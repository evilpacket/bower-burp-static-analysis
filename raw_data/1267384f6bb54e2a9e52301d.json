{
    "url": "http://localhost:9999/simian-lab/ionic-styleguide/test-app/www/lib/ionic/js/ionic.bundle.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>window.name = window.name.replace(NG_DEFER_BOOTSTRAP, '');</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/simian-lab/ionic-styleguide/test-app/www/lib/ionic/js/ionic.bundle.js",
                "path": "/simian-lab/ionic-styleguide/test-app/www/lib/ionic/js/ionic.bundle.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9zaW1pYW4tbGFiL2lvbmljLXN0eWxlZ3VpZGUvdGVzdC1hcHAvd3d3L2xpYi9pb25pYy9qcy9pb25pYy5idW5kbGUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTUzMDA4Nw0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogRnJpLCAwNyBOb3YgMjAxNCAwNTowODowMCBHTVQNCkxhc3QtTW9kaWZpZWQ6IEZyaSwgMDcgTm92IDIwMTQgMDU6MDc6NTggR01UDQoNCi8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKiEKICogQ29weXJpZ2h0IDIwMTQgRHJpZnR5IENvLgogKiBodHRwOi8vZHJpZnR5LmNvbS8KICoKICogSW9uaWMsIHYxLjAuMC1iZXRhLjEyCiAqIEEgcG93ZXJmdWwgSFRNTDUgbW9iaWxlIGFwcCBmcmFtZXdvcmsuCiAqIGh0dHA6Ly9pb25pY2ZyYW1ld29yay5jb20vCiAqCiAqIEJ5IEBtYXhseW5jaCwgQGJlbmpzcGVycnksIEBhZGFtZGJyYWRsZXkgPDMKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLiBQbGVhc2Ugc2VlIExJQ0VOU0UgZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAqCiAqLwoKKGZ1bmN0aW9uKCkgewoKLy8gQ3JlYXRlIGdsb2JhbCBpb25pYyBvYmogYW5kIGl0cyBuYW1lc3BhY2VzCi8vIGJ1aWxkIHByb2Nlc3NlcyBtYXkgaGF2ZSBhbHJlYWR5IGNyZWF0ZWQgYW4gaW9uaWMgb2JqCndpbmRvdy5pb25pYyA9IHdpbmRvdy5pb25pYyB8fCB7fTsKd2luZG93LmlvbmljLnZpZXdzID0ge307CndpbmRvdy5pb25pYy52ZXJzaW9uID0gJzEuMC4wLWJldGEuMTInOwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIGlvbmljKSB7CgogIHZhciByZWFkeUNhbGxiYWNrcyA9IFtdOwogIHZhciBpc0RvbVJlYWR5ID0gZmFsc2U7CgogIGZ1bmN0aW9uIGRvbVJlYWR5KCkgewogICAgaXNEb21SZWFkeSA9IHRydWU7CiAgICBmb3IodmFyIHg9MDsgeDxyZWFkeUNhbGxiYWNrcy5sZW5ndGg7IHgrKykgewogICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVhZHlDYWxsYmFja3NbeF0pOwogICAgfQogICAgcmVhZHlDYWxsYmFja3MgPSBbXTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21SZWFkeSk7CiAgfQogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21SZWFkeSk7CgogIC8vIEZyb20gdGhlIG1hbiBoaW1zZWxmLCBNci4gUGF1bCBJcmlzaC4KICAvLyBUaGUgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHBvbHlmaWxsCiAgLy8gUHV0IGl0IG9uIHdpbmRvdyBqdXN0IHRvIHByZXNlcnZlIGl0cyBjb250ZXh0CiAgLy8gd2l0aG91dCBoYXZpbmcgdG8gdXNlIC5jYWxsCiAgd2luZG93Ll9yQUYgPSAoZnVuY3Rpb24oKXsKICAgIHJldHVybiAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSAgICAgICB8fAogICAgICAgICAgICB3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgfHwKICAgICAgICAgICAgZnVuY3Rpb24oIGNhbGxiYWNrICl7CiAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDE2KTsKICAgICAgICAgICAgfTsKICB9KSgpOwoKICB2YXIgY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgIHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgd2luZG93Lm1vekNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICB3aW5kb3cud2Via2l0Q2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICAvKioKICAqIEBuZ2RvYyB1dGlsaXR5CiAgKiBAbmFtZSBpb25pYy5Eb21VdGlsCiAgKiBAbW9kdWxlIGlvbmljCiAgKi8KICBpb25pYy5Eb21VdGlsID0gewogICAgLy9DYWxsIHdpdGggcHJvcGVyIGNvbnRleHQKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuRG9tVXRpbCNyZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAqIEBhbGlhcyBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAqIEBkZXNjcmlwdGlvbiBDYWxscyBbcmVxdWVzdEFuaW1hdGlvbkZyYW1lXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSksIG9yIGEgcG9seWZpbGwgaWYgbm90IGF2YWlsYWJsZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIG5leHQgZnJhbWUKICAgICAqIGhhcHBlbnMuCiAgICAgKi8KICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZTogZnVuY3Rpb24oY2IpIHsKICAgICAgcmV0dXJuIHdpbmRvdy5fckFGKGNiKTsKICAgIH0sCgogICAgY2FuY2VsQW5pbWF0aW9uRnJhbWU6IGZ1bmN0aW9uKHJlcXVlc3RJZCkgewogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyZXF1ZXN0SWQpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjYW5pbWF0aW9uRnJhbWVUaHJvdHRsZQogICAgICogQGFsaWFzIGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2hlbiBnaXZlbiBhIGNhbGxiYWNrLCBpZiB0aGF0IGNhbGxiYWNrIGlzIGNhbGxlZCAxMDAgdGltZXMgYmV0d2VlbgogICAgICogYW5pbWF0aW9uIGZyYW1lcywgYWRkaW5nIFRocm90dGxlIHdpbGwgbWFrZSBpdCBvbmx5IHJ1biB0aGUgbGFzdCBvZgogICAgICogdGhlIDEwMCBjYWxscy4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBhIGZ1bmN0aW9uIHdoaWNoIHdpbGwgYmUgdGhyb3R0bGVkIHRvCiAgICAgKiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbn0gQSBmdW5jdGlvbiB3aGljaCB3aWxsIHRoZW4gY2FsbCB0aGUgcGFzc2VkIGluIGNhbGxiYWNrLgogICAgICogVGhlIHBhc3NlZCBpbiBjYWxsYmFjayB3aWxsIHJlY2VpdmUgdGhlIGNvbnRleHQgdGhlIHJldHVybmVkIGZ1bmN0aW9uIGlzCiAgICAgKiBjYWxsZWQgd2l0aC4KICAgICAqLwogICAgYW5pbWF0aW9uRnJhbWVUaHJvdHRsZTogZnVuY3Rpb24oY2IpIHsKICAgICAgdmFyIGFyZ3MsIGlzUXVldWVkLCBjb250ZXh0OwogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgICBpZiAoIWlzUXVldWVkKSB7CiAgICAgICAgICBpc1F1ZXVlZCA9IHRydWU7CiAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNiLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICBpc1F1ZXVlZCA9IGZhbHNlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0UG9zaXRpb25JblBhcmVudAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGaW5kIGFuIGVsZW1lbnQncyBzY3JvbGwgb2Zmc2V0IHdpdGhpbiBpdHMgY29udGFpbmVyLgogICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGZpbmQgdGhlIG9mZnNldCBvZi4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEEgcG9zaXRpb24gb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICogICAtIGB7bnVtYmVyfWAgYGxlZnRgIFRoZSBsZWZ0IG9mZnNldCBvZiB0aGUgZWxlbWVudC4KICAgICAqICAgLSBge251bWJlcn1gIGB0b3BgIFRoZSB0b3Agb2Zmc2V0IG9mIHRoZSBlbGVtZW50LgogICAgICovCiAgICBnZXRQb3NpdGlvbkluUGFyZW50OiBmdW5jdGlvbihlbCkgewogICAgICByZXR1cm4gewogICAgICAgIGxlZnQ6IGVsLm9mZnNldExlZnQsCiAgICAgICAgdG9wOiBlbC5vZmZzZXRUb3AKICAgICAgfTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI3JlYWR5CiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENhbGwgYSBmdW5jdGlvbiB3aGVuIHRoZSBET00gaXMgcmVhZHksIG9yIGlmIGl0IGlzIGFscmVhZHkgcmVhZHkKICAgICAqIGNhbGwgdGhlIGZ1bmN0aW9uIGltbWVkaWF0ZWx5LgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZC4KICAgICAqLwogICAgcmVhZHk6IGZ1bmN0aW9uKGNiKSB7CiAgICAgIGlmKGlzRG9tUmVhZHkgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIikgewogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShjYik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVhZHlDYWxsYmFja3MucHVzaChjYik7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI2dldFRleHRCb3VuZHMKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogR2V0IGEgcmVjdCByZXByZXNlbnRpbmcgdGhlIGJvdW5kcyBvZiB0aGUgZ2l2ZW4gdGV4dE5vZGUuCiAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHRleHROb2RlIFRoZSB0ZXh0Tm9kZSB0byBmaW5kIHRoZSBib3VuZHMgb2YuCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBib3VuZHMgb2YgdGhlIG5vZGUuIFByb3BlcnRpZXM6CiAgICAgKiAgIC0gYHtudW1iZXJ9YCBgbGVmdGAgVGhlIGxlZnQgcG9zaXRpb24gb2YgdGhlIHRleHROb2RlLgogICAgICogICAtIGB7bnVtYmVyfWAgYHJpZ2h0YCBUaGUgcmlnaHQgcG9zaXRpb24gb2YgdGhlIHRleHROb2RlLgogICAgICogICAtIGB7bnVtYmVyfWAgYHRvcGAgVGhlIHRvcCBwb3NpdGlvbiBvZiB0aGUgdGV4dE5vZGUuCiAgICAgKiAgIC0gYHtudW1iZXJ9YCBgYm90dG9tYCBUaGUgYm90dG9tIHBvc2l0aW9uIG9mIHRoZSB0ZXh0Tm9kZS4KICAgICAqICAgLSBge251bWJlcn1gIGB3aWR0aGAgVGhlIHdpZHRoIG9mIHRoZSB0ZXh0Tm9kZS4KICAgICAqICAgLSBge251bWJlcn1gIGBoZWlnaHRgIFRoZSBoZWlnaHQgb2YgdGhlIHRleHROb2RlLgogICAgICovCiAgICBnZXRUZXh0Qm91bmRzOiBmdW5jdGlvbih0ZXh0Tm9kZSkgewogICAgICBpZihkb2N1bWVudC5jcmVhdGVSYW5nZSkgewogICAgICAgIHZhciByYW5nZSA9IGRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZUNvbnRlbnRzKHRleHROb2RlKTsKICAgICAgICBpZihyYW5nZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QpIHsKICAgICAgICAgIHZhciByZWN0ID0gcmFuZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICBpZihyZWN0KSB7CiAgICAgICAgICAgIHZhciBzeCA9IHdpbmRvdy5zY3JvbGxYOwogICAgICAgICAgICB2YXIgc3kgPSB3aW5kb3cuc2Nyb2xsWTsKCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgdG9wOiByZWN0LnRvcCArIHN5LAogICAgICAgICAgICAgIGxlZnQ6IHJlY3QubGVmdCArIHN4LAogICAgICAgICAgICAgIHJpZ2h0OiByZWN0LmxlZnQgKyBzeCArIHJlY3Qud2lkdGgsCiAgICAgICAgICAgICAgYm90dG9tOiByZWN0LnRvcCArIHN5ICsgcmVjdC5oZWlnaHQsCiAgICAgICAgICAgICAgd2lkdGg6IHJlY3Qud2lkdGgsCiAgICAgICAgICAgICAgaGVpZ2h0OiByZWN0LmhlaWdodAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI2dldENoaWxkSW5kZXgKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogR2V0IHRoZSBmaXJzdCBpbmRleCBvZiBhIGNoaWxkIG5vZGUgd2l0aGluIHRoZSBnaXZlbiBlbGVtZW50IG9mIHRoZQogICAgICogc3BlY2lmaWVkIHR5cGUuCiAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gZmluZCB0aGUgaW5kZXggb2YuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUgbm9kZU5hbWUgdG8gbWF0Y2ggY2hpbGRyZW4gb2YgZWxlbWVudCBhZ2FpbnN0LgogICAgICogQHJldHVybnMge251bWJlcn0gVGhlIGluZGV4LCBvciAtMSwgb2YgYSBjaGlsZCB3aXRoIG5vZGVOYW1lIG1hdGNoaW5nIHR5cGUuCiAgICAgKi8KICAgIGdldENoaWxkSW5kZXg6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUpIHsKICAgICAgaWYodHlwZSkgewogICAgICAgIHZhciBjaCA9IGVsZW1lbnQucGFyZW50Tm9kZS5jaGlsZHJlbjsKICAgICAgICB2YXIgYzsKICAgICAgICBmb3IodmFyIGkgPSAwLCBrID0gMCwgaiA9IGNoLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgYyA9IGNoW2ldOwogICAgICAgICAgaWYoYy5ub2RlTmFtZSAmJiBjLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gdHlwZSkgewogICAgICAgICAgICBpZihjID09IGVsZW1lbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gazsKICAgICAgICAgICAgfQogICAgICAgICAgICBrKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbGVtZW50LnBhcmVudE5vZGUuY2hpbGRyZW4pLmluZGV4T2YoZWxlbWVudCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgc3dhcE5vZGVzOiBmdW5jdGlvbihzcmMsIGRlc3QpIHsKICAgICAgZGVzdC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShzcmMsIGRlc3QpOwogICAgfSwKCiAgICBlbGVtZW50SXNEZXNjZW5kYW50OiBmdW5jdGlvbihlbCwgcGFyZW50LCBzdG9wQXQpIHsKICAgICAgdmFyIGN1cnJlbnQgPSBlbDsKICAgICAgZG8gewogICAgICAgIGlmIChjdXJyZW50ID09PSBwYXJlbnQpIHJldHVybiB0cnVlOwogICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnBhcmVudE5vZGU7CiAgICAgIH0gd2hpbGUgKGN1cnJlbnQgJiYgY3VycmVudCAhPT0gc3RvcEF0KTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0UGFyZW50V2l0aENsYXNzCiAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUKICAgICAqIEByZXR1cm5zIHtET01FbGVtZW50fSBUaGUgY2xvc2VzdCBwYXJlbnQgb2YgZWxlbWVudCBtYXRjaGluZyB0aGUKICAgICAqIGNsYXNzTmFtZSwgb3IgbnVsbC4KICAgICAqLwogICAgZ2V0UGFyZW50V2l0aENsYXNzOiBmdW5jdGlvbihlLCBjbGFzc05hbWUsIGRlcHRoKSB7CiAgICAgIGRlcHRoID0gZGVwdGggfHwgMTA7CiAgICAgIHdoaWxlKGUucGFyZW50Tm9kZSAmJiBkZXB0aC0tKSB7CiAgICAgICAgaWYoZS5wYXJlbnROb2RlLmNsYXNzTGlzdCAmJiBlLnBhcmVudE5vZGUuY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSkpIHsKICAgICAgICAgIHJldHVybiBlLnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIGUgPSBlLnBhcmVudE5vZGU7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI2dldFBhcmVudE9yU2VsZldpdGhDbGFzcwogICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50CiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lCiAgICAgKiBAcmV0dXJucyB7RE9NRWxlbWVudH0gVGhlIGNsb3Nlc3QgcGFyZW50IG9yIHNlbGYgbWF0Y2hpbmcgdGhlCiAgICAgKiBjbGFzc05hbWUsIG9yIG51bGwuCiAgICAgKi8KICAgIGdldFBhcmVudE9yU2VsZldpdGhDbGFzczogZnVuY3Rpb24oZSwgY2xhc3NOYW1lLCBkZXB0aCkgewogICAgICBkZXB0aCA9IGRlcHRoIHx8IDEwOwogICAgICB3aGlsZShlICYmIGRlcHRoLS0pIHsKICAgICAgICBpZihlLmNsYXNzTGlzdCAmJiBlLmNsYXNzTGlzdC5jb250YWlucyhjbGFzc05hbWUpKSB7CiAgICAgICAgICByZXR1cm4gZTsKICAgICAgICB9CiAgICAgICAgZSA9IGUucGFyZW50Tm9kZTsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI3JlY3RDb250YWlucwogICAgICogQHBhcmFtIHtudW1iZXJ9IHgKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB5CiAgICAgKiBAcGFyYW0ge251bWJlcn0geDEKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MQogICAgICogQHBhcmFtIHtudW1iZXJ9IHgyCiAgICAgKiBAcGFyYW0ge251bWJlcn0geTIKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHt4LHl9IGZpdHMgd2l0aGluIHRoZSByZWN0YW5nbGUgZGVmaW5lZCBieQogICAgICoge3gxLHkxLHgyLHkyfS4KICAgICAqLwogICAgcmVjdENvbnRhaW5zOiBmdW5jdGlvbih4LCB5LCB4MSwgeTEsIHgyLCB5MikgewogICAgICBpZih4IDwgeDEgfHwgeCA+IHgyKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmKHkgPCB5MSB8fCB5ID4geTIpIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgLy9TaG9ydGN1dHMKICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBpb25pYy5Eb21VdGlsLnJlcXVlc3RBbmltYXRpb25GcmFtZTsKICBpb25pYy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IGlvbmljLkRvbVV0aWwuY2FuY2VsQW5pbWF0aW9uRnJhbWU7CiAgaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZSA9IGlvbmljLkRvbVV0aWwuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZTsKfSkod2luZG93LCBkb2N1bWVudCwgaW9uaWMpOwoKLyoqCiAqIGlvbi1ldmVudHMuanMKICoKICogQXV0aG9yOiBNYXggTHluY2ggPG1heEBkcmlmdHkuY29tPgogKgogKiBGcmFtZXdvcmsgZXZlbnRzIGhhbmRsZXMgdmFyaW91cyBtb2JpbGUgYnJvd3NlciBldmVudHMsIGFuZAogKiBkZXRlY3RzIHNwZWNpYWwgZXZlbnRzIGxpa2UgdGFwL3N3aXBlL2V0Yy4gYW5kIGVtaXRzIHRoZW0KICogYXMgY3VzdG9tIGV2ZW50cyB0aGF0IGNhbiBiZSB1c2VkIGluIGFuIGFwcC4KICoKICogUG9ydGlvbnMgbG92aW5nbHkgYWRhcHRlZCBmcm9tIGdpdGh1Yi5jb20vbWFrZXIvcmF0Y2hldCBhbmQgZ2l0aHViLmNvbS9hbGV4Z2lic29uL3RhcC5qcyAtIHRoYW5rcyBndXlzIQogKi8KCihmdW5jdGlvbihpb25pYykgewoKICAvLyBDdXN0b20gZXZlbnQgcG9seWZpbGwKICBpb25pYy5DdXN0b21FdmVudCA9IChmdW5jdGlvbigpIHsKICAgIGlmKCB0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ID09PSAnZnVuY3Rpb24nICkgcmV0dXJuIEN1c3RvbUV2ZW50OwoKICAgIHZhciBjdXN0b21FdmVudCA9IGZ1bmN0aW9uKGV2ZW50LCBwYXJhbXMpIHsKICAgICAgdmFyIGV2dDsKICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHsKICAgICAgICBidWJibGVzOiBmYWxzZSwKICAgICAgICBjYW5jZWxhYmxlOiBmYWxzZSwKICAgICAgICBkZXRhaWw6IHVuZGVmaW5lZAogICAgICB9OwogICAgICB0cnkgewogICAgICAgIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJDdXN0b21FdmVudCIpOwogICAgICAgIGV2dC5pbml0Q3VzdG9tRXZlbnQoZXZlbnQsIHBhcmFtcy5idWJibGVzLCBwYXJhbXMuY2FuY2VsYWJsZSwgcGFyYW1zLmRldGFpbCk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgLy8gZmFsbGJhY2sgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBjcmVhdGVFdmVudCgnQ3VzdG9tRXZlbnQnKQogICAgICAgIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJFdmVudCIpOwogICAgICAgIGZvciAodmFyIHBhcmFtIGluIHBhcmFtcykgewogICAgICAgICAgZXZ0W3BhcmFtXSA9IHBhcmFtc1twYXJhbV07CiAgICAgICAgfQogICAgICAgIGV2dC5pbml0RXZlbnQoZXZlbnQsIHBhcmFtcy5idWJibGVzLCBwYXJhbXMuY2FuY2VsYWJsZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGV2dDsKICAgIH07CiAgICBjdXN0b21FdmVudC5wcm90b3R5cGUgPSB3aW5kb3cuRXZlbnQucHJvdG90eXBlOwogICAgcmV0dXJuIGN1c3RvbUV2ZW50OwogIH0pKCk7CgoKICAvKioKICAgKiBAbmdkb2MgdXRpbGl0eQogICAqIEBuYW1lIGlvbmljLkV2ZW50Q29udHJvbGxlcgogICAqIEBtb2R1bGUgaW9uaWMKICAgKi8KICBpb25pYy5FdmVudENvbnRyb2xsZXIgPSB7CiAgICBWSVJUVUFMSVpFRF9FVkVOVFM6IFsndGFwJywgJ3N3aXBlJywgJ3N3aXBlcmlnaHQnLCAnc3dpcGVsZWZ0JywgJ2RyYWcnLCAnaG9sZCcsICdyZWxlYXNlJ10sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5FdmVudENvbnRyb2xsZXIjdHJpZ2dlcgogICAgICogQGFsaWFzIGlvbmljLnRyaWdnZXIKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudFR5cGUgVGhlIGV2ZW50IHRvIHRyaWdnZXIuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBUaGUgZGF0YSBmb3IgdGhlIGV2ZW50LiBIaW50OiBwYXNzIGluCiAgICAgKiBge3RhcmdldDogdGFyZ2V0RWxlbWVudH1gCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBidWJibGVzIFdoZXRoZXIgdGhlIGV2ZW50IHNob3VsZCBidWJibGUgdXAgdGhlIERPTS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IGNhbmNlbGFibGUgV2hldGhlciB0aGUgZXZlbnQgc2hvdWxkIGJlIGNhbmNlbGFibGUuCiAgICAgKi8KICAgIC8vIFRyaWdnZXIgYSBuZXcgZXZlbnQKICAgIHRyaWdnZXI6IGZ1bmN0aW9uKGV2ZW50VHlwZSwgZGF0YSwgYnViYmxlcywgY2FuY2VsYWJsZSkgewogICAgICB2YXIgZXZlbnQgPSBuZXcgaW9uaWMuQ3VzdG9tRXZlbnQoZXZlbnRUeXBlLCB7CiAgICAgICAgZGV0YWlsOiBkYXRhLAogICAgICAgIGJ1YmJsZXM6ICEhYnViYmxlcywKICAgICAgICBjYW5jZWxhYmxlOiAhIWNhbmNlbGFibGUKICAgICAgfSk7CgogICAgICAvLyBNYWtlIHN1cmUgdG8gdHJpZ2dlciB0aGUgZXZlbnQgb24gdGhlIGdpdmVuIHRhcmdldCwgb3IgZGlzcGF0Y2ggaXQgZnJvbQogICAgICAvLyB0aGUgd2luZG93IGlmIHdlIGRvbid0IGhhdmUgYW4gZXZlbnQgdGFyZ2V0CiAgICAgIGRhdGEgJiYgZGF0YS50YXJnZXQgJiYgZGF0YS50YXJnZXQuZGlzcGF0Y2hFdmVudCAmJiBkYXRhLnRhcmdldC5kaXNwYXRjaEV2ZW50KGV2ZW50KSB8fCB3aW5kb3cuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyI29uCiAgICAgKiBAYWxpYXMgaW9uaWMub24KICAgICAqIEBkZXNjcmlwdGlvbiBMaXN0ZW4gdG8gYW4gZXZlbnQgb24gYW4gZWxlbWVudC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBldmVudCB0byBsaXN0ZW4gZm9yLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGxpc3RlbmVyIHRvIGJlIGNhbGxlZC4KICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byBsaXN0ZW4gZm9yIHRoZSBldmVudCBvbi4KICAgICAqLwogICAgb246IGZ1bmN0aW9uKHR5cGUsIGNhbGxiYWNrLCBlbGVtZW50KSB7CiAgICAgIHZhciBlID0gZWxlbWVudCB8fCB3aW5kb3c7CgogICAgICAvLyBCaW5kIGEgZ2VzdHVyZSBpZiBpdCdzIGEgdmlydHVhbCBldmVudAogICAgICBmb3IodmFyIGkgPSAwLCBqID0gdGhpcy5WSVJUVUFMSVpFRF9FVkVOVFMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgaWYodHlwZSA9PSB0aGlzLlZJUlRVQUxJWkVEX0VWRU5UU1tpXSkgewogICAgICAgICAgdmFyIGdlc3R1cmUgPSBuZXcgaW9uaWMuR2VzdHVyZShlbGVtZW50KTsKICAgICAgICAgIGdlc3R1cmUub24odHlwZSwgY2FsbGJhY2spOwogICAgICAgICAgcmV0dXJuIGdlc3R1cmU7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBPdGhlcndpc2UgYmluZCBhIG5vcm1hbCBldmVudAogICAgICBlLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgY2FsbGJhY2spOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkV2ZW50Q29udHJvbGxlciNvZmYKICAgICAqIEBhbGlhcyBpb25pYy5vZmYKICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sKICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudAogICAgICovCiAgICBvZmY6IGZ1bmN0aW9uKHR5cGUsIGNhbGxiYWNrLCBlbGVtZW50KSB7CiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBjYWxsYmFjayk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyI29uR2VzdHVyZQogICAgICogQGFsaWFzIGlvbmljLm9uR2VzdHVyZQogICAgICogQGRlc2NyaXB0aW9uIEFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBnZXN0dXJlIG9uIGFuIGVsZW1lbnQuCiAgICAgKgogICAgICogQXZhaWxhYmxlIGV2ZW50VHlwZXMgKGZyb20gW2hhbW1lci5qc10oaHR0cDovL2VpZ2h0bWVkaWEuZ2l0aHViLmlvL2hhbW1lci5qcy8pKToKICAgICAqCiAgICAgKiBgaG9sZGAsIGB0YXBgLCBgZG91YmxldGFwYCwgYGRyYWdgLCBgZHJhZ3N0YXJ0YCwgYGRyYWdlbmRgLCBgZHJhZ3VwYCwgYGRyYWdkb3duYCwgPGJyLz4KICAgICAqIGBkcmFnbGVmdGAsIGBkcmFncmlnaHRgLCBgc3dpcGVgLCBgc3dpcGV1cGAsIGBzd2lwZWRvd25gLCBgc3dpcGVsZWZ0YCwgYHN3aXBlcmlnaHRgLCA8YnIvPgogICAgICogYHRyYW5zZm9ybWAsIGB0cmFuc2Zvcm1zdGFydGAsIGB0cmFuc2Zvcm1lbmRgLCBgcm90YXRlYCwgYHBpbmNoYCwgYHBpbmNoaW5gLCBgcGluY2hvdXRgLCA8L2JyPgogICAgICogYHRvdWNoYCwgYHJlbGVhc2VgCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZ2VzdHVyZSBldmVudCB0byBsaXN0ZW4gZm9yLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihlKX0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgZ2VzdHVyZQogICAgICogaGFwcGVucy4KICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBUaGUgYW5ndWxhciBlbGVtZW50IHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IG9uLgogICAgICovCiAgICBvbkdlc3R1cmU6IGZ1bmN0aW9uKHR5cGUsIGNhbGxiYWNrLCBlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBnZXN0dXJlID0gbmV3IGlvbmljLkdlc3R1cmUoZWxlbWVudCwgb3B0aW9ucyk7CiAgICAgIGdlc3R1cmUub24odHlwZSwgY2FsbGJhY2spOwogICAgICByZXR1cm4gZ2VzdHVyZTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5FdmVudENvbnRyb2xsZXIjb2ZmR2VzdHVyZQogICAgICogQGFsaWFzIGlvbmljLm9mZkdlc3R1cmUKICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIGEgZ2VzdHVyZSBvbiBhbiBlbGVtZW50LgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZ2VzdHVyZSBldmVudC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZSl9IGNhbGxiYWNrIFRoZSBsaXN0ZW5lciB0aGF0IHdhcyBhZGRlZCBlYXJsaWVyLgogICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRoZSBsaXN0ZW5lciB3YXMgYWRkZWQgb24uCiAgICAgKi8KICAgIG9mZkdlc3R1cmU6IGZ1bmN0aW9uKGdlc3R1cmUsIHR5cGUsIGNhbGxiYWNrKSB7CiAgICAgIGdlc3R1cmUub2ZmKHR5cGUsIGNhbGxiYWNrKTsKICAgIH0sCgogICAgaGFuZGxlUG9wU3RhdGU6IGZ1bmN0aW9uKGV2ZW50KSB7fQogIH07CgoKICAvLyBNYXAgc29tZSBjb252ZW5pZW50IHRvcC1sZXZlbCBmdW5jdGlvbnMgZm9yIGV2ZW50IGhhbmRsaW5nCiAgaW9uaWMub24gPSBmdW5jdGlvbigpIHsgaW9uaWMuRXZlbnRDb250cm9sbGVyLm9uLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlciwgYXJndW1lbnRzKTsgfTsKICBpb25pYy5vZmYgPSBmdW5jdGlvbigpIHsgaW9uaWMuRXZlbnRDb250cm9sbGVyLm9mZi5hcHBseShpb25pYy5FdmVudENvbnRyb2xsZXIsIGFyZ3VtZW50cyk7IH07CiAgaW9uaWMudHJpZ2dlciA9IGlvbmljLkV2ZW50Q29udHJvbGxlci50cmlnZ2VyOy8vZnVuY3Rpb24oKSB7IGlvbmljLkV2ZW50Q29udHJvbGxlci50cmlnZ2VyLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlci50cmlnZ2VyLCBhcmd1bWVudHMpOyB9OwogIGlvbmljLm9uR2VzdHVyZSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gaW9uaWMuRXZlbnRDb250cm9sbGVyLm9uR2VzdHVyZS5hcHBseShpb25pYy5FdmVudENvbnRyb2xsZXIub25HZXN0dXJlLCBhcmd1bWVudHMpOyB9OwogIGlvbmljLm9mZkdlc3R1cmUgPSBmdW5jdGlvbigpIHsgcmV0dXJuIGlvbmljLkV2ZW50Q29udHJvbGxlci5vZmZHZXN0dXJlLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlci5vZmZHZXN0dXJlLCBhcmd1bWVudHMpOyB9OwoKfSkod2luZG93LmlvbmljKTsKCi8qKgogICogU2ltcGxlIGdlc3R1cmUgY29udHJvbGxlcnMgd2l0aCBzb21lIGNvbW1vbiBnZXN0dXJlcyB0aGF0IGVtaXQKICAqIGdlc3R1cmUgZXZlbnRzLgogICoKICAqIFBvcnRlZCBmcm9tIGdpdGh1Yi5jb20vRWlnaHRNZWRpYS9oYW1tZXIuanMgR2VzdHVyZXMgLSB0aGFua3MhCiAgKi8KKGZ1bmN0aW9uKGlvbmljKSB7CgogIC8qKgogICAqIGlvbmljLkdlc3R1cmVzCiAgICogdXNlIHRoaXMgdG8gY3JlYXRlIGluc3RhbmNlcwogICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgIG9wdGlvbnMKICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgaW9uaWMuR2VzdHVyZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgaW9uaWMuR2VzdHVyZXMuSW5zdGFuY2UoZWxlbWVudCwgb3B0aW9ucyB8fCB7fSk7CiAgfTsKCiAgaW9uaWMuR2VzdHVyZXMgPSB7fTsKCiAgLy8gZGVmYXVsdCBzZXR0aW5ncwogIGlvbmljLkdlc3R1cmVzLmRlZmF1bHRzID0gewogICAgLy8gYWRkIGNzcyB0byB0aGUgZWxlbWVudCB0byBwcmV2ZW50IHRoZSBicm93c2VyIGZyb20gZG9pbmcKICAgIC8vIGl0cyBuYXRpdmUgYmVoYXZpb3IuIHRoaXMgZG9lc250IHByZXZlbnQgdGhlIHNjcm9sbGluZywKICAgIC8vIGJ1dCBjYW5jZWxzIHRoZSBjb250ZXh0bWVudSwgdGFwIGhpZ2hsaWdodGluZyBldGMKICAgIC8vIHNldCB0byBmYWxzZSB0byBkaXNhYmxlIHRoaXMKICAgIHN0b3BfYnJvd3Nlcl9iZWhhdmlvcjogJ2Rpc2FibGUtdXNlci1iZWhhdmlvcicKICB9OwoKICAvLyBkZXRlY3QgdG91Y2hldmVudHMKICBpb25pYy5HZXN0dXJlcy5IQVNfUE9JTlRFUkVWRU5UUyA9IHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgfHwgd2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkOwogIGlvbmljLkdlc3R1cmVzLkhBU19UT1VDSEVWRU5UUyA9ICgnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cpOwoKICAvLyBkb250IHVzZSBtb3VzZWV2ZW50cyBvbiBtb2JpbGUgZGV2aWNlcwogIGlvbmljLkdlc3R1cmVzLk1PQklMRV9SRUdFWCA9IC9tb2JpbGV8dGFibGV0fGlwKGFkfGhvbmV8b2QpfGFuZHJvaWR8c2lsay9pOwogIGlvbmljLkdlc3R1cmVzLk5PX01PVVNFRVZFTlRTID0gaW9uaWMuR2VzdHVyZXMuSEFTX1RPVUNIRVZFTlRTICYmIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKGlvbmljLkdlc3R1cmVzLk1PQklMRV9SRUdFWCk7CgogIC8vIGV2ZW50dHlwZXMgcGVyIHRvdWNoZXZlbnQgKHN0YXJ0LCBtb3ZlLCBlbmQpCiAgLy8gYXJlIGZpbGxlZCBieSBpb25pYy5HZXN0dXJlcy5ldmVudC5kZXRlcm1pbmVFdmVudFR5cGVzIG9uIHNldHVwCiAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVMgPSB7fTsKCiAgLy8gZGlyZWN0aW9uIGRlZmluZXMKICBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fRE9XTiA9ICdkb3duJzsKICBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fTEVGVCA9ICdsZWZ0JzsKICBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fVVAgPSAndXAnOwogIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9SSUdIVCA9ICdyaWdodCc7CgogIC8vIHBvaW50ZXIgdHlwZQogIGlvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0UgPSAnbW91c2UnOwogIGlvbmljLkdlc3R1cmVzLlBPSU5URVJfVE9VQ0ggPSAndG91Y2gnOwogIGlvbmljLkdlc3R1cmVzLlBPSU5URVJfUEVOID0gJ3Blbic7CgogIC8vIHRvdWNoIGV2ZW50IGRlZmluZXMKICBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVCA9ICdzdGFydCc7CiAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRSA9ICdtb3ZlJzsKICBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQgPSAnZW5kJzsKCiAgLy8gaGFtbWVyIGRvY3VtZW50IHdoZXJlIHRoZSBiYXNlIGV2ZW50cyBhcmUgYWRkZWQgYXQKICBpb25pYy5HZXN0dXJlcy5ET0NVTUVOVCA9IHdpbmRvdy5kb2N1bWVudDsKCiAgLy8gcGx1Z2lucyBuYW1lc3BhY2UKICBpb25pYy5HZXN0dXJlcy5wbHVnaW5zID0ge307CgogIC8vIGlmIHRoZSB3aW5kb3cgZXZlbnRzIGFyZSBzZXQuLi4KICBpb25pYy5HZXN0dXJlcy5SRUFEWSA9IGZhbHNlOwoKICAvKioKICAgKiBzZXR1cCBldmVudHMgdG8gZGV0ZWN0IGdlc3R1cmVzIG9uIHRoZSBkb2N1bWVudAogICAqLwogIGZ1bmN0aW9uIHNldHVwKCkgewogICAgaWYoaW9uaWMuR2VzdHVyZXMuUkVBRFkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIGZpbmQgd2hhdCBldmVudHR5cGVzIHdlIGFkZCBsaXN0ZW5lcnMgdG8KICAgIGlvbmljLkdlc3R1cmVzLmV2ZW50LmRldGVybWluZUV2ZW50VHlwZXMoKTsKCiAgICAvLyBSZWdpc3RlciBhbGwgZ2VzdHVyZXMgaW5zaWRlIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzCiAgICBmb3IodmFyIG5hbWUgaW4gaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMpIHsKICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24ucmVnaXN0ZXIoaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXNbbmFtZV0pOwogICAgICB9CiAgICB9CgogICAgLy8gQWRkIHRvdWNoIGV2ZW50cyBvbiB0aGUgZG9jdW1lbnQKICAgIGlvbmljLkdlc3R1cmVzLmV2ZW50Lm9uVG91Y2goaW9uaWMuR2VzdHVyZXMuRE9DVU1FTlQsIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkUsIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5kZXRlY3QpOwogICAgaW9uaWMuR2VzdHVyZXMuZXZlbnQub25Ub3VjaChpb25pYy5HZXN0dXJlcy5ET0NVTUVOVCwgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5ELCBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uZGV0ZWN0KTsKCiAgICAvLyBpb25pYy5HZXN0dXJlcyBpcyByZWFkeS4uLiEKICAgIGlvbmljLkdlc3R1cmVzLlJFQURZID0gdHJ1ZTsKICB9CgogIC8qKgogICAqIGNyZWF0ZSBuZXcgaGFtbWVyIGluc3RhbmNlCiAgICogYWxsIG1ldGhvZHMgc2hvdWxkIHJldHVybiB0aGUgaW5zdGFuY2UgaXRzZWxmLCBzbyBpdCBpcyBjaGFpbmFibGUuCiAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgICAgICBlbGVtZW50CiAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgICAgICBbb3B0aW9ucz17fV0KICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICogQG5hbWUgR2VzdHVyZS5JbnN0YW5jZQogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGlvbmljLkdlc3R1cmVzLkluc3RhbmNlID0gZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIEEgbnVsbCBlbGVtZW50IHdhcyBwYXNzZWQgaW50byB0aGUgaW5zdGFuY2UsIHdoaWNoIG1lYW5zCiAgICAvLyB3aGF0ZXZlciBsb29rdXAgd2FzIGRvbmUgdG8gZmluZCB0aGlzIGVsZW1lbnQgZmFpbGVkIHRvIGZpbmQgaXQKICAgIC8vIHNvIHdlIGNhbid0IGxpc3RlbiBmb3IgZXZlbnRzIG9uIGl0LgogICAgaWYoZWxlbWVudCA9PT0gbnVsbCkgewogICAgICB2b2lkIDA7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBzZXR1cCBpb25pYy5HZXN0dXJlc0pTIHdpbmRvdyBldmVudHMgYW5kIHJlZ2lzdGVyIGFsbCBnZXN0dXJlcwogICAgLy8gdGhpcyBhbHNvIHNldHMgdXAgdGhlIGRlZmF1bHQgb3B0aW9ucwogICAgc2V0dXAoKTsKCiAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoKICAgIC8vIHN0YXJ0L3N0b3AgZGV0ZWN0aW9uIG9wdGlvbgogICAgdGhpcy5lbmFibGVkID0gdHJ1ZTsKCiAgICAvLyBtZXJnZSBvcHRpb25zCiAgICB0aGlzLm9wdGlvbnMgPSBpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoCiAgICAgICAgaW9uaWMuR2VzdHVyZXMudXRpbHMuZXh0ZW5kKHt9LCBpb25pYy5HZXN0dXJlcy5kZWZhdWx0cyksCiAgICAgICAgb3B0aW9ucyB8fCB7fSk7CgogICAgLy8gYWRkIHNvbWUgY3NzIHRvIHRoZSBlbGVtZW50IHRvIHByZXZlbnQgdGhlIGJyb3dzZXIgZnJvbSBkb2luZyBpdHMgbmF0aXZlIGJlaGF2b2lyCiAgICBpZih0aGlzLm9wdGlvbnMuc3RvcF9icm93c2VyX2JlaGF2aW9yKSB7CiAgICAgIGlvbmljLkdlc3R1cmVzLnV0aWxzLnN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yKHRoaXMuZWxlbWVudCwgdGhpcy5vcHRpb25zLnN0b3BfYnJvd3Nlcl9iZWhhdmlvcik7CiAgICB9CgogICAgLy8gc3RhcnQgZGV0ZWN0aW9uIG9uIHRvdWNoc3RhcnQKICAgIGlvbmljLkdlc3R1cmVzLmV2ZW50Lm9uVG91Y2goZWxlbWVudCwgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQsIGZ1bmN0aW9uKGV2KSB7CiAgICAgIGlmKHNlbGYuZW5hYmxlZCkgewogICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5zdGFydERldGVjdChzZWxmLCBldik7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIHJldHVybiBpbnN0YW5jZQogICAgcmV0dXJuIHRoaXM7CiAgfTsKCgogIGlvbmljLkdlc3R1cmVzLkluc3RhbmNlLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogYmluZCBldmVudHMgdG8gdGhlIGluc3RhbmNlCiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgIGdlc3R1cmUKICAgICAqIEBwYXJhbSAgIHtGdW5jdGlvbn0gICAgaGFuZGxlcgogICAgICogQHJldHVybnMge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfQogICAgICovCiAgICBvbjogZnVuY3Rpb24gb25FdmVudChnZXN0dXJlLCBoYW5kbGVyKXsKICAgICAgdmFyIGdlc3R1cmVzID0gZ2VzdHVyZS5zcGxpdCgnICcpOwogICAgICBmb3IodmFyIHQ9MDsgdDxnZXN0dXJlcy5sZW5ndGg7IHQrKykgewogICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGdlc3R1cmVzW3RdLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKCiAgICAvKioKICAgICAqIHVuYmluZCBldmVudHMgdG8gdGhlIGluc3RhbmNlCiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgIGdlc3R1cmUKICAgICAqIEBwYXJhbSAgIHtGdW5jdGlvbn0gICAgaGFuZGxlcgogICAgICogQHJldHVybnMge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfQogICAgICovCiAgICBvZmY6IGZ1bmN0aW9uIG9mZkV2ZW50KGdlc3R1cmUsIGhhbmRsZXIpewogICAgICB2YXIgZ2VzdHVyZXMgPSBnZXN0dXJlLnNwbGl0KCcgJyk7CiAgICAgIGZvcih2YXIgdD0wOyB0PGdlc3R1cmVzLmxlbmd0aDsgdCsrKSB7CiAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZ2VzdHVyZXNbdF0sIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgoKICAgIC8qKgogICAgICogdHJpZ2dlciBnZXN0dXJlIGV2ZW50CiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgIGdlc3R1cmUKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgZXZlbnREYXRhCiAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgKi8KICAgIHRyaWdnZXI6IGZ1bmN0aW9uIHRyaWdnZXJFdmVudChnZXN0dXJlLCBldmVudERhdGEpewogICAgICAvLyBjcmVhdGUgRE9NIGV2ZW50CiAgICAgIHZhciBldmVudCA9IGlvbmljLkdlc3R1cmVzLkRPQ1VNRU5ULmNyZWF0ZUV2ZW50KCdFdmVudCcpOwogICAgICBldmVudC5pbml0RXZlbnQoZ2VzdHVyZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgIGV2ZW50Lmdlc3R1cmUgPSBldmVudERhdGE7CgogICAgICAvLyB0cmlnZ2VyIG9uIHRoZSB0YXJnZXQgaWYgaXQgaXMgaW4gdGhlIGluc3RhbmNlIGVsZW1lbnQsCiAgICAgIC8vIHRoaXMgaXMgZm9yIGV2ZW50IGRlbGVnYXRpb24gdHJpY2tzCiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50OwogICAgICBpZihpb25pYy5HZXN0dXJlcy51dGlscy5oYXNQYXJlbnQoZXZlbnREYXRhLnRhcmdldCwgZWxlbWVudCkpIHsKICAgICAgICBlbGVtZW50ID0gZXZlbnREYXRhLnRhcmdldDsKICAgICAgfQoKICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKCiAgICAvKioKICAgICAqIGVuYWJsZSBvZiBkaXNhYmxlIGhhbW1lci5qcyBkZXRlY3Rpb24KICAgICAqIEBwYXJhbSAgIHtCb29sZWFufSAgIHN0YXRlCiAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgKi8KICAgIGVuYWJsZTogZnVuY3Rpb24gZW5hYmxlKHN0YXRlKSB7CiAgICAgIHRoaXMuZW5hYmxlZCA9IHN0YXRlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwoKICAvKioKICAgKiB0aGlzIGhvbGRzIHRoZSBsYXN0IG1vdmUgZXZlbnQsCiAgICogdXNlZCB0byBmaXggZW1wdHkgdG91Y2hlbmQgaXNzdWUKICAgKiBzZWUgdGhlIG9uVG91Y2ggZXZlbnQgZm9yIGFuIGV4cGxhbmF0aW9uCiAgICogdHlwZSB7T2JqZWN0fQogICAqLwogIHZhciBsYXN0X21vdmVfZXZlbnQgPSBudWxsOwoKCiAgLyoqCiAgICogd2hlbiB0aGUgbW91c2UgaXMgaG9sZCBkb3duLCB0aGlzIGlzIHRydWUKICAgKiB0eXBlIHtCb29sZWFufQogICAqLwogIHZhciBlbmFibGVfZGV0ZWN0ID0gZmFsc2U7CgoKICAvKioKICAgKiB3aGVuIHRvdWNoIGV2ZW50cyBoYXZlIGJlZW4gZmlyZWQsIHRoaXMgaXMgdHJ1ZQogICAqIHR5cGUge0Jvb2xlYW59CiAgICovCiAgdmFyIHRvdWNoX3RyaWdnZXJlZCA9IGZhbHNlOwoKCiAgaW9uaWMuR2VzdHVyZXMuZXZlbnQgPSB7CiAgICAvKioKICAgICAqIHNpbXBsZSBhZGRFdmVudExpc3RlbmVyCiAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgZWxlbWVudAogICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICAgIHR5cGUKICAgICAqIEBwYXJhbSAgIHtGdW5jdGlvbn0gICAgICBoYW5kbGVyCiAgICAgKi8KICAgIGJpbmREb206IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGhhbmRsZXIpIHsKICAgICAgdmFyIHR5cGVzID0gdHlwZS5zcGxpdCgnICcpOwogICAgICBmb3IodmFyIHQ9MDsgdDx0eXBlcy5sZW5ndGg7IHQrKykgewogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0eXBlc1t0XSwgaGFuZGxlciwgZmFsc2UpOwogICAgICB9CiAgICB9LAoKCiAgICAvKioKICAgICAqIHRvdWNoIGV2ZW50cyB3aXRoIG1vdXNlIGZhbGxiYWNrCiAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgZWxlbWVudAogICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICAgIGV2ZW50VHlwZSAgICAgICAgbGlrZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFCiAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgICAgaGFuZGxlcgogICAgICovCiAgICBvblRvdWNoOiBmdW5jdGlvbiBvblRvdWNoKGVsZW1lbnQsIGV2ZW50VHlwZSwgaGFuZGxlcikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICB0aGlzLmJpbmREb20oZWxlbWVudCwgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVNbZXZlbnRUeXBlXSwgZnVuY3Rpb24gYmluZERvbU9uVG91Y2goZXYpIHsKICAgICAgICB2YXIgc291cmNlRXZlbnRUeXBlID0gZXYudHlwZS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAvLyBvbm1vdXNldXAsIGJ1dCB3aGVuIHRvdWNoZW5kIGhhcyBiZWVuIGZpcmVkIHdlIGRvIG5vdGhpbmcuCiAgICAgICAgLy8gdGhpcyBpcyBmb3IgdG91Y2hkZXZpY2VzIHdoaWNoIGFsc28gZmlyZSBhIG1vdXNldXAgb24gdG91Y2hlbmQKICAgICAgICBpZihzb3VyY2VFdmVudFR5cGUubWF0Y2goL21vdXNlLykgJiYgdG91Y2hfdHJpZ2dlcmVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBtb3VzZWJ1dHRvbiBtdXN0IGJlIGRvd24gb3IgYSB0b3VjaCBldmVudAogICAgICAgIGVsc2UgaWYoIHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2gvKSB8fCAgIC8vIHRvdWNoIGV2ZW50cyBhcmUgYWx3YXlzIG9uIHNjcmVlbgogICAgICAgICAgc291cmNlRXZlbnRUeXBlLm1hdGNoKC9wb2ludGVyZG93bi8pIHx8IC8vIHBvaW50ZXJldmVudHMgdG91Y2gKICAgICAgICAgIChzb3VyY2VFdmVudFR5cGUubWF0Y2goL21vdXNlLykgJiYgZXYud2hpY2ggPT09IDEpICAgLy8gbW91c2UgaXMgcHJlc3NlZAogICAgICAgICAgKXsKICAgICAgICAgICAgZW5hYmxlX2RldGVjdCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgIC8vIG1vdXNlIGlzbid0IHByZXNzZWQKICAgICAgICBlbHNlIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiBldi53aGljaCAhPT0gMSkgewogICAgICAgICAgZW5hYmxlX2RldGVjdCA9IGZhbHNlOwogICAgICAgIH0KCgogICAgICAgIC8vIHdlIGFyZSBpbiBhIHRvdWNoIGV2ZW50LCBzZXQgdGhlIHRvdWNoIHRyaWdnZXJlZCBib29sIHRvIHRydWUsCiAgICAgICAgLy8gdGhpcyBmb3IgdGhlIGNvbmZsaWN0cyB0aGF0IG1heSBvY2N1ciBvbiBpb3MgYW5kIGFuZHJvaWQKICAgICAgICBpZihzb3VyY2VFdmVudFR5cGUubWF0Y2goL3RvdWNofHBvaW50ZXIvKSkgewogICAgICAgICAgdG91Y2hfdHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIC8vIGNvdW50IHRoZSB0b3RhbCB0b3VjaGVzIG9uIHRoZSBzY3JlZW4KICAgICAgICB2YXIgY291bnRfdG91Y2hlcyA9IDA7CgogICAgICAgIC8vIHdoZW4gdG91Y2ggaGFzIGJlZW4gdHJpZ2dlcmVkIGluIHRoaXMgZGV0ZWN0aW9uIHNlc3Npb24KICAgICAgICAvLyBhbmQgd2UgYXJlIG5vdyBoYW5kbGluZyBhIG1vdXNlIGV2ZW50LCB3ZSBzdG9wIHRoYXQgdG8gcHJldmVudCBjb25mbGljdHMKICAgICAgICBpZihlbmFibGVfZGV0ZWN0KSB7CiAgICAgICAgICAvLyB1cGRhdGUgcG9pbnRlcmV2ZW50CiAgICAgICAgICBpZihpb25pYy5HZXN0dXJlcy5IQVNfUE9JTlRFUkVWRU5UUyAmJiBldmVudFR5cGUgIT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EKSB7CiAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBpb25pYy5HZXN0dXJlcy5Qb2ludGVyRXZlbnQudXBkYXRlUG9pbnRlcihldmVudFR5cGUsIGV2KTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIHRvdWNoCiAgICAgICAgICBlbHNlIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2gvKSkgewogICAgICAgICAgICBjb3VudF90b3VjaGVzID0gZXYudG91Y2hlcy5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBtb3VzZQogICAgICAgICAgZWxzZSBpZighdG91Y2hfdHJpZ2dlcmVkKSB7CiAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBzb3VyY2VFdmVudFR5cGUubWF0Y2goL3VwLykgPyAwIDogMTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBpZiB3ZSBhcmUgaW4gYSBlbmQgZXZlbnQsIGJ1dCB3aGVuIHdlIHJlbW92ZSBvbmUgdG91Y2ggYW5kCiAgICAgICAgICAvLyB3ZSBzdGlsbCBoYXZlIGVub3VnaCwgc2V0IGV2ZW50VHlwZSB0byBtb3ZlCiAgICAgICAgICBpZihjb3VudF90b3VjaGVzID4gMCAmJiBldmVudFR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EKSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkU7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBubyB0b3VjaGVzLCBmb3JjZSB0aGUgZW5kIGV2ZW50CiAgICAgICAgICBlbHNlIGlmKCFjb3VudF90b3VjaGVzKSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBzdG9yZSB0aGUgbGFzdCBtb3ZlIGV2ZW50CiAgICAgICAgICBpZihjb3VudF90b3VjaGVzIHx8IGxhc3RfbW92ZV9ldmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICBsYXN0X21vdmVfZXZlbnQgPSBldjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyB0cmlnZ2VyIHRoZSBoYW5kbGVyCiAgICAgICAgICBoYW5kbGVyLmNhbGwoaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLCBzZWxmLmNvbGxlY3RFdmVudERhdGEoZWxlbWVudCwgZXZlbnRUeXBlLCBzZWxmLmdldFRvdWNoTGlzdChsYXN0X21vdmVfZXZlbnQsIGV2ZW50VHlwZSksIGV2KSk7CgogICAgICAgICAgLy8gcmVtb3ZlIHBvaW50ZXJldmVudCBmcm9tIGxpc3QKICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTICYmIGV2ZW50VHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgY291bnRfdG91Y2hlcyA9IGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC51cGRhdGVQb2ludGVyKGV2ZW50VHlwZSwgZXYpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy9kZWJ1Zyhzb3VyY2VFdmVudFR5cGUgKyIgIisgZXZlbnRUeXBlKTsKCiAgICAgICAgLy8gb24gdGhlIGVuZCB3ZSByZXNldCBldmVyeXRoaW5nCiAgICAgICAgaWYoIWNvdW50X3RvdWNoZXMpIHsKICAgICAgICAgIGxhc3RfbW92ZV9ldmVudCA9IG51bGw7CiAgICAgICAgICBlbmFibGVfZGV0ZWN0ID0gZmFsc2U7CiAgICAgICAgICB0b3VjaF90cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgIGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC5yZXNldCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKCiAgICAvKioKICAgICAqIHdlIGhhdmUgZGlmZmVyZW50IGV2ZW50cyBmb3IgZWFjaCBkZXZpY2UvYnJvd3NlcgogICAgICogZGV0ZXJtaW5lIHdoYXQgd2UgbmVlZCBhbmQgc2V0IHRoZW0gaW4gdGhlIGlvbmljLkdlc3R1cmVzLkVWRU5UX1RZUEVTIGNvbnN0YW50CiAgICAgKi8KICAgIGRldGVybWluZUV2ZW50VHlwZXM6IGZ1bmN0aW9uIGRldGVybWluZUV2ZW50VHlwZXMoKSB7CiAgICAgIC8vIGRldGVybWluZSB0aGUgZXZlbnR0eXBlIHdlIHdhbnQgdG8gc2V0CiAgICAgIHZhciB0eXBlczsKCiAgICAgIC8vIHBvaW50ZXJFdmVudHMgbWFnaWMKICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuSEFTX1BPSU5URVJFVkVOVFMpIHsKICAgICAgICB0eXBlcyA9IGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC5nZXRFdmVudHMoKTsKICAgICAgfQogICAgICAvLyBvbiBBbmRyb2lkLCBpT1MsIGJsYWNrYmVycnksIHdpbmRvd3MgbW9iaWxlIHdlIGRvbnQgd2FudCBhbnkgbW91c2VldmVudHMKICAgICAgZWxzZSBpZihpb25pYy5HZXN0dXJlcy5OT19NT1VTRUVWRU5UUykgewogICAgICAgIHR5cGVzID0gWwogICAgICAgICAgJ3RvdWNoc3RhcnQnLAogICAgICAgICAgJ3RvdWNobW92ZScsCiAgICAgICAgICAndG91Y2hlbmQgdG91Y2hjYW5jZWwnXTsKICAgICAgfQogICAgICAvLyBmb3Igbm9uIHBvaW50ZXIgZXZlbnRzIGJyb3dzZXJzIGFuZCBtaXhlZCBicm93c2VycywKICAgICAgLy8gbGlrZSBjaHJvbWUgb24gd2luZG93czggdG91Y2ggbGFwdG9wCiAgICAgIGVsc2UgewogICAgICAgIHR5cGVzID0gWwogICAgICAgICAgJ3RvdWNoc3RhcnQgbW91c2Vkb3duJywKICAgICAgICAgICd0b3VjaG1vdmUgbW91c2Vtb3ZlJywKICAgICAgICAgICd0b3VjaGVuZCB0b3VjaGNhbmNlbCBtb3VzZXVwJ107CiAgICAgIH0KCiAgICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX1RZUEVTW2lvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUXSAgPSB0eXBlc1swXTsKICAgICAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVNbaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRV0gICA9IHR5cGVzWzFdOwogICAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFU1tpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkRdICAgID0gdHlwZXNbMl07CiAgICB9LAoKCiAgICAvKioKICAgICAqIGNyZWF0ZSB0b3VjaGxpc3QgZGVwZW5kaW5nIG9uIHRoZSBldmVudAogICAgICogQHBhcmFtICAge09iamVjdH0gICAgZXYKICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgIGV2ZW50VHlwZSAgIHVzZWQgYnkgdGhlIGZha2VtdWx0aXRvdWNoIHBsdWdpbgogICAgICovCiAgICBnZXRUb3VjaExpc3Q6IGZ1bmN0aW9uIGdldFRvdWNoTGlzdChldi8qLCBldmVudFR5cGUqLykgewogICAgICAvLyBnZXQgdGhlIGZha2UgcG9pbnRlckV2ZW50IHRvdWNobGlzdAogICAgICBpZihpb25pYy5HZXN0dXJlcy5IQVNfUE9JTlRFUkVWRU5UUykgewogICAgICAgIHJldHVybiBpb25pYy5HZXN0dXJlcy5Qb2ludGVyRXZlbnQuZ2V0VG91Y2hMaXN0KCk7CiAgICAgIH0KICAgICAgLy8gZ2V0IHRoZSB0b3VjaGxpc3QKICAgICAgZWxzZSBpZihldi50b3VjaGVzKSB7CiAgICAgICAgcmV0dXJuIGV2LnRvdWNoZXM7CiAgICAgIH0KICAgICAgLy8gbWFrZSBmYWtlIHRvdWNobGlzdCBmcm9tIG1vdXNlIHBvc2l0aW9uCiAgICAgIGVsc2UgewogICAgICAgIGV2LmlkZW50aWZpZXIgPSAxOwogICAgICAgIHJldHVybiBbZXZdOwogICAgICB9CiAgICB9LAoKCiAgICAvKioKICAgICAqIGNvbGxlY3QgZXZlbnQgZGF0YSBmb3IgaW9uaWMuR2VzdHVyZXMganMKICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgICAgZXZlbnRUeXBlICAgICAgICBsaWtlIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkUKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICBldmVudERhdGEKICAgICAqLwogICAgY29sbGVjdEV2ZW50RGF0YTogZnVuY3Rpb24gY29sbGVjdEV2ZW50RGF0YShlbGVtZW50LCBldmVudFR5cGUsIHRvdWNoZXMsIGV2KSB7CgogICAgICAvLyBmaW5kIG91dCBwb2ludGVyVHlwZQogICAgICB2YXIgcG9pbnRlclR5cGUgPSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1RPVUNIOwogICAgICBpZihldi50eXBlLm1hdGNoKC9tb3VzZS8pIHx8IGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC5tYXRjaFR5cGUoaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRSwgZXYpKSB7CiAgICAgICAgcG9pbnRlclR5cGUgPSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGNlbnRlciAgICAgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0Q2VudGVyKHRvdWNoZXMpLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCAgIDogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ICAgICAgOiBldi50YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgdG91Y2hlcyAgICAgOiB0b3VjaGVzLAogICAgICAgICAgICAgICAgICAgIGV2ZW50VHlwZSAgIDogZXZlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgIHBvaW50ZXJUeXBlIDogcG9pbnRlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgc3JjRXZlbnQgICAgOiBldiwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogcHJldmVudCB0aGUgYnJvd3NlciBkZWZhdWx0IGFjdGlvbnMKICAgICAgICAgICAgICAgICAgICAgKiBtb3N0bHkgdXNlZCB0byBkaXNhYmxlIHNjcm9sbGluZyBvZiB0aGUgYnJvd3NlcgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3JjRXZlbnQucHJldmVudE1hbmlwdWxhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNyY0V2ZW50LnByZXZlbnRNYW5pcHVsYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vdGhpcy5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIHN0b3AgYnViYmxpbmcgdGhlIGV2ZW50IHVwIHRvIGl0cyBwYXJlbnRzCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3JjRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogaW1tZWRpYXRlbHkgc3RvcCBnZXN0dXJlIGRldGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAqIG1pZ2h0IGJlIHVzZWZ1bCBhZnRlciBhIHN3aXBlIHdhcyBkZXRlY3RlZAogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4geyp9CiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgc3RvcERldGVjdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLnN0b3BEZXRlY3QoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKCiAgaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50ID0gewogICAgLyoqCiAgICAgKiBob2xkcyBhbGwgcG9pbnRlcnMKICAgICAqIHR5cGUge09iamVjdH0KICAgICAqLwogICAgcG9pbnRlcnM6IHt9LAoKICAgIC8qKgogICAgICogZ2V0IGEgbGlzdCBvZiBwb2ludGVycwogICAgICogQHJldHVybnMge0FycmF5fSAgICAgdG91Y2hsaXN0CiAgICAgKi8KICAgIGdldFRvdWNoTGlzdDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIHRvdWNobGlzdCA9IFtdOwoKICAgICAgLy8gd2UgY2FuIHVzZSBmb3JFYWNoIHNpbmNlIHBvaW50ZXJFdmVudHMgb25seSBpcyBpbiBJRTEwCiAgICAgIE9iamVjdC5rZXlzKHNlbGYucG9pbnRlcnMpLnNvcnQoKS5mb3JFYWNoKGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgdG91Y2hsaXN0LnB1c2goc2VsZi5wb2ludGVyc1tpZF0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRvdWNobGlzdDsKICAgIH0sCgogICAgLyoqCiAgICAgKiB1cGRhdGUgdGhlIHBvc2l0aW9uIG9mIGEgcG9pbnRlcgogICAgICogQHBhcmFtICAge1N0cmluZ30gICB0eXBlICAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORAogICAgICogQHBhcmFtICAge09iamVjdH0gICBwb2ludGVyRXZlbnQKICAgICAqLwogICAgdXBkYXRlUG9pbnRlcjogZnVuY3Rpb24odHlwZSwgcG9pbnRlckV2ZW50KSB7CiAgICAgIGlmKHR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EKSB7CiAgICAgICAgdGhpcy5wb2ludGVycyA9IHt9OwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHBvaW50ZXJFdmVudC5pZGVudGlmaWVyID0gcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICB0aGlzLnBvaW50ZXJzW3BvaW50ZXJFdmVudC5wb2ludGVySWRdID0gcG9pbnRlckV2ZW50OwogICAgICB9CgogICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5wb2ludGVycykubGVuZ3RoOwogICAgfSwKCiAgICAvKioKICAgICAqIGNoZWNrIGlmIGV2IG1hdGNoZXMgcG9pbnRlcnR5cGUKICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBwb2ludGVyVHlwZSAgICAgaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRQogICAgICogQHBhcmFtICAge1BvaW50ZXJFdmVudH0gIGV2CiAgICAgKi8KICAgIG1hdGNoVHlwZTogZnVuY3Rpb24ocG9pbnRlclR5cGUsIGV2KSB7CiAgICAgIGlmKCFldi5wb2ludGVyVHlwZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIHR5cGVzID0ge307CiAgICAgIHR5cGVzW2lvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0VdID0gKGV2LnBvaW50ZXJUeXBlID09IGV2Lk1TUE9JTlRFUl9UWVBFX01PVVNFIHx8IGV2LnBvaW50ZXJUeXBlID09IGlvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0UpOwogICAgICB0eXBlc1tpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1RPVUNIXSA9IChldi5wb2ludGVyVHlwZSA9PSBldi5NU1BPSU5URVJfVFlQRV9UT1VDSCB8fCBldi5wb2ludGVyVHlwZSA9PSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1RPVUNIKTsKICAgICAgdHlwZXNbaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9QRU5dID0gKGV2LnBvaW50ZXJUeXBlID09IGV2Lk1TUE9JTlRFUl9UWVBFX1BFTiB8fCBldi5wb2ludGVyVHlwZSA9PSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1BFTik7CiAgICAgIHJldHVybiB0eXBlc1twb2ludGVyVHlwZV07CiAgICB9LAoKCiAgICAvKioKICAgICAqIGdldCBldmVudHMKICAgICAqLwogICAgZ2V0RXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFsKICAgICAgICAncG9pbnRlcmRvd24gTVNQb2ludGVyRG93bicsCiAgICAgICdwb2ludGVybW92ZSBNU1BvaW50ZXJNb3ZlJywKICAgICAgJ3BvaW50ZXJ1cCBwb2ludGVyY2FuY2VsIE1TUG9pbnRlclVwIE1TUG9pbnRlckNhbmNlbCcKICAgICAgICBdOwogICAgfSwKCiAgICAvKioKICAgICAqIHJlc2V0IHRoZSBsaXN0CiAgICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5wb2ludGVycyA9IHt9OwogICAgfQogIH07CgoKICBpb25pYy5HZXN0dXJlcy51dGlscyA9IHsKICAgIC8qKgogICAgICogZXh0ZW5kIG1ldGhvZCwKICAgICAqIGFsc28gdXNlZCBmb3IgY2xvbmluZyB3aGVuIGRlc3QgaXMgYW4gZW1wdHkgb2JqZWN0CiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBkZXN0CiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBzcmMKICAgICAqIEBwYXJhbQl7Qm9vbGVhbn0JbWVyZ2UJCWRvIGEgbWVyZ2UKICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgIGRlc3QKICAgICAqLwogICAgZXh0ZW5kOiBmdW5jdGlvbiBleHRlbmQoZGVzdCwgc3JjLCBtZXJnZSkgewogICAgICBmb3IgKHZhciBrZXkgaW4gc3JjKSB7CiAgICAgICAgaWYoZGVzdFtrZXldICE9PSB1bmRlZmluZWQgJiYgbWVyZ2UpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBkZXN0W2tleV0gPSBzcmNba2V5XTsKICAgICAgfQogICAgICByZXR1cm4gZGVzdDsKICAgIH0sCgoKICAgIC8qKgogICAgICogZmluZCBpZiBhIG5vZGUgaXMgaW4gdGhlIGdpdmVuIHBhcmVudAogICAgICogdXNlZCBmb3IgZXZlbnQgZGVsZWdhdGlvbiB0cmlja3MKICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBub2RlCiAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgcGFyZW50CiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gICAgICAgaGFzX3BhcmVudAogICAgICovCiAgICBoYXNQYXJlbnQ6IGZ1bmN0aW9uKG5vZGUsIHBhcmVudCkgewogICAgICB3aGlsZShub2RlKXsKICAgICAgICBpZihub2RlID09IHBhcmVudCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCgogICAgLyoqCiAgICAgKiBnZXQgdGhlIGNlbnRlciBvZiBhbGwgdGhlIHRvdWNoZXMKICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIHRvdWNoZXMKICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgIGNlbnRlcgogICAgICovCiAgICBnZXRDZW50ZXI6IGZ1bmN0aW9uIGdldENlbnRlcih0b3VjaGVzKSB7CiAgICAgIHZhciB2YWx1ZXNYID0gW10sIHZhbHVlc1kgPSBbXTsKCiAgICAgIGZvcih2YXIgdD0gMCxsZW49dG91Y2hlcy5sZW5ndGg7IHQ8bGVuOyB0KyspIHsKICAgICAgICB2YWx1ZXNYLnB1c2godG91Y2hlc1t0XS5wYWdlWCk7CiAgICAgICAgdmFsdWVzWS5wdXNoKHRvdWNoZXNbdF0ucGFnZVkpOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHBhZ2VYOiAoKE1hdGgubWluLmFwcGx5KE1hdGgsIHZhbHVlc1gpICsgTWF0aC5tYXguYXBwbHkoTWF0aCwgdmFsdWVzWCkpIC8gMiksCiAgICAgICAgICBwYWdlWTogKChNYXRoLm1pbi5hcHBseShNYXRoLCB2YWx1ZXNZKSArIE1hdGgubWF4LmFwcGx5KE1hdGgsIHZhbHVlc1kpKSAvIDIpCiAgICAgIH07CiAgICB9LAoKCiAgICAvKioKICAgICAqIGNhbGN1bGF0ZSB0aGUgdmVsb2NpdHkgYmV0d2VlbiB0d28gcG9pbnRzCiAgICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBkZWx0YV90aW1lCiAgICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBkZWx0YV94CiAgICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBkZWx0YV95CiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSAgICB2ZWxvY2l0eQogICAgICovCiAgICBnZXRWZWxvY2l0eTogZnVuY3Rpb24gZ2V0VmVsb2NpdHkoZGVsdGFfdGltZSwgZGVsdGFfeCwgZGVsdGFfeSkgewogICAgICByZXR1cm4gewogICAgICAgIHg6IE1hdGguYWJzKGRlbHRhX3ggLyBkZWx0YV90aW1lKSB8fCAwLAogICAgICAgIHk6IE1hdGguYWJzKGRlbHRhX3kgLyBkZWx0YV90aW1lKSB8fCAwCiAgICAgIH07CiAgICB9LAoKCiAgICAvKioKICAgICAqIGNhbGN1bGF0ZSB0aGUgYW5nbGUgYmV0d2VlbiB0d28gY29vcmRpbmF0ZXMKICAgICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMQogICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gyCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICBhbmdsZQogICAgICovCiAgICBnZXRBbmdsZTogZnVuY3Rpb24gZ2V0QW5nbGUodG91Y2gxLCB0b3VjaDIpIHsKICAgICAgdmFyIHkgPSB0b3VjaDIucGFnZVkgLSB0b3VjaDEucGFnZVksCiAgICAgIHggPSB0b3VjaDIucGFnZVggLSB0b3VjaDEucGFnZVg7CiAgICAgIHJldHVybiBNYXRoLmF0YW4yKHksIHgpICogMTgwIC8gTWF0aC5QSTsKICAgIH0sCgoKICAgIC8qKgogICAgICogYW5nbGUgdG8gZGlyZWN0aW9uIGRlZmluZQogICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gxCiAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDIKICAgICAqIEByZXR1cm5zIHtTdHJpbmd9ICAgIGRpcmVjdGlvbiBjb25zdGFudCwgbGlrZSBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fTEVGVAogICAgICovCiAgICBnZXREaXJlY3Rpb246IGZ1bmN0aW9uIGdldERpcmVjdGlvbih0b3VjaDEsIHRvdWNoMikgewogICAgICB2YXIgeCA9IE1hdGguYWJzKHRvdWNoMS5wYWdlWCAtIHRvdWNoMi5wYWdlWCksCiAgICAgIHkgPSBNYXRoLmFicyh0b3VjaDEucGFnZVkgLSB0b3VjaDIucGFnZVkpOwoKICAgICAgaWYoeCA+PSB5KSB7CiAgICAgICAgcmV0dXJuIHRvdWNoMS5wYWdlWCAtIHRvdWNoMi5wYWdlWCA+IDAgPyBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fTEVGVCA6IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9SSUdIVDsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXR1cm4gdG91Y2gxLnBhZ2VZIC0gdG91Y2gyLnBhZ2VZID4gMCA/IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9VUCA6IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9ET1dOOwogICAgICB9CiAgICB9LAoKCiAgICAvKioKICAgICAqIGNhbGN1bGF0ZSB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0d28gdG91Y2hlcwogICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gxCiAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDIKICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIGRpc3RhbmNlCiAgICAgKi8KICAgIGdldERpc3RhbmNlOiBmdW5jdGlvbiBnZXREaXN0YW5jZSh0b3VjaDEsIHRvdWNoMikgewogICAgICB2YXIgeCA9IHRvdWNoMi5wYWdlWCAtIHRvdWNoMS5wYWdlWCwKICAgICAgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWTsKICAgICAgcmV0dXJuIE1hdGguc3FydCgoeCp4KSArICh5KnkpKTsKICAgIH0sCgoKICAgIC8qKgogICAgICogY2FsY3VsYXRlIHRoZSBzY2FsZSBmYWN0b3IgYmV0d2VlbiB0d28gdG91Y2hMaXN0cyAoZmluZ2VycykKICAgICAqIG5vIHNjYWxlIGlzIDEsIGFuZCBnb2VzIGRvd24gdG8gMCB3aGVuIHBpbmNoZWQgdG9nZXRoZXIsIGFuZCBiaWdnZXIgd2hlbiBwaW5jaGVkIG91dAogICAgICogQHBhcmFtICAge0FycmF5fSAgICAgc3RhcnQKICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIGVuZAogICAgICogQHJldHVybnMge051bWJlcn0gICAgc2NhbGUKICAgICAqLwogICAgZ2V0U2NhbGU6IGZ1bmN0aW9uIGdldFNjYWxlKHN0YXJ0LCBlbmQpIHsKICAgICAgLy8gbmVlZCB0d28gZmluZ2Vycy4uLgogICAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXREaXN0YW5jZShlbmRbMF0sIGVuZFsxXSkgLwogICAgICAgICAgdGhpcy5nZXREaXN0YW5jZShzdGFydFswXSwgc3RhcnRbMV0pOwogICAgICB9CiAgICAgIHJldHVybiAxOwogICAgfSwKCgogICAgLyoqCiAgICAgKiBjYWxjdWxhdGUgdGhlIHJvdGF0aW9uIGRlZ3JlZXMgYmV0d2VlbiB0d28gdG91Y2hMaXN0cyAoZmluZ2VycykKICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIHN0YXJ0CiAgICAgKiBAcGFyYW0gICB7QXJyYXl9ICAgICBlbmQKICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIHJvdGF0aW9uCiAgICAgKi8KICAgIGdldFJvdGF0aW9uOiBmdW5jdGlvbiBnZXRSb3RhdGlvbihzdGFydCwgZW5kKSB7CiAgICAgIC8vIG5lZWQgdHdvIGZpbmdlcnMKICAgICAgaWYoc3RhcnQubGVuZ3RoID49IDIgJiYgZW5kLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QW5nbGUoZW5kWzFdLCBlbmRbMF0pIC0KICAgICAgICAgIHRoaXMuZ2V0QW5nbGUoc3RhcnRbMV0sIHN0YXJ0WzBdKTsKICAgICAgfQogICAgICByZXR1cm4gMDsKICAgIH0sCgoKICAgIC8qKgogICAgICogYm9vbGVhbiBpZiB0aGUgZGlyZWN0aW9uIGlzIHZlcnRpY2FsCiAgICAgKiBAcGFyYW0gICAge1N0cmluZ30gICAgZGlyZWN0aW9uCiAgICAgKiBAcmV0dXJucyAge0Jvb2xlYW59ICAgaXNfdmVydGljYWwKICAgICAqLwogICAgaXNWZXJ0aWNhbDogZnVuY3Rpb24gaXNWZXJ0aWNhbChkaXJlY3Rpb24pIHsKICAgICAgcmV0dXJuIChkaXJlY3Rpb24gPT0gaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1VQIHx8IGRpcmVjdGlvbiA9PSBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fRE9XTik7CiAgICB9LAoKCiAgICAvKioKICAgICAqIHN0b3AgYnJvd3NlciBkZWZhdWx0IGJlaGF2aW9yIHdpdGggY3NzIGNsYXNzCiAgICAgKiBAcGFyYW0gICB7SHRtbEVsZW1lbnR9ICAgZWxlbWVudAogICAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgIGNzc19jbGFzcwogICAgICovCiAgICBzdG9wRGVmYXVsdEJyb3dzZXJCZWhhdmlvcjogZnVuY3Rpb24gc3RvcERlZmF1bHRCcm93c2VyQmVoYXZpb3IoZWxlbWVudCwgY3NzX2NsYXNzKSB7CiAgICAgIC8vIGNoYW5nZWQgZnJvbSBtYWtpbmcgbWFueSBzdHlsZSBjaGFuZ2VzIHRvIGp1c3QgYWRkaW5nIGEgcHJlc2V0IGNsYXNzbmFtZQogICAgICAvLyBsZXNzIERPTSBtYW5pcHVsYXRpb25zLCBsZXNzIGNvZGUsIGFuZCBlYXNpZXIgdG8gY29udHJvbCBpbiB0aGUgQ1NTIHNpZGUgb2YgdGhpbmdzCiAgICAgIC8vIGhhbW1lci5qcyBkb2Vzbid0IGNvbWUgd2l0aCBDU1MsIGJ1dCBpb25pYyBkb2VzLCB3aGljaCBpcyB3aHkgd2UgcHJlZmVyIHRoaXMgbWV0aG9kCiAgICAgIGlmKGVsZW1lbnQgJiYgZWxlbWVudC5jbGFzc0xpc3QpIHsKICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoY3NzX2NsYXNzKTsKICAgICAgICBlbGVtZW50Lm9uc2VsZWN0c3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfTsKCgogIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbiA9IHsKICAgIC8vIGNvbnRhaW5zIGFsbCByZWdpc3RyZWQgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMgaW4gdGhlIGNvcnJlY3Qgb3JkZXIKICAgIGdlc3R1cmVzOiBbXSwKCiAgICAvLyBkYXRhIG9mIHRoZSBjdXJyZW50IGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgZGV0ZWN0aW9uIHNlc3Npb24KICAgIGN1cnJlbnQ6IG51bGwsCgogICAgLy8gdGhlIHByZXZpb3VzIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgc2Vzc2lvbiBkYXRhCiAgICAvLyBpcyBhIGZ1bGwgY2xvbmUgb2YgdGhlIHByZXZpb3VzIGdlc3R1cmUuY3VycmVudCBvYmplY3QKICAgIHByZXZpb3VzOiBudWxsLAoKICAgIC8vIHdoZW4gdGhpcyBiZWNvbWVzIHRydWUsIG5vIGdlc3R1cmVzIGFyZSBmaXJlZAogICAgc3RvcHBlZDogZmFsc2UsCgoKICAgIC8qKgogICAgICogc3RhcnQgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBkZXRlY3Rpb24KICAgICAqIEBwYXJhbSAgIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0gICBpbnN0CiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgICAgIGV2ZW50RGF0YQogICAgICovCiAgICBzdGFydERldGVjdDogZnVuY3Rpb24gc3RhcnREZXRlY3QoaW5zdCwgZXZlbnREYXRhKSB7CiAgICAgIC8vIGFscmVhZHkgYnVzeSB3aXRoIGEgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBkZXRlY3Rpb24gb24gYW4gZWxlbWVudAogICAgICBpZih0aGlzLmN1cnJlbnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuc3RvcHBlZCA9IGZhbHNlOwoKICAgICAgdGhpcy5jdXJyZW50ID0gewogICAgICAgIGluc3QgICAgICAgIDogaW5zdCwgLy8gcmVmZXJlbmNlIHRvIGlvbmljLkdlc3R1cmVzSW5zdGFuY2Ugd2UncmUgd29ya2luZyBmb3IKICAgICAgICBzdGFydEV2ZW50ICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCh7fSwgZXZlbnREYXRhKSwgLy8gc3RhcnQgZXZlbnREYXRhIGZvciBkaXN0YW5jZXMsIHRpbWluZyBldGMKICAgICAgICBsYXN0RXZlbnQgICA6IGZhbHNlLCAvLyBsYXN0IGV2ZW50RGF0YQogICAgICAgIG5hbWUgICAgICAgIDogJycgLy8gY3VycmVudCBnZXN0dXJlIHdlJ3JlIGluL2RldGVjdGVkLCBjYW4gYmUgJ3RhcCcsICdob2xkJyBldGMKICAgICAgfTsKCiAgICAgIHRoaXMuZGV0ZWN0KGV2ZW50RGF0YSk7CiAgICB9LAoKCiAgICAvKioKICAgICAqIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgZGV0ZWN0aW9uCiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBldmVudERhdGEKICAgICAqLwogICAgZGV0ZWN0OiBmdW5jdGlvbiBkZXRlY3QoZXZlbnREYXRhKSB7CiAgICAgIGlmKCF0aGlzLmN1cnJlbnQgfHwgdGhpcy5zdG9wcGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBleHRlbmQgZXZlbnQgZGF0YSB3aXRoIGNhbGN1bGF0aW9ucyBhYm91dCBzY2FsZSwgZGlzdGFuY2UgZXRjCiAgICAgIGV2ZW50RGF0YSA9IHRoaXMuZXh0ZW5kRXZlbnREYXRhKGV2ZW50RGF0YSk7CgogICAgICAvLyBpbnN0YW5jZSBvcHRpb25zCiAgICAgIHZhciBpbnN0X29wdGlvbnMgPSB0aGlzLmN1cnJlbnQuaW5zdC5vcHRpb25zOwoKICAgICAgLy8gY2FsbCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGhhbmRsZXJzCiAgICAgIGZvcih2YXIgZz0wLGxlbj10aGlzLmdlc3R1cmVzLmxlbmd0aDsgZzxsZW47IGcrKykgewogICAgICAgIHZhciBnZXN0dXJlID0gdGhpcy5nZXN0dXJlc1tnXTsKCiAgICAgICAgLy8gb25seSB3aGVuIHRoZSBpbnN0YW5jZSBvcHRpb25zIGhhdmUgZW5hYmxlZCB0aGlzIGdlc3R1cmUKICAgICAgICBpZighdGhpcy5zdG9wcGVkICYmIGluc3Rfb3B0aW9uc1tnZXN0dXJlLm5hbWVdICE9PSBmYWxzZSkgewogICAgICAgICAgLy8gaWYgYSBoYW5kbGVyIHJldHVybnMgZmFsc2UsIHdlIHN0b3Agd2l0aCB0aGUgZGV0ZWN0aW9uCiAgICAgICAgICBpZihnZXN0dXJlLmhhbmRsZXIuY2FsbChnZXN0dXJlLCBldmVudERhdGEsIHRoaXMuY3VycmVudC5pbnN0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy5zdG9wRGV0ZWN0KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gc3RvcmUgYXMgcHJldmlvdXMgZXZlbnQgZXZlbnQKICAgICAgaWYodGhpcy5jdXJyZW50KSB7CiAgICAgICAgdGhpcy5jdXJyZW50Lmxhc3RFdmVudCA9IGV2ZW50RGF0YTsKICAgICAgfQoKICAgICAgLy8gZW5kZXZlbnQsIGJ1dCBub3QgdGhlIGxhc3QgdG91Y2gsIHNvIGRvbnQgc3RvcAogICAgICBpZihldmVudERhdGEuZXZlbnRUeXBlID09IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCAmJiAhZXZlbnREYXRhLnRvdWNoZXMubGVuZ3RoLTEpIHsKICAgICAgICB0aGlzLnN0b3BEZXRlY3QoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGV2ZW50RGF0YTsKICAgIH0sCgoKICAgIC8qKgogICAgICogY2xlYXIgdGhlIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgdmFycwogICAgICogdGhpcyBpcyBjYWxsZWQgb24gZW5kRGV0ZWN0LCBidXQgY2FuIGFsc28gYmUgdXNlZCB3aGVuIGEgZmluYWwgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBoYXMgYmVlbiBkZXRlY3RlZAogICAgICogdG8gc3RvcCBvdGhlciBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcyBmcm9tIGJlaW5nIGZpcmVkCiAgICAgKi8KICAgIHN0b3BEZXRlY3Q6IGZ1bmN0aW9uIHN0b3BEZXRlY3QoKSB7CiAgICAgIC8vIGNsb25lIGN1cnJlbnQgZGF0YSB0byB0aGUgc3RvcmUgYXMgdGhlIHByZXZpb3VzIGdlc3R1cmUKICAgICAgLy8gdXNlZCBmb3IgdGhlIGRvdWJsZSB0YXAgZ2VzdHVyZSwgc2luY2UgdGhpcyBpcyBhbiBvdGhlciBnZXN0dXJlIGRldGVjdCBzZXNzaW9uCiAgICAgIHRoaXMucHJldmlvdXMgPSBpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoe30sIHRoaXMuY3VycmVudCk7CgogICAgICAvLyByZXNldCB0aGUgY3VycmVudAogICAgICB0aGlzLmN1cnJlbnQgPSBudWxsOwoKICAgICAgLy8gc3RvcHBlZCEKICAgICAgdGhpcy5zdG9wcGVkID0gdHJ1ZTsKICAgIH0sCgoKICAgIC8qKgogICAgICogZXh0ZW5kIGV2ZW50RGF0YSBmb3IgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgZXYKICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgZXYKICAgICAqLwogICAgZXh0ZW5kRXZlbnREYXRhOiBmdW5jdGlvbiBleHRlbmRFdmVudERhdGEoZXYpIHsKICAgICAgdmFyIHN0YXJ0RXYgPSB0aGlzLmN1cnJlbnQuc3RhcnRFdmVudDsKCiAgICAgIC8vIGlmIHRoZSB0b3VjaGVzIGNoYW5nZSwgc2V0IHRoZSBuZXcgdG91Y2hlcyBvdmVyIHRoZSBzdGFydEV2ZW50IHRvdWNoZXMKICAgICAgLy8gdGhpcyBiZWNhdXNlIHRvdWNoZXZlbnRzIGRvbid0IGhhdmUgYWxsIHRoZSB0b3VjaGVzIG9uIHRvdWNoc3RhcnQsIG9yIHRoZQogICAgICAvLyB1c2VyIG11c3QgcGxhY2UgaGlzIGZpbmdlcnMgYXQgdGhlIEVYQUNUIHNhbWUgdGltZSBvbiB0aGUgc2NyZWVuLCB3aGljaCBpcyBub3QgcmVhbGlzdGljCiAgICAgIC8vIGJ1dCwgc29tZXRpbWVzIGl0IGhhcHBlbnMgdGhhdCBib3RoIGZpbmdlcnMgYXJlIHRvdWNoaW5nIGF0IHRoZSBFWEFDVCBzYW1lIHRpbWUKICAgICAgaWYoc3RhcnRFdiAmJiAoZXYudG91Y2hlcy5sZW5ndGggIT0gc3RhcnRFdi50b3VjaGVzLmxlbmd0aCB8fCBldi50b3VjaGVzID09PSBzdGFydEV2LnRvdWNoZXMpKSB7CiAgICAgICAgLy8gZXh0ZW5kIDEgbGV2ZWwgZGVlcCB0byBnZXQgdGhlIHRvdWNobGlzdCB3aXRoIHRoZSB0b3VjaCBvYmplY3RzCiAgICAgICAgc3RhcnRFdi50b3VjaGVzID0gW107CiAgICAgICAgZm9yKHZhciBpPTAsbGVuPWV2LnRvdWNoZXMubGVuZ3RoOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICBzdGFydEV2LnRvdWNoZXMucHVzaChpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoe30sIGV2LnRvdWNoZXNbaV0pKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBkZWx0YV90aW1lID0gZXYudGltZVN0YW1wIC0gc3RhcnRFdi50aW1lU3RhbXAsCiAgICAgICAgICBkZWx0YV94ID0gZXYuY2VudGVyLnBhZ2VYIC0gc3RhcnRFdi5jZW50ZXIucGFnZVgsCiAgICAgICAgICBkZWx0YV95ID0gZXYuY2VudGVyLnBhZ2VZIC0gc3RhcnRFdi5jZW50ZXIucGFnZVksCiAgICAgICAgICB2ZWxvY2l0eSA9IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldFZlbG9jaXR5KGRlbHRhX3RpbWUsIGRlbHRhX3gsIGRlbHRhX3kpOwoKICAgICAgaW9uaWMuR2VzdHVyZXMudXRpbHMuZXh0ZW5kKGV2LCB7CiAgICAgICAgZGVsdGFUaW1lICAgOiBkZWx0YV90aW1lLAoKICAgICAgICBkZWx0YVggICAgICA6IGRlbHRhX3gsCiAgICAgICAgZGVsdGFZICAgICAgOiBkZWx0YV95LAoKICAgICAgICB2ZWxvY2l0eVggICA6IHZlbG9jaXR5LngsCiAgICAgICAgdmVsb2NpdHlZICAgOiB2ZWxvY2l0eS55LAoKICAgICAgICBkaXN0YW5jZSAgICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldERpc3RhbmNlKHN0YXJ0RXYuY2VudGVyLCBldi5jZW50ZXIpLAogICAgICAgIGFuZ2xlICAgICAgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0QW5nbGUoc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCiAgICAgICAgZGlyZWN0aW9uICAgOiBpb25pYy5HZXN0dXJlcy51dGlscy5nZXREaXJlY3Rpb24oc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCgogICAgICAgIHNjYWxlICAgICAgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0U2NhbGUoc3RhcnRFdi50b3VjaGVzLCBldi50b3VjaGVzKSwKICAgICAgICByb3RhdGlvbiAgICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldFJvdGF0aW9uKHN0YXJ0RXYudG91Y2hlcywgZXYudG91Y2hlcyksCgogICAgICAgIHN0YXJ0RXZlbnQgIDogc3RhcnRFdgogICAgICB9KTsKCiAgICAgIHJldHVybiBldjsKICAgIH0sCgoKICAgIC8qKgogICAgICogcmVnaXN0ZXIgbmV3IGdlc3R1cmUKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIGdlc3R1cmUgb2JqZWN0LCBzZWUgZ2VzdHVyZXMuanMgZm9yIGRvY3VtZW50YXRpb24KICAgICAqIEByZXR1cm5zIHtBcnJheX0gICAgIGdlc3R1cmVzCiAgICAgKi8KICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiByZWdpc3RlcihnZXN0dXJlKSB7CiAgICAgIC8vIGFkZCBhbiBlbmFibGUgZ2VzdHVyZSBvcHRpb25zIGlmIHRoZXJlIGlzIG5vIGdpdmVuCiAgICAgIHZhciBvcHRpb25zID0gZ2VzdHVyZS5kZWZhdWx0cyB8fCB7fTsKICAgICAgaWYob3B0aW9uc1tnZXN0dXJlLm5hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICBvcHRpb25zW2dlc3R1cmUubmFtZV0gPSB0cnVlOwogICAgICB9CgogICAgICAvLyBleHRlbmQgaW9uaWMuR2VzdHVyZXMgZGVmYXVsdCBvcHRpb25zIHdpdGggdGhlIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgb3B0aW9ucwogICAgICBpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoaW9uaWMuR2VzdHVyZXMuZGVmYXVsdHMsIG9wdGlvbnMsIHRydWUpOwoKICAgICAgLy8gc2V0IGl0cyBpbmRleAogICAgICBnZXN0dXJlLmluZGV4ID0gZ2VzdHVyZS5pbmRleCB8fCAxMDAwOwoKICAgICAgLy8gYWRkIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgdG8gdGhlIGxpc3QKICAgICAgdGhpcy5nZXN0dXJlcy5wdXNoKGdlc3R1cmUpOwoKICAgICAgLy8gc29ydCB0aGUgbGlzdCBieSBpbmRleAogICAgICB0aGlzLmdlc3R1cmVzLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIGlmIChhLmluZGV4IDwgYi5pbmRleCkgewogICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgICAgICBpZiAoYS5pbmRleCA+IGIuaW5kZXgpIHsKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgICAgfSk7CgogICAgICByZXR1cm4gdGhpcy5nZXN0dXJlczsKICAgIH0KICB9OwoKCiAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMgPSBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcyB8fCB7fTsKCiAgLyoqCiAgICogQ3VzdG9tIGdlc3R1cmVzCiAgICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICoKICAgKiBHZXN0dXJlIG9iamVjdAogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVGhlIG9iamVjdCBzdHJ1Y3R1cmUgb2YgYSBnZXN0dXJlOgogICAqCiAgICogeyBuYW1lOiAnbXlnZXN0dXJlJywKICAgKiAgIGluZGV4OiAxMzM3LAogICAqICAgZGVmYXVsdHM6IHsKICAgKiAgICAgbXlnZXN0dXJlX29wdGlvbjogdHJ1ZQogICAqICAgfQogICAqICAgaGFuZGxlcjogZnVuY3Rpb24odHlwZSwgZXYsIGluc3QpIHsKICAgKiAgICAgLy8gdHJpZ2dlciBnZXN0dXJlIGV2ZW50CiAgICogICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICAgKiAgIH0KICAgKiB9CgogICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgIG5hbWUKICAgKiB0aGlzIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgZ2VzdHVyZSwgbG93ZXJjYXNlCiAgICogaXQgaXMgYWxzbyBiZWluZyB1c2VkIHRvIGRpc2FibGUvZW5hYmxlIHRoZSBnZXN0dXJlIHBlciBpbnN0YW5jZSBjb25maWcuCiAgICoKICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBbaW5kZXg9MTAwMF0KICAgKiB0aGUgaW5kZXggb2YgdGhlIGdlc3R1cmUsIHdoZXJlIGl0IGlzIGdvaW5nIHRvIGJlIGluIHRoZSBzdGFjayBvZiBnZXN0dXJlcyBkZXRlY3Rpb24KICAgKiBsaWtlIHdoZW4geW91IGJ1aWxkIGFuIGdlc3R1cmUgdGhhdCBkZXBlbmRzIG9uIHRoZSBkcmFnIGdlc3R1cmUsIGl0IGlzIGEgZ29vZAogICAqIGlkZWEgdG8gcGxhY2UgaXQgYWZ0ZXIgdGhlIGluZGV4IG9mIHRoZSBkcmFnIGdlc3R1cmUuCiAgICoKICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBbZGVmYXVsdHM9e31dCiAgICogdGhlIGRlZmF1bHQgc2V0dGluZ3Mgb2YgdGhlIGdlc3R1cmUuIHRoZXNlIGFyZSBhZGRlZCB0byB0aGUgaW5zdGFuY2Ugc2V0dGluZ3MsCiAgICogYW5kIGNhbiBiZSBvdmVycnVsZWQgcGVyIGluc3RhbmNlLiB5b3UgY2FuIGFsc28gYWRkIHRoZSBuYW1lIG9mIHRoZSBnZXN0dXJlLAogICAqIGJ1dCB0aGlzIGlzIGFsc28gYWRkZWQgYnkgZGVmYXVsdCAoYW5kIHNldCB0byB0cnVlKS4KICAgKgogICAqIEBwYXJhbSAgIHtGdW5jdGlvbn0gIGhhbmRsZXIKICAgKiB0aGlzIGhhbmRsZXMgdGhlIGdlc3R1cmUgZGV0ZWN0aW9uIG9mIHlvdXIgY3VzdG9tIGdlc3R1cmUgYW5kIHJlY2VpdmVzIHRoZQogICAqIGZvbGxvd2luZyBhcmd1bWVudHM6CiAgICoKICAgKiAgICAgIEBwYXJhbSAge09iamVjdH0gICAgZXZlbnREYXRhCiAgICogICAgICBldmVudCBkYXRhIGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAqICAgICAgICAgIHRpbWVTdGFtcCAgIHtOdW1iZXJ9ICAgICAgICB0aW1lIHRoZSBldmVudCBvY2N1cnJlZAogICAqICAgICAgICAgIHRhcmdldCAgICAgIHtIVE1MRWxlbWVudH0gICB0YXJnZXQgZWxlbWVudAogICAqICAgICAgICAgIHRvdWNoZXMgICAgIHtBcnJheX0gICAgICAgICB0b3VjaGVzIChmaW5nZXJzLCBwb2ludGVycywgbW91c2UpIG9uIHRoZSBzY3JlZW4KICAgKiAgICAgICAgICBwb2ludGVyVHlwZSB7U3RyaW5nfSAgICAgICAga2luZCBvZiBwb2ludGVyIHRoYXQgd2FzIHVzZWQuIG1hdGNoZXMgaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRXxUT1VDSAogICAqICAgICAgICAgIGNlbnRlciAgICAgIHtPYmplY3R9ICAgICAgICBjZW50ZXIgcG9zaXRpb24gb2YgdGhlIHRvdWNoZXMuIGNvbnRhaW5zIHBhZ2VYIGFuZCBwYWdlWQogICAqICAgICAgICAgIGRlbHRhVGltZSAgIHtOdW1iZXJ9ICAgICAgICB0aGUgdG90YWwgdGltZSBvZiB0aGUgdG91Y2hlcyBpbiB0aGUgc2NyZWVuCiAgICogICAgICAgICAgZGVsdGFYICAgICAge051bWJlcn0gICAgICAgIHRoZSBkZWx0YSBvbiB4IGF4aXMgd2UgaGF2ZWQgbW92ZWQKICAgKiAgICAgICAgICBkZWx0YVkgICAgICB7TnVtYmVyfSAgICAgICAgdGhlIGRlbHRhIG9uIHkgYXhpcyB3ZSBoYXZlZCBtb3ZlZAogICAqICAgICAgICAgIHZlbG9jaXR5WCAgIHtOdW1iZXJ9ICAgICAgICB0aGUgdmVsb2NpdHkgb24gdGhlIHgKICAgKiAgICAgICAgICB2ZWxvY2l0eVkgICB7TnVtYmVyfSAgICAgICAgdGhlIHZlbG9jaXR5IG9uIHkKICAgKiAgICAgICAgICBhbmdsZSAgICAgICB7TnVtYmVyfSAgICAgICAgdGhlIGFuZ2xlIHdlIGFyZSBtb3ZpbmcKICAgKiAgICAgICAgICBkaXJlY3Rpb24gICB7U3RyaW5nfSAgICAgICAgdGhlIGRpcmVjdGlvbiB3ZSBhcmUgbW92aW5nLiBtYXRjaGVzIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9VUHxET1dOfExFRlR8UklHSFQKICAgKiAgICAgICAgICBkaXN0YW5jZSAgICB7TnVtYmVyfSAgICAgICAgdGhlIGRpc3RhbmNlIHdlIGhhdmVkIG1vdmVkCiAgICogICAgICAgICAgc2NhbGUgICAgICAge051bWJlcn0gICAgICAgIHNjYWxpbmcgb2YgdGhlIHRvdWNoZXMsIG5lZWRzIDIgdG91Y2hlcwogICAqICAgICAgICAgIHJvdGF0aW9uICAgIHtOdW1iZXJ9ICAgICAgICByb3RhdGlvbiBvZiB0aGUgdG91Y2hlcywgbmVlZHMgMiB0b3VjaGVzICoKICAgKiAgICAgICAgICBldmVudFR5cGUgICB7U3RyaW5nfSAgICAgICAgbWF0Y2hlcyBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVHxNT1ZFfEVORAogICAqICAgICAgICAgIHNyY0V2ZW50ICAgIHtPYmplY3R9ICAgICAgICB0aGUgc291cmNlIGV2ZW50LCBsaWtlIFRvdWNoU3RhcnQgb3IgTW91c2VEb3duICoKICAgKiAgICAgICAgICBzdGFydEV2ZW50ICB7T2JqZWN0fSAgICAgICAgY29udGFpbnMgdGhlIHNhbWUgcHJvcGVydGllcyBhcyBhYm92ZSwKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0IGZyb20gdGhlIGZpcnN0IHRvdWNoLiB0aGlzIGlzIHVzZWQgdG8gY2FsY3VsYXRlCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3RhbmNlcywgZGVsdGFUaW1lLCBzY2FsaW5nIGV0YwogICAqCiAgICogICAgICBAcGFyYW0gIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0gICAgaW5zdAogICAqICAgICAgdGhlIGluc3RhbmNlIHdlIGFyZSBkb2luZyB0aGUgZGV0ZWN0aW9uIGZvci4geW91IGNhbiBnZXQgdGhlIG9wdGlvbnMgZnJvbQogICAqICAgICAgdGhlIGluc3Qub3B0aW9ucyBvYmplY3QgYW5kIHRyaWdnZXIgdGhlIGdlc3R1cmUgZXZlbnQgYnkgY2FsbGluZyBpbnN0LnRyaWdnZXIKICAgKgogICAqCiAgICogSGFuZGxlIGdlc3R1cmVzCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBpbnNpZGUgdGhlIGhhbmRsZXIgeW91IGNhbiBnZXQvc2V0IGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLmN1cnJlbnQuIFRoaXMgaXMgdGhlIGN1cnJlbnQKICAgKiBkZXRlY3Rpb24gc2Vzc2lvbmljLiBJdCBoYXMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzCiAgICogICAgICBAcGFyYW0gIHtTdHJpbmd9ICAgIG5hbWUKICAgKiAgICAgIGNvbnRhaW5zIHRoZSBuYW1lIG9mIHRoZSBnZXN0dXJlIHdlIGhhdmUgZGV0ZWN0ZWQuIGl0IGhhcyBub3QgYSByZWFsIGZ1bmN0aW9uLAogICAqICAgICAgb25seSB0byBjaGVjayBpbiBvdGhlciBnZXN0dXJlcyBpZiBzb21ldGhpbmcgaXMgZGV0ZWN0ZWQuCiAgICogICAgICBsaWtlIGluIHRoZSBkcmFnIGdlc3R1cmUgd2Ugc2V0IGl0IHRvICdkcmFnJyBhbmQgaW4gdGhlIHN3aXBlIGdlc3R1cmUgd2UgY2FuCiAgICogICAgICBjaGVjayBpZiB0aGUgY3VycmVudCBnZXN0dXJlIGlzICdkcmFnJyBieSBhY2Nlc3NpbmcgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uaWMuY3VycmVudC5uYW1lCiAgICoKICAgKiAgICAgIHJlYWRvbmx5CiAgICogICAgICBAcGFyYW0gIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0gICAgaW5zdAogICAqICAgICAgdGhlIGluc3RhbmNlIHdlIGRvIHRoZSBkZXRlY3Rpb24gZm9yCiAgICoKICAgKiAgICAgIHJlYWRvbmx5CiAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIHN0YXJ0RXZlbnQKICAgKiAgICAgIGNvbnRhaW5zIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBmaXJzdCBnZXN0dXJlIGRldGVjdGlvbiBpbiB0aGlzIHNlc3Npb25pYy4KICAgKiAgICAgIFVzZWQgZm9yIGNhbGN1bGF0aW9ucyBhYm91dCB0aW1pbmcsIGRpc3RhbmNlLCBldGMuCiAgICoKICAgKiAgICAgIHJlYWRvbmx5CiAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIGxhc3RFdmVudAogICAqICAgICAgY29udGFpbnMgYWxsIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBsYXN0IGdlc3R1cmUgZGV0ZWN0IGluIHRoaXMgc2Vzc2lvbmljLgogICAqCiAgICogYWZ0ZXIgdGhlIGdlc3R1cmUgZGV0ZWN0aW9uIHNlc3Npb24gaGFzIGJlZW4gY29tcGxldGVkICh1c2VyIGhhcyByZWxlYXNlZCB0aGUgc2NyZWVuKQogICAqIHRoZSBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb25pYy5jdXJyZW50IG9iamVjdCBpcyBjb3BpZWQgaW50byBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb25pYy5wcmV2aW91cywKICAgKiB0aGlzIGlzIHVzZWZ1bGwgZm9yIGdlc3R1cmVzIGxpa2UgZG91YmxldGFwLCB3aGVyZSB5b3UgbmVlZCB0byBrbm93IGlmIHRoZQogICAqIHByZXZpb3VzIGdlc3R1cmUgd2FzIGEgdGFwCiAgICoKICAgKiBvcHRpb25zIHRoYXQgaGF2ZSBiZWVuIHNldCBieSB0aGUgaW5zdGFuY2UgY2FuIGJlIHJlY2VpdmVkIGJ5IGNhbGxpbmcgaW5zdC5vcHRpb25zCiAgICoKICAgKiBZb3UgY2FuIHRyaWdnZXIgYSBnZXN0dXJlIGV2ZW50IGJ5IGNhbGxpbmcgaW5zdC50cmlnZ2VyKCJteWdlc3R1cmUiLCBldmVudCkuCiAgICogVGhlIGZpcnN0IHBhcmFtIGlzIHRoZSBuYW1lIG9mIHlvdXIgZ2VzdHVyZSwgdGhlIHNlY29uZCB0aGUgZXZlbnQgYXJndW1lbnQKICAgKgogICAqCiAgICogUmVnaXN0ZXIgZ2VzdHVyZXMKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFdoZW4gYW4gZ2VzdHVyZSBpcyBhZGRlZCB0byB0aGUgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMgb2JqZWN0LCBpdCBpcyBhdXRvIHJlZ2lzdGVyZWQKICAgKiBhdCB0aGUgc2V0dXAgb2YgdGhlIGZpcnN0IGlvbmljLkdlc3R1cmVzIGluc3RhbmNlLiBZb3UgY2FuIGFsc28gY2FsbCBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb25pYy5yZWdpc3RlcgogICAqIG1hbnVhbGx5IGFuZCBwYXNzIHlvdXIgZ2VzdHVyZSBvYmplY3QgYXMgYSBwYXJhbQogICAqCiAgICovCgogIC8qKgogICAqIEhvbGQKICAgKiBUb3VjaCBzdGF5cyBhdCB0aGUgc2FtZSBwbGFjZSBmb3IgeCB0aW1lCiAgICogZXZlbnRzICBob2xkCiAgICovCiAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuSG9sZCA9IHsKICAgIG5hbWU6ICdob2xkJywKICAgIGluZGV4OiAxMCwKICAgIGRlZmF1bHRzOiB7CiAgICAgIGhvbGRfdGltZW91dAk6IDUwMCwKICAgICAgaG9sZF90aHJlc2hvbGQJOiAxCiAgICB9LAogICAgdGltZXI6IG51bGwsCiAgICBoYW5kbGVyOiBmdW5jdGlvbiBob2xkR2VzdHVyZShldiwgaW5zdCkgewogICAgICBzd2l0Y2goZXYuZXZlbnRUeXBlKSB7CiAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVDoKICAgICAgICAgIC8vIGNsZWFyIGFueSBydW5uaW5nIHRpbWVycwogICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwoKICAgICAgICAgIC8vIHNldCB0aGUgZ2VzdHVyZSBzbyB3ZSBjYW4gY2hlY2sgaW4gdGhlIHRpbWVvdXQgaWYgaXQgc3RpbGwgaXMKICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSB0aGlzLm5hbWU7CgogICAgICAgICAgLy8gc2V0IHRpbWVyIGFuZCBpZiBhZnRlciB0aGUgdGltZW91dCBpdCBzdGlsbCBpcyBob2xkLAogICAgICAgICAgLy8gd2UgdHJpZ2dlciB0aGUgaG9sZCBldmVudAogICAgICAgICAgdGhpcy50aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPT0gJ2hvbGQnKSB7CiAgICAgICAgICAgICAgaW9uaWMudGFwLmNhbmNlbENsaWNrKCk7CiAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdob2xkJywgZXYpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBpbnN0Lm9wdGlvbnMuaG9sZF90aW1lb3V0KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIC8vIHdoZW4geW91IG1vdmUgb3IgZW5kIHdlIGNsZWFyIHRoZSB0aW1lcgogICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRToKICAgICAgICAgIGlmKGV2LmRpc3RhbmNlID4gaW5zdC5vcHRpb25zLmhvbGRfdGhyZXNob2xkKSB7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORDoKICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfTsKCgogIC8qKgogICAqIFRhcC9Eb3VibGVUYXAKICAgKiBRdWljayB0b3VjaCBhdCBhIHBsYWNlIG9yIGRvdWJsZSBhdCB0aGUgc2FtZSBwbGFjZQogICAqIGV2ZW50cyAgdGFwLCBkb3VibGV0YXAKICAgKi8KICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5UYXAgPSB7CiAgICBuYW1lOiAndGFwJywKICAgIGluZGV4OiAxMDAsCiAgICBkZWZhdWx0czogewogICAgICB0YXBfbWF4X3RvdWNodGltZQk6IDI1MCwKICAgICAgdGFwX21heF9kaXN0YW5jZQk6IDEwLAogICAgICB0YXBfYWx3YXlzCQkJOiB0cnVlLAogICAgICBkb3VibGV0YXBfZGlzdGFuY2UJOiAyMCwKICAgICAgZG91YmxldGFwX2ludGVydmFsCTogMzAwCiAgICB9LAogICAgaGFuZGxlcjogZnVuY3Rpb24gdGFwR2VzdHVyZShldiwgaW5zdCkgewogICAgICBpZihldi5ldmVudFR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EICYmIGV2LnNyY0V2ZW50LnR5cGUgIT0gJ3RvdWNoY2FuY2VsJykgewogICAgICAgIC8vIHByZXZpb3VzIGdlc3R1cmUsIGZvciB0aGUgZG91YmxlIHRhcCBzaW5jZSB0aGVzZSBhcmUgdHdvIGRpZmZlcmVudCBnZXN0dXJlIGRldGVjdGlvbnMKICAgICAgICB2YXIgcHJldiA9IGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5wcmV2aW91cywKICAgICAgICBkaWRfZG91YmxldGFwID0gZmFsc2U7CgogICAgICAgIC8vIHdoZW4gdGhlIHRvdWNodGltZSBpcyBoaWdoZXIgdGhlbiB0aGUgbWF4IHRvdWNoIHRpbWUKICAgICAgICAvLyBvciB3aGVuIHRoZSBtb3ZpbmcgZGlzdGFuY2UgaXMgdG9vIG11Y2gKICAgICAgICBpZihldi5kZWx0YVRpbWUgPiBpbnN0Lm9wdGlvbnMudGFwX21heF90b3VjaHRpbWUgfHwKICAgICAgICAgICAgZXYuZGlzdGFuY2UgPiBpbnN0Lm9wdGlvbnMudGFwX21heF9kaXN0YW5jZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBjaGVjayBpZiBkb3VibGUgdGFwCiAgICAgICAgaWYocHJldiAmJiBwcmV2Lm5hbWUgPT0gJ3RhcCcgJiYKICAgICAgICAgICAgKGV2LnRpbWVTdGFtcCAtIHByZXYubGFzdEV2ZW50LnRpbWVTdGFtcCkgPCBpbnN0Lm9wdGlvbnMuZG91YmxldGFwX2ludGVydmFsICYmCiAgICAgICAgICAgIGV2LmRpc3RhbmNlIDwgaW5zdC5vcHRpb25zLmRvdWJsZXRhcF9kaXN0YW5jZSkgewogICAgICAgICAgICAgIGluc3QudHJpZ2dlcignZG91YmxldGFwJywgZXYpOwogICAgICAgICAgICAgIGRpZF9kb3VibGV0YXAgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgIC8vIGRvIGEgc2luZ2xlIHRhcAogICAgICAgIGlmKCFkaWRfZG91YmxldGFwIHx8IGluc3Qub3B0aW9ucy50YXBfYWx3YXlzKSB7CiAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5uYW1lID0gJ3RhcCc7CiAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3RhcCcsIGV2KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKCiAgLyoqCiAgICogU3dpcGUKICAgKiB0cmlnZ2VycyBzd2lwZSBldmVudHMgd2hlbiB0aGUgZW5kIHZlbG9jaXR5IGlzIGFib3ZlIHRoZSB0aHJlc2hvbGQKICAgKiBldmVudHMgIHN3aXBlLCBzd2lwZWxlZnQsIHN3aXBlcmlnaHQsIHN3aXBldXAsIHN3aXBlZG93bgogICAqLwogIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLlN3aXBlID0gewogICAgbmFtZTogJ3N3aXBlJywKICAgIGluZGV4OiA0MCwKICAgIGRlZmF1bHRzOiB7CiAgICAgIC8vIHNldCAwIGZvciB1bmxpbWl0ZWQsIGJ1dCB0aGlzIGNhbiBjb25mbGljdCB3aXRoIHRyYW5zZm9ybQogICAgICBzd2lwZV9tYXhfdG91Y2hlcyAgOiAxLAogICAgICBzd2lwZV92ZWxvY2l0eSAgICAgOiAwLjcKICAgIH0sCiAgICBoYW5kbGVyOiBmdW5jdGlvbiBzd2lwZUdlc3R1cmUoZXYsIGluc3QpIHsKICAgICAgaWYoZXYuZXZlbnRUeXBlID09IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCkgewogICAgICAgIC8vIG1heCB0b3VjaGVzCiAgICAgICAgaWYoaW5zdC5vcHRpb25zLnN3aXBlX21heF90b3VjaGVzID4gMCAmJgogICAgICAgICAgICBldi50b3VjaGVzLmxlbmd0aCA+IGluc3Qub3B0aW9ucy5zd2lwZV9tYXhfdG91Y2hlcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAvLyB3aGVuIHRoZSBkaXN0YW5jZSB3ZSBtb3ZlZCBpcyB0b28gc21hbGwgd2Ugc2tpcCB0aGlzIGdlc3R1cmUKICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgIGlmKGV2LnZlbG9jaXR5WCA+IGluc3Qub3B0aW9ucy5zd2lwZV92ZWxvY2l0eSB8fAogICAgICAgICAgICBldi52ZWxvY2l0eVkgPiBpbnN0Lm9wdGlvbnMuc3dpcGVfdmVsb2NpdHkpIHsKICAgICAgICAgICAgICAvLyB0cmlnZ2VyIHN3aXBlIGV2ZW50cwogICAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsgZXYuZGlyZWN0aW9uLCBldik7CiAgICAgICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgoKICAvKioKICAgKiBEcmFnCiAgICogTW92ZSB3aXRoIHggZmluZ2VycyAoZGVmYXVsdCAxKSBhcm91bmQgb24gdGhlIHBhZ2UuIEJsb2NraW5nIHRoZSBzY3JvbGxpbmcgd2hlbgogICAqIG1vdmluZyBsZWZ0IGFuZCByaWdodCBpcyBhIGdvb2QgcHJhY3RpY2UuIFdoZW4gYWxsIHRoZSBkcmFnIGV2ZW50cyBhcmUgYmxvY2tpbmcKICAgKiB5b3UgZGlzYWJsZSBzY3JvbGxpbmcgb24gdGhhdCBhcmVhLgogICAqIGV2ZW50cyAgZHJhZywgZHJhcGxlZnQsIGRyYWdyaWdodCwgZHJhZ3VwLCBkcmFnZG93bgogICAqLwogIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLkRyYWcgPSB7CiAgICBuYW1lOiAnZHJhZycsCiAgICBpbmRleDogNTAsCiAgICBkZWZhdWx0czogewogICAgICBkcmFnX21pbl9kaXN0YW5jZSA6IDEwLAogICAgICAvLyBTZXQgY29ycmVjdF9mb3JfZHJhZ19taW5fZGlzdGFuY2UgdG8gdHJ1ZSB0byBtYWtlIHRoZSBzdGFydGluZyBwb2ludCBvZiB0aGUgZHJhZwogICAgICAvLyBiZSBjYWxjdWxhdGVkIGZyb20gd2hlcmUgdGhlIGRyYWcgd2FzIHRyaWdnZXJlZCwgbm90IGZyb20gd2hlcmUgdGhlIHRvdWNoIHN0YXJ0ZWQuCiAgICAgIC8vIFVzZWZ1bCB0byBhdm9pZCBhIGplcmstc3RhcnRpbmcgZHJhZywgd2hpY2ggY2FuIG1ha2UgZmluZS1hZGp1c3RtZW50cwogICAgICAvLyB0aHJvdWdoIGRyYWdnaW5nIGRpZmZpY3VsdCwgYW5kIGJlIHZpc3VhbGx5IHVuYXBwZWFsaW5nLgogICAgICBjb3JyZWN0X2Zvcl9kcmFnX21pbl9kaXN0YW5jZSA6IHRydWUsCiAgICAgIC8vIHNldCAwIGZvciB1bmxpbWl0ZWQsIGJ1dCB0aGlzIGNhbiBjb25mbGljdCB3aXRoIHRyYW5zZm9ybQogICAgICBkcmFnX21heF90b3VjaGVzICA6IDEsCiAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCBicm93c2VyIGJlaGF2aW9yIHdoZW4gZHJhZ2dpbmcgb2NjdXJzCiAgICAgIC8vIGJlIGNhcmVmdWwgd2l0aCBpdCwgaXQgbWFrZXMgdGhlIGVsZW1lbnQgYSBibG9ja2luZyBlbGVtZW50CiAgICAgIC8vIHdoZW4geW91IGFyZSB1c2luZyB0aGUgZHJhZyBnZXN0dXJlLCBpdCBpcyBhIGdvb2QgcHJhY3RpY2UgdG8gc2V0IHRoaXMgdHJ1ZQogICAgICBkcmFnX2Jsb2NrX2hvcml6b250YWwgICA6IHRydWUsCiAgICAgIGRyYWdfYmxvY2tfdmVydGljYWwgICAgIDogdHJ1ZSwKICAgICAgLy8gZHJhZ19sb2NrX3RvX2F4aXMga2VlcHMgdGhlIGRyYWcgZ2VzdHVyZSBvbiB0aGUgYXhpcyB0aGF0IGl0IHN0YXJ0ZWQgb24sCiAgICAgIC8vIEl0IGRpc2FsbG93cyB2ZXJ0aWNhbCBkaXJlY3Rpb25zIGlmIHRoZSBpbml0aWFsIGRpcmVjdGlvbiB3YXMgaG9yaXpvbnRhbCwgYW5kIHZpY2UgdmVyc2EuCiAgICAgIGRyYWdfbG9ja190b19heGlzICAgICAgIDogZmFsc2UsCiAgICAgIC8vIGRyYWcgbG9jayBvbmx5IGtpY2tzIGluIHdoZW4gZGlzdGFuY2UgPiBkcmFnX2xvY2tfbWluX2Rpc3RhbmNlCiAgICAgIC8vIFRoaXMgd2F5LCBsb2NraW5nIG9jY3VycyBvbmx5IHdoZW4gdGhlIGRpc3RhbmNlIGhhcyBiZWNvbWUgbGFyZ2UgZW5vdWdoIHRvIHJlbGlhYmx5IGRldGVybWluZSB0aGUgZGlyZWN0aW9uCiAgICAgIGRyYWdfbG9ja19taW5fZGlzdGFuY2UgOiAyNQogICAgfSwKICAgIHRyaWdnZXJlZDogZmFsc2UsCiAgICBoYW5kbGVyOiBmdW5jdGlvbiBkcmFnR2VzdHVyZShldiwgaW5zdCkgewogICAgICAvLyBjdXJyZW50IGdlc3R1cmUgaXNudCBkcmFnLCBidXQgZHJhZ2dlZCBpcyB0cnVlCiAgICAgIC8vIHRoaXMgbWVhbnMgYW4gb3RoZXIgZ2VzdHVyZSBpcyBidXN5LiBub3cgY2FsbCBkcmFnZW5kCiAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lICYmIHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ2VuZCcsIGV2KTsKICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gbWF4IHRvdWNoZXMKICAgICAgaWYoaW5zdC5vcHRpb25zLmRyYWdfbWF4X3RvdWNoZXMgPiAwICYmCiAgICAgICAgICBldi50b3VjaGVzLmxlbmd0aCA+IGluc3Qub3B0aW9ucy5kcmFnX21heF90b3VjaGVzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUOgogICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkU6CiAgICAgICAgICAvLyB3aGVuIHRoZSBkaXN0YW5jZSB3ZSBtb3ZlZCBpcyB0b28gc21hbGwgd2Ugc2tpcCB0aGlzIGdlc3R1cmUKICAgICAgICAgIC8vIG9yIHdlIGNhbiBiZSBhbHJlYWR5IGluIGRyYWdnaW5nCiAgICAgICAgICBpZihldi5kaXN0YW5jZSA8IGluc3Qub3B0aW9ucy5kcmFnX21pbl9kaXN0YW5jZSAmJgogICAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgIC8vIHdlIGFyZSBkcmFnZ2luZyEKICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lKSB7CiAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSB0aGlzLm5hbWU7CiAgICAgICAgICAgIGlmIChpbnN0Lm9wdGlvbnMuY29ycmVjdF9mb3JfZHJhZ19taW5fZGlzdGFuY2UpIHsKICAgICAgICAgICAgICAvLyBXaGVuIGEgZHJhZyBpcyB0cmlnZ2VyZWQsIHNldCB0aGUgZXZlbnQgY2VudGVyIHRvIGRyYWdfbWluX2Rpc3RhbmNlIHBpeGVscyBmcm9tIHRoZSBvcmlnaW5hbCBldmVudCBjZW50ZXIuCiAgICAgICAgICAgICAgLy8gV2l0aG91dCB0aGlzIGNvcnJlY3Rpb24sIHRoZSBkcmFnZ2VkIGRpc3RhbmNlIHdvdWxkIGp1bXBzdGFydCBhdCBkcmFnX21pbl9kaXN0YW5jZSBwaXhlbHMgaW5zdGVhZCBvZiBhdCAwLgogICAgICAgICAgICAgIC8vIEl0IG1pZ2h0IGJlIHVzZWZ1bCB0byBzYXZlIHRoZSBvcmlnaW5hbCBzdGFydCBwb2ludCBzb21ld2hlcmUKICAgICAgICAgICAgICB2YXIgZmFjdG9yID0gTWF0aC5hYnMoaW5zdC5vcHRpb25zLmRyYWdfbWluX2Rpc3RhbmNlL2V2LmRpc3RhbmNlKTsKICAgICAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5zdGFydEV2ZW50LmNlbnRlci5wYWdlWCArPSBldi5kZWx0YVggKiBmYWN0b3I7CiAgICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQuc3RhcnRFdmVudC5jZW50ZXIucGFnZVkgKz0gZXYuZGVsdGFZICogZmFjdG9yOwoKICAgICAgICAgICAgICAvLyByZWNhbGN1bGF0ZSBldmVudCBkYXRhIHVzaW5nIG5ldyBzdGFydCBwb2ludAogICAgICAgICAgICAgIGV2ID0gaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmV4dGVuZEV2ZW50RGF0YShldik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBsb2NrIGRyYWcgdG8gYXhpcz8KICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lmxhc3RFdmVudC5kcmFnX2xvY2tlZF90b19heGlzIHx8IChpbnN0Lm9wdGlvbnMuZHJhZ19sb2NrX3RvX2F4aXMgJiYgaW5zdC5vcHRpb25zLmRyYWdfbG9ja19taW5fZGlzdGFuY2U8PWV2LmRpc3RhbmNlKSkgewogICAgICAgICAgICBldi5kcmFnX2xvY2tlZF90b19heGlzID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0X2RpcmVjdGlvbiA9IGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lmxhc3RFdmVudC5kaXJlY3Rpb247CiAgICAgICAgICBpZihldi5kcmFnX2xvY2tlZF90b19heGlzICYmIGxhc3RfZGlyZWN0aW9uICE9PSBldi5kaXJlY3Rpb24pIHsKICAgICAgICAgICAgLy8ga2VlcCBkaXJlY3Rpb24gb24gdGhlIGF4aXMgdGhhdCB0aGUgZHJhZyBnZXN0dXJlIHN0YXJ0ZWQgb24KICAgICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMudXRpbHMuaXNWZXJ0aWNhbChsYXN0X2RpcmVjdGlvbikpIHsKICAgICAgICAgICAgICBldi5kaXJlY3Rpb24gPSAoZXYuZGVsdGFZIDwgMCkgPyBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fVVAgOiBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fRE9XTjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBldi5kaXJlY3Rpb24gPSAoZXYuZGVsdGFYIDwgMCkgPyBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fTEVGVCA6IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9SSUdIVDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIGZpcnN0IHRpbWUsIHRyaWdnZXIgZHJhZ3N0YXJ0IGV2ZW50CiAgICAgICAgICBpZighdGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ3N0YXJ0JywgZXYpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gdHJpZ2dlciBub3JtYWwgZXZlbnQKICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKCiAgICAgICAgICAvLyBkaXJlY3Rpb24gZXZlbnQsIGxpa2UgZHJhZ2Rvd24KICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKyBldi5kaXJlY3Rpb24sIGV2KTsKCiAgICAgICAgICAvLyBibG9jayB0aGUgYnJvd3NlciBldmVudHMKICAgICAgICAgIGlmKCAoaW5zdC5vcHRpb25zLmRyYWdfYmxvY2tfdmVydGljYWwgJiYgaW9uaWMuR2VzdHVyZXMudXRpbHMuaXNWZXJ0aWNhbChldi5kaXJlY3Rpb24pKSB8fAogICAgICAgICAgICAgIChpbnN0Lm9wdGlvbnMuZHJhZ19ibG9ja19ob3Jpem9udGFsICYmICFpb25pYy5HZXN0dXJlcy51dGlscy5pc1ZlcnRpY2FsKGV2LmRpcmVjdGlvbikpKSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORDoKICAgICAgICAgIC8vIHRyaWdnZXIgZHJhZ2VuZAogICAgICAgICAgaWYodGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ2VuZCcsIGV2KTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9OwoKCiAgLyoqCiAgICogVHJhbnNmb3JtCiAgICogVXNlciB3YW50IHRvIHNjYWxlIG9yIHJvdGF0ZSB3aXRoIDIgZmluZ2VycwogICAqIGV2ZW50cyAgdHJhbnNmb3JtLCBwaW5jaCwgcGluY2hpbiwgcGluY2hvdXQsIHJvdGF0ZQogICAqLwogIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLlRyYW5zZm9ybSA9IHsKICAgIG5hbWU6ICd0cmFuc2Zvcm0nLAogICAgaW5kZXg6IDQ1LAogICAgZGVmYXVsdHM6IHsKICAgICAgLy8gZmFjdG9yLCBubyBzY2FsZSBpcyAxLCB6b29taW4gaXMgdG8gMCBhbmQgem9vbW91dCB1bnRpbCBoaWdoZXIgdGhlbiAxCiAgICAgIHRyYW5zZm9ybV9taW5fc2NhbGUgICAgIDogMC4wMSwKICAgICAgLy8gcm90YXRpb24gaW4gZGVncmVlcwogICAgICB0cmFuc2Zvcm1fbWluX3JvdGF0aW9uICA6IDEsCiAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCBicm93c2VyIGJlaGF2aW9yIHdoZW4gdHdvIHRvdWNoZXMgYXJlIG9uIHRoZSBzY3JlZW4KICAgICAgLy8gYnV0IGl0IG1ha2VzIHRoZSBlbGVtZW50IGEgYmxvY2tpbmcgZWxlbWVudAogICAgICAvLyB3aGVuIHlvdSBhcmUgdXNpbmcgdGhlIHRyYW5zZm9ybSBnZXN0dXJlLCBpdCBpcyBhIGdvb2QgcHJhY3RpY2UgdG8gc2V0IHRoaXMgdHJ1ZQogICAgICB0cmFuc2Zvcm1fYWx3YXlzX2Jsb2NrICA6IGZhbHNlCiAgICB9LAogICAgdHJpZ2dlcmVkOiBmYWxzZSwKICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHRyYW5zZm9ybUdlc3R1cmUoZXYsIGluc3QpIHsKICAgICAgLy8gY3VycmVudCBnZXN0dXJlIGlzbnQgZHJhZywgYnV0IGRyYWdnZWQgaXMgdHJ1ZQogICAgICAvLyB0aGlzIG1lYW5zIGFuIG90aGVyIGdlc3R1cmUgaXMgYnVzeS4gbm93IGNhbGwgZHJhZ2VuZAogICAgICBpZihpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5uYW1lICE9IHRoaXMubmFtZSAmJiB0aGlzLnRyaWdnZXJlZCkgewogICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydlbmQnLCBldik7CiAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIGF0bGVhc3QgbXVsdGl0b3VjaAogICAgICBpZihldi50b3VjaGVzLmxlbmd0aCA8IDIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCB3aGVuIHR3byBmaW5nZXJzIGFyZSBvbiB0aGUgc2NyZWVuCiAgICAgIGlmKGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fYWx3YXlzX2Jsb2NrKSB7CiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgfQoKICAgICAgc3dpdGNoKGV2LmV2ZW50VHlwZSkgewogICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQ6CiAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRToKICAgICAgICAgIHZhciBzY2FsZV90aHJlc2hvbGQgPSBNYXRoLmFicygxLWV2LnNjYWxlKTsKICAgICAgICAgIHZhciByb3RhdGlvbl90aHJlc2hvbGQgPSBNYXRoLmFicyhldi5yb3RhdGlvbik7CgogICAgICAgICAgLy8gd2hlbiB0aGUgZGlzdGFuY2Ugd2UgbW92ZWQgaXMgdG9vIHNtYWxsIHdlIHNraXAgdGhpcyBnZXN0dXJlCiAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgaWYoc2NhbGVfdGhyZXNob2xkIDwgaW5zdC5vcHRpb25zLnRyYW5zZm9ybV9taW5fc2NhbGUgJiYKICAgICAgICAgICAgICByb3RhdGlvbl90aHJlc2hvbGQgPCBpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX21pbl9yb3RhdGlvbikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAvLyB3ZSBhcmUgdHJhbnNmb3JtaW5nIQogICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSA9IHRoaXMubmFtZTsKCiAgICAgICAgICAvLyBmaXJzdCB0aW1lLCB0cmlnZ2VyIGRyYWdzdGFydCBldmVudAogICAgICAgICAgaWYoIXRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydzdGFydCcsIGV2KTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsgLy8gYmFzaWMgdHJhbnNmb3JtIGV2ZW50CgogICAgICAgICAgLy8gdHJpZ2dlciByb3RhdGUgZXZlbnQKICAgICAgICAgIGlmKHJvdGF0aW9uX3RocmVzaG9sZCA+IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3JvdGF0aW9uKSB7CiAgICAgICAgICAgIGluc3QudHJpZ2dlcigncm90YXRlJywgZXYpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHRyaWdnZXIgcGluY2ggZXZlbnQKICAgICAgICAgIGlmKHNjYWxlX3RocmVzaG9sZCA+IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3NjYWxlKSB7CiAgICAgICAgICAgIGluc3QudHJpZ2dlcigncGluY2gnLCBldik7CiAgICAgICAgICAgIGluc3QudHJpZ2dlcigncGluY2gnKyAoKGV2LnNjYWxlIDwgMSkgPyAnaW4nIDogJ291dCcpLCBldik7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQ6CiAgICAgICAgICAvLyB0cmlnZ2VyIGRyYWdlbmQKICAgICAgICAgIGlmKHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydlbmQnLCBldik7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfTsKCgogIC8qKgogICAqIFRvdWNoCiAgICogQ2FsbGVkIGFzIGZpcnN0LCB0ZWxscyB0aGUgdXNlciBoYXMgdG91Y2hlZCB0aGUgc2NyZWVuCiAgICogZXZlbnRzICB0b3VjaAogICAqLwogIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLlRvdWNoID0gewogICAgbmFtZTogJ3RvdWNoJywKICAgIGluZGV4OiAtSW5maW5pdHksCiAgICBkZWZhdWx0czogewogICAgICAvLyBjYWxsIHByZXZlbnREZWZhdWx0IGF0IHRvdWNoc3RhcnQsIGFuZCBtYWtlcyB0aGUgZWxlbWVudCBibG9ja2luZyBieQogICAgICAvLyBkaXNhYmxpbmcgdGhlIHNjcm9sbGluZyBvZiB0aGUgcGFnZSwgYnV0IGl0IGltcHJvdmVzIGdlc3R1cmVzIGxpa2UKICAgICAgLy8gdHJhbnNmb3JtaW5nIGFuZCBkcmFnZ2luZy4KICAgICAgLy8gYmUgY2FyZWZ1bCB3aXRoIHVzaW5nIHRoaXMsIGl0IGNhbiBiZSB2ZXJ5IGFubm95aW5nIGZvciB1c2VycyB0byBiZSBzdHVjawogICAgICAvLyBvbiB0aGUgcGFnZQogICAgICBwcmV2ZW50X2RlZmF1bHQ6IGZhbHNlLAoKICAgICAgLy8gZGlzYWJsZSBtb3VzZSBldmVudHMsIHNvIG9ubHkgdG91Y2ggKG9yIHBlbiEpIGlucHV0IHRyaWdnZXJzIGV2ZW50cwogICAgICBwcmV2ZW50X21vdXNlZXZlbnRzOiBmYWxzZQogICAgfSwKICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHRvdWNoR2VzdHVyZShldiwgaW5zdCkgewogICAgICBpZihpbnN0Lm9wdGlvbnMucHJldmVudF9tb3VzZWV2ZW50cyAmJiBldi5wb2ludGVyVHlwZSA9PSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFKSB7CiAgICAgICAgZXYuc3RvcERldGVjdCgpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYoaW5zdC5vcHRpb25zLnByZXZlbnRfZGVmYXVsdCkgewogICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KCiAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQpIHsKICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lLCBldik7CiAgICAgIH0KICAgIH0KICB9OwoKCiAgLyoqCiAgICogUmVsZWFzZQogICAqIENhbGxlZCBhcyBsYXN0LCB0ZWxscyB0aGUgdXNlciBoYXMgcmVsZWFzZWQgdGhlIHNjcmVlbgogICAqIGV2ZW50cyAgcmVsZWFzZQogICAqLwogIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLlJlbGVhc2UgPSB7CiAgICBuYW1lOiAncmVsZWFzZScsCiAgICBpbmRleDogSW5maW5pdHksCiAgICBoYW5kbGVyOiBmdW5jdGlvbiByZWxlYXNlR2VzdHVyZShldiwgaW5zdCkgewogICAgICBpZihldi5ldmVudFR5cGUgPT0gIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCkgewogICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICAgICAgfQogICAgfQogIH07Cn0pKHdpbmRvdy5pb25pYyk7CgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgaW9uaWMpIHsKCiAgdmFyIElPUyA9ICdpb3MnOwogIHZhciBBTkRST0lEID0gJ2FuZHJvaWQnOwogIHZhciBXSU5ET1dTX1BIT05FID0gJ3dpbmRvd3NwaG9uZSc7CgogIC8qKgogICAqIEBuZ2RvYyB1dGlsaXR5CiAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0KICAgKiBAbW9kdWxlIGlvbmljCiAgICovCiAgaW9uaWMuUGxhdGZvcm0gPSB7CgogICAgLy8gUHV0IG5hdmlnYXRvciBvbiBwbGF0Zm9ybSBzbyBpdCBjYW4gYmUgbW9ja2VkIGFuZCBzZXQKICAgIC8vIHRoZSBicm93c2VyIGRvZXMgbm90IGFsbG93IHdpbmRvdy5uYXZpZ2F0b3IgdG8gYmUgc2V0CiAgICBuYXZpZ2F0b3I6IHdpbmRvdy5uYXZpZ2F0b3IsCgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzUmVhZHkKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBkZXZpY2UgaXMgcmVhZHkuCiAgICAgKi8KICAgIGlzUmVhZHk6IGZhbHNlLAogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzRnVsbFNjcmVlbgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGRldmljZSBpcyBmdWxsc2NyZWVuLgogICAgICovCiAgICBpc0Z1bGxTY3JlZW46IGZhbHNlLAogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3BsYXRmb3JtcwogICAgICogQHJldHVybnMge0FycmF5KHN0cmluZyl9IEFuIGFycmF5IG9mIGFsbCBwbGF0Zm9ybXMgZm91bmQuCiAgICAgKi8KICAgIHBsYXRmb3JtczogbnVsbCwKICAgIC8qKgogICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNncmFkZQogICAgICogQHJldHVybnMge3N0cmluZ30gV2hhdCBncmFkZSB0aGUgY3VycmVudCBwbGF0Zm9ybSBpcy4KICAgICAqLwogICAgZ3JhZGU6IG51bGwsCiAgICB1YTogbmF2aWdhdG9yLnVzZXJBZ2VudCwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3JlYWR5CiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRyaWdnZXIgYSBjYWxsYmFjayBvbmNlIHRoZSBkZXZpY2UgaXMgcmVhZHksIG9yIGltbWVkaWF0ZWx5CiAgICAgKiBpZiB0aGUgZGV2aWNlIGlzIGFscmVhZHkgcmVhZHkuIFRoaXMgbWV0aG9kIGNhbiBiZSBydW4gZnJvbQogICAgICogYW55d2hlcmUgYW5kIGRvZXMgbm90IG5lZWQgdG8gYmUgd3JhcHBlZCBieSBhbnkgYWRkaXRvbmFsIG1ldGhvZHMuCiAgICAgKiBXaGVuIHRoZSBhcHAgaXMgd2l0aGluIGEgV2ViVmlldyAoQ29yZG92YSksIGl0J2xsIGZpcmUKICAgICAqIHRoZSBjYWxsYmFjayBvbmNlIHRoZSBkZXZpY2UgaXMgcmVhZHkuIElmIHRoZSBhcHAgaXMgd2l0aGluCiAgICAgKiBhIHdlYiBicm93c2VyLCBpdCdsbCBmaXJlIHRoZSBjYWxsYmFjayBhZnRlciBgd2luZG93LmxvYWRgLgogICAgICogUGxlYXNlIHJlbWVtYmVyIHRoYXQgQ29yZG92YSBmZWF0dXJlcyAoQ2FtZXJhLCBGaWxlU3lzdGVtLCBldGMpIHN0aWxsCiAgICAgKiB3aWxsIG5vdCB3b3JrIGluIGEgd2ViIGJyb3dzZXIuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gY2FsbC4KICAgICAqLwogICAgcmVhZHk6IGZ1bmN0aW9uKGNiKSB7CiAgICAgIC8vIHJ1biB0aHJvdWdoIHRhc2tzIHRvIGNvbXBsZXRlIG5vdyB0aGF0IHRoZSBkZXZpY2UgaXMgcmVhZHkKICAgICAgaWYodGhpcy5pc1JlYWR5KSB7CiAgICAgICAgY2IoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0aGUgcGxhdGZvcm0gaXNuJ3QgcmVhZHkgeWV0LCBhZGQgaXQgdG8gdGhpcyBhcnJheQogICAgICAgIC8vIHdoaWNoIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIHBsYXRmb3JtIGlzIHJlYWR5CiAgICAgICAgcmVhZHlDYWxsYmFja3MucHVzaChjYik7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBkZXRlY3Q6IGZ1bmN0aW9uKCkgewogICAgICBpb25pYy5QbGF0Zm9ybS5fY2hlY2tQbGF0Zm9ybXMoKTsKCiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICAgIC8vIG9ubHkgYWRkIHRvIHRoZSBib2R5IGNsYXNzIGlmIHdlIGdvdCBwbGF0Zm9ybSBpbmZvCiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGlvbmljLlBsYXRmb3JtLnBsYXRmb3Jtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdwbGF0Zm9ybS0nICsgaW9uaWMuUGxhdGZvcm0ucGxhdGZvcm1zW2ldKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3NldEdyYWRlCiAgICAgKiBAZGVzY3JpcHRpb24gU2V0IHRoZSBncmFkZSBvZiB0aGUgZGV2aWNlOiAnYScsICdiJywgb3IgJ2MnLiAnYScgaXMgdGhlIGJlc3QKICAgICAqIChtb3N0IGNzcyBmZWF0dXJlcyBlbmFibGVkKSwgJ2MnIGlzIHRoZSB3b3JzdC4gIEJ5IGRlZmF1bHQsIHNldHMgdGhlIGdyYWRlCiAgICAgKiBkZXBlbmRpbmcgb24gdGhlIGN1cnJlbnQgZGV2aWNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IGdyYWRlIFRoZSBuZXcgZ3JhZGUgdG8gc2V0LgogICAgICovCiAgICBzZXRHcmFkZTogZnVuY3Rpb24oZ3JhZGUpIHsKICAgICAgdmFyIG9sZEdyYWRlID0gdGhpcy5ncmFkZTsKICAgICAgdGhpcy5ncmFkZSA9IGdyYWRlOwogICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKG9sZEdyYWRlKSB7CiAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2dyYWRlLScgKyBvbGRHcmFkZSk7CiAgICAgICAgfQogICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnZ3JhZGUtJyArIGdyYWRlKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jZGV2aWNlCiAgICAgKiBAZGVzY3JpcHRpb24gUmV0dXJuIHRoZSBjdXJyZW50IGRldmljZSAoZ2l2ZW4gYnkgY29yZG92YSkuCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBUaGUgZGV2aWNlIG9iamVjdC4KICAgICAqLwogICAgZGV2aWNlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHdpbmRvdy5kZXZpY2UgfHwge307CiAgICB9LAoKICAgIF9jaGVja1BsYXRmb3JtczogZnVuY3Rpb24ocGxhdGZvcm1zKSB7CiAgICAgIHRoaXMucGxhdGZvcm1zID0gW107CiAgICAgIHZhciBncmFkZSA9ICdhJzsKCiAgICAgIGlmKHRoaXMuaXNXZWJWaWV3KCkpIHsKICAgICAgICB0aGlzLnBsYXRmb3Jtcy5wdXNoKCd3ZWJ2aWV3Jyk7CiAgICAgICAgdGhpcy5wbGF0Zm9ybXMucHVzaCgnY29yZG92YScpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2goJ2Jyb3dzZXInKTsKICAgICAgfQogICAgICBpZih0aGlzLmlzSVBhZCgpKSB0aGlzLnBsYXRmb3Jtcy5wdXNoKCdpcGFkJyk7CgogICAgICB2YXIgcGxhdGZvcm0gPSB0aGlzLnBsYXRmb3JtKCk7CiAgICAgIGlmKHBsYXRmb3JtKSB7CiAgICAgICAgdGhpcy5wbGF0Zm9ybXMucHVzaChwbGF0Zm9ybSk7CgogICAgICAgIHZhciB2ZXJzaW9uID0gdGhpcy52ZXJzaW9uKCk7CiAgICAgICAgaWYodmVyc2lvbikgewogICAgICAgICAgdmFyIHYgPSB2ZXJzaW9uLnRvU3RyaW5nKCk7CiAgICAgICAgICBpZih2LmluZGV4T2YoJy4nKSA+IDApIHsKICAgICAgICAgICAgdiA9IHYucmVwbGFjZSgnLicsICdfJyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2ICs9ICdfMCc7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnBsYXRmb3Jtcy5wdXNoKHBsYXRmb3JtICsgdi5zcGxpdCgnXycpWzBdKTsKICAgICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2gocGxhdGZvcm0gKyB2KTsKCiAgICAgICAgICBpZih0aGlzLmlzQW5kcm9pZCgpICYmIHZlcnNpb24gPCA0LjQpIHsKICAgICAgICAgICAgZ3JhZGUgPSAodmVyc2lvbiA8IDQgPyAnYycgOiAnYicpOwogICAgICAgICAgfSBlbHNlIGlmKHRoaXMuaXNXaW5kb3dzUGhvbmUoKSkgewogICAgICAgICAgICBncmFkZSA9ICdiJzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0R3JhZGUoZ3JhZGUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzV2ViVmlldwogICAgICogQHJldHVybnMge2Jvb2xlYW59IENoZWNrIGlmIHdlIGFyZSBydW5uaW5nIHdpdGhpbiBhIFdlYlZpZXcgKHN1Y2ggYXMgQ29yZG92YSkuCiAgICAgKi8KICAgIGlzV2ViVmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAhKCF3aW5kb3cuY29yZG92YSAmJiAhd2luZG93LlBob25lR2FwICYmICF3aW5kb3cucGhvbmVnYXApOwogICAgfSwKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNJUGFkCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB3ZSBhcmUgcnVubmluZyBvbiBpUGFkLgogICAgICovCiAgICBpc0lQYWQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiggL2lQYWQvaS50ZXN0KGlvbmljLlBsYXRmb3JtLm5hdmlnYXRvci5wbGF0Zm9ybSkgKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIC9pUGFkL2kudGVzdCh0aGlzLnVhKTsKICAgIH0sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzSU9TCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB3ZSBhcmUgcnVubmluZyBvbiBpT1MuCiAgICAgKi8KICAgIGlzSU9TOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaXMoSU9TKTsKICAgIH0sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzQW5kcm9pZAogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgd2UgYXJlIHJ1bm5pbmcgb24gQW5kcm9pZC4KICAgICAqLwogICAgaXNBbmRyb2lkOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaXMoQU5EUk9JRCk7CiAgICB9LAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNpc1dpbmRvd3NQaG9uZQogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgd2UgYXJlIHJ1bm5pbmcgb24gV2luZG93cyBQaG9uZS4KICAgICAqLwogICAgaXNXaW5kb3dzUGhvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pcyhXSU5ET1dTX1BIT05FKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNwbGF0Zm9ybQogICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIG5hbWUgb2YgdGhlIGN1cnJlbnQgcGxhdGZvcm0uCiAgICAgKi8KICAgIHBsYXRmb3JtOiBmdW5jdGlvbigpIHsKICAgICAgLy8gc2luZ2xldG9uIHRvIGdldCB0aGUgcGxhdGZvcm0gbmFtZQogICAgICBpZihwbGF0Zm9ybU5hbWUgPT09IG51bGwpIHRoaXMuc2V0UGxhdGZvcm0odGhpcy5kZXZpY2UoKS5wbGF0Zm9ybSk7CiAgICAgIHJldHVybiBwbGF0Zm9ybU5hbWU7CiAgICB9LAoKICAgIC8qKgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgc2V0UGxhdGZvcm06IGZ1bmN0aW9uKG4pIHsKICAgICAgaWYodHlwZW9mIG4gIT0gJ3VuZGVmaW5lZCcgJiYgbiAhPT0gbnVsbCAmJiBuLmxlbmd0aCkgewogICAgICAgIHBsYXRmb3JtTmFtZSA9IG4udG9Mb3dlckNhc2UoKTsKICAgICAgfSBlbHNlIGlmKHRoaXMudWEuaW5kZXhPZignQW5kcm9pZCcpID4gMCkgewogICAgICAgIHBsYXRmb3JtTmFtZSA9IEFORFJPSUQ7CiAgICAgIH0gZWxzZSBpZih0aGlzLnVhLmluZGV4T2YoJ2lQaG9uZScpID4gLTEgfHwgdGhpcy51YS5pbmRleE9mKCdpUGFkJykgPiAtMSB8fCB0aGlzLnVhLmluZGV4T2YoJ2lQb2QnKSA+IC0xKSB7CiAgICAgICAgcGxhdGZvcm1OYW1lID0gSU9TOwogICAgICB9IGVsc2UgaWYodGhpcy51YS5pbmRleE9mKCdXaW5kb3dzIFBob25lJykgPiAtMSkgewogICAgICAgIHBsYXRmb3JtTmFtZSA9IFdJTkRPV1NfUEhPTkU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGxhdGZvcm1OYW1lID0gaW9uaWMuUGxhdGZvcm0ubmF2aWdhdG9yLnBsYXRmb3JtICYmIG5hdmlnYXRvci5wbGF0Zm9ybS50b0xvd2VyQ2FzZSgpLnNwbGl0KCcgJylbMF0gfHwgJyc7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSN2ZXJzaW9uCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgdmVyc2lvbiBvZiB0aGUgY3VycmVudCBkZXZpY2UgcGxhdGZvcm0uCiAgICAgKi8KICAgIHZlcnNpb246IGZ1bmN0aW9uKCkgewogICAgICAvLyBzaW5nbGV0b24gdG8gZ2V0IHRoZSBwbGF0Zm9ybSB2ZXJzaW9uCiAgICAgIGlmKHBsYXRmb3JtVmVyc2lvbiA9PT0gbnVsbCkgdGhpcy5zZXRWZXJzaW9uKHRoaXMuZGV2aWNlKCkudmVyc2lvbik7CiAgICAgIHJldHVybiBwbGF0Zm9ybVZlcnNpb247CiAgICB9LAoKICAgIC8qKgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgc2V0VmVyc2lvbjogZnVuY3Rpb24odikgewogICAgICBpZih0eXBlb2YgdiAhPSAndW5kZWZpbmVkJyAmJiB2ICE9PSBudWxsKSB7CiAgICAgICAgdiA9IHYuc3BsaXQoJy4nKTsKICAgICAgICB2ID0gcGFyc2VGbG9hdCh2WzBdICsgJy4nICsgKHYubGVuZ3RoID4gMSA/IHZbMV0gOiAwKSk7CiAgICAgICAgaWYoIWlzTmFOKHYpKSB7CiAgICAgICAgICBwbGF0Zm9ybVZlcnNpb24gPSB2OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcGxhdGZvcm1WZXJzaW9uID0gMDsKCiAgICAgIC8vIGZhbGxiYWNrIHRvIHVzZXItYWdlbnQgY2hlY2tpbmcKICAgICAgdmFyIHBOYW1lID0gdGhpcy5wbGF0Zm9ybSgpOwogICAgICB2YXIgdmVyc2lvbk1hdGNoID0gewogICAgICAgICdhbmRyb2lkJzogL0FuZHJvaWQgKFxkKykuKFxkKyk/LywKICAgICAgICAnaW9zJzogL09TIChcZCspXyhcZCspPy8sCiAgICAgICAgJ3dpbmRvd3NwaG9uZSc6IC9XaW5kb3dzIFBob25lIChcZCspLihcZCspPy8KICAgICAgfTsKICAgICAgaWYodmVyc2lvbk1hdGNoW3BOYW1lXSkgewogICAgICAgIHYgPSB0aGlzLnVhLm1hdGNoKCB2ZXJzaW9uTWF0Y2hbcE5hbWVdICk7CiAgICAgICAgaWYodiAmJiAgdi5sZW5ndGggPiAyKSB7CiAgICAgICAgICBwbGF0Zm9ybVZlcnNpb24gPSBwYXJzZUZsb2F0KCB2WzFdICsgJy4nICsgdlsyXSApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgcGxhdGZvcm0gaXMgdGhlIG9uZSBkZXRlY3RlZCBieSBjb3Jkb3ZhCiAgICBpczogZnVuY3Rpb24odHlwZSkgewogICAgICB0eXBlID0gdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAvLyBjaGVjayBpZiBpdCBoYXMgYW4gYXJyYXkgb2YgcGxhdGZvcm1zCiAgICAgIGlmKHRoaXMucGxhdGZvcm1zKSB7CiAgICAgICAgZm9yKHZhciB4ID0gMDsgeCA8IHRoaXMucGxhdGZvcm1zLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgICBpZih0aGlzLnBsYXRmb3Jtc1t4XSA9PT0gdHlwZSkgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGV4YWN0IG1hdGNoCiAgICAgIHZhciBwTmFtZSA9IHRoaXMucGxhdGZvcm0oKTsKICAgICAgaWYocE5hbWUpIHsKICAgICAgICByZXR1cm4gcE5hbWUgPT09IHR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgfQoKICAgICAgLy8gQSBxdWljayBoYWNrIGZvciB0byBjaGVjayB1c2VyQWdlbnQKICAgICAgcmV0dXJuIHRoaXMudWEudG9Mb3dlckNhc2UoKS5pbmRleE9mKHR5cGUpID49IDA7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jZXhpdEFwcAogICAgICogQGRlc2NyaXB0aW9uIEV4aXQgdGhlIGFwcC4KICAgICAqLwogICAgZXhpdEFwcDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVhZHkoZnVuY3Rpb24oKXsKICAgICAgICBuYXZpZ2F0b3IuYXBwICYmIG5hdmlnYXRvci5hcHAuZXhpdEFwcCAmJiBuYXZpZ2F0b3IuYXBwLmV4aXRBcHAoKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jc2hvd1N0YXR1c0JhcgogICAgICogQGRlc2NyaXB0aW9uIFNob3dzIG9yIGhpZGVzIHRoZSBkZXZpY2Ugc3RhdHVzIGJhciAoaW4gQ29yZG92YSkuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNob3VsZFNob3cgV2hldGhlciBvciBub3QgdG8gc2hvdyB0aGUgc3RhdHVzIGJhci4KICAgICAqLwogICAgc2hvd1N0YXR1c0JhcjogZnVuY3Rpb24odmFsKSB7CiAgICAgIC8vIE9ubHkgdXNlZnVsIHdoZW4gcnVuIHdpdGhpbiBjb3Jkb3ZhCiAgICAgIHRoaXMuX3Nob3dTdGF0dXNCYXIgPSB2YWw7CiAgICAgIHRoaXMucmVhZHkoZnVuY3Rpb24oKXsKICAgICAgICAvLyBydW4gdGhpcyBvbmx5IHdoZW4gb3IgaWYgdGhlIHBsYXRmb3JtIChjb3Jkb3ZhKSBpcyByZWFkeQogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICAgICAgaWYoaW9uaWMuUGxhdGZvcm0uX3Nob3dTdGF0dXNCYXIpIHsKICAgICAgICAgICAgLy8gdGhleSBkbyBub3Qgd2FudCBpdCB0byBiZSBmdWxsIHNjcmVlbgogICAgICAgICAgICB3aW5kb3cuU3RhdHVzQmFyICYmIHdpbmRvdy5TdGF0dXNCYXIuc2hvdygpOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ3N0YXR1cy1iYXItaGlkZScpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gaXQgc2hvdWxkIGJlIGZ1bGwgc2NyZWVuCiAgICAgICAgICAgIHdpbmRvdy5TdGF0dXNCYXIgJiYgd2luZG93LlN0YXR1c0Jhci5oaWRlKCk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnc3RhdHVzLWJhci1oaWRlJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2Z1bGxTY3JlZW4KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0cyB3aGV0aGVyIHRoZSBhcHAgaXMgZnVsbHNjcmVlbiBvciBub3QgKGluIENvcmRvdmEpLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvd0Z1bGxTY3JlZW4gV2hldGhlciBvciBub3QgdG8gc2V0IHRoZSBhcHAgdG8gZnVsbHNjcmVlbi4gRGVmYXVsdHMgdG8gdHJ1ZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3dTdGF0dXNCYXIgV2hldGhlciBvciBub3QgdG8gc2hvdyB0aGUgZGV2aWNlJ3Mgc3RhdHVzIGJhci4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICAgKi8KICAgIGZ1bGxTY3JlZW46IGZ1bmN0aW9uKHNob3dGdWxsU2NyZWVuLCBzaG93U3RhdHVzQmFyKSB7CiAgICAgIC8vIHNob3dGdWxsU2NyZWVuOiBkZWZhdWx0IGlzIHRydWUgaWYgbm8gcGFyYW0gcHJvdmlkZWQKICAgICAgdGhpcy5pc0Z1bGxTY3JlZW4gPSAoc2hvd0Z1bGxTY3JlZW4gIT09IGZhbHNlKTsKCiAgICAgIC8vIGFkZC9yZW1vdmUgdGhlIGZ1bGxzY3JlZW4gY2xhc3NuYW1lIHRvIHRoZSBib2R5CiAgICAgIGlvbmljLkRvbVV0aWwucmVhZHkoZnVuY3Rpb24oKXsKICAgICAgICAvLyBydW4gdGhpcyBvbmx5IHdoZW4gb3IgaWYgdGhlIERPTSBpcyByZWFkeQogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICAgICAgLy8gZml4aW5nIHBhbmUgaGVpZ2h0IGJlZm9yZSB3ZSBhZGp1c3QgdGhpcwogICAgICAgICAgcGFuZXMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdwYW5lJyk7CiAgICAgICAgICBmb3IodmFyIGkgPSAwO2k8cGFuZXMubGVuZ3RoO2krKyl7CiAgICAgICAgICAgIHBhbmVzW2ldLnN0eWxlLmhlaWdodCA9IHBhbmVzW2ldLm9mZnNldEhlaWdodCsicHgiOwogICAgICAgICAgfQogICAgICAgICAgaWYoaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnZnVsbHNjcmVlbicpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdmdWxsc2NyZWVuJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgLy8gc2hvd1N0YXR1c0JhcjogZGVmYXVsdCBpcyBmYWxzZSBpZiBubyBwYXJhbSBwcm92aWRlZAogICAgICAgIGlvbmljLlBsYXRmb3JtLnNob3dTdGF0dXNCYXIoIChzaG93U3RhdHVzQmFyID09PSB0cnVlKSApOwogICAgICB9KTsKICAgIH0KCiAgfTsKCiAgdmFyIHBsYXRmb3JtTmFtZSA9IG51bGwsIC8vIGp1c3QgdGhlIG5hbWUsIGxpa2UgaU9TIG9yIEFuZHJvaWQKICBwbGF0Zm9ybVZlcnNpb24gPSBudWxsLCAvLyBhIGZsb2F0IG9mIHRoZSBtYWpvciBhbmQgbWlub3IsIGxpa2UgNy4xCiAgcmVhZHlDYWxsYmFja3MgPSBbXTsKCiAgLy8gc2V0dXAgbGlzdGVuZXJzIHRvIGtub3cgd2hlbiB0aGUgZGV2aWNlIGlzIHJlYWR5IHRvIGdvCiAgZnVuY3Rpb24gb25XaW5kb3dMb2FkKCkgewogICAgaWYoaW9uaWMuUGxhdGZvcm0uaXNXZWJWaWV3KCkpIHsKICAgICAgLy8gdGhlIHdpbmRvdyBhbmQgc2NyaXB0cyBhcmUgZnVsbHkgbG9hZGVkLCBhbmQgYSBjb3Jkb3ZhL3Bob25lZ2FwCiAgICAgIC8vIG9iamVjdCBleGlzdHMgdGhlbiBsZXQncyBsaXN0ZW4gZm9yIHRoZSBkZXZpY2VyZWFkeQogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJkZXZpY2VyZWFkeSIsIG9uUGxhdGZvcm1SZWFkeSwgZmFsc2UpOwogICAgfSBlbHNlIHsKICAgICAgLy8gdGhlIHdpbmRvdyBhbmQgc2NyaXB0cyBhcmUgZnVsbHkgbG9hZGVkLCBidXQgdGhlIHdpbmRvdyBvYmplY3QgZG9lc24ndCBoYXZlIHRoZQogICAgICAvLyBjb3Jkb3ZhL3Bob25lZ2FwIG9iamVjdCwgc28gaXRzIGp1c3QgYSBicm93c2VyLCBub3QgYSB3ZWJ2aWV3IHdyYXBwZWQgdy8gY29yZG92YQogICAgICBvblBsYXRmb3JtUmVhZHkoKTsKICAgIH0KICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJsb2FkIiwgb25XaW5kb3dMb2FkLCBmYWxzZSk7CiAgfQogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgb25XaW5kb3dMb2FkLCBmYWxzZSk7CgogIGZ1bmN0aW9uIG9uUGxhdGZvcm1SZWFkeSgpIHsKICAgIC8vIHRoZSBkZXZpY2UgaXMgYWxsIHNldCB0byBnbywgaW5pdCBvdXIgb3duIHN0dWZmIHRoZW4gZmlyZSBvZmYgb3VyIGV2ZW50CiAgICBpb25pYy5QbGF0Zm9ybS5pc1JlYWR5ID0gdHJ1ZTsKICAgIGlvbmljLlBsYXRmb3JtLmRldGVjdCgpOwogICAgZm9yKHZhciB4PTA7IHg8cmVhZHlDYWxsYmFja3MubGVuZ3RoOyB4KyspIHsKICAgICAgLy8gZmlyZSBvZmYgYWxsIHRoZSBjYWxsYmFja3MgdGhhdCB3ZXJlIGFkZGVkIGJlZm9yZSB0aGUgcGxhdGZvcm0gd2FzIHJlYWR5CiAgICAgIHJlYWR5Q2FsbGJhY2tzW3hdKCk7CiAgICB9CiAgICByZWFkeUNhbGxiYWNrcyA9IFtdOwogICAgaW9uaWMudHJpZ2dlcigncGxhdGZvcm1yZWFkeScsIHsgdGFyZ2V0OiBkb2N1bWVudCB9KTsKCiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdwbGF0Zm9ybS1yZWFkeScpOwogICAgfSk7CiAgfQoKfSkodGhpcywgZG9jdW1lbnQsIGlvbmljKTsKCihmdW5jdGlvbihkb2N1bWVudCwgaW9uaWMpIHsKICAndXNlIHN0cmljdCc7CgogIC8vIElvbmljIENTUyBwb2x5ZmlsbHMKICBpb25pYy5DU1MgPSB7fTsKCiAgKGZ1bmN0aW9uKCkgewoKICAgIC8vIHRyYW5zZm9ybQogICAgdmFyIGksIGtleXMgPSBbJ3dlYmtpdFRyYW5zZm9ybScsICd0cmFuc2Zvcm0nLCAnLXdlYmtpdC10cmFuc2Zvcm0nLCAnd2Via2l0LXRyYW5zZm9ybScsCiAgICAgICAgICAgICAgICAgICAnLW1vei10cmFuc2Zvcm0nLCAnbW96LXRyYW5zZm9ybScsICdNb3pUcmFuc2Zvcm0nLCAnbW96VHJhbnNmb3JtJywgJ21zVHJhbnNmb3JtJ107CgogICAgZm9yKGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBpZihkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGVba2V5c1tpXV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlvbmljLkNTUy5UUkFOU0ZPUk0gPSBrZXlzW2ldOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgLy8gdHJhbnNpdGlvbgogICAga2V5cyA9IFsnd2Via2l0VHJhbnNpdGlvbicsICdtb3pUcmFuc2l0aW9uJywgJ21zVHJhbnNpdGlvbicsICd0cmFuc2l0aW9uJ107CiAgICBmb3IoaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZVtrZXlzW2ldXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaW9uaWMuQ1NTLlRSQU5TSVRJT04gPSBrZXlzW2ldOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogIH0pKCk7CgogIC8vIGNsYXNzTGlzdCBwb2x5ZmlsbCBmb3IgdGhlbSBvbGRlciBBbmRyb2lkcwogIC8vIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2Rldm9uZ292ZXR0LzEzODE4MzkKICBpZiAoISgiY2xhc3NMaXN0IiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAmJiB0eXBlb2YgSFRNTEVsZW1lbnQgIT09ICd1bmRlZmluZWQnKSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSFRNTEVsZW1lbnQucHJvdG90eXBlLCAnY2xhc3NMaXN0JywgewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICBmdW5jdGlvbiB1cGRhdGUoZm4pIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHgsIGNsYXNzZXMgPSBzZWxmLmNsYXNzTmFtZS5zcGxpdCgvXHMrLyk7CgogICAgICAgICAgICBmb3IoeD0wOyB4PGFyZ3VtZW50cy5sZW5ndGg7IHgrKykgewogICAgICAgICAgICAgIGZuKGNsYXNzZXMsIGNsYXNzZXMuaW5kZXhPZihhcmd1bWVudHNbeF0pLCBhcmd1bWVudHNbeF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZWxmLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbigiICIpOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBhZGQ6IHVwZGF0ZShmdW5jdGlvbihjbGFzc2VzLCBpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgfmluZGV4IHx8IGNsYXNzZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9KSwKCiAgICAgICAgICByZW1vdmU6IHVwZGF0ZShmdW5jdGlvbihjbGFzc2VzLCBpbmRleCkgewogICAgICAgICAgICB+aW5kZXggJiYgY2xhc3Nlcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfSksCgogICAgICAgICAgdG9nZ2xlOiB1cGRhdGUoZnVuY3Rpb24oY2xhc3NlcywgaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgIH5pbmRleCA/IGNsYXNzZXMuc3BsaWNlKGluZGV4LCAxKSA6IGNsYXNzZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9KSwKCiAgICAgICAgICBjb250YWluczogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuICEhfnNlbGYuY2xhc3NOYW1lLnNwbGl0KC9ccysvKS5pbmRleE9mKHZhbHVlKTsKICAgICAgICAgIH0sCgogICAgICAgICAgaXRlbTogZnVuY3Rpb24oaSkgewogICAgICAgICAgICByZXR1cm4gc2VsZi5jbGFzc05hbWUuc3BsaXQoL1xzKy8pW2ldIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgIH0KICAgIH0pOwogIH0KCn0pKGRvY3VtZW50LCBpb25pYyk7CgoKLyoqCiAqIEBuZ2RvYyBwYWdlCiAqIEBuYW1lIHRhcAogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKiBPbiB0b3VjaCBkZXZpY2VzIHN1Y2ggYXMgYSBwaG9uZSBvciB0YWJsZXQsIHNvbWUgYnJvd3NlcnMgaW1wbGVtZW50IGEgMzAwbXMgZGVsYXkgYmV0d2VlbgogKiB0aGUgdGltZSB0aGUgdXNlciBzdG9wcyB0b3VjaGluZyB0aGUgZGlzcGxheSBhbmQgdGhlIG1vbWVudCB0aGUgYnJvd3NlciBleGVjdXRlcyB0aGUKICogY2xpY2suIFRoaXMgZGVsYXkgd2FzIGluaXRpYWxseSBpbnRyb2R1Y2VkIHNvIHRoZSBicm93c2VyIGNhbiBrbm93IHdoZXRoZXIgdGhlIHVzZXIgd2FudHMgdG8KICogZG91YmxlLXRhcCB0byB6b29tIGluIG9uIHRoZSB3ZWJwYWdlLiAgQmFzaWNhbGx5LCB0aGUgYnJvd3NlciB3YWl0cyByb3VnaGx5IDMwMG1zIHRvIHNlZSBpZgogKiB0aGUgdXNlciBpcyBkb3VibGUtdGFwcGluZywgb3IganVzdCB0YXBwaW5nIG9uIHRoZSBkaXNwbGF5IG9uY2UuCiAqCiAqIE91dCBvZiB0aGUgYm94LCBJb25pYyBhdXRvbWF0aWNhbGx5IHJlbW92ZXMgdGhlIDMwMG1zIGRlbGF5IGluIG9yZGVyIHRvIG1ha2UgSW9uaWMgYXBwcwogKiBmZWVsIG1vcmUgIm5hdGl2ZSIgbGlrZS4gUmVzdWx0aW5nbHksIG90aGVyIHNvbHV0aW9ucyBzdWNoIGFzCiAqIFtmYXN0Y2xpY2tdKGh0dHBzOi8vZ2l0aHViLmNvbS9mdGxhYnMvZmFzdGNsaWNrKSBhbmQgQW5ndWxhcidzCiAqIFtuZ1RvdWNoXShodHRwczovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmdUb3VjaCkgc2hvdWxkIG5vdCBiZSBpbmNsdWRlZCwgdG8gYXZvaWQgY29uZmxpY3RzLgogKgogKiBTb21lIGJyb3dzZXJzIGFscmVhZHkgcmVtb3ZlIHRoZSBkZWxheSB3aXRoIGNlcnRhaW4gc2V0dGluZ3MsIHN1Y2ggYXMgdGhlIENTUyBwcm9wZXJ0eQogKiBgdG91Y2gtZXZlbnRzOiBub25lYCBvciB3aXRoIHNwZWNpZmljIG1ldGEgdGFnIHZpZXdwb3J0IHZhbHVlcy4gSG93ZXZlciwgZWFjaCBvZiB0aGVzZQogKiBicm93c2VycyBzdGlsbCBoYW5kbGUgY2xpY2tzIGRpZmZlcmVudGx5LCBzdWNoIGFzIHdoZW4gdG8gZmlyZSBvZmYgb3IgY2FuY2VsIHRoZSBldmVudAogKiAobGlrZSBzY3JvbGxpbmcgd2hlbiB0aGUgdGFyZ2V0IGlzIGEgYnV0dG9uLCBvciBob2xkaW5nIGEgYnV0dG9uIGRvd24pLgogKiBGb3IgYnJvd3NlcnMgdGhhdCBhbHJlYWR5IHJlbW92ZSB0aGUgMzAwbXMgZGVsYXksIGNvbnNpZGVyIElvbmljJ3MgdGFwIHN5c3RlbSBhcyBhIHdheSB0bwogKiBub3JtYWxpemUgaG93IGNsaWNrcyBhcmUgaGFuZGxlZCBhY3Jvc3MgdGhlIHZhcmlvdXMgZGV2aWNlcyBzbyB0aGVyZSdzIGFuIGV4cGVjdGVkIHJlc3BvbnNlCiAqIG5vIG1hdHRlciB3aGF0IHRoZSBkZXZpY2UsIHBsYXRmb3JtIG9yIHZlcnNpb24uIEFkZGl0aW9uYWxseSwgSW9uaWMgd2lsbCBwcmV2ZW50CiAqIGdob3N0Y2xpY2tzIHdoaWNoIGV2ZW4gYnJvd3NlcnMgdGhhdCByZW1vdmUgdGhlIGRlbGF5IHN0aWxsIGV4cGVyaWVuY2UuCiAqCiAqIEluIHNvbWUgY2FzZXMsIHRoaXJkLXBhcnR5IGxpYnJhcmllcyBtYXkgYWxzbyBiZSB3b3JraW5nIHdpdGggdG91Y2ggZXZlbnRzIHdoaWNoIGNhbiBpbnRlcmZlcmUKICogd2l0aCB0aGUgdGFwIHN5c3RlbS4gRm9yIGV4YW1wbGUsIG1hcHBpbmcgbGlicmFyaWVzIGxpa2UgR29vZ2xlIG9yIExlYWZsZXQgTWFwcyBvZnRlbiBpbXBsZW1lbnQKICogYSB0b3VjaCBkZXRlY3Rpb24gc3lzdGVtIHdoaWNoIGNvbmZsaWN0cyB3aXRoIElvbmljJ3MgdGFwIHN5c3RlbS4KICoKICogIyMjIERpc2FibGluZyB0aGUgdGFwIHN5c3RlbQogKgogKiBUbyBkaXNhYmxlIHRoZSB0YXAgZm9yIGFuIGVsZW1lbnQgYW5kIGFsbCBvZiBpdHMgY2hpbGRyZW4gZWxlbWVudHMsCiAqIGFkZCB0aGUgYXR0cmlidXRlIGBkYXRhLXRhcC1kaXNhYmxlZD0idHJ1ZSJgLgogKgogKiBgYGBodG1sCiAqIDxkaXYgZGF0YS10YXAtZGlzYWJsZWQ9InRydWUiPgogKiAgICAgPGRpdiBpZD0iZ29vZ2xlLW1hcCI+PC9kaXY+CiAqIDwvZGl2PgogKiBgYGAKICoKICogIyMjIEFkZGl0aW9uYWwgTm90ZXM6CiAqCiAqIC0gSW9uaWMgdGFwICB3b3JrcyB3aXRoIElvbmljJ3MgSmF2YVNjcmlwdCBzY3JvbGxpbmcKICogLSBFbGVtZW50cyBjYW4gY29tZSBhbmQgZ28gZnJvbSB0aGUgRE9NIGFuZCBJb25pYyB0YXAgZG9lc24ndCBrZWVwIGFkZGluZyBhbmQgcmVtb3ZpbmcKICogICBsaXN0ZW5lcnMKICogLSBObyAidGFwIGRlbGF5IiBhZnRlciB0aGUgZmlyc3QgInRhcCIgKHlvdSBjYW4gdGFwIGFzIGZhc3QgYXMgeW91IHdhbnQsIHRoZXkgYWxsIGNsaWNrKQogKiAtIE1pbmltYWwgZXZlbnRzIGxpc3RlbmVycywgb25seSBiZWluZyBhZGRlZCB0byBkb2N1bWVudAogKiAtIENvcnJlY3QgZm9jdXMgaW4vb3V0IG9uIGVhY2ggaW5wdXQgdHlwZSAoc2VsZWN0LCB0ZXh0ZWFyZWEsIHJhbmdlKSBvbiBlYWNoIHBsYXRmb3JtL2RldmljZQogKiAtIFNob3dzIGFuZCBoaWRlcyB2aXJ0dWFsIGtleWJvYXJkIGNvcnJlY3RseSBmb3IgZWFjaCBwbGF0Zm9ybS9kZXZpY2UKICogLSBXb3JrcyB3aXRoIGxhYmVscyBzdXJyb3VuZGluZyBpbnB1dHMKICogLSBEb2VzIG5vdCBmaXJlIG9mZiBhIGNsaWNrIGlmIHRoZSB1c2VyIG1vdmVzIHRoZSBwb2ludGVyIHRvbyBmYXIKICogLSBBZGRzIGFuZCByZW1vdmVzIGFuICdhY3RpdmF0ZWQnIGNzcyBjbGFzcwogKiAtIE11bHRpcGxlIFt1bml0IHRlc3RzXShodHRwczovL2dpdGh1Yi5jb20vZHJpZnR5Y28vaW9uaWMvYmxvYi9tYXN0ZXIvdGVzdC91bml0L3V0aWxzL3RhcC51bml0LmpzKSBmb3IgZWFjaCBzY2VuYXJpbwogKgogKi8KLyoKCiBJT05JQyBUQVAKIC0tLS0tLS0tLS0tLS0tLQogLSBCb3RoIHRvdWNoIGFuZCBtb3VzZSBldmVudHMgYXJlIGFkZGVkIHRvIHRoZSBkb2N1bWVudC5ib2R5IG9uIERPTSByZWFkeQogLSBJZiBhIHRvdWNoIGV2ZW50IGhhcHBlbnMsIGl0IGRvZXMgbm90IHVzZSBtb3VzZSBldmVudCBsaXN0ZW5lcnMKIC0gT24gdG91Y2hlbmQsIGlmIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHN0YXJ0IGFuZCBlbmQgd2FzIHNtYWxsLCB0cmlnZ2VyIGEgY2xpY2sKIC0gSW4gdGhlIHRyaWdnZXJlZCBjbGljayBldmVudCwgYWRkIGEgJ2lzSW9uaWNUYXAnIHByb3BlcnR5CiAtIFRoZSB0cmlnZ2VyZWQgY2xpY2sgcmVjZWl2ZXMgdGhlIHNhbWUgeCx5IGNvb3JkaW5hdGVzIGFzIGFzIHRoZSBlbmQgZXZlbnQKIC0gT24gZG9jdW1lbnQuYm9keSBjbGljayBsaXN0ZW5lciAod2l0aCB1c2VDYXB0dXJlPXRydWUpLCBvbmx5IGFsbG93IGNsaWNrcyB3aXRoICdpc0lvbmljVGFwJwogLSBUcmlnZ2VyaW5nIGNsaWNrcyB3aXRoIG1vdXNlIGV2ZW50cyB3b3JrIHRoZSBzYW1lIGFzIHRvdWNoLCBleGNlcHQgd2l0aCBtb3VzZWRvd24vbW91c2V1cAogLSBUYXBwaW5nIGlucHV0cyBpcyBkaXNhYmxlZCBkdXJpbmcgc2Nyb2xsaW5nCiovCgp2YXIgdGFwRG9jOyAvLyB0aGUgZWxlbWVudCB3aGljaCB0aGUgbGlzdGVuZXJzIGFyZSBvbiAoZG9jdW1lbnQuYm9keSkKdmFyIHRhcEFjdGl2ZUVsZTsgLy8gdGhlIGVsZW1lbnQgd2hpY2ggaXMgYWN0aXZlIChwcm9iYWJseSBoYXMgZm9jdXMpCnZhciB0YXBFbmFibGVkVG91Y2hFdmVudHM7CnZhciB0YXBNb3VzZVJlc2V0VGltZXI7CnZhciB0YXBQb2ludGVyTW92ZWQ7CnZhciB0YXBQb2ludGVyU3RhcnQ7CnZhciB0YXBUb3VjaEZvY3VzZWRJbnB1dDsKdmFyIHRhcExhc3RUb3VjaFRhcmdldDsKdmFyIHRhcFRvdWNoTW92ZUxpc3RlbmVyID0gJ3RvdWNobW92ZSc7CgovLyBob3cgbXVjaCB0aGUgY29vcmRpbmF0ZXMgY2FuIGJlIG9mZiBiZXR3ZWVuIHN0YXJ0L2VuZCwgYnV0IHN0aWxsIGEgY2xpY2sKdmFyIFRBUF9SRUxFQVNFX1RPTEVSQU5DRSA9IDY7IC8vIGRlZmF1bHQgdG9sZXJhbmNlCnZhciBUQVBfUkVMRUFTRV9CVVRUT05fVE9MRVJBTkNFID0gNTA7IC8vIGJ1dHRvbiBlbGVtZW50cyBzaG91bGQgaGF2ZSBhIGxhcmdlciB0b2xlcmFuY2UKCnZhciB0YXBFdmVudExpc3RlbmVycyA9IHsKICAnY2xpY2snOiB0YXBDbGlja0dhdGVLZWVwZXIsCgogICdtb3VzZWRvd24nOiB0YXBNb3VzZURvd24sCiAgJ21vdXNldXAnOiB0YXBNb3VzZVVwLAogICdtb3VzZW1vdmUnOiB0YXBNb3VzZU1vdmUsCgogICd0b3VjaHN0YXJ0JzogdGFwVG91Y2hTdGFydCwKICAndG91Y2hlbmQnOiB0YXBUb3VjaEVuZCwKICAndG91Y2hjYW5jZWwnOiB0YXBUb3VjaENhbmNlbCwKICAndG91Y2htb3ZlJzogdGFwVG91Y2hNb3ZlLAoKICAncG9pbnRlcmRvd24nOiB0YXBUb3VjaFN0YXJ0LAogICdwb2ludGVydXAnOiB0YXBUb3VjaEVuZCwKICAncG9pbnRlcmNhbmNlbCc6IHRhcFRvdWNoQ2FuY2VsLAogICdwb2ludGVybW92ZSc6IHRhcFRvdWNoTW92ZSwKCiAgJ01TUG9pbnRlckRvd24nOiB0YXBUb3VjaFN0YXJ0LAogICdNU1BvaW50ZXJVcCc6IHRhcFRvdWNoRW5kLAogICdNU1BvaW50ZXJDYW5jZWwnOiB0YXBUb3VjaENhbmNlbCwKICAnTVNQb2ludGVyTW92ZSc6IHRhcFRvdWNoTW92ZSwKCiAgJ2ZvY3VzaW4nOiB0YXBGb2N1c0luLAogICdmb2N1c291dCc6IHRhcEZvY3VzT3V0Cn07Cgppb25pYy50YXAgPSB7CgogIHJlZ2lzdGVyOiBmdW5jdGlvbihlbGUpIHsKICAgIHRhcERvYyA9IGVsZTsKCiAgICB0YXBFdmVudExpc3RlbmVyKCdjbGljaycsIHRydWUsIHRydWUpOwogICAgdGFwRXZlbnRMaXN0ZW5lcignbW91c2V1cCcpOwogICAgdGFwRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJyk7CgogICAgaWYoIHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgKSB7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJyk7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJ1cCcpOwogICAgICB0YXBFdmVudExpc3RlbmVyKCdwb2ludGNhbmNlbCcpOwogICAgICB0YXBUb3VjaE1vdmVMaXN0ZW5lciA9ICdwb2ludGVybW92ZSc7CgogICAgfSBlbHNlIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQpIHsKICAgICAgdGFwRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyRG93bicpOwogICAgICB0YXBFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJVcCcpOwogICAgICB0YXBFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJDYW5jZWwnKTsKICAgICAgdGFwVG91Y2hNb3ZlTGlzdGVuZXIgPSAnTVNQb2ludGVyTW92ZSc7CgogICAgfSBlbHNlIHsKICAgICAgdGFwRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcpOwogICAgICB0YXBFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcpOwogICAgICB0YXBFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcpOwogICAgfQoKICAgIHRhcEV2ZW50TGlzdGVuZXIoJ2ZvY3VzaW4nKTsKICAgIHRhcEV2ZW50TGlzdGVuZXIoJ2ZvY3Vzb3V0Jyk7CgogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBmb3IodmFyIHR5cGUgaW4gdGFwRXZlbnRMaXN0ZW5lcnMpIHsKICAgICAgICB0YXBFdmVudExpc3RlbmVyKHR5cGUsIGZhbHNlKTsKICAgICAgfQogICAgICB0YXBEb2MgPSBudWxsOwogICAgICB0YXBBY3RpdmVFbGUgPSBudWxsOwogICAgICB0YXBFbmFibGVkVG91Y2hFdmVudHMgPSBmYWxzZTsKICAgICAgdGFwUG9pbnRlck1vdmVkID0gZmFsc2U7CiAgICAgIHRhcFBvaW50ZXJTdGFydCA9IG51bGw7CiAgICB9OwogIH0sCgogIGlnbm9yZVNjcm9sbFN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICByZXR1cm4gKGUuZGVmYXVsdFByZXZlbnRlZCkgfHwgIC8vIGRlZmF1bHRQcmV2ZW50ZWQgaGFzIGJlZW4gYXNzaWduZWQgYnkgYW5vdGhlciBjb21wb25lbnQgaGFuZGxpbmcgdGhlIGV2ZW50CiAgICAgICAgICAgKC9eKGZpbGV8cmFuZ2UpJC9pKS50ZXN0KGUudGFyZ2V0LnR5cGUpIHx8CiAgICAgICAgICAgKGUudGFyZ2V0LmRhdGFzZXQgPyBlLnRhcmdldC5kYXRhc2V0LnByZXZlbnRTY3JvbGwgOiBlLnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHJldmVudC1zY3JvbGwnKSkgPT0gJ3RydWUnIHx8IC8vIG1hbnVhbGx5IHNldCB3aXRoaW4gYW4gZWxlbWVudHMgYXR0cmlidXRlcwogICAgICAgICAgICghISgvXihvYmplY3R8ZW1iZWQpJC9pKS50ZXN0KGUudGFyZ2V0LnRhZ05hbWUpKSB8fCAgLy8gZmxhc2gvbW92aWUvb2JqZWN0IHRvdWNoZXMgc2hvdWxkIG5vdCB0cnkgdG8gc2Nyb2xsCiAgICAgICAgICAgaW9uaWMudGFwLmlzRWxlbWVudFRhcERpc2FibGVkKGUudGFyZ2V0KTsgLy8gY2hlY2sgaWYgdGhpcyBlbGVtZW50LCBvciBhbiBhbmNlc3RvciwgaGFzIGBkYXRhLXRhcC1kaXNhYmxlZGAgYXR0cmlidXRlCiAgfSwKCiAgaXNUZXh0SW5wdXQ6IGZ1bmN0aW9uKGVsZSkgewogICAgcmV0dXJuICEhZWxlICYmCiAgICAgICAgICAgKGVsZS50YWdOYW1lID09ICdURVhUQVJFQScgfHwKICAgICAgICAgICAgZWxlLmNvbnRlbnRFZGl0YWJsZSA9PT0gJ3RydWUnIHx8CiAgICAgICAgICAgIChlbGUudGFnTmFtZSA9PSAnSU5QVVQnICYmICEoL14ocmFkaW98Y2hlY2tib3h8cmFuZ2V8ZmlsZXxzdWJtaXR8cmVzZXQpJC9pKS50ZXN0KGVsZS50eXBlKSkgKTsKICB9LAoKICBpc0RhdGVJbnB1dDogZnVuY3Rpb24oZWxlKSB7CiAgICByZXR1cm4gISFlbGUgJiYKICAgICAgICAgICAgKGVsZS50YWdOYW1lID09ICdJTlBVVCcgJiYgKC9eKGRhdGV8dGltZXxkYXRldGltZS1sb2NhbHxtb250aHx3ZWVrKSQvaSkudGVzdChlbGUudHlwZSkpOwogIH0sCgogIGlzTGFiZWxXaXRoVGV4dElucHV0OiBmdW5jdGlvbihlbGUpIHsKICAgIHZhciBjb250YWluZXIgPSB0YXBDb250YWluaW5nRWxlbWVudChlbGUsIGZhbHNlKTsKCiAgICByZXR1cm4gISFjb250YWluZXIgJiYKICAgICAgICAgICBpb25pYy50YXAuaXNUZXh0SW5wdXQoIHRhcFRhcmdldEVsZW1lbnQoIGNvbnRhaW5lciApICk7CiAgfSwKCiAgY29udGFpbnNPcklzVGV4dElucHV0OiBmdW5jdGlvbihlbGUpIHsKICAgIHJldHVybiBpb25pYy50YXAuaXNUZXh0SW5wdXQoZWxlKSB8fCBpb25pYy50YXAuaXNMYWJlbFdpdGhUZXh0SW5wdXQoZWxlKTsKICB9LAoKICBjbG9uZUZvY3VzZWRJbnB1dDogZnVuY3Rpb24oY29udGFpbmVyLCBzY3JvbGxJbnRhbmNlKSB7CiAgICBpZihpb25pYy50YXAuaGFzQ2hlY2tlZENsb25lKSByZXR1cm47CiAgICBpb25pYy50YXAuaGFzQ2hlY2tlZENsb25lID0gdHJ1ZTsKCiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgdmFyIGZvY3VzSW5wdXQgPSBjb250YWluZXIucXVlcnlTZWxlY3RvcignOmZvY3VzJyk7CiAgICAgIGlmKCBpb25pYy50YXAuaXNUZXh0SW5wdXQoZm9jdXNJbnB1dCkgKSB7CiAgICAgICAgdmFyIGNsb25lZElucHV0ID0gZm9jdXNJbnB1dC5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5jbG9uZWQtdGV4dC1pbnB1dCcpOwogICAgICAgIGlmKCFjbG9uZWRJbnB1dCkgewogICAgICAgICAgY2xvbmVkSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGZvY3VzSW5wdXQudGFnTmFtZSk7CiAgICAgICAgICBjbG9uZWRJbnB1dC5wbGFjZWhvbGRlciA9IGZvY3VzSW5wdXQucGxhY2Vob2xkZXI7CiAgICAgICAgICBjbG9uZWRJbnB1dC50eXBlID0gZm9jdXNJbnB1dC50eXBlOwogICAgICAgICAgY2xvbmVkSW5wdXQudmFsdWUgPSBmb2N1c0lucHV0LnZhbHVlOwogICAgICAgICAgY2xvbmVkSW5wdXQuc3R5bGUgPSBmb2N1c0lucHV0LnN0eWxlOwogICAgICAgICAgY2xvbmVkSW5wdXQuY2xhc3NOYW1lID0gZm9jdXNJbnB1dC5jbGFzc05hbWU7CiAgICAgICAgICBjbG9uZWRJbnB1dC5jbGFzc0xpc3QuYWRkKCdjbG9uZWQtdGV4dC1pbnB1dCcpOwogICAgICAgICAgY2xvbmVkSW5wdXQucmVhZE9ubHkgPSB0cnVlOwogICAgICAgICAgaWYgKGZvY3VzSW5wdXQuaXNDb250ZW50RWRpdGFibGUpIHsKICAgICAgICAgICAgY2xvbmVkSW5wdXQuY29udGVudEVkaXRhYmxlID0gZm9jdXNJbnB1dC5jb250ZW50RWRpdGFibGU7CiAgICAgICAgICAgIGNsb25lZElucHV0LmlubmVySFRNTCA9IGZvY3VzSW5wdXQuaW5uZXJIVE1MOwogICAgICAgICAgfQogICAgICAgICAgZm9jdXNJbnB1dC5wYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShjbG9uZWRJbnB1dCwgZm9jdXNJbnB1dCk7CiAgICAgICAgICBmb2N1c0lucHV0LnN0eWxlLnRvcCA9IGZvY3VzSW5wdXQub2Zmc2V0VG9wOwogICAgICAgICAgZm9jdXNJbnB1dC5jbGFzc0xpc3QuYWRkKCdwcmV2aW91cy1pbnB1dC1mb2N1cycpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSwKCiAgaGFzQ2hlY2tlZENsb25lOiBmYWxzZSwKCiAgcmVtb3ZlQ2xvbmVkSW5wdXRzOiBmdW5jdGlvbihjb250YWluZXIsIHNjcm9sbEludGFuY2UpIHsKICAgIGlvbmljLnRhcC5oYXNDaGVja2VkQ2xvbmUgPSBmYWxzZTsKCiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgdmFyIGNsb25lZElucHV0cyA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCcuY2xvbmVkLXRleHQtaW5wdXQnKTsKICAgICAgdmFyIHByZXZpb3VzSW5wdXRGb2N1cyA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCcucHJldmlvdXMtaW5wdXQtZm9jdXMnKTsKICAgICAgdmFyIHg7CgogICAgICBmb3IoeD0wOyB4PGNsb25lZElucHV0cy5sZW5ndGg7IHgrKykgewogICAgICAgIGNsb25lZElucHV0c1t4XS5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBjbG9uZWRJbnB1dHNbeF0gKTsKICAgICAgfQoKICAgICAgZm9yKHg9MDsgeDxwcmV2aW91c0lucHV0Rm9jdXMubGVuZ3RoOyB4KyspIHsKICAgICAgICBwcmV2aW91c0lucHV0Rm9jdXNbeF0uY2xhc3NMaXN0LnJlbW92ZSgncHJldmlvdXMtaW5wdXQtZm9jdXMnKTsKICAgICAgICBwcmV2aW91c0lucHV0Rm9jdXNbeF0uc3R5bGUudG9wID0gJyc7CiAgICAgICAgcHJldmlvdXNJbnB1dEZvY3VzW3hdLmZvY3VzKCk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIHJlcXVpcmVzTmF0aXZlQ2xpY2s6IGZ1bmN0aW9uKGVsZSkgewogICAgaWYoIWVsZSB8fCBlbGUuZGlzYWJsZWQgfHwgKC9eKGZpbGV8cmFuZ2UpJC9pKS50ZXN0KGVsZS50eXBlKSB8fCAoL14ob2JqZWN0fHZpZGVvKSQvaSkudGVzdChlbGUudGFnTmFtZSkgfHwgaW9uaWMudGFwLmlzTGFiZWxDb250YWluaW5nRmlsZUlucHV0KGVsZSkgKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGlvbmljLnRhcC5pc0VsZW1lbnRUYXBEaXNhYmxlZChlbGUpOwogIH0sCgogIGlzTGFiZWxDb250YWluaW5nRmlsZUlucHV0OiBmdW5jdGlvbihlbGUpIHsKICAgIHZhciBsYmwgPSB0YXBDb250YWluaW5nRWxlbWVudChlbGUpOwogICAgaWYobGJsLnRhZ05hbWUgIT09ICdMQUJFTCcpIHJldHVybiBmYWxzZTsKICAgIHZhciBmaWxlSW5wdXQgPSBsYmwucXVlcnlTZWxlY3RvcignaW5wdXRbdHlwZT1maWxlXScpOwogICAgaWYoZmlsZUlucHV0ICYmIGZpbGVJbnB1dC5kaXNhYmxlZCA9PT0gZmFsc2UpIHJldHVybiB0cnVlOwogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIGlzRWxlbWVudFRhcERpc2FibGVkOiBmdW5jdGlvbihlbGUpIHsKICAgIGlmKGVsZSAmJiBlbGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgdmFyIGVsZW1lbnQgPSBlbGU7CiAgICAgIHdoaWxlKGVsZW1lbnQpIHsKICAgICAgICBpZiggKGVsZW1lbnQuZGF0YXNldCA/IGVsZW1lbnQuZGF0YXNldC50YXBEaXNhYmxlZCA6IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXRhcC1kaXNhYmxlZCcpKSA9PSAndHJ1ZScgKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50RWxlbWVudDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIHNldFRvbGVyYW5jZTogZnVuY3Rpb24ocmVsZWFzZVRvbGVyYW5jZSwgcmVsZWFzZUJ1dHRvblRvbGVyYW5jZSkgewogICAgVEFQX1JFTEVBU0VfVE9MRVJBTkNFID0gcmVsZWFzZVRvbGVyYW5jZTsKICAgIFRBUF9SRUxFQVNFX0JVVFRPTl9UT0xFUkFOQ0UgPSByZWxlYXNlQnV0dG9uVG9sZXJhbmNlOwogIH0sCgogIGNhbmNlbENsaWNrOiBmdW5jdGlvbigpIHsKICAgIC8vIHVzZWQgdG8gY2FuY2VsIGFueSBzaW11bGF0ZWQgY2xpY2tzIHdoaWNoIG1heSBoYXBwZW4gb24gYSB0b3VjaGVuZC9tb3VzZXVwCiAgICAvLyBnZXN0dXJlcyB1c2VzIHRoaXMgbWV0aG9kIHdpdGhpbiBpdHMgdGFwIGFuZCBob2xkIGV2ZW50cwogICAgdGFwUG9pbnRlck1vdmVkID0gdHJ1ZTsKICB9LAoKICBwb2ludGVyQ29vcmQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gZ2V0IGNvb3JkaW5hdGVzIGZvciBib3RoIGEgbW91c2UgY2xpY2sKICAgIC8vIG9yIGEgdG91Y2ggZGVwZW5kaW5nIG9uIHRoZSBnaXZlbiBldmVudAogICAgdmFyIGMgPSB7IHg6MCwgeTowIH07CiAgICBpZihldmVudCkgewogICAgICB2YXIgdG91Y2hlcyA9IGV2ZW50LnRvdWNoZXMgJiYgZXZlbnQudG91Y2hlcy5sZW5ndGggPyBldmVudC50b3VjaGVzIDogW2V2ZW50XTsKICAgICAgdmFyIGUgPSAoZXZlbnQuY2hhbmdlZFRvdWNoZXMgJiYgZXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0pIHx8IHRvdWNoZXNbMF07CiAgICAgIGlmKGUpIHsKICAgICAgICBjLnggPSBlLmNsaWVudFggfHwgZS5wYWdlWCB8fCAwOwogICAgICAgIGMueSA9IGUuY2xpZW50WSB8fCBlLnBhZ2VZIHx8IDA7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjOwogIH0KCn07CgpmdW5jdGlvbiB0YXBFdmVudExpc3RlbmVyKHR5cGUsIGVuYWJsZSwgdXNlQ2FwdHVyZSkgewogIGlmKGVuYWJsZSAhPT0gZmFsc2UpIHsKICAgIHRhcERvYy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIHRhcEV2ZW50TGlzdGVuZXJzW3R5cGVdLCB1c2VDYXB0dXJlKTsKICB9IGVsc2UgewogICAgdGFwRG9jLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgdGFwRXZlbnRMaXN0ZW5lcnNbdHlwZV0pOwogIH0KfQoKZnVuY3Rpb24gdGFwQ2xpY2soZSkgewogIC8vIHNpbXVsYXRlIGEgbm9ybWFsIGNsaWNrIGJ5IHJ1bm5pbmcgdGhlIGVsZW1lbnQncyBjbGljayBtZXRob2QgdGhlbiBmb2N1cyBvbiBpdAogIHZhciBjb250YWluZXIgPSB0YXBDb250YWluaW5nRWxlbWVudChlLnRhcmdldCk7CiAgdmFyIGVsZSA9IHRhcFRhcmdldEVsZW1lbnQoY29udGFpbmVyKTsKCiAgaWYoIGlvbmljLnRhcC5yZXF1aXJlc05hdGl2ZUNsaWNrKGVsZSkgfHwgdGFwUG9pbnRlck1vdmVkICkgcmV0dXJuIGZhbHNlOwoKICB2YXIgYyA9IGlvbmljLnRhcC5wb2ludGVyQ29vcmQoZSk7CgogIHZvaWQgMDsKICB0cmlnZ2VyTW91c2VFdmVudCgnY2xpY2snLCBlbGUsIGMueCwgYy55KTsKCiAgLy8gaWYgaXQncyBhbiBpbnB1dCwgZm9jdXMgaW4gb24gdGhlIHRhcmdldCwgb3RoZXJ3aXNlIGJsdXIKICB0YXBIYW5kbGVGb2N1cyhlbGUpOwp9CgpmdW5jdGlvbiB0cmlnZ2VyTW91c2VFdmVudCh0eXBlLCBlbGUsIHgsIHkpIHsKICAvLyB1c2luZyBpbml0TW91c2VFdmVudCBpbnN0ZWFkIG9mIE1vdXNlRXZlbnQgZm9yIG91ciBBbmRyb2lkIGZyaWVuZHMKICB2YXIgY2xpY2tFdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJNb3VzZUV2ZW50cyIpOwogIGNsaWNrRXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgd2luZG93LCAxLCAwLCAwLCB4LCB5LCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CiAgY2xpY2tFdmVudC5pc0lvbmljVGFwID0gdHJ1ZTsKICBlbGUuZGlzcGF0Y2hFdmVudChjbGlja0V2ZW50KTsKfQoKZnVuY3Rpb24gdGFwQ2xpY2tHYXRlS2VlcGVyKGUpIHsKICBpZihlLnRhcmdldC50eXBlID09ICdzdWJtaXQnICYmIGUuZGV0YWlsID09PSAwKSB7CiAgICAvLyBkbyBub3QgcHJldmVudCBjbGljayBpZiBpdCBjYW1lIGZyb20gYW4gIkVudGVyIiBvciAiR28iIGtleXByZXNzIHN1Ym1pdAogICAgcmV0dXJuOwogIH0KCiAgLy8gZG8gbm90IGFsbG93IHRocm91Z2ggYW55IGNsaWNrIGV2ZW50cyB0aGF0IHdlcmUgbm90IGNyZWF0ZWQgYnkgaW9uaWMudGFwCiAgaWYoIChpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgJiYgaW9uaWMudGFwLmNvbnRhaW5zT3JJc1RleHRJbnB1dChlLnRhcmdldCkgKSB8fAogICAgICAoIWUuaXNJb25pY1RhcCAmJiAhaW9uaWMudGFwLnJlcXVpcmVzTmF0aXZlQ2xpY2soZS50YXJnZXQpKSApIHsKICAgIHZvaWQgMDsKICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgaWYoICFpb25pYy50YXAuaXNMYWJlbFdpdGhUZXh0SW5wdXQoZS50YXJnZXQpICkgewogICAgICAvLyBsYWJlbHMgY2xpY2tzIGZyb20gbmF0aXZlIHNob3VsZCBub3QgcHJldmVudERlZmF1bHQgb3RoZXJzaXplIGtleWJvYXJkIHdpbGwgbm90IHNob3cgb24gaW5wdXQgZm9jdXMKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KfQoKLy8gTU9VU0UKZnVuY3Rpb24gdGFwTW91c2VEb3duKGUpIHsKICBpZihlLmlzSW9uaWNUYXAgfHwgdGFwSWdub3JlRXZlbnQoZSkpIHJldHVybjsKCiAgaWYodGFwRW5hYmxlZFRvdWNoRXZlbnRzKSB7CiAgICB2b2lkIDA7CiAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwoKICAgIGlmKCAoIWlvbmljLnRhcC5pc1RleHRJbnB1dChlLnRhcmdldCkgfHwgdGFwTGFzdFRvdWNoVGFyZ2V0ICE9PSBlLnRhcmdldCkgJiYgISgvXihzZWxlY3R8b3B0aW9uKSQvaSkudGVzdChlLnRhcmdldC50YWdOYW1lKSApIHsKICAgICAgLy8gSWYgeW91IHByZXZlbnREZWZhdWx0IG9uIGEgdGV4dCBpbnB1dCB0aGVuIHlvdSBjYW5ub3QgbW92ZSBpdHMgdGV4dCBjYXJldC9jdXJzb3IuCiAgICAgIC8vIEFsbG93IHRocm91Z2ggb25seSB0aGUgdGV4dCBpbnB1dCBkZWZhdWx0LiBIb3dldmVyLCB3aXRob3V0IHByZXZlbnREZWZhdWx0IG9uIGFuCiAgICAgIC8vIGlucHV0IHRoZSAzMDBtcyBkZWxheSBjYW4gY2hhbmdlIGZvY3VzIG9uIGlucHV0cyBhZnRlciB0aGUga2V5Ym9hcmQgc2hvd3MgdXAuCiAgICAgIC8vIFRoZSBmb2N1c2luIGV2ZW50IGhhbmRsZXMgdGhlIGNoYW5jZSBvZiBmb2N1cyBjaGFuZ2luZyBhZnRlciB0aGUga2V5Ym9hcmQgc2hvd3MuCiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKICB0YXBQb2ludGVyU3RhcnQgPSBpb25pYy50YXAucG9pbnRlckNvb3JkKGUpOwoKICB0YXBFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnKTsKICBpb25pYy5hY3RpdmF0b3Iuc3RhcnQoZSk7Cn0KCmZ1bmN0aW9uIHRhcE1vdXNlVXAoZSkgewogIGlmKHRhcEVuYWJsZWRUb3VjaEV2ZW50cykgewogICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGlmKCB0YXBJZ25vcmVFdmVudChlKSB8fCAoL14oc2VsZWN0fG9wdGlvbikkL2kpLnRlc3QoZS50YXJnZXQudGFnTmFtZSkgKSByZXR1cm4gZmFsc2U7CgogIGlmKCAhdGFwSGFzUG9pbnRlck1vdmVkKGUpICkgewogICAgdGFwQ2xpY2soZSk7CiAgfQogIHRhcEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGZhbHNlKTsKICBpb25pYy5hY3RpdmF0b3IuZW5kKCk7CiAgdGFwUG9pbnRlck1vdmVkID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIHRhcE1vdXNlTW92ZShlKSB7CiAgaWYoIHRhcEhhc1BvaW50ZXJNb3ZlZChlKSApIHsKICAgIHRhcEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGZhbHNlKTsKICAgIGlvbmljLmFjdGl2YXRvci5lbmQoKTsKICAgIHRhcFBvaW50ZXJNb3ZlZCA9IHRydWU7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9CgoKLy8gVE9VQ0gKZnVuY3Rpb24gdGFwVG91Y2hTdGFydChlKSB7CiAgaWYoIHRhcElnbm9yZUV2ZW50KGUpICkgcmV0dXJuOwoKICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKCiAgdGFwRW5hYmxlVG91Y2hFdmVudHMoKTsKICB0YXBQb2ludGVyU3RhcnQgPSBpb25pYy50YXAucG9pbnRlckNvb3JkKGUpOwoKICB0YXBFdmVudExpc3RlbmVyKHRhcFRvdWNoTW92ZUxpc3RlbmVyKTsKICBpb25pYy5hY3RpdmF0b3Iuc3RhcnQoZSk7CgogIGlmKCBpb25pYy5QbGF0Zm9ybS5pc0lPUygpICYmIGlvbmljLnRhcC5pc0xhYmVsV2l0aFRleHRJbnB1dChlLnRhcmdldCkgKSB7CiAgICAvLyBpZiB0aGUgdGFwcGVkIGVsZW1lbnQgaXMgYSBsYWJlbCwgd2hpY2ggaGFzIGEgY2hpbGQgaW5wdXQKICAgIC8vIHRoZW4gcHJldmVudERlZmF1bHQgc28gaU9TIGRvZXNuJ3QgdWdseSBhdXRvIHNjcm9sbCB0byB0aGUgaW5wdXQKICAgIC8vIGJ1dCBkbyBub3QgcHJldmVudCBkZWZhdWx0IG9uIEFuZHJvaWQgb3IgZWxzZSB5b3UgY2Fubm90IG1vdmUgdGhlIHRleHQgY2FyZXQKICAgIC8vIGFuZCBkbyBub3QgcHJldmVudCBkZWZhdWx0IG9uIEFuZHJvaWQgb3IgZWxzZSBubyB2aXJ0dWFsIGtleWJvYXJkIHNob3dzIHVwCgogICAgdmFyIHRleHRJbnB1dCA9IHRhcFRhcmdldEVsZW1lbnQoIHRhcENvbnRhaW5pbmdFbGVtZW50KGUudGFyZ2V0KSApOwogICAgaWYoIHRleHRJbnB1dCAhPT0gdGFwQWN0aXZlRWxlICkgewogICAgICAvLyBkb24ndCBwcmV2ZW50RGVmYXVsdCBvbiBhbiBhbHJlYWR5IGZvY3VzZWQgaW5wdXQgb3IgZWxzZSBpT1MncyB0ZXh0IGNhcmV0IGlzbid0IHVzYWJsZQogICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiB0YXBUb3VjaEVuZChlKSB7CiAgaWYoIHRhcElnbm9yZUV2ZW50KGUpICkgcmV0dXJuOwoKICB0YXBFbmFibGVUb3VjaEV2ZW50cygpOwogIGlmKCAhdGFwSGFzUG9pbnRlck1vdmVkKGUpICkgewogICAgdGFwQ2xpY2soZSk7CgogICAgaWYoICgvXihzZWxlY3R8b3B0aW9uKSQvaSkudGVzdChlLnRhcmdldC50YWdOYW1lKSApIHsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgfQogIH0KCiAgdGFwTGFzdFRvdWNoVGFyZ2V0ID0gZS50YXJnZXQ7CiAgdGFwVG91Y2hDYW5jZWwoKTsKfQoKZnVuY3Rpb24gdGFwVG91Y2hNb3ZlKGUpIHsKICBpZiggdGFwSGFzUG9pbnRlck1vdmVkKGUpICkgewogICAgdGFwUG9pbnRlck1vdmVkID0gdHJ1ZTsKICAgIHRhcEV2ZW50TGlzdGVuZXIodGFwVG91Y2hNb3ZlTGlzdGVuZXIsIGZhbHNlKTsKICAgIGlvbmljLmFjdGl2YXRvci5lbmQoKTsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0KCmZ1bmN0aW9uIHRhcFRvdWNoQ2FuY2VsKGUpIHsKICB0YXBFdmVudExpc3RlbmVyKHRhcFRvdWNoTW92ZUxpc3RlbmVyLCBmYWxzZSk7CiAgaW9uaWMuYWN0aXZhdG9yLmVuZCgpOwogIHRhcFBvaW50ZXJNb3ZlZCA9IGZhbHNlOwp9CgpmdW5jdGlvbiB0YXBFbmFibGVUb3VjaEV2ZW50cygpIHsKICB0YXBFbmFibGVkVG91Y2hFdmVudHMgPSB0cnVlOwogIGNsZWFyVGltZW91dCh0YXBNb3VzZVJlc2V0VGltZXIpOwogIHRhcE1vdXNlUmVzZXRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgIHRhcEVuYWJsZWRUb3VjaEV2ZW50cyA9IGZhbHNlOwogIH0sIDIwMDApOwp9CgpmdW5jdGlvbiB0YXBJZ25vcmVFdmVudChlKSB7CiAgaWYoZS5pc1RhcEhhbmRsZWQpIHJldHVybiB0cnVlOwogIGUuaXNUYXBIYW5kbGVkID0gdHJ1ZTsKCiAgaWYoIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyAmJiBpb25pYy50YXAuY29udGFpbnNPcklzVGV4dElucHV0KGUudGFyZ2V0KSApIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHJldHVybiB0cnVlOwogIH0KfQoKZnVuY3Rpb24gdGFwSGFuZGxlRm9jdXMoZWxlKSB7CiAgdGFwVG91Y2hGb2N1c2VkSW5wdXQgPSBudWxsOwoKICB2YXIgdHJpZ2dlckZvY3VzSW4gPSBmYWxzZTsKCiAgaWYoZWxlLnRhZ05hbWUgPT0gJ1NFTEVDVCcpIHsKICAgIC8vIHRyaWNrIHRvIGZvcmNlIEFuZHJvaWQgb3B0aW9ucyB0byBzaG93IHVwCiAgICB0cmlnZ2VyTW91c2VFdmVudCgnbW91c2Vkb3duJywgZWxlLCAwLCAwKTsKICAgIGVsZS5mb2N1cyAmJiBlbGUuZm9jdXMoKTsKICAgIHRyaWdnZXJGb2N1c0luID0gdHJ1ZTsKCiAgfSBlbHNlIGlmKHRhcEFjdGl2ZUVsZW1lbnQoKSA9PT0gZWxlKSB7CiAgICAvLyBhbHJlYWR5IGlzIHRoZSBhY3RpdmUgZWxlbWVudCBhbmQgaGFzIGZvY3VzCiAgICB0cmlnZ2VyRm9jdXNJbiA9IHRydWU7CgogIH0gZWxzZSBpZiggKC9eKGlucHV0fHRleHRhcmVhKSQvaSkudGVzdChlbGUudGFnTmFtZSkgfHwgZWxlLmlzQ29udGVudEVkaXRhYmxlICkgewogICAgdHJpZ2dlckZvY3VzSW4gPSB0cnVlOwogICAgZWxlLmZvY3VzICYmIGVsZS5mb2N1cygpOwogICAgZWxlLnZhbHVlID0gZWxlLnZhbHVlOwogICAgaWYoIHRhcEVuYWJsZWRUb3VjaEV2ZW50cyApIHsKICAgICAgdGFwVG91Y2hGb2N1c2VkSW5wdXQgPSBlbGU7CiAgICB9CgogIH0gZWxzZSB7CiAgICB0YXBGb2N1c091dEFjdGl2ZSgpOwogIH0KCiAgaWYodHJpZ2dlckZvY3VzSW4pIHsKICAgIHRhcEFjdGl2ZUVsZW1lbnQoZWxlKTsKICAgIGlvbmljLnRyaWdnZXIoJ2lvbmljLmZvY3VzaW4nLCB7CiAgICAgIHRhcmdldDogZWxlCiAgICB9LCB0cnVlKTsKICB9Cn0KCmZ1bmN0aW9uIHRhcEZvY3VzT3V0QWN0aXZlKCkgewogIHZhciBlbGUgPSB0YXBBY3RpdmVFbGVtZW50KCk7CiAgaWYoZWxlICYmICgoL14oaW5wdXR8dGV4dGFyZWF8c2VsZWN0KSQvaSkudGVzdChlbGUudGFnTmFtZSkgfHwgZWxlLmlzQ29udGVudEVkaXRhYmxlKSApIHsKICAgIHZvaWQgMDsKICAgIGVsZS5ibHVyKCk7CiAgfQogIHRhcEFjdGl2ZUVsZW1lbnQobnVsbCk7Cn0KCmZ1bmN0aW9uIHRhcEZvY3VzSW4oZSkgewogIC8vIEJlY2F1c2UgYSB0ZXh0IGlucHV0IGRvZXNuJ3QgcHJldmVudERlZmF1bHQgKHNvIHRoZSBjYXJldCBzdGlsbCB3b3JrcykgdGhlcmUncyBhIGNoYW5jZQogIC8vIHRoYXQgaXQncyBtb3VzZWRvd24gZXZlbnQgMzAwbXMgbGF0ZXIgd2lsbCBjaGFuZ2UgdGhlIGZvY3VzIHRvIGFub3RoZXIgZWxlbWVudCBhZnRlcgogIC8vIHRoZSBrZXlib2FyZCBzaG93cyB1cC4KCiAgaWYoIHRhcEVuYWJsZWRUb3VjaEV2ZW50cyAmJgogICAgICBpb25pYy50YXAuaXNUZXh0SW5wdXQoIHRhcEFjdGl2ZUVsZW1lbnQoKSApICYmCiAgICAgIGlvbmljLnRhcC5pc1RleHRJbnB1dCh0YXBUb3VjaEZvY3VzZWRJbnB1dCkgJiYKICAgICAgdGFwVG91Y2hGb2N1c2VkSW5wdXQgIT09IGUudGFyZ2V0ICkgewoKICAgIC8vIDEpIFRoZSBwb2ludGVyIGlzIGZyb20gdG91Y2ggZXZlbnRzCiAgICAvLyAyKSBUaGVyZSBpcyBhbiBhY3RpdmUgZWxlbWVudCB3aGljaCBpcyBhIHRleHQgaW5wdXQKICAgIC8vIDMpIEEgdGV4dCBpbnB1dCB3YXMganVzdCBzZXQgdG8gYmUgZm9jdXNlZCBvbiBieSBhIHRvdWNoIGV2ZW50CiAgICAvLyA0KSBBIG5ldyBmb2N1cyBoYXMgYmVlbiBzZXQsIGhvd2V2ZXIgdGhlIHRhcmdldCBpc24ndCB0aGUgb25lIHRoZSB0b3VjaCBldmVudCB3YW50ZWQKICAgIHZvaWQgMDsKICAgIHRhcFRvdWNoRm9jdXNlZElucHV0LmZvY3VzKCk7CiAgICB0YXBUb3VjaEZvY3VzZWRJbnB1dCA9IG51bGw7CiAgfQogIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyA9IGZhbHNlOwp9CgpmdW5jdGlvbiB0YXBGb2N1c091dCgpIHsKICB0YXBBY3RpdmVFbGVtZW50KG51bGwpOwp9CgpmdW5jdGlvbiB0YXBBY3RpdmVFbGVtZW50KGVsZSkgewogIGlmKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIHRhcEFjdGl2ZUVsZSA9IGVsZTsKICB9CiAgcmV0dXJuIHRhcEFjdGl2ZUVsZSB8fCBkb2N1bWVudC5hY3RpdmVFbGVtZW50Owp9CgpmdW5jdGlvbiB0YXBIYXNQb2ludGVyTW92ZWQoZW5kRXZlbnQpIHsKICBpZighZW5kRXZlbnQgfHwgZW5kRXZlbnQudGFyZ2V0Lm5vZGVUeXBlICE9PSAxIHx8ICF0YXBQb2ludGVyU3RhcnQgfHwgKCB0YXBQb2ludGVyU3RhcnQueCA9PT0gMCAmJiB0YXBQb2ludGVyU3RhcnQueSA9PT0gMCApKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBlbmRDb29yZGluYXRlcyA9IGlvbmljLnRhcC5wb2ludGVyQ29vcmQoZW5kRXZlbnQpOwoKICB2YXIgaGFzQ2xhc3NMaXN0ID0gISEoZW5kRXZlbnQudGFyZ2V0LmNsYXNzTGlzdCAmJiBlbmRFdmVudC50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKTsKICB2YXIgcmVsZWFzZVRvbGVyYW5jZSA9IGhhc0NsYXNzTGlzdCAmIGVuZEV2ZW50LnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ2J1dHRvbicpID8KICAgIFRBUF9SRUxFQVNFX0JVVFRPTl9UT0xFUkFOQ0UgOgogICAgVEFQX1JFTEVBU0VfVE9MRVJBTkNFOwoKICByZXR1cm4gTWF0aC5hYnModGFwUG9pbnRlclN0YXJ0LnggLSBlbmRDb29yZGluYXRlcy54KSA+IHJlbGVhc2VUb2xlcmFuY2UgfHwKICAgICAgICAgTWF0aC5hYnModGFwUG9pbnRlclN0YXJ0LnkgLSBlbmRDb29yZGluYXRlcy55KSA+IHJlbGVhc2VUb2xlcmFuY2U7Cn0KCmZ1bmN0aW9uIHRhcENvbnRhaW5pbmdFbGVtZW50KGVsZSwgYWxsb3dTZWxmKSB7CiAgdmFyIGNsaW1iRWxlID0gZWxlOwogIGZvcih2YXIgeD0wOyB4PDY7IHgrKykgewogICAgaWYoIWNsaW1iRWxlKSBicmVhazsKICAgIGlmKGNsaW1iRWxlLnRhZ05hbWUgPT09ICdMQUJFTCcpIHJldHVybiBjbGltYkVsZTsKICAgIGNsaW1iRWxlID0gY2xpbWJFbGUucGFyZW50RWxlbWVudDsKICB9CiAgaWYoYWxsb3dTZWxmICE9PSBmYWxzZSkgcmV0dXJuIGVsZTsKfQoKZnVuY3Rpb24gdGFwVGFyZ2V0RWxlbWVudChlbGUpIHsKICBpZihlbGUgJiYgZWxlLnRhZ05hbWUgPT09ICdMQUJFTCcpIHsKICAgIGlmKGVsZS5jb250cm9sKSByZXR1cm4gZWxlLmNvbnRyb2w7CgogICAgLy8gb2xkZXIgZGV2aWNlcyBkbyBub3Qgc3VwcG9ydCB0aGUgImNvbnRyb2wiIHByb3BlcnR5CiAgICBpZihlbGUucXVlcnlTZWxlY3RvcikgewogICAgICB2YXIgY29udHJvbCA9IGVsZS5xdWVyeVNlbGVjdG9yKCdpbnB1dCx0ZXh0YXJlYSxzZWxlY3QnKTsKICAgICAgaWYoY29udHJvbCkgcmV0dXJuIGNvbnRyb2w7CiAgICB9CiAgfQogIHJldHVybiBlbGU7Cn0KCmlvbmljLkRvbVV0aWwucmVhZHkoZnVuY3Rpb24oKXsKICB2YXIgbmcgPSB0eXBlb2YgYW5ndWxhciAhPT0gJ3VuZGVmaW5lZCcgPyBhbmd1bGFyIDogbnVsbDsKICAvL2RvIG5vdGhpbmcgZm9yIGUyZSB0ZXN0cwogIGlmICghbmcgfHwgKG5nICYmICFuZy5zY2VuYXJpbykpIHsKICAgIGlvbmljLnRhcC5yZWdpc3Rlcihkb2N1bWVudCk7CiAgfQp9KTsKCihmdW5jdGlvbihkb2N1bWVudCwgaW9uaWMpIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBxdWV1ZUVsZW1lbnRzID0ge307ICAgLy8gZWxlbWVudHMgdGhhdCBzaG91bGQgZ2V0IGFuIGFjdGl2ZSBzdGF0ZSBpbiBYWCBtaWxsaXNlY29uZHMKICB2YXIgYWN0aXZlRWxlbWVudHMgPSB7fTsgIC8vIGVsZW1lbnRzIHRoYXQgYXJlIGN1cnJlbnRseSBhY3RpdmUKICB2YXIga2V5SWQgPSAwOyAgICAgICAgICAgIC8vIGEgY291bnRlciBmb3IgdW5pcXVlIGtleXMgZm9yIHRoZSBhYm92ZSBvamVjdHMKICB2YXIgQUNUSVZBVEVEX0NMQVNTID0gJ2FjdGl2YXRlZCc7CgogIGlvbmljLmFjdGl2YXRvciA9IHsKCiAgICBzdGFydDogZnVuY3Rpb24oZSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyB3aGVuIGFuIGVsZW1lbnQgaXMgdG91Y2hlZC9jbGlja2VkLCBpdCBjbGltYnMgdXAgYSBmZXcKICAgICAgLy8gcGFyZW50cyB0byBzZWUgaWYgaXQgaXMgYW4gLml0ZW0gb3IgLmJ1dHRvbiBlbGVtZW50CiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICAgIGlmICggaW9uaWMudGFwLnJlcXVpcmVzTmF0aXZlQ2xpY2soZS50YXJnZXQpICkgcmV0dXJuOwogICAgICAgIHZhciBlbGUgPSBlLnRhcmdldDsKICAgICAgICB2YXIgZWxlVG9BY3RpdmF0ZTsKCiAgICAgICAgZm9yKHZhciB4PTA7IHg8NjsgeCsrKSB7CiAgICAgICAgICBpZighZWxlIHx8IGVsZS5ub2RlVHlwZSAhPT0gMSkgYnJlYWs7CiAgICAgICAgICBpZihlbGVUb0FjdGl2YXRlICYmIGVsZS5jbGFzc0xpc3QuY29udGFpbnMoJ2l0ZW0nKSkgewogICAgICAgICAgICBlbGVUb0FjdGl2YXRlID0gZWxlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCBlbGUudGFnTmFtZSA9PSAnQScgfHwgZWxlLnRhZ05hbWUgPT0gJ0JVVFRPTicgfHwgZWxlLmhhc0F0dHJpYnV0ZSgnbmctY2xpY2snKSApIHsKICAgICAgICAgICAgZWxlVG9BY3RpdmF0ZSA9IGVsZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiggZWxlLmNsYXNzTGlzdC5jb250YWlucygnYnV0dG9uJykgKSB7CiAgICAgICAgICAgIGVsZVRvQWN0aXZhdGUgPSBlbGU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgLy8gbm8gc2Vuc2UgY2xpbWJpbmcgcGFzdCB0aGVzZQogICAgICAgICAgaWYoZWxlLmNsYXNzTGlzdC5jb250YWlucygncGFuZScpIHx8IGVsZS50YWdOYW1lID09ICdCT0RZJyB8fCBlbGUudGFnTmFtZSA9PSAnSU9OLUNPTlRFTlQnKXsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBlbGUgPSBlbGUucGFyZW50RWxlbWVudDsKICAgICAgICB9CgogICAgICAgIGlmKGVsZVRvQWN0aXZhdGUpIHsKICAgICAgICAgIC8vIHF1ZXVlIHRoYXQgdGhpcyBlbGVtZW50IHNob3VsZCBiZSBzZXQgdG8gYWN0aXZlCiAgICAgICAgICBxdWV1ZUVsZW1lbnRzW2tleUlkXSA9IGVsZVRvQWN0aXZhdGU7CgogICAgICAgICAgLy8gaW4gWFggbWlsbGlzZWNvbmRzLCBzZXQgdGhlIHF1ZXVlZCBlbGVtZW50cyB0byBhY3RpdmUKICAgICAgICAgIGlmKGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnKSB7CiAgICAgICAgICAgIHNlbGYuX2FjdGl2YXRlVGltZW91dCA9IHNldFRpbWVvdXQoYWN0aXZhdGVFbGVtZW50cywgODApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFjdGl2YXRlRWxlbWVudHMpOwogICAgICAgICAgfQoKICAgICAgICAgIGtleUlkID0gKGtleUlkID4gMTkgPyAwIDoga2V5SWQgKyAxKTsKICAgICAgICB9CgogICAgICB9KTsKICAgIH0sCgogICAgZW5kOiBmdW5jdGlvbigpIHsKICAgICAgLy8gY2xlYXIgb3V0IGFueSBhY3RpdmUvcXVldWVkIGVsZW1lbnRzIGFmdGVyIFhYIG1pbGxpc2Vjb25kcwogICAgICBjbGVhclRpbWVvdXQodGhpcy5fYWN0aXZhdGVUaW1lb3V0KTsKICAgICAgc2V0VGltZW91dChjbGVhciwgMjAwKTsKICAgIH0KCiAgfTsKCiAgZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAvLyBjbGVhciBvdXQgYW55IGVsZW1lbnRzIHRoYXQgYXJlIHF1ZXVlZCB0byBiZSBzZXQgdG8gYWN0aXZlCiAgICBxdWV1ZUVsZW1lbnRzID0ge307CgogICAgLy8gaW4gdGhlIG5leHQgZnJhbWUsIHJlbW92ZSB0aGUgYWN0aXZlIGNsYXNzIGZyb20gYWxsIGFjdGl2ZSBlbGVtZW50cwogICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRlYWN0aXZhdGVFbGVtZW50cyk7CiAgfQoKICBmdW5jdGlvbiBhY3RpdmF0ZUVsZW1lbnRzKCkgewogICAgLy8gYWN0aXZhdGUgYWxsIGVsZW1lbnRzIGluIHRoZSBxdWV1ZQogICAgZm9yKHZhciBrZXkgaW4gcXVldWVFbGVtZW50cykgewogICAgICBpZihxdWV1ZUVsZW1lbnRzW2tleV0pIHsKICAgICAgICBxdWV1ZUVsZW1lbnRzW2tleV0uY2xhc3NMaXN0LmFkZChBQ1RJVkFURURfQ0xBU1MpOwogICAgICAgIGFjdGl2ZUVsZW1lbnRzW2tleV0gPSBxdWV1ZUVsZW1lbnRzW2tleV07CiAgICAgIH0KICAgIH0KICAgIHF1ZXVlRWxlbWVudHMgPSB7fTsKICB9CgogIGZ1bmN0aW9uIGRlYWN0aXZhdGVFbGVtZW50cygpIHsKICAgIGZvcih2YXIga2V5IGluIGFjdGl2ZUVsZW1lbnRzKSB7CiAgICAgIGlmKGFjdGl2ZUVsZW1lbnRzW2tleV0pIHsKICAgICAgICBhY3RpdmVFbGVtZW50c1trZXldLmNsYXNzTGlzdC5yZW1vdmUoQUNUSVZBVEVEX0NMQVNTKTsKICAgICAgICBkZWxldGUgYWN0aXZlRWxlbWVudHNba2V5XTsKICAgICAgfQogICAgfQogIH0KCn0pKGRvY3VtZW50LCBpb25pYyk7CgooZnVuY3Rpb24oaW9uaWMpIHsKCiAgLyogZm9yIG5leHRVaWQoKSBmdW5jdGlvbiBiZWxvdyAqLwogIHZhciB1aWQgPSBbJzAnLCcwJywnMCddOwoKICAvKioKICAgKiBWYXJpb3VzIHV0aWxpdGllcyB1c2VkIHRocm91Z2hvdXQgSW9uaWMKICAgKgogICAqIFNvbWUgb2YgdGhlc2UgYXJlIGFkb3B0ZWQgZnJvbSB1bmRlcnNjb3JlLmpzIGFuZCBiYWNrYm9uZS5qcywgYm90aCBhbHNvIE1JVCBsaWNlbnNlZC4KICAgKi8KICBpb25pYy5VdGlscyA9IHsKCiAgICBhcnJheU1vdmU6IGZ1bmN0aW9uIChhcnIsIG9sZF9pbmRleCwgbmV3X2luZGV4KSB7CiAgICAgIGlmIChuZXdfaW5kZXggPj0gYXJyLmxlbmd0aCkgewogICAgICAgIHZhciBrID0gbmV3X2luZGV4IC0gYXJyLmxlbmd0aDsKICAgICAgICB3aGlsZSAoKGstLSkgKyAxKSB7CiAgICAgICAgICBhcnIucHVzaCh1bmRlZmluZWQpOwogICAgICAgIH0KICAgICAgfQogICAgICBhcnIuc3BsaWNlKG5ld19pbmRleCwgMCwgYXJyLnNwbGljZShvbGRfaW5kZXgsIDEpWzBdKTsKICAgICAgcmV0dXJuIGFycjsKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGdpdmVuIGNvbnRleHQKICAgICAqLwogICAgcHJveHk6IGZ1bmN0aW9uKGZ1bmMsIGNvbnRleHQpIHsKICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAqIE9ubHkgY2FsbCBhIGZ1bmN0aW9uIG9uY2UgaW4gdGhlIGdpdmVuIGludGVydmFsLgogICAgICoKICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0gdGhlIGZ1bmN0aW9uIHRvIGNhbGwKICAgICAqIEBwYXJhbSB3YWl0IHtpbnR9IGhvdyBsb25nIHRvIHdhaXQgYmVmb3JlL2FmdGVyIHRvIGFsbG93IGZ1bmN0aW9uIGNhbGxzCiAgICAgKiBAcGFyYW0gaW1tZWRpYXRlIHtib29sZWFufSB3aGV0aGVyIHRvIGNhbGwgaW1tZWRpYXRlbHkgb3IgYWZ0ZXIgdGhlIHdhaXQgaW50ZXJ2YWwKICAgICAqLwogICAgIGRlYm91bmNlOiBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgICAgdmFyIHRpbWVvdXQsIGFyZ3MsIGNvbnRleHQsIHRpbWVzdGFtcCwgcmVzdWx0OwogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpOwogICAgICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGxhc3QgPSAobmV3IERhdGUoKSkgLSB0aW1lc3RhbXA7CiAgICAgICAgICBpZiAobGFzdCA8IHdhaXQpIHsKICAgICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQgLSBsYXN0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICBpZiAoIWltbWVkaWF0ZSkgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICAgIGlmICghdGltZW91dCkgewogICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICAgIH0KICAgICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAqIFRocm90dGxlIHRoZSBnaXZlbiBmdW4sIG9ubHkgYWxsb3dpbmcgaXQgdG8gYmUKICAgICAqIGNhbGxlZCBhdCBtb3N0IGV2ZXJ5IGB3YWl0YCBtcy4KICAgICAqLwogICAgdGhyb3R0bGU6IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKICAgICAgdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdDsKICAgICAgdmFyIHRpbWVvdXQgPSBudWxsOwogICAgICB2YXIgcHJldmlvdXMgPSAwOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICBwcmV2aW91cyA9IG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UgPyAwIDogRGF0ZS5ub3coKTsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgaWYgKCFwcmV2aW91cyAmJiBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlKSBwcmV2aW91cyA9IG5vdzsKICAgICAgICB2YXIgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7CiAgICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgcHJldmlvdXMgPSBub3c7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQgJiYgb3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfSwKICAgICAvLyBCb3Jyb3dlZCBmcm9tIEJhY2tib25lLmpzJ3MgZXh0ZW5kCiAgICAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgICAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAgICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogICAgaW5oZXJpdDogZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgICAgdmFyIHBhcmVudCA9IHRoaXM7CiAgICAgIHZhciBjaGlsZDsKCiAgICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICAgIGlmIChwcm90b1Byb3BzICYmIHByb3RvUHJvcHMuaGFzT3duUHJvcGVydHkoJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CiAgICAgIH0KCiAgICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgICBpb25pYy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgICAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKICAgICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgICAgU3Vycm9nYXRlLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CiAgICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKCiAgICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgICAvLyBpZiBzdXBwbGllZC4KICAgICAgaWYgKHByb3RvUHJvcHMpIGlvbmljLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgICAvLyBsYXRlci4KICAgICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICAgIHJldHVybiBjaGlsZDsKICAgIH0sCgogICAgLy8gRXh0ZW5kIGFkYXB0ZWQgZnJvbSBVbmRlcnNjb3JlLmpzCiAgICBleHRlbmQ6IGZ1bmN0aW9uKG9iaikgewogICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgdmFyIHNvdXJjZSA9IGFyZ3NbaV07CiAgICAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgICAgIH0KICAgICAgICAgfQogICAgICAgfQogICAgICAgcmV0dXJuIG9iajsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBIGNvbnNpc3RlbnQgd2F5IG9mIGNyZWF0aW5nIHVuaXF1ZSBJRHMgaW4gYW5ndWxhci4gVGhlIElEIGlzIGEgc2VxdWVuY2Ugb2YgYWxwaGEgbnVtZXJpYwogICAgICogY2hhcmFjdGVycyBzdWNoIGFzICcwMTJBQkMnLiBUaGUgcmVhc29uIHdoeSB3ZSBhcmUgbm90IHVzaW5nIHNpbXBseSBhIG51bWJlciBjb3VudGVyIGlzIHRoYXQKICAgICAqIHRoZSBudW1iZXIgc3RyaW5nIGdldHMgbG9uZ2VyIG92ZXIgdGltZSwgYW5kIGl0IGNhbiBhbHNvIG92ZXJmbG93LCB3aGVyZSBhcyB0aGUgbmV4dElkCiAgICAgKiB3aWxsIGdyb3cgbXVjaCBzbG93ZXIsIGl0IGlzIGEgc3RyaW5nLCBhbmQgaXQgd2lsbCBuZXZlciBvdmVyZmxvdy4KICAgICAqCiAgICAgKiBAcmV0dXJucyBhbiB1bmlxdWUgYWxwaGEtbnVtZXJpYyBzdHJpbmcKICAgICAqLwogICAgbmV4dFVpZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICAgIHZhciBkaWdpdDsKCiAgICAgIHdoaWxlKGluZGV4KSB7CiAgICAgICAgaW5kZXgtLTsKICAgICAgICBkaWdpdCA9IHVpZFtpbmRleF0uY2hhckNvZGVBdCgwKTsKICAgICAgICBpZiAoZGlnaXQgPT0gNTcgLyonOScqLykgewogICAgICAgICAgdWlkW2luZGV4XSA9ICdBJzsKICAgICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICAgICAgfQogICAgICAgIGlmIChkaWdpdCA9PSA5MCAgLyonWicqLykgewogICAgICAgICAgdWlkW2luZGV4XSA9ICcwJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdWlkW2luZGV4XSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZGlnaXQgKyAxKTsKICAgICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHVpZC51bnNoaWZ0KCcwJyk7CiAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CiAgfTsKCiAgLy8gQmluZCBhIGZldyBvZiB0aGUgbW9zdCB1c2VmdWwgZnVuY3Rpb25zIHRvIHRoZSBpb25pYyBzY29wZQogIGlvbmljLmluaGVyaXQgPSBpb25pYy5VdGlscy5pbmhlcml0OwogIGlvbmljLmV4dGVuZCA9IGlvbmljLlV0aWxzLmV4dGVuZDsKICBpb25pYy50aHJvdHRsZSA9IGlvbmljLlV0aWxzLnRocm90dGxlOwogIGlvbmljLnByb3h5ID0gaW9uaWMuVXRpbHMucHJveHk7CiAgaW9uaWMuZGVib3VuY2UgPSBpb25pYy5VdGlscy5kZWJvdW5jZTsKCn0pKHdpbmRvdy5pb25pYyk7CgovKioKICogQG5nZG9jIHBhZ2UKICogQG5hbWUga2V5Ym9hcmQKICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24KICogT24gYm90aCBBbmRyb2lkIGFuZCBpT1MsIElvbmljIHdpbGwgYXR0ZW1wdCB0byBwcmV2ZW50IHRoZSBrZXlib2FyZCBmcm9tCiAqIG9ic2N1cmluZyBpbnB1dHMgYW5kIGZvY3VzYWJsZSBlbGVtZW50cyB3aGVuIGl0IGFwcGVhcnMgYnkgc2Nyb2xsaW5nIHRoZW0KICogaW50byB2aWV3LiAgSW4gb3JkZXIgZm9yIHRoaXMgdG8gd29yaywgYW55IGZvY3VzYWJsZSBlbGVtZW50cyBtdXN0IGJlIHdpdGhpbgogKiBhIFtTY3JvbGwgVmlld10oaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS9kb2NzL2FwaS9kaXJlY3RpdmUvaW9uU2Nyb2xsLykKICogb3IgYSBkaXJlY3RpdmUgc3VjaCBhcyBbQ29udGVudF0oaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS9kb2NzL2FwaS9kaXJlY3RpdmUvaW9uQ29udGVudC8pCiAqIHRoYXQgaGFzIGEgU2Nyb2xsIFZpZXcuCiAqCiAqIEl0IHdpbGwgYWxzbyBhdHRlbXB0IHRvIHByZXZlbnQgdGhlIG5hdGl2ZSBvdmVyZmxvdyBzY3JvbGxpbmcgb24gZm9jdXMsCiAqIHdoaWNoIGNhbiBjYXVzZSBsYXlvdXQgaXNzdWVzIHN1Y2ggYXMgcHVzaGluZyBoZWFkZXJzIHVwIGFuZCBvdXQgb2Ygdmlldy4KICoKICogVGhlIGtleWJvYXJkIGZpeGVzIHdvcmsgYmVzdCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZQogKiBbSW9uaWMgS2V5Ym9hcmQgUGx1Z2luXShodHRwczovL2dpdGh1Yi5jb20vZHJpZnR5Y28vaW9uaWMtcGx1Z2lucy1rZXlib2FyZCksCiAqIGFsdGhvdWdoIGl0IHdpbGwgcGVyZm9ybSByZWFzb25hYmx5IHdlbGwgd2l0aG91dC4gIEhvd2V2ZXIsIGlmIHlvdSBhcmUgdXNpbmcKICogQ29yZG92YSB0aGVyZSBpcyBubyByZWFzb24gbm90IHRvIHVzZSB0aGUgcGx1Z2luLgogKgogKiAjIyMgSGlkZSB3aGVuIGtleWJvYXJkIHNob3dzCiAqCiAqIFRvIGhpZGUgYW4gZWxlbWVudCB3aGVuIHRoZSBrZXlib2FyZCBpcyBvcGVuLCBhZGQgdGhlIGNsYXNzIGBoaWRlLW9uLWtleWJvYXJkLW9wZW5gLgogKgogKiBgYGBodG1sCiAqIDxkaXYgY2xhc3M9ImhpZGUtb24ta2V5Ym9hcmQtb3BlbiI+CiAqICAgPGRpdiBpZD0iZ29vZ2xlLW1hcCI+PC9kaXY+CiAqIDwvZGl2PgogKiBgYGAKICogLS0tLS0tLS0tLQogKgogKiAjIyMgUGx1Z2luIFVzYWdlCiAqIEluZm9ybWF0aW9uIG9uIHVzaW5nIHRoZSBwbHVnaW4gY2FuIGJlIGZvdW5kIGF0CiAqIFtodHRwczovL2dpdGh1Yi5jb20vZHJpZnR5Y28vaW9uaWMtcGx1Z2lucy1rZXlib2FyZF0oaHR0cHM6Ly9naXRodWIuY29tL2RyaWZ0eWNvL2lvbmljLXBsdWdpbnMta2V5Ym9hcmQpLgogKgogKiAtLS0tLS0tLS0tCiAqCiAqICMjIyBBbmRyb2lkIE5vdGVzCiAqIC0gSWYgeW91ciBhcHAgaXMgcnVubmluZyBpbiBmdWxsc2NyZWVuLCBpLmUuIHlvdSBoYXZlCiAqICAgYDxwcmVmZXJlbmNlIG5hbWU9IkZ1bGxzY3JlZW4iIHZhbHVlPSJ0cnVlIiAvPmAgaW4geW91ciBgY29uZmlnLnhtbGAgZmlsZQogKiAgIHlvdSB3aWxsIG5lZWQgdG8gc2V0IGBpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4gPSB0cnVlYCBtYW51YWxseS4KICoKICogLSBZb3UgY2FuIGNvbmZpZ3VyZSB0aGUgYmVoYXZpb3Igb2YgdGhlIHdlYiB2aWV3IHdoZW4gdGhlIGtleWJvYXJkIHNob3dzIGJ5IHNldHRpbmcKICogICBbYW5kcm9pZDp3aW5kb3dTb2Z0SW5wdXRNb2RlXShodHRwOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3JlZmVyZW5jZS9hbmRyb2lkL1IuYXR0ci5odG1sI3dpbmRvd1NvZnRJbnB1dE1vZGUpCiAqICAgdG8gZWl0aGVyIGBhZGp1c3RQYW5gLCBgYWRqdXN0UmVzaXplYCBvciBgYWRqdXN0Tm90aGluZ2AgaW4geW91ciBhcHAncwogKiAgIGFjdGl2aXR5IGluIGBBbmRyb2lkTWFuaWZlc3QueG1sYC4gYGFkanVzdFJlc2l6ZWAgaXMgdGhlIHJlY29tbWVuZGVkIHNldHRpbmcKICogICBmb3IgSW9uaWMsIGJ1dCBpZiBmb3Igc29tZSByZWFzb24geW91IGRvIHVzZSBgYWRqdXN0UGFuYCB5b3Ugd2lsbCBuZWVkIHRvCiAqICAgc2V0IGBpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4gPSB0cnVlYC4KICoKICogICBgYGB4bWwKICogICA8YWN0aXZpdHkgYW5kcm9pZDp3aW5kb3dTb2Z0SW5wdXRNb2RlPSJhZGp1c3RSZXNpemUiPgogKgogKiAgIGBgYAogKgogKiAjIyMgaU9TIE5vdGVzCiAqIC0gSWYgdGhlIGNvbnRlbnQgb2YgeW91ciBhcHAgKGluY2x1ZGluZyB0aGUgaGVhZGVyKSBpcyBiZWluZyBwdXNoZWQgdXAgYW5kCiAqICAgb3V0IG9mIHZpZXcgb24gaW5wdXQgZm9jdXMsIHRyeSBzZXR0aW5nIGBjb3Jkb3ZhLnBsdWdpbnMuS2V5Ym9hcmQuZGlzYWJsZVNjcm9sbCh0cnVlKWAuCiAqICAgVGhpcyBkb2VzICoqbm90KiogZGlzYWJsZSBzY3JvbGxpbmcgaW4gdGhlIElvbmljIHNjcm9sbCB2aWV3LCByYXRoZXIgaXQKICogICBkaXNhYmxlcyB0aGUgbmF0aXZlIG92ZXJmbG93IHNjcm9sbGluZyB0aGF0IGhhcHBlbnMgYXV0b21hdGljYWxseSBhcyBhCiAqICAgcmVzdWx0IG9mIGZvY3VzaW5nIG9uIGlucHV0cyBiZWxvdyB0aGUga2V5Ym9hcmQuCiAqCiAqLwoKdmFyIGtleWJvYXJkVmlld3BvcnRIZWlnaHQgPSBnZXRWaWV3cG9ydEhlaWdodCgpOwp2YXIga2V5Ym9hcmRJc09wZW47CnZhciBrZXlib2FyZEFjdGl2ZUVsZW1lbnQ7CnZhciBrZXlib2FyZEZvY3VzT3V0VGltZXI7CnZhciBrZXlib2FyZEZvY3VzSW5UaW1lcjsKdmFyIGtleWJvYXJkTGFzdFNob3cgPSAwOwoKdmFyIEtFWUJPQVJEX09QRU5fQ1NTID0gJ2tleWJvYXJkLW9wZW4nOwp2YXIgU0NST0xMX0NPTlRBSU5FUl9DU1MgPSAnc2Nyb2xsJzsKCmlvbmljLmtleWJvYXJkID0gewogIGlzT3BlbjogZmFsc2UsCiAgaGVpZ2h0OiBudWxsLAogIGxhbmRzY2FwZTogZmFsc2UsCn07CgpmdW5jdGlvbiBrZXlib2FyZEluaXQoKSB7CiAgaWYoIGtleWJvYXJkSGFzUGx1Z2luKCkgKSB7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbmF0aXZlLmtleWJvYXJkc2hvdycsIGtleWJvYXJkTmF0aXZlU2hvdyk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbmF0aXZlLmtleWJvYXJkaGlkZScsIGtleWJvYXJkRm9jdXNPdXQpOwoKICAgIC8vZGVwcmVjYXRlZAogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ25hdGl2ZS5zaG93a2V5Ym9hcmQnLCBrZXlib2FyZE5hdGl2ZVNob3cpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ25hdGl2ZS5oaWRla2V5Ym9hcmQnLCBrZXlib2FyZEZvY3VzT3V0KTsKCiAgfSBlbHNlIHsKICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXNvdXQnLCBrZXlib2FyZEZvY3VzT3V0KTsKICB9CgogIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcignaW9uaWMuZm9jdXNpbicsIGtleWJvYXJkQnJvd3NlckZvY3VzSW4pOwogIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXNpbicsIGtleWJvYXJkQnJvd3NlckZvY3VzSW4pOwoKICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywga2V5Ym9hcmRPcmllbnRhdGlvbkNoYW5nZSk7CgogIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQpIHsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlckRvd24iLCBrZXlib2FyZEluaXQpOwogIH0gZWxzZSB7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywga2V5Ym9hcmRJbml0KTsKICB9Cn0KCmZ1bmN0aW9uIGtleWJvYXJkTmF0aXZlU2hvdyhlKSB7CiAgY2xlYXJUaW1lb3V0KGtleWJvYXJkRm9jdXNPdXRUaW1lcik7CiAgaW9uaWMua2V5Ym9hcmQuaGVpZ2h0ID0gZS5rZXlib2FyZEhlaWdodDsKfQoKZnVuY3Rpb24ga2V5Ym9hcmRCcm93c2VyRm9jdXNJbihlKSB7CiAgaWYoICFlLnRhcmdldCB8fCAhaW9uaWMudGFwLmlzVGV4dElucHV0KGUudGFyZ2V0KSB8fCBpb25pYy50YXAuaXNEYXRlSW5wdXQoZS50YXJnZXQpIHx8ICFrZXlib2FyZElzV2l0aGluU2Nyb2xsKGUudGFyZ2V0KSApIHJldHVybjsKCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGtleWJvYXJkT25LZXlEb3duLCBmYWxzZSk7CgogIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wID0gMDsKICBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoJy5zY3JvbGwtY29udGVudCcpLnNjcm9sbFRvcCA9IDA7CgogIGtleWJvYXJkQWN0aXZlRWxlbWVudCA9IGUudGFyZ2V0OwoKICBrZXlib2FyZFNldFNob3coZSk7Cn0KCmZ1bmN0aW9uIGtleWJvYXJkU2V0U2hvdyhlKSB7CiAgY2xlYXJUaW1lb3V0KGtleWJvYXJkRm9jdXNJblRpbWVyKTsKICBjbGVhclRpbWVvdXQoa2V5Ym9hcmRGb2N1c091dFRpbWVyKTsKCiAga2V5Ym9hcmRGb2N1c0luVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICBpZiAoIGtleWJvYXJkTGFzdFNob3cgKyAzNTAgPiBEYXRlLm5vdygpICkgcmV0dXJuOwogICAga2V5Ym9hcmRMYXN0U2hvdyA9IERhdGUubm93KCk7CiAgICB2YXIga2V5Ym9hcmRIZWlnaHQ7CiAgICB2YXIgZWxlbWVudEJvdW5kcyA9IGtleWJvYXJkQWN0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHZhciBjb3VudCA9IDA7CgogICAgdmFyIHBvbGxLZXlib2FyZEhlaWdodCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCl7CgogICAgICBrZXlib2FyZEhlaWdodCA9IGtleWJvYXJkR2V0SGVpZ2h0KCk7CiAgICAgIGlmIChjb3VudCA+IDEwKXsKICAgICAgICBjbGVhckludGVydmFsKHBvbGxLZXlib2FyZEhlaWdodCk7CiAgICAgICAgLy93YWl0ZWQgbG9uZyBlbm91Z2gsIGp1c3QgZ3Vlc3MKICAgICAgICBrZXlib2FyZEhlaWdodCA9IDI3NTsKICAgICAgfQogICAgICBpZiAoa2V5Ym9hcmRIZWlnaHQpewogICAgICAgIGtleWJvYXJkU2hvdyhlLnRhcmdldCwgZWxlbWVudEJvdW5kcy50b3AsIGVsZW1lbnRCb3VuZHMuYm90dG9tLCBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0LCBrZXlib2FyZEhlaWdodCk7CiAgICAgICAgY2xlYXJJbnRlcnZhbChwb2xsS2V5Ym9hcmRIZWlnaHQpOwogICAgICB9CiAgICAgIGNvdW50Kys7CgogICAgfSwgMTAwKTsKICB9LCAzMik7Cn0KCmZ1bmN0aW9uIGtleWJvYXJkU2hvdyhlbGVtZW50LCBlbGVtZW50VG9wLCBlbGVtZW50Qm90dG9tLCB2aWV3cG9ydEhlaWdodCwga2V5Ym9hcmRIZWlnaHQpIHsKICB2YXIgZGV0YWlscyA9IHsKICAgIHRhcmdldDogZWxlbWVudCwKICAgIGVsZW1lbnRUb3A6IE1hdGgucm91bmQoZWxlbWVudFRvcCksCiAgICBlbGVtZW50Qm90dG9tOiBNYXRoLnJvdW5kKGVsZW1lbnRCb3R0b20pLAogICAga2V5Ym9hcmRIZWlnaHQ6IGtleWJvYXJkSGVpZ2h0LAogICAgdmlld3BvcnRIZWlnaHQ6IHZpZXdwb3J0SGVpZ2h0CiAgfTsKCiAgZGV0YWlscy5oYXNQbHVnaW4gPSBrZXlib2FyZEhhc1BsdWdpbigpOwoKICBkZXRhaWxzLmNvbnRlbnRIZWlnaHQgPSB2aWV3cG9ydEhlaWdodCAtIGtleWJvYXJkSGVpZ2h0OwoKICB2b2lkIDA7CgogIC8vIGZpZ3VyZSBvdXQgaWYgdGhlIGVsZW1lbnQgaXMgdW5kZXIgdGhlIGtleWJvYXJkCiAgZGV0YWlscy5pc0VsZW1lbnRVbmRlcktleWJvYXJkID0gKGRldGFpbHMuZWxlbWVudEJvdHRvbSA+IGRldGFpbHMuY29udGVudEhlaWdodCk7CgogIGlvbmljLmtleWJvYXJkLmlzT3BlbiA9IHRydWU7CgogIC8vIHNlbmQgZXZlbnQgc28gdGhlIHNjcm9sbCB2aWV3IGFkanVzdHMKICBrZXlib2FyZEFjdGl2ZUVsZW1lbnQgPSBlbGVtZW50OwogIGlvbmljLnRyaWdnZXIoJ3Njcm9sbENoaWxkSW50b1ZpZXcnLCBkZXRhaWxzLCB0cnVlKTsKCiAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoS0VZQk9BUkRfT1BFTl9DU1MpOwogIH0pOwoKICAvLyBhbnkgc2hvd2luZyBwYXJ0IG9mIHRoZSBkb2N1bWVudCB0aGF0IGlzbid0IHdpdGhpbiB0aGUgc2Nyb2xsIHRoZSB1c2VyCiAgLy8gY291bGQgdG91Y2htb3ZlIGFuZCBjYXVzZSBzb21lIHVnbHkgY2hhbmdlcyB0byB0aGUgYXBwLCBzbyBkaXNhYmxlCiAgLy8gYW55IHRvdWNobW92ZSBldmVudHMgd2hpbGUgdGhlIGtleWJvYXJkIGlzIG9wZW4gdXNpbmcgZS5wcmV2ZW50RGVmYXVsdCgpCiAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgewogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyTW92ZSIsIGtleWJvYXJkUHJldmVudERlZmF1bHQsIGZhbHNlKTsKICB9IGVsc2UgewogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywga2V5Ym9hcmRQcmV2ZW50RGVmYXVsdCwgZmFsc2UpOwogIH0KCiAgcmV0dXJuIGRldGFpbHM7Cn0KCmZ1bmN0aW9uIGtleWJvYXJkRm9jdXNPdXQoZSkgewogIGNsZWFyVGltZW91dChrZXlib2FyZEZvY3VzT3V0VGltZXIpOwoKICBrZXlib2FyZEZvY3VzT3V0VGltZXIgPSBzZXRUaW1lb3V0KGtleWJvYXJkSGlkZSwgMzUwKTsKfQoKZnVuY3Rpb24ga2V5Ym9hcmRIaWRlKCkgewogIHZvaWQgMDsKICBpb25pYy5rZXlib2FyZC5pc09wZW4gPSBmYWxzZTsKCiAgaW9uaWMudHJpZ2dlcigncmVzZXRTY3JvbGxWaWV3JywgewogICAgdGFyZ2V0OiBrZXlib2FyZEFjdGl2ZUVsZW1lbnQKICB9LCB0cnVlKTsKCiAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoS0VZQk9BUkRfT1BFTl9DU1MpOwogIH0pOwoKICAvLyB0aGUga2V5Ym9hcmQgaXMgZ29uZSBub3csIHJlbW92ZSB0aGUgdG91Y2htb3ZlIHRoYXQgZGlzYWJsZXMgbmF0aXZlIHNjcm9sbAogIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQpIHsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlck1vdmUiLCBrZXlib2FyZFByZXZlbnREZWZhdWx0KTsKICB9IGVsc2UgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywga2V5Ym9hcmRQcmV2ZW50RGVmYXVsdCk7CiAgfQogIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBrZXlib2FyZE9uS2V5RG93bik7Cn0KCmZ1bmN0aW9uIGtleWJvYXJkVXBkYXRlVmlld3BvcnRIZWlnaHQoKSB7CiAgaWYoIGdldFZpZXdwb3J0SGVpZ2h0KCkgPiBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0ICkgewogICAga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCA9IGdldFZpZXdwb3J0SGVpZ2h0KCk7CiAgfQp9CgpmdW5jdGlvbiBrZXlib2FyZE9uS2V5RG93bihlKSB7CiAgaWYoIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyApIHsKICAgIGtleWJvYXJkUHJldmVudERlZmF1bHQoZSk7CiAgfQp9CgpmdW5jdGlvbiBrZXlib2FyZFByZXZlbnREZWZhdWx0KGUpIHsKICBpZiggZS50YXJnZXQudGFnTmFtZSAhPT0gJ1RFWFRBUkVBJyApIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICB9Cn0KCmZ1bmN0aW9uIGtleWJvYXJkT3JpZW50YXRpb25DaGFuZ2UoKSB7CiAgdmFyIHVwZGF0ZWRWaWV3cG9ydEhlaWdodCA9IGdldFZpZXdwb3J0SGVpZ2h0KCk7CgogIC8vdG9vIHNsb3csIGhhdmUgdG8gd2FpdCBmb3IgdXBkYXRlZCBoZWlnaHQKICBpZiAodXBkYXRlZFZpZXdwb3J0SGVpZ2h0ID09PSBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0KXsKICAgIHZhciBjb3VudCA9IDA7CiAgICB2YXIgcG9sbFZpZXdwb3J0SGVpZ2h0ID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKICAgICAgLy9naXZlIHVwCiAgICAgIGlmIChjb3VudCA+IDEwKXsKICAgICAgICBjbGVhckludGVydmFsKHBvbGxWaWV3cG9ydEhlaWdodCk7CiAgICAgIH0KCiAgICAgIHVwZGF0ZWRWaWV3cG9ydEhlaWdodCA9IGdldFZpZXdwb3J0SGVpZ2h0KCk7CgogICAgICBpZiAodXBkYXRlZFZpZXdwb3J0SGVpZ2h0ICE9PSBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0KXsKICAgICAgICBpZiAodXBkYXRlZFZpZXdwb3J0SGVpZ2h0IDwga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCl7CiAgICAgICAgICBpb25pYy5rZXlib2FyZC5sYW5kc2NhcGUgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpb25pYy5rZXlib2FyZC5sYW5kc2NhcGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCA9IHVwZGF0ZWRWaWV3cG9ydEhlaWdodDsKICAgICAgICBjbGVhckludGVydmFsKHBvbGxWaWV3cG9ydEhlaWdodCk7CiAgICAgIH0KICAgICAgY291bnQrKzsKCiAgICB9LCA1MCk7CiAgfSBlbHNlIHsKICAgIGtleWJvYXJkVmlld3BvcnRIZWlnaHQgPSB1cGRhdGVkVmlld3BvcnRIZWlnaHQ7CiAgfQp9CgpmdW5jdGlvbiBrZXlib2FyZEdldEhlaWdodCgpIHsKICAvLyBjaGVjayBpZiB3ZSBhcmUgYWxyZWFkeSBoYXZlIGEga2V5Ym9hcmQgaGVpZ2h0IGZyb20gdGhlIHBsdWdpbgogIGlmICggaW9uaWMua2V5Ym9hcmQuaGVpZ2h0ICkgewogICAgcmV0dXJuIGlvbmljLmtleWJvYXJkLmhlaWdodDsKICB9CgogIGlmICggaW9uaWMuUGxhdGZvcm0uaXNBbmRyb2lkKCkgKXsKICAgIC8vc2hvdWxkIGJlIHVzaW5nIHRoZSBwbHVnaW4sIG5vIHdheSB0byBrbm93IGhvdyBiaWcgdGhlIGtleWJvYXJkIGlzLCBzbyBndWVzcwogICAgaWYgKCBpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4gKXsKICAgICAgcmV0dXJuIDI3NTsKICAgIH0KICAgIC8vb3RoZXJ3aXNlLCB3YWl0IGZvciB0aGUgc2NyZWVuIHRvIHJlc2l6ZQogICAgaWYgKCBnZXRWaWV3cG9ydEhlaWdodCgpIDwga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCApewogICAgICByZXR1cm4ga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCAtIGdldFZpZXdwb3J0SGVpZ2h0KCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gMDsKICAgIH0KICB9CgogIC8vIGZhbGxiYWNrIGZvciB3aGVuIGl0cyB0aGUgd2VidmlldyB3aXRob3V0IHRoZSBwbHVnaW4KICAvLyBvciBmb3IganVzdCB0aGUgc3RhbmRhcmQgd2ViIGJyb3dzZXIKICBpZiggaW9uaWMuUGxhdGZvcm0uaXNJT1MoKSApIHsKICAgIGlmICggaW9uaWMua2V5Ym9hcmQubGFuZHNjYXBlICl7CiAgICAgIHJldHVybiAyMDY7CiAgICB9CgogICAgaWYgKCFpb25pYy5QbGF0Zm9ybS5pc1dlYlZpZXcoKSl7CiAgICAgIHJldHVybiAyMTY7CiAgICB9CgogICAgcmV0dXJuIDI2MDsKICB9CgogIC8vIHNhZmUgZ3Vlc3MKICByZXR1cm4gMjc1Owp9CgpmdW5jdGlvbiBnZXRWaWV3cG9ydEhlaWdodCgpIHsKICByZXR1cm4gd2luZG93LmlubmVySGVpZ2h0IHx8IHNjcmVlbi5oZWlnaHQ7Cn0KCmZ1bmN0aW9uIGtleWJvYXJkSXNXaXRoaW5TY3JvbGwoZWxlKSB7CiAgd2hpbGUoZWxlKSB7CiAgICBpZihlbGUuY2xhc3NMaXN0LmNvbnRhaW5zKFNDUk9MTF9DT05UQUlORVJfQ1NTKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGVsZSA9IGVsZS5wYXJlbnRFbGVtZW50OwogIH0KICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGtleWJvYXJkSGFzUGx1Z2luKCkgewogIHJldHVybiAhISh3aW5kb3cuY29yZG92YSAmJiBjb3Jkb3ZhLnBsdWdpbnMgJiYgY29yZG92YS5wbHVnaW5zLktleWJvYXJkKTsKfQoKaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAga2V5Ym9hcmRVcGRhdGVWaWV3cG9ydEhlaWdodCgpOwoKICAvLyBBbmRyb2lkIHNvbWV0aW1lcyByZXBvcnRzIGJhZCBpbm5lckhlaWdodCBvbiB3aW5kb3cubG9hZAogIC8vIHRyeSBpdCBhZ2FpbiBpbiBhIGxpbCBiaXQgdG8gcGxheSBpdCBzYWZlCiAgc2V0VGltZW91dChrZXlib2FyZFVwZGF0ZVZpZXdwb3J0SGVpZ2h0LCA5OTkpOwoKICAvLyBvbmx5IGluaXRpYWxpemUgdGhlIGFkanVzdG1lbnRzIGZvciB0aGUgdmlydHVhbCBrZXlib2FyZAogIC8vIGlmIGEgdG91Y2hzdGFydCBldmVudCBoYXBwZW5zCiAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgewogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyRG93biIsIGtleWJvYXJkSW5pdCwgZmFsc2UpOwogIH0gZWxzZSB7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywga2V5Ym9hcmRJbml0LCBmYWxzZSk7CiAgfQp9KTsKCgoKdmFyIHZpZXdwb3J0VGFnOwp2YXIgdmlld3BvcnRQcm9wZXJ0aWVzID0ge307Cgppb25pYy52aWV3cG9ydCA9IHsKICBvcmllbnRhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAvLyAwID0gUG9ydHJhaXQKICAgIC8vIDkwID0gTGFuZHNjYXBlCiAgICAvLyBub3QgdXNpbmcgd2luZG93Lm9yaWVudGF0aW9uIGJlY2F1c2UgZWFjaCBkZXZpY2UgaGFzIGEgZGlmZmVyZW50IGltcGxlbWVudGF0aW9uCiAgICByZXR1cm4gKHdpbmRvdy5pbm5lcldpZHRoID4gd2luZG93LmlubmVySGVpZ2h0ID8gOTAgOiAwKTsKICB9Cn07CgpmdW5jdGlvbiB2aWV3cG9ydExvYWRUYWcoKSB7CiAgdmFyIHg7CgogIGZvcih4PTA7IHg8ZG9jdW1lbnQuaGVhZC5jaGlsZHJlbi5sZW5ndGg7IHgrKykgewogICAgaWYoZG9jdW1lbnQuaGVhZC5jaGlsZHJlblt4XS5uYW1lID09ICd2aWV3cG9ydCcpIHsKICAgICAgdmlld3BvcnRUYWcgPSBkb2N1bWVudC5oZWFkLmNoaWxkcmVuW3hdOwogICAgICBicmVhazsKICAgIH0KICB9CgogIGlmKHZpZXdwb3J0VGFnKSB7CiAgICB2YXIgcHJvcHMgPSB2aWV3cG9ydFRhZy5jb250ZW50LnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMrL2csICcnKS5zcGxpdCgnLCcpOwogICAgdmFyIGtleVZhbHVlOwogICAgZm9yKHg9MDsgeDxwcm9wcy5sZW5ndGg7IHgrKykgewogICAgICBpZihwcm9wc1t4XSkgewogICAgICAgIGtleVZhbHVlID0gcHJvcHNbeF0uc3BsaXQoJz0nKTsKICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXNbIGtleVZhbHVlWzBdIF0gPSAoa2V5VmFsdWUubGVuZ3RoID4gMSA/IGtleVZhbHVlWzFdIDogJ18nKTsKICAgICAgfQogICAgfQogICAgdmlld3BvcnRVcGRhdGUoKTsKICB9Cn0KCmZ1bmN0aW9uIHZpZXdwb3J0VXBkYXRlKCkgewogIC8vIHVuaXQgdGVzdHMgaW4gdmlld3BvcnQudW5pdC5qcwoKICB2YXIgaW5pdFdpZHRoID0gdmlld3BvcnRQcm9wZXJ0aWVzLndpZHRoOwogIHZhciBpbml0SGVpZ2h0ID0gdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodDsKICB2YXIgcCA9IGlvbmljLlBsYXRmb3JtOwogIHZhciB2ZXJzaW9uID0gcC52ZXJzaW9uKCk7CiAgdmFyIERFVklDRV9XSURUSCA9ICdkZXZpY2Utd2lkdGgnOwogIHZhciBERVZJQ0VfSEVJR0hUID0gJ2RldmljZS1oZWlnaHQnOwogIHZhciBvcmllbnRhdGlvbiA9IGlvbmljLnZpZXdwb3J0Lm9yaWVudGF0aW9uKCk7CgogIC8vIE1vc3QgdGltZXMgd2UncmUgcmVtb3ZpbmcgdGhlIGhlaWdodCBhbmQgYWRkaW5nIHRoZSB3aWR0aAogIC8vIFNvIHRoaXMgaXMgdGhlIGRlZmF1bHQgdG8gc3RhcnQgd2l0aCwgdGhlbiBtb2RpZnkgcGVyIHBsYXRmb3JtL3ZlcnNpb24vb3JlaW50YXRpb24KICBkZWxldGUgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodDsKICB2aWV3cG9ydFByb3BlcnRpZXMud2lkdGggPSBERVZJQ0VfV0lEVEg7CgogIGlmKCBwLmlzSVBhZCgpICkgewogICAgLy8gaVBhZAoKICAgIGlmKCB2ZXJzaW9uID4gNyApIHsKICAgICAgLy8gaVBhZCA+PSA3LjEKICAgICAgLy8gaHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9DQi00MzIzCiAgICAgIGRlbGV0ZSB2aWV3cG9ydFByb3BlcnRpZXMud2lkdGg7CgogICAgfSBlbHNlIHsKICAgICAgLy8gaVBhZCA8PSA3LjAKCiAgICAgIGlmKCBwLmlzV2ViVmlldygpICkgewogICAgICAgIC8vIGlQYWQgPD0gNy4wIFdlYlZpZXcKCiAgICAgICAgaWYoIG9yaWVudGF0aW9uID09IDkwICkgewogICAgICAgICAgLy8gaVBhZCA8PSA3LjAgV2ViVmlldyBMYW5kc2NhcGUKICAgICAgICAgIHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQgPSAnMCc7CgogICAgICAgIH0gZWxzZSBpZih2ZXJzaW9uID09IDcpIHsKICAgICAgICAgIC8vIGlQYWQgPD0gNy4wIFdlYlZpZXcgUG9ydGFpdAogICAgICAgICAgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodCA9IERFVklDRV9IRUlHSFQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIGlQYWQgPD0gNi4xIEJyb3dzZXIKICAgICAgICBpZih2ZXJzaW9uIDwgNykgewogICAgICAgICAgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodCA9ICcwJzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgfSBlbHNlIGlmKCBwLmlzSU9TKCkgKSB7CiAgICAvLyBpUGhvbmUKCiAgICBpZiggcC5pc1dlYlZpZXcoKSApIHsKICAgICAgLy8gaVBob25lIFdlYlZpZXcKCiAgICAgIGlmKHZlcnNpb24gPiA3KSB7CiAgICAgICAgLy8gaVBob25lID49IDcuMSBXZWJWaWV3CiAgICAgICAgZGVsZXRlIHZpZXdwb3J0UHJvcGVydGllcy53aWR0aDsKCiAgICAgIH0gZWxzZSBpZih2ZXJzaW9uIDwgNykgewogICAgICAgIC8vIGlQaG9uZSA8PSA2LjEgV2ViVmlldwogICAgICAgIC8vIGlmIGhlaWdodCB3YXMgc2V0IGl0IG5lZWRzIHRvIGdldCByZW1vdmVkIHdpdGggdGhpcyBoYWNrIGZvciA8PSA2LjEKICAgICAgICBpZiggaW5pdEhlaWdodCApIHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQgPSAnMCc7CgogICAgICB9IGVsc2UgaWYodmVyc2lvbiA9PSA3KSB7CiAgICAgICAgLy9pUGhvbmUgPT0gNy4wIFdlYlZpZXcKICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gREVWSUNFX0hFSUdIVDsKICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIC8vIGlQaG9uZSBCcm93c2VyCgogICAgICBpZiAodmVyc2lvbiA8IDcpIHsKICAgICAgICAvLyBpUGhvbmUgPD0gNi4xIEJyb3dzZXIKICAgICAgICAvLyBpZiBoZWlnaHQgd2FzIHNldCBpdCBuZWVkcyB0byBnZXQgcmVtb3ZlZCB3aXRoIHRoaXMgaGFjayBmb3IgPD0gNi4xCiAgICAgICAgaWYoIGluaXRIZWlnaHQgKSB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gJzAnOwogICAgICB9CiAgICB9CgogIH0KCiAgLy8gb25seSB1cGRhdGUgdGhlIHZpZXdwb3J0IHRhZyBpZiB0aGVyZSB3YXMgYSBjaGFuZ2UKICBpZihpbml0V2lkdGggIT09IHZpZXdwb3J0UHJvcGVydGllcy53aWR0aCB8fCBpbml0SGVpZ2h0ICE9PSB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0KSB7CiAgICB2aWV3cG9ydFRhZ1VwZGF0ZSgpOwogIH0KfQoKZnVuY3Rpb24gdmlld3BvcnRUYWdVcGRhdGUoKSB7CiAgdmFyIGtleSwgcHJvcHMgPSBbXTsKICBmb3Ioa2V5IGluIHZpZXdwb3J0UHJvcGVydGllcykgewogICAgaWYoIHZpZXdwb3J0UHJvcGVydGllc1trZXldICkgewogICAgICBwcm9wcy5wdXNoKGtleSArICh2aWV3cG9ydFByb3BlcnRpZXNba2V5XSA9PSAnXycgPyAnJyA6ICc9JyArIHZpZXdwb3J0UHJvcGVydGllc1trZXldKSApOwogICAgfQogIH0KCiAgdmlld3BvcnRUYWcuY29udGVudCA9IHByb3BzLmpvaW4oJywgJyk7Cn0KCmlvbmljLlBsYXRmb3JtLnJlYWR5KGZ1bmN0aW9uKCkgewogIHZpZXdwb3J0TG9hZFRhZygpOwoKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigib3JpZW50YXRpb25jaGFuZ2UiLCBmdW5jdGlvbigpewogICAgc2V0VGltZW91dCh2aWV3cG9ydFVwZGF0ZSwgMTAwMCk7CiAgfSwgZmFsc2UpOwp9KTsKCihmdW5jdGlvbihpb25pYykgewondXNlIHN0cmljdCc7CiAgaW9uaWMudmlld3MuVmlldyA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgaW9uaWMudmlld3MuVmlldy5pbmhlcml0ID0gaW9uaWMuaW5oZXJpdDsKCiAgaW9uaWMuZXh0ZW5kKGlvbmljLnZpZXdzLlZpZXcucHJvdG90eXBlLCB7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHt9CiAgfSk7Cgp9KSh3aW5kb3cuaW9uaWMpOwoKLyoKICogU2Nyb2xsZXIKICogaHR0cDovL2dpdGh1Yi5jb20venluZ2Evc2Nyb2xsZXIKICoKICogQ29weXJpZ2h0IDIwMTEsIFp5bmdhIEluYy4KICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLgogKiBodHRwczovL3Jhdy5naXRodWIuY29tL3p5bmdhL3Njcm9sbGVyL21hc3Rlci9NSVQtTElDRU5TRS50eHQKICoKICogQmFzZWQgb24gdGhlIHdvcmsgb2Y6IFVuaWZ5IFByb2plY3QgKHVuaWZ5LXByb2plY3Qub3JnKQogKiBodHRwOi8vdW5pZnktcHJvamVjdC5vcmcKICogQ29weXJpZ2h0IDIwMTEsIERldXRzY2hlIFRlbGVrb20gQUcKICogTGljZW5zZTogTUlUICsgQXBhY2hlIChWMikKICovCgovKiBqc2hpbnQgZXFudWxsOiB0cnVlICovCgovKioKICogR2VuZXJpYyBhbmltYXRpb24gY2xhc3Mgd2l0aCBzdXBwb3J0IGZvciBkcm9wcGVkIGZyYW1lcyBib3RoIG9wdGlvbmFsIGVhc2luZyBhbmQgZHVyYXRpb24uCiAqCiAqIE9wdGlvbmFsIGR1cmF0aW9uIGlzIHVzZWZ1bCB3aGVuIHRoZSBsaWZldGltZSBpcyBkZWZpbmVkIGJ5IGFub3RoZXIgY29uZGl0aW9uIHRoYW4gdGltZQogKiBlLmcuIHNwZWVkIG9mIGFuIGFuaW1hdGluZyBvYmplY3QsIGV0Yy4KICoKICogRHJvcHBlZCBmcmFtZSBsb2dpYyBhbGxvd3MgdG8ga2VlcCB1c2luZyB0aGUgc2FtZSB1cGRhdGVyIGxvZ2ljIGluZGVwZW5kZW50IGZyb20gdGhlIGFjdHVhbAogKiByZW5kZXJpbmcuIFRoaXMgZWFzZXMgYSBsb3Qgb2YgY2FzZXMgd2hlcmUgaXQgbWlnaHQgYmUgcHJldHR5IGNvbXBsZXggdG8gYnJlYWsgZG93biBhIHN0YXRlCiAqIGJhc2VkIG9uIHRoZSBwdXJlIHRpbWUgZGlmZmVyZW5jZS4KICovCnZhciB6eW5nYUNvcmUgPSB7IGVmZmVjdDoge30gfTsKKGZ1bmN0aW9uKGdsb2JhbCkgewogIHZhciB0aW1lID0gRGF0ZS5ub3cgfHwgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gK25ldyBEYXRlKCk7CiAgfTsKICB2YXIgZGVzaXJlZEZyYW1lcyA9IDYwOwogIHZhciBtaWxsaXNlY29uZHNQZXJTZWNvbmQgPSAxMDAwOwogIHZhciBydW5uaW5nID0ge307CiAgdmFyIGNvdW50ZXIgPSAxOwoKICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUgPSB7CgogICAgLyoqCiAgICAgKiBBIHJlcXVlc3RBbmltYXRpb25GcmFtZSB3cmFwcGVyIC8gcG9seWZpbGwuCiAgICAgKgogICAgICogQHBhcmFtIGNhbGxiYWNrIHtGdW5jdGlvbn0gVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgYmVmb3JlIHRoZSBuZXh0IHJlcGFpbnQuCiAgICAgKiBAcGFyYW0gcm9vdCB7SFRNTEVsZW1lbnR9IFRoZSByb290IGVsZW1lbnQgZm9yIHRoZSByZXBhaW50CiAgICAgKi8KICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZTogKGZ1bmN0aW9uKCkgewoKICAgICAgLy8gQ2hlY2sgZm9yIHJlcXVlc3QgYW5pbWF0aW9uIEZyYW1lIHN1cHBvcnQKICAgICAgdmFyIHJlcXVlc3RGcmFtZSA9IGdsb2JhbC5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgZ2xvYmFsLndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCBnbG9iYWwubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IGdsb2JhbC5vUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwogICAgICB2YXIgaXNOYXRpdmUgPSAhIXJlcXVlc3RGcmFtZTsKCiAgICAgIGlmIChyZXF1ZXN0RnJhbWUgJiYgIS9yZXF1ZXN0QW5pbWF0aW9uRnJhbWVcKFwpXHMqXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS9pLnRlc3QocmVxdWVzdEZyYW1lLnRvU3RyaW5nKCkpKSB7CiAgICAgICAgaXNOYXRpdmUgPSBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKGlzTmF0aXZlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCByb290KSB7CiAgICAgICAgICByZXF1ZXN0RnJhbWUoY2FsbGJhY2ssIHJvb3QpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHZhciBUQVJHRVRfRlBTID0gNjA7CiAgICAgIHZhciByZXF1ZXN0cyA9IHt9OwogICAgICB2YXIgcmVxdWVzdENvdW50ID0gMDsKICAgICAgdmFyIHJhZkhhbmRsZSA9IDE7CiAgICAgIHZhciBpbnRlcnZhbEhhbmRsZSA9IG51bGw7CiAgICAgIHZhciBsYXN0QWN0aXZlID0gK25ldyBEYXRlKCk7CgogICAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2ssIHJvb3QpIHsKICAgICAgICB2YXIgY2FsbGJhY2tIYW5kbGUgPSByYWZIYW5kbGUrKzsKCiAgICAgICAgLy8gU3RvcmUgY2FsbGJhY2sKICAgICAgICByZXF1ZXN0c1tjYWxsYmFja0hhbmRsZV0gPSBjYWxsYmFjazsKICAgICAgICByZXF1ZXN0Q291bnQrKzsKCiAgICAgICAgLy8gQ3JlYXRlIHRpbWVvdXQgYXQgZmlyc3QgcmVxdWVzdAogICAgICAgIGlmIChpbnRlcnZhbEhhbmRsZSA9PT0gbnVsbCkgewoKICAgICAgICAgIGludGVydmFsSGFuZGxlID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgdGltZSA9ICtuZXcgRGF0ZSgpOwogICAgICAgICAgICB2YXIgY3VycmVudFJlcXVlc3RzID0gcmVxdWVzdHM7CgogICAgICAgICAgICAvLyBSZXNldCBkYXRhIHN0cnVjdHVyZSBiZWZvcmUgZXhlY3V0aW5nIGNhbGxiYWNrcwogICAgICAgICAgICByZXF1ZXN0cyA9IHt9OwogICAgICAgICAgICByZXF1ZXN0Q291bnQgPSAwOwoKICAgICAgICAgICAgZm9yKHZhciBrZXkgaW4gY3VycmVudFJlcXVlc3RzKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXF1ZXN0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50UmVxdWVzdHNba2V5XSh0aW1lKTsKICAgICAgICAgICAgICAgIGxhc3RBY3RpdmUgPSB0aW1lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSB0aGUgdGltZW91dCB3aGVuIG5vdGhpbmcgaGFwcGVucyBmb3IgYSBjZXJ0YWluCiAgICAgICAgICAgIC8vIHBlcmlvZCBvZiB0aW1lCiAgICAgICAgICAgIGlmICh0aW1lIC0gbGFzdEFjdGl2ZSA+IDI1MDApIHsKICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSGFuZGxlKTsKICAgICAgICAgICAgICBpbnRlcnZhbEhhbmRsZSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9LCAxMDAwIC8gVEFSR0VUX0ZQUyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2FsbGJhY2tIYW5kbGU7CiAgICAgIH07CgogICAgfSkoKSwKCgogICAgLyoqCiAgICAgKiBTdG9wcyB0aGUgZ2l2ZW4gYW5pbWF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBpZCB7SW50ZWdlcn0gVW5pcXVlIGFuaW1hdGlvbiBJRAogICAgICogQHJldHVybiB7Qm9vbGVhbn0gV2hldGhlciB0aGUgYW5pbWF0aW9uIHdhcyBzdG9wcGVkIChha2EsIHdhcyBydW5uaW5nIGJlZm9yZSkKICAgICAqLwogICAgc3RvcDogZnVuY3Rpb24oaWQpIHsKICAgICAgdmFyIGNsZWFyZWQgPSBydW5uaW5nW2lkXSAhPSBudWxsOwogICAgICBpZiAoY2xlYXJlZCkgewogICAgICAgIHJ1bm5pbmdbaWRdID0gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIGNsZWFyZWQ7CiAgICB9LAoKCiAgICAvKioKICAgICAqIFdoZXRoZXIgdGhlIGdpdmVuIGFuaW1hdGlvbiBpcyBzdGlsbCBydW5uaW5nLgogICAgICoKICAgICAqIEBwYXJhbSBpZCB7SW50ZWdlcn0gVW5pcXVlIGFuaW1hdGlvbiBJRAogICAgICogQHJldHVybiB7Qm9vbGVhbn0gV2hldGhlciB0aGUgYW5pbWF0aW9uIGlzIHN0aWxsIHJ1bm5pbmcKICAgICAqLwogICAgaXNSdW5uaW5nOiBmdW5jdGlvbihpZCkgewogICAgICByZXR1cm4gcnVubmluZ1tpZF0gIT0gbnVsbDsKICAgIH0sCgoKICAgIC8qKgogICAgICogU3RhcnQgdGhlIGFuaW1hdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gc3RlcENhbGxiYWNrIHtGdW5jdGlvbn0gUG9pbnRlciB0byBmdW5jdGlvbiB3aGljaCBpcyBleGVjdXRlZCBvbiBldmVyeSBzdGVwLgogICAgICogICBTaWduYXR1cmUgb2YgdGhlIG1ldGhvZCBzaG91bGQgYmUgYGZ1bmN0aW9uKHBlcmNlbnQsIG5vdywgdmlydHVhbCkgeyByZXR1cm4gY29udGludWVXaXRoQW5pbWF0aW9uOyB9YAogICAgICogQHBhcmFtIHZlcmlmeUNhbGxiYWNrIHtGdW5jdGlvbn0gRXhlY3V0ZWQgYmVmb3JlIGV2ZXJ5IGFuaW1hdGlvbiBzdGVwLgogICAgICogICBTaWduYXR1cmUgb2YgdGhlIG1ldGhvZCBzaG91bGQgYmUgYGZ1bmN0aW9uKCkgeyByZXR1cm4gY29udGludWVXaXRoQW5pbWF0aW9uOyB9YAogICAgICogQHBhcmFtIGNvbXBsZXRlZENhbGxiYWNrIHtGdW5jdGlvbn0KICAgICAqICAgU2lnbmF0dXJlIG9mIHRoZSBtZXRob2Qgc2hvdWxkIGJlIGBmdW5jdGlvbihkcm9wcGVkRnJhbWVzLCBmaW5pc2hlZEFuaW1hdGlvbikge31gCiAgICAgKiBAcGFyYW0gZHVyYXRpb24ge0ludGVnZXJ9IE1pbGxpc2Vjb25kcyB0byBydW4gdGhlIGFuaW1hdGlvbgogICAgICogQHBhcmFtIGVhc2luZ01ldGhvZCB7RnVuY3Rpb259IFBvaW50ZXIgdG8gZWFzaW5nIGZ1bmN0aW9uCiAgICAgKiAgIFNpZ25hdHVyZSBvZiB0aGUgbWV0aG9kIHNob3VsZCBiZSBgZnVuY3Rpb24ocGVyY2VudCkgeyByZXR1cm4gbW9kaWZpZWRWYWx1ZTsgfWAKICAgICAqIEBwYXJhbSByb290IHtFbGVtZW50fSBSZW5kZXIgcm9vdCwgd2hlbiBhdmFpbGFibGUuIFVzZWQgZm9yIGludGVybmFsCiAgICAgKiAgIHVzYWdlIG9mIHJlcXVlc3RBbmltYXRpb25GcmFtZS4KICAgICAqIEByZXR1cm4ge0ludGVnZXJ9IElkZW50aWZpZXIgb2YgYW5pbWF0aW9uLiBDYW4gYmUgdXNlZCB0byBzdG9wIGl0IGFueSB0aW1lLgogICAgICovCiAgICBzdGFydDogZnVuY3Rpb24oc3RlcENhbGxiYWNrLCB2ZXJpZnlDYWxsYmFjaywgY29tcGxldGVkQ2FsbGJhY2ssIGR1cmF0aW9uLCBlYXNpbmdNZXRob2QsIHJvb3QpIHsKCiAgICAgIHZhciBzdGFydCA9IHRpbWUoKTsKICAgICAgdmFyIGxhc3RGcmFtZSA9IHN0YXJ0OwogICAgICB2YXIgcGVyY2VudCA9IDA7CiAgICAgIHZhciBkcm9wQ291bnRlciA9IDA7CiAgICAgIHZhciBpZCA9IGNvdW50ZXIrKzsKCiAgICAgIGlmICghcm9vdCkgewogICAgICAgIHJvb3QgPSBkb2N1bWVudC5ib2R5OwogICAgICB9CgogICAgICAvLyBDb21wYWN0aW5nIHJ1bm5pbmcgZGIgYXV0b21hdGljYWxseSBldmVyeSBmZXcgbmV3IGFuaW1hdGlvbnMKICAgICAgaWYgKGlkICUgMjAgPT09IDApIHsKICAgICAgICB2YXIgbmV3UnVubmluZyA9IHt9OwogICAgICAgIGZvciAodmFyIHVzZWRJZCBpbiBydW5uaW5nKSB7CiAgICAgICAgICBuZXdSdW5uaW5nW3VzZWRJZF0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICBydW5uaW5nID0gbmV3UnVubmluZzsKICAgICAgfQoKICAgICAgLy8gVGhpcyBpcyB0aGUgaW50ZXJuYWwgc3RlcCBtZXRob2Qgd2hpY2ggaXMgY2FsbGVkIGV2ZXJ5IGZldyBtaWxsaXNlY29uZHMKICAgICAgdmFyIHN0ZXAgPSBmdW5jdGlvbih2aXJ0dWFsKSB7CgogICAgICAgIC8vIE5vcm1hbGl6ZSB2aXJ0dWFsIHZhbHVlCiAgICAgICAgdmFyIHJlbmRlciA9IHZpcnR1YWwgIT09IHRydWU7CgogICAgICAgIC8vIEdldCBjdXJyZW50IHRpbWUKICAgICAgICB2YXIgbm93ID0gdGltZSgpOwoKICAgICAgICAvLyBWZXJpZmljYXRpb24gaXMgZXhlY3V0ZWQgYmVmb3JlIG5leHQgYW5pbWF0aW9uIHN0ZXAKICAgICAgICBpZiAoIXJ1bm5pbmdbaWRdIHx8ICh2ZXJpZnlDYWxsYmFjayAmJiAhdmVyaWZ5Q2FsbGJhY2soaWQpKSkgewoKICAgICAgICAgIHJ1bm5pbmdbaWRdID0gbnVsbDsKICAgICAgICAgIGNvbXBsZXRlZENhbGxiYWNrICYmIGNvbXBsZXRlZENhbGxiYWNrKGRlc2lyZWRGcmFtZXMgLSAoZHJvcENvdW50ZXIgLyAoKG5vdyAtIHN0YXJ0KSAvIG1pbGxpc2Vjb25kc1BlclNlY29uZCkpLCBpZCwgZmFsc2UpOwogICAgICAgICAgcmV0dXJuOwoKICAgICAgICB9CgogICAgICAgIC8vIEZvciB0aGUgY3VycmVudCByZW5kZXJpbmcgdG8gYXBwbHkgbGV0J3MgdXBkYXRlIG9taXR0ZWQgc3RlcHMgaW4gbWVtb3J5LgogICAgICAgIC8vIFRoaXMgaXMgaW1wb3J0YW50IHRvIGJyaW5nIGludGVybmFsIHN0YXRlIHZhcmlhYmxlcyB1cC10by1kYXRlIHdpdGggcHJvZ3Jlc3MgaW4gdGltZS4KICAgICAgICBpZiAocmVuZGVyKSB7CgogICAgICAgICAgdmFyIGRyb3BwZWRGcmFtZXMgPSBNYXRoLnJvdW5kKChub3cgLSBsYXN0RnJhbWUpIC8gKG1pbGxpc2Vjb25kc1BlclNlY29uZCAvIGRlc2lyZWRGcmFtZXMpKSAtIDE7CiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IE1hdGgubWluKGRyb3BwZWRGcmFtZXMsIDQpOyBqKyspIHsKICAgICAgICAgICAgc3RlcCh0cnVlKTsKICAgICAgICAgICAgZHJvcENvdW50ZXIrKzsKICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICAvLyBDb21wdXRlIHBlcmNlbnQgdmFsdWUKICAgICAgICBpZiAoZHVyYXRpb24pIHsKICAgICAgICAgIHBlcmNlbnQgPSAobm93IC0gc3RhcnQpIC8gZHVyYXRpb247CiAgICAgICAgICBpZiAocGVyY2VudCA+IDEpIHsKICAgICAgICAgICAgcGVyY2VudCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBFeGVjdXRlIHN0ZXAgY2FsbGJhY2ssIHRoZW4uLi4KICAgICAgICB2YXIgdmFsdWUgPSBlYXNpbmdNZXRob2QgPyBlYXNpbmdNZXRob2QocGVyY2VudCkgOiBwZXJjZW50OwogICAgICAgIGlmICgoc3RlcENhbGxiYWNrKHZhbHVlLCBub3csIHJlbmRlcikgPT09IGZhbHNlIHx8IHBlcmNlbnQgPT09IDEpICYmIHJlbmRlcikgewogICAgICAgICAgcnVubmluZ1tpZF0gPSBudWxsOwogICAgICAgICAgY29tcGxldGVkQ2FsbGJhY2sgJiYgY29tcGxldGVkQ2FsbGJhY2soZGVzaXJlZEZyYW1lcyAtIChkcm9wQ291bnRlciAvICgobm93IC0gc3RhcnQpIC8gbWlsbGlzZWNvbmRzUGVyU2Vjb25kKSksIGlkLCBwZXJjZW50ID09PSAxIHx8IGR1cmF0aW9uID09IG51bGwpOwogICAgICAgIH0gZWxzZSBpZiAocmVuZGVyKSB7CiAgICAgICAgICBsYXN0RnJhbWUgPSBub3c7CiAgICAgICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHN0ZXAsIHJvb3QpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIC8vIE1hcmsgYXMgcnVubmluZwogICAgICBydW5uaW5nW2lkXSA9IHRydWU7CgogICAgICAvLyBJbml0IGZpcnN0IHN0ZXAKICAgICAgenluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnJlcXVlc3RBbmltYXRpb25GcmFtZShzdGVwLCByb290KTsKCiAgICAgIC8vIFJldHVybiB1bmlxdWUgYW5pbWF0aW9uIElECiAgICAgIHJldHVybiBpZDsKICAgIH0KICB9Owp9KSh0aGlzKTsKCi8qCiAqIFNjcm9sbGVyCiAqIGh0dHA6Ly9naXRodWIuY29tL3p5bmdhL3Njcm9sbGVyCiAqCiAqIENvcHlyaWdodCAyMDExLCBaeW5nYSBJbmMuCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4KICogaHR0cHM6Ly9yYXcuZ2l0aHViLmNvbS96eW5nYS9zY3JvbGxlci9tYXN0ZXIvTUlULUxJQ0VOU0UudHh0CiAqCiAqIEJhc2VkIG9uIHRoZSB3b3JrIG9mOiBVbmlmeSBQcm9qZWN0ICh1bmlmeS1wcm9qZWN0Lm9yZykKICogaHR0cDovL3VuaWZ5LXByb2plY3Qub3JnCiAqIENvcHlyaWdodCAyMDExLCBEZXV0c2NoZSBUZWxla29tIEFHCiAqIExpY2Vuc2U6IE1JVCArIEFwYWNoZSAoVjIpCiAqLwoKdmFyIFNjcm9sbGVyOwoKKGZ1bmN0aW9uKGlvbmljKSB7CiAgdmFyIE5PT1AgPSBmdW5jdGlvbigpe307CgogIC8vIEVhc2luZyBFcXVhdGlvbnMgKGMpIDIwMDMgUm9iZXJ0IFBlbm5lciwgYWxsIHJpZ2h0cyByZXNlcnZlZC4KICAvLyBPcGVuIHNvdXJjZSB1bmRlciB0aGUgQlNEIExpY2Vuc2UuCgogIC8qKgogICAqIEBwYXJhbSBwb3Mge051bWJlcn0gcG9zaXRpb24gYmV0d2VlbiAwIChzdGFydCBvZiBlZmZlY3QpIGFuZCAxIChlbmQgb2YgZWZmZWN0KQogICoqLwogIHZhciBlYXNlT3V0Q3ViaWMgPSBmdW5jdGlvbihwb3MpIHsKICAgIHJldHVybiAoTWF0aC5wb3coKHBvcyAtIDEpLCAzKSArIDEpOwogIH07CgogIC8qKgogICAqIEBwYXJhbSBwb3Mge051bWJlcn0gcG9zaXRpb24gYmV0d2VlbiAwIChzdGFydCBvZiBlZmZlY3QpIGFuZCAxIChlbmQgb2YgZWZmZWN0KQogICoqLwogIHZhciBlYXNlSW5PdXRDdWJpYyA9IGZ1bmN0aW9uKHBvcykgewogICAgaWYgKChwb3MgLz0gMC41KSA8IDEpIHsKICAgICAgcmV0dXJuIDAuNSAqIE1hdGgucG93KHBvcywgMyk7CiAgICB9CgogICAgcmV0dXJuIDAuNSAqIChNYXRoLnBvdygocG9zIC0gMiksIDMpICsgMik7CiAgfTsKCgovKioKICogaW9uaWMudmlld3MuU2Nyb2xsCiAqIEEgcG93ZXJmdWwgc2Nyb2xsIHZpZXcgd2l0aCBzdXBwb3J0IGZvciBib3VuY2luZywgcHVsbCB0byByZWZyZXNoLCBhbmQgcGFnaW5nLgogKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgb3B0aW9ucyBvcHRpb25zIGZvciB0aGUgc2Nyb2xsIHZpZXcKICogQGNsYXNzIEEgc2Nyb2xsIHZpZXcgc3lzdGVtCiAqIEBtZW1iZXJvZiBpb25pYy52aWV3cwogKi8KaW9uaWMudmlld3MuU2Nyb2xsID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5fX2NvbnRhaW5lciA9IG9wdGlvbnMuZWw7CiAgICB0aGlzLl9fY29udGVudCA9IG9wdGlvbnMuZWwuZmlyc3RFbGVtZW50Q2hpbGQ7CgogICAgLy9SZW1vdmUgYW55IHNjcm9sbFRvcCBhdHRhY2hlZCB0byB0aGVzZSBlbGVtZW50czsgdGhleSBhcmUgdmlydHVhbCBzY3JvbGwgbm93CiAgICAvL1RoaXMgYWxzbyBzdG9wcyBvbi1sb2FkLXNjcm9sbC10by13aW5kb3cubG9jYXRpb24uaGFzaCB0aGF0IHRoZSBicm93c2VyIGRvZXMKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIGlmIChzZWxmLl9fY29udGFpbmVyICYmIHNlbGYuX19jb250ZW50KSB7CiAgICAgICAgc2VsZi5fX2NvbnRhaW5lci5zY3JvbGxUb3AgPSAwOwogICAgICAgIHNlbGYuX19jb250ZW50LnNjcm9sbFRvcCA9IDA7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMub3B0aW9ucyA9IHsKCiAgICAgIC8qKiBEaXNhYmxlIHNjcm9sbGluZyBvbiB4LWF4aXMgYnkgZGVmYXVsdCAqLwogICAgICBzY3JvbGxpbmdYOiBmYWxzZSwKICAgICAgc2Nyb2xsYmFyWDogdHJ1ZSwKCiAgICAgIC8qKiBFbmFibGUgc2Nyb2xsaW5nIG9uIHktYXhpcyAqLwogICAgICBzY3JvbGxpbmdZOiB0cnVlLAogICAgICBzY3JvbGxiYXJZOiB0cnVlLAoKICAgICAgc3RhcnRYOiAwLAogICAgICBzdGFydFk6IDAsCgogICAgICAvKiogVGhlIGFtb3VudCB0byBkYW1wZW4gbW91c2V3aGVlbCBldmVudHMgKi8KICAgICAgd2hlZWxEYW1wZW46IDYsCgogICAgICAvKiogVGhlIG1pbmltdW0gc2l6ZSB0aGUgc2Nyb2xsYmFycyBzY2FsZSB0byB3aGlsZSBzY3JvbGxpbmcgKi8KICAgICAgbWluU2Nyb2xsYmFyU2l6ZVg6IDUsCiAgICAgIG1pblNjcm9sbGJhclNpemVZOiA1LAoKICAgICAgLyoqIFNjcm9sbGJhciBmYWRpbmcgYWZ0ZXIgc2Nyb2xsaW5nICovCiAgICAgIHNjcm9sbGJhcnNGYWRlOiB0cnVlLAogICAgICBzY3JvbGxiYXJGYWRlRGVsYXk6IDMwMCwKICAgICAgLyoqIFRoZSBpbml0aWFsIGZhZGUgZGVsYXkgd2hlbiB0aGUgcGFuZSBpcyByZXNpemVkIG9yIGluaXRpYWxpemVkICovCiAgICAgIHNjcm9sbGJhclJlc2l6ZUZhZGVEZWxheTogMTAwMCwKCiAgICAgIC8qKiBFbmFibGUgYW5pbWF0aW9ucyBmb3IgZGVjZWxlcmF0aW9uLCBzbmFwIGJhY2ssIHpvb21pbmcgYW5kIHNjcm9sbGluZyAqLwogICAgICBhbmltYXRpbmc6IHRydWUsCgogICAgICAvKiogZHVyYXRpb24gZm9yIGFuaW1hdGlvbnMgdHJpZ2dlcmVkIGJ5IHNjcm9sbFRvL3pvb21UbyAqLwogICAgICBhbmltYXRpb25EdXJhdGlvbjogMjUwLAoKICAgICAgLyoqIEVuYWJsZSBib3VuY2luZyAoY29udGVudCBjYW4gYmUgc2xvd2x5IG1vdmVkIG91dHNpZGUgYW5kIGp1bXBzIGJhY2sgYWZ0ZXIgcmVsZWFzaW5nKSAqLwogICAgICBib3VuY2luZzogdHJ1ZSwKCiAgICAgIC8qKiBFbmFibGUgbG9ja2luZyB0byB0aGUgbWFpbiBheGlzIGlmIHVzZXIgbW92ZXMgb25seSBzbGlnaHRseSBvbiBvbmUgb2YgdGhlbSBhdCBzdGFydCAqLwogICAgICBsb2NraW5nOiB0cnVlLAoKICAgICAgLyoqIEVuYWJsZSBwYWdpbmF0aW9uIG1vZGUgKHN3aXRjaGluZyBiZXR3ZWVuIGZ1bGwgcGFnZSBjb250ZW50IHBhbmVzKSAqLwogICAgICBwYWdpbmc6IGZhbHNlLAoKICAgICAgLyoqIEVuYWJsZSBzbmFwcGluZyBvZiBjb250ZW50IHRvIGEgY29uZmlndXJlZCBwaXhlbCBncmlkICovCiAgICAgIHNuYXBwaW5nOiBmYWxzZSwKCiAgICAgIC8qKiBFbmFibGUgem9vbWluZyBvZiBjb250ZW50IHZpYSBBUEksIGZpbmdlcnMgYW5kIG1vdXNlIHdoZWVsICovCiAgICAgIHpvb21pbmc6IGZhbHNlLAoKICAgICAgLyoqIE1pbmltdW0gem9vbSBsZXZlbCAqLwogICAgICBtaW5ab29tOiAwLjUsCgogICAgICAvKiogTWF4aW11bSB6b29tIGxldmVsICovCiAgICAgIG1heFpvb206IDMsCgogICAgICAvKiogTXVsdGlwbHkgb3IgZGVjcmVhc2Ugc2Nyb2xsaW5nIHNwZWVkICoqLwogICAgICBzcGVlZE11bHRpcGxpZXI6IDEsCgogICAgICBkZWNlbGVyYXRpb246IDAuOTcsCgogICAgICAvKiogQ2FsbGJhY2sgdGhhdCBpcyBmaXJlZCBvbiB0aGUgbGF0ZXIgb2YgdG91Y2ggZW5kIG9yIGRlY2VsZXJhdGlvbiBlbmQsCiAgICAgICAgcHJvdmlkZWQgdGhhdCBhbm90aGVyIHNjcm9sbGluZyBhY3Rpb24gaGFzIG5vdCBiZWd1bi4gVXNlZCB0byBrbm93CiAgICAgICAgd2hlbiB0byBmYWRlIG91dCBhIHNjcm9sbGJhci4gKi8KICAgICAgc2Nyb2xsaW5nQ29tcGxldGU6IE5PT1AsCgogICAgICAvKiogVGhpcyBjb25maWd1cmVzIHRoZSBhbW91bnQgb2YgY2hhbmdlIGFwcGxpZWQgdG8gZGVjZWxlcmF0aW9uIHdoZW4gcmVhY2hpbmcgYm91bmRhcmllcyAgKiovCiAgICAgIHBlbmV0cmF0aW9uRGVjZWxlcmF0aW9uIDogMC4wMywKCiAgICAgIC8qKiBUaGlzIGNvbmZpZ3VyZXMgdGhlIGFtb3VudCBvZiBjaGFuZ2UgYXBwbGllZCB0byBhY2NlbGVyYXRpb24gd2hlbiByZWFjaGluZyBib3VuZGFyaWVzICAqKi8KICAgICAgcGVuZXRyYXRpb25BY2NlbGVyYXRpb24gOiAwLjA4LAoKICAgICAgLy8gVGhlIG1zIGludGVydmFsIGZvciB0cmlnZ2VyaW5nIHNjcm9sbCBldmVudHMKICAgICAgc2Nyb2xsRXZlbnRJbnRlcnZhbDogMTAsCgogICAgICBnZXRDb250ZW50V2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBNYXRoLm1heChzZWxmLl9fY29udGVudC5zY3JvbGxXaWR0aCwgc2VsZi5fX2NvbnRlbnQub2Zmc2V0V2lkdGgpOwogICAgICB9LAogICAgICBnZXRDb250ZW50SGVpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoc2VsZi5fX2NvbnRlbnQuc2Nyb2xsSGVpZ2h0LCBzZWxmLl9fY29udGVudC5vZmZzZXRIZWlnaHQgKyAoc2VsZi5fX2NvbnRlbnQub2Zmc2V0VG9wICogMikpOwogICAgICB9CiAgICB9OwoKICAgIGZvciAodmFyIGtleSBpbiBvcHRpb25zKSB7CiAgICAgIHRoaXMub3B0aW9uc1trZXldID0gb3B0aW9uc1trZXldOwogICAgfQoKICAgIHRoaXMuaGludFJlc2l6ZSA9IGlvbmljLmRlYm91bmNlKGZ1bmN0aW9uKCkgewogICAgICBzZWxmLnJlc2l6ZSgpOwogICAgfSwgMTAwMCwgdHJ1ZSk7CgogICAgdGhpcy5vblNjcm9sbCA9IGZ1bmN0aW9uKCkgewoKICAgICAgaWYoIWlvbmljLnNjcm9sbC5pc1Njcm9sbGluZykgewogICAgICAgIHNldFRpbWVvdXQoc2VsZi5zZXRTY3JvbGxTdGFydCwgNTApOwogICAgICB9IGVsc2UgewogICAgICAgIGNsZWFyVGltZW91dChzZWxmLnNjcm9sbFRpbWVyKTsKICAgICAgICBzZWxmLnNjcm9sbFRpbWVyID0gc2V0VGltZW91dChzZWxmLnNldFNjcm9sbFN0b3AsIDgwKTsKICAgICAgfQoKICAgIH07CgogICAgdGhpcy5zZXRTY3JvbGxTdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICBpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgPSBNYXRoLmFicyhpb25pYy5zY3JvbGwubGFzdFRvcCAtIHNlbGYuX19zY3JvbGxUb3ApID4gMTsKICAgICAgY2xlYXJUaW1lb3V0KHNlbGYuc2Nyb2xsVGltZXIpOwogICAgICBzZWxmLnNjcm9sbFRpbWVyID0gc2V0VGltZW91dChzZWxmLnNldFNjcm9sbFN0b3AsIDgwKTsKICAgIH07CgogICAgdGhpcy5zZXRTY3JvbGxTdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyA9IGZhbHNlOwogICAgICBpb25pYy5zY3JvbGwubGFzdFRvcCA9IHNlbGYuX19zY3JvbGxUb3A7CiAgICB9OwoKICAgIHRoaXMudHJpZ2dlclNjcm9sbEV2ZW50ID0gaW9uaWMudGhyb3R0bGUoZnVuY3Rpb24oKSB7CiAgICAgIHNlbGYub25TY3JvbGwoKTsKICAgICAgaW9uaWMudHJpZ2dlcignc2Nyb2xsJywgewogICAgICAgIHNjcm9sbFRvcDogc2VsZi5fX3Njcm9sbFRvcCwKICAgICAgICBzY3JvbGxMZWZ0OiBzZWxmLl9fc2Nyb2xsTGVmdCwKICAgICAgICB0YXJnZXQ6IHNlbGYuX19jb250YWluZXIKICAgICAgfSk7CiAgICB9LCB0aGlzLm9wdGlvbnMuc2Nyb2xsRXZlbnRJbnRlcnZhbCk7CgogICAgdGhpcy50cmlnZ2VyU2Nyb2xsRW5kRXZlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgaW9uaWMudHJpZ2dlcignc2Nyb2xsZW5kJywgewogICAgICAgIHNjcm9sbFRvcDogc2VsZi5fX3Njcm9sbFRvcCwKICAgICAgICBzY3JvbGxMZWZ0OiBzZWxmLl9fc2Nyb2xsTGVmdCwKICAgICAgICB0YXJnZXQ6IHNlbGYuX19jb250YWluZXIKICAgICAgfSk7CiAgICB9OwoKICAgIHRoaXMuX19zY3JvbGxMZWZ0ID0gdGhpcy5vcHRpb25zLnN0YXJ0WDsKICAgIHRoaXMuX19zY3JvbGxUb3AgPSB0aGlzLm9wdGlvbnMuc3RhcnRZOwoKICAgIC8vIEdldCB0aGUgcmVuZGVyIHVwZGF0ZSBmdW5jdGlvbiwgaW5pdGlhbGl6ZSBldmVudCBoYW5kbGVycywKICAgIC8vIGFuZCBjYWxjdWxhdGUgdGhlIHNpemUgb2YgdGhlIHNjcm9sbCBjb250YWluZXIKICAgIHRoaXMuX19jYWxsYmFjayA9IHRoaXMuZ2V0UmVuZGVyRm4oKTsKICAgIHRoaXMuX19pbml0RXZlbnRIYW5kbGVycygpOwogICAgdGhpcy5fX2NyZWF0ZVNjcm9sbGJhcnMoKTsKCiAgfSwKCiAgcnVuOiBmdW5jdGlvbigpIHsKICAgIHRoaXMucmVzaXplKCk7CgogICAgLy8gRmFkZSB0aGVtIG91dAogICAgdGhpcy5fX2ZhZGVTY3JvbGxiYXJzKCdvdXQnLCB0aGlzLm9wdGlvbnMuc2Nyb2xsYmFyUmVzaXplRmFkZURlbGF5KTsKICB9LAoKCgogIC8qCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBJTlRFUk5BTCBGSUVMRFMgOjogU1RBVFVTCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKi8KCiAgLyoqIFdoZXRoZXIgb25seSBhIHNpbmdsZSBmaW5nZXIgaXMgdXNlZCBpbiB0b3VjaCBoYW5kbGluZyAqLwogIF9faXNTaW5nbGVUb3VjaDogZmFsc2UsCgogIC8qKiBXaGV0aGVyIGEgdG91Y2ggZXZlbnQgc2VxdWVuY2UgaXMgaW4gcHJvZ3Jlc3MgKi8KICBfX2lzVHJhY2tpbmc6IGZhbHNlLAoKICAvKiogV2hldGhlciBhIGRlY2VsZXJhdGlvbiBhbmltYXRpb24gd2VudCB0byBjb21wbGV0aW9uLiAqLwogIF9fZGlkRGVjZWxlcmF0aW9uQ29tcGxldGU6IGZhbHNlLAoKICAvKioKICAgKiBXaGV0aGVyIGEgZ2VzdHVyZSB6b29tL3JvdGF0ZSBldmVudCBpcyBpbiBwcm9ncmVzcy4gQWN0aXZhdGVzIHdoZW4KICAgKiBhIGdlc3R1cmVzdGFydCBldmVudCBoYXBwZW5zLiBUaGlzIGhhcyBoaWdoZXIgcHJpb3JpdHkgdGhhbiBkcmFnZ2luZy4KICAgKi8KICBfX2lzR2VzdHVyaW5nOiBmYWxzZSwKCiAgLyoqCiAgICogV2hldGhlciB0aGUgdXNlciBoYXMgbW92ZWQgYnkgc3VjaCBhIGRpc3RhbmNlIHRoYXQgd2UgaGF2ZSBlbmFibGVkCiAgICogZHJhZ2dpbmcgbW9kZS4gSGludDogSXQncyBvbmx5IGVuYWJsZWQgYWZ0ZXIgc29tZSBwaXhlbHMgb2YgbW92ZW1lbnQgdG8KICAgKiBub3QgaW50ZXJydXB0IHdpdGggY2xpY2tzIGV0Yy4KICAgKi8KICBfX2lzRHJhZ2dpbmc6IGZhbHNlLAoKICAvKioKICAgKiBOb3QgdG91Y2hpbmcgYW5kIGRyYWdnaW5nIGFueW1vcmUsIGFuZCBzbW9vdGhseSBhbmltYXRpbmcgdGhlCiAgICogdG91Y2ggc2VxdWVuY2UgdXNpbmcgZGVjZWxlcmF0aW9uLgogICAqLwogIF9faXNEZWNlbGVyYXRpbmc6IGZhbHNlLAoKICAvKioKICAgKiBTbW9vdGhseSBhbmltYXRpbmcgdGhlIGN1cnJlbnRseSBjb25maWd1cmVkIGNoYW5nZQogICAqLwogIF9faXNBbmltYXRpbmc6IGZhbHNlLAoKCgogIC8qCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBJTlRFUk5BTCBGSUVMRFMgOjogRElNRU5TSU9OUwogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICovCgogIC8qKiBBdmFpbGFibGUgb3V0ZXIgbGVmdCBwb3NpdGlvbiAoZnJvbSBkb2N1bWVudCBwZXJzcGVjdGl2ZSkgKi8KICBfX2NsaWVudExlZnQ6IDAsCgogIC8qKiBBdmFpbGFibGUgb3V0ZXIgdG9wIHBvc2l0aW9uIChmcm9tIGRvY3VtZW50IHBlcnNwZWN0aXZlKSAqLwogIF9fY2xpZW50VG9wOiAwLAoKICAvKiogQXZhaWxhYmxlIG91dGVyIHdpZHRoICovCiAgX19jbGllbnRXaWR0aDogMCwKCiAgLyoqIEF2YWlsYWJsZSBvdXRlciBoZWlnaHQgKi8KICBfX2NsaWVudEhlaWdodDogMCwKCiAgLyoqIE91dGVyIHdpZHRoIG9mIGNvbnRlbnQgKi8KICBfX2NvbnRlbnRXaWR0aDogMCwKCiAgLyoqIE91dGVyIGhlaWdodCBvZiBjb250ZW50ICovCiAgX19jb250ZW50SGVpZ2h0OiAwLAoKICAvKiogU25hcHBpbmcgd2lkdGggZm9yIGNvbnRlbnQgKi8KICBfX3NuYXBXaWR0aDogMTAwLAoKICAvKiogU25hcHBpbmcgaGVpZ2h0IGZvciBjb250ZW50ICovCiAgX19zbmFwSGVpZ2h0OiAxMDAsCgogIC8qKiBIZWlnaHQgdG8gYXNzaWduIHRvIHJlZnJlc2ggYXJlYSAqLwogIF9fcmVmcmVzaEhlaWdodDogbnVsbCwKCiAgLyoqIFdoZXRoZXIgdGhlIHJlZnJlc2ggcHJvY2VzcyBpcyBlbmFibGVkIHdoZW4gdGhlIGV2ZW50IGlzIHJlbGVhc2VkIG5vdyAqLwogIF9fcmVmcmVzaEFjdGl2ZTogZmFsc2UsCgogIC8qKiBDYWxsYmFjayB0byBleGVjdXRlIG9uIGFjdGl2YXRpb24uIFRoaXMgaXMgZm9yIHNpZ25hbGxpbmcgdGhlIHVzZXIgYWJvdXQgYSByZWZyZXNoIGlzIGFib3V0IHRvIGhhcHBlbiB3aGVuIGhlIHJlbGVhc2UgKi8KICBfX3JlZnJlc2hBY3RpdmF0ZTogbnVsbCwKCiAgLyoqIENhbGxiYWNrIHRvIGV4ZWN1dGUgb24gZGVhY3RpdmF0aW9uLiBUaGlzIGlzIGZvciBzaWduYWxsaW5nIHRoZSB1c2VyIGFib3V0IHRoZSByZWZyZXNoIGJlaW5nIGNhbmNlbGxlZCAqLwogIF9fcmVmcmVzaERlYWN0aXZhdGU6IG51bGwsCgogIC8qKiBDYWxsYmFjayB0byBleGVjdXRlIHRvIHN0YXJ0IHRoZSBhY3R1YWwgcmVmcmVzaC4gQ2FsbCB7QGxpbmsgI3JlZnJlc2hGaW5pc2h9IHdoZW4gZG9uZSAqLwogIF9fcmVmcmVzaFN0YXJ0OiBudWxsLAoKICAvKiogWm9vbSBsZXZlbCAqLwogIF9fem9vbUxldmVsOiAxLAoKICAvKiogU2Nyb2xsIHBvc2l0aW9uIG9uIHgtYXhpcyAqLwogIF9fc2Nyb2xsTGVmdDogMCwKCiAgLyoqIFNjcm9sbCBwb3NpdGlvbiBvbiB5LWF4aXMgKi8KICBfX3Njcm9sbFRvcDogMCwKCiAgLyoqIE1heGltdW0gYWxsb3dlZCBzY3JvbGwgcG9zaXRpb24gb24geC1heGlzICovCiAgX19tYXhTY3JvbGxMZWZ0OiAwLAoKICAvKiogTWF4aW11bSBhbGxvd2VkIHNjcm9sbCBwb3NpdGlvbiBvbiB5LWF4aXMgKi8KICBfX21heFNjcm9sbFRvcDogMCwKCiAgLyogU2NoZWR1bGVkIGxlZnQgcG9zaXRpb24gKGZpbmFsIHBvc2l0aW9uIHdoZW4gYW5pbWF0aW5nKSAqLwogIF9fc2NoZWR1bGVkTGVmdDogMCwKCiAgLyogU2NoZWR1bGVkIHRvcCBwb3NpdGlvbiAoZmluYWwgcG9zaXRpb24gd2hlbiBhbmltYXRpbmcpICovCiAgX19zY2hlZHVsZWRUb3A6IDAsCgogIC8qIFNjaGVkdWxlZCB6b29tIGxldmVsIChmaW5hbCBzY2FsZSB3aGVuIGFuaW1hdGluZykgKi8KICBfX3NjaGVkdWxlZFpvb206IDAsCgoKCiAgLyoKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIElOVEVSTkFMIEZJRUxEUyA6OiBMQVNUIFBPU0lUSU9OUwogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICovCgogIC8qKiBMZWZ0IHBvc2l0aW9uIG9mIGZpbmdlciBhdCBzdGFydCAqLwogIF9fbGFzdFRvdWNoTGVmdDogbnVsbCwKCiAgLyoqIFRvcCBwb3NpdGlvbiBvZiBmaW5nZXIgYXQgc3RhcnQgKi8KICBfX2xhc3RUb3VjaFRvcDogbnVsbCwKCiAgLyoqIFRpbWVzdGFtcCBvZiBsYXN0IG1vdmUgb2YgZmluZ2VyLiBVc2VkIHRvIGxpbWl0IHRyYWNraW5nIHJhbmdlIGZvciBkZWNlbGVyYXRpb24gc3BlZWQuICovCiAgX19sYXN0VG91Y2hNb3ZlOiBudWxsLAoKICAvKiogTGlzdCBvZiBwb3NpdGlvbnMsIHVzZXMgdGhyZWUgaW5kZXhlcyBmb3IgZWFjaCBzdGF0ZTogbGVmdCwgdG9wLCB0aW1lc3RhbXAgKi8KICBfX3Bvc2l0aW9uczogbnVsbCwKCgoKICAvKgogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgSU5URVJOQUwgRklFTERTIDo6IERFQ0VMRVJBVElPTiBTVVBQT1JUCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKi8KCiAgLyoqIE1pbmltdW0gbGVmdCBzY3JvbGwgcG9zaXRpb24gZHVyaW5nIGRlY2VsZXJhdGlvbiAqLwogIF9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdDogbnVsbCwKCiAgLyoqIE1pbmltdW0gdG9wIHNjcm9sbCBwb3NpdGlvbiBkdXJpbmcgZGVjZWxlcmF0aW9uICovCiAgX19taW5EZWNlbGVyYXRpb25TY3JvbGxUb3A6IG51bGwsCgogIC8qKiBNYXhpbXVtIGxlZnQgc2Nyb2xsIHBvc2l0aW9uIGR1cmluZyBkZWNlbGVyYXRpb24gKi8KICBfX21heERlY2VsZXJhdGlvblNjcm9sbExlZnQ6IG51bGwsCgogIC8qKiBNYXhpbXVtIHRvcCBzY3JvbGwgcG9zaXRpb24gZHVyaW5nIGRlY2VsZXJhdGlvbiAqLwogIF9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wOiBudWxsLAoKICAvKiogQ3VycmVudCBmYWN0b3IgdG8gbW9kaWZ5IGhvcml6b250YWwgc2Nyb2xsIHBvc2l0aW9uIHdpdGggb24gZXZlcnkgc3RlcCAqLwogIF9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYOiBudWxsLAoKICAvKiogQ3VycmVudCBmYWN0b3IgdG8gbW9kaWZ5IHZlcnRpY2FsIHNjcm9sbCBwb3NpdGlvbiB3aXRoIG9uIGV2ZXJ5IHN0ZXAgKi8KICBfX2RlY2VsZXJhdGlvblZlbG9jaXR5WTogbnVsbCwKCgogIC8qKiB0aGUgYnJvd3Nlci1zcGVjaWZpYyBwcm9wZXJ0eSB0byB1c2UgZm9yIHRyYW5zZm9ybXMgKi8KICBfX3RyYW5zZm9ybVByb3BlcnR5OiBudWxsLAogIF9fcGVyc3BlY3RpdmVQcm9wZXJ0eTogbnVsbCwKCiAgLyoqIHNjcm9sbGJhciBpbmRpY2F0b3JzICovCiAgX19pbmRpY2F0b3JYOiBudWxsLAogIF9faW5kaWNhdG9yWTogbnVsbCwKCiAgLyoqIFRpbWVvdXQgZm9yIHNjcm9sbGJhciBmYWRpbmcgKi8KICBfX3Njcm9sbGJhckZhZGVUaW1lb3V0OiBudWxsLAoKICAvKiogd2hldGhlciB3ZSd2ZSB0cmllZCB0byB3YWl0IGZvciBzaXplIGFscmVhZHkgKi8KICBfX2RpZFdhaXRGb3JTaXplOiBudWxsLAogIF9fc2l6ZXJUaW1lb3V0OiBudWxsLAoKICBfX2luaXRFdmVudEhhbmRsZXJzOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBFdmVudCBIYW5kbGVyCiAgICB2YXIgY29udGFpbmVyID0gdGhpcy5fX2NvbnRhaW5lcjsKCiAgICBzZWxmLnNjcm9sbENoaWxkSW50b1ZpZXcgPSBmdW5jdGlvbihlKSB7CgogICAgICAvL2Rpc3RhbmNlIGZyb20gYm90dG9tIG9mIHNjcm9sbHZpZXcgdG8gdG9wIG9mIHZpZXdwb3J0CiAgICAgIHZhciBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcDsKCiAgICAgIGlmKCAhc2VsZi5pc1Njcm9sbGVkSW50b1ZpZXcgKSB7CiAgICAgICAgLy8gc2hyaW5rIHNjcm9sbHZpZXcgc28gd2UgY2FuIGFjdHVhbGx5IHNjcm9sbCBpZiB0aGUgaW5wdXQgaXMgaGlkZGVuCiAgICAgICAgLy8gaWYgaXQgaXNuJ3Qgc2hyaW5rIHNvIHdlIGNhbiBzY3JvbGwgdG8gaW5wdXRzIHVuZGVyIHRoZSBrZXlib2FyZAogICAgICAgIGlmIChpb25pYy5QbGF0Zm9ybS5pc0lPUygpIHx8IGlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbil7CiAgICAgICAgICAvLyBpZiB0aGVyZSBhcmUgdGhpbmdzIGJlbG93IHRoZSBzY3JvbGwgdmlldyBhY2NvdW50IGZvciB0aGVtIGFuZAogICAgICAgICAgLy8gc3VidHJhY3QgdGhlbSBmcm9tIHRoZSBrZXlib2FyZCBoZWlnaHQgd2hlbiByZXNpemluZwogICAgICAgICAgc2Nyb2xsQm90dG9tT2Zmc2V0VG9Ub3AgPSBjb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tOwogICAgICAgICAgdmFyIHNjcm9sbEJvdHRvbU9mZnNldFRvQm90dG9tID0gZS5kZXRhaWwudmlld3BvcnRIZWlnaHQgLSBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcDsKICAgICAgICAgIHZhciBrZXlib2FyZE9mZnNldCA9IE1hdGgubWF4KDAsIGUuZGV0YWlsLmtleWJvYXJkSGVpZ2h0IC0gc2Nyb2xsQm90dG9tT2Zmc2V0VG9Cb3R0b20pOwogICAgICAgICAgY29udGFpbmVyLnN0eWxlLmhlaWdodCA9IChjb250YWluZXIuY2xpZW50SGVpZ2h0IC0ga2V5Ym9hcmRPZmZzZXQpICsgInB4IjsKICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS5vdmVyZmxvdyA9ICJ2aXNpYmxlIjsKICAgICAgICAgIC8vdXBkYXRlIHNjcm9sbCB2aWV3CiAgICAgICAgICBzZWxmLnJlc2l6ZSgpOwogICAgICAgIH0KICAgICAgICBzZWxmLmlzU2Nyb2xsZWRJbnRvVmlldyA9IHRydWU7CiAgICAgIH0KCiAgICAgIC8vSWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZCB1bmRlciB0aGUga2V5Ym9hcmQuLi4KICAgICAgaWYoIGUuZGV0YWlsLmlzRWxlbWVudFVuZGVyS2V5Ym9hcmQgKSB7CiAgICAgICAgdmFyIGRlbGF5OwogICAgICAgIC8vIFdhaXQgb24gYW5kcm9pZCBmb3Igd2ViIHZpZXcgdG8gcmVzaXplCiAgICAgICAgaWYgKCBpb25pYy5QbGF0Zm9ybS5pc0FuZHJvaWQoKSAmJiAhaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuICkgewogICAgICAgICAgLy8gYW5kcm9pZCB5IHUgcmVzaXplIHNvIHNsb3cKICAgICAgICAgIGlmICggaW9uaWMuUGxhdGZvcm0udmVyc2lvbigpIDwgNC40KSB7CiAgICAgICAgICAgIGRlbGF5ID0gNTAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gcHJvYmFibHkgb3ZlcmtpbGwgZm9yIGNocm9tZQogICAgICAgICAgICBkZWxheSA9IDM1MDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsYXkgPSA4MDsKICAgICAgICB9CgogICAgICAgIC8vUHV0IGVsZW1lbnQgaW4gbWlkZGxlIG9mIHZpc2libGUgc2NyZWVuCiAgICAgICAgLy9XYWl0IGZvciBhbmRyb2lkIHRvIHVwZGF0ZSB2aWV3IGhlaWdodCBhbmQgcmVzaXplKCkgdG8gcmVzZXQgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nID0gdHJ1ZTsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAvL21pZGRsZSBvZiB0aGUgc2Nyb2xsdmlldywgd2hlcmUgd2Ugd2FudCB0byBzY3JvbGwgdG8KICAgICAgICAgIHZhciBzY3JvbGxNaWRwb2ludE9mZnNldCA9IGNvbnRhaW5lci5jbGllbnRIZWlnaHQgKiAwLjU7CgogICAgICAgICAgc2Nyb2xsQm90dG9tT2Zmc2V0VG9Ub3AgPSBjb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tOwogICAgICAgICAgLy9kaXN0YW5jZSBmcm9tIHRvcCBvZiBmb2N1c2VkIGVsZW1lbnQgdG8gdGhlIGJvdHRvbSBvZiB0aGUgc2Nyb2xsIHZpZXcKICAgICAgICAgIHZhciBlbGVtZW50VG9wT2Zmc2V0VG9TY3JvbGxCb3R0b20gPSBlLmRldGFpbC5lbGVtZW50VG9wIC0gc2Nyb2xsQm90dG9tT2Zmc2V0VG9Ub3A7CgogICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IGVsZW1lbnRUb3BPZmZzZXRUb1Njcm9sbEJvdHRvbSAgKyBzY3JvbGxNaWRwb2ludE9mZnNldDsKCiAgICAgICAgICBpZiAoc2Nyb2xsVG9wID4gMCl7CiAgICAgICAgICAgIGlvbmljLnRhcC5jbG9uZUZvY3VzZWRJbnB1dChjb250YWluZXIsIHNlbGYpOwogICAgICAgICAgICBzZWxmLnNjcm9sbEJ5KDAsIHNjcm9sbFRvcCwgdHJ1ZSk7CiAgICAgICAgICAgIHNlbGYub25TY3JvbGwoKTsKICAgICAgICAgIH0KICAgICAgICB9LCBkZWxheSk7CiAgICAgIH0KCiAgICAgIC8vT25seSB0aGUgZmlyc3Qgc2Nyb2xsVmlldyBwYXJlbnQgb2YgdGhlIGVsZW1lbnQgdGhhdCBicm9hZGNhc3RlZCB0aGlzIGV2ZW50CiAgICAgIC8vKHRoZSBhY3RpdmUgZWxlbWVudCB0aGF0IG5lZWRzIHRvIGJlIHNob3duKSBzaG91bGQgcmVjZWl2ZSB0aGlzIGV2ZW50CiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9OwoKICAgIHNlbGYucmVzZXRTY3JvbGxWaWV3ID0gZnVuY3Rpb24oZSkgewogICAgICAvL3JldHVybiBzY3JvbGx2aWV3IHRvIG9yaWdpbmFsIGhlaWdodCBvbmNlIGtleWJvYXJkIGhhcyBoaWRkZW4KICAgICAgc2VsZi5pc1Njcm9sbGVkSW50b1ZpZXcgPSBmYWxzZTsKICAgICAgY29udGFpbmVyLnN0eWxlLmhlaWdodCA9ICIiOwogICAgICBjb250YWluZXIuc3R5bGUub3ZlcmZsb3cgPSAiIjsKICAgICAgc2VsZi5yZXNpemUoKTsKICAgICAgaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nID0gZmFsc2U7CiAgICB9OwoKICAgIC8vQnJvYWRjYXN0ZWQgd2hlbiBrZXlib2FyZCBpcyBzaG93biBvbiBzb21lIHBsYXRmb3Jtcy4KICAgIC8vU2VlIGpzL3V0aWxzL2tleWJvYXJkLmpzCiAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsQ2hpbGRJbnRvVmlldycsIHNlbGYuc2Nyb2xsQ2hpbGRJbnRvVmlldyk7CiAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigncmVzZXRTY3JvbGxWaWV3Jywgc2VsZi5yZXNldFNjcm9sbFZpZXcpOwoKICAgIGZ1bmN0aW9uIGdldEV2ZW50VG91Y2hlcyhlKSB7CiAgICAgIHJldHVybiBlLnRvdWNoZXMgJiYgZS50b3VjaGVzLmxlbmd0aCA/IGUudG91Y2hlcyA6IFt7CiAgICAgICAgcGFnZVg6IGUucGFnZVgsCiAgICAgICAgcGFnZVk6IGUucGFnZVkKICAgICAgfV07CiAgICB9CgogICAgc2VsZi50b3VjaFN0YXJ0ID0gZnVuY3Rpb24oZSkgewogICAgICBzZWxmLnN0YXJ0Q29vcmRpbmF0ZXMgPSBpb25pYy50YXAucG9pbnRlckNvb3JkKGUpOwoKICAgICAgaWYgKCBpb25pYy50YXAuaWdub3JlU2Nyb2xsU3RhcnQoZSkgKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBzZWxmLl9faXNEb3duID0gdHJ1ZTsKCiAgICAgIGlmKCBpb25pYy50YXAuY29udGFpbnNPcklzVGV4dElucHV0KGUudGFyZ2V0KSB8fCBlLnRhcmdldC50YWdOYW1lID09PSAnU0VMRUNUJyApIHsKICAgICAgICAvLyBkbyBub3Qgc3RhcnQgaWYgdGhlIHRhcmdldCBpcyBhIHRleHQgaW5wdXQKICAgICAgICAvLyBpZiB0aGVyZSBpcyBhIHRvdWNobW92ZSBvbiB0aGlzIGlucHV0LCB0aGVuIHdlIGNhbiBzdGFydCB0aGUgc2Nyb2xsCiAgICAgICAgc2VsZi5fX2hhc1N0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHNlbGYuX19pc1NlbGVjdGFibGUgPSB0cnVlOwogICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWSA9IHRydWU7CiAgICAgIHNlbGYuX19oYXNTdGFydGVkID0gdHJ1ZTsKICAgICAgc2VsZi5kb1RvdWNoU3RhcnQoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCk7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIH07CgogICAgc2VsZi50b3VjaE1vdmUgPSBmdW5jdGlvbihlKSB7CiAgICAgIGlmKCFzZWxmLl9faXNEb3duIHx8CiAgICAgICAgZS5kZWZhdWx0UHJldmVudGVkIHx8CiAgICAgICAgKGUudGFyZ2V0LnRhZ05hbWUgPT09ICdURVhUQVJFQScgJiYgZS50YXJnZXQucGFyZW50RWxlbWVudC5xdWVyeVNlbGVjdG9yKCc6Zm9jdXMnKSkgKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiggIXNlbGYuX19oYXNTdGFydGVkICYmICggaW9uaWMudGFwLmNvbnRhaW5zT3JJc1RleHRJbnB1dChlLnRhcmdldCkgfHwgZS50YXJnZXQudGFnTmFtZSA9PT0gJ1NFTEVDVCcgKSApIHsKICAgICAgICAvLyB0aGUgdGFyZ2V0IGlzIGEgdGV4dCBpbnB1dCBhbmQgc2Nyb2xsIGhhcyBzdGFydGVkCiAgICAgICAgLy8gc2luY2UgdGhlIHRleHQgaW5wdXQgZG9lc24ndCBzdGFydCBvbiB0b3VjaFN0YXJ0LCBkbyBpdCBoZXJlCiAgICAgICAgc2VsZi5fX2hhc1N0YXJ0ZWQgPSB0cnVlOwogICAgICAgIHNlbGYuZG9Ub3VjaFN0YXJ0KGdldEV2ZW50VG91Y2hlcyhlKSwgZS50aW1lU3RhbXApOwogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmKHNlbGYuc3RhcnRDb29yZGluYXRlcykgewogICAgICAgIC8vIHdlIGhhdmUgc3RhcnQgY29vcmRpbmF0ZXMsIHNvIGdldCB0aGlzIHRvdWNoIG1vdmUncyBjdXJyZW50IGNvb3JkaW5hdGVzCiAgICAgICAgdmFyIGN1cnJlbnRDb29yZGluYXRlcyA9IGlvbmljLnRhcC5wb2ludGVyQ29vcmQoZSk7CgogICAgICAgIGlmKCBzZWxmLl9faXNTZWxlY3RhYmxlICYmCiAgICAgICAgICAgIGlvbmljLnRhcC5pc1RleHRJbnB1dChlLnRhcmdldCkgJiYKICAgICAgICAgICAgTWF0aC5hYnMoc2VsZi5zdGFydENvb3JkaW5hdGVzLnggLSBjdXJyZW50Q29vcmRpbmF0ZXMueCkgPiAyMCApIHsKICAgICAgICAgIC8vIHVzZXIgc2xpZCB0aGUgdGV4dCBpbnB1dCdzIGNhcmV0IG9uIGl0cyB4IGF4aXMsIGRpc2FibGUgYW55IGZ1dHVyZSB5IHNjcm9sbGluZwogICAgICAgICAgc2VsZi5fX2VuYWJsZVNjcm9sbFkgPSBmYWxzZTsKICAgICAgICAgIHNlbGYuX19pc1NlbGVjdGFibGUgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYoIHNlbGYuX19lbmFibGVTY3JvbGxZICYmIE1hdGguYWJzKHNlbGYuc3RhcnRDb29yZGluYXRlcy55IC0gY3VycmVudENvb3JkaW5hdGVzLnkpID4gMTAgKSB7CiAgICAgICAgICAvLyB1c2VyIHNjcm9sbGVkIHRoZSBlbnRpcmUgdmlldyBvbiB0aGUgeSBheGlzCiAgICAgICAgICAvLyBkaXNhYmxlZCBiZWluZyBhYmxlIHRvIHNlbGVjdCB0ZXh0IG9uIGFuIGlucHV0CiAgICAgICAgICAvLyBoaWRlIHRoZSBpbnB1dCB3aGljaCBoYXMgZm9jdXMsIGFuZCBzaG93IGEgY2xvbmVkIG9uZSB0aGF0IGRvZXNuJ3QgaGF2ZSBmb2N1cwogICAgICAgICAgc2VsZi5fX2lzU2VsZWN0YWJsZSA9IGZhbHNlOwogICAgICAgICAgaW9uaWMudGFwLmNsb25lRm9jdXNlZElucHV0KGNvbnRhaW5lciwgc2VsZik7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWxmLmRvVG91Y2hNb3ZlKGdldEV2ZW50VG91Y2hlcyhlKSwgZS50aW1lU3RhbXAsIGUuc2NhbGUpOwogICAgICBzZWxmLl9faXNEb3duID0gdHJ1ZTsKICAgIH07CgogICAgc2VsZi50b3VjaEVuZCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYoIXNlbGYuX19pc0Rvd24pIHJldHVybjsKCiAgICAgIHNlbGYuZG9Ub3VjaEVuZChlLnRpbWVTdGFtcCk7CiAgICAgIHNlbGYuX19pc0Rvd24gPSBmYWxzZTsKICAgICAgc2VsZi5fX2hhc1N0YXJ0ZWQgPSBmYWxzZTsKICAgICAgc2VsZi5fX2lzU2VsZWN0YWJsZSA9IHRydWU7CiAgICAgIHNlbGYuX19lbmFibGVTY3JvbGxZID0gdHJ1ZTsKCiAgICAgIGlmKCAhc2VsZi5fX2lzRHJhZ2dpbmcgJiYgIXNlbGYuX19pc0RlY2VsZXJhdGluZyAmJiAhc2VsZi5fX2lzQW5pbWF0aW5nICkgewogICAgICAgIGlvbmljLnRhcC5yZW1vdmVDbG9uZWRJbnB1dHMoY29udGFpbmVyLCBzZWxmKTsKICAgICAgfQogICAgfTsKCiAgICBpZiAoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KSB7CiAgICAgIC8vIFRvdWNoIEV2ZW50cwogICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hzdGFydCIsIHNlbGYudG91Y2hTdGFydCwgZmFsc2UpOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaG1vdmUiLCBzZWxmLnRvdWNoTW92ZSwgZmFsc2UpOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaGVuZCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hjYW5jZWwiLCBzZWxmLnRvdWNoRW5kLCBmYWxzZSk7CgogICAgfSBlbHNlIGlmICh3aW5kb3cubmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkKSB7CiAgICAgIC8vIFBvaW50ZXIgRXZlbnRzCiAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHNlbGYudG91Y2hTdGFydCwgZmFsc2UpOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVybW92ZSIsIHNlbGYudG91Y2hNb3ZlLCBmYWxzZSk7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmNhbmNlbCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKCiAgICB9IGVsc2UgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgewogICAgICAvLyBJRTEwLCBXUDggKFBvaW50ZXIgRXZlbnRzKQogICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyRG93biIsIHNlbGYudG91Y2hTdGFydCwgZmFsc2UpOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJNb3ZlIiwgc2VsZi50b3VjaE1vdmUsIGZhbHNlKTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyVXAiLCBzZWxmLnRvdWNoRW5kLCBmYWxzZSk7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlckNhbmNlbCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKCiAgICB9IGVsc2UgewogICAgICAvLyBNb3VzZSBFdmVudHMKICAgICAgdmFyIG1vdXNlZG93biA9IGZhbHNlOwoKICAgICAgc2VsZi5tb3VzZURvd24gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYgKCBpb25pYy50YXAuaWdub3JlU2Nyb2xsU3RhcnQoZSkgfHwgZS50YXJnZXQudGFnTmFtZSA9PT0gJ1NFTEVDVCcgKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHNlbGYuZG9Ub3VjaFN0YXJ0KGdldEV2ZW50VG91Y2hlcyhlKSwgZS50aW1lU3RhbXApOwoKICAgICAgICBpZiggIWlvbmljLnRhcC5pc1RleHRJbnB1dChlLnRhcmdldCkgKSB7CiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIG1vdXNlZG93biA9IHRydWU7CiAgICAgIH07CgogICAgICBzZWxmLm1vdXNlTW92ZSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAoIW1vdXNlZG93biB8fCBlLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNlbGYuZG9Ub3VjaE1vdmUoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCk7CgogICAgICAgIG1vdXNlZG93biA9IHRydWU7CiAgICAgIH07CgogICAgICBzZWxmLm1vdXNlVXAgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYgKCFtb3VzZWRvd24pIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNlbGYuZG9Ub3VjaEVuZChlLnRpbWVTdGFtcCk7CgogICAgICAgIG1vdXNlZG93biA9IGZhbHNlOwogICAgICB9OwoKICAgICAgc2VsZi5tb3VzZVdoZWVsID0gaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIHNjcm9sbFBhcmVudCA9IGlvbmljLkRvbVV0aWwuZ2V0UGFyZW50T3JTZWxmV2l0aENsYXNzKGUudGFyZ2V0LCAnaW9uaWMtc2Nyb2xsJyk7CiAgICAgICAgaWYgKHNjcm9sbFBhcmVudCA9PT0gc2VsZi5fX2NvbnRhaW5lcikgewoKICAgICAgICAgIHNlbGYuaGludFJlc2l6ZSgpOwogICAgICAgICAgc2VsZi5zY3JvbGxCeSgKICAgICAgICAgICAgZS53aGVlbERlbHRhWC9zZWxmLm9wdGlvbnMud2hlZWxEYW1wZW4sCiAgICAgICAgICAgIC1lLndoZWVsRGVsdGFZL3NlbGYub3B0aW9ucy53aGVlbERhbXBlbgogICAgICAgICAgKTsKCiAgICAgICAgICBzZWxmLl9fZmFkZVNjcm9sbGJhcnMoJ2luJyk7CiAgICAgICAgICBjbGVhclRpbWVvdXQoc2VsZi5fX3doZWVsSGlkZUJhclRpbWVvdXQpOwogICAgICAgICAgc2VsZi5fX3doZWVsSGlkZUJhclRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLl9fZmFkZVNjcm9sbGJhcnMoJ291dCcpOwogICAgICAgICAgfSwgMTAwKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIHNlbGYubW91c2VEb3duLCBmYWxzZSk7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHNlbGYubW91c2VNb3ZlLCBmYWxzZSk7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBzZWxmLm1vdXNlVXAsIGZhbHNlKTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIHNlbGYubW91c2VXaGVlbCwgZmFsc2UpOwogICAgfQogIH0sCgogIF9fY2xlYW51cDogZnVuY3Rpb24oKSB7CiAgICB2YXIgY29udGFpbmVyID0gdGhpcy5fX2NvbnRhaW5lcjsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHNlbGYudG91Y2hTdGFydCk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBzZWxmLnRvdWNoTW92ZSk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHNlbGYudG91Y2hFbmQpOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBzZWxmLnRvdWNoQ2FuY2VsKTsKCiAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigicG9pbnRlcmRvd24iLCBzZWxmLnRvdWNoU3RhcnQpOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigicG9pbnRlcm1vdmUiLCBzZWxmLnRvdWNoTW92ZSk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJwb2ludGVydXAiLCBzZWxmLnRvdWNoRW5kKTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInBvaW50ZXJjYW5jZWwiLCBzZWxmLnRvdWNoRW5kKTsKCiAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyRG93biIsIHNlbGYudG91Y2hTdGFydCk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJNb3ZlIiwgc2VsZi50b3VjaE1vdmUpOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyVXAiLCBzZWxmLnRvdWNoRW5kKTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlckNhbmNlbCIsIHNlbGYudG91Y2hFbmQpOwoKICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBzZWxmLm1vdXNlRG93bik7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZW1vdmUiLCBzZWxmLm1vdXNlTW92ZSk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgc2VsZi5tb3VzZVVwKTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCBzZWxmLm1vdXNlV2hlZWwpOwoKICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGxDaGlsZEludG9WaWV3Jywgc2VsZi5zY3JvbGxDaGlsZEludG9WaWV3KTsKICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNldFNjcm9sbFZpZXcnLCBzZWxmLnJlc2V0U2Nyb2xsVmlldyk7CgogICAgaW9uaWMudGFwLnJlbW92ZUNsb25lZElucHV0cyhjb250YWluZXIsIHNlbGYpOwoKICAgIGRlbGV0ZSB0aGlzLl9fY29udGFpbmVyOwogICAgZGVsZXRlIHRoaXMuX19jb250ZW50OwogICAgZGVsZXRlIHRoaXMuX19pbmRpY2F0b3JYOwogICAgZGVsZXRlIHRoaXMuX19pbmRpY2F0b3JZOwogICAgZGVsZXRlIHRoaXMub3B0aW9ucy5lbDsKCiAgICB0aGlzLl9fY2FsbGJhY2sgPSB0aGlzLnNjcm9sbENoaWxkSW50b1ZpZXcgPSB0aGlzLnJlc2V0U2Nyb2xsVmlldyA9IGFuZ3VsYXIubm9vcDsKCiAgICB0aGlzLm1vdXNlTW92ZSA9IHRoaXMubW91c2VEb3duID0gdGhpcy5tb3VzZVVwID0gdGhpcy5tb3VzZVdoZWVsID0KICAgICAgdGhpcy50b3VjaFN0YXJ0ID0gdGhpcy50b3VjaE1vdmUgPSB0aGlzLnRvdWNoRW5kID0gdGhpcy50b3VjaENhbmNlbCA9IGFuZ3VsYXIubm9vcDsKCiAgICB0aGlzLnJlc2l6ZSA9IHRoaXMuc2Nyb2xsVG8gPSB0aGlzLnpvb21UbyA9CiAgICAgIHRoaXMuX19zY3JvbGxpbmdDb21wbGV0ZSA9IGFuZ3VsYXIubm9vcDsKICAgIGNvbnRhaW5lciA9IG51bGw7CiAgfSwKCiAgLyoqIENyZWF0ZSBhIHNjcm9sbCBiYXIgZGl2IHdpdGggdGhlIGdpdmVuIGRpcmVjdGlvbiAqKi8KICBfX2NyZWF0ZVNjcm9sbGJhcjogZnVuY3Rpb24oZGlyZWN0aW9uKSB7CiAgICB2YXIgYmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCiAgICAgIGluZGljYXRvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKICAgIGluZGljYXRvci5jbGFzc05hbWUgPSAnc2Nyb2xsLWJhci1pbmRpY2F0b3InOwoKICAgIGlmKGRpcmVjdGlvbiA9PSAnaCcpIHsKICAgICAgYmFyLmNsYXNzTmFtZSA9ICdzY3JvbGwtYmFyIHNjcm9sbC1iYXItaCc7CiAgICB9IGVsc2UgewogICAgICBiYXIuY2xhc3NOYW1lID0gJ3Njcm9sbC1iYXIgc2Nyb2xsLWJhci12JzsKICAgIH0KCiAgICBiYXIuYXBwZW5kQ2hpbGQoaW5kaWNhdG9yKTsKICAgIHJldHVybiBiYXI7CiAgfSwKCiAgX19jcmVhdGVTY3JvbGxiYXJzOiBmdW5jdGlvbigpIHsKICAgIHZhciBpbmRpY2F0b3JYLCBpbmRpY2F0b3JZOwoKICAgIGlmKHRoaXMub3B0aW9ucy5zY3JvbGxpbmdYKSB7CiAgICAgIGluZGljYXRvclggPSB7CiAgICAgICAgZWw6IHRoaXMuX19jcmVhdGVTY3JvbGxiYXIoJ2gnKSwKICAgICAgICBzaXplUmF0aW86IDEKICAgICAgfTsKICAgICAgaW5kaWNhdG9yWC5pbmRpY2F0b3IgPSBpbmRpY2F0b3JYLmVsLmNoaWxkcmVuWzBdOwoKICAgICAgaWYodGhpcy5vcHRpb25zLnNjcm9sbGJhclgpIHsKICAgICAgICB0aGlzLl9fY29udGFpbmVyLmFwcGVuZENoaWxkKGluZGljYXRvclguZWwpOwogICAgICB9CiAgICAgIHRoaXMuX19pbmRpY2F0b3JYID0gaW5kaWNhdG9yWDsKICAgIH0KCiAgICBpZih0aGlzLm9wdGlvbnMuc2Nyb2xsaW5nWSkgewogICAgICBpbmRpY2F0b3JZID0gewogICAgICAgIGVsOiB0aGlzLl9fY3JlYXRlU2Nyb2xsYmFyKCd2JyksCiAgICAgICAgc2l6ZVJhdGlvOiAxCiAgICAgIH07CiAgICAgIGluZGljYXRvclkuaW5kaWNhdG9yID0gaW5kaWNhdG9yWS5lbC5jaGlsZHJlblswXTsKCiAgICAgIGlmKHRoaXMub3B0aW9ucy5zY3JvbGxiYXJZKSB7CiAgICAgICAgdGhpcy5fX2NvbnRhaW5lci5hcHBlbmRDaGlsZChpbmRpY2F0b3JZLmVsKTsKICAgICAgfQogICAgICB0aGlzLl9faW5kaWNhdG9yWSA9IGluZGljYXRvclk7CiAgICB9CiAgfSwKCiAgX19yZXNpemVTY3JvbGxiYXJzOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBVcGRhdGUgaG9yaXogYmFyCiAgICBpZihzZWxmLl9faW5kaWNhdG9yWCkgewogICAgICB2YXIgd2lkdGggPSBNYXRoLm1heChNYXRoLnJvdW5kKHNlbGYuX19jbGllbnRXaWR0aCAqIHNlbGYuX19jbGllbnRXaWR0aCAvIChzZWxmLl9fY29udGVudFdpZHRoKSksIDIwKTsKICAgICAgaWYod2lkdGggPiBzZWxmLl9fY29udGVudFdpZHRoKSB7CiAgICAgICAgd2lkdGggPSAwOwogICAgICB9CiAgICAgIHNlbGYuX19pbmRpY2F0b3JYLnNpemUgPSB3aWR0aDsKICAgICAgc2VsZi5fX2luZGljYXRvclgubWluU2NhbGUgPSB0aGlzLm9wdGlvbnMubWluU2Nyb2xsYmFyU2l6ZVggLyB3aWR0aDsKICAgICAgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICBzZWxmLl9faW5kaWNhdG9yWC5tYXhQb3MgPSBzZWxmLl9fY2xpZW50V2lkdGggLSB3aWR0aDsKICAgICAgc2VsZi5fX2luZGljYXRvclguc2l6ZVJhdGlvID0gc2VsZi5fX21heFNjcm9sbExlZnQgPyBzZWxmLl9faW5kaWNhdG9yWC5tYXhQb3MgLyBzZWxmLl9fbWF4U2Nyb2xsTGVmdCA6IDE7CiAgICB9CgogICAgLy8gVXBkYXRlIHZlcnQgYmFyCiAgICBpZihzZWxmLl9faW5kaWNhdG9yWSkgewogICAgICB2YXIgaGVpZ2h0ID0gTWF0aC5tYXgoTWF0aC5yb3VuZChzZWxmLl9fY2xpZW50SGVpZ2h0ICogc2VsZi5fX2NsaWVudEhlaWdodCAvIChzZWxmLl9fY29udGVudEhlaWdodCkpLCAyMCk7CiAgICAgIGlmKGhlaWdodCA+IHNlbGYuX19jb250ZW50SGVpZ2h0KSB7CiAgICAgICAgaGVpZ2h0ID0gMDsKICAgICAgfQogICAgICBzZWxmLl9faW5kaWNhdG9yWS5zaXplID0gaGVpZ2h0OwogICAgICBzZWxmLl9faW5kaWNhdG9yWS5taW5TY2FsZSA9IHRoaXMub3B0aW9ucy5taW5TY3JvbGxiYXJTaXplWSAvIGhlaWdodDsKICAgICAgc2VsZi5fX2luZGljYXRvclkubWF4UG9zID0gc2VsZi5fX2NsaWVudEhlaWdodCAtIGhlaWdodDsKICAgICAgc2VsZi5fX2luZGljYXRvclkuaW5kaWNhdG9yLnN0eWxlLmhlaWdodCA9IGhlaWdodCArICdweCc7CiAgICAgIHNlbGYuX19pbmRpY2F0b3JZLnNpemVSYXRpbyA9IHNlbGYuX19tYXhTY3JvbGxUb3AgPyBzZWxmLl9faW5kaWNhdG9yWS5tYXhQb3MgLyBzZWxmLl9fbWF4U2Nyb2xsVG9wIDogMTsKICAgIH0KICB9LAoKICAvKioKICAgKiBNb3ZlIGFuZCBzY2FsZSB0aGUgc2Nyb2xsYmFycyBhcyB0aGUgcGFnZSBzY3JvbGxzLgogICAqLwogIF9fcmVwb3NpdGlvblNjcm9sbGJhcnM6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzLCB3aWR0aCwgaGVpZ2h0U2NhbGUsCiAgICAgICAgd2lkdGhEaWZmLCBoZWlnaHREaWZmLAogICAgICAgIHgsIHksCiAgICAgICAgeHN0b3AgPSAwLCB5c3RvcCA9IDA7CgogICAgaWYoc2VsZi5fX2luZGljYXRvclgpIHsKICAgICAgLy8gSGFuZGxlIHRoZSBYIHNjcm9sbGJhcgoKICAgICAgLy8gRG9uJ3QgZ28gYWxsIHRoZSB3YXkgdG8gdGhlIHJpZ2h0IGlmIHdlIGhhdmUgYSB2ZXJ0aWNhbCBzY3JvbGxiYXIgYXMgd2VsbAogICAgICBpZihzZWxmLl9faW5kaWNhdG9yWSkgeHN0b3AgPSAxMDsKCiAgICAgIHggPSBNYXRoLnJvdW5kKHNlbGYuX19pbmRpY2F0b3JYLnNpemVSYXRpbyAqIHNlbGYuX19zY3JvbGxMZWZ0KSB8fCAwLAoKICAgICAgLy8gVGhlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdGhlIGxhc3QgY29udGVudCBYIHBvc2l0aW9uLCBhbmQgb3VyIG92ZXJzY3JvbGxlZCBvbmUKICAgICAgd2lkdGhEaWZmID0gc2VsZi5fX3Njcm9sbExlZnQgLSAoc2VsZi5fX21heFNjcm9sbExlZnQgLSB4c3RvcCk7CgogICAgICBpZihzZWxmLl9fc2Nyb2xsTGVmdCA8IDApIHsKCiAgICAgICAgd2lkdGhTY2FsZSA9IE1hdGgubWF4KHNlbGYuX19pbmRpY2F0b3JYLm1pblNjYWxlLAogICAgICAgICAgICAoc2VsZi5fX2luZGljYXRvclguc2l6ZSAtIE1hdGguYWJzKHNlbGYuX19zY3JvbGxMZWZ0KSkgLyBzZWxmLl9faW5kaWNhdG9yWC5zaXplKTsKCiAgICAgICAgLy8gU3RheSBhdCBsZWZ0CiAgICAgICAgeCA9IDA7CgogICAgICAgIC8vIE1ha2Ugc3VyZSBzY2FsZSBpcyB0cmFuc2Zvcm1lZCBmcm9tIHRoZSBsZWZ0L2NlbnRlciBvcmlnaW4gcG9pbnQKICAgICAgICBzZWxmLl9faW5kaWNhdG9yWC5pbmRpY2F0b3Iuc3R5bGVbc2VsZi5fX3RyYW5zZm9ybU9yaWdpblByb3BlcnR5XSA9ICdsZWZ0IGNlbnRlcic7CiAgICAgIH0gZWxzZSBpZih3aWR0aERpZmYgPiAwKSB7CgogICAgICAgIHdpZHRoU2NhbGUgPSBNYXRoLm1heChzZWxmLl9faW5kaWNhdG9yWC5taW5TY2FsZSwKICAgICAgICAgICAgKHNlbGYuX19pbmRpY2F0b3JYLnNpemUgLSB3aWR0aERpZmYpIC8gc2VsZi5fX2luZGljYXRvclguc2l6ZSk7CgogICAgICAgIC8vIFN0YXkgYXQgdGhlIGZ1cnRoZXN0IHggZm9yIHRoZSBzY3JvbGxhYmxlIHZpZXdwb3J0CiAgICAgICAgeCA9IHNlbGYuX19pbmRpY2F0b3JYLm1heFBvcyAtIHhzdG9wOwoKICAgICAgICAvLyBNYWtlIHN1cmUgc2NhbGUgaXMgdHJhbnNmb3JtZWQgZnJvbSB0aGUgcmlnaHQvY2VudGVyIG9yaWdpbiBwb2ludAogICAgICAgIHNlbGYuX19pbmRpY2F0b3JYLmluZGljYXRvci5zdHlsZVtzZWxmLl9fdHJhbnNmb3JtT3JpZ2luUHJvcGVydHldID0gJ3JpZ2h0IGNlbnRlcic7CgogICAgICB9IGVsc2UgewoKICAgICAgICAvLyBOb3JtYWwgbW90aW9uCiAgICAgICAgeCA9IE1hdGgubWluKHNlbGYuX19tYXhTY3JvbGxMZWZ0LCBNYXRoLm1heCgwLCB4KSk7CiAgICAgICAgd2lkdGhTY2FsZSA9IDE7CgogICAgICB9CgogICAgICBzZWxmLl9faW5kaWNhdG9yWC5pbmRpY2F0b3Iuc3R5bGVbc2VsZi5fX3RyYW5zZm9ybVByb3BlcnR5XSA9ICd0cmFuc2xhdGUzZCgnICsgeCArICdweCwgMCwgMCkgc2NhbGVYKCcgKyB3aWR0aFNjYWxlICsgJyknOwogICAgfQoKICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB7CgogICAgICB5ID0gTWF0aC5yb3VuZChzZWxmLl9faW5kaWNhdG9yWS5zaXplUmF0aW8gKiBzZWxmLl9fc2Nyb2xsVG9wKSB8fCAwOwoKICAgICAgLy8gRG9uJ3QgZ28gYWxsIHRoZSB3YXkgdG8gdGhlIHJpZ2h0IGlmIHdlIGhhdmUgYSB2ZXJ0aWNhbCBzY3JvbGxiYXIgYXMgd2VsbAogICAgICBpZihzZWxmLl9faW5kaWNhdG9yWCkgeXN0b3AgPSAxMDsKCiAgICAgIGhlaWdodERpZmYgPSBzZWxmLl9fc2Nyb2xsVG9wIC0gKHNlbGYuX19tYXhTY3JvbGxUb3AgLSB5c3RvcCk7CgogICAgICBpZihzZWxmLl9fc2Nyb2xsVG9wIDwgMCkgewoKICAgICAgICBoZWlnaHRTY2FsZSA9IE1hdGgubWF4KHNlbGYuX19pbmRpY2F0b3JZLm1pblNjYWxlLCAoc2VsZi5fX2luZGljYXRvclkuc2l6ZSAtIE1hdGguYWJzKHNlbGYuX19zY3JvbGxUb3ApKSAvIHNlbGYuX19pbmRpY2F0b3JZLnNpemUpOwoKICAgICAgICAvLyBTdGF5IGF0IHRvcAogICAgICAgIHkgPSAwOwoKICAgICAgICAvLyBNYWtlIHN1cmUgc2NhbGUgaXMgdHJhbnNmb3JtZWQgZnJvbSB0aGUgY2VudGVyL3RvcCBvcmlnaW4gcG9pbnQKICAgICAgICBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3Iuc3R5bGVbc2VsZi5fX3RyYW5zZm9ybU9yaWdpblByb3BlcnR5XSA9ICdjZW50ZXIgdG9wJzsKCiAgICAgIH0gZWxzZSBpZihoZWlnaHREaWZmID4gMCkgewoKICAgICAgICBoZWlnaHRTY2FsZSA9IE1hdGgubWF4KHNlbGYuX19pbmRpY2F0b3JZLm1pblNjYWxlLCAoc2VsZi5fX2luZGljYXRvclkuc2l6ZSAtIGhlaWdodERpZmYpIC8gc2VsZi5fX2luZGljYXRvclkuc2l6ZSk7CgogICAgICAgIC8vIFN0YXkgYXQgYm90dG9tIG9mIHNjcm9sbGFibGUgdmlld3BvcnQKICAgICAgICB5ID0gc2VsZi5fX2luZGljYXRvclkubWF4UG9zIC0geXN0b3A7CgogICAgICAgIC8vIE1ha2Ugc3VyZSBzY2FsZSBpcyB0cmFuc2Zvcm1lZCBmcm9tIHRoZSBjZW50ZXIvYm90dG9tIG9yaWdpbiBwb2ludAogICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5zdHlsZVtzZWxmLl9fdHJhbnNmb3JtT3JpZ2luUHJvcGVydHldID0gJ2NlbnRlciBib3R0b20nOwoKICAgICAgfSBlbHNlIHsKCiAgICAgICAgLy8gTm9ybWFsIG1vdGlvbgogICAgICAgIHkgPSBNYXRoLm1pbihzZWxmLl9fbWF4U2Nyb2xsVG9wLCBNYXRoLm1heCgwLCB5KSk7CiAgICAgICAgaGVpZ2h0U2NhbGUgPSAxOwoKICAgICAgfQoKICAgICAgc2VsZi5fX2luZGljYXRvclkuaW5kaWNhdG9yLnN0eWxlW3NlbGYuX190cmFuc2Zvcm1Qcm9wZXJ0eV0gPSAndHJhbnNsYXRlM2QoMCwnICsgeSArICdweCwgMCkgc2NhbGVZKCcgKyBoZWlnaHRTY2FsZSArICcpJzsKICAgIH0KICB9LAoKICBfX2ZhZGVTY3JvbGxiYXJzOiBmdW5jdGlvbihkaXJlY3Rpb24sIGRlbGF5KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgaWYoIXRoaXMub3B0aW9ucy5zY3JvbGxiYXJzRmFkZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNsYXNzTmFtZSA9ICdzY3JvbGwtYmFyLWZhZGUtb3V0JzsKCiAgICBpZihzZWxmLm9wdGlvbnMuc2Nyb2xsYmFyc0ZhZGUgPT09IHRydWUpIHsKICAgICAgY2xlYXJUaW1lb3V0KHNlbGYuX19zY3JvbGxiYXJGYWRlVGltZW91dCk7CgogICAgICBpZihkaXJlY3Rpb24gPT0gJ2luJykgewogICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JYKSB7IHNlbGYuX19pbmRpY2F0b3JYLmluZGljYXRvci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7IH0KICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWSkgeyBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3IuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOyB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5fX3Njcm9sbGJhckZhZGVUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JYKSB7IHNlbGYuX19pbmRpY2F0b3JYLmluZGljYXRvci5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7IH0KICAgICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB7IHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7IH0KICAgICAgICB9LCBkZWxheSB8fCBzZWxmLm9wdGlvbnMuc2Nyb2xsYmFyRmFkZURlbGF5KTsKICAgICAgfQogICAgfQogIH0sCgogIF9fc2Nyb2xsaW5nQ29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5vcHRpb25zLnNjcm9sbGluZ0NvbXBsZXRlKCk7CiAgICBpb25pYy50YXAucmVtb3ZlQ2xvbmVkSW5wdXRzKHNlbGYuX19jb250YWluZXIsIHNlbGYpOwoKICAgIHNlbGYuX19mYWRlU2Nyb2xsYmFycygnb3V0Jyk7CiAgfSwKCiAgcmVzaXplOiBmdW5jdGlvbigpIHsKICAgIC8vIFVwZGF0ZSBTY3JvbGxlciBkaW1lbnNpb25zIGZvciBjaGFuZ2VkIGNvbnRlbnQKICAgIC8vIEFkZCBwYWRkaW5nIHRvIGJvdHRvbSBvZiBjb250ZW50CiAgICB0aGlzLnNldERpbWVuc2lvbnMoCiAgICAgIHRoaXMuX19jb250YWluZXIuY2xpZW50V2lkdGgsCiAgICAgIHRoaXMuX19jb250YWluZXIuY2xpZW50SGVpZ2h0LAogICAgICB0aGlzLm9wdGlvbnMuZ2V0Q29udGVudFdpZHRoKCksCiAgICAgIHRoaXMub3B0aW9ucy5nZXRDb250ZW50SGVpZ2h0KCkKICAgICk7CiAgfSwKICAvKgogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgUFVCTElDIEFQSQogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICovCgogIGdldFJlbmRlckZuOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgY29udGVudCA9IHRoaXMuX19jb250ZW50OwoKICAgIHZhciBkb2NTdHlsZSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZTsKCiAgICB2YXIgZW5naW5lOwogICAgaWYgKCdNb3pBcHBlYXJhbmNlJyBpbiBkb2NTdHlsZSkgewogICAgICBlbmdpbmUgPSAnZ2Vja28nOwogICAgfSBlbHNlIGlmICgnV2Via2l0QXBwZWFyYW5jZScgaW4gZG9jU3R5bGUpIHsKICAgICAgZW5naW5lID0gJ3dlYmtpdCc7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBuYXZpZ2F0b3IuY3B1Q2xhc3MgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuZ2luZSA9ICd0cmlkZW50JzsKICAgIH0KCiAgICB2YXIgdmVuZG9yUHJlZml4ID0gewogICAgICB0cmlkZW50OiAnbXMnLAogICAgICBnZWNrbzogJ01veicsCiAgICAgIHdlYmtpdDogJ1dlYmtpdCcsCiAgICAgIHByZXN0bzogJ08nCiAgICB9W2VuZ2luZV07CgogICAgdmFyIGhlbHBlckVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHZhciB1bmRlZjsKCiAgICB2YXIgcGVyc3BlY3RpdmVQcm9wZXJ0eSA9IHZlbmRvclByZWZpeCArICJQZXJzcGVjdGl2ZSI7CiAgICB2YXIgdHJhbnNmb3JtUHJvcGVydHkgPSB2ZW5kb3JQcmVmaXggKyAiVHJhbnNmb3JtIjsKICAgIHZhciB0cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eSA9IHZlbmRvclByZWZpeCArICdUcmFuc2Zvcm1PcmlnaW4nOwoKICAgIHNlbGYuX19wZXJzcGVjdGl2ZVByb3BlcnR5ID0gdHJhbnNmb3JtUHJvcGVydHk7CiAgICBzZWxmLl9fdHJhbnNmb3JtUHJvcGVydHkgPSB0cmFuc2Zvcm1Qcm9wZXJ0eTsKICAgIHNlbGYuX190cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eSA9IHRyYW5zZm9ybU9yaWdpblByb3BlcnR5OwoKICAgIGlmIChoZWxwZXJFbGVtLnN0eWxlW3BlcnNwZWN0aXZlUHJvcGVydHldICE9PSB1bmRlZikgewoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGxlZnQsIHRvcCwgem9vbSwgd2FzUmVzaXplKSB7CiAgICAgICAgY29udGVudC5zdHlsZVt0cmFuc2Zvcm1Qcm9wZXJ0eV0gPSAndHJhbnNsYXRlM2QoJyArICgtbGVmdCkgKyAncHgsJyArICgtdG9wKSArICdweCwwKSBzY2FsZSgnICsgem9vbSArICcpJzsKICAgICAgICBzZWxmLl9fcmVwb3NpdGlvblNjcm9sbGJhcnMoKTsKICAgICAgICBpZighd2FzUmVzaXplKSB7CiAgICAgICAgICBzZWxmLnRyaWdnZXJTY3JvbGxFdmVudCgpOwogICAgICAgIH0KICAgICAgfTsKCiAgICB9IGVsc2UgaWYgKGhlbHBlckVsZW0uc3R5bGVbdHJhbnNmb3JtUHJvcGVydHldICE9PSB1bmRlZikgewoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGxlZnQsIHRvcCwgem9vbSwgd2FzUmVzaXplKSB7CiAgICAgICAgY29udGVudC5zdHlsZVt0cmFuc2Zvcm1Qcm9wZXJ0eV0gPSAndHJhbnNsYXRlKCcgKyAoLWxlZnQpICsgJ3B4LCcgKyAoLXRvcCkgKyAncHgpIHNjYWxlKCcgKyB6b29tICsgJyknOwogICAgICAgIHNlbGYuX19yZXBvc2l0aW9uU2Nyb2xsYmFycygpOwogICAgICAgIGlmKCF3YXNSZXNpemUpIHsKICAgICAgICAgIHNlbGYudHJpZ2dlclNjcm9sbEV2ZW50KCk7CiAgICAgICAgfQogICAgICB9OwoKICAgIH0gZWxzZSB7CgogICAgICByZXR1cm4gZnVuY3Rpb24obGVmdCwgdG9wLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgICBjb250ZW50LnN0eWxlLm1hcmdpbkxlZnQgPSBsZWZ0ID8gKC1sZWZ0L3pvb20pICsgJ3B4JyA6ICcnOwogICAgICAgIGNvbnRlbnQuc3R5bGUubWFyZ2luVG9wID0gdG9wID8gKC10b3Avem9vbSkgKyAncHgnIDogJyc7CiAgICAgICAgY29udGVudC5zdHlsZS56b29tID0gem9vbSB8fCAnJzsKICAgICAgICBzZWxmLl9fcmVwb3NpdGlvblNjcm9sbGJhcnMoKTsKICAgICAgICBpZighd2FzUmVzaXplKSB7CiAgICAgICAgICBzZWxmLnRyaWdnZXJTY3JvbGxFdmVudCgpOwogICAgICAgIH0KICAgICAgfTsKCiAgICB9CiAgfSwKCgogIC8qKgogICAqIENvbmZpZ3VyZXMgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIGNsaWVudCAob3V0ZXIpIGFuZCBjb250ZW50IChpbm5lcikgZWxlbWVudHMuCiAgICogUmVxdWlyZXMgdGhlIGF2YWlsYWJsZSBzcGFjZSBmb3IgdGhlIG91dGVyIGVsZW1lbnQgYW5kIHRoZSBvdXRlciBzaXplIG9mIHRoZSBpbm5lciBlbGVtZW50LgogICAqIEFsbCB2YWx1ZXMgd2hpY2ggYXJlIGZhbHN5IChudWxsIG9yIHplcm8gZXRjLikgYXJlIGlnbm9yZWQgYW5kIHRoZSBvbGQgdmFsdWUgaXMga2VwdC4KICAgKgogICAqIEBwYXJhbSBjbGllbnRXaWR0aCB7SW50ZWdlcn0gSW5uZXIgd2lkdGggb2Ygb3V0ZXIgZWxlbWVudAogICAqIEBwYXJhbSBjbGllbnRIZWlnaHQge0ludGVnZXJ9IElubmVyIGhlaWdodCBvZiBvdXRlciBlbGVtZW50CiAgICogQHBhcmFtIGNvbnRlbnRXaWR0aCB7SW50ZWdlcn0gT3V0ZXIgd2lkdGggb2YgaW5uZXIgZWxlbWVudAogICAqIEBwYXJhbSBjb250ZW50SGVpZ2h0IHtJbnRlZ2VyfSBPdXRlciBoZWlnaHQgb2YgaW5uZXIgZWxlbWVudAogICAqLwogIHNldERpbWVuc2lvbnM6IGZ1bmN0aW9uKGNsaWVudFdpZHRoLCBjbGllbnRIZWlnaHQsIGNvbnRlbnRXaWR0aCwgY29udGVudEhlaWdodCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIE9ubHkgdXBkYXRlIHZhbHVlcyB3aGljaCBhcmUgZGVmaW5lZAogICAgaWYgKGNsaWVudFdpZHRoID09PSArY2xpZW50V2lkdGgpIHsKICAgICAgc2VsZi5fX2NsaWVudFdpZHRoID0gY2xpZW50V2lkdGg7CiAgICB9CgogICAgaWYgKGNsaWVudEhlaWdodCA9PT0gK2NsaWVudEhlaWdodCkgewogICAgICBzZWxmLl9fY2xpZW50SGVpZ2h0ID0gY2xpZW50SGVpZ2h0OwogICAgfQoKICAgIGlmIChjb250ZW50V2lkdGggPT09ICtjb250ZW50V2lkdGgpIHsKICAgICAgc2VsZi5fX2NvbnRlbnRXaWR0aCA9IGNvbnRlbnRXaWR0aDsKICAgIH0KCiAgICBpZiAoY29udGVudEhlaWdodCA9PT0gK2NvbnRlbnRIZWlnaHQpIHsKICAgICAgc2VsZi5fX2NvbnRlbnRIZWlnaHQgPSBjb250ZW50SGVpZ2h0OwogICAgfQoKICAgIC8vIFJlZnJlc2ggbWF4aW11bXMKICAgIHNlbGYuX19jb21wdXRlU2Nyb2xsTWF4KCk7CiAgICBzZWxmLl9fcmVzaXplU2Nyb2xsYmFycygpOwoKICAgIC8vIFJlZnJlc2ggc2Nyb2xsIHBvc2l0aW9uCiAgICBzZWxmLnNjcm9sbFRvKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fc2Nyb2xsVG9wLCB0cnVlLCBudWxsLCB0cnVlKTsKCiAgfSwKCgogIC8qKgogICAqIFNldHMgdGhlIGNsaWVudCBjb29yZGluYXRlcyBpbiByZWxhdGlvbiB0byB0aGUgZG9jdW1lbnQuCiAgICoKICAgKiBAcGFyYW0gbGVmdCB7SW50ZWdlcn0gTGVmdCBwb3NpdGlvbiBvZiBvdXRlciBlbGVtZW50CiAgICogQHBhcmFtIHRvcCB7SW50ZWdlcn0gVG9wIHBvc2l0aW9uIG9mIG91dGVyIGVsZW1lbnQKICAgKi8KICBzZXRQb3NpdGlvbjogZnVuY3Rpb24obGVmdCwgdG9wKSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHNlbGYuX19jbGllbnRMZWZ0ID0gbGVmdCB8fCAwOwogICAgc2VsZi5fX2NsaWVudFRvcCA9IHRvcCB8fCAwOwoKICB9LAoKCiAgLyoqCiAgICogQ29uZmlndXJlcyB0aGUgc25hcHBpbmcgKHdoZW4gc25hcHBpbmcgaXMgYWN0aXZlKQogICAqCiAgICogQHBhcmFtIHdpZHRoIHtJbnRlZ2VyfSBTbmFwcGluZyB3aWR0aAogICAqIEBwYXJhbSBoZWlnaHQge0ludGVnZXJ9IFNuYXBwaW5nIGhlaWdodAogICAqLwogIHNldFNuYXBTaXplOiBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHNlbGYuX19zbmFwV2lkdGggPSB3aWR0aDsKICAgIHNlbGYuX19zbmFwSGVpZ2h0ID0gaGVpZ2h0OwoKICB9LAoKCiAgLyoqCiAgICogQWN0aXZhdGVzIHB1bGwtdG8tcmVmcmVzaC4gQSBzcGVjaWFsIHpvbmUgb24gdGhlIHRvcCBvZiB0aGUgbGlzdCB0byBzdGFydCBhIGxpc3QgcmVmcmVzaCB3aGVuZXZlcgogICAqIHRoZSB1c2VyIGV2ZW50IGlzIHJlbGVhc2VkIGR1cmluZyB2aXNpYmlsaXR5IG9mIHRoaXMgem9uZS4gVGhpcyB3YXMgaW50cm9kdWNlZCBieSBzb21lIGFwcHMgb24gaU9TIGxpa2UKICAgKiB0aGUgb2ZmaWNpYWwgVHdpdHRlciBjbGllbnQuCiAgICoKICAgKiBAcGFyYW0gaGVpZ2h0IHtJbnRlZ2VyfSBIZWlnaHQgb2YgcHVsbC10by1yZWZyZXNoIHpvbmUgb24gdG9wIG9mIHJlbmRlcmVkIGxpc3QKICAgKiBAcGFyYW0gYWN0aXZhdGVDYWxsYmFjayB7RnVuY3Rpb259IENhbGxiYWNrIHRvIGV4ZWN1dGUgb24gYWN0aXZhdGlvbi4gVGhpcyBpcyBmb3Igc2lnbmFsbGluZyB0aGUgdXNlciBhYm91dCBhIHJlZnJlc2ggaXMgYWJvdXQgdG8gaGFwcGVuIHdoZW4gaGUgcmVsZWFzZS4KICAgKiBAcGFyYW0gZGVhY3RpdmF0ZUNhbGxiYWNrIHtGdW5jdGlvbn0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbiBkZWFjdGl2YXRpb24uIFRoaXMgaXMgZm9yIHNpZ25hbGxpbmcgdGhlIHVzZXIgYWJvdXQgdGhlIHJlZnJlc2ggYmVpbmcgY2FuY2VsbGVkLgogICAqIEBwYXJhbSBzdGFydENhbGxiYWNrIHtGdW5jdGlvbn0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSB0byBzdGFydCB0aGUgcmVhbCBhc3luYyByZWZyZXNoIGFjdGlvbi4gQ2FsbCB7QGxpbmsgI2ZpbmlzaFB1bGxUb1JlZnJlc2h9IGFmdGVyIGZpbmlzaCBvZiByZWZyZXNoLgogICAqIEBwYXJhbSBzaG93Q2FsbGJhY2sge0Z1bmN0aW9ufSBDYWxsYmFjayB0byBleGVjdXRlIHdoZW4gdGhlIHJlZnJlc2hlciBzaG91bGQgYmUgc2hvd24uIFRoaXMgaXMgZm9yIHNob3dpbmcgdGhlIHJlZnJlc2hlciBkdXJpbmcgYSBuZWdhdGl2ZSBzY3JvbGxUb3AuCiAgICogQHBhcmFtIGhpZGVDYWxsYmFjayB7RnVuY3Rpb259IENhbGxiYWNrIHRvIGV4ZWN1dGUgd2hlbiB0aGUgcmVmcmVzaGVyIHNob3VsZCBiZSBoaWRkZW4uIFRoaXMgaXMgZm9yIGhpZGluZyB0aGUgcmVmcmVzaGVyIHdoZW4gaXQncyBiZWhpbmQgdGhlIG5hdiBiYXIuCiAgICovCiAgYWN0aXZhdGVQdWxsVG9SZWZyZXNoOiBmdW5jdGlvbihoZWlnaHQsIGFjdGl2YXRlQ2FsbGJhY2ssIGRlYWN0aXZhdGVDYWxsYmFjaywgc3RhcnRDYWxsYmFjaywgc2hvd0NhbGxiYWNrLCBoaWRlQ2FsbGJhY2spIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgc2VsZi5fX3JlZnJlc2hIZWlnaHQgPSBoZWlnaHQ7CiAgICBzZWxmLl9fcmVmcmVzaEFjdGl2YXRlID0gYWN0aXZhdGVDYWxsYmFjazsKICAgIHNlbGYuX19yZWZyZXNoRGVhY3RpdmF0ZSA9IGRlYWN0aXZhdGVDYWxsYmFjazsKICAgIHNlbGYuX19yZWZyZXNoU3RhcnQgPSBzdGFydENhbGxiYWNrOwogICAgc2VsZi5fX3JlZnJlc2hTaG93ID0gc2hvd0NhbGxiYWNrOwogICAgc2VsZi5fX3JlZnJlc2hIaWRlID0gaGlkZUNhbGxiYWNrOwogIH0sCgoKICAvKioKICAgKiBTdGFydHMgcHVsbC10by1yZWZyZXNoIG1hbnVhbGx5LgogICAqLwogIHRyaWdnZXJQdWxsVG9SZWZyZXNoOiBmdW5jdGlvbigpIHsKICAgIC8vIFVzZSBwdWJsaXNoIGluc3RlYWQgb2Ygc2Nyb2xsVG8gdG8gYWxsb3cgc2Nyb2xsaW5nIHRvIG91dCBvZiBib3VuZGFyeSBwb3NpdGlvbgogICAgLy8gV2UgZG9uJ3QgbmVlZCB0byBub3JtYWxpemUgc2Nyb2xsTGVmdCwgem9vbUxldmVsLCBldGMuIGhlcmUgYmVjYXVzZSB3ZSBvbmx5IHktc2Nyb2xsaW5nIHdoZW4gcHVsbC10by1yZWZyZXNoIGlzIGVuYWJsZWQKICAgIHRoaXMuX19wdWJsaXNoKHRoaXMuX19zY3JvbGxMZWZ0LCAtdGhpcy5fX3JlZnJlc2hIZWlnaHQsIHRoaXMuX196b29tTGV2ZWwsIHRydWUpOwoKICAgIGlmICh0aGlzLl9fcmVmcmVzaFN0YXJ0KSB7CiAgICAgIHRoaXMuX19yZWZyZXNoU3RhcnQoKTsKICAgIH0KICB9LAoKCiAgLyoqCiAgICogU2lnbmFsaXplcyB0aGF0IHB1bGwtdG8tcmVmcmVzaCBpcyBmaW5pc2hlZC4KICAgKi8KICBmaW5pc2hQdWxsVG9SZWZyZXNoOiBmdW5jdGlvbigpIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgc2VsZi5fX3JlZnJlc2hBY3RpdmUgPSBmYWxzZTsKICAgIGlmIChzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUpIHsKICAgICAgc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKCk7CiAgICB9CgogICAgc2VsZi5zY3JvbGxUbyhzZWxmLl9fc2Nyb2xsTGVmdCwgc2VsZi5fX3Njcm9sbFRvcCwgdHJ1ZSk7CgogIH0sCgoKICAvKioKICAgKiBSZXR1cm5zIHRoZSBzY3JvbGwgcG9zaXRpb24gYW5kIHpvb21pbmcgdmFsdWVzCiAgICoKICAgKiBAcmV0dXJuIHtNYXB9IGBsZWZ0YCBhbmQgYHRvcGAgc2Nyb2xsIHBvc2l0aW9uIGFuZCBgem9vbWAgbGV2ZWwKICAgKi8KICBnZXRWYWx1ZXM6IGZ1bmN0aW9uKCkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICByZXR1cm4gewogICAgICBsZWZ0OiBzZWxmLl9fc2Nyb2xsTGVmdCwKICAgICAgdG9wOiBzZWxmLl9fc2Nyb2xsVG9wLAogICAgICB6b29tOiBzZWxmLl9fem9vbUxldmVsCiAgICB9OwoKICB9LAoKCiAgLyoqCiAgICogUmV0dXJucyB0aGUgbWF4aW11bSBzY3JvbGwgdmFsdWVzCiAgICoKICAgKiBAcmV0dXJuIHtNYXB9IGBsZWZ0YCBhbmQgYHRvcGAgbWF4aW11bSBzY3JvbGwgdmFsdWVzCiAgICovCiAgZ2V0U2Nyb2xsTWF4OiBmdW5jdGlvbigpIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgcmV0dXJuIHsKICAgICAgbGVmdDogc2VsZi5fX21heFNjcm9sbExlZnQsCiAgICAgIHRvcDogc2VsZi5fX21heFNjcm9sbFRvcAogICAgfTsKCiAgfSwKCgogIC8qKgogICAqIFpvb21zIHRvIHRoZSBnaXZlbiBsZXZlbC4gU3VwcG9ydHMgb3B0aW9uYWwgYW5pbWF0aW9uLiBab29tcwogICAqIHRoZSBjZW50ZXIgd2hlbiBubyBjb29yZGluYXRlcyBhcmUgZ2l2ZW4uCiAgICoKICAgKiBAcGFyYW0gbGV2ZWwge051bWJlcn0gTGV2ZWwgdG8gem9vbSB0bwogICAqIEBwYXJhbSBhbmltYXRlIHtCb29sZWFufSBXaGV0aGVyIHRvIHVzZSBhbmltYXRpb24KICAgKiBAcGFyYW0gb3JpZ2luTGVmdCB7TnVtYmVyfSBab29tIGluIGF0IGdpdmVuIGxlZnQgY29vcmRpbmF0ZQogICAqIEBwYXJhbSBvcmlnaW5Ub3Age051bWJlcn0gWm9vbSBpbiBhdCBnaXZlbiB0b3AgY29vcmRpbmF0ZQogICAqLwogIHpvb21UbzogZnVuY3Rpb24obGV2ZWwsIGFuaW1hdGUsIG9yaWdpbkxlZnQsIG9yaWdpblRvcCkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBpZiAoIXNlbGYub3B0aW9ucy56b29taW5nKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiWm9vbWluZyBpcyBub3QgZW5hYmxlZCEiKTsKICAgIH0KCiAgICAvLyBTdG9wIGRlY2VsZXJhdGlvbgogICAgaWYgKHNlbGYuX19pc0RlY2VsZXJhdGluZykgewogICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RvcChzZWxmLl9faXNEZWNlbGVyYXRpbmcpOwogICAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSBmYWxzZTsKICAgIH0KCiAgICB2YXIgb2xkTGV2ZWwgPSBzZWxmLl9fem9vbUxldmVsOwoKICAgIC8vIE5vcm1hbGl6ZSBpbnB1dCBvcmlnaW4gdG8gY2VudGVyIG9mIHZpZXdwb3J0IGlmIG5vdCBkZWZpbmVkCiAgICBpZiAob3JpZ2luTGVmdCA9PSBudWxsKSB7CiAgICAgIG9yaWdpbkxlZnQgPSBzZWxmLl9fY2xpZW50V2lkdGggLyAyOwogICAgfQoKICAgIGlmIChvcmlnaW5Ub3AgPT0gbnVsbCkgewogICAgICBvcmlnaW5Ub3AgPSBzZWxmLl9fY2xpZW50SGVpZ2h0IC8gMjsKICAgIH0KCiAgICAvLyBMaW1pdCBsZXZlbCBhY2NvcmRpbmcgdG8gY29uZmlndXJhdGlvbgogICAgbGV2ZWwgPSBNYXRoLm1heChNYXRoLm1pbihsZXZlbCwgc2VsZi5vcHRpb25zLm1heFpvb20pLCBzZWxmLm9wdGlvbnMubWluWm9vbSk7CgogICAgLy8gUmVjb21wdXRlIG1heGltdW0gdmFsdWVzIHdoaWxlIHRlbXBvcmFyeSB0d2Vha2luZyBtYXhpbXVtIHNjcm9sbCByYW5nZXMKICAgIHNlbGYuX19jb21wdXRlU2Nyb2xsTWF4KGxldmVsKTsKCiAgICAvLyBSZWNvbXB1dGUgbGVmdCBhbmQgdG9wIGNvb3JkaW5hdGVzIGJhc2VkIG9uIG5ldyB6b29tIGxldmVsCiAgICB2YXIgbGVmdCA9ICgob3JpZ2luTGVmdCArIHNlbGYuX19zY3JvbGxMZWZ0KSAqIGxldmVsIC8gb2xkTGV2ZWwpIC0gb3JpZ2luTGVmdDsKICAgIHZhciB0b3AgPSAoKG9yaWdpblRvcCArIHNlbGYuX19zY3JvbGxUb3ApICogbGV2ZWwgLyBvbGRMZXZlbCkgLSBvcmlnaW5Ub3A7CgogICAgLy8gTGltaXQgeC1heGlzCiAgICBpZiAobGVmdCA+IHNlbGYuX19tYXhTY3JvbGxMZWZ0KSB7CiAgICAgIGxlZnQgPSBzZWxmLl9fbWF4U2Nyb2xsTGVmdDsKICAgIH0gZWxzZSBpZiAobGVmdCA8IDApIHsKICAgICAgbGVmdCA9IDA7CiAgICB9CgogICAgLy8gTGltaXQgeS1heGlzCiAgICBpZiAodG9wID4gc2VsZi5fX21heFNjcm9sbFRvcCkgewogICAgICB0b3AgPSBzZWxmLl9fbWF4U2Nyb2xsVG9wOwogICAgfSBlbHNlIGlmICh0b3AgPCAwKSB7CiAgICAgIHRvcCA9IDA7CiAgICB9CgogICAgLy8gUHVzaCB2YWx1ZXMgb3V0CiAgICBzZWxmLl9fcHVibGlzaChsZWZ0LCB0b3AsIGxldmVsLCBhbmltYXRlKTsKCiAgfSwKCgogIC8qKgogICAqIFpvb21zIHRoZSBjb250ZW50IGJ5IHRoZSBnaXZlbiBmYWN0b3IuCiAgICoKICAgKiBAcGFyYW0gZmFjdG9yIHtOdW1iZXJ9IFpvb20gYnkgZ2l2ZW4gZmFjdG9yCiAgICogQHBhcmFtIGFuaW1hdGUge0Jvb2xlYW59IFdoZXRoZXIgdG8gdXNlIGFuaW1hdGlvbgogICAqIEBwYXJhbSBvcmlnaW5MZWZ0IHtOdW1iZXJ9IFpvb20gaW4gYXQgZ2l2ZW4gbGVmdCBjb29yZGluYXRlCiAgICogQHBhcmFtIG9yaWdpblRvcCB7TnVtYmVyfSBab29tIGluIGF0IGdpdmVuIHRvcCBjb29yZGluYXRlCiAgICovCiAgem9vbUJ5OiBmdW5jdGlvbihmYWN0b3IsIGFuaW1hdGUsIG9yaWdpbkxlZnQsIG9yaWdpblRvcCkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBzZWxmLnpvb21UbyhzZWxmLl9fem9vbUxldmVsICogZmFjdG9yLCBhbmltYXRlLCBvcmlnaW5MZWZ0LCBvcmlnaW5Ub3ApOwoKICB9LAoKCiAgLyoqCiAgICogU2Nyb2xscyB0byB0aGUgZ2l2ZW4gcG9zaXRpb24uIFJlc3BlY3QgbGltaXRhdGlvbnMgYW5kIHNuYXBwaW5nIGF1dG9tYXRpY2FsbHkuCiAgICoKICAgKiBAcGFyYW0gbGVmdCB7TnVtYmVyfSBIb3Jpem9udGFsIHNjcm9sbCBwb3NpdGlvbiwga2VlcHMgY3VycmVudCBpZiB2YWx1ZSBpcyA8Y29kZT5udWxsPC9jb2RlPgogICAqIEBwYXJhbSB0b3Age051bWJlcn0gVmVydGljYWwgc2Nyb2xsIHBvc2l0aW9uLCBrZWVwcyBjdXJyZW50IGlmIHZhbHVlIGlzIDxjb2RlPm51bGw8L2NvZGU+CiAgICogQHBhcmFtIGFuaW1hdGUge0Jvb2xlYW59IFdoZXRoZXIgdGhlIHNjcm9sbGluZyBzaG91bGQgaGFwcGVuIHVzaW5nIGFuIGFuaW1hdGlvbgogICAqIEBwYXJhbSB6b29tIHtOdW1iZXJ9IFpvb20gbGV2ZWwgdG8gZ28gdG8KICAgKi8KICBzY3JvbGxUbzogZnVuY3Rpb24obGVmdCwgdG9wLCBhbmltYXRlLCB6b29tLCB3YXNSZXNpemUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBTdG9wIGRlY2VsZXJhdGlvbgogICAgaWYgKHNlbGYuX19pc0RlY2VsZXJhdGluZykgewogICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RvcChzZWxmLl9faXNEZWNlbGVyYXRpbmcpOwogICAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSBmYWxzZTsKICAgIH0KCiAgICAvLyBDb3JyZWN0IGNvb3JkaW5hdGVzIGJhc2VkIG9uIG5ldyB6b29tIGxldmVsCiAgICBpZiAoem9vbSAhPSBudWxsICYmIHpvb20gIT09IHNlbGYuX196b29tTGV2ZWwpIHsKCiAgICAgIGlmICghc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlpvb21pbmcgaXMgbm90IGVuYWJsZWQhIik7CiAgICAgIH0KCiAgICAgIGxlZnQgKj0gem9vbTsKICAgICAgdG9wICo9IHpvb207CgogICAgICAvLyBSZWNvbXB1dGUgbWF4aW11bSB2YWx1ZXMgd2hpbGUgdGVtcG9yYXJ5IHR3ZWFraW5nIG1heGltdW0gc2Nyb2xsIHJhbmdlcwogICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heCh6b29tKTsKCiAgICB9IGVsc2UgewoKICAgICAgLy8gS2VlcCB6b29tIHdoZW4gbm90IGRlZmluZWQKICAgICAgem9vbSA9IHNlbGYuX196b29tTGV2ZWw7CgogICAgfQoKICAgIGlmICghc2VsZi5vcHRpb25zLnNjcm9sbGluZ1gpIHsKCiAgICAgIGxlZnQgPSBzZWxmLl9fc2Nyb2xsTGVmdDsKCiAgICB9IGVsc2UgewoKICAgICAgaWYgKHNlbGYub3B0aW9ucy5wYWdpbmcpIHsKICAgICAgICBsZWZ0ID0gTWF0aC5yb3VuZChsZWZ0IC8gc2VsZi5fX2NsaWVudFdpZHRoKSAqIHNlbGYuX19jbGllbnRXaWR0aDsKICAgICAgfSBlbHNlIGlmIChzZWxmLm9wdGlvbnMuc25hcHBpbmcpIHsKICAgICAgICBsZWZ0ID0gTWF0aC5yb3VuZChsZWZ0IC8gc2VsZi5fX3NuYXBXaWR0aCkgKiBzZWxmLl9fc25hcFdpZHRoOwogICAgICB9CgogICAgfQoKICAgIGlmICghc2VsZi5vcHRpb25zLnNjcm9sbGluZ1kpIHsKCiAgICAgIHRvcCA9IHNlbGYuX19zY3JvbGxUb3A7CgogICAgfSBlbHNlIHsKCiAgICAgIGlmIChzZWxmLm9wdGlvbnMucGFnaW5nKSB7CiAgICAgICAgdG9wID0gTWF0aC5yb3VuZCh0b3AgLyBzZWxmLl9fY2xpZW50SGVpZ2h0KSAqIHNlbGYuX19jbGllbnRIZWlnaHQ7CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5vcHRpb25zLnNuYXBwaW5nKSB7CiAgICAgICAgdG9wID0gTWF0aC5yb3VuZCh0b3AgLyBzZWxmLl9fc25hcEhlaWdodCkgKiBzZWxmLl9fc25hcEhlaWdodDsKICAgICAgfQoKICAgIH0KCiAgICAvLyBMaW1pdCBmb3IgYWxsb3dlZCByYW5nZXMKICAgIGxlZnQgPSBNYXRoLm1heChNYXRoLm1pbihzZWxmLl9fbWF4U2Nyb2xsTGVmdCwgbGVmdCksIDApOwogICAgdG9wID0gTWF0aC5tYXgoTWF0aC5taW4oc2VsZi5fX21heFNjcm9sbFRvcCwgdG9wKSwgMCk7CgogICAgLy8gRG9uJ3QgYW5pbWF0ZSB3aGVuIG5vIGNoYW5nZSBkZXRlY3RlZCwgc3RpbGwgY2FsbCBwdWJsaXNoIHRvIG1ha2Ugc3VyZQogICAgLy8gdGhhdCByZW5kZXJlZCBwb3NpdGlvbiBpcyByZWFsbHkgaW4tc3luYyB3aXRoIGludGVybmFsIGRhdGEKICAgIGlmIChsZWZ0ID09PSBzZWxmLl9fc2Nyb2xsTGVmdCAmJiB0b3AgPT09IHNlbGYuX19zY3JvbGxUb3ApIHsKICAgICAgYW5pbWF0ZSA9IGZhbHNlOwogICAgfQoKICAgIC8vIFB1Ymxpc2ggbmV3IHZhbHVlcwogICAgc2VsZi5fX3B1Ymxpc2gobGVmdCwgdG9wLCB6b29tLCBhbmltYXRlLCB3YXNSZXNpemUpOwoKICB9LAoKCiAgLyoqCiAgICogU2Nyb2xsIGJ5IHRoZSBnaXZlbiBvZmZzZXQKICAgKgogICAqIEBwYXJhbSBsZWZ0IHtOdW1iZXJ9IFNjcm9sbCB4LWF4aXMgYnkgZ2l2ZW4gb2Zmc2V0CiAgICogQHBhcmFtIHRvcCB7TnVtYmVyfSBTY3JvbGwgeS1heGlzIGJ5IGdpdmVuIG9mZnNldAogICAqIEBwYXJhbSBhbmltYXRlIHtCb29sZWFufSBXaGV0aGVyIHRvIGFuaW1hdGUgdGhlIGdpdmVuIGNoYW5nZQogICAqLwogIHNjcm9sbEJ5OiBmdW5jdGlvbihsZWZ0LCB0b3AsIGFuaW1hdGUpIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIHN0YXJ0TGVmdCA9IHNlbGYuX19pc0FuaW1hdGluZyA/IHNlbGYuX19zY2hlZHVsZWRMZWZ0IDogc2VsZi5fX3Njcm9sbExlZnQ7CiAgICB2YXIgc3RhcnRUb3AgPSBzZWxmLl9faXNBbmltYXRpbmcgPyBzZWxmLl9fc2NoZWR1bGVkVG9wIDogc2VsZi5fX3Njcm9sbFRvcDsKCiAgICBzZWxmLnNjcm9sbFRvKHN0YXJ0TGVmdCArIChsZWZ0IHx8IDApLCBzdGFydFRvcCArICh0b3AgfHwgMCksIGFuaW1hdGUpOwoKICB9LAoKCgogIC8qCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBFVkVOVCBDQUxMQkFDS1MKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqLwoKICAvKioKICAgKiBNb3VzZSB3aGVlbCBoYW5kbGVyIGZvciB6b29taW5nIHN1cHBvcnQKICAgKi8KICBkb01vdXNlWm9vbTogZnVuY3Rpb24od2hlZWxEZWx0YSwgdGltZVN0YW1wLCBwYWdlWCwgcGFnZVkpIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2hhbmdlID0gd2hlZWxEZWx0YSA+IDAgPyAwLjk3IDogMS4wMzsKCiAgICByZXR1cm4gc2VsZi56b29tVG8oc2VsZi5fX3pvb21MZXZlbCAqIGNoYW5nZSwgZmFsc2UsIHBhZ2VYIC0gc2VsZi5fX2NsaWVudExlZnQsIHBhZ2VZIC0gc2VsZi5fX2NsaWVudFRvcCk7CgogIH0sCgogIC8qKgogICAqIFRvdWNoIHN0YXJ0IGhhbmRsZXIgZm9yIHNjcm9sbGluZyBzdXBwb3J0CiAgICovCiAgZG9Ub3VjaFN0YXJ0OiBmdW5jdGlvbih0b3VjaGVzLCB0aW1lU3RhbXApIHsKICAgIHRoaXMuaGludFJlc2l6ZSgpOwoKICAgIGlmICh0aW1lU3RhbXAgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgIHRpbWVTdGFtcCA9IHRpbWVTdGFtcC52YWx1ZU9mKCk7CiAgICB9CiAgICBpZiAodHlwZW9mIHRpbWVTdGFtcCAhPT0gIm51bWJlciIpIHsKICAgICAgdGltZVN0YW1wID0gRGF0ZS5ub3coKTsKICAgIH0KCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgLy8gUmVzZXQgaW50ZXJydXB0ZWRBbmltYXRpb24gZmxhZwogICAgc2VsZi5fX2ludGVycnVwdGVkQW5pbWF0aW9uID0gdHJ1ZTsKCiAgICAvLyBTdG9wIGRlY2VsZXJhdGlvbgogICAgaWYgKHNlbGYuX19pc0RlY2VsZXJhdGluZykgewogICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RvcChzZWxmLl9faXNEZWNlbGVyYXRpbmcpOwogICAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSBmYWxzZTsKICAgICAgc2VsZi5fX2ludGVycnVwdGVkQW5pbWF0aW9uID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBTdG9wIGFuaW1hdGlvbgogICAgaWYgKHNlbGYuX19pc0FuaW1hdGluZykgewogICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RvcChzZWxmLl9faXNBbmltYXRpbmcpOwogICAgICBzZWxmLl9faXNBbmltYXRpbmcgPSBmYWxzZTsKICAgICAgc2VsZi5fX2ludGVycnVwdGVkQW5pbWF0aW9uID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBVc2UgY2VudGVyIHBvaW50IHdoZW4gZGVhbGluZyB3aXRoIHR3byBmaW5nZXJzCiAgICB2YXIgY3VycmVudFRvdWNoTGVmdCwgY3VycmVudFRvdWNoVG9wOwogICAgdmFyIGlzU2luZ2xlVG91Y2ggPSB0b3VjaGVzLmxlbmd0aCA9PT0gMTsKICAgIGlmIChpc1NpbmdsZVRvdWNoKSB7CiAgICAgIGN1cnJlbnRUb3VjaExlZnQgPSB0b3VjaGVzWzBdLnBhZ2VYOwogICAgICBjdXJyZW50VG91Y2hUb3AgPSB0b3VjaGVzWzBdLnBhZ2VZOwogICAgfSBlbHNlIHsKICAgICAgY3VycmVudFRvdWNoTGVmdCA9IE1hdGguYWJzKHRvdWNoZXNbMF0ucGFnZVggKyB0b3VjaGVzWzFdLnBhZ2VYKSAvIDI7CiAgICAgIGN1cnJlbnRUb3VjaFRvcCA9IE1hdGguYWJzKHRvdWNoZXNbMF0ucGFnZVkgKyB0b3VjaGVzWzFdLnBhZ2VZKSAvIDI7CiAgICB9CgogICAgLy8gU3RvcmUgaW5pdGlhbCBwb3NpdGlvbnMKICAgIHNlbGYuX19pbml0aWFsVG91Y2hMZWZ0ID0gY3VycmVudFRvdWNoTGVmdDsKICAgIHNlbGYuX19pbml0aWFsVG91Y2hUb3AgPSBjdXJyZW50VG91Y2hUb3A7CgogICAgLy8gU3RvcmUgaW5pdGlhbCB0b3VjaExpc3QgZm9yIHNjYWxlIGNhbGN1bGF0aW9uCiAgICBzZWxmLl9faW5pdGlhbFRvdWNoZXMgPSB0b3VjaGVzOwoKICAgIC8vIFN0b3JlIGN1cnJlbnQgem9vbSBsZXZlbAogICAgc2VsZi5fX3pvb21MZXZlbFN0YXJ0ID0gc2VsZi5fX3pvb21MZXZlbDsKCiAgICAvLyBTdG9yZSBpbml0aWFsIHRvdWNoIHBvc2l0aW9ucwogICAgc2VsZi5fX2xhc3RUb3VjaExlZnQgPSBjdXJyZW50VG91Y2hMZWZ0OwogICAgc2VsZi5fX2xhc3RUb3VjaFRvcCA9IGN1cnJlbnRUb3VjaFRvcDsKCiAgICAvLyBTdG9yZSBpbml0aWFsIG1vdmUgdGltZSBzdGFtcAogICAgc2VsZi5fX2xhc3RUb3VjaE1vdmUgPSB0aW1lU3RhbXA7CgogICAgLy8gUmVzZXQgaW5pdGlhbCBzY2FsZQogICAgc2VsZi5fX2xhc3RTY2FsZSA9IDE7CgogICAgLy8gUmVzZXQgbG9ja2luZyBmbGFncwogICAgc2VsZi5fX2VuYWJsZVNjcm9sbFggPSAhaXNTaW5nbGVUb3VjaCAmJiBzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWDsKICAgIHNlbGYuX19lbmFibGVTY3JvbGxZID0gIWlzU2luZ2xlVG91Y2ggJiYgc2VsZi5vcHRpb25zLnNjcm9sbGluZ1k7CgogICAgLy8gUmVzZXQgdHJhY2tpbmcgZmxhZwogICAgc2VsZi5fX2lzVHJhY2tpbmcgPSB0cnVlOwoKICAgIC8vIFJlc2V0IGRlY2VsZXJhdGlvbiBjb21wbGV0ZSBmbGFnCiAgICBzZWxmLl9fZGlkRGVjZWxlcmF0aW9uQ29tcGxldGUgPSBmYWxzZTsKCiAgICAvLyBEcmFnZ2luZyBzdGFydHMgZGlyZWN0bHkgd2l0aCB0d28gZmluZ2Vycywgb3RoZXJ3aXNlIGxhenkgd2l0aCBhbiBvZmZzZXQKICAgIHNlbGYuX19pc0RyYWdnaW5nID0gIWlzU2luZ2xlVG91Y2g7CgogICAgLy8gU29tZSBmZWF0dXJlcyBhcmUgZGlzYWJsZWQgaW4gbXVsdGkgdG91Y2ggc2NlbmFyaW9zCiAgICBzZWxmLl9faXNTaW5nbGVUb3VjaCA9IGlzU2luZ2xlVG91Y2g7CgogICAgLy8gQ2xlYXJpbmcgZGF0YSBzdHJ1Y3R1cmUKICAgIHNlbGYuX19wb3NpdGlvbnMgPSBbXTsKCiAgfSwKCgogIC8qKgogICAqIFRvdWNoIG1vdmUgaGFuZGxlciBmb3Igc2Nyb2xsaW5nIHN1cHBvcnQKICAgKi8KICBkb1RvdWNoTW92ZTogZnVuY3Rpb24odG91Y2hlcywgdGltZVN0YW1wLCBzY2FsZSkgewogICAgaWYgKHRpbWVTdGFtcCBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgdGltZVN0YW1wID0gdGltZVN0YW1wLnZhbHVlT2YoKTsKICAgIH0KICAgIGlmICh0eXBlb2YgdGltZVN0YW1wICE9PSAibnVtYmVyIikgewogICAgICB0aW1lU3RhbXAgPSBEYXRlLm5vdygpOwogICAgfQoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBJZ25vcmUgZXZlbnQgd2hlbiB0cmFja2luZyBpcyBub3QgZW5hYmxlZCAoZXZlbnQgbWlnaHQgYmUgb3V0c2lkZSBvZiBlbGVtZW50KQogICAgaWYgKCFzZWxmLl9faXNUcmFja2luZykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGN1cnJlbnRUb3VjaExlZnQsIGN1cnJlbnRUb3VjaFRvcDsKCiAgICAvLyBDb21wdXRlIG1vdmUgYmFzZWQgYXJvdW5kIG9mIGNlbnRlciBvZiBmaW5nZXJzCiAgICBpZiAodG91Y2hlcy5sZW5ndGggPT09IDIpIHsKICAgICAgY3VycmVudFRvdWNoTGVmdCA9IE1hdGguYWJzKHRvdWNoZXNbMF0ucGFnZVggKyB0b3VjaGVzWzFdLnBhZ2VYKSAvIDI7CiAgICAgIGN1cnJlbnRUb3VjaFRvcCA9IE1hdGguYWJzKHRvdWNoZXNbMF0ucGFnZVkgKyB0b3VjaGVzWzFdLnBhZ2VZKSAvIDI7CgogICAgICAvLyBDYWxjdWxhdGUgc2NhbGUgd2hlbiBub3QgcHJlc2VudCBhbmQgb25seSB3aGVuIHRvdWNoZXMgYXJlIHVzZWQKICAgICAgaWYgKCFzY2FsZSAmJiBzZWxmLm9wdGlvbnMuem9vbWluZykgewogICAgICAgIHNjYWxlID0gc2VsZi5fX2dldFNjYWxlKHNlbGYuX19pbml0aWFsVG91Y2hlcywgdG91Y2hlcyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGN1cnJlbnRUb3VjaExlZnQgPSB0b3VjaGVzWzBdLnBhZ2VYOwogICAgICBjdXJyZW50VG91Y2hUb3AgPSB0b3VjaGVzWzBdLnBhZ2VZOwogICAgfQoKICAgIHZhciBwb3NpdGlvbnMgPSBzZWxmLl9fcG9zaXRpb25zOwoKICAgIC8vIEFyZSB3ZSBhbHJlYWR5IGlzIGRyYWdnaW5nIG1vZGU/CiAgICBpZiAoc2VsZi5fX2lzRHJhZ2dpbmcpIHsKCiAgICAgIC8vIENvbXB1dGUgbW92ZSBkaXN0YW5jZQogICAgICB2YXIgbW92ZVggPSBjdXJyZW50VG91Y2hMZWZ0IC0gc2VsZi5fX2xhc3RUb3VjaExlZnQ7CiAgICAgIHZhciBtb3ZlWSA9IGN1cnJlbnRUb3VjaFRvcCAtIHNlbGYuX19sYXN0VG91Y2hUb3A7CgogICAgICAvLyBSZWFkIHByZXZpb3VzIHNjcm9sbCBwb3NpdGlvbiBhbmQgem9vbWluZwogICAgICB2YXIgc2Nyb2xsTGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0OwogICAgICB2YXIgc2Nyb2xsVG9wID0gc2VsZi5fX3Njcm9sbFRvcDsKICAgICAgdmFyIGxldmVsID0gc2VsZi5fX3pvb21MZXZlbDsKCiAgICAgIC8vIFdvcmsgd2l0aCBzY2FsaW5nCiAgICAgIGlmIChzY2FsZSAhPSBudWxsICYmIHNlbGYub3B0aW9ucy56b29taW5nKSB7CgogICAgICAgIHZhciBvbGRMZXZlbCA9IGxldmVsOwoKICAgICAgICAvLyBSZWNvbXB1dGUgbGV2ZWwgYmFzZWQgb24gcHJldmlvdXMgc2NhbGUgYW5kIG5ldyBzY2FsZQogICAgICAgIGxldmVsID0gbGV2ZWwgLyBzZWxmLl9fbGFzdFNjYWxlICogc2NhbGU7CgogICAgICAgIC8vIExpbWl0IGxldmVsIGFjY29yZGluZyB0byBjb25maWd1cmF0aW9uCiAgICAgICAgbGV2ZWwgPSBNYXRoLm1heChNYXRoLm1pbihsZXZlbCwgc2VsZi5vcHRpb25zLm1heFpvb20pLCBzZWxmLm9wdGlvbnMubWluWm9vbSk7CgogICAgICAgIC8vIE9ubHkgZG8gZnVydGhlciBjb21wdXRpb24gd2hlbiBjaGFuZ2UgaGFwcGVuZWQKICAgICAgICBpZiAob2xkTGV2ZWwgIT09IGxldmVsKSB7CgogICAgICAgICAgLy8gQ29tcHV0ZSByZWxhdGl2ZSBldmVudCBwb3NpdGlvbiB0byBjb250YWluZXIKICAgICAgICAgIHZhciBjdXJyZW50VG91Y2hMZWZ0UmVsID0gY3VycmVudFRvdWNoTGVmdCAtIHNlbGYuX19jbGllbnRMZWZ0OwogICAgICAgICAgdmFyIGN1cnJlbnRUb3VjaFRvcFJlbCA9IGN1cnJlbnRUb3VjaFRvcCAtIHNlbGYuX19jbGllbnRUb3A7CgogICAgICAgICAgLy8gUmVjb21wdXRlIGxlZnQgYW5kIHRvcCBjb29yZGluYXRlcyBiYXNlZCBvbiBuZXcgem9vbSBsZXZlbAogICAgICAgICAgc2Nyb2xsTGVmdCA9ICgoY3VycmVudFRvdWNoTGVmdFJlbCArIHNjcm9sbExlZnQpICogbGV2ZWwgLyBvbGRMZXZlbCkgLSBjdXJyZW50VG91Y2hMZWZ0UmVsOwogICAgICAgICAgc2Nyb2xsVG9wID0gKChjdXJyZW50VG91Y2hUb3BSZWwgKyBzY3JvbGxUb3ApICogbGV2ZWwgLyBvbGRMZXZlbCkgLSBjdXJyZW50VG91Y2hUb3BSZWw7CgogICAgICAgICAgLy8gUmVjb21wdXRlIG1heCBzY3JvbGwgdmFsdWVzCiAgICAgICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heChsZXZlbCk7CgogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHNlbGYuX19lbmFibGVTY3JvbGxYKSB7CgogICAgICAgIHNjcm9sbExlZnQgLT0gbW92ZVggKiB0aGlzLm9wdGlvbnMuc3BlZWRNdWx0aXBsaWVyOwogICAgICAgIHZhciBtYXhTY3JvbGxMZWZ0ID0gc2VsZi5fX21heFNjcm9sbExlZnQ7CgogICAgICAgIGlmIChzY3JvbGxMZWZ0ID4gbWF4U2Nyb2xsTGVmdCB8fCBzY3JvbGxMZWZ0IDwgMCkgewoKICAgICAgICAgIC8vIFNsb3cgZG93biBvbiB0aGUgZWRnZXMKICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuYm91bmNpbmcpIHsKCiAgICAgICAgICAgIHNjcm9sbExlZnQgKz0gKG1vdmVYIC8gMiAgKiB0aGlzLm9wdGlvbnMuc3BlZWRNdWx0aXBsaWVyKTsKCiAgICAgICAgICB9IGVsc2UgaWYgKHNjcm9sbExlZnQgPiBtYXhTY3JvbGxMZWZ0KSB7CgogICAgICAgICAgICBzY3JvbGxMZWZ0ID0gbWF4U2Nyb2xsTGVmdDsKCiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgc2Nyb2xsTGVmdCA9IDA7CgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ29tcHV0ZSBuZXcgdmVydGljYWwgc2Nyb2xsIHBvc2l0aW9uCiAgICAgIGlmIChzZWxmLl9fZW5hYmxlU2Nyb2xsWSkgewoKICAgICAgICBzY3JvbGxUb3AgLT0gbW92ZVkgKiB0aGlzLm9wdGlvbnMuc3BlZWRNdWx0aXBsaWVyOwogICAgICAgIHZhciBtYXhTY3JvbGxUb3AgPSBzZWxmLl9fbWF4U2Nyb2xsVG9wOwoKICAgICAgICBpZiAoc2Nyb2xsVG9wID4gbWF4U2Nyb2xsVG9wIHx8IHNjcm9sbFRvcCA8IDApIHsKCiAgICAgICAgICAvLyBTbG93IGRvd24gb24gdGhlIGVkZ2VzCiAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmJvdW5jaW5nIHx8IChzZWxmLl9fcmVmcmVzaEhlaWdodCAmJiBzY3JvbGxUb3AgPCAwKSkgewoKICAgICAgICAgICAgc2Nyb2xsVG9wICs9IChtb3ZlWSAvIDIgKiB0aGlzLm9wdGlvbnMuc3BlZWRNdWx0aXBsaWVyKTsKCiAgICAgICAgICAgIC8vIFN1cHBvcnQgcHVsbC10by1yZWZyZXNoIChvbmx5IHdoZW4gb25seSB5IGlzIHNjcm9sbGFibGUpCiAgICAgICAgICAgIGlmICghc2VsZi5fX2VuYWJsZVNjcm9sbFggJiYgc2VsZi5fX3JlZnJlc2hIZWlnaHQgIT0gbnVsbCkgewoKICAgICAgICAgICAgICAvLyBoaWRlIHRoZSByZWZyZXNoZXIgd2hlbiBpdCdzIGJlaGluZCB0aGUgaGVhZGVyIGJhciBpbiBjYXNlIG9mIGhlYWRlciB0cmFuc3BhcmVuY3kKICAgICAgICAgICAgICBpZihzY3JvbGxUb3AgPCAwKXsKICAgICAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoSGlkZGVuID0gZmFsc2U7CiAgICAgICAgICAgICAgICBzZWxmLl9fcmVmcmVzaFNob3coKTsKICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoSGlkZSgpOwogICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hIaWRkZW4gPSB0cnVlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKCFzZWxmLl9fcmVmcmVzaEFjdGl2ZSAmJiBzY3JvbGxUb3AgPD0gLXNlbGYuX19yZWZyZXNoSGVpZ2h0KSB7CgogICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNlbGYuX19yZWZyZXNoQWN0aXZhdGUpIHsKICAgICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmF0ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNlbGYuX19yZWZyZXNoQWN0aXZlICYmIHNjcm9sbFRvcCA+IC1zZWxmLl9fcmVmcmVzaEhlaWdodCkgewoKICAgICAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoQWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKSB7CiAgICAgICAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoRGVhY3RpdmF0ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9IGVsc2UgaWYgKHNjcm9sbFRvcCA+IG1heFNjcm9sbFRvcCkgewoKICAgICAgICAgICAgc2Nyb2xsVG9wID0gbWF4U2Nyb2xsVG9wOwoKICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBzY3JvbGxUb3AgPSAwOwoKICAgICAgICAgIH0KICAgICAgICB9ZWxzZSBpZihzZWxmLl9fcmVmcmVzaEhlaWdodCAmJiAhc2VsZi5fX3JlZnJlc2hIaWRkZW4pewogICAgICAgICAgLy8gaWYgYSBwb3NpdGl2ZSBzY3JvbGwgdmFsdWUgYW5kIHRoZSByZWZyZXNoZXIgaXMgc3RpbGwgbm90IGhpZGRlbiwgaGlkZSBpdAogICAgICAgICAgc2VsZi5fX3JlZnJlc2hIaWRlKCk7CiAgICAgICAgICBzZWxmLl9fcmVmcmVzaEhpZGRlbiA9IHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBLZWVwIGxpc3QgZnJvbSBncm93aW5nIGluZmluaXRlbHkgKGhvbGRpbmcgbWluIDEwLCBtYXggMjAgbWVhc3VyZSBwb2ludHMpCiAgICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoID4gNjApIHsKICAgICAgICBwb3NpdGlvbnMuc3BsaWNlKDAsIDMwKTsKICAgICAgfQoKICAgICAgLy8gVHJhY2sgc2Nyb2xsIG1vdmVtZW50IGZvciBkZWNsZXJhdGlvbgogICAgICBwb3NpdGlvbnMucHVzaChzY3JvbGxMZWZ0LCBzY3JvbGxUb3AsIHRpbWVTdGFtcCk7CgogICAgICAvLyBTeW5jIHNjcm9sbCBwb3NpdGlvbgogICAgICBzZWxmLl9fcHVibGlzaChzY3JvbGxMZWZ0LCBzY3JvbGxUb3AsIGxldmVsKTsKCiAgICAvLyBPdGhlcndpc2UgZmlndXJlIG91dCB3aGV0aGVyIHdlIGFyZSBzd2l0Y2hpbmcgaW50byBkcmFnZ2luZyBtb2RlIG5vdy4KICAgIH0gZWxzZSB7CgogICAgICB2YXIgbWluaW11bVRyYWNraW5nRm9yU2Nyb2xsID0gc2VsZi5vcHRpb25zLmxvY2tpbmcgPyAzIDogMDsKICAgICAgdmFyIG1pbmltdW1UcmFja2luZ0ZvckRyYWcgPSA1OwoKICAgICAgdmFyIGRpc3RhbmNlWCA9IE1hdGguYWJzKGN1cnJlbnRUb3VjaExlZnQgLSBzZWxmLl9faW5pdGlhbFRvdWNoTGVmdCk7CiAgICAgIHZhciBkaXN0YW5jZVkgPSBNYXRoLmFicyhjdXJyZW50VG91Y2hUb3AgLSBzZWxmLl9faW5pdGlhbFRvdWNoVG9wKTsKCiAgICAgIHNlbGYuX19lbmFibGVTY3JvbGxYID0gc2VsZi5vcHRpb25zLnNjcm9sbGluZ1ggJiYgZGlzdGFuY2VYID49IG1pbmltdW1UcmFja2luZ0ZvclNjcm9sbDsKICAgICAgc2VsZi5fX2VuYWJsZVNjcm9sbFkgPSBzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWSAmJiBkaXN0YW5jZVkgPj0gbWluaW11bVRyYWNraW5nRm9yU2Nyb2xsOwoKICAgICAgcG9zaXRpb25zLnB1c2goc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHRpbWVTdGFtcCk7CgogICAgICBzZWxmLl9faXNEcmFnZ2luZyA9IChzZWxmLl9fZW5hYmxlU2Nyb2xsWCB8fCBzZWxmLl9fZW5hYmxlU2Nyb2xsWSkgJiYgKGRpc3RhbmNlWCA+PSBtaW5pbXVtVHJhY2tpbmdGb3JEcmFnIHx8IGRpc3RhbmNlWSA+PSBtaW5pbXVtVHJhY2tpbmdGb3JEcmFnKTsKICAgICAgaWYgKHNlbGYuX19pc0RyYWdnaW5nKSB7CiAgICAgICAgc2VsZi5fX2ludGVycnVwdGVkQW5pbWF0aW9uID0gZmFsc2U7CiAgICAgICAgc2VsZi5fX2ZhZGVTY3JvbGxiYXJzKCdpbicpOwogICAgICB9CgogICAgfQoKICAgIC8vIFVwZGF0ZSBsYXN0IHRvdWNoIHBvc2l0aW9ucyBhbmQgdGltZSBzdGFtcCBmb3IgbmV4dCBldmVudAogICAgc2VsZi5fX2xhc3RUb3VjaExlZnQgPSBjdXJyZW50VG91Y2hMZWZ0OwogICAgc2VsZi5fX2xhc3RUb3VjaFRvcCA9IGN1cnJlbnRUb3VjaFRvcDsKICAgIHNlbGYuX19sYXN0VG91Y2hNb3ZlID0gdGltZVN0YW1wOwogICAgc2VsZi5fX2xhc3RTY2FsZSA9IHNjYWxlOwoKICB9LAoKCiAgLyoqCiAgICogVG91Y2ggZW5kIGhhbmRsZXIgZm9yIHNjcm9sbGluZyBzdXBwb3J0CiAgICovCiAgZG9Ub3VjaEVuZDogZnVuY3Rpb24odGltZVN0YW1wKSB7CiAgICBpZiAodGltZVN0YW1wIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICB0aW1lU3RhbXAgPSB0aW1lU3RhbXAudmFsdWVPZigpOwogICAgfQogICAgaWYgKHR5cGVvZiB0aW1lU3RhbXAgIT09ICJudW1iZXIiKSB7CiAgICAgIHRpbWVTdGFtcCA9IERhdGUubm93KCk7CiAgICB9CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIElnbm9yZSBldmVudCB3aGVuIHRyYWNraW5nIGlzIG5vdCBlbmFibGVkIChubyB0b3VjaHN0YXJ0IGV2ZW50IG9uIGVsZW1lbnQpCiAgICAvLyBUaGlzIGlzIHJlcXVpcmVkIGFzIHRoaXMgbGlzdGVuZXIgKCd0b3VjaG1vdmUnKSBzaXRzIG9uIHRoZSBkb2N1bWVudCBhbmQgbm90IG9uIHRoZSBlbGVtZW50IGl0c2VsZi4KICAgIGlmICghc2VsZi5fX2lzVHJhY2tpbmcpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIE5vdCB0b3VjaGluZyBhbnltb3JlICh3aGVuIHR3byBmaW5nZXIgaGl0IHRoZSBzY3JlZW4gdGhlcmUgYXJlIHR3byB0b3VjaCBlbmQgZXZlbnRzKQogICAgc2VsZi5fX2lzVHJhY2tpbmcgPSBmYWxzZTsKCiAgICAvLyBCZSBzdXJlIHRvIHJlc2V0IHRoZSBkcmFnZ2luZyBmbGFnIG5vdy4gSGVyZSB3ZSBhbHNvIGRldGVjdCB3aGV0aGVyCiAgICAvLyB0aGUgZmluZ2VyIGhhcyBtb3ZlZCBmYXN0IGVub3VnaCB0byBzd2l0Y2ggaW50byBhIGRlY2VsZXJhdGlvbiBhbmltYXRpb24uCiAgICBpZiAoc2VsZi5fX2lzRHJhZ2dpbmcpIHsKCiAgICAgIC8vIFJlc2V0IGRyYWdnaW5nIGZsYWcKICAgICAgc2VsZi5fX2lzRHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAgIC8vIFN0YXJ0IGRlY2VsZXJhdGlvbgogICAgICAvLyBWZXJpZnkgdGhhdCB0aGUgbGFzdCBtb3ZlIGRldGVjdGVkIHdhcyBpbiBzb21lIHJlbGV2YW50IHRpbWUgZnJhbWUKICAgICAgaWYgKHNlbGYuX19pc1NpbmdsZVRvdWNoICYmIHNlbGYub3B0aW9ucy5hbmltYXRpbmcgJiYgKHRpbWVTdGFtcCAtIHNlbGYuX19sYXN0VG91Y2hNb3ZlKSA8PSAxMDApIHsKCiAgICAgICAgLy8gVGhlbiBmaWd1cmUgb3V0IHdoYXQgdGhlIHNjcm9sbCBwb3NpdGlvbiB3YXMgYWJvdXQgMTAwbXMgYWdvCiAgICAgICAgdmFyIHBvc2l0aW9ucyA9IHNlbGYuX19wb3NpdGlvbnM7CiAgICAgICAgdmFyIGVuZFBvcyA9IHBvc2l0aW9ucy5sZW5ndGggLSAxOwogICAgICAgIHZhciBzdGFydFBvcyA9IGVuZFBvczsKCiAgICAgICAgLy8gTW92ZSBwb2ludGVyIHRvIHBvc2l0aW9uIG1lYXN1cmVkIDEwMG1zIGFnbwogICAgICAgIGZvciAodmFyIGkgPSBlbmRQb3M7IGkgPiAwICYmIHBvc2l0aW9uc1tpXSA+IChzZWxmLl9fbGFzdFRvdWNoTW92ZSAtIDEwMCk7IGkgLT0gMykgewogICAgICAgICAgc3RhcnRQb3MgPSBpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgc3RhcnQgYW5kIHN0b3AgcG9zaXRpb24gaXMgaWRlbnRpY2FsIGluIGEgMTAwbXMgdGltZWZyYW1lLAogICAgICAgIC8vIHdlIGNhbm5vdCBjb21wdXRlIGFueSB1c2VmdWwgZGVjZWxlcmF0aW9uLgogICAgICAgIGlmIChzdGFydFBvcyAhPT0gZW5kUG9zKSB7CgogICAgICAgICAgLy8gQ29tcHV0ZSByZWxhdGl2ZSBtb3ZlbWVudCBiZXR3ZWVuIHRoZXNlIHR3byBwb2ludHMKICAgICAgICAgIHZhciB0aW1lT2Zmc2V0ID0gcG9zaXRpb25zW2VuZFBvc10gLSBwb3NpdGlvbnNbc3RhcnRQb3NdOwogICAgICAgICAgdmFyIG1vdmVkTGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0IC0gcG9zaXRpb25zW3N0YXJ0UG9zIC0gMl07CiAgICAgICAgICB2YXIgbW92ZWRUb3AgPSBzZWxmLl9fc2Nyb2xsVG9wIC0gcG9zaXRpb25zW3N0YXJ0UG9zIC0gMV07CgogICAgICAgICAgLy8gQmFzZWQgb24gNTBtcyBjb21wdXRlIHRoZSBtb3ZlbWVudCB0byBhcHBseSBmb3IgZWFjaCByZW5kZXIgc3RlcAogICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCA9IG1vdmVkTGVmdCAvIHRpbWVPZmZzZXQgKiAoMTAwMCAvIDYwKTsKICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkgPSBtb3ZlZFRvcCAvIHRpbWVPZmZzZXQgKiAoMTAwMCAvIDYwKTsKCiAgICAgICAgICAvLyBIb3cgbXVjaCB2ZWxvY2l0eSBpcyByZXF1aXJlZCB0byBzdGFydCB0aGUgZGVjZWxlcmF0aW9uCiAgICAgICAgICB2YXIgbWluVmVsb2NpdHlUb1N0YXJ0RGVjZWxlcmF0aW9uID0gc2VsZi5vcHRpb25zLnBhZ2luZyB8fCBzZWxmLm9wdGlvbnMuc25hcHBpbmcgPyA0IDogMTsKCiAgICAgICAgICAvLyBWZXJpZnkgdGhhdCB3ZSBoYXZlIGVub3VnaCB2ZWxvY2l0eSB0byBzdGFydCBkZWNlbGVyYXRpb24KICAgICAgICAgIGlmIChNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYKSA+IG1pblZlbG9jaXR5VG9TdGFydERlY2VsZXJhdGlvbiB8fCBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZKSA+IG1pblZlbG9jaXR5VG9TdGFydERlY2VsZXJhdGlvbikgewoKICAgICAgICAgICAgLy8gRGVhY3RpdmF0ZSBwdWxsLXRvLXJlZnJlc2ggd2hlbiBkZWNlbGVyYXRpbmcKICAgICAgICAgICAgaWYgKCFzZWxmLl9fcmVmcmVzaEFjdGl2ZSkgewogICAgICAgICAgICAgIHNlbGYuX19zdGFydERlY2VsZXJhdGlvbih0aW1lU3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuX19zY3JvbGxpbmdDb21wbGV0ZSgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgodGltZVN0YW1wIC0gc2VsZi5fX2xhc3RUb3VjaE1vdmUpID4gMTAwKSB7CiAgICAgICAgc2VsZi5fX3Njcm9sbGluZ0NvbXBsZXRlKCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBJZiB0aGlzIHdhcyBhIHNsb3dlciBtb3ZlIGl0IGlzIHBlciBkZWZhdWx0IG5vbiBkZWNlbGVyYXRlZCwgYnV0IHRoaXMKICAgIC8vIHN0aWxsIG1lYW5zIHRoYXQgd2Ugd2FudCBzbmFwIGJhY2sgdG8gdGhlIGJvdW5kcyB3aGljaCBpcyBkb25lIGhlcmUuCiAgICAvLyBUaGlzIGlzIHBsYWNlZCBvdXRzaWRlIHRoZSBjb25kaXRpb24gYWJvdmUgdG8gaW1wcm92ZSBlZGdlIGNhc2Ugc3RhYmlsaXR5CiAgICAvLyBlLmcuIHRvdWNoZW5kIGZpcmVkIHdpdGhvdXQgZW5hYmxlZCBkcmFnZ2luZy4gVGhpcyBzaG91bGQgbm9ybWFsbHkgZG8gbm90CiAgICAvLyBoYXZlIG1vZGlmaWVkIHRoZSBzY3JvbGwgcG9zaXRpb25zIG9yIGV2ZW4gc2hvd2VkIHRoZSBzY3JvbGxiYXJzIHRob3VnaC4KICAgIGlmICghc2VsZi5fX2lzRGVjZWxlcmF0aW5nKSB7CgogICAgICBpZiAoc2VsZi5fX3JlZnJlc2hBY3RpdmUgJiYgc2VsZi5fX3JlZnJlc2hTdGFydCkgewoKICAgICAgICAvLyBVc2UgcHVibGlzaCBpbnN0ZWFkIG9mIHNjcm9sbFRvIHRvIGFsbG93IHNjcm9sbGluZyB0byBvdXQgb2YgYm91bmRhcnkgcG9zaXRpb24KICAgICAgICAvLyBXZSBkb24ndCBuZWVkIHRvIG5vcm1hbGl6ZSBzY3JvbGxMZWZ0LCB6b29tTGV2ZWwsIGV0Yy4gaGVyZSBiZWNhdXNlIHdlIG9ubHkgeS1zY3JvbGxpbmcgd2hlbiBwdWxsLXRvLXJlZnJlc2ggaXMgZW5hYmxlZAogICAgICAgIHNlbGYuX19wdWJsaXNoKHNlbGYuX19zY3JvbGxMZWZ0LCAtc2VsZi5fX3JlZnJlc2hIZWlnaHQsIHNlbGYuX196b29tTGV2ZWwsIHRydWUpOwoKICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hTdGFydCkgewogICAgICAgICAgc2VsZi5fX3JlZnJlc2hTdGFydCgpOwogICAgICAgIH0KCiAgICAgIH0gZWxzZSB7CgogICAgICAgIGlmIChzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gfHwgc2VsZi5fX2lzRHJhZ2dpbmcpIHsKICAgICAgICAgIHNlbGYuX19zY3JvbGxpbmdDb21wbGV0ZSgpOwogICAgICAgIH0KICAgICAgICBzZWxmLnNjcm9sbFRvKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fc2Nyb2xsVG9wLCB0cnVlLCBzZWxmLl9fem9vbUxldmVsKTsKCiAgICAgICAgLy8gRGlyZWN0bHkgc2lnbmFsaXplIGRlYWN0aXZhdGlvbiAobm90aGluZyB0b2RvIG9uIHJlZnJlc2g/KQogICAgICAgIGlmIChzZWxmLl9fcmVmcmVzaEFjdGl2ZSkgewoKICAgICAgICAgIHNlbGYuX19yZWZyZXNoQWN0aXZlID0gZmFsc2U7CiAgICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKSB7CiAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoRGVhY3RpdmF0ZSgpOwogICAgICAgICAgfQoKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBGdWxseSBjbGVhbnVwIGxpc3QKICAgIHNlbGYuX19wb3NpdGlvbnMubGVuZ3RoID0gMDsKCiAgfSwKCgoKICAvKgogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgUFJJVkFURSBBUEkKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqLwoKICAvKioKICAgKiBBcHBsaWVzIHRoZSBzY3JvbGwgcG9zaXRpb24gdG8gdGhlIGNvbnRlbnQgZWxlbWVudAogICAqCiAgICogQHBhcmFtIGxlZnQge051bWJlcn0gTGVmdCBzY3JvbGwgcG9zaXRpb24KICAgKiBAcGFyYW0gdG9wIHtOdW1iZXJ9IFRvcCBzY3JvbGwgcG9zaXRpb24KICAgKiBAcGFyYW0gYW5pbWF0ZSB7Qm9vbGVhbn0gV2hldGhlciBhbmltYXRpb24gc2hvdWxkIGJlIHVzZWQgdG8gbW92ZSB0byB0aGUgbmV3IGNvb3JkaW5hdGVzCiAgICovCiAgX19wdWJsaXNoOiBmdW5jdGlvbihsZWZ0LCB0b3AsIHpvb20sIGFuaW1hdGUsIHdhc1Jlc2l6ZSkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBSZW1lbWJlciB3aGV0aGVyIHdlIGhhZCBhbiBhbmltYXRpb24sIHRoZW4gd2UgdHJ5IHRvIGNvbnRpbnVlIGJhc2VkIG9uIHRoZSBjdXJyZW50ICJkcml2ZSIgb2YgdGhlIGFuaW1hdGlvbgogICAgdmFyIHdhc0FuaW1hdGluZyA9IHNlbGYuX19pc0FuaW1hdGluZzsKICAgIGlmICh3YXNBbmltYXRpbmcpIHsKICAgICAgenluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnN0b3Aod2FzQW5pbWF0aW5nKTsKICAgICAgc2VsZi5fX2lzQW5pbWF0aW5nID0gZmFsc2U7CiAgICB9CgogICAgaWYgKGFuaW1hdGUgJiYgc2VsZi5vcHRpb25zLmFuaW1hdGluZykgewoKICAgICAgLy8gS2VlcCBzY2hlZHVsZWQgcG9zaXRpb25zIGZvciBzY3JvbGxCeS96b29tQnkgZnVuY3Rpb25hbGl0eQogICAgICBzZWxmLl9fc2NoZWR1bGVkTGVmdCA9IGxlZnQ7CiAgICAgIHNlbGYuX19zY2hlZHVsZWRUb3AgPSB0b3A7CiAgICAgIHNlbGYuX19zY2hlZHVsZWRab29tID0gem9vbTsKCiAgICAgIHZhciBvbGRMZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQ7CiAgICAgIHZhciBvbGRUb3AgPSBzZWxmLl9fc2Nyb2xsVG9wOwogICAgICB2YXIgb2xkWm9vbSA9IHNlbGYuX196b29tTGV2ZWw7CgogICAgICB2YXIgZGlmZkxlZnQgPSBsZWZ0IC0gb2xkTGVmdDsKICAgICAgdmFyIGRpZmZUb3AgPSB0b3AgLSBvbGRUb3A7CiAgICAgIHZhciBkaWZmWm9vbSA9IHpvb20gLSBvbGRab29tOwoKICAgICAgdmFyIHN0ZXAgPSBmdW5jdGlvbihwZXJjZW50LCBub3csIHJlbmRlcikgewoKICAgICAgICBpZiAocmVuZGVyKSB7CgogICAgICAgICAgc2VsZi5fX3Njcm9sbExlZnQgPSBvbGRMZWZ0ICsgKGRpZmZMZWZ0ICogcGVyY2VudCk7CiAgICAgICAgICBzZWxmLl9fc2Nyb2xsVG9wID0gb2xkVG9wICsgKGRpZmZUb3AgKiBwZXJjZW50KTsKICAgICAgICAgIHNlbGYuX196b29tTGV2ZWwgPSBvbGRab29tICsgKGRpZmZab29tICogcGVyY2VudCk7CgogICAgICAgICAgLy8gUHVzaCB2YWx1ZXMgb3V0CiAgICAgICAgICBpZiAoc2VsZi5fX2NhbGxiYWNrKSB7CiAgICAgICAgICAgIHNlbGYuX19jYWxsYmFjayhzZWxmLl9fc2Nyb2xsTGVmdCwgc2VsZi5fX3Njcm9sbFRvcCwgc2VsZi5fX3pvb21MZXZlbCwgd2FzUmVzaXplKTsKICAgICAgICAgIH0KCiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIHZlcmlmeSA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgcmV0dXJuIHNlbGYuX19pc0FuaW1hdGluZyA9PT0gaWQ7CiAgICAgIH07CgogICAgICB2YXIgY29tcGxldGVkID0gZnVuY3Rpb24ocmVuZGVyZWRGcmFtZXNQZXJTZWNvbmQsIGFuaW1hdGlvbklkLCB3YXNGaW5pc2hlZCkgewogICAgICAgIGlmIChhbmltYXRpb25JZCA9PT0gc2VsZi5fX2lzQW5pbWF0aW5nKSB7CiAgICAgICAgICBzZWxmLl9faXNBbmltYXRpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHNlbGYuX19kaWREZWNlbGVyYXRpb25Db21wbGV0ZSB8fCB3YXNGaW5pc2hlZCkgewogICAgICAgICAgc2VsZi5fX3Njcm9sbGluZ0NvbXBsZXRlKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKICAgICAgICAgIHNlbGYuX19jb21wdXRlU2Nyb2xsTWF4KCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgLy8gV2hlbiBjb250aW51aW5nIGJhc2VkIG9uIHByZXZpb3VzIGFuaW1hdGlvbiB3ZSBjaG9vc2UgYW4gZWFzZS1vdXQgYW5pbWF0aW9uIGluc3RlYWQgb2YgZWFzZS1pbi1vdXQKICAgICAgc2VsZi5fX2lzQW5pbWF0aW5nID0genluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnN0YXJ0KHN0ZXAsIHZlcmlmeSwgY29tcGxldGVkLCBzZWxmLm9wdGlvbnMuYW5pbWF0aW9uRHVyYXRpb24sIHdhc0FuaW1hdGluZyA/IGVhc2VPdXRDdWJpYyA6IGVhc2VJbk91dEN1YmljKTsKCiAgICB9IGVsc2UgewoKICAgICAgc2VsZi5fX3NjaGVkdWxlZExlZnQgPSBzZWxmLl9fc2Nyb2xsTGVmdCA9IGxlZnQ7CiAgICAgIHNlbGYuX19zY2hlZHVsZWRUb3AgPSBzZWxmLl9fc2Nyb2xsVG9wID0gdG9wOwogICAgICBzZWxmLl9fc2NoZWR1bGVkWm9vbSA9IHNlbGYuX196b29tTGV2ZWwgPSB6b29tOwoKICAgICAgLy8gUHVzaCB2YWx1ZXMgb3V0CiAgICAgIGlmIChzZWxmLl9fY2FsbGJhY2spIHsKICAgICAgICBzZWxmLl9fY2FsbGJhY2sobGVmdCwgdG9wLCB6b29tLCB3YXNSZXNpemUpOwogICAgICB9CgogICAgICAvLyBGaXggbWF4IHNjcm9sbCByYW5nZXMKICAgICAgaWYgKHNlbGYub3B0aW9ucy56b29taW5nKSB7CiAgICAgICAgc2VsZi5fX2NvbXB1dGVTY3JvbGxNYXgoKTsKICAgICAgfQogICAgfQogIH0sCgoKICAvKioKICAgKiBSZWNvbXB1dGVzIHNjcm9sbCBtaW5pbXVtIHZhbHVlcyBiYXNlZCBvbiBjbGllbnQgZGltZW5zaW9ucyBhbmQgY29udGVudCBkaW1lbnNpb25zLgogICAqLwogIF9fY29tcHV0ZVNjcm9sbE1heDogZnVuY3Rpb24oem9vbUxldmVsKSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGlmICh6b29tTGV2ZWwgPT0gbnVsbCkgewogICAgICB6b29tTGV2ZWwgPSBzZWxmLl9fem9vbUxldmVsOwogICAgfQoKICAgIHNlbGYuX19tYXhTY3JvbGxMZWZ0ID0gTWF0aC5tYXgoKHNlbGYuX19jb250ZW50V2lkdGggKiB6b29tTGV2ZWwpIC0gc2VsZi5fX2NsaWVudFdpZHRoLCAwKTsKICAgIHNlbGYuX19tYXhTY3JvbGxUb3AgPSBNYXRoLm1heCgoc2VsZi5fX2NvbnRlbnRIZWlnaHQgKiB6b29tTGV2ZWwpIC0gc2VsZi5fX2NsaWVudEhlaWdodCwgMCk7CgogICAgaWYoIXNlbGYuX19kaWRXYWl0Rm9yU2l6ZSAmJiAhc2VsZi5fX21heFNjcm9sbExlZnQgJiYgIXNlbGYuX19tYXhTY3JvbGxUb3ApIHsKICAgICAgc2VsZi5fX2RpZFdhaXRGb3JTaXplID0gdHJ1ZTsKICAgICAgc2VsZi5fX3dhaXRGb3JTaXplKCk7CiAgICB9CiAgfSwKCgogIC8qKgogICAqIElmIHRoZSBzY3JvbGwgdmlldyBpc24ndCBzaXplZCBjb3JyZWN0bHkgb24gc3RhcnQsIHdhaXQgdW50aWwgd2UgaGF2ZSBhdCBsZWFzdCBzb21lIHNpemUKICAgKi8KICBfX3dhaXRGb3JTaXplOiBmdW5jdGlvbigpIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY2xlYXJUaW1lb3V0KHNlbGYuX19zaXplclRpbWVvdXQpOwoKICAgIHZhciBzaXplciA9IGZ1bmN0aW9uKCkgewogICAgICBzZWxmLnJlc2l6ZSgpOwoKICAgICAgaWYoKHNlbGYub3B0aW9ucy5zY3JvbGxpbmdYICYmICFzZWxmLl9fbWF4U2Nyb2xsTGVmdCkgfHwgKHNlbGYub3B0aW9ucy5zY3JvbGxpbmdZICYmICFzZWxmLl9fbWF4U2Nyb2xsVG9wKSkgewogICAgICAgIC8vc2VsZi5fX3NpemVyVGltZW91dCA9IHNldFRpbWVvdXQoc2l6ZXIsIDEwMDApOwogICAgICB9CiAgICB9OwoKICAgIHNpemVyKCk7CiAgICBzZWxmLl9fc2l6ZXJUaW1lb3V0ID0gc2V0VGltZW91dChzaXplciwgMTAwMCk7CiAgfSwKCiAgLyoKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIEFOSU1BVElPTiAoREVDRUxFUkFUSU9OKSBTVVBQT1JUCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKi8KCiAgLyoqCiAgICogQ2FsbGVkIHdoZW4gYSB0b3VjaCBzZXF1ZW5jZSBlbmQgYW5kIHRoZSBzcGVlZCBvZiB0aGUgZmluZ2VyIHdhcyBoaWdoIGVub3VnaAogICAqIHRvIHN3aXRjaCBpbnRvIGRlY2VsZXJhdGlvbiBtb2RlLgogICAqLwogIF9fc3RhcnREZWNlbGVyYXRpb246IGZ1bmN0aW9uKHRpbWVTdGFtcCkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBpZiAoc2VsZi5vcHRpb25zLnBhZ2luZykgewoKICAgICAgdmFyIHNjcm9sbExlZnQgPSBNYXRoLm1heChNYXRoLm1pbihzZWxmLl9fc2Nyb2xsTGVmdCwgc2VsZi5fX21heFNjcm9sbExlZnQpLCAwKTsKICAgICAgdmFyIHNjcm9sbFRvcCA9IE1hdGgubWF4KE1hdGgubWluKHNlbGYuX19zY3JvbGxUb3AsIHNlbGYuX19tYXhTY3JvbGxUb3ApLCAwKTsKICAgICAgdmFyIGNsaWVudFdpZHRoID0gc2VsZi5fX2NsaWVudFdpZHRoOwogICAgICB2YXIgY2xpZW50SGVpZ2h0ID0gc2VsZi5fX2NsaWVudEhlaWdodDsKCiAgICAgIC8vIFdlIGxpbWl0IGRlY2VsZXJhdGlvbiBub3QgdG8gdGhlIG1pbi9tYXggdmFsdWVzIG9mIHRoZSBhbGxvd2VkIHJhbmdlLCBidXQgdG8gdGhlIHNpemUgb2YgdGhlIHZpc2libGUgY2xpZW50IGFyZWEuCiAgICAgIC8vIEVhY2ggcGFnZSBzaG91bGQgaGF2ZSBleGFjdGx5IHRoZSBzaXplIG9mIHRoZSBjbGllbnQgYXJlYS4KICAgICAgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbExlZnQgPSBNYXRoLmZsb29yKHNjcm9sbExlZnQgLyBjbGllbnRXaWR0aCkgKiBjbGllbnRXaWR0aDsKICAgICAgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCA9IE1hdGguZmxvb3Ioc2Nyb2xsVG9wIC8gY2xpZW50SGVpZ2h0KSAqIGNsaWVudEhlaWdodDsKICAgICAgc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbExlZnQgPSBNYXRoLmNlaWwoc2Nyb2xsTGVmdCAvIGNsaWVudFdpZHRoKSAqIGNsaWVudFdpZHRoOwogICAgICBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wID0gTWF0aC5jZWlsKHNjcm9sbFRvcCAvIGNsaWVudEhlaWdodCkgKiBjbGllbnRIZWlnaHQ7CgogICAgfSBlbHNlIHsKCiAgICAgIHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxMZWZ0ID0gMDsKICAgICAgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCA9IDA7CiAgICAgIHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0ID0gc2VsZi5fX21heFNjcm9sbExlZnQ7CiAgICAgIHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3AgPSBzZWxmLl9fbWF4U2Nyb2xsVG9wOwoKICAgIH0KCiAgICAvLyBXcmFwIGNsYXNzIG1ldGhvZAogICAgdmFyIHN0ZXAgPSBmdW5jdGlvbihwZXJjZW50LCBub3csIHJlbmRlcikgewogICAgICBzZWxmLl9fc3RlcFRocm91Z2hEZWNlbGVyYXRpb24ocmVuZGVyKTsKICAgIH07CgogICAgLy8gSG93IG11Y2ggdmVsb2NpdHkgaXMgcmVxdWlyZWQgdG8ga2VlcCB0aGUgZGVjZWxlcmF0aW9uIHJ1bm5pbmcKICAgIHNlbGYuX19taW5WZWxvY2l0eVRvS2VlcERlY2VsZXJhdGluZyA9IHNlbGYub3B0aW9ucy5zbmFwcGluZyA/IDQgOiAwLjE7CgogICAgLy8gRGV0ZWN0IHdoZXRoZXIgaXQncyBzdGlsbCB3b3J0aCB0byBjb250aW51ZSBhbmltYXRpbmcgc3RlcHMKICAgIC8vIElmIHdlIGFyZSBhbHJlYWR5IHNsb3cgZW5vdWdoIHRvIG5vdCBiZWluZyB1c2VyIHBlcmNlaXZhYmxlIGFueW1vcmUsIHdlIHN0b3AgdGhlIHdob2xlIHByb2Nlc3MgaGVyZS4KICAgIHZhciB2ZXJpZnkgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNob3VsZENvbnRpbnVlID0gTWF0aC5hYnMoc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCkgPj0gc2VsZi5fX21pblZlbG9jaXR5VG9LZWVwRGVjZWxlcmF0aW5nIHx8CiAgICAgICAgTWF0aC5hYnMoc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSkgPj0gc2VsZi5fX21pblZlbG9jaXR5VG9LZWVwRGVjZWxlcmF0aW5nOwogICAgICBpZiAoIXNob3VsZENvbnRpbnVlKSB7CiAgICAgICAgc2VsZi5fX2RpZERlY2VsZXJhdGlvbkNvbXBsZXRlID0gdHJ1ZTsKCiAgICAgICAgLy9NYWtlIHN1cmUgdGhlIHNjcm9sbCB2YWx1ZXMgYXJlIHdpdGhpbiB0aGUgYm91bmRhcmllcyBhZnRlciBhIGJvdW5jZSwKICAgICAgICAvL25vdCBiZWxvdyAwIG9yIGFib3ZlIG1heGltdW0KICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmJvdW5jaW5nKSB7CiAgICAgICAgICBzZWxmLnNjcm9sbFRvKAogICAgICAgICAgICBNYXRoLm1pbiggTWF0aC5tYXgoc2VsZi5fX3Njcm9sbExlZnQsIDApLCBzZWxmLl9fbWF4U2Nyb2xsTGVmdCApLAogICAgICAgICAgICBNYXRoLm1pbiggTWF0aC5tYXgoc2VsZi5fX3Njcm9sbFRvcCwgMCksIHNlbGYuX19tYXhTY3JvbGxUb3AgKSwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzaG91bGRDb250aW51ZTsKICAgIH07CgogICAgdmFyIGNvbXBsZXRlZCA9IGZ1bmN0aW9uKHJlbmRlcmVkRnJhbWVzUGVyU2Vjb25kLCBhbmltYXRpb25JZCwgd2FzRmluaXNoZWQpIHsKICAgICAgc2VsZi5fX2lzRGVjZWxlcmF0aW5nID0gZmFsc2U7CiAgICAgIGlmIChzZWxmLl9fZGlkRGVjZWxlcmF0aW9uQ29tcGxldGUpIHsKICAgICAgICBzZWxmLl9fc2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgICAgfQoKICAgICAgLy8gQW5pbWF0ZSB0byBncmlkIHdoZW4gc25hcHBpbmcgaXMgYWN0aXZlLCBvdGhlcndpc2UganVzdCBmaXggb3V0LW9mLWJvdW5kYXJ5IHBvc2l0aW9ucwogICAgICBpZihzZWxmLm9wdGlvbnMucGFnaW5nKSB7CiAgICAgICAgc2VsZi5zY3JvbGxUbyhzZWxmLl9fc2Nyb2xsTGVmdCwgc2VsZi5fX3Njcm9sbFRvcCwgc2VsZi5vcHRpb25zLnNuYXBwaW5nKTsKICAgICAgfQogICAgfTsKCiAgICAvLyBTdGFydCBhbmltYXRpb24gYW5kIHN3aXRjaCBvbiBmbGFnCiAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RhcnQoc3RlcCwgdmVyaWZ5LCBjb21wbGV0ZWQpOwoKICB9LAoKCiAgLyoqCiAgICogQ2FsbGVkIG9uIGV2ZXJ5IHN0ZXAgb2YgdGhlIGFuaW1hdGlvbgogICAqCiAgICogQHBhcmFtIGluTWVtb3J5IHtCb29sZWFufSBXaGV0aGVyIHRvIG5vdCByZW5kZXIgdGhlIGN1cnJlbnQgc3RlcCwgYnV0IGtlZXAgaXQgaW4gbWVtb3J5IG9ubHkuIFVzZWQgaW50ZXJuYWxseSBvbmx5IQogICAqLwogIF9fc3RlcFRocm91Z2hEZWNlbGVyYXRpb246IGZ1bmN0aW9uKHJlbmRlcikgewoKICAgIHZhciBzZWxmID0gdGhpczsKCgogICAgLy8KICAgIC8vIENPTVBVVEUgTkVYVCBTQ1JPTEwgUE9TSVRJT04KICAgIC8vCgogICAgLy8gQWRkIGRlY2VsZXJhdGlvbiB0byBzY3JvbGwgcG9zaXRpb24KICAgIHZhciBzY3JvbGxMZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQgKyBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYOy8vICogc2VsZi5vcHRpb25zLmRlY2VsZXJhdGlvbik7CiAgICB2YXIgc2Nyb2xsVG9wID0gc2VsZi5fX3Njcm9sbFRvcCArIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVk7Ly8gKiBzZWxmLm9wdGlvbnMuZGVjZWxlcmF0aW9uKTsKCgogICAgLy8KICAgIC8vIEhBUkQgTElNSVQgU0NST0xMIFBPU0lUSU9OIEZPUiBOT04gQk9VTkNJTkcgTU9ERQogICAgLy8KCiAgICBpZiAoIXNlbGYub3B0aW9ucy5ib3VuY2luZykgewoKICAgICAgdmFyIHNjcm9sbExlZnRGaXhlZCA9IE1hdGgubWF4KE1hdGgubWluKHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0LCBzY3JvbGxMZWZ0KSwgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbExlZnQpOwogICAgICBpZiAoc2Nyb2xsTGVmdEZpeGVkICE9PSBzY3JvbGxMZWZ0KSB7CiAgICAgICAgc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRGaXhlZDsKICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYID0gMDsKICAgICAgfQoKICAgICAgdmFyIHNjcm9sbFRvcEZpeGVkID0gTWF0aC5tYXgoTWF0aC5taW4oc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbFRvcCwgc2Nyb2xsVG9wKSwgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCk7CiAgICAgIGlmIChzY3JvbGxUb3BGaXhlZCAhPT0gc2Nyb2xsVG9wKSB7CiAgICAgICAgc2Nyb2xsVG9wID0gc2Nyb2xsVG9wRml4ZWQ7CiAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSA9IDA7CiAgICAgIH0KCiAgICB9CgoKICAgIC8vCiAgICAvLyBVUERBVEUgU0NST0xMIFBPU0lUSU9OCiAgICAvLwoKICAgIGlmIChyZW5kZXIpIHsKCiAgICAgIHNlbGYuX19wdWJsaXNoKHNjcm9sbExlZnQsIHNjcm9sbFRvcCwgc2VsZi5fX3pvb21MZXZlbCk7CgogICAgfSBlbHNlIHsKCiAgICAgIHNlbGYuX19zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdDsKICAgICAgc2VsZi5fX3Njcm9sbFRvcCA9IHNjcm9sbFRvcDsKCiAgICB9CgoKICAgIC8vCiAgICAvLyBTTE9XIERPV04KICAgIC8vCgogICAgLy8gU2xvdyBkb3duIHZlbG9jaXR5IG9uIGV2ZXJ5IGl0ZXJhdGlvbgogICAgaWYgKCFzZWxmLm9wdGlvbnMucGFnaW5nKSB7CgogICAgICAvLyBUaGlzIGlzIHRoZSBmYWN0b3IgYXBwbGllZCB0byBldmVyeSBpdGVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbgogICAgICAvLyB0byBzbG93IGRvd24gdGhlIHByb2Nlc3MuIFRoaXMgc2hvdWxkIGVtdWxhdGUgbmF0dXJhbCBiZWhhdmlvciB3aGVyZQogICAgICAvLyBvYmplY3RzIHNsb3cgZG93biB3aGVuIHRoZSBpbml0aWF0b3Igb2YgdGhlIG1vdmVtZW50IGlzIHJlbW92ZWQKICAgICAgdmFyIGZyaWN0aW9uRmFjdG9yID0gc2VsZi5vcHRpb25zLmRlY2VsZXJhdGlvbjsKCiAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVggKj0gZnJpY3Rpb25GYWN0b3I7CiAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkgKj0gZnJpY3Rpb25GYWN0b3I7CgogICAgfQoKCiAgICAvLwogICAgLy8gQk9VTkNJTkcgU1VQUE9SVAogICAgLy8KCiAgICBpZiAoc2VsZi5vcHRpb25zLmJvdW5jaW5nKSB7CgogICAgICB2YXIgc2Nyb2xsT3V0c2lkZVggPSAwOwogICAgICB2YXIgc2Nyb2xsT3V0c2lkZVkgPSAwOwoKICAgICAgLy8gVGhpcyBjb25maWd1cmVzIHRoZSBhbW91bnQgb2YgY2hhbmdlIGFwcGxpZWQgdG8gZGVjZWxlcmF0aW9uL2FjY2VsZXJhdGlvbiB3aGVuIHJlYWNoaW5nIGJvdW5kYXJpZXMKICAgICAgdmFyIHBlbmV0cmF0aW9uRGVjZWxlcmF0aW9uID0gc2VsZi5vcHRpb25zLnBlbmV0cmF0aW9uRGVjZWxlcmF0aW9uOwogICAgICB2YXIgcGVuZXRyYXRpb25BY2NlbGVyYXRpb24gPSBzZWxmLm9wdGlvbnMucGVuZXRyYXRpb25BY2NlbGVyYXRpb247CgogICAgICAvLyBDaGVjayBsaW1pdHMKICAgICAgaWYgKHNjcm9sbExlZnQgPCBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCkgewogICAgICAgIHNjcm9sbE91dHNpZGVYID0gc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbExlZnQgLSBzY3JvbGxMZWZ0OwogICAgICB9IGVsc2UgaWYgKHNjcm9sbExlZnQgPiBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCkgewogICAgICAgIHNjcm9sbE91dHNpZGVYID0gc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbExlZnQgLSBzY3JvbGxMZWZ0OwogICAgICB9CgogICAgICBpZiAoc2Nyb2xsVG9wIDwgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCkgewogICAgICAgIHNjcm9sbE91dHNpZGVZID0gc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCAtIHNjcm9sbFRvcDsKICAgICAgfSBlbHNlIGlmIChzY3JvbGxUb3AgPiBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wKSB7CiAgICAgICAgc2Nyb2xsT3V0c2lkZVkgPSBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wIC0gc2Nyb2xsVG9wOwogICAgICB9CgogICAgICAvLyBTbG93IGRvd24gdW50aWwgc2xvdyBlbm91Z2gsIHRoZW4gZmxpcCBiYWNrIHRvIHNuYXAgcG9zaXRpb24KICAgICAgaWYgKHNjcm9sbE91dHNpZGVYICE9PSAwKSB7CiAgICAgICAgdmFyIGlzSGVhZGluZ091dHdhcmRzWCA9IHNjcm9sbE91dHNpZGVYICogc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCA8PSBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdDsKICAgICAgICBpZiAoaXNIZWFkaW5nT3V0d2FyZHNYKSB7CiAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYICs9IHNjcm9sbE91dHNpZGVYICogcGVuZXRyYXRpb25EZWNlbGVyYXRpb247CiAgICAgICAgfQogICAgICAgIHZhciBpc1N0b3BwZWRYID0gTWF0aC5hYnMoc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCkgPD0gc2VsZi5fX21pblZlbG9jaXR5VG9LZWVwRGVjZWxlcmF0aW5nOwogICAgICAgIC8vSWYgd2UncmUgbm90IGhlYWRpbmcgb3V0d2FyZHMsIG9yIGlmIHRoZSBhYm92ZSBzdGF0ZW1lbnQgZ290IHVzIGJlbG93IG1pbkRlY2VsZXJhdGlvbiwgZ28gYmFjayB0b3dhcmRzIGJvdW5kcwogICAgICAgIGlmICghaXNIZWFkaW5nT3V0d2FyZHNYIHx8IGlzU3RvcHBlZFgpIHsKICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVggPSBzY3JvbGxPdXRzaWRlWCAqIHBlbmV0cmF0aW9uQWNjZWxlcmF0aW9uOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHNjcm9sbE91dHNpZGVZICE9PSAwKSB7CiAgICAgICAgdmFyIGlzSGVhZGluZ091dHdhcmRzWSA9IHNjcm9sbE91dHNpZGVZICogc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSA8PSBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wOwogICAgICAgIGlmIChpc0hlYWRpbmdPdXR3YXJkc1kpIHsKICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkgKz0gc2Nyb2xsT3V0c2lkZVkgKiBwZW5ldHJhdGlvbkRlY2VsZXJhdGlvbjsKICAgICAgICB9CiAgICAgICAgdmFyIGlzU3RvcHBlZFkgPSBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZKSA8PSBzZWxmLl9fbWluVmVsb2NpdHlUb0tlZXBEZWNlbGVyYXRpbmc7CiAgICAgICAgLy9JZiB3ZSdyZSBub3QgaGVhZGluZyBvdXR3YXJkcywgb3IgaWYgdGhlIGFib3ZlIHN0YXRlbWVudCBnb3QgdXMgYmVsb3cgbWluRGVjZWxlcmF0aW9uLCBnbyBiYWNrIHRvd2FyZHMgYm91bmRzCiAgICAgICAgaWYgKCFpc0hlYWRpbmdPdXR3YXJkc1kgfHwgaXNTdG9wcGVkWSkgewogICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSA9IHNjcm9sbE91dHNpZGVZICogcGVuZXRyYXRpb25BY2NlbGVyYXRpb247CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwKCgogIC8qKgogICAqIGNhbGN1bGF0ZSB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0d28gdG91Y2hlcwogICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMQogICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMgogICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIGRpc3RhbmNlCiAgICovCiAgX19nZXREaXN0YW5jZTogZnVuY3Rpb24gZ2V0RGlzdGFuY2UodG91Y2gxLCB0b3VjaDIpIHsKICAgIHZhciB4ID0gdG91Y2gyLnBhZ2VYIC0gdG91Y2gxLnBhZ2VYLAogICAgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWTsKICAgIHJldHVybiBNYXRoLnNxcnQoKHgqeCkgKyAoeSp5KSk7CiAgfSwKCgogIC8qKgogICAqIGNhbGN1bGF0ZSB0aGUgc2NhbGUgZmFjdG9yIGJldHdlZW4gdHdvIHRvdWNoTGlzdHMgKGZpbmdlcnMpCiAgICogbm8gc2NhbGUgaXMgMSwgYW5kIGdvZXMgZG93biB0byAwIHdoZW4gcGluY2hlZCB0b2dldGhlciwgYW5kIGJpZ2dlciB3aGVuIHBpbmNoZWQgb3V0CiAgICogQHBhcmFtICAge0FycmF5fSAgICAgc3RhcnQKICAgKiBAcGFyYW0gICB7QXJyYXl9ICAgICBlbmQKICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICBzY2FsZQogICAqLwogIF9fZ2V0U2NhbGU6IGZ1bmN0aW9uIGdldFNjYWxlKHN0YXJ0LCBlbmQpIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgLy8gbmVlZCB0d28gZmluZ2Vycy4uLgogICAgaWYoc3RhcnQubGVuZ3RoID49IDIgJiYgZW5kLmxlbmd0aCA+PSAyKSB7CiAgICAgIHJldHVybiBzZWxmLl9fZ2V0RGlzdGFuY2UoZW5kWzBdLCBlbmRbMV0pIC8KICAgICAgICBzZWxmLl9fZ2V0RGlzdGFuY2Uoc3RhcnRbMF0sIHN0YXJ0WzFdKTsKICAgIH0KICAgIHJldHVybiAxOwogIH0KfSk7Cgppb25pYy5zY3JvbGwgPSB7CiAgaXNTY3JvbGxpbmc6IGZhbHNlLAogIGxhc3RUb3A6IDAKfTsKCn0pKGlvbmljKTsKCihmdW5jdGlvbihpb25pYykgewondXNlIHN0cmljdCc7CgogIGlvbmljLnZpZXdzLkhlYWRlckJhciA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgIHRoaXMuZWwgPSBvcHRzLmVsOwoKICAgICAgaW9uaWMuZXh0ZW5kKHRoaXMsIHsKICAgICAgICBhbGlnblRpdGxlOiAnY2VudGVyJwogICAgICB9LCBvcHRzKTsKCiAgICAgIHRoaXMuYWxpZ24oKTsKICAgIH0sCgogICAgYWxpZ246IGZ1bmN0aW9uKGFsaWduKSB7CgogICAgICBhbGlnbiB8fCAoYWxpZ24gPSB0aGlzLmFsaWduVGl0bGUpOwoKICAgICAgLy8gRmluZCB0aGUgdGl0bGVFbCBlbGVtZW50CiAgICAgIHZhciB0aXRsZUVsID0gdGhpcy5lbC5xdWVyeVNlbGVjdG9yKCcudGl0bGUnKTsKICAgICAgaWYoIXRpdGxlRWwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgLy9XZSBoYXZlIHRvIHJBRiBoZXJlIHNvIGFsbCBvZiB0aGUgZWxlbWVudHMgaGF2ZSB0aW1lIHRvIGluaXRpYWxpemUKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpLCBjLCBjaGlsZFNpemU7CiAgICAgICAgdmFyIGNoaWxkTm9kZXMgPSBzZWxmLmVsLmNoaWxkTm9kZXM7CiAgICAgICAgdmFyIGxlZnRXaWR0aCA9IDA7CiAgICAgICAgdmFyIHJpZ2h0V2lkdGggPSAwOwogICAgICAgIHZhciBpc0NvdW50aW5nUmlnaHRXaWR0aCA9IGZhbHNlOwoKICAgICAgICAvLyBDb21wdXRlIGhvdyB3aWRlIHRoZSBsZWZ0IGNoaWxkcmVuIGFyZQogICAgICAgIC8vIFNraXAgYWxsIHRpdGxlcyAodGhlcmUgbWF5IHN0aWxsIGJlIHR3byB0aXRsZXMsIG9uZSBsZWF2aW5nIHRoZSBkb20pCiAgICAgICAgLy8gT25jZSB3ZSBlbmNvdW50ZXIgYSB0aXRsZUVsLCByZWFsaXplIHdlIGFyZSBub3cgY291bnRpbmcgdGhlIHJpZ2h0LWJ1dHRvbnMsIG5vdCBsZWZ0CiAgICAgICAgZm9yKGkgPSAwOyBpIDwgY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgYyA9IGNoaWxkTm9kZXNbaV07CiAgICAgICAgICBpZiAoYy50YWdOYW1lICYmIGMudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09ICdoMScpIHsKICAgICAgICAgICAgaXNDb3VudGluZ1JpZ2h0V2lkdGggPSB0cnVlOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBjaGlsZFNpemUgPSBudWxsOwogICAgICAgICAgaWYoYy5ub2RlVHlwZSA9PSAzKSB7CiAgICAgICAgICAgIHZhciBib3VuZHMgPSBpb25pYy5Eb21VdGlsLmdldFRleHRCb3VuZHMoYyk7CiAgICAgICAgICAgIGlmKGJvdW5kcykgewogICAgICAgICAgICAgIGNoaWxkU2l6ZSA9IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmKGMubm9kZVR5cGUgPT0gMSkgewogICAgICAgICAgICBjaGlsZFNpemUgPSBjLm9mZnNldFdpZHRoOwogICAgICAgICAgfQogICAgICAgICAgaWYoY2hpbGRTaXplKSB7CiAgICAgICAgICAgIGlmIChpc0NvdW50aW5nUmlnaHRXaWR0aCkgewogICAgICAgICAgICAgIHJpZ2h0V2lkdGggKz0gY2hpbGRTaXplOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxlZnRXaWR0aCArPSBjaGlsZFNpemU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBtYXJnaW4gPSBNYXRoLm1heChsZWZ0V2lkdGgsIHJpZ2h0V2lkdGgpICsgMTA7CgogICAgICAgIC8vUmVzZXQgbGVmdCBhbmQgcmlnaHQgYmVmb3JlIHNldHRpbmcgYWdhaW4KICAgICAgICB0aXRsZUVsLnN0eWxlLmxlZnQgPSB0aXRsZUVsLnN0eWxlLnJpZ2h0ID0gJyc7CgogICAgICAgIC8vIFNpemUgYW5kIGFsaWduIHRoZSBoZWFkZXIgdGl0bGVFbCBiYXNlZCBvbiB0aGUgc2l6ZXMgb2YgdGhlIGxlZnQgYW5kCiAgICAgICAgLy8gcmlnaHQgY2hpbGRyZW4sIGFuZCB0aGUgZGVzaXJlZCBhbGlnbm1lbnQgbW9kZQogICAgICAgIGlmKGFsaWduID09ICdjZW50ZXInKSB7CiAgICAgICAgICBpZihtYXJnaW4gPiAxMCkgewogICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmxlZnQgPSBtYXJnaW4gKyAncHgnOwogICAgICAgICAgICB0aXRsZUVsLnN0eWxlLnJpZ2h0ID0gbWFyZ2luICsgJ3B4JzsKICAgICAgICAgIH0KICAgICAgICAgIGlmKHRpdGxlRWwub2Zmc2V0V2lkdGggPCB0aXRsZUVsLnNjcm9sbFdpZHRoKSB7CiAgICAgICAgICAgIGlmKHJpZ2h0V2lkdGggPiAwKSB7CiAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5yaWdodCA9IChyaWdodFdpZHRoICsgNSkgKyAncHgnOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmKGFsaWduID09ICdsZWZ0JykgewogICAgICAgICAgdGl0bGVFbC5jbGFzc0xpc3QuYWRkKCd0aXRsZS1sZWZ0Jyk7CiAgICAgICAgICBpZihsZWZ0V2lkdGggPiAwKSB7CiAgICAgICAgICAgIHRpdGxlRWwuc3R5bGUubGVmdCA9IChsZWZ0V2lkdGggKyAxNSkgKyAncHgnOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZihhbGlnbiA9PSAncmlnaHQnKSB7CiAgICAgICAgICB0aXRsZUVsLmNsYXNzTGlzdC5hZGQoJ3RpdGxlLXJpZ2h0Jyk7CiAgICAgICAgICBpZihyaWdodFdpZHRoID4gMCkgewogICAgICAgICAgICB0aXRsZUVsLnN0eWxlLnJpZ2h0ID0gKHJpZ2h0V2lkdGggKyAxNSkgKyAncHgnOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7Cgp9KShpb25pYyk7CgooZnVuY3Rpb24oaW9uaWMpIHsKJ3VzZSBzdHJpY3QnOwoKICB2YXIgSVRFTV9DTEFTUyA9ICdpdGVtJzsKICB2YXIgSVRFTV9DT05URU5UX0NMQVNTID0gJ2l0ZW0tY29udGVudCc7CiAgdmFyIElURU1fU0xJRElOR19DTEFTUyA9ICdpdGVtLXNsaWRpbmcnOwogIHZhciBJVEVNX09QVElPTlNfQ0xBU1MgPSAnaXRlbS1vcHRpb25zJzsKICB2YXIgSVRFTV9QTEFDRUhPTERFUl9DTEFTUyA9ICdpdGVtLXBsYWNlaG9sZGVyJzsKICB2YXIgSVRFTV9SRU9SREVSSU5HX0NMQVNTID0gJ2l0ZW0tcmVvcmRlcmluZyc7CiAgdmFyIElURU1fUkVPUkRFUl9CVE5fQ0xBU1MgPSAnaXRlbS1yZW9yZGVyJzsKCiAgdmFyIERyYWdPcCA9IGZ1bmN0aW9uKCkge307CiAgRHJhZ09wLnByb3RvdHlwZSA9IHsKICAgIHN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICB9LAogICAgZHJhZzogZnVuY3Rpb24oZSkgewogICAgfSwKICAgIGVuZDogZnVuY3Rpb24oZSkgewogICAgfSwKICAgIGlzU2FtZUl0ZW06IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07CgogIHZhciBTbGlkZURyYWcgPSBmdW5jdGlvbihvcHRzKSB7CiAgICB0aGlzLmRyYWdUaHJlc2hvbGRYID0gb3B0cy5kcmFnVGhyZXNob2xkWCB8fCAxMDsKICAgIHRoaXMuZWwgPSBvcHRzLmVsOwogICAgdGhpcy5jYW5Td2lwZSA9IG9wdHMuY2FuU3dpcGU7CiAgfTsKCiAgU2xpZGVEcmFnLnByb3RvdHlwZSA9IG5ldyBEcmFnT3AoKTsKCiAgU2xpZGVEcmFnLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKGUpIHsKICAgIHZhciBjb250ZW50LCBidXR0b25zLCBvZmZzZXRYLCBidXR0b25zV2lkdGg7CgogICAgaWYgKCF0aGlzLmNhblN3aXBlKCkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmKGUudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyhJVEVNX0NPTlRFTlRfQ0xBU1MpKSB7CiAgICAgIGNvbnRlbnQgPSBlLnRhcmdldDsKICAgIH0gZWxzZSBpZihlLnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoSVRFTV9DTEFTUykpIHsKICAgICAgY29udGVudCA9IGUudGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJy4nICsgSVRFTV9DT05URU5UX0NMQVNTKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnRlbnQgPSBpb25pYy5Eb21VdGlsLmdldFBhcmVudFdpdGhDbGFzcyhlLnRhcmdldCwgSVRFTV9DT05URU5UX0NMQVNTKTsKICAgIH0KCiAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIGEgY29udGVudCBhcmVhIGFzIG9uZSBvZiBvdXIgY2hpbGRyZW4gKG9yIG91cnNlbHZlcyksIHNraXAKICAgIGlmKCFjb250ZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBNYWtlIHN1cmUgd2UgYXJlbid0IGFuaW1hdGluZyBhcyB3ZSBzbGlkZQogICAgY29udGVudC5jbGFzc0xpc3QucmVtb3ZlKElURU1fU0xJRElOR19DTEFTUyk7CgogICAgLy8gR3JhYiB0aGUgc3RhcnRpbmcgWCBwb2ludCBmb3IgdGhlIGl0ZW0gKGZvciBleGFtcGxlLCBzbyB3ZSBjYW4gdGVsbCB3aGV0aGVyIGl0IGlzIG9wZW4gb3IgY2xvc2VkIHRvIHN0YXJ0KQogICAgb2Zmc2V0WCA9IHBhcnNlRmxvYXQoY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXS5yZXBsYWNlKCd0cmFuc2xhdGUzZCgnLCAnJykuc3BsaXQoJywnKVswXSkgfHwgMDsKCiAgICAvLyBHcmFiIHRoZSBidXR0b25zCiAgICBidXR0b25zID0gY29udGVudC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJy4nICsgSVRFTV9PUFRJT05TX0NMQVNTKTsKICAgIGlmKCFidXR0b25zKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGJ1dHRvbnMuY2xhc3NMaXN0LnJlbW92ZSgnaW52aXNpYmxlJyk7CgogICAgYnV0dG9uc1dpZHRoID0gYnV0dG9ucy5vZmZzZXRXaWR0aDsKCiAgICB0aGlzLl9jdXJyZW50RHJhZyA9IHsKICAgICAgYnV0dG9uczogYnV0dG9ucywKICAgICAgYnV0dG9uc1dpZHRoOiBidXR0b25zV2lkdGgsCiAgICAgIGNvbnRlbnQ6IGNvbnRlbnQsCiAgICAgIHN0YXJ0T2Zmc2V0WDogb2Zmc2V0WAogICAgfTsKICB9OwoKICAvKioKICAgKiBDaGVjayBpZiB0aGlzIGlzIHRoZSBzYW1lIGl0ZW0gdGhhdCB3YXMgcHJldmlvdXNseSBkcmFnZ2VkLgogICAqLwogIFNsaWRlRHJhZy5wcm90b3R5cGUuaXNTYW1lSXRlbSA9IGZ1bmN0aW9uKG9wKSB7CiAgICBpZihvcC5fbGFzdERyYWcgJiYgdGhpcy5fY3VycmVudERyYWcpIHsKICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnREcmFnLmNvbnRlbnQgPT0gb3AuX2xhc3REcmFnLmNvbnRlbnQ7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfTsKCiAgU2xpZGVEcmFnLnByb3RvdHlwZS5jbGVhbiA9IGZ1bmN0aW9uKGUpIHsKICAgIHZhciBsYXN0RHJhZyA9IHRoaXMuX2xhc3REcmFnOwoKICAgIGlmKCFsYXN0RHJhZykgcmV0dXJuOwoKICAgIGxhc3REcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TSVRJT05dID0gJyc7CiAgICBsYXN0RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJyc7CiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgbGFzdERyYWcuYnV0dG9ucyAmJiBsYXN0RHJhZy5idXR0b25zLmNsYXNzTGlzdC5hZGQoJ2ludmlzaWJsZScpOwogICAgICB9LCAyNTApOwogICAgfSk7CiAgfTsKCiAgU2xpZGVEcmFnLnByb3RvdHlwZS5kcmFnID0gaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShmdW5jdGlvbihlKSB7CiAgICB2YXIgYnV0dG9uc1dpZHRoOwoKICAgIC8vIFdlIHJlYWxseSBhcmVuJ3QgZHJhZ2dpbmcKICAgIGlmKCF0aGlzLl9jdXJyZW50RHJhZykgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gQ2hlY2sgaWYgd2Ugc2hvdWxkIHN0YXJ0IGRyYWdnaW5nLiBDaGVjayBpZiB3ZSd2ZSBkcmFnZ2VkIHBhc3QgdGhlIHRocmVzaG9sZCwKICAgIC8vIG9yIHdlIGFyZSBzdGFydGluZyBmcm9tIHRoZSBvcGVuIHN0YXRlLgogICAgaWYoIXRoaXMuX2lzRHJhZ2dpbmcgJiYKICAgICAgICAoKE1hdGguYWJzKGUuZ2VzdHVyZS5kZWx0YVgpID4gdGhpcy5kcmFnVGhyZXNob2xkWCkgfHwKICAgICAgICAoTWF0aC5hYnModGhpcy5fY3VycmVudERyYWcuc3RhcnRPZmZzZXRYKSA+IDApKSkKICAgIHsKICAgICAgdGhpcy5faXNEcmFnZ2luZyA9IHRydWU7CiAgICB9CgogICAgaWYodGhpcy5faXNEcmFnZ2luZykgewogICAgICBidXR0b25zV2lkdGggPSB0aGlzLl9jdXJyZW50RHJhZy5idXR0b25zV2lkdGg7CgogICAgICAvLyBHcmFiIHRoZSBuZXcgWCBwb2ludCwgY2FwcGluZyBpdCBhdCB6ZXJvCiAgICAgIHZhciBuZXdYID0gTWF0aC5taW4oMCwgdGhpcy5fY3VycmVudERyYWcuc3RhcnRPZmZzZXRYICsgZS5nZXN0dXJlLmRlbHRhWCk7CgogICAgICAvLyBJZiB0aGUgbmV3IFggcG9zaXRpb24gaXMgcGFzdCB0aGUgYnV0dG9ucywgd2UgbmVlZCB0byBzbG93IGRvd24gdGhlIGRyYWcgKHJ1YmJlciBiYW5kIHN0eWxlKQogICAgICBpZihuZXdYIDwgLWJ1dHRvbnNXaWR0aCkgewogICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgbmV3IFggcG9zaXRpb24sIGNhcHBlZCBhdCB0aGUgdG9wIG9mIHRoZSBidXR0b25zCiAgICAgICAgbmV3WCA9IE1hdGgubWluKC1idXR0b25zV2lkdGgsIC1idXR0b25zV2lkdGggKyAoKChlLmdlc3R1cmUuZGVsdGFYICsgYnV0dG9uc1dpZHRoKSAqIDAuNCkpKTsKICAgICAgfQoKICAgICAgdGhpcy5fY3VycmVudERyYWcuY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgnICsgbmV3WCArICdweCwgMCwgMCknOwogICAgICB0aGlzLl9jdXJyZW50RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0lUSU9OXSA9ICdub25lJzsKICAgIH0KICB9KTsKCiAgU2xpZGVEcmFnLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbihlLCBkb25lQ2FsbGJhY2spIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgLy8gVGhlcmUgaXMgbm8gZHJhZywganVzdCBlbmQgaW1tZWRpYXRlbHkKICAgIGlmKCF0aGlzLl9jdXJyZW50RHJhZykgewogICAgICBkb25lQ2FsbGJhY2sgJiYgZG9uZUNhbGxiYWNrKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBJZiB3ZSBhcmUgY3VycmVudGx5IGRyYWdnaW5nLCB3ZSB3YW50IHRvIHNuYXAgYmFjayBpbnRvIHBsYWNlCiAgICAvLyBUaGUgZmluYWwgcmVzdGluZyBwb2ludCBYIHdpbGwgYmUgdGhlIHdpZHRoIG9mIHRoZSBleHBvc2VkIGJ1dHRvbnMKICAgIHZhciByZXN0aW5nUG9pbnQgPSAtdGhpcy5fY3VycmVudERyYWcuYnV0dG9uc1dpZHRoOwoKICAgIC8vIENoZWNrIGlmIHRoZSBkcmFnIGRpZG4ndCBjbGVhciB0aGUgYnV0dG9ucyBtaWQtcG9pbnQKICAgIC8vIGFuZCB3ZSBhcmVuJ3QgbW92aW5nIGZhc3QgZW5vdWdoIHRvIHN3aXBlIG9wZW4KICAgIGlmKGUuZ2VzdHVyZS5kZWx0YVggPiAtKHRoaXMuX2N1cnJlbnREcmFnLmJ1dHRvbnNXaWR0aC8yKSkgewoKICAgICAgLy8gSWYgd2UgYXJlIGdvaW5nIGxlZnQgYnV0IHRvbyBzbG93LCBvciBnb2luZyByaWdodCwgZ28gYmFjayB0byByZXN0aW5nCiAgICAgIGlmKGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gImxlZnQiICYmIE1hdGguYWJzKGUuZ2VzdHVyZS52ZWxvY2l0eVgpIDwgMC4zKSB7CiAgICAgICAgcmVzdGluZ1BvaW50ID0gMDsKICAgICAgfSBlbHNlIGlmKGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gInJpZ2h0IikgewogICAgICAgIHJlc3RpbmdQb2ludCA9IDA7CiAgICAgIH0KCiAgICB9CgogICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICBpZihyZXN0aW5nUG9pbnQgPT09IDApIHsKICAgICAgICBfdGhpcy5fY3VycmVudERyYWcuY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICcnOwogICAgICAgIHZhciBidXR0b25zID0gX3RoaXMuX2N1cnJlbnREcmFnLmJ1dHRvbnM7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIGJ1dHRvbnMgJiYgYnV0dG9ucy5jbGFzc0xpc3QuYWRkKCdpbnZpc2libGUnKTsKICAgICAgICB9LCAyNTApOwogICAgICB9IGVsc2UgewogICAgICAgIF90aGlzLl9jdXJyZW50RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKCcgKyByZXN0aW5nUG9pbnQgKyAncHgsIDAsIDApJzsKICAgICAgfQogICAgICBfdGhpcy5fY3VycmVudERyYWcuY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNJVElPTl0gPSAnJzsKCgogICAgICAvLyBLaWxsIHRoZSBjdXJyZW50IGRyYWcKICAgICAgX3RoaXMuX2xhc3REcmFnID0gX3RoaXMuX2N1cnJlbnREcmFnOwogICAgICBfdGhpcy5fY3VycmVudERyYWcgPSBudWxsOwoKICAgICAgLy8gV2UgYXJlIGRvbmUsIG5vdGlmeSBjYWxsZXIKICAgICAgZG9uZUNhbGxiYWNrICYmIGRvbmVDYWxsYmFjaygpOwogICAgfSk7CiAgfTsKCiAgdmFyIFJlb3JkZXJEcmFnID0gZnVuY3Rpb24ob3B0cykgewogICAgdGhpcy5kcmFnVGhyZXNob2xkWSA9IG9wdHMuZHJhZ1RocmVzaG9sZFkgfHwgMDsKICAgIHRoaXMub25SZW9yZGVyID0gb3B0cy5vblJlb3JkZXI7CiAgICB0aGlzLmxpc3RFbCA9IG9wdHMubGlzdEVsOwogICAgdGhpcy5lbCA9IG9wdHMuZWw7CiAgICB0aGlzLnNjcm9sbEVsID0gb3B0cy5zY3JvbGxFbDsKICAgIHRoaXMuc2Nyb2xsVmlldyA9IG9wdHMuc2Nyb2xsVmlldzsKICAgIC8vIEdldCB0aGUgVHJ1ZSBUb3Agb2YgdGhlIGxpc3QgZWwgaHR0cDovL3d3dy5xdWlya3Ntb2RlLm9yZy9qcy9maW5kcG9zLmh0bWwKICAgIHRoaXMubGlzdEVsVHJ1ZVRvcCA9IDA7CiAgICBpZiAodGhpcy5saXN0RWwub2Zmc2V0UGFyZW50KSB7CiAgICAgIHZhciBvYmogPSB0aGlzLmxpc3RFbDsKICAgICAgZG8gewogICAgICAgIHRoaXMubGlzdEVsVHJ1ZVRvcCArPSBvYmoub2Zmc2V0VG9wOwogICAgICAgIG9iaiA9IG9iai5vZmZzZXRQYXJlbnQ7CiAgICAgIH0gd2hpbGUgKG9iaik7CiAgICB9CiAgfTsKCiAgUmVvcmRlckRyYWcucHJvdG90eXBlID0gbmV3IERyYWdPcCgpOwoKICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuX21vdmVFbGVtZW50ID0gZnVuY3Rpb24oZSkgewogICAgdmFyIHkgPSBlLmdlc3R1cmUuY2VudGVyLnBhZ2VZICsKICAgICAgdGhpcy5zY3JvbGxWaWV3LmdldFZhbHVlcygpLnRvcCAtCiAgICAgICh0aGlzLl9jdXJyZW50RHJhZy5lbGVtZW50SGVpZ2h0IC8gMikgLQogICAgICB0aGlzLmxpc3RFbFRydWVUb3A7CiAgICB0aGlzLmVsLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKDAsICcreSsncHgsIDApJzsKICB9OwoKICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbihlKSB7CiAgICB2YXIgY29udGVudDsKCiAgICB2YXIgc3RhcnRJbmRleCA9IGlvbmljLkRvbVV0aWwuZ2V0Q2hpbGRJbmRleCh0aGlzLmVsLCB0aGlzLmVsLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgdmFyIGVsZW1lbnRIZWlnaHQgPSB0aGlzLmVsLnNjcm9sbEhlaWdodDsKICAgIHZhciBwbGFjZWhvbGRlciA9IHRoaXMuZWwuY2xvbmVOb2RlKHRydWUpOwoKICAgIHBsYWNlaG9sZGVyLmNsYXNzTGlzdC5hZGQoSVRFTV9QTEFDRUhPTERFUl9DTEFTUyk7CgogICAgdGhpcy5lbC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwbGFjZWhvbGRlciwgdGhpcy5lbCk7CiAgICB0aGlzLmVsLmNsYXNzTGlzdC5hZGQoSVRFTV9SRU9SREVSSU5HX0NMQVNTKTsKCiAgICB0aGlzLl9jdXJyZW50RHJhZyA9IHsKICAgICAgZWxlbWVudEhlaWdodDogZWxlbWVudEhlaWdodCwKICAgICAgc3RhcnRJbmRleDogc3RhcnRJbmRleCwKICAgICAgcGxhY2Vob2xkZXI6IHBsYWNlaG9sZGVyLAogICAgICBzY3JvbGxIZWlnaHQ6IHNjcm9sbCwKICAgICAgbGlzdDogcGxhY2Vob2xkZXIucGFyZW50Tm9kZQogICAgfTsKCiAgICB0aGlzLl9tb3ZlRWxlbWVudChlKTsKICB9OwoKICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuZHJhZyA9IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oZSkgewogICAgLy8gV2UgcmVhbGx5IGFyZW4ndCBkcmFnZ2luZwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYoIXRoaXMuX2N1cnJlbnREcmFnKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgc2Nyb2xsWSA9IDA7CiAgICB2YXIgcGFnZVkgPSBlLmdlc3R1cmUuY2VudGVyLnBhZ2VZOwogICAgdmFyIG9mZnNldCA9IHRoaXMubGlzdEVsVHJ1ZVRvcDsKCiAgICAvL0lmIHdlIGhhdmUgYSBzY3JvbGxWaWV3LCBjaGVjayBzY3JvbGwgYm91bmRhcmllcyBmb3IgZHJhZ2dlZCBlbGVtZW50IGFuZCBzY3JvbGwgaWYgbmVjZXNzYXJ5CiAgICBpZiAodGhpcy5zY3JvbGxWaWV3KSB7CgogICAgICB2YXIgY29udGFpbmVyID0gdGhpcy5zY3JvbGxWaWV3Ll9fY29udGFpbmVyOwogICAgICBzY3JvbGxZID0gdGhpcy5zY3JvbGxWaWV3LmdldFZhbHVlcygpLnRvcDsKCiAgICAgIHZhciBjb250YWluZXJUb3AgPSBjb250YWluZXIub2Zmc2V0VG9wOwogICAgICB2YXIgcGl4ZWxzUGFzdFRvcCA9IGNvbnRhaW5lclRvcCAtIHBhZ2VZICsgdGhpcy5fY3VycmVudERyYWcuZWxlbWVudEhlaWdodC8yOwogICAgICB2YXIgcGl4ZWxzUGFzdEJvdHRvbSA9IHBhZ2VZICsgdGhpcy5fY3VycmVudERyYWcuZWxlbWVudEhlaWdodC8yIC0gY29udGFpbmVyVG9wIC0gY29udGFpbmVyLm9mZnNldEhlaWdodDsKCiAgICAgIGlmIChlLmdlc3R1cmUuZGVsdGFZIDwgMCAmJiBwaXhlbHNQYXN0VG9wID4gMCAmJiBzY3JvbGxZID4gMCkgewogICAgICAgIHRoaXMuc2Nyb2xsVmlldy5zY3JvbGxCeShudWxsLCAtcGl4ZWxzUGFzdFRvcCk7CiAgICAgICAgLy9UcmlnZ2VyIGFub3RoZXIgZHJhZyBzbyB0aGUgc2Nyb2xsaW5nIGtlZXBzIGdvaW5nCiAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5kcmFnKGUpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChlLmdlc3R1cmUuZGVsdGFZID4gMCAmJiBwaXhlbHNQYXN0Qm90dG9tID4gMCkgewogICAgICAgIGlmIChzY3JvbGxZIDwgdGhpcy5zY3JvbGxWaWV3LmdldFNjcm9sbE1heCgpLnRvcCkgewogICAgICAgICAgdGhpcy5zY3JvbGxWaWV3LnNjcm9sbEJ5KG51bGwsIHBpeGVsc1Bhc3RCb3R0b20pOwogICAgICAgICAgLy9UcmlnZ2VyIGFub3RoZXIgZHJhZyBzbyB0aGUgc2Nyb2xsaW5nIGtlZXBzIGdvaW5nCiAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuZHJhZyhlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIENoZWNrIGlmIHdlIHNob3VsZCBzdGFydCBkcmFnZ2luZy4gQ2hlY2sgaWYgd2UndmUgZHJhZ2dlZCBwYXN0IHRoZSB0aHJlc2hvbGQsCiAgICAvLyBvciB3ZSBhcmUgc3RhcnRpbmcgZnJvbSB0aGUgb3BlbiBzdGF0ZS4KICAgIGlmKCF0aGlzLl9pc0RyYWdnaW5nICYmIE1hdGguYWJzKGUuZ2VzdHVyZS5kZWx0YVkpID4gdGhpcy5kcmFnVGhyZXNob2xkWSkgewogICAgICB0aGlzLl9pc0RyYWdnaW5nID0gdHJ1ZTsKICAgIH0KCiAgICBpZih0aGlzLl9pc0RyYWdnaW5nKSB7CiAgICAgIHRoaXMuX21vdmVFbGVtZW50KGUpOwoKICAgICAgdGhpcy5fY3VycmVudERyYWcuY3VycmVudFkgPSBzY3JvbGxZICsgcGFnZVkgLSBvZmZzZXQ7CgogICAgICAvLyB0aGlzLl9yZW9yZGVySXRlbXMoKTsKICAgIH0KICB9KTsKCiAgLy8gV2hlbiBhbiBpdGVtIGlzIGRyYWdnZWQsIHdlIG5lZWQgdG8gcmVvcmRlciBhbnkgaXRlbXMgZm9yIHNvcnRpbmcgcHVycG9zZXMKICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuX2dldFJlb3JkZXJJbmRleCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBsYWNlaG9sZGVyID0gdGhpcy5fY3VycmVudERyYWcucGxhY2Vob2xkZXI7CiAgICB2YXIgc2libGluZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLl9jdXJyZW50RHJhZy5wbGFjZWhvbGRlci5wYXJlbnROb2RlLmNoaWxkcmVuKQogICAgICAuZmlsdGVyKGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgcmV0dXJuIGVsLm5vZGVOYW1lID09PSBzZWxmLmVsLm5vZGVOYW1lICYmIGVsICE9PSBzZWxmLmVsOwogICAgICB9KTsKCiAgICB2YXIgZHJhZ09mZnNldFRvcCA9IHRoaXMuX2N1cnJlbnREcmFnLmN1cnJlbnRZOwogICAgdmFyIGVsOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHNpYmxpbmdzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGVsID0gc2libGluZ3NbaV07CiAgICAgIGlmIChpID09PSBsZW4gLSAxKSB7CiAgICAgICAgaWYgKGRyYWdPZmZzZXRUb3AgPiBlbC5vZmZzZXRUb3ApIHsKICAgICAgICAgIHJldHVybiBpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpID09PSAwKSB7CiAgICAgICAgaWYgKGRyYWdPZmZzZXRUb3AgPCBlbC5vZmZzZXRUb3AgKyBlbC5vZmZzZXRIZWlnaHQpIHsKICAgICAgICAgIHJldHVybiBpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChkcmFnT2Zmc2V0VG9wID4gZWwub2Zmc2V0VG9wIC0gZWwub2Zmc2V0SGVpZ2h0IC8gMiAmJgogICAgICAgICAgICAgICAgIGRyYWdPZmZzZXRUb3AgPCBlbC5vZmZzZXRUb3AgKyBlbC5vZmZzZXRIZWlnaHQpIHsKICAgICAgICByZXR1cm4gaTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuX2N1cnJlbnREcmFnLnN0YXJ0SW5kZXg7CiAgfTsKCiAgUmVvcmRlckRyYWcucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uKGUsIGRvbmVDYWxsYmFjaykgewogICAgaWYoIXRoaXMuX2N1cnJlbnREcmFnKSB7CiAgICAgIGRvbmVDYWxsYmFjayAmJiBkb25lQ2FsbGJhY2soKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBwbGFjZWhvbGRlciA9IHRoaXMuX2N1cnJlbnREcmFnLnBsYWNlaG9sZGVyOwogICAgdmFyIGZpbmFsSW5kZXggPSB0aGlzLl9nZXRSZW9yZGVySW5kZXgoKTsKCiAgICAvLyBSZXBvc2l0aW9uIHRoZSBlbGVtZW50CiAgICB0aGlzLmVsLmNsYXNzTGlzdC5yZW1vdmUoSVRFTV9SRU9SREVSSU5HX0NMQVNTKTsKICAgIHRoaXMuZWwuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAnJzsKCiAgICBwbGFjZWhvbGRlci5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzLmVsLCBwbGFjZWhvbGRlcik7CiAgICBwbGFjZWhvbGRlci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHBsYWNlaG9sZGVyKTsKCiAgICB0aGlzLm9uUmVvcmRlciAmJiB0aGlzLm9uUmVvcmRlcih0aGlzLmVsLCB0aGlzLl9jdXJyZW50RHJhZy5zdGFydEluZGV4LCBmaW5hbEluZGV4KTsKCiAgICB0aGlzLl9jdXJyZW50RHJhZyA9IG51bGw7CiAgICBkb25lQ2FsbGJhY2sgJiYgZG9uZUNhbGxiYWNrKCk7CiAgfTsKCgoKICAvKioKICAgKiBUaGUgTGlzdFZpZXcgaGFuZGxlcyBhIGxpc3Qgb2YgaXRlbXMuIEl0IHdpbGwgcHJvY2VzcyBkcmFnIGFuaW1hdGlvbnMsIGVkaXQgbW9kZSwKICAgKiBhbmQgb3RoZXIgb3BlcmF0aW9ucyB0aGF0IGFyZSBjb21tb24gb24gbW9iaWxlIGxpc3RzIG9yIHRhYmxlIHZpZXdzLgogICAqLwogIGlvbmljLnZpZXdzLkxpc3RWaWV3ID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIG9wdHMgPSBpb25pYy5leHRlbmQoewogICAgICAgIG9uUmVvcmRlcjogZnVuY3Rpb24oZWwsIG9sZEluZGV4LCBuZXdJbmRleCkge30sCiAgICAgICAgdmlydHVhbFJlbW92ZVRocmVzaG9sZDogLTIwMCwKICAgICAgICB2aXJ0dWFsQWRkVGhyZXNob2xkOiAyMDAsCiAgICAgICAgY2FuU3dpcGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9LCBvcHRzKTsKCiAgICAgIGlvbmljLmV4dGVuZCh0aGlzLCBvcHRzKTsKCiAgICAgIGlmKCF0aGlzLml0ZW1IZWlnaHQgJiYgdGhpcy5saXN0RWwpIHsKICAgICAgICB0aGlzLml0ZW1IZWlnaHQgPSB0aGlzLmxpc3RFbC5jaGlsZHJlblswXSAmJiBwYXJzZUludCh0aGlzLmxpc3RFbC5jaGlsZHJlblswXS5zdHlsZS5oZWlnaHQsIDEwKTsKICAgICAgfQoKICAgICAgLy9pb25pYy52aWV3cy5MaXN0Vmlldy5fX3N1cGVyX18uaW5pdGlhbGl6ZS5jYWxsKHRoaXMsIG9wdHMpOwoKICAgICAgdGhpcy5vblJlZnJlc2ggPSBvcHRzLm9uUmVmcmVzaCB8fCBmdW5jdGlvbigpIHt9OwogICAgICB0aGlzLm9uUmVmcmVzaE9wZW5pbmcgPSBvcHRzLm9uUmVmcmVzaE9wZW5pbmcgfHwgZnVuY3Rpb24oKSB7fTsKICAgICAgdGhpcy5vblJlZnJlc2hIb2xkaW5nID0gb3B0cy5vblJlZnJlc2hIb2xkaW5nIHx8IGZ1bmN0aW9uKCkge307CgogICAgICB3aW5kb3cuaW9uaWMub25HZXN0dXJlKCdyZWxlYXNlJywgZnVuY3Rpb24oZSkgewogICAgICAgIF90aGlzLl9oYW5kbGVFbmREcmFnKGUpOwogICAgICB9LCB0aGlzLmVsKTsKCiAgICAgIHdpbmRvdy5pb25pYy5vbkdlc3R1cmUoJ2RyYWcnLCBmdW5jdGlvbihlKSB7CiAgICAgICAgX3RoaXMuX2hhbmRsZURyYWcoZSk7CiAgICAgIH0sIHRoaXMuZWwpOwogICAgICAvLyBTdGFydCB0aGUgZHJhZyBzdGF0ZXMKICAgICAgdGhpcy5faW5pdERyYWcoKTsKICAgIH0sCiAgICAvKioKICAgICAqIENhbGxlZCB0byB0ZWxsIHRoZSBsaXN0IHRvIHN0b3AgcmVmcmVzaGluZy4gVGhpcyBpcyB1c2VmdWwKICAgICAqIGlmIHlvdSBhcmUgcmVmcmVzaGluZyB0aGUgbGlzdCBhbmQgYXJlIGRvbmUgd2l0aCByZWZyZXNoaW5nLgogICAgICovCiAgICBzdG9wUmVmcmVzaGluZzogZnVuY3Rpb24oKSB7CiAgICAgIHZhciByZWZyZXNoZXIgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3IoJy5saXN0LXJlZnJlc2hlcicpOwogICAgICByZWZyZXNoZXIuc3R5bGUuaGVpZ2h0ID0gJzBweCc7CiAgICB9LAoKICAgIC8qKgogICAgICogSWYgd2Ugc2Nyb2xsZWQgYW5kIGhhdmUgdmlydHVhbCBtb2RlIGVuYWJsZWQsIGNvbXB1dGUgdGhlIHdpbmRvdwogICAgICogb2YgYWN0aXZlIGVsZW1lbnRzIGluIG9yZGVyIHRvIGZpZ3VyZSBvdXQgdGhlIHZpZXdwb3J0IHRvIHJlbmRlci4KICAgICAqLwogICAgZGlkU2Nyb2xsOiBmdW5jdGlvbihlKSB7CiAgICAgIGlmKHRoaXMuaXNWaXJ0dWFsKSB7CiAgICAgICAgdmFyIGl0ZW1IZWlnaHQgPSB0aGlzLml0ZW1IZWlnaHQ7CgogICAgICAgIC8vIFRPRE86IFRoaXMgd291bGQgYmUgaW5hY2N1cmF0ZSBpZiB3ZSBhcmUgd2luZG93ZWQKICAgICAgICB2YXIgdG90YWxJdGVtcyA9IHRoaXMubGlzdEVsLmNoaWxkcmVuLmxlbmd0aDsKCiAgICAgICAgLy8gR3JhYiB0aGUgdG90YWwgaGVpZ2h0IG9mIHRoZSBsaXN0CiAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IGUudGFyZ2V0LnNjcm9sbEhlaWdodDsKCiAgICAgICAgLy8gR2V0IHRoZSB2aWV3cG9ydCBoZWlnaHQKICAgICAgICB2YXIgdmlld3BvcnRIZWlnaHQgPSB0aGlzLmVsLnBhcmVudE5vZGUub2Zmc2V0SGVpZ2h0OwoKICAgICAgICAvLyBzY3JvbGxUb3AgaXMgdGhlIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgdmFyIHNjcm9sbFRvcCA9IGUuc2Nyb2xsVG9wOwoKICAgICAgICAvLyBIaWdoIHdhdGVyIGlzIHRoZSBwaXhlbCBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgZWxlbWVudCB0byBpbmNsdWRlIChldmVyeXRoaW5nIGJlZm9yZQogICAgICAgIC8vIHRoYXQgd2lsbCBiZSByZW1vdmVkKQogICAgICAgIHZhciBoaWdoV2F0ZXIgPSBNYXRoLm1heCgwLCBlLnNjcm9sbFRvcCArIHRoaXMudmlydHVhbFJlbW92ZVRocmVzaG9sZCk7CgogICAgICAgIC8vIExvdyB3YXRlciBpcyB0aGUgcGl4ZWwgcG9zaXRpb24gb2YgdGhlIGxhc3QgZWxlbWVudCB0byBpbmNsdWRlIChldmVyeXRoaW5nIGFmdGVyCiAgICAgICAgLy8gdGhhdCB3aWxsIGJlIHJlbW92ZWQpCiAgICAgICAgdmFyIGxvd1dhdGVyID0gTWF0aC5taW4oc2Nyb2xsSGVpZ2h0LCBNYXRoLmFicyhlLnNjcm9sbFRvcCkgKyB2aWV3cG9ydEhlaWdodCArIHRoaXMudmlydHVhbEFkZFRocmVzaG9sZCk7CgogICAgICAgIC8vIENvbXB1dGUgaG93IG1hbnkgaXRlbXMgcGVyIHZpZXdwb3J0IHNpemUgY2FuIHNob3cKICAgICAgICB2YXIgaXRlbXNQZXJWaWV3cG9ydCA9IE1hdGguZmxvb3IoKGxvd1dhdGVyIC0gaGlnaFdhdGVyKSAvIGl0ZW1IZWlnaHQpOwoKICAgICAgICAvLyBHZXQgdGhlIGZpcnN0IGFuZCBsYXN0IGVsZW1lbnRzIGluIHRoZSBsaXN0IGJhc2VkIG9uIGhvdyBtYW55IGNhbiBmaXQKICAgICAgICAvLyBiZXR3ZWVuIHRoZSBwaXhlbCByYW5nZSBvZiBsb3dXYXRlciBhbmQgaGlnaFdhdGVyCiAgICAgICAgdmFyIGZpcnN0ID0gcGFyc2VJbnQoTWF0aC5hYnMoaGlnaFdhdGVyIC8gaXRlbUhlaWdodCksIDEwKTsKICAgICAgICB2YXIgbGFzdCA9IHBhcnNlSW50KE1hdGguYWJzKGxvd1dhdGVyIC8gaXRlbUhlaWdodCksIDEwKTsKCiAgICAgICAgLy8gR2V0IHRoZSBpdGVtcyB3ZSBuZWVkIHRvIHJlbW92ZQogICAgICAgIHRoaXMuX3ZpcnR1YWxJdGVtc1RvUmVtb3ZlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5saXN0RWwuY2hpbGRyZW4sIDAsIGZpcnN0KTsKCiAgICAgICAgLy8gR3JhYiB0aGUgbm9kZXMgd2Ugd2lsbCBiZSBzaG93aW5nCiAgICAgICAgdmFyIG5vZGVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5saXN0RWwuY2hpbGRyZW4sIGZpcnN0LCBmaXJzdCArIGl0ZW1zUGVyVmlld3BvcnQpOwoKICAgICAgICB0aGlzLnJlbmRlclZpZXdwb3J0ICYmIHRoaXMucmVuZGVyVmlld3BvcnQoaGlnaFdhdGVyLCBsb3dXYXRlciwgZmlyc3QsIGxhc3QpOwogICAgICB9CiAgICB9LAoKICAgIGRpZFN0b3BTY3JvbGxpbmc6IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYodGhpcy5pc1ZpcnR1YWwpIHsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgdGhpcy5fdmlydHVhbEl0ZW1zVG9SZW1vdmUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBlbCA9IHRoaXMuX3ZpcnR1YWxJdGVtc1RvUmVtb3ZlW2ldOwogICAgICAgICAgLy9lbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsKTsKICAgICAgICAgIHRoaXMuZGlkSGlkZUl0ZW0gJiYgdGhpcy5kaWRIaWRlSXRlbShpKTsKICAgICAgICB9CiAgICAgICAgLy8gT25jZSBzY3JvbGxpbmcgc3RvcHMsIGNoZWNrIGlmIHdlIG5lZWQgdG8gcmVtb3ZlIG9sZCBpdGVtcwoKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIENsZWFyIGFueSBhY3RpdmUgZHJhZyBlZmZlY3RzIG9uIHRoZSBsaXN0LgogICAgICovCiAgICBjbGVhckRyYWdFZmZlY3RzOiBmdW5jdGlvbigpIHsKICAgICAgaWYodGhpcy5fbGFzdERyYWdPcCkgewogICAgICAgIHRoaXMuX2xhc3REcmFnT3AuY2xlYW4gJiYgdGhpcy5fbGFzdERyYWdPcC5jbGVhbigpOwogICAgICAgIHRoaXMuX2xhc3REcmFnT3AgPSBudWxsOwogICAgICB9CiAgICB9LAoKICAgIF9pbml0RHJhZzogZnVuY3Rpb24oKSB7CiAgICAgIC8vaW9uaWMudmlld3MuTGlzdFZpZXcuX19zdXBlcl9fLl9pbml0RHJhZy5jYWxsKHRoaXMpOwoKICAgICAgLy8gU3RvcmUgdGhlIGxhc3Qgb25lCiAgICAgIHRoaXMuX2xhc3REcmFnT3AgPSB0aGlzLl9kcmFnT3A7CgogICAgICB0aGlzLl9kcmFnT3AgPSBudWxsOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGxpc3QgaXRlbSBmcm9tIHRoZSBnaXZlbiB0YXJnZXQKICAgIF9nZXRJdGVtOiBmdW5jdGlvbih0YXJnZXQpIHsKICAgICAgd2hpbGUodGFyZ2V0KSB7CiAgICAgICAgaWYodGFyZ2V0LmNsYXNzTGlzdCAmJiB0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKElURU1fQ0xBU1MpKSB7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0KICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgoKICAgIF9zdGFydERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBkaWRTdGFydCA9IGZhbHNlOwoKICAgICAgdGhpcy5faXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgdmFyIGxhc3REcmFnT3AgPSB0aGlzLl9sYXN0RHJhZ09wOwogICAgICB2YXIgaXRlbTsKCiAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSByZW9yZGVyIGRyYWcKICAgICAgaWYoaW9uaWMuRG9tVXRpbC5nZXRQYXJlbnRPclNlbGZXaXRoQ2xhc3MoZS50YXJnZXQsIElURU1fUkVPUkRFUl9CVE5fQ0xBU1MpICYmIChlLmdlc3R1cmUuZGlyZWN0aW9uID09ICd1cCcgfHwgZS5nZXN0dXJlLmRpcmVjdGlvbiA9PSAnZG93bicpKSB7CiAgICAgICAgaXRlbSA9IHRoaXMuX2dldEl0ZW0oZS50YXJnZXQpOwoKICAgICAgICBpZihpdGVtKSB7CiAgICAgICAgICB0aGlzLl9kcmFnT3AgPSBuZXcgUmVvcmRlckRyYWcoewogICAgICAgICAgICBsaXN0RWw6IHRoaXMuZWwsCiAgICAgICAgICAgIGVsOiBpdGVtLAogICAgICAgICAgICBzY3JvbGxFbDogdGhpcy5zY3JvbGxFbCwKICAgICAgICAgICAgc2Nyb2xsVmlldzogdGhpcy5zY3JvbGxWaWV3LAogICAgICAgICAgICBvblJlb3JkZXI6IGZ1bmN0aW9uKGVsLCBzdGFydCwgZW5kKSB7CiAgICAgICAgICAgICAgX3RoaXMub25SZW9yZGVyICYmIF90aGlzLm9uUmVvcmRlcihlbCwgc3RhcnQsIGVuZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5fZHJhZ09wLnN0YXJ0KGUpOwogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gT3IgY2hlY2sgaWYgdGhpcyBpcyBhIHN3aXBlIHRvIHRoZSBzaWRlIGRyYWcKICAgICAgZWxzZSBpZighdGhpcy5fZGlkRHJhZ1VwT3JEb3duICYmIChlLmdlc3R1cmUuZGlyZWN0aW9uID09ICdsZWZ0JyB8fCBlLmdlc3R1cmUuZGlyZWN0aW9uID09ICdyaWdodCcpICYmIE1hdGguYWJzKGUuZ2VzdHVyZS5kZWx0YVgpID4gNSkgewoKICAgICAgICAvLyBNYWtlIHN1cmUgdGhpcyBpcyBhbiBpdGVtIHdpdGggYnV0dG9ucwogICAgICAgIGl0ZW0gPSB0aGlzLl9nZXRJdGVtKGUudGFyZ2V0KTsKICAgICAgICBpZihpdGVtICYmIGl0ZW0ucXVlcnlTZWxlY3RvcignLml0ZW0tb3B0aW9ucycpKSB7CiAgICAgICAgICB0aGlzLl9kcmFnT3AgPSBuZXcgU2xpZGVEcmFnKHsgZWw6IHRoaXMuZWwsIGNhblN3aXBlOiB0aGlzLmNhblN3aXBlIH0pOwogICAgICAgICAgdGhpcy5fZHJhZ09wLnN0YXJ0KGUpOwogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gSWYgd2UgaGFkIGEgbGFzdCBkcmFnIG9wZXJhdGlvbiBhbmQgdGhpcyBpcyBhIG5ldyBvbmUgb24gYSBkaWZmZXJlbnQgaXRlbSwgY2xlYW4gdGhhdCBsYXN0IG9uZQogICAgICBpZihsYXN0RHJhZ09wICYmIHRoaXMuX2RyYWdPcCAmJiAhdGhpcy5fZHJhZ09wLmlzU2FtZUl0ZW0obGFzdERyYWdPcCkgJiYgZS5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgbGFzdERyYWdPcC5jbGVhbiAmJiBsYXN0RHJhZ09wLmNsZWFuKCk7CiAgICAgIH0KICAgIH0sCgoKICAgIF9oYW5kbGVFbmREcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB0aGlzLl9kaWREcmFnVXBPckRvd24gPSBmYWxzZTsKCiAgICAgIGlmKCF0aGlzLl9kcmFnT3ApIHsKICAgICAgICAvL2lvbmljLnZpZXdzLkxpc3RWaWV3Ll9fc3VwZXJfXy5faGFuZGxlRW5kRHJhZy5jYWxsKHRoaXMsIGUpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fZHJhZ09wLmVuZChlLCBmdW5jdGlvbigpIHsKICAgICAgICBfdGhpcy5faW5pdERyYWcoKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogUHJvY2VzcyB0aGUgZHJhZyBldmVudCB0byBtb3ZlIHRoZSBpdGVtIHRvIHRoZSBsZWZ0IG9yIHJpZ2h0LgogICAgICovCiAgICBfaGFuZGxlRHJhZzogZnVuY3Rpb24oZSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzLCBjb250ZW50LCBidXR0b25zOwoKICAgICAgaWYoTWF0aC5hYnMoZS5nZXN0dXJlLmRlbHRhWSkgPiA1KSB7CiAgICAgICAgdGhpcy5fZGlkRHJhZ1VwT3JEb3duID0gdHJ1ZTsKICAgICAgfQoKICAgICAgLy8gSWYgd2UgZ2V0IGEgZHJhZyBldmVudCwgbWFrZSBzdXJlIHdlIGFyZW4ndCBpbiBhbm90aGVyIGRyYWcsIHRoZW4gY2hlY2sgaWYgd2Ugc2hvdWxkCiAgICAgIC8vIHN0YXJ0IG9uZQogICAgICBpZighdGhpcy5pc0RyYWdnaW5nICYmICF0aGlzLl9kcmFnT3ApIHsKICAgICAgICB0aGlzLl9zdGFydERyYWcoZSk7CiAgICAgIH0KCiAgICAgIC8vIE5vIGRyYWcgc3RpbGwsIHBhc3MgaXQgdXAKICAgICAgaWYoIXRoaXMuX2RyYWdPcCkgewogICAgICAgIC8vaW9uaWMudmlld3MuTGlzdFZpZXcuX19zdXBlcl9fLl9oYW5kbGVEcmFnLmNhbGwodGhpcywgZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBlLmdlc3R1cmUuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgdGhpcy5fZHJhZ09wLmRyYWcoZSk7CiAgICB9CgogIH0pOwoKfSkoaW9uaWMpOwoKKGZ1bmN0aW9uKGlvbmljKSB7Cid1c2Ugc3RyaWN0JzsKCiAgaW9uaWMudmlld3MuTW9kYWwgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICBvcHRzID0gaW9uaWMuZXh0ZW5kKHsKICAgICAgICBmb2N1c0ZpcnN0SW5wdXQ6IGZhbHNlLAogICAgICAgIHVuZm9jdXNPbkhpZGU6IHRydWUsCiAgICAgICAgZm9jdXNGaXJzdERlbGF5OiA2MDAsCiAgICAgICAgYmFja2Ryb3BDbGlja1RvQ2xvc2U6IHRydWUsCiAgICAgICAgaGFyZHdhcmVCYWNrQnV0dG9uQ2xvc2U6IHRydWUsCiAgICAgIH0sIG9wdHMpOwoKICAgICAgaW9uaWMuZXh0ZW5kKHRoaXMsIG9wdHMpOwoKICAgICAgdGhpcy5lbCA9IG9wdHMuZWw7CiAgICB9LAogICAgc2hvdzogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIGlmKHNlbGYuZm9jdXNGaXJzdElucHV0KSB7CiAgICAgICAgLy8gTGV0IGFueSBhbmltYXRpb25zIHJ1biBmaXJzdAogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGlucHV0ID0gc2VsZi5lbC5xdWVyeVNlbGVjdG9yKCdpbnB1dCwgdGV4dGFyZWEnKTsKICAgICAgICAgIGlucHV0ICYmIGlucHV0LmZvY3VzICYmIGlucHV0LmZvY3VzKCk7CiAgICAgICAgfSwgc2VsZi5mb2N1c0ZpcnN0RGVsYXkpOwogICAgICB9CiAgICB9LAogICAgaGlkZTogZnVuY3Rpb24oKSB7CiAgICAgIC8vIFVuZm9jdXMgYWxsIGVsZW1lbnRzCiAgICAgIGlmKHRoaXMudW5mb2N1c09uSGlkZSkgewogICAgICAgIHZhciBpbnB1dHMgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0LCB0ZXh0YXJlYScpOwogICAgICAgIC8vIExldCBhbnkgYW5pbWF0aW9ucyBydW4gZmlyc3QKICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBpbnB1dHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaW5wdXRzW2ldLmJsdXIgJiYgaW5wdXRzW2ldLmJsdXIoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0pOwoKfSkoaW9uaWMpOwoKKGZ1bmN0aW9uKGlvbmljKSB7Cid1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogVGhlIHNpZGUgbWVudSB2aWV3IGhhbmRsZXMgb25lIG9mIHRoZSBzaWRlIG1lbnUncyBpbiBhIFNpZGUgTWVudSBDb250cm9sbGVyCiAgICogY29uZmlndXJhdGlvbi4KICAgKiBJdCB0YWtlcyBhIERPTSByZWZlcmVuY2UgdG8gdGhhdCBzaWRlIG1lbnUgZWxlbWVudC4KICAgKi8KICBpb25pYy52aWV3cy5TaWRlTWVudSA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgIHRoaXMuZWwgPSBvcHRzLmVsOwogICAgICB0aGlzLmlzRW5hYmxlZCA9ICh0eXBlb2Ygb3B0cy5pc0VuYWJsZWQgPT09ICd1bmRlZmluZWQnKSA/IHRydWUgOiBvcHRzLmlzRW5hYmxlZDsKICAgICAgdGhpcy5zZXRXaWR0aChvcHRzLndpZHRoKTsKICAgIH0sCiAgICBnZXRGdWxsV2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy53aWR0aDsKICAgIH0sCiAgICBzZXRXaWR0aDogZnVuY3Rpb24od2lkdGgpIHsKICAgICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgICB0aGlzLmVsLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgfSwKICAgIHNldElzRW5hYmxlZDogZnVuY3Rpb24oaXNFbmFibGVkKSB7CiAgICAgIHRoaXMuaXNFbmFibGVkID0gaXNFbmFibGVkOwogICAgfSwKICAgIGJyaW5nVXA6IGZ1bmN0aW9uKCkgewogICAgICBpZih0aGlzLmVsLnN0eWxlLnpJbmRleCAhPT0gJzAnKSB7CiAgICAgICAgdGhpcy5lbC5zdHlsZS56SW5kZXggPSAnMCc7CiAgICAgIH0KICAgIH0sCiAgICBwdXNoRG93bjogZnVuY3Rpb24oKSB7CiAgICAgIGlmKHRoaXMuZWwuc3R5bGUuekluZGV4ICE9PSAnLTEnKSB7CiAgICAgICAgdGhpcy5lbC5zdHlsZS56SW5kZXggPSAnLTEnOwogICAgICB9CiAgICB9CiAgfSk7CgogIGlvbmljLnZpZXdzLlNpZGVNZW51Q29udGVudCA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgIGlvbmljLmV4dGVuZCh0aGlzLCB7CiAgICAgICAgYW5pbWF0aW9uQ2xhc3M6ICdtZW51LWFuaW1hdGVkJywKICAgICAgICBvbkRyYWc6IGZ1bmN0aW9uKGUpIHt9LAogICAgICAgIG9uRW5kRHJhZzogZnVuY3Rpb24oZSkge30KICAgICAgfSwgb3B0cyk7CgogICAgICBpb25pYy5vbkdlc3R1cmUoJ2RyYWcnLCBpb25pYy5wcm94eSh0aGlzLl9vbkRyYWcsIHRoaXMpLCB0aGlzLmVsKTsKICAgICAgaW9uaWMub25HZXN0dXJlKCdyZWxlYXNlJywgaW9uaWMucHJveHkodGhpcy5fb25FbmREcmFnLCB0aGlzKSwgdGhpcy5lbCk7CiAgICB9LAogICAgX29uRHJhZzogZnVuY3Rpb24oZSkgewogICAgICB0aGlzLm9uRHJhZyAmJiB0aGlzLm9uRHJhZyhlKTsKICAgIH0sCiAgICBfb25FbmREcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgIHRoaXMub25FbmREcmFnICYmIHRoaXMub25FbmREcmFnKGUpOwogICAgfSwKICAgIGRpc2FibGVBbmltYXRpb246IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmVsLmNsYXNzTGlzdC5yZW1vdmUodGhpcy5hbmltYXRpb25DbGFzcyk7CiAgICB9LAogICAgZW5hYmxlQW5pbWF0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5lbC5jbGFzc0xpc3QuYWRkKHRoaXMuYW5pbWF0aW9uQ2xhc3MpOwogICAgfSwKICAgIGdldFRyYW5zbGF0ZVg6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcGFyc2VGbG9hdCh0aGlzLmVsLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dLnJlcGxhY2UoJ3RyYW5zbGF0ZTNkKCcsICcnKS5zcGxpdCgnLCcpWzBdKTsKICAgIH0sCiAgICBzZXRUcmFuc2xhdGVYOiBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKHgpIHsKICAgICAgdGhpcy5lbC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgnICsgeCArICdweCwgMCwgMCknOwogICAgfSkKICB9KTsKCn0pKGlvbmljKTsKCi8qCiAqIEFkYXB0ZWQgZnJvbSBTd2lwZS5qcyAyLjAKICoKICogQnJhZCBCaXJkc2FsbAogKiBDb3B5cmlnaHQgMjAxMywgTUlUIExpY2Vuc2UKICoKKi8KCihmdW5jdGlvbihpb25pYykgewondXNlIHN0cmljdCc7Cgppb25pYy52aWV3cy5TbGlkZXIgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogIGluaXRpYWxpemU6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB2YXIgc2xpZGVyID0gdGhpczsKCiAgICAvLyB1dGlsaXRpZXMKICAgIHZhciBub29wID0gZnVuY3Rpb24oKSB7fTsgLy8gc2ltcGxlIG5vIG9wZXJhdGlvbiBmdW5jdGlvbgogICAgdmFyIG9mZmxvYWRGbiA9IGZ1bmN0aW9uKGZuKSB7IHNldFRpbWVvdXQoZm4gfHwgbm9vcCwgMCk7IH07IC8vIG9mZmxvYWQgYSBmdW5jdGlvbnMgZXhlY3V0aW9uCgogICAgLy8gY2hlY2sgYnJvd3NlciBjYXBhYmlsaXRpZXMKICAgIHZhciBicm93c2VyID0gewogICAgICBhZGRFdmVudExpc3RlbmVyOiAhIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyLAogICAgICB0b3VjaDogKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdykgfHwgd2luZG93LkRvY3VtZW50VG91Y2ggJiYgZG9jdW1lbnQgaW5zdGFuY2VvZiBEb2N1bWVudFRvdWNoLAogICAgICB0cmFuc2l0aW9uczogKGZ1bmN0aW9uKHRlbXApIHsKICAgICAgICB2YXIgcHJvcHMgPSBbJ3RyYW5zaXRpb25Qcm9wZXJ0eScsICdXZWJraXRUcmFuc2l0aW9uJywgJ01velRyYW5zaXRpb24nLCAnT1RyYW5zaXRpb24nLCAnbXNUcmFuc2l0aW9uJ107CiAgICAgICAgZm9yICggdmFyIGkgaW4gcHJvcHMgKSBpZiAodGVtcC5zdHlsZVsgcHJvcHNbaV0gXSAhPT0gdW5kZWZpbmVkKSByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0pKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N3aXBlJykpCiAgICB9OwoKCiAgICB2YXIgY29udGFpbmVyID0gb3B0aW9ucy5lbDsKCiAgICAvLyBxdWl0IGlmIG5vIHJvb3QgZWxlbWVudAogICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKICAgIHZhciBlbGVtZW50ID0gY29udGFpbmVyLmNoaWxkcmVuWzBdOwogICAgdmFyIHNsaWRlcywgc2xpZGVQb3MsIHdpZHRoLCBsZW5ndGg7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhciBpbmRleCA9IHBhcnNlSW50KG9wdGlvbnMuc3RhcnRTbGlkZSwgMTApIHx8IDA7CiAgICB2YXIgc3BlZWQgPSBvcHRpb25zLnNwZWVkIHx8IDMwMDsKICAgIG9wdGlvbnMuY29udGludW91cyA9IG9wdGlvbnMuY29udGludW91cyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jb250aW51b3VzIDogdHJ1ZTsKCiAgICBmdW5jdGlvbiBzZXR1cCgpIHsKCiAgICAgIC8vIGNhY2hlIHNsaWRlcwogICAgICBzbGlkZXMgPSBlbGVtZW50LmNoaWxkcmVuOwogICAgICBsZW5ndGggPSBzbGlkZXMubGVuZ3RoOwoKICAgICAgLy8gc2V0IGNvbnRpbnVvdXMgdG8gZmFsc2UgaWYgb25seSBvbmUgc2xpZGUKICAgICAgaWYgKHNsaWRlcy5sZW5ndGggPCAyKSBvcHRpb25zLmNvbnRpbnVvdXMgPSBmYWxzZTsKCiAgICAgIC8vc3BlY2lhbCBjYXNlIGlmIHR3byBzbGlkZXMKICAgICAgaWYgKGJyb3dzZXIudHJhbnNpdGlvbnMgJiYgb3B0aW9ucy5jb250aW51b3VzICYmIHNsaWRlcy5sZW5ndGggPCAzKSB7CiAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChzbGlkZXNbMF0uY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGVsZW1lbnQuY2hpbGRyZW5bMV0uY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICBzbGlkZXMgPSBlbGVtZW50LmNoaWxkcmVuOwogICAgICB9CgogICAgICAvLyBjcmVhdGUgYW4gYXJyYXkgdG8gc3RvcmUgY3VycmVudCBwb3NpdGlvbnMgb2YgZWFjaCBzbGlkZQogICAgICBzbGlkZVBvcyA9IG5ldyBBcnJheShzbGlkZXMubGVuZ3RoKTsKCiAgICAgIC8vIGRldGVybWluZSB3aWR0aCBvZiBlYWNoIHNsaWRlCiAgICAgIHdpZHRoID0gY29udGFpbmVyLm9mZnNldFdpZHRoIHx8IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aDsKCiAgICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSAoc2xpZGVzLmxlbmd0aCAqIHdpZHRoKSArICdweCc7CgogICAgICAvLyBzdGFjayBlbGVtZW50cwogICAgICB2YXIgcG9zID0gc2xpZGVzLmxlbmd0aDsKICAgICAgd2hpbGUocG9zLS0pIHsKCiAgICAgICAgdmFyIHNsaWRlID0gc2xpZGVzW3Bvc107CgogICAgICAgIHNsaWRlLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICAgIHNsaWRlLnNldEF0dHJpYnV0ZSgnZGF0YS1pbmRleCcsIHBvcyk7CgogICAgICAgIGlmIChicm93c2VyLnRyYW5zaXRpb25zKSB7CiAgICAgICAgICBzbGlkZS5zdHlsZS5sZWZ0ID0gKHBvcyAqIC13aWR0aCkgKyAncHgnOwogICAgICAgICAgbW92ZShwb3MsIGluZGV4ID4gcG9zID8gLXdpZHRoIDogKGluZGV4IDwgcG9zID8gd2lkdGggOiAwKSwgMCk7CiAgICAgICAgfQoKICAgICAgfQoKICAgICAgLy8gcmVwb3NpdGlvbiBlbGVtZW50cyBiZWZvcmUgYW5kIGFmdGVyIGluZGV4CiAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMgJiYgYnJvd3Nlci50cmFuc2l0aW9ucykgewogICAgICAgIG1vdmUoY2lyY2xlKGluZGV4LTEpLCAtd2lkdGgsIDApOwogICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzEpLCB3aWR0aCwgMCk7CiAgICAgIH0KCiAgICAgIGlmICghYnJvd3Nlci50cmFuc2l0aW9ucykgZWxlbWVudC5zdHlsZS5sZWZ0ID0gKGluZGV4ICogLXdpZHRoKSArICdweCc7CgogICAgICBjb250YWluZXIuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCiAgICAgIG9wdGlvbnMuc2xpZGVzQ2hhbmdlZCAmJiBvcHRpb25zLnNsaWRlc0NoYW5nZWQoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwcmV2KCkgewoKICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgc2xpZGUoaW5kZXgtMSk7CiAgICAgIGVsc2UgaWYgKGluZGV4KSBzbGlkZShpbmRleC0xKTsKCiAgICB9CgogICAgZnVuY3Rpb24gbmV4dCgpIHsKCiAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHNsaWRlKGluZGV4KzEpOwogICAgICBlbHNlIGlmIChpbmRleCA8IHNsaWRlcy5sZW5ndGggLSAxKSBzbGlkZShpbmRleCsxKTsKCiAgICB9CgogICAgZnVuY3Rpb24gY2lyY2xlKGluZGV4KSB7CgogICAgICAvLyBhIHNpbXBsZSBwb3NpdGl2ZSBtb2R1bG8gdXNpbmcgc2xpZGVzLmxlbmd0aAogICAgICByZXR1cm4gKHNsaWRlcy5sZW5ndGggKyAoaW5kZXggJSBzbGlkZXMubGVuZ3RoKSkgJSBzbGlkZXMubGVuZ3RoOwoKICAgIH0KCiAgICBmdW5jdGlvbiBzbGlkZSh0bywgc2xpZGVTcGVlZCkgewoKICAgICAgLy8gZG8gbm90aGluZyBpZiBhbHJlYWR5IG9uIHJlcXVlc3RlZCBzbGlkZQogICAgICBpZiAoaW5kZXggPT0gdG8pIHJldHVybjsKCiAgICAgIGlmIChicm93c2VyLnRyYW5zaXRpb25zKSB7CgogICAgICAgIHZhciBkaXJlY3Rpb24gPSBNYXRoLmFicyhpbmRleC10bykgLyAoaW5kZXgtdG8pOyAvLyAxOiBiYWNrd2FyZCwgLTE6IGZvcndhcmQKCiAgICAgICAgLy8gZ2V0IHRoZSBhY3R1YWwgcG9zaXRpb24gb2YgdGhlIHNsaWRlCiAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgewogICAgICAgICAgdmFyIG5hdHVyYWxfZGlyZWN0aW9uID0gZGlyZWN0aW9uOwogICAgICAgICAgZGlyZWN0aW9uID0gLXNsaWRlUG9zW2NpcmNsZSh0byldIC8gd2lkdGg7CgogICAgICAgICAgLy8gaWYgZ29pbmcgZm9yd2FyZCBidXQgdG8gPCBpbmRleCwgdXNlIHRvID0gc2xpZGVzLmxlbmd0aCArIHRvCiAgICAgICAgICAvLyBpZiBnb2luZyBiYWNrd2FyZCBidXQgdG8gPiBpbmRleCwgdXNlIHRvID0gLXNsaWRlcy5sZW5ndGggKyB0bwogICAgICAgICAgaWYgKGRpcmVjdGlvbiAhPT0gbmF0dXJhbF9kaXJlY3Rpb24pIHRvID0gIC1kaXJlY3Rpb24gKiBzbGlkZXMubGVuZ3RoICsgdG87CgogICAgICAgIH0KCiAgICAgICAgdmFyIGRpZmYgPSBNYXRoLmFicyhpbmRleC10bykgLSAxOwoKICAgICAgICAvLyBtb3ZlIGFsbCB0aGUgc2xpZGVzIGJldHdlZW4gaW5kZXggYW5kIHRvIGluIHRoZSByaWdodCBkaXJlY3Rpb24KICAgICAgICB3aGlsZSAoZGlmZi0tKSBtb3ZlKCBjaXJjbGUoKHRvID4gaW5kZXggPyB0byA6IGluZGV4KSAtIGRpZmYgLSAxKSwgd2lkdGggKiBkaXJlY3Rpb24sIDApOwoKICAgICAgICB0byA9IGNpcmNsZSh0byk7CgogICAgICAgIG1vdmUoaW5kZXgsIHdpZHRoICogZGlyZWN0aW9uLCBzbGlkZVNwZWVkIHx8IHNwZWVkKTsKICAgICAgICBtb3ZlKHRvLCAwLCBzbGlkZVNwZWVkIHx8IHNwZWVkKTsKCiAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgbW92ZShjaXJjbGUodG8gLSBkaXJlY3Rpb24pLCAtKHdpZHRoICogZGlyZWN0aW9uKSwgMCk7IC8vIHdlIG5lZWQgdG8gZ2V0IHRoZSBuZXh0IGluIHBsYWNlCgogICAgICB9IGVsc2UgewoKICAgICAgICB0byA9IGNpcmNsZSh0byk7CiAgICAgICAgYW5pbWF0ZShpbmRleCAqIC13aWR0aCwgdG8gKiAtd2lkdGgsIHNsaWRlU3BlZWQgfHwgc3BlZWQpOwogICAgICAgIC8vbm8gZmFsbGJhY2sgZm9yIGEgY2lyY3VsYXIgY29udGludW91cyBpZiB0aGUgYnJvd3NlciBkb2VzIG5vdCBhY2NlcHQgdHJhbnNpdGlvbnMKICAgICAgfQoKICAgICAgaW5kZXggPSB0bzsKICAgICAgb2ZmbG9hZEZuKG9wdGlvbnMuY2FsbGJhY2sgJiYgb3B0aW9ucy5jYWxsYmFjayhpbmRleCwgc2xpZGVzW2luZGV4XSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIG1vdmUoaW5kZXgsIGRpc3QsIHNwZWVkKSB7CgogICAgICB0cmFuc2xhdGUoaW5kZXgsIGRpc3QsIHNwZWVkKTsKICAgICAgc2xpZGVQb3NbaW5kZXhdID0gZGlzdDsKCiAgICB9CgogICAgZnVuY3Rpb24gdHJhbnNsYXRlKGluZGV4LCBkaXN0LCBzcGVlZCkgewoKICAgICAgdmFyIHNsaWRlID0gc2xpZGVzW2luZGV4XTsKICAgICAgdmFyIHN0eWxlID0gc2xpZGUgJiYgc2xpZGUuc3R5bGU7CgogICAgICBpZiAoIXN0eWxlKSByZXR1cm47CgogICAgICBzdHlsZS53ZWJraXRUcmFuc2l0aW9uRHVyYXRpb24gPQogICAgICBzdHlsZS5Nb3pUcmFuc2l0aW9uRHVyYXRpb24gPQogICAgICBzdHlsZS5tc1RyYW5zaXRpb25EdXJhdGlvbiA9CiAgICAgIHN0eWxlLk9UcmFuc2l0aW9uRHVyYXRpb24gPQogICAgICBzdHlsZS50cmFuc2l0aW9uRHVyYXRpb24gPSBzcGVlZCArICdtcyc7CgogICAgICBzdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSAndHJhbnNsYXRlKCcgKyBkaXN0ICsgJ3B4LDApJyArICd0cmFuc2xhdGVaKDApJzsKICAgICAgc3R5bGUubXNUcmFuc2Zvcm0gPQogICAgICBzdHlsZS5Nb3pUcmFuc2Zvcm0gPQogICAgICBzdHlsZS5PVHJhbnNmb3JtID0gJ3RyYW5zbGF0ZVgoJyArIGRpc3QgKyAncHgpJzsKCiAgICB9CgogICAgZnVuY3Rpb24gYW5pbWF0ZShmcm9tLCB0bywgc3BlZWQpIHsKCiAgICAgIC8vIGlmIG5vdCBhbiBhbmltYXRpb24sIGp1c3QgcmVwb3NpdGlvbgogICAgICBpZiAoIXNwZWVkKSB7CgogICAgICAgIGVsZW1lbnQuc3R5bGUubGVmdCA9IHRvICsgJ3B4JzsKICAgICAgICByZXR1cm47CgogICAgICB9CgogICAgICB2YXIgc3RhcnQgPSArbmV3IERhdGUoKTsKCiAgICAgIHZhciB0aW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgdGltZUVsYXAgPSArbmV3IERhdGUoKSAtIHN0YXJ0OwoKICAgICAgICBpZiAodGltZUVsYXAgPiBzcGVlZCkgewoKICAgICAgICAgIGVsZW1lbnQuc3R5bGUubGVmdCA9IHRvICsgJ3B4JzsKCiAgICAgICAgICBpZiAoZGVsYXkpIGJlZ2luKCk7CgogICAgICAgICAgb3B0aW9ucy50cmFuc2l0aW9uRW5kICYmIG9wdGlvbnMudHJhbnNpdGlvbkVuZC5jYWxsKGV2ZW50LCBpbmRleCwgc2xpZGVzW2luZGV4XSk7CgogICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7CiAgICAgICAgICByZXR1cm47CgogICAgICAgIH0KCiAgICAgICAgZWxlbWVudC5zdHlsZS5sZWZ0ID0gKCggKHRvIC0gZnJvbSkgKiAoTWF0aC5mbG9vcigodGltZUVsYXAgLyBzcGVlZCkgKiAxMDApIC8gMTAwKSApICsgZnJvbSkgKyAncHgnOwoKICAgICAgfSwgNCk7CgogICAgfQoKICAgIC8vIHNldHVwIGF1dG8gc2xpZGVzaG93CiAgICB2YXIgZGVsYXkgPSBvcHRpb25zLmF1dG8gfHwgMDsKICAgIHZhciBpbnRlcnZhbDsKCiAgICBmdW5jdGlvbiBiZWdpbigpIHsKCiAgICAgIGludGVydmFsID0gc2V0VGltZW91dChuZXh0LCBkZWxheSk7CgogICAgfQoKICAgIGZ1bmN0aW9uIHN0b3AoKSB7CgogICAgICBkZWxheSA9IG9wdGlvbnMuYXV0byB8fCAwOwogICAgICBjbGVhclRpbWVvdXQoaW50ZXJ2YWwpOwoKICAgIH0KCgogICAgLy8gc2V0dXAgaW5pdGlhbCB2YXJzCiAgICB2YXIgc3RhcnQgPSB7fTsKICAgIHZhciBkZWx0YSA9IHt9OwogICAgdmFyIGlzU2Nyb2xsaW5nOwoKICAgIC8vIHNldHVwIGV2ZW50IGNhcHR1cmluZwogICAgdmFyIGV2ZW50cyA9IHsKCiAgICAgIGhhbmRsZUV2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICAgIGlmKGV2ZW50LnR5cGUgPT0gJ21vdXNlZG93bicgfHwgZXZlbnQudHlwZSA9PSAnbW91c2V1cCcgfHwgZXZlbnQudHlwZSA9PSAnbW91c2Vtb3ZlJykgewogICAgICAgICAgZXZlbnQudG91Y2hlcyA9IFt7CiAgICAgICAgICAgIHBhZ2VYOiBldmVudC5wYWdlWCwKICAgICAgICAgICAgcGFnZVk6IGV2ZW50LnBhZ2VZCiAgICAgICAgICB9XTsKICAgICAgICB9CgogICAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkgewogICAgICAgICAgY2FzZSAnbW91c2Vkb3duJzogdGhpcy5zdGFydChldmVudCk7IGJyZWFrOwogICAgICAgICAgY2FzZSAndG91Y2hzdGFydCc6IHRoaXMuc3RhcnQoZXZlbnQpOyBicmVhazsKICAgICAgICAgIGNhc2UgJ3RvdWNobW92ZSc6IHRoaXMudG91Y2htb3ZlKGV2ZW50KTsgYnJlYWs7CiAgICAgICAgICBjYXNlICdtb3VzZW1vdmUnOiB0aGlzLnRvdWNobW92ZShldmVudCk7IGJyZWFrOwogICAgICAgICAgY2FzZSAndG91Y2hlbmQnOiBvZmZsb2FkRm4odGhpcy5lbmQoZXZlbnQpKTsgYnJlYWs7CiAgICAgICAgICBjYXNlICdtb3VzZXVwJzogb2ZmbG9hZEZuKHRoaXMuZW5kKGV2ZW50KSk7IGJyZWFrOwogICAgICAgICAgY2FzZSAnd2Via2l0VHJhbnNpdGlvbkVuZCc6CiAgICAgICAgICBjYXNlICdtc1RyYW5zaXRpb25FbmQnOgogICAgICAgICAgY2FzZSAnb1RyYW5zaXRpb25FbmQnOgogICAgICAgICAgY2FzZSAnb3RyYW5zaXRpb25lbmQnOgogICAgICAgICAgY2FzZSAndHJhbnNpdGlvbmVuZCc6IG9mZmxvYWRGbih0aGlzLnRyYW5zaXRpb25FbmQoZXZlbnQpKTsgYnJlYWs7CiAgICAgICAgICBjYXNlICdyZXNpemUnOiBvZmZsb2FkRm4oc2V0dXApOyBicmVhazsKICAgICAgICB9CgogICAgICAgIGlmIChvcHRpb25zLnN0b3BQcm9wYWdhdGlvbikgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICB9LAogICAgICBzdGFydDogZnVuY3Rpb24oZXZlbnQpIHsKCiAgICAgICAgdmFyIHRvdWNoZXMgPSBldmVudC50b3VjaGVzWzBdOwoKICAgICAgICAvLyBtZWFzdXJlIHN0YXJ0IHZhbHVlcwogICAgICAgIHN0YXJ0ID0gewoKICAgICAgICAgIC8vIGdldCBpbml0aWFsIHRvdWNoIGNvb3JkcwogICAgICAgICAgeDogdG91Y2hlcy5wYWdlWCwKICAgICAgICAgIHk6IHRvdWNoZXMucGFnZVksCgogICAgICAgICAgLy8gc3RvcmUgdGltZSB0byBkZXRlcm1pbmUgdG91Y2ggZHVyYXRpb24KICAgICAgICAgIHRpbWU6ICtuZXcgRGF0ZSgpCgogICAgICAgIH07CgogICAgICAgIC8vIHVzZWQgZm9yIHRlc3RpbmcgZmlyc3QgbW92ZSBldmVudAogICAgICAgIGlzU2Nyb2xsaW5nID0gdW5kZWZpbmVkOwoKICAgICAgICAvLyByZXNldCBkZWx0YSBhbmQgZW5kIG1lYXN1cmVtZW50cwogICAgICAgIGRlbHRhID0ge307CgogICAgICAgIC8vIGF0dGFjaCB0b3VjaG1vdmUgYW5kIHRvdWNoZW5kIGxpc3RlbmVycwogICAgICAgIGlmKGJyb3dzZXIudG91Y2gpIHsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcywgZmFsc2UpOwogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcywgZmFsc2UpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdG91Y2htb3ZlOiBmdW5jdGlvbihldmVudCkgewoKICAgICAgICAvLyBlbnN1cmUgc3dpcGluZyB3aXRoIG9uZSB0b3VjaCBhbmQgbm90IHBpbmNoaW5nCiAgICAgICAgLy8gZW5zdXJlIHNsaWRpbmcgaXMgZW5hYmxlZAogICAgICAgIGlmIChldmVudC50b3VjaGVzLmxlbmd0aCA+IDEgfHwKICAgICAgICAgICAgZXZlbnQuc2NhbGUgJiYgZXZlbnQuc2NhbGUgIT09IDEgfHwKICAgICAgICAgICAgc2xpZGVyLnNsaWRlSXNEaXNhYmxlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnMuZGlzYWJsZVNjcm9sbCkgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgdmFyIHRvdWNoZXMgPSBldmVudC50b3VjaGVzWzBdOwoKICAgICAgICAvLyBtZWFzdXJlIGNoYW5nZSBpbiB4IGFuZCB5CiAgICAgICAgZGVsdGEgPSB7CiAgICAgICAgICB4OiB0b3VjaGVzLnBhZ2VYIC0gc3RhcnQueCwKICAgICAgICAgIHk6IHRvdWNoZXMucGFnZVkgLSBzdGFydC55CiAgICAgICAgfTsKCiAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHNjcm9sbGluZyB0ZXN0IGhhcyBydW4gLSBvbmUgdGltZSB0ZXN0CiAgICAgICAgaWYgKCB0eXBlb2YgaXNTY3JvbGxpbmcgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIGlzU2Nyb2xsaW5nID0gISEoIGlzU2Nyb2xsaW5nIHx8IE1hdGguYWJzKGRlbHRhLngpIDwgTWF0aC5hYnMoZGVsdGEueSkgKTsKICAgICAgICB9CgogICAgICAgIC8vIGlmIHVzZXIgaXMgbm90IHRyeWluZyB0byBzY3JvbGwgdmVydGljYWxseQogICAgICAgIGlmICghaXNTY3JvbGxpbmcpIHsKCiAgICAgICAgICAvLyBwcmV2ZW50IG5hdGl2ZSBzY3JvbGxpbmcKICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgLy8gc3RvcCBzbGlkZXNob3cKICAgICAgICAgIHN0b3AoKTsKCiAgICAgICAgICAvLyBpbmNyZWFzZSByZXNpc3RhbmNlIGlmIGZpcnN0IG9yIGxhc3Qgc2xpZGUKICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHsgLy8gd2UgZG9uJ3QgYWRkIHJlc2lzdGFuY2UgYXQgdGhlIGVuZAoKICAgICAgICAgICAgdHJhbnNsYXRlKGNpcmNsZShpbmRleC0xKSwgZGVsdGEueCArIHNsaWRlUG9zW2NpcmNsZShpbmRleC0xKV0sIDApOwogICAgICAgICAgICB0cmFuc2xhdGUoaW5kZXgsIGRlbHRhLnggKyBzbGlkZVBvc1tpbmRleF0sIDApOwogICAgICAgICAgICB0cmFuc2xhdGUoY2lyY2xlKGluZGV4KzEpLCBkZWx0YS54ICsgc2xpZGVQb3NbY2lyY2xlKGluZGV4KzEpXSwgMCk7CgogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGRlbHRhLnggPQogICAgICAgICAgICAgIGRlbHRhLnggLwogICAgICAgICAgICAgICAgKCAoIWluZGV4ICYmIGRlbHRhLnggPiAwIHx8ICAgICAgICAgLy8gaWYgZmlyc3Qgc2xpZGUgYW5kIHNsaWRpbmcgbGVmdAogICAgICAgICAgICAgICAgICBpbmRleCA9PSBzbGlkZXMubGVuZ3RoIC0gMSAmJiAgICAgLy8gb3IgaWYgbGFzdCBzbGlkZSBhbmQgc2xpZGluZyByaWdodAogICAgICAgICAgICAgICAgICBkZWx0YS54IDwgMCAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGlmIHNsaWRpbmcgYXQgYWxsCiAgICAgICAgICAgICAgICApID8KICAgICAgICAgICAgICAgICggTWF0aC5hYnMoZGVsdGEueCkgLyB3aWR0aCArIDEgKSAgICAgIC8vIGRldGVybWluZSByZXNpc3RhbmNlIGxldmVsCiAgICAgICAgICAgICAgICA6IDEgKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBubyByZXNpc3RhbmNlIGlmIGZhbHNlCgogICAgICAgICAgICAvLyB0cmFuc2xhdGUgMToxCiAgICAgICAgICAgIHRyYW5zbGF0ZShpbmRleC0xLCBkZWx0YS54ICsgc2xpZGVQb3NbaW5kZXgtMV0sIDApOwogICAgICAgICAgICB0cmFuc2xhdGUoaW5kZXgsIGRlbHRhLnggKyBzbGlkZVBvc1tpbmRleF0sIDApOwogICAgICAgICAgICB0cmFuc2xhdGUoaW5kZXgrMSwgZGVsdGEueCArIHNsaWRlUG9zW2luZGV4KzFdLCAwKTsKICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgfSwKICAgICAgZW5kOiBmdW5jdGlvbihldmVudCkgewoKICAgICAgICAvLyBtZWFzdXJlIGR1cmF0aW9uCiAgICAgICAgdmFyIGR1cmF0aW9uID0gK25ldyBEYXRlKCkgLSBzdGFydC50aW1lOwoKICAgICAgICAvLyBkZXRlcm1pbmUgaWYgc2xpZGUgYXR0ZW1wdCB0cmlnZ2VycyBuZXh0L3ByZXYgc2xpZGUKICAgICAgICB2YXIgaXNWYWxpZFNsaWRlID0KICAgICAgICAgICAgICBOdW1iZXIoZHVyYXRpb24pIDwgMjUwICYmICAgICAgICAgLy8gaWYgc2xpZGUgZHVyYXRpb24gaXMgbGVzcyB0aGFuIDI1MG1zCiAgICAgICAgICAgICAgTWF0aC5hYnMoZGVsdGEueCkgPiAyMCB8fCAgICAgICAgIC8vIGFuZCBpZiBzbGlkZSBhbXQgaXMgZ3JlYXRlciB0aGFuIDIwcHgKICAgICAgICAgICAgICBNYXRoLmFicyhkZWx0YS54KSA+IHdpZHRoLzI7ICAgICAgLy8gb3IgaWYgc2xpZGUgYW10IGlzIGdyZWF0ZXIgdGhhbiBoYWxmIHRoZSB3aWR0aAoKICAgICAgICAvLyBkZXRlcm1pbmUgaWYgc2xpZGUgYXR0ZW1wdCBpcyBwYXN0IHN0YXJ0IGFuZCBlbmQKICAgICAgICB2YXIgaXNQYXN0Qm91bmRzID0gKCFpbmRleCAmJiBkZWx0YS54ID4gMCkgfHwgICAgICAvLyBpZiBmaXJzdCBzbGlkZSBhbmQgc2xpZGUgYW10IGlzIGdyZWF0ZXIgdGhhbiAwCiAgICAgICAgICAgICAgKGluZGV4ID09IHNsaWRlcy5sZW5ndGggLSAxICYmIGRlbHRhLnggPCAwKTsgLy8gb3IgaWYgbGFzdCBzbGlkZSBhbmQgc2xpZGUgYW10IGlzIGxlc3MgdGhhbiAwCgogICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIGlzUGFzdEJvdW5kcyA9IGZhbHNlOwoKICAgICAgICAvLyBkZXRlcm1pbmUgZGlyZWN0aW9uIG9mIHN3aXBlICh0cnVlOnJpZ2h0LCBmYWxzZTpsZWZ0KQogICAgICAgIHZhciBkaXJlY3Rpb24gPSBkZWx0YS54IDwgMDsKCiAgICAgICAgLy8gaWYgbm90IHNjcm9sbGluZyB2ZXJ0aWNhbGx5CiAgICAgICAgaWYgKCFpc1Njcm9sbGluZykgewoKICAgICAgICAgIGlmIChpc1ZhbGlkU2xpZGUgJiYgIWlzUGFzdEJvdW5kcykgewoKICAgICAgICAgICAgaWYgKGRpcmVjdGlvbikgewoKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSB7IC8vIHdlIG5lZWQgdG8gZ2V0IHRoZSBuZXh0IGluIHRoaXMgZGlyZWN0aW9uIGluIHBsYWNlCgogICAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgtMSksIC13aWR0aCwgMCk7CiAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleCsyKSwgd2lkdGgsIDApOwoKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbW92ZShpbmRleC0xLCAtd2lkdGgsIDApOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbW92ZShpbmRleCwgc2xpZGVQb3NbaW5kZXhdLXdpZHRoLCBzcGVlZCk7CiAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgrMSksIHNsaWRlUG9zW2NpcmNsZShpbmRleCsxKV0td2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgICBpbmRleCA9IGNpcmNsZShpbmRleCsxKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgeyAvLyB3ZSBuZWVkIHRvIGdldCB0aGUgbmV4dCBpbiB0aGlzIGRpcmVjdGlvbiBpbiBwbGFjZQoKICAgICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzEpLCB3aWR0aCwgMCk7CiAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleC0yKSwgLXdpZHRoLCAwKTsKCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgrMSwgd2lkdGgsIDApOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbW92ZShpbmRleCwgc2xpZGVQb3NbaW5kZXhdK3dpZHRoLCBzcGVlZCk7CiAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgtMSksIHNsaWRlUG9zW2NpcmNsZShpbmRleC0xKV0rd2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgICBpbmRleCA9IGNpcmNsZShpbmRleC0xKTsKCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wdGlvbnMuY2FsbGJhY2sgJiYgb3B0aW9ucy5jYWxsYmFjayhpbmRleCwgc2xpZGVzW2luZGV4XSk7CgogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHsKCiAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgtMSksIC13aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgIG1vdmUoaW5kZXgsIDAsIHNwZWVkKTsKICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleCsxKSwgd2lkdGgsIHNwZWVkKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgIG1vdmUoaW5kZXgtMSwgLXdpZHRoLCBzcGVlZCk7CiAgICAgICAgICAgICAgbW92ZShpbmRleCwgMCwgc3BlZWQpOwogICAgICAgICAgICAgIG1vdmUoaW5kZXgrMSwgd2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICAvLyBraWxsIHRvdWNobW92ZSBhbmQgdG91Y2hlbmQgZXZlbnQgbGlzdGVuZXJzIHVudGlsIHRvdWNoc3RhcnQgY2FsbGVkIGFnYWluCiAgICAgICAgaWYoYnJvd3Nlci50b3VjaCkgewogICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgIH0KCiAgICAgIH0sCiAgICAgIHRyYW5zaXRpb25FbmQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgogICAgICAgIGlmIChwYXJzZUludChldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLWluZGV4JyksIDEwKSA9PSBpbmRleCkgewoKICAgICAgICAgIGlmIChkZWxheSkgYmVnaW4oKTsKCiAgICAgICAgICBvcHRpb25zLnRyYW5zaXRpb25FbmQgJiYgb3B0aW9ucy50cmFuc2l0aW9uRW5kLmNhbGwoZXZlbnQsIGluZGV4LCBzbGlkZXNbaW5kZXhdKTsKCiAgICAgICAgfQoKICAgICAgfQoKICAgIH07CgogICAgLy8gUHVibGljIEFQSQogICAgdGhpcy51cGRhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgc2V0VGltZW91dChzZXR1cCk7CiAgICB9OwogICAgdGhpcy5zZXR1cCA9IGZ1bmN0aW9uKCkgewogICAgICBzZXR1cCgpOwogICAgfTsKCiAgICB0aGlzLmVuYWJsZVNsaWRlID0gZnVuY3Rpb24oc2hvdWxkRW5hYmxlKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5zbGlkZUlzRGlzYWJsZWQgPSAhc2hvdWxkRW5hYmxlOwogICAgICB9CiAgICAgIHJldHVybiAhdGhpcy5zbGlkZUlzRGlzYWJsZWQ7CiAgICB9LAogICAgdGhpcy5zbGlkZSA9IGZ1bmN0aW9uKHRvLCBzcGVlZCkgewogICAgICAvLyBjYW5jZWwgc2xpZGVzaG93CiAgICAgIHN0b3AoKTsKCiAgICAgIHNsaWRlKHRvLCBzcGVlZCk7CiAgICB9OwoKICAgIHRoaXMucHJldiA9IHRoaXMucHJldmlvdXMgPSBmdW5jdGlvbigpIHsKICAgICAgLy8gY2FuY2VsIHNsaWRlc2hvdwogICAgICBzdG9wKCk7CgogICAgICBwcmV2KCk7CiAgICB9OwoKICAgIHRoaXMubmV4dCA9IGZ1bmN0aW9uKCkgewogICAgICAvLyBjYW5jZWwgc2xpZGVzaG93CiAgICAgIHN0b3AoKTsKCiAgICAgIG5leHQoKTsKICAgIH07CgogICAgdGhpcy5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIGNhbmNlbCBzbGlkZXNob3cKICAgICAgc3RvcCgpOwogICAgfTsKCiAgICB0aGlzLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIGJlZ2luKCk7CiAgICB9OwoKICAgIHRoaXMuY3VycmVudEluZGV4ID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIHJldHVybiBjdXJyZW50IGluZGV4IHBvc2l0aW9uCiAgICAgIHJldHVybiBpbmRleDsKICAgIH07CgogICAgdGhpcy5zbGlkZXNDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAvLyByZXR1cm4gdG90YWwgbnVtYmVyIG9mIHNsaWRlcwogICAgICByZXR1cm4gbGVuZ3RoOwogICAgfTsKCiAgICB0aGlzLmtpbGwgPSBmdW5jdGlvbigpIHsKICAgICAgLy8gY2FuY2VsIHNsaWRlc2hvdwogICAgICBzdG9wKCk7CgogICAgICAvLyByZXNldCBlbGVtZW50CiAgICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSAnJzsKICAgICAgZWxlbWVudC5zdHlsZS5sZWZ0ID0gJyc7CgogICAgICAvLyByZXNldCBzbGlkZXMKICAgICAgdmFyIHBvcyA9IHNsaWRlcy5sZW5ndGg7CiAgICAgIHdoaWxlKHBvcy0tKSB7CgogICAgICAgIHZhciBzbGlkZSA9IHNsaWRlc1twb3NdOwogICAgICAgIHNsaWRlLnN0eWxlLndpZHRoID0gJyc7CiAgICAgICAgc2xpZGUuc3R5bGUubGVmdCA9ICcnOwoKICAgICAgICBpZiAoYnJvd3Nlci50cmFuc2l0aW9ucykgdHJhbnNsYXRlKHBvcywgMCwgMCk7CgogICAgICB9CgogICAgICAvLyByZW1vdmVkIGV2ZW50IGxpc3RlbmVycwogICAgICBpZiAoYnJvd3Nlci5hZGRFdmVudExpc3RlbmVyKSB7CgogICAgICAgIC8vIHJlbW92ZSBjdXJyZW50IGV2ZW50IGxpc3RlbmVycwogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2Via2l0VHJhbnNpdGlvbkVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbXNUcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdvVHJhbnNpdGlvbkVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignb3RyYW5zaXRpb25lbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgZXZlbnRzLCBmYWxzZSk7CgogICAgICB9CiAgICAgIGVsc2UgewoKICAgICAgICB3aW5kb3cub25yZXNpemUgPSBudWxsOwoKICAgICAgfQogICAgfTsKCiAgICB0aGlzLmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgLy8gdHJpZ2dlciBzZXR1cAogICAgICBzZXR1cCgpOwoKICAgICAgLy8gc3RhcnQgYXV0byBzbGlkZXNob3cgaWYgYXBwbGljYWJsZQogICAgICBpZiAoZGVsYXkpIGJlZ2luKCk7CgoKICAgICAgLy8gYWRkIGV2ZW50IGxpc3RlbmVycwogICAgICBpZiAoYnJvd3Nlci5hZGRFdmVudExpc3RlbmVyKSB7CgogICAgICAgIC8vIHNldCB0b3VjaHN0YXJ0IGV2ZW50IG9uIGVsZW1lbnQKICAgICAgICBpZiAoYnJvd3Nlci50b3VjaCkgewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYnJvd3Nlci50cmFuc2l0aW9ucykgewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21zVHJhbnNpdGlvbkVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdvVHJhbnNpdGlvbkVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdvdHJhbnNpdGlvbmVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBzZXQgcmVzaXplIGV2ZW50IG9uIHdpbmRvdwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBldmVudHMsIGZhbHNlKTsKCiAgICAgIH0gZWxzZSB7CgogICAgICAgIHdpbmRvdy5vbnJlc2l6ZSA9IGZ1bmN0aW9uICgpIHsgc2V0dXAoKTsgfTsgLy8gdG8gcGxheSBuaWNlIHdpdGggb2xkIElFCgogICAgICB9CiAgICB9OwoKICB9Cn0pOwoKfSkoaW9uaWMpOwoKKGZ1bmN0aW9uKGlvbmljKSB7Cid1c2Ugc3RyaWN0JzsKCiAgaW9uaWMudmlld3MuVG9nZ2xlID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgdGhpcy5lbCA9IG9wdHMuZWw7CiAgICAgIHRoaXMuY2hlY2tib3ggPSBvcHRzLmNoZWNrYm94OwogICAgICB0aGlzLnRyYWNrID0gb3B0cy50cmFjazsKICAgICAgdGhpcy5oYW5kbGUgPSBvcHRzLmhhbmRsZTsKICAgICAgdGhpcy5vcGVuUGVyY2VudCA9IC0xOwogICAgICB0aGlzLm9uQ2hhbmdlID0gb3B0cy5vbkNoYW5nZSB8fCBmdW5jdGlvbigpIHt9OwoKICAgICAgdGhpcy50cmlnZ2VyVGhyZXNob2xkID0gb3B0cy50cmlnZ2VyVGhyZXNob2xkIHx8IDIwOwoKICAgICAgdGhpcy5kcmFnU3RhcnRIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgIHNlbGYuZHJhZ1N0YXJ0KGUpOwogICAgICB9OwogICAgICB0aGlzLmRyYWdIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgIHNlbGYuZHJhZyhlKTsKICAgICAgfTsKICAgICAgdGhpcy5ob2xkSGFuZGxlciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBzZWxmLmhvbGQoZSk7CiAgICAgIH07CiAgICAgIHRoaXMucmVsZWFzZUhhbmRsZXIgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgc2VsZi5yZWxlYXNlKGUpOwogICAgICB9OwoKICAgICAgdGhpcy5kcmFnU3RhcnRHZXN0dXJlID0gaW9uaWMub25HZXN0dXJlKCdkcmFnc3RhcnQnLCB0aGlzLmRyYWdTdGFydEhhbmRsZXIsIHRoaXMuZWwpOwogICAgICB0aGlzLmRyYWdHZXN0dXJlID0gaW9uaWMub25HZXN0dXJlKCdkcmFnJywgdGhpcy5kcmFnSGFuZGxlciwgdGhpcy5lbCk7CiAgICAgIHRoaXMuZHJhZ0hvbGRHZXN0dXJlID0gaW9uaWMub25HZXN0dXJlKCdob2xkJywgdGhpcy5ob2xkSGFuZGxlciwgdGhpcy5lbCk7CiAgICAgIHRoaXMuZHJhZ1JlbGVhc2VHZXN0dXJlID0gaW9uaWMub25HZXN0dXJlKCdyZWxlYXNlJywgdGhpcy5yZWxlYXNlSGFuZGxlciwgdGhpcy5lbCk7CiAgICB9LAoKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICBpb25pYy5vZmZHZXN0dXJlKHRoaXMuZHJhZ1N0YXJ0R2VzdHVyZSwgJ2RyYWdzdGFydCcsIHRoaXMuZHJhZ1N0YXJ0R2VzdHVyZSk7CiAgICAgIGlvbmljLm9mZkdlc3R1cmUodGhpcy5kcmFnR2VzdHVyZSwgJ2RyYWcnLCB0aGlzLmRyYWdHZXN0dXJlKTsKICAgICAgaW9uaWMub2ZmR2VzdHVyZSh0aGlzLmRyYWdIb2xkR2VzdHVyZSwgJ2hvbGQnLCB0aGlzLmhvbGRIYW5kbGVyKTsKICAgICAgaW9uaWMub2ZmR2VzdHVyZSh0aGlzLmRyYWdSZWxlYXNlR2VzdHVyZSwgJ3JlbGVhc2UnLCB0aGlzLnJlbGVhc2VIYW5kbGVyKTsKICAgIH0sCgogICAgdGFwOiBmdW5jdGlvbihlKSB7CiAgICAgIGlmKHRoaXMuZWwuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpICE9PSAnZGlzYWJsZWQnKSB7CiAgICAgICAgdGhpcy52YWwoICF0aGlzLmNoZWNrYm94LmNoZWNrZWQgKTsKICAgICAgfQogICAgfSwKCiAgICBkcmFnU3RhcnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYodGhpcy5jaGVja2JveC5kaXNhYmxlZCkgcmV0dXJuOwoKICAgICAgdGhpcy5fZHJhZ0luZm8gPSB7CiAgICAgICAgd2lkdGg6IHRoaXMuZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgbGVmdDogdGhpcy5lbC5vZmZzZXRMZWZ0LAogICAgICAgIHJpZ2h0OiB0aGlzLmVsLm9mZnNldExlZnQgKyB0aGlzLmVsLm9mZnNldFdpZHRoLAogICAgICAgIHRyaWdnZXJYOiB0aGlzLmVsLm9mZnNldFdpZHRoIC8gMiwKICAgICAgICBpbml0aWFsU3RhdGU6IHRoaXMuY2hlY2tib3guY2hlY2tlZAogICAgICB9OwoKICAgICAgLy8gU3RvcCBhbnkgcGFyZW50IGRyYWdnaW5nCiAgICAgIGUuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgLy8gVHJpZ2dlciBob2xkIHN0eWxlcwogICAgICB0aGlzLmhvbGQoZSk7CiAgICB9LAoKICAgIGRyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZighdGhpcy5fZHJhZ0luZm8pIHsgcmV0dXJuOyB9CgogICAgICAvLyBTdG9wIGFueSBwYXJlbnQgZHJhZ2dpbmcKICAgICAgZS5nZXN0dXJlLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oYW1vdW50KSB7CiAgICAgICAgaWYgKCFzZWxmLl9kcmFnSW5mbykgeyByZXR1cm47IH0KCiAgICAgICAgdmFyIHNsaWRlUGFnZUxlZnQgPSBzZWxmLnRyYWNrLm9mZnNldExlZnQgKyAoc2VsZi5oYW5kbGUub2Zmc2V0V2lkdGggLyAyKTsKICAgICAgICB2YXIgc2xpZGVQYWdlUmlnaHQgPSBzZWxmLnRyYWNrLm9mZnNldExlZnQgKyBzZWxmLnRyYWNrLm9mZnNldFdpZHRoIC0gKHNlbGYuaGFuZGxlLm9mZnNldFdpZHRoIC8gMik7CiAgICAgICAgdmFyIGR4ID0gZS5nZXN0dXJlLmRlbHRhWDsKCiAgICAgICAgdmFyIHB4ID0gZS5nZXN0dXJlLnRvdWNoZXNbMF0ucGFnZVggLSBzZWxmLl9kcmFnSW5mby5sZWZ0OwogICAgICAgIHZhciBteCA9IHNlbGYuX2RyYWdJbmZvLndpZHRoIC0gc2VsZi50cmlnZ2VyVGhyZXNob2xkOwoKICAgICAgICAvLyBUaGUgaW5pdGlhbCBzdGF0ZSB3YXMgb24sIHNvICJ0ZW5kIHRvd2FyZHMiIG9uCiAgICAgICAgaWYoc2VsZi5fZHJhZ0luZm8uaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICBpZihweCA8IHNlbGYudHJpZ2dlclRocmVzaG9sZCkgewogICAgICAgICAgICBzZWxmLnNldE9wZW5QZXJjZW50KDApOwogICAgICAgICAgfSBlbHNlIGlmKHB4ID4gc2VsZi5fZHJhZ0luZm8udHJpZ2dlclgpIHsKICAgICAgICAgICAgc2VsZi5zZXRPcGVuUGVyY2VudCgxMDApOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBUaGUgaW5pdGlhbCBzdGF0ZSB3YXMgb2ZmLCBzbyAidGVuZCB0b3dhcmRzIiBvZmYKICAgICAgICAgIGlmKHB4IDwgc2VsZi5fZHJhZ0luZm8udHJpZ2dlclgpIHsKICAgICAgICAgICAgc2VsZi5zZXRPcGVuUGVyY2VudCgwKTsKICAgICAgICAgIH0gZWxzZSBpZihweCA+IG14KSB7CiAgICAgICAgICAgIHNlbGYuc2V0T3BlblBlcmNlbnQoMTAwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBlbmREcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgIHRoaXMuX2RyYWdJbmZvID0gbnVsbDsKICAgIH0sCgogICAgaG9sZDogZnVuY3Rpb24oZSkgewogICAgICB0aGlzLmVsLmNsYXNzTGlzdC5hZGQoJ2RyYWdnaW5nJyk7CiAgICB9LAogICAgcmVsZWFzZTogZnVuY3Rpb24oZSkgewogICAgICB0aGlzLmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWdnaW5nJyk7CiAgICAgIHRoaXMuZW5kRHJhZyhlKTsKICAgIH0sCgoKICAgIHNldE9wZW5QZXJjZW50OiBmdW5jdGlvbihvcGVuUGVyY2VudCkgewogICAgICAvLyBvbmx5IG1ha2UgYSBjaGFuZ2UgaWYgdGhlIG5ldyBvcGVuIHBlcmNlbnQgaGFzIGNoYW5nZWQKICAgICAgaWYodGhpcy5vcGVuUGVyY2VudCA8IDAgfHwgKG9wZW5QZXJjZW50IDwgKHRoaXMub3BlblBlcmNlbnQgLSAzKSB8fCBvcGVuUGVyY2VudCA+ICh0aGlzLm9wZW5QZXJjZW50ICsgMykgKSApIHsKICAgICAgICB0aGlzLm9wZW5QZXJjZW50ID0gb3BlblBlcmNlbnQ7CgogICAgICAgIGlmKG9wZW5QZXJjZW50ID09PSAwKSB7CiAgICAgICAgICB0aGlzLnZhbChmYWxzZSk7CiAgICAgICAgfSBlbHNlIGlmKG9wZW5QZXJjZW50ID09PSAxMDApIHsKICAgICAgICAgIHRoaXMudmFsKHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgb3BlblBpeGVsID0gTWF0aC5yb3VuZCggKG9wZW5QZXJjZW50IC8gMTAwKSAqIHRoaXMudHJhY2sub2Zmc2V0V2lkdGggLSAodGhpcy5oYW5kbGUub2Zmc2V0V2lkdGgpICk7CiAgICAgICAgICBvcGVuUGl4ZWwgPSAob3BlblBpeGVsIDwgMSA/IDAgOiBvcGVuUGl4ZWwpOwogICAgICAgICAgdGhpcy5oYW5kbGUuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoJyArIG9wZW5QaXhlbCArICdweCwwLDApJzsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgdmFsOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZih2YWx1ZSA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICBpZih0aGlzLmhhbmRsZS5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSAhPT0gIiIpIHsKICAgICAgICAgIHRoaXMuaGFuZGxlLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gIiI7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hlY2tib3guY2hlY2tlZCA9IHZhbHVlOwogICAgICAgIHRoaXMub3BlblBlcmNlbnQgPSAodmFsdWUgPyAxMDAgOiAwKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlICYmIHRoaXMub25DaGFuZ2UoKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5jaGVja2JveC5jaGVja2VkOwogICAgfQoKICB9KTsKCn0pKGlvbmljKTsKCn0pKCk7Ci8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKioKICogQGxpY2Vuc2UgQW5ndWxhckpTIHYxLjIuMTcKICogKGMpIDIwMTAtMjAxNCBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7J3VzZSBzdHJpY3QnOwoKLyoqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGlzIG9iamVjdCBwcm92aWRlcyBhIHV0aWxpdHkgZm9yIHByb2R1Y2luZyByaWNoIEVycm9yIG1lc3NhZ2VzIHdpdGhpbgogKiBBbmd1bGFyLiBJdCBjYW4gYmUgY2FsbGVkIGFzIGZvbGxvd3M6CiAqCiAqIHZhciBleGFtcGxlTWluRXJyID0gbWluRXJyKCdleGFtcGxlJyk7CiAqIHRocm93IGV4YW1wbGVNaW5FcnIoJ29uZScsICdUaGlzIHswfSBpcyB7MX0nLCBmb28sIGJhcik7CiAqCiAqIFRoZSBhYm92ZSBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIG1pbkVyciBpbiB0aGUgZXhhbXBsZSBuYW1lc3BhY2UuIFRoZQogKiByZXN1bHRpbmcgZXJyb3Igd2lsbCBoYXZlIGEgbmFtZXNwYWNlZCBlcnJvciBjb2RlIG9mIGV4YW1wbGUub25lLiAgVGhlCiAqIHJlc3VsdGluZyBlcnJvciB3aWxsIHJlcGxhY2UgezB9IHdpdGggdGhlIHZhbHVlIG9mIGZvbywgYW5kIHsxfSB3aXRoIHRoZQogKiB2YWx1ZSBvZiBiYXIuIFRoZSBvYmplY3QgaXMgbm90IHJlc3RyaWN0ZWQgaW4gdGhlIG51bWJlciBvZiBhcmd1bWVudHMgaXQgY2FuCiAqIHRha2UuCiAqCiAqIElmIGZld2VyIGFyZ3VtZW50cyBhcmUgc3BlY2lmaWVkIHRoYW4gbmVjZXNzYXJ5IGZvciBpbnRlcnBvbGF0aW9uLCB0aGUgZXh0cmEKICogaW50ZXJwb2xhdGlvbiBtYXJrZXJzIHdpbGwgYmUgcHJlc2VydmVkIGluIHRoZSBmaW5hbCBzdHJpbmcuCiAqCiAqIFNpbmNlIGRhdGEgd2lsbCBiZSBwYXJzZWQgc3RhdGljYWxseSBkdXJpbmcgYSBidWlsZCBzdGVwLCBzb21lIHJlc3RyaWN0aW9ucwogKiBhcmUgYXBwbGllZCB3aXRoIHJlc3BlY3QgdG8gaG93IG1pbkVyciBpbnN0YW5jZXMgYXJlIGNyZWF0ZWQgYW5kIGNhbGxlZC4KICogSW5zdGFuY2VzIHNob3VsZCBoYXZlIG5hbWVzIG9mIHRoZSBmb3JtIG5hbWVzcGFjZU1pbkVyciBmb3IgYSBtaW5FcnIgY3JlYXRlZAogKiB1c2luZyBtaW5FcnIoJ25hbWVzcGFjZScpIC4gRXJyb3IgY29kZXMsIG5hbWVzcGFjZXMgYW5kIHRlbXBsYXRlIHN0cmluZ3MKICogc2hvdWxkIGFsbCBiZSBzdGF0aWMgc3RyaW5ncywgbm90IHZhcmlhYmxlcyBvciBnZW5lcmFsIGV4cHJlc3Npb25zLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlIFRoZSBuYW1lc3BhY2UgdG8gdXNlIGZvciB0aGUgbmV3IG1pbkVyciBpbnN0YW5jZS4KICogQHJldHVybnMge2Z1bmN0aW9uKGNvZGU6c3RyaW5nLCB0ZW1wbGF0ZTpzdHJpbmcsIC4uLnRlbXBsYXRlQXJncyk6IEVycm9yfSBtaW5FcnIgaW5zdGFuY2UKICovCgpmdW5jdGlvbiBtaW5FcnIobW9kdWxlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb2RlID0gYXJndW1lbnRzWzBdLAogICAgICBwcmVmaXggPSAnWycgKyAobW9kdWxlID8gbW9kdWxlICsgJzonIDogJycpICsgY29kZSArICddICcsCiAgICAgIHRlbXBsYXRlID0gYXJndW1lbnRzWzFdLAogICAgICB0ZW1wbGF0ZUFyZ3MgPSBhcmd1bWVudHMsCiAgICAgIHN0cmluZ2lmeSA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuIG9iai50b1N0cmluZygpLnJlcGxhY2UoLyBce1tcc1xTXSokLywgJycpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmogIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgICAgfSwKICAgICAgbWVzc2FnZSwgaTsKCiAgICBtZXNzYWdlID0gcHJlZml4ICsgdGVtcGxhdGUucmVwbGFjZSgvXHtcZCtcfS9nLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgdmFyIGluZGV4ID0gK21hdGNoLnNsaWNlKDEsIC0xKSwgYXJnOwoKICAgICAgaWYgKGluZGV4ICsgMiA8IHRlbXBsYXRlQXJncy5sZW5ndGgpIHsKICAgICAgICBhcmcgPSB0ZW1wbGF0ZUFyZ3NbaW5kZXggKyAyXTsKICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuIGFyZy50b1N0cmluZygpLnJlcGxhY2UoLyA/XHtbXHNcU10qJC8sICcnKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gJ3VuZGVmaW5lZCc7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnICE9PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIHRvSnNvbihhcmcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnOwogICAgICB9CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwoKICAgIG1lc3NhZ2UgPSBtZXNzYWdlICsgJ1xuaHR0cDovL2Vycm9ycy5hbmd1bGFyanMub3JnLzEuMi4xNy8nICsKICAgICAgKG1vZHVsZSA/IG1vZHVsZSArICcvJyA6ICcnKSArIGNvZGU7CiAgICBmb3IgKGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlICsgKGkgPT0gMiA/ICc/JyA6ICcmJykgKyAncCcgKyAoaS0yKSArICc9JyArCiAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeShhcmd1bWVudHNbaV0pKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IEVycm9yKG1lc3NhZ2UpOwogIH07Cn0KCi8qIFdlIG5lZWQgdG8gdGVsbCBqc2hpbnQgd2hhdCB2YXJpYWJsZXMgYXJlIGJlaW5nIGV4cG9ydGVkICovCi8qIGdsb2JhbAogICAgLWFuZ3VsYXIsCiAgICAtbXNpZSwKICAgIC1qcUxpdGUsCiAgICAtalF1ZXJ5LAogICAgLXNsaWNlLAogICAgLXB1c2gsCiAgICAtdG9TdHJpbmcsCiAgICAtbmdNaW5FcnIsCiAgICAtYW5ndWxhck1vZHVsZSwKICAgIC1ub2RlTmFtZV8sCiAgICAtdWlkLAoKICAgIC1sb3dlcmNhc2UsCiAgICAtdXBwZXJjYXNlLAogICAgLW1hbnVhbExvd2VyY2FzZSwKICAgIC1tYW51YWxVcHBlcmNhc2UsCiAgICAtbm9kZU5hbWVfLAogICAgLWlzQXJyYXlMaWtlLAogICAgLWZvckVhY2gsCiAgICAtc29ydGVkS2V5cywKICAgIC1mb3JFYWNoU29ydGVkLAogICAgLXJldmVyc2VQYXJhbXMsCiAgICAtbmV4dFVpZCwKICAgIC1zZXRIYXNoS2V5LAogICAgLWV4dGVuZCwKICAgIC1pbnQsCiAgICAtaW5oZXJpdCwKICAgIC1ub29wLAogICAgLWlkZW50aXR5LAogICAgLXZhbHVlRm4sCiAgICAtaXNVbmRlZmluZWQsCiAgICAtaXNEZWZpbmVkLAogICAgLWlzT2JqZWN0LAogICAgLWlzU3RyaW5nLAogICAgLWlzTnVtYmVyLAogICAgLWlzRGF0ZSwKICAgIC1pc0FycmF5LAogICAgLWlzRnVuY3Rpb24sCiAgICAtaXNSZWdFeHAsCiAgICAtaXNXaW5kb3csCiAgICAtaXNTY29wZSwKICAgIC1pc0ZpbGUsCiAgICAtaXNCbG9iLAogICAgLWlzQm9vbGVhbiwKICAgIC10cmltLAogICAgLWlzRWxlbWVudCwKICAgIC1tYWtlTWFwLAogICAgLW1hcCwKICAgIC1zaXplLAogICAgLWluY2x1ZGVzLAogICAgLWluZGV4T2YsCiAgICAtYXJyYXlSZW1vdmUsCiAgICAtaXNMZWFmTm9kZSwKICAgIC1jb3B5LAogICAgLXNoYWxsb3dDb3B5LAogICAgLWVxdWFscywKICAgIC1jc3AsCiAgICAtY29uY2F0LAogICAgLXNsaWNlQXJncywKICAgIC1iaW5kLAogICAgLXRvSnNvblJlcGxhY2VyLAogICAgLXRvSnNvbiwKICAgIC1mcm9tSnNvbiwKICAgIC10b0Jvb2xlYW4sCiAgICAtc3RhcnRpbmdUYWcsCiAgICAtdHJ5RGVjb2RlVVJJQ29tcG9uZW50LAogICAgLXBhcnNlS2V5VmFsdWUsCiAgICAtdG9LZXlWYWx1ZSwKICAgIC1lbmNvZGVVcmlTZWdtZW50LAogICAgLWVuY29kZVVyaVF1ZXJ5LAogICAgLWFuZ3VsYXJJbml0LAogICAgLWJvb3RzdHJhcCwKICAgIC1zbmFrZV9jYXNlLAogICAgLWJpbmRKUXVlcnksCiAgICAtYXNzZXJ0QXJnLAogICAgLWFzc2VydEFyZ0ZuLAogICAgLWFzc2VydE5vdEhhc093blByb3BlcnR5LAogICAgLWdldHRlciwKICAgIC1nZXRCbG9ja0VsZW1lbnRzLAogICAgLWhhc093blByb3BlcnR5LAoKKi8KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEBuZ2RvYyBtb2R1bGUKICogQG5hbWUgbmcKICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICoKICogIyBuZyAoY29yZSBtb2R1bGUpCiAqIFRoZSBuZyBtb2R1bGUgaXMgbG9hZGVkIGJ5IGRlZmF1bHQgd2hlbiBhbiBBbmd1bGFySlMgYXBwbGljYXRpb24gaXMgc3RhcnRlZC4gVGhlIG1vZHVsZSBpdHNlbGYKICogY29udGFpbnMgdGhlIGVzc2VudGlhbCBjb21wb25lbnRzIGZvciBhbiBBbmd1bGFySlMgYXBwbGljYXRpb24gdG8gZnVuY3Rpb24uIFRoZSB0YWJsZSBiZWxvdwogKiBsaXN0cyBhIGhpZ2ggbGV2ZWwgYnJlYWtkb3duIG9mIGVhY2ggb2YgdGhlIHNlcnZpY2VzL2ZhY3RvcmllcywgZmlsdGVycywgZGlyZWN0aXZlcyBhbmQgdGVzdGluZwogKiBjb21wb25lbnRzIGF2YWlsYWJsZSB3aXRoaW4gdGhpcyBjb3JlIG1vZHVsZS4KICoKICogPGRpdiBkb2MtbW9kdWxlLWNvbXBvbmVudHM9Im5nIj48L2Rpdj4KICovCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIubG93ZXJjYXNlCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHRoZSBzcGVjaWZpZWQgc3RyaW5nIHRvIGxvd2VyY2FzZS4KICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIGxvd2VyY2FzZS4KICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAqLwp2YXIgbG93ZXJjYXNlID0gZnVuY3Rpb24oc3RyaW5nKXtyZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b0xvd2VyQ2FzZSgpIDogc3RyaW5nO307CnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIudXBwZXJjYXNlCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHRoZSBzcGVjaWZpZWQgc3RyaW5nIHRvIHVwcGVyY2FzZS4KICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIHVwcGVyY2FzZS4KICogQHJldHVybnMge3N0cmluZ30gVXBwZXJjYXNlZCBzdHJpbmcuCiAqLwp2YXIgdXBwZXJjYXNlID0gZnVuY3Rpb24oc3RyaW5nKXtyZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b1VwcGVyQ2FzZSgpIDogc3RyaW5nO307CgoKdmFyIG1hbnVhbExvd2VyY2FzZSA9IGZ1bmN0aW9uKHMpIHsKICAvKiBqc2hpbnQgYml0d2lzZTogZmFsc2UgKi8KICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKGNoKSB7cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSB8IDMyKTt9KQogICAgICA6IHM7Cn07CnZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbihzKSB7CiAgLyoganNoaW50IGJpdHdpc2U6IGZhbHNlICovCiAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgID8gcy5yZXBsYWNlKC9bYS16XS9nLCBmdW5jdGlvbihjaCkge3JldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpO30pCiAgICAgIDogczsKfTsKCgovLyBTdHJpbmcjdG9Mb3dlckNhc2UgYW5kIFN0cmluZyN0b1VwcGVyQ2FzZSBkb24ndCBwcm9kdWNlIGNvcnJlY3QgcmVzdWx0cyBpbiBicm93c2VycyB3aXRoIFR1cmtpc2gKLy8gbG9jYWxlLCBmb3IgdGhpcyByZWFzb24gd2UgbmVlZCB0byBkZXRlY3QgdGhpcyBjYXNlIGFuZCByZWRlZmluZSBsb3dlcmNhc2UvdXBwZXJjYXNlIG1ldGhvZHMKLy8gd2l0aCBjb3JyZWN0IGJ1dCBzbG93ZXIgYWx0ZXJuYXRpdmVzLgppZiAoJ2knICE9PSAnSScudG9Mb3dlckNhc2UoKSkgewogIGxvd2VyY2FzZSA9IG1hbnVhbExvd2VyY2FzZTsKICB1cHBlcmNhc2UgPSBtYW51YWxVcHBlcmNhc2U7Cn0KCgp2YXIgLyoqIGhvbGRzIG1ham9yIHZlcnNpb24gbnVtYmVyIGZvciBJRSBvciBOYU4gZm9yIHJlYWwgYnJvd3NlcnMgKi8KICAgIG1zaWUsCiAgICBqcUxpdGUsICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nIHNpbmNlIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgYWZ0ZXIgdXMuCiAgICBqUXVlcnksICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nCiAgICBzbGljZSAgICAgICAgICAgICA9IFtdLnNsaWNlLAogICAgcHVzaCAgICAgICAgICAgICAgPSBbXS5wdXNoLAogICAgdG9TdHJpbmcgICAgICAgICAgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgbmdNaW5FcnIgICAgICAgICAgPSBtaW5FcnIoJ25nJyksCgogICAgLyoqIEBuYW1lIGFuZ3VsYXIgKi8KICAgIGFuZ3VsYXIgICAgICAgICAgID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgYW5ndWxhck1vZHVsZSwKICAgIG5vZGVOYW1lXywKICAgIHVpZCAgICAgICAgICAgICAgID0gWycwJywgJzAnLCAnMCddOwoKLyoqCiAqIElFIDExIGNoYW5nZWQgdGhlIGZvcm1hdCBvZiB0aGUgVXNlckFnZW50IHN0cmluZy4KICogU2VlIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9tczUzNzUwMy5hc3B4CiAqLwptc2llID0gaW50KCgvbXNpZSAoXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CmlmIChpc05hTihtc2llKSkgewogIG1zaWUgPSBpbnQoKC90cmlkZW50XC8uKjsgcnY6KFxkKykvLmV4ZWMobG93ZXJjYXNlKG5hdmlnYXRvci51c2VyQWdlbnQpKSB8fCBbXSlbMV0pOwp9CgoKLyoqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gb2JqCiAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlIG9iamVjdCAoTm9kZUxpc3QsIEFyZ3VtZW50cywKICogICAgICAgICAgICAgICAgICAgU3RyaW5nIC4uLikKICovCmZ1bmN0aW9uIGlzQXJyYXlMaWtlKG9iaikgewogIGlmIChvYmogPT0gbnVsbCB8fCBpc1dpbmRvdyhvYmopKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aDsKCiAgaWYgKG9iai5ub2RlVHlwZSA9PT0gMSAmJiBsZW5ndGgpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgcmV0dXJuIGlzU3RyaW5nKG9iaikgfHwgaXNBcnJheShvYmopIHx8IGxlbmd0aCA9PT0gMCB8fAogICAgICAgICB0eXBlb2YgbGVuZ3RoID09PSAnbnVtYmVyJyAmJiBsZW5ndGggPiAwICYmIChsZW5ndGggLSAxKSBpbiBvYmo7Cn0KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5mb3JFYWNoCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24sIHdoaWNoIGNhbiBiZSBlaXRoZXIgYW4KICogb2JqZWN0IG9yIGFuIGFycmF5LiBUaGUgYGl0ZXJhdG9yYCBmdW5jdGlvbiBpcyBpbnZva2VkIHdpdGggYGl0ZXJhdG9yKHZhbHVlLCBrZXkpYCwgd2hlcmUgYHZhbHVlYAogKiBpcyB0aGUgdmFsdWUgb2YgYW4gb2JqZWN0IHByb3BlcnR5IG9yIGFuIGFycmF5IGVsZW1lbnQgYW5kIGBrZXlgIGlzIHRoZSBvYmplY3QgcHJvcGVydHkga2V5IG9yCiAqIGFycmF5IGVsZW1lbnQgaW5kZXguIFNwZWNpZnlpbmcgYSBgY29udGV4dGAgZm9yIHRoZSBmdW5jdGlvbiBpcyBvcHRpb25hbC4KICoKICogSXQgaXMgd29ydGggbm90aW5nIHRoYXQgYC5mb3JFYWNoYCBkb2VzIG5vdCBpdGVyYXRlIG92ZXIgaW5oZXJpdGVkIHByb3BlcnRpZXMgYmVjYXVzZSBpdCBmaWx0ZXJzCiAqIHVzaW5nIHRoZSBgaGFzT3duUHJvcGVydHlgIG1ldGhvZC4KICoKICAgYGBganMKICAgICB2YXIgdmFsdWVzID0ge25hbWU6ICdtaXNrbycsIGdlbmRlcjogJ21hbGUnfTsKICAgICB2YXIgbG9nID0gW107CiAgICAgYW5ndWxhci5mb3JFYWNoKHZhbHVlcywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgdGhpcy5wdXNoKGtleSArICc6ICcgKyB2YWx1ZSk7CiAgICAgfSwgbG9nKTsKICAgICBleHBlY3QobG9nKS50b0VxdWFsKFsnbmFtZTogbWlza28nLCAnZ2VuZGVyOiBtYWxlJ10pOwogICBgYGAKICoKICogQHBhcmFtIHtPYmplY3R8QXJyYXl9IG9iaiBPYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRvciBJdGVyYXRvciBmdW5jdGlvbi4KICogQHBhcmFtIHtPYmplY3Q9fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fSBSZWZlcmVuY2UgdG8gYG9iamAuCiAqLwpmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIga2V5OwogIGlmIChvYmopIHsKICAgIGlmIChpc0Z1bmN0aW9uKG9iaikpIHsKICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgLy8gTmVlZCB0byBjaGVjayBpZiBoYXNPd25Qcm9wZXJ0eSBleGlzdHMsCiAgICAgICAgLy8gYXMgb24gSUU4IHRoZSByZXN1bHQgb2YgcXVlcnlTZWxlY3RvckFsbCBpcyBhbiBvYmplY3Qgd2l0aG91dCBhIGhhc093blByb3BlcnR5IGZ1bmN0aW9uCiAgICAgICAgaWYgKGtleSAhPSAncHJvdG90eXBlJyAmJiBrZXkgIT0gJ2xlbmd0aCcgJiYga2V5ICE9ICduYW1lJyAmJiAoIW9iai5oYXNPd25Qcm9wZXJ0eSB8fCBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkpIHsKICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKG9iai5mb3JFYWNoICYmIG9iai5mb3JFYWNoICE9PSBmb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2Uob2JqKSkgewogICAgICBmb3IgKGtleSA9IDA7IGtleSA8IG9iai5sZW5ndGg7IGtleSsrKQogICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBvYmo7Cn0KCmZ1bmN0aW9uIHNvcnRlZEtleXMob2JqKSB7CiAgdmFyIGtleXMgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAga2V5cy5wdXNoKGtleSk7CiAgICB9CiAgfQogIHJldHVybiBrZXlzLnNvcnQoKTsKfQoKZnVuY3Rpb24gZm9yRWFjaFNvcnRlZChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgdmFyIGtleXMgPSBzb3J0ZWRLZXlzKG9iaik7CiAgZm9yICggdmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5c1tpXV0sIGtleXNbaV0pOwogIH0KICByZXR1cm4ga2V5czsKfQoKCi8qKgogKiB3aGVuIHVzaW5nIGZvckVhY2ggdGhlIHBhcmFtcyBhcmUgdmFsdWUsIGtleSwgYnV0IGl0IGlzIG9mdGVuIHVzZWZ1bCB0byBoYXZlIGtleSwgdmFsdWUuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nLCAqKX0gaXRlcmF0b3JGbgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oKiwgc3RyaW5nKX0KICovCmZ1bmN0aW9uIHJldmVyc2VQYXJhbXMoaXRlcmF0b3JGbikgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSwga2V5KSB7IGl0ZXJhdG9yRm4oa2V5LCB2YWx1ZSk7IH07Cn0KCi8qKgogKiBBIGNvbnNpc3RlbnQgd2F5IG9mIGNyZWF0aW5nIHVuaXF1ZSBJRHMgaW4gYW5ndWxhci4gVGhlIElEIGlzIGEgc2VxdWVuY2Ugb2YgYWxwaGEgbnVtZXJpYwogKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogKiB0aGUgbnVtYmVyIHN0cmluZyBnZXRzIGxvbmdlciBvdmVyIHRpbWUsIGFuZCBpdCBjYW4gYWxzbyBvdmVyZmxvdywgd2hlcmUgYXMgdGhlIG5leHRJZAogKiB3aWxsIGdyb3cgbXVjaCBzbG93ZXIsIGl0IGlzIGEgc3RyaW5nLCBhbmQgaXQgd2lsbCBuZXZlciBvdmVyZmxvdy4KICoKICogQHJldHVybnMge3N0cmluZ30gYW4gdW5pcXVlIGFscGhhLW51bWVyaWMgc3RyaW5nCiAqLwpmdW5jdGlvbiBuZXh0VWlkKCkgewogIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgdmFyIGRpZ2l0OwoKICB3aGlsZShpbmRleCkgewogICAgaW5kZXgtLTsKICAgIGRpZ2l0ID0gdWlkW2luZGV4XS5jaGFyQ29kZUF0KDApOwogICAgaWYgKGRpZ2l0ID09IDU3IC8qJzknKi8pIHsKICAgICAgdWlkW2luZGV4XSA9ICdBJzsKICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgIH0KICAgIGlmIChkaWdpdCA9PSA5MCAgLyonWicqLykgewogICAgICB1aWRbaW5kZXhdID0gJzAnOwogICAgfSBlbHNlIHsKICAgICAgdWlkW2luZGV4XSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZGlnaXQgKyAxKTsKICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgIH0KICB9CiAgdWlkLnVuc2hpZnQoJzAnKTsKICByZXR1cm4gdWlkLmpvaW4oJycpOwp9CgoKLyoqCiAqIFNldCBvciBjbGVhciB0aGUgaGFzaGtleSBmb3IgYW4gb2JqZWN0LgogKiBAcGFyYW0gb2JqIG9iamVjdAogKiBAcGFyYW0gaCB0aGUgaGFzaGtleSAoIXRydXRoeSB0byBkZWxldGUgdGhlIGhhc2hrZXkpCiAqLwpmdW5jdGlvbiBzZXRIYXNoS2V5KG9iaiwgaCkgewogIGlmIChoKSB7CiAgICBvYmouJCRoYXNoS2V5ID0gaDsKICB9CiAgZWxzZSB7CiAgICBkZWxldGUgb2JqLiQkaGFzaEtleTsKICB9Cn0KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5leHRlbmQKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRXh0ZW5kcyB0aGUgZGVzdGluYXRpb24gb2JqZWN0IGBkc3RgIGJ5IGNvcHlpbmcgYWxsIG9mIHRoZSBwcm9wZXJ0aWVzIGZyb20gdGhlIGBzcmNgIG9iamVjdChzKQogKiB0byBgZHN0YC4gWW91IGNhbiBzcGVjaWZ5IG11bHRpcGxlIGBzcmNgIG9iamVjdHMuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBkc3QgRGVzdGluYXRpb24gb2JqZWN0LgogKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFNvdXJjZSBvYmplY3QocykuCiAqIEByZXR1cm5zIHtPYmplY3R9IFJlZmVyZW5jZSB0byBgZHN0YC4KICovCmZ1bmN0aW9uIGV4dGVuZChkc3QpIHsKICB2YXIgaCA9IGRzdC4kJGhhc2hLZXk7CiAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIHNldEhhc2hLZXkoZHN0LGgpOwogIHJldHVybiBkc3Q7Cn0KCmZ1bmN0aW9uIGludChzdHIpIHsKICByZXR1cm4gcGFyc2VJbnQoc3RyLCAxMCk7Cn0KCgpmdW5jdGlvbiBpbmhlcml0KHBhcmVudCwgZXh0cmEpIHsKICByZXR1cm4gZXh0ZW5kKG5ldyAoZXh0ZW5kKGZ1bmN0aW9uKCkge30sIHtwcm90b3R5cGU6cGFyZW50fSkpKCksIGV4dHJhKTsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLm5vb3AKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQSBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIG5vIG9wZXJhdGlvbnMuIFRoaXMgZnVuY3Rpb24gY2FuIGJlIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICogZnVuY3Rpb25hbCBzdHlsZS4KICAgYGBganMKICAgICBmdW5jdGlvbiBmb28oY2FsbGJhY2spIHsKICAgICAgIHZhciByZXN1bHQgPSBjYWxjdWxhdGVSZXN1bHQoKTsKICAgICAgIChjYWxsYmFjayB8fCBhbmd1bGFyLm5vb3ApKHJlc3VsdCk7CiAgICAgfQogICBgYGAKICovCmZ1bmN0aW9uIG5vb3AoKSB7fQpub29wLiRpbmplY3QgPSBbXTsKCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaWRlbnRpdHkKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQSBmdW5jdGlvbiB0aGF0IHJldHVybnMgaXRzIGZpcnN0IGFyZ3VtZW50LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICogZnVuY3Rpb25hbCBzdHlsZS4KICoKICAgYGBganMKICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1lcih0cmFuc2Zvcm1hdGlvbkZuLCB2YWx1ZSkgewogICAgICAgcmV0dXJuICh0cmFuc2Zvcm1hdGlvbkZuIHx8IGFuZ3VsYXIuaWRlbnRpdHkpKHZhbHVlKTsKICAgICB9OwogICBgYGAKICovCmZ1bmN0aW9uIGlkZW50aXR5KCQpIHtyZXR1cm4gJDt9CmlkZW50aXR5LiRpbmplY3QgPSBbXTsKCgpmdW5jdGlvbiB2YWx1ZUZuKHZhbHVlKSB7cmV0dXJuIGZ1bmN0aW9uKCkge3JldHVybiB2YWx1ZTt9O30KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc1VuZGVmaW5lZAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIHVuZGVmaW5lZC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgdW5kZWZpbmVkLgogKi8KZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnO30KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNEZWZpbmVkCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgZGVmaW5lZC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgZGVmaW5lZC4KICovCmZ1bmN0aW9uIGlzRGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCc7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc09iamVjdAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBPYmplY3RgLiBVbmxpa2UgYHR5cGVvZmAgaW4gSmF2YVNjcmlwdCwgYG51bGxgcyBhcmUgbm90CiAqIGNvbnNpZGVyZWQgdG8gYmUgb2JqZWN0cy4gTm90ZSB0aGF0IEphdmFTY3JpcHQgYXJyYXlzIGFyZSBvYmplY3RzLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgT2JqZWN0YCBidXQgbm90IGBudWxsYC4KICovCmZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKXtyZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnO30KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNTdHJpbmcKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBTdHJpbmdgLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBTdHJpbmdgLgogKi8KZnVuY3Rpb24gaXNTdHJpbmcodmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnO30KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNOdW1iZXIKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBOdW1iZXJgLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBOdW1iZXJgLgogKi8KZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInO30KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNEYXRlCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSB2YWx1ZSBpcyBhIGRhdGUuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYERhdGVgLgogKi8KZnVuY3Rpb24gaXNEYXRlKHZhbHVlKSB7CiAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAnW29iamVjdCBEYXRlXSc7Cn0KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNBcnJheQogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBBcnJheWAuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBBcnJheWAuCiAqLwpmdW5jdGlvbiBpc0FycmF5KHZhbHVlKSB7CiAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAnW29iamVjdCBBcnJheV0nOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzRnVuY3Rpb24KICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBGdW5jdGlvbmAuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYEZ1bmN0aW9uYC4KICovCmZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbic7fQoKCi8qKgogKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24gb2JqZWN0LgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBSZWdFeHBgLgogKi8KZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwp9CgoKLyoqCiAqIENoZWNrcyBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmplY3QuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gb2JqIE9iamVjdCB0byBjaGVjawogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmouCiAqLwpmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICByZXR1cm4gb2JqICYmIG9iai5kb2N1bWVudCAmJiBvYmoubG9jYXRpb24gJiYgb2JqLmFsZXJ0ICYmIG9iai5zZXRJbnRlcnZhbDsKfQoKCmZ1bmN0aW9uIGlzU2NvcGUob2JqKSB7CiAgcmV0dXJuIG9iaiAmJiBvYmouJGV2YWxBc3luYyAmJiBvYmouJHdhdGNoOwp9CgoKZnVuY3Rpb24gaXNGaWxlKG9iaikgewogIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEZpbGVdJzsKfQoKCmZ1bmN0aW9uIGlzQmxvYihvYmopIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBCbG9iXSc7Cn0KCgpmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbic7Cn0KCgp2YXIgdHJpbSA9IChmdW5jdGlvbigpIHsKICAvLyBuYXRpdmUgdHJpbSBpcyB3YXkgZmFzdGVyOiBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyLXRyaW0tdGVzdAogIC8vIGJ1dCBJRSBkb2Vzbid0IGhhdmUgaXQuLi4gOi0oCiAgLy8gVE9ETzogd2Ugc2hvdWxkIG1vdmUgdGhpcyBpbnRvIElFL0VTNSBwb2x5ZmlsbAogIGlmICghU3RyaW5nLnByb3RvdHlwZS50cmltKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIGlzU3RyaW5nKHZhbHVlKSA/IHZhbHVlLnJlcGxhY2UoL15cc1xzKi8sICcnKS5yZXBsYWNlKC9cc1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgIH07CiAgfQogIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGlzU3RyaW5nKHZhbHVlKSA/IHZhbHVlLnRyaW0oKSA6IHZhbHVlOwogIH07Cn0pKCk7CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzRWxlbWVudAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICovCmZ1bmN0aW9uIGlzRWxlbWVudChub2RlKSB7CiAgcmV0dXJuICEhKG5vZGUgJiYKICAgIChub2RlLm5vZGVOYW1lICAvLyB3ZSBhcmUgYSBkaXJlY3QgZWxlbWVudAogICAgfHwgKG5vZGUucHJvcCAmJiBub2RlLmF0dHIgJiYgbm9kZS5maW5kKSkpOyAgLy8gd2UgaGF2ZSBhbiBvbiBhbmQgZmluZCBtZXRob2QgcGFydCBvZiBqUXVlcnkgQVBJCn0KCi8qKgogKiBAcGFyYW0gc3RyICdrZXkxLGtleTIsLi4uJwogKiBAcmV0dXJucyB7b2JqZWN0fSBpbiB0aGUgZm9ybSBvZiB7a2V5MTp0cnVlLCBrZXkyOnRydWUsIC4uLn0KICovCmZ1bmN0aW9uIG1ha2VNYXAoc3RyKSB7CiAgdmFyIG9iaiA9IHt9LCBpdGVtcyA9IHN0ci5zcGxpdCgiLCIpLCBpOwogIGZvciAoIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKysgKQogICAgb2JqWyBpdGVtc1tpXSBdID0gdHJ1ZTsKICByZXR1cm4gb2JqOwp9CgoKaWYgKG1zaWUgPCA5KSB7CiAgbm9kZU5hbWVfID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgZWxlbWVudCA9IGVsZW1lbnQubm9kZU5hbWUgPyBlbGVtZW50IDogZWxlbWVudFswXTsKICAgIHJldHVybiAoZWxlbWVudC5zY29wZU5hbWUgJiYgZWxlbWVudC5zY29wZU5hbWUgIT0gJ0hUTUwnKQogICAgICA/IHVwcGVyY2FzZShlbGVtZW50LnNjb3BlTmFtZSArICc6JyArIGVsZW1lbnQubm9kZU5hbWUpIDogZWxlbWVudC5ub2RlTmFtZTsKICB9Owp9IGVsc2UgewogIG5vZGVOYW1lXyA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHJldHVybiBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudC5ub2RlTmFtZSA6IGVsZW1lbnRbMF0ubm9kZU5hbWU7CiAgfTsKfQoKCmZ1bmN0aW9uIG1hcChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgdmFyIHJlc3VsdHMgPSBbXTsKICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKTsKICB9KTsKICByZXR1cm4gcmVzdWx0czsKfQoKCi8qKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIGFycmF5LCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYW4gb2JqZWN0IGhhcywgb3IKICogdGhlIGxlbmd0aCBvZiBhIHN0cmluZy4KICoKICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogKiB7QGxpbmsgYW5ndWxhci5PYmplY3R9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheXxzdHJpbmd9IG9iaiBPYmplY3QsIGFycmF5LCBvciBzdHJpbmcgdG8gaW5zcGVjdC4KICogQHBhcmFtIHtib29sZWFufSBbb3duUHJvcHNPbmx5PWZhbHNlXSBDb3VudCBvbmx5ICJvd24iIHByb3BlcnRpZXMgaW4gYW4gb2JqZWN0CiAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBzaXplIG9mIGBvYmpgIG9yIGAwYCBpZiBgb2JqYCBpcyBuZWl0aGVyIGFuIG9iamVjdCBub3IgYW4gYXJyYXkuCiAqLwpmdW5jdGlvbiBzaXplKG9iaiwgb3duUHJvcHNPbmx5KSB7CiAgdmFyIGNvdW50ID0gMCwga2V5OwoKICBpZiAoaXNBcnJheShvYmopIHx8IGlzU3RyaW5nKG9iaikpIHsKICAgIHJldHVybiBvYmoubGVuZ3RoOwogIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgZm9yIChrZXkgaW4gb2JqKQogICAgICBpZiAoIW93blByb3BzT25seSB8fCBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICBjb3VudCsrOwogIH0KCiAgcmV0dXJuIGNvdW50Owp9CgoKZnVuY3Rpb24gaW5jbHVkZXMoYXJyYXksIG9iaikgewogIHJldHVybiBpbmRleE9mKGFycmF5LCBvYmopICE9IC0xOwp9CgpmdW5jdGlvbiBpbmRleE9mKGFycmF5LCBvYmopIHsKICBpZiAoYXJyYXkuaW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2Yob2JqKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgaWYgKG9iaiA9PT0gYXJyYXlbaV0pIHJldHVybiBpOwogIH0KICByZXR1cm4gLTE7Cn0KCmZ1bmN0aW9uIGFycmF5UmVtb3ZlKGFycmF5LCB2YWx1ZSkgewogIHZhciBpbmRleCA9IGluZGV4T2YoYXJyYXksIHZhbHVlKTsKICBpZiAoaW5kZXggPj0wKQogICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKICByZXR1cm4gdmFsdWU7Cn0KCmZ1bmN0aW9uIGlzTGVhZk5vZGUgKG5vZGUpIHsKICBpZiAobm9kZSkgewogICAgc3dpdGNoIChub2RlLm5vZGVOYW1lKSB7CiAgICBjYXNlICJPUFRJT04iOgogICAgY2FzZSAiUFJFIjoKICAgIGNhc2UgIlRJVExFIjoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmNvcHkKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlcyBhIGRlZXAgY29weSBvZiBgc291cmNlYCwgd2hpY2ggc2hvdWxkIGJlIGFuIG9iamVjdCBvciBhbiBhcnJheS4KICoKICogKiBJZiBubyBkZXN0aW5hdGlvbiBpcyBzdXBwbGllZCwgYSBjb3B5IG9mIHRoZSBvYmplY3Qgb3IgYXJyYXkgaXMgY3JlYXRlZC4KICogKiBJZiBhIGRlc3RpbmF0aW9uIGlzIHByb3ZpZGVkLCBhbGwgb2YgaXRzIGVsZW1lbnRzIChmb3IgYXJyYXkpIG9yIHByb3BlcnRpZXMgKGZvciBvYmplY3RzKQogKiAgIGFyZSBkZWxldGVkIGFuZCB0aGVuIGFsbCBlbGVtZW50cy9wcm9wZXJ0aWVzIGZyb20gdGhlIHNvdXJjZSBhcmUgY29waWVkIHRvIGl0LgogKiAqIElmIGBzb3VyY2VgIGlzIG5vdCBhbiBvYmplY3Qgb3IgYXJyYXkgKGluYy4gYG51bGxgIGFuZCBgdW5kZWZpbmVkYCksIGBzb3VyY2VgIGlzIHJldHVybmVkLgogKiAqIElmIGBzb3VyY2VgIGlzIGlkZW50aWNhbCB0byAnZGVzdGluYXRpb24nIGFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93bi4KICoKICogQHBhcmFtIHsqfSBzb3VyY2UgVGhlIHNvdXJjZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBtYWtlIGEgY29weS4KICogICAgICAgICAgICAgICAgICAgQ2FuIGJlIGFueSB0eXBlLCBpbmNsdWRpbmcgcHJpbWl0aXZlcywgYG51bGxgLCBhbmQgYHVuZGVmaW5lZGAuCiAqIEBwYXJhbSB7KE9iamVjdHxBcnJheSk9fSBkZXN0aW5hdGlvbiBEZXN0aW5hdGlvbiBpbnRvIHdoaWNoIHRoZSBzb3VyY2UgaXMgY29waWVkLiBJZgogKiAgICAgcHJvdmlkZWQsIG11c3QgYmUgb2YgdGhlIHNhbWUgdHlwZSBhcyBgc291cmNlYC4KICogQHJldHVybnMgeyp9IFRoZSBjb3B5IG9yIHVwZGF0ZWQgYGRlc3RpbmF0aW9uYCwgaWYgYGRlc3RpbmF0aW9uYCB3YXMgc3BlY2lmaWVkLgogKgogKiBAZXhhbXBsZQogPGV4YW1wbGU+CiA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KIDxkaXYgbmctY29udHJvbGxlcj0iQ29udHJvbGxlciI+CiA8Zm9ybSBub3ZhbGlkYXRlIGNsYXNzPSJzaW1wbGUtZm9ybSI+CiBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVzZXIubmFtZSIgLz48YnIgLz4KIEUtbWFpbDogPGlucHV0IHR5cGU9ImVtYWlsIiBuZy1tb2RlbD0idXNlci5lbWFpbCIgLz48YnIgLz4KIEdlbmRlcjogPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0idXNlci5nZW5kZXIiIHZhbHVlPSJtYWxlIiAvPm1hbGUKIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9InVzZXIuZ2VuZGVyIiB2YWx1ZT0iZmVtYWxlIiAvPmZlbWFsZTxiciAvPgogPGJ1dHRvbiBuZy1jbGljaz0icmVzZXQoKSI+UkVTRVQ8L2J1dHRvbj4KIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZSh1c2VyKSI+U0FWRTwvYnV0dG9uPgogPC9mb3JtPgogPHByZT5mb3JtID0ge3t1c2VyIHwganNvbn19PC9wcmU+CiA8cHJlPm1hc3RlciA9IHt7bWFzdGVyIHwganNvbn19PC9wcmU+CiA8L2Rpdj4KCiA8c2NyaXB0PgogZnVuY3Rpb24gQ29udHJvbGxlcigkc2NvcGUpIHsKICAgICRzY29wZS5tYXN0ZXI9IHt9OwoKICAgICRzY29wZS51cGRhdGUgPSBmdW5jdGlvbih1c2VyKSB7CiAgICAgIC8vIEV4YW1wbGUgd2l0aCAxIGFyZ3VtZW50CiAgICAgICRzY29wZS5tYXN0ZXI9IGFuZ3VsYXIuY29weSh1c2VyKTsKICAgIH07CgogICAgJHNjb3BlLnJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIEV4YW1wbGUgd2l0aCAyIGFyZ3VtZW50cwogICAgICBhbmd1bGFyLmNvcHkoJHNjb3BlLm1hc3RlciwgJHNjb3BlLnVzZXIpOwogICAgfTsKCiAgICAkc2NvcGUucmVzZXQoKTsKICB9CiA8L3NjcmlwdD4KIDwvZmlsZT4KIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uIGNvcHkoc291cmNlLCBkZXN0aW5hdGlvbiwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCkgewogIGlmIChpc1dpbmRvdyhzb3VyY2UpIHx8IGlzU2NvcGUoc291cmNlKSkgewogICAgdGhyb3cgbmdNaW5FcnIoJ2Nwd3MnLAogICAgICAiQ2FuJ3QgY29weSEgTWFraW5nIGNvcGllcyBvZiBXaW5kb3cgb3IgU2NvcGUgaW5zdGFuY2VzIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgfQoKICBpZiAoIWRlc3RpbmF0aW9uKSB7CiAgICBkZXN0aW5hdGlvbiA9IHNvdXJjZTsKICAgIGlmIChzb3VyY2UpIHsKICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIFtdLCBzdGFja1NvdXJjZSwgc3RhY2tEZXN0KTsKICAgICAgfSBlbHNlIGlmIChpc0RhdGUoc291cmNlKSkgewogICAgICAgIGRlc3RpbmF0aW9uID0gbmV3IERhdGUoc291cmNlLmdldFRpbWUoKSk7CiAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAoc291cmNlKSkgewogICAgICAgIGRlc3RpbmF0aW9uID0gbmV3IFJlZ0V4cChzb3VyY2Uuc291cmNlKTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwge30sIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChzb3VyY2UgPT09IGRlc3RpbmF0aW9uKSB0aHJvdyBuZ01pbkVycignY3BpJywKICAgICAgIkNhbid0IGNvcHkhIFNvdXJjZSBhbmQgZGVzdGluYXRpb24gYXJlIGlkZW50aWNhbC4iKTsKCiAgICBzdGFja1NvdXJjZSA9IHN0YWNrU291cmNlIHx8IFtdOwogICAgc3RhY2tEZXN0ID0gc3RhY2tEZXN0IHx8IFtdOwoKICAgIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgIHZhciBpbmRleCA9IGluZGV4T2Yoc3RhY2tTb3VyY2UsIHNvdXJjZSk7CiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBzdGFja0Rlc3RbaW5kZXhdOwoKICAgICAgc3RhY2tTb3VyY2UucHVzaChzb3VyY2UpOwogICAgICBzdGFja0Rlc3QucHVzaChkZXN0aW5hdGlvbik7CiAgICB9CgogICAgdmFyIHJlc3VsdDsKICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgZGVzdGluYXRpb24ubGVuZ3RoID0gMDsKICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ID0gY29weShzb3VyY2VbaV0sIG51bGwsIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpOwogICAgICAgIGlmIChpc09iamVjdChzb3VyY2VbaV0pKSB7CiAgICAgICAgICBzdGFja1NvdXJjZS5wdXNoKHNvdXJjZVtpXSk7CiAgICAgICAgICBzdGFja0Rlc3QucHVzaChyZXN1bHQpOwogICAgICAgIH0KICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKHJlc3VsdCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBoID0gZGVzdGluYXRpb24uJCRoYXNoS2V5OwogICAgICBmb3JFYWNoKGRlc3RpbmF0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgZGVsZXRlIGRlc3RpbmF0aW9uW2tleV07CiAgICAgIH0pOwogICAgICBmb3IgKCB2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgIHJlc3VsdCA9IGNvcHkoc291cmNlW2tleV0sIG51bGwsIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpOwogICAgICAgIGlmIChpc09iamVjdChzb3VyY2Vba2V5XSkpIHsKICAgICAgICAgIHN0YWNrU291cmNlLnB1c2goc291cmNlW2tleV0pOwogICAgICAgICAgc3RhY2tEZXN0LnB1c2gocmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgZGVzdGluYXRpb25ba2V5XSA9IHJlc3VsdDsKICAgICAgfQogICAgICBzZXRIYXNoS2V5KGRlc3RpbmF0aW9uLGgpOwogICAgfQoKICB9CiAgcmV0dXJuIGRlc3RpbmF0aW9uOwp9CgovKioKICogQ3JlYXRlcyBhIHNoYWxsb3cgY29weSBvZiBhbiBvYmplY3QsIGFuIGFycmF5IG9yIGEgcHJpbWl0aXZlCiAqLwpmdW5jdGlvbiBzaGFsbG93Q29weShzcmMsIGRzdCkgewogIGlmIChpc0FycmF5KHNyYykpIHsKICAgIGRzdCA9IGRzdCB8fCBbXTsKCiAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzcmMubGVuZ3RoOyBpKyspIHsKICAgICAgZHN0W2ldID0gc3JjW2ldOwogICAgfQogIH0gZWxzZSBpZiAoaXNPYmplY3Qoc3JjKSkgewogICAgZHN0ID0gZHN0IHx8IHt9OwoKICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc3JjLCBrZXkpICYmICEoa2V5LmNoYXJBdCgwKSA9PT0gJyQnICYmIGtleS5jaGFyQXQoMSkgPT09ICckJykpIHsKICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gZHN0IHx8IHNyYzsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5lcXVhbHMKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB0d28gdmFsdWVzIGFyZSBlcXVpdmFsZW50LiBTdXBwb3J0cyB2YWx1ZSB0eXBlcywgcmVndWxhcgogKiBleHByZXNzaW9ucywgYXJyYXlzIGFuZCBvYmplY3RzLgogKgogKiBUd28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBpZiBhdCBsZWFzdCBvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlOgogKgogKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgcGFzcyBgPT09YCBjb21wYXJpc29uLgogKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgYXJlIG9mIHRoZSBzYW1lIHR5cGUgYW5kIGFsbCBvZiB0aGVpciBwcm9wZXJ0aWVzIGFyZSBlcXVhbCBieQogKiAgIGNvbXBhcmluZyB0aGVtIHdpdGggYGFuZ3VsYXIuZXF1YWxzYC4KICogKiBCb3RoIHZhbHVlcyBhcmUgTmFOLiAoSW4gSmF2YVNjcmlwdCwgTmFOID09IE5hTiA9PiBmYWxzZS4gQnV0IHdlIGNvbnNpZGVyIHR3byBOYU4gYXMgZXF1YWwpCiAqICogQm90aCB2YWx1ZXMgcmVwcmVzZW50IHRoZSBzYW1lIHJlZ3VsYXIgZXhwcmVzc2lvbiAoSW4gSmF2YVNjcmlwdCwKICogICAvYWJjLyA9PSAvYWJjLyA9PiBmYWxzZS4gQnV0IHdlIGNvbnNpZGVyIHR3byByZWd1bGFyIGV4cHJlc3Npb25zIGFzIGVxdWFsIHdoZW4gdGhlaXIgdGV4dHVhbAogKiAgIHJlcHJlc2VudGF0aW9uIG1hdGNoZXMpLgogKgogKiBEdXJpbmcgYSBwcm9wZXJ0eSBjb21wYXJpc29uLCBwcm9wZXJ0aWVzIG9mIGBmdW5jdGlvbmAgdHlwZSBhbmQgcHJvcGVydGllcyB3aXRoIG5hbWVzCiAqIHRoYXQgYmVnaW4gd2l0aCBgJGAgYXJlIGlnbm9yZWQuCiAqCiAqIFNjb3BlIGFuZCBET01XaW5kb3cgb2JqZWN0cyBhcmUgYmVpbmcgY29tcGFyZWQgb25seSBieSBpZGVudGlmeSAoYD09PWApLgogKgogKiBAcGFyYW0geyp9IG8xIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogKiBAcGFyYW0geyp9IG8yIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogKi8KZnVuY3Rpb24gZXF1YWxzKG8xLCBvMikgewogIGlmIChvMSA9PT0gbzIpIHJldHVybiB0cnVlOwogIGlmIChvMSA9PT0gbnVsbCB8fCBvMiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogIGlmIChvMSAhPT0gbzEgJiYgbzIgIT09IG8yKSByZXR1cm4gdHJ1ZTsgLy8gTmFOID09PSBOYU4KICB2YXIgdDEgPSB0eXBlb2YgbzEsIHQyID0gdHlwZW9mIG8yLCBsZW5ndGgsIGtleSwga2V5U2V0OwogIGlmICh0MSA9PSB0MikgewogICAgaWYgKHQxID09ICdvYmplY3QnKSB7CiAgICAgIGlmIChpc0FycmF5KG8xKSkgewogICAgICAgIGlmICghaXNBcnJheShvMikpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoKGxlbmd0aCA9IG8xLmxlbmd0aCkgPT0gbzIubGVuZ3RoKSB7CiAgICAgICAgICBmb3Ioa2V5PTA7IGtleTxsZW5ndGg7IGtleSsrKSB7CiAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKG8xKSkgewogICAgICAgIHJldHVybiBpc0RhdGUobzIpICYmIG8xLmdldFRpbWUoKSA9PSBvMi5nZXRUaW1lKCk7CiAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAobzEpICYmIGlzUmVnRXhwKG8yKSkgewogICAgICAgIHJldHVybiBvMS50b1N0cmluZygpID09IG8yLnRvU3RyaW5nKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzU2NvcGUobzEpIHx8IGlzU2NvcGUobzIpIHx8IGlzV2luZG93KG8xKSB8fCBpc1dpbmRvdyhvMikgfHwgaXNBcnJheShvMikpIHJldHVybiBmYWxzZTsKICAgICAgICBrZXlTZXQgPSB7fTsKICAgICAgICBmb3Ioa2V5IGluIG8xKSB7CiAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSA9PT0gJyQnIHx8IGlzRnVuY3Rpb24obzFba2V5XSkpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKCFlcXVhbHMobzFba2V5XSwgbzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGtleVNldFtrZXldID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZm9yKGtleSBpbiBvMikgewogICAgICAgICAgaWYgKCFrZXlTZXQuaGFzT3duUHJvcGVydHkoa2V5KSAmJgogICAgICAgICAgICAgIGtleS5jaGFyQXQoMCkgIT09ICckJyAmJgogICAgICAgICAgICAgIG8yW2tleV0gIT09IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQoKCmZ1bmN0aW9uIGNzcCgpIHsKICByZXR1cm4gKGRvY3VtZW50LnNlY3VyaXR5UG9saWN5ICYmIGRvY3VtZW50LnNlY3VyaXR5UG9saWN5LmlzQWN0aXZlKSB8fAogICAgICAoZG9jdW1lbnQucXVlcnlTZWxlY3RvciAmJgogICAgICAhIShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbbmctY3NwXScpIHx8IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW5nLWNzcF0nKSkpOwp9CgoKZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwp9CgpmdW5jdGlvbiBzbGljZUFyZ3MoYXJncywgc3RhcnRJbmRleCkgewogIHJldHVybiBzbGljZS5jYWxsKGFyZ3MsIHN0YXJ0SW5kZXggfHwgMCk7Cn0KCgovKiBqc2hpbnQgLVcxMDEgKi8KLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmJpbmQKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogUmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIGNhbGxzIGZ1bmN0aW9uIGBmbmAgYm91bmQgdG8gYHNlbGZgIChgc2VsZmAgYmVjb21lcyB0aGUgYHRoaXNgIGZvcgogKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICoga25vd24gYXMgW3BhcnRpYWwgYXBwbGljYXRpb25dKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUGFydGlhbF9hcHBsaWNhdGlvbiksIGFzCiAqIGRpc3Rpbmd1aXNoZWQgZnJvbSBbZnVuY3Rpb24gY3VycnlpbmddKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3VycnlpbmcjQ29udHJhc3Rfd2l0aF9wYXJ0aWFsX2Z1bmN0aW9uX2FwcGxpY2F0aW9uKS4KICoKICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gRnVuY3Rpb24gdG8gYmUgYm91bmQuCiAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBhcmd1bWVudHMgdG8gYmUgcHJlYm91bmQgdG8gdGhlIGBmbmAgZnVuY3Rpb24gY2FsbC4KICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICovCi8qIGpzaGludCArVzEwMSAqLwpmdW5jdGlvbiBiaW5kKHNlbGYsIGZuKSB7CiAgdmFyIGN1cnJ5QXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyID8gc2xpY2VBcmdzKGFyZ3VtZW50cywgMikgOiBbXTsKICBpZiAoaXNGdW5jdGlvbihmbikgJiYgIShmbiBpbnN0YW5jZW9mIFJlZ0V4cCkpIHsKICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKSkKICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgIH0KICAgICAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgICAgICAgICA6IGZuLmNhbGwoc2VsZik7CiAgICAgICAgfTsKICB9IGVsc2UgewogICAgLy8gaW4gSUUsIG5hdGl2ZSBtZXRob2RzIGFyZSBub3QgZnVuY3Rpb25zIHNvIHRoZXkgY2Fubm90IGJlIGJvdW5kIChub3RlOiB0aGV5IGRvbid0IG5lZWQgdG8gYmUpCiAgICByZXR1cm4gZm47CiAgfQp9CgoKZnVuY3Rpb24gdG9Kc29uUmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogIHZhciB2YWwgPSB2YWx1ZTsKCiAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmIGtleS5jaGFyQXQoMCkgPT09ICckJykgewogICAgdmFsID0gdW5kZWZpbmVkOwogIH0gZWxzZSBpZiAoaXNXaW5kb3codmFsdWUpKSB7CiAgICB2YWwgPSAnJFdJTkRPVyc7CiAgfSBlbHNlIGlmICh2YWx1ZSAmJiAgZG9jdW1lbnQgPT09IHZhbHVlKSB7CiAgICB2YWwgPSAnJERPQ1VNRU5UJzsKICB9IGVsc2UgaWYgKGlzU2NvcGUodmFsdWUpKSB7CiAgICB2YWwgPSAnJFNDT1BFJzsKICB9CgogIHJldHVybiB2YWw7Cn0KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIudG9Kc29uCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFNlcmlhbGl6ZXMgaW5wdXQgaW50byBhIEpTT04tZm9ybWF0dGVkIHN0cmluZy4gUHJvcGVydGllcyB3aXRoIGxlYWRpbmcgJCBjaGFyYWN0ZXJzIHdpbGwgYmUKICogc3RyaXBwZWQgc2luY2UgYW5ndWxhciB1c2VzIHRoaXMgbm90YXRpb24gaW50ZXJuYWxseS4KICoKICogQHBhcmFtIHtPYmplY3R8QXJyYXl8RGF0ZXxzdHJpbmd8bnVtYmVyfSBvYmogSW5wdXQgdG8gYmUgc2VyaWFsaXplZCBpbnRvIEpTT04uCiAqIEBwYXJhbSB7Ym9vbGVhbj19IHByZXR0eSBJZiBzZXQgdG8gdHJ1ZSwgdGhlIEpTT04gb3V0cHV0IHdpbGwgY29udGFpbiBuZXdsaW5lcyBhbmQgd2hpdGVzcGFjZS4KICogQHJldHVybnMge3N0cmluZ3x1bmRlZmluZWR9IEpTT04taWZpZWQgc3RyaW5nIHJlcHJlc2VudGluZyBgb2JqYC4KICovCmZ1bmN0aW9uIHRvSnNvbihvYmosIHByZXR0eSkgewogIGlmICh0eXBlb2Ygb2JqID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHVuZGVmaW5lZDsKICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqLCB0b0pzb25SZXBsYWNlciwgcHJldHR5ID8gJyAgJyA6IG51bGwpOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmZyb21Kc29uCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERlc2VyaWFsaXplcyBhIEpTT04gc3RyaW5nLgogKgogKiBAcGFyYW0ge3N0cmluZ30ganNvbiBKU09OIHN0cmluZyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybnMge09iamVjdHxBcnJheXxzdHJpbmd8bnVtYmVyfSBEZXNlcmlhbGl6ZWQgdGhpbmd5LgogKi8KZnVuY3Rpb24gZnJvbUpzb24oanNvbikgewogIHJldHVybiBpc1N0cmluZyhqc29uKQogICAgICA/IEpTT04ucGFyc2UoanNvbikKICAgICAgOiBqc29uOwp9CgoKZnVuY3Rpb24gdG9Cb29sZWFuKHZhbHVlKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgdmFsdWUgPSB0cnVlOwogIH0gZWxzZSBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoICE9PSAwKSB7CiAgICB2YXIgdiA9IGxvd2VyY2FzZSgiIiArIHZhbHVlKTsKICAgIHZhbHVlID0gISh2ID09ICdmJyB8fCB2ID09ICcwJyB8fCB2ID09ICdmYWxzZScgfHwgdiA9PSAnbm8nIHx8IHYgPT0gJ24nIHx8IHYgPT0gJ1tdJyk7CiAgfSBlbHNlIHsKICAgIHZhbHVlID0gZmFsc2U7CiAgfQogIHJldHVybiB2YWx1ZTsKfQoKLyoqCiAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgZWxlbWVudC4KICovCmZ1bmN0aW9uIHN0YXJ0aW5nVGFnKGVsZW1lbnQpIHsKICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpLmNsb25lKCk7CiAgdHJ5IHsKICAgIC8vIHR1cm5zIG91dCBJRSBkb2VzIG5vdCBsZXQgeW91IHNldCAuaHRtbCgpIG9uIGVsZW1lbnRzIHdoaWNoCiAgICAvLyBhcmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBjaGlsZHJlbi4gU28gd2UganVzdCBpZ25vcmUgaXQuCiAgICBlbGVtZW50LmVtcHR5KCk7CiAgfSBjYXRjaChlKSB7fQogIC8vIEFzIFBlciBET00gU3RhbmRhcmRzCiAgdmFyIFRFWFRfTk9ERSA9IDM7CiAgdmFyIGVsZW1IdG1sID0ganFMaXRlKCc8ZGl2PicpLmFwcGVuZChlbGVtZW50KS5odG1sKCk7CiAgdHJ5IHsKICAgIHJldHVybiBlbGVtZW50WzBdLm5vZGVUeXBlID09PSBURVhUX05PREUgPyBsb3dlcmNhc2UoZWxlbUh0bWwpIDoKICAgICAgICBlbGVtSHRtbC4KICAgICAgICAgIG1hdGNoKC9eKDxbXj5dKz4pLylbMV0uCiAgICAgICAgICByZXBsYWNlKC9ePChbXHdcLV0rKS8sIGZ1bmN0aW9uKG1hdGNoLCBub2RlTmFtZSkgeyByZXR1cm4gJzwnICsgbG93ZXJjYXNlKG5vZGVOYW1lKTsgfSk7CiAgfSBjYXRjaChlKSB7CiAgICByZXR1cm4gbG93ZXJjYXNlKGVsZW1IdG1sKTsKICB9Cgp9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIFRyaWVzIHRvIGRlY29kZSB0aGUgVVJJIGNvbXBvbmVudCB3aXRob3V0IHRocm93aW5nIGFuIGV4Y2VwdGlvbi4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHN0ciB2YWx1ZSBwb3RlbnRpYWwgVVJJIGNvbXBvbmVudCB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBjYW4gYmUgZGVjb2RlZAogKiB3aXRoIHRoZSBkZWNvZGVVUklDb21wb25lbnQgZnVuY3Rpb24uCiAqLwpmdW5jdGlvbiB0cnlEZWNvZGVVUklDb21wb25lbnQodmFsdWUpIHsKICB0cnkgewogICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgfSBjYXRjaChlKSB7CiAgICAvLyBJZ25vcmUgYW55IGludmFsaWQgdXJpIGNvbXBvbmVudAogIH0KfQoKCi8qKgogKiBQYXJzZXMgYW4gZXNjYXBlZCB1cmwgcXVlcnkgc3RyaW5nIGludG8ga2V5LXZhbHVlIHBhaXJzLgogKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsYm9vbGVhbnxBcnJheT59CiAqLwpmdW5jdGlvbiBwYXJzZUtleVZhbHVlKC8qKnN0cmluZyova2V5VmFsdWUpIHsKICB2YXIgb2JqID0ge30sIGtleV92YWx1ZSwga2V5OwogIGZvckVhY2goKGtleVZhbHVlIHx8ICIiKS5zcGxpdCgnJicpLCBmdW5jdGlvbihrZXlWYWx1ZSkgewogICAgaWYgKCBrZXlWYWx1ZSApIHsKICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAga2V5ID0gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KGtleV92YWx1ZVswXSk7CiAgICAgIGlmICggaXNEZWZpbmVkKGtleSkgKSB7CiAgICAgICAgdmFyIHZhbCA9IGlzRGVmaW5lZChrZXlfdmFsdWVbMV0pID8gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KGtleV92YWx1ZVsxXSkgOiB0cnVlOwogICAgICAgIGlmICghb2JqW2tleV0pIHsKICAgICAgICAgIG9ialtrZXldID0gdmFsOwogICAgICAgIH0gZWxzZSBpZihpc0FycmF5KG9ialtrZXldKSkgewogICAgICAgICAgb2JqW2tleV0ucHVzaCh2YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvYmpba2V5XSA9IFtvYmpba2V5XSx2YWxdOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIHJldHVybiBvYmo7Cn0KCmZ1bmN0aW9uIHRvS2V5VmFsdWUob2JqKSB7CiAgdmFyIHBhcnRzID0gW107CiAgZm9yRWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICBmb3JFYWNoKHZhbHVlLCBmdW5jdGlvbihhcnJheVZhbHVlKSB7CiAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsKICAgICAgICAgICAgICAgICAgIChhcnJheVZhbHVlID09PSB0cnVlID8gJycgOiAnPScgKyBlbmNvZGVVcmlRdWVyeShhcnJheVZhbHVlLCB0cnVlKSkpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSwgdHJ1ZSkgKwogICAgICAgICAgICAgICAodmFsdWUgPT09IHRydWUgPyAnJyA6ICc9JyArIGVuY29kZVVyaVF1ZXJ5KHZhbHVlLCB0cnVlKSkpOwogICAgfQogIH0pOwogIHJldHVybiBwYXJ0cy5sZW5ndGggPyBwYXJ0cy5qb2luKCcmJykgOiAnJzsKfQoKCi8qKgogKiBXZSBuZWVkIG91ciBjdXN0b20gbWV0aG9kIGJlY2F1c2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ2dyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogKiBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMzOTg2LnR4dCB3aXRoIHJlZ2FyZHMgdG8gdGhlIGNoYXJhY3RlciBzZXQgKHBjaGFyKSBhbGxvd2VkIGluIHBhdGgKICogc2VnbWVudHM6CiAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICogICAgcGNoYXIgICAgICAgICA9IHVucmVzZXJ2ZWQgLyBwY3QtZW5jb2RlZCAvIHN1Yi1kZWxpbXMgLyAiOiIgLyAiQCIKICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAqICAgIHN1Yi1kZWxpbXMgICAgPSAiISIgLyAiJCIgLyAiJiIgLyAiJyIgLyAiKCIgLyAiKSIKICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogKi8KZnVuY3Rpb24gZW5jb2RlVXJpU2VnbWVudCh2YWwpIHsKICByZXR1cm4gZW5jb2RlVXJpUXVlcnkodmFsLCB0cnVlKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyNi9naSwgJyYnKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUzRC9naSwgJz0nKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyQi9naSwgJysnKTsKfQoKCi8qKgogKiBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCBmb3IgZW5jb2RpbmcgKmtleSogb3IgKnZhbHVlKiBwYXJ0cyBvZiBxdWVyeSBjb21wb25lbnQuIFdlIG5lZWQgYSBjdXN0b20KICogbWV0aG9kIGJlY2F1c2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ2dyZXNzaXZlIGFuZCBlbmNvZGVzIHN0dWZmIHRoYXQgZG9lc24ndCBoYXZlIHRvIGJlCiAqIGVuY29kZWQgcGVyIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODY6CiAqICAgIHF1ZXJ5ICAgICAgID0gKiggcGNoYXIgLyAiLyIgLyAiPyIgKQogKiAgICBwY2hhciAgICAgICAgID0gdW5yZXNlcnZlZCAvIHBjdC1lbmNvZGVkIC8gc3ViLWRlbGltcyAvICI6IiAvICJAIgogKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICogICAgc3ViLWRlbGltcyAgICA9ICIhIiAvICIkIiAvICImIiAvICInIiAvICIoIiAvICIpIgogKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAqLwpmdW5jdGlvbiBlbmNvZGVVcmlRdWVyeSh2YWwsIHBjdEVuY29kZVNwYWNlcykgewogIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQodmFsKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyU0MC9naSwgJ0AnKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUzQS9naSwgJzonKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyNC9nLCAnJCcpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTJDL2dpLCAnLCcpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTIwL2csIChwY3RFbmNvZGVTcGFjZXMgPyAnJTIwJyA6ICcrJykpOwp9CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdBcHAKICogQG1vZHVsZSBuZwogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHthbmd1bGFyLk1vZHVsZX0gbmdBcHAgYW4gb3B0aW9uYWwgYXBwbGljYXRpb24KICogICB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlfSBuYW1lIHRvIGxvYWQuCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBVc2UgdGhpcyBkaXJlY3RpdmUgdG8gKiphdXRvLWJvb3RzdHJhcCoqIGFuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbi4gVGhlIGBuZ0FwcGAgZGlyZWN0aXZlCiAqIGRlc2lnbmF0ZXMgdGhlICoqcm9vdCBlbGVtZW50Kiogb2YgdGhlIGFwcGxpY2F0aW9uIGFuZCBpcyB0eXBpY2FsbHkgcGxhY2VkIG5lYXIgdGhlIHJvb3QgZWxlbWVudAogKiBvZiB0aGUgcGFnZSAtIGUuZy4gb24gdGhlIGA8Ym9keT5gIG9yIGA8aHRtbD5gIHRhZ3MuCiAqCiAqIE9ubHkgb25lIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbiBjYW4gYmUgYXV0by1ib290c3RyYXBwZWQgcGVyIEhUTUwgZG9jdW1lbnQuIFRoZSBmaXJzdCBgbmdBcHBgCiAqIGZvdW5kIGluIHRoZSBkb2N1bWVudCB3aWxsIGJlIHVzZWQgdG8gZGVmaW5lIHRoZSByb290IGVsZW1lbnQgdG8gYXV0by1ib290c3RyYXAgYXMgYW4KICogYXBwbGljYXRpb24uIFRvIHJ1biBtdWx0aXBsZSBhcHBsaWNhdGlvbnMgaW4gYW4gSFRNTCBkb2N1bWVudCB5b3UgbXVzdCBtYW51YWxseSBib290c3RyYXAgdGhlbSB1c2luZwogKiB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9IGluc3RlYWQuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbnMgY2Fubm90IGJlIG5lc3RlZCB3aXRoaW4gZWFjaCBvdGhlci4KICoKICogWW91IGNhbiBzcGVjaWZ5IGFuICoqQW5ndWxhckpTIG1vZHVsZSoqIHRvIGJlIHVzZWQgYXMgdGhlIHJvb3QgbW9kdWxlIGZvciB0aGUgYXBwbGljYXRpb24uICBUaGlzCiAqIG1vZHVsZSB3aWxsIGJlIGxvYWRlZCBpbnRvIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3J9IHdoZW4gdGhlIGFwcGxpY2F0aW9uIGlzIGJvb3RzdHJhcHBlZCBhbmQKICogc2hvdWxkIGNvbnRhaW4gdGhlIGFwcGxpY2F0aW9uIGNvZGUgbmVlZGVkIG9yIGhhdmUgZGVwZW5kZW5jaWVzIG9uIG90aGVyIG1vZHVsZXMgdGhhdCB3aWxsCiAqIGNvbnRhaW4gdGhlIGNvZGUuIFNlZSB7QGxpbmsgYW5ndWxhci5tb2R1bGV9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogKgogKiBJbiB0aGUgZXhhbXBsZSBiZWxvdyBpZiB0aGUgYG5nQXBwYCBkaXJlY3RpdmUgd2VyZSBub3QgcGxhY2VkIG9uIHRoZSBgaHRtbGAgZWxlbWVudCB0aGVuIHRoZQogKiBkb2N1bWVudCB3b3VsZCBub3QgYmUgY29tcGlsZWQsIHRoZSBgQXBwQ29udHJvbGxlcmAgd291bGQgbm90IGJlIGluc3RhbnRpYXRlZCBhbmQgdGhlIGB7eyBhK2IgfX1gCiAqIHdvdWxkIG5vdCBiZSByZXNvbHZlZCB0byBgM2AuCiAqCiAqIGBuZ0FwcGAgaXMgdGhlIGVhc2llc3QsIGFuZCBtb3N0IGNvbW1vbiwgd2F5IHRvIGJvb3RzdHJhcCBhbiBhcHBsaWNhdGlvbi4KICoKIDxleGFtcGxlIG1vZHVsZT0ibmdBcHBEZW1vIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0ibmdBcHBEZW1vQ29udHJvbGxlciI+CiAgICAgSSBjYW4gYWRkOiB7e2F9fSArIHt7Yn19ID0gIHt7IGErYiB9fQogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBhbmd1bGFyLm1vZHVsZSgnbmdBcHBEZW1vJywgW10pLmNvbnRyb2xsZXIoJ25nQXBwRGVtb0NvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAkc2NvcGUuYSA9IDE7CiAgICAgJHNjb3BlLmIgPSAyOwogICB9KTsKICAgPC9maWxlPgogPC9leGFtcGxlPgogKgogKi8KZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdLAogICAgICBhcHBFbGVtZW50LAogICAgICBtb2R1bGUsCiAgICAgIG5hbWVzID0gWyduZzphcHAnLCAnbmctYXBwJywgJ3gtbmctYXBwJywgJ2RhdGEtbmctYXBwJ10sCiAgICAgIE5HX0FQUF9DTEFTU19SRUdFWFAgPSAvXHNuZ1s6XC1dYXBwKDpccyooW1x3XGRfXSspOz8pP1xzLzsKCiAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgIGVsZW1lbnQgJiYgZWxlbWVudHMucHVzaChlbGVtZW50KTsKICB9CgogIGZvckVhY2gobmFtZXMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgIG5hbWVzW25hbWVdID0gdHJ1ZTsKICAgIGFwcGVuZChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChuYW1lKSk7CiAgICBuYW1lID0gbmFtZS5yZXBsYWNlKCc6JywgJ1xcOicpOwogICAgaWYgKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCkgewogICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLicgKyBuYW1lKSwgYXBwZW5kKTsKICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgbmFtZSArICdcXDonKSwgYXBwZW5kKTsKICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1snICsgbmFtZSArICddJyksIGFwcGVuZCk7CiAgICB9CiAgfSk7CgogIGZvckVhY2goZWxlbWVudHMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGlmICghYXBwRWxlbWVudCkgewogICAgICB2YXIgY2xhc3NOYW1lID0gJyAnICsgZWxlbWVudC5jbGFzc05hbWUgKyAnICc7CiAgICAgIHZhciBtYXRjaCA9IE5HX0FQUF9DTEFTU19SRUdFWFAuZXhlYyhjbGFzc05hbWUpOwogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICBtb2R1bGUgPSAobWF0Y2hbMl0gfHwgJycpLnJlcGxhY2UoL1xzKy9nLCAnLCcpOwogICAgICB9IGVsc2UgewogICAgICAgIGZvckVhY2goZWxlbWVudC5hdHRyaWJ1dGVzLCBmdW5jdGlvbihhdHRyKSB7CiAgICAgICAgICBpZiAoIWFwcEVsZW1lbnQgJiYgbmFtZXNbYXR0ci5uYW1lXSkgewogICAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgbW9kdWxlID0gYXR0ci52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0pOwogIGlmIChhcHBFbGVtZW50KSB7CiAgICBib290c3RyYXAoYXBwRWxlbWVudCwgbW9kdWxlID8gW21vZHVsZV0gOiBbXSk7CiAgfQp9CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAqIEBtb2R1bGUgbmcKICogQGRlc2NyaXB0aW9uCiAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAqCiAqIFNlZToge0BsaW5rIGd1aWRlL2Jvb3RzdHJhcCBCb290c3RyYXB9CiAqCiAqIE5vdGUgdGhhdCBuZ1NjZW5hcmlvLWJhc2VkIGVuZC10by1lbmQgdGVzdHMgY2Fubm90IHVzZSB0aGlzIGZ1bmN0aW9uIHRvIGJvb3RzdHJhcCBtYW51YWxseS4KICogVGhleSBtdXN0IHVzZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQXBwIG5nQXBwfS4KICoKICogQW5ndWxhciB3aWxsIGRldGVjdCBpZiBpdCBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgYnJvd3NlciBtb3JlIHRoYW4gb25jZSBhbmQgb25seSBhbGxvdyB0aGUKICogZmlyc3QgbG9hZGVkIHNjcmlwdCB0byBiZSBib290c3RyYXBwZWQgYW5kIHdpbGwgcmVwb3J0IGEgd2FybmluZyB0byB0aGUgYnJvd3NlciBjb25zb2xlIGZvcgogKiBlYWNoIG9mIHRoZSBzdWJzZXF1ZW50IHNjcmlwdHMuICAgVGhpcyBwcmV2ZW50cyBzdHJhbmdlIHJlc3VsdHMgaW4gYXBwbGljYXRpb25zLCB3aGVyZSBvdGhlcndpc2UKICogbXVsdGlwbGUgaW5zdGFuY2VzIG9mIEFuZ3VsYXIgdHJ5IHRvIHdvcmsgb24gdGhlIERPTS4KICoKICogPGV4YW1wbGUgbmFtZT0ibXVsdGktYm9vdHN0cmFwIiBtb2R1bGU9Im11bHRpLWJvb3RzdHJhcCI+CiAqIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogKiA8c2NyaXB0IHNyYz0iLi4vLi4vLi4vYW5ndWxhci5qcyI+PC9zY3JpcHQ+CiAqIDxkaXYgbmctY29udHJvbGxlcj0iQnJva2VuVGFibGUiPgogKiAgIDx0YWJsZT4KICogICA8dHI+CiAqICAgICA8dGggbmctcmVwZWF0PSJoZWFkaW5nIGluIGhlYWRpbmdzIj57e2hlYWRpbmd9fTwvdGg+CiAqICAgPC90cj4KICogICA8dHIgbmctcmVwZWF0PSJmaWxsaW5nIGluIGZpbGxpbmdzIj4KICogICAgIDx0ZCBuZy1yZXBlYXQ9ImZpbGwgaW4gZmlsbGluZyI+e3tmaWxsfX08L3RkPgogKiAgIDwvdHI+CiAqIDwvdGFibGU+CiAqIDwvZGl2PgogKiA8L2ZpbGU+CiAqIDxmaWxlIG5hbWU9ImNvbnRyb2xsZXIuanMiPgogKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ211bHRpLWJvb3RzdHJhcCcsIFtdKQogKgogKiAuY29udHJvbGxlcignQnJva2VuVGFibGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICogICAgICRzY29wZS5oZWFkaW5ncyA9IFsnT25lJywgJ1R3bycsICdUaHJlZSddOwogKiAgICAgJHNjb3BlLmZpbGxpbmdzID0gW1sxLCAyLCAzXSwgWydBJywgJ0InLCAnQyddLCBbNywgOCwgOV1dOwogKiB9KTsKICogPC9maWxlPgogKiA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogaXQoJ3Nob3VsZCBvbmx5IGluc2VydCBvbmUgdGFibGUgY2VsbCBmb3IgZWFjaCBpdGVtIGluICRzY29wZS5maWxsaW5ncycsIGZ1bmN0aW9uKCkgewogKiAgZXhwZWN0KGVsZW1lbnQuYWxsKGJ5LmNzcygndGQnKSkuY291bnQoKSkKICogICAgICAudG9CZSg5KTsKICogfSk7CiAqIDwvZmlsZT4KICogPC9leGFtcGxlPgogKgogKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICogQHBhcmFtIHtBcnJheTxTdHJpbmd8RnVuY3Rpb258QXJyYXk+PX0gbW9kdWxlcyBhbiBhcnJheSBvZiBtb2R1bGVzIHRvIGxvYWQgaW50byB0aGUgYXBwbGljYXRpb24uCiAqICAgICBFYWNoIGl0ZW0gaW4gdGhlIGFycmF5IHNob3VsZCBiZSB0aGUgbmFtZSBvZiBhIHByZWRlZmluZWQgbW9kdWxlIG9yIGEgKERJIGFubm90YXRlZCkKICogICAgIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBpbnZva2VkIGJ5IHRoZSBpbmplY3RvciBhcyBhIHJ1biBibG9jay4KICogICAgIFNlZToge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9CiAqIEByZXR1cm5zIHthdXRvLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAqLwpmdW5jdGlvbiBib290c3RyYXAoZWxlbWVudCwgbW9kdWxlcykgewogIHZhciBkb0Jvb3RzdHJhcCA9IGZ1bmN0aW9uKCkgewogICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKCiAgICBpZiAoZWxlbWVudC5pbmplY3RvcigpKSB7CiAgICAgIHZhciB0YWcgPSAoZWxlbWVudFswXSA9PT0gZG9jdW1lbnQpID8gJ2RvY3VtZW50JyA6IHN0YXJ0aW5nVGFnKGVsZW1lbnQpOwogICAgICB0aHJvdyBuZ01pbkVycignYnRzdHJwZCcsICJBcHAgQWxyZWFkeSBCb290c3RyYXBwZWQgd2l0aCB0aGlzIEVsZW1lbnQgJ3swfSciLCB0YWcpOwogICAgfQoKICAgIG1vZHVsZXMgPSBtb2R1bGVzIHx8IFtdOwogICAgbW9kdWxlcy51bnNoaWZ0KFsnJHByb3ZpZGUnLCBmdW5jdGlvbigkcHJvdmlkZSkgewogICAgICAkcHJvdmlkZS52YWx1ZSgnJHJvb3RFbGVtZW50JywgZWxlbWVudCk7CiAgICB9XSk7CiAgICBtb2R1bGVzLnVuc2hpZnQoJ25nJyk7CiAgICB2YXIgaW5qZWN0b3IgPSBjcmVhdGVJbmplY3Rvcihtb2R1bGVzKTsKICAgIGluamVjdG9yLmludm9rZShbJyRyb290U2NvcGUnLCAnJHJvb3RFbGVtZW50JywgJyRjb21waWxlJywgJyRpbmplY3RvcicsICckYW5pbWF0ZScsCiAgICAgICBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgY29tcGlsZSwgaW5qZWN0b3IsIGFuaW1hdGUpIHsKICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50LmRhdGEoJyRpbmplY3RvcicsIGluamVjdG9yKTsKICAgICAgICAgIGNvbXBpbGUoZWxlbWVudCkoc2NvcGUpOwogICAgICAgIH0pOwogICAgICB9XQogICAgKTsKICAgIHJldHVybiBpbmplY3RvcjsKICB9OwoKICB2YXIgTkdfREVGRVJfQk9PVFNUUkFQID0gL15OR19ERUZFUl9CT09UU1RSQVAhLzsKCiAgaWYgKHdpbmRvdyAmJiAhTkdfREVGRVJfQk9PVFNUUkFQLnRlc3Qod2luZG93Lm5hbWUpKSB7CiAgICByZXR1cm4gZG9Cb290c3RyYXAoKTsKICB9CgogIHdpbmRvdy5uYW1lID0gd2luZG93Lm5hbWUucmVwbGFjZShOR19ERUZFUl9CT09UU1RSQVAsICcnKTsKICBhbmd1bGFyLnJlc3VtZUJvb3RzdHJhcCA9IGZ1bmN0aW9uKGV4dHJhTW9kdWxlcykgewogICAgZm9yRWFjaChleHRyYU1vZHVsZXMsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICBtb2R1bGVzLnB1c2gobW9kdWxlKTsKICAgIH0pOwogICAgZG9Cb290c3RyYXAoKTsKICB9Owp9Cgp2YXIgU05BS0VfQ0FTRV9SRUdFWFAgPSAvW0EtWl0vZzsKZnVuY3Rpb24gc25ha2VfY2FzZShuYW1lLCBzZXBhcmF0b3IpIHsKICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJ18nOwogIHJldHVybiBuYW1lLnJlcGxhY2UoU05BS0VfQ0FTRV9SRUdFWFAsIGZ1bmN0aW9uKGxldHRlciwgcG9zKSB7CiAgICByZXR1cm4gKHBvcyA/IHNlcGFyYXRvciA6ICcnKSArIGxldHRlci50b0xvd2VyQ2FzZSgpOwogIH0pOwp9CgpmdW5jdGlvbiBiaW5kSlF1ZXJ5KCkgewogIC8vIGJpbmQgdG8galF1ZXJ5IGlmIHByZXNlbnQ7CiAgalF1ZXJ5ID0gd2luZG93LmpRdWVyeTsKICAvLyBVc2UgalF1ZXJ5IGlmIGl0IGV4aXN0cyB3aXRoIHByb3BlciBmdW5jdGlvbmFsaXR5LCBvdGhlcndpc2UgZGVmYXVsdCB0byB1cy4KICAvLyBBbmd1bGFyIDEuMisgcmVxdWlyZXMgalF1ZXJ5IDEuNy4xKyBmb3Igb24oKS9vZmYoKSBzdXBwb3J0LgogIGlmIChqUXVlcnkgJiYgalF1ZXJ5LmZuLm9uKSB7CiAgICBqcUxpdGUgPSBqUXVlcnk7CiAgICBleHRlbmQoalF1ZXJ5LmZuLCB7CiAgICAgIHNjb3BlOiBKUUxpdGVQcm90b3R5cGUuc2NvcGUsCiAgICAgIGlzb2xhdGVTY29wZTogSlFMaXRlUHJvdG90eXBlLmlzb2xhdGVTY29wZSwKICAgICAgY29udHJvbGxlcjogSlFMaXRlUHJvdG90eXBlLmNvbnRyb2xsZXIsCiAgICAgIGluamVjdG9yOiBKUUxpdGVQcm90b3R5cGUuaW5qZWN0b3IsCiAgICAgIGluaGVyaXRlZERhdGE6IEpRTGl0ZVByb3RvdHlwZS5pbmhlcml0ZWREYXRhCiAgICB9KTsKICAgIC8vIE1ldGhvZCBzaWduYXR1cmU6CiAgICAvLyAgICAganFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzLCBmaWx0ZXJFbGVtcywgZ2V0dGVySWZOb0FyZ3VtZW50cykKICAgIGpxTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdyZW1vdmUnLCB0cnVlLCB0cnVlLCBmYWxzZSk7CiAgICBqcUxpdGVQYXRjaEpRdWVyeVJlbW92ZSgnZW1wdHknLCBmYWxzZSwgZmFsc2UsIGZhbHNlKTsKICAgIGpxTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdodG1sJywgZmFsc2UsIGZhbHNlLCB0cnVlKTsKICB9IGVsc2UgewogICAganFMaXRlID0gSlFMaXRlOwogIH0KICBhbmd1bGFyLmVsZW1lbnQgPSBqcUxpdGU7Cn0KCi8qKgogKiB0aHJvdyBlcnJvciBpZiB0aGUgYXJndW1lbnQgaXMgZmFsc3kuCiAqLwpmdW5jdGlvbiBhc3NlcnRBcmcoYXJnLCBuYW1lLCByZWFzb24pIHsKICBpZiAoIWFyZykgewogICAgdGhyb3cgbmdNaW5FcnIoJ2FyZXEnLCAiQXJndW1lbnQgJ3swfScgaXMgezF9IiwgKG5hbWUgfHwgJz8nKSwgKHJlYXNvbiB8fCAicmVxdWlyZWQiKSk7CiAgfQogIHJldHVybiBhcmc7Cn0KCmZ1bmN0aW9uIGFzc2VydEFyZ0ZuKGFyZywgbmFtZSwgYWNjZXB0QXJyYXlBbm5vdGF0aW9uKSB7CiAgaWYgKGFjY2VwdEFycmF5QW5ub3RhdGlvbiAmJiBpc0FycmF5KGFyZykpIHsKICAgICAgYXJnID0gYXJnW2FyZy5sZW5ndGggLSAxXTsKICB9CgogIGFzc2VydEFyZyhpc0Z1bmN0aW9uKGFyZyksIG5hbWUsICdub3QgYSBmdW5jdGlvbiwgZ290ICcgKwogICAgICAoYXJnICYmIHR5cGVvZiBhcmcgPT0gJ29iamVjdCcgPyBhcmcuY29uc3RydWN0b3IubmFtZSB8fCAnT2JqZWN0JyA6IHR5cGVvZiBhcmcpKTsKICByZXR1cm4gYXJnOwp9CgovKioKICogdGhyb3cgZXJyb3IgaWYgdGhlIG5hbWUgZ2l2ZW4gaXMgaGFzT3duUHJvcGVydHkKICogQHBhcmFtICB7U3RyaW5nfSBuYW1lICAgIHRoZSBuYW1lIHRvIHRlc3QKICogQHBhcmFtICB7U3RyaW5nfSBjb250ZXh0IHRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBuYW1lIGlzIHVzZWQsIHN1Y2ggYXMgbW9kdWxlIG9yIGRpcmVjdGl2ZQogKi8KZnVuY3Rpb24gYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgY29udGV4dCkgewogIGlmIChuYW1lID09PSAnaGFzT3duUHJvcGVydHknKSB7CiAgICB0aHJvdyBuZ01pbkVycignYmFkbmFtZScsICJoYXNPd25Qcm9wZXJ0eSBpcyBub3QgYSB2YWxpZCB7MH0gbmFtZSIsIGNvbnRleHQpOwogIH0KfQoKLyoqCiAqIFJldHVybiB0aGUgdmFsdWUgYWNjZXNzaWJsZSBmcm9tIHRoZSBvYmplY3QgYnkgcGF0aC4gQW55IHVuZGVmaW5lZCB0cmF2ZXJzYWxzIGFyZSBpZ25vcmVkCiAqIEBwYXJhbSB7T2JqZWN0fSBvYmogc3RhcnRpbmcgb2JqZWN0CiAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIHBhdGggdG8gdHJhdmVyc2UKICogQHBhcmFtIHtib29sZWFufSBbYmluZEZuVG9TY29wZT10cnVlXQogKiBAcmV0dXJucyB7T2JqZWN0fSB2YWx1ZSBhcyBhY2Nlc3NpYmxlIGJ5IHBhdGgKICovCi8vVE9ETyhtaXNrbyk6IHRoaXMgZnVuY3Rpb24gbmVlZHMgdG8gYmUgcmVtb3ZlZApmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgaWYgKCFwYXRoKSByZXR1cm4gb2JqOwogIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogIHZhciBrZXk7CiAgdmFyIGxhc3RJbnN0YW5jZSA9IG9iajsKICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgIGtleSA9IGtleXNbaV07CiAgICBpZiAob2JqKSB7CiAgICAgIG9iaiA9IChsYXN0SW5zdGFuY2UgPSBvYmopW2tleV07CiAgICB9CiAgfQogIGlmICghYmluZEZuVG9TY29wZSAmJiBpc0Z1bmN0aW9uKG9iaikpIHsKICAgIHJldHVybiBiaW5kKGxhc3RJbnN0YW5jZSwgb2JqKTsKICB9CiAgcmV0dXJuIG9iajsKfQoKLyoqCiAqIFJldHVybiB0aGUgRE9NIHNpYmxpbmdzIGJldHdlZW4gdGhlIGZpcnN0IGFuZCBsYXN0IG5vZGUgaW4gdGhlIGdpdmVuIGFycmF5LgogKiBAcGFyYW0ge0FycmF5fSBhcnJheSBsaWtlIG9iamVjdAogKiBAcmV0dXJucyB7RE9NRWxlbWVudH0gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGVsZW1lbnRzCiAqLwpmdW5jdGlvbiBnZXRCbG9ja0VsZW1lbnRzKG5vZGVzKSB7CiAgdmFyIHN0YXJ0Tm9kZSA9IG5vZGVzWzBdLAogICAgICBlbmROb2RlID0gbm9kZXNbbm9kZXMubGVuZ3RoIC0gMV07CiAgaWYgKHN0YXJ0Tm9kZSA9PT0gZW5kTm9kZSkgewogICAgcmV0dXJuIGpxTGl0ZShzdGFydE5vZGUpOwogIH0KCiAgdmFyIGVsZW1lbnQgPSBzdGFydE5vZGU7CiAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdOwoKICBkbyB7CiAgICBlbGVtZW50ID0gZWxlbWVudC5uZXh0U2libGluZzsKICAgIGlmICghZWxlbWVudCkgYnJlYWs7CiAgICBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogIH0gd2hpbGUgKGVsZW1lbnQgIT09IGVuZE5vZGUpOwoKICByZXR1cm4ganFMaXRlKGVsZW1lbnRzKTsKfQoKLyoqCiAqIEBuZ2RvYyB0eXBlCiAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlCiAqIEBtb2R1bGUgbmcKICogQGRlc2NyaXB0aW9uCiAqCiAqIEludGVyZmFjZSBmb3IgY29uZmlndXJpbmcgYW5ndWxhciB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30uCiAqLwoKZnVuY3Rpb24gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KSB7CgogIHZhciAkaW5qZWN0b3JNaW5FcnIgPSBtaW5FcnIoJyRpbmplY3RvcicpOwogIHZhciBuZ01pbkVyciA9IG1pbkVycignbmcnKTsKCiAgZnVuY3Rpb24gZW5zdXJlKG9iaiwgbmFtZSwgZmFjdG9yeSkgewogICAgcmV0dXJuIG9ialtuYW1lXSB8fCAob2JqW25hbWVdID0gZmFjdG9yeSgpKTsKICB9CgogIHZhciBhbmd1bGFyID0gZW5zdXJlKHdpbmRvdywgJ2FuZ3VsYXInLCBPYmplY3QpOwoKICAvLyBXZSBuZWVkIHRvIGV4cG9zZSBgYW5ndWxhci4kJG1pbkVycmAgdG8gbW9kdWxlcyBzdWNoIGFzIGBuZ1Jlc291cmNlYCB0aGF0IHJlZmVyZW5jZSBpdCBkdXJpbmcgYm9vdHN0cmFwCiAgYW5ndWxhci4kJG1pbkVyciA9IGFuZ3VsYXIuJCRtaW5FcnIgfHwgbWluRXJyOwoKICByZXR1cm4gZW5zdXJlKGFuZ3VsYXIsICdtb2R1bGUnLCBmdW5jdGlvbigpIHsKICAgIC8qKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsIGFuZ3VsYXIuTW9kdWxlPn0gKi8KICAgIHZhciBtb2R1bGVzID0ge307CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIubW9kdWxlCiAgICAgKiBAbW9kdWxlIG5nCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBUaGUgYGFuZ3VsYXIubW9kdWxlYCBpcyBhIGdsb2JhbCBwbGFjZSBmb3IgY3JlYXRpbmcsIHJlZ2lzdGVyaW5nIGFuZCByZXRyaWV2aW5nIEFuZ3VsYXIKICAgICAqIG1vZHVsZXMuCiAgICAgKiBBbGwgbW9kdWxlcyAoYW5ndWxhciBjb3JlIG9yIDNyZCBwYXJ0eSkgdGhhdCBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFuIGFwcGxpY2F0aW9uIG11c3QgYmUKICAgICAqIHJlZ2lzdGVyZWQgdXNpbmcgdGhpcyBtZWNoYW5pc20uCiAgICAgKgogICAgICogV2hlbiBwYXNzZWQgdHdvIG9yIG1vcmUgYXJndW1lbnRzLCBhIG5ldyBtb2R1bGUgaXMgY3JlYXRlZC4gIElmIHBhc3NlZCBvbmx5IG9uZSBhcmd1bWVudCwgYW4KICAgICAqIGV4aXN0aW5nIG1vZHVsZSAodGhlIG5hbWUgcGFzc2VkIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byBgbW9kdWxlYCkgaXMgcmV0cmlldmVkLgogICAgICoKICAgICAqCiAgICAgKiAjIE1vZHVsZQogICAgICoKICAgICAqIEEgbW9kdWxlIGlzIGEgY29sbGVjdGlvbiBvZiBzZXJ2aWNlcywgZGlyZWN0aXZlcywgZmlsdGVycywgYW5kIGNvbmZpZ3VyYXRpb24gaW5mb3JtYXRpb24uCiAgICAgKiBgYW5ndWxhci5tb2R1bGVgIGlzIHVzZWQgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAqCiAgICAgKiBgYGBqcwogICAgICogLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZQogICAgICogdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ215TW9kdWxlJywgW10pOwogICAgICoKICAgICAqIC8vIHJlZ2lzdGVyIGEgbmV3IHNlcnZpY2UKICAgICAqIG15TW9kdWxlLnZhbHVlKCdhcHBOYW1lJywgJ015Q29vbEFwcCcpOwogICAgICoKICAgICAqIC8vIGNvbmZpZ3VyZSBleGlzdGluZyBzZXJ2aWNlcyBpbnNpZGUgaW5pdGlhbGl6YXRpb24gYmxvY2tzLgogICAgICogbXlNb2R1bGUuY29uZmlnKFsnJGxvY2F0aW9uUHJvdmlkZXInLCBmdW5jdGlvbigkbG9jYXRpb25Qcm92aWRlcikgewogICAgICogICAvLyBDb25maWd1cmUgZXhpc3RpbmcgcHJvdmlkZXJzCiAgICAgKiAgICRsb2NhdGlvblByb3ZpZGVyLmhhc2hQcmVmaXgoJyEnKTsKICAgICAqIH1dKTsKICAgICAqIGBgYAogICAgICoKICAgICAqIFRoZW4geW91IGNhbiBjcmVhdGUgYW4gaW5qZWN0b3IgYW5kIGxvYWQgeW91ciBtb2R1bGVzIGxpa2UgdGhpczoKICAgICAqCiAgICAgKiBgYGBqcwogICAgICogdmFyIGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJywgJ215TW9kdWxlJ10pCiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBIb3dldmVyIGl0J3MgbW9yZSBsaWtlbHkgdGhhdCB5b3UnbGwganVzdCB1c2UKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9IG9yCiAgICAgKiB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9IHRvIHNpbXBsaWZ5IHRoaXMgcHJvY2VzcyBmb3IgeW91LgogICAgICoKICAgICAqIEBwYXJhbSB7IXN0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlIHRvIGNyZWF0ZSBvciByZXRyaWV2ZS4KPDw8PDwqIEBwYXJhbSB7IUFycmF5LjxzdHJpbmc+PX0gcmVxdWlyZXMgSWYgc3BlY2lmaWVkIHRoZW4gbmV3IG1vZHVsZSBpcyBiZWluZyBjcmVhdGVkLiBJZgo+Pj4+PiogICAgICAgIHVuc3BlY2lmaWVkIHRoZW4gdGhlIG1vZHVsZSBpcyBiZWluZyByZXRyaWV2ZWQgZm9yIGZ1cnRoZXIgY29uZmlndXJhdGlvbi4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSBtb2R1bGUuIFNhbWUgYXMKICAgICAqICAgICAgICB7QGxpbmsgYW5ndWxhci5Nb2R1bGUjY29uZmlnIE1vZHVsZSNjb25maWcoKX0uCiAgICAgKiBAcmV0dXJucyB7bW9kdWxlfSBuZXcgbW9kdWxlIHdpdGggdGhlIHtAbGluayBhbmd1bGFyLk1vZHVsZX0gYXBpLgogICAgICovCiAgICByZXR1cm4gZnVuY3Rpb24gbW9kdWxlKG5hbWUsIHJlcXVpcmVzLCBjb25maWdGbikgewogICAgICB2YXIgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkgPSBmdW5jdGlvbihuYW1lLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKG5hbWUgPT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgICAgICAgIHRocm93IG5nTWluRXJyKCdiYWRuYW1lJywgJ2hhc093blByb3BlcnR5IGlzIG5vdCBhIHZhbGlkIHswfSBuYW1lJywgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ21vZHVsZScpOwogICAgICBpZiAocmVxdWlyZXMgJiYgbW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIG1vZHVsZXNbbmFtZV0gPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBlbnN1cmUobW9kdWxlcywgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFyZXF1aXJlcykgewogICAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCdub21vZCcsICJNb2R1bGUgJ3swfScgaXMgbm90IGF2YWlsYWJsZSEgWW91IGVpdGhlciBtaXNzcGVsbGVkICIgKwogICAgICAgICAgICAgInRoZSBtb2R1bGUgbmFtZSBvciBmb3Jnb3QgdG8gbG9hZCBpdC4gSWYgcmVnaXN0ZXJpbmcgYSBtb2R1bGUgZW5zdXJlIHRoYXQgeW91ICIgKwogICAgICAgICAgICAgInNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LiIsIG5hbWUpOwogICAgICAgIH0KCiAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEFycmF5LjwqPj59ICovCiAgICAgICAgdmFyIGludm9rZVF1ZXVlID0gW107CgogICAgICAgIC8qKiBAdHlwZSB7IUFycmF5LjxGdW5jdGlvbj59ICovCiAgICAgICAgdmFyIHJ1bkJsb2NrcyA9IFtdOwoKICAgICAgICB2YXIgY29uZmlnID0gaW52b2tlTGF0ZXIoJyRpbmplY3RvcicsICdpbnZva2UnKTsKCiAgICAgICAgLyoqIEB0eXBlIHthbmd1bGFyLk1vZHVsZX0gKi8KICAgICAgICB2YXIgbW9kdWxlSW5zdGFuY2UgPSB7CiAgICAgICAgICAvLyBQcml2YXRlIHN0YXRlCiAgICAgICAgICBfaW52b2tlUXVldWU6IGludm9rZVF1ZXVlLAogICAgICAgICAgX3J1bkJsb2NrczogcnVuQmxvY2tzLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNyZXF1aXJlcwogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBMaXN0IG9mIG1vZHVsZSBuYW1lcyB3aGljaCBtdXN0IGJlIGxvYWRlZCBiZWZvcmUgdGhpcyBtb2R1bGUuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIEhvbGRzIHRoZSBsaXN0IG9mIG1vZHVsZXMgd2hpY2ggdGhlIGluamVjdG9yIHdpbGwgbG9hZCBiZWZvcmUgdGhlIGN1cnJlbnQgbW9kdWxlIGlzCiAgICAgICAgICAgKiBsb2FkZWQuCiAgICAgICAgICAgKi8KICAgICAgICAgIHJlcXVpcmVzOiByZXF1aXJlcywKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjbmFtZQogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gTmFtZSBvZiB0aGUgbW9kdWxlLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKi8KICAgICAgICAgIG5hbWU6IG5hbWUsCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcHJvdmlkZXIKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJUeXBlIENvbnN0cnVjdGlvbiBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZQogICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2UuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNwcm92aWRlciAkcHJvdmlkZS5wcm92aWRlcigpfS4KICAgICAgICAgICAqLwogICAgICAgICAgcHJvdmlkZXI6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdwcm92aWRlcicpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmFjdG9yeQogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlckZ1bmN0aW9uIEZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIGZhY3Rvcnk6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdmYWN0b3J5JyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNzZXJ2aWNlCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY29uc3RydWN0b3IgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGluc3RhbnRpYXRlZC4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZSgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgc2VydmljZTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3NlcnZpY2UnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3ZhbHVlCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IFNlcnZpY2UgaW5zdGFuY2Ugb2JqZWN0LgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjdmFsdWUgJHByb3ZpZGUudmFsdWUoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIHZhbHVlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAndmFsdWUnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnN0YW50CiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBjb25zdGFudCBuYW1lCiAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBDb25zdGFudCB2YWx1ZS4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogQmVjYXVzZSB0aGUgY29uc3RhbnQgYXJlIGZpeGVkLCB0aGV5IGdldCBhcHBsaWVkIGJlZm9yZSBvdGhlciBwcm92aWRlIG1ldGhvZHMuCiAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjY29uc3RhbnQgJHByb3ZpZGUuY29uc3RhbnQoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIGNvbnN0YW50OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnY29uc3RhbnQnLCAndW5zaGlmdCcpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjYW5pbWF0aW9uCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBhbmltYXRpb24gbmFtZQogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gYW5pbWF0aW9uRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgYW4KICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogKipOT1RFKio6IGFuaW1hdGlvbnMgdGFrZSBlZmZlY3Qgb25seSBpZiB0aGUgKipuZ0FuaW1hdGUqKiBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqCiAgICAgICAgICAgKiBEZWZpbmVzIGFuIGFuaW1hdGlvbiBob29rIHRoYXQgY2FuIGJlIGxhdGVyIHVzZWQgd2l0aAogICAgICAgICAgICoge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZSAkYW5pbWF0ZX0gc2VydmljZSBhbmQgZGlyZWN0aXZlcyB0aGF0IHVzZSB0aGlzIHNlcnZpY2UuCiAgICAgICAgICAgKgogICAgICAgICAgICogYGBganMKICAgICAgICAgICAqIG1vZHVsZS5hbmltYXRpb24oJy5hbmltYXRpb24tbmFtZScsIGZ1bmN0aW9uKCRpbmplY3QxLCAkaW5qZWN0MikgewogICAgICAgICAgICogICByZXR1cm4gewogICAgICAgICAgICogICAgIGV2ZW50TmFtZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAqICAgICAgIC8vY29kZSB0byBydW4gdGhlIGFuaW1hdGlvbgogICAgICAgICAgICogICAgICAgLy9vbmNlIGNvbXBsZXRlLCB0aGVuIHJ1biBkb25lKCkKICAgICAgICAgICAqICAgICAgIHJldHVybiBmdW5jdGlvbiBjYW5jZWxsYXRpb25GdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgKiAgICAgICAgIC8vY29kZSB0byBjYW5jZWwgdGhlIGFuaW1hdGlvbgogICAgICAgICAgICogICAgICAgfQogICAgICAgICAgICogICAgIH0KICAgICAgICAgICAqICAgfQogICAgICAgICAgICogfSkKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlUHJvdmlkZXIjcmVnaXN0ZXIgJGFuaW1hdGVQcm92aWRlci5yZWdpc3RlcigpfSBhbmQKICAgICAgICAgICAqIHtAbGluayBuZ0FuaW1hdGUgbmdBbmltYXRlIG1vZHVsZX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgKi8KICAgICAgICAgIGFuaW1hdGlvbjogaW52b2tlTGF0ZXIoJyRhbmltYXRlUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2ZpbHRlcgogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRmlsdGVyIG5hbWUuCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXJGYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBmaWx0ZXIuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGZpbHRlclByb3ZpZGVyI3JlZ2lzdGVyICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcigpfS4KICAgICAgICAgICAqLwogICAgICAgICAgZmlsdGVyOiBpbnZva2VMYXRlcignJGZpbHRlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNjb250cm9sbGVyCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgQ29udHJvbGxlciBuYW1lLCBvciBhbiBvYmplY3QgbWFwIG9mIGNvbnRyb2xsZXJzIHdoZXJlIHRoZQogICAgICAgICAgICogICAga2V5cyBhcmUgdGhlIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgY29uc3RydWN0b3JzLgogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyICRjb250cm9sbGVyUHJvdmlkZXIucmVnaXN0ZXIoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIGNvbnRyb2xsZXI6IGludm9rZUxhdGVyKCckY29udHJvbGxlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNkaXJlY3RpdmUKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBEaXJlY3RpdmUgbmFtZSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBkaXJlY3RpdmVzIHdoZXJlIHRoZQogICAgICAgICAgICogICAga2V5cyBhcmUgdGhlIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgZmFjdG9yaWVzLgogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YKICAgICAgICAgICAqIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgJGNvbXBpbGVQcm92aWRlci5kaXJlY3RpdmUoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIGRpcmVjdGl2ZTogaW52b2tlTGF0ZXIoJyRjb21waWxlUHJvdmlkZXInLCAnZGlyZWN0aXZlJyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNjb25maWcKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIEV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBvbiBtb2R1bGUgbG9hZC4gVXNlZnVsIGZvciBzZXJ2aWNlCiAgICAgICAgICAgKiAgICBjb25maWd1cmF0aW9uLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBVc2UgdGhpcyBtZXRob2QgdG8gcmVnaXN0ZXIgd29yayB3aGljaCBuZWVkcyB0byBiZSBwZXJmb3JtZWQgb24gbW9kdWxlIGxvYWRpbmcuCiAgICAgICAgICAgKiBGb3IgbW9yZSBhYm91dCBob3cgdG8gY29uZmlndXJlIHNlcnZpY2VzLCBzZWUKICAgICAgICAgICAqIHtAbGluayBwcm92aWRlcnMjcHJvdmlkZXJzX3Byb3ZpZGVyLXJlY2lwZSBQcm92aWRlciBSZWNpcGV9LgogICAgICAgICAgICovCiAgICAgICAgICBjb25maWc6IGNvbmZpZywKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3J1bgogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW5pdGlhbGl6YXRpb25GbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gYWZ0ZXIgaW5qZWN0b3IgY3JlYXRpb24uCiAgICAgICAgICAgKiAgICBVc2VmdWwgZm9yIGFwcGxpY2F0aW9uIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBVc2UgdGhpcyBtZXRob2QgdG8gcmVnaXN0ZXIgd29yayB3aGljaCBzaG91bGQgYmUgcGVyZm9ybWVkIHdoZW4gdGhlIGluamVjdG9yIGlzIGRvbmUKICAgICAgICAgICAqIGxvYWRpbmcgYWxsIG1vZHVsZXMuCiAgICAgICAgICAgKi8KICAgICAgICAgIHJ1bjogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2goYmxvY2spOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAoY29uZmlnRm4pIHsKICAgICAgICAgIGNvbmZpZyhjb25maWdGbik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gIG1vZHVsZUluc3RhbmNlOwoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvdmlkZXIKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmc9fSBpbnNlcnRNZXRob2QKICAgICAgICAgKiBAcmV0dXJucyB7YW5ndWxhci5Nb2R1bGV9CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF0ZXIocHJvdmlkZXIsIG1ldGhvZCwgaW5zZXJ0TWV0aG9kKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGludm9rZVF1ZXVlW2luc2VydE1ldGhvZCB8fCAncHVzaCddKFtwcm92aWRlciwgbWV0aG9kLCBhcmd1bWVudHNdKTsKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZUluc3RhbmNlOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICB9KTsKCn0KCi8qIGdsb2JhbAogICAgYW5ndWxhck1vZHVsZTogdHJ1ZSwKICAgIHZlcnNpb246IHRydWUsCgogICAgJExvY2FsZVByb3ZpZGVyLAogICAgJENvbXBpbGVQcm92aWRlciwKCiAgICBodG1sQW5jaG9yRGlyZWN0aXZlLAogICAgaW5wdXREaXJlY3RpdmUsCiAgICBpbnB1dERpcmVjdGl2ZSwKICAgIGZvcm1EaXJlY3RpdmUsCiAgICBzY3JpcHREaXJlY3RpdmUsCiAgICBzZWxlY3REaXJlY3RpdmUsCiAgICBzdHlsZURpcmVjdGl2ZSwKICAgIG9wdGlvbkRpcmVjdGl2ZSwKICAgIG5nQmluZERpcmVjdGl2ZSwKICAgIG5nQmluZEh0bWxEaXJlY3RpdmUsCiAgICBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSwKICAgIG5nQ2xhc3NEaXJlY3RpdmUsCiAgICBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSwKICAgIG5nQ2xhc3NPZGREaXJlY3RpdmUsCiAgICBuZ0NzcERpcmVjdGl2ZSwKICAgIG5nQ2xvYWtEaXJlY3RpdmUsCiAgICBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUsCiAgICBuZ0Zvcm1EaXJlY3RpdmUsCiAgICBuZ0hpZGVEaXJlY3RpdmUsCiAgICBuZ0lmRGlyZWN0aXZlLAogICAgbmdJbmNsdWRlRGlyZWN0aXZlLAogICAgbmdJbmNsdWRlRmlsbENvbnRlbnREaXJlY3RpdmUsCiAgICBuZ0luaXREaXJlY3RpdmUsCiAgICBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlLAogICAgbmdQbHVyYWxpemVEaXJlY3RpdmUsCiAgICBuZ1JlcGVhdERpcmVjdGl2ZSwKICAgIG5nU2hvd0RpcmVjdGl2ZSwKICAgIG5nU3R5bGVEaXJlY3RpdmUsCiAgICBuZ1N3aXRjaERpcmVjdGl2ZSwKICAgIG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSwKICAgIG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgIG5nT3B0aW9uc0RpcmVjdGl2ZSwKICAgIG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgIG5nTW9kZWxEaXJlY3RpdmUsCiAgICBuZ0xpc3REaXJlY3RpdmUsCiAgICBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgIHJlcXVpcmVkRGlyZWN0aXZlLAogICAgcmVxdWlyZWREaXJlY3RpdmUsCiAgICBuZ1ZhbHVlRGlyZWN0aXZlLAogICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMsCiAgICBuZ0V2ZW50RGlyZWN0aXZlcywKCiAgICAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAkQW5pbWF0ZVByb3ZpZGVyLAogICAgJEJyb3dzZXJQcm92aWRlciwKICAgICRDYWNoZUZhY3RvcnlQcm92aWRlciwKICAgICRDb250cm9sbGVyUHJvdmlkZXIsCiAgICAkRG9jdW1lbnRQcm92aWRlciwKICAgICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAkRmlsdGVyUHJvdmlkZXIsCiAgICAkSW50ZXJwb2xhdGVQcm92aWRlciwKICAgICRJbnRlcnZhbFByb3ZpZGVyLAogICAgJEh0dHBQcm92aWRlciwKICAgICRIdHRwQmFja2VuZFByb3ZpZGVyLAogICAgJExvY2F0aW9uUHJvdmlkZXIsCiAgICAkTG9nUHJvdmlkZXIsCiAgICAkUGFyc2VQcm92aWRlciwKICAgICRSb290U2NvcGVQcm92aWRlciwKICAgICRRUHJvdmlkZXIsCiAgICAkJFNhbml0aXplVXJpUHJvdmlkZXIsCiAgICAkU2NlUHJvdmlkZXIsCiAgICAkU2NlRGVsZWdhdGVQcm92aWRlciwKICAgICRTbmlmZmVyUHJvdmlkZXIsCiAgICAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyLAogICAgJFRpbWVvdXRQcm92aWRlciwKICAgICQkUkFGUHJvdmlkZXIsCiAgICAkJEFzeW5jQ2FsbGJhY2tQcm92aWRlciwKICAgICRXaW5kb3dQcm92aWRlcgoqLwoKCi8qKgogKiBAbmdkb2Mgb2JqZWN0CiAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogKiBAbW9kdWxlIG5nCiAqIEBkZXNjcmlwdGlvbgogKiBBbiBvYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCBBbmd1bGFySlMgdmVyc2lvbi4gVGhpcyBvYmplY3QgaGFzIHRoZQogKiBmb2xsb3dpbmcgcHJvcGVydGllczoKICoKICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIEZ1bGwgdmVyc2lvbiBzdHJpbmcsIHN1Y2ggYXMgIjAuOS4xOCIuCiAqIC0gYG1ham9yYCDigJMgYHtudW1iZXJ9YCDigJMgTWFqb3IgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjAiLgogKiAtIGBtaW5vcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1pbm9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICI5Ii4KICogLSBgZG90YCDigJMgYHtudW1iZXJ9YCDigJMgRG90IHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIxOCIuCiAqIC0gYGNvZGVOYW1lYCDigJMgYHtzdHJpbmd9YCDigJMgQ29kZSBuYW1lIG9mIHRoZSByZWxlYXNlLCBzdWNoIGFzICJqaWdnbGluZy1hcm1mYXQiLgogKi8KdmFyIHZlcnNpb24gPSB7CiAgZnVsbDogJzEuMi4xNycsICAgIC8vIGFsbCBvZiB0aGVzZSBwbGFjZWhvbGRlciBzdHJpbmdzIHdpbGwgYmUgcmVwbGFjZWQgYnkgZ3J1bnQncwogIG1ham9yOiAxLCAgICAvLyBwYWNrYWdlIHRhc2sKICBtaW5vcjogMiwKICBkb3Q6IDE3LAogIGNvZGVOYW1lOiAncXVhbnR1bS1kaXNlbnRhbmdsZW1lbnQnCn07CgoKZnVuY3Rpb24gcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpewogIGV4dGVuZChhbmd1bGFyLCB7CiAgICAnYm9vdHN0cmFwJzogYm9vdHN0cmFwLAogICAgJ2NvcHknOiBjb3B5LAogICAgJ2V4dGVuZCc6IGV4dGVuZCwKICAgICdlcXVhbHMnOiBlcXVhbHMsCiAgICAnZWxlbWVudCc6IGpxTGl0ZSwKICAgICdmb3JFYWNoJzogZm9yRWFjaCwKICAgICdpbmplY3Rvcic6IGNyZWF0ZUluamVjdG9yLAogICAgJ25vb3AnOm5vb3AsCiAgICAnYmluZCc6YmluZCwKICAgICd0b0pzb24nOiB0b0pzb24sCiAgICAnZnJvbUpzb24nOiBmcm9tSnNvbiwKICAgICdpZGVudGl0eSc6aWRlbnRpdHksCiAgICAnaXNVbmRlZmluZWQnOiBpc1VuZGVmaW5lZCwKICAgICdpc0RlZmluZWQnOiBpc0RlZmluZWQsCiAgICAnaXNTdHJpbmcnOiBpc1N0cmluZywKICAgICdpc0Z1bmN0aW9uJzogaXNGdW5jdGlvbiwKICAgICdpc09iamVjdCc6IGlzT2JqZWN0LAogICAgJ2lzTnVtYmVyJzogaXNOdW1iZXIsCiAgICAnaXNFbGVtZW50JzogaXNFbGVtZW50LAogICAgJ2lzQXJyYXknOiBpc0FycmF5LAogICAgJ3ZlcnNpb24nOiB2ZXJzaW9uLAogICAgJ2lzRGF0ZSc6IGlzRGF0ZSwKICAgICdsb3dlcmNhc2UnOiBsb3dlcmNhc2UsCiAgICAndXBwZXJjYXNlJzogdXBwZXJjYXNlLAogICAgJ2NhbGxiYWNrcyc6IHtjb3VudGVyOiAwfSwKICAgICckJG1pbkVycic6IG1pbkVyciwKICAgICckJGNzcCc6IGNzcAogIH0pOwoKICBhbmd1bGFyTW9kdWxlID0gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KTsKICB0cnkgewogICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnKTsKICB9IGNhdGNoIChlKSB7CiAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScsIFtdKS5wcm92aWRlcignJGxvY2FsZScsICRMb2NhbGVQcm92aWRlcik7CiAgfQoKICBhbmd1bGFyTW9kdWxlKCduZycsIFsnbmdMb2NhbGUnXSwgWyckcHJvdmlkZScsCiAgICBmdW5jdGlvbiBuZ01vZHVsZSgkcHJvdmlkZSkgewogICAgICAvLyAkJHNhbml0aXplVXJpUHJvdmlkZXIgbmVlZHMgdG8gYmUgYmVmb3JlICRjb21waWxlUHJvdmlkZXIgYXMgaXQgaXMgdXNlZCBieSBpdC4KICAgICAgJHByb3ZpZGUucHJvdmlkZXIoewogICAgICAgICQkc2FuaXRpemVVcmk6ICQkU2FuaXRpemVVcmlQcm92aWRlcgogICAgICB9KTsKICAgICAgJHByb3ZpZGUucHJvdmlkZXIoJyRjb21waWxlJywgJENvbXBpbGVQcm92aWRlcikuCiAgICAgICAgZGlyZWN0aXZlKHsKICAgICAgICAgICAgYTogaHRtbEFuY2hvckRpcmVjdGl2ZSwKICAgICAgICAgICAgaW5wdXQ6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICB0ZXh0YXJlYTogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgIGZvcm06IGZvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgIHNjcmlwdDogc2NyaXB0RGlyZWN0aXZlLAogICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdERpcmVjdGl2ZSwKICAgICAgICAgICAgc3R5bGU6IHN0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICBvcHRpb246IG9wdGlvbkRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdCaW5kOiBuZ0JpbmREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQmluZEh0bWw6IG5nQmluZEh0bWxEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQmluZFRlbXBsYXRlOiBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDbGFzczogbmdDbGFzc0RpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDbGFzc0V2ZW46IG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NsYXNzT2RkOiBuZ0NsYXNzT2RkRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0Nsb2FrOiBuZ0Nsb2FrRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NvbnRyb2xsZXI6IG5nQ29udHJvbGxlckRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdGb3JtOiBuZ0Zvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nSGlkZTogbmdIaWRlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0lmOiBuZ0lmRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdJbml0OiBuZ0luaXREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nTm9uQmluZGFibGU6IG5nTm9uQmluZGFibGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nUGx1cmFsaXplOiBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdSZXBlYXQ6IG5nUmVwZWF0RGlyZWN0aXZlLAogICAgICAgICAgICBuZ1Nob3c6IG5nU2hvd0RpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTdHlsZTogbmdTdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTd2l0Y2g6IG5nU3dpdGNoRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1N3aXRjaFdoZW46IG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTd2l0Y2hEZWZhdWx0OiBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nT3B0aW9uczogbmdPcHRpb25zRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1RyYW5zY2x1ZGU6IG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdMaXN0OiBuZ0xpc3REaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2hhbmdlOiBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1JlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdWYWx1ZTogbmdWYWx1ZURpcmVjdGl2ZQogICAgICAgIH0pLgogICAgICAgIGRpcmVjdGl2ZSh7CiAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZUZpbGxDb250ZW50RGlyZWN0aXZlCiAgICAgICAgfSkuCiAgICAgICAgZGlyZWN0aXZlKG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzKS4KICAgICAgICBkaXJlY3RpdmUobmdFdmVudERpcmVjdGl2ZXMpOwogICAgICAkcHJvdmlkZS5wcm92aWRlcih7CiAgICAgICAgJGFuY2hvclNjcm9sbDogJEFuY2hvclNjcm9sbFByb3ZpZGVyLAogICAgICAgICRhbmltYXRlOiAkQW5pbWF0ZVByb3ZpZGVyLAogICAgICAgICRicm93c2VyOiAkQnJvd3NlclByb3ZpZGVyLAogICAgICAgICRjYWNoZUZhY3Rvcnk6ICRDYWNoZUZhY3RvcnlQcm92aWRlciwKICAgICAgICAkY29udHJvbGxlcjogJENvbnRyb2xsZXJQcm92aWRlciwKICAgICAgICAkZG9jdW1lbnQ6ICREb2N1bWVudFByb3ZpZGVyLAogICAgICAgICRleGNlcHRpb25IYW5kbGVyOiAkRXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyLAogICAgICAgICRmaWx0ZXI6ICRGaWx0ZXJQcm92aWRlciwKICAgICAgICAkaW50ZXJwb2xhdGU6ICRJbnRlcnBvbGF0ZVByb3ZpZGVyLAogICAgICAgICRpbnRlcnZhbDogJEludGVydmFsUHJvdmlkZXIsCiAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgJGh0dHBCYWNrZW5kOiAkSHR0cEJhY2tlbmRQcm92aWRlciwKICAgICAgICAkbG9jYXRpb246ICRMb2NhdGlvblByb3ZpZGVyLAogICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAkcGFyc2U6ICRQYXJzZVByb3ZpZGVyLAogICAgICAgICRyb290U2NvcGU6ICRSb290U2NvcGVQcm92aWRlciwKICAgICAgICAkcTogJFFQcm92aWRlciwKICAgICAgICAkc2NlOiAkU2NlUHJvdmlkZXIsCiAgICAgICAgJHNjZURlbGVnYXRlOiAkU2NlRGVsZWdhdGVQcm92aWRlciwKICAgICAgICAkc25pZmZlcjogJFNuaWZmZXJQcm92aWRlciwKICAgICAgICAkdGVtcGxhdGVDYWNoZTogJFRlbXBsYXRlQ2FjaGVQcm92aWRlciwKICAgICAgICAkdGltZW91dDogJFRpbWVvdXRQcm92aWRlciwKICAgICAgICAkd2luZG93OiAkV2luZG93UHJvdmlkZXIsCiAgICAgICAgJCRyQUY6ICQkUkFGUHJvdmlkZXIsCiAgICAgICAgJCRhc3luY0NhbGxiYWNrIDogJCRBc3luY0NhbGxiYWNrUHJvdmlkZXIKICAgICAgfSk7CiAgICB9CiAgXSk7Cn0KCi8qIGdsb2JhbAoKICAtSlFMaXRlUHJvdG90eXBlLAogIC1hZGRFdmVudExpc3RlbmVyRm4sCiAgLXJlbW92ZUV2ZW50TGlzdGVuZXJGbiwKICAtQk9PTEVBTl9BVFRSCiovCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vSlFMaXRlCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5lbGVtZW50CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFdyYXBzIGEgcmF3IERPTSBlbGVtZW50IG9yIEhUTUwgc3RyaW5nIGFzIGEgW2pRdWVyeV0oaHR0cDovL2pxdWVyeS5jb20pIGVsZW1lbnQuCiAqCiAqIElmIGpRdWVyeSBpcyBhdmFpbGFibGUsIGBhbmd1bGFyLmVsZW1lbnRgIGlzIGFuIGFsaWFzIGZvciB0aGUKICogW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLiBJZiBqUXVlcnkgaXMgbm90IGF2YWlsYWJsZSwgYGFuZ3VsYXIuZWxlbWVudGAKICogZGVsZWdhdGVzIHRvIEFuZ3VsYXIncyBidWlsdC1pbiBzdWJzZXQgb2YgalF1ZXJ5LCBjYWxsZWQgImpRdWVyeSBsaXRlIiBvciAianFMaXRlLiIKICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtc3VjY2VzcyI+anFMaXRlIGlzIGEgdGlueSwgQVBJLWNvbXBhdGlibGUgc3Vic2V0IG9mIGpRdWVyeSB0aGF0IGFsbG93cwogKiBBbmd1bGFyIHRvIG1hbmlwdWxhdGUgdGhlIERPTSBpbiBhIGNyb3NzLWJyb3dzZXIgY29tcGF0aWJsZSB3YXkuICoqanFMaXRlKiogaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0CiAqIGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5IHdpdGggdGhlIGdvYWwgb2YgaGF2aW5nIGEgdmVyeSBzbWFsbCBmb290cHJpbnQuPC9kaXY+CiAqCiAqIFRvIHVzZSBqUXVlcnksIHNpbXBseSBsb2FkIGl0IGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAgZXZlbnQgZmlyZWQuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0Ij4qKk5vdGU6KiogYWxsIGVsZW1lbnQgcmVmZXJlbmNlcyBpbiBBbmd1bGFyIGFyZSBhbHdheXMgd3JhcHBlZCB3aXRoIGpRdWVyeSBvcgogKiBqcUxpdGU7IHRoZXkgYXJlIG5ldmVyIHJhdyBET00gcmVmZXJlbmNlcy48L2Rpdj4KICoKICogIyMgQW5ndWxhcidzIGpxTGl0ZQogKiBqcUxpdGUgcHJvdmlkZXMgb25seSB0aGUgZm9sbG93aW5nIGpRdWVyeSBtZXRob2RzOgogKgogKiAtIFtgYWRkQ2xhc3MoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZGRDbGFzcy8pCiAqIC0gW2BhZnRlcigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FmdGVyLykKICogLSBbYGFwcGVuZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAqIC0gW2BhdHRyKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYXR0ci8pCiAqIC0gW2BiaW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYmluZC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzLCBzZWxlY3RvcnMgb3IgZXZlbnREYXRhCiAqIC0gW2BjaGlsZHJlbigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NoaWxkcmVuLykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogKiAtIFtgY2xvbmUoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jbG9uZS8pCiAqIC0gW2Bjb250ZW50cygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NvbnRlbnRzLykKICogLSBbYGNzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nzcy8pCiAqIC0gW2BkYXRhKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZGF0YS8pCiAqIC0gW2BlbXB0eSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2VtcHR5LykKICogLSBbYGVxKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogKiAtIFtgZmluZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2ZpbmQvKSAtIExpbWl0ZWQgdG8gbG9va3VwcyBieSB0YWcgbmFtZQogKiAtIFtgaGFzQ2xhc3MoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9oYXNDbGFzcy8pCiAqIC0gW2BodG1sKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaHRtbC8pCiAqIC0gW2BuZXh0KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vbmV4dC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICogLSBbYG9uKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb24vKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcywgc2VsZWN0b3JzIG9yIGV2ZW50RGF0YQogKiAtIFtgb2ZmKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb2ZmLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMgb3Igc2VsZWN0b3JzCiAqIC0gW2BvbmUoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9vbmUvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcyBvciBzZWxlY3RvcnMKICogLSBbYHBhcmVudCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3BhcmVudC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICogLSBbYHByZXBlbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wcmVwZW5kLykKICogLSBbYHByb3AoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wcm9wLykKICogLSBbYHJlYWR5KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVhZHkvKQogKiAtIFtgcmVtb3ZlKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlLykKICogLSBbYHJlbW92ZUF0dHIoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVBdHRyLykKICogLSBbYHJlbW92ZUNsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQ2xhc3MvKQogKiAtIFtgcmVtb3ZlRGF0YSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZURhdGEvKQogKiAtIFtgcmVwbGFjZVdpdGgoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZXBsYWNlV2l0aC8pCiAqIC0gW2B0ZXh0KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdGV4dC8pCiAqIC0gW2B0b2dnbGVDbGFzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RvZ2dsZUNsYXNzLykKICogLSBbYHRyaWdnZXJIYW5kbGVyKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdHJpZ2dlckhhbmRsZXIvKSAtIFBhc3NlcyBhIGR1bW15IGV2ZW50IG9iamVjdCB0byBoYW5kbGVycy4KICogLSBbYHVuYmluZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3VuYmluZC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzCiAqIC0gW2B2YWwoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS92YWwvKQogKiAtIFtgd3JhcCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3dyYXAvKQogKgogKiAjIyBqUXVlcnkvanFMaXRlIEV4dHJhcwogKiBBbmd1bGFyIGFsc28gcHJvdmlkZXMgdGhlIGZvbGxvd2luZyBhZGRpdGlvbmFsIG1ldGhvZHMgYW5kIGV2ZW50cyB0byBib3RoIGpRdWVyeSBhbmQganFMaXRlOgogKgogKiAjIyMgRXZlbnRzCiAqIC0gYCRkZXN0cm95YCAtIEFuZ3VsYXJKUyBpbnRlcmNlcHRzIGFsbCBqcUxpdGUvalF1ZXJ5J3MgRE9NIGRlc3RydWN0aW9uIGFwaXMgYW5kIGZpcmVzIHRoaXMgZXZlbnQKICogICAgb24gYWxsIERPTSBub2RlcyBiZWluZyByZW1vdmVkLiAgVGhpcyBjYW4gYmUgdXNlZCB0byBjbGVhbiB1cCBhbnkgM3JkIHBhcnR5IGJpbmRpbmdzIHRvIHRoZSBET00KICogICAgZWxlbWVudCBiZWZvcmUgaXQgaXMgcmVtb3ZlZC4KICoKICogIyMjIE1ldGhvZHMKICogLSBgY29udHJvbGxlcihuYW1lKWAgLSByZXRyaWV2ZXMgdGhlIGNvbnRyb2xsZXIgb2YgdGhlIGN1cnJlbnQgZWxlbWVudCBvciBpdHMgcGFyZW50LiBCeSBkZWZhdWx0CiAqICAgcmV0cmlldmVzIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUuIElmIGBuYW1lYCBpcyBwcm92aWRlZCBhcwogKiAgIGNhbWVsQ2FzZSBkaXJlY3RpdmUgbmFtZSwgdGhlbiB0aGUgY29udHJvbGxlciBmb3IgdGhpcyBkaXJlY3RpdmUgd2lsbCBiZSByZXRyaWV2ZWQgKGUuZy4KICogICBgJ25nTW9kZWwnYCkuCiAqIC0gYGluamVjdG9yKClgIC0gcmV0cmlldmVzIHRoZSBpbmplY3RvciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAqIC0gYHNjb3BlKClgIC0gcmV0cmlldmVzIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0gb2YgdGhlIGN1cnJlbnQKICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAqIC0gYGlzb2xhdGVTY29wZSgpYCAtIHJldHJpZXZlcyBhbiBpc29sYXRlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBpZiBvbmUgaXMgYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlCiAqICAgY3VycmVudCBlbGVtZW50LiBUaGlzIGdldHRlciBzaG91bGQgYmUgdXNlZCBvbmx5IG9uIGVsZW1lbnRzIHRoYXQgY29udGFpbiBhIGRpcmVjdGl2ZSB3aGljaCBzdGFydHMgYSBuZXcgaXNvbGF0ZQogKiAgIHNjb3BlLiBDYWxsaW5nIGBzY29wZSgpYCBvbiB0aGlzIGVsZW1lbnQgYWx3YXlzIHJldHVybnMgdGhlIG9yaWdpbmFsIG5vbi1pc29sYXRlIHNjb3BlLgogKiAtIGBpbmhlcml0ZWREYXRhKClgIC0gc2FtZSBhcyBgZGF0YSgpYCwgYnV0IHdhbGtzIHVwIHRoZSBET00gdW50aWwgYSB2YWx1ZSBpcyBmb3VuZCBvciB0aGUgdG9wCiAqICAgcGFyZW50IGVsZW1lbnQgaXMgcmVhY2hlZC4KICoKICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAqIEByZXR1cm5zIHtPYmplY3R9IGpRdWVyeSBvYmplY3QuCiAqLwoKdmFyIGpxQ2FjaGUgPSBKUUxpdGUuY2FjaGUgPSB7fSwKICAgIGpxTmFtZSA9IEpRTGl0ZS5leHBhbmRvID0gJ25nJyArIG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAganFJZCA9IDEsCiAgICBhZGRFdmVudExpc3RlbmVyRm4gPSAod2luZG93LmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIKICAgICAgPyBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikge2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpO30KICAgICAgOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikge2VsZW1lbnQuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTt9KSwKICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcgogICAgICA/IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7IH0KICAgICAgOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikge2VsZW1lbnQuZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsgfSk7CgovKgogKiAhISEgVGhpcyBpcyBhbiB1bmRvY3VtZW50ZWQgInByaXZhdGUiIGZ1bmN0aW9uICEhIQogKi8KdmFyIGpxRGF0YSA9IEpRTGl0ZS5fZGF0YSA9IGZ1bmN0aW9uKG5vZGUpIHsKICAvL2pRdWVyeSBhbHdheXMgcmV0dXJucyBhbiBvYmplY3Qgb24gY2FjaGUgbWlzcwogIHJldHVybiB0aGlzLmNhY2hlW25vZGVbdGhpcy5leHBhbmRvXV0gfHwge307Cn07CgpmdW5jdGlvbiBqcU5leHRJZCgpIHsgcmV0dXJuICsranFJZDsgfQoKCnZhciBTUEVDSUFMX0NIQVJTX1JFR0VYUCA9IC8oW1w6XC1cX10rKC4pKS9nOwp2YXIgTU9aX0hBQ0tfUkVHRVhQID0gL15tb3ooW0EtWl0pLzsKdmFyIGpxTGl0ZU1pbkVyciA9IG1pbkVycignanFMaXRlJyk7CgovKioKICogQ29udmVydHMgc25ha2VfY2FzZSB0byBjYW1lbENhc2UuCiAqIEFsc28gdGhlcmUgaXMgc3BlY2lhbCBjYXNlIGZvciBNb3ogcHJlZml4IHN0YXJ0aW5nIHdpdGggdXBwZXIgY2FzZSBsZXR0ZXIuCiAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAqLwpmdW5jdGlvbiBjYW1lbENhc2UobmFtZSkgewogIHJldHVybiBuYW1lLgogICAgcmVwbGFjZShTUEVDSUFMX0NIQVJTX1JFR0VYUCwgZnVuY3Rpb24oXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICByZXR1cm4gb2Zmc2V0ID8gbGV0dGVyLnRvVXBwZXJDYXNlKCkgOiBsZXR0ZXI7CiAgICB9KS4KICAgIHJlcGxhY2UoTU9aX0hBQ0tfUkVHRVhQLCAnTW96JDEnKTsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIGpRdWVyeSBtdXRhdGlvbiBwYXRjaAovLwovLyBJbiBjb25qdW5jdGlvbiB3aXRoIGJpbmRKUXVlcnkgaW50ZXJjZXB0cyBhbGwgalF1ZXJ5J3MgRE9NIGRlc3RydWN0aW9uIGFwaXMgYW5kIGZpcmVzIGEKLy8gJGRlc3Ryb3kgZXZlbnQgb24gYWxsIERPTSBub2RlcyBiZWluZyByZW1vdmVkLgovLwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCmZ1bmN0aW9uIGpxTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKG5hbWUsIGRpc3BhdGNoVGhpcywgZmlsdGVyRWxlbXMsIGdldHRlcklmTm9Bcmd1bWVudHMpIHsKICB2YXIgb3JpZ2luYWxKcUZuID0galF1ZXJ5LmZuW25hbWVdOwogIG9yaWdpbmFsSnFGbiA9IG9yaWdpbmFsSnFGbi4kb3JpZ2luYWwgfHwgb3JpZ2luYWxKcUZuOwogIHJlbW92ZVBhdGNoLiRvcmlnaW5hbCA9IG9yaWdpbmFsSnFGbjsKICBqUXVlcnkuZm5bbmFtZV0gPSByZW1vdmVQYXRjaDsKCiAgZnVuY3Rpb24gcmVtb3ZlUGF0Y2gocGFyYW0pIHsKICAgIC8vIGpzaGludCAtVzA0MAogICAgdmFyIGxpc3QgPSBmaWx0ZXJFbGVtcyAmJiBwYXJhbSA/IFt0aGlzLmZpbHRlcihwYXJhbSldIDogW3RoaXNdLAogICAgICAgIGZpcmVFdmVudCA9IGRpc3BhdGNoVGhpcywKICAgICAgICBzZXQsIHNldEluZGV4LCBzZXRMZW5ndGgsCiAgICAgICAgZWxlbWVudCwgY2hpbGRJbmRleCwgY2hpbGRMZW5ndGgsIGNoaWxkcmVuOwoKICAgIGlmICghZ2V0dGVySWZOb0FyZ3VtZW50cyB8fCBwYXJhbSAhPSBudWxsKSB7CiAgICAgIHdoaWxlKGxpc3QubGVuZ3RoKSB7CiAgICAgICAgc2V0ID0gbGlzdC5zaGlmdCgpOwogICAgICAgIGZvcihzZXRJbmRleCA9IDAsIHNldExlbmd0aCA9IHNldC5sZW5ndGg7IHNldEluZGV4IDwgc2V0TGVuZ3RoOyBzZXRJbmRleCsrKSB7CiAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKHNldFtzZXRJbmRleF0pOwogICAgICAgICAgaWYgKGZpcmVFdmVudCkgewogICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCckZGVzdHJveScpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmlyZUV2ZW50ID0gIWZpcmVFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZvcihjaGlsZEluZGV4ID0gMCwgY2hpbGRMZW5ndGggPSAoY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCkpLmxlbmd0aDsKICAgICAgICAgICAgICBjaGlsZEluZGV4IDwgY2hpbGRMZW5ndGg7CiAgICAgICAgICAgICAgY2hpbGRJbmRleCsrKSB7CiAgICAgICAgICAgIGxpc3QucHVzaChqUXVlcnkoY2hpbGRyZW5bY2hpbGRJbmRleF0pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvcmlnaW5hbEpxRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Cn0KCnZhciBTSU5HTEVfVEFHX1JFR0VYUCA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPnwpJC87CnZhciBIVE1MX1JFR0VYUCA9IC88fCYjP1x3KzsvOwp2YXIgVEFHX05BTUVfUkVHRVhQID0gLzwoW1x3Ol0rKS87CnZhciBYSFRNTF9UQUdfUkVHRVhQID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW1x3Ol0rKVtePl0qKVwvPi9naTsKCnZhciB3cmFwTWFwID0gewogICdvcHRpb24nOiBbMSwgJzxzZWxlY3QgbXVsdGlwbGU9Im11bHRpcGxlIj4nLCAnPC9zZWxlY3Q+J10sCgogICd0aGVhZCc6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAogICdjb2wnOiBbMiwgJzx0YWJsZT48Y29sZ3JvdXA+JywgJzwvY29sZ3JvdXA+PC90YWJsZT4nXSwKICAndHInOiBbMiwgJzx0YWJsZT48dGJvZHk+JywgJzwvdGJvZHk+PC90YWJsZT4nXSwKICAndGQnOiBbMywgJzx0YWJsZT48dGJvZHk+PHRyPicsICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nXSwKICAnX2RlZmF1bHQnOiBbMCwgIiIsICIiXQp9OwoKd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uOwp3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwp3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKCmZ1bmN0aW9uIGpxTGl0ZUlzVGV4dE5vZGUoaHRtbCkgewogIHJldHVybiAhSFRNTF9SRUdFWFAudGVzdChodG1sKTsKfQoKZnVuY3Rpb24ganFMaXRlQnVpbGRGcmFnbWVudChodG1sLCBjb250ZXh0KSB7CiAgdmFyIGVsZW0sIHRtcCwgdGFnLCB3cmFwLAogICAgICBmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICBub2RlcyA9IFtdLCBpLCBqLCBqajsKCiAgaWYgKGpxTGl0ZUlzVGV4dE5vZGUoaHRtbCkpIHsKICAgIC8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQogICAgbm9kZXMucHVzaChjb250ZXh0LmNyZWF0ZVRleHROb2RlKGh0bWwpKTsKICB9IGVsc2UgewogICAgdG1wID0gZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY29udGV4dC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CiAgICAvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKICAgIHRhZyA9IChUQUdfTkFNRV9SRUdFWFAuZXhlYyhodG1sKSB8fCBbIiIsICIiXSlbMV0udG9Mb3dlckNhc2UoKTsKICAgIHdyYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgIHRtcC5pbm5lckhUTUwgPSAnPGRpdj4mIzE2MDs8L2Rpdj4nICsKICAgICAgd3JhcFsxXSArIGh0bWwucmVwbGFjZShYSFRNTF9UQUdfUkVHRVhQLCAiPCQxPjwvJDI+IikgKyB3cmFwWzJdOwogICAgdG1wLnJlbW92ZUNoaWxkKHRtcC5maXJzdENoaWxkKTsKCiAgICAvLyBEZXNjZW5kIHRocm91Z2ggd3JhcHBlcnMgdG8gdGhlIHJpZ2h0IGNvbnRlbnQKICAgIGkgPSB3cmFwWzBdOwogICAgd2hpbGUgKGktLSkgewogICAgICB0bXAgPSB0bXAubGFzdENoaWxkOwogICAgfQoKICAgIGZvciAoaj0wLCBqaj10bXAuY2hpbGROb2Rlcy5sZW5ndGg7IGo8amo7ICsraikgbm9kZXMucHVzaCh0bXAuY2hpbGROb2Rlc1tqXSk7CgogICAgdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKICAgIHRtcC50ZXh0Q29udGVudCA9ICIiOwogIH0KCiAgLy8gUmVtb3ZlIHdyYXBwZXIgZnJvbSBmcmFnbWVudAogIGZyYWdtZW50LnRleHRDb250ZW50ID0gIiI7CiAgZnJhZ21lbnQuaW5uZXJIVE1MID0gIiI7IC8vIENsZWFyIGlubmVyIEhUTUwKICByZXR1cm4gbm9kZXM7Cn0KCmZ1bmN0aW9uIGpxTGl0ZVBhcnNlSFRNTChodG1sLCBjb250ZXh0KSB7CiAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgdmFyIHBhcnNlZDsKCiAgaWYgKChwYXJzZWQgPSBTSU5HTEVfVEFHX1JFR0VYUC5leGVjKGh0bWwpKSkgewogICAgcmV0dXJuIFtjb250ZXh0LmNyZWF0ZUVsZW1lbnQocGFyc2VkWzFdKV07CiAgfQoKICByZXR1cm4ganFMaXRlQnVpbGRGcmFnbWVudChodG1sLCBjb250ZXh0KTsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCmZ1bmN0aW9uIEpRTGl0ZShlbGVtZW50KSB7CiAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBKUUxpdGUpIHsKICAgIHJldHVybiBlbGVtZW50OwogIH0KICBpZiAoaXNTdHJpbmcoZWxlbWVudCkpIHsKICAgIGVsZW1lbnQgPSB0cmltKGVsZW1lbnQpOwogIH0KICBpZiAoISh0aGlzIGluc3RhbmNlb2YgSlFMaXRlKSkgewogICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpICYmIGVsZW1lbnQuY2hhckF0KDApICE9ICc8JykgewogICAgICB0aHJvdyBqcUxpdGVNaW5FcnIoJ25vc2VsJywgJ0xvb2tpbmcgdXAgZWxlbWVudHMgdmlhIHNlbGVjdG9ycyBpcyBub3Qgc3VwcG9ydGVkIGJ5IGpxTGl0ZSEgU2VlOiBodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9hbmd1bGFyLmVsZW1lbnQnKTsKICAgIH0KICAgIHJldHVybiBuZXcgSlFMaXRlKGVsZW1lbnQpOwogIH0KCiAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICBqcUxpdGVBZGROb2Rlcyh0aGlzLCBqcUxpdGVQYXJzZUhUTUwoZWxlbWVudCkpOwogICAgdmFyIGZyYWdtZW50ID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSk7CiAgICBmcmFnbWVudC5hcHBlbmQodGhpcyk7CiAgfSBlbHNlIHsKICAgIGpxTGl0ZUFkZE5vZGVzKHRoaXMsIGVsZW1lbnQpOwogIH0KfQoKZnVuY3Rpb24ganFMaXRlQ2xvbmUoZWxlbWVudCkgewogIHJldHVybiBlbGVtZW50LmNsb25lTm9kZSh0cnVlKTsKfQoKZnVuY3Rpb24ganFMaXRlRGVhbG9jKGVsZW1lbnQpewogIGpxTGl0ZVJlbW92ZURhdGEoZWxlbWVudCk7CiAgZm9yICggdmFyIGkgPSAwLCBjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGROb2RlcyB8fCBbXTsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICBqcUxpdGVEZWFsb2MoY2hpbGRyZW5baV0pOwogIH0KfQoKZnVuY3Rpb24ganFMaXRlT2ZmKGVsZW1lbnQsIHR5cGUsIGZuLCB1bnN1cHBvcnRlZCkgewogIGlmIChpc0RlZmluZWQodW5zdXBwb3J0ZWQpKSB0aHJvdyBqcUxpdGVNaW5FcnIoJ29mZmFyZ3MnLCAnanFMaXRlI29mZigpIGRvZXMgbm90IHN1cHBvcnQgdGhlIGBzZWxlY3RvcmAgYXJndW1lbnQnKTsKCiAgdmFyIGV2ZW50cyA9IGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJyksCiAgICAgIGhhbmRsZSA9IGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJyk7CgogIGlmICghaGFuZGxlKSByZXR1cm47IC8vbm8gbGlzdGVuZXJzIHJlZ2lzdGVyZWQKCiAgaWYgKGlzVW5kZWZpbmVkKHR5cGUpKSB7CiAgICBmb3JFYWNoKGV2ZW50cywgZnVuY3Rpb24oZXZlbnRIYW5kbGVyLCB0eXBlKSB7CiAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudEhhbmRsZXIpOwogICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIGZvckVhY2godHlwZS5zcGxpdCgnICcpLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZChmbikpIHsKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRzW3R5cGVdKTsKICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICB9IGVsc2UgewogICAgICAgIGFycmF5UmVtb3ZlKGV2ZW50c1t0eXBlXSB8fCBbXSwgZm4pOwogICAgICB9CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZVJlbW92ZURhdGEoZWxlbWVudCwgbmFtZSkgewogIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXTsKCiAgaWYgKGV4cGFuZG9TdG9yZSkgewogICAgaWYgKG5hbWUpIHsKICAgICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXS5kYXRhW25hbWVdOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGV4cGFuZG9TdG9yZS5oYW5kbGUpIHsKICAgICAgZXhwYW5kb1N0b3JlLmV2ZW50cy4kZGVzdHJveSAmJiBleHBhbmRvU3RvcmUuaGFuZGxlKHt9LCAnJGRlc3Ryb3knKTsKICAgICAganFMaXRlT2ZmKGVsZW1lbnQpOwogICAgfQogICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXTsKICAgIGVsZW1lbnRbanFOYW1lXSA9IHVuZGVmaW5lZDsgLy8gaWUgZG9lcyBub3QgYWxsb3cgZGVsZXRpb24gb2YgYXR0cmlidXRlcyBvbiBlbGVtZW50cy4KICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCBrZXksIHZhbHVlKSB7CiAgdmFyIGV4cGFuZG9JZCA9IGVsZW1lbnRbanFOYW1lXSwKICAgICAgZXhwYW5kb1N0b3JlID0ganFDYWNoZVtleHBhbmRvSWQgfHwgLTFdOwoKICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgaWYgKCFleHBhbmRvU3RvcmUpIHsKICAgICAgZWxlbWVudFtqcU5hbWVdID0gZXhwYW5kb0lkID0ganFOZXh0SWQoKTsKICAgICAgZXhwYW5kb1N0b3JlID0ganFDYWNoZVtleHBhbmRvSWRdID0ge307CiAgICB9CiAgICBleHBhbmRvU3RvcmVba2V5XSA9IHZhbHVlOwogIH0gZWxzZSB7CiAgICByZXR1cm4gZXhwYW5kb1N0b3JlICYmIGV4cGFuZG9TdG9yZVtrZXldOwogIH0KfQoKZnVuY3Rpb24ganFMaXRlRGF0YShlbGVtZW50LCBrZXksIHZhbHVlKSB7CiAgdmFyIGRhdGEgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2RhdGEnKSwKICAgICAgaXNTZXR0ZXIgPSBpc0RlZmluZWQodmFsdWUpLAogICAgICBrZXlEZWZpbmVkID0gIWlzU2V0dGVyICYmIGlzRGVmaW5lZChrZXkpLAogICAgICBpc1NpbXBsZUdldHRlciA9IGtleURlZmluZWQgJiYgIWlzT2JqZWN0KGtleSk7CgogIGlmICghZGF0YSAmJiAhaXNTaW1wbGVHZXR0ZXIpIHsKICAgIGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZGF0YScsIGRhdGEgPSB7fSk7CiAgfQoKICBpZiAoaXNTZXR0ZXIpIHsKICAgIGRhdGFba2V5XSA9IHZhbHVlOwogIH0gZWxzZSB7CiAgICBpZiAoa2V5RGVmaW5lZCkgewogICAgICBpZiAoaXNTaW1wbGVHZXR0ZXIpIHsKICAgICAgICAvLyBkb24ndCBjcmVhdGUgZGF0YSBpbiB0aGlzIGNhc2UuCiAgICAgICAgcmV0dXJuIGRhdGEgJiYgZGF0YVtrZXldOwogICAgICB9IGVsc2UgewogICAgICAgIGV4dGVuZChkYXRhLCBrZXkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZGF0YTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgaWYgKCFlbGVtZW50LmdldEF0dHJpYnV0ZSkgcmV0dXJuIGZhbHNlOwogIHJldHVybiAoKCIgIiArIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICIpLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpLgogICAgICBpbmRleE9mKCAiICIgKyBzZWxlY3RvciArICIgIiApID4gLTEpOwp9CgpmdW5jdGlvbiBqcUxpdGVSZW1vdmVDbGFzcyhlbGVtZW50LCBjc3NDbGFzc2VzKSB7CiAgaWYgKGNzc0NsYXNzZXMgJiYgZWxlbWVudC5zZXRBdHRyaWJ1dGUpIHsKICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCB0cmltKAogICAgICAgICAgKCIgIiArIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICIpCiAgICAgICAgICAucmVwbGFjZSgvW1xuXHRdL2csICIgIikKICAgICAgICAgIC5yZXBsYWNlKCIgIiArIHRyaW0oY3NzQ2xhc3MpICsgIiAiLCAiICIpKQogICAgICApOwogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVBZGRDbGFzcyhlbGVtZW50LCBjc3NDbGFzc2VzKSB7CiAgaWYgKGNzc0NsYXNzZXMgJiYgZWxlbWVudC5zZXRBdHRyaWJ1dGUpIHsKICAgIHZhciBleGlzdGluZ0NsYXNzZXMgPSAoJyAnICsgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICcgJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKTsKCiAgICBmb3JFYWNoKGNzc0NsYXNzZXMuc3BsaXQoJyAnKSwgZnVuY3Rpb24oY3NzQ2xhc3MpIHsKICAgICAgY3NzQ2xhc3MgPSB0cmltKGNzc0NsYXNzKTsKICAgICAgaWYgKGV4aXN0aW5nQ2xhc3Nlcy5pbmRleE9mKCcgJyArIGNzc0NsYXNzICsgJyAnKSA9PT0gLTEpIHsKICAgICAgICBleGlzdGluZ0NsYXNzZXMgKz0gY3NzQ2xhc3MgKyAnICc7CiAgICAgIH0KICAgIH0pOwoKICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdjbGFzcycsIHRyaW0oZXhpc3RpbmdDbGFzc2VzKSk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVBZGROb2Rlcyhyb290LCBlbGVtZW50cykgewogIGlmIChlbGVtZW50cykgewogICAgZWxlbWVudHMgPSAoIWVsZW1lbnRzLm5vZGVOYW1lICYmIGlzRGVmaW5lZChlbGVtZW50cy5sZW5ndGgpICYmICFpc1dpbmRvdyhlbGVtZW50cykpCiAgICAgID8gZWxlbWVudHMKICAgICAgOiBbIGVsZW1lbnRzIF07CiAgICBmb3IodmFyIGk9MDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJvb3QucHVzaChlbGVtZW50c1tpXSk7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVDb250cm9sbGVyKGVsZW1lbnQsIG5hbWUpIHsKICByZXR1cm4ganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJCcgKyAobmFtZSB8fCAnbmdDb250cm9sbGVyJyApICsgJ0NvbnRyb2xsZXInKTsKfQoKZnVuY3Rpb24ganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogIC8vIGlmIGVsZW1lbnQgaXMgdGhlIGRvY3VtZW50IG9iamVjdCB3b3JrIHdpdGggdGhlIGh0bWwgZWxlbWVudCBpbnN0ZWFkCiAgLy8gdGhpcyBtYWtlcyAkKGRvY3VtZW50KS5zY29wZSgpIHBvc3NpYmxlCiAgaWYoZWxlbWVudFswXS5ub2RlVHlwZSA9PSA5KSB7CiAgICBlbGVtZW50ID0gZWxlbWVudC5maW5kKCdodG1sJyk7CiAgfQogIHZhciBuYW1lcyA9IGlzQXJyYXkobmFtZSkgPyBuYW1lIDogW25hbWVdOwoKICB3aGlsZSAoZWxlbWVudC5sZW5ndGgpIHsKICAgIHZhciBub2RlID0gZWxlbWVudFswXTsKICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IG5hbWVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgaWYgKCh2YWx1ZSA9IGVsZW1lbnQuZGF0YShuYW1lc1tpXSkpICE9PSB1bmRlZmluZWQpIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvLyBJZiBkZWFsaW5nIHdpdGggYSBkb2N1bWVudCBmcmFnbWVudCBub2RlIHdpdGggYSBob3N0IGVsZW1lbnQsIGFuZCBubyBwYXJlbnQsIHVzZSB0aGUgaG9zdAogICAgLy8gZWxlbWVudCBhcyB0aGUgcGFyZW50LiBUaGlzIGVuYWJsZXMgZGlyZWN0aXZlcyB3aXRoaW4gYSBTaGFkb3cgRE9NIG9yIHBvbHlmaWxsZWQgU2hhZG93IERPTQogICAgLy8gdG8gbG9va3VwIHBhcmVudCBjb250cm9sbGVycy4KICAgIGVsZW1lbnQgPSBqcUxpdGUobm9kZS5wYXJlbnROb2RlIHx8IChub2RlLm5vZGVUeXBlID09PSAxMSAmJiBub2RlLmhvc3QpKTsKICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUVtcHR5KGVsZW1lbnQpIHsKICBmb3IgKHZhciBpID0gMCwgY2hpbGROb2RlcyA9IGVsZW1lbnQuY2hpbGROb2RlczsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgIGpxTGl0ZURlYWxvYyhjaGlsZE5vZGVzW2ldKTsKICB9CiAgd2hpbGUgKGVsZW1lbnQuZmlyc3RDaGlsZCkgewogICAgZWxlbWVudC5yZW1vdmVDaGlsZChlbGVtZW50LmZpcnN0Q2hpbGQpOwogIH0KfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIEZ1bmN0aW9ucyB3aGljaCBhcmUgZGVjbGFyZWQgZGlyZWN0bHkuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwp2YXIgSlFMaXRlUHJvdG90eXBlID0gSlFMaXRlLnByb3RvdHlwZSA9IHsKICByZWFkeTogZnVuY3Rpb24oZm4pIHsKICAgIHZhciBmaXJlZCA9IGZhbHNlOwoKICAgIGZ1bmN0aW9uIHRyaWdnZXIoKSB7CiAgICAgIGlmIChmaXJlZCkgcmV0dXJuOwogICAgICBmaXJlZCA9IHRydWU7CiAgICAgIGZuKCk7CiAgICB9CgogICAgLy8gY2hlY2sgaWYgZG9jdW1lbnQgYWxyZWFkeSBpcyBsb2FkZWQKICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKXsKICAgICAgc2V0VGltZW91dCh0cmlnZ2VyKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMub24oJ0RPTUNvbnRlbnRMb2FkZWQnLCB0cmlnZ2VyKTsgLy8gd29ya3MgZm9yIG1vZGVybiBicm93c2VycyBhbmQgSUU5CiAgICAgIC8vIHdlIGNhbiBub3QgdXNlIGpxTGl0ZSBzaW5jZSB3ZSBhcmUgbm90IGRvbmUgbG9hZGluZyBhbmQgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBsYXRlci4KICAgICAgLy8ganNoaW50IC1XMDY0CiAgICAgIEpRTGl0ZSh3aW5kb3cpLm9uKCdsb2FkJywgdHJpZ2dlcik7IC8vIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQgZm9yIG90aGVycwogICAgICAvLyBqc2hpbnQgK1cwNjQKICAgIH0KICB9LAogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHZhciB2YWx1ZSA9IFtdOwogICAgZm9yRWFjaCh0aGlzLCBmdW5jdGlvbihlKXsgdmFsdWUucHVzaCgnJyArIGUpO30pOwogICAgcmV0dXJuICdbJyArIHZhbHVlLmpvaW4oJywgJykgKyAnXSc7CiAgfSwKCiAgZXE6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgIHJldHVybiAoaW5kZXggPj0gMCkgPyBqcUxpdGUodGhpc1tpbmRleF0pIDoganFMaXRlKHRoaXNbdGhpcy5sZW5ndGggKyBpbmRleF0pOwogIH0sCgogIGxlbmd0aDogMCwKICBwdXNoOiBwdXNoLAogIHNvcnQ6IFtdLnNvcnQsCiAgc3BsaWNlOiBbXS5zcGxpY2UKfTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIGdldHRlci9zZXR0ZXJzLgovLyB0aGVzZSBmdW5jdGlvbnMgcmV0dXJuIHNlbGYgb24gc2V0dGVyIGFuZAovLyB2YWx1ZSBvbiBnZXQuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwp2YXIgQk9PTEVBTl9BVFRSID0ge307CmZvckVhY2goJ211bHRpcGxlLHNlbGVjdGVkLGNoZWNrZWQsZGlzYWJsZWQscmVhZE9ubHkscmVxdWlyZWQsb3Blbicuc3BsaXQoJywnKSwgZnVuY3Rpb24odmFsdWUpIHsKICBCT09MRUFOX0FUVFJbbG93ZXJjYXNlKHZhbHVlKV0gPSB2YWx1ZTsKfSk7CnZhciBCT09MRUFOX0VMRU1FTlRTID0ge307CmZvckVhY2goJ2lucHV0LHNlbGVjdCxvcHRpb24sdGV4dGFyZWEsYnV0dG9uLGZvcm0sZGV0YWlscycuc3BsaXQoJywnKSwgZnVuY3Rpb24odmFsdWUpIHsKICBCT09MRUFOX0VMRU1FTlRTW3VwcGVyY2FzZSh2YWx1ZSldID0gdHJ1ZTsKfSk7CgpmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgdmFyIGJvb2xlYW5BdHRyID0gQk9PTEVBTl9BVFRSW25hbWUudG9Mb3dlckNhc2UoKV07CgogIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwp9Cgpmb3JFYWNoKHsKICBkYXRhOiBqcUxpdGVEYXRhLAogIGluaGVyaXRlZERhdGE6IGpxTGl0ZUluaGVyaXRlZERhdGEsCgogIHNjb3BlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAvLyBDYW4ndCB1c2UganFMaXRlRGF0YSBoZXJlIGRpcmVjdGx5IHNvIHdlIHN0YXkgY29tcGF0aWJsZSB3aXRoIGpRdWVyeSEKICAgIHJldHVybiBqcUxpdGUoZWxlbWVudCkuZGF0YSgnJHNjb3BlJykgfHwganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LnBhcmVudE5vZGUgfHwgZWxlbWVudCwgWyckaXNvbGF0ZVNjb3BlJywgJyRzY29wZSddKTsKICB9LAoKICBpc29sYXRlU2NvcGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIC8vIENhbid0IHVzZSBqcUxpdGVEYXRhIGhlcmUgZGlyZWN0bHkgc28gd2Ugc3RheSBjb21wYXRpYmxlIHdpdGggalF1ZXJ5IQogICAgcmV0dXJuIGpxTGl0ZShlbGVtZW50KS5kYXRhKCckaXNvbGF0ZVNjb3BlJykgfHwganFMaXRlKGVsZW1lbnQpLmRhdGEoJyRpc29sYXRlU2NvcGVOb1RlbXBsYXRlJyk7CiAgfSwKCiAgY29udHJvbGxlcjoganFMaXRlQ29udHJvbGxlciwKCiAgaW5qZWN0b3I6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHJldHVybiBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckaW5qZWN0b3InKTsKICB9LAoKICByZW1vdmVBdHRyOiBmdW5jdGlvbihlbGVtZW50LG5hbWUpIHsKICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogIH0sCgogIGhhc0NsYXNzOiBqcUxpdGVIYXNDbGFzcywKCiAgY3NzOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgbmFtZSA9IGNhbWVsQ2FzZShuYW1lKTsKCiAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICBlbGVtZW50LnN0eWxlW25hbWVdID0gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICB2YXIgdmFsOwoKICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgIC8vIHRoaXMgaXMgc29tZSBJRSBzcGVjaWZpYyB3ZWlyZG5lc3MgdGhhdCBqUXVlcnkgMS42LjQgZG9lcyBub3Qgc3VyZSB3aHkKICAgICAgICB2YWwgPSBlbGVtZW50LmN1cnJlbnRTdHlsZSAmJiBlbGVtZW50LmN1cnJlbnRTdHlsZVtuYW1lXTsKICAgICAgICBpZiAodmFsID09PSAnJykgdmFsID0gJ2F1dG8nOwogICAgICB9CgogICAgICB2YWwgPSB2YWwgfHwgZWxlbWVudC5zdHlsZVtuYW1lXTsKCiAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAvLyBqcXVlcnkgd2VpcmRuZXNzIDotLwogICAgICAgIHZhbCA9ICh2YWwgPT09ICcnKSA/IHVuZGVmaW5lZCA6IHZhbDsKICAgICAgfQoKICAgICAgcmV0dXJuICB2YWw7CiAgICB9CiAgfSwKCiAgYXR0cjogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpewogICAgdmFyIGxvd2VyY2FzZWROYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgaWYgKEJPT0xFQU5fQVRUUltsb3dlcmNhc2VkTmFtZV0pIHsKICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBpZiAoISF2YWx1ZSkgewogICAgICAgICAgZWxlbWVudFtuYW1lXSA9IHRydWU7CiAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCBsb3dlcmNhc2VkTmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSBmYWxzZTsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGxvd2VyY2FzZWROYW1lKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIChlbGVtZW50W25hbWVdIHx8CiAgICAgICAgICAgICAgICAgKGVsZW1lbnQuYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0obmFtZSl8fCBub29wKS5zcGVjaWZpZWQpCiAgICAgICAgICAgICAgID8gbG93ZXJjYXNlZE5hbWUKICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgIC8vIHRoZSBleHRyYSBhcmd1bWVudCAiMiIgaXMgdG8gZ2V0IHRoZSByaWdodCB0aGluZyBmb3IgYS5ocmVmIGluIElFLCBzZWUgalF1ZXJ5IGNvZGUKICAgICAgLy8gc29tZSBlbGVtZW50cyAoZS5nLiBEb2N1bWVudCkgZG9uJ3QgaGF2ZSBnZXQgYXR0cmlidXRlLCBzbyByZXR1cm4gdW5kZWZpbmVkCiAgICAgIHZhciByZXQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZShuYW1lLCAyKTsKICAgICAgLy8gbm9ybWFsaXplIG5vbi1leGlzdGluZyBhdHRyaWJ1dGVzIHRvIHVuZGVmaW5lZCAoYXMgalF1ZXJ5KQogICAgICByZXR1cm4gcmV0ID09PSBudWxsID8gdW5kZWZpbmVkIDogcmV0OwogICAgfQogIH0sCgogIHByb3A6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICBlbGVtZW50W25hbWVdID0gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZWxlbWVudFtuYW1lXTsKICAgIH0KICB9LAoKICB0ZXh0OiAoZnVuY3Rpb24oKSB7CiAgICB2YXIgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFkgPSBbXTsKICAgIGlmIChtc2llIDwgOSkgewogICAgICBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVsxXSA9ICdpbm5lclRleHQnOyAgICAvKiogRWxlbWVudCAqKi8KICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbM10gPSAnbm9kZVZhbHVlJzsgICAgLyoqIFRleHQgKiovCiAgICB9IGVsc2UgewogICAgICBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVsxXSA9ICAgICAgICAgICAgICAgICAvKiogRWxlbWVudCAqKi8KICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbM10gPSAndGV4dENvbnRlbnQnOyAgLyoqIFRleHQgKiovCiAgICB9CiAgICBnZXRUZXh0LiRkdiA9ICcnOwogICAgcmV0dXJuIGdldFRleHQ7CgogICAgZnVuY3Rpb24gZ2V0VGV4dChlbGVtZW50LCB2YWx1ZSkgewogICAgICB2YXIgdGV4dFByb3AgPSBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVtlbGVtZW50Lm5vZGVUeXBlXTsKICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0ZXh0UHJvcCA/IGVsZW1lbnRbdGV4dFByb3BdIDogJyc7CiAgICAgIH0KICAgICAgZWxlbWVudFt0ZXh0UHJvcF0gPSB2YWx1ZTsKICAgIH0KICB9KSgpLAoKICB2YWw6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlKSB7CiAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgIGlmIChub2RlTmFtZV8oZWxlbWVudCkgPT09ICdTRUxFQ1QnICYmIGVsZW1lbnQubXVsdGlwbGUpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgZm9yRWFjaChlbGVtZW50Lm9wdGlvbnMsIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2gob3B0aW9uLnZhbHVlIHx8IG9wdGlvbi50ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA9PT0gMCA/IG51bGwgOiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICB9CiAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MOwogICAgfQogICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkTm9kZXMgPSBlbGVtZW50LmNoaWxkTm9kZXM7IGkgPCBjaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGpxTGl0ZURlYWxvYyhjaGlsZE5vZGVzW2ldKTsKICAgIH0KICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gdmFsdWU7CiAgfSwKCiAgZW1wdHk6IGpxTGl0ZUVtcHR5Cn0sIGZ1bmN0aW9uKGZuLCBuYW1lKXsKICAvKioKICAgKiBQcm9wZXJ0aWVzOiB3cml0ZXMgcmV0dXJuIHNlbGVjdGlvbiwgcmVhZHMgcmV0dXJuIGZpcnN0IHZhbHVlCiAgICovCiAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKGFyZzEsIGFyZzIpIHsKICAgIHZhciBpLCBrZXk7CgogICAgLy8ganFMaXRlSGFzQ2xhc3MgaGFzIG9ubHkgdHdvIGFyZ3VtZW50cywgYnV0IGlzIGEgZ2V0dGVyLW9ubHkgZm4sIHNvIHdlIG5lZWQgdG8gc3BlY2lhbC1jYXNlIGl0CiAgICAvLyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzIG1pbmlmaWNhdGlvbi4KICAgIC8vIGpxTGl0ZUVtcHR5IHRha2VzIG5vIGFyZ3VtZW50cyBidXQgaXMgYSBzZXR0ZXIuCiAgICBpZiAoZm4gIT09IGpxTGl0ZUVtcHR5ICYmCiAgICAgICAgKCgoZm4ubGVuZ3RoID09IDIgJiYgKGZuICE9PSBqcUxpdGVIYXNDbGFzcyAmJiBmbiAhPT0ganFMaXRlQ29udHJvbGxlcikpID8gYXJnMSA6IGFyZzIpID09PSB1bmRlZmluZWQpKSB7CiAgICAgIGlmIChpc09iamVjdChhcmcxKSkgewoKICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgYnV0IHRoZSBvYmplY3QgcHJvcGVydGllcyBhcmUgdGhlIGtleS92YWx1ZXMKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGZuID09PSBqcUxpdGVEYXRhKSB7CiAgICAgICAgICAgIC8vIGRhdGEoKSB0YWtlcyB0aGUgd2hvbGUgb2JqZWN0IGluIGpRdWVyeQogICAgICAgICAgICBmbih0aGlzW2ldLCBhcmcxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIGFyZzEpIHsKICAgICAgICAgICAgICBmbih0aGlzW2ldLCBrZXksIGFyZzFba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gd2UgYXJlIGEgcmVhZCwgc28gcmVhZCB0aGUgZmlyc3QgY2hpbGQuCiAgICAgICAgdmFyIHZhbHVlID0gZm4uJGR2OwogICAgICAgIC8vIE9ubHkgaWYgd2UgaGF2ZSAkZHYgZG8gd2UgaXRlcmF0ZSBvdmVyIGFsbCwgb3RoZXJ3aXNlIGl0IGlzIGp1c3QgdGhlIGZpcnN0IGVsZW1lbnQuCiAgICAgICAgdmFyIGpqID0gKHZhbHVlID09PSB1bmRlZmluZWQpID8gTWF0aC5taW4odGhpcy5sZW5ndGgsIDEpIDogdGhpcy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBqajsgaisrKSB7CiAgICAgICAgICB2YXIgbm9kZVZhbHVlID0gZm4odGhpc1tqXSwgYXJnMSwgYXJnMik7CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlID8gdmFsdWUgKyBub2RlVmFsdWUgOiBub2RlVmFsdWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gd2UgYXJlIGEgd3JpdGUsIHNvIGFwcGx5IHRvIGFsbCBjaGlsZHJlbgogICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpOwogICAgICB9CiAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9Owp9KTsKCmZ1bmN0aW9uIGNyZWF0ZUV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudHMpIHsKICB2YXIgZXZlbnRIYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50LCB0eXBlKSB7CiAgICBpZiAoIWV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy9pZQogICAgICB9OwogICAgfQoKICAgIGlmICghZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7IC8vaWUKICAgICAgfTsKICAgIH0KCiAgICBpZiAoIWV2ZW50LnRhcmdldCkgewogICAgICBldmVudC50YXJnZXQgPSBldmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgfQoKICAgIGlmIChpc1VuZGVmaW5lZChldmVudC5kZWZhdWx0UHJldmVudGVkKSkgewogICAgICB2YXIgcHJldmVudCA9IGV2ZW50LnByZXZlbnREZWZhdWx0OwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgIHByZXZlbnQuY2FsbChldmVudCk7CiAgICAgIH07CiAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZTsKICAgIH0KCiAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgfHwgZXZlbnQucmV0dXJuVmFsdWUgPT09IGZhbHNlOwogICAgfTsKCiAgICAvLyBDb3B5IGV2ZW50IGhhbmRsZXJzIGluIGNhc2UgZXZlbnQgaGFuZGxlcnMgYXJyYXkgaXMgbW9kaWZpZWQgZHVyaW5nIGV4ZWN1dGlvbi4KICAgIHZhciBldmVudEhhbmRsZXJzQ29weSA9IHNoYWxsb3dDb3B5KGV2ZW50c1t0eXBlIHx8IGV2ZW50LnR5cGVdIHx8IFtdKTsKCiAgICBmb3JFYWNoKGV2ZW50SGFuZGxlcnNDb3B5LCBmdW5jdGlvbihmbikgewogICAgICBmbi5jYWxsKGVsZW1lbnQsIGV2ZW50KTsKICAgIH0pOwoKICAgIC8vIFJlbW92ZSBtb25rZXktcGF0Y2hlZCBtZXRob2RzIChJRSksCiAgICAvLyBhcyB0aGV5IHdvdWxkIGNhdXNlIG1lbW9yeSBsZWFrcyBpbiBJRTguCiAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgIC8vIElFNy84IGRvZXMgbm90IGFsbG93IHRvIGRlbGV0ZSBwcm9wZXJ0eSBvbiBuYXRpdmUgb2JqZWN0CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gbnVsbDsKICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gbnVsbDsKICAgICAgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEl0IHNob3VsZG4ndCBhZmZlY3Qgbm9ybWFsIGJyb3dzZXJzIChuYXRpdmUgbWV0aG9kcyBhcmUgZGVmaW5lZCBvbiBwcm90b3R5cGUpLgogICAgICBkZWxldGUgZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgIGRlbGV0ZSBldmVudC5zdG9wUHJvcGFnYXRpb247CiAgICAgIGRlbGV0ZSBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQ7CiAgICB9CiAgfTsKICBldmVudEhhbmRsZXIuZWxlbSA9IGVsZW1lbnQ7CiAgcmV0dXJuIGV2ZW50SGFuZGxlcjsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIEZ1bmN0aW9ucyBpdGVyYXRpbmcgdHJhdmVyc2FsLgovLyBUaGVzZSBmdW5jdGlvbnMgY2hhaW4gcmVzdWx0cyBpbnRvIGEgc2luZ2xlCi8vIHNlbGVjdG9yLgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KZm9yRWFjaCh7CiAgcmVtb3ZlRGF0YToganFMaXRlUmVtb3ZlRGF0YSwKCiAgZGVhbG9jOiBqcUxpdGVEZWFsb2MsCgogIG9uOiBmdW5jdGlvbiBvbkZuKGVsZW1lbnQsIHR5cGUsIGZuLCB1bnN1cHBvcnRlZCl7CiAgICBpZiAoaXNEZWZpbmVkKHVuc3VwcG9ydGVkKSkgdGhyb3cganFMaXRlTWluRXJyKCdvbmFyZ3MnLCAnanFMaXRlI29uKCkgZG9lcyBub3Qgc3VwcG9ydCB0aGUgYHNlbGVjdG9yYCBvciBgZXZlbnREYXRhYCBwYXJhbWV0ZXJzJyk7CgogICAgdmFyIGV2ZW50cyA9IGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJyksCiAgICAgICAgaGFuZGxlID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICBpZiAoIWV2ZW50cykganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnLCBldmVudHMgPSB7fSk7CiAgICBpZiAoIWhhbmRsZSkganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnLCBoYW5kbGUgPSBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSk7CgogICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uKHR5cGUpewogICAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CgogICAgICBpZiAoIWV2ZW50Rm5zKSB7CiAgICAgICAgaWYgKHR5cGUgPT0gJ21vdXNlZW50ZXInIHx8IHR5cGUgPT0gJ21vdXNlbGVhdmUnKSB7CiAgICAgICAgICB2YXIgY29udGFpbnMgPSBkb2N1bWVudC5ib2R5LmNvbnRhaW5zIHx8IGRvY3VtZW50LmJvZHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwogICAgICAgICAgZnVuY3Rpb24oIGEsIGIgKSB7CiAgICAgICAgICAgIC8vIGpzaGludCBiaXR3aXNlOiBmYWxzZQogICAgICAgICAgICB2YXIgYWRvd24gPSBhLm5vZGVUeXBlID09PSA5ID8gYS5kb2N1bWVudEVsZW1lbnQgOiBhLAogICAgICAgICAgICBidXAgPSBiICYmIGIucGFyZW50Tm9kZTsKICAgICAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoCiAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zKCBidXAgKSA6CiAgICAgICAgICAgICAgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBidXAgKSAmIDE2CiAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgIH0gOgogICAgICAgICAgICBmdW5jdGlvbiggYSwgYiApIHsKICAgICAgICAgICAgICBpZiAoIGIgKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAoIChiID0gYi5wYXJlbnROb2RlKSApIHsKICAgICAgICAgICAgICAgICAgaWYgKCBiID09PSBhICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKCiAgICAgICAgICAvLyBSZWZlciB0byBqUXVlcnkncyBpbXBsZW1lbnRhdGlvbiBvZiBtb3VzZWVudGVyICYgbW91c2VsZWF2ZQogICAgICAgICAgLy8gUmVhZCBhYm91dCBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlOgogICAgICAgICAgLy8gaHR0cDovL3d3dy5xdWlya3Ntb2RlLm9yZy9qcy9ldmVudHNfbW91c2UuaHRtbCNsaW5rOAogICAgICAgICAgdmFyIGV2ZW50bWFwID0geyBtb3VzZWxlYXZlIDogIm1vdXNlb3V0IiwgbW91c2VlbnRlciA6ICJtb3VzZW92ZXIifTsKCiAgICAgICAgICBvbkZuKGVsZW1lbnQsIGV2ZW50bWFwW3R5cGVdLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAgICAgLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKICAgICAgICAgICAgaWYgKCAhcmVsYXRlZCB8fCAocmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFjb250YWlucyh0YXJnZXQsIHJlbGF0ZWQpKSApewogICAgICAgICAgICAgIGhhbmRsZShldmVudCwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGhhbmRsZSk7CiAgICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKICAgICAgICB9CiAgICAgICAgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CiAgICAgIH0KICAgICAgZXZlbnRGbnMucHVzaChmbik7CiAgICB9KTsKICB9LAoKICBvZmY6IGpxTGl0ZU9mZiwKCiAgb25lOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikgewogICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKCiAgICAvL2FkZCB0aGUgbGlzdGVuZXIgdHdpY2Ugc28gdGhhdCB3aGVuIGl0IGlzIGNhbGxlZAogICAgLy95b3UgY2FuIHJlbW92ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24gYW5kIHN0aWxsIGJlCiAgICAvL2FibGUgdG8gY2FsbCBlbGVtZW50Lm9mZihldiwgZm4pIG5vcm1hbGx5CiAgICBlbGVtZW50Lm9uKHR5cGUsIGZ1bmN0aW9uIG9uRm4oKSB7CiAgICAgIGVsZW1lbnQub2ZmKHR5cGUsIGZuKTsKICAgICAgZWxlbWVudC5vZmYodHlwZSwgb25Gbik7CiAgICB9KTsKICAgIGVsZW1lbnQub24odHlwZSwgZm4pOwogIH0sCgogIHJlcGxhY2VXaXRoOiBmdW5jdGlvbihlbGVtZW50LCByZXBsYWNlTm9kZSkgewogICAgdmFyIGluZGV4LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICBqcUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgICBmb3JFYWNoKG5ldyBKUUxpdGUocmVwbGFjZU5vZGUpLCBmdW5jdGlvbihub2RlKXsKICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChub2RlLCBlbGVtZW50KTsKICAgICAgfQogICAgICBpbmRleCA9IG5vZGU7CiAgICB9KTsKICB9LAoKICBjaGlsZHJlbjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIGNoaWxkcmVuID0gW107CiAgICBmb3JFYWNoKGVsZW1lbnQuY2hpbGROb2RlcywgZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgIGNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICB9KTsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9LAoKICBjb250ZW50czogZnVuY3Rpb24oZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuY29udGVudERvY3VtZW50IHx8IGVsZW1lbnQuY2hpbGROb2RlcyB8fCBbXTsKICB9LAoKICBhcHBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24oY2hpbGQpewogICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtZW50Lm5vZGVUeXBlID09PSAxMSkgewogICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICB9CiAgICB9KTsKICB9LAoKICBwcmVwZW5kOiBmdW5jdGlvbihlbGVtZW50LCBub2RlKSB7CiAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICB2YXIgaW5kZXggPSBlbGVtZW50LmZpcnN0Q2hpbGQ7CiAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24oY2hpbGQpewogICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNoaWxkLCBpbmRleCk7CiAgICAgIH0pOwogICAgfQogIH0sCgogIHdyYXA6IGZ1bmN0aW9uKGVsZW1lbnQsIHdyYXBOb2RlKSB7CiAgICB3cmFwTm9kZSA9IGpxTGl0ZSh3cmFwTm9kZSlbMF07CiAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgaWYgKHBhcmVudCkgewogICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBOb2RlLCBlbGVtZW50KTsKICAgIH0KICAgIHdyYXBOb2RlLmFwcGVuZENoaWxkKGVsZW1lbnQpOwogIH0sCgogIHJlbW92ZTogZnVuY3Rpb24oZWxlbWVudCkgewogICAganFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIGlmIChwYXJlbnQpIHBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTsKICB9LAoKICBhZnRlcjogZnVuY3Rpb24oZWxlbWVudCwgbmV3RWxlbWVudCkgewogICAgdmFyIGluZGV4ID0gZWxlbWVudCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgZm9yRWFjaChuZXcgSlFMaXRlKG5ld0VsZW1lbnQpLCBmdW5jdGlvbihub2RlKXsKICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgIGluZGV4ID0gbm9kZTsKICAgIH0pOwogIH0sCgogIGFkZENsYXNzOiBqcUxpdGVBZGRDbGFzcywKICByZW1vdmVDbGFzczoganFMaXRlUmVtb3ZlQ2xhc3MsCgogIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihlbGVtZW50LCBzZWxlY3RvciwgY29uZGl0aW9uKSB7CiAgICBpZiAoc2VsZWN0b3IpIHsKICAgICAgZm9yRWFjaChzZWxlY3Rvci5zcGxpdCgnICcpLCBmdW5jdGlvbihjbGFzc05hbWUpewogICAgICAgIHZhciBjbGFzc0NvbmRpdGlvbiA9IGNvbmRpdGlvbjsKICAgICAgICBpZiAoaXNVbmRlZmluZWQoY2xhc3NDb25kaXRpb24pKSB7CiAgICAgICAgICBjbGFzc0NvbmRpdGlvbiA9ICFqcUxpdGVIYXNDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgIH0KICAgICAgICAoY2xhc3NDb25kaXRpb24gPyBqcUxpdGVBZGRDbGFzcyA6IGpxTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICB9KTsKICAgIH0KICB9LAoKICBwYXJlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwogIH0sCgogIG5leHQ6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGlmIChlbGVtZW50Lm5leHRFbGVtZW50U2libGluZykgewogICAgICByZXR1cm4gZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CgogICAgLy8gSUU4IGRvZXNuJ3QgaGF2ZSBuZXh0RWxlbWVudFNpYmxpbmcKICAgIHZhciBlbG0gPSBlbGVtZW50Lm5leHRTaWJsaW5nOwogICAgd2hpbGUgKGVsbSAhPSBudWxsICYmIGVsbS5ub2RlVHlwZSAhPT0gMSkgewogICAgICBlbG0gPSBlbG0ubmV4dFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gZWxtOwogIH0sCgogIGZpbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSkgewogICAgICByZXR1cm4gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShzZWxlY3Rvcik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gW107CiAgICB9CiAgfSwKCiAgY2xvbmU6IGpxTGl0ZUNsb25lLAoKICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnROYW1lLCBldmVudERhdGEpIHsKICAgIHZhciBldmVudEZucyA9IChqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycpIHx8IHt9KVtldmVudE5hbWVdOwoKICAgIGV2ZW50RGF0YSA9IGV2ZW50RGF0YSB8fCBbXTsKCiAgICB2YXIgZXZlbnQgPSBbewogICAgICBwcmV2ZW50RGVmYXVsdDogbm9vcCwKICAgICAgc3RvcFByb3BhZ2F0aW9uOiBub29wCiAgICB9XTsKCiAgICBmb3JFYWNoKGV2ZW50Rm5zLCBmdW5jdGlvbihmbikgewogICAgICBmbi5hcHBseShlbGVtZW50LCBldmVudC5jb25jYXQoZXZlbnREYXRhKSk7CiAgICB9KTsKICB9Cn0sIGZ1bmN0aW9uKGZuLCBuYW1lKXsKICAvKioKICAgKiBjaGFpbmluZyBmdW5jdGlvbnMKICAgKi8KICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oYXJnMSwgYXJnMiwgYXJnMykgewogICAgdmFyIHZhbHVlOwogICAgZm9yKHZhciBpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIsIGFyZzMpOwogICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAvLyBhbnkgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhIHZhbHVlIG5lZWRzIHRvIGJlIHdyYXBwZWQKICAgICAgICAgIHZhbHVlID0ganFMaXRlKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAganFMaXRlQWRkTm9kZXModmFsdWUsIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIsIGFyZzMpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGlzRGVmaW5lZCh2YWx1ZSkgPyB2YWx1ZSA6IHRoaXM7CiAgfTsKCiAgLy8gYmluZCBsZWdhY3kgYmluZC91bmJpbmQgdG8gb24vb2ZmCiAgSlFMaXRlLnByb3RvdHlwZS5iaW5kID0gSlFMaXRlLnByb3RvdHlwZS5vbjsKICBKUUxpdGUucHJvdG90eXBlLnVuYmluZCA9IEpRTGl0ZS5wcm90b3R5cGUub2ZmOwp9KTsKCi8qKgogKiBDb21wdXRlcyBhIGhhc2ggb2YgYW4gJ29iaicuCiAqIEhhc2ggb2YgYToKICogIHN0cmluZyBpcyBzdHJpbmcKICogIG51bWJlciBpcyBudW1iZXIgYXMgc3RyaW5nCiAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICogICAgICAgICB0aGF0IGlzIGFsc28gYXNzaWduZWQgdG8gdGhlICQkaGFzaEtleSBwcm9wZXJ0eSBvZiB0aGUgb2JqZWN0LgogKgogKiBAcGFyYW0gb2JqCiAqIEByZXR1cm5zIHtzdHJpbmd9IGhhc2ggc3RyaW5nIHN1Y2ggdGhhdCB0aGUgc2FtZSBpbnB1dCB3aWxsIGhhdmUgdGhlIHNhbWUgaGFzaCBzdHJpbmcuCiAqICAgICAgICAgVGhlIHJlc3VsdGluZyBzdHJpbmcga2V5IGlzIGluICd0eXBlOmhhc2hLZXknIGZvcm1hdC4KICovCmZ1bmN0aW9uIGhhc2hLZXkob2JqKSB7CiAgdmFyIG9ialR5cGUgPSB0eXBlb2Ygb2JqLAogICAgICBrZXk7CgogIGlmIChvYmpUeXBlID09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbCkgewogICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAvLyBtdXN0IGludm9rZSBvbiBvYmplY3QgdG8ga2VlcCB0aGUgcmlnaHQgdGhpcwogICAgICBrZXkgPSBvYmouJCRoYXNoS2V5KCk7CiAgICB9IGVsc2UgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkgPSBuZXh0VWlkKCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGtleSA9IG9iajsKICB9CgogIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5Owp9CgovKioKICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogKi8KZnVuY3Rpb24gSGFzaE1hcChhcnJheSl7CiAgZm9yRWFjaChhcnJheSwgdGhpcy5wdXQsIHRoaXMpOwp9Ckhhc2hNYXAucHJvdG90eXBlID0gewogIC8qKgogICAqIFN0b3JlIGtleSB2YWx1ZSBwYWlyCiAgICogQHBhcmFtIGtleSBrZXkgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICogQHBhcmFtIHZhbHVlIHZhbHVlIHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAqLwogIHB1dDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgdGhpc1toYXNoS2V5KGtleSldID0gdmFsdWU7CiAgfSwKCiAgLyoqCiAgICogQHBhcmFtIGtleQogICAqIEByZXR1cm5zIHtPYmplY3R9IHRoZSB2YWx1ZSBmb3IgdGhlIGtleQogICAqLwogIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICByZXR1cm4gdGhpc1toYXNoS2V5KGtleSldOwogIH0sCgogIC8qKgogICAqIFJlbW92ZSB0aGUga2V5L3ZhbHVlIHBhaXIKICAgKiBAcGFyYW0ga2V5CiAgICovCiAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgIHZhciB2YWx1ZSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICByZXR1cm4gdmFsdWU7CiAgfQp9OwoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbW9kdWxlIG5nCiAqIEBuYW1lIGFuZ3VsYXIuaW5qZWN0b3IKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYW4gaW5qZWN0b3IgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCBmb3IgcmV0cmlldmluZyBzZXJ2aWNlcyBhcyB3ZWxsIGFzIGZvcgogKiBkZXBlbmRlbmN5IGluamVjdGlvbiAoc2VlIHtAbGluayBndWlkZS9kaSBkZXBlbmRlbmN5IGluamVjdGlvbn0pLgogKgoKICogQHBhcmFtIHtBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gbW9kdWxlcyBBIGxpc3Qgb2YgbW9kdWxlIGZ1bmN0aW9ucyBvciB0aGVpciBhbGlhc2VzLiBTZWUKICogICAgICAgIHtAbGluayBhbmd1bGFyLm1vZHVsZX0uIFRoZSBgbmdgIG1vZHVsZSBtdXN0IGJlIGV4cGxpY2l0bHkgYWRkZWQuCiAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBJbmplY3RvciBmdW5jdGlvbi4gU2VlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LgogKgogKiBAZXhhbXBsZQogKiBUeXBpY2FsIHVzYWdlCiAqIGBgYGpzCiAqICAgLy8gY3JlYXRlIGFuIGluamVjdG9yCiAqICAgdmFyICRpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoWyduZyddKTsKICoKICogICAvLyB1c2UgdGhlIGluamVjdG9yIHRvIGtpY2sgb2ZmIHlvdXIgYXBwbGljYXRpb24KICogICAvLyB1c2UgdGhlIHR5cGUgaW5mZXJlbmNlIHRvIGF1dG8gaW5qZWN0IGFyZ3VtZW50cywgb3IgdXNlIGltcGxpY2l0IGluamVjdGlvbgogKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJHJvb3RTY29wZSwgJGNvbXBpbGUsICRkb2N1bWVudCl7CiAqICAgICAkY29tcGlsZSgkZG9jdW1lbnQpKCRyb290U2NvcGUpOwogKiAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAqICAgfSk7CiAqIGBgYAogKgogKiBTb21ldGltZXMgeW91IHdhbnQgdG8gZ2V0IGFjY2VzcyB0byB0aGUgaW5qZWN0b3Igb2YgYSBjdXJyZW50bHkgcnVubmluZyBBbmd1bGFyIGFwcAogKiBmcm9tIG91dHNpZGUgQW5ndWxhci4gUGVyaGFwcywgeW91IHdhbnQgdG8gaW5qZWN0IGFuZCBjb21waWxlIHNvbWUgbWFya3VwIGFmdGVyIHRoZQogKiBhcHBsaWNhdGlvbiBoYXMgYmVlbiBib290c3RyYXBwZWQuIFlvdSBjYW4gZG8gdGhpcyB1c2luZyB0aGUgZXh0cmEgYGluamVjdG9yKClgIGFkZGVkCiAqIHRvIEpRdWVyeS9qcUxpdGUgZWxlbWVudHMuIFNlZSB7QGxpbmsgYW5ndWxhci5lbGVtZW50fS4KICoKICogKlRoaXMgaXMgZmFpcmx5IHJhcmUgYnV0IGNvdWxkIGJlIHRoZSBjYXNlIGlmIGEgdGhpcmQgcGFydHkgbGlicmFyeSBpcyBpbmplY3RpbmcgdGhlCiAqIG1hcmt1cC4qCiAqCiAqIEluIHRoZSBmb2xsb3dpbmcgZXhhbXBsZSBhIG5ldyBibG9jayBvZiBIVE1MIGNvbnRhaW5pbmcgYSBgbmctY29udHJvbGxlcmAKICogZGlyZWN0aXZlIGlzIGFkZGVkIHRvIHRoZSBlbmQgb2YgdGhlIGRvY3VtZW50IGJvZHkgYnkgSlF1ZXJ5LiBXZSB0aGVuIGNvbXBpbGUgYW5kIGxpbmsKICogaXQgaW50byB0aGUgY3VycmVudCBBbmd1bGFySlMgc2NvcGUuCiAqCiAqIGBgYGpzCiAqIHZhciAkZGl2ID0gJCgnPGRpdiBuZy1jb250cm9sbGVyPSJNeUN0cmwiPnt7Y29udGVudC5sYWJlbH19PC9kaXY+Jyk7CiAqICQoZG9jdW1lbnQuYm9keSkuYXBwZW5kKCRkaXYpOwogKgogKiBhbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmluamVjdG9yKCkuaW52b2tlKGZ1bmN0aW9uKCRjb21waWxlKSB7CiAqICAgdmFyIHNjb3BlID0gYW5ndWxhci5lbGVtZW50KCRkaXYpLnNjb3BlKCk7CiAqICAgJGNvbXBpbGUoJGRpdikoc2NvcGUpOwogKiB9KTsKICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgbW9kdWxlCiAqIEBuYW1lIGF1dG8KICogQGRlc2NyaXB0aW9uCiAqCiAqIEltcGxpY2l0IG1vZHVsZSB3aGljaCBnZXRzIGF1dG9tYXRpY2FsbHkgYWRkZWQgdG8gZWFjaCB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4KICovCgp2YXIgRk5fQVJHUyA9IC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbTsKdmFyIEZOX0FSR19TUExJVCA9IC8sLzsKdmFyIEZOX0FSRyA9IC9eXHMqKF8/KShcUys/KVwxXHMqJC87CnZhciBTVFJJUF9DT01NRU5UUyA9IC8oKFwvXC8uKiQpfChcL1wqW1xzXFNdKj9cKlwvKSkvbWc7CnZhciAkaW5qZWN0b3JNaW5FcnIgPSBtaW5FcnIoJyRpbmplY3RvcicpOwpmdW5jdGlvbiBhbm5vdGF0ZShmbikgewogIHZhciAkaW5qZWN0LAogICAgICBmblRleHQsCiAgICAgIGFyZ0RlY2wsCiAgICAgIGxhc3Q7CgogIGlmICh0eXBlb2YgZm4gPT0gJ2Z1bmN0aW9uJykgewogICAgaWYgKCEoJGluamVjdCA9IGZuLiRpbmplY3QpKSB7CiAgICAgICRpbmplY3QgPSBbXTsKICAgICAgaWYgKGZuLmxlbmd0aCkgewogICAgICAgIGZuVGV4dCA9IGZuLnRvU3RyaW5nKCkucmVwbGFjZShTVFJJUF9DT01NRU5UUywgJycpOwogICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgZm9yRWFjaChhcmdEZWNsWzFdLnNwbGl0KEZOX0FSR19TUExJVCksIGZ1bmN0aW9uKGFyZyl7CiAgICAgICAgICBhcmcucmVwbGFjZShGTl9BUkcsIGZ1bmN0aW9uKGFsbCwgdW5kZXJzY29yZSwgbmFtZSl7CiAgICAgICAgICAgICRpbmplY3QucHVzaChuYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGZuLiRpbmplY3QgPSAkaW5qZWN0OwogICAgfQogIH0gZWxzZSBpZiAoaXNBcnJheShmbikpIHsKICAgIGxhc3QgPSBmbi5sZW5ndGggLSAxOwogICAgYXNzZXJ0QXJnRm4oZm5bbGFzdF0sICdmbicpOwogICAgJGluamVjdCA9IGZuLnNsaWNlKDAsIGxhc3QpOwogIH0gZWxzZSB7CiAgICBhc3NlcnRBcmdGbihmbiwgJ2ZuJywgdHJ1ZSk7CiAgfQogIHJldHVybiAkaW5qZWN0Owp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW5qZWN0b3IKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIGAkaW5qZWN0b3JgIGlzIHVzZWQgdG8gcmV0cmlldmUgb2JqZWN0IGluc3RhbmNlcyBhcyBkZWZpbmVkIGJ5CiAqIHtAbGluayBhdXRvLiRwcm92aWRlIHByb3ZpZGVyfSwgaW5zdGFudGlhdGUgdHlwZXMsIGludm9rZSBtZXRob2RzLAogKiBhbmQgbG9hZCBtb2R1bGVzLgogKgogKiBUaGUgZm9sbG93aW5nIGFsd2F5cyBob2xkcyB0cnVlOgogKgogKiBgYGBqcwogKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKCk7CiAqICAgZXhwZWN0KCRpbmplY3Rvci5nZXQoJyRpbmplY3RvcicpKS50b0JlKCRpbmplY3Rvcik7CiAqICAgZXhwZWN0KCRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGluamVjdG9yKXsKICogICAgIHJldHVybiAkaW5qZWN0b3I7CiAqICAgfSkudG9CZSgkaW5qZWN0b3IpOwogKiBgYGAKICoKICogIyBJbmplY3Rpb24gRnVuY3Rpb24gQW5ub3RhdGlvbgogKgogKiBKYXZhU2NyaXB0IGRvZXMgbm90IGhhdmUgYW5ub3RhdGlvbnMsIGFuZCBhbm5vdGF0aW9ucyBhcmUgbmVlZGVkIGZvciBkZXBlbmRlbmN5IGluamVjdGlvbi4gVGhlCiAqIGZvbGxvd2luZyBhcmUgYWxsIHZhbGlkIHdheXMgb2YgYW5ub3RhdGluZyBmdW5jdGlvbiB3aXRoIGluamVjdGlvbiBhcmd1bWVudHMgYW5kIGFyZSBlcXVpdmFsZW50LgogKgogKiBgYGBqcwogKiAgIC8vIGluZmVycmVkIChvbmx5IHdvcmtzIGlmIGNvZGUgbm90IG1pbmlmaWVkL29iZnVzY2F0ZWQpCiAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbihzZXJ2aWNlQSl7fSk7CiAqCiAqICAgLy8gYW5ub3RhdGVkCiAqICAgZnVuY3Rpb24gZXhwbGljaXQoc2VydmljZUEpIHt9OwogKiAgIGV4cGxpY2l0LiRpbmplY3QgPSBbJ3NlcnZpY2VBJ107CiAqICAgJGluamVjdG9yLmludm9rZShleHBsaWNpdCk7CiAqCiAqICAgLy8gaW5saW5lCiAqICAgJGluamVjdG9yLmludm9rZShbJ3NlcnZpY2VBJywgZnVuY3Rpb24oc2VydmljZUEpe31dKTsKICogYGBgCiAqCiAqICMjIEluZmVyZW5jZQogKgogKiBJbiBKYXZhU2NyaXB0IGNhbGxpbmcgYHRvU3RyaW5nKClgIG9uIGEgZnVuY3Rpb24gcmV0dXJucyB0aGUgZnVuY3Rpb24gZGVmaW5pdGlvbi4gVGhlIGRlZmluaXRpb24KICogY2FuIHRoZW4gYmUgcGFyc2VkIGFuZCB0aGUgZnVuY3Rpb24gYXJndW1lbnRzIGNhbiBiZSBleHRyYWN0ZWQuICpOT1RFOiogVGhpcyBkb2VzIG5vdCB3b3JrIHdpdGgKICogbWluaWZpY2F0aW9uLCBhbmQgb2JmdXNjYXRpb24gdG9vbHMgc2luY2UgdGhlc2UgdG9vbHMgY2hhbmdlIHRoZSBhcmd1bWVudCBuYW1lcy4KICoKICogIyMgYCRpbmplY3RgIEFubm90YXRpb24KICogQnkgYWRkaW5nIGFuIGAkaW5qZWN0YCBwcm9wZXJ0eSBvbnRvIGEgZnVuY3Rpb24gdGhlIGluamVjdGlvbiBwYXJhbWV0ZXJzIGNhbiBiZSBzcGVjaWZpZWQuCiAqCiAqICMjIElubGluZQogKiBBcyBhbiBhcnJheSBvZiBpbmplY3Rpb24gbmFtZXMsIHdoZXJlIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGFycmF5IGlzIHRoZSBmdW5jdGlvbiB0byBjYWxsLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRpbmplY3RvciNnZXQKICoKICogQGRlc2NyaXB0aW9uCiAqIFJldHVybiBhbiBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRvIHJldHJpZXZlLgogKiBAcmV0dXJuIHsqfSBUaGUgaW5zdGFuY2UuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGluamVjdG9yI2ludm9rZQogKgogKiBAZGVzY3JpcHRpb24KICogSW52b2tlIHRoZSBtZXRob2QgYW5kIHN1cHBseSB0aGUgbWV0aG9kIGFyZ3VtZW50cyBmcm9tIHRoZSBgJGluamVjdG9yYC4KICoKICogQHBhcmFtIHshRnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuIEZ1bmN0aW9uIHBhcmFtZXRlcnMgYXJlIGluamVjdGVkIGFjY29yZGluZyB0byB0aGUKICogICB7QGxpbmsgZ3VpZGUvZGkgJGluamVjdCBBbm5vdGF0aW9ufSBydWxlcy4KICogQHBhcmFtIHtPYmplY3Q9fSBzZWxmIFRoZSBgdGhpc2AgZm9yIHRoZSBpbnZva2VkIG1ldGhvZC4KICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzCiAqICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdCBmaXJzdCwgYmVmb3JlIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAqIEByZXR1cm5zIHsqfSB0aGUgdmFsdWUgcmV0dXJuZWQgYnkgdGhlIGludm9rZWQgYGZuYCBmdW5jdGlvbi4KICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkaW5qZWN0b3IjaGFzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBbGxvd3MgdGhlIHVzZXIgdG8gcXVlcnkgaWYgdGhlIHBhcnRpY3VsYXIgc2VydmljZSBleGlzdHMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBOYW1lIG9mIHRoZSBzZXJ2aWNlIHRvIHF1ZXJ5LgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gcmV0dXJucyB0cnVlIGlmIGluamVjdG9yIGhhcyBnaXZlbiBzZXJ2aWNlLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRpbmplY3RvciNpbnN0YW50aWF0ZQogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIEpTIHR5cGUuIFRoZSBtZXRob2QgdGFrZXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaW52b2tlcyB0aGUgbmV3CiAqIG9wZXJhdG9yLCBhbmQgc3VwcGxpZXMgYWxsIG9mIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGFzIHNwZWNpZmllZCBieSB0aGUKICogY29uc3RydWN0b3IgYW5ub3RhdGlvbi4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gVHlwZSBBbm5vdGF0ZWQgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcwogKiBvYmplY3QgZmlyc3QsIGJlZm9yZSB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogKiBAcmV0dXJucyB7T2JqZWN0fSBuZXcgaW5zdGFuY2Ugb2YgYFR5cGVgLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRpbmplY3RvciNhbm5vdGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogUmV0dXJucyBhbiBhcnJheSBvZiBzZXJ2aWNlIG5hbWVzIHdoaWNoIHRoZSBmdW5jdGlvbiBpcyByZXF1ZXN0aW5nIGZvciBpbmplY3Rpb24uIFRoaXMgQVBJIGlzCiAqIHVzZWQgYnkgdGhlIGluamVjdG9yIHRvIGRldGVybWluZSB3aGljaCBzZXJ2aWNlcyBuZWVkIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uIHdoZW4gdGhlCiAqIGZ1bmN0aW9uIGlzIGludm9rZWQuIFRoZXJlIGFyZSB0aHJlZSB3YXlzIGluIHdoaWNoIHRoZSBmdW5jdGlvbiBjYW4gYmUgYW5ub3RhdGVkIHdpdGggdGhlIG5lZWRlZAogKiBkZXBlbmRlbmNpZXMuCiAqCiAqICMgQXJndW1lbnQgbmFtZXMKICoKICogVGhlIHNpbXBsZXN0IGZvcm0gaXMgdG8gZXh0cmFjdCB0aGUgZGVwZW5kZW5jaWVzIGZyb20gdGhlIGFyZ3VtZW50cyBvZiB0aGUgZnVuY3Rpb24uIFRoaXMgaXMgZG9uZQogKiBieSBjb252ZXJ0aW5nIHRoZSBmdW5jdGlvbiBpbnRvIGEgc3RyaW5nIHVzaW5nIGB0b1N0cmluZygpYCBtZXRob2QgYW5kIGV4dHJhY3RpbmcgdGhlIGFyZ3VtZW50CiAqIG5hbWVzLgogKiBgYGBqcwogKiAgIC8vIEdpdmVuCiAqICAgZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJHJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAqCiAqICAgLy8gVGhlbgogKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICogYGBgCiAqCiAqIFRoaXMgbWV0aG9kIGRvZXMgbm90IHdvcmsgd2l0aCBjb2RlIG1pbmlmaWNhdGlvbiAvIG9iZnVzY2F0aW9uLiBGb3IgdGhpcyByZWFzb24gdGhlIGZvbGxvd2luZwogKiBhbm5vdGF0aW9uIHN0cmF0ZWdpZXMgYXJlIHN1cHBvcnRlZC4KICoKICogIyBUaGUgYCRpbmplY3RgIHByb3BlcnR5CiAqCiAqIElmIGEgZnVuY3Rpb24gaGFzIGFuIGAkaW5qZWN0YCBwcm9wZXJ0eSBhbmQgaXRzIHZhbHVlIGlzIGFuIGFycmF5IG9mIHN0cmluZ3MsIHRoZW4gdGhlIHN0cmluZ3MKICogcmVwcmVzZW50IG5hbWVzIG9mIHNlcnZpY2VzIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uLgogKiBgYGBqcwogKiAgIC8vIEdpdmVuCiAqICAgdmFyIE15Q29udHJvbGxlciA9IGZ1bmN0aW9uKG9iZnVzY2F0ZWRTY29wZSwgb2JmdXNjYXRlZFJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAqICAgLy8gRGVmaW5lIGZ1bmN0aW9uIGRlcGVuZGVuY2llcwogKiAgIE15Q29udHJvbGxlclsnJGluamVjdCddID0gWyckc2NvcGUnLCAnJHJvdXRlJ107CiAqCiAqICAgLy8gVGhlbgogKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICogYGBgCiAqCiAqICMgVGhlIGFycmF5IG5vdGF0aW9uCiAqCiAqIEl0IGlzIG9mdGVuIGRlc2lyYWJsZSB0byBpbmxpbmUgSW5qZWN0ZWQgZnVuY3Rpb25zIGFuZCB0aGF0J3Mgd2hlbiBzZXR0aW5nIHRoZSBgJGluamVjdGAgcHJvcGVydHkKICogaXMgdmVyeSBpbmNvbnZlbmllbnQuIEluIHRoZXNlIHNpdHVhdGlvbnMgdXNpbmcgdGhlIGFycmF5IG5vdGF0aW9uIHRvIHNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBpbgogKiBhIHdheSB0aGF0IHN1cnZpdmVzIG1pbmlmaWNhdGlvbiBpcyBhIGJldHRlciBjaG9pY2U6CiAqCiAqIGBgYGpzCiAqICAgLy8gV2Ugd2lzaCB0byB3cml0ZSB0aGlzIChub3QgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24gc2FmZSkKICogICBpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGNvbXBpbGUsICRyb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0pOwogKgogKiAgIC8vIFdlIGFyZSBmb3JjZWQgdG8gd3JpdGUgYnJlYWsgaW5saW5pbmcKICogICB2YXIgdG1wRm4gPSBmdW5jdGlvbihvYmZ1c2NhdGVkQ29tcGlsZSwgb2JmdXNjYXRlZFJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfTsKICogICB0bXBGbi4kaW5qZWN0ID0gWyckY29tcGlsZScsICckcm9vdFNjb3BlJ107CiAqICAgaW5qZWN0b3IuaW52b2tlKHRtcEZuKTsKICoKICogICAvLyBUbyBiZXR0ZXIgc3VwcG9ydCBpbmxpbmUgZnVuY3Rpb24gdGhlIGlubGluZSBhbm5vdGF0aW9uIGlzIHN1cHBvcnRlZAogKiAgIGluamVjdG9yLmludm9rZShbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZDb21waWxlLCBvYmZSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH1dKTsKICoKICogICAvLyBUaGVyZWZvcmUKICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoCiAqICAgICAgWyckY29tcGlsZScsICckcm9vdFNjb3BlJywgZnVuY3Rpb24ob2JmdXNfJGNvbXBpbGUsIG9iZnVzXyRyb290U2NvcGUpIHt9XSkKICogICAgKS50b0VxdWFsKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddKTsKICogYGBgCiAqCiAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXkuPHN0cmluZ3xGdW5jdGlvbj59IGZuIEZ1bmN0aW9uIGZvciB3aGljaCBkZXBlbmRlbnQgc2VydmljZSBuYW1lcyBuZWVkIHRvCiAqIGJlIHJldHJpZXZlZCBhcyBkZXNjcmliZWQgYWJvdmUuCiAqCiAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gVGhlIG5hbWVzIG9mIHRoZSBzZXJ2aWNlcyB3aGljaCB0aGUgZnVuY3Rpb24gcmVxdWlyZXMuCiAqLwoKCgoKLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgJHByb3ZpZGUKICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIFRoZSB7QGxpbmsgYXV0by4kcHJvdmlkZSAkcHJvdmlkZX0gc2VydmljZSBoYXMgYSBudW1iZXIgb2YgbWV0aG9kcyBmb3IgcmVnaXN0ZXJpbmcgY29tcG9uZW50cwogKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gTWFueSBvZiB0aGVzZSBmdW5jdGlvbnMgYXJlIGFsc28gZXhwb3NlZCBvbgogKiB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9LgogKgogKiBBbiBBbmd1bGFyICoqc2VydmljZSoqIGlzIGEgc2luZ2xldG9uIG9iamVjdCBjcmVhdGVkIGJ5IGEgKipzZXJ2aWNlIGZhY3RvcnkqKi4gIFRoZXNlICoqc2VydmljZQogKiBmYWN0b3JpZXMqKiBhcmUgZnVuY3Rpb25zIHdoaWNoLCBpbiB0dXJuLCBhcmUgY3JlYXRlZCBieSBhICoqc2VydmljZSBwcm92aWRlcioqLgogKiBUaGUgKipzZXJ2aWNlIHByb3ZpZGVycyoqIGFyZSBjb25zdHJ1Y3RvciBmdW5jdGlvbnMuIFdoZW4gaW5zdGFudGlhdGVkIHRoZXkgbXVzdCBjb250YWluIGEKICogcHJvcGVydHkgY2FsbGVkIGAkZ2V0YCwgd2hpY2ggaG9sZHMgdGhlICoqc2VydmljZSBmYWN0b3J5KiogZnVuY3Rpb24uCiAqCiAqIFdoZW4geW91IHJlcXVlc3QgYSBzZXJ2aWNlLCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0gaXMgcmVzcG9uc2libGUgZm9yIGZpbmRpbmcgdGhlCiAqIGNvcnJlY3QgKipzZXJ2aWNlIHByb3ZpZGVyKiosIGluc3RhbnRpYXRpbmcgaXQgYW5kIHRoZW4gY2FsbGluZyBpdHMgYCRnZXRgICoqc2VydmljZSBmYWN0b3J5KioKICogZnVuY3Rpb24gdG8gZ2V0IHRoZSBpbnN0YW5jZSBvZiB0aGUgKipzZXJ2aWNlKiouCiAqCiAqIE9mdGVuIHNlcnZpY2VzIGhhdmUgbm8gY29uZmlndXJhdGlvbiBvcHRpb25zIGFuZCB0aGVyZSBpcyBubyBuZWVkIHRvIGFkZCBtZXRob2RzIHRvIHRoZSBzZXJ2aWNlCiAqIHByb3ZpZGVyLiAgVGhlIHByb3ZpZGVyIHdpbGwgYmUgbm8gbW9yZSB0aGFuIGEgY29uc3RydWN0b3IgZnVuY3Rpb24gd2l0aCBhIGAkZ2V0YCBwcm9wZXJ0eS4gRm9yCiAqIHRoZXNlIGNhc2VzIHRoZSB7QGxpbmsgYXV0by4kcHJvdmlkZSAkcHJvdmlkZX0gc2VydmljZSBoYXMgYWRkaXRpb25hbCBoZWxwZXIgbWV0aG9kcyB0byByZWdpc3RlcgogKiBzZXJ2aWNlcyB3aXRob3V0IHNwZWNpZnlpbmcgYSBwcm92aWRlci4KICoKICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNwcm92aWRlciBwcm92aWRlcihwcm92aWRlcil9IC0gcmVnaXN0ZXJzIGEgKipzZXJ2aWNlIHByb3ZpZGVyKiogd2l0aCB0aGUKICogICAgIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9CiAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjY29uc3RhbnQgY29uc3RhbnQob2JqKX0gLSByZWdpc3RlcnMgYSB2YWx1ZS9vYmplY3QgdGhhdCBjYW4gYmUgYWNjZXNzZWQgYnkKICogICAgIHByb3ZpZGVycyBhbmQgc2VydmljZXMuCiAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjdmFsdWUgdmFsdWUob2JqKX0gLSByZWdpc3RlcnMgYSB2YWx1ZS9vYmplY3QgdGhhdCBjYW4gb25seSBiZSBhY2Nlc3NlZCBieQogKiAgICAgc2VydmljZXMsIG5vdCBwcm92aWRlcnMuCiAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjZmFjdG9yeSBmYWN0b3J5KGZuKX0gLSByZWdpc3RlcnMgYSBzZXJ2aWNlICoqZmFjdG9yeSBmdW5jdGlvbioqLCBgZm5gLAogKiAgICAgdGhhdCB3aWxsIGJlIHdyYXBwZWQgaW4gYSAqKnNlcnZpY2UgcHJvdmlkZXIqKiBvYmplY3QsIHdob3NlIGAkZ2V0YCBwcm9wZXJ0eSB3aWxsIGNvbnRhaW4gdGhlCiAqICAgICBnaXZlbiBmYWN0b3J5IGZ1bmN0aW9uLgogKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2Ugc2VydmljZShjbGFzcyl9IC0gcmVnaXN0ZXJzIGEgKipjb25zdHJ1Y3RvciBmdW5jdGlvbioqLCBgY2xhc3NgCiAqICAgICB0aGF0IHdpbGwgYmUgd3JhcHBlZCBpbiBhICoqc2VydmljZSBwcm92aWRlcioqIG9iamVjdCwgd2hvc2UgYCRnZXRgIHByb3BlcnR5IHdpbGwgaW5zdGFudGlhdGUKICogICAgICBhIG5ldyBvYmplY3QgdXNpbmcgdGhlIGdpdmVuIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogKgogKiBTZWUgdGhlIGluZGl2aWR1YWwgbWV0aG9kcyBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhbmQgZXhhbXBsZXMuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHByb3ZpZGUjcHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlZ2lzdGVyIGEgKipwcm92aWRlciBmdW5jdGlvbioqIHdpdGggdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBQcm92aWRlciBmdW5jdGlvbnMKICogYXJlIGNvbnN0cnVjdG9yIGZ1bmN0aW9ucywgd2hvc2UgaW5zdGFuY2VzIGFyZSByZXNwb25zaWJsZSBmb3IgInByb3ZpZGluZyIgYSBmYWN0b3J5IGZvciBhCiAqIHNlcnZpY2UuCiAqCiAqIFNlcnZpY2UgcHJvdmlkZXIgbmFtZXMgc3RhcnQgd2l0aCB0aGUgbmFtZSBvZiB0aGUgc2VydmljZSB0aGV5IHByb3ZpZGUgZm9sbG93ZWQgYnkgYFByb3ZpZGVyYC4KICogRm9yIGV4YW1wbGUsIHRoZSB7QGxpbmsgbmcuJGxvZyAkbG9nfSBzZXJ2aWNlIGhhcyBhIHByb3ZpZGVyIGNhbGxlZAogKiB7QGxpbmsgbmcuJGxvZ1Byb3ZpZGVyICRsb2dQcm92aWRlcn0uCiAqCiAqIFNlcnZpY2UgcHJvdmlkZXIgb2JqZWN0cyBjYW4gaGF2ZSBhZGRpdGlvbmFsIG1ldGhvZHMgd2hpY2ggYWxsb3cgY29uZmlndXJhdGlvbiBvZiB0aGUgcHJvdmlkZXIKICogYW5kIGl0cyBzZXJ2aWNlLiBJbXBvcnRhbnRseSwgeW91IGNhbiBjb25maWd1cmUgd2hhdCBraW5kIG9mIHNlcnZpY2UgaXMgY3JlYXRlZCBieSB0aGUgYCRnZXRgCiAqIG1ldGhvZCwgb3IgaG93IHRoYXQgc2VydmljZSB3aWxsIGFjdC4gRm9yIGV4YW1wbGUsIHRoZSB7QGxpbmsgbmcuJGxvZ1Byb3ZpZGVyICRsb2dQcm92aWRlcn0gaGFzIGEKICogbWV0aG9kIHtAbGluayBuZy4kbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkIGRlYnVnRW5hYmxlZH0KICogd2hpY2ggbGV0cyB5b3Ugc3BlY2lmeSB3aGV0aGVyIHRoZSB7QGxpbmsgbmcuJGxvZyAkbG9nfSBzZXJ2aWNlIHdpbGwgbG9nIGRlYnVnIG1lc3NhZ2VzIHRvIHRoZQogKiBjb25zb2xlIG9yIG5vdC4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLiBOT1RFOiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBhdmFpbGFibGUgdW5kZXIgYG5hbWUgKwogICAgICAgICAgICAgICAgICAgICAgICAnUHJvdmlkZXInYCBrZXkuCiAqIEBwYXJhbSB7KE9iamVjdHxmdW5jdGlvbigpKX0gcHJvdmlkZXIgSWYgdGhlIHByb3ZpZGVyIGlzOgogKgogKiAgIC0gYE9iamVjdGA6IHRoZW4gaXQgc2hvdWxkIGhhdmUgYSBgJGdldGAgbWV0aG9kLiBUaGUgYCRnZXRgIG1ldGhvZCB3aWxsIGJlIGludm9rZWQgdXNpbmcKICogICAgIHtAbGluayBhdXRvLiRpbmplY3RvciNpbnZva2UgJGluamVjdG9yLmludm9rZSgpfSB3aGVuIGFuIGluc3RhbmNlIG5lZWRzIHRvIGJlIGNyZWF0ZWQuCiAqICAgLSBgQ29uc3RydWN0b3JgOiBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBjcmVhdGVkIHVzaW5nCiAqICAgICB7QGxpbmsgYXV0by4kaW5qZWN0b3IjaW5zdGFudGlhdGUgJGluamVjdG9yLmluc3RhbnRpYXRlKCl9LCB0aGVuIHRyZWF0ZWQgYXMgYG9iamVjdGAuCiAqCiAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKCiAqIEBleGFtcGxlCiAqCiAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gY3JlYXRlIGEgc2ltcGxlIGV2ZW50IHRyYWNraW5nIHNlcnZpY2UgYW5kIHJlZ2lzdGVyIGl0IHVzaW5nCiAqIHtAbGluayBhdXRvLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogKgogKiBgYGBqcwogKiAgLy8gRGVmaW5lIHRoZSBldmVudFRyYWNrZXIgcHJvdmlkZXIKICogIGZ1bmN0aW9uIEV2ZW50VHJhY2tlclByb3ZpZGVyKCkgewogKiAgICB2YXIgdHJhY2tpbmdVcmwgPSAnL3RyYWNrJzsKICoKICogICAgLy8gQSBwcm92aWRlciBtZXRob2QgZm9yIGNvbmZpZ3VyaW5nIHdoZXJlIHRoZSB0cmFja2VkIGV2ZW50cyBzaG91bGQgYmVlbiBzYXZlZAogKiAgICB0aGlzLnNldFRyYWNraW5nVXJsID0gZnVuY3Rpb24odXJsKSB7CiAqICAgICAgdHJhY2tpbmdVcmwgPSB1cmw7CiAqICAgIH07CiAqCiAqICAgIC8vIFRoZSBzZXJ2aWNlIGZhY3RvcnkgZnVuY3Rpb24KICogICAgdGhpcy4kZ2V0ID0gWyckaHR0cCcsIGZ1bmN0aW9uKCRodHRwKSB7CiAqICAgICAgdmFyIHRyYWNrZWRFdmVudHMgPSB7fTsKICogICAgICByZXR1cm4gewogKiAgICAgICAgLy8gQ2FsbCB0aGlzIHRvIHRyYWNrIGFuIGV2ZW50CiAqICAgICAgICBldmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICogICAgICAgICAgdmFyIGNvdW50ID0gdHJhY2tlZEV2ZW50c1tldmVudF0gfHwgMDsKICogICAgICAgICAgY291bnQgKz0gMTsKICogICAgICAgICAgdHJhY2tlZEV2ZW50c1tldmVudF0gPSBjb3VudDsKICogICAgICAgICAgcmV0dXJuIGNvdW50OwogKiAgICAgICAgfSwKICogICAgICAgIC8vIENhbGwgdGhpcyB0byBzYXZlIHRoZSB0cmFja2VkIGV2ZW50cyB0byB0aGUgdHJhY2tpbmdVcmwKICogICAgICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAkaHR0cC5wb3N0KHRyYWNraW5nVXJsLCB0cmFja2VkRXZlbnRzKTsKICogICAgICAgIH0KICogICAgICB9OwogKiAgICB9XTsKICogIH0KICoKICogIGRlc2NyaWJlKCdldmVudFRyYWNrZXInLCBmdW5jdGlvbigpIHsKICogICAgdmFyIHBvc3RTcHk7CiAqCiAqICAgIGJlZm9yZUVhY2gobW9kdWxlKGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAqICAgICAgLy8gUmVnaXN0ZXIgdGhlIGV2ZW50VHJhY2tlciBwcm92aWRlcgogKiAgICAgICRwcm92aWRlLnByb3ZpZGVyKCdldmVudFRyYWNrZXInLCBFdmVudFRyYWNrZXJQcm92aWRlcik7CiAqICAgIH0pKTsKICoKICogICAgYmVmb3JlRWFjaChtb2R1bGUoZnVuY3Rpb24oZXZlbnRUcmFja2VyUHJvdmlkZXIpIHsKICogICAgICAvLyBDb25maWd1cmUgZXZlbnRUcmFja2VyIHByb3ZpZGVyCiAqICAgICAgZXZlbnRUcmFja2VyUHJvdmlkZXIuc2V0VHJhY2tpbmdVcmwoJy9jdXN0b20tdHJhY2snKTsKICogICAgfSkpOwogKgogKiAgICBpdCgndHJhY2tzIGV2ZW50cycsIGluamVjdChmdW5jdGlvbihldmVudFRyYWNrZXIpIHsKICogICAgICBleHBlY3QoZXZlbnRUcmFja2VyLmV2ZW50KCdsb2dpbicpKS50b0VxdWFsKDEpOwogKiAgICAgIGV4cGVjdChldmVudFRyYWNrZXIuZXZlbnQoJ2xvZ2luJykpLnRvRXF1YWwoMik7CiAqICAgIH0pKTsKICoKICogICAgaXQoJ3NhdmVzIHRvIHRoZSB0cmFja2luZyB1cmwnLCBpbmplY3QoZnVuY3Rpb24oZXZlbnRUcmFja2VyLCAkaHR0cCkgewogKiAgICAgIHBvc3RTcHkgPSBzcHlPbigkaHR0cCwgJ3Bvc3QnKTsKICogICAgICBldmVudFRyYWNrZXIuZXZlbnQoJ2xvZ2luJyk7CiAqICAgICAgZXZlbnRUcmFja2VyLnNhdmUoKTsKICogICAgICBleHBlY3QocG9zdFNweSkudG9IYXZlQmVlbkNhbGxlZCgpOwogKiAgICAgIGV4cGVjdChwb3N0U3B5Lm1vc3RSZWNlbnRDYWxsLmFyZ3NbMF0pLm5vdC50b0VxdWFsKCcvdHJhY2snKTsKICogICAgICBleHBlY3QocG9zdFNweS5tb3N0UmVjZW50Q2FsbC5hcmdzWzBdKS50b0VxdWFsKCcvY3VzdG9tLXRyYWNrJyk7CiAqICAgICAgZXhwZWN0KHBvc3RTcHkubW9zdFJlY2VudENhbGwuYXJnc1sxXSkudG9FcXVhbCh7ICdsb2dpbic6IDEgfSk7CiAqICAgIH0pKTsKICogIH0pOwogKiBgYGAKICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSNmYWN0b3J5CiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWdpc3RlciBhICoqc2VydmljZSBmYWN0b3J5KiosIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHRvIHJldHVybiB0aGUgc2VydmljZSBpbnN0YW5jZS4KICogVGhpcyBpcyBzaG9ydCBmb3IgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlIHdoZXJlIGl0cyBwcm92aWRlciBjb25zaXN0cyBvZiBvbmx5IGEgYCRnZXRgIHByb3BlcnR5LAogKiB3aGljaCBpcyB0aGUgZ2l2ZW4gc2VydmljZSBmYWN0b3J5IGZ1bmN0aW9uLgogKiBZb3Ugc2hvdWxkIHVzZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoZ2V0Rm4pfSBpZiB5b3UgZG8gbm90IG5lZWQgdG8KICogY29uZmlndXJlIHlvdXIgc2VydmljZSBpbiBhIHByb3ZpZGVyLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gJGdldEZuIFRoZSAkZ2V0Rm4gZm9yIHRoZSBpbnN0YW5jZSBjcmVhdGlvbi4gSW50ZXJuYWxseSB0aGlzIGlzIGEgc2hvcnQgaGFuZAogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgYCRwcm92aWRlLnByb3ZpZGVyKG5hbWUsIHskZ2V0OiAkZ2V0Rm59KWAuCiAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICoKICogQGV4YW1wbGUKICogSGVyZSBpcyBhbiBleGFtcGxlIG9mIHJlZ2lzdGVyaW5nIGEgc2VydmljZQogKiBgYGBqcwogKiAgICRwcm92aWRlLmZhY3RvcnkoJ3BpbmcnLCBbJyRodHRwJywgZnVuY3Rpb24oJGh0dHApIHsKICogICAgIHJldHVybiBmdW5jdGlvbiBwaW5nKCkgewogKiAgICAgICByZXR1cm4gJGh0dHAuc2VuZCgnL3BpbmcnKTsKICogICAgIH07CiAqICAgfV0pOwogKiBgYGAKICogWW91IHdvdWxkIHRoZW4gaW5qZWN0IGFuZCB1c2UgdGhpcyBzZXJ2aWNlIGxpa2UgdGhpczoKICogYGBganMKICogICBzb21lTW9kdWxlLmNvbnRyb2xsZXIoJ0N0cmwnLCBbJ3BpbmcnLCBmdW5jdGlvbihwaW5nKSB7CiAqICAgICBwaW5nKCk7CiAqICAgfV0pOwogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHByb3ZpZGUjc2VydmljZQogKiBAZGVzY3JpcHRpb24KICoKICogUmVnaXN0ZXIgYSAqKnNlcnZpY2UgY29uc3RydWN0b3IqKiwgd2hpY2ggd2lsbCBiZSBpbnZva2VkIHdpdGggYG5ld2AgdG8gY3JlYXRlIHRoZSBzZXJ2aWNlCiAqIGluc3RhbmNlLgogKiBUaGlzIGlzIHNob3J0IGZvciByZWdpc3RlcmluZyBhIHNlcnZpY2Ugd2hlcmUgaXRzIHByb3ZpZGVyJ3MgYCRnZXRgIHByb3BlcnR5IGlzIHRoZSBzZXJ2aWNlCiAqIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGluc3RhbnRpYXRlIHRoZSBzZXJ2aWNlIGluc3RhbmNlLgogKgogKiBZb3Ugc2hvdWxkIHVzZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoY2xhc3MpfSBpZiB5b3UgZGVmaW5lIHlvdXIgc2VydmljZQogKiBhcyBhIHR5cGUvY2xhc3MuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjbGFzcyAoY29uc3RydWN0b3IgZnVuY3Rpb24pIHRoYXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuCiAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICoKICogQGV4YW1wbGUKICogSGVyZSBpcyBhbiBleGFtcGxlIG9mIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB1c2luZwogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoY2xhc3MpfS4KICogYGBganMKICogICB2YXIgUGluZyA9IGZ1bmN0aW9uKCRodHRwKSB7CiAqICAgICB0aGlzLiRodHRwID0gJGh0dHA7CiAqICAgfTsKICoKICogICBQaW5nLiRpbmplY3QgPSBbJyRodHRwJ107CiAqCiAqICAgUGluZy5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKCkgewogKiAgICAgcmV0dXJuIHRoaXMuJGh0dHAuZ2V0KCcvcGluZycpOwogKiAgIH07CiAqICAgJHByb3ZpZGUuc2VydmljZSgncGluZycsIFBpbmcpOwogKiBgYGAKICogWW91IHdvdWxkIHRoZW4gaW5qZWN0IGFuZCB1c2UgdGhpcyBzZXJ2aWNlIGxpa2UgdGhpczoKICogYGBganMKICogICBzb21lTW9kdWxlLmNvbnRyb2xsZXIoJ0N0cmwnLCBbJ3BpbmcnLCBmdW5jdGlvbihwaW5nKSB7CiAqICAgICBwaW5nLnNlbmQoKTsKICogICB9XSk7CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSN2YWx1ZQogKiBAZGVzY3JpcHRpb24KICoKICogUmVnaXN0ZXIgYSAqKnZhbHVlIHNlcnZpY2UqKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfSwgc3VjaCBhcyBhIHN0cmluZywgYQogKiBudW1iZXIsIGFuIGFycmF5LCBhbiBvYmplY3Qgb3IgYSBmdW5jdGlvbi4gIFRoaXMgaXMgc2hvcnQgZm9yIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB3aGVyZSBpdHMKICogcHJvdmlkZXIncyBgJGdldGAgcHJvcGVydHkgaXMgYSBmYWN0b3J5IGZ1bmN0aW9uIHRoYXQgdGFrZXMgbm8gYXJndW1lbnRzIGFuZCByZXR1cm5zIHRoZSAqKnZhbHVlCiAqIHNlcnZpY2UqKi4KICoKICogVmFsdWUgc2VydmljZXMgYXJlIHNpbWlsYXIgdG8gY29uc3RhbnQgc2VydmljZXMsIGV4Y2VwdCB0aGF0IHRoZXkgY2Fubm90IGJlIGluamVjdGVkIGludG8gYQogKiBtb2R1bGUgY29uZmlndXJhdGlvbiBmdW5jdGlvbiAoc2VlIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWd9KSBidXQgdGhleSBjYW4gYmUgb3ZlcnJpZGRlbiBieQogKiBhbiBBbmd1bGFyCiAqIHtAbGluayBhdXRvLiRwcm92aWRlI2RlY29yYXRvciBkZWNvcmF0b3J9LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlLgogKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUgYXJlIHNvbWUgZXhhbXBsZXMgb2YgY3JlYXRpbmcgdmFsdWUgc2VydmljZXMuCiAqIGBgYGpzCiAqICAgJHByb3ZpZGUudmFsdWUoJ0FETUlOX1VTRVInLCAnYWRtaW4nKTsKICoKICogICAkcHJvdmlkZS52YWx1ZSgnUm9sZUxvb2t1cCcsIHsgYWRtaW46IDAsIHdyaXRlcjogMSwgcmVhZGVyOiAyIH0pOwogKgogKiAgICRwcm92aWRlLnZhbHVlKCdoYWxmT2YnLCBmdW5jdGlvbih2YWx1ZSkgewogKiAgICAgcmV0dXJuIHZhbHVlIC8gMjsKICogICB9KTsKICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRwcm92aWRlI2NvbnN0YW50CiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWdpc3RlciBhICoqY29uc3RhbnQgc2VydmljZSoqLCBzdWNoIGFzIGEgc3RyaW5nLCBhIG51bWJlciwgYW4gYXJyYXksIGFuIG9iamVjdCBvciBhIGZ1bmN0aW9uLAogKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gVW5saWtlIHtAbGluayBhdXRvLiRwcm92aWRlI3ZhbHVlIHZhbHVlfSBpdCBjYW4gYmUKICogaW5qZWN0ZWQgaW50byBhIG1vZHVsZSBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIChzZWUge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZ30pIGFuZCBpdCBjYW5ub3QKICogYmUgb3ZlcnJpZGRlbiBieSBhbiBBbmd1bGFyIHtAbGluayBhdXRvLiRwcm92aWRlI2RlY29yYXRvciBkZWNvcmF0b3J9LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgY29uc3RhbnQuCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIGNvbnN0YW50IHZhbHVlLgogKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIGluc3RhbmNlCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUgYSBzb21lIGV4YW1wbGVzIG9mIGNyZWF0aW5nIGNvbnN0YW50czoKICogYGBganMKICogICAkcHJvdmlkZS5jb25zdGFudCgnU0hBUkRfSEVJR0hUJywgMzA2KTsKICoKICogICAkcHJvdmlkZS5jb25zdGFudCgnTVlfQ09MT1VSUycsIFsncmVkJywgJ2JsdWUnLCAnZ3JleSddKTsKICoKICogICAkcHJvdmlkZS5jb25zdGFudCgnZG91YmxlJywgZnVuY3Rpb24odmFsdWUpIHsKICogICAgIHJldHVybiB2YWx1ZSAqIDI7CiAqICAgfSk7CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSNkZWNvcmF0b3IKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlZ2lzdGVyIGEgKipzZXJ2aWNlIGRlY29yYXRvcioqIHdpdGggdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBBIHNlcnZpY2UgZGVjb3JhdG9yCiAqIGludGVyY2VwdHMgdGhlIGNyZWF0aW9uIG9mIGEgc2VydmljZSwgYWxsb3dpbmcgaXQgdG8gb3ZlcnJpZGUgb3IgbW9kaWZ5IHRoZSBiZWhhdmlvdXIgb2YgdGhlCiAqIHNlcnZpY2UuIFRoZSBvYmplY3QgcmV0dXJuZWQgYnkgdGhlIGRlY29yYXRvciBtYXkgYmUgdGhlIG9yaWdpbmFsIHNlcnZpY2UsIG9yIGEgbmV3IHNlcnZpY2UKICogb2JqZWN0IHdoaWNoIHJlcGxhY2VzIG9yIHdyYXBzIGFuZCBkZWxlZ2F0ZXMgdG8gdGhlIG9yaWdpbmFsIHNlcnZpY2UuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNlIHRvIGRlY29yYXRlLgogKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGRlY29yYXRvciBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSBzZXJ2aWNlIG5lZWRzIHRvIGJlCiAqICAgIGluc3RhbnRpYXRlZCBhbmQgc2hvdWxkIHJldHVybiB0aGUgZGVjb3JhdGVkIHNlcnZpY2UgaW5zdGFuY2UuIFRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgdXNpbmcKICogICAgdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciNpbnZva2UgaW5qZWN0b3IuaW52b2tlfSBtZXRob2QgYW5kIGlzIHRoZXJlZm9yZSBmdWxseSBpbmplY3RhYmxlLgogKiAgICBMb2NhbCBpbmplY3Rpb24gYXJndW1lbnRzOgogKgogKiAgICAqIGAkZGVsZWdhdGVgIC0gVGhlIG9yaWdpbmFsIHNlcnZpY2UgaW5zdGFuY2UsIHdoaWNoIGNhbiBiZSBtb25rZXkgcGF0Y2hlZCwgY29uZmlndXJlZCwKICogICAgICBkZWNvcmF0ZWQgb3IgZGVsZWdhdGVkIHRvLgogKgogKiBAZXhhbXBsZQogKiBIZXJlIHdlIGRlY29yYXRlIHRoZSB7QGxpbmsgbmcuJGxvZyAkbG9nfSBzZXJ2aWNlIHRvIGNvbnZlcnQgd2FybmluZ3MgdG8gZXJyb3JzIGJ5IGludGVyY2VwdGluZwogKiBjYWxscyB0byB7QGxpbmsgbmcuJGxvZyNlcnJvciAkbG9nLndhcm4oKX0uCiAqIGBgYGpzCiAqICAgJHByb3ZpZGUuZGVjb3JhdG9yKCckbG9nJywgWyckZGVsZWdhdGUnLCBmdW5jdGlvbigkZGVsZWdhdGUpIHsKICogICAgICRkZWxlZ2F0ZS53YXJuID0gJGRlbGVnYXRlLmVycm9yOwogKiAgICAgcmV0dXJuICRkZWxlZ2F0ZTsKICogICB9XSk7CiAqIGBgYAogKi8KCgpmdW5jdGlvbiBjcmVhdGVJbmplY3Rvcihtb2R1bGVzVG9Mb2FkKSB7CiAgdmFyIElOU1RBTlRJQVRJTkcgPSB7fSwKICAgICAgcHJvdmlkZXJTdWZmaXggPSAnUHJvdmlkZXInLAogICAgICBwYXRoID0gW10sCiAgICAgIGxvYWRlZE1vZHVsZXMgPSBuZXcgSGFzaE1hcCgpLAogICAgICBwcm92aWRlckNhY2hlID0gewogICAgICAgICRwcm92aWRlOiB7CiAgICAgICAgICAgIHByb3ZpZGVyOiBzdXBwb3J0T2JqZWN0KHByb3ZpZGVyKSwKICAgICAgICAgICAgZmFjdG9yeTogc3VwcG9ydE9iamVjdChmYWN0b3J5KSwKICAgICAgICAgICAgc2VydmljZTogc3VwcG9ydE9iamVjdChzZXJ2aWNlKSwKICAgICAgICAgICAgdmFsdWU6IHN1cHBvcnRPYmplY3QodmFsdWUpLAogICAgICAgICAgICBjb25zdGFudDogc3VwcG9ydE9iamVjdChjb25zdGFudCksCiAgICAgICAgICAgIGRlY29yYXRvcjogZGVjb3JhdG9yCiAgICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByb3ZpZGVySW5qZWN0b3IgPSAocHJvdmlkZXJDYWNoZS4kaW5qZWN0b3IgPQogICAgICAgICAgY3JlYXRlSW50ZXJuYWxJbmplY3Rvcihwcm92aWRlckNhY2hlLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCd1bnByJywgIlVua25vd24gcHJvdmlkZXI6IHswfSIsIHBhdGguam9pbignIDwtICcpKTsKICAgICAgICAgIH0pKSwKICAgICAgaW5zdGFuY2VDYWNoZSA9IHt9LAogICAgICBpbnN0YW5jZUluamVjdG9yID0gKGluc3RhbmNlQ2FjaGUuJGluamVjdG9yID0KICAgICAgICAgIGNyZWF0ZUludGVybmFsSW5qZWN0b3IoaW5zdGFuY2VDYWNoZSwgZnVuY3Rpb24oc2VydmljZW5hbWUpIHsKICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gcHJvdmlkZXJJbmplY3Rvci5nZXQoc2VydmljZW5hbWUgKyBwcm92aWRlclN1ZmZpeCk7CiAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yLmludm9rZShwcm92aWRlci4kZ2V0LCBwcm92aWRlcik7CiAgICAgICAgICB9KSk7CgoKICBmb3JFYWNoKGxvYWRNb2R1bGVzKG1vZHVsZXNUb0xvYWQpLCBmdW5jdGlvbihmbikgeyBpbnN0YW5jZUluamVjdG9yLmludm9rZShmbiB8fCBub29wKTsgfSk7CgogIHJldHVybiBpbnN0YW5jZUluamVjdG9yOwoKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyAkcHJvdmlkZXIKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgZnVuY3Rpb24gc3VwcG9ydE9iamVjdChkZWxlZ2F0ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGlzT2JqZWN0KGtleSkpIHsKICAgICAgICBmb3JFYWNoKGtleSwgcmV2ZXJzZVBhcmFtcyhkZWxlZ2F0ZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkZWxlZ2F0ZShrZXksIHZhbHVlKTsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIHByb3ZpZGVyKG5hbWUsIHByb3ZpZGVyXykgewogICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ3NlcnZpY2UnKTsKICAgIGlmIChpc0Z1bmN0aW9uKHByb3ZpZGVyXykgfHwgaXNBcnJheShwcm92aWRlcl8pKSB7CiAgICAgIHByb3ZpZGVyXyA9IHByb3ZpZGVySW5qZWN0b3IuaW5zdGFudGlhdGUocHJvdmlkZXJfKTsKICAgIH0KICAgIGlmICghcHJvdmlkZXJfLiRnZXQpIHsKICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCdwZ2V0JywgIlByb3ZpZGVyICd7MH0nIG11c3QgZGVmaW5lICRnZXQgZmFjdG9yeSBtZXRob2QuIiwgbmFtZSk7CiAgICB9CiAgICByZXR1cm4gcHJvdmlkZXJDYWNoZVtuYW1lICsgcHJvdmlkZXJTdWZmaXhdID0gcHJvdmlkZXJfOwogIH0KCiAgZnVuY3Rpb24gZmFjdG9yeShuYW1lLCBmYWN0b3J5Rm4pIHsgcmV0dXJuIHByb3ZpZGVyKG5hbWUsIHsgJGdldDogZmFjdG9yeUZuIH0pOyB9CgogIGZ1bmN0aW9uIHNlcnZpY2UobmFtZSwgY29uc3RydWN0b3IpIHsKICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IpOwogICAgfV0pOwogIH0KCiAgZnVuY3Rpb24gdmFsdWUobmFtZSwgdmFsKSB7IHJldHVybiBmYWN0b3J5KG5hbWUsIHZhbHVlRm4odmFsKSk7IH0KCiAgZnVuY3Rpb24gY29uc3RhbnQobmFtZSwgdmFsdWUpIHsKICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdjb25zdGFudCcpOwogICAgcHJvdmlkZXJDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgaW5zdGFuY2VDYWNoZVtuYW1lXSA9IHZhbHVlOwogIH0KCiAgZnVuY3Rpb24gZGVjb3JhdG9yKHNlcnZpY2VOYW1lLCBkZWNvckZuKSB7CiAgICB2YXIgb3JpZ1Byb3ZpZGVyID0gcHJvdmlkZXJJbmplY3Rvci5nZXQoc2VydmljZU5hbWUgKyBwcm92aWRlclN1ZmZpeCksCiAgICAgICAgb3JpZyRnZXQgPSBvcmlnUHJvdmlkZXIuJGdldDsKCiAgICBvcmlnUHJvdmlkZXIuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3JpZ0luc3RhbmNlID0gaW5zdGFuY2VJbmplY3Rvci5pbnZva2Uob3JpZyRnZXQsIG9yaWdQcm92aWRlcik7CiAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yLmludm9rZShkZWNvckZuLCBudWxsLCB7JGRlbGVnYXRlOiBvcmlnSW5zdGFuY2V9KTsKICAgIH07CiAgfQoKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBNb2R1bGUgTG9hZGluZwogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIGZ1bmN0aW9uIGxvYWRNb2R1bGVzKG1vZHVsZXNUb0xvYWQpewogICAgdmFyIHJ1bkJsb2NrcyA9IFtdLCBtb2R1bGVGbiwgaW52b2tlUXVldWUsIGksIGlpOwogICAgZm9yRWFjaChtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbihtb2R1bGUpIHsKICAgICAgaWYgKGxvYWRlZE1vZHVsZXMuZ2V0KG1vZHVsZSkpIHJldHVybjsKICAgICAgbG9hZGVkTW9kdWxlcy5wdXQobW9kdWxlLCB0cnVlKTsKCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGlzU3RyaW5nKG1vZHVsZSkpIHsKICAgICAgICAgIG1vZHVsZUZuID0gYW5ndWxhck1vZHVsZShtb2R1bGUpOwogICAgICAgICAgcnVuQmxvY2tzID0gcnVuQmxvY2tzLmNvbmNhdChsb2FkTW9kdWxlcyhtb2R1bGVGbi5yZXF1aXJlcykpLmNvbmNhdChtb2R1bGVGbi5fcnVuQmxvY2tzKTsKCiAgICAgICAgICBmb3IoaW52b2tlUXVldWUgPSBtb2R1bGVGbi5faW52b2tlUXVldWUsIGkgPSAwLCBpaSA9IGludm9rZVF1ZXVlLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgdmFyIGludm9rZUFyZ3MgPSBpbnZva2VRdWV1ZVtpXSwKICAgICAgICAgICAgICAgIHByb3ZpZGVyID0gcHJvdmlkZXJJbmplY3Rvci5nZXQoaW52b2tlQXJnc1swXSk7CgogICAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKG1vZHVsZSkpIHsKICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KG1vZHVsZSkpIHsKICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFzc2VydEFyZ0ZuKG1vZHVsZSwgJ21vZHVsZScpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChpc0FycmF5KG1vZHVsZSkpIHsKICAgICAgICAgIG1vZHVsZSA9IG1vZHVsZVttb2R1bGUubGVuZ3RoIC0gMV07CiAgICAgICAgfQogICAgICAgIGlmIChlLm1lc3NhZ2UgJiYgZS5zdGFjayAmJiBlLnN0YWNrLmluZGV4T2YoZS5tZXNzYWdlKSA9PSAtMSkgewogICAgICAgICAgLy8gU2FmYXJpICYgRkYncyBzdGFjayB0cmFjZXMgZG9uJ3QgY29udGFpbiBlcnJvci5tZXNzYWdlIGNvbnRlbnQKICAgICAgICAgIC8vIHVubGlrZSB0aG9zZSBvZiBDaHJvbWUgYW5kIElFCiAgICAgICAgICAvLyBTbyBpZiBzdGFjayBkb2Vzbid0IGNvbnRhaW4gbWVzc2FnZSwgd2UgY3JlYXRlIGEgbmV3IHN0cmluZyB0aGF0IGNvbnRhaW5zIGJvdGguCiAgICAgICAgICAvLyBTaW5jZSBlcnJvci5zdGFjayBpcyByZWFkLW9ubHkgaW4gU2FmYXJpLCBJJ20gb3ZlcnJpZGluZyBlIGFuZCBub3QgZS5zdGFjayBoZXJlLgogICAgICAgICAgLyoganNoaW50IC1XMDIyICovCiAgICAgICAgICBlID0gZS5tZXNzYWdlICsgJ1xuJyArIGUuc3RhY2s7CiAgICAgICAgfQogICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignbW9kdWxlcnInLCAiRmFpbGVkIHRvIGluc3RhbnRpYXRlIG1vZHVsZSB7MH0gZHVlIHRvOlxuezF9IiwKICAgICAgICAgICAgICAgICAgbW9kdWxlLCBlLnN0YWNrIHx8IGUubWVzc2FnZSB8fCBlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcnVuQmxvY2tzOwogIH0KCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gaW50ZXJuYWwgSW5qZWN0b3IKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgZnVuY3Rpb24gY3JlYXRlSW50ZXJuYWxJbmplY3RvcihjYWNoZSwgZmFjdG9yeSkgewoKICAgIGZ1bmN0aW9uIGdldFNlcnZpY2Uoc2VydmljZU5hbWUpIHsKICAgICAgaWYgKGNhY2hlLmhhc093blByb3BlcnR5KHNlcnZpY2VOYW1lKSkgewogICAgICAgIGlmIChjYWNoZVtzZXJ2aWNlTmFtZV0gPT09IElOU1RBTlRJQVRJTkcpIHsKICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignY2RlcCcsICdDaXJjdWxhciBkZXBlbmRlbmN5IGZvdW5kOiB7MH0nLCBwYXRoLmpvaW4oJyA8LSAnKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYWNoZVtzZXJ2aWNlTmFtZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHBhdGgudW5zaGlmdChzZXJ2aWNlTmFtZSk7CiAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgcmV0dXJuIGNhY2hlW3NlcnZpY2VOYW1lXSA9IGZhY3Rvcnkoc2VydmljZU5hbWUpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgaWYgKGNhY2hlW3NlcnZpY2VOYW1lXSA9PT0gSU5TVEFOVElBVElORykgewogICAgICAgICAgICBkZWxldGUgY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBwYXRoLnNoaWZ0KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpewogICAgICB2YXIgYXJncyA9IFtdLAogICAgICAgICAgJGluamVjdCA9IGFubm90YXRlKGZuKSwKICAgICAgICAgIGxlbmd0aCwgaSwKICAgICAgICAgIGtleTsKCiAgICAgIGZvcihpID0gMCwgbGVuZ3RoID0gJGluamVjdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGtleSA9ICRpbmplY3RbaV07CiAgICAgICAgaWYgKHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ2l0a24nLAogICAgICAgICAgICAgICAgICAnSW5jb3JyZWN0IGluamVjdGlvbiB0b2tlbiEgRXhwZWN0ZWQgc2VydmljZSBuYW1lIGFzIHN0cmluZywgZ290IHswfScsIGtleSk7CiAgICAgICAgfQogICAgICAgIGFyZ3MucHVzaCgKICAgICAgICAgIGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5KQogICAgICAgICAgPyBsb2NhbHNba2V5XQogICAgICAgICAgOiBnZXRTZXJ2aWNlKGtleSkKICAgICAgICApOwogICAgICB9CiAgICAgIGlmICghZm4uJGluamVjdCkgewogICAgICAgIC8vIHRoaXMgbWVhbnMgdGhhdCB3ZSBtdXN0IGJlIGFuIGFycmF5LgogICAgICAgIGZuID0gZm5bbGVuZ3RoXTsKICAgICAgfQoKICAgICAgLy8gaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhcmpzLWludm9rZS1hcHBseS12cy1zd2l0Y2gKICAgICAgLy8gIzUzODgKICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgfQoKICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlKFR5cGUsIGxvY2FscykgewogICAgICB2YXIgQ29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHt9LAogICAgICAgICAgaW5zdGFuY2UsIHJldHVybmVkVmFsdWU7CgogICAgICAvLyBDaGVjayBpZiBUeXBlIGlzIGFubm90YXRlZCBhbmQgdXNlIGp1c3QgdGhlIGdpdmVuIGZ1bmN0aW9uIGF0IG4tMSBhcyBwYXJhbWV0ZXIKICAgICAgLy8gZS5nLiBzb21lTW9kdWxlLmZhY3RvcnkoJ2dyZWV0ZXInLCBbJyR3aW5kb3cnLCBmdW5jdGlvbihyZW5hbWVkJHdpbmRvdykge31dKTsKICAgICAgQ29uc3RydWN0b3IucHJvdG90eXBlID0gKGlzQXJyYXkoVHlwZSkgPyBUeXBlW1R5cGUubGVuZ3RoIC0gMV0gOiBUeXBlKS5wcm90b3R5cGU7CiAgICAgIGluc3RhbmNlID0gbmV3IENvbnN0cnVjdG9yKCk7CiAgICAgIHJldHVybmVkVmFsdWUgPSBpbnZva2UoVHlwZSwgaW5zdGFuY2UsIGxvY2Fscyk7CgogICAgICByZXR1cm4gaXNPYmplY3QocmV0dXJuZWRWYWx1ZSkgfHwgaXNGdW5jdGlvbihyZXR1cm5lZFZhbHVlKSA/IHJldHVybmVkVmFsdWUgOiBpbnN0YW5jZTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBpbnZva2U6IGludm9rZSwKICAgICAgaW5zdGFudGlhdGU6IGluc3RhbnRpYXRlLAogICAgICBnZXQ6IGdldFNlcnZpY2UsCiAgICAgIGFubm90YXRlOiBhbm5vdGF0ZSwKICAgICAgaGFzOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGUuaGFzT3duUHJvcGVydHkobmFtZSArIHByb3ZpZGVyU3VmZml4KSB8fCBjYWNoZS5oYXNPd25Qcm9wZXJ0eShuYW1lKTsKICAgICAgfQogICAgfTsKICB9Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkYW5jaG9yU2Nyb2xsCiAqIEBraW5kIGZ1bmN0aW9uCiAqIEByZXF1aXJlcyAkd2luZG93CiAqIEByZXF1aXJlcyAkbG9jYXRpb24KICogQHJlcXVpcmVzICRyb290U2NvcGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFdoZW4gY2FsbGVkLCBpdCBjaGVja3MgY3VycmVudCB2YWx1ZSBvZiBgJGxvY2F0aW9uLmhhc2goKWAgYW5kIHNjcm9sbHMgdG8gdGhlIHJlbGF0ZWQgZWxlbWVudCwKICogYWNjb3JkaW5nIHRvIHJ1bGVzIHNwZWNpZmllZCBpbgogKiBbSHRtbDUgc3BlY10oaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI3RoZS1pbmRpY2F0ZWQtcGFydC1vZi10aGUtZG9jdW1lbnQpLgogKgogKiBJdCBhbHNvIHdhdGNoZXMgdGhlIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xscyB3aGVuZXZlciBpdCBjaGFuZ2VzIHRvIG1hdGNoIGFueSBhbmNob3IuCiAqIFRoaXMgY2FuIGJlIGRpc2FibGVkIGJ5IGNhbGxpbmcgYCRhbmNob3JTY3JvbGxQcm92aWRlci5kaXNhYmxlQXV0b1Njcm9sbGluZygpYC4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IGlkPSJzY3JvbGxBcmVhIiBuZy1jb250cm9sbGVyPSJTY3JvbGxDdHJsIj4KICAgICAgICAgPGEgbmctY2xpY2s9ImdvdG9Cb3R0b20oKSI+R28gdG8gYm90dG9tPC9hPgogICAgICAgICA8YSBpZD0iYm90dG9tIj48L2E+IFlvdSdyZSBhdCB0aGUgYm90dG9tIQogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICBmdW5jdGlvbiBTY3JvbGxDdHJsKCRzY29wZSwgJGxvY2F0aW9uLCAkYW5jaG9yU2Nyb2xsKSB7CiAgICAgICAgICRzY29wZS5nb3RvQm90dG9tID0gZnVuY3Rpb24gKCl7CiAgICAgICAgICAgLy8gc2V0IHRoZSBsb2NhdGlvbi5oYXNoIHRvIHRoZSBpZCBvZgogICAgICAgICAgIC8vIHRoZSBlbGVtZW50IHlvdSB3aXNoIHRvIHNjcm9sbCB0by4KICAgICAgICAgICAkbG9jYXRpb24uaGFzaCgnYm90dG9tJyk7CgogICAgICAgICAgIC8vIGNhbGwgJGFuY2hvclNjcm9sbCgpCiAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICB9OwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgI3Njcm9sbEFyZWEgewogICAgICAgICBoZWlnaHQ6IDM1MHB4OwogICAgICAgICBvdmVyZmxvdzogYXV0bzsKICAgICAgIH0KCiAgICAgICAjYm90dG9tIHsKICAgICAgICAgZGlzcGxheTogYmxvY2s7CiAgICAgICAgIG1hcmdpbi10b3A6IDIwMDBweDsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uICRBbmNob3JTY3JvbGxQcm92aWRlcigpIHsKCiAgdmFyIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gdHJ1ZTsKCiAgdGhpcy5kaXNhYmxlQXV0b1Njcm9sbGluZyA9IGZ1bmN0aW9uKCkgewogICAgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSBmYWxzZTsKICB9OwoKICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGxvY2F0aW9uJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbigkd2luZG93LCAkbG9jYXRpb24sICRyb290U2NvcGUpIHsKICAgIHZhciBkb2N1bWVudCA9ICR3aW5kb3cuZG9jdW1lbnQ7CgogICAgLy8gaGVscGVyIGZ1bmN0aW9uIHRvIGdldCBmaXJzdCBhbmNob3IgZnJvbSBhIE5vZGVMaXN0CiAgICAvLyBjYW4ndCB1c2UgZmlsdGVyLmZpbHRlciwgYXMgaXQgYWNjZXB0cyBvbmx5IGluc3RhbmNlcyBvZiBBcnJheQogICAgLy8gYW5kIElFIGNhbid0IGNvbnZlcnQgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgW10uc2xpY2UKICAgIC8vIFRPRE8odm9qdGEpOiB1c2UgZmlsdGVyIGlmIHdlIGNoYW5nZSBpdCB0byBhY2NlcHQgbGlzdHMgYXMgd2VsbAogICAgZnVuY3Rpb24gZ2V0Rmlyc3RBbmNob3IobGlzdCkgewogICAgICB2YXIgcmVzdWx0ID0gbnVsbDsKICAgICAgZm9yRWFjaChsaXN0LCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgaWYgKCFyZXN1bHQgJiYgbG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09PSAnYScpIHJlc3VsdCA9IGVsZW1lbnQ7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIGZ1bmN0aW9uIHNjcm9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSAkbG9jYXRpb24uaGFzaCgpLCBlbG07CgogICAgICAvLyBlbXB0eSBoYXNoLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICBpZiAoIWhhc2gpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CgogICAgICAvLyBlbGVtZW50IHdpdGggZ2l2ZW4gaWQKICAgICAgZWxzZSBpZiAoKGVsbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGhhc2gpKSkgZWxtLnNjcm9sbEludG9WaWV3KCk7CgogICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICBlbHNlIGlmICgoZWxtID0gZ2V0Rmlyc3RBbmNob3IoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoaGFzaCkpKSkgZWxtLnNjcm9sbEludG9WaWV3KCk7CgogICAgICAvLyBubyBlbGVtZW50IGFuZCBoYXNoID09ICd0b3AnLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICBlbHNlIGlmIChoYXNoID09PSAndG9wJykgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgIH0KCiAgICAvLyBkb2VzIG5vdCBzY3JvbGwgd2hlbiB1c2VyIGNsaWNrcyBvbiBhbmNob3IgbGluayB0aGF0IGlzIGN1cnJlbnRseSBvbgogICAgLy8gKG5vIHVybCBjaGFuZ2UsIG5vICRsb2NhdGlvbi5oYXNoKCkgY2hhbmdlKSwgYnJvd3NlciBuYXRpdmUgZG9lcyBzY3JvbGwKICAgIGlmIChhdXRvU2Nyb2xsaW5nRW5hYmxlZCkgewogICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2goKSB7cmV0dXJuICRsb2NhdGlvbi5oYXNoKCk7fSwKICAgICAgICBmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2hBY3Rpb24oKSB7CiAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoc2Nyb2xsKTsKICAgICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gc2Nyb2xsOwogIH1dOwp9Cgp2YXIgJGFuaW1hdGVNaW5FcnIgPSBtaW5FcnIoJyRhbmltYXRlJyk7CgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRhbmltYXRlUHJvdmlkZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIERlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgJGFuaW1hdGUgdGhhdCBkb2Vzbid0IHBlcmZvcm0gYW55IGFuaW1hdGlvbnMsIGluc3RlYWQganVzdAogKiBzeW5jaHJvbm91c2x5IHBlcmZvcm1zIERPTQogKiB1cGRhdGVzIGFuZCBjYWxscyBkb25lKCkgY2FsbGJhY2tzLgogKgogKiBJbiBvcmRlciB0byBlbmFibGUgYW5pbWF0aW9ucyB0aGUgbmdBbmltYXRlIG1vZHVsZSBoYXMgdG8gYmUgbG9hZGVkLgogKgogKiBUbyBzZWUgdGhlIGZ1bmN0aW9uYWwgaW1wbGVtZW50YXRpb24gY2hlY2sgb3V0IHNyYy9uZ0FuaW1hdGUvYW5pbWF0ZS5qcwogKi8KdmFyICRBbmltYXRlUHJvdmlkZXIgPSBbJyRwcm92aWRlJywgZnVuY3Rpb24oJHByb3ZpZGUpIHsKCgogIHRoaXMuJCRzZWxlY3RvcnMgPSB7fTsKCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyI3JlZ2lzdGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlcnMgYSBuZXcgaW5qZWN0YWJsZSBhbmltYXRpb24gZmFjdG9yeSBmdW5jdGlvbi4gVGhlIGZhY3RvcnkgZnVuY3Rpb24gcHJvZHVjZXMgdGhlCiAgICogYW5pbWF0aW9uIG9iamVjdCB3aGljaCBjb250YWlucyBjYWxsYmFjayBmdW5jdGlvbnMgZm9yIGVhY2ggZXZlbnQgdGhhdCBpcyBleHBlY3RlZCB0byBiZQogICAqIGFuaW1hdGVkLgogICAqCiAgICogICAqIGBldmVudEZuYDogYGZ1bmN0aW9uKEVsZW1lbnQsIGRvbmVGdW5jdGlvbilgIFRoZSBlbGVtZW50IHRvIGFuaW1hdGUsIHRoZSBgZG9uZUZ1bmN0aW9uYAogICAqICAgbXVzdCBiZSBjYWxsZWQgb25jZSB0aGUgZWxlbWVudCBhbmltYXRpb24gaXMgY29tcGxldGUuIElmIGEgZnVuY3Rpb24gaXMgcmV0dXJuZWQgdGhlbiB0aGUKICAgKiAgIGFuaW1hdGlvbiBzZXJ2aWNlIHdpbGwgdXNlIHRoaXMgZnVuY3Rpb24gdG8gY2FuY2VsIHRoZSBhbmltYXRpb24gd2hlbmV2ZXIgYSBjYW5jZWwgZXZlbnQgaXMKICAgKiAgIHRyaWdnZXJlZC4KICAgKgogICAqCiAgICogYGBganMKICAgKiAgIHJldHVybiB7CiAgICAgKiAgICAgZXZlbnRGbiA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsKICAgICAqICAgICAgIC8vY29kZSB0byBydW4gdGhlIGFuaW1hdGlvbgogICAgICogICAgICAgLy9vbmNlIGNvbXBsZXRlLCB0aGVuIHJ1biBkb25lKCkKICAgICAqICAgICAgIHJldHVybiBmdW5jdGlvbiBjYW5jZWxsYXRpb25GdW5jdGlvbigpIHsKICAgICAqICAgICAgICAgLy9jb2RlIHRvIGNhbmNlbCB0aGUgYW5pbWF0aW9uCiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfQogICAgICogICB9CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZhY3RvcnkgVGhlIGZhY3RvcnkgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHJldHVybiB0aGUgYW5pbWF0aW9uCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QuCiAgICovCiAgdGhpcy5yZWdpc3RlciA9IGZ1bmN0aW9uKG5hbWUsIGZhY3RvcnkpIHsKICAgIHZhciBrZXkgPSBuYW1lICsgJy1hbmltYXRpb24nOwogICAgaWYgKG5hbWUgJiYgbmFtZS5jaGFyQXQoMCkgIT0gJy4nKSB0aHJvdyAkYW5pbWF0ZU1pbkVycignbm90Y3NlbCcsCiAgICAgICAgIkV4cGVjdGluZyBjbGFzcyBzZWxlY3RvciBzdGFydGluZyB3aXRoICcuJyBnb3QgJ3swfScuIiwgbmFtZSk7CiAgICB0aGlzLiQkc2VsZWN0b3JzW25hbWUuc3Vic3RyKDEpXSA9IGtleTsKICAgICRwcm92aWRlLmZhY3Rvcnkoa2V5LCBmYWN0b3J5KTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGFuaW1hdGVQcm92aWRlciNjbGFzc05hbWVGaWx0ZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMgYW5kL29yIHJldHVybnMgdGhlIENTUyBjbGFzcyByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyBjaGVja2VkIHdoZW4gcGVyZm9ybWluZwogICAqIGFuIGFuaW1hdGlvbi4gVXBvbiBib290c3RyYXAgdGhlIGNsYXNzTmFtZUZpbHRlciB2YWx1ZSBpcyBub3Qgc2V0IGF0IGFsbCBhbmQgd2lsbAogICAqIHRoZXJlZm9yZSBlbmFibGUgJGFuaW1hdGUgdG8gYXR0ZW1wdCB0byBwZXJmb3JtIGFuIGFuaW1hdGlvbiBvbiBhbnkgZWxlbWVudC4KICAgKiBXaGVuIHNldHRpbmcgdGhlIGNsYXNzTmFtZUZpbHRlciB2YWx1ZSwgYW5pbWF0aW9ucyB3aWxsIG9ubHkgYmUgcGVyZm9ybWVkIG9uIGVsZW1lbnRzCiAgICogdGhhdCBzdWNjZXNzZnVsbHkgbWF0Y2ggdGhlIGZpbHRlciBleHByZXNzaW9uLiBUaGlzIGluIHR1cm4gY2FuIGJvb3N0IHBlcmZvcm1hbmNlCiAgICogZm9yIGxvdy1wb3dlcmVkIGRldmljZXMgYXMgd2VsbCBhcyBhcHBsaWNhdGlvbnMgY29udGFpbmluZyBhIGxvdCBvZiBzdHJ1Y3R1cmFsIG9wZXJhdGlvbnMuCiAgICogQHBhcmFtIHtSZWdFeHA9fSBleHByZXNzaW9uIFRoZSBjbGFzc05hbWUgZXhwcmVzc2lvbiB3aGljaCB3aWxsIGJlIGNoZWNrZWQgYWdhaW5zdCBhbGwgYW5pbWF0aW9ucwogICAqIEByZXR1cm4ge1JlZ0V4cH0gVGhlIGN1cnJlbnQgQ1NTIGNsYXNzTmFtZSBleHByZXNzaW9uIHZhbHVlLiBJZiBudWxsIHRoZW4gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbiB2YWx1ZQogICAqLwogIHRoaXMuY2xhc3NOYW1lRmlsdGVyID0gZnVuY3Rpb24oZXhwcmVzc2lvbikgewogICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICB0aGlzLiQkY2xhc3NOYW1lRmlsdGVyID0gKGV4cHJlc3Npb24gaW5zdGFuY2VvZiBSZWdFeHApID8gZXhwcmVzc2lvbiA6IG51bGw7CiAgICB9CiAgICByZXR1cm4gdGhpcy4kJGNsYXNzTmFtZUZpbHRlcjsKICB9OwoKICB0aGlzLiRnZXQgPSBbJyR0aW1lb3V0JywgJyQkYXN5bmNDYWxsYmFjaycsIGZ1bmN0aW9uKCR0aW1lb3V0LCAkJGFzeW5jQ2FsbGJhY2spIHsKCiAgICBmdW5jdGlvbiBhc3luYyhmbikgewogICAgICBmbiAmJiAkJGFzeW5jQ2FsbGJhY2soZm4pOwogICAgfQoKICAgIC8qKgogICAgICoKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSAkYW5pbWF0ZQogICAgICogQGRlc2NyaXB0aW9uIFRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHByb3ZpZGVzIHJ1ZGltZW50YXJ5IERPTSBtYW5pcHVsYXRpb24gZnVuY3Rpb25zIHRvCiAgICAgKiBpbnNlcnQsIHJlbW92ZSBhbmQgbW92ZSBlbGVtZW50cyB3aXRoaW4gdGhlIERPTSwgYXMgd2VsbCBhcyBhZGRpbmcgYW5kIHJlbW92aW5nIGNsYXNzZXMuCiAgICAgKiBUaGlzIHNlcnZpY2UgaXMgdGhlIGNvcmUgc2VydmljZSB1c2VkIGJ5IHRoZSBuZ0FuaW1hdGUgJGFuaW1hdG9yIHNlcnZpY2Ugd2hpY2ggcHJvdmlkZXMKICAgICAqIGhpZ2gtbGV2ZWwgYW5pbWF0aW9uIGhvb2tzIGZvciBDU1MgYW5kIEphdmFTY3JpcHQuCiAgICAgKgogICAgICogJGFuaW1hdGUgaXMgYXZhaWxhYmxlIGluIHRoZSBBbmd1bGFySlMgY29yZSwgaG93ZXZlciwgdGhlIG5nQW5pbWF0ZSBtb2R1bGUgbXVzdCBiZSBpbmNsdWRlZAogICAgICogdG8gZW5hYmxlIGZ1bGwgb3V0IGFuaW1hdGlvbiBzdXBwb3J0LiBPdGhlcndpc2UsICRhbmltYXRlIHdpbGwgb25seSBwZXJmb3JtIHNpbXBsZSBET00KICAgICAqIG1hbmlwdWxhdGlvbiBvcGVyYXRpb25zLgogICAgICoKICAgICAqIFRvIGxlYXJuIG1vcmUgYWJvdXQgZW5hYmxpbmcgYW5pbWF0aW9uIHN1cHBvcnQsIGNsaWNrIGhlcmUgdG8gdmlzaXQgdGhlIHtAbGluayBuZ0FuaW1hdGUKICAgICAqIG5nQW5pbWF0ZSBtb2R1bGUgcGFnZX0gYXMgd2VsbCBhcyB0aGUge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZSBuZ0FuaW1hdGUgJGFuaW1hdGUgc2VydmljZQogICAgICogcGFnZX0uCiAgICAgKi8KICAgIHJldHVybiB7CgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNlbnRlcgogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gSW5zZXJ0cyB0aGUgZWxlbWVudCBpbnRvIHRoZSBET00gZWl0aGVyIGFmdGVyIHRoZSBgYWZ0ZXJgIGVsZW1lbnQgb3Igd2l0aGluCiAgICAgICAqICAgdGhlIGBwYXJlbnRgIGVsZW1lbnQuIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBiZSBpbnNlcnRlZCBpbnRvIHRoZSBET00KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnQgdGhlIHBhcmVudCBlbGVtZW50IHdoaWNoIHdpbGwgYXBwZW5kIHRoZSBlbGVtZW50IGFzCiAgICAgICAqICAgYSBjaGlsZCAoaWYgdGhlIGFmdGVyIGVsZW1lbnQgaXMgbm90IHByZXNlbnQpCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gYWZ0ZXIgdGhlIHNpYmxpbmcgZWxlbWVudCB3aGljaCB3aWxsIGFwcGVuZCB0aGUgZWxlbWVudAogICAgICAgKiAgIGFmdGVyIGl0c2VsZgogICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIGFmdGVyIHRoZSBlbGVtZW50IGhhcyBiZWVuCiAgICAgICAqICAgaW5zZXJ0ZWQgaW50byB0aGUgRE9NCiAgICAgICAqLwogICAgICBlbnRlciA6IGZ1bmN0aW9uKGVsZW1lbnQsIHBhcmVudCwgYWZ0ZXIsIGRvbmUpIHsKICAgICAgICBpZiAoYWZ0ZXIpIHsKICAgICAgICAgIGFmdGVyLmFmdGVyKGVsZW1lbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoIXBhcmVudCB8fCAhcGFyZW50WzBdKSB7CiAgICAgICAgICAgIHBhcmVudCA9IGFmdGVyLnBhcmVudCgpOwogICAgICAgICAgfQogICAgICAgICAgcGFyZW50LmFwcGVuZChlbGVtZW50KTsKICAgICAgICB9CiAgICAgICAgYXN5bmMoZG9uZSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNsZWF2ZQogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlcyB0aGUgZWxlbWVudCBmcm9tIHRoZSBET00uIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZQogICAgICAgKiAgIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NCiAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb249fSBkb25lIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGVsZW1lbnQgaGFzIGJlZW4KICAgICAgICogICByZW1vdmVkIGZyb20gdGhlIERPTQogICAgICAgKi8KICAgICAgbGVhdmUgOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICBhc3luYyhkb25lKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRhbmltYXRlI21vdmUKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICogQGRlc2NyaXB0aW9uIE1vdmVzIHRoZSBwb3NpdGlvbiBvZiB0aGUgcHJvdmlkZWQgZWxlbWVudCB3aXRoaW4gdGhlIERPTSB0byBiZSBwbGFjZWQKICAgICAgICogZWl0aGVyIGFmdGVyIHRoZSBgYWZ0ZXJgIGVsZW1lbnQgb3IgaW5zaWRlIG9mIHRoZSBgcGFyZW50YCBlbGVtZW50LiBPbmNlIGNvbXBsZXRlLCB0aGUKICAgICAgICogZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgbW92ZWQgYXJvdW5kIHdpdGhpbiB0aGUKICAgICAgICogICBET00KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnQgdGhlIHBhcmVudCBlbGVtZW50IHdoZXJlIHRoZSBlbGVtZW50IHdpbGwgYmUKICAgICAgICogICBpbnNlcnRlZCBpbnRvIChpZiB0aGUgYWZ0ZXIgZWxlbWVudCBpcyBub3QgcHJlc2VudCkKICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlciB0aGUgc2libGluZyBlbGVtZW50IHdoZXJlIHRoZSBlbGVtZW50IHdpbGwgYmUKICAgICAgICogICBwb3NpdGlvbmVkIG5leHQgdG8KICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZQogICAgICAgKiAgIGVsZW1lbnQgaGFzIGJlZW4gbW92ZWQgdG8gaXRzIG5ldyBwb3NpdGlvbgogICAgICAgKi8KICAgICAgbW92ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIHBhcmVudCwgYWZ0ZXIsIGRvbmUpIHsKICAgICAgICAvLyBEbyBub3QgcmVtb3ZlIGVsZW1lbnQgYmVmb3JlIGluc2VydC4gUmVtb3Zpbmcgd2lsbCBjYXVzZSBkYXRhIGFzc29jaWF0ZWQgd2l0aCB0aGUKICAgICAgICAvLyBlbGVtZW50IHRvIGJlIGRyb3BwZWQuIEluc2VydCB3aWxsIGltcGxpY2l0bHkgZG8gdGhlIHJlbW92ZS4KICAgICAgICB0aGlzLmVudGVyKGVsZW1lbnQsIHBhcmVudCwgYWZ0ZXIsIGRvbmUpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjYWRkQ2xhc3MKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgdG8gdGhlIHByb3ZpZGVkIGVsZW1lbnQuIE9uY2UKICAgICAgICogY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIHRoZSBjbGFzc05hbWUgdmFsdWUKICAgICAgICogICBhZGRlZCB0byBpdAogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIHByb3ZpZGVkKSB0aGF0IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgdGhlCiAgICAgICAqICAgY2xhc3NOYW1lIHZhbHVlIGhhcyBiZWVuIGFkZGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAqLwogICAgICBhZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgewogICAgICAgIGNsYXNzTmFtZSA9IGlzU3RyaW5nKGNsYXNzTmFtZSkgPwogICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lIDoKICAgICAgICAgICAgICAgICAgICAgIGlzQXJyYXkoY2xhc3NOYW1lKSA/IGNsYXNzTmFtZS5qb2luKCcgJykgOiAnJzsKICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICBqcUxpdGVBZGRDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgIH0pOwogICAgICAgIGFzeW5jKGRvbmUpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjcmVtb3ZlQ2xhc3MKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZXMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgZnJvbSB0aGUgcHJvdmlkZWQgZWxlbWVudC4KICAgICAgICogT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGhhdmUgdGhlIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgKiAgIHJlbW92ZWQgZnJvbSBpdAogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZQogICAgICAgKiAgIGNsYXNzTmFtZSB2YWx1ZSBoYXMgYmVlbiByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICovCiAgICAgIHJlbW92ZUNsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7CiAgICAgICAgY2xhc3NOYW1lID0gaXNTdHJpbmcoY2xhc3NOYW1lKSA/CiAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgOgogICAgICAgICAgICAgICAgICAgICAgaXNBcnJheShjbGFzc05hbWUpID8gY2xhc3NOYW1lLmpvaW4oJyAnKSA6ICcnOwogICAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgIGpxTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgfSk7CiAgICAgICAgYXN5bmMoZG9uZSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNzZXRDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gQWRkcyBhbmQvb3IgcmVtb3ZlcyB0aGUgZ2l2ZW4gQ1NTIGNsYXNzZXMgdG8gYW5kIGZyb20gdGhlIGVsZW1lbnQuCiAgICAgICAqIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIGl0cyBDU1MgY2xhc3NlcyBjaGFuZ2VkCiAgICAgICAqICAgcmVtb3ZlZCBmcm9tIGl0CiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhZGQgdGhlIENTUyBjbGFzc2VzIHdoaWNoIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHJlbW92ZSB0aGUgQ1NTIGNsYXNzIHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb249fSBkb25lIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgcHJvdmlkZWQpIHRoYXQgd2lsbCBiZSBmaXJlZCBhZnRlciB0aGUKICAgICAgICogICBDU1MgY2xhc3NlcyBoYXZlIGJlZW4gc2V0IG9uIHRoZSBlbGVtZW50CiAgICAgICAqLwogICAgICBzZXRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFkZCwgcmVtb3ZlLCBkb25lKSB7CiAgICAgICAgZm9yRWFjaChlbGVtZW50LCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAganFMaXRlQWRkQ2xhc3MoZWxlbWVudCwgYWRkKTsKICAgICAgICAgIGpxTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIHJlbW92ZSk7CiAgICAgICAgfSk7CiAgICAgICAgYXN5bmMoZG9uZSk7CiAgICAgIH0sCgogICAgICBlbmFibGVkIDogbm9vcAogICAgfTsKICB9XTsKfV07CgpmdW5jdGlvbiAkJEFzeW5jQ2FsbGJhY2tQcm92aWRlcigpewogIHRoaXMuJGdldCA9IFsnJCRyQUYnLCAnJHRpbWVvdXQnLCBmdW5jdGlvbigkJHJBRiwgJHRpbWVvdXQpIHsKICAgIHJldHVybiAkJHJBRi5zdXBwb3J0ZWQKICAgICAgPyBmdW5jdGlvbihmbikgeyByZXR1cm4gJCRyQUYoZm4pOyB9CiAgICAgIDogZnVuY3Rpb24oZm4pIHsKICAgICAgICByZXR1cm4gJHRpbWVvdXQoZm4sIDAsIGZhbHNlKTsKICAgICAgfTsKICB9XTsKfQoKLyoqCiAqICEgVGhpcyBpcyBhIHByaXZhdGUgdW5kb2N1bWVudGVkIHNlcnZpY2UgIQogKgogKiBAbmFtZSAkYnJvd3NlcgogKiBAcmVxdWlyZXMgJGxvZwogKiBAZGVzY3JpcHRpb24KICogVGhpcyBvYmplY3QgaGFzIHR3byBnb2FsczoKICoKICogLSBoaWRlIGFsbCB0aGUgZ2xvYmFsIHN0YXRlIGluIHRoZSBicm93c2VyIGNhdXNlZCBieSB0aGUgd2luZG93IG9iamVjdAogKiAtIGFic3RyYWN0IGF3YXkgYWxsIHRoZSBicm93c2VyIHNwZWNpZmljIGZlYXR1cmVzIGFuZCBpbmNvbnNpc3RlbmNpZXMKICoKICogRm9yIHRlc3RzIHdlIHByb3ZpZGUge0BsaW5rIG5nTW9jay4kYnJvd3NlciBtb2NrIGltcGxlbWVudGF0aW9ufSBvZiB0aGUgYCRicm93c2VyYAogKiBzZXJ2aWNlLCB3aGljaCBjYW4gYmUgdXNlZCBmb3IgY29udmVuaWVudCB0ZXN0aW5nIG9mIHRoZSBhcHBsaWNhdGlvbiB3aXRob3V0IHRoZSBpbnRlcmFjdGlvbiB3aXRoCiAqIHRoZSByZWFsIGJyb3dzZXIgYXBpcy4KICovCi8qKgogKiBAcGFyYW0ge29iamVjdH0gd2luZG93IFRoZSBnbG9iYWwgd2luZG93IG9iamVjdC4KICogQHBhcmFtIHtvYmplY3R9IGRvY3VtZW50IGpRdWVyeSB3cmFwcGVkIGRvY3VtZW50LgogKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IFhIUiBYTUxIdHRwUmVxdWVzdCBjb25zdHJ1Y3Rvci4KICogQHBhcmFtIHtvYmplY3R9ICRsb2cgY29uc29sZS5sb2cgb3IgYW4gb2JqZWN0IHdpdGggdGhlIHNhbWUgaW50ZXJmYWNlLgogKiBAcGFyYW0ge29iamVjdH0gJHNuaWZmZXIgJHNuaWZmZXIgc2VydmljZQogKi8KZnVuY3Rpb24gQnJvd3Nlcih3aW5kb3csIGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcikgewogIHZhciBzZWxmID0gdGhpcywKICAgICAgcmF3RG9jdW1lbnQgPSBkb2N1bWVudFswXSwKICAgICAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgIGhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeSwKICAgICAgc2V0VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0LAogICAgICBjbGVhclRpbWVvdXQgPSB3aW5kb3cuY2xlYXJUaW1lb3V0LAogICAgICBwZW5kaW5nRGVmZXJJZHMgPSB7fTsKCiAgc2VsZi5pc01vY2sgPSBmYWxzZTsKCiAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gMDsKICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzID0gW107CgogIC8vIFRPRE8odm9qdGEpOiByZW1vdmUgdGhpcyB0ZW1wb3JhcnkgYXBpCiAgc2VsZi4kJGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0ID0gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Q7CiAgc2VsZi4kJGluY091dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gZnVuY3Rpb24oKSB7IG91dHN0YW5kaW5nUmVxdWVzdENvdW50Kys7IH07CgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgZm5gIGZ1bmN0aW9uKHN1cHBvcnRzIGN1cnJ5aW5nKSBhbmQgZGVjcmVtZW50cyB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AKICAgKiBjb3VudGVyLiBJZiB0aGUgY291bnRlciByZWFjaGVzIDAsIGFsbCB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AgYXJlIGV4ZWN1dGVkLgogICAqLwogIGZ1bmN0aW9uIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKSB7CiAgICB0cnkgewogICAgICBmbi5hcHBseShudWxsLCBzbGljZUFyZ3MoYXJndW1lbnRzLCAxKSk7CiAgICB9IGZpbmFsbHkgewogICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudC0tOwogICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICB3aGlsZShvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucG9wKCkoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIEBwcml2YXRlCiAgICogTm90ZTogdGhpcyBtZXRob2QgaXMgdXNlZCBvbmx5IGJ5IHNjZW5hcmlvIHJ1bm5lcgogICAqIFRPRE8odm9qdGEpOiBwcmVmaXggdGhpcyBtZXRob2Qgd2l0aCAkJCA/CiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBjYWxsYmFjayBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gbm8gb3V0c3RhbmRpbmcgcmVxdWVzdAogICAqLwogIHNlbGYubm90aWZ5V2hlbk5vT3V0c3RhbmRpbmdSZXF1ZXN0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAvLyBmb3JjZSBicm93c2VyIHRvIGV4ZWN1dGUgYWxsIHBvbGxGbnMgLSB0aGlzIGlzIG5lZWRlZCBzbyB0aGF0IGNvb2tpZXMgYW5kIG90aGVyIHBvbGxlcnMgZmlyZQogICAgLy8gYXQgc29tZSBkZXRlcm1pbmlzdGljIHRpbWUgaW4gcmVzcGVjdCB0byB0aGUgdGVzdCBydW5uZXIncyBhY3Rpb25zLiBMZWF2aW5nIHRoaW5ncyB1cCB0byB0aGUKICAgIC8vIHJlZ3VsYXIgcG9sbGVyIHdvdWxkIHJlc3VsdCBpbiBmbGFreSB0ZXN0cy4KICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24ocG9sbEZuKXsgcG9sbEZuKCk7IH0pOwoKICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICBjYWxsYmFjaygpOwogICAgfSBlbHNlIHsKICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogICAgfQogIH07CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gUG9sbCBXYXRjaGVyIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIHBvbGxGbnMgPSBbXSwKICAgICAgcG9sbFRpbWVvdXQ7CgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI2FkZFBvbGxGbgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBQb2xsIGZ1bmN0aW9uIHRvIGFkZAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBsaXN0IG9mIGZ1bmN0aW9ucyB0aGF0IHBvbGxlciBwZXJpb2RpY2FsbHkgZXhlY3V0ZXMsCiAgICogYW5kIHN0YXJ0cyBwb2xsaW5nIGlmIG5vdCBzdGFydGVkIHlldC4KICAgKgogICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSB0aGUgYWRkZWQgZnVuY3Rpb24KICAgKi8KICBzZWxmLmFkZFBvbGxGbiA9IGZ1bmN0aW9uKGZuKSB7CiAgICBpZiAoaXNVbmRlZmluZWQocG9sbFRpbWVvdXQpKSBzdGFydFBvbGxlcigxMDAsIHNldFRpbWVvdXQpOwogICAgcG9sbEZucy5wdXNoKGZuKTsKICAgIHJldHVybiBmbjsKICB9OwoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW50ZXJ2YWwgSG93IG9mdGVuIHNob3VsZCBicm93c2VyIGNhbGwgcG9sbCBmdW5jdGlvbnMgKG1zKQogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gc2V0VGltZW91dCBSZWZlcmVuY2UgdG8gYSByZWFsIG9yIGZha2UgYHNldFRpbWVvdXRgIGZ1bmN0aW9uLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ29uZmlndXJlcyB0aGUgcG9sbGVyIHRvIHJ1biBpbiB0aGUgc3BlY2lmaWVkIGludGVydmFscywgdXNpbmcgdGhlIHNwZWNpZmllZAogICAqIHNldFRpbWVvdXQgZm4gYW5kIGtpY2tzIGl0IG9mZi4KICAgKi8KICBmdW5jdGlvbiBzdGFydFBvbGxlcihpbnRlcnZhbCwgc2V0VGltZW91dCkgewogICAgKGZ1bmN0aW9uIGNoZWNrKCkgewogICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uKHBvbGxGbil7IHBvbGxGbigpOyB9KTsKICAgICAgcG9sbFRpbWVvdXQgPSBzZXRUaW1lb3V0KGNoZWNrLCBpbnRlcnZhbCk7CiAgICB9KSgpOwogIH0KCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBVUkwgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgdmFyIGxhc3RCcm93c2VyVXJsID0gbG9jYXRpb24uaHJlZiwKICAgICAgYmFzZUVsZW1lbnQgPSBkb2N1bWVudC5maW5kKCdiYXNlJyksCiAgICAgIG5ld0xvY2F0aW9uID0gbnVsbDsKCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjdXJsCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBHRVRURVI6CiAgICogV2l0aG91dCBhbnkgYXJndW1lbnQsIHRoaXMgbWV0aG9kIGp1c3QgcmV0dXJucyBjdXJyZW50IHZhbHVlIG9mIGxvY2F0aW9uLmhyZWYuCiAgICoKICAgKiBTRVRURVI6CiAgICogV2l0aCBhdCBsZWFzdCBvbmUgYXJndW1lbnQsIHRoaXMgbWV0aG9kIHNldHMgdXJsIHRvIG5ldyB2YWx1ZS4KICAgKiBJZiBodG1sNSBoaXN0b3J5IGFwaSBzdXBwb3J0ZWQsIHB1c2hTdGF0ZS9yZXBsYWNlU3RhdGUgaXMgdXNlZCwgb3RoZXJ3aXNlCiAgICogbG9jYXRpb24uaHJlZi9sb2NhdGlvbi5yZXBsYWNlIGlzIHVzZWQuCiAgICogUmV0dXJucyBpdHMgb3duIGluc3RhbmNlIHRvIGFsbG93IGNoYWluaW5nCiAgICoKICAgKiBOT1RFOiB0aGlzIGFwaSBpcyBpbnRlbmRlZCBmb3IgdXNlIG9ubHkgYnkgdGhlICRsb2NhdGlvbiBzZXJ2aWNlLiBQbGVhc2UgdXNlIHRoZQogICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9uIHNlcnZpY2V9IHRvIGNoYW5nZSB1cmwuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIE5ldyB1cmwgKHdoZW4gdXNlZCBhcyBzZXR0ZXIpCiAgICogQHBhcmFtIHtib29sZWFuPX0gcmVwbGFjZSBTaG91bGQgbmV3IHVybCByZXBsYWNlIGN1cnJlbnQgaGlzdG9yeSByZWNvcmQgPwogICAqLwogIHNlbGYudXJsID0gZnVuY3Rpb24odXJsLCByZXBsYWNlKSB7CiAgICAvLyBBbmRyb2lkIEJyb3dzZXIgQkZDYWNoZSBjYXVzZXMgbG9jYXRpb24sIGhpc3RvcnkgcmVmZXJlbmNlIHRvIGJlY29tZSBzdGFsZS4KICAgIGlmIChsb2NhdGlvbiAhPT0gd2luZG93LmxvY2F0aW9uKSBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICAgIGlmIChoaXN0b3J5ICE9PSB3aW5kb3cuaGlzdG9yeSkgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwoKICAgIC8vIHNldHRlcgogICAgaWYgKHVybCkgewogICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gdXJsKSByZXR1cm47CiAgICAgIGxhc3RCcm93c2VyVXJsID0gdXJsOwogICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSkgewogICAgICAgIGlmIChyZXBsYWNlKSBoaXN0b3J5LnJlcGxhY2VTdGF0ZShudWxsLCAnJywgdXJsKTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgLy8gQ3JhenkgT3BlcmEgQnVnOiBodHRwOi8vbXkub3BlcmEuY29tL2NvbW11bml0eS9mb3J1bXMvdG9waWMuZG1sP2lkPTExODU0NjIKICAgICAgICAgIGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnLCBiYXNlRWxlbWVudC5hdHRyKCdocmVmJykpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuZXdMb2NhdGlvbiA9IHVybDsKICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgbG9jYXRpb24ucmVwbGFjZSh1cmwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc2VsZjsKICAgIC8vIGdldHRlcgogICAgfSBlbHNlIHsKICAgICAgLy8gLSBuZXdMb2NhdGlvbiBpcyBhIHdvcmthcm91bmQgZm9yIGFuIElFNy05IGlzc3VlIHdpdGggbG9jYXRpb24ucmVwbGFjZSBhbmQgbG9jYXRpb24uaHJlZgogICAgICAvLyAgIG1ldGhvZHMgbm90IHVwZGF0aW5nIGxvY2F0aW9uLmhyZWYgc3luY2hyb25vdXNseS4KICAgICAgLy8gLSB0aGUgcmVwbGFjZW1lbnQgaXMgYSB3b3JrYXJvdW5kIGZvciBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD00MDcxNzIKICAgICAgcmV0dXJuIG5ld0xvY2F0aW9uIHx8IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvJTI3L2csIiciKTsKICAgIH0KICB9OwoKICB2YXIgdXJsQ2hhbmdlTGlzdGVuZXJzID0gW10sCiAgICAgIHVybENoYW5nZUluaXQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gZmlyZVVybENoYW5nZSgpIHsKICAgIG5ld0xvY2F0aW9uID0gbnVsbDsKICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSBzZWxmLnVybCgpKSByZXR1cm47CgogICAgbGFzdEJyb3dzZXJVcmwgPSBzZWxmLnVybCgpOwogICAgZm9yRWFjaCh1cmxDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uKGxpc3RlbmVyKSB7CiAgICAgIGxpc3RlbmVyKHNlbGYudXJsKCkpOwogICAgfSk7CiAgfQoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciNvblVybENoYW5nZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVnaXN0ZXIgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCwgd2hlbiB1cmwgY2hhbmdlcy4KICAgKgogICAqIEl0J3Mgb25seSBjYWxsZWQgd2hlbiB0aGUgdXJsIGlzIGNoYW5nZWQgZnJvbSBvdXRzaWRlIG9mIGFuZ3VsYXI6CiAgICogLSB1c2VyIHR5cGVzIGRpZmZlcmVudCB1cmwgaW50byBhZGRyZXNzIGJhcgogICAqIC0gdXNlciBjbGlja3Mgb24gaGlzdG9yeSAoZm9yd2FyZC9iYWNrKSBidXR0b24KICAgKiAtIHVzZXIgY2xpY2tzIG9uIGEgbGluawogICAqCiAgICogSXQncyBub3QgY2FsbGVkIHdoZW4gdXJsIGlzIGNoYW5nZWQgYnkgJGJyb3dzZXIudXJsKCkgbWV0aG9kCiAgICoKICAgKiBUaGUgbGlzdGVuZXIgZ2V0cyBjYWxsZWQgd2l0aCBuZXcgdXJsIGFzIHBhcmFtZXRlci4KICAgKgogICAqIE5PVEU6IHRoaXMgYXBpIGlzIGludGVuZGVkIGZvciB1c2Ugb25seSBieSB0aGUgJGxvY2F0aW9uIHNlcnZpY2UuIFBsZWFzZSB1c2UgdGhlCiAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gbW9uaXRvciB1cmwgY2hhbmdlcyBpbiBhbmd1bGFyIGFwcHMuCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZyl9IGxpc3RlbmVyIExpc3RlbmVyIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHVybCBjaGFuZ2VzLgogICAqIEByZXR1cm4ge2Z1bmN0aW9uKHN0cmluZyl9IFJldHVybnMgdGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXIgZm4gLSBoYW5keSBpZiB0aGUgZm4gaXMgYW5vbnltb3VzLgogICAqLwogIHNlbGYub25VcmxDaGFuZ2UgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgLy8gVE9ETyh2b2p0YSk6IHJlZmFjdG9yIHRvIHVzZSBub2RlJ3Mgc3ludGF4IGZvciBldmVudHMKICAgIGlmICghdXJsQ2hhbmdlSW5pdCkgewogICAgICAvLyBXZSBsaXN0ZW4gb24gYm90aCAoaGFzaGNoYW5nZS9wb3BzdGF0ZSkgd2hlbiBhdmFpbGFibGUsIGFzIHNvbWUgYnJvd3NlcnMgKGUuZy4gT3BlcmEpCiAgICAgIC8vIGRvbid0IGZpcmUgcG9wc3RhdGUgd2hlbiB1c2VyIGNoYW5nZSB0aGUgYWRkcmVzcyBiYXIgYW5kIGRvbid0IGZpcmUgaGFzaGNoYW5nZSB3aGVuIHVybAogICAgICAvLyBjaGFuZ2VkIGJ5IHB1c2gvcmVwbGFjZVN0YXRlCgogICAgICAvLyBodG1sNSBoaXN0b3J5IGFwaSAtIHBvcHN0YXRlIGV2ZW50CiAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSBqcUxpdGUod2luZG93KS5vbigncG9wc3RhdGUnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICBpZiAoJHNuaWZmZXIuaGFzaGNoYW5nZSkganFMaXRlKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgLy8gcG9sbGluZwogICAgICBlbHNlIHNlbGYuYWRkUG9sbEZuKGZpcmVVcmxDaGFuZ2UpOwoKICAgICAgdXJsQ2hhbmdlSW5pdCA9IHRydWU7CiAgICB9CgogICAgdXJsQ2hhbmdlTGlzdGVuZXJzLnB1c2goY2FsbGJhY2spOwogICAgcmV0dXJuIGNhbGxiYWNrOwogIH07CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gTWlzYyBBUEkKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciNiYXNlSHJlZgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV0dXJucyBjdXJyZW50IDxiYXNlIGhyZWY+CiAgICogKGFsd2F5cyByZWxhdGl2ZSAtIHdpdGhvdXQgZG9tYWluKQogICAqCiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGN1cnJlbnQgYmFzZSBocmVmCiAgICovCiAgc2VsZi5iYXNlSHJlZiA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGhyZWYgPSBiYXNlRWxlbWVudC5hdHRyKCdocmVmJyk7CiAgICByZXR1cm4gaHJlZiA/IGhyZWYucmVwbGFjZSgvXihodHRwcz9cOik/XC9cL1teXC9dKi8sICcnKSA6ICcnOwogIH07CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gQ29va2llcyBBUEkKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIHZhciBsYXN0Q29va2llcyA9IHt9OwogIHZhciBsYXN0Q29va2llU3RyaW5nID0gJyc7CiAgdmFyIGNvb2tpZVBhdGggPSBzZWxmLmJhc2VIcmVmKCk7CgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI2Nvb2tpZXMKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBDb29raWUgbmFtZQogICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgQ29va2llIHZhbHVlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgY29va2llcyBtZXRob2QgcHJvdmlkZXMgYSAncHJpdmF0ZScgbG93IGxldmVsIGFjY2VzcyB0byBicm93c2VyIGNvb2tpZXMuCiAgICogSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZGlyZWN0bHksIHVzZSB0aGUgJGNvb2tpZSBzZXJ2aWNlIGluc3RlYWQuCiAgICoKICAgKiBUaGUgcmV0dXJuIHZhbHVlcyB2YXJ5IGRlcGVuZGluZyBvbiB0aGUgYXJndW1lbnRzIHRoYXQgdGhlIG1ldGhvZCB3YXMgY2FsbGVkIHdpdGggYXMgZm9sbG93czoKICAgKgogICAqIC0gY29va2llcygpIC0+IGhhc2ggb2YgYWxsIGNvb2tpZXMsIHRoaXMgaXMgTk9UIGEgY29weSBvZiB0aGUgaW50ZXJuYWwgc3RhdGUsIHNvIGRvIG5vdCBtb2RpZnkKICAgKiAgIGl0CiAgICogLSBjb29raWVzKG5hbWUsIHZhbHVlKSAtPiBzZXQgbmFtZSB0byB2YWx1ZSwgaWYgdmFsdWUgaXMgdW5kZWZpbmVkIGRlbGV0ZSB0aGUgY29va2llCiAgICogLSBjb29raWVzKG5hbWUpIC0+IHRoZSBzYW1lIGFzIChuYW1lLCB1bmRlZmluZWQpID09IERFTEVURVMgKG5vIG9uZSBjYWxscyBpdCByaWdodCBub3cgdGhhdAogICAqICAgd2F5KQogICAqCiAgICogQHJldHVybnMge09iamVjdH0gSGFzaCBvZiBhbGwgY29va2llcyAoaWYgY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlcikKICAgKi8KICBzZWxmLmNvb2tpZXMgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgLyogZ2xvYmFsIGVzY2FwZTogZmFsc2UsIHVuZXNjYXBlOiBmYWxzZSAqLwogICAgdmFyIGNvb2tpZUxlbmd0aCwgY29va2llQXJyYXksIGNvb2tpZSwgaSwgaW5kZXg7CgogICAgaWYgKG5hbWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAiPTtwYXRoPSIgKyBjb29raWVQYXRoICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiO2V4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQiOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgIGNvb2tpZUxlbmd0aCA9IChyYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAnPScgKyBlc2NhcGUodmFsdWUpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnO3BhdGg9JyArIGNvb2tpZVBhdGgpLmxlbmd0aCArIDE7CgogICAgICAgICAgLy8gcGVyIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzIxMDkudHh0IGJyb3dzZXIgbXVzdCBhbGxvdyBhdCBtaW5pbXVtOgogICAgICAgICAgLy8gLSAzMDAgY29va2llcwogICAgICAgICAgLy8gLSAyMCBjb29raWVzIHBlciB1bmlxdWUgZG9tYWluCiAgICAgICAgICAvLyAtIDQwOTYgYnl0ZXMgcGVyIGNvb2tpZQogICAgICAgICAgaWYgKGNvb2tpZUxlbmd0aCA+IDQwOTYpIHsKICAgICAgICAgICAgJGxvZy53YXJuKCJDb29raWUgJyIrIG5hbWUgKwogICAgICAgICAgICAgICInIHBvc3NpYmx5IG5vdCBzZXQgb3Igb3ZlcmZsb3dlZCBiZWNhdXNlIGl0IHdhcyB0b28gbGFyZ2UgKCIrCiAgICAgICAgICAgICAgY29va2llTGVuZ3RoICsgIiA+IDQwOTYgYnl0ZXMpISIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHJhd0RvY3VtZW50LmNvb2tpZSAhPT0gbGFzdENvb2tpZVN0cmluZykgewogICAgICAgIGxhc3RDb29raWVTdHJpbmcgPSByYXdEb2N1bWVudC5jb29raWU7CiAgICAgICAgY29va2llQXJyYXkgPSBsYXN0Q29va2llU3RyaW5nLnNwbGl0KCI7ICIpOwogICAgICAgIGxhc3RDb29raWVzID0ge307CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb29raWVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29va2llID0gY29va2llQXJyYXlbaV07CiAgICAgICAgICBpbmRleCA9IGNvb2tpZS5pbmRleE9mKCc9Jyk7CiAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7IC8vaWdub3JlIG5hbWVsZXNzIGNvb2tpZXMKICAgICAgICAgICAgbmFtZSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoMCwgaW5kZXgpKTsKICAgICAgICAgICAgLy8gdGhlIGZpcnN0IHZhbHVlIHRoYXQgaXMgc2VlbiBmb3IgYSBjb29raWUgaXMgdGhlIG1vc3QKICAgICAgICAgICAgLy8gc3BlY2lmaWMgb25lLiAgdmFsdWVzIGZvciB0aGUgc2FtZSBjb29raWUgbmFtZSB0aGF0CiAgICAgICAgICAgIC8vIGZvbGxvdyBhcmUgZm9yIGxlc3Mgc3BlY2lmaWMgcGF0aHMuCiAgICAgICAgICAgIGlmIChsYXN0Q29va2llc1tuYW1lXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgbGFzdENvb2tpZXNbbmFtZV0gPSB1bmVzY2FwZShjb29raWUuc3Vic3RyaW5nKGluZGV4ICsgMSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBsYXN0Q29va2llczsKICAgIH0KICB9OwoKCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjZGVmZXIKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdobydzIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVmZXJyZWQuCiAgICogQHBhcmFtIHtudW1iZXI9fSBbZGVsYXk9MF0gb2YgbWlsbGlzZWNvbmRzIHRvIGRlZmVyIHRoZSBmdW5jdGlvbiBleGVjdXRpb24uCiAgICogQHJldHVybnMgeyp9IERlZmVySWQgdGhhdCBjYW4gYmUgdXNlZCB0byBjYW5jZWwgdGhlIHRhc2sgdmlhIGAkYnJvd3Nlci5kZWZlci5jYW5jZWwoKWAuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBFeGVjdXRlcyBhIGZuIGFzeW5jaHJvbm91c2x5IHZpYSBgc2V0VGltZW91dChmbiwgZGVsYXkpYC4KICAgKgogICAqIFVubGlrZSB3aGVuIGNhbGxpbmcgYHNldFRpbWVvdXRgIGRpcmVjdGx5LCBpbiB0ZXN0IHRoaXMgZnVuY3Rpb24gaXMgbW9ja2VkIGFuZCBpbnN0ZWFkIG9mIHVzaW5nCiAgICogYHNldFRpbWVvdXRgIGluIHRlc3RzLCB0aGUgZm5zIGFyZSBxdWV1ZWQgaW4gYW4gYXJyYXksIHdoaWNoIGNhbiBiZSBwcm9ncmFtbWF0aWNhbGx5IGZsdXNoZWQKICAgKiB2aWEgYCRicm93c2VyLmRlZmVyLmZsdXNoKClgLgogICAqCiAgICovCiAgc2VsZi5kZWZlciA9IGZ1bmN0aW9uKGZuLCBkZWxheSkgewogICAgdmFyIHRpbWVvdXRJZDsKICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50Kys7CiAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICBkZWxldGUgcGVuZGluZ0RlZmVySWRzW3RpbWVvdXRJZF07CiAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKTsKICAgIH0sIGRlbGF5IHx8IDApOwogICAgcGVuZGluZ0RlZmVySWRzW3RpbWVvdXRJZF0gPSB0cnVlOwogICAgcmV0dXJuIHRpbWVvdXRJZDsKICB9OwoKCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYW5jZWxzIGEgZGVmZXJyZWQgdGFzayBpZGVudGlmaWVkIHdpdGggYGRlZmVySWRgLgogICAqCiAgICogQHBhcmFtIHsqfSBkZWZlcklkIFRva2VuIHJldHVybmVkIGJ5IHRoZSBgJGJyb3dzZXIuZGVmZXJgIGZ1bmN0aW9uLgogICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICogICAgICAgICAgICAgICAgICAgIGNhbmNlbGVkLgogICAqLwogIHNlbGYuZGVmZXIuY2FuY2VsID0gZnVuY3Rpb24oZGVmZXJJZCkgewogICAgaWYgKHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXSkgewogICAgICBkZWxldGUgcGVuZGluZ0RlZmVySWRzW2RlZmVySWRdOwogICAgICBjbGVhclRpbWVvdXQoZGVmZXJJZCk7CiAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KG5vb3ApOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9OwoKfQoKZnVuY3Rpb24gJEJyb3dzZXJQcm92aWRlcigpewogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9nJywgJyRzbmlmZmVyJywgJyRkb2N1bWVudCcsCiAgICAgIGZ1bmN0aW9uKCAkd2luZG93LCAgICRsb2csICAgJHNuaWZmZXIsICAgJGRvY3VtZW50KXsKICAgICAgICByZXR1cm4gbmV3IEJyb3dzZXIoJHdpbmRvdywgJGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcik7CiAgICAgIH1dOwp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGNhY2hlRmFjdG9yeQogKgogKiBAZGVzY3JpcHRpb24KICogRmFjdG9yeSB0aGF0IGNvbnN0cnVjdHMge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdHMgYW5kIGdpdmVzIGFjY2VzcyB0bwogKiB0aGVtLgogKgogKiBgYGBqcwogKgogKiAgdmFyIGNhY2hlID0gJGNhY2hlRmFjdG9yeSgnY2FjaGVJZCcpOwogKiAgZXhwZWN0KCRjYWNoZUZhY3RvcnkuZ2V0KCdjYWNoZUlkJykpLnRvQmUoY2FjaGUpOwogKiAgZXhwZWN0KCRjYWNoZUZhY3RvcnkuZ2V0KCdub1N1Y2hDYWNoZUlkJykpLm5vdC50b0JlRGVmaW5lZCgpOwogKgogKiAgY2FjaGUucHV0KCJrZXkiLCAidmFsdWUiKTsKICogIGNhY2hlLnB1dCgiYW5vdGhlciBrZXkiLCAiYW5vdGhlciB2YWx1ZSIpOwogKgogKiAgLy8gV2UndmUgc3BlY2lmaWVkIG5vIG9wdGlvbnMgb24gY3JlYXRpb24KICogIGV4cGVjdChjYWNoZS5pbmZvKCkpLnRvRXF1YWwoe2lkOiAnY2FjaGVJZCcsIHNpemU6IDJ9KTsKICoKICogYGBgCiAqCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUlkIE5hbWUgb3IgaWQgb2YgdGhlIG5ld2x5IGNyZWF0ZWQgY2FjaGUuCiAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdCB0aGF0IHNwZWNpZmllcyB0aGUgY2FjaGUgYmVoYXZpb3IuIFByb3BlcnRpZXM6CiAqCiAqICAgLSBge251bWJlcj19YCBgY2FwYWNpdHlgIOKAlCB0dXJucyB0aGUgY2FjaGUgaW50byBMUlUgY2FjaGUuCiAqCiAqIEByZXR1cm5zIHtvYmplY3R9IE5ld2x5IGNyZWF0ZWQgY2FjaGUgb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBzZXQgb2YgbWV0aG9kczoKICoKICogLSBge29iamVjdH1gIGBpbmZvKClgIOKAlCBSZXR1cm5zIGlkLCBzaXplLCBhbmQgb3B0aW9ucyBvZiBjYWNoZS4KICogLSBge3sqfX1gIGBwdXQoe3N0cmluZ30ga2V5LCB7Kn0gdmFsdWUpYCDigJQgUHV0cyBhIG5ldyBrZXktdmFsdWUgcGFpciBpbnRvIHRoZSBjYWNoZSBhbmQgcmV0dXJucwogKiAgIGl0LgogKiAtIGB7eyp9fWAgYGdldCh7c3RyaW5nfSBrZXkpYCDigJQgUmV0dXJucyBjYWNoZWQgdmFsdWUgZm9yIGBrZXlgIG9yIHVuZGVmaW5lZCBmb3IgY2FjaGUgbWlzcy4KICogLSBge3ZvaWR9YCBgcmVtb3ZlKHtzdHJpbmd9IGtleSlgIOKAlCBSZW1vdmVzIGEga2V5LXZhbHVlIHBhaXIgZnJvbSB0aGUgY2FjaGUuCiAqIC0gYHt2b2lkfWAgYHJlbW92ZUFsbCgpYCDigJQgUmVtb3ZlcyBhbGwgY2FjaGVkIHZhbHVlcy4KICogLSBge3ZvaWR9YCBgZGVzdHJveSgpYCDigJQgUmVtb3ZlcyByZWZlcmVuY2VzIHRvIHRoaXMgY2FjaGUgZnJvbSAkY2FjaGVGYWN0b3J5LgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9ImNhY2hlRXhhbXBsZUFwcCI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkNhY2hlQ29udHJvbGxlciI+CiAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ibmV3Q2FjaGVLZXkiIHBsYWNlaG9sZGVyPSJLZXkiPgogICAgICAgICA8aW5wdXQgbmctbW9kZWw9Im5ld0NhY2hlVmFsdWUiIHBsYWNlaG9sZGVyPSJWYWx1ZSI+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InB1dChuZXdDYWNoZUtleSwgbmV3Q2FjaGVWYWx1ZSkiPkNhY2hlPC9idXR0b24+CgogICAgICAgICA8cCBuZy1pZj0ia2V5cy5sZW5ndGgiPkNhY2hlZCBWYWx1ZXM8L3A+CiAgICAgICAgIDxkaXYgbmctcmVwZWF0PSJrZXkgaW4ga2V5cyI+CiAgICAgICAgICAgPHNwYW4gbmctYmluZD0ia2V5Ij48L3NwYW4+CiAgICAgICAgICAgPHNwYW4+OiA8L3NwYW4+CiAgICAgICAgICAgPGIgbmctYmluZD0iY2FjaGUuZ2V0KGtleSkiPjwvYj4KICAgICAgICAgPC9kaXY+CgogICAgICAgICA8cD5DYWNoZSBJbmZvPC9wPgogICAgICAgICA8ZGl2IG5nLXJlcGVhdD0iKGtleSwgdmFsdWUpIGluIGNhY2hlLmluZm8oKSI+CiAgICAgICAgICAgPHNwYW4gbmctYmluZD0ia2V5Ij48L3NwYW4+CiAgICAgICAgICAgPHNwYW4+OiA8L3NwYW4+CiAgICAgICAgICAgPGIgbmctYmluZD0idmFsdWUiPjwvYj4KICAgICAgICAgPC9kaXY+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgIGFuZ3VsYXIubW9kdWxlKCdjYWNoZUV4YW1wbGVBcHAnLCBbXSkuCiAgICAgICAgIGNvbnRyb2xsZXIoJ0NhY2hlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbigkc2NvcGUsICRjYWNoZUZhY3RvcnkpIHsKICAgICAgICAgICAkc2NvcGUua2V5cyA9IFtdOwogICAgICAgICAgICRzY29wZS5jYWNoZSA9ICRjYWNoZUZhY3RvcnkoJ2NhY2hlSWQnKTsKICAgICAgICAgICAkc2NvcGUucHV0ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgJHNjb3BlLmNhY2hlLnB1dChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICRzY29wZS5rZXlzLnB1c2goa2V5KTsKICAgICAgICAgICB9OwogICAgICAgICB9XSk7CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICBwIHsKICAgICAgICAgbWFyZ2luOiAxMHB4IDAgM3B4OwogICAgICAgfQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gJENhY2hlRmFjdG9yeVByb3ZpZGVyKCkgewoKICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjYWNoZXMgPSB7fTsKCiAgICBmdW5jdGlvbiBjYWNoZUZhY3RvcnkoY2FjaGVJZCwgb3B0aW9ucykgewogICAgICBpZiAoY2FjaGVJZCBpbiBjYWNoZXMpIHsKICAgICAgICB0aHJvdyBtaW5FcnIoJyRjYWNoZUZhY3RvcnknKSgnaWlkJywgIkNhY2hlSWQgJ3swfScgaXMgYWxyZWFkeSB0YWtlbiEiLCBjYWNoZUlkKTsKICAgICAgfQoKICAgICAgdmFyIHNpemUgPSAwLAogICAgICAgICAgc3RhdHMgPSBleHRlbmQoe30sIG9wdGlvbnMsIHtpZDogY2FjaGVJZH0pLAogICAgICAgICAgZGF0YSA9IHt9LAogICAgICAgICAgY2FwYWNpdHkgPSAob3B0aW9ucyAmJiBvcHRpb25zLmNhcGFjaXR5KSB8fCBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgbHJ1SGFzaCA9IHt9LAogICAgICAgICAgZnJlc2hFbmQgPSBudWxsLAogICAgICAgICAgc3RhbGVFbmQgPSBudWxsOwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyB0eXBlCiAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEEgY2FjaGUgb2JqZWN0IHVzZWQgdG8gc3RvcmUgYW5kIHJldHJpZXZlIGRhdGEsIHByaW1hcmlseSB1c2VkIGJ5CiAgICAgICAqIHtAbGluayAkaHR0cCAkaHR0cH0gYW5kIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOnNjcmlwdCBzY3JpcHR9IGRpcmVjdGl2ZSB0byBjYWNoZQogICAgICAgKiB0ZW1wbGF0ZXMgYW5kIG90aGVyIGRhdGEuCiAgICAgICAqCiAgICAgICAqIGBgYGpzCiAgICAgICAqICBhbmd1bGFyLm1vZHVsZSgnc3VwZXJDYWNoZScpCiAgICAgICAqICAgIC5mYWN0b3J5KCdzdXBlckNhY2hlJywgWyckY2FjaGVGYWN0b3J5JywgZnVuY3Rpb24oJGNhY2hlRmFjdG9yeSkgewogICAgICAgKiAgICAgIHJldHVybiAkY2FjaGVGYWN0b3J5KCdzdXBlci1jYWNoZScpOwogICAgICAgKiAgICB9XSk7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKiBFeGFtcGxlIHRlc3Q6CiAgICAgICAqCiAgICAgICAqIGBgYGpzCiAgICAgICAqICBpdCgnc2hvdWxkIGJlaGF2ZSBsaWtlIGEgY2FjaGUnLCBpbmplY3QoZnVuY3Rpb24oc3VwZXJDYWNoZSkgewogICAgICAgKiAgICBzdXBlckNhY2hlLnB1dCgna2V5JywgJ3ZhbHVlJyk7CiAgICAgICAqICAgIHN1cGVyQ2FjaGUucHV0KCdhbm90aGVyIGtleScsICdhbm90aGVyIHZhbHVlJyk7CiAgICAgICAqCiAgICAgICAqICAgIGV4cGVjdChzdXBlckNhY2hlLmluZm8oKSkudG9FcXVhbCh7CiAgICAgICAqICAgICAgaWQ6ICdzdXBlci1jYWNoZScsCiAgICAgICAqICAgICAgc2l6ZTogMgogICAgICAgKiAgICB9KTsKICAgICAgICoKICAgICAgICogICAgc3VwZXJDYWNoZS5yZW1vdmUoJ2Fub3RoZXIga2V5Jyk7CiAgICAgICAqICAgIGV4cGVjdChzdXBlckNhY2hlLmdldCgnYW5vdGhlciBrZXknKSkudG9CZVVuZGVmaW5lZCgpOwogICAgICAgKgogICAgICAgKiAgICBzdXBlckNhY2hlLnJlbW92ZUFsbCgpOwogICAgICAgKiAgICBleHBlY3Qoc3VwZXJDYWNoZS5pbmZvKCkpLnRvRXF1YWwoewogICAgICAgKiAgICAgIGlkOiAnc3VwZXItY2FjaGUnLAogICAgICAgKiAgICAgIHNpemU6IDAKICAgICAgICogICAgfSk7CiAgICAgICAqICB9KSk7CiAgICAgICAqIGBgYAogICAgICAgKi8KICAgICAgcmV0dXJuIGNhY2hlc1tjYWNoZUlkXSA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjcHV0CiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEluc2VydHMgYSBuYW1lZCBlbnRyeSBpbnRvIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0IHRvIGJlCiAgICAgICAgICogcmV0cmlldmVkIGxhdGVyLCBhbmQgaW5jcmVtZW50aW5nIHRoZSBzaXplIG9mIHRoZSBjYWNoZSBpZiB0aGUga2V5IHdhcyBub3QgYWxyZWFkeQogICAgICAgICAqIHByZXNlbnQgaW4gdGhlIGNhY2hlLiBJZiBiZWhhdmluZyBsaWtlIGFuIExSVSBjYWNoZSwgaXQgd2lsbCBhbHNvIHJlbW92ZSBzdGFsZQogICAgICAgICAqIGVudHJpZXMgZnJvbSB0aGUgc2V0LgogICAgICAgICAqCiAgICAgICAgICogSXQgd2lsbCBub3QgaW5zZXJ0IHVuZGVmaW5lZCB2YWx1ZXMgaW50byB0aGUgY2FjaGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IHRoZSBrZXkgdW5kZXIgd2hpY2ggdGhlIGNhY2hlZCBkYXRhIGlzIHN0b3JlZC4KICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIHRoZSB2YWx1ZSB0byBzdG9yZSBhbG9uZ3NpZGUgdGhlIGtleS4gSWYgaXQgaXMgdW5kZWZpbmVkLCB0aGUga2V5CiAgICAgICAgICogICAgd2lsbCBub3QgYmUgc3RvcmVkLgogICAgICAgICAqIEByZXR1cm5zIHsqfSB0aGUgdmFsdWUgc3RvcmVkLgogICAgICAgICAqLwogICAgICAgIHB1dDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgaWYgKGNhcGFjaXR5IDwgTnVtYmVyLk1BWF9WQUxVRSkgewogICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV0gfHwgKGxydUhhc2hba2V5XSA9IHtrZXk6IGtleX0pOwoKICAgICAgICAgICAgcmVmcmVzaChscnVFbnRyeSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgaWYgKCEoa2V5IGluIGRhdGEpKSBzaXplKys7CiAgICAgICAgICBkYXRhW2tleV0gPSB2YWx1ZTsKCiAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlKHN0YWxlRW5kLmtleSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI2dldAogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZXRyaWV2ZXMgbmFtZWQgZGF0YSBzdG9yZWQgaW4gdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IHRoZSBrZXkgb2YgdGhlIGRhdGEgdG8gYmUgcmV0cmlldmVkCiAgICAgICAgICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSBzdG9yZWQuCiAgICAgICAgICovCiAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmIChjYXBhY2l0eSA8IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgaWYgKCFscnVFbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgcmVmcmVzaChscnVFbnRyeSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGRhdGFba2V5XTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjcmVtb3ZlCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlbW92ZXMgYW4gZW50cnkgZnJvbSB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgdGhlIGtleSBvZiB0aGUgZW50cnkgdG8gYmUgcmVtb3ZlZAogICAgICAgICAqLwogICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZiAoY2FwYWNpdHkgPCBOdW1iZXIuTUFYX1ZBTFVFKSB7CiAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XTsKCiAgICAgICAgICAgIGlmICghbHJ1RW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChscnVFbnRyeSA9PSBmcmVzaEVuZCkgZnJlc2hFbmQgPSBscnVFbnRyeS5wOwogICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gc3RhbGVFbmQpIHN0YWxlRW5kID0gbHJ1RW50cnkubjsKICAgICAgICAgICAgbGluayhscnVFbnRyeS5uLGxydUVudHJ5LnApOwoKICAgICAgICAgICAgZGVsZXRlIGxydUhhc2hba2V5XTsKICAgICAgICAgIH0KCiAgICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICAgICAgc2l6ZS0tOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNyZW1vdmVBbGwKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ2xlYXJzIHRoZSBjYWNoZSBvYmplY3Qgb2YgYW55IGVudHJpZXMuCiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlQWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAgIGRhdGEgPSB7fTsKICAgICAgICAgIHNpemUgPSAwOwogICAgICAgICAgbHJ1SGFzaCA9IHt9OwogICAgICAgICAgZnJlc2hFbmQgPSBzdGFsZUVuZCA9IG51bGw7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI2Rlc3Ryb3kKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogRGVzdHJveXMgdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3QgZW50aXJlbHksCiAgICAgICAgICogcmVtb3ZpbmcgaXQgZnJvbSB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkgJGNhY2hlRmFjdG9yeX0gc2V0LgogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZGF0YSA9IG51bGw7CiAgICAgICAgICBzdGF0cyA9IG51bGw7CiAgICAgICAgICBscnVIYXNoID0gbnVsbDsKICAgICAgICAgIGRlbGV0ZSBjYWNoZXNbY2FjaGVJZF07CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI2luZm8KICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmV0cmlldmUgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGEgcGFydGljdWxhciB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0uCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBhbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgICAgICogICA8dWw+CiAgICAgICAgICogICAgIDxsaT4qKmlkKio6IHRoZSBpZCBvZiB0aGUgY2FjaGUgaW5zdGFuY2U8L2xpPgogICAgICAgICAqICAgICA8bGk+KipzaXplKio6IHRoZSBudW1iZXIgb2YgZW50cmllcyBrZXB0IGluIHRoZSBjYWNoZSBpbnN0YW5jZTwvbGk+CiAgICAgICAgICogICAgIDxsaT4qKi4uLioqOiBhbnkgYWRkaXRpb25hbCBwcm9wZXJ0aWVzIGZyb20gdGhlIG9wdGlvbnMgb2JqZWN0IHdoZW4gY3JlYXRpbmcgdGhlCiAgICAgICAgICogICAgICAgY2FjaGUuPC9saT4KICAgICAgICAgKiAgIDwvdWw+CiAgICAgICAgICovCiAgICAgICAgaW5mbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gZXh0ZW5kKHt9LCBzdGF0cywge3NpemU6IHNpemV9KTsKICAgICAgICB9CiAgICAgIH07CgoKICAgICAgLyoqCiAgICAgICAqIG1ha2VzIHRoZSBgZW50cnlgIHRoZSBmcmVzaEVuZCBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAqLwogICAgICBmdW5jdGlvbiByZWZyZXNoKGVudHJ5KSB7CiAgICAgICAgaWYgKGVudHJ5ICE9IGZyZXNoRW5kKSB7CiAgICAgICAgICBpZiAoIXN0YWxlRW5kKSB7CiAgICAgICAgICAgIHN0YWxlRW5kID0gZW50cnk7CiAgICAgICAgICB9IGVsc2UgaWYgKHN0YWxlRW5kID09IGVudHJ5KSB7CiAgICAgICAgICAgIHN0YWxlRW5kID0gZW50cnkubjsKICAgICAgICAgIH0KCiAgICAgICAgICBsaW5rKGVudHJ5Lm4sIGVudHJ5LnApOwogICAgICAgICAgbGluayhlbnRyeSwgZnJlc2hFbmQpOwogICAgICAgICAgZnJlc2hFbmQgPSBlbnRyeTsKICAgICAgICAgIGZyZXNoRW5kLm4gPSBudWxsOwogICAgICAgIH0KICAgICAgfQoKCiAgICAgIC8qKgogICAgICAgKiBiaWRpcmVjdGlvbmFsbHkgbGlua3MgdHdvIGVudHJpZXMgb2YgdGhlIExSVSBsaW5rZWQgbGlzdAogICAgICAgKi8KICAgICAgZnVuY3Rpb24gbGluayhuZXh0RW50cnksIHByZXZFbnRyeSkgewogICAgICAgIGlmIChuZXh0RW50cnkgIT0gcHJldkVudHJ5KSB7CiAgICAgICAgICBpZiAobmV4dEVudHJ5KSBuZXh0RW50cnkucCA9IHByZXZFbnRyeTsgLy9wIHN0YW5kcyBmb3IgcHJldmlvdXMsICdwcmV2JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICBpZiAocHJldkVudHJ5KSBwcmV2RW50cnkubiA9IG5leHRFbnRyeTsgLy9uIHN0YW5kcyBmb3IgbmV4dCwgJ25leHQnIGRpZG4ndCBtaW5pZnkKICAgICAgICB9CiAgICAgIH0KICAgIH0KCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5I2luZm8KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEdldCBpbmZvcm1hdGlvbiBhYm91dCBhbGwgdGhlIGNhY2hlcyB0aGF0IGhhdmUgYmVlbiBjcmVhdGVkCiAgICoKICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIGtleS12YWx1ZSBtYXAgb2YgYGNhY2hlSWRgIHRvIHRoZSByZXN1bHQgb2YgY2FsbGluZyBgY2FjaGUjaW5mb2AKICAgKi8KICAgIGNhY2hlRmFjdG9yeS5pbmZvID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpbmZvID0ge307CiAgICAgIGZvckVhY2goY2FjaGVzLCBmdW5jdGlvbihjYWNoZSwgY2FjaGVJZCkgewogICAgICAgIGluZm9bY2FjaGVJZF0gPSBjYWNoZS5pbmZvKCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gaW5mbzsKICAgIH07CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNhY2hlRmFjdG9yeSNnZXQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEdldCBhY2Nlc3MgdG8gYSBjYWNoZSBvYmplY3QgYnkgdGhlIGBjYWNoZUlkYCB1c2VkIHdoZW4gaXQgd2FzIGNyZWF0ZWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVJZCBOYW1lIG9yIGlkIG9mIGEgY2FjaGUgdG8gYWNjZXNzLgogICAqIEByZXR1cm5zIHtvYmplY3R9IENhY2hlIG9iamVjdCBpZGVudGlmaWVkIGJ5IHRoZSBjYWNoZUlkIG9yIHVuZGVmaW5lZCBpZiBubyBzdWNoIGNhY2hlLgogICAqLwogICAgY2FjaGVGYWN0b3J5LmdldCA9IGZ1bmN0aW9uKGNhY2hlSWQpIHsKICAgICAgcmV0dXJuIGNhY2hlc1tjYWNoZUlkXTsKICAgIH07CgoKICAgIHJldHVybiBjYWNoZUZhY3Rvcnk7CiAgfTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICR0ZW1wbGF0ZUNhY2hlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgZmlyc3QgdGltZSBhIHRlbXBsYXRlIGlzIHVzZWQsIGl0IGlzIGxvYWRlZCBpbiB0aGUgdGVtcGxhdGUgY2FjaGUgZm9yIHF1aWNrIHJldHJpZXZhbC4gWW91CiAqIGNhbiBsb2FkIHRlbXBsYXRlcyBkaXJlY3RseSBpbnRvIHRoZSBjYWNoZSBpbiBhIGBzY3JpcHRgIHRhZywgb3IgYnkgY29uc3VtaW5nIHRoZQogKiBgJHRlbXBsYXRlQ2FjaGVgIHNlcnZpY2UgZGlyZWN0bHkuCiAqCiAqIEFkZGluZyB2aWEgdGhlIGBzY3JpcHRgIHRhZzoKICoKICogYGBgaHRtbAogKiAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlSWQuaHRtbCI+CiAqICAgICA8cD5UaGlzIGlzIHRoZSBjb250ZW50IG9mIHRoZSB0ZW1wbGF0ZTwvcD4KICogICA8L3NjcmlwdD4KICogYGBgCiAqCiAqICoqTm90ZToqKiB0aGUgYHNjcmlwdGAgdGFnIGNvbnRhaW5pbmcgdGhlIHRlbXBsYXRlIGRvZXMgbm90IG5lZWQgdG8gYmUgaW5jbHVkZWQgaW4gdGhlIGBoZWFkYCBvZgogKiB0aGUgZG9jdW1lbnQsIGJ1dCBpdCBtdXN0IGJlIGJlbG93IHRoZSBgbmctYXBwYCBkZWZpbml0aW9uLgogKgogKiBBZGRpbmcgdmlhIHRoZSAkdGVtcGxhdGVDYWNoZSBzZXJ2aWNlOgogKgogKiBgYGBqcwogKiB2YXIgbXlBcHAgPSBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbXSk7CiAqIG15QXBwLnJ1bihmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewogKiAgICR0ZW1wbGF0ZUNhY2hlLnB1dCgndGVtcGxhdGVJZC5odG1sJywgJ1RoaXMgaXMgdGhlIGNvbnRlbnQgb2YgdGhlIHRlbXBsYXRlJyk7CiAqIH0pOwogKiBgYGAKICoKICogVG8gcmV0cmlldmUgdGhlIHRlbXBsYXRlIGxhdGVyLCBzaW1wbHkgdXNlIGl0IGluIHlvdXIgSFRNTDoKICogYGBgaHRtbAogKiA8ZGl2IG5nLWluY2x1ZGU9IiAndGVtcGxhdGVJZC5odG1sJyAiPjwvZGl2PgogKiBgYGAKICoKICogb3IgZ2V0IGl0IHZpYSBKYXZhc2NyaXB0OgogKiBgYGBqcwogKiAkdGVtcGxhdGVDYWNoZS5nZXQoJ3RlbXBsYXRlSWQuaHRtbCcpCiAqIGBgYAogKgogKiBTZWUge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgJGNhY2hlRmFjdG9yeX0uCiAqCiAqLwpmdW5jdGlvbiAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJGNhY2hlRmFjdG9yeScsIGZ1bmN0aW9uKCRjYWNoZUZhY3RvcnkpIHsKICAgIHJldHVybiAkY2FjaGVGYWN0b3J5KCd0ZW1wbGF0ZXMnKTsKICB9XTsKfQoKLyogISBWQVJJQUJMRS9GVU5DVElPTiBOQU1JTkcgQ09OVkVOVElPTlMgVEhBVCBBUFBMWSBUTyBUSElTIEZJTEUhCiAqCiAqIERPTS1yZWxhdGVkIHZhcmlhYmxlczoKICoKICogLSAibm9kZSIgLSBET00gTm9kZQogKiAtICJlbGVtZW50IiAtIERPTSBFbGVtZW50IG9yIE5vZGUKICogLSAiJG5vZGUiIG9yICIkZWxlbWVudCIgLSBqcUxpdGUtd3JhcHBlZCBub2RlIG9yIGVsZW1lbnQKICoKICoKICogQ29tcGlsZXIgcmVsYXRlZCBzdHVmZjoKICoKICogLSAibGlua0ZuIiAtIGxpbmtpbmcgZm4gb2YgYSBzaW5nbGUgZGlyZWN0aXZlCiAqIC0gIm5vZGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUKICogLSAiY2hpbGRMaW5rRm4iIC0gIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGNoaWxkIG5vZGVzIG9mIGEgcGFydGljdWxhciBub2RlCiAqIC0gImNvbXBvc2l0ZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIGNvbXBpbGF0aW9uIHJvb3QgKG5vZGVMaXN0KQogKi8KCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGNvbXBpbGUKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIENvbXBpbGVzIGFuIEhUTUwgc3RyaW5nIG9yIERPTSBpbnRvIGEgdGVtcGxhdGUgYW5kIHByb2R1Y2VzIGEgdGVtcGxhdGUgZnVuY3Rpb24sIHdoaWNoCiAqIGNhbiB0aGVuIGJlIHVzZWQgdG8gbGluayB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBgc2NvcGVgfSBhbmQgdGhlIHRlbXBsYXRlIHRvZ2V0aGVyLgogKgogKiBUaGUgY29tcGlsYXRpb24gaXMgYSBwcm9jZXNzIG9mIHdhbGtpbmcgdGhlIERPTSB0cmVlIGFuZCBtYXRjaGluZyBET00gZWxlbWVudHMgdG8KICoge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIFRoaXMgZG9jdW1lbnQgaXMgYW4gaW4tZGVwdGggcmVmZXJlbmNlIG9mIGFsbCBkaXJlY3RpdmUgb3B0aW9ucy4KICogRm9yIGEgZ2VudGxlIGludHJvZHVjdGlvbiB0byBkaXJlY3RpdmVzIHdpdGggZXhhbXBsZXMgb2YgY29tbW9uIHVzZSBjYXNlcywKICogc2VlIHRoZSB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlIGRpcmVjdGl2ZSBndWlkZX0uCiAqIDwvZGl2PgogKgogKiAjIyBDb21wcmVoZW5zaXZlIERpcmVjdGl2ZSBBUEkKICoKICogVGhlcmUgYXJlIG1hbnkgZGlmZmVyZW50IG9wdGlvbnMgZm9yIGEgZGlyZWN0aXZlLgogKgogKiBUaGUgZGlmZmVyZW5jZSByZXNpZGVzIGluIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZhY3RvcnkgZnVuY3Rpb24uCiAqIFlvdSBjYW4gZWl0aGVyIHJldHVybiBhICJEaXJlY3RpdmUgRGVmaW5pdGlvbiBPYmplY3QiIChzZWUgYmVsb3cpIHRoYXQgZGVmaW5lcyB0aGUgZGlyZWN0aXZlIHByb3BlcnRpZXMsCiAqIG9yIGp1c3QgdGhlIGBwb3N0TGlua2AgZnVuY3Rpb24gKGFsbCBvdGhlciBwcm9wZXJ0aWVzIHdpbGwgaGF2ZSB0aGUgZGVmYXVsdCB2YWx1ZXMpLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1zdWNjZXNzIj4KICogKipCZXN0IFByYWN0aWNlOioqIEl0J3MgcmVjb21tZW5kZWQgdG8gdXNlIHRoZSAiZGlyZWN0aXZlIGRlZmluaXRpb24gb2JqZWN0IiBmb3JtLgogKiA8L2Rpdj4KICoKICogSGVyZSdzIGFuIGV4YW1wbGUgZGlyZWN0aXZlIGRlY2xhcmVkIHdpdGggYSBEaXJlY3RpdmUgRGVmaW5pdGlvbiBPYmplY3Q6CiAqCiAqIGBgYGpzCiAqICAgdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoLi4uKTsKICoKICogICBteU1vZHVsZS5kaXJlY3RpdmUoJ2RpcmVjdGl2ZU5hbWUnLCBmdW5jdGlvbiBmYWN0b3J5KGluamVjdGFibGVzKSB7CiAqICAgICB2YXIgZGlyZWN0aXZlRGVmaW5pdGlvbk9iamVjdCA9IHsKICogICAgICAgcHJpb3JpdHk6IDAsCiAqICAgICAgIHRlbXBsYXRlOiAnPGRpdj48L2Rpdj4nLCAvLyBvciAvLyBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7IC4uLiB9LAogKiAgICAgICAvLyBvcgogKiAgICAgICAvLyB0ZW1wbGF0ZVVybDogJ2RpcmVjdGl2ZS5odG1sJywgLy8gb3IgLy8gZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgeyAuLi4gfSwKICogICAgICAgdHJhbnNjbHVkZTogZmFsc2UsCiAqICAgICAgIHJlc3RyaWN0OiAnQScsCiAqICAgICAgIHNjb3BlOiBmYWxzZSwKICogICAgICAgY29udHJvbGxlcjogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCAkdHJhbnNjbHVkZSwgb3RoZXJJbmplY3RhYmxlcykgeyAuLi4gfSwKICogICAgICAgY29udHJvbGxlckFzOiAnc3RyaW5nQWxpYXMnLAogKiAgICAgICByZXF1aXJlOiAnc2libGluZ0RpcmVjdGl2ZU5hbWUnLCAvLyBvciAvLyBbJ15wYXJlbnREaXJlY3RpdmVOYW1lJywgJz9vcHRpb25hbERpcmVjdGl2ZU5hbWUnLCAnP15vcHRpb25hbFBhcmVudCddLAogKiAgICAgICBjb21waWxlOiBmdW5jdGlvbiBjb21waWxlKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpIHsKICogICAgICAgICByZXR1cm4gewogKiAgICAgICAgICAgcHJlOiBmdW5jdGlvbiBwcmVMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzLCBjb250cm9sbGVyKSB7IC4uLiB9LAogKiAgICAgICAgICAgcG9zdDogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIpIHsgLi4uIH0KICogICAgICAgICB9CiAqICAgICAgICAgLy8gb3IKICogICAgICAgICAvLyByZXR1cm4gZnVuY3Rpb24gcG9zdExpbmsoIC4uLiApIHsgLi4uIH0KICogICAgICAgfSwKICogICAgICAgLy8gb3IKICogICAgICAgLy8gbGluazogewogKiAgICAgICAvLyAgcHJlOiBmdW5jdGlvbiBwcmVMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzLCBjb250cm9sbGVyKSB7IC4uLiB9LAogKiAgICAgICAvLyAgcG9zdDogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIpIHsgLi4uIH0KICogICAgICAgLy8gfQogKiAgICAgICAvLyBvcgogKiAgICAgICAvLyBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayggLi4uICkgeyAuLi4gfQogKiAgICAgfTsKICogICAgIHJldHVybiBkaXJlY3RpdmVEZWZpbml0aW9uT2JqZWN0OwogKiAgIH0pOwogKiBgYGAKICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZToqKiBBbnkgdW5zcGVjaWZpZWQgb3B0aW9ucyB3aWxsIHVzZSB0aGUgZGVmYXVsdCB2YWx1ZS4gWW91IGNhbiBzZWUgdGhlIGRlZmF1bHQgdmFsdWVzIGJlbG93LgogKiA8L2Rpdj4KICoKICogVGhlcmVmb3JlIHRoZSBhYm92ZSBjYW4gYmUgc2ltcGxpZmllZCBhczoKICoKICogYGBganMKICogICB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSguLi4pOwogKgogKiAgIG15TW9kdWxlLmRpcmVjdGl2ZSgnZGlyZWN0aXZlTmFtZScsIGZ1bmN0aW9uIGZhY3RvcnkoaW5qZWN0YWJsZXMpIHsKICogICAgIHZhciBkaXJlY3RpdmVEZWZpbml0aW9uT2JqZWN0ID0gewogKiAgICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycykgeyAuLi4gfQogKiAgICAgfTsKICogICAgIHJldHVybiBkaXJlY3RpdmVEZWZpbml0aW9uT2JqZWN0OwogKiAgICAgLy8gb3IKICogICAgIC8vIHJldHVybiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycykgeyAuLi4gfQogKiAgIH0pOwogKiBgYGAKICoKICoKICoKICogIyMjIERpcmVjdGl2ZSBEZWZpbml0aW9uIE9iamVjdAogKgogKiBUaGUgZGlyZWN0aXZlIGRlZmluaXRpb24gb2JqZWN0IHByb3ZpZGVzIGluc3RydWN0aW9ucyB0byB0aGUge0BsaW5rIG5nLiRjb21waWxlCiAqIGNvbXBpbGVyfS4gVGhlIGF0dHJpYnV0ZXMgYXJlOgogKgogKiAjIyMjIGBwcmlvcml0eWAKICogV2hlbiB0aGVyZSBhcmUgbXVsdGlwbGUgZGlyZWN0aXZlcyBkZWZpbmVkIG9uIGEgc2luZ2xlIERPTSBlbGVtZW50LCBzb21ldGltZXMgaXQKICogaXMgbmVjZXNzYXJ5IHRvIHNwZWNpZnkgdGhlIG9yZGVyIGluIHdoaWNoIHRoZSBkaXJlY3RpdmVzIGFyZSBhcHBsaWVkLiBUaGUgYHByaW9yaXR5YCBpcyB1c2VkCiAqIHRvIHNvcnQgdGhlIGRpcmVjdGl2ZXMgYmVmb3JlIHRoZWlyIGBjb21waWxlYCBmdW5jdGlvbnMgZ2V0IGNhbGxlZC4gUHJpb3JpdHkgaXMgZGVmaW5lZCBhcyBhCiAqIG51bWJlci4gRGlyZWN0aXZlcyB3aXRoIGdyZWF0ZXIgbnVtZXJpY2FsIGBwcmlvcml0eWAgYXJlIGNvbXBpbGVkIGZpcnN0LiBQcmUtbGluayBmdW5jdGlvbnMKICogYXJlIGFsc28gcnVuIGluIHByaW9yaXR5IG9yZGVyLCBidXQgcG9zdC1saW5rIGZ1bmN0aW9ucyBhcmUgcnVuIGluIHJldmVyc2Ugb3JkZXIuIFRoZSBvcmRlcgogKiBvZiBkaXJlY3RpdmVzIHdpdGggdGhlIHNhbWUgcHJpb3JpdHkgaXMgdW5kZWZpbmVkLiBUaGUgZGVmYXVsdCBwcmlvcml0eSBpcyBgMGAuCiAqCiAqICMjIyMgYHRlcm1pbmFsYAogKiBJZiBzZXQgdG8gdHJ1ZSB0aGVuIHRoZSBjdXJyZW50IGBwcmlvcml0eWAgd2lsbCBiZSB0aGUgbGFzdCBzZXQgb2YgZGlyZWN0aXZlcwogKiB3aGljaCB3aWxsIGV4ZWN1dGUgKGFueSBkaXJlY3RpdmVzIGF0IHRoZSBjdXJyZW50IHByaW9yaXR5IHdpbGwgc3RpbGwgZXhlY3V0ZQogKiBhcyB0aGUgb3JkZXIgb2YgZXhlY3V0aW9uIG9uIHNhbWUgYHByaW9yaXR5YCBpcyB1bmRlZmluZWQpLgogKgogKiAjIyMjIGBzY29wZWAKICogKipJZiBzZXQgdG8gYHRydWVgLCoqIHRoZW4gYSBuZXcgc2NvcGUgd2lsbCBiZSBjcmVhdGVkIGZvciB0aGlzIGRpcmVjdGl2ZS4gSWYgbXVsdGlwbGUgZGlyZWN0aXZlcyBvbiB0aGUKICogc2FtZSBlbGVtZW50IHJlcXVlc3QgYSBuZXcgc2NvcGUsIG9ubHkgb25lIG5ldyBzY29wZSBpcyBjcmVhdGVkLiBUaGUgbmV3IHNjb3BlIHJ1bGUgZG9lcyBub3QKICogYXBwbHkgZm9yIHRoZSByb290IG9mIHRoZSB0ZW1wbGF0ZSBzaW5jZSB0aGUgcm9vdCBvZiB0aGUgdGVtcGxhdGUgYWx3YXlzIGdldHMgYSBuZXcgc2NvcGUuCiAqCiAqICoqSWYgc2V0IHRvIGB7fWAgKG9iamVjdCBoYXNoKSwqKiB0aGVuIGEgbmV3ICJpc29sYXRlIiBzY29wZSBpcyBjcmVhdGVkLiBUaGUgJ2lzb2xhdGUnIHNjb3BlIGRpZmZlcnMgZnJvbQogKiBub3JtYWwgc2NvcGUgaW4gdGhhdCBpdCBkb2VzIG5vdCBwcm90b3R5cGljYWxseSBpbmhlcml0IGZyb20gdGhlIHBhcmVudCBzY29wZS4gVGhpcyBpcyB1c2VmdWwKICogd2hlbiBjcmVhdGluZyByZXVzYWJsZSBjb21wb25lbnRzLCB3aGljaCBzaG91bGQgbm90IGFjY2lkZW50YWxseSByZWFkIG9yIG1vZGlmeSBkYXRhIGluIHRoZQogKiBwYXJlbnQgc2NvcGUuCiAqCiAqIFRoZSAnaXNvbGF0ZScgc2NvcGUgdGFrZXMgYW4gb2JqZWN0IGhhc2ggd2hpY2ggZGVmaW5lcyBhIHNldCBvZiBsb2NhbCBzY29wZSBwcm9wZXJ0aWVzCiAqIGRlcml2ZWQgZnJvbSB0aGUgcGFyZW50IHNjb3BlLiBUaGVzZSBsb2NhbCBwcm9wZXJ0aWVzIGFyZSB1c2VmdWwgZm9yIGFsaWFzaW5nIHZhbHVlcyBmb3IKICogdGVtcGxhdGVzLiBMb2NhbHMgZGVmaW5pdGlvbiBpcyBhIGhhc2ggb2YgbG9jYWwgc2NvcGUgcHJvcGVydHkgdG8gaXRzIHNvdXJjZToKICoKICogKiBgQGAgb3IgYEBhdHRyYCAtIGJpbmQgYSBsb2NhbCBzY29wZSBwcm9wZXJ0eSB0byB0aGUgdmFsdWUgb2YgRE9NIGF0dHJpYnV0ZS4gVGhlIHJlc3VsdCBpcwogKiAgIGFsd2F5cyBhIHN0cmluZyBzaW5jZSBET00gYXR0cmlidXRlcyBhcmUgc3RyaW5ncy4gSWYgbm8gYGF0dHJgIG5hbWUgaXMgc3BlY2lmaWVkICB0aGVuIHRoZQogKiAgIGF0dHJpYnV0ZSBuYW1lIGlzIGFzc3VtZWQgdG8gYmUgdGhlIHNhbWUgYXMgdGhlIGxvY2FsIG5hbWUuCiAqICAgR2l2ZW4gYDx3aWRnZXQgbXktYXR0cj0iaGVsbG8ge3tuYW1lfX0iPmAgYW5kIHdpZGdldCBkZWZpbml0aW9uCiAqICAgb2YgYHNjb3BlOiB7IGxvY2FsTmFtZTonQG15QXR0cicgfWAsIHRoZW4gd2lkZ2V0IHNjb3BlIHByb3BlcnR5IGBsb2NhbE5hbWVgIHdpbGwgcmVmbGVjdAogKiAgIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUgb2YgYGhlbGxvIHt7bmFtZX19YC4gQXMgdGhlIGBuYW1lYCBhdHRyaWJ1dGUgY2hhbmdlcyBzbyB3aWxsIHRoZQogKiAgIGBsb2NhbE5hbWVgIHByb3BlcnR5IG9uIHRoZSB3aWRnZXQgc2NvcGUuIFRoZSBgbmFtZWAgaXMgcmVhZCBmcm9tIHRoZSBwYXJlbnQgc2NvcGUgKG5vdAogKiAgIGNvbXBvbmVudCBzY29wZSkuCiAqCiAqICogYD1gIG9yIGA9YXR0cmAgLSBzZXQgdXAgYmktZGlyZWN0aW9uYWwgYmluZGluZyBiZXR3ZWVuIGEgbG9jYWwgc2NvcGUgcHJvcGVydHkgYW5kIHRoZQogKiAgIHBhcmVudCBzY29wZSBwcm9wZXJ0eSBvZiBuYW1lIGRlZmluZWQgdmlhIHRoZSB2YWx1ZSBvZiB0aGUgYGF0dHJgIGF0dHJpYnV0ZS4gSWYgbm8gYGF0dHJgCiAqICAgbmFtZSBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgYXR0cmlidXRlIG5hbWUgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2FtZSBhcyB0aGUgbG9jYWwgbmFtZS4KICogICBHaXZlbiBgPHdpZGdldCBteS1hdHRyPSJwYXJlbnRNb2RlbCI+YCBhbmQgd2lkZ2V0IGRlZmluaXRpb24gb2YKICogICBgc2NvcGU6IHsgbG9jYWxNb2RlbDonPW15QXR0cicgfWAsIHRoZW4gd2lkZ2V0IHNjb3BlIHByb3BlcnR5IGBsb2NhbE1vZGVsYCB3aWxsIHJlZmxlY3QgdGhlCiAqICAgdmFsdWUgb2YgYHBhcmVudE1vZGVsYCBvbiB0aGUgcGFyZW50IHNjb3BlLiBBbnkgY2hhbmdlcyB0byBgcGFyZW50TW9kZWxgIHdpbGwgYmUgcmVmbGVjdGVkCiAqICAgaW4gYGxvY2FsTW9kZWxgIGFuZCBhbnkgY2hhbmdlcyBpbiBgbG9jYWxNb2RlbGAgd2lsbCByZWZsZWN0IGluIGBwYXJlbnRNb2RlbGAuIElmIHRoZSBwYXJlbnQKICogICBzY29wZSBwcm9wZXJ0eSBkb2Vzbid0IGV4aXN0LCBpdCB3aWxsIHRocm93IGEgTk9OX0FTU0lHTkFCTEVfTU9ERUxfRVhQUkVTU0lPTiBleGNlcHRpb24uIFlvdQogKiAgIGNhbiBhdm9pZCB0aGlzIGJlaGF2aW9yIHVzaW5nIGA9P2Agb3IgYD0/YXR0cmAgaW4gb3JkZXIgdG8gZmxhZyB0aGUgcHJvcGVydHkgYXMgb3B0aW9uYWwuCiAqCiAqICogYCZgIG9yIGAmYXR0cmAgLSBwcm92aWRlcyBhIHdheSB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gdGhlIGNvbnRleHQgb2YgdGhlIHBhcmVudCBzY29wZS4KICogICBJZiBubyBgYXR0cmAgbmFtZSBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgYXR0cmlidXRlIG5hbWUgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2FtZSBhcyB0aGUKICogICBsb2NhbCBuYW1lLiBHaXZlbiBgPHdpZGdldCBteS1hdHRyPSJjb3VudCA9IGNvdW50ICsgdmFsdWUiPmAgYW5kIHdpZGdldCBkZWZpbml0aW9uIG9mCiAqICAgYHNjb3BlOiB7IGxvY2FsRm46JyZteUF0dHInIH1gLCB0aGVuIGlzb2xhdGUgc2NvcGUgcHJvcGVydHkgYGxvY2FsRm5gIHdpbGwgcG9pbnQgdG8KICogICBhIGZ1bmN0aW9uIHdyYXBwZXIgZm9yIHRoZSBgY291bnQgPSBjb3VudCArIHZhbHVlYCBleHByZXNzaW9uLiBPZnRlbiBpdCdzIGRlc2lyYWJsZSB0bwogKiAgIHBhc3MgZGF0YSBmcm9tIHRoZSBpc29sYXRlZCBzY29wZSB2aWEgYW4gZXhwcmVzc2lvbiBhbmQgdG8gdGhlIHBhcmVudCBzY29wZSwgdGhpcyBjYW4gYmUKICogICBkb25lIGJ5IHBhc3NpbmcgYSBtYXAgb2YgbG9jYWwgdmFyaWFibGUgbmFtZXMgYW5kIHZhbHVlcyBpbnRvIHRoZSBleHByZXNzaW9uIHdyYXBwZXIgZm4uCiAqICAgRm9yIGV4YW1wbGUsIGlmIHRoZSBleHByZXNzaW9uIGlzIGBpbmNyZW1lbnQoYW1vdW50KWAgdGhlbiB3ZSBjYW4gc3BlY2lmeSB0aGUgYW1vdW50IHZhbHVlCiAqICAgYnkgY2FsbGluZyB0aGUgYGxvY2FsRm5gIGFzIGBsb2NhbEZuKHthbW91bnQ6IDIyfSlgLgogKgogKgogKgogKiAjIyMjIGBjb250cm9sbGVyYAogKiBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBUaGUgY29udHJvbGxlciBpcyBpbnN0YW50aWF0ZWQgYmVmb3JlIHRoZQogKiBwcmUtbGlua2luZyBwaGFzZSBhbmQgaXQgaXMgc2hhcmVkIHdpdGggb3RoZXIgZGlyZWN0aXZlcyAoc2VlCiAqIGByZXF1aXJlYCBhdHRyaWJ1dGUpLiBUaGlzIGFsbG93cyB0aGUgZGlyZWN0aXZlcyB0byBjb21tdW5pY2F0ZSB3aXRoIGVhY2ggb3RoZXIgYW5kIGF1Z21lbnQKICogZWFjaCBvdGhlcidzIGJlaGF2aW9yLiBUaGUgY29udHJvbGxlciBpcyBpbmplY3RhYmxlIChhbmQgc3VwcG9ydHMgYnJhY2tldCBub3RhdGlvbikgd2l0aCB0aGUgZm9sbG93aW5nIGxvY2FsczoKICoKICogKiBgJHNjb3BlYCAtIEN1cnJlbnQgc2NvcGUgYXNzb2NpYXRlZCB3aXRoIHRoZSBlbGVtZW50CiAqICogYCRlbGVtZW50YCAtIEN1cnJlbnQgZWxlbWVudAogKiAqIGAkYXR0cnNgIC0gQ3VycmVudCBhdHRyaWJ1dGVzIG9iamVjdCBmb3IgdGhlIGVsZW1lbnQKICogKiBgJHRyYW5zY2x1ZGVgIC0gQSB0cmFuc2NsdWRlIGxpbmtpbmcgZnVuY3Rpb24gcHJlLWJvdW5kIHRvIHRoZSBjb3JyZWN0IHRyYW5zY2x1c2lvbiBzY29wZS4KICogICAgVGhlIHNjb3BlIGNhbiBiZSBvdmVycmlkZGVuIGJ5IGFuIG9wdGlvbmFsIGZpcnN0IGFyZ3VtZW50LgogKiAgIGBmdW5jdGlvbihbc2NvcGVdLCBjbG9uZUxpbmtpbmdGbilgLgogKgogKgogKiAjIyMjIGByZXF1aXJlYAogKiBSZXF1aXJlIGFub3RoZXIgZGlyZWN0aXZlIGFuZCBpbmplY3QgaXRzIGNvbnRyb2xsZXIgYXMgdGhlIGZvdXJ0aCBhcmd1bWVudCB0byB0aGUgbGlua2luZyBmdW5jdGlvbi4gVGhlCiAqIGByZXF1aXJlYCB0YWtlcyBhIHN0cmluZyBuYW1lIChvciBhcnJheSBvZiBzdHJpbmdzKSBvZiB0aGUgZGlyZWN0aXZlKHMpIHRvIHBhc3MgaW4uIElmIGFuIGFycmF5IGlzIHVzZWQsIHRoZQogKiBpbmplY3RlZCBhcmd1bWVudCB3aWxsIGJlIGFuIGFycmF5IGluIGNvcnJlc3BvbmRpbmcgb3JkZXIuIElmIG5vIHN1Y2ggZGlyZWN0aXZlIGNhbiBiZQogKiBmb3VuZCwgb3IgaWYgdGhlIGRpcmVjdGl2ZSBkb2VzIG5vdCBoYXZlIGEgY29udHJvbGxlciwgdGhlbiBhbiBlcnJvciBpcyByYWlzZWQuIFRoZSBuYW1lIGNhbiBiZSBwcmVmaXhlZCB3aXRoOgogKgogKiAqIChubyBwcmVmaXgpIC0gTG9jYXRlIHRoZSByZXF1aXJlZCBjb250cm9sbGVyIG9uIHRoZSBjdXJyZW50IGVsZW1lbnQuIFRocm93IGFuIGVycm9yIGlmIG5vdCBmb3VuZC4KICogKiBgP2AgLSBBdHRlbXB0IHRvIGxvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBvciBwYXNzIGBudWxsYCB0byB0aGUgYGxpbmtgIGZuIGlmIG5vdCBmb3VuZC4KICogKiBgXmAgLSBMb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgYnkgc2VhcmNoaW5nIHRoZSBlbGVtZW50J3MgcGFyZW50cy4gVGhyb3cgYW4gZXJyb3IgaWYgbm90IGZvdW5kLgogKiAqIGA/XmAgLSBBdHRlbXB0IHRvIGxvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBieSBzZWFyY2hpbmcgdGhlIGVsZW1lbnQncyBwYXJlbnRzIG9yIHBhc3MgYG51bGxgIHRvIHRoZQogKiAgIGBsaW5rYCBmbiBpZiBub3QgZm91bmQuCiAqCiAqCiAqICMjIyMgYGNvbnRyb2xsZXJBc2AKICogQ29udHJvbGxlciBhbGlhcyBhdCB0aGUgZGlyZWN0aXZlIHNjb3BlLiBBbiBhbGlhcyBmb3IgdGhlIGNvbnRyb2xsZXIgc28gaXQKICogY2FuIGJlIHJlZmVyZW5jZWQgYXQgdGhlIGRpcmVjdGl2ZSB0ZW1wbGF0ZS4gVGhlIGRpcmVjdGl2ZSBuZWVkcyB0byBkZWZpbmUgYSBzY29wZSBmb3IgdGhpcwogKiBjb25maWd1cmF0aW9uIHRvIGJlIHVzZWQuIFVzZWZ1bCBpbiB0aGUgY2FzZSB3aGVuIGRpcmVjdGl2ZSBpcyB1c2VkIGFzIGNvbXBvbmVudC4KICoKICoKICogIyMjIyBgcmVzdHJpY3RgCiAqIFN0cmluZyBvZiBzdWJzZXQgb2YgYEVBQ01gIHdoaWNoIHJlc3RyaWN0cyB0aGUgZGlyZWN0aXZlIHRvIGEgc3BlY2lmaWMgZGlyZWN0aXZlCiAqIGRlY2xhcmF0aW9uIHN0eWxlLiBJZiBvbWl0dGVkLCB0aGUgZGVmYXVsdCAoYXR0cmlidXRlcyBvbmx5KSBpcyB1c2VkLgogKgogKiAqIGBFYCAtIEVsZW1lbnQgbmFtZTogYDxteS1kaXJlY3RpdmU+PC9teS1kaXJlY3RpdmU+YAogKiAqIGBBYCAtIEF0dHJpYnV0ZSAoZGVmYXVsdCk6IGA8ZGl2IG15LWRpcmVjdGl2ZT0iZXhwIj48L2Rpdj5gCiAqICogYENgIC0gQ2xhc3M6IGA8ZGl2IGNsYXNzPSJteS1kaXJlY3RpdmU6IGV4cDsiPjwvZGl2PmAKICogKiBgTWAgLSBDb21tZW50OiBgPCEtLSBkaXJlY3RpdmU6IG15LWRpcmVjdGl2ZSBleHAgLS0+YAogKgogKgogKiAjIyMjIGB0ZW1wbGF0ZWAKICogcmVwbGFjZSB0aGUgY3VycmVudCBlbGVtZW50IHdpdGggdGhlIGNvbnRlbnRzIG9mIHRoZSBIVE1MLiBUaGUgcmVwbGFjZW1lbnQgcHJvY2VzcwogKiBtaWdyYXRlcyBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgLyBjbGFzc2VzIGZyb20gdGhlIG9sZCBlbGVtZW50IHRvIHRoZSBuZXcgb25lLiBTZWUgdGhlCiAqIHtAbGluayBndWlkZS9kaXJlY3RpdmUjY3JlYXRpbmctY3VzdG9tLWRpcmVjdGl2ZXNfY3JlYXRpbmctZGlyZWN0aXZlc190ZW1wbGF0ZS1leHBhbmRpbmctZGlyZWN0aXZlCiAqIERpcmVjdGl2ZXMgR3VpZGV9IGZvciBhbiBleGFtcGxlLgogKgogKiBZb3UgY2FuIHNwZWNpZnkgYHRlbXBsYXRlYCBhcyBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIHRlbXBsYXRlIG9yIGFzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMKICogdHdvIGFyZ3VtZW50cyBgdEVsZW1lbnRgIGFuZCBgdEF0dHJzYCAoZGVzY3JpYmVkIGluIHRoZSBgY29tcGlsZWAgZnVuY3Rpb24gYXBpIGJlbG93KSBhbmQKICogcmV0dXJucyBhIHN0cmluZyB2YWx1ZSByZXByZXNlbnRpbmcgdGhlIHRlbXBsYXRlLgogKgogKgogKiAjIyMjIGB0ZW1wbGF0ZVVybGAKICogU2FtZSBhcyBgdGVtcGxhdGVgIGJ1dCB0aGUgdGVtcGxhdGUgaXMgbG9hZGVkIGZyb20gdGhlIHNwZWNpZmllZCBVUkwuIEJlY2F1c2UKICogdGhlIHRlbXBsYXRlIGxvYWRpbmcgaXMgYXN5bmNocm9ub3VzIHRoZSBjb21waWxhdGlvbi9saW5raW5nIGlzIHN1c3BlbmRlZCB1bnRpbCB0aGUgdGVtcGxhdGUKICogaXMgbG9hZGVkLgogKgogKiBZb3UgY2FuIHNwZWNpZnkgYHRlbXBsYXRlVXJsYCBhcyBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIFVSTCBvciBhcyBhIGZ1bmN0aW9uIHdoaWNoIHRha2VzIHR3bwogKiBhcmd1bWVudHMgYHRFbGVtZW50YCBhbmQgYHRBdHRyc2AgKGRlc2NyaWJlZCBpbiB0aGUgYGNvbXBpbGVgIGZ1bmN0aW9uIGFwaSBiZWxvdykgYW5kIHJldHVybnMKICogYSBzdHJpbmcgdmFsdWUgcmVwcmVzZW50aW5nIHRoZSB1cmwuICBJbiBlaXRoZXIgY2FzZSwgdGhlIHRlbXBsYXRlIFVSTCBpcyBwYXNzZWQgdGhyb3VnaCB7QGxpbmsKICogYXBpL25nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfS4KICoKICoKICogIyMjIyBgcmVwbGFjZWAgKFsqREVQUkVDQVRFRCohXSwgd2lsbCBiZSByZW1vdmVkIGluIG5leHQgbWFqb3IgcmVsZWFzZSkKICogc3BlY2lmeSB3aGVyZSB0aGUgdGVtcGxhdGUgc2hvdWxkIGJlIGluc2VydGVkLiBEZWZhdWx0cyB0byBgZmFsc2VgLgogKgogKiAqIGB0cnVlYCAtIHRoZSB0ZW1wbGF0ZSB3aWxsIHJlcGxhY2UgdGhlIGN1cnJlbnQgZWxlbWVudC4KICogKiBgZmFsc2VgIC0gdGhlIHRlbXBsYXRlIHdpbGwgcmVwbGFjZSB0aGUgY29udGVudHMgb2YgdGhlIGN1cnJlbnQgZWxlbWVudC4KICoKICoKICogIyMjIyBgdHJhbnNjbHVkZWAKICogY29tcGlsZSB0aGUgY29udGVudCBvZiB0aGUgZWxlbWVudCBhbmQgbWFrZSBpdCBhdmFpbGFibGUgdG8gdGhlIGRpcmVjdGl2ZS4KICogVHlwaWNhbGx5IHVzZWQgd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVHJhbnNjbHVkZQogKiBuZ1RyYW5zY2x1ZGV9LiBUaGUgYWR2YW50YWdlIG9mIHRyYW5zY2x1c2lvbiBpcyB0aGF0IHRoZSBsaW5raW5nIGZ1bmN0aW9uIHJlY2VpdmVzIGEKICogdHJhbnNjbHVzaW9uIGZ1bmN0aW9uIHdoaWNoIGlzIHByZS1ib3VuZCB0byB0aGUgY29ycmVjdCBzY29wZS4gSW4gYSB0eXBpY2FsIHNldHVwIHRoZSB3aWRnZXQKICogY3JlYXRlcyBhbiBgaXNvbGF0ZWAgc2NvcGUsIGJ1dCB0aGUgdHJhbnNjbHVzaW9uIGlzIG5vdCBhIGNoaWxkLCBidXQgYSBzaWJsaW5nIG9mIHRoZSBgaXNvbGF0ZWAKICogc2NvcGUuIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgZm9yIHRoZSB3aWRnZXQgdG8gaGF2ZSBwcml2YXRlIHN0YXRlLCBhbmQgdGhlIHRyYW5zY2x1c2lvbiB0bwogKiBiZSBib3VuZCB0byB0aGUgcGFyZW50IChwcmUtYGlzb2xhdGVgKSBzY29wZS4KICoKICogKiBgdHJ1ZWAgLSB0cmFuc2NsdWRlIHRoZSBjb250ZW50IG9mIHRoZSBkaXJlY3RpdmUuCiAqICogYCdlbGVtZW50J2AgLSB0cmFuc2NsdWRlIHRoZSB3aG9sZSBlbGVtZW50IGluY2x1ZGluZyBhbnkgZGlyZWN0aXZlcyBkZWZpbmVkIGF0IGxvd2VyIHByaW9yaXR5LgogKgogKgogKiAjIyMjIGBjb21waWxlYAogKgogKiBgYGBqcwogKiAgIGZ1bmN0aW9uIGNvbXBpbGUodEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSkgeyAuLi4gfQogKiBgYGAKICoKICogVGhlIGNvbXBpbGUgZnVuY3Rpb24gZGVhbHMgd2l0aCB0cmFuc2Zvcm1pbmcgdGhlIHRlbXBsYXRlIERPTS4gU2luY2UgbW9zdCBkaXJlY3RpdmVzIGRvIG5vdCBkbwogKiB0ZW1wbGF0ZSB0cmFuc2Zvcm1hdGlvbiwgaXQgaXMgbm90IHVzZWQgb2Z0ZW4uIFRoZSBjb21waWxlIGZ1bmN0aW9uIHRha2VzIHRoZSBmb2xsb3dpbmcgYXJndW1lbnRzOgogKgogKiAgICogYHRFbGVtZW50YCAtIHRlbXBsYXRlIGVsZW1lbnQgLSBUaGUgZWxlbWVudCB3aGVyZSB0aGUgZGlyZWN0aXZlIGhhcyBiZWVuIGRlY2xhcmVkLiBJdCBpcwogKiAgICAgc2FmZSB0byBkbyB0ZW1wbGF0ZSB0cmFuc2Zvcm1hdGlvbiBvbiB0aGUgZWxlbWVudCBhbmQgY2hpbGQgZWxlbWVudHMgb25seS4KICoKICogICAqIGB0QXR0cnNgIC0gdGVtcGxhdGUgYXR0cmlidXRlcyAtIE5vcm1hbGl6ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzIGRlY2xhcmVkIG9uIHRoaXMgZWxlbWVudCBzaGFyZWQKICogICAgIGJldHdlZW4gYWxsIGRpcmVjdGl2ZSBjb21waWxlIGZ1bmN0aW9ucy4KICoKICogICAqIGB0cmFuc2NsdWRlYCAtICBbKkRFUFJFQ0FURUQqIV0gQSB0cmFuc2NsdWRlIGxpbmtpbmcgZnVuY3Rpb246IGBmdW5jdGlvbihzY29wZSwgY2xvbmVMaW5raW5nRm4pYAogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIFRoZSB0ZW1wbGF0ZSBpbnN0YW5jZSBhbmQgdGhlIGxpbmsgaW5zdGFuY2UgbWF5IGJlIGRpZmZlcmVudCBvYmplY3RzIGlmIHRoZSB0ZW1wbGF0ZSBoYXMKICogYmVlbiBjbG9uZWQuIEZvciB0aGlzIHJlYXNvbiBpdCBpcyAqKm5vdCoqIHNhZmUgdG8gZG8gYW55dGhpbmcgb3RoZXIgdGhhbiBET00gdHJhbnNmb3JtYXRpb25zIHRoYXQKICogYXBwbHkgdG8gYWxsIGNsb25lZCBET00gbm9kZXMgd2l0aGluIHRoZSBjb21waWxlIGZ1bmN0aW9uLiBTcGVjaWZpY2FsbHksIERPTSBsaXN0ZW5lciByZWdpc3RyYXRpb24KICogc2hvdWxkIGJlIGRvbmUgaW4gYSBsaW5raW5nIGZ1bmN0aW9uIHJhdGhlciB0aGFuIGluIGEgY29tcGlsZSBmdW5jdGlvbi4KICogPC9kaXY+CgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIFRoZSBjb21waWxlIGZ1bmN0aW9uIGNhbm5vdCBoYW5kbGUgZGlyZWN0aXZlcyB0aGF0IHJlY3Vyc2l2ZWx5IHVzZSB0aGVtc2VsdmVzIGluIHRoZWlyCiAqIG93biB0ZW1wbGF0ZXMgb3IgY29tcGlsZSBmdW5jdGlvbnMuIENvbXBpbGluZyB0aGVzZSBkaXJlY3RpdmVzIHJlc3VsdHMgaW4gYW4gaW5maW5pdGUgbG9vcCBhbmQgYQogKiBzdGFjayBvdmVyZmxvdyBlcnJvcnMuCiAqCiAqIFRoaXMgY2FuIGJlIGF2b2lkZWQgYnkgbWFudWFsbHkgdXNpbmcgJGNvbXBpbGUgaW4gdGhlIHBvc3RMaW5rIGZ1bmN0aW9uIHRvIGltcGVyYXRpdmVseSBjb21waWxlCiAqIGEgZGlyZWN0aXZlJ3MgdGVtcGxhdGUgaW5zdGVhZCBvZiByZWx5aW5nIG9uIGF1dG9tYXRpYyB0ZW1wbGF0ZSBjb21waWxhdGlvbiB2aWEgYHRlbXBsYXRlYCBvcgogKiBgdGVtcGxhdGVVcmxgIGRlY2xhcmF0aW9uIG9yIG1hbnVhbCBjb21waWxhdGlvbiBpbnNpZGUgdGhlIGNvbXBpbGUgZnVuY3Rpb24uCiAqIDwvZGl2PgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1lcnJvciI+CiAqICoqTm90ZToqKiBUaGUgYHRyYW5zY2x1ZGVgIGZ1bmN0aW9uIHRoYXQgaXMgcGFzc2VkIHRvIHRoZSBjb21waWxlIGZ1bmN0aW9uIGlzIGRlcHJlY2F0ZWQsIGFzIGl0CiAqICAgZS5nLiBkb2VzIG5vdCBrbm93IGFib3V0IHRoZSByaWdodCBvdXRlciBzY29wZS4gUGxlYXNlIHVzZSB0aGUgdHJhbnNjbHVkZSBmdW5jdGlvbiB0aGF0IGlzIHBhc3NlZAogKiAgIHRvIHRoZSBsaW5rIGZ1bmN0aW9uIGluc3RlYWQuCiAqIDwvZGl2PgoKICogQSBjb21waWxlIGZ1bmN0aW9uIGNhbiBoYXZlIGEgcmV0dXJuIHZhbHVlIHdoaWNoIGNhbiBiZSBlaXRoZXIgYSBmdW5jdGlvbiBvciBhbiBvYmplY3QuCiAqCiAqICogcmV0dXJuaW5nIGEgKHBvc3QtbGluaykgZnVuY3Rpb24gLSBpcyBlcXVpdmFsZW50IHRvIHJlZ2lzdGVyaW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHZpYSB0aGUKICogICBgbGlua2AgcHJvcGVydHkgb2YgdGhlIGNvbmZpZyBvYmplY3Qgd2hlbiB0aGUgY29tcGlsZSBmdW5jdGlvbiBpcyBlbXB0eS4KICoKICogKiByZXR1cm5pbmcgYW4gb2JqZWN0IHdpdGggZnVuY3Rpb24ocykgcmVnaXN0ZXJlZCB2aWEgYHByZWAgYW5kIGBwb3N0YCBwcm9wZXJ0aWVzIC0gYWxsb3dzIHlvdSB0bwogKiAgIGNvbnRyb2wgd2hlbiBhIGxpbmtpbmcgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCBkdXJpbmcgdGhlIGxpbmtpbmcgcGhhc2UuIFNlZSBpbmZvIGFib3V0CiAqICAgcHJlLWxpbmtpbmcgYW5kIHBvc3QtbGlua2luZyBmdW5jdGlvbnMgYmVsb3cuCiAqCiAqCiAqICMjIyMgYGxpbmtgCiAqIFRoaXMgcHJvcGVydHkgaXMgdXNlZCBvbmx5IGlmIHRoZSBgY29tcGlsZWAgcHJvcGVydHkgaXMgbm90IGRlZmluZWQuCiAqCiAqIGBgYGpzCiAqICAgZnVuY3Rpb24gbGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlciwgdHJhbnNjbHVkZUZuKSB7IC4uLiB9CiAqIGBgYAogKgogKiBUaGUgbGluayBmdW5jdGlvbiBpcyByZXNwb25zaWJsZSBmb3IgcmVnaXN0ZXJpbmcgRE9NIGxpc3RlbmVycyBhcyB3ZWxsIGFzIHVwZGF0aW5nIHRoZSBET00uIEl0IGlzCiAqIGV4ZWN1dGVkIGFmdGVyIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiBjbG9uZWQuIFRoaXMgaXMgd2hlcmUgbW9zdCBvZiB0aGUgZGlyZWN0aXZlIGxvZ2ljIHdpbGwgYmUKICogcHV0LgogKgogKiAgICogYHNjb3BlYCAtIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIFNjb3BlfSAtIFRoZSBzY29wZSB0byBiZSB1c2VkIGJ5IHRoZQogKiAgICAgZGlyZWN0aXZlIGZvciByZWdpc3RlcmluZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlc30uCiAqCiAqICAgKiBgaUVsZW1lbnRgIC0gaW5zdGFuY2UgZWxlbWVudCAtIFRoZSBlbGVtZW50IHdoZXJlIHRoZSBkaXJlY3RpdmUgaXMgdG8gYmUgdXNlZC4gSXQgaXMgc2FmZSB0bwogKiAgICAgbWFuaXB1bGF0ZSB0aGUgY2hpbGRyZW4gb2YgdGhlIGVsZW1lbnQgb25seSBpbiBgcG9zdExpbmtgIGZ1bmN0aW9uIHNpbmNlIHRoZSBjaGlsZHJlbiBoYXZlCiAqICAgICBhbHJlYWR5IGJlZW4gbGlua2VkLgogKgogKiAgICogYGlBdHRyc2AgLSBpbnN0YW5jZSBhdHRyaWJ1dGVzIC0gTm9ybWFsaXplZCBsaXN0IG9mIGF0dHJpYnV0ZXMgZGVjbGFyZWQgb24gdGhpcyBlbGVtZW50IHNoYXJlZAogKiAgICAgYmV0d2VlbiBhbGwgZGlyZWN0aXZlIGxpbmtpbmcgZnVuY3Rpb25zLgogKgogKiAgICogYGNvbnRyb2xsZXJgIC0gYSBjb250cm9sbGVyIGluc3RhbmNlIC0gQSBjb250cm9sbGVyIGluc3RhbmNlIGlmIGF0IGxlYXN0IG9uZSBkaXJlY3RpdmUgb24gdGhlCiAqICAgICBlbGVtZW50IGRlZmluZXMgYSBjb250cm9sbGVyLiBUaGUgY29udHJvbGxlciBpcyBzaGFyZWQgYW1vbmcgYWxsIHRoZSBkaXJlY3RpdmVzLCB3aGljaCBhbGxvd3MKICogICAgIHRoZSBkaXJlY3RpdmVzIHRvIHVzZSB0aGUgY29udHJvbGxlcnMgYXMgYSBjb21tdW5pY2F0aW9uIGNoYW5uZWwuCiAqCiAqICAgKiBgdHJhbnNjbHVkZUZuYCAtIEEgdHJhbnNjbHVkZSBsaW5raW5nIGZ1bmN0aW9uIHByZS1ib3VuZCB0byB0aGUgY29ycmVjdCB0cmFuc2NsdXNpb24gc2NvcGUuCiAqICAgICBUaGUgc2NvcGUgY2FuIGJlIG92ZXJyaWRkZW4gYnkgYW4gb3B0aW9uYWwgZmlyc3QgYXJndW1lbnQuIFRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGAkdHJhbnNjbHVkZWAKICogICAgIHBhcmFtZXRlciBvZiBkaXJlY3RpdmUgY29udHJvbGxlcnMuCiAqICAgICBgZnVuY3Rpb24oW3Njb3BlXSwgY2xvbmVMaW5raW5nRm4pYC4KICoKICoKICogIyMjIyBQcmUtbGlua2luZyBmdW5jdGlvbgogKgogKiBFeGVjdXRlZCBiZWZvcmUgdGhlIGNoaWxkIGVsZW1lbnRzIGFyZSBsaW5rZWQuIE5vdCBzYWZlIHRvIGRvIERPTSB0cmFuc2Zvcm1hdGlvbiBzaW5jZSB0aGUKICogY29tcGlsZXIgbGlua2luZyBmdW5jdGlvbiB3aWxsIGZhaWwgdG8gbG9jYXRlIHRoZSBjb3JyZWN0IGVsZW1lbnRzIGZvciBsaW5raW5nLgogKgogKiAjIyMjIFBvc3QtbGlua2luZyBmdW5jdGlvbgogKgogKiBFeGVjdXRlZCBhZnRlciB0aGUgY2hpbGQgZWxlbWVudHMgYXJlIGxpbmtlZC4gSXQgaXMgc2FmZSB0byBkbyBET00gdHJhbnNmb3JtYXRpb24gaW4gdGhlIHBvc3QtbGlua2luZyBmdW5jdGlvbi4KICoKICogPGEgbmFtZT0iQXR0cmlidXRlcyI+PC9hPgogKiAjIyMgQXR0cmlidXRlcwogKgogKiBUaGUge0BsaW5rIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIEF0dHJpYnV0ZXN9IG9iamVjdCAtIHBhc3NlZCBhcyBhIHBhcmFtZXRlciBpbiB0aGUKICogYGxpbmsoKWAgb3IgYGNvbXBpbGUoKWAgZnVuY3Rpb25zLiBJdCBoYXMgYSB2YXJpZXR5IG9mIHVzZXMuCiAqCiAqIGFjY2Vzc2luZyAqTm9ybWFsaXplZCBhdHRyaWJ1dGUgbmFtZXM6KgogKiBEaXJlY3RpdmVzIGxpa2UgJ25nQmluZCcgY2FuIGJlIGV4cHJlc3NlZCBpbiBtYW55IHdheXM6ICduZzpiaW5kJywgYGRhdGEtbmctYmluZGAsIG9yICd4LW5nLWJpbmQnLgogKiB0aGUgYXR0cmlidXRlcyBvYmplY3QgYWxsb3dzIGZvciBub3JtYWxpemVkIGFjY2VzcyB0bwogKiAgIHRoZSBhdHRyaWJ1dGVzLgogKgogKiAqICpEaXJlY3RpdmUgaW50ZXItY29tbXVuaWNhdGlvbjoqIEFsbCBkaXJlY3RpdmVzIHNoYXJlIHRoZSBzYW1lIGluc3RhbmNlIG9mIHRoZSBhdHRyaWJ1dGVzCiAqICAgb2JqZWN0IHdoaWNoIGFsbG93cyB0aGUgZGlyZWN0aXZlcyB0byB1c2UgdGhlIGF0dHJpYnV0ZXMgb2JqZWN0IGFzIGludGVyIGRpcmVjdGl2ZQogKiAgIGNvbW11bmljYXRpb24uCiAqCiAqICogKlN1cHBvcnRzIGludGVycG9sYXRpb246KiBJbnRlcnBvbGF0aW9uIGF0dHJpYnV0ZXMgYXJlIGFzc2lnbmVkIHRvIHRoZSBhdHRyaWJ1dGUgb2JqZWN0CiAqICAgYWxsb3dpbmcgb3RoZXIgZGlyZWN0aXZlcyB0byByZWFkIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUuCiAqCiAqICogKk9ic2VydmluZyBpbnRlcnBvbGF0ZWQgYXR0cmlidXRlczoqIFVzZSBgJG9ic2VydmVgIHRvIG9ic2VydmUgdGhlIHZhbHVlIGNoYW5nZXMgb2YgYXR0cmlidXRlcwogKiAgIHRoYXQgY29udGFpbiBpbnRlcnBvbGF0aW9uIChlLmcuIGBzcmM9Int7YmFyfX0iYCkuIE5vdCBvbmx5IGlzIHRoaXMgdmVyeSBlZmZpY2llbnQgYnV0IGl0J3MgYWxzbwogKiAgIHRoZSBvbmx5IHdheSB0byBlYXNpbHkgZ2V0IHRoZSBhY3R1YWwgdmFsdWUgYmVjYXVzZSBkdXJpbmcgdGhlIGxpbmtpbmcgcGhhc2UgdGhlIGludGVycG9sYXRpb24KICogICBoYXNuJ3QgYmVlbiBldmFsdWF0ZWQgeWV0IGFuZCBzbyB0aGUgdmFsdWUgaXMgYXQgdGhpcyB0aW1lIHNldCB0byBgdW5kZWZpbmVkYC4KICoKICogYGBganMKICogZnVuY3Rpb24gbGlua2luZ0ZuKHNjb3BlLCBlbG0sIGF0dHJzLCBjdHJsKSB7CiAqICAgLy8gZ2V0IHRoZSBhdHRyaWJ1dGUgdmFsdWUKICogICBjb25zb2xlLmxvZyhhdHRycy5uZ01vZGVsKTsKICoKICogICAvLyBjaGFuZ2UgdGhlIGF0dHJpYnV0ZQogKiAgIGF0dHJzLiRzZXQoJ25nTW9kZWwnLCAnbmV3IHZhbHVlJyk7CiAqCiAqICAgLy8gb2JzZXJ2ZSBjaGFuZ2VzIHRvIGludGVycG9sYXRlZCBhdHRyaWJ1dGUKICogICBhdHRycy4kb2JzZXJ2ZSgnbmdNb2RlbCcsIGZ1bmN0aW9uKHZhbHVlKSB7CiAqICAgICBjb25zb2xlLmxvZygnbmdNb2RlbCBoYXMgY2hhbmdlZCB2YWx1ZSB0byAnICsgdmFsdWUpOwogKiAgIH0pOwogKiB9CiAqIGBgYAogKgogKiBCZWxvdyBpcyBhbiBleGFtcGxlIHVzaW5nIGAkY29tcGlsZVByb3ZpZGVyYC4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZSoqOiBUeXBpY2FsbHkgZGlyZWN0aXZlcyBhcmUgcmVnaXN0ZXJlZCB3aXRoIGBtb2R1bGUuZGlyZWN0aXZlYC4gVGhlIGV4YW1wbGUgYmVsb3cgaXMKICogdG8gaWxsdXN0cmF0ZSBob3cgYCRjb21waWxlYCB3b3Jrcy4KICogPC9kaXY+CiAqCiA8ZXhhbXBsZSBtb2R1bGU9ImNvbXBpbGUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgIDxzY3JpcHQ+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdjb21waWxlJywgW10sIGZ1bmN0aW9uKCRjb21waWxlUHJvdmlkZXIpIHsKICAgICAgICAvLyBjb25maWd1cmUgbmV3ICdjb21waWxlJyBkaXJlY3RpdmUgYnkgcGFzc2luZyBhIGRpcmVjdGl2ZQogICAgICAgIC8vIGZhY3RvcnkgZnVuY3Rpb24uIFRoZSBmYWN0b3J5IGZ1bmN0aW9uIGluamVjdHMgdGhlICckY29tcGlsZScKICAgICAgICAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgnY29tcGlsZScsIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICAgICAgICAvLyBkaXJlY3RpdmUgZmFjdG9yeSBjcmVhdGVzIGEgbGluayBmdW5jdGlvbgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAgZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgJ2NvbXBpbGUnIGV4cHJlc3Npb24gZm9yIGNoYW5nZXMKICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS4kZXZhbChhdHRycy5jb21waWxlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAvLyBhc3NpZ24gaXQgaW50byB0aGUgY3VycmVudCBET00KICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgbmV3IERPTSBhbmQgbGluayBpdCB0byB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgLy8gc2NvcGUuCiAgICAgICAgICAgICAgICAvLyBOT1RFOiB3ZSBvbmx5IGNvbXBpbGUgLmNoaWxkTm9kZXMgc28gdGhhdAogICAgICAgICAgICAgICAgLy8gd2UgZG9uJ3QgZ2V0IGludG8gaW5maW5pdGUgbG9vcCBjb21waWxpbmcgb3Vyc2VsdmVzCiAgICAgICAgICAgICAgICAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgICB9OwogICAgICAgIH0pCiAgICAgIH0pOwoKICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAkc2NvcGUubmFtZSA9ICdBbmd1bGFyJzsKICAgICAgICAkc2NvcGUuaHRtbCA9ICdIZWxsbyB7e25hbWV9fSc7CiAgICAgIH0KICAgIDwvc2NyaXB0PgogICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgPGlucHV0IG5nLW1vZGVsPSJuYW1lIj4gPGJyPgogICAgICA8dGV4dGFyZWEgbmctbW9kZWw9Imh0bWwiPjwvdGV4dGFyZWE+IDxicj4KICAgICAgPGRpdiBjb21waWxlPSJodG1sIj48L2Rpdj4KICAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgIGl0KCdzaG91bGQgYXV0byBjb21waWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICB2YXIgdGV4dGFyZWEgPSAkKCd0ZXh0YXJlYScpOwogICAgICAgdmFyIG91dHB1dCA9ICQoJ2Rpdltjb21waWxlXScpOwogICAgICAgLy8gVGhlIGluaXRpYWwgc3RhdGUgcmVhZHMgJ0hlbGxvIEFuZ3VsYXInLgogICAgICAgZXhwZWN0KG91dHB1dC5nZXRUZXh0KCkpLnRvQmUoJ0hlbGxvIEFuZ3VsYXInKTsKICAgICAgIHRleHRhcmVhLmNsZWFyKCk7CiAgICAgICB0ZXh0YXJlYS5zZW5kS2V5cygne3tuYW1lfX0hJyk7CiAgICAgICBleHBlY3Qob3V0cHV0LmdldFRleHQoKSkudG9CZSgnQW5ndWxhciEnKTsKICAgICB9KTsKICAgPC9maWxlPgogPC9leGFtcGxlPgoKICoKICoKICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgc3RyaW5nIHRvIGNvbXBpbGUgaW50byBhIHRlbXBsYXRlIGZ1bmN0aW9uLgogKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGUsIGNsb25lQXR0YWNoRm49KX0gdHJhbnNjbHVkZSBmdW5jdGlvbiBhdmFpbGFibGUgdG8gZGlyZWN0aXZlcy4KICogQHBhcmFtIHtudW1iZXJ9IG1heFByaW9yaXR5IG9ubHkgYXBwbHkgZGlyZWN0aXZlcyBsb3dlciB0aGFuIGdpdmVuIHByaW9yaXR5IChPbmx5IGVmZmVjdHMgdGhlCiAqICAgICAgICAgICAgICAgICByb290IGVsZW1lbnQocyksIG5vdCB0aGVpciBjaGlsZHJlbikKICogQHJldHVybnMge2Z1bmN0aW9uKHNjb3BlLCBjbG9uZUF0dGFjaEZuPSl9IGEgbGluayBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGJpbmQgdGVtcGxhdGUKICogKGEgRE9NIGVsZW1lbnQvdHJlZSkgdG8gYSBzY29wZS4gV2hlcmU6CiAqCiAqICAqIGBzY29wZWAgLSBBIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIFNjb3BlfSB0byBiaW5kIHRvLgogKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICogIGB0ZW1wbGF0ZWAgYW5kIGNhbGwgdGhlIGBjbG9uZUF0dGFjaEZuYCBmdW5jdGlvbiBhbGxvd2luZyB0aGUgY2FsbGVyIHRvIGF0dGFjaCB0aGUKICogIGNsb25lZCBlbGVtZW50cyB0byB0aGUgRE9NIGRvY3VtZW50IGF0IHRoZSBhcHByb3ByaWF0ZSBwbGFjZS4gVGhlIGBjbG9uZUF0dGFjaEZuYCBpcwogKiAgY2FsbGVkIGFzOiA8YnI+IGBjbG9uZUF0dGFjaEZuKGNsb25lZEVsZW1lbnQsIHNjb3BlKWAgd2hlcmU6CiAqCiAqICAgICAgKiBgY2xvbmVkRWxlbWVudGAgLSBpcyBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBgZWxlbWVudGAgcGFzc2VkIGludG8gdGhlIGNvbXBpbGVyLgogKiAgICAgICogYHNjb3BlYCAtIGlzIHRoZSBjdXJyZW50IHNjb3BlIHdpdGggd2hpY2ggdGhlIGxpbmtpbmcgZnVuY3Rpb24gaXMgd29ya2luZyB3aXRoLgogKgogKiBDYWxsaW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHJldHVybnMgdGhlIGVsZW1lbnQgb2YgdGhlIHRlbXBsYXRlLiBJdCBpcyBlaXRoZXIgdGhlIG9yaWdpbmFsCiAqIGVsZW1lbnQgcGFzc2VkIGluLCBvciB0aGUgY2xvbmUgb2YgdGhlIGVsZW1lbnQgaWYgdGhlIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZC4KICoKICogQWZ0ZXIgbGlua2luZyB0aGUgdmlldyBpcyBub3QgdXBkYXRlZCB1bnRpbCBhZnRlciBhIGNhbGwgdG8gJGRpZ2VzdCB3aGljaCB0eXBpY2FsbHkgaXMgZG9uZSBieQogKiBBbmd1bGFyIGF1dG9tYXRpY2FsbHkuCiAqCiAqIElmIHlvdSBuZWVkIGFjY2VzcyB0byB0aGUgYm91bmQgdmlldywgdGhlcmUgYXJlIHR3byB3YXlzIHRvIGRvIGl0OgogKgogKiAtIElmIHlvdSBhcmUgbm90IGFza2luZyB0aGUgbGlua2luZyBmdW5jdGlvbiB0byBjbG9uZSB0aGUgdGVtcGxhdGUsIGNyZWF0ZSB0aGUgRE9NIGVsZW1lbnQocykKICogICBiZWZvcmUgeW91IHNlbmQgdGhlbSB0byB0aGUgY29tcGlsZXIgYW5kIGtlZXAgdGhpcyByZWZlcmVuY2UgYXJvdW5kLgogKiAgIGBgYGpzCiAqICAgICB2YXIgZWxlbWVudCA9ICRjb21waWxlKCc8cD57e3RvdGFsfX08L3A+Jykoc2NvcGUpOwogKiAgIGBgYAogKgogKiAtIGlmIG9uIHRoZSBvdGhlciBoYW5kLCB5b3UgbmVlZCB0aGUgZWxlbWVudCB0byBiZSBjbG9uZWQsIHRoZSB2aWV3IHJlZmVyZW5jZSBmcm9tIHRoZSBvcmlnaW5hbAogKiAgIGV4YW1wbGUgd291bGQgbm90IHBvaW50IHRvIHRoZSBjbG9uZSwgYnV0IHJhdGhlciB0byB0aGUgb3JpZ2luYWwgdGVtcGxhdGUgdGhhdCB3YXMgY2xvbmVkLiBJbgogKiAgIHRoaXMgY2FzZSwgeW91IGNhbiBhY2Nlc3MgdGhlIGNsb25lIHZpYSB0aGUgY2xvbmVBdHRhY2hGbjoKICogICBgYGBqcwogKiAgICAgdmFyIHRlbXBsYXRlRWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudCgnPHA+e3t0b3RhbH19PC9wPicpLAogKiAgICAgICAgIHNjb3BlID0gLi4uLjsKICoKICogICAgIHZhciBjbG9uZWRFbGVtZW50ID0gJGNvbXBpbGUodGVtcGxhdGVFbGVtZW50KShzY29wZSwgZnVuY3Rpb24oY2xvbmVkRWxlbWVudCwgc2NvcGUpIHsKICogICAgICAgLy9hdHRhY2ggdGhlIGNsb25lIHRvIERPTSBkb2N1bWVudCBhdCB0aGUgcmlnaHQgcGxhY2UKICogICAgIH0pOwogKgogKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWRFbGVtZW50YAogKiAgIGBgYAogKgogKgogKiBGb3IgaW5mb3JtYXRpb24gb24gaG93IHRoZSBjb21waWxlciB3b3Jrcywgc2VlIHRoZQogKiB7QGxpbmsgZ3VpZGUvY29tcGlsZXIgQW5ndWxhciBIVE1MIENvbXBpbGVyfSBzZWN0aW9uIG9mIHRoZSBEZXZlbG9wZXIgR3VpZGUuCiAqLwoKdmFyICRjb21waWxlTWluRXJyID0gbWluRXJyKCckY29tcGlsZScpOwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKi8KJENvbXBpbGVQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZScsICckJHNhbml0aXplVXJpUHJvdmlkZXInXTsKZnVuY3Rpb24gJENvbXBpbGVQcm92aWRlcigkcHJvdmlkZSwgJCRzYW5pdGl6ZVVyaVByb3ZpZGVyKSB7CiAgdmFyIGhhc0RpcmVjdGl2ZXMgPSB7fSwKICAgICAgU3VmZml4ID0gJ0RpcmVjdGl2ZScsCiAgICAgIENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUCA9IC9eXHMqZGlyZWN0aXZlXDpccyooW1xkXHdfXC1dKylccysoLiopJC8sCiAgICAgIENMQVNTX0RJUkVDVElWRV9SRUdFWFAgPSAvKChbXGRcd19cLV0rKSg/Olw6KFteO10rKSk/Oz8pLzsKCiAgLy8gUmVmOiBodHRwOi8vZGV2ZWxvcGVycy53aGF0d2cub3JnL3dlYmFwcGFwaXMuaHRtbCNldmVudC1oYW5kbGVyLWlkbC1hdHRyaWJ1dGVzCiAgLy8gVGhlIGFzc3VtcHRpb24gaXMgdGhhdCBmdXR1cmUgRE9NIGV2ZW50IGF0dHJpYnV0ZSBuYW1lcyB3aWxsIGJlZ2luIHdpdGgKICAvLyAnb24nIGFuZCBiZSBjb21wb3NlZCBvZiBvbmx5IEVuZ2xpc2ggbGV0dGVycy4KICB2YXIgRVZFTlRfSEFORExFUl9BVFRSX1JFR0VYUCA9IC9eKG9uW2Etel0rfGZvcm1hY3Rpb24pJC87CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlciBhIG5ldyBkaXJlY3RpdmUgd2l0aCB0aGUgY29tcGlsZXIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgTmFtZSBvZiB0aGUgZGlyZWN0aXZlIGluIGNhbWVsLWNhc2UgKGkuZS4gPGNvZGU+bmdCaW5kPC9jb2RlPiB3aGljaAogICAqICAgIHdpbGwgbWF0Y2ggYXMgPGNvZGU+bmctYmluZDwvY29kZT4pLCBvciBhbiBvYmplY3QgbWFwIG9mIGRpcmVjdGl2ZXMgd2hlcmUgdGhlIGtleXMgYXJlIHRoZQogICAqICAgIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgZmFjdG9yaWVzLgogICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGRpcmVjdGl2ZUZhY3RvcnkgQW4gaW5qZWN0YWJsZSBkaXJlY3RpdmUgZmFjdG9yeSBmdW5jdGlvbi4gU2VlCiAgICogICAge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZX0gZm9yIG1vcmUgaW5mby4KICAgKiBAcmV0dXJucyB7bmcuJGNvbXBpbGVQcm92aWRlcn0gU2VsZiBmb3IgY2hhaW5pbmcuCiAgICovCiAgIHRoaXMuZGlyZWN0aXZlID0gZnVuY3Rpb24gcmVnaXN0ZXJEaXJlY3RpdmUobmFtZSwgZGlyZWN0aXZlRmFjdG9yeSkgewogICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ2RpcmVjdGl2ZScpOwogICAgaWYgKGlzU3RyaW5nKG5hbWUpKSB7CiAgICAgIGFzc2VydEFyZyhkaXJlY3RpdmVGYWN0b3J5LCAnZGlyZWN0aXZlRmFjdG9yeScpOwogICAgICBpZiAoIWhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBoYXNEaXJlY3RpdmVzW25hbWVdID0gW107CiAgICAgICAgJHByb3ZpZGUuZmFjdG9yeShuYW1lICsgU3VmZml4LCBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICAgICBmdW5jdGlvbigkaW5qZWN0b3IsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBkaXJlY3RpdmVzID0gW107CiAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24oZGlyZWN0aXZlRmFjdG9yeSwgaW5kZXgpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZSA9ICRpbmplY3Rvci5pbnZva2UoZGlyZWN0aXZlRmFjdG9yeSk7CiAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsgY29tcGlsZTogdmFsdWVGbihkaXJlY3RpdmUpIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFkaXJlY3RpdmUuY29tcGlsZSAmJiBkaXJlY3RpdmUubGluaykgewogICAgICAgICAgICAgICAgICBkaXJlY3RpdmUuY29tcGlsZSA9IHZhbHVlRm4oZGlyZWN0aXZlLmxpbmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlyZWN0aXZlLnByaW9yaXR5ID0gZGlyZWN0aXZlLnByaW9yaXR5IHx8IDA7CiAgICAgICAgICAgICAgICBkaXJlY3RpdmUuaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5uYW1lID0gZGlyZWN0aXZlLm5hbWUgfHwgbmFtZTsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmUgfHwgKGRpcmVjdGl2ZS5jb250cm9sbGVyICYmIGRpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQSc7CiAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgICAgICAgIH1dKTsKICAgICAgfQogICAgICBoYXNEaXJlY3RpdmVzW25hbWVdLnB1c2goZGlyZWN0aXZlRmFjdG9yeSk7CiAgICB9IGVsc2UgewogICAgICBmb3JFYWNoKG5hbWUsIHJldmVyc2VQYXJhbXMocmVnaXN0ZXJEaXJlY3RpdmUpKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNvbXBpbGVQcm92aWRlciNhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICogdXJscyBkdXJpbmcgYVtocmVmXSBzYW5pdGl6YXRpb24uCiAgICoKICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAqCiAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBhW2hyZWZdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8KICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3RgCiAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAqCiAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICovCiAgdGhpcy5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICQkc2FuaXRpemVVcmlQcm92aWRlci5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdChyZWdleHApOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAkJHNhbml0aXplVXJpUHJvdmlkZXIuYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QoKTsKICAgIH0KICB9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIjaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgKiB1cmxzIGR1cmluZyBpbWdbc3JjXSBzYW5pdGl6YXRpb24uCiAgICoKICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAqCiAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBpbWdbc3JjXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICogYW4gYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzLCB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdGAKICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICoKICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgKi8KICB0aGlzLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICQkc2FuaXRpemVVcmlQcm92aWRlci5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QocmVnZXhwKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJCRzYW5pdGl6ZVVyaVByb3ZpZGVyLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCgpOwogICAgfQogIH07CgogIHRoaXMuJGdldCA9IFsKICAgICAgICAgICAgJyRpbmplY3RvcicsICckaW50ZXJwb2xhdGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJHBhcnNlJywKICAgICAgICAgICAgJyRjb250cm9sbGVyJywgJyRyb290U2NvcGUnLCAnJGRvY3VtZW50JywgJyRzY2UnLCAnJGFuaW1hdGUnLCAnJCRzYW5pdGl6ZVVyaScsCiAgICBmdW5jdGlvbigkaW5qZWN0b3IsICAgJGludGVycG9sYXRlLCAgICRleGNlcHRpb25IYW5kbGVyLCAgICRodHRwLCAgICR0ZW1wbGF0ZUNhY2hlLCAgICRwYXJzZSwKICAgICAgICAgICAgICRjb250cm9sbGVyLCAgICRyb290U2NvcGUsICAgJGRvY3VtZW50LCAgICRzY2UsICAgJGFuaW1hdGUsICAgJCRzYW5pdGl6ZVVyaSkgewoKICAgIHZhciBBdHRyaWJ1dGVzID0gZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICB0aGlzLiQkZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgIHRoaXMuJGF0dHIgPSBhdHRyIHx8IHt9OwogICAgfTsKCiAgICBBdHRyaWJ1dGVzLnByb3RvdHlwZSA9IHsKICAgICAgJG5vcm1hbGl6ZTogZGlyZWN0aXZlTm9ybWFsaXplLAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhZGRDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQWRkcyB0aGUgQ1NTIGNsYXNzIHZhbHVlIHNwZWNpZmllZCBieSB0aGUgY2xhc3NWYWwgcGFyYW1ldGVyIHRvIHRoZSBlbGVtZW50LiBJZiBhbmltYXRpb25zCiAgICAgICAqIGFyZSBlbmFibGVkIHRoZW4gYW4gYW5pbWF0aW9uIHdpbGwgYmUgdHJpZ2dlcmVkIGZvciB0aGUgY2xhc3MgYWRkaXRpb24uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc1ZhbCBUaGUgY2xhc3NOYW1lIHZhbHVlIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgKi8KICAgICAgJGFkZENsYXNzIDogZnVuY3Rpb24oY2xhc3NWYWwpIHsKICAgICAgICBpZihjbGFzc1ZhbCAmJiBjbGFzc1ZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcyh0aGlzLiQkZWxlbWVudCwgY2xhc3NWYWwpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRyZW1vdmVDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUmVtb3ZlcyB0aGUgQ1NTIGNsYXNzIHZhbHVlIHNwZWNpZmllZCBieSB0aGUgY2xhc3NWYWwgcGFyYW1ldGVyIGZyb20gdGhlIGVsZW1lbnQuIElmCiAgICAgICAqIGFuaW1hdGlvbnMgYXJlIGVuYWJsZWQgdGhlbiBhbiBhbmltYXRpb24gd2lsbCBiZSB0cmlnZ2VyZWQgZm9yIHRoZSBjbGFzcyByZW1vdmFsLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NWYWwgVGhlIGNsYXNzTmFtZSB2YWx1ZSB0aGF0IHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAqLwogICAgICAkcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihjbGFzc1ZhbCkgewogICAgICAgIGlmKGNsYXNzVmFsICYmIGNsYXNzVmFsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKHRoaXMuJCRlbGVtZW50LCBjbGFzc1ZhbCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJHVwZGF0ZUNsYXNzCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBBZGRzIGFuZCByZW1vdmVzIHRoZSBhcHByb3ByaWF0ZSBDU1MgY2xhc3MgdmFsdWVzIHRvIHRoZSBlbGVtZW50IGJhc2VkIG9uIHRoZSBkaWZmZXJlbmNlCiAgICAgICAqIGJldHdlZW4gdGhlIG5ldyBhbmQgb2xkIENTUyBjbGFzcyB2YWx1ZXMgKHNwZWNpZmllZCBhcyBuZXdDbGFzc2VzIGFuZCBvbGRDbGFzc2VzKS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld0NsYXNzZXMgVGhlIGN1cnJlbnQgQ1NTIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkQ2xhc3NlcyBUaGUgZm9ybWVyIENTUyBjbGFzc05hbWUgdmFsdWUKICAgICAgICovCiAgICAgICR1cGRhdGVDbGFzcyA6IGZ1bmN0aW9uKG5ld0NsYXNzZXMsIG9sZENsYXNzZXMpIHsKICAgICAgICB2YXIgdG9BZGQgPSB0b2tlbkRpZmZlcmVuY2UobmV3Q2xhc3Nlcywgb2xkQ2xhc3Nlcyk7CiAgICAgICAgdmFyIHRvUmVtb3ZlID0gdG9rZW5EaWZmZXJlbmNlKG9sZENsYXNzZXMsIG5ld0NsYXNzZXMpOwoKICAgICAgICBpZih0b0FkZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKHRoaXMuJCRlbGVtZW50LCB0b1JlbW92ZSk7CiAgICAgICAgfSBlbHNlIGlmKHRvUmVtb3ZlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3ModGhpcy4kJGVsZW1lbnQsIHRvQWRkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgJGFuaW1hdGUuc2V0Q2xhc3ModGhpcy4kJGVsZW1lbnQsIHRvQWRkLCB0b1JlbW92ZSk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFNldCBhIG5vcm1hbGl6ZWQgYXR0cmlidXRlIG9uIHRoZSBlbGVtZW50IGluIGEgd2F5IHN1Y2ggdGhhdCBhbGwgZGlyZWN0aXZlcwogICAgICAgKiBjYW4gc2hhcmUgdGhlIGF0dHJpYnV0ZS4gVGhpcyBmdW5jdGlvbiBwcm9wZXJseSBoYW5kbGVzIGJvb2xlYW4gYXR0cmlidXRlcy4KICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKQogICAgICAgKiBAcGFyYW0ge3N0cmluZ3xib29sZWFufSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0LiBJZiBgbnVsbGAgYXR0cmlidXRlIHdpbGwgYmUgZGVsZXRlZC4KICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gd3JpdGVBdHRyIElmIGZhbHNlLCBkb2VzIG5vdCB3cml0ZSB0aGUgdmFsdWUgdG8gRE9NIGVsZW1lbnQgYXR0cmlidXRlLgogICAgICAgKiAgICAgRGVmYXVsdHMgdG8gdHJ1ZS4KICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBhdHRyTmFtZSBPcHRpb25hbCBub25lIG5vcm1hbGl6ZWQgbmFtZS4gRGVmYXVsdHMgdG8ga2V5LgogICAgICAgKi8KICAgICAgJHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgd3JpdGVBdHRyLCBhdHRyTmFtZSkgewogICAgICAgIC8vIFRPRE86IGRlY2lkZSB3aGV0aGVyIG9yIG5vdCB0byB0aHJvdyBhbiBlcnJvciBpZiAiY2xhc3MiCiAgICAgICAgLy9pcyBzZXQgdGhyb3VnaCB0aGlzIGZ1bmN0aW9uIHNpbmNlIGl0IG1heSBjYXVzZSAkdXBkYXRlQ2xhc3MgdG8KICAgICAgICAvL2JlY29tZSB1bnN0YWJsZS4KCiAgICAgICAgdmFyIGJvb2xlYW5LZXkgPSBnZXRCb29sZWFuQXR0ck5hbWUodGhpcy4kJGVsZW1lbnRbMF0sIGtleSksCiAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWwsCiAgICAgICAgICAgIG5vZGVOYW1lOwoKICAgICAgICBpZiAoYm9vbGVhbktleSkgewogICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgIGF0dHJOYW1lID0gYm9vbGVhbktleTsKICAgICAgICB9CgogICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwoKICAgICAgICAvLyB0cmFuc2xhdGUgbm9ybWFsaXplZCBrZXkgdG8gYWN0dWFsIGtleQogICAgICAgIGlmIChhdHRyTmFtZSkgewogICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGF0dHJOYW1lID0gdGhpcy4kYXR0cltrZXldOwogICAgICAgICAgaWYgKCFhdHRyTmFtZSkgewogICAgICAgICAgICB0aGlzLiRhdHRyW2tleV0gPSBhdHRyTmFtZSA9IHNuYWtlX2Nhc2Uoa2V5LCAnLScpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbm9kZU5hbWUgPSBub2RlTmFtZV8odGhpcy4kJGVsZW1lbnQpOwoKICAgICAgICAvLyBzYW5pdGl6ZSBhW2hyZWZdIGFuZCBpbWdbc3JjXSB2YWx1ZXMKICAgICAgICBpZiAoKG5vZGVOYW1lID09PSAnQScgJiYga2V5ID09PSAnaHJlZicpIHx8CiAgICAgICAgICAgIChub2RlTmFtZSA9PT0gJ0lNRycgJiYga2V5ID09PSAnc3JjJykpIHsKICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJCRzYW5pdGl6ZVVyaSh2YWx1ZSwga2V5ID09PSAnc3JjJyk7CiAgICAgICAgfQoKICAgICAgICBpZiAod3JpdGVBdHRyICE9PSBmYWxzZSkgewogICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucmVtb3ZlQXR0cihhdHRyTmFtZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5hdHRyKGF0dHJOYW1lLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBmaXJlIG9ic2VydmVycwogICAgICAgIHZhciAkJG9ic2VydmVycyA9IHRoaXMuJCRvYnNlcnZlcnM7CiAgICAgICAgJCRvYnNlcnZlcnMgJiYgZm9yRWFjaCgkJG9ic2VydmVyc1trZXldLCBmdW5jdGlvbihmbikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm4odmFsdWUpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkb2JzZXJ2ZQogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogT2JzZXJ2ZXMgYW4gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZS4KICAgICAgICoKICAgICAgICogVGhlIG9ic2VydmVyIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCBvbmNlIGR1cmluZyB0aGUgbmV4dCBgJGRpZ2VzdGAgZm9sbG93aW5nCiAgICAgICAqIGNvbXBpbGF0aW9uLiBUaGUgb2JzZXJ2ZXIgaXMgdGhlbiBpbnZva2VkIHdoZW5ldmVyIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUKICAgICAgICogY2hhbmdlcy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKSAuCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oaW50ZXJwb2xhdGVkVmFsdWUpfSBmbiBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW5ldmVyCiAgICAgICAgICAgICAgICB0aGUgaW50ZXJwb2xhdGVkIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgICogICAgICAgIFNlZSB0aGUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSNBdHRyaWJ1dGVzIERpcmVjdGl2ZXN9IGd1aWRlIGZvciBtb3JlIGluZm8uCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSB0aGUgYGZuYCBwYXJhbWV0ZXIuCiAgICAgICAqLwogICAgICAkb2JzZXJ2ZTogZnVuY3Rpb24oa2V5LCBmbikgewogICAgICAgIHZhciBhdHRycyA9IHRoaXMsCiAgICAgICAgICAgICQkb2JzZXJ2ZXJzID0gKGF0dHJzLiQkb2JzZXJ2ZXJzIHx8IChhdHRycy4kJG9ic2VydmVycyA9IHt9KSksCiAgICAgICAgICAgIGxpc3RlbmVycyA9ICgkJG9ic2VydmVyc1trZXldIHx8ICgkJG9ic2VydmVyc1trZXldID0gW10pKTsKCiAgICAgICAgbGlzdGVuZXJzLnB1c2goZm4pOwogICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICghbGlzdGVuZXJzLiQkaW50ZXIpIHsKICAgICAgICAgICAgLy8gbm8gb25lIHJlZ2lzdGVyZWQgYXR0cmlidXRlIGludGVycG9sYXRpb24gZnVuY3Rpb24sIHNvIGxldHMgY2FsbCBpdCBtYW51YWxseQogICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZm47CiAgICAgIH0KICAgIH07CgogICAgdmFyIHN0YXJ0U3ltYm9sID0gJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sKCksCiAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpLAogICAgICAgIGRlbm9ybWFsaXplVGVtcGxhdGUgPSAoc3RhcnRTeW1ib2wgPT0gJ3t7JyB8fCBlbmRTeW1ib2wgID09ICd9fScpCiAgICAgICAgICAgID8gaWRlbnRpdHkKICAgICAgICAgICAgOiBmdW5jdGlvbiBkZW5vcm1hbGl6ZVRlbXBsYXRlKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlLnJlcGxhY2UoL1x7XHsvZywgc3RhcnRTeW1ib2wpLnJlcGxhY2UoL319L2csIGVuZFN5bWJvbCk7CiAgICAgICAgfSwKICAgICAgICBOR19BVFRSX0JJTkRJTkcgPSAvXm5nQXR0cltBLVpdLzsKCgogICAgcmV0dXJuIGNvbXBpbGU7CgogICAgLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKICAgIGZ1bmN0aW9uIGNvbXBpbGUoJGNvbXBpbGVOb2RlcywgdHJhbnNjbHVkZUZuLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0KSB7CiAgICAgIGlmICghKCRjb21waWxlTm9kZXMgaW5zdGFuY2VvZiBqcUxpdGUpKSB7CiAgICAgICAgLy8ganF1ZXJ5IGFsd2F5cyByZXdyYXBzLCB3aGVyZWFzIHdlIG5lZWQgdG8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHNlbGVjdG9yIHNvIHRoYXQgd2UgY2FuCiAgICAgICAgLy8gbW9kaWZ5IGl0LgogICAgICAgICRjb21waWxlTm9kZXMgPSBqcUxpdGUoJGNvbXBpbGVOb2Rlcyk7CiAgICAgIH0KICAgICAgLy8gV2UgY2FuIG5vdCBjb21waWxlIHRvcCBsZXZlbCB0ZXh0IGVsZW1lbnRzIHNpbmNlIHRleHQgbm9kZXMgY2FuIGJlIG1lcmdlZCBhbmQgd2Ugd2lsbAogICAgICAvLyBub3QgYmUgYWJsZSB0byBhdHRhY2ggc2NvcGUgZGF0YSB0byB0aGVtLCBzbyB3ZSB3aWxsIHdyYXAgdGhlbSBpbiA8c3Bhbj4KICAgICAgZm9yRWFjaCgkY29tcGlsZU5vZGVzLCBmdW5jdGlvbihub2RlLCBpbmRleCl7CiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMyAvKiB0ZXh0IG5vZGUgKi8gJiYgbm9kZS5ub2RlVmFsdWUubWF0Y2goL1xTKy8pIC8qIG5vbi1lbXB0eSAqLyApIHsKICAgICAgICAgICRjb21waWxlTm9kZXNbaW5kZXhdID0gbm9kZSA9IGpxTGl0ZShub2RlKS53cmFwKCc8c3Bhbj48L3NwYW4+JykucGFyZW50KClbMF07CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdmFyIGNvbXBvc2l0ZUxpbmtGbiA9CiAgICAgICAgICAgICAgY29tcGlsZU5vZGVzKCRjb21waWxlTm9kZXMsIHRyYW5zY2x1ZGVGbiwgJGNvbXBpbGVOb2RlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwgcHJldmlvdXNDb21waWxlQ29udGV4dCk7CiAgICAgIHNhZmVBZGRDbGFzcygkY29tcGlsZU5vZGVzLCAnbmctc2NvcGUnKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIHB1YmxpY0xpbmtGbihzY29wZSwgY2xvbmVDb25uZWN0Rm4sIHRyYW5zY2x1ZGVDb250cm9sbGVycyl7CiAgICAgICAgYXNzZXJ0QXJnKHNjb3BlLCAnc2NvcGUnKTsKICAgICAgICAvLyBpbXBvcnRhbnQhITogd2UgbXVzdCBjYWxsIG91ciBqcUxpdGUuY2xvbmUoKSBzaW5jZSB0aGUgalF1ZXJ5IG9uZSBpcyB0cnlpbmcgdG8gYmUgc21hcnQKICAgICAgICAvLyBhbmQgc29tZXRpbWVzIGNoYW5nZXMgdGhlIHN0cnVjdHVyZSBvZiB0aGUgRE9NLgogICAgICAgIHZhciAkbGlua05vZGUgPSBjbG9uZUNvbm5lY3RGbgogICAgICAgICAgPyBKUUxpdGVQcm90b3R5cGUuY2xvbmUuY2FsbCgkY29tcGlsZU5vZGVzKSAvLyBJTVBPUlRBTlQhISEKICAgICAgICAgIDogJGNvbXBpbGVOb2RlczsKCiAgICAgICAgZm9yRWFjaCh0cmFuc2NsdWRlQ29udHJvbGxlcnMsIGZ1bmN0aW9uKGluc3RhbmNlLCBuYW1lKSB7CiAgICAgICAgICAkbGlua05vZGUuZGF0YSgnJCcgKyBuYW1lICsgJ0NvbnRyb2xsZXInLCBpbnN0YW5jZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEF0dGFjaCBzY29wZSBvbmx5IHRvIG5vbi10ZXh0IG5vZGVzLgogICAgICAgIGZvcih2YXIgaSA9IDAsIGlpID0gJGxpbmtOb2RlLmxlbmd0aDsgaTxpaTsgaSsrKSB7CiAgICAgICAgICB2YXIgbm9kZSA9ICRsaW5rTm9kZVtpXSwKICAgICAgICAgICAgICBub2RlVHlwZSA9IG5vZGUubm9kZVR5cGU7CiAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDEgLyogZWxlbWVudCAqLyB8fCBub2RlVHlwZSA9PT0gOSAvKiBkb2N1bWVudCAqLykgewogICAgICAgICAgICAkbGlua05vZGUuZXEoaSkuZGF0YSgnJHNjb3BlJywgc2NvcGUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGNsb25lQ29ubmVjdEZuKSBjbG9uZUNvbm5lY3RGbigkbGlua05vZGUsIHNjb3BlKTsKICAgICAgICBpZiAoY29tcG9zaXRlTGlua0ZuKSBjb21wb3NpdGVMaW5rRm4oc2NvcGUsICRsaW5rTm9kZSwgJGxpbmtOb2RlKTsKICAgICAgICByZXR1cm4gJGxpbmtOb2RlOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICAgIHRyeSB7CiAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgLy8gaWdub3JlLCBzaW5jZSBpdCBtZWFucyB0aGF0IHdlIGFyZSB0cnlpbmcgdG8gc2V0IGNsYXNzIG9uCiAgICAgICAgLy8gU1ZHIGVsZW1lbnQsIHdoZXJlIGNsYXNzIG5hbWUgaXMgcmVhZC1vbmx5LgogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDb21waWxlIGZ1bmN0aW9uIG1hdGNoZXMgZWFjaCBub2RlIGluIG5vZGVMaXN0IGFnYWluc3QgdGhlIGRpcmVjdGl2ZXMuIE9uY2UgYWxsIGRpcmVjdGl2ZXMKICAgICAqIGZvciBhIHBhcnRpY3VsYXIgbm9kZSBhcmUgY29sbGVjdGVkIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb25zIGFyZSBleGVjdXRlZC4gVGhlIGNvbXBpbGUKICAgICAqIGZ1bmN0aW9ucyByZXR1cm4gdmFsdWVzIC0gdGhlIGxpbmtpbmcgZnVuY3Rpb25zIC0gYXJlIGNvbWJpbmVkIGludG8gYSBjb21wb3NpdGUgbGlua2luZwogICAgICogZnVuY3Rpb24sIHdoaWNoIGlzIHRoZSBhIGxpbmtpbmcgZnVuY3Rpb24gZm9yIHRoZSBub2RlLgogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZUxpc3R9IG5vZGVMaXN0IGFuIGFycmF5IG9mIG5vZGVzIG9yIE5vZGVMaXN0IHRvIGNvbXBpbGUKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZSwgY2xvbmVBdHRhY2hGbj0pfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAqICAgICAgICBzY29wZSBhcmd1bWVudCBpcyBhdXRvLWdlbmVyYXRlZCB0byB0aGUgbmV3IGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnQ9fSAkcm9vdEVsZW1lbnQgSWYgdGhlIG5vZGVMaXN0IGlzIHRoZSByb290IG9mIHRoZSBjb21waWxhdGlvbiB0cmVlIHRoZW4KICAgICAqICAgICAgICB0aGUgcm9vdEVsZW1lbnQgbXVzdCBiZSBzZXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIG9mIHRoZSBjb21waWxlIHJvb3QuIFRoaXMgaXMKICAgICAqICAgICAgICBuZWVkZWQgc28gdGhhdCB0aGUganFMaXRlIGNvbGxlY3Rpb24gaXRlbXMgY2FuIGJlIHJlcGxhY2VkIHdpdGggd2lkZ2V0cy4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gQSBjb21wb3NpdGUgbGlua2luZyBmdW5jdGlvbiBvZiBhbGwgb2YgdGhlIG1hdGNoZWQgZGlyZWN0aXZlcyBvciBudWxsLgogICAgICovCiAgICBmdW5jdGlvbiBjb21waWxlTm9kZXMobm9kZUxpc3QsIHRyYW5zY2x1ZGVGbiwgJHJvb3RFbGVtZW50LCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCkgewogICAgICB2YXIgbGlua0ZucyA9IFtdLAogICAgICAgICAgYXR0cnMsIGRpcmVjdGl2ZXMsIG5vZGVMaW5rRm4sIGNoaWxkTm9kZXMsIGNoaWxkTGlua0ZuLCBsaW5rRm5Gb3VuZDsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZUxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBhdHRycyA9IG5ldyBBdHRyaWJ1dGVzKCk7CgogICAgICAgIC8vIHdlIG11c3QgYWx3YXlzIHJlZmVyIHRvIG5vZGVMaXN0W2ldIHNpbmNlIHRoZSBub2RlcyBjYW4gYmUgcmVwbGFjZWQgdW5kZXJuZWF0aCB1cy4KICAgICAgICBkaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMobm9kZUxpc3RbaV0sIFtdLCBhdHRycywgaSA9PT0gMCA/IG1heFByaW9yaXR5IDogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWdub3JlRGlyZWN0aXZlKTsKCiAgICAgICAgbm9kZUxpbmtGbiA9IChkaXJlY3RpdmVzLmxlbmd0aCkKICAgICAgICAgICAgPyBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgbm9kZUxpc3RbaV0sIGF0dHJzLCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudWxsLCBbXSwgW10sIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpCiAgICAgICAgICAgIDogbnVsbDsKCiAgICAgICAgaWYgKG5vZGVMaW5rRm4gJiYgbm9kZUxpbmtGbi5zY29wZSkgewogICAgICAgICAgc2FmZUFkZENsYXNzKGpxTGl0ZShub2RlTGlzdFtpXSksICduZy1zY29wZScpOwogICAgICAgIH0KCiAgICAgICAgY2hpbGRMaW5rRm4gPSAobm9kZUxpbmtGbiAmJiBub2RlTGlua0ZuLnRlcm1pbmFsIHx8CiAgICAgICAgICAgICAgICAgICAgICAhKGNoaWxkTm9kZXMgPSBub2RlTGlzdFtpXS5jaGlsZE5vZGVzKSB8fAogICAgICAgICAgICAgICAgICAgICAgIWNoaWxkTm9kZXMubGVuZ3RoKQogICAgICAgICAgICA/IG51bGwKICAgICAgICAgICAgOiBjb21waWxlTm9kZXMoY2hpbGROb2RlcywKICAgICAgICAgICAgICAgICBub2RlTGlua0ZuID8gbm9kZUxpbmtGbi50cmFuc2NsdWRlIDogdHJhbnNjbHVkZUZuKTsKCiAgICAgICAgbGlua0Zucy5wdXNoKG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuKTsKICAgICAgICBsaW5rRm5Gb3VuZCA9IGxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm47CiAgICAgICAgLy91c2UgdGhlIHByZXZpb3VzIGNvbnRleHQgb25seSBmb3IgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIHZpcnR1YWwgZ3JvdXAKICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0ID0gbnVsbDsKICAgICAgfQoKICAgICAgLy8gcmV0dXJuIGEgbGlua2luZyBmdW5jdGlvbiBpZiB3ZSBoYXZlIGZvdW5kIGFueXRoaW5nLCBudWxsIG90aGVyd2lzZQogICAgICByZXR1cm4gbGlua0ZuRm91bmQgPyBjb21wb3NpdGVMaW5rRm4gOiBudWxsOwoKICAgICAgZnVuY3Rpb24gY29tcG9zaXRlTGlua0ZuKHNjb3BlLCBub2RlTGlzdCwgJHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbikgewogICAgICAgIHZhciBub2RlTGlua0ZuLCBjaGlsZExpbmtGbiwgbm9kZSwgJG5vZGUsIGNoaWxkU2NvcGUsIGNoaWxkVHJhbnNjbHVkZUZuLCBpLCBpaSwgbjsKCiAgICAgICAgLy8gY29weSBub2RlTGlzdCBzbyB0aGF0IGxpbmtpbmcgZG9lc24ndCBicmVhayBkdWUgdG8gbGl2ZSBsaXN0IHVwZGF0ZXMuCiAgICAgICAgdmFyIG5vZGVMaXN0TGVuZ3RoID0gbm9kZUxpc3QubGVuZ3RoLAogICAgICAgICAgICBzdGFibGVOb2RlTGlzdCA9IG5ldyBBcnJheShub2RlTGlzdExlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGVMaXN0TGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHN0YWJsZU5vZGVMaXN0W2ldID0gbm9kZUxpc3RbaV07CiAgICAgICAgfQoKICAgICAgICBmb3IoaSA9IDAsIG4gPSAwLCBpaSA9IGxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IG4rKykgewogICAgICAgICAgbm9kZSA9IHN0YWJsZU5vZGVMaXN0W25dOwogICAgICAgICAgbm9kZUxpbmtGbiA9IGxpbmtGbnNbaSsrXTsKICAgICAgICAgIGNoaWxkTGlua0ZuID0gbGlua0Zuc1tpKytdOwogICAgICAgICAgJG5vZGUgPSBqcUxpdGUobm9kZSk7CgogICAgICAgICAgaWYgKG5vZGVMaW5rRm4pIHsKICAgICAgICAgICAgaWYgKG5vZGVMaW5rRm4uc2NvcGUpIHsKICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICRub2RlLmRhdGEoJyRzY29wZScsIGNoaWxkU2NvcGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IG5vZGVMaW5rRm4udHJhbnNjbHVkZTsKICAgICAgICAgICAgaWYgKGNoaWxkVHJhbnNjbHVkZUZuIHx8ICghYm91bmRUcmFuc2NsdWRlRm4gJiYgdHJhbnNjbHVkZUZuKSkgewogICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgIGNyZWF0ZUJvdW5kVHJhbnNjbHVkZUZuKHNjb3BlLCBjaGlsZFRyYW5zY2x1ZGVGbiB8fCB0cmFuc2NsdWRlRm4pCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBub2RlTGlua0ZuKGNoaWxkTGlua0ZuLCBjaGlsZFNjb3BlLCBub2RlLCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZExpbmtGbikgewogICAgICAgICAgICBjaGlsZExpbmtGbihzY29wZSwgbm9kZS5jaGlsZE5vZGVzLCB1bmRlZmluZWQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVCb3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgdHJhbnNjbHVkZUZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBib3VuZFRyYW5zY2x1ZGVGbih0cmFuc2NsdWRlZFNjb3BlLCBjbG9uZUZuLCBjb250cm9sbGVycykgewogICAgICAgIHZhciBzY29wZUNyZWF0ZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKCF0cmFuc2NsdWRlZFNjb3BlKSB7CiAgICAgICAgICB0cmFuc2NsdWRlZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgdHJhbnNjbHVkZWRTY29wZS4kJHRyYW5zY2x1ZGVkID0gdHJ1ZTsKICAgICAgICAgIHNjb3BlQ3JlYXRlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgY2xvbmUgPSB0cmFuc2NsdWRlRm4odHJhbnNjbHVkZWRTY29wZSwgY2xvbmVGbiwgY29udHJvbGxlcnMpOwogICAgICAgIGlmIChzY29wZUNyZWF0ZWQpIHsKICAgICAgICAgIGNsb25lLm9uKCckZGVzdHJveScsIGJpbmQodHJhbnNjbHVkZWRTY29wZSwgdHJhbnNjbHVkZWRTY29wZS4kZGVzdHJveSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBMb29rcyBmb3IgZGlyZWN0aXZlcyBvbiB0aGUgZ2l2ZW4gbm9kZSBhbmQgYWRkcyB0aGVtIHRvIHRoZSBkaXJlY3RpdmUgY29sbGVjdGlvbiB3aGljaCBpcwogICAgICogc29ydGVkLgogICAgICoKICAgICAqIEBwYXJhbSBub2RlIE5vZGUgdG8gc2VhcmNoLgogICAgICogQHBhcmFtIGRpcmVjdGl2ZXMgQW4gYXJyYXkgdG8gd2hpY2ggdGhlIGRpcmVjdGl2ZXMgYXJlIGFkZGVkIHRvLiBUaGlzIGFycmF5IGlzIHNvcnRlZCBiZWZvcmUKICAgICAqICAgICAgICB0aGUgZnVuY3Rpb24gcmV0dXJucy4KICAgICAqIEBwYXJhbSBhdHRycyBUaGUgc2hhcmVkIGF0dHJzIG9iamVjdCB3aGljaCBpcyB1c2VkIHRvIHBvcHVsYXRlIHRoZSBub3JtYWxpemVkIGF0dHJpYnV0ZXMuCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heFByaW9yaXR5IE1heCBkaXJlY3RpdmUgcHJpb3JpdHkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbGxlY3REaXJlY3RpdmVzKG5vZGUsIGRpcmVjdGl2ZXMsIGF0dHJzLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKSB7CiAgICAgIHZhciBub2RlVHlwZSA9IG5vZGUubm9kZVR5cGUsCiAgICAgICAgICBhdHRyc01hcCA9IGF0dHJzLiRhdHRyLAogICAgICAgICAgbWF0Y2gsCiAgICAgICAgICBjbGFzc05hbWU7CgogICAgICBzd2l0Y2gobm9kZVR5cGUpIHsKICAgICAgICBjYXNlIDE6IC8qIEVsZW1lbnQgKi8KICAgICAgICAgIC8vIHVzZSB0aGUgbm9kZSBuYW1lOiA8ZGlyZWN0aXZlPgogICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgZGlyZWN0aXZlTm9ybWFsaXplKG5vZGVOYW1lXyhub2RlKS50b0xvd2VyQ2FzZSgpKSwgJ0UnLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKTsKCiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgdGhlIGF0dHJpYnV0ZXMKICAgICAgICAgIGZvciAodmFyIGF0dHIsIG5hbWUsIG5OYW1lLCBuZ0F0dHJOYW1lLCB2YWx1ZSwgbkF0dHJzID0gbm9kZS5hdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgICAgaiA9IDAsIGpqID0gbkF0dHJzICYmIG5BdHRycy5sZW5ndGg7IGogPCBqajsgaisrKSB7CiAgICAgICAgICAgIHZhciBhdHRyU3RhcnROYW1lID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBhdHRyRW5kTmFtZSA9IGZhbHNlOwoKICAgICAgICAgICAgYXR0ciA9IG5BdHRyc1tqXTsKICAgICAgICAgICAgaWYgKCFtc2llIHx8IG1zaWUgPj0gOCB8fCBhdHRyLnNwZWNpZmllZCkgewogICAgICAgICAgICAgIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgICAgICAgICAgLy8gc3VwcG9ydCBuZ0F0dHIgYXR0cmlidXRlIGJpbmRpbmcKICAgICAgICAgICAgICBuZ0F0dHJOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUpOwogICAgICAgICAgICAgIGlmIChOR19BVFRSX0JJTkRJTkcudGVzdChuZ0F0dHJOYW1lKSkgewogICAgICAgICAgICAgICAgbmFtZSA9IHNuYWtlX2Nhc2UobmdBdHRyTmFtZS5zdWJzdHIoNiksICctJyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlTk5hbWUgPSBuZ0F0dHJOYW1lLnJlcGxhY2UoLyhTdGFydHxFbmQpJC8sICcnKTsKICAgICAgICAgICAgICBpZiAobmdBdHRyTmFtZSA9PT0gZGlyZWN0aXZlTk5hbWUgKyAnU3RhcnQnKSB7CiAgICAgICAgICAgICAgICBhdHRyU3RhcnROYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGF0dHJFbmROYW1lID0gbmFtZS5zdWJzdHIoMCwgbmFtZS5sZW5ndGggLSA1KSArICdlbmQnOwogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDAsIG5hbWUubGVuZ3RoIC0gNik7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgIGF0dHJzTWFwW25OYW1lXSA9IG5hbWU7CiAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdmFsdWUgPSB0cmltKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgIGlmIChnZXRCb29sZWFuQXR0ck5hbWUobm9kZSwgbk5hbWUpKSB7CiAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cnVlOyAvLyBwcmVzZW5jZSBtZWFucyB0cnVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbk5hbWUpOwogICAgICAgICAgICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ0EnLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLCBhdHRyU3RhcnROYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ckVuZE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gdXNlIGNsYXNzIGFzIGRpcmVjdGl2ZQogICAgICAgICAgY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CiAgICAgICAgICBpZiAoaXNTdHJpbmcoY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUgIT09ICcnKSB7CiAgICAgICAgICAgIHdoaWxlIChtYXRjaCA9IENMQVNTX0RJUkVDVElWRV9SRUdFWFAuZXhlYyhjbGFzc05hbWUpKSB7CiAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMl0pOwogICAgICAgICAgICAgIGlmIChhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywgbk5hbWUsICdDJywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRyaW0obWF0Y2hbM10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUuc3Vic3RyKG1hdGNoLmluZGV4ICsgbWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOiAvKiBUZXh0IE5vZGUgKi8KICAgICAgICAgIGFkZFRleHRJbnRlcnBvbGF0ZURpcmVjdGl2ZShkaXJlY3RpdmVzLCBub2RlLm5vZGVWYWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDg6IC8qIENvbW1lbnQgKi8KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG1hdGNoID0gQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQLmV4ZWMobm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShtYXRjaFsxXSk7CiAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ00nLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIHR1cm5zIG91dCB0aGF0IHVuZGVyIHNvbWUgY2lyY3Vtc3RhbmNlcyBJRTkgdGhyb3dzIGVycm9ycyB3aGVuIG9uZSBhdHRlbXB0cyB0byByZWFkCiAgICAgICAgICAgIC8vIGNvbW1lbnQncyBub2RlIHZhbHVlLgogICAgICAgICAgICAvLyBKdXN0IGlnbm9yZSBpdCBhbmQgY29udGludWUuIChDYW4ndCBzZWVtIHRvIHJlcHJvZHVjZSBpbiB0ZXN0IGNhc2UuKQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGRpcmVjdGl2ZXMuc29ydChieVByaW9yaXR5KTsKICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBHaXZlbiBhIG5vZGUgd2l0aCBhbiBkaXJlY3RpdmUtc3RhcnQgaXQgY29sbGVjdHMgYWxsIG9mIHRoZSBzaWJsaW5ncyB1bnRpbCBpdCBmaW5kcwogICAgICogZGlyZWN0aXZlLWVuZC4KICAgICAqIEBwYXJhbSBub2RlCiAgICAgKiBAcGFyYW0gYXR0clN0YXJ0CiAgICAgKiBAcGFyYW0gYXR0ckVuZAogICAgICogQHJldHVybnMgeyp9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGdyb3VwU2Nhbihub2RlLCBhdHRyU3RhcnQsIGF0dHJFbmQpIHsKICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgIGlmIChhdHRyU3RhcnQgJiYgbm9kZS5oYXNBdHRyaWJ1dGUgJiYgbm9kZS5oYXNBdHRyaWJ1dGUoYXR0clN0YXJ0KSkgewogICAgICAgIHZhciBzdGFydE5vZGUgPSBub2RlOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndXRlcmRpcicsCiAgICAgICAgICAgICAgICAgICAgICAiVW50ZXJtaW5hdGVkIGF0dHJpYnV0ZSwgZm91bmQgJ3swfScgYnV0IG5vIG1hdGNoaW5nICd7MX0nIGZvdW5kLiIsCiAgICAgICAgICAgICAgICAgICAgICBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAvKiogRWxlbWVudCAqKi8pIHsKICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIGRlcHRoKys7CiAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyRW5kKSkgZGVwdGgtLTsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CiAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICB9IHdoaWxlIChkZXB0aCA+IDApOwogICAgICB9IGVsc2UgewogICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBqcUxpdGUobm9kZXMpOwogICAgfQoKICAgIC8qKgogICAgICogV3JhcHBlciBmb3IgbGlua2luZyBmdW5jdGlvbiB3aGljaCBjb252ZXJ0cyBub3JtYWwgbGlua2luZyBmdW5jdGlvbiBpbnRvIGEgZ3JvdXBlZAogICAgICogbGlua2luZyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSBsaW5rRm4KICAgICAqIEBwYXJhbSBhdHRyU3RhcnQKICAgICAqIEBwYXJhbSBhdHRyRW5kCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259CiAgICAgKi8KICAgIGZ1bmN0aW9uIGdyb3VwRWxlbWVudHNMaW5rRm5XcmFwcGVyKGxpbmtGbiwgYXR0clN0YXJ0LCBhdHRyRW5kKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzLCB0cmFuc2NsdWRlRm4pIHsKICAgICAgICBlbGVtZW50ID0gZ3JvdXBTY2FuKGVsZW1lbnRbMF0sIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgcmV0dXJuIGxpbmtGbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzLCB0cmFuc2NsdWRlRm4pOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogT25jZSB0aGUgZGlyZWN0aXZlcyBoYXZlIGJlZW4gY29sbGVjdGVkLCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoaXMgbWV0aG9kCiAgICAgKiBpcyByZXNwb25zaWJsZSBmb3IgaW5saW5pbmcgZGlyZWN0aXZlIHRlbXBsYXRlcyBhcyB3ZWxsIGFzIHRlcm1pbmF0aW5nIHRoZSBhcHBsaWNhdGlvbgogICAgICogb2YgdGhlIGRpcmVjdGl2ZXMgaWYgdGhlIHRlcm1pbmFsIGRpcmVjdGl2ZSBoYXMgYmVlbiByZWFjaGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGRpcmVjdGl2ZXMgQXJyYXkgb2YgY29sbGVjdGVkIGRpcmVjdGl2ZXMgdG8gZXhlY3V0ZSB0aGVpciBjb21waWxlIGZ1bmN0aW9uLgogICAgICogICAgICAgIHRoaXMgbmVlZHMgdG8gYmUgcHJlLXNvcnRlZCBieSBwcmlvcml0eSBvcmRlci4KICAgICAqIEBwYXJhbSB7Tm9kZX0gY29tcGlsZU5vZGUgVGhlIHJhdyBET00gbm9kZSB0byBhcHBseSB0aGUgY29tcGlsZSBmdW5jdGlvbnMgdG8KICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0ZW1wbGF0ZUF0dHJzIFRoZSBzaGFyZWQgYXR0cmlidXRlIGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGUsIGNsb25lQXR0YWNoRm49KX0gdHJhbnNjbHVkZUZuIEEgbGlua2luZyBmdW5jdGlvbiwgd2hlcmUgdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgKiBAcGFyYW0ge0pRTGl0ZX0ganFDb2xsZWN0aW9uIElmIHdlIGFyZSB3b3JraW5nIG9uIHRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUgdGhlbiB0aGlzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50IGhhcyB0aGUgcm9vdCBqcUxpdGUgYXJyYXkgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbiBpdC4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gb3JpZ2luYWxSZXBsYWNlRGlyZWN0aXZlIEFuIG9wdGlvbmFsIGRpcmVjdGl2ZSB0aGF0IHdpbGwgYmUgaWdub3JlZCB3aGVuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxpbmcgdGhlIHRyYW5zY2x1c2lvbi4KICAgICAqIEBwYXJhbSB7QXJyYXkuPEZ1bmN0aW9uPn0gcHJlTGlua0ZucwogICAgICogQHBhcmFtIHtBcnJheS48RnVuY3Rpb24+fSBwb3N0TGlua0ZucwogICAgICogQHBhcmFtIHtPYmplY3R9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQgQ29udGV4dCB1c2VkIGZvciBwcmV2aW91cyBjb21waWxhdGlvbiBvZiB0aGUgY3VycmVudAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZQogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBsaW5rRm4KICAgICAqLwogICAgZnVuY3Rpb24gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCB0cmFuc2NsdWRlRm4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFDb2xsZWN0aW9uLCBvcmlnaW5hbFJlcGxhY2VEaXJlY3RpdmUsIHByZUxpbmtGbnMsIHBvc3RMaW5rRm5zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQgfHwge307CgogICAgICB2YXIgdGVybWluYWxQcmlvcml0eSA9IC1OdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUsCiAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQuY29udHJvbGxlckRpcmVjdGl2ZXMsCiAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0Lm5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSwKICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gcHJldmlvdXNDb21waWxlQ29udGV4dC50ZW1wbGF0ZURpcmVjdGl2ZSwKICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0Lm5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICBoYXNUcmFuc2NsdWRlRGlyZWN0aXZlID0gZmFsc2UsCiAgICAgICAgICBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQuaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAkY29tcGlsZU5vZGUgPSB0ZW1wbGF0ZUF0dHJzLiQkZWxlbWVudCA9IGpxTGl0ZShjb21waWxlTm9kZSksCiAgICAgICAgICBkaXJlY3RpdmUsCiAgICAgICAgICBkaXJlY3RpdmVOYW1lLAogICAgICAgICAgJHRlbXBsYXRlLAogICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSA9IG9yaWdpbmFsUmVwbGFjZURpcmVjdGl2ZSwKICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gdHJhbnNjbHVkZUZuLAogICAgICAgICAgbGlua0ZuLAogICAgICAgICAgZGlyZWN0aXZlVmFsdWU7CgogICAgICAvLyBleGVjdXRlcyBhbGwgZGlyZWN0aXZlcyBvbiB0aGUgY3VycmVudCBlbGVtZW50CiAgICAgIGZvcih2YXIgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgZGlyZWN0aXZlID0gZGlyZWN0aXZlc1tpXTsKICAgICAgICB2YXIgYXR0clN0YXJ0ID0gZGlyZWN0aXZlLiQkc3RhcnQ7CiAgICAgICAgdmFyIGF0dHJFbmQgPSBkaXJlY3RpdmUuJCRlbmQ7CgogICAgICAgIC8vIGNvbGxlY3QgbXVsdGlibG9jayBzZWN0aW9ucwogICAgICAgIGlmIChhdHRyU3RhcnQpIHsKICAgICAgICAgICRjb21waWxlTm9kZSA9IGdyb3VwU2Nhbihjb21waWxlTm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICB9CiAgICAgICAgJHRlbXBsYXRlID0gdW5kZWZpbmVkOwoKICAgICAgICBpZiAodGVybWluYWxQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgewogICAgICAgICAgYnJlYWs7IC8vIHByZXZlbnQgZnVydGhlciBwcm9jZXNzaW5nIG9mIGRpcmVjdGl2ZXMKICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS5zY29wZSkgewogICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBuZXdTY29wZURpcmVjdGl2ZSB8fCBkaXJlY3RpdmU7CgogICAgICAgICAgLy8gc2tpcCB0aGUgY2hlY2sgZm9yIGRpcmVjdGl2ZXMgd2l0aCBhc3luYyB0ZW1wbGF0ZXMsIHdlJ2xsIGNoZWNrIHRoZSBkZXJpdmVkIHN5bmMKICAgICAgICAgIC8vIGRpcmVjdGl2ZSB3aGVuIHRoZSB0ZW1wbGF0ZSBhcnJpdmVzCiAgICAgICAgICBpZiAoIWRpcmVjdGl2ZS50ZW1wbGF0ZVVybCkgewogICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgnbmV3L2lzb2xhdGVkIHNjb3BlJywgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLCBkaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgIGlmIChpc09iamVjdChkaXJlY3RpdmVWYWx1ZSkpIHsKICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmUubmFtZTsKCiAgICAgICAgaWYgKCFkaXJlY3RpdmUudGVtcGxhdGVVcmwgJiYgZGlyZWN0aXZlLmNvbnRyb2xsZXIpIHsKICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLmNvbnRyb2xsZXI7CiAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IGNvbnRyb2xsZXJEaXJlY3RpdmVzIHx8IHt9OwogICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoIiciICsgZGlyZWN0aXZlTmFtZSArICInIGNvbnRyb2xsZXIiLAogICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IGRpcmVjdGl2ZTsKICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS50cmFuc2NsdWRlKSB7CiAgICAgICAgICBoYXNUcmFuc2NsdWRlRGlyZWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAvLyBTcGVjaWFsIGNhc2UgbmdJZiBhbmQgbmdSZXBlYXQgc28gdGhhdCB3ZSBkb24ndCBjb21wbGFpbiBhYm91dCBkdXBsaWNhdGUgdHJhbnNjbHVzaW9uLgogICAgICAgICAgLy8gVGhpcyBvcHRpb24gc2hvdWxkIG9ubHkgYmUgdXNlZCBieSBkaXJlY3RpdmVzIHRoYXQga25vdyBob3cgdG8gc2FmZWx5IGhhbmRsZSBlbGVtZW50IHRyYW5zY2x1c2lvbiwKICAgICAgICAgIC8vIHdoZXJlIHRoZSB0cmFuc2NsdWRlZCBub2RlcyBhcmUgYWRkZWQgb3IgcmVwbGFjZWQgYWZ0ZXIgbGlua2luZy4KICAgICAgICAgIGlmICghZGlyZWN0aXZlLiQkdGxiKSB7CiAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0cmFuc2NsdXNpb24nLCBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID09ICdlbGVtZW50JykgewogICAgICAgICAgICBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIHRlcm1pbmFsUHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHk7CiAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGdyb3VwU2Nhbihjb21waWxlTm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPQogICAgICAgICAgICAgICAganFMaXRlKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyAnICsgZGlyZWN0aXZlTmFtZSArICc6ICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVBdHRyc1tkaXJlY3RpdmVOYW1lXSArICcgJykpOwogICAgICAgICAgICBjb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXTsKICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCBqcUxpdGUoc2xpY2VBcmdzKCR0ZW1wbGF0ZSkpLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IGNvbXBpbGUoJHRlbXBsYXRlLCB0cmFuc2NsdWRlRm4sIHRlcm1pbmFsUHJpb3JpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlICYmIHJlcGxhY2VEaXJlY3RpdmUubmFtZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBwYXNzIGluOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIGNvbnRyb2xsZXJEaXJlY3RpdmVzIC0gb3RoZXJ3aXNlIHdlJ2xsIGNyZWF0ZSBkdXBsaWNhdGVzIGNvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlIG9yIHRlbXBsYXRlRGlyZWN0aXZlIC0gY29tYmluaW5nIHRlbXBsYXRlcyB3aXRoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgZWxlbWVudCB0cmFuc2NsdXNpb24gZG9lc24ndCBtYWtlIHNlbnNlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIG9ubHkgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSBzbyB0aGF0IHdlIHByZXZlbnQgcHV0dGluZyB0cmFuc2NsdXNpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb24gdGhlIHNhbWUgZWxlbWVudCBtb3JlIHRoYW4gb25jZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZTogbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoanFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpKS5jb250ZW50cygpOwogICAgICAgICAgICAkY29tcGlsZU5vZGUuZW1wdHkoKTsgLy8gY2xlYXIgY29udGVudHMKICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGUpIHsKICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKCiAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IChpc0Z1bmN0aW9uKGRpcmVjdGl2ZS50ZW1wbGF0ZSkpCiAgICAgICAgICAgICAgPyBkaXJlY3RpdmUudGVtcGxhdGUoJGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzKQogICAgICAgICAgICAgIDogZGlyZWN0aXZlLnRlbXBsYXRlOwoKICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gZGVub3JtYWxpemVUZW1wbGF0ZShkaXJlY3RpdmVWYWx1ZSk7CgogICAgICAgICAgaWYgKGRpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgIGlmIChqcUxpdGVJc1RleHROb2RlKGRpcmVjdGl2ZVZhbHVlKSkgewogICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IFtdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZSh0cmltKGRpcmVjdGl2ZVZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbHJ0JywKICAgICAgICAgICAgICAgICAgIlRlbXBsYXRlIGZvciBkaXJlY3RpdmUgJ3swfScgbXVzdCBoYXZlIGV4YWN0bHkgb25lIHJvb3QgZWxlbWVudC4gezF9IiwKICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSwgJycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sICRjb21waWxlTm9kZSwgY29tcGlsZU5vZGUpOwoKICAgICAgICAgICAgdmFyIG5ld1RlbXBsYXRlQXR0cnMgPSB7JGF0dHI6IHt9fTsKCiAgICAgICAgICAgIC8vIGNvbWJpbmUgZGlyZWN0aXZlcyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIGFuZCBmcm9tIHRoZSB0ZW1wbGF0ZToKICAgICAgICAgICAgLy8gLSB0YWtlIHRoZSBhcnJheSBvZiBkaXJlY3RpdmVzIGZvciB0aGlzIGVsZW1lbnQKICAgICAgICAgICAgLy8gLSBzcGxpdCBpdCBpbnRvIHR3byBwYXJ0cywgdGhvc2UgdGhhdCBhbHJlYWR5IGFwcGxpZWQgKHByb2Nlc3NlZCkgYW5kIHRob3NlIHRoYXQgd2VyZW4ndCAodW5wcm9jZXNzZWQpCiAgICAgICAgICAgIC8vIC0gY29sbGVjdCBkaXJlY3RpdmVzIGZyb20gdGhlIHRlbXBsYXRlIGFuZCBzb3J0IHRoZW0gYnkgcHJpb3JpdHkKICAgICAgICAgICAgLy8gLSBjb21iaW5lIGRpcmVjdGl2ZXMgYXM6IHByb2Nlc3NlZCArIHRlbXBsYXRlICsgdW5wcm9jZXNzZWQKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKGNvbXBpbGVOb2RlLCBbXSwgbmV3VGVtcGxhdGVBdHRycyk7CiAgICAgICAgICAgIHZhciB1bnByb2Nlc3NlZERpcmVjdGl2ZXMgPSBkaXJlY3RpdmVzLnNwbGljZShpICsgMSwgZGlyZWN0aXZlcy5sZW5ndGggLSAoaSArIDEpKTsKCiAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICBtYXJrRGlyZWN0aXZlc0FzSXNvbGF0ZSh0ZW1wbGF0ZURpcmVjdGl2ZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpcmVjdGl2ZXMgPSBkaXJlY3RpdmVzLmNvbmNhdCh0ZW1wbGF0ZURpcmVjdGl2ZXMpLmNvbmNhdCh1bnByb2Nlc3NlZERpcmVjdGl2ZXMpOwogICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0ZW1wbGF0ZUF0dHJzLCBuZXdUZW1wbGF0ZUF0dHJzKTsKCiAgICAgICAgICAgIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChkaXJlY3RpdmVWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZGlyZWN0aXZlLnRlbXBsYXRlVXJsKSB7CiAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CgogICAgICAgICAgaWYgKGRpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICB9CgogICAgICAgICAgbm9kZUxpbmtGbiA9IGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLnNwbGljZShpLCBkaXJlY3RpdmVzLmxlbmd0aCAtIGkpLCAkY29tcGlsZU5vZGUsCiAgICAgICAgICAgICAgdGVtcGxhdGVBdHRycywganFDb2xsZWN0aW9uLCBjaGlsZFRyYW5zY2x1ZGVGbiwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsIHsKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzOiBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZTogbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmU6IHRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZTogbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKGRpcmVjdGl2ZS5jb21waWxlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsaW5rRm4gPSBkaXJlY3RpdmUuY29tcGlsZSgkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24obGlua0ZuKSkgewogICAgICAgICAgICAgIGFkZExpbmtGbnMobnVsbCwgbGlua0ZuLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxpbmtGbikgewogICAgICAgICAgICAgIGFkZExpbmtGbnMobGlua0ZuLnByZSwgbGlua0ZuLnBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGNvbXBpbGVOb2RlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZGlyZWN0aXZlLnRlcm1pbmFsKSB7CiAgICAgICAgICBub2RlTGlua0ZuLnRlcm1pbmFsID0gdHJ1ZTsKICAgICAgICAgIHRlcm1pbmFsUHJpb3JpdHkgPSBNYXRoLm1heCh0ZXJtaW5hbFByaW9yaXR5LCBkaXJlY3RpdmUucHJpb3JpdHkpOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIG5vZGVMaW5rRm4uc2NvcGUgPSBuZXdTY29wZURpcmVjdGl2ZSAmJiBuZXdTY29wZURpcmVjdGl2ZS5zY29wZSA9PT0gdHJ1ZTsKICAgICAgbm9kZUxpbmtGbi50cmFuc2NsdWRlID0gaGFzVHJhbnNjbHVkZURpcmVjdGl2ZSAmJiBjaGlsZFRyYW5zY2x1ZGVGbjsKICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dC5oYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlOwoKICAgICAgLy8gbWlnaHQgYmUgbm9ybWFsIG9yIGRlbGF5ZWQgbm9kZUxpbmtGbiBkZXBlbmRpbmcgb24gaWYgdGVtcGxhdGVVcmwgaXMgcHJlc2VudAogICAgICByZXR1cm4gbm9kZUxpbmtGbjsKCiAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICBmdW5jdGlvbiBhZGRMaW5rRm5zKHByZSwgcG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKSB7CiAgICAgICAgaWYgKHByZSkgewogICAgICAgICAgaWYgKGF0dHJTdGFydCkgcHJlID0gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIocHJlLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgcHJlLnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZTsKICAgICAgICAgIHByZS5kaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTmFtZTsKICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPT09IGRpcmVjdGl2ZSB8fCBkaXJlY3RpdmUuJCRpc29sYXRlU2NvcGUpIHsKICAgICAgICAgICAgcHJlID0gY2xvbmVBbmRBbm5vdGF0ZUZuKHByZSwge2lzb2xhdGVTY29wZTogdHJ1ZX0pOwogICAgICAgICAgfQogICAgICAgICAgcHJlTGlua0Zucy5wdXNoKHByZSk7CiAgICAgICAgfQogICAgICAgIGlmIChwb3N0KSB7CiAgICAgICAgICBpZiAoYXR0clN0YXJ0KSBwb3N0ID0gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIocG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgIHBvc3QucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgcG9zdC5kaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTmFtZTsKICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPT09IGRpcmVjdGl2ZSB8fCBkaXJlY3RpdmUuJCRpc29sYXRlU2NvcGUpIHsKICAgICAgICAgICAgcG9zdCA9IGNsb25lQW5kQW5ub3RhdGVGbihwb3N0LCB7aXNvbGF0ZVNjb3BlOiB0cnVlfSk7CiAgICAgICAgICB9CiAgICAgICAgICBwb3N0TGlua0Zucy5wdXNoKHBvc3QpOwogICAgICAgIH0KICAgICAgfQoKCiAgICAgIGZ1bmN0aW9uIGdldENvbnRyb2xsZXJzKGRpcmVjdGl2ZU5hbWUsIHJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpIHsKICAgICAgICB2YXIgdmFsdWUsIHJldHJpZXZhbE1ldGhvZCA9ICdkYXRhJywgb3B0aW9uYWwgPSBmYWxzZTsKICAgICAgICBpZiAoaXNTdHJpbmcocmVxdWlyZSkpIHsKICAgICAgICAgIHdoaWxlKCh2YWx1ZSA9IHJlcXVpcmUuY2hhckF0KDApKSA9PSAnXicgfHwgdmFsdWUgPT0gJz8nKSB7CiAgICAgICAgICAgIHJlcXVpcmUgPSByZXF1aXJlLnN1YnN0cigxKTsKICAgICAgICAgICAgaWYgKHZhbHVlID09ICdeJykgewogICAgICAgICAgICAgIHJldHJpZXZhbE1ldGhvZCA9ICdpbmhlcml0ZWREYXRhJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcHRpb25hbCA9IG9wdGlvbmFsIHx8IHZhbHVlID09ICc/JzsKICAgICAgICAgIH0KICAgICAgICAgIHZhbHVlID0gbnVsbDsKCiAgICAgICAgICBpZiAoZWxlbWVudENvbnRyb2xsZXJzICYmIHJldHJpZXZhbE1ldGhvZCA9PT0gJ2RhdGEnKSB7CiAgICAgICAgICAgIHZhbHVlID0gZWxlbWVudENvbnRyb2xsZXJzW3JlcXVpcmVdOwogICAgICAgICAgfQogICAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAkZWxlbWVudFtyZXRyaWV2YWxNZXRob2RdKCckJyArIHJlcXVpcmUgKyAnQ29udHJvbGxlcicpOwoKICAgICAgICAgIGlmICghdmFsdWUgJiYgIW9wdGlvbmFsKSB7CiAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdjdHJlcScsCiAgICAgICAgICAgICAgICAiQ29udHJvbGxlciAnezB9JywgcmVxdWlyZWQgYnkgZGlyZWN0aXZlICd7MX0nLCBjYW4ndCBiZSBmb3VuZCEiLAogICAgICAgICAgICAgICAgcmVxdWlyZSwgZGlyZWN0aXZlTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHJlcXVpcmUpKSB7CiAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgZm9yRWFjaChyZXF1aXJlLCBmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAgICAgICAgIHZhbHVlLnB1c2goZ2V0Q29udHJvbGxlcnMoZGlyZWN0aXZlTmFtZSwgcmVxdWlyZSwgJGVsZW1lbnQsIGVsZW1lbnRDb250cm9sbGVycykpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQoKCiAgICAgIGZ1bmN0aW9uIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbikgewogICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXIsIGlzb2xhdGVTY29wZSwgZWxlbWVudENvbnRyb2xsZXJzID0ge30sIHRyYW5zY2x1ZGVGbjsKCiAgICAgICAgaWYgKGNvbXBpbGVOb2RlID09PSBsaW5rTm9kZSkgewogICAgICAgICAgYXR0cnMgPSB0ZW1wbGF0ZUF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhdHRycyA9IHNoYWxsb3dDb3B5KHRlbXBsYXRlQXR0cnMsIG5ldyBBdHRyaWJ1dGVzKGpxTGl0ZShsaW5rTm9kZSksIHRlbXBsYXRlQXR0cnMuJGF0dHIpKTsKICAgICAgICB9CiAgICAgICAgJGVsZW1lbnQgPSBhdHRycy4kJGVsZW1lbnQ7CgogICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSkoXD8/KVxzKihcdyopXHMqJC87CiAgICAgICAgICB2YXIgJGxpbmtOb2RlID0ganFMaXRlKGxpbmtOb2RlKTsKCiAgICAgICAgICBpc29sYXRlU2NvcGUgPSBzY29wZS4kbmV3KHRydWUpOwoKICAgICAgICAgIGlmICh0ZW1wbGF0ZURpcmVjdGl2ZSAmJiAodGVtcGxhdGVEaXJlY3RpdmUgPT09IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSB8fAogICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID09PSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuJCRvcmlnaW5hbERpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgJGxpbmtOb2RlLmRhdGEoJyRpc29sYXRlU2NvcGUnLCBpc29sYXRlU2NvcGUpIDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRsaW5rTm9kZS5kYXRhKCckaXNvbGF0ZVNjb3BlTm9UZW1wbGF0ZScsIGlzb2xhdGVTY29wZSk7CiAgICAgICAgICB9CgoKCiAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGxpbmtOb2RlLCAnbmctaXNvbGF0ZS1zY29wZScpOwoKICAgICAgICAgIGZvckVhY2gobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLnNjb3BlLCBmdW5jdGlvbihkZWZpbml0aW9uLCBzY29wZU5hbWUpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gZGVmaW5pdGlvbi5tYXRjaChMT0NBTF9SRUdFWFApIHx8IFtdLAogICAgICAgICAgICAgICAgYXR0ck5hbWUgPSBtYXRjaFszXSB8fCBzY29wZU5hbWUsCiAgICAgICAgICAgICAgICBvcHRpb25hbCA9IChtYXRjaFsyXSA9PSAnPycpLAogICAgICAgICAgICAgICAgbW9kZSA9IG1hdGNoWzFdLCAvLyBALCA9LCBvciAmCiAgICAgICAgICAgICAgICBsYXN0VmFsdWUsCiAgICAgICAgICAgICAgICBwYXJlbnRHZXQsIHBhcmVudFNldCwgY29tcGFyZTsKCiAgICAgICAgICAgIGlzb2xhdGVTY29wZS4kJGlzb2xhdGVCaW5kaW5nc1tzY29wZU5hbWVdID0gbW9kZSArIGF0dHJOYW1lOwoKICAgICAgICAgICAgc3dpdGNoIChtb2RlKSB7CgogICAgICAgICAgICAgIGNhc2UgJ0AnOgogICAgICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoYXR0ck5hbWUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgICBpZiggYXR0cnNbYXR0ck5hbWVdICkgewogICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYXR0cmlidXRlIGhhcyBiZWVuIHByb3ZpZGVkIHRoZW4gd2UgdHJpZ2dlciBhbiBpbnRlcnBvbGF0aW9uIHRvIGVuc3VyZQogICAgICAgICAgICAgICAgICAvLyB0aGUgdmFsdWUgaXMgdGhlcmUgZm9yIHVzZSBpbiB0aGUgbGluayBmbgogICAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSA9ICRpbnRlcnBvbGF0ZShhdHRyc1thdHRyTmFtZV0pKHNjb3BlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlICc9JzoKICAgICAgICAgICAgICAgIGlmIChvcHRpb25hbCAmJiAhYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgaWYgKHBhcmVudEdldC5saXRlcmFsKSB7CiAgICAgICAgICAgICAgICAgIGNvbXBhcmUgPSBlcXVhbHM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21wYXJlID0gZnVuY3Rpb24oYSxiKSB7IHJldHVybiBhID09PSBiOyB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgdGhlIGNoYW5nZSwgb3Igd2Ugd2lsbCB0aHJvdyB0aGlzIGV4Y2VwdGlvbiBvbiBldmVyeSAkZGlnZXN0CiAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHNjb3BlKTsKICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ25vbmFzc2lnbicsCiAgICAgICAgICAgICAgICAgICAgICAiRXhwcmVzc2lvbiAnezB9JyB1c2VkIHdpdGggZGlyZWN0aXZlICd7MX0nIGlzIG5vbi1hc3NpZ25hYmxlISIsCiAgICAgICAgICAgICAgICAgICAgICBhdHRyc1thdHRyTmFtZV0sIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChzY29wZSk7CiAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHBhcmVudFZhbHVlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IHBhcmVudEdldChzY29wZSk7CiAgICAgICAgICAgICAgICAgIGlmICghY29tcGFyZShwYXJlbnRWYWx1ZSwgaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0pKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIG91dCBvZiBzeW5jIGFuZCBuZWVkIHRvIGNvcHkKICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbXBhcmUocGFyZW50VmFsdWUsIGxhc3RWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcmVudCBjaGFuZ2VkIGFuZCBpdCBoYXMgcHJlY2VkZW5jZQogICAgICAgICAgICAgICAgICAgICAgaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHBhcmVudCBjYW4gYmUgYXNzaWduZWQgdGhlbiBkbyBzbwogICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0KHNjb3BlLCBwYXJlbnRWYWx1ZSA9IGlzb2xhdGVTY29wZVtzY29wZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGxhc3RWYWx1ZSA9IHBhcmVudFZhbHVlOwogICAgICAgICAgICAgICAgfSwgbnVsbCwgcGFyZW50R2V0LmxpdGVyYWwpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgJyYnOgogICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSA9IGZ1bmN0aW9uKGxvY2FscykgewogICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ2lzY3AnLAogICAgICAgICAgICAgICAgICAgICJJbnZhbGlkIGlzb2xhdGUgc2NvcGUgZGVmaW5pdGlvbiBmb3IgZGlyZWN0aXZlICd7MH0nLiIgKwogICAgICAgICAgICAgICAgICAgICIgRGVmaW5pdGlvbjogey4uLiB7MX06ICd7Mn0nIC4uLn0iLAogICAgICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5uYW1lLCBzY29wZU5hbWUsIGRlZmluaXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdHJhbnNjbHVkZUZuID0gYm91bmRUcmFuc2NsdWRlRm4gJiYgY29udHJvbGxlcnNCb3VuZFRyYW5zY2x1ZGU7CiAgICAgICAgaWYgKGNvbnRyb2xsZXJEaXJlY3RpdmVzKSB7CiAgICAgICAgICBmb3JFYWNoKGNvbnRyb2xsZXJEaXJlY3RpdmVzLCBmdW5jdGlvbihkaXJlY3RpdmUpIHsKICAgICAgICAgICAgdmFyIGxvY2FscyA9IHsKICAgICAgICAgICAgICAkc2NvcGU6IGRpcmVjdGl2ZSA9PT0gbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlIHx8IGRpcmVjdGl2ZS4kJGlzb2xhdGVTY29wZSA/IGlzb2xhdGVTY29wZSA6IHNjb3BlLAogICAgICAgICAgICAgICRlbGVtZW50OiAkZWxlbWVudCwKICAgICAgICAgICAgICAkYXR0cnM6IGF0dHJzLAogICAgICAgICAgICAgICR0cmFuc2NsdWRlOiB0cmFuc2NsdWRlRm4KICAgICAgICAgICAgfSwgY29udHJvbGxlckluc3RhbmNlOwoKICAgICAgICAgICAgY29udHJvbGxlciA9IGRpcmVjdGl2ZS5jb250cm9sbGVyOwogICAgICAgICAgICBpZiAoY29udHJvbGxlciA9PSAnQCcpIHsKICAgICAgICAgICAgICBjb250cm9sbGVyID0gYXR0cnNbZGlyZWN0aXZlLm5hbWVdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250cm9sbGVySW5zdGFuY2UgPSAkY29udHJvbGxlcihjb250cm9sbGVyLCBsb2NhbHMpOwogICAgICAgICAgICAvLyBGb3IgZGlyZWN0aXZlcyB3aXRoIGVsZW1lbnQgdHJhbnNjbHVzaW9uIHRoZSBlbGVtZW50IGlzIGEgY29tbWVudCwKICAgICAgICAgICAgLy8gYnV0IGpRdWVyeSAuZGF0YSBkb2Vzbid0IHN1cHBvcnQgYXR0YWNoaW5nIGRhdGEgdG8gY29tbWVudCBub2RlcyBhcyBpdCdzIGhhcmQgdG8KICAgICAgICAgICAgLy8gY2xlYW4gdXAgKGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgzMzUpLgogICAgICAgICAgICAvLyBJbnN0ZWFkLCB3ZSBzYXZlIHRoZSBjb250cm9sbGVycyBmb3IgdGhlIGVsZW1lbnQgaW4gYSBsb2NhbCBoYXNoIGFuZCBhdHRhY2ggdG8gLmRhdGEKICAgICAgICAgICAgLy8gbGF0ZXIsIG9uY2Ugd2UgaGF2ZSB0aGUgYWN0dWFsIGVsZW1lbnQuCiAgICAgICAgICAgIGVsZW1lbnRDb250cm9sbGVyc1tkaXJlY3RpdmUubmFtZV0gPSBjb250cm9sbGVySW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAkZWxlbWVudC5kYXRhKCckJyArIGRpcmVjdGl2ZS5uYW1lICsgJ0NvbnRyb2xsZXInLCBjb250cm9sbGVySW5zdGFuY2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlyZWN0aXZlLmNvbnRyb2xsZXJBcykgewogICAgICAgICAgICAgIGxvY2Fscy4kc2NvcGVbZGlyZWN0aXZlLmNvbnRyb2xsZXJBc10gPSBjb250cm9sbGVySW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gUFJFTElOS0lORwogICAgICAgIGZvcihpID0gMCwgaWkgPSBwcmVMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxpbmtGbiA9IHByZUxpbmtGbnNbaV07CiAgICAgICAgICAgIGxpbmtGbihsaW5rRm4uaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgIGxpbmtGbi5yZXF1aXJlICYmIGdldENvbnRyb2xsZXJzKGxpbmtGbi5kaXJlY3RpdmVOYW1lLCBsaW5rRm4ucmVxdWlyZSwgJGVsZW1lbnQsIGVsZW1lbnRDb250cm9sbGVycyksIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBSRUNVUlNJT04KICAgICAgICAvLyBXZSBvbmx5IHBhc3MgdGhlIGlzb2xhdGUgc2NvcGUsIGlmIHRoZSBpc29sYXRlIGRpcmVjdGl2ZSBoYXMgYSB0ZW1wbGF0ZSwKICAgICAgICAvLyBvdGhlcndpc2UgdGhlIGNoaWxkIGVsZW1lbnRzIGRvIG5vdCBiZWxvbmcgdG8gdGhlIGlzb2xhdGUgZGlyZWN0aXZlLgogICAgICAgIHZhciBzY29wZVRvQ2hpbGQgPSBzY29wZTsKICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlICYmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUudGVtcGxhdGUgfHwgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLnRlbXBsYXRlVXJsID09PSBudWxsKSkgewogICAgICAgICAgc2NvcGVUb0NoaWxkID0gaXNvbGF0ZVNjb3BlOwogICAgICAgIH0KICAgICAgICBjaGlsZExpbmtGbiAmJiBjaGlsZExpbmtGbihzY29wZVRvQ2hpbGQsIGxpbmtOb2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwoKICAgICAgICAvLyBQT1NUTElOS0lORwogICAgICAgIGZvcihpID0gcG9zdExpbmtGbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxpbmtGbiA9IHBvc3RMaW5rRm5zW2ldOwogICAgICAgICAgICBsaW5rRm4obGlua0ZuLmlzb2xhdGVTY29wZSA/IGlzb2xhdGVTY29wZSA6IHNjb3BlLCAkZWxlbWVudCwgYXR0cnMsCiAgICAgICAgICAgICAgICBsaW5rRm4ucmVxdWlyZSAmJiBnZXRDb250cm9sbGVycyhsaW5rRm4uZGlyZWN0aXZlTmFtZSwgbGlua0ZuLnJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpLCB0cmFuc2NsdWRlRm4pOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyBpcyB0aGUgZnVuY3Rpb24gdGhhdCBpcyBpbmplY3RlZCBhcyBgJHRyYW5zY2x1ZGVgLgogICAgICAgIGZ1bmN0aW9uIGNvbnRyb2xsZXJzQm91bmRUcmFuc2NsdWRlKHNjb3BlLCBjbG9uZUF0dGFjaEZuKSB7CiAgICAgICAgICB2YXIgdHJhbnNjbHVkZUNvbnRyb2xsZXJzOwoKICAgICAgICAgIC8vIG5vIHNjb3BlIHBhc3NlZAogICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgIGNsb25lQXR0YWNoRm4gPSBzY29wZTsKICAgICAgICAgICAgc2NvcGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlKSB7CiAgICAgICAgICAgIHRyYW5zY2x1ZGVDb250cm9sbGVycyA9IGVsZW1lbnRDb250cm9sbGVyczsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gYm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIGNsb25lQXR0YWNoRm4sIHRyYW5zY2x1ZGVDb250cm9sbGVycyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbWFya0RpcmVjdGl2ZXNBc0lzb2xhdGUoZGlyZWN0aXZlcykgewogICAgICAvLyBtYXJrIGFsbCBkaXJlY3RpdmVzIGFzIG5lZWRpbmcgaXNvbGF0ZSBzY29wZS4KICAgICAgZm9yICh2YXIgaiA9IDAsIGpqID0gZGlyZWN0aXZlcy5sZW5ndGg7IGogPCBqajsgaisrKSB7CiAgICAgICAgZGlyZWN0aXZlc1tqXSA9IGluaGVyaXQoZGlyZWN0aXZlc1tqXSwgeyQkaXNvbGF0ZVNjb3BlOiB0cnVlfSk7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIGxvb2tzIHVwIHRoZSBkaXJlY3RpdmUgYW5kIGRlY29yYXRlcyBpdCB3aXRoIGV4Y2VwdGlvbiBoYW5kbGluZyBhbmQgcHJvcGVyIHBhcmFtZXRlcnMuIFdlCiAgICAgKiBjYWxsIHRoaXMgdGhlIGJvdW5kRGlyZWN0aXZlLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIG5hbWUgb2YgdGhlIGRpcmVjdGl2ZSB0byBsb29rIHVwLgogICAgICogQHBhcmFtIHtzdHJpbmd9IGxvY2F0aW9uIFRoZSBkaXJlY3RpdmUgbXVzdCBiZSBmb3VuZCBpbiBzcGVjaWZpYyBmb3JtYXQuCiAgICAgKiAgIFN0cmluZyBjb250YWluaW5nIGFueSBvZiB0aGVzZXMgY2hhcmFjdGVyczoKICAgICAqCiAgICAgKiAgICogYEVgOiBlbGVtZW50IG5hbWUKICAgICAqICAgKiBgQSc6IGF0dHJpYnV0ZQogICAgICogICAqIGBDYDogY2xhc3MKICAgICAqICAgKiBgTWA6IGNvbW1lbnQKICAgICAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIGRpcmVjdGl2ZSB3YXMgYWRkZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFkZERpcmVjdGl2ZSh0RGlyZWN0aXZlcywgbmFtZSwgbG9jYXRpb24sIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsIHN0YXJ0QXR0ck5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kQXR0ck5hbWUpIHsKICAgICAgaWYgKG5hbWUgPT09IGlnbm9yZURpcmVjdGl2ZSkgcmV0dXJuIG51bGw7CiAgICAgIHZhciBtYXRjaCA9IG51bGw7CiAgICAgIGlmIChoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgZm9yKHZhciBkaXJlY3RpdmUsIGRpcmVjdGl2ZXMgPSAkaW5qZWN0b3IuZ2V0KG5hbWUgKyBTdWZmaXgpLAogICAgICAgICAgICBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaTxpaTsgaSsrKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICBpZiAoIChtYXhQcmlvcml0eSA9PT0gdW5kZWZpbmVkIHx8IG1heFByaW9yaXR5ID4gZGlyZWN0aXZlLnByaW9yaXR5KSAmJgogICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdC5pbmRleE9mKGxvY2F0aW9uKSAhPSAtMSkgewogICAgICAgICAgICAgIGlmIChzdGFydEF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBpbmhlcml0KGRpcmVjdGl2ZSwgeyQkc3RhcnQ6IHN0YXJ0QXR0ck5hbWUsICQkZW5kOiBlbmRBdHRyTmFtZX0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0RGlyZWN0aXZlcy5wdXNoKGRpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgbWF0Y2ggPSBkaXJlY3RpdmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2goZSkgeyAkZXhjZXB0aW9uSGFuZGxlcihlKTsgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWF0Y2g7CiAgICB9CgoKICAgIC8qKgogICAgICogV2hlbiB0aGUgZWxlbWVudCBpcyByZXBsYWNlZCB3aXRoIEhUTUwgdGVtcGxhdGUgdGhlbiB0aGUgbmV3IGF0dHJpYnV0ZXMKICAgICAqIG9uIHRoZSB0ZW1wbGF0ZSBuZWVkIHRvIGJlIG1lcmdlZCB3aXRoIHRoZSBleGlzdGluZyBhdHRyaWJ1dGVzIGluIHRoZSBET00uCiAgICAgKiBUaGUgZGVzaXJlZCBlZmZlY3QgaXMgdG8gaGF2ZSBib3RoIG9mIHRoZSBhdHRyaWJ1dGVzIHByZXNlbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IGRzdCBkZXN0aW5hdGlvbiBhdHRyaWJ1dGVzIChvcmlnaW5hbCBET00pCiAgICAgKiBAcGFyYW0ge29iamVjdH0gc3JjIHNvdXJjZSBhdHRyaWJ1dGVzIChmcm9tIHRoZSBkaXJlY3RpdmUgdGVtcGxhdGUpCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKGRzdCwgc3JjKSB7CiAgICAgIHZhciBzcmNBdHRyID0gc3JjLiRhdHRyLAogICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICRlbGVtZW50ID0gZHN0LiQkZWxlbWVudDsKCiAgICAgIC8vIHJlYXBwbHkgdGhlIG9sZCBhdHRyaWJ1dGVzIHRvIHRoZSBuZXcgZWxlbWVudAogICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmIChrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgaWYgKHNyY1trZXldICYmIHNyY1trZXldICE9PSB2YWx1ZSkgewogICAgICAgICAgICB2YWx1ZSArPSAoa2V5ID09PSAnc3R5bGUnID8gJzsnIDogJyAnKSArIHNyY1trZXldOwogICAgICAgICAgfQogICAgICAgICAgZHN0LiRzZXQoa2V5LCB2YWx1ZSwgdHJ1ZSwgc3JjQXR0cltrZXldKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gY29weSB0aGUgbmV3IGF0dHJpYnV0ZXMgb24gdGhlIG9sZCBhdHRycyBvYmplY3QKICAgICAgZm9yRWFjaChzcmMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBpZiAoa2V5ID09ICdjbGFzcycpIHsKICAgICAgICAgIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgdmFsdWUpOwogICAgICAgICAgZHN0WydjbGFzcyddID0gKGRzdFsnY2xhc3MnXSA/IGRzdFsnY2xhc3MnXSArICcgJyA6ICcnKSArIHZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoa2V5ID09ICdzdHlsZScpIHsKICAgICAgICAgICRlbGVtZW50LmF0dHIoJ3N0eWxlJywgJGVsZW1lbnQuYXR0cignc3R5bGUnKSArICc7JyArIHZhbHVlKTsKICAgICAgICAgIGRzdFsnc3R5bGUnXSA9IChkc3RbJ3N0eWxlJ10gPyBkc3RbJ3N0eWxlJ10gKyAnOycgOiAnJykgKyB2YWx1ZTsKICAgICAgICAgIC8vIGBkc3RgIHdpbGwgbmV2ZXIgY29udGFpbiBoYXNPd25Qcm9wZXJ0eSBhcyBET00gcGFyc2VyIHdvbid0IGxldCBpdC4KICAgICAgICAgIC8vIFlvdSB3aWxsIGdldCBhbiAiSW52YWxpZENoYXJhY3RlckVycm9yOiBET00gRXhjZXB0aW9uIDUiIGVycm9yIGlmIHlvdQogICAgICAgICAgLy8gaGF2ZSBhbiBhdHRyaWJ1dGUgbGlrZSAiaGFzLW93bi1wcm9wZXJ0eSIgb3IgImRhdGEtaGFzLW93bi1wcm9wZXJ0eSIsIGV0Yy4KICAgICAgICB9IGVsc2UgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnICYmICFkc3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIGRzdEF0dHJba2V5XSA9IHNyY0F0dHJba2V5XTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKCiAgICBmdW5jdGlvbiBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcywgJGNvbXBpbGVOb2RlLCB0QXR0cnMsCiAgICAgICAgJHJvb3RFbGVtZW50LCBjaGlsZFRyYW5zY2x1ZGVGbiwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgdmFyIGxpbmtRdWV1ZSA9IFtdLAogICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4sCiAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sCiAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdLAogICAgICAgICAgb3JpZ0FzeW5jRGlyZWN0aXZlID0gZGlyZWN0aXZlcy5zaGlmdCgpLAogICAgICAgICAgLy8gVGhlIGZhY3QgdGhhdCB3ZSBoYXZlIHRvIGNvcHkgYW5kIHBhdGNoIHRoZSBkaXJlY3RpdmUgc2VlbXMgd3JvbmchCiAgICAgICAgICBkZXJpdmVkU3luY0RpcmVjdGl2ZSA9IGV4dGVuZCh7fSwgb3JpZ0FzeW5jRGlyZWN0aXZlLCB7CiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCByZXBsYWNlOiBudWxsLCAkJG9yaWdpbmFsRGlyZWN0aXZlOiBvcmlnQXN5bmNEaXJlY3RpdmUKICAgICAgICAgIH0pLAogICAgICAgICAgdGVtcGxhdGVVcmwgPSAoaXNGdW5jdGlvbihvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmwpKQogICAgICAgICAgICAgID8gb3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsKCRjb21waWxlTm9kZSwgdEF0dHJzKQogICAgICAgICAgICAgIDogb3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsOwoKICAgICAgJGNvbXBpbGVOb2RlLmVtcHR5KCk7CgogICAgICAkaHR0cC5nZXQoJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmwodGVtcGxhdGVVcmwpLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgc3VjY2VzcyhmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgICB2YXIgY29tcGlsZU5vZGUsIHRlbXBUZW1wbGF0ZUF0dHJzLCAkdGVtcGxhdGUsIGNoaWxkQm91bmRUcmFuc2NsdWRlRm47CgogICAgICAgICAgY29udGVudCA9IGRlbm9ybWFsaXplVGVtcGxhdGUoY29udGVudCk7CgogICAgICAgICAgaWYgKG9yaWdBc3luY0RpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgIGlmIChqcUxpdGVJc1RleHROb2RlKGNvbnRlbnQpKSB7CiAgICAgICAgICAgICAgJHRlbXBsYXRlID0gW107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKHRyaW0oY29udGVudCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgaWYgKCR0ZW1wbGF0ZS5sZW5ndGggIT0gMSB8fCBjb21waWxlTm9kZS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd0cGxydCcsCiAgICAgICAgICAgICAgICAgICJUZW1wbGF0ZSBmb3IgZGlyZWN0aXZlICd7MH0nIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHsxfSIsCiAgICAgICAgICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZS5uYW1lLCB0ZW1wbGF0ZVVybCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRlbXBUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CiAgICAgICAgICAgIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURpcmVjdGl2ZXMgPSBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgW10sIHRlbXBUZW1wbGF0ZUF0dHJzKTsKCiAgICAgICAgICAgIGlmIChpc09iamVjdChvcmlnQXN5bmNEaXJlY3RpdmUuc2NvcGUpKSB7CiAgICAgICAgICAgICAgbWFya0RpcmVjdGl2ZXNBc0lzb2xhdGUodGVtcGxhdGVEaXJlY3RpdmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXJlY3RpdmVzID0gdGVtcGxhdGVEaXJlY3RpdmVzLmNvbmNhdChkaXJlY3RpdmVzKTsKICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModEF0dHJzLCB0ZW1wVGVtcGxhdGVBdHRycyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb21waWxlTm9kZSA9IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGU7CiAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGNvbnRlbnQpOwogICAgICAgICAgfQoKICAgICAgICAgIGRpcmVjdGl2ZXMudW5zaGlmdChkZXJpdmVkU3luY0RpcmVjdGl2ZSk7CgogICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4gPSBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgY29tcGlsZU5vZGUsIHRBdHRycywKICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiwgJGNvbXBpbGVOb2RlLCBvcmlnQXN5bmNEaXJlY3RpdmUsIHByZUxpbmtGbnMsIHBvc3RMaW5rRm5zLAogICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpOwogICAgICAgICAgZm9yRWFjaCgkcm9vdEVsZW1lbnQsIGZ1bmN0aW9uKG5vZGUsIGkpIHsKICAgICAgICAgICAgaWYgKG5vZGUgPT0gY29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaV0gPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuID0gY29tcGlsZU5vZGVzKCRjb21waWxlTm9kZVswXS5jaGlsZE5vZGVzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CgoKICAgICAgICAgIHdoaWxlKGxpbmtRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgdmFyIHNjb3BlID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICBsaW5rUm9vdEVsZW1lbnQgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgIGJvdW5kVHJhbnNjbHVkZUZuID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICBsaW5rTm9kZSA9ICRjb21waWxlTm9kZVswXTsKCiAgICAgICAgICAgIGlmIChiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlICE9PSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlKSB7CiAgICAgICAgICAgICAgdmFyIG9sZENsYXNzZXMgPSBiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlLmNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgaWYgKCEocHJldmlvdXNDb21waWxlQ29udGV4dC5oYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSAmJgogICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUucmVwbGFjZSkpIHsKICAgICAgICAgICAgICAgIC8vIGl0IHdhcyBjbG9uZWQgdGhlcmVmb3JlIHdlIGhhdmUgdG8gY2xvbmUgYXMgd2VsbC4KICAgICAgICAgICAgICAgIGxpbmtOb2RlID0ganFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmVwbGFjZVdpdGgobGlua1Jvb3RFbGVtZW50LCBqcUxpdGUoYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSksIGxpbmtOb2RlKTsKCiAgICAgICAgICAgICAgLy8gQ29weSBpbiBDU1MgY2xhc3NlcyBmcm9tIG9yaWdpbmFsIG5vZGUKICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoanFMaXRlKGxpbmtOb2RlKSwgb2xkQ2xhc3Nlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLnRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLnRyYW5zY2x1ZGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4gPSBib3VuZFRyYW5zY2x1ZGVGbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbihhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LAogICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgfQogICAgICAgICAgbGlua1F1ZXVlID0gbnVsbDsKICAgICAgICB9KS4KICAgICAgICBlcnJvcihmdW5jdGlvbihyZXNwb25zZSwgY29kZSwgaGVhZGVycywgY29uZmlnKSB7CiAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndHBsb2FkJywgJ0ZhaWxlZCB0byBsb2FkIHRlbXBsYXRlOiB7MH0nLCBjb25maWcudXJsKTsKICAgICAgICB9KTsKCiAgICAgIHJldHVybiBmdW5jdGlvbiBkZWxheWVkTm9kZUxpbmtGbihpZ25vcmVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbikgewogICAgICAgIGlmIChsaW5rUXVldWUpIHsKICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHNjb3BlKTsKICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKG5vZGUpOwogICAgICAgICAgbGlua1F1ZXVlLnB1c2gocm9vdEVsZW1lbnQpOwogICAgICAgICAgbGlua1F1ZXVlLnB1c2goYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbihhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTb3J0aW5nIGZ1bmN0aW9uIGZvciBib3VuZCBkaXJlY3RpdmVzLgogICAgICovCiAgICBmdW5jdGlvbiBieVByaW9yaXR5KGEsIGIpIHsKICAgICAgdmFyIGRpZmYgPSBiLnByaW9yaXR5IC0gYS5wcmlvcml0eTsKICAgICAgaWYgKGRpZmYgIT09IDApIHJldHVybiBkaWZmOwogICAgICBpZiAoYS5uYW1lICE9PSBiLm5hbWUpIHJldHVybiAoYS5uYW1lIDwgYi5uYW1lKSA/IC0xIDogMTsKICAgICAgcmV0dXJuIGEuaW5kZXggLSBiLmluZGV4OwogICAgfQoKCiAgICBmdW5jdGlvbiBhc3NlcnROb0R1cGxpY2F0ZSh3aGF0LCBwcmV2aW91c0RpcmVjdGl2ZSwgZGlyZWN0aXZlLCBlbGVtZW50KSB7CiAgICAgIGlmIChwcmV2aW91c0RpcmVjdGl2ZSkgewogICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdtdWx0aWRpcicsICdNdWx0aXBsZSBkaXJlY3RpdmVzIFt7MH0sIHsxfV0gYXNraW5nIGZvciB7Mn0gb246IHszfScsCiAgICAgICAgICAgIHByZXZpb3VzRGlyZWN0aXZlLm5hbWUsIGRpcmVjdGl2ZS5uYW1lLCB3aGF0LCBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIHRleHQpIHsKICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodGV4dCwgdHJ1ZSk7CiAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICAgIHByaW9yaXR5OiAwLAogICAgICAgICAgY29tcGlsZTogdmFsdWVGbihmdW5jdGlvbiB0ZXh0SW50ZXJwb2xhdGVMaW5rRm4oc2NvcGUsIG5vZGUpIHsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IG5vZGUucGFyZW50KCksCiAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IHBhcmVudC5kYXRhKCckYmluZGluZycpIHx8IFtdOwogICAgICAgICAgICBiaW5kaW5ncy5wdXNoKGludGVycG9sYXRlRm4pOwogICAgICAgICAgICBzYWZlQWRkQ2xhc3MocGFyZW50LmRhdGEoJyRiaW5kaW5nJywgYmluZGluZ3MpLCAnbmctYmluZGluZycpOwogICAgICAgICAgICBzY29wZS4kd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgbm9kZVswXS5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGdldFRydXN0ZWRDb250ZXh0KG5vZGUsIGF0dHJOb3JtYWxpemVkTmFtZSkgewogICAgICBpZiAoYXR0ck5vcm1hbGl6ZWROYW1lID09ICJzcmNkb2MiKSB7CiAgICAgICAgcmV0dXJuICRzY2UuSFRNTDsKICAgICAgfQogICAgICB2YXIgdGFnID0gbm9kZU5hbWVfKG5vZGUpOwogICAgICAvLyBtYWN0aW9uW3hsaW5rOmhyZWZdIGNhbiBzb3VyY2UgU1ZHLiAgSXQncyBub3QgbGltaXRlZCB0byA8bWFjdGlvbj4uCiAgICAgIGlmIChhdHRyTm9ybWFsaXplZE5hbWUgPT0gInhsaW5rSHJlZiIgfHwKICAgICAgICAgICh0YWcgPT0gIkZPUk0iICYmIGF0dHJOb3JtYWxpemVkTmFtZSA9PSAiYWN0aW9uIikgfHwKICAgICAgICAgICh0YWcgIT0gIklNRyIgJiYgKGF0dHJOb3JtYWxpemVkTmFtZSA9PSAic3JjIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5vcm1hbGl6ZWROYW1lID09ICJuZ1NyYyIpKSkgewogICAgICAgIHJldHVybiAkc2NlLlJFU09VUkNFX1VSTDsKICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5hbWUpIHsKICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodmFsdWUsIHRydWUpOwoKICAgICAgLy8gbm8gaW50ZXJwb2xhdGlvbiBmb3VuZCAtPiBpZ25vcmUKICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgoKICAgICAgaWYgKG5hbWUgPT09ICJtdWx0aXBsZSIgJiYgbm9kZU5hbWVfKG5vZGUpID09PSAiU0VMRUNUIikgewogICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCJzZWxtdWx0aSIsCiAgICAgICAgICAgICJCaW5kaW5nIHRvIHRoZSAnbXVsdGlwbGUnIGF0dHJpYnV0ZSBpcyBub3Qgc3VwcG9ydGVkLiBFbGVtZW50OiB7MH0iLAogICAgICAgICAgICBzdGFydGluZ1RhZyhub2RlKSk7CiAgICAgIH0KCiAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIGF0dHJJbnRlcnBvbGF0ZVByZUxpbmtGbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gKGF0dHIuJCRvYnNlcnZlcnMgfHwgKGF0dHIuJCRvYnNlcnZlcnMgPSB7fSkpOwoKICAgICAgICAgICAgICAgIGlmIChFVkVOVF9IQU5ETEVSX0FUVFJfUkVHRVhQLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ25vZG9tZXZlbnRzJywKICAgICAgICAgICAgICAgICAgICAgICJJbnRlcnBvbGF0aW9ucyBmb3IgSFRNTCBET00gZXZlbnQgYXR0cmlidXRlcyBhcmUgZGlzYWxsb3dlZC4gIFBsZWFzZSB1c2UgdGhlICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICJuZy0gdmVyc2lvbnMgKHN1Y2ggYXMgbmctY2xpY2sgaW5zdGVhZCBvZiBvbmNsaWNrKSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gaW50ZXJwb2xhdGUgYWdhaW4sIGluIGNhc2UgdGhlIGF0dHJpYnV0ZSB2YWx1ZSBoYXMgYmVlbiB1cGRhdGVkCiAgICAgICAgICAgICAgICAvLyAoZS5nLiBieSBhbm90aGVyIGRpcmVjdGl2ZSdzIGNvbXBpbGUgZnVuY3Rpb24pCiAgICAgICAgICAgICAgICBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGF0dHJbbmFtZV0sIHRydWUsIGdldFRydXN0ZWRDb250ZXh0KG5vZGUsIG5hbWUpKTsKCiAgICAgICAgICAgICAgICAvLyBpZiBhdHRyaWJ1dGUgd2FzIHVwZGF0ZWQgc28gdGhhdCB0aGVyZSBpcyBubyBpbnRlcnBvbGF0aW9uIGdvaW5nIG9uIHdlIGRvbid0IHdhbnQgdG8KICAgICAgICAgICAgICAgIC8vIHJlZ2lzdGVyIGFueSBvYnNlcnZlcnMKICAgICAgICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIFRPRE8oaSk6IHRoaXMgc2hvdWxkIGxpa2VseSBiZSBhdHRyLiRzZXQobmFtZSwgaXRlcnBvbGF0ZUZuKHNjb3BlKSBzbyB0aGF0IHdlIHJlc2V0IHRoZQogICAgICAgICAgICAgICAgLy8gYWN0dWFsIGF0dHIgdmFsdWUKICAgICAgICAgICAgICAgIGF0dHJbbmFtZV0gPSBpbnRlcnBvbGF0ZUZuKHNjb3BlKTsKICAgICAgICAgICAgICAgICgkJG9ic2VydmVyc1tuYW1lXSB8fCAoJCRvYnNlcnZlcnNbbmFtZV0gPSBbXSkpLiQkaW50ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgKGF0dHIuJCRvYnNlcnZlcnMgJiYgYXR0ci4kJG9ic2VydmVyc1tuYW1lXS4kJHNjb3BlIHx8IHNjb3BlKS4KICAgICAgICAgICAgICAgICAgJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlRm5XYXRjaEFjdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAvL3NwZWNpYWwgY2FzZSBmb3IgY2xhc3MgYXR0cmlidXRlIGFkZGl0aW9uICsgcmVtb3ZhbAogICAgICAgICAgICAgICAgICAgIC8vc28gdGhhdCBjbGFzcyBjaGFuZ2VzIGNhbiB0YXAgaW50byB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgLy9ob29rcyBwcm92aWRlZCBieSB0aGUgJGFuaW1hdGUgc2VydmljZS4gQmUgc3VyZSB0bwogICAgICAgICAgICAgICAgICAgIC8vc2tpcCBhbmltYXRpb25zIHdoZW4gdGhlIGZpcnN0IGRpZ2VzdCBvY2N1cnMgKHdoZW4KICAgICAgICAgICAgICAgICAgICAvL2JvdGggdGhlIG5ldyBhbmQgdGhlIG9sZCB2YWx1ZXMgYXJlIHRoZSBzYW1lKSBzaW5jZQogICAgICAgICAgICAgICAgICAgIC8vdGhlIENTUyBjbGFzc2VzIGFyZSB0aGUgbm9uLWludGVycG9sYXRlZCB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICBpZihuYW1lID09PSAnY2xhc3MnICYmIG5ld1ZhbHVlICE9IG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICBhdHRyLiR1cGRhdGVDbGFzcyhuZXdWYWx1ZSwgb2xkVmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQobmFtZSwgbmV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICB9KTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBUaGlzIGlzIGEgc3BlY2lhbCBqcUxpdGUucmVwbGFjZVdpdGgsIHdoaWNoIGNhbiByZXBsYWNlIGl0ZW1zIHdoaWNoCiAgICAgKiBoYXZlIG5vIHBhcmVudHMsIHByb3ZpZGVkIHRoYXQgdGhlIGNvbnRhaW5pbmcganFMaXRlIGNvbGxlY3Rpb24gaXMgcHJvdmlkZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtKcUxpdGU9fSAkcm9vdEVsZW1lbnQgVGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZS4gVXNlZCBzbyB0aGF0IHdlIGNhbiByZXBsYWNlIG5vZGVzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbiB0aGUgcm9vdCBvZiB0aGUgdHJlZS4KICAgICAqIEBwYXJhbSB7SnFMaXRlfSBlbGVtZW50c1RvUmVtb3ZlIFRoZSBqcUxpdGUgZWxlbWVudCB3aGljaCB3ZSBhcmUgZ29pbmcgdG8gcmVwbGFjZS4gV2Uga2VlcAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHNoZWxsLCBidXQgcmVwbGFjZSBpdHMgRE9NIG5vZGUgcmVmZXJlbmNlLgogICAgICogQHBhcmFtIHtOb2RlfSBuZXdOb2RlIFRoZSBuZXcgRE9NIG5vZGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgZWxlbWVudHNUb1JlbW92ZSwgbmV3Tm9kZSkgewogICAgICB2YXIgZmlyc3RFbGVtZW50VG9SZW1vdmUgPSBlbGVtZW50c1RvUmVtb3ZlWzBdLAogICAgICAgICAgcmVtb3ZlQ291bnQgPSBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aCwKICAgICAgICAgIHBhcmVudCA9IGZpcnN0RWxlbWVudFRvUmVtb3ZlLnBhcmVudE5vZGUsCiAgICAgICAgICBpLCBpaTsKCiAgICAgIGlmICgkcm9vdEVsZW1lbnQpIHsKICAgICAgICBmb3IoaSA9IDAsIGlpID0gJHJvb3RFbGVtZW50Lmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgIGlmICgkcm9vdEVsZW1lbnRbaV0gPT0gZmlyc3RFbGVtZW50VG9SZW1vdmUpIHsKICAgICAgICAgICAgJHJvb3RFbGVtZW50W2krK10gPSBuZXdOb2RlOwogICAgICAgICAgICBmb3IgKHZhciBqID0gaSwgajIgPSBqICsgcmVtb3ZlQ291bnQgLSAxLAogICAgICAgICAgICAgICAgICAgICBqaiA9ICRyb290RWxlbWVudC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgaiA8IGpqOyBqKyssIGoyKyspIHsKICAgICAgICAgICAgICBpZiAoajIgPCBqaikgewogICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50W2pdID0gJHJvb3RFbGVtZW50W2oyXTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlICRyb290RWxlbWVudFtqXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJHJvb3RFbGVtZW50Lmxlbmd0aCAtPSByZW1vdmVDb3VudCAtIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHBhcmVudCkgewogICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgZmlyc3RFbGVtZW50VG9SZW1vdmUpOwogICAgICB9CiAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZmlyc3RFbGVtZW50VG9SZW1vdmUpOwogICAgICBuZXdOb2RlW2pxTGl0ZS5leHBhbmRvXSA9IGZpcnN0RWxlbWVudFRvUmVtb3ZlW2pxTGl0ZS5leHBhbmRvXTsKICAgICAgZm9yICh2YXIgayA9IDEsIGtrID0gZWxlbWVudHNUb1JlbW92ZS5sZW5ndGg7IGsgPCBrazsgaysrKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBlbGVtZW50c1RvUmVtb3ZlW2tdOwogICAgICAgIGpxTGl0ZShlbGVtZW50KS5yZW1vdmUoKTsgLy8gbXVzdCBkbyB0aGlzIHdheSB0byBjbGVhbiB1cCBleHBhbmRvCiAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgZGVsZXRlIGVsZW1lbnRzVG9SZW1vdmVba107CiAgICAgIH0KCiAgICAgIGVsZW1lbnRzVG9SZW1vdmVbMF0gPSBuZXdOb2RlOwogICAgICBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aCA9IDE7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNsb25lQW5kQW5ub3RhdGVGbihmbiwgYW5ub3RhdGlvbikgewogICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKCkgeyByZXR1cm4gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsgfSwgZm4sIGFubm90YXRpb24pOwogICAgfQogIH1dOwp9Cgp2YXIgUFJFRklYX1JFR0VYUCA9IC9eKHhbXDpcLV9dfGRhdGFbXDpcLV9dKS9pOwovKioKICogQ29udmVydHMgYWxsIGFjY2VwdGVkIGRpcmVjdGl2ZXMgZm9ybWF0IGludG8gcHJvcGVyIGRpcmVjdGl2ZSBuYW1lLgogKiBBbGwgb2YgdGhlc2Ugd2lsbCBiZWNvbWUgJ215RGlyZWN0aXZlJzoKICogICBteTpEaXJlY3RpdmUKICogICBteS1kaXJlY3RpdmUKICogICB4LW15LWRpcmVjdGl2ZQogKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAqCiAqIEFsc28gdGhlcmUgaXMgc3BlY2lhbCBjYXNlIGZvciBNb3ogcHJlZml4IHN0YXJ0aW5nIHdpdGggdXBwZXIgY2FzZSBsZXR0ZXIuCiAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAqLwpmdW5jdGlvbiBkaXJlY3RpdmVOb3JtYWxpemUobmFtZSkgewogIHJldHVybiBjYW1lbENhc2UobmFtZS5yZXBsYWNlKFBSRUZJWF9SRUdFWFAsICcnKSk7Cn0KCi8qKgogKiBAbmdkb2MgdHlwZQogKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogKgogKiBAZGVzY3JpcHRpb24KICogQSBzaGFyZWQgb2JqZWN0IGJldHdlZW4gZGlyZWN0aXZlIGNvbXBpbGUgLyBsaW5raW5nIGZ1bmN0aW9ucyB3aGljaCBjb250YWlucyBub3JtYWxpemVkIERPTQogKiBlbGVtZW50IGF0dHJpYnV0ZXMuIFRoZSB2YWx1ZXMgcmVmbGVjdCBjdXJyZW50IGJpbmRpbmcgc3RhdGUgYHt7IH19YC4gVGhlIG5vcm1hbGl6YXRpb24gaXMKICogbmVlZGVkIHNpbmNlIGFsbCBvZiB0aGVzZSBhcmUgdHJlYXRlZCBhcyBlcXVpdmFsZW50IGluIEFuZ3VsYXI6CiAqCiAqIGBgYAogKiAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAqIGBgYAogKi8KCi8qKgogKiBAbmdkb2MgcHJvcGVydHkKICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICogQHJldHVybnMge29iamVjdH0gQSBtYXAgb2YgRE9NIGVsZW1lbnQgYXR0cmlidXRlIG5hbWVzIHRvIHRoZSBub3JtYWxpemVkIG5hbWUuIFRoaXMgaXMKICogICAgICAgICAgICAgICAgICAgbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAqLwoKCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFNldCBET00gZWxlbWVudCBhdHRyaWJ1dGUgdmFsdWUuCiAqCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5vcm1hbGl6ZWQgZWxlbWVudCBhdHRyaWJ1dGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gbW9kaWZ5LiBUaGUgbmFtZSBpcwogKiAgICAgICAgICByZXZlcnNlLXRyYW5zbGF0ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkYXR0ciAkYXR0cn0KICogICAgICAgICAgcHJvcGVydHkgdG8gdGhlIG9yaWdpbmFsIG5hbWUuCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4gVGhlIHZhbHVlIGNhbiBiZSBhbiBpbnRlcnBvbGF0ZWQgc3RyaW5nLgogKi8KCgoKLyoqCiAqIENsb3N1cmUgY29tcGlsZXIgdHlwZSBpbmZvcm1hdGlvbgogKi8KCmZ1bmN0aW9uIG5vZGVzZXRMaW5raW5nRm4oCiAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAvKiBOb2RlTGlzdCAqLyBub2RlTGlzdCwKICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgope30KCmZ1bmN0aW9uIGRpcmVjdGl2ZUxpbmtpbmdGbigKICAvKiBub2Rlc2V0TGlua2luZ0ZuICovIG5vZGVzZXRMaW5raW5nRm4sCiAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAvKiBOb2RlICovIG5vZGUsCiAgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwKICAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4KKXt9CgpmdW5jdGlvbiB0b2tlbkRpZmZlcmVuY2Uoc3RyMSwgc3RyMikgewogIHZhciB2YWx1ZXMgPSAnJywKICAgICAgdG9rZW5zMSA9IHN0cjEuc3BsaXQoL1xzKy8pLAogICAgICB0b2tlbnMyID0gc3RyMi5zcGxpdCgvXHMrLyk7CgogIG91dGVyOgogIGZvcih2YXIgaSA9IDA7IGkgPCB0b2tlbnMxLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgdG9rZW4gPSB0b2tlbnMxW2ldOwogICAgZm9yKHZhciBqID0gMDsgaiA8IHRva2VuczIubGVuZ3RoOyBqKyspIHsKICAgICAgaWYodG9rZW4gPT0gdG9rZW5zMltqXSkgY29udGludWUgb3V0ZXI7CiAgICB9CiAgICB2YWx1ZXMgKz0gKHZhbHVlcy5sZW5ndGggPiAwID8gJyAnIDogJycpICsgdG9rZW47CiAgfQogIHJldHVybiB2YWx1ZXM7Cn0KCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGNvbnRyb2xsZXJQcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICogVGhlIHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlciBzZXJ2aWNlfSBpcyB1c2VkIGJ5IEFuZ3VsYXIgdG8gY3JlYXRlIG5ldwogKiBjb250cm9sbGVycy4KICoKICogVGhpcyBwcm92aWRlciBhbGxvd3MgY29udHJvbGxlciByZWdpc3RyYXRpb24gdmlhIHRoZQogKiB7QGxpbmsgbmcuJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlciByZWdpc3Rlcn0gbWV0aG9kLgogKi8KZnVuY3Rpb24gJENvbnRyb2xsZXJQcm92aWRlcigpIHsKICB2YXIgY29udHJvbGxlcnMgPSB7fSwKICAgICAgQ05UUkxfUkVHID0gL14oXFMrKShccythc1xzKyhcdyspKT8kLzsKCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIENvbnRyb2xsZXIgbmFtZSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBjb250cm9sbGVycyB3aGVyZSB0aGUga2V5cyBhcmUKICAgKiAgICB0aGUgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBjb25zdHJ1Y3RvcnMuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxBcnJheX0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmbiAob3B0aW9uYWxseSBkZWNvcmF0ZWQgd2l0aCBESQogICAqICAgIGFubm90YXRpb25zIGluIHRoZSBhcnJheSBub3RhdGlvbikuCiAgICovCiAgdGhpcy5yZWdpc3RlciA9IGZ1bmN0aW9uKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnY29udHJvbGxlcicpOwogICAgaWYgKGlzT2JqZWN0KG5hbWUpKSB7CiAgICAgIGV4dGVuZChjb250cm9sbGVycywgbmFtZSk7CiAgICB9IGVsc2UgewogICAgICBjb250cm9sbGVyc1tuYW1lXSA9IGNvbnN0cnVjdG9yOwogICAgfQogIH07CgoKICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckd2luZG93JywgZnVuY3Rpb24oJGluamVjdG9yLCAkd2luZG93KSB7CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgJGNvbnRyb2xsZXIKICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAqCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufHN0cmluZ30gY29uc3RydWN0b3IgSWYgY2FsbGVkIHdpdGggYSBmdW5jdGlvbiB0aGVuIGl0J3MgY29uc2lkZXJlZCB0byBiZSB0aGUKICAgICAqICAgIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIE90aGVyd2lzZSBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgYSBzdHJpbmcgd2hpY2ggaXMgdXNlZAogICAgICogICAgdG8gcmV0cmlldmUgdGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgdXNpbmcgdGhlIGZvbGxvd2luZyBzdGVwczoKICAgICAqCiAgICAgKiAgICAqIGNoZWNrIGlmIGEgY29udHJvbGxlciB3aXRoIGdpdmVuIG5hbWUgaXMgcmVnaXN0ZXJlZCB2aWEgYCRjb250cm9sbGVyUHJvdmlkZXJgCiAgICAgKiAgICAqIGNoZWNrIGlmIGV2YWx1YXRpbmcgdGhlIHN0cmluZyBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5zIGEgY29uc3RydWN0b3IKICAgICAqICAgICogY2hlY2sgYHdpbmRvd1tjb25zdHJ1Y3Rvcl1gIG9uIHRoZSBnbG9iYWwgYHdpbmRvd2Agb2JqZWN0CiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBJbmplY3Rpb24gbG9jYWxzIGZvciBDb250cm9sbGVyLgogICAgICogQHJldHVybiB7T2JqZWN0fSBJbnN0YW5jZSBvZiBnaXZlbiBjb250cm9sbGVyLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogYCRjb250cm9sbGVyYCBzZXJ2aWNlIGlzIHJlc3BvbnNpYmxlIGZvciBpbnN0YW50aWF0aW5nIGNvbnRyb2xsZXJzLgogICAgICoKICAgICAqIEl0J3MganVzdCBhIHNpbXBsZSBjYWxsIHRvIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LCBidXQgZXh0cmFjdGVkIGludG8KICAgICAqIGEgc2VydmljZSwgc28gdGhhdCBvbmUgY2FuIG92ZXJyaWRlIHRoaXMgc2VydmljZSB3aXRoIFtCQyB2ZXJzaW9uXShodHRwczovL2dpc3QuZ2l0aHViLmNvbS8xNjQ5Nzg4KS4KICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGxvY2FscykgewogICAgICB2YXIgaW5zdGFuY2UsIG1hdGNoLCBjb25zdHJ1Y3RvciwgaWRlbnRpZmllcjsKCiAgICAgIGlmKGlzU3RyaW5nKGV4cHJlc3Npb24pKSB7CiAgICAgICAgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKENOVFJMX1JFRyksCiAgICAgICAgY29uc3RydWN0b3IgPSBtYXRjaFsxXSwKICAgICAgICBpZGVudGlmaWVyID0gbWF0Y2hbM107CiAgICAgICAgZXhwcmVzc2lvbiA9IGNvbnRyb2xsZXJzLmhhc093blByb3BlcnR5KGNvbnN0cnVjdG9yKQogICAgICAgICAgICA/IGNvbnRyb2xsZXJzW2NvbnN0cnVjdG9yXQogICAgICAgICAgICA6IGdldHRlcihsb2NhbHMuJHNjb3BlLCBjb25zdHJ1Y3RvciwgdHJ1ZSkgfHwgZ2V0dGVyKCR3aW5kb3csIGNvbnN0cnVjdG9yLCB0cnVlKTsKCiAgICAgICAgYXNzZXJ0QXJnRm4oZXhwcmVzc2lvbiwgY29uc3RydWN0b3IsIHRydWUpOwogICAgICB9CgogICAgICBpbnN0YW5jZSA9ICRpbmplY3Rvci5pbnN0YW50aWF0ZShleHByZXNzaW9uLCBsb2NhbHMpOwoKICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICBpZiAoIShsb2NhbHMgJiYgdHlwZW9mIGxvY2Fscy4kc2NvcGUgPT0gJ29iamVjdCcpKSB7CiAgICAgICAgICB0aHJvdyBtaW5FcnIoJyRjb250cm9sbGVyJykoJ25vc2NwJywKICAgICAgICAgICAgICAiQ2Fubm90IGV4cG9ydCBjb250cm9sbGVyICd7MH0nIGFzICd7MX0nISBObyAkc2NvcGUgb2JqZWN0IHByb3ZpZGVkIHZpYSBgbG9jYWxzYC4iLAogICAgICAgICAgICAgIGNvbnN0cnVjdG9yIHx8IGV4cHJlc3Npb24ubmFtZSwgaWRlbnRpZmllcik7CiAgICAgICAgfQoKICAgICAgICBsb2NhbHMuJHNjb3BlW2lkZW50aWZpZXJdID0gaW5zdGFuY2U7CiAgICAgIH0KCiAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgIH07CiAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkZG9jdW1lbnQKICogQHJlcXVpcmVzICR3aW5kb3cKICoKICogQGRlc2NyaXB0aW9uCiAqIEEge0BsaW5rIGFuZ3VsYXIuZWxlbWVudCBqUXVlcnkgb3IganFMaXRlfSB3cmFwcGVyIGZvciB0aGUgYnJvd3NlcidzIGB3aW5kb3cuZG9jdW1lbnRgIG9iamVjdC4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ik1haW5DdHJsIj4KICAgICAgICAgPHA+JGRvY3VtZW50IHRpdGxlOiA8YiBuZy1iaW5kPSJ0aXRsZSI+PC9iPjwvcD4KICAgICAgICAgPHA+d2luZG93LmRvY3VtZW50IHRpdGxlOiA8YiBuZy1iaW5kPSJ3aW5kb3dUaXRsZSI+PC9iPjwvcD4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgZnVuY3Rpb24gTWFpbkN0cmwoJHNjb3BlLCAkZG9jdW1lbnQpIHsKICAgICAgICAgJHNjb3BlLnRpdGxlID0gJGRvY3VtZW50WzBdLnRpdGxlOwogICAgICAgICAkc2NvcGUud2luZG93VGl0bGUgPSBhbmd1bGFyLmVsZW1lbnQod2luZG93LmRvY3VtZW50KVswXS50aXRsZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uICREb2N1bWVudFByb3ZpZGVyKCl7CiAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24od2luZG93KXsKICAgIHJldHVybiBqcUxpdGUod2luZG93LmRvY3VtZW50KTsKICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRleGNlcHRpb25IYW5kbGVyCiAqIEByZXF1aXJlcyBuZy4kbG9nCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBbnkgdW5jYXVnaHQgZXhjZXB0aW9uIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGVsZWdhdGVkIHRvIHRoaXMgc2VydmljZS4KICogVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gc2ltcGx5IGRlbGVnYXRlcyB0byBgJGxvZy5lcnJvcmAgd2hpY2ggbG9ncyBpdCBpbnRvCiAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAqCiAqIEluIHVuaXQgdGVzdHMsIGlmIGBhbmd1bGFyLW1vY2tzLmpzYCBpcyBsb2FkZWQsIHRoaXMgc2VydmljZSBpcyBvdmVycmlkZGVuIGJ5CiAqIHtAbGluayBuZ01vY2suJGV4Y2VwdGlvbkhhbmRsZXIgbW9jayAkZXhjZXB0aW9uSGFuZGxlcn0gd2hpY2ggYWlkcyBpbiB0ZXN0aW5nLgogKgogKiAjIyBFeGFtcGxlOgogKgogKiBgYGBqcwogKiAgIGFuZ3VsYXIubW9kdWxlKCdleGNlcHRpb25PdmVycmlkZScsIFtdKS5mYWN0b3J5KCckZXhjZXB0aW9uSGFuZGxlcicsIGZ1bmN0aW9uICgpIHsKICogICAgIHJldHVybiBmdW5jdGlvbiAoZXhjZXB0aW9uLCBjYXVzZSkgewogKiAgICAgICBleGNlcHRpb24ubWVzc2FnZSArPSAnIChjYXVzZWQgYnkgIicgKyBjYXVzZSArICciKSc7CiAqICAgICAgIHRocm93IGV4Y2VwdGlvbjsKICogICAgIH07CiAqICAgfSk7CiAqIGBgYAogKgogKiBUaGlzIGV4YW1wbGUgd2lsbCBvdmVycmlkZSB0aGUgbm9ybWFsIGFjdGlvbiBvZiBgJGV4Y2VwdGlvbkhhbmRsZXJgLCB0byBtYWtlIGFuZ3VsYXIKICogZXhjZXB0aW9ucyBmYWlsIGhhcmQgd2hlbiB0aGV5IGhhcHBlbiwgaW5zdGVhZCBvZiBqdXN0IGxvZ2dpbmcgdG8gdGhlIGNvbnNvbGUuCiAqCiAqIEBwYXJhbSB7RXJyb3J9IGV4Y2VwdGlvbiBFeGNlcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBlcnJvci4KICogQHBhcmFtIHtzdHJpbmc9fSBjYXVzZSBvcHRpb25hbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY29udGV4dCBpbiB3aGljaAogKiAgICAgICB0aGUgZXJyb3Igd2FzIHRocm93bi4KICoKICovCmZ1bmN0aW9uICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckbG9nJywgZnVuY3Rpb24oJGxvZykgewogICAgcmV0dXJuIGZ1bmN0aW9uKGV4Y2VwdGlvbiwgY2F1c2UpIHsKICAgICAgJGxvZy5lcnJvci5hcHBseSgkbG9nLCBhcmd1bWVudHMpOwogICAgfTsKICB9XTsKfQoKLyoqCiAqIFBhcnNlIGhlYWRlcnMgaW50byBrZXkgdmFsdWUgb2JqZWN0CiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBoZWFkZXJzIFJhdyBoZWFkZXJzIGFzIGEgc3RyaW5nCiAqIEByZXR1cm5zIHtPYmplY3R9IFBhcnNlZCBoZWFkZXJzIGFzIGtleSB2YWx1ZSBvYmplY3QKICovCmZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoZWFkZXJzKSB7CiAgdmFyIHBhcnNlZCA9IHt9LCBrZXksIHZhbCwgaTsKCiAgaWYgKCFoZWFkZXJzKSByZXR1cm4gcGFyc2VkOwoKICBmb3JFYWNoKGhlYWRlcnMuc3BsaXQoJ1xuJyksIGZ1bmN0aW9uKGxpbmUpIHsKICAgIGkgPSBsaW5lLmluZGV4T2YoJzonKTsKICAgIGtleSA9IGxvd2VyY2FzZSh0cmltKGxpbmUuc3Vic3RyKDAsIGkpKSk7CiAgICB2YWwgPSB0cmltKGxpbmUuc3Vic3RyKGkgKyAxKSk7CgogICAgaWYgKGtleSkgewogICAgICBpZiAocGFyc2VkW2tleV0pIHsKICAgICAgICBwYXJzZWRba2V5XSArPSAnLCAnICsgdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnNlZFtrZXldID0gdmFsOwogICAgICB9CiAgICB9CiAgfSk7CgogIHJldHVybiBwYXJzZWQ7Cn0KCgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgcHJvdmlkZXMgYWNjZXNzIHRvIHBhcnNlZCBoZWFkZXJzLgogKgogKiBIZWFkZXJzIGFyZSBsYXp5IHBhcnNlZCB3aGVuIGZpcnN0IHJlcXVlc3RlZC4KICogQHNlZSBwYXJzZUhlYWRlcnMKICoKICogQHBhcmFtIHsoc3RyaW5nfE9iamVjdCl9IGhlYWRlcnMgSGVhZGVycyB0byBwcm92aWRlIGFjY2VzcyB0by4KICogQHJldHVybnMge2Z1bmN0aW9uKHN0cmluZz0pfSBSZXR1cm5zIGEgZ2V0dGVyIGZ1bmN0aW9uIHdoaWNoIGlmIGNhbGxlZCB3aXRoOgogKgogKiAgIC0gaWYgY2FsbGVkIHdpdGggc2luZ2xlIGFuIGFyZ3VtZW50IHJldHVybnMgYSBzaW5nbGUgaGVhZGVyIHZhbHVlIG9yIG51bGwKICogICAtIGlmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCBoZWFkZXJzLgogKi8KZnVuY3Rpb24gaGVhZGVyc0dldHRlcihoZWFkZXJzKSB7CiAgdmFyIGhlYWRlcnNPYmogPSBpc09iamVjdChoZWFkZXJzKSA/IGhlYWRlcnMgOiB1bmRlZmluZWQ7CgogIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICBpZiAoIWhlYWRlcnNPYmopIGhlYWRlcnNPYmogPSAgcGFyc2VIZWFkZXJzKGhlYWRlcnMpOwoKICAgIGlmIChuYW1lKSB7CiAgICAgIHJldHVybiBoZWFkZXJzT2JqW2xvd2VyY2FzZShuYW1lKV0gfHwgbnVsbDsKICAgIH0KCiAgICByZXR1cm4gaGVhZGVyc09iajsKICB9Owp9CgoKLyoqCiAqIENoYWluIGFsbCBnaXZlbiBmdW5jdGlvbnMKICoKICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciBib3RoIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWluZwogKgogKiBAcGFyYW0geyp9IGRhdGEgRGF0YSB0byB0cmFuc2Zvcm0uCiAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nPSl9IGhlYWRlcnMgSHR0cCBoZWFkZXJzIGdldHRlciBmbi4KICogQHBhcmFtIHsoRnVuY3Rpb258QXJyYXkuPEZ1bmN0aW9uPil9IGZucyBGdW5jdGlvbiBvciBhbiBhcnJheSBvZiBmdW5jdGlvbnMuCiAqIEByZXR1cm5zIHsqfSBUcmFuc2Zvcm1lZCBkYXRhLgogKi8KZnVuY3Rpb24gdHJhbnNmb3JtRGF0YShkYXRhLCBoZWFkZXJzLCBmbnMpIHsKICBpZiAoaXNGdW5jdGlvbihmbnMpKQogICAgcmV0dXJuIGZucyhkYXRhLCBoZWFkZXJzKTsKCiAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uKGZuKSB7CiAgICBkYXRhID0gZm4oZGF0YSwgaGVhZGVycyk7CiAgfSk7CgogIHJldHVybiBkYXRhOwp9CgoKZnVuY3Rpb24gaXNTdWNjZXNzKHN0YXR1cykgewogIHJldHVybiAyMDAgPD0gc3RhdHVzICYmIHN0YXR1cyA8IDMwMDsKfQoKCmZ1bmN0aW9uICRIdHRwUHJvdmlkZXIoKSB7CiAgdmFyIEpTT05fU1RBUlQgPSAvXlxzKihcW3xce1teXHtdKS8sCiAgICAgIEpTT05fRU5EID0gL1tcfVxdXVxzKiQvLAogICAgICBQUk9URUNUSU9OX1BSRUZJWCA9IC9eXClcXVx9Jyw/XG4vLAogICAgICBDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTiA9IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCd9OwoKICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgLy8gdHJhbnNmb3JtIGluY29taW5nIHJlc3BvbnNlIGRhdGEKICAgIHRyYW5zZm9ybVJlc3BvbnNlOiBbZnVuY3Rpb24oZGF0YSkgewogICAgICBpZiAoaXNTdHJpbmcoZGF0YSkpIHsKICAgICAgICAvLyBzdHJpcCBqc29uIHZ1bG5lcmFiaWxpdHkgcHJvdGVjdGlvbiBwcmVmaXgKICAgICAgICBkYXRhID0gZGF0YS5yZXBsYWNlKFBST1RFQ1RJT05fUFJFRklYLCAnJyk7CiAgICAgICAgaWYgKEpTT05fU1RBUlQudGVzdChkYXRhKSAmJiBKU09OX0VORC50ZXN0KGRhdGEpKQogICAgICAgICAgZGF0YSA9IGZyb21Kc29uKGRhdGEpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfV0sCgogICAgLy8gdHJhbnNmb3JtIG91dGdvaW5nIHJlcXVlc3QgZGF0YQogICAgdHJhbnNmb3JtUmVxdWVzdDogW2Z1bmN0aW9uKGQpIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmICFpc0ZpbGUoZCkgJiYgIWlzQmxvYihkKSA/IHRvSnNvbihkKSA6IGQ7CiAgICB9XSwKCiAgICAvLyBkZWZhdWx0IGhlYWRlcnMKICAgIGhlYWRlcnM6IHsKICAgICAgY29tbW9uOiB7CiAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqLyonCiAgICAgIH0sCiAgICAgIHBvc3Q6ICAgc2hhbGxvd0NvcHkoQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04pLAogICAgICBwdXQ6ICAgIHNoYWxsb3dDb3B5KENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OKSwKICAgICAgcGF0Y2g6ICBzaGFsbG93Q29weShDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTikKICAgIH0sCgogICAgeHNyZkNvb2tpZU5hbWU6ICdYU1JGLVRPS0VOJywKICAgIHhzcmZIZWFkZXJOYW1lOiAnWC1YU1JGLVRPS0VOJwogIH07CgogIC8qKgogICAqIEFyZSBvcmRlcmVkIGJ5IHJlcXVlc3QsIGkuZS4gdGhleSBhcmUgYXBwbGllZCBpbiB0aGUgc2FtZSBvcmRlciBhcyB0aGUKICAgKiBhcnJheSwgb24gcmVxdWVzdCwgYnV0IHJldmVyc2Ugb3JkZXIsIG9uIHJlc3BvbnNlLgogICAqLwogIHZhciBpbnRlcmNlcHRvckZhY3RvcmllcyA9IHRoaXMuaW50ZXJjZXB0b3JzID0gW107CgogIC8qKgogICAqIEZvciBoaXN0b3JpY2FsIHJlYXNvbnMsIHJlc3BvbnNlIGludGVyY2VwdG9ycyBhcmUgb3JkZXJlZCBieSB0aGUgb3JkZXIgaW4gd2hpY2gKICAgKiB0aGV5IGFyZSBhcHBsaWVkIHRvIHRoZSByZXNwb25zZS4gKFRoaXMgaXMgdGhlIG9wcG9zaXRlIG9mIGludGVyY2VwdG9yRmFjdG9yaWVzKQogICAqLwogIHZhciByZXNwb25zZUludGVyY2VwdG9yRmFjdG9yaWVzID0gdGhpcy5yZXNwb25zZUludGVyY2VwdG9ycyA9IFtdOwoKICB0aGlzLiRnZXQgPSBbJyRodHRwQmFja2VuZCcsICckYnJvd3NlcicsICckY2FjaGVGYWN0b3J5JywgJyRyb290U2NvcGUnLCAnJHEnLCAnJGluamVjdG9yJywKICAgICAgZnVuY3Rpb24oJGh0dHBCYWNrZW5kLCAkYnJvd3NlciwgJGNhY2hlRmFjdG9yeSwgJHJvb3RTY29wZSwgJHEsICRpbmplY3RvcikgewoKICAgIHZhciBkZWZhdWx0Q2FjaGUgPSAkY2FjaGVGYWN0b3J5KCckaHR0cCcpOwoKICAgIC8qKgogICAgICogSW50ZXJjZXB0b3JzIHN0b3JlZCBpbiByZXZlcnNlIG9yZGVyLiBJbm5lciBpbnRlcmNlcHRvcnMgYmVmb3JlIG91dGVyIGludGVyY2VwdG9ycy4KICAgICAqIFRoZSByZXZlcnNhbCBpcyBuZWVkZWQgc28gdGhhdCB3ZSBjYW4gYnVpbGQgdXAgdGhlIGludGVyY2VwdGlvbiBjaGFpbiBhcm91bmQgdGhlCiAgICAgKiBzZXJ2ZXIgcmVxdWVzdC4KICAgICAqLwogICAgdmFyIHJldmVyc2VkSW50ZXJjZXB0b3JzID0gW107CgogICAgZm9yRWFjaChpbnRlcmNlcHRvckZhY3RvcmllcywgZnVuY3Rpb24oaW50ZXJjZXB0b3JGYWN0b3J5KSB7CiAgICAgIHJldmVyc2VkSW50ZXJjZXB0b3JzLnVuc2hpZnQoaXNTdHJpbmcoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgPyAkaW5qZWN0b3IuZ2V0KGludGVyY2VwdG9yRmFjdG9yeSkgOiAkaW5qZWN0b3IuaW52b2tlKGludGVyY2VwdG9yRmFjdG9yeSkpOwogICAgfSk7CgogICAgZm9yRWFjaChyZXNwb25zZUludGVyY2VwdG9yRmFjdG9yaWVzLCBmdW5jdGlvbihpbnRlcmNlcHRvckZhY3RvcnksIGluZGV4KSB7CiAgICAgIHZhciByZXNwb25zZUZuID0gaXNTdHJpbmcoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgPyAkaW5qZWN0b3IuZ2V0KGludGVyY2VwdG9yRmFjdG9yeSkKICAgICAgICAgIDogJGluamVjdG9yLmludm9rZShpbnRlcmNlcHRvckZhY3RvcnkpOwoKICAgICAgLyoqCiAgICAgICAqIFJlc3BvbnNlIGludGVyY2VwdG9ycyBnbyBiZWZvcmUgImFyb3VuZCIgaW50ZXJjZXB0b3JzIChubyByZWFsIHJlYXNvbiwganVzdAogICAgICAgKiBoYWQgdG8gcGljayBvbmUuKSBCdXQgdGhleSBhcmUgYWxyZWFkeSByZXZlcnNlZCwgc28gd2UgY2FuJ3QgdXNlIHVuc2hpZnQsIGhlbmNlCiAgICAgICAqIHRoZSBzcGxpY2UuCiAgICAgICAqLwogICAgICByZXZlcnNlZEludGVyY2VwdG9ycy5zcGxpY2UoaW5kZXgsIDAsIHsKICAgICAgICByZXNwb25zZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIHJldHVybiByZXNwb25zZUZuKCRxLndoZW4ocmVzcG9uc2UpKTsKICAgICAgICB9LAogICAgICAgIHJlc3BvbnNlRXJyb3I6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICByZXR1cm4gcmVzcG9uc2VGbigkcS5yZWplY3QocmVzcG9uc2UpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSAkaHR0cAogICAgICogQHJlcXVpcmVzIG5nLiRodHRwQmFja2VuZAogICAgICogQHJlcXVpcmVzICRjYWNoZUZhY3RvcnkKICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgKiBAcmVxdWlyZXMgJHEKICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBjb3JlIEFuZ3VsYXIgc2VydmljZSB0aGF0IGZhY2lsaXRhdGVzIGNvbW11bmljYXRpb24gd2l0aCB0aGUgcmVtb3RlCiAgICAgKiBIVFRQIHNlcnZlcnMgdmlhIHRoZSBicm93c2VyJ3MgW1hNTEh0dHBSZXF1ZXN0XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi94bWxodHRwcmVxdWVzdCkKICAgICAqIG9iamVjdCBvciB2aWEgW0pTT05QXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT05QKS4KICAgICAqCiAgICAgKiBGb3IgdW5pdCB0ZXN0aW5nIGFwcGxpY2F0aW9ucyB0aGF0IHVzZSBgJGh0dHBgIHNlcnZpY2UsIHNlZQogICAgICoge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQgJGh0dHBCYWNrZW5kIG1vY2t9LgogICAgICoKICAgICAqIEZvciBhIGhpZ2hlciBsZXZlbCBvZiBhYnN0cmFjdGlvbiwgcGxlYXNlIGNoZWNrIG91dCB0aGUge0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlCiAgICAgKiAkcmVzb3VyY2V9IHNlcnZpY2UuCiAgICAgKgogICAgICogVGhlICRodHRwIEFQSSBpcyBiYXNlZCBvbiB0aGUge0BsaW5rIG5nLiRxIGRlZmVycmVkL3Byb21pc2UgQVBJc30gZXhwb3NlZCBieQogICAgICogdGhlICRxIHNlcnZpY2UuIFdoaWxlIGZvciBzaW1wbGUgdXNhZ2UgcGF0dGVybnMgdGhpcyBkb2Vzbid0IG1hdHRlciBtdWNoLCBmb3IgYWR2YW5jZWQgdXNhZ2UKICAgICAqIGl0IGlzIGltcG9ydGFudCB0byBmYW1pbGlhcml6ZSB5b3Vyc2VsZiB3aXRoIHRoZXNlIEFQSXMgYW5kIHRoZSBndWFyYW50ZWVzIHRoZXkgcHJvdmlkZS4KICAgICAqCiAgICAgKgogICAgICogIyBHZW5lcmFsIHVzYWdlCiAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgYSBzaW5nbGUgYXJndW1lbnQg4oCUIGEgY29uZmlndXJhdGlvbiBvYmplY3Qg4oCUCiAgICAgKiB0aGF0IGlzIHVzZWQgdG8gZ2VuZXJhdGUgYW4gSFRUUCByZXF1ZXN0IGFuZCByZXR1cm5zICBhIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICogd2l0aCB0d28gJGh0dHAgc3BlY2lmaWMgbWV0aG9kczogYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgLgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAgICRodHRwKHttZXRob2Q6ICdHRVQnLCB1cmw6ICcvc29tZVVybCd9KS4KICAgICAqICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgKiAgICAgICAvLyB3aGVuIHRoZSByZXNwb25zZSBpcyBhdmFpbGFibGUKICAgICAqICAgICB9KS4KICAgICAqICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICogICAgICAgLy8gY2FsbGVkIGFzeW5jaHJvbm91c2x5IGlmIGFuIGVycm9yIG9jY3VycwogICAgICogICAgICAgLy8gb3Igc2VydmVyIHJldHVybnMgcmVzcG9uc2Ugd2l0aCBhbiBlcnJvciBzdGF0dXMuCiAgICAgKiAgICAgfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBTaW5jZSB0aGUgcmV0dXJuZWQgdmFsdWUgb2YgY2FsbGluZyB0aGUgJGh0dHAgZnVuY3Rpb24gaXMgYSBgcHJvbWlzZWAsIHlvdSBjYW4gYWxzbyB1c2UKICAgICAqIHRoZSBgdGhlbmAgbWV0aG9kIHRvIHJlZ2lzdGVyIGNhbGxiYWNrcywgYW5kIHRoZXNlIGNhbGxiYWNrcyB3aWxsIHJlY2VpdmUgYSBzaW5nbGUgYXJndW1lbnQg4oCTCiAgICAgKiBhbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXNwb25zZS4gU2VlIHRoZSBBUEkgc2lnbmF0dXJlIGFuZCB0eXBlIGluZm8gYmVsb3cgZm9yIG1vcmUKICAgICAqIGRldGFpbHMuCiAgICAgKgogICAgICogQSByZXNwb25zZSBzdGF0dXMgY29kZSBiZXR3ZWVuIDIwMCBhbmQgMjk5IGlzIGNvbnNpZGVyZWQgYSBzdWNjZXNzIHN0YXR1cyBhbmQKICAgICAqIHdpbGwgcmVzdWx0IGluIHRoZSBzdWNjZXNzIGNhbGxiYWNrIGJlaW5nIGNhbGxlZC4gTm90ZSB0aGF0IGlmIHRoZSByZXNwb25zZSBpcyBhIHJlZGlyZWN0LAogICAgICogWE1MSHR0cFJlcXVlc3Qgd2lsbCB0cmFuc3BhcmVudGx5IGZvbGxvdyBpdCwgbWVhbmluZyB0aGF0IHRoZSBlcnJvciBjYWxsYmFjayB3aWxsIG5vdCBiZQogICAgICogY2FsbGVkIGZvciBzdWNoIHJlc3BvbnNlcy4KICAgICAqCiAgICAgKiAjIFdyaXRpbmcgVW5pdCBUZXN0cyB0aGF0IHVzZSAkaHR0cAogICAgICogV2hlbiB1bml0IHRlc3RpbmcgKHVzaW5nIHtAbGluayBuZ01vY2sgbmdNb2NrfSksIGl0IGlzIG5lY2Vzc2FyeSB0byBjYWxsCiAgICAgKiB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCNmbHVzaCAkaHR0cEJhY2tlbmQuZmx1c2goKX0gdG8gZmx1c2ggZWFjaCBwZW5kaW5nCiAgICAgKiByZXF1ZXN0IHVzaW5nIHRyYWluZWQgcmVzcG9uc2VzLgogICAgICoKICAgICAqIGBgYAogICAgICogJGh0dHBCYWNrZW5kLmV4cGVjdEdFVCguLi4pOwogICAgICogJGh0dHAuZ2V0KC4uLik7CiAgICAgKiAkaHR0cEJhY2tlbmQuZmx1c2goKTsKICAgICAqIGBgYAogICAgICoKICAgICAqICMgU2hvcnRjdXQgbWV0aG9kcwogICAgICoKICAgICAqIFNob3J0Y3V0IG1ldGhvZHMgYXJlIGFsc28gYXZhaWxhYmxlLiBBbGwgc2hvcnRjdXQgbWV0aG9kcyByZXF1aXJlIHBhc3NpbmcgaW4gdGhlIFVSTCwgYW5kCiAgICAgKiByZXF1ZXN0IGRhdGEgbXVzdCBiZSBwYXNzZWQgaW4gZm9yIFBPU1QvUFVUIHJlcXVlc3RzLgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAgICRodHRwLmdldCgnL3NvbWVVcmwnKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgKiAgICRodHRwLnBvc3QoJy9zb21lVXJsJywgZGF0YSkuc3VjY2VzcyhzdWNjZXNzQ2FsbGJhY2spOwogICAgICogYGBgCiAgICAgKgogICAgICogQ29tcGxldGUgbGlzdCBvZiBzaG9ydGN1dCBtZXRob2RzOgogICAgICoKICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2dldCAkaHR0cC5nZXR9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNoZWFkICRodHRwLmhlYWR9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwb3N0ICRodHRwLnBvc3R9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwdXQgJGh0dHAucHV0fQogICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZGVsZXRlICRodHRwLmRlbGV0ZX0KICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2pzb25wICRodHRwLmpzb25wfQogICAgICoKICAgICAqCiAgICAgKiAjIFNldHRpbmcgSFRUUCBIZWFkZXJzCiAgICAgKgogICAgICogVGhlICRodHRwIHNlcnZpY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGFkZCBjZXJ0YWluIEhUVFAgaGVhZGVycyB0byBhbGwgcmVxdWVzdHMuIFRoZXNlIGRlZmF1bHRzCiAgICAgKiBjYW4gYmUgZnVsbHkgY29uZmlndXJlZCBieSBhY2Nlc3NpbmcgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnNgIGNvbmZpZ3VyYXRpb24KICAgICAqIG9iamVjdCwgd2hpY2ggY3VycmVudGx5IGNvbnRhaW5zIHRoaXMgZGVmYXVsdCBjb25maWd1cmF0aW9uOgogICAgICoKICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5jb21tb25gIChoZWFkZXJzIHRoYXQgYXJlIGNvbW1vbiBmb3IgYWxsIHJlcXVlc3RzKToKICAgICAqICAgLSBgQWNjZXB0OiBhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqIC8gKmAKICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YDogKGhlYWRlciBkZWZhdWx0cyBmb3IgUE9TVCByZXF1ZXN0cykKICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnB1dGAgKGhlYWRlciBkZWZhdWx0cyBmb3IgUFVUIHJlcXVlc3RzKQogICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgKgogICAgICogVG8gYWRkIG9yIG92ZXJ3cml0ZSB0aGVzZSBkZWZhdWx0cywgc2ltcGx5IGFkZCBvciByZW1vdmUgYSBwcm9wZXJ0eSBmcm9tIHRoZXNlIGNvbmZpZ3VyYXRpb24KICAgICAqIG9iamVjdHMuIFRvIGFkZCBoZWFkZXJzIGZvciBhbiBIVFRQIG1ldGhvZCBvdGhlciB0aGFuIFBPU1Qgb3IgUFVULCBzaW1wbHkgYWRkIGEgbmV3IG9iamVjdAogICAgICogd2l0aCB0aGUgbG93ZXJjYXNlZCBIVFRQIG1ldGhvZCBuYW1lIGFzIHRoZSBrZXksIGUuZy4KICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuZ2V0ID0geyAnTXktSGVhZGVyJyA6ICd2YWx1ZScgfS4KICAgICAqCiAgICAgKiBUaGUgZGVmYXVsdHMgY2FuIGFsc28gYmUgc2V0IGF0IHJ1bnRpbWUgdmlhIHRoZSBgJGh0dHAuZGVmYXVsdHNgIG9iamVjdCBpbiB0aGUgc2FtZQogICAgICogZmFzaGlvbi4gRm9yIGV4YW1wbGU6CiAgICAgKgogICAgICogYGBgCiAgICAgKiBtb2R1bGUucnVuKGZ1bmN0aW9uKCRodHRwKSB7CiAgICAgKiAgICRodHRwLmRlZmF1bHRzLmhlYWRlcnMuY29tbW9uLkF1dGhvcml6YXRpb24gPSAnQmFzaWMgWW1WbGNEcGliMjl3JwogICAgICogfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBJbiBhZGRpdGlvbiwgeW91IGNhbiBzdXBwbHkgYSBgaGVhZGVyc2AgcHJvcGVydHkgaW4gdGhlIGNvbmZpZyBvYmplY3QgcGFzc2VkIHdoZW4KICAgICAqIGNhbGxpbmcgYCRodHRwKGNvbmZpZylgLCB3aGljaCBvdmVycmlkZXMgdGhlIGRlZmF1bHRzIHdpdGhvdXQgY2hhbmdpbmcgdGhlbSBnbG9iYWxseS4KICAgICAqCiAgICAgKgogICAgICogIyBUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcwogICAgICoKICAgICAqIEJvdGggcmVxdWVzdHMgYW5kIHJlc3BvbnNlcyBjYW4gYmUgdHJhbnNmb3JtZWQgdXNpbmcgdHJhbnNmb3JtIGZ1bmN0aW9ucy4gQnkgZGVmYXVsdCwgQW5ndWxhcgogICAgICogYXBwbGllcyB0aGVzZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgKgogICAgICogUmVxdWVzdCB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgKgogICAgICogLSBJZiB0aGUgYGRhdGFgIHByb3BlcnR5IG9mIHRoZSByZXF1ZXN0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGNvbnRhaW5zIGFuIG9iamVjdCwgc2VyaWFsaXplIGl0CiAgICAgKiAgIGludG8gSlNPTiBmb3JtYXQuCiAgICAgKgogICAgICogUmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICoKICAgICAqICAtIElmIFhTUkYgcHJlZml4IGlzIGRldGVjdGVkLCBzdHJpcCBpdCAoc2VlIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zIHNlY3Rpb24gYmVsb3cpLgogICAgICogIC0gSWYgSlNPTiByZXNwb25zZSBpcyBkZXRlY3RlZCwgZGVzZXJpYWxpemUgaXQgdXNpbmcgYSBKU09OIHBhcnNlci4KICAgICAqCiAgICAgKiBUbyBnbG9iYWxseSBhdWdtZW50IG9yIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHRyYW5zZm9ybXMsIG1vZGlmeSB0aGUKICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlcXVlc3RgIGFuZCBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZWAKICAgICAqIHByb3BlcnRpZXMuIFRoZXNlIHByb3BlcnRpZXMgYXJlIGJ5IGRlZmF1bHQgYW4gYXJyYXkgb2YgdHJhbnNmb3JtIGZ1bmN0aW9ucywgd2hpY2ggYWxsb3dzIHlvdQogICAgICogdG8gYHB1c2hgIG9yIGB1bnNoaWZ0YCBhIG5ldyB0cmFuc2Zvcm1hdGlvbiBmdW5jdGlvbiBpbnRvIHRoZSB0cmFuc2Zvcm1hdGlvbiBjaGFpbi4gWW91IGNhbgogICAgICogYWxzbyBkZWNpZGUgdG8gY29tcGxldGVseSBvdmVycmlkZSBhbnkgZGVmYXVsdCB0cmFuc2Zvcm1hdGlvbnMgYnkgYXNzaWduaW5nIHlvdXIKICAgICAqIHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9ucyB0byB0aGVzZSBwcm9wZXJ0aWVzIGRpcmVjdGx5IHdpdGhvdXQgdGhlIGFycmF5IHdyYXBwZXIuICBUaGVzZSBkZWZhdWx0cwogICAgICogYXJlIGFnYWluIGF2YWlsYWJsZSBvbiB0aGUgJGh0dHAgZmFjdG9yeSBhdCBydW4tdGltZSwgd2hpY2ggbWF5IGJlIHVzZWZ1bCBpZiB5b3UgaGF2ZSBydW4tdGltZQogICAgICogc2VydmljZXMgeW91IHdpc2ggdG8gYmUgaW52b2x2ZWQgaW4geW91ciB0cmFuc2Zvcm1hdGlvbnMuCiAgICAgKgogICAgICogU2ltaWxhcmx5LCB0byBsb2NhbGx5IG92ZXJyaWRlIHRoZSByZXF1ZXN0L3Jlc3BvbnNlIHRyYW5zZm9ybXMsIGF1Z21lbnQgdGhlCiAgICAgKiBgdHJhbnNmb3JtUmVxdWVzdGAgYW5kL29yIGB0cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcyBvZiB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QgcGFzc2VkCiAgICAgKiBpbnRvIGAkaHR0cGAuCiAgICAgKgogICAgICoKICAgICAqICMgQ2FjaGluZwogICAgICoKICAgICAqIFRvIGVuYWJsZSBjYWNoaW5nLCBzZXQgdGhlIHJlcXVlc3QgY29uZmlndXJhdGlvbiBgY2FjaGVgIHByb3BlcnR5IHRvIGB0cnVlYCAodG8gdXNlIGRlZmF1bHQKICAgICAqIGNhY2hlKSBvciB0byBhIGN1c3RvbSBjYWNoZSBvYmplY3QgKGJ1aWx0IHdpdGgge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgYCRjYWNoZUZhY3RvcnlgfSkuCiAgICAgKiBXaGVuIHRoZSBjYWNoZSBpcyBlbmFibGVkLCBgJGh0dHBgIHN0b3JlcyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyIGluIHRoZSBzcGVjaWZpZWQKICAgICAqIGNhY2hlLiBUaGUgbmV4dCB0aW1lIHRoZSBzYW1lIHJlcXVlc3QgaXMgbWFkZSwgdGhlIHJlc3BvbnNlIGlzIHNlcnZlZCBmcm9tIHRoZSBjYWNoZSB3aXRob3V0CiAgICAgKiBzZW5kaW5nIGEgcmVxdWVzdCB0byB0aGUgc2VydmVyLgogICAgICoKICAgICAqIE5vdGUgdGhhdCBldmVuIGlmIHRoZSByZXNwb25zZSBpcyBzZXJ2ZWQgZnJvbSBjYWNoZSwgZGVsaXZlcnkgb2YgdGhlIGRhdGEgaXMgYXN5bmNocm9ub3VzIGluCiAgICAgKiB0aGUgc2FtZSB3YXkgdGhhdCByZWFsIHJlcXVlc3RzIGFyZS4KICAgICAqCiAgICAgKiBJZiB0aGVyZSBhcmUgbXVsdGlwbGUgR0VUIHJlcXVlc3RzIGZvciB0aGUgc2FtZSBVUkwgdGhhdCBzaG91bGQgYmUgY2FjaGVkIHVzaW5nIHRoZSBzYW1lCiAgICAgKiBjYWNoZSwgYnV0IHRoZSBjYWNoZSBpcyBub3QgcG9wdWxhdGVkIHlldCwgb25seSBvbmUgcmVxdWVzdCB0byB0aGUgc2VydmVyIHdpbGwgYmUgbWFkZSBhbmQKICAgICAqIHRoZSByZW1haW5pbmcgcmVxdWVzdHMgd2lsbCBiZSBmdWxmaWxsZWQgdXNpbmcgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGZpcnN0IHJlcXVlc3QuCiAgICAgKgogICAgICogWW91IGNhbiBjaGFuZ2UgdGhlIGRlZmF1bHQgY2FjaGUgdG8gYSBuZXcgb2JqZWN0IChidWlsdCB3aXRoCiAgICAgKiB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSBgJGNhY2hlRmFjdG9yeWB9KSBieSB1cGRhdGluZyB0aGUKICAgICAqIHtAbGluayBuZy4kaHR0cCNwcm9wZXJ0aWVzX2RlZmF1bHRzIGAkaHR0cC5kZWZhdWx0cy5jYWNoZWB9IHByb3BlcnR5LiBBbGwgcmVxdWVzdHMgd2hvIHNldAogICAgICogdGhlaXIgYGNhY2hlYCBwcm9wZXJ0eSB0byBgdHJ1ZWAgd2lsbCBub3cgdXNlIHRoaXMgY2FjaGUgb2JqZWN0LgogICAgICoKICAgICAqIElmIHlvdSBzZXQgdGhlIGRlZmF1bHQgY2FjaGUgdG8gYGZhbHNlYCB0aGVuIG9ubHkgcmVxdWVzdHMgdGhhdCBzcGVjaWZ5IHRoZWlyIG93biBjdXN0b20KICAgICAqIGNhY2hlIG9iamVjdCB3aWxsIGJlIGNhY2hlZC4KICAgICAqCiAgICAgKiAjIEludGVyY2VwdG9ycwogICAgICoKICAgICAqIEJlZm9yZSB5b3Ugc3RhcnQgY3JlYXRpbmcgaW50ZXJjZXB0b3JzLCBiZSBzdXJlIHRvIHVuZGVyc3RhbmQgdGhlCiAgICAgKiB7QGxpbmsgbmcuJHEgJHEgYW5kIGRlZmVycmVkL3Byb21pc2UgQVBJc30uCiAgICAgKgogICAgICogRm9yIHB1cnBvc2VzIG9mIGdsb2JhbCBlcnJvciBoYW5kbGluZywgYXV0aGVudGljYXRpb24sIG9yIGFueSBraW5kIG9mIHN5bmNocm9ub3VzIG9yCiAgICAgKiBhc3luY2hyb25vdXMgcHJlLXByb2Nlc3Npbmcgb2YgcmVxdWVzdCBvciBwb3N0cHJvY2Vzc2luZyBvZiByZXNwb25zZXMsIGl0IGlzIGRlc2lyYWJsZSB0byBiZQogICAgICogYWJsZSB0byBpbnRlcmNlcHQgcmVxdWVzdHMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCB0byB0aGUgc2VydmVyIGFuZAogICAgICogcmVzcG9uc2VzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgb3ZlciB0byB0aGUgYXBwbGljYXRpb24gY29kZSB0aGF0CiAgICAgKiBpbml0aWF0ZWQgdGhlc2UgcmVxdWVzdHMuIFRoZSBpbnRlcmNlcHRvcnMgbGV2ZXJhZ2UgdGhlIHtAbGluayBuZy4kcQogICAgICogcHJvbWlzZSBBUElzfSB0byBmdWxmaWxsIHRoaXMgbmVlZCBmb3IgYm90aCBzeW5jaHJvbm91cyBhbmQgYXN5bmNocm9ub3VzIHByZS1wcm9jZXNzaW5nLgogICAgICoKICAgICAqIFRoZSBpbnRlcmNlcHRvcnMgYXJlIHNlcnZpY2UgZmFjdG9yaWVzIHRoYXQgYXJlIHJlZ2lzdGVyZWQgd2l0aCB0aGUgYCRodHRwUHJvdmlkZXJgIGJ5CiAgICAgKiBhZGRpbmcgdGhlbSB0byB0aGUgYCRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzYCBhcnJheS4gVGhlIGZhY3RvcnkgaXMgY2FsbGVkIGFuZAogICAgICogaW5qZWN0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgKGlmIHNwZWNpZmllZCkgYW5kIHJldHVybnMgdGhlIGludGVyY2VwdG9yLgogICAgICoKICAgICAqIFRoZXJlIGFyZSB0d28ga2luZHMgb2YgaW50ZXJjZXB0b3JzIChhbmQgdHdvIGtpbmRzIG9mIHJlamVjdGlvbiBpbnRlcmNlcHRvcnMpOgogICAgICoKICAgICAqICAgKiBgcmVxdWVzdGA6IGludGVyY2VwdG9ycyBnZXQgY2FsbGVkIHdpdGggYSBodHRwIGBjb25maWdgIG9iamVjdC4gVGhlIGZ1bmN0aW9uIGlzIGZyZWUgdG8KICAgICAqICAgICBtb2RpZnkgdGhlIGBjb25maWdgIG9iamVjdCBvciBjcmVhdGUgYSBuZXcgb25lLiBUaGUgZnVuY3Rpb24gbmVlZHMgdG8gcmV0dXJuIHRoZSBgY29uZmlnYAogICAgICogICAgIG9iamVjdCBkaXJlY3RseSwgb3IgYSBwcm9taXNlIGNvbnRhaW5pbmcgdGhlIGBjb25maWdgIG9yIGEgbmV3IGBjb25maWdgIG9iamVjdC4KICAgICAqICAgKiBgcmVxdWVzdEVycm9yYDogaW50ZXJjZXB0b3IgZ2V0cyBjYWxsZWQgd2hlbiBhIHByZXZpb3VzIGludGVyY2VwdG9yIHRocmV3IGFuIGVycm9yIG9yCiAgICAgKiAgICAgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbi4KICAgICAqICAgKiBgcmVzcG9uc2VgOiBpbnRlcmNlcHRvcnMgZ2V0IGNhbGxlZCB3aXRoIGh0dHAgYHJlc3BvbnNlYCBvYmplY3QuIFRoZSBmdW5jdGlvbiBpcyBmcmVlIHRvCiAgICAgKiAgICAgbW9kaWZ5IHRoZSBgcmVzcG9uc2VgIG9iamVjdCBvciBjcmVhdGUgYSBuZXcgb25lLiBUaGUgZnVuY3Rpb24gbmVlZHMgdG8gcmV0dXJuIHRoZSBgcmVzcG9uc2VgCiAgICAgKiAgICAgb2JqZWN0IGRpcmVjdGx5LCBvciBhcyBhIHByb21pc2UgY29udGFpbmluZyB0aGUgYHJlc3BvbnNlYCBvciBhIG5ldyBgcmVzcG9uc2VgIG9iamVjdC4KICAgICAqICAgKiBgcmVzcG9uc2VFcnJvcmA6IGludGVyY2VwdG9yIGdldHMgY2FsbGVkIHdoZW4gYSBwcmV2aW91cyBpbnRlcmNlcHRvciB0aHJldyBhbiBlcnJvciBvcgogICAgICogICAgIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24uCiAgICAgKgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciBhcyBhIHNlcnZpY2UKICAgICAqICAgJHByb3ZpZGUuZmFjdG9yeSgnbXlIdHRwSW50ZXJjZXB0b3InLCBmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIHsKICAgICAqICAgICAgIC8vIG9wdGlvbmFsIG1ldGhvZAogICAgICogICAgICAgJ3JlcXVlc3QnOiBmdW5jdGlvbihjb25maWcpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIHN1Y2Nlc3MKICAgICAqICAgICAgICAgcmV0dXJuIGNvbmZpZzsKICAgICAqICAgICAgIH0sCiAgICAgKgogICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgKiAgICAgICdyZXF1ZXN0RXJyb3InOiBmdW5jdGlvbihyZWplY3Rpb24pIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlamVjdGlvbikpIHsKICAgICAqICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VPck5ld1Byb21pc2UKICAgICAqICAgICAgICAgfQogICAgICogICAgICAgICByZXR1cm4gJHEucmVqZWN0KHJlamVjdGlvbik7CiAgICAgKiAgICAgICB9LAogICAgICoKICAgICAqCiAgICAgKgogICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgKiAgICAgICAncmVzcG9uc2UnOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICogICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgKiAgICAgICB9LAogICAgICoKICAgICAqICAgICAgIC8vIG9wdGlvbmFsIG1ldGhvZAogICAgICogICAgICAncmVzcG9uc2VFcnJvcic6IGZ1bmN0aW9uKHJlamVjdGlvbikgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVqZWN0aW9uKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVqZWN0aW9uKTsKICAgICAqICAgICAgIH0KICAgICAqICAgICB9OwogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgICRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzLnB1c2goJ215SHR0cEludGVyY2VwdG9yJyk7CiAgICAgKgogICAgICoKICAgICAqICAgLy8gYWx0ZXJuYXRpdmVseSwgcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIHZpYSBhbiBhbm9ueW1vdXMgZmFjdG9yeQogICAgICogICAkaHR0cFByb3ZpZGVyLmludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gewogICAgICogICAgICAncmVxdWVzdCc6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICogICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgICAgfSwKICAgICAqCiAgICAgKiAgICAgICAncmVzcG9uc2UnOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgICAgfQogICAgICogICAgIH07CiAgICAgKiAgIH0pOwogICAgICogYGBgCiAgICAgKgogICAgICogIyBSZXNwb25zZSBpbnRlcmNlcHRvcnMgKERFUFJFQ0FURUQpCiAgICAgKgogICAgICogQmVmb3JlIHlvdSBzdGFydCBjcmVhdGluZyBpbnRlcmNlcHRvcnMsIGJlIHN1cmUgdG8gdW5kZXJzdGFuZCB0aGUKICAgICAqIHtAbGluayBuZy4kcSAkcSBhbmQgZGVmZXJyZWQvcHJvbWlzZSBBUElzfS4KICAgICAqCiAgICAgKiBGb3IgcHVycG9zZXMgb2YgZ2xvYmFsIGVycm9yIGhhbmRsaW5nLCBhdXRoZW50aWNhdGlvbiBvciBhbnkga2luZCBvZiBzeW5jaHJvbm91cyBvcgogICAgICogYXN5bmNocm9ub3VzIHByZXByb2Nlc3Npbmcgb2YgcmVjZWl2ZWQgcmVzcG9uc2VzLCBpdCBpcyBkZXNpcmFibGUgdG8gYmUgYWJsZSB0byBpbnRlcmNlcHQKICAgICAqIHJlc3BvbnNlcyBmb3IgaHR0cCByZXF1ZXN0cyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIG92ZXIgdG8gdGhlIGFwcGxpY2F0aW9uIGNvZGUgdGhhdAogICAgICogaW5pdGlhdGVkIHRoZXNlIHJlcXVlc3RzLiBUaGUgcmVzcG9uc2UgaW50ZXJjZXB0b3JzIGxldmVyYWdlIHRoZSB7QGxpbmsgbmcuJHEKICAgICAqIHByb21pc2UgYXBpc30gdG8gZnVsZmlsIHRoaXMgbmVlZCBmb3IgYm90aCBzeW5jaHJvbm91cyBhbmQgYXN5bmNocm9ub3VzIHByZXByb2Nlc3NpbmcuCiAgICAgKgogICAgICogVGhlIGludGVyY2VwdG9ycyBhcmUgc2VydmljZSBmYWN0b3JpZXMgdGhhdCBhcmUgcmVnaXN0ZXJlZCB3aXRoIHRoZSAkaHR0cFByb3ZpZGVyIGJ5CiAgICAgKiBhZGRpbmcgdGhlbSB0byB0aGUgYCRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnNgIGFycmF5LiBUaGUgZmFjdG9yeSBpcyBjYWxsZWQgYW5kCiAgICAgKiBpbmplY3RlZCB3aXRoIGRlcGVuZGVuY2llcyAoaWYgc3BlY2lmaWVkKSBhbmQgcmV0dXJucyB0aGUgaW50ZXJjZXB0b3IgIOKAlCBhIGZ1bmN0aW9uIHRoYXQKICAgICAqIHRha2VzIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IGFuZCByZXR1cm5zIHRoZSBvcmlnaW5hbCBvciBhIG5ldyBwcm9taXNlLgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciBhcyBhIHNlcnZpY2UKICAgICAqICAgJHByb3ZpZGUuZmFjdG9yeSgnbXlIdHRwSW50ZXJjZXB0b3InLCBmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIHN1Y2Nlc3MKICAgICAqICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICogICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlc3BvbnNlKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVzcG9uc2UpOwogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAqCiAgICAgKgogICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaChmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICogYGBgCiAgICAgKgogICAgICoKICAgICAqICMgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMKICAgICAqCiAgICAgKiBXaGVuIGRlc2lnbmluZyB3ZWIgYXBwbGljYXRpb25zLCBjb25zaWRlciBzZWN1cml0eSB0aHJlYXRzIGZyb206CiAgICAgKgogICAgICogLSBbSlNPTiB2dWxuZXJhYmlsaXR5XShodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgpCiAgICAgKiAtIFtYU1JGXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Nyb3NzLXNpdGVfcmVxdWVzdF9mb3JnZXJ5KQogICAgICoKICAgICAqIEJvdGggc2VydmVyIGFuZCB0aGUgY2xpZW50IG11c3QgY29vcGVyYXRlIGluIG9yZGVyIHRvIGVsaW1pbmF0ZSB0aGVzZSB0aHJlYXRzLiBBbmd1bGFyIGNvbWVzCiAgICAgKiBwcmUtY29uZmlndXJlZCB3aXRoIHN0cmF0ZWdpZXMgdGhhdCBhZGRyZXNzIHRoZXNlIGlzc3VlcywgYnV0IGZvciB0aGlzIHRvIHdvcmsgYmFja2VuZCBzZXJ2ZXIKICAgICAqIGNvb3BlcmF0aW9uIGlzIHJlcXVpcmVkLgogICAgICoKICAgICAqICMjIEpTT04gVnVsbmVyYWJpbGl0eSBQcm90ZWN0aW9uCiAgICAgKgogICAgICogQSBbSlNPTiB2dWxuZXJhYmlsaXR5XShodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgpCiAgICAgKiBhbGxvd3MgdGhpcmQgcGFydHkgd2Vic2l0ZSB0byB0dXJuIHlvdXIgSlNPTiByZXNvdXJjZSBVUkwgaW50bwogICAgICogW0pTT05QXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT05QKSByZXF1ZXN0IHVuZGVyIHNvbWUgY29uZGl0aW9ucy4gVG8KICAgICAqIGNvdW50ZXIgdGhpcyB5b3VyIHNlcnZlciBjYW4gcHJlZml4IGFsbCBKU09OIHJlcXVlc3RzIHdpdGggZm9sbG93aW5nIHN0cmluZyBgIildfScsXG4iYC4KICAgICAqIEFuZ3VsYXIgd2lsbCBhdXRvbWF0aWNhbGx5IHN0cmlwIHRoZSBwcmVmaXggYmVmb3JlIHByb2Nlc3NpbmcgaXQgYXMgSlNPTi4KICAgICAqCiAgICAgKiBGb3IgZXhhbXBsZSBpZiB5b3VyIHNlcnZlciBuZWVkcyB0byByZXR1cm46CiAgICAgKiBgYGBqcwogICAgICogWydvbmUnLCd0d28nXQogICAgICogYGBgCiAgICAgKgogICAgICogd2hpY2ggaXMgdnVsbmVyYWJsZSB0byBhdHRhY2ssIHlvdXIgc2VydmVyIGNhbiByZXR1cm46CiAgICAgKiBgYGBqcwogICAgICogKV19JywKICAgICAqIFsnb25lJywndHdvJ10KICAgICAqIGBgYAogICAgICoKICAgICAqIEFuZ3VsYXIgd2lsbCBzdHJpcCB0aGUgcHJlZml4LCBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgSlNPTi4KICAgICAqCiAgICAgKgogICAgICogIyMgQ3Jvc3MgU2l0ZSBSZXF1ZXN0IEZvcmdlcnkgKFhTUkYpIFByb3RlY3Rpb24KICAgICAqCiAgICAgKiBbWFNSRl0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSkgaXMgYSB0ZWNobmlxdWUgYnkgd2hpY2gKICAgICAqIGFuIHVuYXV0aG9yaXplZCBzaXRlIGNhbiBnYWluIHlvdXIgdXNlcidzIHByaXZhdGUgZGF0YS4gQW5ndWxhciBwcm92aWRlcyBhIG1lY2hhbmlzbQogICAgICogdG8gY291bnRlciBYU1JGLiBXaGVuIHBlcmZvcm1pbmcgWEhSIHJlcXVlc3RzLCB0aGUgJGh0dHAgc2VydmljZSByZWFkcyBhIHRva2VuIGZyb20gYSBjb29raWUKICAgICAqIChieSBkZWZhdWx0LCBgWFNSRi1UT0tFTmApIGFuZCBzZXRzIGl0IGFzIGFuIEhUVFAgaGVhZGVyIChgWC1YU1JGLVRPS0VOYCkuIFNpbmNlIG9ubHkKICAgICAqIEphdmFTY3JpcHQgdGhhdCBydW5zIG9uIHlvdXIgZG9tYWluIGNvdWxkIHJlYWQgdGhlIGNvb2tpZSwgeW91ciBzZXJ2ZXIgY2FuIGJlIGFzc3VyZWQgdGhhdAogICAgICogdGhlIFhIUiBjYW1lIGZyb20gSmF2YVNjcmlwdCBydW5uaW5nIG9uIHlvdXIgZG9tYWluLiBUaGUgaGVhZGVyIHdpbGwgbm90IGJlIHNldCBmb3IKICAgICAqIGNyb3NzLWRvbWFpbiByZXF1ZXN0cy4KICAgICAqCiAgICAgKiBUbyB0YWtlIGFkdmFudGFnZSBvZiB0aGlzLCB5b3VyIHNlcnZlciBuZWVkcyB0byBzZXQgYSB0b2tlbiBpbiBhIEphdmFTY3JpcHQgcmVhZGFibGUgc2Vzc2lvbgogICAgICogY29va2llIGNhbGxlZCBgWFNSRi1UT0tFTmAgb24gdGhlIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgWEhSIHJlcXVlc3RzIHRoZQogICAgICogc2VydmVyIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZQogICAgICogdGhhdCBvbmx5IEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbiBjb3VsZCBoYXZlIHNlbnQgdGhlIHJlcXVlc3QuIFRoZSB0b2tlbiBtdXN0IGJlCiAgICAgKiB1bmlxdWUgZm9yIGVhY2ggdXNlciBhbmQgbXVzdCBiZSB2ZXJpZmlhYmxlIGJ5IHRoZSBzZXJ2ZXIgKHRvIHByZXZlbnQgdGhlIEphdmFTY3JpcHQgZnJvbQogICAgICogbWFraW5nIHVwIGl0cyBvd24gdG9rZW5zKS4gV2UgcmVjb21tZW5kIHRoYXQgdGhlIHRva2VuIGlzIGEgZGlnZXN0IG9mIHlvdXIgc2l0ZSdzCiAgICAgKiBhdXRoZW50aWNhdGlvbiBjb29raWUgd2l0aCBhIFtzYWx0XShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TYWx0XyhjcnlwdG9ncmFwaHkpKQogICAgICogZm9yIGFkZGVkIHNlY3VyaXR5LgogICAgICoKICAgICAqIFRoZSBuYW1lIG9mIHRoZSBoZWFkZXJzIGNhbiBiZSBzcGVjaWZpZWQgdXNpbmcgdGhlIHhzcmZIZWFkZXJOYW1lIGFuZCB4c3JmQ29va2llTmFtZQogICAgICogcHJvcGVydGllcyBvZiBlaXRoZXIgJGh0dHBQcm92aWRlci5kZWZhdWx0cyBhdCBjb25maWctdGltZSwgJGh0dHAuZGVmYXVsdHMgYXQgcnVuLXRpbWUsCiAgICAgKiBvciB0aGUgcGVyLXJlcXVlc3QgY29uZmlnIG9iamVjdC4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyBPYmplY3QgZGVzY3JpYmluZyB0aGUgcmVxdWVzdCB0byBiZSBtYWRlIGFuZCBob3cgaXQgc2hvdWxkIGJlCiAgICAgKiAgICBwcm9jZXNzZWQuIFRoZSBvYmplY3QgaGFzIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICoKICAgICAqICAgIC0gKiptZXRob2QqKiDigJMgYHtzdHJpbmd9YCDigJMgSFRUUCBtZXRob2QgKGUuZy4gJ0dFVCcsICdQT1NUJywgZXRjKQogICAgICogICAgLSAqKnVybCoqIOKAkyBge3N0cmluZ31gIOKAkyBBYnNvbHV0ZSBvciByZWxhdGl2ZSBVUkwgb2YgdGhlIHJlc291cmNlIHRoYXQgaXMgYmVpbmcgcmVxdWVzdGVkLgogICAgICogICAgLSAqKnBhcmFtcyoqIOKAkyBge09iamVjdC48c3RyaW5nfE9iamVjdD59YCDigJMgTWFwIG9mIHN0cmluZ3Mgb3Igb2JqZWN0cyB3aGljaCB3aWxsIGJlIHR1cm5lZAogICAgICogICAgICB0byBgP2tleTE9dmFsdWUxJmtleTI9dmFsdWUyYCBhZnRlciB0aGUgdXJsLiBJZiB0aGUgdmFsdWUgaXMgbm90IGEgc3RyaW5nLCBpdCB3aWxsIGJlCiAgICAgKiAgICAgIEpTT05pZmllZC4KICAgICAqICAgIC0gKipkYXRhKiog4oCTIGB7c3RyaW5nfE9iamVjdH1gIOKAkyBEYXRhIHRvIGJlIHNlbnQgYXMgdGhlIHJlcXVlc3QgbWVzc2FnZSBkYXRhLgogICAgICogICAgLSAqKmhlYWRlcnMqKiDigJMgYHtPYmplY3R9YCDigJMgTWFwIG9mIHN0cmluZ3Mgb3IgZnVuY3Rpb25zIHdoaWNoIHJldHVybiBzdHJpbmdzIHJlcHJlc2VudGluZwogICAgICogICAgICBIVFRQIGhlYWRlcnMgdG8gc2VuZCB0byB0aGUgc2VydmVyLiBJZiB0aGUgcmV0dXJuIHZhbHVlIG9mIGEgZnVuY3Rpb24gaXMgbnVsbCwgdGhlCiAgICAgKiAgICAgIGhlYWRlciB3aWxsIG5vdCBiZSBzZW50LgogICAgICogICAgLSAqKnhzcmZIZWFkZXJOYW1lKiog4oCTIGB7c3RyaW5nfWAg4oCTIE5hbWUgb2YgSFRUUCBoZWFkZXIgdG8gcG9wdWxhdGUgd2l0aCB0aGUgWFNSRiB0b2tlbi4KICAgICAqICAgIC0gKip4c3JmQ29va2llTmFtZSoqIOKAkyBge3N0cmluZ31gIOKAkyBOYW1lIG9mIGNvb2tpZSBjb250YWluaW5nIHRoZSBYU1JGIHRva2VuLgogICAgICogICAgLSAqKnRyYW5zZm9ybVJlcXVlc3QqKiDigJMKICAgICAqICAgICAgYHtmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKXxBcnJheS48ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcik+fWAg4oCTCiAgICAgKiAgICAgIHRyYW5zZm9ybSBmdW5jdGlvbiBvciBhbiBhcnJheSBvZiBzdWNoIGZ1bmN0aW9ucy4gVGhlIHRyYW5zZm9ybSBmdW5jdGlvbiB0YWtlcyB0aGUgaHR0cAogICAgICogICAgICByZXF1ZXN0IGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgc2VyaWFsaXplZCkgdmVyc2lvbi4KICAgICAqICAgIC0gKip0cmFuc2Zvcm1SZXNwb25zZSoqIOKAkwogICAgICogICAgICBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgKiAgICAgIHJlc3BvbnNlIGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgZGVzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICogICAgLSAqKmNhY2hlKiog4oCTIGB7Ym9vbGVhbnxDYWNoZX1gIOKAkyBJZiB0cnVlLCBhIGRlZmF1bHQgJGh0dHAgY2FjaGUgd2lsbCBiZSB1c2VkIHRvIGNhY2hlIHRoZQogICAgICogICAgICBHRVQgcmVxdWVzdCwgb3RoZXJ3aXNlIGlmIGEgY2FjaGUgaW5zdGFuY2UgYnVpbHQgd2l0aAogICAgICogICAgICB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSwgdGhpcyBjYWNoZSB3aWxsIGJlIHVzZWQgZm9yCiAgICAgKiAgICAgIGNhY2hpbmcuCiAgICAgKiAgICAtICoqdGltZW91dCoqIOKAkyBge251bWJlcnxQcm9taXNlfWAg4oCTIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzLCBvciB7QGxpbmsgbmcuJHEgcHJvbWlzZX0KICAgICAqICAgICAgdGhhdCBzaG91bGQgYWJvcnQgdGhlIHJlcXVlc3Qgd2hlbiByZXNvbHZlZC4KICAgICAqICAgIC0gKip3aXRoQ3JlZGVudGlhbHMqKiAtIGB7Ym9vbGVhbn1gIC0gd2hldGhlciB0byBzZXQgdGhlIGB3aXRoQ3JlZGVudGlhbHNgIGZsYWcgb24gdGhlCiAgICAgKiAgICAgIFhIUiBvYmplY3QuIFNlZSBbcmVxdWVzdHMgd2l0aCBjcmVkZW50aWFsc11odHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9odHRwX2FjY2Vzc19jb250cm9sI3NlY3Rpb25fNQogICAgICogICAgICBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqICAgIC0gKipyZXNwb25zZVR5cGUqKiAtIGB7c3RyaW5nfWAgLSBzZWUKICAgICAqICAgICAgW3JlcXVlc3RUeXBlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS9YTUxIdHRwUmVxdWVzdCNyZXNwb25zZVR5cGUpLgogICAgICoKICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gUmV0dXJucyBhIHtAbGluayBuZy4kcSBwcm9taXNlfSBvYmplY3Qgd2l0aCB0aGUKICAgICAqICAgc3RhbmRhcmQgYHRoZW5gIG1ldGhvZCBhbmQgdHdvIGh0dHAgc3BlY2lmaWMgbWV0aG9kczogYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgLiBUaGUgYHRoZW5gCiAgICAgKiAgIG1ldGhvZCB0YWtlcyB0d28gYXJndW1lbnRzIGEgc3VjY2VzcyBhbmQgYW4gZXJyb3IgY2FsbGJhY2sgd2hpY2ggd2lsbCBiZSBjYWxsZWQgd2l0aCBhCiAgICAgKiAgIHJlc3BvbnNlIG9iamVjdC4gVGhlIGBzdWNjZXNzYCBhbmQgYGVycm9yYCBtZXRob2RzIHRha2UgYSBzaW5nbGUgYXJndW1lbnQgLSBhIGZ1bmN0aW9uIHRoYXQKICAgICAqICAgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgcmVxdWVzdCBzdWNjZWVkcyBvciBmYWlscyByZXNwZWN0aXZlbHkuIFRoZSBhcmd1bWVudHMgcGFzc2VkIGludG8KICAgICAqICAgdGhlc2UgZnVuY3Rpb25zIGFyZSBkZXN0cnVjdHVyZWQgcmVwcmVzZW50YXRpb24gb2YgdGhlIHJlc3BvbnNlIG9iamVjdCBwYXNzZWQgaW50byB0aGUKICAgICAqICAgYHRoZW5gIG1ldGhvZC4gVGhlIHJlc3BvbnNlIG9iamVjdCBoYXMgdGhlc2UgcHJvcGVydGllczoKICAgICAqCiAgICAgKiAgIC0gKipkYXRhKiog4oCTIGB7c3RyaW5nfE9iamVjdH1gIOKAkyBUaGUgcmVzcG9uc2UgYm9keSB0cmFuc2Zvcm1lZCB3aXRoIHRoZSB0cmFuc2Zvcm0KICAgICAqICAgICBmdW5jdGlvbnMuCiAgICAgKiAgIC0gKipzdGF0dXMqKiDigJMgYHtudW1iZXJ9YCDigJMgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgKiAgIC0gKipoZWFkZXJzKiog4oCTIGB7ZnVuY3Rpb24oW2hlYWRlck5hbWVdKX1gIOKAkyBIZWFkZXIgZ2V0dGVyIGZ1bmN0aW9uLgogICAgICogICAtICoqY29uZmlnKiog4oCTIGB7T2JqZWN0fWAg4oCTIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdCB0aGF0IHdhcyB1c2VkIHRvIGdlbmVyYXRlIHRoZSByZXF1ZXN0LgogICAgICogICAtICoqc3RhdHVzVGV4dCoqIOKAkyBge3N0cmluZ31gIOKAkyBIVFRQIHN0YXR1cyB0ZXh0IG9mIHRoZSByZXNwb25zZS4KICAgICAqCiAgICAgKiBAcHJvcGVydHkge0FycmF5LjxPYmplY3Q+fSBwZW5kaW5nUmVxdWVzdHMgQXJyYXkgb2YgY29uZmlnIG9iamVjdHMgZm9yIGN1cnJlbnRseSBwZW5kaW5nCiAgICAgKiAgIHJlcXVlc3RzLiBUaGlzIGlzIHByaW1hcmlseSBtZWFudCB0byBiZSB1c2VkIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMuCiAgICAgKgogICAgICoKICAgICAqIEBleGFtcGxlCjxleGFtcGxlPgo8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkZldGNoQ3RybCI+CiAgICA8c2VsZWN0IG5nLW1vZGVsPSJtZXRob2QiPgogICAgICA8b3B0aW9uPkdFVDwvb3B0aW9uPgogICAgICA8b3B0aW9uPkpTT05QPC9vcHRpb24+CiAgICA8L3NlbGVjdD4KICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXJsIiBzaXplPSI4MCIvPgogICAgPGJ1dHRvbiBpZD0iZmV0Y2hidG4iIG5nLWNsaWNrPSJmZXRjaCgpIj5mZXRjaDwvYnV0dG9uPjxicj4KICAgIDxidXR0b24gaWQ9InNhbXBsZWdldGJ0biIgbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaHR0cC1oZWxsby5odG1sJykiPlNhbXBsZSBHRVQ8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9InNhbXBsZWpzb25wYnRuIgogICAgICBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywKICAgICAgICAgICAgICAgICAgICAnaHR0cHM6Ly9hbmd1bGFyanMub3JnL2dyZWV0LnBocD9jYWxsYmFjaz1KU09OX0NBTExCQUNLJm5hbWU9U3VwZXIlMjBIZXJvJykiPgogICAgICBTYW1wbGUgSlNPTlAKICAgIDwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0iaW52YWxpZGpzb25wYnRuIgogICAgICBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHBzOi8vYW5ndWxhcmpzLm9yZy9kb2VzbnRleGlzdCZjYWxsYmFjaz1KU09OX0NBTExCQUNLJykiPgogICAgICAgIEludmFsaWQgSlNPTlAKICAgICAgPC9idXR0b24+CiAgICA8cHJlPmh0dHAgc3RhdHVzIGNvZGU6IHt7c3RhdHVzfX08L3ByZT4KICAgIDxwcmU+aHR0cCByZXNwb25zZSBkYXRhOiB7e2RhdGF9fTwvcHJlPgogIDwvZGl2Pgo8L2ZpbGU+CjxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgZnVuY3Rpb24gRmV0Y2hDdHJsKCRzY29wZSwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAkc2NvcGUubWV0aG9kID0gJ0dFVCc7CiAgICAkc2NvcGUudXJsID0gJ2h0dHAtaGVsbG8uaHRtbCc7CgogICAgJHNjb3BlLmZldGNoID0gZnVuY3Rpb24oKSB7CiAgICAgICRzY29wZS5jb2RlID0gbnVsbDsKICAgICAgJHNjb3BlLnJlc3BvbnNlID0gbnVsbDsKCiAgICAgICRodHRwKHttZXRob2Q6ICRzY29wZS5tZXRob2QsIHVybDogJHNjb3BlLnVybCwgY2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgc3VjY2VzcyhmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGE7CiAgICAgICAgfSkuCiAgICAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGEgfHwgIlJlcXVlc3QgZmFpbGVkIjsKICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgIH0pOwogICAgfTsKCiAgICAkc2NvcGUudXBkYXRlTW9kZWwgPSBmdW5jdGlvbihtZXRob2QsIHVybCkgewogICAgICAkc2NvcGUubWV0aG9kID0gbWV0aG9kOwogICAgICAkc2NvcGUudXJsID0gdXJsOwogICAgfTsKICB9CjwvZmlsZT4KPGZpbGUgbmFtZT0iaHR0cC1oZWxsby5odG1sIj4KICBIZWxsbywgJGh0dHAhCjwvZmlsZT4KPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgdmFyIHN0YXR1cyA9IGVsZW1lbnQoYnkuYmluZGluZygnc3RhdHVzJykpOwogIHZhciBkYXRhID0gZWxlbWVudChieS5iaW5kaW5nKCdkYXRhJykpOwogIHZhciBmZXRjaEJ0biA9IGVsZW1lbnQoYnkuaWQoJ2ZldGNoYnRuJykpOwogIHZhciBzYW1wbGVHZXRCdG4gPSBlbGVtZW50KGJ5LmlkKCdzYW1wbGVnZXRidG4nKSk7CiAgdmFyIHNhbXBsZUpzb25wQnRuID0gZWxlbWVudChieS5pZCgnc2FtcGxlanNvbnBidG4nKSk7CiAgdmFyIGludmFsaWRKc29ucEJ0biA9IGVsZW1lbnQoYnkuaWQoJ2ludmFsaWRqc29ucGJ0bicpKTsKCiAgaXQoJ3Nob3VsZCBtYWtlIGFuIHhociBHRVQgcmVxdWVzdCcsIGZ1bmN0aW9uKCkgewogICAgc2FtcGxlR2V0QnRuLmNsaWNrKCk7CiAgICBmZXRjaEJ0bi5jbGljaygpOwogICAgZXhwZWN0KHN0YXR1cy5nZXRUZXh0KCkpLnRvTWF0Y2goJzIwMCcpOwogICAgZXhwZWN0KGRhdGEuZ2V0VGV4dCgpKS50b01hdGNoKC9IZWxsbywgXCRodHRwIS8pOwogIH0pOwoKICBpdCgnc2hvdWxkIG1ha2UgYSBKU09OUCByZXF1ZXN0IHRvIGFuZ3VsYXJqcy5vcmcnLCBmdW5jdGlvbigpIHsKICAgIHNhbXBsZUpzb25wQnRuLmNsaWNrKCk7CiAgICBmZXRjaEJ0bi5jbGljaygpOwogICAgZXhwZWN0KHN0YXR1cy5nZXRUZXh0KCkpLnRvTWF0Y2goJzIwMCcpOwogICAgZXhwZWN0KGRhdGEuZ2V0VGV4dCgpKS50b01hdGNoKC9TdXBlciBIZXJvIS8pOwogIH0pOwoKICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byBpbnZhbGlkIFVSTCBhbmQgaW52b2tlIHRoZSBlcnJvciBoYW5kbGVyJywKICAgICAgZnVuY3Rpb24oKSB7CiAgICBpbnZhbGlkSnNvbnBCdG4uY2xpY2soKTsKICAgIGZldGNoQnRuLmNsaWNrKCk7CiAgICBleHBlY3Qoc3RhdHVzLmdldFRleHQoKSkudG9NYXRjaCgnMCcpOwogICAgZXhwZWN0KGRhdGEuZ2V0VGV4dCgpKS50b01hdGNoKCdSZXF1ZXN0IGZhaWxlZCcpOwogIH0pOwo8L2ZpbGU+CjwvZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gJGh0dHAocmVxdWVzdENvbmZpZykgewogICAgICB2YXIgY29uZmlnID0gewogICAgICAgIG1ldGhvZDogJ2dldCcsCiAgICAgICAgdHJhbnNmb3JtUmVxdWVzdDogZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdCwKICAgICAgICB0cmFuc2Zvcm1SZXNwb25zZTogZGVmYXVsdHMudHJhbnNmb3JtUmVzcG9uc2UKICAgICAgfTsKICAgICAgdmFyIGhlYWRlcnMgPSBtZXJnZUhlYWRlcnMocmVxdWVzdENvbmZpZyk7CgogICAgICBleHRlbmQoY29uZmlnLCByZXF1ZXN0Q29uZmlnKTsKICAgICAgY29uZmlnLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgICBjb25maWcubWV0aG9kID0gdXBwZXJjYXNlKGNvbmZpZy5tZXRob2QpOwoKICAgICAgdmFyIHhzcmZWYWx1ZSA9IHVybElzU2FtZU9yaWdpbihjb25maWcudXJsKQogICAgICAgICAgPyAkYnJvd3Nlci5jb29raWVzKClbY29uZmlnLnhzcmZDb29raWVOYW1lIHx8IGRlZmF1bHRzLnhzcmZDb29raWVOYW1lXQogICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgIGlmICh4c3JmVmFsdWUpIHsKICAgICAgICBoZWFkZXJzWyhjb25maWcueHNyZkhlYWRlck5hbWUgfHwgZGVmYXVsdHMueHNyZkhlYWRlck5hbWUpXSA9IHhzcmZWYWx1ZTsKICAgICAgfQoKCiAgICAgIHZhciBzZXJ2ZXJSZXF1ZXN0ID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzOwogICAgICAgIHZhciByZXFEYXRhID0gdHJhbnNmb3JtRGF0YShjb25maWcuZGF0YSwgaGVhZGVyc0dldHRlcihoZWFkZXJzKSwgY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QpOwoKICAgICAgICAvLyBzdHJpcCBjb250ZW50LXR5cGUgaWYgZGF0YSBpcyB1bmRlZmluZWQKICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLmRhdGEpKSB7CiAgICAgICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uKHZhbHVlLCBoZWFkZXIpIHsKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShoZWFkZXIpID09PSAnY29udGVudC10eXBlJykgewogICAgICAgICAgICAgICAgZGVsZXRlIGhlYWRlcnNbaGVhZGVyXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLndpdGhDcmVkZW50aWFscykgJiYgIWlzVW5kZWZpbmVkKGRlZmF1bHRzLndpdGhDcmVkZW50aWFscykpIHsKICAgICAgICAgIGNvbmZpZy53aXRoQ3JlZGVudGlhbHMgPSBkZWZhdWx0cy53aXRoQ3JlZGVudGlhbHM7CiAgICAgICAgfQoKICAgICAgICAvLyBzZW5kIHJlcXVlc3QKICAgICAgICByZXR1cm4gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIGhlYWRlcnMpLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UsIHRyYW5zZm9ybVJlc3BvbnNlKTsKICAgICAgfTsKCiAgICAgIHZhciBjaGFpbiA9IFtzZXJ2ZXJSZXF1ZXN0LCB1bmRlZmluZWRdOwogICAgICB2YXIgcHJvbWlzZSA9ICRxLndoZW4oY29uZmlnKTsKCiAgICAgIC8vIGFwcGx5IGludGVyY2VwdG9ycwogICAgICBmb3JFYWNoKHJldmVyc2VkSW50ZXJjZXB0b3JzLCBmdW5jdGlvbihpbnRlcmNlcHRvcikgewogICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXF1ZXN0IHx8IGludGVyY2VwdG9yLnJlcXVlc3RFcnJvcikgewogICAgICAgICAgY2hhaW4udW5zaGlmdChpbnRlcmNlcHRvci5yZXF1ZXN0LCBpbnRlcmNlcHRvci5yZXF1ZXN0RXJyb3IpOwogICAgICAgIH0KICAgICAgICBpZiAoaW50ZXJjZXB0b3IucmVzcG9uc2UgfHwgaW50ZXJjZXB0b3IucmVzcG9uc2VFcnJvcikgewogICAgICAgICAgY2hhaW4ucHVzaChpbnRlcmNlcHRvci5yZXNwb25zZSwgaW50ZXJjZXB0b3IucmVzcG9uc2VFcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHdoaWxlKGNoYWluLmxlbmd0aCkgewogICAgICAgIHZhciB0aGVuRm4gPSBjaGFpbi5zaGlmdCgpOwogICAgICAgIHZhciByZWplY3RGbiA9IGNoYWluLnNoaWZ0KCk7CgogICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4odGhlbkZuLCByZWplY3RGbik7CiAgICAgIH0KCiAgICAgIHByb21pc2Uuc3VjY2VzcyA9IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgIH07CgogICAgICBwcm9taXNlLmVycm9yID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgfTsKCiAgICAgIHJldHVybiBwcm9taXNlOwoKICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtUmVzcG9uc2UocmVzcG9uc2UpIHsKICAgICAgICAvLyBtYWtlIGEgY29weSBzaW5jZSB0aGUgcmVzcG9uc2UgbXVzdCBiZSBjYWNoZWFibGUKICAgICAgICB2YXIgcmVzcCA9IGV4dGVuZCh7fSwgcmVzcG9uc2UsIHsKICAgICAgICAgIGRhdGE6IHRyYW5zZm9ybURhdGEocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnLnRyYW5zZm9ybVJlc3BvbnNlKQogICAgICAgIH0pOwogICAgICAgIHJldHVybiAoaXNTdWNjZXNzKHJlc3BvbnNlLnN0YXR1cykpCiAgICAgICAgICA/IHJlc3AKICAgICAgICAgIDogJHEucmVqZWN0KHJlc3ApOwogICAgICB9CgogICAgICBmdW5jdGlvbiBtZXJnZUhlYWRlcnMoY29uZmlnKSB7CiAgICAgICAgdmFyIGRlZkhlYWRlcnMgPSBkZWZhdWx0cy5oZWFkZXJzLAogICAgICAgICAgICByZXFIZWFkZXJzID0gZXh0ZW5kKHt9LCBjb25maWcuaGVhZGVycyksCiAgICAgICAgICAgIGRlZkhlYWRlck5hbWUsIGxvd2VyY2FzZURlZkhlYWRlck5hbWUsIHJlcUhlYWRlck5hbWU7CgogICAgICAgIGRlZkhlYWRlcnMgPSBleHRlbmQoe30sIGRlZkhlYWRlcnMuY29tbW9uLCBkZWZIZWFkZXJzW2xvd2VyY2FzZShjb25maWcubWV0aG9kKV0pOwoKICAgICAgICAvLyBleGVjdXRlIGlmIGhlYWRlciB2YWx1ZSBpcyBmdW5jdGlvbgogICAgICAgIGV4ZWNIZWFkZXJzKGRlZkhlYWRlcnMpOwogICAgICAgIGV4ZWNIZWFkZXJzKHJlcUhlYWRlcnMpOwoKICAgICAgICAvLyB1c2luZyBmb3ItaW4gaW5zdGVhZCBvZiBmb3JFYWNoIHRvIGF2b2lkIHVuZWNlc3NhcnkgaXRlcmF0aW9uIGFmdGVyIGhlYWRlciBoYXMgYmVlbiBmb3VuZAogICAgICAgIGRlZmF1bHRIZWFkZXJzSXRlcmF0aW9uOgogICAgICAgIGZvciAoZGVmSGVhZGVyTmFtZSBpbiBkZWZIZWFkZXJzKSB7CiAgICAgICAgICBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lID0gbG93ZXJjYXNlKGRlZkhlYWRlck5hbWUpOwoKICAgICAgICAgIGZvciAocmVxSGVhZGVyTmFtZSBpbiByZXFIZWFkZXJzKSB7CiAgICAgICAgICAgIGlmIChsb3dlcmNhc2UocmVxSGVhZGVyTmFtZSkgPT09IGxvd2VyY2FzZURlZkhlYWRlck5hbWUpIHsKICAgICAgICAgICAgICBjb250aW51ZSBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJlcUhlYWRlcnNbZGVmSGVhZGVyTmFtZV0gPSBkZWZIZWFkZXJzW2RlZkhlYWRlck5hbWVdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlcUhlYWRlcnM7CgogICAgICAgIGZ1bmN0aW9uIGV4ZWNIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgICAgIHZhciBoZWFkZXJDb250ZW50OwoKICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24oaGVhZGVyRm4sIGhlYWRlcikgewogICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihoZWFkZXJGbikpIHsKICAgICAgICAgICAgICBoZWFkZXJDb250ZW50ID0gaGVhZGVyRm4oKTsKICAgICAgICAgICAgICBpZiAoaGVhZGVyQ29udGVudCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJzW2hlYWRlcl0gPSBoZWFkZXJDb250ZW50OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzID0gW107CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaHR0cCNnZXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBHRVRgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGh0dHAjZGVsZXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgREVMRVRFYCByZXF1ZXN0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI2hlYWQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBIRUFEYCByZXF1ZXN0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI2pzb25wCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgSlNPTlBgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIFNob3VsZCBjb250YWluIGBKU09OX0NBTExCQUNLYCBzdHJpbmcuCiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgKi8KICAgIGNyZWF0ZVNob3J0TWV0aG9kcygnZ2V0JywgJ2RlbGV0ZScsICdoZWFkJywgJ2pzb25wJyk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaHR0cCNwb3N0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgUE9TVGAgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaHR0cCNwdXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQVVRgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwogICAgY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEoJ3Bvc3QnLCAncHV0Jyk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lICRodHRwI2RlZmF1bHRzCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSdW50aW1lIGVxdWl2YWxlbnQgb2YgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzYCBwcm9wZXJ0eS4gQWxsb3dzIGNvbmZpZ3VyYXRpb24gb2YKICAgICAgICAgKiBkZWZhdWx0IGhlYWRlcnMsIHdpdGhDcmVkZW50aWFscyBhcyB3ZWxsIGFzIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWF0aW9ucy4KICAgICAgICAgKgogICAgICAgICAqIFNlZSAiU2V0dGluZyBIVFRQIEhlYWRlcnMiIGFuZCAiVHJhbnNmb3JtaW5nIFJlcXVlc3RzIGFuZCBSZXNwb25zZXMiIHNlY3Rpb25zIGFib3ZlLgogICAgICAgICAqLwogICAgJGh0dHAuZGVmYXVsdHMgPSBkZWZhdWx0czsKCgogICAgcmV0dXJuICRodHRwOwoKCiAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHMobmFtZXMpIHsKICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAkaHR0cFtuYW1lXSA9IGZ1bmN0aW9uKHVybCwgY29uZmlnKSB7CiAgICAgICAgICByZXR1cm4gJGh0dHAoZXh0ZW5kKGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICBtZXRob2Q6IG5hbWUsCiAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAkaHR0cFtuYW1lXSA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgY29uZmlnKSB7CiAgICAgICAgICByZXR1cm4gJGh0dHAoZXh0ZW5kKGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICBtZXRob2Q6IG5hbWUsCiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9CgoKICAgIC8qKgogICAgICogTWFrZXMgdGhlIHJlcXVlc3QuCiAgICAgKgogICAgICogISEhIEFDQ0VTU0VTIENMT1NVUkUgVkFSUzoKICAgICAqICRodHRwQmFja2VuZCwgZGVmYXVsdHMsICRsb2csICRyb290U2NvcGUsIGRlZmF1bHRDYWNoZSwgJGh0dHAucGVuZGluZ1JlcXVlc3RzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNlbmRSZXEoY29uZmlnLCByZXFEYXRhLCByZXFIZWFkZXJzKSB7CiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgIGNhY2hlLAogICAgICAgICAgY2FjaGVkUmVzcCwKICAgICAgICAgIHVybCA9IGJ1aWxkVXJsKGNvbmZpZy51cmwsIGNvbmZpZy5wYXJhbXMpOwoKICAgICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzLnB1c2goY29uZmlnKTsKICAgICAgcHJvbWlzZS50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwoKCiAgICAgIGlmICgoY29uZmlnLmNhY2hlIHx8IGRlZmF1bHRzLmNhY2hlKSAmJiBjb25maWcuY2FjaGUgIT09IGZhbHNlICYmIGNvbmZpZy5tZXRob2QgPT0gJ0dFVCcpIHsKICAgICAgICBjYWNoZSA9IGlzT2JqZWN0KGNvbmZpZy5jYWNoZSkgPyBjb25maWcuY2FjaGUKICAgICAgICAgICAgICA6IGlzT2JqZWN0KGRlZmF1bHRzLmNhY2hlKSA/IGRlZmF1bHRzLmNhY2hlCiAgICAgICAgICAgICAgOiBkZWZhdWx0Q2FjaGU7CiAgICAgIH0KCiAgICAgIGlmIChjYWNoZSkgewogICAgICAgIGNhY2hlZFJlc3AgPSBjYWNoZS5nZXQodXJsKTsKICAgICAgICBpZiAoaXNEZWZpbmVkKGNhY2hlZFJlc3ApKSB7CiAgICAgICAgICBpZiAoY2FjaGVkUmVzcC50aGVuKSB7CiAgICAgICAgICAgIC8vIGNhY2hlZCByZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCwgYnV0IHRoZXJlIGlzIG5vIHJlc3BvbnNlIHlldAogICAgICAgICAgICBjYWNoZWRSZXNwLnRoZW4ocmVtb3ZlUGVuZGluZ1JlcSwgcmVtb3ZlUGVuZGluZ1JlcSk7CiAgICAgICAgICAgIHJldHVybiBjYWNoZWRSZXNwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gc2VydmluZyBmcm9tIGNhY2hlCiAgICAgICAgICAgIGlmIChpc0FycmF5KGNhY2hlZFJlc3ApKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcFsxXSwgY2FjaGVkUmVzcFswXSwgc2hhbGxvd0NvcHkoY2FjaGVkUmVzcFsyXSksIGNhY2hlZFJlc3BbM10pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKGNhY2hlZFJlc3AsIDIwMCwge30sICdPSycpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIHB1dCB0aGUgcHJvbWlzZSBmb3IgdGhlIG5vbi10cmFuc2Zvcm1lZCByZXNwb25zZSBpbnRvIGNhY2hlIGFzIGEgcGxhY2Vob2xkZXIKICAgICAgICAgIGNhY2hlLnB1dCh1cmwsIHByb21pc2UpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gaWYgd2Ugd29uJ3QgaGF2ZSB0aGUgcmVzcG9uc2UgaW4gY2FjaGUsIHNlbmQgdGhlIHJlcXVlc3QgdG8gdGhlIGJhY2tlbmQKICAgICAgaWYgKGlzVW5kZWZpbmVkKGNhY2hlZFJlc3ApKSB7CiAgICAgICAgJGh0dHBCYWNrZW5kKGNvbmZpZy5tZXRob2QsIHVybCwgcmVxRGF0YSwgZG9uZSwgcmVxSGVhZGVycywgY29uZmlnLnRpbWVvdXQsCiAgICAgICAgICAgIGNvbmZpZy53aXRoQ3JlZGVudGlhbHMsIGNvbmZpZy5yZXNwb25zZVR5cGUpOwogICAgICB9CgogICAgICByZXR1cm4gcHJvbWlzZTsKCgogICAgICAvKioKICAgICAgICogQ2FsbGJhY2sgcmVnaXN0ZXJlZCB0byAkaHR0cEJhY2tlbmQoKToKICAgICAgICogIC0gY2FjaGVzIHRoZSByZXNwb25zZSBpZiBkZXNpcmVkCiAgICAgICAqICAtIHJlc29sdmVzIHRoZSByYXcgJGh0dHAgcHJvbWlzZQogICAgICAgKiAgLSBjYWxscyAkYXBwbHkKICAgICAgICovCiAgICAgIGZ1bmN0aW9uIGRvbmUoc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCkgewogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgaWYgKGlzU3VjY2VzcyhzdGF0dXMpKSB7CiAgICAgICAgICAgIGNhY2hlLnB1dCh1cmwsIFtzdGF0dXMsIHJlc3BvbnNlLCBwYXJzZUhlYWRlcnMoaGVhZGVyc1N0cmluZyksIHN0YXR1c1RleHRdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHJlbW92ZSBwcm9taXNlIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAgIGNhY2hlLnJlbW92ZSh1cmwpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCk7CiAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgIH0KCgogICAgICAvKioKICAgICAgICogUmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlLgogICAgICAgKi8KICAgICAgZnVuY3Rpb24gcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycywgc3RhdHVzVGV4dCkgewogICAgICAgIC8vIG5vcm1hbGl6ZSBpbnRlcm5hbCBzdGF0dXNlcyB0byAwCiAgICAgICAgc3RhdHVzID0gTWF0aC5tYXgoc3RhdHVzLCAwKTsKCiAgICAgICAgKGlzU3VjY2VzcyhzdGF0dXMpID8gZGVmZXJyZWQucmVzb2x2ZSA6IGRlZmVycmVkLnJlamVjdCkoewogICAgICAgICAgZGF0YTogcmVzcG9uc2UsCiAgICAgICAgICBzdGF0dXM6IHN0YXR1cywKICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksCiAgICAgICAgICBjb25maWc6IGNvbmZpZywKICAgICAgICAgIHN0YXR1c1RleHQgOiBzdGF0dXNUZXh0CiAgICAgICAgfSk7CiAgICAgIH0KCgogICAgICBmdW5jdGlvbiByZW1vdmVQZW5kaW5nUmVxKCkgewogICAgICAgIHZhciBpZHggPSBpbmRleE9mKCRodHRwLnBlbmRpbmdSZXF1ZXN0cywgY29uZmlnKTsKICAgICAgICBpZiAoaWR4ICE9PSAtMSkgJGh0dHAucGVuZGluZ1JlcXVlc3RzLnNwbGljZShpZHgsIDEpOwogICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGJ1aWxkVXJsKHVybCwgcGFyYW1zKSB7CiAgICAgICAgICBpZiAoIXBhcmFtcykgcmV0dXJuIHVybDsKICAgICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgICAgZm9yRWFjaFNvcnRlZChwYXJhbXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB2YWx1ZSA9IFt2YWx1ZV07CgogICAgICAgICAgICBmb3JFYWNoKHZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KHYpKSB7CiAgICAgICAgICAgICAgICB2ID0gdG9Kc29uKHYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSkgKyAnPScgKwogICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlVXJpUXVlcnkodikpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYocGFydHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB1cmwgKz0gKCh1cmwuaW5kZXhPZignPycpID09IC0xKSA/ICc/JyA6ICcmJykgKyBwYXJ0cy5qb2luKCcmJyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgIH0KCgogIH1dOwp9CgpmdW5jdGlvbiBjcmVhdGVYaHIobWV0aG9kKSB7CiAgICAvL2lmIElFIGFuZCB0aGUgbWV0aG9kIGlzIG5vdCBSRkMyNjE2IGNvbXBsaWFudCwgb3IgaWYgWE1MSHR0cFJlcXVlc3QKICAgIC8vaXMgbm90IGF2YWlsYWJsZSwgdHJ5IGdldHRpbmcgYW4gQWN0aXZlWE9iamVjdC4gT3RoZXJ3aXNlLCB1c2UgWE1MSHR0cFJlcXVlc3QKICAgIC8vaWYgaXQgaXMgYXZhaWxhYmxlCiAgICBpZiAobXNpZSA8PSA4ICYmICghbWV0aG9kLm1hdGNoKC9eKGdldHxwb3N0fGhlYWR8cHV0fGRlbGV0ZXxvcHRpb25zKSQvaSkgfHwKICAgICAgIXdpbmRvdy5YTUxIdHRwUmVxdWVzdCkpIHsKICAgICAgcmV0dXJuIG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgIH0gZWxzZSBpZiAod2luZG93LlhNTEh0dHBSZXF1ZXN0KSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7CiAgICB9CgogICAgdGhyb3cgbWluRXJyKCckaHR0cEJhY2tlbmQnKSgnbm94aHInLCAiVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgWE1MSHR0cFJlcXVlc3QuIik7Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaHR0cEJhY2tlbmQKICogQHJlcXVpcmVzICR3aW5kb3cKICogQHJlcXVpcmVzICRkb2N1bWVudAogKgogKiBAZGVzY3JpcHRpb24KICogSFRUUCBiYWNrZW5kIHVzZWQgYnkgdGhlIHtAbGluayBuZy4kaHR0cCBzZXJ2aWNlfSB0aGF0IGRlbGVnYXRlcyB0bwogKiBYTUxIdHRwUmVxdWVzdCBvYmplY3Qgb3IgSlNPTlAgYW5kIGRlYWxzIHdpdGggYnJvd3NlciBpbmNvbXBhdGliaWxpdGllcy4KICoKICogWW91IHNob3VsZCBuZXZlciBuZWVkIHRvIHVzZSB0aGlzIHNlcnZpY2UgZGlyZWN0bHksIGluc3RlYWQgdXNlIHRoZSBoaWdoZXItbGV2ZWwgYWJzdHJhY3Rpb25zOgogKiB7QGxpbmsgbmcuJGh0dHAgJGh0dHB9IG9yIHtAbGluayBuZ1Jlc291cmNlLiRyZXNvdXJjZSAkcmVzb3VyY2V9LgogKgogKiBEdXJpbmcgdGVzdGluZyB0aGlzIGltcGxlbWVudGF0aW9uIGlzIHN3YXBwZWQgd2l0aCB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCBtb2NrCiAqICRodHRwQmFja2VuZH0gd2hpY2ggY2FuIGJlIHRyYWluZWQgd2l0aCByZXNwb25zZXMuCiAqLwpmdW5jdGlvbiAkSHR0cEJhY2tlbmRQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRicm93c2VyJywgJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJGJyb3dzZXIsICR3aW5kb3csICRkb2N1bWVudCkgewogICAgcmV0dXJuIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBjcmVhdGVYaHIsICRicm93c2VyLmRlZmVyLCAkd2luZG93LmFuZ3VsYXIuY2FsbGJhY2tzLCAkZG9jdW1lbnRbMF0pOwogIH1dOwp9CgpmdW5jdGlvbiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgY3JlYXRlWGhyLCAkYnJvd3NlckRlZmVyLCBjYWxsYmFja3MsIHJhd0RvY3VtZW50KSB7CiAgdmFyIEFCT1JURUQgPSAtMTsKCiAgLy8gVE9ETyh2b2p0YSk6IGZpeCB0aGUgc2lnbmF0dXJlCiAgcmV0dXJuIGZ1bmN0aW9uKG1ldGhvZCwgdXJsLCBwb3N0LCBjYWxsYmFjaywgaGVhZGVycywgdGltZW91dCwgd2l0aENyZWRlbnRpYWxzLCByZXNwb25zZVR5cGUpIHsKICAgIHZhciBzdGF0dXM7CiAgICAkYnJvd3Nlci4kJGluY091dHN0YW5kaW5nUmVxdWVzdENvdW50KCk7CiAgICB1cmwgPSB1cmwgfHwgJGJyb3dzZXIudXJsKCk7CgogICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29ucCcpIHsKICAgICAgdmFyIGNhbGxiYWNrSWQgPSAnXycgKyAoY2FsbGJhY2tzLmNvdW50ZXIrKykudG9TdHJpbmcoMzYpOwogICAgICBjYWxsYmFja3NbY2FsbGJhY2tJZF0gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEgPSBkYXRhOwogICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5jYWxsZWQgPSB0cnVlOwogICAgICB9OwoKICAgICAgdmFyIGpzb25wRG9uZSA9IGpzb25wUmVxKHVybC5yZXBsYWNlKCdKU09OX0NBTExCQUNLJywgJ2FuZ3VsYXIuY2FsbGJhY2tzLicgKyBjYWxsYmFja0lkKSwKICAgICAgICAgIGNhbGxiYWNrSWQsIGZ1bmN0aW9uKHN0YXR1cywgdGV4dCkgewogICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzLCBjYWxsYmFja3NbY2FsbGJhY2tJZF0uZGF0YSwgIiIsIHRleHQpOwogICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IG5vb3A7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKCiAgICAgIHZhciB4aHIgPSBjcmVhdGVYaHIobWV0aG9kKTsKCiAgICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgICAgZm9yRWFjaChoZWFkZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIEluIElFNiBhbmQgNywgdGhpcyBtaWdodCBiZSBjYWxsZWQgc3luY2hyb25vdXNseSB3aGVuIHhoci5zZW5kIGJlbG93IGlzIGNhbGxlZCBhbmQgdGhlCiAgICAgIC8vIHJlc3BvbnNlIGlzIGluIHRoZSBjYWNoZS4gdGhlIHByb21pc2UgYXBpIHdpbGwgZW5zdXJlIHRoYXQgdG8gdGhlIGFwcCBjb2RlIHRoZSBhcGkgaXMKICAgICAgLy8gYWx3YXlzIGFzeW5jCiAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAvLyBvbnJlYWR5c3RhdGVjaGFuZ2UgbWlnaHQgZ2V0IGNhbGxlZCBtdWx0aXBsZSB0aW1lcyB3aXRoIHJlYWR5U3RhdGUgPT09IDQgb24gbW9iaWxlIHdlYmtpdCBjYXVzZWQgYnkKICAgICAgICAvLyB4aHJzIHRoYXQgYXJlIHJlc29sdmVkIHdoaWxlIHRoZSBhcHAgaXMgaW4gdGhlIGJhY2tncm91bmQgKHNlZSAjNTQyNikuCiAgICAgICAgLy8gc2luY2UgY2FsbGluZyBjb21wbGV0ZVJlcXVlc3Qgc2V0cyB0aGUgYHhocmAgdmFyaWFibGUgdG8gbnVsbCwgd2UganVzdCBjaGVjayBpZiBpdCdzIG5vdCBudWxsIGJlZm9yZQogICAgICAgIC8vIGNvbnRpbnVpbmcKICAgICAgICAvLwogICAgICAgIC8vIHdlIGNhbid0IHNldCB4aHIub25yZWFkeXN0YXRlY2hhbmdlIHRvIHVuZGVmaW5lZCBvciBkZWxldGUgaXQgYmVjYXVzZSB0aGF0IGJyZWFrcyBJRTggKG1ldGhvZD1QQVRDSCkgYW5kCiAgICAgICAgLy8gU2FmYXJpIHJlc3BlY3RpdmVseS4KICAgICAgICBpZiAoeGhyICYmIHhoci5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgIHZhciByZXNwb25zZUhlYWRlcnMgPSBudWxsLAogICAgICAgICAgICAgIHJlc3BvbnNlID0gbnVsbDsKCiAgICAgICAgICBpZihzdGF0dXMgIT09IEFCT1JURUQpIHsKICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0geGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwoKICAgICAgICAgICAgLy8gcmVzcG9uc2VUZXh0IGlzIHRoZSBvbGQtc2Nob29sIHdheSBvZiByZXRyaWV2aW5nIHJlc3BvbnNlIChzdXBwb3J0ZWQgYnkgSUU4ICYgOSkKICAgICAgICAgICAgLy8gcmVzcG9uc2UvcmVzcG9uc2VUeXBlIHByb3BlcnRpZXMgd2VyZSBpbnRyb2R1Y2VkIGluIFhIUiBMZXZlbDIgc3BlYyAoc3VwcG9ydGVkIGJ5IElFMTApCiAgICAgICAgICAgIHJlc3BvbnNlID0gKCdyZXNwb25zZScgaW4geGhyKSA/IHhoci5yZXNwb25zZSA6IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICB9CgogICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLAogICAgICAgICAgICAgIHN0YXR1cyB8fCB4aHIuc3RhdHVzLAogICAgICAgICAgICAgIHJlc3BvbnNlLAogICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgICAgICAgICB4aHIuc3RhdHVzVGV4dCB8fCAnJyk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKHdpdGhDcmVkZW50aWFscykgewogICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICB9CgogICAgICBpZiAocmVzcG9uc2VUeXBlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSByZXNwb25zZVR5cGU7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgLy8gV2ViS2l0IGFkZGVkIHN1cHBvcnQgZm9yIHRoZSBqc29uIHJlc3BvbnNlVHlwZSB2YWx1ZSBvbiAwOS8wMy8yMDEzCiAgICAgICAgICAvLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NzM2NDguIFZlcnNpb25zIG9mIFNhZmFyaSBwcmlvciB0byA3IGFyZQogICAgICAgICAgLy8ga25vd24gdG8gdGhyb3cgd2hlbiBzZXR0aW5nIHRoZSB2YWx1ZSAianNvbiIgYXMgdGhlIHJlc3BvbnNlIHR5cGUuIE90aGVyIG9sZGVyCiAgICAgICAgICAvLyBicm93c2VycyBpbXBsZW1lbnRpbmcgdGhlIHJlc3BvbnNlVHlwZQogICAgICAgICAgLy8KICAgICAgICAgIC8vIFRoZSBqc29uIHJlc3BvbnNlIHR5cGUgY2FuIGJlIGlnbm9yZWQgaWYgbm90IHN1cHBvcnRlZCwgYmVjYXVzZSBKU09OIHBheWxvYWRzIGFyZQogICAgICAgICAgLy8gcGFyc2VkIG9uIHRoZSBjbGllbnQtc2lkZSByZWdhcmRsZXNzLgogICAgICAgICAgaWYgKHJlc3BvbnNlVHlwZSAhPT0gJ2pzb24nKSB7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB4aHIuc2VuZChwb3N0IHx8IG51bGwpOwogICAgfQoKICAgIGlmICh0aW1lb3V0ID4gMCkgewogICAgICB2YXIgdGltZW91dElkID0gJGJyb3dzZXJEZWZlcih0aW1lb3V0UmVxdWVzdCwgdGltZW91dCk7CiAgICB9IGVsc2UgaWYgKHRpbWVvdXQgJiYgdGltZW91dC50aGVuKSB7CiAgICAgIHRpbWVvdXQudGhlbih0aW1lb3V0UmVxdWVzdCk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRpbWVvdXRSZXF1ZXN0KCkgewogICAgICBzdGF0dXMgPSBBQk9SVEVEOwogICAgICBqc29ucERvbmUgJiYganNvbnBEb25lKCk7CiAgICAgIHhociAmJiB4aHIuYWJvcnQoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcsIHN0YXR1c1RleHQpIHsKICAgICAgLy8gY2FuY2VsIHRpbWVvdXQgYW5kIHN1YnNlcXVlbnQgdGltZW91dCBwcm9taXNlIHJlc29sdXRpb24KICAgICAgdGltZW91dElkICYmICRicm93c2VyRGVmZXIuY2FuY2VsKHRpbWVvdXRJZCk7CiAgICAgIGpzb25wRG9uZSA9IHhociA9IG51bGw7CgogICAgICAvLyBmaXggc3RhdHVzIGNvZGUgd2hlbiBpdCBpcyAwICgwIHN0YXR1cyBpcyB1bmRvY3VtZW50ZWQpLgogICAgICAvLyBPY2N1cnMgd2hlbiBhY2Nlc3NpbmcgZmlsZSByZXNvdXJjZXMgb3Igb24gQW5kcm9pZCA0LjEgc3RvY2sgYnJvd3NlcgogICAgICAvLyB3aGlsZSByZXRyaWV2aW5nIGZpbGVzIGZyb20gYXBwbGljYXRpb24gY2FjaGUuCiAgICAgIGlmIChzdGF0dXMgPT09IDApIHsKICAgICAgICBzdGF0dXMgPSByZXNwb25zZSA/IDIwMCA6IHVybFJlc29sdmUodXJsKS5wcm90b2NvbCA9PSAnZmlsZScgPyA0MDQgOiAwOwogICAgICB9CgogICAgICAvLyBub3JtYWxpemUgSUUgYnVnIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xNDUwKQogICAgICBzdGF0dXMgPSBzdGF0dXMgPT09IDEyMjMgPyAyMDQgOiBzdGF0dXM7CiAgICAgIHN0YXR1c1RleHQgPSBzdGF0dXNUZXh0IHx8ICcnOwoKICAgICAgY2FsbGJhY2soc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCk7CiAgICAgICRicm93c2VyLiQkY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24ganNvbnBSZXEodXJsLCBjYWxsYmFja0lkLCBkb25lKSB7CiAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgIC8vIC0gZmV0Y2hlcyBsb2NhbCBzY3JpcHRzIHZpYSBYSFIgYW5kIGV2YWxzIHRoZW0KICAgIC8vIC0gYWRkcyBhbmQgaW1tZWRpYXRlbHkgcmVtb3ZlcyBzY3JpcHQgZWxlbWVudHMgZnJvbSB0aGUgZG9jdW1lbnQKICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwgY2FsbGJhY2sgPSBudWxsOwogICAgc2NyaXB0LnR5cGUgPSAidGV4dC9qYXZhc2NyaXB0IjsKICAgIHNjcmlwdC5zcmMgPSB1cmw7CiAgICBzY3JpcHQuYXN5bmMgPSB0cnVlOwoKICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKHNjcmlwdCwgImxvYWQiLCBjYWxsYmFjayk7CiAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihzY3JpcHQsICJlcnJvciIsIGNhbGxiYWNrKTsKICAgICAgcmF3RG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICBzY3JpcHQgPSBudWxsOwogICAgICB2YXIgc3RhdHVzID0gLTE7CiAgICAgIHZhciB0ZXh0ID0gInVua25vd24iOwoKICAgICAgaWYgKGV2ZW50KSB7CiAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJsb2FkIiAmJiAhY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmNhbGxlZCkgewogICAgICAgICAgZXZlbnQgPSB7IHR5cGU6ICJlcnJvciIgfTsKICAgICAgICB9CiAgICAgICAgdGV4dCA9IGV2ZW50LnR5cGU7CiAgICAgICAgc3RhdHVzID0gZXZlbnQudHlwZSA9PT0gImVycm9yIiA/IDQwNCA6IDIwMDsKICAgICAgfQoKICAgICAgaWYgKGRvbmUpIHsKICAgICAgICBkb25lKHN0YXR1cywgdGV4dCk7CiAgICAgIH0KICAgIH07CgogICAgYWRkRXZlbnRMaXN0ZW5lckZuKHNjcmlwdCwgImxvYWQiLCBjYWxsYmFjayk7CiAgICBhZGRFdmVudExpc3RlbmVyRm4oc2NyaXB0LCAiZXJyb3IiLCBjYWxsYmFjayk7CgogICAgaWYgKG1zaWUgPD0gOCkgewogICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGlzU3RyaW5nKHNjcmlwdC5yZWFkeVN0YXRlKSAmJiAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KHNjcmlwdC5yZWFkeVN0YXRlKSkgewogICAgICAgICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgICAgICBjYWxsYmFjayh7CiAgICAgICAgICAgIHR5cGU6ICdsb2FkJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIHJhd0RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgIHJldHVybiBjYWxsYmFjazsKICB9Cn0KCnZhciAkaW50ZXJwb2xhdGVNaW5FcnIgPSBtaW5FcnIoJyRpbnRlcnBvbGF0ZScpOwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkaW50ZXJwb2xhdGVQcm92aWRlcgogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICoKICogVXNlZCBmb3IgY29uZmlndXJpbmcgdGhlIGludGVycG9sYXRpb24gbWFya3VwLiBEZWZhdWx0cyB0byBge3tgIGFuZCBgfX1gLgogKgogKiBAZXhhbXBsZQo8ZXhhbXBsZSBtb2R1bGU9ImN1c3RvbUludGVycG9sYXRpb25BcHAiPgo8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KPHNjcmlwdD4KICB2YXIgY3VzdG9tSW50ZXJwb2xhdGlvbkFwcCA9IGFuZ3VsYXIubW9kdWxlKCdjdXN0b21JbnRlcnBvbGF0aW9uQXBwJywgW10pOwoKICBjdXN0b21JbnRlcnBvbGF0aW9uQXBwLmNvbmZpZyhmdW5jdGlvbigkaW50ZXJwb2xhdGVQcm92aWRlcikgewogICAgJGludGVycG9sYXRlUHJvdmlkZXIuc3RhcnRTeW1ib2woJy8vJyk7CiAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5lbmRTeW1ib2woJy8vJyk7CiAgfSk7CgoKICBjdXN0b21JbnRlcnBvbGF0aW9uQXBwLmNvbnRyb2xsZXIoJ0RlbW9Db250cm9sbGVyJywgZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubGFiZWwgPSAiVGhpcyBiaW5kaW5nIGlzIGJyb3VnaHQgeW91IGJ5IC8vIGludGVycG9sYXRpb24gc3ltYm9scy4iOwogIH0pOwo8L3NjcmlwdD4KPGRpdiBuZy1hcHA9IkFwcCIgbmctY29udHJvbGxlcj0iRGVtb0NvbnRyb2xsZXIgYXMgZGVtbyI+CiAgICAvL2RlbW8ubGFiZWwvLwo8L2Rpdj4KPC9maWxlPgo8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICBpdCgnc2hvdWxkIGludGVycG9sYXRlIGJpbmRpbmcgd2l0aCBjdXN0b20gc3ltYm9scycsIGZ1bmN0aW9uKCkgewogICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnZGVtby5sYWJlbCcpKS5nZXRUZXh0KCkpLnRvQmUoJ1RoaXMgYmluZGluZyBpcyBicm91Z2h0IHlvdSBieSAvLyBpbnRlcnBvbGF0aW9uIHN5bWJvbHMuJyk7CiAgfSk7CjwvZmlsZT4KPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gJEludGVycG9sYXRlUHJvdmlkZXIoKSB7CiAgdmFyIHN0YXJ0U3ltYm9sID0gJ3t7JzsKICB2YXIgZW5kU3ltYm9sID0gJ319JzsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3ltYm9sIHRvIGRlbm90ZSBzdGFydCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBge3tgLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBuZXcgdmFsdWUgdG8gc2V0IHRoZSBzdGFydGluZyBzeW1ib2wgdG8uCiAgICogQHJldHVybnMge3N0cmluZ3xzZWxmfSBSZXR1cm5zIHRoZSBzeW1ib2wgd2hlbiB1c2VkIGFzIGdldHRlciBhbmQgc2VsZiBpZiB1c2VkIGFzIHNldHRlci4KICAgKi8KICB0aGlzLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24odmFsdWUpewogICAgaWYgKHZhbHVlKSB7CiAgICAgIHN0YXJ0U3ltYm9sID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHN0YXJ0U3ltYm9sOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgZW5kaW5nIHN5bWJvbCB0by4KICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAqLwogIHRoaXMuZW5kU3ltYm9sID0gZnVuY3Rpb24odmFsdWUpewogICAgaWYgKHZhbHVlKSB7CiAgICAgIGVuZFN5bWJvbCA9IHZhbHVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICB9CiAgfTsKCgogIHRoaXMuJGdldCA9IFsnJHBhcnNlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRzY2UnLCBmdW5jdGlvbigkcGFyc2UsICRleGNlcHRpb25IYW5kbGVyLCAkc2NlKSB7CiAgICB2YXIgc3RhcnRTeW1ib2xMZW5ndGggPSBzdGFydFN5bWJvbC5sZW5ndGgsCiAgICAgICAgZW5kU3ltYm9sTGVuZ3RoID0gZW5kU3ltYm9sLmxlbmd0aDsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSAkaW50ZXJwb2xhdGUKICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgKgogICAgICogQHJlcXVpcmVzICRwYXJzZQogICAgICogQHJlcXVpcmVzICRzY2UKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBDb21waWxlcyBhIHN0cmluZyB3aXRoIG1hcmt1cCBpbnRvIGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24uIFRoaXMgc2VydmljZSBpcyB1c2VkIGJ5IHRoZQogICAgICogSFRNTCB7QGxpbmsgbmcuJGNvbXBpbGUgJGNvbXBpbGV9IHNlcnZpY2UgZm9yIGRhdGEgYmluZGluZy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIgJGludGVycG9sYXRlUHJvdmlkZXJ9IGZvciBjb25maWd1cmluZyB0aGUKICAgICAqIGludGVycG9sYXRpb24gbWFya3VwLgogICAgICoKICAgICAqCiAgICAgKiBgYGBqcwogICAgICogICB2YXIgJGludGVycG9sYXRlID0gLi4uOyAvLyBpbmplY3RlZAogICAgICogICB2YXIgZXhwID0gJGludGVycG9sYXRlKCdIZWxsbyB7e25hbWUgfCB1cHBlcmNhc2V9fSEnKTsKICAgICAqICAgZXhwZWN0KGV4cCh7bmFtZTonQW5ndWxhcid9KS50b0VxdWFsKCdIZWxsbyBBTkdVTEFSIScpOwogICAgICogYGBgCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IFRoZSB0ZXh0IHdpdGggbWFya3VwIHRvIGludGVycG9sYXRlLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gbXVzdEhhdmVFeHByZXNzaW9uIGlmIHNldCB0byB0cnVlIHRoZW4gdGhlIGludGVycG9sYXRpb24gc3RyaW5nIG11c3QgaGF2ZQogICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiBpbiBvcmRlciB0byByZXR1cm4gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gU3RyaW5ncyB3aXRoIG5vCiAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIHdpbGwgcmV0dXJuIG51bGwgZm9yIHRoZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSB0cnVzdGVkQ29udGV4dCB3aGVuIHByb3ZpZGVkLCB0aGUgcmV0dXJuZWQgZnVuY3Rpb24gcGFzc2VzIHRoZSBpbnRlcnBvbGF0ZWQKICAgICAqICAgIHJlc3VsdCB0aHJvdWdoIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkKGludGVycG9sYXRlZFJlc3VsdCwKICAgICAqICAgIHRydXN0ZWRDb250ZXh0KX0gYmVmb3JlIHJldHVybmluZyBpdC4gIFJlZmVyIHRvIHRoZSB7QGxpbmsgbmcuJHNjZSAkc2NlfSBzZXJ2aWNlIHRoYXQKICAgICAqICAgIHByb3ZpZGVzIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGZvciBkZXRhaWxzLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQpfSBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gY29tcHV0ZSB0aGUKICAgICAqICAgIGludGVycG9sYXRlZCBzdHJpbmcuIFRoZSBmdW5jdGlvbiBoYXMgdGhlc2UgcGFyYW1ldGVyczoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YDogYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzIGFyZSBldmFsdWF0ZWQKICAgICAqICAgICAgYWdhaW5zdC4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRpbnRlcnBvbGF0ZSh0ZXh0LCBtdXN0SGF2ZUV4cHJlc3Npb24sIHRydXN0ZWRDb250ZXh0KSB7CiAgICAgIHZhciBzdGFydEluZGV4LAogICAgICAgICAgZW5kSW5kZXgsCiAgICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgICBwYXJ0cyA9IFtdLAogICAgICAgICAgbGVuZ3RoID0gdGV4dC5sZW5ndGgsCiAgICAgICAgICBoYXNJbnRlcnBvbGF0aW9uID0gZmFsc2UsCiAgICAgICAgICBmbiwKICAgICAgICAgIGV4cCwKICAgICAgICAgIGNvbmNhdCA9IFtdOwoKICAgICAgd2hpbGUoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBpZiAoICgoc3RhcnRJbmRleCA9IHRleHQuaW5kZXhPZihzdGFydFN5bWJvbCwgaW5kZXgpKSAhPSAtMSkgJiYKICAgICAgICAgICAgICgoZW5kSW5kZXggPSB0ZXh0LmluZGV4T2YoZW5kU3ltYm9sLCBzdGFydEluZGV4ICsgc3RhcnRTeW1ib2xMZW5ndGgpKSAhPSAtMSkgKSB7CiAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgcGFydHMucHVzaChmbiA9ICRwYXJzZShleHAgPSB0ZXh0LnN1YnN0cmluZyhzdGFydEluZGV4ICsgc3RhcnRTeW1ib2xMZW5ndGgsIGVuZEluZGV4KSkpOwogICAgICAgICAgZm4uZXhwID0gZXhwOwogICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgIGhhc0ludGVycG9sYXRpb24gPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyB3ZSBkaWQgbm90IGZpbmQgYW55dGhpbmcsIHNvIHdlIGhhdmUgdG8gYWRkIHRoZSByZW1haW5kZXIgdG8gdGhlIHBhcnRzIGFycmF5CiAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICBpbmRleCA9IGxlbmd0aDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghKGxlbmd0aCA9IHBhcnRzLmxlbmd0aCkpIHsKICAgICAgICAvLyB3ZSBhZGRlZCwgbm90aGluZywgbXVzdCBoYXZlIGJlZW4gYW4gZW1wdHkgc3RyaW5nLgogICAgICAgIHBhcnRzLnB1c2goJycpOwogICAgICAgIGxlbmd0aCA9IDE7CiAgICAgIH0KCiAgICAgIC8vIENvbmNhdGVuYXRpbmcgZXhwcmVzc2lvbnMgbWFrZXMgaXQgaGFyZCB0byByZWFzb24gYWJvdXQgd2hldGhlciBzb21lIGNvbWJpbmF0aW9uIG9mCiAgICAgIC8vIGNvbmNhdGVuYXRlZCB2YWx1ZXMgYXJlIHVuc2FmZSB0byB1c2UgYW5kIGNvdWxkIGVhc2lseSBsZWFkIHRvIFhTUy4gIEJ5IHJlcXVpcmluZyB0aGF0IGEKICAgICAgLy8gc2luZ2xlIGV4cHJlc3Npb24gYmUgdXNlZCBmb3IgaWZyYW1lW3NyY10sIG9iamVjdFtzcmNdLCBldGMuLCB3ZSBlbnN1cmUgdGhhdCB0aGUgdmFsdWUKICAgICAgLy8gdGhhdCdzIHVzZWQgaXMgYXNzaWduZWQgb3IgY29uc3RydWN0ZWQgYnkgc29tZSBKUyBjb2RlIHNvbWV3aGVyZSB0aGF0IGlzIG1vcmUgdGVzdGFibGUgb3IKICAgICAgLy8gbWFrZSBpdCBvYnZpb3VzIHRoYXQgeW91IGJvdW5kIHRoZSB2YWx1ZSB0byBzb21lIHVzZXIgY29udHJvbGxlZCB2YWx1ZS4gIFRoaXMgaGVscHMgcmVkdWNlCiAgICAgIC8vIHRoZSBsb2FkIHdoZW4gYXVkaXRpbmcgZm9yIFhTUyBpc3N1ZXMuCiAgICAgIGlmICh0cnVzdGVkQ29udGV4dCAmJiBwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICB0aHJvdyAkaW50ZXJwb2xhdGVNaW5FcnIoJ25vY29uY2F0JywKICAgICAgICAgICAgICAiRXJyb3Igd2hpbGUgaW50ZXJwb2xhdGluZzogezB9XG5TdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBkaXNhbGxvd3MgIiArCiAgICAgICAgICAgICAgImludGVycG9sYXRpb25zIHRoYXQgY29uY2F0ZW5hdGUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgd2hlbiBhIHRydXN0ZWQgdmFsdWUgaXMgIiArCiAgICAgICAgICAgICAgInJlcXVpcmVkLiAgU2VlIGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRzY2UiLCB0ZXh0KTsKICAgICAgfQoKICAgICAgaWYgKCFtdXN0SGF2ZUV4cHJlc3Npb24gIHx8IGhhc0ludGVycG9sYXRpb24pIHsKICAgICAgICBjb25jYXQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIGZuID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSBsZW5ndGgsIHBhcnQ7IGk8aWk7IGkrKykgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgKHBhcnQgPSBwYXJ0c1tpXSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgcGFydCA9IHBhcnQoY29udGV4dCk7CiAgICAgICAgICAgICAgICBpZiAodHJ1c3RlZENvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgcGFydCA9ICRzY2UuZ2V0VHJ1c3RlZCh0cnVzdGVkQ29udGV4dCwgcGFydCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwYXJ0ID0gJHNjZS52YWx1ZU9mKHBhcnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCkgeyAvLyBudWxsIHx8IHVuZGVmaW5lZAogICAgICAgICAgICAgICAgICBwYXJ0ID0gJyc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBwYXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJycgKyBwYXJ0OwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHRvSnNvbihwYXJ0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uY2F0W2ldID0gcGFydDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29uY2F0LmpvaW4oJycpOwogICAgICAgICAgfQogICAgICAgICAgY2F0Y2goZXJyKSB7CiAgICAgICAgICAgIHZhciBuZXdFcnIgPSAkaW50ZXJwb2xhdGVNaW5FcnIoJ2ludGVycicsICJDYW4ndCBpbnRlcnBvbGF0ZTogezB9XG57MX0iLCB0ZXh0LAogICAgICAgICAgICAgICAgZXJyLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihuZXdFcnIpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZm4uZXhwID0gdGV4dDsKICAgICAgICBmbi5wYXJ0cyA9IHBhcnRzOwogICAgICAgIHJldHVybiBmbjsKICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZSNzdGFydFN5bWJvbAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBzdGFydCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBge3tgLgogICAgICoKICAgICAqIFVzZSB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wgJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2x9IHRvIGNoYW5nZQogICAgICogdGhlIHN5bWJvbC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBzdGFydCBzeW1ib2wuCiAgICAgKi8KICAgICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZSNlbmRTeW1ib2wKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgZW5kIG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB9fWAuCiAgICAgKgogICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wgJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sfSB0byBjaGFuZ2UKICAgICAqIHRoZSBzeW1ib2wuCiAgICAgKgogICAgICogQHJldHVybnMge3N0cmluZ30gZW5kIHN5bWJvbC4KICAgICAqLwogICAgJGludGVycG9sYXRlLmVuZFN5bWJvbCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgfTsKCiAgICByZXR1cm4gJGludGVycG9sYXRlOwogIH1dOwp9CgpmdW5jdGlvbiAkSW50ZXJ2YWxQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJHdpbmRvdycsICckcScsCiAgICAgICBmdW5jdGlvbigkcm9vdFNjb3BlLCAgICR3aW5kb3csICAgJHEpIHsKICAgIHZhciBpbnRlcnZhbHMgPSB7fTsKCgogICAgIC8qKgogICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICogQG5hbWUgJGludGVydmFsCiAgICAgICoKICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgKiBBbmd1bGFyJ3Mgd3JhcHBlciBmb3IgYHdpbmRvdy5zZXRJbnRlcnZhbGAuIFRoZSBgZm5gIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkIGV2ZXJ5IGBkZWxheWAKICAgICAgKiBtaWxsaXNlY29uZHMuCiAgICAgICoKICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGFuIGludGVydmFsIGZ1bmN0aW9uIGlzIGEgcHJvbWlzZS4gVGhpcyBwcm9taXNlIHdpbGwgYmUKICAgICAgKiBub3RpZmllZCB1cG9uIGVhY2ggdGljayBvZiB0aGUgaW50ZXJ2YWwsIGFuZCB3aWxsIGJlIHJlc29sdmVkIGFmdGVyIGBjb3VudGAgaXRlcmF0aW9ucywgb3IKICAgICAgKiBydW4gaW5kZWZpbml0ZWx5IGlmIGBjb3VudGAgaXMgbm90IGRlZmluZWQuIFRoZSB2YWx1ZSBvZiB0aGUgbm90aWZpY2F0aW9uIHdpbGwgYmUgdGhlCiAgICAgICogbnVtYmVyIG9mIGl0ZXJhdGlvbnMgdGhhdCBoYXZlIHJ1bi4KICAgICAgKiBUbyBjYW5jZWwgYW4gaW50ZXJ2YWwsIGNhbGwgYCRpbnRlcnZhbC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAqCiAgICAgICogSW4gdGVzdHMgeW91IGNhbiB1c2Uge0BsaW5rIG5nTW9jay4kaW50ZXJ2YWwjZmx1c2ggYCRpbnRlcnZhbC5mbHVzaChtaWxsaXMpYH0gdG8KICAgICAgKiBtb3ZlIGZvcndhcmQgYnkgYG1pbGxpc2AgbWlsbGlzZWNvbmRzIGFuZCB0cmlnZ2VyIGFueSBmdW5jdGlvbnMgc2NoZWR1bGVkIHRvIHJ1biBpbiB0aGF0CiAgICAgICogdGltZS4KICAgICAgKgogICAgICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogICAgICAqICoqTm90ZSoqOiBJbnRlcnZhbHMgY3JlYXRlZCBieSB0aGlzIHNlcnZpY2UgbXVzdCBiZSBleHBsaWNpdGx5IGRlc3Ryb3llZCB3aGVuIHlvdSBhcmUgZmluaXNoZWQKICAgICAgKiB3aXRoIHRoZW0uICBJbiBwYXJ0aWN1bGFyIHRoZXkgYXJlIG5vdCBhdXRvbWF0aWNhbGx5IGRlc3Ryb3llZCB3aGVuIGEgY29udHJvbGxlcidzIHNjb3BlIG9yIGEKICAgICAgKiBkaXJlY3RpdmUncyBlbGVtZW50IGFyZSBkZXN0cm95ZWQuCiAgICAgICogWW91IHNob3VsZCB0YWtlIHRoaXMgaW50byBjb25zaWRlcmF0aW9uIGFuZCBtYWtlIHN1cmUgdG8gYWx3YXlzIGNhbmNlbCB0aGUgaW50ZXJ2YWwgYXQgdGhlCiAgICAgICogYXBwcm9wcmlhdGUgbW9tZW50LiAgU2VlIHRoZSBleGFtcGxlIGJlbG93IGZvciBtb3JlIGRldGFpbHMgb24gaG93IGFuZCB3aGVuIHRvIGRvIHRoaXMuCiAgICAgICogPC9kaXY+CiAgICAgICoKICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgY2FsbGVkIHJlcGVhdGVkbHkuCiAgICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IE51bWJlciBvZiBtaWxsaXNlY29uZHMgYmV0d2VlbiBlYWNoIGZ1bmN0aW9uIGNhbGwuCiAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbY291bnQ9MF0gTnVtYmVyIG9mIHRpbWVzIHRvIHJlcGVhdC4gSWYgbm90IHNldCwgb3IgMCwgd2lsbCByZXBlYXQKICAgICAgKiAgIGluZGVmaW5pdGVseS4KICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBbaW52b2tlQXBwbHk9dHJ1ZV0gSWYgc2V0IHRvIGBmYWxzZWAgc2tpcHMgbW9kZWwgZGlydHkgY2hlY2tpbmcsIG90aGVyd2lzZQogICAgICAqICAgd2lsbCBpbnZva2UgYGZuYCB3aXRoaW4gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHl9IGJsb2NrLgogICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggd2lsbCBiZSBub3RpZmllZCBvbiBlYWNoIGl0ZXJhdGlvbi4KICAgICAgKgogICAgICAqIEBleGFtcGxlCiAgICAgICogPGV4YW1wbGUgbW9kdWxlPSJ0aW1lIj4KICAgICAgKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAqICAgICA8c2NyaXB0PgogICAgICAqICAgICAgIGZ1bmN0aW9uIEN0cmwyKCRzY29wZSwkaW50ZXJ2YWwpIHsKICAgICAgKiAgICAgICAgICRzY29wZS5mb3JtYXQgPSAnTS9kL3l5IGg6bW06c3MgYSc7CiAgICAgICogICAgICAgICAkc2NvcGUuYmxvb2RfMSA9IDEwMDsKICAgICAgKiAgICAgICAgICRzY29wZS5ibG9vZF8yID0gMTIwOwogICAgICAqCiAgICAgICogICAgICAgICB2YXIgc3RvcDsKICAgICAgKiAgICAgICAgICRzY29wZS5maWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAvLyBEb24ndCBzdGFydCBhIG5ldyBmaWdodCBpZiB3ZSBhcmUgYWxyZWFkeSBmaWdodGluZwogICAgICAqICAgICAgICAgICBpZiAoIGFuZ3VsYXIuaXNEZWZpbmVkKHN0b3ApICkgcmV0dXJuOwogICAgICAqCiAgICAgICogICAgICAgICAgIHN0b3AgPSAkaW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgICAgaWYgKCRzY29wZS5ibG9vZF8xID4gMCAmJiAkc2NvcGUuYmxvb2RfMiA+IDApIHsKICAgICAgKiAgICAgICAgICAgICAgICAgJHNjb3BlLmJsb29kXzEgPSAkc2NvcGUuYmxvb2RfMSAtIDM7CiAgICAgICogICAgICAgICAgICAgICAgICRzY29wZS5ibG9vZF8yID0gJHNjb3BlLmJsb29kXzIgLSA0OwogICAgICAqICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICogICAgICAgICAgICAgICAgICRzY29wZS5zdG9wRmlnaHQoKTsKICAgICAgKiAgICAgICAgICAgICB9CiAgICAgICogICAgICAgICAgIH0sIDEwMCk7CiAgICAgICogICAgICAgICB9OwogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUuc3RvcEZpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZChzdG9wKSkgewogICAgICAqICAgICAgICAgICAgICRpbnRlcnZhbC5jYW5jZWwoc3RvcCk7CiAgICAgICogICAgICAgICAgICAgc3RvcCA9IHVuZGVmaW5lZDsKICAgICAgKiAgICAgICAgICAgfQogICAgICAqICAgICAgICAgfTsKICAgICAgKgogICAgICAqICAgICAgICAgJHNjb3BlLnJlc2V0RmlnaHQgPSBmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmJsb29kXzEgPSAxMDA7CiAgICAgICogICAgICAgICAgICRzY29wZS5ibG9vZF8yID0gMTIwOwogICAgICAqICAgICAgICAgfQogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaW50ZXJ2YWwgaXMgZGVzdHJveWVkIHRvbwogICAgICAqICAgICAgICAgICAkc2NvcGUuc3RvcEZpZ2h0KCk7CiAgICAgICogICAgICAgICB9KTsKICAgICAgKiAgICAgICB9CiAgICAgICoKICAgICAgKiAgICAgICBhbmd1bGFyLm1vZHVsZSgndGltZScsIFtdKQogICAgICAqICAgICAgICAgLy8gUmVnaXN0ZXIgdGhlICdteUN1cnJlbnRUaW1lJyBkaXJlY3RpdmUgZmFjdG9yeSBtZXRob2QuCiAgICAgICogICAgICAgICAvLyBXZSBpbmplY3QgJGludGVydmFsIGFuZCBkYXRlRmlsdGVyIHNlcnZpY2Ugc2luY2UgdGhlIGZhY3RvcnkgbWV0aG9kIGlzIERJLgogICAgICAqICAgICAgICAgLmRpcmVjdGl2ZSgnbXlDdXJyZW50VGltZScsIGZ1bmN0aW9uKCRpbnRlcnZhbCwgZGF0ZUZpbHRlcikgewogICAgICAqICAgICAgICAgICAvLyByZXR1cm4gdGhlIGRpcmVjdGl2ZSBsaW5rIGZ1bmN0aW9uLiAoY29tcGlsZSBmdW5jdGlvbiBub3QgbmVlZGVkKQogICAgICAqICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICogICAgICAgICAgICAgdmFyIGZvcm1hdCwgIC8vIGRhdGUgZm9ybWF0CiAgICAgICogICAgICAgICAgICAgc3RvcFRpbWU7IC8vIHNvIHRoYXQgd2UgY2FuIGNhbmNlbCB0aGUgdGltZSB1cGRhdGVzCiAgICAgICoKICAgICAgKiAgICAgICAgICAgICAvLyB1c2VkIHRvIHVwZGF0ZSB0aGUgVUkKICAgICAgKiAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVUaW1lKCkgewogICAgICAqICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KGRhdGVGaWx0ZXIobmV3IERhdGUoKSwgZm9ybWF0KSk7CiAgICAgICogICAgICAgICAgICAgfQogICAgICAqCiAgICAgICogICAgICAgICAgICAgLy8gd2F0Y2ggdGhlIGV4cHJlc3Npb24sIGFuZCB1cGRhdGUgdGhlIFVJIG9uIGNoYW5nZS4KICAgICAgKiAgICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0cnMubXlDdXJyZW50VGltZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgKiAgICAgICAgICAgICAgIGZvcm1hdCA9IHZhbHVlOwogICAgICAqICAgICAgICAgICAgICAgdXBkYXRlVGltZSgpOwogICAgICAqICAgICAgICAgICAgIH0pOwogICAgICAqCiAgICAgICogICAgICAgICAgICAgc3RvcFRpbWUgPSAkaW50ZXJ2YWwodXBkYXRlVGltZSwgMTAwMCk7CiAgICAgICoKICAgICAgKiAgICAgICAgICAgICAvLyBsaXN0ZW4gb24gRE9NIGRlc3Ryb3kgKHJlbW92YWwpIGV2ZW50LCBhbmQgY2FuY2VsIHRoZSBuZXh0IFVJIHVwZGF0ZQogICAgICAqICAgICAgICAgICAgIC8vIHRvIHByZXZlbnQgdXBkYXRpbmcgdGltZSBvZnRlciB0aGUgRE9NIGVsZW1lbnQgd2FzIHJlbW92ZWQuCiAgICAgICogICAgICAgICAgICAgZWxlbWVudC5iaW5kKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAgICAgJGludGVydmFsLmNhbmNlbChzdG9wVGltZSk7CiAgICAgICogICAgICAgICAgICAgfSk7CiAgICAgICogICAgICAgICAgIH0KICAgICAgKiAgICAgICAgIH0pOwogICAgICAqICAgICA8L3NjcmlwdD4KICAgICAgKgogICAgICAqICAgICA8ZGl2PgogICAgICAqICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybDIiPgogICAgICAqICAgICAgICAgRGF0ZSBmb3JtYXQ6IDxpbnB1dCBuZy1tb2RlbD0iZm9ybWF0Ij4gPGhyLz4KICAgICAgKiAgICAgICAgIEN1cnJlbnQgdGltZSBpczogPHNwYW4gbXktY3VycmVudC10aW1lPSJmb3JtYXQiPjwvc3Bhbj4KICAgICAgKiAgICAgICAgIDxoci8+CiAgICAgICogICAgICAgICBCbG9vZCAxIDogPGZvbnQgY29sb3I9J3JlZCc+e3tibG9vZF8xfX08L2ZvbnQ+CiAgICAgICogICAgICAgICBCbG9vZCAyIDogPGZvbnQgY29sb3I9J3JlZCc+e3tibG9vZF8yfX08L2ZvbnQ+CiAgICAgICogICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGF0YS1uZy1jbGljaz0iZmlnaHQoKSI+RmlnaHQ8L2J1dHRvbj4KICAgICAgKiAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLW5nLWNsaWNrPSJzdG9wRmlnaHQoKSI+U3RvcEZpZ2h0PC9idXR0b24+CiAgICAgICogICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGF0YS1uZy1jbGljaz0icmVzZXRGaWdodCgpIj5yZXNldEZpZ2h0PC9idXR0b24+CiAgICAgICogICAgICAgPC9kaXY+CiAgICAgICogICAgIDwvZGl2PgogICAgICAqCiAgICAgICogICA8L2ZpbGU+CiAgICAgICogPC9leGFtcGxlPgogICAgICAqLwogICAgZnVuY3Rpb24gaW50ZXJ2YWwoZm4sIGRlbGF5LCBjb3VudCwgaW52b2tlQXBwbHkpIHsKICAgICAgdmFyIHNldEludGVydmFsID0gJHdpbmRvdy5zZXRJbnRlcnZhbCwKICAgICAgICAgIGNsZWFySW50ZXJ2YWwgPSAkd2luZG93LmNsZWFySW50ZXJ2YWwsCiAgICAgICAgICBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgIGl0ZXJhdGlvbiA9IDAsCiAgICAgICAgICBza2lwQXBwbHkgPSAoaXNEZWZpbmVkKGludm9rZUFwcGx5KSAmJiAhaW52b2tlQXBwbHkpOwoKICAgICAgY291bnQgPSBpc0RlZmluZWQoY291bnQpID8gY291bnQgOiAwOwoKICAgICAgcHJvbWlzZS50aGVuKG51bGwsIG51bGwsIGZuKTsKCiAgICAgIHByb21pc2UuJCRpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gdGljaygpIHsKICAgICAgICBkZWZlcnJlZC5ub3RpZnkoaXRlcmF0aW9uKyspOwoKICAgICAgICBpZiAoY291bnQgPiAwICYmIGl0ZXJhdGlvbiA+PSBjb3VudCkgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShpdGVyYXRpb24pOwogICAgICAgICAgY2xlYXJJbnRlcnZhbChwcm9taXNlLiQkaW50ZXJ2YWxJZCk7CiAgICAgICAgICBkZWxldGUgaW50ZXJ2YWxzW3Byb21pc2UuJCRpbnRlcnZhbElkXTsKICAgICAgICB9CgogICAgICAgIGlmICghc2tpcEFwcGx5KSAkcm9vdFNjb3BlLiRhcHBseSgpOwoKICAgICAgfSwgZGVsYXkpOwoKICAgICAgaW50ZXJ2YWxzW3Byb21pc2UuJCRpbnRlcnZhbElkXSA9IGRlZmVycmVkOwoKICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CgoKICAgICAvKioKICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICogQG5hbWUgJGludGVydmFsI2NhbmNlbAogICAgICAqCiAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICogQ2FuY2VscyBhIHRhc2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBgcHJvbWlzZWAuCiAgICAgICoKICAgICAgKiBAcGFyYW0ge3Byb21pc2V9IHByb21pc2UgcmV0dXJuZWQgYnkgdGhlIGAkaW50ZXJ2YWxgIGZ1bmN0aW9uLgogICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayB3YXMgc3VjY2Vzc2Z1bGx5IGNhbmNlbGVkLgogICAgICAqLwogICAgaW50ZXJ2YWwuY2FuY2VsID0gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkaW50ZXJ2YWxJZCBpbiBpbnRlcnZhbHMpIHsKICAgICAgICBpbnRlcnZhbHNbcHJvbWlzZS4kJGludGVydmFsSWRdLnJlamVjdCgnY2FuY2VsZWQnKTsKICAgICAgICBjbGVhckludGVydmFsKHByb21pc2UuJCRpbnRlcnZhbElkKTsKICAgICAgICBkZWxldGUgaW50ZXJ2YWxzW3Byb21pc2UuJCRpbnRlcnZhbElkXTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIHJldHVybiBpbnRlcnZhbDsKICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRsb2NhbGUKICoKICogQGRlc2NyaXB0aW9uCiAqICRsb2NhbGUgc2VydmljZSBwcm92aWRlcyBsb2NhbGl6YXRpb24gcnVsZXMgZm9yIHZhcmlvdXMgQW5ndWxhciBjb21wb25lbnRzLiBBcyBvZiByaWdodCBub3cgdGhlCiAqIG9ubHkgcHVibGljIGFwaSBpczoKICoKICogKiBgaWRgIOKAkyBge3N0cmluZ31gIOKAkyBsb2NhbGUgaWQgZm9ybWF0dGVkIGFzIGBsYW5ndWFnZUlkLWNvdW50cnlJZGAgKGUuZy4gYGVuLXVzYCkKICovCmZ1bmN0aW9uICRMb2NhbGVQcm92aWRlcigpewogIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgaWQ6ICdlbi11cycsCgogICAgICBOVU1CRVJfRk9STUFUUzogewogICAgICAgIERFQ0lNQUxfU0VQOiAnLicsCiAgICAgICAgR1JPVVBfU0VQOiAnLCcsCiAgICAgICAgUEFUVEVSTlM6IFsKICAgICAgICAgIHsgLy8gRGVjaW1hbCBQYXR0ZXJuCiAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgbWluRnJhYzogMCwKICAgICAgICAgICAgbWF4RnJhYzogMywKICAgICAgICAgICAgcG9zUHJlOiAnJywKICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgbmVnUHJlOiAnLScsCiAgICAgICAgICAgIG5lZ1N1ZjogJycsCiAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgIH0seyAvL0N1cnJlbmN5IFBhdHRlcm4KICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICBtaW5GcmFjOiAyLAogICAgICAgICAgICBtYXhGcmFjOiAyLAogICAgICAgICAgICBwb3NQcmU6ICdcdTAwQTQnLAogICAgICAgICAgICBwb3NTdWY6ICcnLAogICAgICAgICAgICBuZWdQcmU6ICcoXHUwMEE0JywKICAgICAgICAgICAgbmVnU3VmOiAnKScsCiAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgIH0KICAgICAgICBdLAogICAgICAgIENVUlJFTkNZX1NZTTogJyQnCiAgICAgIH0sCgogICAgICBEQVRFVElNRV9GT1JNQVRTOiB7CiAgICAgICAgTU9OVEg6CiAgICAgICAgICAgICdKYW51YXJ5LEZlYnJ1YXJ5LE1hcmNoLEFwcmlsLE1heSxKdW5lLEp1bHksQXVndXN0LFNlcHRlbWJlcixPY3RvYmVyLE5vdmVtYmVyLERlY2VtYmVyJwogICAgICAgICAgICAuc3BsaXQoJywnKSwKICAgICAgICBTSE9SVE1PTlRIOiAgJ0phbixGZWIsTWFyLEFwcixNYXksSnVuLEp1bCxBdWcsU2VwLE9jdCxOb3YsRGVjJy5zcGxpdCgnLCcpLAogICAgICAgIERBWTogJ1N1bmRheSxNb25kYXksVHVlc2RheSxXZWRuZXNkYXksVGh1cnNkYXksRnJpZGF5LFNhdHVyZGF5Jy5zcGxpdCgnLCcpLAogICAgICAgIFNIT1JUREFZOiAnU3VuLE1vbixUdWUsV2VkLFRodSxGcmksU2F0Jy5zcGxpdCgnLCcpLAogICAgICAgIEFNUE1TOiBbJ0FNJywnUE0nXSwKICAgICAgICBtZWRpdW06ICdNTU0gZCwgeSBoOm1tOnNzIGEnLAogICAgICAgIHNob3J0OiAnTS9kL3l5IGg6bW0gYScsCiAgICAgICAgZnVsbERhdGU6ICdFRUVFLCBNTU1NIGQsIHknLAogICAgICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICAgICAgICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICAgICAgIHNob3J0RGF0ZTogJ00vZC95eScsCiAgICAgICAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgICAgICAgc2hvcnRUaW1lOiAnaDptbSBhJwogICAgICB9LAoKICAgICAgcGx1cmFsQ2F0OiBmdW5jdGlvbihudW0pIHsKICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gJ29uZSc7CiAgICAgICAgfQogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9CiAgICB9OwogIH07Cn0KCnZhciBQQVRIX01BVENIID0gL14oW15cPyNdKikoXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgREVGQVVMVF9QT1JUUyA9IHsnaHR0cCc6IDgwLCAnaHR0cHMnOiA0NDMsICdmdHAnOiAyMX07CnZhciAkbG9jYXRpb25NaW5FcnIgPSBtaW5FcnIoJyRsb2NhdGlvbicpOwoKCi8qKgogKiBFbmNvZGUgcGF0aCB1c2luZyBlbmNvZGVVcmlTZWdtZW50LCBpZ25vcmluZyBmb3J3YXJkIHNsYXNoZXMKICoKICogQHBhcmFtIHtzdHJpbmd9IHBhdGggUGF0aCB0byBlbmNvZGUKICogQHJldHVybnMge3N0cmluZ30KICovCmZ1bmN0aW9uIGVuY29kZVBhdGgocGF0aCkgewogIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy8nKSwKICAgICAgaSA9IHNlZ21lbnRzLmxlbmd0aDsKCiAgd2hpbGUgKGktLSkgewogICAgc2VnbWVudHNbaV0gPSBlbmNvZGVVcmlTZWdtZW50KHNlZ21lbnRzW2ldKTsKICB9CgogIHJldHVybiBzZWdtZW50cy5qb2luKCcvJyk7Cn0KCmZ1bmN0aW9uIHBhcnNlQWJzb2x1dGVVcmwoYWJzb2x1dGVVcmwsIGxvY2F0aW9uT2JqLCBhcHBCYXNlKSB7CiAgdmFyIHBhcnNlZFVybCA9IHVybFJlc29sdmUoYWJzb2x1dGVVcmwsIGFwcEJhc2UpOwoKICBsb2NhdGlvbk9iai4kJHByb3RvY29sID0gcGFyc2VkVXJsLnByb3RvY29sOwogIGxvY2F0aW9uT2JqLiQkaG9zdCA9IHBhcnNlZFVybC5ob3N0bmFtZTsKICBsb2NhdGlvbk9iai4kJHBvcnQgPSBpbnQocGFyc2VkVXJsLnBvcnQpIHx8IERFRkFVTFRfUE9SVFNbcGFyc2VkVXJsLnByb3RvY29sXSB8fCBudWxsOwp9CgoKZnVuY3Rpb24gcGFyc2VBcHBVcmwocmVsYXRpdmVVcmwsIGxvY2F0aW9uT2JqLCBhcHBCYXNlKSB7CiAgdmFyIHByZWZpeGVkID0gKHJlbGF0aXZlVXJsLmNoYXJBdCgwKSAhPT0gJy8nKTsKICBpZiAocHJlZml4ZWQpIHsKICAgIHJlbGF0aXZlVXJsID0gJy8nICsgcmVsYXRpdmVVcmw7CiAgfQogIHZhciBtYXRjaCA9IHVybFJlc29sdmUocmVsYXRpdmVVcmwsIGFwcEJhc2UpOwogIGxvY2F0aW9uT2JqLiQkcGF0aCA9IGRlY29kZVVSSUNvbXBvbmVudChwcmVmaXhlZCAmJiBtYXRjaC5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJyA/CiAgICAgIG1hdGNoLnBhdGhuYW1lLnN1YnN0cmluZygxKSA6IG1hdGNoLnBhdGhuYW1lKTsKICBsb2NhdGlvbk9iai4kJHNlYXJjaCA9IHBhcnNlS2V5VmFsdWUobWF0Y2guc2VhcmNoKTsKICBsb2NhdGlvbk9iai4kJGhhc2ggPSBkZWNvZGVVUklDb21wb25lbnQobWF0Y2guaGFzaCk7CgogIC8vIG1ha2Ugc3VyZSBwYXRoIHN0YXJ0cyB3aXRoICcvJzsKICBpZiAobG9jYXRpb25PYmouJCRwYXRoICYmIGxvY2F0aW9uT2JqLiQkcGF0aC5jaGFyQXQoMCkgIT0gJy8nKSB7CiAgICBsb2NhdGlvbk9iai4kJHBhdGggPSAnLycgKyBsb2NhdGlvbk9iai4kJHBhdGg7CiAgfQp9CgoKLyoqCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBiZWdpbgogKiBAcGFyYW0ge3N0cmluZ30gd2hvbGUKICogQHJldHVybnMge3N0cmluZ30gcmV0dXJucyB0ZXh0IGZyb20gd2hvbGUgYWZ0ZXIgYmVnaW4gb3IgdW5kZWZpbmVkIGlmIGl0IGRvZXMgbm90IGJlZ2luIHdpdGgKICogICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQgc3RyaW5nLgogKi8KZnVuY3Rpb24gYmVnaW5zV2l0aChiZWdpbiwgd2hvbGUpIHsKICBpZiAod2hvbGUuaW5kZXhPZihiZWdpbikgPT09IDApIHsKICAgIHJldHVybiB3aG9sZS5zdWJzdHIoYmVnaW4ubGVuZ3RoKTsKICB9Cn0KCgpmdW5jdGlvbiBzdHJpcEhhc2godXJsKSB7CiAgdmFyIGluZGV4ID0gdXJsLmluZGV4T2YoJyMnKTsKICByZXR1cm4gaW5kZXggPT0gLTEgPyB1cmwgOiB1cmwuc3Vic3RyKDAsIGluZGV4KTsKfQoKCmZ1bmN0aW9uIHN0cmlwRmlsZSh1cmwpIHsKICByZXR1cm4gdXJsLnN1YnN0cigwLCBzdHJpcEhhc2godXJsKS5sYXN0SW5kZXhPZignLycpICsgMSk7Cn0KCi8qIHJldHVybiB0aGUgc2VydmVyIG9ubHkgKHNjaGVtZTovL2hvc3Q6cG9ydCkgKi8KZnVuY3Rpb24gc2VydmVyQmFzZSh1cmwpIHsKICByZXR1cm4gdXJsLnN1YnN0cmluZygwLCB1cmwuaW5kZXhPZignLycsIHVybC5pbmRleE9mKCcvLycpICsgMikpOwp9CgoKLyoqCiAqIExvY2F0aW9uSHRtbDVVcmwgcmVwcmVzZW50cyBhbiB1cmwKICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIEhUTUw1IG1vZGUgaXMgZW5hYmxlZCBhbmQgc3VwcG9ydGVkCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogKiBAcGFyYW0ge3N0cmluZ30gYmFzZVByZWZpeCB1cmwgcGF0aCBwcmVmaXgKICovCmZ1bmN0aW9uIExvY2F0aW9uSHRtbDVVcmwoYXBwQmFzZSwgYmFzZVByZWZpeCkgewogIHRoaXMuJCRodG1sNSA9IHRydWU7CiAgYmFzZVByZWZpeCA9IGJhc2VQcmVmaXggfHwgJyc7CiAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CiAgcGFyc2VBYnNvbHV0ZVVybChhcHBCYXNlLCB0aGlzLCBhcHBCYXNlKTsKCgogIC8qKgogICAqIFBhcnNlIGdpdmVuIGh0bWw1IChyZWd1bGFyKSB1cmwgc3RyaW5nIGludG8gcHJvcGVydGllcwogICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdBYnNvbHV0ZVVybCBIVE1MNSB1cmwKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIHBhdGhVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCk7CiAgICBpZiAoIWlzU3RyaW5nKHBhdGhVcmwpKSB7CiAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaXB0aHByZngnLCAnSW52YWxpZCB1cmwgInswfSIsIG1pc3NpbmcgcGF0aCBwcmVmaXggInsxfSIuJywgdXJsLAogICAgICAgICAgYXBwQmFzZU5vRmlsZSk7CiAgICB9CgogICAgcGFyc2VBcHBVcmwocGF0aFVybCwgdGhpcywgYXBwQmFzZSk7CgogICAgaWYgKCF0aGlzLiQkcGF0aCkgewogICAgICB0aGlzLiQkcGF0aCA9ICcvJzsKICAgIH0KCiAgICB0aGlzLiQkY29tcG9zZSgpOwogIH07CgogIC8qKgogICAqIENvbXBvc2UgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgdGhpcy4kJGFic1VybCA9IGFwcEJhc2VOb0ZpbGUgKyB0aGlzLiQkdXJsLnN1YnN0cigxKTsgLy8gZmlyc3QgY2hhciBpcyBhbHdheXMgJy8nCiAgfTsKCiAgdGhpcy4kJHJld3JpdGUgPSBmdW5jdGlvbih1cmwpIHsKICAgIHZhciBhcHBVcmwsIHByZXZBcHBVcmw7CgogICAgaWYgKCAoYXBwVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpKSAhPT0gdW5kZWZpbmVkICkgewogICAgICBwcmV2QXBwVXJsID0gYXBwVXJsOwogICAgICBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGJhc2VQcmVmaXgsIGFwcFVybCkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgcmV0dXJuIGFwcEJhc2VOb0ZpbGUgKyAoYmVnaW5zV2l0aCgnLycsIGFwcFVybCkgfHwgYXBwVXJsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYXBwQmFzZSArIHByZXZBcHBVcmw7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlICsgYXBwVXJsOwogICAgfSBlbHNlIGlmIChhcHBCYXNlTm9GaWxlID09IHVybCArICcvJykgewogICAgICByZXR1cm4gYXBwQmFzZU5vRmlsZTsKICAgIH0KICB9Owp9CgoKLyoqCiAqIExvY2F0aW9uSGFzaGJhbmdVcmwgcmVwcmVzZW50cyB1cmwKICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGRldmVsb3BlciBkb2Vzbid0IG9wdCBpbnRvIGh0bWw1IG1vZGUuCiAqIEl0IGFsc28gc2VydmVzIGFzIHRoZSBiYXNlIGNsYXNzIGZvciBodG1sNSBtb2RlIGZhbGxiYWNrIG9uIGxlZ2FjeSBicm93c2Vycy4KICoKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBCYXNlIGFwcGxpY2F0aW9uIGJhc2UgVVJMCiAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoUHJlZml4IGhhc2hiYW5nIHByZWZpeAogKi8KZnVuY3Rpb24gTG9jYXRpb25IYXNoYmFuZ1VybChhcHBCYXNlLCBoYXNoUHJlZml4KSB7CiAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CgogIHBhcnNlQWJzb2x1dGVVcmwoYXBwQmFzZSwgdGhpcywgYXBwQmFzZSk7CgoKICAvKioKICAgKiBQYXJzZSBnaXZlbiBoYXNoYmFuZyB1cmwgaW50byBwcm9wZXJ0aWVzCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBIYXNoYmFuZyB1cmwKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIHdpdGhvdXRCYXNlVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpIHx8IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKTsKICAgIHZhciB3aXRob3V0SGFzaFVybCA9IHdpdGhvdXRCYXNlVXJsLmNoYXJBdCgwKSA9PSAnIycKICAgICAgICA/IGJlZ2luc1dpdGgoaGFzaFByZWZpeCwgd2l0aG91dEJhc2VVcmwpCiAgICAgICAgOiAodGhpcy4kJGh0bWw1KQogICAgICAgICAgPyB3aXRob3V0QmFzZVVybAogICAgICAgICAgOiAnJzsKCiAgICBpZiAoIWlzU3RyaW5nKHdpdGhvdXRIYXNoVXJsKSkgewogICAgICB0aHJvdyAkbG9jYXRpb25NaW5FcnIoJ2loc2hwcmZ4JywgJ0ludmFsaWQgdXJsICJ7MH0iLCBtaXNzaW5nIGhhc2ggcHJlZml4ICJ7MX0iLicsIHVybCwKICAgICAgICAgIGhhc2hQcmVmaXgpOwogICAgfQogICAgcGFyc2VBcHBVcmwod2l0aG91dEhhc2hVcmwsIHRoaXMsIGFwcEJhc2UpOwoKICAgIHRoaXMuJCRwYXRoID0gcmVtb3ZlV2luZG93c0RyaXZlTmFtZSh0aGlzLiQkcGF0aCwgd2l0aG91dEhhc2hVcmwsIGFwcEJhc2UpOwoKICAgIHRoaXMuJCRjb21wb3NlKCk7CgogICAgLyoKICAgICAqIEluIFdpbmRvd3MsIG9uIGFuIGFuY2hvciBub2RlIG9uIGRvY3VtZW50cyBsb2FkZWQgZnJvbQogICAgICogdGhlIGZpbGVzeXN0ZW0sIHRoZSBicm93c2VyIHdpbGwgcmV0dXJuIGEgcGF0aG5hbWUKICAgICAqIHByZWZpeGVkIHdpdGggdGhlIGRyaXZlIG5hbWUgKCcvQzovcGF0aCcpIHdoZW4gYQogICAgICogcGF0aG5hbWUgd2l0aG91dCBhIGRyaXZlIGlzIHNldDoKICAgICAqICAqIGEuc2V0QXR0cmlidXRlKCdocmVmJywgJy9mb28nKQogICAgICogICAqIGEucGF0aG5hbWUgPT09ICcvQzovZm9vJyAvL3RydWUKICAgICAqCiAgICAgKiBJbnNpZGUgb2YgQW5ndWxhciwgd2UncmUgYWx3YXlzIHVzaW5nIHBhdGhuYW1lcyB0aGF0CiAgICAgKiBkbyBub3QgaW5jbHVkZSBkcml2ZSBuYW1lcyBmb3Igcm91dGluZy4KICAgICAqLwogICAgZnVuY3Rpb24gcmVtb3ZlV2luZG93c0RyaXZlTmFtZSAocGF0aCwgdXJsLCBiYXNlKSB7CiAgICAgIC8qCiAgICAgIE1hdGNoZXMgcGF0aHMgZm9yIGZpbGUgcHJvdG9jb2wgb24gd2luZG93cywKICAgICAgc3VjaCBhcyAvQzovZm9vL2JhciwgYW5kIGNhcHR1cmVzIG9ubHkgL2Zvby9iYXIuCiAgICAgICovCiAgICAgIHZhciB3aW5kb3dzRmlsZVBhdGhFeHAgPSAvXlwvW0EtWl06KFwvLiopLzsKCiAgICAgIHZhciBmaXJzdFBhdGhTZWdtZW50TWF0Y2g7CgogICAgICAvL0dldCB0aGUgcmVsYXRpdmUgcGF0aCBmcm9tIHRoZSBpbnB1dCBVUkwuCiAgICAgIGlmICh1cmwuaW5kZXhPZihiYXNlKSA9PT0gMCkgewogICAgICAgIHVybCA9IHVybC5yZXBsYWNlKGJhc2UsICcnKTsKICAgICAgfQoKICAgICAgLy8gVGhlIGlucHV0IFVSTCBpbnRlbnRpb25hbGx5IGNvbnRhaW5zIGEgZmlyc3QgcGF0aCBzZWdtZW50IHRoYXQgZW5kcyB3aXRoIGEgY29sb24uCiAgICAgIGlmICh3aW5kb3dzRmlsZVBhdGhFeHAuZXhlYyh1cmwpKSB7CiAgICAgICAgcmV0dXJuIHBhdGg7CiAgICAgIH0KCiAgICAgIGZpcnN0UGF0aFNlZ21lbnRNYXRjaCA9IHdpbmRvd3NGaWxlUGF0aEV4cC5leGVjKHBhdGgpOwogICAgICByZXR1cm4gZmlyc3RQYXRoU2VnbWVudE1hdGNoID8gZmlyc3RQYXRoU2VnbWVudE1hdGNoWzFdIDogcGF0aDsKICAgIH0KICB9OwoKICAvKioKICAgKiBDb21wb3NlIGhhc2hiYW5nIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICogQHByaXZhdGUKICAgKi8KICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgIHRoaXMuJCRhYnNVcmwgPSBhcHBCYXNlICsgKHRoaXMuJCR1cmwgPyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybCA6ICcnKTsKICB9OwoKICB0aGlzLiQkcmV3cml0ZSA9IGZ1bmN0aW9uKHVybCkgewogICAgaWYoc3RyaXBIYXNoKGFwcEJhc2UpID09IHN0cmlwSGFzaCh1cmwpKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgfTsKfQoKCi8qKgogKiBMb2NhdGlvbkhhc2hiYW5nVXJsIHJlcHJlc2VudHMgdXJsCiAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBodG1sNSBoaXN0b3J5IGFwaSBpcyBlbmFibGVkIGJ1dCB0aGUgYnJvd3NlcgogKiBkb2VzIG5vdCBzdXBwb3J0IGl0LgogKgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggaGFzaGJhbmcgcHJlZml4CiAqLwpmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybChhcHBCYXNlLCBoYXNoUHJlZml4KSB7CiAgdGhpcy4kJGh0bWw1ID0gdHJ1ZTsKICBMb2NhdGlvbkhhc2hiYW5nVXJsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHZhciBhcHBCYXNlTm9GaWxlID0gc3RyaXBGaWxlKGFwcEJhc2UpOwoKICB0aGlzLiQkcmV3cml0ZSA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIGFwcFVybDsKCiAgICBpZiAoIGFwcEJhc2UgPT0gc3RyaXBIYXNoKHVybCkgKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9IGVsc2UgaWYgKCAoYXBwVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlTm9GaWxlLCB1cmwpKSApIHsKICAgICAgcmV0dXJuIGFwcEJhc2UgKyBoYXNoUHJlZml4ICsgYXBwVXJsOwogICAgfSBlbHNlIGlmICggYXBwQmFzZU5vRmlsZSA9PT0gdXJsICsgJy8nKSB7CiAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlOwogICAgfQogIH07CgogIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgLy8gaW5jbHVkZSBoYXNoUHJlZml4IGluICQkYWJzVXJsIHdoZW4gJCR1cmwgaXMgZW1wdHkgc28gSUU4ICYgOSBkbyBub3QgcmVsb2FkIHBhZ2UgYmVjYXVzZSBvZiByZW1vdmFsIG9mICcjJwogICAgdGhpcy4kJGFic1VybCA9IGFwcEJhc2UgKyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybDsKICB9OwoKfQoKCkxvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsLnByb3RvdHlwZSA9CiAgTG9jYXRpb25IYXNoYmFuZ1VybC5wcm90b3R5cGUgPQogIExvY2F0aW9uSHRtbDVVcmwucHJvdG90eXBlID0gewoKICAvKioKICAgKiBBcmUgd2UgaW4gaHRtbDUgbW9kZT8KICAgKiBAcHJpdmF0ZQogICAqLwogICQkaHRtbDU6IGZhbHNlLAoKICAvKioKICAgKiBIYXMgYW55IGNoYW5nZSBiZWVuIHJlcGxhY2luZyA/CiAgICogQHByaXZhdGUKICAgKi8KICAkJHJlcGxhY2U6IGZhbHNlLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI2Fic1VybAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICoKICAgKiBSZXR1cm4gZnVsbCB1cmwgcmVwcmVzZW50YXRpb24gd2l0aCBhbGwgc2VnbWVudHMgZW5jb2RlZCBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICogW1JGQyAzOTg2XShodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMzOTg2LnR4dCkuCiAgICoKICAgKiBAcmV0dXJuIHtzdHJpbmd9IGZ1bGwgdXJsCiAgICovCiAgYWJzVXJsOiBsb2NhdGlvbkdldHRlcignJCRhYnNVcmwnKSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiN1cmwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgKgogICAqIFJldHVybiB1cmwgKGUuZy4gYC9wYXRoP2E9YiNoYXNoYCkgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAqCiAgICogQ2hhbmdlIHBhdGgsIHNlYXJjaCBhbmQgaGFzaCwgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdXJsIE5ldyB1cmwgd2l0aG91dCBiYXNlIHByZWZpeCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKQogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVwbGFjZSBUaGUgcGF0aCB0aGF0IHdpbGwgYmUgY2hhbmdlZAogICAqIEByZXR1cm4ge3N0cmluZ30gdXJsCiAgICovCiAgdXJsOiBmdW5jdGlvbih1cmwsIHJlcGxhY2UpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh1cmwpKQogICAgICByZXR1cm4gdGhpcy4kJHVybDsKCiAgICB2YXIgbWF0Y2ggPSBQQVRIX01BVENILmV4ZWModXJsKTsKICAgIGlmIChtYXRjaFsxXSkgdGhpcy5wYXRoKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSkpOwogICAgaWYgKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSB0aGlzLnNlYXJjaChtYXRjaFszXSB8fCAnJyk7CiAgICB0aGlzLmhhc2gobWF0Y2hbNV0gfHwgJycsIHJlcGxhY2UpOwoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jcHJvdG9jb2wKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAqCiAgICogUmV0dXJuIHByb3RvY29sIG9mIGN1cnJlbnQgdXJsLgogICAqCiAgICogQHJldHVybiB7c3RyaW5nfSBwcm90b2NvbCBvZiBjdXJyZW50IHVybAogICAqLwogIHByb3RvY29sOiBsb2NhdGlvbkdldHRlcignJCRwcm90b2NvbCcpLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI2hvc3QKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAqCiAgICogUmV0dXJuIGhvc3Qgb2YgY3VycmVudCB1cmwuCiAgICoKICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhvc3Qgb2YgY3VycmVudCB1cmwuCiAgICovCiAgaG9zdDogbG9jYXRpb25HZXR0ZXIoJyQkaG9zdCcpLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3BvcnQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAqCiAgICogUmV0dXJuIHBvcnQgb2YgY3VycmVudCB1cmwuCiAgICoKICAgKiBAcmV0dXJuIHtOdW1iZXJ9IHBvcnQKICAgKi8KICBwb3J0OiBsb2NhdGlvbkdldHRlcignJCRwb3J0JyksCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jcGF0aAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAqCiAgICogUmV0dXJuIHBhdGggb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAqCiAgICogQ2hhbmdlIHBhdGggd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgKgogICAqIE5vdGU6IFBhdGggc2hvdWxkIGFsd2F5cyBiZWdpbiB3aXRoIGZvcndhcmQgc2xhc2ggKC8pLCB0aGlzIG1ldGhvZCB3aWxsIGFkZCB0aGUgZm9yd2FyZCBzbGFzaAogICAqIGlmIGl0IGlzIG1pc3NpbmcuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHBhdGggTmV3IHBhdGgKICAgKiBAcmV0dXJuIHtzdHJpbmd9IHBhdGgKICAgKi8KICBwYXRoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRwYXRoJywgZnVuY3Rpb24ocGF0aCkgewogICAgcmV0dXJuIHBhdGguY2hhckF0KDApID09ICcvJyA/IHBhdGggOiAnLycgKyBwYXRoOwogIH0pLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3NlYXJjaAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAqCiAgICogUmV0dXJuIHNlYXJjaCBwYXJ0IChhcyBvYmplY3QpIG9mIGN1cnJlbnQgdXJsIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgKgogICAqIENoYW5nZSBzZWFyY2ggcGFydCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAqCiAgICoKICAgKiBgYGBqcwogICAqIC8vIGdpdmVuIHVybCBodHRwOi8vZXhhbXBsZS5jb20vIy9zb21lL3BhdGg/Zm9vPWJhciZiYXo9eG94bwogICAqIHZhciBzZWFyY2hPYmplY3QgPSAkbG9jYXRpb24uc2VhcmNoKCk7CiAgICogLy8gPT4ge2ZvbzogJ2JhcicsIGJhejogJ3hveG8nfQogICAqCiAgICoKICAgKiAvLyBzZXQgZm9vIHRvICd5aXBlZScKICAgKiAkbG9jYXRpb24uc2VhcmNoKCdmb28nLCAneWlwZWUnKTsKICAgKiAvLyA9PiAkbG9jYXRpb24KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdC48c3RyaW5nPnxPYmplY3QuPEFycmF5LjxzdHJpbmc+Pn0gc2VhcmNoIE5ldyBzZWFyY2ggcGFyYW1zIC0gc3RyaW5nIG9yCiAgICogaGFzaCBvYmplY3QuCiAgICoKICAgKiBXaGVuIGNhbGxlZCB3aXRoIGEgc2luZ2xlIGFyZ3VtZW50IHRoZSBtZXRob2QgYWN0cyBhcyBhIHNldHRlciwgc2V0dGluZyB0aGUgYHNlYXJjaGAgY29tcG9uZW50CiAgICogb2YgYCRsb2NhdGlvbmAgdG8gdGhlIHNwZWNpZmllZCB2YWx1ZS4KICAgKgogICAqIElmIHRoZSBhcmd1bWVudCBpcyBhIGhhc2ggb2JqZWN0IGNvbnRhaW5pbmcgYW4gYXJyYXkgb2YgdmFsdWVzLCB0aGVzZSB2YWx1ZXMgd2lsbCBiZSBlbmNvZGVkCiAgICogYXMgZHVwbGljYXRlIHNlYXJjaCBwYXJhbWV0ZXJzIGluIHRoZSB1cmwuCiAgICoKICAgKiBAcGFyYW0geyhzdHJpbmd8QXJyYXk8c3RyaW5nPik9fSBwYXJhbVZhbHVlIElmIGBzZWFyY2hgIGlzIGEgc3RyaW5nLCB0aGVuIGBwYXJhbVZhbHVlYCB3aWxsCiAgICogb3ZlcnJpZGUgb25seSBhIHNpbmdsZSBzZWFyY2ggcHJvcGVydHkuCiAgICoKICAgKiBJZiBgcGFyYW1WYWx1ZWAgaXMgYW4gYXJyYXksIGl0IHdpbGwgb3ZlcnJpZGUgdGhlIHByb3BlcnR5IG9mIHRoZSBgc2VhcmNoYCBjb21wb25lbnQgb2YKICAgKiBgJGxvY2F0aW9uYCBzcGVjaWZpZWQgdmlhIHRoZSBmaXJzdCBhcmd1bWVudC4KICAgKgogICAqIElmIGBwYXJhbVZhbHVlYCBpcyBgbnVsbGAsIHRoZSBwcm9wZXJ0eSBzcGVjaWZpZWQgdmlhIHRoZSBmaXJzdCBhcmd1bWVudCB3aWxsIGJlIGRlbGV0ZWQuCiAgICoKICAgKiBAcmV0dXJuIHtPYmplY3R9IElmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIHRoZSBwYXJzZWQgYHNlYXJjaGAgb2JqZWN0LiBJZiBjYWxsZWQgd2l0aAogICAqIG9uZSBvciBtb3JlIGFyZ3VtZW50cyByZXR1cm5zIGAkbG9jYXRpb25gIG9iamVjdCBpdHNlbGYuCiAgICovCiAgc2VhcmNoOiBmdW5jdGlvbihzZWFyY2gsIHBhcmFtVmFsdWUpIHsKICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMuJCRzZWFyY2g7CiAgICAgIGNhc2UgMToKICAgICAgICBpZiAoaXNTdHJpbmcoc2VhcmNoKSkgewogICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IHBhcnNlS2V5VmFsdWUoc2VhcmNoKTsKICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNlYXJjaCkpIHsKICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBzZWFyY2g7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaXNyY2hhcmcnLAogICAgICAgICAgICAgICdUaGUgZmlyc3QgYXJndW1lbnQgb2YgdGhlIGAkbG9jYXRpb24jc2VhcmNoKClgIGNhbGwgbXVzdCBiZSBhIHN0cmluZyBvciBhbiBvYmplY3QuJyk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIGlmIChpc1VuZGVmaW5lZChwYXJhbVZhbHVlKSB8fCBwYXJhbVZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICBkZWxldGUgdGhpcy4kJHNlYXJjaFtzZWFyY2hdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiQkc2VhcmNoW3NlYXJjaF0gPSBwYXJhbVZhbHVlOwogICAgICAgIH0KICAgIH0KCiAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNoYXNoCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICoKICAgKiBSZXR1cm4gaGFzaCBmcmFnbWVudCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICoKICAgKiBDaGFuZ2UgaGFzaCBmcmFnbWVudCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBoYXNoIE5ldyBoYXNoIGZyYWdtZW50CiAgICogQHJldHVybiB7c3RyaW5nfSBoYXNoCiAgICovCiAgaGFzaDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkaGFzaCcsIGlkZW50aXR5KSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNyZXBsYWNlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJZiBjYWxsZWQsIGFsbCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBkdXJpbmcgY3VycmVudCBgJGRpZ2VzdGAgd2lsbCBiZSByZXBsYWNpbmcgY3VycmVudCBoaXN0b3J5CiAgICogcmVjb3JkLCBpbnN0ZWFkIG9mIGFkZGluZyBuZXcgb25lLgogICAqLwogIHJlcGxhY2U6IGZ1bmN0aW9uKCkgewogICAgdGhpcy4kJHJlcGxhY2UgPSB0cnVlOwogICAgcmV0dXJuIHRoaXM7CiAgfQp9OwoKZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXIocHJvcGVydHkpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CiAgfTsKfQoKCmZ1bmN0aW9uIGxvY2F0aW9uR2V0dGVyU2V0dGVyKHByb3BlcnR5LCBwcmVwcm9jZXNzKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CgogICAgdGhpc1twcm9wZXJ0eV0gPSBwcmVwcm9jZXNzKHZhbHVlKTsKICAgIHRoaXMuJCRjb21wb3NlKCk7CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKfQoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkbG9jYXRpb24KICoKICogQHJlcXVpcmVzICRyb290RWxlbWVudAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlICRsb2NhdGlvbiBzZXJ2aWNlIHBhcnNlcyB0aGUgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyIChiYXNlZCBvbiB0aGUKICogW3dpbmRvdy5sb2NhdGlvbl0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vd2luZG93LmxvY2F0aW9uKSkgYW5kIG1ha2VzIHRoZSBVUkwKICogYXZhaWxhYmxlIHRvIHlvdXIgYXBwbGljYXRpb24uIENoYW5nZXMgdG8gdGhlIFVSTCBpbiB0aGUgYWRkcmVzcyBiYXIgYXJlIHJlZmxlY3RlZCBpbnRvCiAqICRsb2NhdGlvbiBzZXJ2aWNlIGFuZCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBhcmUgcmVmbGVjdGVkIGludG8gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIuCiAqCiAqICoqVGhlICRsb2NhdGlvbiBzZXJ2aWNlOioqCiAqCiAqIC0gRXhwb3NlcyB0aGUgY3VycmVudCBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIsIHNvIHlvdSBjYW4KICogICAtIFdhdGNoIGFuZCBvYnNlcnZlIHRoZSBVUkwuCiAqICAgLSBDaGFuZ2UgdGhlIFVSTC4KICogLSBTeW5jaHJvbml6ZXMgdGhlIFVSTCB3aXRoIHRoZSBicm93c2VyIHdoZW4gdGhlIHVzZXIKICogICAtIENoYW5nZXMgdGhlIGFkZHJlc3MgYmFyLgogKiAgIC0gQ2xpY2tzIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIChvciBjbGlja3MgYSBIaXN0b3J5IGxpbmspLgogKiAgIC0gQ2xpY2tzIG9uIGEgbGluay4KICogLSBSZXByZXNlbnRzIHRoZSBVUkwgb2JqZWN0IGFzIGEgc2V0IG9mIG1ldGhvZHMgKHByb3RvY29sLCBob3N0LCBwb3J0LCBwYXRoLCBzZWFyY2gsIGhhc2gpLgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUge0BsaW5rIGd1aWRlLyRsb2NhdGlvbiBEZXZlbG9wZXIgR3VpZGU6IFVzaW5nICRsb2NhdGlvbn0KICovCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRsb2NhdGlvblByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKiBVc2UgdGhlIGAkbG9jYXRpb25Qcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gZGVlcCBsaW5raW5nIHBhdGhzIGFyZSBzdG9yZWQuCiAqLwpmdW5jdGlvbiAkTG9jYXRpb25Qcm92aWRlcigpewogIHZhciBoYXNoUHJlZml4ID0gJycsCiAgICAgIGh0bWw1TW9kZSA9IGZhbHNlOwoKICAvKioKICAgKiBAbmdkb2MgcHJvcGVydHkKICAgKiBAbmFtZSAkbG9jYXRpb25Qcm92aWRlciNoYXNoUHJlZml4CiAgICogQGRlc2NyaXB0aW9uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBwcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICovCiAgdGhpcy5oYXNoUHJlZml4ID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICBpZiAoaXNEZWZpbmVkKHByZWZpeCkpIHsKICAgICAgaGFzaFByZWZpeCA9IHByZWZpeDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaGFzaFByZWZpeDsKICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgcHJvcGVydHkKICAgKiBAbmFtZSAkbG9jYXRpb25Qcm92aWRlciNodG1sNU1vZGUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBtb2RlIFVzZSBIVE1MNSBzdHJhdGVneSBpZiBhdmFpbGFibGUuCiAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgKi8KICB0aGlzLmh0bWw1TW9kZSA9IGZ1bmN0aW9uKG1vZGUpIHsKICAgIGlmIChpc0RlZmluZWQobW9kZSkpIHsKICAgICAgaHRtbDVNb2RlID0gbW9kZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaHRtbDVNb2RlOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBldmVudAogICAqIEBuYW1lICRsb2NhdGlvbiMkbG9jYXRpb25DaGFuZ2VTdGFydAogICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBCcm9hZGNhc3RlZCBiZWZvcmUgYSBVUkwgd2lsbCBjaGFuZ2UuIFRoaXMgY2hhbmdlIGNhbiBiZSBwcmV2ZW50ZWQgYnkgY2FsbGluZwogICAqIGBwcmV2ZW50RGVmYXVsdGAgbWV0aG9kIG9mIHRoZSBldmVudC4gU2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gZm9yIG1vcmUKICAgKiBkZXRhaWxzIGFib3V0IGV2ZW50IG9iamVjdC4gVXBvbiBzdWNjZXNzZnVsIGNoYW5nZQogICAqIHtAbGluayBuZy4kbG9jYXRpb24jZXZlbnRzXyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MgJGxvY2F0aW9uQ2hhbmdlU3VjY2Vzc30gaXMgZmlyZWQuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gYW5ndWxhckV2ZW50IFN5bnRoZXRpYyBldmVudCBvYmplY3QuCiAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1VybCBOZXcgVVJMCiAgICogQHBhcmFtIHtzdHJpbmc9fSBvbGRVcmwgVVJMIHRoYXQgd2FzIGJlZm9yZSBpdCB3YXMgY2hhbmdlZC4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGV2ZW50CiAgICogQG5hbWUgJGxvY2F0aW9uIyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MKICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICogQGRlc2NyaXB0aW9uCiAgICogQnJvYWRjYXN0ZWQgYWZ0ZXIgYSBVUkwgd2FzIGNoYW5nZWQuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gYW5ndWxhckV2ZW50IFN5bnRoZXRpYyBldmVudCBvYmplY3QuCiAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1VybCBOZXcgVVJMCiAgICogQHBhcmFtIHtzdHJpbmc9fSBvbGRVcmwgVVJMIHRoYXQgd2FzIGJlZm9yZSBpdCB3YXMgY2hhbmdlZC4KICAgKi8KCiAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRicm93c2VyJywgJyRzbmlmZmVyJywgJyRyb290RWxlbWVudCcsCiAgICAgIGZ1bmN0aW9uKCAkcm9vdFNjb3BlLCAgICRicm93c2VyLCAgICRzbmlmZmVyLCAgICRyb290RWxlbWVudCkgewogICAgdmFyICRsb2NhdGlvbiwKICAgICAgICBMb2NhdGlvbk1vZGUsCiAgICAgICAgYmFzZUhyZWYgPSAkYnJvd3Nlci5iYXNlSHJlZigpLCAvLyBpZiBiYXNlW2hyZWZdIGlzIHVuZGVmaW5lZCwgaXQgZGVmYXVsdHMgdG8gJycKICAgICAgICBpbml0aWFsVXJsID0gJGJyb3dzZXIudXJsKCksCiAgICAgICAgYXBwQmFzZTsKCiAgICBpZiAoaHRtbDVNb2RlKSB7CiAgICAgIGFwcEJhc2UgPSBzZXJ2ZXJCYXNlKGluaXRpYWxVcmwpICsgKGJhc2VIcmVmIHx8ICcvJyk7CiAgICAgIExvY2F0aW9uTW9kZSA9ICRzbmlmZmVyLmhpc3RvcnkgPyBMb2NhdGlvbkh0bWw1VXJsIDogTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmw7CiAgICB9IGVsc2UgewogICAgICBhcHBCYXNlID0gc3RyaXBIYXNoKGluaXRpYWxVcmwpOwogICAgICBMb2NhdGlvbk1vZGUgPSBMb2NhdGlvbkhhc2hiYW5nVXJsOwogICAgfQogICAgJGxvY2F0aW9uID0gbmV3IExvY2F0aW9uTW9kZShhcHBCYXNlLCAnIycgKyBoYXNoUHJlZml4KTsKICAgICRsb2NhdGlvbi4kJHBhcnNlKCRsb2NhdGlvbi4kJHJld3JpdGUoaW5pdGlhbFVybCkpOwoKICAgICRyb290RWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCkgewogICAgICAvLyBUT0RPKHZvanRhKTogcmV3cml0ZSBsaW5rIHdoZW4gb3BlbmluZyBpbiBuZXcgdGFiL3dpbmRvdyAoaW4gbGVnYWN5IGJyb3dzZXIpCiAgICAgIC8vIGN1cnJlbnRseSB3ZSBvcGVuIG5pY2UgdXJsIGxpbmsgYW5kIHJlZGlyZWN0IHRoZW4KCiAgICAgIGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQud2hpY2ggPT0gMikgcmV0dXJuOwoKICAgICAgdmFyIGVsbSA9IGpxTGl0ZShldmVudC50YXJnZXQpOwoKICAgICAgLy8gdHJhdmVyc2UgdGhlIERPTSB1cCB0byBmaW5kIGZpcnN0IEEgdGFnCiAgICAgIHdoaWxlIChsb3dlcmNhc2UoZWxtWzBdLm5vZGVOYW1lKSAhPT0gJ2EnKSB7CiAgICAgICAgLy8gaWdub3JlIHJld3JpdGluZyBpZiBubyBBIHRhZyAocmVhY2hlZCByb290IGVsZW1lbnQsIG9yIG5vIHBhcmVudCAtIHJlbW92ZWQgZnJvbSBkb2N1bWVudCkKICAgICAgICBpZiAoZWxtWzBdID09PSAkcm9vdEVsZW1lbnRbMF0gfHwgIShlbG0gPSBlbG0ucGFyZW50KCkpWzBdKSByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBhYnNIcmVmID0gZWxtLnByb3AoJ2hyZWYnKTsKCiAgICAgIGlmIChpc09iamVjdChhYnNIcmVmKSAmJiBhYnNIcmVmLnRvU3RyaW5nKCkgPT09ICdbb2JqZWN0IFNWR0FuaW1hdGVkU3RyaW5nXScpIHsKICAgICAgICAvLyBTVkdBbmltYXRlZFN0cmluZy5hbmltVmFsIHNob3VsZCBiZSBpZGVudGljYWwgdG8gU1ZHQW5pbWF0ZWRTdHJpbmcuYmFzZVZhbCwgdW5sZXNzIGR1cmluZwogICAgICAgIC8vIGFuIGFuaW1hdGlvbi4KICAgICAgICBhYnNIcmVmID0gdXJsUmVzb2x2ZShhYnNIcmVmLmFuaW1WYWwpLmhyZWY7CiAgICAgIH0KCiAgICAgIC8vIE1ha2UgcmVsYXRpdmUgbGlua3Mgd29yayBpbiBIVE1MNSBtb2RlIGZvciBsZWdhY3kgYnJvd3NlcnMgKG9yIGF0IGxlYXN0IElFOCAmIDkpCiAgICAgIC8vIFRoZSBocmVmIHNob3VsZCBiZSBhIHJlZ3VsYXIgdXJsIGUuZy4gL2xpbmsvc29tZXdoZXJlIG9yIGxpbmsvc29tZXdoZXJlIG9yIC4uL3NvbWV3aGVyZSBvcgogICAgICAvLyBzb21ld2hlcmUjYW5jaG9yIG9yIGh0dHA6Ly9leGFtcGxlLmNvbS9zb21ld2hlcmUKICAgICAgaWYgKExvY2F0aW9uTW9kZSA9PT0gTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwpIHsKICAgICAgICAvLyBnZXQgdGhlIGFjdHVhbCBocmVmIGF0dHJpYnV0ZSAtIHNlZQogICAgICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9kZDM0NzE0OCh2PXZzLjg1KS5hc3B4CiAgICAgICAgdmFyIGhyZWYgPSBlbG0uYXR0cignaHJlZicpIHx8IGVsbS5hdHRyKCd4bGluazpocmVmJyk7CgogICAgICAgIGlmIChocmVmLmluZGV4T2YoJzovLycpIDwgMCkgeyAgICAgICAgIC8vIElnbm9yZSBhYnNvbHV0ZSBVUkxzCiAgICAgICAgICB2YXIgcHJlZml4ID0gJyMnICsgaGFzaFByZWZpeDsKICAgICAgICAgIGlmIChocmVmWzBdID09ICcvJykgewogICAgICAgICAgICAvLyBhYnNvbHV0ZSBwYXRoIC0gcmVwbGFjZSBvbGQgcGF0aAogICAgICAgICAgICBhYnNIcmVmID0gYXBwQmFzZSArIHByZWZpeCArIGhyZWY7CiAgICAgICAgICB9IGVsc2UgaWYgKGhyZWZbMF0gPT0gJyMnKSB7CiAgICAgICAgICAgIC8vIGxvY2FsIGFuY2hvcgogICAgICAgICAgICBhYnNIcmVmID0gYXBwQmFzZSArIHByZWZpeCArICgkbG9jYXRpb24ucGF0aCgpIHx8ICcvJykgKyBocmVmOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gcmVsYXRpdmUgcGF0aCAtIGpvaW4gd2l0aCBjdXJyZW50IHBhdGgKICAgICAgICAgICAgdmFyIHN0YWNrID0gJGxvY2F0aW9uLnBhdGgoKS5zcGxpdCgiLyIpLAogICAgICAgICAgICAgIHBhcnRzID0gaHJlZi5zcGxpdCgiLyIpOwogICAgICAgICAgICBmb3IgKHZhciBpPTA7IGk8cGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAocGFydHNbaV0gPT0gIi4iKQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgZWxzZSBpZiAocGFydHNbaV0gPT0gIi4uIikKICAgICAgICAgICAgICAgIHN0YWNrLnBvcCgpOwogICAgICAgICAgICAgIGVsc2UgaWYgKHBhcnRzW2ldLmxlbmd0aCkKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gocGFydHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFic0hyZWYgPSBhcHBCYXNlICsgcHJlZml4ICsgc3RhY2suam9pbignLycpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHJld3JpdHRlblVybCA9ICRsb2NhdGlvbi4kJHJld3JpdGUoYWJzSHJlZik7CgogICAgICBpZiAoYWJzSHJlZiAmJiAhZWxtLmF0dHIoJ3RhcmdldCcpICYmIHJld3JpdHRlblVybCAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGlmIChyZXdyaXR0ZW5VcmwgIT0gJGJyb3dzZXIudXJsKCkpIHsKICAgICAgICAgIC8vIHVwZGF0ZSBsb2NhdGlvbiBtYW51YWxseQogICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2UocmV3cml0dGVuVXJsKTsKICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAvLyBoYWNrIHRvIHdvcmsgYXJvdW5kIEZGNiBidWcgNjg0MjA4IHdoZW4gc2NlbmFyaW8gcnVubmVyIGNsaWNrcyBvbiBsaW5rcwogICAgICAgICAgd2luZG93LmFuZ3VsYXJbJ2ZmLTY4NDIwOC1wcmV2ZW50RGVmYXVsdCddID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKCiAgICAvLyByZXdyaXRlIGhhc2hiYW5nIHVybCA8PiBodG1sNSB1cmwKICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gaW5pdGlhbFVybCkgewogICAgICAkYnJvd3Nlci51cmwoJGxvY2F0aW9uLmFic1VybCgpLCB0cnVlKTsKICAgIH0KCiAgICAvLyB1cGRhdGUgJGxvY2F0aW9uIHdoZW4gJGJyb3dzZXIgdXJsIGNoYW5nZXMKICAgICRicm93c2VyLm9uVXJsQ2hhbmdlKGZ1bmN0aW9uKG5ld1VybCkgewogICAgICBpZiAoJGxvY2F0aW9uLmFic1VybCgpICE9IG5ld1VybCkgewogICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBvbGRVcmwgPSAkbG9jYXRpb24uYWJzVXJsKCk7CgogICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2UobmV3VXJsKTsKICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN0YXJ0JywgbmV3VXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRVcmwpLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgICAgJGJyb3dzZXIudXJsKG9sZFVybCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICB9CiAgICB9KTsKCiAgICAvLyB1cGRhdGUgYnJvd3NlcgogICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwOwogICAgJHJvb3RTY29wZS4kd2F0Y2goZnVuY3Rpb24gJGxvY2F0aW9uV2F0Y2goKSB7CiAgICAgIHZhciBvbGRVcmwgPSAkYnJvd3Nlci51cmwoKTsKICAgICAgdmFyIGN1cnJlbnRSZXBsYWNlID0gJGxvY2F0aW9uLiQkcmVwbGFjZTsKCiAgICAgIGlmICghY2hhbmdlQ291bnRlciB8fCBvbGRVcmwgIT0gJGxvY2F0aW9uLmFic1VybCgpKSB7CiAgICAgICAgY2hhbmdlQ291bnRlcisrOwogICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN0YXJ0JywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpLgogICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIGN1cnJlbnRSZXBsYWNlKTsKICAgICAgICAgICAgYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgICRsb2NhdGlvbi4kJHJlcGxhY2UgPSBmYWxzZTsKCiAgICAgIHJldHVybiBjaGFuZ2VDb3VudGVyOwogICAgfSk7CgogICAgcmV0dXJuICRsb2NhdGlvbjsKCiAgICBmdW5jdGlvbiBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCkgewogICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MnLCAkbG9jYXRpb24uYWJzVXJsKCksIG9sZFVybCk7CiAgICB9Cn1dOwp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGxvZwogKiBAcmVxdWlyZXMgJHdpbmRvdwogKgogKiBAZGVzY3JpcHRpb24KICogU2ltcGxlIHNlcnZpY2UgZm9yIGxvZ2dpbmcuIERlZmF1bHQgaW1wbGVtZW50YXRpb24gc2FmZWx5IHdyaXRlcyB0aGUgbWVzc2FnZQogKiBpbnRvIHRoZSBicm93c2VyJ3MgY29uc29sZSAoaWYgcHJlc2VudCkuCiAqCiAqIFRoZSBtYWluIHB1cnBvc2Ugb2YgdGhpcyBzZXJ2aWNlIGlzIHRvIHNpbXBsaWZ5IGRlYnVnZ2luZyBhbmQgdHJvdWJsZXNob290aW5nLgogKgogKiBUaGUgZGVmYXVsdCBpcyB0byBsb2cgYGRlYnVnYCBtZXNzYWdlcy4gWW91IGNhbiB1c2UKICoge0BsaW5rIG5nLiRsb2dQcm92aWRlciBuZy4kbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkfSB0byBjaGFuZ2UgdGhpcy4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgIGZ1bmN0aW9uIExvZ0N0cmwoJHNjb3BlLCAkbG9nKSB7CiAgICAgICAgICRzY29wZS4kbG9nID0gJGxvZzsKICAgICAgICAgJHNjb3BlLm1lc3NhZ2UgPSAnSGVsbG8gV29ybGQhJzsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkxvZ0N0cmwiPgogICAgICAgICA8cD5SZWxvYWQgdGhpcyBwYWdlIHdpdGggb3BlbiBjb25zb2xlLCBlbnRlciB0ZXh0IGFuZCBoaXQgdGhlIGxvZyBidXR0b24uLi48L3A+CiAgICAgICAgIE1lc3NhZ2U6CiAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibWVzc2FnZSIvPgogICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmxvZyhtZXNzYWdlKSI+bG9nPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cud2FybihtZXNzYWdlKSI+d2FybjwvYnV0dG9uPgogICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy5lcnJvcihtZXNzYWdlKSI+ZXJyb3I8L2J1dHRvbj4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGxvZ1Byb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKiBVc2UgdGhlIGAkbG9nUHJvdmlkZXJgIHRvIGNvbmZpZ3VyZSBob3cgdGhlIGFwcGxpY2F0aW9uIGxvZ3MgbWVzc2FnZXMKICovCmZ1bmN0aW9uICRMb2dQcm92aWRlcigpewogIHZhciBkZWJ1ZyA9IHRydWUsCiAgICAgIHNlbGYgPSB0aGlzOwoKICAvKioKICAgKiBAbmdkb2MgcHJvcGVydHkKICAgKiBAbmFtZSAkbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkCiAgICogQGRlc2NyaXB0aW9uCiAgICogQHBhcmFtIHtib29sZWFuPX0gZmxhZyBlbmFibGUgb3IgZGlzYWJsZSBkZWJ1ZyBsZXZlbCBtZXNzYWdlcwogICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICovCiAgdGhpcy5kZWJ1Z0VuYWJsZWQgPSBmdW5jdGlvbihmbGFnKSB7CiAgICBpZiAoaXNEZWZpbmVkKGZsYWcpKSB7CiAgICAgIGRlYnVnID0gZmxhZzsKICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGRlYnVnOwogICAgfQogIH07CgogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uKCR3aW5kb3cpewogICAgcmV0dXJuIHsKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGxvZyNsb2cKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFdyaXRlIGEgbG9nIG1lc3NhZ2UKICAgICAgICovCiAgICAgIGxvZzogY29uc29sZUxvZygnbG9nJyksCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkbG9nI2luZm8KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFdyaXRlIGFuIGluZm9ybWF0aW9uIG1lc3NhZ2UKICAgICAgICovCiAgICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRsb2cjd2FybgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYSB3YXJuaW5nIG1lc3NhZ2UKICAgICAgICovCiAgICAgIHdhcm46IGNvbnNvbGVMb2coJ3dhcm4nKSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRsb2cjZXJyb3IKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFdyaXRlIGFuIGVycm9yIG1lc3NhZ2UKICAgICAgICovCiAgICAgIGVycm9yOiBjb25zb2xlTG9nKCdlcnJvcicpLAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGxvZyNkZWJ1ZwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYSBkZWJ1ZyBtZXNzYWdlCiAgICAgICAqLwogICAgICBkZWJ1ZzogKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZm4gPSBjb25zb2xlTG9nKCdkZWJ1ZycpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoZGVidWcpIHsKICAgICAgICAgICAgZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9KCkpCiAgICB9OwoKICAgIGZ1bmN0aW9uIGZvcm1hdEVycm9yKGFyZykgewogICAgICBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICBpZiAoYXJnLnN0YWNrKSB7CiAgICAgICAgICBhcmcgPSAoYXJnLm1lc3NhZ2UgJiYgYXJnLnN0YWNrLmluZGV4T2YoYXJnLm1lc3NhZ2UpID09PSAtMSkKICAgICAgICAgICAgICA/ICdFcnJvcjogJyArIGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zdGFjawogICAgICAgICAgICAgIDogYXJnLnN0YWNrOwogICAgICAgIH0gZWxzZSBpZiAoYXJnLnNvdXJjZVVSTCkgewogICAgICAgICAgYXJnID0gYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnNvdXJjZVVSTCArICc6JyArIGFyZy5saW5lOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbnNvbGVMb2codHlwZSkgewogICAgICB2YXIgY29uc29sZSA9ICR3aW5kb3cuY29uc29sZSB8fCB7fSwKICAgICAgICAgIGxvZ0ZuID0gY29uc29sZVt0eXBlXSB8fCBjb25zb2xlLmxvZyB8fCBub29wLAogICAgICAgICAgaGFzQXBwbHkgPSBmYWxzZTsKCiAgICAgIC8vIE5vdGU6IHJlYWRpbmcgbG9nRm4uYXBwbHkgdGhyb3dzIGFuIGVycm9yIGluIElFMTEgaW4gSUU4IGRvY3VtZW50IG1vZGUuCiAgICAgIC8vIFRoZSByZWFzb24gYmVoaW5kIHRoaXMgaXMgdGhhdCBjb25zb2xlLmxvZyBoYXMgdHlwZSAib2JqZWN0IiBpbiBJRTguLi4KICAgICAgdHJ5IHsKICAgICAgICBoYXNBcHBseSA9ICEhbG9nRm4uYXBwbHk7CiAgICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgICBpZiAoaGFzQXBwbHkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICBhcmdzLnB1c2goZm9ybWF0RXJyb3IoYXJnKSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsb2dGbi5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9CgogICAgICAvLyB3ZSBhcmUgSUUgd2hpY2ggZWl0aGVyIGRvZXNuJ3QgaGF2ZSB3aW5kb3cuY29uc29sZSA9PiB0aGlzIGlzIG5vb3AgYW5kIHdlIGRvIG5vdGhpbmcsCiAgICAgIC8vIG9yIHdlIGFyZSBJRSB3aGVyZSBjb25zb2xlLmxvZyBkb2Vzbid0IGhhdmUgYXBwbHkgc28gd2UgbG9nIGF0IGxlYXN0IGZpcnN0IDIgYXJncwogICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgICAgIGxvZ0ZuKGFyZzEsIGFyZzIgPT0gbnVsbCA/ICcnIDogYXJnMik7CiAgICAgIH07CiAgICB9CiAgfV07Cn0KCnZhciAkcGFyc2VNaW5FcnIgPSBtaW5FcnIoJyRwYXJzZScpOwp2YXIgcHJvbWlzZVdhcm5pbmdDYWNoZSA9IHt9Owp2YXIgcHJvbWlzZVdhcm5pbmc7CgovLyBTYW5kYm94aW5nIEFuZ3VsYXIgRXhwcmVzc2lvbnMKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIEFuZ3VsYXIgZXhwcmVzc2lvbnMgYXJlIGdlbmVyYWxseSBjb25zaWRlcmVkIHNhZmUgYmVjYXVzZSB0aGVzZSBleHByZXNzaW9ucyBvbmx5IGhhdmUgZGlyZWN0Ci8vIGFjY2VzcyB0byAkc2NvcGUgYW5kIGxvY2Fscy4gSG93ZXZlciwgb25lIGNhbiBvYnRhaW4gdGhlIGFiaWxpdHkgdG8gZXhlY3V0ZSBhcmJpdHJhcnkgSlMgY29kZSBieQovLyBvYnRhaW5pbmcgYSByZWZlcmVuY2UgdG8gbmF0aXZlIEpTIGZ1bmN0aW9ucyBzdWNoIGFzIHRoZSBGdW5jdGlvbiBjb25zdHJ1Y3Rvci4KLy8KLy8gQXMgYW4gZXhhbXBsZSwgY29uc2lkZXIgdGhlIGZvbGxvd2luZyBBbmd1bGFyIGV4cHJlc3Npb246Ci8vCi8vICAge30udG9TdHJpbmcuY29uc3RydWN0b3IoYWxlcnQoImV2aWwgSlMgY29kZSIpKQovLwovLyBXZSB3YW50IHRvIHByZXZlbnQgdGhpcyB0eXBlIG9mIGFjY2Vzcy4gRm9yIHRoZSBzYWtlIG9mIHBlcmZvcm1hbmNlLCBkdXJpbmcgdGhlIGxleGluZyBwaGFzZSB3ZQovLyBkaXNhbGxvdyBhbnkgImRvdHRlZCIgYWNjZXNzIHRvIGFueSBtZW1iZXIgbmFtZWQgImNvbnN0cnVjdG9yIi4KLy8KLy8gRm9yIHJlZmxlY3RpdmUgY2FsbHMgKGFbYl0pIHdlIGNoZWNrIHRoYXQgdGhlIHZhbHVlIG9mIHRoZSBsb29rdXAgaXMgbm90IHRoZSBGdW5jdGlvbiBjb25zdHJ1Y3RvcgovLyB3aGlsZSBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLCB3aGljaCBpcyBhIHN0cm9uZ2VyIGJ1dCBtb3JlIGV4cGVuc2l2ZSB0ZXN0LiBTaW5jZSByZWZsZWN0aXZlCi8vIGNhbGxzIGFyZSBleHBlbnNpdmUgYW55d2F5LCB0aGlzIGlzIG5vdCBzdWNoIGEgYmlnIGRlYWwgY29tcGFyZWQgdG8gc3RhdGljIGRlcmVmZXJlbmNpbmcuCi8vCi8vIFRoaXMgc2FuZGJveGluZyB0ZWNobmlxdWUgaXMgbm90IHBlcmZlY3QgYW5kIGRvZXNuJ3QgYWltIHRvIGJlLiBUaGUgZ29hbCBpcyB0byBwcmV2ZW50IGV4cGxvaXRzCi8vIGFnYWluc3QgdGhlIGV4cHJlc3Npb24gbGFuZ3VhZ2UsIGJ1dCBub3QgdG8gcHJldmVudCBleHBsb2l0cyB0aGF0IHdlcmUgZW5hYmxlZCBieSBleHBvc2luZwovLyBzZW5zaXRpdmUgSmF2YVNjcmlwdCBvciBicm93c2VyIGFwaXMgb24gU2NvcGUuIEV4cG9zaW5nIHN1Y2ggb2JqZWN0cyBvbiBhIFNjb3BlIGlzIG5ldmVyIGEgZ29vZAovLyBwcmFjdGljZSBhbmQgdGhlcmVmb3JlIHdlIGFyZSBub3QgZXZlbiB0cnlpbmcgdG8gcHJvdGVjdCBhZ2FpbnN0IGludGVyYWN0aW9uIHdpdGggYW4gb2JqZWN0Ci8vIGV4cGxpY2l0bHkgZXhwb3NlZCBpbiB0aGlzIHdheS4KLy8KLy8gQSBkZXZlbG9wZXIgY291bGQgZm9pbCB0aGUgbmFtZSBjaGVjayBieSBhbGlhc2luZyB0aGUgRnVuY3Rpb24gY29uc3RydWN0b3IgdW5kZXIgYSBkaWZmZXJlbnQKLy8gbmFtZSBvbiB0aGUgc2NvcGUuCi8vCi8vIEluIGdlbmVyYWwsIGl0IGlzIG5vdCBwb3NzaWJsZSB0byBhY2Nlc3MgYSBXaW5kb3cgb2JqZWN0IGZyb20gYW4gYW5ndWxhciBleHByZXNzaW9uIHVubGVzcyBhCi8vIHdpbmRvdyBvciBzb21lIERPTSBvYmplY3QgdGhhdCBoYXMgYSByZWZlcmVuY2UgdG8gd2luZG93IGlzIHB1Ymxpc2hlZCBvbnRvIGEgU2NvcGUuCgpmdW5jdGlvbiBlbnN1cmVTYWZlTWVtYmVyTmFtZShuYW1lLCBmdWxsRXhwcmVzc2lvbikgewogIGlmIChuYW1lID09PSAiY29uc3RydWN0b3IiKSB7CiAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWNmbGQnLAogICAgICAgICdSZWZlcmVuY2luZyAiY29uc3RydWN0b3IiIGZpZWxkIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICBmdWxsRXhwcmVzc2lvbik7CiAgfQogIHJldHVybiBuYW1lOwp9CgpmdW5jdGlvbiBlbnN1cmVTYWZlT2JqZWN0KG9iaiwgZnVsbEV4cHJlc3Npb24pIHsKICAvLyBuaWZ0eSBjaGVjayBpZiBvYmogaXMgRnVuY3Rpb24gdGhhdCBpcyBmYXN0IGFuZCB3b3JrcyBhY3Jvc3MgaWZyYW1lcyBhbmQgb3RoZXIgY29udGV4dHMKICBpZiAob2JqKSB7CiAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBvYmopIHsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZm4nLAogICAgICAgICAgJ1JlZmVyZW5jaW5nIEZ1bmN0aW9uIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgIH0gZWxzZSBpZiAoLy8gaXNXaW5kb3cob2JqKQogICAgICAgIG9iai5kb2N1bWVudCAmJiBvYmoubG9jYXRpb24gJiYgb2JqLmFsZXJ0ICYmIG9iai5zZXRJbnRlcnZhbCkgewogICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWN3aW5kb3cnLAogICAgICAgICAgJ1JlZmVyZW5jaW5nIHRoZSBXaW5kb3cgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfSBlbHNlIGlmICgvLyBpc0VsZW1lbnQob2JqKQogICAgICAgIG9iai5jaGlsZHJlbiAmJiAob2JqLm5vZGVOYW1lIHx8IChvYmoucHJvcCAmJiBvYmouYXR0ciAmJiBvYmouZmluZCkpKSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY2RvbScsCiAgICAgICAgICAnUmVmZXJlbmNpbmcgRE9NIG5vZGVzIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgIH0KICB9CiAgcmV0dXJuIG9iajsKfQoKdmFyIE9QRVJBVE9SUyA9IHsKICAgIC8qIGpzaGludCBiaXR3aXNlIDogZmFsc2UgKi8KICAgICdudWxsJzpmdW5jdGlvbigpe3JldHVybiBudWxsO30sCiAgICAndHJ1ZSc6ZnVuY3Rpb24oKXtyZXR1cm4gdHJ1ZTt9LAogICAgJ2ZhbHNlJzpmdW5jdGlvbigpe3JldHVybiBmYWxzZTt9LAogICAgdW5kZWZpbmVkOm5vb3AsCiAgICAnKyc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpewogICAgICBhPWEoc2VsZiwgbG9jYWxzKTsgYj1iKHNlbGYsIGxvY2Fscyk7CiAgICAgIGlmIChpc0RlZmluZWQoYSkpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKGIpKSB7CiAgICAgICAgICByZXR1cm4gYSArIGI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhOwogICAgICB9CiAgICAgIHJldHVybiBpc0RlZmluZWQoYik/Yjp1bmRlZmluZWQ7fSwKICAgICctJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7CiAgICAgICAgICBhPWEoc2VsZiwgbG9jYWxzKTsgYj1iKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICByZXR1cm4gKGlzRGVmaW5lZChhKT9hOjApLShpc0RlZmluZWQoYik/YjowKTsKICAgICAgICB9LAogICAgJyonOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpKmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJy8nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpL2Ioc2VsZiwgbG9jYWxzKTt9LAogICAgJyUnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJ14nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpXmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz0nOm5vb3AsCiAgICAnPT09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsIGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk9PT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICchPT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSwgYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSE9PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT09YihzZWxmLCBsb2NhbHMpO30sCiAgICAnIT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpIT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICc8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKTxiKHNlbGYsIGxvY2Fscyk7fSwKICAgICc+JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT5iKHNlbGYsIGxvY2Fscyk7fSwKICAgICc8PSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk8PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz49JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT49YihzZWxmLCBsb2NhbHMpO30sCiAgICAnJiYnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJiZiKHNlbGYsIGxvY2Fscyk7fSwKICAgICd8fCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyl8fGIoc2VsZiwgbG9jYWxzKTt9LAogICAgJyYnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJmIoc2VsZiwgbG9jYWxzKTt9LAovLyAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhfGI7fSwKICAgICd8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGIoc2VsZiwgbG9jYWxzKShzZWxmLCBsb2NhbHMsIGEoc2VsZiwgbG9jYWxzKSk7fSwKICAgICchJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEpe3JldHVybiAhYShzZWxmLCBsb2NhbHMpO30KfTsKLyoganNoaW50IGJpdHdpc2U6IHRydWUgKi8KdmFyIEVTQ0FQRSA9IHsibiI6IlxuIiwgImYiOiJcZiIsICJyIjoiXHIiLCAidCI6Ilx0IiwgInYiOiJcdiIsICInIjoiJyIsICciJzonIid9OwoKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKi8KdmFyIExleGVyID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwp9OwoKTGV4ZXIucHJvdG90eXBlID0gewogIGNvbnN0cnVjdG9yOiBMZXhlciwKCiAgbGV4OiBmdW5jdGlvbiAodGV4dCkgewogICAgdGhpcy50ZXh0ID0gdGV4dDsKCiAgICB0aGlzLmluZGV4ID0gMDsKICAgIHRoaXMuY2ggPSB1bmRlZmluZWQ7CiAgICB0aGlzLmxhc3RDaCA9ICc6JzsgLy8gY2FuIHN0YXJ0IHJlZ2V4cAoKICAgIHRoaXMudG9rZW5zID0gW107CgogICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLnRleHQubGVuZ3RoKSB7CiAgICAgIHRoaXMuY2ggPSB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpOwogICAgICBpZiAodGhpcy5pcygnIlwnJykpIHsKICAgICAgICB0aGlzLnJlYWRTdHJpbmcodGhpcy5jaCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc051bWJlcih0aGlzLmNoKSB8fCB0aGlzLmlzKCcuJykgJiYgdGhpcy5pc051bWJlcih0aGlzLnBlZWsoKSkpIHsKICAgICAgICB0aGlzLnJlYWROdW1iZXIoKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzSWRlbnQodGhpcy5jaCkpIHsKICAgICAgICB0aGlzLnJlYWRJZGVudCgpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXMoJygpe31bXS4sOzo/JykpIHsKICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgIGluZGV4OiB0aGlzLmluZGV4LAogICAgICAgICAgdGV4dDogdGhpcy5jaAogICAgICAgIH0pOwogICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzV2hpdGVzcGFjZSh0aGlzLmNoKSkgewogICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgICBjb250aW51ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY2gyID0gdGhpcy5jaCArIHRoaXMucGVlaygpOwogICAgICAgIHZhciBjaDMgPSBjaDIgKyB0aGlzLnBlZWsoMik7CiAgICAgICAgdmFyIGZuID0gT1BFUkFUT1JTW3RoaXMuY2hdOwogICAgICAgIHZhciBmbjIgPSBPUEVSQVRPUlNbY2gyXTsKICAgICAgICB2YXIgZm4zID0gT1BFUkFUT1JTW2NoM107CiAgICAgICAgaWYgKGZuMykgewogICAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7aW5kZXg6IHRoaXMuaW5kZXgsIHRleHQ6IGNoMywgZm46IGZuM30pOwogICAgICAgICAgdGhpcy5pbmRleCArPSAzOwogICAgICAgIH0gZWxzZSBpZiAoZm4yKSB7CiAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHtpbmRleDogdGhpcy5pbmRleCwgdGV4dDogY2gyLCBmbjogZm4yfSk7CiAgICAgICAgICB0aGlzLmluZGV4ICs9IDI7CiAgICAgICAgfSBlbHNlIGlmIChmbikgewogICAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgICAgIGluZGV4OiB0aGlzLmluZGV4LAogICAgICAgICAgICB0ZXh0OiB0aGlzLmNoLAogICAgICAgICAgICBmbjogZm4KICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5pbmRleCArPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ1VuZXhwZWN0ZWQgbmV4dCBjaGFyYWN0ZXIgJywgdGhpcy5pbmRleCwgdGhpcy5pbmRleCArIDEpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmxhc3RDaCA9IHRoaXMuY2g7CiAgICB9CiAgICByZXR1cm4gdGhpcy50b2tlbnM7CiAgfSwKCiAgaXM6IGZ1bmN0aW9uKGNoYXJzKSB7CiAgICByZXR1cm4gY2hhcnMuaW5kZXhPZih0aGlzLmNoKSAhPT0gLTE7CiAgfSwKCiAgd2FzOiBmdW5jdGlvbihjaGFycykgewogICAgcmV0dXJuIGNoYXJzLmluZGV4T2YodGhpcy5sYXN0Q2gpICE9PSAtMTsKICB9LAoKICBwZWVrOiBmdW5jdGlvbihpKSB7CiAgICB2YXIgbnVtID0gaSB8fCAxOwogICAgcmV0dXJuICh0aGlzLmluZGV4ICsgbnVtIDwgdGhpcy50ZXh0Lmxlbmd0aCkgPyB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXggKyBudW0pIDogZmFsc2U7CiAgfSwKCiAgaXNOdW1iZXI6IGZ1bmN0aW9uKGNoKSB7CiAgICByZXR1cm4gKCcwJyA8PSBjaCAmJiBjaCA8PSAnOScpOwogIH0sCgogIGlzV2hpdGVzcGFjZTogZnVuY3Rpb24oY2gpIHsKICAgIC8vIElFIHRyZWF0cyBub24tYnJlYWtpbmcgc3BhY2UgYXMgXHUwMEEwCiAgICByZXR1cm4gKGNoID09PSAnICcgfHwgY2ggPT09ICdccicgfHwgY2ggPT09ICdcdCcgfHwKICAgICAgICAgICAgY2ggPT09ICdcbicgfHwgY2ggPT09ICdcdicgfHwgY2ggPT09ICdcdTAwQTAnKTsKICB9LAoKICBpc0lkZW50OiBmdW5jdGlvbihjaCkgewogICAgcmV0dXJuICgnYScgPD0gY2ggJiYgY2ggPD0gJ3onIHx8CiAgICAgICAgICAgICdBJyA8PSBjaCAmJiBjaCA8PSAnWicgfHwKICAgICAgICAgICAgJ18nID09PSBjaCB8fCBjaCA9PT0gJyQnKTsKICB9LAoKICBpc0V4cE9wZXJhdG9yOiBmdW5jdGlvbihjaCkgewogICAgcmV0dXJuIChjaCA9PT0gJy0nIHx8IGNoID09PSAnKycgfHwgdGhpcy5pc051bWJlcihjaCkpOwogIH0sCgogIHRocm93RXJyb3I6IGZ1bmN0aW9uKGVycm9yLCBzdGFydCwgZW5kKSB7CiAgICBlbmQgPSBlbmQgfHwgdGhpcy5pbmRleDsKICAgIHZhciBjb2xTdHIgPSAoaXNEZWZpbmVkKHN0YXJ0KQogICAgICAgICAgICA/ICdzICcgKyBzdGFydCArICAnLScgKyB0aGlzLmluZGV4ICsgJyBbJyArIHRoaXMudGV4dC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkgKyAnXScKICAgICAgICAgICAgOiAnICcgKyBlbmQpOwogICAgdGhyb3cgJHBhcnNlTWluRXJyKCdsZXhlcnInLCAnTGV4ZXIgRXJyb3I6IHswfSBhdCBjb2x1bW57MX0gaW4gZXhwcmVzc2lvbiBbezJ9XS4nLAogICAgICAgIGVycm9yLCBjb2xTdHIsIHRoaXMudGV4dCk7CiAgfSwKCiAgcmVhZE51bWJlcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbnVtYmVyID0gJyc7CiAgICB2YXIgc3RhcnQgPSB0aGlzLmluZGV4OwogICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLnRleHQubGVuZ3RoKSB7CiAgICAgIHZhciBjaCA9IGxvd2VyY2FzZSh0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpKTsKICAgICAgaWYgKGNoID09ICcuJyB8fCB0aGlzLmlzTnVtYmVyKGNoKSkgewogICAgICAgIG51bWJlciArPSBjaDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcGVla0NoID0gdGhpcy5wZWVrKCk7CiAgICAgICAgaWYgKGNoID09ICdlJyAmJiB0aGlzLmlzRXhwT3BlcmF0b3IocGVla0NoKSkgewogICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICBwZWVrQ2ggJiYgdGhpcy5pc051bWJlcihwZWVrQ2gpICYmCiAgICAgICAgICAgIG51bWJlci5jaGFyQXQobnVtYmVyLmxlbmd0aCAtIDEpID09ICdlJykgewogICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICAoIXBlZWtDaCB8fCAhdGhpcy5pc051bWJlcihwZWVrQ2gpKSAmJgogICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignSW52YWxpZCBleHBvbmVudCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5pbmRleCsrOwogICAgfQogICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICBpbmRleDogc3RhcnQsCiAgICAgIHRleHQ6IG51bWJlciwKICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgY29uc3RhbnQ6IHRydWUsCiAgICAgIGZuOiBmdW5jdGlvbigpIHsgcmV0dXJuIG51bWJlcjsgfQogICAgfSk7CiAgfSwKCiAgcmVhZElkZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBwYXJzZXIgPSB0aGlzOwoKICAgIHZhciBpZGVudCA9ICcnOwogICAgdmFyIHN0YXJ0ID0gdGhpcy5pbmRleDsKCiAgICB2YXIgbGFzdERvdCwgcGVla0luZGV4LCBtZXRob2ROYW1lLCBjaDsKCiAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgY2ggPSB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpOwogICAgICBpZiAoY2ggPT09ICcuJyB8fCB0aGlzLmlzSWRlbnQoY2gpIHx8IHRoaXMuaXNOdW1iZXIoY2gpKSB7CiAgICAgICAgaWYgKGNoID09PSAnLicpIGxhc3REb3QgPSB0aGlzLmluZGV4OwogICAgICAgIGlkZW50ICs9IGNoOwogICAgICB9IGVsc2UgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHRoaXMuaW5kZXgrKzsKICAgIH0KCiAgICAvL2NoZWNrIGlmIHRoaXMgaXMgbm90IGEgbWV0aG9kIGludm9jYXRpb24gYW5kIGlmIGl0IGlzIGJhY2sgb3V0IHRvIGxhc3QgZG90CiAgICBpZiAobGFzdERvdCkgewogICAgICBwZWVrSW5kZXggPSB0aGlzLmluZGV4OwogICAgICB3aGlsZSAocGVla0luZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICAgIGNoID0gdGhpcy50ZXh0LmNoYXJBdChwZWVrSW5kZXgpOwogICAgICAgIGlmIChjaCA9PT0gJygnKSB7CiAgICAgICAgICBtZXRob2ROYW1lID0gaWRlbnQuc3Vic3RyKGxhc3REb3QgLSBzdGFydCArIDEpOwogICAgICAgICAgaWRlbnQgPSBpZGVudC5zdWJzdHIoMCwgbGFzdERvdCAtIHN0YXJ0KTsKICAgICAgICAgIHRoaXMuaW5kZXggPSBwZWVrSW5kZXg7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuaXNXaGl0ZXNwYWNlKGNoKSkgewogICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKCiAgICB2YXIgdG9rZW4gPSB7CiAgICAgIGluZGV4OiBzdGFydCwKICAgICAgdGV4dDogaWRlbnQKICAgIH07CgogICAgLy8gT1BFUkFUT1JTIGlzIG91ciBvd24gb2JqZWN0IHNvIHdlIGRvbid0IG5lZWQgdG8gdXNlIHNwZWNpYWwgaGFzT3duUHJvcGVydHlGbgogICAgaWYgKE9QRVJBVE9SUy5oYXNPd25Qcm9wZXJ0eShpZGVudCkpIHsKICAgICAgdG9rZW4uZm4gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgICB0b2tlbi5saXRlcmFsID0gdHJ1ZTsKICAgICAgdG9rZW4uY29uc3RhbnQgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGlkZW50LCB0aGlzLm9wdGlvbnMsIHRoaXMudGV4dCk7CiAgICAgIHRva2VuLmZuID0gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICB9LCB7CiAgICAgICAgYXNzaWduOiBmdW5jdGlvbihzZWxmLCB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIHNldHRlcihzZWxmLCBpZGVudCwgdmFsdWUsIHBhcnNlci50ZXh0LCBwYXJzZXIub3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICB0aGlzLnRva2Vucy5wdXNoKHRva2VuKTsKCiAgICBpZiAobWV0aG9kTmFtZSkgewogICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICBpbmRleDpsYXN0RG90LAogICAgICAgIHRleHQ6ICcuJwogICAgICB9KTsKICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgaW5kZXg6IGxhc3REb3QgKyAxLAogICAgICAgIHRleHQ6IG1ldGhvZE5hbWUKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgcmVhZFN0cmluZzogZnVuY3Rpb24ocXVvdGUpIHsKICAgIHZhciBzdGFydCA9IHRoaXMuaW5kZXg7CiAgICB0aGlzLmluZGV4Kys7CiAgICB2YXIgc3RyaW5nID0gJyc7CiAgICB2YXIgcmF3U3RyaW5nID0gcXVvdGU7CiAgICB2YXIgZXNjYXBlID0gZmFsc2U7CiAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgdmFyIGNoID0gdGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4KTsKICAgICAgcmF3U3RyaW5nICs9IGNoOwogICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgaWYgKGNoID09PSAndScpIHsKICAgICAgICAgIHZhciBoZXggPSB0aGlzLnRleHQuc3Vic3RyaW5nKHRoaXMuaW5kZXggKyAxLCB0aGlzLmluZGV4ICsgNSk7CiAgICAgICAgICBpZiAoIWhleC5tYXRjaCgvW1xkYS1mXXs0fS9pKSkKICAgICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdJbnZhbGlkIHVuaWNvZGUgZXNjYXBlIFtcXHUnICsgaGV4ICsgJ10nKTsKICAgICAgICAgIHRoaXMuaW5kZXggKz0gNDsKICAgICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHJlcCA9IEVTQ0FQRVtjaF07CiAgICAgICAgICBpZiAocmVwKSB7CiAgICAgICAgICAgIHN0cmluZyArPSByZXA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVzY2FwZSA9IGZhbHNlOwogICAgICB9IGVsc2UgaWYgKGNoID09PSAnXFwnKSB7CiAgICAgICAgZXNjYXBlID0gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChjaCA9PT0gcXVvdGUpIHsKICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgICBpbmRleDogc3RhcnQsCiAgICAgICAgICB0ZXh0OiByYXdTdHJpbmcsCiAgICAgICAgICBzdHJpbmc6IHN0cmluZywKICAgICAgICAgIGxpdGVyYWw6IHRydWUsCiAgICAgICAgICBjb25zdGFudDogdHJ1ZSwKICAgICAgICAgIGZuOiBmdW5jdGlvbigpIHsgcmV0dXJuIHN0cmluZzsgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgIH0KICAgICAgdGhpcy5pbmRleCsrOwogICAgfQogICAgdGhpcy50aHJvd0Vycm9yKCdVbnRlcm1pbmF0ZWQgcXVvdGUnLCBzdGFydCk7CiAgfQp9OwoKCi8qKgogKiBAY29uc3RydWN0b3IKICovCnZhciBQYXJzZXIgPSBmdW5jdGlvbiAobGV4ZXIsICRmaWx0ZXIsIG9wdGlvbnMpIHsKICB0aGlzLmxleGVyID0gbGV4ZXI7CiAgdGhpcy4kZmlsdGVyID0gJGZpbHRlcjsKICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwp9OwoKUGFyc2VyLlpFUk8gPSBleHRlbmQoZnVuY3Rpb24gKCkgewogIHJldHVybiAwOwp9LCB7CiAgY29uc3RhbnQ6IHRydWUKfSk7CgpQYXJzZXIucHJvdG90eXBlID0gewogIGNvbnN0cnVjdG9yOiBQYXJzZXIsCgogIHBhcnNlOiBmdW5jdGlvbiAodGV4dCkgewogICAgdGhpcy50ZXh0ID0gdGV4dDsKCiAgICB0aGlzLnRva2VucyA9IHRoaXMubGV4ZXIubGV4KHRleHQpOwoKICAgIHZhciB2YWx1ZSA9IHRoaXMuc3RhdGVtZW50cygpOwoKICAgIGlmICh0aGlzLnRva2Vucy5sZW5ndGggIT09IDApIHsKICAgICAgdGhpcy50aHJvd0Vycm9yKCdpcyBhbiB1bmV4cGVjdGVkIHRva2VuJywgdGhpcy50b2tlbnNbMF0pOwogICAgfQoKICAgIHZhbHVlLmxpdGVyYWwgPSAhIXZhbHVlLmxpdGVyYWw7CiAgICB2YWx1ZS5jb25zdGFudCA9ICEhdmFsdWUuY29uc3RhbnQ7CgogICAgcmV0dXJuIHZhbHVlOwogIH0sCgogIHByaW1hcnk6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBwcmltYXJ5OwogICAgaWYgKHRoaXMuZXhwZWN0KCcoJykpIHsKICAgICAgcHJpbWFyeSA9IHRoaXMuZmlsdGVyQ2hhaW4oKTsKICAgICAgdGhpcy5jb25zdW1lKCcpJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMuZXhwZWN0KCdbJykpIHsKICAgICAgcHJpbWFyeSA9IHRoaXMuYXJyYXlEZWNsYXJhdGlvbigpOwogICAgfSBlbHNlIGlmICh0aGlzLmV4cGVjdCgneycpKSB7CiAgICAgIHByaW1hcnkgPSB0aGlzLm9iamVjdCgpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIHRva2VuID0gdGhpcy5leHBlY3QoKTsKICAgICAgcHJpbWFyeSA9IHRva2VuLmZuOwogICAgICBpZiAoIXByaW1hcnkpIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ25vdCBhIHByaW1hcnkgZXhwcmVzc2lvbicsIHRva2VuKTsKICAgICAgfQogICAgICBwcmltYXJ5LmxpdGVyYWwgPSAhIXRva2VuLmxpdGVyYWw7CiAgICAgIHByaW1hcnkuY29uc3RhbnQgPSAhIXRva2VuLmNvbnN0YW50OwogICAgfQoKICAgIHZhciBuZXh0LCBjb250ZXh0OwogICAgd2hpbGUgKChuZXh0ID0gdGhpcy5leHBlY3QoJygnLCAnWycsICcuJykpKSB7CiAgICAgIGlmIChuZXh0LnRleHQgPT09ICcoJykgewogICAgICAgIHByaW1hcnkgPSB0aGlzLmZ1bmN0aW9uQ2FsbChwcmltYXJ5LCBjb250ZXh0KTsKICAgICAgICBjb250ZXh0ID0gbnVsbDsKICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICdbJykgewogICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgIHByaW1hcnkgPSB0aGlzLm9iamVjdEluZGV4KHByaW1hcnkpOwogICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJy4nKSB7CiAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgcHJpbWFyeSA9IHRoaXMuZmllbGRBY2Nlc3MocHJpbWFyeSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdJTVBPU1NJQkxFJyk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwcmltYXJ5OwogIH0sCgogIHRocm93RXJyb3I6IGZ1bmN0aW9uKG1zZywgdG9rZW4pIHsKICAgIHRocm93ICRwYXJzZU1pbkVycignc3ludGF4JywKICAgICAgICAnU3ludGF4IEVycm9yOiBUb2tlbiBcJ3swfVwnIHsxfSBhdCBjb2x1bW4gezJ9IG9mIHRoZSBleHByZXNzaW9uIFt7M31dIHN0YXJ0aW5nIGF0IFt7NH1dLicsCiAgICAgICAgICB0b2tlbi50ZXh0LCBtc2csICh0b2tlbi5pbmRleCArIDEpLCB0aGlzLnRleHQsIHRoaXMudGV4dC5zdWJzdHJpbmcodG9rZW4uaW5kZXgpKTsKICB9LAoKICBwZWVrVG9rZW46IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMudG9rZW5zLmxlbmd0aCA9PT0gMCkKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCd1ZW9lJywgJ1VuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246IHswfScsIHRoaXMudGV4dCk7CiAgICByZXR1cm4gdGhpcy50b2tlbnNbMF07CiAgfSwKCiAgcGVlazogZnVuY3Rpb24oZTEsIGUyLCBlMywgZTQpIHsKICAgIGlmICh0aGlzLnRva2Vucy5sZW5ndGggPiAwKSB7CiAgICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5zWzBdOwogICAgICB2YXIgdCA9IHRva2VuLnRleHQ7CiAgICAgIGlmICh0ID09PSBlMSB8fCB0ID09PSBlMiB8fCB0ID09PSBlMyB8fCB0ID09PSBlNCB8fAogICAgICAgICAgKCFlMSAmJiAhZTIgJiYgIWUzICYmICFlNCkpIHsKICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9LAoKICBleHBlY3Q6IGZ1bmN0aW9uKGUxLCBlMiwgZTMsIGU0KXsKICAgIHZhciB0b2tlbiA9IHRoaXMucGVlayhlMSwgZTIsIGUzLCBlNCk7CiAgICBpZiAodG9rZW4pIHsKICAgICAgdGhpcy50b2tlbnMuc2hpZnQoKTsKICAgICAgcmV0dXJuIHRva2VuOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIGNvbnN1bWU6IGZ1bmN0aW9uKGUxKXsKICAgIGlmICghdGhpcy5leHBlY3QoZTEpKSB7CiAgICAgIHRoaXMudGhyb3dFcnJvcignaXMgdW5leHBlY3RlZCwgZXhwZWN0aW5nIFsnICsgZTEgKyAnXScsIHRoaXMucGVlaygpKTsKICAgIH0KICB9LAoKICB1bmFyeUZuOiBmdW5jdGlvbihmbiwgcmlnaHQpIHsKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgIHJldHVybiBmbihzZWxmLCBsb2NhbHMsIHJpZ2h0KTsKICAgIH0sIHsKICAgICAgY29uc3RhbnQ6cmlnaHQuY29uc3RhbnQKICAgIH0pOwogIH0sCgogIHRlcm5hcnlGbjogZnVuY3Rpb24obGVmdCwgbWlkZGxlLCByaWdodCl7CiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgIHJldHVybiBsZWZ0KHNlbGYsIGxvY2FscykgPyBtaWRkbGUoc2VsZiwgbG9jYWxzKSA6IHJpZ2h0KHNlbGYsIGxvY2Fscyk7CiAgICB9LCB7CiAgICAgIGNvbnN0YW50OiBsZWZ0LmNvbnN0YW50ICYmIG1pZGRsZS5jb25zdGFudCAmJiByaWdodC5jb25zdGFudAogICAgfSk7CiAgfSwKCiAgYmluYXJ5Rm46IGZ1bmN0aW9uKGxlZnQsIGZuLCByaWdodCkgewogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbihzZWxmLCBsb2NhbHMpIHsKICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgbGVmdCwgcmlnaHQpOwogICAgfSwgewogICAgICBjb25zdGFudDpsZWZ0LmNvbnN0YW50ICYmIHJpZ2h0LmNvbnN0YW50CiAgICB9KTsKICB9LAoKICBzdGF0ZW1lbnRzOiBmdW5jdGlvbigpIHsKICAgIHZhciBzdGF0ZW1lbnRzID0gW107CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAodGhpcy50b2tlbnMubGVuZ3RoID4gMCAmJiAhdGhpcy5wZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgc3RhdGVtZW50cy5wdXNoKHRoaXMuZmlsdGVyQ2hhaW4oKSk7CiAgICAgIGlmICghdGhpcy5leHBlY3QoJzsnKSkgewogICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgIHJldHVybiAoc3RhdGVtZW50cy5sZW5ndGggPT09IDEpCiAgICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgICA6IGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZW1lbnQgPSBzdGF0ZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgICBpZiAoc3RhdGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZW1lbnQoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9LAoKICBmaWx0ZXJDaGFpbjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMuZXhwcmVzc2lvbigpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCd8JykpKSB7CiAgICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMuZmlsdGVyKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBsZWZ0OwogICAgICB9CiAgICB9CiAgfSwKCiAgZmlsdGVyOiBmdW5jdGlvbigpIHsKICAgIHZhciB0b2tlbiA9IHRoaXMuZXhwZWN0KCk7CiAgICB2YXIgZm4gPSB0aGlzLiRmaWx0ZXIodG9rZW4udGV4dCk7CiAgICB2YXIgYXJnc0ZuID0gW107CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJzonKSkpIHsKICAgICAgICBhcmdzRm4ucHVzaCh0aGlzLmV4cHJlc3Npb24oKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBpbnB1dCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBbaW5wdXRdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzRm4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBmbkludm9rZTsKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfSwKCiAgZXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5hc3NpZ25tZW50KCk7CiAgfSwKCiAgYXNzaWdubWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMudGVybmFyeSgpOwogICAgdmFyIHJpZ2h0OwogICAgdmFyIHRva2VuOwogICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc9JykpKSB7CiAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2ltcGxpZXMgYXNzaWdubWVudCBidXQgWycgKwogICAgICAgICAgICB0aGlzLnRleHQuc3Vic3RyaW5nKDAsIHRva2VuLmluZGV4KSArICddIGNhbiBub3QgYmUgYXNzaWduZWQgdG8nLCB0b2tlbik7CiAgICAgIH0KICAgICAgcmlnaHQgPSB0aGlzLnRlcm5hcnkoKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICByZXR1cm4gbGVmdC5hc3NpZ24oc2NvcGUsIHJpZ2h0KHNjb3BlLCBsb2NhbHMpLCBsb2NhbHMpOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgdGVybmFyeTogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMubG9naWNhbE9SKCk7CiAgICB2YXIgbWlkZGxlOwogICAgdmFyIHRva2VuOwogICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc/JykpKSB7CiAgICAgIG1pZGRsZSA9IHRoaXMudGVybmFyeSgpOwogICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJzonKSkpIHsKICAgICAgICByZXR1cm4gdGhpcy50ZXJuYXJ5Rm4obGVmdCwgbWlkZGxlLCB0aGlzLnRlcm5hcnkoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdleHBlY3RlZCA6JywgdG9rZW4pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbGVmdDsKICAgIH0KICB9LAoKICBsb2dpY2FsT1I6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlZnQgPSB0aGlzLmxvZ2ljYWxBTkQoKTsKICAgIHZhciB0b2tlbjsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnfHwnKSkpIHsKICAgICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5sb2dpY2FsQU5EKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBsZWZ0OwogICAgICB9CiAgICB9CiAgfSwKCiAgbG9naWNhbEFORDogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMuZXF1YWxpdHkoKTsKICAgIHZhciB0b2tlbjsKICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnJiYnKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMubG9naWNhbEFORCgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIGVxdWFsaXR5OiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5yZWxhdGlvbmFsKCk7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJz09JywnIT0nLCc9PT0nLCchPT0nKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMuZXF1YWxpdHkoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICByZWxhdGlvbmFsOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5hZGRpdGl2ZSgpOwogICAgdmFyIHRva2VuOwogICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc8JywgJz4nLCAnPD0nLCAnPj0nKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMucmVsYXRpb25hbCgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIGFkZGl0aXZlOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5tdWx0aXBsaWNhdGl2ZSgpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCcrJywnLScpKSkgewogICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5tdWx0aXBsaWNhdGl2ZSgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIG11bHRpcGxpY2F0aXZlOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy51bmFyeSgpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCcqJywnLycsJyUnKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMudW5hcnkoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICB1bmFyeTogZnVuY3Rpb24oKSB7CiAgICB2YXIgdG9rZW47CiAgICBpZiAodGhpcy5leHBlY3QoJysnKSkgewogICAgICByZXR1cm4gdGhpcy5wcmltYXJ5KCk7CiAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCctJykpKSB7CiAgICAgIHJldHVybiB0aGlzLmJpbmFyeUZuKFBhcnNlci5aRVJPLCB0b2tlbi5mbiwgdGhpcy51bmFyeSgpKTsKICAgIH0gZWxzZSBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJyEnKSkpIHsKICAgICAgcmV0dXJuIHRoaXMudW5hcnlGbih0b2tlbi5mbiwgdGhpcy51bmFyeSgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLnByaW1hcnkoKTsKICAgIH0KICB9LAoKICBmaWVsZEFjY2VzczogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICB2YXIgcGFyc2VyID0gdGhpczsKICAgIHZhciBmaWVsZCA9IHRoaXMuZXhwZWN0KCkudGV4dDsKICAgIHZhciBnZXR0ZXIgPSBnZXR0ZXJGbihmaWVsZCwgdGhpcy5vcHRpb25zLCB0aGlzLnRleHQpOwoKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2NvcGUsIGxvY2Fscywgc2VsZikgewogICAgICByZXR1cm4gZ2V0dGVyKHNlbGYgfHwgb2JqZWN0KHNjb3BlLCBsb2NhbHMpKTsKICAgIH0sIHsKICAgICAgYXNzaWduOiBmdW5jdGlvbihzY29wZSwgdmFsdWUsIGxvY2FscykgewogICAgICAgIHJldHVybiBzZXR0ZXIob2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBmaWVsZCwgdmFsdWUsIHBhcnNlci50ZXh0LCBwYXJzZXIub3B0aW9ucyk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIG9iamVjdEluZGV4OiBmdW5jdGlvbihvYmopIHsKICAgIHZhciBwYXJzZXIgPSB0aGlzOwoKICAgIHZhciBpbmRleEZuID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICB0aGlzLmNvbnN1bWUoJ10nKTsKCiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICB2YXIgbyA9IG9iaihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgaSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKSwKICAgICAgICAgIHYsIHA7CgogICAgICBpZiAoIW8pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHYgPSBlbnN1cmVTYWZlT2JqZWN0KG9baV0sIHBhcnNlci50ZXh0KTsKICAgICAgaWYgKHYgJiYgdi50aGVuICYmIHBhcnNlci5vcHRpb25zLnVud3JhcFByb21pc2VzKSB7CiAgICAgICAgcCA9IHY7CiAgICAgICAgaWYgKCEoJyQkdicgaW4gdikpIHsKICAgICAgICAgIHAuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgcC50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgfQogICAgICAgIHYgPSB2LiQkdjsKICAgICAgfQogICAgICByZXR1cm4gdjsKICAgIH0sIHsKICAgICAgYXNzaWduOiBmdW5jdGlvbihzZWxmLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIGtleSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKTsKICAgICAgICAvLyBwcmV2ZW50IG92ZXJ3cml0aW5nIG9mIEZ1bmN0aW9uLmNvbnN0cnVjdG9yIHdoaWNoIHdvdWxkIGJyZWFrIGVuc3VyZVNhZmVPYmplY3QgY2hlY2sKICAgICAgICB2YXIgc2FmZSA9IGVuc3VyZVNhZmVPYmplY3Qob2JqKHNlbGYsIGxvY2FscyksIHBhcnNlci50ZXh0KTsKICAgICAgICByZXR1cm4gc2FmZVtrZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIGZ1bmN0aW9uQ2FsbDogZnVuY3Rpb24oZm4sIGNvbnRleHRHZXR0ZXIpIHsKICAgIHZhciBhcmdzRm4gPSBbXTsKICAgIGlmICh0aGlzLnBlZWtUb2tlbigpLnRleHQgIT09ICcpJykgewogICAgICBkbyB7CiAgICAgICAgYXJnc0ZuLnB1c2godGhpcy5leHByZXNzaW9uKCkpOwogICAgICB9IHdoaWxlICh0aGlzLmV4cGVjdCgnLCcpKTsKICAgIH0KICAgIHRoaXMuY29uc3VtZSgnKScpOwoKICAgIHZhciBwYXJzZXIgPSB0aGlzOwoKICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgIHZhciBhcmdzID0gW107CiAgICAgIHZhciBjb250ZXh0ID0gY29udGV4dEdldHRlciA/IGNvbnRleHRHZXR0ZXIoc2NvcGUsIGxvY2FscykgOiBzY29wZTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnc0ZuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzY29wZSwgbG9jYWxzKSk7CiAgICAgIH0KICAgICAgdmFyIGZuUHRyID0gZm4oc2NvcGUsIGxvY2FscywgY29udGV4dCkgfHwgbm9vcDsKCiAgICAgIGVuc3VyZVNhZmVPYmplY3QoY29udGV4dCwgcGFyc2VyLnRleHQpOwogICAgICBlbnN1cmVTYWZlT2JqZWN0KGZuUHRyLCBwYXJzZXIudGV4dCk7CgogICAgICAvLyBJRSBzdHVwaWRpdHkhIChJRSBkb2Vzbid0IGhhdmUgYXBwbHkgZm9yIHNvbWUgbmF0aXZlIGZ1bmN0aW9ucykKICAgICAgdmFyIHYgPSBmblB0ci5hcHBseQogICAgICAgICAgICA/IGZuUHRyLmFwcGx5KGNvbnRleHQsIGFyZ3MpCiAgICAgICAgICAgIDogZm5QdHIoYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSk7CgogICAgICByZXR1cm4gZW5zdXJlU2FmZU9iamVjdCh2LCBwYXJzZXIudGV4dCk7CiAgICB9OwogIH0sCgogIC8vIFRoaXMgaXMgdXNlZCB3aXRoIGpzb24gYXJyYXkgZGVjbGFyYXRpb24KICBhcnJheURlY2xhcmF0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZWxlbWVudEZucyA9IFtdOwogICAgdmFyIGFsbENvbnN0YW50ID0gdHJ1ZTsKICAgIGlmICh0aGlzLnBlZWtUb2tlbigpLnRleHQgIT09ICddJykgewogICAgICBkbyB7CiAgICAgICAgaWYgKHRoaXMucGVlaygnXScpKSB7CiAgICAgICAgICAvLyBTdXBwb3J0IHRyYWlsaW5nIGNvbW1hcyBwZXIgRVM1LjEuCiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgdmFyIGVsZW1lbnRGbiA9IHRoaXMuZXhwcmVzc2lvbigpOwogICAgICAgIGVsZW1lbnRGbnMucHVzaChlbGVtZW50Rm4pOwogICAgICAgIGlmICghZWxlbWVudEZuLmNvbnN0YW50KSB7CiAgICAgICAgICBhbGxDb25zdGFudCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSB3aGlsZSAodGhpcy5leHBlY3QoJywnKSk7CiAgICB9CiAgICB0aGlzLmNvbnN1bWUoJ10nKTsKCiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50Rm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYXJyYXkucHVzaChlbGVtZW50Rm5zW2ldKHNlbGYsIGxvY2FscykpOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0sIHsKICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgY29uc3RhbnQ6IGFsbENvbnN0YW50CiAgICB9KTsKICB9LAoKICBvYmplY3Q6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBrZXlWYWx1ZXMgPSBbXTsKICAgIHZhciBhbGxDb25zdGFudCA9IHRydWU7CiAgICBpZiAodGhpcy5wZWVrVG9rZW4oKS50ZXh0ICE9PSAnfScpIHsKICAgICAgZG8gewogICAgICAgIGlmICh0aGlzLnBlZWsoJ30nKSkgewogICAgICAgICAgLy8gU3VwcG9ydCB0cmFpbGluZyBjb21tYXMgcGVyIEVTNS4xLgogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHZhciB0b2tlbiA9IHRoaXMuZXhwZWN0KCksCiAgICAgICAga2V5ID0gdG9rZW4uc3RyaW5nIHx8IHRva2VuLnRleHQ7CiAgICAgICAgdGhpcy5jb25zdW1lKCc6Jyk7CiAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICAgICAga2V5VmFsdWVzLnB1c2goe2tleToga2V5LCB2YWx1ZTogdmFsdWV9KTsKICAgICAgICBpZiAoIXZhbHVlLmNvbnN0YW50KSB7CiAgICAgICAgICBhbGxDb25zdGFudCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSB3aGlsZSAodGhpcy5leHBlY3QoJywnKSk7CiAgICB9CiAgICB0aGlzLmNvbnN1bWUoJ30nKTsKCiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleVZhbHVlID0ga2V5VmFsdWVzW2ldOwogICAgICAgIG9iamVjdFtrZXlWYWx1ZS5rZXldID0ga2V5VmFsdWUudmFsdWUoc2VsZiwgbG9jYWxzKTsKICAgICAgfQogICAgICByZXR1cm4gb2JqZWN0OwogICAgfSwgewogICAgICBsaXRlcmFsOiB0cnVlLAogICAgICBjb25zdGFudDogYWxsQ29uc3RhbnQKICAgIH0pOwogIH0KfTsKCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQYXJzZXIgaGVscGVyIGZ1bmN0aW9ucwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKZnVuY3Rpb24gc2V0dGVyKG9iaiwgcGF0aCwgc2V0VmFsdWUsIGZ1bGxFeHAsIG9wdGlvbnMpIHsKICAvL25lZWRlZD8KICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyksIGtleTsKICBmb3IgKHZhciBpID0gMDsgZWxlbWVudC5sZW5ndGggPiAxOyBpKyspIHsKICAgIGtleSA9IGVuc3VyZVNhZmVNZW1iZXJOYW1lKGVsZW1lbnQuc2hpZnQoKSwgZnVsbEV4cCk7CiAgICB2YXIgcHJvcGVydHlPYmogPSBvYmpba2V5XTsKICAgIGlmICghcHJvcGVydHlPYmopIHsKICAgICAgcHJvcGVydHlPYmogPSB7fTsKICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU9iajsKICAgIH0KICAgIG9iaiA9IHByb3BlcnR5T2JqOwogICAgaWYgKG9iai50aGVuICYmIG9wdGlvbnMudW53cmFwUHJvbWlzZXMpIHsKICAgICAgcHJvbWlzZVdhcm5pbmcoZnVsbEV4cCk7CiAgICAgIGlmICghKCIkJHYiIGluIG9iaikpIHsKICAgICAgICAoZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7IH0KICAgICAgICApKG9iaik7CiAgICAgIH0KICAgICAgaWYgKG9iai4kJHYgPT09IHVuZGVmaW5lZCkgewogICAgICAgIG9iai4kJHYgPSB7fTsKICAgICAgfQogICAgICBvYmogPSBvYmouJCR2OwogICAgfQogIH0KICBrZXkgPSBlbnN1cmVTYWZlTWVtYmVyTmFtZShlbGVtZW50LnNoaWZ0KCksIGZ1bGxFeHApOwogIG9ialtrZXldID0gc2V0VmFsdWU7CiAgcmV0dXJuIHNldFZhbHVlOwp9Cgp2YXIgZ2V0dGVyRm5DYWNoZSA9IHt9OwoKLyoqCiAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSAiQmxhY2sgSG9sZSIgdmFyaWFudCBmcm9tOgogKiAtIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1wYXJzZS1nZXR0ZXIvNAogKiAtIGh0dHA6Ly9qc3BlcmYuY29tL3BhdGgtZXZhbHVhdGlvbi1zaW1wbGlmaWVkLzcKICovCmZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXJGbihrZXkwLCBrZXkxLCBrZXkyLCBrZXkzLCBrZXk0LCBmdWxsRXhwLCBvcHRpb25zKSB7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MCwgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MSwgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MiwgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MywgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5NCwgZnVsbEV4cCk7CgogIHJldHVybiAhb3B0aW9ucy51bndyYXBQcm9taXNlcwogICAgICA/IGZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXIoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgdmFyIHBhdGhWYWwgPSAobG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkwKSkgPyBsb2NhbHMgOiBzY29wZTsKCiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gcGF0aFZhbDsKICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTBdOwoKICAgICAgICAgIGlmICgha2V5MSkgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MV07CgogICAgICAgICAgaWYgKCFrZXkyKSByZXR1cm4gcGF0aFZhbDsKICAgICAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkyXTsKCiAgICAgICAgICBpZiAoIWtleTMpIHJldHVybiBwYXRoVmFsOwogICAgICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTNdOwoKICAgICAgICAgIGlmICgha2V5NCkgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5NF07CgogICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfQogICAgICA6IGZ1bmN0aW9uIGNzcFNhZmVQcm9taXNlRW5hYmxlZEdldHRlcihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICB2YXIgcGF0aFZhbCA9IChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlLAogICAgICAgICAgICAgIHByb21pc2U7CgogICAgICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MF07CiAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgcHJvbWlzZVdhcm5pbmcoZnVsbEV4cCk7CiAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgfQoKICAgICAgICAgIGlmICgha2V5MSkgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MV07CiAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgcHJvbWlzZVdhcm5pbmcoZnVsbEV4cCk7CiAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgfQoKICAgICAgICAgIGlmICgha2V5MikgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5Ml07CiAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgcHJvbWlzZVdhcm5pbmcoZnVsbEV4cCk7CiAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgfQoKICAgICAgICAgIGlmICgha2V5MykgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5M107CiAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgcHJvbWlzZVdhcm5pbmcoZnVsbEV4cCk7CiAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgfQoKICAgICAgICAgIGlmICgha2V5NCkgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5NF07CiAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgcHJvbWlzZVdhcm5pbmcoZnVsbEV4cCk7CiAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfTsKfQoKZnVuY3Rpb24gc2ltcGxlR2V0dGVyRm4xKGtleTAsIGZ1bGxFeHApIHsKICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkwLCBmdWxsRXhwKTsKCiAgcmV0dXJuIGZ1bmN0aW9uIHNpbXBsZUdldHRlckZuMShzY29wZSwgbG9jYWxzKSB7CiAgICBpZiAoc2NvcGUgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIHJldHVybiAoKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGUpW2tleTBdOwogIH07Cn0KCmZ1bmN0aW9uIHNpbXBsZUdldHRlckZuMihrZXkwLCBrZXkxLCBmdWxsRXhwKSB7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MCwgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MSwgZnVsbEV4cCk7CgogIHJldHVybiBmdW5jdGlvbiBzaW1wbGVHZXR0ZXJGbjIoc2NvcGUsIGxvY2FscykgewogICAgaWYgKHNjb3BlID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICBzY29wZSA9ICgobG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkwKSkgPyBsb2NhbHMgOiBzY29wZSlba2V5MF07CiAgICByZXR1cm4gc2NvcGUgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHNjb3BlW2tleTFdOwogIH07Cn0KCmZ1bmN0aW9uIGdldHRlckZuKHBhdGgsIG9wdGlvbnMsIGZ1bGxFeHApIHsKICAvLyBDaGVjayB3aGV0aGVyIHRoZSBjYWNoZSBoYXMgdGhpcyBnZXR0ZXIgYWxyZWFkeS4KICAvLyBXZSBjYW4gdXNlIGhhc093blByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBjYWNoZSBiZWNhdXNlIHdlIGVuc3VyZSwKICAvLyBzZWUgYmVsb3csIHRoYXQgdGhlIGNhY2hlIG5ldmVyIHN0b3JlcyBhIHBhdGggY2FsbGVkICdoYXNPd25Qcm9wZXJ0eScKICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgcmV0dXJuIGdldHRlckZuQ2FjaGVbcGF0aF07CiAgfQoKICB2YXIgcGF0aEtleXMgPSBwYXRoLnNwbGl0KCcuJyksCiAgICAgIHBhdGhLZXlzTGVuZ3RoID0gcGF0aEtleXMubGVuZ3RoLAogICAgICBmbjsKCiAgLy8gV2hlbiB3ZSBoYXZlIG9ubHkgMSBvciAyIHRva2VucywgdXNlIG9wdGltaXplZCBzcGVjaWFsIGNhc2UgY2xvc3VyZXMuCiAgLy8gaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhcmpzLXBhcnNlLWdldHRlci82CiAgaWYgKCFvcHRpb25zLnVud3JhcFByb21pc2VzICYmIHBhdGhLZXlzTGVuZ3RoID09PSAxKSB7CiAgICBmbiA9IHNpbXBsZUdldHRlckZuMShwYXRoS2V5c1swXSwgZnVsbEV4cCk7CiAgfSBlbHNlIGlmICghb3B0aW9ucy51bndyYXBQcm9taXNlcyAmJiBwYXRoS2V5c0xlbmd0aCA9PT0gMikgewogICAgZm4gPSBzaW1wbGVHZXR0ZXJGbjIocGF0aEtleXNbMF0sIHBhdGhLZXlzWzFdLCBmdWxsRXhwKTsKICB9IGVsc2UgaWYgKG9wdGlvbnMuY3NwKSB7CiAgICBpZiAocGF0aEtleXNMZW5ndGggPCA2KSB7CiAgICAgIGZuID0gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSwgZnVsbEV4cCwKICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIGZuID0gZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgIHZhciBpID0gMCwgdmFsOwogICAgICAgIGRvIHsKICAgICAgICAgIHZhbCA9IGNzcFNhZmVHZXR0ZXJGbihwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhLZXlzW2krK10sIGZ1bGxFeHAsIG9wdGlvbnMpKHNjb3BlLCBsb2NhbHMpOwoKICAgICAgICAgIGxvY2FscyA9IHVuZGVmaW5lZDsgLy8gY2xlYXIgYWZ0ZXIgZmlyc3QgaXRlcmF0aW9uCiAgICAgICAgICBzY29wZSA9IHZhbDsKICAgICAgICB9IHdoaWxlIChpIDwgcGF0aEtleXNMZW5ndGgpOwogICAgICAgIHJldHVybiB2YWw7CiAgICAgIH07CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBjb2RlID0gJ3ZhciBwO1xuJzsKICAgIGZvckVhY2gocGF0aEtleXMsIGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKICAgICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5LCBmdWxsRXhwKTsKICAgICAgY29kZSArPSAnaWYocyA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkO1xuJyArCiAgICAgICAgICAgICAgJ3M9JysgKGluZGV4CiAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBzaW1wbHkgZGVyZWZlcmVuY2UgJ3MnIG9uIGFueSAuZG90IG5vdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgICA/ICdzJwogICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IGlmIHdlIGFyZSBmaXJzdCB0aGVuIHdlIGNoZWNrIGxvY2FscyBmaXJzdCwgYW5kIGlmIHNvIHJlYWQgaXQgZmlyc3QKICAgICAgICAgICAgICAgICAgICAgIDogJygoayYmay5oYXNPd25Qcm9wZXJ0eSgiJyArIGtleSArICciKSk/azpzKScpICsgJ1siJyArIGtleSArICciXScgKyAnO1xuJyArCiAgICAgICAgICAgICAgKG9wdGlvbnMudW53cmFwUHJvbWlzZXMKICAgICAgICAgICAgICAgID8gJ2lmIChzICYmIHMudGhlbikge1xuJyArCiAgICAgICAgICAgICAgICAgICcgcHcoIicgKyBmdWxsRXhwLnJlcGxhY2UoLyhbIlxyXG5dKS9nLCAnXFwkMScpICsgJyIpO1xuJyArCiAgICAgICAgICAgICAgICAgICcgaWYgKCEoIiQkdiIgaW4gcykpIHtcbicgKwogICAgICAgICAgICAgICAgICAgICcgcD1zO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJyBwLiQkdiA9IHVuZGVmaW5lZDtcbicgKwogICAgICAgICAgICAgICAgICAgICcgcC50aGVuKGZ1bmN0aW9uKHYpIHtwLiQkdj12O30pO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJ31cbicgKwogICAgICAgICAgICAgICAgICAnIHM9cy4kJHZcbicgKwogICAgICAgICAgICAgICAgJ31cbicKICAgICAgICAgICAgICAgIDogJycpOwogICAgfSk7CiAgICBjb2RlICs9ICdyZXR1cm4gczsnOwoKICAgIC8qIGpzaGludCAtVzA1NCAqLwogICAgdmFyIGV2YWxlZEZuR2V0dGVyID0gbmV3IEZ1bmN0aW9uKCdzJywgJ2snLCAncHcnLCBjb2RlKTsgLy8gcz1zY29wZSwgaz1sb2NhbHMsIHB3PXByb21pc2VXYXJuaW5nCiAgICAvKiBqc2hpbnQgK1cwNTQgKi8KICAgIGV2YWxlZEZuR2V0dGVyLnRvU3RyaW5nID0gdmFsdWVGbihjb2RlKTsKICAgIGZuID0gb3B0aW9ucy51bndyYXBQcm9taXNlcyA/IGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgcmV0dXJuIGV2YWxlZEZuR2V0dGVyKHNjb3BlLCBsb2NhbHMsIHByb21pc2VXYXJuaW5nKTsKICAgIH0gOiBldmFsZWRGbkdldHRlcjsKICB9CgogIC8vIE9ubHkgY2FjaGUgdGhlIHZhbHVlIGlmIGl0J3Mgbm90IGdvaW5nIHRvIG1lc3MgdXAgdGhlIGNhY2hlIG9iamVjdAogIC8vIFRoaXMgaXMgbW9yZSBwZXJmb3JtYW50IHRoYXQgdXNpbmcgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsCiAgaWYgKHBhdGggIT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgIGdldHRlckZuQ2FjaGVbcGF0aF0gPSBmbjsKICB9CiAgcmV0dXJuIGZuOwp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRwYXJzZQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICoKICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uCiAqCiAqIGBgYGpzCiAqICAgdmFyIGdldHRlciA9ICRwYXJzZSgndXNlci5uYW1lJyk7CiAqICAgdmFyIHNldHRlciA9IGdldHRlci5hc3NpZ247CiAqICAgdmFyIGNvbnRleHQgPSB7dXNlcjp7bmFtZTonYW5ndWxhcid9fTsKICogICB2YXIgbG9jYWxzID0ge3VzZXI6e25hbWU6J2xvY2FsJ319OwogKgogKiAgIGV4cGVjdChnZXR0ZXIoY29udGV4dCkpLnRvRXF1YWwoJ2FuZ3VsYXInKTsKICogICBzZXR0ZXIoY29udGV4dCwgJ25ld1ZhbHVlJyk7CiAqICAgZXhwZWN0KGNvbnRleHQudXNlci5uYW1lKS50b0VxdWFsKCduZXdWYWx1ZScpOwogKiAgIGV4cGVjdChnZXR0ZXIoY29udGV4dCwgbG9jYWxzKSkudG9FcXVhbCgnbG9jYWwnKTsKICogYGBgCiAqCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAqCiAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICogICAgICBgY29udGV4dGAuCiAqCiAqICAgIFRoZSByZXR1cm5lZCBmdW5jdGlvbiBhbHNvIGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAqICAgICAgKiBgbGl0ZXJhbGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB3aGV0aGVyIHRoZSBleHByZXNzaW9uJ3MgdG9wLWxldmVsIG5vZGUgaXMgYSBKYXZhU2NyaXB0CiAqICAgICAgICBsaXRlcmFsLgogKiAgICAgICogYGNvbnN0YW50YCDigJMgYHtib29sZWFufWAg4oCTIHdoZXRoZXIgdGhlIGV4cHJlc3Npb24gaXMgbWFkZSBlbnRpcmVseSBvZiBKYXZhU2NyaXB0CiAqICAgICAgICBjb25zdGFudCBsaXRlcmFscy4KICogICAgICAqIGBhc3NpZ25gIOKAkyBgez9mdW5jdGlvbihjb250ZXh0LCB2YWx1ZSl9YCDigJMgaWYgdGhlIGV4cHJlc3Npb24gaXMgYXNzaWduYWJsZSwgdGhpcyB3aWxsIGJlCiAqICAgICAgICBzZXQgdG8gYSBmdW5jdGlvbiB0byBjaGFuZ2UgaXRzIHZhbHVlIG9uIHRoZSBnaXZlbiBjb250ZXh0LgogKgogKi8KCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRwYXJzZVByb3ZpZGVyCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBgJHBhcnNlUHJvdmlkZXJgIGNhbiBiZSB1c2VkIGZvciBjb25maWd1cmluZyB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiB0aGUge0BsaW5rIG5nLiRwYXJzZSAkcGFyc2V9CiAqICBzZXJ2aWNlLgogKi8KZnVuY3Rpb24gJFBhcnNlUHJvdmlkZXIoKSB7CiAgdmFyIGNhY2hlID0ge307CgogIHZhciAkcGFyc2VPcHRpb25zID0gewogICAgY3NwOiBmYWxzZSwKICAgIHVud3JhcFByb21pc2VzOiBmYWxzZSwKICAgIGxvZ1Byb21pc2VXYXJuaW5nczogdHJ1ZQogIH07CgoKICAvKioKICAgKiBAZGVwcmVjYXRlZCBQcm9taXNlIHVud3JhcHBpbmcgdmlhICRwYXJzZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIGZ1dHVyZS4KICAgKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcGFyc2VQcm92aWRlciN1bndyYXBQcm9taXNlcwogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogKipUaGlzIGZlYXR1cmUgaXMgZGVwcmVjYXRlZCwgc2VlIGRlcHJlY2F0aW9uIG5vdGVzIGJlbG93IGZvciBtb3JlIGluZm8qKgogICAqCiAgICogSWYgc2V0IHRvIHRydWUgKGRlZmF1bHQgaXMgZmFsc2UpLCAkcGFyc2Ugd2lsbCB1bndyYXAgcHJvbWlzZXMgYXV0b21hdGljYWxseSB3aGVuIGEgcHJvbWlzZSBpcwogICAqIGZvdW5kIGF0IGFueSBwYXJ0IG9mIHRoZSBleHByZXNzaW9uLiBJbiBvdGhlciB3b3JkcywgaWYgc2V0IHRvIHRydWUsIHRoZSBleHByZXNzaW9uIHdpbGwgYWx3YXlzCiAgICogcmVzdWx0IGluIGEgbm9uLXByb21pc2UgdmFsdWUuCiAgICoKICAgKiBXaGlsZSB0aGUgcHJvbWlzZSBpcyB1bnJlc29sdmVkLCBpdCdzIHRyZWF0ZWQgYXMgdW5kZWZpbmVkLCBidXQgb25jZSByZXNvbHZlZCBhbmQgZnVsZmlsbGVkLAogICAqIHRoZSBmdWxmaWxsbWVudCB2YWx1ZSBpcyB1c2VkIGluIHBsYWNlIG9mIHRoZSBwcm9taXNlIHdoaWxlIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICoKICAgKiAqKkRlcHJlY2F0aW9uIG5vdGljZSoqCiAgICoKICAgKiBUaGlzIGlzIGEgZmVhdHVyZSB0aGF0IGRpZG4ndCBwcm92ZSB0byBiZSB3aWxkbHkgdXNlZnVsIG9yIHBvcHVsYXIsIHByaW1hcmlseSBiZWNhdXNlIG9mIHRoZQogICAqIGRpY2hvdG9teSBiZXR3ZWVuIGRhdGEgYWNjZXNzIGluIHRlbXBsYXRlcyAoYWNjZXNzZWQgYXMgcmF3IHZhbHVlcykgYW5kIGNvbnRyb2xsZXIgY29kZQogICAqIChhY2Nlc3NlZCBhcyBwcm9taXNlcykuCiAgICoKICAgKiBJbiBtb3N0IGNvZGUgd2UgZW5kZWQgdXAgcmVzb2x2aW5nIHByb21pc2VzIG1hbnVhbGx5IGluIGNvbnRyb2xsZXJzIGFueXdheSBhbmQgdGh1cyB1bmlmeWluZwogICAqIHRoZSBtb2RlbCBhY2Nlc3MgdGhlcmUuCiAgICoKICAgKiBPdGhlciBkb3duc2lkZXMgb2YgYXV0b21hdGljIHByb21pc2UgdW53cmFwcGluZzoKICAgKgogICAqIC0gd2hlbiBidWlsZGluZyBjb21wb25lbnRzIGl0J3Mgb2Z0ZW4gZGVzaXJhYmxlIHRvIHJlY2VpdmUgdGhlIHJhdyBwcm9taXNlcwogICAqIC0gYWRkcyBjb21wbGV4aXR5IGFuZCBzbG93cyBkb3duIGV4cHJlc3Npb24gZXZhbHVhdGlvbgogICAqIC0gbWFrZXMgZXhwcmVzc2lvbiBjb2RlIHByZS1nZW5lcmF0aW9uIHVuYXR0cmFjdGl2ZSBkdWUgdG8gdGhlIGFtb3VudCBvZiBjb2RlIHRoYXQgbmVlZHMgdG8gYmUKICAgKiAgIGdlbmVyYXRlZAogICAqIC0gbWFrZXMgSURFIGF1dG8tY29tcGxldGlvbiBhbmQgdG9vbCBzdXBwb3J0IGhhcmQKICAgKgogICAqICoqV2FybmluZyBMb2dzKioKICAgKgogICAqIElmIHRoZSB1bndyYXBwaW5nIGlzIGVuYWJsZWQsIEFuZ3VsYXIgd2lsbCBsb2cgYSB3YXJuaW5nIGFib3V0IGVhY2ggZXhwcmVzc2lvbiB0aGF0IHVud3JhcHMgYQogICAqIHByb21pc2UgKHRvIHJlZHVjZSB0aGUgbm9pc2UsIGVhY2ggZXhwcmVzc2lvbiBpcyBsb2dnZWQgb25seSBvbmNlKS4gVG8gZGlzYWJsZSB0aGlzIGxvZ2dpbmcgdXNlCiAgICogYCRwYXJzZVByb3ZpZGVyLmxvZ1Byb21pc2VXYXJuaW5ncyhmYWxzZSlgIGFwaS4KICAgKgogICAqCiAgICogQHBhcmFtIHtib29sZWFuPX0gdmFsdWUgTmV3IHZhbHVlLgogICAqIEByZXR1cm5zIHtib29sZWFufHNlbGZ9IFJldHVybnMgdGhlIGN1cnJlbnQgc2V0dGluZyB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0ZXIuCiAgICovCiAgdGhpcy51bndyYXBQcm9taXNlcyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAkcGFyc2VPcHRpb25zLnVud3JhcFByb21pc2VzID0gISF2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJHBhcnNlT3B0aW9ucy51bndyYXBQcm9taXNlczsKICAgIH0KICB9OwoKCiAgLyoqCiAgICogQGRlcHJlY2F0ZWQgUHJvbWlzZSB1bndyYXBwaW5nIHZpYSAkcGFyc2UgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBmdXR1cmUuCiAgICoKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHBhcnNlUHJvdmlkZXIjbG9nUHJvbWlzZVdhcm5pbmdzCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBDb250cm9scyB3aGV0aGVyIEFuZ3VsYXIgc2hvdWxkIGxvZyBhIHdhcm5pbmcgb24gYW55IGVuY291bnRlciBvZiBhIHByb21pc2UgaW4gYW4gZXhwcmVzc2lvbi4KICAgKgogICAqIFRoZSBkZWZhdWx0IGlzIHNldCB0byBgdHJ1ZWAuCiAgICoKICAgKiBUaGlzIHNldHRpbmcgYXBwbGllcyBvbmx5IGlmIGAkcGFyc2VQcm92aWRlci51bndyYXBQcm9taXNlc2Agc2V0dGluZyBpcyBzZXQgdG8gdHJ1ZSBhcyB3ZWxsLgogICAqCiAgICogQHBhcmFtIHtib29sZWFuPX0gdmFsdWUgTmV3IHZhbHVlLgogICAqIEByZXR1cm5zIHtib29sZWFufHNlbGZ9IFJldHVybnMgdGhlIGN1cnJlbnQgc2V0dGluZyB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0ZXIuCiAgICovCiB0aGlzLmxvZ1Byb21pc2VXYXJuaW5ncyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAkcGFyc2VPcHRpb25zLmxvZ1Byb21pc2VXYXJuaW5ncyA9IHZhbHVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAkcGFyc2VPcHRpb25zLmxvZ1Byb21pc2VXYXJuaW5nczsKICAgIH0KICB9OwoKCiAgdGhpcy4kZ2V0ID0gWyckZmlsdGVyJywgJyRzbmlmZmVyJywgJyRsb2cnLCBmdW5jdGlvbigkZmlsdGVyLCAkc25pZmZlciwgJGxvZykgewogICAgJHBhcnNlT3B0aW9ucy5jc3AgPSAkc25pZmZlci5jc3A7CgogICAgcHJvbWlzZVdhcm5pbmcgPSBmdW5jdGlvbiBwcm9taXNlV2FybmluZ0ZuKGZ1bGxFeHApIHsKICAgICAgaWYgKCEkcGFyc2VPcHRpb25zLmxvZ1Byb21pc2VXYXJuaW5ncyB8fCBwcm9taXNlV2FybmluZ0NhY2hlLmhhc093blByb3BlcnR5KGZ1bGxFeHApKSByZXR1cm47CiAgICAgIHByb21pc2VXYXJuaW5nQ2FjaGVbZnVsbEV4cF0gPSB0cnVlOwogICAgICAkbG9nLndhcm4oJ1skcGFyc2VdIFByb21pc2UgZm91bmQgaW4gdGhlIGV4cHJlc3Npb24gYCcgKyBmdWxsRXhwICsgJ2AuICcgKwogICAgICAgICAgJ0F1dG9tYXRpYyB1bndyYXBwaW5nIG9mIHByb21pc2VzIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGVwcmVjYXRlZC4nKTsKICAgIH07CgogICAgcmV0dXJuIGZ1bmN0aW9uKGV4cCkgewogICAgICB2YXIgcGFyc2VkRXhwcmVzc2lvbjsKCiAgICAgIHN3aXRjaCAodHlwZW9mIGV4cCkgewogICAgICAgIGNhc2UgJ3N0cmluZyc6CgogICAgICAgICAgaWYgKGNhY2hlLmhhc093blByb3BlcnR5KGV4cCkpIHsKICAgICAgICAgICAgcmV0dXJuIGNhY2hlW2V4cF07CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCRwYXJzZU9wdGlvbnMpOwogICAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIobGV4ZXIsICRmaWx0ZXIsICRwYXJzZU9wdGlvbnMpOwogICAgICAgICAgcGFyc2VkRXhwcmVzc2lvbiA9IHBhcnNlci5wYXJzZShleHApOwoKICAgICAgICAgIGlmIChleHAgIT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgICAgICAgICAgLy8gT25seSBjYWNoZSB0aGUgdmFsdWUgaWYgaXQncyBub3QgZ29pbmcgdG8gbWVzcyB1cCB0aGUgY2FjaGUgb2JqZWN0CiAgICAgICAgICAgIC8vIFRoaXMgaXMgbW9yZSBwZXJmb3JtYW50IHRoYXQgdXNpbmcgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsCiAgICAgICAgICAgIGNhY2hlW2V4cF0gPSBwYXJzZWRFeHByZXNzaW9uOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBwYXJzZWRFeHByZXNzaW9uOwoKICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICByZXR1cm4gZXhwOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIG5vb3A7CiAgICAgIH0KICAgIH07CiAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkcQogKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogKgogKiBAZGVzY3JpcHRpb24KICogQSBwcm9taXNlL2RlZmVycmVkIGltcGxlbWVudGF0aW9uIGluc3BpcmVkIGJ5IFtLcmlzIEtvd2FsJ3MgUV0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKS4KICoKICogW1RoZSBDb21tb25KUyBQcm9taXNlIHByb3Bvc2FsXShodHRwOi8vd2lraS5jb21tb25qcy5vcmcvd2lraS9Qcm9taXNlcykgZGVzY3JpYmVzIGEgcHJvbWlzZSBhcyBhbgogKiBpbnRlcmZhY2UgZm9yIGludGVyYWN0aW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgcmVwcmVzZW50cyB0aGUgcmVzdWx0IG9mIGFuIGFjdGlvbiB0aGF0IGlzCiAqIHBlcmZvcm1lZCBhc3luY2hyb25vdXNseSwgYW5kIG1heSBvciBtYXkgbm90IGJlIGZpbmlzaGVkIGF0IGFueSBnaXZlbiBwb2ludCBpbiB0aW1lLgogKgogKiBGcm9tIHRoZSBwZXJzcGVjdGl2ZSBvZiBkZWFsaW5nIHdpdGggZXJyb3IgaGFuZGxpbmcsIGRlZmVycmVkIGFuZCBwcm9taXNlIEFQSXMgYXJlIHRvCiAqIGFzeW5jaHJvbm91cyBwcm9ncmFtbWluZyB3aGF0IGB0cnlgLCBgY2F0Y2hgIGFuZCBgdGhyb3dgIGtleXdvcmRzIGFyZSB0byBzeW5jaHJvbm91cyBwcm9ncmFtbWluZy4KICoKICogYGBganMKICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgLCBgc2NvcGVgIGFuZCBgb2tUb0dyZWV0YAogKiAgIC8vIGFyZSBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgbGV4aWNhbCBzY29wZSAodGhleSBjb3VsZCBoYXZlIGJlZW4gaW5qZWN0ZWQgb3IgcGFzc2VkIGluKS4KICoKICogICBmdW5jdGlvbiBhc3luY0dyZWV0KG5hbWUpIHsKICogICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAqCiAqICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgICAvLyBzaW5jZSB0aGlzIGZuIGV4ZWN1dGVzIGFzeW5jIGluIGEgZnV0dXJlIHR1cm4gb2YgdGhlIGV2ZW50IGxvb3AsIHdlIG5lZWQgdG8gd3JhcAogKiAgICAgICAvLyBvdXIgY29kZSBpbnRvIGFuICRhcHBseSBjYWxsIHNvIHRoYXQgdGhlIG1vZGVsIGNoYW5nZXMgYXJlIHByb3Blcmx5IG9ic2VydmVkLgogKiAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAqICAgICAgICAgZGVmZXJyZWQubm90aWZ5KCdBYm91dCB0byBncmVldCAnICsgbmFtZSArICcuJyk7CiAqCiAqICAgICAgICAgaWYgKG9rVG9HcmVldChuYW1lKSkgewogKiAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgnSGVsbG8sICcgKyBuYW1lICsgJyEnKTsKICogICAgICAgICB9IGVsc2UgewogKiAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KCdHcmVldGluZyAnICsgbmFtZSArICcgaXMgbm90IGFsbG93ZWQuJyk7CiAqICAgICAgICAgfQogKiAgICAgICB9KTsKICogICAgIH0sIDEwMDApOwogKgogKiAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAqICAgfQogKgogKiAgIHZhciBwcm9taXNlID0gYXN5bmNHcmVldCgnUm9iaW4gSG9vZCcpOwogKiAgIHByb21pc2UudGhlbihmdW5jdGlvbihncmVldGluZykgewogKiAgICAgYWxlcnQoJ1N1Y2Nlc3M6ICcgKyBncmVldGluZyk7CiAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAqICAgICBhbGVydCgnRmFpbGVkOiAnICsgcmVhc29uKTsKICogICB9LCBmdW5jdGlvbih1cGRhdGUpIHsKICogICAgIGFsZXJ0KCdHb3Qgbm90aWZpY2F0aW9uOiAnICsgdXBkYXRlKTsKICogICB9KTsKICogYGBgCiAqCiAqIEF0IGZpcnN0IGl0IG1pZ2h0IG5vdCBiZSBvYnZpb3VzIHdoeSB0aGlzIGV4dHJhIGNvbXBsZXhpdHkgaXMgd29ydGggdGhlIHRyb3VibGUuIFRoZSBwYXlvZmYKICogY29tZXMgaW4gdGhlIHdheSBvZiBndWFyYW50ZWVzIHRoYXQgcHJvbWlzZSBhbmQgZGVmZXJyZWQgQVBJcyBtYWtlLCBzZWUKICogaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC91bmNvbW1vbmpzL2Jsb2IvbWFzdGVyL3Byb21pc2VzL3NwZWNpZmljYXRpb24ubWQuCiAqCiAqIEFkZGl0aW9uYWxseSB0aGUgcHJvbWlzZSBhcGkgYWxsb3dzIGZvciBjb21wb3NpdGlvbiB0aGF0IGlzIHZlcnkgaGFyZCB0byBkbyB3aXRoIHRoZQogKiB0cmFkaXRpb25hbCBjYWxsYmFjayAoW0NQU10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db250aW51YXRpb24tcGFzc2luZ19zdHlsZSkpIGFwcHJvYWNoLgogKiBGb3IgbW9yZSBvbiB0aGlzIHBsZWFzZSBzZWUgdGhlIFtRIGRvY3VtZW50YXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkgZXNwZWNpYWxseSB0aGUKICogc2VjdGlvbiBvbiBzZXJpYWwgb3IgcGFyYWxsZWwgam9pbmluZyBvZiBwcm9taXNlcy4KICoKICoKICogIyBUaGUgRGVmZXJyZWQgQVBJCiAqCiAqIEEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkIGlzIGNvbnN0cnVjdGVkIGJ5IGNhbGxpbmcgYCRxLmRlZmVyKClgLgogKgogKiBUaGUgcHVycG9zZSBvZiB0aGUgZGVmZXJyZWQgb2JqZWN0IGlzIHRvIGV4cG9zZSB0aGUgYXNzb2NpYXRlZCBQcm9taXNlIGluc3RhbmNlIGFzIHdlbGwgYXMgQVBJcwogKiB0aGF0IGNhbiBiZSB1c2VkIGZvciBzaWduYWxpbmcgdGhlIHN1Y2Nlc3NmdWwgb3IgdW5zdWNjZXNzZnVsIGNvbXBsZXRpb24sIGFzIHdlbGwgYXMgdGhlIHN0YXR1cwogKiBvZiB0aGUgdGFzay4KICoKICogKipNZXRob2RzKioKICoKICogLSBgcmVzb2x2ZSh2YWx1ZSlgIOKAkyByZXNvbHZlcyB0aGUgZGVyaXZlZCBwcm9taXNlIHdpdGggdGhlIGB2YWx1ZWAuIElmIHRoZSB2YWx1ZSBpcyBhIHJlamVjdGlvbgogKiAgIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YCwgdGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpbnN0ZWFkLgogKiAtIGByZWplY3QocmVhc29uKWAg4oCTIHJlamVjdHMgdGhlIGRlcml2ZWQgcHJvbWlzZSB3aXRoIHRoZSBgcmVhc29uYC4gVGhpcyBpcyBlcXVpdmFsZW50IHRvCiAqICAgcmVzb2x2aW5nIGl0IHdpdGggYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLgogKiAtIGBub3RpZnkodmFsdWUpYCAtIHByb3ZpZGVzIHVwZGF0ZXMgb24gdGhlIHN0YXR1cyBvZiB0aGUgcHJvbWlzZSdzIGV4ZWN1dGlvbi4gVGhpcyBtYXkgYmUgY2FsbGVkCiAqICAgbXVsdGlwbGUgdGltZXMgYmVmb3JlIHRoZSBwcm9taXNlIGlzIGVpdGhlciByZXNvbHZlZCBvciByZWplY3RlZC4KICoKICogKipQcm9wZXJ0aWVzKioKICoKICogLSBwcm9taXNlIOKAkyBge1Byb21pc2V9YCDigJMgcHJvbWlzZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoaXMgZGVmZXJyZWQuCiAqCiAqCiAqICMgVGhlIFByb21pc2UgQVBJCiAqCiAqIEEgbmV3IHByb21pc2UgaW5zdGFuY2UgaXMgY3JlYXRlZCB3aGVuIGEgZGVmZXJyZWQgaW5zdGFuY2UgaXMgY3JlYXRlZCBhbmQgY2FuIGJlIHJldHJpZXZlZCBieQogKiBjYWxsaW5nIGBkZWZlcnJlZC5wcm9taXNlYC4KICoKICogVGhlIHB1cnBvc2Ugb2YgdGhlIHByb21pc2Ugb2JqZWN0IGlzIHRvIGFsbG93IGZvciBpbnRlcmVzdGVkIHBhcnRpZXMgdG8gZ2V0IGFjY2VzcyB0byB0aGUgcmVzdWx0CiAqIG9mIHRoZSBkZWZlcnJlZCB0YXNrIHdoZW4gaXQgY29tcGxldGVzLgogKgogKiAqKk1ldGhvZHMqKgogKgogKiAtIGB0aGVuKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaywgbm90aWZ5Q2FsbGJhY2spYCDigJMgcmVnYXJkbGVzcyBvZiB3aGVuIHRoZSBwcm9taXNlIHdhcyBvcgogKiAgIHdpbGwgYmUgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQsIGB0aGVuYCBjYWxscyBvbmUgb2YgdGhlIHN1Y2Nlc3Mgb3IgZXJyb3IgY2FsbGJhY2tzIGFzeW5jaHJvbm91c2x5CiAqICAgYXMgc29vbiBhcyB0aGUgcmVzdWx0IGlzIGF2YWlsYWJsZS4gVGhlIGNhbGxiYWNrcyBhcmUgY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQ6IHRoZSByZXN1bHQKICogICBvciByZWplY3Rpb24gcmVhc29uLiBBZGRpdGlvbmFsbHksIHRoZSBub3RpZnkgY2FsbGJhY2sgbWF5IGJlIGNhbGxlZCB6ZXJvIG9yIG1vcmUgdGltZXMgdG8KICogICBwcm92aWRlIGEgcHJvZ3Jlc3MgaW5kaWNhdGlvbiwgYmVmb3JlIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkLgogKgogKiAgIFRoaXMgbWV0aG9kICpyZXR1cm5zIGEgbmV3IHByb21pc2UqIHdoaWNoIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkIHZpYSB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZQogKiAgIGBzdWNjZXNzQ2FsbGJhY2tgLCBgZXJyb3JDYWxsYmFja2AuIEl0IGFsc28gbm90aWZpZXMgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlCiAqICAgYG5vdGlmeUNhbGxiYWNrYCBtZXRob2QuIFRoZSBwcm9taXNlIGNhbiBub3QgYmUgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgZnJvbSB0aGUgbm90aWZ5Q2FsbGJhY2sKICogICBtZXRob2QuCiAqCiAqIC0gYGNhdGNoKGVycm9yQ2FsbGJhY2spYCDigJMgc2hvcnRoYW5kIGZvciBgcHJvbWlzZS50aGVuKG51bGwsIGVycm9yQ2FsbGJhY2spYAogKgogKiAtIGBmaW5hbGx5KGNhbGxiYWNrKWAg4oCTIGFsbG93cyB5b3UgdG8gb2JzZXJ2ZSBlaXRoZXIgdGhlIGZ1bGZpbGxtZW50IG9yIHJlamVjdGlvbiBvZiBhIHByb21pc2UsCiAqICAgYnV0IHRvIGRvIHNvIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZSBmaW5hbCB2YWx1ZS4gVGhpcyBpcyB1c2VmdWwgdG8gcmVsZWFzZSByZXNvdXJjZXMgb3IgZG8gc29tZQogKiAgIGNsZWFuLXVwIHRoYXQgbmVlZHMgdG8gYmUgZG9uZSB3aGV0aGVyIHRoZSBwcm9taXNlIHdhcyByZWplY3RlZCBvciByZXNvbHZlZC4gU2VlIHRoZSBbZnVsbAogKiAgIHNwZWNpZmljYXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcS93aWtpL0FQSS1SZWZlcmVuY2UjcHJvbWlzZWZpbmFsbHljYWxsYmFjaykgZm9yCiAqICAgbW9yZSBpbmZvcm1hdGlvbi4KICoKICogICBCZWNhdXNlIGBmaW5hbGx5YCBpcyBhIHJlc2VydmVkIHdvcmQgaW4gSmF2YVNjcmlwdCBhbmQgcmVzZXJ2ZWQga2V5d29yZHMgYXJlIG5vdCBzdXBwb3J0ZWQgYXMKICogICBwcm9wZXJ0eSBuYW1lcyBieSBFUzMsIHlvdSdsbCBuZWVkIHRvIGludm9rZSB0aGUgbWV0aG9kIGxpa2UgYHByb21pc2VbJ2ZpbmFsbHknXShjYWxsYmFjaylgIHRvCiAqICAgbWFrZSB5b3VyIGNvZGUgSUU4IGFuZCBBbmRyb2lkIDIueCBjb21wYXRpYmxlLgogKgogKiAjIENoYWluaW5nIHByb21pc2VzCiAqCiAqIEJlY2F1c2UgY2FsbGluZyB0aGUgYHRoZW5gIG1ldGhvZCBvZiBhIHByb21pc2UgcmV0dXJucyBhIG5ldyBkZXJpdmVkIHByb21pc2UsIGl0IGlzIGVhc2lseQogKiBwb3NzaWJsZSB0byBjcmVhdGUgYSBjaGFpbiBvZiBwcm9taXNlczoKICoKICogYGBganMKICogICBwcm9taXNlQiA9IHByb21pc2VBLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAqICAgICByZXR1cm4gcmVzdWx0ICsgMTsKICogICB9KTsKICoKICogICAvLyBwcm9taXNlQiB3aWxsIGJlIHJlc29sdmVkIGltbWVkaWF0ZWx5IGFmdGVyIHByb21pc2VBIGlzIHJlc29sdmVkIGFuZCBpdHMgdmFsdWUKICogICAvLyB3aWxsIGJlIHRoZSByZXN1bHQgb2YgcHJvbWlzZUEgaW5jcmVtZW50ZWQgYnkgMQogKiBgYGAKICoKICogSXQgaXMgcG9zc2libGUgdG8gY3JlYXRlIGNoYWlucyBvZiBhbnkgbGVuZ3RoIGFuZCBzaW5jZSBhIHByb21pc2UgY2FuIGJlIHJlc29sdmVkIHdpdGggYW5vdGhlcgogKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAqIHRoZSBwcm9taXNlcyBhdCBhbnkgcG9pbnQgaW4gdGhlIGNoYWluLiBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIHRvIGltcGxlbWVudCBwb3dlcmZ1bCBBUElzIGxpa2UKICogJGh0dHAncyByZXNwb25zZSBpbnRlcmNlcHRvcnMuCiAqCiAqCiAqICMgRGlmZmVyZW5jZXMgYmV0d2VlbiBLcmlzIEtvd2FsJ3MgUSBhbmQgJHEKICoKICogIFRoZXJlIGFyZSB0d28gbWFpbiBkaWZmZXJlbmNlczoKICoKICogLSAkcSBpcyBpbnRlZ3JhdGVkIHdpdGggdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlfSBTY29wZSBtb2RlbCBvYnNlcnZhdGlvbgogKiAgIG1lY2hhbmlzbSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyBmYXN0ZXIgcHJvcGFnYXRpb24gb2YgcmVzb2x1dGlvbiBvciByZWplY3Rpb24gaW50byB5b3VyCiAqICAgbW9kZWxzIGFuZCBhdm9pZGluZyB1bm5lY2Vzc2FyeSBicm93c2VyIHJlcGFpbnRzLCB3aGljaCB3b3VsZCByZXN1bHQgaW4gZmxpY2tlcmluZyBVSS4KICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICogICBhbGwgdGhlIGltcG9ydGFudCBmdW5jdGlvbmFsaXR5IG5lZWRlZCBmb3IgY29tbW9uIGFzeW5jIHRhc2tzLgogKgogKiAgIyBUZXN0aW5nCiAqCiAqICBgYGBqcwogKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKiAgICAgIHZhciBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICoKICogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsgcmVzb2x2ZWRWYWx1ZSA9IHZhbHVlOyB9KTsKICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9CZVVuZGVmaW5lZCgpOwogKgogKiAgICAgIC8vIFNpbXVsYXRlIHJlc29sdmluZyBvZiBwcm9taXNlCiAqICAgICAgZGVmZXJyZWQucmVzb2x2ZSgxMjMpOwogKiAgICAgIC8vIE5vdGUgdGhhdCB0aGUgJ3RoZW4nIGZ1bmN0aW9uIGRvZXMgbm90IGdldCBjYWxsZWQgc3luY2hyb25vdXNseS4KICogICAgICAvLyBUaGlzIGlzIGJlY2F1c2Ugd2Ugd2FudCB0aGUgcHJvbWlzZSBBUEkgdG8gYWx3YXlzIGJlIGFzeW5jLCB3aGV0aGVyIG9yIG5vdAogKiAgICAgIC8vIGl0IGdvdCBjYWxsZWQgc3luY2hyb25vdXNseSBvciBhc3luY2hyb25vdXNseS4KICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9CZVVuZGVmaW5lZCgpOwogKgogKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICogICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0VxdWFsKDEyMyk7CiAqICAgIH0pKTsKICogIGBgYAogKi8KZnVuY3Rpb24gJFFQcm92aWRlcigpIHsKCiAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRleGNlcHRpb25IYW5kbGVyJywgZnVuY3Rpb24oJHJvb3RTY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgIHJldHVybiBxRmFjdG9yeShmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoY2FsbGJhY2spOwogICAgfSwgJGV4Y2VwdGlvbkhhbmRsZXIpOwogIH1dOwp9CgoKLyoqCiAqIENvbnN0cnVjdHMgYSBwcm9taXNlIG1hbmFnZXIuCiAqCiAqIEBwYXJhbSB7ZnVuY3Rpb24oRnVuY3Rpb24pfSBuZXh0VGljayBGdW5jdGlvbiBmb3IgZXhlY3V0aW5nIGZ1bmN0aW9ucyBpbiB0aGUgbmV4dCB0dXJuLgogKiBAcGFyYW0ge2Z1bmN0aW9uKC4uLiopfSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIGludG8gd2hpY2ggdW5leHBlY3RlZCBleGNlcHRpb25zIGFyZSBwYXNzZWQgZm9yCiAqICAgICBkZWJ1Z2dpbmcgcHVycG9zZXMuCiAqIEByZXR1cm5zIHtvYmplY3R9IFByb21pc2UgbWFuYWdlci4KICovCmZ1bmN0aW9uIHFGYWN0b3J5KG5leHRUaWNrLCBleGNlcHRpb25IYW5kbGVyKSB7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcSNkZWZlcgogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDcmVhdGVzIGEgYERlZmVycmVkYCBvYmplY3Qgd2hpY2ggcmVwcmVzZW50cyBhIHRhc2sgd2hpY2ggd2lsbCBmaW5pc2ggaW4gdGhlIGZ1dHVyZS4KICAgKgogICAqIEByZXR1cm5zIHtEZWZlcnJlZH0gUmV0dXJucyBhIG5ldyBpbnN0YW5jZSBvZiBkZWZlcnJlZC4KICAgKi8KICB2YXIgZGVmZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBwZW5kaW5nID0gW10sCiAgICAgICAgdmFsdWUsIGRlZmVycmVkOwoKICAgIGRlZmVycmVkID0gewoKICAgICAgcmVzb2x2ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBwZW5kaW5nOwogICAgICAgICAgcGVuZGluZyA9IHVuZGVmaW5lZDsKICAgICAgICAgIHZhbHVlID0gcmVmKHZhbCk7CgogICAgICAgICAgaWYgKGNhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgICAgICAgIHZhbHVlLnRoZW4oY2FsbGJhY2tbMF0sIGNhbGxiYWNrWzFdLCBjYWxsYmFja1syXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgcmVqZWN0OiBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGNyZWF0ZUludGVybmFsUmVqZWN0ZWRQcm9taXNlKHJlYXNvbikpOwogICAgICB9LAoKCiAgICAgIG5vdGlmeTogZnVuY3Rpb24ocHJvZ3Jlc3MpIHsKICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHBlbmRpbmc7CgogICAgICAgICAgaWYgKHBlbmRpbmcubGVuZ3RoKSB7CiAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFja3NbaV07CiAgICAgICAgICAgICAgICBjYWxsYmFja1syXShwcm9ncmVzcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgcHJvbWlzZTogewogICAgICAgIHRoZW46IGZ1bmN0aW9uKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc2JhY2spIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwoKICAgICAgICAgIHZhciB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChpc0Z1bmN0aW9uKGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSkpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgdmFyIHdyYXBwZWRQcm9ncmVzc2JhY2sgPSBmdW5jdGlvbihwcm9ncmVzcykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlc3VsdC5ub3RpZnkoKGlzRnVuY3Rpb24ocHJvZ3Jlc3NiYWNrKSA/IHByb2dyZXNzYmFjayA6IGRlZmF1bHRDYWxsYmFjaykocHJvZ3Jlc3MpKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgICBwZW5kaW5nLnB1c2goW3dyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2ssIHdyYXBwZWRQcm9ncmVzc2JhY2tdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlLnRoZW4od3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjaywgd3JhcHBlZFByb2dyZXNzYmFjayk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgIH0sCgogICAgICAgICJjYXRjaCI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKG51bGwsIGNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAiZmluYWxseSI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgZnVuY3Rpb24gbWFrZVByb21pc2UodmFsdWUsIHJlc29sdmVkKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwogICAgICAgICAgICBpZiAocmVzb2x2ZWQpIHsKICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNhbGxiYWNrKHZhbHVlLCBpc1Jlc29sdmVkKSB7CiAgICAgICAgICAgIHZhciBjYWxsYmFja091dHB1dCA9IG51bGw7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tPdXRwdXQgPSAoY2FsbGJhY2sgfHxkZWZhdWx0Q2FsbGJhY2spKCk7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgIHJldHVybiBtYWtlUHJvbWlzZShlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNhbGxiYWNrT3V0cHV0ICYmIGlzRnVuY3Rpb24oY2FsbGJhY2tPdXRwdXQudGhlbikpIHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tPdXRwdXQudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYWtlUHJvbWlzZSh2YWx1ZSwgaXNSZXNvbHZlZCk7CiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYWtlUHJvbWlzZShlcnJvciwgZmFsc2UpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBtYWtlUHJvbWlzZSh2YWx1ZSwgaXNSZXNvbHZlZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVDYWxsYmFjayh2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAgICAgICByZXR1cm4gaGFuZGxlQ2FsbGJhY2soZXJyb3IsIGZhbHNlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gZGVmZXJyZWQ7CiAgfTsKCgogIHZhciByZWYgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHZhbHVlICYmIGlzRnVuY3Rpb24odmFsdWUudGhlbikpIHJldHVybiB2YWx1ZTsKICAgIHJldHVybiB7CiAgICAgIHRoZW46IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXN1bHQucmVzb2x2ZShjYWxsYmFjayh2YWx1ZSkpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgfQogICAgfTsKICB9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRxI3JlamVjdAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDcmVhdGVzIGEgcHJvbWlzZSB0aGF0IGlzIHJlc29sdmVkIGFzIHJlamVjdGVkIHdpdGggdGhlIHNwZWNpZmllZCBgcmVhc29uYC4gVGhpcyBhcGkgc2hvdWxkIGJlCiAgICogdXNlZCB0byBmb3J3YXJkIHJlamVjdGlvbiBpbiBhIGNoYWluIG9mIHByb21pc2VzLiBJZiB5b3UgYXJlIGRlYWxpbmcgd2l0aCB0aGUgbGFzdCBwcm9taXNlIGluCiAgICogYSBwcm9taXNlIGNoYWluLCB5b3UgZG9uJ3QgbmVlZCB0byB3b3JyeSBhYm91dCBpdC4KICAgKgogICAqIFdoZW4gY29tcGFyaW5nIGRlZmVycmVkcy9wcm9taXNlcyB0byB0aGUgZmFtaWxpYXIgYmVoYXZpb3Igb2YgdHJ5L2NhdGNoL3Rocm93LCB0aGluayBvZgogICAqIGByZWplY3RgIGFzIHRoZSBgdGhyb3dgIGtleXdvcmQgaW4gSmF2YVNjcmlwdC4gVGhpcyBhbHNvIG1lYW5zIHRoYXQgaWYgeW91ICJjYXRjaCIgYW4gZXJyb3IgdmlhCiAgICogYSBwcm9taXNlIGVycm9yIGNhbGxiYWNrIGFuZCB5b3Ugd2FudCB0byBmb3J3YXJkIHRoZSBlcnJvciB0byB0aGUgcHJvbWlzZSBkZXJpdmVkIGZyb20gdGhlCiAgICogY3VycmVudCBwcm9taXNlLCB5b3UgaGF2ZSB0byAicmV0aHJvdyIgdGhlIGVycm9yIGJ5IHJldHVybmluZyBhIHJlamVjdGlvbiBjb25zdHJ1Y3RlZCB2aWEKICAgKiBgcmVqZWN0YC4KICAgKgogICAqIGBgYGpzCiAgICogICBwcm9taXNlQiA9IHByb21pc2VBLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICogICAgIC8vIHN1Y2Nlc3M6IGRvIHNvbWV0aGluZyBhbmQgcmVzb2x2ZSBwcm9taXNlQgogICAqICAgICAvLyAgICAgICAgICB3aXRoIHRoZSBvbGQgb3IgYSBuZXcgcmVzdWx0CiAgICogICAgIHJldHVybiByZXN1bHQ7CiAgICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgKiAgICAgLy8gZXJyb3I6IGhhbmRsZSB0aGUgZXJyb3IgaWYgcG9zc2libGUgYW5kCiAgICogICAgIC8vICAgICAgICByZXNvbHZlIHByb21pc2VCIHdpdGggbmV3UHJvbWlzZU9yVmFsdWUsCiAgICogICAgIC8vICAgICAgICBvdGhlcndpc2UgZm9yd2FyZCB0aGUgcmVqZWN0aW9uIHRvIHByb21pc2VCCiAgICogICAgIGlmIChjYW5IYW5kbGUocmVhc29uKSkgewogICAqICAgICAgLy8gaGFuZGxlIHRoZSBlcnJvciBhbmQgcmVjb3ZlcgogICAqICAgICAgcmV0dXJuIG5ld1Byb21pc2VPclZhbHVlOwogICAqICAgICB9CiAgICogICAgIHJldHVybiAkcS5yZWplY3QocmVhc29uKTsKICAgKiAgIH0pOwogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHsqfSByZWFzb24gQ29uc3RhbnQsIG1lc3NhZ2UsIGV4Y2VwdGlvbiBvciBhbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZWplY3Rpb24gcmVhc29uLgogICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHdhcyBhbHJlYWR5IHJlc29sdmVkIGFzIHJlamVjdGVkIHdpdGggdGhlIGByZWFzb25gLgogICAqLwogIHZhciByZWplY3QgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwogICAgcmVzdWx0LnJlamVjdChyZWFzb24pOwogICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogIH07CgogIHZhciBjcmVhdGVJbnRlcm5hbFJlamVjdGVkUHJvbWlzZSA9IGZ1bmN0aW9uKHJlYXNvbikgewogICAgcmV0dXJuIHsKICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChpc0Z1bmN0aW9uKGVycmJhY2spID8gZXJyYmFjayA6IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pKTsKICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgfQogICAgfTsKICB9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRxI3doZW4KICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogV3JhcHMgYW4gb2JqZWN0IHRoYXQgbWlnaHQgYmUgYSB2YWx1ZSBvciBhICgzcmQgcGFydHkpIHRoZW4tYWJsZSBwcm9taXNlIGludG8gYSAkcSBwcm9taXNlLgogICAqIFRoaXMgaXMgdXNlZnVsIHdoZW4geW91IGFyZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgbWlnaHQgb3IgbWlnaHQgbm90IGJlIGEgcHJvbWlzZSwgb3IgaWYKICAgKiB0aGUgcHJvbWlzZSBjb21lcyBmcm9tIGEgc291cmNlIHRoYXQgY2FuJ3QgYmUgdHJ1c3RlZC4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgb3IgYSBwcm9taXNlCiAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIG9mIHRoZSBwYXNzZWQgdmFsdWUgb3IgcHJvbWlzZQogICAqLwogIHZhciB3aGVuID0gZnVuY3Rpb24odmFsdWUsIGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc2JhY2spIHsKICAgIHZhciByZXN1bHQgPSBkZWZlcigpLAogICAgICAgIGRvbmU7CgogICAgdmFyIHdyYXBwZWRDYWxsYmFjayA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIChpc0Z1bmN0aW9uKGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgIHJldHVybiByZWplY3QoZSk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIChpc0Z1bmN0aW9uKGVycmJhY2spID8gZXJyYmFjayA6IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICB9CiAgICB9OwoKICAgIHZhciB3cmFwcGVkUHJvZ3Jlc3NiYWNrID0gZnVuY3Rpb24ocHJvZ3Jlc3MpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gKGlzRnVuY3Rpb24ocHJvZ3Jlc3NiYWNrKSA/IHByb2dyZXNzYmFjayA6IGRlZmF1bHRDYWxsYmFjaykocHJvZ3Jlc3MpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgfQogICAgfTsKCiAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgcmVmKHZhbHVlKS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICByZXN1bHQucmVzb2x2ZShyZWYodmFsdWUpLnRoZW4od3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjaywgd3JhcHBlZFByb2dyZXNzYmFjaykpOwogICAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgIHJlc3VsdC5yZXNvbHZlKHdyYXBwZWRFcnJiYWNrKHJlYXNvbikpOwogICAgICB9LCBmdW5jdGlvbihwcm9ncmVzcykgewogICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgcmVzdWx0Lm5vdGlmeSh3cmFwcGVkUHJvZ3Jlc3NiYWNrKHByb2dyZXNzKSk7CiAgICAgIH0pOwogICAgfSk7CgogICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogIH07CgoKICBmdW5jdGlvbiBkZWZhdWx0Q2FsbGJhY2sodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CgoKICBmdW5jdGlvbiBkZWZhdWx0RXJyYmFjayhyZWFzb24pIHsKICAgIHJldHVybiByZWplY3QocmVhc29uKTsKICB9CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHEjYWxsCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENvbWJpbmVzIG11bHRpcGxlIHByb21pc2VzIGludG8gYSBzaW5nbGUgcHJvbWlzZSB0aGF0IGlzIHJlc29sdmVkIHdoZW4gYWxsIG9mIHRoZSBpbnB1dAogICAqIHByb21pc2VzIGFyZSByZXNvbHZlZC4KICAgKgogICAqIEBwYXJhbSB7QXJyYXkuPFByb21pc2U+fE9iamVjdC48UHJvbWlzZT59IHByb21pc2VzIEFuIGFycmF5IG9yIGhhc2ggb2YgcHJvbWlzZXMuCiAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBzaW5nbGUgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBhbiBhcnJheS9oYXNoIG9mIHZhbHVlcywKICAgKiAgIGVhY2ggdmFsdWUgY29ycmVzcG9uZGluZyB0byB0aGUgcHJvbWlzZSBhdCB0aGUgc2FtZSBpbmRleC9rZXkgaW4gdGhlIGBwcm9taXNlc2AgYXJyYXkvaGFzaC4KICAgKiAgIElmIGFueSBvZiB0aGUgcHJvbWlzZXMgaXMgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbiwgdGhpcyByZXN1bHRpbmcgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkCiAgICogICB3aXRoIHRoZSBzYW1lIHJlamVjdGlvbiB2YWx1ZS4KICAgKi8KICBmdW5jdGlvbiBhbGwocHJvbWlzZXMpIHsKICAgIHZhciBkZWZlcnJlZCA9IGRlZmVyKCksCiAgICAgICAgY291bnRlciA9IDAsCiAgICAgICAgcmVzdWx0cyA9IGlzQXJyYXkocHJvbWlzZXMpID8gW10gOiB7fTsKCiAgICBmb3JFYWNoKHByb21pc2VzLCBmdW5jdGlvbihwcm9taXNlLCBrZXkpIHsKICAgICAgY291bnRlcisrOwogICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmIChyZXN1bHRzLmhhc093blByb3BlcnR5KGtleSkpIHJldHVybjsKICAgICAgICByZXN1bHRzW2tleV0gPSB2YWx1ZTsKICAgICAgICBpZiAoISgtLWNvdW50ZXIpKSBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICBpZiAocmVzdWx0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm47CiAgICAgICAgZGVmZXJyZWQucmVqZWN0KHJlYXNvbik7CiAgICAgIH0pOwogICAgfSk7CgogICAgaWYgKGNvdW50ZXIgPT09IDApIHsKICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgIH0KCiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICB9CgogIHJldHVybiB7CiAgICBkZWZlcjogZGVmZXIsCiAgICByZWplY3Q6IHJlamVjdCwKICAgIHdoZW46IHdoZW4sCiAgICBhbGw6IGFsbAogIH07Cn0KCmZ1bmN0aW9uICQkUkFGUHJvdmlkZXIoKXsgLy9yQUYKICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJHRpbWVvdXQnLCBmdW5jdGlvbigkd2luZG93LCAkdGltZW91dCkgewogICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgICB2YXIgY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSAkd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93LndlYmtpdENhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93Lm1vekNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93LndlYmtpdENhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgICB2YXIgcmFmU3VwcG9ydGVkID0gISFyZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CiAgICB2YXIgcmFmID0gcmFmU3VwcG9ydGVkCiAgICAgID8gZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIHZhciBpZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShmbik7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGlkKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICA6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICB2YXIgdGltZXIgPSAkdGltZW91dChmbiwgMTYuNjYsIGZhbHNlKTsgLy8gMTAwMCAvIDYwID0gMTYuNjY2CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICR0aW1lb3V0LmNhbmNlbCh0aW1lcik7CiAgICAgICAgICB9OwogICAgICAgIH07CgogICAgcmFmLnN1cHBvcnRlZCA9IHJhZlN1cHBvcnRlZDsKCiAgICByZXR1cm4gcmFmOwogIH1dOwp9CgovKioKICogREVTSUdOIE5PVEVTCiAqCiAqIFRoZSBkZXNpZ24gZGVjaXNpb25zIGJlaGluZCB0aGUgc2NvcGUgYXJlIGhlYXZpbHkgZmF2b3JlZCBmb3Igc3BlZWQgYW5kIG1lbW9yeSBjb25zdW1wdGlvbi4KICoKICogVGhlIHR5cGljYWwgdXNlIG9mIHNjb3BlIGlzIHRvIHdhdGNoIHRoZSBleHByZXNzaW9ucywgd2hpY2ggbW9zdCBvZiB0aGUgdGltZSByZXR1cm4gdGhlIHNhbWUKICogdmFsdWUgYXMgbGFzdCB0aW1lIHNvIHdlIG9wdGltaXplIHRoZSBvcGVyYXRpb24uCiAqCiAqIENsb3N1cmVzIGNvbnN0cnVjdGlvbiBpcyBleHBlbnNpdmUgaW4gdGVybXMgb2Ygc3BlZWQgYXMgd2VsbCBhcyBtZW1vcnk6CiAqICAgLSBObyBjbG9zdXJlcywgaW5zdGVhZCB1c2UgcHJvdG90eXBpY2FsIGluaGVyaXRhbmNlIGZvciBBUEkKICogICAtIEludGVybmFsIHN0YXRlIG5lZWRzIHRvIGJlIHN0b3JlZCBvbiBzY29wZSBkaXJlY3RseSwgd2hpY2ggbWVhbnMgdGhhdCBwcml2YXRlIHN0YXRlIGlzCiAqICAgICBleHBvc2VkIGFzICQkX19fXyBwcm9wZXJ0aWVzCiAqCiAqIExvb3Agb3BlcmF0aW9ucyBhcmUgb3B0aW1pemVkIGJ5IHVzaW5nIHdoaWxlKGNvdW50LS0pIHsgLi4uIH0KICogICAtIHRoaXMgbWVhbnMgdGhhdCBpbiBvcmRlciB0byBrZWVwIHRoZSBzYW1lIG9yZGVyIG9mIGV4ZWN1dGlvbiBhcyBhZGRpdGlvbiB3ZSBoYXZlIHRvIGFkZAogKiAgICAgaXRlbXMgdG8gdGhlIGFycmF5IGF0IHRoZSBiZWdpbm5pbmcgKHVuc2hpZnQpIGluc3RlYWQgb2YgYXQgdGhlIGVuZCAocHVzaCkKICoKICogQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIGFuZCByZW1vdmVkIG9mdGVuCiAqICAgLSBVc2luZyBhbiBhcnJheSB3b3VsZCBiZSBzbG93IHNpbmNlIGluc2VydHMgaW4gbWlkZGxlIGFyZSBleHBlbnNpdmUgc28gd2UgdXNlIGxpbmtlZCBsaXN0CiAqCiAqIFRoZXJlIGFyZSBmZXcgd2F0Y2hlcyB0aGVuIGEgbG90IG9mIG9ic2VydmVycy4gVGhpcyBpcyB3aHkgeW91IGRvbid0IHdhbnQgdGhlIG9ic2VydmVyIHRvIGJlCiAqIGltcGxlbWVudGVkIGluIHRoZSBzYW1lIHdheSBhcyB3YXRjaC4gV2F0Y2ggcmVxdWlyZXMgcmV0dXJuIG9mIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdoaWNoCiAqIGFyZSBleHBlbnNpdmUgdG8gY29uc3RydWN0LgogKi8KCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRyb290U2NvcGVQcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICoKICogUHJvdmlkZXIgZm9yIHRoZSAkcm9vdFNjb3BlIHNlcnZpY2UuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHJvb3RTY29wZVByb3ZpZGVyI2RpZ2VzdFR0bAogKiBAZGVzY3JpcHRpb24KICoKICogU2V0cyB0aGUgbnVtYmVyIG9mIGAkZGlnZXN0YCBpdGVyYXRpb25zIHRoZSBzY29wZSBzaG91bGQgYXR0ZW1wdCB0byBleGVjdXRlIGJlZm9yZSBnaXZpbmcgdXAgYW5kCiAqIGFzc3VtaW5nIHRoYXQgdGhlIG1vZGVsIGlzIHVuc3RhYmxlLgogKgogKiBUaGUgY3VycmVudCBkZWZhdWx0IGlzIDEwIGl0ZXJhdGlvbnMuCiAqCiAqIEluIGNvbXBsZXggYXBwbGljYXRpb25zIGl0J3MgcG9zc2libGUgdGhhdCB0aGUgZGVwZW5kZW5jaWVzIGJldHdlZW4gYCR3YXRjaGBzIHdpbGwgcmVzdWx0IGluCiAqIHNldmVyYWwgZGlnZXN0IGl0ZXJhdGlvbnMuIEhvd2V2ZXIgaWYgYW4gYXBwbGljYXRpb24gbmVlZHMgbW9yZSB0aGFuIHRoZSBkZWZhdWx0IDEwIGRpZ2VzdAogKiBpdGVyYXRpb25zIGZvciBpdHMgbW9kZWwgdG8gc3RhYmlsaXplIHRoZW4geW91IHNob3VsZCBpbnZlc3RpZ2F0ZSB3aGF0IGlzIGNhdXNpbmcgdGhlIG1vZGVsIHRvCiAqIGNvbnRpbnVvdXNseSBjaGFuZ2UgZHVyaW5nIHRoZSBkaWdlc3QuCiAqCiAqIEluY3JlYXNpbmcgdGhlIFRUTCBjb3VsZCBoYXZlIHBlcmZvcm1hbmNlIGltcGxpY2F0aW9ucywgc28geW91IHNob3VsZCBub3QgY2hhbmdlIGl0IHdpdGhvdXQKICogcHJvcGVyIGp1c3RpZmljYXRpb24uCiAqCiAqIEBwYXJhbSB7bnVtYmVyfSBsaW1pdCBUaGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zLgogKi8KCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHJvb3RTY29wZQogKiBAZGVzY3JpcHRpb24KICoKICogRXZlcnkgYXBwbGljYXRpb24gaGFzIGEgc2luZ2xlIHJvb3Qge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogKiBBbGwgb3RoZXIgc2NvcGVzIGFyZSBkZXNjZW5kYW50IHNjb3BlcyBvZiB0aGUgcm9vdCBzY29wZS4gU2NvcGVzIHByb3ZpZGUgc2VwYXJhdGlvbgogKiBiZXR3ZWVuIHRoZSBtb2RlbCBhbmQgdGhlIHZpZXcsIHZpYSBhIG1lY2hhbmlzbSBmb3Igd2F0Y2hpbmcgdGhlIG1vZGVsIGZvciBjaGFuZ2VzLgogKiBUaGV5IGFsc28gcHJvdmlkZSBhbiBldmVudCBlbWlzc2lvbi9icm9hZGNhc3QgYW5kIHN1YnNjcmlwdGlvbiBmYWNpbGl0eS4gU2VlIHRoZQogKiB7QGxpbmsgZ3VpZGUvc2NvcGUgZGV2ZWxvcGVyIGd1aWRlIG9uIHNjb3Blc30uCiAqLwpmdW5jdGlvbiAkUm9vdFNjb3BlUHJvdmlkZXIoKXsKICB2YXIgVFRMID0gMTA7CiAgdmFyICRyb290U2NvcGVNaW5FcnIgPSBtaW5FcnIoJyRyb290U2NvcGUnKTsKICB2YXIgbGFzdERpcnR5V2F0Y2ggPSBudWxsOwoKICB0aGlzLmRpZ2VzdFR0bCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBUVEwgPSB2YWx1ZTsKICAgIH0KICAgIHJldHVybiBUVEw7CiAgfTsKCiAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJHBhcnNlJywgJyRicm93c2VyJywKICAgICAgZnVuY3Rpb24oICRpbmplY3RvciwgICAkZXhjZXB0aW9uSGFuZGxlciwgICAkcGFyc2UsICAgJGJyb3dzZXIpIHsKCiAgICAvKioKICAgICAqIEBuZ2RvYyB0eXBlCiAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHJvb3Qgc2NvcGUgY2FuIGJlIHJldHJpZXZlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUgJHJvb3RTY29wZX0ga2V5IGZyb20gdGhlCiAgICAgKiB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIHVzaW5nIHRoZQogICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG5ldyAkbmV3KCl9IG1ldGhvZC4gKE1vc3Qgc2NvcGVzIGFyZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgd2hlbgogICAgICogY29tcGlsZWQgSFRNTCB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4pCiAgICAgKgogICAgICogSGVyZSBpcyBhIHNpbXBsZSBzY29wZSBzbmlwcGV0IHRvIHNob3cgaG93IHlvdSBjYW4gaW50ZXJhY3Qgd2l0aCB0aGUgc2NvcGUuCiAgICAgKiBgYGBodG1sCiAgICAgKiA8ZmlsZSBzcmM9Ii4vdGVzdC9uZy9yb290U2NvcGVTcGVjLmpzIiB0YWc9ImRvY3MxIiAvPgogICAgICogYGBgCiAgICAgKgogICAgICogIyBJbmhlcml0YW5jZQogICAgICogQSBzY29wZSBjYW4gaW5oZXJpdCBmcm9tIGEgcGFyZW50IHNjb3BlLCBhcyBpbiB0aGlzIGV4YW1wbGU6CiAgICAgKiBgYGBqcwogICAgICAgICB2YXIgcGFyZW50ID0gJHJvb3RTY29wZTsKICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LiRuZXcoKTsKCiAgICAgICAgIHBhcmVudC5zYWx1dGF0aW9uID0gIkhlbGxvIjsKICAgICAgICAgY2hpbGQubmFtZSA9ICJXb3JsZCI7CiAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwoKICAgICAgICAgY2hpbGQuc2FsdXRhdGlvbiA9ICJXZWxjb21lIjsKICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ1dlbGNvbWUnKTsKICAgICAgICAgZXhwZWN0KHBhcmVudC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwogICAgICogYGBgCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uKCk+PX0gcHJvdmlkZXJzIE1hcCBvZiBzZXJ2aWNlIGZhY3Rvcnkgd2hpY2ggbmVlZCB0byBiZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZCBmb3IgdGhlIGN1cnJlbnQgc2NvcGUuIERlZmF1bHRzIHRvIHtAbGluayBuZ30uCiAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCAqPj19IGluc3RhbmNlQ2FjaGUgUHJvdmlkZXMgcHJlLWluc3RhbnRpYXRlZCBzZXJ2aWNlcyB3aGljaCBzaG91bGQKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kL292ZXJyaWRlIHNlcnZpY2VzIHByb3ZpZGVkIGJ5IGBwcm92aWRlcnNgLiBUaGlzIGlzIGhhbmR5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4gdW5pdC10ZXN0aW5nIGFuZCBoYXZpbmcgdGhlIG5lZWQgdG8gb3ZlcnJpZGUgYSBkZWZhdWx0CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2UuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBOZXdseSBjcmVhdGVkIHNjb3BlLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gU2NvcGUoKSB7CiAgICAgIHRoaXMuJGlkID0gbmV4dFVpZCgpOwogICAgICB0aGlzLiQkcGhhc2UgPSB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkd2F0Y2hlcnMgPQogICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPQogICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgIHRoaXNbJ3RoaXMnXSA9IHRoaXMuJHJvb3QgPSAgdGhpczsKICAgICAgdGhpcy4kJGRlc3Ryb3llZCA9IGZhbHNlOwogICAgICB0aGlzLiQkYXN5bmNRdWV1ZSA9IFtdOwogICAgICB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlID0gW107CiAgICAgIHRoaXMuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgdGhpcy4kJGxpc3RlbmVyQ291bnQgPSB7fTsKICAgICAgdGhpcy4kJGlzb2xhdGVCaW5kaW5ncyA9IHt9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRpZAogICAgICogQHJldHVybnMge251bWJlcn0gVW5pcXVlIHNjb3BlIElEIChtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcgYWxwaGFudW1lcmljIHNlcXVlbmNlKSB1c2VmdWwgZm9yCiAgICAgKiAgIGRlYnVnZ2luZy4KICAgICAqLwoKCiAgICBTY29wZS5wcm90b3R5cGUgPSB7CiAgICAgIGNvbnN0cnVjdG9yOiBTY29wZSwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBDcmVhdGVzIGEgbmV3IGNoaWxkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfS4KICAgICAgICoKICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gZXZlbnRzLiBUaGUgc2NvcGUgY2FuIGJlIHJlbW92ZWQgZnJvbSB0aGUKICAgICAgICogc2NvcGUgaGllcmFyY2h5IHVzaW5nIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9LgogICAgICAgKgogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfSBtdXN0IGJlIGNhbGxlZCBvbiBhIHNjb3BlIHdoZW4gaXQgaXMKICAgICAgICogZGVzaXJlZCBmb3IgdGhlIHNjb3BlIGFuZCBpdHMgY2hpbGQgc2NvcGVzIHRvIGJlIHBlcm1hbmVudGx5IGRldGFjaGVkIGZyb20gdGhlIHBhcmVudCBhbmQKICAgICAgICogdGh1cyBzdG9wIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzb2xhdGUgSWYgdHJ1ZSwgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgKiAgICAgICAgIHBhcmVudCBzY29wZS4gVGhlIHNjb3BlIGlzIGlzb2xhdGVkLCBhcyBpdCBjYW4gbm90IHNlZSBwYXJlbnQgc2NvcGUgcHJvcGVydGllcy4KICAgICAgICogICAgICAgICBXaGVuIGNyZWF0aW5nIHdpZGdldHMsIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAqICAgICAgICAgc3RhdGUuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgKgogICAgICAgKi8KICAgICAgJG5ldzogZnVuY3Rpb24oaXNvbGF0ZSkgewogICAgICAgIHZhciBDaGlsZFNjb3BlLAogICAgICAgICAgICBjaGlsZDsKCiAgICAgICAgaWYgKGlzb2xhdGUpIHsKICAgICAgICAgIGNoaWxkID0gbmV3IFNjb3BlKCk7CiAgICAgICAgICBjaGlsZC4kcm9vdCA9IHRoaXMuJHJvb3Q7CiAgICAgICAgICAvLyBlbnN1cmUgdGhhdCB0aGVyZSBpcyBqdXN0IG9uZSBhc3luYyBxdWV1ZSBwZXIgJHJvb3RTY29wZSBhbmQgaXRzIGNoaWxkcmVuCiAgICAgICAgICBjaGlsZC4kJGFzeW5jUXVldWUgPSB0aGlzLiQkYXN5bmNRdWV1ZTsKICAgICAgICAgIGNoaWxkLiQkcG9zdERpZ2VzdFF1ZXVlID0gdGhpcy4kJHBvc3REaWdlc3RRdWV1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gT25seSBjcmVhdGUgYSBjaGlsZCBzY29wZSBjbGFzcyBpZiBzb21lYm9keSBhc2tzIGZvciBvbmUsCiAgICAgICAgICAvLyBidXQgY2FjaGUgaXQgdG8gYWxsb3cgdGhlIFZNIHRvIG9wdGltaXplIGxvb2t1cHMuCiAgICAgICAgICBpZiAoIXRoaXMuJCRjaGlsZFNjb3BlQ2xhc3MpIHsKICAgICAgICAgICAgdGhpcy4kJGNoaWxkU2NvcGVDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRoaXMuJCR3YXRjaGVycyA9IHRoaXMuJCRuZXh0U2libGluZyA9CiAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVyQ291bnQgPSB7fTsKICAgICAgICAgICAgICB0aGlzLiRpZCA9IG5leHRVaWQoKTsKICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRTY29wZUNsYXNzID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy4kJGNoaWxkU2NvcGVDbGFzcy5wcm90b3R5cGUgPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgY2hpbGQgPSBuZXcgdGhpcy4kJGNoaWxkU2NvcGVDbGFzcygpOwogICAgICAgIH0KICAgICAgICBjaGlsZFsndGhpcyddID0gY2hpbGQ7CiAgICAgICAgY2hpbGQuJHBhcmVudCA9IHRoaXM7CiAgICAgICAgY2hpbGQuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZFRhaWw7CiAgICAgICAgaWYgKHRoaXMuJCRjaGlsZEhlYWQpIHsKICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwuJCRuZXh0U2libGluZyA9IGNoaWxkOwogICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IGNoaWxkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IGNoaWxkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyR3YXRjaAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUmVnaXN0ZXJzIGEgYGxpc3RlbmVyYCBjYWxsYmFjayB0byBiZSBleGVjdXRlZCB3aGVuZXZlciB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICoKICAgICAgICogLSBUaGUgYHdhdGNoRXhwcmVzc2lvbmAgaXMgY2FsbGVkIG9uIGV2ZXJ5IGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdAogICAgICAgKiAgICRkaWdlc3QoKX0gYW5kIHNob3VsZCByZXR1cm4gdGhlIHZhbHVlIHRoYXQgd2lsbCBiZSB3YXRjaGVkLiAoU2luY2UKICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gcmVydW5zIHdoZW4gaXQgZGV0ZWN0cyBjaGFuZ2VzIHRoZQogICAgICAgKiAgIGB3YXRjaEV4cHJlc3Npb25gIGNhbiBleGVjdXRlIG11bHRpcGxlIHRpbWVzIHBlcgogICAgICAgKiAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQgc2hvdWxkIGJlIGlkZW1wb3RlbnQuKQogICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCBvbmx5IHdoZW4gdGhlIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgYHdhdGNoRXhwcmVzc2lvbmAgYW5kIHRoZQogICAgICAgKiAgIHByZXZpb3VzIGNhbGwgdG8gYHdhdGNoRXhwcmVzc2lvbmAgYXJlIG5vdCBlcXVhbCAod2l0aCB0aGUgZXhjZXB0aW9uIG9mIHRoZSBpbml0aWFsIHJ1biwKICAgICAgICogICBzZWUgYmVsb3cpLiBJbmVxdWFsaXR5IGlzIGRldGVybWluZWQgYWNjb3JkaW5nIHRvIHJlZmVyZW5jZSBpbmVxdWFsaXR5LAogICAgICAgKiAgIFtzdHJpY3QgY29tcGFyaXNvbl0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvT3BlcmF0b3JzL0NvbXBhcmlzb25fT3BlcmF0b3JzKQogICAgICAgKiAgICB2aWEgdGhlIGAhPT1gIEphdmFzY3JpcHQgb3BlcmF0b3IsIHVubGVzcyBgb2JqZWN0RXF1YWxpdHkgPT0gdHJ1ZWAKICAgICAgICogICAoc2VlIG5leHQgcG9pbnQpCiAgICAgICAqIC0gV2hlbiBgb2JqZWN0RXF1YWxpdHkgPT0gdHJ1ZWAsIGluZXF1YWxpdHkgb2YgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGlzIGRldGVybWluZWQKICAgICAgICogICBhY2NvcmRpbmcgdG8gdGhlIHtAbGluayBhbmd1bGFyLmVxdWFsc30gZnVuY3Rpb24uIFRvIHNhdmUgdGhlIHZhbHVlIG9mIHRoZSBvYmplY3QgZm9yCiAgICAgICAqICAgbGF0ZXIgY29tcGFyaXNvbiwgdGhlIHtAbGluayBhbmd1bGFyLmNvcHl9IGZ1bmN0aW9uIGlzIHVzZWQuIFRoaXMgdGhlcmVmb3JlIG1lYW5zIHRoYXQKICAgICAgICogICB3YXRjaGluZyBjb21wbGV4IG9iamVjdHMgd2lsbCBoYXZlIGFkdmVyc2UgbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMuCiAgICAgICAqIC0gVGhlIHdhdGNoIGBsaXN0ZW5lcmAgbWF5IGNoYW5nZSB0aGUgbW9kZWwsIHdoaWNoIG1heSB0cmlnZ2VyIG90aGVyIGBsaXN0ZW5lcmBzIHRvIGZpcmUuCiAgICAgICAqICAgVGhpcyBpcyBhY2hpZXZlZCBieSByZXJ1bm5pbmcgdGhlIHdhdGNoZXJzIHVudGlsIG5vIGNoYW5nZXMgYXJlIGRldGVjdGVkLiBUaGUgcmVydW4KICAgICAgICogICBpdGVyYXRpb24gbGltaXQgaXMgMTAgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wIGRlYWRsb2NrLgogICAgICAgKgogICAgICAgKgogICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGlzIGNhbGxlZCwKICAgICAgICogeW91IGNhbiByZWdpc3RlciBhIGB3YXRjaEV4cHJlc3Npb25gIGZ1bmN0aW9uIHdpdGggbm8gYGxpc3RlbmVyYC4gKFNpbmNlIGB3YXRjaEV4cHJlc3Npb25gCiAgICAgICAqIGNhbiBleGVjdXRlIG11bHRpcGxlIHRpbWVzIHBlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlIHdoZW4gYQogICAgICAgKiBjaGFuZ2UgaXMgZGV0ZWN0ZWQsIGJlIHByZXBhcmVkIGZvciBtdWx0aXBsZSBjYWxscyB0byB5b3VyIGxpc3RlbmVyLikKICAgICAgICoKICAgICAgICogQWZ0ZXIgYSB3YXRjaGVyIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUgc2NvcGUsIHRoZSBgbGlzdGVuZXJgIGZuIGlzIGNhbGxlZCBhc3luY2hyb25vdXNseQogICAgICAgKiAodmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMgJGV2YWxBc3luY30pIHRvIGluaXRpYWxpemUgdGhlCiAgICAgICAqIHdhdGNoZXIuIEluIHJhcmUgY2FzZXMsIHRoaXMgaXMgdW5kZXNpcmFibGUgYmVjYXVzZSB0aGUgbGlzdGVuZXIgaXMgY2FsbGVkIHdoZW4gdGhlIHJlc3VsdAogICAgICAgKiBvZiBgd2F0Y2hFeHByZXNzaW9uYCBkaWRuJ3QgY2hhbmdlLiBUbyBkZXRlY3QgdGhpcyBzY2VuYXJpbyB3aXRoaW4gdGhlIGBsaXN0ZW5lcmAgZm4sIHlvdQogICAgICAgKiBjYW4gY29tcGFyZSB0aGUgYG5ld1ZhbGAgYW5kIGBvbGRWYWxgLiBJZiB0aGVzZSB0d28gdmFsdWVzIGFyZSBpZGVudGljYWwgKGA9PT1gKSB0aGVuIHRoZQogICAgICAgKiBsaXN0ZW5lciB3YXMgY2FsbGVkIGR1ZSB0byBpbml0aWFsaXphdGlvbi4KICAgICAgICoKICAgICAgICogVGhlIGV4YW1wbGUgYmVsb3cgY29udGFpbnMgYW4gaWxsdXN0cmF0aW9uIG9mIHVzaW5nIGEgZnVuY3Rpb24gYXMgeW91ciAkd2F0Y2ggbGlzdGVuZXIKICAgICAgICoKICAgICAgICoKICAgICAgICogIyBFeGFtcGxlCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAgLy8gbGV0J3MgYXNzdW1lIHRoYXQgc2NvcGUgd2FzIGRlcGVuZGVuY3kgaW5qZWN0ZWQgYXMgdGhlICRyb290U2NvcGUKICAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlOwogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnbWlza28nOwogICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsKICAgICAgICAgICB9KTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIC8vIHRoZSBsaXN0ZW5lciBpcyBhbHdheXMgY2FsbGVkIGR1cmluZyB0aGUgZmlyc3QgJGRpZ2VzdCBsb29wIGFmdGVyIGl0IHdhcyByZWdpc3RlcmVkCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAvLyBidXQgbm93IGl0IHdpbGwgbm90IGJlIGNhbGxlZCB1bmxlc3MgdGhlIHZhbHVlIGNoYW5nZXMKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdhZGFtJzsKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMik7CgoKCiAgICAgICAgICAgLy8gVXNpbmcgYSBsaXN0ZW5lciBmdW5jdGlvbgogICAgICAgICAgIHZhciBmb29kOwogICAgICAgICAgIHNjb3BlLmZvb2RDb3VudGVyID0gMDsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgc2NvcGUuJHdhdGNoKAogICAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgbGlzdGVuZXIgZnVuY3Rpb24KICAgICAgICAgICAgIGZ1bmN0aW9uKCkgeyByZXR1cm4gZm9vZDsgfSwKICAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIGNoYW5nZSBoYW5kbGVyCiAgICAgICAgICAgICBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgaWYgKCBuZXdWYWx1ZSAhPT0gb2xkVmFsdWUgKSB7CiAgICAgICAgICAgICAgICAgLy8gT25seSBpbmNyZW1lbnQgdGhlIGNvdW50ZXIgaWYgdGhlIHZhbHVlIGNoYW5nZWQKICAgICAgICAgICAgICAgICBzY29wZS5mb29kQ291bnRlciA9IHNjb3BlLmZvb2RDb3VudGVyICsgMTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgICk7CiAgICAgICAgICAgLy8gTm8gZGlnZXN0IGhhcyBiZWVuIHJ1biBzbyB0aGUgY291bnRlciB3aWxsIGJlIHplcm8KICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIC8vIFJ1biB0aGUgZGlnZXN0IGJ1dCBzaW5jZSBmb29kIGhhcyBub3QgY2hhbmdlZCBjb3VudCB3aWxsIHN0aWxsIGJlIHplcm8KICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAvLyBVcGRhdGUgZm9vZCBhbmQgcnVuIGRpZ2VzdC4gIE5vdyB0aGUgY291bnRlciB3aWxsIGluY3JlbWVudAogICAgICAgICAgIGZvb2QgPSAnY2hlZXNlYnVyZ2VyJzsKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKX0gd2F0Y2hFeHByZXNzaW9uIEV4cHJlc3Npb24gdGhhdCBpcyBldmFsdWF0ZWQgb24gZWFjaAogICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlLiBBIGNoYW5nZSBpbiB0aGUgcmV0dXJuIHZhbHVlIHRyaWdnZXJzCiAgICAgICAqICAgIGEgY2FsbCB0byB0aGUgYGxpc3RlbmVyYC4KICAgICAgICoKICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGNhbGxlZCB3aXRoIGN1cnJlbnQgYHNjb3BlYCBhcyBhIHBhcmFtZXRlci4KICAgICAgICogQHBhcmFtIHsoZnVuY3Rpb24oKXxzdHJpbmcpPX0gbGlzdGVuZXIgQ2FsbGJhY2sgY2FsbGVkIHdoZW5ldmVyIHRoZSByZXR1cm4gdmFsdWUgb2YKICAgICAgICogICB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICoKICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSwgc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWVzIGFzCiAgICAgICAqICAgICAgcGFyYW1ldGVycy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gb2JqZWN0RXF1YWxpdHkgQ29tcGFyZSBmb3Igb2JqZWN0IGVxdWFsaXR5IHVzaW5nIHtAbGluayBhbmd1bGFyLmVxdWFsc30gaW5zdGVhZCBvZgogICAgICAgKiAgICAgY29tcGFyaW5nIGZvciByZWZlcmVuY2UgZXF1YWxpdHkuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAqLwogICAgICAkd2F0Y2g6IGZ1bmN0aW9uKHdhdGNoRXhwLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHkpIHsKICAgICAgICB2YXIgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICBnZXQgPSBjb21waWxlVG9Gbih3YXRjaEV4cCwgJ3dhdGNoJyksCiAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycywKICAgICAgICAgICAgd2F0Y2hlciA9IHsKICAgICAgICAgICAgICBmbjogbGlzdGVuZXIsCiAgICAgICAgICAgICAgbGFzdDogaW5pdFdhdGNoVmFsLAogICAgICAgICAgICAgIGdldDogZ2V0LAogICAgICAgICAgICAgIGV4cDogd2F0Y2hFeHAsCiAgICAgICAgICAgICAgZXE6ICEhb2JqZWN0RXF1YWxpdHkKICAgICAgICAgICAgfTsKCiAgICAgICAgbGFzdERpcnR5V2F0Y2ggPSBudWxsOwoKICAgICAgICAvLyBpbiB0aGUgY2FzZSB1c2VyIHBhc3Mgc3RyaW5nLCB3ZSBuZWVkIHRvIGNvbXBpbGUgaXQsIGRvIHdlIHJlYWxseSBuZWVkIHRoaXMgPwogICAgICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpIHsKICAgICAgICAgIHZhciBsaXN0ZW5GbiA9IGNvbXBpbGVUb0ZuKGxpc3RlbmVyIHx8IG5vb3AsICdsaXN0ZW5lcicpOwogICAgICAgICAgd2F0Y2hlci5mbiA9IGZ1bmN0aW9uKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkge2xpc3RlbkZuKHNjb3BlKTt9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiB3YXRjaEV4cCA9PSAnc3RyaW5nJyAmJiBnZXQuY29uc3RhbnQpIHsKICAgICAgICAgIHZhciBvcmlnaW5hbEZuID0gd2F0Y2hlci5mbjsKICAgICAgICAgIHdhdGNoZXIuZm4gPSBmdW5jdGlvbihuZXdWYWwsIG9sZFZhbCwgc2NvcGUpIHsKICAgICAgICAgICAgb3JpZ2luYWxGbi5jYWxsKHRoaXMsIG5ld1ZhbCwgb2xkVmFsLCBzY29wZSk7CiAgICAgICAgICAgIGFycmF5UmVtb3ZlKGFycmF5LCB3YXRjaGVyKTsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoIWFycmF5KSB7CiAgICAgICAgICBhcnJheSA9IHNjb3BlLiQkd2F0Y2hlcnMgPSBbXTsKICAgICAgICB9CiAgICAgICAgLy8gd2UgdXNlIHVuc2hpZnQgc2luY2Ugd2UgdXNlIGEgd2hpbGUgbG9vcCBpbiAkZGlnZXN0IGZvciBzcGVlZC4KICAgICAgICAvLyB0aGUgd2hpbGUgbG9vcCByZWFkcyBpbiByZXZlcnNlIG9yZGVyLgogICAgICAgIGFycmF5LnVuc2hpZnQod2F0Y2hlcik7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiBkZXJlZ2lzdGVyV2F0Y2goKSB7CiAgICAgICAgICBhcnJheVJlbW92ZShhcnJheSwgd2F0Y2hlcik7CiAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CiAgICAgICAgfTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyR3YXRjaENvbGxlY3Rpb24KICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNoYWxsb3cgd2F0Y2hlcyB0aGUgcHJvcGVydGllcyBvZiBhbiBvYmplY3QgYW5kIGZpcmVzIHdoZW5ldmVyIGFueSBvZiB0aGUgcHJvcGVydGllcyBjaGFuZ2UKICAgICAgICogKGZvciBhcnJheXMsIHRoaXMgaW1wbGllcyB3YXRjaGluZyB0aGUgYXJyYXkgaXRlbXM7IGZvciBvYmplY3QgbWFwcywgdGhpcyBpbXBsaWVzIHdhdGNoaW5nCiAgICAgICAqIHRoZSBwcm9wZXJ0aWVzKS4gSWYgYSBjaGFuZ2UgaXMgZGV0ZWN0ZWQsIHRoZSBgbGlzdGVuZXJgIGNhbGxiYWNrIGlzIGZpcmVkLgogICAgICAgKgogICAgICAgKiAtIFRoZSBgb2JqYCBjb2xsZWN0aW9uIGlzIG9ic2VydmVkIHZpYSBzdGFuZGFyZCAkd2F0Y2ggb3BlcmF0aW9uIGFuZCBpcyBleGFtaW5lZCBvbiBldmVyeQogICAgICAgKiAgIGNhbGwgdG8gJGRpZ2VzdCgpIHRvIHNlZSBpZiBhbnkgaXRlbXMgaGF2ZSBiZWVuIGFkZGVkLCByZW1vdmVkLCBvciBtb3ZlZC4KICAgICAgICogLSBUaGUgYGxpc3RlbmVyYCBpcyBjYWxsZWQgd2hlbmV2ZXIgYW55dGhpbmcgd2l0aGluIHRoZSBgb2JqYCBoYXMgY2hhbmdlZC4gRXhhbXBsZXMgaW5jbHVkZQogICAgICAgKiAgIGFkZGluZywgcmVtb3ZpbmcsIGFuZCBtb3ZpbmcgaXRlbXMgYmVsb25naW5nIHRvIGFuIG9iamVjdCBvciBhcnJheS4KICAgICAgICoKICAgICAgICoKICAgICAgICogIyBFeGFtcGxlCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ2lnb3InLCAnbWF0aWFzJywgJ21pc2tvJywgJ2phbWVzJ107CiAgICAgICAgICAkc2NvcGUuZGF0YUNvdW50ID0gNDsKCiAgICAgICAgICAkc2NvcGUuJHdhdGNoQ29sbGVjdGlvbignbmFtZXMnLCBmdW5jdGlvbihuZXdOYW1lcywgb2xkTmFtZXMpIHsKICAgICAgICAgICAgJHNjb3BlLmRhdGFDb3VudCA9IG5ld05hbWVzLmxlbmd0aDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDQpOwogICAgICAgICAgJHNjb3BlLiRkaWdlc3QoKTsKCiAgICAgICAgICAvL3N0aWxsIGF0IDQgLi4uIG5vIGNoYW5nZXMKICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDQpOwoKICAgICAgICAgICRzY29wZS5uYW1lcy5wb3AoKTsKICAgICAgICAgICRzY29wZS4kZGlnZXN0KCk7CgogICAgICAgICAgLy9ub3cgdGhlcmUncyBiZWVuIGEgY2hhbmdlCiAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCgzKTsKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfGZ1bmN0aW9uKHNjb3BlKX0gb2JqIEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4gVGhlCiAgICAgICAqICAgIGV4cHJlc3Npb24gdmFsdWUgc2hvdWxkIGV2YWx1YXRlIHRvIGFuIG9iamVjdCBvciBhbiBhcnJheSB3aGljaCBpcyBvYnNlcnZlZCBvbiBlYWNoCiAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEFueSBzaGFsbG93IGNoYW5nZSB3aXRoaW4gdGhlCiAgICAgICAqICAgIGNvbGxlY3Rpb24gd2lsbCB0cmlnZ2VyIGEgY2FsbCB0byB0aGUgYGxpc3RlbmVyYC4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihuZXdDb2xsZWN0aW9uLCBvbGRDb2xsZWN0aW9uLCBzY29wZSl9IGxpc3RlbmVyIGEgY2FsbGJhY2sgZnVuY3Rpb24gY2FsbGVkCiAgICAgICAqICAgIHdoZW4gYSBjaGFuZ2UgaXMgZGV0ZWN0ZWQuCiAgICAgICAqICAgIC0gVGhlIGBuZXdDb2xsZWN0aW9uYCBvYmplY3QgaXMgdGhlIG5ld2x5IG1vZGlmaWVkIGRhdGEgb2J0YWluZWQgZnJvbSB0aGUgYG9iamAgZXhwcmVzc2lvbgogICAgICAgKiAgICAtIFRoZSBgb2xkQ29sbGVjdGlvbmAgb2JqZWN0IGlzIGEgY29weSBvZiB0aGUgZm9ybWVyIGNvbGxlY3Rpb24gZGF0YS4KICAgICAgICogICAgICBEdWUgdG8gcGVyZm9ybWFuY2UgY29uc2lkZXJhdGlvbnMsIHRoZWBvbGRDb2xsZWN0aW9uYCB2YWx1ZSBpcyBjb21wdXRlZCBvbmx5IGlmIHRoZQogICAgICAgKiAgICAgIGBsaXN0ZW5lcmAgZnVuY3Rpb24gZGVjbGFyZXMgdHdvIG9yIG1vcmUgYXJndW1lbnRzLgogICAgICAgKiAgICAtIFRoZSBgc2NvcGVgIGFyZ3VtZW50IHJlZmVycyB0byB0aGUgY3VycmVudCBzY29wZS4KICAgICAgICoKICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZS1yZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuIFdoZW4gdGhlCiAgICAgICAqICAgIGRlLXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBpcyBleGVjdXRlZCwgdGhlIGludGVybmFsIHdhdGNoIG9wZXJhdGlvbiBpcyB0ZXJtaW5hdGVkLgogICAgICAgKi8KICAgICAgJHdhdGNoQ29sbGVjdGlvbjogZnVuY3Rpb24ob2JqLCBsaXN0ZW5lcikgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAvLyB0aGUgY3VycmVudCB2YWx1ZSwgdXBkYXRlZCBvbiBlYWNoIGRpcnR5LWNoZWNrIHJ1bgogICAgICAgIHZhciBuZXdWYWx1ZTsKICAgICAgICAvLyBhIHNoYWxsb3cgY29weSBvZiB0aGUgbmV3VmFsdWUgZnJvbSB0aGUgbGFzdCBkaXJ0eS1jaGVjayBydW4sCiAgICAgICAgLy8gdXBkYXRlZCB0byBtYXRjaCBuZXdWYWx1ZSBkdXJpbmcgZGlydHktY2hlY2sgcnVuCiAgICAgICAgdmFyIG9sZFZhbHVlOwogICAgICAgIC8vIGEgc2hhbGxvdyBjb3B5IG9mIHRoZSBuZXdWYWx1ZSBmcm9tIHdoZW4gdGhlIGxhc3QgY2hhbmdlIGhhcHBlbmVkCiAgICAgICAgdmFyIHZlcnlPbGRWYWx1ZTsKICAgICAgICAvLyBvbmx5IHRyYWNrIHZlcnlPbGRWYWx1ZSBpZiB0aGUgbGlzdGVuZXIgaXMgYXNraW5nIGZvciBpdAogICAgICAgIHZhciB0cmFja1ZlcnlPbGRWYWx1ZSA9IChsaXN0ZW5lci5sZW5ndGggPiAxKTsKICAgICAgICB2YXIgY2hhbmdlRGV0ZWN0ZWQgPSAwOwogICAgICAgIHZhciBvYmpHZXR0ZXIgPSAkcGFyc2Uob2JqKTsKICAgICAgICB2YXIgaW50ZXJuYWxBcnJheSA9IFtdOwogICAgICAgIHZhciBpbnRlcm5hbE9iamVjdCA9IHt9OwogICAgICAgIHZhciBpbml0UnVuID0gdHJ1ZTsKICAgICAgICB2YXIgb2xkTGVuZ3RoID0gMDsKCiAgICAgICAgZnVuY3Rpb24gJHdhdGNoQ29sbGVjdGlvbldhdGNoKCkgewogICAgICAgICAgbmV3VmFsdWUgPSBvYmpHZXR0ZXIoc2VsZik7CiAgICAgICAgICB2YXIgbmV3TGVuZ3RoLCBrZXk7CgogICAgICAgICAgaWYgKCFpc09iamVjdChuZXdWYWx1ZSkpIHsgLy8gaWYgcHJpbWl0aXZlCiAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBvbGRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2UobmV3VmFsdWUpKSB7CiAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gaW50ZXJuYWxBcnJheSkgewogICAgICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2l0aW9uaW5nIGZyb20gc29tZXRoaW5nIHdoaWNoIHdhcyBub3QgYW4gYXJyYXkgaW50byBhcnJheS4KICAgICAgICAgICAgICBvbGRWYWx1ZSA9IGludGVybmFsQXJyYXk7CiAgICAgICAgICAgICAgb2xkTGVuZ3RoID0gb2xkVmFsdWUubGVuZ3RoID0gMDsKICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdMZW5ndGggPSBuZXdWYWx1ZS5sZW5ndGg7CgogICAgICAgICAgICBpZiAob2xkTGVuZ3RoICE9PSBuZXdMZW5ndGgpIHsKICAgICAgICAgICAgICAvLyBpZiBsZW5ndGhzIGRvIG5vdCBtYXRjaCB3ZSBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIG5vdGlmaWNhdGlvbgogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgb2xkVmFsdWUubGVuZ3RoID0gb2xkTGVuZ3RoID0gbmV3TGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGNvcHkgdGhlIGl0ZW1zIHRvIG9sZFZhbHVlIGFuZCBsb29rIGZvciBjaGFuZ2VzLgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0xlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGJvdGhOYU4gPSAob2xkVmFsdWVbaV0gIT09IG9sZFZhbHVlW2ldKSAmJgogICAgICAgICAgICAgICAgICAobmV3VmFsdWVbaV0gIT09IG5ld1ZhbHVlW2ldKTsKICAgICAgICAgICAgICBpZiAoIWJvdGhOYU4gJiYgKG9sZFZhbHVlW2ldICE9PSBuZXdWYWx1ZVtpXSkpIHsKICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgICBvbGRWYWx1ZVtpXSA9IG5ld1ZhbHVlW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBpbnRlcm5hbE9iamVjdCkgewogICAgICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2l0aW9uaW5nIGZyb20gc29tZXRoaW5nIHdoaWNoIHdhcyBub3QgYW4gb2JqZWN0IGludG8gb2JqZWN0LgogICAgICAgICAgICAgIG9sZFZhbHVlID0gaW50ZXJuYWxPYmplY3QgPSB7fTsKICAgICAgICAgICAgICBvbGRMZW5ndGggPSAwOwogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gY29weSB0aGUgaXRlbXMgdG8gb2xkVmFsdWUgYW5kIGxvb2sgZm9yIGNoYW5nZXMuCiAgICAgICAgICAgIG5ld0xlbmd0aCA9IDA7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIG5ld0xlbmd0aCsrOwogICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlW2tleV0gIT09IG5ld1ZhbHVlW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlW2tleV0gPSBuZXdWYWx1ZVtrZXldOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBvbGRMZW5ndGgrKzsKICAgICAgICAgICAgICAgICAgb2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvbGRMZW5ndGggPiBuZXdMZW5ndGgpIHsKICAgICAgICAgICAgICAvLyB3ZSB1c2VkIHRvIGhhdmUgbW9yZSBrZXlzLCBuZWVkIHRvIGZpbmQgdGhlbSBhbmQgZGVzdHJveSB0aGVtLgogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgZm9yKGtleSBpbiBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlLmhhc093blByb3BlcnR5KGtleSkgJiYgIW5ld1ZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgb2xkTGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSBvbGRWYWx1ZVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoYW5nZURldGVjdGVkOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gJHdhdGNoQ29sbGVjdGlvbkFjdGlvbigpIHsKICAgICAgICAgIGlmIChpbml0UnVuKSB7CiAgICAgICAgICAgIGluaXRSdW4gPSBmYWxzZTsKICAgICAgICAgICAgbGlzdGVuZXIobmV3VmFsdWUsIG5ld1ZhbHVlLCBzZWxmKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpc3RlbmVyKG5ld1ZhbHVlLCB2ZXJ5T2xkVmFsdWUsIHNlbGYpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIG1ha2UgYSBjb3B5IGZvciB0aGUgbmV4dCB0aW1lIGEgY29sbGVjdGlvbiBpcyBjaGFuZ2VkCiAgICAgICAgICBpZiAodHJhY2tWZXJ5T2xkVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFpc09iamVjdChuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAvL3ByaW1pdGl2ZQogICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZSA9IG5ldyBBcnJheShuZXdWYWx1ZS5sZW5ndGgpOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3VmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZVtpXSA9IG5ld1ZhbHVlW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsgLy8gaWYgb2JqZWN0CiAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0ge307CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChuZXdWYWx1ZSwga2V5KSkgewogICAgICAgICAgICAgICAgICB2ZXJ5T2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy4kd2F0Y2goJHdhdGNoQ29sbGVjdGlvbldhdGNoLCAkd2F0Y2hDb2xsZWN0aW9uQWN0aW9uKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUHJvY2Vzc2VzIGFsbCBvZiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJzfSBvZiB0aGUgY3VycmVudCBzY29wZSBhbmQKICAgICAgICogaXRzIGNoaWxkcmVuLiBCZWNhdXNlIGEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJ9J3MgbGlzdGVuZXIgY2FuIGNoYW5nZQogICAgICAgKiB0aGUgbW9kZWwsIHRoZSBgJGRpZ2VzdCgpYCBrZWVwcyBjYWxsaW5nIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcnN9CiAgICAgICAqIHVudGlsIG5vIG1vcmUgbGlzdGVuZXJzIGFyZSBmaXJpbmcuIFRoaXMgbWVhbnMgdGhhdCBpdCBpcyBwb3NzaWJsZSB0byBnZXQgaW50byBhbiBpbmZpbml0ZQogICAgICAgKiBsb29wLiBUaGlzIGZ1bmN0aW9uIHdpbGwgdGhyb3cgYCdNYXhpbXVtIGl0ZXJhdGlvbiBsaW1pdCBleGNlZWRlZC4nYCBpZiB0aGUgbnVtYmVyIG9mCiAgICAgICAqIGl0ZXJhdGlvbnMgZXhjZWVkcyAxMC4KICAgICAgICoKICAgICAgICogVXN1YWxseSwgeW91IGRvbid0IGNhbGwgYCRkaWdlc3QoKWAgZGlyZWN0bHkgaW4KICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NvbnRyb2xsZXIgY29udHJvbGxlcnN9IG9yIGluCiAgICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4KICAgICAgICogSW5zdGVhZCwgeW91IHNob3VsZCBjYWxsIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHkoKX0gKHR5cGljYWxseSBmcm9tIHdpdGhpbgogICAgICAgKiBhIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfSksIHdoaWNoIHdpbGwgZm9yY2UgYSBgJGRpZ2VzdCgpYC4KICAgICAgICoKICAgICAgICogSWYgeW91IHdhbnQgdG8gYmUgbm90aWZpZWQgd2hlbmV2ZXIgYCRkaWdlc3QoKWAgaXMgY2FsbGVkLAogICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aAogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggJHdhdGNoKCl9IHdpdGggbm8gYGxpc3RlbmVyYC4KICAgICAgICoKICAgICAgICogSW4gdW5pdCB0ZXN0cywgeW91IG1heSBuZWVkIHRvIGNhbGwgYCRkaWdlc3QoKWAgdG8gc2ltdWxhdGUgdGhlIHNjb3BlIGxpZmUgY3ljbGUuCiAgICAgICAqCiAgICAgICAqICMgRXhhbXBsZQogICAgICAgKiBgYGBqcwogICAgICAgICAgIHZhciBzY29wZSA9IC4uLjsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICBzY29wZS5jb3VudGVyID0gMDsKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAvLyB0aGUgbGlzdGVuZXIgaXMgYWx3YXlzIGNhbGxlZCBkdXJpbmcgdGhlIGZpcnN0ICRkaWdlc3QgbG9vcCBhZnRlciBpdCB3YXMgcmVnaXN0ZXJlZAogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgLy8gYnV0IG5vdyBpdCB3aWxsIG5vdCBiZSBjYWxsZWQgdW5sZXNzIHRoZSB2YWx1ZSBjaGFuZ2VzCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDIpOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICovCiAgICAgICRkaWdlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB3YXRjaCwgdmFsdWUsIGxhc3QsCiAgICAgICAgICAgIHdhdGNoZXJzLAogICAgICAgICAgICBhc3luY1F1ZXVlID0gdGhpcy4kJGFzeW5jUXVldWUsCiAgICAgICAgICAgIHBvc3REaWdlc3RRdWV1ZSA9IHRoaXMuJCRwb3N0RGlnZXN0UXVldWUsCiAgICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgICAgZGlydHksIHR0bCA9IFRUTCwKICAgICAgICAgICAgbmV4dCwgY3VycmVudCwgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgd2F0Y2hMb2cgPSBbXSwKICAgICAgICAgICAgbG9nSWR4LCBsb2dNc2csIGFzeW5jVGFzazsKCiAgICAgICAgYmVnaW5QaGFzZSgnJGRpZ2VzdCcpOwoKICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CgogICAgICAgIGRvIHsgLy8gIndoaWxlIGRpcnR5IiBsb29wCiAgICAgICAgICBkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgY3VycmVudCA9IHRhcmdldDsKCiAgICAgICAgICB3aGlsZShhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGFzeW5jVGFzayA9IGFzeW5jUXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgICBhc3luY1Rhc2suc2NvcGUuJGV2YWwoYXN5bmNUYXNrLmV4cHJlc3Npb24pOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICB0cmF2ZXJzZVNjb3Blc0xvb3A6CiAgICAgICAgICBkbyB7IC8vICJ0cmF2ZXJzZSB0aGUgc2NvcGVzIiBsb29wCiAgICAgICAgICAgIGlmICgod2F0Y2hlcnMgPSBjdXJyZW50LiQkd2F0Y2hlcnMpKSB7CiAgICAgICAgICAgICAgLy8gcHJvY2VzcyBvdXIgd2F0Y2hlcwogICAgICAgICAgICAgIGxlbmd0aCA9IHdhdGNoZXJzLmxlbmd0aDsKICAgICAgICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHdhdGNoID0gd2F0Y2hlcnNbbGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgLy8gTW9zdCBjb21tb24gd2F0Y2hlcyBhcmUgb24gcHJpbWl0aXZlcywgaW4gd2hpY2ggY2FzZSB3ZSBjYW4gc2hvcnQKICAgICAgICAgICAgICAgICAgLy8gY2lyY3VpdCBpdCB3aXRoID09PSBvcGVyYXRvciwgb25seSB3aGVuID09PSBmYWlscyBkbyB3ZSB1c2UgLmVxdWFscwogICAgICAgICAgICAgICAgICBpZiAod2F0Y2gpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKHZhbHVlID0gd2F0Y2guZ2V0KGN1cnJlbnQpKSAhPT0gKGxhc3QgPSB3YXRjaC5sYXN0KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAhKHdhdGNoLmVxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGVxdWFscyh2YWx1ZSwgbGFzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgaXNOYU4odmFsdWUpICYmIGlzTmFOKGxhc3QpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGxhc3REaXJ0eVdhdGNoID0gd2F0Y2g7CiAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5sYXN0ID0gd2F0Y2guZXEgPyBjb3B5KHZhbHVlLCBudWxsKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgd2F0Y2guZm4odmFsdWUsICgobGFzdCA9PT0gaW5pdFdhdGNoVmFsKSA/IHZhbHVlIDogbGFzdCksIGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHR0bCA8IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nSWR4ID0gNCAtIHR0bDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXRjaExvZ1tsb2dJZHhdKSB3YXRjaExvZ1tsb2dJZHhdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ01zZyA9IChpc0Z1bmN0aW9uKHdhdGNoLmV4cCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdmbjogJyArICh3YXRjaC5leHAubmFtZSB8fCB3YXRjaC5leHAudG9TdHJpbmcoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogd2F0Y2guZXhwOwogICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgKz0gJzsgbmV3VmFsOiAnICsgdG9Kc29uKHZhbHVlKSArICc7IG9sZFZhbDogJyArIHRvSnNvbihsYXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hMb2dbbG9nSWR4XS5wdXNoKGxvZ01zZyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh3YXRjaCA9PT0gbGFzdERpcnR5V2F0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBtb3N0IHJlY2VudGx5IGRpcnR5IHdhdGNoZXIgaXMgbm93IGNsZWFuLCBzaG9ydCBjaXJjdWl0IHNpbmNlIHRoZSByZW1haW5pbmcgd2F0Y2hlcnMKICAgICAgICAgICAgICAgICAgICAgIC8vIGhhdmUgYWxyZWFkeSBiZWVuIHRlc3RlZC4KICAgICAgICAgICAgICAgICAgICAgIGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayB0cmF2ZXJzZVNjb3Blc0xvb3A7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgLy8gdGhpcyBwaWVjZSBzaG91bGQgYmUga2VwdCBpbiBzeW5jIHdpdGggdGhlIHRyYXZlcnNhbCBpbiAkYnJvYWRjYXN0CiAgICAgICAgICAgIGlmICghKG5leHQgPSAoY3VycmVudC4kJGNoaWxkSGVhZCB8fAogICAgICAgICAgICAgICAgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICB3aGlsZShjdXJyZW50ICE9PSB0YXJnZXQgJiYgIShuZXh0ID0gY3VycmVudC4kJG5leHRTaWJsaW5nKSkgewogICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gbmV4dCkpOwoKICAgICAgICAgIC8vIGBicmVhayB0cmF2ZXJzZVNjb3Blc0xvb3A7YCB0YWtlcyB1cyB0byBoZXJlCgogICAgICAgICAgaWYoKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKSAmJiAhKHR0bC0tKSkgewogICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgIHRocm93ICRyb290U2NvcGVNaW5FcnIoJ2luZmRpZycsCiAgICAgICAgICAgICAgICAnezB9ICRkaWdlc3QoKSBpdGVyYXRpb25zIHJlYWNoZWQuIEFib3J0aW5nIVxuJyArCiAgICAgICAgICAgICAgICAnV2F0Y2hlcnMgZmlyZWQgaW4gdGhlIGxhc3QgNSBpdGVyYXRpb25zOiB7MX0nLAogICAgICAgICAgICAgICAgVFRMLCB0b0pzb24od2F0Y2hMb2cpKTsKICAgICAgICAgIH0KCiAgICAgICAgfSB3aGlsZSAoZGlydHkgfHwgYXN5bmNRdWV1ZS5sZW5ndGgpOwoKICAgICAgICBjbGVhclBoYXNlKCk7CgogICAgICAgIHdoaWxlKHBvc3REaWdlc3RRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHBvc3REaWdlc3RRdWV1ZS5zaGlmdCgpKCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kKICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gc2NvcGUgYmVpbmcgZGVzdHJveWVkCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBCcm9hZGNhc3RlZCB3aGVuIGEgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbiBhcmUgYmVpbmcgZGVzdHJveWVkLgogICAgICAgKgogICAgICAgKiBOb3RlIHRoYXQsIGluIEFuZ3VsYXJKUywgdGhlcmUgaXMgYWxzbyBhIGAkZGVzdHJveWAgalF1ZXJ5IGV2ZW50LCB3aGljaCBjYW4gYmUgdXNlZCB0bwogICAgICAgKiBjbGVhbiB1cCBET00gYmluZGluZ3MgYmVmb3JlIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00uCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUmVtb3ZlcyB0aGUgY3VycmVudCBzY29wZSAoYW5kIGFsbCBvZiBpdHMgY2hpbGRyZW4pIGZyb20gdGhlIHBhcmVudCBzY29wZS4gUmVtb3ZhbCBpbXBsaWVzCiAgICAgICAqIHRoYXQgY2FsbHMgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IHdpbGwgbm8gbG9uZ2VyCiAgICAgICAqIHByb3BhZ2F0ZSB0byB0aGUgY3VycmVudCBzY29wZSBhbmQgaXRzIGNoaWxkcmVuLiBSZW1vdmFsIGFsc28gaW1wbGllcyB0aGF0IHRoZSBjdXJyZW50CiAgICAgICAqIHNjb3BlIGlzIGVsaWdpYmxlIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24uCiAgICAgICAqCiAgICAgICAqIFRoZSBgJGRlc3Ryb3koKWAgaXMgdXN1YWxseSB1c2VkIGJ5IGRpcmVjdGl2ZXMgc3VjaCBhcwogICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fSBmb3IgbWFuYWdpbmcgdGhlCiAgICAgICAqIHVucm9sbGluZyBvZiB0aGUgbG9vcC4KICAgICAgICoKICAgICAgICogSnVzdCBiZWZvcmUgYSBzY29wZSBpcyBkZXN0cm95ZWQsIGEgYCRkZXN0cm95YCBldmVudCBpcyBicm9hZGNhc3RlZCBvbiB0aGlzIHNjb3BlLgogICAgICAgKiBBcHBsaWNhdGlvbiBjb2RlIGNhbiByZWdpc3RlciBhIGAkZGVzdHJveWAgZXZlbnQgaGFuZGxlciB0aGF0IHdpbGwgZ2l2ZSBpdCBhIGNoYW5jZSB0bwogICAgICAgKiBwZXJmb3JtIGFueSBuZWNlc3NhcnkgY2xlYW51cC4KICAgICAgICoKICAgICAgICogTm90ZSB0aGF0LCBpbiBBbmd1bGFySlMsIHRoZXJlIGlzIGFsc28gYSBgJGRlc3Ryb3lgIGpRdWVyeSBldmVudCwgd2hpY2ggY2FuIGJlIHVzZWQgdG8KICAgICAgICogY2xlYW4gdXAgRE9NIGJpbmRpbmdzIGJlZm9yZSBhbiBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgKi8KICAgICAgJGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIHdlIGNhbid0IGRlc3Ryb3kgdGhlIHJvb3Qgc2NvcGUgb3IgYSBzY29wZSB0aGF0IGhhcyBiZWVuIGFscmVhZHkgZGVzdHJveWVkCiAgICAgICAgaWYgKHRoaXMuJCRkZXN0cm95ZWQpIHJldHVybjsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy4kcGFyZW50OwoKICAgICAgICB0aGlzLiRicm9hZGNhc3QoJyRkZXN0cm95Jyk7CiAgICAgICAgdGhpcy4kJGRlc3Ryb3llZCA9IHRydWU7CiAgICAgICAgaWYgKHRoaXMgPT09ICRyb290U2NvcGUpIHJldHVybjsKCiAgICAgICAgZm9yRWFjaCh0aGlzLiQkbGlzdGVuZXJDb3VudCwgYmluZChudWxsLCBkZWNyZW1lbnRMaXN0ZW5lckNvdW50LCB0aGlzKSk7CgogICAgICAgIC8vIHNldmVyIGFsbCB0aGUgcmVmZXJlbmNlcyB0byBwYXJlbnQgc2NvcGVzIChhZnRlciB0aGlzIGNsZWFudXAsIHRoZSBjdXJyZW50IHNjb3BlIHNob3VsZAogICAgICAgIC8vIG5vdCBiZSByZXRhaW5lZCBieSBhbnkgb2Ygb3VyIHJlZmVyZW5jZXMgYW5kIHNob3VsZCBiZSBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uKQogICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRIZWFkID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZFRhaWwgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRUYWlsID0gdGhpcy4kJHByZXZTaWJsaW5nOwogICAgICAgIGlmICh0aGlzLiQkcHJldlNpYmxpbmcpIHRoaXMuJCRwcmV2U2libGluZy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgIGlmICh0aGlzLiQkbmV4dFNpYmxpbmcpIHRoaXMuJCRuZXh0U2libGluZy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nOwoKCiAgICAgICAgLy8gQWxsIG9mIHRoZSBjb2RlIGJlbG93IGlzIGJvZ3VzIGNvZGUgdGhhdCB3b3JrcyBhcm91bmQgVjgncyBtZW1vcnkgbGVhayB2aWEgb3B0aW1pemVkIGNvZGUKICAgICAgICAvLyBhbmQgaW5saW5lIGNhY2hlcy4KICAgICAgICAvLwogICAgICAgIC8vIHNlZToKICAgICAgICAvLyAtIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvdjgvaXNzdWVzL2RldGFpbD9pZD0yMDczI2MyNgogICAgICAgIC8vIC0gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvNjc5NCNpc3N1ZWNvbW1lbnQtMzg2NDg5MDkKICAgICAgICAvLyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzEzMTMjaXNzdWVjb21tZW50LTEwMzc4NDUxCgogICAgICAgIHRoaXMuJHBhcmVudCA9IHRoaXMuJCRuZXh0U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZEhlYWQgPQogICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsID0gdGhpcy4kcm9vdCA9IG51bGw7CgogICAgICAgIC8vIGRvbid0IHJlc2V0IHRoZXNlIHRvIG51bGwgaW4gY2FzZSBzb21lIGFzeW5jIHRhc2sgdHJpZXMgdG8gcmVnaXN0ZXIgYSBsaXN0ZW5lci93YXRjaC90YXNrCiAgICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgIHRoaXMuJCR3YXRjaGVycyA9IHRoaXMuJCRhc3luY1F1ZXVlID0gdGhpcy4kJHBvc3REaWdlc3RRdWV1ZSA9IFtdOwoKICAgICAgICAvLyBwcmV2ZW50IE5QRXMgc2luY2UgdGhlc2UgbWV0aG9kcyBoYXZlIHJlZmVyZW5jZXMgdG8gcHJvcGVydGllcyB3ZSBudWxsZWQgb3V0CiAgICAgICAgdGhpcy4kZGVzdHJveSA9IHRoaXMuJGRpZ2VzdCA9IHRoaXMuJGFwcGx5ID0gbm9vcDsKICAgICAgICB0aGlzLiRvbiA9IHRoaXMuJHdhdGNoID0gZnVuY3Rpb24oKSB7IHJldHVybiBub29wOyB9OwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZXZhbAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRXhlY3V0ZXMgdGhlIGBleHByZXNzaW9uYCBvbiB0aGUgY3VycmVudCBzY29wZSBhbmQgcmV0dXJucyB0aGUgcmVzdWx0LiBBbnkgZXhjZXB0aW9ucyBpbgogICAgICAgKiB0aGUgZXhwcmVzc2lvbiBhcmUgcHJvcGFnYXRlZCAodW5jYXVnaHQpLiBUaGlzIGlzIHVzZWZ1bCB3aGVuIGV2YWx1YXRpbmcgQW5ndWxhcgogICAgICAgKiBleHByZXNzaW9ucy4KICAgICAgICoKICAgICAgICogIyBFeGFtcGxlCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAgdmFyIHNjb3BlID0gbmcuJHJvb3RTY29wZS5TY29wZSgpOwogICAgICAgICAgIHNjb3BlLmEgPSAxOwogICAgICAgICAgIHNjb3BlLmIgPSAyOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoJ2ErYicpKS50b0VxdWFsKDMpOwogICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbChmdW5jdGlvbihzY29wZSl7IHJldHVybiBzY29wZS5hICsgc2NvcGUuYjsgfSkpLnRvRXF1YWwoMyk7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICoKICAgICAgICogICAgLSBgc3RyaW5nYDogZXhlY3V0ZSB1c2luZyB0aGUgcnVsZXMgYXMgZGVmaW5lZCBpbiAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KG9iamVjdCk9fSBsb2NhbHMgTG9jYWwgdmFyaWFibGVzIG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbiBzY29wZS4KICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICovCiAgICAgICRldmFsOiBmdW5jdGlvbihleHByLCBsb2NhbHMpIHsKICAgICAgICByZXR1cm4gJHBhcnNlKGV4cHIpKHRoaXMsIGxvY2Fscyk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEV4ZWN1dGVzIHRoZSBleHByZXNzaW9uIG9uIHRoZSBjdXJyZW50IHNjb3BlIGF0IGEgbGF0ZXIgcG9pbnQgaW4gdGltZS4KICAgICAgICoKICAgICAgICogVGhlIGAkZXZhbEFzeW5jYCBtYWtlcyBubyBndWFyYW50ZWVzIGFzIHRvIHdoZW4gdGhlIGBleHByZXNzaW9uYCB3aWxsIGJlIGV4ZWN1dGVkLCBvbmx5CiAgICAgICAqIHRoYXQ6CiAgICAgICAqCiAgICAgICAqICAgLSBpdCB3aWxsIGV4ZWN1dGUgYWZ0ZXIgdGhlIGZ1bmN0aW9uIHRoYXQgc2NoZWR1bGVkIHRoZSBldmFsdWF0aW9uIChwcmVmZXJhYmx5IGJlZm9yZSBET00KICAgICAgICogICAgIHJlbmRlcmluZykuCiAgICAgICAqICAgLSBhdCBsZWFzdCBvbmUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0IGN5Y2xlfSB3aWxsIGJlIHBlcmZvcm1lZCBhZnRlcgogICAgICAgKiAgICAgYGV4cHJlc3Npb25gIGV4ZWN1dGlvbi4KICAgICAgICoKICAgICAgICogQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAqIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICoKICAgICAgICogX19Ob3RlOl9fIGlmIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIG91dHNpZGUgb2YgYSBgJGRpZ2VzdGAgY3ljbGUsIGEgbmV3IGAkZGlnZXN0YCBjeWNsZQogICAgICAgKiB3aWxsIGJlIHNjaGVkdWxlZC4gSG93ZXZlciwgaXQgaXMgZW5jb3VyYWdlZCB0byBhbHdheXMgY2FsbCBjb2RlIHRoYXQgY2hhbmdlcyB0aGUgbW9kZWwKICAgICAgICogZnJvbSB3aXRoaW4gYW4gYCRhcHBseWAgY2FsbC4gVGhhdCBpbmNsdWRlcyBjb2RlIGV2YWx1YXRlZCB2aWEgYCRldmFsQXN5bmNgLgogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICoKICAgICAgICogICAgLSBgc3RyaW5nYDogZXhlY3V0ZSB1c2luZyB0aGUgcnVsZXMgYXMgZGVmaW5lZCBpbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCB0aGUgY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICoKICAgICAgICovCiAgICAgICRldmFsQXN5bmM6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgICAvLyBpZiB3ZSBhcmUgb3V0c2lkZSBvZiBhbiAkZGlnZXN0IGxvb3AgYW5kIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUgd2UgYXJlIHNjaGVkdWxpbmcgYXN5bmMKICAgICAgICAvLyB0YXNrIGFsc28gc2NoZWR1bGUgYXN5bmMgYXV0by1mbHVzaAogICAgICAgIGlmICghJHJvb3RTY29wZS4kJHBoYXNlICYmICEkcm9vdFNjb3BlLiQkYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kJGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdGhpcy4kJGFzeW5jUXVldWUucHVzaCh7c2NvcGU6IHRoaXMsIGV4cHJlc3Npb246IGV4cHJ9KTsKICAgICAgfSwKCiAgICAgICQkcG9zdERpZ2VzdCA6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgdGhpcy4kJHBvc3REaWdlc3RRdWV1ZS5wdXNoKGZuKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGFwcGx5CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBgJGFwcGx5KClgIGlzIHVzZWQgdG8gZXhlY3V0ZSBhbiBleHByZXNzaW9uIGluIGFuZ3VsYXIgZnJvbSBvdXRzaWRlIG9mIHRoZSBhbmd1bGFyCiAgICAgICAqIGZyYW1ld29yay4gKEZvciBleGFtcGxlIGZyb20gYnJvd3NlciBET00gZXZlbnRzLCBzZXRUaW1lb3V0LCBYSFIgb3IgdGhpcmQgcGFydHkgbGlicmFyaWVzKS4KICAgICAgICogQmVjYXVzZSB3ZSBhcmUgY2FsbGluZyBpbnRvIHRoZSBhbmd1bGFyIGZyYW1ld29yayB3ZSBuZWVkIHRvIHBlcmZvcm0gcHJvcGVyIHNjb3BlIGxpZmUKICAgICAgICogY3ljbGUgb2Yge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyIGV4Y2VwdGlvbiBoYW5kbGluZ30sCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgZXhlY3V0aW5nIHdhdGNoZXN9LgogICAgICAgKgogICAgICAgKiAjIyBMaWZlIGN5Y2xlCiAgICAgICAqCiAgICAgICAqICMgUHNldWRvLUNvZGUgb2YgYCRhcHBseSgpYAogICAgICAgKiBgYGBqcwogICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICByZXR1cm4gJGV2YWwoZXhwcik7CiAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIFNjb3BlJ3MgYCRhcHBseSgpYCBtZXRob2QgdHJhbnNpdGlvbnMgdGhyb3VnaCB0aGUgZm9sbG93aW5nIHN0YWdlczoKICAgICAgICoKICAgICAgICogMS4gVGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGV4ZWN1dGVkIHVzaW5nIHRoZQogICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbCAkZXZhbCgpfSBtZXRob2QuCiAgICAgICAqIDIuIEFueSBleGNlcHRpb25zIGZyb20gdGhlIGV4ZWN1dGlvbiBvZiB0aGUgZXhwcmVzc2lvbiBhcmUgZm9yd2FyZGVkIHRvIHRoZQogICAgICAgKiAgICB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAqIDMuIFRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2h9IGxpc3RlbmVycyBhcmUgZmlyZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgdGhlCiAgICAgICAqICAgIGV4cHJlc3Npb24gd2FzIGV4ZWN1dGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gbWV0aG9kLgogICAgICAgKgogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHAgQW4gYW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICAgKgogICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICAgICAqLwogICAgICAkYXBwbHk6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgYmVnaW5QaGFzZSgnJGFwcGx5Jyk7CiAgICAgICAgICByZXR1cm4gdGhpcy4kZXZhbChleHByKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJG9uCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBMaXN0ZW5zIG9uIGV2ZW50cyBvZiBhIGdpdmVuIHR5cGUuIFNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdCAkZW1pdH0gZm9yCiAgICAgICAqIGRpc2N1c3Npb24gb2YgZXZlbnQgbGlmZSBjeWNsZS4KICAgICAgICoKICAgICAgICogVGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uIGZvcm1hdCBpczogYGZ1bmN0aW9uKGV2ZW50LCBhcmdzLi4uKWAuIFRoZSBgZXZlbnRgIG9iamVjdAogICAgICAgKiBwYXNzZWQgaW50byB0aGUgbGlzdGVuZXIgaGFzIHRoZSBmb2xsb3dpbmcgYXR0cmlidXRlczoKICAgICAgICoKICAgICAgICogICAtIGB0YXJnZXRTY29wZWAgLSBge1Njb3BlfWA6IHRoZSBzY29wZSBvbiB3aGljaCB0aGUgZXZlbnQgd2FzIGAkZW1pdGAtZWQgb3IKICAgICAgICogICAgIGAkYnJvYWRjYXN0YC1lZC4KICAgICAgICogICAtIGBjdXJyZW50U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgY3VycmVudCBzY29wZSB3aGljaCBpcyBoYW5kbGluZyB0aGUgZXZlbnQuCiAgICAgICAqICAgLSBgbmFtZWAgLSBge3N0cmluZ31gOiBuYW1lIG9mIHRoZSBldmVudC4KICAgICAgICogICAtIGBzdG9wUHJvcGFnYXRpb25gIC0gYHtmdW5jdGlvbj19YDogY2FsbGluZyBgc3RvcFByb3BhZ2F0aW9uYCBmdW5jdGlvbiB3aWxsIGNhbmNlbAogICAgICAgKiAgICAgZnVydGhlciBldmVudCBwcm9wYWdhdGlvbiAoYXZhaWxhYmxlIG9ubHkgZm9yIGV2ZW50cyB0aGF0IHdlcmUgYCRlbWl0YC1lZCkuCiAgICAgICAqICAgLSBgcHJldmVudERlZmF1bHRgIC0gYHtmdW5jdGlvbn1gOiBjYWxsaW5nIGBwcmV2ZW50RGVmYXVsdGAgc2V0cyBgZGVmYXVsdFByZXZlbnRlZGAgZmxhZwogICAgICAgKiAgICAgdG8gdHJ1ZS4KICAgICAgICogICAtIGBkZWZhdWx0UHJldmVudGVkYCAtIGB7Ym9vbGVhbn1gOiB0cnVlIGlmIGBwcmV2ZW50RGVmYXVsdGAgd2FzIGNhbGxlZC4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBsaXN0ZW4gb24uCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQsIC4uLmFyZ3MpfSBsaXN0ZW5lciBGdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGV2ZW50IGlzIGVtaXR0ZWQuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAqLwogICAgICAkb246IGZ1bmN0aW9uKG5hbWUsIGxpc3RlbmVyKSB7CiAgICAgICAgdmFyIG5hbWVkTGlzdGVuZXJzID0gdGhpcy4kJGxpc3RlbmVyc1tuYW1lXTsKICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzKSB7CiAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzW25hbWVdID0gbmFtZWRMaXN0ZW5lcnMgPSBbXTsKICAgICAgICB9CiAgICAgICAgbmFtZWRMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICAgIHZhciBjdXJyZW50ID0gdGhpczsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAoIWN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdKSB7CiAgICAgICAgICAgIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdKys7CiAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQpKTsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW2luZGV4T2YobmFtZWRMaXN0ZW5lcnMsIGxpc3RlbmVyKV0gPSBudWxsOwogICAgICAgICAgZGVjcmVtZW50TGlzdGVuZXJDb3VudChzZWxmLCAxLCBuYW1lKTsKICAgICAgICB9OwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGVtaXQKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIERpc3BhdGNoZXMgYW4gZXZlbnQgYG5hbWVgIHVwd2FyZHMgdGhyb3VnaCB0aGUgc2NvcGUgaGllcmFyY2h5IG5vdGlmeWluZyB0aGUKICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICoKICAgICAgICogVGhlIGV2ZW50IGxpZmUgY3ljbGUgc3RhcnRzIGF0IHRoZSBzY29wZSBvbiB3aGljaCBgJGVtaXRgIHdhcyBjYWxsZWQuIEFsbAogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldAogICAgICAgKiBub3RpZmllZC4gQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHRyYXZlcnNlcyB1cHdhcmRzIHRvd2FyZCB0aGUgcm9vdCBzY29wZSBhbmQgY2FsbHMgYWxsCiAgICAgICAqIHJlZ2lzdGVyZWQgbGlzdGVuZXJzIGFsb25nIHRoZSB3YXkuIFRoZSBldmVudCB3aWxsIHN0b3AgcHJvcGFnYXRpbmcgaWYgb25lIG9mIHRoZSBsaXN0ZW5lcnMKICAgICAgICogY2FuY2VscyBpdC4KICAgICAgICoKICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAqIG9udG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBlbWl0LgogICAgICAgKiBAcGFyYW0gey4uLip9IGFyZ3MgT3B0aW9uYWwgb25lIG9yIG1vcmUgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICogQHJldHVybiB7T2JqZWN0fSBFdmVudCBvYmplY3QgKHNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259KS4KICAgICAgICovCiAgICAgICRlbWl0OiBmdW5jdGlvbihuYW1lLCBhcmdzKSB7CiAgICAgICAgdmFyIGVtcHR5ID0gW10sCiAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLAogICAgICAgICAgICBzY29wZSA9IHRoaXMsCiAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgIHRhcmdldFNjb3BlOiBzY29wZSwKICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkge3N0b3BQcm9wYWdhdGlvbiA9IHRydWU7fSwKICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IGZhbHNlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICBpLCBsZW5ndGg7CgogICAgICAgIGRvIHsKICAgICAgICAgIG5hbWVkTGlzdGVuZXJzID0gc2NvcGUuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgZW1wdHk7CiAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBzY29wZTsKICAgICAgICAgIGZvciAoaT0wLCBsZW5ndGg9bmFtZWRMaXN0ZW5lcnMubGVuZ3RoOyBpPGxlbmd0aDsgaSsrKSB7CgogICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgIGlmICghbmFtZWRMaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgLy9hbGxvdyBhbGwgbGlzdGVuZXJzIGF0dGFjaGVkIHRvIHRoZSBjdXJyZW50IHNjb3BlIHRvIHJ1bgogICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy9pZiBhbnkgbGlzdGVuZXIgb24gdGhlIGN1cnJlbnQgc2NvcGUgc3RvcHMgcHJvcGFnYXRpb24sIHByZXZlbnQgYnViYmxpbmcKICAgICAgICAgIGlmIChzdG9wUHJvcGFnYXRpb24pIHJldHVybiBldmVudDsKICAgICAgICAgIC8vdHJhdmVyc2UgdXB3YXJkcwogICAgICAgICAgc2NvcGUgPSBzY29wZS4kcGFyZW50OwogICAgICAgIH0gd2hpbGUgKHNjb3BlKTsKCiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGJyb2FkY2FzdAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgZG93bndhcmRzIHRvIGFsbCBjaGlsZCBzY29wZXMgKGFuZCB0aGVpciBjaGlsZHJlbikgbm90aWZ5aW5nIHRoZQogICAgICAgKiByZWdpc3RlcmVkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gbGlzdGVuZXJzLgogICAgICAgKgogICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkYnJvYWRjYXN0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gbGlzdGVuaW5nIGZvciBgbmFtZWAgZXZlbnQgb24gdGhpcyBzY29wZSBnZXQKICAgICAgICogbm90aWZpZWQuIEFmdGVyd2FyZHMsIHRoZSBldmVudCBwcm9wYWdhdGVzIHRvIGFsbCBkaXJlY3QgYW5kIGluZGlyZWN0IHNjb3BlcyBvZiB0aGUgY3VycmVudAogICAgICAgKiBzY29wZSBhbmQgY2FsbHMgYWxsIHJlZ2lzdGVyZWQgbGlzdGVuZXJzIGFsb25nIHRoZSB3YXkuIFRoZSBldmVudCBjYW5ub3QgYmUgY2FuY2VsZWQuCiAgICAgICAqCiAgICAgICAqIEFueSBleGNlcHRpb24gZW1pdHRlZCBmcm9tIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSB3aWxsIGJlIHBhc3NlZAogICAgICAgKiBvbnRvIHRoZSB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gYnJvYWRjYXN0LgogICAgICAgKiBAcGFyYW0gey4uLip9IGFyZ3MgT3B0aW9uYWwgb25lIG9yIG1vcmUgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICogQHJldHVybiB7T2JqZWN0fSBFdmVudCBvYmplY3QsIHNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259CiAgICAgICAqLwogICAgICAkYnJvYWRjYXN0OiBmdW5jdGlvbihuYW1lLCBhcmdzKSB7CiAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQsCiAgICAgICAgICAgIG5leHQgPSB0YXJnZXQsCiAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHRhcmdldCwKICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IGZhbHNlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICBsaXN0ZW5lcnMsIGksIGxlbmd0aDsKCiAgICAgICAgLy9kb3duIHdoaWxlIHlvdSBjYW4sIHRoZW4gdXAgYW5kIG5leHQgc2libGluZyBvciB1cCBhbmQgbmV4dCBzaWJsaW5nIHVudGlsIGJhY2sgYXQgcm9vdAogICAgICAgIHdoaWxlICgoY3VycmVudCA9IG5leHQpKSB7CiAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBjdXJyZW50OwogICAgICAgICAgbGlzdGVuZXJzID0gY3VycmVudC4kJGxpc3RlbmVyc1tuYW1lXSB8fCBbXTsKICAgICAgICAgIGZvciAoaT0wLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpPGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIC8vIGlmIGxpc3RlbmVycyB3ZXJlIGRlcmVnaXN0ZXJlZCwgZGVmcmFnbWVudCB0aGUgYXJyYXkKICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgIC8vIHllcywgdGhpcyBjb2RlIGlzIGEgYml0IGNyYXp5LCBidXQgaXQgd29ya3MgYW5kIHdlIGhhdmUgdGVzdHMgdG8gcHJvdmUgaXQhCiAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRkaWdlc3QKICAgICAgICAgIC8vICh0aG91Z2ggaXQgZGlmZmVycyBkdWUgdG8gaGF2aW5nIHRoZSBleHRyYSBjaGVjayBmb3IgJCRsaXN0ZW5lckNvdW50KQogICAgICAgICAgaWYgKCEobmV4dCA9ICgoY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gJiYgY3VycmVudC4kJGNoaWxkSGVhZCkgfHwKICAgICAgICAgICAgICAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICB3aGlsZShjdXJyZW50ICE9PSB0YXJnZXQgJiYgIShuZXh0ID0gY3VycmVudC4kJG5leHRTaWJsaW5nKSkgewogICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBldmVudDsKICAgICAgfQogICAgfTsKCiAgICB2YXIgJHJvb3RTY29wZSA9IG5ldyBTY29wZSgpOwoKICAgIHJldHVybiAkcm9vdFNjb3BlOwoKCiAgICBmdW5jdGlvbiBiZWdpblBoYXNlKHBoYXNlKSB7CiAgICAgIGlmICgkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICB0aHJvdyAkcm9vdFNjb3BlTWluRXJyKCdpbnByb2cnLCAnezB9IGFscmVhZHkgaW4gcHJvZ3Jlc3MnLCAkcm9vdFNjb3BlLiQkcGhhc2UpOwogICAgICB9CgogICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBwaGFzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBjbGVhclBoYXNlKCkgewogICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbXBpbGVUb0ZuKGV4cCwgbmFtZSkgewogICAgICB2YXIgZm4gPSAkcGFyc2UoZXhwKTsKICAgICAgYXNzZXJ0QXJnRm4oZm4sIG5hbWUpOwogICAgICByZXR1cm4gZm47CiAgICB9CgogICAgZnVuY3Rpb24gZGVjcmVtZW50TGlzdGVuZXJDb3VudChjdXJyZW50LCBjb3VudCwgbmFtZSkgewogICAgICBkbyB7CiAgICAgICAgY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gLT0gY291bnQ7CgogICAgICAgIGlmIChjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSA9PT0gMCkgewogICAgICAgICAgZGVsZXRlIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdOwogICAgICAgIH0KICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQpKTsKICAgIH0KCiAgICAvKioKICAgICAqIGZ1bmN0aW9uIHVzZWQgYXMgYW4gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMuCiAgICAgKiBiZWNhdXNlIGl0J3MgdW5pcXVlIHdlIGNhbiBlYXNpbHkgdGVsbCBpdCBhcGFydCBmcm9tIG90aGVyIHZhbHVlcwogICAgICovCiAgICBmdW5jdGlvbiBpbml0V2F0Y2hWYWwoKSB7fQogIH1dOwp9CgovKioKICogQGRlc2NyaXB0aW9uCiAqIFByaXZhdGUgc2VydmljZSB0byBzYW5pdGl6ZSB1cmlzIGZvciBsaW5rcyBhbmQgaW1hZ2VzLiBVc2VkIGJ5ICRjb21waWxlIGFuZCAkc2FuaXRpemUuCiAqLwpmdW5jdGlvbiAkJFNhbml0aXplVXJpUHJvdmlkZXIoKSB7CiAgdmFyIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gL15ccyooaHR0cHM/fGZ0cHxtYWlsdG98dGVsfGZpbGUpOi8sCiAgICBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSAvXlxzKihodHRwcz98ZnRwfGZpbGUpOnxkYXRhOmltYWdlXC8vOwoKICAvKioKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICogdXJscyBkdXJpbmcgYVtocmVmXSBzYW5pdGl6YXRpb24uCiAgICoKICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAqCiAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBhW2hyZWZdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8KICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3RgCiAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAqCiAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICovCiAgdGhpcy5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gcmVnZXhwOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdDsKICB9OwoKCiAgLyoqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV0cmlldmVzIG9yIG92ZXJyaWRlcyB0aGUgZGVmYXVsdCByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIGZvciB3aGl0ZWxpc3Rpbmcgb2Ygc2FmZQogICAqIHVybHMgZHVyaW5nIGltZ1tzcmNdIHNhbml0aXphdGlvbi4KICAgKgogICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICoKICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGltZ1tzcmNdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8KICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0YAogICAqIHJlZ3VsYXIgZXhwcmVzc2lvbi4gSWYgYSBtYXRjaCBpcyBmb3VuZCwgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlLAogICAqIHRoZSBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpcyBpdCB3cml0dGVuIGludG8gdGhlIERPTS4KICAgKgogICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAqLwogIHRoaXMuaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24ocmVnZXhwKSB7CiAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gcmVnZXhwOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgfTsKCiAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gc2FuaXRpemVVcmkodXJpLCBpc0ltYWdlKSB7CiAgICAgIHZhciByZWdleCA9IGlzSW1hZ2UgPyBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgOiBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdDsKICAgICAgdmFyIG5vcm1hbGl6ZWRWYWw7CiAgICAgIC8vIE5PVEU6IHVybFJlc29sdmUoKSBkb2Vzbid0IHN1cHBvcnQgSUUgPCA4IHNvIHdlIGRvbid0IHNhbml0aXplIGZvciB0aGF0IGNhc2UuCiAgICAgIGlmICghbXNpZSB8fCBtc2llID49IDggKSB7CiAgICAgICAgbm9ybWFsaXplZFZhbCA9IHVybFJlc29sdmUodXJpKS5ocmVmOwogICAgICAgIGlmIChub3JtYWxpemVkVmFsICE9PSAnJyAmJiAhbm9ybWFsaXplZFZhbC5tYXRjaChyZWdleCkpIHsKICAgICAgICAgIHJldHVybiAndW5zYWZlOicrbm9ybWFsaXplZFZhbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHVyaTsKICAgIH07CiAgfTsKfQoKdmFyICRzY2VNaW5FcnIgPSBtaW5FcnIoJyRzY2UnKTsKCnZhciBTQ0VfQ09OVEVYVFMgPSB7CiAgSFRNTDogJ2h0bWwnLAogIENTUzogJ2NzcycsCiAgVVJMOiAndXJsJywKICAvLyBSRVNPVVJDRV9VUkwgaXMgYSBzdWJ0eXBlIG9mIFVSTCB1c2VkIGluIGNvbnRleHRzIHdoZXJlIGEgcHJpdmlsZWdlZCByZXNvdXJjZSBpcyBzb3VyY2VkIGZyb20gYQogIC8vIHVybC4gIChlLmcuIG5nLWluY2x1ZGUsIHNjcmlwdCBzcmMsIHRlbXBsYXRlVXJsKQogIFJFU09VUkNFX1VSTDogJ3Jlc291cmNlVXJsJywKICBKUzogJ2pzJwp9OwoKLy8gSGVscGVyIGZ1bmN0aW9ucyBmb2xsb3cuCgovLyBDb3BpZWQgZnJvbToKLy8gaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfc3RyaW5nX3N0cmluZy5qcy5zb3VyY2UuaHRtbCNsaW5lOTYyCi8vIFByZXJlcTogcyBpcyBhIHN0cmluZy4KZnVuY3Rpb24gZXNjYXBlRm9yUmVnZXhwKHMpIHsKICByZXR1cm4gcy5yZXBsYWNlKC8oWy0oKVxbXF17fSs/Ki4kXF58LDojPCFcXF0pL2csICdcXCQxJykuCiAgICAgICAgICAgcmVwbGFjZSgvXHgwOC9nLCAnXFx4MDgnKTsKfQoKCmZ1bmN0aW9uIGFkanVzdE1hdGNoZXIobWF0Y2hlcikgewogIGlmIChtYXRjaGVyID09PSAnc2VsZicpIHsKICAgIHJldHVybiBtYXRjaGVyOwogIH0gZWxzZSBpZiAoaXNTdHJpbmcobWF0Y2hlcikpIHsKICAgIC8vIFN0cmluZ3MgbWF0Y2ggZXhhY3RseSBleGNlcHQgZm9yIDIgd2lsZGNhcmRzIC0gJyonIGFuZCAnKionLgogICAgLy8gJyonIG1hdGNoZXMgYW55IGNoYXJhY3RlciBleGNlcHQgdGhvc2UgZnJvbSB0aGUgc2V0ICc6Ly4/JicuCiAgICAvLyAnKionIG1hdGNoZXMgYW55IGNoYXJhY3RlciAobGlrZSAuKiBpbiBhIFJlZ0V4cCkuCiAgICAvLyBNb3JlIHRoYW4gMiAqJ3MgcmFpc2VzIGFuIGVycm9yIGFzIGl0J3MgaWxsIGRlZmluZWQuCiAgICBpZiAobWF0Y2hlci5pbmRleE9mKCcqKionKSA+IC0xKSB7CiAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2l3Y2FyZCcsCiAgICAgICAgICAnSWxsZWdhbCBzZXF1ZW5jZSAqKiogaW4gc3RyaW5nIG1hdGNoZXIuICBTdHJpbmc6IHswfScsIG1hdGNoZXIpOwogICAgfQogICAgbWF0Y2hlciA9IGVzY2FwZUZvclJlZ2V4cChtYXRjaGVyKS4KICAgICAgICAgICAgICAgICAgcmVwbGFjZSgnXFwqXFwqJywgJy4qJykuCiAgICAgICAgICAgICAgICAgIHJlcGxhY2UoJ1xcKicsICdbXjovLj8mO10qJyk7CiAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyBtYXRjaGVyICsgJyQnKTsKICB9IGVsc2UgaWYgKGlzUmVnRXhwKG1hdGNoZXIpKSB7CiAgICAvLyBUaGUgb25seSBvdGhlciB0eXBlIG9mIG1hdGNoZXIgYWxsb3dlZCBpcyBhIFJlZ2V4cC4KICAgIC8vIE1hdGNoIGVudGlyZSBVUkwgLyBkaXNhbGxvdyBwYXJ0aWFsIG1hdGNoZXMuCiAgICAvLyBGbGFncyBhcmUgcmVzZXQgKGkuZS4gbm8gZ2xvYmFsLCBpZ25vcmVDYXNlIG9yIG11bHRpbGluZSkKICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIG1hdGNoZXIuc291cmNlICsgJyQnKTsKICB9IGVsc2UgewogICAgdGhyb3cgJHNjZU1pbkVycignaW1hdGNoZXInLAogICAgICAgICdNYXRjaGVycyBtYXkgb25seSBiZSAic2VsZiIsIHN0cmluZyBwYXR0ZXJucyBvciBSZWdFeHAgb2JqZWN0cycpOwogIH0KfQoKCmZ1bmN0aW9uIGFkanVzdE1hdGNoZXJzKG1hdGNoZXJzKSB7CiAgdmFyIGFkanVzdGVkTWF0Y2hlcnMgPSBbXTsKICBpZiAoaXNEZWZpbmVkKG1hdGNoZXJzKSkgewogICAgZm9yRWFjaChtYXRjaGVycywgZnVuY3Rpb24obWF0Y2hlcikgewogICAgICBhZGp1c3RlZE1hdGNoZXJzLnB1c2goYWRqdXN0TWF0Y2hlcihtYXRjaGVyKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGFkanVzdGVkTWF0Y2hlcnM7Cn0KCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHNjZURlbGVnYXRlCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBgJHNjZURlbGVnYXRlYCBpcyBhIHNlcnZpY2UgdGhhdCBpcyB1c2VkIGJ5IHRoZSBgJHNjZWAgc2VydmljZSB0byBwcm92aWRlIHtAbGluayBuZy4kc2NlIFN0cmljdAogKiBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfSBzZXJ2aWNlcyB0byBBbmd1bGFySlMuCiAqCiAqIFR5cGljYWxseSwgeW91IHdvdWxkIGNvbmZpZ3VyZSBvciBvdmVycmlkZSB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSAkc2NlRGVsZWdhdGV9IGluc3RlYWQgb2YKICogdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIGN1c3RvbWl6ZSB0aGUgd2F5IFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIHdvcmtzIGluIEFuZ3VsYXJKUy4gIFRoaXMgaXMKICogYmVjYXVzZSwgd2hpbGUgdGhlIGAkc2NlYCBwcm92aWRlcyBudW1lcm91cyBzaG9ydGhhbmQgbWV0aG9kcywgZXRjLiwgeW91IHJlYWxseSBvbmx5IG5lZWQgdG8KICogb3ZlcnJpZGUgMyBjb3JlIGZ1bmN0aW9ucyAoYHRydXN0QXNgLCBgZ2V0VHJ1c3RlZGAgYW5kIGB2YWx1ZU9mYCkgdG8gcmVwbGFjZSB0aGUgd2F5IHRoaW5ncwogKiB3b3JrIGJlY2F1c2UgYCRzY2VgIGRlbGVnYXRlcyB0byBgJHNjZURlbGVnYXRlYCBmb3IgdGhlc2Ugb3BlcmF0aW9ucy4KICoKICogUmVmZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSB0byBjb25maWd1cmUgdGhpcyBzZXJ2aWNlLgogKgogKiBUaGUgZGVmYXVsdCBpbnN0YW5jZSBvZiBgJHNjZURlbGVnYXRlYCBzaG91bGQgd29yayBvdXQgb2YgdGhlIGJveCB3aXRoIGxpdHRsZSBwYWluLiAgV2hpbGUgeW91CiAqIGNhbiBvdmVycmlkZSBpdCBjb21wbGV0ZWx5IHRvIGNoYW5nZSB0aGUgYmVoYXZpb3Igb2YgYCRzY2VgLCB0aGUgY29tbW9uIGNhc2Ugd291bGQKICogaW52b2x2ZSBjb25maWd1cmluZyB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSBpbnN0ZWFkIGJ5IHNldHRpbmcKICogeW91ciBvd24gd2hpdGVsaXN0cyBhbmQgYmxhY2tsaXN0cyBmb3IgdHJ1c3RpbmcgVVJMcyB1c2VkIGZvciBsb2FkaW5nIEFuZ3VsYXJKUyByZXNvdXJjZXMgc3VjaCBhcwogKiB0ZW1wbGF0ZXMuICBSZWZlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QKICogJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZCB7QGxpbmsKICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxCbGFja2xpc3R9CiAqLwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkc2NlRGVsZWdhdGVQcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICoKICogVGhlIGAkc2NlRGVsZWdhdGVQcm92aWRlcmAgcHJvdmlkZXIgYWxsb3dzIGRldmVsb3BlcnMgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlCiAqICRzY2VEZWxlZ2F0ZX0gc2VydmljZS4gIFRoaXMgYWxsb3dzIG9uZSB0byBnZXQvc2V0IHRoZSB3aGl0ZWxpc3RzIGFuZCBibGFja2xpc3RzIHVzZWQgdG8gZW5zdXJlCiAqIHRoYXQgdGhlIFVSTHMgdXNlZCBmb3Igc291cmNpbmcgQW5ndWxhciB0ZW1wbGF0ZXMgYXJlIHNhZmUuICBSZWZlciB7QGxpbmsKICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZAogKiB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxCbGFja2xpc3R9CiAqCiAqIEZvciB0aGUgZ2VuZXJhbCBkZXRhaWxzIGFib3V0IHRoaXMgc2VydmljZSBpbiBBbmd1bGFyLCByZWFkIHRoZSBtYWluIHBhZ2UgZm9yIHtAbGluayBuZy4kc2NlCiAqIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfS4KICoKICogKipFeGFtcGxlKio6ICBDb25zaWRlciB0aGUgZm9sbG93aW5nIGNhc2UuIDxhIG5hbWU9ImV4YW1wbGUiPjwvYT4KICoKICogLSB5b3VyIGFwcCBpcyBob3N0ZWQgYXQgdXJsIGBodHRwOi8vbXlhcHAuZXhhbXBsZS5jb20vYAogKiAtIGJ1dCBzb21lIG9mIHlvdXIgdGVtcGxhdGVzIGFyZSBob3N0ZWQgb24gb3RoZXIgZG9tYWlucyB5b3UgY29udHJvbCBzdWNoIGFzCiAqICAgYGh0dHA6Ly9zcnYwMS5hc3NldHMuZXhhbXBsZS5jb20vYCzCoCBgaHR0cDovL3NydjAyLmFzc2V0cy5leGFtcGxlLmNvbS9gLCBldGMuCiAqIC0gYW5kIHlvdSBoYXZlIGFuIG9wZW4gcmVkaXJlY3QgYXQgYGh0dHA6Ly9teWFwcC5leGFtcGxlLmNvbS9jbGlja1RocnU/Li4uYC4KICoKICogSGVyZSBpcyB3aGF0IGEgc2VjdXJlIGNvbmZpZ3VyYXRpb24gZm9yIHRoaXMgc2NlbmFyaW8gbWlnaHQgbG9vayBsaWtlOgogKgogKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAqICAgIGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFtdKS5jb25maWcoZnVuY3Rpb24oJHNjZURlbGVnYXRlUHJvdmlkZXIpIHsKICogICAgICAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybFdoaXRlbGlzdChbCiAqICAgICAgICAvLyBBbGxvdyBzYW1lIG9yaWdpbiByZXNvdXJjZSBsb2Fkcy4KICogICAgICAgICdzZWxmJywKICogICAgICAgIC8vIEFsbG93IGxvYWRpbmcgZnJvbSBvdXIgYXNzZXRzIGRvbWFpbi4gIE5vdGljZSB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuICogYW5kICoqLgogKiAgICAgICAgJ2h0dHA6Ly9zcnYqLmFzc2V0cy5leGFtcGxlLmNvbS8qKiddKTsKICoKICogICAgICAvLyBUaGUgYmxhY2tsaXN0IG92ZXJyaWRlcyB0aGUgd2hpdGVsaXN0IHNvIHRoZSBvcGVuIHJlZGlyZWN0IGhlcmUgaXMgYmxvY2tlZC4KICogICAgICAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybEJsYWNrbGlzdChbCiAqICAgICAgICAnaHR0cDovL215YXBwLmV4YW1wbGUuY29tL2NsaWNrVGhydSoqJ10pOwogKiAgICAgIH0pOwogKiA8L3ByZT4KICovCgpmdW5jdGlvbiAkU2NlRGVsZWdhdGVQcm92aWRlcigpIHsKICB0aGlzLlNDRV9DT05URVhUUyA9IFNDRV9DT05URVhUUzsKCiAgLy8gUmVzb3VyY2UgVVJMcyBjYW4gYWxzbyBiZSB0cnVzdGVkIGJ5IHBvbGljeS4KICB2YXIgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBbJ3NlbGYnXSwKICAgICAgcmVzb3VyY2VVcmxCbGFja2xpc3QgPSBbXTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBwYXJhbSB7QXJyYXk9fSB3aGl0ZWxpc3QgV2hlbiBwcm92aWRlZCwgcmVwbGFjZXMgdGhlIHJlc291cmNlVXJsV2hpdGVsaXN0IHdpdGggdGhlIHZhbHVlCiAgICogICAgIHByb3ZpZGVkLiAgVGhpcyBtdXN0IGJlIGFuIGFycmF5IG9yIG51bGwuICBBIHNuYXBzaG90IG9mIHRoaXMgYXJyYXkgaXMgdXNlZCBzbyBmdXJ0aGVyCiAgICogICAgIGNoYW5nZXMgdG8gdGhlIGFycmF5IGFyZSBpZ25vcmVkLgogICAqCiAgICogICAgIEZvbGxvdyB7QGxpbmsgbmcuJHNjZSNyZXNvdXJjZVVybFBhdHRlcm5JdGVtIHRoaXMgbGlua30gZm9yIGEgZGVzY3JpcHRpb24gb2YgdGhlIGl0ZW1zCiAgICogICAgIGFsbG93ZWQgaW4gdGhpcyBhcnJheS4KICAgKgogICAqICAgICBOb3RlOiAqKmFuIGVtcHR5IHdoaXRlbGlzdCBhcnJheSB3aWxsIGJsb2NrIGFsbCBVUkxzKiohCiAgICoKICAgKiBAcmV0dXJuIHtBcnJheX0gdGhlIGN1cnJlbnRseSBzZXQgd2hpdGVsaXN0IGFycmF5LgogICAqCiAgICogVGhlICoqZGVmYXVsdCB2YWx1ZSoqIHdoZW4gbm8gd2hpdGVsaXN0IGhhcyBiZWVuIGV4cGxpY2l0bHkgc2V0IGlzIGBbJ3NlbGYnXWAgYWxsb3dpbmcgb25seQogICAqIHNhbWUgb3JpZ2luIHJlc291cmNlIHJlcXVlc3RzLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cy9HZXRzIHRoZSB3aGl0ZWxpc3Qgb2YgdHJ1c3RlZCByZXNvdXJjZSBVUkxzLgogICAqLwogIHRoaXMucmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIHJlc291cmNlVXJsV2hpdGVsaXN0ID0gYWRqdXN0TWF0Y2hlcnModmFsdWUpOwogICAgfQogICAgcmV0dXJuIHJlc291cmNlVXJsV2hpdGVsaXN0OwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PX0gYmxhY2tsaXN0IFdoZW4gcHJvdmlkZWQsIHJlcGxhY2VzIHRoZSByZXNvdXJjZVVybEJsYWNrbGlzdCB3aXRoIHRoZSB2YWx1ZQogICAqICAgICBwcm92aWRlZC4gIFRoaXMgbXVzdCBiZSBhbiBhcnJheSBvciBudWxsLiAgQSBzbmFwc2hvdCBvZiB0aGlzIGFycmF5IGlzIHVzZWQgc28gZnVydGhlcgogICAqICAgICBjaGFuZ2VzIHRvIHRoZSBhcnJheSBhcmUgaWdub3JlZC4KICAgKgogICAqICAgICBGb2xsb3cge0BsaW5rIG5nLiRzY2UjcmVzb3VyY2VVcmxQYXR0ZXJuSXRlbSB0aGlzIGxpbmt9IGZvciBhIGRlc2NyaXB0aW9uIG9mIHRoZSBpdGVtcwogICAqICAgICBhbGxvd2VkIGluIHRoaXMgYXJyYXkuCiAgICoKICAgKiAgICAgVGhlIHR5cGljYWwgdXNhZ2UgZm9yIHRoZSBibGFja2xpc3QgaXMgdG8gKipibG9jawogICAqICAgICBbb3BlbiByZWRpcmVjdHNdKGh0dHA6Ly9jd2UubWl0cmUub3JnL2RhdGEvZGVmaW5pdGlvbnMvNjAxLmh0bWwpKiogc2VydmVkIGJ5IHlvdXIgZG9tYWluIGFzCiAgICogICAgIHRoZXNlIHdvdWxkIG90aGVyd2lzZSBiZSB0cnVzdGVkIGJ1dCBhY3R1YWxseSByZXR1cm4gY29udGVudCBmcm9tIHRoZSByZWRpcmVjdGVkIGRvbWFpbi4KICAgKgogICAqICAgICBGaW5hbGx5LCAqKnRoZSBibGFja2xpc3Qgb3ZlcnJpZGVzIHRoZSB3aGl0ZWxpc3QqKiBhbmQgaGFzIHRoZSBmaW5hbCBzYXkuCiAgICoKICAgKiBAcmV0dXJuIHtBcnJheX0gdGhlIGN1cnJlbnRseSBzZXQgYmxhY2tsaXN0IGFycmF5LgogICAqCiAgICogVGhlICoqZGVmYXVsdCB2YWx1ZSoqIHdoZW4gbm8gd2hpdGVsaXN0IGhhcyBiZWVuIGV4cGxpY2l0bHkgc2V0IGlzIHRoZSBlbXB0eSBhcnJheSAoaS5lLiB0aGVyZQogICAqIGlzIG5vIGJsYWNrbGlzdC4pCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzL0dldHMgdGhlIGJsYWNrbGlzdCBvZiB0cnVzdGVkIHJlc291cmNlIFVSTHMuCiAgICovCgogIHRoaXMucmVzb3VyY2VVcmxCbGFja2xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIHJlc291cmNlVXJsQmxhY2tsaXN0ID0gYWRqdXN0TWF0Y2hlcnModmFsdWUpOwogICAgfQogICAgcmV0dXJuIHJlc291cmNlVXJsQmxhY2tsaXN0OwogIH07CgogIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CgogICAgdmFyIGh0bWxTYW5pdGl6ZXIgPSBmdW5jdGlvbiBodG1sU2FuaXRpemVyKGh0bWwpIHsKICAgICAgdGhyb3cgJHNjZU1pbkVycigndW5zYWZlJywgJ0F0dGVtcHRpbmcgdG8gdXNlIGFuIHVuc2FmZSB2YWx1ZSBpbiBhIHNhZmUgY29udGV4dC4nKTsKICAgIH07CgogICAgaWYgKCRpbmplY3Rvci5oYXMoJyRzYW5pdGl6ZScpKSB7CiAgICAgIGh0bWxTYW5pdGl6ZXIgPSAkaW5qZWN0b3IuZ2V0KCckc2FuaXRpemUnKTsKICAgIH0KCgogICAgZnVuY3Rpb24gbWF0Y2hVcmwobWF0Y2hlciwgcGFyc2VkVXJsKSB7CiAgICAgIGlmIChtYXRjaGVyID09PSAnc2VsZicpIHsKICAgICAgICByZXR1cm4gdXJsSXNTYW1lT3JpZ2luKHBhcnNlZFVybCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVmaW5pdGVseSBhIHJlZ2V4LiAgU2VlIGFkanVzdE1hdGNoZXJzKCkKICAgICAgICByZXR1cm4gISFtYXRjaGVyLmV4ZWMocGFyc2VkVXJsLmhyZWYpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaXNSZXNvdXJjZVVybEFsbG93ZWRCeVBvbGljeSh1cmwpIHsKICAgICAgdmFyIHBhcnNlZFVybCA9IHVybFJlc29sdmUodXJsLnRvU3RyaW5nKCkpOwogICAgICB2YXIgaSwgbiwgYWxsb3dlZCA9IGZhbHNlOwogICAgICAvLyBFbnN1cmUgdGhhdCBhdCBsZWFzdCBvbmUgaXRlbSBmcm9tIHRoZSB3aGl0ZWxpc3QgYWxsb3dzIHRoaXMgdXJsLgogICAgICBmb3IgKGkgPSAwLCBuID0gcmVzb3VyY2VVcmxXaGl0ZWxpc3QubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgaWYgKG1hdGNoVXJsKHJlc291cmNlVXJsV2hpdGVsaXN0W2ldLCBwYXJzZWRVcmwpKSB7CiAgICAgICAgICBhbGxvd2VkID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoYWxsb3dlZCkgewogICAgICAgIC8vIEVuc3VyZSB0aGF0IG5vIGl0ZW0gZnJvbSB0aGUgYmxhY2tsaXN0IGJsb2NrZWQgdGhpcyB1cmwuCiAgICAgICAgZm9yIChpID0gMCwgbiA9IHJlc291cmNlVXJsQmxhY2tsaXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgICAgaWYgKG1hdGNoVXJsKHJlc291cmNlVXJsQmxhY2tsaXN0W2ldLCBwYXJzZWRVcmwpKSB7CiAgICAgICAgICAgIGFsbG93ZWQgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhbGxvd2VkOwogICAgfQoKICAgIGZ1bmN0aW9uIGdlbmVyYXRlSG9sZGVyVHlwZShCYXNlKSB7CiAgICAgIHZhciBob2xkZXJUeXBlID0gZnVuY3Rpb24gVHJ1c3RlZFZhbHVlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWUpIHsKICAgICAgICB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdHJ1c3RlZFZhbHVlOwogICAgICAgIH07CiAgICAgIH07CiAgICAgIGlmIChCYXNlKSB7CiAgICAgICAgaG9sZGVyVHlwZS5wcm90b3R5cGUgPSBuZXcgQmFzZSgpOwogICAgICB9CiAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlLnZhbHVlT2YgPSBmdW5jdGlvbiBzY2VWYWx1ZU9mKCkgewogICAgICAgIHJldHVybiB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCk7CiAgICAgIH07CiAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gc2NlVG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuJCR1bndyYXBUcnVzdGVkVmFsdWUoKS50b1N0cmluZygpOwogICAgICB9OwogICAgICByZXR1cm4gaG9sZGVyVHlwZTsKICAgIH0KCiAgICB2YXIgdHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSA9IGdlbmVyYXRlSG9sZGVyVHlwZSgpLAogICAgICAgIGJ5VHlwZSA9IHt9OwoKICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuSFRNTF0gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkNTU10gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICBieVR5cGVbU0NFX0NPTlRFWFRTLlVSTF0gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkpTXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuUkVTT1VSQ0VfVVJMXSA9IGdlbmVyYXRlSG9sZGVyVHlwZShieVR5cGVbU0NFX0NPTlRFWFRTLlVSTF0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybnMgYW4gb2JqZWN0IHRoYXQgaXMgdHJ1c3RlZCBieSBhbmd1bGFyIGZvciB1c2UgaW4gc3BlY2lmaWVkIHN0cmljdAogICAgICogY29udGV4dHVhbCBlc2NhcGluZyBjb250ZXh0cyAoc3VjaCBhcyBuZy1iaW5kLWh0bWwsIG5nLWluY2x1ZGUsIGFueSBzcmMKICAgICAqIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uLCBhbnkgZG9tIGV2ZW50IGJpbmRpbmcgYXR0cmlidXRlIGludGVycG9sYXRpb24KICAgICAqIHN1Y2ggYXMgZm9yIG9uY2xpY2ssICBldGMuKSB0aGF0IHVzZXMgdGhlIHByb3ZpZGVkIHZhbHVlLgogICAgICogU2VlIHtAbGluayBuZy4kc2NlICRzY2V9IGZvciBlbmFibGluZyBzdHJpY3QgY29udGV4dHVhbCBlc2NhcGluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgc2FmZSBmb3IgdXNlLiAgZS5nLiB1cmwsCiAgICAgKiAgIHJlc291cmNlVXJsLCBodG1sLCBqcyBhbmQgY3NzLgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdGhhdCB0aGF0IHNob3VsZCBiZSBjb25zaWRlcmVkIHRydXN0ZWQvc2FmZS4KICAgICAqIEByZXR1cm5zIHsqfSBBIHZhbHVlIHRoYXQgY2FuIGJlIHVzZWQgdG8gc3RhbmQgaW4gZm9yIHRoZSBwcm92aWRlZCBgdmFsdWVgIGluIHBsYWNlcwogICAgICogd2hlcmUgQW5ndWxhciBleHBlY3RzIGEgJHNjZS50cnVzdEFzKCkgcmV0dXJuIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiB0cnVzdEFzKHR5cGUsIHRydXN0ZWRWYWx1ZSkgewogICAgICB2YXIgQ29uc3RydWN0b3IgPSAoYnlUeXBlLmhhc093blByb3BlcnR5KHR5cGUpID8gYnlUeXBlW3R5cGVdIDogbnVsbCk7CiAgICAgIGlmICghQ29uc3RydWN0b3IpIHsKICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpY29udGV4dCcsCiAgICAgICAgICAgICdBdHRlbXB0ZWQgdG8gdHJ1c3QgYSB2YWx1ZSBpbiBpbnZhbGlkIGNvbnRleHQuIENvbnRleHQ6IHswfTsgVmFsdWU6IHsxfScsCiAgICAgICAgICAgIHR5cGUsIHRydXN0ZWRWYWx1ZSk7CiAgICAgIH0KICAgICAgaWYgKHRydXN0ZWRWYWx1ZSA9PT0gbnVsbCB8fCB0cnVzdGVkVmFsdWUgPT09IHVuZGVmaW5lZCB8fCB0cnVzdGVkVmFsdWUgPT09ICcnKSB7CiAgICAgICAgcmV0dXJuIHRydXN0ZWRWYWx1ZTsKICAgICAgfQogICAgICAvLyBBbGwgdGhlIGN1cnJlbnQgY29udGV4dHMgaW4gU0NFX0NPTlRFWFRTIGhhcHBlbiB0byBiZSBzdHJpbmdzLiAgSW4gb3JkZXIgdG8gYXZvaWQgdHJ1c3RpbmcKICAgICAgLy8gbXV0YWJsZSBvYmplY3RzLCB3ZSBlbnN1cmUgaGVyZSB0aGF0IHRoZSB2YWx1ZSBwYXNzZWQgaW4gaXMgYWN0dWFsbHkgYSBzdHJpbmcuCiAgICAgIGlmICh0eXBlb2YgdHJ1c3RlZFZhbHVlICE9PSAnc3RyaW5nJykgewogICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2l0eXBlJywKICAgICAgICAgICAgJ0F0dGVtcHRlZCB0byB0cnVzdCBhIG5vbi1zdHJpbmcgdmFsdWUgaW4gYSBjb250ZW50IHJlcXVpcmluZyBhIHN0cmluZzogQ29udGV4dDogezB9JywKICAgICAgICAgICAgdHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBDb25zdHJ1Y3Rvcih0cnVzdGVkVmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZURlbGVnYXRlI3ZhbHVlT2YKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIElmIHRoZSBwYXNzZWQgcGFyYW1ldGVyIGhhZCBiZWVuIHJldHVybmVkIGJ5IGEgcHJpb3IgY2FsbCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LCByZXR1cm5zIHRoZSB2YWx1ZSB0aGF0IGhhZCBiZWVuIHBhc3NlZCB0byB7QGxpbmsKICAgICAqIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LgogICAgICoKICAgICAqIElmIHRoZSBwYXNzZWQgcGFyYW1ldGVyIGlzIG5vdCBhIHZhbHVlIHRoYXQgaGFkIGJlZW4gcmV0dXJuZWQgYnkge0BsaW5rCiAgICAgKiBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSwgcmV0dXJucyBpdCBhcy1pcy4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0KICAgICAqICAgICAgY2FsbCBvciBhbnl0aGluZyBlbHNlLgogICAgICogQHJldHVybnMgeyp9IFRoZSBgdmFsdWVgIHRoYXQgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiAgICAgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gaWYgYHZhbHVlYCBpcyB0aGUgcmVzdWx0IG9mIHN1Y2ggYSBjYWxsLiAgT3RoZXJ3aXNlLCByZXR1cm5zCiAgICAgKiAgICAgYHZhbHVlYCB1bmNoYW5nZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHZhbHVlT2YobWF5YmVUcnVzdGVkKSB7CiAgICAgIGlmIChtYXliZVRydXN0ZWQgaW5zdGFuY2VvZiB0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKSB7CiAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZC4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUYWtlcyB0aGUgcmVzdWx0IG9mIGEge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9IGNhbGwgYW5kCiAgICAgKiByZXR1cm5zIHRoZSBvcmlnaW5hbGx5IHN1cHBsaWVkIHZhbHVlIGlmIHRoZSBxdWVyaWVkIGNvbnRleHQgdHlwZSBpcyBhIHN1cGVydHlwZSBvZiB0aGUKICAgICAqIGNyZWF0ZWQgdHlwZS4gIElmIHRoaXMgY29uZGl0aW9uIGlzbid0IHNhdGlzZmllZCwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgdG8gYmUgdXNlZC4KICAgICAqIEBwYXJhbSB7Kn0gbWF5YmVUcnVzdGVkIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBjYWxsLgogICAgICogQHJldHVybnMgeyp9IFRoZSB2YWx1ZSB0aGUgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiAgICAgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gaWYgdmFsaWQgaW4gdGhpcyBjb250ZXh0LiAgT3RoZXJ3aXNlLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRUcnVzdGVkKHR5cGUsIG1heWJlVHJ1c3RlZCkgewogICAgICBpZiAobWF5YmVUcnVzdGVkID09PSBudWxsIHx8IG1heWJlVHJ1c3RlZCA9PT0gdW5kZWZpbmVkIHx8IG1heWJlVHJ1c3RlZCA9PT0gJycpIHsKICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkOwogICAgICB9CiAgICAgIHZhciBjb25zdHJ1Y3RvciA9IChieVR5cGUuaGFzT3duUHJvcGVydHkodHlwZSkgPyBieVR5cGVbdHlwZV0gOiBudWxsKTsKICAgICAgaWYgKGNvbnN0cnVjdG9yICYmIG1heWJlVHJ1c3RlZCBpbnN0YW5jZW9mIGNvbnN0cnVjdG9yKSB7CiAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZC4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpOwogICAgICB9CiAgICAgIC8vIElmIHdlIGdldCBoZXJlLCB0aGVuIHdlIG1heSBvbmx5IHRha2Ugb25lIG9mIHR3byBhY3Rpb25zLgogICAgICAvLyAxLiBzYW5pdGl6ZSB0aGUgdmFsdWUgZm9yIHRoZSByZXF1ZXN0ZWQgdHlwZSwgb3IKICAgICAgLy8gMi4gdGhyb3cgYW4gZXhjZXB0aW9uLgogICAgICBpZiAodHlwZSA9PT0gU0NFX0NPTlRFWFRTLlJFU09VUkNFX1VSTCkgewogICAgICAgIGlmIChpc1Jlc291cmNlVXJsQWxsb3dlZEJ5UG9saWN5KG1heWJlVHJ1c3RlZCkpIHsKICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2luc2VjdXJsJywKICAgICAgICAgICAgICAnQmxvY2tlZCBsb2FkaW5nIHJlc291cmNlIGZyb20gdXJsIG5vdCBhbGxvd2VkIGJ5ICRzY2VEZWxlZ2F0ZSBwb2xpY3kuICBVUkw6IHswfScsCiAgICAgICAgICAgICAgbWF5YmVUcnVzdGVkLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBTQ0VfQ09OVEVYVFMuSFRNTCkgewogICAgICAgIHJldHVybiBodG1sU2FuaXRpemVyKG1heWJlVHJ1c3RlZCk7CiAgICAgIH0KICAgICAgdGhyb3cgJHNjZU1pbkVycigndW5zYWZlJywgJ0F0dGVtcHRpbmcgdG8gdXNlIGFuIHVuc2FmZSB2YWx1ZSBpbiBhIHNhZmUgY29udGV4dC4nKTsKICAgIH0KCiAgICByZXR1cm4geyB0cnVzdEFzOiB0cnVzdEFzLAogICAgICAgICAgICAgZ2V0VHJ1c3RlZDogZ2V0VHJ1c3RlZCwKICAgICAgICAgICAgIHZhbHVlT2Y6IHZhbHVlT2YgfTsKICB9XTsKfQoKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJHNjZVByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUgJHNjZVByb3ZpZGVyIHByb3ZpZGVyIGFsbG93cyBkZXZlbG9wZXJzIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIG5nLiRzY2UgJHNjZX0gc2VydmljZS4KICogLSAgIGVuYWJsZS9kaXNhYmxlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpIGluIGEgbW9kdWxlCiAqIC0gICBvdmVycmlkZSB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aXRoIGEgY3VzdG9tIGRlbGVnYXRlCiAqCiAqIFJlYWQgbW9yZSBhYm91dCB7QGxpbmsgbmcuJHNjZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAqLwoKLyoganNoaW50IG1heGxlbjogZmFsc2UqLwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRzY2UKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIGAkc2NlYCBpcyBhIHNlcnZpY2UgdGhhdCBwcm92aWRlcyBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBzZXJ2aWNlcyB0byBBbmd1bGFySlMuCiAqCiAqICMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcKICoKICogU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSkgaXMgYSBtb2RlIGluIHdoaWNoIEFuZ3VsYXJKUyByZXF1aXJlcyBiaW5kaW5ncyBpbiBjZXJ0YWluCiAqIGNvbnRleHRzIHRvIHJlc3VsdCBpbiBhIHZhbHVlIHRoYXQgaXMgbWFya2VkIGFzIHNhZmUgdG8gdXNlIGZvciB0aGF0IGNvbnRleHQuICBPbmUgZXhhbXBsZSBvZgogKiBzdWNoIGEgY29udGV4dCBpcyBiaW5kaW5nIGFyYml0cmFyeSBodG1sIGNvbnRyb2xsZWQgYnkgdGhlIHVzZXIgdmlhIGBuZy1iaW5kLWh0bWxgLiAgV2UgcmVmZXIKICogdG8gdGhlc2UgY29udGV4dHMgYXMgcHJpdmlsZWdlZCBvciBTQ0UgY29udGV4dHMuCiAqCiAqIEFzIG9mIHZlcnNpb24gMS4yLCBBbmd1bGFyIHNoaXBzIHdpdGggU0NFIGVuYWJsZWQgYnkgZGVmYXVsdC4KICoKICogTm90ZTogIFdoZW4gZW5hYmxlZCAodGhlIGRlZmF1bHQpLCBJRTggaW4gcXVpcmtzIG1vZGUgaXMgbm90IHN1cHBvcnRlZC4gIEluIHRoaXMgbW9kZSwgSUU4IGFsbG93cwogKiBvbmUgdG8gZXhlY3V0ZSBhcmJpdHJhcnkgamF2YXNjcmlwdCBieSB0aGUgdXNlIG9mIHRoZSBleHByZXNzaW9uKCkgc3ludGF4LiAgUmVmZXIKICogPGh0dHA6Ly9ibG9ncy5tc2RuLmNvbS9iL2llL2FyY2hpdmUvMjAwOC8xMC8xNi9lbmRpbmctZXhwcmVzc2lvbnMuYXNweD4gdG8gbGVhcm4gbW9yZSBhYm91dCB0aGVtLgogKiBZb3UgY2FuIGVuc3VyZSB5b3VyIGRvY3VtZW50IGlzIGluIHN0YW5kYXJkcyBtb2RlIGFuZCBub3QgcXVpcmtzIG1vZGUgYnkgYWRkaW5nIGA8IWRvY3R5cGUgaHRtbD5gCiAqIHRvIHRoZSB0b3Agb2YgeW91ciBIVE1MIGRvY3VtZW50LgogKgogKiBTQ0UgYXNzaXN0cyBpbiB3cml0aW5nIGNvZGUgaW4gd2F5IHRoYXQgKGEpIGlzIHNlY3VyZSBieSBkZWZhdWx0IGFuZCAoYikgbWFrZXMgYXVkaXRpbmcgZm9yCiAqIHNlY3VyaXR5IHZ1bG5lcmFiaWxpdGllcyBzdWNoIGFzIFhTUywgY2xpY2tqYWNraW5nLCBldGMuIGEgbG90IGVhc2llci4KICoKICogSGVyZSdzIGFuIGV4YW1wbGUgb2YgYSBiaW5kaW5nIGluIGEgcHJpdmlsZWdlZCBjb250ZXh0OgogKgogKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAqICAgICA8aW5wdXQgbmctbW9kZWw9InVzZXJIdG1sIj4KICogICAgIDxkaXYgbmctYmluZC1odG1sPSJ1c2VySHRtbCI+CiAqIDwvcHJlPgogKgogKiBOb3RpY2UgdGhhdCBgbmctYmluZC1odG1sYCBpcyBib3VuZCB0byBgdXNlckh0bWxgIGNvbnRyb2xsZWQgYnkgdGhlIHVzZXIuICBXaXRoIFNDRQogKiBkaXNhYmxlZCwgdGhpcyBhcHBsaWNhdGlvbiBhbGxvd3MgdGhlIHVzZXIgdG8gcmVuZGVyIGFyYml0cmFyeSBIVE1MIGludG8gdGhlIERJVi4KICogSW4gYSBtb3JlIHJlYWxpc3RpYyBleGFtcGxlLCBvbmUgbWF5IGJlIHJlbmRlcmluZyB1c2VyIGNvbW1lbnRzLCBibG9nIGFydGljbGVzLCBldGMuIHZpYQogKiBiaW5kaW5ncy4gIChIVE1MIGlzIGp1c3Qgb25lIGV4YW1wbGUgb2YgYSBjb250ZXh0IHdoZXJlIHJlbmRlcmluZyB1c2VyIGNvbnRyb2xsZWQgaW5wdXQgY3JlYXRlcwogKiBzZWN1cml0eSB2dWxuZXJhYmlsaXRpZXMuKQogKgogKiBGb3IgdGhlIGNhc2Ugb2YgSFRNTCwgeW91IG1pZ2h0IHVzZSBhIGxpYnJhcnksIGVpdGhlciBvbiB0aGUgY2xpZW50IHNpZGUsIG9yIG9uIHRoZSBzZXJ2ZXIgc2lkZSwKICogdG8gc2FuaXRpemUgdW5zYWZlIEhUTUwgYmVmb3JlIGJpbmRpbmcgdG8gdGhlIHZhbHVlIGFuZCByZW5kZXJpbmcgaXQgaW4gdGhlIGRvY3VtZW50LgogKgogKiBIb3cgd291bGQgeW91IGVuc3VyZSB0aGF0IGV2ZXJ5IHBsYWNlIHRoYXQgdXNlZCB0aGVzZSB0eXBlcyBvZiBiaW5kaW5ncyB3YXMgYm91bmQgdG8gYSB2YWx1ZSB0aGF0CiAqIHdhcyBzYW5pdGl6ZWQgYnkgeW91ciBsaWJyYXJ5IChvciByZXR1cm5lZCBhcyBzYWZlIGZvciByZW5kZXJpbmcgYnkgeW91ciBzZXJ2ZXI/KSAgSG93IGNhbiB5b3UKICogZW5zdXJlIHRoYXQgeW91IGRpZG4ndCBhY2NpZGVudGFsbHkgZGVsZXRlIHRoZSBsaW5lIHRoYXQgc2FuaXRpemVkIHRoZSB2YWx1ZSwgb3IgcmVuYW1lZCBzb21lCiAqIHByb3BlcnRpZXMvZmllbGRzIGFuZCBmb3Jnb3QgdG8gdXBkYXRlIHRoZSBiaW5kaW5nIHRvIHRoZSBzYW5pdGl6ZWQgdmFsdWU/CiAqCiAqIFRvIGJlIHNlY3VyZSBieSBkZWZhdWx0LCB5b3Ugd2FudCB0byBlbnN1cmUgdGhhdCBhbnkgc3VjaCBiaW5kaW5ncyBhcmUgZGlzYWxsb3dlZCB1bmxlc3MgeW91IGNhbgogKiBkZXRlcm1pbmUgdGhhdCBzb21ldGhpbmcgZXhwbGljaXRseSBzYXlzIGl0J3Mgc2FmZSB0byB1c2UgYSB2YWx1ZSBmb3IgYmluZGluZyBpbiB0aGF0CiAqIGNvbnRleHQuICBZb3UgY2FuIHRoZW4gYXVkaXQgeW91ciBjb2RlIChhIHNpbXBsZSBncmVwIHdvdWxkIGRvKSB0byBlbnN1cmUgdGhhdCB0aGlzIGlzIG9ubHkgZG9uZQogKiBmb3IgdGhvc2UgdmFsdWVzIHRoYXQgeW91IGNhbiBlYXNpbHkgdGVsbCBhcmUgc2FmZSAtIGJlY2F1c2UgdGhleSB3ZXJlIHJlY2VpdmVkIGZyb20geW91ciBzZXJ2ZXIsCiAqIHNhbml0aXplZCBieSB5b3VyIGxpYnJhcnksIGV0Yy4gIFlvdSBjYW4gb3JnYW5pemUgeW91ciBjb2RlYmFzZSB0byBoZWxwIHdpdGggdGhpcyAtIHBlcmhhcHMKICogYWxsb3dpbmcgb25seSB0aGUgZmlsZXMgaW4gYSBzcGVjaWZpYyBkaXJlY3RvcnkgdG8gZG8gdGhpcy4gIEVuc3VyaW5nIHRoYXQgdGhlIGludGVybmFsIEFQSQogKiBleHBvc2VkIGJ5IHRoYXQgY29kZSBkb2Vzbid0IG1hcmt1cCBhcmJpdHJhcnkgdmFsdWVzIGFzIHNhZmUgdGhlbiBiZWNvbWVzIGEgbW9yZSBtYW5hZ2VhYmxlIHRhc2suCiAqCiAqIEluIHRoZSBjYXNlIG9mIEFuZ3VsYXJKUycgU0NFIHNlcnZpY2UsIG9uZSB1c2VzIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfQogKiAoYW5kIHNob3J0aGFuZCBtZXRob2RzIHN1Y2ggYXMge0BsaW5rIG5nLiRzY2UjdHJ1c3RBc0h0bWwgJHNjZS50cnVzdEFzSHRtbH0sIGV0Yy4pIHRvCiAqIG9idGFpbiB2YWx1ZXMgdGhhdCB3aWxsIGJlIGFjY2VwdGVkIGJ5IFNDRSAvIHByaXZpbGVnZWQgY29udGV4dHMuCiAqCiAqCiAqICMjIEhvdyBkb2VzIGl0IHdvcms/CiAqCiAqIEluIHByaXZpbGVnZWQgY29udGV4dHMsIGRpcmVjdGl2ZXMgYW5kIGNvZGUgd2lsbCBiaW5kIHRvIHRoZSByZXN1bHQgb2Yge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZAogKiAkc2NlLmdldFRydXN0ZWQoY29udGV4dCwgdmFsdWUpfSByYXRoZXIgdGhhbiB0byB0aGUgdmFsdWUgZGlyZWN0bHkuICBEaXJlY3RpdmVzIHVzZSB7QGxpbmsKICogbmcuJHNjZSNwYXJzZSAkc2NlLnBhcnNlQXN9IHJhdGhlciB0aGFuIGAkcGFyc2VgIHRvIHdhdGNoIGF0dHJpYnV0ZSBiaW5kaW5ncywgd2hpY2ggcGVyZm9ybXMgdGhlCiAqIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkfSBiZWhpbmQgdGhlIHNjZW5lcyBvbiBub24tY29uc3RhbnQgbGl0ZXJhbHMuCiAqCiAqIEFzIGFuIGV4YW1wbGUsIHtAbGluayBuZy5kaXJlY3RpdmU6bmdCaW5kSHRtbCBuZ0JpbmRIdG1sfSB1c2VzIHtAbGluawogKiBuZy4kc2NlI3BhcnNlQXNIdG1sICRzY2UucGFyc2VBc0h0bWwoYmluZGluZyBleHByZXNzaW9uKX0uICBIZXJlJ3MgdGhlIGFjdHVhbCBjb2RlIChzbGlnaHRseQogKiBzaW1wbGlmaWVkKToKICoKICogPHByZSBjbGFzcz0icHJldHR5cHJpbnQiPgogKiAgIHZhciBuZ0JpbmRIdG1sRGlyZWN0aXZlID0gWyckc2NlJywgZnVuY3Rpb24oJHNjZSkgewogKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAqICAgICAgIHNjb3BlLiR3YXRjaCgkc2NlLnBhcnNlQXNIdG1sKGF0dHIubmdCaW5kSHRtbCksIGZ1bmN0aW9uKHZhbHVlKSB7CiAqICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlIHx8ICcnKTsKICogICAgICAgfSk7CiAqICAgICB9OwogKiAgIH1dOwogKiA8L3ByZT4KICoKICogIyMgSW1wYWN0IG9uIGxvYWRpbmcgdGVtcGxhdGVzCiAqCiAqIFRoaXMgYXBwbGllcyBib3RoIHRvIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBgbmctaW5jbHVkZWB9IGRpcmVjdGl2ZSBhcyB3ZWxsIGFzCiAqIGB0ZW1wbGF0ZVVybGAncyBzcGVjaWZpZWQgYnkge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4KICoKICogQnkgZGVmYXVsdCwgQW5ndWxhciBvbmx5IGxvYWRzIHRlbXBsYXRlcyBmcm9tIHRoZSBzYW1lIGRvbWFpbiBhbmQgcHJvdG9jb2wgYXMgdGhlIGFwcGxpY2F0aW9uCiAqIGRvY3VtZW50LiAgVGhpcyBpcyBkb25lIGJ5IGNhbGxpbmcge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAqICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfSBvbiB0aGUgdGVtcGxhdGUgVVJMLiAgVG8gbG9hZCB0ZW1wbGF0ZXMgZnJvbSBvdGhlciBkb21haW5zIGFuZC9vcgogKiBwcm90b2NvbHMsIHlvdSBtYXkgZWl0aGVyIGVpdGhlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0CiAqIHRoZW19IG9yIHtAbGluayBuZy4kc2NlI3RydXN0QXNSZXNvdXJjZVVybCB3cmFwIGl0fSBpbnRvIGEgdHJ1c3RlZCB2YWx1ZS4KICoKICogKlBsZWFzZSBub3RlKjoKICogVGhlIGJyb3dzZXIncwogKiBbU2FtZSBPcmlnaW4gUG9saWN5XShodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Jyb3dzZXJzZWMvd2lraS9QYXJ0MiNTYW1lLW9yaWdpbl9wb2xpY3lfZm9yX1hNTEh0dHBSZXF1ZXN0KQogKiBhbmQgW0Nyb3NzLU9yaWdpbiBSZXNvdXJjZSBTaGFyaW5nIChDT1JTKV0oaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8pCiAqIHBvbGljeSBhcHBseSBpbiBhZGRpdGlvbiB0byB0aGlzIGFuZCBtYXkgZnVydGhlciByZXN0cmljdCB3aGV0aGVyIHRoZSB0ZW1wbGF0ZSBpcyBzdWNjZXNzZnVsbHkKICogbG9hZGVkLiAgVGhpcyBtZWFucyB0aGF0IHdpdGhvdXQgdGhlIHJpZ2h0IENPUlMgcG9saWN5LCBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbgogKiB3b24ndCB3b3JrIG9uIGFsbCBicm93c2Vycy4gIEFsc28sIGxvYWRpbmcgdGVtcGxhdGVzIGZyb20gYGZpbGU6Ly9gIFVSTCBkb2VzIG5vdCB3b3JrIG9uIHNvbWUKICogYnJvd3NlcnMuCiAqCiAqICMjIFRoaXMgZmVlbHMgbGlrZSB0b28gbXVjaCBvdmVyaGVhZCBmb3IgdGhlIGRldmVsb3Blcj8KICoKICogSXQncyBpbXBvcnRhbnQgdG8gcmVtZW1iZXIgdGhhdCBTQ0Ugb25seSBhcHBsaWVzIHRvIGludGVycG9sYXRpb24gZXhwcmVzc2lvbnMuCiAqCiAqIElmIHlvdXIgZXhwcmVzc2lvbnMgYXJlIGNvbnN0YW50IGxpdGVyYWxzLCB0aGV5J3JlIGF1dG9tYXRpY2FsbHkgdHJ1c3RlZCBhbmQgeW91IGRvbid0IG5lZWQgdG8KICogY2FsbCBgJHNjZS50cnVzdEFzYCBvbiB0aGVtIChyZW1lbWJlciB0byBpbmNsdWRlIHRoZSBgbmdTYW5pdGl6ZWAgbW9kdWxlKSAoZS5nLgogKiBgPGRpdiBuZy1iaW5kLWh0bWw9Iic8Yj5pbXBsaWNpdGx5IHRydXN0ZWQ8L2I+JyI+PC9kaXY+YCkganVzdCB3b3Jrcy4KICoKICogQWRkaXRpb25hbGx5LCBgYVtocmVmXWAgYW5kIGBpbWdbc3JjXWAgYXV0b21hdGljYWxseSBzYW5pdGl6ZSB0aGVpciBVUkxzIGFuZCBkbyBub3QgcGFzcyB0aGVtCiAqIHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWR9LiAgU0NFIGRvZXNuJ3QgcGxheSBhIHJvbGUgaGVyZS4KICoKICogVGhlIGluY2x1ZGVkIHtAbGluayBuZy4kc2NlRGVsZWdhdGUgJHNjZURlbGVnYXRlfSBjb21lcyB3aXRoIHNhbmUgZGVmYXVsdHMgdG8gYWxsb3cgeW91IHRvIGxvYWQKICogdGVtcGxhdGVzIGluIGBuZy1pbmNsdWRlYCBmcm9tIHlvdXIgYXBwbGljYXRpb24ncyBkb21haW4gd2l0aG91dCBoYXZpbmcgdG8gZXZlbiBrbm93IGFib3V0IFNDRS4KICogSXQgYmxvY2tzIGxvYWRpbmcgdGVtcGxhdGVzIGZyb20gb3RoZXIgZG9tYWlucyBvciBsb2FkaW5nIHRlbXBsYXRlcyBvdmVyIGh0dHAgZnJvbSBhbiBodHRwcwogKiBzZXJ2ZWQgZG9jdW1lbnQuICBZb3UgY2FuIGNoYW5nZSB0aGVzZSBieSBzZXR0aW5nIHlvdXIgb3duIGN1c3RvbSB7QGxpbmsKICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0c30gYW5kIHtAbGluawogKiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdCBibGFja2xpc3RzfSBmb3IgbWF0Y2hpbmcgc3VjaCBVUkxzLgogKgogKiBUaGlzIHNpZ25pZmljYW50bHkgcmVkdWNlcyB0aGUgb3ZlcmhlYWQuICBJdCBpcyBmYXIgZWFzaWVyIHRvIHBheSB0aGUgc21hbGwgb3ZlcmhlYWQgYW5kIGhhdmUgYW4KICogYXBwbGljYXRpb24gdGhhdCdzIHNlY3VyZSBhbmQgY2FuIGJlIGF1ZGl0ZWQgdG8gdmVyaWZ5IHRoYXQgd2l0aCBtdWNoIG1vcmUgZWFzZSB0aGFuIGJvbHRpbmcKICogc2VjdXJpdHkgb250byBhbiBhcHBsaWNhdGlvbiBsYXRlci4KICoKICogPGEgbmFtZT0iY29udGV4dHMiPjwvYT4KICogIyMgV2hhdCB0cnVzdGVkIGNvbnRleHQgdHlwZXMgYXJlIHN1cHBvcnRlZD8KICoKICogfCBDb250ZXh0ICAgICAgICAgICAgIHwgTm90ZXMgICAgICAgICAgfAogKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS18CiAqIHwgYCRzY2UuSFRNTGAgICAgICAgICB8IEZvciBIVE1MIHRoYXQncyBzYWZlIHRvIHNvdXJjZSBpbnRvIHRoZSBhcHBsaWNhdGlvbi4gIFRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQmluZEh0bWwgbmdCaW5kSHRtbH0gZGlyZWN0aXZlIHVzZXMgdGhpcyBjb250ZXh0IGZvciBiaW5kaW5ncy4gSWYgYW4gdW5zYWZlIHZhbHVlIGlzIGVuY291bnRlcmVkIGFuZCB0aGUge0BsaW5rIG5nU2FuaXRpemUgJHNhbml0aXplfSBtb2R1bGUgaXMgcHJlc2VudCB0aGlzIHdpbGwgc2FuaXRpemUgdGhlIHZhbHVlIGluc3RlYWQgb2YgdGhyb3dpbmcgYW4gZXJyb3IuIHwKICogfCBgJHNjZS5DU1NgICAgICAgICAgIHwgRm9yIENTUyB0aGF0J3Mgc2FmZSB0byBzb3VyY2UgaW50byB0aGUgYXBwbGljYXRpb24uICBDdXJyZW50bHkgdW51c2VkLiAgRmVlbCBmcmVlIHRvIHVzZSBpdCBpbiB5b3VyIG93biBkaXJlY3RpdmVzLiB8CiAqIHwgYCRzY2UuVVJMYCAgICAgICAgICB8IEZvciBVUkxzIHRoYXQgYXJlIHNhZmUgdG8gZm9sbG93IGFzIGxpbmtzLiAgQ3VycmVudGx5IHVudXNlZCAoYDxhIGhyZWY9YCBhbmQgYDxpbWcgc3JjPWAgc2FuaXRpemUgdGhlaXIgdXJscyBhbmQgZG9uJ3QgY29uc3RpdHV0ZSBhbiBTQ0UgY29udGV4dC4gfAogKiB8IGAkc2NlLlJFU09VUkNFX1VSTGAgfCBGb3IgVVJMcyB0aGF0IGFyZSBub3Qgb25seSBzYWZlIHRvIGZvbGxvdyBhcyBsaW5rcywgYnV0IHdob3NlIGNvbnRlbnRzIGFyZSBhbHNvIHNhZmUgdG8gaW5jbHVkZSBpbiB5b3VyIGFwcGxpY2F0aW9uLiAgRXhhbXBsZXMgaW5jbHVkZSBgbmctaW5jbHVkZWAsIGBzcmNgIC8gYG5nU3JjYCBiaW5kaW5ncyBmb3IgdGFncyBvdGhlciB0aGFuIGBJTUdgIChlLmcuIGBJRlJBTUVgLCBgT0JKRUNUYCwgZXRjLikgIDxicj48YnI+Tm90ZSB0aGF0IGAkc2NlLlJFU09VUkNFX1VSTGAgbWFrZXMgYSBzdHJvbmdlciBzdGF0ZW1lbnQgYWJvdXQgdGhlIFVSTCB0aGFuIGAkc2NlLlVSTGAgZG9lcyBhbmQgdGhlcmVmb3JlIGNvbnRleHRzIHJlcXVpcmluZyB2YWx1ZXMgdHJ1c3RlZCBmb3IgYCRzY2UuUkVTT1VSQ0VfVVJMYCBjYW4gYmUgdXNlZCBhbnl3aGVyZSB0aGF0IHZhbHVlcyB0cnVzdGVkIGZvciBgJHNjZS5VUkxgIGFyZSByZXF1aXJlZC4gfAogKiB8IGAkc2NlLkpTYCAgICAgICAgICAgfCBGb3IgSmF2YVNjcmlwdCB0aGF0IGlzIHNhZmUgdG8gZXhlY3V0ZSBpbiB5b3VyIGFwcGxpY2F0aW9uJ3MgY29udGV4dC4gIEN1cnJlbnRseSB1bnVzZWQuICBGZWVsIGZyZWUgdG8gdXNlIGl0IGluIHlvdXIgb3duIGRpcmVjdGl2ZXMuIHwKICoKICogIyMgRm9ybWF0IG9mIGl0ZW1zIGluIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCByZXNvdXJjZVVybFdoaXRlbGlzdH0ve0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0IEJsYWNrbGlzdH0gPGEgbmFtZT0icmVzb3VyY2VVcmxQYXR0ZXJuSXRlbSI+PC9hPgogKgogKiAgRWFjaCBlbGVtZW50IGluIHRoZXNlIGFycmF5cyBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOgogKgogKiAgLSAqKidzZWxmJyoqCiAqICAgIC0gVGhlIHNwZWNpYWwgKipzdHJpbmcqKiwgYCdzZWxmJ2AsIGNhbiBiZSB1c2VkIHRvIG1hdGNoIGFnYWluc3QgYWxsIFVSTHMgb2YgdGhlICoqc2FtZQogKiAgICAgIGRvbWFpbioqIGFzIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1c2luZyB0aGUgKipzYW1lIHByb3RvY29sKiouCiAqICAtICoqU3RyaW5nKiogKGV4Y2VwdCB0aGUgc3BlY2lhbCB2YWx1ZSBgJ3NlbGYnYCkKICogICAgLSBUaGUgc3RyaW5nIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgZnVsbCAqbm9ybWFsaXplZCAvIGFic29sdXRlIFVSTCogb2YgdGhlIHJlc291cmNlCiAqICAgICAgYmVpbmcgdGVzdGVkIChzdWJzdHJpbmcgbWF0Y2hlcyBhcmUgbm90IGdvb2QgZW5vdWdoLikKICogICAgLSBUaGVyZSBhcmUgZXhhY3RseSAqKnR3byB3aWxkY2FyZCBzZXF1ZW5jZXMqKiAtIGAqYCBhbmQgYCoqYC4gIEFsbCBvdGhlciBjaGFyYWN0ZXJzCiAqICAgICAgbWF0Y2ggdGhlbXNlbHZlcy4KICogICAgLSBgKmA6IG1hdGNoZXMgemVybyBvciBtb3JlIG9jY3VycmVuY2VzIG9mIGFueSBjaGFyYWN0ZXIgb3RoZXIgdGhhbiBvbmUgb2YgdGhlIGZvbGxvd2luZyA2CiAqICAgICAgY2hhcmFjdGVyczogJ2A6YCcsICdgL2AnLCAnYC5gJywgJ2A/YCcsICdgJmAnIGFuZCAnOycuICBJdCdzIGEgdXNlZnVsIHdpbGRjYXJkIGZvciB1c2UKICogICAgICBpbiBhIHdoaXRlbGlzdC4KICogICAgLSBgKipgOiBtYXRjaGVzIHplcm8gb3IgbW9yZSBvY2N1cnJlbmNlcyBvZiAqYW55KiBjaGFyYWN0ZXIuICBBcyBzdWNoLCBpdCdzIG5vdAogKiAgICAgIG5vdCBhcHByb3ByaWF0ZSB0byB1c2UgaW4gZm9yIGEgc2NoZW1lLCBkb21haW4sIGV0Yy4gYXMgaXQgd291bGQgbWF0Y2ggdG9vIG11Y2guICAoZS5nLgogKiAgICAgIGh0dHA6Ly8qKi5leGFtcGxlLmNvbS8gd291bGQgbWF0Y2ggaHR0cDovL2V2aWwuY29tLz9pZ25vcmU9LmV4YW1wbGUuY29tLyBhbmQgdGhhdCBtaWdodAogKiAgICAgIG5vdCBoYXZlIGJlZW4gdGhlIGludGVudGlvbi4pICBJdHMgdXNhZ2UgYXQgdGhlIHZlcnkgZW5kIG9mIHRoZSBwYXRoIGlzIG9rLiAgKGUuZy4KICogICAgICBodHRwOi8vZm9vLmV4YW1wbGUuY29tL3RlbXBsYXRlcy8qKikuCiAqICAtICoqUmVnRXhwKiogKCpzZWUgY2F2ZWF0IGJlbG93KikKICogICAgLSAqQ2F2ZWF0KjogIFdoaWxlIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXJlIHBvd2VyZnVsIGFuZCBvZmZlciBncmVhdCBmbGV4aWJpbGl0eSwgIHRoZWlyIHN5bnRheAogKiAgICAgIChhbmQgYWxsIHRoZSBpbmV2aXRhYmxlIGVzY2FwaW5nKSBtYWtlcyB0aGVtICpoYXJkZXIgdG8gbWFpbnRhaW4qLiAgSXQncyBlYXN5IHRvCiAqICAgICAgYWNjaWRlbnRhbGx5IGludHJvZHVjZSBhIGJ1ZyB3aGVuIG9uZSB1cGRhdGVzIGEgY29tcGxleCBleHByZXNzaW9uIChpbWhvLCBhbGwgcmVnZXhlcyBzaG91bGQKICogICAgICBoYXZlIGdvb2QgdGVzdCBjb3ZlcmFnZS4pLiAgRm9yIGluc3RhbmNlLCB0aGUgdXNlIG9mIGAuYCBpbiB0aGUgcmVnZXggaXMgY29ycmVjdCBvbmx5IGluIGEKICogICAgICBzbWFsbCBudW1iZXIgb2YgY2FzZXMuICBBIGAuYCBjaGFyYWN0ZXIgaW4gdGhlIHJlZ2V4IHVzZWQgd2hlbiBtYXRjaGluZyB0aGUgc2NoZW1lIG9yIGEKICogICAgICBzdWJkb21haW4gY291bGQgYmUgbWF0Y2hlZCBhZ2FpbnN0IGEgYDpgIG9yIGxpdGVyYWwgYC5gIHRoYXQgd2FzIGxpa2VseSBub3QgaW50ZW5kZWQuICAgSXQKICogICAgICBpcyBoaWdobHkgcmVjb21tZW5kZWQgdG8gdXNlIHRoZSBzdHJpbmcgcGF0dGVybnMgYW5kIG9ubHkgZmFsbCBiYWNrIHRvIHJlZ3VsYXIgZXhwcmVzc2lvbnMKICogICAgICBpZiB0aGV5IGFzIGEgbGFzdCByZXNvcnQuCiAqICAgIC0gVGhlIHJlZ3VsYXIgZXhwcmVzc2lvbiBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIFJlZ0V4cCAoaS5lLiBub3QgYSBzdHJpbmcuKSAgSXQgaXMKICogICAgICBtYXRjaGVkIGFnYWluc3QgdGhlICoqZW50aXJlKiogKm5vcm1hbGl6ZWQgLyBhYnNvbHV0ZSBVUkwqIG9mIHRoZSByZXNvdXJjZSBiZWluZyB0ZXN0ZWQKICogICAgICAoZXZlbiB3aGVuIHRoZSBSZWdFeHAgZGlkIG5vdCBoYXZlIHRoZSBgXmAgYW5kIGAkYCBjb2Rlcy4pICBJbiBhZGRpdGlvbiwgYW55IGZsYWdzCiAqICAgICAgcHJlc2VudCBvbiB0aGUgUmVnRXhwIChzdWNoIGFzIG11bHRpbGluZSwgZ2xvYmFsLCBpZ25vcmVDYXNlKSBhcmUgaWdub3JlZC4KICogICAgLSBJZiB5b3UgYXJlIGdlbmVyYXRpbmcgeW91ciBKYXZhU2NyaXB0IGZyb20gc29tZSBvdGhlciB0ZW1wbGF0aW5nIGVuZ2luZSAobm90CiAqICAgICAgcmVjb21tZW5kZWQsIGUuZy4gaW4gaXNzdWUgWyM0MDA2XShodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy80MDA2KSksCiAqICAgICAgcmVtZW1iZXIgdG8gZXNjYXBlIHlvdXIgcmVndWxhciBleHByZXNzaW9uIChhbmQgYmUgYXdhcmUgdGhhdCB5b3UgbWlnaHQgbmVlZCBtb3JlIHRoYW4KICogICAgICBvbmUgbGV2ZWwgb2YgZXNjYXBpbmcgZGVwZW5kaW5nIG9uIHlvdXIgdGVtcGxhdGluZyBlbmdpbmUgYW5kIHRoZSB3YXkgeW91IGludGVycG9sYXRlZAogKiAgICAgIHRoZSB2YWx1ZS4pICBEbyBtYWtlIHVzZSBvZiB5b3VyIHBsYXRmb3JtJ3MgZXNjYXBpbmcgbWVjaGFuaXNtIGFzIGl0IG1pZ2h0IGJlIGdvb2QKICogICAgICBlbm91Z2ggYmVmb3JlIGNvZGluZyB5b3VyIG93bi4gIGUuZy4gUnVieSBoYXMKICogICAgICBbUmVnZXhwLmVzY2FwZShzdHIpXShodHRwOi8vd3d3LnJ1YnktZG9jLm9yZy9jb3JlLTIuMC4wL1JlZ2V4cC5odG1sI21ldGhvZC1jLWVzY2FwZSkKICogICAgICBhbmQgUHl0aG9uIGhhcyBbcmUuZXNjYXBlXShodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvcmUuaHRtbCNyZS5lc2NhcGUpLgogKiAgICAgIEphdmFzY3JpcHQgbGFja3MgYSBzaW1pbGFyIGJ1aWx0IGluIGZ1bmN0aW9uIGZvciBlc2NhcGluZy4gIFRha2UgYSBsb29rIGF0IEdvb2dsZQogKiAgICAgIENsb3N1cmUgbGlicmFyeSdzIFtnb29nLnN0cmluZy5yZWdFeHBFc2NhcGUocyldKAogKiAgICAgIGh0dHA6Ly9kb2NzLmNsb3N1cmUtbGlicmFyeS5nb29nbGVjb2RlLmNvbS9naXQvY2xvc3VyZV9nb29nX3N0cmluZ19zdHJpbmcuanMuc291cmNlLmh0bWwjbGluZTk2MikuCiAqCiAqIFJlZmVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciAkc2NlRGVsZWdhdGVQcm92aWRlcn0gZm9yIGFuIGV4YW1wbGUuCiAqCiAqICMjIFNob3cgbWUgYW4gZXhhbXBsZSB1c2luZyBTQ0UuCiAqCiAqIEBleGFtcGxlCjxleGFtcGxlIG1vZHVsZT0ibXlTY2VBcHAiIGRlcHM9ImFuZ3VsYXItc2FuaXRpemUuanMiPgo8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICA8ZGl2IG5nLWNvbnRyb2xsZXI9Im15QXBwQ29udHJvbGxlciBhcyBteUN0cmwiPgogICAgPGkgbmctYmluZC1odG1sPSJteUN0cmwuZXhwbGljaXRseVRydXN0ZWRIdG1sIiBpZD0iZXhwbGljaXRseVRydXN0ZWRIdG1sIj48L2k+PGJyPjxicj4KICAgIDxiPlVzZXIgY29tbWVudHM8L2I+PGJyPgogICAgQnkgZGVmYXVsdCwgSFRNTCB0aGF0IGlzbid0IGV4cGxpY2l0bHkgdHJ1c3RlZCAoZS5nLiBBbGljZSdzIGNvbW1lbnQpIGlzIHNhbml0aXplZCB3aGVuCiAgICAkc2FuaXRpemUgaXMgYXZhaWxhYmxlLiAgSWYgJHNhbml0aXplIGlzbid0IGF2YWlsYWJsZSwgdGhpcyByZXN1bHRzIGluIGFuIGVycm9yIGluc3RlYWQgb2YgYW4KICAgIGV4cGxvaXQuCiAgICA8ZGl2IGNsYXNzPSJ3ZWxsIj4KICAgICAgPGRpdiBuZy1yZXBlYXQ9InVzZXJDb21tZW50IGluIG15Q3RybC51c2VyQ29tbWVudHMiPgogICAgICAgIDxiPnt7dXNlckNvbW1lbnQubmFtZX19PC9iPjoKICAgICAgICA8c3BhbiBuZy1iaW5kLWh0bWw9InVzZXJDb21tZW50Lmh0bWxDb21tZW50IiBjbGFzcz0iaHRtbENvbW1lbnQiPjwvc3Bhbj4KICAgICAgICA8YnI+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9kaXY+CjwvZmlsZT4KCjxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgdmFyIG15U2NlQXBwID0gYW5ndWxhci5tb2R1bGUoJ215U2NlQXBwJywgWyduZ1Nhbml0aXplJ10pOwoKICBteVNjZUFwcC5jb250cm9sbGVyKCJteUFwcENvbnRyb2xsZXIiLCBmdW5jdGlvbiBteUFwcENvbnRyb2xsZXIoJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkc2NlKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAkaHR0cC5nZXQoInRlc3RfZGF0YS5qc29uIiwge2NhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLnN1Y2Nlc3MoZnVuY3Rpb24odXNlckNvbW1lbnRzKSB7CiAgICAgIHNlbGYudXNlckNvbW1lbnRzID0gdXNlckNvbW1lbnRzOwogICAgfSk7CiAgICBzZWxmLmV4cGxpY2l0bHlUcnVzdGVkSHRtbCA9ICRzY2UudHJ1c3RBc0h0bWwoCiAgICAgICAgJzxzcGFuIG9ubW91c2VvdmVyPSJ0aGlzLnRleHRDb250ZW50PSZxdW90O0V4cGxpY2l0bHkgdHJ1c3RlZCBIVE1MIGJ5cGFzc2VzICcgKwogICAgICAgICdzYW5pdGl6YXRpb24uJnF1b3Q7Ij5Ib3ZlciBvdmVyIHRoaXMgdGV4dC48L3NwYW4+Jyk7CiAgfSk7CjwvZmlsZT4KCjxmaWxlIG5hbWU9InRlc3RfZGF0YS5qc29uIj4KWwogIHsgIm5hbWUiOiAiQWxpY2UiLAogICAgImh0bWxDb21tZW50IjoKICAgICAgICAiPHNwYW4gb25tb3VzZW92ZXI9J3RoaXMudGV4dENvbnRlbnQ9XCJQV04zRCFcIic+SXMgPGk+YW55b25lPC9pPiByZWFkaW5nIHRoaXM/PC9zcGFuPiIKICB9LAogIHsgIm5hbWUiOiAiQm9iIiwKICAgICJodG1sQ29tbWVudCI6ICI8aT5ZZXMhPC9pPiAgQW0gSSB0aGUgb25seSBvdGhlciBvbmU/IgogIH0KXQo8L2ZpbGU+Cgo8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICBkZXNjcmliZSgnU0NFIGRvYyBkZW1vJywgZnVuY3Rpb24oKSB7CiAgICBpdCgnc2hvdWxkIHNhbml0aXplIHVudHJ1c3RlZCB2YWx1ZXMnLCBmdW5jdGlvbigpIHsKICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcuaHRtbENvbW1lbnQnKSkuZ2V0SW5uZXJIdG1sKCkpCiAgICAgICAgICAudG9CZSgnPHNwYW4+SXMgPGk+YW55b25lPC9pPiByZWFkaW5nIHRoaXM/PC9zcGFuPicpOwogICAgfSk7CgogICAgaXQoJ3Nob3VsZCBOT1Qgc2FuaXRpemUgZXhwbGljaXRseSB0cnVzdGVkIHZhbHVlcycsIGZ1bmN0aW9uKCkgewogICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZXhwbGljaXRseVRydXN0ZWRIdG1sJykpLmdldElubmVySHRtbCgpKS50b0JlKAogICAgICAgICAgJzxzcGFuIG9ubW91c2VvdmVyPSJ0aGlzLnRleHRDb250ZW50PSZxdW90O0V4cGxpY2l0bHkgdHJ1c3RlZCBIVE1MIGJ5cGFzc2VzICcgKwogICAgICAgICAgJ3Nhbml0aXphdGlvbi4mcXVvdDsiPkhvdmVyIG92ZXIgdGhpcyB0ZXh0Ljwvc3Bhbj4nKTsKICAgIH0pOwogIH0pOwo8L2ZpbGU+CjwvZXhhbXBsZT4KICoKICoKICoKICogIyMgQ2FuIEkgZGlzYWJsZSBTQ0UgY29tcGxldGVseT8KICoKICogWWVzLCB5b3UgY2FuLiAgSG93ZXZlciwgdGhpcyBpcyBzdHJvbmdseSBkaXNjb3VyYWdlZC4gIFNDRSBnaXZlcyB5b3UgYSBsb3Qgb2Ygc2VjdXJpdHkgYmVuZWZpdHMKICogZm9yIGxpdHRsZSBjb2Rpbmcgb3ZlcmhlYWQuICBJdCB3aWxsIGJlIG11Y2ggaGFyZGVyIHRvIHRha2UgYW4gU0NFIGRpc2FibGVkIGFwcGxpY2F0aW9uIGFuZAogKiBlaXRoZXIgc2VjdXJlIGl0IG9uIHlvdXIgb3duIG9yIGVuYWJsZSBTQ0UgYXQgYSBsYXRlciBzdGFnZS4gIEl0IG1pZ2h0IG1ha2Ugc2Vuc2UgdG8gZGlzYWJsZSBTQ0UKICogZm9yIGNhc2VzIHdoZXJlIHlvdSBoYXZlIGEgbG90IG9mIGV4aXN0aW5nIGNvZGUgdGhhdCB3YXMgd3JpdHRlbiBiZWZvcmUgU0NFIHdhcyBpbnRyb2R1Y2VkIGFuZAogKiB5b3UncmUgbWlncmF0aW5nIHRoZW0gYSBtb2R1bGUgYXQgYSB0aW1lLgogKgogKiBUaGF0IHNhaWQsIGhlcmUncyBob3cgeW91IGNhbiBjb21wbGV0ZWx5IGRpc2FibGUgU0NFOgogKgogKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAqICAgYW5ndWxhci5tb2R1bGUoJ215QXBwV2l0aFNjZURpc2FibGVkbXlBcHAnLCBbXSkuY29uZmlnKGZ1bmN0aW9uKCRzY2VQcm92aWRlcikgewogKiAgICAgLy8gQ29tcGxldGVseSBkaXNhYmxlIFNDRS4gIEZvciBkZW1vbnN0cmF0aW9uIHB1cnBvc2VzIG9ubHkhCiAqICAgICAvLyBEbyBub3QgdXNlIGluIG5ldyBwcm9qZWN0cy4KICogICAgICRzY2VQcm92aWRlci5lbmFibGVkKGZhbHNlKTsKICogICB9KTsKICogPC9wcmU+CiAqCiAqLwovKiBqc2hpbnQgbWF4bGVuOiAxMDAgKi8KCmZ1bmN0aW9uICRTY2VQcm92aWRlcigpIHsKICB2YXIgZW5hYmxlZCA9IHRydWU7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkc2NlUHJvdmlkZXIjZW5hYmxlZAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBJZiBwcm92aWRlZCwgdGhlbiBlbmFibGVzL2Rpc2FibGVzIFNDRS4KICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIFNDRSBpcyBlbmFibGVkLCBmYWxzZSBvdGhlcndpc2UuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBFbmFibGVzL2Rpc2FibGVzIFNDRSBhbmQgcmV0dXJucyB0aGUgY3VycmVudCB2YWx1ZS4KICAgKi8KICB0aGlzLmVuYWJsZWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGVuYWJsZWQgPSAhIXZhbHVlOwogICAgfQogICAgcmV0dXJuIGVuYWJsZWQ7CiAgfTsKCgogIC8qIERlc2lnbiBub3RlcyBvbiB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBmb3IgU0NFLgogICAqCiAgICogVGhlIEFQSSBjb250cmFjdCBmb3IgdGhlIFNDRSBkZWxlZ2F0ZQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBUaGUgU0NFIGRlbGVnYXRlIG9iamVjdCBtdXN0IHByb3ZpZGUgdGhlIGZvbGxvd2luZyAzIG1ldGhvZHM6CiAgICoKICAgKiAtIHRydXN0QXMoY29udGV4dEVudW0sIHZhbHVlKQogICAqICAgICBUaGlzIG1ldGhvZCBpcyB1c2VkIHRvIHRlbGwgdGhlIFNDRSBzZXJ2aWNlIHRoYXQgdGhlIHByb3ZpZGVkIHZhbHVlIGlzIE9LIHRvIHVzZSBpbiB0aGUKICAgKiAgICAgY29udGV4dHMgc3BlY2lmaWVkIGJ5IGNvbnRleHRFbnVtLiAgSXQgbXVzdCByZXR1cm4gYW4gb2JqZWN0IHRoYXQgd2lsbCBiZSBhY2NlcHRlZCBieQogICAqICAgICBnZXRUcnVzdGVkKCkgZm9yIGEgY29tcGF0aWJsZSBjb250ZXh0RW51bSBhbmQgcmV0dXJuIHRoaXMgdmFsdWUuCiAgICoKICAgKiAtIHZhbHVlT2YodmFsdWUpCiAgICogICAgIEZvciB2YWx1ZXMgdGhhdCB3ZXJlIG5vdCBwcm9kdWNlZCBieSB0cnVzdEFzKCksIHJldHVybiB0aGVtIGFzIGlzLiAgRm9yIHZhbHVlcyB0aGF0IHdlcmUKICAgKiAgICAgcHJvZHVjZWQgYnkgdHJ1c3RBcygpLCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgaW5wdXQgdmFsdWUgdG8gdHJ1c3RBcy4gIEJhc2ljYWxseSwgaWYKICAgKiAgICAgdHJ1c3RBcyBpcyB3cmFwcGluZyB0aGUgZ2l2ZW4gdmFsdWVzIGludG8gc29tZSB0eXBlLCB0aGlzIG9wZXJhdGlvbiB1bndyYXBzIGl0IHdoZW4gZ2l2ZW4KICAgKiAgICAgc3VjaCBhIHZhbHVlLgogICAqCiAgICogLSBnZXRUcnVzdGVkKGNvbnRleHRFbnVtLCB2YWx1ZSkKICAgKiAgICAgVGhpcyBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIHRoZSBhIHZhbHVlIHRoYXQgaXMgc2FmZSB0byB1c2UgaW4gdGhlIGNvbnRleHQgc3BlY2lmaWVkIGJ5CiAgICogICAgIGNvbnRleHRFbnVtIG9yIHRocm93IGFuZCBleGNlcHRpb24gb3RoZXJ3aXNlLgogICAqCiAgICogTk9URTogVGhpcyBjb250cmFjdCBkZWxpYmVyYXRlbHkgZG9lcyBOT1Qgc3RhdGUgdGhhdCB2YWx1ZXMgcmV0dXJuZWQgYnkgdHJ1c3RBcygpIG11c3QgYmUKICAgKiBvcGFxdWUgb3Igd3JhcHBlZCBpbiBzb21lIGhvbGRlciBvYmplY3QuICBUaGF0IGhhcHBlbnMgdG8gYmUgYW4gaW1wbGVtZW50YXRpb24gZGV0YWlsLiAgRm9yCiAgICogaW5zdGFuY2UsIGFuIGltcGxlbWVudGF0aW9uIGNvdWxkIG1haW50YWluIGEgcmVnaXN0cnkgb2YgYWxsIHRydXN0ZWQgb2JqZWN0cyBieSBjb250ZXh0LiAgSW4KICAgKiBzdWNoIGEgY2FzZSwgdHJ1c3RBcygpIHdvdWxkIHJldHVybiB0aGUgc2FtZSBvYmplY3QgdGhhdCB3YXMgcGFzc2VkIGluLiAgZ2V0VHJ1c3RlZCgpIHdvdWxkCiAgICogcmV0dXJuIHRoZSBzYW1lIG9iamVjdCBwYXNzZWQgaW4gaWYgaXQgd2FzIGZvdW5kIGluIHRoZSByZWdpc3RyeSB1bmRlciBhIGNvbXBhdGlibGUgY29udGV4dCBvcgogICAqIHRocm93IGFuIGV4Y2VwdGlvbiBvdGhlcndpc2UuICBBbiBpbXBsZW1lbnRhdGlvbiBtaWdodCBvbmx5IHdyYXAgdmFsdWVzIHNvbWUgb2YgdGhlIHRpbWUgYmFzZWQKICAgKiBvbiBzb21lIGNyaXRlcmlhLiAgZ2V0VHJ1c3RlZCgpIG1pZ2h0IHJldHVybiBhIHZhbHVlIGFuZCBub3QgdGhyb3cgYW4gZXhjZXB0aW9uIGZvciBzcGVjaWFsCiAgICogY29uc3RhbnRzIG9yIG9iamVjdHMgZXZlbiBpZiBub3Qgd3JhcHBlZC4gIEFsbCBzdWNoIGltcGxlbWVudGF0aW9ucyBmdWxmaWxsIHRoaXMgY29udHJhY3QuCiAgICoKICAgKgogICAqIEEgbm90ZSBvbiB0aGUgaW5oZXJpdGFuY2UgbW9kZWwgZm9yIFNDRSBjb250ZXh0cwogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEkndmUgdXNlZCBpbmhlcml0YW5jZSBhbmQgbWFkZSBSRVNPVVJDRV9VUkwgd3JhcHBlZCB0eXBlcyBhIHN1YnR5cGUgb2YgVVJMIHdyYXBwZWQgdHlwZXMuICBUaGlzCiAgICogaXMgcHVyZWx5IGFuIGltcGxlbWVudGF0aW9uIGRldGFpbHMuCiAgICoKICAgKiBUaGUgY29udHJhY3QgaXMgc2ltcGx5IHRoaXM6CiAgICoKICAgKiAgICAgZ2V0VHJ1c3RlZCgkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpIHN1Y2NlZWRpbmcgaW1wbGllcyB0aGF0IGdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKQogICAqICAgICB3aWxsIGFsc28gc3VjY2VlZC4KICAgKgogICAqIEluaGVyaXRhbmNlIGhhcHBlbnMgdG8gY2FwdHVyZSB0aGlzIGluIGEgbmF0dXJhbCB3YXkuICBJbiBzb21lIGZ1dHVyZSwgd2UKICAgKiBtYXkgbm90IHVzZSBpbmhlcml0YW5jZSBhbnltb3JlLiAgVGhhdCBpcyBPSyBiZWNhdXNlIG5vIGNvZGUgb3V0c2lkZSBvZgogICAqIHNjZS5qcyBhbmQgc2NlU3BlY3MuanMgd291bGQgbmVlZCB0byBiZSBhd2FyZSBvZiB0aGlzIGRldGFpbC4KICAgKi8KCiAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCAnJHNuaWZmZXInLCAnJHNjZURlbGVnYXRlJywgZnVuY3Rpb24oCiAgICAgICAgICAgICAgICAkcGFyc2UsICAgJHNuaWZmZXIsICAgJHNjZURlbGVnYXRlKSB7CiAgICAvLyBQcmVyZXE6IEVuc3VyZSB0aGF0IHdlJ3JlIG5vdCBydW5uaW5nIGluIElFOCBxdWlya3MgbW9kZS4gIEluIHRoYXQgbW9kZSwgSUUgYWxsb3dzCiAgICAvLyB0aGUgImV4cHJlc3Npb24oamF2YXNjcmlwdCBleHByZXNzaW9uKSIgc3ludGF4IHdoaWNoIGlzIGluc2VjdXJlLgogICAgaWYgKGVuYWJsZWQgJiYgJHNuaWZmZXIubXNpZSAmJiAkc25pZmZlci5tc2llRG9jdW1lbnRNb2RlIDwgOCkgewogICAgICB0aHJvdyAkc2NlTWluRXJyKCdpZXF1aXJrcycsCiAgICAgICAgJ1N0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGRvZXMgbm90IHN1cHBvcnQgSW50ZXJuZXQgRXhwbG9yZXIgdmVyc2lvbiA8IDkgaW4gcXVpcmtzICcgKwogICAgICAgICdtb2RlLiAgWW91IGNhbiBmaXggdGhpcyBieSBhZGRpbmcgdGhlIHRleHQgPCFkb2N0eXBlIGh0bWw+IHRvIHRoZSB0b3Agb2YgeW91ciBIVE1MICcgKwogICAgICAgICdkb2N1bWVudC4gIFNlZSBodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy4kc2NlIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgfQoKICAgIHZhciBzY2UgPSBzaGFsbG93Q29weShTQ0VfQ09OVEVYVFMpOwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNpc0VuYWJsZWQKICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgKgogICAgICogQHJldHVybiB7Qm9vbGVhbn0gdHJ1ZSBpZiBTQ0UgaXMgZW5hYmxlZCwgZmFsc2Ugb3RoZXJ3aXNlLiAgSWYgeW91IHdhbnQgdG8gc2V0IHRoZSB2YWx1ZSwgeW91CiAgICAgKiBoYXZlIHRvIGRvIGl0IGF0IG1vZHVsZSBjb25maWcgdGltZSBvbiB7QGxpbmsgbmcuJHNjZVByb3ZpZGVyICRzY2VQcm92aWRlcn0uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGEgYm9vbGVhbiBpbmRpY2F0aW5nIGlmIFNDRSBpcyBlbmFibGVkLgogICAgICovCiAgICBzY2UuaXNFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZW5hYmxlZDsKICAgIH07CiAgICBzY2UudHJ1c3RBcyA9ICRzY2VEZWxlZ2F0ZS50cnVzdEFzOwogICAgc2NlLmdldFRydXN0ZWQgPSAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZDsKICAgIHNjZS52YWx1ZU9mID0gJHNjZURlbGVnYXRlLnZhbHVlT2Y7CgogICAgaWYgKCFlbmFibGVkKSB7CiAgICAgIHNjZS50cnVzdEFzID0gc2NlLmdldFRydXN0ZWQgPSBmdW5jdGlvbih0eXBlLCB2YWx1ZSkgeyByZXR1cm4gdmFsdWU7IH07CiAgICAgIHNjZS52YWx1ZU9mID0gaWRlbnRpdHk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4gIFRoaXMgaXMgbGlrZSB7QGxpbmsKICAgICAqIG5nLiRwYXJzZSAkcGFyc2V9IGFuZCBpcyBpZGVudGljYWwgd2hlbiB0aGUgZXhwcmVzc2lvbiBpcyBhIGxpdGVyYWwgY29uc3RhbnQuICBPdGhlcndpc2UsIGl0CiAgICAgKiB3cmFwcyB0aGUgZXhwcmVzc2lvbiBpbiBhIGNhbGwgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWQoKnR5cGUqLAogICAgICogKnJlc3VsdCopfQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIFNDRSBjb250ZXh0IGluIHdoaWNoIHRoaXMgcmVzdWx0IHdpbGwgYmUgdXNlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKi8KICAgIHNjZS5wYXJzZUFzID0gZnVuY3Rpb24gc2NlUGFyc2VBcyh0eXBlLCBleHByKSB7CiAgICAgIHZhciBwYXJzZWQgPSAkcGFyc2UoZXhwcik7CiAgICAgIGlmIChwYXJzZWQubGl0ZXJhbCAmJiBwYXJzZWQuY29uc3RhbnQpIHsKICAgICAgICByZXR1cm4gcGFyc2VkOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmdW5jdGlvbiBzY2VQYXJzZUFzVHJ1c3RlZChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgIHJldHVybiBzY2UuZ2V0VHJ1c3RlZCh0eXBlLCBwYXJzZWQoc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVsZWdhdGVzIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfS4gIEFzIHN1Y2gsCiAgICAgKiByZXR1cm5zIGFuIG9iamVjdCB0aGF0IGlzIHRydXN0ZWQgYnkgYW5ndWxhciBmb3IgdXNlIGluIHNwZWNpZmllZCBzdHJpY3QgY29udGV4dHVhbAogICAgICogZXNjYXBpbmcgY29udGV4dHMgKHN1Y2ggYXMgbmctYmluZC1odG1sLCBuZy1pbmNsdWRlLCBhbnkgc3JjIGF0dHJpYnV0ZQogICAgICogaW50ZXJwb2xhdGlvbiwgYW55IGRvbSBldmVudCBiaW5kaW5nIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIHN1Y2ggYXMgZm9yIG9uY2xpY2ssICBldGMuKQogICAgICogdGhhdCB1c2VzIHRoZSBwcm92aWRlZCB2YWx1ZS4gIFNlZSAqIHtAbGluayBuZy4kc2NlICRzY2V9IGZvciBlbmFibGluZyBzdHJpY3QgY29udGV4dHVhbAogICAgICogZXNjYXBpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHNhZmUgZm9yIHVzZS4gIGUuZy4gdXJsLAogICAgICogICByZXNvdXJjZV91cmwsIGh0bWwsIGpzIGFuZCBjc3MuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0aGF0IHRoYXQgc2hvdWxkIGJlIGNvbnNpZGVyZWQgdHJ1c3RlZC9zYWZlLgogICAgICogQHJldHVybnMgeyp9IEEgdmFsdWUgdGhhdCBjYW4gYmUgdXNlZCB0byBzdGFuZCBpbiBmb3IgdGhlIHByb3ZpZGVkIGB2YWx1ZWAgaW4gcGxhY2VzCiAgICAgKiB3aGVyZSBBbmd1bGFyIGV4cGVjdHMgYSAkc2NlLnRydXN0QXMoKSByZXR1cm4gdmFsdWUuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc0h0bWwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzSHRtbCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkSHRtbAogICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZEh0bWwodmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc1VybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzKCRzY2UuVVJMLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkVXJsCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkVXJsKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZQogICAgICogICAgIHJldHVybiB2YWx1ZSBvZiB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzICRzY2UudHJ1c3RBc30uKQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3RydXN0QXNSZXNvdXJjZVVybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNSZXNvdXJjZVVybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybAogICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZSByZXR1cm4KICAgICAqICAgICB2YWx1ZSBvZiB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzICRzY2UudHJ1c3RBc30uKQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3RydXN0QXNKcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNKcyh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5KUywgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICogQHJldHVybnMgeyp9IEFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZEpzCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkSnModmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVsZWdhdGVzIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWRgfS4gIEFzIHN1Y2gsCiAgICAgKiB0YWtlcyB0aGUgcmVzdWx0IG9mIGEge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyBgJHNjZS50cnVzdEFzYH0oKSBjYWxsIGFuZCByZXR1cm5zIHRoZQogICAgICogb3JpZ2luYWxseSBzdXBwbGllZCB2YWx1ZSBpZiB0aGUgcXVlcmllZCBjb250ZXh0IHR5cGUgaXMgYSBzdXBlcnR5cGUgb2YgdGhlIGNyZWF0ZWQgdHlwZS4KICAgICAqIElmIHRoaXMgY29uZGl0aW9uIGlzbid0IHNhdGlzZmllZCwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgdG8gYmUgdXNlZC4KICAgICAqIEBwYXJhbSB7Kn0gbWF5YmVUcnVzdGVkIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgY2FsbC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgdmFsdWUgdGhlIHdhcyBvcmlnaW5hbGx5IHByb3ZpZGVkIHRvCiAgICAgKiAgICAgICAgICAgICAge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyBgJHNjZS50cnVzdEFzYH0gaWYgdmFsaWQgaW4gdGhpcyBjb250ZXh0LgogICAgICogICAgICAgICAgICAgIE90aGVyd2lzZSwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkSHRtbAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRIdG1sKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5IVE1MLCB2YWx1ZSlgCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZENzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRDc3ModmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuQ1NTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2UuZ2V0VHJ1c3RlZGAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuQ1NTLCB2YWx1ZSlgCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZFVybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuVVJMLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2UuZ2V0VHJ1c3RlZGAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuVVJMLCB2YWx1ZSlgCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZGAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSlgCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZEpzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZEpzKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkpTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2UuZ2V0VHJ1c3RlZGAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuSlMsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzSHRtbAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNIdG1sKGV4cHJlc3Npb24gc3RyaW5nKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzQ3NzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UucGFyc2VBc0Nzcyh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5DU1MsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UucGFyc2VBc1VybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzUmVzb3VyY2VVcmwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZSBgJHNjZS5wYXJzZUFzKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjcGFyc2VBc0pzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UucGFyc2VBc0pzKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLkpTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKi8KCiAgICAvLyBTaG9ydGhhbmQgZGVsZWdhdGlvbnMuCiAgICB2YXIgcGFyc2UgPSBzY2UucGFyc2VBcywKICAgICAgICBnZXRUcnVzdGVkID0gc2NlLmdldFRydXN0ZWQsCiAgICAgICAgdHJ1c3RBcyA9IHNjZS50cnVzdEFzOwoKICAgIGZvckVhY2goU0NFX0NPTlRFWFRTLCBmdW5jdGlvbiAoZW51bVZhbHVlLCBuYW1lKSB7CiAgICAgIHZhciBsTmFtZSA9IGxvd2VyY2FzZShuYW1lKTsKICAgICAgc2NlW2NhbWVsQ2FzZSgicGFyc2VfYXNfIiArIGxOYW1lKV0gPSBmdW5jdGlvbiAoZXhwcikgewogICAgICAgIHJldHVybiBwYXJzZShlbnVtVmFsdWUsIGV4cHIpOwogICAgICB9OwogICAgICBzY2VbY2FtZWxDYXNlKCJnZXRfdHJ1c3RlZF8iICsgbE5hbWUpXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiBnZXRUcnVzdGVkKGVudW1WYWx1ZSwgdmFsdWUpOwogICAgICB9OwogICAgICBzY2VbY2FtZWxDYXNlKCJ0cnVzdF9hc18iICsgbE5hbWUpXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiB0cnVzdEFzKGVudW1WYWx1ZSwgdmFsdWUpOwogICAgICB9OwogICAgfSk7CgogICAgcmV0dXJuIHNjZTsKICB9XTsKfQoKLyoqCiAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgc2VydmljZSAhISEKICoKICogQG5hbWUgJHNuaWZmZXIKICogQHJlcXVpcmVzICR3aW5kb3cKICogQHJlcXVpcmVzICRkb2N1bWVudAogKgogKiBAcHJvcGVydHkge2Jvb2xlYW59IGhpc3RvcnkgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGh0bWw1IGhpc3RvcnkgYXBpID8KICogQHByb3BlcnR5IHtib29sZWFufSBoYXNoY2hhbmdlIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBoYXNoY2hhbmdlIGV2ZW50ID8KICogQHByb3BlcnR5IHtib29sZWFufSB0cmFuc2l0aW9ucyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgQ1NTIHRyYW5zaXRpb24gZXZlbnRzID8KICogQHByb3BlcnR5IHtib29sZWFufSBhbmltYXRpb25zIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBDU1MgYW5pbWF0aW9uIGV2ZW50cyA/CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGlzIHZlcnkgc2ltcGxlIGltcGxlbWVudGF0aW9uIG9mIHRlc3RpbmcgYnJvd3NlcidzIGZlYXR1cmVzLgogKi8KZnVuY3Rpb24gJFNuaWZmZXJQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICB2YXIgZXZlbnRTdXBwb3J0ID0ge30sCiAgICAgICAgYW5kcm9pZCA9CiAgICAgICAgICBpbnQoKC9hbmRyb2lkIChcZCspLy5leGVjKGxvd2VyY2FzZSgoJHdpbmRvdy5uYXZpZ2F0b3IgfHwge30pLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSksCiAgICAgICAgYm94ZWUgPSAvQm94ZWUvaS50ZXN0KCgkd2luZG93Lm5hdmlnYXRvciB8fCB7fSkudXNlckFnZW50KSwKICAgICAgICBkb2N1bWVudCA9ICRkb2N1bWVudFswXSB8fCB7fSwKICAgICAgICBkb2N1bWVudE1vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGUsCiAgICAgICAgdmVuZG9yUHJlZml4LAogICAgICAgIHZlbmRvclJlZ2V4ID0gL14oTW96fHdlYmtpdHxPfG1zKSg/PVtBLVpdKS8sCiAgICAgICAgYm9keVN0eWxlID0gZG9jdW1lbnQuYm9keSAmJiBkb2N1bWVudC5ib2R5LnN0eWxlLAogICAgICAgIHRyYW5zaXRpb25zID0gZmFsc2UsCiAgICAgICAgYW5pbWF0aW9ucyA9IGZhbHNlLAogICAgICAgIG1hdGNoOwoKICAgIGlmIChib2R5U3R5bGUpIHsKICAgICAgZm9yKHZhciBwcm9wIGluIGJvZHlTdHlsZSkgewogICAgICAgIGlmKG1hdGNoID0gdmVuZG9yUmVnZXguZXhlYyhwcm9wKSkgewogICAgICAgICAgdmVuZG9yUHJlZml4ID0gbWF0Y2hbMF07CiAgICAgICAgICB2ZW5kb3JQcmVmaXggPSB2ZW5kb3JQcmVmaXguc3Vic3RyKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyB2ZW5kb3JQcmVmaXguc3Vic3RyKDEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZighdmVuZG9yUHJlZml4KSB7CiAgICAgICAgdmVuZG9yUHJlZml4ID0gKCdXZWJraXRPcGFjaXR5JyBpbiBib2R5U3R5bGUpICYmICd3ZWJraXQnOwogICAgICB9CgogICAgICB0cmFuc2l0aW9ucyA9ICEhKCgndHJhbnNpdGlvbicgaW4gYm9keVN0eWxlKSB8fCAodmVuZG9yUHJlZml4ICsgJ1RyYW5zaXRpb24nIGluIGJvZHlTdHlsZSkpOwogICAgICBhbmltYXRpb25zICA9ICEhKCgnYW5pbWF0aW9uJyBpbiBib2R5U3R5bGUpIHx8ICh2ZW5kb3JQcmVmaXggKyAnQW5pbWF0aW9uJyBpbiBib2R5U3R5bGUpKTsKCiAgICAgIGlmIChhbmRyb2lkICYmICghdHJhbnNpdGlvbnN8fCFhbmltYXRpb25zKSkgewogICAgICAgIHRyYW5zaXRpb25zID0gaXNTdHJpbmcoZG9jdW1lbnQuYm9keS5zdHlsZS53ZWJraXRUcmFuc2l0aW9uKTsKICAgICAgICBhbmltYXRpb25zID0gaXNTdHJpbmcoZG9jdW1lbnQuYm9keS5zdHlsZS53ZWJraXRBbmltYXRpb24pOwogICAgICB9CiAgICB9CgoKICAgIHJldHVybiB7CiAgICAgIC8vIEFuZHJvaWQgaGFzIGhpc3RvcnkucHVzaFN0YXRlLCBidXQgaXQgZG9lcyBub3QgdXBkYXRlIGxvY2F0aW9uIGNvcnJlY3RseQogICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9hbmRyb2lkL2lzc3Vlcy9kZXRhaWw/aWQ9MTc0NzEKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvOTA0CgogICAgICAvLyBvbGRlciB3ZWJraXQgYnJvd3NlciAoNTMzLjkpIG9uIEJveGVlIGJveCBoYXMgZXhhY3RseSB0aGUgc2FtZSBwcm9ibGVtIGFzIEFuZHJvaWQgaGFzCiAgICAgIC8vIHNvIGxldCdzIG5vdCB1c2UgdGhlIGhpc3RvcnkgQVBJIGFsc28KICAgICAgLy8gV2UgYXJlIHB1cnBvc2VmdWxseSB1c2luZyBgIShhbmRyb2lkIDwgNClgIHRvIGNvdmVyIHRoZSBjYXNlIHdoZW4gYGFuZHJvaWRgIGlzIHVuZGVmaW5lZAogICAgICAvLyBqc2hpbnQgLVcwMTgKICAgICAgaGlzdG9yeTogISEoJHdpbmRvdy5oaXN0b3J5ICYmICR3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUgJiYgIShhbmRyb2lkIDwgNCkgJiYgIWJveGVlKSwKICAgICAgLy8ganNoaW50ICtXMDE4CiAgICAgIGhhc2hjaGFuZ2U6ICdvbmhhc2hjaGFuZ2UnIGluICR3aW5kb3cgJiYKICAgICAgICAgICAgICAgICAgLy8gSUU4IGNvbXBhdGlibGUgbW9kZSBsaWVzCiAgICAgICAgICAgICAgICAgICghZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50TW9kZSA+IDcpLAogICAgICBoYXNFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAvLyBJRTkgaW1wbGVtZW50cyAnaW5wdXQnIGV2ZW50IGl0J3Mgc28gZnViYXJlZCB0aGF0IHdlIHJhdGhlciBwcmV0ZW5kIHRoYXQgaXQgZG9lc24ndCBoYXZlCiAgICAgICAgLy8gaXQuIEluIHBhcnRpY3VsYXIgdGhlIGV2ZW50IGlzIG5vdCBmaXJlZCB3aGVuIGJhY2tzcGFjZSBvciBkZWxldGUga2V5IGFyZSBwcmVzc2VkIG9yCiAgICAgICAgLy8gd2hlbiBjdXQgb3BlcmF0aW9uIGlzIHBlcmZvcm1lZC4KICAgICAgICBpZiAoZXZlbnQgPT0gJ2lucHV0JyAmJiBtc2llID09IDkpIHJldHVybiBmYWxzZTsKCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGV2ZW50U3VwcG9ydFtldmVudF0pKSB7CiAgICAgICAgICB2YXIgZGl2RWxtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICBldmVudFN1cHBvcnRbZXZlbnRdID0gJ29uJyArIGV2ZW50IGluIGRpdkVsbTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBldmVudFN1cHBvcnRbZXZlbnRdOwogICAgICB9LAogICAgICBjc3A6IGNzcCgpLAogICAgICB2ZW5kb3JQcmVmaXg6IHZlbmRvclByZWZpeCwKICAgICAgdHJhbnNpdGlvbnMgOiB0cmFuc2l0aW9ucywKICAgICAgYW5pbWF0aW9ucyA6IGFuaW1hdGlvbnMsCiAgICAgIGFuZHJvaWQ6IGFuZHJvaWQsCiAgICAgIG1zaWUgOiBtc2llLAogICAgICBtc2llRG9jdW1lbnRNb2RlOiBkb2N1bWVudE1vZGUKICAgIH07CiAgfV07Cn0KCmZ1bmN0aW9uICRUaW1lb3V0UHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRicm93c2VyJywgJyRxJywgJyRleGNlcHRpb25IYW5kbGVyJywKICAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHEsICAgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgIHZhciBkZWZlcnJlZHMgPSB7fTsKCgogICAgIC8qKgogICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICogQG5hbWUgJHRpbWVvdXQKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIEFuZ3VsYXIncyB3cmFwcGVyIGZvciBgd2luZG93LnNldFRpbWVvdXRgLiBUaGUgYGZuYCBmdW5jdGlvbiBpcyB3cmFwcGVkIGludG8gYSB0cnkvY2F0Y2gKICAgICAgKiBibG9jayBhbmQgZGVsZWdhdGVzIGFueSBleGNlcHRpb25zIHRvCiAgICAgICoge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAqCiAgICAgICogVGhlIHJldHVybiB2YWx1ZSBvZiByZWdpc3RlcmluZyBhIHRpbWVvdXQgZnVuY3Rpb24gaXMgYSBwcm9taXNlLCB3aGljaCB3aWxsIGJlIHJlc29sdmVkIHdoZW4KICAgICAgKiB0aGUgdGltZW91dCBpcyByZWFjaGVkIGFuZCB0aGUgdGltZW91dCBmdW5jdGlvbiBpcyBleGVjdXRlZC4KICAgICAgKgogICAgICAqIFRvIGNhbmNlbCBhIHRpbWVvdXQgcmVxdWVzdCwgY2FsbCBgJHRpbWVvdXQuY2FuY2VsKHByb21pc2UpYC4KICAgICAgKgogICAgICAqIEluIHRlc3RzIHlvdSBjYW4gdXNlIHtAbGluayBuZ01vY2suJHRpbWVvdXQgYCR0aW1lb3V0LmZsdXNoKClgfSB0bwogICAgICAqIHN5bmNocm9ub3VzbHkgZmx1c2ggdGhlIHF1ZXVlIG9mIGRlZmVycmVkIGZ1bmN0aW9ucy4KICAgICAgKgogICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvc2UgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWxheWVkLgogICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIERlbGF5IGluIG1pbGxpc2Vjb25kcy4KICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBbaW52b2tlQXBwbHk9dHJ1ZV0gSWYgc2V0IHRvIGBmYWxzZWAgc2tpcHMgbW9kZWwgZGlydHkgY2hlY2tpbmcsIG90aGVyd2lzZQogICAgICAqICAgd2lsbCBpbnZva2UgYGZuYCB3aXRoaW4gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHl9IGJsb2NrLgogICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBQcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aGVuIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQuIFRoZSB2YWx1ZSB0aGlzCiAgICAgICogICBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBpcyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBgZm5gIGZ1bmN0aW9uLgogICAgICAqCiAgICAgICovCiAgICBmdW5jdGlvbiB0aW1lb3V0KGZuLCBkZWxheSwgaW52b2tlQXBwbHkpIHsKICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKSwKICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgc2tpcEFwcGx5ID0gKGlzRGVmaW5lZChpbnZva2VBcHBseSkgJiYgIWludm9rZUFwcGx5KSwKICAgICAgICAgIHRpbWVvdXRJZDsKCiAgICAgIHRpbWVvdXRJZCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGZuKCkpOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgfQogICAgICAgIGZpbmFsbHkgewogICAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICB9CgogICAgICAgIGlmICghc2tpcEFwcGx5KSAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICB9LCBkZWxheSk7CgogICAgICBwcm9taXNlLiQkdGltZW91dElkID0gdGltZW91dElkOwogICAgICBkZWZlcnJlZHNbdGltZW91dElkXSA9IGRlZmVycmVkOwoKICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CgoKICAgICAvKioKICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICogQG5hbWUgJHRpbWVvdXQjY2FuY2VsCiAgICAgICoKICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgKiBDYW5jZWxzIGEgdGFzayBhc3NvY2lhdGVkIHdpdGggdGhlIGBwcm9taXNlYC4gQXMgYSByZXN1bHQgb2YgdGhpcywgdGhlIHByb21pc2Ugd2lsbCBiZQogICAgICAqIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24uCiAgICAgICoKICAgICAgKiBAcGFyYW0ge1Byb21pc2U9fSBwcm9taXNlIFByb21pc2UgcmV0dXJuZWQgYnkgdGhlIGAkdGltZW91dGAgZnVuY3Rpb24uCiAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVsbHkKICAgICAgKiAgIGNhbmNlbGVkLgogICAgICAqLwogICAgdGltZW91dC5jYW5jZWwgPSBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgIGlmIChwcm9taXNlICYmIHByb21pc2UuJCR0aW1lb3V0SWQgaW4gZGVmZXJyZWRzKSB7CiAgICAgICAgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdLnJlamVjdCgnY2FuY2VsZWQnKTsKICAgICAgICBkZWxldGUgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdOwogICAgICAgIHJldHVybiAkYnJvd3Nlci5kZWZlci5jYW5jZWwocHJvbWlzZS4kJHRpbWVvdXRJZCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICByZXR1cm4gdGltZW91dDsKICB9XTsKfQoKLy8gTk9URTogIFRoZSB1c2FnZSBvZiB3aW5kb3cgYW5kIGRvY3VtZW50IGluc3RlYWQgb2YgJHdpbmRvdyBhbmQgJGRvY3VtZW50IGhlcmUgaXMKLy8gZGVsaWJlcmF0ZS4gIFRoaXMgc2VydmljZSBkZXBlbmRzIG9uIHRoZSBzcGVjaWZpYyBiZWhhdmlvciBvZiBhbmNob3Igbm9kZXMgY3JlYXRlZCBieSB0aGUKLy8gYnJvd3NlciAocmVzb2x2aW5nIGFuZCBwYXJzaW5nIFVSTHMpIHRoYXQgaXMgdW5saWtlbHkgdG8gYmUgcHJvdmlkZWQgYnkgbW9jayBvYmplY3RzIGFuZAovLyBjYXVzZSB1cyB0byBicmVhayB0ZXN0cy4gIEluIGFkZGl0aW9uLCB3aGVuIHRoZSBicm93c2VyIHJlc29sdmVzIGEgVVJMIGZvciBYSFIsIGl0Ci8vIGRvZXNuJ3Qga25vdyBhYm91dCBtb2NrZWQgbG9jYXRpb25zIGFuZCByZXNvbHZlcyBVUkxzIHRvIHRoZSByZWFsIGRvY3VtZW50IC0gd2hpY2ggaXMKLy8gZXhhY3RseSB0aGUgYmVoYXZpb3IgbmVlZGVkIGhlcmUuICBUaGVyZSBpcyBsaXR0bGUgdmFsdWUgaXMgbW9ja2luZyB0aGVzZSBvdXQgZm9yIHRoaXMKLy8gc2VydmljZS4KdmFyIHVybFBhcnNpbmdOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwp2YXIgb3JpZ2luVXJsID0gdXJsUmVzb2x2ZSh3aW5kb3cubG9jYXRpb24uaHJlZiwgdHJ1ZSk7CgoKLyoqCiAqCiAqIEltcGxlbWVudGF0aW9uIE5vdGVzIGZvciBub24tSUUgYnJvd3NlcnMKICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogKiBBc3NpZ25pbmcgYSBVUkwgdG8gdGhlIGhyZWYgcHJvcGVydHkgb2YgYW4gYW5jaG9yIERPTSBub2RlLCBldmVuIG9uZSBhdHRhY2hlZCB0byB0aGUgRE9NLAogKiByZXN1bHRzIGJvdGggaW4gdGhlIG5vcm1hbGl6aW5nIGFuZCBwYXJzaW5nIG9mIHRoZSBVUkwuICBOb3JtYWxpemluZyBtZWFucyB0aGF0IGEgcmVsYXRpdmUKICogVVJMIHdpbGwgYmUgcmVzb2x2ZWQgaW50byBhbiBhYnNvbHV0ZSBVUkwgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogKiBQYXJzaW5nIG1lYW5zIHRoYXQgdGhlIGFuY2hvciBub2RlJ3MgaG9zdCwgaG9zdG5hbWUsIHByb3RvY29sLCBwb3J0LCBwYXRobmFtZSBhbmQgcmVsYXRlZAogKiBwcm9wZXJ0aWVzIGFyZSBhbGwgcG9wdWxhdGVkIHRvIHJlZmxlY3QgdGhlIG5vcm1hbGl6ZWQgVVJMLiAgVGhpcyBhcHByb2FjaCBoYXMgd2lkZQogKiBjb21wYXRpYmlsaXR5IC0gU2FmYXJpIDErLCBNb3ppbGxhIDErLCBPcGVyYSA3KyxlIGV0Yy4gIFNlZQogKiBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICoKICogSW1wbGVtZW50YXRpb24gTm90ZXMgZm9yIElFCiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogKiBJRSA+PSA4IGFuZCA8PSAxMCBub3JtYWxpemVzIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byB0aGUgYW5jaG9yIG5vZGUgc2ltaWxhciB0byB0aGUgb3RoZXIKICogYnJvd3NlcnMuICBIb3dldmVyLCB0aGUgcGFyc2VkIGNvbXBvbmVudHMgd2lsbCBub3QgYmUgc2V0IGlmIHRoZSBVUkwgYXNzaWduZWQgZGlkIG5vdCBzcGVjaWZ5CiAqIHRoZW0uICAoZS5nLiBpZiB5b3UgYXNzaWduIGEuaHJlZiA9ICJmb28iLCB0aGVuIGEucHJvdG9jb2wsIGEuaG9zdCwgZXRjLiB3aWxsIGJlIGVtcHR5LikgIFdlCiAqIHdvcmsgYXJvdW5kIHRoYXQgYnkgcGVyZm9ybWluZyB0aGUgcGFyc2luZyBpbiBhIDJuZCBzdGVwIGJ5IHRha2luZyBhIHByZXZpb3VzbHkgbm9ybWFsaXplZAogKiBVUkwgKGUuZy4gYnkgYXNzaWduaW5nIHRvIGEuaHJlZikgYW5kIGFzc2lnbmluZyBpdCBhLmhyZWYgYWdhaW4uICBUaGlzIGNvcnJlY3RseSBwb3B1bGF0ZXMgdGhlCiAqIHByb3BlcnRpZXMgc3VjaCBhcyBwcm90b2NvbCwgaG9zdG5hbWUsIHBvcnQsIGV0Yy4KICoKICogSUU3IGRvZXMgbm90IG5vcm1hbGl6ZSB0aGUgVVJMIHdoZW4gYXNzaWduZWQgdG8gYW4gYW5jaG9yIG5vZGUuICAoQXBwYXJlbnRseSwgaXQgZG9lcywgaWYgb25lCiAqIHVzZXMgdGhlIGlubmVyIEhUTUwgYXBwcm9hY2ggdG8gYXNzaWduIHRoZSBVUkwgYXMgcGFydCBvZiBhbiBIVE1MIHNuaXBwZXQgLQogKiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS80NzI3MjkpICBIb3dldmVyLCBzZXR0aW5nIGltZ1tzcmNdIGRvZXMgbm9ybWFsaXplIHRoZSBVUkwuCiAqIFVuZm9ydHVuYXRlbHksIHNldHRpbmcgaW1nW3NyY10gdG8gc29tZXRoaW5nIGxpa2UgImphdmFzY3JpcHQ6Zm9vIiBvbiBJRSB0aHJvd3MgYW4gZXhjZXB0aW9uLgogKiBTaW5jZSB0aGUgcHJpbWFyeSB1c2FnZSBmb3Igbm9ybWFsaXppbmcgVVJMcyBpcyB0byBzYW5pdGl6ZSBzdWNoIFVSTHMsIHdlIGNhbid0IHVzZSB0aGF0CiAqIG1ldGhvZCBhbmQgSUUgPCA4IGlzIHVuc3VwcG9ydGVkLgogKgogKiBSZWZlcmVuY2VzOgogKiAgIGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0hUTUxBbmNob3JFbGVtZW50CiAqICAgaHR0cDovL3d3dy5hcHRhbmEuY29tL3JlZmVyZW5jZS9odG1sL2FwaS9IVE1MQW5jaG9yRWxlbWVudC5odG1sCiAqICAgaHR0cDovL3VybC5zcGVjLndoYXR3Zy5vcmcvI3VybHV0aWxzCiAqICAgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9wdWxsLzI5MDIKICogICBodHRwOi8vamFtZXMucGFkb2xzZXkuY29tL2phdmFzY3JpcHQvcGFyc2luZy11cmxzLXdpdGgtdGhlLWRvbS8KICoKICogQGtpbmQgZnVuY3Rpb24KICogQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgVVJMIHRvIGJlIHBhcnNlZC4KICogQGRlc2NyaXB0aW9uIE5vcm1hbGl6ZXMgYW5kIHBhcnNlcyBhIFVSTC4KICogQHJldHVybnMge29iamVjdH0gUmV0dXJucyB0aGUgbm9ybWFsaXplZCBVUkwgYXMgYSBkaWN0aW9uYXJ5LgogKgogKiAgIHwgbWVtYmVyIG5hbWUgICB8IERlc2NyaXB0aW9uICAgIHwKICogICB8LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS18CiAqICAgfCBocmVmICAgICAgICAgIHwgQSBub3JtYWxpemVkIHZlcnNpb24gb2YgdGhlIHByb3ZpZGVkIFVSTCBpZiBpdCB3YXMgbm90IGFuIGFic29sdXRlIFVSTCB8CiAqICAgfCBwcm90b2NvbCAgICAgIHwgVGhlIHByb3RvY29sIGluY2x1ZGluZyB0aGUgdHJhaWxpbmcgY29sb24gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqICAgfCBob3N0ICAgICAgICAgIHwgVGhlIGhvc3QgYW5kIHBvcnQgKGlmIHRoZSBwb3J0IGlzIG5vbi1kZWZhdWx0KSBvZiB0aGUgbm9ybWFsaXplZFVybCAgICB8CiAqICAgfCBzZWFyY2ggICAgICAgIHwgVGhlIHNlYXJjaCBwYXJhbXMsIG1pbnVzIHRoZSBxdWVzdGlvbiBtYXJrICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqICAgfCBoYXNoICAgICAgICAgIHwgVGhlIGhhc2ggc3RyaW5nLCBtaW51cyB0aGUgaGFzaCBzeW1ib2wKICogICB8IGhvc3RuYW1lICAgICAgfCBUaGUgaG9zdG5hbWUKICogICB8IHBvcnQgICAgICAgICAgfCBUaGUgcG9ydCwgd2l0aG91dCAiOiIKICogICB8IHBhdGhuYW1lICAgICAgfCBUaGUgcGF0aG5hbWUsIGJlZ2lubmluZyB3aXRoICIvIgogKgogKi8KZnVuY3Rpb24gdXJsUmVzb2x2ZSh1cmwsIGJhc2UpIHsKICB2YXIgaHJlZiA9IHVybDsKCiAgaWYgKG1zaWUpIHsKICAgIC8vIE5vcm1hbGl6ZSBiZWZvcmUgcGFyc2UuICBSZWZlciBJbXBsZW1lbnRhdGlvbiBOb3RlcyBvbiB3aHkgdGhpcyBpcwogICAgLy8gZG9uZSBpbiB0d28gc3RlcHMgb24gSUUuCiAgICB1cmxQYXJzaW5nTm9kZS5zZXRBdHRyaWJ1dGUoImhyZWYiLCBocmVmKTsKICAgIGhyZWYgPSB1cmxQYXJzaW5nTm9kZS5ocmVmOwogIH0KCiAgdXJsUGFyc2luZ05vZGUuc2V0QXR0cmlidXRlKCdocmVmJywgaHJlZik7CgogIC8vIHVybFBhcnNpbmdOb2RlIHByb3ZpZGVzIHRoZSBVcmxVdGlscyBpbnRlcmZhY2UgLSBodHRwOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jdXJsdXRpbHMKICByZXR1cm4gewogICAgaHJlZjogdXJsUGFyc2luZ05vZGUuaHJlZiwKICAgIHByb3RvY29sOiB1cmxQYXJzaW5nTm9kZS5wcm90b2NvbCA/IHVybFBhcnNpbmdOb2RlLnByb3RvY29sLnJlcGxhY2UoLzokLywgJycpIDogJycsCiAgICBob3N0OiB1cmxQYXJzaW5nTm9kZS5ob3N0LAogICAgc2VhcmNoOiB1cmxQYXJzaW5nTm9kZS5zZWFyY2ggPyB1cmxQYXJzaW5nTm9kZS5zZWFyY2gucmVwbGFjZSgvXlw/LywgJycpIDogJycsCiAgICBoYXNoOiB1cmxQYXJzaW5nTm9kZS5oYXNoID8gdXJsUGFyc2luZ05vZGUuaGFzaC5yZXBsYWNlKC9eIy8sICcnKSA6ICcnLAogICAgaG9zdG5hbWU6IHVybFBhcnNpbmdOb2RlLmhvc3RuYW1lLAogICAgcG9ydDogdXJsUGFyc2luZ05vZGUucG9ydCwKICAgIHBhdGhuYW1lOiAodXJsUGFyc2luZ05vZGUucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycpCiAgICAgID8gdXJsUGFyc2luZ05vZGUucGF0aG5hbWUKICAgICAgOiAnLycgKyB1cmxQYXJzaW5nTm9kZS5wYXRobmFtZQogIH07Cn0KCi8qKgogKiBQYXJzZSBhIHJlcXVlc3QgVVJMIGFuZCBkZXRlcm1pbmUgd2hldGhlciB0aGlzIGlzIGEgc2FtZS1vcmlnaW4gcmVxdWVzdCBhcyB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gcmVxdWVzdFVybCBUaGUgdXJsIG9mIHRoZSByZXF1ZXN0IGFzIGEgc3RyaW5nIHRoYXQgd2lsbCBiZSByZXNvbHZlZAogKiBvciBhIHBhcnNlZCBVUkwgb2JqZWN0LgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgcmVxdWVzdCBpcyBmb3IgdGhlIHNhbWUgb3JpZ2luIGFzIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudC4KICovCmZ1bmN0aW9uIHVybElzU2FtZU9yaWdpbihyZXF1ZXN0VXJsKSB7CiAgdmFyIHBhcnNlZCA9IChpc1N0cmluZyhyZXF1ZXN0VXJsKSkgPyB1cmxSZXNvbHZlKHJlcXVlc3RVcmwpIDogcmVxdWVzdFVybDsKICByZXR1cm4gKHBhcnNlZC5wcm90b2NvbCA9PT0gb3JpZ2luVXJsLnByb3RvY29sICYmCiAgICAgICAgICBwYXJzZWQuaG9zdCA9PT0gb3JpZ2luVXJsLmhvc3QpOwp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHdpbmRvdwogKgogKiBAZGVzY3JpcHRpb24KICogQSByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93YCBvYmplY3QuIFdoaWxlIGB3aW5kb3dgCiAqIGlzIGdsb2JhbGx5IGF2YWlsYWJsZSBpbiBKYXZhU2NyaXB0LCBpdCBjYXVzZXMgdGVzdGFiaWxpdHkgcHJvYmxlbXMsIGJlY2F1c2UKICogaXQgaXMgYSBnbG9iYWwgdmFyaWFibGUuIEluIGFuZ3VsYXIgd2UgYWx3YXlzIHJlZmVyIHRvIGl0IHRocm91Z2ggdGhlCiAqIGAkd2luZG93YCBzZXJ2aWNlLCBzbyBpdCBtYXkgYmUgb3ZlcnJpZGRlbiwgcmVtb3ZlZCBvciBtb2NrZWQgZm9yIHRlc3RpbmcuCiAqCiAqIEV4cHJlc3Npb25zLCBsaWtlIHRoZSBvbmUgZGVmaW5lZCBmb3IgdGhlIGBuZ0NsaWNrYCBkaXJlY3RpdmUgaW4gdGhlIGV4YW1wbGUKICogYmVsb3csIGFyZSBldmFsdWF0ZWQgd2l0aCByZXNwZWN0IHRvIHRoZSBjdXJyZW50IHNjb3BlLiAgVGhlcmVmb3JlLCB0aGVyZSBpcwogKiBubyByaXNrIG9mIGluYWR2ZXJ0ZW50bHkgY29kaW5nIGluIGEgZGVwZW5kZW5jeSBvbiBhIGdsb2JhbCB2YWx1ZSBpbiBzdWNoIGFuCiAqIGV4cHJlc3Npb24uCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUsICR3aW5kb3cpIHsKICAgICAgICAgICAkc2NvcGUuZ3JlZXRpbmcgPSAnSGVsbG8sIFdvcmxkISc7CiAgICAgICAgICAgJHNjb3BlLmRvR3JlZXRpbmcgPSBmdW5jdGlvbihncmVldGluZykgewogICAgICAgICAgICAgICAkd2luZG93LmFsZXJ0KGdyZWV0aW5nKTsKICAgICAgICAgICB9OwogICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iZ3JlZXRpbmciIC8+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9ImRvR3JlZXRpbmcoZ3JlZXRpbmcpIj5BTEVSVDwvYnV0dG9uPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICBpdCgnc2hvdWxkIGRpc3BsYXkgdGhlIGdyZWV0aW5nIGluIHRoZSBpbnB1dCBib3gnLCBmdW5jdGlvbigpIHsKICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2dyZWV0aW5nJykpLnNlbmRLZXlzKCdIZWxsbywgRTJFIFRlc3RzJyk7CiAgICAgICAvLyBJZiB3ZSBjbGljayB0aGUgYnV0dG9uIGl0IHdpbGwgYmxvY2sgdGhlIHRlc3QgcnVubmVyCiAgICAgICAvLyBlbGVtZW50KCc6YnV0dG9uJykuY2xpY2soKTsKICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiAkV2luZG93UHJvdmlkZXIoKXsKICB0aGlzLiRnZXQgPSB2YWx1ZUZuKHdpbmRvdyk7Cn0KCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGZpbHRlclByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBGaWx0ZXJzIGFyZSBqdXN0IGZ1bmN0aW9ucyB3aGljaCB0cmFuc2Zvcm0gaW5wdXQgdG8gYW4gb3V0cHV0LiBIb3dldmVyIGZpbHRlcnMgbmVlZCB0byBiZQogKiBEZXBlbmRlbmN5IEluamVjdGVkLiBUbyBhY2hpZXZlIHRoaXMgYSBmaWx0ZXIgZGVmaW5pdGlvbiBjb25zaXN0cyBvZiBhIGZhY3RvcnkgZnVuY3Rpb24gd2hpY2ggaXMKICogYW5ub3RhdGVkIHdpdGggZGVwZW5kZW5jaWVzIGFuZCBpcyByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgYSBmaWx0ZXIgZnVuY3Rpb24uCiAqCiAqIGBgYGpzCiAqICAgLy8gRmlsdGVyIHJlZ2lzdHJhdGlvbgogKiAgIGZ1bmN0aW9uIE15TW9kdWxlKCRwcm92aWRlLCAkZmlsdGVyUHJvdmlkZXIpIHsKICogICAgIC8vIGNyZWF0ZSBhIHNlcnZpY2UgdG8gZGVtb25zdHJhdGUgaW5qZWN0aW9uIChub3QgYWx3YXlzIG5lZWRlZCkKICogICAgICRwcm92aWRlLnZhbHVlKCdncmVldCcsIGZ1bmN0aW9uKG5hbWUpewogKiAgICAgICByZXR1cm4gJ0hlbGxvICcgKyBuYW1lICsgJyEnOwogKiAgICAgfSk7CiAqCiAqICAgICAvLyByZWdpc3RlciBhIGZpbHRlciBmYWN0b3J5IHdoaWNoIHVzZXMgdGhlCiAqICAgICAvLyBncmVldCBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIERJLgogKiAgICAgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCdncmVldCcsIGZ1bmN0aW9uKGdyZWV0KXsKICogICAgICAgLy8gcmV0dXJuIHRoZSBmaWx0ZXIgZnVuY3Rpb24gd2hpY2ggdXNlcyB0aGUgZ3JlZXQgc2VydmljZQogKiAgICAgICAvLyB0byBnZW5lcmF0ZSBzYWx1dGF0aW9uCiAqICAgICAgIHJldHVybiBmdW5jdGlvbih0ZXh0KSB7CiAqICAgICAgICAgLy8gZmlsdGVycyBuZWVkIHRvIGJlIGZvcmdpdmluZyBzbyBjaGVjayBpbnB1dCB2YWxpZGl0eQogKiAgICAgICAgIHJldHVybiB0ZXh0ICYmIGdyZWV0KHRleHQpIHx8IHRleHQ7CiAqICAgICAgIH07CiAqICAgICB9KTsKICogICB9CiAqIGBgYAogKgogKiBUaGUgZmlsdGVyIGZ1bmN0aW9uIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUgYCRpbmplY3RvcmAgdW5kZXIgdGhlIGZpbHRlciBuYW1lIHN1ZmZpeCB3aXRoCiAqIGBGaWx0ZXJgLgogKgogKiBgYGBqcwogKiAgIGl0KCdzaG91bGQgYmUgdGhlIHNhbWUgaW5zdGFuY2UnLCBpbmplY3QoCiAqICAgICBmdW5jdGlvbigkZmlsdGVyUHJvdmlkZXIpIHsKICogICAgICAgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCdyZXZlcnNlJywgZnVuY3Rpb24oKXsKICogICAgICAgICByZXR1cm4gLi4uOwogKiAgICAgICB9KTsKICogICAgIH0sCiAqICAgICBmdW5jdGlvbigkZmlsdGVyLCByZXZlcnNlRmlsdGVyKSB7CiAqICAgICAgIGV4cGVjdCgkZmlsdGVyKCdyZXZlcnNlJykpLnRvQmUocmV2ZXJzZUZpbHRlcik7CiAqICAgICB9KTsKICogYGBgCiAqCiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGhvdyBhbmd1bGFyIGZpbHRlcnMgd29yaywgYW5kIGhvdyB0byBjcmVhdGUgeW91ciBvd24gZmlsdGVycywgc2VlCiAqIHtAbGluayBndWlkZS9maWx0ZXIgRmlsdGVyc30gaW4gdGhlIEFuZ3VsYXIgRGV2ZWxvcGVyIEd1aWRlLgogKi8KLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGZpbHRlclByb3ZpZGVyI3JlZ2lzdGVyCiAqIEBkZXNjcmlwdGlvbgogKiBSZWdpc3RlciBmaWx0ZXIgZmFjdG9yeSBmdW5jdGlvbi4KICoKICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24gd2hpY2ggaXMgaW5qZWN0YWJsZS4KICovCgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRmaWx0ZXIKICogQGtpbmQgZnVuY3Rpb24KICogQGRlc2NyaXB0aW9uCiAqIEZpbHRlcnMgYXJlIHVzZWQgZm9yIGZvcm1hdHRpbmcgZGF0YSBkaXNwbGF5ZWQgdG8gdGhlIHVzZXIuCiAqCiAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICoKICogICAgICAgICB7eyBleHByZXNzaW9uIFt8IGZpbHRlcl9uYW1lWzpwYXJhbWV0ZXJfdmFsdWVdIC4uLiBdIH19CiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZpbHRlciBmdW5jdGlvbiB0byByZXRyaWV2ZQogKiBAcmV0dXJuIHtGdW5jdGlvbn0gdGhlIGZpbHRlciBmdW5jdGlvbgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBuYW1lPSIkZmlsdGVyIiBtb2R1bGU9ImZpbHRlckV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ3RybCI+CiAgICAgICAgPGgzPnt7IG9yaWdpbmFsVGV4dCB9fTwvaDM+CiAgICAgICAgPGgzPnt7IGZpbHRlcmVkVGV4dCB9fTwvaDM+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdmaWx0ZXJFeGFtcGxlJywgW10pCiAgICAgIC5jb250cm9sbGVyKCdNYWluQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJGZpbHRlcikgewogICAgICAgICRzY29wZS5vcmlnaW5hbFRleHQgPSAnaGVsbG8nOwogICAgICAgICRzY29wZS5maWx0ZXJlZFRleHQgPSAkZmlsdGVyKCd1cHBlcmNhc2UnKSgkc2NvcGUub3JpZ2luYWxUZXh0KTsKICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgKi8KJEZpbHRlclByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJ107CmZ1bmN0aW9uICRGaWx0ZXJQcm92aWRlcigkcHJvdmlkZSkgewogIHZhciBzdWZmaXggPSAnRmlsdGVyJzsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyIGZ1bmN0aW9uLCBvciBhbiBvYmplY3QgbWFwIG9mIGZpbHRlcnMgd2hlcmUKICAgKiAgICB0aGUga2V5cyBhcmUgdGhlIGZpbHRlciBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGZpbHRlciBmYWN0b3JpZXMuCiAgICogQHJldHVybnMge09iamVjdH0gUmVnaXN0ZXJlZCBmaWx0ZXIgaW5zdGFuY2UsIG9yIGlmIGEgbWFwIG9mIGZpbHRlcnMgd2FzIHByb3ZpZGVkIHRoZW4gYSBtYXAKICAgKiAgICBvZiB0aGUgcmVnaXN0ZXJlZCBmaWx0ZXIgaW5zdGFuY2VzLgogICAqLwogIGZ1bmN0aW9uIHJlZ2lzdGVyKG5hbWUsIGZhY3RvcnkpIHsKICAgIGlmKGlzT2JqZWN0KG5hbWUpKSB7CiAgICAgIHZhciBmaWx0ZXJzID0ge307CiAgICAgIGZvckVhY2gobmFtZSwgZnVuY3Rpb24oZmlsdGVyLCBrZXkpIHsKICAgICAgICBmaWx0ZXJzW2tleV0gPSByZWdpc3RlcihrZXksIGZpbHRlcik7CiAgICAgIH0pOwogICAgICByZXR1cm4gZmlsdGVyczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBzdWZmaXgsIGZhY3RvcnkpOwogICAgfQogIH0KICB0aGlzLnJlZ2lzdGVyID0gcmVnaXN0ZXI7CgogIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICByZXR1cm4gZnVuY3Rpb24obmFtZSkgewogICAgICByZXR1cm4gJGluamVjdG9yLmdldChuYW1lICsgc3VmZml4KTsKICAgIH07CiAgfV07CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgLyogZ2xvYmFsCiAgICBjdXJyZW5jeUZpbHRlcjogZmFsc2UsCiAgICBkYXRlRmlsdGVyOiBmYWxzZSwKICAgIGZpbHRlckZpbHRlcjogZmFsc2UsCiAgICBqc29uRmlsdGVyOiBmYWxzZSwKICAgIGxpbWl0VG9GaWx0ZXI6IGZhbHNlLAogICAgbG93ZXJjYXNlRmlsdGVyOiBmYWxzZSwKICAgIG51bWJlckZpbHRlcjogZmFsc2UsCiAgICBvcmRlckJ5RmlsdGVyOiBmYWxzZSwKICAgIHVwcGVyY2FzZUZpbHRlcjogZmFsc2UsCiAgKi8KCiAgcmVnaXN0ZXIoJ2N1cnJlbmN5JywgY3VycmVuY3lGaWx0ZXIpOwogIHJlZ2lzdGVyKCdkYXRlJywgZGF0ZUZpbHRlcik7CiAgcmVnaXN0ZXIoJ2ZpbHRlcicsIGZpbHRlckZpbHRlcik7CiAgcmVnaXN0ZXIoJ2pzb24nLCBqc29uRmlsdGVyKTsKICByZWdpc3RlcignbGltaXRUbycsIGxpbWl0VG9GaWx0ZXIpOwogIHJlZ2lzdGVyKCdsb3dlcmNhc2UnLCBsb3dlcmNhc2VGaWx0ZXIpOwogIHJlZ2lzdGVyKCdudW1iZXInLCBudW1iZXJGaWx0ZXIpOwogIHJlZ2lzdGVyKCdvcmRlckJ5Jywgb3JkZXJCeUZpbHRlcik7CiAgcmVnaXN0ZXIoJ3VwcGVyY2FzZScsIHVwcGVyY2FzZUZpbHRlcik7Cn0KCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGZpbHRlcgogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogU2VsZWN0cyBhIHN1YnNldCBvZiBpdGVtcyBmcm9tIGBhcnJheWAgYW5kIHJldHVybnMgaXQgYXMgYSBuZXcgYXJyYXkuCiAqCiAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBzb3VyY2UgYXJyYXkuCiAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdHxmdW5jdGlvbigpfSBleHByZXNzaW9uIFRoZSBwcmVkaWNhdGUgdG8gYmUgdXNlZCBmb3Igc2VsZWN0aW5nIGl0ZW1zIGZyb20KICogICBgYXJyYXlgLgogKgogKiAgIENhbiBiZSBvbmUgb2Y6CiAqCiAqICAgLSBgc3RyaW5nYDogVGhlIHN0cmluZyBpcyBldmFsdWF0ZWQgYXMgYW4gZXhwcmVzc2lvbiBhbmQgdGhlIHJlc3VsdGluZyB2YWx1ZSBpcyB1c2VkIGZvciBzdWJzdHJpbmcgbWF0Y2ggYWdhaW5zdAogKiAgICAgdGhlIGNvbnRlbnRzIG9mIHRoZSBgYXJyYXlgLiBBbGwgc3RyaW5ncyBvciBvYmplY3RzIHdpdGggc3RyaW5nIHByb3BlcnRpZXMgaW4gYGFycmF5YCB0aGF0IGNvbnRhaW4gdGhpcyBzdHJpbmcKICogICAgIHdpbGwgYmUgcmV0dXJuZWQuIFRoZSBwcmVkaWNhdGUgY2FuIGJlIG5lZ2F0ZWQgYnkgcHJlZml4aW5nIHRoZSBzdHJpbmcgd2l0aCBgIWAuCiAqCiAqICAgLSBgT2JqZWN0YDogQSBwYXR0ZXJuIG9iamVjdCBjYW4gYmUgdXNlZCB0byBmaWx0ZXIgc3BlY2lmaWMgcHJvcGVydGllcyBvbiBvYmplY3RzIGNvbnRhaW5lZAogKiAgICAgYnkgYGFycmF5YC4gRm9yIGV4YW1wbGUgYHtuYW1lOiJNIiwgcGhvbmU6IjEifWAgcHJlZGljYXRlIHdpbGwgcmV0dXJuIGFuIGFycmF5IG9mIGl0ZW1zCiAqICAgICB3aGljaCBoYXZlIHByb3BlcnR5IGBuYW1lYCBjb250YWluaW5nICJNIiBhbmQgcHJvcGVydHkgYHBob25lYCBjb250YWluaW5nICIxIi4gQSBzcGVjaWFsCiAqICAgICBwcm9wZXJ0eSBuYW1lIGAkYCBjYW4gYmUgdXNlZCAoYXMgaW4gYHskOiJ0ZXh0In1gKSB0byBhY2NlcHQgYSBtYXRjaCBhZ2FpbnN0IGFueQogKiAgICAgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4gVGhhdCdzIGVxdWl2YWxlbnQgdG8gdGhlIHNpbXBsZSBzdWJzdHJpbmcgbWF0Y2ggd2l0aCBhIGBzdHJpbmdgCiAqICAgICBhcyBkZXNjcmliZWQgYWJvdmUuCiAqCiAqICAgLSBgZnVuY3Rpb24odmFsdWUpYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogKiAgICAgY2FsbGVkIGZvciBlYWNoIGVsZW1lbnQgb2YgYGFycmF5YC4gVGhlIGZpbmFsIHJlc3VsdCBpcyBhbiBhcnJheSBvZiB0aG9zZSBlbGVtZW50cyB0aGF0CiAqICAgICB0aGUgcHJlZGljYXRlIHJldHVybmVkIHRydWUgZm9yLgogKgogKiBAcGFyYW0ge2Z1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQpfHRydWV8dW5kZWZpbmVkfSBjb21wYXJhdG9yIENvbXBhcmF0b3Igd2hpY2ggaXMgdXNlZCBpbgogKiAgICAgZGV0ZXJtaW5pbmcgaWYgdGhlIGV4cGVjdGVkIHZhbHVlIChmcm9tIHRoZSBmaWx0ZXIgZXhwcmVzc2lvbikgYW5kIGFjdHVhbCB2YWx1ZSAoZnJvbQogKiAgICAgdGhlIG9iamVjdCBpbiB0aGUgYXJyYXkpIHNob3VsZCBiZSBjb25zaWRlcmVkIGEgbWF0Y2guCiAqCiAqICAgQ2FuIGJlIG9uZSBvZjoKICoKICogICAtIGBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkKWA6CiAqICAgICBUaGUgZnVuY3Rpb24gd2lsbCBiZSBnaXZlbiB0aGUgb2JqZWN0IHZhbHVlIGFuZCB0aGUgcHJlZGljYXRlIHZhbHVlIHRvIGNvbXBhcmUgYW5kCiAqICAgICBzaG91bGQgcmV0dXJuIHRydWUgaWYgdGhlIGl0ZW0gc2hvdWxkIGJlIGluY2x1ZGVkIGluIGZpbHRlcmVkIHJlc3VsdC4KICoKICogICAtIGB0cnVlYDogQSBzaG9ydGhhbmQgZm9yIGBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkKSB7IHJldHVybiBhbmd1bGFyLmVxdWFscyhleHBlY3RlZCwgYWN0dWFsKX1gLgogKiAgICAgdGhpcyBpcyBlc3NlbnRpYWxseSBzdHJpY3QgY29tcGFyaXNvbiBvZiBleHBlY3RlZCBhbmQgYWN0dWFsLgogKgogKiAgIC0gYGZhbHNlfHVuZGVmaW5lZGA6IEEgc2hvcnQgaGFuZCBmb3IgYSBmdW5jdGlvbiB3aGljaCB3aWxsIGxvb2sgZm9yIGEgc3Vic3RyaW5nIG1hdGNoIGluIGNhc2UKICogICAgIGluc2Vuc2l0aXZlIHdheS4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IG5nLWluaXQ9ImZyaWVuZHMgPSBbe25hbWU6J0pvaG4nLCBwaG9uZTonNTU1LTEyNzYnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonTWFyeScsIHBob25lOic4MDAtQklHLU1BUlknfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidBZGFtJywgcGhvbmU6JzU1NS01Njc4J30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1J30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J0p1bGlldHRlJywgcGhvbmU6JzU1NS01Njc4J31dIj48L2Rpdj4KCiAgICAgICBTZWFyY2g6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoVGV4dCI+CiAgICAgICA8dGFibGUgaWQ9InNlYXJjaFRleHRSZXN1bHRzIj4KICAgICAgICAgPHRyPjx0aD5OYW1lPC90aD48dGg+UGhvbmU8L3RoPjwvdHI+CiAgICAgICAgIDx0ciBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIHwgZmlsdGVyOnNlYXJjaFRleHQiPgogICAgICAgICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgPC90cj4KICAgICAgIDwvdGFibGU+CiAgICAgICA8aHI+CiAgICAgICBBbnk6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLiQiPiA8YnI+CiAgICAgICBOYW1lIG9ubHkgPGlucHV0IG5nLW1vZGVsPSJzZWFyY2gubmFtZSI+PGJyPgogICAgICAgUGhvbmUgb25seSA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC5waG9uZSI+PGJyPgogICAgICAgRXF1YWxpdHkgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic3RyaWN0Ij48YnI+CiAgICAgICA8dGFibGUgaWQ9InNlYXJjaE9ialJlc3VsdHMiPgogICAgICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kT2JqIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoOnN0cmljdCI+CiAgICAgICAgICAgPHRkPnt7ZnJpZW5kT2JqLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgPHRkPnt7ZnJpZW5kT2JqLnBob25lfX08L3RkPgogICAgICAgICA8L3RyPgogICAgICAgPC90YWJsZT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICB2YXIgZXhwZWN0RnJpZW5kTmFtZXMgPSBmdW5jdGlvbihleHBlY3RlZE5hbWVzLCBrZXkpIHsKICAgICAgICAgZWxlbWVudC5hbGwoYnkucmVwZWF0ZXIoa2V5ICsgJyBpbiBmcmllbmRzJykuY29sdW1uKGtleSArICcubmFtZScpKS50aGVuKGZ1bmN0aW9uKGFycikgewogICAgICAgICAgIGFyci5mb3JFYWNoKGZ1bmN0aW9uKHdkLCBpKSB7CiAgICAgICAgICAgICBleHBlY3Qod2QuZ2V0VGV4dCgpKS50b01hdGNoKGV4cGVjdGVkTmFtZXNbaV0pOwogICAgICAgICAgIH0pOwogICAgICAgICB9KTsKICAgICAgIH07CgogICAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgc2VhcmNoVGV4dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlYXJjaFRleHQnKSk7CiAgICAgICAgIHNlYXJjaFRleHQuY2xlYXIoKTsKICAgICAgICAgc2VhcmNoVGV4dC5zZW5kS2V5cygnbScpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ01hcnknLCAnTWlrZScsICdBZGFtJ10sICdmcmllbmQnKTsKCiAgICAgICAgIHNlYXJjaFRleHQuY2xlYXIoKTsKICAgICAgICAgc2VhcmNoVGV4dC5zZW5kS2V5cygnNzYnKTsKICAgICAgICAgZXhwZWN0RnJpZW5kTmFtZXMoWydKb2huJywgJ0p1bGllJ10sICdmcmllbmQnKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgc2VhcmNoIGluIHNwZWNpZmljIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgcHJlZGljYXRlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgc2VhcmNoQW55ID0gZWxlbWVudChieS5tb2RlbCgnc2VhcmNoLiQnKSk7CiAgICAgICAgIHNlYXJjaEFueS5jbGVhcigpOwogICAgICAgICBzZWFyY2hBbnkuc2VuZEtleXMoJ2knKTsKICAgICAgICAgZXhwZWN0RnJpZW5kTmFtZXMoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnLCAnSnVsaWV0dGUnXSwgJ2ZyaWVuZE9iaicpOwogICAgICAgfSk7CiAgICAgICBpdCgnc2hvdWxkIHVzZSBhIGVxdWFsIGNvbXBhcmlzb24gd2hlbiBjb21wYXJhdG9yIGlzIHRydWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIHNlYXJjaE5hbWUgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzZWFyY2gubmFtZScpKTsKICAgICAgICAgdmFyIHN0cmljdCA9IGVsZW1lbnQoYnkubW9kZWwoJ3N0cmljdCcpKTsKICAgICAgICAgc2VhcmNoTmFtZS5jbGVhcigpOwogICAgICAgICBzZWFyY2hOYW1lLnNlbmRLZXlzKCdKdWxpZScpOwogICAgICAgICBzdHJpY3QuY2xpY2soKTsKICAgICAgICAgZXhwZWN0RnJpZW5kTmFtZXMoWydKdWxpZSddLCAnZnJpZW5kT2JqJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uIGZpbHRlckZpbHRlcigpIHsKICByZXR1cm4gZnVuY3Rpb24oYXJyYXksIGV4cHJlc3Npb24sIGNvbXBhcmF0b3IpIHsKICAgIGlmICghaXNBcnJheShhcnJheSkpIHJldHVybiBhcnJheTsKCiAgICB2YXIgY29tcGFyYXRvclR5cGUgPSB0eXBlb2YoY29tcGFyYXRvciksCiAgICAgICAgcHJlZGljYXRlcyA9IFtdOwoKICAgIHByZWRpY2F0ZXMuY2hlY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBpZighcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIGlmIChjb21wYXJhdG9yVHlwZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICBpZiAoY29tcGFyYXRvclR5cGUgPT09ICdib29sZWFuJyAmJiBjb21wYXJhdG9yKSB7CiAgICAgICAgY29tcGFyYXRvciA9IGZ1bmN0aW9uKG9iaiwgdGV4dCkgewogICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKG9iaiwgdGV4dCk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb21wYXJhdG9yID0gZnVuY3Rpb24ob2JqLCB0ZXh0KSB7CiAgICAgICAgICBpZiAob2JqICYmIHRleHQgJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHRleHQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIGZvciAodmFyIG9iaktleSBpbiBvYmopIHsKICAgICAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBvYmpLZXkpICYmCiAgICAgICAgICAgICAgICAgIGNvbXBhcmF0b3Iob2JqW29iaktleV0sIHRleHRbb2JqS2V5XSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB0ZXh0ID0gKCcnK3RleHQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gKCcnK29iaikudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgfTsKICAgICAgfQogICAgfQoKICAgIHZhciBzZWFyY2ggPSBmdW5jdGlvbihvYmosIHRleHQpewogICAgICBpZiAodHlwZW9mIHRleHQgPT0gJ3N0cmluZycgJiYgdGV4dC5jaGFyQXQoMCkgPT09ICchJykgewogICAgICAgIHJldHVybiAhc2VhcmNoKG9iaiwgdGV4dC5zdWJzdHIoMSkpOwogICAgICB9CiAgICAgIHN3aXRjaCAodHlwZW9mIG9iaikgewogICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgIHJldHVybiBjb21wYXJhdG9yKG9iaiwgdGV4dCk7CiAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHRleHQpIHsKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICByZXR1cm4gY29tcGFyYXRvcihvYmosIHRleHQpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGZvciAoIHZhciBvYmpLZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIHNlYXJjaChvYmpbb2JqS2V5XSwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGNhc2UgImFycmF5IjoKICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IG9iai5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoc2VhcmNoKG9ialtpXSwgdGV4dCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH07CiAgICBzd2l0Y2ggKHR5cGVvZiBleHByZXNzaW9uKSB7CiAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICBjYXNlICJudW1iZXIiOgogICAgICBjYXNlICJzdHJpbmciOgogICAgICAgIC8vIFNldCB1cCBleHByZXNzaW9uIG9iamVjdCBhbmQgZmFsbCB0aHJvdWdoCiAgICAgICAgZXhwcmVzc2lvbiA9IHskOmV4cHJlc3Npb259OwogICAgICAgIC8vIGpzaGludCAtVzA4NgogICAgICBjYXNlICJvYmplY3QiOgogICAgICAgIC8vIGpzaGludCArVzA4NgogICAgICAgIGZvciAodmFyIGtleSBpbiBleHByZXNzaW9uKSB7CiAgICAgICAgICAoZnVuY3Rpb24ocGF0aCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGV4cHJlc3Npb25bcGF0aF0gPT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChwYXRoID09ICckJyA/IHZhbHVlIDogKHZhbHVlICYmIHZhbHVlW3BhdGhdKSwgZXhwcmVzc2lvbltwYXRoXSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkoa2V5KTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICBwcmVkaWNhdGVzLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgfQogICAgdmFyIGZpbHRlcmVkID0gW107CiAgICBmb3IgKCB2YXIgaiA9IDA7IGogPCBhcnJheS5sZW5ndGg7IGorKykgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtqXTsKICAgICAgaWYgKHByZWRpY2F0ZXMuY2hlY2sodmFsdWUpKSB7CiAgICAgICAgZmlsdGVyZWQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmaWx0ZXJlZDsKICB9Owp9CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBjdXJyZW5jeQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRm9ybWF0cyBhIG51bWJlciBhcyBhIGN1cnJlbmN5IChpZSAkMSwyMzQuNTYpLiBXaGVuIG5vIGN1cnJlbmN5IHN5bWJvbCBpcyBwcm92aWRlZCwgZGVmYXVsdAogKiBzeW1ib2wgZm9yIGN1cnJlbnQgbG9jYWxlIGlzIHVzZWQuCiAqCiAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgSW5wdXQgdG8gZmlsdGVyLgogKiBAcGFyYW0ge3N0cmluZz19IHN5bWJvbCBDdXJyZW5jeSBzeW1ib2wgb3IgaWRlbnRpZmllciB0byBiZSBkaXNwbGF5ZWQuCiAqIEByZXR1cm5zIHtzdHJpbmd9IEZvcm1hdHRlZCBudW1iZXIuCiAqCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUuYW1vdW50ID0gMTIzNC41NjsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBuZy1tb2RlbD0iYW1vdW50Ij4gPGJyPgogICAgICAgICBkZWZhdWx0IGN1cnJlbmN5IHN5bWJvbCAoJCk6IDxzcGFuIGlkPSJjdXJyZW5jeS1kZWZhdWx0Ij57e2Ftb3VudCB8IGN1cnJlbmN5fX08L3NwYW4+PGJyPgogICAgICAgICBjdXN0b20gY3VycmVuY3kgaWRlbnRpZmllciAoVVNEJCk6IDxzcGFuPnt7YW1vdW50IHwgY3VycmVuY3k6IlVTRCQifX08L3NwYW4+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGluaXQgd2l0aCAxMjM0LjU2JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjdXJyZW5jeS1kZWZhdWx0JykpLmdldFRleHQoKSkudG9CZSgnJDEsMjM0LjU2Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS5nZXRUZXh0KCkpLnRvQmUoJ1VTRCQxLDIzNC41NicpOwogICAgICAgfSk7CiAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnc2FmYXJpJykgewogICAgICAgICAgIC8vIFNhZmFyaSBkb2VzIG5vdCB1bmRlcnN0YW5kIHRoZSBtaW51cyBrZXkuIFNlZQogICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3Byb3RyYWN0b3IvaXNzdWVzLzQ4MQogICAgICAgICAgIHJldHVybjsKICAgICAgICAgfQogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdhbW91bnQnKSkuY2xlYXIoKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnYW1vdW50JykpLnNlbmRLZXlzKCctMTIzNCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY3VycmVuY3ktZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJygkMSwyMzQuMDApJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS5nZXRUZXh0KCkpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmN1cnJlbmN5RmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKZnVuY3Rpb24gY3VycmVuY3lGaWx0ZXIoJGxvY2FsZSkgewogIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICByZXR1cm4gZnVuY3Rpb24oYW1vdW50LCBjdXJyZW5jeVN5bWJvbCl7CiAgICBpZiAoaXNVbmRlZmluZWQoY3VycmVuY3lTeW1ib2wpKSBjdXJyZW5jeVN5bWJvbCA9IGZvcm1hdHMuQ1VSUkVOQ1lfU1lNOwogICAgcmV0dXJuIGZvcm1hdE51bWJlcihhbW91bnQsIGZvcm1hdHMuUEFUVEVSTlNbMV0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLCAyKS4KICAgICAgICAgICAgICAgIHJlcGxhY2UoL1x1MDBBNC9nLCBjdXJyZW5jeVN5bWJvbCk7CiAgfTsKfQoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgbnVtYmVyCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGb3JtYXRzIGEgbnVtYmVyIGFzIHRleHQuCiAqCiAqIElmIHRoZSBpbnB1dCBpcyBub3QgYSBudW1iZXIgYW4gZW1wdHkgc3RyaW5nIGlzIHJldHVybmVkLgogKgogKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IG51bWJlciBOdW1iZXIgdG8gZm9ybWF0LgogKiBAcGFyYW0geyhudW1iZXJ8c3RyaW5nKT19IGZyYWN0aW9uU2l6ZSBOdW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMgdG8gcm91bmQgdGhlIG51bWJlciB0by4KICogSWYgdGhpcyBpcyBub3QgcHJvdmlkZWQgdGhlbiB0aGUgZnJhY3Rpb24gc2l6ZSBpcyBjb21wdXRlZCBmcm9tIHRoZSBjdXJyZW50IGxvY2FsZSdzIG51bWJlcgogKiBmb3JtYXR0aW5nIHBhdHRlcm4uIEluIHRoZSBjYXNlIG9mIHRoZSBkZWZhdWx0IGxvY2FsZSwgaXQgd2lsbCBiZSAzLgogKiBAcmV0dXJucyB7c3RyaW5nfSBOdW1iZXIgcm91bmRlZCB0byBkZWNpbWFsUGxhY2VzIGFuZCBwbGFjZXMgYSDigJws4oCdIGFmdGVyIGVhY2ggdGhpcmQgZGlnaXQuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudmFsID0gMTIzNC41Njc4OTsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBFbnRlciBudW1iZXI6IDxpbnB1dCBuZy1tb2RlbD0ndmFsJz48YnI+CiAgICAgICAgIERlZmF1bHQgZm9ybWF0dGluZzogPHNwYW4gaWQ9J251bWJlci1kZWZhdWx0Jz57e3ZhbCB8IG51bWJlcn19PC9zcGFuPjxicj4KICAgICAgICAgTm8gZnJhY3Rpb25zOiA8c3Bhbj57e3ZhbCB8IG51bWJlcjowfX08L3NwYW4+PGJyPgogICAgICAgICBOZWdhdGl2ZSBudW1iZXI6IDxzcGFuPnt7LXZhbCB8IG51bWJlcjo0fX08L3NwYW4+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBudW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdudW1iZXItZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJzEsMjM0LjU2OCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS5nZXRUZXh0KCkpLnRvQmUoJzEsMjM1Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS5nZXRUZXh0KCkpLnRvQmUoJy0xLDIzNC41Njc5Jyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWwnKSkuY2xlYXIoKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsJykpLnNlbmRLZXlzKCczMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbnVtYmVyLWRlZmF1bHQnKSkuZ2V0VGV4dCgpKS50b0JlKCczLDM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkuZ2V0VGV4dCgpKS50b0JlKCczLDM3NCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkuZ2V0VGV4dCgpKS50b0JlKCctMywzNzQuMzMzMCcpOwogICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKbnVtYmVyRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKZnVuY3Rpb24gbnVtYmVyRmlsdGVyKCRsb2NhbGUpIHsKICB2YXIgZm9ybWF0cyA9ICRsb2NhbGUuTlVNQkVSX0ZPUk1BVFM7CiAgcmV0dXJuIGZ1bmN0aW9uKG51bWJlciwgZnJhY3Rpb25TaXplKSB7CiAgICByZXR1cm4gZm9ybWF0TnVtYmVyKG51bWJlciwgZm9ybWF0cy5QQVRURVJOU1swXSwgZm9ybWF0cy5HUk9VUF9TRVAsIGZvcm1hdHMuREVDSU1BTF9TRVAsCiAgICAgIGZyYWN0aW9uU2l6ZSk7CiAgfTsKfQoKdmFyIERFQ0lNQUxfU0VQID0gJy4nOwpmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgaWYgKG51bWJlciA9PSBudWxsIHx8ICFpc0Zpbml0ZShudW1iZXIpIHx8IGlzT2JqZWN0KG51bWJlcikpIHJldHVybiAnJzsKCiAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgcGFydHMgPSBbXTsKCiAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICB2YXIgbWF0Y2ggPSBudW1TdHIubWF0Y2goLyhbXGRcLl0rKWUoLT8pKFxkKykvKTsKICAgIGlmIChtYXRjaCAmJiBtYXRjaFsyXSA9PSAnLScgJiYgbWF0Y2hbM10gPiBmcmFjdGlvblNpemUgKyAxKSB7CiAgICAgIG51bVN0ciA9ICcwJzsKICAgIH0gZWxzZSB7CiAgICAgIGZvcm1hdGVkVGV4dCA9IG51bVN0cjsKICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgfQogIH0KCiAgaWYgKCFoYXNFeHBvbmVudCkgewogICAgdmFyIGZyYWN0aW9uTGVuID0gKG51bVN0ci5zcGxpdChERUNJTUFMX1NFUClbMV0gfHwgJycpLmxlbmd0aDsKCiAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgIGlmIChpc1VuZGVmaW5lZChmcmFjdGlvblNpemUpKSB7CiAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgfQoKICAgIHZhciBwb3cgPSBNYXRoLnBvdygxMCwgZnJhY3Rpb25TaXplICsgMSk7CiAgICBudW1iZXIgPSBNYXRoLmZsb29yKG51bWJlciAqIHBvdyArIDUpIC8gcG93OwogICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICB2YXIgd2hvbGUgPSBmcmFjdGlvblswXTsKICAgIGZyYWN0aW9uID0gZnJhY3Rpb25bMV0gfHwgJyc7CgogICAgdmFyIGksIHBvcyA9IDAsCiAgICAgICAgbGdyb3VwID0gcGF0dGVybi5sZ1NpemUsCiAgICAgICAgZ3JvdXAgPSBwYXR0ZXJuLmdTaXplOwoKICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICBwb3MgPSB3aG9sZS5sZW5ndGggLSBsZ3JvdXA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgIGlmICgocG9zIC0gaSklZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IGdyb3VwU2VwOwogICAgICAgIH0KICAgICAgICBmb3JtYXRlZFRleHQgKz0gd2hvbGUuY2hhckF0KGkpOwogICAgICB9CiAgICB9CgogICAgZm9yIChpID0gcG9zOyBpIDwgd2hvbGUubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCh3aG9sZS5sZW5ndGggLSBpKSVsZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgfQogICAgICBmb3JtYXRlZFRleHQgKz0gd2hvbGUuY2hhckF0KGkpOwogICAgfQoKICAgIC8vIGZvcm1hdCBmcmFjdGlvbiBwYXJ0LgogICAgd2hpbGUoZnJhY3Rpb24ubGVuZ3RoIDwgZnJhY3Rpb25TaXplKSB7CiAgICAgIGZyYWN0aW9uICs9ICcwJzsKICAgIH0KCiAgICBpZiAoZnJhY3Rpb25TaXplICYmIGZyYWN0aW9uU2l6ZSAhPT0gIjAiKSBmb3JtYXRlZFRleHQgKz0gZGVjaW1hbFNlcCArIGZyYWN0aW9uLnN1YnN0cigwLCBmcmFjdGlvblNpemUpOwogIH0gZWxzZSB7CgogICAgaWYgKGZyYWN0aW9uU2l6ZSA+IDAgJiYgbnVtYmVyID4gLTEgJiYgbnVtYmVyIDwgMSkgewogICAgICBmb3JtYXRlZFRleHQgPSBudW1iZXIudG9GaXhlZChmcmFjdGlvblNpemUpOwogICAgfQogIH0KCiAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdQcmUgOiBwYXR0ZXJuLnBvc1ByZSk7CiAgcGFydHMucHVzaChmb3JtYXRlZFRleHQpOwogIHBhcnRzLnB1c2goaXNOZWdhdGl2ZSA/IHBhdHRlcm4ubmVnU3VmIDogcGF0dGVybi5wb3NTdWYpOwogIHJldHVybiBwYXJ0cy5qb2luKCcnKTsKfQoKZnVuY3Rpb24gcGFkTnVtYmVyKG51bSwgZGlnaXRzLCB0cmltKSB7CiAgdmFyIG5lZyA9ICcnOwogIGlmIChudW0gPCAwKSB7CiAgICBuZWcgPSAgJy0nOwogICAgbnVtID0gLW51bTsKICB9CiAgbnVtID0gJycgKyBudW07CiAgd2hpbGUobnVtLmxlbmd0aCA8IGRpZ2l0cykgbnVtID0gJzAnICsgbnVtOwogIGlmICh0cmltKQogICAgbnVtID0gbnVtLnN1YnN0cihudW0ubGVuZ3RoIC0gZGlnaXRzKTsKICByZXR1cm4gbmVnICsgbnVtOwp9CgoKZnVuY3Rpb24gZGF0ZUdldHRlcihuYW1lLCBzaXplLCBvZmZzZXQsIHRyaW0pIHsKICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICByZXR1cm4gZnVuY3Rpb24oZGF0ZSkgewogICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICBpZiAob2Zmc2V0ID4gMCB8fCB2YWx1ZSA+IC1vZmZzZXQpCiAgICAgIHZhbHVlICs9IG9mZnNldDsKICAgIGlmICh2YWx1ZSA9PT0gMCAmJiBvZmZzZXQgPT0gLTEyICkgdmFsdWUgPSAxMjsKICAgIHJldHVybiBwYWROdW1iZXIodmFsdWUsIHNpemUsIHRyaW0pOwogIH07Cn0KCmZ1bmN0aW9uIGRhdGVTdHJHZXR0ZXIobmFtZSwgc2hvcnRGb3JtKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUsIGZvcm1hdHMpIHsKICAgIHZhciB2YWx1ZSA9IGRhdGVbJ2dldCcgKyBuYW1lXSgpOwogICAgdmFyIGdldCA9IHVwcGVyY2FzZShzaG9ydEZvcm0gPyAoJ1NIT1JUJyArIG5hbWUpIDogbmFtZSk7CgogICAgcmV0dXJuIGZvcm1hdHNbZ2V0XVt2YWx1ZV07CiAgfTsKfQoKZnVuY3Rpb24gdGltZVpvbmVHZXR0ZXIoZGF0ZSkgewogIHZhciB6b25lID0gLTEgKiBkYXRlLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgdmFyIHBhZGRlZFpvbmUgPSAoem9uZSA+PSAwKSA/ICIrIiA6ICIiOwoKICBwYWRkZWRab25lICs9IHBhZE51bWJlcihNYXRoW3pvbmUgPiAwID8gJ2Zsb29yJyA6ICdjZWlsJ10oem9uZSAvIDYwKSwgMikgKwogICAgICAgICAgICAgICAgcGFkTnVtYmVyKE1hdGguYWJzKHpvbmUgJSA2MCksIDIpOwoKICByZXR1cm4gcGFkZGVkWm9uZTsKfQoKZnVuY3Rpb24gYW1wbUdldHRlcihkYXRlLCBmb3JtYXRzKSB7CiAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA8IDEyID8gZm9ybWF0cy5BTVBNU1swXSA6IGZvcm1hdHMuQU1QTVNbMV07Cn0KCnZhciBEQVRFX0ZPUk1BVFMgPSB7CiAgeXl5eTogZGF0ZUdldHRlcignRnVsbFllYXInLCA0KSwKICAgIHl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDIsIDAsIHRydWUpLAogICAgIHk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMSksCiAgTU1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnKSwKICAgTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcsIHRydWUpLAogICAgTU06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMiwgMSksCiAgICAgTTogZGF0ZUdldHRlcignTW9udGgnLCAxLCAxKSwKICAgIGRkOiBkYXRlR2V0dGVyKCdEYXRlJywgMiksCiAgICAgZDogZGF0ZUdldHRlcignRGF0ZScsIDEpLAogICAgSEg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiksCiAgICAgSDogZGF0ZUdldHRlcignSG91cnMnLCAxKSwKICAgIGhoOiBkYXRlR2V0dGVyKCdIb3VycycsIDIsIC0xMiksCiAgICAgaDogZGF0ZUdldHRlcignSG91cnMnLCAxLCAtMTIpLAogICAgbW06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAyKSwKICAgICBtOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMSksCiAgICBzczogZGF0ZUdldHRlcignU2Vjb25kcycsIDIpLAogICAgIHM6IGRhdGVHZXR0ZXIoJ1NlY29uZHMnLCAxKSwKICAgICAvLyB3aGlsZSBJU08gODYwMSByZXF1aXJlcyBmcmFjdGlvbnMgdG8gYmUgcHJlZml4ZWQgd2l0aCBgLmAgb3IgYCxgCiAgICAgLy8gd2UgY2FuIGJlIGp1c3Qgc2FmZWx5IHJlbHkgb24gdXNpbmcgYHNzc2Agc2luY2Ugd2UgY3VycmVudGx5IGRvbid0IHN1cHBvcnQgc2luZ2xlIG9yIHR3byBkaWdpdCBmcmFjdGlvbnMKICAgc3NzOiBkYXRlR2V0dGVyKCdNaWxsaXNlY29uZHMnLCAzKSwKICBFRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknKSwKICAgRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknLCB0cnVlKSwKICAgICBhOiBhbXBtR2V0dGVyLAogICAgIFo6IHRpbWVab25lR2V0dGVyCn07Cgp2YXIgREFURV9GT1JNQVRTX1NQTElUID0gLygoPzpbXnlNZEhobXNhWkUnXSspfCg/OicoPzpbXiddfCcnKSonKXwoPzpFK3x5K3xNK3xkK3xIK3xoK3xtK3xzK3xhfFopKSguKikvLAogICAgTlVNQkVSX1NUUklORyA9IC9eXC0/XGQrJC87CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBkYXRlCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAgIEZvcm1hdHMgYGRhdGVgIHRvIGEgc3RyaW5nIGJhc2VkIG9uIHRoZSByZXF1ZXN0ZWQgYGZvcm1hdGAuCiAqCiAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBiZSBjb21wb3NlZCBvZiB0aGUgZm9sbG93aW5nIGVsZW1lbnRzOgogKgogKiAgICogYCd5eXl5J2A6IDQgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciAoZS5nLiBBRCAxID0+IDAwMDEsIEFEIDIwMTAgPT4gMjAxMCkKICogICAqIGAneXknYDogMiBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBwYWRkZWQgKDAwLTk5KS4gKGUuZy4gQUQgMjAwMSA9PiAwMSwgQUQgMjAxMCA9PiAxMCkKICogICAqIGAneSdgOiAxIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIGUuZy4gKEFEIDEgPT4gMSwgQUQgMTk5ID0+IDE5OSkKICogICAqIGAnTU1NTSdgOiBNb250aCBpbiB5ZWFyIChKYW51YXJ5LURlY2VtYmVyKQogKiAgICogYCdNTU0nYDogTW9udGggaW4geWVhciAoSmFuLURlYykKICogICAqIGAnTU0nYDogTW9udGggaW4geWVhciwgcGFkZGVkICgwMS0xMikKICogICAqIGAnTSdgOiBNb250aCBpbiB5ZWFyICgxLTEyKQogKiAgICogYCdkZCdgOiBEYXkgaW4gbW9udGgsIHBhZGRlZCAoMDEtMzEpCiAqICAgKiBgJ2QnYDogRGF5IGluIG1vbnRoICgxLTMxKQogKiAgICogYCdFRUVFJ2A6IERheSBpbiBXZWVrLChTdW5kYXktU2F0dXJkYXkpCiAqICAgKiBgJ0VFRSdgOiBEYXkgaW4gV2VlaywgKFN1bi1TYXQpCiAqICAgKiBgJ0hIJ2A6IEhvdXIgaW4gZGF5LCBwYWRkZWQgKDAwLTIzKQogKiAgICogYCdIJ2A6IEhvdXIgaW4gZGF5ICgwLTIzKQogKiAgICogYCdoaCdgOiBIb3VyIGluIGFtL3BtLCBwYWRkZWQgKDAxLTEyKQogKiAgICogYCdoJ2A6IEhvdXIgaW4gYW0vcG0sICgxLTEyKQogKiAgICogYCdtbSdgOiBNaW51dGUgaW4gaG91ciwgcGFkZGVkICgwMC01OSkKICogICAqIGAnbSdgOiBNaW51dGUgaW4gaG91ciAoMC01OSkKICogICAqIGAnc3MnYDogU2Vjb25kIGluIG1pbnV0ZSwgcGFkZGVkICgwMC01OSkKICogICAqIGAncydgOiBTZWNvbmQgaW4gbWludXRlICgwLTU5KQogKiAgICogYCcuc3NzJyBvciAnLHNzcydgOiBNaWxsaXNlY29uZCBpbiBzZWNvbmQsIHBhZGRlZCAoMDAwLTk5OSkKICogICAqIGAnYSdgOiBhbS9wbSBtYXJrZXIKICogICAqIGAnWidgOiA0IGRpZ2l0ICgrc2lnbikgcmVwcmVzZW50YXRpb24gb2YgdGhlIHRpbWV6b25lIG9mZnNldCAoLTEyMDAtKzEyMDApCiAqCiAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBhbHNvIGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHByZWRlZmluZWQKICogICB7QGxpbmsgZ3VpZGUvaTE4biBsb2NhbGl6YWJsZSBmb3JtYXRzfToKICoKICogICAqIGAnbWVkaXVtJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSBoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlCiAqICAgICAoZS5nLiBTZXAgMywgMjAxMCAxMjowNTowOCBwbSkKICogICAqIGAnc2hvcnQnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSBoOm1tIGEnYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiA5LzMvMTAgMTI6MDUgcG0pCiAqICAgKiBgJ2Z1bGxEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdFRUVFLCBNTU1NIGQseSdgIGZvciBlbl9VUyAgbG9jYWxlCiAqICAgICAoZS5nLiBGcmlkYXksIFNlcHRlbWJlciAzLCAyMDEwKQogKiAgICogYCdsb25nRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwdGVtYmVyIDMsIDIwMTApCiAqICAgKiBgJ21lZGl1bURhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwIDMsIDIwMTApCiAqICAgKiBgJ3Nob3J0RGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5J2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiA5LzMvMTApCiAqICAgKiBgJ21lZGl1bVRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDU6MDggcG0pCiAqICAgKiBgJ3Nob3J0VGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbSBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNSBwbSkKICoKICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGNvbnRhaW4gbGl0ZXJhbCB2YWx1ZXMuIFRoZXNlIG5lZWQgdG8gYmUgcXVvdGVkIHdpdGggc2luZ2xlIHF1b3RlcyAoZS5nLgogKiAgIGAiaCAnaW4gdGhlIG1vcm5pbmcnImApLiBJbiBvcmRlciB0byBvdXRwdXQgc2luZ2xlIHF1b3RlLCB1c2UgdHdvIHNpbmdsZSBxdW90ZXMgaW4gYSBzZXF1ZW5jZQogKiAgIChlLmcuIGAiaCAnbycnY2xvY2snImApLgogKgogKiBAcGFyYW0geyhEYXRlfG51bWJlcnxzdHJpbmcpfSBkYXRlIERhdGUgdG8gZm9ybWF0IGVpdGhlciBhcyBEYXRlIG9iamVjdCwgbWlsbGlzZWNvbmRzIChzdHJpbmcgb3IKICogICAgbnVtYmVyKSBvciB2YXJpb3VzIElTTyA4NjAxIGRhdGV0aW1lIHN0cmluZyBmb3JtYXRzIChlLmcuIHl5eXktTU0tZGRUSEg6bW06c3MuU1NTWiBhbmQgaXRzCiAqICAgIHNob3J0ZXIgdmVyc2lvbnMgbGlrZSB5eXl5LU1NLWRkVEhIOm1tWiwgeXl5eS1NTS1kZCBvciB5eXl5TU1kZFRISG1tc3NaKS4gSWYgbm8gdGltZXpvbmUgaXMKICogICAgc3BlY2lmaWVkIGluIHRoZSBzdHJpbmcgaW5wdXQsIHRoZSB0aW1lIGlzIGNvbnNpZGVyZWQgdG8gYmUgaW4gdGhlIGxvY2FsIHRpbWV6b25lLgogKiBAcGFyYW0ge3N0cmluZz19IGZvcm1hdCBGb3JtYXR0aW5nIHJ1bGVzIChzZWUgRGVzY3JpcHRpb24pLiBJZiBub3Qgc3BlY2lmaWVkLAogKiAgICBgbWVkaXVtRGF0ZWAgaXMgdXNlZC4KICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIHN0cmluZyBvciB0aGUgaW5wdXQgaWYgaW5wdXQgaXMgbm90IHJlY29nbml6ZWQgYXMgZGF0ZS9taWxsaXMuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTwvc3Bhbj46CiAgICAgICAgICAgPHNwYW4+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PC9zcGFuPjxicj4KICAgICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08L3NwYW4+OgogICAgICAgICAgPHNwYW4+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjxicj4KICAgICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08L3NwYW4+OgogICAgICAgICAgPHNwYW4+e3snMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08L3NwYW4+PGJyPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgZm9ybWF0IGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSciKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgdG9NYXRjaCgvT2N0IDJcZCwgMjAxMCBcZHsxLDJ9OlxkezJ9OlxkezJ9IChBTXxQTSkvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWiciKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgdG9NYXRjaCgvMjAxMFwtMTBcLTJcZCBcZHsyfTpcZHsyfTpcZHsyfSAoXC18XCspP1xkezR9Lyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoIicxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSciKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgdG9NYXRjaCgvMTBcLzJcZFwvMjAxMCBAIFxkezEsMn06XGR7Mn0oQU18UE0pLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmRhdGVGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwpmdW5jdGlvbiBkYXRlRmlsdGVyKCRsb2NhbGUpIHsKCgogIHZhciBSX0lTTzg2MDFfU1RSID0gL14oXGR7NH0pLT8oXGRcZCktPyhcZFxkKSg/OlQoXGRcZCkoPzo6PyhcZFxkKSg/Ojo/KFxkXGQpKD86XC4oXGQrKSk/KT8pPyhafChbKy1dKShcZFxkKTo/KFxkXGQpKT8pPyQvOwogICAgICAgICAgICAgICAgICAgICAvLyAxICAgICAgICAyICAgICAgIDMgICAgICAgICA0ICAgICAgICAgIDUgICAgICAgICAgNiAgICAgICAgICA3ICAgICAgICAgIDggIDkgICAgIDEwICAgICAgMTEKICBmdW5jdGlvbiBqc29uU3RyaW5nVG9EYXRlKHN0cmluZykgewogICAgdmFyIG1hdGNoOwogICAgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKFJfSVNPODYwMV9TVFIpKSB7CiAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoMCksCiAgICAgICAgICB0ekhvdXIgPSAwLAogICAgICAgICAgdHpNaW4gID0gMCwKICAgICAgICAgIGRhdGVTZXR0ZXIgPSBtYXRjaFs4XSA/IGRhdGUuc2V0VVRDRnVsbFllYXIgOiBkYXRlLnNldEZ1bGxZZWFyLAogICAgICAgICAgdGltZVNldHRlciA9IG1hdGNoWzhdID8gZGF0ZS5zZXRVVENIb3VycyA6IGRhdGUuc2V0SG91cnM7CgogICAgICBpZiAobWF0Y2hbOV0pIHsKICAgICAgICB0ekhvdXIgPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMF0pOwogICAgICAgIHR6TWluID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTFdKTsKICAgICAgfQogICAgICBkYXRlU2V0dGVyLmNhbGwoZGF0ZSwgaW50KG1hdGNoWzFdKSwgaW50KG1hdGNoWzJdKSAtIDEsIGludChtYXRjaFszXSkpOwogICAgICB2YXIgaCA9IGludChtYXRjaFs0XXx8MCkgLSB0ekhvdXI7CiAgICAgIHZhciBtID0gaW50KG1hdGNoWzVdfHwwKSAtIHR6TWluOwogICAgICB2YXIgcyA9IGludChtYXRjaFs2XXx8MCk7CiAgICAgIHZhciBtcyA9IE1hdGgucm91bmQocGFyc2VGbG9hdCgnMC4nICsgKG1hdGNoWzddfHwwKSkgKiAxMDAwKTsKICAgICAgdGltZVNldHRlci5jYWxsKGRhdGUsIGgsIG0sIHMsIG1zKTsKICAgICAgcmV0dXJuIGRhdGU7CiAgICB9CiAgICByZXR1cm4gc3RyaW5nOwogIH0KCgogIHJldHVybiBmdW5jdGlvbihkYXRlLCBmb3JtYXQpIHsKICAgIHZhciB0ZXh0ID0gJycsCiAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICBmbiwgbWF0Y2g7CgogICAgZm9ybWF0ID0gZm9ybWF0IHx8ICdtZWRpdW1EYXRlJzsKICAgIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tmb3JtYXRdIHx8IGZvcm1hdDsKICAgIGlmIChpc1N0cmluZyhkYXRlKSkgewogICAgICBpZiAoTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpKSB7CiAgICAgICAgZGF0ZSA9IGludChkYXRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRlID0ganNvblN0cmluZ1RvRGF0ZShkYXRlKTsKICAgICAgfQogICAgfQoKICAgIGlmIChpc051bWJlcihkYXRlKSkgewogICAgICBkYXRlID0gbmV3IERhdGUoZGF0ZSk7CiAgICB9CgogICAgaWYgKCFpc0RhdGUoZGF0ZSkpIHsKICAgICAgcmV0dXJuIGRhdGU7CiAgICB9CgogICAgd2hpbGUoZm9ybWF0KSB7CiAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgcGFydHMgPSBjb25jYXQocGFydHMsIG1hdGNoLCAxKTsKICAgICAgICBmb3JtYXQgPSBwYXJ0cy5wb3AoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwYXJ0cy5wdXNoKGZvcm1hdCk7CiAgICAgICAgZm9ybWF0ID0gbnVsbDsKICAgICAgfQogICAgfQoKICAgIGZvckVhY2gocGFydHMsIGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgZm4gPSBEQVRFX0ZPUk1BVFNbdmFsdWVdOwogICAgICB0ZXh0ICs9IGZuID8gZm4oZGF0ZSwgJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTKQogICAgICAgICAgICAgICAgIDogdmFsdWUucmVwbGFjZSgvKF4nfCckKS9nLCAnJykucmVwbGFjZSgvJycvZywgIiciKTsKICAgIH0pOwoKICAgIHJldHVybiB0ZXh0OwogIH07Cn0KCgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBqc29uCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAgIEFsbG93cyB5b3UgdG8gY29udmVydCBhIEphdmFTY3JpcHQgb2JqZWN0IGludG8gSlNPTiBzdHJpbmcuCiAqCiAqICAgVGhpcyBmaWx0ZXIgaXMgbW9zdGx5IHVzZWZ1bCBmb3IgZGVidWdnaW5nLiBXaGVuIHVzaW5nIHRoZSBkb3VibGUgY3VybHkge3t2YWx1ZX19IG5vdGF0aW9uCiAqICAgdGhlIGJpbmRpbmcgaXMgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gSlNPTi4KICoKICogQHBhcmFtIHsqfSBvYmplY3QgQW55IEphdmFTY3JpcHQgb2JqZWN0IChpbmNsdWRpbmcgYXJyYXlzIGFuZCBwcmltaXRpdmUgdHlwZXMpIHRvIGZpbHRlci4KICogQHJldHVybnMge3N0cmluZ30gSlNPTiBzdHJpbmcuCiAqCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHByZT57eyB7J25hbWUnOid2YWx1ZSd9IHwganNvbiB9fTwvcHJlPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQganNvbmlmeSBmaWx0ZXJlZCBvYmplY3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoInsnbmFtZSc6J3ZhbHVlJ30iKSkuZ2V0VGV4dCgpKS50b01hdGNoKC9ce1xuICAibmFtZSI6ID8idmFsdWUiXG59Lyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICoKICovCmZ1bmN0aW9uIGpzb25GaWx0ZXIoKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIHRvSnNvbihvYmplY3QsIHRydWUpOwogIH07Cn0KCgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBsb3dlcmNhc2UKICogQGtpbmQgZnVuY3Rpb24KICogQGRlc2NyaXB0aW9uCiAqIENvbnZlcnRzIHN0cmluZyB0byBsb3dlcmNhc2UuCiAqIEBzZWUgYW5ndWxhci5sb3dlcmNhc2UKICovCnZhciBsb3dlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKGxvd2VyY2FzZSk7CgoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgdXBwZXJjYXNlCiAqIEBraW5kIGZ1bmN0aW9uCiAqIEBkZXNjcmlwdGlvbgogKiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogKiBAc2VlIGFuZ3VsYXIudXBwZXJjYXNlCiAqLwp2YXIgdXBwZXJjYXNlRmlsdGVyID0gdmFsdWVGbih1cHBlcmNhc2UpOwoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgbGltaXRUbwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlcyBhIG5ldyBhcnJheSBvciBzdHJpbmcgY29udGFpbmluZyBvbmx5IGEgc3BlY2lmaWVkIG51bWJlciBvZiBlbGVtZW50cy4gVGhlIGVsZW1lbnRzCiAqIGFyZSB0YWtlbiBmcm9tIGVpdGhlciB0aGUgYmVnaW5uaW5nIG9yIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheSBvciBzdHJpbmcsIGFzIHNwZWNpZmllZCBieQogKiB0aGUgdmFsdWUgYW5kIHNpZ24gKHBvc2l0aXZlIG9yIG5lZ2F0aXZlKSBvZiBgbGltaXRgLgogKgogKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gaW5wdXQgU291cmNlIGFycmF5IG9yIHN0cmluZyB0byBiZSBsaW1pdGVkLgogKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGxpbWl0IFRoZSBsZW5ndGggb2YgdGhlIHJldHVybmVkIGFycmF5IG9yIHN0cmluZy4gSWYgdGhlIGBsaW1pdGAgbnVtYmVyCiAqICAgICBpcyBwb3NpdGl2ZSwgYGxpbWl0YCBudW1iZXIgb2YgaXRlbXMgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBzb3VyY2UgYXJyYXkvc3RyaW5nIGFyZSBjb3BpZWQuCiAqICAgICBJZiB0aGUgbnVtYmVyIGlzIG5lZ2F0aXZlLCBgbGltaXRgIG51bWJlciAgb2YgaXRlbXMgZnJvbSB0aGUgZW5kIG9mIHRoZSBzb3VyY2UgYXJyYXkvc3RyaW5nCiAqICAgICBhcmUgY29waWVkLiBUaGUgYGxpbWl0YCB3aWxsIGJlIHRyaW1tZWQgaWYgaXQgZXhjZWVkcyBgYXJyYXkubGVuZ3RoYAogKiBAcmV0dXJucyB7QXJyYXl8c3RyaW5nfSBBIG5ldyBzdWItYXJyYXkgb3Igc3Vic3RyaW5nIG9mIGxlbmd0aCBgbGltaXRgIG9yIGxlc3MgaWYgaW5wdXQgYXJyYXkKICogICAgIGhhZCBsZXNzIHRoYW4gYGxpbWl0YCBlbGVtZW50cy4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5udW1iZXJzID0gWzEsMiwzLDQsNSw2LDcsOCw5XTsKICAgICAgICAgICAkc2NvcGUubGV0dGVycyA9ICJhYmNkZWZnaGkiOwogICAgICAgICAgICRzY29wZS5udW1MaW1pdCA9IDM7CiAgICAgICAgICAgJHNjb3BlLmxldHRlckxpbWl0ID0gMzsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBMaW1pdCB7e251bWJlcnN9fSB0bzogPGlucHV0IHR5cGU9ImludGVnZXIiIG5nLW1vZGVsPSJudW1MaW1pdCI+CiAgICAgICAgIDxwPk91dHB1dCBudW1iZXJzOiB7eyBudW1iZXJzIHwgbGltaXRUbzpudW1MaW1pdCB9fTwvcD4KICAgICAgICAgTGltaXQge3tsZXR0ZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJpbnRlZ2VyIiBuZy1tb2RlbD0ibGV0dGVyTGltaXQiPgogICAgICAgICA8cD5PdXRwdXQgbGV0dGVyczoge3sgbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQgfX08L3A+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICB2YXIgbnVtTGltaXRJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ251bUxpbWl0JykpOwogICAgICAgdmFyIGxldHRlckxpbWl0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdsZXR0ZXJMaW1pdCcpKTsKICAgICAgIHZhciBsaW1pdGVkTnVtYmVycyA9IGVsZW1lbnQoYnkuYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bnVtTGltaXQnKSk7CiAgICAgICB2YXIgbGltaXRlZExldHRlcnMgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2xldHRlcnMgfCBsaW1pdFRvOmxldHRlckxpbWl0JykpOwoKICAgICAgIGl0KCdzaG91bGQgbGltaXQgdGhlIG51bWJlciBhcnJheSB0byBmaXJzdCB0aHJlZSBpdGVtcycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QobnVtTGltaXRJbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KGxldHRlckxpbWl0SW5wdXQuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTnVtYmVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBudW1iZXJzOiBbMSwyLDNdJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTGV0dGVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBsZXR0ZXJzOiBhYmMnKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgdXBkYXRlIHRoZSBvdXRwdXQgd2hlbiAtMyBpcyBlbnRlcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIG51bUxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbnVtTGltaXRJbnB1dC5zZW5kS2V5cygnLTMnKTsKICAgICAgICAgbGV0dGVyTGltaXRJbnB1dC5jbGVhcigpOwogICAgICAgICBsZXR0ZXJMaW1pdElucHV0LnNlbmRLZXlzKCctMycpOwogICAgICAgICBleHBlY3QobGltaXRlZE51bWJlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbnVtYmVyczogWzcsOCw5XScpOwogICAgICAgICBleHBlY3QobGltaXRlZExldHRlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbGV0dGVyczogZ2hpJyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIG5vdCBleGNlZWQgdGhlIG1heGltdW0gc2l6ZSBvZiBpbnB1dCBhcnJheScsIGZ1bmN0aW9uKCkgewogICAgICAgICBudW1MaW1pdElucHV0LmNsZWFyKCk7CiAgICAgICAgIG51bUxpbWl0SW5wdXQuc2VuZEtleXMoJzEwMCcpOwogICAgICAgICBsZXR0ZXJMaW1pdElucHV0LmNsZWFyKCk7CiAgICAgICAgIGxldHRlckxpbWl0SW5wdXQuc2VuZEtleXMoJzEwMCcpOwogICAgICAgICBleHBlY3QobGltaXRlZE51bWJlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbnVtYmVyczogWzEsMiwzLDQsNSw2LDcsOCw5XScpOwogICAgICAgICBleHBlY3QobGltaXRlZExldHRlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbGV0dGVyczogYWJjZGVmZ2hpJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uIGxpbWl0VG9GaWx0ZXIoKXsKICByZXR1cm4gZnVuY3Rpb24oaW5wdXQsIGxpbWl0KSB7CiAgICBpZiAoIWlzQXJyYXkoaW5wdXQpICYmICFpc1N0cmluZyhpbnB1dCkpIHJldHVybiBpbnB1dDsKCiAgICBpZiAoTWF0aC5hYnMoTnVtYmVyKGxpbWl0KSkgPT09IEluZmluaXR5KSB7CiAgICAgIGxpbWl0ID0gTnVtYmVyKGxpbWl0KTsKICAgIH0gZWxzZSB7CiAgICAgIGxpbWl0ID0gaW50KGxpbWl0KTsKICAgIH0KCiAgICBpZiAoaXNTdHJpbmcoaW5wdXQpKSB7CiAgICAgIC8vTmFOIGNoZWNrIG9uIGxpbWl0CiAgICAgIGlmIChsaW1pdCkgewogICAgICAgIHJldHVybiBsaW1pdCA+PSAwID8gaW5wdXQuc2xpY2UoMCwgbGltaXQpIDogaW5wdXQuc2xpY2UobGltaXQsIGlucHV0Lmxlbmd0aCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CiAgICB9CgogICAgdmFyIG91dCA9IFtdLAogICAgICBpLCBuOwoKICAgIC8vIGlmIGFicyhsaW1pdCkgZXhjZWVkcyBtYXhpbXVtIGxlbmd0aCwgdHJpbSBpdAogICAgaWYgKGxpbWl0ID4gaW5wdXQubGVuZ3RoKQogICAgICBsaW1pdCA9IGlucHV0Lmxlbmd0aDsKICAgIGVsc2UgaWYgKGxpbWl0IDwgLWlucHV0Lmxlbmd0aCkKICAgICAgbGltaXQgPSAtaW5wdXQubGVuZ3RoOwoKICAgIGlmIChsaW1pdCA+IDApIHsKICAgICAgaSA9IDA7CiAgICAgIG4gPSBsaW1pdDsKICAgIH0gZWxzZSB7CiAgICAgIGkgPSBpbnB1dC5sZW5ndGggKyBsaW1pdDsKICAgICAgbiA9IGlucHV0Lmxlbmd0aDsKICAgIH0KCiAgICBmb3IgKDsgaTxuOyBpKyspIHsKICAgICAgb3V0LnB1c2goaW5wdXRbaV0pOwogICAgfQoKICAgIHJldHVybiBvdXQ7CiAgfTsKfQoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgb3JkZXJCeQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogT3JkZXJzIGEgc3BlY2lmaWVkIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuIEl0IGlzIG9yZGVyZWQgYWxwaGFiZXRpY2FsbHkKICogZm9yIHN0cmluZ3MgYW5kIG51bWVyaWNhbGx5IGZvciBudW1iZXJzLiBOb3RlOiBpZiB5b3Ugbm90aWNlIG51bWJlcnMgYXJlIG5vdCBiZWluZyBzb3J0ZWQKICogY29ycmVjdGx5LCBtYWtlIHN1cmUgdGhleSBhcmUgYWN0dWFsbHkgYmVpbmcgc2F2ZWQgYXMgbnVtYmVycyBhbmQgbm90IHN0cmluZ3MuCiAqCiAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzb3J0LgogKiBAcGFyYW0ge2Z1bmN0aW9uKCopfHN0cmluZ3xBcnJheS48KGZ1bmN0aW9uKCopfHN0cmluZyk+fSBleHByZXNzaW9uIEEgcHJlZGljYXRlIHRvIGJlCiAqICAgIHVzZWQgYnkgdGhlIGNvbXBhcmF0b3IgdG8gZGV0ZXJtaW5lIHRoZSBvcmRlciBvZiBlbGVtZW50cy4KICoKICogICAgQ2FuIGJlIG9uZSBvZjoKICoKICogICAgLSBgZnVuY3Rpb25gOiBHZXR0ZXIgZnVuY3Rpb24uIFRoZSByZXN1bHQgb2YgdGhpcyBmdW5jdGlvbiB3aWxsIGJlIHNvcnRlZCB1c2luZyB0aGUKICogICAgICBgPGAsIGA9YCwgYD5gIG9wZXJhdG9yLgogKiAgICAtIGBzdHJpbmdgOiBBbiBBbmd1bGFyIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIG9iamVjdCB0byBvcmRlciBieSwgc3VjaCBhcyAnbmFtZScKICogICAgICB0byBzb3J0IGJ5IGEgcHJvcGVydHkgY2FsbGVkICduYW1lJy4gT3B0aW9uYWxseSBwcmVmaXhlZCB3aXRoIGArYCBvciBgLWAgdG8gY29udHJvbAogKiAgICAgIGFzY2VuZGluZyBvciBkZXNjZW5kaW5nIHNvcnQgb3JkZXIgKGZvciBleGFtcGxlLCArbmFtZSBvciAtbmFtZSkuCiAqICAgIC0gYEFycmF5YDogQW4gYXJyYXkgb2YgZnVuY3Rpb24gb3Igc3RyaW5nIHByZWRpY2F0ZXMuIFRoZSBmaXJzdCBwcmVkaWNhdGUgaW4gdGhlIGFycmF5CiAqICAgICAgaXMgdXNlZCBmb3Igc29ydGluZywgYnV0IHdoZW4gdHdvIGl0ZW1zIGFyZSBlcXVpdmFsZW50LCB0aGUgbmV4dCBwcmVkaWNhdGUgaXMgdXNlZC4KICoKICogQHBhcmFtIHtib29sZWFuPX0gcmV2ZXJzZSBSZXZlcnNlIHRoZSBvcmRlciBvZiB0aGUgYXJyYXkuCiAqIEByZXR1cm5zIHtBcnJheX0gU29ydGVkIGNvcHkgb2YgdGhlIHNvdXJjZSBhcnJheS4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5mcmllbmRzID0KICAgICAgICAgICAgICAgW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjEyJywgYWdlOjEwfSwKICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzU1NS05ODc2JywgYWdlOjE5fSwKICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJywgYWdlOjIxfSwKICAgICAgICAgICAgICAgIHtuYW1lOidBZGFtJywgcGhvbmU6JzU1NS01Njc4JywgYWdlOjM1fSwKICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NScsIGFnZToyOX1dCiAgICAgICAgICAgJHNjb3BlLnByZWRpY2F0ZSA9ICctYWdlJzsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8cHJlPlNvcnRpbmcgcHJlZGljYXRlID0ge3twcmVkaWNhdGV9fTsgcmV2ZXJzZSA9IHt7cmV2ZXJzZX19PC9wcmU+CiAgICAgICAgIDxoci8+CiAgICAgICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlPScnIj51bnNvcnRlZDwvYT4gXQogICAgICAgICA8dGFibGUgY2xhc3M9ImZyaWVuZCI+CiAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICduYW1lJzsgcmV2ZXJzZT1mYWxzZSI+TmFtZTwvYT4KICAgICAgICAgICAgICAgICAoPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJy1uYW1lJzsgcmV2ZXJzZT1mYWxzZSI+XjwvYT4pPC90aD4KICAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAncGhvbmUnOyByZXZlcnNlPSFyZXZlcnNlIj5QaG9uZSBOdW1iZXI8L2E+PC90aD4KICAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnYWdlJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+QWdlPC9hPjwvdGg+CiAgICAgICAgICAgPC90cj4KICAgICAgICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IG9yZGVyQnk6cHJlZGljYXRlOnJldmVyc2UiPgogICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICAgICAgICAgIDwvdHI+CiAgICAgICAgIDwvdGFibGU+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICoKICogSXQncyBhbHNvIHBvc3NpYmxlIHRvIGNhbGwgdGhlIG9yZGVyQnkgZmlsdGVyIG1hbnVhbGx5LCBieSBpbmplY3RpbmcgYCRmaWx0ZXJgLCByZXRyaWV2aW5nIHRoZQogKiBmaWx0ZXIgcm91dGluZSB3aXRoIGAkZmlsdGVyKCdvcmRlckJ5JylgLCBhbmQgY2FsbGluZyB0aGUgcmV0dXJuZWQgZmlsdGVyIHJvdXRpbmUgd2l0aCB0aGUKICogZGVzaXJlZCBwYXJhbWV0ZXJzLgogKgogKiBFeGFtcGxlOgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgPHRhYmxlIGNsYXNzPSJmcmllbmQiPgogICAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icmV2ZXJzZT1mYWxzZTtvcmRlcignbmFtZScsIGZhbHNlKSI+TmFtZTwvYT4KICAgICAgICAgICAgICAoPGEgaHJlZj0iIiBuZy1jbGljaz0ib3JkZXIoJy1uYW1lJyxmYWxzZSkiPl48L2E+KTwvdGg+CiAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJyZXZlcnNlPSFyZXZlcnNlO29yZGVyKCdwaG9uZScsIHJldmVyc2UpIj5QaG9uZSBOdW1iZXI8L2E+PC90aD4KICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InJldmVyc2U9IXJldmVyc2U7b3JkZXIoJ2FnZScscmV2ZXJzZSkiPkFnZTwvYT48L3RoPgogICAgICAgICAgPC90cj4KICAgICAgICAgIDx0ciBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIj4KICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLmFnZX19PC90ZD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgPC90YWJsZT4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CgogICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUsICRmaWx0ZXIpIHsKICAgICAgICB2YXIgb3JkZXJCeSA9ICRmaWx0ZXIoJ29yZGVyQnknKTsKICAgICAgICAkc2NvcGUuZnJpZW5kcyA9IFsKICAgICAgICAgIHsgbmFtZTogJ0pvaG4nLCAgICBwaG9uZTogJzU1NS0xMjEyJywgICAgYWdlOiAxMCB9LAogICAgICAgICAgeyBuYW1lOiAnTWFyeScsICAgIHBob25lOiAnNTU1LTk4NzYnLCAgICBhZ2U6IDE5IH0sCiAgICAgICAgICB7IG5hbWU6ICdNaWtlJywgICAgcGhvbmU6ICc1NTUtNDMyMScsICAgIGFnZTogMjEgfSwKICAgICAgICAgIHsgbmFtZTogJ0FkYW0nLCAgICBwaG9uZTogJzU1NS01Njc4JywgICAgYWdlOiAzNSB9LAogICAgICAgICAgeyBuYW1lOiAnSnVsaWUnLCAgIHBob25lOiAnNTU1LTg3NjUnLCAgICBhZ2U6IDI5IH0KICAgICAgICBdOwoKICAgICAgICAkc2NvcGUub3JkZXIgPSBmdW5jdGlvbihwcmVkaWNhdGUsIHJldmVyc2UpIHsKICAgICAgICAgICRzY29wZS5mcmllbmRzID0gb3JkZXJCeSgkc2NvcGUuZnJpZW5kcywgcHJlZGljYXRlLCByZXZlcnNlKTsKICAgICAgICB9OwogICAgICAgICRzY29wZS5vcmRlcignLWFnZScsZmFsc2UpOwogICAgICB9CiAgICA8L2ZpbGU+CjwvZXhhbXBsZT4KICovCm9yZGVyQnlGaWx0ZXIuJGluamVjdCA9IFsnJHBhcnNlJ107CmZ1bmN0aW9uIG9yZGVyQnlGaWx0ZXIoJHBhcnNlKXsKICByZXR1cm4gZnVuY3Rpb24oYXJyYXksIHNvcnRQcmVkaWNhdGUsIHJldmVyc2VPcmRlcikgewogICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgaWYgKCFzb3J0UHJlZGljYXRlKSByZXR1cm4gYXJyYXk7CiAgICBzb3J0UHJlZGljYXRlID0gaXNBcnJheShzb3J0UHJlZGljYXRlKSA/IHNvcnRQcmVkaWNhdGU6IFtzb3J0UHJlZGljYXRlXTsKICAgIHNvcnRQcmVkaWNhdGUgPSBtYXAoc29ydFByZWRpY2F0ZSwgZnVuY3Rpb24ocHJlZGljYXRlKXsKICAgICAgdmFyIGRlc2NlbmRpbmcgPSBmYWxzZSwgZ2V0ID0gcHJlZGljYXRlIHx8IGlkZW50aXR5OwogICAgICBpZiAoaXNTdHJpbmcocHJlZGljYXRlKSkgewogICAgICAgIGlmICgocHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnKycgfHwgcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLScpKSB7CiAgICAgICAgICBkZXNjZW5kaW5nID0gcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLSc7CiAgICAgICAgICBwcmVkaWNhdGUgPSBwcmVkaWNhdGUuc3Vic3RyaW5nKDEpOwogICAgICAgIH0KICAgICAgICBnZXQgPSAkcGFyc2UocHJlZGljYXRlKTsKICAgICAgICBpZiAoZ2V0LmNvbnN0YW50KSB7CiAgICAgICAgICB2YXIga2V5ID0gZ2V0KCk7CiAgICAgICAgICByZXR1cm4gcmV2ZXJzZUNvbXBhcmF0b3IoZnVuY3Rpb24oYSxiKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wYXJlKGFba2V5XSwgYltrZXldKTsKICAgICAgICAgIH0sIGRlc2NlbmRpbmcpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV2ZXJzZUNvbXBhcmF0b3IoZnVuY3Rpb24oYSxiKXsKICAgICAgICByZXR1cm4gY29tcGFyZShnZXQoYSksZ2V0KGIpKTsKICAgICAgfSwgZGVzY2VuZGluZyk7CiAgICB9KTsKICAgIHZhciBhcnJheUNvcHkgPSBbXTsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7IGFycmF5Q29weS5wdXNoKGFycmF5W2ldKTsgfQogICAgcmV0dXJuIGFycmF5Q29weS5zb3J0KHJldmVyc2VDb21wYXJhdG9yKGNvbXBhcmF0b3IsIHJldmVyc2VPcmRlcikpOwoKICAgIGZ1bmN0aW9uIGNvbXBhcmF0b3IobzEsIG8yKXsKICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgc29ydFByZWRpY2F0ZS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjb21wID0gc29ydFByZWRpY2F0ZVtpXShvMSwgbzIpOwogICAgICAgIGlmIChjb21wICE9PSAwKSByZXR1cm4gY29tcDsKICAgICAgfQogICAgICByZXR1cm4gMDsKICAgIH0KICAgIGZ1bmN0aW9uIHJldmVyc2VDb21wYXJhdG9yKGNvbXAsIGRlc2NlbmRpbmcpIHsKICAgICAgcmV0dXJuIHRvQm9vbGVhbihkZXNjZW5kaW5nKQogICAgICAgICAgPyBmdW5jdGlvbihhLGIpe3JldHVybiBjb21wKGIsYSk7fQogICAgICAgICAgOiBjb21wOwogICAgfQogICAgZnVuY3Rpb24gY29tcGFyZSh2MSwgdjIpewogICAgICB2YXIgdDEgPSB0eXBlb2YgdjE7CiAgICAgIHZhciB0MiA9IHR5cGVvZiB2MjsKICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgaWYgKHQxID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgdjEgPSB2MS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgIHYyID0gdjIudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHYxID09PSB2MikgcmV0dXJuIDA7CiAgICAgICAgcmV0dXJuIHYxIDwgdjIgPyAtMSA6IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHQxIDwgdDIgPyAtMSA6IDE7CiAgICAgIH0KICAgIH0KICB9Owp9CgpmdW5jdGlvbiBuZ0RpcmVjdGl2ZShkaXJlY3RpdmUpIHsKICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICBkaXJlY3RpdmUgPSB7CiAgICAgIGxpbms6IGRpcmVjdGl2ZQogICAgfTsKICB9CiAgZGlyZWN0aXZlLnJlc3RyaWN0ID0gZGlyZWN0aXZlLnJlc3RyaWN0IHx8ICdBQyc7CiAgcmV0dXJuIHZhbHVlRm4oZGlyZWN0aXZlKTsKfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYQogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogTW9kaWZpZXMgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgdGhlIGh0bWwgQSB0YWcgc28gdGhhdCB0aGUgZGVmYXVsdCBhY3Rpb24gaXMgcHJldmVudGVkIHdoZW4KICogdGhlIGhyZWYgYXR0cmlidXRlIGlzIGVtcHR5LgogKgogKiBUaGlzIGNoYW5nZSBwZXJtaXRzIHRoZSBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIHRoZSBgbmdDbGlja2AgZGlyZWN0aXZlCiAqIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogKiBgPGEgaHJlZj0iIiBuZy1jbGljaz0ibGlzdC5hZGRJdGVtKCkiPkFkZCBJdGVtPC9hPmAKICovCnZhciBodG1sQW5jaG9yRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgcmVzdHJpY3Q6ICdFJywKICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CgogICAgaWYgKG1zaWUgPD0gOCkgewoKICAgICAgLy8gdHVybiA8YSBocmVmIG5nLWNsaWNrPSIuLiI+bGluazwvYT4gaW50byBhIHN0eWxhYmxlIGxpbmsgaW4gSUUKICAgICAgLy8gYnV0IG9ubHkgaWYgaXQgZG9lc24ndCBoYXZlIG5hbWUgYXR0cmlidXRlLCBpbiB3aGljaCBjYXNlIGl0J3MgYW4gYW5jaG9yCiAgICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLm5hbWUpIHsKICAgICAgICBhdHRyLiRzZXQoJ2hyZWYnLCAnJyk7CiAgICAgIH0KCiAgICAgIC8vIGFkZCBhIGNvbW1lbnQgbm9kZSB0byBhbmNob3JzIHRvIHdvcmthcm91bmQgSUUgYnVnIHRoYXQgY2F1c2VzIGVsZW1lbnQgY29udGVudCB0byBiZSByZXNldAogICAgICAvLyB0byBuZXcgYXR0cmlidXRlIGNvbnRlbnQgaWYgYXR0cmlidXRlIGlzIHVwZGF0ZWQgd2l0aCB2YWx1ZSBjb250YWluaW5nIEAgYW5kIGVsZW1lbnQgYWxzbwogICAgICAvLyBjb250YWlucyB2YWx1ZSB3aXRoIEAKICAgICAgLy8gc2VlIGlzc3VlICMxOTQ5CiAgICAgIGVsZW1lbnQuYXBwZW5kKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJ0lFIGZpeCcpKTsKICAgIH0KCiAgICBpZiAoIWF0dHIuaHJlZiAmJiAhYXR0ci54bGlua0hyZWYgJiYgIWF0dHIubmFtZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAvLyBTVkdBRWxlbWVudCBkb2VzIG5vdCB1c2UgdGhlIGhyZWYgYXR0cmlidXRlLCBidXQgcmF0aGVyIHRoZSAneGxpbmtIcmVmJyBhdHRyaWJ1dGUuCiAgICAgICAgdmFyIGhyZWYgPSB0b1N0cmluZy5jYWxsKGVsZW1lbnQucHJvcCgnaHJlZicpKSA9PT0gJ1tvYmplY3QgU1ZHQW5pbWF0ZWRTdHJpbmddJyA/CiAgICAgICAgICAgICAgICAgICAneGxpbms6aHJlZicgOiAnaHJlZic7CiAgICAgICAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICAvLyBpZiB3ZSBoYXZlIG5vIGhyZWYgdXJsLCB0aGVuIGRvbid0IG5hdmlnYXRlIGFueXdoZXJlLgogICAgICAgICAgaWYgKCFlbGVtZW50LmF0dHIoaHJlZikpIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdIcmVmCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSA5OQogKgogKiBAZGVzY3JpcHRpb24KICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGFuIGhyZWYgYXR0cmlidXRlIHdpbGwKICogbWFrZSB0aGUgbGluayBnbyB0byB0aGUgd3JvbmcgVVJMIGlmIHRoZSB1c2VyIGNsaWNrcyBpdCBiZWZvcmUKICogQW5ndWxhciBoYXMgYSBjaGFuY2UgdG8gcmVwbGFjZSB0aGUgYHt7aGFzaH19YCBtYXJrdXAgd2l0aCBpdHMKICogdmFsdWUuIFVudGlsIEFuZ3VsYXIgcmVwbGFjZXMgdGhlIG1hcmt1cCB0aGUgbGluayB3aWxsIGJlIGJyb2tlbgogKiBhbmQgd2lsbCBtb3N0IGxpa2VseSByZXR1cm4gYSA0MDQgZXJyb3IuCiAqCiAqIFRoZSBgbmdIcmVmYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICoKICogVGhlIHdyb25nIHdheSB0byB3cml0ZSBpdDoKICogYGBgaHRtbAogKiA8YSBocmVmPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogYGBgCiAqCiAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICogYGBgaHRtbAogKiA8YSBuZy1ocmVmPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogYGBgCiAqCiAqIEBlbGVtZW50IEEKICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdIcmVmIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICoKICogQGV4YW1wbGUKICogVGhpcyBleGFtcGxlIHNob3dzIHZhcmlvdXMgY29tYmluYXRpb25zIG9mIGBocmVmYCwgYG5nLWhyZWZgIGFuZCBgbmctY2xpY2tgIGF0dHJpYnV0ZXMKICogaW4gbGlua3MgYW5kIHRoZWlyIGRpZmZlcmVudCBiZWhhdmlvcnM6CiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJ2YWx1ZSIgLz48YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0xIiBocmVmIG5nLWNsaWNrPSJ2YWx1ZSA9IDEiPmxpbmsgMTwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0yIiBocmVmPSIiIG5nLWNsaWNrPSJ2YWx1ZSA9IDIiPmxpbmsgMjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0zIiBuZy1ocmVmPSIve3snMTIzJ319Ij5saW5rIDM8L2E+IChsaW5rLCByZWxvYWQhKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTQiIGhyZWY9IiIgbmFtZT0ieHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDQiPmFuY2hvcjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay01IiBuYW1lPSJ4eHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDUiPmFuY2hvcjwvYT4gKG5vIGxpbmspPGJyIC8+CiAgICAgICAgPGEgaWQ9ImxpbmstNiIgbmctaHJlZj0ie3t2YWx1ZX19Ij5saW5rPC9hPiAobGluaywgY2hhbmdlIGxvY2F0aW9uKQogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgd2l0aG91dCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay0xJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCcxJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0xJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKCcnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstMicpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9FcXVhbCgnMicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmstMicpKS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBhbmQgY2hhbmdlIHVybCB3aGVuIG5nLWhyZWYgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0zJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b01hdGNoKC9cLzEyMyQvKTsKCiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTMnKSkuY2xpY2soKTsKCiAgICAgICAgICAvLyBBdCB0aGlzIHBvaW50LCB3ZSBuYXZpZ2F0ZSBhd2F5IGZyb20gYW4gQW5ndWxhciBwYWdlLCBzbyB3ZSBuZWVkCiAgICAgICAgICAvLyB0byB1c2UgYnJvd3Nlci5kcml2ZXIgdG8gZ2V0IHRoZSBiYXNlIHdlYmRyaXZlci4KCiAgICAgICAgICBicm93c2VyLndhaXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBicm93c2VyLmRyaXZlci5nZXRDdXJyZW50VXJsKCkudGhlbihmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICByZXR1cm4gdXJsLm1hdGNoKC9cLzEyMyQvKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCAxMDAwLCAncGFnZSBzaG91bGQgbmF2aWdhdGUgdG8gLzEyMycpOwogICAgICAgIH0pOwoKICAgICAgICB4aXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcgYW5kIG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTQnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUoJycpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBubyBocmVmIGJ1dCBuYW1lIHNwZWNpZmllZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay01JykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCc1Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay01JykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKG51bGwpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIG9ubHkgY2hhbmdlIHVybCB3aGVuIG9ubHkgbmctaHJlZicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuY2xlYXIoKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLnNlbmRLZXlzKCc2Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay02JykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b01hdGNoKC9cLzYkLyk7CgogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay02JykpLmNsaWNrKCk7CgogICAgICAgICAgLy8gQXQgdGhpcyBwb2ludCwgd2UgbmF2aWdhdGUgYXdheSBmcm9tIGFuIEFuZ3VsYXIgcGFnZSwgc28gd2UgbmVlZAogICAgICAgICAgLy8gdG8gdXNlIGJyb3dzZXIuZHJpdmVyIHRvIGdldCB0aGUgYmFzZSB3ZWJkcml2ZXIuCiAgICAgICAgICBicm93c2VyLndhaXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBicm93c2VyLmRyaXZlci5nZXRDdXJyZW50VXJsKCkudGhlbihmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICByZXR1cm4gdXJsLm1hdGNoKC9cLzYkLyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgMTAwMCwgJ3BhZ2Ugc2hvdWxkIG5hdmlnYXRlIHRvIC82Jyk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1NyYwogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgOTkKICoKICogQGRlc2NyaXB0aW9uCiAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhIGBzcmNgIGF0dHJpYnV0ZSBkb2Vzbid0CiAqIHdvcmsgcmlnaHQ6IFRoZSBicm93c2VyIHdpbGwgZmV0Y2ggZnJvbSB0aGUgVVJMIHdpdGggdGhlIGxpdGVyYWwKICogdGV4dCBge3toYXNofX1gIHVudGlsIEFuZ3VsYXIgcmVwbGFjZXMgdGhlIGV4cHJlc3Npb24gaW5zaWRlCiAqIGB7e2hhc2h9fWAuIFRoZSBgbmdTcmNgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogKgogKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxpbWcgc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogYGBgCiAqCiAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICogYGBgaHRtbAogKiA8aW1nIG5nLXNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAqIGBgYAogKgogKiBAZWxlbWVudCBJTUcKICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdTcmMgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU3Jjc2V0CiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSA5OQogKgogKiBAZGVzY3JpcHRpb24KICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGEgYHNyY3NldGAgYXR0cmlidXRlIGRvZXNuJ3QKICogd29yayByaWdodDogVGhlIGJyb3dzZXIgd2lsbCBmZXRjaCBmcm9tIHRoZSBVUkwgd2l0aCB0aGUgbGl0ZXJhbAogKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICogYHt7aGFzaH19YC4gVGhlIGBuZ1NyY3NldGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAqCiAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAqIGBgYGh0bWwKICogPGltZyBzcmNzZXQ9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSAyeCIvPgogKiBgYGAKICoKICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxpbWcgbmctc3Jjc2V0PSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0gMngiLz4KICogYGBgCiAqCiAqIEBlbGVtZW50IElNRwogKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ1NyY3NldCBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdEaXNhYmxlZAogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUgZm9sbG93aW5nIG1hcmt1cCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAqIGBgYGh0bWwKICogPGRpdiBuZy1pbml0PSJzY29wZSA9IHsgaXNEaXNhYmxlZDogZmFsc2UgfSI+CiAqICA8YnV0dG9uIGRpc2FibGVkPSJ7e3Njb3BlLmlzRGlzYWJsZWR9fSI+RGlzYWJsZWQ8L2J1dHRvbj4KICogPC9kaXY+CiAqIGBgYAogKgogKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICogc3VjaCBhcyBkaXNhYmxlZC4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAqIFRoZSBgbmdEaXNhYmxlZGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgZGlzYWJsZWRgIGF0dHJpYnV0ZS4KICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgQ2xpY2sgbWUgdG8gdG9nZ2xlOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICAgIDxidXR0b24gbmctbW9kZWw9ImJ1dHRvbiIgbmctZGlzYWJsZWQ9ImNoZWNrZWQiPkJ1dHRvbjwvYnV0dG9uPgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgdG9nZ2xlIGJ1dHRvbicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCdidXR0b24nKSkuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnYnV0dG9uJykpLmdldEF0dHJpYnV0ZSgnZGlzYWJsZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqCiAqIEBlbGVtZW50IElOUFVUCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdEaXNhYmxlZCBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAiZGlzYWJsZWQiIHdpbGwgYmUgc2V0IG9uIHRoZSBlbGVtZW50CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2hlY2tlZAogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICogc3VjaCBhcyBjaGVja2VkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICogVGhlIGBuZ0NoZWNrZWRgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtIGZvciB0aGUgYGNoZWNrZWRgIGF0dHJpYnV0ZS4KICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgQ2hlY2sgbWUgdG8gY2hlY2sgYm90aDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ibWFzdGVyIj48YnIvPgogICAgICAgIDxpbnB1dCBpZD0iY2hlY2tTbGF2ZSIgdHlwZT0iY2hlY2tib3giIG5nLWNoZWNrZWQ9Im1hc3RlciI+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBib3RoIGNoZWNrQm94ZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjaGVja1NsYXZlJykpLmdldEF0dHJpYnV0ZSgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ21hc3RlcicpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2NoZWNrU2xhdmUnKSkuZ2V0QXR0cmlidXRlKCdjaGVja2VkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKgogKiBAZWxlbWVudCBJTlBVVAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2hlY2tlZCBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAiY2hlY2tlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdSZWFkb25seQogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICogc3VjaCBhcyByZWFkb25seS4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAqIFRoZSBgbmdSZWFkb25seWAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgcmVhZG9ubHlgIGF0dHJpYnV0ZS4KICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgQ2hlY2sgbWUgdG8gbWFrZSB0ZXh0IHJlYWRvbmx5OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1yZWFkb25seT0iY2hlY2tlZCIgdmFsdWU9IkknbSBBbmd1bGFyIi8+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgcmVhZG9ubHkgYXR0cicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCdbdHlwZT0idGV4dCJdJykpLmdldEF0dHJpYnV0ZSgncmVhZG9ubHknKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdjaGVja2VkJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJ1t0eXBlPSJ0ZXh0Il0nKSkuZ2V0QXR0cmlidXRlKCdyZWFkb25seScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICoKICogQGVsZW1lbnQgSU5QVVQKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1JlYWRvbmx5IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJyZWFkb25seSIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTZWxlY3RlZAogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICogc3VjaCBhcyBzZWxlY3RlZC4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAqIFRoZSBgbmdTZWxlY3RlZGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgc2VsZWN0ZWRgIGF0dHJpYnV0ZS4KICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgQ2hlY2sgbWUgdG8gc2VsZWN0OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJzZWxlY3RlZCI+PGJyLz4KICAgICAgICA8c2VsZWN0PgogICAgICAgICAgPG9wdGlvbj5IZWxsbyE8L29wdGlvbj4KICAgICAgICAgIDxvcHRpb24gaWQ9ImdyZWV0IiBuZy1zZWxlY3RlZD0ic2VsZWN0ZWQiPkdyZWV0aW5ncyE8L29wdGlvbj4KICAgICAgICA8L3NlbGVjdD4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICBpdCgnc2hvdWxkIHNlbGVjdCBHcmVldGluZ3MhJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZ3JlZXQnKSkuZ2V0QXR0cmlidXRlKCdzZWxlY3RlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3NlbGVjdGVkJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZ3JlZXQnKSkuZ2V0QXR0cmlidXRlKCdzZWxlY3RlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICoKICogQGVsZW1lbnQgT1BUSU9OCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTZWxlY3RlZCBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAic2VsZWN0ZWQiIHdpbGwgYmUgc2V0IG9uIHRoZSBlbGVtZW50CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdPcGVuCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIG9wZW4uIChUaGVpciBwcmVzZW5jZSBtZWFucyB0cnVlIGFuZCB0aGVpciBhYnNlbmNlIG1lYW5zIGZhbHNlLikKICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICogYmluZGluZyBpbmZvcm1hdGlvbiB3b3VsZCBiZSBsb3N0IHdoZW4gdGhlIGJyb3dzZXIgcmVtb3ZlcyB0aGUgYXR0cmlidXRlLgogKiBUaGUgYG5nT3BlbmAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgb3BlbmAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICBDaGVjayBtZSBjaGVjayBtdWx0aXBsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ib3BlbiI+PGJyLz4KICAgICAgICAgPGRldGFpbHMgaWQ9ImRldGFpbHMiIG5nLW9wZW49Im9wZW4iPgogICAgICAgICAgICA8c3VtbWFyeT5TaG93L0hpZGUgbWU8L3N1bW1hcnk+CiAgICAgICAgIDwvZGV0YWlscz4KICAgICAgIDwvZmlsZT4KICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBvcGVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2RldGFpbHMnKSkuZ2V0QXR0cmlidXRlKCdvcGVuJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ29wZW4nKSkuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZGV0YWlscycpKS5nZXRBdHRyaWJ1dGUoJ29wZW4nKSkudG9CZVRydXRoeSgpOwogICAgICAgICB9KTsKICAgICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAqCiAqIEBlbGVtZW50IERFVEFJTFMKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ09wZW4gSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSwKICogICAgIHRoZW4gc3BlY2lhbCBhdHRyaWJ1dGUgIm9wZW4iIHdpbGwgYmUgc2V0IG9uIHRoZSBlbGVtZW50CiAqLwoKdmFyIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzID0ge307CgoKLy8gYm9vbGVhbiBhdHRycyBhcmUgZXZhbHVhdGVkCmZvckVhY2goQk9PTEVBTl9BVFRSLCBmdW5jdGlvbihwcm9wTmFtZSwgYXR0ck5hbWUpIHsKICAvLyBiaW5kaW5nIHRvIG11bHRpcGxlIGlzIG5vdCBzdXBwb3J0ZWQKICBpZiAocHJvcE5hbWUgPT0gIm11bHRpcGxlIikgcmV0dXJuOwoKICB2YXIgbm9ybWFsaXplZCA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIGF0dHJOYW1lKTsKICBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlc1tub3JtYWxpemVkXSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltub3JtYWxpemVkXSwgZnVuY3Rpb24gbmdCb29sZWFuQXR0cldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBhdHRyLiRzZXQoYXR0ck5hbWUsICEhdmFsdWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH07Cn0pOwoKCi8vIG5nLXNyYywgbmctc3Jjc2V0LCBuZy1ocmVmIGFyZSBpbnRlcnBvbGF0ZWQKZm9yRWFjaChbJ3NyYycsICdzcmNzZXQnLCAnaHJlZiddLCBmdW5jdGlvbihhdHRyTmFtZSkgewogIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgdmFyIHByb3BOYW1lID0gYXR0ck5hbWUsCiAgICAgICAgICAgIG5hbWUgPSBhdHRyTmFtZTsKCiAgICAgICAgaWYgKGF0dHJOYW1lID09PSAnaHJlZicgJiYKICAgICAgICAgICAgdG9TdHJpbmcuY2FsbChlbGVtZW50LnByb3AoJ2hyZWYnKSkgPT09ICdbb2JqZWN0IFNWR0FuaW1hdGVkU3RyaW5nXScpIHsKICAgICAgICAgIG5hbWUgPSAneGxpbmtIcmVmJzsKICAgICAgICAgIGF0dHIuJGF0dHJbbmFtZV0gPSAneGxpbms6aHJlZic7CiAgICAgICAgICBwcm9wTmFtZSA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBhdHRyLiRvYnNlcnZlKG5vcm1hbGl6ZWQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAoIXZhbHVlKQogICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgIGF0dHIuJHNldChuYW1lLCB2YWx1ZSk7CgogICAgICAgICAgLy8gb24gSUUsIGlmICJuZzpzcmMiIGRpcmVjdGl2ZSBkZWNsYXJhdGlvbiBpcyB1c2VkIGFuZCAic3JjIiBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdAogICAgICAgICAgLy8gdGhlbiBjYWxsaW5nIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdzcmMnLCAnZm9vJykgZG9lc24ndCBkbyBhbnl0aGluZywgc28gd2UgbmVlZAogICAgICAgICAgLy8gdG8gc2V0IHRoZSBwcm9wZXJ0eSBhcyB3ZWxsIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgZWZmZWN0LgogICAgICAgICAgLy8gd2UgdXNlIGF0dHJbYXR0ck5hbWVdIHZhbHVlIHNpbmNlICRzZXQgY2FuIHNhbml0aXplIHRoZSB1cmwuCiAgICAgICAgICBpZiAobXNpZSAmJiBwcm9wTmFtZSkgZWxlbWVudC5wcm9wKHByb3BOYW1lLCBhdHRyW25hbWVdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9Owp9KTsKCi8qIGdsb2JhbCAtbnVsbEZvcm1DdHJsICovCnZhciBudWxsRm9ybUN0cmwgPSB7CiAgJGFkZENvbnRyb2w6IG5vb3AsCiAgJHJlbW92ZUNvbnRyb2w6IG5vb3AsCiAgJHNldFZhbGlkaXR5OiBub29wLAogICRzZXREaXJ0eTogbm9vcCwKICAkc2V0UHJpc3RpbmU6IG5vb3AKfTsKCi8qKgogKiBAbmdkb2MgdHlwZQogKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyCiAqCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybSB5ZXQuCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGRpcnR5IFRydWUgaWYgdXNlciBoYXMgYWxyZWFkeSBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0uCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgYWxsIG9mIHRoZSBjb250YWluaW5nIGZvcm1zIGFuZCBjb250cm9scyBhcmUgdmFsaWQuCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgY29udGFpbmluZyBjb250cm9sIG9yIGZvcm0gaXMgaW52YWxpZC4KICoKICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBJcyBhbiBvYmplY3QgaGFzaCwgY29udGFpbmluZyByZWZlcmVuY2VzIHRvIGFsbCBpbnZhbGlkIGNvbnRyb2xzIG9yCiAqICBmb3Jtcywgd2hlcmU6CiAqCiAqICAtIGtleXMgYXJlIHZhbGlkYXRpb24gdG9rZW5zIChlcnJvciBuYW1lcyksCiAqICAtIHZhbHVlcyBhcmUgYXJyYXlzIG9mIGNvbnRyb2xzIG9yIGZvcm1zIHRoYXQgYXJlIGludmFsaWQgZm9yIGdpdmVuIGVycm9yIG5hbWUuCiAqCiAqCiAqICBCdWlsdC1pbiB2YWxpZGF0aW9uIHRva2VuczoKICoKICogIC0gYGVtYWlsYAogKiAgLSBgbWF4YAogKiAgLSBgbWF4bGVuZ3RoYAogKiAgLSBgbWluYAogKiAgLSBgbWlubGVuZ3RoYAogKiAgLSBgbnVtYmVyYAogKiAgLSBgcGF0dGVybmAKICogIC0gYHJlcXVpcmVkYAogKiAgLSBgdXJsYAogKgogKiBAZGVzY3JpcHRpb24KICogYEZvcm1Db250cm9sbGVyYCBrZWVwcyB0cmFjayBvZiBhbGwgaXRzIGNvbnRyb2xzIGFuZCBuZXN0ZWQgZm9ybXMgYXMgd2VsbCBhcyB0aGUgc3RhdGUgb2YgdGhlbSwKICogc3VjaCBhcyBiZWluZyB2YWxpZC9pbnZhbGlkIG9yIGRpcnR5L3ByaXN0aW5lLgogKgogKiBFYWNoIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBmb3JtfSBkaXJlY3RpdmUgY3JlYXRlcyBhbiBpbnN0YW5jZQogKiBvZiBgRm9ybUNvbnRyb2xsZXJgLgogKgogKi8KLy9hc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKRm9ybUNvbnRyb2xsZXIuJGluamVjdCA9IFsnJGVsZW1lbnQnLCAnJGF0dHJzJywgJyRzY29wZScsICckYW5pbWF0ZSddOwpmdW5jdGlvbiBGb3JtQ29udHJvbGxlcihlbGVtZW50LCBhdHRycywgJHNjb3BlLCAkYW5pbWF0ZSkgewogIHZhciBmb3JtID0gdGhpcywKICAgICAgcGFyZW50Rm9ybSA9IGVsZW1lbnQucGFyZW50KCkuY29udHJvbGxlcignZm9ybScpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgaW52YWxpZENvdW50ID0gMCwgLy8gdXNlZCB0byBlYXNpbHkgZGV0ZXJtaW5lIGlmIHdlIGFyZSB2YWxpZAogICAgICBlcnJvcnMgPSBmb3JtLiRlcnJvciA9IHt9LAogICAgICBjb250cm9scyA9IFtdOwoKICAvLyBpbml0IHN0YXRlCiAgZm9ybS4kbmFtZSA9IGF0dHJzLm5hbWUgfHwgYXR0cnMubmdGb3JtOwogIGZvcm0uJGRpcnR5ID0gZmFsc2U7CiAgZm9ybS4kcHJpc3RpbmUgPSB0cnVlOwogIGZvcm0uJHZhbGlkID0gdHJ1ZTsKICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CgogIHBhcmVudEZvcm0uJGFkZENvbnRyb2woZm9ybSk7CgogIC8vIFNldHVwIGluaXRpYWwgc3RhdGUgb2YgdGhlIGNvbnRyb2wKICBlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICB0b2dnbGVWYWxpZENzcyh0cnVlKTsKCiAgLy8gY29udmVuaWVuY2UgbWV0aG9kIGZvciBlYXN5IHRvZ2dsaW5nIG9mIGNsYXNzZXMKICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCAoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgKGlzVmFsaWQgPyBWQUxJRF9DTEFTUyA6IElOVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRhZGRDb250cm9sCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlciBhIGNvbnRyb2wgd2l0aCB0aGUgZm9ybS4KICAgKgogICAqIElucHV0IGVsZW1lbnRzIHVzaW5nIG5nTW9kZWxDb250cm9sbGVyIGRvIHRoaXMgYXV0b21hdGljYWxseSB3aGVuIHRoZXkgYXJlIGxpbmtlZC4KICAgKi8KICBmb3JtLiRhZGRDb250cm9sID0gZnVuY3Rpb24oY29udHJvbCkgewogICAgLy8gQnJlYWtpbmcgY2hhbmdlIC0gYmVmb3JlLCBpbnB1dHMgd2hvc2UgbmFtZSB3YXMgImhhc093blByb3BlcnR5IiB3ZXJlIHF1aWV0bHkgaWdub3JlZAogICAgLy8gYW5kIG5vdCBhZGRlZCB0byB0aGUgc2NvcGUuICBOb3cgd2UgdGhyb3cgYW4gZXJyb3IuCiAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShjb250cm9sLiRuYW1lLCAnaW5wdXQnKTsKICAgIGNvbnRyb2xzLnB1c2goY29udHJvbCk7CgogICAgaWYgKGNvbnRyb2wuJG5hbWUpIHsKICAgICAgZm9ybVtjb250cm9sLiRuYW1lXSA9IGNvbnRyb2w7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHJlbW92ZUNvbnRyb2wKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERlcmVnaXN0ZXIgYSBjb250cm9sIGZyb20gdGhlIGZvcm0uCiAgICoKICAgKiBJbnB1dCBlbGVtZW50cyB1c2luZyBuZ01vZGVsQ29udHJvbGxlciBkbyB0aGlzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGV5IGFyZSBkZXN0cm95ZWQuCiAgICovCiAgZm9ybS4kcmVtb3ZlQ29udHJvbCA9IGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgIGlmIChjb250cm9sLiRuYW1lICYmIGZvcm1bY29udHJvbC4kbmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgZGVsZXRlIGZvcm1bY29udHJvbC4kbmFtZV07CiAgICB9CiAgICBmb3JFYWNoKGVycm9ycywgZnVuY3Rpb24ocXVldWUsIHZhbGlkYXRpb25Ub2tlbikgewogICAgICBmb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGNvbnRyb2wpOwogICAgfSk7CgogICAgYXJyYXlSZW1vdmUoY29udHJvbHMsIGNvbnRyb2wpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRWYWxpZGl0eQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgdmFsaWRpdHkgb2YgYSBmb3JtIGNvbnRyb2wuCiAgICoKICAgKiBUaGlzIG1ldGhvZCB3aWxsIGFsc28gcHJvcGFnYXRlIHRvIHBhcmVudCBmb3Jtcy4KICAgKi8KICBmb3JtLiRzZXRWYWxpZGl0eSA9IGZ1bmN0aW9uKHZhbGlkYXRpb25Ub2tlbiwgaXNWYWxpZCwgY29udHJvbCkgewogICAgdmFyIHF1ZXVlID0gZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl07CgogICAgaWYgKGlzVmFsaWQpIHsKICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgYXJyYXlSZW1vdmUocXVldWUsIGNvbnRyb2wpOwogICAgICAgIGlmICghcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICBpbnZhbGlkQ291bnQtLTsKICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQpOwogICAgICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgIGZvcm0uJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGVycm9yc1t2YWxpZGF0aW9uVG9rZW5dID0gZmFsc2U7CiAgICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBmb3JtKTsKICAgICAgICB9CiAgICAgIH0KCiAgICB9IGVsc2UgewogICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQpOwogICAgICB9CiAgICAgIGlmIChxdWV1ZSkgewogICAgICAgIGlmIChpbmNsdWRlcyhxdWV1ZSwgY29udHJvbCkpIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBlcnJvcnNbdmFsaWRhdGlvblRva2VuXSA9IHF1ZXVlID0gW107CiAgICAgICAgaW52YWxpZENvdW50Kys7CiAgICAgICAgdG9nZ2xlVmFsaWRDc3MoZmFsc2UsIHZhbGlkYXRpb25Ub2tlbik7CiAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCBmYWxzZSwgZm9ybSk7CiAgICAgIH0KICAgICAgcXVldWUucHVzaChjb250cm9sKTsKCiAgICAgIGZvcm0uJHZhbGlkID0gZmFsc2U7CiAgICAgIGZvcm0uJGludmFsaWQgPSB0cnVlOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXREaXJ0eQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgZm9ybSB0byBhIGRpcnR5IHN0YXRlLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byBhZGQgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgZm9ybSB0byBhIGRpcnR5CiAgICogc3RhdGUgKG5nLWRpcnR5IGNsYXNzKS4gVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBwYXJlbnQgZm9ybXMuCiAgICovCiAgZm9ybS4kc2V0RGlydHkgPSBmdW5jdGlvbigpIHsKICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIFBSSVNUSU5FX0NMQVNTKTsKICAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgIGZvcm0uJGRpcnR5ID0gdHJ1ZTsKICAgIGZvcm0uJHByaXN0aW5lID0gZmFsc2U7CiAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRQcmlzdGluZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgZm9ybSB0byBpdHMgcHJpc3RpbmUgc3RhdGUuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBmb3JtIHRvIGl0cyBwcmlzdGluZQogICAqIHN0YXRlIChuZy1wcmlzdGluZSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gYWxsIHRoZSBjb250cm9scyBjb250YWluZWQKICAgKiBpbiB0aGlzIGZvcm0uCiAgICoKICAgKiBTZXR0aW5nIGEgZm9ybSBiYWNrIHRvIGEgcHJpc3RpbmUgc3RhdGUgaXMgb2Z0ZW4gdXNlZnVsIHdoZW4gd2Ugd2FudCB0byAncmV1c2UnIGEgZm9ybSBhZnRlcgogICAqIHNhdmluZyBvciByZXNldHRpbmcgaXQuCiAgICovCiAgZm9ybS4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCBESVJUWV9DTEFTUyk7CiAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCBQUklTVElORV9DTEFTUyk7CiAgICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogICAgZm9ybS4kcHJpc3RpbmUgPSB0cnVlOwogICAgZm9yRWFjaChjb250cm9scywgZnVuY3Rpb24oY29udHJvbCkgewogICAgICBjb250cm9sLiRzZXRQcmlzdGluZSgpOwogICAgfSk7CiAgfTsKfQoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nRm9ybQogKiBAcmVzdHJpY3QgRUFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBOZXN0YWJsZSBhbGlhcyBvZiB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gYGZvcm1gfSBkaXJlY3RpdmUuIEhUTUwKICogZG9lcyBub3QgYWxsb3cgbmVzdGluZyBvZiBmb3JtIGVsZW1lbnRzLiBJdCBpcyB1c2VmdWwgdG8gbmVzdCBmb3JtcywgZm9yIGV4YW1wbGUgaWYgdGhlIHZhbGlkaXR5IG9mIGEKICogc3ViLWdyb3VwIG9mIGNvbnRyb2xzIG5lZWRzIHRvIGJlIGRldGVybWluZWQuCiAqCiAqIE5vdGU6IHRoZSBwdXJwb3NlIG9mIGBuZ0Zvcm1gIGlzIHRvIGdyb3VwIGNvbnRyb2xzLAogKiBidXQgbm90IHRvIGJlIGEgcmVwbGFjZW1lbnQgZm9yIHRoZSBgPGZvcm0+YCB0YWcgd2l0aCBhbGwgb2YgaXRzIGNhcGFiaWxpdGllcwogKiAoZS5nLiBwb3N0aW5nIHRvIHRoZSBzZXJ2ZXIsIC4uLikuCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdGb3JtfG5hbWUgTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICoKICovCgogLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZm9ybQogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogRGlyZWN0aXZlIHRoYXQgaW5zdGFudGlhdGVzCiAqIHtAbGluayBmb3JtLkZvcm1Db250cm9sbGVyIEZvcm1Db250cm9sbGVyfS4KICoKICogSWYgdGhlIGBuYW1lYCBhdHRyaWJ1dGUgaXMgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIGlzIHB1Ymxpc2hlZCBvbnRvIHRoZSBjdXJyZW50IHNjb3BlIHVuZGVyCiAqIHRoaXMgbmFtZS4KICoKICogIyBBbGlhczoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0gYG5nRm9ybWB9CiAqCiAqIEluIEFuZ3VsYXIgZm9ybXMgY2FuIGJlIG5lc3RlZC4gVGhpcyBtZWFucyB0aGF0IHRoZSBvdXRlciBmb3JtIGlzIHZhbGlkIHdoZW4gYWxsIG9mIHRoZSBjaGlsZAogKiBmb3JtcyBhcmUgdmFsaWQgYXMgd2VsbC4gSG93ZXZlciwgYnJvd3NlcnMgZG8gbm90IGFsbG93IG5lc3Rpbmcgb2YgYDxmb3JtPmAgZWxlbWVudHMsIHNvCiAqIEFuZ3VsYXIgcHJvdmlkZXMgdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfSBkaXJlY3RpdmUgd2hpY2ggYmVoYXZlcyBpZGVudGljYWxseSB0bwogKiBgPGZvcm0+YCBidXQgY2FuIGJlIG5lc3RlZC4gIFRoaXMgYWxsb3dzIHlvdSB0byBoYXZlIG5lc3RlZCBmb3Jtcywgd2hpY2ggaXMgdmVyeSB1c2VmdWwgd2hlbgogKiB1c2luZyBBbmd1bGFyIHZhbGlkYXRpb24gZGlyZWN0aXZlcyBpbiBmb3JtcyB0aGF0IGFyZSBkeW5hbWljYWxseSBnZW5lcmF0ZWQgdXNpbmcgdGhlCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgYG5nUmVwZWF0YH0gZGlyZWN0aXZlLiBTaW5jZSB5b3UgY2Fubm90IGR5bmFtaWNhbGx5IGdlbmVyYXRlIHRoZSBgbmFtZWAKICogYXR0cmlidXRlIG9mIGlucHV0IGVsZW1lbnRzIHVzaW5nIGludGVycG9sYXRpb24sIHlvdSBoYXZlIHRvIHdyYXAgZWFjaCBzZXQgb2YgcmVwZWF0ZWQgaW5wdXRzIGluIGFuCiAqIGBuZ0Zvcm1gIGRpcmVjdGl2ZSBhbmQgbmVzdCB0aGVzZSBpbiBhbiBvdXRlciBgZm9ybWAgZWxlbWVudC4KICoKICoKICogIyBDU1MgY2xhc3NlcwogKiAgLSBgbmctdmFsaWRgIGlzIHNldCBpZiB0aGUgZm9ybSBpcyB2YWxpZC4KICogIC0gYG5nLWludmFsaWRgIGlzIHNldCBpZiB0aGUgZm9ybSBpcyBpbnZhbGlkLgogKiAgLSBgbmctcHJpc3RpbmVgIGlzIHNldCBpZiB0aGUgZm9ybSBpcyBwcmlzdGluZS4KICogIC0gYG5nLWRpcnR5YCBpcyBzZXQgaWYgdGhlIGZvcm0gaXMgZGlydHkuCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0IG5nQW5pbWF0ZSBjYW4gZGV0ZWN0IGVhY2ggb2YgdGhlc2UgY2xhc3NlcyB3aGVuIGFkZGVkIGFuZCByZW1vdmVkLgogKgogKgogKiAjIFN1Ym1pdHRpbmcgYSBmb3JtIGFuZCBwcmV2ZW50aW5nIHRoZSBkZWZhdWx0IGFjdGlvbgogKgogKiBTaW5jZSB0aGUgcm9sZSBvZiBmb3JtcyBpbiBjbGllbnQtc2lkZSBBbmd1bGFyIGFwcGxpY2F0aW9ucyBpcyBkaWZmZXJlbnQgdGhhbiBpbiBjbGFzc2ljYWwKICogcm91bmR0cmlwIGFwcHMsIGl0IGlzIGRlc2lyYWJsZSBmb3IgdGhlIGJyb3dzZXIgbm90IHRvIHRyYW5zbGF0ZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGludG8gYSBmdWxsCiAqIHBhZ2UgcmVsb2FkIHRoYXQgc2VuZHMgdGhlIGRhdGEgdG8gdGhlIHNlcnZlci4gSW5zdGVhZCBzb21lIGphdmFzY3JpcHQgbG9naWMgc2hvdWxkIGJlIHRyaWdnZXJlZAogKiB0byBoYW5kbGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbiBhbiBhcHBsaWNhdGlvbi1zcGVjaWZpYyB3YXkuCiAqCiAqIEZvciB0aGlzIHJlYXNvbiwgQW5ndWxhciBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKGZvcm0gc3VibWlzc2lvbiB0byB0aGUgc2VydmVyKSB1bmxlc3MgdGhlCiAqIGA8Zm9ybT5gIGVsZW1lbnQgaGFzIGFuIGBhY3Rpb25gIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCiAqCiAqIFlvdSBjYW4gdXNlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHR3byB3YXlzIHRvIHNwZWNpZnkgd2hhdCBqYXZhc2NyaXB0IG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIHdoZW4KICogYSBmb3JtIGlzIHN1Ym1pdHRlZDoKICoKICogLSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3VibWl0IG5nU3VibWl0fSBkaXJlY3RpdmUgb24gdGhlIGZvcm0gZWxlbWVudAogKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfSBkaXJlY3RpdmUgb24gdGhlIGZpcnN0CiAgKiAgYnV0dG9uIG9yIGlucHV0IGZpZWxkIG9mIHR5cGUgc3VibWl0IChpbnB1dFt0eXBlPXN1Ym1pdF0pCiAqCiAqIFRvIHByZXZlbnQgZG91YmxlIGV4ZWN1dGlvbiBvZiB0aGUgaGFuZGxlciwgdXNlIG9ubHkgb25lIG9mIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3VibWl0IG5nU3VibWl0fQogKiBvciB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30gZGlyZWN0aXZlcy4KICogVGhpcyBpcyBiZWNhdXNlIG9mIHRoZSBmb2xsb3dpbmcgZm9ybSBzdWJtaXNzaW9uIHJ1bGVzIGluIHRoZSBIVE1MIHNwZWNpZmljYXRpb246CiAqCiAqIC0gSWYgYSBmb3JtIGhhcyBvbmx5IG9uZSBpbnB1dCBmaWVsZCB0aGVuIGhpdHRpbmcgZW50ZXIgaW4gdGhpcyBmaWVsZCB0cmlnZ2VycyBmb3JtIHN1Ym1pdAogKiAoYG5nU3VibWl0YCkKICogLSBpZiBhIGZvcm0gaGFzIDIrIGlucHV0IGZpZWxkcyBhbmQgbm8gYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbiBoaXR0aW5nIGVudGVyCiAqIGRvZXNuJ3QgdHJpZ2dlciBzdWJtaXQKICogLSBpZiBhIGZvcm0gaGFzIG9uZSBvciBtb3JlIGlucHV0IGZpZWxkcyBhbmQgb25lIG9yIG1vcmUgYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbgogKiBoaXR0aW5nIGVudGVyIGluIGFueSBvZiB0aGUgaW5wdXQgZmllbGRzIHdpbGwgdHJpZ2dlciB0aGUgY2xpY2sgaGFuZGxlciBvbiB0aGUgKmZpcnN0KiBidXR0b24gb3IKICogaW5wdXRbdHlwZT1zdWJtaXRdIChgbmdDbGlja2ApICphbmQqIGEgc3VibWl0IGhhbmRsZXIgb24gdGhlIGVuY2xvc2luZyBmb3JtIChgbmdTdWJtaXRgKQogKgogKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICoKICogIyMgQW5pbWF0aW9uIEhvb2tzCiAqCiAqIEFuaW1hdGlvbnMgaW4gbmdGb3JtIGFyZSB0cmlnZ2VyZWQgd2hlbiBhbnkgb2YgdGhlIGFzc29jaWF0ZWQgQ1NTIGNsYXNzZXMgYXJlIGFkZGVkIGFuZCByZW1vdmVkLgogKiBUaGVzZSBjbGFzc2VzIGFyZTogYC5uZy1wcmlzdGluZWAsIGAubmctZGlydHlgLCBgLm5nLWludmFsaWRgIGFuZCBgLm5nLXZhbGlkYCBhcyB3ZWxsIGFzIGFueQogKiBvdGhlciB2YWxpZGF0aW9ucyB0aGF0IGFyZSBwZXJmb3JtZWQgd2l0aGluIHRoZSBmb3JtLiBBbmltYXRpb25zIGluIG5nRm9ybSBhcmUgc2ltaWxhciB0byBob3cKICogdGhleSB3b3JrIGluIG5nQ2xhc3MgYW5kIGFuaW1hdGlvbnMgY2FuIGJlIGhvb2tlZCBpbnRvIHVzaW5nIENTUyB0cmFuc2l0aW9ucywga2V5ZnJhbWVzIGFzIHdlbGwKICogYXMgSlMgYW5pbWF0aW9ucy4KICoKICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGEgc2ltcGxlIHdheSB0byB1dGlsaXplIENTUyB0cmFuc2l0aW9ucyB0byBzdHlsZSBhIGZvcm0gZWxlbWVudAogKiB0aGF0IGhhcyBiZWVuIHJlbmRlcmVkIGFzIGludmFsaWQgYWZ0ZXIgaXQgaGFzIGJlZW4gdmFsaWRhdGVkOgogKgogKiA8cHJlPgogKiAvL2JlIHN1cmUgdG8gaW5jbHVkZSBuZ0FuaW1hdGUgYXMgYSBtb2R1bGUgdG8gaG9vayBpbnRvIG1vcmUKICogLy9hZHZhbmNlZCBhbmltYXRpb25zCiAqIC5teS1mb3JtIHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICogfQogKiAubXktZm9ybS5uZy1pbnZhbGlkIHsKICogICBiYWNrZ3JvdW5kOiByZWQ7CiAqICAgY29sb3I6d2hpdGU7CiAqIH0KICogPC9wcmU+CiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZSBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiIGZpeEJhc2U9InRydWUiPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnVzZXJUeXBlID0gJ2d1ZXN0JzsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8c3R5bGU+CiAgICAgICAgLm15LWZvcm0gewogICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICAgICAgfQogICAgICAgIC5teS1mb3JtLm5nLWludmFsaWQgewogICAgICAgICAgYmFja2dyb3VuZDogcmVkOwogICAgICAgIH0KICAgICAgIDwvc3R5bGU+CiAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiIGNsYXNzPSJteS1mb3JtIj4KICAgICAgICAgdXNlclR5cGU6IDxpbnB1dCBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InVzZXJUeXBlIiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+PGJyPgogICAgICAgICA8dHQ+dXNlclR5cGUgPSB7e3VzZXJUeXBlfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgICAgPC9mb3JtPgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHVzZXJUeXBlID0gZWxlbWVudChieS5iaW5kaW5nKCd1c2VyVHlwZScpKTsKICAgICAgICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKCiAgICAgICAgICBleHBlY3QodXNlclR5cGUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2d1ZXN0Jyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXNlclR5cGUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3VzZXJUeXBlJykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIHVzZXJJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXJUeXBlJykpOwoKICAgICAgICAgIHVzZXJJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlcklucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICBleHBlY3QodXNlclR5cGUuZ2V0VGV4dCgpKS50b0VxdWFsKCd1c2VyVHlwZSA9Jyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICoKICovCnZhciBmb3JtRGlyZWN0aXZlRmFjdG9yeSA9IGZ1bmN0aW9uKGlzTmdGb3JtKSB7CiAgcmV0dXJuIFsnJHRpbWVvdXQnLCBmdW5jdGlvbigkdGltZW91dCkgewogICAgdmFyIGZvcm1EaXJlY3RpdmUgPSB7CiAgICAgIG5hbWU6ICdmb3JtJywKICAgICAgcmVzdHJpY3Q6IGlzTmdGb3JtID8gJ0VBQycgOiAnRScsCiAgICAgIGNvbnRyb2xsZXI6IEZvcm1Db250cm9sbGVyLAogICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZm9ybUVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgaWYgKCFhdHRyLmFjdGlvbikgewogICAgICAgICAgICAgIC8vIHdlIGNhbid0IHVzZSBqcSBldmVudHMgYmVjYXVzZSBpZiBhIGZvcm0gaXMgZGVzdHJveWVkIGR1cmluZyBzdWJtaXNzaW9uIHRoZSBkZWZhdWx0CiAgICAgICAgICAgICAgLy8gYWN0aW9uIGlzIG5vdCBwcmV2ZW50ZWQuIHNlZSAjMTIzOAogICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgLy8gSUUgOSBpcyBub3QgYWZmZWN0ZWQgYmVjYXVzZSBpdCBkb2Vzbid0IGZpcmUgYSBzdWJtaXQgZXZlbnQgYW5kIHRyeSB0byBkbyBhIGZ1bGwKICAgICAgICAgICAgICAvLyBwYWdlIHJlbG9hZCBpZiB0aGUgZm9ybSB3YXMgZGVzdHJveWVkIGJ5IHN1Ym1pc3Npb24gb2YgdGhlIGZvcm0gdmlhIGEgY2xpY2sgaGFuZGxlcgogICAgICAgICAgICAgIC8vIG9uIGEgYnV0dG9uIGluIHRoZSBmb3JtLiBMb29rcyBsaWtlIGFuIElFOSBzcGVjaWZpYyBidWcuCiAgICAgICAgICAgICAgdmFyIHByZXZlbnREZWZhdWx0TGlzdGVuZXIgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQKICAgICAgICAgICAgICAgICAgPyBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICAgICAgICAgIDogZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy8gSUUKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKCiAgICAgICAgICAgICAgLy8gdW5yZWdpc3RlciB0aGUgcHJldmVudERlZmF1bHQgbGlzdGVuZXIgc28gdGhhdCB3ZSBkb24ndCBub3QgbGVhayBtZW1vcnkgYnV0IGluIGEKICAgICAgICAgICAgICAvLyB3YXkgdGhhdCB3aWxsIGFjaGlldmUgdGhlIHByZXZlbnRpb24gb2YgdGhlIGRlZmF1bHQgYWN0aW9uLgogICAgICAgICAgICAgIGZvcm1FbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihmb3JtRWxlbWVudFswXSwgJ3N1Ym1pdCcsIHByZXZlbnREZWZhdWx0TGlzdGVuZXIpOwogICAgICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcGFyZW50Rm9ybUN0cmwgPSBmb3JtRWxlbWVudC5wYXJlbnQoKS5jb250cm9sbGVyKCdmb3JtJyksCiAgICAgICAgICAgICAgICBhbGlhcyA9IGF0dHIubmFtZSB8fCBhdHRyLm5nRm9ybTsKCiAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgIHNldHRlcihzY29wZSwgYWxpYXMsIGNvbnRyb2xsZXIsIGFsaWFzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyZW50Rm9ybUN0cmwpIHsKICAgICAgICAgICAgICBmb3JtRWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHBhcmVudEZvcm1DdHJsLiRyZW1vdmVDb250cm9sKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgaWYgKGFsaWFzKSB7CiAgICAgICAgICAgICAgICAgIHNldHRlcihzY29wZSwgYWxpYXMsIHVuZGVmaW5lZCwgYWxpYXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXh0ZW5kKGNvbnRyb2xsZXIsIG51bGxGb3JtQ3RybCk7IC8vc3RvcCBwcm9wYWdhdGluZyBjaGlsZCBkZXN0cnVjdGlvbiBoYW5kbGVycyB1cHdhcmRzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBmb3JtRGlyZWN0aXZlOwogIH1dOwp9OwoKdmFyIGZvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSgpOwp2YXIgbmdGb3JtRGlyZWN0aXZlID0gZm9ybURpcmVjdGl2ZUZhY3RvcnkodHJ1ZSk7CgovKiBnbG9iYWwKCiAgICAtVkFMSURfQ0xBU1MsCiAgICAtSU5WQUxJRF9DTEFTUywKICAgIC1QUklTVElORV9DTEFTUywKICAgIC1ESVJUWV9DTEFTUwoqLwoKdmFyIFVSTF9SRUdFWFAgPSAvXihmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXFMrKSg6WzAtOV0rKT8oXC98XC8oW1x3IyE6Lj8rPSYlQCFcLVwvXSkpPyQvOwp2YXIgRU1BSUxfUkVHRVhQID0gL15bYS16MC05ISMkJSYnKisvPT9eX2B7fH1+Li1dK0BbYS16MC05LV0rKFwuW2EtejAtOS1dKykqJC9pOwp2YXIgTlVNQkVSX1JFR0VYUCA9IC9eXHMqKFwtfFwrKT8oXGQrfChcZCooXC5cZCopKSlccyokLzsKCnZhciBpbnB1dFR5cGUgPSB7CgogIC8qKgogICAqIEBuZ2RvYyBpbnB1dAogICAqIEBuYW1lIGlucHV0W3RleHRdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTdGFuZGFyZCBIVE1MIHRleHQgaW5wdXQgd2l0aCBhbmd1bGFyIGRhdGEgYmluZGluZy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgKiAgICBtaW5sZW5ndGguCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAqICAgIG1heGxlbmd0aC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBbbmdUcmltPXRydWVdIElmIHNldCB0byBmYWxzZSBBbmd1bGFyIHdpbGwgbm90IGF1dG9tYXRpY2FsbHkgdHJpbSB0aGUgaW5wdXQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJ0ZXh0LWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2d1ZXN0JzsKICAgICAgICAgICAgICRzY29wZS53b3JkID0gL15ccypcdypccyokLzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgIFNpbmdsZSB3b3JkOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmctcGF0dGVybj0id29yZCIgcmVxdWlyZWQgbmctdHJpbT0iZmFsc2UiPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnBhdHRlcm4iPgogICAgICAgICAgICAgU2luZ2xlIHdvcmQgb25seSE8L3NwYW4+CgogICAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgPC9mb3JtPgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICAgIHZhciB0ZXh0ID0gZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndGV4dCcpKTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2d1ZXN0Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9FcXVhbCgndGV4dCA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBtdWx0aSB3b3JkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCdoZWxsbyB3b3JsZCcpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ3RleHQnOiB0ZXh0SW5wdXRUeXBlLAoKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbbnVtYmVyXQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGV4dCBpbnB1dCB3aXRoIG51bWJlciB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gU2V0cyB0aGUgYG51bWJlcmAgdmFsaWRhdGlvbgogICAqIGVycm9yIGlmIG5vdCBhIHZhbGlkIG51bWJlci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBtaW4gU2V0cyB0aGUgYG1pbmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgbGVzcyB0aGFuIGBtaW5gLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAqICAgIG1pbmxlbmd0aC4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICogICAgbWF4bGVuZ3RoLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0ibnVtYmVyLWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZSA9IDEyOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgTnVtYmVyOiA8aW5wdXQgdHlwZT0ibnVtYmVyIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InZhbHVlIgogICAgICAgICAgICAgICAgICAgICAgICAgIG1pbj0iMCIgbWF4PSI5OSIgcmVxdWlyZWQ+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IubnVtYmVyIj4KICAgICAgICAgICAgIE5vdCB2YWxpZCBudW1iZXIhPC9zcGFuPgogICAgICAgICAgIDx0dD52YWx1ZSA9IHt7dmFsdWV9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgdmFyIHZhbHVlID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZScpKTsKICAgICAgICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKICAgICAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpOwoKICAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzEyJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCcnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9FcXVhbCgndmFsdWUgPScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgb3ZlciBtYXgnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJzEyMycpOwogICAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAqLwogICdudW1iZXInOiBudW1iZXJJbnB1dFR5cGUsCgoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFt1cmxdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUZXh0IGlucHV0IHdpdGggVVJMIHZhbGlkYXRpb24uIFNldHMgdGhlIGB1cmxgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSBjb250ZW50IGlzIG5vdCBhCiAgICogdmFsaWQgVVJMLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAqICAgIG1pbmxlbmd0aC4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICogICAgbWF4bGVuZ3RoLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0idXJsLWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2h0dHA6Ly9nb29nbGUuY29tJzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgIFVSTDogPGlucHV0IHR5cGU9InVybCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci51cmwiPgogICAgICAgICAgICAgTm90IHZhbGlkIHVybCE8L3NwYW4+CiAgICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IudXJsID0ge3shIW15Rm9ybS4kZXJyb3IudXJsfX08L3R0Pjxici8+CiAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgdmFyIHRleHQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwoKICAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvQ29udGFpbignaHR0cDovL2dvb2dsZS5jb20nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0VxdWFsKCd0ZXh0ID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCB1cmwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJ2JveCcpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ3VybCc6IHVybElucHV0VHlwZSwKCgogIC8qKgogICAqIEBuZ2RvYyBpbnB1dAogICAqIEBuYW1lIGlucHV0W2VtYWlsXQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGV4dCBpbnB1dCB3aXRoIGVtYWlsIHZhbGlkYXRpb24uIFNldHMgdGhlIGBlbWFpbGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgbm90IGEgdmFsaWQgZW1haWwKICAgKiBhZGRyZXNzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAqICAgIG1pbmxlbmd0aC4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICogICAgbWF4bGVuZ3RoLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0iZW1haWwtaW5wdXQtZGlyZWN0aXZlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnbWVAZXhhbXBsZS5jb20nOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIEVtYWlsOiA8aW5wdXQgdHlwZT0iZW1haWwiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIgcmVxdWlyZWQ+CiAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZW1haWwiPgogICAgICAgICAgICAgICBOb3QgdmFsaWQgZW1haWwhPC9zcGFuPgogICAgICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLmVtYWlsID0ge3shIW15Rm9ybS4kZXJyb3IuZW1haWx9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICAgIHZhciB0ZXh0ID0gZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndGV4dCcpKTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ21lQGV4YW1wbGUuY29tJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCcnKTsKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0VxdWFsKCd0ZXh0ID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCBlbWFpbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygneHh4Jyk7CgogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgKi8KICAnZW1haWwnOiBlbWFpbElucHV0VHlwZSwKCgogIC8qKgogICAqIEBuZ2RvYyBpbnB1dAogICAqIEBuYW1lIGlucHV0W3JhZGlvXQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogSFRNTCByYWRpbyBidXR0b24uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gc2VsZWN0ZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nVmFsdWUgQW5ndWxhciBleHByZXNzaW9uIHdoaWNoIHNldHMgdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZAogICAqICAgIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0icmFkaW8taW5wdXQtZGlyZWN0aXZlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLmNvbG9yID0gJ2JsdWUnOwogICAgICAgICAgICAgJHNjb3BlLnNwZWNpYWxWYWx1ZSA9IHsKICAgICAgICAgICAgICAgImlkIjogIjEyMzQ1IiwKICAgICAgICAgICAgICAgInZhbHVlIjogImdyZWVuIgogICAgICAgICAgICAgfTsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0icmVkIj4gIFJlZCA8YnIvPgogICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiBuZy12YWx1ZT0ic3BlY2lhbFZhbHVlIj4gR3JlZW4gPGJyLz4KICAgICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9ImJsdWUiPiBCbHVlIDxici8+CiAgICAgICAgICAgPHR0PmNvbG9yID0ge3tjb2xvciB8IGpzb259fTwvdHQ+PGJyLz4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICAgIE5vdGUgdGhhdCBgbmctdmFsdWU9InNwZWNpYWxWYWx1ZSJgIHNldHMgcmFkaW8gaXRlbSdzIHZhbHVlIHRvIGJlIHRoZSB2YWx1ZSBvZiBgJHNjb3BlLnNwZWNpYWxWYWx1ZWAuCiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNvbG9yID0gZWxlbWVudChieS5iaW5kaW5nKCdjb2xvcicpKTsKCiAgICAgICAgICAgIGV4cGVjdChjb2xvci5nZXRUZXh0KCkpLnRvQ29udGFpbignYmx1ZScpOwoKICAgICAgICAgICAgZWxlbWVudC5hbGwoYnkubW9kZWwoJ2NvbG9yJykpLmdldCgwKS5jbGljaygpOwoKICAgICAgICAgICAgZXhwZWN0KGNvbG9yLmdldFRleHQoKSkudG9Db250YWluKCdyZWQnKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAqLwogICdyYWRpbyc6IHJhZGlvSW5wdXRUeXBlLAoKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbY2hlY2tib3hdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBIVE1MIGNoZWNrYm94LgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nVHJ1ZVZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gc2VsZWN0ZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0ZhbHNlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBub3Qgc2VsZWN0ZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlCiAgICAgIDxleGFtcGxlIG5hbWU9ImNoZWNrYm94LWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZTEgPSB0cnVlOwogICAgICAgICAgICAgJHNjb3BlLnZhbHVlMiA9ICdZRVMnCiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICBWYWx1ZTE6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMSI+IDxici8+CiAgICAgICAgICAgVmFsdWUyOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmctdHJ1ZS12YWx1ZT0iWUVTIiBuZy1mYWxzZS12YWx1ZT0iTk8iPiA8YnIvPgogICAgICAgICAgIDx0dD52YWx1ZTEgPSB7e3ZhbHVlMX19PC90dD48YnIvPgogICAgICAgICAgIDx0dD52YWx1ZTIgPSB7e3ZhbHVlMn19PC90dD48YnIvPgogICAgICAgICAgPC9mb3JtPgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHN0YXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZTEgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlMScpKTsKICAgICAgICAgICAgdmFyIHZhbHVlMiA9IGVsZW1lbnQoYnkuYmluZGluZygndmFsdWUyJykpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMS5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgICBleHBlY3QodmFsdWUyLmdldFRleHQoKSkudG9Db250YWluKCdZRVMnKTsKCiAgICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlMScpKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZTInKSkuY2xpY2soKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZTEuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZTIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ05PJyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgKi8KICAnY2hlY2tib3gnOiBjaGVja2JveElucHV0VHlwZSwKCiAgJ2hpZGRlbic6IG5vb3AsCiAgJ2J1dHRvbic6IG5vb3AsCiAgJ3N1Ym1pdCc6IG5vb3AsCiAgJ3Jlc2V0Jzogbm9vcCwKICAnZmlsZSc6IG5vb3AKfTsKCi8vIEEgaGVscGVyIGZ1bmN0aW9uIHRvIGNhbGwgJHNldFZhbGlkaXR5IGFuZCByZXR1cm4gdGhlIHZhbHVlIC8gdW5kZWZpbmVkLAovLyBhIHBhdHRlcm4gdGhhdCBpcyByZXBlYXRlZCBhIGxvdCBpbiB0aGUgaW5wdXQgdmFsaWRhdGlvbiBsb2dpYy4KZnVuY3Rpb24gdmFsaWRhdGUoY3RybCwgdmFsaWRhdG9yTmFtZSwgdmFsaWRpdHksIHZhbHVlKXsKICBjdHJsLiRzZXRWYWxpZGl0eSh2YWxpZGF0b3JOYW1lLCB2YWxpZGl0eSk7CiAgcmV0dXJuIHZhbGlkaXR5ID8gdmFsdWUgOiB1bmRlZmluZWQ7Cn0KCgpmdW5jdGlvbiBhZGROYXRpdmVIdG1sNVZhbGlkYXRvcnMoY3RybCwgdmFsaWRhdG9yTmFtZSwgZWxlbWVudCkgewogIHZhciB2YWxpZGl0eSA9IGVsZW1lbnQucHJvcCgndmFsaWRpdHknKTsKICBpZiAoaXNPYmplY3QodmFsaWRpdHkpKSB7CiAgICB2YXIgdmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgLy8gRG9uJ3Qgb3ZlcndyaXRlIHByZXZpb3VzIHZhbGlkYXRpb24sIGRvbid0IGNvbnNpZGVyIHZhbHVlTWlzc2luZyB0byBhcHBseSAobmctcmVxdWlyZWQgY2FuCiAgICAgIC8vIHBlcmZvcm0gdGhlIHJlcXVpcmVkIHZhbGlkYXRpb24pCiAgICAgIGlmICghY3RybC4kZXJyb3JbdmFsaWRhdG9yTmFtZV0gJiYgKHZhbGlkaXR5LmJhZElucHV0IHx8IHZhbGlkaXR5LmN1c3RvbUVycm9yIHx8CiAgICAgICAgICB2YWxpZGl0eS50eXBlTWlzbWF0Y2gpICYmICF2YWxpZGl0eS52YWx1ZU1pc3NpbmcpIHsKICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSh2YWxpZGF0b3JOYW1lLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH07CiAgICBjdHJsLiRwYXJzZXJzLnB1c2godmFsaWRhdG9yKTsKICB9Cn0KCmZ1bmN0aW9uIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogIHZhciB2YWxpZGl0eSA9IGVsZW1lbnQucHJvcCgndmFsaWRpdHknKTsKICB2YXIgcGxhY2Vob2xkZXIgPSBlbGVtZW50WzBdLnBsYWNlaG9sZGVyLCBub2V2ZW50ID0ge307CgogIC8vIEluIGNvbXBvc2l0aW9uIG1vZGUsIHVzZXJzIGFyZSBzdGlsbCBpbnB1dGluZyBpbnRlcm1lZGlhdGUgdGV4dCBidWZmZXIsCiAgLy8gaG9sZCB0aGUgbGlzdGVuZXIgdW50aWwgY29tcG9zaXRpb24gaXMgZG9uZS4KICAvLyBNb3JlIGFib3V0IGNvbXBvc2l0aW9uIGV2ZW50czogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0NvbXBvc2l0aW9uRXZlbnQKICBpZiAoISRzbmlmZmVyLmFuZHJvaWQpIHsKICAgIHZhciBjb21wb3NpbmcgPSBmYWxzZTsKCiAgICBlbGVtZW50Lm9uKCdjb21wb3NpdGlvbnN0YXJ0JywgZnVuY3Rpb24oZGF0YSkgewogICAgICBjb21wb3NpbmcgPSB0cnVlOwogICAgfSk7CgogICAgZWxlbWVudC5vbignY29tcG9zaXRpb25lbmQnLCBmdW5jdGlvbigpIHsKICAgICAgY29tcG9zaW5nID0gZmFsc2U7CiAgICAgIGxpc3RlbmVyKCk7CiAgICB9KTsKICB9CgogIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKGV2KSB7CiAgICBpZiAoY29tcG9zaW5nKSByZXR1cm47CiAgICB2YXIgdmFsdWUgPSBlbGVtZW50LnZhbCgpOwoKICAgIC8vIElFICgxMSBhbmQgdW5kZXIpIHNlZW0gdG8gZW1pdCBhbiAnaW5wdXQnIGV2ZW50IGlmIHRoZSBwbGFjZWhvbGRlciB2YWx1ZSBjaGFuZ2VzLgogICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBkaXJ0eSB0aGUgdmFsdWUgd2hlbiB0aGlzIGhhcHBlbnMsIHNvIHdlIGFib3J0IGhlcmUuIFVuZm9ydHVuYXRlbHksCiAgICAvLyBJRSBhbHNvIHNlbmRzIGlucHV0IGV2ZW50cyBmb3Igb3RoZXIgbm9uLWlucHV0LXJlbGF0ZWQgdGhpbmdzLCAoc3VjaCBhcyBmb2N1c2luZyBvbiBhCiAgICAvLyBmb3JtIGNvbnRyb2wpLCBzbyB0aGlzIGNoYW5nZSBpcyBub3QgZW50aXJlbHkgZW5vdWdoIHRvIHNvbHZlIHRoaXMuCiAgICBpZiAobXNpZSAmJiAoZXYgfHwgbm9ldmVudCkudHlwZSA9PT0gJ2lucHV0JyAmJiBlbGVtZW50WzBdLnBsYWNlaG9sZGVyICE9PSBwbGFjZWhvbGRlcikgewogICAgICBwbGFjZWhvbGRlciA9IGVsZW1lbnRbMF0ucGxhY2Vob2xkZXI7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBCeSBkZWZhdWx0IHdlIHdpbGwgdHJpbSB0aGUgdmFsdWUKICAgIC8vIElmIHRoZSBhdHRyaWJ1dGUgbmctdHJpbSBleGlzdHMgd2Ugd2lsbCBhdm9pZCB0cmltbWluZwogICAgLy8gZS5nLiA8aW5wdXQgbmctbW9kZWw9ImZvbyIgbmctdHJpbT0iZmFsc2UiPgogICAgaWYgKHRvQm9vbGVhbihhdHRyLm5nVHJpbSB8fCAnVCcpKSB7CiAgICAgIHZhbHVlID0gdHJpbSh2YWx1ZSk7CiAgICB9CgogICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUgfHwKICAgICAgICAvLyBJZiB0aGUgdmFsdWUgaXMgc3RpbGwgZW1wdHkvZmFsc3ksIGFuZCB0aGVyZSBpcyBubyBgcmVxdWlyZWRgIGVycm9yLCBydW4gdmFsaWRhdG9ycwogICAgICAgIC8vIGFnYWluLiBUaGlzIGVuYWJsZXMgSFRNTDUgY29uc3RyYWludCB2YWxpZGF0aW9uIGVycm9ycyB0byBhZmZlY3QgQW5ndWxhciB2YWxpZGF0aW9uCiAgICAgICAgLy8gZXZlbiB3aGVuIHRoZSBmaXJzdCBjaGFyYWN0ZXIgZW50ZXJlZCBjYXVzZXMgYW4gZXJyb3IuCiAgICAgICAgKHZhbGlkaXR5ICYmIHZhbHVlID09PSAnJyAmJiAhdmFsaWRpdHkudmFsdWVNaXNzaW5nKSkgewogICAgICBpZiAoc2NvcGUuJCRwaGFzZSkgewogICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZSh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CgogIC8vIGlmIHRoZSBicm93c2VyIGRvZXMgc3VwcG9ydCAiaW5wdXQiIGV2ZW50LCB3ZSBhcmUgZmluZSAtIGV4Y2VwdCBvbiBJRTkgd2hpY2ggZG9lc24ndCBmaXJlIHRoZQogIC8vIGlucHV0IGV2ZW50IG9uIGJhY2tzcGFjZSwgZGVsZXRlIG9yIGN1dAogIGlmICgkc25pZmZlci5oYXNFdmVudCgnaW5wdXQnKSkgewogICAgZWxlbWVudC5vbignaW5wdXQnLCBsaXN0ZW5lcik7CiAgfSBlbHNlIHsKICAgIHZhciB0aW1lb3V0OwoKICAgIHZhciBkZWZlckxpc3RlbmVyID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGltZW91dCkgewogICAgICAgIHRpbWVvdXQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICBlbGVtZW50Lm9uKCdrZXlkb3duJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdmFyIGtleSA9IGV2ZW50LmtleUNvZGU7CgogICAgICAvLyBpZ25vcmUKICAgICAgLy8gICAgY29tbWFuZCAgICAgICAgICAgIG1vZGlmaWVycyAgICAgICAgICAgICAgICAgICBhcnJvd3MKICAgICAgaWYgKGtleSA9PT0gOTEgfHwgKDE1IDwga2V5ICYmIGtleSA8IDE5KSB8fCAoMzcgPD0ga2V5ICYmIGtleSA8PSA0MCkpIHJldHVybjsKCiAgICAgIGRlZmVyTGlzdGVuZXIoKTsKICAgIH0pOwoKICAgIC8vIGlmIHVzZXIgbW9kaWZpZXMgaW5wdXQgdmFsdWUgdXNpbmcgY29udGV4dCBtZW51IGluIElFLCB3ZSBuZWVkICJwYXN0ZSIgYW5kICJjdXQiIGV2ZW50cyB0byBjYXRjaCBpdAogICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdwYXN0ZScpKSB7CiAgICAgIGVsZW1lbnQub24oJ3Bhc3RlIGN1dCcsIGRlZmVyTGlzdGVuZXIpOwogICAgfQogIH0KCiAgLy8gaWYgdXNlciBwYXN0ZSBpbnRvIGlucHV0IHVzaW5nIG1vdXNlIG9uIG9sZGVyIGJyb3dzZXIKICAvLyBvciBmb3JtIGF1dG9jb21wbGV0ZSBvbiBuZXdlciBicm93c2VyLCB3ZSBuZWVkICJjaGFuZ2UiIGV2ZW50IHRvIGNhdGNoIGl0CiAgZWxlbWVudC5vbignY2hhbmdlJywgbGlzdGVuZXIpOwoKICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgIGVsZW1lbnQudmFsKGN0cmwuJGlzRW1wdHkoY3RybC4kdmlld1ZhbHVlKSA/ICcnIDogY3RybC4kdmlld1ZhbHVlKTsKICB9OwoKICAvLyBwYXR0ZXJuIHZhbGlkYXRvcgogIHZhciBwYXR0ZXJuID0gYXR0ci5uZ1BhdHRlcm4sCiAgICAgIHBhdHRlcm5WYWxpZGF0b3IsCiAgICAgIG1hdGNoOwoKICBpZiAocGF0dGVybikgewogICAgdmFyIHZhbGlkYXRlUmVnZXggPSBmdW5jdGlvbihyZWdleHAsIHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAncGF0dGVybicsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IHJlZ2V4cC50ZXN0KHZhbHVlKSwgdmFsdWUpOwogICAgfTsKICAgIG1hdGNoID0gcGF0dGVybi5tYXRjaCgvXlwvKC4qKVwvKFtnaW1dKikkLyk7CiAgICBpZiAobWF0Y2gpIHsKICAgICAgcGF0dGVybiA9IG5ldyBSZWdFeHAobWF0Y2hbMV0sIG1hdGNoWzJdKTsKICAgICAgcGF0dGVyblZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlUmVnZXgocGF0dGVybiwgdmFsdWUpOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgcGF0dGVyblZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIHBhdHRlcm5PYmogPSBzY29wZS4kZXZhbChwYXR0ZXJuKTsKCiAgICAgICAgaWYgKCFwYXR0ZXJuT2JqIHx8ICFwYXR0ZXJuT2JqLnRlc3QpIHsKICAgICAgICAgIHRocm93IG1pbkVycignbmdQYXR0ZXJuJykoJ25vcmVnZXhwJywKICAgICAgICAgICAgJ0V4cGVjdGVkIHswfSB0byBiZSBhIFJlZ0V4cCBidXQgd2FzIHsxfS4gRWxlbWVudDogezJ9JywgcGF0dGVybiwKICAgICAgICAgICAgcGF0dGVybk9iaiwgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsaWRhdGVSZWdleChwYXR0ZXJuT2JqLCB2YWx1ZSk7CiAgICAgIH07CiAgICB9CgogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogIH0KCiAgLy8gbWluIGxlbmd0aCB2YWxpZGF0b3IKICBpZiAoYXR0ci5uZ01pbmxlbmd0aCkgewogICAgdmFyIG1pbmxlbmd0aCA9IGludChhdHRyLm5nTWlubGVuZ3RoKTsKICAgIHZhciBtaW5MZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ21pbmxlbmd0aCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlLmxlbmd0aCA+PSBtaW5sZW5ndGgsIHZhbHVlKTsKICAgIH07CgogICAgY3RybC4kcGFyc2Vycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWluTGVuZ3RoVmFsaWRhdG9yKTsKICB9CgogIC8vIG1heCBsZW5ndGggdmFsaWRhdG9yCiAgaWYgKGF0dHIubmdNYXhsZW5ndGgpIHsKICAgIHZhciBtYXhsZW5ndGggPSBpbnQoYXR0ci5uZ01heGxlbmd0aCk7CiAgICB2YXIgbWF4TGVuZ3RoVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICdtYXhsZW5ndGgnLCBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCB2YWx1ZS5sZW5ndGggPD0gbWF4bGVuZ3RoLCB2YWx1ZSk7CiAgICB9OwoKICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhMZW5ndGhWYWxpZGF0b3IpOwogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1heExlbmd0aFZhbGlkYXRvcik7CiAgfQp9CgpmdW5jdGlvbiBudW1iZXJJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgdmFyIGVtcHR5ID0gY3RybC4kaXNFbXB0eSh2YWx1ZSk7CiAgICBpZiAoZW1wdHkgfHwgTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgdHJ1ZSk7CiAgICAgIHJldHVybiB2YWx1ZSA9PT0gJycgPyBudWxsIDogKGVtcHR5ID8gdmFsdWUgOiBwYXJzZUZsb2F0KHZhbHVlKSk7CiAgICB9IGVsc2UgewogICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgZmFsc2UpOwogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogIH0pOwoKICBhZGROYXRpdmVIdG1sNVZhbGlkYXRvcnMoY3RybCwgJ251bWJlcicsIGVsZW1lbnQpOwoKICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBjdHJsLiRpc0VtcHR5KHZhbHVlKSA/ICcnIDogJycgKyB2YWx1ZTsKICB9KTsKCiAgaWYgKGF0dHIubWluKSB7CiAgICB2YXIgbWluVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIG1pbiA9IHBhcnNlRmxvYXQoYXR0ci5taW4pOwogICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ21pbicsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlID49IG1pbiwgdmFsdWUpOwogICAgfTsKCiAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluVmFsaWRhdG9yKTsKICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogIH0KCiAgaWYgKGF0dHIubWF4KSB7CiAgICB2YXIgbWF4VmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIG1heCA9IHBhcnNlRmxvYXQoYXR0ci5tYXgpOwogICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ21heCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlIDw9IG1heCwgdmFsdWUpOwogICAgfTsKCiAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWF4VmFsaWRhdG9yKTsKICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogIH0KCiAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ251bWJlcicsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IGlzTnVtYmVyKHZhbHVlKSwgdmFsdWUpOwogIH0pOwp9CgpmdW5jdGlvbiB1cmxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogIHZhciB1cmxWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICd1cmwnLCBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCBVUkxfUkVHRVhQLnRlc3QodmFsdWUpLCB2YWx1ZSk7CiAgfTsKCiAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHVybFZhbGlkYXRvcik7CiAgY3RybC4kcGFyc2Vycy5wdXNoKHVybFZhbGlkYXRvcik7Cn0KCmZ1bmN0aW9uIGVtYWlsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICB2YXIgZW1haWxWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICdlbWFpbCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKSwgdmFsdWUpOwogIH07CgogIGN0cmwuJGZvcm1hdHRlcnMucHVzaChlbWFpbFZhbGlkYXRvcik7CiAgY3RybC4kcGFyc2Vycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKfQoKZnVuY3Rpb24gcmFkaW9JbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAvLyBtYWtlIHRoZSBuYW1lIHVuaXF1ZSwgaWYgbm90IGRlZmluZWQKICBpZiAoaXNVbmRlZmluZWQoYXR0ci5uYW1lKSkgewogICAgZWxlbWVudC5hdHRyKCduYW1lJywgbmV4dFVpZCgpKTsKICB9CgogIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICBpZiAoZWxlbWVudFswXS5jaGVja2VkKSB7CiAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUoYXR0ci52YWx1ZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwoKICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciB2YWx1ZSA9IGF0dHIudmFsdWU7CiAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICB9OwoKICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7Cn0KCmZ1bmN0aW9uIGNoZWNrYm94SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgdmFyIHRydWVWYWx1ZSA9IGF0dHIubmdUcnVlVmFsdWUsCiAgICAgIGZhbHNlVmFsdWUgPSBhdHRyLm5nRmFsc2VWYWx1ZTsKCiAgaWYgKCFpc1N0cmluZyh0cnVlVmFsdWUpKSB0cnVlVmFsdWUgPSB0cnVlOwogIGlmICghaXNTdHJpbmcoZmFsc2VWYWx1ZSkpIGZhbHNlVmFsdWUgPSBmYWxzZTsKCiAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGVsZW1lbnRbMF0uY2hlY2tlZCk7CiAgICB9KTsKICB9KTsKCiAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSBjdHJsLiR2aWV3VmFsdWU7CiAgfTsKCiAgLy8gT3ZlcnJpZGUgdGhlIHN0YW5kYXJkIGAkaXNFbXB0eWAgYmVjYXVzZSBhIHZhbHVlIG9mIGBmYWxzZWAgbWVhbnMgZW1wdHkgaW4gYSBjaGVja2JveC4KICBjdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPT0gdHJ1ZVZhbHVlOwogIH07CgogIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSB0cnVlVmFsdWU7CiAgfSk7CgogIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID8gdHJ1ZVZhbHVlIDogZmFsc2VWYWx1ZTsKICB9KTsKfQoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIHRleHRhcmVhCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBIVE1MIHRleHRhcmVhIGVsZW1lbnQgY29udHJvbCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLiBUaGUgZGF0YS1iaW5kaW5nIGFuZCB2YWxpZGF0aW9uCiAqIHByb3BlcnRpZXMgb2YgdGhpcyBlbGVtZW50IGFyZSBleGFjdGx5IHRoZSBzYW1lIGFzIHRob3NlIG9mIHRoZQogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0IGVsZW1lbnR9LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAqICAgIG1pbmxlbmd0aC4KICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogKiAgICBtYXhsZW5ndGguCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW5wdXQKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIEhUTUwgaW5wdXQgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIElucHV0IGNvbnRyb2wgZm9sbG93cyBIVE1MNSBpbnB1dCB0eXBlcwogKiBhbmQgcG9seWZpbGxzIHRoZSBIVE1MNSB2YWxpZGF0aW9uIGJlaGF2aW9yIGZvciBvbGRlciBicm93c2Vycy4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICogQHBhcmFtIHtib29sZWFuPX0gbmdSZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGlmIHNldCB0byB0cnVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAqICAgIG1pbmxlbmd0aC4KICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogKiAgICBtYXhsZW5ndGguCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlIG5hbWU9ImlucHV0LWRpcmVjdGl2ZSI+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlciA9IHtuYW1lOiAnZ3Vlc3QnLCBsYXN0OiAndmlzaXRvcid9OwogICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgICAgICAgVXNlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXNlck5hbWUiIG5nLW1vZGVsPSJ1c2VyLm5hbWUiIHJlcXVpcmVkPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLnVzZXJOYW1lLiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+PGJyPgogICAgICAgICAgIExhc3QgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9Imxhc3ROYW1lIiBuZy1tb2RlbD0idXNlci5sYXN0IgogICAgICAgICAgICAgbmctbWlubGVuZ3RoPSIzIiBuZy1tYXhsZW5ndGg9IjEwIj4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWlubGVuZ3RoIj4KICAgICAgICAgICAgIFRvbyBzaG9ydCE8L3NwYW4+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubGFzdE5hbWUuJGVycm9yLm1heGxlbmd0aCI+CiAgICAgICAgICAgICBUb28gbG9uZyE8L3NwYW4+PGJyPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDxocj4KICAgICAgICAgPHR0PnVzZXIgPSB7e3VzZXJ9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS51c2VyTmFtZS4kdmFsaWQgPSB7e215Rm9ybS51c2VyTmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLnVzZXJOYW1lLiRlcnJvciA9IHt7bXlGb3JtLnVzZXJOYW1lLiRlcnJvcn19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJHZhbGlkID0ge3tteUZvcm0ubGFzdE5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kZXJyb3IgPSB7e215Rm9ybS5sYXN0TmFtZS4kZXJyb3J9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5taW5sZW5ndGggPSB7eyEhbXlGb3JtLiRlcnJvci5taW5sZW5ndGh9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5tYXhsZW5ndGggPSB7eyEhbXlGb3JtLiRlcnJvci5tYXhsZW5ndGh9fTwvdHQ+PGJyPgogICAgICAgPC9kaXY+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgdmFyIHVzZXIgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3t7dXNlcn19JykpOwogICAgICAgIHZhciB1c2VyTmFtZVZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpOwogICAgICAgIHZhciBsYXN0TmFtZVZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpOwogICAgICAgIHZhciBsYXN0TmFtZUVycm9yID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJGVycm9yJykpOwogICAgICAgIHZhciBmb3JtVmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSk7CiAgICAgICAgdmFyIHVzZXJOYW1lSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd1c2VyLm5hbWUnKSk7CiAgICAgICAgdmFyIHVzZXJMYXN0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd1c2VyLmxhc3QnKSk7CgogICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibmFtZSI6Imd1ZXN0IiwibGFzdCI6InZpc2l0b3IifScpOwogICAgICAgICAgZXhwZWN0KHVzZXJOYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5IHdoZW4gcmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzZXJOYW1lSW5wdXQuY2xlYXIoKTsKICAgICAgICAgIHVzZXJOYW1lSW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Imxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdCh1c2VyTmFtZVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSB2YWxpZCBpZiBlbXB0eSB3aGVuIG1pbiBsZW5ndGggaXMgc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2VyTGFzdElucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VyTGFzdElucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoiIn0nKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsZXNzIHRoYW4gcmVxdWlyZWQgbWluIGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlckxhc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlckxhc3RJbnB1dC5zZW5kS2V5cygneHgnKTsKCiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QifScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVFcnJvci5nZXRUZXh0KCkpLnRvQ29udGFpbignbWlubGVuZ3RoJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbG9uZ2VyIHRoYW4gbWF4IGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlckxhc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlckxhc3RJbnB1dC5zZW5kS2V5cygnc29tZSByaWRpY3Vsb3VzbHkgbG9uZyBuYW1lJyk7CgogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lRXJyb3IuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ21heGxlbmd0aCcpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIGlucHV0RGlyZWN0aXZlID0gWyckYnJvd3NlcicsICckc25pZmZlcicsIGZ1bmN0aW9uKCRicm93c2VyLCAkc25pZmZlcikgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgIGlmIChjdHJsKSB7CiAgICAgICAgKGlucHV0VHlwZVtsb3dlcmNhc2UoYXR0ci50eXBlKV0gfHwgaW5wdXRUeXBlLnRleHQpKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIpOwogICAgICB9CiAgICB9CiAgfTsKfV07Cgp2YXIgVkFMSURfQ0xBU1MgPSAnbmctdmFsaWQnLAogICAgSU5WQUxJRF9DTEFTUyA9ICduZy1pbnZhbGlkJywKICAgIFBSSVNUSU5FX0NMQVNTID0gJ25nLXByaXN0aW5lJywKICAgIERJUlRZX0NMQVNTID0gJ25nLWRpcnR5JzsKCi8qKgogKiBAbmdkb2MgdHlwZQogKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyCiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSAkdmlld1ZhbHVlIEFjdHVhbCBzdHJpbmcgdmFsdWUgaW4gdGhlIHZpZXcuCiAqIEBwcm9wZXJ0eSB7Kn0gJG1vZGVsVmFsdWUgVGhlIHZhbHVlIGluIHRoZSBtb2RlbCwgdGhhdCB0aGUgY29udHJvbCBpcyBib3VuZCB0by4KICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkcGFyc2VycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgICAgIHRoZSBjb250cm9sIHJlYWRzIHZhbHVlIGZyb20gdGhlIERPTS4gIEVhY2ggZnVuY3Rpb24gaXMgY2FsbGVkLCBpbiB0dXJuLCBwYXNzaW5nIHRoZSB2YWx1ZQogICAgICAgdGhyb3VnaCB0byB0aGUgbmV4dC4gVGhlIGxhc3QgcmV0dXJuIHZhbHVlIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG1vZGVsLgogICAgICAgVXNlZCB0byBzYW5pdGl6ZSAvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGlvbi4gRm9yIHZhbGlkYXRpb24sCiAgICAgICB0aGUgcGFyc2VycyBzaG91bGQgdXBkYXRlIHRoZSB2YWxpZGl0eSBzdGF0ZSB1c2luZwogICAgICAge0BsaW5rIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5ICRzZXRWYWxpZGl0eSgpfSwKICAgICAgIGFuZCByZXR1cm4gYHVuZGVmaW5lZGAgZm9yIGludmFsaWQgdmFsdWVzLgoKICoKICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkZm9ybWF0dGVycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgICAgIHRoZSBtb2RlbCB2YWx1ZSBjaGFuZ2VzLiBFYWNoIGZ1bmN0aW9uIGlzIGNhbGxlZCwgaW4gdHVybiwgcGFzc2luZyB0aGUgdmFsdWUgdGhyb3VnaCB0byB0aGUKICAgICAgIG5leHQuIFVzZWQgdG8gZm9ybWF0IC8gY29udmVydCB2YWx1ZXMgZm9yIGRpc3BsYXkgaW4gdGhlIGNvbnRyb2wgYW5kIHZhbGlkYXRpb24uCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIGZvcm1hdHRlcih2YWx1ZSkgewogKiAgIGlmICh2YWx1ZSkgewogKiAgICAgcmV0dXJuIHZhbHVlLnRvVXBwZXJDYXNlKCk7CiAqICAgfQogKiB9CiAqIG5nTW9kZWwuJGZvcm1hdHRlcnMucHVzaChmb3JtYXR0ZXIpOwogKiBgYGAKICoKICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkdmlld0NoYW5nZUxpc3RlbmVycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSB3aGVuZXZlciB0aGUKICogICAgIHZpZXcgdmFsdWUgaGFzIGNoYW5nZWQuIEl0IGlzIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cywgYW5kIGl0cyByZXR1cm4gdmFsdWUgaXMgaWdub3JlZC4KICogICAgIFRoaXMgY2FuIGJlIHVzZWQgaW4gcGxhY2Ugb2YgYWRkaXRpb25hbCAkd2F0Y2hlcyBhZ2FpbnN0IHRoZSBtb2RlbCB2YWx1ZS4KICoKICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBvYmplY3QgaGFzaCB3aXRoIGFsbCBlcnJvcnMgYXMga2V5cy4KICoKICogQHByb3BlcnR5IHtib29sZWFufSAkcHJpc3RpbmUgVHJ1ZSBpZiB1c2VyIGhhcyBub3QgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sIHlldC4KICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbC4KICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiB0aGVyZSBpcyBubyBlcnJvci4KICogQHByb3BlcnR5IHtib29sZWFufSAkaW52YWxpZCBUcnVlIGlmIGF0IGxlYXN0IG9uZSBlcnJvciBvbiB0aGUgY29udHJvbC4KICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgQVBJIGZvciB0aGUgYG5nLW1vZGVsYCBkaXJlY3RpdmUuIFRoZSBjb250cm9sbGVyIGNvbnRhaW5zCiAqIHNlcnZpY2VzIGZvciBkYXRhLWJpbmRpbmcsIHZhbGlkYXRpb24sIENTUyB1cGRhdGVzLCBhbmQgdmFsdWUgZm9ybWF0dGluZyBhbmQgcGFyc2luZy4gSXQKICogcHVycG9zZWZ1bGx5IGRvZXMgbm90IGNvbnRhaW4gYW55IGxvZ2ljIHdoaWNoIGRlYWxzIHdpdGggRE9NIHJlbmRlcmluZyBvciBsaXN0ZW5pbmcgdG8KICogRE9NIGV2ZW50cy4gU3VjaCBET00gcmVsYXRlZCBsb2dpYyBzaG91bGQgYmUgcHJvdmlkZWQgYnkgb3RoZXIgZGlyZWN0aXZlcyB3aGljaCBtYWtlIHVzZSBvZgogKiBgTmdNb2RlbENvbnRyb2xsZXJgIGZvciBkYXRhLWJpbmRpbmcuCiAqCiAqICMjIEN1c3RvbSBDb250cm9sIEV4YW1wbGUKICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0byB1c2UgYE5nTW9kZWxDb250cm9sbGVyYCB3aXRoIGEgY3VzdG9tIGNvbnRyb2wgdG8gYWNoaWV2ZQogKiBkYXRhLWJpbmRpbmcuIE5vdGljZSBob3cgZGlmZmVyZW50IGRpcmVjdGl2ZXMgKGBjb250ZW50ZWRpdGFibGVgLCBgbmctbW9kZWxgLCBhbmQgYHJlcXVpcmVkYCkKICogY29sbGFib3JhdGUgdG9nZXRoZXIgdG8gYWNoaWV2ZSB0aGUgZGVzaXJlZCByZXN1bHQuCiAqCiAqIE5vdGUgdGhhdCBgY29udGVudGVkaXRhYmxlYCBpcyBhbiBIVE1MNSBhdHRyaWJ1dGUsIHdoaWNoIHRlbGxzIHRoZSBicm93c2VyIHRvIGxldCB0aGUgZWxlbWVudAogKiBjb250ZW50cyBiZSBlZGl0ZWQgaW4gcGxhY2UgYnkgdGhlIHVzZXIuICBUaGlzIHdpbGwgbm90IHdvcmsgb24gb2xkZXIgYnJvd3NlcnMuCiAqCiAqIFdlIGFyZSB1c2luZyB0aGUge0BsaW5rIG5nLnNlcnZpY2U6JHNjZSAkc2NlfSBzZXJ2aWNlIGhlcmUgYW5kIGluY2x1ZGUgdGhlIHtAbGluayBuZ1Nhbml0aXplICRzYW5pdGl6ZX0KICogbW9kdWxlIHRvIGF1dG9tYXRpY2FsbHkgcmVtb3ZlICJiYWQiIGNvbnRlbnQgbGlrZSBpbmxpbmUgZXZlbnQgbGlzdGVuZXIgKGUuZy4gYDxzcGFuIG9uY2xpY2s9Ii4uLiI+YCkuCiAqIEhvd2V2ZXIsIGFzIHdlIGFyZSB1c2luZyBgJHNjZWAgdGhlIG1vZGVsIGNhbiBzdGlsbCBkZWNpZGUgdG8gdG8gcHJvdmlkZSB1bnNhZmUgY29udGVudCBpZiBpdCBtYXJrcwogKiB0aGF0IGNvbnRlbnQgdXNpbmcgdGhlIGAkc2NlYCBzZXJ2aWNlLgogKgogKiA8ZXhhbXBsZSBuYW1lPSJOZ01vZGVsQ29udHJvbGxlciIgbW9kdWxlPSJjdXN0b21Db250cm9sIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgIFtjb250ZW50ZWRpdGFibGVdIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgICBtaW4taGVpZ2h0OiAyMHB4OwogICAgICB9CgogICAgICAubmctaW52YWxpZCB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmVkOwogICAgICB9CgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUNvbnRyb2wnLCBbJ25nU2FuaXRpemUnXSkuCiAgICAgICAgZGlyZWN0aXZlKCdjb250ZW50ZWRpdGFibGUnLCBbJyRzY2UnLCBmdW5jdGlvbigkc2NlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0EnLCAvLyBvbmx5IGFjdGl2YXRlIG9uIGVsZW1lbnQgYXR0cmlidXRlCiAgICAgICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsIC8vIGdldCBhIGhvbGQgb2YgTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBuZ01vZGVsKSB7CiAgICAgICAgICAgICAgaWYoIW5nTW9kZWwpIHJldHVybjsgLy8gZG8gbm90aGluZyBpZiBubyBuZy1tb2RlbAoKICAgICAgICAgICAgICAvLyBTcGVjaWZ5IGhvdyBVSSBzaG91bGQgYmUgdXBkYXRlZAogICAgICAgICAgICAgIG5nTW9kZWwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKCRzY2UuZ2V0VHJ1c3RlZEh0bWwobmdNb2RlbC4kdmlld1ZhbHVlIHx8ICcnKSk7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciBjaGFuZ2UgZXZlbnRzIHRvIGVuYWJsZSBiaW5kaW5nCiAgICAgICAgICAgICAgZWxlbWVudC5vbignYmx1ciBrZXl1cCBjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShyZWFkKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZWFkKCk7IC8vIGluaXRpYWxpemUKCiAgICAgICAgICAgICAgLy8gV3JpdGUgZGF0YSB0byB0aGUgbW9kZWwKICAgICAgICAgICAgICBmdW5jdGlvbiByZWFkKCkgewogICAgICAgICAgICAgICAgdmFyIGh0bWwgPSBlbGVtZW50Lmh0bWwoKTsKICAgICAgICAgICAgICAgIC8vIFdoZW4gd2UgY2xlYXIgdGhlIGNvbnRlbnQgZWRpdGFibGUgdGhlIGJyb3dzZXIgbGVhdmVzIGEgPGJyPiBiZWhpbmQKICAgICAgICAgICAgICAgIC8vIElmIHN0cmlwLWJyIGF0dHJpYnV0ZSBpcyBwcm92aWRlZCB0aGVuIHdlIHN0cmlwIHRoaXMgb3V0CiAgICAgICAgICAgICAgICBpZiggYXR0cnMuc3RyaXBCciAmJiBodG1sID09ICc8YnI+JyApIHsKICAgICAgICAgICAgICAgICAgaHRtbCA9ICcnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmdNb2RlbC4kc2V0Vmlld1ZhbHVlKGh0bWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9XSk7CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIj4KICAgICAgIDxkaXYgY29udGVudGVkaXRhYmxlCiAgICAgICAgICAgIG5hbWU9Im15V2lkZ2V0IiBuZy1tb2RlbD0idXNlckNvbnRlbnQiCiAgICAgICAgICAgIHN0cmlwLWJyPSJ0cnVlIgogICAgICAgICAgICByZXF1aXJlZD5DaGFuZ2UgbWUhPC9kaXY+CiAgICAgICAgPHNwYW4gbmctc2hvdz0ibXlGb3JtLm15V2lkZ2V0LiRlcnJvci5yZXF1aXJlZCI+UmVxdWlyZWQhPC9zcGFuPgogICAgICAgPGhyPgogICAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ1c2VyQ29udGVudCI+PC90ZXh0YXJlYT4KICAgICAgPC9mb3JtPgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICBpdCgnc2hvdWxkIGRhdGEtYmluZCBhbmQgYmVjb21lIGludmFsaWQnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ3NhZmFyaScgfHwgYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnZmlyZWZveCcpIHsKICAgICAgICAvLyBTYWZhcmlEcml2ZXIgY2FuJ3QgaGFuZGxlIGNvbnRlbnRlZGl0YWJsZQogICAgICAgIC8vIGFuZCBGaXJlZm94IGRyaXZlciBjYW4ndCBjbGVhciBjb250ZW50ZWRpdGFibGVzIHZlcnkgd2VsbAogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgY29udGVudEVkaXRhYmxlID0gZWxlbWVudChieS5jc3MoJ1tjb250ZW50ZWRpdGFibGVdJykpOwogICAgICB2YXIgY29udGVudCA9ICdDaGFuZ2UgbWUhJzsKCiAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUuZ2V0VGV4dCgpKS50b0VxdWFsKGNvbnRlbnQpOwoKICAgICAgY29udGVudEVkaXRhYmxlLmNsZWFyKCk7CiAgICAgIGNvbnRlbnRFZGl0YWJsZS5zZW5kS2V5cyhwcm90cmFjdG9yLktleS5CQUNLX1NQQUNFKTsKICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS5nZXRUZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9NYXRjaCgvbmctaW52YWxpZC1yZXF1aXJlZC8pOwogICAgfSk7CiAgICA8L2ZpbGU+CiAqIDwvZXhhbXBsZT4KICoKICoKICovCnZhciBOZ01vZGVsQ29udHJvbGxlciA9IFsnJHNjb3BlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRhdHRycycsICckZWxlbWVudCcsICckcGFyc2UnLCAnJGFuaW1hdGUnLAogICAgZnVuY3Rpb24oJHNjb3BlLCAkZXhjZXB0aW9uSGFuZGxlciwgJGF0dHIsICRlbGVtZW50LCAkcGFyc2UsICRhbmltYXRlKSB7CiAgdGhpcy4kdmlld1ZhbHVlID0gTnVtYmVyLk5hTjsKICB0aGlzLiRtb2RlbFZhbHVlID0gTnVtYmVyLk5hTjsKICB0aGlzLiRwYXJzZXJzID0gW107CiAgdGhpcy4kZm9ybWF0dGVycyA9IFtdOwogIHRoaXMuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMgPSBbXTsKICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgdGhpcy4kZGlydHkgPSBmYWxzZTsKICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogIHRoaXMuJG5hbWUgPSAkYXR0ci5uYW1lOwoKICB2YXIgbmdNb2RlbEdldCA9ICRwYXJzZSgkYXR0ci5uZ01vZGVsKSwKICAgICAgbmdNb2RlbFNldCA9IG5nTW9kZWxHZXQuYXNzaWduOwoKICBpZiAoIW5nTW9kZWxTZXQpIHsKICAgIHRocm93IG1pbkVycignbmdNb2RlbCcpKCdub25hc3NpZ24nLCAiRXhwcmVzc2lvbiAnezB9JyBpcyBub24tYXNzaWduYWJsZS4gRWxlbWVudDogezF9IiwKICAgICAgICAkYXR0ci5uZ01vZGVsLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHJlbmRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbGVkIHdoZW4gdGhlIHZpZXcgbmVlZHMgdG8gYmUgdXBkYXRlZC4gSXQgaXMgZXhwZWN0ZWQgdGhhdCB0aGUgdXNlciBvZiB0aGUgbmctbW9kZWwKICAgKiBkaXJlY3RpdmUgd2lsbCBpbXBsZW1lbnQgdGhpcyBtZXRob2QuCiAgICovCiAgdGhpcy4kcmVuZGVyID0gbm9vcDsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJGlzRW1wdHkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgaXMgY2FsbGVkIHdoZW4gd2UgbmVlZCB0byBkZXRlcm1pbmUgaWYgdGhlIHZhbHVlIG9mIHRoZSBpbnB1dCBpcyBlbXB0eS4KICAgKgogICAqIEZvciBpbnN0YW5jZSwgdGhlIHJlcXVpcmVkIGRpcmVjdGl2ZSBkb2VzIHRoaXMgdG8gd29yayBvdXQgaWYgdGhlIGlucHV0IGhhcyBkYXRhIG9yIG5vdC4KICAgKiBUaGUgZGVmYXVsdCBgJGlzRW1wdHlgIGZ1bmN0aW9uIGNoZWNrcyB3aGV0aGVyIHRoZSB2YWx1ZSBpcyBgdW5kZWZpbmVkYCwgYCcnYCwgYG51bGxgIG9yIGBOYU5gLgogICAqCiAgICogWW91IGNhbiBvdmVycmlkZSB0aGlzIGZvciBpbnB1dCBkaXJlY3RpdmVzIHdob3NlIGNvbmNlcHQgb2YgYmVpbmcgZW1wdHkgaXMgZGlmZmVyZW50IHRvIHRoZQogICAqIGRlZmF1bHQuIFRoZSBgY2hlY2tib3hJbnB1dFR5cGVgIGRpcmVjdGl2ZSBkb2VzIHRoaXMgYmVjYXVzZSBpbiBpdHMgY2FzZSBhIHZhbHVlIG9mIGBmYWxzZWAKICAgKiBpbXBsaWVzIGVtcHR5LgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBlbXB0eS4KICAgKi8KICB0aGlzLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBpc1VuZGVmaW5lZCh2YWx1ZSkgfHwgdmFsdWUgPT09ICcnIHx8IHZhbHVlID09PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZTsKICB9OwoKICB2YXIgcGFyZW50Rm9ybSA9ICRlbGVtZW50LmluaGVyaXRlZERhdGEoJyRmb3JtQ29udHJvbGxlcicpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgaW52YWxpZENvdW50ID0gMCwgLy8gdXNlZCB0byBlYXNpbHkgZGV0ZXJtaW5lIGlmIHdlIGFyZSB2YWxpZAogICAgICAkZXJyb3IgPSB0aGlzLiRlcnJvciA9IHt9OyAvLyBrZWVwIGludmFsaWQga2V5cyBoZXJlCgoKICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgJGVsZW1lbnQuYWRkQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpOwogIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwoKICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogIGZ1bmN0aW9uIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQsIHZhbGlkYXRpb25FcnJvcktleSkgewogICAgdmFsaWRhdGlvbkVycm9yS2V5ID0gdmFsaWRhdGlvbkVycm9yS2V5ID8gJy0nICsgc25ha2VfY2FzZSh2YWxpZGF0aW9uRXJyb3JLZXksICctJykgOiAnJzsKICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKCRlbGVtZW50LCAoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsIChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VmFsaWRpdHkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENoYW5nZSB0aGUgdmFsaWRpdHkgc3RhdGUsIGFuZCBub3RpZmllcyB0aGUgZm9ybSB3aGVuIHRoZSBjb250cm9sIGNoYW5nZXMgdmFsaWRpdHkuIChpLmUuIGl0CiAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAqCiAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCBieSB2YWxpZGF0b3JzIC0gaS5lLiB0aGUgcGFyc2VyIG9yIGZvcm1hdHRlciBmdW5jdGlvbnMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsaWRhdGlvbkVycm9yS2V5IE5hbWUgb2YgdGhlIHZhbGlkYXRvci4gdGhlIGB2YWxpZGF0aW9uRXJyb3JLZXlgIHdpbGwgYXNzaWduCiAgICogICAgICAgIHRvIGAkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XT1pc1ZhbGlkYCBzbyB0aGF0IGl0IGlzIGF2YWlsYWJsZSBmb3IgZGF0YS1iaW5kaW5nLgogICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICogICAgICAgIGZvciBjbGFzcyBuYW1lLiBFeGFtcGxlOiBgbXlFcnJvcmAgd2lsbCByZXN1bHQgaW4gYG5nLXZhbGlkLW15LWVycm9yYCBhbmQgYG5nLWludmFsaWQtbXktZXJyb3JgCiAgICogICAgICAgIGNsYXNzIGFuZCBjYW4gYmUgYm91bmQgdG8gYXMgIGB7e3NvbWVGb3JtLnNvbWVDb250cm9sLiRlcnJvci5teUVycm9yfX1gIC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAqLwogIHRoaXMuJHNldFZhbGlkaXR5ID0gZnVuY3Rpb24odmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkKSB7CiAgICAvLyBQdXJwb3NlZnVsIHVzZSBvZiAhIGhlcmUgdG8gY2FzdCBpc1ZhbGlkIHRvIGJvb2xlYW4gaW4gY2FzZSBpdCBpcyB1bmRlZmluZWQKICAgIC8vIGpzaGludCAtVzAxOAogICAgaWYgKCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID09PSAhaXNWYWxpZCkgcmV0dXJuOwogICAgLy8ganNoaW50ICtXMDE4CgogICAgaWYgKGlzVmFsaWQpIHsKICAgICAgaWYgKCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldKSBpbnZhbGlkQ291bnQtLTsKICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlKTsKICAgICAgICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0b2dnbGVWYWxpZENzcyhmYWxzZSk7CiAgICAgIHRoaXMuJGludmFsaWQgPSB0cnVlOwogICAgICB0aGlzLiR2YWxpZCA9IGZhbHNlOwogICAgICBpbnZhbGlkQ291bnQrKzsKICAgIH0KCiAgICAkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSA9ICFpc1ZhbGlkOwogICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KTsKCiAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQsIHRoaXMpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRQcmlzdGluZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgY29udHJvbCB0byBpdHMgcHJpc3RpbmUgc3RhdGUuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBjb250cm9sIHRvIGl0cyBwcmlzdGluZQogICAqIHN0YXRlIChuZy1wcmlzdGluZSBjbGFzcykuCiAgICovCiAgdGhpcy4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLiRkaXJ0eSA9IGZhbHNlOwogICAgdGhpcy4kcHJpc3RpbmUgPSB0cnVlOwogICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoJGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgICRhbmltYXRlLmFkZENsYXNzKCRlbGVtZW50LCBQUklTVElORV9DTEFTUyk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZpZXdWYWx1ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXBkYXRlIHRoZSB2aWV3IHZhbHVlLgogICAqCiAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIHRoZSB2aWV3IHZhbHVlIGNoYW5nZXMsIHR5cGljYWxseSBmcm9tIHdpdGhpbiBhIERPTSBldmVudCBoYW5kbGVyLgogICAqIEZvciBleGFtcGxlIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9IGFuZAogICAqIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0gZGlyZWN0aXZlcyBjYWxsIGl0LgogICAqCiAgICogSXQgd2lsbCB1cGRhdGUgdGhlICR2aWV3VmFsdWUsIHRoZW4gcGFzcyB0aGlzIHZhbHVlIHRocm91Z2ggZWFjaCBvZiB0aGUgZnVuY3Rpb25zIGluIGAkcGFyc2Vyc2AsCiAgICogd2hpY2ggaW5jbHVkZXMgYW55IHZhbGlkYXRvcnMuIFRoZSB2YWx1ZSB0aGF0IGNvbWVzIG91dCBvZiB0aGlzIGAkcGFyc2Vyc2AgcGlwZWxpbmUsIGJlIGFwcGxpZWQgdG8KICAgKiBgJG1vZGVsVmFsdWVgIGFuZCB0aGUgKipleHByZXNzaW9uKiogc3BlY2lmaWVkIGluIHRoZSBgbmctbW9kZWxgIGF0dHJpYnV0ZS4KICAgKgogICAqIExhc3RseSwgYWxsIHRoZSByZWdpc3RlcmVkIGNoYW5nZSBsaXN0ZW5lcnMsIGluIHRoZSBgJHZpZXdDaGFuZ2VMaXN0ZW5lcnNgIGxpc3QsIGFyZSBjYWxsZWQuCiAgICoKICAgKiBOb3RlIHRoYXQgY2FsbGluZyB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90IHRyaWdnZXIgYSBgJGRpZ2VzdGAuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVmFsdWUgZnJvbSB0aGUgdmlldy4KICAgKi8KICB0aGlzLiRzZXRWaWV3VmFsdWUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgdGhpcy4kdmlld1ZhbHVlID0gdmFsdWU7CgogICAgLy8gY2hhbmdlIHRvIGRpcnR5CiAgICBpZiAodGhpcy4kcHJpc3RpbmUpIHsKICAgICAgdGhpcy4kZGlydHkgPSB0cnVlOwogICAgICB0aGlzLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcygkZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MpOwogICAgICAkYW5pbWF0ZS5hZGRDbGFzcygkZWxlbWVudCwgRElSVFlfQ0xBU1MpOwogICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgfQoKICAgIGZvckVhY2godGhpcy4kcGFyc2VycywgZnVuY3Rpb24oZm4pIHsKICAgICAgdmFsdWUgPSBmbih2YWx1ZSk7CiAgICB9KTsKCiAgICBpZiAodGhpcy4kbW9kZWxWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgdGhpcy4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICBuZ01vZGVsU2V0KCRzY29wZSwgdmFsdWUpOwogICAgICBmb3JFYWNoKHRoaXMuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uKGxpc3RlbmVyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIC8vIG1vZGVsIC0+IHZhbHVlCiAgdmFyIGN0cmwgPSB0aGlzOwoKICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nTW9kZWxXYXRjaCgpIHsKICAgIHZhciB2YWx1ZSA9IG5nTW9kZWxHZXQoJHNjb3BlKTsKCiAgICAvLyBpZiBzY29wZSBtb2RlbCB2YWx1ZSBhbmQgbmdNb2RlbCB2YWx1ZSBhcmUgb3V0IG9mIHN5bmMKICAgIGlmIChjdHJsLiRtb2RlbFZhbHVlICE9PSB2YWx1ZSkgewoKICAgICAgdmFyIGZvcm1hdHRlcnMgPSBjdHJsLiRmb3JtYXR0ZXJzLAogICAgICAgICAgaWR4ID0gZm9ybWF0dGVycy5sZW5ndGg7CgogICAgICBjdHJsLiRtb2RlbFZhbHVlID0gdmFsdWU7CiAgICAgIHdoaWxlKGlkeC0tKSB7CiAgICAgICAgdmFsdWUgPSBmb3JtYXR0ZXJzW2lkeF0odmFsdWUpOwogICAgICB9CgogICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIGN0cmwuJHZpZXdWYWx1ZSA9IHZhbHVlOwogICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZhbHVlOwogIH0pOwp9XTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vZGVsCiAqCiAqIEBlbGVtZW50IGlucHV0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nTW9kZWxgIGRpcmVjdGl2ZSBiaW5kcyBhbiBgaW5wdXRgLGBzZWxlY3RgLCBgdGV4dGFyZWFgIChvciBjdXN0b20gZm9ybSBjb250cm9sKSB0byBhCiAqIHByb3BlcnR5IG9uIHRoZSBzY29wZSB1c2luZyB7QGxpbmsgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciBOZ01vZGVsQ29udHJvbGxlcn0sCiAqIHdoaWNoIGlzIGNyZWF0ZWQgYW5kIGV4cG9zZWQgYnkgdGhpcyBkaXJlY3RpdmUuCiAqCiAqIGBuZ01vZGVsYCBpcyByZXNwb25zaWJsZSBmb3I6CiAqCiAqIC0gQmluZGluZyB0aGUgdmlldyBpbnRvIHRoZSBtb2RlbCwgd2hpY2ggb3RoZXIgZGlyZWN0aXZlcyBzdWNoIGFzIGBpbnB1dGAsIGB0ZXh0YXJlYWAgb3IgYHNlbGVjdGAKICogICByZXF1aXJlLgogKiAtIFByb3ZpZGluZyB2YWxpZGF0aW9uIGJlaGF2aW9yIChpLmUuIHJlcXVpcmVkLCBudW1iZXIsIGVtYWlsLCB1cmwpLgogKiAtIEtlZXBpbmcgdGhlIHN0YXRlIG9mIHRoZSBjb250cm9sICh2YWxpZC9pbnZhbGlkLCBkaXJ0eS9wcmlzdGluZSwgdmFsaWRhdGlvbiBlcnJvcnMpLgogKiAtIFNldHRpbmcgcmVsYXRlZCBjc3MgY2xhc3NlcyBvbiB0aGUgZWxlbWVudCAoYG5nLXZhbGlkYCwgYG5nLWludmFsaWRgLCBgbmctZGlydHlgLCBgbmctcHJpc3RpbmVgKSBpbmNsdWRpbmcgYW5pbWF0aW9ucy4KICogLSBSZWdpc3RlcmluZyB0aGUgY29udHJvbCB3aXRoIGl0cyBwYXJlbnQge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGZvcm19LgogKgogKiBOb3RlOiBgbmdNb2RlbGAgd2lsbCB0cnkgdG8gYmluZCB0byB0aGUgcHJvcGVydHkgZ2l2ZW4gYnkgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUKICogY3VycmVudCBzY29wZS4gSWYgdGhlIHByb3BlcnR5IGRvZXNuJ3QgYWxyZWFkeSBleGlzdCBvbiB0aGlzIHNjb3BlLCBpdCB3aWxsIGJlIGNyZWF0ZWQKICogaW1wbGljaXRseSBhbmQgYWRkZWQgdG8gdGhlIHNjb3BlLgogKgogKiBGb3IgYmVzdCBwcmFjdGljZXMgb24gdXNpbmcgYG5nTW9kZWxgLCBzZWU6CiAqCiAqICAtIFtodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3dpa2kvVW5kZXJzdGFuZGluZy1TY29wZXNdCiAqCiAqIEZvciBiYXNpYyBleGFtcGxlcywgaG93IHRvIHVzZSBgbmdNb2RlbGAsIHNlZToKICoKICogIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0KICogICAgLSB7QGxpbmsgaW5wdXRbdGV4dF0gdGV4dH0KICogICAgLSB7QGxpbmsgaW5wdXRbY2hlY2tib3hdIGNoZWNrYm94fQogKiAgICAtIHtAbGluayBpbnB1dFtyYWRpb10gcmFkaW99CiAqICAgIC0ge0BsaW5rIGlucHV0W251bWJlcl0gbnVtYmVyfQogKiAgICAtIHtAbGluayBpbnB1dFtlbWFpbF0gZW1haWx9CiAqICAgIC0ge0BsaW5rIGlucHV0W3VybF0gdXJsfQogKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9CiAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6dGV4dGFyZWEgdGV4dGFyZWF9CiAqCiAqICMgQ1NTIGNsYXNzZXMKICogVGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIHJlbW92ZWQgb24gdGhlIGFzc29jaWF0ZWQgaW5wdXQvc2VsZWN0L3RleHRhcmVhIGVsZW1lbnQKICogZGVwZW5kaW5nIG9uIHRoZSB2YWxpZGl0eSBvZiB0aGUgbW9kZWwuCiAqCiAqICAtIGBuZy12YWxpZGAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyB2YWxpZC4KICogIC0gYG5nLWludmFsaWRgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgaW52YWxpZC4KICogIC0gYG5nLXByaXN0aW5lYCBpcyBzZXQgaWYgdGhlIG1vZGVsIGlzIHByaXN0aW5lLgogKiAgLSBgbmctZGlydHlgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgZGlydHkuCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0IG5nQW5pbWF0ZSBjYW4gZGV0ZWN0IGVhY2ggb2YgdGhlc2UgY2xhc3NlcyB3aGVuIGFkZGVkIGFuZCByZW1vdmVkLgogKgogKiAjIyBBbmltYXRpb24gSG9va3MKICoKICogQW5pbWF0aW9ucyB3aXRoaW4gbW9kZWxzIGFyZSB0cmlnZ2VyZWQgd2hlbiBhbnkgb2YgdGhlIGFzc29jaWF0ZWQgQ1NTIGNsYXNzZXMgYXJlIGFkZGVkIGFuZCByZW1vdmVkCiAqIG9uIHRoZSBpbnB1dCBlbGVtZW50IHdoaWNoIGlzIGF0dGFjaGVkIHRvIHRoZSBtb2RlbC4gVGhlc2UgY2xhc3NlcyBhcmU6IGAubmctcHJpc3RpbmVgLCBgLm5nLWRpcnR5YCwKICogYC5uZy1pbnZhbGlkYCBhbmQgYC5uZy12YWxpZGAgYXMgd2VsbCBhcyBhbnkgb3RoZXIgdmFsaWRhdGlvbnMgdGhhdCBhcmUgcGVyZm9ybWVkIG9uIHRoZSBtb2RlbCBpdHNlbGYuCiAqIFRoZSBhbmltYXRpb25zIHRoYXQgYXJlIHRyaWdnZXJlZCB3aXRoaW4gbmdNb2RlbCBhcmUgc2ltaWxhciB0byBob3cgdGhleSB3b3JrIGluIG5nQ2xhc3MgYW5kCiAqIGFuaW1hdGlvbnMgY2FuIGJlIGhvb2tlZCBpbnRvIHVzaW5nIENTUyB0cmFuc2l0aW9ucywga2V5ZnJhbWVzIGFzIHdlbGwgYXMgSlMgYW5pbWF0aW9ucy4KICoKICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGEgc2ltcGxlIHdheSB0byB1dGlsaXplIENTUyB0cmFuc2l0aW9ucyB0byBzdHlsZSBhbiBpbnB1dCBlbGVtZW50CiAqIHRoYXQgaGFzIGJlZW4gcmVuZGVyZWQgYXMgaW52YWxpZCBhZnRlciBpdCBoYXMgYmVlbiB2YWxpZGF0ZWQ6CiAqCiAqIDxwcmU+CiAqIC8vYmUgc3VyZSB0byBpbmNsdWRlIG5nQW5pbWF0ZSBhcyBhIG1vZHVsZSB0byBob29rIGludG8gbW9yZQogKiAvL2FkdmFuY2VkIGFuaW1hdGlvbnMKICogLm15LWlucHV0IHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICogfQogKiAubXktaW5wdXQubmctaW52YWxpZCB7CiAqICAgYmFja2dyb3VuZDogcmVkOwogKiAgIGNvbG9yOndoaXRlOwogKiB9CiAqIDwvcHJlPgogKgogKiBAZXhhbXBsZQogKiA8ZXhhbXBsZSBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiIGZpeEJhc2U9InRydWUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLnZhbCA9ICcxJzsKICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxzdHlsZT4KICAgICAgICAgLm15LWlucHV0IHsKICAgICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgICAgICB9CiAgICAgICAgIC5teS1pbnB1dC5uZy1pbnZhbGlkIHsKICAgICAgICAgICBjb2xvcjp3aGl0ZTsKICAgICAgICAgICBiYWNrZ3JvdW5kOiByZWQ7CiAgICAgICAgIH0KICAgICAgIDwvc3R5bGU+CiAgICAgICBVcGRhdGUgaW5wdXQgdG8gc2VlIHRyYW5zaXRpb25zIHdoZW4gdmFsaWQvaW52YWxpZC4KICAgICAgIEludGVnZXIgaXMgYSB2YWxpZCB2YWx1ZS4KICAgICAgIDxmb3JtIG5hbWU9InRlc3RGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJ2YWwiIG5nLXBhdHRlcm49Ii9eXGQrJC8iIG5hbWU9ImFuaW0iIGNsYXNzPSJteS1pbnB1dCIgLz4KICAgICAgIDwvZm9ybT4KICAgICA8L2ZpbGU+CiAqIDwvZXhhbXBsZT4KICovCnZhciBuZ01vZGVsRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlcXVpcmU6IFsnbmdNb2RlbCcsICdeP2Zvcm0nXSwKICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgIC8vIG5vdGlmeSBvdGhlcnMsIGVzcGVjaWFsbHkgcGFyZW50IGZvcm1zCgogICAgICB2YXIgbW9kZWxDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICBmb3JtQ3RybCA9IGN0cmxzWzFdIHx8IG51bGxGb3JtQ3RybDsKCiAgICAgIGZvcm1DdHJsLiRhZGRDb250cm9sKG1vZGVsQ3RybCk7CgogICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgZm9ybUN0cmwuJHJlbW92ZUNvbnRyb2wobW9kZWxDdHJsKTsKICAgICAgfSk7CiAgICB9CiAgfTsKfTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NoYW5nZQogKgogKiBAZGVzY3JpcHRpb24KICogRXZhbHVhdGUgdGhlIGdpdmVuIGV4cHJlc3Npb24gd2hlbiB0aGUgdXNlciBjaGFuZ2VzIHRoZSBpbnB1dC4KICogVGhlIGV4cHJlc3Npb24gaXMgZXZhbHVhdGVkIGltbWVkaWF0ZWx5LCB1bmxpa2UgdGhlIEphdmFTY3JpcHQgb25jaGFuZ2UgZXZlbnQKICogd2hpY2ggb25seSB0cmlnZ2VycyBhdCB0aGUgZW5kIG9mIGEgY2hhbmdlICh1c3VhbGx5LCB3aGVuIHRoZSB1c2VyIGxlYXZlcyB0aGUKICogZm9ybSBlbGVtZW50IG9yIHByZXNzZXMgdGhlIHJldHVybiBrZXkpLgogKiBUaGUgZXhwcmVzc2lvbiBpcyBub3QgZXZhbHVhdGVkIHdoZW4gdGhlIHZhbHVlIGNoYW5nZSBpcyBjb21pbmcgZnJvbSB0aGUgbW9kZWwuCiAqCiAqIE5vdGUsIHRoaXMgZGlyZWN0aXZlIHJlcXVpcmVzIGBuZ01vZGVsYCB0byBiZSBwcmVzZW50LgogKgogKiBAZWxlbWVudCBpbnB1dAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2hhbmdlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24gY2hhbmdlCiAqIGluIGlucHV0IHZhbHVlLgogKgogKiBAZXhhbXBsZQogKiA8ZXhhbXBsZSBuYW1lPSJuZ0NoYW5nZS1kaXJlY3RpdmUiPgogKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogKiAgICAgPHNjcmlwdD4KICogICAgICAgZnVuY3Rpb24gQ29udHJvbGxlcigkc2NvcGUpIHsKICogICAgICAgICAkc2NvcGUuY291bnRlciA9IDA7CiAqICAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgJHNjb3BlLmNvdW50ZXIrKzsKICogICAgICAgICB9OwogKiAgICAgICB9CiAqICAgICA8L3NjcmlwdD4KICogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ29udHJvbGxlciI+CiAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgbmctY2hhbmdlPSJjaGFuZ2UoKSIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMSIgLz4KICogICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY29uZmlybWVkIiBpZD0ibmctY2hhbmdlLWV4YW1wbGUyIiAvPgogKiAgICAgICA8bGFiZWwgZm9yPSJuZy1jaGFuZ2UtZXhhbXBsZTIiPkNvbmZpcm1lZDwvbGFiZWw+PGJyIC8+CiAqICAgICAgIDx0dD5kZWJ1ZyA9IHt7Y29uZmlybWVkfX08L3R0Pjxici8+CiAqICAgICAgIDx0dD5jb3VudGVyID0ge3tjb3VudGVyfX08L3R0Pjxici8+CiAqICAgICA8L2Rpdj4KICogICA8L2ZpbGU+CiAqICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAqICAgICB2YXIgY291bnRlciA9IGVsZW1lbnQoYnkuYmluZGluZygnY291bnRlcicpKTsKICogICAgIHZhciBkZWJ1ZyA9IGVsZW1lbnQoYnkuYmluZGluZygnY29uZmlybWVkJykpOwogKgogKiAgICAgaXQoJ3Nob3VsZCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIHZpZXcnLCBmdW5jdGlvbigpIHsKICogICAgICAgZXhwZWN0KGNvdW50ZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzAnKTsKICoKICogICAgICAgZWxlbWVudChieS5pZCgnbmctY2hhbmdlLWV4YW1wbGUxJykpLmNsaWNrKCk7CiAqCiAqICAgICAgIGV4cGVjdChjb3VudGVyLmdldFRleHQoKSkudG9Db250YWluKCcxJyk7CiAqICAgICAgIGV4cGVjdChkZWJ1Zy5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogKiAgICAgfSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIG5vdCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGVsZW1lbnQoYnkuaWQoJ25nLWNoYW5nZS1leGFtcGxlMicpKS5jbGljaygpOwoKICogICAgICAgZXhwZWN0KGNvdW50ZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzAnKTsKICogICAgICAgZXhwZWN0KGRlYnVnLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAqICAgICB9KTsKICogICA8L2ZpbGU+CiAqIDwvZXhhbXBsZT4KICovCnZhciBuZ0NoYW5nZURpcmVjdGl2ZSA9IHZhbHVlRm4oewogIHJlcXVpcmU6ICduZ01vZGVsJywKICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgY3RybC4kdmlld0NoYW5nZUxpc3RlbmVycy5wdXNoKGZ1bmN0aW9uKCkgewogICAgICBzY29wZS4kZXZhbChhdHRyLm5nQ2hhbmdlKTsKICAgIH0pOwogIH0KfSk7CgoKdmFyIHJlcXVpcmVkRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxtLCBhdHRyLCBjdHJsKSB7CiAgICAgIGlmICghY3RybCkgcmV0dXJuOwogICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICB2YXIgdmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoYXR0ci5yZXF1aXJlZCAmJiBjdHJsLiRpc0VtcHR5KHZhbHVlKSkgewogICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgZmFsc2UpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncmVxdWlyZWQnLCB0cnVlKTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godmFsaWRhdG9yKTsKICAgICAgY3RybC4kcGFyc2Vycy51bnNoaWZ0KHZhbGlkYXRvcik7CgogICAgICBhdHRyLiRvYnNlcnZlKCdyZXF1aXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHZhbGlkYXRvcihjdHJsLiR2aWV3VmFsdWUpOwogICAgICB9KTsKICAgIH0KICB9Owp9OwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTGlzdAogKgogKiBAZGVzY3JpcHRpb24KICogVGV4dCBpbnB1dCB0aGF0IGNvbnZlcnRzIGJldHdlZW4gYSBkZWxpbWl0ZWQgc3RyaW5nIGFuZCBhbiBhcnJheSBvZiBzdHJpbmdzLiBUaGUgZGVsaW1pdGVyCiAqIGNhbiBiZSBhIGZpeGVkIHN0cmluZyAoYnkgZGVmYXVsdCBhIGNvbW1hKSBvciBhIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICoKICogQGVsZW1lbnQgaW5wdXQKICogQHBhcmFtIHtzdHJpbmc9fSBuZ0xpc3Qgb3B0aW9uYWwgZGVsaW1pdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gc3BsaXQgdGhlIHZhbHVlLiBJZgogKiAgIHNwZWNpZmllZCBpbiBmb3JtIGAvc29tZXRoaW5nL2AgdGhlbiB0aGUgdmFsdWUgd2lsbCBiZSBjb252ZXJ0ZWQgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlIG5hbWU9Im5nTGlzdC1kaXJlY3RpdmUiPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWVzID0gWydpZ29yJywgJ21pc2tvJywgJ3ZvanRhJ107CiAgICAgICAgIH0KICAgICAgIDwvc2NyaXB0PgogICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgTGlzdDogPGlucHV0IG5hbWU9Im5hbWVzSW5wdXQiIG5nLW1vZGVsPSJuYW1lcyIgbmctbGlzdCByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubmFtZXNJbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgPGJyPgogICAgICAgICA8dHQ+bmFtZXMgPSB7e25hbWVzfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yID0ge3tteUZvcm0ubmFtZXNJbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgIDwvZm9ybT4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICB2YXIgbGlzdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbmFtZXMnKSk7CiAgICAgICAgdmFyIG5hbWVzID0gZWxlbWVudChieS5iaW5kaW5nKCd7e25hbWVzfX0nKSk7CiAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgdmFyIGVycm9yID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZXJyb3InKSk7CgogICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KG5hbWVzLmdldFRleHQoKSkudG9Db250YWluKCdbImlnb3IiLCJtaXNrbyIsInZvanRhIl0nKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGVycm9yLmdldENzc1ZhbHVlKCdkaXNwbGF5JykpLnRvQmUoJ25vbmUnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBsaXN0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGxpc3RJbnB1dC5zZW5kS2V5cygnJyk7CgogICAgICAgICAgZXhwZWN0KG5hbWVzLmdldFRleHQoKSkudG9Db250YWluKCcnKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIGV4cGVjdChlcnJvci5nZXRDc3NWYWx1ZSgnZGlzcGxheScpKS5ub3QudG9CZSgnbm9uZScpOyAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0xpc3REaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgdmFyIG1hdGNoID0gL1wvKC4qKVwvLy5leGVjKGF0dHIubmdMaXN0KSwKICAgICAgICAgIHNlcGFyYXRvciA9IG1hdGNoICYmIG5ldyBSZWdFeHAobWF0Y2hbMV0pIHx8IGF0dHIubmdMaXN0IHx8ICcsJzsKCiAgICAgIHZhciBwYXJzZSA9IGZ1bmN0aW9uKHZpZXdWYWx1ZSkgewogICAgICAgIC8vIElmIHRoZSB2aWV3VmFsdWUgaXMgaW52YWxpZCAoc2F5IHJlcXVpcmVkIGJ1dCBlbXB0eSkgaXQgd2lsbCBiZSBgdW5kZWZpbmVkYAogICAgICAgIGlmIChpc1VuZGVmaW5lZCh2aWV3VmFsdWUpKSByZXR1cm47CgogICAgICAgIHZhciBsaXN0ID0gW107CgogICAgICAgIGlmICh2aWV3VmFsdWUpIHsKICAgICAgICAgIGZvckVhY2godmlld1ZhbHVlLnNwbGl0KHNlcGFyYXRvciksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgbGlzdC5wdXNoKHRyaW0odmFsdWUpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgIH07CgogICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGFyc2UpOwogICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZS5qb2luKCcsICcpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfSk7CgogICAgICAvLyBPdmVycmlkZSB0aGUgc3RhbmRhcmQgJGlzRW1wdHkgYmVjYXVzZSBhbiBlbXB0eSBhcnJheSBtZWFucyB0aGUgaW5wdXQgaXMgZW1wdHkuCiAgICAgIGN0cmwuJGlzRW1wdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiAhdmFsdWUgfHwgIXZhbHVlLmxlbmd0aDsKICAgICAgfTsKICAgIH0KICB9Owp9OwoKCnZhciBDT05TVEFOVF9WQUxVRV9SRUdFWFAgPSAvXih0cnVlfGZhbHNlfFxkKykkLzsKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdWYWx1ZQogKgogKiBAZGVzY3JpcHRpb24KICogQmluZHMgdGhlIGdpdmVuIGV4cHJlc3Npb24gdG8gdGhlIHZhbHVlIG9mIGBpbnB1dFtzZWxlY3RdYCBvciBgaW5wdXRbcmFkaW9dYCwgc28KICogdGhhdCB3aGVuIHRoZSBlbGVtZW50IGlzIHNlbGVjdGVkLCB0aGUgYG5nTW9kZWxgIG9mIHRoYXQgZWxlbWVudCBpcyBzZXQgdG8gdGhlCiAqIGJvdW5kIHZhbHVlLgogKgogKiBgbmdWYWx1ZWAgaXMgdXNlZnVsIHdoZW4gZHluYW1pY2FsbHkgZ2VuZXJhdGluZyBsaXN0cyBvZiByYWRpbyBidXR0b25zIHVzaW5nIGBuZy1yZXBlYXRgLCBhcwogKiBzaG93biBiZWxvdy4KICoKICogQGVsZW1lbnQgaW5wdXQKICogQHBhcmFtIHtzdHJpbmc9fSBuZ1ZhbHVlIGFuZ3VsYXIgZXhwcmVzc2lvbiwgd2hvc2UgdmFsdWUgd2lsbCBiZSBib3VuZCB0byB0aGUgYHZhbHVlYCBhdHRyaWJ1dGUKICogICBvZiB0aGUgYGlucHV0YCBlbGVtZW50CiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZSBuYW1lPSJuZ1ZhbHVlLWRpcmVjdGl2ZSI+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsncGl6emEnLCAndW5pY29ybnMnLCAncm9ib3RzJ107CiAgICAgICAgICAgICRzY29wZS5teSA9IHsgZmF2b3JpdGU6ICd1bmljb3JucycgfTsKICAgICAgICAgIH0KICAgICAgIDwvc2NyaXB0PgogICAgICAgIDxmb3JtIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgPGgyPldoaWNoIGlzIHlvdXIgZmF2b3JpdGU/PC9oMj4KICAgICAgICAgICAgPGxhYmVsIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyIgZm9yPSJ7e25hbWV9fSI+CiAgICAgICAgICAgICAge3tuYW1lfX0KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iCiAgICAgICAgICAgICAgICAgICAgIG5nLW1vZGVsPSJteS5mYXZvcml0ZSIKICAgICAgICAgICAgICAgICAgICAgbmctdmFsdWU9Im5hbWUiCiAgICAgICAgICAgICAgICAgICAgIGlkPSJ7e25hbWV9fSIKICAgICAgICAgICAgICAgICAgICAgbmFtZT0iZmF2b3JpdGUiPgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgPGRpdj5Zb3UgY2hvc2Uge3tteS5mYXZvcml0ZX19PC9kaXY+CiAgICAgICAgPC9mb3JtPgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIHZhciBmYXZvcml0ZSA9IGVsZW1lbnQoYnkuYmluZGluZygnbXkuZmF2b3JpdGUnKSk7CgogICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGZhdm9yaXRlLmdldFRleHQoKSkudG9Db250YWluKCd1bmljb3JucycpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgYmluZCB0aGUgdmFsdWVzIHRvIHRoZSBpbnB1dHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5Lm1vZGVsKCdteS5mYXZvcml0ZScpKS5nZXQoMCkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChmYXZvcml0ZS5nZXRUZXh0KCkpLnRvQ29udGFpbigncGl6emEnKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIG5nVmFsdWVEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcHJpb3JpdHk6IDEwMCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRwbCwgdHBsQXR0cikgewogICAgICBpZiAoQ09OU1RBTlRfVkFMVUVfUkVHRVhQLnRlc3QodHBsQXR0ci5uZ1ZhbHVlKSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiBuZ1ZhbHVlQ29uc3RhbnRMaW5rKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBzY29wZS4kZXZhbChhdHRyLm5nVmFsdWUpKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmdW5jdGlvbiBuZ1ZhbHVlTGluayhzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1ZhbHVlLCBmdW5jdGlvbiB2YWx1ZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCB2YWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfTsKfTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQmluZAogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdCaW5kYCBhdHRyaWJ1dGUgdGVsbHMgQW5ndWxhciB0byByZXBsYWNlIHRoZSB0ZXh0IGNvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBIVE1MIGVsZW1lbnQKICogd2l0aCB0aGUgdmFsdWUgb2YgYSBnaXZlbiBleHByZXNzaW9uLCBhbmQgdG8gdXBkYXRlIHRoZSB0ZXh0IGNvbnRlbnQgd2hlbiB0aGUgdmFsdWUgb2YgdGhhdAogKiBleHByZXNzaW9uIGNoYW5nZXMuCiAqCiAqIFR5cGljYWxseSwgeW91IGRvbid0IHVzZSBgbmdCaW5kYCBkaXJlY3RseSwgYnV0IGluc3RlYWQgeW91IHVzZSB0aGUgZG91YmxlIGN1cmx5IG1hcmt1cCBsaWtlCiAqIGB7eyBleHByZXNzaW9uIH19YCB3aGljaCBpcyBzaW1pbGFyIGJ1dCBsZXNzIHZlcmJvc2UuCiAqCiAqIEl0IGlzIHByZWZlcmFibGUgdG8gdXNlIGBuZ0JpbmRgIGluc3RlYWQgb2YgYHt7IGV4cHJlc3Npb24gfX1gIHdoZW4gYSB0ZW1wbGF0ZSBpcyBtb21lbnRhcmlseQogKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyBzdGF0ZSBiZWZvcmUgQW5ndWxhciBjb21waWxlcyBpdC4gU2luY2UgYG5nQmluZGAgaXMgYW4KICogZWxlbWVudCBhdHRyaWJ1dGUsIGl0IG1ha2VzIHRoZSBiaW5kaW5ncyBpbnZpc2libGUgdG8gdGhlIHVzZXIgd2hpbGUgdGhlIHBhZ2UgaXMgbG9hZGluZy4KICoKICogQW4gYWx0ZXJuYXRpdmUgc29sdXRpb24gdG8gdGhpcyBwcm9ibGVtIHdvdWxkIGJlIHVzaW5nIHRoZQogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xvYWsgbmdDbG9ha30gZGlyZWN0aXZlLgogKgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0JpbmQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAqCiAqIEBleGFtcGxlCiAqIEVudGVyIGEgbmFtZSBpbiB0aGUgTGl2ZSBQcmV2aWV3IHRleHQgYm94OyB0aGUgZ3JlZXRpbmcgYmVsb3cgdGhlIHRleHQgYm94IGNoYW5nZXMgaW5zdGFudGx5LgogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV2hpcmxlZCc7CiAgICAgICAgIH0KICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgRW50ZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgICAgIEhlbGxvIDxzcGFuIG5nLWJpbmQ9Im5hbWUiPjwvc3Bhbj4hCiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIG5hbWVJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ25hbWUnKSk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCduYW1lJykpLmdldFRleHQoKSkudG9CZSgnV2hpcmxlZCcpOwogICAgICAgICBuYW1lSW5wdXQuY2xlYXIoKTsKICAgICAgICAgbmFtZUlucHV0LnNlbmRLZXlzKCd3b3JsZCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCduYW1lJykpLmdldFRleHQoKSkudG9CZSgnd29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KdmFyIG5nQmluZERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgYXR0ci5uZ0JpbmQpOwogIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZCwgZnVuY3Rpb24gbmdCaW5kV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgIC8vIFdlIGFyZSBwdXJwb3NlZnVsbHkgdXNpbmcgPT0gaGVyZSByYXRoZXIgdGhhbiA9PT0gYmVjYXVzZSB3ZSB3YW50IHRvCiAgICAvLyBjYXRjaCB3aGVuIHZhbHVlIGlzICJudWxsIG9yIHVuZGVmaW5lZCIKICAgIC8vIGpzaGludCAtVzA0MQogICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogIH0pOwp9KTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0JpbmRUZW1wbGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0JpbmRUZW1wbGF0ZWAgZGlyZWN0aXZlIHNwZWNpZmllcyB0aGF0IHRoZSBlbGVtZW50CiAqIHRleHQgY29udGVudCBzaG91bGQgYmUgcmVwbGFjZWQgd2l0aCB0aGUgaW50ZXJwb2xhdGlvbiBvZiB0aGUgdGVtcGxhdGUKICogaW4gdGhlIGBuZ0JpbmRUZW1wbGF0ZWAgYXR0cmlidXRlLgogKiBVbmxpa2UgYG5nQmluZGAsIHRoZSBgbmdCaW5kVGVtcGxhdGVgIGNhbiBjb250YWluIG11bHRpcGxlIGB7e2AgYH19YAogKiBleHByZXNzaW9ucy4gVGhpcyBkaXJlY3RpdmUgaXMgbmVlZGVkIHNpbmNlIHNvbWUgSFRNTCBlbGVtZW50cwogKiAoc3VjaCBhcyBUSVRMRSBhbmQgT1BUSU9OKSBjYW5ub3QgY29udGFpbiBTUEFOIGVsZW1lbnRzLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtzdHJpbmd9IG5nQmluZFRlbXBsYXRlIHRlbXBsYXRlIG9mIGZvcm0KICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgICRzY29wZS5uYW1lID0gJ1dvcmxkJzsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgIFNhbHV0YXRpb246IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ic2FsdXRhdGlvbiI+PGJyPgogICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICAgICAgIDxwcmUgbmctYmluZC10ZW1wbGF0ZT0ie3tzYWx1dGF0aW9ufX0ge3tuYW1lfX0hIj48L3ByZT4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgc2FsdXRhdGlvbkVsZW0gPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3NhbHV0YXRpb24nKSk7CiAgICAgICAgIHZhciBzYWx1dGF0aW9uSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzYWx1dGF0aW9uJykpOwogICAgICAgICB2YXIgbmFtZUlucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbmFtZScpKTsKCiAgICAgICAgIGV4cGVjdChzYWx1dGF0aW9uRWxlbS5nZXRUZXh0KCkpLnRvQmUoJ0hlbGxvIFdvcmxkIScpOwoKICAgICAgICAgc2FsdXRhdGlvbklucHV0LmNsZWFyKCk7CiAgICAgICAgIHNhbHV0YXRpb25JbnB1dC5zZW5kS2V5cygnR3JlZXRpbmdzJyk7CiAgICAgICAgIG5hbWVJbnB1dC5jbGVhcigpOwogICAgICAgICBuYW1lSW5wdXQuc2VuZEtleXMoJ3VzZXInKTsKCiAgICAgICAgIGV4cGVjdChzYWx1dGF0aW9uRWxlbS5nZXRUZXh0KCkpLnRvQmUoJ0dyZWV0aW5ncyB1c2VyIScpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgLy8gVE9ETzogbW92ZSB0aGlzIHRvIHNjZW5hcmlvIHJ1bm5lcgogICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoZWxlbWVudC5hdHRyKGF0dHIuJGF0dHIubmdCaW5kVGVtcGxhdGUpKTsKICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgYXR0ci4kb2JzZXJ2ZSgnbmdCaW5kVGVtcGxhdGUnLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBlbGVtZW50LnRleHQodmFsdWUpOwogICAgfSk7CiAgfTsKfV07CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdCaW5kSHRtbAogKgogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlcyBhIGJpbmRpbmcgdGhhdCB3aWxsIGlubmVySFRNTCB0aGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGBleHByZXNzaW9uYCBpbnRvIHRoZSBjdXJyZW50CiAqIGVsZW1lbnQgaW4gYSBzZWN1cmUgd2F5LiAgQnkgZGVmYXVsdCwgdGhlIGlubmVySFRNTC1lZCBjb250ZW50IHdpbGwgYmUgc2FuaXRpemVkIHVzaW5nIHRoZSB7QGxpbmsKICogbmdTYW5pdGl6ZS4kc2FuaXRpemUgJHNhbml0aXplfSBzZXJ2aWNlLiAgVG8gdXRpbGl6ZSB0aGlzIGZ1bmN0aW9uYWxpdHksIGVuc3VyZSB0aGF0IGAkc2FuaXRpemVgCiAqIGlzIGF2YWlsYWJsZSwgZm9yIGV4YW1wbGUsIGJ5IGluY2x1ZGluZyB7QGxpbmsgbmdTYW5pdGl6ZX0gaW4geW91ciBtb2R1bGUncyBkZXBlbmRlbmNpZXMgKG5vdCBpbgogKiBjb3JlIEFuZ3VsYXIuKSAgWW91IG1heSBhbHNvIGJ5cGFzcyBzYW5pdGl6YXRpb24gZm9yIHZhbHVlcyB5b3Uga25vdyBhcmUgc2FmZS4gVG8gZG8gc28sIGJpbmQgdG8KICogYW4gZXhwbGljaXRseSB0cnVzdGVkIHZhbHVlIHZpYSB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzSHRtbCAkc2NlLnRydXN0QXNIdG1sfS4gIFNlZSB0aGUgZXhhbXBsZQogKiB1bmRlciB7QGxpbmsgbmcuJHNjZSNFeGFtcGxlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfS4KICoKICogTm90ZTogSWYgYSBgJHNhbml0aXplYCBzZXJ2aWNlIGlzIHVuYXZhaWxhYmxlIGFuZCB0aGUgYm91bmQgdmFsdWUgaXNuJ3QgZXhwbGljaXRseSB0cnVzdGVkLCB5b3UKICogd2lsbCBoYXZlIGFuIGV4Y2VwdGlvbiAoaW5zdGVhZCBvZiBhbiBleHBsb2l0LikKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCaW5kSHRtbCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICoKICogQGV4YW1wbGUKICAgVHJ5IGl0IGhlcmU6IGVudGVyIHRleHQgaW4gdGV4dCBib3ggYW5kIHdhdGNoIHRoZSBncmVldGluZyBjaGFuZ2UuCgogICA8ZXhhbXBsZSBtb2R1bGU9Im5nQmluZEh0bWxFeGFtcGxlIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0ibmdCaW5kSHRtbEN0cmwiPgogICAgICAgIDxwIG5nLWJpbmQtaHRtbD0ibXlIVE1MIj48L3A+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICBhbmd1bGFyLm1vZHVsZSgnbmdCaW5kSHRtbEV4YW1wbGUnLCBbJ25nU2FuaXRpemUnXSkKCiAgICAgICAuY29udHJvbGxlcignbmdCaW5kSHRtbEN0cmwnLCBbJyRzY29wZScsIGZ1bmN0aW9uIG5nQmluZEh0bWxDdHJsKCRzY29wZSkgewogICAgICAgICAkc2NvcGUubXlIVE1MID0KICAgICAgICAgICAgJ0kgYW0gYW4gPGNvZGU+SFRNTDwvY29kZT5zdHJpbmcgd2l0aCA8YSBocmVmPSIjIj5saW5rcyE8L2E+IGFuZCBvdGhlciA8ZW0+c3R1ZmY8L2VtPic7CiAgICAgICB9XSk7CiAgICAgPC9maWxlPgoKICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZC1odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ215SFRNTCcpKS5nZXRUZXh0KCkpLnRvQmUoCiAgICAgICAgICAgICAnSSBhbSBhbiBIVE1Mc3RyaW5nIHdpdGggbGlua3MhIGFuZCBvdGhlciBzdHVmZicpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdCaW5kSHRtbERpcmVjdGl2ZSA9IFsnJHNjZScsICckcGFyc2UnLCBmdW5jdGlvbigkc2NlLCAkcGFyc2UpIHsKICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbCk7CgogICAgdmFyIHBhcnNlZCA9ICRwYXJzZShhdHRyLm5nQmluZEh0bWwpOwogICAgZnVuY3Rpb24gZ2V0U3RyaW5nVmFsdWUoKSB7IHJldHVybiAocGFyc2VkKHNjb3BlKSB8fCAnJykudG9TdHJpbmcoKTsgfQoKICAgIHNjb3BlLiR3YXRjaChnZXRTdHJpbmdWYWx1ZSwgZnVuY3Rpb24gbmdCaW5kSHRtbFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgIGVsZW1lbnQuaHRtbCgkc2NlLmdldFRydXN0ZWRIdG1sKHBhcnNlZChzY29wZSkpIHx8ICcnKTsKICAgIH0pOwogIH07Cn1dOwoKZnVuY3Rpb24gY2xhc3NEaXJlY3RpdmUobmFtZSwgc2VsZWN0b3IpIHsKICBuYW1lID0gJ25nQ2xhc3MnICsgbmFtZTsKICByZXR1cm4gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0FDJywKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICB2YXIgb2xkVmFsOwoKICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltuYW1lXSwgbmdDbGFzc1dhdGNoQWN0aW9uLCB0cnVlKTsKCiAgICAgICAgYXR0ci4kb2JzZXJ2ZSgnY2xhc3MnLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgbmdDbGFzc1dhdGNoQWN0aW9uKHNjb3BlLiRldmFsKGF0dHJbbmFtZV0pKTsKICAgICAgICB9KTsKCgogICAgICAgIGlmIChuYW1lICE9PSAnbmdDbGFzcycpIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaCgnJGluZGV4JywgZnVuY3Rpb24oJGluZGV4LCBvbGQkaW5kZXgpIHsKICAgICAgICAgICAgLy8ganNoaW50IGJpdHdpc2U6IGZhbHNlCiAgICAgICAgICAgIHZhciBtb2QgPSAkaW5kZXggJiAxOwogICAgICAgICAgICBpZiAobW9kICE9PSAob2xkJGluZGV4ICYgMSkpIHsKICAgICAgICAgICAgICB2YXIgY2xhc3NlcyA9IGFycmF5Q2xhc3NlcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgbW9kID09PSBzZWxlY3RvciA/CiAgICAgICAgICAgICAgICBhZGRDbGFzc2VzKGNsYXNzZXMpIDoKICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzZXMoY2xhc3Nlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRkQ2xhc3NlcyhjbGFzc2VzKSB7CiAgICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IGRpZ2VzdENsYXNzQ291bnRzKGNsYXNzZXMsIDEpOwogICAgICAgICAgYXR0ci4kYWRkQ2xhc3MobmV3Q2xhc3Nlcyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZW1vdmVDbGFzc2VzKGNsYXNzZXMpIHsKICAgICAgICAgIHZhciBuZXdDbGFzc2VzID0gZGlnZXN0Q2xhc3NDb3VudHMoY2xhc3NlcywgLTEpOwogICAgICAgICAgYXR0ci4kcmVtb3ZlQ2xhc3MobmV3Q2xhc3Nlcyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkaWdlc3RDbGFzc0NvdW50cyAoY2xhc3NlcywgY291bnQpIHsKICAgICAgICAgIHZhciBjbGFzc0NvdW50cyA9IGVsZW1lbnQuZGF0YSgnJGNsYXNzQ291bnRzJykgfHwge307CiAgICAgICAgICB2YXIgY2xhc3Nlc1RvVXBkYXRlID0gW107CiAgICAgICAgICBmb3JFYWNoKGNsYXNzZXMsIGZ1bmN0aW9uIChjbGFzc05hbWUpIHsKICAgICAgICAgICAgaWYgKGNvdW50ID4gMCB8fCBjbGFzc0NvdW50c1tjbGFzc05hbWVdKSB7CiAgICAgICAgICAgICAgY2xhc3NDb3VudHNbY2xhc3NOYW1lXSA9IChjbGFzc0NvdW50c1tjbGFzc05hbWVdIHx8IDApICsgY291bnQ7CiAgICAgICAgICAgICAgaWYgKGNsYXNzQ291bnRzW2NsYXNzTmFtZV0gPT09ICsoY291bnQgPiAwKSkgewogICAgICAgICAgICAgICAgY2xhc3Nlc1RvVXBkYXRlLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgZWxlbWVudC5kYXRhKCckY2xhc3NDb3VudHMnLCBjbGFzc0NvdW50cyk7CiAgICAgICAgICByZXR1cm4gY2xhc3Nlc1RvVXBkYXRlLmpvaW4oJyAnKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzZXMgKG9sZENsYXNzZXMsIG5ld0NsYXNzZXMpIHsKICAgICAgICAgIHZhciB0b0FkZCA9IGFycmF5RGlmZmVyZW5jZShuZXdDbGFzc2VzLCBvbGRDbGFzc2VzKTsKICAgICAgICAgIHZhciB0b1JlbW92ZSA9IGFycmF5RGlmZmVyZW5jZShvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKTsKICAgICAgICAgIHRvUmVtb3ZlID0gZGlnZXN0Q2xhc3NDb3VudHModG9SZW1vdmUsIC0xKTsKICAgICAgICAgIHRvQWRkID0gZGlnZXN0Q2xhc3NDb3VudHModG9BZGQsIDEpOwoKICAgICAgICAgIGlmICh0b0FkZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoZWxlbWVudCwgdG9SZW1vdmUpOwogICAgICAgICAgfSBlbHNlIGlmICh0b1JlbW92ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgdG9BZGQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJGFuaW1hdGUuc2V0Q2xhc3MoZWxlbWVudCwgdG9BZGQsIHRvUmVtb3ZlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG5nQ2xhc3NXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gdHJ1ZSB8fCBzY29wZS4kaW5kZXggJSAyID09PSBzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IGFycmF5Q2xhc3NlcyhuZXdWYWwgfHwgW10pOwogICAgICAgICAgICBpZiAoIW9sZFZhbCkgewogICAgICAgICAgICAgIGFkZENsYXNzZXMobmV3Q2xhc3Nlcyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWVxdWFscyhuZXdWYWwsb2xkVmFsKSkgewogICAgICAgICAgICAgIHZhciBvbGRDbGFzc2VzID0gYXJyYXlDbGFzc2VzKG9sZFZhbCk7CiAgICAgICAgICAgICAgdXBkYXRlQ2xhc3NlcyhvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgb2xkVmFsID0gc2hhbGxvd0NvcHkobmV3VmFsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24gYXJyYXlEaWZmZXJlbmNlKHRva2VuczEsIHRva2VuczIpIHsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwoKICAgICAgb3V0ZXI6CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0b2tlbnMxLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zMVtpXTsKICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgdG9rZW5zMi5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYodG9rZW4gPT0gdG9rZW5zMltqXSkgY29udGludWUgb3V0ZXI7CiAgICAgICAgfQogICAgICAgIHZhbHVlcy5wdXNoKHRva2VuKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWVzOwogICAgfQoKICAgIGZ1bmN0aW9uIGFycmF5Q2xhc3NlcyAoY2xhc3NWYWwpIHsKICAgICAgaWYgKGlzQXJyYXkoY2xhc3NWYWwpKSB7CiAgICAgICAgcmV0dXJuIGNsYXNzVmFsOwogICAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKGNsYXNzVmFsKSkgewogICAgICAgIHJldHVybiBjbGFzc1ZhbC5zcGxpdCgnICcpOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGNsYXNzVmFsKSkgewogICAgICAgIHZhciBjbGFzc2VzID0gW10sIGkgPSAwOwogICAgICAgIGZvckVhY2goY2xhc3NWYWwsIGZ1bmN0aW9uKHYsIGspIHsKICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgIGNsYXNzZXMgPSBjbGFzc2VzLmNvbmNhdChrLnNwbGl0KCcgJykpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBjbGFzc2VzOwogICAgICB9CiAgICAgIHJldHVybiBjbGFzc1ZhbDsKICAgIH0KICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDbGFzcwogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdDbGFzc2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gZHluYW1pY2FsbHkgc2V0IENTUyBjbGFzc2VzIG9uIGFuIEhUTUwgZWxlbWVudCBieSBkYXRhYmluZGluZwogKiBhbiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICoKICogVGhlIGRpcmVjdGl2ZSBvcGVyYXRlcyBpbiB0aHJlZSBkaWZmZXJlbnQgd2F5cywgZGVwZW5kaW5nIG9uIHdoaWNoIG9mIHRocmVlIHR5cGVzIHRoZSBleHByZXNzaW9uCiAqIGV2YWx1YXRlcyB0bzoKICoKICogMS4gSWYgdGhlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgc3RyaW5nLCB0aGUgc3RyaW5nIHNob3VsZCBiZSBvbmUgb3IgbW9yZSBzcGFjZS1kZWxpbWl0ZWQgY2xhc3MKICogbmFtZXMuCiAqCiAqIDIuIElmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhbiBhcnJheSwgZWFjaCBlbGVtZW50IG9mIHRoZSBhcnJheSBzaG91bGQgYmUgYSBzdHJpbmcgdGhhdCBpcwogKiBvbmUgb3IgbW9yZSBzcGFjZS1kZWxpbWl0ZWQgY2xhc3MgbmFtZXMuCiAqCiAqIDMuIElmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhbiBvYmplY3QsIHRoZW4gZm9yIGVhY2gga2V5LXZhbHVlIHBhaXIgb2YgdGhlCiAqIG9iamVjdCB3aXRoIGEgdHJ1dGh5IHZhbHVlIHRoZSBjb3JyZXNwb25kaW5nIGtleSBpcyB1c2VkIGFzIGEgY2xhc3MgbmFtZS4KICoKICogVGhlIGRpcmVjdGl2ZSB3b24ndCBhZGQgZHVwbGljYXRlIGNsYXNzZXMgaWYgYSBwYXJ0aWN1bGFyIGNsYXNzIHdhcyBhbHJlYWR5IHNldC4KICoKICogV2hlbiB0aGUgZXhwcmVzc2lvbiBjaGFuZ2VzLCB0aGUgcHJldmlvdXNseSBhZGRlZCBjbGFzc2VzIGFyZSByZW1vdmVkIGFuZCBvbmx5IHRoZW4gdGhlCiAqIG5ldyBjbGFzc2VzIGFyZSBhZGRlZC4KICoKICogQGFuaW1hdGlvbnMKICogYWRkIC0gaGFwcGVucyBqdXN0IGJlZm9yZSB0aGUgY2xhc3MgaXMgYXBwbGllZCB0byB0aGUgZWxlbWVudAogKiByZW1vdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBjbGFzcyBpcyByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MKICogICBuYW1lcywgYW4gYXJyYXksIG9yIGEgbWFwIG9mIGNsYXNzIG5hbWVzIHRvIGJvb2xlYW4gdmFsdWVzLiBJbiB0aGUgY2FzZSBvZiBhIG1hcCwgdGhlCiAqICAgbmFtZXMgb2YgdGhlIHByb3BlcnRpZXMgd2hvc2UgdmFsdWVzIGFyZSB0cnV0aHkgd2lsbCBiZSBhZGRlZCBhcyBjc3MgY2xhc3NlcyB0byB0aGUKICogICBlbGVtZW50LgogKgogKiBAZXhhbXBsZSBFeGFtcGxlIHRoYXQgZGVtb25zdHJhdGVzIGJhc2ljIGJpbmRpbmdzIHZpYSBuZ0NsYXNzIGRpcmVjdGl2ZS4KICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8cCBuZy1jbGFzcz0ie3N0cmlrZTogZGVsZXRlZCwgYm9sZDogaW1wb3J0YW50LCByZWQ6IGVycm9yfSI+TWFwIFN5bnRheCBFeGFtcGxlPC9wPgogICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iZGVsZXRlZCI+IGRlbGV0ZWQgKGFwcGx5ICJzdHJpa2UiIGNsYXNzKTxicj4KICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImltcG9ydGFudCI+IGltcG9ydGFudCAoYXBwbHkgImJvbGQiIGNsYXNzKTxicj4KICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImVycm9yIj4gZXJyb3IgKGFwcGx5ICJyZWQiIGNsYXNzKQogICAgICAgPGhyPgogICAgICAgPHAgbmctY2xhc3M9InN0eWxlIj5Vc2luZyBTdHJpbmcgU3ludGF4PC9wPgogICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzdHlsZSIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQgc3RyaWtlIHJlZCI+CiAgICAgICA8aHI+CiAgICAgICA8cCBuZy1jbGFzcz0iW3N0eWxlMSwgc3R5bGUyLCBzdHlsZTNdIj5Vc2luZyBBcnJheSBTeW50YXg8L3A+CiAgICAgICA8aW5wdXQgbmctbW9kZWw9InN0eWxlMSIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQsIHN0cmlrZSBvciByZWQiPjxicj4KICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUyIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCwgc3RyaWtlIG9yIHJlZCI+PGJyPgogICAgICAgPGlucHV0IG5nLW1vZGVsPSJzdHlsZTMiIHBsYWNlaG9sZGVyPSJUeXBlOiBib2xkLCBzdHJpa2Ugb3IgcmVkIj48YnI+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAuc3RyaWtlIHsKICAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiBsaW5lLXRocm91Z2g7CiAgICAgICB9CiAgICAgICAuYm9sZCB7CiAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICB9CiAgICAgICAucmVkIHsKICAgICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIHZhciBwcyA9IGVsZW1lbnQuYWxsKGJ5LmNzcygncCcpKTsKCiAgICAgICBpdCgnc2hvdWxkIGxldCB5b3UgdG9nZ2xlIHRoZSBjbGFzcycsIGZ1bmN0aW9uKCkgewoKICAgICAgICAgZXhwZWN0KHBzLmZpcnN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS5ub3QudG9NYXRjaCgvYm9sZC8pOwogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC50b01hdGNoKC9yZWQvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2ltcG9ydGFudCcpKS5jbGljaygpOwogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvTWF0Y2goL2JvbGQvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2Vycm9yJykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChwcy5maXJzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9NYXRjaCgvcmVkLyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIGxldCB5b3UgdG9nZ2xlIHN0cmluZyBleGFtcGxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChwcy5nZXQoMSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b0JlKCcnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUnKSkuY2xlYXIoKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUnKSkuc2VuZEtleXMoJ3JlZCcpOwogICAgICAgICBleHBlY3QocHMuZ2V0KDEpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9CZSgncmVkJyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnYXJyYXkgZXhhbXBsZSBzaG91bGQgaGF2ZSAzIGNsYXNzZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHBzLmxhc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJycpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZTEnKSkuc2VuZEtleXMoJ2JvbGQnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUyJykpLnNlbmRLZXlzKCdzdHJpa2UnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUzJykpLnNlbmRLZXlzKCdyZWQnKTsKICAgICAgICAgZXhwZWN0KHBzLmxhc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJ2JvbGQgc3RyaWtlIHJlZCcpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CgogICAjIyBBbmltYXRpb25zCgogICBUaGUgZXhhbXBsZSBiZWxvdyBkZW1vbnN0cmF0ZXMgaG93IHRvIHBlcmZvcm0gYW5pbWF0aW9ucyB1c2luZyBuZ0NsYXNzLgoKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxpbnB1dCBpZD0ic2V0YnRuIiB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVZhcj0nbXktY2xhc3MnIj4KICAgICAgPGlucHV0IGlkPSJjbGVhcmJ0biIgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVZhcj0nJyI+CiAgICAgIDxicj4KICAgICAgPHNwYW4gY2xhc3M9ImJhc2UtY2xhc3MiIG5nLWNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAuYmFzZS1jbGFzcyB7CiAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICB9CgogICAgICAgLmJhc2UtY2xhc3MubXktY2xhc3MgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgICBmb250LXNpemU6M2VtOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcuYmFzZS1jbGFzcycpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwoKICAgICAgICAgZWxlbWVudChieS5pZCgnc2V0YnRuJykpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5iYXNlLWNsYXNzJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2NsZWFyYnRuJykpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5iYXNlLWNsYXNzJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkubm90LgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KCgogICAjIyBuZ0NsYXNzIGFuZCBwcmUtZXhpc3RpbmcgQ1NTMyBUcmFuc2l0aW9ucy9BbmltYXRpb25zCiAgIFRoZSBuZ0NsYXNzIGRpcmVjdGl2ZSBzdGlsbCBzdXBwb3J0cyBDU1MzIFRyYW5zaXRpb25zL0FuaW1hdGlvbnMgZXZlbiBpZiB0aGV5IGRvIG5vdCBmb2xsb3cgdGhlIG5nQW5pbWF0ZSBDU1MgbmFtaW5nIHN0cnVjdHVyZS4KICAgVXBvbiBhbmltYXRpb24gbmdBbmltYXRlIHdpbGwgYXBwbHkgc3VwcGxlbWVudGFyeSBDU1MgY2xhc3NlcyB0byB0cmFjayB0aGUgc3RhcnQgYW5kIGVuZCBvZiBhbiBhbmltYXRpb24sIGJ1dCB0aGlzIHdpbGwgbm90IGhpbmRlcgogICBhbnkgcHJlLWV4aXN0aW5nIENTUyB0cmFuc2l0aW9ucyBhbHJlYWR5IG9uIHRoZSBlbGVtZW50LiBUbyBnZXQgYW4gaWRlYSBvZiB3aGF0IGhhcHBlbnMgZHVyaW5nIGEgY2xhc3MtYmFzZWQgYW5pbWF0aW9uLCBiZSBzdXJlCiAgIHRvIHZpZXcgdGhlIHN0ZXAgYnkgc3RlcCBkZXRhaWxzIG9mIHtAbGluayBuZ0FuaW1hdGUuJGFuaW1hdGUjYWRkY2xhc3MgJGFuaW1hdGUuYWRkQ2xhc3N9IGFuZAogICB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlI3JlbW92ZWNsYXNzICRhbmltYXRlLnJlbW92ZUNsYXNzfS4KICovCnZhciBuZ0NsYXNzRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJycsIHRydWUpOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDbGFzc09kZAogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdDbGFzc09kZGAgYW5kIGBuZ0NsYXNzRXZlbmAgZGlyZWN0aXZlcyB3b3JrIGV4YWN0bHkgYXMKICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgdGhleSB3b3JrIGluCiAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZSBlZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAqCiAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIHRoZSBzY29wZSBvZiBhbgogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fS4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzc09kZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgICAgICAgIDxsaSBuZy1yZXBlYXQ9Im5hbWUgaW4gbmFtZXMiPgogICAgICAgICAgIDxzcGFuIG5nLWNsYXNzLW9kZD0iJ29kZCciIG5nLWNsYXNzLWV2ZW49IidldmVuJyI+CiAgICAgICAgICAgICB7e25hbWV9fQogICAgICAgICAgIDwvc3Bhbj4KICAgICAgICAgIDwvbGk+CiAgICAgICAgPC9vbD4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgIC5vZGQgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAgICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzLW9kZCBhbmQgbmctY2xhc3MtZXZlbicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygwKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9vZGQvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkucmVwZWF0ZXIoJ25hbWUgaW4gbmFtZXMnKS5yb3coMSkuY29sdW1uKCduYW1lJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdDbGFzc09kZERpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdPZGQnLCAwKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2xhc3NFdmVuCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCB0aGV5IHdvcmsgaW4KICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlIGVmZmVjdCBvbmx5IG9uIG9kZCAoZXZlbikgcm93cy4KICoKICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gdGhlIHNjb3BlIG9mIGFuCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzRXZlbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUKICogICByZXN1bHQgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgICAgICAgIDxsaSBuZy1yZXBlYXQ9Im5hbWUgaW4gbmFtZXMiPgogICAgICAgICAgIDxzcGFuIG5nLWNsYXNzLW9kZD0iJ29kZCciIG5nLWNsYXNzLWV2ZW49IidldmVuJyI+CiAgICAgICAgICAgICB7e25hbWV9fSAmbmJzcDsgJm5ic3A7ICZuYnNwOwogICAgICAgICAgIDwvc3Bhbj4KICAgICAgICAgIDwvbGk+CiAgICAgICAgPC9vbD4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgIC5vZGQgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAgICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzLW9kZCBhbmQgbmctY2xhc3MtZXZlbicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygwKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9vZGQvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkucmVwZWF0ZXIoJ25hbWUgaW4gbmFtZXMnKS5yb3coMSkuY29sdW1uKCduYW1lJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdDbGFzc0V2ZW5EaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnRXZlbicsIDEpOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDbG9hawogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdDbG9ha2AgZGlyZWN0aXZlIGlzIHVzZWQgdG8gcHJldmVudCB0aGUgQW5ndWxhciBodG1sIHRlbXBsYXRlIGZyb20gYmVpbmcgYnJpZWZseQogKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyAodW5jb21waWxlZCkgZm9ybSB3aGlsZSB5b3VyIGFwcGxpY2F0aW9uIGlzIGxvYWRpbmcuIFVzZSB0aGlzCiAqIGRpcmVjdGl2ZSB0byBhdm9pZCB0aGUgdW5kZXNpcmFibGUgZmxpY2tlciBlZmZlY3QgY2F1c2VkIGJ5IHRoZSBodG1sIHRlbXBsYXRlIGRpc3BsYXkuCiAqCiAqIFRoZSBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgdG8gdGhlIGA8Ym9keT5gIGVsZW1lbnQsIGJ1dCB0aGUgcHJlZmVycmVkIHVzYWdlIGlzIHRvIGFwcGx5CiAqIG11bHRpcGxlIGBuZ0Nsb2FrYCBkaXJlY3RpdmVzIHRvIHNtYWxsIHBvcnRpb25zIG9mIHRoZSBwYWdlIHRvIHBlcm1pdCBwcm9ncmVzc2l2ZSByZW5kZXJpbmcKICogb2YgdGhlIGJyb3dzZXIgdmlldy4KICoKICogYG5nQ2xvYWtgIHdvcmtzIGluIGNvb3BlcmF0aW9uIHdpdGggdGhlIGZvbGxvd2luZyBjc3MgcnVsZSBlbWJlZGRlZCB3aXRoaW4gYGFuZ3VsYXIuanNgIGFuZAogKiBgYW5ndWxhci5taW4uanNgLgogKiBGb3IgQ1NQIG1vZGUgcGxlYXNlIGFkZCBgYW5ndWxhci1jc3AuY3NzYCB0byB5b3VyIGh0bWwgZmlsZSAoc2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDc3AgbmdDc3B9KS4KICoKICogYGBgY3NzCiAqIFtuZ1w6Y2xvYWtdLCBbbmctY2xvYWtdLCBbZGF0YS1uZy1jbG9ha10sIFt4LW5nLWNsb2FrXSwgLm5nLWNsb2FrLCAueC1uZy1jbG9hayB7CiAqICAgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OwogKiB9CiAqIGBgYAogKgogKiBXaGVuIHRoaXMgY3NzIHJ1bGUgaXMgbG9hZGVkIGJ5IHRoZSBicm93c2VyLCBhbGwgaHRtbCBlbGVtZW50cyAoaW5jbHVkaW5nIHRoZWlyIGNoaWxkcmVuKSB0aGF0CiAqIGFyZSB0YWdnZWQgd2l0aCB0aGUgYG5nQ2xvYWtgIGRpcmVjdGl2ZSBhcmUgaGlkZGVuLiBXaGVuIEFuZ3VsYXIgZW5jb3VudGVycyB0aGlzIGRpcmVjdGl2ZQogKiBkdXJpbmcgdGhlIGNvbXBpbGF0aW9uIG9mIHRoZSB0ZW1wbGF0ZSBpdCBkZWxldGVzIHRoZSBgbmdDbG9ha2AgZWxlbWVudCBhdHRyaWJ1dGUsIG1ha2luZwogKiB0aGUgY29tcGlsZWQgZWxlbWVudCB2aXNpYmxlLgogKgogKiBGb3IgdGhlIGJlc3QgcmVzdWx0LCB0aGUgYGFuZ3VsYXIuanNgIHNjcmlwdCBtdXN0IGJlIGxvYWRlZCBpbiB0aGUgaGVhZCBzZWN0aW9uIG9mIHRoZSBodG1sCiAqIGRvY3VtZW50OyBhbHRlcm5hdGl2ZWx5LCB0aGUgY3NzIHJ1bGUgYWJvdmUgbXVzdCBiZSBpbmNsdWRlZCBpbiB0aGUgZXh0ZXJuYWwgc3R5bGVzaGVldCBvZiB0aGUKICogYXBwbGljYXRpb24uCiAqCiAqIExlZ2FjeSBicm93c2VycywgbGlrZSBJRTcsIGRvIG5vdCBwcm92aWRlIGF0dHJpYnV0ZSBzZWxlY3RvciBzdXBwb3J0IChhZGRlZCBpbiBDU1MgMi4xKSBzbyB0aGV5CiAqIGNhbm5vdCBtYXRjaCB0aGUgYFtuZ1w6Y2xvYWtdYCBzZWxlY3Rvci4gVG8gd29yayBhcm91bmQgdGhpcyBsaW1pdGF0aW9uLCB5b3UgbXVzdCBhZGQgdGhlIGNzcwogKiBjbGFzcyBgbmctY2xvYWtgIGluIGFkZGl0aW9uIHRvIHRoZSBgbmdDbG9ha2AgZGlyZWN0aXZlIGFzIHNob3duIGluIHRoZSBleGFtcGxlIGJlbG93LgogKgogKiBAZWxlbWVudCBBTlkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPGRpdiBpZD0idGVtcGxhdGUxIiBuZy1jbG9haz57eyAnaGVsbG8nIH19PC9kaXY+CiAgICAgICAgPGRpdiBpZD0idGVtcGxhdGUyIiBuZy1jbG9hayBjbGFzcz0ibmctY2xvYWsiPnt7ICdoZWxsbyBJRTcnIH19PC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCByZW1vdmUgdGhlIHRlbXBsYXRlIGRpcmVjdGl2ZSBhbmQgY3NzIGNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCgkKCcjdGVtcGxhdGUxJykuZ2V0QXR0cmlidXRlKCduZy1jbG9haycpKS4KICAgICAgICAgICB0b0JlTnVsbCgpOwogICAgICAgICBleHBlY3QoJCgnI3RlbXBsYXRlMicpLmdldEF0dHJpYnV0ZSgnbmctY2xvYWsnKSkuCiAgICAgICAgICAgdG9CZU51bGwoKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKgogKi8KdmFyIG5nQ2xvYWtEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgYXR0ci4kc2V0KCduZ0Nsb2FrJywgdW5kZWZpbmVkKTsKICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoJ25nLWNsb2FrJyk7CiAgfQp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ29udHJvbGxlcgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZSBhdHRhY2hlcyBhIGNvbnRyb2xsZXIgY2xhc3MgdG8gdGhlIHZpZXcuIFRoaXMgaXMgYSBrZXkgYXNwZWN0IG9mIGhvdyBhbmd1bGFyCiAqIHN1cHBvcnRzIHRoZSBwcmluY2lwbGVzIGJlaGluZCB0aGUgTW9kZWwtVmlldy1Db250cm9sbGVyIGRlc2lnbiBwYXR0ZXJuLgogKgogKiBNVkMgY29tcG9uZW50cyBpbiBhbmd1bGFyOgogKgogKiAqIE1vZGVsIOKAlCBUaGUgTW9kZWwgaXMgc2NvcGUgcHJvcGVydGllczsgc2NvcGVzIGFyZSBhdHRhY2hlZCB0byB0aGUgRE9NIHdoZXJlIHNjb3BlIHByb3BlcnRpZXMKICogICBhcmUgYWNjZXNzZWQgdGhyb3VnaCBiaW5kaW5ncy4KICogKiBWaWV3IOKAlCBUaGUgdGVtcGxhdGUgKEhUTUwgd2l0aCBkYXRhIGJpbmRpbmdzKSB0aGF0IGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAqICogQ29udHJvbGxlciDigJQgVGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgYSBDb250cm9sbGVyIGNsYXNzOyB0aGUgY2xhc3MgY29udGFpbnMgYnVzaW5lc3MKICogICBsb2dpYyBiZWhpbmQgdGhlIGFwcGxpY2F0aW9uIHRvIGRlY29yYXRlIHRoZSBzY29wZSB3aXRoIGZ1bmN0aW9ucyBhbmQgdmFsdWVzCiAqCiAqIE5vdGUgdGhhdCB5b3UgY2FuIGFsc28gYXR0YWNoIGNvbnRyb2xsZXJzIHRvIHRoZSBET00gYnkgZGVjbGFyaW5nIGl0IGluIGEgcm91dGUgZGVmaW5pdGlvbgogKiB2aWEgdGhlIHtAbGluayBuZ1JvdXRlLiRyb3V0ZSAkcm91dGV9IHNlcnZpY2UuIEEgY29tbW9uIG1pc3Rha2UgaXMgdG8gZGVjbGFyZSB0aGUgY29udHJvbGxlcgogKiBhZ2FpbiB1c2luZyBgbmctY29udHJvbGxlcmAgaW4gdGhlIHRlbXBsYXRlIGl0c2VsZi4gIFRoaXMgd2lsbCBjYXVzZSB0aGUgY29udHJvbGxlciB0byBiZSBhdHRhY2hlZAogKiBhbmQgZXhlY3V0ZWQgdHdpY2UuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAc2NvcGUKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NvbnRyb2xsZXIgTmFtZSBvZiBhIGdsb2JhbGx5IGFjY2Vzc2libGUgY29uc3RydWN0b3IgZnVuY3Rpb24gb3IgYW4KICogICAgIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IHRoYXQgb24gdGhlIGN1cnJlbnQgc2NvcGUgZXZhbHVhdGVzIHRvIGEKICogICAgIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBUaGUgY29udHJvbGxlciBpbnN0YW5jZSBjYW4gYmUgcHVibGlzaGVkIGludG8gYSBzY29wZSBwcm9wZXJ0eQogKiAgICAgYnkgc3BlY2lmeWluZyBgYXMgcHJvcGVydHlOYW1lYC4KICoKICogQGV4YW1wbGUKICogSGVyZSBpcyBhIHNpbXBsZSBmb3JtIGZvciBlZGl0aW5nIHVzZXIgY29udGFjdCBpbmZvcm1hdGlvbi4gQWRkaW5nLCByZW1vdmluZywgY2xlYXJpbmcsIGFuZAogKiBncmVldGluZyBhcmUgbWV0aG9kcyBkZWNsYXJlZCBvbiB0aGUgY29udHJvbGxlciAoc2VlIHNvdXJjZSB0YWIpLiBUaGVzZSBtZXRob2RzIGNhbgogKiBlYXNpbHkgYmUgY2FsbGVkIGZyb20gdGhlIGFuZ3VsYXIgbWFya3VwLiBBbnkgY2hhbmdlcyB0byB0aGUgZGF0YSBhcmUgYXV0b21hdGljYWxseSByZWZsZWN0ZWQKICogaW4gdGhlIFZpZXcgd2l0aG91dCB0aGUgbmVlZCBmb3IgYSBtYW51YWwgdXBkYXRlLgogKgogKiBUd28gZGlmZmVyZW50IGRlY2xhcmF0aW9uIHN0eWxlcyBhcmUgaW5jbHVkZWQgYmVsb3c6CiAqCiAqICogb25lIGJpbmRzIG1ldGhvZHMgYW5kIHByb3BlcnRpZXMgZGlyZWN0bHkgb250byB0aGUgY29udHJvbGxlciB1c2luZyBgdGhpc2A6CiAqIGBuZy1jb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIxIGFzIHNldHRpbmdzImAKICogKiBvbmUgaW5qZWN0cyBgJHNjb3BlYCBpbnRvIHRoZSBjb250cm9sbGVyOgogKiBgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMiJgCiAqCiAqIFRoZSBzZWNvbmQgb3B0aW9uIGlzIG1vcmUgY29tbW9uIGluIHRoZSBBbmd1bGFyIGNvbW11bml0eSwgYW5kIGlzIGdlbmVyYWxseSB1c2VkIGluIGJvaWxlcnBsYXRlcwogKiBhbmQgaW4gdGhpcyBndWlkZS4gSG93ZXZlciwgdGhlcmUgYXJlIGFkdmFudGFnZXMgdG8gYmluZGluZyBwcm9wZXJ0aWVzIGRpcmVjdGx5IHRvIHRoZSBjb250cm9sbGVyCiAqIGFuZCBhdm9pZGluZyBzY29wZS4KICoKICogKiBVc2luZyBgY29udHJvbGxlciBhc2AgbWFrZXMgaXQgb2J2aW91cyB3aGljaCBjb250cm9sbGVyIHlvdSBhcmUgYWNjZXNzaW5nIGluIHRoZSB0ZW1wbGF0ZSB3aGVuCiAqIG11bHRpcGxlIGNvbnRyb2xsZXJzIGFwcGx5IHRvIGFuIGVsZW1lbnQuCiAqICogSWYgeW91IGFyZSB3cml0aW5nIHlvdXIgY29udHJvbGxlcnMgYXMgY2xhc3NlcyB5b3UgaGF2ZSBlYXNpZXIgYWNjZXNzIHRvIHRoZSBwcm9wZXJ0aWVzIGFuZAogKiBtZXRob2RzLCB3aGljaCB3aWxsIGFwcGVhciBvbiB0aGUgc2NvcGUsIGZyb20gaW5zaWRlIHRoZSBjb250cm9sbGVyIGNvZGUuCiAqICogU2luY2UgdGhlcmUgaXMgYWx3YXlzIGEgYC5gIGluIHRoZSBiaW5kaW5ncywgeW91IGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgcHJvdG90eXBhbAogKiBpbmhlcml0YW5jZSBtYXNraW5nIHByaW1pdGl2ZXMuCiAqCiAqIFRoaXMgZXhhbXBsZSBkZW1vbnN0cmF0ZXMgdGhlIGBjb250cm9sbGVyIGFzYCBzeW50YXguCiAqCiAqIDxleGFtcGxlIG5hbWU9Im5nQ29udHJvbGxlckFzIj4KICogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICogICAgPGRpdiBpZD0iY3RybC1hcy1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMSBhcyBzZXR0aW5ncyI+CiAqICAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzZXR0aW5ncy5uYW1lIi8+CiAqICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5ncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAqICAgICAgQ29udGFjdDoKICogICAgICA8dWw+CiAqICAgICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzIj4KICogICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICogICAgICAgICAgICAgPG9wdGlvbj5waG9uZTwvb3B0aW9uPgogKiAgICAgICAgICAgICA8b3B0aW9uPmVtYWlsPC9vcHRpb24+CiAqICAgICAgICAgIDwvc2VsZWN0PgogKiAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9ImNvbnRhY3QudmFsdWUiLz4KICogICAgICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5jbGVhckNvbnRhY3QoY29udGFjdCkiPmNsZWFyPC9hPgogKiAgICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLnJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICogICAgICAgIDwvbGk+CiAqICAgICAgICA8bGk+WyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5hZGRDb250YWN0KCkiPmFkZDwvYT4gXTwvbGk+CiAqICAgICA8L3VsPgogKiAgICA8L2Rpdj4KICogICA8L2ZpbGU+CiAqICAgPGZpbGUgbmFtZT0iYXBwLmpzIj4KICogICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyMSgpIHsKICogICAgICB0aGlzLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAqICAgICAgdGhpcy5jb250YWN0cyA9IFsKICogICAgICAgIHt0eXBlOiAncGhvbmUnLCB2YWx1ZTogJzQwOCA1NTUgMTIxMid9LAogKiAgICAgICAge3R5cGU6ICdlbWFpbCcsIHZhbHVlOiAnam9obi5zbWl0aEBleGFtcGxlLm9yZyd9IF07CiAqICAgIH0KICoKICogICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICogICAgICBhbGVydCh0aGlzLm5hbWUpOwogKiAgICB9OwogKgogKiAgICBTZXR0aW5nc0NvbnRyb2xsZXIxLnByb3RvdHlwZS5hZGRDb250YWN0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOiAnZW1haWwnLCB2YWx1ZTogJ3lvdXJuYW1lQGV4YW1wbGUub3JnJ30pOwogKiAgICB9OwogKgogKiAgICBTZXR0aW5nc0NvbnRyb2xsZXIxLnByb3RvdHlwZS5yZW1vdmVDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAqICAgICB2YXIgaW5kZXggPSB0aGlzLmNvbnRhY3RzLmluZGV4T2YoY29udGFjdFRvUmVtb3ZlKTsKICogICAgICB0aGlzLmNvbnRhY3RzLnNwbGljZShpbmRleCwgMSk7CiAqICAgIH07CiAqCiAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICogICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogKiAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICogICAgfTsKICogICA8L2ZpbGU+CiAqICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAqICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXIgYXMnLCBmdW5jdGlvbigpIHsKICogICAgICAgdmFyIGNvbnRhaW5lciA9IGVsZW1lbnQoYnkuaWQoJ2N0cmwtYXMtZXhtcGwnKSk7CiAqICAgICAgICAgZXhwZWN0KGNvbnRhaW5lci5maW5kRWxlbWVudChieS5tb2RlbCgnc2V0dGluZ3MubmFtZScpKQogKiAgICAgICAgICAgLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnSm9obiBTbWl0aCcpOwogKgogKiAgICAgICB2YXIgZmlyc3RSZXBlYXQgPQogKiAgICAgICAgICAgY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzJykucm93KDApKTsKICogICAgICAgdmFyIHNlY29uZFJlcGVhdCA9CiAqICAgICAgICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMnKS5yb3coMSkpOwogKgogKiAgICAgICBleHBlY3QoZmlyc3RSZXBlYXQuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAgLnRvQmUoJzQwOCA1NTUgMTIxMicpOwogKgogKiAgICAgICBleHBlY3Qoc2Vjb25kUmVwZWF0LmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAqCiAqICAgICAgIGZpcnN0UmVwZWF0LmZpbmRFbGVtZW50KGJ5LmxpbmtUZXh0KCdjbGVhcicpKS5jbGljaygpOwogKgogKiAgICAgICBleHBlY3QoZmlyc3RSZXBlYXQuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAgLnRvQmUoJycpOwogKgogKiAgICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkubGlua1RleHQoJ2FkZCcpKS5jbGljaygpOwogKgogKiAgICAgICBleHBlY3QoY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzJykucm93KDIpKQogKiAgICAgICAgICAgLmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpCiAqICAgICAgICAgICAuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAgLnRvQmUoJ3lvdXJuYW1lQGV4YW1wbGUub3JnJyk7CiAqICAgICB9KTsKICogICA8L2ZpbGU+CiAqIDwvZXhhbXBsZT4KICoKICogVGhpcyBleGFtcGxlIGRlbW9uc3RyYXRlcyB0aGUgImF0dGFjaCB0byBgJHNjb3BlYCIgc3R5bGUgb2YgY29udHJvbGxlci4KICoKICogPGV4YW1wbGUgbmFtZT0ibmdDb250cm9sbGVyIj4KICogIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogKiAgIDxkaXYgaWQ9ImN0cmwtZXhtcGwiIG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjIiPgogKiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIi8+CiAqICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICogICAgIENvbnRhY3Q6CiAqICAgICA8dWw+CiAqICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogKiAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbnRhY3QudHlwZSI+CiAqICAgICAgICAgICAgPG9wdGlvbj5waG9uZTwvb3B0aW9uPgogKiAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICogICAgICAgICA8L3NlbGVjdD4KICogICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9ImNvbnRhY3QudmFsdWUiLz4KICogICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImNsZWFyQ29udGFjdChjb250YWN0KSI+Y2xlYXI8L2E+CiAqICAgICAgICAgfCA8YSBocmVmPSIiIG5nLWNsaWNrPSJyZW1vdmVDb250YWN0KGNvbnRhY3QpIj5YPC9hPiBdCiAqICAgICAgIDwvbGk+CiAqICAgICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9ImFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICogICAgPC91bD4KICogICA8L2Rpdj4KICogIDwvZmlsZT4KICogIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAqICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyMigkc2NvcGUpIHsKICogICAgICRzY29wZS5uYW1lID0gIkpvaG4gU21pdGgiOwogKiAgICAgJHNjb3BlLmNvbnRhY3RzID0gWwogKiAgICAgICB7dHlwZToncGhvbmUnLCB2YWx1ZTonNDA4IDU1NSAxMjEyJ30sCiAqICAgICAgIHt0eXBlOidlbWFpbCcsIHZhbHVlOidqb2huLnNtaXRoQGV4YW1wbGUub3JnJ30gXTsKICoKICogICAgICRzY29wZS5ncmVldCA9IGZ1bmN0aW9uKCkgewogKiAgICAgICBhbGVydCgkc2NvcGUubmFtZSk7CiAqICAgICB9OwogKgogKiAgICAgJHNjb3BlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICogICAgICAgJHNjb3BlLmNvbnRhY3RzLnB1c2goe3R5cGU6J2VtYWlsJywgdmFsdWU6J3lvdXJuYW1lQGV4YW1wbGUub3JnJ30pOwogKiAgICAgfTsKICoKICogICAgICRzY29wZS5yZW1vdmVDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAqICAgICAgIHZhciBpbmRleCA9ICRzY29wZS5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAqICAgICAgICRzY29wZS5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogKiAgICAgfTsKICoKICogICAgICRzY29wZS5jbGVhckNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0KSB7CiAqICAgICAgIGNvbnRhY3QudHlwZSA9ICdwaG9uZSc7CiAqICAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICogICAgIH07CiAqICAgfQogKiAgPC9maWxlPgogKiAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAqICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogKiAgICAgIHZhciBjb250YWluZXIgPSBlbGVtZW50KGJ5LmlkKCdjdHJsLWV4bXBsJykpOwogKgogKiAgICAgIGV4cGVjdChjb250YWluZXIuZmluZEVsZW1lbnQoYnkubW9kZWwoJ25hbWUnKSkKICogICAgICAgICAgLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnSm9obiBTbWl0aCcpOwogKgogKiAgICAgIHZhciBmaXJzdFJlcGVhdCA9CiAqICAgICAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBjb250YWN0cycpLnJvdygwKSk7CiAqICAgICAgdmFyIHNlY29uZFJlcGVhdCA9CiAqICAgICAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBjb250YWN0cycpLnJvdygxKSk7CiAqCiAqICAgICAgZXhwZWN0KGZpcnN0UmVwZWF0LmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgLnRvQmUoJzQwOCA1NTUgMTIxMicpOwogKiAgICAgIGV4cGVjdChzZWNvbmRSZXBlYXQuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAudG9CZSgnam9obi5zbWl0aEBleGFtcGxlLm9yZycpOwogKgogKiAgICAgIGZpcnN0UmVwZWF0LmZpbmRFbGVtZW50KGJ5LmxpbmtUZXh0KCdjbGVhcicpKS5jbGljaygpOwogKgogKiAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgIC50b0JlKCcnKTsKICoKICogICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkubGlua1RleHQoJ2FkZCcpKS5jbGljaygpOwogKgogKiAgICAgIGV4cGVjdChjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gY29udGFjdHMnKS5yb3coMikpCiAqICAgICAgICAgIC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKQogKiAgICAgICAgICAuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAudG9CZSgneW91cm5hbWVAZXhhbXBsZS5vcmcnKTsKICogICAgfSk7CiAqICA8L2ZpbGU+CiAqPC9leGFtcGxlPgoKICovCnZhciBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUgPSBbZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHNjb3BlOiB0cnVlLAogICAgY29udHJvbGxlcjogJ0AnLAogICAgcHJpb3JpdHk6IDUwMAogIH07Cn1dOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDc3AKICoKICogQGVsZW1lbnQgaHRtbAogKiBAZGVzY3JpcHRpb24KICogRW5hYmxlcyBbQ1NQIChDb250ZW50IFNlY3VyaXR5IFBvbGljeSldKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkgc3VwcG9ydC4KICoKICogVGhpcyBpcyBuZWNlc3Nhcnkgd2hlbiBkZXZlbG9waW5nIHRoaW5ncyBsaWtlIEdvb2dsZSBDaHJvbWUgRXh0ZW5zaW9ucy4KICoKICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogKiBGb3IgdXMgdG8gYmUgY29tcGF0aWJsZSwgd2UganVzdCBuZWVkIHRvIGltcGxlbWVudCB0aGUgImdldHRlckZuIiBpbiAkcGFyc2Ugd2l0aG91dCB2aW9sYXRpbmcKICogYW55IG9mIHRoZXNlIHJlc3RyaWN0aW9ucy4KICoKICogQW5ndWxhckpTIHVzZXMgYEZ1bmN0aW9uKHN0cmluZylgIGdlbmVyYXRlZCBmdW5jdGlvbnMgYXMgYSBzcGVlZCBvcHRpbWl6YXRpb24uIEFwcGx5aW5nIHRoZSBgbmdDc3BgCiAqIGRpcmVjdGl2ZSB3aWxsIGNhdXNlIEFuZ3VsYXIgdG8gdXNlIENTUCBjb21wYXRpYmlsaXR5IG1vZGUuIFdoZW4gdGhpcyBtb2RlIGlzIG9uIEFuZ3VsYXJKUyB3aWxsCiAqIGV2YWx1YXRlIGFsbCBleHByZXNzaW9ucyB1cCB0byAzMCUgc2xvd2VyIHRoYW4gaW4gbm9uLUNTUCBtb2RlLCBidXQgbm8gc2VjdXJpdHkgdmlvbGF0aW9ucyB3aWxsCiAqIGJlIHJhaXNlZC4KICoKICogQ1NQIGZvcmJpZHMgSmF2YVNjcmlwdCB0byBpbmxpbmUgc3R5bGVzaGVldCBydWxlcy4gSW4gbm9uIENTUCBtb2RlIEFuZ3VsYXIgYXV0b21hdGljYWxseQogKiBpbmNsdWRlcyBzb21lIENTUyBydWxlcyAoZS5nLiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xvYWsgbmdDbG9ha30pLgogKiBUbyBtYWtlIHRob3NlIGRpcmVjdGl2ZXMgd29yayBpbiBDU1AgbW9kZSwgaW5jbHVkZSB0aGUgYGFuZ3VsYXItY3NwLmNzc2AgbWFudWFsbHkuCiAqCiAqIEluIG9yZGVyIHRvIHVzZSB0aGlzIGZlYXR1cmUgcHV0IHRoZSBgbmdDc3BgIGRpcmVjdGl2ZSBvbiB0aGUgcm9vdCBlbGVtZW50IG9mIHRoZSBhcHBsaWNhdGlvbi4KICoKICogKk5vdGU6IFRoaXMgZGlyZWN0aXZlIGlzIG9ubHkgYXZhaWxhYmxlIGluIHRoZSBgbmctY3NwYCBhbmQgYGRhdGEtbmctY3NwYCBhdHRyaWJ1dGUgZm9ybS4qCiAqCiAqIEBleGFtcGxlCiAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICBgYGBodG1sCiAgICAgPCFkb2N0eXBlIGh0bWw+CiAgICAgPGh0bWwgbmctYXBwIG5nLWNzcD4KICAgICAuLi4KICAgICAuLi4KICAgICA8L2h0bWw+CiAgIGBgYAogKi8KCi8vIG5nQ3NwIGlzIG5vdCBpbXBsZW1lbnRlZCBhcyBhIHByb3BlciBkaXJlY3RpdmUgYW55IG1vcmUsIGJlY2F1c2Ugd2UgbmVlZCBpdCBiZSBwcm9jZXNzZWQgd2hpbGUgd2UgYm9vdHN0cmFwCi8vIHRoZSBzeXN0ZW0gKGJlZm9yZSAkcGFyc2UgaXMgaW5zdGFudGlhdGVkKSwgZm9yIHRoaXMgcmVhc29uIHdlIGp1c3QgaGF2ZSBhIGNzcCgpIGZuIHRoYXQgbG9va3MgZm9yIG5nLWNzcCBhdHRyaWJ1dGUKLy8gYW55d2hlcmUgaW4gdGhlIGN1cnJlbnQgZG9jCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NsaWNrCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbmdDbGljayBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAqIGFuIGVsZW1lbnQgaXMgY2xpY2tlZC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGljayB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGNsaWNrLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctY2xpY2s9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2NvdW50JykpLmdldFRleHQoKSkudG9NYXRjaCgnMCcpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnYnV0dG9uJykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2NvdW50JykpLmdldFRleHQoKSkudG9NYXRjaCgnMScpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwovKgogKiBBIGRpcmVjdGl2ZSB0aGF0IGFsbG93cyBjcmVhdGlvbiBvZiBjdXN0b20gb25jbGljayBoYW5kbGVycyB0aGF0IGFyZSBkZWZpbmVkIGFzIGFuZ3VsYXIKICogZXhwcmVzc2lvbnMgYW5kIGFyZSBjb21waWxlZCBhbmQgZXhlY3V0ZWQgd2l0aGluIHRoZSBjdXJyZW50IHNjb3BlLgogKgogKiBFdmVudHMgdGhhdCBhcmUgaGFuZGxlZCB2aWEgdGhlc2UgaGFuZGxlciBhcmUgYWx3YXlzIGNvbmZpZ3VyZWQgbm90IHRvIHByb3BhZ2F0ZSBmdXJ0aGVyLgogKi8KdmFyIG5nRXZlbnREaXJlY3RpdmVzID0ge307CmZvckVhY2goCiAgJ2NsaWNrIGRibGNsaWNrIG1vdXNlZG93biBtb3VzZXVwIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZW1vdmUgbW91c2VlbnRlciBtb3VzZWxlYXZlIGtleWRvd24ga2V5dXAga2V5cHJlc3Mgc3VibWl0IGZvY3VzIGJsdXIgY29weSBjdXQgcGFzdGUnLnNwbGl0KCcgJyksCiAgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBuYW1lKTsKICAgIG5nRXZlbnREaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gWyckcGFyc2UnLCBmdW5jdGlvbigkcGFyc2UpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgYXR0cikgewogICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJbZGlyZWN0aXZlTmFtZV0pOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQub24obG93ZXJjYXNlKG5hbWUpLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7JGV2ZW50OmV2ZW50fSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XTsKICB9Cik7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0RibGNsaWNrCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nRGJsY2xpY2tgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGEgZGJsY2xpY2sgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGJsY2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBhIGRibGNsaWNrLiAoVGhlIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLWRibGNsaWNrPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50IChvbiBkb3VibGUgY2xpY2spCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW91c2Vkb3duCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbmdNb3VzZWRvd24gZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vkb3duIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlZG93biB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIG1vdXNlZG93bi4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNlZG93bj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAob24gbW91c2UgZG93bikKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZXVwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZXVwIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNldXAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZXVwLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctbW91c2V1cD0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAob24gbW91c2UgdXApCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZW92ZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlb3ZlciBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW92ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZW92ZXIuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1tb3VzZW92ZXI9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKHdoZW4gbW91c2UgaXMgb3ZlcikKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZWVudGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWVudGVyIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlZW50ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZWVudGVyLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctbW91c2VlbnRlcj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBlbnRlcnMpCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW91c2VsZWF2ZQogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VsZWF2ZSBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWxlYXZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogbW91c2VsZWF2ZS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNlbGVhdmU9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKHdoZW4gbW91c2UgbGVhdmVzKQogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vdXNlbW92ZQogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vtb3ZlIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbW92ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIG1vdXNlbW92ZS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNlbW92ZT0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBtb3ZlcykKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdLZXlkb3duCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXlkb3duIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBrZXlkb3duLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGlucHV0IG5nLWtleWRvd249ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAga2V5IGRvd24gY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0tleXVwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXl1cCBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdLZXl1cCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGtleXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxwPlR5cGluZyBpbiB0aGUgaW5wdXQgYm94IGJlbG93IHVwZGF0ZXMgdGhlIGtleSBjb3VudDwvcD4KICAgICAgIDxpbnB1dCBuZy1rZXl1cD0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPiBrZXkgdXAgY291bnQ6IHt7Y291bnR9fQoKICAgICAgIDxwPlR5cGluZyBpbiB0aGUgaW5wdXQgYm94IGJlbG93IHVwZGF0ZXMgdGhlIGtleWNvZGU8L3A+CiAgICAgICA8aW5wdXQgbmcta2V5dXA9ImV2ZW50PSRldmVudCI+CiAgICAgICA8cD5ldmVudCBrZXlDb2RlOiB7eyBldmVudC5rZXlDb2RlIH19PC9wPgogICAgICAgPHA+ZXZlbnQgYWx0S2V5OiB7eyBldmVudC5hbHRLZXkgfX08L3A+CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nS2V5cHJlc3MKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXByZXNzIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXByZXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICoga2V5cHJlc3MuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9CiAqIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8aW5wdXQgbmcta2V5cHJlc3M9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAga2V5IHByZXNzIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTdWJtaXQKICoKICogQGRlc2NyaXB0aW9uCiAqIEVuYWJsZXMgYmluZGluZyBhbmd1bGFyIGV4cHJlc3Npb25zIHRvIG9uc3VibWl0IGV2ZW50cy4KICoKICogQWRkaXRpb25hbGx5IGl0IHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAod2hpY2ggZm9yIGZvcm0gbWVhbnMgc2VuZGluZyB0aGUgcmVxdWVzdCB0byB0aGUKICogc2VydmVyIGFuZCByZWxvYWRpbmcgdGhlIGN1cnJlbnQgcGFnZSksIGJ1dCBvbmx5IGlmIHRoZSBmb3JtIGRvZXMgbm90IGNvbnRhaW4gYGFjdGlvbmAsCiAqIGBkYXRhLWFjdGlvbmAsIG9yIGB4LWFjdGlvbmAgYXR0cmlidXRlcy4KICoKICogQGVsZW1lbnQgZm9ybQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3VibWl0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAqICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPHNjcmlwdD4KICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLmxpc3QgPSBbXTsKICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2hlbGxvJzsKICAgICAgICAgICRzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCRzY29wZS50ZXh0KSB7CiAgICAgICAgICAgICAgJHNjb3BlLmxpc3QucHVzaCh0aGlzLnRleHQpOwogICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJyc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICA8L3NjcmlwdD4KICAgICAgPGZvcm0gbmctc3VibWl0PSJzdWJtaXQoKSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgRW50ZXIgdGV4dCBhbmQgaGl0IGVudGVyOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idGV4dCIgbmFtZT0idGV4dCIgLz4KICAgICAgICA8aW5wdXQgdHlwZT0ic3VibWl0IiBpZD0ic3VibWl0IiB2YWx1ZT0iU3VibWl0IiAvPgogICAgICAgIDxwcmU+bGlzdD17e2xpc3R9fTwvcHJlPgogICAgICA8L2Zvcm0+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdWJtaXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbGlzdCcpKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3Q9W10nKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJyNzdWJtaXQnKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbGlzdCcpKS5nZXRUZXh0KCkpLnRvQ29udGFpbignaGVsbG8nKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaW5wdXQoJ3RleHQnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCcnKTsKICAgICAgIH0pOwogICAgICAgaXQoJ3Nob3VsZCBpZ25vcmUgZW1wdHkgc3RyaW5ncycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9CZSgnbGlzdD1bXScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3N1Ym1pdCcpKS5jbGljaygpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3N1Ym1pdCcpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9Db250YWluKCdoZWxsbycpOwogICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nRm9jdXMKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGZvY3VzIGV2ZW50LgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdGb2N1cyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGZvY3VzLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQmx1cgogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gYmx1ciBldmVudC4KICoKICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmx1ciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGJsdXIuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDb3B5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBjb3B5IGV2ZW50LgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDb3B5IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogY29weS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8aW5wdXQgbmctY29weT0iY29waWVkPXRydWUiIG5nLWluaXQ9ImNvcGllZD1mYWxzZTsgdmFsdWU9J2NvcHkgbWUnIiBuZy1tb2RlbD0idmFsdWUiPgogICAgICBjb3BpZWQ6IHt7Y29waWVkfX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0N1dAogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gY3V0IGV2ZW50LgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDdXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBjdXQuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGlucHV0IG5nLWN1dD0iY3V0PXRydWUiIG5nLWluaXQ9ImN1dD1mYWxzZTsgdmFsdWU9J2N1dCBtZSciIG5nLW1vZGVsPSJ2YWx1ZSI+CiAgICAgIGN1dDoge3tjdXR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nUGFzdGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIHBhc3RlIGV2ZW50LgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdQYXN0ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIHBhc3RlLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxpbnB1dCBuZy1wYXN0ZT0icGFzdGU9dHJ1ZSIgbmctaW5pdD0icGFzdGU9ZmFsc2UiIHBsYWNlaG9sZGVyPSdwYXN0ZSBoZXJlJz4KICAgICAgcGFzdGVkOiB7e3Bhc3RlfX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0lmCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nSWZgIGRpcmVjdGl2ZSByZW1vdmVzIG9yIHJlY3JlYXRlcyBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIGJhc2VkIG9uIGFuCiAqIHtleHByZXNzaW9ufS4gSWYgdGhlIGV4cHJlc3Npb24gYXNzaWduZWQgdG8gYG5nSWZgIGV2YWx1YXRlcyB0byBhIGZhbHNlCiAqIHZhbHVlIHRoZW4gdGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00sIG90aGVyd2lzZSBhIGNsb25lIG9mIHRoZQogKiBlbGVtZW50IGlzIHJlaW5zZXJ0ZWQgaW50byB0aGUgRE9NLgogKgogKiBgbmdJZmAgZGlmZmVycyBmcm9tIGBuZ1Nob3dgIGFuZCBgbmdIaWRlYCBpbiB0aGF0IGBuZ0lmYCBjb21wbGV0ZWx5IHJlbW92ZXMgYW5kIHJlY3JlYXRlcyB0aGUKICogZWxlbWVudCBpbiB0aGUgRE9NIHJhdGhlciB0aGFuIGNoYW5naW5nIGl0cyB2aXNpYmlsaXR5IHZpYSB0aGUgYGRpc3BsYXlgIGNzcyBwcm9wZXJ0eS4gIEEgY29tbW9uCiAqIGNhc2Ugd2hlbiB0aGlzIGRpZmZlcmVuY2UgaXMgc2lnbmlmaWNhbnQgaXMgd2hlbiB1c2luZyBjc3Mgc2VsZWN0b3JzIHRoYXQgcmVseSBvbiBhbiBlbGVtZW50J3MKICogcG9zaXRpb24gd2l0aGluIHRoZSBET00sIHN1Y2ggYXMgdGhlIGA6Zmlyc3QtY2hpbGRgIG9yIGA6bGFzdC1jaGlsZGAgcHNldWRvLWNsYXNzZXMuCiAqCiAqIE5vdGUgdGhhdCB3aGVuIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZCB1c2luZyBgbmdJZmAgaXRzIHNjb3BlIGlzIGRlc3Ryb3llZCBhbmQgYSBuZXcgc2NvcGUKICogaXMgY3JlYXRlZCB3aGVuIHRoZSBlbGVtZW50IGlzIHJlc3RvcmVkLiAgVGhlIHNjb3BlIGNyZWF0ZWQgd2l0aGluIGBuZ0lmYCBpbmhlcml0cyBmcm9tCiAqIGl0cyBwYXJlbnQgc2NvcGUgdXNpbmcKICogW3Byb3RvdHlwYWwgaW5oZXJpdGFuY2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvd2lraS9UaGUtTnVhbmNlcy1vZi1TY29wZS1Qcm90b3R5cGFsLUluaGVyaXRhbmNlKS4KICogQW4gaW1wb3J0YW50IGltcGxpY2F0aW9uIG9mIHRoaXMgaXMgaWYgYG5nTW9kZWxgIGlzIHVzZWQgd2l0aGluIGBuZ0lmYCB0byBiaW5kIHRvCiAqIGEgamF2YXNjcmlwdCBwcmltaXRpdmUgZGVmaW5lZCBpbiB0aGUgcGFyZW50IHNjb3BlLiBJbiB0aGlzIGNhc2UgYW55IG1vZGlmaWNhdGlvbnMgbWFkZSB0byB0aGUKICogdmFyaWFibGUgd2l0aGluIHRoZSBjaGlsZCBzY29wZSB3aWxsIG92ZXJyaWRlIChoaWRlKSB0aGUgdmFsdWUgaW4gdGhlIHBhcmVudCBzY29wZS4KICoKICogQWxzbywgYG5nSWZgIHJlY3JlYXRlcyBlbGVtZW50cyB1c2luZyB0aGVpciBjb21waWxlZCBzdGF0ZS4gQW4gZXhhbXBsZSBvZiB0aGlzIGJlaGF2aW9yCiAqIGlzIGlmIGFuIGVsZW1lbnQncyBjbGFzcyBhdHRyaWJ1dGUgaXMgZGlyZWN0bHkgbW9kaWZpZWQgYWZ0ZXIgaXQncyBjb21waWxlZCwgdXNpbmcgc29tZXRoaW5nIGxpa2UKICogalF1ZXJ5J3MgYC5hZGRDbGFzcygpYCBtZXRob2QsIGFuZCB0aGUgZWxlbWVudCBpcyBsYXRlciByZW1vdmVkLiBXaGVuIGBuZ0lmYCByZWNyZWF0ZXMgdGhlIGVsZW1lbnQKICogdGhlIGFkZGVkIGNsYXNzIHdpbGwgYmUgbG9zdCBiZWNhdXNlIHRoZSBvcmlnaW5hbCBjb21waWxlZCBzdGF0ZSBpcyB1c2VkIHRvIHJlZ2VuZXJhdGUgdGhlIGVsZW1lbnQuCiAqCiAqIEFkZGl0aW9uYWxseSwgeW91IGNhbiBwcm92aWRlIGFuaW1hdGlvbnMgdmlhIHRoZSBgbmdBbmltYXRlYCBtb2R1bGUgdG8gYW5pbWF0ZSB0aGUgYGVudGVyYAogKiBhbmQgYGxlYXZlYCBlZmZlY3RzLgogKgogKiBAYW5pbWF0aW9ucwogKiBlbnRlciAtIGhhcHBlbnMganVzdCBhZnRlciB0aGUgbmdJZiBjb250ZW50cyBjaGFuZ2UgYW5kIGEgbmV3IERPTSBlbGVtZW50IGlzIGNyZWF0ZWQgYW5kIGluamVjdGVkIGludG8gdGhlIG5nSWYgY29udGFpbmVyCiAqIGxlYXZlIC0gaGFwcGVucyBqdXN0IGJlZm9yZSB0aGUgbmdJZiBjb250ZW50cyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBET00KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBzY29wZQogKiBAcHJpb3JpdHkgNjAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdJZiBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgZmFsc3kgdGhlbgogKiAgICAgdGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00gdHJlZS4gSWYgaXQgaXMgdHJ1dGh5IGEgY29weSBvZiB0aGUgY29tcGlsZWQKICogICAgIGVsZW1lbnQgaXMgYWRkZWQgdG8gdGhlIERPTSB0cmVlLgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIiBuZy1pbml0PSJjaGVja2VkPXRydWUiIC8+PGJyLz4KICAgICAgU2hvdyB3aGVuIGNoZWNrZWQ6CiAgICAgIDxzcGFuIG5nLWlmPSJjaGVja2VkIiBjbGFzcz0iYW5pbWF0ZS1pZiI+CiAgICAgICAgSSdtIHJlbW92ZWQgd2hlbiB0aGUgY2hlY2tib3ggaXMgdW5jaGVja2VkLgogICAgICA8L3NwYW4+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgIC5hbmltYXRlLWlmIHsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICB9CgogICAgICAuYW5pbWF0ZS1pZi5uZy1lbnRlciwgLmFuaW1hdGUtaWYubmctbGVhdmUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIsCiAgICAgIC5hbmltYXRlLWlmLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSB7CiAgICAgICAgb3BhY2l0eTowOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1pZi5uZy1sZWF2ZSwKICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgIH0KICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdJZkRpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogIHJldHVybiB7CiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICBwcmlvcml0eTogNjAwLAogICAgdGVybWluYWw6IHRydWUsCiAgICByZXN0cmljdDogJ0EnLAogICAgJCR0bGI6IHRydWUsCiAgICBsaW5rOiBmdW5jdGlvbiAoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICAgICAgdmFyIGJsb2NrLCBjaGlsZFNjb3BlLCBwcmV2aW91c0VsZW1lbnRzOwogICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIubmdJZiwgZnVuY3Rpb24gbmdJZldhdGNoQWN0aW9uKHZhbHVlKSB7CgogICAgICAgICAgaWYgKHRvQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgaWYgKCFjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgJHRyYW5zY2x1ZGUoY2hpbGRTY29wZSwgZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICBjbG9uZVtjbG9uZS5sZW5ndGgrK10gPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCcgZW5kIG5nSWY6ICcgKyAkYXR0ci5uZ0lmICsgJyAnKTsKICAgICAgICAgICAgICAgIC8vIE5vdGU6IFdlIG9ubHkgbmVlZCB0aGUgZmlyc3QvbGFzdCBub2RlIG9mIHRoZSBjbG9uZWQgbm9kZXMuCiAgICAgICAgICAgICAgICAvLyBIb3dldmVyLCB3ZSBuZWVkIHRvIGtlZXAgdGhlIHJlZmVyZW5jZSB0byB0aGUganFsaXRlIHdyYXBwZXIgYXMgaXQgbWlnaHQgYmUgY2hhbmdlZCBsYXRlcgogICAgICAgICAgICAgICAgLy8gYnkgYSBkaXJlY3RpdmUgd2l0aCB0ZW1wbGF0ZVVybCB3aGVuIGl0cyB0ZW1wbGF0ZSBhcnJpdmVzLgogICAgICAgICAgICAgICAgYmxvY2sgPSB7CiAgICAgICAgICAgICAgICAgIGNsb25lOiBjbG9uZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNsb25lLCAkZWxlbWVudC5wYXJlbnQoKSwgJGVsZW1lbnQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZihwcmV2aW91c0VsZW1lbnRzKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cy5yZW1vdmUoKTsKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGJsb2NrKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cyA9IGdldEJsb2NrRWxlbWVudHMoYmxvY2suY2xvbmUpOwogICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKHByZXZpb3VzRWxlbWVudHMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cyA9IG51bGw7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgYmxvY2sgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgfTsKfV07CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0luY2x1ZGUKICogQHJlc3RyaWN0IEVDQQogKgogKiBAZGVzY3JpcHRpb24KICogRmV0Y2hlcywgY29tcGlsZXMgYW5kIGluY2x1ZGVzIGFuIGV4dGVybmFsIEhUTUwgZnJhZ21lbnQuCiAqCiAqIEJ5IGRlZmF1bHQsIHRoZSB0ZW1wbGF0ZSBVUkwgaXMgcmVzdHJpY3RlZCB0byB0aGUgc2FtZSBkb21haW4gYW5kIHByb3RvY29sIGFzIHRoZQogKiBhcHBsaWNhdGlvbiBkb2N1bWVudC4gVGhpcyBpcyBkb25lIGJ5IGNhbGxpbmcge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAqICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfSBvbiBpdC4gVG8gbG9hZCB0ZW1wbGF0ZXMgZnJvbSBvdGhlciBkb21haW5zIG9yIHByb3RvY29scwogKiB5b3UgbWF5IGVpdGhlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0IHRoZW19IG9yCiAqIFt3cmFwIHRoZW1dKG5nLiRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsKSBhcyB0cnVzdGVkIHZhbHVlcy4gUmVmZXIgdG8gQW5ndWxhcidzIHtAbGluawogKiBuZy4kc2NlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nfS4KICoKICogSW4gYWRkaXRpb24sIHRoZSBicm93c2VyJ3MKICogW1NhbWUgT3JpZ2luIFBvbGljeV0oaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9icm93c2Vyc2VjL3dpa2kvUGFydDIjU2FtZS1vcmlnaW5fcG9saWN5X2Zvcl9YTUxIdHRwUmVxdWVzdCkKICogYW5kIFtDcm9zcy1PcmlnaW4gUmVzb3VyY2UgU2hhcmluZyAoQ09SUyldKGh0dHA6Ly93d3cudzMub3JnL1RSL2NvcnMvKQogKiBwb2xpY3kgbWF5IGZ1cnRoZXIgcmVzdHJpY3Qgd2hldGhlciB0aGUgdGVtcGxhdGUgaXMgc3VjY2Vzc2Z1bGx5IGxvYWRlZC4KICogRm9yIGV4YW1wbGUsIGBuZ0luY2x1ZGVgIHdvbid0IHdvcmsgZm9yIGNyb3NzLWRvbWFpbiByZXF1ZXN0cyBvbiBhbGwgYnJvd3NlcnMgYW5kIGZvciBgZmlsZTovL2AKICogYWNjZXNzIG9uIHNvbWUgYnJvd3NlcnMuCiAqCiAqIEBhbmltYXRpb25zCiAqIGVudGVyIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYnJpbmcgbmV3IGNvbnRlbnQgaW50byB0aGUgYnJvd3Nlci4KICogbGVhdmUgLSBhbmltYXRpb24gaXMgdXNlZCB0byBhbmltYXRlIGV4aXN0aW5nIGNvbnRlbnQgYXdheS4KICoKICogVGhlIGVudGVyIGFuZCBsZWF2ZSBhbmltYXRpb24gb2NjdXIgY29uY3VycmVudGx5LgogKgogKiBAc2NvcGUKICogQHByaW9yaXR5IDQwMAogKgogKiBAcGFyYW0ge3N0cmluZ30gbmdJbmNsdWRlfHNyYyBhbmd1bGFyIGV4cHJlc3Npb24gZXZhbHVhdGluZyB0byBVUkwuIElmIHRoZSBzb3VyY2UgaXMgYSBzdHJpbmcgY29uc3RhbnQsCiAqICAgICAgICAgICAgICAgICBtYWtlIHN1cmUgeW91IHdyYXAgaXQgaW4gKipzaW5nbGUqKiBxdW90ZXMsIGUuZy4gYHNyYz0iJ215UGFydGlhbFRlbXBsYXRlLmh0bWwnImAuCiAqIEBwYXJhbSB7c3RyaW5nPX0gb25sb2FkIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbiBhIG5ldyBwYXJ0aWFsIGlzIGxvYWRlZC4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBhdXRvc2Nyb2xsIFdoZXRoZXIgYG5nSW5jbHVkZWAgc2hvdWxkIGNhbGwge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwKICogICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsfSB0byBzY3JvbGwgdGhlIHZpZXdwb3J0IGFmdGVyIHRoZSBjb250ZW50IGlzIGxvYWRlZC4KICoKICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgbm90IHNldCwgZGlzYWJsZSBzY3JvbGxpbmcuCiAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIHNldCB3aXRob3V0IHZhbHVlLCBlbmFibGUgc2Nyb2xsaW5nLgogKiAgICAgICAgICAgICAgICAgIC0gT3RoZXJ3aXNlIGVuYWJsZSBzY3JvbGxpbmcgb25seSBpZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1dGh5IHZhbHVlLgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgIDxzZWxlY3QgbmctbW9kZWw9InRlbXBsYXRlIiBuZy1vcHRpb25zPSJ0Lm5hbWUgZm9yIHQgaW4gdGVtcGxhdGVzIj4KICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPihibGFuayk8L29wdGlvbj4KICAgICAgIDwvc2VsZWN0PgogICAgICAgdXJsIG9mIHRoZSB0ZW1wbGF0ZTogPHR0Pnt7dGVtcGxhdGUudXJsfX08L3R0PgogICAgICAgPGhyLz4KICAgICAgIDxkaXYgY2xhc3M9InNsaWRlLWFuaW1hdGUtY29udGFpbmVyIj4KICAgICAgICAgPGRpdiBjbGFzcz0ic2xpZGUtYW5pbWF0ZSIgbmctaW5jbHVkZT0idGVtcGxhdGUudXJsIj48L2Rpdj4KICAgICAgIDwvZGl2PgogICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAkc2NvcGUudGVtcGxhdGVzID0KICAgICAgICAgIFsgeyBuYW1lOiAndGVtcGxhdGUxLmh0bWwnLCB1cmw6ICd0ZW1wbGF0ZTEuaHRtbCd9LAogICAgICAgICAgICB7IG5hbWU6ICd0ZW1wbGF0ZTIuaHRtbCcsIHVybDogJ3RlbXBsYXRlMi5odG1sJ30gXTsKICAgICAgICAkc2NvcGUudGVtcGxhdGUgPSAkc2NvcGUudGVtcGxhdGVzWzBdOwogICAgICB9CiAgICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0idGVtcGxhdGUxLmh0bWwiPgogICAgICBDb250ZW50IG9mIHRlbXBsYXRlMS5odG1sCiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTIuaHRtbCI+CiAgICAgIENvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWwKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgLnNsaWRlLWFuaW1hdGUtY29udGFpbmVyIHsKICAgICAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgaGVpZ2h0OjQwcHg7CiAgICAgICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgICB9CgogICAgICAuc2xpZGUtYW5pbWF0ZSB7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICB9CgogICAgICAuc2xpZGUtYW5pbWF0ZS5uZy1lbnRlciwgLnNsaWRlLWFuaW1hdGUubmctbGVhdmUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKCiAgICAgICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICAgICAgdG9wOjA7CiAgICAgICAgbGVmdDowOwogICAgICAgIHJpZ2h0OjA7CiAgICAgICAgYm90dG9tOjA7CiAgICAgICAgZGlzcGxheTpibG9jazsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgICAgIC5zbGlkZS1hbmltYXRlLm5nLWVudGVyIHsKICAgICAgICB0b3A6LTUwcHg7CiAgICAgIH0KICAgICAgLnNsaWRlLWFuaW1hdGUubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICB0b3A6MDsKICAgICAgfQoKICAgICAgLnNsaWRlLWFuaW1hdGUubmctbGVhdmUgewogICAgICAgIHRvcDowOwogICAgICB9CiAgICAgIC5zbGlkZS1hbmltYXRlLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSB7CiAgICAgICAgdG9wOjUwcHg7CiAgICAgIH0KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdGVtcGxhdGVTZWxlY3QgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZW1wbGF0ZScpKTsKICAgICAgdmFyIGluY2x1ZGVFbGVtID0gZWxlbWVudChieS5jc3MoJ1tuZy1pbmNsdWRlXScpKTsKCiAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTEuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdChpbmNsdWRlRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGVtcGxhdGUxLmh0bWwvKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUyLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnZmlyZWZveCcpIHsKICAgICAgICAgIC8vIEZpcmVmb3ggY2FuJ3QgaGFuZGxlIHVzaW5nIHNlbGVjdHMKICAgICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9wcm90cmFjdG9yL2lzc3Vlcy80ODAKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuY2xpY2soKTsKICAgICAgICB0ZW1wbGF0ZVNlbGVjdC5lbGVtZW50LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMikuY2xpY2soKTsKICAgICAgICBleHBlY3QoaW5jbHVkZUVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMi5odG1sLyk7CiAgICAgIH0pOwoKICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gYmxhbmsnLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnZmlyZWZveCcpIHsKICAgICAgICAgIC8vIEZpcmVmb3ggY2FuJ3QgaGFuZGxlIHVzaW5nIHNlbGVjdHMKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuY2xpY2soKTsKICAgICAgICB0ZW1wbGF0ZVNlbGVjdC5lbGVtZW50LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMCkuY2xpY2soKTsKICAgICAgICBleHBlY3QoaW5jbHVkZUVsZW0uaXNQcmVzZW50KCkpLnRvQmUoZmFsc2UpOwogICAgICB9KTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZXZlbnQKICogQG5hbWUgbmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudFJlcXVlc3RlZAogKiBAZXZlbnRUeXBlIGVtaXQgb24gdGhlIHNjb3BlIG5nSW5jbHVkZSB3YXMgZGVjbGFyZWQgaW4KICogQGRlc2NyaXB0aW9uCiAqIEVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgbmdJbmNsdWRlIGNvbnRlbnQgaXMgcmVxdWVzdGVkLgogKi8KCgovKioKICogQG5nZG9jIGV2ZW50CiAqIEBuYW1lIG5nSW5jbHVkZSMkaW5jbHVkZUNvbnRlbnRMb2FkZWQKICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nSW5jbHVkZSBzY29wZQogKiBAZGVzY3JpcHRpb24KICogRW1pdHRlZCBldmVyeSB0aW1lIHRoZSBuZ0luY2x1ZGUgY29udGVudCBpcyByZWxvYWRlZC4KICovCnZhciBuZ0luY2x1ZGVEaXJlY3RpdmUgPSBbJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRhbmNob3JTY3JvbGwnLCAnJGFuaW1hdGUnLCAnJHNjZScsCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCRodHRwLCAgICR0ZW1wbGF0ZUNhY2hlLCAgICRhbmNob3JTY3JvbGwsICAgJGFuaW1hdGUsICAgJHNjZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0VDQScsCiAgICBwcmlvcml0eTogNDAwLAogICAgdGVybWluYWw6IHRydWUsCiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICBjb250cm9sbGVyOiBhbmd1bGFyLm5vb3AsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIHZhciBzcmNFeHAgPSBhdHRyLm5nSW5jbHVkZSB8fCBhdHRyLnNyYywKICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnLAogICAgICAgICAgYXV0b1Njcm9sbEV4cCA9IGF0dHIuYXV0b3Njcm9sbDsKCiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgICAgIHZhciBjaGFuZ2VDb3VudGVyID0gMCwKICAgICAgICAgICAgY3VycmVudFNjb3BlLAogICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQsCiAgICAgICAgICAgIGN1cnJlbnRFbGVtZW50OwoKICAgICAgICB2YXIgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYocHJldmlvdXNFbGVtZW50KSB7CiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmKGN1cnJlbnRTY29wZSkgewogICAgICAgICAgICBjdXJyZW50U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgY3VycmVudFNjb3BlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmKGN1cnJlbnRFbGVtZW50KSB7CiAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGN1cnJlbnRFbGVtZW50LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQgPSBudWxsOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50ID0gY3VycmVudEVsZW1lbnQ7CiAgICAgICAgICAgIGN1cnJlbnRFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBzY29wZS4kd2F0Y2goJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwoc3JjRXhwKSwgZnVuY3Rpb24gbmdJbmNsdWRlV2F0Y2hBY3Rpb24oc3JjKSB7CiAgICAgICAgICB2YXIgYWZ0ZXJBbmltYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhdXRvU2Nyb2xsRXhwKSAmJiAoIWF1dG9TY3JvbGxFeHAgfHwgc2NvcGUuJGV2YWwoYXV0b1Njcm9sbEV4cCkpKSB7CiAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHRoaXNDaGFuZ2VJZCA9ICsrY2hhbmdlQ291bnRlcjsKCiAgICAgICAgICBpZiAoc3JjKSB7CiAgICAgICAgICAgICRodHRwLmdldChzcmMsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCAhPT0gY2hhbmdlQ291bnRlcikgcmV0dXJuOwogICAgICAgICAgICAgIHZhciBuZXdTY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICBjdHJsLnRlbXBsYXRlID0gcmVzcG9uc2U7CgogICAgICAgICAgICAgIC8vIE5vdGU6IFRoaXMgd2lsbCBhbHNvIGxpbmsgYWxsIGNoaWxkcmVuIG9mIG5nLWluY2x1ZGUgdGhhdCB3ZXJlIGNvbnRhaW5lZCBpbiB0aGUgb3JpZ2luYWwKICAgICAgICAgICAgICAvLyBodG1sLiBJZiB0aGF0IGNvbnRlbnQgY29udGFpbnMgY29udHJvbGxlcnMsIC4uLiB0aGV5IGNvdWxkIHBvbGx1dGUvY2hhbmdlIHRoZSBzY29wZS4KICAgICAgICAgICAgICAvLyBIb3dldmVyLCB1c2luZyBuZy1pbmNsdWRlIG9uIGFuIGVsZW1lbnQgd2l0aCBhZGRpdGlvbmFsIGNvbnRlbnQgZG9lcyBub3QgbWFrZSBzZW5zZS4uLgogICAgICAgICAgICAgIC8vIE5vdGU6IFdlIGNhbid0IHJlbW92ZSB0aGVtIGluIHRoZSBjbG9uZUF0dGNoRm4gb2YgJHRyYW5zY2x1ZGUgYXMgdGhhdAogICAgICAgICAgICAgIC8vIGZ1bmN0aW9uIGlzIGNhbGxlZCBiZWZvcmUgbGlua2luZyB0aGUgY29udGVudCwgd2hpY2ggd291bGQgYXBwbHkgY2hpbGQKICAgICAgICAgICAgICAvLyBkaXJlY3RpdmVzIHRvIG5vbiBleGlzdGluZyBlbGVtZW50cy4KICAgICAgICAgICAgICB2YXIgY2xvbmUgPSAkdHJhbnNjbHVkZShuZXdTY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNsb25lLCBudWxsLCAkZWxlbWVudCwgYWZ0ZXJBbmltYXRpb24pOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBuZXdTY29wZTsKICAgICAgICAgICAgICBjdXJyZW50RWxlbWVudCA9IGNsb25lOwoKICAgICAgICAgICAgICBjdXJyZW50U2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudExvYWRlZCcpOwogICAgICAgICAgICAgIHNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICh0aGlzQ2hhbmdlSWQgPT09IGNoYW5nZUNvdW50ZXIpIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRSZXF1ZXN0ZWQnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgY3RybC50ZW1wbGF0ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfTsKfV07CgovLyBUaGlzIGRpcmVjdGl2ZSBpcyBjYWxsZWQgZHVyaW5nIHRoZSAkdHJhbnNjbHVkZSBjYWxsIG9mIHRoZSBmaXJzdCBgbmdJbmNsdWRlYCBkaXJlY3RpdmUuCi8vIEl0IHdpbGwgcmVwbGFjZSBhbmQgY29tcGlsZSB0aGUgY29udGVudCBvZiB0aGUgZWxlbWVudCB3aXRoIHRoZSBsb2FkZWQgdGVtcGxhdGUuCi8vIFdlIG5lZWQgdGhpcyBkaXJlY3RpdmUgc28gdGhhdCB0aGUgZWxlbWVudCBjb250ZW50IGlzIGFscmVhZHkgZmlsbGVkIHdoZW4KLy8gdGhlIGxpbmsgZnVuY3Rpb24gb2YgYW5vdGhlciBkaXJlY3RpdmUgb24gdGhlIHNhbWUgZWxlbWVudCBhcyBuZ0luY2x1ZGUKLy8gaXMgY2FsbGVkLgp2YXIgbmdJbmNsdWRlRmlsbENvbnRlbnREaXJlY3RpdmUgPSBbJyRjb21waWxlJywKICBmdW5jdGlvbigkY29tcGlsZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICBwcmlvcml0eTogLTQwMCwKICAgICAgcmVxdWlyZTogJ25nSW5jbHVkZScsCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwpIHsKICAgICAgICAkZWxlbWVudC5odG1sKGN0cmwudGVtcGxhdGUpOwogICAgICAgICRjb21waWxlKCRlbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTsKICAgICAgfQogICAgfTsKICB9XTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nSW5pdAogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdJbml0YCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBldmFsdWF0ZSBhbiBleHByZXNzaW9uIGluIHRoZQogKiBjdXJyZW50IHNjb3BlLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1lcnJvciI+CiAqIFRoZSBvbmx5IGFwcHJvcHJpYXRlIHVzZSBvZiBgbmdJbml0YCBpcyBmb3IgYWxpYXNpbmcgc3BlY2lhbCBwcm9wZXJ0aWVzIG9mCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgYG5nUmVwZWF0YH0sIGFzIHNlZW4gaW4gdGhlIGRlbW8gYmVsb3cuIEJlc2lkZXMgdGhpcyBjYXNlLCB5b3UKICogc2hvdWxkIHVzZSB7QGxpbmsgZ3VpZGUvY29udHJvbGxlciBjb250cm9sbGVyc30gcmF0aGVyIHRoYW4gYG5nSW5pdGAKICogdG8gaW5pdGlhbGl6ZSB2YWx1ZXMgb24gYSBzY29wZS4KICogPC9kaXY+CiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGUqKjogSWYgeW91IGhhdmUgYXNzaWdubWVudCBpbiBgbmdJbml0YCBhbG9uZyB3aXRoIHtAbGluayBuZy4kZmlsdGVyIGAkZmlsdGVyYH0sIG1ha2UKICogc3VyZSB5b3UgaGF2ZSBwYXJlbnRoZXNpcyBmb3IgY29ycmVjdCBwcmVjZWRlbmNlOgogKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAqICAgPGRpdiBuZy1pbml0PSJ0ZXN0MSA9IChkYXRhIHwgb3JkZXJCeTonbmFtZScpIj48L2Rpdj4KICogPC9wcmU+CiAqIDwvZGl2PgogKgogKiBAcHJpb3JpdHkgNDUwCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSW5pdCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgJHNjb3BlLmxpc3QgPSBbWydhJywgJ2InXSwgWydjJywgJ2QnXV07CiAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8ZGl2IG5nLXJlcGVhdD0iaW5uZXJMaXN0IGluIGxpc3QiIG5nLWluaXQ9Im91dGVySW5kZXggPSAkaW5kZXgiPgogICAgICAgPGRpdiBuZy1yZXBlYXQ9InZhbHVlIGluIGlubmVyTGlzdCIgbmctaW5pdD0iaW5uZXJJbmRleCA9ICRpbmRleCI+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZXhhbXBsZS1pbml0Ij5saXN0WyB7e291dGVySW5kZXh9fSBdWyB7e2lubmVySW5kZXh9fSBdID0ge3t2YWx1ZX19Ozwvc3Bhbj4KICAgICAgIDwvZGl2PgogICAgIDwvZGl2PgogICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGFsaWFzIGluZGV4IHBvc2l0aW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgZWxlbWVudHMgPSBlbGVtZW50LmFsbChieS5jc3MoJy5leGFtcGxlLWluaXQnKSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50cy5nZXQoMCkuZ2V0VGV4dCgpKS50b0JlKCdsaXN0WyAwIF1bIDAgXSA9IGE7Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50cy5nZXQoMSkuZ2V0VGV4dCgpKS50b0JlKCdsaXN0WyAwIF1bIDEgXSA9IGI7Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50cy5nZXQoMikuZ2V0VGV4dCgpKS50b0JlKCdsaXN0WyAxIF1bIDAgXSA9IGM7Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50cy5nZXQoMykuZ2V0VGV4dCgpKS50b0JlKCdsaXN0WyAxIF1bIDEgXSA9IGQ7Jyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0luaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgcHJpb3JpdHk6IDQ1MCwKICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgc2NvcGUuJGV2YWwoYXR0cnMubmdJbml0KTsKICAgICAgfQogICAgfTsKICB9Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdOb25CaW5kYWJsZQogKiBAcmVzdHJpY3QgQUMKICogQHByaW9yaXR5IDEwMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdOb25CaW5kYWJsZWAgZGlyZWN0aXZlIHRlbGxzIEFuZ3VsYXIgbm90IHRvIGNvbXBpbGUgb3IgYmluZCB0aGUgY29udGVudHMgb2YgdGhlIGN1cnJlbnQKICogRE9NIGVsZW1lbnQuIFRoaXMgaXMgdXNlZnVsIGlmIHRoZSBlbGVtZW50IGNvbnRhaW5zIHdoYXQgYXBwZWFycyB0byBiZSBBbmd1bGFyIGRpcmVjdGl2ZXMgYW5kCiAqIGJpbmRpbmdzIGJ1dCB3aGljaCBzaG91bGQgYmUgaWdub3JlZCBieSBBbmd1bGFyLiBUaGlzIGNvdWxkIGJlIHRoZSBjYXNlIGlmIHlvdSBoYXZlIGEgc2l0ZSB0aGF0CiAqIGRpc3BsYXlzIHNuaXBwZXRzIG9mIGNvZGUsIGZvciBpbnN0YW5jZS4KICoKICogQGVsZW1lbnQgQU5ZCiAqCiAqIEBleGFtcGxlCiAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9ucyB3aGVyZSBhIHNpbXBsZSBpbnRlcnBvbGF0aW9uIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwKICogYnV0IHRoZSBvbmUgd3JhcHBlZCBpbiBgbmdOb25CaW5kYWJsZWAgaXMgbGVmdCBhbG9uZS4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8ZGl2Pk5vcm1hbDoge3sxICsgMn19PC9kaXY+CiAgICAgICAgPGRpdiBuZy1ub24tYmluZGFibGU+SWdub3JlZDoge3sxICsgMn19PC9kaXY+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLW5vbi1iaW5kYWJsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCcxICsgMicpKS5nZXRUZXh0KCkpLnRvQ29udGFpbignMycpOwogICAgICAgICBleHBlY3QoZWxlbWVudC5hbGwoYnkuY3NzKCdkaXYnKSkubGFzdCgpLmdldFRleHQoKSkudG9NYXRjaCgvMSBcKyAyLyk7CiAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIG5nTm9uQmluZGFibGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7IHRlcm1pbmFsOiB0cnVlLCBwcmlvcml0eTogMTAwMCB9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nUGx1cmFsaXplCiAqIEByZXN0cmljdCBFQQogKgogKiBAZGVzY3JpcHRpb24KICogYG5nUGx1cmFsaXplYCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGRpc3BsYXlzIG1lc3NhZ2VzIGFjY29yZGluZyB0byBlbi1VUyBsb2NhbGl6YXRpb24gcnVsZXMuCiAqIFRoZXNlIHJ1bGVzIGFyZSBidW5kbGVkIHdpdGggYW5ndWxhci5qcywgYnV0IGNhbiBiZSBvdmVycmlkZGVuCiAqIChzZWUge0BsaW5rIGd1aWRlL2kxOG4gQW5ndWxhciBpMThufSBkZXYgZ3VpZGUpLiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGRpcmVjdGl2ZQogKiBieSBzcGVjaWZ5aW5nIHRoZSBtYXBwaW5ncyBiZXR3ZWVuCiAqIFtwbHVyYWwgY2F0ZWdvcmllc10oaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sKQogKiBhbmQgdGhlIHN0cmluZ3MgdG8gYmUgZGlzcGxheWVkLgogKgogKiAjIFBsdXJhbCBjYXRlZ29yaWVzIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMKICogVGhlcmUgYXJlIHR3bwogKiBbcGx1cmFsIGNhdGVnb3JpZXNdKGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbCkKICogaW4gQW5ndWxhcidzIGRlZmF1bHQgZW4tVVMgbG9jYWxlOiAib25lIiBhbmQgIm90aGVyIi4KICoKICogV2hpbGUgYSBwbHVyYWwgY2F0ZWdvcnkgbWF5IG1hdGNoIG1hbnkgbnVtYmVycyAoZm9yIGV4YW1wbGUsIGluIGVuLVVTIGxvY2FsZSwgIm90aGVyIiBjYW4gbWF0Y2gKICogYW55IG51bWJlciB0aGF0IGlzIG5vdCAxKSwgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgY2FuIG9ubHkgbWF0Y2ggb25lIG51bWJlci4gRm9yIGV4YW1wbGUsIHRoZQogKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBUaGVyZSBhcmUgZXhhbXBsZXMgb2YgcGx1cmFsIGNhdGVnb3JpZXMKICogYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcyB0aHJvdWdob3V0IHRoZSByZXN0IG9mIHRoaXMgZG9jdW1lbnRhdGlvbi4KICoKICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZQogKiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGJ5IHByb3ZpZGluZyAyIGF0dHJpYnV0ZXM6IGBjb3VudGAgYW5kIGB3aGVuYC4KICogWW91IGNhbiBhbHNvIHByb3ZpZGUgYW4gb3B0aW9uYWwgYXR0cmlidXRlLCBgb2Zmc2V0YC4KICoKICogVGhlIHZhbHVlIG9mIHRoZSBgY291bnRgIGF0dHJpYnV0ZSBjYW4gYmUgZWl0aGVyIGEgc3RyaW5nIG9yIGFuIHtAbGluayBndWlkZS9leHByZXNzaW9uCiAqIEFuZ3VsYXIgZXhwcmVzc2lvbn07IHRoZXNlIGFyZSBldmFsdWF0ZWQgb24gdGhlIGN1cnJlbnQgc2NvcGUgZm9yIGl0cyBib3VuZCB2YWx1ZS4KICoKICogVGhlIGB3aGVuYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoZSBtYXBwaW5ncyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yaWVzIGFuZCB0aGUgYWN0dWFsCiAqIHN0cmluZyB0byBiZSBkaXNwbGF5ZWQuIFRoZSB2YWx1ZSBvZiB0aGUgYXR0cmlidXRlIHNob3VsZCBiZSBhIEpTT04gb2JqZWN0LgogKgogKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZToKICoKICogYGBgaHRtbAogKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogKiA8L25nLXBsdXJhbGl6ZT4KICpgYGAKICoKICogSW4gdGhlIGV4YW1wbGUsIGAiMDogTm9ib2R5IGlzIHZpZXdpbmcuImAgaXMgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUuIElmIHlvdSBkaWQgbm90CiAqIHNwZWNpZnkgdGhpcyBydWxlLCAwIHdvdWxkIGJlIG1hdGNoZWQgdG8gdGhlICJvdGhlciIgY2F0ZWdvcnkgYW5kICIwIHBlb3BsZSBhcmUgdmlld2luZyIKICogd291bGQgYmUgc2hvd24gaW5zdGVhZCBvZiAiTm9ib2R5IGlzIHZpZXdpbmciLiBZb3UgY2FuIHNwZWNpZnkgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgZm9yCiAqIG90aGVyIG51bWJlcnMsIGZvciBleGFtcGxlIDEyLCBzbyB0aGF0IGluc3RlYWQgb2Ygc2hvd2luZyAiMTIgcGVvcGxlIGFyZSB2aWV3aW5nIiwgeW91IGNhbgogKiBzaG93ICJhIGRvemVuIHBlb3BsZSBhcmUgdmlld2luZyIuCiAqCiAqIFlvdSBjYW4gdXNlIGEgc2V0IG9mIGNsb3NlZCBicmFjZXMgKGB7fWApIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSBudW1iZXIgdGhhdCB5b3Ugd2FudCBzdWJzdGl0dXRlZAogKiBpbnRvIHBsdXJhbGl6ZWQgc3RyaW5ncy4gSW4gdGhlIHByZXZpb3VzIGV4YW1wbGUsIEFuZ3VsYXIgd2lsbCByZXBsYWNlIGB7fWAgd2l0aAogKiA8c3BhbiBuZy1ub24tYmluZGFibGU+YHt7cGVyc29uQ291bnR9fWA8L3NwYW4+LiBUaGUgY2xvc2VkIGJyYWNlcyBge31gIGlzIGEgcGxhY2Vob2xkZXIKICogZm9yIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57e251bWJlckV4cHJlc3Npb259fTwvc3Bhbj4uCiAqCiAqICMgQ29uZmlndXJpbmcgbmdQbHVyYWxpemUgd2l0aCBvZmZzZXQKICogVGhlIGBvZmZzZXRgIGF0dHJpYnV0ZSBhbGxvd3MgZnVydGhlciBjdXN0b21pemF0aW9uIG9mIHBsdXJhbGl6ZWQgdGV4dCwgd2hpY2ggY2FuIHJlc3VsdCBpbgogKiBhIGJldHRlciB1c2VyIGV4cGVyaWVuY2UuIEZvciBleGFtcGxlLCBpbnN0ZWFkIG9mIHRoZSBtZXNzYWdlICI0IHBlb3BsZSBhcmUgdmlld2luZyB0aGlzIGRvY3VtZW50IiwKICogeW91IG1pZ2h0IGRpc3BsYXkgIkpvaG4sIEthdGUgYW5kIDIgb3RoZXJzIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLgogKiBUaGUgb2Zmc2V0IGF0dHJpYnV0ZSBhbGxvd3MgeW91IHRvIG9mZnNldCBhIG51bWJlciBieSBhbnkgZGVzaXJlZCB2YWx1ZS4KICogTGV0J3MgdGFrZSBhIGxvb2sgYXQgYW4gZXhhbXBsZToKICoKICogYGBgaHRtbAogKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIgb2Zmc2V0PTIKICogICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICogPC9uZy1wbHVyYWxpemU+CiAqIGBgYAogKgogKiBOb3RpY2UgdGhhdCB3ZSBhcmUgc3RpbGwgdXNpbmcgdHdvIHBsdXJhbCBjYXRlZ29yaWVzKG9uZSwgb3RoZXIpLCBidXQgd2UgYWRkZWQKICogdGhyZWUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIDAsIDEgYW5kIDIuCiAqIFdoZW4gb25lIHBlcnNvbiwgcGVyaGFwcyBKb2huLCB2aWV3cyB0aGUgZG9jdW1lbnQsICJKb2huIGlzIHZpZXdpbmciIHdpbGwgYmUgc2hvd24uCiAqIFdoZW4gdGhyZWUgcGVvcGxlIHZpZXcgdGhlIGRvY3VtZW50LCBubyBleHBsaWNpdCBudW1iZXIgcnVsZSBpcyBmb3VuZCwgc28KICogYW4gb2Zmc2V0IG9mIDIgaXMgdGFrZW4gb2ZmIDMsIGFuZCBBbmd1bGFyIHVzZXMgMSB0byBkZWNpZGUgdGhlIHBsdXJhbCBjYXRlZ29yeS4KICogSW4gdGhpcyBjYXNlLCBwbHVyYWwgY2F0ZWdvcnkgJ29uZScgaXMgbWF0Y2hlZCBhbmQgIkpvaG4sIE1hcnJ5IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nIgogKiBpcyBzaG93bi4KICoKICogTm90ZSB0aGF0IHdoZW4geW91IHNwZWNpZnkgb2Zmc2V0cywgeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yCiAqIG51bWJlcnMgZnJvbSAwIHVwIHRvIGFuZCBpbmNsdWRpbmcgdGhlIG9mZnNldC4gSWYgeW91IHVzZSBhbiBvZmZzZXQgb2YgMywgZm9yIGV4YW1wbGUsCiAqIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvciAwLCAxLCAyIGFuZCAzLiBZb3UgbXVzdCBhbHNvIHByb3ZpZGUgcGx1cmFsIHN0cmluZ3MgZm9yCiAqIHBsdXJhbCBjYXRlZ29yaWVzICJvbmUiIGFuZCAib3RoZXIiLgogKgogKiBAcGFyYW0ge3N0cmluZ3xleHByZXNzaW9ufSBjb3VudCBUaGUgdmFyaWFibGUgdG8gYmUgYm91bmQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nfSB3aGVuIFRoZSBtYXBwaW5nIGJldHdlZW4gcGx1cmFsIGNhdGVnb3J5IHRvIGl0cyBjb3JyZXNwb25kaW5nIHN0cmluZ3MuCiAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0IE9mZnNldCB0byBkZWR1Y3QgZnJvbSB0aGUgdG90YWwgbnVtYmVyLgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGU+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUucGVyc29uMSA9ICdJZ29yJzsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjIgPSAnTWlza28nOwogICAgICAgICAgICAkc2NvcGUucGVyc29uQ291bnQgPSAxOwogICAgICAgICAgfQogICAgICAgIDwvc2NyaXB0PgogICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICBQZXJzb24gMTo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjEiIHZhbHVlPSJJZ29yIiAvPjxici8+CiAgICAgICAgICBQZXJzb24gMjo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjIiIHZhbHVlPSJNaXNrbyIgLz48YnIvPgogICAgICAgICAgTnVtYmVyIG9mIFBlb3BsZTo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbkNvdW50IiB2YWx1ZT0iMSIgLz48YnIvPgoKICAgICAgICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBzaW1wbGUgcGx1cmFsaXphdGlvbiBydWxlcyBmb3IgZW4gbG9jYWxlIC0tLT4KICAgICAgICAgIFdpdGhvdXQgT2Zmc2V0OgogICAgICAgICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiCiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAgICAgIDwvbmctcGx1cmFsaXplPjxicj4KCiAgICAgICAgICA8IS0tLSBFeGFtcGxlIHdpdGggb2Zmc2V0IC0tLT4KICAgICAgICAgIFdpdGggT2Zmc2V0KDIpOgogICAgICAgICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAgICAgIDwvbmctcGx1cmFsaXplPgogICAgICAgIDwvZGl2PgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgc2hvdyBjb3JyZWN0IHBsdXJhbGl6ZWQgc3RyaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgd2l0aG91dE9mZnNldCA9IGVsZW1lbnQuYWxsKGJ5LmNzcygnbmctcGx1cmFsaXplJykpLmdldCgwKTsKICAgICAgICAgIHZhciB3aXRoT2Zmc2V0ID0gZWxlbWVudC5hbGwoYnkuY3NzKCduZy1wbHVyYWxpemUnKSkuZ2V0KDEpOwogICAgICAgICAgdmFyIGNvdW50SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdwZXJzb25Db3VudCcpKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJzEgcGVyc29uIGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ0lnb3IgaXMgdmlld2luZy4nKTsKCiAgICAgICAgICBjb3VudElucHV0LmNsZWFyKCk7CiAgICAgICAgICBjb3VudElucHV0LnNlbmRLZXlzKCcwJyk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdOb2JvZHkgaXMgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgY291bnRJbnB1dC5jbGVhcigpOwogICAgICAgICAgY291bnRJbnB1dC5zZW5kS2V5cygnMicpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnMiBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ0lnb3IgYW5kIE1pc2tvIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzMnKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJzMgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdJZ29yLCBNaXNrbyBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nKTsKCiAgICAgICAgICBjb3VudElucHV0LmNsZWFyKCk7CiAgICAgICAgICBjb3VudElucHV0LnNlbmRLZXlzKCc0Jyk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCc0IHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciwgTWlza28gYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgc2hvdyBkYXRhLWJvdW5kIG5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgd2l0aE9mZnNldCA9IGVsZW1lbnQuYWxsKGJ5LmNzcygnbmctcGx1cmFsaXplJykpLmdldCgxKTsKICAgICAgICAgIHZhciBwZXJzb25Db3VudCA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbkNvdW50JykpOwogICAgICAgICAgdmFyIHBlcnNvbjEgPSBlbGVtZW50KGJ5Lm1vZGVsKCdwZXJzb24xJykpOwogICAgICAgICAgdmFyIHBlcnNvbjIgPSBlbGVtZW50KGJ5Lm1vZGVsKCdwZXJzb24yJykpOwogICAgICAgICAgcGVyc29uQ291bnQuY2xlYXIoKTsKICAgICAgICAgIHBlcnNvbkNvdW50LnNlbmRLZXlzKCc0Jyk7CiAgICAgICAgICBwZXJzb24xLmNsZWFyKCk7CiAgICAgICAgICBwZXJzb24xLnNlbmRLZXlzKCdEaScpOwogICAgICAgICAgcGVyc29uMi5jbGVhcigpOwogICAgICAgICAgcGVyc29uMi5zZW5kS2V5cygnVm9qdGEnKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnRGksIFZvanRhIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIG5nUGx1cmFsaXplRGlyZWN0aXZlID0gWyckbG9jYWxlJywgJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRsb2NhbGUsICRpbnRlcnBvbGF0ZSkgewogIHZhciBCUkFDRSA9IC97fS9nOwogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0VBJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgIHZhciBudW1iZXJFeHAgPSBhdHRyLmNvdW50LAogICAgICAgICAgd2hlbkV4cCA9IGF0dHIuJGF0dHIud2hlbiAmJiBlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci53aGVuKSwgLy8gd2UgaGF2ZSB7e319IGluIGF0dHJzCiAgICAgICAgICBvZmZzZXQgPSBhdHRyLm9mZnNldCB8fCAwLAogICAgICAgICAgd2hlbnMgPSBzY29wZS4kZXZhbCh3aGVuRXhwKSB8fCB7fSwKICAgICAgICAgIHdoZW5zRXhwRm5zID0ge30sCiAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpLAogICAgICAgICAgaXNXaGVuID0gL153aGVuKE1pbnVzKT8oLispJC87CgogICAgICBmb3JFYWNoKGF0dHIsIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICBpZiAoaXNXaGVuLnRlc3QoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgIHdoZW5zW2xvd2VyY2FzZShhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoJ3doZW4nLCAnJykucmVwbGFjZSgnTWludXMnLCAnLScpKV0gPQogICAgICAgICAgICBlbGVtZW50LmF0dHIoYXR0ci4kYXR0clthdHRyaWJ1dGVOYW1lXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgZm9yRWFjaCh3aGVucywgZnVuY3Rpb24oZXhwcmVzc2lvbiwga2V5KSB7CiAgICAgICAgd2hlbnNFeHBGbnNba2V5XSA9CiAgICAgICAgICAkaW50ZXJwb2xhdGUoZXhwcmVzc2lvbi5yZXBsYWNlKEJSQUNFLCBzdGFydFN5bWJvbCArIG51bWJlckV4cCArICctJyArCiAgICAgICAgICAgIG9mZnNldCArIGVuZFN5bWJvbCkpOwogICAgICB9KTsKCiAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ1BsdXJhbGl6ZVdhdGNoKCkgewogICAgICAgIHZhciB2YWx1ZSA9IHBhcnNlRmxvYXQoc2NvcGUuJGV2YWwobnVtYmVyRXhwKSk7CgogICAgICAgIGlmICghaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAvL2lmIGV4cGxpY2l0IG51bWJlciBydWxlIHN1Y2ggYXMgMSwgMiwgMy4uLiBpcyBkZWZpbmVkLCBqdXN0IHVzZSBpdC4gT3RoZXJ3aXNlLAogICAgICAgICAgLy9jaGVjayBpdCBhZ2FpbnN0IHBsdXJhbGl6YXRpb24gcnVsZXMgaW4gJGxvY2FsZSBzZXJ2aWNlCiAgICAgICAgICBpZiAoISh2YWx1ZSBpbiB3aGVucykpIHZhbHVlID0gJGxvY2FsZS5wbHVyYWxDYXQodmFsdWUgLSBvZmZzZXQpOwogICAgICAgICAgIHJldHVybiB3aGVuc0V4cEZuc1t2YWx1ZV0oc2NvcGUsIGVsZW1lbnQsIHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfQogICAgICB9LCBmdW5jdGlvbiBuZ1BsdXJhbGl6ZVdhdGNoQWN0aW9uKG5ld1ZhbCkgewogICAgICAgIGVsZW1lbnQudGV4dChuZXdWYWwpOwogICAgICB9KTsKICAgIH0KICB9Owp9XTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nUmVwZWF0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nUmVwZWF0YCBkaXJlY3RpdmUgaW5zdGFudGlhdGVzIGEgdGVtcGxhdGUgb25jZSBwZXIgaXRlbSBmcm9tIGEgY29sbGVjdGlvbi4gRWFjaCB0ZW1wbGF0ZQogKiBpbnN0YW5jZSBnZXRzIGl0cyBvd24gc2NvcGUsIHdoZXJlIHRoZSBnaXZlbiBsb29wIHZhcmlhYmxlIGlzIHNldCB0byB0aGUgY3VycmVudCBjb2xsZWN0aW9uIGl0ZW0sCiAqIGFuZCBgJGluZGV4YCBpcyBzZXQgdG8gdGhlIGl0ZW0gaW5kZXggb3Iga2V5LgogKgogKiBTcGVjaWFsIHByb3BlcnRpZXMgYXJlIGV4cG9zZWQgb24gdGhlIGxvY2FsIHNjb3BlIG9mIGVhY2ggdGVtcGxhdGUgaW5zdGFuY2UsIGluY2x1ZGluZzoKICoKICogfCBWYXJpYWJsZSAgfCBUeXBlICAgICAgICAgICAgfCBEZXRhaWxzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8LS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAqIHwgYCRpbmRleGAgIHwge0B0eXBlIG51bWJlcn0gIHwgaXRlcmF0b3Igb2Zmc2V0IG9mIHRoZSByZXBlYXRlZCBlbGVtZW50ICgwLi5sZW5ndGgtMSkgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCBgJGZpcnN0YCAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGZpcnN0IGluIHRoZSBpdGVyYXRvci4gICAgICAgICAgICAgICAgICAgICAgfAogKiB8IGAkbWlkZGxlYCB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgYmV0d2VlbiB0aGUgZmlyc3QgYW5kIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLiB8CiAqIHwgYCRsYXN0YCAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBsYXN0IGluIHRoZSBpdGVyYXRvci4gICAgICAgICAgICAgICAgICAgICAgIHwKICogfCBgJGV2ZW5gICAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSBpdGVyYXRvciBwb3NpdGlvbiBgJGluZGV4YCBpcyBldmVuIChvdGhlcndpc2UgZmFsc2UpLiAgICAgICAgICAgfAogKiB8IGAkb2RkYCAgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIGl0ZXJhdG9yIHBvc2l0aW9uIGAkaW5kZXhgIGlzIG9kZCAob3RoZXJ3aXNlIGZhbHNlKS4gICAgICAgICAgICB8CiAqCiAqIENyZWF0aW5nIGFsaWFzZXMgZm9yIHRoZXNlIHByb3BlcnRpZXMgaXMgcG9zc2libGUgd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5pdCBgbmdJbml0YH0uCiAqIFRoaXMgbWF5IGJlIHVzZWZ1bCB3aGVuLCBmb3IgaW5zdGFuY2UsIG5lc3RpbmcgbmdSZXBlYXRzLgogKgogKiAjIFNwZWNpYWwgcmVwZWF0IHN0YXJ0IGFuZCBlbmQgcG9pbnRzCiAqIFRvIHJlcGVhdCBhIHNlcmllcyBvZiBlbGVtZW50cyBpbnN0ZWFkIG9mIGp1c3Qgb25lIHBhcmVudCBlbGVtZW50LCBuZ1JlcGVhdCAoYXMgd2VsbCBhcyBvdGhlciBuZyBkaXJlY3RpdmVzKSBzdXBwb3J0cyBleHRlbmRpbmcKICogdGhlIHJhbmdlIG9mIHRoZSByZXBlYXRlciBieSBkZWZpbmluZyBleHBsaWNpdCBzdGFydCBhbmQgZW5kIHBvaW50cyBieSB1c2luZyAqKm5nLXJlcGVhdC1zdGFydCoqIGFuZCAqKm5nLXJlcGVhdC1lbmQqKiByZXNwZWN0aXZlbHkuCiAqIFRoZSAqKm5nLXJlcGVhdC1zdGFydCoqIGRpcmVjdGl2ZSB3b3JrcyB0aGUgc2FtZSBhcyAqKm5nLXJlcGVhdCoqLCBidXQgd2lsbCByZXBlYXQgYWxsIHRoZSBIVE1MIGNvZGUgKGluY2x1ZGluZyB0aGUgdGFnIGl0J3MgZGVmaW5lZCBvbikKICogdXAgdG8gYW5kIGluY2x1ZGluZyB0aGUgZW5kaW5nIEhUTUwgdGFnIHdoZXJlICoqbmctcmVwZWF0LWVuZCoqIGlzIHBsYWNlZC4KICoKICogVGhlIGV4YW1wbGUgYmVsb3cgbWFrZXMgdXNlIG9mIHRoaXMgZmVhdHVyZToKICogYGBgaHRtbAogKiAgIDxoZWFkZXIgbmctcmVwZWF0LXN0YXJ0PSJpdGVtIGluIGl0ZW1zIj4KICogICAgIEhlYWRlciB7eyBpdGVtIH19CiAqICAgPC9oZWFkZXI+CiAqICAgPGRpdiBjbGFzcz0iYm9keSI+CiAqICAgICBCb2R5IHt7IGl0ZW0gfX0KICogICA8L2Rpdj4KICogICA8Zm9vdGVyIG5nLXJlcGVhdC1lbmQ+CiAqICAgICBGb290ZXIge3sgaXRlbSB9fQogKiAgIDwvZm9vdGVyPgogKiBgYGAKICoKICogQW5kIHdpdGggYW4gaW5wdXQgb2Yge0B0eXBlIFsnQScsJ0InXX0gZm9yIHRoZSBpdGVtcyB2YXJpYWJsZSBpbiB0aGUgZXhhbXBsZSBhYm92ZSwgdGhlIG91dHB1dCB3aWxsIGV2YWx1YXRlIHRvOgogKiBgYGBodG1sCiAqICAgPGhlYWRlcj4KICogICAgIEhlYWRlciBBCiAqICAgPC9oZWFkZXI+CiAqICAgPGRpdiBjbGFzcz0iYm9keSI+CiAqICAgICBCb2R5IEEKICogICA8L2Rpdj4KICogICA8Zm9vdGVyPgogKiAgICAgRm9vdGVyIEEKICogICA8L2Zvb3Rlcj4KICogICA8aGVhZGVyPgogKiAgICAgSGVhZGVyIEIKICogICA8L2hlYWRlcj4KICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICogICAgIEJvZHkgQgogKiAgIDwvZGl2PgogKiAgIDxmb290ZXI+CiAqICAgICBGb290ZXIgQgogKiAgIDwvZm9vdGVyPgogKiBgYGAKICoKICogVGhlIGN1c3RvbSBzdGFydCBhbmQgZW5kIHBvaW50cyBmb3IgbmdSZXBlYXQgYWxzbyBzdXBwb3J0IGFsbCBvdGhlciBIVE1MIGRpcmVjdGl2ZSBzeW50YXggZmxhdm9ycyBwcm92aWRlZCBpbiBBbmd1bGFySlMgKHN1Y2gKICogYXMgKipkYXRhLW5nLXJlcGVhdC1zdGFydCoqLCAqKngtbmctcmVwZWF0LXN0YXJ0KiogYW5kICoqbmc6cmVwZWF0LXN0YXJ0KiopLgogKgogKiBAYW5pbWF0aW9ucwogKiAqKi5lbnRlcioqIC0gd2hlbiBhIG5ldyBpdGVtIGlzIGFkZGVkIHRvIHRoZSBsaXN0IG9yIHdoZW4gYW4gaXRlbSBpcyByZXZlYWxlZCBhZnRlciBhIGZpbHRlcgogKgogKiAqKi5sZWF2ZSoqIC0gd2hlbiBhbiBpdGVtIGlzIHJlbW92ZWQgZnJvbSB0aGUgbGlzdCBvciB3aGVuIGFuIGl0ZW0gaXMgZmlsdGVyZWQgb3V0CiAqCiAqICoqLm1vdmUqKiAtIHdoZW4gYW4gYWRqYWNlbnQgaXRlbSBpcyBmaWx0ZXJlZCBvdXQgY2F1c2luZyBhIHJlb3JkZXIgb3Igd2hlbiB0aGUgaXRlbSBjb250ZW50cyBhcmUgcmVvcmRlcmVkCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAc2NvcGUKICogQHByaW9yaXR5IDEwMDAKICogQHBhcmFtIHtyZXBlYXRfZXhwcmVzc2lvbn0gbmdSZXBlYXQgVGhlIGV4cHJlc3Npb24gaW5kaWNhdGluZyBob3cgdG8gZW51bWVyYXRlIGEgY29sbGVjdGlvbi4gVGhlc2UKICogICBmb3JtYXRzIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkOgogKgogKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb25gIOKAkyB3aGVyZSB2YXJpYWJsZSBpcyB0aGUgdXNlciBkZWZpbmVkIGxvb3AgdmFyaWFibGUgYW5kIGBleHByZXNzaW9uYAogKiAgICAgaXMgYSBzY29wZSBleHByZXNzaW9uIGdpdmluZyB0aGUgY29sbGVjdGlvbiB0byBlbnVtZXJhdGUuCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGFsYnVtIGluIGFydGlzdC5hbGJ1bXNgLgogKgogKiAgICogYChrZXksIHZhbHVlKSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgYGtleWAgYW5kIGB2YWx1ZWAgY2FuIGJlIGFueSB1c2VyIGRlZmluZWQgaWRlbnRpZmllcnMsCiAqICAgICBhbmQgYGV4cHJlc3Npb25gIGlzIHRoZSBzY29wZSBleHByZXNzaW9uIGdpdmluZyB0aGUgY29sbGVjdGlvbiB0byBlbnVtZXJhdGUuCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYChuYW1lLCBhZ2UpIGluIHsnYWRhbSc6MTAsICdhbWFsaWUnOjEyfWAuCiAqCiAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbiB0cmFjayBieSB0cmFja2luZ19leHByZXNzaW9uYCDigJMgWW91IGNhbiBhbHNvIHByb3ZpZGUgYW4gb3B0aW9uYWwgdHJhY2tpbmcgZnVuY3Rpb24KICogICAgIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGFzc29jaWF0ZSB0aGUgb2JqZWN0cyBpbiB0aGUgY29sbGVjdGlvbiB3aXRoIHRoZSBET00gZWxlbWVudHMuIElmIG5vIHRyYWNraW5nIGZ1bmN0aW9uCiAqICAgICBpcyBzcGVjaWZpZWQgdGhlIG5nLXJlcGVhdCBhc3NvY2lhdGVzIGVsZW1lbnRzIGJ5IGlkZW50aXR5IGluIHRoZSBjb2xsZWN0aW9uLiBJdCBpcyBhbiBlcnJvciB0byBoYXZlCiAqICAgICBtb3JlIHRoYW4gb25lIHRyYWNraW5nIGZ1bmN0aW9uIHRvIHJlc29sdmUgdG8gdGhlIHNhbWUga2V5LiAoVGhpcyB3b3VsZCBtZWFuIHRoYXQgdHdvIGRpc3RpbmN0IG9iamVjdHMgYXJlCiAqICAgICBtYXBwZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQsIHdoaWNoIGlzIG5vdCBwb3NzaWJsZS4pICBGaWx0ZXJzIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSBleHByZXNzaW9uLAogKiAgICAgYmVmb3JlIHNwZWNpZnlpbmcgYSB0cmFja2luZyBleHByZXNzaW9uLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zYCBpcyBlcXVpdmFsZW50IHRvIGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5ICRpZChpdGVtKWAuIFRoaXMgaW1wbGllcyB0aGF0IHRoZSBET00gZWxlbWVudHMKICogICAgIHdpbGwgYmUgYXNzb2NpYXRlZCBieSBpdGVtIGlkZW50aXR5IGluIHRoZSBhcnJheS4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSlgLiBBIGJ1aWx0IGluIGAkaWQoKWAgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gYXNzaWduIGEgdW5pcXVlCiAqICAgICBgJCRoYXNoS2V5YCBwcm9wZXJ0eSB0byBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5LiBUaGlzIHByb3BlcnR5IGlzIHRoZW4gdXNlZCBhcyBhIGtleSB0byBhc3NvY2lhdGVkIERPTSBlbGVtZW50cwogKiAgICAgd2l0aCB0aGUgY29ycmVzcG9uZGluZyBpdGVtIGluIHRoZSBhcnJheSBieSBpZGVudGl0eS4gTW92aW5nIHRoZSBzYW1lIG9iamVjdCBpbiBhcnJheSB3b3VsZCBtb3ZlIHRoZSBET00KICogICAgIGVsZW1lbnQgaW4gdGhlIHNhbWUgd2F5IGluIHRoZSBET00uCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSB0eXBpY2FsIHBhdHRlcm4gd2hlbiB0aGUgaXRlbXMgY29tZSBmcm9tIHRoZSBkYXRhYmFzZS4gSW4gdGhpcwogKiAgICAgY2FzZSB0aGUgb2JqZWN0IGlkZW50aXR5IGRvZXMgbm90IG1hdHRlci4gVHdvIG9iamVjdHMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBhcyBsb25nIGFzIHRoZWlyIGBpZGAKICogICAgIHByb3BlcnR5IGlzIHNhbWUuCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgfCBmaWx0ZXI6c2VhcmNoVGV4dCB0cmFjayBieSBpdGVtLmlkYCBpcyBhIHBhdHRlcm4gdGhhdCBtaWdodCBiZSB1c2VkIHRvIGFwcGx5IGEgZmlsdGVyCiAqICAgICB0byBpdGVtcyBpbiBjb25qdW5jdGlvbiB3aXRoIGEgdHJhY2tpbmcgZXhwcmVzc2lvbi4KICoKICogQGV4YW1wbGUKICogVGhpcyBleGFtcGxlIGluaXRpYWxpemVzIHRoZSBzY29wZSB0byBhIGxpc3Qgb2YgbmFtZXMgYW5kCiAqIHRoZW4gdXNlcyBgbmdSZXBlYXRgIHRvIGRpc3BsYXkgZXZlcnkgcGVyc29uOgogIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFsKICAgICAgICB7bmFtZTonSm9obicsIGFnZToyNSwgZ2VuZGVyOidib3knfSwKICAgICAgICB7bmFtZTonSmVzc2llJywgYWdlOjMwLCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICB7bmFtZTonSm9oYW5uYScsIGFnZToyOCwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAge25hbWU6J0pveScsIGFnZToxNSwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAge25hbWU6J01hcnknLCBhZ2U6MjgsIGdlbmRlcjonZ2lybCd9LAogICAgICAgIHtuYW1lOidQZXRlcicsIGFnZTo5NSwgZ2VuZGVyOidib3knfSwKICAgICAgICB7bmFtZTonU2ViYXN0aWFuJywgYWdlOjUwLCBnZW5kZXI6J2JveSd9LAogICAgICAgIHtuYW1lOidFcmlrYScsIGFnZToyNywgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAge25hbWU6J1BhdHJpY2snLCBhZ2U6NDAsIGdlbmRlcjonYm95J30sCiAgICAgICAge25hbWU6J1NhbWFudGhhJywgYWdlOjYwLCBnZW5kZXI6J2dpcmwnfQogICAgICBdIj4KICAgICAgICBJIGhhdmUge3tmcmllbmRzLmxlbmd0aH19IGZyaWVuZHMuIFRoZXkgYXJlOgogICAgICAgIDxpbnB1dCB0eXBlPSJzZWFyY2giIG5nLW1vZGVsPSJxIiBwbGFjZWhvbGRlcj0iZmlsdGVyIGZyaWVuZHMuLi4iIC8+CiAgICAgICAgPHVsIGNsYXNzPSJleGFtcGxlLWFuaW1hdGUtY29udGFpbmVyIj4KICAgICAgICAgIDxsaSBjbGFzcz0iYW5pbWF0ZS1yZXBlYXQiIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6cSI+CiAgICAgICAgICAgIFt7eyRpbmRleCArIDF9fV0ge3tmcmllbmQubmFtZX19IHdobyBpcyB7e2ZyaWVuZC5hZ2V9fSB5ZWFycyBvbGQuCiAgICAgICAgICA8L2xpPgogICAgICAgIDwvdWw+CiAgICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuZXhhbXBsZS1hbmltYXRlLWNvbnRhaW5lciB7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGxpc3Qtc3R5bGU6bm9uZTsKICAgICAgICBtYXJnaW46MDsKICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtcmVwZWF0IHsKICAgICAgICBsaW5lLWhlaWdodDo0MHB4OwogICAgICAgIGxpc3Qtc3R5bGU6bm9uZTsKICAgICAgICBib3gtc2l6aW5nOmJvcmRlci1ib3g7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1tb3ZlLAogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctZW50ZXIsCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1sZWF2ZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSwKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLW1vdmUsCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlciB7CiAgICAgICAgb3BhY2l0eTowOwogICAgICAgIG1heC1oZWlnaHQ6MDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlLAogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbW92ZS5uZy1tb3ZlLWFjdGl2ZSwKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgb3BhY2l0eToxOwogICAgICAgIG1heC1oZWlnaHQ6NDBweDsKICAgICAgfQogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIHZhciBmcmllbmRzID0gZWxlbWVudC5hbGwoYnkucmVwZWF0ZXIoJ2ZyaWVuZCBpbiBmcmllbmRzJykpOwoKICAgICAgaXQoJ3Nob3VsZCByZW5kZXIgaW5pdGlhbCBkYXRhIHNldCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMTApOwogICAgICAgIGV4cGVjdChmcmllbmRzLmdldCgwKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxXSBKb2huIHdobyBpcyAyNSB5ZWFycyBvbGQuJyk7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMuZ2V0KDEpLmdldFRleHQoKSkudG9FcXVhbCgnWzJdIEplc3NpZSB3aG8gaXMgMzAgeWVhcnMgb2xkLicpOwogICAgICAgIGV4cGVjdChmcmllbmRzLmxhc3QoKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxMF0gU2FtYW50aGEgd2hvIGlzIDYwIHllYXJzIG9sZC4nKTsKICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdmcmllbmRzLmxlbmd0aCcpKS5nZXRUZXh0KCkpCiAgICAgICAgICAgIC50b01hdGNoKCJJIGhhdmUgMTAgZnJpZW5kcy4gVGhleSBhcmU6Iik7CiAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgdXBkYXRlIHJlcGVhdGVyIHdoZW4gZmlsdGVyIHByZWRpY2F0ZSBjaGFuZ2VzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMTApOwoKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgncScpKS5zZW5kS2V5cygnbWEnKTsKCiAgICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMik7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmdldCgwKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxXSBNYXJ5IHdobyBpcyAyOCB5ZWFycyBvbGQuJyk7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmxhc3QoKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1syXSBTYW1hbnRoYSB3aG8gaXMgNjAgeWVhcnMgb2xkLicpOwogICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICovCnZhciBuZ1JlcGVhdERpcmVjdGl2ZSA9IFsnJHBhcnNlJywgJyRhbmltYXRlJywgZnVuY3Rpb24oJHBhcnNlLCAkYW5pbWF0ZSkgewogIHZhciBOR19SRU1PVkVEID0gJyQkTkdfUkVNT1ZFRCc7CiAgdmFyIG5nUmVwZWF0TWluRXJyID0gbWluRXJyKCduZ1JlcGVhdCcpOwogIHJldHVybiB7CiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICBwcmlvcml0eTogMTAwMCwKICAgIHRlcm1pbmFsOiB0cnVlLAogICAgJCR0bGI6IHRydWUsCiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybCwgJHRyYW5zY2x1ZGUpewogICAgICAgIHZhciBleHByZXNzaW9uID0gJGF0dHIubmdSZXBlYXQ7CiAgICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxzKihbXHNcU10rPylccytpblxzKyhbXHNcU10rPykoPzpccyt0cmFja1xzK2J5XHMrKFtcc1xTXSs/KSk/XHMqJC8pLAogICAgICAgICAgdHJhY2tCeUV4cCwgdHJhY2tCeUV4cEdldHRlciwgdHJhY2tCeUlkRXhwRm4sIHRyYWNrQnlJZEFycmF5Rm4sIHRyYWNrQnlJZE9iakZuLAogICAgICAgICAgbGhzLCByaHMsIHZhbHVlSWRlbnRpZmllciwga2V5SWRlbnRpZmllciwKICAgICAgICAgIGhhc2hGbkxvY2FscyA9IHskaWQ6IGhhc2hLZXl9OwoKICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICB0aHJvdyBuZ1JlcGVhdE1pbkVycignaWV4cCcsICJFeHBlY3RlZCBleHByZXNzaW9uIGluIGZvcm0gb2YgJ19pdGVtXyBpbiBfY29sbGVjdGlvbl9bIHRyYWNrIGJ5IF9pZF9dJyBidXQgZ290ICd7MH0nLiIsCiAgICAgICAgICAgIGV4cHJlc3Npb24pOwogICAgICAgIH0KCiAgICAgICAgbGhzID0gbWF0Y2hbMV07CiAgICAgICAgcmhzID0gbWF0Y2hbMl07CiAgICAgICAgdHJhY2tCeUV4cCA9IG1hdGNoWzNdOwoKICAgICAgICBpZiAodHJhY2tCeUV4cCkgewogICAgICAgICAgdHJhY2tCeUV4cEdldHRlciA9ICRwYXJzZSh0cmFja0J5RXhwKTsKICAgICAgICAgIHRyYWNrQnlJZEV4cEZuID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgLy8gYXNzaWduIGtleSwgdmFsdWUsIGFuZCAkaW5kZXggdG8gdGhlIGxvY2FscyBzbyB0aGF0IHRoZXkgY2FuIGJlIHVzZWQgaW4gaGFzaCBmdW5jdGlvbnMKICAgICAgICAgICAgaWYgKGtleUlkZW50aWZpZXIpIGhhc2hGbkxvY2Fsc1trZXlJZGVudGlmaWVyXSA9IGtleTsKICAgICAgICAgICAgaGFzaEZuTG9jYWxzW3ZhbHVlSWRlbnRpZmllcl0gPSB2YWx1ZTsKICAgICAgICAgICAgaGFzaEZuTG9jYWxzLiRpbmRleCA9IGluZGV4OwogICAgICAgICAgICByZXR1cm4gdHJhY2tCeUV4cEdldHRlcigkc2NvcGUsIGhhc2hGbkxvY2Fscyk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cmFja0J5SWRBcnJheUZuID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaGFzaEtleSh2YWx1ZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdHJhY2tCeUlkT2JqRm4gPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBtYXRjaCA9IGxocy5tYXRjaCgvXig/OihbXCRcd10rKXxcKChbXCRcd10rKVxzKixccyooW1wkXHddKylcKSkkLyk7CiAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgdGhyb3cgbmdSZXBlYXRNaW5FcnIoJ2lpZGV4cCcsICInX2l0ZW1fJyBpbiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uXycgc2hvdWxkIGJlIGFuIGlkZW50aWZpZXIgb3IgJyhfa2V5XywgX3ZhbHVlXyknIGV4cHJlc3Npb24sIGJ1dCBnb3QgJ3swfScuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaHMpOwogICAgICAgIH0KICAgICAgICB2YWx1ZUlkZW50aWZpZXIgPSBtYXRjaFszXSB8fCBtYXRjaFsxXTsKICAgICAgICBrZXlJZGVudGlmaWVyID0gbWF0Y2hbMl07CgogICAgICAgIC8vIFN0b3JlIGEgbGlzdCBvZiBlbGVtZW50cyBmcm9tIHByZXZpb3VzIHJ1bi4gVGhpcyBpcyBhIGhhc2ggd2hlcmUga2V5IGlzIHRoZSBpdGVtIGZyb20gdGhlCiAgICAgICAgLy8gaXRlcmF0b3IsIGFuZCB0aGUgdmFsdWUgaXMgb2JqZWN0cyB3aXRoIGZvbGxvd2luZyBwcm9wZXJ0aWVzLgogICAgICAgIC8vICAgLSBzY29wZTogYm91bmQgc2NvcGUKICAgICAgICAvLyAgIC0gZWxlbWVudDogcHJldmlvdXMgZWxlbWVudC4KICAgICAgICAvLyAgIC0gaW5kZXg6IHBvc2l0aW9uCiAgICAgICAgdmFyIGxhc3RCbG9ja01hcCA9IHt9OwoKICAgICAgICAvL3dhdGNoIHByb3BzCiAgICAgICAgJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24ocmhzLCBmdW5jdGlvbiBuZ1JlcGVhdEFjdGlvbihjb2xsZWN0aW9uKXsKICAgICAgICAgIHZhciBpbmRleCwgbGVuZ3RoLAogICAgICAgICAgICAgIHByZXZpb3VzTm9kZSA9ICRlbGVtZW50WzBdLCAgICAgLy8gY3VycmVudCBwb3NpdGlvbiBvZiB0aGUgbm9kZQogICAgICAgICAgICAgIG5leHROb2RlLAogICAgICAgICAgICAgIC8vIFNhbWUgYXMgbGFzdEJsb2NrTWFwIGJ1dCBpdCBoYXMgdGhlIGN1cnJlbnQgc3RhdGUuIEl0IHdpbGwgYmVjb21lIHRoZQogICAgICAgICAgICAgIC8vIGxhc3RCbG9ja01hcCBvbiB0aGUgbmV4dCBpdGVyYXRpb24uCiAgICAgICAgICAgICAgbmV4dEJsb2NrTWFwID0ge30sCiAgICAgICAgICAgICAgYXJyYXlMZW5ndGgsCiAgICAgICAgICAgICAgY2hpbGRTY29wZSwKICAgICAgICAgICAgICBrZXksIHZhbHVlLCAvLyBrZXkvdmFsdWUgb2YgaXRlcmF0aW9uCiAgICAgICAgICAgICAgdHJhY2tCeUlkLAogICAgICAgICAgICAgIHRyYWNrQnlJZEZuLAogICAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzLAogICAgICAgICAgICAgIGJsb2NrLCAgICAgICAvLyBsYXN0IG9iamVjdCBpbmZvcm1hdGlvbiB7c2NvcGUsIGVsZW1lbnQsIGlkfQogICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyID0gW10sCiAgICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZTsKCgogICAgICAgICAgaWYgKGlzQXJyYXlMaWtlKGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzID0gY29sbGVjdGlvbjsKICAgICAgICAgICAgdHJhY2tCeUlkRm4gPSB0cmFja0J5SWRFeHBGbiB8fCB0cmFja0J5SWRBcnJheUZuOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJhY2tCeUlkRm4gPSB0cmFja0J5SWRFeHBGbiB8fCB0cmFja0J5SWRPYmpGbjsKICAgICAgICAgICAgLy8gaWYgb2JqZWN0LCBleHRyYWN0IGtleXMsIHNvcnQgdGhlbSBhbmQgdXNlIHRvIGRldGVybWluZSBvcmRlciBvZiBpdGVyYXRpb24gb3ZlciBvYmogcHJvcHMKICAgICAgICAgICAgY29sbGVjdGlvbktleXMgPSBbXTsKICAgICAgICAgICAgZm9yIChrZXkgaW4gY29sbGVjdGlvbikgewogICAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmhhc093blByb3BlcnR5KGtleSkgJiYga2V5LmNoYXJBdCgwKSAhPSAnJCcpIHsKICAgICAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29sbGVjdGlvbktleXMuc29ydCgpOwogICAgICAgICAgfQoKICAgICAgICAgIGFycmF5TGVuZ3RoID0gY29sbGVjdGlvbktleXMubGVuZ3RoOwoKICAgICAgICAgIC8vIGxvY2F0ZSBleGlzdGluZyBpdGVtcwogICAgICAgICAgbGVuZ3RoID0gbmV4dEJsb2NrT3JkZXIubGVuZ3RoID0gY29sbGVjdGlvbktleXMubGVuZ3RoOwogICAgICAgICAgZm9yKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbktleXMpID8gaW5kZXggOiBjb2xsZWN0aW9uS2V5c1tpbmRleF07CiAgICAgICAgICAgdmFsdWUgPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgdHJhY2tCeUlkID0gdHJhY2tCeUlkRm4oa2V5LCB2YWx1ZSwgaW5kZXgpOwogICAgICAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KHRyYWNrQnlJZCwgJ2B0cmFjayBieWAgaWQnKTsKICAgICAgICAgICBpZihsYXN0QmxvY2tNYXAuaGFzT3duUHJvcGVydHkodHJhY2tCeUlkKSkgewogICAgICAgICAgICAgYmxvY2sgPSBsYXN0QmxvY2tNYXBbdHJhY2tCeUlkXTsKICAgICAgICAgICAgIGRlbGV0ZSBsYXN0QmxvY2tNYXBbdHJhY2tCeUlkXTsKICAgICAgICAgICAgIG5leHRCbG9ja01hcFt0cmFja0J5SWRdID0gYmxvY2s7CiAgICAgICAgICAgICBuZXh0QmxvY2tPcmRlcltpbmRleF0gPSBibG9jazsKICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRCbG9ja01hcC5oYXNPd25Qcm9wZXJ0eSh0cmFja0J5SWQpKSB7CiAgICAgICAgICAgICAvLyByZXN0b3JlIGxhc3RCbG9ja01hcAogICAgICAgICAgICAgZm9yRWFjaChuZXh0QmxvY2tPcmRlciwgZnVuY3Rpb24oYmxvY2spIHsKICAgICAgICAgICAgICAgaWYgKGJsb2NrICYmIGJsb2NrLnNjb3BlKSBsYXN0QmxvY2tNYXBbYmxvY2suaWRdID0gYmxvY2s7CiAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBkdXBsaWNhdGUgYW5kIHdlIG5lZWQgdG8gdGhyb3cgYW4gZXJyb3IKICAgICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdkdXBlcycsICJEdXBsaWNhdGVzIGluIGEgcmVwZWF0ZXIgYXJlIG5vdCBhbGxvd2VkLiBVc2UgJ3RyYWNrIGJ5JyBleHByZXNzaW9uIHRvIHNwZWNpZnkgdW5pcXVlIGtleXMuIFJlcGVhdGVyOiB7MH0sIER1cGxpY2F0ZSBrZXk6IHsxfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uLCAgICAgICB0cmFja0J5SWQpOwogICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAvLyBuZXcgbmV2ZXIgYmVmb3JlIHNlZW4gYmxvY2sKICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyW2luZGV4XSA9IHsgaWQ6IHRyYWNrQnlJZCB9OwogICAgICAgICAgICAgbmV4dEJsb2NrTWFwW3RyYWNrQnlJZF0gPSBmYWxzZTsKICAgICAgICAgICB9CiAgICAgICAgIH0KCiAgICAgICAgICAvLyByZW1vdmUgZXhpc3RpbmcgaXRlbXMKICAgICAgICAgIGZvciAoa2V5IGluIGxhc3RCbG9ja01hcCkgewogICAgICAgICAgICAvLyBsYXN0QmxvY2tNYXAgaXMgb3VyIG93biBvYmplY3Qgc28gd2UgZG9uJ3QgbmVlZCB0byB1c2Ugc3BlY2lhbCBoYXNPd25Qcm9wZXJ0eUZuCiAgICAgICAgICAgIGlmIChsYXN0QmxvY2tNYXAuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIGJsb2NrID0gbGFzdEJsb2NrTWFwW2tleV07CiAgICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZSA9IGdldEJsb2NrRWxlbWVudHMoYmxvY2suY2xvbmUpOwogICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGVsZW1lbnRzVG9SZW1vdmUpOwogICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudHNUb1JlbW92ZSwgZnVuY3Rpb24oZWxlbWVudCkgeyBlbGVtZW50W05HX1JFTU9WRURdID0gdHJ1ZTsgfSk7CiAgICAgICAgICAgICAgYmxvY2suc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIHdlIGFyZSBub3QgdXNpbmcgZm9yRWFjaCBmb3IgcGVyZiByZWFzb25zICh0cnlpbmcgdG8gYXZvaWQgI2NhbGwpCiAgICAgICAgICBmb3IgKGluZGV4ID0gMCwgbGVuZ3RoID0gY29sbGVjdGlvbktleXMubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbktleXMpID8gaW5kZXggOiBjb2xsZWN0aW9uS2V5c1tpbmRleF07CiAgICAgICAgICAgIHZhbHVlID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICBibG9jayA9IG5leHRCbG9ja09yZGVyW2luZGV4XTsKICAgICAgICAgICAgaWYgKG5leHRCbG9ja09yZGVyW2luZGV4IC0gMV0pIHByZXZpb3VzTm9kZSA9IGdldEJsb2NrRW5kKG5leHRCbG9ja09yZGVyW2luZGV4IC0gMV0pOwoKICAgICAgICAgICAgaWYgKGJsb2NrLnNjb3BlKSB7CiAgICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBhbHJlYWR5IHNlZW4gdGhpcyBvYmplY3QsIHRoZW4gd2UgbmVlZCB0byByZXVzZSB0aGUKICAgICAgICAgICAgICAvLyBhc3NvY2lhdGVkIHNjb3BlL2VsZW1lbnQKICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gYmxvY2suc2NvcGU7CgogICAgICAgICAgICAgIG5leHROb2RlID0gcHJldmlvdXNOb2RlOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIG5leHROb2RlID0gbmV4dE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgfSB3aGlsZShuZXh0Tm9kZSAmJiBuZXh0Tm9kZVtOR19SRU1PVkVEXSk7CgogICAgICAgICAgICAgIGlmIChnZXRCbG9ja1N0YXJ0KGJsb2NrKSAhPSBuZXh0Tm9kZSkgewogICAgICAgICAgICAgICAgLy8gZXhpc3RpbmcgaXRlbSB3aGljaCBnb3QgbW92ZWQKICAgICAgICAgICAgICAgICRhbmltYXRlLm1vdmUoZ2V0QmxvY2tFbGVtZW50cyhibG9jay5jbG9uZSksIG51bGwsIGpxTGl0ZShwcmV2aW91c05vZGUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldmlvdXNOb2RlID0gZ2V0QmxvY2tFbmQoYmxvY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIG5ldyBpdGVtIHdoaWNoIHdlIGRvbid0IGtub3cgYWJvdXQKICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gJHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50aWZpZXJdID0gdmFsdWU7CiAgICAgICAgICAgIGlmIChrZXlJZGVudGlmaWVyKSBjaGlsZFNjb3BlW2tleUlkZW50aWZpZXJdID0ga2V5OwogICAgICAgICAgICBjaGlsZFNjb3BlLiRpbmRleCA9IGluZGV4OwogICAgICAgICAgICBjaGlsZFNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICAgICAgICAgIGNoaWxkU2NvcGUuJGxhc3QgPSAoaW5kZXggPT09IChhcnJheUxlbmd0aCAtIDEpKTsKICAgICAgICAgICAgY2hpbGRTY29wZS4kbWlkZGxlID0gIShjaGlsZFNjb3BlLiRmaXJzdCB8fCBjaGlsZFNjb3BlLiRsYXN0KTsKICAgICAgICAgICAgLy8ganNoaW50IGJpdHdpc2U6IGZhbHNlCiAgICAgICAgICAgIGNoaWxkU2NvcGUuJG9kZCA9ICEoY2hpbGRTY29wZS4kZXZlbiA9IChpbmRleCYxKSA9PT0gMCk7CiAgICAgICAgICAgIC8vIGpzaGludCBiaXR3aXNlOiB0cnVlCgogICAgICAgICAgICBpZiAoIWJsb2NrLnNjb3BlKSB7CiAgICAgICAgICAgICAgJHRyYW5zY2x1ZGUoY2hpbGRTY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICAgIGNsb25lW2Nsb25lLmxlbmd0aCsrXSA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyBlbmQgbmdSZXBlYXQ6ICcgKyBleHByZXNzaW9uICsgJyAnKTsKICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNsb25lLCBudWxsLCBqcUxpdGUocHJldmlvdXNOb2RlKSk7CiAgICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBjbG9uZTsKICAgICAgICAgICAgICAgIGJsb2NrLnNjb3BlID0gY2hpbGRTY29wZTsKICAgICAgICAgICAgICAgIC8vIE5vdGU6IFdlIG9ubHkgbmVlZCB0aGUgZmlyc3QvbGFzdCBub2RlIG9mIHRoZSBjbG9uZWQgbm9kZXMuCiAgICAgICAgICAgICAgICAvLyBIb3dldmVyLCB3ZSBuZWVkIHRvIGtlZXAgdGhlIHJlZmVyZW5jZSB0byB0aGUganFsaXRlIHdyYXBwZXIgYXMgaXQgbWlnaHQgYmUgY2hhbmdlZCBsYXRlcgogICAgICAgICAgICAgICAgLy8gYnkgYSBkaXJlY3RpdmUgd2l0aCB0ZW1wbGF0ZVVybCB3aGVuIGl0cyB0ZW1wbGF0ZSBhcnJpdmVzLgogICAgICAgICAgICAgICAgYmxvY2suY2xvbmUgPSBjbG9uZTsKICAgICAgICAgICAgICAgIG5leHRCbG9ja01hcFtibG9jay5pZF0gPSBibG9jazsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbGFzdEJsb2NrTWFwID0gbmV4dEJsb2NrTWFwOwogICAgICAgIH0pOwogICAgfQogIH07CgogIGZ1bmN0aW9uIGdldEJsb2NrU3RhcnQoYmxvY2spIHsKICAgIHJldHVybiBibG9jay5jbG9uZVswXTsKICB9CgogIGZ1bmN0aW9uIGdldEJsb2NrRW5kKGJsb2NrKSB7CiAgICByZXR1cm4gYmxvY2suY2xvbmVbYmxvY2suY2xvbmUubGVuZ3RoIC0gMV07CiAgfQp9XTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU2hvdwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ1Nob3dgIGRpcmVjdGl2ZSBzaG93cyBvciBoaWRlcyB0aGUgZ2l2ZW4gSFRNTCBlbGVtZW50IGJhc2VkIG9uIHRoZSBleHByZXNzaW9uCiAqIHByb3ZpZGVkIHRvIHRoZSBuZ1Nob3cgYXR0cmlidXRlLiBUaGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gYnkgcmVtb3Zpbmcgb3IgYWRkaW5nCiAqIHRoZSBgbmctaGlkZWAgQ1NTIGNsYXNzIG9udG8gdGhlIGVsZW1lbnQuIFRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcyBpcyBwcmVkZWZpbmVkCiAqIGluIEFuZ3VsYXJKUyBhbmQgc2V0cyB0aGUgZGlzcGxheSBzdHlsZSB0byBub25lICh1c2luZyBhbiAhaW1wb3J0YW50IGZsYWcpLgogKiBGb3IgQ1NQIG1vZGUgcGxlYXNlIGFkZCBgYW5ndWxhci1jc3AuY3NzYCB0byB5b3VyIGh0bWwgZmlsZSAoc2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDc3AgbmdDc3B9KS4KICoKICogYGBgaHRtbAogKiA8IS0tIHdoZW4gJHNjb3BlLm15VmFsdWUgaXMgdHJ1dGh5IChlbGVtZW50IGlzIHZpc2libGUpIC0tPgogKiA8ZGl2IG5nLXNob3c9Im15VmFsdWUiPjwvZGl2PgogKgogKiA8IS0tIHdoZW4gJHNjb3BlLm15VmFsdWUgaXMgZmFsc3kgKGVsZW1lbnQgaXMgaGlkZGVuKSAtLT4KICogPGRpdiBuZy1zaG93PSJteVZhbHVlIiBjbGFzcz0ibmctaGlkZSI+PC9kaXY+CiAqIGBgYAogKgogKiBXaGVuIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gZmFsc2UgdGhlbiB0aGUgbmctaGlkZSBDU1MgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGNsYXNzIGF0dHJpYnV0ZQogKiBvbiB0aGUgZWxlbWVudCBjYXVzaW5nIGl0IHRvIGJlY29tZSBoaWRkZW4uIFdoZW4gdHJ1ZSwgdGhlIG5nLWhpZGUgQ1NTIGNsYXNzIGlzIHJlbW92ZWQKICogZnJvbSB0aGUgZWxlbWVudCBjYXVzaW5nIHRoZSBlbGVtZW50IG5vdCB0byBhcHBlYXIgaGlkZGVuLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIEhlcmUgaXMgYSBsaXN0IG9mIHZhbHVlcyB0aGF0IG5nU2hvdyB3aWxsIGNvbnNpZGVyIGFzIGEgZmFsc3kgdmFsdWUgKGNhc2UgaW5zZW5zaXRpdmUpOjxiciAvPgogKiAiZiIgLyAiMCIgLyAiZmFsc2UiIC8gIm5vIiAvICJuIiAvICJbXSIKICogPC9kaXY+CiAqCiAqICMjIFdoeSBpcyAhaW1wb3J0YW50IHVzZWQ/CiAqCiAqIFlvdSBtYXkgYmUgd29uZGVyaW5nIHdoeSAhaW1wb3J0YW50IGlzIHVzZWQgZm9yIHRoZSAubmctaGlkZSBDU1MgY2xhc3MuIFRoaXMgaXMgYmVjYXVzZSB0aGUgYC5uZy1oaWRlYCBzZWxlY3RvcgogKiBjYW4gYmUgZWFzaWx5IG92ZXJyaWRkZW4gYnkgaGVhdmllciBzZWxlY3RvcnMuIEZvciBleGFtcGxlLCBzb21ldGhpbmcgYXMgc2ltcGxlCiAqIGFzIGNoYW5naW5nIHRoZSBkaXNwbGF5IHN0eWxlIG9uIGEgSFRNTCBsaXN0IGl0ZW0gd291bGQgbWFrZSBoaWRkZW4gZWxlbWVudHMgYXBwZWFyIHZpc2libGUuCiAqIFRoaXMgYWxzbyBiZWNvbWVzIGEgYmlnZ2VyIGlzc3VlIHdoZW4gZGVhbGluZyB3aXRoIENTUyBmcmFtZXdvcmtzLgogKgogKiBCeSB1c2luZyAhaW1wb3J0YW50LCB0aGUgc2hvdyBhbmQgaGlkZSBiZWhhdmlvciB3aWxsIHdvcmsgYXMgZXhwZWN0ZWQgZGVzcGl0ZSBhbnkgY2xhc2ggYmV0d2VlbiBDU1Mgc2VsZWN0b3IKICogc3BlY2lmaWNpdHkgKHdoZW4gIWltcG9ydGFudCBpc24ndCB1c2VkIHdpdGggYW55IGNvbmZsaWN0aW5nIHN0eWxlcykuIElmIGEgZGV2ZWxvcGVyIGNob29zZXMgdG8gb3ZlcnJpZGUgdGhlCiAqIHN0eWxpbmcgdG8gY2hhbmdlIGhvdyB0byBoaWRlIGFuIGVsZW1lbnQgdGhlbiBpdCBpcyBqdXN0IGEgbWF0dGVyIG9mIHVzaW5nICFpbXBvcnRhbnQgaW4gdGhlaXIgb3duIENTUyBjb2RlLgogKgogKiAjIyMgT3ZlcnJpZGluZyAubmctaGlkZQogKgogKiBCeSBkZWZhdWx0LCB0aGUgYC5uZy1oaWRlYCBjbGFzcyB3aWxsIHN0eWxlIHRoZSBlbGVtZW50IHdpdGggYGRpc3BsYXk6bm9uZSFpbXBvcnRhbnRgLiBJZiB5b3Ugd2lzaCB0byBjaGFuZ2UKICogdGhlIGhpZGUgYmVoYXZpb3Igd2l0aCBuZ1Nob3cvbmdIaWRlIHRoZW4gdGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkgcmVzdGF0aW5nIHRoZSBzdHlsZXMgZm9yIHRoZSBgLm5nLWhpZGVgCiAqIGNsYXNzIGluIENTUzoKICoKICogYGBgY3NzCiAqIC5uZy1oaWRlIHsKICogICAvL3RoaXMgaXMganVzdCBhbm90aGVyIGZvcm0gb2YgaGlkaW5nIGFuIGVsZW1lbnQKICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICogICBwb3NpdGlvbjphYnNvbHV0ZTsKICogICB0b3A6LTk5OTlweDsKICogICBsZWZ0Oi05OTk5cHg7CiAqIH0KICogYGBgCiAqCiAqIEJ5IGRlZmF1bHQgeW91IGRvbid0IG5lZWQgdG8gb3ZlcnJpZGUgaW4gQ1NTIGFueXRoaW5nIGFuZCB0aGUgYW5pbWF0aW9ucyB3aWxsIHdvcmsgYXJvdW5kIHRoZSBkaXNwbGF5IHN0eWxlLgogKgogKiAjIyBBIG5vdGUgYWJvdXQgYW5pbWF0aW9ucyB3aXRoIG5nU2hvdwogKgogKiBBbmltYXRpb25zIGluIG5nU2hvdy9uZ0hpZGUgd29yayB3aXRoIHRoZSBzaG93IGFuZCBoaWRlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgZGlyZWN0aXZlIGV4cHJlc3Npb24KICogaXMgdHJ1ZSBhbmQgZmFsc2UuIFRoaXMgc3lzdGVtIHdvcmtzIGxpa2UgdGhlIGFuaW1hdGlvbiBzeXN0ZW0gcHJlc2VudCB3aXRoIG5nQ2xhc3MgZXhjZXB0IHRoYXQKICogeW91IG11c3QgYWxzbyBpbmNsdWRlIHRoZSAhaW1wb3J0YW50IGZsYWcgdG8gb3ZlcnJpZGUgdGhlIGRpc3BsYXkgcHJvcGVydHkKICogc28gdGhhdCB5b3UgY2FuIHBlcmZvcm0gYW4gYW5pbWF0aW9uIHdoZW4gdGhlIGVsZW1lbnQgaXMgaGlkZGVuIGR1cmluZyB0aGUgdGltZSBvZiB0aGUgYW5pbWF0aW9uLgogKgogKiBgYGBjc3MKICogLy8KICogLy9hIHdvcmtpbmcgZXhhbXBsZSBjYW4gYmUgZm91bmQgYXQgdGhlIGJvdHRvbSBvZiB0aGlzIHBhZ2UKICogLy8KICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQsIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogfQogKgogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLm5nLWhpZGUtYWRkLWFjdGl2ZSB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsgLi4uIH0KICogYGBgCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0LCBhcyBvZiBBbmd1bGFySlMgdmVyc2lvbiAxLjIuMTcgKGFuZCAxLjMuMC1iZXRhLjExKSwgdGhlcmUgaXMgbm8gbmVlZCB0byBjaGFuZ2UgdGhlIGRpc3BsYXkKICogcHJvcGVydHkgdG8gYmxvY2sgZHVyaW5nIGFuaW1hdGlvbiBzdGF0ZXMtLW5nQW5pbWF0ZSB3aWxsIGhhbmRsZSB0aGUgc3R5bGUgdG9nZ2xpbmcgYXV0b21hdGljYWxseSBmb3IgeW91LgogKgogKiBAYW5pbWF0aW9ucwogKiBhZGRDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgYW5kIHRoZSBqdXN0IGJlZm9yZSBjb250ZW50cyBhcmUgc2V0IHRvIHZpc2libGUKICogcmVtb3ZlQ2xhc3M6IC5uZy1oaWRlIC0gaGFwcGVucyBhZnRlciB0aGUgbmdTaG93IGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgbm9uIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gaGlkZGVuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU2hvdyBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5CiAqICAgICB0aGVuIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgIDxkaXY+CiAgICAgICAgU2hvdzoKICAgICAgICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtc2hvdyIgbmctc2hvdz0iY2hlY2tlZCI+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi10aHVtYnMtdXAiPjwvc3Bhbj4gSSBzaG93IHVwIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdj4KICAgICAgICBIaWRlOgogICAgICAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1zaG93IiBuZy1oaWRlPSJjaGVja2VkIj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXRodW1icy1kb3duIj48L3NwYW4+IEkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJnbHlwaGljb25zLmNzcyI+CiAgICAgIEBpbXBvcnQgdXJsKC8vbmV0ZG5hLmJvb3RzdHJhcGNkbi5jb20vYm9vdHN0cmFwLzMuMC4wL2Nzcy9ib290c3RyYXAtZ2x5cGhpY29ucy5jc3MpOwogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuYW5pbWF0ZS1zaG93IHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIGxpbmUtaGVpZ2h0OjIwcHg7CiAgICAgICAgb3BhY2l0eToxOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLXNob3cubmctaGlkZSB7CiAgICAgICAgbGluZS1oZWlnaHQ6MDsKICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgcGFkZGluZzowIDEwcHg7CiAgICAgIH0KCiAgICAgIC5jaGVjay1lbGVtZW50IHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICB9CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHRodW1ic1VwID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZ2x5cGhpY29uLXRodW1icy11cCcpKTsKICAgICAgdmFyIHRodW1ic0Rvd24gPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLWRvd24nKSk7CgogICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHRodW1ic1VwLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVUcnV0aHkoKTsKCiAgICAgICAgZWxlbWVudChieS5tb2RlbCgnY2hlY2tlZCcpKS5jbGljaygpOwoKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICB9KTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdTaG93RGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1Nob3csIGZ1bmN0aW9uIG5nU2hvd1dhdGNoQWN0aW9uKHZhbHVlKXsKICAgICAgJGFuaW1hdGVbdG9Cb29sZWFuKHZhbHVlKSA/ICdyZW1vdmVDbGFzcycgOiAnYWRkQ2xhc3MnXShlbGVtZW50LCAnbmctaGlkZScpOwogICAgfSk7CiAgfTsKfV07CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdIaWRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nSGlkZWAgZGlyZWN0aXZlIHNob3dzIG9yIGhpZGVzIHRoZSBnaXZlbiBIVE1MIGVsZW1lbnQgYmFzZWQgb24gdGhlIGV4cHJlc3Npb24KICogcHJvdmlkZWQgdG8gdGhlIG5nSGlkZSBhdHRyaWJ1dGUuIFRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiBieSByZW1vdmluZyBvciBhZGRpbmcKICogdGhlIGBuZy1oaWRlYCBDU1MgY2xhc3Mgb250byB0aGUgZWxlbWVudC4gVGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzIGlzIHByZWRlZmluZWQKICogaW4gQW5ndWxhckpTIGFuZCBzZXRzIHRoZSBkaXNwbGF5IHN0eWxlIHRvIG5vbmUgKHVzaW5nIGFuICFpbXBvcnRhbnQgZmxhZykuCiAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogKgogKiBgYGBodG1sCiAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyB0cnV0aHkgKGVsZW1lbnQgaXMgaGlkZGVuKSAtLT4KICogPGRpdiBuZy1oaWRlPSJteVZhbHVlIiBjbGFzcz0ibmctaGlkZSI+PC9kaXY+CiAqCiAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyB2aXNpYmxlKSAtLT4KICogPGRpdiBuZy1oaWRlPSJteVZhbHVlIj48L2Rpdj4KICogYGBgCiAqCiAqIFdoZW4gdGhlIG5nSGlkZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlIHRoZW4gdGhlIC5uZy1oaWRlIENTUyBjbGFzcyBpcyBhZGRlZCB0byB0aGUgY2xhc3MgYXR0cmlidXRlCiAqIG9uIHRoZSBlbGVtZW50IGNhdXNpbmcgaXQgdG8gYmVjb21lIGhpZGRlbi4gV2hlbiBmYWxzZSwgdGhlIG5nLWhpZGUgQ1NTIGNsYXNzIGlzIHJlbW92ZWQKICogZnJvbSB0aGUgZWxlbWVudCBjYXVzaW5nIHRoZSBlbGVtZW50IG5vdCB0byBhcHBlYXIgaGlkZGVuLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIEhlcmUgaXMgYSBsaXN0IG9mIHZhbHVlcyB0aGF0IG5nSGlkZSB3aWxsIGNvbnNpZGVyIGFzIGEgZmFsc3kgdmFsdWUgKGNhc2UgaW5zZW5zaXRpdmUpOjxiciAvPgogKiAiZiIgLyAiMCIgLyAiZmFsc2UiIC8gIm5vIiAvICJuIiAvICJbXSIKICogPC9kaXY+CiAqCiAqICMjIFdoeSBpcyAhaW1wb3J0YW50IHVzZWQ/CiAqCiAqIFlvdSBtYXkgYmUgd29uZGVyaW5nIHdoeSAhaW1wb3J0YW50IGlzIHVzZWQgZm9yIHRoZSAubmctaGlkZSBDU1MgY2xhc3MuIFRoaXMgaXMgYmVjYXVzZSB0aGUgYC5uZy1oaWRlYCBzZWxlY3RvcgogKiBjYW4gYmUgZWFzaWx5IG92ZXJyaWRkZW4gYnkgaGVhdmllciBzZWxlY3RvcnMuIEZvciBleGFtcGxlLCBzb21ldGhpbmcgYXMgc2ltcGxlCiAqIGFzIGNoYW5naW5nIHRoZSBkaXNwbGF5IHN0eWxlIG9uIGEgSFRNTCBsaXN0IGl0ZW0gd291bGQgbWFrZSBoaWRkZW4gZWxlbWVudHMgYXBwZWFyIHZpc2libGUuCiAqIFRoaXMgYWxzbyBiZWNvbWVzIGEgYmlnZ2VyIGlzc3VlIHdoZW4gZGVhbGluZyB3aXRoIENTUyBmcmFtZXdvcmtzLgogKgogKiBCeSB1c2luZyAhaW1wb3J0YW50LCB0aGUgc2hvdyBhbmQgaGlkZSBiZWhhdmlvciB3aWxsIHdvcmsgYXMgZXhwZWN0ZWQgZGVzcGl0ZSBhbnkgY2xhc2ggYmV0d2VlbiBDU1Mgc2VsZWN0b3IKICogc3BlY2lmaWNpdHkgKHdoZW4gIWltcG9ydGFudCBpc24ndCB1c2VkIHdpdGggYW55IGNvbmZsaWN0aW5nIHN0eWxlcykuIElmIGEgZGV2ZWxvcGVyIGNob29zZXMgdG8gb3ZlcnJpZGUgdGhlCiAqIHN0eWxpbmcgdG8gY2hhbmdlIGhvdyB0byBoaWRlIGFuIGVsZW1lbnQgdGhlbiBpdCBpcyBqdXN0IGEgbWF0dGVyIG9mIHVzaW5nICFpbXBvcnRhbnQgaW4gdGhlaXIgb3duIENTUyBjb2RlLgogKgogKiAjIyMgT3ZlcnJpZGluZyAubmctaGlkZQogKgogKiBCeSBkZWZhdWx0LCB0aGUgYC5uZy1oaWRlYCBjbGFzcyB3aWxsIHN0eWxlIHRoZSBlbGVtZW50IHdpdGggYGRpc3BsYXk6bm9uZSFpbXBvcnRhbnRgLiBJZiB5b3Ugd2lzaCB0byBjaGFuZ2UKICogdGhlIGhpZGUgYmVoYXZpb3Igd2l0aCBuZ1Nob3cvbmdIaWRlIHRoZW4gdGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkgcmVzdGF0aW5nIHRoZSBzdHlsZXMgZm9yIHRoZSBgLm5nLWhpZGVgCiAqIGNsYXNzIGluIENTUzoKICoKICogYGBgY3NzCiAqIC5uZy1oaWRlIHsKICogICAvL3RoaXMgaXMganVzdCBhbm90aGVyIGZvcm0gb2YgaGlkaW5nIGFuIGVsZW1lbnQKICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICogICBwb3NpdGlvbjphYnNvbHV0ZTsKICogICB0b3A6LTk5OTlweDsKICogICBsZWZ0Oi05OTk5cHg7CiAqIH0KICogYGBgCiAqCiAqIEJ5IGRlZmF1bHQgeW91IGRvbid0IG5lZWQgdG8gb3ZlcnJpZGUgaW4gQ1NTIGFueXRoaW5nIGFuZCB0aGUgYW5pbWF0aW9ucyB3aWxsIHdvcmsgYXJvdW5kIHRoZSBkaXNwbGF5IHN0eWxlLgogKgogKiAjIyBBIG5vdGUgYWJvdXQgYW5pbWF0aW9ucyB3aXRoIG5nSGlkZQogKgogKiBBbmltYXRpb25zIGluIG5nU2hvdy9uZ0hpZGUgd29yayB3aXRoIHRoZSBzaG93IGFuZCBoaWRlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgZGlyZWN0aXZlIGV4cHJlc3Npb24KICogaXMgdHJ1ZSBhbmQgZmFsc2UuIFRoaXMgc3lzdGVtIHdvcmtzIGxpa2UgdGhlIGFuaW1hdGlvbiBzeXN0ZW0gcHJlc2VudCB3aXRoIG5nQ2xhc3MsIGV4Y2VwdCB0aGF0IHRoZSBgLm5nLWhpZGVgCiAqIENTUyBjbGFzcyBpcyBhZGRlZCBhbmQgcmVtb3ZlZCBmb3IgeW91IGluc3RlYWQgb2YgeW91ciBvd24gQ1NTIGNsYXNzLgogKgogKiBgYGBjc3MKICogLy8KICogLy9hIHdvcmtpbmcgZXhhbXBsZSBjYW4gYmUgZm91bmQgYXQgdGhlIGJvdHRvbSBvZiB0aGlzIHBhZ2UKICogLy8KICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQsIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogfQogKgogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLm5nLWhpZGUtYWRkLWFjdGl2ZSB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsgLi4uIH0KICogYGBgCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0LCBhcyBvZiBBbmd1bGFySlMgdmVyc2lvbiAxLjIuMTcgKGFuZCAxLjMuMC1iZXRhLjExKSwgdGhlcmUgaXMgbm8gbmVlZCB0byBjaGFuZ2UgdGhlIGRpc3BsYXkKICogcHJvcGVydHkgdG8gYmxvY2sgZHVyaW5nIGFuaW1hdGlvbiBzdGF0ZXMtLW5nQW5pbWF0ZSB3aWxsIGhhbmRsZSB0aGUgc3R5bGUgdG9nZ2xpbmcgYXV0b21hdGljYWxseSBmb3IgeW91LgogKgogKiBAYW5pbWF0aW9ucwogKiByZW1vdmVDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ0hpZGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgYW5kIGp1c3QgYmVmb3JlIHRoZSBjb250ZW50cyBhcmUgc2V0IHRvIGhpZGRlbgogKiBhZGRDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ0hpZGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBub24gdHJ1dGh5IHZhbHVlIGFuZCBqdXN0IGJlZm9yZSB0aGUgY29udGVudHMgYXJlIHNldCB0byB2aXNpYmxlCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSGlkZSBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5IHRoZW4KICogICAgIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgIDxkaXY+CiAgICAgICAgU2hvdzoKICAgICAgICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtaGlkZSIgbmctc2hvdz0iY2hlY2tlZCI+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi10aHVtYnMtdXAiPjwvc3Bhbj4gSSBzaG93IHVwIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdj4KICAgICAgICBIaWRlOgogICAgICAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1oaWRlIiBuZy1oaWRlPSJjaGVja2VkIj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXRodW1icy1kb3duIj48L3NwYW4+IEkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJnbHlwaGljb25zLmNzcyI+CiAgICAgIEBpbXBvcnQgdXJsKC8vbmV0ZG5hLmJvb3RzdHJhcGNkbi5jb20vYm9vdHN0cmFwLzMuMC4wL2Nzcy9ib290c3RyYXAtZ2x5cGhpY29ucy5jc3MpOwogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuYW5pbWF0ZS1oaWRlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIGxpbmUtaGVpZ2h0OjIwcHg7CiAgICAgICAgb3BhY2l0eToxOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLWhpZGUubmctaGlkZSB7CiAgICAgICAgbGluZS1oZWlnaHQ6MDsKICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgcGFkZGluZzowIDEwcHg7CiAgICAgIH0KCiAgICAgIC5jaGVjay1lbGVtZW50IHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICB9CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHRodW1ic1VwID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZ2x5cGhpY29uLXRodW1icy11cCcpKTsKICAgICAgdmFyIHRodW1ic0Rvd24gPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLWRvd24nKSk7CgogICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHRodW1ic1VwLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVUcnV0aHkoKTsKCiAgICAgICAgZWxlbWVudChieS5tb2RlbCgnY2hlY2tlZCcpKS5jbGljaygpOwoKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICB9KTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdIaWRlRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0hpZGUsIGZ1bmN0aW9uIG5nSGlkZVdhdGNoQWN0aW9uKHZhbHVlKXsKICAgICAgJGFuaW1hdGVbdG9Cb29sZWFuKHZhbHVlKSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnXShlbGVtZW50LCAnbmctaGlkZScpOwogICAgfSk7CiAgfTsKfV07CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1N0eWxlCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ1N0eWxlYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzZXQgQ1NTIHN0eWxlIG9uIGFuIEhUTUwgZWxlbWVudCBjb25kaXRpb25hbGx5LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1N0eWxlCiAqCiAqIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHdoaWNoIGV2YWxzIHRvIGFuCiAqIG9iamVjdCB3aG9zZSBrZXlzIGFyZSBDU1Mgc3R5bGUgbmFtZXMgYW5kIHZhbHVlcyBhcmUgY29ycmVzcG9uZGluZyB2YWx1ZXMgZm9yIHRob3NlIENTUwogKiBrZXlzLgogKgogKiBTaW5jZSBzb21lIENTUyBzdHlsZSBuYW1lcyBhcmUgbm90IHZhbGlkIGtleXMgZm9yIGFuIG9iamVjdCwgdGhleSBtdXN0IGJlIHF1b3RlZC4KICogU2VlIHRoZSAnYmFja2dyb3VuZC1jb2xvcicgc3R5bGUgaW4gdGhlIGV4YW1wbGUgYmVsb3cuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQgY29sb3IiIG5nLWNsaWNrPSJteVN0eWxlPXtjb2xvcjoncmVkJ30iPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQgYmFja2dyb3VuZCIgbmctY2xpY2s9Im15U3R5bGU9eydiYWNrZ3JvdW5kLWNvbG9yJzonYmx1ZSd9Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVN0eWxlPXt9Ij4KICAgICAgICA8YnIvPgogICAgICAgIDxzcGFuIG5nLXN0eWxlPSJteVN0eWxlIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgICAgICA8cHJlPm15U3R5bGU9e3tteVN0eWxlfX08L3ByZT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgIHNwYW4gewogICAgICAgICBjb2xvcjogYmxhY2s7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgdmFyIGNvbG9yU3BhbiA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuJykpOwoKICAgICAgIGlpdCgnc2hvdWxkIGNoZWNrIG5nLXN0eWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChjb2xvclNwYW4uZ2V0Q3NzVmFsdWUoJ2NvbG9yJykpLnRvQmUoJ3JnYmEoMCwgMCwgMCwgMSknKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJ2lucHV0W3ZhbHVlPVwnc2V0IGNvbG9yXCddJykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChjb2xvclNwYW4uZ2V0Q3NzVmFsdWUoJ2NvbG9yJykpLnRvQmUoJ3JnYmEoMjU1LCAwLCAwLCAxKScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnaW5wdXRbdmFsdWU9Y2xlYXJdJykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChjb2xvclNwYW4uZ2V0Q3NzVmFsdWUoJ2NvbG9yJykpLnRvQmUoJ3JnYmEoMCwgMCwgMCwgMSknKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KdmFyIG5nU3R5bGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogIHNjb3BlLiR3YXRjaChhdHRyLm5nU3R5bGUsIGZ1bmN0aW9uIG5nU3R5bGVXYXRjaEFjdGlvbihuZXdTdHlsZXMsIG9sZFN0eWxlcykgewogICAgaWYgKG9sZFN0eWxlcyAmJiAobmV3U3R5bGVzICE9PSBvbGRTdHlsZXMpKSB7CiAgICAgIGZvckVhY2gob2xkU3R5bGVzLCBmdW5jdGlvbih2YWwsIHN0eWxlKSB7IGVsZW1lbnQuY3NzKHN0eWxlLCAnJyk7fSk7CiAgICB9CiAgICBpZiAobmV3U3R5bGVzKSBlbGVtZW50LmNzcyhuZXdTdHlsZXMpOwogIH0sIHRydWUpOwp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU3dpdGNoCiAqIEByZXN0cmljdCBFQQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ1N3aXRjaGAgZGlyZWN0aXZlIGlzIHVzZWQgdG8gY29uZGl0aW9uYWxseSBzd2FwIERPTSBzdHJ1Y3R1cmUgb24geW91ciB0ZW1wbGF0ZSBiYXNlZCBvbiBhIHNjb3BlIGV4cHJlc3Npb24uCiAqIEVsZW1lbnRzIHdpdGhpbiBgbmdTd2l0Y2hgIGJ1dCB3aXRob3V0IGBuZ1N3aXRjaFdoZW5gIG9yIGBuZ1N3aXRjaERlZmF1bHRgIGRpcmVjdGl2ZXMgd2lsbCBiZSBwcmVzZXJ2ZWQgYXQgdGhlIGxvY2F0aW9uCiAqIGFzIHNwZWNpZmllZCBpbiB0aGUgdGVtcGxhdGUuCiAqCiAqIFRoZSBkaXJlY3RpdmUgaXRzZWxmIHdvcmtzIHNpbWlsYXIgdG8gbmdJbmNsdWRlLCBob3dldmVyLCBpbnN0ZWFkIG9mIGRvd25sb2FkaW5nIHRlbXBsYXRlIGNvZGUgKG9yIGxvYWRpbmcgaXQKICogZnJvbSB0aGUgdGVtcGxhdGUgY2FjaGUpLCBgbmdTd2l0Y2hgIHNpbXBseSBjaG9vc2VzIG9uZSBvZiB0aGUgbmVzdGVkIGVsZW1lbnRzIGFuZCBtYWtlcyBpdCB2aXNpYmxlIGJhc2VkIG9uIHdoaWNoIGVsZW1lbnQKICogbWF0Y2hlcyB0aGUgdmFsdWUgb2J0YWluZWQgZnJvbSB0aGUgZXZhbHVhdGVkIGV4cHJlc3Npb24uIEluIG90aGVyIHdvcmRzLCB5b3UgZGVmaW5lIGEgY29udGFpbmVyIGVsZW1lbnQKICogKHdoZXJlIHlvdSBwbGFjZSB0aGUgZGlyZWN0aXZlKSwgcGxhY2UgYW4gZXhwcmVzc2lvbiBvbiB0aGUgKipgb249Ii4uLiJgIGF0dHJpYnV0ZSoqCiAqIChvciB0aGUgKipgbmctc3dpdGNoPSIuLi4iYCBhdHRyaWJ1dGUqKiksIGRlZmluZSBhbnkgaW5uZXIgZWxlbWVudHMgaW5zaWRlIG9mIHRoZSBkaXJlY3RpdmUgYW5kIHBsYWNlCiAqIGEgd2hlbiBhdHRyaWJ1dGUgcGVyIGVsZW1lbnQuIFRoZSB3aGVuIGF0dHJpYnV0ZSBpcyB1c2VkIHRvIGluZm9ybSBuZ1N3aXRjaCB3aGljaCBlbGVtZW50IHRvIGRpc3BsYXkgd2hlbiB0aGUgb24KICogZXhwcmVzc2lvbiBpcyBldmFsdWF0ZWQuIElmIGEgbWF0Y2hpbmcgZXhwcmVzc2lvbiBpcyBub3QgZm91bmQgdmlhIGEgd2hlbiBhdHRyaWJ1dGUgdGhlbiBhbiBlbGVtZW50IHdpdGggdGhlIGRlZmF1bHQKICogYXR0cmlidXRlIGlzIGRpc3BsYXllZC4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtaW5mbyI+CiAqIEJlIGF3YXJlIHRoYXQgdGhlIGF0dHJpYnV0ZSB2YWx1ZXMgdG8gbWF0Y2ggYWdhaW5zdCBjYW5ub3QgYmUgZXhwcmVzc2lvbnMuIFRoZXkgYXJlIGludGVycHJldGVkCiAqIGFzIGxpdGVyYWwgc3RyaW5nIHZhbHVlcyB0byBtYXRjaCBhZ2FpbnN0LgogKiBGb3IgZXhhbXBsZSwgKipgbmctc3dpdGNoLXdoZW49InNvbWVWYWwiYCoqIHdpbGwgbWF0Y2ggYWdhaW5zdCB0aGUgc3RyaW5nIGAic29tZVZhbCJgIG5vdCBhZ2FpbnN0IHRoZQogKiB2YWx1ZSBvZiB0aGUgZXhwcmVzc2lvbiBgJHNjb3BlLnNvbWVWYWxgLgogKiA8L2Rpdj4KCiAqIEBhbmltYXRpb25zCiAqIGVudGVyIC0gaGFwcGVucyBhZnRlciB0aGUgbmdTd2l0Y2ggY29udGVudHMgY2hhbmdlIGFuZCB0aGUgbWF0Y2hlZCBjaGlsZCBlbGVtZW50IGlzIHBsYWNlZCBpbnNpZGUgdGhlIGNvbnRhaW5lcgogKiBsZWF2ZSAtIGhhcHBlbnMganVzdCBhZnRlciB0aGUgbmdTd2l0Y2ggY29udGVudHMgY2hhbmdlIGFuZCBqdXN0IGJlZm9yZSB0aGUgZm9ybWVyIGNvbnRlbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTQogKgogKiBAdXNhZ2UKICoKICogYGBgCiAqIDxBTlkgbmctc3dpdGNoPSJleHByZXNzaW9uIj4KICogICA8QU5ZIG5nLXN3aXRjaC13aGVuPSJtYXRjaFZhbHVlMSI+Li4uPC9BTlk+CiAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTIiPi4uLjwvQU5ZPgogKiAgIDxBTlkgbmctc3dpdGNoLWRlZmF1bHQ+Li4uPC9BTlk+CiAqIDwvQU5ZPgogKiBgYGAKICoKICoKICogQHNjb3BlCiAqIEBwcmlvcml0eSA4MDAKICogQHBhcmFtIHsqfSBuZ1N3aXRjaHxvbiBleHByZXNzaW9uIHRvIG1hdGNoIGFnYWluc3QgPHR0Pm5nLXN3aXRjaC13aGVuPC90dD4uCiAqIE9uIGNoaWxkIGVsZW1lbnRzIGFkZDoKICoKICogKiBgbmdTd2l0Y2hXaGVuYDogdGhlIGNhc2Ugc3RhdGVtZW50IHRvIG1hdGNoIGFnYWluc3QuIElmIG1hdGNoIHRoZW4gdGhpcwogKiAgIGNhc2Ugd2lsbCBiZSBkaXNwbGF5ZWQuIElmIHRoZSBzYW1lIG1hdGNoIGFwcGVhcnMgbXVsdGlwbGUgdGltZXMsIGFsbCB0aGUKICogICBlbGVtZW50cyB3aWxsIGJlIGRpc3BsYXllZC4KICogKiBgbmdTd2l0Y2hEZWZhdWx0YDogdGhlIGRlZmF1bHQgY2FzZSB3aGVuIG5vIG90aGVyIGNhc2UgbWF0Y2guIElmIHRoZXJlCiAqICAgYXJlIG11bHRpcGxlIGRlZmF1bHQgY2FzZXMsIGFsbCBvZiB0aGVtIHdpbGwgYmUgZGlzcGxheWVkIHdoZW4gbm8gb3RoZXIKICogICBjYXNlIG1hdGNoLgogKgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ic2VsZWN0aW9uIiBuZy1vcHRpb25zPSJpdGVtIGZvciBpdGVtIGluIGl0ZW1zIj4KICAgICAgICA8L3NlbGVjdD4KICAgICAgICA8dHQ+c2VsZWN0aW9uPXt7c2VsZWN0aW9ufX08L3R0PgogICAgICAgIDxoci8+CiAgICAgICAgPGRpdiBjbGFzcz0iYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyIgogICAgICAgICAgbmctc3dpdGNoIG9uPSJzZWxlY3Rpb24iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaCIgbmctc3dpdGNoLXdoZW49InNldHRpbmdzIj5TZXR0aW5ncyBEaXY8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iYW5pbWF0ZS1zd2l0Y2giIG5nLXN3aXRjaC13aGVuPSJob21lIj5Ib21lIFNwYW48L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iYW5pbWF0ZS1zd2l0Y2giIG5nLXN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS5pdGVtcyA9IFsnc2V0dGluZ3MnLCAnaG9tZScsICdvdGhlciddOwogICAgICAgICRzY29wZS5zZWxlY3Rpb24gPSAkc2NvcGUuaXRlbXNbMF07CiAgICAgIH0KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgLmFuaW1hdGUtc3dpdGNoLWNvbnRhaW5lciB7CiAgICAgICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGhlaWdodDo0MHB4OwogICAgICAgIG92ZXJmbG93OmhpZGRlbjsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtc3dpdGNoIHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1hbmltYXRlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CgogICAgICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgICAgIHRvcDowOwogICAgICAgIGxlZnQ6MDsKICAgICAgICByaWdodDowOwogICAgICAgIGJvdHRvbTowOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1zd2l0Y2gubmctbGVhdmUubmctbGVhdmUtYWN0aXZlLAogICAgICAuYW5pbWF0ZS1zd2l0Y2gubmctZW50ZXIgewogICAgICAgIHRvcDotNTBweDsKICAgICAgfQogICAgICAuYW5pbWF0ZS1zd2l0Y2gubmctbGVhdmUsCiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogICAgICAgIHRvcDowOwogICAgICB9CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHN3aXRjaEVsZW0gPSBlbGVtZW50KGJ5LmNzcygnW25nLXN3aXRjaF0nKSk7CiAgICAgIHZhciBzZWxlY3QgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzZWxlY3Rpb24nKSk7CgogICAgICBpdCgnc2hvdWxkIHN0YXJ0IGluIHNldHRpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHN3aXRjaEVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9TZXR0aW5ncyBEaXYvKTsKICAgICAgfSk7CiAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGhvbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZWxlY3QuZWxlbWVudC5hbGwoYnkuY3NzKCdvcHRpb24nKSkuZ2V0KDEpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KHN3aXRjaEVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9Ib21lIFNwYW4vKTsKICAgICAgfSk7CiAgICAgIGl0KCdzaG91bGQgc2VsZWN0IGRlZmF1bHQnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZWxlY3QuZWxlbWVudC5hbGwoYnkuY3NzKCdvcHRpb24nKSkuZ2V0KDIpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KHN3aXRjaEVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9kZWZhdWx0Lyk7CiAgICAgIH0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCnZhciBuZ1N3aXRjaERpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0VBJywKICAgIHJlcXVpcmU6ICduZ1N3aXRjaCcsCgogICAgLy8gYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCiAgICBjb250cm9sbGVyOiBbJyRzY29wZScsIGZ1bmN0aW9uIG5nU3dpdGNoQ29udHJvbGxlcigpIHsKICAgICB0aGlzLmNhc2VzID0ge307CiAgICB9XSwKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBuZ1N3aXRjaENvbnRyb2xsZXIpIHsKICAgICAgdmFyIHdhdGNoRXhwciA9IGF0dHIubmdTd2l0Y2ggfHwgYXR0ci5vbiwKICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZXMgPSBbXSwKICAgICAgICAgIHNlbGVjdGVkRWxlbWVudHMgPSBbXSwKICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMgPSBbXSwKICAgICAgICAgIHNlbGVjdGVkU2NvcGVzID0gW107CgogICAgICBzY29wZS4kd2F0Y2god2F0Y2hFeHByLCBmdW5jdGlvbiBuZ1N3aXRjaFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIGksIGlpOwogICAgICAgIGZvciAoaSA9IDAsIGlpID0gcHJldmlvdXNFbGVtZW50cy5sZW5ndGg7IGkgPCBpaTsgKytpKSB7CiAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzW2ldLnJlbW92ZSgpOwogICAgICAgIH0KICAgICAgICBwcmV2aW91c0VsZW1lbnRzLmxlbmd0aCA9IDA7CgogICAgICAgIGZvciAoaSA9IDAsIGlpID0gc2VsZWN0ZWRTY29wZXMubGVuZ3RoOyBpIDwgaWk7ICsraSkgewogICAgICAgICAgdmFyIHNlbGVjdGVkID0gc2VsZWN0ZWRFbGVtZW50c1tpXTsKICAgICAgICAgIHNlbGVjdGVkU2NvcGVzW2ldLiRkZXN0cm95KCk7CiAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzW2ldID0gc2VsZWN0ZWQ7CiAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShzZWxlY3RlZCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBzZWxlY3RlZEVsZW1lbnRzLmxlbmd0aCA9IDA7CiAgICAgICAgc2VsZWN0ZWRTY29wZXMubGVuZ3RoID0gMDsKCiAgICAgICAgaWYgKChzZWxlY3RlZFRyYW5zY2x1ZGVzID0gbmdTd2l0Y2hDb250cm9sbGVyLmNhc2VzWychJyArIHZhbHVlXSB8fCBuZ1N3aXRjaENvbnRyb2xsZXIuY2FzZXNbJz8nXSkpIHsKICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHIuY2hhbmdlKTsKICAgICAgICAgIGZvckVhY2goc2VsZWN0ZWRUcmFuc2NsdWRlcywgZnVuY3Rpb24oc2VsZWN0ZWRUcmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICBzZWxlY3RlZFNjb3Blcy5wdXNoKHNlbGVjdGVkU2NvcGUpOwogICAgICAgICAgICBzZWxlY3RlZFRyYW5zY2x1ZGUudHJhbnNjbHVkZShzZWxlY3RlZFNjb3BlLCBmdW5jdGlvbihjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBhbmNob3IgPSBzZWxlY3RlZFRyYW5zY2x1ZGUuZWxlbWVudDsKCiAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50cy5wdXNoKGNhc2VFbGVtZW50KTsKICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjYXNlRWxlbWVudCwgYW5jaG9yLnBhcmVudCgpLCBhbmNob3IpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKfV07Cgp2YXIgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICBwcmlvcml0eTogODAwLAogIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgIGN0cmwuY2FzZXNbJyEnICsgYXR0cnMubmdTd2l0Y2hXaGVuXSA9IChjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0gfHwgW10pOwogICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dLnB1c2goeyB0cmFuc2NsdWRlOiAkdHJhbnNjbHVkZSwgZWxlbWVudDogZWxlbWVudCB9KTsKICB9Cn0pOwoKdmFyIG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgcHJpb3JpdHk6IDgwMCwKICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgIGN0cmwuY2FzZXNbJz8nXSA9IChjdHJsLmNhc2VzWyc/J10gfHwgW10pOwogICAgY3RybC5jYXNlc1snPyddLnB1c2goeyB0cmFuc2NsdWRlOiAkdHJhbnNjbHVkZSwgZWxlbWVudDogZWxlbWVudCB9KTsKICAgfQp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nVHJhbnNjbHVkZQogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIERpcmVjdGl2ZSB0aGF0IG1hcmtzIHRoZSBpbnNlcnRpb24gcG9pbnQgZm9yIHRoZSB0cmFuc2NsdWRlZCBET00gb2YgdGhlIG5lYXJlc3QgcGFyZW50IGRpcmVjdGl2ZSB0aGF0IHVzZXMgdHJhbnNjbHVzaW9uLgogKgogKiBBbnkgZXhpc3RpbmcgY29udGVudCBvZiB0aGUgZWxlbWVudCB0aGF0IHRoaXMgZGlyZWN0aXZlIGlzIHBsYWNlZCBvbiB3aWxsIGJlIHJlbW92ZWQgYmVmb3JlIHRoZSB0cmFuc2NsdWRlZCBjb250ZW50IGlzIGluc2VydGVkLgogKgogKiBAZWxlbWVudCBBTlkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJ0cmFuc2NsdWRlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnRpdGxlID0gJ0xvcmVtIElwc3VtJzsKICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdOZXF1ZSBwb3JybyBxdWlzcXVhbSBlc3QgcXVpIGRvbG9yZW0gaXBzdW0gcXVpYSBkb2xvci4uLic7CiAgICAgICAgIH0KCiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCd0cmFuc2NsdWRlJywgW10pCiAgICAgICAgICAuZGlyZWN0aXZlKCdwYW5lJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgICAgICAgIHNjb3BlOiB7IHRpdGxlOidAJyB9LAogICAgICAgICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgc3R5bGU9ImJvcmRlcjogMXB4IHNvbGlkIGJsYWNrOyI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiBncmF5Ij57e3RpdGxlfX08L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgICAgICB9OwogICAgICAgICB9KTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJ0aXRsZSI+PGJyPgogICAgICAgICA8dGV4dGFyZWEgbmctbW9kZWw9InRleHQiPjwvdGV4dGFyZWE+IDxici8+CiAgICAgICAgIDxwYW5lIHRpdGxlPSJ7e3RpdGxlfX0iPnt7dGV4dH19PC9wYW5lPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgaGF2ZSB0cmFuc2NsdWRlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHRpdGxlRWxlbWVudCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RpdGxlJykpOwogICAgICAgICAgdGl0bGVFbGVtZW50LmNsZWFyKCk7CiAgICAgICAgICB0aXRsZUVsZW1lbnQuc2VuZEtleXMoJ1RJVExFJyk7CiAgICAgICAgICB2YXIgdGV4dEVsZW1lbnQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwogICAgICAgICAgdGV4dEVsZW1lbnQuY2xlYXIoKTsKICAgICAgICAgIHRleHRFbGVtZW50LnNlbmRLZXlzKCdURVhUJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd0aXRsZScpKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1RJVExFJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpLmdldFRleHQoKSkudG9FcXVhbCgnVEVYVCcpOwogICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKgogKi8KdmFyIG5nVHJhbnNjbHVkZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsIGNvbnRyb2xsZXIsICR0cmFuc2NsdWRlKSB7CiAgICBpZiAoISR0cmFuc2NsdWRlKSB7CiAgICAgIHRocm93IG1pbkVycignbmdUcmFuc2NsdWRlJykoJ29ycGhhbicsCiAgICAgICAnSWxsZWdhbCB1c2Ugb2YgbmdUcmFuc2NsdWRlIGRpcmVjdGl2ZSBpbiB0aGUgdGVtcGxhdGUhICcgKwogICAgICAgJ05vIHBhcmVudCBkaXJlY3RpdmUgdGhhdCByZXF1aXJlcyBhIHRyYW5zY2x1c2lvbiBmb3VuZC4gJyArCiAgICAgICAnRWxlbWVudDogezB9JywKICAgICAgIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICB9CgogICAgJHRyYW5zY2x1ZGUoZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgJGVsZW1lbnQuZW1wdHkoKTsKICAgICAgJGVsZW1lbnQuYXBwZW5kKGNsb25lKTsKICAgIH0pOwogIH0KfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBzY3JpcHQKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIExvYWQgdGhlIGNvbnRlbnQgb2YgYSBgPHNjcmlwdD5gIGVsZW1lbnQgaW50byB7QGxpbmsgbmcuJHRlbXBsYXRlQ2FjaGUgYCR0ZW1wbGF0ZUNhY2hlYH0sIHNvIHRoYXQgdGhlCiAqIHRlbXBsYXRlIGNhbiBiZSB1c2VkIGJ5IHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIGBuZ0luY2x1ZGVgfSwKICoge0BsaW5rIG5nUm91dGUuZGlyZWN0aXZlOm5nVmlldyBgbmdWaWV3YH0sIG9yIHtAbGluayBndWlkZS9kaXJlY3RpdmUgZGlyZWN0aXZlc30uIFRoZSB0eXBlIG9mIHRoZQogKiBgPHNjcmlwdD5gIGVsZW1lbnQgbXVzdCBiZSBzcGVjaWZpZWQgYXMgYHRleHQvbmctdGVtcGxhdGVgLCBhbmQgYSBjYWNoZSBuYW1lIGZvciB0aGUgdGVtcGxhdGUgbXVzdCBiZQogKiBhc3NpZ25lZCB0aHJvdWdoIHRoZSBlbGVtZW50J3MgYGlkYCwgd2hpY2ggY2FuIHRoZW4gYmUgdXNlZCBhcyBhIGRpcmVjdGl2ZSdzIGB0ZW1wbGF0ZVVybGAuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIE11c3QgYmUgc2V0IHRvIGAndGV4dC9uZy10ZW1wbGF0ZSdgLgogKiBAcGFyYW0ge3N0cmluZ30gaWQgQ2FjaGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUuCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGU+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0iL3RwbC5odG1sIj4KICAgICAgICBDb250ZW50IG9mIHRoZSB0ZW1wbGF0ZS4KICAgICAgPC9zY3JpcHQ+CgogICAgICA8YSBuZy1jbGljaz0iY3VycmVudFRwbD0nL3RwbC5odG1sJyIgaWQ9InRwbC1saW5rIj5Mb2FkIGlubGluZWQgdGVtcGxhdGU8L2E+CiAgICAgIDxkaXYgaWQ9InRwbC1jb250ZW50IiBuZy1pbmNsdWRlIHNyYz0iY3VycmVudFRwbCI+PC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlIGRlZmluZWQgaW5zaWRlIHNjcmlwdCB0YWcnLCBmdW5jdGlvbigpIHsKICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3RwbC1saW5rJykpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjdHBsLWNvbnRlbnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRoZSB0ZW1wbGF0ZS8pOwogICAgICB9KTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgc2NyaXB0RGlyZWN0aXZlID0gWyckdGVtcGxhdGVDYWNoZScsIGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgaWYgKGF0dHIudHlwZSA9PSAndGV4dC9uZy10ZW1wbGF0ZScpIHsKICAgICAgICB2YXIgdGVtcGxhdGVVcmwgPSBhdHRyLmlkLAogICAgICAgICAgICAvLyBJRSBpcyBub3QgY29uc2lzdGVudCwgaW4gc2NyaXB0cyB3ZSBoYXZlIHRvIHJlYWQgLnRleHQgYnV0IGluIG90aGVyIG5vZGVzIHdlIGhhdmUgdG8gcmVhZCAudGV4dENvbnRlbnQKICAgICAgICAgICAgdGV4dCA9IGVsZW1lbnRbMF0udGV4dDsKCiAgICAgICAgJHRlbXBsYXRlQ2FjaGUucHV0KHRlbXBsYXRlVXJsLCB0ZXh0KTsKICAgICAgfQogICAgfQogIH07Cn1dOwoKdmFyIG5nT3B0aW9uc01pbkVyciA9IG1pbkVycignbmdPcHRpb25zJyk7Ci8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIHNlbGVjdAogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogSFRNTCBgU0VMRUNUYCBlbGVtZW50IHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuCiAqCiAqICMgYG5nT3B0aW9uc2AKICoKICogVGhlIGBuZ09wdGlvbnNgIGF0dHJpYnV0ZSBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBnZW5lcmF0ZSBhIGxpc3Qgb2YgYDxvcHRpb24+YAogKiBlbGVtZW50cyBmb3IgdGhlIGA8c2VsZWN0PmAgZWxlbWVudCB1c2luZyB0aGUgYXJyYXkgb3Igb2JqZWN0IG9idGFpbmVkIGJ5IGV2YWx1YXRpbmcgdGhlCiAqIGBuZ09wdGlvbnNgIGNvbXByZWhlbnNpb25fZXhwcmVzc2lvbi4KICoKICogV2hlbiBhbiBpdGVtIGluIHRoZSBgPHNlbGVjdD5gIG1lbnUgaXMgc2VsZWN0ZWQsIHRoZSBhcnJheSBlbGVtZW50IG9yIG9iamVjdCBwcm9wZXJ0eQogKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuZ01vZGVsYAogKiBkaXJlY3RpdmUuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogYG5nTW9kZWxgIGNvbXBhcmVzIGJ5IHJlZmVyZW5jZSwgbm90IHZhbHVlLiBUaGlzIGlzIGltcG9ydGFudCB3aGVuIGJpbmRpbmcgdG8gYW4KICogYXJyYXkgb2Ygb2JqZWN0cy4gU2VlIGFuIGV4YW1wbGUgW2luIHRoaXMganNmaWRkbGVdKGh0dHA6Ly9qc2ZpZGRsZS5uZXQvcVd6VGIvKS4KICogPC9kaXY+CiAqCiAqIE9wdGlvbmFsbHksIGEgc2luZ2xlIGhhcmQtY29kZWQgYDxvcHRpb24+YCBlbGVtZW50LCB3aXRoIHRoZSB2YWx1ZSBzZXQgdG8gYW4gZW1wdHkgc3RyaW5nLCBjYW4KICogYmUgbmVzdGVkIGludG8gdGhlIGA8c2VsZWN0PmAgZWxlbWVudC4gVGhpcyBlbGVtZW50IHdpbGwgdGhlbiByZXByZXNlbnQgdGhlIGBudWxsYCBvciAibm90IHNlbGVjdGVkIgogKiBvcHRpb24uIFNlZSBleGFtcGxlIGJlbG93IGZvciBkZW1vbnN0cmF0aW9uLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIGBuZ09wdGlvbnNgIHByb3ZpZGVzIGFuIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciB0aGUgYDxvcHRpb24+YCBlbGVtZW50IHdoaWNoIHNob3VsZCBiZSB1c2VkIGluc3RlYWQKICogb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gd2hlbiB5b3Ugd2FudCB0aGUKICogYHNlbGVjdGAgbW9kZWwgdG8gYmUgYm91bmQgdG8gYSBub24tc3RyaW5nIHZhbHVlLiBUaGlzIGlzIGJlY2F1c2UgYW4gb3B0aW9uIGVsZW1lbnQgY2FuIG9ubHkKICogYmUgYm91bmQgdG8gc3RyaW5nIHZhbHVlcyBhdCBwcmVzZW50LgogKiA8L2Rpdj4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgVGhlIGNvbnRyb2wgaXMgY29uc2lkZXJlZCB2YWxpZCBvbmx5IGlmIHZhbHVlIGlzIGVudGVyZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICogQHBhcmFtIHtjb21wcmVoZW5zaW9uX2V4cHJlc3Npb249fSBuZ09wdGlvbnMgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgZm9ybXM6CiAqCiAqICAgKiBmb3IgYXJyYXkgZGF0YSBzb3VyY2VzOgogKiAgICAgKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAqICAgICAqIGBsYWJlbGAgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YCAqKmB0cmFjayBieWAqKiBgdHJhY2tleHByYAogKiAgICogZm9yIG9iamVjdCBkYXRhIHNvdXJjZXM6CiAqICAgICAqIGBsYWJlbGAgKipgZm9yIChgKipga2V5YCAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZm9yIChgKipga2V5YCAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqICAgICAqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3IgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAKICogICAgICAgICAqKmBmb3JgIGAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqCiAqIFdoZXJlOgogKgogKiAgICogYGFycmF5YCAvIGBvYmplY3RgOiBhbiBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBhcnJheSAvIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAqICAgKiBgdmFsdWVgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGVhY2ggaXRlbSBpbiB0aGUgYGFycmF5YCBvciBlYWNoIHByb3BlcnR5IHZhbHVlCiAqICAgICAgb2YgYG9iamVjdGAgZHVyaW5nIGl0ZXJhdGlvbi4KICogICAqIGBrZXlgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGEgcHJvcGVydHkgbmFtZSBpbiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogKiAgICogYGxhYmVsYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB0aGUgbGFiZWwgZm9yIGA8b3B0aW9uPmAgZWxlbWVudC4gVGhlCiAqICAgICBgZXhwcmVzc2lvbmAgd2lsbCBtb3N0IGxpa2VseSByZWZlciB0byB0aGUgYHZhbHVlYCB2YXJpYWJsZSAoZS5nLiBgdmFsdWUucHJvcGVydHlOYW1lYCkuCiAqICAgKiBgc2VsZWN0YDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgb2YgdGhlIHBhcmVudCBgPHNlbGVjdD5gCiAqICAgICAgZWxlbWVudC4gSWYgbm90IHNwZWNpZmllZCwgYHNlbGVjdGAgZXhwcmVzc2lvbiB3aWxsIGRlZmF1bHQgdG8gYHZhbHVlYC4KICogICAqIGBncm91cGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdXNlZCB0byBncm91cCBvcHRpb25zIHVzaW5nIHRoZSBgPG9wdGdyb3VwPmAKICogICAgICBET00gZWxlbWVudC4KICogICAqIGB0cmFja2V4cHJgOiBVc2VkIHdoZW4gd29ya2luZyB3aXRoIGFuIGFycmF5IG9mIG9iamVjdHMuIFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUKICogICAgICB1c2VkIHRvIGlkZW50aWZ5IHRoZSBvYmplY3RzIGluIHRoZSBhcnJheS4gVGhlIGB0cmFja2V4cHJgIHdpbGwgbW9zdCBsaWtlbHkgcmVmZXIgdG8gdGhlCiAqICAgICBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIE15Q250cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUuY29sb3JzID0gWwogICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZTond2hpdGUnLCBzaGFkZTonbGlnaHQnfSwKICAgICAgICAgICAge25hbWU6J3JlZCcsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J3llbGxvdycsIHNoYWRlOidsaWdodCd9CiAgICAgICAgICBdOwogICAgICAgICAgJHNjb3BlLm15Q29sb3IgPSAkc2NvcGUuY29sb3JzWzJdOyAvLyByZWQKICAgICAgICB9CiAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNeUNudHJsIj4KICAgICAgICAgIDx1bD4KICAgICAgICAgICAgPGxpIG5nLXJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgICAgICBOYW1lOiA8aW5wdXQgbmctbW9kZWw9ImNvbG9yLm5hbWUiPgogICAgICAgICAgICAgIFs8YSBocmVmIG5nLWNsaWNrPSJjb2xvcnMuc3BsaWNlKCRpbmRleCwgMSkiPlg8L2E+XQogICAgICAgICAgICA8L2xpPgogICAgICAgICAgICA8bGk+CiAgICAgICAgICAgICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5wdXNoKHt9KSI+YWRkPC9hPl0KICAgICAgICAgICAgPC9saT4KICAgICAgICAgIDwvdWw+CiAgICAgICAgICA8aHIvPgogICAgICAgICAgQ29sb3IgKG51bGwgbm90IGFsbG93ZWQpOgogICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ibXlDb2xvciIgbmctb3B0aW9ucz0iY29sb3IubmFtZSBmb3IgY29sb3IgaW4gY29sb3JzIj48L3NlbGVjdD48YnI+CgogICAgICAgICAgQ29sb3IgKG51bGwgYWxsb3dlZCk6CiAgICAgICAgICA8c3BhbiAgY2xhc3M9Im51bGxhYmxlIj4KICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ibXlDb2xvciIgbmctb3B0aW9ucz0iY29sb3IubmFtZSBmb3IgY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPi0tIGNob29zZSBjb2xvciAtLTwvb3B0aW9uPgogICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgIDwvc3Bhbj48YnIvPgoKICAgICAgICAgIENvbG9yIGdyb3VwZWQgYnkgc2hhZGU6CiAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJteUNvbG9yIiBuZy1vcHRpb25zPSJjb2xvci5uYW1lIGdyb3VwIGJ5IGNvbG9yLnNoYWRlIGZvciBjb2xvciBpbiBjb2xvcnMiPgogICAgICAgICAgPC9zZWxlY3Q+PGJyLz4KCgogICAgICAgICAgU2VsZWN0IDxhIGhyZWYgbmctY2xpY2s9Im15Q29sb3IgPSB7IG5hbWU6J25vdCBpbiBsaXN0Jywgc2hhZGU6ICdvdGhlcicgfSI+Ym9ndXM8L2E+Ljxicj4KICAgICAgICAgIDxoci8+CiAgICAgICAgICBDdXJyZW50bHkgc2VsZWN0ZWQ6IHt7IHtzZWxlY3RlZF9jb2xvcjpteUNvbG9yfSAgfX0KICAgICAgICAgIDxkaXYgc3R5bGU9ImJvcmRlcjpzb2xpZCAxcHggYmxhY2s7IGhlaWdodDoyMHB4IgogICAgICAgICAgICAgICBuZy1zdHlsZT0ieydiYWNrZ3JvdW5kLWNvbG9yJzpteUNvbG9yLm5hbWV9Ij4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLW9wdGlvbnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6bXlDb2xvcn0nKSkuZ2V0VGV4dCgpKS50b01hdGNoKCdyZWQnKTsKICAgICAgICAgICBlbGVtZW50LmFsbChieS5zZWxlY3QoJ215Q29sb3InKSkuZmlyc3QoKS5jbGljaygpOwogICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5LmNzcygnc2VsZWN0W25nLW1vZGVsPSJteUNvbG9yIl0gb3B0aW9uJykpLmZpcnN0KCkuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6bXlDb2xvcn0nKSkuZ2V0VGV4dCgpKS50b01hdGNoKCdibGFjaycpOwogICAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCcubnVsbGFibGUgc2VsZWN0W25nLW1vZGVsPSJteUNvbG9yIl0nKSkuY2xpY2soKTsKICAgICAgICAgICBlbGVtZW50LmFsbChieS5jc3MoJy5udWxsYWJsZSBzZWxlY3RbbmctbW9kZWw9Im15Q29sb3IiXSBvcHRpb24nKSkuZmlyc3QoKS5jbGljaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpteUNvbG9yfScpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJ251bGwnKTsKICAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICovCgp2YXIgbmdPcHRpb25zRGlyZWN0aXZlID0gdmFsdWVGbih7IHRlcm1pbmFsOiB0cnVlIH0pOwovLyBqc2hpbnQgbWF4bGVuOiBmYWxzZQp2YXIgc2VsZWN0RGlyZWN0aXZlID0gWyckY29tcGlsZScsICckcGFyc2UnLCBmdW5jdGlvbigkY29tcGlsZSwgICAkcGFyc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIC8vMDAwMDExMTExMTExMTEwMDAwMDAwMDAwMDIyMjIyMjIyMjIwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMzMzMzMzMDAwMDAwMDAwMDAwMDA0NDQ0NDQ0NDQ0NDQ0NDQwMDAwMDAwMDA1NTU1NTU1NTU1NTU1NTUwMDAwMDAwNjY2NjY2NjY2NjY2NjY2MDAwMDAwMDAwMDAwMDAwNzc3Nzc3Nzc3NzAwMDAwMDAwMDAwMDAwMDAwMDA4ODg4ODg4ODg4CiAgdmFyIE5HX09QVElPTlNfUkVHRVhQID0gL15ccyooW1xzXFNdKz8pKD86XHMrYXNccysoW1xzXFNdKz8pKT8oPzpccytncm91cFxzK2J5XHMrKFtcc1xTXSs/KSk/XHMrZm9yXHMrKD86KFtcJFx3XVtcJFx3XSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XSopXHMqLFxzKihbXCRcd11bXCRcd10qKVxzKlwpKSlccytpblxzKyhbXHNcU10rPykoPzpccyt0cmFja1xzK2J5XHMrKFtcc1xTXSs/KSk/JC8sCiAgICAgIG51bGxNb2RlbEN0cmwgPSB7JHNldFZpZXdWYWx1ZTogbm9vcH07Ci8vIGpzaGludCBtYXhsZW46IDEwMAoKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICBjb250cm9sbGVyOiBbJyRlbGVtZW50JywgJyRzY29wZScsICckYXR0cnMnLCBmdW5jdGlvbigkZWxlbWVudCwgJHNjb3BlLCAkYXR0cnMpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgb3B0aW9uc01hcCA9IHt9LAogICAgICAgICAgbmdNb2RlbEN0cmwgPSBudWxsTW9kZWxDdHJsLAogICAgICAgICAgbnVsbE9wdGlvbiwKICAgICAgICAgIHVua25vd25PcHRpb247CgoKICAgICAgc2VsZi5kYXRhYm91bmQgPSAkYXR0cnMubmdNb2RlbDsKCgogICAgICBzZWxmLmluaXQgPSBmdW5jdGlvbihuZ01vZGVsQ3RybF8sIG51bGxPcHRpb25fLCB1bmtub3duT3B0aW9uXykgewogICAgICAgIG5nTW9kZWxDdHJsID0gbmdNb2RlbEN0cmxfOwogICAgICAgIG51bGxPcHRpb24gPSBudWxsT3B0aW9uXzsKICAgICAgICB1bmtub3duT3B0aW9uID0gdW5rbm93bk9wdGlvbl87CiAgICAgIH07CgoKICAgICAgc2VsZi5hZGRPcHRpb24gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KHZhbHVlLCAnIm9wdGlvbiB2YWx1ZSInKTsKICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAkZWxlbWVudC52YWwodmFsdWUpOwogICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgfQogICAgICB9OwoKCiAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5oYXNPcHRpb24odmFsdWUpKSB7CiAgICAgICAgICBkZWxldGUgb3B0aW9uc01hcFt2YWx1ZV07CiAgICAgICAgICBpZiAobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSA9PSB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLnJlbmRlclVua25vd25PcHRpb24odmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCgogICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBmdW5jdGlvbih2YWwpIHsKICAgICAgICB2YXIgdW5rbm93blZhbCA9ICc/ICcgKyBoYXNoS2V5KHZhbCkgKyAnID8nOwogICAgICAgIHVua25vd25PcHRpb24udmFsKHVua25vd25WYWwpOwogICAgICAgICRlbGVtZW50LnByZXBlbmQodW5rbm93bk9wdGlvbik7CiAgICAgICAgJGVsZW1lbnQudmFsKHVua25vd25WYWwpOwogICAgICAgIHVua25vd25PcHRpb24ucHJvcCgnc2VsZWN0ZWQnLCB0cnVlKTsgLy8gbmVlZGVkIGZvciBJRQogICAgICB9OwoKCiAgICAgIHNlbGYuaGFzT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gb3B0aW9uc01hcC5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSk7CiAgICAgIH07CgogICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgIC8vIGRpc2FibGUgdW5rbm93biBvcHRpb24gc28gdGhhdCB3ZSBkb24ndCBkbyB3b3JrIHdoZW4gdGhlIHdob2xlIHNlbGVjdCBpcyBiZWluZyBkZXN0cm95ZWQKICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBub29wOwogICAgICB9KTsKICAgIH1dLAoKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAvLyBpZiBuZ01vZGVsIGlzIG5vdCBkZWZpbmVkLCB3ZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nCiAgICAgIGlmICghY3RybHNbMV0pIHJldHVybjsKCiAgICAgIHZhciBzZWxlY3RDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICBuZ01vZGVsQ3RybCA9IGN0cmxzWzFdLAogICAgICAgICAgbXVsdGlwbGUgPSBhdHRyLm11bHRpcGxlLAogICAgICAgICAgb3B0aW9uc0V4cCA9IGF0dHIubmdPcHRpb25zLAogICAgICAgICAgbnVsbE9wdGlvbiA9IGZhbHNlLCAvLyBpZiBmYWxzZSwgdXNlciB3aWxsIG5vdCBiZSBhYmxlIHRvIHNlbGVjdCBpdCAodXNlZCBieSBuZ09wdGlvbnMpCiAgICAgICAgICBlbXB0eU9wdGlvbiwKICAgICAgICAgIC8vIHdlIGNhbid0IGp1c3QganFMaXRlKCc8b3B0aW9uPicpIHNpbmNlIGpxTGl0ZSBpcyBub3Qgc21hcnQgZW5vdWdoCiAgICAgICAgICAvLyB0byBjcmVhdGUgaXQgaW4gPHNlbGVjdD4gYW5kIElFIGJhcmZzIG90aGVyd2lzZS4KICAgICAgICAgIG9wdGlvblRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpKSwKICAgICAgICAgIG9wdEdyb3VwVGVtcGxhdGUgPWpxTGl0ZShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRncm91cCcpKSwKICAgICAgICAgIHVua25vd25PcHRpb24gPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpOwoKICAgICAgLy8gZmluZCAibnVsbCIgb3B0aW9uCiAgICAgIGZvcih2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbigpLCBpaSA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICBpZiAoY2hpbGRyZW5baV0udmFsdWUgPT09ICcnKSB7CiAgICAgICAgICBlbXB0eU9wdGlvbiA9IG51bGxPcHRpb24gPSBjaGlsZHJlbi5lcShpKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgc2VsZWN0Q3RybC5pbml0KG5nTW9kZWxDdHJsLCBudWxsT3B0aW9uLCB1bmtub3duT3B0aW9uKTsKCiAgICAgIC8vIHJlcXVpcmVkIHZhbGlkYXRvcgogICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICBuZ01vZGVsQ3RybC4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIXZhbHVlIHx8IHZhbHVlLmxlbmd0aCA9PT0gMDsKICAgICAgICB9OwogICAgICB9CgogICAgICBpZiAob3B0aW9uc0V4cCkgc2V0dXBBc09wdGlvbnMoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgZWxzZSBpZiAobXVsdGlwbGUpIHNldHVwQXNNdWx0aXBsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICBlbHNlIHNldHVwQXNTaW5nbGUoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKTsKCgogICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKCiAgICAgIGZ1bmN0aW9uIHNldHVwQXNTaW5nbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKSB7CiAgICAgICAgbmdNb2RlbEN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgaWYgKHNlbGVjdEN0cmwuaGFzT3B0aW9uKHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIGlmICh2aWV3VmFsdWUgPT09ICcnKSBlbXB0eU9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyB0byBtYWtlIElFOSBoYXBweQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZpZXdWYWx1ZSkgJiYgZW1wdHlPcHRpb24pIHsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCgnJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoc2VsZWN0RWxlbWVudC52YWwoKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gc2V0dXBBc011bHRpcGxlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgdmFyIGxhc3RWaWV3OwogICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGl0ZW1zID0gbmV3IEhhc2hNYXAoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5maW5kKCdvcHRpb24nKSwgZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IGlzRGVmaW5lZChpdGVtcy5nZXQob3B0aW9uLnZhbHVlKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICAvLyB3ZSBoYXZlIHRvIGRvIGl0IG9uIGVhY2ggd2F0Y2ggc2luY2UgbmdNb2RlbCB3YXRjaGVzIHJlZmVyZW5jZSwgYnV0CiAgICAgICAgLy8gd2UgbmVlZCB0byB3b3JrIG9mIGFuIGFycmF5LCBzbyB3ZSBuZWVkIHRvIHNlZSBpZiBhbnl0aGluZyB3YXMgaW5zZXJ0ZWQvcmVtb3ZlZAogICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBzZWxlY3RNdWx0aXBsZVdhdGNoKCkgewogICAgICAgICAgaWYgKCFlcXVhbHMobGFzdFZpZXcsIGN0cmwuJHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgbGFzdFZpZXcgPSBzaGFsbG93Q29weShjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgc2VsZWN0RWxlbWVudC5vbignY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIGFycmF5LnB1c2gob3B0aW9uLnZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUoYXJyYXkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHNldHVwQXNPcHRpb25zKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgdmFyIG1hdGNoOwoKICAgICAgICBpZiAoIShtYXRjaCA9IG9wdGlvbnNFeHAubWF0Y2goTkdfT1BUSU9OU19SRUdFWFApKSkgewogICAgICAgICAgdGhyb3cgbmdPcHRpb25zTWluRXJyKCdpZXhwJywKICAgICAgICAgICAgIkV4cGVjdGVkIGV4cHJlc3Npb24gaW4gZm9ybSBvZiAiICsKICAgICAgICAgICAgIidfc2VsZWN0XyAoYXMgX2xhYmVsXyk/IGZvciAoX2tleV8sKT9fdmFsdWVfIGluIF9jb2xsZWN0aW9uXyciICsKICAgICAgICAgICAgIiBidXQgZ290ICd7MH0nLiBFbGVtZW50OiB7MX0iLAogICAgICAgICAgICBvcHRpb25zRXhwLCBzdGFydGluZ1RhZyhzZWxlY3RFbGVtZW50KSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgICAgICAgZ3JvdXBCeUZuID0gJHBhcnNlKG1hdGNoWzNdIHx8ICcnKSwKICAgICAgICAgICAgdmFsdWVGbiA9ICRwYXJzZShtYXRjaFsyXSA/IG1hdGNoWzFdIDogdmFsdWVOYW1lKSwKICAgICAgICAgICAgdmFsdWVzRm4gPSAkcGFyc2UobWF0Y2hbN10pLAogICAgICAgICAgICB0cmFjayA9IG1hdGNoWzhdLAogICAgICAgICAgICB0cmFja0ZuID0gdHJhY2sgPyAkcGFyc2UobWF0Y2hbOF0pIDogbnVsbCwKICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnJheSBvZiBhcnJheSBvZiBleGlzdGluZyBvcHRpb24gZ3JvdXBzIGluIERPTS4KICAgICAgICAgICAgLy8gV2UgdHJ5IHRvIHJldXNlIHRoZXNlIGlmIHBvc3NpYmxlCiAgICAgICAgICAgIC8vIC0gb3B0aW9uR3JvdXBzQ2FjaGVbMF0gaXMgdGhlIG9wdGlvbnMgd2l0aCBubyBvcHRpb24gZ3JvdXAKICAgICAgICAgICAgLy8gLSBvcHRpb25Hcm91cHNDYWNoZVs/XVswXSBpcyB0aGUgcGFyZW50OiBlaXRoZXIgdGhlIFNFTEVDVCBvciBPUFRHUk9VUCBlbGVtZW50CiAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlID0gW1t7ZWxlbWVudDogc2VsZWN0RWxlbWVudCwgbGFiZWw6Jyd9XV07CgogICAgICAgIGlmIChudWxsT3B0aW9uKSB7CiAgICAgICAgICAvLyBjb21waWxlIHRoZSBlbGVtZW50IHNpbmNlIHRoZXJlIG1pZ2h0IGJlIGJpbmRpbmdzIGluIGl0CiAgICAgICAgICAkY29tcGlsZShudWxsT3B0aW9uKShzY29wZSk7CgogICAgICAgICAgLy8gcmVtb3ZlIHRoZSBjbGFzcywgd2hpY2ggaXMgYWRkZWQgYXV0b21hdGljYWxseSBiZWNhdXNlIHdlIHJlY29tcGlsZSB0aGUgZWxlbWVudCBhbmQgaXQKICAgICAgICAgIC8vIGJlY29tZXMgdGhlIGNvbXBpbGF0aW9uIHJvb3QKICAgICAgICAgIG51bGxPcHRpb24ucmVtb3ZlQ2xhc3MoJ25nLXNjb3BlJyk7CgogICAgICAgICAgLy8gd2UgbmVlZCB0byByZW1vdmUgaXQgYmVmb3JlIGNhbGxpbmcgc2VsZWN0RWxlbWVudC5lbXB0eSgpIGJlY2F1c2Ugb3RoZXJ3aXNlIElFIHdpbGwKICAgICAgICAgIC8vIHJlbW92ZSB0aGUgbGFiZWwgZnJvbSB0aGUgZWxlbWVudC4gd3RmPwogICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmUoKTsKICAgICAgICB9CgogICAgICAgIC8vIGNsZWFyIGNvbnRlbnRzLCB3ZSdsbCBhZGQgd2hhdCdzIG5lZWRlZCBiYXNlZCBvbiB0aGUgbW9kZWwKICAgICAgICBzZWxlY3RFbGVtZW50LmVtcHR5KCk7CgogICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgbG9jYWxzID0ge30sCiAgICAgICAgICAgICAgICBrZXksIHZhbHVlLCBvcHRpb25FbGVtZW50LCBpbmRleCwgZ3JvdXBJbmRleCwgbGVuZ3RoLCBncm91cExlbmd0aCwgdHJhY2tJbmRleDsKCiAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc0NhY2hlW2dyb3VwSW5kZXhdOwoKICAgICAgICAgICAgICAgIGZvcihpbmRleCA9IDEsIGxlbmd0aCA9IG9wdGlvbkdyb3VwLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgaWYgKChvcHRpb25FbGVtZW50ID0gb3B0aW9uR3JvdXBbaW5kZXhdLmVsZW1lbnQpWzBdLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gb3B0aW9uRWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKHRyYWNrSW5kZXggPSAwOyB0cmFja0luZGV4IDwgY29sbGVjdGlvbi5sZW5ndGg7IHRyYWNrSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25bdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKHNjb3BlLCBsb2NhbHMpID09IGtleSkgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKHZhbHVlRm4oc2NvcGUsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGtleSA9IHNlbGVjdEVsZW1lbnQudmFsKCk7CiAgICAgICAgICAgICAgaWYgKGtleSA9PSAnPycpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnJyl7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgICAgICAgIGZvciAodHJhY2tJbmRleCA9IDA7IHRyYWNrSW5kZXggPCBjb2xsZWN0aW9uLmxlbmd0aDsgdHJhY2tJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW3RyYWNrSW5kZXhdOwogICAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKHNjb3BlLCBsb2NhbHMpID09IGtleSkgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgICAgICAgaWYgKGtleU5hbWUpIGxvY2Fsc1trZXlOYW1lXSA9IGtleTsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBVcGRhdGUgdGhlIG51bGwgb3B0aW9uJ3Mgc2VsZWN0ZWQgcHJvcGVydHkgaGVyZSBzbyAkcmVuZGVyIGNsZWFucyBpdCB1cCBjb3JyZWN0bHkKICAgICAgICAgICAgICBpZiAob3B0aW9uR3JvdXBzQ2FjaGVbMF0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlWzBdWzFdLmlkICE9PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGVbMF1bMV0uc2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICBjdHJsLiRyZW5kZXIgPSByZW5kZXI7CgogICAgICAgIC8vIFRPRE8odm9qdGEpOiBjYW4ndCB3ZSBvcHRpbWl6ZSB0aGlzID8KICAgICAgICBzY29wZS4kd2F0Y2gocmVuZGVyKTsKCiAgICAgICAgZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgICAgICAgIC8vIFRlbXBvcmFyeSBsb2NhdGlvbiBmb3IgdGhlIG9wdGlvbiBncm91cHMgYmVmb3JlIHdlIHJlbmRlciB0aGVtCiAgICAgICAgICB2YXIgb3B0aW9uR3JvdXBzID0geycnOltdfSwKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzID0gWycnXSwKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgb3B0aW9uLAogICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgICAgIG1vZGVsVmFsdWUgPSBjdHJsLiRtb2RlbFZhbHVlLAogICAgICAgICAgICAgIHZhbHVlcyA9IHZhbHVlc0ZuKHNjb3BlKSB8fCBbXSwKICAgICAgICAgICAgICBrZXlzID0ga2V5TmFtZSA/IHNvcnRlZEtleXModmFsdWVzKSA6IHZhbHVlcywKICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgZ3JvdXBMZW5ndGgsIGxlbmd0aCwKICAgICAgICAgICAgICBncm91cEluZGV4LCBpbmRleCwKICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICBzZWxlY3RlZCwKICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IGZhbHNlLCAvLyBub3RoaW5nIGlzIHNlbGVjdGVkIHlldAogICAgICAgICAgICAgIGxhc3RFbGVtZW50LAogICAgICAgICAgICAgIGVsZW1lbnQsCiAgICAgICAgICAgICAgbGFiZWw7CgogICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmICh0cmFja0ZuICYmIGlzQXJyYXkobW9kZWxWYWx1ZSkpIHsKICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKFtdKTsKICAgICAgICAgICAgICBmb3IgKHZhciB0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IG1vZGVsVmFsdWUubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gbW9kZWxWYWx1ZVt0cmFja0luZGV4XTsKICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0LnB1dCh0cmFja0ZuKHNjb3BlLCBsb2NhbHMpLCBtb2RlbFZhbHVlW3RyYWNrSW5kZXhdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBuZXcgSGFzaE1hcChtb2RlbFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFdlIG5vdyBidWlsZCB1cCB0aGUgbGlzdCBvZiBvcHRpb25zIHdlIG5lZWQgKHdlIG1lcmdlIGxhdGVyKQogICAgICAgICAgZm9yIChpbmRleCA9IDA7IGxlbmd0aCA9IGtleXMubGVuZ3RoLCBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewoKICAgICAgICAgICAga2V5ID0gaW5kZXg7CiAgICAgICAgICAgIGlmIChrZXlOYW1lKSB7CiAgICAgICAgICAgICAga2V5ID0ga2V5c1tpbmRleF07CiAgICAgICAgICAgICAgaWYgKCBrZXkuY2hhckF0KDApID09PSAnJCcgKSBjb250aW51ZTsKICAgICAgICAgICAgICBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gdmFsdWVzW2tleV07CgogICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4oc2NvcGUsIGxvY2FscykgfHwgJyc7CiAgICAgICAgICAgIGlmICghKG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0pKSB7CiAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSA9IFtdOwogICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZXMucHVzaChvcHRpb25Hcm91cE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgIHNlbGVjdGVkID0gaXNEZWZpbmVkKAogICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQucmVtb3ZlKHRyYWNrRm4gPyB0cmFja0ZuKHNjb3BlLCBsb2NhbHMpIDogdmFsdWVGbihzY29wZSwgbG9jYWxzKSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kZWxDYXN0ID0ge307CiAgICAgICAgICAgICAgICBtb2RlbENhc3RbdmFsdWVOYW1lXSA9IG1vZGVsVmFsdWU7CiAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IHRyYWNrRm4oc2NvcGUsIG1vZGVsQ2FzdCkgPT09IHRyYWNrRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gbW9kZWxWYWx1ZSA9PT0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBzZWxlY3RlZFNldCB8fCBzZWxlY3RlZDsgLy8gc2VlIGlmIGF0IGxlYXN0IG9uZSBpdGVtIGlzIHNlbGVjdGVkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCgogICAgICAgICAgICAvLyBkb2luZyBkaXNwbGF5Rm4oc2NvcGUsIGxvY2FscykgfHwgJycgb3ZlcndyaXRlcyB6ZXJvIHZhbHVlcwogICAgICAgICAgICBsYWJlbCA9IGlzRGVmaW5lZChsYWJlbCkgPyBsYWJlbCA6ICcnOwogICAgICAgICAgICBvcHRpb25Hcm91cC5wdXNoKHsKICAgICAgICAgICAgICAvLyBlaXRoZXIgdGhlIGluZGV4IGludG8gYXJyYXkgb3Iga2V5IGZyb20gb2JqZWN0CiAgICAgICAgICAgICAgaWQ6IHRyYWNrRm4gPyB0cmFja0ZuKHNjb3BlLCBsb2NhbHMpIDogKGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4KSwKICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHNlbGVjdGVkICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgc2VsZWN0ZWQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChudWxsT3B0aW9uIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAvLyBpbnNlcnQgbnVsbCBvcHRpb24gaWYgd2UgaGF2ZSBhIHBsYWNlaG9sZGVyLCBvciB0aGUgbW9kZWwgaXMgbnVsbAogICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6JycsIGxhYmVsOicnLCBzZWxlY3RlZDohc2VsZWN0ZWRTZXR9KTsKICAgICAgICAgICAgfSBlbHNlIGlmICghc2VsZWN0ZWRTZXQpIHsKICAgICAgICAgICAgICAvLyBvcHRpb24gY291bGQgbm90IGJlIGZvdW5kLCB3ZSBoYXZlIHRvIGluc2VydCB0aGUgdW5kZWZpbmVkIGl0ZW0KICAgICAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnVuc2hpZnQoe2lkOic/JywgbGFiZWw6JycsIHNlbGVjdGVkOnRydWV9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgdG8gbWF0Y2ggdGhlIG9wdGlvbkdyb3VwcyB3ZSBjb21wdXRlZCBhYm92ZQogICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cE5hbWVzLmxlbmd0aDsKICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA8IGdyb3VwTGVuZ3RoOwogICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgLy8gY3VycmVudCBvcHRpb24gZ3JvdXAgbmFtZSBvciAnJyBpZiBubyBncm91cAogICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBvcHRpb25Hcm91cE5hbWVzW2dyb3VwSW5kZXhdOwoKICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXTsKCiAgICAgICAgICAgIGlmIChvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPD0gZ3JvdXBJbmRleCkgewogICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gZ3JvdyB0aGUgb3B0aW9uR3JvdXBzCiAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSB7CiAgICAgICAgICAgICAgICBlbGVtZW50OiBvcHRHcm91cFRlbXBsYXRlLmNsb25lKCkuYXR0cignbGFiZWwnLCBvcHRpb25Hcm91cE5hbWUpLAogICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbkdyb3VwLmxhYmVsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbZXhpc3RpbmdQYXJlbnRdOwogICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnB1c2goZXhpc3RpbmdPcHRpb25zKTsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChleGlzdGluZ1BhcmVudC5lbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IGV4aXN0aW5nT3B0aW9uc1swXTsgIC8vIGVpdGhlciBTRUxFQ1QgKG5vIGdyb3VwKSBvciBPUFRHUk9VUCBlbGVtZW50CgogICAgICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgT1BUR1JPVVAgbGFiZWwgaWYgbm90IHRoZSBzYW1lLgogICAgICAgICAgICAgIGlmIChleGlzdGluZ1BhcmVudC5sYWJlbCAhPSBvcHRpb25Hcm91cE5hbWUpIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXR0cignbGFiZWwnLCBleGlzdGluZ1BhcmVudC5sYWJlbCA9IG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsYXN0RWxlbWVudCA9IG51bGw7ICAvLyBzdGFydCBhdCB0aGUgYmVnaW5uaW5nCiAgICAgICAgICAgIGZvcihpbmRleCA9IDAsIGxlbmd0aCA9IG9wdGlvbkdyb3VwLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICBvcHRpb24gPSBvcHRpb25Hcm91cFtpbmRleF07CiAgICAgICAgICAgICAgaWYgKChleGlzdGluZ09wdGlvbiA9IGV4aXN0aW5nT3B0aW9uc1tpbmRleCsxXSkpIHsKICAgICAgICAgICAgICAgIC8vIHJldXNlIGVsZW1lbnRzCiAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGV4aXN0aW5nT3B0aW9uLmVsZW1lbnQ7CiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24ubGFiZWwgIT09IG9wdGlvbi5sYWJlbCkgewogICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC50ZXh0KGV4aXN0aW5nT3B0aW9uLmxhYmVsID0gb3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5pZCAhPT0gb3B0aW9uLmlkKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnZhbChleGlzdGluZ09wdGlvbi5pZCA9IG9wdGlvbi5pZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcpIHByb3ZpZGVkIGJ5IGpRdWVyeSBoYXMgc2lkZS1lZmZlY3RzCiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgIT09IG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcsIChleGlzdGluZ09wdGlvbi5zZWxlY3RlZCA9IG9wdGlvbi5zZWxlY3RlZCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBncm93IGVsZW1lbnRzCgogICAgICAgICAgICAgICAgLy8gaWYgaXQncyBhIG51bGwgb3B0aW9uCiAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmlkID09PSAnJyAmJiBudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgIC8vIHB1dCBiYWNrIHRoZSBwcmUtY29tcGlsZWQgZWxlbWVudAogICAgICAgICAgICAgICAgICBlbGVtZW50ID0gbnVsbE9wdGlvbjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIGpRdWVyeSh2MS40LjIpIEJ1ZzogV2Ugc2hvdWxkIGJlIGFibGUgdG8gY2hhaW4gdGhlIG1ldGhvZCBjYWxscywgYnV0CiAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnkgb24gc29tZSBicm93c2VyIHRoZSAudGV4dCgpIHJldHVybnMgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgLy8gcmF0aGVyIHRoZW4gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgIChlbGVtZW50ID0gb3B0aW9uVGVtcGxhdGUuY2xvbmUoKSkKICAgICAgICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKQogICAgICAgICAgICAgICAgICAgICAgLnRleHQob3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb24ubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogb3B0aW9uLnNlbGVjdGVkCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5hZnRlcihlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRJT05zIGluIGEgZ3JvdXAKICAgICAgICAgICAgaW5kZXgrKzsgLy8gaW5jcmVtZW50IHNpbmNlIHRoZSBleGlzdGluZ09wdGlvbnNbMF0gaXMgcGFyZW50IGVsZW1lbnQgbm90IE9QVElPTgogICAgICAgICAgICB3aGlsZShleGlzdGluZ09wdGlvbnMubGVuZ3RoID4gaW5kZXgpIHsKICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucG9wKCkuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUR1JPVVBzIGZyb20gc2VsZWN0CiAgICAgICAgICB3aGlsZShvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPiBncm91cEluZGV4KSB7CiAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnBvcCgpWzBdLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKfV07Cgp2YXIgb3B0aW9uRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbigkaW50ZXJwb2xhdGUpIHsKICB2YXIgbnVsbFNlbGVjdEN0cmwgPSB7CiAgICBhZGRPcHRpb246IG5vb3AsCiAgICByZW1vdmVPcHRpb246IG5vb3AKICB9OwoKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHByaW9yaXR5OiAxMDAsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZChhdHRyLnZhbHVlKSkgewogICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQudGV4dCgpLCB0cnVlKTsKICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHsKICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBlbGVtZW50LnRleHQoKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgdmFyIHNlbGVjdEN0cmxOYW1lID0gJyRzZWxlY3RDb250cm9sbGVyJywKICAgICAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKSwKICAgICAgICAgICAgc2VsZWN0Q3RybCA9IHBhcmVudC5kYXRhKHNlbGVjdEN0cmxOYW1lKSB8fAogICAgICAgICAgICAgIHBhcmVudC5wYXJlbnQoKS5kYXRhKHNlbGVjdEN0cmxOYW1lKTsgLy8gaW4gY2FzZSB3ZSBhcmUgaW4gb3B0Z3JvdXAKCiAgICAgICAgaWYgKHNlbGVjdEN0cmwgJiYgc2VsZWN0Q3RybC5kYXRhYm91bmQpIHsKICAgICAgICAgIC8vIEZvciBzb21lIHJlYXNvbiBPcGVyYSBkZWZhdWx0cyB0byB0cnVlIGFuZCBpZiBub3Qgb3ZlcnJpZGRlbiB0aGlzIG1lc3NlcyB1cCB0aGUgcmVwZWF0ZXIuCiAgICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRoZSB2aWV3IHRvIGRyaXZlIHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgbW9kZWwgYW55d2F5LgogICAgICAgICAgZWxlbWVudC5wcm9wKCdzZWxlY3RlZCcsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZWN0Q3RybCA9IG51bGxTZWxlY3RDdHJsOwogICAgICAgIH0KCiAgICAgICAgaWYgKGludGVycG9sYXRlRm4pIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZVdhdGNoQWN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBuZXdWYWwpOwogICAgICAgICAgICBpZiAobmV3VmFsICE9PSBvbGRWYWwpIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKG9sZFZhbCk7CiAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKG5ld1ZhbCk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfTsKfV07Cgp2YXIgc3R5bGVEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICByZXN0cmljdDogJ0UnLAogIHRlcm1pbmFsOiB0cnVlCn0pOwoKICBpZiAod2luZG93LmFuZ3VsYXIuYm9vdHN0cmFwKSB7CiAgICAvL0FuZ3VsYXJKUyBpcyBhbHJlYWR5IGxvYWRlZCwgc28gd2UgY2FuIHJldHVybiBoZXJlLi4uCiAgICBjb25zb2xlLmxvZygnV0FSTklORzogVHJpZWQgdG8gbG9hZCBhbmd1bGFyIG1vcmUgdGhhbiBvbmNlLicpOwogICAgcmV0dXJuOwogIH0KCiAgLy90cnkgdG8gYmluZCB0byBqcXVlcnkgbm93IHNvIHRoYXQgb25lIGNhbiB3cml0ZSBhbmd1bGFyLmVsZW1lbnQoKS5yZWFkKCkKICAvL2J1dCB3ZSB3aWxsIHJlYmluZCBvbiBib290c3RyYXAgYWdhaW4uCiAgYmluZEpRdWVyeSgpOwoKICBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcik7CgogIGpxTGl0ZShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBhbmd1bGFySW5pdChkb2N1bWVudCwgYm9vdHN0cmFwKTsKICB9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKIXdpbmRvdy5hbmd1bGFyLiQkY3NwKCkgJiYgd2luZG93LmFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuZmluZCgnaGVhZCcpLnByZXBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtbbmdcXDpjbG9ha10sW25nLWNsb2FrXSxbZGF0YS1uZy1jbG9ha10sW3gtbmctY2xvYWtdLC5uZy1jbG9haywueC1uZy1jbG9haywubmctaGlkZXtkaXNwbGF5Om5vbmUgIWltcG9ydGFudDt9bmdcXDpmb3Jte2Rpc3BsYXk6YmxvY2s7fS5uZy1hbmltYXRlLWJsb2NrLXRyYW5zaXRpb25ze3RyYW5zaXRpb246MHMgYWxsIWltcG9ydGFudDstd2Via2l0LXRyYW5zaXRpb246MHMgYWxsIWltcG9ydGFudDt9Lm5nLWhpZGUtYWRkLWFjdGl2ZSwubmctaGlkZS1yZW1vdmV7ZGlzcGxheTpibG9jayFpbXBvcnRhbnQ7fTwvc3R5bGU+Jyk7Ci8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKioKICogQGxpY2Vuc2UgQW5ndWxhckpTIHYxLjIuMTcKICogKGMpIDIwMTAtMjAxNCBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBhbmd1bGFyLCB1bmRlZmluZWQpIHsndXNlIHN0cmljdCc7CgovKiBqc2hpbnQgbWF4bGVuOiBmYWxzZSAqLwoKLyoqCiAqIEBuZ2RvYyBtb2R1bGUKICogQG5hbWUgbmdBbmltYXRlCiAqIEBkZXNjcmlwdGlvbgogKgogKiAjIG5nQW5pbWF0ZQogKgogKiBUaGUgYG5nQW5pbWF0ZWAgbW9kdWxlIHByb3ZpZGVzIHN1cHBvcnQgZm9yIEphdmFTY3JpcHQsIENTUzMgdHJhbnNpdGlvbiBhbmQgQ1NTMyBrZXlmcmFtZSBhbmltYXRpb24gaG9va3Mgd2l0aGluIGV4aXN0aW5nIGNvcmUgYW5kIGN1c3RvbSBkaXJlY3RpdmVzLgogKgogKgogKiA8ZGl2IGRvYy1tb2R1bGUtY29tcG9uZW50cz0ibmdBbmltYXRlIj48L2Rpdj4KICoKICogIyBVc2FnZQogKgogKiBUbyBzZWUgYW5pbWF0aW9ucyBpbiBhY3Rpb24sIGFsbCB0aGF0IGlzIHJlcXVpcmVkIGlzIHRvIGRlZmluZSB0aGUgYXBwcm9wcmlhdGUgQ1NTIGNsYXNzZXMKICogb3IgdG8gcmVnaXN0ZXIgYSBKYXZhU2NyaXB0IGFuaW1hdGlvbiB2aWEgdGhlIG15TW9kdWxlLmFuaW1hdGlvbigpIGZ1bmN0aW9uLiBUaGUgZGlyZWN0aXZlcyB0aGF0IHN1cHBvcnQgYW5pbWF0aW9uIGF1dG9tYXRpY2FsbHkgYXJlOgogKiBgbmdSZXBlYXRgLCBgbmdJbmNsdWRlYCwgYG5nSWZgLCBgbmdTd2l0Y2hgLCBgbmdTaG93YCwgYG5nSGlkZWAsIGBuZ1ZpZXdgIGFuZCBgbmdDbGFzc2AuIEN1c3RvbSBkaXJlY3RpdmVzIGNhbiB0YWtlIGFkdmFudGFnZSBvZiBhbmltYXRpb24KICogYnkgdXNpbmcgdGhlIGAkYW5pbWF0ZWAgc2VydmljZS4KICoKICogQmVsb3cgaXMgYSBtb3JlIGRldGFpbGVkIGJyZWFrZG93biBvZiB0aGUgc3VwcG9ydGVkIGFuaW1hdGlvbiBldmVudHMgcHJvdmlkZWQgYnkgcHJlLWV4aXN0aW5nIG5nIGRpcmVjdGl2ZXM6CiAqCiAqIHwgRGlyZWN0aXZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgU3VwcG9ydGVkIEFuaW1hdGlvbnMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0I3VzYWdlX2FuaW1hdGlvbnMgbmdSZXBlYXR9ICAgICAgICAgfCBlbnRlciwgbGVhdmUgYW5kIG1vdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nUm91dGUuZGlyZWN0aXZlOm5nVmlldyN1c2FnZV9hbmltYXRpb25zIG5nVmlld30gICAgICAgIHwgZW50ZXIgYW5kIGxlYXZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlI3VzYWdlX2FuaW1hdGlvbnMgbmdJbmNsdWRlfSAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3dpdGNoI3VzYWdlX2FuaW1hdGlvbnMgbmdTd2l0Y2h9ICAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0lmI3VzYWdlX2FuaW1hdGlvbnMgbmdJZn0gICAgICAgICAgICAgICAgIHwgZW50ZXIgYW5kIGxlYXZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyN1c2FnZV9hbmltYXRpb25zIG5nQ2xhc3N9ICAgICAgICAgICB8IGFkZCBhbmQgcmVtb3ZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU2hvdyN1c2FnZV9hbmltYXRpb25zIG5nU2hvdyAmIG5nSGlkZX0gICAgfCBhZGQgYW5kIHJlbW92ZSAodGhlIG5nLWhpZGUgY2xhc3MgdmFsdWUpICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtI3VzYWdlX2FuaW1hdGlvbnMgZm9ybX0gICAgICAgICAgICAgICAgIHwgYWRkIGFuZCByZW1vdmUgKGRpcnR5LCBwcmlzdGluZSwgdmFsaWQsIGludmFsaWQgJiBhbGwgb3RoZXIgdmFsaWRhdGlvbnMpICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTW9kZWwjdXNhZ2VfYW5pbWF0aW9ucyBuZ01vZGVsfSAgICAgICAgICAgfCBhZGQgYW5kIHJlbW92ZSAoZGlydHksIHByaXN0aW5lLCB2YWxpZCwgaW52YWxpZCAmIGFsbCBvdGhlciB2YWxpZGF0aW9ucykgICAgICAgICAgICAgICAgfAogKgogKiBZb3UgY2FuIGZpbmQgb3V0IG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgYW5pbWF0aW9ucyB1cG9uIHZpc2l0aW5nIGVhY2ggZGlyZWN0aXZlIHBhZ2UuCiAqCiAqIEJlbG93IGlzIGFuIGV4YW1wbGUgb2YgaG93IHRvIGFwcGx5IGFuaW1hdGlvbnMgdG8gYSBkaXJlY3RpdmUgdGhhdCBzdXBwb3J0cyBhbmltYXRpb24gaG9va3M6CiAqCiAqIGBgYGh0bWwKICogPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICogLnNsaWRlLm5nLWVudGVyLCAuc2xpZGUubmctbGVhdmUgewogKiAgIC13ZWJraXQtdHJhbnNpdGlvbjowLjVzIGxpbmVhciBhbGw7CiAqICAgdHJhbnNpdGlvbjowLjVzIGxpbmVhciBhbGw7CiAqIH0KICoKICogLnNsaWRlLm5nLWVudGVyIHsgfSAgICAgICAgLyYjNDI7IHN0YXJ0aW5nIGFuaW1hdGlvbnMgZm9yIGVudGVyICYjNDI7LwogKiAuc2xpZGUubmctZW50ZXItYWN0aXZlIHsgfSAvJiM0MjsgdGVybWluYWwgYW5pbWF0aW9ucyBmb3IgZW50ZXIgJiM0MjsvCiAqIC5zbGlkZS5uZy1sZWF2ZSB7IH0gICAgICAgIC8mIzQyOyBzdGFydGluZyBhbmltYXRpb25zIGZvciBsZWF2ZSAmIzQyOy8KICogLnNsaWRlLm5nLWxlYXZlLWFjdGl2ZSB7IH0gLyYjNDI7IHRlcm1pbmFsIGFuaW1hdGlvbnMgZm9yIGxlYXZlICYjNDI7LwogKiA8L3N0eWxlPgogKgogKiA8IS0tCiAqIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGFkZCAubmctZW50ZXIgYW5kIC5uZy1sZWF2ZSB0byB0aGUgZWxlbWVudAogKiB0byB0cmlnZ2VyIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb25zCiAqIC0tPgogKiA8QU5ZIGNsYXNzPSJzbGlkZSIgbmctaW5jbHVkZT0iLi4uIj48L0FOWT4KICogYGBgCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0IGlmIGFuIGFuaW1hdGlvbiBpcyBydW5uaW5nLCBhbnkgY2hpbGQgZWxlbWVudHMgY2Fubm90IGJlIGFuaW1hdGVkIHVudGlsIHRoZSBwYXJlbnQgZWxlbWVudCdzCiAqIGFuaW1hdGlvbiBoYXMgY29tcGxldGVkLgogKgogKiA8aDI+Q1NTLWRlZmluZWQgQW5pbWF0aW9uczwvaDI+CiAqIFRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGFwcGx5IHR3byBDU1MgY2xhc3NlcyB0byB0aGUgYW5pbWF0ZWQgZWxlbWVudCBhbmQgdGhlc2UgdHdvIENTUyBjbGFzc2VzCiAqIGFyZSBkZXNpZ25lZCB0byBjb250YWluIHRoZSBzdGFydCBhbmQgZW5kIENTUyBzdHlsaW5nLiBCb3RoIENTUyB0cmFuc2l0aW9ucyBhbmQga2V5ZnJhbWUgYW5pbWF0aW9ucyBhcmUgc3VwcG9ydGVkCiAqIGFuZCBjYW4gYmUgdXNlZCB0byBwbGF5IGFsb25nIHdpdGggdGhpcyBuYW1pbmcgc3RydWN0dXJlLgogKgogKiBUaGUgZm9sbG93aW5nIGNvZGUgYmVsb3cgZGVtb25zdHJhdGVzIGhvdyB0byBwZXJmb3JtIGFuaW1hdGlvbnMgdXNpbmcgKipDU1MgdHJhbnNpdGlvbnMqKiB3aXRoIEFuZ3VsYXI6CiAqCiAqIGBgYGh0bWwKICogPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICogLyYjNDI7CiAqICBUaGUgYW5pbWF0ZSBjbGFzcyBpcyBhcGFydCBvZiB0aGUgZWxlbWVudCBhbmQgdGhlIG5nLWVudGVyIGNsYXNzCiAqICBpcyBhdHRhY2hlZCB0byB0aGUgZWxlbWVudCBvbmNlIHRoZSBlbnRlciBhbmltYXRpb24gZXZlbnQgaXMgdHJpZ2dlcmVkCiAqICYjNDI7LwogKiAucmV2ZWFsLWFuaW1hdGlvbi5uZy1lbnRlciB7CiAqICAtd2Via2l0LXRyYW5zaXRpb246IDFzIGxpbmVhciBhbGw7IC8mIzQyOyBTYWZhcmkvQ2hyb21lICYjNDI7LwogKiAgdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsgLyYjNDI7IEFsbCBvdGhlciBtb2Rlcm4gYnJvd3NlcnMgYW5kIElFMTArICYjNDI7LwogKgogKiAgLyYjNDI7IFRoZSBhbmltYXRpb24gcHJlcGFyYXRpb24gY29kZSAmIzQyOy8KICogIG9wYWNpdHk6IDA7CiAqIH0KICoKICogLyYjNDI7CiAqICBLZWVwIGluIG1pbmQgdGhhdCB5b3Ugd2FudCB0byBjb21iaW5lIGJvdGggQ1NTCiAqICBjbGFzc2VzIHRvZ2V0aGVyIHRvIGF2b2lkIGFueSBDU1Mtc3BlY2lmaWNpdHkKICogIGNvbmZsaWN0cwogKiAmIzQyOy8KICogLnJldmVhbC1hbmltYXRpb24ubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICogIC8mIzQyOyBUaGUgYW5pbWF0aW9uIGNvZGUgaXRzZWxmICYjNDI7LwogKiAgb3BhY2l0eTogMTsKICogfQogKiA8L3N0eWxlPgogKgogKiA8ZGl2IGNsYXNzPSJ2aWV3LWNvbnRhaW5lciI+CiAqICAgPGRpdiBuZy12aWV3IGNsYXNzPSJyZXZlYWwtYW5pbWF0aW9uIj48L2Rpdj4KICogPC9kaXY+CiAqIGBgYAogKgogKiBUaGUgZm9sbG93aW5nIGNvZGUgYmVsb3cgZGVtb25zdHJhdGVzIGhvdyB0byBwZXJmb3JtIGFuaW1hdGlvbnMgdXNpbmcgKipDU1MgYW5pbWF0aW9ucyoqIHdpdGggQW5ndWxhcjoKICoKICogYGBgaHRtbAogKiA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogKiAucmV2ZWFsLWFuaW1hdGlvbi5uZy1lbnRlciB7CiAqICAgLXdlYmtpdC1hbmltYXRpb246IGVudGVyX3NlcXVlbmNlIDFzIGxpbmVhcjsgLyYjNDI7IFNhZmFyaS9DaHJvbWUgJiM0MjsvCiAqICAgYW5pbWF0aW9uOiBlbnRlcl9zZXF1ZW5jZSAxcyBsaW5lYXI7IC8mIzQyOyBJRTEwKyBhbmQgRnV0dXJlIEJyb3dzZXJzICYjNDI7LwogKiB9CiAqIEAtd2Via2l0LWtleWZyYW1lcyBlbnRlcl9zZXF1ZW5jZSB7CiAqICAgZnJvbSB7IG9wYWNpdHk6MDsgfQogKiAgIHRvIHsgb3BhY2l0eToxOyB9CiAqIH0KICogQGtleWZyYW1lcyBlbnRlcl9zZXF1ZW5jZSB7CiAqICAgZnJvbSB7IG9wYWNpdHk6MDsgfQogKiAgIHRvIHsgb3BhY2l0eToxOyB9CiAqIH0KICogPC9zdHlsZT4KICoKICogPGRpdiBjbGFzcz0idmlldy1jb250YWluZXIiPgogKiAgIDxkaXYgbmctdmlldyBjbGFzcz0icmV2ZWFsLWFuaW1hdGlvbiI+PC9kaXY+CiAqIDwvZGl2PgogKiBgYGAKICoKICogQm90aCBDU1MzIGFuaW1hdGlvbnMgYW5kIHRyYW5zaXRpb25zIGNhbiBiZSB1c2VkIHRvZ2V0aGVyIGFuZCB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgZmlndXJlIG91dCB0aGUgY29ycmVjdCBkdXJhdGlvbiBhbmQgZGVsYXkgdGltaW5nLgogKgogKiBVcG9uIERPTSBtdXRhdGlvbiwgdGhlIGV2ZW50IGNsYXNzIGlzIGFkZGVkIGZpcnN0IChzb21ldGhpbmcgbGlrZSBgbmctZW50ZXJgKSwgdGhlbiB0aGUgYnJvd3NlciBwcmVwYXJlcyBpdHNlbGYgdG8gYWRkCiAqIHRoZSBhY3RpdmUgY2xhc3MgKGluIHRoaXMgY2FzZSBgbmctZW50ZXItYWN0aXZlYCkgd2hpY2ggdGhlbiB0cmlnZ2VycyB0aGUgYW5pbWF0aW9uLiBUaGUgYW5pbWF0aW9uIG1vZHVsZSB3aWxsIGF1dG9tYXRpY2FsbHkKICogZGV0ZWN0IHRoZSBDU1MgY29kZSB0byBkZXRlcm1pbmUgd2hlbiB0aGUgYW5pbWF0aW9uIGVuZHMuIE9uY2UgdGhlIGFuaW1hdGlvbiBpcyBvdmVyIHRoZW4gYm90aCBDU1MgY2xhc3NlcyB3aWxsIGJlCiAqIHJlbW92ZWQgZnJvbSB0aGUgRE9NLiBJZiBhIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBDU1MgdHJhbnNpdGlvbnMgb3IgQ1NTIGFuaW1hdGlvbnMgdGhlbiB0aGUgYW5pbWF0aW9uIHdpbGwgc3RhcnQgYW5kIGVuZAogKiBpbW1lZGlhdGVseSByZXN1bHRpbmcgaW4gYSBET00gZWxlbWVudCB0aGF0IGlzIGF0IGl0cyBmaW5hbCBzdGF0ZS4gVGhpcyBmaW5hbCBzdGF0ZSBpcyB3aGVuIHRoZSBET00gZWxlbWVudAogKiBoYXMgbm8gQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGNsYXNzZXMgYXBwbGllZCB0byBpdC4KICoKICogPGgzPkNTUyBTdGFnZ2VyaW5nIEFuaW1hdGlvbnM8L2gzPgogKiBBIFN0YWdnZXJpbmcgYW5pbWF0aW9uIGlzIGEgY29sbGVjdGlvbiBvZiBhbmltYXRpb25zIHRoYXQgYXJlIGlzc3VlZCB3aXRoIGEgc2xpZ2h0IGRlbGF5IGluIGJldHdlZW4gZWFjaCBzdWNjZXNzaXZlIG9wZXJhdGlvbiByZXN1bHRpbmcgaW4gYQogKiBjdXJ0YWluLWxpa2UgZWZmZWN0LiBUaGUgbmdBbmltYXRlIG1vZHVsZSwgYXMgb2YgMS4yLjAsIHN1cHBvcnRzIHN0YWdnZXJpbmcgYW5pbWF0aW9ucyBhbmQgdGhlIHN0YWdnZXIgZWZmZWN0IGNhbiBiZQogKiBwZXJmb3JtZWQgYnkgY3JlYXRpbmcgYSAqKm5nLUVWRU5ULXN0YWdnZXIqKiBDU1MgY2xhc3MgYW5kIGF0dGFjaGluZyB0aGF0IGNsYXNzIHRvIHRoZSBiYXNlIENTUyBjbGFzcyB1c2VkIGZvcgogKiB0aGUgYW5pbWF0aW9uLiBUaGUgc3R5bGUgcHJvcGVydHkgZXhwZWN0ZWQgd2l0aGluIHRoZSBzdGFnZ2VyIGNsYXNzIGNhbiBlaXRoZXIgYmUgYSAqKnRyYW5zaXRpb24tZGVsYXkqKiBvciBhbgogKiAqKmFuaW1hdGlvbi1kZWxheSoqIHByb3BlcnR5IChvciBib3RoIGlmIHlvdXIgYW5pbWF0aW9uIGNvbnRhaW5zIGJvdGggdHJhbnNpdGlvbnMgYW5kIGtleWZyYW1lIGFuaW1hdGlvbnMpLgogKgogKiBgYGBjc3MKICogLm15LWFuaW1hdGlvbi5uZy1lbnRlciB7CiAqICAgLyYjNDI7IHN0YW5kYXJkIHRyYW5zaXRpb24gY29kZSAmIzQyOy8KICogICAtd2Via2l0LXRyYW5zaXRpb246IDFzIGxpbmVhciBhbGw7CiAqICAgdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsKICogICBvcGFjaXR5OjA7CiAqIH0KICogLm15LWFuaW1hdGlvbi5uZy1lbnRlci1zdGFnZ2VyIHsKICogICAvJiM0MjsgdGhpcyB3aWxsIGhhdmUgYSAxMDBtcyBkZWxheSBiZXR3ZWVuIGVhY2ggc3VjY2Vzc2l2ZSBsZWF2ZSBhbmltYXRpb24gJiM0MjsvCiAqICAgLXdlYmtpdC10cmFuc2l0aW9uLWRlbGF5OiAwLjFzOwogKiAgIHRyYW5zaXRpb24tZGVsYXk6IDAuMXM7CiAqCiAqICAgLyYjNDI7IGluIGNhc2UgdGhlIHN0YWdnZXIgZG9lc24ndCB3b3JrIHRoZW4gdGhlc2UgdHdvIHZhbHVlcwogKiAgICBtdXN0IGJlIHNldCB0byAwIHRvIGF2b2lkIGFuIGFjY2lkZW50YWwgQ1NTIGluaGVyaXRhbmNlICYjNDI7LwogKiAgIC13ZWJraXQtdHJhbnNpdGlvbi1kdXJhdGlvbjogMHM7CiAqICAgdHJhbnNpdGlvbi1kdXJhdGlvbjogMHM7CiAqIH0KICogLm15LWFuaW1hdGlvbi5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogKiAgIC8mIzQyOyBzdGFuZGFyZCB0cmFuc2l0aW9uIHN0eWxlcyAmIzQyOy8KICogICBvcGFjaXR5OjE7CiAqIH0KICogYGBgCiAqCiAqIFN0YWdnZXJpbmcgYW5pbWF0aW9ucyB3b3JrIGJ5IGRlZmF1bHQgaW4gbmdSZXBlYXQgKHNvIGxvbmcgYXMgdGhlIENTUyBjbGFzcyBpcyBkZWZpbmVkKS4gT3V0c2lkZSBvZiBuZ1JlcGVhdCwgdG8gdXNlIHN0YWdnZXJpbmcgYW5pbWF0aW9ucwogKiBvbiB5b3VyIG93biwgdGhleSBjYW4gYmUgdHJpZ2dlcmVkIGJ5IGZpcmluZyBtdWx0aXBsZSBjYWxscyB0byB0aGUgc2FtZSBldmVudCBvbiAkYW5pbWF0ZS4gSG93ZXZlciwgdGhlIHJlc3RyaWN0aW9ucyBzdXJyb3VuZGluZyB0aGlzCiAqIGFyZSB0aGF0IGVhY2ggb2YgdGhlIGVsZW1lbnRzIG11c3QgaGF2ZSB0aGUgc2FtZSBDU1MgY2xhc3NOYW1lIHZhbHVlIGFzIHdlbGwgYXMgdGhlIHNhbWUgcGFyZW50IGVsZW1lbnQuIEEgc3RhZ2dlciBvcGVyYXRpb24KICogd2lsbCBhbHNvIGJlIHJlc2V0IGlmIG1vcmUgdGhhbiAxMG1zIGhhcyBwYXNzZWQgYWZ0ZXIgdGhlIGxhc3QgYW5pbWF0aW9uIGhhcyBiZWVuIGZpcmVkLgogKgogKiBUaGUgZm9sbG93aW5nIGNvZGUgd2lsbCBpc3N1ZSB0aGUgKipuZy1sZWF2ZS1zdGFnZ2VyKiogZXZlbnQgb24gdGhlIGVsZW1lbnQgcHJvdmlkZWQ6CiAqCiAqIGBgYGpzCiAqIHZhciBraWRzID0gcGFyZW50LmNoaWxkcmVuKCk7CiAqCiAqICRhbmltYXRlLmxlYXZlKGtpZHNbMF0pOyAvL3N0YWdnZXIgaW5kZXg9MAogKiAkYW5pbWF0ZS5sZWF2ZShraWRzWzFdKTsgLy9zdGFnZ2VyIGluZGV4PTEKICogJGFuaW1hdGUubGVhdmUoa2lkc1syXSk7IC8vc3RhZ2dlciBpbmRleD0yCiAqICRhbmltYXRlLmxlYXZlKGtpZHNbM10pOyAvL3N0YWdnZXIgaW5kZXg9MwogKiAkYW5pbWF0ZS5sZWF2ZShraWRzWzRdKTsgLy9zdGFnZ2VyIGluZGV4PTQKICoKICogJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgLy9zdGFnZ2VyIGhhcyByZXNldCBpdHNlbGYKICogICAkYW5pbWF0ZS5sZWF2ZShraWRzWzVdKTsgLy9zdGFnZ2VyIGluZGV4PTAKICogICAkYW5pbWF0ZS5sZWF2ZShraWRzWzZdKTsgLy9zdGFnZ2VyIGluZGV4PTEKICogfSwgMTAwLCBmYWxzZSk7CiAqIGBgYAogKgogKiBTdGFnZ2VyIGFuaW1hdGlvbnMgYXJlIGN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCB3aXRoaW4gQ1NTLWRlZmluZWQgYW5pbWF0aW9ucy4KICoKICogPGgyPkphdmFTY3JpcHQtZGVmaW5lZCBBbmltYXRpb25zPC9oMj4KICogSW4gdGhlIGV2ZW50IHRoYXQgeW91IGRvIG5vdCB3YW50IHRvIHVzZSBDU1MzIHRyYW5zaXRpb25zIG9yIENTUzMgYW5pbWF0aW9ucyBvciBpZiB5b3Ugd2lzaCB0byBvZmZlciBhbmltYXRpb25zIG9uIGJyb3dzZXJzIHRoYXQgZG8gbm90CiAqIHlldCBzdXBwb3J0IENTUyB0cmFuc2l0aW9ucy9hbmltYXRpb25zLCB0aGVuIHlvdSBjYW4gbWFrZSB1c2Ugb2YgSmF2YVNjcmlwdCBhbmltYXRpb25zIGRlZmluZWQgaW5zaWRlIG9mIHlvdXIgQW5ndWxhckpTIG1vZHVsZS4KICoKICogYGBganMKICogLy8hYW5ub3RhdGU9IllvdXJBcHAiIFlvdXIgQW5ndWxhckpTIE1vZHVsZXxSZXBsYWNlIHRoaXMgb3IgbmdNb2R1bGUgd2l0aCB0aGUgbW9kdWxlIHRoYXQgeW91IHVzZWQgdG8gZGVmaW5lIHlvdXIgYXBwbGljYXRpb24uCiAqIHZhciBuZ01vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKCdZb3VyQXBwJywgWyduZ0FuaW1hdGUnXSk7CiAqIG5nTW9kdWxlLmFuaW1hdGlvbignLm15LWNyYXp5LWFuaW1hdGlvbicsIGZ1bmN0aW9uKCkgewogKiAgIHJldHVybiB7CiAqICAgICBlbnRlcjogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogKiAgICAgICAvL3J1biB0aGUgYW5pbWF0aW9uIGhlcmUgYW5kIGNhbGwgZG9uZSB3aGVuIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUKICogICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbmNlbGxlZCkgewogKiAgICAgICAgIC8vdGhpcyAob3B0aW9uYWwpIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIGFuaW1hdGlvbgogKiAgICAgICAgIC8vY29tcGxldGVzIG9yIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBjYW5jZWxsZWQgKHRoZSBjYW5jZWxsZWQKICogICAgICAgICAvL2ZsYWcgd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiBjYW5jZWxsZWQpLgogKiAgICAgICB9OwogKiAgICAgfSwKICogICAgIGxlYXZlOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7IH0sCiAqICAgICBtb3ZlOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYmVmb3JlIHRoZSBjbGFzcyBpcyBhZGRlZAogKiAgICAgYmVmb3JlQWRkQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBjbGFzcyBpcyBhZGRlZAogKiAgICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGJlZm9yZSB0aGUgY2xhc3MgaXMgcmVtb3ZlZAogKiAgICAgYmVmb3JlUmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBjbGFzcyBpcyByZW1vdmVkCiAqICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0KICogICB9OwogKiB9KTsKICogYGBgCiAqCiAqIEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIGFyZSBjcmVhdGVkIHdpdGggYSBDU1MtbGlrZSBjbGFzcyBzZWxlY3RvciBhbmQgYSBjb2xsZWN0aW9uIG9mIGV2ZW50cyB3aGljaCBhcmUgc2V0IHRvIHJ1bgogKiBhIGphdmFzY3JpcHQgY2FsbGJhY2sgZnVuY3Rpb24uIFdoZW4gYW4gYW5pbWF0aW9uIGlzIHRyaWdnZXJlZCwgJGFuaW1hdGUgd2lsbCBsb29rIGZvciBhIG1hdGNoaW5nIGFuaW1hdGlvbiB3aGljaCBmaXRzCiAqIHRoZSBlbGVtZW50J3MgQ1NTIGNsYXNzIGF0dHJpYnV0ZSB2YWx1ZSBhbmQgdGhlbiBydW4gdGhlIG1hdGNoaW5nIGFuaW1hdGlvbiBldmVudCBmdW5jdGlvbiAoaWYgZm91bmQpLgogKiBJbiBvdGhlciB3b3JkcywgaWYgdGhlIENTUyBjbGFzc2VzIHByZXNlbnQgb24gdGhlIGFuaW1hdGVkIGVsZW1lbnQgbWF0Y2ggYW55IG9mIHRoZSBKYXZhU2NyaXB0IGFuaW1hdGlvbnMgdGhlbiB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbAogKiBiZSBleGVjdXRlZC4gSXQgc2hvdWxkIGJlIGFsc28gbm90ZWQgdGhhdCBvbmx5IHNpbXBsZSwgc2luZ2xlIGNsYXNzIHNlbGVjdG9ycyBhcmUgYWxsb3dlZCAoY29tcG91bmQgY2xhc3Mgc2VsZWN0b3JzIGFyZSBub3Qgc3VwcG9ydGVkKS4KICoKICogV2l0aGluIGEgSmF2YVNjcmlwdCBhbmltYXRpb24sIGFuIG9iamVjdCBjb250YWluaW5nIHZhcmlvdXMgZXZlbnQgY2FsbGJhY2sgYW5pbWF0aW9uIGZ1bmN0aW9ucyBpcyBleHBlY3RlZCB0byBiZSByZXR1cm5lZC4KICogQXMgZXhwbGFpbmVkIGFib3ZlLCB0aGVzZSBjYWxsYmFja3MgYXJlIHRyaWdnZXJlZCBiYXNlZCBvbiB0aGUgYW5pbWF0aW9uIGV2ZW50LiBUaGVyZWZvcmUgaWYgYW4gZW50ZXIgYW5pbWF0aW9uIGlzIHJ1biwKICogYW5kIHRoZSBKYXZhU2NyaXB0IGFuaW1hdGlvbiBpcyBmb3VuZCwgdGhlbiB0aGUgZW50ZXIgY2FsbGJhY2sgd2lsbCBoYW5kbGUgdGhhdCBhbmltYXRpb24gKGluIGFkZGl0aW9uIHRvIHRoZSBDU1Mga2V5ZnJhbWUgYW5pbWF0aW9uCiAqIG9yIHRyYW5zaXRpb24gY29kZSB0aGF0IGlzIGRlZmluZWQgdmlhIGEgc3R5bGVzaGVldCkuCiAqCiAqLwoKYW5ndWxhci5tb2R1bGUoJ25nQW5pbWF0ZScsIFsnbmcnXSkKCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJGFuaW1hdGVQcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogVGhlIGAkYW5pbWF0ZVByb3ZpZGVyYCBhbGxvd3MgZGV2ZWxvcGVycyB0byByZWdpc3RlciBKYXZhU2NyaXB0IGFuaW1hdGlvbiBldmVudCBoYW5kbGVycyBkaXJlY3RseSBpbnNpZGUgb2YgYSBtb2R1bGUuCiAgICogV2hlbiBhbiBhbmltYXRpb24gaXMgdHJpZ2dlcmVkLCB0aGUgJGFuaW1hdGUgc2VydmljZSB3aWxsIHF1ZXJ5IHRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHRvIGZpbmQgYW55IGFuaW1hdGlvbnMgdGhhdCBtYXRjaAogICAqIHRoZSBwcm92aWRlZCBuYW1lIHZhbHVlLgogICAqCiAgICogUmVxdWlyZXMgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSB0byBiZSBpbnN0YWxsZWQuCiAgICoKICAgKiBQbGVhc2UgdmlzaXQgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSBvdmVydmlldyBwYWdlIGxlYXJuIG1vcmUgYWJvdXQgaG93IHRvIHVzZSBhbmltYXRpb25zIGluIHlvdXIgYXBwbGljYXRpb24uCiAgICoKICAgKi8KCiAgLy90aGlzIHByaXZhdGUgc2VydmljZSBpcyBvbmx5IHVzZWQgd2l0aGluIENTUy1lbmFibGVkIGFuaW1hdGlvbnMKICAvL0lFOCArIElFOSBkbyBub3Qgc3VwcG9ydCByQUYgbmF0aXZlbHksIGJ1dCB0aGF0IGlzIGZpbmUgc2luY2UgdGhleQogIC8vYWxzbyBkb24ndCBzdXBwb3J0IHRyYW5zaXRpb25zIGFuZCBrZXlmcmFtZXMgd2hpY2ggbWVhbnMgdGhhdCB0aGUgY29kZQogIC8vYmVsb3cgd2lsbCBuZXZlciBiZSB1c2VkIGJ5IHRoZSB0d28gYnJvd3NlcnMuCiAgLmZhY3RvcnkoJyQkYW5pbWF0ZVJlZmxvdycsIFsnJCRyQUYnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJCRyQUYsICRkb2N1bWVudCkgewogICAgdmFyIGJvZCA9ICRkb2N1bWVudFswXS5ib2R5OwogICAgcmV0dXJuIGZ1bmN0aW9uKGZuKSB7CiAgICAgIC8vdGhlIHJldHVybmVkIGZ1bmN0aW9uIGFjdHMgYXMgdGhlIGNhbmNlbGxhdGlvbiBmdW5jdGlvbgogICAgICByZXR1cm4gJCRyQUYoZnVuY3Rpb24oKSB7CiAgICAgICAgLy90aGUgbGluZSBiZWxvdyB3aWxsIGZvcmNlIHRoZSBicm93c2VyIHRvIHBlcmZvcm0gYSByZXBhaW50CiAgICAgICAgLy9zbyB0aGF0IGFsbCB0aGUgYW5pbWF0ZWQgZWxlbWVudHMgd2l0aGluIHRoZSBhbmltYXRpb24gZnJhbWUKICAgICAgICAvL3dpbGwgYmUgcHJvcGVybHkgdXBkYXRlZCBhbmQgZHJhd24gb24gc2NyZWVuLiBUaGlzIGlzCiAgICAgICAgLy9yZXF1aXJlZCB0byBwZXJmb3JtIG11bHRpLWNsYXNzIENTUyBiYXNlZCBhbmltYXRpb25zIHdpdGgKICAgICAgICAvL0ZpcmVmb3guIERPIE5PVCBSRU1PVkUgVEhJUyBMSU5FLgogICAgICAgIHZhciBhID0gYm9kLm9mZnNldFdpZHRoICsgMTsKICAgICAgICBmbigpOwogICAgICB9KTsKICAgIH07CiAgfV0pCgogIC5jb25maWcoWyckcHJvdmlkZScsICckYW5pbWF0ZVByb3ZpZGVyJywgZnVuY3Rpb24oJHByb3ZpZGUsICRhbmltYXRlUHJvdmlkZXIpIHsKICAgIHZhciBub29wID0gYW5ndWxhci5ub29wOwogICAgdmFyIGZvckVhY2ggPSBhbmd1bGFyLmZvckVhY2g7CiAgICB2YXIgc2VsZWN0b3JzID0gJGFuaW1hdGVQcm92aWRlci4kJHNlbGVjdG9yczsKCiAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgIHZhciBOR19BTklNQVRFX1NUQVRFID0gJyQkbmdBbmltYXRlU3RhdGUnOwogICAgdmFyIE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSA9ICduZy1hbmltYXRlJzsKICAgIHZhciByb290QW5pbWF0ZVN0YXRlID0ge3J1bm5pbmc6IHRydWV9OwoKICAgIGZ1bmN0aW9uIGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KSB7CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBlbGVtZW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGVsbSA9IGVsZW1lbnRbaV07CiAgICAgICAgaWYoZWxtLm5vZGVUeXBlID09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgcmV0dXJuIGVsbTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwcmVwYXJlRWxlbWVudChlbGVtZW50KSB7CiAgICAgIHJldHVybiBlbGVtZW50ICYmIGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgIH0KCiAgICBmdW5jdGlvbiBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCkgewogICAgICByZXR1cm4gYW5ndWxhci5lbGVtZW50KGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KSk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNNYXRjaGluZ0VsZW1lbnQoZWxtMSwgZWxtMikgewogICAgICByZXR1cm4gZXh0cmFjdEVsZW1lbnROb2RlKGVsbTEpID09IGV4dHJhY3RFbGVtZW50Tm9kZShlbG0yKTsKICAgIH0KCiAgICAkcHJvdmlkZS5kZWNvcmF0b3IoJyRhbmltYXRlJywgWyckZGVsZWdhdGUnLCAnJGluamVjdG9yJywgJyRzbmlmZmVyJywgJyRyb290RWxlbWVudCcsICckJGFzeW5jQ2FsbGJhY2snLCAnJHJvb3RTY29wZScsICckZG9jdW1lbnQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oJGRlbGVnYXRlLCAgICRpbmplY3RvciwgICAkc25pZmZlciwgICAkcm9vdEVsZW1lbnQsICAgJCRhc3luY0NhbGxiYWNrLCAgICAkcm9vdFNjb3BlLCAgICRkb2N1bWVudCkgewoKICAgICAgdmFyIGdsb2JhbEFuaW1hdGlvbkNvdW50ZXIgPSAwOwogICAgICAkcm9vdEVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCByb290QW5pbWF0ZVN0YXRlKTsKCiAgICAgIC8vIGRpc2FibGUgYW5pbWF0aW9ucyBkdXJpbmcgYm9vdHN0cmFwLCBidXQgb25jZSB3ZSBib290c3RyYXBwZWQsIHdhaXQgYWdhaW4KICAgICAgLy8gZm9yIGFub3RoZXIgZGlnZXN0IHVudGlsIGVuYWJsaW5nIGFuaW1hdGlvbnMuIFRoZSByZWFzb24gd2h5IHdlIGRpZ2VzdCB0d2ljZQogICAgICAvLyBpcyBiZWNhdXNlIGFsbCBzdHJ1Y3R1cmFsIGFuaW1hdGlvbnMgKGVudGVyLCBsZWF2ZSBhbmQgbW92ZSkgYWxsIHBlcmZvcm0gYQogICAgICAvLyBwb3N0IGRpZ2VzdCBvcGVyYXRpb24gYmVmb3JlIGFuaW1hdGluZy4gSWYgd2Ugb25seSB3YWl0IGZvciBhIHNpbmdsZSBkaWdlc3QKICAgICAgLy8gdG8gcGFzcyB0aGVuIHRoZSBzdHJ1Y3R1cmFsIGFuaW1hdGlvbiB3b3VsZCByZW5kZXIgaXRzIGFuaW1hdGlvbiBvbiBwYWdlIGxvYWQuCiAgICAgIC8vICh3aGljaCBpcyB3aGF0IHdlJ3JlIHRyeWluZyB0byBhdm9pZCB3aGVuIHRoZSBhcHBsaWNhdGlvbiBmaXJzdCBib290cyB1cC4pCiAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgdmFyIGNsYXNzTmFtZUZpbHRlciA9ICRhbmltYXRlUHJvdmlkZXIuY2xhc3NOYW1lRmlsdGVyKCk7CiAgICAgIHZhciBpc0FuaW1hdGFibGVDbGFzc05hbWUgPSAhY2xhc3NOYW1lRmlsdGVyCiAgICAgICAgICAgICAgPyBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH0KICAgICAgICAgICAgICA6IGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNsYXNzTmFtZUZpbHRlci50ZXN0KGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIGxvb2t1cChuYW1lKSB7CiAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgIHZhciBtYXRjaGVzID0gW10sCiAgICAgICAgICAgICAgZmxhZ01hcCA9IHt9LAogICAgICAgICAgICAgIGNsYXNzZXMgPSBuYW1lLnN1YnN0cigxKS5zcGxpdCgnLicpOwoKICAgICAgICAgIC8vdGhlIGVtcHR5IHN0cmluZyB2YWx1ZSBpcyB0aGUgZGVmYXVsdCBhbmltYXRpb24KICAgICAgICAgIC8vb3BlcmF0aW9uIHdoaWNoIHBlcmZvcm1zIENTUyB0cmFuc2l0aW9uIGFuZCBrZXlmcmFtZQogICAgICAgICAgLy9hbmltYXRpb25zIHNuaWZmaW5nLiBUaGlzIGlzIGFsd2F5cyBpbmNsdWRlZCBmb3IgZWFjaAogICAgICAgICAgLy9lbGVtZW50IGFuaW1hdGlvbiBwcm9jZWR1cmUgaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMKICAgICAgICAgIC8vdHJhbnNpdGlvbnMgYW5kL29yIGtleWZyYW1lIGFuaW1hdGlvbnMuIFRoZSBkZWZhdWx0CiAgICAgICAgICAvL2FuaW1hdGlvbiBpcyBhZGRlZCB0byB0aGUgdG9wIG9mIHRoZSBsaXN0IHRvIHByZXZlbnQKICAgICAgICAgIC8vYW55IHByZXZpb3VzIGFuaW1hdGlvbnMgZnJvbSBhZmZlY3RpbmcgdGhlIGVsZW1lbnQgc3R5bGluZwogICAgICAgICAgLy9wcmlvciB0byB0aGUgZWxlbWVudCBiZWluZyBhbmltYXRlZC4KICAgICAgICAgIGlmICgkc25pZmZlci50cmFuc2l0aW9ucyB8fCAkc25pZmZlci5hbmltYXRpb25zKSB7CiAgICAgICAgICAgIG1hdGNoZXMucHVzaCgkaW5qZWN0b3IuZ2V0KHNlbGVjdG9yc1snJ10pKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmb3IodmFyIGk9MDsgaSA8IGNsYXNzZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtsYXNzID0gY2xhc3Nlc1tpXSwKICAgICAgICAgICAgICAgIHNlbGVjdG9yRmFjdG9yeU5hbWUgPSBzZWxlY3RvcnNba2xhc3NdOwogICAgICAgICAgICBpZihzZWxlY3RvckZhY3RvcnlOYW1lICYmICFmbGFnTWFwW2tsYXNzXSkgewogICAgICAgICAgICAgIG1hdGNoZXMucHVzaCgkaW5qZWN0b3IuZ2V0KHNlbGVjdG9yRmFjdG9yeU5hbWUpKTsKICAgICAgICAgICAgICBmbGFnTWFwW2tsYXNzXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaGVzOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0aW9uUnVubmVyKGVsZW1lbnQsIGFuaW1hdGlvbkV2ZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAvL3RyYW5zY2x1ZGVkIGRpcmVjdGl2ZXMgbWF5IHNvbWV0aW1lcyBmaXJlIGFuIGFuaW1hdGlvbiB1c2luZyBvbmx5IGNvbW1lbnQgbm9kZXMKICAgICAgICAvL2Jlc3QgdG8gY2F0Y2ggdGhpcyBlYXJseSBvbiB0byBwcmV2ZW50IGFueSBhbmltYXRpb24gb3BlcmF0aW9ucyBmcm9tIG9jY3VycmluZwogICAgICAgIHZhciBub2RlID0gZWxlbWVudFswXTsKICAgICAgICBpZighbm9kZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGlzU2V0Q2xhc3NPcGVyYXRpb24gPSBhbmltYXRpb25FdmVudCA9PSAnc2V0Q2xhc3MnOwogICAgICAgIHZhciBpc0NsYXNzQmFzZWQgPSBpc1NldENsYXNzT3BlcmF0aW9uIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbkV2ZW50ID09ICdhZGRDbGFzcycgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uRXZlbnQgPT0gJ3JlbW92ZUNsYXNzJzsKCiAgICAgICAgdmFyIGNsYXNzTmFtZUFkZCwgY2xhc3NOYW1lUmVtb3ZlOwogICAgICAgIGlmKGFuZ3VsYXIuaXNBcnJheShjbGFzc05hbWUpKSB7CiAgICAgICAgICBjbGFzc05hbWVBZGQgPSBjbGFzc05hbWVbMF07CiAgICAgICAgICBjbGFzc05hbWVSZW1vdmUgPSBjbGFzc05hbWVbMV07CiAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWVBZGQgKyAnICcgKyBjbGFzc05hbWVSZW1vdmU7CiAgICAgICAgfQoKICAgICAgICB2YXIgY3VycmVudENsYXNzTmFtZSA9IGVsZW1lbnQuYXR0cignY2xhc3MnKTsKICAgICAgICB2YXIgY2xhc3NlcyA9IGN1cnJlbnRDbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWU7CiAgICAgICAgaWYoIWlzQW5pbWF0YWJsZUNsYXNzTmFtZShjbGFzc2VzKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJlZm9yZUNvbXBsZXRlID0gbm9vcCwKICAgICAgICAgICAgYmVmb3JlQ2FuY2VsID0gW10sCiAgICAgICAgICAgIGJlZm9yZSA9IFtdLAogICAgICAgICAgICBhZnRlckNvbXBsZXRlID0gbm9vcCwKICAgICAgICAgICAgYWZ0ZXJDYW5jZWwgPSBbXSwKICAgICAgICAgICAgYWZ0ZXIgPSBbXTsKCiAgICAgICAgdmFyIGFuaW1hdGlvbkxvb2t1cCA9ICgnICcgKyBjbGFzc2VzKS5yZXBsYWNlKC9ccysvZywnLicpOwogICAgICAgIGZvckVhY2gobG9va3VwKGFuaW1hdGlvbkxvb2t1cCksIGZ1bmN0aW9uKGFuaW1hdGlvbkZhY3RvcnkpIHsKICAgICAgICAgIHZhciBjcmVhdGVkID0gcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgYW5pbWF0aW9uRXZlbnQpOwogICAgICAgICAgaWYoIWNyZWF0ZWQgJiYgaXNTZXRDbGFzc09wZXJhdGlvbikgewogICAgICAgICAgICByZWdpc3RlckFuaW1hdGlvbihhbmltYXRpb25GYWN0b3J5LCAnYWRkQ2xhc3MnKTsKICAgICAgICAgICAgcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgJ3JlbW92ZUNsYXNzJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyQW5pbWF0aW9uKGFuaW1hdGlvbkZhY3RvcnksIGV2ZW50KSB7CiAgICAgICAgICB2YXIgYWZ0ZXJGbiA9IGFuaW1hdGlvbkZhY3RvcnlbZXZlbnRdOwogICAgICAgICAgdmFyIGJlZm9yZUZuID0gYW5pbWF0aW9uRmFjdG9yeVsnYmVmb3JlJyArIGV2ZW50LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgZXZlbnQuc3Vic3RyKDEpXTsKICAgICAgICAgIGlmKGFmdGVyRm4gfHwgYmVmb3JlRm4pIHsKICAgICAgICAgICAgaWYoZXZlbnQgPT0gJ2xlYXZlJykgewogICAgICAgICAgICAgIGJlZm9yZUZuID0gYWZ0ZXJGbjsKICAgICAgICAgICAgICAvL3doZW4gc2V0IGFzIG51bGwgdGhlbiBhbmltYXRpb24ga25vd3MgdG8gc2tpcCB0aGlzIHBoYXNlCiAgICAgICAgICAgICAgYWZ0ZXJGbiA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWZ0ZXIucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQgOiBldmVudCwgZm4gOiBhZnRlckZuCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBiZWZvcmUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQgOiBldmVudCwgZm4gOiBiZWZvcmVGbgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBydW4oZm5zLCBjYW5jZWxsYXRpb25zLCBhbGxDb21wbGV0ZUZuKSB7CiAgICAgICAgICB2YXIgYW5pbWF0aW9ucyA9IFtdOwogICAgICAgICAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uKGFuaW1hdGlvbikgewogICAgICAgICAgICBhbmltYXRpb24uZm4gJiYgYW5pbWF0aW9ucy5wdXNoKGFuaW1hdGlvbik7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgZnVuY3Rpb24gYWZ0ZXJBbmltYXRpb25Db21wbGV0ZShpbmRleCkgewogICAgICAgICAgICBpZihjYW5jZWxsYXRpb25zKSB7CiAgICAgICAgICAgICAgKGNhbmNlbGxhdGlvbnNbaW5kZXhdIHx8IG5vb3ApKCk7CiAgICAgICAgICAgICAgaWYoKytjb3VudCA8IGFuaW1hdGlvbnMubGVuZ3RoKSByZXR1cm47CiAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vVGhlIGNvZGUgYmVsb3cgYWRkcyBkaXJlY3RseSB0byB0aGUgYXJyYXkgaW4gb3JkZXIgdG8gd29yayB3aXRoCiAgICAgICAgICAvL2JvdGggc3luYyBhbmQgYXN5bmMgYW5pbWF0aW9ucy4gU3luYyBhbmltYXRpb25zIGFyZSB3aGVuIHRoZSBkb25lKCkKICAgICAgICAgIC8vb3BlcmF0aW9uIGlzIGNhbGxlZCByaWdodCBhd2F5LiBETyBOT1QgUkVGQUNUT1IhCiAgICAgICAgICBmb3JFYWNoKGFuaW1hdGlvbnMsIGZ1bmN0aW9uKGFuaW1hdGlvbiwgaW5kZXgpIHsKICAgICAgICAgICAgdmFyIHByb2dyZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgYWZ0ZXJBbmltYXRpb25Db21wbGV0ZShpbmRleCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN3aXRjaChhbmltYXRpb24uZXZlbnQpIHsKICAgICAgICAgICAgICBjYXNlICdzZXRDbGFzcyc6CiAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIGNsYXNzTmFtZUFkZCwgY2xhc3NOYW1lUmVtb3ZlLCBwcm9ncmVzcykpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnYWRkQ2xhc3MnOgogICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucy5wdXNoKGFuaW1hdGlvbi5mbihlbGVtZW50LCBjbGFzc05hbWVBZGQgfHwgY2xhc3NOYW1lLCAgICAgcHJvZ3Jlc3MpKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ3JlbW92ZUNsYXNzJzoKICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMucHVzaChhbmltYXRpb24uZm4oZWxlbWVudCwgY2xhc3NOYW1lUmVtb3ZlIHx8IGNsYXNzTmFtZSwgIHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucy5wdXNoKGFuaW1hdGlvbi5mbihlbGVtZW50LCBwcm9ncmVzcykpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmKGNhbmNlbGxhdGlvbnMgJiYgY2FuY2VsbGF0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG5vZGUgOiBub2RlLAogICAgICAgICAgZXZlbnQgOiBhbmltYXRpb25FdmVudCwKICAgICAgICAgIGNsYXNzTmFtZSA6IGNsYXNzTmFtZSwKICAgICAgICAgIGlzQ2xhc3NCYXNlZCA6IGlzQ2xhc3NCYXNlZCwKICAgICAgICAgIGlzU2V0Q2xhc3NPcGVyYXRpb24gOiBpc1NldENsYXNzT3BlcmF0aW9uLAogICAgICAgICAgYmVmb3JlIDogZnVuY3Rpb24oYWxsQ29tcGxldGVGbikgewogICAgICAgICAgICBiZWZvcmVDb21wbGV0ZSA9IGFsbENvbXBsZXRlRm47CiAgICAgICAgICAgIHJ1bihiZWZvcmUsIGJlZm9yZUNhbmNlbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgYmVmb3JlQ29tcGxldGUgPSBub29wOwogICAgICAgICAgICAgIGFsbENvbXBsZXRlRm4oKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgYWZ0ZXIgOiBmdW5jdGlvbihhbGxDb21wbGV0ZUZuKSB7CiAgICAgICAgICAgIGFmdGVyQ29tcGxldGUgPSBhbGxDb21wbGV0ZUZuOwogICAgICAgICAgICBydW4oYWZ0ZXIsIGFmdGVyQ2FuY2VsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBhZnRlckNvbXBsZXRlID0gbm9vcDsKICAgICAgICAgICAgICBhbGxDb21wbGV0ZUZuKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIGNhbmNlbCA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZihiZWZvcmVDYW5jZWwpIHsKICAgICAgICAgICAgICBmb3JFYWNoKGJlZm9yZUNhbmNlbCwgZnVuY3Rpb24oY2FuY2VsRm4pIHsKICAgICAgICAgICAgICAgIChjYW5jZWxGbiB8fCBub29wKSh0cnVlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBiZWZvcmVDb21wbGV0ZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihhZnRlckNhbmNlbCkgewogICAgICAgICAgICAgIGZvckVhY2goYWZ0ZXJDYW5jZWwsIGZ1bmN0aW9uKGNhbmNlbEZuKSB7CiAgICAgICAgICAgICAgICAoY2FuY2VsRm4gfHwgbm9vcCkodHJ1ZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICAgKiBAbmFtZSAkYW5pbWF0ZQogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogVGhlIGAkYW5pbWF0ZWAgc2VydmljZSBwcm92aWRlcyBhbmltYXRpb24gZGV0ZWN0aW9uIHN1cHBvcnQgd2hpbGUgcGVyZm9ybWluZyBET00gb3BlcmF0aW9ucyAoZW50ZXIsIGxlYXZlIGFuZCBtb3ZlKSBhcyB3ZWxsIGFzIGR1cmluZyBhZGRDbGFzcyBhbmQgcmVtb3ZlQ2xhc3Mgb3BlcmF0aW9ucy4KICAgICAgICogV2hlbiBhbnkgb2YgdGhlc2Ugb3BlcmF0aW9ucyBhcmUgcnVuLCB0aGUgJGFuaW1hdGUgc2VydmljZQogICAgICAgKiB3aWxsIGV4YW1pbmUgYW55IEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zICh3aGljaCBhcmUgZGVmaW5lZCBieSB1c2luZyB0aGUgJGFuaW1hdGVQcm92aWRlciBwcm92aWRlciBvYmplY3QpCiAgICAgICAqIGFzIHdlbGwgYXMgYW55IENTUy1kZWZpbmVkIGFuaW1hdGlvbnMgYWdhaW5zdCB0aGUgQ1NTIGNsYXNzZXMgcHJlc2VudCBvbiB0aGUgZWxlbWVudCBvbmNlIHRoZSBET00gb3BlcmF0aW9uIGlzIHJ1bi4KICAgICAgICoKICAgICAgICogVGhlIGAkYW5pbWF0ZWAgc2VydmljZSBpcyB1c2VkIGJlaGluZCB0aGUgc2NlbmVzIHdpdGggcHJlLWV4aXN0aW5nIGRpcmVjdGl2ZXMgYW5kIGFuaW1hdGlvbiB3aXRoIHRoZXNlIGRpcmVjdGl2ZXMKICAgICAgICogd2lsbCB3b3JrIG91dCBvZiB0aGUgYm94IHdpdGhvdXQgYW55IGV4dHJhIGNvbmZpZ3VyYXRpb24uCiAgICAgICAqCiAgICAgICAqIFJlcXVpcmVzIHRoZSB7QGxpbmsgbmdBbmltYXRlIGBuZ0FuaW1hdGVgfSBtb2R1bGUgdG8gYmUgaW5zdGFsbGVkLgogICAgICAgKgogICAgICAgKiBQbGVhc2UgdmlzaXQgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSBvdmVydmlldyBwYWdlIGxlYXJuIG1vcmUgYWJvdXQgaG93IHRvIHVzZSBhbmltYXRpb25zIGluIHlvdXIgYXBwbGljYXRpb24uCiAgICAgICAqCiAgICAgICAqLwogICAgICByZXR1cm4gewogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNlbnRlcgogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBBcHBlbmRzIHRoZSBlbGVtZW50IHRvIHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgdGhhdCByZXNpZGVzIGluIHRoZSBkb2N1bWVudCBhbmQgdGhlbiBydW5zIHRoZSBlbnRlciBhbmltYXRpb24uIE9uY2UKICAgICAgICAgKiB0aGUgYW5pbWF0aW9uIGlzIHN0YXJ0ZWQsIHRoZSBmb2xsb3dpbmcgQ1NTIGNsYXNzZXMgd2lsbCBiZSBwcmVzZW50IG9uIHRoZSBlbGVtZW50IGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgZW50ZXIgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgKiB8IDEuICRhbmltYXRlLmVudGVyKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAyLiBlbGVtZW50IGlzIGluc2VydGVkIGludG8gdGhlIHBhcmVudEVsZW1lbnQgZWxlbWVudCBvciBiZXNpZGUgdGhlIGFmdGVyRWxlbWVudCBlbGVtZW50ICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gJGFuaW1hdGUgcnVucyBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDQuIHRoZSAubmctZW50ZXIgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIiAgICB8CiAgICAgICAgICogfCA1LiAkYW5pbWF0ZSBzY2FucyB0aGUgZWxlbWVudCBzdHlsZXMgdG8gZ2V0IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gZHVyYXRpb24gYW5kIGRlbGF5ICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1lbnRlciIgICAgfAogICAgICAgICAqIHwgNi4gJGFuaW1hdGUgd2FpdHMgZm9yIDEwbXMgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIiICAgIHwKICAgICAgICAgKiB8IDcuIHRoZSAubmctZW50ZXItYWN0aXZlIGFuZCAubmctYW5pbWF0ZS1hY3RpdmUgY2xhc3NlcyBhcmUgYWRkZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgbmctZW50ZXIgbmctZW50ZXItYWN0aXZlIiB8CiAgICAgICAgICogfCA4LiAkYW5pbWF0ZSB3YWl0cyBmb3IgWCBtaWxsaXNlY29uZHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1lbnRlciBuZy1lbnRlci1hY3RpdmUiIHwKICAgICAgICAgKiB8IDkuIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMC4gVGhlIGRvbmVDYWxsYmFjaygpIGNhbGxiYWNrIGlzIGZpcmVkIChpZiBwcm92aWRlZCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGVudGVyIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50RWxlbWVudCB0aGUgcGFyZW50IGVsZW1lbnQgb2YgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgZW50ZXIgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlckVsZW1lbnQgdGhlIHNpYmxpbmcgZWxlbWVudCAod2hpY2ggaXMgdGhlIHByZXZpb3VzIGVsZW1lbnQpIG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGVudGVyIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKT19IGRvbmVDYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBvbmNlIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUKICAgICAgICAqLwogICAgICAgIGVudGVyIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBkb25lQ2FsbGJhY2spIHsKICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBwYXJlbnRFbGVtZW50ID0gcHJlcGFyZUVsZW1lbnQocGFyZW50RWxlbWVudCk7CiAgICAgICAgICBhZnRlckVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChhZnRlckVsZW1lbnQpOwoKICAgICAgICAgIHRoaXMuZW5hYmxlZChmYWxzZSwgZWxlbWVudCk7CiAgICAgICAgICAkZGVsZWdhdGUuZW50ZXIoZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50KTsKICAgICAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdlbnRlcicsICduZy1lbnRlcicsIGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCwgbm9vcCwgZG9uZUNhbGxiYWNrKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNsZWF2ZQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSdW5zIHRoZSBsZWF2ZSBhbmltYXRpb24gb3BlcmF0aW9uIGFuZCwgdXBvbiBjb21wbGV0aW9uLCByZW1vdmVzIHRoZSBlbGVtZW50IGZyb20gdGhlIERPTS4gT25jZQogICAgICAgICAqIHRoZSBhbmltYXRpb24gaXMgc3RhcnRlZCwgdGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyB3aWxsIGJlIGFkZGVkIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgbGVhdmUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgKiB8IDEuICRhbmltYXRlLmxlYXZlKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAyLiAkYW5pbWF0ZSBydW5zIGFueSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gdGhlIC5uZy1sZWF2ZSBjbGFzcyBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbGVhdmUiICAgIHwKICAgICAgICAgKiB8IDQuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZlIiAgICB8CiAgICAgICAgICogfCA1LiAkYW5pbWF0ZSB3YWl0cyBmb3IgMTBtcyAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1sZWF2ZSIgICAgfAogICAgICAgICAqIHwgNi4gdGhlIC5uZy1sZWF2ZS1hY3RpdmUgYW5kIC5uZy1hbmltYXRlLWFjdGl2ZSBjbGFzc2VzIGlzIGFkZGVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIG5nLWxlYXZlIG5nLWxlYXZlLWFjdGl2ZSIgfAogICAgICAgICAqIHwgNy4gJGFuaW1hdGUgd2FpdHMgZm9yIFggbWlsbGlzZWNvbmRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgbmctbGVhdmUgbmctbGVhdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCA4LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOS4gVGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCAuLi4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDEwLiBUaGUgZG9uZUNhbGxiYWNrKCkgY2FsbGJhY2sgaXMgZmlyZWQgKGlmIHByb3ZpZGVkKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgLi4uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgbGVhdmUgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICovCiAgICAgICAgbGVhdmUgOiBmdW5jdGlvbihlbGVtZW50LCBkb25lQ2FsbGJhY2spIHsKICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBjYW5jZWxDaGlsZEFuaW1hdGlvbnMoZWxlbWVudCk7CiAgICAgICAgICB0aGlzLmVuYWJsZWQoZmFsc2UsIGVsZW1lbnQpOwogICAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ2xlYXZlJywgJ25nLWxlYXZlJywgc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpLCBudWxsLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAkZGVsZWdhdGUubGVhdmUoZWxlbWVudCk7CiAgICAgICAgICAgIH0sIGRvbmVDYWxsYmFjayk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjbW92ZQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBGaXJlcyB0aGUgbW92ZSBET00gb3BlcmF0aW9uLiBKdXN0IGJlZm9yZSB0aGUgYW5pbWF0aW9uIHN0YXJ0cywgdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGVpdGhlciBhcHBlbmQgaXQgaW50byB0aGUgcGFyZW50RWxlbWVudCBjb250YWluZXIgb3IKICAgICAgICAgKiBhZGQgdGhlIGVsZW1lbnQgZGlyZWN0bHkgYWZ0ZXIgdGhlIGFmdGVyRWxlbWVudCBlbGVtZW50IGlmIHByZXNlbnQuIFRoZW4gdGhlIG1vdmUgYW5pbWF0aW9uIHdpbGwgYmUgcnVuLiBPbmNlCiAgICAgICAgICogdGhlIGFuaW1hdGlvbiBpcyBzdGFydGVkLCB0aGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIHdpbGwgYmUgYWRkZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyBtb3ZlIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlIHwKICAgICAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5tb3ZlKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gZWxlbWVudCBpcyBtb3ZlZCBpbnRvIHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgb3IgYmVzaWRlIHRoZSBhZnRlckVsZW1lbnQgZWxlbWVudCAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDMuICRhbmltYXRlIHJ1bnMgYW55IEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICB8CiAgICAgICAgICogfCA0LiB0aGUgLm5nLW1vdmUgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1tb3ZlIiAgICAgfAogICAgICAgICAqIHwgNS4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbW92ZSIgICAgIHwKICAgICAgICAgKiB8IDYuICRhbmltYXRlIHdhaXRzIGZvciAxMG1zICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmUiICAgICB8CiAgICAgICAgICogfCA3LiB0aGUgLm5nLW1vdmUtYWN0aXZlIGFuZCAubmctYW5pbWF0ZS1hY3RpdmUgY2xhc3NlcyBpcyBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1tb3ZlIG5nLW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCA4LiAkYW5pbWF0ZSB3YWl0cyBmb3IgWCBtaWxsaXNlY29uZHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1tb3ZlIG5nLW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCA5LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMTAuIFRoZSBkb25lQ2FsbGJhY2soKSBjYWxsYmFjayBpcyBmaXJlZCAoaWYgcHJvdmlkZWQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBtb3ZlIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50RWxlbWVudCB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIG1vdmUgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlckVsZW1lbnQgdGhlIHNpYmxpbmcgZWxlbWVudCAod2hpY2ggaXMgdGhlIHByZXZpb3VzIGVsZW1lbnQpIG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIG1vdmUgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICovCiAgICAgICAgbW92ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCwgZG9uZUNhbGxiYWNrKSB7CiAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgcGFyZW50RWxlbWVudCA9IHByZXBhcmVFbGVtZW50KHBhcmVudEVsZW1lbnQpOwogICAgICAgICAgYWZ0ZXJFbGVtZW50ID0gcHJlcGFyZUVsZW1lbnQoYWZ0ZXJFbGVtZW50KTsKCiAgICAgICAgICBjYW5jZWxDaGlsZEFuaW1hdGlvbnMoZWxlbWVudCk7CiAgICAgICAgICB0aGlzLmVuYWJsZWQoZmFsc2UsIGVsZW1lbnQpOwogICAgICAgICAgJGRlbGVnYXRlLm1vdmUoZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50KTsKICAgICAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdtb3ZlJywgJ25nLW1vdmUnLCBlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIG5vb3AsIGRvbmVDYWxsYmFjayk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjYWRkQ2xhc3MKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRyaWdnZXJzIGEgY3VzdG9tIGFuaW1hdGlvbiBldmVudCBiYXNlZCBvZmYgdGhlIGNsYXNzTmFtZSB2YXJpYWJsZSBhbmQgdGhlbiBhdHRhY2hlcyB0aGUgY2xhc3NOYW1lIHZhbHVlIHRvIHRoZSBlbGVtZW50IGFzIGEgQ1NTIGNsYXNzLgogICAgICAgICAqIFVubGlrZSB0aGUgb3RoZXIgYW5pbWF0aW9uIG1ldGhvZHMsIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBzdWZmaXggdGhlIGNsYXNzTmFtZSB2YWx1ZSB3aXRoIHtAdHlwZSAtYWRkfSBpbiBvcmRlciB0byBwcm92aWRlCiAgICAgICAgICogdGhlIGFuaW1hdGUgc2VydmljZSB0aGUgc2V0dXAgYW5kIGFjdGl2ZSBDU1MgY2xhc3NlcyBpbiBvcmRlciB0byB0cmlnZ2VyIHRoZSBhbmltYXRpb24gKHRoaXMgd2lsbCBiZSBza2lwcGVkIGlmIG5vIENTUyB0cmFuc2l0aW9ucwogICAgICAgICAqIG9yIGtleWZyYW1lcyBhcmUgZGVmaW5lZCBvbiB0aGUgLWFkZCBvciBiYXNlIENTUyBjbGFzcykuCiAgICAgICAgICoKICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIGFkZENsYXNzIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAqIHwgMS4gJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgJ3N1cGVyJykgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gJGFuaW1hdGUgcnVucyBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gdGhlIC5zdXBlci1hZGQgY2xhc3MgYXJlIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlci1hZGQiICAgfAogICAgICAgICAqIHwgNC4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlci1hZGQiICAgfAogICAgICAgICAqIHwgNS4gJGFuaW1hdGUgd2FpdHMgZm9yIDEwbXMgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlci1hZGQiICAgfAogICAgICAgICAqIHwgNi4gdGhlIC5zdXBlciwgLnN1cGVyLWFkZC1hY3RpdmUgYW5kIC5uZy1hbmltYXRlLWFjdGl2ZSBjbGFzc2VzIGFyZSBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBzdXBlciBzdXBlci1hZGQgc3VwZXItYWRkLWFjdGl2ZSIgICAgICAgICAgfAogICAgICAgICAqIHwgNy4gJGFuaW1hdGUgd2FpdHMgZm9yIFggbWlsbGlzZWNvbmRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgc3VwZXItYWRkIHN1cGVyLWFkZC1hY3RpdmUiICB8CiAgICAgICAgICogfCA4LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA5LiBUaGUgc3VwZXIgY2xhc3MgaXMga2VwdCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMC4gVGhlIGRvbmVDYWxsYmFjaygpIGNhbGxiYWNrIGlzIGZpcmVkIChpZiBwcm92aWRlZCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIGFuaW1hdGVkCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudCBhbmQgdGhlbiBhbmltYXRlZAogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKT19IGRvbmVDYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBvbmNlIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUKICAgICAgICAqLwogICAgICAgIGFkZENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lQ2FsbGJhY2spIHsKICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgcGVyZm9ybUFuaW1hdGlvbignYWRkQ2xhc3MnLCBjbGFzc05hbWUsIGVsZW1lbnQsIG51bGwsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkZGVsZWdhdGUuYWRkQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIH0sIGRvbmVDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI3JlbW92ZUNsYXNzCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUcmlnZ2VycyBhIGN1c3RvbSBhbmltYXRpb24gZXZlbnQgYmFzZWQgb2ZmIHRoZSBjbGFzc05hbWUgdmFyaWFibGUgYW5kIHRoZW4gcmVtb3ZlcyB0aGUgQ1NTIGNsYXNzIHByb3ZpZGVkIGJ5IHRoZSBjbGFzc05hbWUgdmFsdWUKICAgICAgICAgKiBmcm9tIHRoZSBlbGVtZW50LiBVbmxpa2UgdGhlIG90aGVyIGFuaW1hdGlvbiBtZXRob2RzLCB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgc3VmZml4IHRoZSBjbGFzc05hbWUgdmFsdWUgd2l0aCB7QHR5cGUgLXJlbW92ZX0gaW4KICAgICAgICAgKiBvcmRlciB0byBwcm92aWRlIHRoZSBhbmltYXRlIHNlcnZpY2UgdGhlIHNldHVwIGFuZCBhY3RpdmUgQ1NTIGNsYXNzZXMgaW4gb3JkZXIgdG8gdHJpZ2dlciB0aGUgYW5pbWF0aW9uICh0aGlzIHdpbGwgYmUgc2tpcHBlZCBpZgogICAgICAgICAqIG5vIENTUyB0cmFuc2l0aW9ucyBvciBrZXlmcmFtZXMgYXJlIGRlZmluZWQgb24gdGhlIC1yZW1vdmUgb3IgYmFzZSBDU1MgY2xhc3NlcykuCiAgICAgICAgICoKICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIHJlbW92ZUNsYXNzIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSAgICAgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCAnc3VwZXInKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDIuICRhbmltYXRlIHJ1bnMgYW55IEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSIgICAgICAgfAogICAgICAgICAqIHwgMy4gdGhlIC5zdXBlci1yZW1vdmUgY2xhc3MgYXJlIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSJ8CiAgICAgICAgICogfCA0LiAkYW5pbWF0ZSBzY2FucyB0aGUgZWxlbWVudCBzdHlsZXMgdG8gZ2V0IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gZHVyYXRpb24gYW5kIGRlbGF5ICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIG5nLWFuaW1hdGUgc3VwZXItcmVtb3ZlIiAgIHwKICAgICAgICAgKiB8IDUuICRhbmltYXRlIHdhaXRzIGZvciAxMG1zICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUiICAgfAogICAgICAgICAqIHwgNi4gdGhlIC5zdXBlci1yZW1vdmUtYWN0aXZlIGFuZCAubmctYW5pbWF0ZS1hY3RpdmUgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIC5zdXBlciBpcyByZW1vdmVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIHN1cGVyLXJlbW92ZSBzdXBlci1yZW1vdmUtYWN0aXZlIiAgICAgICAgICB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSB3YWl0cyBmb3IgWCBtaWxsaXNlY29uZHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgc3VwZXItcmVtb3ZlIHN1cGVyLXJlbW92ZS1hY3RpdmUiICAgfAogICAgICAgICAqIHwgOC4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA5LiBUaGUgZG9uZUNhbGxiYWNrKCkgY2FsbGJhY2sgaXMgZmlyZWQgKGlmIHByb3ZpZGVkKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSBhbmltYXRlZAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUgdGhlIENTUyBjbGFzcyB0aGF0IHdpbGwgYmUgYW5pbWF0ZWQgYW5kIHRoZW4gcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICovCiAgICAgICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIGVsZW1lbnQgPSBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdyZW1vdmVDbGFzcycsIGNsYXNzTmFtZSwgZWxlbWVudCwgbnVsbCwgbnVsbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRkZWxlZ2F0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgfSwgZG9uZUNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICoKICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjc2V0Q2xhc3MKICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgYW5kL29yIHJlbW92ZXMgdGhlIGdpdmVuIENTUyBjbGFzc2VzIHRvIGFuZCBmcm9tIHRoZSBlbGVtZW50LgogICAgICAgICAgICogT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBpdHMgQ1NTIGNsYXNzZXMgY2hhbmdlZAogICAgICAgICAgICogICByZW1vdmVkIGZyb20gaXQKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhZGQgdGhlIENTUyBjbGFzc2VzIHdoaWNoIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdmUgdGhlIENTUyBjbGFzcyB3aGljaCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZQogICAgICAgICAgICogICBDU1MgY2xhc3NlcyBoYXZlIGJlZW4gc2V0IG9uIHRoZSBlbGVtZW50CiAgICAgICAgICAgKi8KICAgICAgICBzZXRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFkZCwgcmVtb3ZlLCBkb25lQ2FsbGJhY2spIHsKICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgcGVyZm9ybUFuaW1hdGlvbignc2V0Q2xhc3MnLCBbYWRkLCByZW1vdmVdLCBlbGVtZW50LCBudWxsLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJGRlbGVnYXRlLnNldENsYXNzKGVsZW1lbnQsIGFkZCwgcmVtb3ZlKTsKICAgICAgICAgIH0sIGRvbmVDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2VuYWJsZWQKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gdmFsdWUgSWYgcHJvdmlkZWQgdGhlbiBzZXQgdGhlIGFuaW1hdGlvbiBvbiBvciBvZmYuCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IElmIHByb3ZpZGVkIHRoZW4gdGhlIGVsZW1lbnQgd2lsbCBiZSB1c2VkIHRvIHJlcHJlc2VudCB0aGUgZW5hYmxlL2Rpc2FibGUgb3BlcmF0aW9uCiAgICAgICAgICogQHJldHVybiB7Ym9vbGVhbn0gQ3VycmVudCBhbmltYXRpb24gc3RhdGUuCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBHbG9iYWxseSBlbmFibGVzL2Rpc2FibGVzIGFuaW1hdGlvbnMuCiAgICAgICAgICoKICAgICAgICAqLwogICAgICAgIGVuYWJsZWQgOiBmdW5jdGlvbih2YWx1ZSwgZWxlbWVudCkgewogICAgICAgICAgc3dpdGNoKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIGlmKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKSB8fCB7fTsKICAgICAgICAgICAgICAgIGRhdGEuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIGRhdGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZCA9ICF2YWx1ZTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHZhbHVlID0gIXJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICEhdmFsdWU7CiAgICAgICAgIH0KICAgICAgfTsKCiAgICAgIC8qCiAgICAgICAgYWxsIGFuaW1hdGlvbnMgY2FsbCB0aGlzIHNoYXJlZCBhbmltYXRpb24gdHJpZ2dlcmluZyBmdW5jdGlvbiBpbnRlcm5hbGx5LgogICAgICAgIFRoZSBhbmltYXRpb25FdmVudCB2YXJpYWJsZSByZWZlcnMgdG8gdGhlIEphdmFTY3JpcHQgYW5pbWF0aW9uIGV2ZW50IHRoYXQgd2lsbCBiZSB0cmlnZ2VyZWQKICAgICAgICBhbmQgdGhlIGNsYXNzTmFtZSB2YWx1ZSBpcyB0aGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uIHRoYXQgd2lsbCBiZSBhcHBsaWVkIHdpdGhpbiB0aGUKICAgICAgICBDU1MgY29kZS4gRWxlbWVudCwgcGFyZW50RWxlbWVudCBhbmQgYWZ0ZXJFbGVtZW50IGFyZSBwcm92aWRlZCBET00gZWxlbWVudHMgZm9yIHRoZSBhbmltYXRpb24KICAgICAgICBhbmQgdGhlIG9uQ29tcGxldGUgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCBvbmNlIHRoZSBhbmltYXRpb24gaXMgZnVsbHkgY29tcGxldGUuCiAgICAgICovCiAgICAgIGZ1bmN0aW9uIHBlcmZvcm1BbmltYXRpb24oYW5pbWF0aW9uRXZlbnQsIGNsYXNzTmFtZSwgZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBkb21PcGVyYXRpb24sIGRvbmVDYWxsYmFjaykgewoKICAgICAgICB2YXIgcnVubmVyID0gYW5pbWF0aW9uUnVubmVyKGVsZW1lbnQsIGFuaW1hdGlvbkV2ZW50LCBjbGFzc05hbWUpOwogICAgICAgIGlmKCFydW5uZXIpIHsKICAgICAgICAgIGZpcmVET01PcGVyYXRpb24oKTsKICAgICAgICAgIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICBjbG9zZUFuaW1hdGlvbigpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY2xhc3NOYW1lID0gcnVubmVyLmNsYXNzTmFtZTsKICAgICAgICB2YXIgZWxlbWVudEV2ZW50cyA9IGFuZ3VsYXIuZWxlbWVudC5fZGF0YShydW5uZXIubm9kZSk7CiAgICAgICAgZWxlbWVudEV2ZW50cyA9IGVsZW1lbnRFdmVudHMgJiYgZWxlbWVudEV2ZW50cy5ldmVudHM7CgogICAgICAgIGlmICghcGFyZW50RWxlbWVudCkgewogICAgICAgICAgcGFyZW50RWxlbWVudCA9IGFmdGVyRWxlbWVudCA/IGFmdGVyRWxlbWVudC5wYXJlbnQoKSA6IGVsZW1lbnQucGFyZW50KCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbmdBbmltYXRlU3RhdGUgID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgIHZhciBydW5uaW5nQW5pbWF0aW9ucyAgICAgPSBuZ0FuaW1hdGVTdGF0ZS5hY3RpdmUgfHwge307CiAgICAgICAgdmFyIHRvdGFsQWN0aXZlQW5pbWF0aW9ucyA9IG5nQW5pbWF0ZVN0YXRlLnRvdGFsQWN0aXZlIHx8IDA7CiAgICAgICAgdmFyIGxhc3RBbmltYXRpb24gICAgICAgICA9IG5nQW5pbWF0ZVN0YXRlLmxhc3Q7CgogICAgICAgIC8vb25seSBhbGxvdyBhbmltYXRpb25zIGlmIHRoZSBjdXJyZW50bHkgcnVubmluZyBhbmltYXRpb24gaXMgbm90IHN0cnVjdHVyYWwKICAgICAgICAvL29yIGlmIHRoZXJlIGlzIG5vIGFuaW1hdGlvbiBydW5uaW5nIGF0IGFsbAogICAgICAgIHZhciBza2lwQW5pbWF0aW9ucyA9IHJ1bm5lci5pc0NsYXNzQmFzZWQgPwogICAgICAgICAgbmdBbmltYXRlU3RhdGUuZGlzYWJsZWQgfHwgKGxhc3RBbmltYXRpb24gJiYgIWxhc3RBbmltYXRpb24uaXNDbGFzc0Jhc2VkKSA6CiAgICAgICAgICBmYWxzZTsKCiAgICAgICAgLy9za2lwIHRoZSBhbmltYXRpb24gaWYgYW5pbWF0aW9ucyBhcmUgZGlzYWJsZWQsIGEgcGFyZW50IGlzIGFscmVhZHkgYmVpbmcgYW5pbWF0ZWQsCiAgICAgICAgLy90aGUgZWxlbWVudCBpcyBub3QgY3VycmVudGx5IGF0dGFjaGVkIHRvIHRoZSBkb2N1bWVudCBib2R5IG9yIHRoZW4gY29tcGxldGVseSBjbG9zZQogICAgICAgIC8vdGhlIGFuaW1hdGlvbiBpZiBhbnkgbWF0Y2hpbmcgYW5pbWF0aW9ucyBhcmUgbm90IGZvdW5kIGF0IGFsbC4KICAgICAgICAvL05PVEU6IElFOCArIElFOSBzaG91bGQgY2xvc2UgcHJvcGVybHkgKHJ1biBjbG9zZUFuaW1hdGlvbigpKSBpbiBjYXNlIGFuIGFuaW1hdGlvbiB3YXMgZm91bmQuCiAgICAgICAgaWYgKHNraXBBbmltYXRpb25zIHx8IGFuaW1hdGlvbnNEaXNhYmxlZChlbGVtZW50LCBwYXJlbnRFbGVtZW50KSkgewogICAgICAgICAgZmlyZURPTU9wZXJhdGlvbigpOwogICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGNsb3NlQW5pbWF0aW9uKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgc2tpcEFuaW1hdGlvbiA9IGZhbHNlOwogICAgICAgIGlmKHRvdGFsQWN0aXZlQW5pbWF0aW9ucyA+IDApIHsKICAgICAgICAgIHZhciBhbmltYXRpb25zVG9DYW5jZWwgPSBbXTsKICAgICAgICAgIGlmKCFydW5uZXIuaXNDbGFzc0Jhc2VkKSB7CiAgICAgICAgICAgIGlmKGFuaW1hdGlvbkV2ZW50ID09ICdsZWF2ZScgJiYgcnVubmluZ0FuaW1hdGlvbnNbJ25nLWxlYXZlJ10pIHsKICAgICAgICAgICAgICBza2lwQW5pbWF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvL2NhbmNlbCBhbGwgYW5pbWF0aW9ucyB3aGVuIGEgc3RydWN0dXJhbCBhbmltYXRpb24gdGFrZXMgcGxhY2UKICAgICAgICAgICAgICBmb3IodmFyIGtsYXNzIGluIHJ1bm5pbmdBbmltYXRpb25zKSB7CiAgICAgICAgICAgICAgICBhbmltYXRpb25zVG9DYW5jZWwucHVzaChydW5uaW5nQW5pbWF0aW9uc1trbGFzc10pOwogICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBrbGFzcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJ1bm5pbmdBbmltYXRpb25zID0ge307CiAgICAgICAgICAgICAgdG90YWxBY3RpdmVBbmltYXRpb25zID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmKGxhc3RBbmltYXRpb24uZXZlbnQgPT0gJ3NldENsYXNzJykgewogICAgICAgICAgICBhbmltYXRpb25zVG9DYW5jZWwucHVzaChsYXN0QW5pbWF0aW9uKTsKICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZihydW5uaW5nQW5pbWF0aW9uc1tjbGFzc05hbWVdKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gcnVubmluZ0FuaW1hdGlvbnNbY2xhc3NOYW1lXTsKICAgICAgICAgICAgaWYoY3VycmVudC5ldmVudCA9PSBhbmltYXRpb25FdmVudCkgewogICAgICAgICAgICAgIHNraXBBbmltYXRpb24gPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFuaW1hdGlvbnNUb0NhbmNlbC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmKGFuaW1hdGlvbnNUb0NhbmNlbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZvckVhY2goYW5pbWF0aW9uc1RvQ2FuY2VsLCBmdW5jdGlvbihvcGVyYXRpb24pIHsKICAgICAgICAgICAgICBvcGVyYXRpb24uY2FuY2VsKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYocnVubmVyLmlzQ2xhc3NCYXNlZCAmJiAhcnVubmVyLmlzU2V0Q2xhc3NPcGVyYXRpb24gJiYgIXNraXBBbmltYXRpb24pIHsKICAgICAgICAgIHNraXBBbmltYXRpb24gPSAoYW5pbWF0aW9uRXZlbnQgPT0gJ2FkZENsYXNzJykgPT0gZWxlbWVudC5oYXNDbGFzcyhjbGFzc05hbWUpOyAvL29wcG9zaXRlIG9mIFhPUgogICAgICAgIH0KCiAgICAgICAgaWYoc2tpcEFuaW1hdGlvbikgewogICAgICAgICAgZmlyZURPTU9wZXJhdGlvbigpOwogICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGZpcmVEb25lQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYoYW5pbWF0aW9uRXZlbnQgPT0gJ2xlYXZlJykgewogICAgICAgICAgLy90aGVyZSdzIG5vIG5lZWQgdG8gZXZlciByZW1vdmUgdGhlIGxpc3RlbmVyIHNpbmNlIHRoZSBlbGVtZW50CiAgICAgICAgICAvL3dpbGwgYmUgcmVtb3ZlZCAoZGVzdHJveWVkKSBhZnRlciB0aGUgbGVhdmUgYW5pbWF0aW9uIGVuZHMgb3IKICAgICAgICAgIC8vaXMgY2FuY2VsbGVkIG1pZHdheQogICAgICAgICAgZWxlbWVudC5vbmUoJyRkZXN0cm95JywgZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudCh0aGlzKTsKICAgICAgICAgICAgdmFyIHN0YXRlID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgICBpZihzdGF0ZSkgewogICAgICAgICAgICAgIHZhciBhY3RpdmVMZWF2ZUFuaW1hdGlvbiA9IHN0YXRlLmFjdGl2ZVsnbmctbGVhdmUnXTsKICAgICAgICAgICAgICBpZihhY3RpdmVMZWF2ZUFuaW1hdGlvbikgewogICAgICAgICAgICAgICAgYWN0aXZlTGVhdmVBbmltYXRpb24uY2FuY2VsKCk7CiAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsICduZy1sZWF2ZScpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvL3RoZSBuZy1hbmltYXRlIGNsYXNzIGRvZXMgbm90aGluZywgYnV0IGl0J3MgaGVyZSB0byBhbGxvdyBmb3IKICAgICAgICAvL3BhcmVudCBhbmltYXRpb25zIHRvIGZpbmQgYW5kIGNhbmNlbCBjaGlsZCBhbmltYXRpb25zIHdoZW4gbmVlZGVkCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhOR19BTklNQVRFX0NMQVNTX05BTUUpOwoKICAgICAgICB2YXIgbG9jYWxBbmltYXRpb25Db3VudCA9IGdsb2JhbEFuaW1hdGlvbkNvdW50ZXIrKzsKICAgICAgICB0b3RhbEFjdGl2ZUFuaW1hdGlvbnMrKzsKICAgICAgICBydW5uaW5nQW5pbWF0aW9uc1tjbGFzc05hbWVdID0gcnVubmVyOwoKICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSwgewogICAgICAgICAgbGFzdCA6IHJ1bm5lciwKICAgICAgICAgIGFjdGl2ZSA6IHJ1bm5pbmdBbmltYXRpb25zLAogICAgICAgICAgaW5kZXggOiBsb2NhbEFuaW1hdGlvbkNvdW50LAogICAgICAgICAgdG90YWxBY3RpdmUgOiB0b3RhbEFjdGl2ZUFuaW1hdGlvbnMKICAgICAgICB9KTsKCiAgICAgICAgLy9maXJzdCB3ZSBydW4gdGhlIGJlZm9yZSBhbmltYXRpb25zIGFuZCB3aGVuIGFsbCBvZiB0aG9zZSBhcmUgY29tcGxldGUKICAgICAgICAvL3RoZW4gd2UgcGVyZm9ybSB0aGUgRE9NIG9wZXJhdGlvbiBhbmQgcnVuIHRoZSBuZXh0IHNldCBvZiBhbmltYXRpb25zCiAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICBydW5uZXIuYmVmb3JlKGZ1bmN0aW9uKGNhbmNlbGxlZCkgewogICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICBjYW5jZWxsZWQgPSBjYW5jZWxsZWQgfHwKICAgICAgICAgICAgICAgICAgICAgICAgIWRhdGEgfHwgIWRhdGEuYWN0aXZlW2NsYXNzTmFtZV0gfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHJ1bm5lci5pc0NsYXNzQmFzZWQgJiYgZGF0YS5hY3RpdmVbY2xhc3NOYW1lXS5ldmVudCAhPSBhbmltYXRpb25FdmVudCk7CgogICAgICAgICAgZmlyZURPTU9wZXJhdGlvbigpOwogICAgICAgICAgaWYoY2FuY2VsbGVkID09PSB0cnVlKSB7CiAgICAgICAgICAgIGNsb3NlQW5pbWF0aW9uKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgIHJ1bm5lci5hZnRlcihjbG9zZUFuaW1hdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIGZpcmVET01DYWxsYmFjayhhbmltYXRpb25QaGFzZSkgewogICAgICAgICAgdmFyIGV2ZW50TmFtZSA9ICckYW5pbWF0ZTonICsgYW5pbWF0aW9uUGhhc2U7CiAgICAgICAgICBpZihlbGVtZW50RXZlbnRzICYmIGVsZW1lbnRFdmVudHNbZXZlbnROYW1lXSAmJiBlbGVtZW50RXZlbnRzW2V2ZW50TmFtZV0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAkJGFzeW5jQ2FsbGJhY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZWxlbWVudC50cmlnZ2VySGFuZGxlcihldmVudE5hbWUsIHsKICAgICAgICAgICAgICAgIGV2ZW50IDogYW5pbWF0aW9uRXZlbnQsCiAgICAgICAgICAgICAgICBjbGFzc05hbWUgOiBjbGFzc05hbWUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpIHsKICAgICAgICAgIGZpcmVET01DYWxsYmFjaygnYmVmb3JlJyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCkgewogICAgICAgICAgZmlyZURPTUNhbGxiYWNrKCdhZnRlcicpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmlyZURvbmVDYWxsYmFja0FzeW5jKCkgewogICAgICAgICAgZmlyZURPTUNhbGxiYWNrKCdjbG9zZScpOwogICAgICAgICAgaWYoZG9uZUNhbGxiYWNrKSB7CiAgICAgICAgICAgICQkYXN5bmNDYWxsYmFjayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBkb25lQ2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL2l0IGlzIGxlc3MgY29tcGxpY2F0ZWQgdG8gdXNlIGEgZmxhZyB0aGFuIG1hbmFnaW5nIGFuZCBjYW5jZWxpbmcKICAgICAgICAvL3RpbWVvdXRzIGNvbnRhaW5pbmcgbXVsdGlwbGUgY2FsbGJhY2tzLgogICAgICAgIGZ1bmN0aW9uIGZpcmVET01PcGVyYXRpb24oKSB7CiAgICAgICAgICBpZighZmlyZURPTU9wZXJhdGlvbi5oYXNCZWVuUnVuKSB7CiAgICAgICAgICAgIGZpcmVET01PcGVyYXRpb24uaGFzQmVlblJ1biA9IHRydWU7CiAgICAgICAgICAgIGRvbU9wZXJhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2xvc2VBbmltYXRpb24oKSB7CiAgICAgICAgICBpZighY2xvc2VBbmltYXRpb24uaGFzQmVlblJ1bikgewogICAgICAgICAgICBjbG9zZUFuaW1hdGlvbi5oYXNCZWVuUnVuID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgIGlmKGRhdGEpIHsKICAgICAgICAgICAgICAvKiBvbmx5IHN0cnVjdHVyYWwgYW5pbWF0aW9ucyB3YWl0IGZvciByZWZsb3cgYmVmb3JlIHJlbW92aW5nIGFuCiAgICAgICAgICAgICAgICAgYW5pbWF0aW9uLCBidXQgY2xhc3MtYmFzZWQgYW5pbWF0aW9ucyBkb24ndC4gQW4gZXhhbXBsZSBvZiB0aGlzCiAgICAgICAgICAgICAgICAgZmFpbGluZyB3b3VsZCBiZSB3aGVuIGEgcGFyZW50IEhUTUwgdGFnIGhhcyBhIG5nLWNsYXNzIGF0dHJpYnV0ZQogICAgICAgICAgICAgICAgIGNhdXNpbmcgQUxMIGRpcmVjdGl2ZXMgYmVsb3cgdG8gc2tpcCBhbmltYXRpb25zIGR1cmluZyB0aGUgZGlnZXN0ICovCiAgICAgICAgICAgICAgaWYocnVubmVyICYmIHJ1bm5lci5pc0NsYXNzQmFzZWQpIHsKICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCRhc3luY0NhbGxiYWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKSB8fCB7fTsKICAgICAgICAgICAgICAgICAgaWYobG9jYWxBbmltYXRpb25Db3VudCA9PSBkYXRhLmluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkV2ZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSwgZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpcmVEb25lQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2FuY2VsQ2hpbGRBbmltYXRpb25zKGVsZW1lbnQpIHsKICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgdmFyIG5vZGVzID0gYW5ndWxhci5pc0Z1bmN0aW9uKG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSkgPwogICAgICAgICAgICBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoTkdfQU5JTUFURV9DTEFTU19OQU1FKSA6CiAgICAgICAgICAgIG5vZGUucXVlcnlTZWxlY3RvckFsbCgnLicgKyBOR19BTklNQVRFX0NMQVNTX05BTUUpOwogICAgICAgICAgZm9yRWFjaChub2RlcywgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgICAgaWYoZGF0YSAmJiBkYXRhLmFjdGl2ZSkgewogICAgICAgICAgICAgIGZvckVhY2goZGF0YS5hY3RpdmUsIGZ1bmN0aW9uKHJ1bm5lcikgewogICAgICAgICAgICAgICAgcnVubmVyLmNhbmNlbCgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICAgICAgaWYoaXNNYXRjaGluZ0VsZW1lbnQoZWxlbWVudCwgJHJvb3RFbGVtZW50KSkgewogICAgICAgICAgaWYoIXJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQpIHsKICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHJvb3RBbmltYXRlU3RhdGUuc3RydWN0dXJhbCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZihjbGFzc05hbWUpIHsKICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwoKICAgICAgICAgIHZhciByZW1vdmVBbmltYXRpb25zID0gY2xhc3NOYW1lID09PSB0cnVlOwogICAgICAgICAgaWYoIXJlbW92ZUFuaW1hdGlvbnMgJiYgZGF0YS5hY3RpdmUgJiYgZGF0YS5hY3RpdmVbY2xhc3NOYW1lXSkgewogICAgICAgICAgICBkYXRhLnRvdGFsQWN0aXZlLS07CiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmFjdGl2ZVtjbGFzc05hbWVdOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKHJlbW92ZUFuaW1hdGlvbnMgfHwgIWRhdGEudG90YWxBY3RpdmUpIHsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhOR19BTklNQVRFX0NMQVNTX05BTUUpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZURhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRpb25zRGlzYWJsZWQoZWxlbWVudCwgcGFyZW50RWxlbWVudCkgewogICAgICAgIGlmIChyb290QW5pbWF0ZVN0YXRlLmRpc2FibGVkKSByZXR1cm4gdHJ1ZTsKCiAgICAgICAgaWYoaXNNYXRjaGluZ0VsZW1lbnQoZWxlbWVudCwgJHJvb3RFbGVtZW50KSkgewogICAgICAgICAgcmV0dXJuIHJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQgfHwgcm9vdEFuaW1hdGVTdGF0ZS5ydW5uaW5nOwogICAgICAgIH0KCiAgICAgICAgZG8gewogICAgICAgICAgLy90aGUgZWxlbWVudCBkaWQgbm90IHJlYWNoIHRoZSByb290IGVsZW1lbnQgd2hpY2ggbWVhbnMgdGhhdCBpdAogICAgICAgICAgLy9pcyBub3QgYXBhcnQgb2YgdGhlIERPTS4gVGhlcmVmb3JlIHRoZXJlIGlzIG5vIHJlYXNvbiB0byBkbwogICAgICAgICAgLy9hbnkgYW5pbWF0aW9ucyBvbiBpdAogICAgICAgICAgaWYocGFyZW50RWxlbWVudC5sZW5ndGggPT09IDApIGJyZWFrOwoKICAgICAgICAgIHZhciBpc1Jvb3QgPSBpc01hdGNoaW5nRWxlbWVudChwYXJlbnRFbGVtZW50LCAkcm9vdEVsZW1lbnQpOwogICAgICAgICAgdmFyIHN0YXRlID0gaXNSb290ID8gcm9vdEFuaW1hdGVTdGF0ZSA6IHBhcmVudEVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgIHZhciByZXN1bHQgPSBzdGF0ZSAmJiAoISFzdGF0ZS5kaXNhYmxlZCB8fCBzdGF0ZS5ydW5uaW5nIHx8IHN0YXRlLnRvdGFsQWN0aXZlID4gMCk7CiAgICAgICAgICBpZihpc1Jvb3QgfHwgcmVzdWx0KSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9CgogICAgICAgICAgaWYoaXNSb290KSByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgd2hpbGUocGFyZW50RWxlbWVudCA9IHBhcmVudEVsZW1lbnQucGFyZW50KCkpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfV0pOwoKICAgICRhbmltYXRlUHJvdmlkZXIucmVnaXN0ZXIoJycsIFsnJHdpbmRvdycsICckc25pZmZlcicsICckdGltZW91dCcsICckJGFuaW1hdGVSZWZsb3cnLAogICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigkd2luZG93LCAgICRzbmlmZmVyLCAgICR0aW1lb3V0LCAgICQkYW5pbWF0ZVJlZmxvdykgewogICAgICAvLyBEZXRlY3QgcHJvcGVyIHRyYW5zaXRpb25lbmQvYW5pbWF0aW9uZW5kIGV2ZW50IG5hbWVzLgogICAgICB2YXIgQ1NTX1BSRUZJWCA9ICcnLCBUUkFOU0lUSU9OX1BST1AsIFRSQU5TSVRJT05FTkRfRVZFTlQsIEFOSU1BVElPTl9QUk9QLCBBTklNQVRJT05FTkRfRVZFTlQ7CgogICAgICAvLyBJZiB1bnByZWZpeGVkIGV2ZW50cyBhcmUgbm90IHN1cHBvcnRlZCBidXQgd2Via2l0LXByZWZpeGVkIGFyZSwgdXNlIHRoZSBsYXR0ZXIuCiAgICAgIC8vIE90aGVyd2lzZSwganVzdCB1c2UgVzNDIG5hbWVzLCBicm93c2VycyBub3Qgc3VwcG9ydGluZyB0aGVtIGF0IGFsbCB3aWxsIGp1c3QgaWdub3JlIHRoZW0uCiAgICAgIC8vIE5vdGU6IENocm9tZSBpbXBsZW1lbnRzIGB3aW5kb3cub253ZWJraXRhbmltYXRpb25lbmRgIGFuZCBkb2Vzbid0IGltcGxlbWVudCBgd2luZG93Lm9uYW5pbWF0aW9uZW5kYAogICAgICAvLyBidXQgYXQgdGhlIHNhbWUgdGltZSBkaXNwYXRjaGVzIHRoZSBgYW5pbWF0aW9uZW5kYCBldmVudCBhbmQgbm90IGB3ZWJraXRBbmltYXRpb25FbmRgLgogICAgICAvLyBSZWdpc3RlciBib3RoIGV2ZW50cyBpbiBjYXNlIGB3aW5kb3cub25hbmltYXRpb25lbmRgIGlzIG5vdCBzdXBwb3J0ZWQgYmVjYXVzZSBvZiB0aGF0LAogICAgICAvLyBkbyB0aGUgc2FtZSBmb3IgYHRyYW5zaXRpb25lbmRgIGFzIFNhZmFyaSBpcyBsaWtlbHkgdG8gZXhoaWJpdCBzaW1pbGFyIGJlaGF2aW9yLgogICAgICAvLyBBbHNvLCB0aGUgb25seSBtb2Rlcm4gYnJvd3NlciB0aGF0IHVzZXMgdmVuZG9yIHByZWZpeGVzIGZvciB0cmFuc2l0aW9ucy9rZXlmcmFtZXMgaXMgd2Via2l0CiAgICAgIC8vIHRoZXJlZm9yZSB0aGVyZSBpcyBubyByZWFzb24gdG8gdGVzdCBhbnltb3JlIGZvciBvdGhlciB2ZW5kb3IgcHJlZml4ZXM6IGh0dHA6Ly9jYW5pdXNlLmNvbS8jc2VhcmNoPXRyYW5zaXRpb24KICAgICAgaWYgKHdpbmRvdy5vbnRyYW5zaXRpb25lbmQgPT09IHVuZGVmaW5lZCAmJiB3aW5kb3cub253ZWJraXR0cmFuc2l0aW9uZW5kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBDU1NfUFJFRklYID0gJy13ZWJraXQtJzsKICAgICAgICBUUkFOU0lUSU9OX1BST1AgPSAnV2Via2l0VHJhbnNpdGlvbic7CiAgICAgICAgVFJBTlNJVElPTkVORF9FVkVOVCA9ICd3ZWJraXRUcmFuc2l0aW9uRW5kIHRyYW5zaXRpb25lbmQnOwogICAgICB9IGVsc2UgewogICAgICAgIFRSQU5TSVRJT05fUFJPUCA9ICd0cmFuc2l0aW9uJzsKICAgICAgICBUUkFOU0lUSU9ORU5EX0VWRU5UID0gJ3RyYW5zaXRpb25lbmQnOwogICAgICB9CgogICAgICBpZiAod2luZG93Lm9uYW5pbWF0aW9uZW5kID09PSB1bmRlZmluZWQgJiYgd2luZG93Lm9ud2Via2l0YW5pbWF0aW9uZW5kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBDU1NfUFJFRklYID0gJy13ZWJraXQtJzsKICAgICAgICBBTklNQVRJT05fUFJPUCA9ICdXZWJraXRBbmltYXRpb24nOwogICAgICAgIEFOSU1BVElPTkVORF9FVkVOVCA9ICd3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBBTklNQVRJT05fUFJPUCA9ICdhbmltYXRpb24nOwogICAgICAgIEFOSU1BVElPTkVORF9FVkVOVCA9ICdhbmltYXRpb25lbmQnOwogICAgICB9CgogICAgICB2YXIgRFVSQVRJT05fS0VZID0gJ0R1cmF0aW9uJzsKICAgICAgdmFyIFBST1BFUlRZX0tFWSA9ICdQcm9wZXJ0eSc7CiAgICAgIHZhciBERUxBWV9LRVkgPSAnRGVsYXknOwogICAgICB2YXIgQU5JTUFUSU9OX0lURVJBVElPTl9DT1VOVF9LRVkgPSAnSXRlcmF0aW9uQ291bnQnOwogICAgICB2YXIgTkdfQU5JTUFURV9QQVJFTlRfS0VZID0gJyQkbmdBbmltYXRlS2V5JzsKICAgICAgdmFyIE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZID0gJyQkbmdBbmltYXRlQ1NTM0RhdGEnOwogICAgICB2YXIgTkdfQU5JTUFURV9CTE9DS19DTEFTU19OQU1FID0gJ25nLWFuaW1hdGUtYmxvY2stdHJhbnNpdGlvbnMnOwogICAgICB2YXIgRUxBUFNFRF9USU1FX01BWF9ERUNJTUFMX1BMQUNFUyA9IDM7CiAgICAgIHZhciBDTE9TSU5HX1RJTUVfQlVGRkVSID0gMS41OwogICAgICB2YXIgT05FX1NFQ09ORCA9IDEwMDA7CgogICAgICB2YXIgbG9va3VwQ2FjaGUgPSB7fTsKICAgICAgdmFyIHBhcmVudENvdW50ZXIgPSAwOwogICAgICB2YXIgYW5pbWF0aW9uUmVmbG93UXVldWUgPSBbXTsKICAgICAgdmFyIGNhbmNlbEFuaW1hdGlvblJlZmxvdzsKICAgICAgZnVuY3Rpb24gYWZ0ZXJSZWZsb3coZWxlbWVudCwgY2FsbGJhY2spIHsKICAgICAgICBpZihjYW5jZWxBbmltYXRpb25SZWZsb3cpIHsKICAgICAgICAgIGNhbmNlbEFuaW1hdGlvblJlZmxvdygpOwogICAgICAgIH0KICAgICAgICBhbmltYXRpb25SZWZsb3dRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICBjYW5jZWxBbmltYXRpb25SZWZsb3cgPSAkJGFuaW1hdGVSZWZsb3coZnVuY3Rpb24oKSB7CiAgICAgICAgICBmb3JFYWNoKGFuaW1hdGlvblJlZmxvd1F1ZXVlLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICBmbigpOwogICAgICAgICAgfSk7CgogICAgICAgICAgYW5pbWF0aW9uUmVmbG93UXVldWUgPSBbXTsKICAgICAgICAgIGNhbmNlbEFuaW1hdGlvblJlZmxvdyA9IG51bGw7CiAgICAgICAgICBsb29rdXBDYWNoZSA9IHt9OwogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgY2xvc2luZ1RpbWVyID0gbnVsbDsKICAgICAgdmFyIGNsb3NpbmdUaW1lc3RhbXAgPSAwOwogICAgICB2YXIgYW5pbWF0aW9uRWxlbWVudFF1ZXVlID0gW107CiAgICAgIGZ1bmN0aW9uIGFuaW1hdGlvbkNsb3NlSGFuZGxlcihlbGVtZW50LCB0b3RhbFRpbWUpIHsKICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KG5vZGUpOwoKICAgICAgICAvL3RoaXMgaXRlbSB3aWxsIGJlIGdhcmJhZ2UgY29sbGVjdGVkIGJ5IHRoZSBjbG9zaW5nCiAgICAgICAgLy9hbmltYXRpb24gdGltZW91dAogICAgICAgIGFuaW1hdGlvbkVsZW1lbnRRdWV1ZS5wdXNoKGVsZW1lbnQpOwoKICAgICAgICAvL2J1dCBpdCBtYXkgbm90IG5lZWQgdG8gY2FuY2VsIG91dCB0aGUgZXhpc3RpbmcgdGltZW91dAogICAgICAgIC8vaWYgdGhlIHRpbWVzdGFtcCBpcyBsZXNzIHRoYW4gdGhlIHByZXZpb3VzIG9uZQogICAgICAgIHZhciBmdXR1cmVUaW1lc3RhbXAgPSBEYXRlLm5vdygpICsgdG90YWxUaW1lOwogICAgICAgIGlmKGZ1dHVyZVRpbWVzdGFtcCA8PSBjbG9zaW5nVGltZXN0YW1wKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAkdGltZW91dC5jYW5jZWwoY2xvc2luZ1RpbWVyKTsKCiAgICAgICAgY2xvc2luZ1RpbWVzdGFtcCA9IGZ1dHVyZVRpbWVzdGFtcDsKICAgICAgICBjbG9zaW5nVGltZXIgPSAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIGNsb3NlQWxsQW5pbWF0aW9ucyhhbmltYXRpb25FbGVtZW50UXVldWUpOwogICAgICAgICAgYW5pbWF0aW9uRWxlbWVudFF1ZXVlID0gW107CiAgICAgICAgfSwgdG90YWxUaW1lLCBmYWxzZSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNsb3NlQWxsQW5pbWF0aW9ucyhlbGVtZW50cykgewogICAgICAgIGZvckVhY2goZWxlbWVudHMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgIHZhciBlbGVtZW50RGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgICBpZihlbGVtZW50RGF0YSkgewogICAgICAgICAgICAoZWxlbWVudERhdGEuY2xvc2VBbmltYXRpb25GbiB8fCBub29wKSgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBjYWNoZUtleSkgewogICAgICAgIHZhciBkYXRhID0gY2FjaGVLZXkgPyBsb29rdXBDYWNoZVtjYWNoZUtleV0gOiBudWxsOwogICAgICAgIGlmKCFkYXRhKSB7CiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uID0gMDsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uRGVsYXkgPSAwOwogICAgICAgICAgdmFyIGFuaW1hdGlvbkR1cmF0aW9uID0gMDsKICAgICAgICAgIHZhciBhbmltYXRpb25EZWxheSA9IDA7CiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkRlbGF5U3R5bGU7CiAgICAgICAgICB2YXIgYW5pbWF0aW9uRGVsYXlTdHlsZTsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb25TdHlsZTsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uUHJvcGVydHlTdHlsZTsKCiAgICAgICAgICAvL3dlIHdhbnQgYWxsIHRoZSBzdHlsZXMgZGVmaW5lZCBiZWZvcmUgYW5kIGFmdGVyCiAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRTdHlsZXMgPSAkd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCkgfHwge307CgogICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvblN0eWxlID0gZWxlbWVudFN0eWxlc1tUUkFOU0lUSU9OX1BST1AgKyBEVVJBVElPTl9LRVldOwoKICAgICAgICAgICAgICB0cmFuc2l0aW9uRHVyYXRpb24gPSBNYXRoLm1heChwYXJzZU1heFRpbWUodHJhbnNpdGlvbkR1cmF0aW9uU3R5bGUpLCB0cmFuc2l0aW9uRHVyYXRpb24pOwoKICAgICAgICAgICAgICB0cmFuc2l0aW9uUHJvcGVydHlTdHlsZSA9IGVsZW1lbnRTdHlsZXNbVFJBTlNJVElPTl9QUk9QICsgUFJPUEVSVFlfS0VZXTsKCiAgICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5U3R5bGUgPSBlbGVtZW50U3R5bGVzW1RSQU5TSVRJT05fUFJPUCArIERFTEFZX0tFWV07CgogICAgICAgICAgICAgIHRyYW5zaXRpb25EZWxheSAgPSBNYXRoLm1heChwYXJzZU1heFRpbWUodHJhbnNpdGlvbkRlbGF5U3R5bGUpLCB0cmFuc2l0aW9uRGVsYXkpOwoKICAgICAgICAgICAgICBhbmltYXRpb25EZWxheVN0eWxlID0gZWxlbWVudFN0eWxlc1tBTklNQVRJT05fUFJPUCArIERFTEFZX0tFWV07CgogICAgICAgICAgICAgIGFuaW1hdGlvbkRlbGF5ICAgPSBNYXRoLm1heChwYXJzZU1heFRpbWUoYW5pbWF0aW9uRGVsYXlTdHlsZSksIGFuaW1hdGlvbkRlbGF5KTsKCiAgICAgICAgICAgICAgdmFyIGFEdXJhdGlvbiAgPSBwYXJzZU1heFRpbWUoZWxlbWVudFN0eWxlc1tBTklNQVRJT05fUFJPUCArIERVUkFUSU9OX0tFWV0pOwoKICAgICAgICAgICAgICBpZihhRHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICBhRHVyYXRpb24gKj0gcGFyc2VJbnQoZWxlbWVudFN0eWxlc1tBTklNQVRJT05fUFJPUCArIEFOSU1BVElPTl9JVEVSQVRJT05fQ09VTlRfS0VZXSwgMTApIHx8IDE7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBhbmltYXRpb25EdXJhdGlvbiA9IE1hdGgubWF4KGFEdXJhdGlvbiwgYW5pbWF0aW9uRHVyYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgIHRvdGFsIDogMCwKICAgICAgICAgICAgdHJhbnNpdGlvblByb3BlcnR5U3R5bGU6IHRyYW5zaXRpb25Qcm9wZXJ0eVN0eWxlLAogICAgICAgICAgICB0cmFuc2l0aW9uRHVyYXRpb25TdHlsZTogdHJhbnNpdGlvbkR1cmF0aW9uU3R5bGUsCiAgICAgICAgICAgIHRyYW5zaXRpb25EZWxheVN0eWxlOiB0cmFuc2l0aW9uRGVsYXlTdHlsZSwKICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5OiB0cmFuc2l0aW9uRGVsYXksCiAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbjogdHJhbnNpdGlvbkR1cmF0aW9uLAogICAgICAgICAgICBhbmltYXRpb25EZWxheVN0eWxlOiBhbmltYXRpb25EZWxheVN0eWxlLAogICAgICAgICAgICBhbmltYXRpb25EZWxheTogYW5pbWF0aW9uRGVsYXksCiAgICAgICAgICAgIGFuaW1hdGlvbkR1cmF0aW9uOiBhbmltYXRpb25EdXJhdGlvbgogICAgICAgICAgfTsKICAgICAgICAgIGlmKGNhY2hlS2V5KSB7CiAgICAgICAgICAgIGxvb2t1cENhY2hlW2NhY2hlS2V5XSA9IGRhdGE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRhOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwYXJzZU1heFRpbWUoc3RyKSB7CiAgICAgICAgdmFyIG1heFZhbHVlID0gMDsKICAgICAgICB2YXIgdmFsdWVzID0gYW5ndWxhci5pc1N0cmluZyhzdHIpID8KICAgICAgICAgIHN0ci5zcGxpdCgvXHMqLFxzKi8pIDoKICAgICAgICAgIFtdOwogICAgICAgIGZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgbWF4VmFsdWUgPSBNYXRoLm1heChwYXJzZUZsb2F0KHZhbHVlKSB8fCAwLCBtYXhWYWx1ZSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1heFZhbHVlOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRDYWNoZUtleShlbGVtZW50KSB7CiAgICAgICAgdmFyIHBhcmVudEVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgICAgIHZhciBwYXJlbnRJRCA9IHBhcmVudEVsZW1lbnQuZGF0YShOR19BTklNQVRFX1BBUkVOVF9LRVkpOwogICAgICAgIGlmKCFwYXJlbnRJRCkgewogICAgICAgICAgcGFyZW50RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfUEFSRU5UX0tFWSwgKytwYXJlbnRDb3VudGVyKTsKICAgICAgICAgIHBhcmVudElEID0gcGFyZW50Q291bnRlcjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmVudElEICsgJy0nICsgZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0ZVNldHVwKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGNhbGN1bGF0aW9uRGVjb3JhdG9yKSB7CiAgICAgICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkoZWxlbWVudCk7CiAgICAgICAgdmFyIGV2ZW50Q2FjaGVLZXkgPSBjYWNoZUtleSArICcgJyArIGNsYXNzTmFtZTsKICAgICAgICB2YXIgaXRlbUluZGV4ID0gbG9va3VwQ2FjaGVbZXZlbnRDYWNoZUtleV0gPyArK2xvb2t1cENhY2hlW2V2ZW50Q2FjaGVLZXldLnRvdGFsIDogMDsKCiAgICAgICAgdmFyIHN0YWdnZXIgPSB7fTsKICAgICAgICBpZihpdGVtSW5kZXggPiAwKSB7CiAgICAgICAgICB2YXIgc3RhZ2dlckNsYXNzTmFtZSA9IGNsYXNzTmFtZSArICctc3RhZ2dlcic7CiAgICAgICAgICB2YXIgc3RhZ2dlckNhY2hlS2V5ID0gY2FjaGVLZXkgKyAnICcgKyBzdGFnZ2VyQ2xhc3NOYW1lOwogICAgICAgICAgdmFyIGFwcGx5Q2xhc3NlcyA9ICFsb29rdXBDYWNoZVtzdGFnZ2VyQ2FjaGVLZXldOwoKICAgICAgICAgIGFwcGx5Q2xhc3NlcyAmJiBlbGVtZW50LmFkZENsYXNzKHN0YWdnZXJDbGFzc05hbWUpOwoKICAgICAgICAgIHN0YWdnZXIgPSBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBzdGFnZ2VyQ2FjaGVLZXkpOwoKICAgICAgICAgIGFwcGx5Q2xhc3NlcyAmJiBlbGVtZW50LnJlbW92ZUNsYXNzKHN0YWdnZXJDbGFzc05hbWUpOwogICAgICAgIH0KCiAgICAgICAgLyogdGhlIGFuaW1hdGlvbiBpdHNlbGYgbWF5IG5lZWQgdG8gYWRkL3JlbW92ZSBzcGVjaWFsIENTUyBjbGFzc2VzCiAgICAgICAgICogYmVmb3JlIGNhbGN1bGF0aW5nIHRoZSBhbm1hdGlvbiBzdHlsZXMgKi8KICAgICAgICBjYWxjdWxhdGlvbkRlY29yYXRvciA9IGNhbGN1bGF0aW9uRGVjb3JhdG9yIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihmbikgeyByZXR1cm4gZm4oKTsgfTsKCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwoKICAgICAgICB2YXIgZm9ybWVyRGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSkgfHwge307CgogICAgICAgIHZhciB0aW1pbmdzID0gY2FsY3VsYXRpb25EZWNvcmF0b3IoZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gZ2V0RWxlbWVudEFuaW1hdGlvbkRldGFpbHMoZWxlbWVudCwgZXZlbnRDYWNoZUtleSk7CiAgICAgICAgfSk7CgogICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb24gPSB0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbjsKICAgICAgICB2YXIgYW5pbWF0aW9uRHVyYXRpb24gPSB0aW1pbmdzLmFuaW1hdGlvbkR1cmF0aW9uOwogICAgICAgIGlmKHRyYW5zaXRpb25EdXJhdGlvbiA9PT0gMCAmJiBhbmltYXRpb25EdXJhdGlvbiA9PT0gMCkgewogICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZLCB7CiAgICAgICAgICBydW5uaW5nIDogZm9ybWVyRGF0YS5ydW5uaW5nIHx8IDAsCiAgICAgICAgICBpdGVtSW5kZXggOiBpdGVtSW5kZXgsCiAgICAgICAgICBzdGFnZ2VyIDogc3RhZ2dlciwKICAgICAgICAgIHRpbWluZ3MgOiB0aW1pbmdzLAogICAgICAgICAgY2xvc2VBbmltYXRpb25GbiA6IG5vb3AKICAgICAgICB9KTsKCiAgICAgICAgLy90ZW1wb3JhcmlseSBkaXNhYmxlIHRoZSB0cmFuc2l0aW9uIHNvIHRoYXQgdGhlIGVudGVyIHN0eWxlcwogICAgICAgIC8vZG9uJ3QgYW5pbWF0ZSB0d2ljZSAodGhpcyBpcyBoZXJlIHRvIGF2b2lkIGEgYnVnIGluIENocm9tZS9GRikuCiAgICAgICAgdmFyIGlzQ3VycmVudGx5QW5pbWF0aW5nID0gZm9ybWVyRGF0YS5ydW5uaW5nID4gMCB8fCBhbmltYXRpb25FdmVudCA9PSAnc2V0Q2xhc3MnOwogICAgICAgIGlmKHRyYW5zaXRpb25EdXJhdGlvbiA+IDApIHsKICAgICAgICAgIGJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lLCBpc0N1cnJlbnRseUFuaW1hdGluZyk7CiAgICAgICAgfQoKICAgICAgICAvL3N0YWdnZXJpbmcga2V5ZnJhbWUgYW5pbWF0aW9ucyB3b3JrIGJ5IGFkanVzdGluZyB0aGUgYGFuaW1hdGlvbi1kZWxheWAgQ1NTIHByb3BlcnR5CiAgICAgICAgLy9vbiB0aGUgZ2l2ZW4gZWxlbWVudCwgaG93ZXZlciwgdGhlIGRlbGF5IHZhbHVlIGNhbiBvbmx5IGNhbGN1bGF0ZWQgYWZ0ZXIgdGhlIHJlZmxvdwogICAgICAgIC8vc2luY2UgYnkgdGhhdCB0aW1lICRhbmltYXRlIGtub3dzIGhvdyBtYW55IGVsZW1lbnRzIGFyZSBiZWluZyBhbmltYXRlZC4gVGhlcmVmb3JlLAogICAgICAgIC8vdW50aWwgdGhlIHJlZmxvdyBvY2N1cnMgdGhlIGVsZW1lbnQgbmVlZHMgdG8gYmUgYmxvY2tlZCAod2hlcmUgdGhlIGtleWZyYW1lIGFuaW1hdGlvbgogICAgICAgIC8vaXMgc2V0IHRvIGBub25lIDBzYCkuIFRoaXMgYmxvY2tpbmcgbWVjaGFuaXNtIHNob3VsZCBvbmx5IGJlIHNldCBmb3Igd2hlbiBhIHN0YWdnZXIKICAgICAgICAvL2FuaW1hdGlvbiBpcyBkZXRlY3RlZCBhbmQgd2hlbiB0aGUgZWxlbWVudCBpdGVtIGluZGV4IGlzIGdyZWF0ZXIgdGhhbiAwLgogICAgICAgIGlmKGFuaW1hdGlvbkR1cmF0aW9uID4gMCAmJiBzdGFnZ2VyLmFuaW1hdGlvbkRlbGF5ID4gMCAmJiBzdGFnZ2VyLmFuaW1hdGlvbkR1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICBibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBmdW5jdGlvbiBpc1N0cnVjdHVyYWxBbmltYXRpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgcmV0dXJuIGNsYXNzTmFtZSA9PSAnbmctZW50ZXInIHx8IGNsYXNzTmFtZSA9PSAnbmctbW92ZScgfHwgY2xhc3NOYW1lID09ICduZy1sZWF2ZSc7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lLCBpc0FuaW1hdGluZykgewogICAgICAgIGlmKGlzU3RydWN0dXJhbEFuaW1hdGlvbihjbGFzc05hbWUpIHx8ICFpc0FuaW1hdGluZykgewogICAgICAgICAgZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpLnN0eWxlW1RSQU5TSVRJT05fUFJPUCArIFBST1BFUlRZX0tFWV0gPSAnbm9uZSc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoTkdfQU5JTUFURV9CTE9DS19DTEFTU19OQU1FKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpIHsKICAgICAgICBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkuc3R5bGVbQU5JTUFUSU9OX1BST1BdID0gJ25vbmUgMHMnOwogICAgICB9CgogICAgICBmdW5jdGlvbiB1bmJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICAgICAgdmFyIHByb3AgPSBUUkFOU0lUSU9OX1BST1AgKyBQUk9QRVJUWV9LRVk7CiAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgaWYobm9kZS5zdHlsZVtwcm9wXSAmJiBub2RlLnN0eWxlW3Byb3BdLmxlbmd0aCA+IDApIHsKICAgICAgICAgIG5vZGUuc3R5bGVbcHJvcF0gPSAnJzsKICAgICAgICB9CiAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhOR19BTklNQVRFX0JMT0NLX0NMQVNTX05BTUUpOwogICAgICB9CgogICAgICBmdW5jdGlvbiB1bmJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpIHsKICAgICAgICB2YXIgcHJvcCA9IEFOSU1BVElPTl9QUk9QOwogICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgIGlmKG5vZGUuc3R5bGVbcHJvcF0gJiYgbm9kZS5zdHlsZVtwcm9wXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICBub2RlLnN0eWxlW3Byb3BdID0gJyc7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRlUnVuKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFjdGl2ZUFuaW1hdGlvbkNvbXBsZXRlKSB7CiAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgdmFyIGVsZW1lbnREYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICBpZihub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKS5pbmRleE9mKGNsYXNzTmFtZSkgPT0gLTEgfHwgIWVsZW1lbnREYXRhKSB7CiAgICAgICAgICBhY3RpdmVBbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGFjdGl2ZUNsYXNzTmFtZSA9ICcnOwogICAgICAgIGZvckVhY2goY2xhc3NOYW1lLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGtsYXNzLCBpKSB7CiAgICAgICAgICBhY3RpdmVDbGFzc05hbWUgKz0gKGkgPiAwID8gJyAnIDogJycpICsga2xhc3MgKyAnLWFjdGl2ZSc7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBzdGFnZ2VyID0gZWxlbWVudERhdGEuc3RhZ2dlcjsKICAgICAgICB2YXIgdGltaW5ncyA9IGVsZW1lbnREYXRhLnRpbWluZ3M7CiAgICAgICAgdmFyIGl0ZW1JbmRleCA9IGVsZW1lbnREYXRhLml0ZW1JbmRleDsKICAgICAgICB2YXIgbWF4RHVyYXRpb24gPSBNYXRoLm1heCh0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbiwgdGltaW5ncy5hbmltYXRpb25EdXJhdGlvbik7CiAgICAgICAgdmFyIG1heERlbGF5ID0gTWF0aC5tYXgodGltaW5ncy50cmFuc2l0aW9uRGVsYXksIHRpbWluZ3MuYW5pbWF0aW9uRGVsYXkpOwogICAgICAgIHZhciBtYXhEZWxheVRpbWUgPSBtYXhEZWxheSAqIE9ORV9TRUNPTkQ7CgogICAgICAgIHZhciBzdGFydFRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgIHZhciBjc3MzQW5pbWF0aW9uRXZlbnRzID0gQU5JTUFUSU9ORU5EX0VWRU5UICsgJyAnICsgVFJBTlNJVElPTkVORF9FVkVOVDsKCiAgICAgICAgdmFyIHN0eWxlID0gJycsIGFwcGxpZWRTdHlsZXMgPSBbXTsKICAgICAgICBpZih0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbiA+IDApIHsKICAgICAgICAgIHZhciBwcm9wZXJ0eVN0eWxlID0gdGltaW5ncy50cmFuc2l0aW9uUHJvcGVydHlTdHlsZTsKICAgICAgICAgIGlmKHByb3BlcnR5U3R5bGUuaW5kZXhPZignYWxsJykgPT0gLTEpIHsKICAgICAgICAgICAgc3R5bGUgKz0gQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLXByb3BlcnR5OiAnICsgcHJvcGVydHlTdHlsZSArICc7JzsKICAgICAgICAgICAgc3R5bGUgKz0gQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLWR1cmF0aW9uOiAnICsgdGltaW5ncy50cmFuc2l0aW9uRHVyYXRpb25TdHlsZSArICc7JzsKICAgICAgICAgICAgYXBwbGllZFN0eWxlcy5wdXNoKENTU19QUkVGSVggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eScpOwogICAgICAgICAgICBhcHBsaWVkU3R5bGVzLnB1c2goQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLWR1cmF0aW9uJyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihpdGVtSW5kZXggPiAwKSB7CiAgICAgICAgICBpZihzdGFnZ2VyLnRyYW5zaXRpb25EZWxheSA+IDAgJiYgc3RhZ2dlci50cmFuc2l0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgICAgdmFyIGRlbGF5U3R5bGUgPSB0aW1pbmdzLnRyYW5zaXRpb25EZWxheVN0eWxlOwogICAgICAgICAgICBzdHlsZSArPSBDU1NfUFJFRklYICsgJ3RyYW5zaXRpb24tZGVsYXk6ICcgKwogICAgICAgICAgICAgICAgICAgICBwcmVwYXJlU3RhZ2dlckRlbGF5KGRlbGF5U3R5bGUsIHN0YWdnZXIudHJhbnNpdGlvbkRlbGF5LCBpdGVtSW5kZXgpICsgJzsgJzsKICAgICAgICAgICAgYXBwbGllZFN0eWxlcy5wdXNoKENTU19QUkVGSVggKyAndHJhbnNpdGlvbi1kZWxheScpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKHN0YWdnZXIuYW5pbWF0aW9uRGVsYXkgPiAwICYmIHN0YWdnZXIuYW5pbWF0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgICAgc3R5bGUgKz0gQ1NTX1BSRUZJWCArICdhbmltYXRpb24tZGVsYXk6ICcgKwogICAgICAgICAgICAgICAgICAgICBwcmVwYXJlU3RhZ2dlckRlbGF5KHRpbWluZ3MuYW5pbWF0aW9uRGVsYXlTdHlsZSwgc3RhZ2dlci5hbmltYXRpb25EZWxheSwgaXRlbUluZGV4KSArICc7ICc7CiAgICAgICAgICAgIGFwcGxpZWRTdHlsZXMucHVzaChDU1NfUFJFRklYICsgJ2FuaW1hdGlvbi1kZWxheScpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYoYXBwbGllZFN0eWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAvL3RoZSBlbGVtZW50IGJlaW5nIGFuaW1hdGVkIG1heSBzb21ldGltZXMgY29udGFpbiBjb21tZW50IG5vZGVzIGluCiAgICAgICAgICAvL3RoZSBqcUxpdGUgb2JqZWN0LCBzbyB3ZSdyZSBzYWZlIHRvIHVzZSBhIHNpbmdsZSB2YXJpYWJsZSB0byBob3VzZQogICAgICAgICAgLy90aGUgc3R5bGVzIHNpbmNlIHRoZXJlIGlzIGFsd2F5cyBvbmx5IG9uZSBlbGVtZW50IGJlaW5nIGFuaW1hdGVkCiAgICAgICAgICB2YXIgb2xkU3R5bGUgPSBub2RlLmdldEF0dHJpYnV0ZSgnc3R5bGUnKSB8fCAnJzsKICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKCdzdHlsZScsIG9sZFN0eWxlICsgJzsgJyArIHN0eWxlKTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQub24oY3NzM0FuaW1hdGlvbkV2ZW50cywgb25BbmltYXRpb25Qcm9ncmVzcyk7CiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhhY3RpdmVDbGFzc05hbWUpOwogICAgICAgIGVsZW1lbnREYXRhLmNsb3NlQW5pbWF0aW9uRm4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIG9uRW5kKCk7CiAgICAgICAgICBhY3RpdmVBbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgIH07CgogICAgICAgIHZhciBzdGFnZ2VyVGltZSAgICAgICA9IGl0ZW1JbmRleCAqIChNYXRoLm1heChzdGFnZ2VyLmFuaW1hdGlvbkRlbGF5LCBzdGFnZ2VyLnRyYW5zaXRpb25EZWxheSkgfHwgMCk7CiAgICAgICAgdmFyIGFuaW1hdGlvblRpbWUgICAgID0gKG1heERlbGF5ICsgbWF4RHVyYXRpb24pICogQ0xPU0lOR19USU1FX0JVRkZFUjsKICAgICAgICB2YXIgdG90YWxUaW1lICAgICAgICAgPSAoc3RhZ2dlclRpbWUgKyBhbmltYXRpb25UaW1lKSAqIE9ORV9TRUNPTkQ7CgogICAgICAgIGVsZW1lbnREYXRhLnJ1bm5pbmcrKzsKICAgICAgICBhbmltYXRpb25DbG9zZUhhbmRsZXIoZWxlbWVudCwgdG90YWxUaW1lKTsKICAgICAgICByZXR1cm4gb25FbmQ7CgogICAgICAgIC8vIFRoaXMgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIGNhbGxlZCBieSAkYW5pbWF0ZSBzbwogICAgICAgIC8vIHRoZXJlIGlzIG5vIG5lZWQgdG8gYXR0YWNoIHRoaXMgaW50ZXJuYWxseSB0byB0aGUKICAgICAgICAvLyB0aW1lb3V0IGRvbmUgbWV0aG9kLgogICAgICAgIGZ1bmN0aW9uIG9uRW5kKGNhbmNlbGxlZCkgewogICAgICAgICAgZWxlbWVudC5vZmYoY3NzM0FuaW1hdGlvbkV2ZW50cywgb25BbmltYXRpb25Qcm9ncmVzcyk7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGFjdGl2ZUNsYXNzTmFtZSk7CiAgICAgICAgICBhbmltYXRlQ2xvc2UoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgICAgZm9yICh2YXIgaSBpbiBhcHBsaWVkU3R5bGVzKSB7CiAgICAgICAgICAgIG5vZGUuc3R5bGUucmVtb3ZlUHJvcGVydHkoYXBwbGllZFN0eWxlc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbkFuaW1hdGlvblByb2dyZXNzKGV2ZW50KSB7CiAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIHZhciBldiA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgZXZlbnQ7CiAgICAgICAgICB2YXIgdGltZVN0YW1wID0gZXYuJG1hbnVhbFRpbWVTdGFtcCB8fCBldi50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKCiAgICAgICAgICAvKiBGaXJlZm94IChvciBwb3NzaWJseSBqdXN0IEdlY2tvKSBsaWtlcyB0byBub3Qgcm91bmQgdmFsdWVzIHVwCiAgICAgICAgICAgKiB3aGVuIGEgbXMgbWVhc3VyZW1lbnQgaXMgdXNlZCBmb3IgdGhlIGFuaW1hdGlvbiAqLwogICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gcGFyc2VGbG9hdChldi5lbGFwc2VkVGltZS50b0ZpeGVkKEVMQVBTRURfVElNRV9NQVhfREVDSU1BTF9QTEFDRVMpKTsKCiAgICAgICAgICAvKiAkbWFudWFsVGltZVN0YW1wIGlzIGEgbW9ja2VkIHRpbWVTdGFtcCB2YWx1ZSB3aGljaCBpcyBzZXQKICAgICAgICAgICAqIHdpdGhpbiBicm93c2VyVHJpZ2dlcigpLiBUaGlzIGlzIG9ubHkgaGVyZSBzbyB0aGF0IHRlc3RzIGNhbgogICAgICAgICAgICogbW9jayBhbmltYXRpb25zIHByb3Blcmx5LiBSZWFsIGV2ZW50cyBmYWxsYmFjayB0byBldmVudC50aW1lU3RhbXAsCiAgICAgICAgICAgKiBvciwgaWYgdGhleSBkb24ndCwgdGhlbiBhIHRpbWVTdGFtcCBpcyBhdXRvbWF0aWNhbGx5IGNyZWF0ZWQgZm9yIHRoZW0uCiAgICAgICAgICAgKiBXZSdyZSBjaGVja2luZyB0byBzZWUgaWYgdGhlIHRpbWVTdGFtcCBzdXJwYXNzZXMgdGhlIGV4cGVjdGVkIGRlbGF5LAogICAgICAgICAgICogYnV0IHdlJ3JlIHVzaW5nIGVsYXBzZWRUaW1lIGluc3RlYWQgb2YgdGhlIHRpbWVTdGFtcCBvbiB0aGUgMm5kCiAgICAgICAgICAgKiBwcmUtY29uZGl0aW9uIHNpbmNlIGFuaW1hdGlvbnMgc29tZXRpbWVzIGNsb3NlIG9mZiBlYXJseSAqLwogICAgICAgICAgaWYoTWF0aC5tYXgodGltZVN0YW1wIC0gc3RhcnRUaW1lLCAwKSA+PSBtYXhEZWxheVRpbWUgJiYgZWxhcHNlZFRpbWUgPj0gbWF4RHVyYXRpb24pIHsKICAgICAgICAgICAgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHByZXBhcmVTdGFnZ2VyRGVsYXkoZGVsYXlTdHlsZSwgc3RhZ2dlckRlbGF5LCBpbmRleCkgewogICAgICAgIHZhciBzdHlsZSA9ICcnOwogICAgICAgIGZvckVhY2goZGVsYXlTdHlsZS5zcGxpdCgnLCcpLCBmdW5jdGlvbih2YWwsIGkpIHsKICAgICAgICAgIHN0eWxlICs9IChpID4gMCA/ICcsJyA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAoaW5kZXggKiBzdGFnZ2VyRGVsYXkgKyBwYXJzZUludCh2YWwsIDEwKSkgKyAncyc7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHN0eWxlOwogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRlQmVmb3JlKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGNhbGN1bGF0aW9uRGVjb3JhdG9yKSB7CiAgICAgICAgaWYoYW5pbWF0ZVNldHVwKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGNhbGN1bGF0aW9uRGVjb3JhdG9yKSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbmNlbGxlZCkgewogICAgICAgICAgICBjYW5jZWxsZWQgJiYgYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0ZUFmdGVyKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUpIHsKICAgICAgICBpZihlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DU1NfREFUQV9LRVkpKSB7CiAgICAgICAgICByZXR1cm4gYW5pbWF0ZVJ1bihhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRlKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlKSB7CiAgICAgICAgLy9JZiB0aGUgYW5pbWF0ZVNldHVwIGZ1bmN0aW9uIGRvZXNuJ3QgYm90aGVyIHJldHVybmluZyBhCiAgICAgICAgLy9jYW5jZWxsYXRpb24gZnVuY3Rpb24gdGhlbiBpdCBtZWFucyB0aGF0IHRoZXJlIGlzIG5vIGFuaW1hdGlvbgogICAgICAgIC8vdG8gcGVyZm9ybSBhdCBhbGwKICAgICAgICB2YXIgcHJlUmVmbG93Q2FuY2VsbGF0aW9uID0gYW5pbWF0ZUJlZm9yZShhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICBpZighcHJlUmVmbG93Q2FuY2VsbGF0aW9uKSB7CiAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy9UaGVyZSBhcmUgdHdvIGNhbmNlbGxhdGlvbiBmdW5jdGlvbnM6IG9uZSBpcyBiZWZvcmUgdGhlIGZpcnN0CiAgICAgICAgLy9yZWZsb3cgYW5pbWF0aW9uIGFuZCB0aGUgc2Vjb25kIGlzIGR1cmluZyB0aGUgYWN0aXZlIHN0YXRlCiAgICAgICAgLy9hbmltYXRpb24uIFRoZSBmaXJzdCBmdW5jdGlvbiB3aWxsIHRha2UgY2FyZSBvZiByZW1vdmluZyB0aGUKICAgICAgICAvL2RhdGEgZnJvbSB0aGUgZWxlbWVudCB3aGljaCB3aWxsIG5vdCBtYWtlIHRoZSAybmQgYW5pbWF0aW9uCiAgICAgICAgLy9oYXBwZW4gaW4gdGhlIGZpcnN0IHBsYWNlCiAgICAgICAgdmFyIGNhbmNlbCA9IHByZVJlZmxvd0NhbmNlbGxhdGlvbjsKICAgICAgICBhZnRlclJlZmxvdyhlbGVtZW50LCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgdW5ibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgIC8vb25jZSB0aGUgcmVmbG93IGlzIGNvbXBsZXRlIHRoZW4gd2UgcG9pbnQgY2FuY2VsIHRvCiAgICAgICAgICAvL3RoZSBuZXcgY2FuY2VsbGF0aW9uIGZ1bmN0aW9uIHdoaWNoIHdpbGwgcmVtb3ZlIGFsbCBvZiB0aGUKICAgICAgICAgIC8vYW5pbWF0aW9uIHByb3BlcnRpZXMgZnJvbSB0aGUgYWN0aXZlIGFuaW1hdGlvbgogICAgICAgICAgY2FuY2VsID0gYW5pbWF0ZUFmdGVyKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbmNlbGxlZCkgewogICAgICAgICAgKGNhbmNlbCB8fCBub29wKShjYW5jZWxsZWQpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DU1NfREFUQV9LRVkpOwogICAgICAgIGlmKGRhdGEpIHsKICAgICAgICAgIGlmKGRhdGEucnVubmluZykgewogICAgICAgICAgICBkYXRhLnJ1bm5pbmctLTsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCFkYXRhLnJ1bm5pbmcgfHwgZGF0YS5ydW5uaW5nID09PSAwKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGVudGVyIDogZnVuY3Rpb24oZWxlbWVudCwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICByZXR1cm4gYW5pbWF0ZSgnZW50ZXInLCBlbGVtZW50LCAnbmctZW50ZXInLCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgIH0sCgogICAgICAgIGxlYXZlIDogZnVuY3Rpb24oZWxlbWVudCwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICByZXR1cm4gYW5pbWF0ZSgnbGVhdmUnLCBlbGVtZW50LCAnbmctbGVhdmUnLCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgIH0sCgogICAgICAgIG1vdmUgOiBmdW5jdGlvbihlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgIHJldHVybiBhbmltYXRlKCdtb3ZlJywgZWxlbWVudCwgJ25nLW1vdmUnLCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgIH0sCgogICAgICAgIGJlZm9yZVNldENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgdmFyIGNsYXNzTmFtZSA9IHN1ZmZpeENsYXNzZXMocmVtb3ZlLCAnLXJlbW92ZScpICsgJyAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXhDbGFzc2VzKGFkZCwgJy1hZGQnKTsKICAgICAgICAgIHZhciBjYW5jZWxsYXRpb25NZXRob2QgPSBhbmltYXRlQmVmb3JlKCdzZXRDbGFzcycsIGVsZW1lbnQsIGNsYXNzTmFtZSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgLyogd2hlbiBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gYW4gZWxlbWVudCB0aGVuIHRoZSB0cmFuc2l0aW9uIHN0eWxlCiAgICAgICAgICAgICAqIHRoYXQgaXMgYXBwbGllZCBpcyB0aGUgdHJhbnNpdGlvbiBkZWZpbmVkIG9uIHRoZSBlbGVtZW50IHdpdGhvdXQgdGhlCiAgICAgICAgICAgICAqIENTUyBjbGFzcyBiZWluZyB0aGVyZS4gVGhpcyBpcyBob3cgQ1NTMyBmdW5jdGlvbnMgb3V0c2lkZSBvZiBuZ0FuaW1hdGUuCiAgICAgICAgICAgICAqIGh0dHA6Ly9wbG5rci5jby9lZGl0L2o4T3pnVE54SFRiNG4zekx5akdXP3A9cHJldmlldyAqLwogICAgICAgICAgICB2YXIga2xhc3MgPSBlbGVtZW50LmF0dHIoJ2NsYXNzJyk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MocmVtb3ZlKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhhZGQpOwogICAgICAgICAgICB2YXIgdGltaW5ncyA9IGZuKCk7CiAgICAgICAgICAgIGVsZW1lbnQuYXR0cignY2xhc3MnLCBrbGFzcyk7CiAgICAgICAgICAgIHJldHVybiB0aW1pbmdzOwogICAgICAgICAgfSk7CgogICAgICAgICAgaWYoY2FuY2VsbGF0aW9uTWV0aG9kKSB7CiAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgIHVuYmxvY2tLZXlmcmFtZUFuaW1hdGlvbnMoZWxlbWVudCk7CiAgICAgICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2FuY2VsbGF0aW9uTWV0aG9kOwogICAgICAgICAgfQogICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgfSwKCiAgICAgICAgYmVmb3JlQWRkQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ2FkZENsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctYWRkJyksIGZ1bmN0aW9uKGZuKSB7CgogICAgICAgICAgICAvKiB3aGVuIGEgQ1NTIGNsYXNzIGlzIGFkZGVkIHRvIGFuIGVsZW1lbnQgdGhlbiB0aGUgdHJhbnNpdGlvbiBzdHlsZSB0aGF0CiAgICAgICAgICAgICAqIGlzIGFwcGxpZWQgaXMgdGhlIHRyYW5zaXRpb24gZGVmaW5lZCBvbiB0aGUgZWxlbWVudCB3aGVuIHRoZSBDU1MgY2xhc3MKICAgICAgICAgICAgICogaXMgYWRkZWQgYXQgdGhlIHRpbWUgb2YgdGhlIGFuaW1hdGlvbi4gVGhpcyBpcyBob3cgQ1NTMyBmdW5jdGlvbnMKICAgICAgICAgICAgICogb3V0c2lkZSBvZiBuZ0FuaW1hdGUuICovCiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgdmFyIHRpbWluZ3MgPSBmbigpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIHJldHVybiB0aW1pbmdzOwogICAgICAgICAgfSk7CgogICAgICAgICAgaWYoY2FuY2VsbGF0aW9uTWV0aG9kKSB7CiAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgIHVuYmxvY2tLZXlmcmFtZUFuaW1hdGlvbnMoZWxlbWVudCk7CiAgICAgICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2FuY2VsbGF0aW9uTWV0aG9kOwogICAgICAgICAgfQogICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgfSwKCiAgICAgICAgc2V0Q2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICByZW1vdmUgPSBzdWZmaXhDbGFzc2VzKHJlbW92ZSwgJy1yZW1vdmUnKTsKICAgICAgICAgIGFkZCA9IHN1ZmZpeENsYXNzZXMoYWRkLCAnLWFkZCcpOwogICAgICAgICAgdmFyIGNsYXNzTmFtZSA9IHJlbW92ZSArICcgJyArIGFkZDsKICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ3NldENsYXNzJywgZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgIH0sCgogICAgICAgIGFkZENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ2FkZENsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctYWRkJyksIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgfSwKCiAgICAgICAgYmVmb3JlUmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ3JlbW92ZUNsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctcmVtb3ZlJyksIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIC8qIHdoZW4gY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIGFuIGVsZW1lbnQgdGhlbiB0aGUgdHJhbnNpdGlvbiBzdHlsZQogICAgICAgICAgICAgKiB0aGF0IGlzIGFwcGxpZWQgaXMgdGhlIHRyYW5zaXRpb24gZGVmaW5lZCBvbiB0aGUgZWxlbWVudCB3aXRob3V0IHRoZQogICAgICAgICAgICAgKiBDU1MgY2xhc3MgYmVpbmcgdGhlcmUuIFRoaXMgaXMgaG93IENTUzMgZnVuY3Rpb25zIG91dHNpZGUgb2YgbmdBbmltYXRlLgogICAgICAgICAgICAgKiBodHRwOi8vcGxua3IuY28vZWRpdC9qOE96Z1ROeEhUYjRuM3pMeWpHVz9wPXByZXZpZXcgKi8KICAgICAgICAgICAgdmFyIGtsYXNzID0gZWxlbWVudC5hdHRyKCdjbGFzcycpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIHZhciB0aW1pbmdzID0gZm4oKTsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKCdjbGFzcycsIGtsYXNzKTsKICAgICAgICAgICAgcmV0dXJuIHRpbWluZ3M7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZihjYW5jZWxsYXRpb25NZXRob2QpIHsKICAgICAgICAgICAgYWZ0ZXJSZWZsb3coZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdW5ibG9ja1RyYW5zaXRpb25zKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgdW5ibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICB9CiAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICByZXR1cm4gYW5pbWF0ZUFmdGVyKCdyZW1vdmVDbGFzcycsIGVsZW1lbnQsIHN1ZmZpeENsYXNzZXMoY2xhc3NOYW1lLCAnLXJlbW92ZScpLCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIHN1ZmZpeENsYXNzZXMoY2xhc3Nlcywgc3VmZml4KSB7CiAgICAgICAgdmFyIGNsYXNzTmFtZSA9ICcnOwogICAgICAgIGNsYXNzZXMgPSBhbmd1bGFyLmlzQXJyYXkoY2xhc3NlcykgPyBjbGFzc2VzIDogY2xhc3Nlcy5zcGxpdCgvXHMrLyk7CiAgICAgICAgZm9yRWFjaChjbGFzc2VzLCBmdW5jdGlvbihrbGFzcywgaSkgewogICAgICAgICAgaWYoa2xhc3MgJiYga2xhc3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjbGFzc05hbWUgKz0gKGkgPiAwID8gJyAnIDogJycpICsga2xhc3MgKyBzdWZmaXg7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNsYXNzTmFtZTsKICAgICAgfQogICAgfV0pOwogIH1dKTsKCgp9KSh3aW5kb3csIHdpbmRvdy5hbmd1bGFyKTsKCi8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKioKICogQGxpY2Vuc2UgQW5ndWxhckpTIHYxLjIuMTcKICogKGMpIDIwMTAtMjAxNCBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBhbmd1bGFyLCB1bmRlZmluZWQpIHsndXNlIHN0cmljdCc7Cgp2YXIgJHNhbml0aXplTWluRXJyID0gYW5ndWxhci4kJG1pbkVycignJHNhbml0aXplJyk7CgovKioKICogQG5nZG9jIG1vZHVsZQogKiBAbmFtZSBuZ1Nhbml0aXplCiAqIEBkZXNjcmlwdGlvbgogKgogKiAjIG5nU2FuaXRpemUKICoKICogVGhlIGBuZ1Nhbml0aXplYCBtb2R1bGUgcHJvdmlkZXMgZnVuY3Rpb25hbGl0eSB0byBzYW5pdGl6ZSBIVE1MLgogKgogKgogKiA8ZGl2IGRvYy1tb2R1bGUtY29tcG9uZW50cz0ibmdTYW5pdGl6ZSI+PC9kaXY+CiAqCiAqIFNlZSB7QGxpbmsgbmdTYW5pdGl6ZS4kc2FuaXRpemUgYCRzYW5pdGl6ZWB9IGZvciB1c2FnZS4KICovCgovKgogKiBIVE1MIFBhcnNlciBCeSBNaXNrbyBIZXZlcnkgKG1pc2tvQGhldmVyeS5jb20pCiAqIGJhc2VkIG9uOiAgSFRNTCBQYXJzZXIgQnkgSm9obiBSZXNpZyAoZWpvaG4ub3JnKQogKiBPcmlnaW5hbCBjb2RlIGJ5IEVyaWsgQXJ2aWRzc29uLCBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIGh0dHA6Ly9lcmlrLmVhZS5uZXQvc2ltcGxlaHRtbHBhcnNlci9zaW1wbGVodG1scGFyc2VyLmpzCiAqCiAqIC8vIFVzZSBsaWtlIHNvOgogKiBodG1sUGFyc2VyKGh0bWxTdHJpbmcsIHsKICogICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSkge30sCiAqICAgICBlbmQ6IGZ1bmN0aW9uKHRhZykge30sCiAqICAgICBjaGFyczogZnVuY3Rpb24odGV4dCkge30sCiAqICAgICBjb21tZW50OiBmdW5jdGlvbih0ZXh0KSB7fQogKiB9KTsKICoKICovCgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRzYW5pdGl6ZQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogICBUaGUgaW5wdXQgaXMgc2FuaXRpemVkIGJ5IHBhcnNpbmcgdGhlIGh0bWwgaW50byB0b2tlbnMuIEFsbCBzYWZlIHRva2VucyAoZnJvbSBhIHdoaXRlbGlzdCkgYXJlCiAqICAgdGhlbiBzZXJpYWxpemVkIGJhY2sgdG8gcHJvcGVybHkgZXNjYXBlZCBodG1sIHN0cmluZy4gVGhpcyBtZWFucyB0aGF0IG5vIHVuc2FmZSBpbnB1dCBjYW4gbWFrZQogKiAgIGl0IGludG8gdGhlIHJldHVybmVkIHN0cmluZywgaG93ZXZlciwgc2luY2Ugb3VyIHBhcnNlciBpcyBtb3JlIHN0cmljdCB0aGFuIGEgdHlwaWNhbCBicm93c2VyCiAqICAgcGFyc2VyLCBpdCdzIHBvc3NpYmxlIHRoYXQgc29tZSBvYnNjdXJlIGlucHV0LCB3aGljaCB3b3VsZCBiZSByZWNvZ25pemVkIGFzIHZhbGlkIEhUTUwgYnkgYQogKiAgIGJyb3dzZXIsIHdvbid0IG1ha2UgaXQgdGhyb3VnaCB0aGUgc2FuaXRpemVyLgogKiAgIFRoZSB3aGl0ZWxpc3QgaXMgY29uZmlndXJlZCB1c2luZyB0aGUgZnVuY3Rpb25zIGBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdGAgYW5kCiAqICAgYGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdGAgb2Yge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIgYCRjb21waWxlUHJvdmlkZXJgfS4KICoKICogQHBhcmFtIHtzdHJpbmd9IGh0bWwgSHRtbCBpbnB1dC4KICogQHJldHVybnMge3N0cmluZ30gU2FuaXRpemVkIGh0bWwuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdTYW5pdGl6ZSIgZGVwcz0iYW5ndWxhci1zYW5pdGl6ZS5qcyI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxzY3JpcHQ+CiAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSwgJHNjZSkgewogICAgICAgICAkc2NvcGUuc25pcHBldCA9CiAgICAgICAgICAgJzxwIHN0eWxlPSJjb2xvcjpibHVlIj5hbiBodG1sXG4nICsKICAgICAgICAgICAnPGVtIG9ubW91c2VvdmVyPSJ0aGlzLnRleHRDb250ZW50PVwnUFdOM0QhXCciPmNsaWNrIGhlcmU8L2VtPlxuJyArCiAgICAgICAgICAgJ3NuaXBwZXQ8L3A+JzsKICAgICAgICAgJHNjb3BlLmRlbGliZXJhdGVseVRydXN0RGFuZ2Vyb3VzU25pcHBldCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgIHJldHVybiAkc2NlLnRydXN0QXNIdG1sKCRzY29wZS5zbmlwcGV0KTsKICAgICAgICAgfTsKICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgIFNuaXBwZXQ6IDx0ZXh0YXJlYSBuZy1tb2RlbD0ic25pcHBldCIgY29scz0iNjAiIHJvd3M9IjMiPjwvdGV4dGFyZWE+CiAgICAgICA8dGFibGU+CiAgICAgICAgIDx0cj4KICAgICAgICAgICA8dGQ+RGlyZWN0aXZlPC90ZD4KICAgICAgICAgICA8dGQ+SG93PC90ZD4KICAgICAgICAgICA8dGQ+U291cmNlPC90ZD4KICAgICAgICAgICA8dGQ+UmVuZGVyZWQ8L3RkPgogICAgICAgICA8L3RyPgogICAgICAgICA8dHIgaWQ9ImJpbmQtaHRtbC13aXRoLXNhbml0aXplIj4KICAgICAgICAgICA8dGQ+bmctYmluZC1odG1sPC90ZD4KICAgICAgICAgICA8dGQ+QXV0b21hdGljYWxseSB1c2VzICRzYW5pdGl6ZTwvdGQ+CiAgICAgICAgICAgPHRkPjxwcmU+Jmx0O2RpdiBuZy1iaW5kLWh0bWw9InNuaXBwZXQiJmd0Ozxici8+Jmx0Oy9kaXYmZ3Q7PC9wcmU+PC90ZD4KICAgICAgICAgICA8dGQ+PGRpdiBuZy1iaW5kLWh0bWw9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0iYmluZC1odG1sLXdpdGgtdHJ1c3QiPgogICAgICAgICAgIDx0ZD5uZy1iaW5kLWh0bWw8L3RkPgogICAgICAgICAgIDx0ZD5CeXBhc3MgJHNhbml0aXplIGJ5IGV4cGxpY2l0bHkgdHJ1c3RpbmcgdGhlIGRhbmdlcm91cyB2YWx1ZTwvdGQ+CiAgICAgICAgICAgPHRkPgogICAgICAgICAgIDxwcmU+Jmx0O2RpdiBuZy1iaW5kLWh0bWw9ImRlbGliZXJhdGVseVRydXN0RGFuZ2Vyb3VzU25pcHBldCgpIiZndDsKJmx0Oy9kaXYmZ3Q7PC9wcmU+CiAgICAgICAgICAgPC90ZD4KICAgICAgICAgICA8dGQ+PGRpdiBuZy1iaW5kLWh0bWw9ImRlbGliZXJhdGVseVRydXN0RGFuZ2Vyb3VzU25pcHBldCgpIj48L2Rpdj48L3RkPgogICAgICAgICA8L3RyPgogICAgICAgICA8dHIgaWQ9ImJpbmQtZGVmYXVsdCI+CiAgICAgICAgICAgPHRkPm5nLWJpbmQ8L3RkPgogICAgICAgICAgIDx0ZD5BdXRvbWF0aWNhbGx5IGVzY2FwZXM8L3RkPgogICAgICAgICAgIDx0ZD48cHJlPiZsdDtkaXYgbmctYmluZD0ic25pcHBldCImZ3Q7PGJyLz4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICAgICAgICAgIDx0ZD48ZGl2IG5nLWJpbmQ9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICA8L3RhYmxlPgogICAgICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgaXQoJ3Nob3VsZCBzYW5pdGl6ZSB0aGUgaHRtbCBzbmlwcGV0IGJ5IGRlZmF1bHQnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI2JpbmQtaHRtbC13aXRoLXNhbml0aXplIGRpdicpKS5nZXRJbm5lckh0bWwoKSkuCiAgICAgICAgIHRvQmUoJzxwPmFuIGh0bWxcbjxlbT5jbGljayBoZXJlPC9lbT5cbnNuaXBwZXQ8L3A+Jyk7CiAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgaW5saW5lIHJhdyBzbmlwcGV0IGlmIGJvdW5kIHRvIGEgdHJ1c3RlZCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1odG1sLXdpdGgtdHJ1c3QgZGl2JykpLmdldElubmVySHRtbCgpKS4KICAgICAgICAgdG9CZSgiPHAgc3R5bGU9XCJjb2xvcjpibHVlXCI+YW4gaHRtbFxuIiArCiAgICAgICAgICAgICAgIjxlbSBvbm1vdXNlb3Zlcj1cInRoaXMudGV4dENvbnRlbnQ9J1BXTjNEISdcIj5jbGljayBoZXJlPC9lbT5cbiIgKwogICAgICAgICAgICAgICJzbmlwcGV0PC9wPiIpOwogICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGVzY2FwZSBzbmlwcGV0IHdpdGhvdXQgYW55IGZpbHRlcicsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1kZWZhdWx0IGRpdicpKS5nZXRJbm5lckh0bWwoKSkuCiAgICAgICAgIHRvQmUoIiZsdDtwIHN0eWxlPVwiY29sb3I6Ymx1ZVwiJmd0O2FuIGh0bWxcbiIgKwogICAgICAgICAgICAgICImbHQ7ZW0gb25tb3VzZW92ZXI9XCJ0aGlzLnRleHRDb250ZW50PSdQV04zRCEnXCImZ3Q7Y2xpY2sgaGVyZSZsdDsvZW0mZ3Q7XG4iICsKICAgICAgICAgICAgICAic25pcHBldCZsdDsvcCZndDsiKTsKICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3NuaXBwZXQnKSkuY2xlYXIoKTsKICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3NuaXBwZXQnKSkuc2VuZEtleXMoJ25ldyA8YiBvbmNsaWNrPSJhbGVydCgxKSI+dGV4dDwvYj4nKTsKICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI2JpbmQtaHRtbC13aXRoLXNhbml0aXplIGRpdicpKS5nZXRJbm5lckh0bWwoKSkuCiAgICAgICAgIHRvQmUoJ25ldyA8Yj50ZXh0PC9iPicpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1odG1sLXdpdGgtdHJ1c3QgZGl2JykpLmdldElubmVySHRtbCgpKS50b0JlKAogICAgICAgICAnbmV3IDxiIG9uY2xpY2s9ImFsZXJ0KDEpIj50ZXh0PC9iPicpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1kZWZhdWx0IGRpdicpKS5nZXRJbm5lckh0bWwoKSkudG9CZSgKICAgICAgICAgIm5ldyAmbHQ7YiBvbmNsaWNrPVwiYWxlcnQoMSlcIiZndDt0ZXh0Jmx0Oy9iJmd0OyIpOwogICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uICRTYW5pdGl6ZVByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJCRzYW5pdGl6ZVVyaScsIGZ1bmN0aW9uKCQkc2FuaXRpemVVcmkpIHsKICAgIHJldHVybiBmdW5jdGlvbihodG1sKSB7CiAgICAgIHZhciBidWYgPSBbXTsKICAgICAgaHRtbFBhcnNlcihodG1sLCBodG1sU2FuaXRpemVXcml0ZXIoYnVmLCBmdW5jdGlvbih1cmksIGlzSW1hZ2UpIHsKICAgICAgICByZXR1cm4gIS9edW5zYWZlLy50ZXN0KCQkc2FuaXRpemVVcmkodXJpLCBpc0ltYWdlKSk7CiAgICAgIH0pKTsKICAgICAgcmV0dXJuIGJ1Zi5qb2luKCcnKTsKICAgIH07CiAgfV07Cn0KCmZ1bmN0aW9uIHNhbml0aXplVGV4dChjaGFycykgewogIHZhciBidWYgPSBbXTsKICB2YXIgd3JpdGVyID0gaHRtbFNhbml0aXplV3JpdGVyKGJ1ZiwgYW5ndWxhci5ub29wKTsKICB3cml0ZXIuY2hhcnMoY2hhcnMpOwogIHJldHVybiBidWYuam9pbignJyk7Cn0KCgovLyBSZWd1bGFyIEV4cHJlc3Npb25zIGZvciBwYXJzaW5nIHRhZ3MgYW5kIGF0dHJpYnV0ZXMKdmFyIFNUQVJUX1RBR19SRUdFWFAgPQogICAgICAgL148XHMqKFtcdzotXSspKCg/OlxzK1tcdzotXSsoPzpccyo9XHMqKD86KD86IlteIl0qIil8KD86J1teJ10qJyl8W14+XHNdKykpPykqKVxzKihcLz8pXHMqPi8sCiAgRU5EX1RBR19SRUdFWFAgPSAvXjxccypcL1xzKihbXHc6LV0rKVtePl0qPi8sCiAgQVRUUl9SRUdFWFAgPSAvKFtcdzotXSspKD86XHMqPVxzKig/Oig/OiIoKD86W14iXSkqKSIpfCg/OicoKD86W14nXSkqKScpfChbXj5cc10rKSkpPy9nLAogIEJFR0lOX1RBR19SRUdFWFAgPSAvXjwvLAogIEJFR0lOR19FTkRfVEFHRV9SRUdFWFAgPSAvXjxccypcLy8sCiAgQ09NTUVOVF9SRUdFWFAgPSAvPCEtLSguKj8pLS0+L2csCiAgRE9DVFlQRV9SRUdFWFAgPSAvPCFET0NUWVBFKFtePl0qPyk+L2ksCiAgQ0RBVEFfUkVHRVhQID0gLzwhXFtDREFUQVxbKC4qPyldXT4vZywKICBTVVJST0dBVEVfUEFJUl9SRUdFWFAgPSAvW1x1RDgwMC1cdURCRkZdW1x1REMwMC1cdURGRkZdL2csCiAgLy8gTWF0Y2ggZXZlcnl0aGluZyBvdXRzaWRlIG9mIG5vcm1hbCBjaGFycyBhbmQgIiAocXVvdGUgY2hhcmFjdGVyKQogIE5PTl9BTFBIQU5VTUVSSUNfUkVHRVhQID0gLyhbXlwjLX58IHwhXSkvZzsKCgovLyBHb29kIHNvdXJjZSBvZiBpbmZvIGFib3V0IGVsZW1lbnRzIGFuZCBhdHRyaWJ1dGVzCi8vIGh0dHA6Ly9kZXYudzMub3JnL2h0bWw1L3NwZWMvT3ZlcnZpZXcuaHRtbCNzZW1hbnRpY3MKLy8gaHR0cDovL3NpbW9uLmh0bWw1Lm9yZy9odG1sLWVsZW1lbnRzCgovLyBTYWZlIFZvaWQgRWxlbWVudHMgLSBIVE1MNQovLyBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdm9pZC1lbGVtZW50cwp2YXIgdm9pZEVsZW1lbnRzID0gbWFrZU1hcCgiYXJlYSxicixjb2wsaHIsaW1nLHdiciIpOwoKLy8gRWxlbWVudHMgdGhhdCB5b3UgY2FuLCBpbnRlbnRpb25hbGx5LCBsZWF2ZSBvcGVuIChhbmQgd2hpY2ggY2xvc2UgdGhlbXNlbHZlcykKLy8gaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI29wdGlvbmFsLXRhZ3MKdmFyIG9wdGlvbmFsRW5kVGFnQmxvY2tFbGVtZW50cyA9IG1ha2VNYXAoImNvbGdyb3VwLGRkLGR0LGxpLHAsdGJvZHksdGQsdGZvb3QsdGgsdGhlYWQsdHIiKSwKICAgIG9wdGlvbmFsRW5kVGFnSW5saW5lRWxlbWVudHMgPSBtYWtlTWFwKCJycCxydCIpLAogICAgb3B0aW9uYWxFbmRUYWdFbGVtZW50cyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbmFsRW5kVGFnSW5saW5lRWxlbWVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uYWxFbmRUYWdCbG9ja0VsZW1lbnRzKTsKCi8vIFNhZmUgQmxvY2sgRWxlbWVudHMgLSBIVE1MNQp2YXIgYmxvY2tFbGVtZW50cyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBvcHRpb25hbEVuZFRhZ0Jsb2NrRWxlbWVudHMsIG1ha2VNYXAoImFkZHJlc3MsYXJ0aWNsZSwiICsKICAgICAgICAiYXNpZGUsYmxvY2txdW90ZSxjYXB0aW9uLGNlbnRlcixkZWwsZGlyLGRpdixkbCxmaWd1cmUsZmlnY2FwdGlvbixmb290ZXIsaDEsaDIsaDMsaDQsaDUsIiArCiAgICAgICAgImg2LGhlYWRlcixoZ3JvdXAsaHIsaW5zLG1hcCxtZW51LG5hdixvbCxwcmUsc2NyaXB0LHNlY3Rpb24sdGFibGUsdWwiKSk7CgovLyBJbmxpbmUgRWxlbWVudHMgLSBIVE1MNQp2YXIgaW5saW5lRWxlbWVudHMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgb3B0aW9uYWxFbmRUYWdJbmxpbmVFbGVtZW50cywgbWFrZU1hcCgiYSxhYmJyLGFjcm9ueW0sYiwiICsKICAgICAgICAiYmRpLGJkbyxiaWcsYnIsY2l0ZSxjb2RlLGRlbCxkZm4sZW0sZm9udCxpLGltZyxpbnMsa2JkLGxhYmVsLG1hcCxtYXJrLHEscnVieSxycCxydCxzLCIgKwogICAgICAgICJzYW1wLHNtYWxsLHNwYW4sc3RyaWtlLHN0cm9uZyxzdWIsc3VwLHRpbWUsdHQsdSx2YXIiKSk7CgoKLy8gU3BlY2lhbCBFbGVtZW50cyAoY2FuIGNvbnRhaW4gYW55dGhpbmcpCnZhciBzcGVjaWFsRWxlbWVudHMgPSBtYWtlTWFwKCJzY3JpcHQsc3R5bGUiKTsKCnZhciB2YWxpZEVsZW1lbnRzID0gYW5ndWxhci5leHRlbmQoe30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9pZEVsZW1lbnRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrRWxlbWVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5saW5lRWxlbWVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uYWxFbmRUYWdFbGVtZW50cyk7CgovL0F0dHJpYnV0ZXMgdGhhdCBoYXZlIGhyZWYgYW5kIGhlbmNlIG5lZWQgdG8gYmUgc2FuaXRpemVkCnZhciB1cmlBdHRycyA9IG1ha2VNYXAoImJhY2tncm91bmQsY2l0ZSxocmVmLGxvbmdkZXNjLHNyYyx1c2VtYXAiKTsKdmFyIHZhbGlkQXR0cnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgdXJpQXR0cnMsIG1ha2VNYXAoCiAgICAnYWJicixhbGlnbixhbHQsYXhpcyxiZ2NvbG9yLGJvcmRlcixjZWxscGFkZGluZyxjZWxsc3BhY2luZyxjbGFzcyxjbGVhciwnKwogICAgJ2NvbG9yLGNvbHMsY29sc3Bhbixjb21wYWN0LGNvb3JkcyxkaXIsZmFjZSxoZWFkZXJzLGhlaWdodCxocmVmbGFuZyxoc3BhY2UsJysKICAgICdpc21hcCxsYW5nLGxhbmd1YWdlLG5vaHJlZixub3dyYXAscmVsLHJldixyb3dzLHJvd3NwYW4scnVsZXMsJysKICAgICdzY29wZSxzY3JvbGxpbmcsc2hhcGUsc2l6ZSxzcGFuLHN0YXJ0LHN1bW1hcnksdGFyZ2V0LHRpdGxlLHR5cGUsJysKICAgICd2YWxpZ24sdmFsdWUsdnNwYWNlLHdpZHRoJykpOwoKZnVuY3Rpb24gbWFrZU1hcChzdHIpIHsKICB2YXIgb2JqID0ge30sIGl0ZW1zID0gc3RyLnNwbGl0KCcsJyksIGk7CiAgZm9yIChpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSBvYmpbaXRlbXNbaV1dID0gdHJ1ZTsKICByZXR1cm4gb2JqOwp9CgoKLyoqCiAqIEBleGFtcGxlCiAqIGh0bWxQYXJzZXIoaHRtbFN0cmluZywgewogKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICogICAgIGVuZDogZnVuY3Rpb24odGFnKSB7fSwKICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAqIH0pOwogKgogKiBAcGFyYW0ge3N0cmluZ30gaHRtbCBzdHJpbmcKICogQHBhcmFtIHtvYmplY3R9IGhhbmRsZXIKICovCmZ1bmN0aW9uIGh0bWxQYXJzZXIoIGh0bWwsIGhhbmRsZXIgKSB7CiAgdmFyIGluZGV4LCBjaGFycywgbWF0Y2gsIHN0YWNrID0gW10sIGxhc3QgPSBodG1sOwogIHN0YWNrLmxhc3QgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHN0YWNrWyBzdGFjay5sZW5ndGggLSAxIF07IH07CgogIHdoaWxlICggaHRtbCApIHsKICAgIGNoYXJzID0gdHJ1ZTsKCiAgICAvLyBNYWtlIHN1cmUgd2UncmUgbm90IGluIGEgc2NyaXB0IG9yIHN0eWxlIGVsZW1lbnQKICAgIGlmICggIXN0YWNrLmxhc3QoKSB8fCAhc3BlY2lhbEVsZW1lbnRzWyBzdGFjay5sYXN0KCkgXSApIHsKCiAgICAgIC8vIENvbW1lbnQKICAgICAgaWYgKCBodG1sLmluZGV4T2YoIjwhLS0iKSA9PT0gMCApIHsKICAgICAgICAvLyBjb21tZW50cyBjb250YWluaW5nIC0tIGFyZSBub3QgYWxsb3dlZCB1bmxlc3MgdGhleSB0ZXJtaW5hdGUgdGhlIGNvbW1lbnQKICAgICAgICBpbmRleCA9IGh0bWwuaW5kZXhPZigiLS0iLCA0KTsKCiAgICAgICAgaWYgKCBpbmRleCA+PSAwICYmIGh0bWwubGFzdEluZGV4T2YoIi0tPiIsIGluZGV4KSA9PT0gaW5kZXgpIHsKICAgICAgICAgIGlmIChoYW5kbGVyLmNvbW1lbnQpIGhhbmRsZXIuY29tbWVudCggaHRtbC5zdWJzdHJpbmcoIDQsIGluZGV4ICkgKTsKICAgICAgICAgIGh0bWwgPSBodG1sLnN1YnN0cmluZyggaW5kZXggKyAzICk7CiAgICAgICAgICBjaGFycyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgLy8gRE9DVFlQRQogICAgICB9IGVsc2UgaWYgKCBET0NUWVBFX1JFR0VYUC50ZXN0KGh0bWwpICkgewogICAgICAgIG1hdGNoID0gaHRtbC5tYXRjaCggRE9DVFlQRV9SRUdFWFAgKTsKCiAgICAgICAgaWYgKCBtYXRjaCApIHsKICAgICAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UoIG1hdGNoWzBdLCAnJyk7CiAgICAgICAgICBjaGFycyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgLy8gZW5kIHRhZwogICAgICB9IGVsc2UgaWYgKCBCRUdJTkdfRU5EX1RBR0VfUkVHRVhQLnRlc3QoaHRtbCkgKSB7CiAgICAgICAgbWF0Y2ggPSBodG1sLm1hdGNoKCBFTkRfVEFHX1JFR0VYUCApOwoKICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBtYXRjaFswXS5sZW5ndGggKTsKICAgICAgICAgIG1hdGNoWzBdLnJlcGxhY2UoIEVORF9UQUdfUkVHRVhQLCBwYXJzZUVuZFRhZyApOwogICAgICAgICAgY2hhcnMgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAvLyBzdGFydCB0YWcKICAgICAgfSBlbHNlIGlmICggQkVHSU5fVEFHX1JFR0VYUC50ZXN0KGh0bWwpICkgewogICAgICAgIG1hdGNoID0gaHRtbC5tYXRjaCggU1RBUlRfVEFHX1JFR0VYUCApOwoKICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBtYXRjaFswXS5sZW5ndGggKTsKICAgICAgICAgIG1hdGNoWzBdLnJlcGxhY2UoIFNUQVJUX1RBR19SRUdFWFAsIHBhcnNlU3RhcnRUYWcgKTsKICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIGNoYXJzICkgewogICAgICAgIGluZGV4ID0gaHRtbC5pbmRleE9mKCI8Iik7CgogICAgICAgIHZhciB0ZXh0ID0gaW5kZXggPCAwID8gaHRtbCA6IGh0bWwuc3Vic3RyaW5nKCAwLCBpbmRleCApOwogICAgICAgIGh0bWwgPSBpbmRleCA8IDAgPyAiIiA6IGh0bWwuc3Vic3RyaW5nKCBpbmRleCApOwoKICAgICAgICBpZiAoaGFuZGxlci5jaGFycykgaGFuZGxlci5jaGFycyggZGVjb2RlRW50aXRpZXModGV4dCkgKTsKICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UobmV3IFJlZ0V4cCgiKC4qKTxcXHMqXFwvXFxzKiIgKyBzdGFjay5sYXN0KCkgKyAiW14+XSo+IiwgJ2knKSwKICAgICAgICBmdW5jdGlvbihhbGwsIHRleHQpewogICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZShDT01NRU5UX1JFR0VYUCwgIiQxIikucmVwbGFjZShDREFUQV9SRUdFWFAsICIkMSIpOwoKICAgICAgICAgIGlmIChoYW5kbGVyLmNoYXJzKSBoYW5kbGVyLmNoYXJzKCBkZWNvZGVFbnRpdGllcyh0ZXh0KSApOwoKICAgICAgICAgIHJldHVybiAiIjsKICAgICAgfSk7CgogICAgICBwYXJzZUVuZFRhZyggIiIsIHN0YWNrLmxhc3QoKSApOwogICAgfQoKICAgIGlmICggaHRtbCA9PSBsYXN0ICkgewogICAgICB0aHJvdyAkc2FuaXRpemVNaW5FcnIoJ2JhZHBhcnNlJywgIlRoZSBzYW5pdGl6ZXIgd2FzIHVuYWJsZSB0byBwYXJzZSB0aGUgZm9sbG93aW5nIGJsb2NrICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm9mIGh0bWw6IHswfSIsIGh0bWwpOwogICAgfQogICAgbGFzdCA9IGh0bWw7CiAgfQoKICAvLyBDbGVhbiB1cCBhbnkgcmVtYWluaW5nIHRhZ3MKICBwYXJzZUVuZFRhZygpOwoKICBmdW5jdGlvbiBwYXJzZVN0YXJ0VGFnKCB0YWcsIHRhZ05hbWUsIHJlc3QsIHVuYXJ5ICkgewogICAgdGFnTmFtZSA9IGFuZ3VsYXIubG93ZXJjYXNlKHRhZ05hbWUpOwogICAgaWYgKCBibG9ja0VsZW1lbnRzWyB0YWdOYW1lIF0gKSB7CiAgICAgIHdoaWxlICggc3RhY2subGFzdCgpICYmIGlubGluZUVsZW1lbnRzWyBzdGFjay5sYXN0KCkgXSApIHsKICAgICAgICBwYXJzZUVuZFRhZyggIiIsIHN0YWNrLmxhc3QoKSApOwogICAgICB9CiAgICB9CgogICAgaWYgKCBvcHRpb25hbEVuZFRhZ0VsZW1lbnRzWyB0YWdOYW1lIF0gJiYgc3RhY2subGFzdCgpID09IHRhZ05hbWUgKSB7CiAgICAgIHBhcnNlRW5kVGFnKCAiIiwgdGFnTmFtZSApOwogICAgfQoKICAgIHVuYXJ5ID0gdm9pZEVsZW1lbnRzWyB0YWdOYW1lIF0gfHwgISF1bmFyeTsKCiAgICBpZiAoICF1bmFyeSApCiAgICAgIHN0YWNrLnB1c2goIHRhZ05hbWUgKTsKCiAgICB2YXIgYXR0cnMgPSB7fTsKCiAgICByZXN0LnJlcGxhY2UoQVRUUl9SRUdFWFAsCiAgICAgIGZ1bmN0aW9uKG1hdGNoLCBuYW1lLCBkb3VibGVRdW90ZWRWYWx1ZSwgc2luZ2xlUXVvdGVkVmFsdWUsIHVucXVvdGVkVmFsdWUpIHsKICAgICAgICB2YXIgdmFsdWUgPSBkb3VibGVRdW90ZWRWYWx1ZQogICAgICAgICAgfHwgc2luZ2xlUXVvdGVkVmFsdWUKICAgICAgICAgIHx8IHVucXVvdGVkVmFsdWUKICAgICAgICAgIHx8ICcnOwoKICAgICAgICBhdHRyc1tuYW1lXSA9IGRlY29kZUVudGl0aWVzKHZhbHVlKTsKICAgIH0pOwogICAgaWYgKGhhbmRsZXIuc3RhcnQpIGhhbmRsZXIuc3RhcnQoIHRhZ05hbWUsIGF0dHJzLCB1bmFyeSApOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VFbmRUYWcoIHRhZywgdGFnTmFtZSApIHsKICAgIHZhciBwb3MgPSAwLCBpOwogICAgdGFnTmFtZSA9IGFuZ3VsYXIubG93ZXJjYXNlKHRhZ05hbWUpOwogICAgaWYgKCB0YWdOYW1lICkKICAgICAgLy8gRmluZCB0aGUgY2xvc2VzdCBvcGVuZWQgdGFnIG9mIHRoZSBzYW1lIHR5cGUKICAgICAgZm9yICggcG9zID0gc3RhY2subGVuZ3RoIC0gMTsgcG9zID49IDA7IHBvcy0tICkKICAgICAgICBpZiAoIHN0YWNrWyBwb3MgXSA9PSB0YWdOYW1lICkKICAgICAgICAgIGJyZWFrOwoKICAgIGlmICggcG9zID49IDAgKSB7CiAgICAgIC8vIENsb3NlIGFsbCB0aGUgb3BlbiBlbGVtZW50cywgdXAgdGhlIHN0YWNrCiAgICAgIGZvciAoIGkgPSBzdGFjay5sZW5ndGggLSAxOyBpID49IHBvczsgaS0tICkKICAgICAgICBpZiAoaGFuZGxlci5lbmQpIGhhbmRsZXIuZW5kKCBzdGFja1sgaSBdICk7CgogICAgICAvLyBSZW1vdmUgdGhlIG9wZW4gZWxlbWVudHMgZnJvbSB0aGUgc3RhY2sKICAgICAgc3RhY2subGVuZ3RoID0gcG9zOwogICAgfQogIH0KfQoKdmFyIGhpZGRlblByZT1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwcmUiKTsKdmFyIHNwYWNlUmUgPSAvXihccyopKFtcc1xTXSo/KShccyopJC87Ci8qKgogKiBkZWNvZGVzIGFsbCBlbnRpdGllcyBpbnRvIHJlZ3VsYXIgc3RyaW5nCiAqIEBwYXJhbSB2YWx1ZQogKiBAcmV0dXJucyB7c3RyaW5nfSBBIHN0cmluZyB3aXRoIGRlY29kZWQgZW50aXRpZXMuCiAqLwpmdW5jdGlvbiBkZWNvZGVFbnRpdGllcyh2YWx1ZSkgewogIGlmICghdmFsdWUpIHsgcmV0dXJuICcnOyB9CgogIC8vIE5vdGU6IElFOCBkb2VzIG5vdCBwcmVzZXJ2ZSBzcGFjZXMgYXQgdGhlIHN0YXJ0L2VuZCBvZiBpbm5lckhUTUwKICAvLyBzbyB3ZSBtdXN0IGNhcHR1cmUgdGhlbSBhbmQgcmVhdHRhY2ggdGhlbSBhZnRlcndhcmQKICB2YXIgcGFydHMgPSBzcGFjZVJlLmV4ZWModmFsdWUpOwogIHZhciBzcGFjZUJlZm9yZSA9IHBhcnRzWzFdOwogIHZhciBzcGFjZUFmdGVyID0gcGFydHNbM107CiAgdmFyIGNvbnRlbnQgPSBwYXJ0c1syXTsKICBpZiAoY29udGVudCkgewogICAgaGlkZGVuUHJlLmlubmVySFRNTD1jb250ZW50LnJlcGxhY2UoLzwvZywiJmx0OyIpOwogICAgLy8gaW5uZXJUZXh0IGRlcGVuZHMgb24gc3R5bGluZyBhcyBpdCBkb2Vzbid0IGRpc3BsYXkgaGlkZGVuIGVsZW1lbnRzLgogICAgLy8gVGhlcmVmb3JlLCBpdCdzIGJldHRlciB0byB1c2UgdGV4dENvbnRlbnQgbm90IHRvIGNhdXNlIHVubmVjZXNzYXJ5CiAgICAvLyByZWZsb3dzLiBIb3dldmVyLCBJRTw5IGRvbid0IHN1cHBvcnQgdGV4dENvbnRlbnQgc28gdGhlIGlubmVyVGV4dAogICAgLy8gZmFsbGJhY2sgaXMgbmVjZXNzYXJ5LgogICAgY29udGVudCA9ICd0ZXh0Q29udGVudCcgaW4gaGlkZGVuUHJlID8KICAgICAgaGlkZGVuUHJlLnRleHRDb250ZW50IDogaGlkZGVuUHJlLmlubmVyVGV4dDsKICB9CiAgcmV0dXJuIHNwYWNlQmVmb3JlICsgY29udGVudCArIHNwYWNlQWZ0ZXI7Cn0KCi8qKgogKiBFc2NhcGVzIGFsbCBwb3RlbnRpYWxseSBkYW5nZXJvdXMgY2hhcmFjdGVycywgc28gdGhhdCB0aGUKICogcmVzdWx0aW5nIHN0cmluZyBjYW4gYmUgc2FmZWx5IGluc2VydGVkIGludG8gYXR0cmlidXRlIG9yCiAqIGVsZW1lbnQgdGV4dC4KICogQHBhcmFtIHZhbHVlCiAqIEByZXR1cm5zIHtzdHJpbmd9IGVzY2FwZWQgdGV4dAogKi8KZnVuY3Rpb24gZW5jb2RlRW50aXRpZXModmFsdWUpIHsKICByZXR1cm4gdmFsdWUuCiAgICByZXBsYWNlKC8mL2csICcmYW1wOycpLgogICAgcmVwbGFjZShTVVJST0dBVEVfUEFJUl9SRUdFWFAsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgaGkgPSB2YWx1ZS5jaGFyQ29kZUF0KDApOwogICAgICB2YXIgbG93ID0gdmFsdWUuY2hhckNvZGVBdCgxKTsKICAgICAgcmV0dXJuICcmIycgKyAoKChoaSAtIDB4RDgwMCkgKiAweDQwMCkgKyAobG93IC0gMHhEQzAwKSArIDB4MTAwMDApICsgJzsnOwogICAgfSkuCiAgICByZXBsYWNlKE5PTl9BTFBIQU5VTUVSSUNfUkVHRVhQLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiAnJiMnICsgdmFsdWUuY2hhckNvZGVBdCgwKSArICc7JzsKICAgIH0pLgogICAgcmVwbGFjZSgvPC9nLCAnJmx0OycpLgogICAgcmVwbGFjZSgvPi9nLCAnJmd0OycpOwp9CgovKioKICogY3JlYXRlIGFuIEhUTUwvWE1MIHdyaXRlciB3aGljaCB3cml0ZXMgdG8gYnVmZmVyCiAqIEBwYXJhbSB7QXJyYXl9IGJ1ZiB1c2UgYnVmLmphaW4oJycpIHRvIGdldCBvdXQgc2FuaXRpemVkIGh0bWwgc3RyaW5nCiAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHsKICogICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSkge30sCiAqICAgICBlbmQ6IGZ1bmN0aW9uKHRhZykge30sCiAqICAgICBjaGFyczogZnVuY3Rpb24odGV4dCkge30sCiAqICAgICBjb21tZW50OiBmdW5jdGlvbih0ZXh0KSB7fQogKiB9CiAqLwpmdW5jdGlvbiBodG1sU2FuaXRpemVXcml0ZXIoYnVmLCB1cmlWYWxpZGF0b3IpewogIHZhciBpZ25vcmUgPSBmYWxzZTsKICB2YXIgb3V0ID0gYW5ndWxhci5iaW5kKGJ1ZiwgYnVmLnB1c2gpOwogIHJldHVybiB7CiAgICBzdGFydDogZnVuY3Rpb24odGFnLCBhdHRycywgdW5hcnkpewogICAgICB0YWcgPSBhbmd1bGFyLmxvd2VyY2FzZSh0YWcpOwogICAgICBpZiAoIWlnbm9yZSAmJiBzcGVjaWFsRWxlbWVudHNbdGFnXSkgewogICAgICAgIGlnbm9yZSA9IHRhZzsKICAgICAgfQogICAgICBpZiAoIWlnbm9yZSAmJiB2YWxpZEVsZW1lbnRzW3RhZ10gPT09IHRydWUpIHsKICAgICAgICBvdXQoJzwnKTsKICAgICAgICBvdXQodGFnKTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goYXR0cnMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgICAgdmFyIGxrZXk9YW5ndWxhci5sb3dlcmNhc2Uoa2V5KTsKICAgICAgICAgIHZhciBpc0ltYWdlID0gKHRhZyA9PT0gJ2ltZycgJiYgbGtleSA9PT0gJ3NyYycpIHx8IChsa2V5ID09PSAnYmFja2dyb3VuZCcpOwogICAgICAgICAgaWYgKHZhbGlkQXR0cnNbbGtleV0gPT09IHRydWUgJiYKICAgICAgICAgICAgKHVyaUF0dHJzW2xrZXldICE9PSB0cnVlIHx8IHVyaVZhbGlkYXRvcih2YWx1ZSwgaXNJbWFnZSkpKSB7CiAgICAgICAgICAgIG91dCgnICcpOwogICAgICAgICAgICBvdXQoa2V5KTsKICAgICAgICAgICAgb3V0KCc9IicpOwogICAgICAgICAgICBvdXQoZW5jb2RlRW50aXRpZXModmFsdWUpKTsKICAgICAgICAgICAgb3V0KCciJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgb3V0KHVuYXJ5ID8gJy8+JyA6ICc+Jyk7CiAgICAgIH0KICAgIH0sCiAgICBlbmQ6IGZ1bmN0aW9uKHRhZyl7CiAgICAgICAgdGFnID0gYW5ndWxhci5sb3dlcmNhc2UodGFnKTsKICAgICAgICBpZiAoIWlnbm9yZSAmJiB2YWxpZEVsZW1lbnRzW3RhZ10gPT09IHRydWUpIHsKICAgICAgICAgIG91dCgnPC8nKTsKICAgICAgICAgIG91dCh0YWcpOwogICAgICAgICAgb3V0KCc+Jyk7CiAgICAgICAgfQogICAgICAgIGlmICh0YWcgPT0gaWdub3JlKSB7CiAgICAgICAgICBpZ25vcmUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0sCiAgICBjaGFyczogZnVuY3Rpb24oY2hhcnMpewogICAgICAgIGlmICghaWdub3JlKSB7CiAgICAgICAgICBvdXQoZW5jb2RlRW50aXRpZXMoY2hhcnMpKTsKICAgICAgICB9CiAgICAgIH0KICB9Owp9CgoKLy8gZGVmaW5lIG5nU2FuaXRpemUgbW9kdWxlIGFuZCByZWdpc3RlciAkc2FuaXRpemUgc2VydmljZQphbmd1bGFyLm1vZHVsZSgnbmdTYW5pdGl6ZScsIFtdKS5wcm92aWRlcignJHNhbml0aXplJywgJFNhbml0aXplUHJvdmlkZXIpOwoKLyogZ2xvYmFsIHNhbml0aXplVGV4dDogZmFsc2UgKi8KCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGxpbmt5CiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGaW5kcyBsaW5rcyBpbiB0ZXh0IGlucHV0IGFuZCB0dXJucyB0aGVtIGludG8gaHRtbCBsaW5rcy4gU3VwcG9ydHMgaHR0cC9odHRwcy9mdHAvbWFpbHRvIGFuZAogKiBwbGFpbiBlbWFpbCBhZGRyZXNzIGxpbmtzLgogKgogKiBSZXF1aXJlcyB0aGUge0BsaW5rIG5nU2FuaXRpemUgYG5nU2FuaXRpemVgfSBtb2R1bGUgdG8gYmUgaW5zdGFsbGVkLgogKgogKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBJbnB1dCB0ZXh0LgogKiBAcGFyYW0ge3N0cmluZ30gdGFyZ2V0IFdpbmRvdyAoX2JsYW5rfF9zZWxmfF9wYXJlbnR8X3RvcCkgb3IgbmFtZWQgZnJhbWUgdG8gb3BlbiBsaW5rcyBpbi4KICogQHJldHVybnMge3N0cmluZ30gSHRtbC1saW5raWZpZWQgdGV4dC4KICoKICogQHVzYWdlCiAgIDxzcGFuIG5nLWJpbmQtaHRtbD0ibGlua3lfZXhwcmVzc2lvbiB8IGxpbmt5Ij48L3NwYW4+CiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdTYW5pdGl6ZSIgZGVwcz0iYW5ndWxhci1zYW5pdGl6ZS5qcyI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5zbmlwcGV0ID0KICAgICAgICAgICAgICdQcmV0dHkgdGV4dCB3aXRoIHNvbWUgbGlua3M6XG4nKwogICAgICAgICAgICAgJ2h0dHA6Ly9hbmd1bGFyanMub3JnLyxcbicrCiAgICAgICAgICAgICAnbWFpbHRvOnVzQHNvbWV3aGVyZS5vcmcsXG4nKwogICAgICAgICAgICAgJ2Fub3RoZXJAc29tZXdoZXJlLm9yZyxcbicrCiAgICAgICAgICAgICAnYW5kIG9uZSBtb3JlOiBmdHA6Ly8xMjcuMC4wLjEvLic7CiAgICAgICAgICAgJHNjb3BlLnNuaXBwZXRXaXRoVGFyZ2V0ID0gJ2h0dHA6Ly9hbmd1bGFyanMub3JnLyc7CiAgICAgICAgIH0KICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgIFNuaXBwZXQ6IDx0ZXh0YXJlYSBuZy1tb2RlbD0ic25pcHBldCIgY29scz0iNjAiIHJvd3M9IjMiPjwvdGV4dGFyZWE+CiAgICAgICA8dGFibGU+CiAgICAgICAgIDx0cj4KICAgICAgICAgICA8dGQ+RmlsdGVyPC90ZD4KICAgICAgICAgICA8dGQ+U291cmNlPC90ZD4KICAgICAgICAgICA8dGQ+UmVuZGVyZWQ8L3RkPgogICAgICAgICA8L3RyPgogICAgICAgICA8dHIgaWQ9Imxpbmt5LWZpbHRlciI+CiAgICAgICAgICAgPHRkPmxpbmt5IGZpbHRlcjwvdGQ+CiAgICAgICAgICAgPHRkPgogICAgICAgICAgICAgPHByZT4mbHQ7ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldCB8IGxpbmt5IiZndDs8YnI+Jmx0Oy9kaXYmZ3Q7PC9wcmU+CiAgICAgICAgICAgPC90ZD4KICAgICAgICAgICA8dGQ+CiAgICAgICAgICAgICA8ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldCB8IGxpbmt5Ij48L2Rpdj4KICAgICAgICAgICA8L3RkPgogICAgICAgICA8L3RyPgogICAgICAgICA8dHIgaWQ9Imxpbmt5LXRhcmdldCI+CiAgICAgICAgICA8dGQ+bGlua3kgdGFyZ2V0PC90ZD4KICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgPHByZT4mbHQ7ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldFdpdGhUYXJnZXQgfCBsaW5reTonX2JsYW5rJyImZ3Q7PGJyPiZsdDsvZGl2Jmd0OzwvcHJlPgogICAgICAgICAgPC90ZD4KICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgPGRpdiBuZy1iaW5kLWh0bWw9InNuaXBwZXRXaXRoVGFyZ2V0IHwgbGlua3k6J19ibGFuayciPjwvZGl2PgogICAgICAgICAgPC90ZD4KICAgICAgICAgPC90cj4KICAgICAgICAgPHRyIGlkPSJlc2NhcGVkLWh0bWwiPgogICAgICAgICAgIDx0ZD5ubyBmaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD48cHJlPiZsdDtkaXYgbmctYmluZD0ic25pcHBldCImZ3Q7PGJyPiZsdDsvZGl2Jmd0OzwvcHJlPjwvdGQ+CiAgICAgICAgICAgPHRkPjxkaXYgbmctYmluZD0ic25pcHBldCI+PC9kaXY+PC90ZD4KICAgICAgICAgPC90cj4KICAgICAgIDwvdGFibGU+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBsaW5raWZ5IHRoZSBzbmlwcGV0IHdpdGggdXJscycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGlua3ktZmlsdGVyJykpLmVsZW1lbnQoYnkuYmluZGluZygnc25pcHBldCB8IGxpbmt5JykpLmdldFRleHQoKSkuCiAgICAgICAgICAgICB0b0JlKCdQcmV0dHkgdGV4dCB3aXRoIHNvbWUgbGlua3M6IGh0dHA6Ly9hbmd1bGFyanMub3JnLywgdXNAc29tZXdoZXJlLm9yZywgJyArCiAgICAgICAgICAgICAgICAgICdhbm90aGVyQHNvbWV3aGVyZS5vcmcsIGFuZCBvbmUgbW9yZTogZnRwOi8vMTI3LjAuMC4xLy4nKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQuYWxsKGJ5LmNzcygnI2xpbmt5LWZpbHRlciBhJykpLmNvdW50KCkpLnRvRXF1YWwoNCk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIG5vdCBsaW5raWZ5IHNuaXBwZXQgd2l0aG91dCB0aGUgbGlua3kgZmlsdGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdlc2NhcGVkLWh0bWwnKSkuZWxlbWVudChieS5iaW5kaW5nKCdzbmlwcGV0JykpLmdldFRleHQoKSkuCiAgICAgICAgICAgICB0b0JlKCdQcmV0dHkgdGV4dCB3aXRoIHNvbWUgbGlua3M6IGh0dHA6Ly9hbmd1bGFyanMub3JnLywgbWFpbHRvOnVzQHNvbWV3aGVyZS5vcmcsICcgKwogICAgICAgICAgICAgICAgICAnYW5vdGhlckBzb21ld2hlcmUub3JnLCBhbmQgb25lIG1vcmU6IGZ0cDovLzEyNy4wLjAuMS8uJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50LmFsbChieS5jc3MoJyNlc2NhcGVkLWh0bWwgYScpKS5jb3VudCgpKS50b0VxdWFsKDApOwogICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc25pcHBldCcpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzbmlwcGV0JykpLnNlbmRLZXlzKCduZXcgaHR0cDovL2xpbmsuJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5reS1maWx0ZXInKSkuZWxlbWVudChieS5iaW5kaW5nKCdzbmlwcGV0IHwgbGlua3knKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgIHRvQmUoJ25ldyBodHRwOi8vbGluay4nKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQuYWxsKGJ5LmNzcygnI2xpbmt5LWZpbHRlciBhJykpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdlc2NhcGVkLWh0bWwnKSkuZWxlbWVudChieS5iaW5kaW5nKCdzbmlwcGV0JykpLmdldFRleHQoKSkKICAgICAgICAgICAgIC50b0JlKCduZXcgaHR0cDovL2xpbmsuJyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHdvcmsgd2l0aCB0aGUgdGFyZ2V0IHByb3BlcnR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmt5LXRhcmdldCcpKS4KICAgICAgICAgICAgZWxlbWVudChieS5iaW5kaW5nKCJzbmlwcGV0V2l0aFRhcmdldCB8IGxpbmt5OidfYmxhbmsnIikpLmdldFRleHQoKSkuCiAgICAgICAgICAgIHRvQmUoJ2h0dHA6Ly9hbmd1bGFyanMub3JnLycpOwogICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI2xpbmt5LXRhcmdldCBhJykpLmdldEF0dHJpYnV0ZSgndGFyZ2V0JykpLnRvRXF1YWwoJ19ibGFuaycpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwphbmd1bGFyLm1vZHVsZSgnbmdTYW5pdGl6ZScpLmZpbHRlcignbGlua3knLCBbJyRzYW5pdGl6ZScsIGZ1bmN0aW9uKCRzYW5pdGl6ZSkgewogIHZhciBMSU5LWV9VUkxfUkVHRVhQID0KICAgICAgICAvKChmdHB8aHR0cHM/KTpcL1wvfChtYWlsdG86KT9bQS1aYS16MC05Ll8lKy1dK0ApXFMqW15ccy47LCgpe308Pl0vLAogICAgICBNQUlMVE9fUkVHRVhQID0gL15tYWlsdG86LzsKCiAgcmV0dXJuIGZ1bmN0aW9uKHRleHQsIHRhcmdldCkgewogICAgaWYgKCF0ZXh0KSByZXR1cm4gdGV4dDsKICAgIHZhciBtYXRjaDsKICAgIHZhciByYXcgPSB0ZXh0OwogICAgdmFyIGh0bWwgPSBbXTsKICAgIHZhciB1cmw7CiAgICB2YXIgaTsKICAgIHdoaWxlICgobWF0Y2ggPSByYXcubWF0Y2goTElOS1lfVVJMX1JFR0VYUCkpKSB7CiAgICAgIC8vIFdlIGNhbiBub3QgZW5kIGluIHRoZXNlIGFzIHRoZXkgYXJlIHNvbWV0aW1lcyBmb3VuZCBhdCB0aGUgZW5kIG9mIHRoZSBzZW50ZW5jZQogICAgICB1cmwgPSBtYXRjaFswXTsKICAgICAgLy8gaWYgd2UgZGlkIG5vdCBtYXRjaCBmdHAvaHR0cC9tYWlsdG8gdGhlbiBhc3N1bWUgbWFpbHRvCiAgICAgIGlmIChtYXRjaFsyXSA9PSBtYXRjaFszXSkgdXJsID0gJ21haWx0bzonICsgdXJsOwogICAgICBpID0gbWF0Y2guaW5kZXg7CiAgICAgIGFkZFRleHQocmF3LnN1YnN0cigwLCBpKSk7CiAgICAgIGFkZExpbmsodXJsLCBtYXRjaFswXS5yZXBsYWNlKE1BSUxUT19SRUdFWFAsICcnKSk7CiAgICAgIHJhdyA9IHJhdy5zdWJzdHJpbmcoaSArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICB9CiAgICBhZGRUZXh0KHJhdyk7CiAgICByZXR1cm4gJHNhbml0aXplKGh0bWwuam9pbignJykpOwoKICAgIGZ1bmN0aW9uIGFkZFRleHQodGV4dCkgewogICAgICBpZiAoIXRleHQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaHRtbC5wdXNoKHNhbml0aXplVGV4dCh0ZXh0KSk7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkTGluayh1cmwsIHRleHQpIHsKICAgICAgaHRtbC5wdXNoKCc8YSAnKTsKICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKHRhcmdldCkpIHsKICAgICAgICBodG1sLnB1c2goJ3RhcmdldD0iJyk7CiAgICAgICAgaHRtbC5wdXNoKHRhcmdldCk7CiAgICAgICAgaHRtbC5wdXNoKCciICcpOwogICAgICB9CiAgICAgIGh0bWwucHVzaCgnaHJlZj0iJyk7CiAgICAgIGh0bWwucHVzaCh1cmwpOwogICAgICBodG1sLnB1c2goJyI+Jyk7CiAgICAgIGFkZFRleHQodGV4dCk7CiAgICAgIGh0bWwucHVzaCgnPC9hPicpOwogICAgfQogIH07Cn1dKTsKCgp9KSh3aW5kb3csIHdpbmRvdy5hbmd1bGFyKTsKCi8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKioKICogU3RhdGUtYmFzZWQgcm91dGluZyBmb3IgQW5ndWxhckpTCiAqIEB2ZXJzaW9uIHYwLjIuMTAKICogQGxpbmsgaHR0cDovL2FuZ3VsYXItdWkuZ2l0aHViLmNvbS8KICogQGxpY2Vuc2UgTUlUIExpY2Vuc2UsIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUCiAqLwoKLyogY29tbW9uanMgcGFja2FnZSBtYW5hZ2VyIHN1cHBvcnQgKGVnIGNvbXBvbmVudGpzKSAqLwppZiAodHlwZW9mIG1vZHVsZSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGV4cG9ydHMgIT09ICJ1bmRlZmluZWQiICYmIG1vZHVsZS5leHBvcnRzID09PSBleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cyA9ICd1aS5yb3V0ZXInOwp9CgooZnVuY3Rpb24gKHdpbmRvdywgYW5ndWxhciwgdW5kZWZpbmVkKSB7Ci8qanNoaW50IGdsb2JhbHN0cmljdDp0cnVlKi8KLypnbG9iYWwgYW5ndWxhcjpmYWxzZSovCid1c2Ugc3RyaWN0JzsKCnZhciBpc0RlZmluZWQgPSBhbmd1bGFyLmlzRGVmaW5lZCwKICAgIGlzRnVuY3Rpb24gPSBhbmd1bGFyLmlzRnVuY3Rpb24sCiAgICBpc1N0cmluZyA9IGFuZ3VsYXIuaXNTdHJpbmcsCiAgICBpc09iamVjdCA9IGFuZ3VsYXIuaXNPYmplY3QsCiAgICBpc0FycmF5ID0gYW5ndWxhci5pc0FycmF5LAogICAgZm9yRWFjaCA9IGFuZ3VsYXIuZm9yRWFjaCwKICAgIGV4dGVuZCA9IGFuZ3VsYXIuZXh0ZW5kLAogICAgY29weSA9IGFuZ3VsYXIuY29weTsKCmZ1bmN0aW9uIGluaGVyaXQocGFyZW50LCBleHRyYSkgewogIHJldHVybiBleHRlbmQobmV3IChleHRlbmQoZnVuY3Rpb24oKSB7fSwgeyBwcm90b3R5cGU6IHBhcmVudCB9KSkoKSwgZXh0cmEpOwp9CgpmdW5jdGlvbiBtZXJnZShkc3QpIHsKICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqICE9PSBkc3QpIHsKICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBpZiAoIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSBkc3Rba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0KICB9KTsKICByZXR1cm4gZHN0Owp9CgovKioKICogRmluZHMgdGhlIGNvbW1vbiBhbmNlc3RvciBwYXRoIGJldHdlZW4gdHdvIHN0YXRlcy4KICoKICogQHBhcmFtIHtPYmplY3R9IGZpcnN0IFRoZSBmaXJzdCBzdGF0ZS4KICogQHBhcmFtIHtPYmplY3R9IHNlY29uZCBUaGUgc2Vjb25kIHN0YXRlLgogKiBAcmV0dXJuIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBzdGF0ZSBuYW1lcyBpbiBkZXNjZW5kaW5nIG9yZGVyLCBub3QgaW5jbHVkaW5nIHRoZSByb290LgogKi8KZnVuY3Rpb24gYW5jZXN0b3JzKGZpcnN0LCBzZWNvbmQpIHsKICB2YXIgcGF0aCA9IFtdOwoKICBmb3IgKHZhciBuIGluIGZpcnN0LnBhdGgpIHsKICAgIGlmIChmaXJzdC5wYXRoW25dICE9PSBzZWNvbmQucGF0aFtuXSkgYnJlYWs7CiAgICBwYXRoLnB1c2goZmlyc3QucGF0aFtuXSk7CiAgfQogIHJldHVybiBwYXRoOwp9CgovKioKICogSUU4LXNhZmUgd3JhcHBlciBmb3IgYE9iamVjdC5rZXlzKClgLgogKgogKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IEEgSmF2YVNjcmlwdCBvYmplY3QuCiAqIEByZXR1cm4ge0FycmF5fSBSZXR1cm5zIHRoZSBrZXlzIG9mIHRoZSBvYmplY3QgYXMgYW4gYXJyYXkuCiAqLwpmdW5jdGlvbiBrZXlzKG9iamVjdCkgewogIGlmIChPYmplY3Qua2V5cykgewogICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iamVjdCk7CiAgfQogIHZhciByZXN1bHQgPSBbXTsKCiAgYW5ndWxhci5mb3JFYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfQoKLyoqCiAqIElFOC1zYWZlIHdyYXBwZXIgZm9yIGBBcnJheS5wcm90b3R5cGUuaW5kZXhPZigpYC4KICoKICogQHBhcmFtIHtBcnJheX0gYXJyYXkgQSBKYXZhU2NyaXB0IGFycmF5LgogKiBAcGFyYW0geyp9IHZhbHVlIEEgdmFsdWUgdG8gc2VhcmNoIHRoZSBhcnJheSBmb3IuCiAqIEByZXR1cm4ge051bWJlcn0gUmV0dXJucyB0aGUgYXJyYXkgaW5kZXggdmFsdWUgb2YgYHZhbHVlYCwgb3IgYC0xYCBpZiBub3QgcHJlc2VudC4KICovCmZ1bmN0aW9uIGFycmF5U2VhcmNoKGFycmF5LCB2YWx1ZSkgewogIGlmIChBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewogICAgcmV0dXJuIGFycmF5LmluZGV4T2YodmFsdWUsIE51bWJlcihhcmd1bWVudHNbMl0pIHx8IDApOwogIH0KICB2YXIgbGVuID0gYXJyYXkubGVuZ3RoID4+PiAwLCBmcm9tID0gTnVtYmVyKGFyZ3VtZW50c1syXSkgfHwgMDsKICBmcm9tID0gKGZyb20gPCAwKSA/IE1hdGguY2VpbChmcm9tKSA6IE1hdGguZmxvb3IoZnJvbSk7CgogIGlmIChmcm9tIDwgMCkgZnJvbSArPSBsZW47CgogIGZvciAoOyBmcm9tIDwgbGVuOyBmcm9tKyspIHsKICAgIGlmIChmcm9tIGluIGFycmF5ICYmIGFycmF5W2Zyb21dID09PSB2YWx1ZSkgcmV0dXJuIGZyb207CiAgfQogIHJldHVybiAtMTsKfQoKLyoqCiAqIE1lcmdlcyBhIHNldCBvZiBwYXJhbWV0ZXJzIHdpdGggYWxsIHBhcmFtZXRlcnMgaW5oZXJpdGVkIGJldHdlZW4gdGhlIGNvbW1vbiBwYXJlbnRzIG9mIHRoZQogKiBjdXJyZW50IHN0YXRlIGFuZCBhIGdpdmVuIGRlc3RpbmF0aW9uIHN0YXRlLgogKgogKiBAcGFyYW0ge09iamVjdH0gY3VycmVudFBhcmFtcyBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgc3RhdGUgcGFyYW1ldGVycyAoJHN0YXRlUGFyYW1zKS4KICogQHBhcmFtIHtPYmplY3R9IG5ld1BhcmFtcyBUaGUgc2V0IG9mIHBhcmFtZXRlcnMgd2hpY2ggd2lsbCBiZSBjb21wb3NpdGVkIHdpdGggaW5oZXJpdGVkIHBhcmFtcy4KICogQHBhcmFtIHtPYmplY3R9ICRjdXJyZW50IEludGVybmFsIGRlZmluaXRpb24gb2Ygb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgY3VycmVudCBzdGF0ZS4KICogQHBhcmFtIHtPYmplY3R9ICR0byBJbnRlcm5hbCBkZWZpbml0aW9uIG9mIG9iamVjdCByZXByZXNlbnRpbmcgc3RhdGUgdG8gdHJhbnNpdGlvbiB0by4KICovCmZ1bmN0aW9uIGluaGVyaXRQYXJhbXMoY3VycmVudFBhcmFtcywgbmV3UGFyYW1zLCAkY3VycmVudCwgJHRvKSB7CiAgdmFyIHBhcmVudHMgPSBhbmNlc3RvcnMoJGN1cnJlbnQsICR0byksIHBhcmVudFBhcmFtcywgaW5oZXJpdGVkID0ge30sIGluaGVyaXRMaXN0ID0gW107CgogIGZvciAodmFyIGkgaW4gcGFyZW50cykgewogICAgaWYgKCFwYXJlbnRzW2ldLnBhcmFtcyB8fCAhcGFyZW50c1tpXS5wYXJhbXMubGVuZ3RoKSBjb250aW51ZTsKICAgIHBhcmVudFBhcmFtcyA9IHBhcmVudHNbaV0ucGFyYW1zOwoKICAgIGZvciAodmFyIGogaW4gcGFyZW50UGFyYW1zKSB7CiAgICAgIGlmIChhcnJheVNlYXJjaChpbmhlcml0TGlzdCwgcGFyZW50UGFyYW1zW2pdKSA+PSAwKSBjb250aW51ZTsKICAgICAgaW5oZXJpdExpc3QucHVzaChwYXJlbnRQYXJhbXNbal0pOwogICAgICBpbmhlcml0ZWRbcGFyZW50UGFyYW1zW2pdXSA9IGN1cnJlbnRQYXJhbXNbcGFyZW50UGFyYW1zW2pdXTsKICAgIH0KICB9CiAgcmV0dXJuIGV4dGVuZCh7fSwgaW5oZXJpdGVkLCBuZXdQYXJhbXMpOwp9CgovKioKICogTm9ybWFsaXplcyBhIHNldCBvZiB2YWx1ZXMgdG8gc3RyaW5nIG9yIGBudWxsYCwgZmlsdGVyaW5nIHRoZW0gYnkgYSBsaXN0IG9mIGtleXMuCiAqCiAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGxpc3Qgb2Yga2V5cyB0byBub3JtYWxpemUvcmV0dXJuLgogKiBAcGFyYW0ge09iamVjdH0gdmFsdWVzIEFuIG9iamVjdCBoYXNoIG9mIHZhbHVlcyB0byBub3JtYWxpemUuCiAqIEByZXR1cm4ge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgaGFzaCBvZiBub3JtYWxpemVkIHN0cmluZyB2YWx1ZXMuCiAqLwpmdW5jdGlvbiBub3JtYWxpemUoa2V5cywgdmFsdWVzKSB7CiAgdmFyIG5vcm1hbGl6ZWQgPSB7fTsKCiAgZm9yRWFjaChrZXlzLCBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIHZhbHVlID0gdmFsdWVzW25hbWVdOwogICAgbm9ybWFsaXplZFtuYW1lXSA9ICh2YWx1ZSAhPSBudWxsKSA/IFN0cmluZyh2YWx1ZSkgOiBudWxsOwogIH0pOwogIHJldHVybiBub3JtYWxpemVkOwp9CgovKioKICogUGVyZm9ybXMgYSBub24tc3RyaWN0IGNvbXBhcmlzb24gb2YgdGhlIHN1YnNldCBvZiB0d28gb2JqZWN0cywgZGVmaW5lZCBieSBhIGxpc3Qgb2Yga2V5cy4KICoKICogQHBhcmFtIHtPYmplY3R9IGEgVGhlIGZpcnN0IG9iamVjdC4KICogQHBhcmFtIHtPYmplY3R9IGIgVGhlIHNlY29uZCBvYmplY3QuCiAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGxpc3Qgb2Yga2V5cyB3aXRoaW4gZWFjaCBvYmplY3QgdG8gY29tcGFyZS4gSWYgdGhlIGxpc3QgaXMgZW1wdHkgb3Igbm90IHNwZWNpZmllZCwKICogICAgICAgICAgICAgICAgICAgICBpdCBkZWZhdWx0cyB0byB0aGUgbGlzdCBvZiBrZXlzIGluIGBhYC4KICogQHJldHVybiB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGtleXMgbWF0Y2gsIG90aGVyd2lzZSBgZmFsc2VgLgogKi8KZnVuY3Rpb24gZXF1YWxGb3JLZXlzKGEsIGIsIGtleXMpIHsKICBpZiAoIWtleXMpIHsKICAgIGtleXMgPSBbXTsKICAgIGZvciAodmFyIG4gaW4gYSkga2V5cy5wdXNoKG4pOyAvLyBVc2VkIGluc3RlYWQgb2YgT2JqZWN0LmtleXMoKSBmb3IgSUU4IGNvbXBhdGliaWxpdHkKICB9CgogIGZvciAodmFyIGk9MDsgaTxrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgayA9IGtleXNbaV07CiAgICBpZiAoYVtrXSAhPSBiW2tdKSByZXR1cm4gZmFsc2U7IC8vIE5vdCAnPT09JywgdmFsdWVzIGFyZW4ndCBuZWNlc3NhcmlseSBub3JtYWxpemVkCiAgfQogIHJldHVybiB0cnVlOwp9CgovKioKICogUmV0dXJucyB0aGUgc3Vic2V0IG9mIGFuIG9iamVjdCwgYmFzZWQgb24gYSBsaXN0IG9mIGtleXMuCiAqCiAqIEBwYXJhbSB7QXJyYXl9IGtleXMKICogQHBhcmFtIHtPYmplY3R9IHZhbHVlcwogKiBAcmV0dXJuIHtCb29sZWFufSBSZXR1cm5zIGEgc3Vic2V0IG9mIGB2YWx1ZXNgLgogKi8KZnVuY3Rpb24gZmlsdGVyQnlLZXlzKGtleXMsIHZhbHVlcykgewogIHZhciBmaWx0ZXJlZCA9IHt9OwoKICBmb3JFYWNoKGtleXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICBmaWx0ZXJlZFtuYW1lXSA9IHZhbHVlc1tuYW1lXTsKICB9KTsKICByZXR1cm4gZmlsdGVyZWQ7Cn0KLyoqCiAqIEBuZ2RvYyBvdmVydmlldwogKiBAbmFtZSB1aS5yb3V0ZXIudXRpbAogKgogKiBAZGVzY3JpcHRpb24KICogIyB1aS5yb3V0ZXIudXRpbCBzdWItbW9kdWxlCiAqCiAqIFRoaXMgbW9kdWxlIGlzIGEgZGVwZW5kZW5jeSBvZiBvdGhlciBzdWItbW9kdWxlcy4gRG8gbm90IGluY2x1ZGUgdGhpcyBtb2R1bGUgYXMgYSBkZXBlbmRlbmN5CiAqIGluIHlvdXIgYW5ndWxhciBhcHAgKHVzZSB7QGxpbmsgdWkucm91dGVyfSBtb2R1bGUgaW5zdGVhZCkuCiAqCiAqLwphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnV0aWwnLCBbJ25nJ10pOwoKLyoqCiAqIEBuZ2RvYyBvdmVydmlldwogKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyCiAqIAogKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwKICoKICogQGRlc2NyaXB0aW9uCiAqICMgdWkucm91dGVyLnJvdXRlciBzdWItbW9kdWxlCiAqCiAqIFRoaXMgbW9kdWxlIGlzIGEgZGVwZW5kZW5jeSBvZiBvdGhlciBzdWItbW9kdWxlcy4gRG8gbm90IGluY2x1ZGUgdGhpcyBtb2R1bGUgYXMgYSBkZXBlbmRlbmN5CiAqIGluIHlvdXIgYW5ndWxhciBhcHAgKHVzZSB7QGxpbmsgdWkucm91dGVyfSBtb2R1bGUgaW5zdGVhZCkuCiAqLwphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnJvdXRlcicsIFsndWkucm91dGVyLnV0aWwnXSk7CgovKioKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZQogKiAKICogQHJlcXVpcmVzIHVpLnJvdXRlci5yb3V0ZXIKICogQHJlcXVpcmVzIHVpLnJvdXRlci51dGlsCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAjIHVpLnJvdXRlci5zdGF0ZSBzdWItbW9kdWxlCiAqCiAqIFRoaXMgbW9kdWxlIGlzIGEgZGVwZW5kZW5jeSBvZiB0aGUgbWFpbiB1aS5yb3V0ZXIgbW9kdWxlLiBEbyBub3QgaW5jbHVkZSB0aGlzIG1vZHVsZSBhcyBhIGRlcGVuZGVuY3kKICogaW4geW91ciBhbmd1bGFyIGFwcCAodXNlIHtAbGluayB1aS5yb3V0ZXJ9IG1vZHVsZSBpbnN0ZWFkKS4KICogCiAqLwphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJywgWyd1aS5yb3V0ZXIucm91dGVyJywgJ3VpLnJvdXRlci51dGlsJ10pOwoKLyoqCiAqIEBuZ2RvYyBvdmVydmlldwogKiBAbmFtZSB1aS5yb3V0ZXIKICoKICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogIyB1aS5yb3V0ZXIKICogCiAqICMjIFRoZSBtYWluIG1vZHVsZSBmb3IgdWkucm91dGVyIAogKiBUaGVyZSBhcmUgc2V2ZXJhbCBzdWItbW9kdWxlcyBpbmNsdWRlZCB3aXRoIHRoZSB1aS5yb3V0ZXIgbW9kdWxlLCBob3dldmVyIG9ubHkgdGhpcyBtb2R1bGUgaXMgbmVlZGVkCiAqIGFzIGEgZGVwZW5kZW5jeSB3aXRoaW4geW91ciBhbmd1bGFyIGFwcC4gVGhlIG90aGVyIG1vZHVsZXMgYXJlIGZvciBvcmdhbml6YXRpb24gcHVycG9zZXMuIAogKgogKiBUaGUgbW9kdWxlcyBhcmU6CiAqICogdWkucm91dGVyIC0gdGhlIG1haW4gInVtYnJlbGxhIiBtb2R1bGUKICogKiB1aS5yb3V0ZXIucm91dGVyIC0gCiAqIAogKiAqWW91J2xsIG5lZWQgdG8gaW5jbHVkZSAqKm9ubHkqKiB0aGlzIG1vZHVsZSBhcyB0aGUgZGVwZW5kZW5jeSB3aXRoaW4geW91ciBhbmd1bGFyIGFwcC4qCiAqIAogKiA8cHJlPgogKiA8IWRvY3R5cGUgaHRtbD4KICogPGh0bWwgbmctYXBwPSJteUFwcCI+CiAqIDxoZWFkPgogKiAgIDxzY3JpcHQgc3JjPSJqcy9hbmd1bGFyLmpzIj48L3NjcmlwdD4KICogICA8IS0tIEluY2x1ZGUgdGhlIHVpLXJvdXRlciBzY3JpcHQgLS0+CiAqICAgPHNjcmlwdCBzcmM9ImpzL2FuZ3VsYXItdWktcm91dGVyLm1pbi5qcyI+PC9zY3JpcHQ+CiAqICAgPHNjcmlwdD4KICogICAgIC8vIC4uLmFuZCBhZGQgJ3VpLnJvdXRlcicgYXMgYSBkZXBlbmRlbmN5CiAqICAgICB2YXIgbXlBcHAgPSBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbJ3VpLnJvdXRlciddKTsKICogICA8L3NjcmlwdD4KICogPC9oZWFkPgogKiA8Ym9keT4KICogPC9ib2R5PgogKiA8L2h0bWw+CiAqIDwvcHJlPgogKi8KYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlcicsIFsndWkucm91dGVyLnN0YXRlJ10pOwoKYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5jb21wYXQnLCBbJ3VpLnJvdXRlciddKTsKCi8qKgogKiBAbmdkb2Mgb2JqZWN0CiAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlCiAqCiAqIEByZXF1aXJlcyAkcQogKiBAcmVxdWlyZXMgJGluamVjdG9yCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBNYW5hZ2VzIHJlc29sdXRpb24gb2YgKGFjeWNsaWMpIGdyYXBocyBvZiBwcm9taXNlcy4KICovCiRSZXNvbHZlLiRpbmplY3QgPSBbJyRxJywgJyRpbmplY3RvciddOwpmdW5jdGlvbiAkUmVzb2x2ZSggICRxLCAgICAkaW5qZWN0b3IpIHsKICAKICB2YXIgVklTSVRfSU5fUFJPR1JFU1MgPSAxLAogICAgICBWSVNJVF9ET05FID0gMiwKICAgICAgTk9USElORyA9IHt9LAogICAgICBOT19ERVBFTkRFTkNJRVMgPSBbXSwKICAgICAgTk9fTE9DQUxTID0gTk9USElORywKICAgICAgTk9fUEFSRU5UID0gZXh0ZW5kKCRxLndoZW4oTk9USElORyksIHsgJCRwcm9taXNlczogTk9USElORywgJCR2YWx1ZXM6IE5PVEhJTkcgfSk7CiAgCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlI3N0dWR5CiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTdHVkaWVzIGEgc2V0IG9mIGludm9jYWJsZXMgdGhhdCBhcmUgbGlrZWx5IHRvIGJlIHVzZWQgbXVsdGlwbGUgdGltZXMuCiAgICogPHByZT4KICAgKiAkcmVzb2x2ZS5zdHVkeShpbnZvY2FibGVzKShsb2NhbHMsIHBhcmVudCwgc2VsZikKICAgKiA8L3ByZT4KICAgKiBpcyBlcXVpdmFsZW50IHRvCiAgICogPHByZT4KICAgKiAkcmVzb2x2ZS5yZXNvbHZlKGludm9jYWJsZXMsIGxvY2FscywgcGFyZW50LCBzZWxmKQogICAqIDwvcHJlPgogICAqIGJ1dCB0aGUgZm9ybWVyIGlzIG1vcmUgZWZmaWNpZW50IChpbiBmYWN0IGByZXNvbHZlYCBqdXN0IGNhbGxzIGBzdHVkeWAgCiAgICogaW50ZXJuYWxseSkuCiAgICoKICAgKiBAcGFyYW0ge29iamVjdH0gaW52b2NhYmxlcyBJbnZvY2FibGUgb2JqZWN0cwogICAqIEByZXR1cm4ge2Z1bmN0aW9ufSBhIGZ1bmN0aW9uIHRvIHBhc3MgaW4gbG9jYWxzLCBwYXJlbnQgYW5kIHNlbGYKICAgKi8KICB0aGlzLnN0dWR5ID0gZnVuY3Rpb24gKGludm9jYWJsZXMpIHsKICAgIGlmICghaXNPYmplY3QoaW52b2NhYmxlcykpIHRocm93IG5ldyBFcnJvcigiJ2ludm9jYWJsZXMnIG11c3QgYmUgYW4gb2JqZWN0Iik7CiAgICAKICAgIC8vIFBlcmZvcm0gYSB0b3BvbG9naWNhbCBzb3J0IG9mIGludm9jYWJsZXMgdG8gYnVpbGQgYW4gb3JkZXJlZCBwbGFuCiAgICB2YXIgcGxhbiA9IFtdLCBjeWNsZSA9IFtdLCB2aXNpdGVkID0ge307CiAgICBmdW5jdGlvbiB2aXNpdCh2YWx1ZSwga2V5KSB7CiAgICAgIGlmICh2aXNpdGVkW2tleV0gPT09IFZJU0lUX0RPTkUpIHJldHVybjsKICAgICAgCiAgICAgIGN5Y2xlLnB1c2goa2V5KTsKICAgICAgaWYgKHZpc2l0ZWRba2V5XSA9PT0gVklTSVRfSU5fUFJPR1JFU1MpIHsKICAgICAgICBjeWNsZS5zcGxpY2UoMCwgY3ljbGUuaW5kZXhPZihrZXkpKTsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkN5Y2xpYyBkZXBlbmRlbmN5OiAiICsgY3ljbGUuam9pbigiIC0+ICIpKTsKICAgICAgfQogICAgICB2aXNpdGVkW2tleV0gPSBWSVNJVF9JTl9QUk9HUkVTUzsKICAgICAgCiAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICBwbGFuLnB1c2goa2V5LCBbIGZ1bmN0aW9uKCkgeyByZXR1cm4gJGluamVjdG9yLmdldCh2YWx1ZSk7IH1dLCBOT19ERVBFTkRFTkNJRVMpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBwYXJhbXMgPSAkaW5qZWN0b3IuYW5ub3RhdGUodmFsdWUpOwogICAgICAgIGZvckVhY2gocGFyYW1zLCBmdW5jdGlvbiAocGFyYW0pIHsKICAgICAgICAgIGlmIChwYXJhbSAhPT0ga2V5ICYmIGludm9jYWJsZXMuaGFzT3duUHJvcGVydHkocGFyYW0pKSB2aXNpdChpbnZvY2FibGVzW3BhcmFtXSwgcGFyYW0pOwogICAgICAgIH0pOwogICAgICAgIHBsYW4ucHVzaChrZXksIHZhbHVlLCBwYXJhbXMpOwogICAgICB9CiAgICAgIAogICAgICBjeWNsZS5wb3AoKTsKICAgICAgdmlzaXRlZFtrZXldID0gVklTSVRfRE9ORTsKICAgIH0KICAgIGZvckVhY2goaW52b2NhYmxlcywgdmlzaXQpOwogICAgaW52b2NhYmxlcyA9IGN5Y2xlID0gdmlzaXRlZCA9IG51bGw7IC8vIHBsYW4gaXMgYWxsIHRoYXQncyByZXF1aXJlZAogICAgCiAgICBmdW5jdGlvbiBpc1Jlc29sdmUodmFsdWUpIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0KHZhbHVlKSAmJiB2YWx1ZS50aGVuICYmIHZhbHVlLiQkcHJvbWlzZXM7CiAgICB9CiAgICAKICAgIHJldHVybiBmdW5jdGlvbiAobG9jYWxzLCBwYXJlbnQsIHNlbGYpIHsKICAgICAgaWYgKGlzUmVzb2x2ZShsb2NhbHMpICYmIHNlbGYgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHNlbGYgPSBwYXJlbnQ7IHBhcmVudCA9IGxvY2FsczsgbG9jYWxzID0gbnVsbDsKICAgICAgfQogICAgICBpZiAoIWxvY2FscykgbG9jYWxzID0gTk9fTE9DQUxTOwogICAgICBlbHNlIGlmICghaXNPYmplY3QobG9jYWxzKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiJ2xvY2FscycgbXVzdCBiZSBhbiBvYmplY3QiKTsKICAgICAgfSAgICAgICAKICAgICAgaWYgKCFwYXJlbnQpIHBhcmVudCA9IE5PX1BBUkVOVDsKICAgICAgZWxzZSBpZiAoIWlzUmVzb2x2ZShwYXJlbnQpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCIncGFyZW50JyBtdXN0IGJlIGEgcHJvbWlzZSByZXR1cm5lZCBieSAkcmVzb2x2ZS5yZXNvbHZlKCkiKTsKICAgICAgfQogICAgICAKICAgICAgLy8gVG8gY29tcGxldGUgdGhlIG92ZXJhbGwgcmVzb2x1dGlvbiwgd2UgaGF2ZSB0byB3YWl0IGZvciB0aGUgcGFyZW50CiAgICAgIC8vIHByb21pc2UgYW5kIGZvciB0aGUgcHJvbWlzZSBmb3IgZWFjaCBpbnZva2FibGUgaW4gb3VyIHBsYW4uCiAgICAgIHZhciByZXNvbHV0aW9uID0gJHEuZGVmZXIoKSwKICAgICAgICAgIHJlc3VsdCA9IHJlc29sdXRpb24ucHJvbWlzZSwKICAgICAgICAgIHByb21pc2VzID0gcmVzdWx0LiQkcHJvbWlzZXMgPSB7fSwKICAgICAgICAgIHZhbHVlcyA9IGV4dGVuZCh7fSwgbG9jYWxzKSwKICAgICAgICAgIHdhaXQgPSAxICsgcGxhbi5sZW5ndGgvMywKICAgICAgICAgIG1lcmdlZCA9IGZhbHNlOwogICAgICAgICAgCiAgICAgIGZ1bmN0aW9uIGRvbmUoKSB7CiAgICAgICAgLy8gTWVyZ2UgcGFyZW50IHZhbHVlcyB3ZSBoYXZlbid0IGdvdCB5ZXQgYW5kIHB1Ymxpc2ggb3VyIG93biAkJHZhbHVlcwogICAgICAgIGlmICghLS13YWl0KSB7CiAgICAgICAgICBpZiAoIW1lcmdlZCkgbWVyZ2UodmFsdWVzLCBwYXJlbnQuJCR2YWx1ZXMpOyAKICAgICAgICAgIHJlc3VsdC4kJHZhbHVlcyA9IHZhbHVlczsKICAgICAgICAgIHJlc3VsdC4kJHByb21pc2VzID0gdHJ1ZTsgLy8ga2VlcCBmb3IgaXNSZXNvbHZlKCkKICAgICAgICAgIHJlc29sdXRpb24ucmVzb2x2ZSh2YWx1ZXMpOwogICAgICAgIH0KICAgICAgfQogICAgICAKICAgICAgZnVuY3Rpb24gZmFpbChyZWFzb24pIHsKICAgICAgICByZXN1bHQuJCRmYWlsdXJlID0gcmVhc29uOwogICAgICAgIHJlc29sdXRpb24ucmVqZWN0KHJlYXNvbik7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFNob3J0LWNpcmN1aXQgaWYgcGFyZW50IGhhcyBhbHJlYWR5IGZhaWxlZAogICAgICBpZiAoaXNEZWZpbmVkKHBhcmVudC4kJGZhaWx1cmUpKSB7CiAgICAgICAgZmFpbChwYXJlbnQuJCRmYWlsdXJlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIAogICAgICAvLyBNZXJnZSBwYXJlbnQgdmFsdWVzIGlmIHRoZSBwYXJlbnQgaGFzIGFscmVhZHkgcmVzb2x2ZWQsIG9yIG1lcmdlCiAgICAgIC8vIHBhcmVudCBwcm9taXNlcyBhbmQgd2FpdCBpZiB0aGUgcGFyZW50IHJlc29sdmUgaXMgc3RpbGwgaW4gcHJvZ3Jlc3MuCiAgICAgIGlmIChwYXJlbnQuJCR2YWx1ZXMpIHsKICAgICAgICBtZXJnZWQgPSBtZXJnZSh2YWx1ZXMsIHBhcmVudC4kJHZhbHVlcyk7CiAgICAgICAgZG9uZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIGV4dGVuZChwcm9taXNlcywgcGFyZW50LiQkcHJvbWlzZXMpOwogICAgICAgIHBhcmVudC50aGVuKGRvbmUsIGZhaWwpOwogICAgICB9CiAgICAgIAogICAgICAvLyBQcm9jZXNzIGVhY2ggaW52b2NhYmxlIGluIHRoZSBwbGFuLCBidXQgaWdub3JlIGFueSB3aGVyZSBhIGxvY2FsIG9mIHRoZSBzYW1lIG5hbWUgZXhpc3RzLgogICAgICBmb3IgKHZhciBpPTAsIGlpPXBsYW4ubGVuZ3RoOyBpPGlpOyBpKz0zKSB7CiAgICAgICAgaWYgKGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShwbGFuW2ldKSkgZG9uZSgpOwogICAgICAgIGVsc2UgaW52b2tlKHBsYW5baV0sIHBsYW5baSsxXSwgcGxhbltpKzJdKTsKICAgICAgfQogICAgICAKICAgICAgZnVuY3Rpb24gaW52b2tlKGtleSwgaW52b2NhYmxlLCBwYXJhbXMpIHsKICAgICAgICAvLyBDcmVhdGUgYSBkZWZlcnJlZCBmb3IgdGhpcyBpbnZvY2F0aW9uLiBGYWlsdXJlcyB3aWxsIHByb3BhZ2F0ZSB0byB0aGUgcmVzb2x1dGlvbiBhcyB3ZWxsLgogICAgICAgIHZhciBpbnZvY2F0aW9uID0gJHEuZGVmZXIoKSwgd2FpdFBhcmFtcyA9IDA7CiAgICAgICAgZnVuY3Rpb24gb25mYWlsdXJlKHJlYXNvbikgewogICAgICAgICAgaW52b2NhdGlvbi5yZWplY3QocmVhc29uKTsKICAgICAgICAgIGZhaWwocmVhc29uKTsKICAgICAgICB9CiAgICAgICAgLy8gV2FpdCBmb3IgYW55IHBhcmFtZXRlciB0aGF0IHdlIGhhdmUgYSBwcm9taXNlIGZvciAoZWl0aGVyIGZyb20gcGFyZW50IG9yIGZyb20gdGhpcwogICAgICAgIC8vIHJlc29sdmU7IGluIHRoYXQgY2FzZSBzdHVkeSgpIHdpbGwgaGF2ZSBtYWRlIHN1cmUgaXQncyBvcmRlcmVkIGJlZm9yZSB1cyBpbiB0aGUgcGxhbikuCiAgICAgICAgZm9yRWFjaChwYXJhbXMsIGZ1bmN0aW9uIChkZXApIHsKICAgICAgICAgIGlmIChwcm9taXNlcy5oYXNPd25Qcm9wZXJ0eShkZXApICYmICFsb2NhbHMuaGFzT3duUHJvcGVydHkoZGVwKSkgewogICAgICAgICAgICB3YWl0UGFyYW1zKys7CiAgICAgICAgICAgIHByb21pc2VzW2RlcF0udGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgdmFsdWVzW2RlcF0gPSByZXN1bHQ7CiAgICAgICAgICAgICAgaWYgKCEoLS13YWl0UGFyYW1zKSkgcHJvY2VlZCgpOwogICAgICAgICAgICB9LCBvbmZhaWx1cmUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmICghd2FpdFBhcmFtcykgcHJvY2VlZCgpOwogICAgICAgIGZ1bmN0aW9uIHByb2NlZWQoKSB7CiAgICAgICAgICBpZiAoaXNEZWZpbmVkKHJlc3VsdC4kJGZhaWx1cmUpKSByZXR1cm47CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpbnZvY2F0aW9uLnJlc29sdmUoJGluamVjdG9yLmludm9rZShpbnZvY2FibGUsIHNlbGYsIHZhbHVlcykpOwogICAgICAgICAgICBpbnZvY2F0aW9uLnByb21pc2UudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgdmFsdWVzW2tleV0gPSByZXN1bHQ7CiAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9LCBvbmZhaWx1cmUpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBvbmZhaWx1cmUoZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFB1Ymxpc2ggcHJvbWlzZSBzeW5jaHJvbm91c2x5OyBpbnZvY2F0aW9ucyBmdXJ0aGVyIGRvd24gaW4gdGhlIHBsYW4gbWF5IGRlcGVuZCBvbiBpdC4KICAgICAgICBwcm9taXNlc1trZXldID0gaW52b2NhdGlvbi5wcm9taXNlOwogICAgICB9CiAgICAgIAogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwogIAogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlI3Jlc29sdmUKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHJlc29sdmUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlc29sdmVzIGEgc2V0IG9mIGludm9jYWJsZXMuIEFuIGludm9jYWJsZSBpcyBhIGZ1bmN0aW9uIHRvIGJlIGludm9rZWQgdmlhIAogICAqIGAkaW5qZWN0b3IuaW52b2tlKClgLCBhbmQgY2FuIGhhdmUgYW4gYXJiaXRyYXJ5IG51bWJlciBvZiBkZXBlbmRlbmNpZXMuIAogICAqIEFuIGludm9jYWJsZSBjYW4gZWl0aGVyIHJldHVybiBhIHZhbHVlIGRpcmVjdGx5LAogICAqIG9yIGEgYCRxYCBwcm9taXNlLiBJZiBhIHByb21pc2UgaXMgcmV0dXJuZWQgaXQgd2lsbCBiZSByZXNvbHZlZCBhbmQgdGhlIAogICAqIHJlc3VsdGluZyB2YWx1ZSB3aWxsIGJlIHVzZWQgaW5zdGVhZC4gRGVwZW5kZW5jaWVzIG9mIGludm9jYWJsZXMgYXJlIHJlc29sdmVkIAogICAqIChpbiB0aGlzIG9yZGVyIG9mIHByZWNlZGVuY2UpCiAgICoKICAgKiAtIGZyb20gdGhlIHNwZWNpZmllZCBgbG9jYWxzYAogICAqIC0gZnJvbSBhbm90aGVyIGludm9jYWJsZSB0aGF0IGlzIHBhcnQgb2YgdGhpcyBgJHJlc29sdmVgIGNhbGwKICAgKiAtIGZyb20gYW4gaW52b2NhYmxlIHRoYXQgaXMgaW5oZXJpdGVkIGZyb20gYSBgcGFyZW50YCBjYWxsIHRvIGAkcmVzb2x2ZWAgCiAgICogICAob3IgcmVjdXJzaXZlbHkKICAgKiAtIGZyb20gYW55IGFuY2VzdG9yIGAkcmVzb2x2ZWAgb2YgdGhhdCBwYXJlbnQpLgogICAqCiAgICogVGhlIHJldHVybiB2YWx1ZSBvZiBgJHJlc29sdmVgIGlzIGEgcHJvbWlzZSBmb3IgYW4gb2JqZWN0IHRoYXQgY29udGFpbnMgCiAgICogKGluIHRoaXMgb3JkZXIgb2YgcHJlY2VkZW5jZSkKICAgKgogICAqIC0gYW55IGBsb2NhbHNgIChpZiBzcGVjaWZpZWQpCiAgICogLSB0aGUgcmVzb2x2ZWQgcmV0dXJuIHZhbHVlcyBvZiBhbGwgaW5qZWN0YWJsZXMKICAgKiAtIGFueSB2YWx1ZXMgaW5oZXJpdGVkIGZyb20gYSBgcGFyZW50YCBjYWxsIHRvIGAkcmVzb2x2ZWAgKGlmIHNwZWNpZmllZCkKICAgKgogICAqIFRoZSBwcm9taXNlIHdpbGwgcmVzb2x2ZSBhZnRlciB0aGUgYHBhcmVudGAgcHJvbWlzZSAoaWYgYW55KSBhbmQgYWxsIHByb21pc2VzIAogICAqIHJldHVybmVkIGJ5IGluamVjdGFibGVzIGhhdmUgYmVlbiByZXNvbHZlZC4gSWYgYW55IGludm9jYWJsZSAKICAgKiAob3IgYCRpbmplY3Rvci5pbnZva2VgKSB0aHJvd3MgYW4gZXhjZXB0aW9uLCBvciBpZiBhIHByb21pc2UgcmV0dXJuZWQgYnkgYW4gCiAgICogaW52b2NhYmxlIGlzIHJlamVjdGVkLCB0aGUgYCRyZXNvbHZlYCBwcm9taXNlIGlzIGltbWVkaWF0ZWx5IHJlamVjdGVkIHdpdGggdGhlIAogICAqIHNhbWUgZXJyb3IuIEEgcmVqZWN0aW9uIG9mIGEgYHBhcmVudGAgcHJvbWlzZSAoaWYgc3BlY2lmaWVkKSB3aWxsIGxpa2V3aXNlIGJlIAogICAqIHByb3BhZ2F0ZWQgaW1tZWRpYXRlbHkuIE9uY2UgdGhlIGAkcmVzb2x2ZWAgcHJvbWlzZSBoYXMgYmVlbiByZWplY3RlZCwgbm8gCiAgICogZnVydGhlciBpbnZvY2FibGVzIHdpbGwgYmUgY2FsbGVkLgogICAqIAogICAqIEN5Y2xpYyBkZXBlbmRlbmNpZXMgYmV0d2VlbiBpbnZvY2FibGVzIGFyZSBub3QgcGVybWl0dGVkIGFuZCB3aWxsIGNhdWVzIGAkcmVzb2x2ZWAKICAgKiB0byB0aHJvdyBhbiBlcnJvci4gQXMgYSBzcGVjaWFsIGNhc2UsIGFuIGluamVjdGFibGUgY2FuIGRlcGVuZCBvbiBhIHBhcmFtZXRlciAKICAgKiB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGluamVjdGFibGUsIHdoaWNoIHdpbGwgYmUgZnVsZmlsbGVkIGZyb20gdGhlIGBwYXJlbnRgIAogICAqIGluamVjdGFibGUgb2YgdGhlIHNhbWUgbmFtZS4gVGhpcyBhbGxvd3MgaW5oZXJpdGVkIHZhbHVlcyB0byBiZSBkZWNvcmF0ZWQuIAogICAqIE5vdGUgdGhhdCBpbiB0aGlzIGNhc2UgYW55IG90aGVyIGluamVjdGFibGUgaW4gdGhlIHNhbWUgYCRyZXNvbHZlYCB3aXRoIHRoZSBzYW1lCiAgICogZGVwZW5kZW5jeSB3b3VsZCBzZWUgdGhlIGRlY29yYXRlZCB2YWx1ZSwgbm90IHRoZSBpbmhlcml0ZWQgdmFsdWUuCiAgICoKICAgKiBOb3RlIHRoYXQgbWlzc2luZyBkZXBlbmRlbmNpZXMgLS0gdW5saWtlIGN5Y2xpYyBkZXBlbmRlbmNpZXMgLS0gd2lsbCBjYXVzZSBhbiAKICAgKiAoYXN5bmNocm9ub3VzKSByZWplY3Rpb24gb2YgdGhlIGAkcmVzb2x2ZWAgcHJvbWlzZSByYXRoZXIgdGhhbiBhIChzeW5jaHJvbm91cykgCiAgICogZXhjZXB0aW9uLgogICAqCiAgICogSW52b2NhYmxlcyBhcmUgaW52b2tlZCBlYWdlcmx5IGFzIHNvb24gYXMgYWxsIGRlcGVuZGVuY2llcyBhcmUgYXZhaWxhYmxlLiAKICAgKiBUaGlzIGlzIHRydWUgZXZlbiBmb3IgZGVwZW5kZW5jaWVzIGluaGVyaXRlZCBmcm9tIGEgYHBhcmVudGAgY2FsbCB0byBgJHJlc29sdmVgLgogICAqCiAgICogQXMgYSBzcGVjaWFsIGNhc2UsIGFuIGludm9jYWJsZSBjYW4gYmUgYSBzdHJpbmcsIGluIHdoaWNoIGNhc2UgaXQgaXMgdGFrZW4gdG8gCiAgICogYmUgYSBzZXJ2aWNlIG5hbWUgdG8gYmUgcGFzc2VkIHRvIGAkaW5qZWN0b3IuZ2V0KClgLiBUaGlzIGlzIHN1cHBvcnRlZCBwcmltYXJpbHkgCiAgICogZm9yIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IHdpdGggdGhlIGByZXNvbHZlYCBwcm9wZXJ0eSBvZiBgJHJvdXRlUHJvdmlkZXJgIAogICAqIHJvdXRlcy4KICAgKgogICAqIEBwYXJhbSB7b2JqZWN0fSBpbnZvY2FibGVzIGZ1bmN0aW9ucyB0byBpbnZva2Ugb3IgCiAgICogYCRpbmplY3RvcmAgc2VydmljZXMgdG8gZmV0Y2guCiAgICogQHBhcmFtIHtvYmplY3R9IGxvY2FscyAgdmFsdWVzIHRvIG1ha2UgYXZhaWxhYmxlIHRvIHRoZSBpbmplY3RhYmxlcwogICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJlbnQgIGEgcHJvbWlzZSByZXR1cm5lZCBieSBhbm90aGVyIGNhbGwgdG8gYCRyZXNvbHZlYC4KICAgKiBAcGFyYW0ge29iamVjdH0gc2VsZiAgdGhlIGB0aGlzYCBmb3IgdGhlIGludm9rZWQgbWV0aG9kcwogICAqIEByZXR1cm4ge29iamVjdH0gUHJvbWlzZSBmb3IgYW4gb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIHJlc29sdmVkIHJldHVybiB2YWx1ZQogICAqIG9mIGFsbCBpbnZvY2FibGVzLCBhcyB3ZWxsIGFzIGFueSBpbmhlcml0ZWQgYW5kIGxvY2FsIHZhbHVlcy4KICAgKi8KICB0aGlzLnJlc29sdmUgPSBmdW5jdGlvbiAoaW52b2NhYmxlcywgbG9jYWxzLCBwYXJlbnQsIHNlbGYpIHsKICAgIHJldHVybiB0aGlzLnN0dWR5KGludm9jYWJsZXMpKGxvY2FscywgcGFyZW50LCBzZWxmKTsKICB9Owp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnV0aWwnKS5zZXJ2aWNlKCckcmVzb2x2ZScsICRSZXNvbHZlKTsKCgovKioKICogQG5nZG9jIG9iamVjdAogKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5CiAqCiAqIEByZXF1aXJlcyAkaHR0cAogKiBAcmVxdWlyZXMgJHRlbXBsYXRlQ2FjaGUKICogQHJlcXVpcmVzICRpbmplY3RvcgogKgogKiBAZGVzY3JpcHRpb24KICogU2VydmljZS4gTWFuYWdlcyBsb2FkaW5nIG9mIHRlbXBsYXRlcy4KICovCiRUZW1wbGF0ZUZhY3RvcnkuJGluamVjdCA9IFsnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJGluamVjdG9yJ107CmZ1bmN0aW9uICRUZW1wbGF0ZUZhY3RvcnkoICAkaHR0cCwgICAkdGVtcGxhdGVDYWNoZSwgICAkaW5qZWN0b3IpIHsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tQ29uZmlnCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSB0ZW1wbGF0ZSBmcm9tIGEgY29uZmlndXJhdGlvbiBvYmplY3QuIAogICAqCiAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyBDb25maWd1cmF0aW9uIG9iamVjdCBmb3Igd2hpY2ggdG8gbG9hZCBhIHRlbXBsYXRlLiAKICAgKiBUaGUgZm9sbG93aW5nIHByb3BlcnRpZXMgYXJlIHNlYXJjaCBpbiB0aGUgc3BlY2lmaWVkIG9yZGVyLCBhbmQgdGhlIGZpcnN0IG9uZSAKICAgKiB0aGF0IGlzIGRlZmluZWQgaXMgdXNlZCB0byBjcmVhdGUgdGhlIHRlbXBsYXRlOgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBjb25maWcudGVtcGxhdGUgaHRtbCBzdHJpbmcgdGVtcGxhdGUgb3IgZnVuY3Rpb24gdG8gCiAgICogbG9hZCB2aWEge0BsaW5rIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkjZnJvbVN0cmluZyBmcm9tU3RyaW5nfS4KICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IGNvbmZpZy50ZW1wbGF0ZVVybCB1cmwgdG8gbG9hZCBvciBhIGZ1bmN0aW9uIHJldHVybmluZyAKICAgKiB0aGUgdXJsIHRvIGxvYWQgdmlhIHtAbGluayB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21VcmwgZnJvbVVybH0uCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnLnRlbXBsYXRlUHJvdmlkZXIgZnVuY3Rpb24gdG8gaW52b2tlIHZpYSAKICAgKiB7QGxpbmsgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tUHJvdmlkZXIgZnJvbVByb3ZpZGVyfS4KICAgKiBAcGFyYW0ge29iamVjdH0gcGFyYW1zICBQYXJhbWV0ZXJzIHRvIHBhc3MgdG8gdGhlIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAqIEBwYXJhbSB7b2JqZWN0fSBsb2NhbHMgTG9jYWxzIHRvIHBhc3MgdG8gYGludm9rZWAgaWYgdGhlIHRlbXBsYXRlIGlzIGxvYWRlZCAKICAgKiB2aWEgYSBgdGVtcGxhdGVQcm92aWRlcmAuIERlZmF1bHRzIHRvIGB7IHBhcmFtczogcGFyYW1zIH1gLgogICAqCiAgICogQHJldHVybiB7c3RyaW5nfG9iamVjdH0gIFRoZSB0ZW1wbGF0ZSBodG1sIGFzIGEgc3RyaW5nLCBvciBhIHByb21pc2UgZm9yIAogICAqIHRoYXQgc3RyaW5nLG9yIGBudWxsYCBpZiBubyB0ZW1wbGF0ZSBpcyBjb25maWd1cmVkLgogICAqLwogIHRoaXMuZnJvbUNvbmZpZyA9IGZ1bmN0aW9uIChjb25maWcsIHBhcmFtcywgbG9jYWxzKSB7CiAgICByZXR1cm4gKAogICAgICBpc0RlZmluZWQoY29uZmlnLnRlbXBsYXRlKSA/IHRoaXMuZnJvbVN0cmluZyhjb25maWcudGVtcGxhdGUsIHBhcmFtcykgOgogICAgICBpc0RlZmluZWQoY29uZmlnLnRlbXBsYXRlVXJsKSA/IHRoaXMuZnJvbVVybChjb25maWcudGVtcGxhdGVVcmwsIHBhcmFtcykgOgogICAgICBpc0RlZmluZWQoY29uZmlnLnRlbXBsYXRlUHJvdmlkZXIpID8gdGhpcy5mcm9tUHJvdmlkZXIoY29uZmlnLnRlbXBsYXRlUHJvdmlkZXIsIHBhcmFtcywgbG9jYWxzKSA6CiAgICAgIG51bGwKICAgICk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tU3RyaW5nCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSB0ZW1wbGF0ZSBmcm9tIGEgc3RyaW5nIG9yIGEgZnVuY3Rpb24gcmV0dXJuaW5nIGEgc3RyaW5nLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSB0ZW1wbGF0ZSBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nIG9yIGZ1bmN0aW9uIHRoYXQgCiAgICogcmV0dXJucyBhbiBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nLgogICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgUGFyYW1ldGVycyB0byBwYXNzIHRvIHRoZSB0ZW1wbGF0ZSBmdW5jdGlvbi4KICAgKgogICAqIEByZXR1cm4ge3N0cmluZ3xvYmplY3R9IFRoZSB0ZW1wbGF0ZSBodG1sIGFzIGEgc3RyaW5nLCBvciBhIHByb21pc2UgZm9yIHRoYXQgCiAgICogc3RyaW5nLgogICAqLwogIHRoaXMuZnJvbVN0cmluZyA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgcGFyYW1zKSB7CiAgICByZXR1cm4gaXNGdW5jdGlvbih0ZW1wbGF0ZSkgPyB0ZW1wbGF0ZShwYXJhbXMpIDogdGVtcGxhdGU7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tVXJsCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkKICAgKiAKICAgKiBAZGVzY3JpcHRpb24KICAgKiBMb2FkcyBhIHRlbXBsYXRlIGZyb20gdGhlIGEgVVJMIHZpYSBgJGh0dHBgIGFuZCBgJHRlbXBsYXRlQ2FjaGVgLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8RnVuY3Rpb259IHVybCB1cmwgb2YgdGhlIHRlbXBsYXRlIHRvIGxvYWQsIG9yIGEgZnVuY3Rpb24gCiAgICogdGhhdCByZXR1cm5zIGEgdXJsLgogICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgUGFyYW1ldGVycyB0byBwYXNzIHRvIHRoZSB1cmwgZnVuY3Rpb24uCiAgICogQHJldHVybiB7c3RyaW5nfFByb21pc2UuPHN0cmluZz59IFRoZSB0ZW1wbGF0ZSBodG1sIGFzIGEgc3RyaW5nLCBvciBhIHByb21pc2UgCiAgICogZm9yIHRoYXQgc3RyaW5nLgogICAqLwogIHRoaXMuZnJvbVVybCA9IGZ1bmN0aW9uICh1cmwsIHBhcmFtcykgewogICAgaWYgKGlzRnVuY3Rpb24odXJsKSkgdXJsID0gdXJsKHBhcmFtcyk7CiAgICBpZiAodXJsID09IG51bGwpIHJldHVybiBudWxsOwogICAgZWxzZSByZXR1cm4gJGh0dHAKICAgICAgICAuZ2V0KHVybCwgeyBjYWNoZTogJHRlbXBsYXRlQ2FjaGUgfSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXNwb25zZSkgeyByZXR1cm4gcmVzcG9uc2UuZGF0YTsgfSk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tVXJsCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSB0ZW1wbGF0ZSBieSBpbnZva2luZyBhbiBpbmplY3RhYmxlIHByb3ZpZGVyIGZ1bmN0aW9uLgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXIgRnVuY3Rpb24gdG8gaW52b2tlIHZpYSBgJGluamVjdG9yLmludm9rZWAKICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIFBhcmFtZXRlcnMgZm9yIHRoZSB0ZW1wbGF0ZS4KICAgKiBAcGFyYW0ge09iamVjdH0gbG9jYWxzIExvY2FscyB0byBwYXNzIHRvIGBpbnZva2VgLiBEZWZhdWx0cyB0byAKICAgKiBgeyBwYXJhbXM6IHBhcmFtcyB9YC4KICAgKiBAcmV0dXJuIHtzdHJpbmd8UHJvbWlzZS48c3RyaW5nPn0gVGhlIHRlbXBsYXRlIGh0bWwgYXMgYSBzdHJpbmcsIG9yIGEgcHJvbWlzZSAKICAgKiBmb3IgdGhhdCBzdHJpbmcuCiAgICovCiAgdGhpcy5mcm9tUHJvdmlkZXIgPSBmdW5jdGlvbiAocHJvdmlkZXIsIHBhcmFtcywgbG9jYWxzKSB7CiAgICByZXR1cm4gJGluamVjdG9yLmludm9rZShwcm92aWRlciwgbnVsbCwgbG9jYWxzIHx8IHsgcGFyYW1zOiBwYXJhbXMgfSk7CiAgfTsKfQoKYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci51dGlsJykuc2VydmljZSgnJHRlbXBsYXRlRmFjdG9yeScsICRUZW1wbGF0ZUZhY3RvcnkpOwoKLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBNYXRjaGVzIFVSTHMgYWdhaW5zdCBwYXR0ZXJucyBhbmQgZXh0cmFjdHMgbmFtZWQgcGFyYW1ldGVycyBmcm9tIHRoZSBwYXRoIG9yIHRoZSBzZWFyY2gKICogcGFydCBvZiB0aGUgVVJMLiBBIFVSTCBwYXR0ZXJuIGNvbnNpc3RzIG9mIGEgcGF0aCBwYXR0ZXJuLCBvcHRpb25hbGx5IGZvbGxvd2VkIGJ5ICc/JyBhbmQgYSBsaXN0CiAqIG9mIHNlYXJjaCBwYXJhbWV0ZXJzLiBNdWx0aXBsZSBzZWFyY2ggcGFyYW1ldGVyIG5hbWVzIGFyZSBzZXBhcmF0ZWQgYnkgJyYnLiBTZWFyY2ggcGFyYW1ldGVycwogKiBkbyBub3QgaW5mbHVlbmNlIHdoZXRoZXIgb3Igbm90IGEgVVJMIGlzIG1hdGNoZWQsIGJ1dCB0aGVpciB2YWx1ZXMgYXJlIHBhc3NlZCB0aHJvdWdoIGludG8KICogdGhlIG1hdGNoZWQgcGFyYW1ldGVycyByZXR1cm5lZCBieSB7QGxpbmsgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI21ldGhvZHNfZXhlYyBleGVjfS4KICogCiAqIFBhdGggcGFyYW1ldGVyIHBsYWNlaG9sZGVycyBjYW4gYmUgc3BlY2lmaWVkIHVzaW5nIHNpbXBsZSBjb2xvbi9jYXRjaC1hbGwgc3ludGF4IG9yIGN1cmx5IGJyYWNlCiAqIHN5bnRheCwgd2hpY2ggb3B0aW9uYWxseSBhbGxvd3MgYSByZWd1bGFyIGV4cHJlc3Npb24gZm9yIHRoZSBwYXJhbWV0ZXIgdG8gYmUgc3BlY2lmaWVkOgogKgogKiAqIGAnOidgIG5hbWUgLSBjb2xvbiBwbGFjZWhvbGRlcgogKiAqIGAnKidgIG5hbWUgLSBjYXRjaC1hbGwgcGxhY2Vob2xkZXIKICogKiBgJ3snIG5hbWUgJ30nYCAtIGN1cmx5IHBsYWNlaG9sZGVyCiAqICogYCd7JyBuYW1lICc6JyByZWdleHAgJ30nYCAtIGN1cmx5IHBsYWNlaG9sZGVyIHdpdGggcmVnZXhwLiBTaG91bGQgdGhlIHJlZ2V4cCBpdHNlbGYgY29udGFpbgogKiAgIGN1cmx5IGJyYWNlcywgdGhleSBtdXN0IGJlIGluIG1hdGNoZWQgcGFpcnMgb3IgZXNjYXBlZCB3aXRoIGEgYmFja3NsYXNoLgogKgogKiBQYXJhbWV0ZXIgbmFtZXMgbWF5IGNvbnRhaW4gb25seSB3b3JkIGNoYXJhY3RlcnMgKGxhdGluIGxldHRlcnMsIGRpZ2l0cywgYW5kIHVuZGVyc2NvcmUpIGFuZAogKiBtdXN0IGJlIHVuaXF1ZSB3aXRoaW4gdGhlIHBhdHRlcm4gKGFjcm9zcyBib3RoIHBhdGggYW5kIHNlYXJjaCBwYXJhbWV0ZXJzKS4gRm9yIGNvbG9uIAogKiBwbGFjZWhvbGRlcnMgb3IgY3VybHkgcGxhY2Vob2xkZXJzIHdpdGhvdXQgYW4gZXhwbGljaXQgcmVnZXhwLCBhIHBhdGggcGFyYW1ldGVyIG1hdGNoZXMgYW55CiAqIG51bWJlciBvZiBjaGFyYWN0ZXJzIG90aGVyIHRoYW4gJy8nLiBGb3IgY2F0Y2gtYWxsIHBsYWNlaG9sZGVycyB0aGUgcGF0aCBwYXJhbWV0ZXIgbWF0Y2hlcwogKiBhbnkgbnVtYmVyIG9mIGNoYXJhY3RlcnMuCiAqIAogKiBFeGFtcGxlczoKICogCiAqICogYCcvaGVsbG8vJ2AgLSBNYXRjaGVzIG9ubHkgaWYgdGhlIHBhdGggaXMgZXhhY3RseSAnL2hlbGxvLycuIFRoZXJlIGlzIG5vIHNwZWNpYWwgdHJlYXRtZW50IGZvcgogKiAgIHRyYWlsaW5nIHNsYXNoZXMsIGFuZCBwYXR0ZXJucyBoYXZlIHRvIG1hdGNoIHRoZSBlbnRpcmUgcGF0aCwgbm90IGp1c3QgYSBwcmVmaXguCiAqICogYCcvdXNlci86aWQnYCAtIE1hdGNoZXMgJy91c2VyL2JvYicgb3IgJy91c2VyLzEyMzQhISEnIG9yIGV2ZW4gJy91c2VyLycgYnV0IG5vdCAnL3VzZXInIG9yCiAqICAgJy91c2VyL2JvYi9kZXRhaWxzJy4gVGhlIHNlY29uZCBwYXRoIHNlZ21lbnQgd2lsbCBiZSBjYXB0dXJlZCBhcyB0aGUgcGFyYW1ldGVyICdpZCcuCiAqICogYCcvdXNlci97aWR9J2AgLSBTYW1lIGFzIHRoZSBwcmV2aW91cyBleGFtcGxlLCBidXQgdXNpbmcgY3VybHkgYnJhY2Ugc3ludGF4LgogKiAqIGAnL3VzZXIve2lkOlteL10qfSdgIC0gU2FtZSBhcyB0aGUgcHJldmlvdXMgZXhhbXBsZS4KICogKiBgJy91c2VyL3tpZDpbMC05YS1mQS1GXXsxLDh9fSdgIC0gU2ltaWxhciB0byB0aGUgcHJldmlvdXMgZXhhbXBsZSwgYnV0IG9ubHkgbWF0Y2hlcyBpZiB0aGUgaWQKICogICBwYXJhbWV0ZXIgY29uc2lzdHMgb2YgMSB0byA4IGhleCBkaWdpdHMuCiAqICogYCcvZmlsZXMve3BhdGg6Lip9J2AgLSBNYXRjaGVzIGFueSBVUkwgc3RhcnRpbmcgd2l0aCAnL2ZpbGVzLycgYW5kIGNhcHR1cmVzIHRoZSByZXN0IG9mIHRoZQogKiAgIHBhdGggaW50byB0aGUgcGFyYW1ldGVyICdwYXRoJy4KICogKiBgJy9maWxlcy8qcGF0aCdgIC0gZGl0dG8uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBwYXR0ZXJuICB0aGUgcGF0dGVybiB0byBjb21waWxlIGludG8gYSBtYXRjaGVyLgogKgogKiBAcHJvcGVydHkge3N0cmluZ30gcHJlZml4ICBBIHN0YXRpYyBwcmVmaXggb2YgdGhpcyBwYXR0ZXJuLiBUaGUgbWF0Y2hlciBndWFyYW50ZWVzIHRoYXQgYW55CiAqICAgVVJMIG1hdGNoaW5nIHRoaXMgbWF0Y2hlciAoaS5lLiBhbnkgc3RyaW5nIGZvciB3aGljaCB7QGxpbmsgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI21ldGhvZHNfZXhlYyBleGVjKCl9IHJldHVybnMKICogICBub24tbnVsbCkgd2lsbCBzdGFydCB3aXRoIHRoaXMgcHJlZml4LgogKgogKiBAcHJvcGVydHkge3N0cmluZ30gc291cmNlICBUaGUgcGF0dGVybiB0aGF0IHdhcyBwYXNzZWQgaW50byB0aGUgY29udHJ1Y3RvcgogKgogKiBAcHJvcGVydHkge3N0cmluZ30gc291cmNlUGF0aCAgVGhlIHBhdGggcG9ydGlvbiBvZiB0aGUgc291cmNlIHByb3BlcnR5CiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzb3VyY2VTZWFyY2ggIFRoZSBzZWFyY2ggcG9ydGlvbiBvZiB0aGUgc291cmNlIHByb3BlcnR5CiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSByZWdleCAgVGhlIGNvbnN0cnVjdGVkIHJlZ2V4IHRoYXQgd2lsbCBiZSB1c2VkIHRvIG1hdGNoIGFnYWluc3QgdGhlIHVybCB3aGVuIAogKiAgIGl0IGlzIHRpbWUgdG8gZGV0ZXJtaW5lIHdoaWNoIHVybCB3aWxsIG1hdGNoLgogKgogKiBAcmV0dXJucyB7T2JqZWN0fSAgTmV3IFVybE1hdGNoZXIgb2JqZWN0CiAqLwpmdW5jdGlvbiBVcmxNYXRjaGVyKHBhdHRlcm4pIHsKCiAgLy8gRmluZCBhbGwgcGxhY2Vob2xkZXJzIGFuZCBjcmVhdGUgYSBjb21waWxlZCBwYXR0ZXJuLCB1c2luZyBlaXRoZXIgY2xhc3NpYyBvciBjdXJseSBzeW50YXg6CiAgLy8gICAnKicgbmFtZQogIC8vICAgJzonIG5hbWUKICAvLyAgICd7JyBuYW1lICd9JwogIC8vICAgJ3snIG5hbWUgJzonIHJlZ2V4cCAnfScKICAvLyBUaGUgcmVndWxhciBleHByZXNzaW9uIGlzIHNvbWV3aGF0IGNvbXBsaWNhdGVkIGR1ZSB0byB0aGUgbmVlZCB0byBhbGxvdyBjdXJseSBicmFjZXMKICAvLyBpbnNpZGUgdGhlIHJlZ3VsYXIgZXhwcmVzc2lvbi4gVGhlIHBsYWNlaG9sZGVyIHJlZ2V4cCBicmVha3MgZG93biBhcyBmb2xsb3dzOgogIC8vICAgIChbOipdKShcdyspICAgICAgICAgICAgICAgY2xhc3NpYyBwbGFjZWhvbGRlciAoJDEgLyAkMikKICAvLyAgICBceyhcdyspKD86XDooIC4uLiApKT9cfSAgIGN1cmx5IGJyYWNlIHBsYWNlaG9sZGVyICgkMykgd2l0aCBvcHRpb25hbCByZWdleHAgLi4uICgkNCkKICAvLyAgICAoPzogLi4uIHwgLi4uIHwgLi4uICkrICAgIHRoZSByZWdleHAgY29uc2lzdHMgb2YgYW55IG51bWJlciBvZiBhdG9tcywgYW4gYXRvbSBiZWluZyBlaXRoZXIKICAvLyAgICBbXnt9XFxdKyAgICAgICAgICAgICAgICAgIC0gYW55dGhpbmcgb3RoZXIgdGhhbiBjdXJseSBicmFjZXMgb3IgYmFja3NsYXNoCiAgLy8gICAgXFwuICAgICAgICAgICAgICAgICAgICAgICAtIGEgYmFja3NsYXNoIGVzY2FwZQogIC8vICAgIFx7KD86W157fVxcXSt8XFwuKSpcfSAgICAgLSBhIG1hdGNoZWQgc2V0IG9mIGN1cmx5IGJyYWNlcyBjb250YWluaW5nIG90aGVyIGF0b21zCiAgdmFyIHBsYWNlaG9sZGVyID0gLyhbOipdKShcdyspfFx7KFx3KykoPzpcOigoPzpbXnt9XFxdK3xcXC58XHsoPzpbXnt9XFxdK3xcXC4pKlx9KSspKT9cfS9nLAogICAgICBuYW1lcyA9IHt9LCBjb21waWxlZCA9ICdeJywgbGFzdCA9IDAsIG0sCiAgICAgIHNlZ21lbnRzID0gdGhpcy5zZWdtZW50cyA9IFtdLAogICAgICBwYXJhbXMgPSB0aGlzLnBhcmFtcyA9IFtdOwoKICBmdW5jdGlvbiBhZGRQYXJhbWV0ZXIoaWQpIHsKICAgIGlmICghL15cdysoLStcdyspKiQvLnRlc3QoaWQpKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVyIG5hbWUgJyIgKyBpZCArICInIGluIHBhdHRlcm4gJyIgKyBwYXR0ZXJuICsgIiciKTsKICAgIGlmIChuYW1lc1tpZF0pIHRocm93IG5ldyBFcnJvcigiRHVwbGljYXRlIHBhcmFtZXRlciBuYW1lICciICsgaWQgKyAiJyBpbiBwYXR0ZXJuICciICsgcGF0dGVybiArICInIik7CiAgICBuYW1lc1tpZF0gPSB0cnVlOwogICAgcGFyYW1zLnB1c2goaWQpOwogIH0KCiAgZnVuY3Rpb24gcXVvdGVSZWdFeHAoc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoL1tcXFxbXF1cXiQqKz8uKCl8e31dL2csICJcXCQmIik7CiAgfQoKICB0aGlzLnNvdXJjZSA9IHBhdHRlcm47CgogIC8vIFNwbGl0IGludG8gc3RhdGljIHNlZ21lbnRzIHNlcGFyYXRlZCBieSBwYXRoIHBhcmFtZXRlciBwbGFjZWhvbGRlcnMuCiAgLy8gVGhlIG51bWJlciBvZiBzZWdtZW50cyBpcyBhbHdheXMgMSBtb3JlIHRoYW4gdGhlIG51bWJlciBvZiBwYXJhbWV0ZXJzLgogIHZhciBpZCwgcmVnZXhwLCBzZWdtZW50OwogIHdoaWxlICgobSA9IHBsYWNlaG9sZGVyLmV4ZWMocGF0dGVybikpKSB7CiAgICBpZCA9IG1bMl0gfHwgbVszXTsgLy8gSUVbNzhdIHJldHVybnMgJycgZm9yIHVubWF0Y2hlZCBncm91cHMgaW5zdGVhZCBvZiBudWxsCiAgICByZWdleHAgPSBtWzRdIHx8IChtWzFdID09ICcqJyA/ICcuKicgOiAnW14vXSonKTsKICAgIHNlZ21lbnQgPSBwYXR0ZXJuLnN1YnN0cmluZyhsYXN0LCBtLmluZGV4KTsKICAgIGlmIChzZWdtZW50LmluZGV4T2YoJz8nKSA+PSAwKSBicmVhazsgLy8gd2UncmUgaW50byB0aGUgc2VhcmNoIHBhcnQKICAgIGNvbXBpbGVkICs9IHF1b3RlUmVnRXhwKHNlZ21lbnQpICsgJygnICsgcmVnZXhwICsgJyknOwogICAgYWRkUGFyYW1ldGVyKGlkKTsKICAgIHNlZ21lbnRzLnB1c2goc2VnbWVudCk7CiAgICBsYXN0ID0gcGxhY2Vob2xkZXIubGFzdEluZGV4OwogIH0KICBzZWdtZW50ID0gcGF0dGVybi5zdWJzdHJpbmcobGFzdCk7CgogIC8vIEZpbmQgYW55IHNlYXJjaCBwYXJhbWV0ZXIgbmFtZXMgYW5kIHJlbW92ZSB0aGVtIGZyb20gdGhlIGxhc3Qgc2VnbWVudAogIHZhciBpID0gc2VnbWVudC5pbmRleE9mKCc/Jyk7CiAgaWYgKGkgPj0gMCkgewogICAgdmFyIHNlYXJjaCA9IHRoaXMuc291cmNlU2VhcmNoID0gc2VnbWVudC5zdWJzdHJpbmcoaSk7CiAgICBzZWdtZW50ID0gc2VnbWVudC5zdWJzdHJpbmcoMCwgaSk7CiAgICB0aGlzLnNvdXJjZVBhdGggPSBwYXR0ZXJuLnN1YnN0cmluZygwLCBsYXN0K2kpOwoKICAgIC8vIEFsbG93IHBhcmFtZXRlcnMgdG8gYmUgc2VwYXJhdGVkIGJ5ICc/JyBhcyB3ZWxsIGFzICcmJyB0byBtYWtlIGNvbmNhdCgpIGVhc2llcgogICAgZm9yRWFjaChzZWFyY2guc3Vic3RyaW5nKDEpLnNwbGl0KC9bJj9dLyksIGFkZFBhcmFtZXRlcik7CiAgfSBlbHNlIHsKICAgIHRoaXMuc291cmNlUGF0aCA9IHBhdHRlcm47CiAgICB0aGlzLnNvdXJjZVNlYXJjaCA9ICcnOwogIH0KCiAgY29tcGlsZWQgKz0gcXVvdGVSZWdFeHAoc2VnbWVudCkgKyAnJCc7CiAgc2VnbWVudHMucHVzaChzZWdtZW50KTsKICB0aGlzLnJlZ2V4cCA9IG5ldyBSZWdFeHAoY29tcGlsZWQpOwogIHRoaXMucHJlZml4ID0gc2VnbWVudHNbMF07Cn0KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI2NvbmNhdAogKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBSZXR1cm5zIGEgbmV3IG1hdGNoZXIgZm9yIGEgcGF0dGVybiBjb25zdHJ1Y3RlZCBieSBhcHBlbmRpbmcgdGhlIHBhdGggcGFydCBhbmQgYWRkaW5nIHRoZQogKiBzZWFyY2ggcGFyYW1ldGVycyBvZiB0aGUgc3BlY2lmaWVkIHBhdHRlcm4gdG8gdGhpcyBwYXR0ZXJuLiBUaGUgY3VycmVudCBwYXR0ZXJuIGlzIG5vdAogKiBtb2RpZmllZC4gVGhpcyBjYW4gYmUgdW5kZXJzdG9vZCBhcyBjcmVhdGluZyBhIHBhdHRlcm4gZm9yIFVSTHMgdGhhdCBhcmUgcmVsYXRpdmUgdG8gKG9yCiAqIHN1ZmZpeGVzIG9mKSB0aGUgY3VycmVudCBwYXR0ZXJuLgogKgogKiBAZXhhbXBsZQogKiBUaGUgZm9sbG93aW5nIHR3byBtYXRjaGVycyBhcmUgZXF1aXZhbGVudDoKICogYGBgCiAqIG5ldyBVcmxNYXRjaGVyKCcvdXNlci97aWR9P3EnKS5jb25jYXQoJy9kZXRhaWxzP2RhdGUnKTsKICogbmV3IFVybE1hdGNoZXIoJy91c2VyL3tpZH0vZGV0YWlscz9xJmRhdGUnKTsKICogYGBgCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBwYXR0ZXJuICBUaGUgcGF0dGVybiB0byBhcHBlbmQuCiAqIEByZXR1cm5zIHt1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXJ9ICBBIG1hdGNoZXIgZm9yIHRoZSBjb25jYXRlbmF0ZWQgcGF0dGVybi4KICovClVybE1hdGNoZXIucHJvdG90eXBlLmNvbmNhdCA9IGZ1bmN0aW9uIChwYXR0ZXJuKSB7CiAgLy8gQmVjYXVzZSBvcmRlciBvZiBzZWFyY2ggcGFyYW1ldGVycyBpcyBpcnJlbGV2YW50LCB3ZSBjYW4gYWRkIG91ciBvd24gc2VhcmNoCiAgLy8gcGFyYW1ldGVycyB0byB0aGUgZW5kIG9mIHRoZSBuZXcgcGF0dGVybi4gUGFyc2UgdGhlIG5ldyBwYXR0ZXJuIGJ5IGl0c2VsZgogIC8vIGFuZCB0aGVuIGpvaW4gdGhlIGJpdHMgdG9nZXRoZXIsIGJ1dCBpdCdzIG11Y2ggZWFzaWVyIHRvIGRvIHRoaXMgb24gYSBzdHJpbmcgbGV2ZWwuCiAgcmV0dXJuIG5ldyBVcmxNYXRjaGVyKHRoaXMuc291cmNlUGF0aCArIHBhdHRlcm4gKyB0aGlzLnNvdXJjZVNlYXJjaCk7Cn07CgpVcmxNYXRjaGVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zb3VyY2U7Cn07CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlciNleGVjCiAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFRlc3RzIHRoZSBzcGVjaWZpZWQgcGF0aCBhZ2FpbnN0IHRoaXMgbWF0Y2hlciwgYW5kIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNhcHR1cmVkCiAqIHBhcmFtZXRlciB2YWx1ZXMsIG9yIG51bGwgaWYgdGhlIHBhdGggZG9lcyBub3QgbWF0Y2guIFRoZSByZXR1cm5lZCBvYmplY3QgY29udGFpbnMgdGhlIHZhbHVlcwogKiBvZiBhbnkgc2VhcmNoIHBhcmFtZXRlcnMgdGhhdCBhcmUgbWVudGlvbmVkIGluIHRoZSBwYXR0ZXJuLCBidXQgdGhlaXIgdmFsdWUgbWF5IGJlIG51bGwgaWYKICogdGhleSBhcmUgbm90IHByZXNlbnQgaW4gYHNlYXJjaFBhcmFtc2AuIFRoaXMgbWVhbnMgdGhhdCBzZWFyY2ggcGFyYW1ldGVycyBhcmUgYWx3YXlzIHRyZWF0ZWQKICogYXMgb3B0aW9uYWwuCiAqCiAqIEBleGFtcGxlCiAqIGBgYAogKiBuZXcgVXJsTWF0Y2hlcignL3VzZXIve2lkfT9xJnInKS5leGVjKCcvdXNlci9ib2InLCB7IHg6JzEnLCBxOidoZWxsbycgfSk7CiAqIC8vIHJldHVybnMgeyBpZDonYm9iJywgcTonaGVsbG8nLCByOm51bGwgfQogKiBgYGAKICoKICogQHBhcmFtIHtzdHJpbmd9IHBhdGggIFRoZSBVUkwgcGF0aCB0byBtYXRjaCwgZS5nLiBgJGxvY2F0aW9uLnBhdGgoKWAuCiAqIEBwYXJhbSB7T2JqZWN0fSBzZWFyY2hQYXJhbXMgIFVSTCBzZWFyY2ggcGFyYW1ldGVycywgZS5nLiBgJGxvY2F0aW9uLnNlYXJjaCgpYC4KICogQHJldHVybnMge09iamVjdH0gIFRoZSBjYXB0dXJlZCBwYXJhbWV0ZXIgdmFsdWVzLgogKi8KVXJsTWF0Y2hlci5wcm90b3R5cGUuZXhlYyA9IGZ1bmN0aW9uIChwYXRoLCBzZWFyY2hQYXJhbXMpIHsKICB2YXIgbSA9IHRoaXMucmVnZXhwLmV4ZWMocGF0aCk7CiAgaWYgKCFtKSByZXR1cm4gbnVsbDsKCiAgdmFyIHBhcmFtcyA9IHRoaXMucGFyYW1zLCBuVG90YWwgPSBwYXJhbXMubGVuZ3RoLAogICAgblBhdGggPSB0aGlzLnNlZ21lbnRzLmxlbmd0aC0xLAogICAgdmFsdWVzID0ge30sIGk7CgogIGlmIChuUGF0aCAhPT0gbS5sZW5ndGggLSAxKSB0aHJvdyBuZXcgRXJyb3IoIlVuYmFsYW5jZWQgY2FwdHVyZSBncm91cCBpbiByb3V0ZSAnIiArIHRoaXMuc291cmNlICsgIiciKTsKCiAgZm9yIChpPTA7IGk8blBhdGg7IGkrKykgdmFsdWVzW3BhcmFtc1tpXV0gPSBtW2krMV07CiAgZm9yICgvKiovOyBpPG5Ub3RhbDsgaSsrKSB2YWx1ZXNbcGFyYW1zW2ldXSA9IHNlYXJjaFBhcmFtc1twYXJhbXNbaV1dOwoKICByZXR1cm4gdmFsdWVzOwp9OwoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIjcGFyYW1ldGVycwogKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBSZXR1cm5zIHRoZSBuYW1lcyBvZiBhbGwgcGF0aCBhbmQgc2VhcmNoIHBhcmFtZXRlcnMgb2YgdGhpcyBwYXR0ZXJuIGluIGFuIHVuc3BlY2lmaWVkIG9yZGVyLgogKiAKICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSAgQW4gYXJyYXkgb2YgcGFyYW1ldGVyIG5hbWVzLiBNdXN0IGJlIHRyZWF0ZWQgYXMgcmVhZC1vbmx5LiBJZiB0aGUKICogICAgcGF0dGVybiBoYXMgbm8gcGFyYW1ldGVycywgYW4gZW1wdHkgYXJyYXkgaXMgcmV0dXJuZWQuCiAqLwpVcmxNYXRjaGVyLnByb3RvdHlwZS5wYXJhbWV0ZXJzID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnBhcmFtczsKfTsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI2Zvcm1hdAogKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGEgVVJMIHRoYXQgbWF0Y2hlcyB0aGlzIHBhdHRlcm4gYnkgc3Vic3RpdHV0aW5nIHRoZSBzcGVjaWZpZWQgdmFsdWVzCiAqIGZvciB0aGUgcGF0aCBhbmQgc2VhcmNoIHBhcmFtZXRlcnMuIE51bGwgdmFsdWVzIGZvciBwYXRoIHBhcmFtZXRlcnMgYXJlCiAqIHRyZWF0ZWQgYXMgZW1wdHkgc3RyaW5ncy4KICoKICogQGV4YW1wbGUKICogYGBgCiAqIG5ldyBVcmxNYXRjaGVyKCcvdXNlci97aWR9P3EnKS5mb3JtYXQoeyBpZDonYm9iJywgcToneWVzJyB9KTsKICogLy8gcmV0dXJucyAnL3VzZXIvYm9iP3E9eWVzJwogKiBgYGAKICoKICogQHBhcmFtIHtPYmplY3R9IHZhbHVlcyAgdGhlIHZhbHVlcyB0byBzdWJzdGl0dXRlIGZvciB0aGUgcGFyYW1ldGVycyBpbiB0aGlzIHBhdHRlcm4uCiAqIEByZXR1cm5zIHtzdHJpbmd9ICB0aGUgZm9ybWF0dGVkIFVSTCAocGF0aCBhbmQgb3B0aW9uYWxseSBzZWFyY2ggcGFydCkuCiAqLwpVcmxNYXRjaGVyLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbiAodmFsdWVzKSB7CiAgdmFyIHNlZ21lbnRzID0gdGhpcy5zZWdtZW50cywgcGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgaWYgKCF2YWx1ZXMpIHJldHVybiBzZWdtZW50cy5qb2luKCcnKTsKCiAgdmFyIG5QYXRoID0gc2VnbWVudHMubGVuZ3RoLTEsIG5Ub3RhbCA9IHBhcmFtcy5sZW5ndGgsCiAgICByZXN1bHQgPSBzZWdtZW50c1swXSwgaSwgc2VhcmNoLCB2YWx1ZTsKCiAgZm9yIChpPTA7IGk8blBhdGg7IGkrKykgewogICAgdmFsdWUgPSB2YWx1ZXNbcGFyYW1zW2ldXTsKICAgIC8vIFRPRE86IE1heWJlIHdlIHNob3VsZCB0aHJvdyBvbiBudWxsIGhlcmU/IEl0J3Mgbm90IHJlYWxseSBnb29kIHN0eWxlIHRvIHVzZSAnJyBhbmQgbnVsbCBpbnRlcmNoYW5nZWFibGV5CiAgICBpZiAodmFsdWUgIT0gbnVsbCkgcmVzdWx0ICs9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICByZXN1bHQgKz0gc2VnbWVudHNbaSsxXTsKICB9CiAgZm9yICgvKiovOyBpPG5Ub3RhbDsgaSsrKSB7CiAgICB2YWx1ZSA9IHZhbHVlc1twYXJhbXNbaV1dOwogICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgcmVzdWx0ICs9IChzZWFyY2ggPyAnJicgOiAnPycpICsgcGFyYW1zW2ldICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgc2VhcmNoID0gdHJ1ZTsKICAgIH0KICB9CgogIHJldHVybiByZXN1bHQ7Cn07CgoKCi8qKgogKiBAbmdkb2Mgb2JqZWN0CiAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeQogKgogKiBAZGVzY3JpcHRpb24KICogRmFjdG9yeSBmb3Ige0BsaW5rIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gaW5zdGFuY2VzLiBUaGUgZmFjdG9yeSBpcyBhbHNvIGF2YWlsYWJsZSB0byBwcm92aWRlcnMKICogdW5kZXIgdGhlIG5hbWUgYCR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyYC4KICovCmZ1bmN0aW9uICRVcmxNYXRjaGVyRmFjdG9yeSgpIHsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5I2NvbXBpbGUKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDcmVhdGVzIGEge0BsaW5rIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gZm9yIHRoZSBzcGVjaWZpZWQgcGF0dGVybi4KICAgKiAgIAogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXR0ZXJuICBUaGUgVVJMIHBhdHRlcm4uCiAgICogQHJldHVybnMge3VpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gIFRoZSBVcmxNYXRjaGVyLgogICAqLwogIHRoaXMuY29tcGlsZSA9IGZ1bmN0aW9uIChwYXR0ZXJuKSB7CiAgICByZXR1cm4gbmV3IFVybE1hdGNoZXIocGF0dGVybik7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5I2lzTWF0Y2hlcgogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpcyBhIFVybE1hdGNoZXIsIG9yIGZhbHNlIG90aGVyd2lzZS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgIFRoZSBvYmplY3QgdG8gcGVyZm9ybSB0aGUgdHlwZSBjaGVjayBhZ2FpbnN0LgogICAqIEByZXR1cm5zIHtCb29sZWFufSAgUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIG9iamVjdCBoYXMgdGhlIGZvbGxvd2luZyBmdW5jdGlvbnM6IGBleGVjYCwgYGZvcm1hdGAsIGFuZCBgY29uY2F0YC4KICAgKi8KICB0aGlzLmlzTWF0Y2hlciA9IGZ1bmN0aW9uIChvKSB7CiAgICByZXR1cm4gaXNPYmplY3QobykgJiYgaXNGdW5jdGlvbihvLmV4ZWMpICYmIGlzRnVuY3Rpb24oby5mb3JtYXQpICYmIGlzRnVuY3Rpb24oby5jb25jYXQpOwogIH07CiAgCiAgLyogTm8gbmVlZCB0byBkb2N1bWVudCAkZ2V0LCBzaW5jZSBpdCByZXR1cm5zIHRoaXMgKi8KICB0aGlzLiRnZXQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpczsKICB9Owp9CgovLyBSZWdpc3RlciBhcyBhIHByb3ZpZGVyIHNvIGl0J3MgYXZhaWxhYmxlIHRvIG90aGVyIHByb3ZpZGVycwphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnV0aWwnKS5wcm92aWRlcignJHVybE1hdGNoZXJGYWN0b3J5JywgJFVybE1hdGNoZXJGYWN0b3J5KTsKCi8qKgogKiBAbmdkb2Mgb2JqZWN0CiAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyCiAqCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnlQcm92aWRlcgogKgogKiBAZGVzY3JpcHRpb24KICogYCR1cmxSb3V0ZXJQcm92aWRlcmAgaGFzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB3YXRjaGluZyBgJGxvY2F0aW9uYC4gCiAqIFdoZW4gYCRsb2NhdGlvbmAgY2hhbmdlcyBpdCBydW5zIHRocm91Z2ggYSBsaXN0IG9mIHJ1bGVzIG9uZSBieSBvbmUgdW50aWwgYSAKICogbWF0Y2ggaXMgZm91bmQuIGAkdXJsUm91dGVyUHJvdmlkZXJgIGlzIHVzZWQgYmVoaW5kIHRoZSBzY2VuZXMgYW55dGltZSB5b3Ugc3BlY2lmeSAKICogYSB1cmwgaW4gYSBzdGF0ZSBjb25maWd1cmF0aW9uLiBBbGwgdXJscyBhcmUgY29tcGlsZWQgaW50byBhIFVybE1hdGNoZXIgb2JqZWN0LgogKgogKiBUaGVyZSBhcmUgc2V2ZXJhbCBtZXRob2RzIG9uIGAkdXJsUm91dGVyUHJvdmlkZXJgIHRoYXQgbWFrZSBpdCB1c2VmdWwgdG8gdXNlIGRpcmVjdGx5CiAqIGluIHlvdXIgbW9kdWxlIGNvbmZpZy4KICovCiRVcmxSb3V0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckdXJsTWF0Y2hlckZhY3RvcnlQcm92aWRlciddOwpmdW5jdGlvbiAkVXJsUm91dGVyUHJvdmlkZXIoICAkdXJsTWF0Y2hlckZhY3RvcnkpIHsKICB2YXIgcnVsZXMgPSBbXSwgCiAgICAgIG90aGVyd2lzZSA9IG51bGw7CgogIC8vIFJldHVybnMgYSBzdHJpbmcgdGhhdCBpcyBhIHByZWZpeCBvZiBhbGwgc3RyaW5ncyBtYXRjaGluZyB0aGUgUmVnRXhwCiAgZnVuY3Rpb24gcmVnRXhwUHJlZml4KHJlKSB7CiAgICB2YXIgcHJlZml4ID0gL15cXigoPzpcXFteYS16QS1aMC05XXxbXlxcXFtcXVxeJCorPy4oKXx7fV0rKSopLy5leGVjKHJlLnNvdXJjZSk7CiAgICByZXR1cm4gKHByZWZpeCAhPSBudWxsKSA/IHByZWZpeFsxXS5yZXBsYWNlKC9cXCguKS9nLCAiJDEiKSA6ICcnOwogIH0KCiAgLy8gSW50ZXJwb2xhdGVzIG1hdGNoZWQgdmFsdWVzIGludG8gYSBTdHJpbmcucmVwbGFjZSgpLXN0eWxlIHBhdHRlcm4KICBmdW5jdGlvbiBpbnRlcnBvbGF0ZShwYXR0ZXJuLCBtYXRjaCkgewogICAgcmV0dXJuIHBhdHRlcm4ucmVwbGFjZSgvXCQoXCR8XGR7MSwyfSkvLCBmdW5jdGlvbiAobSwgd2hhdCkgewogICAgICByZXR1cm4gbWF0Y2hbd2hhdCA9PT0gJyQnID8gMCA6IE51bWJlcih3aGF0KV07CiAgICB9KTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyI3J1bGUKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERlZmluZXMgcnVsZXMgdGhhdCBhcmUgdXNlZCBieSBgJHVybFJvdXRlclByb3ZpZGVyIHRvIGZpbmQgbWF0Y2hlcyBmb3IKICAgKiBzcGVjaWZpYyBVUkxzLgogICAqCiAgICogQGV4YW1wbGUKICAgKiA8cHJlPgogICAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXIucm91dGVyJ10pOwogICAqCiAgICogYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHVybFJvdXRlclByb3ZpZGVyKSB7CiAgICogICAvLyBIZXJlJ3MgYW4gZXhhbXBsZSBvZiBob3cgeW91IG1pZ2h0IGFsbG93IGNhc2UgaW5zZW5zaXRpdmUgdXJscwogICAqICAgJHVybFJvdXRlclByb3ZpZGVyLnJ1bGUoZnVuY3Rpb24gKCRpbmplY3RvciwgJGxvY2F0aW9uKSB7CiAgICogICAgIHZhciBwYXRoID0gJGxvY2F0aW9uLnBhdGgoKSwKICAgKiAgICAgICAgIG5vcm1hbGl6ZWQgPSBwYXRoLnRvTG93ZXJDYXNlKCk7CiAgICoKICAgKiAgICAgaWYgKHBhdGggIT09IG5vcm1hbGl6ZWQpIHsKICAgKiAgICAgICByZXR1cm4gbm9ybWFsaXplZDsKICAgKiAgICAgfQogICAqICAgfSk7CiAgICogfSk7CiAgICogPC9wcmU+CiAgICoKICAgKiBAcGFyYW0ge29iamVjdH0gcnVsZSBIYW5kbGVyIGZ1bmN0aW9uIHRoYXQgdGFrZXMgYCRpbmplY3RvcmAgYW5kIGAkbG9jYXRpb25gCiAgICogc2VydmljZXMgYXMgYXJndW1lbnRzLiBZb3UgY2FuIHVzZSB0aGVtIHRvIHJldHVybiBhIHZhbGlkIHBhdGggYXMgYSBzdHJpbmcuCiAgICoKICAgKiBAcmV0dXJuIHtvYmplY3R9ICR1cmxSb3V0ZXJQcm92aWRlciAtICR1cmxSb3V0ZXJQcm92aWRlciBpbnN0YW5jZQogICAqLwogIHRoaXMucnVsZSA9CiAgICBmdW5jdGlvbiAocnVsZSkgewogICAgICBpZiAoIWlzRnVuY3Rpb24ocnVsZSkpIHRocm93IG5ldyBFcnJvcigiJ3J1bGUnIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICBydWxlcy5wdXNoKHJ1bGUpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlciNvdGhlcndpc2UKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERlZmluZXMgYSBwYXRoIHRoYXQgaXMgdXNlZCB3aGVuIGFuIGludmFsaWVkIHJvdXRlIGlzIHJlcXVlc3RlZC4KICAgKgogICAqIEBleGFtcGxlCiAgICogPHByZT4KICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyLnJvdXRlciddKTsKICAgKgogICAqIGFwcC5jb25maWcoZnVuY3Rpb24gKCR1cmxSb3V0ZXJQcm92aWRlcikgewogICAqICAgLy8gaWYgdGhlIHBhdGggZG9lc24ndCBtYXRjaCBhbnkgb2YgdGhlIHVybHMgeW91IGNvbmZpZ3VyZWQKICAgKiAgIC8vIG90aGVyd2lzZSB3aWxsIHRha2UgY2FyZSBvZiByb3V0aW5nIHRoZSB1c2VyIHRvIHRoZQogICAqICAgLy8gc3BlY2lmaWVkIHVybAogICAqICAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnL2luZGV4Jyk7CiAgICoKICAgKiAgIC8vIEV4YW1wbGUgb2YgdXNpbmcgZnVuY3Rpb24gcnVsZSBhcyBwYXJhbQogICAqICAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZShmdW5jdGlvbiAoJGluamVjdG9yLCAkbG9jYXRpb24pIHsKICAgKiAgICAgLi4uCiAgICogICB9KTsKICAgKiB9KTsKICAgKiA8L3ByZT4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gcnVsZSBUaGUgdXJsIHBhdGggeW91IHdhbnQgdG8gcmVkaXJlY3QgdG8gb3IgYSBmdW5jdGlvbiAKICAgKiBydWxlIHRoYXQgcmV0dXJucyB0aGUgdXJsIHBhdGguIFRoZSBmdW5jdGlvbiB2ZXJzaW9uIGlzIHBhc3NlZCB0d28gcGFyYW1zOiAKICAgKiBgJGluamVjdG9yYCBhbmQgYCRsb2NhdGlvbmAgc2VydmljZXMuCiAgICoKICAgKiBAcmV0dXJuIHtvYmplY3R9ICR1cmxSb3V0ZXJQcm92aWRlciAtICR1cmxSb3V0ZXJQcm92aWRlciBpbnN0YW5jZQogICAqLwogIHRoaXMub3RoZXJ3aXNlID0KICAgIGZ1bmN0aW9uIChydWxlKSB7CiAgICAgIGlmIChpc1N0cmluZyhydWxlKSkgewogICAgICAgIHZhciByZWRpcmVjdCA9IHJ1bGU7CiAgICAgICAgcnVsZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHJlZGlyZWN0OyB9OwogICAgICB9CiAgICAgIGVsc2UgaWYgKCFpc0Z1bmN0aW9uKHJ1bGUpKSB0aHJvdyBuZXcgRXJyb3IoIidydWxlJyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgb3RoZXJ3aXNlID0gcnVsZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKCiAgZnVuY3Rpb24gaGFuZGxlSWZNYXRjaCgkaW5qZWN0b3IsIGhhbmRsZXIsIG1hdGNoKSB7CiAgICBpZiAoIW1hdGNoKSByZXR1cm4gZmFsc2U7CiAgICB2YXIgcmVzdWx0ID0gJGluamVjdG9yLmludm9rZShoYW5kbGVyLCBoYW5kbGVyLCB7ICRtYXRjaDogbWF0Y2ggfSk7CiAgICByZXR1cm4gaXNEZWZpbmVkKHJlc3VsdCkgPyByZXN1bHQgOiB0cnVlOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIjd2hlbgogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVnaXN0ZXJzIGEgaGFuZGxlciBmb3IgYSBnaXZlbiB1cmwgbWF0Y2hpbmcuIGlmIGhhbmRsZSBpcyBhIHN0cmluZywgaXQgaXMKICAgKiB0cmVhdGVkIGFzIGEgcmVkaXJlY3QsIGFuZCBpcyBpbnRlcnBvbGF0ZWQgYWNjb3JkaW5nIHRvIHRoZSBzeXludGF4IG9mIG1hdGNoCiAgICogKGkuZS4gbGlrZSBTdHJpbmcucmVwbGFjZSgpIGZvciBSZWdFeHAsIG9yIGxpa2UgYSBVcmxNYXRjaGVyIHBhdHRlcm4gb3RoZXJ3aXNlKS4KICAgKgogICAqIElmIHRoZSBoYW5kbGVyIGlzIGEgZnVuY3Rpb24sIGl0IGlzIGluamVjdGFibGUuIEl0IGdldHMgaW52b2tlZCBpZiBgJGxvY2F0aW9uYAogICAqIG1hdGNoZXMuIFlvdSBoYXZlIHRoZSBvcHRpb24gb2YgaW5qZWN0IHRoZSBtYXRjaCBvYmplY3QgYXMgYCRtYXRjaGAuCiAgICoKICAgKiBUaGUgaGFuZGxlciBjYW4gcmV0dXJuCiAgICoKICAgKiAtICoqZmFsc3kqKiB0byBpbmRpY2F0ZSB0aGF0IHRoZSBydWxlIGRpZG4ndCBtYXRjaCBhZnRlciBhbGwsIHRoZW4gYCR1cmxSb3V0ZXJgCiAgICogICB3aWxsIGNvbnRpbnVlIHRyeWluZyB0byBmaW5kIGFub3RoZXIgb25lIHRoYXQgbWF0Y2hlcy4KICAgKiAtICoqc3RyaW5nKiogd2hpY2ggaXMgdHJlYXRlZCBhcyBhIHJlZGlyZWN0IGFuZCBwYXNzZWQgdG8gYCRsb2NhdGlvbi51cmwoKWAKICAgKiAtICoqdm9pZCoqIG9yIGFueSAqKnRydXRoeSoqIHZhbHVlIHRlbGxzIGAkdXJsUm91dGVyYCB0aGF0IHRoZSB1cmwgd2FzIGhhbmRsZWQuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIDxwcmU+CiAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlci5yb3V0ZXInXSk7CiAgICoKICAgKiBhcHAuY29uZmlnKGZ1bmN0aW9uICgkdXJsUm91dGVyUHJvdmlkZXIpIHsKICAgKiAgICR1cmxSb3V0ZXJQcm92aWRlci53aGVuKCRzdGF0ZS51cmwsIGZ1bmN0aW9uICgkbWF0Y2gsICRzdGF0ZVBhcmFtcykgewogICAqICAgICBpZiAoJHN0YXRlLiRjdXJyZW50Lm5hdmlnYWJsZSAhPT0gc3RhdGUgfHwKICAgKiAgICAgICAgICFlcXVhbEZvcktleXMoJG1hdGNoLCAkc3RhdGVQYXJhbXMpIHsKICAgKiAgICAgICRzdGF0ZS50cmFuc2l0aW9uVG8oc3RhdGUsICRtYXRjaCwgZmFsc2UpOwogICAqICAgICB9CiAgICogICB9KTsKICAgKiB9KTsKICAgKiA8L3ByZT4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gd2hhdCBUaGUgaW5jb21pbmcgcGF0aCB0aGF0IHlvdSB3YW50IHRvIHJlZGlyZWN0LgogICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gaGFuZGxlciBUaGUgcGF0aCB5b3Ugd2FudCB0byByZWRpcmVjdCB5b3VyIHVzZXIgdG8uCiAgICovCiAgdGhpcy53aGVuID0KICAgIGZ1bmN0aW9uICh3aGF0LCBoYW5kbGVyKSB7CiAgICAgIHZhciByZWRpcmVjdCwgaGFuZGxlcklzU3RyaW5nID0gaXNTdHJpbmcoaGFuZGxlcik7CiAgICAgIGlmIChpc1N0cmluZyh3aGF0KSkgd2hhdCA9ICR1cmxNYXRjaGVyRmFjdG9yeS5jb21waWxlKHdoYXQpOwoKICAgICAgaWYgKCFoYW5kbGVySXNTdHJpbmcgJiYgIWlzRnVuY3Rpb24oaGFuZGxlcikgJiYgIWlzQXJyYXkoaGFuZGxlcikpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkICdoYW5kbGVyJyBpbiB3aGVuKCkiKTsKCiAgICAgIHZhciBzdHJhdGVnaWVzID0gewogICAgICAgIG1hdGNoZXI6IGZ1bmN0aW9uICh3aGF0LCBoYW5kbGVyKSB7CiAgICAgICAgICBpZiAoaGFuZGxlcklzU3RyaW5nKSB7CiAgICAgICAgICAgIHJlZGlyZWN0ID0gJHVybE1hdGNoZXJGYWN0b3J5LmNvbXBpbGUoaGFuZGxlcik7CiAgICAgICAgICAgIGhhbmRsZXIgPSBbJyRtYXRjaCcsIGZ1bmN0aW9uICgkbWF0Y2gpIHsgcmV0dXJuIHJlZGlyZWN0LmZvcm1hdCgkbWF0Y2gpOyB9XTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKCRpbmplY3RvciwgJGxvY2F0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVJZk1hdGNoKCRpbmplY3RvciwgaGFuZGxlciwgd2hhdC5leGVjKCRsb2NhdGlvbi5wYXRoKCksICRsb2NhdGlvbi5zZWFyY2goKSkpOwogICAgICAgICAgfSwgewogICAgICAgICAgICBwcmVmaXg6IGlzU3RyaW5nKHdoYXQucHJlZml4KSA/IHdoYXQucHJlZml4IDogJycKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgcmVnZXg6IGZ1bmN0aW9uICh3aGF0LCBoYW5kbGVyKSB7CiAgICAgICAgICBpZiAod2hhdC5nbG9iYWwgfHwgd2hhdC5zdGlja3kpIHRocm93IG5ldyBFcnJvcigid2hlbigpIFJlZ0V4cCBtdXN0IG5vdCBiZSBnbG9iYWwgb3Igc3RpY2t5Iik7CgogICAgICAgICAgaWYgKGhhbmRsZXJJc1N0cmluZykgewogICAgICAgICAgICByZWRpcmVjdCA9IGhhbmRsZXI7CiAgICAgICAgICAgIGhhbmRsZXIgPSBbJyRtYXRjaCcsIGZ1bmN0aW9uICgkbWF0Y2gpIHsgcmV0dXJuIGludGVycG9sYXRlKHJlZGlyZWN0LCAkbWF0Y2gpOyB9XTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKCRpbmplY3RvciwgJGxvY2F0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVJZk1hdGNoKCRpbmplY3RvciwgaGFuZGxlciwgd2hhdC5leGVjKCRsb2NhdGlvbi5wYXRoKCkpKTsKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgcHJlZml4OiByZWdFeHBQcmVmaXgod2hhdCkKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciBjaGVjayA9IHsgbWF0Y2hlcjogJHVybE1hdGNoZXJGYWN0b3J5LmlzTWF0Y2hlcih3aGF0KSwgcmVnZXg6IHdoYXQgaW5zdGFuY2VvZiBSZWdFeHAgfTsKCiAgICAgIGZvciAodmFyIG4gaW4gY2hlY2spIHsKICAgICAgICBpZiAoY2hlY2tbbl0pIHsKICAgICAgICAgIHJldHVybiB0aGlzLnJ1bGUoc3RyYXRlZ2llc1tuXSh3aGF0LCBoYW5kbGVyKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgJ3doYXQnIGluIHdoZW4oKSIpOwogICAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlcgogICAqCiAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKi8KICB0aGlzLiRnZXQgPQogICAgWyAgICAgICAgJyRsb2NhdGlvbicsICckcm9vdFNjb3BlJywgJyRpbmplY3RvcicsCiAgICBmdW5jdGlvbiAoJGxvY2F0aW9uLCAgICRyb290U2NvcGUsICAgJGluamVjdG9yKSB7CiAgICAgIC8vIFRPRE86IE9wdGltaXplIGdyb3VwcyBvZiBydWxlcyB3aXRoIG5vbi1lbXB0eSBwcmVmaXggaW50byBzb21lIHNvcnQgb2YgZGVjaXNpb24gdHJlZQogICAgICBmdW5jdGlvbiB1cGRhdGUoZXZ0KSB7CiAgICAgICAgaWYgKGV2dCAmJiBldnQuZGVmYXVsdFByZXZlbnRlZCkgcmV0dXJuOwogICAgICAgIGZ1bmN0aW9uIGNoZWNrKHJ1bGUpIHsKICAgICAgICAgIHZhciBoYW5kbGVkID0gcnVsZSgkaW5qZWN0b3IsICRsb2NhdGlvbik7CiAgICAgICAgICBpZiAoaGFuZGxlZCkgewogICAgICAgICAgICBpZiAoaXNTdHJpbmcoaGFuZGxlZCkpICRsb2NhdGlvbi5yZXBsYWNlKCkudXJsKGhhbmRsZWQpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIG49cnVsZXMubGVuZ3RoLCBpOwogICAgICAgIGZvciAoaT0wOyBpPG47IGkrKykgewogICAgICAgICAgaWYgKGNoZWNrKHJ1bGVzW2ldKSkgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBhbHdheXMgY2hlY2sgb3RoZXJ3aXNlIGxhc3QgdG8gYWxsb3cgZHluYW1pYyB1cGRhdGVzIHRvIHRoZSBzZXQgb2YgcnVsZXMKICAgICAgICBpZiAob3RoZXJ3aXNlKSBjaGVjayhvdGhlcndpc2UpOwogICAgICB9CgogICAgICAkcm9vdFNjb3BlLiRvbignJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZSk7CgogICAgICByZXR1cm4gewogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlciNzeW5jCiAgICAgICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVHJpZ2dlcnMgYW4gdXBkYXRlOyB0aGUgc2FtZSB1cGRhdGUgdGhhdCBoYXBwZW5zIHdoZW4gdGhlIGFkZHJlc3MgYmFyIHVybCBjaGFuZ2VzLCBha2EgYCRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3NgLgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIHVzZWZ1bCB3aGVuIHlvdSBuZWVkIHRvIHVzZSBgcHJldmVudERlZmF1bHQoKWAgb24gdGhlIGAkbG9jYXRpb25DaGFuZ2VTdWNjZXNzYCBldmVudCwgCiAgICAgICAgICogcGVyZm9ybSBzb21lIGN1c3RvbSBsb2dpYyAocm91dGUgcHJvdGVjdGlvbiwgYXV0aCwgY29uZmlnLCByZWRpcmVjdGlvbiwgZXRjKSBhbmQgdGhlbiBmaW5hbGx5IHByb2NlZWQgCiAgICAgICAgICogd2l0aCB0aGUgdHJhbnNpdGlvbiBieSBjYWxsaW5nIGAkdXJsUm91dGVyLnN5bmMoKWAuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAqIDxwcmU+CiAgICAgICAgICogYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyJ10pOwogICAgICAgICAqICAgLnJ1bihmdW5jdGlvbigkcm9vdFNjb3BlLCAkdXJsUm91dGVyKSB7CiAgICAgICAgICogICAgICRyb290U2NvcGUuJG9uKCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICogICAgICAgLy8gSGFsdCBzdGF0ZSBjaGFuZ2UgZnJvbSBldmVuIHN0YXJ0aW5nCiAgICAgICAgICogICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICogICAgICAgLy8gUGVyZm9ybSBjdXN0b20gbG9naWMKICAgICAgICAgKiAgICAgICB2YXIgbWVldHNSZXF1aXJlbWVudCA9IC4uLgogICAgICAgICAqICAgICAgIC8vIENvbnRpbnVlIHdpdGggdGhlIHVwZGF0ZSBhbmQgc3RhdGUgdHJhbnNpdGlvbiBpZiBsb2dpYyBhbGxvd3MKICAgICAgICAgKiAgICAgICBpZiAobWVldHNSZXF1aXJlbWVudCkgJHVybFJvdXRlci5zeW5jKCk7CiAgICAgICAgICogICAgIH0pOwogICAgICAgICAqIH0pOwogICAgICAgICAqIDwvcHJlPgogICAgICAgICAqLwogICAgICAgIHN5bmM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHVwZGF0ZSgpOwogICAgICAgIH0KICAgICAgfTsKICAgIH1dOwp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnJvdXRlcicpLnByb3ZpZGVyKCckdXJsUm91dGVyJywgJFVybFJvdXRlclByb3ZpZGVyKTsKCi8qKgogKiBAbmdkb2Mgb2JqZWN0CiAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlcgogKgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIKICogQHJlcXVpcmVzIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyCiAqIEByZXF1aXJlcyAkbG9jYXRpb25Qcm92aWRlcgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIG5ldyBgJHN0YXRlUHJvdmlkZXJgIHdvcmtzIHNpbWlsYXIgdG8gQW5ndWxhcidzIHYxIHJvdXRlciwgYnV0IGl0IGZvY3VzZXMgcHVyZWx5CiAqIG9uIHN0YXRlLgogKgogKiBBIHN0YXRlIGNvcnJlc3BvbmRzIHRvIGEgInBsYWNlIiBpbiB0aGUgYXBwbGljYXRpb24gaW4gdGVybXMgb2YgdGhlIG92ZXJhbGwgVUkgYW5kCiAqIG5hdmlnYXRpb24uIEEgc3RhdGUgZGVzY3JpYmVzICh2aWEgdGhlIGNvbnRyb2xsZXIgLyB0ZW1wbGF0ZSAvIHZpZXcgcHJvcGVydGllcykgd2hhdAogKiB0aGUgVUkgbG9va3MgbGlrZSBhbmQgZG9lcyBhdCB0aGF0IHBsYWNlLgogKgogKiBTdGF0ZXMgb2Z0ZW4gaGF2ZSB0aGluZ3MgaW4gY29tbW9uLCBhbmQgdGhlIHByaW1hcnkgd2F5IG9mIGZhY3RvcmluZyBvdXQgdGhlc2UKICogY29tbW9uYWxpdGllcyBpbiB0aGlzIG1vZGVsIGlzIHZpYSB0aGUgc3RhdGUgaGllcmFyY2h5LCBpLmUuIHBhcmVudC9jaGlsZCBzdGF0ZXMgYWthCiAqIG5lc3RlZCBzdGF0ZXMuCiAqCiAqIFRoZSBgJHN0YXRlUHJvdmlkZXJgIHByb3ZpZGVzIGludGVyZmFjZXMgdG8gZGVjbGFyZSB0aGVzZSBzdGF0ZXMgZm9yIHlvdXIgYXBwLgogKi8KJFN0YXRlUHJvdmlkZXIuJGluamVjdCA9IFsnJHVybFJvdXRlclByb3ZpZGVyJywgJyR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyJywgJyRsb2NhdGlvblByb3ZpZGVyJ107CmZ1bmN0aW9uICRTdGF0ZVByb3ZpZGVyKCAgICR1cmxSb3V0ZXJQcm92aWRlciwgICAkdXJsTWF0Y2hlckZhY3RvcnksICAgICAgICAgICAkbG9jYXRpb25Qcm92aWRlcikgewoKICB2YXIgcm9vdCwgc3RhdGVzID0ge30sICRzdGF0ZSwgcXVldWUgPSB7fSwgYWJzdHJhY3RLZXkgPSAnYWJzdHJhY3QnOwoKICAvLyBCdWlsZHMgc3RhdGUgcHJvcGVydGllcyBmcm9tIGRlZmluaXRpb24gcGFzc2VkIHRvIHJlZ2lzdGVyU3RhdGUoKQogIHZhciBzdGF0ZUJ1aWxkZXIgPSB7CgogICAgLy8gRGVyaXZlIHBhcmVudCBzdGF0ZSBmcm9tIGEgaGllcmFyY2hpY2FsIG5hbWUgb25seSBpZiAncGFyZW50JyBpcyBub3QgZXhwbGljaXRseSBkZWZpbmVkLgogICAgLy8gc3RhdGUuY2hpbGRyZW4gPSBbXTsKICAgIC8vIGlmIChwYXJlbnQpIHBhcmVudC5jaGlsZHJlbi5wdXNoKHN0YXRlKTsKICAgIHBhcmVudDogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgaWYgKGlzRGVmaW5lZChzdGF0ZS5wYXJlbnQpICYmIHN0YXRlLnBhcmVudCkgcmV0dXJuIGZpbmRTdGF0ZShzdGF0ZS5wYXJlbnQpOwogICAgICAvLyByZWdleCBtYXRjaGVzIGFueSB2YWxpZCBjb21wb3NpdGUgc3RhdGUgbmFtZQogICAgICAvLyB3b3VsZCBtYXRjaCAiY29udGFjdC5saXN0IiBidXQgbm90ICJjb250YWN0cyIKICAgICAgdmFyIGNvbXBvc2l0ZU5hbWUgPSAvXiguKylcLlteLl0rJC8uZXhlYyhzdGF0ZS5uYW1lKTsKICAgICAgcmV0dXJuIGNvbXBvc2l0ZU5hbWUgPyBmaW5kU3RhdGUoY29tcG9zaXRlTmFtZVsxXSkgOiByb290OwogICAgfSwKCiAgICAvLyBpbmhlcml0ICdkYXRhJyBmcm9tIHBhcmVudCBhbmQgb3ZlcnJpZGUgYnkgb3duIHZhbHVlcyAoaWYgYW55KQogICAgZGF0YTogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgaWYgKHN0YXRlLnBhcmVudCAmJiBzdGF0ZS5wYXJlbnQuZGF0YSkgewogICAgICAgIHN0YXRlLmRhdGEgPSBzdGF0ZS5zZWxmLmRhdGEgPSBleHRlbmQoe30sIHN0YXRlLnBhcmVudC5kYXRhLCBzdGF0ZS5kYXRhKTsKICAgICAgfQogICAgICByZXR1cm4gc3RhdGUuZGF0YTsKICAgIH0sCgogICAgLy8gQnVpbGQgYSBVUkxNYXRjaGVyIGlmIG5lY2Vzc2FyeSwgZWl0aGVyIHZpYSBhIHJlbGF0aXZlIG9yIGFic29sdXRlIFVSTAogICAgdXJsOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICB2YXIgdXJsID0gc3RhdGUudXJsOwoKICAgICAgaWYgKGlzU3RyaW5nKHVybCkpIHsKICAgICAgICBpZiAodXJsLmNoYXJBdCgwKSA9PSAnXicpIHsKICAgICAgICAgIHJldHVybiAkdXJsTWF0Y2hlckZhY3RvcnkuY29tcGlsZSh1cmwuc3Vic3RyaW5nKDEpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChzdGF0ZS5wYXJlbnQubmF2aWdhYmxlIHx8IHJvb3QpLnVybC5jb25jYXQodXJsKTsKICAgICAgfQoKICAgICAgaWYgKCR1cmxNYXRjaGVyRmFjdG9yeS5pc01hdGNoZXIodXJsKSB8fCB1cmwgPT0gbnVsbCkgewogICAgICAgIHJldHVybiB1cmw7CiAgICAgIH0KICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHVybCAnIiArIHVybCArICInIGluIHN0YXRlICciICsgc3RhdGUgKyAiJyIpOwogICAgfSwKCiAgICAvLyBLZWVwIHRyYWNrIG9mIHRoZSBjbG9zZXN0IGFuY2VzdG9yIHN0YXRlIHRoYXQgaGFzIGEgVVJMIChpLmUuIGlzIG5hdmlnYWJsZSkKICAgIG5hdmlnYWJsZTogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgcmV0dXJuIHN0YXRlLnVybCA/IHN0YXRlIDogKHN0YXRlLnBhcmVudCA/IHN0YXRlLnBhcmVudC5uYXZpZ2FibGUgOiBudWxsKTsKICAgIH0sCgogICAgLy8gRGVyaXZlIHBhcmFtZXRlcnMgZm9yIHRoaXMgc3RhdGUgYW5kIGVuc3VyZSB0aGV5J3JlIGEgc3VwZXItc2V0IG9mIHBhcmVudCdzIHBhcmFtZXRlcnMKICAgIHBhcmFtczogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgaWYgKCFzdGF0ZS5wYXJhbXMpIHsKICAgICAgICByZXR1cm4gc3RhdGUudXJsID8gc3RhdGUudXJsLnBhcmFtZXRlcnMoKSA6IHN0YXRlLnBhcmVudC5wYXJhbXM7CiAgICAgIH0KICAgICAgaWYgKCFpc0FycmF5KHN0YXRlLnBhcmFtcykpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbXMgaW4gc3RhdGUgJyIgKyBzdGF0ZSArICInIik7CiAgICAgIGlmIChzdGF0ZS51cmwpIHRocm93IG5ldyBFcnJvcigiQm90aCBwYXJhbXMgYW5kIHVybCBzcGVjaWNpZmllZCBpbiBzdGF0ZSAnIiArIHN0YXRlICsgIiciKTsKICAgICAgcmV0dXJuIHN0YXRlLnBhcmFtczsKICAgIH0sCgogICAgLy8gSWYgdGhlcmUgaXMgbm8gZXhwbGljaXQgbXVsdGktdmlldyBjb25maWd1cmF0aW9uLCBtYWtlIG9uZSB1cCBzbyB3ZSBkb24ndCBoYXZlCiAgICAvLyB0byBoYW5kbGUgYm90aCBjYXNlcyBpbiB0aGUgdmlldyBkaXJlY3RpdmUgbGF0ZXIuIE5vdGUgdGhhdCBoYXZpbmcgYW4gZXhwbGljaXQKICAgIC8vICd2aWV3cycgcHJvcGVydHkgd2lsbCBtZWFuIHRoZSBkZWZhdWx0IHVubmFtZWQgdmlldyBwcm9wZXJ0aWVzIGFyZSBpZ25vcmVkLiBUaGlzCiAgICAvLyBpcyBhbHNvIGEgZ29vZCB0aW1lIHRvIHJlc29sdmUgdmlldyBuYW1lcyB0byBhYnNvbHV0ZSBuYW1lcywgc28gZXZlcnl0aGluZyBpcyBhCiAgICAvLyBzdHJhaWdodCBsb29rdXAgYXQgbGluayB0aW1lLgogICAgdmlld3M6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgIHZhciB2aWV3cyA9IHt9OwoKICAgICAgZm9yRWFjaChpc0RlZmluZWQoc3RhdGUudmlld3MpID8gc3RhdGUudmlld3MgOiB7ICcnOiBzdGF0ZSB9LCBmdW5jdGlvbiAodmlldywgbmFtZSkgewogICAgICAgIGlmIChuYW1lLmluZGV4T2YoJ0AnKSA8IDApIG5hbWUgKz0gJ0AnICsgc3RhdGUucGFyZW50Lm5hbWU7CiAgICAgICAgdmlld3NbbmFtZV0gPSB2aWV3OwogICAgICB9KTsKICAgICAgcmV0dXJuIHZpZXdzOwogICAgfSwKCiAgICBvd25QYXJhbXM6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgIGlmICghc3RhdGUucGFyZW50KSB7CiAgICAgICAgcmV0dXJuIHN0YXRlLnBhcmFtczsKICAgICAgfQogICAgICB2YXIgcGFyYW1OYW1lcyA9IHt9OyBmb3JFYWNoKHN0YXRlLnBhcmFtcywgZnVuY3Rpb24gKHApIHsgcGFyYW1OYW1lc1twXSA9IHRydWU7IH0pOwoKICAgICAgZm9yRWFjaChzdGF0ZS5wYXJlbnQucGFyYW1zLCBmdW5jdGlvbiAocCkgewogICAgICAgIGlmICghcGFyYW1OYW1lc1twXSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIHJlcXVpcmVkIHBhcmFtZXRlciAnIiArIHAgKyAiJyBpbiBzdGF0ZSAnIiArIHN0YXRlLm5hbWUgKyAiJyIpOwogICAgICAgIH0KICAgICAgICBwYXJhbU5hbWVzW3BdID0gZmFsc2U7CiAgICAgIH0pOwogICAgICB2YXIgb3duUGFyYW1zID0gW107CgogICAgICBmb3JFYWNoKHBhcmFtTmFtZXMsIGZ1bmN0aW9uIChvd24sIHApIHsKICAgICAgICBpZiAob3duKSBvd25QYXJhbXMucHVzaChwKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBvd25QYXJhbXM7CiAgICB9LAoKICAgIC8vIEtlZXAgYSBmdWxsIHBhdGggZnJvbSB0aGUgcm9vdCBkb3duIHRvIHRoaXMgc3RhdGUgYXMgdGhpcyBpcyBuZWVkZWQgZm9yIHN0YXRlIGFjdGl2YXRpb24uCiAgICBwYXRoOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICByZXR1cm4gc3RhdGUucGFyZW50ID8gc3RhdGUucGFyZW50LnBhdGguY29uY2F0KHN0YXRlKSA6IFtdOyAvLyBleGNsdWRlIHJvb3QgZnJvbSBwYXRoCiAgICB9LAoKICAgIC8vIFNwZWVkIHVwICRzdGF0ZS5jb250YWlucygpIGFzIGl0J3MgdXNlZCBhIGxvdAogICAgaW5jbHVkZXM6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgIHZhciBpbmNsdWRlcyA9IHN0YXRlLnBhcmVudCA/IGV4dGVuZCh7fSwgc3RhdGUucGFyZW50LmluY2x1ZGVzKSA6IHt9OwogICAgICBpbmNsdWRlc1tzdGF0ZS5uYW1lXSA9IHRydWU7CiAgICAgIHJldHVybiBpbmNsdWRlczsKICAgIH0sCgogICAgJGRlbGVnYXRlczoge30KICB9OwoKICBmdW5jdGlvbiBpc1JlbGF0aXZlKHN0YXRlTmFtZSkgewogICAgcmV0dXJuIHN0YXRlTmFtZS5pbmRleE9mKCIuIikgPT09IDAgfHwgc3RhdGVOYW1lLmluZGV4T2YoIl4iKSA9PT0gMDsKICB9CgogIGZ1bmN0aW9uIGZpbmRTdGF0ZShzdGF0ZU9yTmFtZSwgYmFzZSkgewogICAgdmFyIGlzU3RyID0gaXNTdHJpbmcoc3RhdGVPck5hbWUpLAogICAgICAgIG5hbWUgID0gaXNTdHIgPyBzdGF0ZU9yTmFtZSA6IHN0YXRlT3JOYW1lLm5hbWUsCiAgICAgICAgcGF0aCAgPSBpc1JlbGF0aXZlKG5hbWUpOwoKICAgIGlmIChwYXRoKSB7CiAgICAgIGlmICghYmFzZSkgdGhyb3cgbmV3IEVycm9yKCJObyByZWZlcmVuY2UgcG9pbnQgZ2l2ZW4gZm9yIHBhdGggJyIgICsgbmFtZSArICInIik7CiAgICAgIHZhciByZWwgPSBuYW1lLnNwbGl0KCIuIiksIGkgPSAwLCBwYXRoTGVuZ3RoID0gcmVsLmxlbmd0aCwgY3VycmVudCA9IGJhc2U7CgogICAgICBmb3IgKDsgaSA8IHBhdGhMZW5ndGg7IGkrKykgewogICAgICAgIGlmIChyZWxbaV0gPT09ICIiICYmIGkgPT09IDApIHsKICAgICAgICAgIGN1cnJlbnQgPSBiYXNlOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChyZWxbaV0gPT09ICJeIikgewogICAgICAgICAgaWYgKCFjdXJyZW50LnBhcmVudCkgdGhyb3cgbmV3IEVycm9yKCJQYXRoICciICsgbmFtZSArICInIG5vdCB2YWxpZCBmb3Igc3RhdGUgJyIgKyBiYXNlLm5hbWUgKyAiJyIpOwogICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50OwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJlbCA9IHJlbC5zbGljZShpKS5qb2luKCIuIik7CiAgICAgIG5hbWUgPSBjdXJyZW50Lm5hbWUgKyAoY3VycmVudC5uYW1lICYmIHJlbCA/ICIuIiA6ICIiKSArIHJlbDsKICAgIH0KICAgIHZhciBzdGF0ZSA9IHN0YXRlc1tuYW1lXTsKCiAgICBpZiAoc3RhdGUgJiYgKGlzU3RyIHx8ICghaXNTdHIgJiYgKHN0YXRlID09PSBzdGF0ZU9yTmFtZSB8fCBzdGF0ZS5zZWxmID09PSBzdGF0ZU9yTmFtZSkpKSkgewogICAgICByZXR1cm4gc3RhdGU7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH0KCiAgZnVuY3Rpb24gcXVldWVTdGF0ZShwYXJlbnROYW1lLCBzdGF0ZSkgewogICAgaWYgKCFxdWV1ZVtwYXJlbnROYW1lXSkgewogICAgICBxdWV1ZVtwYXJlbnROYW1lXSA9IFtdOwogICAgfQogICAgcXVldWVbcGFyZW50TmFtZV0ucHVzaChzdGF0ZSk7CiAgfQoKICBmdW5jdGlvbiByZWdpc3RlclN0YXRlKHN0YXRlKSB7CiAgICAvLyBXcmFwIGEgbmV3IG9iamVjdCBhcm91bmQgdGhlIHN0YXRlIHNvIHdlIGNhbiBzdG9yZSBvdXIgcHJpdmF0ZSBkZXRhaWxzIGVhc2lseS4KICAgIHN0YXRlID0gaW5oZXJpdChzdGF0ZSwgewogICAgICBzZWxmOiBzdGF0ZSwKICAgICAgcmVzb2x2ZTogc3RhdGUucmVzb2x2ZSB8fCB7fSwKICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5uYW1lOyB9CiAgICB9KTsKCiAgICB2YXIgbmFtZSA9IHN0YXRlLm5hbWU7CiAgICBpZiAoIWlzU3RyaW5nKG5hbWUpIHx8IG5hbWUuaW5kZXhPZignQCcpID49IDApIHRocm93IG5ldyBFcnJvcigiU3RhdGUgbXVzdCBoYXZlIGEgdmFsaWQgbmFtZSIpOwogICAgaWYgKHN0YXRlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgdGhyb3cgbmV3IEVycm9yKCJTdGF0ZSAnIiArIG5hbWUgKyAiJycgaXMgYWxyZWFkeSBkZWZpbmVkIik7CgogICAgLy8gR2V0IHBhcmVudCBuYW1lCiAgICB2YXIgcGFyZW50TmFtZSA9IChuYW1lLmluZGV4T2YoJy4nKSAhPT0gLTEpID8gbmFtZS5zdWJzdHJpbmcoMCwgbmFtZS5sYXN0SW5kZXhPZignLicpKQogICAgICAgIDogKGlzU3RyaW5nKHN0YXRlLnBhcmVudCkpID8gc3RhdGUucGFyZW50CiAgICAgICAgOiAnJzsKCiAgICAvLyBJZiBwYXJlbnQgaXMgbm90IHJlZ2lzdGVyZWQgeWV0LCBhZGQgc3RhdGUgdG8gcXVldWUgYW5kIHJlZ2lzdGVyIGxhdGVyCiAgICBpZiAocGFyZW50TmFtZSAmJiAhc3RhdGVzW3BhcmVudE5hbWVdKSB7CiAgICAgIHJldHVybiBxdWV1ZVN0YXRlKHBhcmVudE5hbWUsIHN0YXRlLnNlbGYpOwogICAgfQoKICAgIGZvciAodmFyIGtleSBpbiBzdGF0ZUJ1aWxkZXIpIHsKICAgICAgaWYgKGlzRnVuY3Rpb24oc3RhdGVCdWlsZGVyW2tleV0pKSBzdGF0ZVtrZXldID0gc3RhdGVCdWlsZGVyW2tleV0oc3RhdGUsIHN0YXRlQnVpbGRlci4kZGVsZWdhdGVzW2tleV0pOwogICAgfQogICAgc3RhdGVzW25hbWVdID0gc3RhdGU7CgogICAgLy8gUmVnaXN0ZXIgdGhlIHN0YXRlIGluIHRoZSBnbG9iYWwgc3RhdGUgbGlzdCBhbmQgd2l0aCAkdXJsUm91dGVyIGlmIG5lY2Vzc2FyeS4KICAgIGlmICghc3RhdGVbYWJzdHJhY3RLZXldICYmIHN0YXRlLnVybCkgewogICAgICAkdXJsUm91dGVyUHJvdmlkZXIud2hlbihzdGF0ZS51cmwsIFsnJG1hdGNoJywgJyRzdGF0ZVBhcmFtcycsIGZ1bmN0aW9uICgkbWF0Y2gsICRzdGF0ZVBhcmFtcykgewogICAgICAgIGlmICgkc3RhdGUuJGN1cnJlbnQubmF2aWdhYmxlICE9IHN0YXRlIHx8ICFlcXVhbEZvcktleXMoJG1hdGNoLCAkc3RhdGVQYXJhbXMpKSB7CiAgICAgICAgICAkc3RhdGUudHJhbnNpdGlvblRvKHN0YXRlLCAkbWF0Y2gsIHsgbG9jYXRpb246IGZhbHNlIH0pOwogICAgICAgIH0KICAgICAgfV0pOwogICAgfQoKICAgIC8vIFJlZ2lzdGVyIGFueSBxdWV1ZWQgY2hpbGRyZW4KICAgIGlmIChxdWV1ZVtuYW1lXSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlW25hbWVdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVnaXN0ZXJTdGF0ZShxdWV1ZVtuYW1lXVtpXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gc3RhdGU7CiAgfQoKICAvLyBDaGVja3MgdGV4dCB0byBzZWUgaWYgaXQgbG9va3MgbGlrZSBhIGdsb2IuCiAgZnVuY3Rpb24gaXNHbG9iICh0ZXh0KSB7CiAgICByZXR1cm4gdGV4dC5pbmRleE9mKCcqJykgPiAtMTsKICB9CgogIC8vIFJldHVybnMgdHJ1ZSBpZiBnbG9iIG1hdGNoZXMgY3VycmVudCAkc3RhdGUgbmFtZS4KICBmdW5jdGlvbiBkb2VzU3RhdGVNYXRjaEdsb2IgKGdsb2IpIHsKICAgIHZhciBnbG9iU2VnbWVudHMgPSBnbG9iLnNwbGl0KCcuJyksCiAgICAgICAgc2VnbWVudHMgPSAkc3RhdGUuJGN1cnJlbnQubmFtZS5zcGxpdCgnLicpOwoKICAgIC8vbWF0Y2ggZ3JlZWR5IHN0YXJ0cwogICAgaWYgKGdsb2JTZWdtZW50c1swXSA9PT0gJyoqJykgewogICAgICAgc2VnbWVudHMgPSBzZWdtZW50cy5zbGljZShzZWdtZW50cy5pbmRleE9mKGdsb2JTZWdtZW50c1sxXSkpOwogICAgICAgc2VnbWVudHMudW5zaGlmdCgnKionKTsKICAgIH0KICAgIC8vbWF0Y2ggZ3JlZWR5IGVuZHMKICAgIGlmIChnbG9iU2VnbWVudHNbZ2xvYlNlZ21lbnRzLmxlbmd0aCAtIDFdID09PSAnKionKSB7CiAgICAgICBzZWdtZW50cy5zcGxpY2Uoc2VnbWVudHMuaW5kZXhPZihnbG9iU2VnbWVudHNbZ2xvYlNlZ21lbnRzLmxlbmd0aCAtIDJdKSArIDEsIE51bWJlci5NQVhfVkFMVUUpOwogICAgICAgc2VnbWVudHMucHVzaCgnKionKTsKICAgIH0KCiAgICBpZiAoZ2xvYlNlZ21lbnRzLmxlbmd0aCAhPSBzZWdtZW50cy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vbWF0Y2ggc2luZ2xlIHN0YXJzCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGdsb2JTZWdtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKGdsb2JTZWdtZW50c1tpXSA9PT0gJyonKSB7CiAgICAgICAgc2VnbWVudHNbaV0gPSAnKic7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gc2VnbWVudHMuam9pbignJykgPT09IGdsb2JTZWdtZW50cy5qb2luKCcnKTsKICB9CgoKICAvLyBJbXBsaWNpdCByb290IHN0YXRlIHRoYXQgaXMgYWx3YXlzIGFjdGl2ZQogIHJvb3QgPSByZWdpc3RlclN0YXRlKHsKICAgIG5hbWU6ICcnLAogICAgdXJsOiAnXicsCiAgICB2aWV3czogbnVsbCwKICAgICdhYnN0cmFjdCc6IHRydWUKICB9KTsKICByb290Lm5hdmlnYWJsZSA9IG51bGw7CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUHJvdmlkZXIjZGVjb3JhdG9yCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQWxsb3dzIHlvdSB0byBleHRlbmQgKGNhcmVmdWxseSkgb3Igb3ZlcnJpZGUgKGF0IHlvdXIgb3duIHBlcmlsKSB0aGUgCiAgICogYHN0YXRlQnVpbGRlcmAgb2JqZWN0IHVzZWQgaW50ZXJuYWxseSBieSBgJHN0YXRlUHJvdmlkZXJgLiBUaGlzIGNhbiBiZSB1c2VkIAogICAqIHRvIGFkZCBjdXN0b20gZnVuY3Rpb25hbGl0eSB0byB1aS1yb3V0ZXIsIGZvciBleGFtcGxlIGluZmVycmluZyB0ZW1wbGF0ZVVybCAKICAgKiBiYXNlZCBvbiB0aGUgc3RhdGUgbmFtZS4KICAgKgogICAqIFdoZW4gcGFzc2luZyBvbmx5IGEgbmFtZSwgaXQgcmV0dXJucyB0aGUgY3VycmVudCAob3JpZ2luYWwgb3IgZGVjb3JhdGVkKSBidWlsZGVyCiAgICogZnVuY3Rpb24gdGhhdCBtYXRjaGVzIGBuYW1lYC4KICAgKgogICAqIFRoZSBidWlsZGVyIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSBkZWNvcmF0ZWQgYXJlIGxpc3RlZCBiZWxvdy4gVGhvdWdoIG5vdCBhbGwKICAgKiBuZWNlc3NhcmlseSBoYXZlIGEgZ29vZCB1c2UgY2FzZSBmb3IgZGVjb3JhdGlvbiwgdGhhdCBpcyB1cCB0byB5b3UgdG8gZGVjaWRlLgogICAqCiAgICogSW4gYWRkaXRpb24sIHVzZXJzIGNhbiBhdHRhY2ggY3VzdG9tIGRlY29yYXRvcnMsIHdoaWNoIHdpbGwgZ2VuZXJhdGUgbmV3IAogICAqIHByb3BlcnRpZXMgd2l0aGluIHRoZSBzdGF0ZSdzIGludGVybmFsIGRlZmluaXRpb24uIFRoZXJlIGlzIGN1cnJlbnRseSBubyBjbGVhciAKICAgKiB1c2UtY2FzZSBmb3IgdGhpcyBiZXlvbmQgYWNjZXNzaW5nIGludGVybmFsIHN0YXRlcyAoaS5lLiAkc3RhdGUuJGN1cnJlbnQpLCAKICAgKiBob3dldmVyLCBleHBlY3QgdGhpcyB0byBiZWNvbWUgaW5jcmVhc2luZ2x5IHJlbGV2YW50IGFzIHdlIGludHJvZHVjZSBhZGRpdGlvbmFsIAogICAqIG1ldGEtcHJvZ3JhbW1pbmcgZmVhdHVyZXMuCiAgICoKICAgKiAqKldhcm5pbmcqKjogRGVjb3JhdG9ycyBzaG91bGQgbm90IGJlIGludGVyZGVwZW5kZW50IGJlY2F1c2UgdGhlIG9yZGVyIG9mIAogICAqIGV4ZWN1dGlvbiBvZiB0aGUgYnVpbGRlciBmdW5jdGlvbnMgaW4gbm9uLWRldGVybWluaXN0aWMuIEJ1aWxkZXIgZnVuY3Rpb25zIAogICAqIHNob3VsZCBvbmx5IGJlIGRlcGVuZGVudCBvbiB0aGUgc3RhdGUgZGVmaW5pdGlvbiBvYmplY3QgYW5kIHN1cGVyIGZ1bmN0aW9uLgogICAqCiAgICoKICAgKiBFeGlzdGluZyBidWlsZGVyIGZ1bmN0aW9ucyBhbmQgY3VycmVudCByZXR1cm4gdmFsdWVzOgogICAqCiAgICogLSAqKnBhcmVudCoqIGB7b2JqZWN0fWAgLSByZXR1cm5zIHRoZSBwYXJlbnQgc3RhdGUgb2JqZWN0LgogICAqIC0gKipkYXRhKiogYHtvYmplY3R9YCAtIHJldHVybnMgc3RhdGUgZGF0YSwgaW5jbHVkaW5nIGFueSBpbmhlcml0ZWQgZGF0YSB0aGF0IGlzIG5vdAogICAqICAgb3ZlcnJpZGRlbiBieSBvd24gdmFsdWVzIChpZiBhbnkpLgogICAqIC0gKip1cmwqKiBge29iamVjdH1gIC0gcmV0dXJucyBhIHtsaW5rIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gb3IgbnVsbC4KICAgKiAtICoqbmF2aWdhYmxlKiogYHtvYmplY3R9YCAtIHJldHVybnMgY2xvc2VzdCBhbmNlc3RvciBzdGF0ZSB0aGF0IGhhcyBhIFVSTCAoYWthIGlzIAogICAqICAgbmF2aWdhYmxlKS4KICAgKiAtICoqcGFyYW1zKiogYHtvYmplY3R9YCAtIHJldHVybnMgYW4gYXJyYXkgb2Ygc3RhdGUgcGFyYW1zIHRoYXQgYXJlIGVuc3VyZWQgdG8gCiAgICogICBiZSBhIHN1cGVyLXNldCBvZiBwYXJlbnQncyBwYXJhbXMuCiAgICogLSAqKnZpZXdzKiogYHtvYmplY3R9YCAtIHJldHVybnMgYSB2aWV3cyBvYmplY3Qgd2hlcmUgZWFjaCBrZXkgaXMgYW4gYWJzb2x1dGUgdmlldyAKICAgKiAgIG5hbWUgKGkuZS4gInZpZXdOYW1lQHN0YXRlTmFtZSIpIGFuZCBlYWNoIHZhbHVlIGlzIHRoZSBjb25maWcgb2JqZWN0IAogICAqICAgKHRlbXBsYXRlLCBjb250cm9sbGVyKSBmb3IgdGhlIHZpZXcuIEV2ZW4gd2hlbiB5b3UgZG9uJ3QgdXNlIHRoZSB2aWV3cyBvYmplY3QgCiAgICogICBleHBsaWNpdGx5IG9uIGEgc3RhdGUgY29uZmlnLCBvbmUgaXMgc3RpbGwgY3JlYXRlZCBmb3IgeW91IGludGVybmFsbHkuCiAgICogICBTbyBieSBkZWNvcmF0aW5nIHRoaXMgYnVpbGRlciBmdW5jdGlvbiB5b3UgaGF2ZSBhY2Nlc3MgdG8gZGVjb3JhdGluZyB0ZW1wbGF0ZSAKICAgKiAgIGFuZCBjb250cm9sbGVyIHByb3BlcnRpZXMuCiAgICogLSAqKm93blBhcmFtcyoqIGB7b2JqZWN0fWAgLSByZXR1cm5zIGFuIGFycmF5IG9mIHBhcmFtcyB0aGF0IGJlbG9uZyB0byB0aGUgc3RhdGUsIAogICAqICAgbm90IGluY2x1ZGluZyBhbnkgcGFyYW1zIGRlZmluZWQgYnkgYW5jZXN0b3Igc3RhdGVzLgogICAqIC0gKipwYXRoKiogYHtzdHJpbmd9YCAtIHJldHVybnMgdGhlIGZ1bGwgcGF0aCBmcm9tIHRoZSByb290IGRvd24gdG8gdGhpcyBzdGF0ZS4gCiAgICogICBOZWVkZWQgZm9yIHN0YXRlIGFjdGl2YXRpb24uCiAgICogLSAqKmluY2x1ZGVzKiogYHtvYmplY3R9YCAtIHJldHVybnMgYW4gb2JqZWN0IHRoYXQgaW5jbHVkZXMgZXZlcnkgc3RhdGUgdGhhdCAKICAgKiAgIHdvdWxkIHBhc3MgYSAnJHN0YXRlLmluY2x1ZGVzKCknIHRlc3QuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIDxwcmU+CiAgICogLy8gT3ZlcnJpZGUgdGhlIGludGVybmFsICd2aWV3cycgYnVpbGRlciB3aXRoIGEgZnVuY3Rpb24gdGhhdCB0YWtlcyB0aGUgc3RhdGUKICAgKiAvLyBkZWZpbml0aW9uLCBhbmQgYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGZ1bmN0aW9uIGJlaW5nIG92ZXJyaWRkZW46CiAgICogJHN0YXRlUHJvdmlkZXIuZGVjb3JhdG9yKCd2aWV3cycsIGZ1bmN0aW9uICgkc3RhdGUsIHBhcmVudCkgewogICAqICAgdmFyIHJlc3VsdCA9IHt9LAogICAqICAgICAgIHZpZXdzID0gcGFyZW50KHN0YXRlKTsKICAgKgogICAqICAgYW5ndWxhci5mb3JFYWNoKHZpZXcsIGZ1bmN0aW9uIChjb25maWcsIG5hbWUpIHsKICAgKiAgICAgdmFyIGF1dG9OYW1lID0gKHN0YXRlLm5hbWUgKyAnLicgKyBuYW1lKS5yZXBsYWNlKCcuJywgJy8nKTsKICAgKiAgICAgY29uZmlnLnRlbXBsYXRlVXJsID0gY29uZmlnLnRlbXBsYXRlVXJsIHx8ICcvcGFydGlhbHMvJyArIGF1dG9OYW1lICsgJy5odG1sJzsKICAgKiAgICAgcmVzdWx0W25hbWVdID0gY29uZmlnOwogICAqICAgfSk7CiAgICogICByZXR1cm4gcmVzdWx0OwogICAqIH0pOwogICAqCiAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoJ2hvbWUnLCB7CiAgICogICB2aWV3czogewogICAqICAgICAnY29udGFjdC5saXN0JzogeyBjb250cm9sbGVyOiAnTGlzdENvbnRyb2xsZXInIH0sCiAgICogICAgICdjb250YWN0Lml0ZW0nOiB7IGNvbnRyb2xsZXI6ICdJdGVtQ29udHJvbGxlcicgfQogICAqICAgfQogICAqIH0pOwogICAqCiAgICogLy8gLi4uCiAgICoKICAgKiAkc3RhdGUuZ28oJ2hvbWUnKTsKICAgKiAvLyBBdXRvLXBvcHVsYXRlcyBsaXN0IGFuZCBpdGVtIHZpZXdzIHdpdGggL3BhcnRpYWxzL2hvbWUvY29udGFjdC9saXN0Lmh0bWwsCiAgICogLy8gYW5kIC9wYXJ0aWFscy9ob21lL2NvbnRhY3QvaXRlbS5odG1sLCByZXNwZWN0aXZlbHkuCiAgICogPC9wcmU+CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgYnVpbGRlciBmdW5jdGlvbiB0byBkZWNvcmF0ZS4gCiAgICogQHBhcmFtIHtvYmplY3R9IGZ1bmMgQSBmdW5jdGlvbiB0aGF0IGlzIHJlc3BvbnNpYmxlIGZvciBkZWNvcmF0aW5nIHRoZSBvcmlnaW5hbCAKICAgKiBidWlsZGVyIGZ1bmN0aW9uLiBUaGUgZnVuY3Rpb24gcmVjZWl2ZXMgdHdvIHBhcmFtZXRlcnM6CiAgICoKICAgKiAgIC0gYHtvYmplY3R9YCAtIHN0YXRlIC0gVGhlIHN0YXRlIGNvbmZpZyBvYmplY3QuCiAgICogICAtIGB7b2JqZWN0fWAgLSBzdXBlciAtIFRoZSBvcmlnaW5hbCBidWlsZGVyIGZ1bmN0aW9uLgogICAqCiAgICogQHJldHVybiB7b2JqZWN0fSAkc3RhdGVQcm92aWRlciAtICRzdGF0ZVByb3ZpZGVyIGluc3RhbmNlCiAgICovCiAgdGhpcy5kZWNvcmF0b3IgPSBkZWNvcmF0b3I7CiAgZnVuY3Rpb24gZGVjb3JhdG9yKG5hbWUsIGZ1bmMpIHsKICAgIC8qanNoaW50IHZhbGlkdGhpczogdHJ1ZSAqLwogICAgaWYgKGlzU3RyaW5nKG5hbWUpICYmICFpc0RlZmluZWQoZnVuYykpIHsKICAgICAgcmV0dXJuIHN0YXRlQnVpbGRlcltuYW1lXTsKICAgIH0KICAgIGlmICghaXNGdW5jdGlvbihmdW5jKSB8fCAhaXNTdHJpbmcobmFtZSkpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBpZiAoc3RhdGVCdWlsZGVyW25hbWVdICYmICFzdGF0ZUJ1aWxkZXIuJGRlbGVnYXRlc1tuYW1lXSkgewogICAgICBzdGF0ZUJ1aWxkZXIuJGRlbGVnYXRlc1tuYW1lXSA9IHN0YXRlQnVpbGRlcltuYW1lXTsKICAgIH0KICAgIHN0YXRlQnVpbGRlcltuYW1lXSA9IGZ1bmM7CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlciNzdGF0ZQogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUHJvdmlkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVycyBhIHN0YXRlIGNvbmZpZ3VyYXRpb24gdW5kZXIgYSBnaXZlbiBzdGF0ZSBuYW1lLiBUaGUgc3RhdGVDb25maWcgb2JqZWN0CiAgICogaGFzIHRoZSBmb2xsb3dpbmcgYWNjZXB0YWJsZSBwcm9wZXJ0aWVzLgogICAqCiAgICogPGEgaWQ9J3RlbXBsYXRlJz48L2E+CiAgICoKICAgKiAtICoqYHRlbXBsYXRlYCoqIC0ge3N0cmluZ3xmdW5jdGlvbj19IC0gaHRtbCB0ZW1wbGF0ZSBhcyBhIHN0cmluZyBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucwogICAqICAgYW4gaHRtbCB0ZW1wbGF0ZSBhcyBhIHN0cmluZyB3aGljaCBzaG91bGQgYmUgdXNlZCBieSB0aGUgdWlWaWV3IGRpcmVjdGl2ZXMuIFRoaXMgcHJvcGVydHkgCiAgICogICB0YWtlcyBwcmVjZWRlbmNlIG92ZXIgdGVtcGxhdGVVcmwuCiAgICogICAKICAgKiAgIElmIGB0ZW1wbGF0ZWAgaXMgYSBmdW5jdGlvbiwgaXQgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAgICoKICAgKiAgIC0ge2FycmF5LiZsdDtvYmplY3QmZ3Q7fSAtIHN0YXRlIHBhcmFtZXRlcnMgZXh0cmFjdGVkIGZyb20gdGhlIGN1cnJlbnQgJGxvY2F0aW9uLnBhdGgoKSBieQogICAqICAgICBhcHBseWluZyB0aGUgY3VycmVudCBzdGF0ZQogICAqCiAgICogPGEgaWQ9J3RlbXBsYXRlVXJsJz48L2E+CiAgICoKICAgKiAtICoqYHRlbXBsYXRlVXJsYCoqIC0ge3N0cmluZ3xmdW5jdGlvbj19IC0gcGF0aCBvciBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSBwYXRoIHRvIGFuIGh0bWwgCiAgICogICB0ZW1wbGF0ZSB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5IHVpVmlldy4KICAgKiAgIAogICAqICAgSWYgYHRlbXBsYXRlVXJsYCBpcyBhIGZ1bmN0aW9uLCBpdCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICAgKgogICAqICAgLSB7YXJyYXkuJmx0O29iamVjdCZndDt9IC0gc3RhdGUgcGFyYW1ldGVycyBleHRyYWN0ZWQgZnJvbSB0aGUgY3VycmVudCAkbG9jYXRpb24ucGF0aCgpIGJ5IAogICAqICAgICBhcHBseWluZyB0aGUgY3VycmVudCBzdGF0ZQogICAqCiAgICogPGEgaWQ9J3RlbXBsYXRlUHJvdmlkZXInPjwvYT4KICAgKgogICAqIC0gKipgdGVtcGxhdGVQcm92aWRlcmAqKiAtIHtmdW5jdGlvbj19IC0gUHJvdmlkZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIEhUTUwgY29udGVudAogICAqICAgc3RyaW5nLgogICAqCiAgICogPGEgaWQ9J2NvbnRyb2xsZXInPjwvYT4KICAgKgogICAqIC0gKipgY29udHJvbGxlcmAqKiAtIHtzdHJpbmd8ZnVuY3Rpb249fSAtICBDb250cm9sbGVyIGZuIHRoYXQgc2hvdWxkIGJlIGFzc29jaWF0ZWQgd2l0aCBuZXdseSAKICAgKiAgIHJlbGF0ZWQgc2NvcGUgb3IgdGhlIG5hbWUgb2YgYSByZWdpc3RlcmVkIGNvbnRyb2xsZXIgaWYgcGFzc2VkIGFzIGEgc3RyaW5nLgogICAqCiAgICogPGEgaWQ9J2NvbnRyb2xsZXJQcm92aWRlcic+PC9hPgogICAqCiAgICogLSAqKmBjb250cm9sbGVyUHJvdmlkZXJgKiogLSB7ZnVuY3Rpb249fSAtIEluamVjdGFibGUgcHJvdmlkZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zCiAgICogICB0aGUgYWN0dWFsIGNvbnRyb2xsZXIgb3Igc3RyaW5nLgogICAqCiAgICogPGEgaWQ9J2NvbnRyb2xsZXJBcyc+PC9hPgogICAqIAogICAqIC0gKipgY29udHJvbGxlckFzYCoqIOKAkyB7c3RyaW5nPX0g4oCTIEEgY29udHJvbGxlciBhbGlhcyBuYW1lLiBJZiBwcmVzZW50IHRoZSBjb250cm9sbGVyIHdpbGwgYmUgCiAgICogICBwdWJsaXNoZWQgdG8gc2NvcGUgdW5kZXIgdGhlIGNvbnRyb2xsZXJBcyBuYW1lLgogICAqCiAgICogPGEgaWQ9J3Jlc29sdmUnPjwvYT4KICAgKgogICAqIC0gKipgcmVzb2x2ZWAqKiAtIHtvYmplY3QuJmx0O3N0cmluZywgZnVuY3Rpb24mZ3Q7PX0gLSBBbiBvcHRpb25hbCBtYXAgb2YgZGVwZW5kZW5jaWVzIHdoaWNoIAogICAqICAgc2hvdWxkIGJlIGluamVjdGVkIGludG8gdGhlIGNvbnRyb2xsZXIuIElmIGFueSBvZiB0aGVzZSBkZXBlbmRlbmNpZXMgYXJlIHByb21pc2VzLCAKICAgKiAgIHRoZSByb3V0ZXIgd2lsbCB3YWl0IGZvciB0aGVtIGFsbCB0byBiZSByZXNvbHZlZCBvciBvbmUgdG8gYmUgcmVqZWN0ZWQgYmVmb3JlIHRoZSAKICAgKiAgIGNvbnRyb2xsZXIgaXMgaW5zdGFudGlhdGVkLiBJZiBhbGwgdGhlIHByb21pc2VzIGFyZSByZXNvbHZlZCBzdWNjZXNzZnVsbHksIHRoZSB2YWx1ZXMgCiAgICogICBvZiB0aGUgcmVzb2x2ZWQgcHJvbWlzZXMgYXJlIGluamVjdGVkIGFuZCAkc3RhdGVDaGFuZ2VTdWNjZXNzIGV2ZW50IGlzIGZpcmVkLiBJZiBhbnkgCiAgICogICBvZiB0aGUgcHJvbWlzZXMgYXJlIHJlamVjdGVkIHRoZSAkc3RhdGVDaGFuZ2VFcnJvciBldmVudCBpcyBmaXJlZC4gVGhlIG1hcCBvYmplY3QgaXM6CiAgICogICAKICAgKiAgIC0ga2V5IC0ge3N0cmluZ306IG5hbWUgb2YgZGVwZW5kZW5jeSB0byBiZSBpbmplY3RlZCBpbnRvIGNvbnRyb2xsZXIKICAgKiAgIC0gZmFjdG9yeSAtIHtzdHJpbmd8ZnVuY3Rpb259OiBJZiBzdHJpbmcgdGhlbiBpdCBpcyBhbGlhcyBmb3Igc2VydmljZS4gT3RoZXJ3aXNlIGlmIGZ1bmN0aW9uLCAKICAgKiAgICAgaXQgaXMgaW5qZWN0ZWQgYW5kIHJldHVybiB2YWx1ZSBpdCB0cmVhdGVkIGFzIGRlcGVuZGVuY3kuIElmIHJlc3VsdCBpcyBhIHByb21pc2UsIGl0IGlzIAogICAqICAgICByZXNvbHZlZCBiZWZvcmUgaXRzIHZhbHVlIGlzIGluamVjdGVkIGludG8gY29udHJvbGxlci4KICAgKgogICAqIDxhIGlkPSd1cmwnPjwvYT4KICAgKgogICAqIC0gKipgdXJsYCoqIC0ge3N0cmluZz19IC0gQSB1cmwgd2l0aCBvcHRpb25hbCBwYXJhbWV0ZXJzLiBXaGVuIGEgc3RhdGUgaXMgbmF2aWdhdGVkIG9yCiAgICogICB0cmFuc2l0aW9uZWQgdG8sIHRoZSBgJHN0YXRlUGFyYW1zYCBzZXJ2aWNlIHdpbGwgYmUgcG9wdWxhdGVkIHdpdGggYW55IAogICAqICAgcGFyYW1ldGVycyB0aGF0IHdlcmUgcGFzc2VkLgogICAqCiAgICogPGEgaWQ9J3BhcmFtcyc+PC9hPgogICAqCiAgICogLSAqKmBwYXJhbXNgKiogLSB7b2JqZWN0PX0gLSBBbiBhcnJheSBvZiBwYXJhbWV0ZXIgbmFtZXMgb3IgcmVndWxhciBleHByZXNzaW9ucy4gT25seSAKICAgKiAgIHVzZSB0aGlzIHdpdGhpbiBhIHN0YXRlIGlmIHlvdSBhcmUgbm90IHVzaW5nIHVybC4gT3RoZXJ3aXNlIHlvdSBjYW4gc3BlY2lmeSB5b3VyCiAgICogICBwYXJhbWV0ZXJzIHdpdGhpbiB0aGUgdXJsLiBXaGVuIGEgc3RhdGUgaXMgbmF2aWdhdGVkIG9yIHRyYW5zaXRpb25lZCB0bywgdGhlIAogICAqICAgJHN0YXRlUGFyYW1zIHNlcnZpY2Ugd2lsbCBiZSBwb3B1bGF0ZWQgd2l0aCBhbnkgcGFyYW1ldGVycyB0aGF0IHdlcmUgcGFzc2VkLgogICAqCiAgICogPGEgaWQ9J3ZpZXdzJz48L2E+CiAgICoKICAgKiAtICoqYHZpZXdzYCoqIC0ge29iamVjdD19IC0gVXNlIHRoZSB2aWV3cyBwcm9wZXJ0eSB0byBzZXQgdXAgbXVsdGlwbGUgdmlld3Mgb3IgdG8gdGFyZ2V0IHZpZXdzCiAgICogICBtYW51YWxseS9leHBsaWNpdGx5LgogICAqCiAgICogPGEgaWQ9J2Fic3RyYWN0Jz48L2E+CiAgICoKICAgKiAtICoqYGFic3RyYWN0YCoqIC0ge2Jvb2xlYW49fSAtIEFuIGFic3RyYWN0IHN0YXRlIHdpbGwgbmV2ZXIgYmUgZGlyZWN0bHkgYWN0aXZhdGVkLCAKICAgKiAgIGJ1dCBjYW4gcHJvdmlkZSBpbmhlcml0ZWQgcHJvcGVydGllcyB0byBpdHMgY29tbW9uIGNoaWxkcmVuIHN0YXRlcy4KICAgKgogICAqIDxhIGlkPSdvbkVudGVyJz48L2E+CiAgICoKICAgKiAtICoqYG9uRW50ZXJgKiogLSB7b2JqZWN0PX0gLSBDYWxsYmFjayBmdW5jdGlvbiBmb3Igd2hlbiBhIHN0YXRlIGlzIGVudGVyZWQuIEdvb2Qgd2F5CiAgICogICB0byB0cmlnZ2VyIGFuIGFjdGlvbiBvciBkaXNwYXRjaCBhbiBldmVudCwgc3VjaCBhcyBvcGVuaW5nIGEgZGlhbG9nLgogICAqCiAgICogPGEgaWQ9J29uRXhpdCc+PC9hPgogICAqCiAgICogLSAqKmBvbkV4aXRgKiogLSB7b2JqZWN0PX0gLSBDYWxsYmFjayBmdW5jdGlvbiBmb3Igd2hlbiBhIHN0YXRlIGlzIGV4aXRlZC4gR29vZCB3YXkgdG8KICAgKiAgIHRyaWdnZXIgYW4gYWN0aW9uIG9yIGRpc3BhdGNoIGFuIGV2ZW50LCBzdWNoIGFzIG9wZW5pbmcgYSBkaWFsb2cuCiAgICoKICAgKiA8YSBpZD0ncmVsb2FkT25TZWFyY2gnPjwvYT4KICAgKgogICAqIC0gKipgcmVsb2FkT25TZWFyY2ggPSB0cnVlYCoqIC0ge2Jvb2xlYW49fSAtIElmIGBmYWxzZWAsIHdpbGwgbm90IHJldHJpZ2dlciB0aGUgc2FtZSBzdGF0ZSAKICAgKiAgIGp1c3QgYmVjYXVzZSBhIHNlYXJjaC9xdWVyeSBwYXJhbWV0ZXIgaGFzIGNoYW5nZWQgKHZpYSAkbG9jYXRpb24uc2VhcmNoKCkgb3IgJGxvY2F0aW9uLmhhc2goKSkuIAogICAqICAgVXNlZnVsIGZvciB3aGVuIHlvdSdkIGxpa2UgdG8gbW9kaWZ5ICRsb2NhdGlvbi5zZWFyY2goKSB3aXRob3V0IHRyaWdnZXJpbmcgYSByZWxvYWQuCiAgICoKICAgKiA8YSBpZD0nZGF0YSc+PC9hPgogICAqCiAgICogLSAqKmBkYXRhYCoqIC0ge29iamVjdD19IC0gQXJiaXRyYXJ5IGRhdGEgb2JqZWN0LCB1c2VmdWwgZm9yIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAqCiAgICogQGV4YW1wbGUKICAgKiA8cHJlPgogICAqIC8vIFNvbWUgc3RhdGUgbmFtZSBleGFtcGxlcwogICAqCiAgICogLy8gc3RhdGVOYW1lIGNhbiBiZSBhIHNpbmdsZSB0b3AtbGV2ZWwgbmFtZSAobXVzdCBiZSB1bmlxdWUpLgogICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwge30pOwogICAqCiAgICogLy8gT3IgaXQgY2FuIGJlIGEgbmVzdGVkIHN0YXRlIG5hbWUuIFRoaXMgc3RhdGUgaXMgYSBjaGlsZCBvZiB0aGUgCiAgICogLy8gYWJvdmUgImhvbWUiIHN0YXRlLgogICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lLm5ld2VzdCIsIHt9KTsKICAgKgogICAqIC8vIE5lc3Qgc3RhdGVzIGFzIGRlZXBseSBhcyBuZWVkZWQuCiAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUubmV3ZXN0LmFiYy54eXouaW5jZXB0aW9uIiwge30pOwogICAqCiAgICogLy8gc3RhdGUoKSByZXR1cm5zICRzdGF0ZVByb3ZpZGVyLCBzbyB5b3UgY2FuIGNoYWluIHN0YXRlIGRlY2xhcmF0aW9ucy4KICAgKiAkc3RhdGVQcm92aWRlcgogICAqICAgLnN0YXRlKCJob21lIiwge30pCiAgICogICAuc3RhdGUoImFib3V0Iiwge30pCiAgICogICAuc3RhdGUoImNvbnRhY3RzIiwge30pOwogICAqIDwvcHJlPgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgQSB1bmlxdWUgc3RhdGUgbmFtZSwgZS5nLiAiaG9tZSIsICJhYm91dCIsICJjb250YWN0cyIuIAogICAqIFRvIGNyZWF0ZSBhIHBhcmVudC9jaGlsZCBzdGF0ZSB1c2UgYSBkb3QsIGUuZy4gImFib3V0LnNhbGVzIiwgImhvbWUubmV3ZXN0Ii4KICAgKiBAcGFyYW0ge29iamVjdH0gZGVmaW5pdGlvbiBTdGF0ZSBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgKi8KICB0aGlzLnN0YXRlID0gc3RhdGU7CiAgZnVuY3Rpb24gc3RhdGUobmFtZSwgZGVmaW5pdGlvbikgewogICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICBpZiAoaXNPYmplY3QobmFtZSkpIGRlZmluaXRpb24gPSBuYW1lOwogICAgZWxzZSBkZWZpbml0aW9uLm5hbWUgPSBuYW1lOwogICAgcmVnaXN0ZXJTdGF0ZShkZWZpbml0aW9uKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgKgogICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICogQHJlcXVpcmVzICRxCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kdmlldwogICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwuJHJlc29sdmUKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVBhcmFtcwogICAqCiAgICogQHByb3BlcnR5IHtvYmplY3R9IHBhcmFtcyBBIHBhcmFtIG9iamVjdCwgZS5nLiB7c2VjdGlvbklkOiBzZWN0aW9uLmlkKX0sIHRoYXQgCiAgICogeW91J2QgbGlrZSB0byB0ZXN0IGFnYWluc3QgdGhlIGN1cnJlbnQgYWN0aXZlIHN0YXRlLgogICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjdXJyZW50IEEgcmVmZXJlbmNlIHRvIHRoZSBzdGF0ZSdzIGNvbmZpZyBvYmplY3QuIEhvd2V2ZXIgCiAgICogeW91IHBhc3NlZCBpdCBpbi4gVXNlZnVsIGZvciBhY2Nlc3NpbmcgY3VzdG9tIGRhdGEuCiAgICogQHByb3BlcnR5IHtvYmplY3R9IHRyYW5zaXRpb24gQ3VycmVudGx5IHBlbmRpbmcgdHJhbnNpdGlvbi4gQSBwcm9taXNlIHRoYXQnbGwgCiAgICogcmVzb2x2ZSBvciByZWplY3QuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBgJHN0YXRlYCBzZXJ2aWNlIGlzIHJlc3BvbnNpYmxlIGZvciByZXByZXNlbnRpbmcgc3RhdGVzIGFzIHdlbGwgYXMgdHJhbnNpdGlvbmluZwogICAqIGJldHdlZW4gdGhlbS4gSXQgYWxzbyBwcm92aWRlcyBpbnRlcmZhY2VzIHRvIGFzayBmb3IgY3VycmVudCBzdGF0ZSBvciBldmVuIHN0YXRlcwogICAqIHlvdSdyZSBjb21pbmcgZnJvbS4KICAgKi8KICAvLyAkdXJsUm91dGVyIGlzIGluamVjdGVkIGp1c3QgdG8gZW5zdXJlIGl0IGdldHMgaW5zdGFudGlhdGVkCiAgdGhpcy4kZ2V0ID0gJGdldDsKICAkZ2V0LiRpbmplY3QgPSBbJyRyb290U2NvcGUnLCAnJHEnLCAnJHZpZXcnLCAnJGluamVjdG9yJywgJyRyZXNvbHZlJywgJyRzdGF0ZVBhcmFtcycsICckbG9jYXRpb24nLCAnJHVybFJvdXRlcicsICckYnJvd3NlciddOwogIGZ1bmN0aW9uICRnZXQoICAgJHJvb3RTY29wZSwgICAkcSwgICAkdmlldywgICAkaW5qZWN0b3IsICAgJHJlc29sdmUsICAgJHN0YXRlUGFyYW1zLCAgICRsb2NhdGlvbiwgICAkdXJsUm91dGVyLCAgICRicm93c2VyKSB7CgogICAgdmFyIFRyYW5zaXRpb25TdXBlcnNlZGVkID0gJHEucmVqZWN0KG5ldyBFcnJvcigndHJhbnNpdGlvbiBzdXBlcnNlZGVkJykpOwogICAgdmFyIFRyYW5zaXRpb25QcmV2ZW50ZWQgPSAkcS5yZWplY3QobmV3IEVycm9yKCd0cmFuc2l0aW9uIHByZXZlbnRlZCcpKTsKICAgIHZhciBUcmFuc2l0aW9uQWJvcnRlZCA9ICRxLnJlamVjdChuZXcgRXJyb3IoJ3RyYW5zaXRpb24gYWJvcnRlZCcpKTsKICAgIHZhciBUcmFuc2l0aW9uRmFpbGVkID0gJHEucmVqZWN0KG5ldyBFcnJvcigndHJhbnNpdGlvbiBmYWlsZWQnKSk7CiAgICB2YXIgY3VycmVudExvY2F0aW9uID0gJGxvY2F0aW9uLnVybCgpOwogICAgdmFyIGJhc2VIcmVmID0gJGJyb3dzZXIuYmFzZUhyZWYoKTsKCiAgICBmdW5jdGlvbiBzeW5jVXJsKCkgewogICAgICBpZiAoJGxvY2F0aW9uLnVybCgpICE9PSBjdXJyZW50TG9jYXRpb24pIHsKICAgICAgICAkbG9jYXRpb24udXJsKGN1cnJlbnRMb2NhdGlvbik7CiAgICAgICAgJGxvY2F0aW9uLnJlcGxhY2UoKTsKICAgICAgfQogICAgfQoKICAgIHJvb3QubG9jYWxzID0geyByZXNvbHZlOiBudWxsLCBnbG9iYWxzOiB7ICRzdGF0ZVBhcmFtczoge30gfSB9OwogICAgJHN0YXRlID0gewogICAgICBwYXJhbXM6IHt9LAogICAgICBjdXJyZW50OiByb290LnNlbGYsCiAgICAgICRjdXJyZW50OiByb290LAogICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI3JlbG9hZAogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgbWV0aG9kIHRoYXQgZm9yY2UgcmVsb2FkcyB0aGUgY3VycmVudCBzdGF0ZS4gQWxsIHJlc29sdmVzIGFyZSByZS1yZXNvbHZlZCwgZXZlbnRzIGFyZSBub3QgcmUtZmlyZWQsIAogICAgICogYW5kIGNvbnRyb2xsZXJzIHJlaW5zdGFudGlhdGVkIChidWcgd2l0aCBjb250cm9sbGVycyByZWluc3RhbnRpYXRpbmcgcmlnaHQgbm93LCBmaXhpbmcgc29vbikuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiB2YXIgYXBwIGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlciddKTsKICAgICAqCiAgICAgKiBhcHAuY29udHJvbGxlcignY3RybCcsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSkgewogICAgICogICAkc2NvcGUucmVsb2FkID0gZnVuY3Rpb24oKXsKICAgICAqICAgICAkc3RhdGUucmVsb2FkKCk7CiAgICAgKiAgIH0KICAgICAqIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogYHJlbG9hZCgpYCBpcyBqdXN0IGFuIGFsaWFzIGZvcjoKICAgICAqIDxwcmU+CiAgICAgKiAkc3RhdGUudHJhbnNpdGlvblRvKCRzdGF0ZS5jdXJyZW50LCAkc3RhdGVQYXJhbXMsIHsgCiAgICAgKiAgIHJlbG9hZDogdHJ1ZSwgaW5oZXJpdDogZmFsc2UsIG5vdGlmeTogZmFsc2UgCiAgICAgKiB9KTsKICAgICAqIDwvcHJlPgogICAgICovCiAgICAkc3RhdGUucmVsb2FkID0gZnVuY3Rpb24gcmVsb2FkKCkgewogICAgICAkc3RhdGUudHJhbnNpdGlvblRvKCRzdGF0ZS5jdXJyZW50LCAkc3RhdGVQYXJhbXMsIHsgcmVsb2FkOiB0cnVlLCBpbmhlcml0OiBmYWxzZSwgbm90aWZ5OiBmYWxzZSB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjZ28KICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZW5pZW5jZSBtZXRob2QgZm9yIHRyYW5zaXRpb25pbmcgdG8gYSBuZXcgc3RhdGUuIGAkc3RhdGUuZ29gIGNhbGxzIAogICAgICogYCRzdGF0ZS50cmFuc2l0aW9uVG9gIGludGVybmFsbHkgYnV0IGF1dG9tYXRpY2FsbHkgc2V0cyBvcHRpb25zIHRvIAogICAgICogYHsgbG9jYXRpb246IHRydWUsIGluaGVyaXQ6IHRydWUsIHJlbGF0aXZlOiAkc3RhdGUuJGN1cnJlbnQsIG5vdGlmeTogdHJ1ZSB9YC4gCiAgICAgKiBUaGlzIGFsbG93cyB5b3UgdG8gZWFzaWx5IHVzZSBhbiBhYnNvbHV0ZSBvciByZWxhdGl2ZSB0byBwYXRoIGFuZCBzcGVjaWZ5IAogICAgICogb25seSB0aGUgcGFyYW1ldGVycyB5b3UnZCBsaWtlIHRvIHVwZGF0ZSAod2hpbGUgbGV0dGluZyB1bnNwZWNpZmllZCBwYXJhbWV0ZXJzIAogICAgICogaW5oZXJpdCBmcm9tIHRoZSBjdXJyZW50bHkgYWN0aXZlIGFuY2VzdG9yIHN0YXRlcykuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyJ10pOwogICAgICoKICAgICAqIGFwcC5jb250cm9sbGVyKCdjdHJsJywgZnVuY3Rpb24gKCRzY29wZSwgJHN0YXRlKSB7CiAgICAgKiAgICRzY29wZS5jaGFuZ2VTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAqICAgICAkc3RhdGUuZ28oJ2NvbnRhY3QuZGV0YWlsJyk7CiAgICAgKiAgIH07CiAgICAgKiB9KTsKICAgICAqIDwvcHJlPgogICAgICogPGltZyBzcmM9Jy4uL25nZG9jX2Fzc2V0cy9TdGF0ZUdvRXhhbXBsZXMucG5nJy8+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHRvIEFic29sdXRlIHN0YXRlIG5hbWUgb3IgcmVsYXRpdmUgc3RhdGUgcGF0aC4gU29tZSBleGFtcGxlczoKICAgICAqCiAgICAgKiAtIGAkc3RhdGUuZ28oJ2NvbnRhY3QuZGV0YWlsJylgIC0gd2lsbCBnbyB0byB0aGUgYGNvbnRhY3QuZGV0YWlsYCBzdGF0ZQogICAgICogLSBgJHN0YXRlLmdvKCdeJylgIC0gd2lsbCBnbyB0byBhIHBhcmVudCBzdGF0ZQogICAgICogLSBgJHN0YXRlLmdvKCdeLnNpYmxpbmcnKWAgLSB3aWxsIGdvIHRvIGEgc2libGluZyBzdGF0ZQogICAgICogLSBgJHN0YXRlLmdvKCcuY2hpbGQuZ3JhbmRjaGlsZCcpYCAtIHdpbGwgZ28gdG8gZ3JhbmRjaGlsZCBzdGF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gcGFyYW1zIEEgbWFwIG9mIHRoZSBwYXJhbWV0ZXJzIHRoYXQgd2lsbCBiZSBzZW50IHRvIHRoZSBzdGF0ZSwgCiAgICAgKiB3aWxsIHBvcHVsYXRlICRzdGF0ZVBhcmFtcy4gQW55IHBhcmFtZXRlcnMgdGhhdCBhcmUgbm90IHNwZWNpZmllZCB3aWxsIGJlIGluaGVyaXRlZCBmcm9tIGN1cnJlbnRseSAKICAgICAqIGRlZmluZWQgcGFyYW1ldGVycy4gVGhpcyBhbGxvd3MsIGZvciBleGFtcGxlLCBnb2luZyB0byBhIHNpYmxpbmcgc3RhdGUgdGhhdCBzaGFyZXMgcGFyYW1ldGVycwogICAgICogc3BlY2lmaWVkIGluIGEgcGFyZW50IHN0YXRlLiBQYXJhbWV0ZXIgaW5oZXJpdGFuY2Ugb25seSB3b3JrcyBiZXR3ZWVuIGNvbW1vbiBhbmNlc3RvciBzdGF0ZXMsIEkuZS4KICAgICAqIHRyYW5zaXRpb25pbmcgdG8gYSBzaWJsaW5nIHdpbGwgZ2V0IHlvdSB0aGUgcGFyYW1ldGVycyBmb3IgYWxsIHBhcmVudHMsIHRyYW5zaXRpb25pbmcgdG8gYSBjaGlsZAogICAgICogd2lsbCBnZXQgeW91IGFsbCBjdXJyZW50IHBhcmFtZXRlcnMsIGV0Yy4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdC4gVGhlIG9wdGlvbnMgYXJlOgogICAgICoKICAgICAqIC0gKipgbG9jYXRpb25gKiogLSB7Ym9vbGVhbj10cnVlfHN0cmluZz19IC0gSWYgYHRydWVgIHdpbGwgdXBkYXRlIHRoZSB1cmwgaW4gdGhlIGxvY2F0aW9uIGJhciwgaWYgYGZhbHNlYAogICAgICogICAgd2lsbCBub3QuIElmIHN0cmluZywgbXVzdCBiZSBgInJlcGxhY2UiYCwgd2hpY2ggd2lsbCB1cGRhdGUgdXJsIGFuZCBhbHNvIHJlcGxhY2UgbGFzdCBoaXN0b3J5IHJlY29yZC4KICAgICAqIC0gKipgaW5oZXJpdGAqKiAtIHtib29sZWFuPXRydWV9LCBJZiBgdHJ1ZWAgd2lsbCBpbmhlcml0IHVybCBwYXJhbWV0ZXJzIGZyb20gY3VycmVudCB1cmwuCiAgICAgKiAtICoqYHJlbGF0aXZlYCoqIC0ge29iamVjdD0kc3RhdGUuJGN1cnJlbnR9LCBXaGVuIHRyYW5zaXRpb25pbmcgd2l0aCByZWxhdGl2ZSBwYXRoIChlLmcgJ14nKSwgCiAgICAgKiAgICBkZWZpbmVzIHdoaWNoIHN0YXRlIHRvIGJlIHJlbGF0aXZlIGZyb20uCiAgICAgKiAtICoqYG5vdGlmeWAqKiAtIHtib29sZWFuPXRydWV9LCBJZiBgdHJ1ZWAgd2lsbCBicm9hZGNhc3QgJHN0YXRlQ2hhbmdlU3RhcnQgYW5kICRzdGF0ZUNoYW5nZVN1Y2Nlc3MgZXZlbnRzLgogICAgICogLSAqKmByZWxvYWRgKiogKHYwLjIuNSkgLSB7Ym9vbGVhbj1mYWxzZX0sIElmIGB0cnVlYCB3aWxsIGZvcmNlIHRyYW5zaXRpb24gZXZlbiBpZiB0aGUgc3RhdGUgb3IgcGFyYW1zIAogICAgICogICAgaGF2ZSBub3QgY2hhbmdlZCwgYWthIGEgcmVsb2FkIG9mIHRoZSBzYW1lIHN0YXRlLiBJdCBkaWZmZXJzIGZyb20gcmVsb2FkT25TZWFyY2ggYmVjYXVzZSB5b3UnZAogICAgICogICAgdXNlIHRoaXMgd2hlbiB5b3Ugd2FudCB0byBmb3JjZSBhIHJlbG9hZCB3aGVuICpldmVyeXRoaW5nKiBpcyB0aGUgc2FtZSwgaW5jbHVkaW5nIHNlYXJjaCBwYXJhbXMuCiAgICAgKgogICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSByZXByZXNlbnRpbmcgdGhlIHN0YXRlIG9mIHRoZSBuZXcgdHJhbnNpdGlvbi4KICAgICAqCiAgICAgKiBQb3NzaWJsZSBzdWNjZXNzIHZhbHVlczoKICAgICAqCiAgICAgKiAtICRzdGF0ZS5jdXJyZW50CiAgICAgKgogICAgICogPGJyLz5Qb3NzaWJsZSByZWplY3Rpb24gdmFsdWVzOgogICAgICoKICAgICAqIC0gJ3RyYW5zaXRpb24gc3VwZXJzZWRlZCcgLSB3aGVuIGEgbmV3ZXIgdHJhbnNpdGlvbiBoYXMgYmVlbiBzdGFydGVkIGFmdGVyIHRoaXMgb25lCiAgICAgKiAtICd0cmFuc2l0aW9uIHByZXZlbnRlZCcgLSB3aGVuIGBldmVudC5wcmV2ZW50RGVmYXVsdCgpYCBoYXMgYmVlbiBjYWxsZWQgaW4gYSBgJHN0YXRlQ2hhbmdlU3RhcnRgIGxpc3RlbmVyCiAgICAgKiAtICd0cmFuc2l0aW9uIGFib3J0ZWQnIC0gd2hlbiBgZXZlbnQucHJldmVudERlZmF1bHQoKWAgaGFzIGJlZW4gY2FsbGVkIGluIGEgYCRzdGF0ZU5vdEZvdW5kYCBsaXN0ZW5lciBvcgogICAgICogICB3aGVuIGEgYCRzdGF0ZU5vdEZvdW5kYCBgZXZlbnQucmV0cnlgIHByb21pc2UgZXJyb3JzLgogICAgICogLSAndHJhbnNpdGlvbiBmYWlsZWQnIC0gd2hlbiBhIHN0YXRlIGhhcyBiZWVuIHVuc3VjY2Vzc2Z1bGx5IGZvdW5kIGFmdGVyIDIgdHJpZXMuCiAgICAgKiAtICpyZXNvbHZlIGVycm9yKiAtIHdoZW4gYW4gZXJyb3IgaGFzIG9jY3VycmVkIHdpdGggYSBgcmVzb2x2ZWAKICAgICAqCiAgICAgKi8KICAgICRzdGF0ZS5nbyA9IGZ1bmN0aW9uIGdvKHRvLCBwYXJhbXMsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMudHJhbnNpdGlvblRvKHRvLCBwYXJhbXMsIGV4dGVuZCh7IGluaGVyaXQ6IHRydWUsIHJlbGF0aXZlOiAkc3RhdGUuJGN1cnJlbnQgfSwgb3B0aW9ucykpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSN0cmFuc2l0aW9uVG8KICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBMb3ctbGV2ZWwgbWV0aG9kIGZvciB0cmFuc2l0aW9uaW5nIHRvIGEgbmV3IHN0YXRlLiB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2dvICRzdGF0ZS5nb30KICAgICAqIHVzZXMgYHRyYW5zaXRpb25Ub2AgaW50ZXJuYWxseS4gYCRzdGF0ZS5nb2AgaXMgcmVjb21tZW5kZWQgaW4gbW9zdCBzaXR1YXRpb25zLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiA8cHJlPgogICAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlciddKTsKICAgICAqCiAgICAgKiBhcHAuY29udHJvbGxlcignY3RybCcsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSkgewogICAgICogICAkc2NvcGUuY2hhbmdlU3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgKiAgICAgJHN0YXRlLnRyYW5zaXRpb25UbygnY29udGFjdC5kZXRhaWwnKTsKICAgICAqICAgfTsKICAgICAqIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHRvIFN0YXRlIG5hbWUuCiAgICAgKiBAcGFyYW0ge29iamVjdD19IHRvUGFyYW1zIEEgbWFwIG9mIHRoZSBwYXJhbWV0ZXJzIHRoYXQgd2lsbCBiZSBzZW50IHRvIHRoZSBzdGF0ZSwKICAgICAqIHdpbGwgcG9wdWxhdGUgJHN0YXRlUGFyYW1zLgogICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0LiBUaGUgb3B0aW9ucyBhcmU6CiAgICAgKgogICAgICogLSAqKmBsb2NhdGlvbmAqKiAtIHtib29sZWFuPXRydWV8c3RyaW5nPX0gLSBJZiBgdHJ1ZWAgd2lsbCB1cGRhdGUgdGhlIHVybCBpbiB0aGUgbG9jYXRpb24gYmFyLCBpZiBgZmFsc2VgCiAgICAgKiAgICB3aWxsIG5vdC4gSWYgc3RyaW5nLCBtdXN0IGJlIGAicmVwbGFjZSJgLCB3aGljaCB3aWxsIHVwZGF0ZSB1cmwgYW5kIGFsc28gcmVwbGFjZSBsYXN0IGhpc3RvcnkgcmVjb3JkLgogICAgICogLSAqKmBpbmhlcml0YCoqIC0ge2Jvb2xlYW49ZmFsc2V9LCBJZiBgdHJ1ZWAgd2lsbCBpbmhlcml0IHVybCBwYXJhbWV0ZXJzIGZyb20gY3VycmVudCB1cmwuCiAgICAgKiAtICoqYHJlbGF0aXZlYCoqIC0ge29iamVjdD19LCBXaGVuIHRyYW5zaXRpb25pbmcgd2l0aCByZWxhdGl2ZSBwYXRoIChlLmcgJ14nKSwgCiAgICAgKiAgICBkZWZpbmVzIHdoaWNoIHN0YXRlIHRvIGJlIHJlbGF0aXZlIGZyb20uCiAgICAgKiAtICoqYG5vdGlmeWAqKiAtIHtib29sZWFuPXRydWV9LCBJZiBgdHJ1ZWAgd2lsbCBicm9hZGNhc3QgJHN0YXRlQ2hhbmdlU3RhcnQgYW5kICRzdGF0ZUNoYW5nZVN1Y2Nlc3MgZXZlbnRzLgogICAgICogLSAqKmByZWxvYWRgKiogKHYwLjIuNSkgLSB7Ym9vbGVhbj1mYWxzZX0sIElmIGB0cnVlYCB3aWxsIGZvcmNlIHRyYW5zaXRpb24gZXZlbiBpZiB0aGUgc3RhdGUgb3IgcGFyYW1zIAogICAgICogICAgaGF2ZSBub3QgY2hhbmdlZCwgYWthIGEgcmVsb2FkIG9mIHRoZSBzYW1lIHN0YXRlLiBJdCBkaWZmZXJzIGZyb20gcmVsb2FkT25TZWFyY2ggYmVjYXVzZSB5b3UnZAogICAgICogICAgdXNlIHRoaXMgd2hlbiB5b3Ugd2FudCB0byBmb3JjZSBhIHJlbG9hZCB3aGVuICpldmVyeXRoaW5nKiBpcyB0aGUgc2FtZSwgaW5jbHVkaW5nIHNlYXJjaCBwYXJhbXMuCiAgICAgKgogICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSByZXByZXNlbnRpbmcgdGhlIHN0YXRlIG9mIHRoZSBuZXcgdHJhbnNpdGlvbi4gU2VlCiAgICAgKiB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2dvICRzdGF0ZS5nb30uCiAgICAgKi8KICAgICRzdGF0ZS50cmFuc2l0aW9uVG8gPSBmdW5jdGlvbiB0cmFuc2l0aW9uVG8odG8sIHRvUGFyYW1zLCBvcHRpb25zKSB7CiAgICAgIHRvUGFyYW1zID0gdG9QYXJhbXMgfHwge307CiAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgIGxvY2F0aW9uOiB0cnVlLCBpbmhlcml0OiBmYWxzZSwgcmVsYXRpdmU6IG51bGwsIG5vdGlmeTogdHJ1ZSwgcmVsb2FkOiBmYWxzZSwgJHJldHJ5OiBmYWxzZQogICAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICAgIHZhciBmcm9tID0gJHN0YXRlLiRjdXJyZW50LCBmcm9tUGFyYW1zID0gJHN0YXRlLnBhcmFtcywgZnJvbVBhdGggPSBmcm9tLnBhdGg7CiAgICAgIHZhciBldnQsIHRvU3RhdGUgPSBmaW5kU3RhdGUodG8sIG9wdGlvbnMucmVsYXRpdmUpOwoKICAgICAgaWYgKCFpc0RlZmluZWQodG9TdGF0ZSkpIHsKICAgICAgICAvLyBCcm9hZGNhc3Qgbm90IGZvdW5kIGV2ZW50IGFuZCBhYm9ydCB0aGUgdHJhbnNpdGlvbiBpZiBwcmV2ZW50ZWQKICAgICAgICB2YXIgcmVkaXJlY3QgPSB7IHRvOiB0bywgdG9QYXJhbXM6IHRvUGFyYW1zLCBvcHRpb25zOiBvcHRpb25zIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjJHN0YXRlTm90Rm91bmQKICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEZpcmVkIHdoZW4gYSByZXF1ZXN0ZWQgc3RhdGUgKipjYW5ub3QgYmUgZm91bmQqKiB1c2luZyB0aGUgcHJvdmlkZWQgc3RhdGUgbmFtZSBkdXJpbmcgdHJhbnNpdGlvbi4KICAgICAgICAgKiBUaGUgZXZlbnQgaXMgYnJvYWRjYXN0IGFsbG93aW5nIGFueSBoYW5kbGVycyBhIHNpbmdsZSBjaGFuY2UgdG8gZGVhbCB3aXRoIHRoZSBlcnJvciAodXN1YWxseSBieQogICAgICAgICAqIGxhenktbG9hZGluZyB0aGUgdW5mb3VuZCBzdGF0ZSkuIEEgc3BlY2lhbCBgdW5mb3VuZFN0YXRlYCBvYmplY3QgaXMgcGFzc2VkIHRvIHRoZSBsaXN0ZW5lciBoYW5kbGVyLAogICAgICAgICAqIHlvdSBjYW4gc2VlIGl0cyB0aHJlZSBwcm9wZXJ0aWVzIGluIHRoZSBleGFtcGxlLiBZb3UgY2FuIHVzZSBgZXZlbnQucHJldmVudERlZmF1bHQoKWAgdG8gYWJvcnQgdGhlCiAgICAgICAgICogdHJhbnNpdGlvbiBhbmQgdGhlIHByb21pc2UgcmV0dXJuZWQgZnJvbSBgZ29gIHdpbGwgYmUgcmVqZWN0ZWQgd2l0aCBhIGAndHJhbnNpdGlvbiBhYm9ydGVkJ2AgdmFsdWUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB1bmZvdW5kU3RhdGUgVW5mb3VuZCBTdGF0ZSBpbmZvcm1hdGlvbi4gQ29udGFpbnM6IGB0bywgdG9QYXJhbXMsIG9wdGlvbnNgIHByb3BlcnRpZXMuCiAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gZnJvbVN0YXRlIEN1cnJlbnQgc3RhdGUgb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmcm9tUGFyYW1zIEN1cnJlbnQgc3RhdGUgcGFyYW1zLgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgKgogICAgICAgICAqIDxwcmU+CiAgICAgICAgICogLy8gc29tZXdoZXJlLCBhc3N1bWUgbGF6eS5zdGF0ZSBoYXMgbm90IGJlZW4gZGVmaW5lZAogICAgICAgICAqICRzdGF0ZS5nbygibGF6eS5zdGF0ZSIsIHthOjEsIGI6Mn0sIHtpbmhlcml0OmZhbHNlfSk7CiAgICAgICAgICoKICAgICAgICAgKiAvLyBzb21ld2hlcmUgZWxzZQogICAgICAgICAqICRzY29wZS4kb24oJyRzdGF0ZU5vdEZvdW5kJywKICAgICAgICAgKiBmdW5jdGlvbihldmVudCwgdW5mb3VuZFN0YXRlLCBmcm9tU3RhdGUsIGZyb21QYXJhbXMpewogICAgICAgICAqICAgICBjb25zb2xlLmxvZyh1bmZvdW5kU3RhdGUudG8pOyAvLyAibGF6eS5zdGF0ZSIKICAgICAgICAgKiAgICAgY29uc29sZS5sb2codW5mb3VuZFN0YXRlLnRvUGFyYW1zKTsgLy8ge2E6MSwgYjoyfQogICAgICAgICAqICAgICBjb25zb2xlLmxvZyh1bmZvdW5kU3RhdGUub3B0aW9ucyk7IC8vIHtpbmhlcml0OmZhbHNlfSArIGRlZmF1bHQgb3B0aW9ucwogICAgICAgICAqIH0pCiAgICAgICAgICogPC9wcmU+CiAgICAgICAgICovCiAgICAgICAgZXZ0ID0gJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckc3RhdGVOb3RGb3VuZCcsIHJlZGlyZWN0LCBmcm9tLnNlbGYsIGZyb21QYXJhbXMpOwogICAgICAgIGlmIChldnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgc3luY1VybCgpOwogICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25BYm9ydGVkOwogICAgICAgIH0KCiAgICAgICAgLy8gQWxsb3cgdGhlIGhhbmRsZXIgdG8gcmV0dXJuIGEgcHJvbWlzZSB0byBkZWZlciBzdGF0ZSBsb29rdXAgcmV0cnkKICAgICAgICBpZiAoZXZ0LnJldHJ5KSB7CiAgICAgICAgICBpZiAob3B0aW9ucy4kcmV0cnkpIHsKICAgICAgICAgICAgc3luY1VybCgpOwogICAgICAgICAgICByZXR1cm4gVHJhbnNpdGlvbkZhaWxlZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXRyeVRyYW5zaXRpb24gPSAkc3RhdGUudHJhbnNpdGlvbiA9ICRxLndoZW4oZXZ0LnJldHJ5KTsKICAgICAgICAgIHJldHJ5VHJhbnNpdGlvbi50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAocmV0cnlUcmFuc2l0aW9uICE9PSAkc3RhdGUudHJhbnNpdGlvbikgcmV0dXJuIFRyYW5zaXRpb25TdXBlcnNlZGVkOwogICAgICAgICAgICByZWRpcmVjdC5vcHRpb25zLiRyZXRyeSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiAkc3RhdGUudHJhbnNpdGlvblRvKHJlZGlyZWN0LnRvLCByZWRpcmVjdC50b1BhcmFtcywgcmVkaXJlY3Qub3B0aW9ucyk7CiAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25BYm9ydGVkOwogICAgICAgICAgfSk7CiAgICAgICAgICBzeW5jVXJsKCk7CiAgICAgICAgICByZXR1cm4gcmV0cnlUcmFuc2l0aW9uOwogICAgICAgIH0KCiAgICAgICAgLy8gQWx3YXlzIHJldHJ5IG9uY2UgaWYgdGhlICRzdGF0ZU5vdEZvdW5kIHdhcyBub3QgcHJldmVudGVkCiAgICAgICAgLy8gKGhhbmRsZXMgZWl0aGVyIHJlZGlyZWN0IGNoYW5nZWQgb3Igc3RhdGUgbGF6eS1kZWZpbml0aW9uKQogICAgICAgIHRvID0gcmVkaXJlY3QudG87CiAgICAgICAgdG9QYXJhbXMgPSByZWRpcmVjdC50b1BhcmFtczsKICAgICAgICBvcHRpb25zID0gcmVkaXJlY3Qub3B0aW9uczsKICAgICAgICB0b1N0YXRlID0gZmluZFN0YXRlKHRvLCBvcHRpb25zLnJlbGF0aXZlKTsKICAgICAgICBpZiAoIWlzRGVmaW5lZCh0b1N0YXRlKSkgewogICAgICAgICAgaWYgKG9wdGlvbnMucmVsYXRpdmUpIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IHJlc29sdmUgJyIgKyB0byArICInIGZyb20gc3RhdGUgJyIgKyBvcHRpb25zLnJlbGF0aXZlICsgIiciKTsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gc3VjaCBzdGF0ZSAnIiArIHRvICsgIiciKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRvU3RhdGVbYWJzdHJhY3RLZXldKSB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB0cmFuc2l0aW9uIHRvIGFic3RyYWN0IHN0YXRlICciICsgdG8gKyAiJyIpOwogICAgICBpZiAob3B0aW9ucy5pbmhlcml0KSB0b1BhcmFtcyA9IGluaGVyaXRQYXJhbXMoJHN0YXRlUGFyYW1zLCB0b1BhcmFtcyB8fCB7fSwgJHN0YXRlLiRjdXJyZW50LCB0b1N0YXRlKTsKICAgICAgdG8gPSB0b1N0YXRlOwoKICAgICAgdmFyIHRvUGF0aCA9IHRvLnBhdGg7CgogICAgICAvLyBTdGFydGluZyBmcm9tIHRoZSByb290IG9mIHRoZSBwYXRoLCBrZWVwIGFsbCBsZXZlbHMgdGhhdCBoYXZlbid0IGNoYW5nZWQKICAgICAgdmFyIGtlZXAsIHN0YXRlLCBsb2NhbHMgPSByb290LmxvY2FscywgdG9Mb2NhbHMgPSBbXTsKICAgICAgZm9yIChrZWVwID0gMCwgc3RhdGUgPSB0b1BhdGhba2VlcF07CiAgICAgICAgICAgc3RhdGUgJiYgc3RhdGUgPT09IGZyb21QYXRoW2tlZXBdICYmIGVxdWFsRm9yS2V5cyh0b1BhcmFtcywgZnJvbVBhcmFtcywgc3RhdGUub3duUGFyYW1zKSAmJiAhb3B0aW9ucy5yZWxvYWQ7CiAgICAgICAgICAga2VlcCsrLCBzdGF0ZSA9IHRvUGF0aFtrZWVwXSkgewogICAgICAgIGxvY2FscyA9IHRvTG9jYWxzW2tlZXBdID0gc3RhdGUubG9jYWxzOwogICAgICB9CgogICAgICAvLyBJZiB3ZSdyZSBnb2luZyB0byB0aGUgc2FtZSBzdGF0ZSBhbmQgYWxsIGxvY2FscyBhcmUga2VwdCwgd2UndmUgZ290IG5vdGhpbmcgdG8gZG8uCiAgICAgIC8vIEJ1dCBjbGVhciAndHJhbnNpdGlvbicsIGFzIHdlIHN0aWxsIHdhbnQgdG8gY2FuY2VsIGFueSBvdGhlciBwZW5kaW5nIHRyYW5zaXRpb25zLgogICAgICAvLyBUT0RPOiBXZSBtYXkgbm90IHdhbnQgdG8gYnVtcCAndHJhbnNpdGlvbicgaWYgd2UncmUgY2FsbGVkIGZyb20gYSBsb2NhdGlvbiBjaGFuZ2UgdGhhdCB3ZSd2ZSBpbml0aWF0ZWQgb3Vyc2VsdmVzLAogICAgICAvLyBiZWNhdXNlIHdlIG1pZ2h0IGFjY2lkZW50YWxseSBhYm9ydCBhIGxlZ2l0aW1hdGUgdHJhbnNpdGlvbiBpbml0aWF0ZWQgZnJvbSBjb2RlPwogICAgICBpZiAoc2hvdWxkVHJpZ2dlclJlbG9hZCh0bywgZnJvbSwgbG9jYWxzLCBvcHRpb25zKSApIHsKICAgICAgICBpZiAoIHRvLnNlbGYucmVsb2FkT25TZWFyY2ggIT09IGZhbHNlICkKICAgICAgICAgIHN5bmNVcmwoKTsKICAgICAgICAkc3RhdGUudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgcmV0dXJuICRxLndoZW4oJHN0YXRlLmN1cnJlbnQpOwogICAgICB9CgogICAgICAvLyBOb3JtYWxpemUvZmlsdGVyIHBhcmFtZXRlcnMgYmVmb3JlIHdlIHBhc3MgdGhlbSB0byBldmVudCBoYW5kbGVycyBldGMuCiAgICAgIHRvUGFyYW1zID0gbm9ybWFsaXplKHRvLnBhcmFtcywgdG9QYXJhbXMgfHwge30pOwoKICAgICAgLy8gQnJvYWRjYXN0IHN0YXJ0IGV2ZW50IGFuZCBjYW5jZWwgdGhlIHRyYW5zaXRpb24gaWYgcmVxdWVzdGVkCiAgICAgIGlmIChvcHRpb25zLm5vdGlmeSkgewogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjJHN0YXRlQ2hhbmdlU3RhcnQKICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEZpcmVkIHdoZW4gdGhlIHN0YXRlIHRyYW5zaXRpb24gKipiZWdpbnMqKi4gWW91IGNhbiB1c2UgYGV2ZW50LnByZXZlbnREZWZhdWx0KClgCiAgICAgICAgICogdG8gcHJldmVudCB0aGUgdHJhbnNpdGlvbiBmcm9tIGhhcHBlbmluZyBhbmQgdGhlbiB0aGUgdHJhbnNpdGlvbiBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgKiByZWplY3RlZCB3aXRoIGEgYCd0cmFuc2l0aW9uIHByZXZlbnRlZCdgIHZhbHVlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IEV2ZW50IG9iamVjdC4KICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSB0b1N0YXRlIFRoZSBzdGF0ZSBiZWluZyB0cmFuc2l0aW9uZWQgdG8uCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRvUGFyYW1zIFRoZSBwYXJhbXMgc3VwcGxpZWQgdG8gdGhlIGB0b1N0YXRlYC4KICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSBmcm9tU3RhdGUgVGhlIGN1cnJlbnQgc3RhdGUsIHByZS10cmFuc2l0aW9uLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmcm9tUGFyYW1zIFRoZSBwYXJhbXMgc3VwcGxpZWQgdG8gdGhlIGBmcm9tU3RhdGVgLgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgKgogICAgICAgICAqIDxwcmU+CiAgICAgICAgICogJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN0YXJ0JywKICAgICAgICAgKiBmdW5jdGlvbihldmVudCwgdG9TdGF0ZSwgdG9QYXJhbXMsIGZyb21TdGF0ZSwgZnJvbVBhcmFtcyl7CiAgICAgICAgICogICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICogICAgIC8vIHRyYW5zaXRpb25UbygpIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoCiAgICAgICAgICogICAgIC8vIGEgJ3RyYW5zaXRpb24gcHJldmVudGVkJyBlcnJvcgogICAgICAgICAqIH0pCiAgICAgICAgICogPC9wcmU+CiAgICAgICAgICovCiAgICAgICAgZXZ0ID0gJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckc3RhdGVDaGFuZ2VTdGFydCcsIHRvLnNlbGYsIHRvUGFyYW1zLCBmcm9tLnNlbGYsIGZyb21QYXJhbXMpOwogICAgICAgIGlmIChldnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgc3luY1VybCgpOwogICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25QcmV2ZW50ZWQ7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBSZXNvbHZlIGxvY2FscyBmb3IgdGhlIHJlbWFpbmluZyBzdGF0ZXMsIGJ1dCBkb24ndCB1cGRhdGUgYW55IGdsb2JhbCBzdGF0ZSBqdXN0CiAgICAgIC8vIHlldCAtLSBpZiBhbnl0aGluZyBmYWlscyB0byByZXNvbHZlIHRoZSBjdXJyZW50IHN0YXRlIG5lZWRzIHRvIHJlbWFpbiB1bnRvdWNoZWQuCiAgICAgIC8vIFdlIGFsc28gc2V0IHVwIGFuIGluaGVyaXRhbmNlIGNoYWluIGZvciB0aGUgbG9jYWxzIGhlcmUuIFRoaXMgYWxsb3dzIHRoZSB2aWV3IGRpcmVjdGl2ZQogICAgICAvLyB0byBxdWlja2x5IGxvb2sgdXAgdGhlIGNvcnJlY3QgZGVmaW5pdGlvbiBmb3IgZWFjaCB2aWV3IGluIHRoZSBjdXJyZW50IHN0YXRlLiBFdmVuCiAgICAgIC8vIHRob3VnaCB3ZSBjcmVhdGUgdGhlIGxvY2FscyBvYmplY3QgaXRzZWxmIG91dHNpZGUgcmVzb2x2ZVN0YXRlKCksIGl0IGlzIGluaXRpYWxseQogICAgICAvLyBlbXB0eSBhbmQgZ2V0cyBmaWxsZWQgYXN5bmNocm9ub3VzbHkuIFdlIG5lZWQgdG8ga2VlcCB0cmFjayBvZiB0aGUgcHJvbWlzZSBmb3IgdGhlCiAgICAgIC8vIChmdWxseSByZXNvbHZlZCkgY3VycmVudCBsb2NhbHMsIGFuZCBwYXNzIHRoaXMgZG93biB0aGUgY2hhaW4uCiAgICAgIHZhciByZXNvbHZlZCA9ICRxLndoZW4obG9jYWxzKTsKICAgICAgZm9yICh2YXIgbD1rZWVwOyBsPHRvUGF0aC5sZW5ndGg7IGwrKywgc3RhdGU9dG9QYXRoW2xdKSB7CiAgICAgICAgbG9jYWxzID0gdG9Mb2NhbHNbbF0gPSBpbmhlcml0KGxvY2Fscyk7CiAgICAgICAgcmVzb2x2ZWQgPSByZXNvbHZlU3RhdGUoc3RhdGUsIHRvUGFyYW1zLCBzdGF0ZT09PXRvLCByZXNvbHZlZCwgbG9jYWxzKTsKICAgICAgfQoKICAgICAgLy8gT25jZSBldmVyeXRoaW5nIGlzIHJlc29sdmVkLCB3ZSBhcmUgcmVhZHkgdG8gcGVyZm9ybSB0aGUgYWN0dWFsIHRyYW5zaXRpb24KICAgICAgLy8gYW5kIHJldHVybiBhIHByb21pc2UgZm9yIHRoZSBuZXcgc3RhdGUuIFdlIGFsc28ga2VlcCB0cmFjayBvZiB3aGF0IHRoZQogICAgICAvLyBjdXJyZW50IHByb21pc2UgaXMsIHNvIHRoYXQgd2UgY2FuIGRldGVjdCBvdmVybGFwcGluZyB0cmFuc2l0aW9ucyBhbmQKICAgICAgLy8ga2VlcCBvbmx5IHRoZSBvdXRjb21lIG9mIHRoZSBsYXN0IHRyYW5zaXRpb24uCiAgICAgIHZhciB0cmFuc2l0aW9uID0gJHN0YXRlLnRyYW5zaXRpb24gPSByZXNvbHZlZC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbCwgZW50ZXJpbmcsIGV4aXRpbmc7CgogICAgICAgIGlmICgkc3RhdGUudHJhbnNpdGlvbiAhPT0gdHJhbnNpdGlvbikgcmV0dXJuIFRyYW5zaXRpb25TdXBlcnNlZGVkOwoKICAgICAgICAvLyBFeGl0ICdmcm9tJyBzdGF0ZXMgbm90IGtlcHQKICAgICAgICBmb3IgKGw9ZnJvbVBhdGgubGVuZ3RoLTE7IGw+PWtlZXA7IGwtLSkgewogICAgICAgICAgZXhpdGluZyA9IGZyb21QYXRoW2xdOwogICAgICAgICAgaWYgKGV4aXRpbmcuc2VsZi5vbkV4aXQpIHsKICAgICAgICAgICAgJGluamVjdG9yLmludm9rZShleGl0aW5nLnNlbGYub25FeGl0LCBleGl0aW5nLnNlbGYsIGV4aXRpbmcubG9jYWxzLmdsb2JhbHMpOwogICAgICAgICAgfQogICAgICAgICAgZXhpdGluZy5sb2NhbHMgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gRW50ZXIgJ3RvJyBzdGF0ZXMgbm90IGtlcHQKICAgICAgICBmb3IgKGw9a2VlcDsgbDx0b1BhdGgubGVuZ3RoOyBsKyspIHsKICAgICAgICAgIGVudGVyaW5nID0gdG9QYXRoW2xdOwogICAgICAgICAgZW50ZXJpbmcubG9jYWxzID0gdG9Mb2NhbHNbbF07CiAgICAgICAgICBpZiAoZW50ZXJpbmcuc2VsZi5vbkVudGVyKSB7CiAgICAgICAgICAgICRpbmplY3Rvci5pbnZva2UoZW50ZXJpbmcuc2VsZi5vbkVudGVyLCBlbnRlcmluZy5zZWxmLCBlbnRlcmluZy5sb2NhbHMuZ2xvYmFscyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBSdW4gaXQgYWdhaW4sIHRvIGNhdGNoIGFueSB0cmFuc2l0aW9ucyBpbiBjYWxsYmFja3MKICAgICAgICBpZiAoJHN0YXRlLnRyYW5zaXRpb24gIT09IHRyYW5zaXRpb24pIHJldHVybiBUcmFuc2l0aW9uU3VwZXJzZWRlZDsKCiAgICAgICAgLy8gVXBkYXRlIGdsb2JhbHMgaW4gJHN0YXRlCiAgICAgICAgJHN0YXRlLiRjdXJyZW50ID0gdG87CiAgICAgICAgJHN0YXRlLmN1cnJlbnQgPSB0by5zZWxmOwogICAgICAgICRzdGF0ZS5wYXJhbXMgPSB0b1BhcmFtczsKICAgICAgICBjb3B5KCRzdGF0ZS5wYXJhbXMsICRzdGF0ZVBhcmFtcyk7CiAgICAgICAgJHN0YXRlLnRyYW5zaXRpb24gPSBudWxsOwoKICAgICAgICAvLyBVcGRhdGUgJGxvY2F0aW9uCiAgICAgICAgdmFyIHRvTmF2ID0gdG8ubmF2aWdhYmxlOwogICAgICAgIGlmIChvcHRpb25zLmxvY2F0aW9uICYmIHRvTmF2KSB7CiAgICAgICAgICAkbG9jYXRpb24udXJsKHRvTmF2LnVybC5mb3JtYXQodG9OYXYubG9jYWxzLmdsb2JhbHMuJHN0YXRlUGFyYW1zKSk7CgogICAgICAgICAgaWYgKG9wdGlvbnMubG9jYXRpb24gPT09ICdyZXBsYWNlJykgewogICAgICAgICAgICAkbG9jYXRpb24ucmVwbGFjZSgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnMubm90aWZ5KSB7CiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSMkc3RhdGVDaGFuZ2VTdWNjZXNzCiAgICAgICAgICogQGV2ZW50T2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBGaXJlZCBvbmNlIHRoZSBzdGF0ZSB0cmFuc2l0aW9uIGlzICoqY29tcGxldGUqKi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBFdmVudCBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gdG9TdGF0ZSBUaGUgc3RhdGUgYmVpbmcgdHJhbnNpdGlvbmVkIHRvLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0b1BhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgdG9TdGF0ZWAuCiAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gZnJvbVN0YXRlIFRoZSBjdXJyZW50IHN0YXRlLCBwcmUtdHJhbnNpdGlvbi4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZnJvbVBhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgZnJvbVN0YXRlYC4KICAgICAgICAgKi8KICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHN0YXRlQ2hhbmdlU3VjY2VzcycsIHRvLnNlbGYsIHRvUGFyYW1zLCBmcm9tLnNlbGYsIGZyb21QYXJhbXMpOwogICAgICAgIH0KICAgICAgICBjdXJyZW50TG9jYXRpb24gPSAkbG9jYXRpb24udXJsKCk7CgogICAgICAgIHJldHVybiAkc3RhdGUuY3VycmVudDsKICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgaWYgKCRzdGF0ZS50cmFuc2l0aW9uICE9PSB0cmFuc2l0aW9uKSByZXR1cm4gVHJhbnNpdGlvblN1cGVyc2VkZWQ7CgogICAgICAgICRzdGF0ZS50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlIyRzdGF0ZUNoYW5nZUVycm9yCiAgICAgICAgICogQGV2ZW50T2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBGaXJlZCB3aGVuIGFuICoqZXJyb3Igb2NjdXJzKiogZHVyaW5nIHRyYW5zaXRpb24uIEl0J3MgaW1wb3J0YW50IHRvIG5vdGUgdGhhdCBpZiB5b3UKICAgICAgICAgKiBoYXZlIGFueSBlcnJvcnMgaW4geW91ciByZXNvbHZlIGZ1bmN0aW9ucyAoamF2YXNjcmlwdCBlcnJvcnMsIG5vbi1leGlzdGVudCBzZXJ2aWNlcywgZXRjKQogICAgICAgICAqIHRoZXkgd2lsbCBub3QgdGhyb3cgdHJhZGl0aW9uYWxseS4gWW91IG11c3QgbGlzdGVuIGZvciB0aGlzICRzdGF0ZUNoYW5nZUVycm9yIGV2ZW50IHRvCiAgICAgICAgICogY2F0Y2ggKipBTEwqKiBlcnJvcnMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IHRvU3RhdGUgVGhlIHN0YXRlIGJlaW5nIHRyYW5zaXRpb25lZCB0by4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdG9QYXJhbXMgVGhlIHBhcmFtcyBzdXBwbGllZCB0byB0aGUgYHRvU3RhdGVgLgogICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IGZyb21TdGF0ZSBUaGUgY3VycmVudCBzdGF0ZSwgcHJlLXRyYW5zaXRpb24uCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGZyb21QYXJhbXMgVGhlIHBhcmFtcyBzdXBwbGllZCB0byB0aGUgYGZyb21TdGF0ZWAuCiAgICAgICAgICogQHBhcmFtIHtFcnJvcn0gZXJyb3IgVGhlIHJlc29sdmUgZXJyb3Igb2JqZWN0LgogICAgICAgICAqLwogICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHN0YXRlQ2hhbmdlRXJyb3InLCB0by5zZWxmLCB0b1BhcmFtcywgZnJvbS5zZWxmLCBmcm9tUGFyYW1zLCBlcnJvcik7CiAgICAgICAgc3luY1VybCgpOwoKICAgICAgICByZXR1cm4gJHEucmVqZWN0KGVycm9yKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gdHJhbnNpdGlvbjsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjaXMKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaW1pbGFyIHRvIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI21ldGhvZHNfaW5jbHVkZXMgJHN0YXRlLmluY2x1ZGVzfSwKICAgICAqIGJ1dCBvbmx5IGNoZWNrcyBmb3IgdGhlIGZ1bGwgc3RhdGUgbmFtZS4gSWYgcGFyYW1zIGlzIHN1cHBsaWVkIHRoZW4gaXQgd2lsbCBiZSAKICAgICAqIHRlc3RlZCBmb3Igc3RyaWN0IGVxdWFsaXR5IGFnYWluc3QgdGhlIGN1cnJlbnQgYWN0aXZlIHBhcmFtcyBvYmplY3QsIHNvIGFsbCBwYXJhbXMgCiAgICAgKiBtdXN0IG1hdGNoIHdpdGggbm9uZSBtaXNzaW5nIGFuZCBubyBleHRyYXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAkc3RhdGUuaXMoJ2NvbnRhY3QuZGV0YWlscy5pdGVtJyk7IC8vIHJldHVybnMgdHJ1ZQogICAgICogJHN0YXRlLmlzKGNvbnRhY3REZXRhaWxJdGVtU3RhdGVPYmplY3QpOyAvLyByZXR1cm5zIHRydWUKICAgICAqCiAgICAgKiAvLyBldmVyeXRoaW5nIGVsc2Ugd291bGQgcmV0dXJuIGZhbHNlCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IHN0YXRlTmFtZSBUaGUgc3RhdGUgbmFtZSBvciBzdGF0ZSBvYmplY3QgeW91J2QgbGlrZSB0byBjaGVjay4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gcGFyYW1zIEEgcGFyYW0gb2JqZWN0LCBlLmcuIGB7c2VjdGlvbklkOiBzZWN0aW9uLmlkfWAsIHRoYXQgeW91J2QgbGlrZSAKICAgICAqIHRvIHRlc3QgYWdhaW5zdCB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIGl0IGlzIHRoZSBzdGF0ZS4KICAgICAqLwogICAgJHN0YXRlLmlzID0gZnVuY3Rpb24gaXMoc3RhdGVPck5hbWUsIHBhcmFtcykgewogICAgICB2YXIgc3RhdGUgPSBmaW5kU3RhdGUoc3RhdGVPck5hbWUpOwoKICAgICAgaWYgKCFpc0RlZmluZWQoc3RhdGUpKSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgaWYgKCRzdGF0ZS4kY3VycmVudCAhPT0gc3RhdGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiBpc0RlZmluZWQocGFyYW1zKSAmJiBwYXJhbXMgIT09IG51bGwgPyBhbmd1bGFyLmVxdWFscygkc3RhdGVQYXJhbXMsIHBhcmFtcykgOiB0cnVlOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNpbmNsdWRlcwogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgbWV0aG9kIHRvIGRldGVybWluZSBpZiB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUgaXMgZXF1YWwgdG8gb3IgaXMgdGhlIGNoaWxkIG9mIHRoZSAKICAgICAqIHN0YXRlIHN0YXRlTmFtZS4gSWYgYW55IHBhcmFtcyBhcmUgcGFzc2VkIHRoZW4gdGhleSB3aWxsIGJlIHRlc3RlZCBmb3IgYSBtYXRjaCBhcyB3ZWxsLgogICAgICogTm90IGFsbCB0aGUgcGFyYW1ldGVycyBuZWVkIHRvIGJlIHBhc3NlZCwganVzdCB0aGUgb25lcyB5b3UnZCBsaWtlIHRvIHRlc3QgZm9yIGVxdWFsaXR5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiA8cHJlPgogICAgICogJHN0YXRlLiRjdXJyZW50Lm5hbWUgPSAnY29udGFjdHMuZGV0YWlscy5pdGVtJzsKICAgICAqCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImNvbnRhY3RzIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICogJHN0YXRlLmluY2x1ZGVzKCJjb250YWN0cy5kZXRhaWxzIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICogJHN0YXRlLmluY2x1ZGVzKCJjb250YWN0cy5kZXRhaWxzLml0ZW0iKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImNvbnRhY3RzLmxpc3QiKTsgLy8gcmV0dXJucyBmYWxzZQogICAgICogJHN0YXRlLmluY2x1ZGVzKCJhYm91dCIpOyAvLyByZXR1cm5zIGZhbHNlCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEJhc2ljIGdsb2JpbmcgcGF0dGVybnMgd2lsbCBhbHNvIHdvcmsuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAkc3RhdGUuJGN1cnJlbnQubmFtZSA9ICdjb250YWN0cy5kZXRhaWxzLml0ZW0udXJsJzsKICAgICAqCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoIiouZGV0YWlscy4qLioiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoIiouZGV0YWlscy4qKiIpOyAvLyByZXR1cm5zIHRydWUKICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKiouaXRlbS4qKiIpOyAvLyByZXR1cm5zIHRydWUKICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKi5kZXRhaWxzLml0ZW0udXJsIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICogJHN0YXRlLmluY2x1ZGVzKCIqLmRldGFpbHMuKi51cmwiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoIiouZGV0YWlscy4qIik7IC8vIHJldHVybnMgZmFsc2UKICAgICAqICRzdGF0ZS5pbmNsdWRlcygiaXRlbS4qKiIpOyAvLyByZXR1cm5zIGZhbHNlCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RhdGVPck5hbWUgQSBwYXJ0aWFsIG5hbWUgdG8gYmUgc2VhcmNoZWQgZm9yIHdpdGhpbiB0aGUgY3VycmVudCBzdGF0ZSBuYW1lLgogICAgICogQHBhcmFtIHtvYmplY3R9IHBhcmFtcyBBIHBhcmFtIG9iamVjdCwgZS5nLiBge3NlY3Rpb25JZDogc2VjdGlvbi5pZH1gLCAKICAgICAqIHRoYXQgeW91J2QgbGlrZSB0byB0ZXN0IGFnYWluc3QgdGhlIGN1cnJlbnQgYWN0aXZlIHN0YXRlLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBpdCBkb2VzIGluY2x1ZGUgdGhlIHN0YXRlCiAgICAgKi8KCiAgICAkc3RhdGUuaW5jbHVkZXMgPSBmdW5jdGlvbiBpbmNsdWRlcyhzdGF0ZU9yTmFtZSwgcGFyYW1zKSB7CiAgICAgIGlmIChpc1N0cmluZyhzdGF0ZU9yTmFtZSkgJiYgaXNHbG9iKHN0YXRlT3JOYW1lKSkgewogICAgICAgIGlmIChkb2VzU3RhdGVNYXRjaEdsb2Ioc3RhdGVPck5hbWUpKSB7CiAgICAgICAgICBzdGF0ZU9yTmFtZSA9ICRzdGF0ZS4kY3VycmVudC5uYW1lOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgc3RhdGUgPSBmaW5kU3RhdGUoc3RhdGVPck5hbWUpOwogICAgICBpZiAoIWlzRGVmaW5lZChzdGF0ZSkpIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CgogICAgICBpZiAoIWlzRGVmaW5lZCgkc3RhdGUuJGN1cnJlbnQuaW5jbHVkZXNbc3RhdGUubmFtZV0pKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgdmFsaWRQYXJhbXMgPSB0cnVlOwogICAgICBhbmd1bGFyLmZvckVhY2gocGFyYW1zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgaWYgKCFpc0RlZmluZWQoJHN0YXRlUGFyYW1zW2tleV0pIHx8ICRzdGF0ZVBhcmFtc1trZXldICE9PSB2YWx1ZSkgewogICAgICAgICAgdmFsaWRQYXJhbXMgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gdmFsaWRQYXJhbXM7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNocmVmCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSB1cmwgZ2VuZXJhdGlvbiBtZXRob2QgdGhhdCByZXR1cm5zIHRoZSBjb21waWxlZCB1cmwgZm9yIHRoZSBnaXZlbiBzdGF0ZSBwb3B1bGF0ZWQgd2l0aCB0aGUgZ2l2ZW4gcGFyYW1zLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiA8cHJlPgogICAgICogZXhwZWN0KCRzdGF0ZS5ocmVmKCJhYm91dC5wZXJzb24iLCB7IHBlcnNvbjogImJvYiIgfSkpLnRvRXF1YWwoIi9hYm91dC9ib2IiKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gc3RhdGVPck5hbWUgVGhlIHN0YXRlIG5hbWUgb3Igc3RhdGUgb2JqZWN0IHlvdSdkIGxpa2UgdG8gZ2VuZXJhdGUgYSB1cmwgZnJvbS4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gcGFyYW1zIEFuIG9iamVjdCBvZiBwYXJhbWV0ZXIgdmFsdWVzIHRvIGZpbGwgdGhlIHN0YXRlJ3MgcmVxdWlyZWQgcGFyYW1ldGVycy4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdC4gVGhlIG9wdGlvbnMgYXJlOgogICAgICoKICAgICAqIC0gKipgbG9zc3lgKiogLSB7Ym9vbGVhbj10cnVlfSAtICBJZiB0cnVlLCBhbmQgaWYgdGhlcmUgaXMgbm8gdXJsIGFzc29jaWF0ZWQgd2l0aCB0aGUgc3RhdGUgcHJvdmlkZWQgaW4gdGhlCiAgICAgKiAgICBmaXJzdCBwYXJhbWV0ZXIsIHRoZW4gdGhlIGNvbnN0cnVjdGVkIGhyZWYgdXJsIHdpbGwgYmUgYnVpbHQgZnJvbSB0aGUgZmlyc3QgbmF2aWdhYmxlIGFuY2VzdG9yIChha2EKICAgICAqICAgIGFuY2VzdG9yIHdpdGggYSB2YWxpZCB1cmwpLgogICAgICogLSAqKmBpbmhlcml0YCoqIC0ge2Jvb2xlYW49ZmFsc2V9LCBJZiBgdHJ1ZWAgd2lsbCBpbmhlcml0IHVybCBwYXJhbWV0ZXJzIGZyb20gY3VycmVudCB1cmwuCiAgICAgKiAtICoqYHJlbGF0aXZlYCoqIC0ge29iamVjdD0kc3RhdGUuJGN1cnJlbnR9LCBXaGVuIHRyYW5zaXRpb25pbmcgd2l0aCByZWxhdGl2ZSBwYXRoIChlLmcgJ14nKSwgCiAgICAgKiAgICBkZWZpbmVzIHdoaWNoIHN0YXRlIHRvIGJlIHJlbGF0aXZlIGZyb20uCiAgICAgKiAtICoqYGFic29sdXRlYCoqIC0ge2Jvb2xlYW49ZmFsc2V9LCAgSWYgdHJ1ZSB3aWxsIGdlbmVyYXRlIGFuIGFic29sdXRlIHVybCwgZS5nLiAiaHR0cDovL3d3dy5leGFtcGxlLmNvbS9mdWxsdXJsIi4KICAgICAqIAogICAgICogQHJldHVybnMge3N0cmluZ30gY29tcGlsZWQgc3RhdGUgdXJsCiAgICAgKi8KICAgICRzdGF0ZS5ocmVmID0gZnVuY3Rpb24gaHJlZihzdGF0ZU9yTmFtZSwgcGFyYW1zLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBleHRlbmQoeyBsb3NzeTogdHJ1ZSwgaW5oZXJpdDogZmFsc2UsIGFic29sdXRlOiBmYWxzZSwgcmVsYXRpdmU6ICRzdGF0ZS4kY3VycmVudCB9LCBvcHRpb25zIHx8IHt9KTsKICAgICAgdmFyIHN0YXRlID0gZmluZFN0YXRlKHN0YXRlT3JOYW1lLCBvcHRpb25zLnJlbGF0aXZlKTsKICAgICAgaWYgKCFpc0RlZmluZWQoc3RhdGUpKSByZXR1cm4gbnVsbDsKCiAgICAgIHBhcmFtcyA9IGluaGVyaXRQYXJhbXMoJHN0YXRlUGFyYW1zLCBwYXJhbXMgfHwge30sICRzdGF0ZS4kY3VycmVudCwgc3RhdGUpOwogICAgICB2YXIgbmF2ID0gKHN0YXRlICYmIG9wdGlvbnMubG9zc3kpID8gc3RhdGUubmF2aWdhYmxlIDogc3RhdGU7CiAgICAgIHZhciB1cmwgPSAobmF2ICYmIG5hdi51cmwpID8gbmF2LnVybC5mb3JtYXQobm9ybWFsaXplKHN0YXRlLnBhcmFtcywgcGFyYW1zIHx8IHt9KSkgOiBudWxsOwogICAgICBpZiAoISRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSgpICYmIHVybCkgewogICAgICAgIHVybCA9ICIjIiArICRsb2NhdGlvblByb3ZpZGVyLmhhc2hQcmVmaXgoKSArIHVybDsKICAgICAgfQoKICAgICAgaWYgKGJhc2VIcmVmICE9PSAnLycpIHsKICAgICAgICBpZiAoJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKCkpIHsKICAgICAgICAgIHVybCA9IGJhc2VIcmVmLnNsaWNlKDAsIC0xKSArIHVybDsKICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuYWJzb2x1dGUpewogICAgICAgICAgdXJsID0gYmFzZUhyZWYuc2xpY2UoMSkgKyB1cmw7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5hYnNvbHV0ZSAmJiB1cmwpIHsKICAgICAgICB1cmwgPSAkbG9jYXRpb24ucHJvdG9jb2woKSArICc6Ly8nICsgCiAgICAgICAgICAgICAgJGxvY2F0aW9uLmhvc3QoKSArIAogICAgICAgICAgICAgICgkbG9jYXRpb24ucG9ydCgpID09IDgwIHx8ICRsb2NhdGlvbi5wb3J0KCkgPT0gNDQzID8gJycgOiAnOicgKyAkbG9jYXRpb24ucG9ydCgpKSArIAogICAgICAgICAgICAgICghJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKCkgJiYgdXJsID8gJy8nIDogJycpICsgCiAgICAgICAgICAgICAgdXJsOwogICAgICB9CiAgICAgIHJldHVybiB1cmw7CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI2dldAogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybnMgdGhlIHN0YXRlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBhbnkgc3BlY2lmaWMgc3RhdGUgb3IgYWxsIHN0YXRlcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3Q9fSBzdGF0ZU9yTmFtZSBJZiBwcm92aWRlZCwgd2lsbCBvbmx5IGdldCB0aGUgY29uZmlnIGZvcgogICAgICogdGhlIHJlcXVlc3RlZCBzdGF0ZS4gSWYgbm90IHByb3ZpZGVkLCByZXR1cm5zIGFuIGFycmF5IG9mIEFMTCBzdGF0ZSBjb25maWdzLgogICAgICogQHJldHVybnMge29iamVjdHxhcnJheX0gU3RhdGUgY29uZmlndXJhdGlvbiBvYmplY3Qgb3IgYXJyYXkgb2YgYWxsIG9iamVjdHMuCiAgICAgKi8KICAgICRzdGF0ZS5nZXQgPSBmdW5jdGlvbiAoc3RhdGVPck5hbWUsIGNvbnRleHQpIHsKICAgICAgaWYgKCFpc0RlZmluZWQoc3RhdGVPck5hbWUpKSB7CiAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICBmb3JFYWNoKHN0YXRlcywgZnVuY3Rpb24oc3RhdGUpIHsgbGlzdC5wdXNoKHN0YXRlLnNlbGYpOyB9KTsKICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgfQogICAgICB2YXIgc3RhdGUgPSBmaW5kU3RhdGUoc3RhdGVPck5hbWUsIGNvbnRleHQpOwogICAgICByZXR1cm4gKHN0YXRlICYmIHN0YXRlLnNlbGYpID8gc3RhdGUuc2VsZiA6IG51bGw7CiAgICB9OwoKICAgIGZ1bmN0aW9uIHJlc29sdmVTdGF0ZShzdGF0ZSwgcGFyYW1zLCBwYXJhbXNBcmVGaWx0ZXJlZCwgaW5oZXJpdGVkLCBkc3QpIHsKICAgICAgLy8gTWFrZSBhIHJlc3RyaWN0ZWQgJHN0YXRlUGFyYW1zIHdpdGggb25seSB0aGUgcGFyYW1ldGVycyB0aGF0IGFwcGx5IHRvIHRoaXMgc3RhdGUgaWYKICAgICAgLy8gbmVjZXNzYXJ5LiBJbiBhZGRpdGlvbiB0byBiZWluZyBhdmFpbGFibGUgdG8gdGhlIGNvbnRyb2xsZXIgYW5kIG9uRW50ZXIvb25FeGl0IGNhbGxiYWNrcywKICAgICAgLy8gd2UgYWxzbyBuZWVkICRzdGF0ZVBhcmFtcyB0byBiZSBhdmFpbGFibGUgZm9yIGFueSAkaW5qZWN0b3IgY2FsbHMgd2UgbWFrZSBkdXJpbmcgdGhlCiAgICAgIC8vIGRlcGVuZGVuY3kgcmVzb2x1dGlvbiBwcm9jZXNzLgogICAgICB2YXIgJHN0YXRlUGFyYW1zID0gKHBhcmFtc0FyZUZpbHRlcmVkKSA/IHBhcmFtcyA6IGZpbHRlckJ5S2V5cyhzdGF0ZS5wYXJhbXMsIHBhcmFtcyk7CiAgICAgIHZhciBsb2NhbHMgPSB7ICRzdGF0ZVBhcmFtczogJHN0YXRlUGFyYW1zIH07CgogICAgICAvLyBSZXNvbHZlICdnbG9iYWwnIGRlcGVuZGVuY2llcyBmb3IgdGhlIHN0YXRlLCBpLmUuIHRob3NlIG5vdCBzcGVjaWZpYyB0byBhIHZpZXcuCiAgICAgIC8vIFdlJ3JlIGFsc28gaW5jbHVkaW5nICRzdGF0ZVBhcmFtcyBpbiB0aGlzOyB0aGF0IHdheSB0aGUgcGFyYW1ldGVycyBhcmUgcmVzdHJpY3RlZAogICAgICAvLyB0byB0aGUgc2V0IHRoYXQgc2hvdWxkIGJlIHZpc2libGUgdG8gdGhlIHN0YXRlLCBhbmQgYXJlIGluZGVwZW5kZW50IG9mIHdoZW4gd2UgdXBkYXRlCiAgICAgIC8vIHRoZSBnbG9iYWwgJHN0YXRlIGFuZCAkc3RhdGVQYXJhbXMgdmFsdWVzLgogICAgICBkc3QucmVzb2x2ZSA9ICRyZXNvbHZlLnJlc29sdmUoc3RhdGUucmVzb2x2ZSwgbG9jYWxzLCBkc3QucmVzb2x2ZSwgc3RhdGUpOwogICAgICB2YXIgcHJvbWlzZXMgPSBbIGRzdC5yZXNvbHZlLnRoZW4oZnVuY3Rpb24gKGdsb2JhbHMpIHsKICAgICAgICBkc3QuZ2xvYmFscyA9IGdsb2JhbHM7CiAgICAgIH0pIF07CiAgICAgIGlmIChpbmhlcml0ZWQpIHByb21pc2VzLnB1c2goaW5oZXJpdGVkKTsKCiAgICAgIC8vIFJlc29sdmUgdGVtcGxhdGUgYW5kIGRlcGVuZGVuY2llcyBmb3IgYWxsIHZpZXdzLgogICAgICBmb3JFYWNoKHN0YXRlLnZpZXdzLCBmdW5jdGlvbiAodmlldywgbmFtZSkgewogICAgICAgIHZhciBpbmplY3RhYmxlcyA9ICh2aWV3LnJlc29sdmUgJiYgdmlldy5yZXNvbHZlICE9PSBzdGF0ZS5yZXNvbHZlID8gdmlldy5yZXNvbHZlIDoge30pOwogICAgICAgIGluamVjdGFibGVzLiR0ZW1wbGF0ZSA9IFsgZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICR2aWV3LmxvYWQobmFtZSwgeyB2aWV3OiB2aWV3LCBsb2NhbHM6IGxvY2FscywgcGFyYW1zOiAkc3RhdGVQYXJhbXMsIG5vdGlmeTogZmFsc2UgfSkgfHwgJyc7CiAgICAgICAgfV07CgogICAgICAgIHByb21pc2VzLnB1c2goJHJlc29sdmUucmVzb2x2ZShpbmplY3RhYmxlcywgbG9jYWxzLCBkc3QucmVzb2x2ZSwgc3RhdGUpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgLy8gUmVmZXJlbmNlcyB0byB0aGUgY29udHJvbGxlciAob25seSBpbnN0YW50aWF0ZWQgYXQgbGluayB0aW1lKQogICAgICAgICAgaWYgKGlzRnVuY3Rpb24odmlldy5jb250cm9sbGVyUHJvdmlkZXIpIHx8IGlzQXJyYXkodmlldy5jb250cm9sbGVyUHJvdmlkZXIpKSB7CiAgICAgICAgICAgIHZhciBpbmplY3RMb2NhbHMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgaW5qZWN0YWJsZXMsIGxvY2Fscyk7CiAgICAgICAgICAgIHJlc3VsdC4kJGNvbnRyb2xsZXIgPSAkaW5qZWN0b3IuaW52b2tlKHZpZXcuY29udHJvbGxlclByb3ZpZGVyLCBudWxsLCBpbmplY3RMb2NhbHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0LiQkY29udHJvbGxlciA9IHZpZXcuY29udHJvbGxlcjsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFByb3ZpZGUgYWNjZXNzIHRvIHRoZSBzdGF0ZSBpdHNlbGYgZm9yIGludGVybmFsIHVzZQogICAgICAgICAgcmVzdWx0LiQkc3RhdGUgPSBzdGF0ZTsKICAgICAgICAgIHJlc3VsdC4kJGNvbnRyb2xsZXJBcyA9IHZpZXcuY29udHJvbGxlckFzOwogICAgICAgICAgZHN0W25hbWVdID0gcmVzdWx0OwogICAgICAgIH0pKTsKICAgICAgfSk7CgogICAgICAvLyBXYWl0IGZvciBhbGwgdGhlIHByb21pc2VzIGFuZCB0aGVuIHJldHVybiB0aGUgYWN0aXZhdGlvbiBvYmplY3QKICAgICAgcmV0dXJuICRxLmFsbChwcm9taXNlcykudGhlbihmdW5jdGlvbiAodmFsdWVzKSB7CiAgICAgICAgcmV0dXJuIGRzdDsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuICRzdGF0ZTsKICB9CgogIGZ1bmN0aW9uIHNob3VsZFRyaWdnZXJSZWxvYWQodG8sIGZyb20sIGxvY2Fscywgb3B0aW9ucykgewogICAgaWYgKCB0byA9PT0gZnJvbSAmJiAoKGxvY2FscyA9PT0gZnJvbS5sb2NhbHMgJiYgIW9wdGlvbnMucmVsb2FkKSB8fCAodG8uc2VsZi5yZWxvYWRPblNlYXJjaCA9PT0gZmFsc2UpKSApIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykKICAudmFsdWUoJyRzdGF0ZVBhcmFtcycsIHt9KQogIC5wcm92aWRlcignJHN0YXRlJywgJFN0YXRlUHJvdmlkZXIpOwoKCiRWaWV3UHJvdmlkZXIuJGluamVjdCA9IFtdOwpmdW5jdGlvbiAkVmlld1Byb3ZpZGVyKCkgewoKICB0aGlzLiRnZXQgPSAkZ2V0OwogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHZpZXcKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5CiAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICovCiAgJGdldC4kaW5qZWN0ID0gWyckcm9vdFNjb3BlJywgJyR0ZW1wbGF0ZUZhY3RvcnknXTsKICBmdW5jdGlvbiAkZ2V0KCAgICRyb290U2NvcGUsICAgJHRlbXBsYXRlRmFjdG9yeSkgewogICAgcmV0dXJuIHsKICAgICAgLy8gJHZpZXcubG9hZCgnZnVsbC52aWV3TmFtZScsIHsgdGVtcGxhdGU6IC4uLiwgY29udHJvbGxlcjogLi4uLCByZXNvbHZlOiAuLi4sIGFzeW5jOiBmYWxzZSwgcGFyYW1zOiAuLi4gfSkKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHZpZXcjbG9hZAogICAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiR2aWV3CiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBuYW1lCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIG9wdGlvbiBvYmplY3QuCiAgICAgICAqLwogICAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgcmVzdWx0LCBkZWZhdWx0cyA9IHsKICAgICAgICAgIHRlbXBsYXRlOiBudWxsLCBjb250cm9sbGVyOiBudWxsLCB2aWV3OiBudWxsLCBsb2NhbHM6IG51bGwsIG5vdGlmeTogdHJ1ZSwgYXN5bmM6IHRydWUsIHBhcmFtczoge30KICAgICAgICB9OwogICAgICAgIG9wdGlvbnMgPSBleHRlbmQoZGVmYXVsdHMsIG9wdGlvbnMpOwoKICAgICAgICBpZiAob3B0aW9ucy52aWV3KSB7CiAgICAgICAgICByZXN1bHQgPSAkdGVtcGxhdGVGYWN0b3J5LmZyb21Db25maWcob3B0aW9ucy52aWV3LCBvcHRpb25zLnBhcmFtcywgb3B0aW9ucy5sb2NhbHMpOwogICAgICAgIH0KICAgICAgICBpZiAocmVzdWx0ICYmIG9wdGlvbnMubm90aWZ5KSB7CiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSMkdmlld0NvbnRlbnRMb2FkaW5nCiAgICAgICAgICogQGV2ZW50T2YgdWkucm91dGVyLnN0YXRlLiR2aWV3CiAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqCiAgICAgICAgICogRmlyZWQgb25jZSB0aGUgdmlldyAqKmJlZ2lucyBsb2FkaW5nKiosICpiZWZvcmUqIHRoZSBET00gaXMgcmVuZGVyZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB2aWV3Q29uZmlnIFRoZSB2aWV3IGNvbmZpZyBwcm9wZXJ0aWVzICh0ZW1wbGF0ZSwgY29udHJvbGxlciwgZXRjKS4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICoKICAgICAgICAgKiA8cHJlPgogICAgICAgICAqICRzY29wZS4kb24oJyR2aWV3Q29udGVudExvYWRpbmcnLAogICAgICAgICAqIGZ1bmN0aW9uKGV2ZW50LCB2aWV3Q29uZmlnKXsKICAgICAgICAgKiAgICAgLy8gQWNjZXNzIHRvIGFsbCB0aGUgdmlldyBjb25maWcgcHJvcGVydGllcy4KICAgICAgICAgKiAgICAgLy8gYW5kIG9uZSBzcGVjaWFsIHByb3BlcnR5ICd0YXJnZXRWaWV3JwogICAgICAgICAqICAgICAvLyB2aWV3Q29uZmlnLnRhcmdldFZpZXcKICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgKi8KICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHZpZXdDb250ZW50TG9hZGluZycsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KfQoKYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpLnByb3ZpZGVyKCckdmlldycsICRWaWV3UHJvdmlkZXIpOwoKLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGxQcm92aWRlcgogKgogKiBAZGVzY3JpcHRpb24KICogUHJvdmlkZXIgdGhhdCByZXR1cm5zIHRoZSB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGx9IHNlcnZpY2UgZnVuY3Rpb24uCiAqLwpmdW5jdGlvbiAkVmlld1Njcm9sbFByb3ZpZGVyKCkgewoKICB2YXIgdXNlQW5jaG9yU2Nyb2xsID0gZmFsc2U7CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsUHJvdmlkZXIjdXNlQW5jaG9yU2Nyb2xsCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsUHJvdmlkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldmVydHMgYmFjayB0byB1c2luZyB0aGUgY29yZSBbYCRhbmNob3JTY3JvbGxgXShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy4kYW5jaG9yU2Nyb2xsKSBzZXJ2aWNlIGZvcgogICAqIHNjcm9sbGluZyBiYXNlZCBvbiB0aGUgdXJsIGFuY2hvci4KICAgKi8KICB0aGlzLnVzZUFuY2hvclNjcm9sbCA9IGZ1bmN0aW9uICgpIHsKICAgIHVzZUFuY2hvclNjcm9sbCA9IHRydWU7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsCiAgICoKICAgKiBAcmVxdWlyZXMgJGFuY2hvclNjcm9sbAogICAqIEByZXF1aXJlcyAkdGltZW91dAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogV2hlbiBjYWxsZWQgd2l0aCBhIGpxTGl0ZSBlbGVtZW50LCBpdCBzY3JvbGxzIHRoZSBlbGVtZW50IGludG8gdmlldyAoYWZ0ZXIgYQogICAqIGAkdGltZW91dGAgc28gdGhlIERPTSBoYXMgdGltZSB0byByZWZyZXNoKS4KICAgKgogICAqIElmIHlvdSBwcmVmZXIgdG8gcmVseSBvbiBgJGFuY2hvclNjcm9sbGAgdG8gc2Nyb2xsIHRoZSB2aWV3IHRvIHRoZSBhbmNob3IsCiAgICogdGhpcyBjYW4gYmUgZW5hYmxlZCBieSBjYWxsaW5nIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbFByb3ZpZGVyI21ldGhvZHNfdXNlQW5jaG9yU2Nyb2xsIGAkdWlWaWV3U2Nyb2xsUHJvdmlkZXIudXNlQW5jaG9yU2Nyb2xsKClgfS4KICAgKi8KICB0aGlzLiRnZXQgPSBbJyRhbmNob3JTY3JvbGwnLCAnJHRpbWVvdXQnLCBmdW5jdGlvbiAoJGFuY2hvclNjcm9sbCwgJHRpbWVvdXQpIHsKICAgIGlmICh1c2VBbmNob3JTY3JvbGwpIHsKICAgICAgcmV0dXJuICRhbmNob3JTY3JvbGw7CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uICgkZWxlbWVudCkgewogICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgJGVsZW1lbnRbMF0uc2Nyb2xsSW50b1ZpZXcoKTsKICAgICAgfSwgMCwgZmFsc2UpOwogICAgfTsKICB9XTsKfQoKYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpLnByb3ZpZGVyKCckdWlWaWV3U2Nyb2xsJywgJFZpZXdTY3JvbGxQcm92aWRlcik7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXZpZXcKICoKICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICogQHJlcXVpcmVzICRjb21waWxlCiAqIEByZXF1aXJlcyAkY29udHJvbGxlcgogKiBAcmVxdWlyZXMgJGluamVjdG9yCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbAogKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAqCiAqIEByZXN0cmljdCBFQ0EKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSB1aS12aWV3IGRpcmVjdGl2ZSB0ZWxscyAkc3RhdGUgd2hlcmUgdG8gcGxhY2UgeW91ciB0ZW1wbGF0ZXMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gdWktdmlldyBBIHZpZXcgbmFtZS4gVGhlIG5hbWUgc2hvdWxkIGJlIHVuaXF1ZSBhbW9uZ3N0IHRoZSBvdGhlciB2aWV3cyBpbiB0aGUKICogc2FtZSBzdGF0ZS4gWW91IGNhbiBoYXZlIHZpZXdzIG9mIHRoZSBzYW1lIG5hbWUgdGhhdCBsaXZlIGluIGRpZmZlcmVudCBzdGF0ZXMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gYXV0b3Njcm9sbCBJdCBhbGxvd3MgeW91IHRvIHNldCB0aGUgc2Nyb2xsIGJlaGF2aW9yIG9mIHRoZSBicm93c2VyIHdpbmRvdwogKiB3aGVuIGEgdmlldyBpcyBwb3B1bGF0ZWQuIEJ5IGRlZmF1bHQsICRhbmNob3JTY3JvbGwgaXMgb3ZlcnJpZGRlbiBieSB1aS1yb3V0ZXIncyBjdXN0b20gc2Nyb2xsCiAqIHNlcnZpY2UsIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbH0uIFRoaXMgY3VzdG9tIHNlcnZpY2UgbGV0J3MgeW91CiAqIHNjcm9sbCB1aS12aWV3IGVsZW1lbnRzIGludG8gdmlldyB3aGVuIHRoZXkgYXJlIHBvcHVsYXRlZCBkdXJpbmcgYSBzdGF0ZSBhY3RpdmF0aW9uLgogKgogKiAqTm90ZTogVG8gcmV2ZXJ0IGJhY2sgdG8gb2xkIFtgJGFuY2hvclNjcm9sbGBdKGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRhbmNob3JTY3JvbGwpCiAqIGZ1bmN0aW9uYWxpdHksIGNhbGwgYCR1aVZpZXdTY3JvbGxQcm92aWRlci51c2VBbmNob3JTY3JvbGwoKWAuKgogKgogKiBAcGFyYW0ge3N0cmluZz19IG9ubG9hZCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW5ldmVyIHRoZSB2aWV3IHVwZGF0ZXMuCiAqIAogKiBAZXhhbXBsZQogKiBBIHZpZXcgY2FuIGJlIHVubmFtZWQgb3IgbmFtZWQuIAogKiA8cHJlPgogKiA8IS0tIFVubmFtZWQgLS0+CiAqIDxkaXYgdWktdmlldz48L2Rpdj4gCiAqIAogKiA8IS0tIE5hbWVkIC0tPgogKiA8ZGl2IHVpLXZpZXc9InZpZXdOYW1lIj48L2Rpdj4KICogPC9wcmU+CiAqCiAqIFlvdSBjYW4gb25seSBoYXZlIG9uZSB1bm5hbWVkIHZpZXcgd2l0aGluIGFueSB0ZW1wbGF0ZSAob3Igcm9vdCBodG1sKS4gSWYgeW91IGFyZSBvbmx5IHVzaW5nIGEgCiAqIHNpbmdsZSB2aWV3IGFuZCBpdCBpcyB1bm5hbWVkIHRoZW4geW91IGNhbiBwb3B1bGF0ZSBpdCBsaWtlIHNvOgogKiA8cHJlPgogKiA8ZGl2IHVpLXZpZXc+PC9kaXY+IAogKiAkc3RhdGVQcm92aWRlci5zdGF0ZSgiaG9tZSIsIHsKICogICB0ZW1wbGF0ZTogIjxoMT5IRUxMTyE8L2gxPiIKICogfSkKICogPC9wcmU+CiAqIAogKiBUaGUgYWJvdmUgaXMgYSBjb252ZW5pZW50IHNob3J0Y3V0IGVxdWl2YWxlbnQgdG8gc3BlY2lmeWluZyB5b3VyIHZpZXcgZXhwbGljaXRseSB3aXRoIHRoZSB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyI3ZpZXdzIGB2aWV3c2B9CiAqIGNvbmZpZyBwcm9wZXJ0eSwgYnkgbmFtZSwgaW4gdGhpcyBjYXNlIGFuIGVtcHR5IG5hbWU6CiAqIDxwcmU+CiAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwgewogKiAgIHZpZXdzOiB7CiAqICAgICAiIjogewogKiAgICAgICB0ZW1wbGF0ZTogIjxoMT5IRUxMTyE8L2gxPiIKICogICAgIH0KICogICB9ICAgIAogKiB9KQogKiA8L3ByZT4KICogCiAqIEJ1dCB0eXBpY2FsbHkgeW91J2xsIG9ubHkgdXNlIHRoZSB2aWV3cyBwcm9wZXJ0eSBpZiB5b3UgbmFtZSB5b3VyIHZpZXcgb3IgaGF2ZSBtb3JlIHRoYW4gb25lIHZpZXcgCiAqIGluIHRoZSBzYW1lIHRlbXBsYXRlLiBUaGVyZSdzIG5vdCByZWFsbHkgYSBjb21wZWxsaW5nIHJlYXNvbiB0byBuYW1lIGEgdmlldyBpZiBpdHMgdGhlIG9ubHkgb25lLCAKICogYnV0IHlvdSBjb3VsZCBpZiB5b3Ugd2FudGVkLCBsaWtlIHNvOgogKiA8cHJlPgogKiA8ZGl2IHVpLXZpZXc9Im1haW4iPjwvZGl2PgogKiA8L3ByZT4gCiAqIDxwcmU+CiAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwgewogKiAgIHZpZXdzOiB7CiAqICAgICAibWFpbiI6IHsKICogICAgICAgdGVtcGxhdGU6ICI8aDE+SEVMTE8hPC9oMT4iCiAqICAgICB9CiAqICAgfSAgICAKICogfSkKICogPC9wcmU+CiAqIAogKiBSZWFsbHkgdGhvdWdoLCB5b3UnbGwgdXNlIHZpZXdzIHRvIHNldCB1cCBtdWx0aXBsZSB2aWV3czoKICogPHByZT4KICogPGRpdiB1aS12aWV3PjwvZGl2PgogKiA8ZGl2IHVpLXZpZXc9ImNoYXJ0Ij48L2Rpdj4gCiAqIDxkaXYgdWktdmlldz0iZGF0YSI+PC9kaXY+IAogKiA8L3ByZT4KICogCiAqIDxwcmU+CiAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwgewogKiAgIHZpZXdzOiB7CiAqICAgICAiIjogewogKiAgICAgICB0ZW1wbGF0ZTogIjxoMT5IRUxMTyE8L2gxPiIKICogICAgIH0sCiAqICAgICAiY2hhcnQiOiB7CiAqICAgICAgIHRlbXBsYXRlOiAiPGNoYXJ0X3RoaW5nLz4iCiAqICAgICB9LAogKiAgICAgImRhdGEiOiB7CiAqICAgICAgIHRlbXBsYXRlOiAiPGRhdGFfdGhpbmcvPiIKICogICAgIH0KICogICB9ICAgIAogKiB9KQogKiA8L3ByZT4KICoKICogRXhhbXBsZXMgZm9yIGBhdXRvc2Nyb2xsYDoKICoKICogPHByZT4KICogPCEtLSBJZiBhdXRvc2Nyb2xsIHByZXNlbnQgd2l0aCBubyBleHByZXNzaW9uLAogKiAgICAgIHRoZW4gc2Nyb2xsIHVpLXZpZXcgaW50byB2aWV3IC0tPgogKiA8dWktdmlldyBhdXRvc2Nyb2xsLz4KICoKICogPCEtLSBJZiBhdXRvc2Nyb2xsIHByZXNlbnQgd2l0aCB2YWxpZCBleHByZXNzaW9uLAogKiAgICAgIHRoZW4gc2Nyb2xsIHVpLXZpZXcgaW50byB2aWV3IGlmIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUgLS0+CiAqIDx1aS12aWV3IGF1dG9zY3JvbGw9J3RydWUnLz4KICogPHVpLXZpZXcgYXV0b3Njcm9sbD0nZmFsc2UnLz4KICogPHVpLXZpZXcgYXV0b3Njcm9sbD0nc2NvcGVWYXJpYWJsZScvPgogKiA8L3ByZT4KICovCiRWaWV3RGlyZWN0aXZlLiRpbmplY3QgPSBbJyRzdGF0ZScsICckaW5qZWN0b3InLCAnJHVpVmlld1Njcm9sbCddOwpmdW5jdGlvbiAkVmlld0RpcmVjdGl2ZSggICAkc3RhdGUsICAgJGluamVjdG9yLCAgICR1aVZpZXdTY3JvbGwpIHsKCiAgZnVuY3Rpb24gZ2V0U2VydmljZSgpIHsKICAgIHJldHVybiAoJGluamVjdG9yLmhhcykgPyBmdW5jdGlvbihzZXJ2aWNlKSB7CiAgICAgIHJldHVybiAkaW5qZWN0b3IuaGFzKHNlcnZpY2UpID8gJGluamVjdG9yLmdldChzZXJ2aWNlKSA6IG51bGw7CiAgICB9IDogZnVuY3Rpb24oc2VydmljZSkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiAkaW5qZWN0b3IuZ2V0KHNlcnZpY2UpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH07CiAgfQoKICB2YXIgc2VydmljZSA9IGdldFNlcnZpY2UoKSwKICAgICAgJGFuaW1hdG9yID0gc2VydmljZSgnJGFuaW1hdG9yJyksCiAgICAgICRhbmltYXRlID0gc2VydmljZSgnJGFuaW1hdGUnKTsKCiAgLy8gUmV0dXJucyBhIHNldCBvZiBET00gbWFuaXB1bGF0aW9uIGZ1bmN0aW9ucyBiYXNlZCBvbiB3aGljaCBBbmd1bGFyIHZlcnNpb24KICAvLyBpdCBzaG91bGQgdXNlCiAgZnVuY3Rpb24gZ2V0UmVuZGVyZXIoYXR0cnMsIHNjb3BlKSB7CiAgICB2YXIgc3RhdGljcyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIGVudGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgdGFyZ2V0LCBjYikgeyB0YXJnZXQuYWZ0ZXIoZWxlbWVudCk7IGNiKCk7IH0sCiAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChlbGVtZW50LCBjYikgeyBlbGVtZW50LnJlbW92ZSgpOyBjYigpOyB9CiAgICAgIH07CiAgICB9OwoKICAgIGlmICgkYW5pbWF0ZSkgewogICAgICByZXR1cm4gewogICAgICAgIGVudGVyOiBmdW5jdGlvbihlbGVtZW50LCB0YXJnZXQsIGNiKSB7ICRhbmltYXRlLmVudGVyKGVsZW1lbnQsIG51bGwsIHRhcmdldCwgY2IpOyB9LAogICAgICAgIGxlYXZlOiBmdW5jdGlvbihlbGVtZW50LCBjYikgeyAkYW5pbWF0ZS5sZWF2ZShlbGVtZW50LCBjYik7IH0KICAgICAgfTsKICAgIH0KCiAgICBpZiAoJGFuaW1hdG9yKSB7CiAgICAgIHZhciBhbmltYXRlID0gJGFuaW1hdG9yICYmICRhbmltYXRvcihzY29wZSwgYXR0cnMpOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBlbnRlcjogZnVuY3Rpb24oZWxlbWVudCwgdGFyZ2V0LCBjYikge2FuaW1hdGUuZW50ZXIoZWxlbWVudCwgbnVsbCwgdGFyZ2V0KTsgY2IoKTsgfSwKICAgICAgICBsZWF2ZTogZnVuY3Rpb24oZWxlbWVudCwgY2IpIHsgYW5pbWF0ZS5sZWF2ZShlbGVtZW50KTsgY2IoKTsgfQogICAgICB9OwogICAgfQoKICAgIHJldHVybiBzdGF0aWNzKCk7CiAgfQoKICB2YXIgZGlyZWN0aXZlID0gewogICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgdGVybWluYWw6IHRydWUsCiAgICBwcmlvcml0eTogNDAwLAogICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgY29tcGlsZTogZnVuY3Rpb24gKHRFbGVtZW50LCB0QXR0cnMsICR0cmFuc2NsdWRlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsICRlbGVtZW50LCBhdHRycykgewogICAgICAgIHZhciBwcmV2aW91c0VsLCBjdXJyZW50RWwsIGN1cnJlbnRTY29wZSwgbGF0ZXN0TG9jYWxzLAogICAgICAgICAgICBvbmxvYWRFeHAgICAgID0gYXR0cnMub25sb2FkIHx8ICcnLAogICAgICAgICAgICBhdXRvU2Nyb2xsRXhwID0gYXR0cnMuYXV0b3Njcm9sbCwKICAgICAgICAgICAgcmVuZGVyZXIgICAgICA9IGdldFJlbmRlcmVyKGF0dHJzLCBzY29wZSk7CgogICAgICAgIHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXBkYXRlVmlldyhmYWxzZSk7CiAgICAgICAgfSk7CiAgICAgICAgc2NvcGUuJG9uKCckdmlld0NvbnRlbnRMb2FkaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1cGRhdGVWaWV3KGZhbHNlKTsKICAgICAgICB9KTsKCiAgICAgICAgdXBkYXRlVmlldyh0cnVlKTsKCiAgICAgICAgZnVuY3Rpb24gY2xlYW51cExhc3RWaWV3KCkgewogICAgICAgICAgaWYgKHByZXZpb3VzRWwpIHsKICAgICAgICAgICAgcHJldmlvdXNFbC5yZW1vdmUoKTsKICAgICAgICAgICAgcHJldmlvdXNFbCA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGN1cnJlbnRTY29wZSkgewogICAgICAgICAgICBjdXJyZW50U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgY3VycmVudFNjb3BlID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY3VycmVudEVsKSB7CiAgICAgICAgICAgIHJlbmRlcmVyLmxlYXZlKGN1cnJlbnRFbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbCA9IG51bGw7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcHJldmlvdXNFbCA9IGN1cnJlbnRFbDsKICAgICAgICAgICAgY3VycmVudEVsID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZpZXcoZmlyc3RUaW1lKSB7CiAgICAgICAgICB2YXIgbmV3U2NvcGUgICAgICAgID0gc2NvcGUuJG5ldygpLAogICAgICAgICAgICAgIG5hbWUgICAgICAgICAgICA9IGN1cnJlbnRFbCAmJiBjdXJyZW50RWwuZGF0YSgnJHVpVmlld05hbWUnKSwKICAgICAgICAgICAgICBwcmV2aW91c0xvY2FscyAgPSBuYW1lICYmICRzdGF0ZS4kY3VycmVudCAmJiAkc3RhdGUuJGN1cnJlbnQubG9jYWxzW25hbWVdOwoKICAgICAgICAgIGlmICghZmlyc3RUaW1lICYmIHByZXZpb3VzTG9jYWxzID09PSBsYXRlc3RMb2NhbHMpIHJldHVybjsgLy8gbm90aGluZyB0byBkbwoKICAgICAgICAgIHZhciBjbG9uZSA9ICR0cmFuc2NsdWRlKG5ld1Njb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICByZW5kZXJlci5lbnRlcihjbG9uZSwgJGVsZW1lbnQsIGZ1bmN0aW9uIG9uVWlWaWV3RW50ZXIoKSB7CiAgICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKGF1dG9TY3JvbGxFeHApICYmICFhdXRvU2Nyb2xsRXhwIHx8IHNjb3BlLiRldmFsKGF1dG9TY3JvbGxFeHApKSB7CiAgICAgICAgICAgICAgICAkdWlWaWV3U2Nyb2xsKGNsb25lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhbnVwTGFzdFZpZXcoKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGxhdGVzdExvY2FscyA9ICRzdGF0ZS4kY3VycmVudC5sb2NhbHNbY2xvbmUuZGF0YSgnJHVpVmlld05hbWUnKV07CgogICAgICAgICAgY3VycmVudEVsID0gY2xvbmU7CiAgICAgICAgICBjdXJyZW50U2NvcGUgPSBuZXdTY29wZTsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXZpZXcjJHZpZXdDb250ZW50TG9hZGVkCiAgICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXZpZXcKICAgICAgICAgICAqIEBldmVudFR5cGUgZW1pdHMgb24gdWktdmlldyBkaXJlY3RpdmUgc2NvcGUKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiAgICAgICAgICAgKgogICAgICAgICAgICogRmlyZWQgb25jZSB0aGUgdmlldyBpcyAqKmxvYWRlZCoqLCAqYWZ0ZXIqIHRoZSBET00gaXMgcmVuZGVyZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IEV2ZW50IG9iamVjdC4KICAgICAgICAgICAqLwogICAgICAgICAgY3VycmVudFNjb3BlLiRlbWl0KCckdmlld0NvbnRlbnRMb2FkZWQnKTsKICAgICAgICAgIGN1cnJlbnRTY29wZS4kZXZhbChvbmxvYWRFeHApOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9OwoKICByZXR1cm4gZGlyZWN0aXZlOwp9CgokVmlld0RpcmVjdGl2ZUZpbGwuJGluamVjdCA9IFsnJGNvbXBpbGUnLCAnJGNvbnRyb2xsZXInLCAnJHN0YXRlJ107CmZ1bmN0aW9uICRWaWV3RGlyZWN0aXZlRmlsbCAoJGNvbXBpbGUsICRjb250cm9sbGVyLCAkc3RhdGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgcHJpb3JpdHk6IC00MDAsCiAgICBjb21waWxlOiBmdW5jdGlvbiAodEVsZW1lbnQpIHsKICAgICAgdmFyIGluaXRpYWwgPSB0RWxlbWVudC5odG1sKCk7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsICRlbGVtZW50LCBhdHRycykgewogICAgICAgIHZhciBuYW1lICAgICAgPSBhdHRycy51aVZpZXcgfHwgYXR0cnMubmFtZSB8fCAnJywKICAgICAgICAgICAgaW5oZXJpdGVkID0gJGVsZW1lbnQuaW5oZXJpdGVkRGF0YSgnJHVpVmlldycpOwoKICAgICAgICBpZiAobmFtZS5pbmRleE9mKCdAJykgPCAwKSB7CiAgICAgICAgICBuYW1lID0gbmFtZSArICdAJyArIChpbmhlcml0ZWQgPyBpbmhlcml0ZWQuc3RhdGUubmFtZSA6ICcnKTsKICAgICAgICB9CgogICAgICAgICRlbGVtZW50LmRhdGEoJyR1aVZpZXdOYW1lJywgbmFtZSk7CgogICAgICAgIHZhciBjdXJyZW50ID0gJHN0YXRlLiRjdXJyZW50LAogICAgICAgICAgICBsb2NhbHMgID0gY3VycmVudCAmJiBjdXJyZW50LmxvY2Fsc1tuYW1lXTsKCiAgICAgICAgaWYgKCEgbG9jYWxzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAkZWxlbWVudC5kYXRhKCckdWlWaWV3JywgeyBuYW1lOiBuYW1lLCBzdGF0ZTogbG9jYWxzLiQkc3RhdGUgfSk7CiAgICAgICAgJGVsZW1lbnQuaHRtbChsb2NhbHMuJHRlbXBsYXRlID8gbG9jYWxzLiR0ZW1wbGF0ZSA6IGluaXRpYWwpOwoKICAgICAgICB2YXIgbGluayA9ICRjb21waWxlKCRlbGVtZW50LmNvbnRlbnRzKCkpOwoKICAgICAgICBpZiAobG9jYWxzLiQkY29udHJvbGxlcikgewogICAgICAgICAgbG9jYWxzLiRzY29wZSA9IHNjb3BlOwogICAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSAkY29udHJvbGxlcihsb2NhbHMuJCRjb250cm9sbGVyLCBsb2NhbHMpOwogICAgICAgICAgaWYgKGxvY2Fscy4kJGNvbnRyb2xsZXJBcykgewogICAgICAgICAgICBzY29wZVtsb2NhbHMuJCRjb250cm9sbGVyQXNdID0gY29udHJvbGxlcjsKICAgICAgICAgIH0KICAgICAgICAgICRlbGVtZW50LmRhdGEoJyRuZ0NvbnRyb2xsZXJDb250cm9sbGVyJywgY29udHJvbGxlcik7CiAgICAgICAgICAkZWxlbWVudC5jaGlsZHJlbigpLmRhdGEoJyRuZ0NvbnRyb2xsZXJDb250cm9sbGVyJywgY29udHJvbGxlcik7CiAgICAgICAgfQoKICAgICAgICBsaW5rKHNjb3BlKTsKICAgICAgfTsKICAgIH0KICB9Owp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykuZGlyZWN0aXZlKCd1aVZpZXcnLCAkVmlld0RpcmVjdGl2ZSk7CmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnKS5kaXJlY3RpdmUoJ3VpVmlldycsICRWaWV3RGlyZWN0aXZlRmlsbCk7CgpmdW5jdGlvbiBwYXJzZVN0YXRlUmVmKHJlZikgewogIHZhciBwYXJzZWQgPSByZWYucmVwbGFjZSgvXG4vZywgIiAiKS5tYXRjaCgvXihbXihdKz8pXHMqKFwoKC4qKVwpKT8kLyk7CiAgaWYgKCFwYXJzZWQgfHwgcGFyc2VkLmxlbmd0aCAhPT0gNCkgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHN0YXRlIHJlZiAnIiArIHJlZiArICInIik7CiAgcmV0dXJuIHsgc3RhdGU6IHBhcnNlZFsxXSwgcGFyYW1FeHByOiBwYXJzZWRbM10gfHwgbnVsbCB9Owp9CgpmdW5jdGlvbiBzdGF0ZUNvbnRleHQoZWwpIHsKICB2YXIgc3RhdGVEYXRhID0gZWwucGFyZW50KCkuaW5oZXJpdGVkRGF0YSgnJHVpVmlldycpOwoKICBpZiAoc3RhdGVEYXRhICYmIHN0YXRlRGF0YS5zdGF0ZSAmJiBzdGF0ZURhdGEuc3RhdGUubmFtZSkgewogICAgcmV0dXJuIHN0YXRlRGF0YS5zdGF0ZTsKICB9Cn0KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktc3JlZgogKgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogKiBAcmVxdWlyZXMgJHRpbWVvdXQKICoKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgZGlyZWN0aXZlIHRoYXQgYmluZHMgYSBsaW5rIChgPGE+YCB0YWcpIHRvIGEgc3RhdGUuIElmIHRoZSBzdGF0ZSBoYXMgYW4gYXNzb2NpYXRlZCAKICogVVJMLCB0aGUgZGlyZWN0aXZlIHdpbGwgYXV0b21hdGljYWxseSBnZW5lcmF0ZSAmIHVwZGF0ZSB0aGUgYGhyZWZgIGF0dHJpYnV0ZSB2aWEgCiAqIHRoZSB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2hyZWYgJHN0YXRlLmhyZWYoKX0gbWV0aG9kLiBDbGlja2luZyAKICogdGhlIGxpbmsgd2lsbCB0cmlnZ2VyIGEgc3RhdGUgdHJhbnNpdGlvbiB3aXRoIG9wdGlvbmFsIHBhcmFtZXRlcnMuIAogKgogKiBBbHNvIG1pZGRsZS1jbGlja2luZywgcmlnaHQtY2xpY2tpbmcsIGFuZCBjdHJsLWNsaWNraW5nIG9uIHRoZSBsaW5rIHdpbGwgYmUgCiAqIGhhbmRsZWQgbmF0aXZlbHkgYnkgdGhlIGJyb3dzZXIuCiAqCiAqIFlvdSBjYW4gYWxzbyB1c2UgcmVsYXRpdmUgc3RhdGUgcGF0aHMgd2l0aGluIHVpLXNyZWYsIGp1c3QgbGlrZSB0aGUgcmVsYXRpdmUgCiAqIHBhdGhzIHBhc3NlZCB0byBgJHN0YXRlLmdvKClgLiBZb3UganVzdCBuZWVkIHRvIGJlIGF3YXJlIHRoYXQgdGhlIHBhdGggaXMgcmVsYXRpdmUKICogdG8gdGhlIHN0YXRlIHRoYXQgdGhlIGxpbmsgbGl2ZXMgaW4sIGluIG90aGVyIHdvcmRzIHRoZSBzdGF0ZSB0aGF0IGxvYWRlZCB0aGUgCiAqIHRlbXBsYXRlIGNvbnRhaW5pbmcgdGhlIGxpbmsuCiAqCiAqIFlvdSBjYW4gc3BlY2lmeSBvcHRpb25zIHRvIHBhc3MgdG8ge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjZ28gJHN0YXRlLmdvKCl9CiAqIHVzaW5nIHRoZSBgdWktc3JlZi1vcHRzYCBhdHRyaWJ1dGUuIE9wdGlvbnMgYXJlIHJlc3RyaWN0ZWQgdG8gYGxvY2F0aW9uYCwgYGluaGVyaXRgLAogKiBhbmQgYHJlbG9hZGAuCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUncyBhbiBleGFtcGxlIG9mIGhvdyB5b3UnZCB1c2UgdWktc3JlZiBhbmQgaG93IGl0IHdvdWxkIGNvbXBpbGUuIElmIHlvdSBoYXZlIHRoZSAKICogZm9sbG93aW5nIHRlbXBsYXRlOgogKiA8cHJlPgogKiA8YSB1aS1zcmVmPSJob21lIj5Ib21lPC9hPiB8IDxhIHVpLXNyZWY9ImFib3V0Ij5BYm91dDwvYT4KICogCiAqIDx1bD4KICogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogKiAgICAgICAgIDxhIHVpLXNyZWY9ImNvbnRhY3RzLmRldGFpbCh7IGlkOiBjb250YWN0LmlkIH0pIj57eyBjb250YWN0Lm5hbWUgfX08L2E+CiAqICAgICA8L2xpPgogKiA8L3VsPgogKiA8L3ByZT4KICogCiAqIFRoZW4gdGhlIGNvbXBpbGVkIGh0bWwgd291bGQgYmUgKGFzc3VtaW5nIEh0bWw1TW9kZSBpcyBvZmYpOgogKiA8cHJlPgogKiA8YSBocmVmPSIjL2hvbWUiIHVpLXNyZWY9ImhvbWUiPkhvbWU8L2E+IHwgPGEgaHJlZj0iIy9hYm91dCIgdWktc3JlZj0iYWJvdXQiPkFib3V0PC9hPgogKiAKICogPHVsPgogKiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAqICAgICAgICAgPGEgaHJlZj0iIy9jb250YWN0cy8xIiB1aS1zcmVmPSJjb250YWN0cy5kZXRhaWwoeyBpZDogY29udGFjdC5pZCB9KSI+Sm9lPC9hPgogKiAgICAgPC9saT4KICogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogKiAgICAgICAgIDxhIGhyZWY9IiMvY29udGFjdHMvMiIgdWktc3JlZj0iY29udGFjdHMuZGV0YWlsKHsgaWQ6IGNvbnRhY3QuaWQgfSkiPkFsaWNlPC9hPgogKiAgICAgPC9saT4KICogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogKiAgICAgICAgIDxhIGhyZWY9IiMvY29udGFjdHMvMyIgdWktc3JlZj0iY29udGFjdHMuZGV0YWlsKHsgaWQ6IGNvbnRhY3QuaWQgfSkiPkJvYjwvYT4KICogICAgIDwvbGk+CiAqIDwvdWw+CiAqCiAqIDxhIHVpLXNyZWY9ImhvbWUiIHVpLXNyZWYtb3B0cz0ie3JlbG9hZDogdHJ1ZX0iPkhvbWU8L2E+CiAqIDwvcHJlPgogKgogKiBAcGFyYW0ge3N0cmluZ30gdWktc3JlZiAnc3RhdGVOYW1lJyBjYW4gYmUgYW55IHZhbGlkIGFic29sdXRlIG9yIHJlbGF0aXZlIHN0YXRlCiAqIEBwYXJhbSB7T2JqZWN0fSB1aS1zcmVmLW9wdHMgb3B0aW9ucyB0byBwYXNzIHRvIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI2dvICRzdGF0ZS5nbygpfQogKi8KJFN0YXRlUmVmRGlyZWN0aXZlLiRpbmplY3QgPSBbJyRzdGF0ZScsICckdGltZW91dCddOwpmdW5jdGlvbiAkU3RhdGVSZWZEaXJlY3RpdmUoJHN0YXRlLCAkdGltZW91dCkgewogIHZhciBhbGxvd2VkT3B0aW9ucyA9IFsnbG9jYXRpb24nLCAnaW5oZXJpdCcsICdyZWxvYWQnXTsKCiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQScsCiAgICByZXF1aXJlOiAnP151aVNyZWZBY3RpdmUnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCB1aVNyZWZBY3RpdmUpIHsKICAgICAgdmFyIHJlZiA9IHBhcnNlU3RhdGVSZWYoYXR0cnMudWlTcmVmKTsKICAgICAgdmFyIHBhcmFtcyA9IG51bGwsIHVybCA9IG51bGwsIGJhc2UgPSBzdGF0ZUNvbnRleHQoZWxlbWVudCkgfHwgJHN0YXRlLiRjdXJyZW50OwogICAgICB2YXIgaXNGb3JtID0gZWxlbWVudFswXS5ub2RlTmFtZSA9PT0gIkZPUk0iOwogICAgICB2YXIgYXR0ciA9IGlzRm9ybSA/ICJhY3Rpb24iIDogImhyZWYiLCBuYXYgPSB0cnVlOwoKICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgcmVsYXRpdmU6IGJhc2UKICAgICAgfTsKICAgICAgdmFyIG9wdGlvbnNPdmVycmlkZSA9IHNjb3BlLiRldmFsKGF0dHJzLnVpU3JlZk9wdHMpIHx8IHt9OwogICAgICBhbmd1bGFyLmZvckVhY2goYWxsb3dlZE9wdGlvbnMsIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgIGlmIChvcHRpb24gaW4gb3B0aW9uc092ZXJyaWRlKSB7CiAgICAgICAgICBvcHRpb25zW29wdGlvbl0gPSBvcHRpb25zT3ZlcnJpZGVbb3B0aW9uXTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgdmFyIHVwZGF0ZSA9IGZ1bmN0aW9uKG5ld1ZhbCkgewogICAgICAgIGlmIChuZXdWYWwpIHBhcmFtcyA9IG5ld1ZhbDsKICAgICAgICBpZiAoIW5hdikgcmV0dXJuOwoKICAgICAgICB2YXIgbmV3SHJlZiA9ICRzdGF0ZS5ocmVmKHJlZi5zdGF0ZSwgcGFyYW1zLCBvcHRpb25zKTsKCiAgICAgICAgaWYgKHVpU3JlZkFjdGl2ZSkgewogICAgICAgICAgdWlTcmVmQWN0aXZlLiQkc2V0U3RhdGVJbmZvKHJlZi5zdGF0ZSwgcGFyYW1zKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFuZXdIcmVmKSB7CiAgICAgICAgICBuYXYgPSBmYWxzZTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZWxlbWVudFswXVthdHRyXSA9IG5ld0hyZWY7CiAgICAgIH07CgogICAgICBpZiAocmVmLnBhcmFtRXhwcikgewogICAgICAgIHNjb3BlLiR3YXRjaChyZWYucGFyYW1FeHByLCBmdW5jdGlvbihuZXdWYWwsIG9sZFZhbCkgewogICAgICAgICAgaWYgKG5ld1ZhbCAhPT0gcGFyYW1zKSB1cGRhdGUobmV3VmFsKTsKICAgICAgICB9LCB0cnVlKTsKICAgICAgICBwYXJhbXMgPSBzY29wZS4kZXZhbChyZWYucGFyYW1FeHByKTsKICAgICAgfQogICAgICB1cGRhdGUoKTsKCiAgICAgIGlmIChpc0Zvcm0pIHJldHVybjsKCiAgICAgIGVsZW1lbnQuYmluZCgiY2xpY2siLCBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIGJ1dHRvbiA9IGUud2hpY2ggfHwgZS5idXR0b247CiAgICAgICAgaWYgKCAhKGJ1dHRvbiA+IDEgfHwgZS5jdHJsS2V5IHx8IGUubWV0YUtleSB8fCBlLnNoaWZ0S2V5IHx8IGVsZW1lbnQuYXR0cigndGFyZ2V0JykpICkgewogICAgICAgICAgLy8gSEFDSzogVGhpcyBpcyB0byBhbGxvdyBuZy1jbGlja3MgdG8gYmUgcHJvY2Vzc2VkIGJlZm9yZSB0aGUgdHJhbnNpdGlvbiBpcyBpbml0aWF0ZWQ6CiAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHN0YXRlLmdvKHJlZi5zdGF0ZSwgcGFyYW1zLCBvcHRpb25zKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgdWkucm91dGVyLnN0YXRlLmRpcmVjdGl2ZTp1aS1zcmVmLWFjdGl2ZQogKgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVBhcmFtcwogKiBAcmVxdWlyZXMgJGludGVycG9sYXRlCiAqCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGRpcmVjdGl2ZSB3b3JraW5nIGFsb25nc2lkZSB1aS1zcmVmIHRvIGFkZCBjbGFzc2VzIHRvIGFuIGVsZW1lbnQgd2hlbiB0aGUgCiAqIHJlbGF0ZWQgdWktc3JlZiBkaXJlY3RpdmUncyBzdGF0ZSBpcyBhY3RpdmUsIGFuZCByZW1vdmluZyB0aGVtIHdoZW4gaXQgaXMgaW5hY3RpdmUuCiAqIFRoZSBwcmltYXJ5IHVzZS1jYXNlIGlzIHRvIHNpbXBsaWZ5IHRoZSBzcGVjaWFsIGFwcGVhcmFuY2Ugb2YgbmF2aWdhdGlvbiBtZW51cyAKICogcmVseWluZyBvbiBgdWktc3JlZmAsIGJ5IGhhdmluZyB0aGUgImFjdGl2ZSIgc3RhdGUncyBtZW51IGJ1dHRvbiBhcHBlYXIgZGlmZmVyZW50LAogKiBkaXN0aW5ndWlzaGluZyBpdCBmcm9tIHRoZSBpbmFjdGl2ZSBtZW51IGl0ZW1zLgogKgogKiBAZXhhbXBsZQogKiBHaXZlbiB0aGUgZm9sbG93aW5nIHRlbXBsYXRlOgogKiA8cHJlPgogKiA8dWw+CiAqICAgPGxpIHVpLXNyZWYtYWN0aXZlPSJhY3RpdmUiIGNsYXNzPSJpdGVtIj4KICogICAgIDxhIGhyZWYgdWktc3JlZj0iYXBwLnVzZXIoe3VzZXI6ICdiaWxib2JhZ2dpbnMnfSkiPkBiaWxib2JhZ2dpbnM8L2E+CiAqICAgPC9saT4KICogPC91bD4KICogPC9wcmU+CiAqIAogKiBXaGVuIHRoZSBhcHAgc3RhdGUgaXMgImFwcC51c2VyIiwgYW5kIGNvbnRhaW5zIHRoZSBzdGF0ZSBwYXJhbWV0ZXIgInVzZXIiIHdpdGggdmFsdWUgImJpbGJvYmFnZ2lucyIsIAogKiB0aGUgcmVzdWx0aW5nIEhUTUwgd2lsbCBhcHBlYXIgYXMgKG5vdGUgdGhlICdhY3RpdmUnIGNsYXNzKToKICogPHByZT4KICogPHVsPgogKiAgIDxsaSB1aS1zcmVmLWFjdGl2ZT0iYWN0aXZlIiBjbGFzcz0iaXRlbSBhY3RpdmUiPgogKiAgICAgPGEgdWktc3JlZj0iYXBwLnVzZXIoe3VzZXI6ICdiaWxib2JhZ2dpbnMnfSkiIGhyZWY9Ii91c2Vycy9iaWxib2JhZ2dpbnMiPkBiaWxib2JhZ2dpbnM8L2E+CiAqICAgPC9saT4KICogPC91bD4KICogPC9wcmU+CiAqIAogKiBUaGUgY2xhc3MgbmFtZSBpcyBpbnRlcnBvbGF0ZWQgKipvbmNlKiogZHVyaW5nIHRoZSBkaXJlY3RpdmVzIGxpbmsgdGltZSAoYW55IGZ1cnRoZXIgY2hhbmdlcyB0byB0aGUgCiAqIGludGVycG9sYXRlZCB2YWx1ZSBhcmUgaWdub3JlZCkuIAogKiAKICogTXVsdGlwbGUgY2xhc3NlcyBtYXkgYmUgc3BlY2lmaWVkIGluIGEgc3BhY2Utc2VwYXJhdGVkIGZvcm1hdDoKICogPHByZT4KICogPHVsPgogKiAgIDxsaSB1aS1zcmVmLWFjdGl2ZT0nY2xhc3MxIGNsYXNzMiBjbGFzczMnPgogKiAgICAgPGEgdWktc3JlZj0iYXBwLnVzZXIiPmxpbms8L2E+CiAqICAgPC9saT4KICogPC91bD4KICogPC9wcmU+CiAqLwokU3RhdGVBY3RpdmVEaXJlY3RpdmUuJGluamVjdCA9IFsnJHN0YXRlJywgJyRzdGF0ZVBhcmFtcycsICckaW50ZXJwb2xhdGUnXTsKZnVuY3Rpb24gJFN0YXRlQWN0aXZlRGlyZWN0aXZlKCRzdGF0ZSwgJHN0YXRlUGFyYW1zLCAkaW50ZXJwb2xhdGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICJBIiwKICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgJyRhdHRycycsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykgewogICAgICB2YXIgc3RhdGUsIHBhcmFtcywgYWN0aXZlQ2xhc3M7CgogICAgICAvLyBUaGVyZSBwcm9iYWJseSBpc24ndCBtdWNoIHBvaW50IGluICRvYnNlcnZpbmcgdGhpcwogICAgICBhY3RpdmVDbGFzcyA9ICRpbnRlcnBvbGF0ZSgkYXR0cnMudWlTcmVmQWN0aXZlIHx8ICcnLCBmYWxzZSkoJHNjb3BlKTsKCiAgICAgIC8vIEFsbG93IHVpU3JlZiB0byBjb21tdW5pY2F0ZSB3aXRoIHVpU3JlZkFjdGl2ZQogICAgICB0aGlzLiQkc2V0U3RhdGVJbmZvID0gZnVuY3Rpb24obmV3U3RhdGUsIG5ld1BhcmFtcykgewogICAgICAgIHN0YXRlID0gJHN0YXRlLmdldChuZXdTdGF0ZSwgc3RhdGVDb250ZXh0KCRlbGVtZW50KSk7CiAgICAgICAgcGFyYW1zID0gbmV3UGFyYW1zOwogICAgICAgIHVwZGF0ZSgpOwogICAgICB9OwoKICAgICAgJHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZSk7CgogICAgICAvLyBVcGRhdGUgcm91dGUgc3RhdGUKICAgICAgZnVuY3Rpb24gdXBkYXRlKCkgewogICAgICAgIGlmICgkc3RhdGUuJGN1cnJlbnQuc2VsZiA9PT0gc3RhdGUgJiYgbWF0Y2hlc1BhcmFtcygpKSB7CiAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhhY3RpdmVDbGFzcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKGFjdGl2ZUNsYXNzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG1hdGNoZXNQYXJhbXMoKSB7CiAgICAgICAgcmV0dXJuICFwYXJhbXMgfHwgZXF1YWxGb3JLZXlzKHBhcmFtcywgJHN0YXRlUGFyYW1zKTsKICAgICAgfQogICAgfV0KICB9Owp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykKICAuZGlyZWN0aXZlKCd1aVNyZWYnLCAkU3RhdGVSZWZEaXJlY3RpdmUpCiAgLmRpcmVjdGl2ZSgndWlTcmVmQWN0aXZlJywgJFN0YXRlQWN0aXZlRGlyZWN0aXZlKTsKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5maWx0ZXI6aXNTdGF0ZQogKgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogVHJhbnNsYXRlcyB0byB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2lzICRzdGF0ZS5pcygic3RhdGVOYW1lIil9LgogKi8KJElzU3RhdGVGaWx0ZXIuJGluamVjdCA9IFsnJHN0YXRlJ107CmZ1bmN0aW9uICRJc1N0YXRlRmlsdGVyKCRzdGF0ZSkgewogIHJldHVybiBmdW5jdGlvbihzdGF0ZSkgewogICAgcmV0dXJuICRzdGF0ZS5pcyhzdGF0ZSk7CiAgfTsKfQoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgdWkucm91dGVyLnN0YXRlLmZpbHRlcjppbmNsdWRlZEJ5U3RhdGUKICoKICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFRyYW5zbGF0ZXMgdG8ge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjbWV0aG9kc19pbmNsdWRlcyAkc3RhdGUuaW5jbHVkZXMoJ2Z1bGxPclBhcnRpYWxTdGF0ZU5hbWUnKX0uCiAqLwokSW5jbHVkZWRCeVN0YXRlRmlsdGVyLiRpbmplY3QgPSBbJyRzdGF0ZSddOwpmdW5jdGlvbiAkSW5jbHVkZWRCeVN0YXRlRmlsdGVyKCRzdGF0ZSkgewogIHJldHVybiBmdW5jdGlvbihzdGF0ZSkgewogICAgcmV0dXJuICRzdGF0ZS5pbmNsdWRlcyhzdGF0ZSk7CiAgfTsKfQoKYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpCiAgLmZpbHRlcignaXNTdGF0ZScsICRJc1N0YXRlRmlsdGVyKQogIC5maWx0ZXIoJ2luY2x1ZGVkQnlTdGF0ZScsICRJbmNsdWRlZEJ5U3RhdGVGaWx0ZXIpOwoKLyoKICogQG5nZG9jIG9iamVjdAogKiBAbmFtZSB1aS5yb3V0ZXIuY29tcGF0LiRyb3V0ZVByb3ZpZGVyCiAqCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUHJvdmlkZXIKICogQHJlcXVpcmVzIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBgJHJvdXRlUHJvdmlkZXJgIG9mIHRoZSBgdWkucm91dGVyLmNvbXBhdGAgbW9kdWxlIG92ZXJ3cml0ZXMgdGhlIGV4aXN0aW5nCiAqIGByb3V0ZVByb3ZpZGVyYCBmcm9tIHRoZSBjb3JlLiBUaGlzIGlzIGRvbmUgdG8gcHJvdmlkZSBjb21wYXRpYmlsaXR5IGJldHdlZW4KICogdGhlIFVJIFJvdXRlciBhbmQgdGhlIGNvcmUgcm91dGVyLgogKgogKiBJdCBhbHNvIHByb3ZpZGVzIGEgYHdoZW4oKWAgbWV0aG9kIHRvIHJlZ2lzdGVyIHJvdXRlcyB0aGF0IG1hcCB0byBjZXJ0YWluIHVybHMuCiAqIEJlaGluZCB0aGUgc2NlbmVzIGl0IGFjdHVhbGx5IGRlbGVnYXRlcyBlaXRoZXIgdG8gCiAqIHtAbGluayB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlciAkdXJsUm91dGVyUHJvdmlkZXJ9IG9yIHRvIHRoZSAKICoge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlciAkc3RhdGVQcm92aWRlcn0gdG8gcG9zdHByb2Nlc3MgdGhlIGdpdmVuIAogKiByb3V0ZXIgZGVmaW5pdGlvbiBvYmplY3QuCiAqLwokUm91dGVQcm92aWRlci4kaW5qZWN0ID0gWyckc3RhdGVQcm92aWRlcicsICckdXJsUm91dGVyUHJvdmlkZXInXTsKZnVuY3Rpb24gJFJvdXRlUHJvdmlkZXIoICAkc3RhdGVQcm92aWRlciwgICAgJHVybFJvdXRlclByb3ZpZGVyKSB7CgogIHZhciByb3V0ZXMgPSBbXTsKCiAgb25FbnRlclJvdXRlLiRpbmplY3QgPSBbJyQkc3RhdGUnXTsKICBmdW5jdGlvbiBvbkVudGVyUm91dGUoICAgJCRzdGF0ZSkgewogICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICB0aGlzLmxvY2FscyA9ICQkc3RhdGUubG9jYWxzLmdsb2JhbHM7CiAgICB0aGlzLnBhcmFtcyA9IHRoaXMubG9jYWxzLiRzdGF0ZVBhcmFtczsKICB9CgogIGZ1bmN0aW9uIG9uRXhpdFJvdXRlKCkgewogICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICB0aGlzLmxvY2FscyA9IG51bGw7CiAgICB0aGlzLnBhcmFtcyA9IG51bGw7CiAgfQoKICB0aGlzLndoZW4gPSB3aGVuOwogIC8qCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLmNvbXBhdC4kcm91dGVQcm92aWRlciN3aGVuCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5jb21wYXQuJHJvdXRlUHJvdmlkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVycyBhIHJvdXRlIHdpdGggYSBnaXZlbiByb3V0ZSBkZWZpbml0aW9uIG9iamVjdC4gVGhlIHJvdXRlIGRlZmluaXRpb24KICAgKiBvYmplY3QgaGFzIHRoZSBzYW1lIGludGVyZmFjZSB0aGUgYW5ndWxhciBjb3JlIHJvdXRlIGRlZmluaXRpb24gb2JqZWN0IGhhcy4KICAgKiAKICAgKiBAZXhhbXBsZQogICAqIDxwcmU+CiAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlci5jb21wYXQnXSk7CiAgICoKICAgKiBhcHAuY29uZmlnKGZ1bmN0aW9uICgkcm91dGVQcm92aWRlcikgewogICAqICAgJHJvdXRlUHJvdmlkZXIud2hlbignaG9tZScsIHsKICAgKiAgICAgY29udHJvbGxlcjogZnVuY3Rpb24gKCkgeyAuLi4gfSwKICAgKiAgICAgdGVtcGxhdGVVcmw6ICdwYXRoL3RvL3RlbXBsYXRlJwogICAqICAgfSk7CiAgICogfSk7CiAgICogPC9wcmU+CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFVSTCBhcyBzdHJpbmcKICAgKiBAcGFyYW0ge29iamVjdH0gcm91dGUgUm91dGUgZGVmaW5pdGlvbiBvYmplY3QKICAgKgogICAqIEByZXR1cm4ge29iamVjdH0gJHJvdXRlUHJvdmlkZXIgLSAkcm91dGVQcm92aWRlciBpbnN0YW5jZQogICAqLwogIGZ1bmN0aW9uIHdoZW4odXJsLCByb3V0ZSkgewogICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICBpZiAocm91dGUucmVkaXJlY3RUbyAhPSBudWxsKSB7CiAgICAgIC8vIFJlZGlyZWN0LCBjb25maWd1cmUgZGlyZWN0bHkgb24gJHVybFJvdXRlclByb3ZpZGVyCiAgICAgIHZhciByZWRpcmVjdCA9IHJvdXRlLnJlZGlyZWN0VG8sIGhhbmRsZXI7CiAgICAgIGlmIChpc1N0cmluZyhyZWRpcmVjdCkpIHsKICAgICAgICBoYW5kbGVyID0gcmVkaXJlY3Q7IC8vIGxlYXZlICR1cmxSb3V0ZXJQcm92aWRlciB0byBoYW5kbGUKICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHJlZGlyZWN0KSkgewogICAgICAgIC8vIEFkYXB0IHRvICR1cmxSb3V0ZXJQcm92aWRlciBBUEkKICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24gKHBhcmFtcywgJGxvY2F0aW9uKSB7CiAgICAgICAgICByZXR1cm4gcmVkaXJlY3QocGFyYW1zLCAkbG9jYXRpb24ucGF0aCgpLCAkbG9jYXRpb24uc2VhcmNoKCkpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkICdyZWRpcmVjdFRvJyBpbiB3aGVuKCkiKTsKICAgICAgfQogICAgICAkdXJsUm91dGVyUHJvdmlkZXIud2hlbih1cmwsIGhhbmRsZXIpOwogICAgfSBlbHNlIHsKICAgICAgLy8gUmVndWxhciByb3V0ZSwgY29uZmlndXJlIGFzIHN0YXRlCiAgICAgICRzdGF0ZVByb3ZpZGVyLnN0YXRlKGluaGVyaXQocm91dGUsIHsKICAgICAgICBwYXJlbnQ6IG51bGwsCiAgICAgICAgbmFtZTogJ3JvdXRlOicgKyBlbmNvZGVVUklDb21wb25lbnQodXJsKSwKICAgICAgICB1cmw6IHVybCwKICAgICAgICBvbkVudGVyOiBvbkVudGVyUm91dGUsCiAgICAgICAgb25FeGl0OiBvbkV4aXRSb3V0ZQogICAgICB9KSk7CiAgICB9CiAgICByb3V0ZXMucHVzaChyb3V0ZSk7CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8qCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5jb21wYXQuJHJvdXRlCiAgICoKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICogQHJlcXVpcmVzICRyb3V0ZVBhcmFtcwogICAqCiAgICogQHByb3BlcnR5IHtvYmplY3R9IHJvdXRlcyAtIEFycmF5IG9mIHJlZ2lzdGVyZWQgcm91dGVzLgogICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBwYXJhbXMgLSBDdXJyZW50IHJvdXRlIHBhcmFtcyBhcyBvYmplY3QuCiAgICogQHByb3BlcnR5IHtzdHJpbmd9IGN1cnJlbnQgLSBOYW1lIG9mIHRoZSBjdXJyZW50IHJvdXRlLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGAkcm91dGVgIHNlcnZpY2UgcHJvdmlkZXMgaW50ZXJmYWNlcyB0byBhY2Nlc3MgZGVmaW5lZCByb3V0ZXMuIEl0IGFsc28gbGV0J3MKICAgKiB5b3UgYWNjZXNzIHJvdXRlIHBhcmFtcyB0aHJvdWdoIGAkcm91dGVQYXJhbXNgIHNlcnZpY2UsIHNvIHlvdSBoYXZlIGZ1bGx5CiAgICogY29udHJvbCBvdmVyIGFsbCB0aGUgc3R1ZmYgeW91IHdvdWxkIGFjdHVhbGx5IGdldCBmcm9tIGFuZ3VsYXIncyBjb3JlIGAkcm91dGVgCiAgICogc2VydmljZS4KICAgKi8KICB0aGlzLiRnZXQgPSAkZ2V0OwogICRnZXQuJGluamVjdCA9IFsnJHN0YXRlJywgJyRyb290U2NvcGUnLCAnJHJvdXRlUGFyYW1zJ107CiAgZnVuY3Rpb24gJGdldCggICAkc3RhdGUsICAgJHJvb3RTY29wZSwgICAkcm91dGVQYXJhbXMpIHsKCiAgICB2YXIgJHJvdXRlID0gewogICAgICByb3V0ZXM6IHJvdXRlcywKICAgICAgcGFyYW1zOiAkcm91dGVQYXJhbXMsCiAgICAgIGN1cnJlbnQ6IHVuZGVmaW5lZAogICAgfTsKCiAgICBmdW5jdGlvbiBzdGF0ZUFzUm91dGUoc3RhdGUpIHsKICAgICAgcmV0dXJuIChzdGF0ZS5uYW1lICE9PSAnJykgPyBzdGF0ZSA6IHVuZGVmaW5lZDsKICAgIH0KCiAgICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3RhcnQnLCBmdW5jdGlvbiAoZXYsIHRvLCB0b1BhcmFtcywgZnJvbSwgZnJvbVBhcmFtcykgewogICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZVN0YXJ0Jywgc3RhdGVBc1JvdXRlKHRvKSwgc3RhdGVBc1JvdXRlKGZyb20pKTsKICAgIH0pOwoKICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24gKGV2LCB0bywgdG9QYXJhbXMsIGZyb20sIGZyb21QYXJhbXMpIHsKICAgICAgJHJvdXRlLmN1cnJlbnQgPSBzdGF0ZUFzUm91dGUodG8pOwogICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZVN1Y2Nlc3MnLCBzdGF0ZUFzUm91dGUodG8pLCBzdGF0ZUFzUm91dGUoZnJvbSkpOwogICAgICBjb3B5KHRvUGFyYW1zLCAkcm91dGUucGFyYW1zKTsKICAgIH0pOwoKICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VFcnJvcicsIGZ1bmN0aW9uIChldiwgdG8sIHRvUGFyYW1zLCBmcm9tLCBmcm9tUGFyYW1zLCBlcnJvcikgewogICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZUVycm9yJywgc3RhdGVBc1JvdXRlKHRvKSwgc3RhdGVBc1JvdXRlKGZyb20pLCBlcnJvcik7CiAgICB9KTsKCiAgICByZXR1cm4gJHJvdXRlOwogIH0KfQoKYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5jb21wYXQnKQogIC5wcm92aWRlcignJHJvdXRlJywgJFJvdXRlUHJvdmlkZXIpCiAgLmRpcmVjdGl2ZSgnbmdWaWV3JywgJFZpZXdEaXJlY3RpdmUpOwp9KSh3aW5kb3csIHdpbmRvdy5hbmd1bGFyKTsKLyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qIQogKiBDb3B5cmlnaHQgMjAxNCBEcmlmdHkgQ28uCiAqIGh0dHA6Ly9kcmlmdHkuY29tLwogKgogKiBJb25pYywgdjEuMC4wLWJldGEuMTIKICogQSBwb3dlcmZ1bCBIVE1MNSBtb2JpbGUgYXBwIGZyYW1ld29yay4KICogaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS8KICoKICogQnkgQG1heGx5bmNoLCBAYmVuanNwZXJyeSwgQGFkYW1kYnJhZGxleSA8MwogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuIFBsZWFzZSBzZWUgTElDRU5TRSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICoKICovCgooZnVuY3Rpb24oKSB7Ci8qCiAqIGRlcHJlY2F0ZWQuanMKICogaHR0cHM6Ly9naXRodWIuY29tL3dlYXJlZnJhY3RhbC9kZXByZWNhdGVkLwogKiBDb3B5cmlnaHQgKGMpIDIwMTQgRnJhY3RhbCA8Y29udGFjdEB3ZWFyZWZyYWN0YWwuY29tPgogKiBMaWNlbnNlIE1JVAogKi8KLy9JbnRlcnZhbCBvYmplY3QKdmFyIGRlcHJlY2F0ZWQgPSB7CiAgbWV0aG9kOiBmdW5jdGlvbihtc2csIGxvZywgZm4pIHsKICAgIHZhciBjYWxsZWQgPSBmYWxzZTsKICAgIHJldHVybiBmdW5jdGlvbiBkZXByZWNhdGVkTWV0aG9kKCl7CiAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICBsb2cobXNnKTsKICAgICAgfQogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfSwKCiAgZmllbGQ6IGZ1bmN0aW9uKG1zZywgbG9nLCBwYXJlbnQsIGZpZWxkLCB2YWwpIHsKICAgIHZhciBjYWxsZWQgPSBmYWxzZTsKICAgIHZhciBnZXR0ZXIgPSBmdW5jdGlvbigpewogICAgICBpZiAoIWNhbGxlZCkgewogICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgbG9nKG1zZyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbDsKICAgIH07CiAgICB2YXIgc2V0dGVyID0gZnVuY3Rpb24odikgewogICAgICBpZiAoIWNhbGxlZCkgewogICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgbG9nKG1zZyk7CiAgICAgIH0KICAgICAgdmFsID0gdjsKICAgICAgcmV0dXJuIHY7CiAgICB9OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHBhcmVudCwgZmllbGQsIHsKICAgICAgZ2V0OiBnZXR0ZXIsCiAgICAgIHNldDogc2V0dGVyLAogICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICB9KTsKICAgIHJldHVybjsKICB9Cn07CgoKdmFyIElvbmljTW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ2lvbmljJywgWyduZ0FuaW1hdGUnLCAnbmdTYW5pdGl6ZScsICd1aS5yb3V0ZXInXSksCiAgZXh0ZW5kID0gYW5ndWxhci5leHRlbmQsCiAgZm9yRWFjaCA9IGFuZ3VsYXIuZm9yRWFjaCwKICBpc0RlZmluZWQgPSBhbmd1bGFyLmlzRGVmaW5lZCwKICBpc1N0cmluZyA9IGFuZ3VsYXIuaXNTdHJpbmcsCiAganFMaXRlID0gYW5ndWxhci5lbGVtZW50OwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNBY3Rpb25TaGVldAogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgQWN0aW9uIFNoZWV0IGlzIGEgc2xpZGUtdXAgcGFuZSB0aGF0IGxldHMgdGhlIHVzZXIgY2hvb3NlIGZyb20gYSBzZXQgb2Ygb3B0aW9ucy4KICogRGFuZ2Vyb3VzIG9wdGlvbnMgYXJlIGhpZ2hsaWdodGVkIGluIHJlZCBhbmQgbWFkZSBvYnZpb3VzLgogKgogKiBUaGVyZSBhcmUgZWFzeSB3YXlzIHRvIGNhbmNlbCBvdXQgb2YgdGhlIGFjdGlvbiBzaGVldCwgc3VjaCBhcyB0YXBwaW5nIHRoZSBiYWNrZHJvcCBvciBldmVuCiAqIGhpdHRpbmcgZXNjYXBlIG9uIHRoZSBrZXlib2FyZCBmb3IgZGVza3RvcCB0ZXN0aW5nLgogKgogKiAhW0FjdGlvbiBTaGVldF0oaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS5zMy5hbWF6b25hd3MuY29tL2RvY3MvY29udHJvbGxlcnMvYWN0aW9uU2hlZXQuZ2lmKQogKgogKiBAdXNhZ2UKICogVG8gdHJpZ2dlciBhbiBBY3Rpb24gU2hlZXQgaW4geW91ciBjb2RlLCB1c2UgdGhlICRpb25pY0FjdGlvblNoZWV0IHNlcnZpY2UgaW4geW91ciBhbmd1bGFyIGNvbnRyb2xsZXJzOgogKgogKiBgYGBqcwogKiBhbmd1bGFyLm1vZHVsZSgnbXlTdXBlckFwcCcsIFsnaW9uaWMnXSkKICogLmNvbnRyb2xsZXIoZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNBY3Rpb25TaGVldCwgJHRpbWVvdXQpIHsKICoKICogIC8vIFRyaWdnZXJlZCBvbiBhIGJ1dHRvbiBjbGljaywgb3Igc29tZSBvdGhlciB0YXJnZXQKICogICRzY29wZS5zaG93ID0gZnVuY3Rpb24oKSB7CiAqCiAqICAgIC8vIFNob3cgdGhlIGFjdGlvbiBzaGVldAogKiAgICB2YXIgaGlkZVNoZWV0ID0gJGlvbmljQWN0aW9uU2hlZXQuc2hvdyh7CiAqICAgICAgYnV0dG9uczogWwogKiAgICAgICAgeyB0ZXh0OiAnPGI+U2hhcmU8L2I+IFRoaXMnIH0sCiAqICAgICAgICB7IHRleHQ6ICdNb3ZlJyB9CiAqICAgICAgXSwKICogICAgICBkZXN0cnVjdGl2ZVRleHQ6ICdEZWxldGUnLAogKiAgICAgIHRpdGxlVGV4dDogJ01vZGlmeSB5b3VyIGFsYnVtJywKICogICAgICBjYW5jZWxUZXh0OiAnQ2FuY2VsJywKICogICAgICBjYW5jZWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gYWRkIGNhbmNlbCBjb2RlLi4KICAgICAgICB9LAogKiAgICAgIGJ1dHRvbkNsaWNrZWQ6IGZ1bmN0aW9uKGluZGV4KSB7CiAqICAgICAgICByZXR1cm4gdHJ1ZTsKICogICAgICB9CiAqICAgIH0pOwogKgogKiAgICAvLyBGb3IgZXhhbXBsZSdzIHNha2UsIGhpZGUgdGhlIHNoZWV0IGFmdGVyIHR3byBzZWNvbmRzCiAqICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgIGhpZGVTaGVldCgpOwogKiAgICB9LCAyMDAwKTsKICoKICogIH07CiAqIH0pOwogKiBgYGAKICoKICovCklvbmljTW9kdWxlCi5mYWN0b3J5KCckaW9uaWNBY3Rpb25TaGVldCcsIFsKICAnJHJvb3RTY29wZScsCiAgJyRjb21waWxlJywKICAnJGFuaW1hdGUnLAogICckdGltZW91dCcsCiAgJyRpb25pY1RlbXBsYXRlTG9hZGVyJywKICAnJGlvbmljUGxhdGZvcm0nLAogICckaW9uaWNCb2R5JywKZnVuY3Rpb24oJHJvb3RTY29wZSwgJGNvbXBpbGUsICRhbmltYXRlLCAkdGltZW91dCwgJGlvbmljVGVtcGxhdGVMb2FkZXIsICRpb25pY1BsYXRmb3JtLCAkaW9uaWNCb2R5KSB7CgogIHJldHVybiB7CiAgICBzaG93OiBhY3Rpb25TaGVldAogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNBY3Rpb25TaGVldCNzaG93CiAgICogQGRlc2NyaXB0aW9uCiAgICogTG9hZCBhbmQgcmV0dXJuIGEgbmV3IGFjdGlvbiBzaGVldC4KICAgKgogICAqIEEgbmV3IGlzb2xhdGVkIHNjb3BlIHdpbGwgYmUgY3JlYXRlZCBmb3IgdGhlCiAgICogYWN0aW9uIHNoZWV0IGFuZCB0aGUgbmV3IGVsZW1lbnQgd2lsbCBiZSBhcHBlbmRlZCBpbnRvIHRoZSBib2R5LgogICAqCiAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHRoaXMgQWN0aW9uU2hlZXQuIFByb3BlcnRpZXM6CiAgICoKICAgKiAgLSBgW09iamVjdF1gIGBidXR0b25zYCBXaGljaCBidXR0b25zIHRvIHNob3cuICBFYWNoIGJ1dHRvbiBpcyBhbiBvYmplY3Qgd2l0aCBhIGB0ZXh0YCBmaWVsZC4KICAgKiAgLSBge3N0cmluZ31gIGB0aXRsZVRleHRgIFRoZSB0aXRsZSB0byBzaG93IG9uIHRoZSBhY3Rpb24gc2hlZXQuCiAgICogIC0gYHtzdHJpbmc9fWAgYGNhbmNlbFRleHRgIHRoZSB0ZXh0IGZvciBhICdjYW5jZWwnIGJ1dHRvbiBvbiB0aGUgYWN0aW9uIHNoZWV0LgogICAqICAtIGB7c3RyaW5nPX1gIGBkZXN0cnVjdGl2ZVRleHRgIFRoZSB0ZXh0IGZvciBhICdkYW5nZXInIG9uIHRoZSBhY3Rpb24gc2hlZXQuCiAgICogIC0gYHtmdW5jdGlvbj19YCBgY2FuY2VsYCBDYWxsZWQgaWYgdGhlIGNhbmNlbCBidXR0b24gaXMgcHJlc3NlZCwgdGhlIGJhY2tkcm9wIGlzIHRhcHBlZCBvcgogICAqICAgICB0aGUgaGFyZHdhcmUgYmFjayBidXR0b24gaXMgcHJlc3NlZC4KICAgKiAgLSBge2Z1bmN0aW9uPX1gIGBidXR0b25DbGlja2VkYCBDYWxsZWQgd2hlbiBvbmUgb2YgdGhlIG5vbi1kZXN0cnVjdGl2ZSBidXR0b25zIGlzIGNsaWNrZWQsCiAgICogICAgIHdpdGggdGhlIGluZGV4IG9mIHRoZSBidXR0b24gdGhhdCB3YXMgY2xpY2tlZCBhbmQgdGhlIGJ1dHRvbiBvYmplY3QuIFJldHVybiB0cnVlIHRvIGNsb3NlCiAgICogICAgIHRoZSBhY3Rpb24gc2hlZXQsIG9yIGZhbHNlIHRvIGtlZXAgaXQgb3BlbmVkLgogICAqICAtIGB7ZnVuY3Rpb249fWAgYGRlc3RydWN0aXZlQnV0dG9uQ2xpY2tlZGAgQ2FsbGVkIHdoZW4gdGhlIGRlc3RydWN0aXZlIGJ1dHRvbiBpcyBjbGlja2VkLgogICAqICAgICBSZXR1cm4gdHJ1ZSB0byBjbG9zZSB0aGUgYWN0aW9uIHNoZWV0LCBvciBmYWxzZSB0byBrZWVwIGl0IG9wZW5lZC4KICAgKiAgLSAgYHtib29sZWFuPX1gIGBjYW5jZWxPblN0YXRlQ2hhbmdlYCBXaGV0aGVyIHRvIGNhbmNlbCB0aGUgYWN0aW9uU2hlZXQgd2hlbiBuYXZpZ2F0aW5nCiAgICogICAgIHRvIGEgbmV3IHN0YXRlLiAgRGVmYXVsdCB0cnVlLgogICAqCiAgICogQHJldHVybnMge2Z1bmN0aW9ufSBgaGlkZVNoZWV0YCBBIGZ1bmN0aW9uIHdoaWNoLCB3aGVuIGNhbGxlZCwgaGlkZXMgJiBjYW5jZWxzIHRoZSBhY3Rpb24gc2hlZXQuCiAgICovCiAgZnVuY3Rpb24gYWN0aW9uU2hlZXQob3B0cykgewogICAgdmFyIHNjb3BlID0gJHJvb3RTY29wZS4kbmV3KHRydWUpOwoKICAgIGFuZ3VsYXIuZXh0ZW5kKHNjb3BlLCB7CiAgICAgIGNhbmNlbDogYW5ndWxhci5ub29wLAogICAgICBkZXN0cnVjdGl2ZUJ1dHRvbkNsaWNrZWQ6IGFuZ3VsYXIubm9vcCwKICAgICAgYnV0dG9uQ2xpY2tlZDogYW5ndWxhci5ub29wLAogICAgICAkZGVyZWdpc3RlckJhY2tCdXR0b246IGFuZ3VsYXIubm9vcCwKICAgICAgYnV0dG9uczogW10sCiAgICAgIGNhbmNlbE9uU3RhdGVDaGFuZ2U6IHRydWUKICAgIH0sIG9wdHMgfHwge30pOwoKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZQogICAgdmFyIGVsZW1lbnQgPSBzY29wZS5lbGVtZW50ID0gJGNvbXBpbGUoJzxpb24tYWN0aW9uLXNoZWV0IGJ1dHRvbnM9ImJ1dHRvbnMiPjwvaW9uLWFjdGlvbi1zaGVldD4nKShzY29wZSk7CgogICAgLy8gR3JhYiB0aGUgc2hlZXQgZWxlbWVudCBmb3IgYW5pbWF0aW9uCiAgICB2YXIgc2hlZXRFbCA9IGpxTGl0ZShlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJy5hY3Rpb24tc2hlZXQtd3JhcHBlcicpKTsKCiAgICB2YXIgc3RhdGVDaGFuZ2VMaXN0ZW5Eb25lID0gc2NvcGUuY2FuY2VsT25TdGF0ZUNoYW5nZSA/CiAgICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24oKSB7IHNjb3BlLmNhbmNlbCgpOyB9KSA6CiAgICAgIGFuZ3VsYXIubm9vcDsKCiAgICAvLyByZW1vdmVzIHRoZSBhY3Rpb25TaGVldCBmcm9tIHRoZSBzY3JlZW4KICAgIHNjb3BlLnJlbW92ZVNoZWV0ID0gZnVuY3Rpb24oZG9uZSkgewogICAgICBpZiAoc2NvcGUucmVtb3ZlZCkgcmV0dXJuOwoKICAgICAgc2NvcGUucmVtb3ZlZCA9IHRydWU7CiAgICAgIHNoZWV0RWwucmVtb3ZlQ2xhc3MoJ2FjdGlvbi1zaGVldC11cCcpOwogICAgICAkaW9uaWNCb2R5LnJlbW92ZUNsYXNzKCdhY3Rpb24tc2hlZXQtb3BlbicpOwogICAgICBzY29wZS4kZGVyZWdpc3RlckJhY2tCdXR0b24oKTsKICAgICAgc3RhdGVDaGFuZ2VMaXN0ZW5Eb25lKCk7CgogICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCAnYWN0aXZlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICBlbGVtZW50LnJlbW92ZSgpOwogICAgICAgIC8vIHNjb3BlLmNhbmNlbC4kc2NvcGUgaXMgZGVmaW5lZCBuZWFyIHRoZSBib3R0b20KICAgICAgICBzY29wZS5jYW5jZWwuJHNjb3BlID0gbnVsbDsKICAgICAgICAoZG9uZSB8fCBhbmd1bGFyLm5vb3ApKCk7CiAgICAgIH0pOwogICAgfTsKCiAgICBzY29wZS5zaG93U2hlZXQgPSBmdW5jdGlvbihkb25lKSB7CiAgICAgIGlmIChzY29wZS5yZW1vdmVkKSByZXR1cm47CgogICAgICAkaW9uaWNCb2R5LmFwcGVuZChlbGVtZW50KQogICAgICAgICAgICAgICAgLmFkZENsYXNzKCdhY3Rpb24tc2hlZXQtb3BlbicpOwoKICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgJ2FjdGl2ZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChzY29wZS5yZW1vdmVkKSByZXR1cm47CiAgICAgICAgKGRvbmUgfHwgYW5ndWxhci5ub29wKSgpOwogICAgICB9KTsKICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICBpZiAoc2NvcGUucmVtb3ZlZCkgcmV0dXJuOwogICAgICAgIHNoZWV0RWwuYWRkQ2xhc3MoJ2FjdGlvbi1zaGVldC11cCcpOwogICAgICB9LCAyMCwgZmFsc2UpOwogICAgfTsKCiAgICAvLyByZWdpc3RlckJhY2tCdXR0b25BY3Rpb24gcmV0dXJucyBhIGNhbGxiYWNrIHRvIGRlcmVnaXN0ZXIgdGhlIGFjdGlvbgogICAgc2NvcGUuJGRlcmVnaXN0ZXJCYWNrQnV0dG9uID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICAkdGltZW91dChzY29wZS5jYW5jZWwpOwogICAgICB9LAogICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9BQ1RJT05fU0hFRVQKICAgICk7CgogICAgLy8gY2FsbGVkIHdoZW4gdGhlIHVzZXIgcHJlc3NlcyB0aGUgY2FuY2VsIGJ1dHRvbgogICAgc2NvcGUuY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIGFmdGVyIHRoZSBhbmltYXRpb24gaXMgb3V0LCBjYWxsIHRoZSBjYW5jZWwgY2FsbGJhY2sKICAgICAgc2NvcGUucmVtb3ZlU2hlZXQob3B0cy5jYW5jZWwpOwogICAgfTsKCiAgICBzY29wZS5idXR0b25DbGlja2VkID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgLy8gQ2hlY2sgaWYgdGhlIGJ1dHRvbiBjbGljayBldmVudCByZXR1cm5lZCB0cnVlLCB3aGljaCBtZWFucwogICAgICAvLyB3ZSBjYW4gY2xvc2UgdGhlIGFjdGlvbiBzaGVldAogICAgICBpZiAob3B0cy5idXR0b25DbGlja2VkKGluZGV4LCBvcHRzLmJ1dHRvbnNbaW5kZXhdKSA9PT0gdHJ1ZSkgewogICAgICAgIHNjb3BlLnJlbW92ZVNoZWV0KCk7CiAgICAgIH0KICAgIH07CgogICAgc2NvcGUuZGVzdHJ1Y3RpdmVCdXR0b25DbGlja2VkID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIENoZWNrIGlmIHRoZSBkZXN0cnVjdGl2ZSBidXR0b24gY2xpY2sgZXZlbnQgcmV0dXJuZWQgdHJ1ZSwgd2hpY2ggbWVhbnMKICAgICAgLy8gd2UgY2FuIGNsb3NlIHRoZSBhY3Rpb24gc2hlZXQKICAgICAgaWYgKG9wdHMuZGVzdHJ1Y3RpdmVCdXR0b25DbGlja2VkKCkgPT09IHRydWUpIHsKICAgICAgICBzY29wZS5yZW1vdmVTaGVldCgpOwogICAgICB9CiAgICB9OwoKICAgIHNjb3BlLnNob3dTaGVldCgpOwoKICAgIC8vIEV4cG9zZSB0aGUgc2NvcGUgb24gJGlvbmljQWN0aW9uU2hlZXQncyByZXR1cm4gdmFsdWUgZm9yIHRoZSBzYWtlCiAgICAvLyBvZiB0ZXN0aW5nIGl0LgogICAgc2NvcGUuY2FuY2VsLiRzY29wZSA9IHNjb3BlOwoKICAgIHJldHVybiBzY29wZS5jYW5jZWw7CiAgfQp9XSk7CgoKanFMaXRlLnByb3RvdHlwZS5hZGRDbGFzcyA9IGZ1bmN0aW9uKGNzc0NsYXNzZXMpIHsKICB2YXIgeCwgeSwgY3NzQ2xhc3MsIGVsLCBzcGxpdENsYXNzZXMsIGV4aXN0aW5nQ2xhc3NlczsKICBpZiAoY3NzQ2xhc3NlcyAmJiBjc3NDbGFzc2VzICE9ICduZy1zY29wZScgJiYgY3NzQ2xhc3NlcyAhPSAnbmctaXNvbGF0ZS1zY29wZScpIHsKICAgIGZvcih4PTA7IHg8dGhpcy5sZW5ndGg7IHgrKykgewogICAgICBlbCA9IHRoaXNbeF07CiAgICAgIGlmKGVsLnNldEF0dHJpYnV0ZSkgewoKICAgICAgICBpZihjc3NDbGFzc2VzLmluZGV4T2YoJyAnKSA8IDAgJiYgZWwuY2xhc3NMaXN0LmFkZCkgewogICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChjc3NDbGFzc2VzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXhpc3RpbmdDbGFzc2VzID0gKCcgJyArIChlbC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgJyAnKQogICAgICAgICAgICAucmVwbGFjZSgvW1xuXHRdL2csICIgIik7CiAgICAgICAgICBzcGxpdENsYXNzZXMgPSBjc3NDbGFzc2VzLnNwbGl0KCcgJyk7CgogICAgICAgICAgZm9yICh5PTA7IHk8c3BsaXRDbGFzc2VzLmxlbmd0aDsgeSsrKSB7CiAgICAgICAgICAgIGNzc0NsYXNzID0gc3BsaXRDbGFzc2VzW3ldLnRyaW0oKTsKICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2xhc3Nlcy5pbmRleE9mKCcgJyArIGNzc0NsYXNzICsgJyAnKSA9PT0gLTEpIHsKICAgICAgICAgICAgICBleGlzdGluZ0NsYXNzZXMgKz0gY3NzQ2xhc3MgKyAnICc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBleGlzdGluZ0NsYXNzZXMudHJpbSgpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHRoaXM7Cn07CgpqcUxpdGUucHJvdG90eXBlLnJlbW92ZUNsYXNzID0gZnVuY3Rpb24oY3NzQ2xhc3NlcykgewogIHZhciB4LCB5LCBzcGxpdENsYXNzZXMsIGNzc0NsYXNzLCBlbDsKICBpZiAoY3NzQ2xhc3NlcykgewogICAgZm9yKHg9MDsgeDx0aGlzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGVsID0gdGhpc1t4XTsKICAgICAgaWYoZWwuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgaWYoY3NzQ2xhc3Nlcy5pbmRleE9mKCcgJykgPCAwICYmIGVsLmNsYXNzTGlzdC5yZW1vdmUpIHsKICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoY3NzQ2xhc3Nlcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNwbGl0Q2xhc3NlcyA9IGNzc0NsYXNzZXMuc3BsaXQoJyAnKTsKCiAgICAgICAgICBmb3IgKHk9MDsgeTxzcGxpdENsYXNzZXMubGVuZ3RoOyB5KyspIHsKICAgICAgICAgICAgY3NzQ2xhc3MgPSBzcGxpdENsYXNzZXNbeV07CiAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAoCiAgICAgICAgICAgICAgICAoIiAiICsgKGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xuXHRdL2csICIgIikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKCIgIiArIGNzc0NsYXNzLnRyaW0oKSArICIgIiwgIiAiKSkudHJpbSgpCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIHJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY0JhY2tkcm9wCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqIFNob3dzIGFuZCBoaWRlcyBhIGJhY2tkcm9wIG92ZXIgdGhlIFVJLiAgQXBwZWFycyBiZWhpbmQgcG9wdXBzLCBsb2FkaW5nLAogKiBhbmQgb3RoZXIgb3ZlcmxheXMuCiAqCiAqIE9mdGVuLCBtdWx0aXBsZSBVSSBjb21wb25lbnRzIHJlcXVpcmUgYSBiYWNrZHJvcCwgYnV0IG9ubHkgb25lIGJhY2tkcm9wIGlzCiAqIGV2ZXIgbmVlZGVkIGluIHRoZSBET00gYXQgYSB0aW1lLgogKgogKiBUaGVyZWZvcmUsIGVhY2ggY29tcG9uZW50IHRoYXQgcmVxdWlyZXMgdGhlIGJhY2tkcm9wIHRvIGJlIHNob3duIGNhbGxzCiAqIGAkaW9uaWNCYWNrZHJvcC5yZXRhaW4oKWAgd2hlbiBpdCB3YW50cyB0aGUgYmFja2Ryb3AsIHRoZW4gYCRpb25pY0JhY2tkcm9wLnJlbGVhc2UoKWAKICogd2hlbiBpdCBpcyBkb25lIHdpdGggdGhlIGJhY2tkcm9wLgogKgogKiBGb3IgZWFjaCB0aW1lIGByZXRhaW5gIGlzIGNhbGxlZCwgdGhlIGJhY2tkcm9wIHdpbGwgYmUgc2hvd24gdW50aWwgYHJlbGVhc2VgIGlzIGNhbGxlZC4KICoKICogRm9yIGV4YW1wbGUsIGlmIGByZXRhaW5gIGlzIGNhbGxlZCB0aHJlZSB0aW1lcywgdGhlIGJhY2tkcm9wIHdpbGwgYmUgc2hvd24gdW50aWwgYHJlbGVhc2VgCiAqIGlzIGNhbGxlZCB0aHJlZSB0aW1lcy4KICoKICogQHVzYWdlCiAqCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIE15Q29udHJvbGxlcigkc2NvcGUsICRpb25pY0JhY2tkcm9wLCAkdGltZW91dCkgewogKiAgIC8vU2hvdyBhIGJhY2tkcm9wIGZvciBvbmUgc2Vjb25kCiAqICAgJHNjb3BlLmFjdGlvbiA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljQmFja2Ryb3AucmV0YWluKCk7CiAqICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICogICAgICAgJGlvbmljQmFja2Ryb3AucmVsZWFzZSgpOwogKiAgICAgfSwgMTAwMCk7CiAqICAgfTsKICogfQogKiBgYGAKICovCklvbmljTW9kdWxlCi5mYWN0b3J5KCckaW9uaWNCYWNrZHJvcCcsIFsKICAnJGRvY3VtZW50JywgJyR0aW1lb3V0JywKZnVuY3Rpb24oJGRvY3VtZW50LCAkdGltZW91dCkgewoKICB2YXIgZWwgPSBqcUxpdGUoJzxkaXYgY2xhc3M9ImJhY2tkcm9wIj4nKTsKICB2YXIgYmFja2Ryb3BIb2xkcyA9IDA7CgogICRkb2N1bWVudFswXS5ib2R5LmFwcGVuZENoaWxkKGVsWzBdKTsKCiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljQmFja2Ryb3AjcmV0YWluCiAgICAgKiBAZGVzY3JpcHRpb24gUmV0YWlucyB0aGUgYmFja2Ryb3AuCiAgICAgKi8KICAgIHJldGFpbjogcmV0YWluLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNCYWNrZHJvcCNyZWxlYXNlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlbGVhc2VzIHRoZSBiYWNrZHJvcC4KICAgICAqLwogICAgcmVsZWFzZTogcmVsZWFzZSwKCiAgICBnZXRFbGVtZW50OiBnZXRFbGVtZW50LAoKICAgIC8vIGV4cG9zZWQgZm9yIHRlc3RpbmcKICAgIF9lbGVtZW50OiBlbAogIH07CgogIGZ1bmN0aW9uIHJldGFpbigpIHsKICAgIGlmICggKCsrYmFja2Ryb3BIb2xkcykgPT09IDEgKSB7CiAgICAgIGVsLmFkZENsYXNzKCd2aXNpYmxlJyk7CiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICBiYWNrZHJvcEhvbGRzICYmIGVsLmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgfSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHJlbGVhc2UoKSB7CiAgICBpZiAoICgtLWJhY2tkcm9wSG9sZHMpID09PSAwICkgewogICAgICBlbC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICFiYWNrZHJvcEhvbGRzICYmIGVsLnJlbW92ZUNsYXNzKCd2aXNpYmxlJyk7CiAgICAgIH0sIDQwMCwgZmFsc2UpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0RWxlbWVudCgpIHsKICAgIHJldHVybiBlbDsKICB9Cgp9XSk7CgovKioKICogQHByaXZhdGUKICovCklvbmljTW9kdWxlCi5mYWN0b3J5KCckaW9uaWNCaW5kJywgWyckcGFyc2UnLCAnJGludGVycG9sYXRlJywgZnVuY3Rpb24oJHBhcnNlLCAkaW50ZXJwb2xhdGUpIHsKICB2YXIgTE9DQUxfUkVHRVhQID0gL15ccyooW0A9Jl0pKFw/PylccyooXHcqKVxzKiQvOwogIHJldHVybiBmdW5jdGlvbihzY29wZSwgYXR0cnMsIGJpbmREZWZpbml0aW9uKSB7CiAgICBmb3JFYWNoKGJpbmREZWZpbml0aW9uIHx8IHt9LCBmdW5jdGlvbiAoZGVmaW5pdGlvbiwgc2NvcGVOYW1lKSB7CiAgICAgIC8vQWRhcHRlZCBmcm9tIGFuZ3VsYXIuanMgJGNvbXBpbGUKICAgICAgdmFyIG1hdGNoID0gZGVmaW5pdGlvbi5tYXRjaChMT0NBTF9SRUdFWFApIHx8IFtdLAogICAgICAgIGF0dHJOYW1lID0gbWF0Y2hbM10gfHwgc2NvcGVOYW1lLAogICAgICAgIG1vZGUgPSBtYXRjaFsxXSwgLy8gQCwgPSwgb3IgJgogICAgICAgIHBhcmVudEdldCwKICAgICAgICB1bndhdGNoOwoKICAgICAgc3dpdGNoKG1vZGUpIHsKICAgICAgICBjYXNlICdAJzoKICAgICAgICAgIGlmICghYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIHdlIHRyaWdnZXIgYW4gaW50ZXJwb2xhdGlvbiB0byBlbnN1cmUKICAgICAgICAgIC8vIHRoZSB2YWx1ZSBpcyB0aGVyZSBmb3IgdXNlIGltbWVkaWF0ZWx5CiAgICAgICAgICBpZiAoYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgIHNjb3BlW3Njb3BlTmFtZV0gPSAkaW50ZXJwb2xhdGUoYXR0cnNbYXR0ck5hbWVdKShzY29wZSk7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnPSc6CiAgICAgICAgICBpZiAoIWF0dHJzW2F0dHJOYW1lXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB1bndhdGNoID0gc2NvcGUuJHdhdGNoKGF0dHJzW2F0dHJOYW1lXSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IHZhbHVlOwogICAgICAgICAgfSk7CiAgICAgICAgICAvL0Rlc3Ryb3kgcGFyZW50IHNjb3BlIHdhdGNoZXIgd2hlbiB0aGlzIHNjb3BlIGlzIGRlc3Ryb3llZAogICAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIHVud2F0Y2gpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJyYnOgogICAgICAgICAgLyoganNoaW50IC1XMDQ0ICovCiAgICAgICAgICBpZiAoYXR0cnNbYXR0ck5hbWVdICYmIGF0dHJzW2F0dHJOYW1lXS5tYXRjaChSZWdFeHAoc2NvcGVOYW1lICsgJ1woLio/XCknKSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcmIGV4cHJlc3Npb24gYmluZGluZyAiJyArIHNjb3BlTmFtZSArICciIGxvb2tzIGxpa2UgaXQgd2lsbCByZWN1cnNpdmVseSBjYWxsICInICsKICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyc1thdHRyTmFtZV0gKyAnIiBhbmQgY2F1c2UgYSBzdGFjayBvdmVyZmxvdyEgUGxlYXNlIGNob29zZSBhIGRpZmZlcmVudCBzY29wZU5hbWUuJyk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgIHNjb3BlW3Njb3BlTmFtZV0gPSBmdW5jdGlvbihsb2NhbHMpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcmVudEdldChzY29wZSwgbG9jYWxzKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfSk7CiAgfTsKfV0pOwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY0JvZHkKICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24gQW4gYW5ndWxhciB1dGlsaXR5IHNlcnZpY2UgdG8gZWFzaWx5IGFuZCBlZmZpY2llbnRseQogKiBhZGQgYW5kIHJlbW92ZSBDU1MgY2xhc3NlcyBmcm9tIHRoZSBkb2N1bWVudCdzIGJvZHkgZWxlbWVudC4KICovCklvbmljTW9kdWxlCi5mYWN0b3J5KCckaW9uaWNCb2R5JywgWyckZG9jdW1lbnQnLCBmdW5jdGlvbigkZG9jdW1lbnQpIHsKICByZXR1cm4gewogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNCb2R5I2FkZAogICAgICogQGRlc2NyaXB0aW9uIEFkZCBhIGNsYXNzIHRvIHRoZSBkb2N1bWVudCdzIGJvZHkgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzcyBFYWNoIGFyZ3VtZW50IHdpbGwgYmUgYWRkZWQgdG8gdGhlIGJvZHkgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHskaW9uaWNCb2R5fSBUaGUgJGlvbmljQm9keSBzZXJ2aWNlIHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICAgKi8KICAgIGFkZENsYXNzOiBmdW5jdGlvbigpIHsKICAgICAgZm9yKHZhciB4PTA7IHg8YXJndW1lbnRzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuY2xhc3NMaXN0LmFkZChhcmd1bWVudHNbeF0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljQm9keSNyZW1vdmVDbGFzcwogICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZSBhIGNsYXNzIGZyb20gdGhlIGRvY3VtZW50J3MgYm9keSBlbGVtZW50LgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzIEVhY2ggYXJndW1lbnQgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGJvZHkgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHskaW9uaWNCb2R5fSBUaGUgJGlvbmljQm9keSBzZXJ2aWNlIHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICAgKi8KICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbigpIHsKICAgICAgZm9yKHZhciB4PTA7IHg8YXJndW1lbnRzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuY2xhc3NMaXN0LnJlbW92ZShhcmd1bWVudHNbeF0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljQm9keSNlbmFibGVDbGFzcwogICAgICogQGRlc2NyaXB0aW9uIFNpbWlsYXIgdG8gdGhlIGBhZGRgIG1ldGhvZCwgZXhjZXB0IHRoZSBmaXJzdCBwYXJhbWV0ZXIgYWNjZXB0cyBhIGJvb2xlYW4KICAgICAqIHZhbHVlIGRldGVybWluaW5nIGlmIHRoZSBjbGFzcyBzaG91bGQgYmUgYWRkZWQgb3IgcmVtb3ZlZC4gUmF0aGVyIHRoYW4gd3JpdGluZyB1c2VyIGNvZGUsCiAgICAgKiBzdWNoIGFzICJpZiB0cnVlIHRoZW4gYWRkIHRoZSBjbGFzcywgZWxzZSB0aGVuIHJlbW92ZSB0aGUgY2xhc3MiLCB0aGlzIG1ldGhvZCBjYW4gYmUKICAgICAqIGdpdmVuIGEgdHJ1ZSBvciBmYWxzZSB2YWx1ZSB3aGljaCByZWR1Y2VzIHJlZHVuZGFudCBjb2RlLgogICAgICogQHBhcmFtIHtib29sZWFufSBzaG91bGRFbmFibGVDbGFzcyBBIHRydWUvZmFsc2UgdmFsdWUgaWYgdGhlIGNsYXNzIHNob3VsZCBiZSBhZGRlZCBvciByZW1vdmVkLgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzIEVhY2ggcmVtYWluaW5nIGFyZ3VtZW50IHdvdWxkIGJlIGFkZGVkIG9yIHJlbW92ZWQgZGVwZW5kaW5nIG9uCiAgICAgKiB0aGUgZmlyc3QgYXJndW1lbnQuCiAgICAgKiBAcmV0dXJucyB7JGlvbmljQm9keX0gVGhlICRpb25pY0JvZHkgc2VydmljZSBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAgICovCiAgICBlbmFibGVDbGFzczogZnVuY3Rpb24oc2hvdWxkRW5hYmxlQ2xhc3MpIHsKICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLnNsaWNlKDEpOwogICAgICBpZihzaG91bGRFbmFibGVDbGFzcykgewogICAgICAgIHRoaXMuYWRkQ2xhc3MuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5yZW1vdmVDbGFzcy5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0JvZHkjYXBwZW5kCiAgICAgKiBAZGVzY3JpcHRpb24gQXBwZW5kIGEgY2hpbGQgdG8gdGhlIGRvY3VtZW50J3MgYm9keS4KICAgICAqIEBwYXJhbSB7ZWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byBiZSBhcHBlbmRlZCB0byB0aGUgYm9keS4gVGhlIHBhc3NlZCBpbiBlbGVtZW50CiAgICAgKiBjYW4gYmUgZWl0aGVyIGEganFMaXRlIGVsZW1lbnQsIG9yIGEgRE9NIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7JGlvbmljQm9keX0gVGhlICRpb25pY0JvZHkgc2VydmljZSBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAgICovCiAgICBhcHBlbmQ6IGZ1bmN0aW9uKGVsZSkgewogICAgICAkZG9jdW1lbnRbMF0uYm9keS5hcHBlbmRDaGlsZCggZWxlLmxlbmd0aCA/IGVsZVswXSA6IGVsZSApOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0JvZHkjZ2V0CiAgICAgKiBAZGVzY3JpcHRpb24gR2V0IHRoZSBkb2N1bWVudCdzIGJvZHkgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHtlbGVtZW50fSBSZXR1cm5zIHRoZSBkb2N1bWVudCdzIGJvZHkgZWxlbWVudC4KICAgICAqLwogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICRkb2N1bWVudFswXS5ib2R5OwogICAgfQogIH07Cn1dKTsKCklvbmljTW9kdWxlCi5mYWN0b3J5KCckaW9uaWNDbGlja0Jsb2NrJywgWwogICckZG9jdW1lbnQnLAogICckaW9uaWNCb2R5JywKICAnJHRpbWVvdXQnLApmdW5jdGlvbigkZG9jdW1lbnQsICRpb25pY0JvZHksICR0aW1lb3V0KSB7CiAgdmFyIGNiID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogIGNiLmNsYXNzTmFtZSA9ICdjbGljay1ibG9jayc7CiAgcmV0dXJuIHsKICAgIHNob3c6IGZ1bmN0aW9uKCkgewogICAgICBpZihjYi5wYXJlbnRFbGVtZW50KSB7CiAgICAgICAgY2IuY2xhc3NMaXN0LnJlbW92ZSgnaGlkZScpOwogICAgICB9IGVsc2UgewogICAgICAgICRpb25pY0JvZHkuYXBwZW5kKGNiKTsKICAgICAgfQogICAgICAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgIGNiLmNsYXNzTGlzdC5hZGQoJ2hpZGUnKTsKICAgICAgfSwgNTAwKTsKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbigpIHsKICAgICAgY2IuY2xhc3NMaXN0LmFkZCgnaGlkZScpOwogICAgfQogIH07Cn1dKTsKCklvbmljTW9kdWxlCi5mYWN0b3J5KCckY29sbGVjdGlvbkRhdGFTb3VyY2UnLCBbCiAgJyRjYWNoZUZhY3RvcnknLAogICckcGFyc2UnLAogICckcm9vdFNjb3BlJywKZnVuY3Rpb24oJGNhY2hlRmFjdG9yeSwgJHBhcnNlLCAkcm9vdFNjb3BlKSB7CiAgZnVuY3Rpb24gaGlkZVdpdGhUcmFuc2Zvcm0oZWxlbWVudCkgewogICAgZWxlbWVudC5jc3MoaW9uaWMuQ1NTLlRSQU5TRk9STSwgJ3RyYW5zbGF0ZTNkKC0yMDAwcHgsLTIwMDBweCwwKScpOwogIH0KCiAgZnVuY3Rpb24gQ29sbGVjdGlvblJlcGVhdERhdGFTb3VyY2Uob3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5zY29wZSA9IG9wdGlvbnMuc2NvcGU7CiAgICB0aGlzLnRyYW5zY2x1ZGVGbiA9IG9wdGlvbnMudHJhbnNjbHVkZUZuOwogICAgdGhpcy50cmFuc2NsdWRlUGFyZW50ID0gb3B0aW9ucy50cmFuc2NsdWRlUGFyZW50OwogICAgdGhpcy5lbGVtZW50ID0gb3B0aW9ucy5lbGVtZW50OwoKICAgIHRoaXMua2V5RXhwciA9IG9wdGlvbnMua2V5RXhwcjsKICAgIHRoaXMubGlzdEV4cHIgPSBvcHRpb25zLmxpc3RFeHByOwogICAgdGhpcy50cmFja0J5RXhwciA9IG9wdGlvbnMudHJhY2tCeUV4cHI7CgogICAgdGhpcy5oZWlnaHRHZXR0ZXIgPSBvcHRpb25zLmhlaWdodEdldHRlcjsKICAgIHRoaXMud2lkdGhHZXR0ZXIgPSBvcHRpb25zLndpZHRoR2V0dGVyOwoKICAgIHRoaXMuZGltZW5zaW9ucyA9IFtdOwogICAgdGhpcy5kYXRhID0gW107CgogICAgdGhpcy5hdHRhY2hlZEl0ZW1zID0ge307CiAgICB0aGlzLkJBQ0tVUF9JVEVNU19MRU5HVEggPSAyMDsKICAgIHRoaXMuYmFja3VwSXRlbXNBcnJheSA9IFtdOwogIH0KICBDb2xsZWN0aW9uUmVwZWF0RGF0YVNvdXJjZS5wcm90b3R5cGUgPSB7CiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmlzU2V0dXApIHJldHVybjsKICAgICAgdGhpcy5pc1NldHVwID0gdHJ1ZTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLkJBQ0tVUF9JVEVNU19MRU5HVEg7IGkrKykgewogICAgICAgIHRoaXMuZGV0YWNoSXRlbSh0aGlzLmNyZWF0ZUl0ZW0oKSk7CiAgICAgIH0KICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5kaW1lbnNpb25zLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICAgIHRoaXMuYmFja3VwSXRlbXNBcnJheS5sZW5ndGggPSAwOwogICAgICB0aGlzLmF0dGFjaGVkSXRlbXMgPSB7fTsKICAgIH0sCiAgICBjYWxjdWxhdGVEYXRhRGltZW5zaW9uczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsb2NhbHMgPSB7fTsKICAgICAgdGhpcy5kaW1lbnNpb25zID0gdGhpcy5kYXRhLm1hcChmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgICBsb2NhbHNbdGhpcy5rZXlFeHByXSA9IHZhbHVlOwogICAgICAgIGxvY2Fscy4kaW5kZXggPSBpbmRleDsKICAgICAgICByZXR1cm4gewogICAgICAgICAgd2lkdGg6IHRoaXMud2lkdGhHZXR0ZXIodGhpcy5zY29wZSwgbG9jYWxzKSwKICAgICAgICAgIGhlaWdodDogdGhpcy5oZWlnaHRHZXR0ZXIodGhpcy5zY29wZSwgbG9jYWxzKQogICAgICAgIH07CiAgICAgIH0sIHRoaXMpOwogICAgICB0aGlzLmRpbWVuc2lvbnMgPSB0aGlzLmJlZm9yZVNpYmxpbmdzLmNvbmNhdCh0aGlzLmRpbWVuc2lvbnMpLmNvbmNhdCh0aGlzLmFmdGVyU2libGluZ3MpOwogICAgICB0aGlzLmRhdGFTdGFydEluZGV4ID0gdGhpcy5iZWZvcmVTaWJsaW5ncy5sZW5ndGg7CiAgICB9LAogICAgY3JlYXRlSXRlbTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtID0ge307CgogICAgICBpdGVtLnNjb3BlID0gdGhpcy5zY29wZS4kbmV3KCk7CiAgICAgIHRoaXMudHJhbnNjbHVkZUZuKGl0ZW0uc2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgY2xvbmUuY3NzKCdwb3NpdGlvbicsICdhYnNvbHV0ZScpOwogICAgICAgIGl0ZW0uZWxlbWVudCA9IGNsb25lOwogICAgICB9KTsKICAgICAgdGhpcy50cmFuc2NsdWRlUGFyZW50LmFwcGVuZChpdGVtLmVsZW1lbnQpOwoKICAgICAgcmV0dXJuIGl0ZW07CiAgICB9LAogICAgZ2V0SXRlbTogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgaWYgKCAoaXRlbSA9IHRoaXMuYXR0YWNoZWRJdGVtc1tpbmRleF0pICkgewogICAgICAgIC8vZG8gbm90aGluZywgdGhlIGl0ZW0gaXMgZ29vZAogICAgICB9IGVsc2UgaWYgKCAoaXRlbSA9IHRoaXMuYmFja3VwSXRlbXNBcnJheS5wb3AoKSkgKSB7CiAgICAgICAgcmVjb25uZWN0U2NvcGUoaXRlbS5zY29wZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaXRlbSA9IHRoaXMuY3JlYXRlSXRlbSgpOwogICAgICB9CiAgICAgIHJldHVybiBpdGVtOwogICAgfSwKICAgIGF0dGFjaEl0ZW1BdEluZGV4OiBmdW5jdGlvbihpbmRleCkgewogICAgICBpZiAoaW5kZXggPCB0aGlzLmRhdGFTdGFydEluZGV4KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYmVmb3JlU2libGluZ3NbaW5kZXhdOwogICAgICB9CiAgICAgIC8vIFN1YnRyYWN0IHNvIHdlIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhpcy5kYXRhLCBhZnRlcgogICAgICAvLyB0aGlzLmJlZm9yZVNpYmxpbmdzLgogICAgICBpbmRleCAtPSB0aGlzLmRhdGFTdGFydEluZGV4OwoKICAgICAgaWYgKGluZGV4ID4gdGhpcy5kYXRhLmxlbmd0aCAtIDEpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZnRlclNpYmxpbmdzW2luZGV4IC0gdGhpcy5kYXRhU3RhcnRJbmRleF07CiAgICAgIH0KCiAgICAgIHZhciBpdGVtID0gdGhpcy5nZXRJdGVtKGluZGV4KTsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5kYXRhW2luZGV4XTsKCiAgICAgIGlmIChpdGVtLmluZGV4ICE9PSBpbmRleCB8fCBpdGVtLnNjb3BlW3RoaXMua2V5RXhwcl0gIT09IHZhbHVlKSB7CiAgICAgICAgaXRlbS5pbmRleCA9IGl0ZW0uc2NvcGUuJGluZGV4ID0gaW5kZXg7CiAgICAgICAgaXRlbS5zY29wZVt0aGlzLmtleUV4cHJdID0gdmFsdWU7CiAgICAgICAgaXRlbS5zY29wZS4kZmlyc3QgPSAoaW5kZXggPT09IDApOwogICAgICAgIGl0ZW0uc2NvcGUuJGxhc3QgPSAoaW5kZXggPT09ICh0aGlzLmdldExlbmd0aCgpIC0gMSkpOwogICAgICAgIGl0ZW0uc2NvcGUuJG1pZGRsZSA9ICEoaXRlbS5zY29wZS4kZmlyc3QgfHwgaXRlbS5zY29wZS4kbGFzdCk7CiAgICAgICAgaXRlbS5zY29wZS4kb2RkID0gIShpdGVtLnNjb3BlLiRldmVuID0gKGluZGV4JjEpID09PSAwKTsKCiAgICAgICAgLy9XZSBjaGFuZ2VkIHRoZSBzY29wZSwgc28gZGlnZXN0IGlmIG5lZWRlZAogICAgICAgIGlmICghJHJvb3RTY29wZS4kJHBoYXNlKSB7CiAgICAgICAgICBpdGVtLnNjb3BlLiRkaWdlc3QoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5hdHRhY2hlZEl0ZW1zW2luZGV4XSA9IGl0ZW07CgogICAgICByZXR1cm4gaXRlbTsKICAgIH0sCiAgICBkZXN0cm95SXRlbTogZnVuY3Rpb24oaXRlbSkgewogICAgICBpdGVtLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgIGl0ZW0uc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgaXRlbS5zY29wZSA9IG51bGw7CiAgICAgIGl0ZW0uZWxlbWVudCA9IG51bGw7CiAgICB9LAogICAgZGV0YWNoSXRlbTogZnVuY3Rpb24oaXRlbSkgewogICAgICBkZWxldGUgdGhpcy5hdHRhY2hlZEl0ZW1zW2l0ZW0uaW5kZXhdOwoKICAgICAgLy9JZiBpdCdzIGFuIG91dHNpZGUgaXRlbSwgb25seSBoaWRlIGl0LiBUaGVzZSBpdGVtcyBhcmVuJ3QgcGFydCBvZiBjb2xsZWN0aW9uCiAgICAgIC8vcmVwZWF0J3MgbGlzdCwgb25seSBzaXQgb3V0c2lkZQogICAgICBpZiAoaXRlbS5pc091dHNpZGUpIHsKICAgICAgICBoaWRlV2l0aFRyYW5zZm9ybShpdGVtLmVsZW1lbnQpOwogICAgICAvLyBJZiB3ZSBhcmUgYXQgdGhlIGxpbWl0IG9mIGJhY2t1cCBpdGVtcywganVzdCBnZXQgcmlkIG9mIHRoZSB0aGlzIGVsZW1lbnQKICAgICAgfSBlbHNlIGlmICh0aGlzLmJhY2t1cEl0ZW1zQXJyYXkubGVuZ3RoID49IHRoaXMuQkFDS1VQX0lURU1TX0xFTkdUSCkgewogICAgICAgIHRoaXMuZGVzdHJveUl0ZW0oaXRlbSk7CiAgICAgIC8vIE90aGVyd2lzZSwgYWRkIGl0IHRvIG91ciBiYWNrdXAgaXRlbXMKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmJhY2t1cEl0ZW1zQXJyYXkucHVzaChpdGVtKTsKICAgICAgICBoaWRlV2l0aFRyYW5zZm9ybShpdGVtLmVsZW1lbnQpOwogICAgICAgIC8vRG9uJ3QgLiRkZXN0cm95KCksIGp1c3Qgc3RvcCB3YXRjaGVycyBhbmQgZXZlbnRzIGZpcmluZwogICAgICAgIGRpc2Nvbm5lY3RTY29wZShpdGVtLnNjb3BlKTsKICAgICAgfQoKICAgIH0sCiAgICBnZXRMZW5ndGg6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5kaW1lbnNpb25zICYmIHRoaXMuZGltZW5zaW9ucy5sZW5ndGggfHwgMDsKICAgIH0sCiAgICBzZXREYXRhOiBmdW5jdGlvbih2YWx1ZSwgYmVmb3JlU2libGluZ3MsIGFmdGVyU2libGluZ3MpIHsKICAgICAgdGhpcy5kYXRhID0gdmFsdWUgfHwgW107CiAgICAgIHRoaXMuYmVmb3JlU2libGluZ3MgPSBiZWZvcmVTaWJsaW5ncyB8fCBbXTsKICAgICAgdGhpcy5hZnRlclNpYmxpbmdzID0gYWZ0ZXJTaWJsaW5ncyB8fCBbXTsKICAgICAgdGhpcy5jYWxjdWxhdGVEYXRhRGltZW5zaW9ucygpOwoKICAgICAgdGhpcy5hZnRlclNpYmxpbmdzLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewogICAgICAgIGl0ZW0uZWxlbWVudC5jc3Moe3Bvc2l0aW9uOiAnYWJzb2x1dGUnLCB0b3A6ICcwJywgbGVmdDogJzAnIH0pOwogICAgICAgIGhpZGVXaXRoVHJhbnNmb3JtKGl0ZW0uZWxlbWVudCk7CiAgICAgIH0pOwogICAgfSwKICB9OwoKICByZXR1cm4gQ29sbGVjdGlvblJlcGVhdERhdGFTb3VyY2U7Cn1dKTsKCmZ1bmN0aW9uIGRpc2Nvbm5lY3RTY29wZShzY29wZSkgewogIGlmIChzY29wZS4kcm9vdCA9PT0gc2NvcGUpIHsKICAgIHJldHVybjsgLy8gd2UgY2FuJ3QgZGlzY29ubmVjdCB0aGUgcm9vdCBub2RlOwogIH0KICB2YXIgcGFyZW50ID0gc2NvcGUuJHBhcmVudDsKICBzY29wZS4kJGRpc2Nvbm5lY3RlZCA9IHRydWU7CiAgLy8gU2VlIFNjb3BlLiRkZXN0cm95CiAgaWYgKHBhcmVudC4kJGNoaWxkSGVhZCA9PT0gc2NvcGUpIHsKICAgIHBhcmVudC4kJGNoaWxkSGVhZCA9IHNjb3BlLiQkbmV4dFNpYmxpbmc7CiAgfQogIGlmIChwYXJlbnQuJCRjaGlsZFRhaWwgPT09IHNjb3BlKSB7CiAgICBwYXJlbnQuJCRjaGlsZFRhaWwgPSBzY29wZS4kJHByZXZTaWJsaW5nOwogIH0KICBpZiAoc2NvcGUuJCRwcmV2U2libGluZykgewogICAgc2NvcGUuJCRwcmV2U2libGluZy4kJG5leHRTaWJsaW5nID0gc2NvcGUuJCRuZXh0U2libGluZzsKICB9CiAgaWYgKHNjb3BlLiQkbmV4dFNpYmxpbmcpIHsKICAgIHNjb3BlLiQkbmV4dFNpYmxpbmcuJCRwcmV2U2libGluZyA9IHNjb3BlLiQkcHJldlNpYmxpbmc7CiAgfQogIHNjb3BlLiQkbmV4dFNpYmxpbmcgPSBzY29wZS4kJHByZXZTaWJsaW5nID0gbnVsbDsKfQoKZnVuY3Rpb24gcmVjb25uZWN0U2NvcGUoc2NvcGUpIHsKICBpZiAoc2NvcGUuJHJvb3QgPT09IHNjb3BlKSB7CiAgICByZXR1cm47IC8vIHdlIGNhbid0IGRpc2Nvbm5lY3QgdGhlIHJvb3Qgbm9kZTsKICB9CiAgaWYgKCFzY29wZS4kJGRpc2Nvbm5lY3RlZCkgewogICAgcmV0dXJuOwogIH0KICB2YXIgcGFyZW50ID0gc2NvcGUuJHBhcmVudDsKICBzY29wZS4kJGRpc2Nvbm5lY3RlZCA9IGZhbHNlOwogIC8vIFNlZSBTY29wZS4kbmV3IGZvciB0aGlzIGxvZ2ljLi4uCiAgc2NvcGUuJCRwcmV2U2libGluZyA9IHBhcmVudC4kJGNoaWxkVGFpbDsKICBpZiAocGFyZW50LiQkY2hpbGRIZWFkKSB7CiAgICBwYXJlbnQuJCRjaGlsZFRhaWwuJCRuZXh0U2libGluZyA9IHNjb3BlOwogICAgcGFyZW50LiQkY2hpbGRUYWlsID0gc2NvcGU7CiAgfSBlbHNlIHsKICAgIHBhcmVudC4kJGNoaWxkSGVhZCA9IHBhcmVudC4kJGNoaWxkVGFpbCA9IHNjb3BlOwogIH0KfQoKCklvbmljTW9kdWxlCi5mYWN0b3J5KCckY29sbGVjdGlvblJlcGVhdE1hbmFnZXInLCBbCiAgJyRyb290U2NvcGUnLAogICckdGltZW91dCcsCmZ1bmN0aW9uKCRyb290U2NvcGUsICR0aW1lb3V0KSB7CiAgLyoqCiAgICogVm9jYWJ1bGFyeTogInByaW1hcnkiIGFuZCAic2Vjb25kYXJ5IiBzaXplL2RpcmVjdGlvbi9wb3NpdGlvbiBtZWFuCiAgICogInkiIGFuZCAieCIgZm9yIHZlcnRpY2FsIHNjcm9sbGluZywgb3IgIngiIGFuZCAieSIgZm9yIGhvcml6b250YWwgc2Nyb2xsaW5nLgogICAqLwogIGZ1bmN0aW9uIENvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyKG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRoaXMuZGF0YVNvdXJjZSA9IG9wdGlvbnMuZGF0YVNvdXJjZTsKICAgIHRoaXMuZWxlbWVudCA9IG9wdGlvbnMuZWxlbWVudDsKICAgIHRoaXMuc2Nyb2xsVmlldyA9IG9wdGlvbnMuc2Nyb2xsVmlldzsKCiAgICB0aGlzLmlzVmVydGljYWwgPSAhIXRoaXMuc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1k7CiAgICB0aGlzLnJlbmRlcmVkSXRlbXMgPSB7fTsKICAgIHRoaXMuZGltZW5zaW9ucyA9IFtdOwogICAgdGhpcy5zZXRDdXJyZW50SW5kZXgoMCk7CgogICAgLy9PdmVycmlkZSBzY3JvbGx2aWV3J3MgcmVuZGVyIGNhbGxiYWNrCiAgICB0aGlzLnNjcm9sbFZpZXcuX18kY2FsbGJhY2sgPSB0aGlzLnNjcm9sbFZpZXcuX19jYWxsYmFjazsKICAgIHRoaXMuc2Nyb2xsVmlldy5fX2NhbGxiYWNrID0gYW5ndWxhci5iaW5kKHRoaXMsIHRoaXMucmVuZGVyU2Nyb2xsKTsKCiAgICBmdW5jdGlvbiBnZXRWaWV3cG9ydFNpemUoKSB7IHJldHVybiBzZWxmLnZpZXdwb3J0U2l6ZTsgfQogICAgLy9TZXQgZ2V0dGVycyBhbmQgc2V0dGVycyB0byBtYXRjaCB3aGV0aGVyIHRoaXMgc2Nyb2xsdmlldyBpcyB2ZXJ0aWNhbCBvciBub3QKICAgIGlmICh0aGlzLmlzVmVydGljYWwpIHsKICAgICAgdGhpcy5zY3JvbGxWaWV3Lm9wdGlvbnMuZ2V0Q29udGVudEhlaWdodCA9IGdldFZpZXdwb3J0U2l6ZTsKCiAgICAgIHRoaXMuc2Nyb2xsVmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fc2Nyb2xsVG9wOwogICAgICB9OwogICAgICB0aGlzLnNjcm9sbE1heFZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5fX21heFNjcm9sbFRvcDsKICAgICAgfTsKICAgICAgdGhpcy5zY3JvbGxTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5fX2NsaWVudEhlaWdodDsKICAgICAgfTsKICAgICAgdGhpcy5zZWNvbmRhcnlTY3JvbGxTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5fX2NsaWVudFdpZHRoOwogICAgICB9OwogICAgICB0aGlzLnRyYW5zZm9ybVN0cmluZyA9IGZ1bmN0aW9uKHksIHgpIHsKICAgICAgICByZXR1cm4gJ3RyYW5zbGF0ZTNkKCcreCsncHgsJyt5KydweCwwKSc7CiAgICAgIH07CiAgICAgIHRoaXMucHJpbWFyeURpbWVuc2lvbiA9IGZ1bmN0aW9uKGRpbSkgewogICAgICAgIHJldHVybiBkaW0uaGVpZ2h0OwogICAgICB9OwogICAgICB0aGlzLnNlY29uZGFyeURpbWVuc2lvbiA9IGZ1bmN0aW9uKGRpbSkgewogICAgICAgIHJldHVybiBkaW0ud2lkdGg7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICB0aGlzLnNjcm9sbFZpZXcub3B0aW9ucy5nZXRDb250ZW50V2lkdGggPSBnZXRWaWV3cG9ydFNpemU7CgogICAgICB0aGlzLnNjcm9sbFZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5fX3Njcm9sbExlZnQ7CiAgICAgIH07CiAgICAgIHRoaXMuc2Nyb2xsTWF4VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fbWF4U2Nyb2xsTGVmdDsKICAgICAgfTsKICAgICAgdGhpcy5zY3JvbGxTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5fX2NsaWVudFdpZHRoOwogICAgICB9OwogICAgICB0aGlzLnNlY29uZGFyeVNjcm9sbFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fY2xpZW50SGVpZ2h0OwogICAgICB9OwogICAgICB0aGlzLnRyYW5zZm9ybVN0cmluZyA9IGZ1bmN0aW9uKHgsIHkpIHsKICAgICAgICByZXR1cm4gJ3RyYW5zbGF0ZTNkKCcreCsncHgsJyt5KydweCwwKSc7CiAgICAgIH07CiAgICAgIHRoaXMucHJpbWFyeURpbWVuc2lvbiA9IGZ1bmN0aW9uKGRpbSkgewogICAgICAgIHJldHVybiBkaW0ud2lkdGg7CiAgICAgIH07CiAgICAgIHRoaXMuc2Vjb25kYXJ5RGltZW5zaW9uID0gZnVuY3Rpb24oZGltKSB7CiAgICAgICAgcmV0dXJuIGRpbS5oZWlnaHQ7CiAgICAgIH07CiAgICB9CiAgfQoKICBDb2xsZWN0aW9uUmVwZWF0TWFuYWdlci5wcm90b3R5cGUgPSB7CiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZW5kZXJlZEl0ZW1zID0ge307CiAgICAgIHRoaXMucmVuZGVyID0gYW5ndWxhci5ub29wOwogICAgICB0aGlzLmNhbGN1bGF0ZURpbWVuc2lvbnMgPSBhbmd1bGFyLm5vb3A7CiAgICAgIHRoaXMuZGltZW5zaW9ucyA9IFtdOwogICAgfSwKCiAgICAvKgogICAgICogUHJlLWNhbGN1bGF0ZSB0aGUgcG9zaXRpb24gb2YgYWxsIGl0ZW1zIGluIHRoZSBkYXRhIGxpc3QuCiAgICAgKiBEbyB0aGlzIHVzaW5nIHRoZSBwcm92aWRlZCB3aWR0aCBhbmQgaGVpZ2h0IChwcmltYXJ5U2l6ZSBhbmQgc2Vjb25kYXJ5U2l6ZSkKICAgICAqIHByb3ZpZGVkIGJ5IHRoZSBkYXRhU291cmNlLgogICAgICovCiAgICBjYWxjdWxhdGVEaW1lbnNpb25zOiBmdW5jdGlvbigpIHsKICAgICAgLyoKICAgICAgICogRm9yIHRoZSBzYWtlIG9mIGV4cGxhbmF0aW9ucyBiZWxvdywgd2UncmUgZ29pbmcgdG8gcHJldGVuZCB3ZSBhcmUgc2Nyb2xsaW5nCiAgICAgICAqIHZlcnRpY2FsbHk6IEl0ZW1zIGFyZSBsYWlkIG91dCB3aXRoIHByaW1hcnlTaXplIGJlaW5nIGhlaWdodCwKICAgICAgICogc2Vjb25kYXJ5U2l6ZSBiZWluZyB3aWR0aC4KICAgICAgICovCiAgICAgIHZhciBwcmltYXJ5UG9zID0gMDsKICAgICAgdmFyIHNlY29uZGFyeVBvcyA9IDA7CiAgICAgIHZhciBzZWNvbmRhcnlTY3JvbGxTaXplID0gdGhpcy5zZWNvbmRhcnlTY3JvbGxTaXplKCk7CiAgICAgIHZhciBwcmV2aW91c0l0ZW07CgogICAgICB0aGlzLmRhdGFTb3VyY2UuYmVmb3JlU2libGluZ3MgJiYgdGhpcy5kYXRhU291cmNlLmJlZm9yZVNpYmxpbmdzLmZvckVhY2goY2FsY3VsYXRlU2l6ZSwgdGhpcyk7CiAgICAgIHZhciBiZWZvcmVTaXplID0gcHJpbWFyeVBvcyArIChwcmV2aW91c0l0ZW0gPyBwcmV2aW91c0l0ZW0ucHJpbWFyeVNpemUgOiAwKTsKCiAgICAgIHByaW1hcnlQb3MgPSBzZWNvbmRhcnlQb3MgPSAwOwogICAgICBwcmV2aW91c0l0ZW0gPSBudWxsOwoKICAgICAgdmFyIGRpbWVuc2lvbnMgPSB0aGlzLmRhdGFTb3VyY2UuZGltZW5zaW9ucy5tYXAoY2FsY3VsYXRlU2l6ZSwgdGhpcyk7CiAgICAgIHZhciB0b3RhbFNpemUgPSBwcmltYXJ5UG9zICsgKHByZXZpb3VzSXRlbSA/IHByZXZpb3VzSXRlbS5wcmltYXJ5U2l6ZSA6IDApOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBiZWZvcmVTaXplOiBiZWZvcmVTaXplLAogICAgICAgIHRvdGFsU2l6ZTogdG90YWxTaXplLAogICAgICAgIGRpbWVuc2lvbnM6IGRpbWVuc2lvbnMKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZVNpemUoZGltKSB7CgogICAgICAgIC8vRWFjaCBkaW1lbnNpb24gaXMgYW4gb2JqZWN0IHt3aWR0aDogTnVtYmVyLCBoZWlnaHQ6IE51bWJlcn0gcHJvdmlkZWQgYnkKICAgICAgICAvL3RoZSBkYXRhU291cmNlCiAgICAgICAgdmFyIHJlY3QgPSB7CiAgICAgICAgICAvL0dldCB0aGUgaGVpZ2h0IG91dCBvZiB0aGUgZGltZW5zaW9uIG9iamVjdAogICAgICAgICAgcHJpbWFyeVNpemU6IHRoaXMucHJpbWFyeURpbWVuc2lvbihkaW0pLAogICAgICAgICAgLy9NYXggb3V0IHRoZSBpdGVtJ3Mgd2lkdGggdG8gdGhlIHdpZHRoIG9mIHRoZSBzY3JvbGx2aWV3CiAgICAgICAgICBzZWNvbmRhcnlTaXplOiBNYXRoLm1pbih0aGlzLnNlY29uZGFyeURpbWVuc2lvbihkaW0pLCBzZWNvbmRhcnlTY3JvbGxTaXplKQogICAgICAgIH07CgogICAgICAgIC8vSWYgdGhpcyBpc24ndCB0aGUgZmlyc3QgaXRlbQogICAgICAgIGlmIChwcmV2aW91c0l0ZW0pIHsKICAgICAgICAgIC8vTW92ZSB0aGUgaXRlbSdzIHggcG9zaXRpb24gb3ZlciBieSB0aGUgd2lkdGggb2YgdGhlIHByZXZpb3VzIGl0ZW0KICAgICAgICAgIHNlY29uZGFyeVBvcyArPSBwcmV2aW91c0l0ZW0uc2Vjb25kYXJ5U2l6ZTsKICAgICAgICAgIC8vSWYgdGhlIHkgcG9zaXRpb24gaXMgdGhlIHNhbWUgYXMgdGhlIHByZXZpb3VzIGl0ZW0gYW5kCiAgICAgICAgICAvL3RoZSB4IHBvc2l0aW9uIGlzIGJpZ2dlciB0aGFuIHRoZSBzY3JvbGxlcidzIHdpZHRoCiAgICAgICAgICBpZiAocHJldmlvdXNJdGVtLnByaW1hcnlQb3MgPT09IHByaW1hcnlQb3MgJiYKICAgICAgICAgICAgICBzZWNvbmRhcnlQb3MgKyByZWN0LnNlY29uZGFyeVNpemUgPiBzZWNvbmRhcnlTY3JvbGxTaXplKSB7CiAgICAgICAgICAgIC8vVGhlbiBnbyB0byB0aGUgbmV4dCByb3csIHdpdGggeCBwb3NpdGlvbiAwCiAgICAgICAgICAgIHNlY29uZGFyeVBvcyA9IDA7CiAgICAgICAgICAgIHByaW1hcnlQb3MgKz0gcHJldmlvdXNJdGVtLnByaW1hcnlTaXplOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVjdC5wcmltYXJ5UG9zID0gcHJpbWFyeVBvczsKICAgICAgICByZWN0LnNlY29uZGFyeVBvcyA9IHNlY29uZGFyeVBvczsKCiAgICAgICAgcHJldmlvdXNJdGVtID0gcmVjdDsKICAgICAgICByZXR1cm4gcmVjdDsKICAgICAgfQogICAgfSwKICAgIHJlc2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciByZXN1bHQgPSB0aGlzLmNhbGN1bGF0ZURpbWVuc2lvbnMoKTsKICAgICAgdGhpcy5kaW1lbnNpb25zID0gcmVzdWx0LmRpbWVuc2lvbnM7CiAgICAgIHRoaXMudmlld3BvcnRTaXplID0gcmVzdWx0LnRvdGFsU2l6ZTsKICAgICAgdGhpcy5iZWZvcmVTaXplID0gcmVzdWx0LmJlZm9yZVNpemU7CiAgICAgIHRoaXMuc2V0Q3VycmVudEluZGV4KDApOwogICAgICB0aGlzLnJlbmRlcih0cnVlKTsKICAgICAgdGhpcy5kYXRhU291cmNlLnNldHVwKCk7CiAgICB9LAogICAgLyoKICAgICAqIHNldEN1cnJlbnRJbmRleCBzZXRzIHRoZSBpbmRleCBpbiB0aGUgbGlzdCB0aGF0IG1hdGNoZXMgdGhlIHNjcm9sbGVyJ3MgcG9zaXRpb24uCiAgICAgKiBBbHNvIHNhdmUgdGhlIHBvc2l0aW9uIGluIHRoZSBzY3JvbGxlciBmb3IgbmV4dCBhbmQgcHJldmlvdXMgaXRlbXMgKGlmIHRoZXkgZXhpc3QpCiAgICAgKi8KICAgIHNldEN1cnJlbnRJbmRleDogZnVuY3Rpb24oaW5kZXgsIGhlaWdodCkgewogICAgICB2YXIgY3VycmVudFBvcyA9ICh0aGlzLmRpbWVuc2lvbnNbaW5kZXhdIHx8IHt9KS5wcmltYXJ5UG9zIHx8IDA7CiAgICAgIHRoaXMuY3VycmVudEluZGV4ID0gaW5kZXg7CgogICAgICB0aGlzLmhhc1ByZXZJbmRleCA9IGluZGV4ID4gMDsKICAgICAgaWYgKHRoaXMuaGFzUHJldkluZGV4KSB7CiAgICAgICAgdGhpcy5wcmV2aW91c1BvcyA9IE1hdGgubWF4KAogICAgICAgICAgY3VycmVudFBvcyAtIHRoaXMuZGltZW5zaW9uc1tpbmRleCAtIDFdLnByaW1hcnlTaXplLAogICAgICAgICAgdGhpcy5kaW1lbnNpb25zW2luZGV4IC0gMV0ucHJpbWFyeVBvcwogICAgICAgICk7CiAgICAgIH0KICAgICAgdGhpcy5oYXNOZXh0SW5kZXggPSBpbmRleCArIDEgPCB0aGlzLmRhdGFTb3VyY2UuZ2V0TGVuZ3RoKCk7CiAgICAgIGlmICh0aGlzLmhhc05leHRJbmRleCkgewogICAgICAgIHRoaXMubmV4dFBvcyA9IE1hdGgubWluKAogICAgICAgICAgY3VycmVudFBvcyArIHRoaXMuZGltZW5zaW9uc1tpbmRleCArIDFdLnByaW1hcnlTaXplLAogICAgICAgICAgdGhpcy5kaW1lbnNpb25zW2luZGV4ICsgMV0ucHJpbWFyeVBvcwogICAgICAgICk7CiAgICAgIH0KICAgIH0sCiAgICAvKioKICAgICAqIG92ZXJyaWRlIHRoZSBzY3JvbGxlcidzIHJlbmRlciBjYWxsYmFjayB0byBjaGVjayBpZiB3ZSBuZWVkIHRvCiAgICAgKiByZS1yZW5kZXIgb3VyIGNvbGxlY3Rpb24KICAgICAqLwogICAgcmVuZGVyU2Nyb2xsOiBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKHRyYW5zZm9ybUxlZnQsIHRyYW5zZm9ybVRvcCwgem9vbSwgd2FzUmVzaXplKSB7CiAgICAgIGlmICh0aGlzLmlzVmVydGljYWwpIHsKICAgICAgICB0aGlzLnJlbmRlcklmTmVlZGVkKHRyYW5zZm9ybVRvcCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5yZW5kZXJJZk5lZWRlZCh0cmFuc2Zvcm1MZWZ0KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fJGNhbGxiYWNrKHRyYW5zZm9ybUxlZnQsIHRyYW5zZm9ybVRvcCwgem9vbSwgd2FzUmVzaXplKTsKICAgIH0pLAoKICAgIHJlbmRlcklmTmVlZGVkOiBmdW5jdGlvbihzY3JvbGxQb3MpIHsKICAgICAgaWYgKCh0aGlzLmhhc05leHRJbmRleCAmJiBzY3JvbGxQb3MgPj0gdGhpcy5uZXh0UG9zKSB8fAogICAgICAgICAgKHRoaXMuaGFzUHJldkluZGV4ICYmIHNjcm9sbFBvcyA8IHRoaXMucHJldmlvdXNQb3MpKSB7CiAgICAgICAgICAgLy8gTWF0aC5hYnModHJhbnNmb3JtUG9zIC0gdGhpcy5sYXN0UmVuZGVyU2Nyb2xsVmFsdWUpID4gMTAwKSB7CiAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgfQogICAgfSwKICAgIC8qCiAgICAgKiBnZXRJbmRleEZvclNjcm9sbFZhbHVlOiBHaXZlbiB0aGUgbW9zdCByZWNlbnQgZGF0YSBpbmRleCBhbmQgYSBuZXcgc2Nyb2xsVmFsdWUsCiAgICAgKiBmaW5kIHRoZSBkYXRhIGluZGV4IHRoYXQgbWF0Y2hlcyB0aGF0IHNjcm9sbFZhbHVlLgogICAgICoKICAgICAqIFN0cmF0ZWd5IChpZiB3ZSBhcmUgc2Nyb2xsaW5nIGRvd24pOiBrZWVwIGdvaW5nIGZvcndhcmQgaW4gdGhlIGRpbWVuc2lvbnMgbGlzdCwKICAgICAqIHN0YXJ0aW5nIGF0IHRoZSBnaXZlbiBpbmRleCwgdW50aWwgYW4gaXRlbSB3aXRoIGhlaWdodCBtYXRjaGluZyB0aGUgbmV3IHNjcm9sbFZhbHVlCiAgICAgKiBpcyBmb3VuZC4KICAgICAqCiAgICAgKiBUaGlzIGlzIGEgd2hpbGUgbG9vcC4gSW4gdGhlIHdvcnN0IGNhc2UgaXQgd2lsbCBoYXZlIHRvIGdvIHRocm91Z2ggdGhlIHdob2xlIGxpc3QKICAgICAqIChlZyB0byBzY3JvbGwgZnJvbSB0b3AgdG8gYm90dG9tKS4gIFRoZSBtb3N0IGNvbW1vbiBjYXNlIGlzIHRvIHNjcm9sbAogICAgICogZG93biAxLTMgaXRlbXMgYXQgYSB0aW1lLgogICAgICoKICAgICAqIFdoaWxlIHRoaXMgaXMgbm90IGFzIGVmZmljaWVudCBhcyBpdCBjb3VsZCBiZSwgb3B0aW1pemluZyBpdCBnaXZlcyBubyBub3RpY2VhYmxlCiAgICAgKiBiZW5lZml0LiAgV2Ugd291bGQgaGF2ZSB0byB1c2UgYSBuZXcgbWVtb3J5LWludGVuc2l2ZSBkYXRhIHN0cnVjdHVyZSBmb3IgZGltZW5zaW9ucwogICAgICogdG8gZnVsbHkgb3B0aW1pemUgaXQuCiAgICAgKi8KICAgIGdldEluZGV4Rm9yU2Nyb2xsVmFsdWU6IGZ1bmN0aW9uKGksIHNjcm9sbFZhbHVlKSB7CiAgICAgIHZhciByZWN0OwogICAgICAvL1Njcm9sbGluZyB1cAogICAgICBpZiAoc2Nyb2xsVmFsdWUgPD0gdGhpcy5kaW1lbnNpb25zW2ldLnByaW1hcnlQb3MpIHsKICAgICAgICB3aGlsZSAoIChyZWN0ID0gdGhpcy5kaW1lbnNpb25zW2kgLSAxXSkgJiYgcmVjdC5wcmltYXJ5UG9zID4gc2Nyb2xsVmFsdWUpIHsKICAgICAgICAgIGktLTsKICAgICAgICB9CiAgICAgIC8vU2Nyb2xsaW5nIGRvd24KICAgICAgfSBlbHNlIHsKICAgICAgICB3aGlsZSAoIChyZWN0ID0gdGhpcy5kaW1lbnNpb25zW2kgKyAxXSkgJiYgcmVjdC5wcmltYXJ5UG9zIDwgc2Nyb2xsVmFsdWUpIHsKICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGk7CiAgICB9LAogICAgLyoKICAgICAqIHJlbmRlcjogRmlndXJlIG91dCB0aGUgc2Nyb2xsIHBvc2l0aW9uLCB0aGUgaW5kZXggbWF0Y2hpbmcgaXQsIGFuZCB0aGVuIHRlbGwKICAgICAqIHRoZSBkYXRhIHNvdXJjZSB0byByZW5kZXIgdGhlIGNvcnJlY3QgaXRlbXMgaW50byB0aGUgRE9NLgogICAgICovCiAgICByZW5kZXI6IGZ1bmN0aW9uKHNob3VsZFJlZHJhd0FsbCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBpOwogICAgICB2YXIgaXNPdXRPZkJvdW5kcyA9ICggdGhpcy5jdXJyZW50SW5kZXggPj0gdGhpcy5kYXRhU291cmNlLmdldExlbmd0aCgpICk7CiAgICAgIC8vIFdlIHdhbnQgdG8gcmVtb3ZlIGFsbCB0aGUgaXRlbXMgYW5kIHJlZHJhdyBldmVyeXRoaW5nIGlmIHdlJ3JlIG91dCBvZiBib3VuZHMKICAgICAgLy8gb3IgYSBmbGFnIGlzIHBhc3NlZCBpbi4KICAgICAgaWYgKGlzT3V0T2ZCb3VuZHMgfHwgc2hvdWxkUmVkcmF3QWxsKSB7CiAgICAgICAgZm9yIChpIGluIHRoaXMucmVuZGVyZWRJdGVtcykgewogICAgICAgICAgdGhpcy5yZW1vdmVJdGVtKGkpOwogICAgICAgIH0KICAgICAgICAvLyBKdXN0IGRvbid0IHJlbmRlciBhbnl0aGluZyBpZiB3ZSdyZSBvdXQgb2YgYm91bmRzCiAgICAgICAgaWYgKGlzT3V0T2ZCb3VuZHMpIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHJlY3Q7CiAgICAgIHZhciBzY3JvbGxWYWx1ZSA9IHRoaXMuc2Nyb2xsVmFsdWUoKTsKICAgICAgLy8gU2Nyb2xsIHNpemUgPSBob3cgbWFueSBwaXhlbHMgYXJlIHZpc2libGUgaW4gdGhlIHNjcm9sbGVyIGF0IG9uZSB0aW1lCiAgICAgIHZhciBzY3JvbGxTaXplID0gdGhpcy5zY3JvbGxTaXplKCk7CiAgICAgIC8vIFdlIHRha2UgdGhlIGN1cnJlbnQgc2Nyb2xsIHZhbHVlIGFuZCBhZGQgaXQgdG8gdGhlIHNjcm9sbFNpemUgdG8gZ2V0CiAgICAgIC8vIHdoYXQgc2Nyb2xsVmFsdWUgdGhlIGN1cnJlbnQgdmlzaWJsZSBzY3JvbGwgYXJlYSBlbmRzIGF0LgogICAgICB2YXIgc2Nyb2xsU2l6ZUVuZCA9IHNjcm9sbFNpemUgKyBzY3JvbGxWYWx1ZTsKICAgICAgLy8gR2V0IHRoZSBuZXcgc3RhcnQgaW5kZXggZm9yIHNjcm9sbGluZywgYmFzZWQgb24gdGhlIGN1cnJlbnQgc2Nyb2xsVmFsdWUgYW5kCiAgICAgIC8vIHRoZSBtb3N0IHJlY2VudCBrbm93biBpbmRleAogICAgICB2YXIgc3RhcnRJbmRleCA9IHRoaXMuZ2V0SW5kZXhGb3JTY3JvbGxWYWx1ZSh0aGlzLmN1cnJlbnRJbmRleCwgc2Nyb2xsVmFsdWUpOwoKICAgICAgLy8gSWYgd2UgYXJlbid0IG9uIHRoZSBmaXJzdCBpdGVtLCBhZGQgb25lIHJvdyBvZiBpdGVtcyBiZWZvcmUgc28gdGhhdCB3aGVuIHRoZSB1c2VyIGlzCiAgICAgIC8vIHNjcm9sbGluZyB1cCBoZSBzZWVzIHRoZSBwcmV2aW91cyBpdGVtCiAgICAgIHZhciByZW5kZXJTdGFydEluZGV4ID0gTWF0aC5tYXgoc3RhcnRJbmRleCAtIDEsIDApOwogICAgICAvLyBLZWVwIGFkZGluZyBpdGVtcyB0byB0aGUgJ2V4dHJhIHJvdyBhYm92ZScgdW50aWwgd2UgZ2V0IHRvIGEgbmV3IHJvdy4KICAgICAgLy8gVGhpcyBpcyBmb3IgdGhlIGNhc2Ugd2hlcmUgdGhlcmUgYXJlIG11bHRpcGxlIGl0ZW1zIG9uIG9uZSByb3cgYWJvdmUKICAgICAgLy8gdGhlIGN1cnJlbnQgaXRlbTsgd2Ugd2FudCB0byBrZWVwIGFkZGluZyBpdGVtcyBhYm92ZSB1bnRpbAogICAgICAvLyBhIG5ldyByb3cgaXMgcmVhY2hlZC4KICAgICAgd2hpbGUgKHJlbmRlclN0YXJ0SW5kZXggPiAwICYmCiAgICAgICAgIChyZWN0ID0gdGhpcy5kaW1lbnNpb25zW3JlbmRlclN0YXJ0SW5kZXhdKSAmJgogICAgICAgICByZWN0LnByaW1hcnlQb3MgPT09IHRoaXMuZGltZW5zaW9uc1tzdGFydEluZGV4IC0gMV0ucHJpbWFyeVBvcykgewogICAgICAgIHJlbmRlclN0YXJ0SW5kZXgtLTsKICAgICAgfQoKICAgICAgLy8gS2VlcCByZW5kZXJpbmcgaXRlbXMsIGFkZGluZyB0aGVtIHVudGlsIHdlIGFyZSBwYXN0IHRoZSBlbmQgb2YgdGhlIHZpc2libGUgc2Nyb2xsIGFyZWEKICAgICAgaSA9IHJlbmRlclN0YXJ0SW5kZXg7CiAgICAgIHdoaWxlICgocmVjdCA9IHRoaXMuZGltZW5zaW9uc1tpXSkgJiYgKHJlY3QucHJpbWFyeVBvcyAtIHJlY3QucHJpbWFyeVNpemUgPCBzY3JvbGxTaXplRW5kKSkgewogICAgICAgIGRvUmVuZGVyKGksIHJlY3QpOwogICAgICAgIGkrKzsKICAgICAgfQoKICAgICAgLy8gUmVuZGVyIHR3byBleHRyYSBpdGVtcyBhdCB0aGUgZW5kIGFzIGEgYnVmZmVyCiAgICAgIGlmIChzZWxmLmRpbWVuc2lvbnNbaV0pIHsKICAgICAgICBkb1JlbmRlcihpLCBzZWxmLmRpbWVuc2lvbnNbaV0pOwogICAgICAgIGkrKzsKICAgICAgfQogICAgICBpZiAoc2VsZi5kaW1lbnNpb25zW2ldKSB7CiAgICAgICAgZG9SZW5kZXIoaSwgc2VsZi5kaW1lbnNpb25zW2ldKTsKICAgICAgfQogICAgICB2YXIgcmVuZGVyRW5kSW5kZXggPSBpOwoKICAgICAgLy8gUmVtb3ZlIGFueSBpdGVtcyB0aGF0IHdlcmUgcmVuZGVyZWQgYW5kIGFyZW4ndCB2aXNpYmxlIGFueW1vcmUKICAgICAgZm9yICh2YXIgcmVuZGVySW5kZXggaW4gdGhpcy5yZW5kZXJlZEl0ZW1zKSB7CiAgICAgICAgaWYgKHJlbmRlckluZGV4IDwgcmVuZGVyU3RhcnRJbmRleCB8fCByZW5kZXJJbmRleCA+IHJlbmRlckVuZEluZGV4KSB7CiAgICAgICAgICB0aGlzLnJlbW92ZUl0ZW0ocmVuZGVySW5kZXgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5zZXRDdXJyZW50SW5kZXgoc3RhcnRJbmRleCk7CgogICAgICBmdW5jdGlvbiBkb1JlbmRlcihkYXRhSW5kZXgsIHJlY3QpIHsKICAgICAgICBpZiAoZGF0YUluZGV4IDwgc2VsZi5kYXRhU291cmNlLmRhdGFTdGFydEluZGV4KSB7CiAgICAgICAgICAvLyBkbyBub3RoaW5nCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYucmVuZGVySXRlbShkYXRhSW5kZXgsIHJlY3QucHJpbWFyeVBvcyAtIHNlbGYuYmVmb3JlU2l6ZSwgcmVjdC5zZWNvbmRhcnlQb3MpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHJlbmRlckl0ZW06IGZ1bmN0aW9uKGRhdGFJbmRleCwgcHJpbWFyeVBvcywgc2Vjb25kYXJ5UG9zKSB7CiAgICAgIC8vIEF0dGFjaCBhbiBpdGVtLCBhbmQgc2V0IGl0cyB0cmFuc2Zvcm0gcG9zaXRpb24gdG8gdGhlIHJlcXVpcmVkIHZhbHVlCiAgICAgIHZhciBpdGVtID0gdGhpcy5kYXRhU291cmNlLmF0dGFjaEl0ZW1BdEluZGV4KGRhdGFJbmRleCk7CiAgICAgIHZvaWQgMDsKICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5lbGVtZW50KSB7CiAgICAgICAgaWYgKGl0ZW0ucHJpbWFyeVBvcyAhPT0gcHJpbWFyeVBvcyB8fCBpdGVtLnNlY29uZGFyeVBvcyAhPT0gc2Vjb25kYXJ5UG9zKSB7CiAgICAgICAgICBpdGVtLmVsZW1lbnQuY3NzKGlvbmljLkNTUy5UUkFOU0ZPUk0sIHRoaXMudHJhbnNmb3JtU3RyaW5nKAogICAgICAgICAgICBwcmltYXJ5UG9zLCBzZWNvbmRhcnlQb3MKICAgICAgICAgICkpOwogICAgICAgICAgaXRlbS5wcmltYXJ5UG9zID0gcHJpbWFyeVBvczsKICAgICAgICAgIGl0ZW0uc2Vjb25kYXJ5UG9zID0gc2Vjb25kYXJ5UG9zOwogICAgICAgIH0KICAgICAgICAvLyBTYXZlIHRoZSBpdGVtIGluIHJlbmRlcmVkIGl0ZW1zCiAgICAgICAgdGhpcy5yZW5kZXJlZEl0ZW1zW2RhdGFJbmRleF0gPSBpdGVtOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIGFuIGl0ZW0gYXQgdGhpcyBpbmRleCBkb2Vzbid0IGV4aXN0IGFueW1vcmUsIGJlIHN1cmUgdG8gZGVsZXRlCiAgICAgICAgLy8gaXQgZnJvbSByZW5kZXJlZCBpdGVtcwogICAgICAgIGRlbGV0ZSB0aGlzLnJlbmRlcmVkSXRlbXNbZGF0YUluZGV4XTsKICAgICAgfQogICAgfSwKICAgIHJlbW92ZUl0ZW06IGZ1bmN0aW9uKGRhdGFJbmRleCkgewogICAgICAvLyBEZXRhY2ggYSBnaXZlbiBpdGVtCiAgICAgIHZhciBpdGVtID0gdGhpcy5yZW5kZXJlZEl0ZW1zW2RhdGFJbmRleF07CiAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgaXRlbS5wcmltYXJ5UG9zID0gaXRlbS5zZWNvbmRhcnlQb3MgPSBudWxsOwogICAgICAgIHRoaXMuZGF0YVNvdXJjZS5kZXRhY2hJdGVtKGl0ZW0pOwogICAgICAgIGRlbGV0ZSB0aGlzLnJlbmRlcmVkSXRlbXNbZGF0YUluZGV4XTsKICAgICAgfQogICAgfQogIH07CgogIHJldHVybiBDb2xsZWN0aW9uUmVwZWF0TWFuYWdlcjsKfV0pOwoKCmZ1bmN0aW9uIGRlbGVnYXRlU2VydmljZShtZXRob2ROYW1lcykgewogIHJldHVybiBbJyRsb2cnLCBmdW5jdGlvbigkbG9nKSB7CiAgICB2YXIgZGVsZWdhdGUgPSB0aGlzOwoKICAgIHZhciBpbnN0YW5jZXMgPSB0aGlzLl9pbnN0YW5jZXMgPSBbXTsKICAgIHRoaXMuX3JlZ2lzdGVySW5zdGFuY2UgPSBmdW5jdGlvbihpbnN0YW5jZSwgaGFuZGxlKSB7CiAgICAgIGluc3RhbmNlLiQkZGVsZWdhdGVIYW5kbGUgPSBoYW5kbGU7CiAgICAgIGluc3RhbmNlcy5wdXNoKGluc3RhbmNlKTsKCiAgICAgIHJldHVybiBmdW5jdGlvbiBkZXJlZ2lzdGVyKCkgewogICAgICAgIHZhciBpbmRleCA9IGluc3RhbmNlcy5pbmRleE9mKGluc3RhbmNlKTsKICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgICBpbnN0YW5jZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMuJGdldEJ5SGFuZGxlID0gZnVuY3Rpb24oaGFuZGxlKSB7CiAgICAgIGlmICghaGFuZGxlKSB7CiAgICAgICAgcmV0dXJuIGRlbGVnYXRlOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgSW5zdGFuY2VGb3JIYW5kbGUoaGFuZGxlKTsKICAgIH07CgogICAgLyoKICAgICAqIENyZWF0ZXMgYSBuZXcgb2JqZWN0IHRoYXQgd2lsbCBoYXZlIGFsbCB0aGUgbWV0aG9kTmFtZXMgZ2l2ZW4sCiAgICAgKiBhbmQgY2FsbCB0aGVtIG9uIHRoZSBnaXZlbiB0aGUgY29udHJvbGxlciBpbnN0YW5jZSBtYXRjaGluZyBnaXZlbgogICAgICogaGFuZGxlLgogICAgICogVGhlIHJlYXNvbiB3ZSBkb24ndCBqdXN0IGxldCAkZ2V0QnlIYW5kbGUgcmV0dXJuIHRoZSBjb250cm9sbGVyIGluc3RhbmNlCiAgICAgKiBpdHNlbGYgaXMgdGhhdCB0aGUgY29udHJvbGxlciBpbnN0YW5jZSBtaWdodCBub3QgZXhpc3QgeWV0LgogICAgICoKICAgICAqIFdlIHdhbnQgcGVvcGxlIHRvIGJlIGFibGUgdG8gZG8KICAgICAqIGB2YXIgaW5zdGFuY2UgPSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ2ZvbycpYCBvbiBjb250cm9sbGVyCiAgICAgKiBpbnN0YW50aWF0aW9uLCBidXQgb24gY29udHJvbGxlciBpbnN0YW50aWF0aW9uIGEgY2hpbGQgZGlyZWN0aXZlCiAgICAgKiBtYXkgbm90IGhhdmUgYmVlbiBjb21waWxlZCB5ZXQhCiAgICAgKgogICAgICogU28gdGhpcyBpcyBvdXIgd2F5IG9mIHNvbHZpbmcgdGhpcyBwcm9ibGVtOiB3ZSBjcmVhdGUgYW4gb2JqZWN0CiAgICAgKiB0aGF0IHdpbGwgb25seSB0cnkgdG8gZmV0Y2ggdGhlIGNvbnRyb2xsZXIgd2l0aCBnaXZlbiBoYW5kbGUKICAgICAqIG9uY2UgdGhlIG1ldGhvZHMgYXJlIGFjdHVhbGx5IGNhbGxlZC4KICAgICAqLwogICAgZnVuY3Rpb24gSW5zdGFuY2VGb3JIYW5kbGUoaGFuZGxlKSB7CiAgICAgIHRoaXMuaGFuZGxlID0gaGFuZGxlOwogICAgfQogICAgbWV0aG9kTmFtZXMuZm9yRWFjaChmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgIEluc3RhbmNlRm9ySGFuZGxlLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBoYW5kbGUgPSB0aGlzLmhhbmRsZTsKICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICB2YXIgbWF0Y2hpbmdJbnN0YW5jZXNGb3VuZCA9IDA7CiAgICAgICAgdmFyIGZpbmFsUmVzdWx0OwogICAgICAgIHZhciByZXN1bHQ7CgogICAgICAgIC8vVGhpcyBsb2dpYyBpcyByZXBlYXRlZCBiZWxvdzsgd2UgY291bGQgZmFjdG9yIHNvbWUgb2YgaXQgb3V0IHRvIGEgZnVuY3Rpb24KICAgICAgICAvL2J1dCBkb24ndCBiZWNhdXNlIGl0IGxldHMgdGhpcyBtZXRob2QgYmUgbW9yZSBwZXJmb3JtYW50IChvbmUgbG9vcCB2ZXJzdXMgMikKICAgICAgICBpbnN0YW5jZXMuZm9yRWFjaChmdW5jdGlvbihpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGluc3RhbmNlLiQkZGVsZWdhdGVIYW5kbGUgPT09IGhhbmRsZSkgewogICAgICAgICAgICBtYXRjaGluZ0luc3RhbmNlc0ZvdW5kKys7CiAgICAgICAgICAgIHJlc3VsdCA9IGluc3RhbmNlW21ldGhvZE5hbWVdLmFwcGx5KGluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgICAgLy9Pbmx5IHJldHVybiB0aGUgdmFsdWUgZnJvbSB0aGUgZmlyc3QgY2FsbAogICAgICAgICAgICBpZiAobWF0Y2hpbmdJbnN0YW5jZXNGb3VuZCA9PT0gMSkgewogICAgICAgICAgICAgIGZpbmFsUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGlmICghbWF0Y2hpbmdJbnN0YW5jZXNGb3VuZCkgewogICAgICAgICAgcmV0dXJuICRsb2cud2FybigKICAgICAgICAgICAgJ0RlbGVnYXRlIGZvciBoYW5kbGUgIicrdGhpcy5oYW5kbGUrJyIgY291bGQgbm90IGZpbmQgYSAnICsKICAgICAgICAgICAgJ2NvcnJlc3BvbmRpbmcgZWxlbWVudCB3aXRoIGRlbGVnYXRlLWhhbmRsZT0iJyt0aGlzLmhhbmRsZSsnIiEgJyArCiAgICAgICAgICAgIG1ldGhvZE5hbWUgKyAnKCkgd2FzIG5vdCBjYWxsZWQhXG4nICsKICAgICAgICAgICAgJ1Bvc3NpYmxlIGNhdXNlOiBJZiB5b3UgYXJlIGNhbGxpbmcgJyArIG1ldGhvZE5hbWUgKyAnKCkgaW1tZWRpYXRlbHksIGFuZCAnICsKICAgICAgICAgICAgJ3lvdXIgZWxlbWVudCB3aXRoIGRlbGVnYXRlLWhhbmRsZT0iJyArIHRoaXMuaGFuZGxlICsgJyIgaXMgYSBjaGlsZCBvZiB5b3VyICcgKwogICAgICAgICAgICAnY29udHJvbGxlciwgdGhlbiB5b3VyIGVsZW1lbnQgbWF5IG5vdCBiZSBjb21waWxlZCB5ZXQuIFB1dCBhICR0aW1lb3V0ICcgKwogICAgICAgICAgICAnYXJvdW5kIHlvdXIgY2FsbCB0byAnICsgbWV0aG9kTmFtZSArICcoKSBhbmQgdHJ5IGFnYWluLicKICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmluYWxSZXN1bHQ7CiAgICAgIH07CiAgICAgIGRlbGVnYXRlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgdmFyIGZpbmFsUmVzdWx0OwogICAgICAgIHZhciByZXN1bHQ7CgogICAgICAgIC8vVGhpcyBsb2dpYyBpcyByZXBlYXRlZCBhYm92ZQogICAgICAgIGluc3RhbmNlcy5mb3JFYWNoKGZ1bmN0aW9uKGluc3RhbmNlLCBpbmRleCkgewogICAgICAgICAgcmVzdWx0ID0gaW5zdGFuY2VbbWV0aG9kTmFtZV0uYXBwbHkoaW5zdGFuY2UsIGFyZ3MpOwogICAgICAgICAgLy9Pbmx5IHJldHVybiB0aGUgdmFsdWUgZnJvbSB0aGUgZmlyc3QgY2FsbAogICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGZpbmFsUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZmluYWxSZXN1bHQ7CiAgICAgIH07CgogICAgICBmdW5jdGlvbiBjYWxsTWV0aG9kKGluc3RhbmNlc1RvVXNlLCBtZXRob2ROYW1lLCBhcmdzKSB7CiAgICAgICAgdmFyIGZpbmFsUmVzdWx0OwogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaW5zdGFuY2VzVG9Vc2UuZm9yRWFjaChmdW5jdGlvbihpbnN0YW5jZSwgaW5kZXgpIHsKICAgICAgICAgIHJlc3VsdCA9IGluc3RhbmNlW21ldGhvZE5hbWVdLmFwcGx5KGluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgIC8vTWFrZSBpdCBzbyB0aGUgZmlyc3QgcmVzdWx0IGlzIHRoZSBvbmUgcmV0dXJuZWQKICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkgewogICAgICAgICAgICBmaW5hbFJlc3VsdCA9IHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZmluYWxSZXN1bHQ7CiAgICAgIH0KICAgIH0pOwogIH1dOwp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljR2VzdHVyZQogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbiBBbiBhbmd1bGFyIHNlcnZpY2UgZXhwb3NpbmcgaW9uaWMKICoge0BsaW5rIGlvbmljLnV0aWxpdHk6aW9uaWMuRXZlbnRDb250cm9sbGVyfSdzIGdlc3R1cmVzLgogKi8KSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY0dlc3R1cmUnLCBbZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljR2VzdHVyZSNvbgogICAgICogQGRlc2NyaXB0aW9uIEFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBnZXN0dXJlIG9uIGFuIGVsZW1lbnQuIFNlZSB7QGxpbmsgaW9uaWMudXRpbGl0eTppb25pYy5FdmVudENvbnRyb2xsZXIjb25HZXN0dXJlfS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudFR5cGUgVGhlIGdlc3R1cmUgZXZlbnQgdG8gbGlzdGVuIGZvci4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZSl9IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGdlc3R1cmUKICAgICAqIGhhcHBlbnMuCiAgICAgKiBAcGFyYW0ge2VsZW1lbnR9ICRlbGVtZW50IFRoZSBhbmd1bGFyIGVsZW1lbnQgdG8gbGlzdGVuIGZvciB0aGUgZXZlbnQgb24uCiAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZX0gVGhlIGdlc3R1cmUgb2JqZWN0ICh1c2UgdGhpcyB0byByZW1vdmUgdGhlIGdlc3R1cmUgbGF0ZXIgb24pLgogICAgICovCiAgICBvbjogZnVuY3Rpb24oZXZlbnRUeXBlLCBjYiwgJGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHdpbmRvdy5pb25pYy5vbkdlc3R1cmUoZXZlbnRUeXBlLCBjYiwgJGVsZW1lbnRbMF0sIG9wdGlvbnMpOwogICAgfSwKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljR2VzdHVyZSNvZmYKICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIGEgZ2VzdHVyZSBvbiBhbiBlbGVtZW50LiBTZWUge0BsaW5rIGlvbmljLnV0aWxpdHk6aW9uaWMuRXZlbnRDb250cm9sbGVyI29mZkdlc3R1cmV9LgogICAgICogQHBhcmFtIHtpb25pYy5HZXN0dXJlfSBnZXN0dXJlIFRoZSBnZXN0dXJlIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnRUeXBlIFRoZSBnZXN0dXJlIGV2ZW50IHRvIHJlbW92ZSB0aGUgbGlzdGVuZXIgZm9yLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihlKX0gY2FsbGJhY2sgVGhlIGxpc3RlbmVyIHRvIHJlbW92ZS4KICAgICAqLwogICAgb2ZmOiBmdW5jdGlvbihnZXN0dXJlLCBldmVudFR5cGUsIGNiKSB7CiAgICAgIHJldHVybiB3aW5kb3cuaW9uaWMub2ZmR2VzdHVyZShnZXN0dXJlLCBldmVudFR5cGUsIGNiKTsKICAgIH0KICB9Owp9XSk7CgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRpb25pY0NvbmZpZ1Byb3ZpZGVyCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uICRpb25pY0NvbmZpZ1Byb3ZpZGVyIGNhbiBiZSB1c2VkIGR1cmluZyB0aGUgY29uZmlndXJhdGlvbiBwaGFzZSBvZiB5b3VyIGFwcAogKiB0byBjaGFuZ2UgaG93IElvbmljIHdvcmtzLgogKgogKiBAdXNhZ2UKICogYGBganMKICogdmFyIG15QXBwID0gYW5ndWxhci5tb2R1bGUoJ3JlYWxseUNvb2xBcHAnLCBbJ2lvbmljJ10pOwogKgogKiBteUFwcC5jb25maWcoZnVuY3Rpb24oJGlvbmljQ29uZmlnUHJvdmlkZXIpIHsKICogICAkaW9uaWNDb25maWdQcm92aWRlci5wcmVmZXRjaFRlbXBsYXRlcyhmYWxzZSk7CiAqIH0pOwogKiBgYGAKICovCklvbmljTW9kdWxlCi5wcm92aWRlcignJGlvbmljQ29uZmlnJywgZnVuY3Rpb24oKSB7CgogIHZhciBwcm92aWRlciA9IHRoaXM7CiAgdmFyIGNvbmZpZyA9IHsKICAgIHByZWZldGNoVGVtcGxhdGVzOiB0cnVlCiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY0NvbmZpZ1Byb3ZpZGVyI3ByZWZldGNoVGVtcGxhdGVzCiAgICogQGRlc2NyaXB0aW9uIFNldCB3aGV0aGVyIElvbmljIHNob3VsZCBwcmVmZXRjaCBhbGwgdGVtcGxhdGVVcmxzIGRlZmluZWQgaW4KICAgKiAkc3RhdGVQcm92aWRlci5zdGF0ZS4gRGVmYXVsdCB0cnVlLiBJZiBzZXQgdG8gZmFsc2UsIHRoZSB1c2VyIHdpbGwgaGF2ZSB0byB3YWl0CiAgICogZm9yIGEgdGVtcGxhdGUgdG8gYmUgZmV0Y2hlZCB0aGUgZmlyc3QgdGltZSBoZS9zaGUgaXMgZ29pbmcgdG8gYSBhIG5ldyBwYWdlLgogICAqIEBwYXJhbSBzaG91bGRQcmVmZXRjaCBXaGV0aGVyIElvbmljIHNob3VsZCBwcmVmZXRjaCB0ZW1wbGF0ZVVybHMgZGVmaW5lZCBpbgogICAqIGAkc3RhdGVQcm92aWRlci5zdGF0ZSgpYC4gRGVmYXVsdCB0cnVlLgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIElvbmljIHdpbGwgcHJlZmV0Y2ggdGVtcGxhdGVVcmxzIGRlZmluZWQgaW4gJHN0YXRlUHJvdmlkZXIuc3RhdGUuCiAgICovCiAgdGhpcy5wcmVmZXRjaFRlbXBsYXRlcyA9IGZ1bmN0aW9uKG5ld1ZhbHVlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBjb25maWcucHJlZmV0Y2hUZW1wbGF0ZXMgPSBuZXdWYWx1ZTsKICAgIH0KICAgIHJldHVybiBjb25maWcucHJlZmV0Y2hUZW1wbGF0ZXM7CiAgfTsKCiAgLy8gcHJpdmF0ZTogU2VydmljZSBkZWZpbml0aW9uIGZvciBpbnRlcm5hbCBJb25pYyB1c2UKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY0NvbmZpZwogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvbmZpZzsKICB9Owp9KTsKCgp2YXIgTE9BRElOR19UUEwgPQogICc8ZGl2IGNsYXNzPSJsb2FkaW5nLWNvbnRhaW5lciI+JyArCiAgICAnPGRpdiBjbGFzcz0ibG9hZGluZyI+JyArCiAgICAnPC9kaXY+JyArCiAgJzwvZGl2Pic7Cgp2YXIgTE9BRElOR19ISURFX0RFUFJFQ0FURUQgPSAnJGlvbmljTG9hZGluZyBpbnN0YW5jZS5oaWRlKCkgaGFzIGJlZW4gZGVwcmVjYXRlZC4gVXNlICRpb25pY0xvYWRpbmcuaGlkZSgpLic7CnZhciBMT0FESU5HX1NIT1dfREVQUkVDQVRFRCA9ICckaW9uaWNMb2FkaW5nIGluc3RhbmNlLnNob3coKSBoYXMgYmVlbiBkZXByZWNhdGVkLiBVc2UgJGlvbmljTG9hZGluZy5zaG93KCkuJzsKdmFyIExPQURJTkdfU0VUX0RFUFJFQ0FURUQgPSAnJGlvbmljTG9hZGluZyBpbnN0YW5jZS5zZXRDb250ZW50KCkgaGFzIGJlZW4gZGVwcmVjYXRlZC4gVXNlICRpb25pY0xvYWRpbmcuc2hvdyh7IHRlbXBsYXRlOiBcJ215IGNvbnRlbnRcJyB9KS4nOwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY0xvYWRpbmcKICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24KICogQW4gb3ZlcmxheSB0aGF0IGNhbiBiZSB1c2VkIHRvIGluZGljYXRlIGFjdGl2aXR5IHdoaWxlIGJsb2NraW5nIHVzZXIKICogaW50ZXJhY3Rpb24uCiAqCiAqIEB1c2FnZQogKiBgYGBqcwogKiBhbmd1bGFyLm1vZHVsZSgnTG9hZGluZ0FwcCcsIFsnaW9uaWMnXSkKICogLmNvbnRyb2xsZXIoJ0xvYWRpbmdDdHJsJywgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNMb2FkaW5nKSB7CiAqICAgJHNjb3BlLnNob3cgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY0xvYWRpbmcuc2hvdyh7CiAqICAgICAgIHRlbXBsYXRlOiAnTG9hZGluZy4uLicKICogICAgIH0pOwogKiAgIH07CiAqICAgJHNjb3BlLmhpZGUgPSBmdW5jdGlvbigpewogKiAgICAgJGlvbmljTG9hZGluZy5oaWRlKCk7CiAqICAgfTsKICogfSk7CiAqIGBgYAogKi8KLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgJGlvbmljTG9hZGluZ0NvbmZpZwogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKiBTZXQgdGhlIGRlZmF1bHQgb3B0aW9ucyB0byBiZSBwYXNzZWQgdG8gdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY0xvYWRpbmd9IHNlcnZpY2UuCiAqCiAqIEB1c2FnZQogKiBgYGBqcwogKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ215QXBwJywgWydpb25pYyddKQogKiBhcHAuY29uc3RhbnQoJyRpb25pY0xvYWRpbmdDb25maWcnLCB7CiAqICAgdGVtcGxhdGU6ICdEZWZhdWx0IExvYWRpbmcgVGVtcGxhdGUuLi4nCiAqIH0pOwogKiBhcHAuY29udHJvbGxlcignQXBwQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJGlvbmljTG9hZGluZykgewogKiAgICRzY29wZS5zaG93TG9hZGluZyA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljTG9hZGluZy5zaG93KCk7IC8vb3B0aW9ucyBkZWZhdWx0IHRvIHZhbHVlcyBpbiAkaW9uaWNMb2FkaW5nQ29uZmlnCiAqICAgfTsKICogfSk7CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmNvbnN0YW50KCckaW9uaWNMb2FkaW5nQ29uZmlnJywgewogIHRlbXBsYXRlOiAnPGkgY2xhc3M9Imlvbi1sb2FkaW5nLWQiPjwvaT4nCn0pCi5mYWN0b3J5KCckaW9uaWNMb2FkaW5nJywgWwogICckaW9uaWNMb2FkaW5nQ29uZmlnJywKICAnJGlvbmljQm9keScsCiAgJyRpb25pY1RlbXBsYXRlTG9hZGVyJywKICAnJGlvbmljQmFja2Ryb3AnLAogICckdGltZW91dCcsCiAgJyRxJywKICAnJGxvZycsCiAgJyRjb21waWxlJywKICAnJGlvbmljUGxhdGZvcm0nLApmdW5jdGlvbigkaW9uaWNMb2FkaW5nQ29uZmlnLCAkaW9uaWNCb2R5LCAkaW9uaWNUZW1wbGF0ZUxvYWRlciwgJGlvbmljQmFja2Ryb3AsICR0aW1lb3V0LCAkcSwgJGxvZywgJGNvbXBpbGUsICRpb25pY1BsYXRmb3JtKSB7CgogIHZhciBsb2FkZXJJbnN0YW5jZTsKICAvL2RlZmF1bHQgdmFsdWVzCiAgdmFyIGRlcmVnaXN0ZXJCYWNrQWN0aW9uID0gYW5ndWxhci5ub29wOwogIHZhciBsb2FkaW5nU2hvd0RlbGF5ID0gJHEud2hlbigpOwoKICByZXR1cm4gewogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNMb2FkaW5nI3Nob3cKICAgICAqIEBkZXNjcmlwdGlvbiBTaG93cyBhIGxvYWRpbmcgaW5kaWNhdG9yLiBJZiB0aGUgaW5kaWNhdG9yIGlzIGFscmVhZHkgc2hvd24sCiAgICAgKiBpdCB3aWxsIHNldCB0aGUgb3B0aW9ucyBnaXZlbiBhbmQga2VlcCB0aGUgaW5kaWNhdG9yIHNob3duLgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdHMgVGhlIG9wdGlvbnMgZm9yIHRoZSBsb2FkaW5nIGluZGljYXRvci4gQXZhaWxhYmxlIHByb3BlcnRpZXM6CiAgICAgKiAgLSBge3N0cmluZz19YCBgdGVtcGxhdGVgIFRoZSBodG1sIGNvbnRlbnQgb2YgdGhlIGluZGljYXRvci4KICAgICAqICAtIGB7c3RyaW5nPX1gIGB0ZW1wbGF0ZVVybGAgVGhlIHVybCBvZiBhbiBodG1sIHRlbXBsYXRlIHRvIGxvYWQgYXMgdGhlIGNvbnRlbnQgb2YgdGhlIGluZGljYXRvci4KICAgICAqICAtIGB7Ym9vbGVhbj19YCBgbm9CYWNrZHJvcGAgV2hldGhlciB0byBoaWRlIHRoZSBiYWNrZHJvcC4gQnkgZGVmYXVsdCBpdCB3aWxsIGJlIHNob3duLgogICAgICogIC0gYHtudW1iZXI9fWAgYGRlbGF5YCBIb3cgbWFueSBtaWxsaXNlY29uZHMgdG8gZGVsYXkgc2hvd2luZyB0aGUgaW5kaWNhdG9yLiBCeSBkZWZhdWx0IHRoZXJlIGlzIG5vIGRlbGF5LgogICAgICogIC0gYHtudW1iZXI9fWAgYGR1cmF0aW9uYCBIb3cgbWFueSBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBhdXRvbWF0aWNhbGx5CiAgICAgKiAgaGlkaW5nIHRoZSBpbmRpY2F0b3IuIEJ5IGRlZmF1bHQsIHRoZSBpbmRpY2F0b3Igd2lsbCBiZSBzaG93biB1bnRpbCBgLmhpZGUoKWAgaXMgY2FsbGVkLgogICAgICovCiAgICBzaG93OiBzaG93TG9hZGVyLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNMb2FkaW5nI2hpZGUKICAgICAqIEBkZXNjcmlwdGlvbiBIaWRlcyB0aGUgbG9hZGluZyBpbmRpY2F0b3IsIGlmIHNob3duLgogICAgICovCiAgICBoaWRlOiBoaWRlTG9hZGVyLAogICAgLyoqCiAgICAgKiBAcHJpdmF0ZSBmb3IgdGVzdGluZwogICAgICovCiAgICBfZ2V0TG9hZGVyOiBnZXRMb2FkZXIKICB9OwoKICBmdW5jdGlvbiBnZXRMb2FkZXIoKSB7CiAgICBpZiAoIWxvYWRlckluc3RhbmNlKSB7CiAgICAgIGxvYWRlckluc3RhbmNlID0gJGlvbmljVGVtcGxhdGVMb2FkZXIuY29tcGlsZSh7CiAgICAgICAgdGVtcGxhdGU6IExPQURJTkdfVFBMLAogICAgICAgIGFwcGVuZFRvOiAkaW9uaWNCb2R5LmdldCgpCiAgICAgIH0pCiAgICAgIC50aGVuKGZ1bmN0aW9uKGxvYWRlcikgewogICAgICAgIHZhciBzZWxmID0gbG9hZGVyOwoKICAgICAgICBsb2FkZXIuc2hvdyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIHZhciB0ZW1wbGF0ZVByb21pc2UgPSBvcHRpb25zLnRlbXBsYXRlVXJsID8KICAgICAgICAgICAgJGlvbmljVGVtcGxhdGVMb2FkZXIubG9hZChvcHRpb25zLnRlbXBsYXRlVXJsKSA6CiAgICAgICAgICAgIC8vb3B0aW9ucy5jb250ZW50OiBkZXByZWNhdGVkCiAgICAgICAgICAgICRxLndoZW4ob3B0aW9ucy50ZW1wbGF0ZSB8fCBvcHRpb25zLmNvbnRlbnQgfHwgJycpOwoKCiAgICAgICAgICBpZiAoIXRoaXMuaXNTaG93bikgewogICAgICAgICAgICAvL29wdGlvbnMuc2hvd0JhY2tkcm9wOiBkZXByZWNhdGVkCiAgICAgICAgICAgIHRoaXMuaGFzQmFja2Ryb3AgPSAhb3B0aW9ucy5ub0JhY2tkcm9wICYmIG9wdGlvbnMuc2hvd0JhY2tkcm9wICE9PSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFja2Ryb3ApIHsKICAgICAgICAgICAgICAkaW9uaWNCYWNrZHJvcC5yZXRhaW4oKTsKICAgICAgICAgICAgICAkaW9uaWNCYWNrZHJvcC5nZXRFbGVtZW50KCkuYWRkQ2xhc3MoJ2JhY2tkcm9wLWxvYWRpbmcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmIChvcHRpb25zLmR1cmF0aW9uKSB7CiAgICAgICAgICAgICR0aW1lb3V0LmNhbmNlbCh0aGlzLmR1cmF0aW9uVGltZW91dCk7CiAgICAgICAgICAgIHRoaXMuZHVyYXRpb25UaW1lb3V0ID0gJHRpbWVvdXQoCiAgICAgICAgICAgICAgYW5ndWxhci5iaW5kKHRoaXMsIHRoaXMuaGlkZSksCiAgICAgICAgICAgICAgK29wdGlvbnMuZHVyYXRpb24KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0ZW1wbGF0ZVByb21pc2UudGhlbihmdW5jdGlvbihodG1sKSB7CiAgICAgICAgICAgIGlmIChodG1sKSB7CiAgICAgICAgICAgICAgdmFyIGxvYWRpbmcgPSBzZWxmLmVsZW1lbnQuY2hpbGRyZW4oKTsKICAgICAgICAgICAgICBsb2FkaW5nLmh0bWwoaHRtbCk7CiAgICAgICAgICAgICAgJGNvbXBpbGUobG9hZGluZy5jb250ZW50cygpKShzZWxmLnNjb3BlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9Eb24ndCBzaG93IHVudGlsIHRlbXBsYXRlIGNoYW5nZXMKICAgICAgICAgICAgaWYgKHNlbGYuaXNTaG93bikgewogICAgICAgICAgICAgIHNlbGYuZWxlbWVudC5hZGRDbGFzcygndmlzaWJsZScpOwogICAgICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNTaG93bikgewogICAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAkaW9uaWNCb2R5LmFkZENsYXNzKCdsb2FkaW5nLWFjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICB0aGlzLmlzU2hvd24gPSB0cnVlOwogICAgICAgIH07CiAgICAgICAgbG9hZGVyLmhpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLmlzU2hvd24pIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFja2Ryb3ApIHsKICAgICAgICAgICAgICAkaW9uaWNCYWNrZHJvcC5yZWxlYXNlKCk7CiAgICAgICAgICAgICAgJGlvbmljQmFja2Ryb3AuZ2V0RWxlbWVudCgpLnJlbW92ZUNsYXNzKCdiYWNrZHJvcC1sb2FkaW5nJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgJGlvbmljQm9keS5yZW1vdmVDbGFzcygnbG9hZGluZy1hY3RpdmUnKTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAhc2VsZi5pc1Nob3duICYmIHNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcygndmlzaWJsZScpOwogICAgICAgICAgICB9LCAyMDApOwogICAgICAgICAgfQogICAgICAgICAgJHRpbWVvdXQuY2FuY2VsKHRoaXMuZHVyYXRpb25UaW1lb3V0KTsKICAgICAgICAgIHRoaXMuaXNTaG93biA9IGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBsb2FkZXI7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGxvYWRlckluc3RhbmNlOwogIH0KCiAgZnVuY3Rpb24gc2hvd0xvYWRlcihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZXh0ZW5kKCRpb25pY0xvYWRpbmdDb25maWcgfHwge30sIG9wdGlvbnMgfHwge30pOwogICAgdmFyIGRlbGF5ID0gb3B0aW9ucy5kZWxheSB8fCBvcHRpb25zLnNob3dEZWxheSB8fCAwOwoKICAgIC8vSWYgbG9hZGluZy5zaG93KCkgd2FzIGNhbGxlZCBwcmV2aW91c2x5LCBjYW5jZWwgaXQgYW5kIHNob3cgd2l0aCBvdXIgbmV3IG9wdGlvbnMKICAgIGxvYWRpbmdTaG93RGVsYXkgJiYgJHRpbWVvdXQuY2FuY2VsKGxvYWRpbmdTaG93RGVsYXkpOwogICAgbG9hZGluZ1Nob3dEZWxheSA9ICR0aW1lb3V0KGFuZ3VsYXIubm9vcCwgZGVsYXkpOwoKICAgIGxvYWRpbmdTaG93RGVsYXkudGhlbihnZXRMb2FkZXIpLnRoZW4oZnVuY3Rpb24obG9hZGVyKSB7CiAgICAgIGRlcmVnaXN0ZXJCYWNrQWN0aW9uKCk7CiAgICAgIC8vRGlzYWJsZSBoYXJkd2FyZSBiYWNrIGJ1dHRvbiB3aGlsZSBsb2FkaW5nCiAgICAgIGRlcmVnaXN0ZXJCYWNrQWN0aW9uID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgIGFuZ3VsYXIubm9vcCwKICAgICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9MT0FESU5HCiAgICAgICk7CiAgICAgIHJldHVybiBsb2FkZXIuc2hvdyhvcHRpb25zKTsKICAgIH0pOwoKICAgIHJldHVybiB7CiAgICAgIGhpZGU6IGRlcHJlY2F0ZWQubWV0aG9kKExPQURJTkdfSElERV9ERVBSRUNBVEVELCAkbG9nLmVycm9yLCBoaWRlTG9hZGVyKSwKICAgICAgc2hvdzogZGVwcmVjYXRlZC5tZXRob2QoTE9BRElOR19TSE9XX0RFUFJFQ0FURUQsICRsb2cuZXJyb3IsIGZ1bmN0aW9uKCkgewogICAgICAgIHNob3dMb2FkZXIob3B0aW9ucyk7CiAgICAgIH0pLAogICAgICBzZXRDb250ZW50OiBkZXByZWNhdGVkLm1ldGhvZChMT0FESU5HX1NFVF9ERVBSRUNBVEVELCAkbG9nLmVycm9yLCBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgZ2V0TG9hZGVyKCkudGhlbihmdW5jdGlvbihsb2FkZXIpIHsKICAgICAgICAgIGxvYWRlci5zaG93KHsgdGVtcGxhdGU6IGNvbnRlbnQgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaGlkZUxvYWRlcigpIHsKICAgIGRlcmVnaXN0ZXJCYWNrQWN0aW9uKCk7CiAgICAkdGltZW91dC5jYW5jZWwobG9hZGluZ1Nob3dEZWxheSk7CiAgICBnZXRMb2FkZXIoKS50aGVuKGZ1bmN0aW9uKGxvYWRlcikgewogICAgICBsb2FkZXIuaGlkZSgpOwogICAgfSk7CiAgfQp9XSk7CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljTW9kYWwKICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24KICoKICogUmVsYXRlZDoge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNNb2RhbCBpb25pY01vZGFsIGNvbnRyb2xsZXJ9LgogKgogKiBUaGUgTW9kYWwgaXMgYSBjb250ZW50IHBhbmUgdGhhdCBjYW4gZ28gb3ZlciB0aGUgdXNlcidzIG1haW4gdmlldwogKiB0ZW1wb3JhcmlseS4gIFVzdWFsbHkgdXNlZCBmb3IgbWFraW5nIGEgY2hvaWNlIG9yIGVkaXRpbmcgYW4gaXRlbS4KICoKICogUHV0IHRoZSBjb250ZW50IG9mIHRoZSBtb2RhbCBpbnNpZGUgb2YgYW4gYDxpb24tbW9kYWwtdmlldz5gIGVsZW1lbnQuCiAqCiAqIE5vdGU6IGEgbW9kYWwgd2lsbCBicm9hZGNhc3QgJ21vZGFsLnNob3duJywgJ21vZGFsLmhpZGRlbicsIGFuZCAnbW9kYWwucmVtb3ZlZCcgZXZlbnRzIGZyb20gaXRzIG9yaWdpbmF0aW5nCiAqIHNjb3BlLCBwYXNzaW5nIGluIGl0c2VsZiBhcyBhbiBldmVudCBhcmd1bWVudC4gQm90aCB0aGUgbW9kYWwucmVtb3ZlZCBhbmQgbW9kYWwuaGlkZGVuIGV2ZW50cyBhcmUKICogY2FsbGVkIHdoZW4gdGhlIG1vZGFsIGlzIHJlbW92ZWQuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxzY3JpcHQgaWQ9Im15LW1vZGFsLmh0bWwiIHR5cGU9InRleHQvbmctdGVtcGxhdGUiPgogKiAgIDxpb24tbW9kYWwtdmlldz4KICogICAgIDxpb24taGVhZGVyLWJhcj4KICogICAgICAgPGgxIGNsYXNzPSJ0aXRsZSI+TXkgTW9kYWwgdGl0bGU8L2gxPgogKiAgICAgPC9pb24taGVhZGVyLWJhcj4KICogICAgIDxpb24tY29udGVudD4KICogICAgICAgSGVsbG8hCiAqICAgICA8L2lvbi1jb250ZW50PgogKiAgIDwvaW9uLW1vZGFsLXZpZXc+CiAqIDwvc2NyaXB0PgogKiBgYGAKICogYGBganMKICogYW5ndWxhci5tb2R1bGUoJ3Rlc3RBcHAnLCBbJ2lvbmljJ10pCiAqIC5jb250cm9sbGVyKCdNeUNvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUsICRpb25pY01vZGFsKSB7CiAqICAgJGlvbmljTW9kYWwuZnJvbVRlbXBsYXRlVXJsKCdteS1tb2RhbC5odG1sJywgewogKiAgICAgc2NvcGU6ICRzY29wZSwKICogICAgIGFuaW1hdGlvbjogJ3NsaWRlLWluLXVwJwogKiAgIH0pLnRoZW4oZnVuY3Rpb24obW9kYWwpIHsKICogICAgICRzY29wZS5tb2RhbCA9IG1vZGFsOwogKiAgIH0pOwogKiAgICRzY29wZS5vcGVuTW9kYWwgPSBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5tb2RhbC5zaG93KCk7CiAqICAgfTsKICogICAkc2NvcGUuY2xvc2VNb2RhbCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJHNjb3BlLm1vZGFsLmhpZGUoKTsKICogICB9OwogKiAgIC8vQ2xlYW51cCB0aGUgbW9kYWwgd2hlbiB3ZSdyZSBkb25lIHdpdGggaXQhCiAqICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5tb2RhbC5yZW1vdmUoKTsKICogICB9KTsKICogICAvLyBFeGVjdXRlIGFjdGlvbiBvbiBoaWRlIG1vZGFsCiAqICAgJHNjb3BlLiRvbignbW9kYWwuaGlkZGVuJywgZnVuY3Rpb24oKSB7CiAqICAgICAvLyBFeGVjdXRlIGFjdGlvbgogKiAgIH0pOwogKiAgIC8vIEV4ZWN1dGUgYWN0aW9uIG9uIHJlbW92ZSBtb2RhbAogKiAgICRzY29wZS4kb24oJ21vZGFsLnJlbW92ZWQnLCBmdW5jdGlvbigpIHsKICogICAgIC8vIEV4ZWN1dGUgYWN0aW9uCiAqICAgfSk7CiAqIH0pOwogKiBgYGAKICovCklvbmljTW9kdWxlCi5mYWN0b3J5KCckaW9uaWNNb2RhbCcsIFsKICAnJHJvb3RTY29wZScsCiAgJyRpb25pY0JvZHknLAogICckY29tcGlsZScsCiAgJyR0aW1lb3V0JywKICAnJGlvbmljUGxhdGZvcm0nLAogICckaW9uaWNUZW1wbGF0ZUxvYWRlcicsCiAgJyRxJywKICAnJGxvZycsCmZ1bmN0aW9uKCRyb290U2NvcGUsICRpb25pY0JvZHksICRjb21waWxlLCAkdGltZW91dCwgJGlvbmljUGxhdGZvcm0sICRpb25pY1RlbXBsYXRlTG9hZGVyLCAkcSwgJGxvZykgewoKICAvKioKICAgKiBAbmdkb2MgY29udHJvbGxlcgogICAqIEBuYW1lIGlvbmljTW9kYWwKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogSW5zdGFudGlhdGVkIGJ5IHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNNb2RhbH0gc2VydmljZS4KICAgKgogICAqIEJlIHN1cmUgdG8gY2FsbCBbcmVtb3ZlKCldKCNyZW1vdmUpIHdoZW4geW91IGFyZSBkb25lIHdpdGggZWFjaCBtb2RhbAogICAqIHRvIGNsZWFuIGl0IHVwIGFuZCBhdm9pZCBtZW1vcnkgbGVha3MuCiAgICoKICAgKiBOb3RlOiBhIG1vZGFsIHdpbGwgYnJvYWRjYXN0ICdtb2RhbC5zaG93bicsICdtb2RhbC5oaWRkZW4nLCBhbmQgJ21vZGFsLnJlbW92ZWQnIGV2ZW50cyBmcm9tIGl0cyBvcmlnaW5hdGluZwogICAqIHNjb3BlLCBwYXNzaW5nIGluIGl0c2VsZiBhcyBhbiBldmVudCBhcmd1bWVudC4gTm90ZTogYm90aCBtb2RhbC5yZW1vdmVkIGFuZCBtb2RhbC5oaWRkZW4gYXJlCiAgICogY2FsbGVkIHdoZW4gdGhlIG1vZGFsIGlzIHJlbW92ZWQuCiAgICovCiAgdmFyIE1vZGFsVmlldyA9IGlvbmljLnZpZXdzLk1vZGFsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pY01vZGFsI2luaXRpYWxpemUKICAgICAqIEBkZXNjcmlwdGlvbiBDcmVhdGVzIGEgbmV3IG1vZGFsIGNvbnRyb2xsZXIgaW5zdGFuY2UuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBBbiBvcHRpb25zIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAqICAtIGB7b2JqZWN0PX1gIGBzY29wZWAgVGhlIHNjb3BlIHRvIGJlIGEgY2hpbGQgb2YuCiAgICAgKiAgICBEZWZhdWx0OiBjcmVhdGVzIGEgY2hpbGQgb2YgJHJvb3RTY29wZS4KICAgICAqICAtIGB7c3RyaW5nPX1gIGBhbmltYXRpb25gIFRoZSBhbmltYXRpb24gdG8gc2hvdyAmIGhpZGUgd2l0aC4KICAgICAqICAgIERlZmF1bHQ6ICdzbGlkZS1pbi11cCcKICAgICAqICAtIGB7Ym9vbGVhbj19YCBgZm9jdXNGaXJzdElucHV0YCBXaGV0aGVyIHRvIGF1dG9mb2N1cyB0aGUgZmlyc3QgaW5wdXQgb2YKICAgICAqICAgIHRoZSBtb2RhbCB3aGVuIHNob3duLiAgRGVmYXVsdDogZmFsc2UuCiAgICAgKiAgLSBge2Jvb2xlYW49fWAgYGJhY2tkcm9wQ2xpY2tUb0Nsb3NlYCBXaGV0aGVyIHRvIGNsb3NlIHRoZSBtb2RhbCBvbiBjbGlja2luZyB0aGUgYmFja2Ryb3AuCiAgICAgKiAgICBEZWZhdWx0OiB0cnVlLgogICAgICogIC0gYHtib29sZWFuPX1gIGBoYXJkd2FyZUJhY2tCdXR0b25DbG9zZWAgV2hldGhlciB0aGUgbW9kYWwgY2FuIGJlIGNsb3NlZCB1c2luZyB0aGUgaGFyZHdhcmUKICAgICAqICAgIGJhY2sgYnV0dG9uIG9uIEFuZHJvaWQgYW5kIHNpbWlsYXIgZGV2aWNlcy4gIERlZmF1bHQ6IHRydWUuCiAgICAgKi8KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgaW9uaWMudmlld3MuTW9kYWwucHJvdG90eXBlLmluaXRpYWxpemUuY2FsbCh0aGlzLCBvcHRzKTsKICAgICAgdGhpcy5hbmltYXRpb24gPSBvcHRzLmFuaW1hdGlvbiB8fCAnc2xpZGUtaW4tdXAnOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljTW9kYWwjc2hvdwogICAgICogQGRlc2NyaXB0aW9uIFNob3cgdGhpcyBtb2RhbCBpbnN0YW5jZS4KICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgbW9kYWwgaXMgZmluaXNoZWQgYW5pbWF0aW5nIGluLgogICAgICovCiAgICBzaG93OiBmdW5jdGlvbih0YXJnZXQpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgaWYoc2VsZi5zY29wZS4kJGRlc3Ryb3llZCkgewogICAgICAgICRsb2cuZXJyb3IoJ0Nhbm5vdCBjYWxsICcgKyAgc2VsZi52aWV3VHlwZSArICcuc2hvdygpIGFmdGVyIHJlbW92ZSgpLiBQbGVhc2UgY3JlYXRlIGEgbmV3ICcgKyAgc2VsZi52aWV3VHlwZSArICcgaW5zdGFuY2UuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbW9kYWxFbCA9IGpxTGl0ZShzZWxmLm1vZGFsRWwpOwoKICAgICAgc2VsZi5lbC5jbGFzc0xpc3QucmVtb3ZlKCdoaWRlJyk7CiAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgJGlvbmljQm9keS5hZGRDbGFzcyhzZWxmLnZpZXdUeXBlICsgJy1vcGVuJyk7CiAgICAgIH0sIDQwMCk7CgogICAgICBpZighc2VsZi5lbC5wYXJlbnRFbGVtZW50KSB7CiAgICAgICAgbW9kYWxFbC5hZGRDbGFzcyhzZWxmLmFuaW1hdGlvbik7CiAgICAgICAgJGlvbmljQm9keS5hcHBlbmQoc2VsZi5lbCk7CiAgICAgIH0KCiAgICAgIGlmKHRhcmdldCAmJiBzZWxmLnBvc2l0aW9uVmlldykgewogICAgICAgIHNlbGYucG9zaXRpb25WaWV3KHRhcmdldCwgbW9kYWxFbCk7CiAgICAgIH0KCiAgICAgIG1vZGFsRWwuYWRkQ2xhc3MoJ25nLWVudGVyIGFjdGl2ZScpCiAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ25nLWxlYXZlIG5nLWxlYXZlLWFjdGl2ZScpOwoKICAgICAgc2VsZi5faXNTaG93biA9IHRydWU7CiAgICAgIHNlbGYuX2RlcmVnaXN0ZXJCYWNrQnV0dG9uID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgIHNlbGYuaGFyZHdhcmVCYWNrQnV0dG9uQ2xvc2UgPyBhbmd1bGFyLmJpbmQoc2VsZiwgc2VsZi5oaWRlKSA6IGFuZ3VsYXIubm9vcCwKICAgICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9NT0RBTAogICAgICApOwoKICAgICAgc2VsZi5faXNPcGVuUHJvbWlzZSA9ICRxLmRlZmVyKCk7CgogICAgICBpb25pYy52aWV3cy5Nb2RhbC5wcm90b3R5cGUuc2hvdy5jYWxsKHNlbGYpOwoKICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICBtb2RhbEVsLmFkZENsYXNzKCduZy1lbnRlci1hY3RpdmUnKTsKICAgICAgICBpb25pYy50cmlnZ2VyKCdyZXNpemUnKTsKICAgICAgICBzZWxmLnNjb3BlLiRwYXJlbnQgJiYgc2VsZi5zY29wZS4kcGFyZW50LiRicm9hZGNhc3Qoc2VsZi52aWV3VHlwZSArICcuc2hvd24nLCBzZWxmKTsKICAgICAgICBzZWxmLmVsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICB9LCAyMCk7CgogICAgICByZXR1cm4gJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgLy9BZnRlciBhbmltYXRpbmcgaW4sIGFsbG93IGhpZGUgb24gYmFja2Ryb3AgY2xpY2sKICAgICAgICBzZWxmLiRlbC5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICBpZiAoc2VsZi5iYWNrZHJvcENsaWNrVG9DbG9zZSAmJiBlLnRhcmdldCA9PT0gc2VsZi5lbCkgewogICAgICAgICAgICBzZWxmLmhpZGUoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgNDAwKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pY01vZGFsI2hpZGUKICAgICAqIEBkZXNjcmlwdGlvbiBIaWRlIHRoaXMgbW9kYWwgaW5zdGFuY2UuCiAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIG1vZGFsIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBvdXQuCiAgICAgKi8KICAgIGhpZGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBtb2RhbEVsID0ganFMaXRlKHNlbGYubW9kYWxFbCk7CgogICAgICBzZWxmLmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICBtb2RhbEVsLmFkZENsYXNzKCduZy1sZWF2ZScpOwoKICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICBtb2RhbEVsLmFkZENsYXNzKCduZy1sZWF2ZS1hY3RpdmUnKQogICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ25nLWVudGVyIG5nLWVudGVyLWFjdGl2ZSBhY3RpdmUnKTsKICAgICAgfSwgMjApOwoKICAgICAgc2VsZi4kZWwub2ZmKCdjbGljaycpOwogICAgICBzZWxmLl9pc1Nob3duID0gZmFsc2U7CiAgICAgIHNlbGYuc2NvcGUuJHBhcmVudCAmJiBzZWxmLnNjb3BlLiRwYXJlbnQuJGJyb2FkY2FzdChzZWxmLnZpZXdUeXBlICsgJy5oaWRkZW4nLCBzZWxmKTsKICAgICAgc2VsZi5fZGVyZWdpc3RlckJhY2tCdXR0b24gJiYgc2VsZi5fZGVyZWdpc3RlckJhY2tCdXR0b24oKTsKCiAgICAgIGlvbmljLnZpZXdzLk1vZGFsLnByb3RvdHlwZS5oaWRlLmNhbGwoc2VsZik7CgogICAgICByZXR1cm4gJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAkaW9uaWNCb2R5LnJlbW92ZUNsYXNzKHNlbGYudmlld1R5cGUgKyAnLW9wZW4nKTsKICAgICAgICBzZWxmLmVsLmNsYXNzTGlzdC5hZGQoJ2hpZGUnKTsKICAgICAgfSwgc2VsZi5oaWRlRGVsYXkgfHwgMzIwKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pY01vZGFsI3JlbW92ZQogICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZSB0aGlzIG1vZGFsIGluc3RhbmNlIGZyb20gdGhlIERPTSBhbmQgY2xlYW4gdXAuCiAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIG1vZGFsIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBvdXQuCiAgICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5zY29wZS4kcGFyZW50ICYmIHNlbGYuc2NvcGUuJHBhcmVudC4kYnJvYWRjYXN0KHNlbGYudmlld1R5cGUgKyAnLnJlbW92ZWQnLCBzZWxmKTsKCiAgICAgIHJldHVybiBzZWxmLmhpZGUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICBzZWxmLiRlbC5yZW1vdmUoKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWNNb2RhbCNpc1Nob3duCiAgICAgKiBAcmV0dXJucyBib29sZWFuIFdoZXRoZXIgdGhpcyBtb2RhbCBpcyBjdXJyZW50bHkgc2hvd24uCiAgICAgKi8KICAgIGlzU2hvd246IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gISF0aGlzLl9pc1Nob3duOwogICAgfQogIH0pOwoKICB2YXIgY3JlYXRlTW9kYWwgPSBmdW5jdGlvbih0ZW1wbGF0ZVN0cmluZywgb3B0aW9ucykgewogICAgLy8gQ3JlYXRlIGEgbmV3IHNjb3BlIGZvciB0aGUgbW9kYWwKICAgIHZhciBzY29wZSA9IG9wdGlvbnMuc2NvcGUgJiYgb3B0aW9ucy5zY29wZS4kbmV3KCkgfHwgJHJvb3RTY29wZS4kbmV3KHRydWUpOwoKICAgIG9wdGlvbnMudmlld1R5cGUgPSBvcHRpb25zLnZpZXdUeXBlIHx8ICdtb2RhbCc7CgogICAgZXh0ZW5kKHNjb3BlLCB7CiAgICAgICRoYXNIZWFkZXI6IGZhbHNlLAogICAgICAkaGFzU3ViaGVhZGVyOiBmYWxzZSwKICAgICAgJGhhc0Zvb3RlcjogZmFsc2UsCiAgICAgICRoYXNTdWJmb290ZXI6IGZhbHNlLAogICAgICAkaGFzVGFiczogZmFsc2UsCiAgICAgICRoYXNUYWJzVG9wOiBmYWxzZQogICAgfSk7CgogICAgLy8gQ29tcGlsZSB0aGUgdGVtcGxhdGUKICAgIHZhciBlbGVtZW50ID0gJGNvbXBpbGUoJzxpb24tJyArIG9wdGlvbnMudmlld1R5cGUgKyAnPicgKyB0ZW1wbGF0ZVN0cmluZyArICc8L2lvbi0nICsgb3B0aW9ucy52aWV3VHlwZSArICc+Jykoc2NvcGUpOwoKICAgIG9wdGlvbnMuJGVsID0gZWxlbWVudDsKICAgIG9wdGlvbnMuZWwgPSBlbGVtZW50WzBdOwogICAgb3B0aW9ucy5tb2RhbEVsID0gb3B0aW9ucy5lbC5xdWVyeVNlbGVjdG9yKCcuJyArIG9wdGlvbnMudmlld1R5cGUpOwogICAgdmFyIG1vZGFsID0gbmV3IE1vZGFsVmlldyhvcHRpb25zKTsKCiAgICBtb2RhbC5zY29wZSA9IHNjb3BlOwoKICAgIC8vIElmIHRoaXMgd2Fzbid0IGEgZGVmaW5lZCBzY29wZSwgd2UgY2FuIGFzc2lnbiB0aGUgdmlld1R5cGUgdG8gdGhlIGlzb2xhdGVkIHNjb3BlCiAgICAvLyB3ZSBjcmVhdGVkCiAgICBpZighb3B0aW9ucy5zY29wZSkgewogICAgICBzY29wZVsgb3B0aW9ucy52aWV3VHlwZSBdID0gbW9kYWw7CiAgICB9CgogICAgcmV0dXJuIG1vZGFsOwogIH07CgogIHJldHVybiB7CiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY01vZGFsI2Zyb21UZW1wbGF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlU3RyaW5nIFRoZSB0ZW1wbGF0ZSBzdHJpbmcgdG8gdXNlIGFzIHRoZSBtb2RhbCdzCiAgICAgKiBjb250ZW50LgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0byBiZSBwYXNzZWQge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNNb2RhbCNpbml0aWFsaXplIGlvbmljTW9kYWwjaW5pdGlhbGl6ZX0gbWV0aG9kLgogICAgICogQHJldHVybnMge29iamVjdH0gQW4gaW5zdGFuY2Ugb2YgYW4ge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNNb2RhbH0KICAgICAqIGNvbnRyb2xsZXIuCiAgICAgKi8KICAgIGZyb21UZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVTdHJpbmcsIG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGFsID0gY3JlYXRlTW9kYWwodGVtcGxhdGVTdHJpbmcsIG9wdGlvbnMgfHwge30pOwogICAgICByZXR1cm4gbW9kYWw7CiAgICB9LAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNNb2RhbCNmcm9tVGVtcGxhdGVVcmwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZW1wbGF0ZVVybCBUaGUgdXJsIHRvIGxvYWQgdGhlIHRlbXBsYXRlIGZyb20uCiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBPcHRpb25zIHRvIGJlIHBhc3NlZCB7QGxpbmsgaW9uaWMuY29udHJvbGxlcjppb25pY01vZGFsI2luaXRpYWxpemUgaW9uaWNNb2RhbCNpbml0aWFsaXplfSBtZXRob2QuCiAgICAgKiBvcHRpb25zIG9iamVjdC4KICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gaW5zdGFuY2Ugb2YKICAgICAqIGFuIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljTW9kYWx9IGNvbnRyb2xsZXIuCiAgICAgKi8KICAgIGZyb21UZW1wbGF0ZVVybDogZnVuY3Rpb24odXJsLCBvcHRpb25zLCBfKSB7CiAgICAgIHZhciBjYjsKICAgICAgLy9EZXByZWNhdGVkOiBhbGxvdyBhIGNhbGxiYWNrIGFzIHNlY29uZCBwYXJhbWV0ZXIuIE5vdyB3ZSByZXR1cm4gYSBwcm9taXNlLgogICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKG9wdGlvbnMpKSB7CiAgICAgICAgY2IgPSBvcHRpb25zOwogICAgICAgIG9wdGlvbnMgPSBfOwogICAgICB9CiAgICAgIHJldHVybiAkaW9uaWNUZW1wbGF0ZUxvYWRlci5sb2FkKHVybCkudGhlbihmdW5jdGlvbih0ZW1wbGF0ZVN0cmluZykgewogICAgICAgIHZhciBtb2RhbCA9IGNyZWF0ZU1vZGFsKHRlbXBsYXRlU3RyaW5nLCBvcHRpb25zIHx8IHt9KTsKICAgICAgICBjYiAmJiBjYihtb2RhbCk7CiAgICAgICAgcmV0dXJuIG1vZGFsOwogICAgICB9KTsKICAgIH0KICB9Owp9XSk7CgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9IGRpcmVjdGl2ZS4KICoKICogQHVzYWdlCiAqCiAqIGBgYGh0bWwKICogPGJvZHkgbmctY29udHJvbGxlcj0iTXlDdHJsIj4KICogICA8aW9uLW5hdi1iYXI+CiAqICAgICA8YnV0dG9uIG5nLWNsaWNrPSJzZXROYXZUaXRsZSgnYmFuYW5hJykiPgogKiAgICAgICBTZXQgdGl0bGUgdG8gYmFuYW5hIQogKiAgICAgPC9idXR0b24+CiAqICAgPC9pb24tbmF2LWJhcj4KICogPC9ib2R5PgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljTmF2QmFyRGVsZWdhdGUpIHsKICogICAkc2NvcGUuc2V0TmF2VGl0bGUgPSBmdW5jdGlvbih0aXRsZSkgewogKiAgICAgJGlvbmljTmF2QmFyRGVsZWdhdGUuc2V0VGl0bGUodGl0bGUpOwogKiAgIH0KICogfQogKiBgYGAKICovCklvbmljTW9kdWxlCi5zZXJ2aWNlKCckaW9uaWNOYXZCYXJEZWxlZ2F0ZScsIGRlbGVnYXRlU2VydmljZShbCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI2JhY2sKICAgKiBAZGVzY3JpcHRpb24gR29lcyBiYWNrIGluIHRoZSB2aWV3IGhpc3RvcnkuCiAgICogQHBhcmFtIHtET01FdmVudD19IGV2ZW50IFRoZSBldmVudCBvYmplY3QgKGVnIGZyb20gYSB0YXAgZXZlbnQpCiAgICovCiAgJ2JhY2snLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNhbGlnbgogICAqIEBkZXNjcmlwdGlvbiBBbGlnbnMgdGhlIHRpdGxlIHdpdGggdGhlIGJ1dHRvbnMgaW4gYSBnaXZlbiBkaXJlY3Rpb24uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0byB0aGUgYWxpZ24gdGhlIHRpdGxlIHRleHQgdG93YXJkcy4KICAgKiBBdmFpbGFibGU6ICdsZWZ0JywgJ3JpZ2h0JywgJ2NlbnRlcicuIERlZmF1bHQ6ICdjZW50ZXInLgogICAqLwogICdhbGlnbicsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI3Nob3dCYWNrQnV0dG9uCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0L2dldCB3aGV0aGVyIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhY2tCdXR0b259IGlzIHNob3duCiAgICogKGlmIGl0IGV4aXN0cykuCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdyBXaGV0aGVyIHRvIHNob3cgdGhlIGJhY2sgYnV0dG9uLgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBiYWNrIGJ1dHRvbiBpcyBzaG93bi4KICAgKi8KICAnc2hvd0JhY2tCdXR0b24nLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNzaG93QmFyCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0L2dldCB3aGV0aGVyIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gaXMgc2hvd24uCiAgICogQHBhcmFtIHtib29sZWFufSBzaG93IFdoZXRoZXIgdG8gc2hvdyB0aGUgYmFyLgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBiYXIgaXMgc2hvd24uCiAgICovCiAgJ3Nob3dCYXInLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNzZXRUaXRsZQogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldCB0aGUgdGl0bGUgZm9yIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0uCiAgICogQHBhcmFtIHtzdHJpbmd9IHRpdGxlIFRoZSBuZXcgdGl0bGUgdG8gc2hvdy4KICAgKi8KICAnc2V0VGl0bGUnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNjaGFuZ2VUaXRsZQogICAqIEBkZXNjcmlwdGlvbgogICAqIENoYW5nZSB0aGUgdGl0bGUsIHRyYW5zaXRpb25pbmcgdGhlIG5ldyB0aXRsZSBpbiBhbmQgdGhlIG9sZCBvbmUgb3V0IGluIGEgZ2l2ZW4gZGlyZWN0aW9uLgogICAqIEBwYXJhbSB7c3RyaW5nfSB0aXRsZSBUaGUgbmV3IHRpdGxlIHRvIHNob3cuCiAgICogQHBhcmFtIHtzdHJpbmd9IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIHRvIHRyYW5zaXRpb24gdGhlIG5ldyB0aXRsZSBpbi4KICAgKiBBdmFpbGFibGU6ICdmb3J3YXJkJywgJ2JhY2snLgogICAqLwogICdjaGFuZ2VUaXRsZScsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI2dldFRpdGxlCiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGN1cnJlbnQgdGl0bGUgb2YgdGhlIG5hdmJhci4KICAgKi8KICAnZ2V0VGl0bGUnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNnZXRQcmV2aW91c1RpdGxlCiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIHByZXZpb3VzIHRpdGxlIG9mIHRoZSBuYXZiYXIuCiAgICovCiAgJ2dldFByZXZpb3VzVGl0bGUnCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAqIEBwYXJhbSB7c3RyaW5nfSBoYW5kbGUKICAgKiBAcmV0dXJucyBgZGVsZWdhdGVJbnN0YW5jZWAgQSBkZWxlZ2F0ZSBpbnN0YW5jZSB0aGF0IGNvbnRyb2xzIG9ubHkgdGhlCiAgICogbmF2QmFycyB3aXRoIGRlbGVnYXRlLWhhbmRsZSBtYXRjaGluZyB0aGUgZ2l2ZW4gaGFuZGxlLgogICAqCiAgICogRXhhbXBsZTogYCRpb25pY05hdkJhckRlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXlIYW5kbGUnKS5zZXRUaXRsZSgnbmV3VGl0bGUnKWAKICAgKi8KXSkpOwoKdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1ZJRVcgPSAxMDA7CnZhciBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9TSURFX01FTlUgPSAxNTA7CnZhciBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9NT0RBTCA9IDIwMDsKdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX0FDVElPTl9TSEVFVCA9IDMwMDsKdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1BPUFVQID0gNDAwOwp2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfTE9BRElORyA9IDUwMDsKCmZ1bmN0aW9uIGNvbXBvbmVudENvbmZpZyhkZWZhdWx0cykgewogIGRlZmF1bHRzLiRnZXQgPSBmdW5jdGlvbigpIHsgcmV0dXJuIGRlZmF1bHRzOyB9OwogIHJldHVybiBkZWZhdWx0czsKfQoKSW9uaWNNb2R1bGUKLmNvbnN0YW50KCckaW9uaWNQbGF0Zm9ybURlZmF1bHRzJywgewogICdpb3MnOiB7CiAgICAnJGlvbmljTmF2QmFyQ29uZmlnJzogewogICAgICB0cmFuc2l0aW9uOiAnbmF2LXRpdGxlLXNsaWRlLWlvcycsLy9uYXYtdGl0bGUtc2xpZGUtaW9zNycsCiAgICAgIGFsaWduVGl0bGU6ICdjZW50ZXInLAogICAgICBiYWNrQnV0dG9uSWNvbjogJ2lvbi1pb3M3LWFycm93LWJhY2snCiAgICB9LAogICAgJyRpb25pY05hdlZpZXdDb25maWcnOiB7CiAgICAgIC8vdHJhbnNpdGlvbjogJ3NsaWRlLWxlZnQtcmlnaHQtaW9zJwogICAgICB0cmFuc2l0aW9uOiAnc2xpZGUtaW9zJwogICAgfSwKICAgICckaW9uaWNUYWJzQ29uZmlnJzogewogICAgICB0eXBlOiAnJywKICAgICAgcG9zaXRpb246ICcnCiAgICB9CiAgfSwKICAnYW5kcm9pZCc6IHsKICAgICckaW9uaWNOYXZCYXJDb25maWcnOiB7CiAgICAgIHRyYW5zaXRpb246ICduYXYtdGl0bGUtc2xpZGUtZnVsbCcsCiAgICAgIGFsaWduVGl0bGU6ICdjZW50ZXInLAogICAgICBiYWNrQnV0dG9uSWNvbjogJ2lvbi1pb3M3LWFycm93LWJhY2snCiAgICB9LAogICAgJyRpb25pY05hdlZpZXdDb25maWcnOiB7CiAgICAgIHRyYW5zaXRpb246ICdzbGlkZS1mdWxsJwogICAgfSwKICAgICckaW9uaWNUYWJzQ29uZmlnJzogewogICAgICB0eXBlOiAndGFicy1zdHJpcGVkJywKICAgICAgcG9zaXRpb246ICcnCiAgICB9CiAgfQp9KTsKCgpJb25pY01vZHVsZS5jb25maWcoWwogICckaW9uaWNQbGF0Zm9ybURlZmF1bHRzJywKCiAgJyRpbmplY3RvcicsCgpmdW5jdGlvbigkaW9uaWNQbGF0Zm9ybURlZmF1bHRzLCAkaW5qZWN0b3IpIHsKICB2YXIgcGxhdGZvcm0gPSBpb25pYy5QbGF0Zm9ybS5wbGF0Zm9ybSgpOwoKICB2YXIgYXBwbHlDb25maWcgPSBmdW5jdGlvbihwbGF0Zm9ybURlZmF1bHRzKSB7CiAgICBmb3JFYWNoKHBsYXRmb3JtRGVmYXVsdHMsIGZ1bmN0aW9uKGRlZmF1bHRzLCBjb25zdGFudE5hbWUpIHsKICAgICAgZXh0ZW5kKCRpbmplY3Rvci5nZXQoY29uc3RhbnROYW1lKSwgZGVmYXVsdHMpOwogICAgfSk7CiAgfTsKCiAgc3dpdGNoKHBsYXRmb3JtKSB7CiAgICBjYXNlICdpb3MnOgogICAgICBhcHBseUNvbmZpZygkaW9uaWNQbGF0Zm9ybURlZmF1bHRzLmlvcyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnYW5kcm9pZCc6CiAgICAgIGFwcGx5Q29uZmlnKCRpb25pY1BsYXRmb3JtRGVmYXVsdHMuYW5kcm9pZCk7CiAgICAgIGJyZWFrOwogIH0KfV0pOwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY1BsYXRmb3JtCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqIEFuIGFuZ3VsYXIgYWJzdHJhY3Rpb24gb2Yge0BsaW5rIGlvbmljLnV0aWxpdHk6aW9uaWMuUGxhdGZvcm19LgogKgogKiBVc2VkIHRvIGRldGVjdCB0aGUgY3VycmVudCBwbGF0Zm9ybSwgYXMgd2VsbCBhcyBkbyB0aGluZ3MgbGlrZSBvdmVycmlkZSB0aGUKICogQW5kcm9pZCBiYWNrIGJ1dHRvbiBpbiBQaG9uZUdhcC9Db3Jkb3ZhLgogKi8KSW9uaWNNb2R1bGUKLnByb3ZpZGVyKCckaW9uaWNQbGF0Zm9ybScsIGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICAkZ2V0OiBbJyRxJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbigkcSwgJHJvb3RTY29wZSkgewogICAgICB2YXIgc2VsZiA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRpb25pY1BsYXRmb3JtI29uSGFyZHdhcmVCYWNrQnV0dG9uCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU29tZSBwbGF0Zm9ybXMgaGF2ZSBhIGhhcmR3YXJlIGJhY2sgYnV0dG9uLCBzbyB0aGlzIGlzIG9uZSB3YXkgdG8KICAgICAgICAgKiBiaW5kIHRvIGl0LgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIHRoZSBjYWxsYmFjayB0byB0cmlnZ2VyIHdoZW4gdGhpcyBldmVudCBvY2N1cnMKICAgICAgICAgKi8KICAgICAgICBvbkhhcmR3YXJlQmFja0J1dHRvbjogZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIGlvbmljLlBsYXRmb3JtLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdiYWNrYnV0dG9uJywgY2IsIGZhbHNlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaW9uaWNQbGF0Zm9ybSNvZmZIYXJkd2FyZUJhY2tCdXR0b24KICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIHRoZSBiYWNrYnV0dG9uLgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBsaXN0ZW5lciBmdW5jdGlvbiB0aGF0IHdhcwogICAgICAgICAqIG9yaWdpbmFsbHkgYm91bmQuCiAgICAgICAgICovCiAgICAgICAgb2ZmSGFyZHdhcmVCYWNrQnV0dG9uOiBmdW5jdGlvbihmbikgewogICAgICAgICAgaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2JhY2tidXR0b24nLCBmbik7CiAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGlvbmljUGxhdGZvcm0jcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmVnaXN0ZXIgYSBoYXJkd2FyZSBiYWNrIGJ1dHRvbiBhY3Rpb24uIE9ubHkgb25lIGFjdGlvbiB3aWxsIGV4ZWN1dGUKICAgICAgICAgKiB3aGVuIHRoZSBiYWNrIGJ1dHRvbiBpcyBjbGlja2VkLCBzbyB0aGlzIG1ldGhvZCBkZWNpZGVzIHdoaWNoIG9mCiAgICAgICAgICogdGhlIHJlZ2lzdGVyZWQgYmFjayBidXR0b24gYWN0aW9ucyBoYXMgdGhlIGhpZ2hlc3QgcHJpb3JpdHkuCiAgICAgICAgICoKICAgICAgICAgKiBGb3IgZXhhbXBsZSwgaWYgYW4gYWN0aW9uc2hlZXQgaXMgc2hvd2luZywgdGhlIGJhY2sgYnV0dG9uIHNob3VsZAogICAgICAgICAqIGNsb3NlIHRoZSBhY3Rpb25zaGVldCwgYnV0IGl0IHNob3VsZCBub3QgYWxzbyBnbyBiYWNrIGEgcGFnZSB2aWV3CiAgICAgICAgICogb3IgY2xvc2UgYSBtb2RhbCB3aGljaCBtYXkgYmUgb3Blbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCB3aGVuIHRoZSBiYWNrIGJ1dHRvbiBpcyBwcmVzc2VkLAogICAgICAgICAqIGlmIHRoaXMgbGlzdGVuZXIgaXMgdGhlIGhpZ2hlc3QgcHJpb3JpdHkuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IHByaW9yaXR5IE9ubHkgdGhlIGhpZ2hlc3QgcHJpb3JpdHkgd2lsbCBleGVjdXRlLgogICAgICAgICAqIEBwYXJhbSB7Kj19IGFjdGlvbklkIFRoZSBpZCB0byBhc3NpZ24gdGhpcyBhY3Rpb24uIERlZmF1bHQ6IGEKICAgICAgICAgKiByYW5kb20gdW5pcXVlIGlkLgogICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbn0gQSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgd2lsbCBkZXJlZ2lzdGVyCiAgICAgICAgICogdGhpcyBiYWNrQnV0dG9uQWN0aW9uLgogICAgICAgICAqLwogICAgICAgICRiYWNrQnV0dG9uQWN0aW9uczoge30sCiAgICAgICAgcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uOiBmdW5jdGlvbihmbiwgcHJpb3JpdHksIGFjdGlvbklkKSB7CgogICAgICAgICAgaWYoIXNlbGYuX2hhc0JhY2tCdXR0b25IYW5kbGVyKSB7CiAgICAgICAgICAgIC8vIGFkZCBhIGJhY2sgYnV0dG9uIGxpc3RlbmVyIGlmIG9uZSBoYXNuJ3QgYmVlbiBzZXR1cCB5ZXQKICAgICAgICAgICAgc2VsZi4kYmFja0J1dHRvbkFjdGlvbnMgPSB7fTsKICAgICAgICAgICAgc2VsZi5vbkhhcmR3YXJlQmFja0J1dHRvbihzZWxmLmhhcmR3YXJlQmFja0J1dHRvbkNsaWNrKTsKICAgICAgICAgICAgc2VsZi5faGFzQmFja0J1dHRvbkhhbmRsZXIgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBhY3Rpb24gPSB7CiAgICAgICAgICAgIGlkOiAoYWN0aW9uSWQgPyBhY3Rpb25JZCA6IGlvbmljLlV0aWxzLm5leHRVaWQoKSksCiAgICAgICAgICAgIHByaW9yaXR5OiAocHJpb3JpdHkgPyBwcmlvcml0eSA6IDApLAogICAgICAgICAgICBmbjogZm4KICAgICAgICAgIH07CiAgICAgICAgICBzZWxmLiRiYWNrQnV0dG9uQWN0aW9uc1thY3Rpb24uaWRdID0gYWN0aW9uOwoKICAgICAgICAgIC8vIHJldHVybiBhIGZ1bmN0aW9uIHRvIGRlLXJlZ2lzdGVyIHRoaXMgYmFjayBidXR0b24gYWN0aW9uCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzZWxmLiRiYWNrQnV0dG9uQWN0aW9uc1thY3Rpb24uaWRdOwogICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIGhhcmR3YXJlQmFja0J1dHRvbkNsaWNrOiBmdW5jdGlvbihlKXsKICAgICAgICAgIC8vIGxvb3AgdGhyb3VnaCBhbGwgdGhlIHJlZ2lzdGVyZWQgYmFjayBidXR0b24gYWN0aW9ucwogICAgICAgICAgLy8gYW5kIG9ubHkgcnVuIHRoZSBsYXN0IG9uZSBvZiB0aGUgaGlnaGVzdCBwcmlvcml0eQogICAgICAgICAgdmFyIHByaW9yaXR5QWN0aW9uLCBhY3Rpb25JZDsKICAgICAgICAgIGZvcihhY3Rpb25JZCBpbiBzZWxmLiRiYWNrQnV0dG9uQWN0aW9ucykgewogICAgICAgICAgICBpZighcHJpb3JpdHlBY3Rpb24gfHwgc2VsZi4kYmFja0J1dHRvbkFjdGlvbnNbYWN0aW9uSWRdLnByaW9yaXR5ID49IHByaW9yaXR5QWN0aW9uLnByaW9yaXR5KSB7CiAgICAgICAgICAgICAgcHJpb3JpdHlBY3Rpb24gPSBzZWxmLiRiYWNrQnV0dG9uQWN0aW9uc1thY3Rpb25JZF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmKHByaW9yaXR5QWN0aW9uKSB7CiAgICAgICAgICAgIHByaW9yaXR5QWN0aW9uLmZuKGUpOwogICAgICAgICAgICByZXR1cm4gcHJpb3JpdHlBY3Rpb247CiAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgaXM6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICAgIHJldHVybiBpb25pYy5QbGF0Zm9ybS5pcyh0eXBlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGlvbmljUGxhdGZvcm0jcmVhZHkKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUcmlnZ2VyIGEgY2FsbGJhY2sgb25jZSB0aGUgZGV2aWNlIGlzIHJlYWR5LAogICAgICAgICAqIG9yIGltbWVkaWF0ZWx5IGlmIHRoZSBkZXZpY2UgaXMgYWxyZWFkeSByZWFkeS4KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uPX0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBkZXZpY2UgaXMgcmVhZHkuCiAgICAgICAgICovCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgICB2YXIgcSA9ICRxLmRlZmVyKCk7CgogICAgICAgICAgaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKXsKICAgICAgICAgICAgcS5yZXNvbHZlKCk7CiAgICAgICAgICAgIGNiICYmIGNiKCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICByZXR1cm4gcS5wcm9taXNlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9XQogIH07Cgp9KTsKCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljUG9wb3ZlcgogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWxhdGVkOiB7QGxpbmsgaW9uaWMuY29udHJvbGxlcjppb25pY1BvcG92ZXIgaW9uaWNQb3BvdmVyIGNvbnRyb2xsZXJ9LgogKgogKiBUaGUgUG9wb3ZlciBpcyBhIHZpZXcgdGhhdCBmbG9hdHMgYWJvdmUgYW4gYXBw4oCZcyBjb250ZW50LiBQb3BvdmVycyBwcm92aWRlIGFuCiAqIGVhc3kgd2F5IHRvIHByZXNlbnQgb3IgZ2F0aGVyIGluZm9ybWF0aW9uIGZyb20gdGhlIHVzZXIgYW5kIGFyZQogKiBjb21tb25seSB1c2VkIGluIHRoZSBmb2xsb3dpbmcgc2l0dWF0aW9uczoKICoKICogLSBTaG93IG1vcmUgaW5mbyBhYm91dCB0aGUgY3VycmVudCB2aWV3CiAqIC0gU2VsZWN0IGEgY29tbW9ubHkgdXNlZCB0b29sIG9yIGNvbmZpZ3VyYXRpb24KICogLSBQcmVzZW50IGEgbGlzdCBvZiBhY3Rpb25zIHRvIHBlcmZvcm0gaW5zaWRlIG9uZSBvZiB5b3VyIHZpZXdzCiAqCiAqIFB1dCB0aGUgY29udGVudCBvZiB0aGUgcG9wb3ZlciBpbnNpZGUgb2YgYW4gYDxpb24tcG9wb3Zlci12aWV3PmAgZWxlbWVudC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPHA+CiAqICAgPGJ1dHRvbiBuZy1jbGljaz0ib3BlblBvcG92ZXIoJGV2ZW50KSI+T3BlbiBQb3BvdmVyPC9idXR0b24+CiAqIDwvcD4KICoKICogPHNjcmlwdCBpZD0ibXktcG9wb3Zlci5odG1sIiB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIj4KICogICA8aW9uLXBvcG92ZXItdmlldz4KICogICAgIDxpb24taGVhZGVyLWJhcj4KICogICAgICAgPGgxIGNsYXNzPSJ0aXRsZSI+TXkgUG9wb3ZlciBUaXRsZTwvaDE+CiAqICAgICA8L2lvbi1oZWFkZXItYmFyPgogKiAgICAgPGlvbi1jb250ZW50PgogKiAgICAgICBIZWxsbyEKICogICAgIDwvaW9uLWNvbnRlbnQ+CiAqICAgPC9pb24tcG9wb3Zlci12aWV3PgogKiA8L3NjcmlwdD4KICogYGBgCiAqIGBgYGpzCiAqIGFuZ3VsYXIubW9kdWxlKCd0ZXN0QXBwJywgWydpb25pYyddKQogKiAuY29udHJvbGxlcignTXlDb250cm9sbGVyJywgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNQb3BvdmVyKSB7CiAqICAgJGlvbmljUG9wb3Zlci5mcm9tVGVtcGxhdGVVcmwoJ215LXBvcG92ZXIuaHRtbCcsIHsKICogICAgIHNjb3BlOiAkc2NvcGUsCiAqICAgfSkudGhlbihmdW5jdGlvbihwb3BvdmVyKSB7CiAqICAgICAkc2NvcGUucG9wb3ZlciA9IHBvcG92ZXI7CiAqICAgfSk7CiAqICAgJHNjb3BlLm9wZW5Qb3BvdmVyID0gZnVuY3Rpb24oJGV2ZW50KSB7CiAqICAgICAkc2NvcGUucG9wb3Zlci5zaG93KCRldmVudCk7CiAqICAgfTsKICogICAkc2NvcGUuY2xvc2VQb3BvdmVyID0gZnVuY3Rpb24oKSB7CiAqICAgICAkc2NvcGUucG9wb3Zlci5oaWRlKCk7CiAqICAgfTsKICogICAvL0NsZWFudXAgdGhlIHBvcG92ZXIgd2hlbiB3ZSdyZSBkb25lIHdpdGggaXQhCiAqICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5wb3BvdmVyLnJlbW92ZSgpOwogKiAgIH0pOwogKiAgIC8vIEV4ZWN1dGUgYWN0aW9uIG9uIGhpZGUgcG9wb3ZlcgogKiAgICRzY29wZS4kb24oJ3BvcG92ZXIuaGlkZGVuJywgZnVuY3Rpb24oKSB7CiAqICAgICAvLyBFeGVjdXRlIGFjdGlvbgogKiAgIH0pOwogKiAgIC8vIEV4ZWN1dGUgYWN0aW9uIG9uIHJlbW92ZSBwb3BvdmVyCiAqICAgJHNjb3BlLiRvbigncG9wb3Zlci5yZW1vdmVkJywgZnVuY3Rpb24oKSB7CiAqICAgICAvLyBFeGVjdXRlIGFjdGlvbgogKiAgIH0pOwogKiB9KTsKICogYGBgCiAqLwoKCklvbmljTW9kdWxlCi5mYWN0b3J5KCckaW9uaWNQb3BvdmVyJywgWyckaW9uaWNNb2RhbCcsICckaW9uaWNQb3NpdGlvbicsICckZG9jdW1lbnQnLCAnJHdpbmRvdycsCmZ1bmN0aW9uKCRpb25pY01vZGFsLCAkaW9uaWNQb3NpdGlvbiwgJGRvY3VtZW50LCAkd2luZG93KSB7CgogIHZhciBQT1BPVkVSX0JPRFlfUEFERElORyA9IDY7CgogIHZhciBQT1BPVkVSX09QVElPTlMgPSB7CiAgICB2aWV3VHlwZTogJ3BvcG92ZXInLAogICAgaGlkZURlbGF5OiAxLAogICAgYW5pbWF0aW9uOiAnbm9uZScsCiAgICBwb3NpdGlvblZpZXc6IHBvc2l0aW9uVmlldwogIH07CgogIGZ1bmN0aW9uIHBvc2l0aW9uVmlldyh0YXJnZXQsIHBvcG92ZXJFbGUpIHsKICAgIHZhciB0YXJnZXRFbGUgPSBhbmd1bGFyLmVsZW1lbnQodGFyZ2V0LnRhcmdldCB8fCB0YXJnZXQpOwogICAgdmFyIGJ1dHRvbk9mZnNldCA9ICRpb25pY1Bvc2l0aW9uLm9mZnNldCggdGFyZ2V0RWxlICk7CiAgICB2YXIgcG9wb3ZlcldpZHRoID0gcG9wb3ZlckVsZS5wcm9wKCdvZmZzZXRXaWR0aCcpOwogICAgdmFyIHBvcG92ZXJIZWlnaHQgPSBwb3BvdmVyRWxlLnByb3AoJ29mZnNldEhlaWdodCcpOwogICAgdmFyIGJvZHlXaWR0aCA9ICRkb2N1bWVudFswXS5ib2R5LmNsaWVudFdpZHRoOwogICAgLy8gY2xpZW50SGVpZ2h0IGRvZXNuJ3Qgd29yayBvbiBhbGwgcGxhdGZvcm1zIGZvciBib2R5CiAgICB2YXIgYm9keUhlaWdodCA9ICR3aW5kb3cuaW5uZXJIZWlnaHQ7CgogICAgdmFyIHBvcG92ZXJDU1MgPSB7CiAgICAgIGxlZnQ6IGJ1dHRvbk9mZnNldC5sZWZ0ICsgYnV0dG9uT2Zmc2V0LndpZHRoIC8gMiAtIHBvcG92ZXJXaWR0aCAvIDIKICAgIH07CiAgICB2YXIgYXJyb3dFbGUgPSBqcUxpdGUocG9wb3ZlckVsZVswXS5xdWVyeVNlbGVjdG9yKCcucG9wb3Zlci1hcnJvdycpKTsKCiAgICBpZiAocG9wb3ZlckNTUy5sZWZ0IDwgUE9QT1ZFUl9CT0RZX1BBRERJTkcpIHsKICAgICAgcG9wb3ZlckNTUy5sZWZ0ID0gUE9QT1ZFUl9CT0RZX1BBRERJTkc7CiAgICB9IGVsc2UgaWYocG9wb3ZlckNTUy5sZWZ0ICsgcG9wb3ZlcldpZHRoICsgUE9QT1ZFUl9CT0RZX1BBRERJTkcgPiBib2R5V2lkdGgpIHsKICAgICAgcG9wb3ZlckNTUy5sZWZ0ID0gYm9keVdpZHRoIC0gcG9wb3ZlcldpZHRoIC0gUE9QT1ZFUl9CT0RZX1BBRERJTkc7CiAgICB9CgogICAgLy8gSWYgdGhlIHBvcG92ZXIgd2hlbiBwb3BwZWQgZG93biBzdHJldGNoZXMgcGFzdCBib3R0b20gb2Ygc2NyZWVuLAogICAgLy8gbWFrZSBpdCBwb3AgdXAKICAgIGlmIChidXR0b25PZmZzZXQudG9wICsgYnV0dG9uT2Zmc2V0LmhlaWdodCArIHBvcG92ZXJIZWlnaHQgPiBib2R5SGVpZ2h0KSB7CiAgICAgIHBvcG92ZXJDU1MudG9wID0gYnV0dG9uT2Zmc2V0LnRvcCAtIHBvcG92ZXJIZWlnaHQ7CiAgICAgIHBvcG92ZXJFbGUucmVtb3ZlQ2xhc3MoJ3BvcG92ZXItdG9wJykuYWRkQ2xhc3MoJ3BvcG92ZXItYm90dG9tJyk7CiAgICB9IGVsc2UgewogICAgICBwb3BvdmVyQ1NTLnRvcCA9IGJ1dHRvbk9mZnNldC50b3AgKyBidXR0b25PZmZzZXQuaGVpZ2h0OwogICAgICBwb3BvdmVyRWxlLnJlbW92ZUNsYXNzKCdwb3BvdmVyLWJvdHRvbScpLmFkZENsYXNzKCdwb3BvdmVyLXRvcCcpOwogICAgfQoKICAgIGFycm93RWxlLmNzcyh7CiAgICAgIGxlZnQ6IGJ1dHRvbk9mZnNldC5sZWZ0ICsgYnV0dG9uT2Zmc2V0LndpZHRoIC8gMiAtCiAgICAgICAgYXJyb3dFbGUucHJvcCgnb2Zmc2V0V2lkdGgnKSAvIDIgLSBwb3BvdmVyQ1NTLmxlZnQgKyAncHgnCiAgICB9KTsKCiAgICBwb3BvdmVyRWxlLmNzcyh7CiAgICAgIHRvcDogcG9wb3ZlckNTUy50b3AgKyAncHgnLAogICAgICBsZWZ0OiBwb3BvdmVyQ1NTLmxlZnQgKyAncHgnLAogICAgICBtYXJnaW5MZWZ0OiAnMCcsCiAgICAgIG9wYWNpdHk6ICcxJwogICAgfSk7CgogIH0KCiAgLyoqCiAgICogQG5nZG9jIGNvbnRyb2xsZXIKICAgKiBAbmFtZSBpb25pY1BvcG92ZXIKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogSW5zdGFudGlhdGVkIGJ5IHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNQb3BvdmVyfSBzZXJ2aWNlLgogICAqCiAgICogQmUgc3VyZSB0byBjYWxsIFtyZW1vdmUoKV0oI3JlbW92ZSkgd2hlbiB5b3UgYXJlIGRvbmUgd2l0aCBlYWNoIHBvcG92ZXIKICAgKiB0byBjbGVhbiBpdCB1cCBhbmQgYXZvaWQgbWVtb3J5IGxlYWtzLgogICAqCiAgICogTm90ZTogYSBwb3BvdmVyIHdpbGwgYnJvYWRjYXN0ICdwb3BvdmVyLnNob3duJywgJ3BvcG92ZXIuaGlkZGVuJywgYW5kICdwb3BvdmVyLnJlbW92ZWQnIGV2ZW50cyBmcm9tIGl0cyBvcmlnaW5hdGluZwogICAqIHNjb3BlLCBwYXNzaW5nIGluIGl0c2VsZiBhcyBhbiBldmVudCBhcmd1bWVudC4gQm90aCB0aGUgcG9wb3Zlci5yZW1vdmVkIGFuZCBwb3BvdmVyLmhpZGRlbiBldmVudHMgYXJlCiAgICogY2FsbGVkIHdoZW4gdGhlIHBvcG92ZXIgaXMgcmVtb3ZlZC4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGlvbmljUG9wb3ZlciNpbml0aWFsaXplCiAgICogQGRlc2NyaXB0aW9uIENyZWF0ZXMgYSBuZXcgcG9wb3ZlciBjb250cm9sbGVyIGluc3RhbmNlLgogICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIEFuIG9wdGlvbnMgb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAqICAtIGB7b2JqZWN0PX1gIGBzY29wZWAgVGhlIHNjb3BlIHRvIGJlIGEgY2hpbGQgb2YuCiAgICogICAgRGVmYXVsdDogY3JlYXRlcyBhIGNoaWxkIG9mICRyb290U2NvcGUuCiAgICogIC0gYHtib29sZWFuPX1gIGBmb2N1c0ZpcnN0SW5wdXRgIFdoZXRoZXIgdG8gYXV0b2ZvY3VzIHRoZSBmaXJzdCBpbnB1dCBvZgogICAqICAgIHRoZSBwb3BvdmVyIHdoZW4gc2hvd24uICBEZWZhdWx0OiBmYWxzZS4KICAgKiAgLSBge2Jvb2xlYW49fWAgYGJhY2tkcm9wQ2xpY2tUb0Nsb3NlYCBXaGV0aGVyIHRvIGNsb3NlIHRoZSBwb3BvdmVyIG9uIGNsaWNraW5nIHRoZSBiYWNrZHJvcC4KICAgKiAgICBEZWZhdWx0OiB0cnVlLgogICAqICAtIGB7Ym9vbGVhbj19YCBgaGFyZHdhcmVCYWNrQnV0dG9uQ2xvc2VgIFdoZXRoZXIgdGhlIHBvcG92ZXIgY2FuIGJlIGNsb3NlZCB1c2luZyB0aGUgaGFyZHdhcmUKICAgKiAgICBiYWNrIGJ1dHRvbiBvbiBBbmRyb2lkIGFuZCBzaW1pbGFyIGRldmljZXMuICBEZWZhdWx0OiB0cnVlLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgaW9uaWNQb3BvdmVyI3Nob3cKICAgKiBAZGVzY3JpcHRpb24gU2hvdyB0aGlzIHBvcG92ZXIgaW5zdGFuY2UuCiAgICogQHBhcmFtIHskZXZlbnR9ICRldmVudCBUaGUgJGV2ZW50IG9yIHRhcmdldCBlbGVtZW50IHdoaWNoIHRoZSBwb3BvdmVyIHNob3VsZCBhbGlnbgogICAqIGl0c2VsZiBuZXh0IHRvLgogICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wb3ZlciBpcyBmaW5pc2hlZCBhbmltYXRpbmcgaW4uCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBpb25pY1BvcG92ZXIjaGlkZQogICAqIEBkZXNjcmlwdGlvbiBIaWRlIHRoaXMgcG9wb3ZlciBpbnN0YW5jZS4KICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIHBvcG92ZXIgaXMgZmluaXNoZWQgYW5pbWF0aW5nIG91dC4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGlvbmljUG9wb3ZlciNyZW1vdmUKICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlIHRoaXMgcG9wb3ZlciBpbnN0YW5jZSBmcm9tIHRoZSBET00gYW5kIGNsZWFuIHVwLgogICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wb3ZlciBpcyBmaW5pc2hlZCBhbmltYXRpbmcgb3V0LgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgaW9uaWNQb3BvdmVyI2lzU2hvd24KICAgKiBAcmV0dXJucyBib29sZWFuIFdoZXRoZXIgdGhpcyBwb3BvdmVyIGlzIGN1cnJlbnRseSBzaG93bi4KICAgKi8KCiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljUG9wb3ZlciNmcm9tVGVtcGxhdGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZW1wbGF0ZVN0cmluZyBUaGUgdGVtcGxhdGUgc3RyaW5nIHRvIHVzZSBhcyB0aGUgcG9wb3ZlcnMncwogICAgICogY29udGVudC4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIE9wdGlvbnMgdG8gYmUgcGFzc2VkIHRvIHRoZSBpbml0aWFsaXplIG1ldGhvZC4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEFuIGluc3RhbmNlIG9mIGFuIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljUG9wb3Zlcn0KICAgICAqIGNvbnRyb2xsZXIgKCRpb25pY1BvcG92ZXIgaXMgYnVpbHQgb24gdG9wIG9mICRpb25pY1BvcG92ZXIpLgogICAgICovCiAgICBmcm9tVGVtcGxhdGU6IGZ1bmN0aW9uKHRlbXBsYXRlU3RyaW5nLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiAkaW9uaWNNb2RhbC5mcm9tVGVtcGxhdGUodGVtcGxhdGVTdHJpbmcsIGlvbmljLlV0aWxzLmV4dGVuZChvcHRpb25zIHx8IHt9LCBQT1BPVkVSX09QVElPTlMpICk7CiAgICB9LAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNQb3BvdmVyI2Zyb21UZW1wbGF0ZVVybAogICAgICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlVXJsIFRoZSB1cmwgdG8gbG9hZCB0aGUgdGVtcGxhdGUgZnJvbS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIE9wdGlvbnMgdG8gYmUgcGFzc2VkIHRvIHRoZSBpbml0aWFsaXplIG1ldGhvZC4KICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gaW5zdGFuY2Ugb2YKICAgICAqIGFuIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljUG9wb3Zlcn0gY29udHJvbGxlciAoJGlvbmljUG9wb3ZlciBpcyBidWlsdCBvbiB0b3Agb2YgJGlvbmljUG9wb3ZlcikuCiAgICAgKi8KICAgIGZyb21UZW1wbGF0ZVVybDogZnVuY3Rpb24odXJsLCBvcHRpb25zLCBfKSB7CiAgICAgIHJldHVybiAkaW9uaWNNb2RhbC5mcm9tVGVtcGxhdGVVcmwodXJsLCBvcHRpb25zLCBpb25pYy5VdGlscy5leHRlbmQob3B0aW9ucyB8fCB7fSwgUE9QT1ZFUl9PUFRJT05TKSApOwogICAgfQogIH07Cgp9XSk7CgoKdmFyIFBPUFVQX1RQTCA9CiAgJzxkaXYgY2xhc3M9InBvcHVwLWNvbnRhaW5lciI+JyArCiAgICAnPGRpdiBjbGFzcz0icG9wdXAiPicgKwogICAgICAnPGRpdiBjbGFzcz0icG9wdXAtaGVhZCI+JyArCiAgICAgICAgJzxoMyBjbGFzcz0icG9wdXAtdGl0bGUiIG5nLWJpbmQtaHRtbD0idGl0bGUiPjwvaDM+JyArCiAgICAgICAgJzxoNSBjbGFzcz0icG9wdXAtc3ViLXRpdGxlIiBuZy1iaW5kLWh0bWw9InN1YlRpdGxlIiBuZy1pZj0ic3ViVGl0bGUiPjwvaDU+JyArCiAgICAgICc8L2Rpdj4nICsKICAgICAgJzxkaXYgY2xhc3M9InBvcHVwLWJvZHkiPicgKwogICAgICAnPC9kaXY+JyArCiAgICAgICc8ZGl2IGNsYXNzPSJwb3B1cC1idXR0b25zIj4nICsKICAgICAgICAnPGJ1dHRvbiBuZy1yZXBlYXQ9ImJ1dHRvbiBpbiBidXR0b25zIiBuZy1jbGljaz0iJGJ1dHRvblRhcHBlZChidXR0b24sICRldmVudCkiIGNsYXNzPSJidXR0b24iIG5nLWNsYXNzPSJidXR0b24udHlwZSB8fCBcJ2J1dHRvbi1kZWZhdWx0XCciIG5nLWJpbmQtaHRtbD0iYnV0dG9uLnRleHQiPjwvYnV0dG9uPicgKwogICAgICAnPC9kaXY+JyArCiAgICAnPC9kaXY+JyArCiAgJzwvZGl2Pic7CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljUG9wdXAKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAY29kZXBlbiB6a21oSgogKiBAZGVzY3JpcHRpb24KICoKICogVGhlIElvbmljIFBvcHVwIHNlcnZpY2UgYWxsb3dzIHByb2dyYW1tYXRpY2FsbHkgY3JlYXRpbmcgYW5kIHNob3dpbmcgcG9wdXAKICogd2luZG93cyB0aGF0IHJlcXVpcmUgdGhlIHVzZXIgdG8gcmVzcG9uZCBpbiBvcmRlciB0byBjb250aW51ZS4KICoKICogVGhlIHBvcHVwIHN5c3RlbSBoYXMgc3VwcG9ydCBmb3IgbW9yZSBmbGV4aWJsZSB2ZXJzaW9ucyBvZiB0aGUgYnVpbHQgaW4gYGFsZXJ0KClgLCBgcHJvbXB0KClgLAogKiBhbmQgYGNvbmZpcm0oKWAgZnVuY3Rpb25zIHRoYXQgdXNlcnMgYXJlIHVzZWQgdG8sIGluIGFkZGl0aW9uIHRvIGFsbG93aW5nIHBvcHVwcyB3aXRoIGNvbXBsZXRlbHkKICogY3VzdG9tIGNvbnRlbnQgYW5kIGxvb2suCiAqCiAqIEFuIGlucHV0IGNhbiBiZSBnaXZlbiBhbiBgYXV0b2ZvY3VzYCBhdHRyaWJ1dGUgc28gaXQgYXV0b21hdGljYWxseSByZWNlaXZlcyBmb2N1cyB3aGVuCiAqIHRoZSBwb3B1cCBmaXJzdCBzaG93cy4gSG93ZXZlciwgZGVwZW5kaW5nIG9uIGNlcnRhaW4gdXNlLWNhc2VzIHRoaXMgY2FuIGNhdXNlIGlzc3VlcyB3aXRoCiAqIHRoZSB0YXAvY2xpY2sgc3lzdGVtLCB3aGljaCBpcyB3aHkgSW9uaWMgcHJlZmVycyB1c2luZyB0aGUgYGF1dG9mb2N1c2AgYXR0cmlidXRlIGFzCiAqIGFuIG9wdC1pbiBmZWF0dXJlIGFuZCBub3QgdGhlIGRlZmF1bHQuCiAqCiAqIEB1c2FnZQogKiBBIGZldyBiYXNpYyBleGFtcGxlcywgc2VlIGJlbG93IGZvciBkZXRhaWxzIGFib3V0IGFsbCBvZiB0aGUgb3B0aW9ucyBhdmFpbGFibGUuCiAqCiAqIGBgYGpzCiAqYW5ndWxhci5tb2R1bGUoJ215U3VwZXJBcHAnLCBbJ2lvbmljJ10pCiAqLmNvbnRyb2xsZXIoJ1BvcHVwQ3RybCcsZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNQb3B1cCwgJHRpbWVvdXQpIHsKICoKICogLy8gVHJpZ2dlcmVkIG9uIGEgYnV0dG9uIGNsaWNrLCBvciBzb21lIG90aGVyIHRhcmdldAogKiAkc2NvcGUuc2hvd1BvcHVwID0gZnVuY3Rpb24oKSB7CiAqICAgJHNjb3BlLmRhdGEgPSB7fQogKgogKiAgIC8vIEFuIGVsYWJvcmF0ZSwgY3VzdG9tIHBvcHVwCiAqICAgdmFyIG15UG9wdXAgPSAkaW9uaWNQb3B1cC5zaG93KHsKICogICAgIHRlbXBsYXRlOiAnPGlucHV0IHR5cGU9InBhc3N3b3JkIiBuZy1tb2RlbD0iZGF0YS53aWZpIj4nLAogKiAgICAgdGl0bGU6ICdFbnRlciBXaS1GaSBQYXNzd29yZCcsCiAqICAgICBzdWJUaXRsZTogJ1BsZWFzZSB1c2Ugbm9ybWFsIHRoaW5ncycsCiAqICAgICBzY29wZTogJHNjb3BlLAogKiAgICAgYnV0dG9uczogWwogKiAgICAgICB7IHRleHQ6ICdDYW5jZWwnIH0sCiAqICAgICAgIHsKICogICAgICAgICB0ZXh0OiAnPGI+U2F2ZTwvYj4nLAogKiAgICAgICAgIHR5cGU6ICdidXR0b24tcG9zaXRpdmUnLAogKiAgICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAqICAgICAgICAgICBpZiAoISRzY29wZS5kYXRhLndpZmkpIHsKICogICAgICAgICAgICAgLy9kb24ndCBhbGxvdyB0aGUgdXNlciB0byBjbG9zZSB1bmxlc3MgaGUgZW50ZXJzIHdpZmkgcGFzc3dvcmQKICogICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogKiAgICAgICAgICAgfSBlbHNlIHsKICogICAgICAgICAgICAgcmV0dXJuICRzY29wZS5kYXRhLndpZmk7CiAqICAgICAgICAgICB9CiAqICAgICAgICAgfQogKiAgICAgICB9LAogKiAgICAgXQogKiAgIH0pOwogKiAgIG15UG9wdXAudGhlbihmdW5jdGlvbihyZXMpIHsKICogICAgIGNvbnNvbGUubG9nKCdUYXBwZWQhJywgcmVzKTsKICogICB9KTsKICogICAkdGltZW91dChmdW5jdGlvbigpIHsKICogICAgICBteVBvcHVwLmNsb3NlKCk7IC8vY2xvc2UgdGhlIHBvcHVwIGFmdGVyIDMgc2Vjb25kcyBmb3Igc29tZSByZWFzb24KICogICB9LCAzMDAwKTsKICogIH07CiAqICAvLyBBIGNvbmZpcm0gZGlhbG9nCiAqICAkc2NvcGUuc2hvd0NvbmZpcm0gPSBmdW5jdGlvbigpIHsKICogICAgdmFyIGNvbmZpcm1Qb3B1cCA9ICRpb25pY1BvcHVwLmNvbmZpcm0oewogKiAgICAgIHRpdGxlOiAnQ29uc3VtZSBJY2UgQ3JlYW0nLAogKiAgICAgIHRlbXBsYXRlOiAnQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGVhdCB0aGlzIGljZSBjcmVhbT8nCiAqICAgIH0pOwogKiAgICBjb25maXJtUG9wdXAudGhlbihmdW5jdGlvbihyZXMpIHsKICogICAgICBpZihyZXMpIHsKICogICAgICAgIGNvbnNvbGUubG9nKCdZb3UgYXJlIHN1cmUnKTsKICogICAgICB9IGVsc2UgewogKiAgICAgICAgY29uc29sZS5sb2coJ1lvdSBhcmUgbm90IHN1cmUnKTsKICogICAgICB9CiAqICAgIH0pOwogKiAgfTsKICoKICogIC8vIEFuIGFsZXJ0IGRpYWxvZwogKiAgJHNjb3BlLnNob3dBbGVydCA9IGZ1bmN0aW9uKCkgewogKiAgICB2YXIgYWxlcnRQb3B1cCA9ICRpb25pY1BvcHVwLmFsZXJ0KHsKICogICAgICB0aXRsZTogJ0RvblwndCBlYXQgdGhhdCEnLAogKiAgICAgIHRlbXBsYXRlOiAnSXQgbWlnaHQgdGFzdGUgZ29vZCcKICogICAgfSk7CiAqICAgIGFsZXJ0UG9wdXAudGhlbihmdW5jdGlvbihyZXMpIHsKICogICAgICBjb25zb2xlLmxvZygnVGhhbmsgeW91IGZvciBub3QgZWF0aW5nIG15IGRlbGljaW91cyBpY2UgY3JlYW0gY29uZScpOwogKiAgICB9KTsKICogIH07CiAqfSk7CiAqYGBgCiAqLwoKSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY1BvcHVwJywgWwogICckaW9uaWNUZW1wbGF0ZUxvYWRlcicsCiAgJyRpb25pY0JhY2tkcm9wJywKICAnJHEnLAogICckdGltZW91dCcsCiAgJyRyb290U2NvcGUnLAogICckaW9uaWNCb2R5JywKICAnJGNvbXBpbGUnLAogICckaW9uaWNQbGF0Zm9ybScsCmZ1bmN0aW9uKCRpb25pY1RlbXBsYXRlTG9hZGVyLCAkaW9uaWNCYWNrZHJvcCwgJHEsICR0aW1lb3V0LCAkcm9vdFNjb3BlLCAkaW9uaWNCb2R5LCAkY29tcGlsZSwgJGlvbmljUGxhdGZvcm0pIHsKICAvL1RPRE8gYWxsb3cgdGhpcyB0byBiZSBjb25maWd1cmVkCiAgdmFyIGNvbmZpZyA9IHsKICAgIHN0YWNrUHVzaERlbGF5OiA3NQogIH07CiAgdmFyIHBvcHVwU3RhY2sgPSBbXTsKICB2YXIgJGlvbmljUG9wdXAgPSB7CiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvdyBhIGNvbXBsZXggcG9wdXAuIFRoaXMgaXMgdGhlIG1hc3RlciBzaG93IGZ1bmN0aW9uIGZvciBhbGwgcG9wdXBzLgogICAgICoKICAgICAqIEEgY29tcGxleCBwb3B1cCBoYXMgYSBgYnV0dG9uc2AgYXJyYXksIHdpdGggZWFjaCBidXR0b24gaGF2aW5nIGEgYHRleHRgIGFuZCBgdHlwZWAKICAgICAqIGZpZWxkLCBpbiBhZGRpdGlvbiB0byBhbiBgb25UYXBgIGZ1bmN0aW9uLiAgVGhlIGBvblRhcGAgZnVuY3Rpb24sIGNhbGxlZCB3aGVuCiAgICAgKiB0aGUgY29ycmVzcG9uZGluZ2J1dHRvbiBvbiB0aGUgcG9wdXAgaXMgdGFwcGVkLCB3aWxsIGJ5IGRlZmF1bHQgY2xvc2UgdGhlIHBvcHVwCiAgICAgKiBhbmQgcmVzb2x2ZSB0aGUgcG9wdXAgcHJvbWlzZSB3aXRoIGl0cyByZXR1cm4gdmFsdWUuICBJZiB5b3Ugd2lzaCB0byBwcmV2ZW50IHRoZQogICAgICogZGVmYXVsdCBhbmQga2VlcCB0aGUgcG9wdXAgb3BlbiBvbiBidXR0b24gdGFwLCBjYWxsIGBldmVudC5wcmV2ZW50RGVmYXVsdCgpYCBvbiB0aGUKICAgICAqIHBhc3NlZCBpbiB0YXAgZXZlbnQuICBEZXRhaWxzIGJlbG93LgogICAgICoKICAgICAqIEBuYW1lICRpb25pY1BvcHVwI3Nob3cKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIGZvciB0aGUgbmV3IHBvcHVwLCBvZiB0aGUgZm9ybToKICAgICAqCiAgICAgKiBgYGAKICAgICAqIHsKICAgICAqICAgdGl0bGU6ICcnLCAvLyBTdHJpbmcuIFRoZSB0aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHN1YlRpdGxlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBzdWItdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICB0ZW1wbGF0ZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgYm9keS4KICAgICAqICAgdGVtcGxhdGVVcmw6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIFVSTCBvZiBhbiBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCAgIGJvZHkuCiAgICAgKiAgIHNjb3BlOiBudWxsLCAvLyBTY29wZSAob3B0aW9uYWwpLiBBIHNjb3BlIHRvIGxpbmsgdG8gdGhlIHBvcHVwIGNvbnRlbnQuCiAgICAgKiAgIGJ1dHRvbnM6IFt7IC8vQXJyYXlbT2JqZWN0XSAob3B0aW9uYWwpLiBCdXR0b25zIHRvIHBsYWNlIGluIHRoZSBwb3B1cCBmb290ZXIuCiAgICAgKiAgICAgdGV4dDogJ0NhbmNlbCcsCiAgICAgKiAgICAgdHlwZTogJ2J1dHRvbi1kZWZhdWx0JywKICAgICAqICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogICAgICogICAgICAgLy8gZS5wcmV2ZW50RGVmYXVsdCgpIHdpbGwgc3RvcCB0aGUgcG9wdXAgZnJvbSBjbG9zaW5nIHdoZW4gdGFwcGVkLgogICAgICogICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICogICAgIH0KICAgICAqICAgfSwgewogICAgICogICAgIHRleHQ6ICdPSycsCiAgICAgKiAgICAgdHlwZTogJ2J1dHRvbi1wb3NpdGl2ZScsCiAgICAgKiAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHsKICAgICAqICAgICAgIC8vIFJldHVybmluZyBhIHZhbHVlIHdpbGwgY2F1c2UgdGhlIHByb21pc2UgdG8gcmVzb2x2ZSB3aXRoIHRoZSBnaXZlbiB2YWx1ZS4KICAgICAqICAgICAgIHJldHVybiBzY29wZS5kYXRhLnJlc3BvbnNlOwogICAgICogICAgIH0KICAgICAqICAgfV0KICAgICAqIH0KICAgICAqIGBgYAogICAgICoKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3B1cCBpcyBjbG9zZWQuIEhhcyBhbiBhZGRpdGlvbmFsCiAgICAgKiBgY2xvc2VgIGZ1bmN0aW9uLCB3aGljaCBjYW4gYmUgdXNlZCB0byBwcm9ncmFtbWF0aWNhbGx5IGNsb3NlIHRoZSBwb3B1cC4KICAgICAqLwogICAgc2hvdzogc2hvd1BvcHVwLAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljUG9wdXAjYWxlcnQKICAgICAqIEBkZXNjcmlwdGlvbiBTaG93IGEgc2ltcGxlIGFsZXJ0IHBvcHVwIHdpdGggYSBtZXNzYWdlIGFuZCBvbmUgYnV0dG9uIHRoYXQgdGhlIHVzZXIgY2FuCiAgICAgKiB0YXAgdG8gY2xvc2UgdGhlIHBvcHVwLgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIGZvciBzaG93aW5nIHRoZSBhbGVydCwgb2YgdGhlIGZvcm06CiAgICAgKgogICAgICogYGBgCiAgICAgKiB7CiAgICAgKiAgIHRpdGxlOiAnJywgLy8gU3RyaW5nLiBUaGUgdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICBzdWJUaXRsZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgc3ViLXRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgdGVtcGxhdGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwIGJvZHkuCiAgICAgKiAgIHRlbXBsYXRlVXJsOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBVUkwgb2YgYW4gaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgICBib2R5LgogICAgICogICBva1RleHQ6ICcnLCAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdPSycpLiBUaGUgdGV4dCBvZiB0aGUgT0sgYnV0dG9uLgogICAgICogICBva1R5cGU6ICcnLCAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdidXR0b24tcG9zaXRpdmUnKS4gVGhlIHR5cGUgb2YgdGhlIE9LIGJ1dHRvbi4KICAgICAqIH0KICAgICAqIGBgYAogICAgICoKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3B1cCBpcyBjbG9zZWQuIEhhcyBvbmUgYWRkaXRpb25hbAogICAgICogZnVuY3Rpb24gYGNsb3NlYCwgd2hpY2ggY2FuIGJlIGNhbGxlZCB3aXRoIGFueSB2YWx1ZSB0byBwcm9ncmFtbWF0aWNhbGx5IGNsb3NlIHRoZSBwb3B1cAogICAgICogd2l0aCB0aGUgZ2l2ZW4gdmFsdWUuCiAgICAgKi8KICAgIGFsZXJ0OiBzaG93QWxlcnQsCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNQb3B1cCNjb25maXJtCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3cgYSBzaW1wbGUgY29uZmlybSBwb3B1cCB3aXRoIGEgQ2FuY2VsIGFuZCBPSyBidXR0b24uCiAgICAgKgogICAgICogUmVzb2x2ZXMgdGhlIHByb21pc2Ugd2l0aCB0cnVlIGlmIHRoZSB1c2VyIHByZXNzZXMgdGhlIE9LIGJ1dHRvbiwgYW5kIGZhbHNlIGlmIHRoZQogICAgICogdXNlciBwcmVzc2VzIHRoZSBDYW5jZWwgYnV0dG9uLgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIGZvciBzaG93aW5nIHRoZSBjb25maXJtIHBvcHVwLCBvZiB0aGUgZm9ybToKICAgICAqCiAgICAgKiBgYGAKICAgICAqIHsKICAgICAqICAgdGl0bGU6ICcnLCAvLyBTdHJpbmcuIFRoZSB0aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHN1YlRpdGxlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBzdWItdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICB0ZW1wbGF0ZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgYm9keS4KICAgICAqICAgdGVtcGxhdGVVcmw6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIFVSTCBvZiBhbiBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCAgIGJvZHkuCiAgICAgKiAgIGNhbmNlbFRleHQ6ICcnLCAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdDYW5jZWwnKS4gVGhlIHRleHQgb2YgdGhlIENhbmNlbCBidXR0b24uCiAgICAgKiAgIGNhbmNlbFR5cGU6ICcnLCAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdidXR0b24tZGVmYXVsdCcpLiBUaGUgdHlwZSBvZiB0aGUgQ2FuY2VsIGJ1dHRvbi4KICAgICAqICAgb2tUZXh0OiAnJywgLy8gU3RyaW5nIChkZWZhdWx0OiAnT0snKS4gVGhlIHRleHQgb2YgdGhlIE9LIGJ1dHRvbi4KICAgICAqICAgb2tUeXBlOiAnJywgLy8gU3RyaW5nIChkZWZhdWx0OiAnYnV0dG9uLXBvc2l0aXZlJykuIFRoZSB0eXBlIG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiB9CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wdXAgaXMgY2xvc2VkLiBIYXMgb25lIGFkZGl0aW9uYWwKICAgICAqIGZ1bmN0aW9uIGBjbG9zZWAsIHdoaWNoIGNhbiBiZSBjYWxsZWQgd2l0aCBhbnkgdmFsdWUgdG8gcHJvZ3JhbW1hdGljYWxseSBjbG9zZSB0aGUgcG9wdXAKICAgICAqIHdpdGggdGhlIGdpdmVuIHZhbHVlLgogICAgICovCiAgICBjb25maXJtOiBzaG93Q29uZmlybSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1BvcHVwI3Byb21wdAogICAgICogQGRlc2NyaXB0aW9uIFNob3cgYSBzaW1wbGUgcHJvbXB0IHBvcHVwLCB3aGljaCBoYXMgYW4gaW5wdXQsIE9LIGJ1dHRvbiwgYW5kIENhbmNlbCBidXR0b24uCiAgICAgKiBSZXNvbHZlcyB0aGUgcHJvbWlzZSB3aXRoIHRoZSB2YWx1ZSBvZiB0aGUgaW5wdXQgaWYgdGhlIHVzZXIgcHJlc3NlcyBPSywgYW5kIHdpdGggdW5kZWZpbmVkCiAgICAgKiBpZiB0aGUgdXNlciBwcmVzc2VzIENhbmNlbC4KICAgICAqCiAgICAgKiBgYGBqYXZhc2NyaXB0CiAgICAgKiAgJGlvbmljUG9wdXAucHJvbXB0KHsKICAgICAqICAgIHRpdGxlOiAnUGFzc3dvcmQgQ2hlY2snLAogICAgICogICAgdGVtcGxhdGU6ICdFbnRlciB5b3VyIHNlY3JldCBwYXNzd29yZCcsCiAgICAgKiAgICBpbnB1dFR5cGU6ICdwYXNzd29yZCcsCiAgICAgKiAgICBpbnB1dFBsYWNlaG9sZGVyOiAnWW91ciBwYXNzd29yZCcKICAgICAqICB9KS50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICogICAgY29uc29sZS5sb2coJ1lvdXIgcGFzc3dvcmQgaXMnLCByZXMpOwogICAgICogIH0pOwogICAgICogYGBgCiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBmb3Igc2hvd2luZyB0aGUgcHJvbXB0IHBvcHVwLCBvZiB0aGUgZm9ybToKICAgICAqCiAgICAgKiBgYGAKICAgICAqIHsKICAgICAqICAgdGl0bGU6ICcnLCAvLyBTdHJpbmcuIFRoZSB0aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHN1YlRpdGxlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBzdWItdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICB0ZW1wbGF0ZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgYm9keS4KICAgICAqICAgdGVtcGxhdGVVcmw6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIFVSTCBvZiBhbiBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCAgIGJvZHkuCiAgICAgKiAgIGlucHV0VHlwZTogLy8gU3RyaW5nIChkZWZhdWx0OiAndGV4dCcpLiBUaGUgdHlwZSBvZiBpbnB1dCB0byB1c2UKICAgICAqICAgaW5wdXRQbGFjZWhvbGRlcjogLy8gU3RyaW5nIChkZWZhdWx0OiAnJykuIEEgcGxhY2Vob2xkZXIgdG8gdXNlIGZvciB0aGUgaW5wdXQuCiAgICAgKiAgIGNhbmNlbFRleHQ6IC8vIFN0cmluZyAoZGVmYXVsdDogJ0NhbmNlbCcuIFRoZSB0ZXh0IG9mIHRoZSBDYW5jZWwgYnV0dG9uLgogICAgICogICBjYW5jZWxUeXBlOiAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdidXR0b24tZGVmYXVsdCcpLiBUaGUgdHlwZSBvZiB0aGUgQ2FuY2VsIGJ1dHRvbi4KICAgICAqICAgb2tUZXh0OiAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdPSycpLiBUaGUgdGV4dCBvZiB0aGUgT0sgYnV0dG9uLgogICAgICogICBva1R5cGU6IC8vIFN0cmluZyAoZGVmYXVsdDogJ2J1dHRvbi1wb3NpdGl2ZScpLiBUaGUgdHlwZSBvZiB0aGUgT0sgYnV0dG9uLgogICAgICogfQogICAgICogYGBgCiAgICAgKgogICAgICogQHJldHVybnMge29iamVjdH0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIHBvcHVwIGlzIGNsb3NlZC4gSGFzIG9uZSBhZGRpdGlvbmFsCiAgICAgKiBmdW5jdGlvbiBgY2xvc2VgLCB3aGljaCBjYW4gYmUgY2FsbGVkIHdpdGggYW55IHZhbHVlIHRvIHByb2dyYW1tYXRpY2FsbHkgY2xvc2UgdGhlIHBvcHVwCiAgICAgKiB3aXRoIHRoZSBnaXZlbiB2YWx1ZS4KICAgICAqLwogICAgcHJvbXB0OiBzaG93UHJvbXB0LAogICAgLyoqCiAgICAgKiBAcHJpdmF0ZSBmb3IgdGVzdGluZwogICAgICovCiAgICBfY3JlYXRlUG9wdXA6IGNyZWF0ZVBvcHVwLAogICAgX3BvcHVwU3RhY2s6IHBvcHVwU3RhY2sKICB9OwoKICByZXR1cm4gJGlvbmljUG9wdXA7CgogIGZ1bmN0aW9uIGNyZWF0ZVBvcHVwKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICBzY29wZTogbnVsbCwKICAgICAgdGl0bGU6ICcnLAogICAgICBidXR0b25zOiBbXSwKICAgIH0sIG9wdGlvbnMgfHwge30pOwoKICAgIHZhciBwb3B1cFByb21pc2UgPSAkaW9uaWNUZW1wbGF0ZUxvYWRlci5jb21waWxlKHsKICAgICAgdGVtcGxhdGU6IFBPUFVQX1RQTCwKICAgICAgc2NvcGU6IG9wdGlvbnMuc2NvcGUgJiYgb3B0aW9ucy5zY29wZS4kbmV3KCksCiAgICAgIGFwcGVuZFRvOiAkaW9uaWNCb2R5LmdldCgpCiAgICB9KTsKICAgIHZhciBjb250ZW50UHJvbWlzZSA9IG9wdGlvbnMudGVtcGxhdGVVcmwgPwogICAgICAkaW9uaWNUZW1wbGF0ZUxvYWRlci5sb2FkKG9wdGlvbnMudGVtcGxhdGVVcmwpIDoKICAgICAgJHEud2hlbihvcHRpb25zLnRlbXBsYXRlIHx8IG9wdGlvbnMuY29udGVudCB8fCAnJyk7CgogICAgcmV0dXJuICRxLmFsbChbcG9wdXBQcm9taXNlLCBjb250ZW50UHJvbWlzZV0pCiAgICAudGhlbihmdW5jdGlvbihyZXN1bHRzKSB7CiAgICAgIHZhciBzZWxmID0gcmVzdWx0c1swXTsKICAgICAgdmFyIGNvbnRlbnQgPSByZXN1bHRzWzFdOwogICAgICB2YXIgcmVzcG9uc2VEZWZlcnJlZCA9ICRxLmRlZmVyKCk7CgogICAgICBzZWxmLnJlc3BvbnNlRGVmZXJyZWQgPSByZXNwb25zZURlZmVycmVkOwoKICAgICAgLy9DYW4ndCBuZy1iaW5kLWh0bWwgZm9yIHBvcHVwLWJvZHkgYmVjYXVzZSBpdCBjYW4gYmUgaW5zZWN1cmUgaHRtbAogICAgICAvLyhlZyBhbiBpbnB1dCBpbiBjYXNlIG9mIHByb21wdCkKICAgICAgdmFyIGJvZHkgPSBqcUxpdGUoc2VsZi5lbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJy5wb3B1cC1ib2R5JykpOwogICAgICBpZiAoY29udGVudCkgewogICAgICAgIGJvZHkuaHRtbChjb250ZW50KTsKICAgICAgICAkY29tcGlsZShib2R5LmNvbnRlbnRzKCkpKHNlbGYuc2NvcGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGJvZHkucmVtb3ZlKCk7CiAgICAgIH0KCiAgICAgIGV4dGVuZChzZWxmLnNjb3BlLCB7CiAgICAgICAgdGl0bGU6IG9wdGlvbnMudGl0bGUsCiAgICAgICAgYnV0dG9uczogb3B0aW9ucy5idXR0b25zLAogICAgICAgIHN1YlRpdGxlOiBvcHRpb25zLnN1YlRpdGxlLAogICAgICAgICRidXR0b25UYXBwZWQ6IGZ1bmN0aW9uKGJ1dHRvbiwgZXZlbnQpIHsKICAgICAgICAgIHZhciByZXN1bHQgPSAoYnV0dG9uLm9uVGFwIHx8IGFuZ3VsYXIubm9vcCkoZXZlbnQpOwogICAgICAgICAgZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50IHx8IGV2ZW50OyAvL2pxdWVyeSBldmVudHMKCiAgICAgICAgICBpZiAoIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgcmVzcG9uc2VEZWZlcnJlZC5yZXNvbHZlKHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHNlbGYuc2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChzZWxmLmlzU2hvd24pIHJldHVybjsKCiAgICAgICAgc2VsZi5pc1Nob3duID0gdHJ1ZTsKICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAvL2lmIGhpZGRlbiB3aGlsZSB3YWl0aW5nIGZvciByYWYsIGRvbid0IHNob3cKICAgICAgICAgIGlmICghc2VsZi5pc1Nob3duKSByZXR1cm47CgogICAgICAgICAgc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCdwb3B1cC1oaWRkZW4nKTsKICAgICAgICAgIHNlbGYuZWxlbWVudC5hZGRDbGFzcygncG9wdXAtc2hvd2luZyBhY3RpdmUnKTsKICAgICAgICAgIGZvY3VzSW5wdXQoc2VsZi5lbGVtZW50KTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgc2VsZi5oaWRlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcDsKICAgICAgICBpZiAoIXNlbGYuaXNTaG93bikgcmV0dXJuIGNhbGxiYWNrKCk7CgogICAgICAgIHNlbGYuaXNTaG93biA9IGZhbHNlOwogICAgICAgIHNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgc2VsZi5lbGVtZW50LmFkZENsYXNzKCdwb3B1cC1oaWRkZW4nKTsKICAgICAgICAkdGltZW91dChjYWxsYmFjaywgMjUwKTsKICAgICAgfTsKICAgICAgc2VsZi5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoc2VsZi5yZW1vdmVkKSByZXR1cm47CgogICAgICAgIHNlbGYuaGlkZShmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgIHNlbGYuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICB9KTsKCiAgICAgICAgc2VsZi5yZW1vdmVkID0gdHJ1ZTsKICAgICAgfTsKCiAgICAgIHJldHVybiBzZWxmOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBvbkhhcmR3YXJlQmFja0J1dHRvbihlKSB7CiAgICBwb3B1cFN0YWNrWzBdICYmIHBvcHVwU3RhY2tbMF0ucmVzcG9uc2VEZWZlcnJlZC5yZXNvbHZlKCk7CiAgfQoKICBmdW5jdGlvbiBzaG93UG9wdXAob3B0aW9ucykgewogICAgdmFyIHBvcHVwUHJvbWlzZSA9ICRpb25pY1BvcHVwLl9jcmVhdGVQb3B1cChvcHRpb25zKTsKICAgIHZhciBwcmV2aW91c1BvcHVwID0gcG9wdXBTdGFja1swXTsKCiAgICBpZiAocHJldmlvdXNQb3B1cCkgewogICAgICBwcmV2aW91c1BvcHVwLmhpZGUoKTsKICAgIH0KCiAgICB2YXIgcmVzdWx0UHJvbWlzZSA9ICR0aW1lb3V0KGFuZ3VsYXIubm9vcCwgcHJldmlvdXNQb3B1cCA/IGNvbmZpZy5zdGFja1B1c2hEZWxheSA6IDApCiAgICAudGhlbihmdW5jdGlvbigpIHsgcmV0dXJuIHBvcHVwUHJvbWlzZTsgfSkKICAgIC50aGVuKGZ1bmN0aW9uKHBvcHVwKSB7CiAgICAgIGlmICghcHJldmlvdXNQb3B1cCkgewogICAgICAgIC8vQWRkIHBvcHVwLW9wZW4gJiBiYWNrZHJvcCBpZiB0aGlzIGlzIGZpcnN0IHBvcHVwCiAgICAgICAgJGlvbmljQm9keS5hZGRDbGFzcygncG9wdXAtb3BlbicpOwogICAgICAgICRpb25pY0JhY2tkcm9wLnJldGFpbigpOwogICAgICAgIC8vb25seSBzaG93IHRoZSBiYWNrZHJvcCBvbiB0aGUgZmlyc3QgcG9wdXAKICAgICAgICAkaW9uaWNQb3B1cC5fYmFja0J1dHRvbkFjdGlvbkRvbmUgPSAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICAgICAgICBvbkhhcmR3YXJlQmFja0J1dHRvbiwKICAgICAgICAgIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1BPUFVQCiAgICAgICAgKTsKICAgICAgfQogICAgICBwb3B1cFN0YWNrLnVuc2hpZnQocG9wdXApOwogICAgICBwb3B1cC5zaG93KCk7CgogICAgICAvL0RFUFJFQ0FURUQ6IG5vdGlmeSB0aGUgcHJvbWlzZSB3aXRoIGFuIG9iamVjdCB3aXRoIGEgY2xvc2UgbWV0aG9kCiAgICAgIHBvcHVwLnJlc3BvbnNlRGVmZXJyZWQubm90aWZ5KHsKICAgICAgICBjbG9zZTogcmVzdWx0UHJvbWlzZS5jbG9zZQogICAgICB9KTsKCiAgICAgIHJldHVybiBwb3B1cC5yZXNwb25zZURlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICB2YXIgaW5kZXggPSBwb3B1cFN0YWNrLmluZGV4T2YocG9wdXApOwogICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgIHBvcHVwU3RhY2suc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgICAgcG9wdXAucmVtb3ZlKCk7CgogICAgICAgIHZhciBwcmV2aW91c1BvcHVwID0gcG9wdXBTdGFja1swXTsKICAgICAgICBpZiAocHJldmlvdXNQb3B1cCkgewogICAgICAgICAgcHJldmlvdXNQb3B1cC5zaG93KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vUmVtb3ZlIHBvcHVwLW9wZW4gJiBiYWNrZHJvcCBpZiB0aGlzIGlzIGxhc3QgcG9wdXAKICAgICAgICAgICRpb25pY0JvZHkucmVtb3ZlQ2xhc3MoJ3BvcHVwLW9wZW4nKTsKICAgICAgICAgICRpb25pY0JhY2tkcm9wLnJlbGVhc2UoKTsKICAgICAgICAgICgkaW9uaWNQb3B1cC5fYmFja0J1dHRvbkFjdGlvbkRvbmUgfHwgYW5ndWxhci5ub29wKSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9KTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIGNsb3NlKHJlc3VsdCkgewogICAgICBwb3B1cFByb21pc2UudGhlbihmdW5jdGlvbihwb3B1cCkgewogICAgICAgIGlmICghcG9wdXAucmVtb3ZlZCkgewogICAgICAgICAgcG9wdXAucmVzcG9uc2VEZWZlcnJlZC5yZXNvbHZlKHJlc3VsdCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJlc3VsdFByb21pc2UuY2xvc2UgPSBjbG9zZTsKCiAgICByZXR1cm4gcmVzdWx0UHJvbWlzZTsKICB9CgogIGZ1bmN0aW9uIGZvY3VzSW5wdXQoZWxlbWVudCkgewogICAgdmFyIGZvY3VzT24gPSBlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJ1thdXRvZm9jdXNdJyk7CiAgICBpZiAoZm9jdXNPbikgewogICAgICBmb2N1c09uLmZvY3VzKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzaG93QWxlcnQob3B0cykgewogICAgcmV0dXJuIHNob3dQb3B1cCggZXh0ZW5kKHsKICAgICAgYnV0dG9uczogW3sKICAgICAgICB0ZXh0OiBvcHRzLm9rVGV4dCB8fCAnT0snLAogICAgICAgIHR5cGU6IG9wdHMub2tUeXBlIHx8ICdidXR0b24tcG9zaXRpdmUnLAogICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH1dCiAgICB9LCBvcHRzIHx8IHt9KSApOwogIH0KCiAgZnVuY3Rpb24gc2hvd0NvbmZpcm0ob3B0cykgewogICAgcmV0dXJuIHNob3dQb3B1cCggZXh0ZW5kKHsKICAgICAgYnV0dG9uczogW3sKICAgICAgICB0ZXh0OiBvcHRzLmNhbmNlbFRleHQgfHwgJ0NhbmNlbCcgLAogICAgICAgIHR5cGU6IG9wdHMuY2FuY2VsVHlwZSB8fCAnYnV0dG9uLWRlZmF1bHQnLAogICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7IHJldHVybiBmYWxzZTsgfQogICAgICB9LCB7CiAgICAgICAgdGV4dDogb3B0cy5va1RleHQgfHwgJ09LJywKICAgICAgICB0eXBlOiBvcHRzLm9rVHlwZSB8fCAnYnV0dG9uLXBvc2l0aXZlJywKICAgICAgICBvblRhcDogZnVuY3Rpb24oZSkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICB9XQogICAgfSwgb3B0cyB8fCB7fSkgKTsKICB9CgogIGZ1bmN0aW9uIHNob3dQcm9tcHQob3B0cykgewogICAgdmFyIHNjb3BlID0gJHJvb3RTY29wZS4kbmV3KHRydWUpOwogICAgc2NvcGUuZGF0YSA9IHt9OwogICAgdmFyIHRleHQgPSAnJzsKICAgIGlmKG9wdHMudGVtcGxhdGUgJiYgLzxbYS16XVtcc1xTXSo+L2kudGVzdChvcHRzLnRlbXBsYXRlKSA9PT0gZmFsc2UpewogICAgICB0ZXh0ID0gJzxzcGFuPicrb3B0cy50ZW1wbGF0ZSsnPC9zcGFuPic7CiAgICAgIGRlbGV0ZSBvcHRzLnRlbXBsYXRlOwogICAgfQogICAgcmV0dXJuIHNob3dQb3B1cCggZXh0ZW5kKHsKICAgICAgdGVtcGxhdGU6IHRleHQrJzxpbnB1dCBuZy1tb2RlbD0iZGF0YS5yZXNwb25zZSIgdHlwZT0iJyArIChvcHRzLmlucHV0VHlwZSB8fCAndGV4dCcpICsKICAgICAgICAnIiBwbGFjZWhvbGRlcj0iJyArIChvcHRzLmlucHV0UGxhY2Vob2xkZXIgfHwgJycpICsgJyI+JywKICAgICAgc2NvcGU6IHNjb3BlLAogICAgICBidXR0b25zOiBbewogICAgICAgIHRleHQ6IG9wdHMuY2FuY2VsVGV4dCB8fCAnQ2FuY2VsJywKICAgICAgICB0eXBlOiBvcHRzLmNhbmNlbFR5cGV8fCAnYnV0dG9uLWRlZmF1bHQnLAogICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7fQogICAgICB9LCB7CiAgICAgICAgdGV4dDogb3B0cy5va1RleHQgfHwgJ09LJywKICAgICAgICB0eXBlOiBvcHRzLm9rVHlwZSB8fCAnYnV0dG9uLXBvc2l0aXZlJywKICAgICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgcmV0dXJuIHNjb3BlLmRhdGEucmVzcG9uc2UgfHwgJyc7CiAgICAgICAgfQogICAgICB9XQogICAgfSwgb3B0cyB8fCB7fSkgKTsKICB9Cn1dKTsKCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljUG9zaXRpb24KICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24KICogQSBzZXQgb2YgdXRpbGl0eSBtZXRob2RzIHRoYXQgY2FuIGJlIHVzZSB0byByZXRyaWV2ZSBwb3NpdGlvbiBvZiBET00gZWxlbWVudHMuCiAqIEl0IGlzIG1lYW50IHRvIGJlIHVzZWQgd2hlcmUgd2UgbmVlZCB0byBhYnNvbHV0ZS1wb3NpdGlvbiBET00gZWxlbWVudHMgaW4KICogcmVsYXRpb24gdG8gb3RoZXIsIGV4aXN0aW5nIGVsZW1lbnRzICh0aGlzIGlzIHRoZSBjYXNlIGZvciB0b29sdGlwcywgcG9wb3ZlcnMsIGV0Yy4pLgogKgogKiBBZGFwdGVkIGZyb20gW0FuZ3VsYXJVSSBCb290c3RyYXBdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyLXVpL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9zcmMvcG9zaXRpb24vcG9zaXRpb24uanMpLAogKiAoW2xpY2Vuc2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyLXVpL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKSkKICovCklvbmljTW9kdWxlCi5mYWN0b3J5KCckaW9uaWNQb3NpdGlvbicsIFsnJGRvY3VtZW50JywgJyR3aW5kb3cnLCBmdW5jdGlvbiAoJGRvY3VtZW50LCAkd2luZG93KSB7CgogIGZ1bmN0aW9uIGdldFN0eWxlKGVsLCBjc3Nwcm9wKSB7CiAgICBpZiAoZWwuY3VycmVudFN0eWxlKSB7IC8vSUUKICAgICAgcmV0dXJuIGVsLmN1cnJlbnRTdHlsZVtjc3Nwcm9wXTsKICAgIH0gZWxzZSBpZiAoJHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgIHJldHVybiAkd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpW2Nzc3Byb3BdOwogICAgfQogICAgLy8gZmluYWxseSB0cnkgYW5kIGdldCBpbmxpbmUgc3R5bGUKICAgIHJldHVybiBlbC5zdHlsZVtjc3Nwcm9wXTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBhIGdpdmVuIGVsZW1lbnQgaXMgc3RhdGljYWxseSBwb3NpdGlvbmVkCiAgICogQHBhcmFtIGVsZW1lbnQgLSByYXcgRE9NIGVsZW1lbnQKICAgKi8KICBmdW5jdGlvbiBpc1N0YXRpY1Bvc2l0aW9uZWQoZWxlbWVudCkgewogICAgcmV0dXJuIChnZXRTdHlsZShlbGVtZW50LCAncG9zaXRpb24nKSB8fCAnc3RhdGljJyApID09PSAnc3RhdGljJzsKICB9CgogIC8qKgogICAqIHJldHVybnMgdGhlIGNsb3Nlc3QsIG5vbi1zdGF0aWNhbGx5IHBvc2l0aW9uZWQgcGFyZW50T2Zmc2V0IG9mIGEgZ2l2ZW4gZWxlbWVudAogICAqIEBwYXJhbSBlbGVtZW50CiAgICovCiAgdmFyIHBhcmVudE9mZnNldEVsID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgIHZhciBkb2NEb21FbCA9ICRkb2N1bWVudFswXTsKICAgIHZhciBvZmZzZXRQYXJlbnQgPSBlbGVtZW50Lm9mZnNldFBhcmVudCB8fCBkb2NEb21FbDsKICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgb2Zmc2V0UGFyZW50ICE9PSBkb2NEb21FbCAmJiBpc1N0YXRpY1Bvc2l0aW9uZWQob2Zmc2V0UGFyZW50KSApIHsKICAgICAgb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKICAgIH0KICAgIHJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jRG9tRWw7CiAgfTsKCiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljUG9zaXRpb24jcG9zaXRpb24KICAgICAqIEBkZXNjcmlwdGlvbiBHZXQgdGhlIGN1cnJlbnQgY29vcmRpbmF0ZXMgb2YgdGhlIGVsZW1lbnQsIHJlbGF0aXZlIHRvIHRoZSBvZmZzZXQgcGFyZW50LgogICAgICogUmVhZC1vbmx5IGVxdWl2YWxlbnQgb2YgW2pRdWVyeSdzIHBvc2l0aW9uIGZ1bmN0aW9uXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcG9zaXRpb24vKS4KICAgICAqIEBwYXJhbSB7ZWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byBnZXQgdGhlIHBvc2l0aW9uIG9mLgogICAgICogQHJldHVybnMge29iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgcHJvcGVydGllcyB0b3AsIGxlZnQsIHdpZHRoIGFuZCBoZWlnaHQuCiAgICAgKi8KICAgIHBvc2l0aW9uOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICB2YXIgZWxCQ1IgPSB0aGlzLm9mZnNldChlbGVtZW50KTsKICAgICAgdmFyIG9mZnNldFBhcmVudEJDUiA9IHsgdG9wOiAwLCBsZWZ0OiAwIH07CiAgICAgIHZhciBvZmZzZXRQYXJlbnRFbCA9IHBhcmVudE9mZnNldEVsKGVsZW1lbnRbMF0pOwogICAgICBpZiAob2Zmc2V0UGFyZW50RWwgIT0gJGRvY3VtZW50WzBdKSB7CiAgICAgICAgb2Zmc2V0UGFyZW50QkNSID0gdGhpcy5vZmZzZXQoYW5ndWxhci5lbGVtZW50KG9mZnNldFBhcmVudEVsKSk7CiAgICAgICAgb2Zmc2V0UGFyZW50QkNSLnRvcCArPSBvZmZzZXRQYXJlbnRFbC5jbGllbnRUb3AgLSBvZmZzZXRQYXJlbnRFbC5zY3JvbGxUb3A7CiAgICAgICAgb2Zmc2V0UGFyZW50QkNSLmxlZnQgKz0gb2Zmc2V0UGFyZW50RWwuY2xpZW50TGVmdCAtIG9mZnNldFBhcmVudEVsLnNjcm9sbExlZnQ7CiAgICAgIH0KCiAgICAgIHZhciBib3VuZGluZ0NsaWVudFJlY3QgPSBlbGVtZW50WzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICByZXR1cm4gewogICAgICAgIHdpZHRoOiBib3VuZGluZ0NsaWVudFJlY3Qud2lkdGggfHwgZWxlbWVudC5wcm9wKCdvZmZzZXRXaWR0aCcpLAogICAgICAgIGhlaWdodDogYm91bmRpbmdDbGllbnRSZWN0LmhlaWdodCB8fCBlbGVtZW50LnByb3AoJ29mZnNldEhlaWdodCcpLAogICAgICAgIHRvcDogZWxCQ1IudG9wIC0gb2Zmc2V0UGFyZW50QkNSLnRvcCwKICAgICAgICBsZWZ0OiBlbEJDUi5sZWZ0IC0gb2Zmc2V0UGFyZW50QkNSLmxlZnQKICAgICAgfTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNQb3NpdGlvbiNvZmZzZXQKICAgICAqIEBkZXNjcmlwdGlvbiBHZXQgdGhlIGN1cnJlbnQgY29vcmRpbmF0ZXMgb2YgdGhlIGVsZW1lbnQsIHJlbGF0aXZlIHRvIHRoZSBkb2N1bWVudC4KICAgICAqIFJlYWQtb25seSBlcXVpdmFsZW50IG9mIFtqUXVlcnkncyBvZmZzZXQgZnVuY3Rpb25dKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9vZmZzZXQvKS4KICAgICAqIEBwYXJhbSB7ZWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byBnZXQgdGhlIG9mZnNldCBvZi4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHByb3BlcnRpZXMgdG9wLCBsZWZ0LCB3aWR0aCBhbmQgaGVpZ2h0LgogICAgICovCiAgICBvZmZzZXQ6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgIHZhciBib3VuZGluZ0NsaWVudFJlY3QgPSBlbGVtZW50WzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICByZXR1cm4gewogICAgICAgIHdpZHRoOiBib3VuZGluZ0NsaWVudFJlY3Qud2lkdGggfHwgZWxlbWVudC5wcm9wKCdvZmZzZXRXaWR0aCcpLAogICAgICAgIGhlaWdodDogYm91bmRpbmdDbGllbnRSZWN0LmhlaWdodCB8fCBlbGVtZW50LnByb3AoJ29mZnNldEhlaWdodCcpLAogICAgICAgIHRvcDogYm91bmRpbmdDbGllbnRSZWN0LnRvcCArICgkd2luZG93LnBhZ2VZT2Zmc2V0IHx8ICRkb2N1bWVudFswXS5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wKSwKICAgICAgICBsZWZ0OiBib3VuZGluZ0NsaWVudFJlY3QubGVmdCArICgkd2luZG93LnBhZ2VYT2Zmc2V0IHx8ICRkb2N1bWVudFswXS5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCkKICAgICAgfTsKICAgIH0KCiAgfTsKfV0pOwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZQogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKiBEZWxlZ2F0ZSBmb3IgY29udHJvbGxpbmcgc2Nyb2xsVmlld3MgKGNyZWF0ZWQgYnkKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25Db250ZW50fSBhbmQKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TY3JvbGx9IGRpcmVjdGl2ZXMpLgogKgogKiBNZXRob2RzIGNhbGxlZCBkaXJlY3RseSBvbiB0aGUgJGlvbmljU2Nyb2xsRGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIHNjcm9sbAogKiB2aWV3cy4gIFVzZSB0aGUge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljU2Nyb2xsRGVsZWdhdGUjJGdldEJ5SGFuZGxlICRnZXRCeUhhbmRsZX0KICogbWV0aG9kIHRvIGNvbnRyb2wgc3BlY2lmaWMgc2Nyb2xsVmlld3MuCiAqCiAqIEB1c2FnZQogKgogKiBgYGBodG1sCiAqIDxib2R5IG5nLWNvbnRyb2xsZXI9Ik1haW5DdHJsIj4KICogICA8aW9uLWNvbnRlbnQ+CiAqICAgICA8YnV0dG9uIG5nLWNsaWNrPSJzY3JvbGxUb3AoKSI+U2Nyb2xsIHRvIFRvcCE8L2J1dHRvbj4KICogICA8L2lvbi1jb250ZW50PgogKiA8L2JvZHk+CiAqIGBgYAogKiBgYGBqcwogKiBmdW5jdGlvbiBNYWluQ3RybCgkc2NvcGUsICRpb25pY1Njcm9sbERlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNjcm9sbFRvcCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljU2Nyb2xsRGVsZWdhdGUuc2Nyb2xsVG9wKCk7CiAqICAgfTsKICogfQogKiBgYGAKICoKICogRXhhbXBsZSBvZiBhZHZhbmNlZCB1c2FnZSwgd2l0aCB0d28gc2Nyb2xsIGFyZWFzIHVzaW5nIGBkZWxlZ2F0ZS1oYW5kbGVgCiAqIGZvciBmaW5lIGNvbnRyb2wuCiAqCiAqIGBgYGh0bWwKICogPGJvZHkgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogKiAgIDxpb24tY29udGVudCBkZWxlZ2F0ZS1oYW5kbGU9Im1haW5TY3JvbGwiPgogKiAgICAgPGJ1dHRvbiBuZy1jbGljaz0ic2Nyb2xsTWFpblRvVG9wKCkiPgogKiAgICAgICBTY3JvbGwgY29udGVudCB0byB0b3AhCiAqICAgICA8L2J1dHRvbj4KICogICAgIDxpb24tc2Nyb2xsIGRlbGVnYXRlLWhhbmRsZT0ic21hbGwiIHN0eWxlPSJoZWlnaHQ6IDEwMHB4OyI+CiAqICAgICAgIDxidXR0b24gbmctY2xpY2s9InNjcm9sbFNtYWxsVG9Ub3AoKSI+CiAqICAgICAgICAgU2Nyb2xsIHNtYWxsIGFyZWEgdG8gdG9wIQogKiAgICAgICA8L2J1dHRvbj4KICogICAgIDwvaW9uLXNjcm9sbD4KICogICA8L2lvbi1jb250ZW50PgogKiA8L2JvZHk+CiAqIGBgYAogKiBgYGBqcwogKiBmdW5jdGlvbiBNYWluQ3RybCgkc2NvcGUsICRpb25pY1Njcm9sbERlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNjcm9sbE1haW5Ub1RvcCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdtYWluU2Nyb2xsJykuc2Nyb2xsVG9wKCk7CiAqICAgfTsKICogICAkc2NvcGUuc2Nyb2xsU21hbGxUb1RvcCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdzbWFsbCcpLnNjcm9sbFRvcCgpOwogKiAgIH07CiAqIH0KICogYGBgCiAqLwpJb25pY01vZHVsZQouc2VydmljZSgnJGlvbmljU2Nyb2xsRGVsZWdhdGUnLCBkZWxlZ2F0ZVNlcnZpY2UoWwogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNyZXNpemUKICAgKiBAZGVzY3JpcHRpb24gVGVsbCB0aGUgc2Nyb2xsVmlldyB0byByZWNhbGN1bGF0ZSB0aGUgc2l6ZSBvZiBpdHMgY29udGFpbmVyLgogICAqLwogICdyZXNpemUnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNzY3JvbGxUb3AKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRBbmltYXRlIFdoZXRoZXIgdGhlIHNjcm9sbCBzaG91bGQgYW5pbWF0ZS4KICAgKi8KICAnc2Nyb2xsVG9wJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsQm90dG9tCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkQW5pbWF0ZSBXaGV0aGVyIHRoZSBzY3JvbGwgc2hvdWxkIGFuaW1hdGUuCiAgICovCiAgJ3Njcm9sbEJvdHRvbScsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3Njcm9sbFRvCiAgICogQHBhcmFtIHtudW1iZXJ9IGxlZnQgVGhlIHgtdmFsdWUgdG8gc2Nyb2xsIHRvLgogICAqIEBwYXJhbSB7bnVtYmVyfSB0b3AgVGhlIHktdmFsdWUgdG8gc2Nyb2xsIHRvLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0aGUgc2Nyb2xsIHNob3VsZCBhbmltYXRlLgogICAqLwogICdzY3JvbGxUbycsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3Njcm9sbEJ5CiAgICogQHBhcmFtIHtudW1iZXJ9IGxlZnQgVGhlIHgtb2Zmc2V0IHRvIHNjcm9sbCBieS4KICAgKiBAcGFyYW0ge251bWJlcn0gdG9wIFRoZSB5LW9mZnNldCB0byBzY3JvbGwgYnkuCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkQW5pbWF0ZSBXaGV0aGVyIHRoZSBzY3JvbGwgc2hvdWxkIGFuaW1hdGUuCiAgICovCiAgJ3Njcm9sbEJ5JywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjem9vbVRvCiAgICogQHBhcmFtIHtudW1iZXJ9IGxldmVsIExldmVsIHRvIHpvb20gdG8uCiAgICogQHBhcmFtIHtib29sZWFuPX0gYW5pbWF0ZSBXaGV0aGVyIHRvIGFuaW1hdGUgdGhlIHpvb20uCiAgICogQHBhcmFtIHtudW1iZXI9fSBvcmlnaW5MZWZ0IFpvb20gaW4gYXQgZ2l2ZW4gbGVmdCBjb29yZGluYXRlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gb3JpZ2luVG9wIFpvb20gaW4gYXQgZ2l2ZW4gdG9wIGNvb3JkaW5hdGUuCiAgICovCiAgJ3pvb21UbycsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3pvb21CeQogICAqIEBwYXJhbSB7bnVtYmVyfSBmYWN0b3IgVGhlIGZhY3RvciB0byB6b29tIGJ5LgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IGFuaW1hdGUgV2hldGhlciB0byBhbmltYXRlIHRoZSB6b29tLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gb3JpZ2luTGVmdCBab29tIGluIGF0IGdpdmVuIGxlZnQgY29vcmRpbmF0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG9yaWdpblRvcCBab29tIGluIGF0IGdpdmVuIHRvcCBjb29yZGluYXRlLgogICAqLwogICd6b29tQnknLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNnZXRTY3JvbGxQb3NpdGlvbgogICAqIEByZXR1cm5zIHtvYmplY3R9IFRoZSBzY3JvbGwgcG9zaXRpb24gb2YgdGhpcyB2aWV3LCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgKiAgLSBge251bWJlcn1gIGBsZWZ0YCBUaGUgZGlzdGFuY2UgdGhlIHVzZXIgaGFzIHNjcm9sbGVkIGZyb20gdGhlIGxlZnQgKHN0YXJ0cyBhdCAwKS4KICAgKiAgLSBge251bWJlcn1gIGB0b3BgIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBoYXMgc2Nyb2xsZWQgZnJvbSB0aGUgdG9wIChzdGFydHMgYXQgMCkuCiAgICovCiAgJ2dldFNjcm9sbFBvc2l0aW9uJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjYW5jaG9yU2Nyb2xsCiAgICogQGRlc2NyaXB0aW9uIFRlbGwgdGhlIHNjcm9sbFZpZXcgdG8gc2Nyb2xsIHRvIHRoZSBlbGVtZW50IHdpdGggYW4gaWQKICAgKiBtYXRjaGluZyB3aW5kb3cubG9jYXRpb24uaGFzaC4KICAgKgogICAqIElmIG5vIG1hdGNoaW5nIGVsZW1lbnQgaXMgZm91bmQsIGl0IHdpbGwgc2Nyb2xsIHRvIHRvcC4KICAgKgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0aGUgc2Nyb2xsIHNob3VsZCBhbmltYXRlLgogICAqLwogICdhbmNob3JTY3JvbGwnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNnZXRTY3JvbGxWaWV3CiAgICogQHJldHVybnMge29iamVjdH0gVGhlIHNjcm9sbFZpZXcgYXNzb2NpYXRlZCB3aXRoIHRoaXMgZGVsZWdhdGUuCiAgICovCiAgJ2dldFNjcm9sbFZpZXcnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNyZW1lbWJlclNjcm9sbFBvc2l0aW9uCiAgICogQGRlc2NyaXB0aW9uCiAgICogV2lsbCBtYWtlIGl0IHNvLCB3aGVuIHRoaXMgc2Nyb2xsVmlldyBpcyBkZXN0cm95ZWQgKHVzZXIgbGVhdmVzIHRoZSBwYWdlKSwKICAgKiB0aGUgbGFzdCBzY3JvbGwgcG9zaXRpb24gdGhlIHBhZ2Ugd2FzIG9uIHdpbGwgYmUgc2F2ZWQsIGluZGV4ZWQgYnkgdGhlCiAgICogZ2l2ZW4gaWQuCiAgICoKICAgKiBOb3RlOiBmb3IgcGFnZXMgYXNzb2NpYXRlZCB3aXRoIGEgdmlldyB1bmRlciBhbiBpb24tbmF2LXZpZXcsCiAgICogcmVtZW1iZXJTY3JvbGxQb3NpdGlvbiBhdXRvbWF0aWNhbGx5IHNhdmVzIHRoZWlyIHNjcm9sbC4KICAgKgogICAqIFJlbGF0ZWQgbWV0aG9kczogc2Nyb2xsVG9SZW1lbWJlcmVkUG9zaXRpb24sIGZvcmdldFNjcm9sbFBvc2l0aW9uIChiZWxvdykuCiAgICoKICAgKiBJbiB0aGUgZm9sbG93aW5nIGV4YW1wbGUsIHRoZSBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIGlvbi1zY3JvbGwgZWxlbWVudAogICAqIHdpbGwgcGVyc2lzdCwgZXZlbiB3aGVuIHRoZSB1c2VyIGNoYW5nZXMgdGhlIHRvZ2dsZSBzd2l0Y2guCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi10b2dnbGUgbmctbW9kZWw9InNob3VsZFNob3dTY3JvbGxWaWV3Ij48L2lvbi10b2dnbGU+CiAgICogPGlvbi1zY3JvbGwgZGVsZWdhdGUtaGFuZGxlPSJteVNjcm9sbCIgbmctaWY9InNob3VsZFNob3dTY3JvbGxWaWV3Ij4KICAgKiAgIDxkaXYgbmctY29udHJvbGxlcj0iU2Nyb2xsQ3RybCI+CiAgICogICAgIDxpb24tbGlzdD4KICAgKiAgICAgICB7JSByYXcgJX08aW9uLWl0ZW0gbmctcmVwZWF0PSJpIGluIGl0ZW1zIj57e2l9fTwvaW9uLWl0ZW0+eyUgZW5kcmF3ICV9CiAgICogICAgIDwvaW9uLWxpc3Q+CiAgICogICA8L2Rpdj4KICAgKiA8L2lvbi1zY3JvbGw+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBTY3JvbGxDdHJsKCRzY29wZSwgJGlvbmljU2Nyb2xsRGVsZWdhdGUpIHsKICAgKiAgIHZhciBkZWxlZ2F0ZSA9ICRpb25pY1Njcm9sbERlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXlTY3JvbGwnKTsKICAgKgogICAqICAgLy8gUHV0IGFueSB1bmlxdWUgSUQgaGVyZS4gIFRoZSBwb2ludCBvZiB0aGlzIGlzOiBldmVyeSB0aW1lIHRoZSBjb250cm9sbGVyIGlzIHJlY3JlYXRlZAogICAqICAgLy8gd2Ugd2FudCB0byBsb2FkIHRoZSBjb3JyZWN0IHJlbWVtYmVyZWQgc2Nyb2xsIHZhbHVlcy4KICAgKiAgIGRlbGVnYXRlLnJlbWVtYmVyU2Nyb2xsUG9zaXRpb24oJ215LXNjcm9sbC1pZCcpOwogICAqICAgZGVsZWdhdGUuc2Nyb2xsVG9SZW1lbWJlcmVkUG9zaXRpb24oKTsKICAgKiAgICRzY29wZS5pdGVtcyA9IFtdOwogICAqICAgZm9yICh2YXIgaT0wOyBpPDEwMDsgaSsrKSB7CiAgICogICAgICRzY29wZS5pdGVtcy5wdXNoKGkpOwogICAqICAgfQogICAqIH0KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBpZCBUaGUgaWQgdG8gcmVtZW1iZXIgdGhlIHNjcm9sbCBwb3NpdGlvbiBvZiB0aGlzCiAgICogc2Nyb2xsVmlldyBieS4KICAgKi8KICAncmVtZW1iZXJTY3JvbGxQb3NpdGlvbicsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI2ZvcmdldFNjcm9sbFBvc2l0aW9uCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3RvcCByZW1lbWJlcmluZyB0aGUgc2Nyb2xsIHBvc2l0aW9uIGZvciB0aGlzIHNjcm9sbFZpZXcuCiAgICovCiAgJ2ZvcmdldFNjcm9sbFBvc2l0aW9uJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsVG9SZW1lbWJlcmVkUG9zaXRpb24KICAgKiBAZGVzY3JpcHRpb24KICAgKiBJZiB0aGlzIHNjcm9sbFZpZXcgaGFzIGFuIGlkIGFzc29jaWF0ZWQgd2l0aCBpdHMgc2Nyb2xsIHBvc2l0aW9uLAogICAqICh0aHJvdWdoIGNhbGxpbmcgcmVtZW1iZXJTY3JvbGxQb3NpdGlvbiksIGFuZCB0aGF0IHBvc2l0aW9uIGlzIHJlbWVtYmVyZWQsCiAgICogbG9hZCB0aGUgcG9zaXRpb24gYW5kIHNjcm9sbCB0byBpdC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRBbmltYXRlIFdoZXRoZXIgdG8gYW5pbWF0ZSB0aGUgc2Nyb2xsLgogICAqLwogICdzY3JvbGxUb1JlbWVtYmVyZWRQb3NpdGlvbicKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjJGdldEJ5SGFuZGxlCiAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAqIEByZXR1cm5zIGBkZWxlZ2F0ZUluc3RhbmNlYCBBIGRlbGVnYXRlIGluc3RhbmNlIHRoYXQgY29udHJvbHMgb25seSB0aGUKICAgKiBzY3JvbGxWaWV3cyB3aXRoIGBkZWxlZ2F0ZS1oYW5kbGVgIG1hdGNoaW5nIHRoZSBnaXZlbiBoYW5kbGUuCiAgICoKICAgKiBFeGFtcGxlOiBgJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteS1oYW5kbGUnKS5zY3JvbGxUb3AoKTtgCiAgICovCl0pKTsKCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZQogKiBAbW9kdWxlIGlvbmljCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZWxlZ2F0ZSBmb3IgY29udHJvbGxpbmcgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVzfSBkaXJlY3RpdmUuCiAqCiAqIE1ldGhvZHMgY2FsbGVkIGRpcmVjdGx5IG9uIHRoZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlIHNlcnZpY2Ugd2lsbCBjb250cm9sIGFsbCBzaWRlCiAqIG1lbnVzLiAgVXNlIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTaWRlTWVudURlbGVnYXRlIyRnZXRCeUhhbmRsZSAkZ2V0QnlIYW5kbGV9CiAqIG1ldGhvZCB0byBjb250cm9sIHNwZWNpZmljIGlvblNpZGVNZW51cyBpbnN0YW5jZXMuCiAqCiAqIEB1c2FnZQogKgogKiBgYGBodG1sCiAqIDxib2R5IG5nLWNvbnRyb2xsZXI9Ik1haW5DdHJsIj4KICogICA8aW9uLXNpZGUtbWVudXM+CiAqICAgICA8aW9uLXNpZGUtbWVudS1jb250ZW50PgogKiAgICAgICBDb250ZW50IQogKiAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ0b2dnbGVMZWZ0U2lkZU1lbnUoKSI+CiAqICAgICAgICAgVG9nZ2xlIExlZnQgU2lkZSBNZW51CiAqICAgICAgIDwvYnV0dG9uPgogKiAgICAgPC9pb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAqICAgICA8aW9uLXNpZGUtbWVudSBzaWRlPSJsZWZ0Ij4KICogICAgICAgTGVmdCBNZW51IQogKiAgICAgPGlvbi1zaWRlLW1lbnU+CiAqICAgPC9pb24tc2lkZS1tZW51cz4KICogPC9ib2R5PgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gTWFpbkN0cmwoJHNjb3BlLCAkaW9uaWNTaWRlTWVudURlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnRvZ2dsZUxlZnRTaWRlTWVudSA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZS50b2dnbGVMZWZ0KCk7CiAqICAgfTsKICogfQogKiBgYGAKICovCklvbmljTW9kdWxlCi5zZXJ2aWNlKCckaW9uaWNTaWRlTWVudURlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSN0b2dnbGVMZWZ0CiAgICogQGRlc2NyaXB0aW9uIFRvZ2dsZSB0aGUgbGVmdCBzaWRlIG1lbnUgKGlmIGl0IGV4aXN0cykuCiAgICogQHBhcmFtIHtib29sZWFuPX0gaXNPcGVuIFdoZXRoZXIgdG8gb3BlbiBvciBjbG9zZSB0aGUgbWVudS4KICAgKiBEZWZhdWx0OiBUb2dnbGVzIHRoZSBtZW51LgogICAqLwogICd0b2dnbGVMZWZ0JywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSN0b2dnbGVSaWdodAogICAqIEBkZXNjcmlwdGlvbiBUb2dnbGUgdGhlIHJpZ2h0IHNpZGUgbWVudSAoaWYgaXQgZXhpc3RzKS4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBpc09wZW4gV2hldGhlciB0byBvcGVuIG9yIGNsb3NlIHRoZSBtZW51LgogICAqIERlZmF1bHQ6IFRvZ2dsZXMgdGhlIG1lbnUuCiAgICovCiAgJ3RvZ2dsZVJpZ2h0JywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNnZXRPcGVuUmF0aW8KICAgKiBAZGVzY3JpcHRpb24gR2V0cyB0aGUgcmF0aW8gb2Ygb3BlbiBhbW91bnQgb3ZlciBtZW51IHdpZHRoLiBGb3IgZXhhbXBsZSwgYQogICAqIG1lbnUgb2Ygd2lkdGggMTAwIHRoYXQgaXMgb3BlbmVkIGJ5IDUwIHBpeGVscyBpcyA1MCUgb3BlbmVkLCBhbmQgd291bGQgcmV0dXJuCiAgICogYSByYXRpbyBvZiAwLjUuCiAgICoKICAgKiBAcmV0dXJucyB7ZmxvYXR9IDAgaWYgbm90aGluZyBpcyBvcGVuLCBiZXR3ZWVuIDAgYW5kIDEgaWYgbGVmdCBtZW51IGlzCiAgICogb3BlbmVkL29wZW5pbmcsIGFuZCBiZXR3ZWVuIDAgYW5kIC0xIGlmIHJpZ2h0IG1lbnUgaXMgb3BlbmVkL29wZW5pbmcuCiAgICovCiAgJ2dldE9wZW5SYXRpbycsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NpZGVNZW51RGVsZWdhdGUjaXNPcGVuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgZWl0aGVyIHRoZSBsZWZ0IG9yIHJpZ2h0IG1lbnUgaXMgY3VycmVudGx5IG9wZW5lZC4KICAgKi8KICAnaXNPcGVuJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNpc09wZW5MZWZ0CiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGxlZnQgbWVudSBpcyBjdXJyZW50bHkgb3BlbmVkLgogICAqLwogICdpc09wZW5MZWZ0JywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNpc09wZW5SaWdodAogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByaWdodCBtZW51IGlzIGN1cnJlbnRseSBvcGVuZWQuCiAgICovCiAgJ2lzT3BlblJpZ2h0JywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNjYW5EcmFnQ29udGVudAogICAqIEBwYXJhbSB7Ym9vbGVhbj19IGNhbkRyYWcgU2V0IHdoZXRoZXIgdGhlIGNvbnRlbnQgY2FuIG9yIGNhbm5vdCBiZSBkcmFnZ2VkIHRvIG9wZW4KICAgKiBzaWRlIG1lbnVzLgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBjb250ZW50IGNhbiBiZSBkcmFnZ2VkIHRvIG9wZW4gc2lkZSBtZW51cy4KICAgKi8KICAnY2FuRHJhZ0NvbnRlbnQnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2VkZ2VEcmFnVGhyZXNob2xkCiAgICogQHBhcmFtIHtib29sZWFufG51bWJlcj19IHZhbHVlIFNldCB3aGV0aGVyIHRoZSBjb250ZW50IGRyYWcgY2FuIG9ubHkgc3RhcnQgaWYgaXQgaXMgYmVsb3cgYSBjZXJ0YWluIHRocmVzaG9sZCBkaXN0YW5jZSBmcm9tIHRoZSBlZGdlIG9mIHRoZSBzY3JlZW4uIEFjY2VwdHMgdGhyZWUgZGlmZmVyZW50IHZhbHVlczoKICAgKiAgLSBJZiBhIG5vbi16ZXJvIG51bWJlciBpcyBnaXZlbiwgdGhhdCBtYW55IHBpeGVscyBpcyB1c2VkIGFzIHRoZSBtYXhpbXVtIGFsbG93ZWQgZGlzdGFuY2UgZnJvbSB0aGUgZWRnZSB0aGF0IHN0YXJ0cyBkcmFnZ2luZyB0aGUgc2lkZSBtZW51LgogICAqICAtIElmIHRydWUgaXMgZ2l2ZW4sIHRoZSBkZWZhdWx0IG51bWJlciBvZiBwaXhlbHMgKDI1KSBpcyB1c2VkIGFzIHRoZSBtYXhpbXVtIGFsbG93ZWQgZGlzdGFuY2UuCiAgICogIC0gSWYgZmFsc2Ugb3IgMCBpcyBnaXZlbiwgdGhlIGVkZ2UgZHJhZyB0aHJlc2hvbGQgaXMgZGlzYWJsZWQsIGFuZCBkcmFnZ2luZyBmcm9tIGFueXdoZXJlIG9uIHRoZSBjb250ZW50IGlzIGFsbG93ZWQuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGRyYWcgY2FuIHN0YXJ0IG9ubHkgZnJvbSB3aXRoaW4gdGhlIGVkZ2Ugb2Ygc2NyZWVuIHRocmVzaG9sZC4KICAgKi8KICAnZWRnZURyYWdUaHJlc2hvbGQnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAqIEBwYXJhbSB7c3RyaW5nfSBoYW5kbGUKICAgKiBAcmV0dXJucyBgZGVsZWdhdGVJbnN0YW5jZWAgQSBkZWxlZ2F0ZSBpbnN0YW5jZSB0aGF0IGNvbnRyb2xzIG9ubHkgdGhlCiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXN9IGRpcmVjdGl2ZXMgd2l0aCBgZGVsZWdhdGUtaGFuZGxlYCBtYXRjaGluZwogICAqIHRoZSBnaXZlbiBoYW5kbGUuCiAgICoKICAgKiBFeGFtcGxlOiBgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215LWhhbmRsZScpLnRvZ2dsZUxlZnQoKTtgCiAgICovCl0pKTsKCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZQogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKiBEZWxlZ2F0ZSB0aGF0IGNvbnRyb2xzIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNsaWRlQm94fSBkaXJlY3RpdmUuCiAqCiAqIE1ldGhvZHMgY2FsbGVkIGRpcmVjdGx5IG9uIHRoZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlIHNlcnZpY2Ugd2lsbCBjb250cm9sIGFsbCBzbGlkZSBib3hlcy4gIFVzZSB0aGUge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUgJGdldEJ5SGFuZGxlfQogKiBtZXRob2QgdG8gY29udHJvbCBzcGVjaWZpYyBzbGlkZSBib3ggaW5zdGFuY2VzLgogKgogKiBAdXNhZ2UKICoKICogYGBgaHRtbAogKiA8Ym9keSBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogKiAgIDxpb24tc2xpZGUtYm94PgogKiAgICAgPGlvbi1zbGlkZT4KICogICAgICAgPGRpdiBjbGFzcz0iYm94IGJsdWUiPgogKiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9Im5leHRTbGlkZSgpIj5OZXh0IHNsaWRlITwvYnV0dG9uPgogKiAgICAgICA8L2Rpdj4KICogICAgIDwvaW9uLXNsaWRlPgogKiAgICAgPGlvbi1zbGlkZT4KICogICAgICAgPGRpdiBjbGFzcz0iYm94IHJlZCI+CiAqICAgICAgICAgU2xpZGUgMiEKICogICAgICAgPC9kaXY+CiAqICAgICA8L2lvbi1zbGlkZT4KICogICA8L2lvbi1zbGlkZS1ib3g+CiAqIDwvYm9keT4KICogYGBgCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIE15Q3RybCgkc2NvcGUsICRpb25pY1NsaWRlQm94RGVsZWdhdGUpIHsKICogICAkc2NvcGUubmV4dFNsaWRlID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTbGlkZUJveERlbGVnYXRlLm5leHQoKTsKICogICB9CiAqIH0KICogYGBgCiAqLwpJb25pY01vZHVsZQouc2VydmljZSgnJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZScsIGRlbGVnYXRlU2VydmljZShbCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjdXBkYXRlCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXBkYXRlIHRoZSBzbGlkZWJveCAoZm9yIGV4YW1wbGUgaWYgdXNpbmcgQW5ndWxhciB3aXRoIG5nLXJlcGVhdCwKICAgKiByZXNpemUgaXQgZm9yIHRoZSBlbGVtZW50cyBpbnNpZGUpLgogICAqLwogICd1cGRhdGUnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI3NsaWRlCiAgICogQHBhcmFtIHtudW1iZXJ9IHRvIFRoZSBpbmRleCB0byBzbGlkZSB0by4KICAgKiBAcGFyYW0ge251bWJlcj19IHNwZWVkIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGZvciB0aGUgY2hhbmdlIHRvIHRha2UuCiAgICovCiAgJ3NsaWRlJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNlbmFibGVTbGlkZQogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEVuYWJsZSBXaGV0aGVyIHRvIGVuYWJsZSBzbGlkaW5nIHRoZSBzbGlkZWJveC4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciBzbGlkaW5nIGlzIGVuYWJsZWQuCiAgICovCiAgJ2VuYWJsZVNsaWRlJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNwcmV2aW91cwogICAqIEBkZXNjcmlwdGlvbiBHbyB0byB0aGUgcHJldmlvdXMgc2xpZGUuIFdyYXBzIGFyb3VuZCBpZiBhdCB0aGUgYmVnaW5uaW5nLgogICAqLwogICdwcmV2aW91cycsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjbmV4dAogICAqIEBkZXNjcmlwdGlvbiBHbyB0byB0aGUgbmV4dCBzbGlkZS4gV3JhcHMgYXJvdW5kIGlmIGF0IHRoZSBlbmQuCiAgICovCiAgJ25leHQnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI3N0b3AKICAgKiBAZGVzY3JpcHRpb24gU3RvcCBzbGlkaW5nLiBUaGUgc2xpZGVCb3ggd2lsbCBub3QgbW92ZSBhZ2FpbiB1bnRpbAogICAqIGV4cGxpY2l0bHkgdG9sZCB0byBkbyBzby4KICAgKi8KICAnc3RvcCcsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjc3RhcnQKICAgKiBAZGVzY3JpcHRpb24gU3RhcnQgc2xpZGluZyBhZ2FpbiBpZiB0aGUgc2xpZGVCb3ggd2FzIHN0b3BwZWQuIAogICAqLwogICdzdGFydCcsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjY3VycmVudEluZGV4CiAgICogQHJldHVybnMgbnVtYmVyIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBzbGlkZS4KICAgKi8KICAnY3VycmVudEluZGV4JywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNzbGlkZXNDb3VudAogICAqIEByZXR1cm5zIG51bWJlciBUaGUgbnVtYmVyIG9mIHNsaWRlcyB0aGVyZSBhcmUgY3VycmVudGx5LgogICAqLwogICdzbGlkZXNDb3VudCcKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUKICAgKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlCiAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2xpZGVCb3h9IGRpcmVjdGl2ZXMgd2l0aCBgZGVsZWdhdGUtaGFuZGxlYCBtYXRjaGluZwogICAqIHRoZSBnaXZlbiBoYW5kbGUuCiAgICoKICAgKiBFeGFtcGxlOiBgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215LWhhbmRsZScpLnN0b3AoKTtgCiAgICovCl0pKTsKCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljVGFic0RlbGVnYXRlCiAqIEBtb2R1bGUgaW9uaWMKICoKICogQGRlc2NyaXB0aW9uCiAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25UYWJzfSBkaXJlY3RpdmUuCiAqCiAqIE1ldGhvZHMgY2FsbGVkIGRpcmVjdGx5IG9uIHRoZSAkaW9uaWNUYWJzRGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIGlvblRhYnMKICogZGlyZWN0aXZlcy4gVXNlIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNUYWJzRGVsZWdhdGUjJGdldEJ5SGFuZGxlICRnZXRCeUhhbmRsZX0KICogbWV0aG9kIHRvIGNvbnRyb2wgc3BlY2lmaWMgaW9uVGFicyBpbnN0YW5jZXMuCiAqCiAqIEB1c2FnZQogKgogKiBgYGBodG1sCiAqIDxib2R5IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAqICAgPGlvbi10YWJzPgogKgogKiAgICAgPGlvbi10YWIgdGl0bGU9IlRhYiAxIj4KICogICAgICAgSGVsbG8gdGFiIDEhCiAqICAgICAgIDxidXR0b24gbmctY2xpY2s9InNlbGVjdFRhYldpdGhJbmRleCgxKSI+U2VsZWN0IHRhYiAyITwvYnV0dG9uPgogKiAgICAgPC9pb24tdGFiPgogKiAgICAgPGlvbi10YWIgdGl0bGU9IlRhYiAyIj5IZWxsbyB0YWIgMiE8L2lvbi10YWI+CiAqCiAqICAgPC9pb24tdGFicz4KICogPC9ib2R5PgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljVGFic0RlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNlbGVjdFRhYldpdGhJbmRleCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAqICAgICAkaW9uaWNUYWJzRGVsZWdhdGUuc2VsZWN0KGluZGV4KTsKICogICB9CiAqIH0KICogYGBgCiAqLwpJb25pY01vZHVsZQouc2VydmljZSgnJGlvbmljVGFic0RlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljVGFic0RlbGVnYXRlI3NlbGVjdAogICAqIEBkZXNjcmlwdGlvbiBTZWxlY3QgdGhlIHRhYiBtYXRjaGluZyB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggSW5kZXggb2YgdGhlIHRhYiB0byBzZWxlY3QuCiAgICovCiAgJ3NlbGVjdCcsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1RhYnNEZWxlZ2F0ZSNzZWxlY3RlZEluZGV4CiAgICogQHJldHVybnMgYG51bWJlcmAgVGhlIGluZGV4IG9mIHRoZSBzZWxlY3RlZCB0YWIsIG9yIC0xLgogICAqLwogICdzZWxlY3RlZEluZGV4JwogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNUYWJzRGVsZWdhdGUjJGdldEJ5SGFuZGxlCiAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAqIEByZXR1cm5zIGBkZWxlZ2F0ZUluc3RhbmNlYCBBIGRlbGVnYXRlIGluc3RhbmNlIHRoYXQgY29udHJvbHMgb25seSB0aGUKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblRhYnN9IGRpcmVjdGl2ZXMgd2l0aCBgZGVsZWdhdGUtaGFuZGxlYCBtYXRjaGluZwogICAqIHRoZSBnaXZlbiBoYW5kbGUuCiAgICoKICAgKiBFeGFtcGxlOiBgJGlvbmljVGFic0RlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXktaGFuZGxlJykuc2VsZWN0KDApO2AKICAgKi8KXSkpOwoKCi8vIGNsb3N1cmUgdG8ga2VlcCB0aGluZ3MgbmVhdAooZnVuY3Rpb24oKSB7CiAgdmFyIHRlbXBsYXRlc1RvQ2FjaGUgPSBbXTsKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNUZW1wbGF0ZUNhY2hlCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uIEEgc2VydmljZSB0aGF0IHByZWVtcHRpdmVseSBjYWNoZXMgdGVtcGxhdGUgZmlsZXMgdG8gZWxpbWluYXRlIHRyYW5zaXRpb24gZmxpY2tlciBhbmQgYm9vc3QgcGVyZm9ybWFuY2UuCiAqIEB1c2FnZQogKiBTdGF0ZSB0ZW1wbGF0ZXMgYXJlIGNhY2hlZCBhdXRvbWF0aWNhbGx5LCBidXQgeW91IGNhbiBvcHRpb25hbGx5IGNhY2hlIG90aGVyIHRlbXBsYXRlcy4KICoKICogYGBganMKICogJGlvbmljVGVtcGxhdGVDYWNoZSgnbXlOZ0luY2x1ZGVUZW1wbGF0ZS5odG1sJyk7CiAqIGBgYAogKgogKiBPcHRpb25hbGx5IGRpc2FibGUgYWxsIHByZWVtcHRpdmUgY2FjaGluZyB3aXRoIHRoZSBgJGlvbmljQ29uZmlnUHJvdmlkZXJgIG9yIGluZGl2aWR1YWwgc3RhdGVzIGJ5IHNldHRpbmcgYHByZWZldGNoVGVtcGxhdGVgCiAqIGluIHRoZSBgJHN0YXRlYCBkZWZpbml0aW9uCiAqCiAqIGBgYGpzCiAqICAgYW5ndWxhci5tb2R1bGUoJ215QXBwJywgWydpb25pYyddKQogKiAgIC5jb25maWcoZnVuY3Rpb24oJHN0YXRlUHJvdmlkZXIsICRpb25pY0NvbmZpZ1Byb3ZpZGVyKSB7CiAqCiAqICAgICAvLyBkaXNhYmxlIHByZWVtcHRpdmUgdGVtcGxhdGUgY2FjaGluZyBnbG9iYWxseQogKiAgICAgJGlvbmljQ29uZmlnUHJvdmlkZXIucHJlZmV0Y2hUZW1wbGF0ZXMoZmFsc2UpOwogKgogKiAgICAgLy8gZGlzYWJsZSBpbmRpdmlkdWFsIHN0YXRlcwogKiAgICAgJHN0YXRlUHJvdmlkZXIKICogICAgICAgLnN0YXRlKCd0YWJzJywgewogKiAgICAgICAgIHVybDogIi90YWIiLAogKiAgICAgICAgIGFic3RyYWN0OiB0cnVlLAogKiAgICAgICAgIHByZWZldGNoVGVtcGxhdGU6IGZhbHNlLAogKiAgICAgICAgIHRlbXBsYXRlVXJsOiAidGFicy10ZW1wbGF0ZXMvdGFicy5odG1sIgogKiAgICAgICB9KQogKiAgICAgICAuc3RhdGUoJ3RhYnMuaG9tZScsIHsKICogICAgICAgICB1cmw6ICIvaG9tZSIsCiAqICAgICAgICAgdmlld3M6IHsKICogICAgICAgICAgICdob21lLXRhYic6IHsKICogICAgICAgICAgICAgcHJlZmV0Y2hUZW1wbGF0ZTogZmFsc2UsCiAqICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAidGFicy10ZW1wbGF0ZXMvaG9tZS5odG1sIiwKICogICAgICAgICAgICAgY29udHJvbGxlcjogJ0hvbWVUYWJDdHJsJwogKiAgICAgICAgICAgfQogKiAgICAgICAgIH0KICogICAgICAgfSk7CiAqICAgfSk7CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY1RlbXBsYXRlQ2FjaGUnLCBbCickaHR0cCcsCickdGVtcGxhdGVDYWNoZScsCickdGltZW91dCcsCickaW9uaWNDb25maWcnLApmdW5jdGlvbigkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICR0aW1lb3V0LCAkaW9uaWNDb25maWcpIHsKICB2YXIgdG9DYWNoZSA9IHRlbXBsYXRlc1RvQ2FjaGUsCiAgICAgIGhhc1J1biA9IGZhbHNlOwoKICBmdW5jdGlvbiAkaW9uaWNUZW1wbGF0ZUNhY2hlKHRlbXBsYXRlcyl7CiAgICBpZih0b0NhY2hlLmxlbmd0aCA+IDUwMCkgcmV0dXJuIGZhbHNlOwogICAgaWYodHlwZW9mIHRlbXBsYXRlcyA9PT0gJ3VuZGVmaW5lZCcpcmV0dXJuIHJ1bigpOwogICAgaWYoaXNTdHJpbmcodGVtcGxhdGVzKSl0ZW1wbGF0ZXMgPSBbdGVtcGxhdGVzXTsKICAgIGZvckVhY2godGVtcGxhdGVzLCBmdW5jdGlvbih0ZW1wbGF0ZSl7CiAgICAgIHRvQ2FjaGUucHVzaCh0ZW1wbGF0ZSk7CiAgICB9KTsKICAgIC8vIGlzIHRoaXMgaXMgYmVpbmcgY2FsbGVkIGFmdGVyIHRoZSBpbml0aWFsIElvbmljTW9kdWxlLnJ1bigpCiAgICBpZihoYXNSdW4pIHJ1bigpOwogIH0KCiAgLy8gcnVuIHRocm91Z2ggbWV0aG9kcyAtIGludGVybmFsIG1ldGhvZAogIHZhciBydW4gPSBmdW5jdGlvbigpewogICAgaWYoJGlvbmljQ29uZmlnLnByZWZldGNoVGVtcGxhdGVzID09PSBmYWxzZSlyZXR1cm47CiAgICAvL2NvbnNvbGUubG9nKCdwcmVmZXRjaGluZycsIHRvQ2FjaGUpOwogICAgLy9mb3IgdGVzdGluZwogICAgJGlvbmljVGVtcGxhdGVDYWNoZS5fcnVuQ291bnQrKzsKCiAgICBoYXNSdW4gPSB0cnVlOwogICAgLy8gaWdub3JlIGlmIHJhY2UgY29uZGl0aW9uIGFscmVhZHkgemVyb2VkIG91dCBhcnJheQogICAgaWYodG9DYWNoZS5sZW5ndGggPT09IDApcmV0dXJuOwogICAgLy9jb25zb2xlLmxvZyh0b0NhY2hlKTsKICAgIHZhciBpID0gMDsKICAgIHdoaWxlICggaSA8IDUgJiYgKHRlbXBsYXRlID0gdG9DYWNoZS5wb3AoKSkgKSB7CiAgICAgIC8vIG5vdGUgdGhhdCBpbmxpbmUgdGVtcGxhdGVzIGFyZSBpZ25vcmVkIGJ5IHRoaXMgcmVxdWVzdAogICAgICBpZiAoaXNTdHJpbmcodGVtcGxhdGUpKSAkaHR0cC5nZXQodGVtcGxhdGUsIHsgY2FjaGU6ICR0ZW1wbGF0ZUNhY2hlIH0pOwogICAgICBpKys7CiAgICB9CiAgICAvLyBvbmx5IHByZWxvYWQgNSB0ZW1wbGF0ZXMgYSBzZWNvbmQKICAgIGlmKHRvQ2FjaGUubGVuZ3RoKSR0aW1lb3V0KGZ1bmN0aW9uKCl7cnVuKCk7fSwgMTAwMCk7CiAgfTsKCiAgLy8gZXhwb3NpbmcgZm9yIHRlc3RpbmcKICAkaW9uaWNUZW1wbGF0ZUNhY2hlLl9ydW5Db3VudCA9IDA7CiAgLy8gZGVmYXVsdCBtZXRob2QKICByZXR1cm4gJGlvbmljVGVtcGxhdGVDYWNoZTsKfV0pCgovLyBJbnRlcmNlcHRzIHRoZSAkc3RhdGVwcm92aWRlci5zdGF0ZSgpIGNvbW1hbmQgdG8gbG9vayBmb3IgdGVtcGxhdGVVcmxzIHRoYXQgY2FuIGJlIGNhY2hlZAouY29uZmlnKFsKJyRzdGF0ZVByb3ZpZGVyJywKJyRpb25pY0NvbmZpZ1Byb3ZpZGVyJywKZnVuY3Rpb24oJHN0YXRlUHJvdmlkZXIsICRpb25pY0NvbmZpZ1Byb3ZpZGVyKSB7CiAgdmFyIHN0YXRlUHJvdmlkZXJTdGF0ZSA9ICRzdGF0ZVByb3ZpZGVyLnN0YXRlOwogICRzdGF0ZVByb3ZpZGVyLnN0YXRlID0gZnVuY3Rpb24oc3RhdGVOYW1lLCBkZWZpbml0aW9uKSB7CiAgICAvLyBkb24ndCBldmVuIGJvdGhlciBpZiBpdCdzIGRpc2FibGVkLiBub3RlLCBhbm90aGVyIGNvbmZpZyBtYXkgcnVuIGFmdGVyIHRoaXMsIHNvIGl0J3Mgbm90IGEgY2F0Y2gtYWxsCiAgICBpZigkaW9uaWNDb25maWdQcm92aWRlci5wcmVmZXRjaFRlbXBsYXRlcygpICE9PSBmYWxzZSl7CiAgICAgIHZhciBlbmFibGVkID0gZGVmaW5pdGlvbi5wcmVmZXRjaFRlbXBsYXRlICE9PSBmYWxzZTsKICAgICAgaWYoZW5hYmxlZCAmJiBpc1N0cmluZyhkZWZpbml0aW9uLnRlbXBsYXRlVXJsKSl0ZW1wbGF0ZXNUb0NhY2hlLnB1c2goZGVmaW5pdGlvbi50ZW1wbGF0ZVVybCk7CiAgICAgIGlmKGFuZ3VsYXIuaXNPYmplY3QoZGVmaW5pdGlvbi52aWV3cykpewogICAgICAgIGZvciAodmFyIGtleSBpbiBkZWZpbml0aW9uLnZpZXdzKXsKICAgICAgICAgIGVuYWJsZWQgPSBkZWZpbml0aW9uLnZpZXdzW2tleV0ucHJlZmV0Y2hUZW1wbGF0ZSAhPT0gZmFsc2U7CiAgICAgICAgICBpZihlbmFibGVkICYmIGlzU3RyaW5nKGRlZmluaXRpb24udmlld3Nba2V5XS50ZW1wbGF0ZVVybCkpIHRlbXBsYXRlc1RvQ2FjaGUucHVzaChkZWZpbml0aW9uLnZpZXdzW2tleV0udGVtcGxhdGVVcmwpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHN0YXRlUHJvdmlkZXJTdGF0ZS5jYWxsKCRzdGF0ZVByb3ZpZGVyLCBzdGF0ZU5hbWUsIGRlZmluaXRpb24pOwogIH07Cn1dKQoKLy8gcHJvY2VzcyB0aGUgdGVtcGxhdGVVcmxzIGNvbGxlY3RlZCBieSB0aGUgJHN0YXRlUHJvdmlkZXIsIGFkZGluZyB0aGVtIHRvIHRoZSBjYWNoZQoucnVuKFsKJyRpb25pY1RlbXBsYXRlQ2FjaGUnLApmdW5jdGlvbigkaW9uaWNUZW1wbGF0ZUNhY2hlKSB7CiAgJGlvbmljVGVtcGxhdGVDYWNoZSgpOwp9XSk7Cgp9KSgpOwoKSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY1RlbXBsYXRlTG9hZGVyJywgWwogICckY29tcGlsZScsCiAgJyRjb250cm9sbGVyJywKICAnJGh0dHAnLAogICckcScsCiAgJyRyb290U2NvcGUnLAogICckdGVtcGxhdGVDYWNoZScsCmZ1bmN0aW9uKCRjb21waWxlLCAkY29udHJvbGxlciwgJGh0dHAsICRxLCAkcm9vdFNjb3BlLCAkdGVtcGxhdGVDYWNoZSkgewoKICByZXR1cm4gewogICAgbG9hZDogZmV0Y2hUZW1wbGF0ZSwKICAgIGNvbXBpbGU6IGxvYWRBbmRDb21waWxlCiAgfTsKCiAgZnVuY3Rpb24gZmV0Y2hUZW1wbGF0ZSh1cmwpIHsKICAgIHJldHVybiAkaHR0cC5nZXQodXJsLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkKICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgIHJldHVybiByZXNwb25zZS5kYXRhICYmIHJlc3BvbnNlLmRhdGEudHJpbSgpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBsb2FkQW5kQ29tcGlsZShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgdGVtcGxhdGU6ICcnLAogICAgICB0ZW1wbGF0ZVVybDogJycsCiAgICAgIHNjb3BlOiBudWxsLAogICAgICBjb250cm9sbGVyOiBudWxsLAogICAgICBsb2NhbHM6IHt9LAogICAgICBhcHBlbmRUbzogbnVsbAogICAgfSwgb3B0aW9ucyB8fCB7fSk7CgogICAgdmFyIHRlbXBsYXRlUHJvbWlzZSA9IG9wdGlvbnMudGVtcGxhdGVVcmwgPwogICAgICB0aGlzLmxvYWQob3B0aW9ucy50ZW1wbGF0ZVVybCkgOgogICAgICAkcS53aGVuKG9wdGlvbnMudGVtcGxhdGUpOwoKICAgIHJldHVybiB0ZW1wbGF0ZVByb21pc2UudGhlbihmdW5jdGlvbih0ZW1wbGF0ZSkgewogICAgICB2YXIgY29udHJvbGxlcjsKICAgICAgdmFyIHNjb3BlID0gb3B0aW9ucy5zY29wZSB8fCAkcm9vdFNjb3BlLiRuZXcoKTsKCiAgICAgIC8vSW5jYXNlIHRlbXBsYXRlIGRvZXNuJ3QgaGF2ZSBqdXN0IG9uZSByb290IGVsZW1lbnQsIGRvIHRoaXMKICAgICAgdmFyIGVsZW1lbnQgPSBqcUxpdGUoJzxkaXY+JykuaHRtbCh0ZW1wbGF0ZSkuY29udGVudHMoKTsKCiAgICAgIGlmIChvcHRpb25zLmNvbnRyb2xsZXIpIHsKICAgICAgICBjb250cm9sbGVyID0gJGNvbnRyb2xsZXIoCiAgICAgICAgICBvcHRpb25zLmNvbnRyb2xsZXIsCiAgICAgICAgICBleHRlbmQob3B0aW9ucy5sb2NhbHMsIHsKICAgICAgICAgICAgJHNjb3BlOiBzY29wZQogICAgICAgICAgfSkKICAgICAgICApOwogICAgICAgIGVsZW1lbnQuY2hpbGRyZW4oKS5kYXRhKCckbmdDb250cm9sbGVyQ29udHJvbGxlcicsIGNvbnRyb2xsZXIpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLmFwcGVuZFRvKSB7CiAgICAgICAganFMaXRlKG9wdGlvbnMuYXBwZW5kVG8pLmFwcGVuZChlbGVtZW50KTsKICAgICAgfQoKICAgICAgJGNvbXBpbGUoZWxlbWVudCkoc2NvcGUpOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICAgIHNjb3BlOiBzY29wZQogICAgICB9OwogICAgfSk7CiAgfQoKfV0pOwoKLyoqCiAqIEBwcml2YXRlCiAqIFRPRE8gZG9jdW1lbnQKICovCklvbmljTW9kdWxlCi5ydW4oWwogICckcm9vdFNjb3BlJywKICAnJHN0YXRlJywKICAnJGxvY2F0aW9uJywKICAnJGRvY3VtZW50JywKICAnJGFuaW1hdGUnLAogICckaW9uaWNQbGF0Zm9ybScsCiAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKZnVuY3Rpb24oJHJvb3RTY29wZSwgJHN0YXRlLCAkbG9jYXRpb24sICRkb2N1bWVudCwgJGFuaW1hdGUsICRpb25pY1BsYXRmb3JtLCAkaW9uaWNWaWV3U2VydmljZSkgewoKICAvLyBpbml0IHRoZSB2YXJpYWJsZXMgdGhhdCBrZWVwIHRyYWNrIG9mIHRoZSB2aWV3IGhpc3RvcnkKICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeSA9IHsKICAgIGhpc3RvcmllczogeyByb290OiB7IGhpc3RvcnlJZDogJ3Jvb3QnLCBwYXJlbnRIaXN0b3J5SWQ6IG51bGwsIHN0YWNrOiBbXSwgY3Vyc29yOiAtMSB9IH0sCiAgICB2aWV3czoge30sCiAgICBiYWNrVmlldzogbnVsbCwKICAgIGZvcndhcmRWaWV3OiBudWxsLAogICAgY3VycmVudFZpZXc6IG51bGwsCiAgICBkaXNhYmxlZFJlZ2lzdHJhYmxlVGFnTmFtZXM6IFtdCiAgfTsKCiAgLy8gc2V0IHRoYXQgdGhlc2UgZGlyZWN0aXZlcyBzaG91bGQgbm90IGFuaW1hdGUgd2hlbiB0cmFuc2l0aW9uaW5nCiAgLy8gdG8gaXQuIEluc3RlYWQsIHRoZSBjaGlsZHJlbiA8dGFiPiBkaXJlY3RpdmVzIHdvdWxkIGFuaW1hdGUKICBpZiAoJGlvbmljVmlld1NlcnZpY2UuZGlzYWJsZVJlZ2lzdGVyQnlUYWdOYW1lKSB7CiAgICAkaW9uaWNWaWV3U2VydmljZS5kaXNhYmxlUmVnaXN0ZXJCeVRhZ05hbWUoJ2lvbi10YWJzJyk7CiAgICAkaW9uaWNWaWV3U2VydmljZS5kaXNhYmxlUmVnaXN0ZXJCeVRhZ05hbWUoJ2lvbi1zaWRlLW1lbnVzJyk7CiAgfQoKICAkcm9vdFNjb3BlLiRvbigndmlld1N0YXRlLmNoYW5nZUhpc3RvcnknLCBmdW5jdGlvbihlLCBkYXRhKSB7CiAgICBpZighZGF0YSkgcmV0dXJuOwoKICAgIHZhciBoaXN0ID0gKGRhdGEuaGlzdG9yeUlkID8gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBkYXRhLmhpc3RvcnlJZCBdIDogbnVsbCApOwogICAgaWYoaGlzdCAmJiBoaXN0LmN1cnNvciA+IC0xICYmIGhpc3QuY3Vyc29yIDwgaGlzdC5zdGFjay5sZW5ndGgpIHsKICAgICAgLy8gdGhlIGhpc3RvcnkgdGhleSdyZSBnb2luZyB0byBhbHJlYWR5IGV4aXN0cwogICAgICAvLyBnbyB0byBpdCdzIGxhc3QgdmlldyBpbiBpdHMgc3RhY2sKICAgICAgdmFyIHZpZXcgPSBoaXN0LnN0YWNrWyBoaXN0LmN1cnNvciBdOwogICAgICByZXR1cm4gdmlldy5nbyhkYXRhKTsKICAgIH0KCiAgICAvLyB0aGlzIGhpc3RvcnkgZG9lcyBub3QgaGF2ZSBhIFVSTCwgYnV0IGl0IGRvZXMgaGF2ZSBhIHVpU3JlZgogICAgLy8gZmlndXJlIG91dCBpdHMgVVJMIGZyb20gdGhlIHVpU3JlZgogICAgaWYoIWRhdGEudXJsICYmIGRhdGEudWlTcmVmKSB7CiAgICAgIGRhdGEudXJsID0gJHN0YXRlLmhyZWYoZGF0YS51aVNyZWYpOwogICAgfQoKICAgIGlmKGRhdGEudXJsKSB7CiAgICAgIC8vIGRvbid0IGxldCBpdCBzdGFydCB3aXRoIGEgIywgbWVzc2VzIHdpdGggJGxvY2F0aW9uLnVybCgpCiAgICAgIGlmKGRhdGEudXJsLmluZGV4T2YoJyMnKSA9PT0gMCkgewogICAgICAgIGRhdGEudXJsID0gZGF0YS51cmwucmVwbGFjZSgnIycsICcnKTsKICAgICAgfQogICAgICBpZihkYXRhLnVybCAhPT0gJGxvY2F0aW9uLnVybCgpKSB7CiAgICAgICAgLy8gd2UndmUgZ290IGEgZ29vZCBVUkwsIHJlYWR5IEdPIQogICAgICAgICRsb2NhdGlvbi51cmwoZGF0YS51cmwpOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIFNldCB0aGUgZG9jdW1lbnQgdGl0bGUgd2hlbiBhIG5ldyB2aWV3IGlzIHNob3duCiAgJHJvb3RTY29wZS4kb24oJ3ZpZXdTdGF0ZS52aWV3RW50ZXInLCBmdW5jdGlvbihlLCBkYXRhKSB7CiAgICBpZihkYXRhICYmIGRhdGEudGl0bGUpIHsKICAgICAgJGRvY3VtZW50WzBdLnRpdGxlID0gZGF0YS50aXRsZTsKICAgIH0KICB9KTsKCiAgLy8gVHJpZ2dlcmVkIHdoZW4gZGV2aWNlcyB3aXRoIGEgaGFyZHdhcmUgYmFjayBidXR0b24gKEFuZHJvaWQpIGlzIGNsaWNrZWQgYnkgdGhlIHVzZXIKICAvLyBUaGlzIGlzIGEgQ29yZG92YS9QaG9uZWdhcCBwbGF0Zm9ybSBzcGVjaWZjIG1ldGhvZAogIGZ1bmN0aW9uIG9uSGFyZHdhcmVCYWNrQnV0dG9uKGUpIHsKICAgIGlmKCRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmJhY2tWaWV3KSB7CiAgICAgIC8vIHRoZXJlIGlzIGEgYmFjayB2aWV3LCBnbyB0byBpdAogICAgICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5iYWNrVmlldy5nbygpOwogICAgfSBlbHNlIHsKICAgICAgLy8gdGhlcmUgaXMgbm8gYmFjayB2aWV3LCBzbyBjbG9zZSB0aGUgYXBwIGluc3RlYWQKICAgICAgaW9uaWMuUGxhdGZvcm0uZXhpdEFwcCgpOwogICAgfQogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KICAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICBvbkhhcmR3YXJlQmFja0J1dHRvbiwKICAgIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1ZJRVcKICApOwoKfV0pCgouZmFjdG9yeSgnJGlvbmljVmlld1NlcnZpY2UnLCBbCiAgJyRyb290U2NvcGUnLAogICckc3RhdGUnLAogICckbG9jYXRpb24nLAogICckd2luZG93JywKICAnJGluamVjdG9yJywKICAnJGFuaW1hdGUnLAogICckaW9uaWNOYXZWaWV3Q29uZmlnJywKICAnJGlvbmljQ2xpY2tCbG9jaycsCmZ1bmN0aW9uKCRyb290U2NvcGUsICRzdGF0ZSwgJGxvY2F0aW9uLCAkd2luZG93LCAkaW5qZWN0b3IsICRhbmltYXRlLCAkaW9uaWNOYXZWaWV3Q29uZmlnLCAkaW9uaWNDbGlja0Jsb2NrKSB7CgogIHZhciBWaWV3ID0gZnVuY3Rpb24oKXt9OwogIFZpZXcucHJvdG90eXBlLmluaXRpYWxpemUgPSBmdW5jdGlvbihkYXRhKSB7CiAgICBpZihkYXRhKSB7CiAgICAgIGZvcih2YXIgbmFtZSBpbiBkYXRhKSB0aGlzW25hbWVdID0gZGF0YVtuYW1lXTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9OwogIFZpZXcucHJvdG90eXBlLmdvID0gZnVuY3Rpb24oKSB7CgogICAgaWYodGhpcy5zdGF0ZU5hbWUpIHsKICAgICAgcmV0dXJuICRzdGF0ZS5nbyh0aGlzLnN0YXRlTmFtZSwgdGhpcy5zdGF0ZVBhcmFtcyk7CiAgICB9CgogICAgaWYodGhpcy51cmwgJiYgdGhpcy51cmwgIT09ICRsb2NhdGlvbi51cmwoKSkgewoKICAgICAgaWYoJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuYmFja1ZpZXcgPT09IHRoaXMpIHsKICAgICAgICByZXR1cm4gJHdpbmRvdy5oaXN0b3J5LmdvKC0xKTsKICAgICAgfSBlbHNlIGlmKCRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmZvcndhcmRWaWV3ID09PSB0aGlzKSB7CiAgICAgICAgcmV0dXJuICR3aW5kb3cuaGlzdG9yeS5nbygxKTsKICAgICAgfQoKICAgICAgJGxvY2F0aW9uLnVybCh0aGlzLnVybCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9OwogIFZpZXcucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgIGlmKHRoaXMuc2NvcGUpIHsKICAgICAgdGhpcy5zY29wZS4kZGVzdHJveSAmJiB0aGlzLnNjb3BlLiRkZXN0cm95KCk7CiAgICAgIHRoaXMuc2NvcGUgPSBudWxsOwogICAgfQogIH07CgogIGZ1bmN0aW9uIGNyZWF0ZVZpZXdJZChzdGF0ZUlkKSB7CiAgICByZXR1cm4gaW9uaWMuVXRpbHMubmV4dFVpZCgpOwogIH0KCiAgcmV0dXJuIHsKCiAgICByZWdpc3RlcjogZnVuY3Rpb24oY29udGFpbmVyU2NvcGUsIGVsZW1lbnQpIHsKCiAgICAgIHZhciB2aWV3SGlzdG9yeSA9ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LAogICAgICAgICAgY3VycmVudFN0YXRlSWQgPSB0aGlzLmdldEN1cnJlbnRTdGF0ZUlkKCksCiAgICAgICAgICBoaXN0ID0gdGhpcy5fZ2V0SGlzdG9yeShjb250YWluZXJTY29wZSksCiAgICAgICAgICBjdXJyZW50VmlldyA9IHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3LAogICAgICAgICAgYmFja1ZpZXcgPSB2aWV3SGlzdG9yeS5iYWNrVmlldywKICAgICAgICAgIGZvcndhcmRWaWV3ID0gdmlld0hpc3RvcnkuZm9yd2FyZFZpZXcsCiAgICAgICAgICBuZXh0Vmlld09wdGlvbnMgPSB0aGlzLm5leHRWaWV3T3B0aW9ucygpLAogICAgICAgICAgcnNwID0gewogICAgICAgICAgICB2aWV3SWQ6IG51bGwsCiAgICAgICAgICAgIG5hdkFjdGlvbjogbnVsbCwKICAgICAgICAgICAgbmF2RGlyZWN0aW9uOiBudWxsLAogICAgICAgICAgICBoaXN0b3J5SWQ6IGhpc3QuaGlzdG9yeUlkCiAgICAgICAgICB9OwoKICAgICAgaWYoZWxlbWVudCAmJiAhdGhpcy5pc1RhZ05hbWVSZWdpc3RyYWJsZShlbGVtZW50KSkgewogICAgICAgIC8vIGZpcnN0IGNoZWNrIHRvIHNlZSBpZiB0aGlzIGVsZW1lbnQgY2FuIGV2ZW4gYmUgcmVnaXN0ZXJlZCBhcyBhIHZpZXcuCiAgICAgICAgLy8gQ2VydGFpbiB0YWdzIGFyZSBvbmx5IGNvbnRhaW5lcnMgZm9yIHZpZXdzLCBidXQgYXJlIG5vdCB2aWV3cyB0aGVtc2VsdmVzLgogICAgICAgIC8vIEZvciBleGFtcGxlLCB0aGUgPGlvbi10YWJzPiBkaXJlY3RpdmUgY29udGFpbnMgYSA8aW9uLXRhYj4gYW5kIHRoZSA8aW9uLXRhYj4gaXMgdGhlCiAgICAgICAgLy8gdmlldywgYnV0IHRoZSA8aW9uLXRhYnM+IGRpcmVjdGl2ZSBpdHNlbGYgc2hvdWxkIG5vdCBiZSByZWdpc3RlcmVkIGFzIGEgdmlldy4KICAgICAgICByc3AubmF2QWN0aW9uID0gJ2Rpc2FibGVkQnlUYWdOYW1lJzsKICAgICAgICByZXR1cm4gcnNwOwogICAgICB9CgogICAgICBpZihjdXJyZW50VmlldyAmJgogICAgICAgICBjdXJyZW50Vmlldy5zdGF0ZUlkID09PSBjdXJyZW50U3RhdGVJZCAmJgogICAgICAgICBjdXJyZW50Vmlldy5oaXN0b3J5SWQgPT09IGhpc3QuaGlzdG9yeUlkKSB7CiAgICAgICAgLy8gZG8gbm90aGluZyBpZiBpdHMgdGhlIHNhbWUgc3RhdGVJZCBpbiB0aGUgc2FtZSBoaXN0b3J5CiAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdub0NoYW5nZSc7CiAgICAgICAgcmV0dXJuIHJzcDsKICAgICAgfQoKICAgICAgaWYodmlld0hpc3RvcnkuZm9yY2VkTmF2KSB7CiAgICAgICAgLy8gd2UndmUgcHJldmlvdXNseSBzZXQgZXhhY3RseSB3aGF0IHRvIGRvCiAgICAgICAgaW9uaWMuVXRpbHMuZXh0ZW5kKHJzcCwgdmlld0hpc3RvcnkuZm9yY2VkTmF2KTsKICAgICAgICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5mb3JjZWROYXYgPSBudWxsOwoKICAgICAgfSBlbHNlIGlmKGJhY2tWaWV3ICYmIGJhY2tWaWV3LnN0YXRlSWQgPT09IGN1cnJlbnRTdGF0ZUlkKSB7CiAgICAgICAgLy8gdGhleSB3ZW50IGJhY2sgb25lLCBzZXQgdGhlIG9sZCBjdXJyZW50IHZpZXcgYXMgYSBmb3J3YXJkIHZpZXcKICAgICAgICByc3Audmlld0lkID0gYmFja1ZpZXcudmlld0lkOwogICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnbW92ZUJhY2snOwogICAgICAgIHJzcC52aWV3SWQgPSBiYWNrVmlldy52aWV3SWQ7CiAgICAgICAgaWYoYmFja1ZpZXcuaGlzdG9yeUlkID09PSBjdXJyZW50Vmlldy5oaXN0b3J5SWQpIHsKICAgICAgICAgIC8vIHdlbnQgYmFjayBpbiB0aGUgc2FtZSBoaXN0b3J5CiAgICAgICAgICByc3AubmF2RGlyZWN0aW9uID0gJ2JhY2snOwogICAgICAgIH0KCiAgICAgIH0gZWxzZSBpZihmb3J3YXJkVmlldyAmJiBmb3J3YXJkVmlldy5zdGF0ZUlkID09PSBjdXJyZW50U3RhdGVJZCkgewogICAgICAgIC8vIHRoZXkgd2VudCB0byB0aGUgZm9yd2FyZCBvbmUsIHNldCB0aGUgZm9yd2FyZCB2aWV3IHRvIG5vIGxvbmdlciBhIGZvcndhcmQgdmlldwogICAgICAgIHJzcC52aWV3SWQgPSBmb3J3YXJkVmlldy52aWV3SWQ7CiAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdtb3ZlRm9yd2FyZCc7CiAgICAgICAgaWYoZm9yd2FyZFZpZXcuaGlzdG9yeUlkID09PSBjdXJyZW50Vmlldy5oaXN0b3J5SWQpIHsKICAgICAgICAgIHJzcC5uYXZEaXJlY3Rpb24gPSAnZm9yd2FyZCc7CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFyZW50SGlzdG9yeSA9IHRoaXMuX2dldFBhcmVudEhpc3RvcnlPYmooY29udGFpbmVyU2NvcGUpOwogICAgICAgIGlmKGZvcndhcmRWaWV3Lmhpc3RvcnlJZCAmJiBwYXJlbnRIaXN0b3J5LnNjb3BlKSB7CiAgICAgICAgICAvLyBpZiBhIGhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBjcmVhdGVkIGJ5IHRoZSBmb3J3YXJkIHZpZXcgdGhlbiBtYWtlIHN1cmUgaXQgc3RheXMgdGhlIHNhbWUKICAgICAgICAgIHBhcmVudEhpc3Rvcnkuc2NvcGUuJGhpc3RvcnlJZCA9IGZvcndhcmRWaWV3Lmhpc3RvcnlJZDsKICAgICAgICAgIHJzcC5oaXN0b3J5SWQgPSBmb3J3YXJkVmlldy5oaXN0b3J5SWQ7CiAgICAgICAgfQoKICAgICAgfSBlbHNlIGlmKGN1cnJlbnRWaWV3ICYmIGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCAhPT0gaGlzdC5oaXN0b3J5SWQgJiYKICAgICAgICAgICAgICAgIGhpc3QuY3Vyc29yID4gLTEgJiYgaGlzdC5zdGFjay5sZW5ndGggPiAwICYmIGhpc3QuY3Vyc29yIDwgaGlzdC5zdGFjay5sZW5ndGggJiYKICAgICAgICAgICAgICAgIGhpc3Quc3RhY2tbaGlzdC5jdXJzb3JdLnN0YXRlSWQgPT09IGN1cnJlbnRTdGF0ZUlkKSB7CiAgICAgICAgLy8gdGhleSBqdXN0IGNoYW5nZWQgdG8gYSBkaWZmZXJlbnQgaGlzdG9yeSBhbmQgdGhlIGhpc3RvcnkgYWxyZWFkeSBoYXMgdmlld3MgaW4gaXQKICAgICAgICByc3Audmlld0lkID0gaGlzdC5zdGFja1toaXN0LmN1cnNvcl0udmlld0lkOwogICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnbW92ZUJhY2snOwoKICAgICAgfSBlbHNlIHsKCiAgICAgICAgLy8gc2V0IGEgbmV3IHVuaXF1ZSB2aWV3SWQKICAgICAgICByc3Audmlld0lkID0gY3JlYXRlVmlld0lkKGN1cnJlbnRTdGF0ZUlkKTsKCiAgICAgICAgaWYoY3VycmVudFZpZXcpIHsKICAgICAgICAgIC8vIHNldCB0aGUgZm9yd2FyZCB2aWV3IGlmIHRoZXJlIGlzIGEgY3VycmVudCB2aWV3IChpZTogaWYgaXRzIG5vdCB0aGUgZmlyc3QgdmlldykKICAgICAgICAgIGN1cnJlbnRWaWV3LmZvcndhcmRWaWV3SWQgPSByc3Audmlld0lkOwoKICAgICAgICAgIC8vIGl0cyBvbmx5IG1vdmluZyBmb3J3YXJkIGlmIGl0cyBpbiB0aGUgc2FtZSBoaXN0b3J5CiAgICAgICAgICBpZihoaXN0Lmhpc3RvcnlJZCA9PT0gY3VycmVudFZpZXcuaGlzdG9yeUlkKSB7CiAgICAgICAgICAgIHJzcC5uYXZEaXJlY3Rpb24gPSAnZm9yd2FyZCc7CiAgICAgICAgICB9CiAgICAgICAgICByc3AubmF2QWN0aW9uID0gJ25ld1ZpZXcnOwoKICAgICAgICAgIC8vIGNoZWNrIGlmIHRoZXJlIGlzIGEgbmV3IGZvcndhcmQgdmlldwogICAgICAgICAgaWYoZm9yd2FyZFZpZXcgJiYgY3VycmVudFZpZXcuc3RhdGVJZCAhPT0gZm9yd2FyZFZpZXcuc3RhdGVJZCkgewogICAgICAgICAgICAvLyB0aGV5IG5hdmlnYXRlZCB0byBhIG5ldyB2aWV3IGJ1dCB0aGUgc3RhY2sgYWxyZWFkeSBoYXMgYSBmb3J3YXJkIHZpZXcKICAgICAgICAgICAgLy8gc2luY2UgaXRzIGEgbmV3IHZpZXcgcmVtb3ZlIGFueSBmb3J3YXJkcyB0aGF0IGV4aXN0ZWQKICAgICAgICAgICAgdmFyIGZvcndhcmRzSGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnlCeUlkKGZvcndhcmRWaWV3Lmhpc3RvcnlJZCk7CiAgICAgICAgICAgIGlmKGZvcndhcmRzSGlzdG9yeSkgewogICAgICAgICAgICAgIC8vIHRoZSBmb3J3YXJkIGhhcyBhIGhpc3RvcnkKICAgICAgICAgICAgICBmb3IodmFyIHg9Zm9yd2FyZHNIaXN0b3J5LnN0YWNrLmxlbmd0aCAtIDE7IHggPj0gZm9yd2FyZFZpZXcuaW5kZXg7IHgtLSkgewogICAgICAgICAgICAgICAgLy8gc3RhcnRpbmcgZnJvbSB0aGUgZW5kIGRlc3Ryb3kgYWxsIGZvcndhcmRzIGluIHRoaXMgaGlzdG9yeSBmcm9tIHRoaXMgcG9pbnQKICAgICAgICAgICAgICAgIGZvcndhcmRzSGlzdG9yeS5zdGFja1t4XS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICBmb3J3YXJkc0hpc3Rvcnkuc3RhY2suc3BsaWNlKHgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gdGhlcmUncyBubyBjdXJyZW50IHZpZXcsIHNvIHRoaXMgbXVzdCBiZSB0aGUgaW5pdGlhbCB2aWV3CiAgICAgICAgICByc3AubmF2QWN0aW9uID0gJ2luaXRpYWxWaWV3JzsKICAgICAgICB9CgogICAgICAgIC8vIGFkZCB0aGUgbmV3IHZpZXcKICAgICAgICB2aWV3SGlzdG9yeS52aWV3c1tyc3Audmlld0lkXSA9IHRoaXMuY3JlYXRlVmlldyh7CiAgICAgICAgICB2aWV3SWQ6IHJzcC52aWV3SWQsCiAgICAgICAgICBpbmRleDogaGlzdC5zdGFjay5sZW5ndGgsCiAgICAgICAgICBoaXN0b3J5SWQ6IGhpc3QuaGlzdG9yeUlkLAogICAgICAgICAgYmFja1ZpZXdJZDogKGN1cnJlbnRWaWV3ICYmIGN1cnJlbnRWaWV3LnZpZXdJZCA/IGN1cnJlbnRWaWV3LnZpZXdJZCA6IG51bGwpLAogICAgICAgICAgZm9yd2FyZFZpZXdJZDogbnVsbCwKICAgICAgICAgIHN0YXRlSWQ6IGN1cnJlbnRTdGF0ZUlkLAogICAgICAgICAgc3RhdGVOYW1lOiB0aGlzLmdldEN1cnJlbnRTdGF0ZU5hbWUoKSwKICAgICAgICAgIHN0YXRlUGFyYW1zOiB0aGlzLmdldEN1cnJlbnRTdGF0ZVBhcmFtcygpLAogICAgICAgICAgdXJsOiAkbG9jYXRpb24udXJsKCksCiAgICAgICAgfSk7CgogICAgICAgIGlmIChyc3AubmF2QWN0aW9uID09ICdtb3ZlQmFjaycpIHsKICAgICAgICAgIC8vbW92ZUJhY2soZnJvbSwgdG8pOwogICAgICAgICAgJHJvb3RTY29wZS4kZW1pdCgnJHZpZXdIaXN0b3J5LnZpZXdCYWNrJywgY3VycmVudFZpZXcudmlld0lkLCByc3Audmlld0lkKTsKICAgICAgICB9CgogICAgICAgIC8vIGFkZCB0aGUgbmV3IHZpZXcgdG8gdGhpcyBoaXN0b3J5J3Mgc3RhY2sKICAgICAgICBoaXN0LnN0YWNrLnB1c2godmlld0hpc3Rvcnkudmlld3NbcnNwLnZpZXdJZF0pOwogICAgICB9CgogICAgICBpZihuZXh0Vmlld09wdGlvbnMpIHsKICAgICAgICBpZihuZXh0Vmlld09wdGlvbnMuZGlzYWJsZUFuaW1hdGUpIHJzcC5uYXZEaXJlY3Rpb24gPSBudWxsOwogICAgICAgIGlmKG5leHRWaWV3T3B0aW9ucy5kaXNhYmxlQmFjaykgdmlld0hpc3Rvcnkudmlld3NbcnNwLnZpZXdJZF0uYmFja1ZpZXdJZCA9IG51bGw7CiAgICAgICAgdGhpcy5uZXh0Vmlld09wdGlvbnMobnVsbCk7CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0TmF2Vmlld3MocnNwLnZpZXdJZCk7CgogICAgICBoaXN0LmN1cnNvciA9IHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3LmluZGV4OwoKICAgICAgcmV0dXJuIHJzcDsKICAgIH0sCgogICAgc2V0TmF2Vmlld3M6IGZ1bmN0aW9uKHZpZXdJZCkgewogICAgICB2YXIgdmlld0hpc3RvcnkgPSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeTsKCiAgICAgIHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3ID0gdGhpcy5fZ2V0Vmlld0J5SWQodmlld0lkKTsKICAgICAgdmlld0hpc3RvcnkuYmFja1ZpZXcgPSB0aGlzLl9nZXRCYWNrVmlldyh2aWV3SGlzdG9yeS5jdXJyZW50Vmlldyk7CiAgICAgIHZpZXdIaXN0b3J5LmZvcndhcmRWaWV3ID0gdGhpcy5fZ2V0Rm9yd2FyZFZpZXcodmlld0hpc3RvcnkuY3VycmVudFZpZXcpOwoKICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckdmlld0hpc3RvcnkuaGlzdG9yeUNoYW5nZScsIHsKICAgICAgICBzaG93QmFjazogKHZpZXdIaXN0b3J5LmJhY2tWaWV3ICYmIHZpZXdIaXN0b3J5LmJhY2tWaWV3Lmhpc3RvcnlJZCA9PT0gdmlld0hpc3RvcnkuY3VycmVudFZpZXcuaGlzdG9yeUlkKQogICAgICB9KTsKICAgIH0sCgogICAgcmVnaXN0ZXJIaXN0b3J5OiBmdW5jdGlvbihzY29wZSkgewogICAgICBzY29wZS4kaGlzdG9yeUlkID0gaW9uaWMuVXRpbHMubmV4dFVpZCgpOwogICAgfSwKCiAgICBjcmVhdGVWaWV3OiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHZhciBuZXdWaWV3ID0gbmV3IFZpZXcoKTsKICAgICAgcmV0dXJuIG5ld1ZpZXcuaW5pdGlhbGl6ZShkYXRhKTsKICAgIH0sCgogICAgZ2V0Q3VycmVudFZpZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuY3VycmVudFZpZXc7CiAgICB9LAoKICAgIGdldEJhY2tWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmJhY2tWaWV3OwogICAgfSwKCiAgICBnZXRGb3J3YXJkVmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5mb3J3YXJkVmlldzsKICAgIH0sCgogICAgZ2V0TmF2RGlyZWN0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lm5hdkRpcmVjdGlvbjsKICAgIH0sCgogICAgZ2V0Q3VycmVudFN0YXRlTmFtZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAoJHN0YXRlICYmICRzdGF0ZS5jdXJyZW50ID8gJHN0YXRlLmN1cnJlbnQubmFtZSA6IG51bGwpOwogICAgfSwKCiAgICBpc0N1cnJlbnRTdGF0ZU5hdlZpZXc6IGZ1bmN0aW9uKG5hdlZpZXcpIHsKICAgICAgcmV0dXJuICgkc3RhdGUgJiYKICAgICAgICAgICAgICAkc3RhdGUuY3VycmVudCAmJgogICAgICAgICAgICAgICRzdGF0ZS5jdXJyZW50LnZpZXdzICYmCiAgICAgICAgICAgICAgJHN0YXRlLmN1cnJlbnQudmlld3NbbmF2Vmlld10gPyB0cnVlIDogZmFsc2UpOwogICAgfSwKCiAgICBnZXRDdXJyZW50U3RhdGVQYXJhbXM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgcnRuOwogICAgICBpZiAoJHN0YXRlICYmICRzdGF0ZS5wYXJhbXMpIHsKICAgICAgICBmb3IodmFyIGtleSBpbiAkc3RhdGUucGFyYW1zKSB7CiAgICAgICAgICBpZigkc3RhdGUucGFyYW1zLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgcnRuID0gcnRuIHx8IHt9OwogICAgICAgICAgICBydG5ba2V5XSA9ICRzdGF0ZS5wYXJhbXNba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJ0bjsKICAgIH0sCgogICAgZ2V0Q3VycmVudFN0YXRlSWQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaWQ7CiAgICAgIGlmKCRzdGF0ZSAmJiAkc3RhdGUuY3VycmVudCAmJiAkc3RhdGUuY3VycmVudC5uYW1lKSB7CiAgICAgICAgaWQgPSAkc3RhdGUuY3VycmVudC5uYW1lOwogICAgICAgIGlmKCRzdGF0ZS5wYXJhbXMpIHsKICAgICAgICAgIGZvcih2YXIga2V5IGluICRzdGF0ZS5wYXJhbXMpIHsKICAgICAgICAgICAgaWYoJHN0YXRlLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICRzdGF0ZS5wYXJhbXNba2V5XSkgewogICAgICAgICAgICAgIGlkICs9ICJfIiArIGtleSArICI9IiArICRzdGF0ZS5wYXJhbXNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaWQ7CiAgICAgIH0KICAgICAgLy8gaWYgc29tZXRoaW5nIGdvZXMgd3JvbmcgbWFrZSBzdXJlIGl0cyBnb3QgYSB1bmlxdWUgc3RhdGVJZAogICAgICByZXR1cm4gaW9uaWMuVXRpbHMubmV4dFVpZCgpOwogICAgfSwKCiAgICBnb1RvSGlzdG9yeVJvb3Q6IGZ1bmN0aW9uKGhpc3RvcnlJZCkgewogICAgICBpZihoaXN0b3J5SWQpIHsKICAgICAgICB2YXIgaGlzdCA9ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3Rvcmllc1sgaGlzdG9yeUlkIF07CiAgICAgICAgaWYoaGlzdCAmJiBoaXN0LnN0YWNrLmxlbmd0aCkgewogICAgICAgICAgaWYoJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuY3VycmVudFZpZXcgJiYgJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuY3VycmVudFZpZXcudmlld0lkID09PSBoaXN0LnN0YWNrWzBdLnZpZXdJZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5mb3JjZWROYXYgPSB7CiAgICAgICAgICAgIHZpZXdJZDogaGlzdC5zdGFja1swXS52aWV3SWQsCiAgICAgICAgICAgIG5hdkFjdGlvbjogJ21vdmVCYWNrJywKICAgICAgICAgICAgbmF2RGlyZWN0aW9uOiAnYmFjaycKICAgICAgICAgIH07CiAgICAgICAgICBoaXN0LnN0YWNrWzBdLmdvKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIF9nZXRWaWV3QnlJZDogZnVuY3Rpb24odmlld0lkKSB7CiAgICAgIHJldHVybiAodmlld0lkID8gJHJvb3RTY29wZS4kdmlld0hpc3Rvcnkudmlld3NbIHZpZXdJZCBdIDogbnVsbCApOwogICAgfSwKCiAgICBfZ2V0QmFja1ZpZXc6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgcmV0dXJuICh2aWV3ID8gdGhpcy5fZ2V0Vmlld0J5SWQodmlldy5iYWNrVmlld0lkKSA6IG51bGwgKTsKICAgIH0sCgogICAgX2dldEZvcndhcmRWaWV3OiBmdW5jdGlvbih2aWV3KSB7CiAgICAgIHJldHVybiAodmlldyA/IHRoaXMuX2dldFZpZXdCeUlkKHZpZXcuZm9yd2FyZFZpZXdJZCkgOiBudWxsICk7CiAgICB9LAoKICAgIF9nZXRIaXN0b3J5QnlJZDogZnVuY3Rpb24oaGlzdG9yeUlkKSB7CiAgICAgIHJldHVybiAoaGlzdG9yeUlkID8gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBoaXN0b3J5SWQgXSA6IG51bGwgKTsKICAgIH0sCgogICAgX2dldEhpc3Rvcnk6IGZ1bmN0aW9uKHNjb3BlKSB7CiAgICAgIHZhciBoaXN0T2JqID0gdGhpcy5fZ2V0UGFyZW50SGlzdG9yeU9iaihzY29wZSk7CgogICAgICBpZiggISRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3Rvcmllc1sgaGlzdE9iai5oaXN0b3J5SWQgXSApIHsKICAgICAgICAvLyB0aGlzIGhpc3Rvcnkgb2JqZWN0IGV4aXN0cyBpbiBwYXJlbnQgc2NvcGUsIGJ1dCBkb2Vzbid0CiAgICAgICAgLy8gZXhpc3QgaW4gdGhlIGhpc3RvcnkgZGF0YSB5ZXQKICAgICAgICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXNbIGhpc3RPYmouaGlzdG9yeUlkIF0gPSB7CiAgICAgICAgICBoaXN0b3J5SWQ6IGhpc3RPYmouaGlzdG9yeUlkLAogICAgICAgICAgcGFyZW50SGlzdG9yeUlkOiB0aGlzLl9nZXRQYXJlbnRIaXN0b3J5T2JqKGhpc3RPYmouc2NvcGUuJHBhcmVudCkuaGlzdG9yeUlkLAogICAgICAgICAgc3RhY2s6IFtdLAogICAgICAgICAgY3Vyc29yOiAtMQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXNbIGhpc3RPYmouaGlzdG9yeUlkIF07CiAgICB9LAoKICAgIF9nZXRQYXJlbnRIaXN0b3J5T2JqOiBmdW5jdGlvbihzY29wZSkgewogICAgICB2YXIgcGFyZW50U2NvcGUgPSBzY29wZTsKICAgICAgd2hpbGUocGFyZW50U2NvcGUpIHsKICAgICAgICBpZihwYXJlbnRTY29wZS5oYXNPd25Qcm9wZXJ0eSgnJGhpc3RvcnlJZCcpKSB7CiAgICAgICAgICAvLyB0aGlzIHBhcmVudCBzY29wZSBoYXMgYSBoaXN0b3J5SWQKICAgICAgICAgIHJldHVybiB7IGhpc3RvcnlJZDogcGFyZW50U2NvcGUuJGhpc3RvcnlJZCwgc2NvcGU6IHBhcmVudFNjb3BlIH07CiAgICAgICAgfQogICAgICAgIC8vIG5vdGhpbmcgZm91bmQga2VlcCBjbGltYmluZyB1cAogICAgICAgIHBhcmVudFNjb3BlID0gcGFyZW50U2NvcGUuJHBhcmVudDsKICAgICAgfQogICAgICAvLyBubyBoaXN0b3J5IGZvciBmb3IgdGhlIHBhcmVudCwgdXNlIHRoZSByb290CiAgICAgIHJldHVybiB7IGhpc3RvcnlJZDogJ3Jvb3QnLCBzY29wZTogJHJvb3RTY29wZSB9OwogICAgfSwKCiAgICBuZXh0Vmlld09wdGlvbnM6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHRoaXMuX25leHRPcHRzID0gb3B0czsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5fbmV4dE9wdHM7CiAgICAgIH0KICAgIH0sCgogICAgZ2V0UmVuZGVyZXI6IGZ1bmN0aW9uKG5hdlZpZXdFbGVtZW50LCBuYXZWaWV3QXR0cnMsIG5hdlZpZXdTY29wZSkgewogICAgICB2YXIgc2VydmljZSA9IHRoaXM7CiAgICAgIHZhciByZWdpc3RlckRhdGE7CiAgICAgIHZhciBkb0FuaW1hdGlvbjsKCiAgICAgIC8vIGNsaW1iIHVwIHRoZSBET00gYW5kIHNlZSB3aGljaCBhbmltYXRpb24gY2xhc3NuYW1lIHRvIHVzZSwgaWYgYW55CiAgICAgIHZhciBhbmltYXRpb25DbGFzcyA9IGdldFBhcmVudEFuaW1hdGlvbkNsYXNzKG5hdlZpZXdFbGVtZW50WzBdKTsKCiAgICAgIGZ1bmN0aW9uIGdldFBhcmVudEFuaW1hdGlvbkNsYXNzKGVsKSB7CiAgICAgICAgdmFyIGNsYXNzTmFtZSA9ICcnOwogICAgICAgIHdoaWxlKCFjbGFzc05hbWUgJiYgZWwpIHsKICAgICAgICAgIGNsYXNzTmFtZSA9IGVsLmdldEF0dHJpYnV0ZSgnYW5pbWF0aW9uJyk7CiAgICAgICAgICBlbCA9IGVsLnBhcmVudEVsZW1lbnQ7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB0aGV5IGRvbid0IGhhdmUgYW4gYW5pbWF0aW9uIHNldCBleHBsaWNpdGx5LCB1c2UgdGhlIHZhbHVlIGluIHRoZSBjb25maWcKICAgICAgICBpZighY2xhc3NOYW1lKSB7CiAgICAgICAgICByZXR1cm4gJGlvbmljTmF2Vmlld0NvbmZpZy50cmFuc2l0aW9uOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNsYXNzTmFtZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gc2V0QW5pbWF0aW9uQ2xhc3MoKSB7CiAgICAgICAgLy8gYWRkIHRoZSBhbmltYXRpb24gQ1NTIGNsYXNzIHdlJ3JlIGdvbm5hIHVzZSB0byB0cmFuc2l0aW9uIGJldHdlZW4gdmlld3MKICAgICAgICBpZiAoYW5pbWF0aW9uQ2xhc3MpIHsKICAgICAgICAgIG5hdlZpZXdFbGVtZW50WzBdLmNsYXNzTGlzdC5hZGQoYW5pbWF0aW9uQ2xhc3MpOwogICAgICAgIH0KCiAgICAgICAgaWYocmVnaXN0ZXJEYXRhLm5hdkRpcmVjdGlvbiA9PT0gJ2JhY2snKSB7CiAgICAgICAgICAvLyBhbmltYXRlIGxpa2Ugd2UncmUgbW92aW5nIGJhY2t3YXJkCiAgICAgICAgICBuYXZWaWV3RWxlbWVudFswXS5jbGFzc0xpc3QuYWRkKCdyZXZlcnNlJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGRlZmF1bHRzIHRvIGFuaW1hdGUgZm9yd2FyZAogICAgICAgICAgLy8gbWFrZSBzdXJlIHRoZSByZXZlcnNlIGNsYXNzIGlzbid0IGFscmVhZHkgYWRkZWQKICAgICAgICAgIG5hdlZpZXdFbGVtZW50WzBdLmNsYXNzTGlzdC5yZW1vdmUoJ3JldmVyc2UnKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbihzaG91bGRBbmltYXRlKSB7CgogICAgICAgIHJldHVybiB7CgogICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCiAgICAgICAgICAgIGlmKGRvQW5pbWF0aW9uICYmIHNob3VsZEFuaW1hdGUpIHsKICAgICAgICAgICAgICAvLyBlbnRlciB3aXRoIGFuIGFuaW1hdGlvbgogICAgICAgICAgICAgIHNldEFuaW1hdGlvbkNsYXNzKCk7CgogICAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWVudGVyJyk7CiAgICAgICAgICAgICAgJGlvbmljQ2xpY2tCbG9jay5zaG93KCk7CgogICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGVsZW1lbnQsIG5hdlZpZXdFbGVtZW50LCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRpb25pY0NsaWNrQmxvY2suaGlkZSgpOwogICAgICAgICAgICAgICAgaWYgKGFuaW1hdGlvbkNsYXNzKSB7CiAgICAgICAgICAgICAgICAgIG5hdlZpZXdFbGVtZW50WzBdLmNsYXNzTGlzdC5yZW1vdmUoYW5pbWF0aW9uQ2xhc3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmKCFkb0FuaW1hdGlvbikgewogICAgICAgICAgICAgICRpb25pY0NsaWNrQmxvY2suaGlkZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBubyBhbmltYXRpb24KICAgICAgICAgICAgbmF2Vmlld0VsZW1lbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgfSwKCiAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gbmF2Vmlld0VsZW1lbnQuY29udGVudHMoKTsKCiAgICAgICAgICAgIGlmKGRvQW5pbWF0aW9uICYmIHNob3VsZEFuaW1hdGUpIHsKICAgICAgICAgICAgICAvLyBsZWF2ZSB3aXRoIGFuIGFuaW1hdGlvbgogICAgICAgICAgICAgIHNldEFuaW1hdGlvbkNsYXNzKCk7CgogICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG5vIGFuaW1hdGlvbgogICAgICAgICAgICBlbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgfSwKCiAgICAgICAgICByZWdpc3RlcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAvLyByZWdpc3RlciBhIG5ldyB2aWV3CiAgICAgICAgICAgIHJlZ2lzdGVyRGF0YSA9IHNlcnZpY2UucmVnaXN0ZXIobmF2Vmlld1Njb3BlLCBlbGVtZW50KTsKICAgICAgICAgICAgZG9BbmltYXRpb24gPSAoYW5pbWF0aW9uQ2xhc3MgIT09IG51bGwgJiYgcmVnaXN0ZXJEYXRhLm5hdkRpcmVjdGlvbiAhPT0gbnVsbCk7CiAgICAgICAgICAgIHJldHVybiByZWdpc3RlckRhdGE7CiAgICAgICAgICB9CgogICAgICAgIH07CiAgICAgIH07CiAgICB9LAoKICAgIGRpc2FibGVSZWdpc3RlckJ5VGFnTmFtZTogZnVuY3Rpb24odGFnTmFtZSkgewogICAgICAvLyBub3QgZXZlcnkgZWxlbWVudCBzaG91bGQgYW5pbWF0ZSBiZXR3ZWUgdHJhbnNpdGlvbnMKICAgICAgLy8gRm9yIGV4YW1wbGUsIHRoZSA8aW9uLXRhYnM+IGRpcmVjdGl2ZSBzaG91bGQgbm90IGFuaW1hdGUgd2hlbiBpdCBlbnRlcnMsCiAgICAgIC8vIGJ1dCBpbnN0ZWFkIHRoZSA8aW9uLXRhYnM+IGRpcmVjdHZlIHdvdWxkIGp1c3Qgc2hvdywgYW5kIGl0cyBjaGlsZHJlbgogICAgICAvLyA8aW9uLXRhYj4gZGlyZWN0aXZlcyB3b3VsZCBkbyB0aGUgYW5pbWF0aW5nLCBidXQgPGlvbi10YWJzPiBpdHNlbGYgaXMgbm90IGEgdmlldwogICAgICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5kaXNhYmxlZFJlZ2lzdHJhYmxlVGFnTmFtZXMucHVzaCh0YWdOYW1lLnRvVXBwZXJDYXNlKCkpOwogICAgfSwKCiAgICBpc1RhZ05hbWVSZWdpc3RyYWJsZTogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAvLyBjaGVjayBpZiB0aGlzIGVsZW1lbnQgaGFzIGEgdGFnTmFtZSAoYXQgaXRzIHJvb3QsIG5vdCByZWN1cnNpdmVseSkKICAgICAgLy8gdGhhdCBzaG91bGRuJ3QgYmUgYW5pbWF0ZWQsIGxpa2UgPGlvbi10YWJzPiBvciA8aW9uLXNpZGUtbWVudT4KICAgICAgdmFyIHgsIHksIGRpc2FibGVkVGFncyA9ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmRpc2FibGVkUmVnaXN0cmFibGVUYWdOYW1lczsKICAgICAgZm9yKHg9MDsgeDxlbGVtZW50Lmxlbmd0aDsgeCsrKSB7CiAgICAgICAgaWYoZWxlbWVudFt4XS5ub2RlVHlwZSAhPT0gMSkgY29udGludWU7CiAgICAgICAgZm9yKHk9MDsgeTxkaXNhYmxlZFRhZ3MubGVuZ3RoOyB5KyspIHsKICAgICAgICAgIGlmKGVsZW1lbnRbeF0udGFnTmFtZSA9PT0gZGlzYWJsZWRUYWdzW3ldKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIGNsZWFySGlzdG9yeTogZnVuY3Rpb24oKSB7CiAgICAgIHZhcgogICAgICBoaXN0b3JpZXMgPSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXMsCiAgICAgIGN1cnJlbnRWaWV3ID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuY3VycmVudFZpZXc7CgogICAgICBpZihoaXN0b3JpZXMpIHsKICAgICAgICBmb3IodmFyIGhpc3RvcnlJZCBpbiBoaXN0b3JpZXMpIHsKCiAgICAgICAgICBpZihoaXN0b3JpZXNbaGlzdG9yeUlkXS5zdGFjaykgewogICAgICAgICAgICBoaXN0b3JpZXNbaGlzdG9yeUlkXS5zdGFjayA9IFtdOwogICAgICAgICAgICBoaXN0b3JpZXNbaGlzdG9yeUlkXS5jdXJzb3IgPSAtMTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZihjdXJyZW50VmlldyAmJiBjdXJyZW50Vmlldy5oaXN0b3J5SWQgPT09IGhpc3RvcnlJZCkgewogICAgICAgICAgICBjdXJyZW50Vmlldy5iYWNrVmlld0lkID0gbnVsbDsKICAgICAgICAgICAgY3VycmVudFZpZXcuZm9yd2FyZFZpZXdJZCA9IG51bGw7CiAgICAgICAgICAgIGhpc3Rvcmllc1toaXN0b3J5SWRdLnN0YWNrLnB1c2goY3VycmVudFZpZXcpOwogICAgICAgICAgfSBlbHNlIGlmKGhpc3Rvcmllc1toaXN0b3J5SWRdLmRlc3Ryb3kpIHsKICAgICAgICAgICAgaGlzdG9yaWVzW2hpc3RvcnlJZF0uZGVzdHJveSgpOwogICAgICAgICAgfQoKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvcih2YXIgdmlld0lkIGluICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LnZpZXdzKSB7CiAgICAgICAgaWYodmlld0lkICE9PSBjdXJyZW50Vmlldy52aWV3SWQpIHsKICAgICAgICAgIGRlbGV0ZSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS52aWV3c1t2aWV3SWRdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYoY3VycmVudFZpZXcpIHsKICAgICAgICB0aGlzLnNldE5hdlZpZXdzKGN1cnJlbnRWaWV3LnZpZXdJZCk7CiAgICAgIH0KICAgIH0KCiAgfTsKCn1dKTsKCi8qKgogKiBAcHJpdmF0ZQogKi8KSW9uaWNNb2R1bGUuY29uZmlnKFsKICAnJHByb3ZpZGUnLApmdW5jdGlvbigkcHJvdmlkZSkgewogIGZ1bmN0aW9uICRMb2NhdGlvbkRlY29yYXRvcigkbG9jYXRpb24sICR0aW1lb3V0KSB7CgogICAgJGxvY2F0aW9uLl9faGFzaCA9ICRsb2NhdGlvbi5oYXNoOwogICAgLy9GaXg6IHdoZW4gd2luZG93LmxvY2F0aW9uLmhhc2ggaXMgc2V0LCB0aGUgc2Nyb2xsYWJsZSBhcmVhCiAgICAvL2ZvdW5kIG5lYXJlc3QgdG8gYm9keSdzIHNjcm9sbFRvcCBpcyBzZXQgdG8gc2Nyb2xsIHRvIGFuIGVsZW1lbnQKICAgIC8vd2l0aCB0aGF0IElELgogICAgJGxvY2F0aW9uLmhhc2ggPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgc2Nyb2xsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNjcm9sbC1jb250ZW50Jyk7CiAgICAgICAgICBpZiAoc2Nyb2xsKQogICAgICAgICAgICBzY3JvbGwuc2Nyb2xsVG9wID0gMDsKICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgIH0KICAgICAgcmV0dXJuICRsb2NhdGlvbi5fX2hhc2godmFsdWUpOwogICAgfTsKCiAgICByZXR1cm4gJGxvY2F0aW9uOwogIH0KCiAgJHByb3ZpZGUuZGVjb3JhdG9yKCckbG9jYXRpb24nLCBbJyRkZWxlZ2F0ZScsICckdGltZW91dCcsICRMb2NhdGlvbkRlY29yYXRvcl0pOwp9XSk7CgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZQogKiBAbW9kdWxlIGlvbmljCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZWxlZ2F0ZSBmb3IgY29udHJvbGxpbmcgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdH0gZGlyZWN0aXZlLgogKgogKiBNZXRob2RzIGNhbGxlZCBkaXJlY3RseSBvbiB0aGUgJGlvbmljTGlzdERlbGVnYXRlIHNlcnZpY2Ugd2lsbCBjb250cm9sIGFsbCBsaXN0cy4KICogVXNlIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNMaXN0RGVsZWdhdGUjJGdldEJ5SGFuZGxlICRnZXRCeUhhbmRsZX0KICogbWV0aG9kIHRvIGNvbnRyb2wgc3BlY2lmaWMgaW9uTGlzdCBpbnN0YW5jZXMuCiAqCiAqIEB1c2FnZQogKgogKiBgYGBgaHRtbAogKiA8aW9uLWNvbnRlbnQgbmctY29udHJvbGxlcj0iTXlDdHJsIj4KICogICA8YnV0dG9uIGNsYXNzPSJidXR0b24iIG5nLWNsaWNrPSJzaG93RGVsZXRlQnV0dG9ucygpIj48L2J1dHRvbj4KICogICA8aW9uLWxpc3Q+CiAqICAgICA8aW9uLWl0ZW0gbmctcmVwZWF0PSJpIGluIGl0ZW1zIj4KICogICAgICAgeyUgcmF3ICV9SGVsbG8sIHt7aX19IXslIGVuZHJhdyAlfQogKiAgICAgICA8aW9uLWRlbGV0ZS1idXR0b24gY2xhc3M9Imlvbi1taW51cy1jaXJjbGVkIj48L2lvbi1kZWxldGUtYnV0dG9uPgogKiAgICAgPC9pb24taXRlbT4KICogICA8L2lvbi1saXN0PgogKiA8L2lvbi1jb250ZW50PgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljTGlzdERlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNob3dEZWxldGVCdXR0b25zID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNMaXN0RGVsZWdhdGUuc2hvd0RlbGV0ZSh0cnVlKTsKICogICB9OwogKiB9CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLnNlcnZpY2UoJyRpb25pY0xpc3REZWxlZ2F0ZScsIGRlbGVnYXRlU2VydmljZShbCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZSNzaG93UmVvcmRlcgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3dSZW9yZGVyIFNldCB3aGV0aGVyIG9yIG5vdCB0aGlzIGxpc3QgaXMgc2hvd2luZyBpdHMgcmVvcmRlciBidXR0b25zLgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByZW9yZGVyIGJ1dHRvbnMgYXJlIHNob3duLgogICAqLwogICdzaG93UmVvcmRlcicsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZSNzaG93RGVsZXRlCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvd0RlbGV0ZSBTZXQgd2hldGhlciBvciBub3QgdGhpcyBsaXN0IGlzIHNob3dpbmcgaXRzIGRlbGV0ZSBidXR0b25zLgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBkZWxldGUgYnV0dG9ucyBhcmUgc2hvd24uCiAgICovCiAgJ3Nob3dEZWxldGUnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNMaXN0RGVsZWdhdGUjY2FuU3dpcGVJdGVtcwogICAqIEBwYXJhbSB7Ym9vbGVhbj19IGNhblN3aXBlSXRlbXMgU2V0IHdoZXRoZXIgb3Igbm90IHRoaXMgbGlzdCBpcyBhYmxlIHRvIHN3aXBlIHRvIHNob3cKICAgKiBvcHRpb24gYnV0dG9ucy4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgbGlzdCBpcyBhYmxlIHRvIHN3aXBlIHRvIHNob3cgb3B0aW9uIGJ1dHRvbnMuCiAgICovCiAgJ2NhblN3aXBlSXRlbXMnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNMaXN0RGVsZWdhdGUjY2xvc2VPcHRpb25CdXR0b25zCiAgICogQGRlc2NyaXB0aW9uIENsb3NlcyBhbnkgb3B0aW9uIGJ1dHRvbnMgb24gdGhlIGxpc3QgdGhhdCBhcmUgc3dpcGVkIG9wZW4uCiAgICovCiAgJ2Nsb3NlT3B0aW9uQnV0dG9ucycsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUKICAgKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlCiAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdH0gZGlyZWN0aXZlcyB3aXRoIGBkZWxlZ2F0ZS1oYW5kbGVgIG1hdGNoaW5nCiAgICogdGhlIGdpdmVuIGhhbmRsZS4KICAgKgogICAqIEV4YW1wbGU6IGAkaW9uaWNMaXN0RGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteS1oYW5kbGUnKS5zaG93UmVvcmRlcih0cnVlKTtgCiAgICovCl0pKQoKLmNvbnRyb2xsZXIoJyRpb25pY0xpc3QnLCBbCiAgJyRzY29wZScsCiAgJyRhdHRycycsCiAgJyRwYXJzZScsCiAgJyRpb25pY0xpc3REZWxlZ2F0ZScsCmZ1bmN0aW9uKCRzY29wZSwgJGF0dHJzLCAkcGFyc2UsICRpb25pY0xpc3REZWxlZ2F0ZSkgewoKICB2YXIgaXNTd2lwZWFibGUgPSB0cnVlOwogIHZhciBpc1Jlb3JkZXJTaG93biA9IGZhbHNlOwogIHZhciBpc0RlbGV0ZVNob3duID0gZmFsc2U7CgogIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNMaXN0RGVsZWdhdGUuX3JlZ2lzdGVySW5zdGFuY2UodGhpcywgJGF0dHJzLmRlbGVnYXRlSGFuZGxlKTsKICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGRlcmVnaXN0ZXJJbnN0YW5jZSk7CgogIHRoaXMuc2hvd1Jlb3JkZXIgPSBmdW5jdGlvbihzaG93KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBpc1Jlb3JkZXJTaG93biA9ICEhc2hvdzsKICAgIH0KICAgIHJldHVybiBpc1Jlb3JkZXJTaG93bjsKICB9OwoKICB0aGlzLnNob3dEZWxldGUgPSBmdW5jdGlvbihzaG93KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBpc0RlbGV0ZVNob3duID0gISFzaG93OwogICAgfQogICAgcmV0dXJuIGlzRGVsZXRlU2hvd247CiAgfTsKCiAgdGhpcy5jYW5Td2lwZUl0ZW1zID0gZnVuY3Rpb24oY2FuKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBpc1N3aXBlYWJsZSA9ICEhY2FuOwogICAgfQogICAgcmV0dXJuIGlzU3dpcGVhYmxlOwogIH07CgogIHRoaXMuY2xvc2VPcHRpb25CdXR0b25zID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLmxpc3RWaWV3ICYmIHRoaXMubGlzdFZpZXcuY2xlYXJEcmFnRWZmZWN0cygpOwogIH07Cn1dKTsKCklvbmljTW9kdWxlCi5jb250cm9sbGVyKCckaW9uaWNOYXZCYXInLCBbCiAgJyRzY29wZScsCiAgJyRlbGVtZW50JywKICAnJGF0dHJzJywKICAnJGlvbmljVmlld1NlcnZpY2UnLAogICckYW5pbWF0ZScsCiAgJyRjb21waWxlJywKICAnJGlvbmljTmF2QmFyRGVsZWdhdGUnLApmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsICRpb25pY1ZpZXdTZXJ2aWNlLCAkYW5pbWF0ZSwgJGNvbXBpbGUsICRpb25pY05hdkJhckRlbGVnYXRlKSB7CiAgLy9MZXQgdGhlIHBhcmVudCBrbm93IGFib3V0IG91ciBjb250cm9sbGVyIHRvbyBzbyB0aGF0IGNoaWxkcmVuIG9mCiAgLy9zaWJsaW5nIGNvbnRlbnQgZWxlbWVudHMgY2FuIGtub3cgYWJvdXQgdXMKICAkZWxlbWVudC5wYXJlbnQoKS5kYXRhKCckaW9uTmF2QmFyQ29udHJvbGxlcicsIHRoaXMpOwoKICB2YXIgZGVyZWdpc3Rlckluc3RhbmNlID0gJGlvbmljTmF2QmFyRGVsZWdhdGUuX3JlZ2lzdGVySW5zdGFuY2UodGhpcywgJGF0dHJzLmRlbGVnYXRlSGFuZGxlKTsKCiAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBkZXJlZ2lzdGVySW5zdGFuY2UpOwoKICAkc2NvcGUuJG9uKCckdmlld0hpc3RvcnkuaGlzdG9yeUNoYW5nZScsIGZ1bmN0aW9uKGUsIGRhdGEpIHsKICAgIGJhY2tJc1Nob3duID0gISFkYXRhLnNob3dCYWNrOwogIH0pOwoKICB2YXIgc2VsZiA9IHRoaXM7CgogIHRoaXMubGVmdEJ1dHRvbnNFbGVtZW50ID0ganFMaXRlKAogICAgJGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLmJ1dHRvbnMubGVmdC1idXR0b25zJykKICApOwogIHRoaXMucmlnaHRCdXR0b25zRWxlbWVudCA9IGpxTGl0ZSgKICAgICRlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJy5idXR0b25zLnJpZ2h0LWJ1dHRvbnMnKQogICk7CgogIHRoaXMuYmFjayA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGJhY2tWaWV3ID0gJGlvbmljVmlld1NlcnZpY2UuZ2V0QmFja1ZpZXcoKTsKICAgIGJhY2tWaWV3ICYmIGJhY2tWaWV3LmdvKCk7CiAgICByZXR1cm4gZmFsc2U7CiAgfTsKCiAgdGhpcy5hbGlnbiA9IGZ1bmN0aW9uKGRpcmVjdGlvbikgewogICAgdGhpcy5faGVhZGVyQmFyVmlldy5hbGlnbihkaXJlY3Rpb24pOwogIH07CgogIHRoaXMuc2hvd0JhY2tCdXR0b24gPSBmdW5jdGlvbihzaG93KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAkc2NvcGUuYmFja0J1dHRvblNob3duID0gISFzaG93OwogICAgfQogICAgcmV0dXJuICEhKCRzY29wZS5oYXNCYWNrQnV0dG9uICYmICRzY29wZS5iYWNrQnV0dG9uU2hvd24pOwogIH07CgogIHRoaXMuc2hvd0JhciA9IGZ1bmN0aW9uKHNob3cpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICRzY29wZS5pc0ludmlzaWJsZSA9ICFzaG93OwogICAgICAkc2NvcGUuJHBhcmVudC4kaGFzSGVhZGVyID0gISFzaG93OwogICAgfQogICAgcmV0dXJuICEkc2NvcGUuaXNJbnZpc2libGU7CiAgfTsKCiAgdGhpcy5zZXRUaXRsZSA9IGZ1bmN0aW9uKHRpdGxlKSB7CiAgICBpZiAoJHNjb3BlLnRpdGxlID09PSB0aXRsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICAkc2NvcGUub2xkVGl0bGUgPSAkc2NvcGUudGl0bGU7CiAgICAkc2NvcGUudGl0bGUgPSB0aXRsZSB8fCAnJzsKICB9OwoKICB0aGlzLmNoYW5nZVRpdGxlID0gZnVuY3Rpb24odGl0bGUsIGRpcmVjdGlvbikgewogICAgaWYgKCRzY29wZS50aXRsZSA9PT0gdGl0bGUpIHsKICAgICAgLy8gaWYgd2UncmUgbm90IGFuaW1hdGluZyB0aGUgdGl0bGUsIGJ1dCB0aGUgYmFjayBidXR0b24gYmVjb21lcyBpbnZpc2libGUKICAgICAgaWYodHlwZW9mIGJhY2tJc1Nob3duICE9ICd1bmRlZmluZWQnICYmICFiYWNrSXNTaG93biAmJiAkc2NvcGUuYmFja0J1dHRvblNob3duKXsKICAgICAgICBqcUxpdGUoJGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLmJhY2stYnV0dG9uJykpLmFkZENsYXNzKCduZy1oaWRlJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5zZXRUaXRsZSh0aXRsZSk7CiAgICAkc2NvcGUuaXNSZXZlcnNlID0gZGlyZWN0aW9uID09ICdiYWNrJzsKICAgICRzY29wZS5zaG91bGRBbmltYXRlID0gISFkaXJlY3Rpb247CgogICAgaWYgKCEkc2NvcGUuc2hvdWxkQW5pbWF0ZSkgewogICAgICAvL1dlJ3JlIGRvbmUhCiAgICAgIHRoaXMuX2hlYWRlckJhclZpZXcuYWxpZ24oKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2FuaW1hdGVUaXRsZXMoKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH07CgogIHRoaXMuZ2V0VGl0bGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiAkc2NvcGUudGl0bGUgfHwgJyc7CiAgfTsKCiAgdGhpcy5nZXRQcmV2aW91c1RpdGxlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gJHNjb3BlLm9sZFRpdGxlIHx8ICcnOwogIH07CgogIC8qKgogICAqIEV4cG9zZWQgZm9yIHRlc3RpbmcKICAgKi8KICB0aGlzLl9hbmltYXRlVGl0bGVzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgb2xkVGl0bGVFbCwgbmV3VGl0bGVFbCwgY3VycmVudFRpdGxlczsKCiAgICAvL0lmIHdlIGhhdmUgYW55IHRpdGxlIHJpZ2h0IG5vdwogICAgLy8ob3IgbW9yZSB0aGFuIG9uZSwgdGhleSBjb3VsZCBiZSB0cmFuc2l0aW9uaW5nIG9uIHN3aXRjaCksCiAgICAvL3JlcGxhY2UgdGhlIGZpcnN0IG9uZSB3aXRoIGFuIG9sZFRpdGxlIGVsZW1lbnQKICAgIGN1cnJlbnRUaXRsZXMgPSAkZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yQWxsKCcudGl0bGUnKTsKICAgIGlmIChjdXJyZW50VGl0bGVzLmxlbmd0aCkgewogICAgICBvbGRUaXRsZUVsID0gJGNvbXBpbGUoJzxoMSBjbGFzcz0idGl0bGUiIG5nLWJpbmQtaHRtbD0ib2xkVGl0bGUiPjwvaDE+JykoJHNjb3BlKTsKICAgICAganFMaXRlKGN1cnJlbnRUaXRsZXNbMF0pLnJlcGxhY2VXaXRoKG9sZFRpdGxlRWwpOwogICAgfQogICAgLy9Db21waWxlIG5ldyB0aXRsZQogICAgbmV3VGl0bGVFbCA9ICRjb21waWxlKCc8aDEgY2xhc3M9InRpdGxlIGludmlzaWJsZSIgbmctYmluZC1odG1sPSJ0aXRsZSI+PC9oMT4nKSgkc2NvcGUpOwoKICAgIC8vQW5pbWF0ZSBpbiBvbiBuZXh0IGZyYW1lCiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CgogICAgICBvbGRUaXRsZUVsICYmICRhbmltYXRlLmxlYXZlKGpxTGl0ZShvbGRUaXRsZUVsKSk7CgogICAgICB2YXIgaW5zZXJ0ID0gb2xkVGl0bGVFbCAmJiBqcUxpdGUob2xkVGl0bGVFbCkgfHwgbnVsbDsKICAgICAgJGFuaW1hdGUuZW50ZXIobmV3VGl0bGVFbCwgJGVsZW1lbnQsIGluc2VydCwgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5faGVhZGVyQmFyVmlldy5hbGlnbigpOwogICAgICB9KTsKCiAgICAgIC8vQ2xlYW51cCBhbnkgb2xkIHRpdGxlcyBsZWZ0b3ZlciAoYmVzaWRlcyB0aGUgb25lIHdlIGFscmVhZHkgZGlkIHJlcGxhY2VXaXRoIG9uKQogICAgICBmb3JFYWNoKGN1cnJlbnRUaXRsZXMsIGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgaWYgKGVsICYmIGVsLnBhcmVudE5vZGUpIHsKICAgICAgICAgIC8vVXNlIC5yZW1vdmUoKSB0byBjbGVhbnVwIHRoaW5ncyBsaWtlIC5kYXRhKCkKICAgICAgICAgIGpxTGl0ZShlbCkucmVtb3ZlKCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vJGFwcGx5IHNvIGJpbmRpbmdzIGZpcmUKICAgICAgJHNjb3BlLiRkaWdlc3QoKTsKCiAgICAgIC8vU3RvcCBmbGlja2VyIG9mIG5ldyB0aXRsZSBvbiBpb3M3CiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICBuZXdUaXRsZUVsWzBdLmNsYXNzTGlzdC5yZW1vdmUoJ2ludmlzaWJsZScpOwogICAgICB9KTsKICAgIH0pOwogIH07Cn1dKTsKCgovKioKICogQHByaXZhdGUKICovCklvbmljTW9kdWxlCgouZmFjdG9yeSgnJCRzY3JvbGxWYWx1ZUNhY2hlJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHt9Owp9KQoKLmNvbnRyb2xsZXIoJyRpb25pY1Njcm9sbCcsIFsKICAnJHNjb3BlJywKICAnc2Nyb2xsVmlld09wdGlvbnMnLAogICckdGltZW91dCcsCiAgJyR3aW5kb3cnLAogICckJHNjcm9sbFZhbHVlQ2FjaGUnLAogICckbG9jYXRpb24nLAogICckcm9vdFNjb3BlJywKICAnJGRvY3VtZW50JywKICAnJGlvbmljU2Nyb2xsRGVsZWdhdGUnLApmdW5jdGlvbigkc2NvcGUsIHNjcm9sbFZpZXdPcHRpb25zLCAkdGltZW91dCwgJHdpbmRvdywgJCRzY3JvbGxWYWx1ZUNhY2hlLCAkbG9jYXRpb24sICRyb290U2NvcGUsICRkb2N1bWVudCwgJGlvbmljU2Nyb2xsRGVsZWdhdGUpIHsKCiAgdmFyIHNlbGYgPSB0aGlzOwogIC8vIGZvciB0ZXN0aW5nCiAgdGhpcy5fX3RpbWVvdXQgPSAkdGltZW91dDsKCiAgdGhpcy5fc2Nyb2xsVmlld09wdGlvbnMgPSBzY3JvbGxWaWV3T3B0aW9uczsgLy9mb3IgdGVzdGluZwoKICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudCA9IHNjcm9sbFZpZXdPcHRpb25zLmVsOwogIHZhciAkZWxlbWVudCA9IHRoaXMuJGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CiAgdmFyIHNjcm9sbFZpZXcgPSB0aGlzLnNjcm9sbFZpZXcgPSBuZXcgaW9uaWMudmlld3MuU2Nyb2xsKHNjcm9sbFZpZXdPcHRpb25zKTsKCiAgLy9BdHRhY2ggc2VsZiB0byBlbGVtZW50IGFzIGEgY29udHJvbGxlciBzbyBvdGhlciBkaXJlY3RpdmVzIGNhbiByZXF1aXJlIHRoaXMgY29udHJvbGxlcgogIC8vdGhyb3VnaCBgcmVxdWlyZTogJyRpb25pY1Njcm9sbCcKICAvL0Fsc28gYXR0YWNoIHRvIHBhcmVudCBzbyB0aGF0IHNpYmxpbmcgZWxlbWVudHMgY2FuIHJlcXVpcmUgdGhpcwogICgkZWxlbWVudC5wYXJlbnQoKS5sZW5ndGggPyAkZWxlbWVudC5wYXJlbnQoKSA6ICRlbGVtZW50KQogICAgLmRhdGEoJyQkaW9uaWNTY3JvbGxDb250cm9sbGVyJywgdGhpcyk7CgogIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZSgKICAgIHRoaXMsIHNjcm9sbFZpZXdPcHRpb25zLmRlbGVnYXRlSGFuZGxlCiAgKTsKCiAgaWYgKCFhbmd1bGFyLmlzRGVmaW5lZChzY3JvbGxWaWV3T3B0aW9ucy5ib3VuY2luZykpIHsKICAgIGlvbmljLlBsYXRmb3JtLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgICBzY3JvbGxWaWV3Lm9wdGlvbnMuYm91bmNpbmcgPSB0cnVlOwoKICAgICAgaWYoaW9uaWMuUGxhdGZvcm0uaXNBbmRyb2lkKCkpIHsKICAgICAgICAvLyBObyBib3VuY2luZyBieSBkZWZhdWx0IG9uIEFuZHJvaWQKICAgICAgICBzY3JvbGxWaWV3Lm9wdGlvbnMuYm91bmNpbmcgPSBmYWxzZTsKICAgICAgICAvLyBGYXN0ZXIgc2Nyb2xsIGRlY2VsCiAgICAgICAgc2Nyb2xsVmlldy5vcHRpb25zLmRlY2VsZXJhdGlvbiA9IDAuOTU7CiAgICAgIH0gZWxzZSB7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgdmFyIHJlc2l6ZSA9IGFuZ3VsYXIuYmluZChzY3JvbGxWaWV3LCBzY3JvbGxWaWV3LnJlc2l6ZSk7CiAgaW9uaWMub24oJ3Jlc2l6ZScsIHJlc2l6ZSwgJHdpbmRvdyk7CgogIC8vIHNldCBieSByb290U2NvcGUgbGlzdGVuZXIgaWYgbmVlZGVkCiAgdmFyIGJhY2tMaXN0ZW5Eb25lID0gYW5ndWxhci5ub29wOwogIHZhciB2aWV3Q29udGVudExvYWRlZCA9IGFuZ3VsYXIubm9vcDsKCiAgdmFyIHNjcm9sbEZ1bmMgPSBmdW5jdGlvbihlKSB7CiAgICB2YXIgZGV0YWlsID0gKGUub3JpZ2luYWxFdmVudCB8fCBlKS5kZXRhaWwgfHwge307CiAgICAkc2NvcGUuJG9uU2Nyb2xsICYmICRzY29wZS4kb25TY3JvbGwoewogICAgICBldmVudDogZSwKICAgICAgc2Nyb2xsVG9wOiBkZXRhaWwuc2Nyb2xsVG9wIHx8IDAsCiAgICAgIHNjcm9sbExlZnQ6IGRldGFpbC5zY3JvbGxMZWZ0IHx8IDAKICAgIH0pOwogIH07CgogICRlbGVtZW50Lm9uKCdzY3JvbGwnLCBzY3JvbGxGdW5jICk7CgogICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICBkZXJlZ2lzdGVySW5zdGFuY2UoKTsKICAgIHNjcm9sbFZpZXcuX19jbGVhbnVwKCk7CiAgICBpb25pYy5vZmYoJ3Jlc2l6ZScsIHJlc2l6ZSwgJHdpbmRvdyk7CiAgICAkd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHJlc2l6ZSk7CiAgICB2aWV3Q29udGVudExvYWRlZCgpOwogICAgYmFja0xpc3RlbkRvbmUoKTsKICAgIGlmIChzZWxmLl9yZW1lbWJlclNjcm9sbElkKSB7CiAgICAgICQkc2Nyb2xsVmFsdWVDYWNoZVtzZWxmLl9yZW1lbWJlclNjcm9sbElkXSA9IHNjcm9sbFZpZXcuZ2V0VmFsdWVzKCk7CiAgICB9CiAgICBzY3JvbGxWaWV3T3B0aW9ucyA9IG51bGw7CiAgICBzZWxmLl9zY3JvbGxWaWV3T3B0aW9ucyA9IG51bGw7CiAgICBzZWxmLmVsZW1lbnQgPSBudWxsOwogICAgJGVsZW1lbnQub2ZmKCdzY3JvbGwnLCBzY3JvbGxGdW5jKTsKICAgICRlbGVtZW50ID0gbnVsbDsKICAgIHNlbGYuJGVsZW1lbnQgPSBudWxsOwogICAgc2VsZi5zY3JvbGxWaWV3ID0gbnVsbDsKICAgIHNjcm9sbFZpZXcgPSBudWxsOwogIH0pOwoKICB2aWV3Q29udGVudExvYWRlZCA9ICRzY29wZS4kb24oJyR2aWV3Q29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUsIGhpc3RvcnlEYXRhKSB7CiAgICAvL29ubHkgdGhlIHRvcC1tb3N0IHNjcm9sbCBhcmVhIHVuZGVyIGEgdmlldyBzaG91bGQgcmVtZW1iZXIgdGhhdCB2aWV3J3MKICAgIC8vc2Nyb2xsIHBvc2l0aW9uCiAgICBpZiAoZS5kZWZhdWx0UHJldmVudGVkKSB7IHJldHVybjsgfQogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgIHZhciB2aWV3SWQgPSBoaXN0b3J5RGF0YSAmJiBoaXN0b3J5RGF0YS52aWV3SWQgfHwgJHNjb3BlLiRoaXN0b3J5SWQ7CiAgICBpZiAodmlld0lkKSB7CiAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYucmVtZW1iZXJTY3JvbGxQb3NpdGlvbih2aWV3SWQpOwogICAgICAgIHNlbGYuc2Nyb2xsVG9SZW1lbWJlcmVkUG9zaXRpb24oKTsKCiAgICAgICAgYmFja0xpc3RlbkRvbmUgPSAkcm9vdFNjb3BlLiRvbignJHZpZXdIaXN0b3J5LnZpZXdCYWNrJywgZnVuY3Rpb24oZSwgZnJvbVZpZXdJZCwgdG9WaWV3SWQpIHsKICAgICAgICAgIC8vV2hlbiBnb2luZyBiYWNrIGZyb20gdGhpcyB2aWV3LCBmb3JnZXQgaXRzIHNhdmVkIHNjcm9sbCBwb3NpdGlvbgogICAgICAgICAgaWYgKHZpZXdJZCA9PT0gZnJvbVZpZXdJZCkgewogICAgICAgICAgICBzZWxmLmZvcmdldFNjcm9sbFBvc2l0aW9uKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sIDAsIGZhbHNlKTsKICAgIH0KICB9KTsKCiAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICBzY3JvbGxWaWV3LnJ1bigpOwogIH0pOwoKICB0aGlzLl9yZW1lbWJlclNjcm9sbElkID0gbnVsbDsKCiAgdGhpcy5nZXRTY3JvbGxWaWV3ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3OwogIH07CgogIHRoaXMuZ2V0U2Nyb2xsUG9zaXRpb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuZ2V0VmFsdWVzKCk7CiAgfTsKCiAgdGhpcy5yZXNpemUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiAkdGltZW91dChyZXNpemUpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICRlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCdzY3JvbGwucmVzaXplJyk7CiAgICB9KTsKICB9OwoKICB0aGlzLnNjcm9sbFRvcCA9IGZ1bmN0aW9uKHNob3VsZEFuaW1hdGUpIHsKICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgc2Nyb2xsVmlldy5zY3JvbGxUbygwLCAwLCAhIXNob3VsZEFuaW1hdGUpOwogICAgfSk7CiAgfTsKCiAgdGhpcy5zY3JvbGxCb3R0b20gPSBmdW5jdGlvbihzaG91bGRBbmltYXRlKSB7CiAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHZhciBtYXggPSBzY3JvbGxWaWV3LmdldFNjcm9sbE1heCgpOwogICAgICBzY3JvbGxWaWV3LnNjcm9sbFRvKG1heC5sZWZ0LCBtYXgudG9wLCAhIXNob3VsZEFuaW1hdGUpOwogICAgfSk7CiAgfTsKCiAgdGhpcy5zY3JvbGxUbyA9IGZ1bmN0aW9uKGxlZnQsIHRvcCwgc2hvdWxkQW5pbWF0ZSkgewogICAgdGhpcy5yZXNpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBzY3JvbGxWaWV3LnNjcm9sbFRvKGxlZnQsIHRvcCwgISFzaG91bGRBbmltYXRlKTsKICAgIH0pOwogIH07CgogIHRoaXMuem9vbVRvID0gZnVuY3Rpb24oem9vbSwgc2hvdWxkQW5pbWF0ZSwgb3JpZ2luTGVmdCwgb3JpZ2luVG9wKSB7CiAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHNjcm9sbFZpZXcuem9vbVRvKHpvb20sICEhc2hvdWxkQW5pbWF0ZSwgb3JpZ2luTGVmdCwgb3JpZ2luVG9wKTsKICAgIH0pOwogIH07CgogIHRoaXMuem9vbUJ5ID0gZnVuY3Rpb24oem9vbSwgc2hvdWxkQW5pbWF0ZSwgb3JpZ2luTGVmdCwgb3JpZ2luVG9wKSB7CiAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHNjcm9sbFZpZXcuem9vbUJ5KHpvb20sICEhc2hvdWxkQW5pbWF0ZSwgb3JpZ2luTGVmdCwgb3JpZ2luVG9wKTsKICAgIH0pOwogIH07CgogIHRoaXMuc2Nyb2xsQnkgPSBmdW5jdGlvbihsZWZ0LCB0b3AsIHNob3VsZEFuaW1hdGUpIHsKICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgc2Nyb2xsVmlldy5zY3JvbGxCeShsZWZ0LCB0b3AsICEhc2hvdWxkQW5pbWF0ZSk7CiAgICB9KTsKICB9OwoKICB0aGlzLmFuY2hvclNjcm9sbCA9IGZ1bmN0aW9uKHNob3VsZEFuaW1hdGUpIHsKICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgdmFyIGhhc2ggPSAkbG9jYXRpb24uaGFzaCgpOwogICAgICB2YXIgZWxtID0gaGFzaCAmJiAkZG9jdW1lbnRbMF0uZ2V0RWxlbWVudEJ5SWQoaGFzaCk7CiAgICAgIGlmICghKGhhc2ggJiYgZWxtKSkgewogICAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsVG8oMCwwLCAhIXNob3VsZEFuaW1hdGUpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgY3VyRWxtID0gZWxtOwogICAgICB2YXIgc2Nyb2xsTGVmdCA9IDAsIHNjcm9sbFRvcCA9IDAsIGxldmVsc0NsaW1iZWQgPSAwOwogICAgICBkbyB7CiAgICAgICAgaWYoY3VyRWxtICE9PSBudWxsKXNjcm9sbExlZnQgKz0gY3VyRWxtLm9mZnNldExlZnQ7CiAgICAgICAgaWYoY3VyRWxtICE9PSBudWxsKXNjcm9sbFRvcCArPSBjdXJFbG0ub2Zmc2V0VG9wOwogICAgICAgIGN1ckVsbSA9IGN1ckVsbS5vZmZzZXRQYXJlbnQ7CiAgICAgICAgbGV2ZWxzQ2xpbWJlZCsrOwogICAgICB9IHdoaWxlIChjdXJFbG0uYXR0cmlidXRlcyAhPSBzZWxmLmVsZW1lbnQuYXR0cmlidXRlcyAmJiBjdXJFbG0ub2Zmc2V0UGFyZW50KTsKICAgICAgc2Nyb2xsVmlldy5zY3JvbGxUbyhzY3JvbGxMZWZ0LCBzY3JvbGxUb3AsICEhc2hvdWxkQW5pbWF0ZSk7CiAgICB9KTsKICB9OwoKICB0aGlzLnJlbWVtYmVyU2Nyb2xsUG9zaXRpb24gPSBmdW5jdGlvbihpZCkgewogICAgaWYgKCFpZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk11c3Qgc3VwcGx5IGFuIGlkIHRvIHJlbWVtYmVyIHRoZSBzY3JvbGwgYnkhIik7CiAgICB9CiAgICB0aGlzLl9yZW1lbWJlclNjcm9sbElkID0gaWQ7CiAgfTsKICB0aGlzLmZvcmdldFNjcm9sbFBvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgICBkZWxldGUgJCRzY3JvbGxWYWx1ZUNhY2hlW3RoaXMuX3JlbWVtYmVyU2Nyb2xsSWRdOwogICAgdGhpcy5fcmVtZW1iZXJTY3JvbGxJZCA9IG51bGw7CiAgfTsKICB0aGlzLnNjcm9sbFRvUmVtZW1iZXJlZFBvc2l0aW9uID0gZnVuY3Rpb24oc2hvdWxkQW5pbWF0ZSkgewogICAgdmFyIHZhbHVlcyA9ICQkc2Nyb2xsVmFsdWVDYWNoZVt0aGlzLl9yZW1lbWJlclNjcm9sbElkXTsKICAgIGlmICh2YWx1ZXMpIHsKICAgICAgdGhpcy5yZXNpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsVG8oK3ZhbHVlcy5sZWZ0LCArdmFsdWVzLnRvcCwgc2hvdWxkQW5pbWF0ZSk7CiAgICAgIH0pOwogICAgfQogIH07CgogIC8qKgogICAqIEBwcml2YXRlCiAgICovCiAgdGhpcy5fc2V0UmVmcmVzaGVyID0gZnVuY3Rpb24ocmVmcmVzaGVyU2NvcGUsIHJlZnJlc2hlckVsZW1lbnQpIHsKICAgIHZhciByZWZyZXNoZXIgPSB0aGlzLnJlZnJlc2hlciA9IHJlZnJlc2hlckVsZW1lbnQ7CiAgICB2YXIgcmVmcmVzaGVySGVpZ2h0ID0gc2VsZi5yZWZyZXNoZXIuY2xpZW50SGVpZ2h0IHx8IDA7CiAgICBzY3JvbGxWaWV3LmFjdGl2YXRlUHVsbFRvUmVmcmVzaChyZWZyZXNoZXJIZWlnaHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyBhY3RpdmF0ZUNhbGxiYWNrCiAgICAgIHJlZnJlc2hlci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgcmVmcmVzaGVyU2NvcGUuJG9uUHVsbGluZygpOwogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIGRlYWN0aXZhdGVDYWxsYmFjawogICAgICAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgIHJlZnJlc2hlci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICByZWZyZXNoZXIuY2xhc3NMaXN0LnJlbW92ZSgncmVmcmVzaGluZycpOwogICAgICAgIHJlZnJlc2hlci5jbGFzc0xpc3QuYWRkKCdpbnZpc2libGUnKTsKICAgICAgfSwzMDApOwogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIHN0YXJ0Q2FsbGJhY2sKICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5hZGQoJ3JlZnJlc2hpbmcnKTsKICAgICAgcmVmcmVzaGVyU2NvcGUuJG9uUmVmcmVzaCgpOwogICAgfSxmdW5jdGlvbigpewogICAgICAvLyBzaG93Q2FsbGJhY2sKICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2ludmlzaWJsZScpOwogICAgfSxmdW5jdGlvbigpewogICAgICAvLyBoaWRlQ2FsbGJhY2sKICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5hZGQoJ2ludmlzaWJsZScpOwogICAgfSk7CiAgfTsKfV0pOwoKCklvbmljTW9kdWxlCi5jb250cm9sbGVyKCckaW9uaWNTaWRlTWVudXMnLCBbCiAgJyRzY29wZScsCiAgJyRhdHRycycsCiAgJyRpb25pY1NpZGVNZW51RGVsZWdhdGUnLAogICckaW9uaWNQbGF0Zm9ybScsCiAgJyRpb25pY0JvZHknLApmdW5jdGlvbigkc2NvcGUsICRhdHRycywgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSwgJGlvbmljUGxhdGZvcm0sICRpb25pY0JvZHkpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyIHJpZ2h0U2hvd2luZywgbGVmdFNob3dpbmcsIGlzRHJhZ2dpbmc7CiAgdmFyIHN0YXJ0WCwgbGFzdFgsIG9mZnNldFgsIGlzQXNpZGVFeHBvc2VkOwoKICBzZWxmLiRzY29wZSA9ICRzY29wZTsKCiAgc2VsZi5pbml0aWFsaXplID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgc2VsZi5sZWZ0ID0gb3B0aW9ucy5sZWZ0OwogICAgc2VsZi5yaWdodCA9IG9wdGlvbnMucmlnaHQ7CiAgICBzZWxmLnNldENvbnRlbnQob3B0aW9ucy5jb250ZW50KTsKICAgIHNlbGYuZHJhZ1RocmVzaG9sZFggPSBvcHRpb25zLmRyYWdUaHJlc2hvbGRYIHx8IDEwOwogIH07CgogIC8qKgogICAqIFNldCB0aGUgY29udGVudCB2aWV3IGNvbnRyb2xsZXIgaWYgbm90IHBhc3NlZCBpbiB0aGUgY29uc3RydWN0b3Igb3B0aW9ucy4KICAgKgogICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZW50CiAgICovCiAgc2VsZi5zZXRDb250ZW50ID0gZnVuY3Rpb24oY29udGVudCkgewogICAgaWYoY29udGVudCkgewogICAgICBzZWxmLmNvbnRlbnQgPSBjb250ZW50OwoKICAgICAgc2VsZi5jb250ZW50Lm9uRHJhZyA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBzZWxmLl9oYW5kbGVEcmFnKGUpOwogICAgICB9OwoKICAgICAgc2VsZi5jb250ZW50LmVuZERyYWcgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgc2VsZi5fZW5kRHJhZyhlKTsKICAgICAgfTsKICAgIH0KICB9OwoKICBzZWxmLmlzT3BlbkxlZnQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZWxmLmdldE9wZW5BbW91bnQoKSA+IDA7CiAgfTsKCiAgc2VsZi5pc09wZW5SaWdodCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlbGYuZ2V0T3BlbkFtb3VudCgpIDwgMDsKICB9OwoKICAvKioKICAgKiBUb2dnbGUgdGhlIGxlZnQgbWVudSB0byBvcGVuIDEwMCUKICAgKi8KICBzZWxmLnRvZ2dsZUxlZnQgPSBmdW5jdGlvbihzaG91bGRPcGVuKSB7CiAgICB2YXIgb3BlbkFtb3VudCA9IHNlbGYuZ2V0T3BlbkFtb3VudCgpOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgc2hvdWxkT3BlbiA9IG9wZW5BbW91bnQgPD0gMDsKICAgIH0KICAgIHNlbGYuY29udGVudC5lbmFibGVBbmltYXRpb24oKTsKICAgIGlmKCFzaG91bGRPcGVuKSB7CiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoMCk7CiAgICB9IGVsc2UgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKDEwMCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogVG9nZ2xlIHRoZSByaWdodCBtZW51IHRvIG9wZW4gMTAwJQogICAqLwogIHNlbGYudG9nZ2xlUmlnaHQgPSBmdW5jdGlvbihzaG91bGRPcGVuKSB7CiAgICB2YXIgb3BlbkFtb3VudCA9IHNlbGYuZ2V0T3BlbkFtb3VudCgpOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgc2hvdWxkT3BlbiA9IG9wZW5BbW91bnQgPj0gMDsKICAgIH0KICAgIHNlbGYuY29udGVudC5lbmFibGVBbmltYXRpb24oKTsKICAgIGlmKCFzaG91bGRPcGVuKSB7CiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoMCk7CiAgICB9IGVsc2UgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKC0xMDApOwogICAgfQogIH07CgogIC8qKgogICAqIENsb3NlIGFsbCBtZW51cy4KICAgKi8KICBzZWxmLmNsb3NlID0gZnVuY3Rpb24oKSB7CiAgICBzZWxmLm9wZW5QZXJjZW50YWdlKDApOwogIH07CgogIC8qKgogICAqIEByZXR1cm4ge2Zsb2F0fSBUaGUgYW1vdW50IHRoZSBzaWRlIG1lbnUgaXMgb3BlbiwgZWl0aGVyIHBvc2l0aXZlIG9yIG5lZ2F0aXZlIGZvciBsZWZ0IChwb3NpdGl2ZSksIG9yIHJpZ2h0IChuZWdhdGl2ZSkKICAgKi8KICBzZWxmLmdldE9wZW5BbW91bnQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZWxmLmNvbnRlbnQgJiYgc2VsZi5jb250ZW50LmdldFRyYW5zbGF0ZVgoKSB8fCAwOwogIH07CgogIC8qKgogICAqIEByZXR1cm4ge2Zsb2F0fSBUaGUgcmF0aW8gb2Ygb3BlbiBhbW91bnQgb3ZlciBtZW51IHdpZHRoLiBGb3IgZXhhbXBsZSwgYQogICAqIG1lbnUgb2Ygd2lkdGggMTAwIG9wZW4gNTAgcGl4ZWxzIHdvdWxkIGJlIG9wZW4gNTAlIG9yIGEgcmF0aW8gb2YgMC41LiBWYWx1ZSBpcyBuZWdhdGl2ZQogICAqIGZvciByaWdodCBtZW51LgogICAqLwogIHNlbGYuZ2V0T3BlblJhdGlvID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYW1vdW50ID0gc2VsZi5nZXRPcGVuQW1vdW50KCk7CiAgICBpZihhbW91bnQgPj0gMCkgewogICAgICByZXR1cm4gYW1vdW50IC8gc2VsZi5sZWZ0LndpZHRoOwogICAgfQogICAgcmV0dXJuIGFtb3VudCAvIHNlbGYucmlnaHQud2lkdGg7CiAgfTsKCiAgc2VsZi5pc09wZW4gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZWxmLmdldE9wZW5BbW91bnQoKSAhPT0gMDsKICB9OwoKICAvKioKICAgKiBAcmV0dXJuIHtmbG9hdH0gVGhlIHBlcmNlbnRhZ2Ugb2Ygb3BlbiBhbW91bnQgb3ZlciBtZW51IHdpZHRoLiBGb3IgZXhhbXBsZSwgYQogICAqIG1lbnUgb2Ygd2lkdGggMTAwIG9wZW4gNTAgcGl4ZWxzIHdvdWxkIGJlIG9wZW4gNTAlLiBWYWx1ZSBpcyBuZWdhdGl2ZQogICAqIGZvciByaWdodCBtZW51LgogICAqLwogIHNlbGYuZ2V0T3BlblBlcmNlbnRhZ2UgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZWxmLmdldE9wZW5SYXRpbygpICogMTAwOwogIH07CgogIC8qKgogICAqIE9wZW4gdGhlIG1lbnUgd2l0aCBhIGdpdmVuIHBlcmNlbnRhZ2UgYW1vdW50LgogICAqIEBwYXJhbSB7ZmxvYXR9IHBlcmNlbnRhZ2UgVGhlIHBlcmNlbnRhZ2UgKHBvc2l0aXZlIG9yIG5lZ2F0aXZlIGZvciBsZWZ0L3JpZ2h0KSB0byBvcGVuIHRoZSBtZW51LgogICAqLwogIHNlbGYub3BlblBlcmNlbnRhZ2UgPSBmdW5jdGlvbihwZXJjZW50YWdlKSB7CiAgICB2YXIgcCA9IHBlcmNlbnRhZ2UgLyAxMDA7CgogICAgaWYoc2VsZi5sZWZ0ICYmIHBlcmNlbnRhZ2UgPj0gMCkgewogICAgICBzZWxmLm9wZW5BbW91bnQoc2VsZi5sZWZ0LndpZHRoICogcCk7CiAgICB9IGVsc2UgaWYoc2VsZi5yaWdodCAmJiBwZXJjZW50YWdlIDwgMCkgewogICAgICB2YXIgbWF4UmlnaHQgPSBzZWxmLnJpZ2h0LndpZHRoOwogICAgICBzZWxmLm9wZW5BbW91bnQoc2VsZi5yaWdodC53aWR0aCAqIHApOwogICAgfQoKICAgIC8vIGFkZCB0aGUgQ1NTIGNsYXNzICJtZW51LW9wZW4iIGlmIHRoZSBwZXJjZW50YWdlIGRvZXMgbm90CiAgICAvLyBlcXVhbCAwLCBvdGhlcndpc2UgcmVtb3ZlIHRoZSBjbGFzcyBmcm9tIHRoZSBib2R5IGVsZW1lbnQKICAgICRpb25pY0JvZHkuZW5hYmxlQ2xhc3MoIChwZXJjZW50YWdlICE9PSAwKSwgJ21lbnUtb3BlbicpOwogIH07CgogIC8qKgogICAqIE9wZW4gdGhlIG1lbnUgdGhlIGdpdmVuIHBpeGVsIGFtb3VudC4KICAgKiBAcGFyYW0ge2Zsb2F0fSBhbW91bnQgdGhlIHBpeGVsIGFtb3VudCB0byBvcGVuIHRoZSBtZW51LiBQb3NpdGl2ZSB2YWx1ZSBmb3IgbGVmdCBtZW51LAogICAqIG5lZ2F0aXZlIHZhbHVlIGZvciByaWdodCBtZW51IChvbmx5IG9uZSBtZW51IHdpbGwgYmUgdmlzaWJsZSBhdCBhIHRpbWUpLgogICAqLwogIHNlbGYub3BlbkFtb3VudCA9IGZ1bmN0aW9uKGFtb3VudCkgewogICAgdmFyIG1heExlZnQgPSBzZWxmLmxlZnQgJiYgc2VsZi5sZWZ0LndpZHRoIHx8IDA7CiAgICB2YXIgbWF4UmlnaHQgPSBzZWxmLnJpZ2h0ICYmIHNlbGYucmlnaHQud2lkdGggfHwgMDsKCiAgICAvLyBDaGVjayBpZiB3ZSBjYW4gbW92ZSB0byB0aGF0IHNpZGUsIGRlcGVuZGluZyBpZiB0aGUgbGVmdC9yaWdodCBwYW5lbCBpcyBlbmFibGVkCiAgICBpZighKHNlbGYubGVmdCAmJiBzZWxmLmxlZnQuaXNFbmFibGVkKSAmJiBhbW91bnQgPiAwKSB7CiAgICAgIHNlbGYuY29udGVudC5zZXRUcmFuc2xhdGVYKDApOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYoIShzZWxmLnJpZ2h0ICYmIHNlbGYucmlnaHQuaXNFbmFibGVkKSAmJiBhbW91bnQgPCAwKSB7CiAgICAgIHNlbGYuY29udGVudC5zZXRUcmFuc2xhdGVYKDApOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYobGVmdFNob3dpbmcgJiYgYW1vdW50ID4gbWF4TGVmdCkgewogICAgICBzZWxmLmNvbnRlbnQuc2V0VHJhbnNsYXRlWChtYXhMZWZ0KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmKHJpZ2h0U2hvd2luZyAmJiBhbW91bnQgPCAtbWF4UmlnaHQpIHsKICAgICAgc2VsZi5jb250ZW50LnNldFRyYW5zbGF0ZVgoLW1heFJpZ2h0KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHNlbGYuY29udGVudC5zZXRUcmFuc2xhdGVYKGFtb3VudCk7CgogICAgaWYoYW1vdW50ID49IDApIHsKICAgICAgbGVmdFNob3dpbmcgPSB0cnVlOwogICAgICByaWdodFNob3dpbmcgPSBmYWxzZTsKCiAgICAgIGlmKGFtb3VudCA+IDApIHsKICAgICAgICAvLyBQdXNoIHRoZSB6LWluZGV4IG9mIHRoZSByaWdodCBtZW51IGRvd24KICAgICAgICBzZWxmLnJpZ2h0ICYmIHNlbGYucmlnaHQucHVzaERvd24gJiYgc2VsZi5yaWdodC5wdXNoRG93bigpOwogICAgICAgIC8vIEJyaW5nIHRoZSB6LWluZGV4IG9mIHRoZSBsZWZ0IG1lbnUgdXAKICAgICAgICBzZWxmLmxlZnQgJiYgc2VsZi5sZWZ0LmJyaW5nVXAgJiYgc2VsZi5sZWZ0LmJyaW5nVXAoKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmlnaHRTaG93aW5nID0gdHJ1ZTsKICAgICAgbGVmdFNob3dpbmcgPSBmYWxzZTsKCiAgICAgIC8vIEJyaW5nIHRoZSB6LWluZGV4IG9mIHRoZSByaWdodCBtZW51IHVwCiAgICAgIHNlbGYucmlnaHQgJiYgc2VsZi5yaWdodC5icmluZ1VwICYmIHNlbGYucmlnaHQuYnJpbmdVcCgpOwogICAgICAvLyBQdXNoIHRoZSB6LWluZGV4IG9mIHRoZSBsZWZ0IG1lbnUgZG93bgogICAgICBzZWxmLmxlZnQgJiYgc2VsZi5sZWZ0LnB1c2hEb3duICYmIHNlbGYubGVmdC5wdXNoRG93bigpOwogICAgfQogIH07CgogIC8qKgogICAqIEdpdmVuIGFuIGV2ZW50IG9iamVjdCwgZmluZCB0aGUgZmluYWwgcmVzdGluZyBwb3NpdGlvbiBvZiB0aGlzIHNpZGUKICAgKiBtZW51LiBGb3IgZXhhbXBsZSwgaWYgdGhlIHVzZXIgInRocm93cyIgdGhlIGNvbnRlbnQgdG8gdGhlIHJpZ2h0IGFuZAogICAqIHJlbGVhc2VzIHRoZSB0b3VjaCwgdGhlIGxlZnQgbWVudSBzaG91bGQgc25hcCBvcGVuIChhbmltYXRlZCwgb2YgY291cnNlKS4KICAgKgogICAqIEBwYXJhbSB7RXZlbnR9IGUgdGhlIGdlc3R1cmUgZXZlbnQgdG8gdXNlIGZvciBzbmFwcGluZwogICAqLwogIHNlbGYuc25hcFRvUmVzdCA9IGZ1bmN0aW9uKGUpIHsKICAgIC8vIFdlIHdhbnQgdG8gYW5pbWF0ZSBhdCB0aGUgZW5kIG9mIHRoaXMKICAgIHNlbGYuY29udGVudC5lbmFibGVBbmltYXRpb24oKTsKICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAvLyBDaGVjayBob3cgbXVjaCB0aGUgcGFuZWwgaXMgb3BlbiBhZnRlciB0aGUgZHJhZywgYW5kCiAgICAvLyB3aGF0IHRoZSBkcmFnIHZlbG9jaXR5IGlzCiAgICB2YXIgcmF0aW8gPSBzZWxmLmdldE9wZW5SYXRpbygpOwoKICAgIGlmKHJhdGlvID09PSAwKSB7CiAgICAgIC8vIEp1c3QgdG8gYmUgc2FmZQogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKDApOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHZlbG9jaXR5VGhyZXNob2xkID0gMC4zOwogICAgdmFyIHZlbG9jaXR5WCA9IGUuZ2VzdHVyZS52ZWxvY2l0eVg7CiAgICB2YXIgZGlyZWN0aW9uID0gZS5nZXN0dXJlLmRpcmVjdGlvbjsKCiAgICAvLyBHb2luZyByaWdodCwgbGVzcyB0aGFuIGhhbGYsIHRvbyBzbG93IChzbmFwIGJhY2spCiAgICBpZihyYXRpbyA+IDAgJiYgcmF0aW8gPCAwLjUgJiYgZGlyZWN0aW9uID09ICdyaWdodCcgJiYgdmVsb2NpdHlYIDwgdmVsb2NpdHlUaHJlc2hvbGQpIHsKICAgICAgc2VsZi5vcGVuUGVyY2VudGFnZSgwKTsKICAgIH0KCiAgICAvLyBHb2luZyBsZWZ0LCBtb3JlIHRoYW4gaGFsZiwgdG9vIHNsb3cgKHNuYXAgYmFjaykKICAgIGVsc2UgaWYocmF0aW8gPiAwLjUgJiYgZGlyZWN0aW9uID09ICdsZWZ0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKDEwMCk7CiAgICB9CgogICAgLy8gR29pbmcgbGVmdCwgbGVzcyB0aGFuIGhhbGYsIHRvbyBzbG93IChzbmFwIGJhY2spCiAgICBlbHNlIGlmKHJhdGlvIDwgMCAmJiByYXRpbyA+IC0wLjUgJiYgZGlyZWN0aW9uID09ICdsZWZ0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKDApOwogICAgfQoKICAgIC8vIEdvaW5nIHJpZ2h0LCBtb3JlIHRoYW4gaGFsZiwgdG9vIHNsb3cgKHNuYXAgYmFjaykKICAgIGVsc2UgaWYocmF0aW8gPCAwLjUgJiYgZGlyZWN0aW9uID09ICdyaWdodCcgJiYgdmVsb2NpdHlYIDwgdmVsb2NpdHlUaHJlc2hvbGQpIHsKICAgICAgc2VsZi5vcGVuUGVyY2VudGFnZSgtMTAwKTsKICAgIH0KCiAgICAvLyBHb2luZyByaWdodCwgbW9yZSB0aGFuIGhhbGYsIG9yIHF1aWNrbHkgKHNuYXAgb3BlbikKICAgIGVsc2UgaWYoZGlyZWN0aW9uID09ICdyaWdodCcgJiYgcmF0aW8gPj0gMCAmJiAocmF0aW8gPj0gMC41IHx8IHZlbG9jaXR5WCA+IHZlbG9jaXR5VGhyZXNob2xkKSkgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKDEwMCk7CiAgICB9CgogICAgLy8gR29pbmcgbGVmdCwgbW9yZSB0aGFuIGhhbGYsIG9yIHF1aWNrbHkgKHNwYW4gb3BlbikKICAgIGVsc2UgaWYoZGlyZWN0aW9uID09ICdsZWZ0JyAmJiByYXRpbyA8PSAwICYmIChyYXRpbyA8PSAtMC41IHx8IHZlbG9jaXR5WCA+IHZlbG9jaXR5VGhyZXNob2xkKSkgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKC0xMDApOwogICAgfQoKICAgIC8vIFNuYXAgYmFjayBmb3Igc2FmZXR5CiAgICBlbHNlIHsKICAgICAgc2VsZi5vcGVuUGVyY2VudGFnZSgwKTsKICAgIH0KICB9OwoKICBzZWxmLmlzQXNpZGVFeHBvc2VkID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gISFpc0FzaWRlRXhwb3NlZDsKICB9OwoKICBzZWxmLmV4cG9zZUFzaWRlID0gZnVuY3Rpb24oc2hvdWxkRXhwb3NlQXNpZGUpIHsKICAgIGlzQXNpZGVFeHBvc2VkID0gc2hvdWxkRXhwb3NlQXNpZGU7CgogICAgLy8gc2V0IHRoZSBsZWZ0IG1hcmdldCB3aWR0aCBpZiBpdCBzaG91bGQgYmUgZXhwb3NlZAogICAgLy8gb3RoZXJ3aXNlIHNldCBmYWxzZSBzbyB0aGVyZSdzIG5vIGxlZnQgbWFyZ2luCiAgICBzZWxmLmNvbnRlbnQuc2V0TWFyZ2luTGVmdCggaXNBc2lkZUV4cG9zZWQgPyBzZWxmLmxlZnQud2lkdGggOiAwICk7CgogICAgc2VsZi4kc2NvcGUuJGVtaXQoJyRpb25pY0V4cG9zZUFzaWRlJywgaXNBc2lkZUV4cG9zZWQpOwogIH07CgogIHNlbGYuYWN0aXZlQXNpZGVSZXNpemluZyA9IGZ1bmN0aW9uKGlzUmVzaXppbmcpIHsKICAgICRpb25pY0JvZHkuZW5hYmxlQ2xhc3MoaXNSZXNpemluZywgJ2FzaWRlLXJlc2l6aW5nJyk7CiAgfTsKCiAgLy8gRW5kIGEgZHJhZyB3aXRoIHRoZSBnaXZlbiBldmVudAogIHNlbGYuX2VuZERyYWcgPSBmdW5jdGlvbihlKSB7CiAgICBpZihpc0FzaWRlRXhwb3NlZCkgcmV0dXJuOwoKICAgIGlmKGlzRHJhZ2dpbmcpIHsKICAgICAgc2VsZi5zbmFwVG9SZXN0KGUpOwogICAgfQogICAgc3RhcnRYID0gbnVsbDsKICAgIGxhc3RYID0gbnVsbDsKICAgIG9mZnNldFggPSBudWxsOwogIH07CgogIC8vIEhhbmRsZSBhIGRyYWcgZXZlbnQKICBzZWxmLl9oYW5kbGVEcmFnID0gZnVuY3Rpb24oZSkgewogICAgaWYoaXNBc2lkZUV4cG9zZWQpIHJldHVybjsKCiAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIHN0YXJ0IGNvb3JkcywgZ3JhYiBhbmQgc3RvcmUgdGhlbQogICAgaWYoIXN0YXJ0WCkgewogICAgICBzdGFydFggPSBlLmdlc3R1cmUudG91Y2hlc1swXS5wYWdlWDsKICAgICAgbGFzdFggPSBzdGFydFg7CiAgICB9IGVsc2UgewogICAgICAvLyBHcmFiIHRoZSBjdXJyZW50IHRhcCBjb29yZHMKICAgICAgbGFzdFggPSBlLmdlc3R1cmUudG91Y2hlc1swXS5wYWdlWDsKICAgIH0KCiAgICAvLyBDYWxjdWxhdGUgZGlmZmVyZW5jZSBmcm9tIHRoZSB0YXAgcG9pbnRzCiAgICBpZighaXNEcmFnZ2luZyAmJiBNYXRoLmFicyhsYXN0WCAtIHN0YXJ0WCkgPiBzZWxmLmRyYWdUaHJlc2hvbGRYKSB7CiAgICAgIC8vIGlmIHRoZSBkaWZmZXJlbmNlIGlzIGdyZWF0ZXIgdGhhbiB0aHJlc2hvbGQsIHN0YXJ0IGRyYWdnaW5nIHVzaW5nIHRoZSBjdXJyZW50CiAgICAgIC8vIHBvaW50IGFzIHRoZSBzdGFydGluZyBwb2ludAogICAgICBzdGFydFggPSBsYXN0WDsKCiAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAvLyBJbml0aWFsaXplIGRyYWdnaW5nCiAgICAgIHNlbGYuY29udGVudC5kaXNhYmxlQW5pbWF0aW9uKCk7CiAgICAgIG9mZnNldFggPSBzZWxmLmdldE9wZW5BbW91bnQoKTsKICAgIH0KCiAgICBpZihpc0RyYWdnaW5nKSB7CiAgICAgIHNlbGYub3BlbkFtb3VudChvZmZzZXRYICsgKGxhc3RYIC0gc3RhcnRYKSk7CiAgICB9CiAgfTsKCiAgc2VsZi5jYW5EcmFnQ29udGVudCA9IGZ1bmN0aW9uKGNhbkRyYWcpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICRzY29wZS5kcmFnQ29udGVudCA9ICEhY2FuRHJhZzsKICAgIH0KICAgIHJldHVybiAkc2NvcGUuZHJhZ0NvbnRlbnQ7CiAgfTsKCiAgc2VsZi5lZGdlVGhyZXNob2xkID0gMjU7CiAgc2VsZi5lZGdlVGhyZXNob2xkRW5hYmxlZCA9IGZhbHNlOwogIHNlbGYuZWRnZURyYWdUaHJlc2hvbGQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgaWYgKGFuZ3VsYXIuaXNOdW1iZXIodmFsdWUpICYmIHZhbHVlID4gMCkgewogICAgICAgIHNlbGYuZWRnZVRocmVzaG9sZCA9IHZhbHVlOwogICAgICAgIHNlbGYuZWRnZVRocmVzaG9sZEVuYWJsZWQgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuZWRnZVRocmVzaG9sZEVuYWJsZWQgPSAhIXZhbHVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2VsZi5lZGdlVGhyZXNob2xkRW5hYmxlZDsKICB9OwoKICBzZWxmLmlzRHJhZ2dhYmxlVGFyZ2V0ID0gZnVuY3Rpb24oZSkgewogICAgLy9Pbmx5IHJlc3RyaWN0IGVkZ2Ugd2hlbiBzaWRlbWVudSBpcyBjbG9zZWQgYW5kIHJlc3RyaWN0aW9uIGlzIGVuYWJsZWQKICAgIHZhciBzaG91bGRPbmx5QWxsb3dFZGdlRHJhZyA9IHNlbGYuZWRnZVRocmVzaG9sZEVuYWJsZWQgJiYgIXNlbGYuaXNPcGVuKCk7CiAgICB2YXIgc3RhcnRYID0gZS5nZXN0dXJlLnN0YXJ0RXZlbnQgJiYgZS5nZXN0dXJlLnN0YXJ0RXZlbnQuY2VudGVyICYmCiAgICAgIGUuZ2VzdHVyZS5zdGFydEV2ZW50LmNlbnRlci5wYWdlWDsKCiAgICB2YXIgZHJhZ0lzV2l0aGluQm91bmRzID0gIXNob3VsZE9ubHlBbGxvd0VkZ2VEcmFnIHx8CiAgICAgIHN0YXJ0WCA8PSBzZWxmLmVkZ2VUaHJlc2hvbGQgfHwKICAgICAgc3RhcnRYID49IHNlbGYuY29udGVudC5vZmZzZXRXaWR0aCAtIHNlbGYuZWRnZVRocmVzaG9sZDsKCiAgICByZXR1cm4gKCRzY29wZS5kcmFnQ29udGVudCB8fCBzZWxmLmlzT3BlbigpKSAmJgogICAgICAgICAgIGRyYWdJc1dpdGhpbkJvdW5kcyAmJgogICAgICAgICAgICFlLmdlc3R1cmUuc3JjRXZlbnQuZGVmYXVsdFByZXZlbnRlZCAmJgogICAgICAgICAgICFlLnRhcmdldC50YWdOYW1lLm1hdGNoKC9pbnB1dHx0ZXh0YXJlYXxzZWxlY3R8b2JqZWN0fGVtYmVkL2kpICYmCiAgICAgICAgICAgIWUudGFyZ2V0LmlzQ29udGVudEVkaXRhYmxlICYmCiAgICAgICAgICAgIShlLnRhcmdldC5kYXRhc2V0ID8gZS50YXJnZXQuZGF0YXNldC5wcmV2ZW50U2Nyb2xsIDogZS50YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLXByZXZlbnQtc2Nyb2xsJykgPT0gJ3RydWUnKTsKICB9OwoKICAkc2NvcGUuc2lkZU1lbnVDb250ZW50VHJhbnNsYXRlWCA9IDA7CgogIHZhciBkZXJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbiA9IGFuZ3VsYXIubm9vcDsKICB2YXIgY2xvc2VTaWRlTWVudSA9IGFuZ3VsYXIuYmluZChzZWxmLCBzZWxmLmNsb3NlKTsKCiAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZWxmLmdldE9wZW5BbW91bnQoKSAhPT0gMDsKICB9LCBmdW5jdGlvbihpc09wZW4pIHsKICAgIGRlcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKCk7CiAgICBpZiAoaXNPcGVuKSB7CiAgICAgIGRlcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgIGNsb3NlU2lkZU1lbnUsCiAgICAgICAgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfU0lERV9NRU5VCiAgICAgICk7CiAgICB9CiAgfSk7CgogIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNTaWRlTWVudURlbGVnYXRlLl9yZWdpc3Rlckluc3RhbmNlKAogICAgc2VsZiwgJGF0dHJzLmRlbGVnYXRlSGFuZGxlCiAgKTsKCiAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgIGRlcmVnaXN0ZXJJbnN0YW5jZSgpOwogICAgZGVyZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oKTsKICB9KTsKCiAgc2VsZi5pbml0aWFsaXplKHsKICAgIGxlZnQ6IHsgd2lkdGg6IDI3NSB9LAogICAgcmlnaHQ6IHsgd2lkdGg6IDI3NSB9CiAgfSk7Cgp9XSk7CgpJb25pY01vZHVsZQouY29udHJvbGxlcignJGlvbmljVGFiJywgWwogICckc2NvcGUnLAogICckaW9uaWNWaWV3U2VydmljZScsCiAgJyRhdHRycycsCiAgJyRsb2NhdGlvbicsCiAgJyRzdGF0ZScsCmZ1bmN0aW9uKCRzY29wZSwgJGlvbmljVmlld1NlcnZpY2UsICRhdHRycywgJGxvY2F0aW9uLCAkc3RhdGUpIHsKICB0aGlzLiRzY29wZSA9ICRzY29wZTsKCiAgLy9BbGwgb2YgdGhlc2UgZXhwb3NlZCBmb3IgdGVzdGluZwogIHRoaXMuaHJlZk1hdGNoZXNTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICRhdHRycy5ocmVmICYmICRsb2NhdGlvbi5wYXRoKCkuaW5kZXhPZigKICAgICAgJGF0dHJzLmhyZWYucmVwbGFjZSgvXiMvLCAnJykucmVwbGFjZSgvXC8kLywgJycpCiAgICApID09PSAwOwogIH07CiAgdGhpcy5zcmVmTWF0Y2hlc1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gJGF0dHJzLnVpU3JlZiAmJiAkc3RhdGUuaW5jbHVkZXMoICRhdHRycy51aVNyZWYuc3BsaXQoJygnKVswXSApOwogIH07CiAgdGhpcy5uYXZOYW1lTWF0Y2hlc1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5uYXZWaWV3TmFtZSAmJiAkaW9uaWNWaWV3U2VydmljZS5pc0N1cnJlbnRTdGF0ZU5hdlZpZXcodGhpcy5uYXZWaWV3TmFtZSk7CiAgfTsKCiAgdGhpcy50YWJNYXRjaGVzU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmhyZWZNYXRjaGVzU3RhdGUoKSB8fCB0aGlzLnNyZWZNYXRjaGVzU3RhdGUoKSB8fCB0aGlzLm5hdk5hbWVNYXRjaGVzU3RhdGUoKTsKICB9Owp9XSk7CgpJb25pY01vZHVsZQouY29udHJvbGxlcignJGlvbmljVGFicycsIFsKICAnJHNjb3BlJywKICAnJGlvbmljVmlld1NlcnZpY2UnLAogICckZWxlbWVudCcsCmZ1bmN0aW9uKCRzY29wZSwgJGlvbmljVmlld1NlcnZpY2UsICRlbGVtZW50KSB7CiAgdmFyIF9zZWxlY3RlZFRhYiA9IG51bGw7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHNlbGYudGFicyA9IFtdOwoKICBzZWxmLnNlbGVjdGVkSW5kZXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZWxmLnRhYnMuaW5kZXhPZihfc2VsZWN0ZWRUYWIpOwogIH07CiAgc2VsZi5zZWxlY3RlZFRhYiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF9zZWxlY3RlZFRhYjsKICB9OwoKICBzZWxmLmFkZCA9IGZ1bmN0aW9uKHRhYikgewogICAgJGlvbmljVmlld1NlcnZpY2UucmVnaXN0ZXJIaXN0b3J5KHRhYik7CiAgICBzZWxmLnRhYnMucHVzaCh0YWIpOwogICAgaWYoc2VsZi50YWJzLmxlbmd0aCA9PT0gMSkgewogICAgICBzZWxmLnNlbGVjdCh0YWIpOwogICAgfQogIH07CgogIHNlbGYucmVtb3ZlID0gZnVuY3Rpb24odGFiKSB7CiAgICB2YXIgdGFiSW5kZXggPSBzZWxmLnRhYnMuaW5kZXhPZih0YWIpOwogICAgaWYgKHRhYkluZGV4ID09PSAtMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvL1VzZSBhIGZpZWxkIGxpa2UgJyR0YWJTZWxlY3RlZCcgc28gZGV2ZWxvcGVycyB3b24ndCBhY2NpZGVudGFsbHkgc2V0IGl0IGluIGNvbnRyb2xsZXJzIGV0YwogICAgaWYgKHRhYi4kdGFiU2VsZWN0ZWQpIHsKICAgICAgc2VsZi5kZXNlbGVjdCh0YWIpOwogICAgICAvL1RyeSB0byBzZWxlY3QgYSBuZXcgdGFiIGlmIHdlJ3JlIHJlbW92aW5nIGEgdGFiCiAgICAgIGlmIChzZWxmLnRhYnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgLy9kbyBub3RoaW5nIGlmIHRoZXJlIGFyZSBubyBvdGhlciB0YWJzIHRvIHNlbGVjdAogICAgICB9IGVsc2UgewogICAgICAgIC8vU2VsZWN0IHByZXZpb3VzIHRhYiBpZiBpdCdzIHRoZSBsYXN0IHRhYiwgZWxzZSBzZWxlY3QgbmV4dCB0YWIKICAgICAgICB2YXIgbmV3VGFiSW5kZXggPSB0YWJJbmRleCA9PT0gc2VsZi50YWJzLmxlbmd0aCAtIDEgPyB0YWJJbmRleCAtIDEgOiB0YWJJbmRleCArIDE7CiAgICAgICAgc2VsZi5zZWxlY3Qoc2VsZi50YWJzW25ld1RhYkluZGV4XSk7CiAgICAgIH0KICAgIH0KICAgIHNlbGYudGFicy5zcGxpY2UodGFiSW5kZXgsIDEpOwogIH07CgogIHNlbGYuZGVzZWxlY3QgPSBmdW5jdGlvbih0YWIpIHsKICAgIGlmICh0YWIuJHRhYlNlbGVjdGVkKSB7CiAgICAgIF9zZWxlY3RlZFRhYiA9IG51bGw7CiAgICAgIHRhYi4kdGFiU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgKHRhYi5vbkRlc2VsZWN0IHx8IGFuZ3VsYXIubm9vcCkoKTsKICAgIH0KICB9OwoKICBzZWxmLnNlbGVjdCA9IGZ1bmN0aW9uKHRhYiwgc2hvdWxkRW1pdEV2ZW50KSB7CiAgICB2YXIgdGFiSW5kZXg7CiAgICBpZiAoYW5ndWxhci5pc051bWJlcih0YWIpKSB7CiAgICAgIHRhYkluZGV4ID0gdGFiOwogICAgICB0YWIgPSBzZWxmLnRhYnNbdGFiSW5kZXhdOwogICAgfSBlbHNlIHsKICAgICAgdGFiSW5kZXggPSBzZWxmLnRhYnMuaW5kZXhPZih0YWIpOwogICAgfQoKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIHNob3VsZEVtaXRFdmVudCA9ICEhKHRhYi5uYXZWaWV3TmFtZSB8fCB0YWIudWlTcmVmKTsKICAgIH0KCiAgICBpZiAoX3NlbGVjdGVkVGFiICYmIF9zZWxlY3RlZFRhYi4kaGlzdG9yeUlkID09IHRhYi4kaGlzdG9yeUlkKSB7CiAgICAgIGlmIChzaG91bGRFbWl0RXZlbnQpIHsKICAgICAgICAkaW9uaWNWaWV3U2VydmljZS5nb1RvSGlzdG9yeVJvb3QodGFiLiRoaXN0b3J5SWQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3JFYWNoKHNlbGYudGFicywgZnVuY3Rpb24odGFiKSB7CiAgICAgICAgc2VsZi5kZXNlbGVjdCh0YWIpOwogICAgICB9KTsKCiAgICAgIF9zZWxlY3RlZFRhYiA9IHRhYjsKICAgICAgLy9Vc2UgYSBmdW5ueSBuYW1lIGxpa2UgJHRhYlNlbGVjdGVkIHNvIHRoZSBkZXZlbG9wZXIgZG9lc24ndCBvdmVyd3JpdGUgdGhlIHZhciBpbiBhIGNoaWxkIHNjb3BlCiAgICAgIHRhYi4kdGFiU2VsZWN0ZWQgPSB0cnVlOwogICAgICAodGFiLm9uU2VsZWN0IHx8IGFuZ3VsYXIubm9vcCkoKTsKCiAgICAgIGlmIChzaG91bGRFbWl0RXZlbnQpIHsKICAgICAgICB2YXIgdmlld0RhdGEgPSB7CiAgICAgICAgICB0eXBlOiAndGFiJywKICAgICAgICAgIHRhYkluZGV4OiB0YWJJbmRleCwKICAgICAgICAgIGhpc3RvcnlJZDogdGFiLiRoaXN0b3J5SWQsCiAgICAgICAgICBuYXZWaWV3TmFtZTogdGFiLm5hdlZpZXdOYW1lLAogICAgICAgICAgaGFzTmF2VmlldzogISF0YWIubmF2Vmlld05hbWUsCiAgICAgICAgICB0aXRsZTogdGFiLnRpdGxlLAogICAgICAgICAgdXJsOiB0YWIuaHJlZiwKICAgICAgICAgIHVpU3JlZjogdGFiLnVpU3JlZgogICAgICAgIH07CiAgICAgICAgJHNjb3BlLiRlbWl0KCd2aWV3U3RhdGUuY2hhbmdlSGlzdG9yeScsIHZpZXdEYXRhKTsKICAgICAgfQogICAgfQogIH07Cn1dKTsKCgovKgogKiBXZSBkb24ndCBkb2N1bWVudCB0aGUgaW9uQWN0aW9uU2hlZXQgZGlyZWN0aXZlLCB3ZSBpbnN0ZWFkIGRvY3VtZW50CiAqIHRoZSAkaW9uaWNBY3Rpb25TaGVldCBzZXJ2aWNlCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25BY3Rpb25TaGVldCcsIFsnJGRvY3VtZW50JywgZnVuY3Rpb24oJGRvY3VtZW50KSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBzY29wZTogdHJ1ZSwKICAgIHJlcGxhY2U6IHRydWUsCiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KXsKICAgICAgdmFyIGtleVVwID0gZnVuY3Rpb24oZSkgewogICAgICAgIGlmKGUud2hpY2ggPT0gMjcpIHsKICAgICAgICAgICRzY29wZS5jYW5jZWwoKTsKICAgICAgICAgICRzY29wZS4kYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgYmFja2Ryb3BDbGljayA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZihlLnRhcmdldCA9PSAkZWxlbWVudFswXSkgewogICAgICAgICAgJHNjb3BlLmNhbmNlbCgpOwogICAgICAgICAgJHNjb3BlLiRhcHBseSgpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAkZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAkZG9jdW1lbnQudW5iaW5kKCdrZXl1cCcsIGtleVVwKTsKICAgICAgfSk7CgogICAgICAkZG9jdW1lbnQuYmluZCgna2V5dXAnLCBrZXlVcCk7CiAgICAgICRlbGVtZW50LmJpbmQoJ2NsaWNrJywgYmFja2Ryb3BDbGljayk7CiAgICB9LAogICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPSJhY3Rpb24tc2hlZXQtYmFja2Ryb3AiPicgKwogICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC13cmFwcGVyIj4nICsKICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldCI+JyArCiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC1ncm91cCI+JyArCiAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LXRpdGxlIiBuZy1pZj0idGl0bGVUZXh0IiBuZy1iaW5kLWh0bWw9InRpdGxlVGV4dCI+PC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAnPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIiBuZy1jbGljaz0iYnV0dG9uQ2xpY2tlZCgkaW5kZXgpIiBuZy1yZXBlYXQ9ImJ1dHRvbiBpbiBidXR0b25zIiBuZy1iaW5kLWh0bWw9ImJ1dHRvbi50ZXh0Ij48L2J1dHRvbj4nICsKICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC1ncm91cCIgbmctaWY9ImRlc3RydWN0aXZlVGV4dCI+JyArCiAgICAgICAgICAgICAgICAgICAgICAnPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIGRlc3RydWN0aXZlIiBuZy1jbGljaz0iZGVzdHJ1Y3RpdmVCdXR0b25DbGlja2VkKCkiIG5nLWJpbmQtaHRtbD0iZGVzdHJ1Y3RpdmVUZXh0Ij48L2J1dHRvbj4nICsKICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC1ncm91cCIgbmctaWY9ImNhbmNlbFRleHQiPicgKwogICAgICAgICAgICAgICAgICAgICAgJzxidXR0b24gY2xhc3M9ImJ1dHRvbiIgbmctY2xpY2s9ImNhbmNlbCgpIiBuZy1iaW5kLWh0bWw9ImNhbmNlbFRleHQiPjwvYnV0dG9uPicgKwogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgICc8L2Rpdj4nCiAgfTsKfV0pOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvbkNoZWNrYm94CiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICogQGNvZGVwZW4gaHFjanUKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBjaGVja2JveCBpcyBubyBkaWZmZXJlbnQgdGhhbiB0aGUgSFRNTCBjaGVja2JveCBpbnB1dCwgZXhjZXB0IGl0J3Mgc3R5bGVkIGRpZmZlcmVudGx5LgogKgogKiBUaGUgY2hlY2tib3ggYmVoYXZlcyBsaWtlIGFueSBbQW5ndWxhckpTIGNoZWNrYm94XShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy9pbnB1dC9pbnB1dFtjaGVja2JveF0pLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8aW9uLWNoZWNrYm94IG5nLW1vZGVsPSJpc0NoZWNrZWQiPkNoZWNrYm94IExhYmVsPC9pb24tY2hlY2tib3g+CiAqIGBgYAogKi8KCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbkNoZWNrYm94JywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXBsYWNlOiB0cnVlLAogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICB0ZW1wbGF0ZToKICAgICAgJzxsYWJlbCBjbGFzcz0iaXRlbSBpdGVtLWNoZWNrYm94Ij4nICsKICAgICAgICAnPGRpdiBjbGFzcz0iY2hlY2tib3ggY2hlY2tib3gtaW5wdXQtaGlkZGVuIGRpc2FibGUtcG9pbnRlci1ldmVudHMiPicgKwogICAgICAgICAgJzxpbnB1dCB0eXBlPSJjaGVja2JveCI+JyArCiAgICAgICAgICAnPGkgY2xhc3M9ImNoZWNrYm94LWljb24iPjwvaT4nICsKICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgJzxkaXYgY2xhc3M9Iml0ZW0tY29udGVudCBkaXNhYmxlLXBvaW50ZXItZXZlbnRzIiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAnPC9sYWJlbD4nLAogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICB2YXIgaW5wdXQgPSBlbGVtZW50LmZpbmQoJ2lucHV0Jyk7CiAgICAgIGZvckVhY2goewogICAgICAgICduYW1lJzogYXR0ci5uYW1lLAogICAgICAgICduZy12YWx1ZSc6IGF0dHIubmdWYWx1ZSwKICAgICAgICAnbmctbW9kZWwnOiBhdHRyLm5nTW9kZWwsCiAgICAgICAgJ25nLWNoZWNrZWQnOiBhdHRyLm5nQ2hlY2tlZCwKICAgICAgICAnbmctZGlzYWJsZWQnOiBhdHRyLm5nRGlzYWJsZWQsCiAgICAgICAgJ25nLXRydWUtdmFsdWUnOiBhdHRyLm5nVHJ1ZVZhbHVlLAogICAgICAgICduZy1mYWxzZS12YWx1ZSc6IGF0dHIubmdGYWxzZVZhbHVlLAogICAgICAgICduZy1jaGFuZ2UnOiBhdHRyLm5nQ2hhbmdlCiAgICAgIH0sIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKSB7CiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIGlucHV0LmF0dHIobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogIH07Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG1vZHVsZSBpb25pYwogKiBAbmFtZSBjb2xsZWN0aW9uUmVwZWF0CiAqIEByZXN0cmljdCBBCiAqIEBjb2RlcGVuIG1GeWdoCiAqIEBkZXNjcmlwdGlvbgogKiBgY29sbGVjdGlvbi1yZXBlYXRgIGlzIGEgZGlyZWN0aXZlIHRoYXQgYWxsb3dzIHlvdSB0byByZW5kZXIgbGlzdHMgd2l0aAogKiB0aG91c2FuZHMgb2YgaXRlbXMgaW4gdGhlbSwgYW5kIGV4cGVyaWVuY2UgbGl0dGxlIHRvIG5vIHBlcmZvcm1hbmNlIHBlbmFsdHkuCiAqCiAqIERlbW86CiAqCiAqIFRoZSBkaXJlY3RpdmUgcmVuZGVycyBvbnRvIHRoZSBzY3JlZW4gb25seSB0aGUgaXRlbXMgdGhhdCBzaG91bGQgYmUgY3VycmVudGx5IHZpc2libGUuCiAqIFNvIGlmIHlvdSBoYXZlIDEsMDAwIGl0ZW1zIGluIHlvdXIgbGlzdCBidXQgb25seSB0ZW4gZml0IG9uIHlvdXIgc2NyZWVuLAogKiBjb2xsZWN0aW9uLXJlcGVhdCB3aWxsIG9ubHkgcmVuZGVyIGludG8gdGhlIERPTSB0aGUgdGVuIHRoYXQgYXJlIGluIHRoZSBjdXJyZW50CiAqIHNjcm9sbCBwb3NpdGlvbi4KICoKICogSGVyZSBhcmUgYSBmZXcgdGhpbmdzIHRvIGtlZXAgaW4gbWluZCB3aGlsZSB1c2luZyBjb2xsZWN0aW9uLXJlcGVhdDoKICoKICogMS4gVGhlIGRhdGEgc3VwcGxpZWQgdG8gY29sbGVjdGlvbi1yZXBlYXQgbXVzdCBiZSBhbiBhcnJheS4KICogMi4gWW91IG11c3QgZXhwbGljaXRseSB0ZWxsIHRoZSBkaXJlY3RpdmUgd2hhdCBzaXplIHlvdXIgaXRlbXMgd2lsbCBiZSBpbiB0aGUgRE9NLCB1c2luZyBkaXJlY3RpdmUgYXR0cmlidXRlcy4KICogUGl4ZWwgYW1vdW50cyBvciBwZXJjZW50YWdlcyBhcmUgYWxsb3dlZCAoc2VlIGJlbG93KS4KICogMy4gVGhlIGVsZW1lbnRzIHJlbmRlcmVkIHdpbGwgYmUgYWJzb2x1dGVseSBwb3NpdGlvbmVkOiBiZSBzdXJlIHRvIGxldCB5b3VyIENTUyB3b3JrIHdpdGgKICogdGhpcyAoc2VlIGJlbG93KS4KICogNC4gRWFjaCBjb2xsZWN0aW9uLXJlcGVhdCBsaXN0IHdpbGwgdGFrZSB1cCBhbGwgb2YgaXRzIHBhcmVudCBzY3JvbGxWaWV3J3Mgc3BhY2UuCiAqIElmIHlvdSB3aXNoIHRvIGhhdmUgbXVsdGlwbGUgbGlzdHMgb24gb25lIHBhZ2UsIHB1dCBlYWNoIGxpc3Qgd2l0aGluIGl0cyBvd24KICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TY3JvbGwgaW9uU2Nyb2xsfSBjb250YWluZXIuCiAqIDUuIFlvdSBzaG91bGQgbm90IHVzZSB0aGUgbmctc2hvdyBhbmQgbmctaGlkZSBkaXJlY3RpdmVzIG9uIHlvdXIgaW9uLWNvbnRlbnQvaW9uLXNjcm9sbCBlbGVtZW50cyB0aGF0CiAqIGhhdmUgYSBjb2xsZWN0aW9uLXJlcGVhdCBpbnNpZGUuICBuZy1zaG93IGFuZCBuZy1oaWRlIGFwcGx5IHRoZSBgZGlzcGxheTogbm9uZWAgY3NzIHJ1bGUgdG8gdGhlIGNvbnRlbnQncwogKiBzdHlsZSwgY2F1c2luZyB0aGUgc2Nyb2xsVmlldyB0byByZWFkIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBjb250ZW50IGFzIDAuICBSZXN1bHRpbmdseSwKICogY29sbGVjdGlvbi1yZXBlYXQgd2lsbCByZW5kZXIgZWxlbWVudHMgdGhhdCBoYXZlIGp1c3QgYmVlbiB1bi1oaWRkZW4gaW5jb3JyZWN0bHkuCiAqCiAqCiAqIEB1c2FnZQogKgogKiAjIyMjIEJhc2ljIFVzYWdlIChzaW5nbGUgcm93cyBvZiBpdGVtcykKICoKICogTm90aWNlIHR3byB0aGluZ3MgaGVyZTogd2UgdXNlIG5nLXN0eWxlIHRvIHNldCB0aGUgaGVpZ2h0IG9mIHRoZSBpdGVtIHRvIG1hdGNoCiAqIHdoYXQgdGhlIHJlcGVhdGVyIHRoaW5rcyBvdXIgaXRlbSBoZWlnaHQgaXMuICBBZGRpdGlvbmFsbHksIHdlIGFkZCBhIGNzcyBydWxlCiAqIHRvIG1ha2Ugb3VyIGl0ZW0gc3RyZXRjaCB0byBmaXQgdGhlIGZ1bGwgc2NyZWVuIChzaW5jZSBpdCB3aWxsIGJlIGFic29sdXRlbHkKICogcG9zaXRpb25lZCkuCiAqCiAqIGBgYGh0bWwKICogPGlvbi1jb250ZW50IG5nLWNvbnRyb2xsZXI9IkNvbnRlbnRDdHJsIj4KICogICA8ZGl2IGNsYXNzPSJsaXN0Ij4KICogICAgIDxkaXYgY2xhc3M9Iml0ZW0gbXktaXRlbSIKICogICAgICAgY29sbGVjdGlvbi1yZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiCiAqICAgICAgIGNvbGxlY3Rpb24taXRlbS13aWR0aD0iJzEwMCUnIgogKiAgICAgICBjb2xsZWN0aW9uLWl0ZW0taGVpZ2h0PSJnZXRJdGVtSGVpZ2h0KGl0ZW0sICRpbmRleCkiCiAqICAgICAgIG5nLXN0eWxlPSJ7aGVpZ2h0OiBnZXRJdGVtSGVpZ2h0KGl0ZW0sICRpbmRleCl9Ij4KICogICAgICAgeyUgcmF3ICV9e3tpdGVtfX17JSBlbmRyYXcgJX0KICogICAgIDwvZGl2PgogKiAgIDwvZGl2PgogKiA8L2Rpdj4KICogYGBgCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIENvbnRlbnRDdHJsKCRzY29wZSkgewogKiAgICRzY29wZS5pdGVtcyA9IFtdOwogKiAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTAwMDsgaSsrKSB7CiAqICAgICAkc2NvcGUuaXRlbXMucHVzaCgnSXRlbSAnICsgaSk7CiAqICAgfQogKgogKiAgICRzY29wZS5nZXRJdGVtSGVpZ2h0ID0gZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKICogICAgIC8vTWFrZSBldmVubHkgaW5kZXhlZCBpdGVtcyBiZSAxMHB4IHRhbGxlciwgZm9yIHRoZSBzYWtlIG9mIGV4YW1wbGUKICogICAgIHJldHVybiAoaW5kZXggJSAyKSA9PT0gMCA/IDUwIDogNjA7CiAqICAgfTsKICogfQogKiBgYGAKICogYGBgY3NzCiAqIC5teS1pdGVtIHsKICogICBsZWZ0OiAwOwogKiAgIHJpZ2h0OiAwOwogKiB9CiAqIGBgYAogKgogKiAjIyMjIEdyaWQgVXNhZ2UgKHRocmVlIGl0ZW1zIHBlciByb3cpCiAqCiAqIGBgYGh0bWwKICogPGlvbi1jb250ZW50PgogKiAgIDxkaXYgY2xhc3M9Iml0ZW0gaXRlbS1hdmF0YXIgbXktaW1hZ2UtaXRlbSIKICogICAgIGNvbGxlY3Rpb24tcmVwZWF0PSJpbWFnZSBpbiBpbWFnZXMiCiAqICAgICBjb2xsZWN0aW9uLWl0ZW0td2lkdGg9IiczMyUnIgogKiAgICAgY29sbGVjdGlvbi1pdGVtLWhlaWdodD0iJzMzJSciPgogKiAgICAgPGltZyBuZy1zcmM9Int7aW1hZ2Uuc3JjfX0iPgogKiAgIDwvZGl2PgogKiA8L2lvbi1jb250ZW50PgogKiBgYGAKICogUGVyY2VudGFnZSBvZiB0b3RhbCB2aXNpYmxlIGxpc3QgZGltZW5zaW9ucy4gVGhpcyBleGFtcGxlIHNob3dzIGEgMyBieSAzIG1hdHJpeCB0aGF0IGZpdHMgb24gdGhlIHNjcmVlbiAoMyByb3dzIGFuZCAzIGNvbHVtcykuIE5vdGUgdGhhdCBkaW1lbnNpb25zIGFyZSB1c2VkIGluIHRoZSBjcmVhdGlvbiBvZiB0aGUgZWxlbWVudCBhbmQgdGhlcmVmb3JlIGEgbWVhc3VyZW1lbnQgb2YgdGhlIGl0ZW0gY2Fubm5vdCBiZSB1c2VkIGFzIGFuIGlucHV0IGRpbWVuc2lvbi4KICogYGBgY3NzCiAqIC5teS1pbWFnZS1pdGVtIGltZyB7CiAqICAgaGVpZ2h0OiAzMyU7CiAqICAgd2lkdGg6IDMzJTsKICogfQogKiBgYGAKICoKICogQHBhcmFtIHtleHByZXNzaW9ufSBjb2xsZWN0aW9uLXJlcGVhdCBUaGUgZXhwcmVzc2lvbiBpbmRpY2F0aW5nIGhvdyB0byBlbnVtZXJhdGUgYSBjb2xsZWN0aW9uLiBUaGVzZQogKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAqCiAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgYWxidW0gaW4gYXJ0aXN0LmFsYnVtc2AuCiAqCiAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbiB0cmFjayBieSB0cmFja2luZ19leHByZXNzaW9uYCDigJMgWW91IGNhbiBhbHNvIHByb3ZpZGUgYW4gb3B0aW9uYWwgdHJhY2tpbmcgZnVuY3Rpb24KICogICAgIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGFzc29jaWF0ZSB0aGUgb2JqZWN0cyBpbiB0aGUgY29sbGVjdGlvbiB3aXRoIHRoZSBET00gZWxlbWVudHMuIElmIG5vIHRyYWNraW5nIGZ1bmN0aW9uCiAqICAgICBpcyBzcGVjaWZpZWQgdGhlIGNvbGxlY3Rpb24tcmVwZWF0IGFzc29jaWF0ZXMgZWxlbWVudHMgYnkgaWRlbnRpdHkgaW4gdGhlIGNvbGxlY3Rpb24uIEl0IGlzIGFuIGVycm9yIHRvIGhhdmUKICogICAgIG1vcmUgdGhhbiBvbmUgdHJhY2tpbmcgZnVuY3Rpb24gdG8gcmVzb2x2ZSB0byB0aGUgc2FtZSBrZXkuIChUaGlzIHdvdWxkIG1lYW4gdGhhdCB0d28gZGlzdGluY3Qgb2JqZWN0cyBhcmUKICogICAgIG1hcHBlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudCwgd2hpY2ggaXMgbm90IHBvc3NpYmxlLikgIEZpbHRlcnMgc2hvdWxkIGJlIGFwcGxpZWQgdG8gdGhlIGV4cHJlc3Npb24sCiAqICAgICBiZWZvcmUgc3BlY2lmeWluZyBhIHRyYWNraW5nIGV4cHJlc3Npb24uCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXNgIGlzIGVxdWl2YWxlbnQgdG8gYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgJGlkKGl0ZW0pJy4gVGhpcyBpbXBsaWVzIHRoYXQgdGhlIERPTSBlbGVtZW50cwogKiAgICAgd2lsbCBiZSBhc3NvY2lhdGVkIGJ5IGl0ZW0gaWRlbnRpdHkgaW4gdGhlIGFycmF5LgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5ICRpZChpdGVtKWAuIEEgYnVpbHQgaW4gYCRpZCgpYCBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byBhc3NpZ24gYSB1bmlxdWUKICogICAgIGAkJGhhc2hLZXlgIHByb3BlcnR5IHRvIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXkuIFRoaXMgcHJvcGVydHkgaXMgdGhlbiB1c2VkIGFzIGEga2V5IHRvIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnRzCiAqICAgICB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGl0ZW0gaW4gdGhlIGFycmF5IGJ5IGlkZW50aXR5LiBNb3ZpbmcgdGhlIHNhbWUgb2JqZWN0IGluIGFycmF5IHdvdWxkIG1vdmUgdGhlIERPTQogKiAgICAgZWxlbWVudCBpbiB0aGUgc2FtZSB3YXkgaW4gdGhlIERPTS4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSBpdGVtLmlkYCBpcyBhIHR5cGljYWwgcGF0dGVybiB3aGVuIHRoZSBpdGVtcyBjb21lIGZyb20gdGhlIGRhdGFiYXNlLiBJbiB0aGlzCiAqICAgICBjYXNlIHRoZSBvYmplY3QgaWRlbnRpdHkgZG9lcyBub3QgbWF0dGVyLiBUd28gb2JqZWN0cyBhcmUgY29uc2lkZXJlZCBlcXVpdmFsZW50IGFzIGxvbmcgYXMgdGhlaXIgYGlkYAogKiAgICAgcHJvcGVydHkgaXMgc2FtZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB8IGZpbHRlcjpzZWFyY2hUZXh0IHRyYWNrIGJ5IGl0ZW0uaWRgIGlzIGEgcGF0dGVybiB0aGF0IG1pZ2h0IGJlIHVzZWQgdG8gYXBwbHkgYSBmaWx0ZXIKICogICAgIHRvIGl0ZW1zIGluIGNvbmp1bmN0aW9uIHdpdGggYSB0cmFja2luZyBleHByZXNzaW9uLgogKgogKiBAcGFyYW0ge2V4cHJlc3Npb259IGNvbGxlY3Rpb24taXRlbS13aWR0aCBUaGUgd2lkdGggb2YgdGhlIHJlcGVhdGVkIGVsZW1lbnQuICBDYW4gYmUgYSBudW1iZXIgKGluIHBpeGVscykgb3IgYSBwZXJjZW50YWdlLgogKiBAcGFyYW0ge2V4cHJlc3Npb259IGNvbGxlY3Rpb24taXRlbS1oZWlnaHQgVGhlIGhlaWdodCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudC4gIENhbiBiZSBhIG51bWJlciAoaW4gcGl4ZWxzKSwgb3IgYSBwZXJjZW50YWdlLgogKgogKi8KdmFyIENPTExFQ1RJT05fUkVQRUFUX1NDUk9MTFZJRVdfWFlfRVJST1IgPSAiQ2Fubm90IGNyZWF0ZSBhIGNvbGxlY3Rpb24tcmVwZWF0IHdpdGhpbiBhIHNjcm9sbFZpZXcgdGhhdCBpcyBzY3JvbGxhYmxlIG9uIGJvdGggeCBhbmQgeSBheGlzLiAgQ2hvb3NlIGVpdGhlciB4IGRpcmVjdGlvbiBvciB5IGRpcmVjdGlvbi4iOwp2YXIgQ09MTEVDVElPTl9SRVBFQVRfQVRUUl9IRUlHSFRfRVJST1IgPSAiY29sbGVjdGlvbi1yZXBlYXQgZXhwZWN0ZWQgYXR0cmlidXRlIGNvbGxlY3Rpb24taXRlbS1oZWlnaHQgdG8gYmUgYSBhbiBleHByZXNzaW9uIHRoYXQgcmV0dXJucyBhIG51bWJlciAoaW4gcGl4ZWxzKSBvciBwZXJjZW50YWdlLiI7CnZhciBDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX1dJRFRIX0VSUk9SID0gImNvbGxlY3Rpb24tcmVwZWF0IGV4cGVjdGVkIGF0dHJpYnV0ZSBjb2xsZWN0aW9uLWl0ZW0td2lkdGggdG8gYmUgYSBhbiBleHByZXNzaW9uIHRoYXQgcmV0dXJucyBhIG51bWJlciAoaW4gcGl4ZWxzKSBvciBwZXJjZW50YWdlLiI7CnZhciBDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX1JFUEVBVF9FUlJPUiA9ICJjb2xsZWN0aW9uLXJlcGVhdCBleHBlY3RlZCBleHByZXNzaW9uIGluIGZvcm0gb2YgJ19pdGVtXyBpbiBfY29sbGVjdGlvbl9bIHRyYWNrIGJ5IF9pZF9dJyBidXQgZ290ICclJyI7CgpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdjb2xsZWN0aW9uUmVwZWF0JywgWwogICckY29sbGVjdGlvblJlcGVhdE1hbmFnZXInLAogICckY29sbGVjdGlvbkRhdGFTb3VyY2UnLAogICckcGFyc2UnLApmdW5jdGlvbigkY29sbGVjdGlvblJlcGVhdE1hbmFnZXIsICRjb2xsZWN0aW9uRGF0YVNvdXJjZSwgJHBhcnNlKSB7CiAgcmV0dXJuIHsKICAgIHByaW9yaXR5OiAxMDAwLAogICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgdGVybWluYWw6IHRydWUsCiAgICAkJHRsYjogdHJ1ZSwKICAgIHJlcXVpcmU6ICdeJGlvbmljU2Nyb2xsJywKICAgIGNvbnRyb2xsZXI6IFtmdW5jdGlvbigpe31dLAogICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNjcm9sbEN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICAgIHZhciB3cmFwID0ganFMaXRlKCc8ZGl2IHN0eWxlPSJwb3NpdGlvbjpyZWxhdGl2ZTsiPicpOwogICAgICAkZWxlbWVudC5wYXJlbnQoKVswXS5pbnNlcnRCZWZvcmUod3JhcFswXSwgJGVsZW1lbnRbMF0pOwogICAgICB3cmFwLmFwcGVuZCgkZWxlbWVudCk7CgogICAgICB2YXIgc2Nyb2xsVmlldyA9IHNjcm9sbEN0cmwuc2Nyb2xsVmlldzsKICAgICAgaWYgKHNjcm9sbFZpZXcub3B0aW9ucy5zY3JvbGxpbmdYICYmIHNjcm9sbFZpZXcub3B0aW9ucy5zY3JvbGxpbmdZKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKENPTExFQ1RJT05fUkVQRUFUX1NDUk9MTFZJRVdfWFlfRVJST1IpOwogICAgICB9CgogICAgICB2YXIgaXNWZXJ0aWNhbCA9ICEhc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1k7CiAgICAgIGlmIChpc1ZlcnRpY2FsICYmICEkYXR0ci5jb2xsZWN0aW9uSXRlbUhlaWdodCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX0hFSUdIVF9FUlJPUik7CiAgICAgIH0gZWxzZSBpZiAoIWlzVmVydGljYWwgJiYgISRhdHRyLmNvbGxlY3Rpb25JdGVtV2lkdGgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoQ09MTEVDVElPTl9SRVBFQVRfQVRUUl9XSURUSF9FUlJPUik7CiAgICAgIH0KCiAgICAgIHZhciBoZWlnaHRQYXJzZWQgPSAkcGFyc2UoJGF0dHIuY29sbGVjdGlvbkl0ZW1IZWlnaHQgfHwgJyIxMDAlIicpOwogICAgICB2YXIgd2lkdGhQYXJzZWQgPSAkcGFyc2UoJGF0dHIuY29sbGVjdGlvbkl0ZW1XaWR0aCB8fCAnIjEwMCUiJyk7CgogICAgICB2YXIgaGVpZ2h0R2V0dGVyID0gZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgIHZhciByZXN1bHQgPSBoZWlnaHRQYXJzZWQoc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgaWYgKGlzU3RyaW5nKHJlc3VsdCkgJiYgcmVzdWx0LmluZGV4T2YoJyUnKSA+IC0xKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihwYXJzZUludChyZXN1bHQsIDEwKSAvIDEwMCAqIHNjcm9sbFZpZXcuX19jbGllbnRIZWlnaHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICB2YXIgd2lkdGhHZXR0ZXIgPSBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHdpZHRoUGFyc2VkKHNjb3BlLCBsb2NhbHMpOwogICAgICAgIGlmIChpc1N0cmluZyhyZXN1bHQpICYmIHJlc3VsdC5pbmRleE9mKCclJykgPiAtMSkgewogICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IocGFyc2VJbnQocmVzdWx0LCAxMCkgLyAxMDAgKiBzY3JvbGxWaWV3Ll9fY2xpZW50V2lkdGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwoKICAgICAgdmFyIG1hdGNoID0gJGF0dHIuY29sbGVjdGlvblJlcGVhdC5tYXRjaCgvXlxzKihbXHNcU10rPylccytpblxzKyhbXHNcU10rPykoPzpccyt0cmFja1xzK2J5XHMrKFtcc1xTXSs/KSk/XHMqJC8pOwogICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKENPTExFQ1RJT05fUkVQRUFUX0FUVFJfUkVQRUFUX0VSUk9SCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCclJywgJGF0dHIuY29sbGVjdGlvblJlcGVhdCkpOwogICAgICB9CiAgICAgIHZhciBrZXlFeHByID0gbWF0Y2hbMV07CiAgICAgIHZhciBsaXN0RXhwciA9IG1hdGNoWzJdOwogICAgICB2YXIgdHJhY2tCeUV4cHIgPSBtYXRjaFszXTsKCiAgICAgIHZhciBkYXRhU291cmNlID0gbmV3ICRjb2xsZWN0aW9uRGF0YVNvdXJjZSh7CiAgICAgICAgc2NvcGU6ICRzY29wZSwKICAgICAgICB0cmFuc2NsdWRlRm46ICR0cmFuc2NsdWRlLAogICAgICAgIHRyYW5zY2x1ZGVQYXJlbnQ6ICRlbGVtZW50LnBhcmVudCgpLAogICAgICAgIGtleUV4cHI6IGtleUV4cHIsCiAgICAgICAgbGlzdEV4cHI6IGxpc3RFeHByLAogICAgICAgIHRyYWNrQnlFeHByOiB0cmFja0J5RXhwciwKICAgICAgICBoZWlnaHRHZXR0ZXI6IGhlaWdodEdldHRlciwKICAgICAgICB3aWR0aEdldHRlcjogd2lkdGhHZXR0ZXIKICAgICAgfSk7CiAgICAgIHZhciBjb2xsZWN0aW9uUmVwZWF0TWFuYWdlciA9IG5ldyAkY29sbGVjdGlvblJlcGVhdE1hbmFnZXIoewogICAgICAgIGRhdGFTb3VyY2U6IGRhdGFTb3VyY2UsCiAgICAgICAgZWxlbWVudDogc2Nyb2xsQ3RybC4kZWxlbWVudCwKICAgICAgICBzY3JvbGxWaWV3OiBzY3JvbGxDdHJsLnNjcm9sbFZpZXcsCiAgICAgIH0pOwoKICAgICAgJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24obGlzdEV4cHIsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICYmICFhbmd1bGFyLmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNvbGxlY3Rpb24tcmVwZWF0IGV4cGVjdHMgYW4gYXJyYXkgdG8gcmVwZWF0IG92ZXIsIGJ1dCBpbnN0ZWFkIGdvdCAnIiArIHR5cGVvZiB2YWx1ZSArICInLiIpOwogICAgICAgIH0KICAgICAgICByZXJlbmRlcih2YWx1ZSk7CiAgICAgIH0pOwoKICAgICAgLy8gRmluZCBldmVyeSBzaWJsaW5nIGJlZm9yZSBhbmQgYWZ0ZXIgdGhlIHJlcGVhdGVkIGl0ZW1zLCBhbmQgcGFzcyB0aGVtCiAgICAgIC8vIHRvIHRoZSBkYXRhU291cmNlCiAgICAgIHZhciBzY3JvbGxWaWV3Q29udGVudCA9IHNjcm9sbEN0cmwuc2Nyb2xsVmlldy5fX2NvbnRlbnQ7CiAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyKHZhbHVlKSB7CiAgICAgICAgdmFyIGJlZm9yZVNpYmxpbmdzID0gW107CiAgICAgICAgdmFyIGFmdGVyU2libGluZ3MgPSBbXTsKICAgICAgICB2YXIgYmVmb3JlID0gdHJ1ZTsKCiAgICAgICAgZm9yRWFjaChzY3JvbGxWaWV3Q29udGVudC5jaGlsZHJlbiwgZnVuY3Rpb24obm9kZSwgaSkgewogICAgICAgICAgaWYgKCBpb25pYy5Eb21VdGlsLmVsZW1lbnRJc0Rlc2NlbmRhbnQoJGVsZW1lbnRbMF0sIG5vZGUsIHNjcm9sbFZpZXdDb250ZW50KSApIHsKICAgICAgICAgICAgYmVmb3JlID0gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoJ2NvbGxlY3Rpb24tcmVwZWF0LWlnbm9yZScpKSByZXR1cm47CiAgICAgICAgICAgIHZhciB3aWR0aCA9IG5vZGUub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgIHZhciBoZWlnaHQgPSBub2RlLm9mZnNldEhlaWdodDsKICAgICAgICAgICAgaWYgKHdpZHRoICYmIGhlaWdodCkgewogICAgICAgICAgICAgIHZhciBlbGVtZW50ID0ganFMaXRlKG5vZGUpOwogICAgICAgICAgICAgIChiZWZvcmUgPyBiZWZvcmVTaWJsaW5ncyA6IGFmdGVyU2libGluZ3MpLnB1c2goewogICAgICAgICAgICAgICAgd2lkdGg6IG5vZGUub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IG5vZGUub2Zmc2V0SGVpZ2h0LAogICAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICAgICAgICAgIHNjb3BlOiBlbGVtZW50Lmlzb2xhdGVTY29wZSgpIHx8IGVsZW1lbnQuc2NvcGUoKSwKICAgICAgICAgICAgICAgIGlzT3V0c2lkZTogdHJ1ZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHNjcm9sbFZpZXcucmVzaXplKCk7CiAgICAgICAgZGF0YVNvdXJjZS5zZXREYXRhKHZhbHVlLCBiZWZvcmVTaWJsaW5ncywgYWZ0ZXJTaWJsaW5ncyk7CiAgICAgICAgY29sbGVjdGlvblJlcGVhdE1hbmFnZXIucmVzaXplKCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVyZW5kZXJPblJlc2l6ZSgpIHsKICAgICAgICByZXJlbmRlcigkc2NvcGUuJGV2YWwobGlzdEV4cHIpKTsKICAgICAgfQoKICAgICAgc2Nyb2xsQ3RybC4kZWxlbWVudC5vbignc2Nyb2xsLnJlc2l6ZScsIHJlcmVuZGVyT25SZXNpemUpOwogICAgICBpb25pYy5vbigncmVzaXplJywgcmVyZW5kZXJPblJlc2l6ZSwgd2luZG93KTsKCiAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgY29sbGVjdGlvblJlcGVhdE1hbmFnZXIuZGVzdHJveSgpOwogICAgICAgIGRhdGFTb3VyY2UuZGVzdHJveSgpOwogICAgICAgIGlvbmljLm9mZigncmVzaXplJywgcmVyZW5kZXJPblJlc2l6ZSwgd2luZG93KTsKICAgICAgfSk7CiAgICB9CiAgfTsKfV0pCi5kaXJlY3RpdmUoewogIG5nU3JjOiBjb2xsZWN0aW9uUmVwZWF0U3JjRGlyZWN0aXZlKCduZ1NyYycsICdzcmMnKSwKICBuZ1NyY3NldDogY29sbGVjdGlvblJlcGVhdFNyY0RpcmVjdGl2ZSgnbmdTcmNzZXQnLCAnc3Jjc2V0JyksCiAgbmdIcmVmOiBjb2xsZWN0aW9uUmVwZWF0U3JjRGlyZWN0aXZlKCduZ0hyZWYnLCAnaHJlZicpCn0pOwoKLy8gRml4IGZvciAjMTY3NAovLyBQcm9ibGVtOiBpZiBhbiBuZ1NyYyBvciBuZ0hyZWYgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBmYWxzeSB2YWx1ZSwgaXQgd2lsbAovLyBub3QgZXJhc2UgdGhlIHByZXZpb3VzIHRydXRoeSB2YWx1ZSBvZiB0aGUgaHJlZi4KLy8gSW4gY29sbGVjdGlvblJlcGVhdCwgd2UgcmUtdXNlIGVsZW1lbnRzIGZyb20gYmVmb3JlLiBTbyBpZiB0aGUgbmdIcmVmIGV4cHJlc3Npb24KLy8gZXZhbHVhdGVzIHRvIHRydXRoeSBmb3IgaXRlbSAxIGFuZCB0aGVuIGZhbHN5IGZvciBpdGVtIDIsIGlmIGFuIGVsZW1lbnQgY2hhbmdlcwovLyBmcm9tIHJlcHJlc2VudGluZyBpdGVtIDEgdG8gcmVwcmVzZW50aW5nIGl0ZW0gMiwgaXRlbSAyIHdpbGwgc3RpbGwgaGF2ZQovLyBpdGVtIDEncyBocmVmIHZhbHVlLgovLyBTb2x1dGlvbjogIGVyYXNlIHRoZSBocmVmIG9yIHNyYyBhdHRyaWJ1dGUgaWYgbmdIcmVmL25nU3JjIGFyZSBmYWxzeS4KZnVuY3Rpb24gY29sbGVjdGlvblJlcGVhdFNyY0RpcmVjdGl2ZShuZ0F0dHJOYW1lLCBhdHRyTmFtZSkgewogIHJldHVybiBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBwcmlvcml0eTogJzk5JywgLy8gaXQgbmVlZHMgdG8gcnVuIGFmdGVyIHRoZSBhdHRyaWJ1dGVzIGFyZSBpbnRlcnBvbGF0ZWQKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBhdHRyLiRvYnNlcnZlKG5nQXR0ck5hbWUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgICAgIGVsZW1lbnRbMF0ucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uQ29udGVudAogKiBAbW9kdWxlIGlvbmljCiAqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY1Njcm9sbERlbGVnYXRlCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgaW9uQ29udGVudCBkaXJlY3RpdmUgcHJvdmlkZXMgYW4gZWFzeSB0byB1c2UgY29udGVudCBhcmVhIHRoYXQgY2FuIGJlIGNvbmZpZ3VyZWQKICogdG8gdXNlIElvbmljJ3MgY3VzdG9tIFNjcm9sbCBWaWV3LCBvciB0aGUgYnVpbHQgaW4gb3ZlcmZsb3cgc2Nyb2xsaW5nIG9mIHRoZSBicm93c2VyLgogKgogKiBXaGlsZSB3ZSByZWNvbW1lbmQgdXNpbmcgdGhlIGN1c3RvbSBTY3JvbGwgZmVhdHVyZXMgaW4gSW9uaWMgaW4gbW9zdCBjYXNlcywgc29tZXRpbWVzCiAqIChmb3IgcGVyZm9ybWFuY2UgcmVhc29ucykgb25seSB0aGUgYnJvd3NlcidzIG5hdGl2ZSBvdmVyZmxvdyBzY3JvbGxpbmcgd2lsbCBzdWZmaWNlLAogKiBhbmQgc28gd2UndmUgbWFkZSBpdCBlYXN5IHRvIHRvZ2dsZSBiZXR3ZWVuIHRoZSBJb25pYyBzY3JvbGwgaW1wbGVtZW50YXRpb24gYW5kCiAqIG92ZXJmbG93IHNjcm9sbGluZy4KICoKICogWW91IGNhbiBpbXBsZW1lbnQgcHVsbC10by1yZWZyZXNoIHdpdGggdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uUmVmcmVzaGVyfQogKiBkaXJlY3RpdmUsIGFuZCBpbmZpbml0ZSBzY3JvbGxpbmcgd2l0aCB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25JbmZpbml0ZVNjcm9sbH0KICogZGlyZWN0aXZlLgogKgogKiBCZSBhd2FyZSB0aGF0IHRoaXMgZGlyZWN0aXZlIGdldHMgaXRzIG93biBjaGlsZCBzY29wZS4gSWYgeW91IGRvIG5vdCB1bmRlcnN0YW5kIHdoeSB0aGlzCiAqIGlzIGltcG9ydGFudCwgeW91IGNhbiByZWFkIFtodHRwczovL2RvY3MuYW5ndWxhcmpzLm9yZy9ndWlkZS9zY29wZV0oaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvZ3VpZGUvc2NvcGUpLgogKgogKiBAcGFyYW0ge3N0cmluZz19IGRlbGVnYXRlLWhhbmRsZSBUaGUgaGFuZGxlIHVzZWQgdG8gaWRlbnRpZnkgdGhpcyBzY3JvbGxWaWV3CiAqIHdpdGgge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljU2Nyb2xsRGVsZWdhdGV9LgogKiBAcGFyYW0ge3N0cmluZz19IGRpcmVjdGlvbiBXaGljaCB3YXkgdG8gc2Nyb2xsLiAneCcgb3IgJ3knIG9yICd4eScuIERlZmF1bHQgJ3knLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBsb2NraW5nIFdoZXRoZXIgdG8gbG9jayBzY3JvbGxpbmcgaW4gb25lIGRpcmVjdGlvbiBhdCBhIHRpbWUuIFVzZWZ1bCB0byBzZXQgdG8gZmFsc2Ugd2hlbiB6b29tZWQgaW4gb3Igc2Nyb2xsaW5nIGluIHR3byBkaXJlY3Rpb25zLiBEZWZhdWx0IHRydWUuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IHBhZGRpbmcgV2hldGhlciB0byBhZGQgcGFkZGluZyB0byB0aGUgY29udGVudC4KICogb2YgdGhlIGNvbnRlbnQuICBEZWZhdWx0cyB0byB0cnVlIG9uIGlPUywgZmFsc2Ugb24gQW5kcm9pZC4KICogQHBhcmFtIHtib29sZWFuPX0gc2Nyb2xsIFdoZXRoZXIgdG8gYWxsb3cgc2Nyb2xsaW5nIG9mIGNvbnRlbnQuICBEZWZhdWx0cyB0byB0cnVlLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBvdmVyZmxvdy1zY3JvbGwgV2hldGhlciB0byB1c2Ugb3ZlcmZsb3ctc2Nyb2xsaW5nIGluc3RlYWQgb2YKICogSW9uaWMgc2Nyb2xsLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBzY3JvbGxiYXIteCBXaGV0aGVyIHRvIHNob3cgdGhlIGhvcml6b250YWwgc2Nyb2xsYmFyLiBEZWZhdWx0IHRydWUuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IHNjcm9sbGJhci15IFdoZXRoZXIgdG8gc2hvdyB0aGUgdmVydGljYWwgc2Nyb2xsYmFyLiBEZWZhdWx0IHRydWUuCiAqIEBwYXJhbSB7c3RyaW5nPX0gc3RhcnQteSBJbml0aWFsIHZlcnRpY2FsIHNjcm9sbCBwb3NpdGlvbi4gRGVmYXVsdCAwLgogKiBvZiB0aGUgY29udGVudC4gIERlZmF1bHRzIHRvIHRydWUgb24gaU9TLCBmYWxzZSBvbiBBbmRyb2lkLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1zY3JvbGwgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuIHRoZSBjb250ZW50IGlzIHNjcm9sbGVkLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1zY3JvbGwtY29tcGxldGUgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuIGEgc2Nyb2xsIGFjdGlvbiBjb21wbGV0ZXMuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGhhcy1ib3VuY2luZyBXaGV0aGVyIHRvIGFsbG93IHNjcm9sbGluZyB0byBib3VuY2UgcGFzdCB0aGUgZWRnZXMKICogb2YgdGhlIGNvbnRlbnQuICBEZWZhdWx0cyB0byB0cnVlIG9uIGlPUywgZmFsc2Ugb24gQW5kcm9pZC4KICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbkNvbnRlbnQnLCBbCiAgJyR0aW1lb3V0JywKICAnJGNvbnRyb2xsZXInLAogICckaW9uaWNCaW5kJywKZnVuY3Rpb24oJHRpbWVvdXQsICRjb250cm9sbGVyLCAkaW9uaWNCaW5kKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiAnXj9pb25OYXZWaWV3JywKICAgIHNjb3BlOiB0cnVlLAogICAgcHJpb3JpdHk6IDgwMCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgdmFyIGlubmVyRWxlbWVudDsKCiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3Njcm9sbC1jb250ZW50IGlvbmljLXNjcm9sbCcpOwoKICAgICAgaWYgKGF0dHIuc2Nyb2xsICE9ICdmYWxzZScpIHsKICAgICAgICAvL1dlIGNhbm5vdCB1c2Ugbm9ybWFsIHRyYW5zY2x1ZGUgaGVyZSBiZWNhdXNlIGl0IGJyZWFrcyBlbGVtZW50LmRhdGEoKQogICAgICAgIC8vaW5oZXJpdGFuY2Ugb24gY29tcGlsZQogICAgICAgIGlubmVyRWxlbWVudCA9IGpxTGl0ZSgnPGRpdiBjbGFzcz0ic2Nyb2xsIj48L2Rpdj4nKTsKICAgICAgICBpbm5lckVsZW1lbnQuYXBwZW5kKGVsZW1lbnQuY29udGVudHMoKSk7CiAgICAgICAgZWxlbWVudC5hcHBlbmQoaW5uZXJFbGVtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdzY3JvbGwtY29udGVudC1mYWxzZScpOwogICAgICB9CgogICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgbmF2Vmlld0N0cmwpIHsKICAgICAgICB2YXIgcGFyZW50U2NvcGUgPSAkc2NvcGUuJHBhcmVudDsKICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIChwYXJlbnRTY29wZS4kaGFzSGVhZGVyID8gJyBoYXMtaGVhZGVyJyA6ICcnKSAgKwogICAgICAgICAgICAocGFyZW50U2NvcGUuJGhhc1N1YmhlYWRlciA/ICcgaGFzLXN1YmhlYWRlcicgOiAnJykgKwogICAgICAgICAgICAocGFyZW50U2NvcGUuJGhhc0Zvb3RlciA/ICcgaGFzLWZvb3RlcicgOiAnJykgKwogICAgICAgICAgICAocGFyZW50U2NvcGUuJGhhc1N1YmZvb3RlciA/ICcgaGFzLXN1YmZvb3RlcicgOiAnJykgKwogICAgICAgICAgICAocGFyZW50U2NvcGUuJGhhc1RhYnMgPyAnIGhhcy10YWJzJyA6ICcnKSArCiAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzVGFic1RvcCA/ICcgaGFzLXRhYnMtdG9wJyA6ICcnKTsKICAgICAgICB9LCBmdW5jdGlvbihjbGFzc05hbWUsIG9sZENsYXNzTmFtZSkgewogICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3Mob2xkQ2xhc3NOYW1lKTsKICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vT25seSB0aGlzIGlvbkNvbnRlbnQgc2hvdWxkIHVzZSB0aGVzZSB2YXJpYWJsZXMgZnJvbSBwYXJlbnQgc2NvcGVzCiAgICAgICAgJHNjb3BlLiRoYXNIZWFkZXIgPSAkc2NvcGUuJGhhc1N1YmhlYWRlciA9CiAgICAgICAgICAkc2NvcGUuJGhhc0Zvb3RlciA9ICRzY29wZS4kaGFzU3ViZm9vdGVyID0KICAgICAgICAgICRzY29wZS4kaGFzVGFicyA9ICRzY29wZS4kaGFzVGFic1RvcCA9CiAgICAgICAgICBmYWxzZTsKICAgICAgICAkaW9uaWNCaW5kKCRzY29wZSwgJGF0dHIsIHsKICAgICAgICAgICRvblNjcm9sbDogJyZvblNjcm9sbCcsCiAgICAgICAgICAkb25TY3JvbGxDb21wbGV0ZTogJyZvblNjcm9sbENvbXBsZXRlJywKICAgICAgICAgIGhhc0JvdW5jaW5nOiAnQCcsCiAgICAgICAgICBwYWRkaW5nOiAnQCcsCiAgICAgICAgICBkaXJlY3Rpb246ICdAJywKICAgICAgICAgIHNjcm9sbGJhclg6ICdAJywKICAgICAgICAgIHNjcm9sbGJhclk6ICdAJywKICAgICAgICAgIHN0YXJ0WDogJ0AnLAogICAgICAgICAgc3RhcnRZOiAnQCcsCiAgICAgICAgICBzY3JvbGxFdmVudEludGVydmFsOiAnQCcKICAgICAgICB9KTsKICAgICAgICAkc2NvcGUuZGlyZWN0aW9uID0gJHNjb3BlLmRpcmVjdGlvbiB8fCAneSc7CgogICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZCgkYXR0ci5wYWRkaW5nKSkgewogICAgICAgICAgJHNjb3BlLiR3YXRjaCgkYXR0ci5wYWRkaW5nLCBmdW5jdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgICAoaW5uZXJFbGVtZW50IHx8ICRlbGVtZW50KS50b2dnbGVDbGFzcygncGFkZGluZycsICEhbmV3VmFsKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKCRhdHRyLnNjcm9sbCA9PT0gImZhbHNlIikgewogICAgICAgICAgLy9kbyBub3RoaW5nCiAgICAgICAgfSBlbHNlIGlmKGF0dHIub3ZlcmZsb3dTY3JvbGwgPT09ICJ0cnVlIikgewogICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoJ292ZXJmbG93LXNjcm9sbCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgc2Nyb2xsVmlld09wdGlvbnMgPSB7CiAgICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgICAgZGVsZWdhdGVIYW5kbGU6IGF0dHIuZGVsZWdhdGVIYW5kbGUsCiAgICAgICAgICAgIGxvY2tpbmc6IChhdHRyLmxvY2tpbmcgfHwgJ3RydWUnKSA9PT0gJ3RydWUnLAogICAgICAgICAgICBib3VuY2luZzogJHNjb3BlLiRldmFsKCRzY29wZS5oYXNCb3VuY2luZyksCiAgICAgICAgICAgIHN0YXJ0WDogJHNjb3BlLiRldmFsKCRzY29wZS5zdGFydFgpIHx8IDAsCiAgICAgICAgICAgIHN0YXJ0WTogJHNjb3BlLiRldmFsKCRzY29wZS5zdGFydFkpIHx8IDAsCiAgICAgICAgICAgIHNjcm9sbGJhclg6ICRzY29wZS4kZXZhbCgkc2NvcGUuc2Nyb2xsYmFyWCkgIT09IGZhbHNlLAogICAgICAgICAgICBzY3JvbGxiYXJZOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnNjcm9sbGJhclkpICE9PSBmYWxzZSwKICAgICAgICAgICAgc2Nyb2xsaW5nWDogJHNjb3BlLmRpcmVjdGlvbi5pbmRleE9mKCd4JykgPj0gMCwKICAgICAgICAgICAgc2Nyb2xsaW5nWTogJHNjb3BlLmRpcmVjdGlvbi5pbmRleE9mKCd5JykgPj0gMCwKICAgICAgICAgICAgc2Nyb2xsRXZlbnRJbnRlcnZhbDogcGFyc2VJbnQoJHNjb3BlLnNjcm9sbEV2ZW50SW50ZXJ2YWwsIDEwKSB8fCAxMCwKICAgICAgICAgICAgc2Nyb2xsaW5nQ29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRzY29wZS4kb25TY3JvbGxDb21wbGV0ZSh7CiAgICAgICAgICAgICAgICBzY3JvbGxUb3A6IHRoaXMuX19zY3JvbGxUb3AsCiAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0OiB0aGlzLl9fc2Nyb2xsTGVmdAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgJGNvbnRyb2xsZXIoJyRpb25pY1Njcm9sbCcsIHsKICAgICAgICAgICAgJHNjb3BlOiAkc2NvcGUsCiAgICAgICAgICAgIHNjcm9sbFZpZXdPcHRpb25zOiBzY3JvbGxWaWV3T3B0aW9ucwogICAgICAgICAgfSk7CgogICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2Nyb2xsVmlld09wdGlvbnMuc2Nyb2xsaW5nQ29tcGxldGUgPSBhbmd1bGFyLm5vb3A7CiAgICAgICAgICAgIGRlbGV0ZSBzY3JvbGxWaWV3T3B0aW9ucy5lbDsKICAgICAgICAgICAgaW5uZXJFbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgJGVsZW1lbnQgPSBudWxsOwogICAgICAgICAgICBhdHRyLiQkZWxlbWVudCA9IG51bGw7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZXhwb3NlQXNpZGVXaGVuCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICogQHBhcmVudCBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBJdCBpcyBjb21tb24gZm9yIGEgdGFibGV0IGFwcGxpY2F0aW9uIHRvIGhpZGUgYSBtZW51IHdoZW4gaW4gcG9ydHJhaXQgbW9kZSwgYnV0IHRvIHNob3cgdGhlCiAqIHNhbWUgbWVudSBvbiB0aGUgbGVmdCBzaWRlIHdoZW4gdGhlIHRhYmxldCBpcyBpbiBsYW5kc2NhcGUgbW9kZS4gVGhlIGBleHBvc2VBc2lkZVdoZW5gIGF0dHJpYnV0ZQogKiBkaXJlY3RpdmUgY2FuIGJlIHVzZWQgdG8gYWNjb21wbGlzaCBhIHNpbWlsYXIgaW50ZXJmYWNlLgogKgogKiBCeSBkZWZhdWx0LCBzaWRlIG1lbnVzIGFyZSBoaWRkZW4gdW5kZXJuZWF0aCBpdHMgc2lkZSBtZW51IGNvbnRlbnQsIGFuZCBjYW4gYmUgb3BlbmVkIGJ5IGVpdGhlcgogKiBzd2lwaW5nIHRoZSBjb250ZW50IGxlZnQgb3IgcmlnaHQsIG9yIHRvZ2dsaW5nIGEgYnV0dG9uIHRvIHNob3cgdGhlIHNpZGUgbWVudS4gSG93ZXZlciwgYnkgYWRkaW5nIHRoZQogKiBgZXhwb3NlQXNpZGVXaGVuYCBhdHRyaWJ1dGUgZGlyZWN0aXZlIHRvIGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnV9IGVsZW1lbnQgZGlyZWN0aXZlLAogKiBhIHNpZGUgbWVudSBjYW4gYmUgZ2l2ZW4gaW5zdHJ1Y3Rpb25zIG9uICJ3aGVuIiB0aGUgbWVudSBzaG91bGQgYmUgZXhwb3NlZCAoYWx3YXlzIHZpZXdhYmxlKS4gRm9yCiAqIGV4YW1wbGUsIHRoZSBgZXhwb3NlLWFzaWRlLXdoZW49ImxhcmdlImAgYXR0cmlidXRlIHdpbGwga2VlcCB0aGUgc2lkZSBtZW51IGhpZGRlbiB3aGVuIHRoZSB2aWV3cG9ydCdzCiAqIHdpZHRoIGlzIGxlc3MgdGhhbiBgNzY4cHhgLCBidXQgd2hlbiB0aGUgdmlld3BvcnQncyB3aWR0aCBpcyBgNzY4cHhgIG9yIGdyZWF0ZXIsIHRoZSBtZW51IHdpbGwgdGhlbgogKiBhbHdheXMgYmUgc2hvd24gYW5kIGNhbiBubyBsb25nZXIgYmUgb3BlbmVkIG9yIGNsb3NlZCBsaWtlIGl0IGNvdWxkIHdoZW4gaXQgd2FzIGhpZGRlbiBmb3Igc21hbGxlcgogKiB2aWV3cG9ydHMuCiAqCiAqIFVzaW5nIGBsYXJnZWAgYXMgdGhlIGF0dHJpYnV0ZSdzIHZhbHVlIGlzIGEgc2hvcnRjdXQgdmFsdWUgdG8gYChtaW4td2lkdGg6NzY4cHgpYCBzaW5jZSBpdCBpcwogKiB0aGUgbW9zdCBjb21tb24gdXNlLWNhc2UuIEhvd2V2ZXIsIGZvciBhZGRlZCBmbGV4aWJpbGl0eSwgYW55IHZhbGlkIG1lZGlhIHF1ZXJ5IGNvdWxkIGJlIGFkZGVkCiAqIGFzIHRoZSB2YWx1ZSwgc3VjaCBhcyBgKG1pbi13aWR0aDo2MDBweClgIG9yIGV2ZW4gbXVsdGlwbGUgcXVlcmllcyBzdWNoIGFzCiAqIGAobWluLXdpZHRoOjc1MHB4KSBhbmQgKG1heC13aWR0aDoxMjAwcHgpYC4KCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxpb24tc2lkZS1tZW51cz4KICogICA8IS0tIENlbnRlciBjb250ZW50IC0tPgogKiAgIDxpb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAqICAgPC9pb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAqCiAqICAgPCEtLSBMZWZ0IG1lbnUgLS0+CiAqICAgPGlvbi1zaWRlLW1lbnUgZXhwb3NlLWFzaWRlLXdoZW49ImxhcmdlIj4KICogICA8L2lvbi1zaWRlLW1lbnU+CiAqIDwvaW9uLXNpZGUtbWVudXM+CiAqIGBgYAogKiBGb3IgYSBjb21wbGV0ZSBzaWRlIG1lbnUgZXhhbXBsZSwgc2VlIHRoZQogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51c30gZG9jdW1lbnRhdGlvbi4KICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2V4cG9zZUFzaWRlV2hlbicsIFsnJHdpbmRvdycsIGZ1bmN0aW9uKCR3aW5kb3cpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIHJlcXVpcmU6ICdeaW9uU2lkZU1lbnVzJywKICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBzaWRlTWVudUN0cmwpIHsKCiAgICAgIGZ1bmN0aW9uIGNoZWNrQXNpZGVFeHBvc2UoKSB7CiAgICAgICAgdmFyIG1xID0gJGF0dHIuZXhwb3NlQXNpZGVXaGVuID09ICdsYXJnZScgPyAnKG1pbi13aWR0aDo3NjhweCknIDogJGF0dHIuZXhwb3NlQXNpZGVXaGVuOwogICAgICAgIHNpZGVNZW51Q3RybC5leHBvc2VBc2lkZSggJHdpbmRvdy5tYXRjaE1lZGlhKG1xKS5tYXRjaGVzICk7CiAgICAgICAgc2lkZU1lbnVDdHJsLmFjdGl2ZUFzaWRlUmVzaXppbmcoZmFsc2UpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBvblJlc2l6ZSgpIHsKICAgICAgICBzaWRlTWVudUN0cmwuYWN0aXZlQXNpZGVSZXNpemluZyh0cnVlKTsKICAgICAgICBkZWJvdW5jZWRDaGVjaygpOwogICAgICB9CgogICAgICB2YXIgZGVib3VuY2VkQ2hlY2sgPSBpb25pYy5kZWJvdW5jZShmdW5jdGlvbigpIHsKICAgICAgICAkc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCl7CiAgICAgICAgICBjaGVja0FzaWRlRXhwb3NlKCk7CiAgICAgICAgfSk7CiAgICAgIH0sIDMwMCwgZmFsc2UpOwoKICAgICAgY2hlY2tBc2lkZUV4cG9zZSgpOwoKICAgICAgaW9uaWMub24oJ3Jlc2l6ZScsIG9uUmVzaXplLCAkd2luZG93KTsKCiAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKXsKICAgICAgICBpb25pYy5vZmYoJ3Jlc2l6ZScsIG9uUmVzaXplLCAkd2luZG93KTsKICAgICAgfSk7CgogICAgfQogIH07Cn1dKTsKCgp2YXIgR0VTVFVSRV9ESVJFQ1RJVkVTID0gJ29uSG9sZCBvblRhcCBvblRvdWNoIG9uUmVsZWFzZSBvbkRyYWcgb25EcmFnVXAgb25EcmFnUmlnaHQgb25EcmFnRG93biBvbkRyYWdMZWZ0IG9uU3dpcGUgb25Td2lwZVVwIG9uU3dpcGVSaWdodCBvblN3aXBlRG93biBvblN3aXBlTGVmdCcuc3BsaXQoJyAnKTsKCkdFU1RVUkVfRElSRUNUSVZFUy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICBJb25pY01vZHVsZS5kaXJlY3RpdmUobmFtZSwgZ2VzdHVyZURpcmVjdGl2ZShuYW1lKSk7Cn0pOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uSG9sZAogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUb3VjaCBzdGF5cyBhdCB0aGUgc2FtZSBsb2NhdGlvbiBmb3IgNTAwbXMuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24taG9sZD0ib25Ib2xkKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uVGFwCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIFF1aWNrIHRvdWNoIGF0IGEgbG9jYXRpb24uIElmIHRoZSBkdXJhdGlvbiBvZiB0aGUgdG91Y2ggZ29lcwogKiBsb25nZXIgdGhhbiAyNTBtcyBpdCBpcyBubyBsb25nZXIgYSB0YXAgZ2VzdHVyZS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGJ1dHRvbiBvbi10YXA9Im9uVGFwKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uVG91Y2gKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogQ2FsbGVkIGltbWVkaWF0ZWx5IHdoZW4gdGhlIHVzZXIgZmlyc3QgYmVnaW5zIGEgdG91Y2guIFRoaXMKICogZ2VzdHVyZSBkb2VzIG5vdCB3YWl0IGZvciBhIHRvdWNoZW5kL21vdXNldXAuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tdG91Y2g9Im9uVG91Y2goKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25SZWxlYXNlCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxlZCB3aGVuIHRoZSB1c2VyIGVuZHMgYSB0b3VjaC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGJ1dHRvbiBvbi1yZWxlYXNlPSJvblJlbGVhc2UoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25EcmFnCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIE1vdmUgd2l0aCBvbmUgdG91Y2ggYXJvdW5kIG9uIHRoZSBwYWdlLiBCbG9ja2luZyB0aGUgc2Nyb2xsaW5nIHdoZW4KICogbW92aW5nIGxlZnQgYW5kIHJpZ2h0IGlzIGEgZ29vZCBwcmFjdGljZS4gV2hlbiBhbGwgdGhlIGRyYWcgZXZlbnRzIGFyZQogKiBibG9ja2luZyB5b3UgZGlzYWJsZSBzY3JvbGxpbmcgb24gdGhhdCBhcmVhLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLWRyYWc9Im9uRHJhZygpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBvbkRyYWdVcAogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDYWxsZWQgd2hlbiB0aGUgZWxlbWVudCBpcyBkcmFnZ2VkIHVwLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLWRyYWctdXA9Im9uRHJhZ1VwKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uRHJhZ1JpZ2h0CiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxlZCB3aGVuIHRoZSBlbGVtZW50IGlzIGRyYWdnZWQgdG8gdGhlIHJpZ2h0LgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLWRyYWctcmlnaHQ9Im9uRHJhZ1JpZ2h0KCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uRHJhZ0Rvd24KICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogQ2FsbGVkIHdoZW4gdGhlIGVsZW1lbnQgaXMgZHJhZ2dlZCBkb3duLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLWRyYWctZG93bj0ib25EcmFnRG93bigpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBvbkRyYWdMZWZ0CiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxlZCB3aGVuIHRoZSBlbGVtZW50IGlzIGRyYWdnZWQgdG8gdGhlIGxlZnQuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tZHJhZy1sZWZ0PSJvbkRyYWdMZWZ0KCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uU3dpcGUKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogQ2FsbGVkIHdoZW4gYSBtb3ZpbmcgdG91Y2ggaGFzIGEgaGlnaCB2ZWxvY2l0eSBpbiBhbnkgZGlyZWN0aW9uLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLXN3aXBlPSJvblN3aXBlKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uU3dpcGVVcAogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDYWxsZWQgd2hlbiBhIG1vdmluZyB0b3VjaCBoYXMgYSBoaWdoIHZlbG9jaXR5IG1vdmluZyB1cC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGJ1dHRvbiBvbi1zd2lwZS11cD0ib25Td2lwZVVwKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uU3dpcGVSaWdodAogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDYWxsZWQgd2hlbiBhIG1vdmluZyB0b3VjaCBoYXMgYSBoaWdoIHZlbG9jaXR5IG1vdmluZyB0byB0aGUgcmlnaHQuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tc3dpcGUtcmlnaHQ9Im9uU3dpcGVSaWdodCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBvblN3aXBlRG93bgogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDYWxsZWQgd2hlbiBhIG1vdmluZyB0b3VjaCBoYXMgYSBoaWdoIHZlbG9jaXR5IG1vdmluZyBkb3duLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLXN3aXBlLWRvd249Im9uU3dpcGVEb3duKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uU3dpcGVMZWZ0CiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxlZCB3aGVuIGEgbW92aW5nIHRvdWNoIGhhcyBhIGhpZ2ggdmVsb2NpdHkgbW92aW5nIHRvIHRoZSBsZWZ0LgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLXN3aXBlLWxlZnQ9Im9uU3dpcGVMZWZ0KCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCmZ1bmN0aW9uIGdlc3R1cmVEaXJlY3RpdmUoZGlyZWN0aXZlTmFtZSkgewogIHJldHVybiBbJyRpb25pY0dlc3R1cmUnLCAnJHBhcnNlJywgZnVuY3Rpb24oJGlvbmljR2VzdHVyZSwgJHBhcnNlKSB7CiAgICB2YXIgZXZlbnRUeXBlID0gZGlyZWN0aXZlTmFtZS5zdWJzdHIoMikudG9Mb3dlckNhc2UoKTsKCiAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgdmFyIGZuID0gJHBhcnNlKCBhdHRyW2RpcmVjdGl2ZU5hbWVdICk7CgogICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbihldikgewogICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgIGZuKHNjb3BlLCB7CiAgICAgICAgICAgICRldmVudDogZXYKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgdmFyIGdlc3R1cmUgPSAkaW9uaWNHZXN0dXJlLm9uKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGVsZW1lbnQpOwoKICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICRpb25pY0dlc3R1cmUub2ZmKGdlc3R1cmUsIGV2ZW50VHlwZSwgbGlzdGVuZXIpOwogICAgICB9KTsKICAgIH07CiAgfV07Cn0KCgpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25OYXZCYXInLCB0YXBTY3JvbGxUb1RvcERpcmVjdGl2ZSgpKQouZGlyZWN0aXZlKCdpb25IZWFkZXJCYXInLCB0YXBTY3JvbGxUb1RvcERpcmVjdGl2ZSgpKQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uSGVhZGVyQmFyCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIEFkZHMgYSBmaXhlZCBoZWFkZXIgYmFyIGFib3ZlIHNvbWUgY29udGVudC4KICoKICogQ2FuIGFsc28gYmUgYSBzdWJoZWFkZXIgKGxvd2VyIGRvd24pIGlmIHRoZSAnYmFyLXN1YmhlYWRlcicgY2xhc3MgaXMgYXBwbGllZC4KICogU2VlIFt0aGUgaGVhZGVyIENTUyBkb2NzXSgvZG9jcy9jb21wb25lbnRzLyNzdWJoZWFkZXIpLgogKgogKiBOb3RlOiBJZiB5b3UgdXNlIGlvbkhlYWRlckJhciBpbiBjb21iaW5hdGlvbiB3aXRoIG5nLWlmLCB0aGUgc3Vycm91bmRpbmcgY29udGVudAogKiB3aWxsIG5vdCBhbGlnbiBjb3JyZWN0bHkuICBUaGlzIHdpbGwgYmUgZml4ZWQgc29vbi4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBhbGlnbi10aXRsZSBXaGVyZSB0byBhbGlnbiB0aGUgdGl0bGUuIAogKiBBdmFpbGFibGU6ICdsZWZ0JywgJ3JpZ2h0Jywgb3IgJ2NlbnRlcicuICBEZWZhdWx0cyB0byAnY2VudGVyJy4KICogQHBhcmFtIHtib29sZWFuPX0gbm8tdGFwLXNjcm9sbCBCeSBkZWZhdWx0LCB0aGUgaGVhZGVyIGJhciB3aWxsIHNjcm9sbCB0aGUKICogY29udGVudCB0byB0aGUgdG9wIHdoZW4gdGFwcGVkLiAgU2V0IG5vLXRhcC1zY3JvbGwgdG8gdHJ1ZSB0byBkaXNhYmxlIHRoaXMgCiAqIGJlaGF2aW9yLgogKiBBdmFpbGFibGU6IHRydWUgb3IgZmFsc2UuICBEZWZhdWx0cyB0byBmYWxzZS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi1oZWFkZXItYmFyIGFsaWduLXRpdGxlPSJsZWZ0IiBjbGFzcz0iYmFyLXBvc2l0aXZlIj4KICogICA8ZGl2IGNsYXNzPSJidXR0b25zIj4KICogICAgIDxidXR0b24gY2xhc3M9ImJ1dHRvbiIgbmctY2xpY2s9ImRvU29tZXRoaW5nKCkiPkxlZnQgQnV0dG9uPC9idXR0b24+CiAqICAgPC9kaXY+CiAqICAgPGgxIGNsYXNzPSJ0aXRsZSI+VGl0bGUhPC9oMT4KICogICA8ZGl2IGNsYXNzPSJidXR0b25zIj4KICogICAgIDxidXR0b24gY2xhc3M9ImJ1dHRvbiI+UmlnaHQgQnV0dG9uPC9idXR0b24+CiAqICAgPC9kaXY+CiAqIDwvaW9uLWhlYWRlci1iYXI+CiAqIDxpb24tY29udGVudD4KICogICBTb21lIGNvbnRlbnQhCiAqIDwvaW9uLWNvbnRlbnQ+CiAqIGBgYAogKi8KLmRpcmVjdGl2ZSgnaW9uSGVhZGVyQmFyJywgaGVhZGVyRm9vdGVyQmFyRGlyZWN0aXZlKHRydWUpKQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uRm9vdGVyQmFyCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIEFkZHMgYSBmaXhlZCBmb290ZXIgYmFyIGJlbG93IHNvbWUgY29udGVudC4KICoKICogQ2FuIGFsc28gYmUgYSBzdWJmb290ZXIgKGhpZ2hlciB1cCkgaWYgdGhlICdiYXItc3ViZm9vdGVyJyBjbGFzcyBpcyBhcHBsaWVkLgogKiBTZWUgW3RoZSBmb290ZXIgQ1NTIGRvY3NdKC9kb2NzL2NvbXBvbmVudHMvI2Zvb3RlcikuCiAqCiAqIE5vdGU6IElmIHlvdSB1c2UgaW9uRm9vdGVyQmFyIGluIGNvbWJpbmF0aW9uIHdpdGggbmctaWYsIHRoZSBzdXJyb3VuZGluZyBjb250ZW50CiAqIHdpbGwgbm90IGFsaWduIGNvcnJlY3RseS4gIFRoaXMgd2lsbCBiZSBmaXhlZCBzb29uLgogKgogKiBAcGFyYW0ge3N0cmluZz19IGFsaWduLXRpdGxlIFdoZXJlIHRvIGFsaWduIHRoZSB0aXRsZS4KICogQXZhaWxhYmxlOiAnbGVmdCcsICdyaWdodCcsIG9yICdjZW50ZXInLiAgRGVmYXVsdHMgdG8gJ2NlbnRlcicuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxpb24tY29udGVudD4KICogICBTb21lIGNvbnRlbnQhCiAqIDwvaW9uLWNvbnRlbnQ+CiAqIDxpb24tZm9vdGVyLWJhciBhbGlnbi10aXRsZT0ibGVmdCIgY2xhc3M9ImJhci1hc3NlcnRpdmUiPgogKiAgIDxkaXYgY2xhc3M9ImJ1dHRvbnMiPgogKiAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIj5MZWZ0IEJ1dHRvbjwvYnV0dG9uPgogKiAgIDwvZGl2PgogKiAgIDxoMSBjbGFzcz0idGl0bGUiPlRpdGxlITwvaDE+CiAqICAgPGRpdiBjbGFzcz0iYnV0dG9ucyIgbmctY2xpY2s9ImRvU29tZXRoaW5nKCkiPgogKiAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIj5SaWdodCBCdXR0b248L2J1dHRvbj4KICogICA8L2Rpdj4KICogPC9pb24tZm9vdGVyLWJhcj4KICogYGBgCiAqLwouZGlyZWN0aXZlKCdpb25Gb290ZXJCYXInLCBoZWFkZXJGb290ZXJCYXJEaXJlY3RpdmUoZmFsc2UpKTsKCmZ1bmN0aW9uIHRhcFNjcm9sbFRvVG9wRGlyZWN0aXZlKCkgewogIHJldHVybiBbJyRpb25pY1Njcm9sbERlbGVnYXRlJywgZnVuY3Rpb24oJGlvbmljU2Nyb2xsRGVsZWdhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgaWYgKCRhdHRyLm5vVGFwU2Nyb2xsID09ICd0cnVlJykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpb25pYy5vbigndGFwJywgb25UYXAsICRlbGVtZW50WzBdKTsKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaW9uaWMub2ZmKCd0YXAnLCBvblRhcCwgJGVsZW1lbnRbMF0pOwogICAgICAgIH0pOwoKICAgICAgICBmdW5jdGlvbiBvblRhcChlKSB7CiAgICAgICAgICB2YXIgZGVwdGggPSAzOwogICAgICAgICAgdmFyIGN1cnJlbnQgPSBlLnRhcmdldDsKICAgICAgICAgIC8vRG9uJ3Qgc2Nyb2xsIHRvIHRvcCBpbiBjZXJ0YWluIGNhc2VzCiAgICAgICAgICB3aGlsZSAoZGVwdGgtLSAmJiBjdXJyZW50KSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50LmNsYXNzTGlzdC5jb250YWlucygnYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGN1cnJlbnQudGFnTmFtZS5tYXRjaCgvaW5wdXR8dGV4dGFyZWF8c2VsZWN0L2kpIHx8CiAgICAgICAgICAgICAgICBjdXJyZW50LmlzQ29udGVudEVkaXRhYmxlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdG91Y2ggPSBlLmdlc3R1cmUgJiYgZS5nZXN0dXJlLnRvdWNoZXNbMF0gfHwgZS5kZXRhaWwudG91Y2hlc1swXTsKICAgICAgICAgIHZhciBib3VuZHMgPSAkZWxlbWVudFswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgIGlmIChpb25pYy5Eb21VdGlsLnJlY3RDb250YWlucygKICAgICAgICAgICAgdG91Y2gucGFnZVgsIHRvdWNoLnBhZ2VZLAogICAgICAgICAgICBib3VuZHMubGVmdCwgYm91bmRzLnRvcCAtIDIwLAogICAgICAgICAgICBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQKICAgICAgICAgICkpIHsKICAgICAgICAgICAgJGlvbmljU2Nyb2xsRGVsZWdhdGUuc2Nyb2xsVG9wKHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XTsKfQoKZnVuY3Rpb24gaGVhZGVyRm9vdGVyQmFyRGlyZWN0aXZlKGlzSGVhZGVyKSB7CiAgcmV0dXJuIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cikgewogICAgICAgICRlbGVtZW50LmFkZENsYXNzKGlzSGVhZGVyID8gJ2JhciBiYXItaGVhZGVyJyA6ICdiYXIgYmFyLWZvb3RlcicpOwogICAgICAgIHZhciBwYXJlbnQgPSAkZWxlbWVudFswXS5wYXJlbnROb2RlOwogICAgICAgIGlmKHBhcmVudC5xdWVyeVNlbGVjdG9yKCcudGFicy10b3AnKSkkZWxlbWVudC5hZGRDbGFzcygnaGFzLXRhYnMtdG9wJyk7CiAgICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgdmFyIGhiID0gbmV3IGlvbmljLnZpZXdzLkhlYWRlckJhcih7CiAgICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgICAgYWxpZ25UaXRsZTogJGF0dHIuYWxpZ25UaXRsZSB8fCAnY2VudGVyJwogICAgICAgICAgfSk7CgogICAgICAgICAgdmFyIGVsID0gJGVsZW1lbnRbMF07CgogICAgICAgICAgaWYgKGlzSGVhZGVyKSB7CiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7IHJldHVybiBlbC5jbGFzc05hbWU7IH0sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGlzU2hvd24gPSB2YWx1ZS5pbmRleE9mKCduZy1oaWRlJykgPT09IC0xOwogICAgICAgICAgICAgIHZhciBpc1N1YmhlYWRlciA9IHZhbHVlLmluZGV4T2YoJ2Jhci1zdWJoZWFkZXInKSAhPT0gLTE7CiAgICAgICAgICAgICAgJHNjb3BlLiRoYXNIZWFkZXIgPSBpc1Nob3duICYmICFpc1N1YmhlYWRlcjsKICAgICAgICAgICAgICAkc2NvcGUuJGhhc1N1YmhlYWRlciA9IGlzU2hvd24gJiYgaXNTdWJoZWFkZXI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGRlbGV0ZSAkc2NvcGUuJGhhc0hlYWRlcjsKICAgICAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNTdWJoZWFkZXI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsgcmV0dXJuIGVsLmNsYXNzTmFtZTsgfSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgaXNTaG93biA9IHZhbHVlLmluZGV4T2YoJ25nLWhpZGUnKSA9PT0gLTE7CiAgICAgICAgICAgICAgdmFyIGlzU3ViZm9vdGVyID0gdmFsdWUuaW5kZXhPZignYmFyLXN1YmZvb3RlcicpICE9PSAtMTsKICAgICAgICAgICAgICAkc2NvcGUuJGhhc0Zvb3RlciA9IGlzU2hvd24gJiYgIWlzU3ViZm9vdGVyOwogICAgICAgICAgICAgICRzY29wZS4kaGFzU3ViZm9vdGVyID0gaXNTaG93biAmJiBpc1N1YmZvb3RlcjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzRm9vdGVyOwogICAgICAgICAgICAgIGRlbGV0ZSAkc2NvcGUuJGhhc1N1YmZvb3RlcjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJyRoYXNUYWJzJywgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgJGVsZW1lbnQudG9nZ2xlQ2xhc3MoJ2hhcy10YWJzJywgISF2YWwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV07Cn0KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvbkluZmluaXRlU2Nyb2xsCiAqIEBtb2R1bGUgaW9uaWMKICogQHBhcmVudCBpb25pYy5kaXJlY3RpdmU6aW9uQ29udGVudCwgaW9uaWMuZGlyZWN0aXZlOmlvblNjcm9sbAogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGlvbkluZmluaXRlU2Nyb2xsIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIGNhbGwgYSBmdW5jdGlvbiB3aGVuZXZlcgogKiB0aGUgdXNlciBnZXRzIHRvIHRoZSBib3R0b20gb2YgdGhlIHBhZ2Ugb3IgbmVhciB0aGUgYm90dG9tIG9mIHRoZSBwYWdlLgogKgogKiBUaGUgZXhwcmVzc2lvbiB5b3UgcGFzcyBpbiBmb3IgYG9uLWluZmluaXRlYCBpcyBjYWxsZWQgd2hlbiB0aGUgdXNlciBzY3JvbGxzCiAqIGdyZWF0ZXIgdGhhbiBgZGlzdGFuY2VgIGF3YXkgZnJvbSB0aGUgYm90dG9tIG9mIHRoZSBjb250ZW50LiAgT25jZSBgb24taW5maW5pdGVgCiAqIGlzIGRvbmUgbG9hZGluZyBuZXcgZGF0YSwgaXQgc2hvdWxkIGJyb2FkY2FzdCB0aGUgYHNjcm9sbC5pbmZpbml0ZVNjcm9sbENvbXBsZXRlYAogKiBldmVudCBmcm9tIHlvdXIgY29udHJvbGxlciAoc2VlIGJlbG93IGV4YW1wbGUpLgogKgogKiBAcGFyYW0ge2V4cHJlc3Npb259IG9uLWluZmluaXRlIFdoYXQgdG8gY2FsbCB3aGVuIHRoZSBzY3JvbGxlciByZWFjaGVzIHRoZQogKiBib3R0b20uCiAqIEBwYXJhbSB7c3RyaW5nPX0gZGlzdGFuY2UgVGhlIGRpc3RhbmNlIGZyb20gdGhlIGJvdHRvbSB0aGF0IHRoZSBzY3JvbGwgbXVzdAogKiByZWFjaCB0byB0cmlnZ2VyIHRoZSBvbi1pbmZpbml0ZSBleHByZXNzaW9uLiBEZWZhdWx0OiAxJS4KICogQHBhcmFtIHtzdHJpbmc9fSBpY29uIFRoZSBpY29uIHRvIHNob3cgd2hpbGUgbG9hZGluZy4gRGVmYXVsdDogJ2lvbi1sb2FkaW5nLWQnLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8aW9uLWNvbnRlbnQgbmctY29udHJvbGxlcj0iTXlDb250cm9sbGVyIj4KICogICA8aW9uLWxpc3Q+CiAqICAgLi4uLgogKiAgIC4uLi4KICogICA8L2lvbi1saXN0PgogKgogKiAgIDxpb24taW5maW5pdGUtc2Nyb2xsCiAqICAgICBvbi1pbmZpbml0ZT0ibG9hZE1vcmUoKSIKICogICAgIGRpc3RhbmNlPSIxJSI+CiAqICAgPC9pb24taW5maW5pdGUtc2Nyb2xsPgogKiA8L2lvbi1jb250ZW50PgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJGh0dHApIHsKICogICAkc2NvcGUuaXRlbXMgPSBbXTsKICogICAkc2NvcGUubG9hZE1vcmUgPSBmdW5jdGlvbigpIHsKICogICAgICRodHRwLmdldCgnL21vcmUtaXRlbXMnKS5zdWNjZXNzKGZ1bmN0aW9uKGl0ZW1zKSB7CiAqICAgICAgIHVzZUl0ZW1zKGl0ZW1zKTsKICogICAgICAgJHNjb3BlLiRicm9hZGNhc3QoJ3Njcm9sbC5pbmZpbml0ZVNjcm9sbENvbXBsZXRlJyk7CiAqICAgICB9KTsKICogICB9OwogKgogKiAgICRzY29wZS4kb24oJ3N0YXRlQ2hhbmdlU3VjY2VzcycsIGZ1bmN0aW9uKCkgewogKiAgICAgJHNjb3BlLmxvYWRNb3JlKCk7CiAqICAgfSk7CiAqIH0KICogYGBgCiAqCiAqIEFuIGVhc3kgdG8gd2F5IHRvIHN0b3AgaW5maW5pdGUgc2Nyb2xsIG9uY2UgdGhlcmUgaXMgbm8gbW9yZSBkYXRhIHRvIGxvYWQKICogaXMgdG8gdXNlIGFuZ3VsYXIncyBgbmctaWZgIGRpcmVjdGl2ZToKICoKICogYGBgaHRtbAogKiA8aW9uLWluZmluaXRlLXNjcm9sbAogKiAgIG5nLWlmPSJtb3JlRGF0YUNhbkJlTG9hZGVkKCkiCiAqICAgaWNvbj0iaW9uLWxvYWRpbmctYyIKICogICBvbi1pbmZpbml0ZT0ibG9hZE1vcmVEYXRhKCkiPgogKiA8L2lvbi1pbmZpbml0ZS1zY3JvbGw+CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uSW5maW5pdGVTY3JvbGwnLCBbJyR0aW1lb3V0JywgZnVuY3Rpb24oJHRpbWVvdXQpIHsKICBmdW5jdGlvbiBjYWxjdWxhdGVNYXhWYWx1ZShkaXN0YW5jZSwgbWF4aW11bSwgaXNQZXJjZW50KSB7CiAgICByZXR1cm4gaXNQZXJjZW50ID8KICAgICAgbWF4aW11bSAqICgxIC0gcGFyc2VGbG9hdChkaXN0YW5jZSwxMCkgLyAxMDApIDoKICAgICAgbWF4aW11bSAtIHBhcnNlRmxvYXQoZGlzdGFuY2UsIDEwKTsKICB9CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiBbJ14kaW9uaWNTY3JvbGwnLCAnaW9uSW5maW5pdGVTY3JvbGwnXSwKICAgIHRlbXBsYXRlOiAnPGkgY2xhc3M9Imljb24ge3tpY29uKCl9fSBpY29uLXJlZnJlc2hpbmciPjwvaT4nLAogICAgc2NvcGU6IHRydWUsCiAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckYXR0cnMnLCBmdW5jdGlvbigkc2NvcGUsICRhdHRycykgewogICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlOwogICAgICB0aGlzLnNjcm9sbFZpZXcgPSBudWxsOyAvL2dpdmVuIGJ5IGxpbmsgZnVuY3Rpb24KICAgICAgdGhpcy5nZXRNYXhTY3JvbGwgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGlzdGFuY2UgPSAoJGF0dHJzLmRpc3RhbmNlIHx8ICcyLjUlJykudHJpbSgpOwogICAgICAgIHZhciBpc1BlcmNlbnQgPSBkaXN0YW5jZS5pbmRleE9mKCclJykgIT09IC0xOwogICAgICAgIHZhciBtYXhWYWx1ZXMgPSB0aGlzLnNjcm9sbFZpZXcuZ2V0U2Nyb2xsTWF4KCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxlZnQ6IHRoaXMuc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1ggPwogICAgICAgICAgICBjYWxjdWxhdGVNYXhWYWx1ZShkaXN0YW5jZSwgbWF4VmFsdWVzLmxlZnQsIGlzUGVyY2VudCkgOgogICAgICAgICAgICAtMSwKICAgICAgICAgIHRvcDogdGhpcy5zY3JvbGxWaWV3Lm9wdGlvbnMuc2Nyb2xsaW5nWSA/CiAgICAgICAgICAgIGNhbGN1bGF0ZU1heFZhbHVlKGRpc3RhbmNlLCBtYXhWYWx1ZXMudG9wLCBpc1BlcmNlbnQpIDoKICAgICAgICAgICAgLTEKICAgICAgICB9OwogICAgICB9OwogICAgfV0sCiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsIGN0cmxzKSB7CiAgICAgIHZhciBzY3JvbGxDdHJsID0gY3RybHNbMF07CiAgICAgIHZhciBpbmZpbml0ZVNjcm9sbEN0cmwgPSBjdHJsc1sxXTsKICAgICAgdmFyIHNjcm9sbFZpZXcgPSBpbmZpbml0ZVNjcm9sbEN0cmwuc2Nyb2xsVmlldyA9IHNjcm9sbEN0cmwuc2Nyb2xsVmlldzsKCiAgICAgICRzY29wZS5pY29uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRycy5pY29uKSA/ICRhdHRycy5pY29uIDogJ2lvbi1sb2FkaW5nLWQnOwogICAgICB9OwoKICAgICAgdmFyIG9uSW5maW5pdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAkZWxlbWVudFswXS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICBpbmZpbml0ZVNjcm9sbEN0cmwuaXNMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAkc2NvcGUuJHBhcmVudCAmJiAkc2NvcGUuJHBhcmVudC4kYXBwbHkoJGF0dHJzLm9uSW5maW5pdGUgfHwgJycpOwogICAgICB9OwoKICAgICAgdmFyIGZpbmlzaEluZmluaXRlU2Nyb2xsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgJGVsZW1lbnRbMF0uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY3JvbGxWaWV3LnJlc2l6ZSgpOwogICAgICAgICAgY2hlY2tCb3VuZHMoKTsKICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgICAgaW5maW5pdGVTY3JvbGxDdHJsLmlzTG9hZGluZyA9IGZhbHNlOwogICAgICB9OwoKICAgICAgJHNjb3BlLiRvbignc2Nyb2xsLmluZmluaXRlU2Nyb2xsQ29tcGxldGUnLCBmdW5jdGlvbigpIHsKICAgICAgICBmaW5pc2hJbmZpbml0ZVNjcm9sbCgpOwogICAgICB9KTsKCiAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2Nyb2xsQ3RybC4kZWxlbWVudC5vZmYoJ3Njcm9sbCcsIGNoZWNrQm91bmRzKTsKICAgICAgfSk7CgogICAgICB2YXIgY2hlY2tCb3VuZHMgPSBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGNoZWNrSW5maW5pdGVCb3VuZHMpOwoKICAgICAgLy9DaGVjayBib3VuZHMgb24gc3RhcnQsIGFmdGVyIHNjcm9sbFZpZXcgaXMgZnVsbHkgcmVuZGVyZWQKICAgICAgc2V0VGltZW91dChjaGVja0JvdW5kcyk7CiAgICAgIHNjcm9sbEN0cmwuJGVsZW1lbnQub24oJ3Njcm9sbCcsIGNoZWNrQm91bmRzKTsKCiAgICAgIGZ1bmN0aW9uIGNoZWNrSW5maW5pdGVCb3VuZHMoKSB7CiAgICAgICAgaWYgKGluZmluaXRlU2Nyb2xsQ3RybC5pc0xvYWRpbmcpIHJldHVybjsKCiAgICAgICAgdmFyIHNjcm9sbFZhbHVlcyA9IHNjcm9sbFZpZXcuZ2V0VmFsdWVzKCk7CiAgICAgICAgdmFyIG1heFNjcm9sbCA9IGluZmluaXRlU2Nyb2xsQ3RybC5nZXRNYXhTY3JvbGwoKTsKCiAgICAgICAgaWYgKChtYXhTY3JvbGwubGVmdCAhPT0gLTEgJiYgc2Nyb2xsVmFsdWVzLmxlZnQgPj0gbWF4U2Nyb2xsLmxlZnQpIHx8CiAgICAgICAgICAgIChtYXhTY3JvbGwudG9wICE9PSAtMSAmJiBzY3JvbGxWYWx1ZXMudG9wID49IG1heFNjcm9sbC50b3ApKSB7CiAgICAgICAgICBvbkluZmluaXRlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKdmFyIElURU1fVFBMX0NPTlRFTlRfQU5DSE9SID0KICAnPGEgY2xhc3M9Iml0ZW0tY29udGVudCIgbmctaHJlZj0ie3skaHJlZigpfX0iIHRhcmdldD0ie3skdGFyZ2V0KCl9fSI+PC9hPic7CnZhciBJVEVNX1RQTF9DT05URU5UID0KICAnPGRpdiBjbGFzcz0iaXRlbS1jb250ZW50Ij48L2Rpdj4nOwovKioKKiBAbmdkb2MgZGlyZWN0aXZlCiogQG5hbWUgaW9uSXRlbQoqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3QKKiBAbW9kdWxlIGlvbmljCiogQHJlc3RyaWN0IEUKKiBDcmVhdGVzIGEgbGlzdC1pdGVtIHRoYXQgY2FuIGVhc2lseSBiZSBzd2lwZWQsCiogZGVsZXRlZCwgcmVvcmRlcmVkLCBlZGl0ZWQsIGFuZCBtb3JlLgoqCiogU2VlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdH0gZm9yIGEgY29tcGxldGUgZXhhbXBsZSAmIGV4cGxhbmF0aW9uLgoqCiogQ2FuIGJlIGFzc2lnbmVkIGFueSBpdGVtIGNsYXNzIG5hbWUuIFNlZSB0aGUKKiBbbGlzdCBDU1MgZG9jdW1lbnRhdGlvbl0oL2RvY3MvY29tcG9uZW50cy8jbGlzdCkuCioKKiBAdXNhZ2UKKgoqIGBgYGh0bWwKKiA8aW9uLWxpc3Q+CiogICA8aW9uLWl0ZW0+SGVsbG8hPC9pb24taXRlbT4KKiAgIDxpb24taXRlbSBocmVmPSIjL2RldGFpbCI+CiogICAgIExpbmsgdG8gZGV0YWlsIHBhZ2UKKiAgIDxpb24taXRlbT4KKiA8L2lvbi1saXN0PgoqIGBgYAoqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25JdGVtJywgWwogICckYW5pbWF0ZScsCiAgJyRjb21waWxlJywKZnVuY3Rpb24oJGFuaW1hdGUsICRjb21waWxlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgdGhpcy4kc2NvcGUgPSAkc2NvcGU7CiAgICAgIHRoaXMuJGVsZW1lbnQgPSAkZWxlbWVudDsKICAgIH1dLAogICAgc2NvcGU6IHRydWUsCiAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgIHZhciBpc0FuY2hvciA9IGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRycy5ocmVmKSB8fAogICAgICAgIGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRycy5uZ0hyZWYpIHx8CiAgICAgICAgYW5ndWxhci5pc0RlZmluZWQoJGF0dHJzLnVpU3JlZik7CiAgICAgIHZhciBpc0NvbXBsZXhJdGVtID0gaXNBbmNob3IgfHwKICAgICAgICAvL0xhbWUgd2F5IG9mIHRlc3RpbmcsIGJ1dCB3ZSBoYXZlIHRvIGtub3cgYXQgY29tcGlsZSB3aGF0IHRvIGRvIHdpdGggdGhlIGVsZW1lbnQKICAgICAgICAvaW9uLShkZWxldGV8b3B0aW9ufHJlb3JkZXIpLWJ1dHRvbi9pLnRlc3QoJGVsZW1lbnQuaHRtbCgpKTsKCiAgICAgICAgaWYgKGlzQ29tcGxleEl0ZW0pIHsKICAgICAgICAgIHZhciBpbm5lckVsZW1lbnQgPSBqcUxpdGUoaXNBbmNob3IgPyBJVEVNX1RQTF9DT05URU5UX0FOQ0hPUiA6IElURU1fVFBMX0NPTlRFTlQpOwogICAgICAgICAgaW5uZXJFbGVtZW50LmFwcGVuZCgkZWxlbWVudC5jb250ZW50cygpKTsKCiAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoaW5uZXJFbGVtZW50KTsKICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKCdpdGVtIGl0ZW0tY29tcGxleCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygnaXRlbScpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgICAgICAkc2NvcGUuJGhyZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICRhdHRycy5ocmVmIHx8ICRhdHRycy5uZ0hyZWY7CiAgICAgICAgICB9OwogICAgICAgICAgJHNjb3BlLiR0YXJnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICRhdHRycy50YXJnZXQgfHwgJ19zZWxmJzsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KICB9Owp9XSk7Cgp2YXIgSVRFTV9UUExfREVMRVRFX0JVVFRPTiA9CiAgJzxkaXYgY2xhc3M9Iml0ZW0tbGVmdC1lZGl0IGl0ZW0tZGVsZXRlIGVuYWJsZS1wb2ludGVyLWV2ZW50cyI+JyArCiAgJzwvZGl2Pic7Ci8qKgoqIEBuZ2RvYyBkaXJlY3RpdmUKKiBAbmFtZSBpb25EZWxldGVCdXR0b24KKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25JdGVtCiogQG1vZHVsZSBpb25pYwoqIEByZXN0cmljdCBFCiogQ3JlYXRlcyBhIGRlbGV0ZSBidXR0b24gaW5zaWRlIGEgbGlzdCBpdGVtLCB0aGF0IGlzIHZpc2libGUgd2hlbiB0aGUKKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3QgaW9uTGlzdCBwYXJlbnQnc30gYHNob3ctZGVsZXRlYCBldmFsdWF0ZXMgdG8gdHJ1ZSBvcgoqIGAkaW9uaWNMaXN0RGVsZWdhdGUuc2hvd0RlbGV0ZSh0cnVlKWAgaXMgY2FsbGVkLgoqCiogVGFrZXMgYW55IGlvbmljb24gYXMgYSBjbGFzcy4KKgoqIFNlZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3R9IGZvciBhIGNvbXBsZXRlIGV4YW1wbGUgJiBleHBsYW5hdGlvbi4KKgoqIEB1c2FnZQoqCiogYGBgaHRtbAoqIDxpb24tbGlzdCBzaG93LWRlbGV0ZT0ic2hvdWxkU2hvd0RlbGV0ZSI+CiogICA8aW9uLWl0ZW0+CiogICAgIDxpb24tZGVsZXRlLWJ1dHRvbiBjbGFzcz0iaW9uLW1pbnVzLWNpcmNsZWQiPjwvaW9uLWRlbGV0ZS1idXR0b24+CiogICAgIEhlbGxvLCBsaXN0IGl0ZW0hCiogICA8L2lvbi1pdGVtPgoqIDwvaW9uLWxpc3Q+CiogPGlvbi10b2dnbGUgbmctbW9kZWw9InNob3VsZFNob3dEZWxldGUiPgoqICAgU2hvdyBEZWxldGU/CiogPC9pb24tdG9nZ2xlPgoqIGBgYAoqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25EZWxldGVCdXR0b24nLCBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6IFsnXmlvbkl0ZW0nLCAnXj9pb25MaXN0J10sCiAgICAvL1J1biBiZWZvcmUgYW55dGhpbmcgZWxzZSwgc28gd2UgY2FuIG1vdmUgaXQgYmVmb3JlIG90aGVyIGRpcmVjdGl2ZXMgcHJvY2VzcwogICAgLy9pdHMgbG9jYXRpb24gKGVnIG5nSWYgcmVsaWVzIG9uIHRoZSBsb2NhdGlvbiBvZiB0aGUgZGlyZWN0aXZlIGluIHRoZSBkb20pCiAgICBwcmlvcml0eTogTnVtYmVyLk1BWF9WQUxVRSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cikgewogICAgICAvL0FkZCB0aGUgY2xhc3NlcyB3ZSBuZWVkIGR1cmluZyB0aGUgY29tcGlsZSBwaGFzZSwgc28gdGhhdCB0aGV5IHN0YXkKICAgICAgLy9ldmVuIGlmIHNvbWV0aGluZyBlbHNlIGxpa2UgbmdJZiByZW1vdmVzIHRoZSBlbGVtZW50IGFuZCByZS1hZGRzcyBpdAogICAgICAkYXR0ci4kc2V0KCdjbGFzcycsICgkYXR0clsnY2xhc3MnXSB8fCAnJykgKyAnIGJ1dHRvbiBpY29uIGJ1dHRvbi1pY29uJywgdHJ1ZSk7CiAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybHMpIHsKICAgICAgICB2YXIgaXRlbUN0cmwgPSBjdHJsc1swXTsKICAgICAgICB2YXIgbGlzdEN0cmwgPSBjdHJsc1sxXTsKICAgICAgICB2YXIgY29udGFpbmVyID0ganFMaXRlKElURU1fVFBMX0RFTEVURV9CVVRUT04pOwogICAgICAgIGNvbnRhaW5lci5hcHBlbmQoJGVsZW1lbnQpOwogICAgICAgIGl0ZW1DdHJsLiRlbGVtZW50LmFwcGVuZChjb250YWluZXIpLmFkZENsYXNzKCdpdGVtLWxlZnQtZWRpdGFibGUnKTsKCiAgICAgICAgaWYgKGxpc3RDdHJsICYmIGxpc3RDdHJsLnNob3dEZWxldGUoKSkgewogICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKCd2aXNpYmxlIGFjdGl2ZScpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9Owp9XSk7CgoKSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaXRlbUZsb2F0aW5nTGFiZWwnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdDJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50KSB7CiAgICAgIHZhciBlbCA9IGVsZW1lbnRbMF07CiAgICAgIHZhciBpbnB1dCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0LCB0ZXh0YXJlYScpOwogICAgICB2YXIgaW5wdXRMYWJlbCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJy5pbnB1dC1sYWJlbCcpOwoKICAgICAgaWYgKCAhaW5wdXQgfHwgIWlucHV0TGFiZWwgKSByZXR1cm47CgogICAgICB2YXIgb25JbnB1dCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggaW5wdXQudmFsdWUgKSB7CiAgICAgICAgICBpbnB1dExhYmVsLmNsYXNzTGlzdC5hZGQoJ2hhcy1pbnB1dCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnB1dExhYmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2hhcy1pbnB1dCcpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0Jywgb25JbnB1dCk7CgogICAgICB2YXIgbmdNb2RlbEN0cmwgPSBhbmd1bGFyLmVsZW1lbnQoaW5wdXQpLmNvbnRyb2xsZXIoJ25nTW9kZWwnKTsKICAgICAgaWYgKCBuZ01vZGVsQ3RybCApIHsKICAgICAgICBuZ01vZGVsQ3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dC52YWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUgfHwgJyc7CiAgICAgICAgICBvbklucHV0KCk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgIGlucHV0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2lucHV0Jywgb25JbnB1dCk7CiAgICAgIH0pOwogICAgfQogIH07Cn0pOwoKdmFyIElURU1fVFBMX09QVElPTl9CVVRUT05TID0KICAnPGRpdiBjbGFzcz0iaXRlbS1vcHRpb25zIGludmlzaWJsZSI+JyArCiAgJzwvZGl2Pic7Ci8qKgoqIEBuZ2RvYyBkaXJlY3RpdmUKKiBAbmFtZSBpb25PcHRpb25CdXR0b24KKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25JdGVtCiogQG1vZHVsZSBpb25pYwoqIEByZXN0cmljdCBFCiogQ3JlYXRlcyBhbiBvcHRpb24gYnV0dG9uIGluc2lkZSBhIGxpc3QgaXRlbSwgdGhhdCBpcyB2aXNpYmxlIHdoZW4gdGhlIGl0ZW0gaXMgc3dpcGVkCiogdG8gdGhlIGxlZnQgYnkgdGhlIHVzZXIuICBTd2lwZWQgb3BlbiBvcHRpb24gYnV0dG9ucyBjYW4gYmUgaGlkZGVuIHdpdGgKKiB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNMaXN0RGVsZWdhdGUjY2xvc2VPcHRpb25CdXR0b25zICRpb25pY0xpc3REZWxlZ2F0ZSNjbG9zZU9wdGlvbkJ1dHRvbnN9LgoqCiogQ2FuIGJlIGFzc2lnbmVkIGFueSBidXR0b24gY2xhc3MuCioKKiBTZWUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0fSBmb3IgYSBjb21wbGV0ZSBleGFtcGxlICYgZXhwbGFuYXRpb24uCioKKiBAdXNhZ2UKKgoqIGBgYGh0bWwKKiA8aW9uLWxpc3Q+CiogICA8aW9uLWl0ZW0+CiogICAgIEkgbG92ZSBraXR0ZW5zIQoqICAgICA8aW9uLW9wdGlvbi1idXR0b24gY2xhc3M9ImJ1dHRvbi1wb3NpdGl2ZSI+U2hhcmU8L2lvbi1vcHRpb24tYnV0dG9uPgoqICAgICA8aW9uLW9wdGlvbi1idXR0b24gY2xhc3M9ImJ1dHRvbi1hc3NlcnRpdmUiPkVkaXQ8L2lvbi1vcHRpb24tYnV0dG9uPgoqICAgPC9pb24taXRlbT4KKiA8L2lvbi1saXN0PgoqIGBgYAoqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25PcHRpb25CdXR0b24nLCBbJyRjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICBmdW5jdGlvbiBzdG9wUHJvcGFnYXRpb24oZSkgewogICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICB9CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiAnXmlvbkl0ZW0nLAogICAgcHJpb3JpdHk6IE51bWJlci5NQVhfVkFMVUUsCiAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgJGF0dHIuJHNldCgnY2xhc3MnLCAoJGF0dHJbJ2NsYXNzJ10gfHwgJycpICsgJyBidXR0b24nLCB0cnVlKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBpdGVtQ3RybCkgewogICAgICAgIGlmICghaXRlbUN0cmwub3B0aW9uc0NvbnRhaW5lcikgewogICAgICAgICAgaXRlbUN0cmwub3B0aW9uc0NvbnRhaW5lciA9IGpxTGl0ZShJVEVNX1RQTF9PUFRJT05fQlVUVE9OUyk7CiAgICAgICAgICBpdGVtQ3RybC4kZWxlbWVudC5hcHBlbmQoaXRlbUN0cmwub3B0aW9uc0NvbnRhaW5lcik7CiAgICAgICAgfQogICAgICAgIGl0ZW1DdHJsLm9wdGlvbnNDb250YWluZXIuYXBwZW5kKCRlbGVtZW50KTsKCiAgICAgICAgLy9Eb24ndCBidWJibGUgY2xpY2sgdXAgdG8gbWFpbiAuaXRlbQogICAgICAgICRlbGVtZW50Lm9uKCdjbGljaycsIHN0b3BQcm9wYWdhdGlvbik7CiAgICAgIH07CiAgICB9CiAgfTsKfV0pOwoKdmFyIElURU1fVFBMX1JFT1JERVJfQlVUVE9OID0KICAnPGRpdiBkYXRhLXByZXZlbnQtc2Nyb2xsPSJ0cnVlIiBjbGFzcz0iaXRlbS1yaWdodC1lZGl0IGl0ZW0tcmVvcmRlciBlbmFibGUtcG9pbnRlci1ldmVudHMiPicgKwogICc8L2Rpdj4nOwoKLyoqCiogQG5nZG9jIGRpcmVjdGl2ZQoqIEBuYW1lIGlvblJlb3JkZXJCdXR0b24KKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25JdGVtCiogQG1vZHVsZSBpb25pYwoqIEByZXN0cmljdCBFCiogQ3JlYXRlcyBhIHJlb3JkZXIgYnV0dG9uIGluc2lkZSBhIGxpc3QgaXRlbSwgdGhhdCBpcyB2aXNpYmxlIHdoZW4gdGhlCioge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0IGlvbkxpc3QgcGFyZW50J3N9IGBzaG93LXJlb3JkZXJgIGV2YWx1YXRlcyB0byB0cnVlIG9yCiogYCRpb25pY0xpc3REZWxlZ2F0ZS5zaG93UmVvcmRlcih0cnVlKWAgaXMgY2FsbGVkLgoqCiogQ2FuIGJlIGRyYWdnZWQgdG8gcmVvcmRlciBpdGVtcyBpbiB0aGUgbGlzdC4gVGFrZXMgYW55IGlvbmljb24gY2xhc3MuCioKKiBOb3RlOiBSZW9yZGVyaW5nIHdvcmtzIGJlc3Qgd2hlbiB1c2VkIHdpdGggYG5nLXJlcGVhdGAuICBCZSBzdXJlIHRoYXQgYWxsIGBpb24taXRlbWAgY2hpbGRyZW4gb2YgYW4gYGlvbi1saXN0YCBhcmUgcGFydCBvZiB0aGUgc2FtZSBgbmctcmVwZWF0YCBleHByZXNzaW9uLgoqCiogV2hlbiBhbiBpdGVtIHJlb3JkZXIgaXMgY29tcGxldGUsIHRoZSBleHByZXNzaW9uIGdpdmVuIGluIHRoZSBgb24tcmVvcmRlcmAgYXR0cmlidXRlIGlzIGNhbGxlZC4gVGhlIGBvbi1yZW9yZGVyYCBleHByZXNzaW9uIGlzIGdpdmVuIHR3byBsb2NhbHMgdGhhdCBjYW4gYmUgdXNlZDogYCRmcm9tSW5kZXhgIGFuZCBgJHRvSW5kZXhgLiAgU2VlIGJlbG93IGZvciBhbiBleGFtcGxlLgoqCiogTG9vayBhdCB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3R9IGZvciBtb3JlIGV4YW1wbGVzLgoqCiogQHVzYWdlCioKKiBgYGBodG1sCiogPGlvbi1saXN0IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCIgc2hvdy1yZW9yZGVyPSJ0cnVlIj4KKiAgIDxpb24taXRlbSBuZy1yZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiPgoqICAgICBJdGVtIHt7aXRlbX19CiogICAgIDxpb24tcmVvcmRlci1idXR0b24gY2xhc3M9Imlvbi1uYXZpY29uIgoqICAgICAgICAgICAgICAgICAgICAgICAgIG9uLXJlb3JkZXI9Im1vdmVJdGVtKGl0ZW0sICRmcm9tSW5kZXgsICR0b0luZGV4KSI+CiogICAgIDwvaW9uLXJlb3JkZXItYnV0dG9uPgoqICAgPC9pb24taXRlbT4KKiA8L2lvbi1saXN0PgoqIGBgYAoqIGBgYGpzCiogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSkgewoqICAgJHNjb3BlLml0ZW1zID0gWzEsIDIsIDMsIDRdOwoqICAgJHNjb3BlLm1vdmVJdGVtID0gZnVuY3Rpb24oaXRlbSwgZnJvbUluZGV4LCB0b0luZGV4KSB7CiogICAgIC8vTW92ZSB0aGUgaXRlbSBpbiB0aGUgYXJyYXkKKiAgICAgJHNjb3BlLml0ZW1zLnNwbGljZShmcm9tSW5kZXgsIDEpOwoqICAgICAkc2NvcGUuaXRlbXMuc3BsaWNlKHRvSW5kZXgsIDAsIGl0ZW0pOwoqICAgfTsKKiB9CiogYGBgCioKKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1yZW9yZGVyIEV4cHJlc3Npb24gdG8gY2FsbCB3aGVuIGFuIGl0ZW0gaXMgcmVvcmRlcmVkLgoqIFBhcmFtZXRlcnMgZ2l2ZW46ICRmcm9tSW5kZXgsICR0b0luZGV4LgoqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25SZW9yZGVyQnV0dG9uJywgWyckYW5pbWF0ZScsICckcGFyc2UnLCBmdW5jdGlvbigkYW5pbWF0ZSwgJHBhcnNlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiBbJ15pb25JdGVtJywgJ14/aW9uTGlzdCddLAogICAgcHJpb3JpdHk6IE51bWJlci5NQVhfVkFMVUUsCiAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgJGF0dHIuJHNldCgnY2xhc3MnLCAoJGF0dHJbJ2NsYXNzJ10gfHwgJycpICsgJyBidXR0b24gaWNvbiBidXR0b24taWNvbicsIHRydWUpOwogICAgICAkZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtcHJldmVudC1zY3JvbGwnLCB0cnVlKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJscykgewogICAgICAgIHZhciBpdGVtQ3RybCA9IGN0cmxzWzBdOwogICAgICAgIHZhciBsaXN0Q3RybCA9IGN0cmxzWzFdOwogICAgICAgIHZhciBvblJlb3JkZXJGbiA9ICRwYXJzZSgkYXR0ci5vblJlb3JkZXIpOwoKICAgICAgICAkc2NvcGUuJG9uUmVvcmRlciA9IGZ1bmN0aW9uKG9sZEluZGV4LCBuZXdJbmRleCkgewogICAgICAgICAgb25SZW9yZGVyRm4oJHNjb3BlLCB7CiAgICAgICAgICAgICRmcm9tSW5kZXg6IG9sZEluZGV4LAogICAgICAgICAgICAkdG9JbmRleDogbmV3SW5kZXgKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIC8vIHByZXZlbnQgY2xpY2tzIGZyb20gYnViYmxpbmcgdXAgdG8gdGhlIGl0ZW0KICAgICAgICBpZighJGF0dHIubmdDbGljayAmJiAhJGF0dHIub25DbGljayAmJiAhJGF0dHIub25jbGljayl7CiAgICAgICAgICAkZWxlbWVudFswXS5vbmNsaWNrID0gZnVuY3Rpb24oZSl7ZS5zdG9wUHJvcGFnYXRpb24oKTsgcmV0dXJuIGZhbHNlO307CiAgICAgICAgfQoKICAgICAgICB2YXIgY29udGFpbmVyID0ganFMaXRlKElURU1fVFBMX1JFT1JERVJfQlVUVE9OKTsKICAgICAgICBjb250YWluZXIuYXBwZW5kKCRlbGVtZW50KTsKICAgICAgICBpdGVtQ3RybC4kZWxlbWVudC5hcHBlbmQoY29udGFpbmVyKS5hZGRDbGFzcygnaXRlbS1yaWdodC1lZGl0YWJsZScpOwoKICAgICAgICBpZiAobGlzdEN0cmwgJiYgbGlzdEN0cmwuc2hvd1Jlb3JkZXIoKSkgewogICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKCd2aXNpYmxlIGFjdGl2ZScpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9Owp9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBrZXlib2FyZEF0dGFjaAogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBrZXlib2FyZC1hdHRhY2ggaXMgYW4gYXR0cmlidXRlIGRpcmVjdGl2ZSB3aGljaCB3aWxsIGNhdXNlIGFuIGVsZW1lbnQgdG8gZmxvYXQgYWJvdmUKICogdGhlIGtleWJvYXJkIHdoZW4gdGhlIGtleWJvYXJkIHNob3dzLiBDdXJyZW50bHkgb25seSBzdXBwb3J0cyB0aGUKICogW2lvbi1mb290ZXItYmFyXSh7eyBwYWdlLnZlcnNpb25IcmVmIH19L2FwaS9kaXJlY3RpdmUvaW9uRm9vdGVyQmFyLykgZGlyZWN0aXZlLgogKgogKiAjIyMgTm90ZXMKICogLSBUaGlzIGRpcmVjdGl2ZSByZXF1aXJlcyB0aGUKICogW0lvbmljIEtleWJvYXJkIFBsdWdpbl0oaHR0cHM6Ly9naXRodWIuY29tL2RyaWZ0eWNvL2lvbmljLXBsdWdpbnMta2V5Ym9hcmQpLgogKiAtIE9uIEFuZHJvaWQgbm90IGluIGZ1bGxzY3JlZW4gbW9kZSwgaS5lLiB5b3UgaGF2ZQogKiAgIGA8cHJlZmVyZW5jZSBuYW1lPSJGdWxsc2NyZWVuIiB2YWx1ZT0iZmFsc2UiIC8+YCBvciBubyBwcmVmZXJlbmNlIGluIHlvdXIgYGNvbmZpZy54bWxgIGZpbGUsCiAqICAgdGhpcyBkaXJlY3RpdmUgaXMgdW5uZWNlc3Nhcnkgc2luY2UgaXQgaXMgdGhlIGRlZmF1bHQgYmVoYXZpb3IuCiAqIC0gT24gaU9TLCBpZiB0aGVyZSBpcyBhbiBpbnB1dCBpbiB5b3VyIGZvb3RlciwgeW91IHdpbGwgbmVlZCB0byBzZXQKICogICBgY29yZG92YS5wbHVnaW5zLktleWJvYXJkLmRpc2FibGVTY3JvbGwodHJ1ZSlgLgogKgogKiBAdXNhZ2UKICoKICogYGBgaHRtbAogKiAgPGlvbi1mb290ZXItYmFyIGFsaWduLXRpdGxlPSJsZWZ0IiBrZXlib2FyZC1hdHRhY2ggY2xhc3M9ImJhci1hc3NlcnRpdmUiPgogKiAgICA8aDEgY2xhc3M9InRpdGxlIj5UaXRsZSE8L2gxPgogKiAgPC9pb24tZm9vdGVyLWJhcj4KICogYGBgCiAqLwoKSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgna2V5Ym9hcmRBdHRhY2gnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICBpb25pYy5vbignbmF0aXZlLmtleWJvYXJkc2hvdycsIG9uU2hvdywgd2luZG93KTsKICAgIGlvbmljLm9uKCduYXRpdmUua2V5Ym9hcmRoaWRlJywgb25IaWRlLCB3aW5kb3cpOwoKICAgIC8vZGVwcmVjYXRlZAogICAgaW9uaWMub24oJ25hdGl2ZS5zaG93a2V5Ym9hcmQnLCBvblNob3csIHdpbmRvdyk7CiAgICBpb25pYy5vbignbmF0aXZlLmhpZGVrZXlib2FyZCcsIG9uSGlkZSwgd2luZG93KTsKCgogICAgdmFyIHNjcm9sbEN0cmw7CgogICAgZnVuY3Rpb24gb25TaG93KGUpIHsKICAgICAgaWYgKGlvbmljLlBsYXRmb3JtLmlzQW5kcm9pZCgpICYmICFpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vZm9yIHRlc3RpbmcKICAgICAgdmFyIGtleWJvYXJkSGVpZ2h0ID0gZS5rZXlib2FyZEhlaWdodCB8fCBlLmRldGFpbC5rZXlib2FyZEhlaWdodDsKICAgICAgZWxlbWVudC5jc3MoJ2JvdHRvbScsIGtleWJvYXJkSGVpZ2h0ICsgInB4Iik7CiAgICAgIHNjcm9sbEN0cmwgPSBlbGVtZW50LmNvbnRyb2xsZXIoJyRpb25pY1Njcm9sbCcpOwogICAgICBpZiAoIHNjcm9sbEN0cmwgKSB7CiAgICAgICAgc2Nyb2xsQ3RybC5zY3JvbGxWaWV3Ll9fY29udGFpbmVyLnN0eWxlLmJvdHRvbSA9IGtleWJvYXJkSGVpZ2h0ICsga2V5Ym9hcmRBdHRhY2hHZXRDbGllbnRIZWlnaHQoZWxlbWVudFswXSkgKyAicHgiOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gb25IaWRlKCkgewogICAgICBpZiAoaW9uaWMuUGxhdGZvcm0uaXNBbmRyb2lkKCkgJiYgIWlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZWxlbWVudC5jc3MoJ2JvdHRvbScsICcnKTsKICAgICAgaWYgKCBzY3JvbGxDdHJsICkgewogICAgICAgIHNjcm9sbEN0cmwuc2Nyb2xsVmlldy5fX2NvbnRhaW5lci5zdHlsZS5ib3R0b20gPSAnJzsKICAgICAgfQogICAgfQoKICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgaW9uaWMub2ZmKCduYXRpdmUua2V5Ym9hcmRzaG93Jywgb25TaG93LCB3aW5kb3cpOwogICAgICBpb25pYy5vZmYoJ25hdGl2ZS5rZXlib2FyZGhpZGUnLCBvbkhpZGUsIHdpbmRvdyk7CgogICAgICAvL2RlcHJlY2F0ZWQKICAgICAgaW9uaWMub2ZmKCduYXRpdmUuc2hvd2tleWJvYXJkJywgb25TaG93LCB3aW5kb3cpOwogICAgICBpb25pYy5vZmYoJ25hdGl2ZS5oaWRla2V5Ym9hcmQnLCBvbkhpZGUsIHdpbmRvdyk7CiAgICB9KTsKICB9Owp9KTsKCmZ1bmN0aW9uIGtleWJvYXJkQXR0YWNoR2V0Q2xpZW50SGVpZ2h0KGVsZW1lbnQpIHsKICByZXR1cm4gZWxlbWVudC5jbGllbnRIZWlnaHQ7Cn0KCi8qKgoqIEBuZ2RvYyBkaXJlY3RpdmUKKiBAbmFtZSBpb25MaXN0CiogQG1vZHVsZSBpb25pYwoqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY0xpc3REZWxlZ2F0ZQoqIEBjb2RlcGVuIEpzSGpmCiogQHJlc3RyaWN0IEUKKiBAZGVzY3JpcHRpb24KKiBUaGUgTGlzdCBpcyBhIHdpZGVseSB1c2VkIGludGVyZmFjZSBlbGVtZW50IGluIGFsbW9zdCBhbnkgbW9iaWxlIGFwcCwgYW5kIGNhbiBpbmNsdWRlCiogY29udGVudCByYW5naW5nIGZyb20gYmFzaWMgdGV4dCBhbGwgdGhlIHdheSB0byBidXR0b25zLCB0b2dnbGVzLCBpY29ucywgYW5kIHRodW1ibmFpbHMuCioKKiBCb3RoIHRoZSBsaXN0LCB3aGljaCBjb250YWlucyBpdGVtcywgYW5kIHRoZSBsaXN0IGl0ZW1zIHRoZW1zZWx2ZXMgY2FuIGJlIGFueSBIVE1MCiogZWxlbWVudC4gVGhlIGNvbnRhaW5pbmcgZWxlbWVudCByZXF1aXJlcyB0aGUgYGxpc3RgIGNsYXNzIGFuZCBlYWNoIGxpc3QgaXRlbSByZXF1aXJlcwoqIHRoZSBgaXRlbWAgY2xhc3MuCioKKiBIb3dldmVyLCB1c2luZyB0aGUgaW9uTGlzdCBhbmQgaW9uSXRlbSBkaXJlY3RpdmVzIG1ha2UgaXQgZWFzeSB0byBzdXBwb3J0IHZhcmlvdXMKKiBpbnRlcmFjdGlvbiBtb2RlcyBzdWNoIGFzIHN3aXBlIHRvIGVkaXQsIGRyYWcgdG8gcmVvcmRlciwgYW5kIHJlbW92aW5nIGl0ZW1zLgoqCiogUmVsYXRlZDoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25JdGVtfSwge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25PcHRpb25CdXR0b259Cioge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25SZW9yZGVyQnV0dG9ufSwge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25EZWxldGVCdXR0b259LCBbYGxpc3QgQ1NTIGRvY3VtZW50YXRpb25gXSgvZG9jcy9jb21wb25lbnRzLyNsaXN0KS4KKgoqIEB1c2FnZQoqCiogQmFzaWMgVXNhZ2U6CioKKiBgYGBodG1sCiogPGlvbi1saXN0PgoqICAgPGlvbi1pdGVtIG5nLXJlcGVhdD0iaXRlbSBpbiBpdGVtcyI+CiogICAgIHslIHJhdyAlfUhlbGxvLCB7e2l0ZW19fSF7JSBlbmRyYXcgJX0KKiAgIDwvaW9uLWl0ZW0+CiogPC9pb24tbGlzdD4KKiBgYGAKKgoqIEFkdmFuY2VkIFVzYWdlOiBUaHVtYm5haWxzLCBEZWxldGUgYnV0dG9ucywgUmVvcmRlcmluZywgU3dpcGluZwoqCiogYGBgaHRtbAoqIDxpb24tbGlzdCBuZy1jb250cm9sbGVyPSJNeUN0cmwiCiogICAgICAgICAgIHNob3ctZGVsZXRlPSJzaG91bGRTaG93RGVsZXRlIgoqICAgICAgICAgICBzaG93LXJlb3JkZXI9InNob3VsZFNob3dSZW9yZGVyIgoqICAgICAgICAgICBjYW4tc3dpcGU9Imxpc3RDYW5Td2lwZSI+CiogICA8aW9uLWl0ZW0gbmctcmVwZWF0PSJpdGVtIGluIGl0ZW1zIgoqICAgICAgICAgICAgIGNsYXNzPSJpdGVtLXRodW1ibmFpbC1sZWZ0Ij4KKgoqICAgICB7JSByYXcgJX08aW1nIG5nLXNyYz0ie3tpdGVtLmltZ319Ij4KKiAgICAgPGgyPnt7aXRlbS50aXRsZX19PC9oMj4KKiAgICAgPHA+e3tpdGVtLmRlc2NyaXB0aW9ufX08L3A+eyUgZW5kcmF3ICV9CiogICAgIDxpb24tb3B0aW9uLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLXBvc2l0aXZlIgoqICAgICAgICAgICAgICAgICAgICAgICAgbmctY2xpY2s9InNoYXJlKGl0ZW0pIj4KKiAgICAgICBTaGFyZQoqICAgICA8L2lvbi1vcHRpb24tYnV0dG9uPgoqICAgICA8aW9uLW9wdGlvbi1idXR0b24gY2xhc3M9ImJ1dHRvbi1pbmZvIgoqICAgICAgICAgICAgICAgICAgICAgICAgbmctY2xpY2s9ImVkaXQoaXRlbSkiPgoqICAgICAgIEVkaXQKKiAgICAgPC9pb24tb3B0aW9uLWJ1dHRvbj4KKiAgICAgPGlvbi1kZWxldGUtYnV0dG9uIGNsYXNzPSJpb24tbWludXMtY2lyY2xlZCIKKiAgICAgICAgICAgICAgICAgICAgICAgIG5nLWNsaWNrPSJpdGVtcy5zcGxpY2UoJGluZGV4LCAxKSI+CiogICAgIDwvaW9uLWRlbGV0ZS1idXR0b24+CiogICAgIDxpb24tcmVvcmRlci1idXR0b24gY2xhc3M9Imlvbi1uYXZpY29uIgoqICAgICAgICAgICAgICAgICAgICAgICAgIG9uLXJlb3JkZXI9InJlb3JkZXJJdGVtKGl0ZW0sICRmcm9tSW5kZXgsICR0b0luZGV4KSI+CiogICAgIDwvaW9uLXJlb3JkZXItYnV0dG9uPgoqCiogICA8L2lvbi1pdGVtPgoqIDwvaW9uLWxpc3Q+CiogYGBgCioKKiBAcGFyYW0ge3N0cmluZz19IGRlbGVnYXRlLWhhbmRsZSBUaGUgaGFuZGxlIHVzZWQgdG8gaWRlbnRpZnkgdGhpcyBsaXN0IHdpdGgKKiB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNMaXN0RGVsZWdhdGV9LgoqIEBwYXJhbSB0eXBlIHtzdHJpbmc9fSBUaGUgdHlwZSBvZiBsaXN0IHRvIHVzZSAoZm9yIGV4YW1wbGUsIGxpc3QtaW5zZXQgZm9yIGFuIGluc2V0IGxpc3QpCiogQHBhcmFtIHNob3ctZGVsZXRlIHtib29sZWFuPX0gV2hldGhlciB0aGUgZGVsZXRlIGJ1dHRvbnMgZm9yIHRoZSBpdGVtcyBpbiB0aGUgbGlzdCBhcmUKKiBjdXJyZW50bHkgc2hvd24gb3IgaGlkZGVuLgoqIEBwYXJhbSBzaG93LXJlb3JkZXIge2Jvb2xlYW49fSBXaGV0aGVyIHRoZSByZW9yZGVyIGJ1dHRvbnMgZm9yIHRoZSBpdGVtcyBpbiB0aGUgbGlzdCBhcmUKKiBjdXJyZW50bHkgc2hvd24gb3IgaGlkZGVuLgoqIEBwYXJhbSBjYW4tc3dpcGUge2Jvb2xlYW49fSBXaGV0aGVyIHRoZSBpdGVtcyBpbiB0aGUgbGlzdCBhcmUgYWxsb3dlZCB0byBiZSBzd2lwZWQgdG8gcmV2ZWFsCiogb3B0aW9uIGJ1dHRvbnMuIERlZmF1bHQ6IHRydWUuCiovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbkxpc3QnLCBbCiAgJyRhbmltYXRlJywKICAnJHRpbWVvdXQnLApmdW5jdGlvbigkYW5pbWF0ZSwgJHRpbWVvdXQpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6IFsnaW9uTGlzdCcsICdePyRpb25pY1Njcm9sbCddLAogICAgY29udHJvbGxlcjogJyRpb25pY0xpc3QnLAogICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgIHZhciBsaXN0RWwgPSBqcUxpdGUoJzxkaXYgY2xhc3M9Imxpc3QiPicpCiAgICAgIC5hcHBlbmQoICRlbGVtZW50LmNvbnRlbnRzKCkgKQogICAgICAuYWRkQ2xhc3MoJGF0dHIudHlwZSk7CiAgICAgICRlbGVtZW50LmFwcGVuZChsaXN0RWwpOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgY3RybHMpIHsKICAgICAgICB2YXIgbGlzdEN0cmwgPSBjdHJsc1swXTsKICAgICAgICB2YXIgc2Nyb2xsQ3RybCA9IGN0cmxzWzFdOwoKICAgICAgICAvL1dhaXQgZm9yIGNoaWxkIGVsZW1lbnRzIHRvIHJlbmRlci4uLgogICAgICAgICR0aW1lb3V0KGluaXQpOwoKICAgICAgICBmdW5jdGlvbiBpbml0KCkgewogICAgICAgICAgdmFyIGxpc3RWaWV3ID0gbGlzdEN0cmwubGlzdFZpZXcgPSBuZXcgaW9uaWMudmlld3MuTGlzdFZpZXcoewogICAgICAgICAgICBlbDogJGVsZW1lbnRbMF0sCiAgICAgICAgICAgIGxpc3RFbDogJGVsZW1lbnQuY2hpbGRyZW4oKVswXSwKICAgICAgICAgICAgc2Nyb2xsRWw6IHNjcm9sbEN0cmwgJiYgc2Nyb2xsQ3RybC5lbGVtZW50LAogICAgICAgICAgICBzY3JvbGxWaWV3OiBzY3JvbGxDdHJsICYmIHNjcm9sbEN0cmwuc2Nyb2xsVmlldywKICAgICAgICAgICAgb25SZW9yZGVyOiBmdW5jdGlvbihlbCwgb2xkSW5kZXgsIG5ld0luZGV4KSB7CiAgICAgICAgICAgICAgdmFyIGl0ZW1TY29wZSA9IGpxTGl0ZShlbCkuc2NvcGUoKTsKICAgICAgICAgICAgICBpZiAoaXRlbVNjb3BlICYmIGl0ZW1TY29wZS4kb25SZW9yZGVyKSB7CiAgICAgICAgICAgICAgICAvL01ha2Ugc3VyZSBvblJlb3JkZXIgaXMgY2FsbGVkIGluIGFwcGx5IGN5Y2xlLAogICAgICAgICAgICAgICAgLy9idXQgYWxzbyBtYWtlIHN1cmUgaXQgaGFzIG5vIGNvbmZsaWN0cyBieSBkb2luZwogICAgICAgICAgICAgICAgLy8kZXZhbEFzeW5jCiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaXRlbVNjb3BlLiRvblJlb3JkZXIob2xkSW5kZXgsIG5ld0luZGV4KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FuU3dpcGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBsaXN0Q3RybC5jYW5Td2lwZUl0ZW1zKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmIChpc0RlZmluZWQoJGF0dHIuY2FuU3dpcGUpKSB7CiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJyEhKCcgKyAkYXR0ci5jYW5Td2lwZSArICcpJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBsaXN0Q3RybC5jYW5Td2lwZUl0ZW1zKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNEZWZpbmVkKCRhdHRyLnNob3dEZWxldGUpKSB7CiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJyEhKCcgKyAkYXR0ci5zaG93RGVsZXRlICsgJyknLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGxpc3RDdHJsLnNob3dEZWxldGUodmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0RlZmluZWQoJGF0dHIuc2hvd1Jlb3JkZXIpKSB7CiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJyEhKCcgKyAkYXR0ci5zaG93UmVvcmRlciArICcpJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBsaXN0Q3RybC5zaG93UmVvcmRlcih2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsaXN0Q3RybC5zaG93RGVsZXRlKCk7CiAgICAgICAgICB9LCBmdW5jdGlvbihpc1Nob3duLCB3YXNTaG93bikgewogICAgICAgICAgICAvL09ubHkgdXNlIGlzU2hvd249ZmFsc2UgaWYgaXQgd2FzIGFscmVhZHkgc2hvd24KICAgICAgICAgICAgaWYgKCFpc1Nob3duICYmICF3YXNTaG93bikgeyByZXR1cm47IH0KCiAgICAgICAgICAgIGlmIChpc1Nob3duKSBsaXN0Q3RybC5jbG9zZU9wdGlvbkJ1dHRvbnMoKTsKICAgICAgICAgICAgbGlzdEN0cmwuY2FuU3dpcGVJdGVtcyghaXNTaG93bik7CgogICAgICAgICAgICAkZWxlbWVudC5jaGlsZHJlbigpLnRvZ2dsZUNsYXNzKCdsaXN0LWxlZnQtZWRpdGluZycsIGlzU2hvd24pOwogICAgICAgICAgICAkZWxlbWVudC50b2dnbGVDbGFzcygnZGlzYWJsZS1wb2ludGVyLWV2ZW50cycsIGlzU2hvd24pOwoKICAgICAgICAgICAgdmFyIGRlbGV0ZUJ1dHRvbiA9IGpxTGl0ZSgkZWxlbWVudFswXS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdpdGVtLWRlbGV0ZScpKTsKICAgICAgICAgICAgc2V0QnV0dG9uU2hvd24oZGVsZXRlQnV0dG9uLCBsaXN0Q3RybC5zaG93RGVsZXRlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsaXN0Q3RybC5zaG93UmVvcmRlcigpOwogICAgICAgICAgfSwgZnVuY3Rpb24oaXNTaG93biwgd2FzU2hvd24pIHsKICAgICAgICAgICAgLy9Pbmx5IHVzZSBpc1Nob3duPWZhbHNlIGlmIGl0IHdhcyBhbHJlYWR5IHNob3duCiAgICAgICAgICAgIGlmICghaXNTaG93biAmJiAhd2FzU2hvd24pIHsgcmV0dXJuOyB9CgogICAgICAgICAgICBpZiAoaXNTaG93bikgbGlzdEN0cmwuY2xvc2VPcHRpb25CdXR0b25zKCk7CiAgICAgICAgICAgIGxpc3RDdHJsLmNhblN3aXBlSXRlbXMoIWlzU2hvd24pOwoKICAgICAgICAgICAgJGVsZW1lbnQuY2hpbGRyZW4oKS50b2dnbGVDbGFzcygnbGlzdC1yaWdodC1lZGl0aW5nJywgaXNTaG93bik7CiAgICAgICAgICAgICRlbGVtZW50LnRvZ2dsZUNsYXNzKCdkaXNhYmxlLXBvaW50ZXItZXZlbnRzJywgaXNTaG93bik7CgogICAgICAgICAgICB2YXIgcmVvcmRlckJ1dHRvbiA9IGpxTGl0ZSgkZWxlbWVudFswXS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdpdGVtLXJlb3JkZXInKSk7CiAgICAgICAgICAgIHNldEJ1dHRvblNob3duKHJlb3JkZXJCdXR0b24sIGxpc3RDdHJsLnNob3dSZW9yZGVyKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGZ1bmN0aW9uIHNldEJ1dHRvblNob3duKGVsLCBzaG93bikgewogICAgICAgICAgICBzaG93bigpICYmIGVsLmFkZENsYXNzKCd2aXNpYmxlJykgfHwgZWwucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2hvd24oKSAmJiBlbC5hZGRDbGFzcygnYWN0aXZlJykgfHwgZWwucmVtb3ZlQ2xhc3MoJ2ludmlzaWJsZScpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICB9OwogICAgfQogIH07Cn1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG1lbnVDbG9zZQogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogQ2xvc2VzIGEgc2lkZSBtZW51IHdoaWNoIGlzIGN1cnJlbnRseSBvcGVuZWQuCiAqCiAqIEB1c2FnZQogKiBCZWxvdyBpcyBhbiBleGFtcGxlIG9mIGEgbGluayB3aXRoaW4gYSBzaWRlIG1lbnUuIFRhcHBpbmcgdGhpcyBsaW5rIHdvdWxkCiAqIGF1dG9tYXRpY2FsbHkgY2xvc2UgdGhlIGN1cnJlbnRseSBvcGVuZWQgbWVudS4KICoKICogYGBgaHRtbAogKiA8YSBtZW51LWNsb3NlIGhyZWY9IiMvaG9tZSIgY2xhc3M9Iml0ZW0iPkhvbWU8L2E+CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnbWVudUNsb3NlJywgWyckaW9uaWNWaWV3U2VydmljZScsIGZ1bmN0aW9uKCRpb25pY1ZpZXdTZXJ2aWNlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQUMnLAogICAgcmVxdWlyZTogJ15pb25TaWRlTWVudXMnLAogICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNpZGVNZW51Q3RybCkgewogICAgICAkZWxlbWVudC5iaW5kKCdjbGljaycsIGZ1bmN0aW9uKCl7CiAgICAgICAgc2lkZU1lbnVDdHJsLmNsb3NlKCk7CiAgICAgIH0pOwogICAgfQogIH07Cn1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG1lbnVUb2dnbGUKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRvZ2dsZSBhIHNpZGUgbWVudSBvbiB0aGUgZ2l2ZW4gc2lkZQogKgogKiBAdXNhZ2UKICogQmVsb3cgaXMgYW4gZXhhbXBsZSBvZiBhIGxpbmsgd2l0aGluIGEgbmF2IGJhci4gVGFwcGluZyB0aGlzIGxpbmsgd291bGQKICogYXV0b21hdGljYWxseSBvcGVuIHRoZSBnaXZlbiBzaWRlIG1lbnUKICoKICogYGBgaHRtbAogKiA8aW9uLXZpZXc+CiAqICAgPGlvbi1uYXYtYnV0dG9ucyBzaWRlPSJsZWZ0Ij4KICogICAgPGJ1dHRvbiBtZW51LXRvZ2dsZT0ibGVmdCIgY2xhc3M9ImJ1dHRvbiBidXR0b24taWNvbiBpY29uIGlvbi1uYXZpY29uIj48L2J1dHRvbj4KICogICA8L2lvbi1uYXYtYnV0dG9ucz4KICogIC4uLgogKiA8L2lvbi12aWV3PgogKiBgYGAKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ21lbnVUb2dnbGUnLCBbJyRpb25pY1ZpZXdTZXJ2aWNlJywgZnVuY3Rpb24oJGlvbmljVmlld1NlcnZpY2UpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBQycsCiAgICByZXF1aXJlOiAnXmlvblNpZGVNZW51cycsCiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2lkZU1lbnVDdHJsKSB7CiAgICAgIHZhciBzaWRlID0gJGF0dHIubWVudVRvZ2dsZSB8fCAnbGVmdCc7CiAgICAgICRlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oKXsKICAgICAgICBpZihzaWRlID09PSAnbGVmdCcpIHsKICAgICAgICAgIHNpZGVNZW51Q3RybC50b2dnbGVMZWZ0KCk7CiAgICAgICAgfSBlbHNlIGlmKHNpZGUgPT09ICdyaWdodCcpIHsKICAgICAgICAgIHNpZGVNZW51Q3RybC50b2dnbGVSaWdodCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKfV0pOwoKCi8qCiAqIFdlIGRvbid0IGRvY3VtZW50IHRoZSBpb25Nb2RhbCBkaXJlY3RpdmUsIHdlIGluc3RlYWQgZG9jdW1lbnQKICogdGhlICRpb25pY01vZGFsIHNlcnZpY2UKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbk1vZGFsJywgW2Z1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgIHJlcGxhY2U6IHRydWUsCiAgICBjb250cm9sbGVyOiBbZnVuY3Rpb24oKXt9XSwKICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0ibW9kYWwtYmFja2Ryb3AiPicgKwogICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im1vZGFsLXdyYXBwZXIiIG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICAgICAgICAgICAnPC9kaXY+JwogIH07Cn1dKTsKCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbk1vZGFsVmlldycsIGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICBlbGVtZW50LmFkZENsYXNzKCdtb2RhbCcpOwogICAgfQogIH07Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uTmF2QmFja0J1dHRvbgogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBFCiAqIEBwYXJlbnQgaW9uTmF2QmFyCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGEgYmFjayBidXR0b24gaW5zaWRlIGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfS4KICoKICogV2lsbCBzaG93IHVwIHdoZW4gdGhlIHVzZXIgaXMgYWJsZSB0byBnbyBiYWNrIGluIHRoZSBjdXJyZW50IG5hdmlnYXRpb24gc3RhY2suCiAqCiAqIEJ5IGRlZmF1bHQsIHdpbGwgZ28gYmFjayB3aGVuIGNsaWNrZWQuICBJZiB5b3Ugd2lzaCBmb3IgbW9yZSBhZHZhbmNlZCBiZWhhdmlvciwgc2VlIHRoZQogKiBleGFtcGxlcyBiZWxvdy4KICoKICogQHVzYWdlCiAqCiAqIFdpdGggZGVmYXVsdCBjbGljayBhY3Rpb246CiAqCiAqIGBgYGh0bWwKICogPGlvbi1uYXYtYmFyPgogKiAgIDxpb24tbmF2LWJhY2stYnV0dG9uIGNsYXNzPSJidXR0b24tY2xlYXIiPgogKiAgICAgPGkgY2xhc3M9Imlvbi1hcnJvdy1sZWZ0LWMiPjwvaT4gQmFjawogKiAgIDwvaW9uLW5hdi1iYWNrLWJ1dHRvbj4KICogPC9pb24tbmF2LWJhcj4KICogYGBgCiAqCiAqIFdpdGggY3VzdG9tIGNsaWNrIGFjdGlvbiwgdXNpbmcge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTmF2QmFyRGVsZWdhdGV9OgogKgogKiBgYGBodG1sCiAqIDxpb24tbmF2LWJhciBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogKiAgIDxpb24tbmF2LWJhY2stYnV0dG9uIGNsYXNzPSJidXR0b24tY2xlYXIiCiAqICAgICBuZy1jbGljaz0iZ29CYWNrKCkiPgogKiAgICAgPGkgY2xhc3M9Imlvbi1hcnJvdy1sZWZ0LWMiPjwvaT4gQmFjawogKiAgIDwvaW9uLW5hdi1iYWNrLWJ1dHRvbj4KICogPC9pb24tbmF2LWJhcj4KICogYGBgCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIE15Q3RybCgkc2NvcGUsICRpb25pY05hdkJhckRlbGVnYXRlKSB7CiAqICAgJHNjb3BlLmdvQmFjayA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljTmF2QmFyRGVsZWdhdGUuYmFjaygpOwogKiAgIH07CiAqIH0KICogYGBgCiAqCiAqIERpc3BsYXlpbmcgdGhlIHByZXZpb3VzIHRpdGxlIG9uIHRoZSBiYWNrIGJ1dHRvbiwgYWdhaW4gdXNpbmcKICoge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTmF2QmFyRGVsZWdhdGV9LgogKgogKiBgYGBodG1sCiAqIDxpb24tbmF2LWJhciBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogKiAgIDxpb24tbmF2LWJhY2stYnV0dG9uIGNsYXNzPSJidXR0b24taWNvbiI+CiAqICAgICA8aSBjbGFzcz0iaWNvbiBpb24tYXJyb3ctbGVmdC1jIj48L2k+eyUgcmF3ICV9e3tnZXRQcmV2aW91c1RpdGxlKCkgfHwgJ0JhY2snfX17JSBlbmRyYXcgJX0KICogICA8L2lvbi1uYXYtYmFjay1idXR0b24+CiAqIDwvaW9uLW5hdi1iYXI+CiAqIGBgYAogKiBgYGBqcwogKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlLCAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSkgewogKiAgICRzY29wZS5nZXRQcmV2aW91c1RpdGxlID0gZnVuY3Rpb24oKSB7CiAqICAgICByZXR1cm4gJGlvbmljTmF2QmFyRGVsZWdhdGUuZ2V0UHJldmlvdXNUaXRsZSgpOwogKiAgIH07CiAqIH0KICogYGBgCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25OYXZCYWNrQnV0dG9uJywgWwogICckYW5pbWF0ZScsCiAgJyRyb290U2NvcGUnLAogICckc2FuaXRpemUnLAogICckaW9uaWNOYXZCYXJDb25maWcnLAogICckaW9uaWNOZ0NsaWNrJywKZnVuY3Rpb24oJGFuaW1hdGUsICRyb290U2NvcGUsICRzYW5pdGl6ZSwgJGlvbmljTmF2QmFyQ29uZmlnLCAkaW9uaWNOZ0NsaWNrKSB7CiAgdmFyIGJhY2tJc1Nob3duID0gZmFsc2U7CiAgLy9JZiB0aGUgY3VycmVudCB2aWV3c3RhdGUgZG9lcyBub3QgYWxsb3cgYSBiYWNrIGJ1dHRvbiwKICAvL2Fsd2F5cyBoaWRlIGl0LgogICRyb290U2NvcGUuJG9uKCckdmlld0hpc3RvcnkuaGlzdG9yeUNoYW5nZScsIGZ1bmN0aW9uKGUsIGRhdGEpIHsKICAgIGJhY2tJc1Nob3duID0gISFkYXRhLnNob3dCYWNrOwogIH0pOwogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVxdWlyZTogJ15pb25OYXZCYXInLAogICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICB0RWxlbWVudC5hZGRDbGFzcygnYnV0dG9uIGJhY2stYnV0dG9uIG5nLWhpZGUnKTsKCiAgICAgIHZhciBoYXNJY29uQ2hpbGQgPSAhISh0RWxlbWVudC5odG1sKCkgfHwgJycpLm1hdGNoKC9jbGFzcz0uKj9pb24tLyk7CgogICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIG5hdkJhckN0cmwpIHsKCiAgICAgICAgLy8gQWRkIGEgZGVmYXVsdCBiYWNrIGJ1dHRvbiBpY29uIGJhc2VkIG9uIHRoZSBuYXYgY29uZmlnLCB1bmxlc3Mgb25lIGlzIHNldAogICAgICAgIGlmICghaGFzSWNvbkNoaWxkICYmICRlbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCdpb24tJykgPT09IC0xKSB7CiAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygkaW9uaWNOYXZCYXJDb25maWcuYmFja0J1dHRvbkljb24pOwogICAgICAgIH0KCiAgICAgICAgLy9EZWZhdWx0IHRvIG5nQ2xpY2sgZ29pbmcgYmFjaywgYnV0IGRvbid0IG92ZXJyaWRlIGEgY3VzdG9tIG9uZQogICAgICAgIGlmICghaXNEZWZpbmVkKCRhdHRyLm5nQ2xpY2spKSB7CiAgICAgICAgICAkaW9uaWNOZ0NsaWNrKCRzY29wZSwgJGVsZW1lbnQsIG5hdkJhckN0cmwuYmFjayk7CiAgICAgICAgfQoKICAgICAgICAvL01ha2Ugc3VyZSBib3RoIHRoYXQgYSBiYWNrQnV0dG9uIGlzIGFsbG93ZWQgaW4gdGhlIGZpcnN0IHBsYWNlLAogICAgICAgIC8vYW5kIHRoYXQgaXQgaXMgc2hvd24gYnkgdGhlIGN1cnJlbnQgdmlldy4KICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoaXNEZWZpbmVkKCRhdHRyLmZyb21UaXRsZSkpIHsKICAgICAgICAgICAgJGVsZW1lbnRbMF0uaW5uZXJIVE1MID0gJzxzcGFuIGNsYXNzPSJiYWNrLWJ1dHRvbi10aXRsZSI+JyArICRzYW5pdGl6ZSgkc2NvcGUub2xkVGl0bGUpICsgJzwvc3Bhbj4nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICEhKGJhY2tJc1Nob3duICYmICRzY29wZS5iYWNrQnV0dG9uU2hvd24pOwogICAgICAgIH0sIGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oc2hvdykgewogICAgICAgICAgaWYgKHNob3cpICRhbmltYXRlLnJlbW92ZUNsYXNzKCRlbGVtZW50LCAnbmctaGlkZScpOwogICAgICAgICAgZWxzZSAkYW5pbWF0ZS5hZGRDbGFzcygkZWxlbWVudCwgJ25nLWhpZGUnKTsKICAgICAgICB9KSk7CiAgICAgIH07CiAgICB9CiAgfTsKfV0pOwoKCklvbmljTW9kdWxlLmNvbnN0YW50KCckaW9uaWNOYXZCYXJDb25maWcnLCB7CiAgdHJhbnNpdGlvbjogJ25hdi10aXRsZS1zbGlkZS1pb3M3JywKICBhbGlnblRpdGxlOiAnY2VudGVyJywKICBiYWNrQnV0dG9uSWNvbjogJ2lvbi1pb3M3LWFycm93LWJhY2snCn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uTmF2QmFyCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljTmF2QmFyRGVsZWdhdGUKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIElmIHdlIGhhdmUgYW4ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZWaWV3fSBkaXJlY3RpdmUsIHdlIGNhbiBhbHNvIGNyZWF0ZSBhbgogKiBgPGlvbi1uYXYtYmFyPmAsIHdoaWNoIHdpbGwgY3JlYXRlIGEgdG9wYmFyIHRoYXQgdXBkYXRlcyBhcyB0aGUgYXBwbGljYXRpb24gc3RhdGUgY2hhbmdlcy4KICoKICogV2UgY2FuIGFkZCBhIGJhY2sgYnV0dG9uIGJ5IHB1dHRpbmcgYW4ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYWNrQnV0dG9ufSBpbnNpZGUuCiAqCiAqIFdlIGNhbiBhZGQgYnV0dG9ucyBkZXBlbmRpbmcgb24gdGhlIGN1cnJlbnRseSB2aXNpYmxlIHZpZXcgdXNpbmcKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCdXR0b25zfS4KICoKICogQWRkIGFuIFthbmltYXRpb24gY2xhc3NdKC9kb2NzL2NvbXBvbmVudHMjYW5pbWF0aW9ucykgdG8gdGhlIGVsZW1lbnQgdmlhIHRoZQogKiBgYW5pbWF0aW9uYCBhdHRyaWJ1dGUgdG8gZW5hYmxlIGFuaW1hdGVkIGNoYW5naW5nIG9mIHRpdGxlcyAKICogKHJlY29tbWVuZGVkOiAnbmF2LXRpdGxlLXNsaWRlLWlvczcnKS4KICoKICogTm90ZSB0aGF0IHRoZSBpb24tbmF2LWJhciBlbGVtZW50IHdpbGwgb25seSB3b3JrIGNvcnJlY3RseSBpZiB5b3VyIGNvbnRlbnQgaGFzIGFuCiAqIGlvblZpZXcgYXJvdW5kIGl0LgogKgogKiBAdXNhZ2UKICoKICogYGBgaHRtbAogKiA8Ym9keSBuZy1hcHA9InN0YXJ0ZXIiPgogKiAgIDwhLS0gVGhlIG5hdiBiYXIgdGhhdCB3aWxsIGJlIHVwZGF0ZWQgYXMgd2UgbmF2aWdhdGUgLS0+CiAqICAgPGlvbi1uYXYtYmFyIGNsYXNzPSJiYXItcG9zaXRpdmUiIGFuaW1hdGlvbj0ibmF2LXRpdGxlLXNsaWRlLWlvczciPgogKiAgIDwvaW9uLW5hdi1iYXI+CiAqCiAqICAgPCEtLSB3aGVyZSB0aGUgaW5pdGlhbCB2aWV3IHRlbXBsYXRlIHdpbGwgYmUgcmVuZGVyZWQgLS0+CiAqICAgPGlvbi1uYXYtdmlldz4KICogICAgIDxpb24tdmlldz4KICogICAgICAgPGlvbi1jb250ZW50PkhlbGxvITwvaW9uLWNvbnRlbnQ+CiAqICAgICA8L2lvbi12aWV3PgogKiAgIDwvaW9uLW5hdi12aWV3PgogKiA8L2JvZHk+CiAqIGBgYAogKgogKiBAcGFyYW0ge3N0cmluZz19IGRlbGVnYXRlLWhhbmRsZSBUaGUgaGFuZGxlIHVzZWQgdG8gaWRlbnRpZnkgdGhpcyBuYXZCYXIKICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNOYXZCYXJEZWxlZ2F0ZX0uCiAqIEBwYXJhbSBhbGlnbi10aXRsZSB7c3RyaW5nPX0gV2hlcmUgdG8gYWxpZ24gdGhlIHRpdGxlIG9mIHRoZSBuYXZiYXIuCiAqIEF2YWlsYWJsZTogJ2xlZnQnLCAncmlnaHQnLCAnY2VudGVyJy4gRGVmYXVsdHMgdG8gJ2NlbnRlcicuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IG5vLXRhcC1zY3JvbGwgQnkgZGVmYXVsdCwgdGhlIG5hdmJhciB3aWxsIHNjcm9sbCB0aGUgY29udGVudAogKiB0byB0aGUgdG9wIHdoZW4gdGFwcGVkLiAgU2V0IG5vLXRhcC1zY3JvbGwgdG8gdHJ1ZSB0byBkaXNhYmxlIHRoaXMgYmVoYXZpb3IuCiAqCiAqIDwvdGFibGU+PGJyLz4KICoKICogIyMjIEFsdGVybmF0aXZlIFVzYWdlCiAqCiAqIEFsdGVybmF0aXZlbHksIHlvdSBtYXkgcHV0IGlvbi1uYXYtYmFyIGluc2lkZSBvZiBlYWNoIGluZGl2aWR1YWwgdmlldydzIGlvbi12aWV3IGVsZW1lbnQuCiAqIFRoaXMgd2lsbCBhbGxvdyB5b3UgdG8gaGF2ZSB0aGUgd2hvbGUgbmF2YmFyLCBub3QganVzdCBpdHMgY29udGVudHMsIHRyYW5zaXRpb24gZXZlcnkgdmlldyBjaGFuZ2UuCiAqCiAqIFRoaXMgaXMgc2ltaWxhciB0byB1c2luZyBhIGhlYWRlciBiYXIgaW5zaWRlIHlvdXIgaW9uLXZpZXcsIGV4Y2VwdCBpdCB3aWxsIGhhdmUgYWxsIHRoZSBwb3dlciBvZiBhIG5hdmJhci4KICoKICogSWYgeW91IGRvIHRoaXMsIHNpbXBseSBwdXQgbmF2IGJ1dHRvbnMgaW5zaWRlIHRoZSBuYXZiYXIgaXRzZWxmOyBkbyBub3QgdXNlIGA8aW9uLW5hdi1idXR0b25zPmAuCiAqCiAqCiAqIGBgYGh0bWwKICogPGlvbi12aWV3IHRpdGxlPSJteVRpdGxlIj4KICogICA8aW9uLW5hdi1iYXIgY2xhc3M9ImJhci1wb3NpdGl2ZSI+CiAqICAgICA8aW9uLW5hdi1iYWNrLWJ1dHRvbj4KICogICAgICAgQmFjawogKiAgICAgPC9pb24tbmF2LWJhY2stYnV0dG9uPgogKiAgICAgPGRpdiBjbGFzcz0iYnV0dG9ucyByaWdodC1idXR0b25zIj4KICogICAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIj4KICogICAgICAgICBSaWdodCBCdXR0b24KICogICAgICAgPC9idXR0b24+CiAqICAgICA8L2Rpdj4KICogICA8L2lvbi1uYXYtYmFyPgogKiA8L2lvbi12aWV3PgogKiBgYGAKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbk5hdkJhcicsIFsKICAnJGlvbmljVmlld1NlcnZpY2UnLAogICckcm9vdFNjb3BlJywKICAnJGFuaW1hdGUnLAogICckY29tcGlsZScsCiAgJyRpb25pY05hdkJhckNvbmZpZycsCmZ1bmN0aW9uKCRpb25pY1ZpZXdTZXJ2aWNlLCAkcm9vdFNjb3BlLCAkYW5pbWF0ZSwgJGNvbXBpbGUsICRpb25pY05hdkJhckNvbmZpZykgewoKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIGNvbnRyb2xsZXI6ICckaW9uaWNOYXZCYXInLAogICAgc2NvcGU6IHRydWUsCiAgICBjb21waWxlOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgIC8vV2UgY2Fubm90IHRyYW5zY2x1ZGUgaGVyZSBiZWNhdXNlIGl0IGJyZWFrcyBlbGVtZW50LmRhdGEoKSBpbmhlcml0YW5jZSBvbiBjb21waWxlCiAgICAgIHRFbGVtZW50CiAgICAgICAgLmFkZENsYXNzKCdiYXIgYmFyLWhlYWRlciBuYXYtYmFyJykKICAgICAgICAuYXBwZW5kKAogICAgICAgICAgJzxkaXYgY2xhc3M9ImJ1dHRvbnMgbGVmdC1idXR0b25zIj4gJyArCiAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAnPGgxIG5nLWJpbmQtaHRtbD0idGl0bGUiIGNsYXNzPSJ0aXRsZSI+PC9oMT4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJidXR0b25zIHJpZ2h0LWJ1dHRvbnMiPiAnICsKICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgKTsKCiAgICAgIGlmIChpc0RlZmluZWQodEF0dHJzLmFuaW1hdGlvbikpIHsKICAgICAgICB0RWxlbWVudC5hZGRDbGFzcyh0QXR0cnMuYW5pbWF0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0RWxlbWVudC5hZGRDbGFzcygkaW9uaWNOYXZCYXJDb25maWcudHJhbnNpdGlvbik7CiAgICAgIH0KCiAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBuYXZCYXJDdHJsKSB7CiAgICAgICAgbmF2QmFyQ3RybC5faGVhZGVyQmFyVmlldyA9IG5ldyBpb25pYy52aWV3cy5IZWFkZXJCYXIoewogICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgYWxpZ25UaXRsZTogJGF0dHIuYWxpZ25UaXRsZSB8fCAkaW9uaWNOYXZCYXJDb25maWcuYWxpZ25UaXRsZSB8fCAnY2VudGVyJwogICAgICAgIH0pOwoKICAgICAgICAvL2RlZmF1bHRzCiAgICAgICAgJHNjb3BlLmJhY2tCdXR0b25TaG93biA9IGZhbHNlOwogICAgICAgICRzY29wZS5zaG91bGRBbmltYXRlID0gdHJ1ZTsKICAgICAgICAkc2NvcGUuaXNSZXZlcnNlID0gZmFsc2U7CiAgICAgICAgJHNjb3BlLmlzSW52aXNpYmxlID0gdHJ1ZTsKCiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICRzY29wZS4kcGFyZW50LiRoYXNIZWFkZXIgPSBmYWxzZTsKICAgICAgICB9KTsKCiAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAoJHNjb3BlLmlzUmV2ZXJzZSA/ICcgcmV2ZXJzZScgOiAnJykgKwogICAgICAgICAgICAoJHNjb3BlLmlzSW52aXNpYmxlID8gJyBpbnZpc2libGUnIDogJycpICsKICAgICAgICAgICAgKCEkc2NvcGUuc2hvdWxkQW5pbWF0ZSA/ICcgbm8tYW5pbWF0aW9uJyA6ICcnKTsKICAgICAgICB9LCBmdW5jdGlvbihjbGFzc05hbWUsIG9sZENsYXNzTmFtZSkgewogICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3Mob2xkQ2xhc3NOYW1lKTsKICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvbk5hdkJ1dHRvbnMKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAcGFyZW50IGlvbk5hdlZpZXcKICoKICogQGRlc2NyaXB0aW9uCiAqIFVzZSBpb25OYXZCdXR0b25zIHRvIHNldCB0aGUgYnV0dG9ucyBvbiB5b3VyIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfQogKiBmcm9tIHdpdGhpbiBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblZpZXd9LgogKgogKiBBbnkgYnV0dG9ucyB5b3UgZGVjbGFyZSB3aWxsIGJlIHBsYWNlZCBvbnRvIHRoZSBuYXZiYXIncyBjb3JyZXNwb25kaW5nIHNpZGUsCiAqIGFuZCB0aGVuIGRlc3Ryb3llZCB3aGVuIHRoZSB1c2VyIGxlYXZlcyB0aGVpciBwYXJlbnQgdmlldy4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi1uYXYtYmFyPgogKiA8L2lvbi1uYXYtYmFyPgogKiA8aW9uLW5hdi12aWV3PgogKiAgIDxpb24tdmlldz4KICogICAgIDxpb24tbmF2LWJ1dHRvbnMgc2lkZT0ibGVmdCI+CiAqICAgICAgIDxidXR0b24gY2xhc3M9ImJ1dHRvbiIgbmctY2xpY2s9ImRvU29tZXRoaW5nKCkiPgogKiAgICAgICAgIEknbSBhIGJ1dHRvbiBvbiB0aGUgbGVmdCBvZiB0aGUgbmF2YmFyIQogKiAgICAgICA8L2J1dHRvbj4KICogICAgIDwvaW9uLW5hdi1idXR0b25zPgogKiAgICAgPGlvbi1jb250ZW50PgogKiAgICAgICBTb21lIHN1cGVyIGNvbnRlbnQgaGVyZSEKICogICAgIDwvaW9uLWNvbnRlbnQ+CiAqICAgPC9pb24tdmlldz4KICogPC9pb24tbmF2LXZpZXc+CiAqIGBgYAogKgogKiBAcGFyYW0ge3N0cmluZ30gc2lkZSBUaGUgc2lkZSB0byBwbGFjZSB0aGUgYnV0dG9ucyBvbiBpbiB0aGUgcGFyZW50CiAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfS4gQXZhaWxhYmxlOiAnbGVmdCcgb3IgJ3JpZ2h0Jy4KICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbk5hdkJ1dHRvbnMnLCBbJyRjb21waWxlJywgJyRhbmltYXRlJywgZnVuY3Rpb24oJGNvbXBpbGUsICRhbmltYXRlKSB7CiAgcmV0dXJuIHsKICAgIHJlcXVpcmU6ICdeaW9uTmF2QmFyJywKICAgIHJlc3RyaWN0OiAnRScsCiAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgIHZhciBjb250ZW50ID0gJGVsZW1lbnQuY29udGVudHMoKS5yZW1vdmUoKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgbmF2QmFyQ3RybCkgewogICAgICAgIHZhciBuYXZFbGVtZW50ID0gJGF0dHJzLnNpZGUgPT09ICdyaWdodCcgPwogICAgICAgICAgbmF2QmFyQ3RybC5yaWdodEJ1dHRvbnNFbGVtZW50IDoKICAgICAgICAgIG5hdkJhckN0cmwubGVmdEJ1dHRvbnNFbGVtZW50OwoKICAgICAgICAvL1B1dCBhbGwgb2Ygb3VyIGluc2lkZSBidXR0b25zIGludG8gdGhlaXIgb3duIHNwYW4sCiAgICAgICAgLy9zbyB3ZSBjYW4gcmVtb3ZlIHRoZW0gYWxsIHdoZW4gdGhpcyBlbGVtZW50IGRpZXMgLQogICAgICAgIC8vZXZlbiBpZiB0aGUgYnV0dG9ucyBoYXZlIGNoYW5nZWQgdGhyb3VnaCBhbiBuZy1yZXBlYXQgb3IgdGhlIGxpa2UsCiAgICAgICAgLy93ZSBqdXN0IHJlbW92ZSB0aGVpciBkaXYgcGFyZW50IGFuZCB0aGV5IGFyZSBnb25lLgogICAgICAgIHZhciBidXR0b25zID0ganFMaXRlKCc8c3Bhbj4nKS5hcHBlbmQoY29udGVudCk7CgogICAgICAgIC8vQ29tcGlsZSBidXR0b25zIGluc2lkZSBjb250ZW50IHNvIHRoZXkgaGF2ZSBhY2Nlc3MgdG8gZXZlcnl0aGluZwogICAgICAgIC8vc29tZXRoaW5nIGluc2lkZSBjb250ZW50IGRvZXMgKGVnIHBhcmVudCBpb25pY1Njcm9sbCkKICAgICAgICAkZWxlbWVudC5hcHBlbmQoYnV0dG9ucyk7CiAgICAgICAgJGNvbXBpbGUoYnV0dG9ucykoJHNjb3BlKTsKCiAgICAgICAgLy9BcHBlbmQgYnV0dG9ucyB0byBuYXZiYXIKICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAvL0lmIHRoZSBzY29wZSBpcyBkZXN0cm95ZWQgYmVmb3JlIHJhZiBydW5zLCBiZSBzdXJlIG5vdCB0byBlbnRlcgogICAgICAgICAgaWYgKCEkc2NvcGUuJCRkZXN0cm95ZWQpIHsKICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoYnV0dG9ucywgbmF2RWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vV2hlbiBvdXIgaW9uLW5hdi1idXR0b25zIGNvbnRhaW5lciBpcyBkZXN0cm95ZWQsCiAgICAgICAgLy9kZXN0cm95IGV2ZXJ5dGhpbmcgaW4gdGhlIG5hdmJhcgogICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShidXR0b25zKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gVGhlIG9yaWdpbmFsIGVsZW1lbnQgaXMganVzdCBhIGNvbXBsZXRlbHkgZW1wdHkgPGlvbi1uYXYtYnV0dG9ucz4gZWxlbWVudC4KICAgICAgICAvLyBtYWtlIGl0IGludmlzaWJsZSBqdXN0IHRvIGJlIHN1cmUgaXQgZG9lc24ndCBjaGFuZ2UgYW55IGxheW91dAogICAgICAgICRlbGVtZW50LmNzcygnZGlzcGxheScsICdub25lJyk7CiAgICAgIH07CiAgICB9CiAgfTsKfV0pOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5hdkNsZWFyCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBuYXYtY2xlYXIgaXMgYW4gYXR0cmlidXRlIGRpcmVjdGl2ZSB3aGljaCBzaG91bGQgYmUgdXNlZCB3aXRoIGFuIGVsZW1lbnQgdGhhdCBjaGFuZ2VzCiAqIHRoZSB2aWV3IG9uIGNsaWNrLCBmb3IgZXhhbXBsZSBhbiBgPGEgaHJlZj5gIG9yIGEgYDxidXR0b24gdWktc3JlZj5gLgogKgogKiBuYXYtY2xlYXIgd2lsbCBjYXVzZSB0aGUgZ2l2ZW4gZWxlbWVudCwgd2hlbiBjbGlja2VkLCB0byBkaXNhYmxlIHRoZSBuZXh0IHZpZXcgdHJhbnNpdGlvbi4KICogVGhpcyBkaXJlY3RpdmUgaXMgdXNlZnVsLCBmb3IgZXhhbXBsZSwgZm9yIGxpbmtzIHdpdGhpbiBhIHNpZGVNZW51LgogKgogKiBAdXNhZ2UKICogQmVsb3cgaXMgYSBsaW5rIGluIGEgc2lkZSBtZW51LCB3aXRoIHRoZSBuYXYtY2xlYXIgZGlyZWN0aXZlIGFkZGVkIHRvIGl0LgogKiBUYXBwaW5nIHRoaXMgbGluayB3aWxsIGRpc2FibGUgYW55IGFuaW1hdGlvbnMgdGhhdCB3b3VsZCBub3JtYWxseSBvY2N1cgogKiBiZXR3ZWVuIHZpZXdzLgogKgogKiBgYGBodG1sCiAqIDxhIG5hdi1jbGVhciBtZW51LWNsb3NlIGhyZWY9IiMvaG9tZSIgY2xhc3M9Iml0ZW0iPkhvbWU8L2E+CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnbmF2Q2xlYXInLCBbCiAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAnJHN0YXRlJywKICAnJGxvY2F0aW9uJywKICAnJHdpbmRvdycsCiAgJyRyb290U2NvcGUnLApmdW5jdGlvbigkaW9uaWNWaWV3U2VydmljZSwgJGxvY2F0aW9uLCAkc3RhdGUsICR3aW5kb3csICRyb290U2NvcGUpIHsKICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlRXJyb3InLCBmdW5jdGlvbigpIHsKICAgICRpb25pY1ZpZXdTZXJ2aWNlLm5leHRWaWV3T3B0aW9ucyhudWxsKTsKICB9KTsKICByZXR1cm4gewogICAgcHJpb3JpdHk6IDEwMCwKICAgIHJlc3RyaWN0OiAnQUMnLAogICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQpIHsKICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgICAgdmFyIHVucmVnaXN0ZXJMaXN0ZW5lcjsKICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Gb3JTdGF0ZUNoYW5nZSgpIHsKICAgICAgICAgIHVucmVnaXN0ZXJMaXN0ZW5lciA9ICRzY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN0YXJ0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRpb25pY1ZpZXdTZXJ2aWNlLm5leHRWaWV3T3B0aW9ucyh7CiAgICAgICAgICAgICAgZGlzYWJsZUFuaW1hdGU6IHRydWUsCiAgICAgICAgICAgICAgZGlzYWJsZUJhY2s6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHVucmVnaXN0ZXJMaXN0ZW5lcigpOwogICAgICAgICAgfSk7CiAgICAgICAgICAkd2luZG93LnNldFRpbWVvdXQodW5yZWdpc3Rlckxpc3RlbmVyLCAzMDApOwogICAgICAgIH0KCiAgICAgICAgJGVsZW1lbnQub24oJ2NsaWNrJywgbGlzdGVuRm9yU3RhdGVDaGFuZ2UpOwogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKSW9uaWNNb2R1bGUuY29uc3RhbnQoJyRpb25pY05hdlZpZXdDb25maWcnLCB7CiAgdHJhbnNpdGlvbjogJ3NsaWRlLWxlZnQtcmlnaHQtaW9zNycKfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25OYXZWaWV3CiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICogQGNvZGVwZW4gb2RxQ3oKICoKICogQGRlc2NyaXB0aW9uCiAqIEFzIGEgdXNlciBuYXZpZ2F0ZXMgdGhyb3VnaG91dCB5b3VyIGFwcCwgSW9uaWMgaXMgYWJsZSB0byBrZWVwIHRyYWNrIG9mIHRoZWlyCiAqIG5hdmlnYXRpb24gaGlzdG9yeS4gQnkga25vd2luZyB0aGVpciBoaXN0b3J5LCB0cmFuc2l0aW9ucyBiZXR3ZWVuIHZpZXdzCiAqIGNvcnJlY3RseSBzbGlkZSBlaXRoZXIgbGVmdCBvciByaWdodCwgb3Igbm8gdHJhbnNpdGlvbiBhdCBhbGwuIEFuIGFkZGl0aW9uYWwKICogYmVuZWZpdCB0byBJb25pYydzIG5hdmlnYXRpb24gc3lzdGVtIGlzIGl0cyBhYmlsaXR5IHRvIG1hbmFnZSBtdWx0aXBsZQogKiBoaXN0b3JpZXMuCiAqCiAqIElvbmljIHVzZXMgdGhlIEFuZ3VsYXJVSSBSb3V0ZXIgbW9kdWxlIHNvIGFwcCBpbnRlcmZhY2VzIGNhbiBiZSBvcmdhbml6ZWQKICogaW50byB2YXJpb3VzICJzdGF0ZXMiLiBMaWtlIEFuZ3VsYXIncyBjb3JlICRyb3V0ZSBzZXJ2aWNlLCBVUkxzIGNhbiBiZSB1c2VkCiAqIHRvIGNvbnRyb2wgdGhlIHZpZXdzLiBIb3dldmVyLCB0aGUgQW5ndWxhclVJIFJvdXRlciBwcm92aWRlcyBhIG1vcmUgcG93ZXJmdWwKICogc3RhdGUgbWFuYWdlciBpbiB0aGF0IHN0YXRlcyBhcmUgYm91bmQgdG8gbmFtZWQsIG5lc3RlZCwgYW5kIHBhcmFsbGVsIHZpZXdzLAogKiBhbGxvd2luZyBtb3JlIHRoYW4gb25lIHRlbXBsYXRlIHRvIGJlIHJlbmRlcmVkIG9uIHRoZSBzYW1lIHBhZ2UuCiAqIEFkZGl0aW9uYWxseSwgZWFjaCBzdGF0ZSBpcyBub3QgcmVxdWlyZWQgdG8gYmUgYm91bmQgdG8gYSBVUkwsIGFuZCBkYXRhIGNhbgogKiBiZSBwdXNoZWQgdG8gZWFjaCBzdGF0ZSB3aGljaCBhbGxvd3MgbXVjaCBmbGV4aWJpbGl0eS4KICoKICogVGhlIGlvbk5hdlZpZXcgZGlyZWN0aXZlIGlzIHVzZWQgdG8gcmVuZGVyIHRlbXBsYXRlcyBpbiB5b3VyIGFwcGxpY2F0aW9uLiBFYWNoIHRlbXBsYXRlCiAqIGlzIHBhcnQgb2YgYSBzdGF0ZS4gU3RhdGVzIGFyZSB1c3VhbGx5IG1hcHBlZCB0byBhIHVybCwgYW5kIGFyZSBkZWZpbmVkIHByb2dyYW1hdGljYWxseQogKiB1c2luZyBhbmd1bGFyLXVpLXJvdXRlciAoc2VlIFt0aGVpciBkb2NzXShodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci11aS91aS1yb3V0ZXIvd2lraSksCiAqIGFuZCByZW1lbWJlciB0byByZXBsYWNlIHVpLXZpZXcgd2l0aCBpb24tbmF2LXZpZXcgaW4gZXhhbXBsZXMpLgogKgogKiBAdXNhZ2UKICogSW4gdGhpcyBleGFtcGxlLCB3ZSB3aWxsIGNyZWF0ZSBhIG5hdmlnYXRpb24gdmlldyB0aGF0IGNvbnRhaW5zIG91ciBkaWZmZXJlbnQgc3RhdGVzIGZvciB0aGUgYXBwLgogKgogKiBUbyBkbyB0aGlzLCBpbiBvdXIgbWFya3VwIHdlIHVzZSBpb25OYXZWaWV3IHRvcCBsZXZlbCBkaXJlY3RpdmUuIFRvIGRpc3BsYXkgYSBoZWFkZXIgYmFyIHdlIHVzZQogKiB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9IGRpcmVjdGl2ZSB0aGF0IHVwZGF0ZXMgYXMgd2UgbmF2aWdhdGUgdGhyb3VnaCB0aGUKICogbmF2aWdhdGlvbiBzdGFjay4KICoKICogWW91IGNhbiB1c2UgYW55IFthbmltYXRpb24gY2xhc3NdKC9kb2NzL2NvbXBvbmVudHMjYW5pbWF0aW9ucykgb24gdGhlIG5hdlZpZXcncyBgYW5pbWF0aW9uYCBhdHRyaWJ1dGUKICogdG8gaGF2ZSBpdHMgcGFnZXMgYW5pbWF0ZS4KICoKICogUmVjb21tZW5kZWQgZm9yIHBhZ2UgdHJhbnNpdGlvbnM6ICdzbGlkZS1sZWZ0LXJpZ2h0JywgJ3NsaWRlLWxlZnQtcmlnaHQtaW9zNycsICdzbGlkZS1pbi11cCcuCiAqCiAqIGBgYGh0bWwKICogPGlvbi1uYXYtYmFyPjwvaW9uLW5hdi1iYXI+CiAqIDxpb24tbmF2LXZpZXcgYW5pbWF0aW9uPSJzbGlkZS1sZWZ0LXJpZ2h0Ij4KICogICA8IS0tIENlbnRlciBjb250ZW50IC0tPgogKiA8L2lvbi1uYXYtdmlldz4KICogYGBgCiAqCiAqIE5leHQsIHdlIG5lZWQgdG8gc2V0dXAgb3VyIHN0YXRlcyB0aGF0IHdpbGwgYmUgcmVuZGVyZWQuCiAqCiAqIGBgYGpzCiAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbJ2lvbmljJ10pOwogKiBhcHAuY29uZmlnKGZ1bmN0aW9uKCRzdGF0ZVByb3ZpZGVyKSB7CiAqICAgJHN0YXRlUHJvdmlkZXIKICogICAuc3RhdGUoJ2luZGV4JywgewogKiAgICAgdXJsOiAnLycsCiAqICAgICB0ZW1wbGF0ZVVybDogJ2hvbWUuaHRtbCcKICogICB9KQogKiAgIC5zdGF0ZSgnbXVzaWMnLCB7CiAqICAgICB1cmw6ICcvbXVzaWMnLAogKiAgICAgdGVtcGxhdGVVcmw6ICdtdXNpYy5odG1sJwogKiAgIH0pOwogKiB9KTsKICogYGBgCiAqIFRoZW4gb24gYXBwIHN0YXJ0LCAkc3RhdGVQcm92aWRlciB3aWxsIGxvb2sgYXQgdGhlIHVybCwgc2VlIGl0IG1hdGNoZXMgdGhlIGluZGV4IHN0YXRlLAogKiBhbmQgdGhlbiB0cnkgdG8gbG9hZCBob21lLmh0bWwgaW50byB0aGUgYDxpb24tbmF2LXZpZXc+YC4KICoKICogUGFnZXMgYXJlIGxvYWRlZCBieSB0aGUgVVJMcyBnaXZlbi4gT25lIHNpbXBsZSB3YXkgdG8gY3JlYXRlIHRlbXBsYXRlcyBpbiBBbmd1bGFyIGlzIHRvIHB1dAogKiB0aGVtIGRpcmVjdGx5IGludG8geW91ciBIVE1MIGZpbGUgYW5kIHVzZSB0aGUgYDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSI+YCBzeW50YXguCiAqIFNvIGhlcmUgaXMgb25lIHdheSB0byBwdXQgaG9tZS5odG1sIGludG8gb3VyIGFwcDoKICoKICogYGBgaHRtbAogKiA8c2NyaXB0IGlkPSJob21lIiB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIj4KICogICA8IS0tIFRoZSB0aXRsZSBvZiB0aGUgaW9uLXZpZXcgd2lsbCBiZSBzaG93biBvbiB0aGUgbmF2YmFyIC0tPgogKiAgIDxpb24tdmlldyB0aXRsZT0iJ0hvbWUnIj4KICogICAgIDxpb24tY29udGVudCBuZy1jb250cm9sbGVyPSJIb21lQ3RybCI+CiAqICAgICAgIDwhLS0gVGhlIGNvbnRlbnQgb2YgdGhlIHBhZ2UgLS0+CiAqICAgICAgIDxhIGhyZWY9IiMvbXVzaWMiPkdvIHRvIG11c2ljIHBhZ2UhPC9hPgogKiAgICAgPC9pb24tY29udGVudD4KICogICA8L2lvbi12aWV3PgogKiA8L3NjcmlwdD4KICogYGBgCiAqCiAqIFRoaXMgaXMgZ29vZCB0byBkbyBiZWNhdXNlIHRoZSB0ZW1wbGF0ZSB3aWxsIGJlIGNhY2hlZCBmb3IgdmVyeSBmYXN0IGxvYWRpbmcsIGluc3RlYWQgb2YKICogaGF2aW5nIHRvIGZldGNoIHRoZW0gZnJvbSB0aGUgbmV0d29yay4KICoKICogUGxlYXNlIHZpc2l0IFtBbmd1bGFyVUkgUm91dGVyJ3MgZG9jc10oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItdWkvdWktcm91dGVyL3dpa2kpIGZvcgogKiBtb3JlIGluZm8uIEJlbG93IGlzIGEgZ3JlYXQgdmlkZW8gYnkgdGhlIEFuZ3VsYXJVSSBSb3V0ZXIgZ3V5cyB0aGF0IG1heSBoZWxwIHRvIGV4cGxhaW4KICogaG93IGl0IGFsbCB3b3JrczoKICoKICogPGlmcmFtZSB3aWR0aD0iNTYwIiBoZWlnaHQ9IjMxNSIgc3JjPSIvL3d3dy55b3V0dWJlLmNvbS9lbWJlZC9kcUpSb2g4TW5CbyIKICogZnJhbWVib3JkZXI9IjAiIGFsbG93ZnVsbHNjcmVlbj48L2lmcmFtZT4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIEEgdmlldyBuYW1lLiBUaGUgbmFtZSBzaG91bGQgYmUgdW5pcXVlIGFtb25nc3QgdGhlIG90aGVyIHZpZXdzIGluIHRoZQogKiBzYW1lIHN0YXRlLiBZb3UgY2FuIGhhdmUgdmlld3Mgb2YgdGhlIHNhbWUgbmFtZSB0aGF0IGxpdmUgaW4gZGlmZmVyZW50IHN0YXRlcy4gRm9yIG1vcmUKICogaW5mb3JtYXRpb24sIHNlZSB1aS1yb3V0ZXIncyBbdWktdmlldyBkb2N1bWVudGF0aW9uXShodHRwOi8vYW5ndWxhci11aS5naXRodWIuaW8vdWktcm91dGVyL3NpdGUvIy9hcGkvdWkucm91dGVyLnN0YXRlLmRpcmVjdGl2ZTp1aS12aWV3KS4KICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbk5hdlZpZXcnLCBbCiAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAnJHN0YXRlJywKICAnJGNvbXBpbGUnLAogICckY29udHJvbGxlcicsCiAgJyRhbmltYXRlJywKZnVuY3Rpb24oICRpb25pY1ZpZXdTZXJ2aWNlLCAgICRzdGF0ZSwgICAkY29tcGlsZSwgICAkY29udHJvbGxlciwgICAkYW5pbWF0ZSkgewogIC8vIElPTklDJ3MgZm9yayBvZiBBbmd1bGFyIFVJIFJvdXRlciwgdjAuMi43CiAgLy8gdGhlIG5hdlZpZXcgaGFuZGxlcyByZWdpc3RlcmluZyB2aWV3cyBpbiB0aGUgaGlzdG9yeSwgd2hpY2ggYW5pbWF0aW9uIHRvIHVzZSwgYW5kIHdoaWNoCiAgdmFyIHZpZXdJc1VwZGF0aW5nID0gZmFsc2U7CgogIHZhciBkaXJlY3RpdmUgPSB7CiAgICByZXN0cmljdDogJ0UnLAogICAgdGVybWluYWw6IHRydWUsCiAgICBwcmlvcml0eTogMjAwMCwKICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICBjb250cm9sbGVyOiBmdW5jdGlvbigpe30sCiAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0ciwgdHJhbnNjbHVkZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIG5hdlZpZXdDdHJsKSB7CiAgICAgICAgdmFyIHZpZXdTY29wZSwgdmlld0xvY2FscywKICAgICAgICAgIG5hbWUgPSBhdHRyW2RpcmVjdGl2ZS5uYW1lXSB8fCBhdHRyLm5hbWUgfHwgJycsCiAgICAgICAgICBvbmxvYWRFeHAgPSBhdHRyLm9ubG9hZCB8fCAnJywKICAgICAgICAgIGluaXRpYWxWaWV3ID0gdHJhbnNjbHVkZShzY29wZSk7CgogICAgICAgIC8vIFB1dCBiYWNrIHRoZSBjb21waWxlZCBpbml0aWFsIHZpZXcKICAgICAgICBlbGVtZW50LmFwcGVuZChpbml0aWFsVmlldyk7CgogICAgICAgIC8vIEZpbmQgdGhlIGRldGFpbHMgb2YgdGhlIHBhcmVudCB2aWV3IGRpcmVjdGl2ZSAoaWYgYW55KSBhbmQgdXNlIGl0CiAgICAgICAgLy8gdG8gZGVyaXZlIG91ciBvd24gcXVhbGlmaWVkIHZpZXcgbmFtZSwgdGhlbiBoYW5nIG91ciBvd24gZGV0YWlscwogICAgICAgIC8vIG9mZiB0aGUgRE9NIHNvIGNoaWxkIGRpcmVjdGl2ZXMgY2FuIGZpbmQgaXQuCiAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50KCkuaW5oZXJpdGVkRGF0YSgnJHVpVmlldycpOwogICAgICAgIGlmIChuYW1lLmluZGV4T2YoJ0AnKSA8IDApIG5hbWUgID0gbmFtZSArICdAJyArICgocGFyZW50ICYmIHBhcmVudC5zdGF0ZSkgPyBwYXJlbnQuc3RhdGUubmFtZSA6ICcnKTsKICAgICAgICB2YXIgdmlldyA9IHsgbmFtZTogbmFtZSwgc3RhdGU6IG51bGwgfTsKICAgICAgICBlbGVtZW50LmRhdGEoJyR1aVZpZXcnLCB2aWV3KTsKCiAgICAgICAgdmFyIGV2ZW50SG9vayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHZpZXdJc1VwZGF0aW5nKSByZXR1cm47CiAgICAgICAgICB2aWV3SXNVcGRhdGluZyA9IHRydWU7CgogICAgICAgICAgdHJ5IHsgdXBkYXRlVmlldyh0cnVlKTsgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB2aWV3SXNVcGRhdGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfQogICAgICAgICAgdmlld0lzVXBkYXRpbmcgPSBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICBzY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBldmVudEhvb2spOwogICAgICAgIC8vIHNjb3BlLiRvbignJHZpZXdDb250ZW50TG9hZGluZycsIGV2ZW50SG9vayk7CiAgICAgICAgdXBkYXRlVmlldyhmYWxzZSk7CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZpZXcoZG9BbmltYXRlKSB7CiAgICAgICAgICAvLz09PWZhbHNlIGJlY2F1c2UgJGFuaW1hdGUuZW5hYmxlZCgpIGlzIGEgbm9vcCB3aXRob3V0IGFuZ3VsYXItYW5pbWF0ZSBpbmNsdWRlZAogICAgICAgICAgaWYgKCRhbmltYXRlLmVuYWJsZWQoKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgZG9BbmltYXRlID0gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGxvY2FscyA9ICRzdGF0ZS4kY3VycmVudCAmJiAkc3RhdGUuJGN1cnJlbnQubG9jYWxzW25hbWVdOwogICAgICAgICAgaWYgKGxvY2FscyA9PT0gdmlld0xvY2FscykgcmV0dXJuOyAvLyBub3RoaW5nIHRvIGRvCiAgICAgICAgICB2YXIgcmVuZGVyZXIgPSAkaW9uaWNWaWV3U2VydmljZS5nZXRSZW5kZXJlcihlbGVtZW50LCBhdHRyLCBzY29wZSk7CgogICAgICAgICAgLy8gRGVzdHJveSBwcmV2aW91cyB2aWV3IHNjb3BlCiAgICAgICAgICBpZiAodmlld1Njb3BlKSB7CiAgICAgICAgICAgIHZpZXdTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICB2aWV3U2NvcGUgPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghbG9jYWxzKSB7CiAgICAgICAgICAgIHZpZXdMb2NhbHMgPSBudWxsOwogICAgICAgICAgICB2aWV3LnN0YXRlID0gbnVsbDsKCiAgICAgICAgICAgIC8vIFJlc3RvcmUgdGhlIGluaXRpYWwgdmlldwogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5hcHBlbmQoaW5pdGlhbFZpZXcpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0ganFMaXRlKCc8ZGl2PjwvZGl2PicpLmh0bWwobG9jYWxzLiR0ZW1wbGF0ZSkuY29udGVudHMoKTsKICAgICAgICAgIHZhciB2aWV3UmVnaXN0ZXJEYXRhID0gcmVuZGVyZXIoKS5yZWdpc3RlcihuZXdFbGVtZW50KTsKCiAgICAgICAgICAvLyBSZW1vdmUgZXhpc3RpbmcgY29udGVudAogICAgICAgICAgcmVuZGVyZXIoZG9BbmltYXRlKS5sZWF2ZSgpOwoKICAgICAgICAgIHZpZXdMb2NhbHMgPSBsb2NhbHM7CiAgICAgICAgICB2aWV3LnN0YXRlID0gbG9jYWxzLiQkc3RhdGU7CgogICAgICAgICAgcmVuZGVyZXIoZG9BbmltYXRlKS5lbnRlcihuZXdFbGVtZW50KTsKCiAgICAgICAgICB2YXIgbGluayA9ICRjb21waWxlKG5ld0VsZW1lbnQpOwogICAgICAgICAgdmlld1Njb3BlID0gc2NvcGUuJG5ldygpOwoKICAgICAgICAgIHZpZXdTY29wZS4kbmF2RGlyZWN0aW9uID0gdmlld1JlZ2lzdGVyRGF0YS5uYXZEaXJlY3Rpb247CgogICAgICAgICAgaWYgKGxvY2Fscy4kJGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgbG9jYWxzLiRzY29wZSA9IHZpZXdTY29wZTsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSAkY29udHJvbGxlcihsb2NhbHMuJCRjb250cm9sbGVyLCBsb2NhbHMpOwogICAgICAgICAgICBlbGVtZW50LmNoaWxkcmVuKCkuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGxpbmsodmlld1Njb3BlKTsKCiAgICAgICAgICB2YXIgdmlld0hpc3RvcnlEYXRhID0gJGlvbmljVmlld1NlcnZpY2UuX2dldFZpZXdCeUlkKHZpZXdSZWdpc3RlckRhdGEudmlld0lkKSB8fCB7fTsKICAgICAgICAgIHZpZXdTY29wZS4kYnJvYWRjYXN0KCckdmlld0NvbnRlbnRMb2FkZWQnLCB2aWV3SGlzdG9yeURhdGEpOwoKICAgICAgICAgIGlmIChvbmxvYWRFeHApIHZpZXdTY29wZS4kZXZhbChvbmxvYWRFeHApOwoKICAgICAgICAgIG5ld0VsZW1lbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9OwogIHJldHVybiBkaXJlY3RpdmU7Cn1dKTsKCgpJb25pY01vZHVsZQoKLmNvbmZpZyhbJyRwcm92aWRlJywgZnVuY3Rpb24oJHByb3ZpZGUpIHsKICAkcHJvdmlkZS5kZWNvcmF0b3IoJ25nQ2xpY2tEaXJlY3RpdmUnLCBbJyRkZWxlZ2F0ZScsIGZ1bmN0aW9uKCRkZWxlZ2F0ZSkgewogICAgLy8gZHJvcCB0aGUgZGVmYXVsdCBuZ0NsaWNrIGRpcmVjdGl2ZQogICAgJGRlbGVnYXRlLnNoaWZ0KCk7CiAgICByZXR1cm4gJGRlbGVnYXRlOwogIH1dKTsKfV0pCgovKioKICogQHByaXZhdGUKICovCi5mYWN0b3J5KCckaW9uaWNOZ0NsaWNrJywgWyckcGFyc2UnLCBmdW5jdGlvbigkcGFyc2UpIHsKICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGNsaWNrRXhwcikgewogICAgdmFyIGNsaWNrSGFuZGxlciA9IGFuZ3VsYXIuaXNGdW5jdGlvbihjbGlja0V4cHIpID8KICAgICAgY2xpY2tFeHByIDoKICAgICAgJHBhcnNlKGNsaWNrRXhwcik7CgogICAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCkgewogICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgY2xpY2tIYW5kbGVyKHNjb3BlLCB7JGV2ZW50OiAoZXZlbnQpfSk7CiAgICAgIH0pOwogICAgfSk7CgogICAgLy8gSGFjayBmb3IgaU9TIFNhZmFyaSdzIGJlbmVmaXQuIEl0IGdvZXMgc2VhcmNoaW5nIGZvciBvbmNsaWNrIGhhbmRsZXJzIGFuZCBpcyBsaWFibGUgdG8gY2xpY2sKICAgIC8vIHNvbWV0aGluZyBlbHNlIG5lYXJieS4KICAgIGVsZW1lbnQub25jbGljayA9IGZ1bmN0aW9uKGV2ZW50KSB7IH07CiAgfTsKfV0pCgouZGlyZWN0aXZlKCduZ0NsaWNrJywgWyckaW9uaWNOZ0NsaWNrJywgZnVuY3Rpb24oJGlvbmljTmdDbGljaykgewogIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgJGlvbmljTmdDbGljayhzY29wZSwgZWxlbWVudCwgYXR0ci5uZ0NsaWNrKTsKICB9Owp9XSkKCi5kaXJlY3RpdmUoJ2lvblN0b3BFdmVudCcsIGZ1bmN0aW9uICgpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICBlbGVtZW50LmJpbmQoYXR0ci5pb25TdG9wRXZlbnQsIGV2ZW50U3RvcFByb3BhZ2F0aW9uKTsKICAgIH0KICB9Owp9KTsKZnVuY3Rpb24gZXZlbnRTdG9wUHJvcGFnYXRpb24oZSkgewogIGUuc3RvcFByb3BhZ2F0aW9uKCk7Cn0KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25QYW5lCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uIEEgc2ltcGxlIGNvbnRhaW5lciB0aGF0IGZpdHMgY29udGVudCwgd2l0aCBubyBzaWRlIGVmZmVjdHMuICBBZGRzIHRoZSAncGFuZScgY2xhc3MgdG8gdGhlIGVsZW1lbnQuCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25QYW5lJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICBlbGVtZW50LmFkZENsYXNzKCdwYW5lJyk7CiAgICB9CiAgfTsKfSk7CgovKgogKiBXZSBkb24ndCBkb2N1bWVudCB0aGUgaW9uUG9wb3ZlciBkaXJlY3RpdmUsIHdlIGluc3RlYWQgZG9jdW1lbnQKICogdGhlICRpb25pY1BvcG92ZXIgc2VydmljZQogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uUG9wb3ZlcicsIFtmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICByZXBsYWNlOiB0cnVlLAogICAgY29udHJvbGxlcjogW2Z1bmN0aW9uKCl7fV0sCiAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9InBvcG92ZXItYmFja2Ryb3AiPicgKwogICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9InBvcG92ZXItd3JhcHBlciIgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAgICAgICAgICAnPC9kaXY+JwogIH07Cn1dKTsKCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblBvcG92ZXJWaWV3JywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIGVsZW1lbnQuYXBwZW5kKCBhbmd1bGFyLmVsZW1lbnQoJzxkaXYgY2xhc3M9InBvcG92ZXItYXJyb3ciPjwvZGl2PicpICk7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3BvcG92ZXInKTsKICAgIH0KICB9Owp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblJhZGlvCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICogQGNvZGVwZW4gc2FvQkcKICogQGRlc2NyaXB0aW9uCiAqIFRoZSByYWRpbyBkaXJlY3RpdmUgaXMgbm8gZGlmZmVyZW50IHRoYW4gdGhlIEhUTUwgcmFkaW8gaW5wdXQsIGV4Y2VwdCBpdCdzIHN0eWxlZCBkaWZmZXJlbnRseS4KICoKICogUmFkaW8gYmVoYXZlcyBsaWtlIGFueSBbQW5ndWxhckpTIHJhZGlvXShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy9pbnB1dC9pbnB1dFtyYWRpb10pLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8aW9uLXJhZGlvIG5nLW1vZGVsPSJjaG9pY2UiIG5nLXZhbHVlPSInQSciPkNob29zZSBBPC9pb24tcmFkaW8+CiAqIDxpb24tcmFkaW8gbmctbW9kZWw9ImNob2ljZSIgbmctdmFsdWU9IidCJyI+Q2hvb3NlIEI8L2lvbi1yYWRpbz4KICogPGlvbi1yYWRpbyBuZy1tb2RlbD0iY2hvaWNlIiBuZy12YWx1ZT0iJ0MnIj5DaG9vc2UgQzwvaW9uLXJhZGlvPgogKiBgYGAKICogCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBUaGUgbmFtZSBvZiB0aGUgcmFkaW8gaW5wdXQuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IHZhbHVlIFRoZSB2YWx1ZSBvZiB0aGUgcmFkaW8gaW5wdXQuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGRpc2FibGVkIFRoZSBzdGF0ZSBvZiB0aGUgcmFkaW8gaW5wdXQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gaWNvbiBUaGUgaWNvbiB0byB1c2Ugd2hlbiB0aGUgcmFkaW8gaW5wdXQgaXMgc2VsZWN0ZWQuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG5nLXZhbHVlIEFuZ3VsYXIgZXF1aXZhbGVudCBvZiB0aGUgdmFsdWUgYXR0cmlidXRlLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBuZy1tb2RlbCBUaGUgYW5ndWxhciBtb2RlbCBmb3IgdGhlIHJhZGlvIGlucHV0LgogKiBAcGFyYW0ge2Jvb2xlYW49fSBuZy1kaXNhYmxlZCBBbmd1bGFyIGVxdWl2YWxlbnQgb2YgdGhlIGRpc2FibGVkIGF0dHJpYnV0ZS4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gbmctY2hhbmdlIFRyaWdnZXJzIGdpdmVuIGV4cHJlc3Npb24gd2hlbiByYWRpbyBpbnB1dCdzIG1vZGVsIGNoYW5nZXMKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblJhZGlvJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXBsYWNlOiB0cnVlLAogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICB0ZW1wbGF0ZToKICAgICAgJzxsYWJlbCBjbGFzcz0iaXRlbSBpdGVtLXJhZGlvIj4nICsKICAgICAgICAnPGlucHV0IHR5cGU9InJhZGlvIiBuYW1lPSJyYWRpby1ncm91cCI+JyArCiAgICAgICAgJzxkaXYgY2xhc3M9Iml0ZW0tY29udGVudCBkaXNhYmxlLXBvaW50ZXItZXZlbnRzIiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICc8aSBjbGFzcz0icmFkaW8taWNvbiBkaXNhYmxlLXBvaW50ZXItZXZlbnRzIGljb24gaW9uLWNoZWNrbWFyayI+PC9pPicgKwogICAgICAnPC9sYWJlbD4nLAoKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgaWYoYXR0ci5pY29uKSBlbGVtZW50LmNoaWxkcmVuKCkuZXEoMikucmVtb3ZlQ2xhc3MoJ2lvbi1jaGVja21hcmsnKS5hZGRDbGFzcyhhdHRyLmljb24pOwogICAgICB2YXIgaW5wdXQgPSBlbGVtZW50LmZpbmQoJ2lucHV0Jyk7CiAgICAgIGZvckVhY2goewogICAgICAgICAgJ25hbWUnOiBhdHRyLm5hbWUsCiAgICAgICAgICAndmFsdWUnOiBhdHRyLnZhbHVlLAogICAgICAgICAgJ2Rpc2FibGVkJzogYXR0ci5kaXNhYmxlZCwKICAgICAgICAgICduZy12YWx1ZSc6IGF0dHIubmdWYWx1ZSwKICAgICAgICAgICduZy1tb2RlbCc6IGF0dHIubmdNb2RlbCwKICAgICAgICAgICduZy1kaXNhYmxlZCc6IGF0dHIubmdEaXNhYmxlZCwKICAgICAgICAgICduZy1jaGFuZ2UnOiBhdHRyLm5nQ2hhbmdlCiAgICAgIH0sIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKSB7CiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgaW5wdXQuYXR0cihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgc2NvcGUuZ2V0VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBzY29wZS5uZ1ZhbHVlIHx8IGF0dHIudmFsdWU7CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0KICB9Owp9KTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25SZWZyZXNoZXIKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25Db250ZW50LCBpb25pYy5kaXJlY3RpdmU6aW9uU2Nyb2xsCiAqIEBkZXNjcmlwdGlvbgogKiBBbGxvd3MgeW91IHRvIGFkZCBwdWxsLXRvLXJlZnJlc2ggdG8gYSBzY3JvbGxWaWV3LgogKgogKiBQbGFjZSBpdCBhcyB0aGUgZmlyc3QgY2hpbGQgb2YgeW91ciB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkNvbnRlbnR9IG9yCiAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2Nyb2xsfSBlbGVtZW50LgogKgogKiBXaGVuIHJlZnJlc2hpbmcgaXMgY29tcGxldGUsICRicm9hZGNhc3QgdGhlICdzY3JvbGwucmVmcmVzaENvbXBsZXRlJyBldmVudAogKiBmcm9tIHlvdXIgY29udHJvbGxlci4KICoKICogQHVzYWdlCiAqCiAqIGBgYGh0bWwKICogPGlvbi1jb250ZW50IG5nLWNvbnRyb2xsZXI9Ik15Q29udHJvbGxlciI+CiAqICAgPGlvbi1yZWZyZXNoZXIKICogICAgIHB1bGxpbmctdGV4dD0iUHVsbCB0byByZWZyZXNoLi4uIgogKiAgICAgb24tcmVmcmVzaD0iZG9SZWZyZXNoKCkiPgogKiAgIDwvaW9uLXJlZnJlc2hlcj4KICogICA8aW9uLWxpc3Q+CiAqICAgICA8aW9uLWl0ZW0gbmctcmVwZWF0PSJpdGVtIGluIGl0ZW1zIj48L2lvbi1pdGVtPgogKiAgIDwvaW9uLWxpc3Q+CiAqIDwvaW9uLWNvbnRlbnQ+CiAqIGBgYAogKiBgYGBqcwogKiBhbmd1bGFyLm1vZHVsZSgndGVzdEFwcCcsIFsnaW9uaWMnXSkKICogLmNvbnRyb2xsZXIoJ015Q29udHJvbGxlcicsIGZ1bmN0aW9uKCRzY29wZSwgJGh0dHApIHsKICogICAkc2NvcGUuaXRlbXMgPSBbMSwyLDNdOwogKiAgICRzY29wZS5kb1JlZnJlc2ggPSBmdW5jdGlvbigpIHsKICogICAgICRodHRwLmdldCgnL25ldy1pdGVtcycpCiAqICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24obmV3SXRlbXMpIHsKICogICAgICAgICRzY29wZS5pdGVtcyA9IG5ld0l0ZW1zOwogKiAgICAgIH0pCiAqICAgICAgLmZpbmFsbHkoZnVuY3Rpb24oKSB7CiAqICAgICAgICAvLyBTdG9wIHRoZSBpb24tcmVmcmVzaGVyIGZyb20gc3Bpbm5pbmcKICogICAgICAgICRzY29wZS4kYnJvYWRjYXN0KCdzY3JvbGwucmVmcmVzaENvbXBsZXRlJyk7CiAqICAgICAgfSk7CiAqICAgfTsKICogfSk7CiAqIGBgYAogKgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1yZWZyZXNoIENhbGxlZCB3aGVuIHRoZSB1c2VyIHB1bGxzIGRvd24gZW5vdWdoIGFuZCBsZXRzIGdvCiAqIG9mIHRoZSByZWZyZXNoZXIuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXB1bGxpbmcgQ2FsbGVkIHdoZW4gdGhlIHVzZXIgc3RhcnRzIHRvIHB1bGwgZG93bgogKiBvbiB0aGUgcmVmcmVzaGVyLgogKiBAcGFyYW0ge3N0cmluZz19IHB1bGxpbmctaWNvbiBUaGUgaWNvbiB0byBkaXNwbGF5IHdoaWxlIHRoZSB1c2VyIGlzIHB1bGxpbmcgZG93bi4KICogRGVmYXVsdDogJ2lvbi1hcnJvdy1kb3duLWMnLgogKiBAcGFyYW0ge3N0cmluZz19IHB1bGxpbmctdGV4dCBUaGUgdGV4dCB0byBkaXNwbGF5IHdoaWxlIHRoZSB1c2VyIGlzIHB1bGxpbmcgZG93bi4KICogQHBhcmFtIHtzdHJpbmc9fSByZWZyZXNoaW5nLWljb24gVGhlIGljb24gdG8gZGlzcGxheSBhZnRlciB1c2VyIGxldHMgZ28gb2YgdGhlCiAqIHJlZnJlc2hlci4KICogQHBhcmFtIHtzdHJpbmc9fSByZWZyZXNoaW5nLXRleHQgVGhlIHRleHQgdG8gZGlzcGxheSBhZnRlciB0aGUgdXNlciBsZXRzIGdvIG9mCiAqIHRoZSByZWZyZXNoZXIuCiAqCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25SZWZyZXNoZXInLCBbJyRpb25pY0JpbmQnLCBmdW5jdGlvbigkaW9uaWNCaW5kKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXBsYWNlOiB0cnVlLAogICAgcmVxdWlyZTogJ14kaW9uaWNTY3JvbGwnLAogICAgdGVtcGxhdGU6CiAgICAnPGRpdiBjbGFzcz0ic2Nyb2xsLXJlZnJlc2hlciIgY29sbGVjdGlvbi1yZXBlYXQtaWdub3JlPicgKwogICAgICAnPGRpdiBjbGFzcz0iaW9uaWMtcmVmcmVzaGVyLWNvbnRlbnQiICcgKwogICAgICAnbmctY2xhc3M9IntcJ2lvbmljLXJlZnJlc2hlci13aXRoLXRleHRcJzogcHVsbGluZ1RleHQgfHwgcmVmcmVzaGluZ1RleHR9Ij4nICsKICAgICAgICAnPGRpdiBjbGFzcz0iaWNvbi1wdWxsaW5nIj4nICsKICAgICAgICAgICc8aSBjbGFzcz0iaWNvbiB7e3B1bGxpbmdJY29ufX0iPjwvaT4nICsKICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgJzxkaXYgY2xhc3M9InRleHQtcHVsbGluZyIgbmctYmluZC1odG1sPSJwdWxsaW5nVGV4dCI+PC9kaXY+JyArCiAgICAgICAgJzxpIGNsYXNzPSJpY29uIHt7cmVmcmVzaGluZ0ljb259fSBpY29uLXJlZnJlc2hpbmciPjwvaT4nICsKICAgICAgICAnPGRpdiBjbGFzcz0idGV4dC1yZWZyZXNoaW5nIiBuZy1iaW5kLWh0bWw9InJlZnJlc2hpbmdUZXh0Ij48L2Rpdj4nICsKICAgICAgJzwvZGl2PicgKwogICAgJzwvZGl2PicsCiAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgIGlmIChhbmd1bGFyLmlzVW5kZWZpbmVkKCRhdHRycy5wdWxsaW5nSWNvbikpIHsKICAgICAgICAkYXR0cnMuJHNldCgncHVsbGluZ0ljb24nLCAnaW9uLWFycm93LWRvd24tYycpOwogICAgICB9CiAgICAgIGlmIChhbmd1bGFyLmlzVW5kZWZpbmVkKCRhdHRycy5yZWZyZXNoaW5nSWNvbikpIHsKICAgICAgICAkYXR0cnMuJHNldCgncmVmcmVzaGluZ0ljb24nLCAnaW9uLWxvYWRpbmctZCcpOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsIHNjcm9sbEN0cmwpIHsKICAgICAgICAkaW9uaWNCaW5kKCRzY29wZSwgJGF0dHJzLCB7CiAgICAgICAgICBwdWxsaW5nSWNvbjogJ0AnLAogICAgICAgICAgcHVsbGluZ1RleHQ6ICdAJywKICAgICAgICAgIHJlZnJlc2hpbmdJY29uOiAnQCcsCiAgICAgICAgICByZWZyZXNoaW5nVGV4dDogJ0AnLAogICAgICAgICAgJG9uUmVmcmVzaDogJyZvblJlZnJlc2gnLAogICAgICAgICAgJG9uUHVsbGluZzogJyZvblB1bGxpbmcnCiAgICAgICAgfSk7CgogICAgICAgIHNjcm9sbEN0cmwuX3NldFJlZnJlc2hlcigkc2NvcGUsICRlbGVtZW50WzBdKTsKICAgICAgICAkc2NvcGUuJG9uKCdzY3JvbGwucmVmcmVzaENvbXBsZXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAkc2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2Nyb2xsQ3RybC5zY3JvbGxWaWV3LmZpbmlzaFB1bGxUb1JlZnJlc2goKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9OwogICAgfQogIH07Cn1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblNjcm9sbAogKiBAbW9kdWxlIGlvbmljCiAqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY1Njcm9sbERlbGVnYXRlCiAqIEBjb2RlcGVuIG13RnVoCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGEgc2Nyb2xsYWJsZSBjb250YWluZXIgZm9yIGFsbCBjb250ZW50IGluc2lkZS4KICoKICogQHVzYWdlCiAqCiAqIEJhc2ljIHVzYWdlOgogKgogKiBgYGBodG1sCiAqIDxpb24tc2Nyb2xsIHpvb21pbmc9InRydWUiIGRpcmVjdGlvbj0ieHkiIHN0eWxlPSJ3aWR0aDogNTAwcHg7IGhlaWdodDogNTAwcHgiPgogKiAgIDxkaXYgc3R5bGU9IndpZHRoOiA1MDAwcHg7IGhlaWdodDogNTAwMHB4OyBiYWNrZ3JvdW5kOiB1cmwoJ2h0dHBzOi8vdXBsb2FkLndpa2ltZWRpYS5vcmcvd2lraXBlZGlhL2NvbW1vbnMvYS9hZC9FdXJvcGVfZ2VvbG9naWNhbF9tYXAtZW4uanBnJykgcmVwZWF0Ij48L2Rpdj4KICogIDwvaW9uLXNjcm9sbD4KICogYGBgCiAqCiAqIE5vdGUgdGhhdCBpdCdzIGltcG9ydGFudCB0byBzZXQgdGhlIGhlaWdodCBvZiB0aGUgc2Nyb2xsIGJveCBhcyB3ZWxsIGFzIHRoZSBoZWlnaHQgb2YgdGhlIGlubmVyCiAqIGNvbnRlbnQgdG8gZW5hYmxlIHNjcm9sbGluZy4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBoYXZlIGZ1bGwgY29udHJvbCBvdmVyIHNjcm9sbGFibGUgYXJlYXMuCiAqCiAqIElmIHlvdSdkIGp1c3QgbGlrZSB0byBoYXZlIGEgY2VudGVyIGNvbnRlbnQgc2Nyb2xsaW5nIGFyZWEsIHVzZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkNvbnRlbnR9IGluc3RlYWQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIHNjcm9sbFZpZXcKICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTY3JvbGxEZWxlZ2F0ZX0uCiAqIEBwYXJhbSB7c3RyaW5nPX0gZGlyZWN0aW9uIFdoaWNoIHdheSB0byBzY3JvbGwuICd4JyBvciAneScgb3IgJ3h5Jy4gRGVmYXVsdCAneScuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGxvY2tpbmcgV2hldGhlciB0byBsb2NrIHNjcm9sbGluZyBpbiBvbmUgZGlyZWN0aW9uIGF0IGEgdGltZS4gVXNlZnVsIHRvIHNldCB0byBmYWxzZSB3aGVuIHpvb21lZCBpbiBvciBzY3JvbGxpbmcgaW4gdHdvIGRpcmVjdGlvbnMuIERlZmF1bHQgdHJ1ZS4KICogQHBhcmFtIHtib29sZWFuPX0gcGFnaW5nIFdoZXRoZXIgdG8gc2Nyb2xsIHdpdGggcGFnaW5nLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1yZWZyZXNoIENhbGxlZCBvbiBwdWxsLXRvLXJlZnJlc2gsIHRyaWdnZXJlZCBieSBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblJlZnJlc2hlcn0uCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNjcm9sbCBDYWxsZWQgd2hlbmV2ZXIgdGhlIHVzZXIgc2Nyb2xscy4KICogQHBhcmFtIHtib29sZWFuPX0gc2Nyb2xsYmFyLXggV2hldGhlciB0byBzaG93IHRoZSBob3Jpem9udGFsIHNjcm9sbGJhci4gRGVmYXVsdCB0cnVlLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBzY3JvbGxiYXIteSBXaGV0aGVyIHRvIHNob3cgdGhlIHZlcnRpY2FsIHNjcm9sbGJhci4gRGVmYXVsdCB0cnVlLgogKiBAcGFyYW0ge2Jvb2xlYW49fSB6b29taW5nIFdoZXRoZXIgdG8gc3VwcG9ydCBwaW5jaC10by16b29tCiAqIEBwYXJhbSB7aW50ZWdlcj19IG1pbi16b29tIFRoZSBzbWFsbGVzdCB6b29tIGFtb3VudCBhbGxvd2VkIChkZWZhdWx0IGlzIDAuNSkKICogQHBhcmFtIHtpbnRlZ2VyPX0gbWF4LXpvb20gVGhlIGxhcmdlc3Qgem9vbSBhbW91bnQgYWxsb3dlZCAoZGVmYXVsdCBpcyAzKQogKiBAcGFyYW0ge2Jvb2xlYW49fSBoYXMtYm91bmNpbmcgV2hldGhlciB0byBhbGxvdyBzY3JvbGxpbmcgdG8gYm91bmNlIHBhc3QgdGhlIGVkZ2VzCiAqIG9mIHRoZSBjb250ZW50LiAgRGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MsIGZhbHNlIG9uIEFuZHJvaWQuCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25TY3JvbGwnLCBbCiAgJyR0aW1lb3V0JywKICAnJGNvbnRyb2xsZXInLAogICckaW9uaWNCaW5kJywKZnVuY3Rpb24oJHRpbWVvdXQsICRjb250cm9sbGVyLCAkaW9uaWNCaW5kKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBzY29wZTogdHJ1ZSwKICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3Njcm9sbC12aWV3IGlvbmljLXNjcm9sbCcpOwoKICAgICAgLy9XZSBjYW5ub3QgdHJhbnNjbHVkZSBoZXJlIGJlY2F1c2UgaXQgYnJlYWtzIGVsZW1lbnQuZGF0YSgpIGluaGVyaXRhbmNlIG9uIGNvbXBpbGUKICAgICAgdmFyIGlubmVyRWxlbWVudCA9IGpxTGl0ZSgnPGRpdiBjbGFzcz0ic2Nyb2xsIj48L2Rpdj4nKTsKICAgICAgaW5uZXJFbGVtZW50LmFwcGVuZChlbGVtZW50LmNvbnRlbnRzKCkpOwogICAgICBlbGVtZW50LmFwcGVuZChpbm5lckVsZW1lbnQpOwoKICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICB2YXIgc2Nyb2xsVmlldywgc2Nyb2xsQ3RybDsKCiAgICAgICAgJGlvbmljQmluZCgkc2NvcGUsICRhdHRyLCB7CiAgICAgICAgICBkaXJlY3Rpb246ICdAJywKICAgICAgICAgIHBhZ2luZzogJ0AnLAogICAgICAgICAgJG9uU2Nyb2xsOiAnJm9uU2Nyb2xsJywKICAgICAgICAgIHNjcm9sbDogJ0AnLAogICAgICAgICAgc2Nyb2xsYmFyWDogJ0AnLAogICAgICAgICAgc2Nyb2xsYmFyWTogJ0AnLAogICAgICAgICAgem9vbWluZzogJ0AnLAogICAgICAgICAgbWluWm9vbTogJ0AnLAogICAgICAgICAgbWF4Wm9vbTogJ0AnCiAgICAgICAgfSk7CiAgICAgICAgJHNjb3BlLmRpcmVjdGlvbiA9ICRzY29wZS5kaXJlY3Rpb24gfHwgJ3knOwoKICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQoJGF0dHIucGFkZGluZykpIHsKICAgICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIucGFkZGluZywgZnVuY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgIGlubmVyRWxlbWVudC50b2dnbGVDbGFzcygncGFkZGluZycsICEhbmV3VmFsKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZigkc2NvcGUuJGV2YWwoJHNjb3BlLnBhZ2luZykgPT09IHRydWUpIHsKICAgICAgICAgIGlubmVyRWxlbWVudC5hZGRDbGFzcygnc2Nyb2xsLXBhZ2luZycpOwogICAgICAgIH0KCiAgICAgICAgaWYoISRzY29wZS5kaXJlY3Rpb24pIHsgJHNjb3BlLmRpcmVjdGlvbiA9ICd5JzsgfQogICAgICAgIHZhciBpc1BhZ2luZyA9ICRzY29wZS4kZXZhbCgkc2NvcGUucGFnaW5nKSA9PT0gdHJ1ZTsKCiAgICAgICAgdmFyIHNjcm9sbFZpZXdPcHRpb25zPSB7CiAgICAgICAgICBlbDogJGVsZW1lbnRbMF0sCiAgICAgICAgICBkZWxlZ2F0ZUhhbmRsZTogJGF0dHIuZGVsZWdhdGVIYW5kbGUsCiAgICAgICAgICBsb2NraW5nOiAoJGF0dHIubG9ja2luZyB8fCAndHJ1ZScpID09PSAndHJ1ZScsCiAgICAgICAgICBib3VuY2luZzogJHNjb3BlLiRldmFsKCRhdHRyLmhhc0JvdW5jaW5nKSwKICAgICAgICAgIHBhZ2luZzogaXNQYWdpbmcsCiAgICAgICAgICBzY3JvbGxiYXJYOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnNjcm9sbGJhclgpICE9PSBmYWxzZSwKICAgICAgICAgIHNjcm9sbGJhclk6ICRzY29wZS4kZXZhbCgkc2NvcGUuc2Nyb2xsYmFyWSkgIT09IGZhbHNlLAogICAgICAgICAgc2Nyb2xsaW5nWDogJHNjb3BlLmRpcmVjdGlvbi5pbmRleE9mKCd4JykgPj0gMCwKICAgICAgICAgIHNjcm9sbGluZ1k6ICRzY29wZS5kaXJlY3Rpb24uaW5kZXhPZigneScpID49IDAsCiAgICAgICAgICB6b29taW5nOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnpvb21pbmcpID09PSB0cnVlLAogICAgICAgICAgbWF4Wm9vbTogJHNjb3BlLiRldmFsKCRzY29wZS5tYXhab29tKSB8fCAzLAogICAgICAgICAgbWluWm9vbTogJHNjb3BlLiRldmFsKCRzY29wZS5taW5ab29tKSB8fCAwLjUKICAgICAgICB9OwogICAgICAgIGlmIChpc1BhZ2luZykgewogICAgICAgICAgc2Nyb2xsVmlld09wdGlvbnMuc3BlZWRNdWx0aXBsaWVyID0gMC44OwogICAgICAgICAgc2Nyb2xsVmlld09wdGlvbnMuYm91bmNpbmcgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHNjcm9sbEN0cmwgPSAkY29udHJvbGxlcignJGlvbmljU2Nyb2xsJywgewogICAgICAgICAgJHNjb3BlOiAkc2NvcGUsCiAgICAgICAgICBzY3JvbGxWaWV3T3B0aW9uczogc2Nyb2xsVmlld09wdGlvbnMKICAgICAgICB9KTsKICAgICAgICBzY3JvbGxWaWV3ID0gJHNjb3BlLiRwYXJlbnQuc2Nyb2xsVmlldyA9IHNjcm9sbEN0cmwuc2Nyb2xsVmlldzsKICAgICAgfQogICAgfQogIH07Cn1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblNpZGVNZW51CiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICogQHBhcmVudCBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGNvbnRhaW5lciBmb3IgYSBzaWRlIG1lbnUsIHNpYmxpbmcgdG8gYW4ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudUNvbnRlbnR9IGRpcmVjdGl2ZS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi1zaWRlLW1lbnUKICogICBzaWRlPSJsZWZ0IgogKiAgIHdpZHRoPSJteVdpZHRoVmFsdWUgKyAyMCIKICogICBpcy1lbmFibGVkPSJzaG91bGRMZWZ0U2lkZU1lbnVCZUVuYWJsZWQoKSI+CiAqIDwvaW9uLXNpZGUtbWVudT4KICogYGBgCiAqIEZvciBhIGNvbXBsZXRlIHNpZGUgbWVudSBleGFtcGxlLCBzZWUgdGhlCiAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVzfSBkb2N1bWVudGF0aW9uLgogKgogKiBAcGFyYW0ge3N0cmluZ30gc2lkZSBXaGljaCBzaWRlIHRoZSBzaWRlIG1lbnUgaXMgY3VycmVudGx5IG9uLiAgQWxsb3dlZCB2YWx1ZXM6ICdsZWZ0JyBvciAncmlnaHQnLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBpcy1lbmFibGVkIFdoZXRoZXIgdGhpcyBzaWRlIG1lbnUgaXMgZW5hYmxlZC4KICogQHBhcmFtIHtudW1iZXI9fSB3aWR0aCBIb3cgbWFueSBwaXhlbHMgd2lkZSB0aGUgc2lkZSBtZW51IHNob3VsZCBiZS4gIERlZmF1bHRzIHRvIDI3NS4KICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblNpZGVNZW51JywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiAnXmlvblNpZGVNZW51cycsCiAgICBzY29wZTogdHJ1ZSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgYW5ndWxhci5pc1VuZGVmaW5lZChhdHRyLmlzRW5hYmxlZCkgJiYgYXR0ci4kc2V0KCdpc0VuYWJsZWQnLCAndHJ1ZScpOwogICAgICBhbmd1bGFyLmlzVW5kZWZpbmVkKGF0dHIud2lkdGgpICYmIGF0dHIuJHNldCgnd2lkdGgnLCAnMjc1Jyk7CgogICAgICBlbGVtZW50LmFkZENsYXNzKCdtZW51IG1lbnUtJyArIGF0dHIuc2lkZSk7CgogICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNpZGVNZW51Q3RybCkgewogICAgICAgICRzY29wZS5zaWRlID0gJGF0dHIuc2lkZSB8fCAnbGVmdCc7CgogICAgICAgIHZhciBzaWRlTWVudSA9IHNpZGVNZW51Q3RybFskc2NvcGUuc2lkZV0gPSBuZXcgaW9uaWMudmlld3MuU2lkZU1lbnUoewogICAgICAgICAgd2lkdGg6IDI3NSwKICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgIGlzRW5hYmxlZDogdHJ1ZQogICAgICAgIH0pOwoKICAgICAgICAkc2NvcGUuJHdhdGNoKCRhdHRyLndpZHRoLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHZhciBudW1iZXJWYWwgPSArdmFsOwogICAgICAgICAgaWYgKG51bWJlclZhbCAmJiBudW1iZXJWYWwgPT0gdmFsKSB7CiAgICAgICAgICAgIHNpZGVNZW51LnNldFdpZHRoKCt2YWwpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIuaXNFbmFibGVkLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHNpZGVNZW51LnNldElzRW5hYmxlZCghIXZhbCk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfTsKfSk7CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uU2lkZU1lbnVDb250ZW50CiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICogQHBhcmVudCBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGNvbnRhaW5lciBmb3IgdGhlIG1haW4gdmlzaWJsZSBjb250ZW50LCBzaWJsaW5nIHRvIG9uZSBvciBtb3JlCiAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnV9IGRpcmVjdGl2ZXMuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxpb24tc2lkZS1tZW51LWNvbnRlbnQKICogICBlZGdlLWRyYWctdGhyZXNob2xkPSJ0cnVlIgogKiAgIGRyYWctY29udGVudD0idHJ1ZSI+CiAqIDwvaW9uLXNpZGUtbWVudS1jb250ZW50PgogKiBgYGAKICogRm9yIGEgY29tcGxldGUgc2lkZSBtZW51IGV4YW1wbGUsIHNlZSB0aGUKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXN9IGRvY3VtZW50YXRpb24uCiAqCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGRyYWctY29udGVudCBXaGV0aGVyIHRoZSBjb250ZW50IGNhbiBiZSBkcmFnZ2VkLiBEZWZhdWx0IHRydWUuCiAqIEBwYXJhbSB7Ym9vbGVhbnxudW1iZXI9fSBlZGdlLWRyYWctdGhyZXNob2xkIFdoZXRoZXIgdGhlIGNvbnRlbnQgZHJhZyBjYW4gb25seSBzdGFydCBpZiBpdCBpcyBiZWxvdyBhIGNlcnRhaW4gdGhyZXNob2xkIGRpc3RhbmNlIGZyb20gdGhlIGVkZ2Ugb2YgdGhlIHNjcmVlbi4gIERlZmF1bHQgZmFsc2UuIEFjY2VwdHMgdGhyZWUgdHlwZXMgb2YgdmFsdWVzOgogICAqICAtIElmIGEgbm9uLXplcm8gbnVtYmVyIGlzIGdpdmVuLCB0aGF0IG1hbnkgcGl4ZWxzIGlzIHVzZWQgYXMgdGhlIG1heGltdW0gYWxsb3dlZCBkaXN0YW5jZSBmcm9tIHRoZSBlZGdlIHRoYXQgc3RhcnRzIGRyYWdnaW5nIHRoZSBzaWRlIG1lbnUuCiAgICogIC0gSWYgdHJ1ZSBpcyBnaXZlbiwgdGhlIGRlZmF1bHQgbnVtYmVyIG9mIHBpeGVscyAoMjUpIGlzIHVzZWQgYXMgdGhlIG1heGltdW0gYWxsb3dlZCBkaXN0YW5jZS4KICAgKiAgLSBJZiBmYWxzZSBvciAwIGlzIGdpdmVuLCB0aGUgZWRnZSBkcmFnIHRocmVzaG9sZCBpcyBkaXNhYmxlZCwgYW5kIGRyYWdnaW5nIGZyb20gYW55d2hlcmUgb24gdGhlIGNvbnRlbnQgaXMgYWxsb3dlZC4KICoKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblNpZGVNZW51Q29udGVudCcsIFsKICAnJHRpbWVvdXQnLAogICckaW9uaWNHZXN0dXJlJywKICAnJHdpbmRvdycsCmZ1bmN0aW9uKCR0aW1lb3V0LCAkaW9uaWNHZXN0dXJlLCAkd2luZG93KSB7CgogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0VBJywgLy9ERVBSRUNBVEVEICdBJwogICAgcmVxdWlyZTogJ15pb25TaWRlTWVudXMnLAogICAgc2NvcGU6IHRydWUsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBzaWRlTWVudUN0cmwpIHsKICAgICAgICB2YXIgc3RhcnRDb29yZCA9IG51bGw7CiAgICAgICAgdmFyIHByaW1hcnlTY3JvbGxBeGlzID0gbnVsbDsKCiAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoJ21lbnUtY29udGVudCBwYW5lJyk7CgogICAgICAgIGlmIChpc0RlZmluZWQoYXR0ci5kcmFnQ29udGVudCkpIHsKICAgICAgICAgICRzY29wZS4kd2F0Y2goYXR0ci5kcmFnQ29udGVudCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgc2lkZU1lbnVDdHJsLmNhbkRyYWdDb250ZW50KHZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzaWRlTWVudUN0cmwuY2FuRHJhZ0NvbnRlbnQodHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEZWZpbmVkKGF0dHIuZWRnZURyYWdUaHJlc2hvbGQpKSB7CiAgICAgICAgICAkc2NvcGUuJHdhdGNoKGF0dHIuZWRnZURyYWdUaHJlc2hvbGQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHNpZGVNZW51Q3RybC5lZGdlRHJhZ1RocmVzaG9sZCh2YWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIExpc3RlbiBmb3IgdGFwcyBvbiB0aGUgY29udGVudCB0byBjbG9zZSB0aGUgbWVudQogICAgICAgIGZ1bmN0aW9uIG9uQ29udGVudFRhcChnZXN0dXJlRXZ0KSB7CiAgICAgICAgICBpZihzaWRlTWVudUN0cmwuZ2V0T3BlbkFtb3VudCgpICE9PSAwKSB7CiAgICAgICAgICAgIHNpZGVNZW51Q3RybC5jbG9zZSgpOwogICAgICAgICAgICBnZXN0dXJlRXZ0Lmdlc3R1cmUuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgc3RhcnRDb29yZCA9IG51bGw7CiAgICAgICAgICAgIHByaW1hcnlTY3JvbGxBeGlzID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZighc3RhcnRDb29yZCkgewogICAgICAgICAgICBzdGFydENvb3JkID0gaW9uaWMudGFwLnBvaW50ZXJDb29yZChnZXN0dXJlRXZ0Lmdlc3R1cmUuc3JjRXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25EcmFnWChlKSB7CiAgICAgICAgICBpZighc2lkZU1lbnVDdHJsLmlzRHJhZ2dhYmxlVGFyZ2V0KGUpKSByZXR1cm47CgogICAgICAgICAgaWYoIGdldFByaW1hcnlTY3JvbGxBeGlzKGUpID09ICd4JykgewogICAgICAgICAgICBzaWRlTWVudUN0cmwuX2hhbmRsZURyYWcoZSk7CiAgICAgICAgICAgIGUuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25EcmFnWShlKSB7CiAgICAgICAgICBpZiggZ2V0UHJpbWFyeVNjcm9sbEF4aXMoZSkgPT0gJ3gnICkgewogICAgICAgICAgICBlLmdlc3R1cmUuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uRHJhZ1JlbGVhc2UoZSkgewogICAgICAgICAgc2lkZU1lbnVDdHJsLl9lbmREcmFnKGUpOwogICAgICAgICAgc3RhcnRDb29yZCA9IG51bGw7CiAgICAgICAgICBwcmltYXJ5U2Nyb2xsQXhpcyA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRQcmltYXJ5U2Nyb2xsQXhpcyhnZXN0dXJlRXZ0KSB7CiAgICAgICAgICAvLyBnZXRzIHdoZXRoZXIgdGhlIHVzZXIgaXMgcHJpbWFyaWx5IHNjcm9sbGluZyBvbiB0aGUgWCBvciBZCiAgICAgICAgICAvLyBJZiBhIG1ham9yaXR5IG9mIHRoZSBkcmFnIGhhcyBiZWVuIG9uIHRoZSBZIHNpbmNlIHRoZSBzdGFydCBvZgogICAgICAgICAgLy8gdGhlIGRyYWcsIGJ1dCB0aGUgWCBoYXMgbW92ZWQgYSBsaXR0bGUgYml0LCBpdCdzIHN0aWxsIGEgWSBkcmFnCgogICAgICAgICAgaWYocHJpbWFyeVNjcm9sbEF4aXMpIHsKICAgICAgICAgICAgLy8gd2UgYWxyZWFkeSBmaWd1cmVkIG91dCB3aGljaCB3YXkgdGhleSdyZSBzY3JvbGxpbmcKICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlTY3JvbGxBeGlzOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKGdlc3R1cmVFdnQgJiYgZ2VzdHVyZUV2dC5nZXN0dXJlKSB7CgogICAgICAgICAgICBpZighc3RhcnRDb29yZCkgewogICAgICAgICAgICAgIC8vIGdldCB0aGUgc3RhcnRpbmcgcG9pbnQKICAgICAgICAgICAgICBzdGFydENvb3JkID0gaW9uaWMudGFwLnBvaW50ZXJDb29yZChnZXN0dXJlRXZ0Lmdlc3R1cmUuc3JjRXZlbnQpOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyB3ZSBhbHJlYWR5IGhhdmUgYSBzdGFydGluZyBwb2ludCwgZmlndXJlIG91dCB3aGljaCBkaXJlY3Rpb24gdGhleSdyZSBnb2luZwogICAgICAgICAgICAgIHZhciBlbmRDb29yZCA9IGlvbmljLnRhcC5wb2ludGVyQ29vcmQoZ2VzdHVyZUV2dC5nZXN0dXJlLnNyY0V2ZW50KTsKCiAgICAgICAgICAgICAgdmFyIHhEaXN0YW5jZSA9IE1hdGguYWJzKGVuZENvb3JkLnggLSBzdGFydENvb3JkLngpOwogICAgICAgICAgICAgIHZhciB5RGlzdGFuY2UgPSBNYXRoLmFicyhlbmRDb29yZC55IC0gc3RhcnRDb29yZC55KTsKCiAgICAgICAgICAgICAgdmFyIHNjcm9sbEF4aXMgPSAoIHhEaXN0YW5jZSA8IHlEaXN0YW5jZSA/ICd5JyA6ICd4JyApOwoKICAgICAgICAgICAgICBpZiggTWF0aC5tYXgoeERpc3RhbmNlLCB5RGlzdGFuY2UpID4gMzAgKSB7CiAgICAgICAgICAgICAgICAvLyBvaywgd2UgcHJldHR5IG11Y2gga25vdyB3aGljaCB3YXkgdGhleSdyZSBnb2luZwogICAgICAgICAgICAgICAgLy8gbGV0J3MgbG9jayBpdCBpbgogICAgICAgICAgICAgICAgcHJpbWFyeVNjcm9sbEF4aXMgPSBzY3JvbGxBeGlzOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIHNjcm9sbEF4aXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAneCc7CiAgICAgICAgfQoKICAgICAgICB2YXIgY29udGVudCA9IHsKICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnRbMF0sCiAgICAgICAgICBvbkRyYWc6IGZ1bmN0aW9uKGUpIHt9LAogICAgICAgICAgZW5kRHJhZzogZnVuY3Rpb24oZSkge30sCiAgICAgICAgICBnZXRUcmFuc2xhdGVYOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICRzY29wZS5zaWRlTWVudUNvbnRlbnRUcmFuc2xhdGVYIHx8IDA7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0VHJhbnNsYXRlWDogaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShmdW5jdGlvbihhbW91bnQpIHsKICAgICAgICAgICAgdmFyIHhUcmFuc2Zvcm0gPSBjb250ZW50Lm9mZnNldFggKyBhbW91bnQ7CiAgICAgICAgICAgICRlbGVtZW50WzBdLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKCcgKyB4VHJhbnNmb3JtICsgJ3B4LDAsMCknOwogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAkc2NvcGUuc2lkZU1lbnVDb250ZW50VHJhbnNsYXRlWCA9IGFtb3VudDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KSwKICAgICAgICAgIHNldE1hcmdpbkxlZnQ6IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oYW1vdW50KSB7CiAgICAgICAgICAgIGlmKGFtb3VudCkgewogICAgICAgICAgICAgICRlbGVtZW50WzBdLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKCcgKyBhbW91bnQgKyAncHgsMCwwKSc7CiAgICAgICAgICAgICAgJGVsZW1lbnRbMF0uc3R5bGUud2lkdGggPSAoJHdpbmRvdy5pbm5lcldpZHRoIC0gYW1vdW50KSArICdweCc7CiAgICAgICAgICAgICAgY29udGVudC5vZmZzZXRYID0gYW1vdW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICRlbGVtZW50WzBdLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKDAsMCwwKSc7CiAgICAgICAgICAgICAgJGVsZW1lbnRbMF0uc3R5bGUud2lkdGggPSAnJzsKICAgICAgICAgICAgICBjb250ZW50Lm9mZnNldFggPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9KSwKICAgICAgICAgIGVuYWJsZUFuaW1hdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRzY29wZS5hbmltYXRpb25FbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgJGVsZW1lbnRbMF0uY2xhc3NMaXN0LmFkZCgnbWVudS1hbmltYXRlZCcpOwogICAgICAgICAgfSwKICAgICAgICAgIGRpc2FibGVBbmltYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkc2NvcGUuYW5pbWF0aW9uRW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAkZWxlbWVudFswXS5jbGFzc0xpc3QucmVtb3ZlKCdtZW51LWFuaW1hdGVkJyk7CiAgICAgICAgICB9LAogICAgICAgICAgb2Zmc2V0WDogMAogICAgICAgIH07CgogICAgICAgIHNpZGVNZW51Q3RybC5zZXRDb250ZW50KGNvbnRlbnQpOwoKICAgICAgICAvLyBhZGQgZ2VzdHVyZSBoYW5kbGVycwogICAgICAgIHZhciBnZXN0dXJlT3B0cyA9IHsgc3RvcF9icm93c2VyX2JlaGF2aW9yOiBmYWxzZSB9OwogICAgICAgIHZhciBjb250ZW50VGFwR2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ3RhcCcsIG9uQ29udGVudFRhcCwgJGVsZW1lbnQsIGdlc3R1cmVPcHRzKTsKICAgICAgICB2YXIgZHJhZ1JpZ2h0R2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ2RyYWdyaWdodCcsIG9uRHJhZ1gsICRlbGVtZW50LCBnZXN0dXJlT3B0cyk7CiAgICAgICAgdmFyIGRyYWdMZWZ0R2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ2RyYWdsZWZ0Jywgb25EcmFnWCwgJGVsZW1lbnQsIGdlc3R1cmVPcHRzKTsKICAgICAgICB2YXIgZHJhZ1VwR2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ2RyYWd1cCcsIG9uRHJhZ1ksICRlbGVtZW50LCBnZXN0dXJlT3B0cyk7CiAgICAgICAgdmFyIGRyYWdEb3duR2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ2RyYWdkb3duJywgb25EcmFnWSwgJGVsZW1lbnQsIGdlc3R1cmVPcHRzKTsKICAgICAgICB2YXIgcmVsZWFzZUdlc3R1cmUgPSAkaW9uaWNHZXN0dXJlLm9uKCdyZWxlYXNlJywgb25EcmFnUmVsZWFzZSwgJGVsZW1lbnQsIGdlc3R1cmVPcHRzKTsKCiAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAkaW9uaWNHZXN0dXJlLm9mZihkcmFnTGVmdEdlc3R1cmUsICdkcmFnbGVmdCcsIG9uRHJhZ1gpOwogICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoZHJhZ1JpZ2h0R2VzdHVyZSwgJ2RyYWdyaWdodCcsIG9uRHJhZ1gpOwogICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoZHJhZ1VwR2VzdHVyZSwgJ2RyYWd1cCcsIG9uRHJhZ1kpOwogICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoZHJhZ0Rvd25HZXN0dXJlLCAnZHJhZ2Rvd24nLCBvbkRyYWdZKTsKICAgICAgICAgICRpb25pY0dlc3R1cmUub2ZmKHJlbGVhc2VHZXN0dXJlLCAncmVsZWFzZScsIG9uRHJhZ1JlbGVhc2UpOwogICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoY29udGVudFRhcEdlc3R1cmUsICd0YXAnLCBvbkNvbnRlbnRUYXApOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKSW9uaWNNb2R1bGUKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblNpZGVNZW51cwogKiBAbW9kdWxlIGlvbmljCiAqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY1NpZGVNZW51RGVsZWdhdGUKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgY29udGFpbmVyIGVsZW1lbnQgZm9yIHNpZGUgbWVudShzKSBhbmQgdGhlIG1haW4gY29udGVudC4gQWxsb3dzIHRoZSBsZWZ0CiAqIGFuZC9vciByaWdodCBzaWRlIG1lbnUgdG8gYmUgdG9nZ2xlZCBieSBkcmFnZ2luZyB0aGUgbWFpbiBjb250ZW50IGFyZWEgc2lkZQogKiB0byBzaWRlLgogKgogKiBUbyBhdXRvbWF0aWNhbGx5IGNsb3NlIGFuIG9wZW5lZCBtZW51IHlvdSBjYW4gYWRkIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOm1lbnVDbG9zZX0KICogYXR0cmlidXRlIGRpcmVjdGl2ZS4gSW5jbHVkaW5nIHRoZSBgbWVudS1jbG9zZWAgYXR0cmlidXRlIGlzIHVzdWFsbHkgYWRkZWQgdG8KICogbGlua3MgYW5kIGJ1dHRvbnMgd2l0aGluIGBpb24tc2lkZS1tZW51YCBjb250ZW50LCBzbyB0aGF0IHdoZW4gdGhlIGVsZW1lbnQgaXMKICogY2xpY2tlZCB0aGVuIHRoZSBvcGVuZWQgc2lkZSBtZW51IHdpbGwgYXV0b21hdGljYWxseSBjbG9zZS4KICoKICogQnkgZGVmYXVsdCwgc2lkZSBtZW51cyBhcmUgaGlkZGVuIHVuZGVybmVhdGggaXRzIHNpZGUgbWVudSBjb250ZW50LCBhbmQgY2FuIGJlIG9wZW5lZCBieQogKiBlaXRoZXIgc3dpcGluZyB0aGUgY29udGVudCBsZWZ0IG9yIHJpZ2h0LCBvciB0b2dnbGluZyBhIGJ1dHRvbiB0byBzaG93IHRoZSBzaWRlIG1lbnUuIEhvd2V2ZXIsCiAqIGJ5IGFkZGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTpleHBvc2VBc2lkZVdoZW59IGF0dHJpYnV0ZSBkaXJlY3RpdmUgdG8gYW4KICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudX0gZWxlbWVudCBkaXJlY3RpdmUsIGEgc2lkZSBtZW51IGNhbiBiZSBnaXZlbiBpbnN0cnVjdGlvbnMKICogb24gIndoZW4iIHRoZSBtZW51IHNob3VsZCBiZSBleHBvc2VkIChhbHdheXMgdmlld2FibGUpLgogKgogKiAhW1NpZGUgTWVudV0oaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS5zMy5hbWF6b25hd3MuY29tL2RvY3MvY29udHJvbGxlcnMvc2lkZW1lbnUuZ2lmKQogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBzaWRlIG1lbnVzLCBjaGVjayBvdXQ6CiAqCiAqIC0ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudUNvbnRlbnR9CiAqIC0ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudX0KICogLSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOm1lbnVDbG9zZX0KICogLSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmV4cG9zZUFzaWRlV2hlbn0KICoKICogQHVzYWdlCiAqIFRvIHVzZSBzaWRlIG1lbnVzLCBhZGQgYW4gYDxpb24tc2lkZS1tZW51cz5gIHBhcmVudCBlbGVtZW50LAogKiBhbiBgPGlvbi1zaWRlLW1lbnUtY29udGVudD5gIGZvciB0aGUgY2VudGVyIGNvbnRlbnQsCiAqIGFuZCBvbmUgb3IgbW9yZSBgPGlvbi1zaWRlLW1lbnU+YCBkaXJlY3RpdmVzLgogKgogKiBgYGBodG1sCiAqIDxpb24tc2lkZS1tZW51cz4KICogICA8IS0tIENlbnRlciBjb250ZW50IC0tPgogKiAgIDxpb24tc2lkZS1tZW51LWNvbnRlbnQgbmctY29udHJvbGxlcj0iQ29udGVudENvbnRyb2xsZXIiPgogKiAgIDwvaW9uLXNpZGUtbWVudS1jb250ZW50PgogKgogKiAgIDwhLS0gTGVmdCBtZW51IC0tPgogKiAgIDxpb24tc2lkZS1tZW51IHNpZGU9ImxlZnQiPgogKiAgIDwvaW9uLXNpZGUtbWVudT4KICoKICogICA8IS0tIFJpZ2h0IG1lbnUgLS0+CiAqICAgPGlvbi1zaWRlLW1lbnUgc2lkZT0icmlnaHQiPgogKiAgIDwvaW9uLXNpZGUtbWVudT4KICogPC9pb24tc2lkZS1tZW51cz4KICogYGBgCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIENvbnRlbnRDb250cm9sbGVyKCRzY29wZSwgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSkgewogKiAgICRzY29wZS50b2dnbGVMZWZ0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTaWRlTWVudURlbGVnYXRlLnRvZ2dsZUxlZnQoKTsKICogICB9OwogKiB9CiAqIGBgYAogKgogKiBAcGFyYW0ge3N0cmluZz19IGRlbGVnYXRlLWhhbmRsZSBUaGUgaGFuZGxlIHVzZWQgdG8gaWRlbnRpZnkgdGhpcyBzaWRlIG1lbnUKICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTaWRlTWVudURlbGVnYXRlfS4KICoKICovCi5kaXJlY3RpdmUoJ2lvblNpZGVNZW51cycsIFsnJGlvbmljQm9keScsIGZ1bmN0aW9uKCRpb25pY0JvZHkpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgY29udHJvbGxlcjogJyRpb25pY1NpZGVNZW51cycsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIGF0dHIuJHNldCgnY2xhc3MnLCAoYXR0clsnY2xhc3MnXSB8fCAnJykgKyAnIHZpZXcnKTsKCiAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSkgewoKICAgICAgICAkc2NvcGUuJG9uKCckaW9uaWNFeHBvc2VBc2lkZScsIGZ1bmN0aW9uKGV2dCwgaXNBc2lkZUV4cG9zZWQpewogICAgICAgICAgaWYoISRzY29wZS4kZXhwb3NlQXNpZGUpICRzY29wZS4kZXhwb3NlQXNpZGUgPSB7fTsKICAgICAgICAgICRzY29wZS4kZXhwb3NlQXNpZGUuYWN0aXZlID0gaXNBc2lkZUV4cG9zZWQ7CiAgICAgICAgICAkaW9uaWNCb2R5LmVuYWJsZUNsYXNzKGlzQXNpZGVFeHBvc2VkLCAnYXNpZGUtb3BlbicpOwogICAgICAgIH0pOwoKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAkaW9uaWNCb2R5LnJlbW92ZUNsYXNzKCdtZW51LW9wZW4nLCAnYXNpZGUtb3BlbicpOwogICAgICAgIH0pOwoKICAgICAgfQogICAgfQogIH07Cn1dKTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25TbGlkZUJveAogKiBAbW9kdWxlIGlvbmljCiAqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY1NsaWRlQm94RGVsZWdhdGUKICogQHJlc3RyaWN0IEUKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBTbGlkZSBCb3ggaXMgYSBtdWx0aS1wYWdlIGNvbnRhaW5lciB3aGVyZSBlYWNoIHBhZ2UgY2FuIGJlIHN3aXBlZCBvciBkcmFnZ2VkIGJldHdlZW46CiAqCiAqICFbU2xpZGVCb3hdKGh0dHA6Ly9pb25pY2ZyYW1ld29yay5jb20uczMuYW1hem9uYXdzLmNvbS9kb2NzL2NvbnRyb2xsZXJzL3NsaWRlQm94LmdpZikKICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi1zbGlkZS1ib3ggb24tc2xpZGUtY2hhbmdlZD0ic2xpZGVIYXNDaGFuZ2VkKCRpbmRleCkiPgogKiAgIDxpb24tc2xpZGU+CiAqICAgICA8ZGl2IGNsYXNzPSJib3ggYmx1ZSI+PGgxPkJMVUU8L2gxPjwvZGl2PgogKiAgIDwvaW9uLXNsaWRlPgogKiAgIDxpb24tc2xpZGU+CiAqICAgICA8ZGl2IGNsYXNzPSJib3ggeWVsbG93Ij48aDE+WUVMTE9XPC9oMT48L2Rpdj4KICogICA8L2lvbi1zbGlkZT4KICogICA8aW9uLXNsaWRlPgogKiAgICAgPGRpdiBjbGFzcz0iYm94IHBpbmsiPjxoMT5QSU5LPC9oMT48L2Rpdj4KICogICA8L2lvbi1zbGlkZT4KICogPC9pb24tc2xpZGUtYm94PgogKiBgYGAKICoKICogQHBhcmFtIHtzdHJpbmc9fSBkZWxlZ2F0ZS1oYW5kbGUgVGhlIGhhbmRsZSB1c2VkIHRvIGlkZW50aWZ5IHRoaXMgc2xpZGVCb3gKICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTbGlkZUJveERlbGVnYXRlfS4KICogQHBhcmFtIHtib29sZWFuPX0gZG9lcy1jb250aW51ZSBXaGV0aGVyIHRoZSBzbGlkZSBib3ggc2hvdWxkIGxvb3AuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGF1dG8tcGxheSBXaGV0aGVyIHRoZSBzbGlkZSBib3ggc2hvdWxkIGF1dG9tYXRpY2FsbHkgc2xpZGUuIERlZmF1bHQgdHJ1ZSBpZiBkb2VzLWNvbnRpbnVlIGlzIHRydWUuCiAqIEBwYXJhbSB7bnVtYmVyPX0gc2xpZGUtaW50ZXJ2YWwgSG93IG1hbnkgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdG8gY2hhbmdlIHNsaWRlcyAoaWYgZG9lcy1jb250aW51ZSBpcyB0cnVlKS4gRGVmYXVsdHMgdG8gNDAwMC4KICogQHBhcmFtIHtib29sZWFuPX0gc2hvdy1wYWdlciBXaGV0aGVyIGEgcGFnZXIgc2hvdWxkIGJlIHNob3duIGZvciB0aGlzIHNsaWRlIGJveC4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gcGFnZXItY2xpY2sgRXhwcmVzc2lvbiB0byBjYWxsIHdoZW4gYSBwYWdlciBpcyBjbGlja2VkIChpZiBzaG93LXBhZ2VyIGlzIHRydWUpLiBJcyBwYXNzZWQgdGhlICdpbmRleCcgdmFyaWFibGUuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNsaWRlLWNoYW5nZWQgRXhwcmVzc2lvbiBjYWxsZWQgd2hlbmV2ZXIgdGhlIHNsaWRlIGlzIGNoYW5nZWQuICBJcyBwYXNzZWQgYW4gJyRpbmRleCcgdmFyaWFibGUuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IGFjdGl2ZS1zbGlkZSBNb2RlbCB0byBiaW5kIHRoZSBjdXJyZW50IHNsaWRlIHRvLgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uU2xpZGVCb3gnLCBbCiAgJyR0aW1lb3V0JywKICAnJGNvbXBpbGUnLAogICckaW9uaWNTbGlkZUJveERlbGVnYXRlJywKZnVuY3Rpb24oJHRpbWVvdXQsICRjb21waWxlLCAkaW9uaWNTbGlkZUJveERlbGVnYXRlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXBsYWNlOiB0cnVlLAogICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgIHNjb3BlOiB7CiAgICAgIGF1dG9QbGF5OiAnPScsCiAgICAgIGRvZXNDb250aW51ZTogJ0AnLAogICAgICBzbGlkZUludGVydmFsOiAnQCcsCiAgICAgIHNob3dQYWdlcjogJ0AnLAogICAgICBwYWdlckNsaWNrOiAnJicsCiAgICAgIGRpc2FibGVTY3JvbGw6ICdAJywKICAgICAgb25TbGlkZUNoYW5nZWQ6ICcmJywKICAgICAgYWN0aXZlU2xpZGU6ICc9PycKICAgIH0sCiAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsICckYXR0cnMnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBjb250aW51b3VzID0gJHNjb3BlLiRldmFsKCRzY29wZS5kb2VzQ29udGludWUpID09PSB0cnVlOwogICAgICB2YXIgc2hvdWxkQXV0b1BsYXkgPSBpc0RlZmluZWQoJGF0dHJzLmF1dG9QbGF5KSA/ICEhJHNjb3BlLmF1dG9QbGF5IDogZmFsc2U7CiAgICAgIHZhciBzbGlkZUludGVydmFsID0gc2hvdWxkQXV0b1BsYXkgPyAkc2NvcGUuJGV2YWwoJHNjb3BlLnNsaWRlSW50ZXJ2YWwpIHx8IDQwMDAgOiAwOwoKICAgICAgdmFyIHNsaWRlciA9IG5ldyBpb25pYy52aWV3cy5TbGlkZXIoewogICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICBhdXRvOiBzbGlkZUludGVydmFsLAogICAgICAgIGNvbnRpbnVvdXM6IGNvbnRpbnVvdXMsCiAgICAgICAgc3RhcnRTbGlkZTogJHNjb3BlLmFjdGl2ZVNsaWRlLAogICAgICAgIHNsaWRlc0NoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgJHNjb3BlLmN1cnJlbnRTbGlkZSA9IHNsaWRlci5jdXJyZW50SW5kZXgoKTsKCiAgICAgICAgICAvLyBUcnkgdG8gdHJpZ2dlciBhIGRpZ2VzdAogICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7fSk7CiAgICAgICAgfSwKICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oc2xpZGVJbmRleCkgewogICAgICAgICAgJHNjb3BlLmN1cnJlbnRTbGlkZSA9IHNsaWRlSW5kZXg7CiAgICAgICAgICAkc2NvcGUub25TbGlkZUNoYW5nZWQoeyBpbmRleDogJHNjb3BlLmN1cnJlbnRTbGlkZSwgJGluZGV4OiAkc2NvcGUuY3VycmVudFNsaWRlfSk7CiAgICAgICAgICAkc2NvcGUuJHBhcmVudC4kYnJvYWRjYXN0KCdzbGlkZUJveC5zbGlkZUNoYW5nZWQnLCBzbGlkZUluZGV4KTsKICAgICAgICAgICRzY29wZS5hY3RpdmVTbGlkZSA9IHNsaWRlSW5kZXg7CiAgICAgICAgICAvLyBUcnkgdG8gdHJpZ2dlciBhIGRpZ2VzdAogICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7fSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHNsaWRlci5lbmFibGVTbGlkZSgkc2NvcGUuJGV2YWwoJGF0dHJzLmRpc2FibGVTY3JvbGwpICE9PSB0cnVlKTsKCiAgICAgICRzY29wZS4kd2F0Y2goJ2FjdGl2ZVNsaWRlJywgZnVuY3Rpb24obnYpIHsKICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChudikpewogICAgICAgICAgc2xpZGVyLnNsaWRlKG52KTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgJHNjb3BlLiRvbignc2xpZGVCb3gubmV4dFNsaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2xpZGVyLm5leHQoKTsKICAgICAgfSk7CgogICAgICAkc2NvcGUuJG9uKCdzbGlkZUJveC5wcmV2U2xpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICBzbGlkZXIucHJldigpOwogICAgICB9KTsKCiAgICAgICRzY29wZS4kb24oJ3NsaWRlQm94LnNldFNsaWRlJywgZnVuY3Rpb24oZSwgaW5kZXgpIHsKICAgICAgICBzbGlkZXIuc2xpZGUoaW5kZXgpOwogICAgICB9KTsKCiAgICAgIC8vRXhwb3NlZCBmb3IgdGVzdGluZwogICAgICB0aGlzLl9fc2xpZGVyID0gc2xpZGVyOwoKICAgICAgdmFyIGRlcmVnaXN0ZXJJbnN0YW5jZSA9ICRpb25pY1NsaWRlQm94RGVsZWdhdGUuX3JlZ2lzdGVySW5zdGFuY2Uoc2xpZGVyLCAkYXR0cnMuZGVsZWdhdGVIYW5kbGUpOwogICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGRlcmVnaXN0ZXJJbnN0YW5jZSk7CgogICAgICB0aGlzLnNsaWRlc0NvdW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNsaWRlci5zbGlkZXNDb3VudCgpOwogICAgICB9OwoKICAgICAgdGhpcy5vblBhZ2VyQ2xpY2sgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgIHZvaWQgMDsKICAgICAgICAkc2NvcGUucGFnZXJDbGljayh7aW5kZXg6IGluZGV4fSk7CiAgICAgIH07CgogICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBzbGlkZXIubG9hZCgpOwogICAgICB9KTsKICAgIH1dLAogICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPSJzbGlkZXIiPicgKwogICAgICAnPGRpdiBjbGFzcz0ic2xpZGVyLXNsaWRlcyIgbmctdHJhbnNjbHVkZT4nICsKICAgICAgJzwvZGl2PicgKwogICAgJzwvZGl2PicsCgogICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNsaWRlQm94Q3RybCkgewogICAgICAvLyBJZiB0aGUgcGFnZXIgc2hvdWxkIHNob3csIGFwcGVuZCBpdCB0byB0aGUgc2xpZGUgYm94CiAgICAgIGlmKCRzY29wZS4kZXZhbCgkc2NvcGUuc2hvd1BhZ2VyKSAhPT0gZmFsc2UpIHsKICAgICAgICB2YXIgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgdmFyIHBhZ2VyID0ganFMaXRlKCc8aW9uLXBhZ2VyPjwvaW9uLXBhZ2VyPicpOwogICAgICAgICRlbGVtZW50LmFwcGVuZChwYWdlcik7CiAgICAgICAgJGNvbXBpbGUocGFnZXIpKGNoaWxkU2NvcGUpOwogICAgICB9CiAgICB9CiAgfTsKfV0pCi5kaXJlY3RpdmUoJ2lvblNsaWRlJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiAnXmlvblNsaWRlQm94JywKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgZWxlbWVudC5hZGRDbGFzcygnc2xpZGVyLXNsaWRlJyk7CiAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICB9OwogICAgfSwKICB9Owp9KQoKLmRpcmVjdGl2ZSgnaW9uUGFnZXInLCBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcGxhY2U6IHRydWUsCiAgICByZXF1aXJlOiAnXmlvblNsaWRlQm94JywKICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0ic2xpZGVyLXBhZ2VyIj48c3BhbiBjbGFzcz0ic2xpZGVyLXBhZ2VyLXBhZ2UiIG5nLXJlcGVhdD0ic2xpZGUgaW4gbnVtU2xpZGVzKCkgdHJhY2sgYnkgJGluZGV4IiBuZy1jbGFzcz0ie2FjdGl2ZTogJGluZGV4ID09IGN1cnJlbnRTbGlkZX0iIG5nLWNsaWNrPSJwYWdlckNsaWNrKCRpbmRleCkiPjxpIGNsYXNzPSJpY29uIGlvbi1yZWNvcmQiPjwvaT48L3NwYW4+PC9kaXY+JywKICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBzbGlkZUJveCkgewogICAgICB2YXIgc2VsZWN0UGFnZSA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgdmFyIGNoaWxkcmVuID0gJGVsZW1lbnRbMF0uY2hpbGRyZW47CiAgICAgICAgdmFyIGxlbmd0aCA9IGNoaWxkcmVuLmxlbmd0aDsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmKGkgPT0gaW5kZXgpIHsKICAgICAgICAgICAgY2hpbGRyZW5baV0uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGlsZHJlbltpXS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgogICAgICAkc2NvcGUucGFnZXJDbGljayA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgc2xpZGVCb3gub25QYWdlckNsaWNrKGluZGV4KTsKICAgICAgfTsKCiAgICAgICRzY29wZS5udW1TbGlkZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFycmF5KHNsaWRlQm94LnNsaWRlc0NvdW50KCkpOwogICAgICB9OwoKICAgICAgJHNjb3BlLiR3YXRjaCgnY3VycmVudFNsaWRlJywgZnVuY3Rpb24odikgewogICAgICAgIHNlbGVjdFBhZ2Uodik7CiAgICAgIH0pOwogICAgfQogIH07Cgp9KTsKCklvbmljTW9kdWxlLmNvbnN0YW50KCckaW9uaWNUYWJDb25maWcnLCB7CiAgdHlwZTogJycKfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25UYWIKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25UYWJzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDb250YWlucyBhIHRhYidzIGNvbnRlbnQuICBUaGUgY29udGVudCBvbmx5IGV4aXN0cyB3aGlsZSB0aGUgZ2l2ZW4gdGFiIGlzIHNlbGVjdGVkLgogKgogKiBFYWNoIGlvblRhYiBoYXMgaXRzIG93biB2aWV3IGhpc3RvcnkuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxpb24tdGFiCiAqICAgdGl0bGU9IlRhYiEiCiAqICAgaWNvbj0ibXktaWNvbiIKICogICBocmVmPSIjL3RhYi90YWItbGluayIKICogICBvbi1zZWxlY3Q9Im9uVGFiU2VsZWN0ZWQoKSIKICogICBvbi1kZXNlbGVjdD0ib25UYWJEZXNlbGVjdGVkKCkiPgogKiA8L2lvbi10YWI+CiAqIGBgYAogKiBGb3IgYSBjb21wbGV0ZSwgd29ya2luZyB0YWIgYmFyIGV4YW1wbGUsIHNlZSB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25UYWJzfSBkb2N1bWVudGF0aW9uLgogKgogKiBAcGFyYW0ge3N0cmluZ30gdGl0bGUgVGhlIHRpdGxlIG9mIHRoZSB0YWIuCiAqIEBwYXJhbSB7c3RyaW5nPX0gaHJlZiBUaGUgbGluayB0aGF0IHRoaXMgdGFiIHdpbGwgbmF2aWdhdGUgdG8gd2hlbiB0YXBwZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gaWNvbiBUaGUgaWNvbiBvZiB0aGUgdGFiLiBJZiBnaXZlbiwgdGhpcyB3aWxsIGJlY29tZSB0aGUgZGVmYXVsdCBmb3IgaWNvbi1vbiBhbmQgaWNvbi1vZmYuCiAqIEBwYXJhbSB7c3RyaW5nPX0gaWNvbi1vbiBUaGUgaWNvbiBvZiB0aGUgdGFiIHdoaWxlIGl0IGlzIHNlbGVjdGVkLgogKiBAcGFyYW0ge3N0cmluZz19IGljb24tb2ZmIFRoZSBpY29uIG9mIHRoZSB0YWIgd2hpbGUgaXQgaXMgbm90IHNlbGVjdGVkLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBiYWRnZSBUaGUgYmFkZ2UgdG8gcHV0IG9uIHRoaXMgdGFiICh1c3VhbGx5IGEgbnVtYmVyKS4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gYmFkZ2Utc3R5bGUgVGhlIHN0eWxlIG9mIGJhZGdlIHRvIHB1dCBvbiB0aGlzIHRhYiAoZWcgdGFicy1wb3NpdGl2ZSkuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNlbGVjdCBDYWxsZWQgd2hlbiB0aGlzIHRhYiBpcyBzZWxlY3RlZC4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tZGVzZWxlY3QgQ2FsbGVkIHdoZW4gdGhpcyB0YWIgaXMgZGVzZWxlY3RlZC4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gbmctY2xpY2sgQnkgZGVmYXVsdCwgdGhlIHRhYiB3aWxsIGJlIHNlbGVjdGVkIG9uIGNsaWNrLiBJZiBuZ0NsaWNrIGlzIHNldCwgaXQgd2lsbCBub3QuICBZb3UgY2FuIGV4cGxpY2l0bHkgc3dpdGNoIHRhYnMgdXNpbmcge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljVGFic0RlbGVnYXRlI3NlbGVjdCAkaW9uaWNUYWJzRGVsZWdhdGUuc2VsZWN0KCl9LgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uVGFiJywgWwogICckcm9vdFNjb3BlJywKICAnJGFuaW1hdGUnLAogICckaW9uaWNCaW5kJywKICAnJGNvbXBpbGUnLApmdW5jdGlvbigkcm9vdFNjb3BlLCAkYW5pbWF0ZSwgJGlvbmljQmluZCwgJGNvbXBpbGUpIHsKCiAgLy9SZXR1cm5zICcga2V5PSJ2YWx1ZSInIGlmIHZhbHVlIGV4aXN0cwogIGZ1bmN0aW9uIGF0dHJTdHIoayx2KSB7CiAgICByZXR1cm4gYW5ndWxhci5pc0RlZmluZWQodikgPyAnICcgKyBrICsgJz0iJyArIHYgKyAnIicgOiAnJzsKICB9CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiBbJ15pb25UYWJzJywgJ2lvblRhYiddLAogICAgcmVwbGFjZTogdHJ1ZSwKICAgIGNvbnRyb2xsZXI6ICckaW9uaWNUYWInLAogICAgc2NvcGU6IHRydWUsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CgogICAgICAvL1dlIGNyZWF0ZSB0aGUgdGFiTmF2VGVtcGxhdGUgaW4gdGhlIGNvbXBpbGUgcGhhc2Ugc28gdGhhdCB0aGUKICAgICAgLy9hdHRyaWJ1dGVzIHdlIHBhc3MgZG93biB3b24ndCBiZSBpbnRlcnBvbGF0ZWQgeWV0IC0gd2Ugd2FudAogICAgICAvL3RvIHBhc3MgZG93biB0aGUgJ3JhdycgdmVyc2lvbnMgb2YgdGhlIGF0dHJpYnV0ZXMKICAgICAgdmFyIHRhYk5hdlRlbXBsYXRlID0gJzxpb24tdGFiLW5hdicgKwogICAgICAgIGF0dHJTdHIoJ25nLWNsaWNrJywgYXR0ci5uZ0NsaWNrKSArCiAgICAgICAgYXR0clN0cigndGl0bGUnLCBhdHRyLnRpdGxlKSArCiAgICAgICAgYXR0clN0cignaWNvbicsIGF0dHIuaWNvbikgKwogICAgICAgIGF0dHJTdHIoJ2ljb24tb24nLCBhdHRyLmljb25PbikgKwogICAgICAgIGF0dHJTdHIoJ2ljb24tb2ZmJywgYXR0ci5pY29uT2ZmKSArCiAgICAgICAgYXR0clN0cignYmFkZ2UnLCBhdHRyLmJhZGdlKSArCiAgICAgICAgYXR0clN0cignYmFkZ2Utc3R5bGUnLCBhdHRyLmJhZGdlU3R5bGUpICsKICAgICAgICBhdHRyU3RyKCdoaWRkZW4nLCBhdHRyLmhpZGRlbikgKwogICAgICAgIGF0dHJTdHIoJ2NsYXNzJywgYXR0clsnY2xhc3MnXSkgKwogICAgICAgICc+PC9pb24tdGFiLW5hdj4nOwoKICAgICAgLy9SZW1vdmUgdGhlIGNvbnRlbnRzIG9mIHRoZSBlbGVtZW50IHNvIHdlIGNhbiBjb21waWxlIHRoZW0gbGF0ZXIsIGlmIHRhYiBpcyBzZWxlY3RlZAogICAgICAvL1dlIGRvbid0IHVzZSByZWd1bGFyIHRyYW5zY2x1c2lvbiBiZWNhdXNlIGl0IGJyZWFrcyBlbGVtZW50IGluaGVyaXRhbmNlCiAgICAgIHZhciB0YWJDb250ZW50ID0ganFMaXRlKCc8ZGl2IGNsYXNzPSJwYW5lIj4nKQogICAgICAgIC5hcHBlbmQoIGVsZW1lbnQuY29udGVudHMoKS5yZW1vdmUoKSApOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmxzKSB7CiAgICAgICAgdmFyIGNoaWxkU2NvcGU7CiAgICAgICAgdmFyIGNoaWxkRWxlbWVudDsKICAgICAgICB2YXIgdGFic0N0cmwgPSBjdHJsc1swXTsKICAgICAgICB2YXIgdGFiQ3RybCA9IGN0cmxzWzFdOwoKICAgICAgICB2YXIgbmF2VmlldyA9IHRhYkNvbnRlbnRbMF0ucXVlcnlTZWxlY3RvcignaW9uLW5hdi12aWV3JykgfHwKICAgICAgICAgIHRhYkNvbnRlbnRbMF0ucXVlcnlTZWxlY3RvcignZGF0YS1pb24tbmF2LXZpZXcnKTsKICAgICAgICB2YXIgbmF2Vmlld05hbWUgPSBuYXZWaWV3ICYmIG5hdlZpZXcuZ2V0QXR0cmlidXRlKCduYW1lJyk7CgogICAgICAgICRpb25pY0JpbmQoJHNjb3BlLCAkYXR0ciwgewogICAgICAgICAgYW5pbWF0ZTogJz0nLAogICAgICAgICAgb25TZWxlY3Q6ICcmJywKICAgICAgICAgIG9uRGVzZWxlY3Q6ICcmJywKICAgICAgICAgIHRpdGxlOiAnQCcsCiAgICAgICAgICB1aVNyZWY6ICdAJywKICAgICAgICAgIGhyZWY6ICdAJywKICAgICAgICB9KTsKCiAgICAgICAgdGFic0N0cmwuYWRkKCRzY29wZSk7CiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHRhYnNDdHJsLnJlbW92ZSgkc2NvcGUpOwogICAgICAgICAgdGFiTmF2RWxlbWVudC5pc29sYXRlU2NvcGUoKS4kZGVzdHJveSgpOwogICAgICAgICAgdGFiTmF2RWxlbWVudC5yZW1vdmUoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy9SZW1vdmUgdGl0bGUgYXR0cmlidXRlIHNvIGJyb3dzZXItdG9vbHRpcCBkb2VzIG5vdCBhcGVhcgogICAgICAgICRlbGVtZW50WzBdLnJlbW92ZUF0dHJpYnV0ZSgndGl0bGUnKTsKCiAgICAgICAgaWYgKG5hdlZpZXdOYW1lKSB7CiAgICAgICAgICB0YWJDdHJsLm5hdlZpZXdOYW1lID0gJHNjb3BlLm5hdlZpZXdOYW1lID0gbmF2Vmlld05hbWU7CiAgICAgICAgfQogICAgICAgICRzY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBzZWxlY3RJZk1hdGNoZXNTdGF0ZSk7CiAgICAgICAgc2VsZWN0SWZNYXRjaGVzU3RhdGUoKTsKICAgICAgICBmdW5jdGlvbiBzZWxlY3RJZk1hdGNoZXNTdGF0ZSgpIHsKICAgICAgICAgIGlmICh0YWJDdHJsLnRhYk1hdGNoZXNTdGF0ZSgpKSB7CiAgICAgICAgICAgIHRhYnNDdHJsLnNlbGVjdCgkc2NvcGUsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciB0YWJOYXZFbGVtZW50ID0ganFMaXRlKHRhYk5hdlRlbXBsYXRlKTsKICAgICAgICB0YWJOYXZFbGVtZW50LmRhdGEoJyRpb25UYWJzQ29udHJvbGxlcicsIHRhYnNDdHJsKTsKICAgICAgICB0YWJOYXZFbGVtZW50LmRhdGEoJyRpb25UYWJDb250cm9sbGVyJywgdGFiQ3RybCk7CiAgICAgICAgdGFic0N0cmwuJHRhYnNFbGVtZW50LmFwcGVuZCgkY29tcGlsZSh0YWJOYXZFbGVtZW50KSgkc2NvcGUpKTsKCiAgICAgICAgJHNjb3BlLiR3YXRjaCgnJHRhYlNlbGVjdGVkJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGNoaWxkU2NvcGUgJiYgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgY2hpbGRTY29wZSA9IG51bGw7CiAgICAgICAgICBjaGlsZEVsZW1lbnQgJiYgJGFuaW1hdGUubGVhdmUoY2hpbGRFbGVtZW50KTsKICAgICAgICAgIGNoaWxkRWxlbWVudCA9IG51bGw7CiAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgICAgIGNoaWxkRWxlbWVudCA9IHRhYkNvbnRlbnQuY2xvbmUoKTsKICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2hpbGRFbGVtZW50LCB0YWJzQ3RybC4kZWxlbWVudCk7CiAgICAgICAgICAgICRjb21waWxlKGNoaWxkRWxlbWVudCkoY2hpbGRTY29wZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICB9OwogICAgfQogIH07Cn1dKTsKCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblRhYk5hdicsIFtmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcGxhY2U6IHRydWUsCiAgICByZXF1aXJlOiBbJ15pb25UYWJzJywgJ15pb25UYWInXSwKICAgIHRlbXBsYXRlOgogICAgJzxhIG5nLWNsYXNzPSJ7XCd0YWItaXRlbS1hY3RpdmVcJzogaXNUYWJBY3RpdmUoKSwgXCdoYXMtYmFkZ2VcJzpiYWRnZSwgXCd0YWItaGlkZGVuXCc6aXNIaWRkZW4oKX0iICcgKwogICAgICAnIGNsYXNzPSJ0YWItaXRlbSI+JyArCiAgICAgICc8c3BhbiBjbGFzcz0iYmFkZ2Uge3tiYWRnZVN0eWxlfX0iIG5nLWlmPSJiYWRnZSI+e3tiYWRnZX19PC9zcGFuPicgKwogICAgICAnPGkgY2xhc3M9Imljb24ge3tnZXRJY29uT24oKX19IiBuZy1pZj0iZ2V0SWNvbk9uKCkgJiYgaXNUYWJBY3RpdmUoKSI+PC9pPicgKwogICAgICAnPGkgY2xhc3M9Imljb24ge3tnZXRJY29uT2ZmKCl9fSIgbmctaWY9ImdldEljb25PZmYoKSAmJiAhaXNUYWJBY3RpdmUoKSI+PC9pPicgKwogICAgICAnPHNwYW4gY2xhc3M9InRhYi10aXRsZSIgbmctYmluZC1odG1sPSJ0aXRsZSI+PC9zcGFuPicgKwogICAgJzwvYT4nLAogICAgc2NvcGU6IHsKICAgICAgdGl0bGU6ICdAJywKICAgICAgaWNvbjogJ0AnLAogICAgICBpY29uT246ICdAJywKICAgICAgaWNvbk9mZjogJ0AnLAogICAgICBiYWRnZTogJz0nLAogICAgICBoaWRkZW46ICdAJywKICAgICAgYmFkZ2VTdHlsZTogJ0AnLAogICAgICAnY2xhc3MnOiAnQCcKICAgIH0sCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyLCB0cmFuc2NsdWRlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgY3RybHMpIHsKICAgICAgICB2YXIgdGFic0N0cmwgPSBjdHJsc1swXSwKICAgICAgICAgIHRhYkN0cmwgPSBjdHJsc1sxXTsKCiAgICAgICAgLy9SZW1vdmUgdGl0bGUgYXR0cmlidXRlIHNvIGJyb3dzZXItdG9vbHRpcCBkb2VzIG5vdCBhcGVhcgogICAgICAgICRlbGVtZW50WzBdLnJlbW92ZUF0dHJpYnV0ZSgndGl0bGUnKTsKCiAgICAgICAgJHNjb3BlLnNlbGVjdFRhYiA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIHRhYnNDdHJsLnNlbGVjdCh0YWJDdHJsLiRzY29wZSwgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBpZiAoISRhdHRycy5uZ0NsaWNrKSB7CiAgICAgICAgICAkZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAkc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRzY29wZS5zZWxlY3RUYWIoZXZlbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgJHNjb3BlLmlzSGlkZGVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZigkYXR0cnMuaGlkZGVuID09PSAndHJ1ZScgfHwgJGF0dHJzLmhpZGRlbiA9PT0gdHJ1ZSlyZXR1cm4gdHJ1ZTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICAkc2NvcGUuZ2V0SWNvbk9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gJHNjb3BlLmljb25PbiB8fCAkc2NvcGUuaWNvbjsKICAgICAgICB9OwogICAgICAgICRzY29wZS5nZXRJY29uT2ZmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gJHNjb3BlLmljb25PZmYgfHwgJHNjb3BlLmljb247CiAgICAgICAgfTsKCiAgICAgICAgJHNjb3BlLmlzVGFiQWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGFic0N0cmwuc2VsZWN0ZWRUYWIoKSA9PT0gdGFiQ3RybC4kc2NvcGU7CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0KICB9Owp9XSk7CgpJb25pY01vZHVsZS5jb25zdGFudCgnJGlvbmljVGFic0NvbmZpZycsIHsKICBwb3NpdGlvbjogJycsCiAgdHlwZTogJycKfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25UYWJzCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljVGFic0RlbGVnYXRlCiAqIEByZXN0cmljdCBFCiAqIEBjb2RlcGVuIEticnpKCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBQb3dlcnMgYSBtdWx0aS10YWJiZWQgaW50ZXJmYWNlIHdpdGggYSBUYWIgQmFyIGFuZCBhIHNldCBvZiAicGFnZXMiIHRoYXQgY2FuIGJlIHRhYmJlZAogKiB0aHJvdWdoLgogKgogKiBBc3NpZ24gYW55IFt0YWJzIGNsYXNzXSgvZG9jcy9jb21wb25lbnRzI3RhYnMpIG9yCiAqIFthbmltYXRpb24gY2xhc3NdKC9kb2NzL2NvbXBvbmVudHMjYW5pbWF0aW9uKSB0byB0aGUgZWxlbWVudCB0byBkZWZpbmUKICogaXRzIGxvb2sgYW5kIGZlZWwuCiAqCiAqIFNlZSB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25UYWJ9IGRpcmVjdGl2ZSdzIGRvY3VtZW50YXRpb24gZm9yIG1vcmUgZGV0YWlscyBvbgogKiBpbmRpdmlkdWFsIHRhYnMuCiAqCiAqIE5vdGU6IGRvIG5vdCBwbGFjZSBpb24tdGFicyBpbnNpZGUgb2YgYW4gaW9uLWNvbnRlbnQgZWxlbWVudDsgaXQgaGFzIGJlZW4ga25vd24gdG8gY2F1c2UgYQogKiBjZXJ0YWluIENTUyBidWcuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxpb24tdGFicyBjbGFzcz0idGFicy1wb3NpdGl2ZSB0YWJzLWljb24tb25seSI+CiAqCiAqICAgPGlvbi10YWIgdGl0bGU9IkhvbWUiIGljb24tb249Imlvbi1pb3M3LWZpbGluZyIgaWNvbi1vZmY9Imlvbi1pb3M3LWZpbGluZy1vdXRsaW5lIj4KICogICAgIDwhLS0gVGFiIDEgY29udGVudCAtLT4KICogICA8L2lvbi10YWI+CiAqCiAqICAgPGlvbi10YWIgdGl0bGU9IkFib3V0IiBpY29uLW9uPSJpb24taW9zNy1jbG9jayIgaWNvbi1vZmY9Imlvbi1pb3M3LWNsb2NrLW91dGxpbmUiPgogKiAgICAgPCEtLSBUYWIgMiBjb250ZW50IC0tPgogKiAgIDwvaW9uLXRhYj4KICoKICogICA8aW9uLXRhYiB0aXRsZT0iU2V0dGluZ3MiIGljb24tb249Imlvbi1pb3M3LWdlYXIiIGljb24tb2ZmPSJpb24taW9zNy1nZWFyLW91dGxpbmUiPgogKiAgICAgPCEtLSBUYWIgMyBjb250ZW50IC0tPgogKiAgIDwvaW9uLXRhYj4KICoKICogPC9pb24tdGFicz4KICogYGBgCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGVzZSB0YWJzCiAqIHdpdGgge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljVGFic0RlbGVnYXRlfS4KICovCgpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25UYWJzJywgWwogICckaW9uaWNWaWV3U2VydmljZScsIAogICckaW9uaWNUYWJzRGVsZWdhdGUnLCAKICAnJGlvbmljVGFic0NvbmZpZycsIApmdW5jdGlvbigkaW9uaWNWaWV3U2VydmljZSwgJGlvbmljVGFic0RlbGVnYXRlLCAkaW9uaWNUYWJzQ29uZmlnKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBzY29wZTogdHJ1ZSwKICAgIGNvbnRyb2xsZXI6ICckaW9uaWNUYWJzJywKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgZWxlbWVudC5hZGRDbGFzcygndmlldycpOwogICAgICAvL1dlIGNhbm5vdCB1c2UgcmVndWxhciB0cmFuc2NsdWRlIGhlcmUgYmVjYXVzZSBpdCBicmVha3MgZWxlbWVudC5kYXRhKCkKICAgICAgLy9pbmhlcml0YW5jZSBvbiBjb21waWxlCiAgICAgIHZhciBpbm5lckVsZW1lbnQgPSBqcUxpdGUoJzxkaXYgY2xhc3M9InRhYnMiPjwvZGl2PicpOwogICAgICBpbm5lckVsZW1lbnQuYXBwZW5kKGVsZW1lbnQuY29udGVudHMoKSk7CiAgICAgIGVsZW1lbnQuYXBwZW5kKGlubmVyRWxlbWVudCk7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJGlvbmljVGFic0NvbmZpZy5wb3NpdGlvbik7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJGlvbmljVGFic0NvbmZpZy50eXBlKTsKCiAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCB0YWJzQ3RybCkgewogICAgICAgIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNUYWJzRGVsZWdhdGUuX3JlZ2lzdGVySW5zdGFuY2UoCiAgICAgICAgICB0YWJzQ3RybCwgJGF0dHIuZGVsZWdhdGVIYW5kbGUKICAgICAgICApOwoKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGRlcmVnaXN0ZXJJbnN0YW5jZSk7CgogICAgICAgIHRhYnNDdHJsLiRzY29wZSA9ICRzY29wZTsKICAgICAgICB0YWJzQ3RybC4kZWxlbWVudCA9ICRlbGVtZW50OwogICAgICAgIHRhYnNDdHJsLiR0YWJzRWxlbWVudCA9IGpxTGl0ZSgkZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCcudGFicycpKTsKCiAgICAgICAgdmFyIGVsID0gJGVsZW1lbnRbMF07CiAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsgcmV0dXJuIGVsLmNsYXNzTmFtZTsgfSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHZhciBpc1RhYnNUb3AgPSB2YWx1ZS5pbmRleE9mKCd0YWJzLXRvcCcpICE9PSAtMTsKICAgICAgICAgIHZhciBpc0hpZGRlbiA9IHZhbHVlLmluZGV4T2YoJ3RhYnMtaXRlbS1oaWRlJykgIT09IC0xOwogICAgICAgICAgJHNjb3BlLiRoYXNUYWJzID0gIWlzVGFic1RvcCAmJiAhaXNIaWRkZW47CiAgICAgICAgICAkc2NvcGUuJGhhc1RhYnNUb3AgPSBpc1RhYnNUb3AgJiYgIWlzSGlkZGVuOwogICAgICAgIH0pOwogICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNUYWJzOwogICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzVGFic1RvcDsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07Cn1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblRvZ2dsZQogKiBAbW9kdWxlIGlvbmljCiAqIEBjb2RlcGVuIHRmQXpqCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHRvZ2dsZSBpcyBhbiBhbmltYXRlZCBzd2l0Y2ggd2hpY2ggYmluZHMgYSBnaXZlbiBtb2RlbCB0byBhIGJvb2xlYW4uCiAqCiAqIEFsbG93cyBkcmFnZ2luZyBvZiB0aGUgc3dpdGNoJ3MgbnViLgogKgogKiBUaGUgdG9nZ2xlIGJlaGF2ZXMgbGlrZSBhbnkgW0FuZ3VsYXJKUyBjaGVja2JveF0oaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcvaW5wdXQvaW5wdXRbY2hlY2tib3hdKSBvdGhlcndpc2UuCiAqCiAqIEBwYXJhbSB0b2dnbGUtY2xhc3Mge3N0cmluZz19IFNldHMgdGhlIENTUyBjbGFzcyBvbiB0aGUgaW5uZXIgYGxhYmVsLnRvZ2dsZWAgZWxlbWVudCBjcmVhdGVkIGJ5IHRoZSBkaXJlY3RpdmUuCiAqCiAqIEB1c2FnZQogKiBCZWxvdyBpcyBhbiBleGFtcGxlIG9mIGEgdG9nZ2xlIGRpcmVjdGl2ZSB3aGljaCBpcyB3aXJlZCB1cCB0byB0aGUgYGFpcnBsYW5lTW9kZWAgbW9kZWwKICogYW5kIGhhcyB0aGUgYHRvZ2dsZS1jYWxtYCBDU1MgY2xhc3MgYXNzaWduZWQgdG8gdGhlIGlubmVyIGVsZW1lbnQuCiAqCiAqIGBgYGh0bWwKICogPGlvbi10b2dnbGUgbmctbW9kZWw9ImFpcnBsYW5lTW9kZSIgdG9nZ2xlLWNsYXNzPSJ0b2dnbGUtY2FsbSI+QWlycGxhbmUgTW9kZTwvaW9uLXRvZ2dsZT4KICogYGBgCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25Ub2dnbGUnLCBbCiAgJyRpb25pY0dlc3R1cmUnLAogICckdGltZW91dCcsCmZ1bmN0aW9uKCRpb25pY0dlc3R1cmUsICR0aW1lb3V0KSB7CgogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVwbGFjZTogdHJ1ZSwKICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgdGVtcGxhdGU6CiAgICAgICc8ZGl2IGNsYXNzPSJpdGVtIGl0ZW0tdG9nZ2xlIj4nICsKICAgICAgICAnPGRpdiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICc8bGFiZWwgY2xhc3M9InRvZ2dsZSI+JyArCiAgICAgICAgICAnPGlucHV0IHR5cGU9ImNoZWNrYm94Ij4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0cmFjayI+JyArCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJoYW5kbGUiPjwvZGl2PicgKwogICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICc8L2xhYmVsPicgKwogICAgICAnPC9kaXY+JywKCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQuZmluZCgnaW5wdXQnKTsKICAgICAgZm9yRWFjaCh7CiAgICAgICAgJ25hbWUnOiBhdHRyLm5hbWUsCiAgICAgICAgJ25nLXZhbHVlJzogYXR0ci5uZ1ZhbHVlLAogICAgICAgICduZy1tb2RlbCc6IGF0dHIubmdNb2RlbCwKICAgICAgICAnbmctY2hlY2tlZCc6IGF0dHIubmdDaGVja2VkLAogICAgICAgICduZy1kaXNhYmxlZCc6IGF0dHIubmdEaXNhYmxlZCwKICAgICAgICAnbmctdHJ1ZS12YWx1ZSc6IGF0dHIubmdUcnVlVmFsdWUsCiAgICAgICAgJ25nLWZhbHNlLXZhbHVlJzogYXR0ci5uZ0ZhbHNlVmFsdWUsCiAgICAgICAgJ25nLWNoYW5nZSc6IGF0dHIubmdDaGFuZ2UKICAgICAgfSwgZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgaW5wdXQuYXR0cihuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGlmKGF0dHIudG9nZ2xlQ2xhc3MpIHsKICAgICAgICBlbGVtZW50WzBdLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdsYWJlbCcpWzBdLmNsYXNzTGlzdC5hZGQoYXR0ci50b2dnbGVDbGFzcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgICB2YXIgZWwsIGNoZWNrYm94LCB0cmFjaywgaGFuZGxlOwoKICAgICAgICAgZWwgPSAkZWxlbWVudFswXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbGFiZWwnKVswXTsKICAgICAgICAgY2hlY2tib3ggPSBlbC5jaGlsZHJlblswXTsKICAgICAgICAgdHJhY2sgPSBlbC5jaGlsZHJlblsxXTsKICAgICAgICAgaGFuZGxlID0gdHJhY2suY2hpbGRyZW5bMF07CgogICAgICAgICB2YXIgbmdNb2RlbENvbnRyb2xsZXIgPSBqcUxpdGUoY2hlY2tib3gpLmNvbnRyb2xsZXIoJ25nTW9kZWwnKTsKCiAgICAgICAgICRzY29wZS50b2dnbGUgPSBuZXcgaW9uaWMudmlld3MuVG9nZ2xlKHsKICAgICAgICAgICBlbDogZWwsCiAgICAgICAgICAgdHJhY2s6IHRyYWNrLAogICAgICAgICAgIGNoZWNrYm94OiBjaGVja2JveCwKICAgICAgICAgICBoYW5kbGU6IGhhbmRsZSwKICAgICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBpZihjaGVja2JveC5jaGVja2VkKSB7CiAgICAgICAgICAgICAgIG5nTW9kZWxDb250cm9sbGVyLiRzZXRWaWV3VmFsdWUodHJ1ZSk7CiAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICBuZ01vZGVsQ29udHJvbGxlci4kc2V0Vmlld1ZhbHVlKGZhbHNlKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgICRzY29wZS4kYXBwbHkoKTsKICAgICAgICAgICB9CiAgICAgICAgIH0pOwoKICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAkc2NvcGUudG9nZ2xlLmRlc3Ryb3koKTsKICAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CgogIH07Cn1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblZpZXcKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAcGFyZW50IGlvbk5hdlZpZXcKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgY29udGFpbmVyIGZvciBjb250ZW50LCB1c2VkIHRvIHRlbGwgYSBwYXJlbnQge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9CiAqIGFib3V0IHRoZSBjdXJyZW50IHZpZXcuCiAqCiAqIEB1c2FnZQogKiBCZWxvdyBpcyBhbiBleGFtcGxlIHdoZXJlIG91ciBwYWdlIHdpbGwgbG9hZCB3aXRoIGEgbmF2YmFyIGNvbnRhaW5pbmcgIk15IFBhZ2UiIGFzIHRoZSB0aXRsZS4KICoKICogYGBgaHRtbAogKiA8aW9uLW5hdi1iYXI+PC9pb24tbmF2LWJhcj4KICogPGlvbi1uYXYtdmlldyBjbGFzcz0ic2xpZGUtbGVmdC1yaWdodCI+CiAqICAgPGlvbi12aWV3IHRpdGxlPSJNeSBQYWdlIj4KICogICAgIDxpb24tY29udGVudD4KICogICAgICAgSGVsbG8hCiAqICAgICA8L2lvbi1jb250ZW50PgogKiAgIDwvaW9uLXZpZXc+CiAqIDwvaW9uLW5hdi12aWV3PgogKiBgYGAKICoKICogQHBhcmFtIHtzdHJpbmc9fSB0aXRsZSBUaGUgdGl0bGUgdG8gZGlzcGxheSBvbiB0aGUgcGFyZW50IHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfS4KICogQHBhcmFtIHtib29sZWFuPX0gaGlkZS1iYWNrLWJ1dHRvbiBXaGV0aGVyIHRvIGhpZGUgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBwYXJlbnQKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9IGJ5IGRlZmF1bHQuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGhpZGUtbmF2LWJhciBXaGV0aGVyIHRvIGhpZGUgdGhlIHBhcmVudAogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gYnkgZGVmYXVsdC4KICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblZpZXcnLCBbJyRpb25pY1ZpZXdTZXJ2aWNlJywgJyRyb290U2NvcGUnLCAnJGFuaW1hdGUnLAogICAgICAgICAgIGZ1bmN0aW9uKCAkaW9uaWNWaWV3U2VydmljZSwgICAkcm9vdFNjb3BlLCAgICRhbmltYXRlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRUEnLAogICAgcHJpb3JpdHk6IDEwMDAsCiAgICByZXF1aXJlOiBbJ14/aW9uTmF2QmFyJywgJ14/aW9uTW9kYWwnXSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpIHsKICAgICAgdEVsZW1lbnQuYWRkQ2xhc3MoJ3BhbmUnKTsKICAgICAgdEVsZW1lbnRbMF0ucmVtb3ZlQXR0cmlidXRlKCd0aXRsZScpOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmxzKSB7CiAgICAgICAgdmFyIG5hdkJhckN0cmwgPSBjdHJsc1swXTsKICAgICAgICB2YXIgbW9kYWxDdHJsID0gY3RybHNbMV07CgogICAgICAgIC8vRG9uJ3QgdXNlIHRoZSBpb25WaWV3IGlmIHdlJ3JlIGluc2lkZSBhIG1vZGFsIG9yIHRoZXJlJ3Mgbm8gbmF2YmFyCiAgICAgICAgaWYgKCFuYXZCYXJDdHJsIHx8IG1vZGFsQ3RybCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLnRpdGxlKSkgewoKICAgICAgICAgIHZhciBpbml0aWFsVGl0bGUgPSAkYXR0ci50aXRsZTsKICAgICAgICAgIG5hdkJhckN0cmwuY2hhbmdlVGl0bGUoaW5pdGlhbFRpdGxlLCAkc2NvcGUuJG5hdkRpcmVjdGlvbik7CgogICAgICAgICAgLy8gd2F0Y2ggZm9yIGNoYW5nZXMgaW4gdGhlIHRpdGxlLCBkb24ndCBzZXQgaW5pdGlhbCB2YWx1ZSBhcyBjaGFuZ2VUaXRsZSBkb2VzIHRoYXQKICAgICAgICAgICRhdHRyLiRvYnNlcnZlKCd0aXRsZScsIGZ1bmN0aW9uKHZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgIG5hdkJhckN0cmwuc2V0VGl0bGUodmFsKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIGhpZGVCYWNrQXR0ciA9IGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLmhpZGVCYWNrQnV0dG9uKSA/CiAgICAgICAgICAkYXR0ci5oaWRlQmFja0J1dHRvbiA6CiAgICAgICAgICAnZmFsc2UnOwogICAgICAgICRzY29wZS4kd2F0Y2goaGlkZUJhY2tBdHRyLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgLy8gU2hvdWxkIHdlIGhpZGUgYSBiYWNrIGJ1dHRvbiB3aGVuIHRoaXMgdGFiIGlzIHNob3duCiAgICAgICAgICBuYXZCYXJDdHJsLnNob3dCYWNrQnV0dG9uKCF2YWx1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBoaWRlTmF2QXR0ciA9IGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLmhpZGVOYXZCYXIpID8KICAgICAgICAgICRhdHRyLmhpZGVOYXZCYXIgOgogICAgICAgICAgJ2ZhbHNlJzsKICAgICAgICAkc2NvcGUuJHdhdGNoKGhpZGVOYXZBdHRyLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgLy8gU2hvdWxkIHRoZSBuYXYgYmFyIGJlIGhpZGRlbiBmb3IgdGhpcyB2aWV3IG9yIG5vdD8KICAgICAgICAgIG5hdkJhckN0cmwuc2hvd0JhcighdmFsdWUpOwogICAgICAgIH0pOwoKICAgICAgfTsKICAgIH0KICB9Owp9XSk7CgohZnVuY3Rpb24oZSl7aWYoIm9iamVjdCI9PXR5cGVvZiBleHBvcnRzJiYidW5kZWZpbmVkIiE9dHlwZW9mIG1vZHVsZSltb2R1bGUuZXhwb3J0cz1lKCk7ZWxzZSBpZigiZnVuY3Rpb24iPT10eXBlb2YgZGVmaW5lJiZkZWZpbmUuYW1kKWRlZmluZShbXSxlKTtlbHNle3ZhciBmOyJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93P2Y9d2luZG93OiJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsP2Y9Z2xvYmFsOiJ1bmRlZmluZWQiIT10eXBlb2Ygc2VsZiYmKGY9c2VsZiksZi5jb2xsaWRlPWUoKX19KGZ1bmN0aW9uKCl7dmFyIGRlZmluZSxtb2R1bGUsZXhwb3J0cztyZXR1cm4gKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIrbysiJyIpfXZhciBmPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChmLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGYsZi5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsKLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjYuMwooZnVuY3Rpb24oKSB7CiAgdmFyIGdldE5hbm9TZWNvbmRzLCBocnRpbWUsIGxvYWRUaW1lOwoKICBpZiAoKHR5cGVvZiBwZXJmb3JtYW5jZSAhPT0gInVuZGVmaW5lZCIgJiYgcGVyZm9ybWFuY2UgIT09IG51bGwpICYmIHBlcmZvcm1hbmNlLm5vdykgewogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlLm5vdygpOwogICAgfTsKICB9IGVsc2UgaWYgKCh0eXBlb2YgcHJvY2VzcyAhPT0gInVuZGVmaW5lZCIgJiYgcHJvY2VzcyAhPT0gbnVsbCkgJiYgcHJvY2Vzcy5ocnRpbWUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAoZ2V0TmFub1NlY29uZHMoKSAtIGxvYWRUaW1lKSAvIDFlNjsKICAgIH07CiAgICBocnRpbWUgPSBwcm9jZXNzLmhydGltZTsKICAgIGdldE5hbm9TZWNvbmRzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBocjsKICAgICAgaHIgPSBocnRpbWUoKTsKICAgICAgcmV0dXJuIGhyWzBdICogMWU5ICsgaHJbMV07CiAgICB9OwogICAgbG9hZFRpbWUgPSBnZXROYW5vU2Vjb25kcygpOwogIH0gZWxzZSBpZiAoRGF0ZS5ub3cpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBEYXRlLm5vdygpIC0gbG9hZFRpbWU7CiAgICB9OwogICAgbG9hZFRpbWUgPSBEYXRlLm5vdygpOwogIH0gZWxzZSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBsb2FkVGltZTsKICAgIH07CiAgICBsb2FkVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH0KCn0pLmNhbGwodGhpcyk7CgovKgovL0Agc291cmNlTWFwcGluZ1VSTD1wZXJmb3JtYW5jZS1ub3cubWFwCiovCgp9KS5jYWxsKHRoaXMsX2RlcmVxXygicWhESVJUIikpCn0seyJxaERJUlQiOjEzfV0sMjpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7CnZhciBub3cgPSBfZGVyZXFfKCdwZXJmb3JtYW5jZS1ub3cnKQogICwgZ2xvYmFsID0gdHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcgPyB7fSA6IHdpbmRvdwogICwgdmVuZG9ycyA9IFsnbW96JywgJ3dlYmtpdCddCiAgLCBzdWZmaXggPSAnQW5pbWF0aW9uRnJhbWUnCiAgLCByYWYgPSBnbG9iYWxbJ3JlcXVlc3QnICsgc3VmZml4XQogICwgY2FmID0gZ2xvYmFsWydjYW5jZWwnICsgc3VmZml4XSB8fCBnbG9iYWxbJ2NhbmNlbFJlcXVlc3QnICsgc3VmZml4XQoKZm9yKHZhciBpID0gMDsgaSA8IHZlbmRvcnMubGVuZ3RoICYmICFyYWY7IGkrKykgewogIHJhZiA9IGdsb2JhbFt2ZW5kb3JzW2ldICsgJ1JlcXVlc3QnICsgc3VmZml4XQogIGNhZiA9IGdsb2JhbFt2ZW5kb3JzW2ldICsgJ0NhbmNlbCcgKyBzdWZmaXhdCiAgICAgIHx8IGdsb2JhbFt2ZW5kb3JzW2ldICsgJ0NhbmNlbFJlcXVlc3QnICsgc3VmZml4XQp9CgovLyBTb21lIHZlcnNpb25zIG9mIEZGIGhhdmUgckFGIGJ1dCBub3QgY0FGCmlmKCFyYWYgfHwgIWNhZikgewogIHZhciBsYXN0ID0gMAogICAgLCBpZCA9IDAKICAgICwgcXVldWUgPSBbXQogICAgLCBmcmFtZUR1cmF0aW9uID0gMTAwMCAvIDYwCgogIHJhZiA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICBpZihxdWV1ZS5sZW5ndGggPT09IDApIHsKICAgICAgdmFyIF9ub3cgPSBub3coKQogICAgICAgICwgbmV4dCA9IE1hdGgubWF4KDAsIGZyYW1lRHVyYXRpb24gLSAoX25vdyAtIGxhc3QpKQogICAgICBsYXN0ID0gbmV4dCArIF9ub3cKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY3AgPSBxdWV1ZS5zbGljZSgwKQogICAgICAgIC8vIENsZWFyIHF1ZXVlIGhlcmUgdG8gcHJldmVudAogICAgICAgIC8vIGNhbGxiYWNrcyBmcm9tIGFwcGVuZGluZyBsaXN0ZW5lcnMKICAgICAgICAvLyB0byB0aGUgY3VycmVudCBmcmFtZSdzIHF1ZXVlCiAgICAgICAgcXVldWUubGVuZ3RoID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY3AubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghY3BbaV0uY2FuY2VsbGVkKSB7CiAgICAgICAgICAgIGNwW2ldLmNhbGxiYWNrKGxhc3QpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBuZXh0KQogICAgfQogICAgcXVldWUucHVzaCh7CiAgICAgIGhhbmRsZTogKytpZCwKICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICBjYW5jZWxsZWQ6IGZhbHNlCiAgICB9KQogICAgcmV0dXJuIGlkCiAgfQoKICBjYWYgPSBmdW5jdGlvbihoYW5kbGUpIHsKICAgIGZvcih2YXIgaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICBpZihxdWV1ZVtpXS5oYW5kbGUgPT09IGhhbmRsZSkgewogICAgICAgIHF1ZXVlW2ldLmNhbmNlbGxlZCA9IHRydWUKICAgICAgfQogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHsKICAvLyBXcmFwIGluIGEgbmV3IGZ1bmN0aW9uIHRvIHByZXZlbnQKICAvLyBgY2FuY2VsYCBwb3RlbnRpYWxseSBiZWluZyBhc3NpZ25lZAogIC8vIHRvIHRoZSBuYXRpdmUgckFGIGZ1bmN0aW9uCiAgcmV0dXJuIHJhZi5hcHBseShnbG9iYWwsIGFyZ3VtZW50cykKfQptb2R1bGUuZXhwb3J0cy5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICBjYWYuYXBwbHkoZ2xvYmFsLCBhcmd1bWVudHMpCn0KCn0seyJwZXJmb3JtYW5jZS1ub3ciOjN9XSwzOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9X2RlcmVxXygxKQp9LHsicWhESVJUIjoxM31dLDQ6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewoKLy8gSW50ZXJwb2xhdGlvbiBkaXNhYmxlZCBmb3Igbm93Ci8vIHZhciBpbnRlcnBvbGF0ZSA9IHJlcXVpcmUoJy4vY29yZS9pbnRlcnBvbGF0ZScpOwovLyB2YXIgY3NzRmVhdHVyZSA9IHJlcXVpcmUoJ2ZlYXR1cmUvY3NzJyk7Cgp2YXIgdGltZWxpbmUgPSBfZGVyZXFfKCcuL2NvcmUvdGltZWxpbmUnKTsKdmFyIGR5bmFtaWNzID0gX2RlcmVxXygnLi9jb3JlL2R5bmFtaWNzJyk7CnZhciBlYXNpbmdGdW5jdGlvbnMgPSBfZGVyZXFfKCcuL2NvcmUvZWFzaW5nLWZ1bmN0aW9ucycpOwoKdmFyIHVpZCA9IF9kZXJlcV8oJy4vdXRpbC91aWQnKTsKdmFyIEV2ZW50RW1pdHRlciA9IF9kZXJlcV8oJy4vdXRpbC9zaW1wbGUtZW1pdHRlcicpOwoKZnVuY3Rpb24gY2xhbXAobWluLCBuLCBtYXgpIHsgcmV0dXJuIE1hdGgubWF4KG1pbiwgTWF0aC5taW4obiwgbWF4KSk7IH0KCm1vZHVsZS5leHBvcnRzID0gQW5pbWF0b3I7CgpmdW5jdGlvbiBBbmltYXRvcihvcHRzKSB7CiAgLy9pZiBgbmV3YCBrZXl3b3JkIGlzbid0IHByb3ZpZGVkLCBkbyBpdCBmb3IgdXNlcgogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBBbmltYXRvcikpIHsKICAgIHJldHVybiBuZXcgQW5pbWF0b3Iob3B0cyk7CiAgfQoKICBvcHRzID0gb3B0cyB8fCB7fTsKCiAgLy9Qcml2YXRlIHN0YXRlIGdvZXMgaW4gdGhpcy5fCiAgdGhpcy5fID0gewogICAgaWQ6IHVpZCgpLAogICAgcGVyY2VudDogMCwKICAgIGR1cmF0aW9uOiA1MDAsCiAgICBpc1JldmVyc2U6IGZhbHNlCiAgfTsKCiAgdmFyIGVtaXR0ZXIgPSB0aGlzLl8uZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKICB0aGlzLl8ub25EZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICBlbWl0dGVyLmVtaXQoJ2Rlc3Ryb3knKTsKICB9OwogIHRoaXMuXy5vblN0b3AgPSBmdW5jdGlvbih3YXNDb21wbGV0ZWQpIHsKICAgIGVtaXR0ZXIuZW1pdCgnc3RvcCcsIHdhc0NvbXBsZXRlZCk7CiAgICB3YXNDb21wbGV0ZWQgJiYgZW1pdHRlci5lbWl0KCdjb21wbGV0ZScpOwogIH07CiAgdGhpcy5fLm9uU3RhcnQgPSBmdW5jdGlvbigpIHsKICAgIGVtaXR0ZXIuZW1pdCgnc3RhcnQnKTsKICB9OwogIHRoaXMuXy5vblN0ZXAgPSBmdW5jdGlvbih2KSB7CiAgICBlbWl0dGVyLmVtaXQoJ3N0ZXAnLCB2KTsKICB9OwoKICBvcHRzLmR1cmF0aW9uICYmIHRoaXMuZHVyYXRpb24ob3B0cy5kdXJhdGlvbik7CiAgb3B0cy5wZXJjZW50ICYmIHRoaXMucGVyY2VudChvcHRzLnBlcmNlbnQpOwogIG9wdHMuZWFzaW5nICYmIHRoaXMuZWFzaW5nKG9wdHMuZWFzaW5nKTsKICBvcHRzLnJldmVyc2UgJiYgdGhpcy5yZXZlcnNlKG9wdHMucmV2ZXJzZSk7Cn0KCkFuaW1hdG9yLnByb3RvdHlwZSA9IHsKCiAgcmV2ZXJzZTogZnVuY3Rpb24ocmV2ZXJzZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgdGhpcy5fLmlzUmV2ZXJzZSA9ICEhcmV2ZXJzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fLmlzUmV2ZXJzZTsKICB9LAoKICBlYXNpbmc6IGZ1bmN0aW9uKGVhc2luZykgewogICAgdmFyIHR5cGUgPSB0eXBlb2YgZWFzaW5nOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicgfHwgdHlwZSA9PT0gJ3N0cmluZycgfHwgdHlwZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICB0aGlzLl8uZWFzaW5nID0gZmlndXJlT3V0RWFzaW5nKGVhc2luZyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fLmVhc2luZzsKICB9LAoKICBwZXJjZW50OiBmdW5jdGlvbihwZXJjZW50KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBpZiAodHlwZW9mIHBlcmNlbnQgPT09ICdudW1iZXInKSB7CiAgICAgICAgdGhpcy5fLnBlcmNlbnQgPSBjbGFtcCgwLCBwZXJjZW50LCAxKTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHsKICAgICAgICB0aGlzLl8ub25TdGVwKHRoaXMuX2dldFZhbHVlRm9yUGVyY2VudCh0aGlzLl8ucGVyY2VudCkpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIHRoaXMuXy5wZXJjZW50OwogIH0sCgogIGR1cmF0aW9uOiBmdW5jdGlvbihkdXJhdGlvbikgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gJ251bWJlcicgJiYgZHVyYXRpb24gPiAwKSB7CiAgICAgICAgdGhpcy5fLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fLmR1cmF0aW9uOwogIH0sCgogIC8qKgogICAqIEludGVycG9sYXRpb24gaXMgZGlzYWJsZWQgZm9yIG5vdy4KICAgKi8KICAvLyBhZGRJbnRlcnBvbGF0aW9uOiBmdW5jdGlvbihlbCwgc3RhcnRpbmdTdHlsZXMsIGVuZGluZ1N0eWxlcykgewogIC8vICAgdmFyIGludGVycG9sYXRvcnM7CiAgLy8gICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogIC8vICAgICBzeW5jU3R5bGVzKHN0YXJ0aW5nU3R5bGVzLCBlbmRpbmdTdHlsZXMsIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKSk7CiAgLy8gICAgIGludGVycG9sYXRvcnMgPSBtYWtlUHJvcGVydHlJbnRlcnBvbGF0b3JzKHN0YXJ0aW5nU3R5bGVzLCBlbmRpbmdTdHlsZXMpOwoKICAvLyAgICAgdGhpcy5vbignc3RlcCcsIHNldFN0eWxlcyk7CiAgLy8gICAgIHJldHVybiBmdW5jdGlvbiB1bmJpbmQoKSB7CiAgLy8gICAgICAgdGhpcy5vZmYoJ3N0ZXAnLCBzZXRTdHlsZXMpOwogIC8vICAgICB9OwogIC8vICAgfQogIC8vICAgZnVuY3Rpb24gc2V0U3R5bGVzKHYpIHsKICAvLyAgICAgZm9yICh2YXIgcHJvcGVydHkgaW4gaW50ZXJwb2xhdG9ycykgewogIC8vICAgICAgIGVsLnN0eWxlW3Byb3BlcnR5XSA9IGludGVycG9sYXRvcnNbcHJvcGVydHldKHYpOwogIC8vICAgICB9CiAgLy8gICB9CiAgLy8gfSwKCiAgaXNSdW5uaW5nOiBmdW5jdGlvbigpIHsgCiAgICByZXR1cm4gISF0aGlzLl8uaXNSdW5uaW5nOyAKICB9LAoKICBwcm9taXNlOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiB7CiAgICAgIHRoZW46IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgc2VsZi5vbmNlKCdzdG9wJywgY2IpOwogICAgICB9CiAgICB9OwogIH0sCgogIG9uOiBmdW5jdGlvbihldmVudFR5cGUsIGxpc3RlbmVyKSB7CiAgICB0aGlzLl8uZW1pdHRlci5vbihldmVudFR5cGUsIGxpc3RlbmVyKTsKICAgIHJldHVybiB0aGlzOwogIH0sCiAgb25jZTogZnVuY3Rpb24oZXZlbnRUeXBlLCBsaXN0ZW5lcikgewogICAgdGhpcy5fLmVtaXR0ZXIub25jZShldmVudFR5cGUsIGxpc3RlbmVyKTsKICAgIHJldHVybiB0aGlzOwogIH0sCiAgb2ZmOiBmdW5jdGlvbihldmVudFR5cGUsIGxpc3RlbmVyKSB7CiAgICB0aGlzLl8uZW1pdHRlci5vZmYoZXZlbnRUeXBlLCBsaXN0ZW5lcik7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc3RvcCgpOwogICAgdGhpcy5fLm9uRGVzdHJveSgpOwogICAgdGhpcy5vZmYoKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLl8uaXNSdW5uaW5nKSByZXR1cm47CgogICAgdGhpcy5fLmlzUnVubmluZyA9IGZhbHNlOwogICAgdGltZWxpbmUuYW5pbWF0aW9uU3RvcHBlZCh0aGlzKTsKCiAgICB0aGlzLl8ub25TdG9wKHRoaXMuX2lzQ29tcGxldGUoKSk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICByZXN0YXJ0OiBmdW5jdGlvbihpbW1lZGlhdGUpIHsKICAgIGlmICh0aGlzLl8uaXNSdW5uaW5nKSByZXR1cm47CgogICAgdGhpcy5fLnBlcmNlbnQgPSB0aGlzLl9nZXRTdGFydFBlcmNlbnQoKTsKCiAgICByZXR1cm4gdGhpcy5zdGFydCghIWltbWVkaWF0ZSk7CiAgfSwKCiAgc3RhcnQ6IGZ1bmN0aW9uKGltbWVkaWF0ZSkgewogICAgaWYgKHRoaXMuXy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICBpZiAoaW1tZWRpYXRlKSB7CiAgICAgIHRoaXMuXy5vblN0ZXAodGhpcy5fZ2V0VmFsdWVGb3JQZXJjZW50KHRoaXMuXy5wZXJjZW50KSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl8uaXNTdGFydGluZyA9IHRydWU7CiAgICB9CgogICAgdGhpcy5fLmlzUnVubmluZyA9IHRydWU7CiAgICB0aW1lbGluZS5hbmltYXRpb25TdGFydGVkKHRoaXMpOwoKICAgIHRoaXMuXy5vblN0YXJ0KCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBfaXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIXRoaXMuXy5pc1J1bm5pbmcgJiYgCiAgICAgIHRoaXMuXy5wZXJjZW50ID09PSB0aGlzLl9nZXRFbmRQZXJjZW50KCk7CiAgfSwKICBfZ2V0RW5kUGVyY2VudDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fLmlzUmV2ZXJzZSA/IDAgOiAxOwogIH0sCiAgX2dldFN0YXJ0UGVyY2VudDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fLmlzUmV2ZXJzZSA/IDEgOiAwOwogIH0sCgogIF9nZXRWYWx1ZUZvclBlcmNlbnQ6IGZ1bmN0aW9uKHBlcmNlbnQpIHsKICAgIGlmICh0aGlzLl8uZWFzaW5nKSB7CiAgICAgIHJldHVybiB0aGlzLl8uZWFzaW5nKHBlcmNlbnQsIHRoaXMuXy5kdXJhdGlvbik7CiAgICB9CiAgICByZXR1cm4gcGVyY2VudDsKICB9LAoKICBfdGljazogZnVuY3Rpb24oZGVsdGFUKSB7CiAgICB2YXIgc3RhdGUgPSB0aGlzLl87CgogICAgLy9GaXJzdCB0aWNrLCBkb24ndCB1cCB0aGUgcGVyY2VudAogICAgaWYgKHN0YXRlLmlzU3RhcnRpbmcpIHsKICAgICAgc3RhdGUuaXNTdGFydGluZyA9IGZhbHNlOwogICAgfSBlbHNlIGlmIChzdGF0ZS5pc1JldmVyc2UpIHsKICAgICAgc3RhdGUucGVyY2VudCA9IE1hdGgubWF4KDAsIHN0YXRlLnBlcmNlbnQgLSAoZGVsdGFUIC8gc3RhdGUuZHVyYXRpb24pKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YXRlLnBlcmNlbnQgPSBNYXRoLm1pbigxLCBzdGF0ZS5wZXJjZW50ICsgKGRlbHRhVCAvIHN0YXRlLmR1cmF0aW9uKSk7CiAgICB9CiAgICAKICAgIHN0YXRlLm9uU3RlcCh0aGlzLl9nZXRWYWx1ZUZvclBlcmNlbnQoc3RhdGUucGVyY2VudCkpOwoKICAgIGlmIChzdGF0ZS5wZXJjZW50ID09PSB0aGlzLl9nZXRFbmRQZXJjZW50KCkpIHsKICAgICAgdGhpcy5zdG9wKCk7CiAgICB9CiAgfSwKCn07CgpmdW5jdGlvbiBmaWd1cmVPdXRFYXNpbmcoZWFzaW5nKSB7CiAgaWYgKHR5cGVvZiBlYXNpbmcgPT09ICdvYmplY3QnKSB7CiAgICB2YXIgZHluYW1pY1R5cGUgPSB0eXBlb2YgZWFzaW5nLnR5cGUgPT09ICdzdHJpbmcnICYmCiAgICAgIGVhc2luZy50eXBlLnRvTG93ZXJDYXNlKCkudHJpbSgpOwoKICAgIGlmICghZHluYW1pY3NbZHluYW1pY1R5cGVdKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAnSW52YWxpZCBlYXNpbmcgZHluYW1pY3Mgb2JqZWN0IHR5cGUgIicgKyBlYXNpbmcudHlwZSArICciLiAnICsKICAgICAgICAnQXZhaWxhYmxlIGR5bmFtaWNzIHR5cGVzOiAnICsgT2JqZWN0LmtleXMoZHluYW1pY3MpLmpvaW4oJywgJykgKyAnLicKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBkeW5hbWljc1tkeW5hbWljVHlwZV0oZWFzaW5nKTsKCiAgfSBlbHNlIGlmICh0eXBlb2YgZWFzaW5nID09PSAnc3RyaW5nJykgewogICAgZWFzaW5nID0gZWFzaW5nLnRvTG93ZXJDYXNlKCkudHJpbSgpOwogICAgCiAgICBpZiAoZWFzaW5nLmluZGV4T2YoJ2N1YmljLWJlemllcignKSA9PT0gMCkgewogICAgICB2YXIgcGFydHMgPSBlYXNpbmcKICAgICAgICAucmVwbGFjZSgnY3ViaWMtYmV6aWVyKCcsICcnKQogICAgICAgIC5yZXBsYWNlKCcpJywgJycpCiAgICAgICAgLnNwbGl0KCcsJykKICAgICAgICAubWFwKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIHJldHVybiB2LnRyaW0oKTsKICAgICAgICB9KTsKICAgICAgcmV0dXJuIGVhc2luZ0Z1bmN0aW9uc1snY3ViaWMtYmV6aWVyJ10ocGFydHNbMF0sIHBhcnRzWzFdLCBwYXJ0c1syXSwgcGFydHNbM10pOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGZuID0gZWFzaW5nRnVuY3Rpb25zW2Vhc2luZ107CiAgICAgIGlmICghZm4pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAnSW52YWxpZCBlYXNpbmcgZnVuY3Rpb24gIicgKyBlYXNpbmcgKyAnIi4gJyArCiAgICAgICAgICAnQXZhaWxhYmxlIGVhc2luZyBmdW5jdGlvbnM6ICcgKyBPYmplY3Qua2V5cyhlYXNpbmdGdW5jdGlvbnMpLmpvaW4oJywgJykgKyAnLicKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBlYXNpbmdGdW5jdGlvbnNbZWFzaW5nXSgpOwogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIGVhc2luZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgcmV0dXJuIGVhc2luZzsKICB9Cn0KCi8vIC8qCi8vICAqIFR3ZWVuaW5nIGhlbHBlcnMKLy8gICovCi8vIGZ1bmN0aW9uIHN5bmNTdHlsZXMoc3RhcnRpbmdTdHlsZXMsIGVuZGluZ1N0eWxlcywgY29tcHV0ZWRTdHlsZSkgewovLyAgIHZhciBwcm9wZXJ0eTsKLy8gICBmb3IgKHByb3BlcnR5IGluIHN0YXJ0aW5nU3R5bGVzKSB7Ci8vICAgICBpZiAoIWVuZGluZ1N0eWxlcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHsKLy8gICAgICAgZGVsZXRlIHN0YXJ0aW5nU3R5bGVzW3Byb3BlcnR5XTsKLy8gICAgIH0KLy8gICB9Ci8vICAgZm9yIChwcm9wZXJ0eSBpbiBlbmRpbmdTdHlsZXMpIHsKLy8gICAgIGlmICghc3RhcnRpbmdTdHlsZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpKSB7Ci8vICAgICAgIHN0YXJ0aW5nU3R5bGVzW3Byb3BlcnR5XSA9IGNvbXB1dGVkU3R5bGVbdmVuZG9yaXplUHJvcGVydHlOYW1lKHByb3BlcnR5KV07Ci8vICAgICB9Ci8vICAgfQovLyB9CgovLyBmdW5jdGlvbiBtYWtlUHJvcGVydHlJbnRlcnBvbGF0b3JzKHN0YXJ0aW5nU3R5bGVzLCBlbmRpbmdTdHlsZXMpIHsKLy8gICB2YXIgaW50ZXJwb2xhdG9ycyA9IHt9OwovLyAgIHZhciBwcm9wZXJ0eTsKLy8gICBmb3IgKHByb3BlcnR5IGluIHN0YXJ0aW5nU3R5bGVzKSB7Ci8vICAgICBpbnRlcnBvbGF0b3JzW3ZlbmRvcml6ZVByb3BlcnR5TmFtZShwcm9wZXJ0eSldID0gaW50ZXJwb2xhdGUucHJvcGVydHlJbnRlcnBvbGF0b3IoCi8vICAgICAgIHByb3BlcnR5LCBzdGFydGluZ1N0eWxlc1twcm9wZXJ0eV0sIGVuZGluZ1N0eWxlc1twcm9wZXJ0eV0KLy8gICAgICk7Ci8vICAgfQovLyAgIHJldHVybiBpbnRlcnBvbGF0b3JzOwovLyB9CgovLyB2YXIgdHJhbnNmb3JtUHJvcGVydHk7Ci8vIGZ1bmN0aW9uIHZlbmRvcml6ZVByb3BlcnR5TmFtZShwcm9wZXJ0eSkgewovLyAgIGlmIChwcm9wZXJ0eSA9PT0gJ3RyYW5zZm9ybScpIHsKLy8gICAgIC8vU2V0IHRyYW5zZm9ybVByb3BlcnR5IGxhemlseSwgdG8gYmUgc3VyZSBET00gaGFzIGxvYWRlZCBhbHJlYWR5IHdoZW4gdXNpbmcgaXQKLy8gICAgIHJldHVybiB0cmFuc2Zvcm1Qcm9wZXJ0eSB8fCAKLy8gICAgICAgKHRyYW5zZm9ybVByb3BlcnR5ID0gY3NzRmVhdHVyZSgndHJhbnNmb3JtJykucHJvcGVydHkpOwovLyAgIH0gZWxzZSB7Ci8vICAgICByZXR1cm4gcHJvcGVydHk7Ci8vICAgfQovLyB9Cgp9LHsiLi9jb3JlL2R5bmFtaWNzIjo2LCIuL2NvcmUvZWFzaW5nLWZ1bmN0aW9ucyI6NywiLi9jb3JlL3RpbWVsaW5lIjo4LCIuL3V0aWwvc2ltcGxlLWVtaXR0ZXIiOjExLCIuL3V0aWwvdWlkIjoxMn1dLDU6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewovKgogKiBDb3B5cmlnaHQgKEMpIDIwMDggQXBwbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQKICogbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zCiAqIGFyZSBtZXQ6CiAqIDEuIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiAqICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KICogMi4gUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQKICogICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZQogKiAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgogKgogKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIEFQUExFIElOQy4gYGBBUyBJUycnIEFORCBBTlkKICogRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUKICogSU1QTElFRCBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSCiAqIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuICBJTiBOTyBFVkVOVCBTSEFMTCBBUFBMRSBJTkMuIE9SCiAqIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLAogKiBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiAqIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUgogKiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZCiAqIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVAogKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UKICogT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KICovCgovLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXRyYW5zaXRpb25zLyN0cmFuc2l0aW9uLWVhc2luZy1mdW5jdGlvbgptb2R1bGUuZXhwb3J0cyA9ICB7CiAgLyoKICAgKiBAcGFyYW0geCB7bnVtYmVyfSB0aGUgdmFsdWUgb2YgeCBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlLCAwLjAgPD0geCA8PSAxLjAKICAgKiBAcGFyYW0gZHVyYXRpb24ge251bWJlcn0gdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb24gaW4gbWlsbGlzZWNvbmRzCiAgICogQHJldHVybiB7bnVtYmVyfSB0aGUgeSB2YWx1ZSBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlCiAgICovCiAgbGluZWFyOiB1bml0QmV6aWVyKDAuMCwgMC4wLCAxLjAsIDEuMCksCgogIC8qCiAgICogQHBhcmFtIHgge251bWJlcn0gdGhlIHZhbHVlIG9mIHggYWxvbmcgdGhlIGJlemllciBjdXJ2ZSwgMC4wIDw9IHggPD0gMS4wCiAgICogQHBhcmFtIGR1cmF0aW9uIHtudW1iZXJ9IHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGluIG1pbGxpc2Vjb25kcwogICAqIEByZXR1cm4ge251bWJlcn0gdGhlIHkgdmFsdWUgYWxvbmcgdGhlIGJlemllciBjdXJ2ZQogICAqLwogIGVhc2U6IHVuaXRCZXppZXIoMC4yNSwgMC4xLCAwLjI1LCAxLjApLAoKICAvKgogICAqIEBwYXJhbSB4IHtudW1iZXJ9IHRoZSB2YWx1ZSBvZiB4IGFsb25nIHRoZSBiZXppZXIgY3VydmUsIDAuMCA8PSB4IDw9IDEuMAogICAqIEBwYXJhbSBkdXJhdGlvbiB7bnVtYmVyfSB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbiBpbiBtaWxsaXNlY29uZHMKICAgKiBAcmV0dXJuIHtudW1iZXJ9IHRoZSB5IHZhbHVlIGFsb25nIHRoZSBiZXppZXIgY3VydmUKICAgKi8KICBlYXNlSW46IHVuaXRCZXppZXIoMC40MiwgMCwgMS4wLCAxLjApLAoKICAvKgogICAqIEBwYXJhbSB4IHtudW1iZXJ9IHRoZSB2YWx1ZSBvZiB4IGFsb25nIHRoZSBiZXppZXIgY3VydmUsIDAuMCA8PSB4IDw9IDEuMAogICAqIEBwYXJhbSBkdXJhdGlvbiB7bnVtYmVyfSB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbiBpbiBtaWxsaXNlY29uZHMKICAgKiBAcmV0dXJuIHtudW1iZXJ9IHRoZSB5IHZhbHVlIGFsb25nIHRoZSBiZXppZXIgY3VydmUKICAgKi8KICBlYXNlT3V0OiB1bml0QmV6aWVyKDAsIDAsIDAuNTgsIDEuMCksCgogIC8qCiAgICogQHBhcmFtIHgge251bWJlcn0gdGhlIHZhbHVlIG9mIHggYWxvbmcgdGhlIGJlemllciBjdXJ2ZSwgMC4wIDw9IHggPD0gMS4wCiAgICogQHBhcmFtIGR1cmF0aW9uIHtudW1iZXJ9IHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGluIG1pbGxpc2Vjb25kcwogICAqIEByZXR1cm4ge251bWJlcn0gdGhlIHkgdmFsdWUgYWxvbmcgdGhlIGJlemllciBjdXJ2ZQogICAqLwogIGVhc2VJbk91dDogdW5pdEJlemllcigwLjQyLCAwLCAwLjU4LCAxLjApLAoKICAvKgogICAqIEBwYXJhbSBwMXgge251bWJlcn0gWCBjb21wb25lbnQgb2YgY29udHJvbCBwb2ludCAxCiAgICogQHBhcmFtIHAxeSB7bnVtYmVyfSBZIGNvbXBvbmVudCBvZiBjb250cm9sIHBvaW50IDEKICAgKiBAcGFyYW0gcDJ4IHtudW1iZXJ9IFggY29tcG9uZW50IG9mIGNvbnRyb2wgcG9pbnQgMgogICAqIEBwYXJhbSBwMnkge251bWJlcn0gWSBjb21wb25lbnQgb2YgY29udHJvbCBwb2ludCAyCiAgICogQHBhcmFtIHgge251bWJlcn0gdGhlIHZhbHVlIG9mIHggYWxvbmcgdGhlIGJlemllciBjdXJ2ZSwgMC4wIDw9IHggPD0gMS4wCiAgICogQHBhcmFtIGR1cmF0aW9uIHtudW1iZXJ9IHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGluIG1pbGxpc2Vjb25kcwogICAqIEByZXR1cm4ge251bWJlcn0gdGhlIHkgdmFsdWUgYWxvbmcgdGhlIGJlemllciBjdXJ2ZQogICAqLwogIGN1YmljQmV6aWVyOiBmdW5jdGlvbihwMXgsIHAxeSwgcDJ4LCBwMnkpIHsKICAgIHJldHVybiB1bml0QmV6aWVyKHAxeCwgcDF5LCBwMngsIHAyeSk7CiAgfQp9OwoKZnVuY3Rpb24gQjEodCkgeyByZXR1cm4gdCp0KnQ7IH0KZnVuY3Rpb24gQjIodCkgeyByZXR1cm4gMyp0KnQqKDEtdCk7IH0KZnVuY3Rpb24gQjModCkgeyByZXR1cm4gMyp0KigxLXQpKigxLXQpOyB9CmZ1bmN0aW9uIEI0KHQpIHsgcmV0dXJuICgxLXQpKigxLXQpKigxLXQpOyB9CgovKgogKiBKYXZhU2NyaXB0IHBvcnQgb2YgV2Via2l0IGltcGxlbWVudGF0aW9uIG9mIENTUyBjdWJpYy1iZXppZXIocDF4LnAxeSxwMngscDJ5KSBieSBodHRwOi8vbWNrLm1lCiAqIGh0dHA6Ly9zdm4ud2Via2l0Lm9yZy9yZXBvc2l0b3J5L3dlYmtpdC90cnVuay9Tb3VyY2UvV2ViQ29yZS9wbGF0Zm9ybS9ncmFwaGljcy9Vbml0QmV6aWVyLmgKICovCgovKgogKiBEdXJhdGlvbiB2YWx1ZSB0byB1c2Ugd2hlbiBvbmUgaXMgbm90IHNwZWNpZmllZCAoNDAwbXMgaXMgYSBjb21tb24gdmFsdWUpLgogKiBAY29uc3QKICogQHR5cGUge251bWJlcn0KICovCnZhciBERUZBVUxUX0RVUkFUSU9OID0gNDAwOy8vbXMKCi8qCiAqIFRoZSBlcHNpbG9uIHZhbHVlIHdlIHBhc3MgdG8gVW5pdEJlemllcjo6c29sdmUgZ2l2ZW4gdGhhdCB0aGUgYW5pbWF0aW9uIGlzIGdvaW5nIHRvIHJ1biBvdmVyIHxkdXJ8IHNlY29uZHMuCiAqIFRoZSBsb25nZXIgdGhlIGFuaW1hdGlvbiwgdGhlIG1vcmUgcHJlY2lzaW9uIHdlIG5lZWQgaW4gdGhlIGVhc2luZyBmdW5jdGlvbiByZXN1bHQgdG8gYXZvaWQgdWdseSBkaXNjb250aW51aXRpZXMuCiAqIGh0dHA6Ly9zdm4ud2Via2l0Lm9yZy9yZXBvc2l0b3J5L3dlYmtpdC90cnVuay9Tb3VyY2UvV2ViQ29yZS9wYWdlL2FuaW1hdGlvbi9BbmltYXRpb25CYXNlLmNwcAogKi8KZnVuY3Rpb24gc29sdmVFcHNpbG9uKGR1cmF0aW9uKSB7CiAgcmV0dXJuIDEuMCAvICgyMDAuMCAqIGR1cmF0aW9uKTsKfQoKLyoKICogRGVmaW5lcyBhIGN1YmljLWJlemllciBjdXJ2ZSBnaXZlbiB0aGUgbWlkZGxlIHR3byBjb250cm9sIHBvaW50cy4KICogTk9URTogZmlyc3QgYW5kIGxhc3QgY29udHJvbCBwb2ludHMgYXJlIGltcGxpY2l0bHkgKDAsMCkgYW5kICgxLDEpLgogKiBAcGFyYW0gcDF4IHtudW1iZXJ9IFggY29tcG9uZW50IG9mIGNvbnRyb2wgcG9pbnQgMQogKiBAcGFyYW0gcDF5IHtudW1iZXJ9IFkgY29tcG9uZW50IG9mIGNvbnRyb2wgcG9pbnQgMQogKiBAcGFyYW0gcDJ4IHtudW1iZXJ9IFggY29tcG9uZW50IG9mIGNvbnRyb2wgcG9pbnQgMgogKiBAcGFyYW0gcDJ5IHtudW1iZXJ9IFkgY29tcG9uZW50IG9mIGNvbnRyb2wgcG9pbnQgMgogKi8KZnVuY3Rpb24gdW5pdEJlemllcihwMXgsIHAxeSwgcDJ4LCBwMnkpIHsKCiAgLy8gcHJpdmF0ZSBtZW1iZXJzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIENhbGN1bGF0ZSB0aGUgcG9seW5vbWlhbCBjb2VmZmljaWVudHMsIGltcGxpY2l0IGZpcnN0IGFuZCBsYXN0IGNvbnRyb2wgcG9pbnRzIGFyZSAoMCwwKSBhbmQgKDEsMSkuCgogIC8qCiAgICogWCBjb21wb25lbnQgb2YgQmV6aWVyIGNvZWZmaWNpZW50IEMKICAgKiBAY29uc3QKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIHZhciBjeCA9IDMuMCAqIHAxeDsKCiAgLyoKICAgKiBYIGNvbXBvbmVudCBvZiBCZXppZXIgY29lZmZpY2llbnQgQgogICAqIEBjb25zdAogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgdmFyIGJ4ID0gMy4wICogKHAyeCAtIHAxeCkgLSBjeDsKCiAgLyoKICAgKiBYIGNvbXBvbmVudCBvZiBCZXppZXIgY29lZmZpY2llbnQgQQogICAqIEBjb25zdAogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgdmFyIGF4ID0gMS4wIC0gY3ggLWJ4OwoKICAvKgogICAqIFkgY29tcG9uZW50IG9mIEJlemllciBjb2VmZmljaWVudCBDCiAgICogQGNvbnN0CiAgICogQHR5cGUge251bWJlcn0KICAgKi8KICB2YXIgY3kgPSAzLjAgKiBwMXk7CgogIC8qCiAgICogWSBjb21wb25lbnQgb2YgQmV6aWVyIGNvZWZmaWNpZW50IEIKICAgKiBAY29uc3QKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIHZhciBieSA9IDMuMCAqIChwMnkgLSBwMXkpIC0gY3k7CgogIC8qCiAgICogWSBjb21wb25lbnQgb2YgQmV6aWVyIGNvZWZmaWNpZW50IEEKICAgKiBAY29uc3QKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIHZhciBheSA9IDEuMCAtIGN5IC0gYnk7CgogIC8qCiAgICogQHBhcmFtIHQge251bWJlcn0gcGFyYW1ldHJpYyBlYXNpbmcgdmFsdWUKICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICovCiAgdmFyIHNhbXBsZUN1cnZlWCA9IGZ1bmN0aW9uKHQpIHsKICAgIC8vIGBheCB0XjMgKyBieCB0XjIgKyBjeCB0JyBleHBhbmRlZCB1c2luZyBIb3JuZXIncyBydWxlLgogICAgcmV0dXJuICgoYXggKiB0ICsgYngpICogdCArIGN4KSAqIHQ7CiAgfTsKCiAgLyoKICAgKiBAcGFyYW0gdCB7bnVtYmVyfSBwYXJhbWV0cmljIGVhc2luZyB2YWx1ZQogICAqIEByZXR1cm4ge251bWJlcn0KICAgKi8KICB2YXIgc2FtcGxlQ3VydmVZID0gZnVuY3Rpb24odCkgewogICAgcmV0dXJuICgoYXkgKiB0ICsgYnkpICogdCArIGN5KSAqIHQ7CiAgfTsKCiAgLyoKICAgKiBAcGFyYW0gdCB7bnVtYmVyfSBwYXJhbWV0cmljIGVhc2luZyB2YWx1ZQogICAqIEByZXR1cm4ge251bWJlcn0KICAgKi8KICB2YXIgc2FtcGxlQ3VydmVEZXJpdmF0aXZlWCA9IGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiAoMy4wICogYXggKiB0ICsgMi4wICogYngpICogdCArIGN4OwogIH07CgogIC8qCiAgICogR2l2ZW4gYW4geCB2YWx1ZSwgZmluZCBhIHBhcmFtZXRyaWMgdmFsdWUgaXQgY2FtZSBmcm9tLgogICAqIEBwYXJhbSB4IHtudW1iZXJ9IHZhbHVlIG9mIHggYWxvbmcgdGhlIGJlemllciBjdXJ2ZSwgMC4wIDw9IHggPD0gMS4wCiAgICogQHBhcmFtIGVwc2lsb24ge251bWJlcn0gYWNjdXJhY3kgbGltaXQgb2YgdCBmb3IgdGhlIGdpdmVuIHgKICAgKiBAcmV0dXJuIHtudW1iZXJ9IHRoZSB0IHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8geAogICAqLwogIHZhciBzb2x2ZUN1cnZlWCA9IGZ1bmN0aW9uKHgsIGVwc2lsb24pIHsKICAgIHZhciB0MDsKICAgIHZhciB0MTsKICAgIHZhciB0MjsKICAgIHZhciB4MjsKICAgIHZhciBkMjsKICAgIHZhciBpOwoKICAgIC8vIEZpcnN0IHRyeSBhIGZldyBpdGVyYXRpb25zIG9mIE5ld3RvbidzIG1ldGhvZCAtLSBub3JtYWxseSB2ZXJ5IGZhc3QuCiAgICBmb3IgKHQyID0geCwgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgeDIgPSBzYW1wbGVDdXJ2ZVgodDIpIC0geDsKICAgICAgaWYgKE1hdGguYWJzICh4MikgPCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIHQyOwogICAgICB9CiAgICAgIGQyID0gc2FtcGxlQ3VydmVEZXJpdmF0aXZlWCh0Mik7CiAgICAgIGlmIChNYXRoLmFicyhkMikgPCAxZS02KSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgdDIgPSB0MiAtIHgyIC8gZDI7CiAgICB9CgogICAgLy8gRmFsbCBiYWNrIHRvIHRoZSBiaXNlY3Rpb24gbWV0aG9kIGZvciByZWxpYWJpbGl0eS4KICAgIHQwID0gMC4wOwogICAgdDEgPSAxLjA7CiAgICB0MiA9IHg7CgogICAgaWYgKHQyIDwgdDApIHsKICAgICAgcmV0dXJuIHQwOwogICAgfQogICAgaWYgKHQyID4gdDEpIHsKICAgICAgcmV0dXJuIHQxOwogICAgfQoKICAgIHdoaWxlICh0MCA8IHQxKSB7CiAgICAgIHgyID0gc2FtcGxlQ3VydmVYKHQyKTsKICAgICAgaWYgKE1hdGguYWJzKHgyIC0geCkgPCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIHQyOwogICAgICB9CiAgICAgIGlmICh4ID4geDIpIHsKICAgICAgICB0MCA9IHQyOwogICAgICB9IGVsc2UgewogICAgICAgIHQxID0gdDI7CiAgICAgIH0KICAgICAgdDIgPSAodDEgLSB0MCkgKiAwLjUgKyB0MDsKICAgIH0KCiAgICAvLyBGYWlsdXJlLgogICAgcmV0dXJuIHQyOwogIH07CgogIC8qCiAgICogQHBhcmFtIHgge251bWJlcn0gdGhlIHZhbHVlIG9mIHggYWxvbmcgdGhlIGJlemllciBjdXJ2ZSwgMC4wIDw9IHggPD0gMS4wCiAgICogQHBhcmFtIGVwc2lsb24ge251bWJlcn0gdGhlIGFjY3VyYWN5IG9mIHQgZm9yIHRoZSBnaXZlbiB4CiAgICogQHJldHVybiB7bnVtYmVyfSB0aGUgeSB2YWx1ZSBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlCiAgICovCiAgdmFyIHNvbHZlID0gZnVuY3Rpb24oeCwgZXBzaWxvbikgewogICAgcmV0dXJuIHNhbXBsZUN1cnZlWShzb2x2ZUN1cnZlWCh4LCBlcHNpbG9uKSk7CiAgfTsKCiAgLy8gcHVibGljIGludGVyZmFjZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvKgogICAqIEZpbmQgdGhlIHkgb2YgdGhlIGN1YmljLWJlemllciBmb3IgYSBnaXZlbiB4IHdpdGggYWNjdXJhY3kgZGV0ZXJtaW5lZCBieSB0aGUgYW5pbWF0aW9uIGR1cmF0aW9uLgogICAqIEBwYXJhbSB4IHtudW1iZXJ9IHRoZSB2YWx1ZSBvZiB4IGFsb25nIHRoZSBiZXppZXIgY3VydmUsIDAuMCA8PSB4IDw9IDEuMAogICAqIEBwYXJhbSBkdXJhdGlvbiB7bnVtYmVyfSB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbiBpbiBtaWxsaXNlY29uZHMKICAgKiBAcmV0dXJuIHtudW1iZXJ9IHRoZSB5IHZhbHVlIGFsb25nIHRoZSBiZXppZXIgY3VydmUKICAgKi8KICByZXR1cm4gZnVuY3Rpb24oeCwgZHVyYXRpb24pIHsKICAgIHJldHVybiBzb2x2ZSh4LCBzb2x2ZUVwc2lsb24oK2R1cmF0aW9uIHx8IERFRkFVTFRfRFVSQVRJT04pKTsKICB9Owp9CgoKfSx7fV0sNjpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBBIEhVR0UgdGhhbmsgeW91IHRvIGR5bmFtaWNzLmpzIHdoaWNoIGluc3BpcmVkIHRoZXNlIGR5bmFtaWNzIHNpbXVsYXRpb25zLgogKiBodHRwczovL2dpdGh1Yi5jb20vbWljaGFlbHZpbGxhci9keW5hbWljcy5qcwogKgogKiBBbHNvIGxpY2Vuc2VkIHVuZGVyIE1JVAogKi8KCnZhciBleHRlbmQgPSBfZGVyZXFfKCcuLi91dGlsL2V4dGVuZCcpOwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgc3ByaW5nOiBkeW5hbWljc1NwcmluZywKICBncmF2aXR5OiBkeW5hbWljc0dyYXZpdHkKfTsKCnZhciBzcHJpbmdEZWZhdWx0cyA9IHsKICBmcmVxdWVuY3k6IDE1LAogIGZyaWN0aW9uOiAyMDAsCiAgYW50aWNpcGF0aW9uU3RyZW5ndGg6IDAsCiAgYW50aWNpcGF0aW9uU2l6ZTogMAp9OwpmdW5jdGlvbiBkeW5hbWljc1NwcmluZyhvcHRzKSB7CiAgb3B0cyA9IGV4dGVuZCh7fSwgc3ByaW5nRGVmYXVsdHMsIG9wdHMgfHwge30pOwoKICByZXR1cm4gZnVuY3Rpb24gYXQodCwgZHVyYXRpb24pIHsKICAgIHZhciBBLCBBdCwgYSwgYW5nbGUsIGIsIGRlY2FsLCBmcmVxdWVuY3ksIGZyaWN0aW9uLCBmcmljdGlvblQsIHMsIHYsIHkwLCB5UywKICAgIF9vcHRzID0gb3B0czsKICAgIGZyZXF1ZW5jeSA9IE1hdGgubWF4KDEsIG9wdHMuZnJlcXVlbmN5KTsKICAgIGZyaWN0aW9uID0gTWF0aC5wb3coMjAsIG9wdHMuZnJpY3Rpb24gLyAxMDApOwogICAgcyA9IG9wdHMuYW50aWNpcGF0aW9uU2l6ZSAvIDEwMDsKICAgIGRlY2FsID0gTWF0aC5tYXgoMCwgcyk7CiAgICBmcmljdGlvblQgPSAodCAvICgxIC0gcykpIC0gKHMgLyAoMSAtIHMpKTsKICAgIGlmICh0IDwgcykgewogICAgICBBID0gZnVuY3Rpb24odCkgewogICAgICAgIHZhciBNLCBhLCBiLCB4MCwgeDE7CiAgICAgICAgTSA9IDAuODsKICAgICAgICB4MCA9IHMgLyAoMSAtIHMpOwogICAgICAgIHgxID0gMDsKICAgICAgICBiID0gKHgwIC0gKE0gKiB4MSkpIC8gKHgwIC0geDEpOwogICAgICAgIGEgPSAoTSAtIGIpIC8geDA7CiAgICAgICAgcmV0dXJuIChhICogdCAqIF9vcHRzLmFudGljaXBhdGlvblN0cmVuZ3RoIC8gMTAwKSArIGI7CiAgICAgIH07CiAgICAgIHlTID0gKHMgLyAoMSAtIHMpKSAtIChzIC8gKDEgLSBzKSk7CiAgICAgIHkwID0gKDAgLyAoMSAtIHMpKSAtIChzIC8gKDEgLSBzKSk7CiAgICAgIGIgPSBNYXRoLmFjb3MoMSAvIEEoeVMpKTsKICAgICAgYSA9IChNYXRoLmFjb3MoMSAvIEEoeTApKSAtIGIpIC8gKGZyZXF1ZW5jeSAqICgtcykpOwogICAgfSBlbHNlIHsKICAgICAgQSA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICByZXR1cm4gTWF0aC5wb3coZnJpY3Rpb24gLyAxMCwgLXQpICogKDEgLSB0KTsKICAgICAgfTsKICAgICAgYiA9IDA7CiAgICAgIGEgPSAxOwogICAgfQogICAgQXQgPSBBKGZyaWN0aW9uVCk7CiAgICBhbmdsZSA9IGZyZXF1ZW5jeSAqICh0IC0gcykgKiBhICsgYjsKICAgIHYgPSAxIC0gKEF0ICogTWF0aC5jb3MoYW5nbGUpKTsKICAgIC8vcmV0dXJuIFt0LCB2LCBBdCwgZnJpY3Rpb25ULCBhbmdsZV07CiAgICByZXR1cm4gdjsKICB9Owp9Cgp2YXIgZ3Jhdml0eURlZmF1bHRzID0gewogIGJvdW5jZTogNDAsCiAgZ3Jhdml0eTogMTAwMCwKICBpbml0aWFsRm9yY2U6IGZhbHNlCn07CmZ1bmN0aW9uIGR5bmFtaWNzR3Jhdml0eShvcHRzKSB7CiAgb3B0cyA9IGV4dGVuZCh7fSwgZ3Jhdml0eURlZmF1bHRzLCBvcHRzIHx8IHt9KTsKICB2YXIgY3VydmVzID0gW107CgogIGluaXQoKTsKCiAgcmV0dXJuIGF0OwoKICBmdW5jdGlvbiBsZW5ndGgoKSB7CiAgICB2YXIgTCwgYiwgYm91bmNlLCBjdXJ2ZSwgZ3Jhdml0eTsKICAgIGJvdW5jZSA9IE1hdGgubWluKG9wdHMuYm91bmNlIC8gMTAwLCA4MCk7CiAgICBncmF2aXR5ID0gb3B0cy5ncmF2aXR5IC8gMTAwOwogICAgYiA9IE1hdGguc3FydCgyIC8gZ3Jhdml0eSk7CiAgICBjdXJ2ZSA9IHsKICAgICAgYTogLWIsCiAgICAgIGI6IGIsCiAgICAgIEg6IDEKICAgIH07CiAgICBpZiAob3B0cy5pbml0aWFsRm9yY2UpIHsKICAgICAgY3VydmUuYSA9IDA7CiAgICAgIGN1cnZlLmIgPSBjdXJ2ZS5iICogMjsKICAgIH0KICAgIHdoaWxlIChjdXJ2ZS5IID4gMC4wMDEpIHsKICAgICAgTCA9IGN1cnZlLmIgLSBjdXJ2ZS5hOwogICAgICBjdXJ2ZSA9IHsKICAgICAgICBhOiBjdXJ2ZS5iLAogICAgICAgIGI6IGN1cnZlLmIgKyBMICogYm91bmNlLAogICAgICAgIEg6IGN1cnZlLkggKiBib3VuY2UgKiBib3VuY2UKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBjdXJ2ZS5iOwogIH0KCiAgZnVuY3Rpb24gaW5pdCgpIHsKICAgIHZhciBMLCBiLCBib3VuY2UsIGN1cnZlLCBncmF2aXR5LCBfcmVzdWx0czsKCiAgICBMID0gbGVuZ3RoKCk7CiAgICBncmF2aXR5ID0gKG9wdHMuZ3Jhdml0eSAvIDEwMCkgKiBMICogTDsKICAgIGJvdW5jZSA9IE1hdGgubWluKG9wdHMuYm91bmNlIC8gMTAwLCA4MCk7CiAgICBiID0gTWF0aC5zcXJ0KDIgLyBncmF2aXR5KTsKICAgIGN1cnZlcyA9IFtdOwogICAgY3VydmUgPSB7CiAgICAgIGE6IC1iLAogICAgICBiOiBiLAogICAgICBIOiAxCiAgICB9OwogICAgaWYgKG9wdHMuaW5pdGlhbEZvcmNlKSB7CiAgICAgIGN1cnZlLmEgPSAwOwogICAgICBjdXJ2ZS5iID0gY3VydmUuYiAqIDI7CiAgICB9CiAgICBjdXJ2ZXMucHVzaChjdXJ2ZSk7CiAgICBfcmVzdWx0cyA9IFtdOwogICAgd2hpbGUgKGN1cnZlLmIgPCAxICYmIGN1cnZlLkggPiAwLjAwMSkgewogICAgICBMID0gY3VydmUuYiAtIGN1cnZlLmE7CiAgICAgIGN1cnZlID0gewogICAgICAgIGE6IGN1cnZlLmIsCiAgICAgICAgYjogY3VydmUuYiArIEwgKiBib3VuY2UsCiAgICAgICAgSDogY3VydmUuSCAqIGJvdW5jZSAqIGJvdW5jZQogICAgICB9OwogICAgICBfcmVzdWx0cy5wdXNoKGN1cnZlcy5wdXNoKGN1cnZlKSk7CiAgICB9CiAgICByZXR1cm4gX3Jlc3VsdHM7CiAgfQoKICBmdW5jdGlvbiBjYWxjdWxhdGVDdXJ2ZShhLCBiLCBILCB0KXsKICAgIHZhciBMLCBjLCB0MjsKICAgIEwgPSBiIC0gYTsKICAgIHQyID0gKDIgLyBMKSAqIHQgLSAxIC0gKGEgKiAyIC8gTCk7CiAgICBjID0gdDIgKiB0MiAqIEggLSBIICsgMTsKICAgIGlmIChvcHRzLmluaXRpYWxGb3JjZSkgewogICAgICBjID0gMSAtIGM7CiAgICB9CiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIGF0KHQsIGR1cmF0aW9uKSB7CiAgICB2YXIgYm91bmNlLCBjdXJ2ZSwgZ3Jhdml0eSwgaSwgdjsKICAgIGJvdW5jZSA9IG9wdHMuYm91bmNlIC8gMTAwOwogICAgZ3Jhdml0eSA9IG9wdHMuZ3Jhdml0eTsKICAgIGkgPSAwOwogICAgY3VydmUgPSBjdXJ2ZXNbaV07CiAgICB3aGlsZSAoISh0ID49IGN1cnZlLmEgJiYgdCA8PSBjdXJ2ZS5iKSkgewogICAgICBpICs9IDE7CiAgICAgIGN1cnZlID0gY3VydmVzW2ldOwogICAgICBpZiAoIWN1cnZlKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmICghY3VydmUpIHsKICAgICAgdiA9IG9wdHMuaW5pdGlhbEZvcmNlID8gMCA6IDE7CiAgICB9IGVsc2UgewogICAgICB2ID0gY2FsY3VsYXRlQ3VydmUoY3VydmUuYSwgY3VydmUuYiwgY3VydmUuSCwgdCk7CiAgICB9CiAgICAvL3JldHVybiBbdCwgdl07CiAgICByZXR1cm4gdjsKICB9Cgp9OwoKfSx7Ii4uL3V0aWwvZXh0ZW5kIjoxMH1dLDc6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewp2YXIgZHluYW1pY3MgPSBfZGVyZXFfKCcuL2R5bmFtaWNzJyk7CnZhciBiZXppZXIgPSBfZGVyZXFfKCcuL2JlemllcicpOwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgJ2xpbmVhcic6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHQsIGR1cmF0aW9uKSB7CiAgICAgIHJldHVybiBiZXppZXIubGluZWFyKHQsIGR1cmF0aW9uKTsKICAgIH07CiAgfSwKICAnZWFzZSc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHQsIGR1cmF0aW9uKSB7CiAgICAgIHJldHVybiBiZXppZXIuZWFzZSh0LCBkdXJhdGlvbik7CiAgICB9OwogIH0sCiAgJ2Vhc2UtaW4nOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmdW5jdGlvbih0LCBkdXJhdGlvbikgewogICAgICByZXR1cm4gYmV6aWVyLmVhc2VJbih0LCBkdXJhdGlvbik7CiAgICB9OwogIH0sCiAgJ2Vhc2Utb3V0JzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odCwgZHVyYXRpb24pIHsKICAgICAgcmV0dXJuIGJlemllci5lYXNlT3V0KHQsIGR1cmF0aW9uKTsKICAgIH07CiAgfSwKICAnZWFzZS1pbi1vdXQnOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmdW5jdGlvbih0LCBkdXJhdGlvbikgewogICAgICByZXR1cm4gYmV6aWVyLmVhc2VJbk91dCh0LCBkdXJhdGlvbik7CiAgICB9OwogIH0sCiAgJ2N1YmljLWJlemllcic6IGZ1bmN0aW9uKHgxLCB5MSwgeDIsIHkyLCBkdXJhdGlvbikgewogICAgdmFyIGJ6ID0gYmV6aWVyLmN1YmljQmV6aWVyKHgxLCB5MSwgeDIsIHkyKTsvLywgdCwgZHVyYXRpb24pOwogICAgcmV0dXJuIGZ1bmN0aW9uKHQsIGR1cmF0aW9uKSB7CiAgICAgIHJldHVybiBieih0LCBkdXJhdGlvbik7CiAgICB9OwogIH0KfTsKCn0seyIuL2JlemllciI6NSwiLi9keW5hbWljcyI6Nn1dLDg6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewoKdmFyIHJhZiA9IF9kZXJlcV8oJ3JhZicpOwp2YXIgdGltZSA9IF9kZXJlcV8oJ3BlcmZvcm1hbmNlLW5vdycpOwoKdmFyIHNlbGYgPSBtb2R1bGUuZXhwb3J0cyA9IHsKICBfcnVubmluZzoge30sCgogIGFuaW1hdGlvblN0YXJ0ZWQ6IGZ1bmN0aW9uKGluc3RhbmNlKSB7CiAgICBzZWxmLl9ydW5uaW5nW2luc3RhbmNlLl8uaWRdID0gaW5zdGFuY2U7CgogICAgaWYgKCFzZWxmLmlzVGlja2luZykgewogICAgICBzZWxmLnRpY2soKTsKICAgIH0KICB9LAoKICBhbmltYXRpb25TdG9wcGVkOiBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgZGVsZXRlIHNlbGYuX3J1bm5pbmdbaW5zdGFuY2UuXy5pZF07CiAgICBzZWxmLm1heWJlU3RvcFRpY2tpbmcoKTsKICB9LAoKICB0aWNrOiBmdW5jdGlvbigpIHsKICAgIHZhciBsYXN0RnJhbWUgPSB0aW1lKCk7CgogICAgc2VsZi5pc1RpY2tpbmcgPSB0cnVlOwogICAgc2VsZi5fcmFmSWQgPSByYWYoc3RlcCk7CgogICAgZnVuY3Rpb24gc3RlcCgpIHsKICAgICAgc2VsZi5fcmFmSWQgPSByYWYoc3RlcCk7CgogICAgICAvLyBHZXQgY3VycmVudCB0aW1lCiAgICAgIHZhciBub3cgPSB0aW1lKCk7CiAgICAgIHZhciBkZWx0YVQgPSBub3cgLSBsYXN0RnJhbWU7CgogICAgICBmb3IgKHZhciBhbmltYXRpb25JZCBpbiBzZWxmLl9ydW5uaW5nKSB7CiAgICAgICAgc2VsZi5fcnVubmluZ1thbmltYXRpb25JZF0uX3RpY2soZGVsdGFUKTsKICAgICAgfQoKICAgICAgbGFzdEZyYW1lID0gbm93OwogICAgfQogIH0sCgogIG1heWJlU3RvcFRpY2tpbmc6IGZ1bmN0aW9uKCkgewogICAgaWYgKHNlbGYuaXNUaWNraW5nICYmICFPYmplY3Qua2V5cyhzZWxmLl9ydW5uaW5nKS5sZW5ndGgpIHsKICAgICAgcmFmLmNhbmNlbChzZWxmLl9yYWZJZCk7CiAgICAgIHNlbGYuaXNUaWNraW5nID0gZmFsc2U7CiAgICB9CiAgfSwKCn07CgoKfSx7InBlcmZvcm1hbmNlLW5vdyI6MSwicmFmIjoyfV0sOTpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gewogIGFuaW1hdG9yOiBfZGVyZXFfKCcuL2FuaW1hdG9yJykKfTsKCn0seyIuL2FuaW1hdG9yIjo0fV0sMTA6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewoKLyoKICogVGhlcmUgcmVhbGx5IGlzIG5vIHRpbnkgbWluaW1hbCBleHRlbmQoKSBvbiBucG0gdG8gZmluZCwKICogc28gd2UganVzdCB1c2Ugb3VyIG93bi4KICovCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGV4dGVuZChvYmopIHsKICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICBmb3IodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgIHZhciBzb3VyY2UgPSBhcmdzW2ldOwogICAgIGlmIChzb3VyY2UpIHsKICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgIH0KICAgICB9CiAgIH0KICAgcmV0dXJuIG9iajsKfTsKCn0se31dLDExOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXsKCi8vIEFsbCB3ZSB3YW50IGlzIGFuIGV2ZW50RW1pdHRlciB0aGF0IGRvZXNuJ3QgdXNlICNjYWxsIG9yICNhcHBseSwKLy8gYnkgZXhwZWN0aW5nIDAtMSBhcmd1bWVudHMuIAovLyBXZSBjb3VsZG4ndCBmaW5kIHRoaXMgb24gbnBtLCBzbyB3ZSBtYWtlIG91ciBvd24uCgptb2R1bGUuZXhwb3J0cyA9IFNpbXBsZUV2ZW50RW1pdHRlcjsKCmZ1bmN0aW9uIFNpbXBsZUV2ZW50RW1pdHRlcigpIHsKfQoKU2ltcGxlRXZlbnRFbWl0dGVyLnByb3RvdHlwZSA9IHsKICBsaXN0ZW5lcnM6IFtdLAogIG9uOiBmdW5jdGlvbihldmVudFR5cGUsIGZuKSB7CiAgICBpZiAodHlwZW9mIGZuICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CiAgICB0aGlzLmxpc3RlbmVyc1tldmVudFR5cGVdIHx8ICh0aGlzLmxpc3RlbmVyc1tldmVudFR5cGVdID0gW10pOwogICAgdGhpcy5saXN0ZW5lcnNbZXZlbnRUeXBlXS5wdXNoKGZuKTsKICB9LAogIG9uY2U6IGZ1bmN0aW9uKGV2ZW50VHlwZSwgZm4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGZ1bmN0aW9uIG9uY2VGbigpIHsKICAgICAgc2VsZi5vZmYoZXZlbnRUeXBlLCBmbik7CiAgICAgIHNlbGYub2ZmKGV2ZW50VHlwZSwgb25jZUZuKTsKICAgIH0KICAgIHRoaXMub24oZXZlbnRUeXBlLCBmbik7CiAgICB0aGlzLm9uKGV2ZW50VHlwZSwgb25jZUZuKTsKICB9LAogIC8vIEJ1aWx0LWluIGxpbWl0YXRpb246IHdlIG9ubHkgZXhwZWN0IDAtMSBhcmd1bWVudHMKICAvLyBUaGlzIGlzIHRvIHNhdmUgYXMgbXVjaCBwZXJmIGFzIHBvc3NpYmxlIHdoZW4gc2VuZGluZwogIC8vIGV2ZW50cyBldmVyeSBmcmFtZS4KICBlbWl0OiBmdW5jdGlvbihldmVudFR5cGUsIGV2ZW50QXJnKSB7CiAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbZXZlbnRUeXBlXSB8fCBbXTsKICAgIHZhciBpID0gMDsKICAgIHZhciBsZW4gPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgICAgZm9yIChpOyBpIDwgbGVuOyBpKyspIGxpc3RlbmVyc1tpXSAmJiBsaXN0ZW5lcnNbaV0oZXZlbnRBcmcpOwogICAgfSBlbHNlIHsKICAgICAgZm9yIChpOyBpIDwgbGVuOyBpKyspIGxpc3RlbmVyc1tpXSAmJiBsaXN0ZW5lcnNbaV0oKTsKICAgIH0KICB9LAogIG9mZjogZnVuY3Rpb24oZXZlbnRUeXBlLCBmblRvUmVtb3ZlKSB7CiAgICBpZiAoIWV2ZW50VHlwZSkgewogICAgICAvL1JlbW92ZSBhbGwgbGlzdGVuZXJzCiAgICAgIGZvciAodmFyIHR5cGUgaW4gdGhpcy5saXN0ZW5lcnMpIHsKICAgICAgICB0aGlzLm9mZih0eXBlKTsKICAgICAgfQogICAgfSBlbHNlICB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1tldmVudFR5cGVdOwogICAgICBpZiAobGlzdGVuZXJzKSB7CiAgICAgICAgaWYgKCFmblRvUmVtb3ZlKSB7CiAgICAgICAgICBsaXN0ZW5lcnMubGVuZ3RoID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGluZGV4ID0gbGlzdGVuZXJzLmluZGV4T2YoZm5Ub1JlbW92ZSk7CiAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9IAp9OwoKfSx7fV0sMTI6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewoKLyoqCiAqIG5leHRVaWQoKSBmcm9tIGFuZ3VsYXIuanMKICogTGljZW5zZSBNSVQKICogaHR0cDovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzCiAqCiAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAqIGNoYXJhY3RlcnMgc3VjaCBhcyAnMDEyQUJDJy4gVGhlIHJlYXNvbiB3aHkgd2UgYXJlIG5vdCB1c2luZyBzaW1wbHkgYSBudW1iZXIgY291bnRlciBpcyB0aGF0CiAqIHRoZSBudW1iZXIgc3RyaW5nIGdldHMgbG9uZ2VyIG92ZXIgdGltZSwgYW5kIGl0IGNhbiBhbHNvIG92ZXJmbG93LCB3aGVyZSBhcyB0aGUgbmV4dElkCiAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogKgogKiBAcmV0dXJucyBhbiB1bmlxdWUgYWxwaGEtbnVtZXJpYyBzdHJpbmcKICovCnZhciB1aWQgPSBbXTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gbmV4dFVpZCgpIHsKICB2YXIgaW5kZXggPSB1aWQubGVuZ3RoOwogIHZhciBkaWdpdDsKCiAgd2hpbGUoaW5kZXgpIHsKICAgIGluZGV4LS07CiAgICBkaWdpdCA9IHVpZFtpbmRleF0uY2hhckNvZGVBdCgwKTsKICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgIHVpZFtpbmRleF0gPSAnQSc7CiAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CiAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgdWlkW2luZGV4XSA9ICcwJzsKICAgIH0gZWxzZSB7CiAgICAgIHVpZFtpbmRleF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRpZ2l0ICsgMSk7CiAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CiAgfQogIHVpZC51bnNoaWZ0KCcwJyk7CiAgcmV0dXJuIHVpZC5qb2luKCcnKTsKfTsKCn0se31dLDEzOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXsKLy8gc2hpbSBmb3IgdXNpbmcgcHJvY2VzcyBpbiBicm93c2VyCgp2YXIgcHJvY2VzcyA9IG1vZHVsZS5leHBvcnRzID0ge307Cgpwcm9jZXNzLm5leHRUaWNrID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBjYW5TZXRJbW1lZGlhdGUgPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJwogICAgJiYgd2luZG93LnNldEltbWVkaWF0ZTsKICAgIHZhciBjYW5Qb3N0ID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcKICAgICYmIHdpbmRvdy5wb3N0TWVzc2FnZSAmJiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcgogICAgOwoKICAgIGlmIChjYW5TZXRJbW1lZGlhdGUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGYpIHsgcmV0dXJuIHdpbmRvdy5zZXRJbW1lZGlhdGUoZikgfTsKICAgIH0KCiAgICBpZiAoY2FuUG9zdCkgewogICAgICAgIHZhciBxdWV1ZSA9IFtdOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgIHZhciBzb3VyY2UgPSBldi5zb3VyY2U7CiAgICAgICAgICAgIGlmICgoc291cmNlID09PSB3aW5kb3cgfHwgc291cmNlID09PSBudWxsKSAmJiBldi5kYXRhID09PSAncHJvY2Vzcy10aWNrJykgewogICAgICAgICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICBpZiAocXVldWUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sIHRydWUpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gbmV4dFRpY2soZm4pIHsKICAgICAgICAgICAgcXVldWUucHVzaChmbik7CiAgICAgICAgICAgIHdpbmRvdy5wb3N0TWVzc2FnZSgncHJvY2Vzcy10aWNrJywgJyonKTsKICAgICAgICB9OwogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiBuZXh0VGljayhmbikgewogICAgICAgIHNldFRpbWVvdXQoZm4sIDApOwogICAgfTsKfSkoKTsKCnByb2Nlc3MudGl0bGUgPSAnYnJvd3Nlcic7CnByb2Nlc3MuYnJvd3NlciA9IHRydWU7CnByb2Nlc3MuZW52ID0ge307CnByb2Nlc3MuYXJndiA9IFtdOwoKZnVuY3Rpb24gbm9vcCgpIHt9Cgpwcm9jZXNzLm9uID0gbm9vcDsKcHJvY2Vzcy5hZGRMaXN0ZW5lciA9IG5vb3A7CnByb2Nlc3Mub25jZSA9IG5vb3A7CnByb2Nlc3Mub2ZmID0gbm9vcDsKcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lciA9IG5vb3A7CnByb2Nlc3MucmVtb3ZlQWxsTGlzdGVuZXJzID0gbm9vcDsKcHJvY2Vzcy5lbWl0ID0gbm9vcDsKCnByb2Nlc3MuYmluZGluZyA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkJyk7Cn0KCi8vIFRPRE8oc2h0eWxtYW4pCnByb2Nlc3MuY3dkID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gJy8nIH07CnByb2Nlc3MuY2hkaXIgPSBmdW5jdGlvbiAoZGlyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuY2hkaXIgaXMgbm90IHN1cHBvcnRlZCcpOwp9OwoKfSx7fV19LHt9LFs5XSkKKDkpCn0pOwp9KSgpOw==",
                "body": "LyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qIQogKiBDb3B5cmlnaHQgMjAxNCBEcmlmdHkgQ28uCiAqIGh0dHA6Ly9kcmlmdHkuY29tLwogKgogKiBJb25pYywgdjEuMC4wLWJldGEuMTIKICogQSBwb3dlcmZ1bCBIVE1MNSBtb2JpbGUgYXBwIGZyYW1ld29yay4KICogaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS8KICoKICogQnkgQG1heGx5bmNoLCBAYmVuanNwZXJyeSwgQGFkYW1kYnJhZGxleSA8MwogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuIFBsZWFzZSBzZWUgTElDRU5TRSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICoKICovCgooZnVuY3Rpb24oKSB7CgovLyBDcmVhdGUgZ2xvYmFsIGlvbmljIG9iaiBhbmQgaXRzIG5hbWVzcGFjZXMKLy8gYnVpbGQgcHJvY2Vzc2VzIG1heSBoYXZlIGFscmVhZHkgY3JlYXRlZCBhbiBpb25pYyBvYmoKd2luZG93LmlvbmljID0gd2luZG93LmlvbmljIHx8IHt9Owp3aW5kb3cuaW9uaWMudmlld3MgPSB7fTsKd2luZG93LmlvbmljLnZlcnNpb24gPSAnMS4wLjAtYmV0YS4xMic7CgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgaW9uaWMpIHsKCiAgdmFyIHJlYWR5Q2FsbGJhY2tzID0gW107CiAgdmFyIGlzRG9tUmVhZHkgPSBmYWxzZTsKCiAgZnVuY3Rpb24gZG9tUmVhZHkoKSB7CiAgICBpc0RvbVJlYWR5ID0gdHJ1ZTsKICAgIGZvcih2YXIgeD0wOyB4PHJlYWR5Q2FsbGJhY2tzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShyZWFkeUNhbGxiYWNrc1t4XSk7CiAgICB9CiAgICByZWFkeUNhbGxiYWNrcyA9IFtdOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbVJlYWR5KTsKICB9CiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbVJlYWR5KTsKCiAgLy8gRnJvbSB0aGUgbWFuIGhpbXNlbGYsIE1yLiBQYXVsIElyaXNoLgogIC8vIFRoZSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgcG9seWZpbGwKICAvLyBQdXQgaXQgb24gd2luZG93IGp1c3QgdG8gcHJlc2VydmUgaXRzIGNvbnRleHQKICAvLyB3aXRob3V0IGhhdmluZyB0byB1c2UgLmNhbGwKICB3aW5kb3cuX3JBRiA9IChmdW5jdGlvbigpewogICAgcmV0dXJuICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lICAgICAgIHx8CiAgICAgICAgICAgIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSAgICB8fAogICAgICAgICAgICBmdW5jdGlvbiggY2FsbGJhY2sgKXsKICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChjYWxsYmFjaywgMTYpOwogICAgICAgICAgICB9OwogIH0pKCk7CgogIHZhciBjYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgd2luZG93LndlYmtpdENhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICB3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgIHdpbmRvdy53ZWJraXRDYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgogIC8qKgogICogQG5nZG9jIHV0aWxpdHkKICAqIEBuYW1lIGlvbmljLkRvbVV0aWwKICAqIEBtb2R1bGUgaW9uaWMKICAqLwogIGlvbmljLkRvbVV0aWwgPSB7CiAgICAvL0NhbGwgd2l0aCBwcm9wZXIgY29udGV4dAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI3JlcXVlc3RBbmltYXRpb25GcmFtZQogICAgICogQGFsaWFzIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZQogICAgICogQGRlc2NyaXB0aW9uIENhbGxzIFtyZXF1ZXN0QW5pbWF0aW9uRnJhbWVdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS93aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSwgb3IgYSBwb2x5ZmlsbCBpZiBub3QgYXZhaWxhYmxlLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgbmV4dCBmcmFtZQogICAgICogaGFwcGVucy4KICAgICAqLwogICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lOiBmdW5jdGlvbihjYikgewogICAgICByZXR1cm4gd2luZG93Ll9yQUYoY2IpOwogICAgfSwKCiAgICBjYW5jZWxBbmltYXRpb25GcmFtZTogZnVuY3Rpb24ocmVxdWVzdElkKSB7CiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJlcXVlc3RJZCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuRG9tVXRpbCNhbmltYXRpb25GcmFtZVRocm90dGxlCiAgICAgKiBAYWxpYXMgaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXaGVuIGdpdmVuIGEgY2FsbGJhY2ssIGlmIHRoYXQgY2FsbGJhY2sgaXMgY2FsbGVkIDEwMCB0aW1lcyBiZXR3ZWVuCiAgICAgKiBhbmltYXRpb24gZnJhbWVzLCBhZGRpbmcgVGhyb3R0bGUgd2lsbCBtYWtlIGl0IG9ubHkgcnVuIHRoZSBsYXN0IG9mCiAgICAgKiB0aGUgMTAwIGNhbGxzLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBiZSB0aHJvdHRsZWQgdG8KICAgICAqIHJlcXVlc3RBbmltYXRpb25GcmFtZQogICAgICogQHJldHVybnMge2Z1bmN0aW9ufSBBIGZ1bmN0aW9uIHdoaWNoIHdpbGwgdGhlbiBjYWxsIHRoZSBwYXNzZWQgaW4gY2FsbGJhY2suCiAgICAgKiBUaGUgcGFzc2VkIGluIGNhbGxiYWNrIHdpbGwgcmVjZWl2ZSB0aGUgY29udGV4dCB0aGUgcmV0dXJuZWQgZnVuY3Rpb24gaXMKICAgICAqIGNhbGxlZCB3aXRoLgogICAgICovCiAgICBhbmltYXRpb25GcmFtZVRocm90dGxlOiBmdW5jdGlvbihjYikgewogICAgICB2YXIgYXJncywgaXNRdWV1ZWQsIGNvbnRleHQ7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICAgIGNvbnRleHQgPSB0aGlzOwogICAgICAgIGlmICghaXNRdWV1ZWQpIHsKICAgICAgICAgIGlzUXVldWVkID0gdHJ1ZTsKICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2IuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgIGlzUXVldWVkID0gZmFsc2U7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuRG9tVXRpbCNnZXRQb3NpdGlvbkluUGFyZW50CiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEZpbmQgYW4gZWxlbWVudCdzIHNjcm9sbCBvZmZzZXQgd2l0aGluIGl0cyBjb250YWluZXIuCiAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gZmluZCB0aGUgb2Zmc2V0IG9mLgogICAgICogQHJldHVybnMge29iamVjdH0gQSBwb3NpdGlvbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKiAgIC0gYHtudW1iZXJ9YCBgbGVmdGAgVGhlIGxlZnQgb2Zmc2V0IG9mIHRoZSBlbGVtZW50LgogICAgICogICAtIGB7bnVtYmVyfWAgYHRvcGAgVGhlIHRvcCBvZmZzZXQgb2YgdGhlIGVsZW1lbnQuCiAgICAgKi8KICAgIGdldFBvc2l0aW9uSW5QYXJlbnQ6IGZ1bmN0aW9uKGVsKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgbGVmdDogZWwub2Zmc2V0TGVmdCwKICAgICAgICB0b3A6IGVsLm9mZnNldFRvcAogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjcmVhZHkKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ2FsbCBhIGZ1bmN0aW9uIHdoZW4gdGhlIERPTSBpcyByZWFkeSwgb3IgaWYgaXQgaXMgYWxyZWFkeSByZWFkeQogICAgICogY2FsbCB0aGUgZnVuY3Rpb24gaW1tZWRpYXRlbHkuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gYmUgY2FsbGVkLgogICAgICovCiAgICByZWFkeTogZnVuY3Rpb24oY2IpIHsKICAgICAgaWYoaXNEb21SZWFkeSB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGNiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWFkeUNhbGxiYWNrcy5wdXNoKGNiKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0VGV4dEJvdW5kcwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBHZXQgYSByZWN0IHJlcHJlc2VudGluZyB0aGUgYm91bmRzIG9mIHRoZSBnaXZlbiB0ZXh0Tm9kZS4KICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gdGV4dE5vZGUgVGhlIHRleHROb2RlIHRvIGZpbmQgdGhlIGJvdW5kcyBvZi4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJvdW5kcyBvZiB0aGUgbm9kZS4gUHJvcGVydGllczoKICAgICAqICAgLSBge251bWJlcn1gIGBsZWZ0YCBUaGUgbGVmdCBwb3NpdGlvbiBvZiB0aGUgdGV4dE5vZGUuCiAgICAgKiAgIC0gYHtudW1iZXJ9YCBgcmlnaHRgIFRoZSByaWdodCBwb3NpdGlvbiBvZiB0aGUgdGV4dE5vZGUuCiAgICAgKiAgIC0gYHtudW1iZXJ9YCBgdG9wYCBUaGUgdG9wIHBvc2l0aW9uIG9mIHRoZSB0ZXh0Tm9kZS4KICAgICAqICAgLSBge251bWJlcn1gIGBib3R0b21gIFRoZSBib3R0b20gcG9zaXRpb24gb2YgdGhlIHRleHROb2RlLgogICAgICogICAtIGB7bnVtYmVyfWAgYHdpZHRoYCBUaGUgd2lkdGggb2YgdGhlIHRleHROb2RlLgogICAgICogICAtIGB7bnVtYmVyfWAgYGhlaWdodGAgVGhlIGhlaWdodCBvZiB0aGUgdGV4dE5vZGUuCiAgICAgKi8KICAgIGdldFRleHRCb3VuZHM6IGZ1bmN0aW9uKHRleHROb2RlKSB7CiAgICAgIGlmKGRvY3VtZW50LmNyZWF0ZVJhbmdlKSB7CiAgICAgICAgdmFyIHJhbmdlID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKICAgICAgICByYW5nZS5zZWxlY3ROb2RlQ29udGVudHModGV4dE5vZGUpOwogICAgICAgIGlmKHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCkgewogICAgICAgICAgdmFyIHJlY3QgPSByYW5nZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgIGlmKHJlY3QpIHsKICAgICAgICAgICAgdmFyIHN4ID0gd2luZG93LnNjcm9sbFg7CiAgICAgICAgICAgIHZhciBzeSA9IHdpbmRvdy5zY3JvbGxZOwoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0b3A6IHJlY3QudG9wICsgc3ksCiAgICAgICAgICAgICAgbGVmdDogcmVjdC5sZWZ0ICsgc3gsCiAgICAgICAgICAgICAgcmlnaHQ6IHJlY3QubGVmdCArIHN4ICsgcmVjdC53aWR0aCwKICAgICAgICAgICAgICBib3R0b206IHJlY3QudG9wICsgc3kgKyByZWN0LmhlaWdodCwKICAgICAgICAgICAgICB3aWR0aDogcmVjdC53aWR0aCwKICAgICAgICAgICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0Q2hpbGRJbmRleAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBHZXQgdGhlIGZpcnN0IGluZGV4IG9mIGEgY2hpbGQgbm9kZSB3aXRoaW4gdGhlIGdpdmVuIGVsZW1lbnQgb2YgdGhlCiAgICAgKiBzcGVjaWZpZWQgdHlwZS4KICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byBmaW5kIHRoZSBpbmRleCBvZi4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBub2RlTmFtZSB0byBtYXRjaCBjaGlsZHJlbiBvZiBlbGVtZW50IGFnYWluc3QuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgaW5kZXgsIG9yIC0xLCBvZiBhIGNoaWxkIHdpdGggbm9kZU5hbWUgbWF0Y2hpbmcgdHlwZS4KICAgICAqLwogICAgZ2V0Q2hpbGRJbmRleDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSkgewogICAgICBpZih0eXBlKSB7CiAgICAgICAgdmFyIGNoID0gZWxlbWVudC5wYXJlbnROb2RlLmNoaWxkcmVuOwogICAgICAgIHZhciBjOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGsgPSAwLCBqID0gY2gubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICBjID0gY2hbaV07CiAgICAgICAgICBpZihjLm5vZGVOYW1lICYmIGMubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSB0eXBlKSB7CiAgICAgICAgICAgIGlmKGMgPT0gZWxlbWVudCkgewogICAgICAgICAgICAgIHJldHVybiBrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGsrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGVsZW1lbnQucGFyZW50Tm9kZS5jaGlsZHJlbikuaW5kZXhPZihlbGVtZW50KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBzd2FwTm9kZXM6IGZ1bmN0aW9uKHNyYywgZGVzdCkgewogICAgICBkZXN0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNyYywgZGVzdCk7CiAgICB9LAoKICAgIGVsZW1lbnRJc0Rlc2NlbmRhbnQ6IGZ1bmN0aW9uKGVsLCBwYXJlbnQsIHN0b3BBdCkgewogICAgICB2YXIgY3VycmVudCA9IGVsOwogICAgICBkbyB7CiAgICAgICAgaWYgKGN1cnJlbnQgPT09IHBhcmVudCkgcmV0dXJuIHRydWU7CiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50Tm9kZTsKICAgICAgfSB3aGlsZSAoY3VycmVudCAmJiBjdXJyZW50ICE9PSBzdG9wQXQpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuRG9tVXRpbCNnZXRQYXJlbnRXaXRoQ2xhc3MKICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudAogICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZQogICAgICogQHJldHVybnMge0RPTUVsZW1lbnR9IFRoZSBjbG9zZXN0IHBhcmVudCBvZiBlbGVtZW50IG1hdGNoaW5nIHRoZQogICAgICogY2xhc3NOYW1lLCBvciBudWxsLgogICAgICovCiAgICBnZXRQYXJlbnRXaXRoQ2xhc3M6IGZ1bmN0aW9uKGUsIGNsYXNzTmFtZSwgZGVwdGgpIHsKICAgICAgZGVwdGggPSBkZXB0aCB8fCAxMDsKICAgICAgd2hpbGUoZS5wYXJlbnROb2RlICYmIGRlcHRoLS0pIHsKICAgICAgICBpZihlLnBhcmVudE5vZGUuY2xhc3NMaXN0ICYmIGUucGFyZW50Tm9kZS5jbGFzc0xpc3QuY29udGFpbnMoY2xhc3NOYW1lKSkgewogICAgICAgICAgcmV0dXJuIGUucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgZSA9IGUucGFyZW50Tm9kZTsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0UGFyZW50T3JTZWxmV2l0aENsYXNzCiAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUKICAgICAqIEByZXR1cm5zIHtET01FbGVtZW50fSBUaGUgY2xvc2VzdCBwYXJlbnQgb3Igc2VsZiBtYXRjaGluZyB0aGUKICAgICAqIGNsYXNzTmFtZSwgb3IgbnVsbC4KICAgICAqLwogICAgZ2V0UGFyZW50T3JTZWxmV2l0aENsYXNzOiBmdW5jdGlvbihlLCBjbGFzc05hbWUsIGRlcHRoKSB7CiAgICAgIGRlcHRoID0gZGVwdGggfHwgMTA7CiAgICAgIHdoaWxlKGUgJiYgZGVwdGgtLSkgewogICAgICAgIGlmKGUuY2xhc3NMaXN0ICYmIGUuY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSkpIHsKICAgICAgICAgIHJldHVybiBlOwogICAgICAgIH0KICAgICAgICBlID0gZS5wYXJlbnROb2RlOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjcmVjdENvbnRhaW5zCiAgICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgICogQHBhcmFtIHtudW1iZXJ9IHkKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MQogICAgICogQHBhcmFtIHtudW1iZXJ9IHkxCiAgICAgKiBAcGFyYW0ge251bWJlcn0geDIKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIge3gseX0gZml0cyB3aXRoaW4gdGhlIHJlY3RhbmdsZSBkZWZpbmVkIGJ5CiAgICAgKiB7eDEseTEseDIseTJ9LgogICAgICovCiAgICByZWN0Q29udGFpbnM6IGZ1bmN0aW9uKHgsIHksIHgxLCB5MSwgeDIsIHkyKSB7CiAgICAgIGlmKHggPCB4MSB8fCB4ID4geDIpIHJldHVybiBmYWxzZTsKICAgICAgaWYoeSA8IHkxIHx8IHkgPiB5MikgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKICAvL1Nob3J0Y3V0cwogIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IGlvbmljLkRvbVV0aWwucmVxdWVzdEFuaW1hdGlvbkZyYW1lOwogIGlvbmljLmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gaW9uaWMuRG9tVXRpbC5jYW5jZWxBbmltYXRpb25GcmFtZTsKICBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlID0gaW9uaWMuRG9tVXRpbC5hbmltYXRpb25GcmFtZVRocm90dGxlOwp9KSh3aW5kb3csIGRvY3VtZW50LCBpb25pYyk7CgovKioKICogaW9uLWV2ZW50cy5qcwogKgogKiBBdXRob3I6IE1heCBMeW5jaCA8bWF4QGRyaWZ0eS5jb20+CiAqCiAqIEZyYW1ld29yayBldmVudHMgaGFuZGxlcyB2YXJpb3VzIG1vYmlsZSBicm93c2VyIGV2ZW50cywgYW5kCiAqIGRldGVjdHMgc3BlY2lhbCBldmVudHMgbGlrZSB0YXAvc3dpcGUvZXRjLiBhbmQgZW1pdHMgdGhlbQogKiBhcyBjdXN0b20gZXZlbnRzIHRoYXQgY2FuIGJlIHVzZWQgaW4gYW4gYXBwLgogKgogKiBQb3J0aW9ucyBsb3ZpbmdseSBhZGFwdGVkIGZyb20gZ2l0aHViLmNvbS9tYWtlci9yYXRjaGV0IGFuZCBnaXRodWIuY29tL2FsZXhnaWJzb24vdGFwLmpzIC0gdGhhbmtzIGd1eXMhCiAqLwoKKGZ1bmN0aW9uKGlvbmljKSB7CgogIC8vIEN1c3RvbSBldmVudCBwb2x5ZmlsbAogIGlvbmljLkN1c3RvbUV2ZW50ID0gKGZ1bmN0aW9uKCkgewogICAgaWYoIHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgPT09ICdmdW5jdGlvbicgKSByZXR1cm4gQ3VzdG9tRXZlbnQ7CgogICAgdmFyIGN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oZXZlbnQsIHBhcmFtcykgewogICAgICB2YXIgZXZ0OwogICAgICBwYXJhbXMgPSBwYXJhbXMgfHwgewogICAgICAgIGJ1YmJsZXM6IGZhbHNlLAogICAgICAgIGNhbmNlbGFibGU6IGZhbHNlLAogICAgICAgIGRldGFpbDogdW5kZWZpbmVkCiAgICAgIH07CiAgICAgIHRyeSB7CiAgICAgICAgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkN1c3RvbUV2ZW50Iik7CiAgICAgICAgZXZ0LmluaXRDdXN0b21FdmVudChldmVudCwgcGFyYW1zLmJ1YmJsZXMsIHBhcmFtcy5jYW5jZWxhYmxlLCBwYXJhbXMuZGV0YWlsKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAvLyBmYWxsYmFjayBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IGNyZWF0ZUV2ZW50KCdDdXN0b21FdmVudCcpCiAgICAgICAgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkV2ZW50Iik7CiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7CiAgICAgICAgICBldnRbcGFyYW1dID0gcGFyYW1zW3BhcmFtXTsKICAgICAgICB9CiAgICAgICAgZXZ0LmluaXRFdmVudChldmVudCwgcGFyYW1zLmJ1YmJsZXMsIHBhcmFtcy5jYW5jZWxhYmxlKTsKICAgICAgfQogICAgICByZXR1cm4gZXZ0OwogICAgfTsKICAgIGN1c3RvbUV2ZW50LnByb3RvdHlwZSA9IHdpbmRvdy5FdmVudC5wcm90b3R5cGU7CiAgICByZXR1cm4gY3VzdG9tRXZlbnQ7CiAgfSkoKTsKCgogIC8qKgogICAqIEBuZ2RvYyB1dGlsaXR5CiAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyCiAgICogQG1vZHVsZSBpb25pYwogICAqLwogIGlvbmljLkV2ZW50Q29udHJvbGxlciA9IHsKICAgIFZJUlRVQUxJWkVEX0VWRU5UUzogWyd0YXAnLCAnc3dpcGUnLCAnc3dpcGVyaWdodCcsICdzd2lwZWxlZnQnLCAnZHJhZycsICdob2xkJywgJ3JlbGVhc2UnXSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkV2ZW50Q29udHJvbGxlciN0cmlnZ2VyCiAgICAgKiBAYWxpYXMgaW9uaWMudHJpZ2dlcgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZXZlbnQgdG8gdHJpZ2dlci4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFRoZSBkYXRhIGZvciB0aGUgZXZlbnQuIEhpbnQ6IHBhc3MgaW4KICAgICAqIGB7dGFyZ2V0OiB0YXJnZXRFbGVtZW50fWAKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IGJ1YmJsZXMgV2hldGhlciB0aGUgZXZlbnQgc2hvdWxkIGJ1YmJsZSB1cCB0aGUgRE9NLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gY2FuY2VsYWJsZSBXaGV0aGVyIHRoZSBldmVudCBzaG91bGQgYmUgY2FuY2VsYWJsZS4KICAgICAqLwogICAgLy8gVHJpZ2dlciBhIG5ldyBldmVudAogICAgdHJpZ2dlcjogZnVuY3Rpb24oZXZlbnRUeXBlLCBkYXRhLCBidWJibGVzLCBjYW5jZWxhYmxlKSB7CiAgICAgIHZhciBldmVudCA9IG5ldyBpb25pYy5DdXN0b21FdmVudChldmVudFR5cGUsIHsKICAgICAgICBkZXRhaWw6IGRhdGEsCiAgICAgICAgYnViYmxlczogISFidWJibGVzLAogICAgICAgIGNhbmNlbGFibGU6ICEhY2FuY2VsYWJsZQogICAgICB9KTsKCiAgICAgIC8vIE1ha2Ugc3VyZSB0byB0cmlnZ2VyIHRoZSBldmVudCBvbiB0aGUgZ2l2ZW4gdGFyZ2V0LCBvciBkaXNwYXRjaCBpdCBmcm9tCiAgICAgIC8vIHRoZSB3aW5kb3cgaWYgd2UgZG9uJ3QgaGF2ZSBhbiBldmVudCB0YXJnZXQKICAgICAgZGF0YSAmJiBkYXRhLnRhcmdldCAmJiBkYXRhLnRhcmdldC5kaXNwYXRjaEV2ZW50ICYmIGRhdGEudGFyZ2V0LmRpc3BhdGNoRXZlbnQoZXZlbnQpIHx8IHdpbmRvdy5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5FdmVudENvbnRyb2xsZXIjb24KICAgICAqIEBhbGlhcyBpb25pYy5vbgogICAgICogQGRlc2NyaXB0aW9uIExpc3RlbiB0byBhbiBldmVudCBvbiBhbiBlbGVtZW50LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGV2ZW50IHRvIGxpc3RlbiBmb3IuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgbGlzdGVuZXIgdG8gYmUgY2FsbGVkLgogICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IG9uLgogICAgICovCiAgICBvbjogZnVuY3Rpb24odHlwZSwgY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgdmFyIGUgPSBlbGVtZW50IHx8IHdpbmRvdzsKCiAgICAgIC8vIEJpbmQgYSBnZXN0dXJlIGlmIGl0J3MgYSB2aXJ0dWFsIGV2ZW50CiAgICAgIGZvcih2YXIgaSA9IDAsIGogPSB0aGlzLlZJUlRVQUxJWkVEX0VWRU5UUy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICBpZih0eXBlID09IHRoaXMuVklSVFVBTElaRURfRVZFTlRTW2ldKSB7CiAgICAgICAgICB2YXIgZ2VzdHVyZSA9IG5ldyBpb25pYy5HZXN0dXJlKGVsZW1lbnQpOwogICAgICAgICAgZ2VzdHVyZS5vbih0eXBlLCBjYWxsYmFjayk7CiAgICAgICAgICByZXR1cm4gZ2VzdHVyZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE90aGVyd2lzZSBiaW5kIGEgbm9ybWFsIGV2ZW50CiAgICAgIGUuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBjYWxsYmFjayk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyI29mZgogICAgICogQGFsaWFzIGlvbmljLm9mZgogICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lci4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjawogICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50CiAgICAgKi8KICAgIG9mZjogZnVuY3Rpb24odHlwZSwgY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGNhbGxiYWNrKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5FdmVudENvbnRyb2xsZXIjb25HZXN0dXJlCiAgICAgKiBAYWxpYXMgaW9uaWMub25HZXN0dXJlCiAgICAgKiBAZGVzY3JpcHRpb24gQWRkIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIGdlc3R1cmUgb24gYW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBBdmFpbGFibGUgZXZlbnRUeXBlcyAoZnJvbSBbaGFtbWVyLmpzXShodHRwOi8vZWlnaHRtZWRpYS5naXRodWIuaW8vaGFtbWVyLmpzLykpOgogICAgICoKICAgICAqIGBob2xkYCwgYHRhcGAsIGBkb3VibGV0YXBgLCBgZHJhZ2AsIGBkcmFnc3RhcnRgLCBgZHJhZ2VuZGAsIGBkcmFndXBgLCBgZHJhZ2Rvd25gLCA8YnIvPgogICAgICogYGRyYWdsZWZ0YCwgYGRyYWdyaWdodGAsIGBzd2lwZWAsIGBzd2lwZXVwYCwgYHN3aXBlZG93bmAsIGBzd2lwZWxlZnRgLCBgc3dpcGVyaWdodGAsIDxici8+CiAgICAgKiBgdHJhbnNmb3JtYCwgYHRyYW5zZm9ybXN0YXJ0YCwgYHRyYW5zZm9ybWVuZGAsIGByb3RhdGVgLCBgcGluY2hgLCBgcGluY2hpbmAsIGBwaW5jaG91dGAsIDwvYnI+CiAgICAgKiBgdG91Y2hgLCBgcmVsZWFzZWAKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnRUeXBlIFRoZSBnZXN0dXJlIGV2ZW50IHRvIGxpc3RlbiBmb3IuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGUpfSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBnZXN0dXJlCiAgICAgKiBoYXBwZW5zLgogICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IFRoZSBhbmd1bGFyIGVsZW1lbnQgdG8gbGlzdGVuIGZvciB0aGUgZXZlbnQgb24uCiAgICAgKi8KICAgIG9uR2VzdHVyZTogZnVuY3Rpb24odHlwZSwgY2FsbGJhY2ssIGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgdmFyIGdlc3R1cmUgPSBuZXcgaW9uaWMuR2VzdHVyZShlbGVtZW50LCBvcHRpb25zKTsKICAgICAgZ2VzdHVyZS5vbih0eXBlLCBjYWxsYmFjayk7CiAgICAgIHJldHVybiBnZXN0dXJlOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLkV2ZW50Q29udHJvbGxlciNvZmZHZXN0dXJlCiAgICAgKiBAYWxpYXMgaW9uaWMub2ZmR2VzdHVyZQogICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBnZXN0dXJlIG9uIGFuIGVsZW1lbnQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnRUeXBlIFRoZSBnZXN0dXJlIGV2ZW50LgogICAgICogQHBhcmFtIHtmdW5jdGlvbihlKX0gY2FsbGJhY2sgVGhlIGxpc3RlbmVyIHRoYXQgd2FzIGFkZGVkIGVhcmxpZXIuCiAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgdGhlIGxpc3RlbmVyIHdhcyBhZGRlZCBvbi4KICAgICAqLwogICAgb2ZmR2VzdHVyZTogZnVuY3Rpb24oZ2VzdHVyZSwgdHlwZSwgY2FsbGJhY2spIHsKICAgICAgZ2VzdHVyZS5vZmYodHlwZSwgY2FsbGJhY2spOwogICAgfSwKCiAgICBoYW5kbGVQb3BTdGF0ZTogZnVuY3Rpb24oZXZlbnQpIHt9CiAgfTsKCgogIC8vIE1hcCBzb21lIGNvbnZlbmllbnQgdG9wLWxldmVsIGZ1bmN0aW9ucyBmb3IgZXZlbnQgaGFuZGxpbmcKICBpb25pYy5vbiA9IGZ1bmN0aW9uKCkgeyBpb25pYy5FdmVudENvbnRyb2xsZXIub24uYXBwbHkoaW9uaWMuRXZlbnRDb250cm9sbGVyLCBhcmd1bWVudHMpOyB9OwogIGlvbmljLm9mZiA9IGZ1bmN0aW9uKCkgeyBpb25pYy5FdmVudENvbnRyb2xsZXIub2ZmLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlciwgYXJndW1lbnRzKTsgfTsKICBpb25pYy50cmlnZ2VyID0gaW9uaWMuRXZlbnRDb250cm9sbGVyLnRyaWdnZXI7Ly9mdW5jdGlvbigpIHsgaW9uaWMuRXZlbnRDb250cm9sbGVyLnRyaWdnZXIuYXBwbHkoaW9uaWMuRXZlbnRDb250cm9sbGVyLnRyaWdnZXIsIGFyZ3VtZW50cyk7IH07CiAgaW9uaWMub25HZXN0dXJlID0gZnVuY3Rpb24oKSB7IHJldHVybiBpb25pYy5FdmVudENvbnRyb2xsZXIub25HZXN0dXJlLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlci5vbkdlc3R1cmUsIGFyZ3VtZW50cyk7IH07CiAgaW9uaWMub2ZmR2VzdHVyZSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gaW9uaWMuRXZlbnRDb250cm9sbGVyLm9mZkdlc3R1cmUuYXBwbHkoaW9uaWMuRXZlbnRDb250cm9sbGVyLm9mZkdlc3R1cmUsIGFyZ3VtZW50cyk7IH07Cgp9KSh3aW5kb3cuaW9uaWMpOwoKLyoqCiAgKiBTaW1wbGUgZ2VzdHVyZSBjb250cm9sbGVycyB3aXRoIHNvbWUgY29tbW9uIGdlc3R1cmVzIHRoYXQgZW1pdAogICogZ2VzdHVyZSBldmVudHMuCiAgKgogICogUG9ydGVkIGZyb20gZ2l0aHViLmNvbS9FaWdodE1lZGlhL2hhbW1lci5qcyBHZXN0dXJlcyAtIHRoYW5rcyEKICAqLwooZnVuY3Rpb24oaW9uaWMpIHsKCiAgLyoqCiAgICogaW9uaWMuR2VzdHVyZXMKICAgKiB1c2UgdGhpcyB0byBjcmVhdGUgaW5zdGFuY2VzCiAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIGVsZW1lbnQKICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgb3B0aW9ucwogICAqIEByZXR1cm5zIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBpb25pYy5HZXN0dXJlID0gZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBpb25pYy5HZXN0dXJlcy5JbnN0YW5jZShlbGVtZW50LCBvcHRpb25zIHx8IHt9KTsKICB9OwoKICBpb25pYy5HZXN0dXJlcyA9IHt9OwoKICAvLyBkZWZhdWx0IHNldHRpbmdzCiAgaW9uaWMuR2VzdHVyZXMuZGVmYXVsdHMgPSB7CiAgICAvLyBhZGQgY3NzIHRvIHRoZSBlbGVtZW50IHRvIHByZXZlbnQgdGhlIGJyb3dzZXIgZnJvbSBkb2luZwogICAgLy8gaXRzIG5hdGl2ZSBiZWhhdmlvci4gdGhpcyBkb2VzbnQgcHJldmVudCB0aGUgc2Nyb2xsaW5nLAogICAgLy8gYnV0IGNhbmNlbHMgdGhlIGNvbnRleHRtZW51LCB0YXAgaGlnaGxpZ2h0aW5nIGV0YwogICAgLy8gc2V0IHRvIGZhbHNlIHRvIGRpc2FibGUgdGhpcwogICAgc3RvcF9icm93c2VyX2JlaGF2aW9yOiAnZGlzYWJsZS11c2VyLWJlaGF2aW9yJwogIH07CgogIC8vIGRldGVjdCB0b3VjaGV2ZW50cwogIGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTID0gd2luZG93Lm5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCB8fCB3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQ7CiAgaW9uaWMuR2VzdHVyZXMuSEFTX1RPVUNIRVZFTlRTID0gKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdyk7CgogIC8vIGRvbnQgdXNlIG1vdXNlZXZlbnRzIG9uIG1vYmlsZSBkZXZpY2VzCiAgaW9uaWMuR2VzdHVyZXMuTU9CSUxFX1JFR0VYID0gL21vYmlsZXx0YWJsZXR8aXAoYWR8aG9uZXxvZCl8YW5kcm9pZHxzaWxrL2k7CiAgaW9uaWMuR2VzdHVyZXMuTk9fTU9VU0VFVkVOVFMgPSBpb25pYy5HZXN0dXJlcy5IQVNfVE9VQ0hFVkVOVFMgJiYgd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goaW9uaWMuR2VzdHVyZXMuTU9CSUxFX1JFR0VYKTsKCiAgLy8gZXZlbnR0eXBlcyBwZXIgdG91Y2hldmVudCAoc3RhcnQsIG1vdmUsIGVuZCkKICAvLyBhcmUgZmlsbGVkIGJ5IGlvbmljLkdlc3R1cmVzLmV2ZW50LmRldGVybWluZUV2ZW50VHlwZXMgb24gc2V0dXAKICBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFUyA9IHt9OwoKICAvLyBkaXJlY3Rpb24gZGVmaW5lcwogIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9ET1dOID0gJ2Rvd24nOwogIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9MRUZUID0gJ2xlZnQnOwogIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9VUCA9ICd1cCc7CiAgaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1JJR0hUID0gJ3JpZ2h0JzsKCiAgLy8gcG9pbnRlciB0eXBlCiAgaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRSA9ICdtb3VzZSc7CiAgaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9UT1VDSCA9ICd0b3VjaCc7CiAgaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9QRU4gPSAncGVuJzsKCiAgLy8gdG91Y2ggZXZlbnQgZGVmaW5lcwogIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUID0gJ3N0YXJ0JzsKICBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFID0gJ21vdmUnOwogIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCA9ICdlbmQnOwoKICAvLyBoYW1tZXIgZG9jdW1lbnQgd2hlcmUgdGhlIGJhc2UgZXZlbnRzIGFyZSBhZGRlZCBhdAogIGlvbmljLkdlc3R1cmVzLkRPQ1VNRU5UID0gd2luZG93LmRvY3VtZW50OwoKICAvLyBwbHVnaW5zIG5hbWVzcGFjZQogIGlvbmljLkdlc3R1cmVzLnBsdWdpbnMgPSB7fTsKCiAgLy8gaWYgdGhlIHdpbmRvdyBldmVudHMgYXJlIHNldC4uLgogIGlvbmljLkdlc3R1cmVzLlJFQURZID0gZmFsc2U7CgogIC8qKgogICAqIHNldHVwIGV2ZW50cyB0byBkZXRlY3QgZ2VzdHVyZXMgb24gdGhlIGRvY3VtZW50CiAgICovCiAgZnVuY3Rpb24gc2V0dXAoKSB7CiAgICBpZihpb25pYy5HZXN0dXJlcy5SRUFEWSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gZmluZCB3aGF0IGV2ZW50dHlwZXMgd2UgYWRkIGxpc3RlbmVycyB0bwogICAgaW9uaWMuR2VzdHVyZXMuZXZlbnQuZGV0ZXJtaW5lRXZlbnRUeXBlcygpOwoKICAgIC8vIFJlZ2lzdGVyIGFsbCBnZXN0dXJlcyBpbnNpZGUgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMKICAgIGZvcih2YXIgbmFtZSBpbiBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcykgewogICAgICBpZihpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5yZWdpc3Rlcihpb25pYy5HZXN0dXJlcy5nZXN0dXJlc1tuYW1lXSk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBBZGQgdG91Y2ggZXZlbnRzIG9uIHRoZSBkb2N1bWVudAogICAgaW9uaWMuR2VzdHVyZXMuZXZlbnQub25Ub3VjaChpb25pYy5HZXN0dXJlcy5ET0NVTUVOVCwgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRSwgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmRldGVjdCk7CiAgICBpb25pYy5HZXN0dXJlcy5ldmVudC5vblRvdWNoKGlvbmljLkdlc3R1cmVzLkRPQ1VNRU5ULCBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQsIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5kZXRlY3QpOwoKICAgIC8vIGlvbmljLkdlc3R1cmVzIGlzIHJlYWR5Li4uIQogICAgaW9uaWMuR2VzdHVyZXMuUkVBRFkgPSB0cnVlOwogIH0KCiAgLyoqCiAgICogY3JlYXRlIG5ldyBoYW1tZXIgaW5zdGFuY2UKICAgKiBhbGwgbWV0aG9kcyBzaG91bGQgcmV0dXJuIHRoZSBpbnN0YW5jZSBpdHNlbGYsIHNvIGl0IGlzIGNoYWluYWJsZS4KICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgICAgIGVsZW1lbnQKICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgICAgIFtvcHRpb25zPXt9XQogICAqIEByZXR1cm5zIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0KICAgKiBAbmFtZSBHZXN0dXJlLkluc3RhbmNlCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgaW9uaWMuR2VzdHVyZXMuSW5zdGFuY2UgPSBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgLy8gQSBudWxsIGVsZW1lbnQgd2FzIHBhc3NlZCBpbnRvIHRoZSBpbnN0YW5jZSwgd2hpY2ggbWVhbnMKICAgIC8vIHdoYXRldmVyIGxvb2t1cCB3YXMgZG9uZSB0byBmaW5kIHRoaXMgZWxlbWVudCBmYWlsZWQgdG8gZmluZCBpdAogICAgLy8gc28gd2UgY2FuJ3QgbGlzdGVuIGZvciBldmVudHMgb24gaXQuCiAgICBpZihlbGVtZW50ID09PSBudWxsKSB7CiAgICAgIHZvaWQgMDsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIHNldHVwIGlvbmljLkdlc3R1cmVzSlMgd2luZG93IGV2ZW50cyBhbmQgcmVnaXN0ZXIgYWxsIGdlc3R1cmVzCiAgICAvLyB0aGlzIGFsc28gc2V0cyB1cCB0aGUgZGVmYXVsdCBvcHRpb25zCiAgICBzZXR1cCgpOwoKICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CgogICAgLy8gc3RhcnQvc3RvcCBkZXRlY3Rpb24gb3B0aW9uCiAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgIC8vIG1lcmdlIG9wdGlvbnMKICAgIHRoaXMub3B0aW9ucyA9IGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCgKICAgICAgICBpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoe30sIGlvbmljLkdlc3R1cmVzLmRlZmF1bHRzKSwKICAgICAgICBvcHRpb25zIHx8IHt9KTsKCiAgICAvLyBhZGQgc29tZSBjc3MgdG8gdGhlIGVsZW1lbnQgdG8gcHJldmVudCB0aGUgYnJvd3NlciBmcm9tIGRvaW5nIGl0cyBuYXRpdmUgYmVoYXZvaXIKICAgIGlmKHRoaXMub3B0aW9ucy5zdG9wX2Jyb3dzZXJfYmVoYXZpb3IpIHsKICAgICAgaW9uaWMuR2VzdHVyZXMudXRpbHMuc3RvcERlZmF1bHRCcm93c2VyQmVoYXZpb3IodGhpcy5lbGVtZW50LCB0aGlzLm9wdGlvbnMuc3RvcF9icm93c2VyX2JlaGF2aW9yKTsKICAgIH0KCiAgICAvLyBzdGFydCBkZXRlY3Rpb24gb24gdG91Y2hzdGFydAogICAgaW9uaWMuR2VzdHVyZXMuZXZlbnQub25Ub3VjaChlbGVtZW50LCBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVCwgZnVuY3Rpb24oZXYpIHsKICAgICAgaWYoc2VsZi5lbmFibGVkKSB7CiAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLnN0YXJ0RGV0ZWN0KHNlbGYsIGV2KTsKICAgICAgfQogICAgfSk7CgogICAgLy8gcmV0dXJuIGluc3RhbmNlCiAgICByZXR1cm4gdGhpczsKICB9OwoKCiAgaW9uaWMuR2VzdHVyZXMuSW5zdGFuY2UucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgKiBiaW5kIGV2ZW50cyB0byB0aGUgaW5zdGFuY2UKICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgZ2VzdHVyZQogICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgICBoYW5kbGVyCiAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgKi8KICAgIG9uOiBmdW5jdGlvbiBvbkV2ZW50KGdlc3R1cmUsIGhhbmRsZXIpewogICAgICB2YXIgZ2VzdHVyZXMgPSBnZXN0dXJlLnNwbGl0KCcgJyk7CiAgICAgIGZvcih2YXIgdD0wOyB0PGdlc3R1cmVzLmxlbmd0aDsgdCsrKSB7CiAgICAgICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZ2VzdHVyZXNbdF0sIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgoKICAgIC8qKgogICAgICogdW5iaW5kIGV2ZW50cyB0byB0aGUgaW5zdGFuY2UKICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgZ2VzdHVyZQogICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgICBoYW5kbGVyCiAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgKi8KICAgIG9mZjogZnVuY3Rpb24gb2ZmRXZlbnQoZ2VzdHVyZSwgaGFuZGxlcil7CiAgICAgIHZhciBnZXN0dXJlcyA9IGdlc3R1cmUuc3BsaXQoJyAnKTsKICAgICAgZm9yKHZhciB0PTA7IHQ8Z2VzdHVyZXMubGVuZ3RoOyB0KyspIHsKICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihnZXN0dXJlc1t0XSwgaGFuZGxlciwgZmFsc2UpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgLyoqCiAgICAgKiB0cmlnZ2VyIGdlc3R1cmUgZXZlbnQKICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgZ2VzdHVyZQogICAgICogQHBhcmFtICAge09iamVjdH0gICAgICBldmVudERhdGEKICAgICAqIEByZXR1cm5zIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0KICAgICAqLwogICAgdHJpZ2dlcjogZnVuY3Rpb24gdHJpZ2dlckV2ZW50KGdlc3R1cmUsIGV2ZW50RGF0YSl7CiAgICAgIC8vIGNyZWF0ZSBET00gZXZlbnQKICAgICAgdmFyIGV2ZW50ID0gaW9uaWMuR2VzdHVyZXMuRE9DVU1FTlQuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7CiAgICAgIGV2ZW50LmluaXRFdmVudChnZXN0dXJlLCB0cnVlLCB0cnVlKTsKICAgICAgZXZlbnQuZ2VzdHVyZSA9IGV2ZW50RGF0YTsKCiAgICAgIC8vIHRyaWdnZXIgb24gdGhlIHRhcmdldCBpZiBpdCBpcyBpbiB0aGUgaW5zdGFuY2UgZWxlbWVudCwKICAgICAgLy8gdGhpcyBpcyBmb3IgZXZlbnQgZGVsZWdhdGlvbiB0cmlja3MKICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgIGlmKGlvbmljLkdlc3R1cmVzLnV0aWxzLmhhc1BhcmVudChldmVudERhdGEudGFyZ2V0LCBlbGVtZW50KSkgewogICAgICAgIGVsZW1lbnQgPSBldmVudERhdGEudGFyZ2V0OwogICAgICB9CgogICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgoKICAgIC8qKgogICAgICogZW5hYmxlIG9mIGRpc2FibGUgaGFtbWVyLmpzIGRldGVjdGlvbgogICAgICogQHBhcmFtICAge0Jvb2xlYW59ICAgc3RhdGUKICAgICAqIEByZXR1cm5zIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0KICAgICAqLwogICAgZW5hYmxlOiBmdW5jdGlvbiBlbmFibGUoc3RhdGUpIHsKICAgICAgdGhpcy5lbmFibGVkID0gc3RhdGU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH07CgogIC8qKgogICAqIHRoaXMgaG9sZHMgdGhlIGxhc3QgbW92ZSBldmVudCwKICAgKiB1c2VkIHRvIGZpeCBlbXB0eSB0b3VjaGVuZCBpc3N1ZQogICAqIHNlZSB0aGUgb25Ub3VjaCBldmVudCBmb3IgYW4gZXhwbGFuYXRpb24KICAgKiB0eXBlIHtPYmplY3R9CiAgICovCiAgdmFyIGxhc3RfbW92ZV9ldmVudCA9IG51bGw7CgoKICAvKioKICAgKiB3aGVuIHRoZSBtb3VzZSBpcyBob2xkIGRvd24sIHRoaXMgaXMgdHJ1ZQogICAqIHR5cGUge0Jvb2xlYW59CiAgICovCiAgdmFyIGVuYWJsZV9kZXRlY3QgPSBmYWxzZTsKCgogIC8qKgogICAqIHdoZW4gdG91Y2ggZXZlbnRzIGhhdmUgYmVlbiBmaXJlZCwgdGhpcyBpcyB0cnVlCiAgICogdHlwZSB7Qm9vbGVhbn0KICAgKi8KICB2YXIgdG91Y2hfdHJpZ2dlcmVkID0gZmFsc2U7CgoKICBpb25pYy5HZXN0dXJlcy5ldmVudCA9IHsKICAgIC8qKgogICAgICogc2ltcGxlIGFkZEV2ZW50TGlzdGVuZXIKICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgICAgdHlwZQogICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgICAgIGhhbmRsZXIKICAgICAqLwogICAgYmluZERvbTogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgaGFuZGxlcikgewogICAgICB2YXIgdHlwZXMgPSB0eXBlLnNwbGl0KCcgJyk7CiAgICAgIGZvcih2YXIgdD0wOyB0PHR5cGVzLmxlbmd0aDsgdCsrKSB7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGVzW3RdLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICogdG91Y2ggZXZlbnRzIHdpdGggbW91c2UgZmFsbGJhY2sKICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgICAgZXZlbnRUeXBlICAgICAgICBsaWtlIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkUKICAgICAqIEBwYXJhbSAgIHtGdW5jdGlvbn0gICAgICBoYW5kbGVyCiAgICAgKi8KICAgIG9uVG91Y2g6IGZ1bmN0aW9uIG9uVG91Y2goZWxlbWVudCwgZXZlbnRUeXBlLCBoYW5kbGVyKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIHRoaXMuYmluZERvbShlbGVtZW50LCBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFU1tldmVudFR5cGVdLCBmdW5jdGlvbiBiaW5kRG9tT25Ub3VjaChldikgewogICAgICAgIHZhciBzb3VyY2VFdmVudFR5cGUgPSBldi50eXBlLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIC8vIG9ubW91c2V1cCwgYnV0IHdoZW4gdG91Y2hlbmQgaGFzIGJlZW4gZmlyZWQgd2UgZG8gbm90aGluZy4KICAgICAgICAvLyB0aGlzIGlzIGZvciB0b3VjaGRldmljZXMgd2hpY2ggYWxzbyBmaXJlIGEgbW91c2V1cCBvbiB0b3VjaGVuZAogICAgICAgIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiB0b3VjaF90cmlnZ2VyZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIG1vdXNlYnV0dG9uIG11c3QgYmUgZG93biBvciBhIHRvdWNoIGV2ZW50CiAgICAgICAgZWxzZSBpZiggc291cmNlRXZlbnRUeXBlLm1hdGNoKC90b3VjaC8pIHx8ICAgLy8gdG91Y2ggZXZlbnRzIGFyZSBhbHdheXMgb24gc2NyZWVuCiAgICAgICAgICBzb3VyY2VFdmVudFR5cGUubWF0Y2goL3BvaW50ZXJkb3duLykgfHwgLy8gcG9pbnRlcmV2ZW50cyB0b3VjaAogICAgICAgICAgKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiBldi53aGljaCA9PT0gMSkgICAvLyBtb3VzZSBpcyBwcmVzc2VkCiAgICAgICAgICApewogICAgICAgICAgICBlbmFibGVfZGV0ZWN0ID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgLy8gbW91c2UgaXNuJ3QgcHJlc3NlZAogICAgICAgIGVsc2UgaWYoc291cmNlRXZlbnRUeXBlLm1hdGNoKC9tb3VzZS8pICYmIGV2LndoaWNoICE9PSAxKSB7CiAgICAgICAgICBlbmFibGVfZGV0ZWN0ID0gZmFsc2U7CiAgICAgICAgfQoKCiAgICAgICAgLy8gd2UgYXJlIGluIGEgdG91Y2ggZXZlbnQsIHNldCB0aGUgdG91Y2ggdHJpZ2dlcmVkIGJvb2wgdG8gdHJ1ZSwKICAgICAgICAvLyB0aGlzIGZvciB0aGUgY29uZmxpY3RzIHRoYXQgbWF5IG9jY3VyIG9uIGlvcyBhbmQgYW5kcm9pZAogICAgICAgIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2h8cG9pbnRlci8pKSB7CiAgICAgICAgICB0b3VjaF90cmlnZ2VyZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gY291bnQgdGhlIHRvdGFsIHRvdWNoZXMgb24gdGhlIHNjcmVlbgogICAgICAgIHZhciBjb3VudF90b3VjaGVzID0gMDsKCiAgICAgICAgLy8gd2hlbiB0b3VjaCBoYXMgYmVlbiB0cmlnZ2VyZWQgaW4gdGhpcyBkZXRlY3Rpb24gc2Vzc2lvbgogICAgICAgIC8vIGFuZCB3ZSBhcmUgbm93IGhhbmRsaW5nIGEgbW91c2UgZXZlbnQsIHdlIHN0b3AgdGhhdCB0byBwcmV2ZW50IGNvbmZsaWN0cwogICAgICAgIGlmKGVuYWJsZV9kZXRlY3QpIHsKICAgICAgICAgIC8vIHVwZGF0ZSBwb2ludGVyZXZlbnQKICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTICYmIGV2ZW50VHlwZSAhPSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgY291bnRfdG91Y2hlcyA9IGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC51cGRhdGVQb2ludGVyKGV2ZW50VHlwZSwgZXYpOwogICAgICAgICAgfQogICAgICAgICAgLy8gdG91Y2gKICAgICAgICAgIGVsc2UgaWYoc291cmNlRXZlbnRUeXBlLm1hdGNoKC90b3VjaC8pKSB7CiAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBldi50b3VjaGVzLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIC8vIG1vdXNlCiAgICAgICAgICBlbHNlIGlmKCF0b3VjaF90cmlnZ2VyZWQpIHsKICAgICAgICAgICAgY291bnRfdG91Y2hlcyA9IHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdXAvKSA/IDAgOiAxOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGlmIHdlIGFyZSBpbiBhIGVuZCBldmVudCwgYnV0IHdoZW4gd2UgcmVtb3ZlIG9uZSB0b3VjaCBhbmQKICAgICAgICAgIC8vIHdlIHN0aWxsIGhhdmUgZW5vdWdoLCBzZXQgZXZlbnRUeXBlIHRvIG1vdmUKICAgICAgICAgIGlmKGNvdW50X3RvdWNoZXMgPiAwICYmIGV2ZW50VHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIG5vIHRvdWNoZXMsIGZvcmNlIHRoZSBlbmQgZXZlbnQKICAgICAgICAgIGVsc2UgaWYoIWNvdW50X3RvdWNoZXMpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHN0b3JlIHRoZSBsYXN0IG1vdmUgZXZlbnQKICAgICAgICAgIGlmKGNvdW50X3RvdWNoZXMgfHwgbGFzdF9tb3ZlX2V2ZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgIGxhc3RfbW92ZV9ldmVudCA9IGV2OwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHRyaWdnZXIgdGhlIGhhbmRsZXIKICAgICAgICAgIGhhbmRsZXIuY2FsbChpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24sIHNlbGYuY29sbGVjdEV2ZW50RGF0YShlbGVtZW50LCBldmVudFR5cGUsIHNlbGYuZ2V0VG91Y2hMaXN0KGxhc3RfbW92ZV9ldmVudCwgZXZlbnRUeXBlKSwgZXYpKTsKCiAgICAgICAgICAvLyByZW1vdmUgcG9pbnRlcmV2ZW50IGZyb20gbGlzdAogICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuSEFTX1BPSU5URVJFVkVOVFMgJiYgZXZlbnRUeXBlID09IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCkgewogICAgICAgICAgICBjb3VudF90b3VjaGVzID0gaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50LnVwZGF0ZVBvaW50ZXIoZXZlbnRUeXBlLCBldik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL2RlYnVnKHNvdXJjZUV2ZW50VHlwZSArIiAiKyBldmVudFR5cGUpOwoKICAgICAgICAvLyBvbiB0aGUgZW5kIHdlIHJlc2V0IGV2ZXJ5dGhpbmcKICAgICAgICBpZighY291bnRfdG91Y2hlcykgewogICAgICAgICAgbGFzdF9tb3ZlX2V2ZW50ID0gbnVsbDsKICAgICAgICAgIGVuYWJsZV9kZXRlY3QgPSBmYWxzZTsKICAgICAgICAgIHRvdWNoX3RyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50LnJlc2V0KCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgoKICAgIC8qKgogICAgICogd2UgaGF2ZSBkaWZmZXJlbnQgZXZlbnRzIGZvciBlYWNoIGRldmljZS9icm93c2VyCiAgICAgKiBkZXRlcm1pbmUgd2hhdCB3ZSBuZWVkIGFuZCBzZXQgdGhlbSBpbiB0aGUgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVMgY29uc3RhbnQKICAgICAqLwogICAgZGV0ZXJtaW5lRXZlbnRUeXBlczogZnVuY3Rpb24gZGV0ZXJtaW5lRXZlbnRUeXBlcygpIHsKICAgICAgLy8gZGV0ZXJtaW5lIHRoZSBldmVudHR5cGUgd2Ugd2FudCB0byBzZXQKICAgICAgdmFyIHR5cGVzOwoKICAgICAgLy8gcG9pbnRlckV2ZW50cyBtYWdpYwogICAgICBpZihpb25pYy5HZXN0dXJlcy5IQVNfUE9JTlRFUkVWRU5UUykgewogICAgICAgIHR5cGVzID0gaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50LmdldEV2ZW50cygpOwogICAgICB9CiAgICAgIC8vIG9uIEFuZHJvaWQsIGlPUywgYmxhY2tiZXJyeSwgd2luZG93cyBtb2JpbGUgd2UgZG9udCB3YW50IGFueSBtb3VzZWV2ZW50cwogICAgICBlbHNlIGlmKGlvbmljLkdlc3R1cmVzLk5PX01PVVNFRVZFTlRTKSB7CiAgICAgICAgdHlwZXMgPSBbCiAgICAgICAgICAndG91Y2hzdGFydCcsCiAgICAgICAgICAndG91Y2htb3ZlJywKICAgICAgICAgICd0b3VjaGVuZCB0b3VjaGNhbmNlbCddOwogICAgICB9CiAgICAgIC8vIGZvciBub24gcG9pbnRlciBldmVudHMgYnJvd3NlcnMgYW5kIG1peGVkIGJyb3dzZXJzLAogICAgICAvLyBsaWtlIGNocm9tZSBvbiB3aW5kb3dzOCB0b3VjaCBsYXB0b3AKICAgICAgZWxzZSB7CiAgICAgICAgdHlwZXMgPSBbCiAgICAgICAgICAndG91Y2hzdGFydCBtb3VzZWRvd24nLAogICAgICAgICAgJ3RvdWNobW92ZSBtb3VzZW1vdmUnLAogICAgICAgICAgJ3RvdWNoZW5kIHRvdWNoY2FuY2VsIG1vdXNldXAnXTsKICAgICAgfQoKICAgICAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVNbaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlRdICA9IHR5cGVzWzBdOwogICAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFU1tpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFXSAgID0gdHlwZXNbMV07CiAgICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX1RZUEVTW2lvbmljLkdlc3R1cmVzLkVWRU5UX0VORF0gICAgPSB0eXBlc1syXTsKICAgIH0sCgoKICAgIC8qKgogICAgICogY3JlYXRlIHRvdWNobGlzdCBkZXBlbmRpbmcgb24gdGhlIGV2ZW50CiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBldgogICAgICogQHBhcmFtICAge1N0cmluZ30gICAgZXZlbnRUeXBlICAgdXNlZCBieSB0aGUgZmFrZW11bHRpdG91Y2ggcGx1Z2luCiAgICAgKi8KICAgIGdldFRvdWNoTGlzdDogZnVuY3Rpb24gZ2V0VG91Y2hMaXN0KGV2LyosIGV2ZW50VHlwZSovKSB7CiAgICAgIC8vIGdldCB0aGUgZmFrZSBwb2ludGVyRXZlbnQgdG91Y2hsaXN0CiAgICAgIGlmKGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTKSB7CiAgICAgICAgcmV0dXJuIGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC5nZXRUb3VjaExpc3QoKTsKICAgICAgfQogICAgICAvLyBnZXQgdGhlIHRvdWNobGlzdAogICAgICBlbHNlIGlmKGV2LnRvdWNoZXMpIHsKICAgICAgICByZXR1cm4gZXYudG91Y2hlczsKICAgICAgfQogICAgICAvLyBtYWtlIGZha2UgdG91Y2hsaXN0IGZyb20gbW91c2UgcG9zaXRpb24KICAgICAgZWxzZSB7CiAgICAgICAgZXYuaWRlbnRpZmllciA9IDE7CiAgICAgICAgcmV0dXJuIFtldl07CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICogY29sbGVjdCBldmVudCBkYXRhIGZvciBpb25pYy5HZXN0dXJlcyBqcwogICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIGVsZW1lbnQKICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBldmVudFR5cGUgICAgICAgIGxpa2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRQogICAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgIGV2ZW50RGF0YQogICAgICovCiAgICBjb2xsZWN0RXZlbnREYXRhOiBmdW5jdGlvbiBjb2xsZWN0RXZlbnREYXRhKGVsZW1lbnQsIGV2ZW50VHlwZSwgdG91Y2hlcywgZXYpIHsKCiAgICAgIC8vIGZpbmQgb3V0IHBvaW50ZXJUeXBlCiAgICAgIHZhciBwb2ludGVyVHlwZSA9IGlvbmljLkdlc3R1cmVzLlBPSU5URVJfVE9VQ0g7CiAgICAgIGlmKGV2LnR5cGUubWF0Y2goL21vdXNlLykgfHwgaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50Lm1hdGNoVHlwZShpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFLCBldikpIHsKICAgICAgICBwb2ludGVyVHlwZSA9IGlvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0U7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgY2VudGVyICAgICAgOiBpb25pYy5HZXN0dXJlcy51dGlscy5nZXRDZW50ZXIodG91Y2hlcyksCiAgICAgICAgICAgICAgICAgICAgdGltZVN0YW1wICAgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKICAgICAgICAgICAgICAgICAgICB0YXJnZXQgICAgICA6IGV2LnRhcmdldCwKICAgICAgICAgICAgICAgICAgICB0b3VjaGVzICAgICA6IHRvdWNoZXMsCiAgICAgICAgICAgICAgICAgICAgZXZlbnRUeXBlICAgOiBldmVudFR5cGUsCiAgICAgICAgICAgICAgICAgICAgcG9pbnRlclR5cGUgOiBwb2ludGVyVHlwZSwKICAgICAgICAgICAgICAgICAgICBzcmNFdmVudCAgICA6IGV2LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBwcmV2ZW50IHRoZSBicm93c2VyIGRlZmF1bHQgYWN0aW9ucwogICAgICAgICAgICAgICAgICAgICAqIG1vc3RseSB1c2VkIHRvIGRpc2FibGUgc2Nyb2xsaW5nIG9mIHRoZSBicm93c2VyCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5zcmNFdmVudC5wcmV2ZW50TWFuaXB1bGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3JjRXZlbnQucHJldmVudE1hbmlwdWxhdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3JjRXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy90aGlzLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogc3RvcCBidWJibGluZyB0aGUgZXZlbnQgdXAgdG8gaXRzIHBhcmVudHMKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBpbW1lZGlhdGVseSBzdG9wIGdlc3R1cmUgZGV0ZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogbWlnaHQgYmUgdXNlZnVsIGFmdGVyIGEgc3dpcGUgd2FzIGRldGVjdGVkCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybiB7Kn0KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBzdG9wRGV0ZWN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uc3RvcERldGVjdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9OwoKICBpb25pYy5HZXN0dXJlcy5Qb2ludGVyRXZlbnQgPSB7CiAgICAvKioKICAgICAqIGhvbGRzIGFsbCBwb2ludGVycwogICAgICogdHlwZSB7T2JqZWN0fQogICAgICovCiAgICBwb2ludGVyczoge30sCgogICAgLyoqCiAgICAgKiBnZXQgYSBsaXN0IG9mIHBvaW50ZXJzCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9ICAgICB0b3VjaGxpc3QKICAgICAqLwogICAgZ2V0VG91Y2hMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgdG91Y2hsaXN0ID0gW107CgogICAgICAvLyB3ZSBjYW4gdXNlIGZvckVhY2ggc2luY2UgcG9pbnRlckV2ZW50cyBvbmx5IGlzIGluIElFMTAKICAgICAgT2JqZWN0LmtleXMoc2VsZi5wb2ludGVycykuc29ydCgpLmZvckVhY2goZnVuY3Rpb24oaWQpIHsKICAgICAgICB0b3VjaGxpc3QucHVzaChzZWxmLnBvaW50ZXJzW2lkXSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdG91Y2hsaXN0OwogICAgfSwKCiAgICAvKioKICAgICAqIHVwZGF0ZSB0aGUgcG9zaXRpb24gb2YgYSBwb2ludGVyCiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgIHR5cGUgICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5ECiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgIHBvaW50ZXJFdmVudAogICAgICovCiAgICB1cGRhdGVQb2ludGVyOiBmdW5jdGlvbih0eXBlLCBwb2ludGVyRXZlbnQpIHsKICAgICAgaWYodHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICB0aGlzLnBvaW50ZXJzID0ge307CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgcG9pbnRlckV2ZW50LmlkZW50aWZpZXIgPSBwb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgIHRoaXMucG9pbnRlcnNbcG9pbnRlckV2ZW50LnBvaW50ZXJJZF0gPSBwb2ludGVyRXZlbnQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnBvaW50ZXJzKS5sZW5ndGg7CiAgICB9LAoKICAgIC8qKgogICAgICogY2hlY2sgaWYgZXYgbWF0Y2hlcyBwb2ludGVydHlwZQogICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICAgIHBvaW50ZXJUeXBlICAgICBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFCiAgICAgKiBAcGFyYW0gICB7UG9pbnRlckV2ZW50fSAgZXYKICAgICAqLwogICAgbWF0Y2hUeXBlOiBmdW5jdGlvbihwb2ludGVyVHlwZSwgZXYpIHsKICAgICAgaWYoIWV2LnBvaW50ZXJUeXBlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgdHlwZXMgPSB7fTsKICAgICAgdHlwZXNbaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRV0gPSAoZXYucG9pbnRlclR5cGUgPT0gZXYuTVNQT0lOVEVSX1RZUEVfTU9VU0UgfHwgZXYucG9pbnRlclR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRSk7CiAgICAgIHR5cGVzW2lvbmljLkdlc3R1cmVzLlBPSU5URVJfVE9VQ0hdID0gKGV2LnBvaW50ZXJUeXBlID09IGV2Lk1TUE9JTlRFUl9UWVBFX1RPVUNIIHx8IGV2LnBvaW50ZXJUeXBlID09IGlvbmljLkdlc3R1cmVzLlBPSU5URVJfVE9VQ0gpOwogICAgICB0eXBlc1tpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1BFTl0gPSAoZXYucG9pbnRlclR5cGUgPT0gZXYuTVNQT0lOVEVSX1RZUEVfUEVOIHx8IGV2LnBvaW50ZXJUeXBlID09IGlvbmljLkdlc3R1cmVzLlBPSU5URVJfUEVOKTsKICAgICAgcmV0dXJuIHR5cGVzW3BvaW50ZXJUeXBlXTsKICAgIH0sCgoKICAgIC8qKgogICAgICogZ2V0IGV2ZW50cwogICAgICovCiAgICBnZXRFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gWwogICAgICAgICdwb2ludGVyZG93biBNU1BvaW50ZXJEb3duJywKICAgICAgJ3BvaW50ZXJtb3ZlIE1TUG9pbnRlck1vdmUnLAogICAgICAncG9pbnRlcnVwIHBvaW50ZXJjYW5jZWwgTVNQb2ludGVyVXAgTVNQb2ludGVyQ2FuY2VsJwogICAgICAgIF07CiAgICB9LAoKICAgIC8qKgogICAgICogcmVzZXQgdGhlIGxpc3QKICAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnBvaW50ZXJzID0ge307CiAgICB9CiAgfTsKCgogIGlvbmljLkdlc3R1cmVzLnV0aWxzID0gewogICAgLyoqCiAgICAgKiBleHRlbmQgbWV0aG9kLAogICAgICogYWxzbyB1c2VkIGZvciBjbG9uaW5nIHdoZW4gZGVzdCBpcyBhbiBlbXB0eSBvYmplY3QKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIGRlc3QKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIHNyYwogICAgICogQHBhcmFtCXtCb29sZWFufQltZXJnZQkJZG8gYSBtZXJnZQogICAgICogQHJldHVybnMge09iamVjdH0gICAgZGVzdAogICAgICovCiAgICBleHRlbmQ6IGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzcmMsIG1lcmdlKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgICBpZihkZXN0W2tleV0gIT09IHVuZGVmaW5lZCAmJiBtZXJnZSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGRlc3Rba2V5XSA9IHNyY1trZXldOwogICAgICB9CiAgICAgIHJldHVybiBkZXN0OwogICAgfSwKCgogICAgLyoqCiAgICAgKiBmaW5kIGlmIGEgbm9kZSBpcyBpbiB0aGUgZ2l2ZW4gcGFyZW50CiAgICAgKiB1c2VkIGZvciBldmVudCBkZWxlZ2F0aW9uIHRyaWNrcwogICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIG5vZGUKICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBwYXJlbnQKICAgICAqIEByZXR1cm5zIHtib29sZWFufSAgICAgICBoYXNfcGFyZW50CiAgICAgKi8KICAgIGhhc1BhcmVudDogZnVuY3Rpb24obm9kZSwgcGFyZW50KSB7CiAgICAgIHdoaWxlKG5vZGUpewogICAgICAgIGlmKG5vZGUgPT0gcGFyZW50KSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKCiAgICAvKioKICAgICAqIGdldCB0aGUgY2VudGVyIG9mIGFsbCB0aGUgdG91Y2hlcwogICAgICogQHBhcmFtICAge0FycmF5fSAgICAgdG91Y2hlcwogICAgICogQHJldHVybnMge09iamVjdH0gICAgY2VudGVyCiAgICAgKi8KICAgIGdldENlbnRlcjogZnVuY3Rpb24gZ2V0Q2VudGVyKHRvdWNoZXMpIHsKICAgICAgdmFyIHZhbHVlc1ggPSBbXSwgdmFsdWVzWSA9IFtdOwoKICAgICAgZm9yKHZhciB0PSAwLGxlbj10b3VjaGVzLmxlbmd0aDsgdDxsZW47IHQrKykgewogICAgICAgIHZhbHVlc1gucHVzaCh0b3VjaGVzW3RdLnBhZ2VYKTsKICAgICAgICB2YWx1ZXNZLnB1c2godG91Y2hlc1t0XS5wYWdlWSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgcGFnZVg6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWCkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNYKSkgLyAyKSwKICAgICAgICAgIHBhZ2VZOiAoKE1hdGgubWluLmFwcGx5KE1hdGgsIHZhbHVlc1kpICsgTWF0aC5tYXguYXBwbHkoTWF0aCwgdmFsdWVzWSkpIC8gMikKICAgICAgfTsKICAgIH0sCgoKICAgIC8qKgogICAgICogY2FsY3VsYXRlIHRoZSB2ZWxvY2l0eSBiZXR3ZWVuIHR3byBwb2ludHMKICAgICAqIEBwYXJhbSAgIHtOdW1iZXJ9ICAgIGRlbHRhX3RpbWUKICAgICAqIEBwYXJhbSAgIHtOdW1iZXJ9ICAgIGRlbHRhX3gKICAgICAqIEBwYXJhbSAgIHtOdW1iZXJ9ICAgIGRlbHRhX3kKICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgIHZlbG9jaXR5CiAgICAgKi8KICAgIGdldFZlbG9jaXR5OiBmdW5jdGlvbiBnZXRWZWxvY2l0eShkZWx0YV90aW1lLCBkZWx0YV94LCBkZWx0YV95KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogTWF0aC5hYnMoZGVsdGFfeCAvIGRlbHRhX3RpbWUpIHx8IDAsCiAgICAgICAgeTogTWF0aC5hYnMoZGVsdGFfeSAvIGRlbHRhX3RpbWUpIHx8IDAKICAgICAgfTsKICAgIH0sCgoKICAgIC8qKgogICAgICogY2FsY3VsYXRlIHRoZSBhbmdsZSBiZXR3ZWVuIHR3byBjb29yZGluYXRlcwogICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gxCiAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDIKICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIGFuZ2xlCiAgICAgKi8KICAgIGdldEFuZ2xlOiBmdW5jdGlvbiBnZXRBbmdsZSh0b3VjaDEsIHRvdWNoMikgewogICAgICB2YXIgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWSwKICAgICAgeCA9IHRvdWNoMi5wYWdlWCAtIHRvdWNoMS5wYWdlWDsKICAgICAgcmV0dXJuIE1hdGguYXRhbjIoeSwgeCkgKiAxODAgLyBNYXRoLlBJOwogICAgfSwKCgogICAgLyoqCiAgICAgKiBhbmdsZSB0byBkaXJlY3Rpb24gZGVmaW5lCiAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDEKICAgICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMgogICAgICogQHJldHVybnMge1N0cmluZ30gICAgZGlyZWN0aW9uIGNvbnN0YW50LCBsaWtlIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9MRUZUCiAgICAgKi8KICAgIGdldERpcmVjdGlvbjogZnVuY3Rpb24gZ2V0RGlyZWN0aW9uKHRvdWNoMSwgdG91Y2gyKSB7CiAgICAgIHZhciB4ID0gTWF0aC5hYnModG91Y2gxLnBhZ2VYIC0gdG91Y2gyLnBhZ2VYKSwKICAgICAgeSA9IE1hdGguYWJzKHRvdWNoMS5wYWdlWSAtIHRvdWNoMi5wYWdlWSk7CgogICAgICBpZih4ID49IHkpIHsKICAgICAgICByZXR1cm4gdG91Y2gxLnBhZ2VYIC0gdG91Y2gyLnBhZ2VYID4gMCA/IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9MRUZUIDogaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1JJR0hUOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHJldHVybiB0b3VjaDEucGFnZVkgLSB0b3VjaDIucGFnZVkgPiAwID8gaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1VQIDogaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX0RPV047CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICogY2FsY3VsYXRlIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHR3byB0b3VjaGVzCiAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDEKICAgICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMgogICAgICogQHJldHVybnMge051bWJlcn0gICAgZGlzdGFuY2UKICAgICAqLwogICAgZ2V0RGlzdGFuY2U6IGZ1bmN0aW9uIGdldERpc3RhbmNlKHRvdWNoMSwgdG91Y2gyKSB7CiAgICAgIHZhciB4ID0gdG91Y2gyLnBhZ2VYIC0gdG91Y2gxLnBhZ2VYLAogICAgICB5ID0gdG91Y2gyLnBhZ2VZIC0gdG91Y2gxLnBhZ2VZOwogICAgICByZXR1cm4gTWF0aC5zcXJ0KCh4KngpICsgKHkqeSkpOwogICAgfSwKCgogICAgLyoqCiAgICAgKiBjYWxjdWxhdGUgdGhlIHNjYWxlIGZhY3RvciBiZXR3ZWVuIHR3byB0b3VjaExpc3RzIChmaW5nZXJzKQogICAgICogbm8gc2NhbGUgaXMgMSwgYW5kIGdvZXMgZG93biB0byAwIHdoZW4gcGluY2hlZCB0b2dldGhlciwgYW5kIGJpZ2dlciB3aGVuIHBpbmNoZWQgb3V0CiAgICAgKiBAcGFyYW0gICB7QXJyYXl9ICAgICBzdGFydAogICAgICogQHBhcmFtICAge0FycmF5fSAgICAgZW5kCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICBzY2FsZQogICAgICovCiAgICBnZXRTY2FsZTogZnVuY3Rpb24gZ2V0U2NhbGUoc3RhcnQsIGVuZCkgewogICAgICAvLyBuZWVkIHR3byBmaW5nZXJzLi4uCiAgICAgIGlmKHN0YXJ0Lmxlbmd0aCA+PSAyICYmIGVuZC5sZW5ndGggPj0gMikgewogICAgICAgIHJldHVybiB0aGlzLmdldERpc3RhbmNlKGVuZFswXSwgZW5kWzFdKSAvCiAgICAgICAgICB0aGlzLmdldERpc3RhbmNlKHN0YXJ0WzBdLCBzdGFydFsxXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIDE7CiAgICB9LAoKCiAgICAvKioKICAgICAqIGNhbGN1bGF0ZSB0aGUgcm90YXRpb24gZGVncmVlcyBiZXR3ZWVuIHR3byB0b3VjaExpc3RzIChmaW5nZXJzKQogICAgICogQHBhcmFtICAge0FycmF5fSAgICAgc3RhcnQKICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIGVuZAogICAgICogQHJldHVybnMge051bWJlcn0gICAgcm90YXRpb24KICAgICAqLwogICAgZ2V0Um90YXRpb246IGZ1bmN0aW9uIGdldFJvdGF0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgLy8gbmVlZCB0d28gZmluZ2VycwogICAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRBbmdsZShlbmRbMV0sIGVuZFswXSkgLQogICAgICAgICAgdGhpcy5nZXRBbmdsZShzdGFydFsxXSwgc3RhcnRbMF0pOwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfSwKCgogICAgLyoqCiAgICAgKiBib29sZWFuIGlmIHRoZSBkaXJlY3Rpb24gaXMgdmVydGljYWwKICAgICAqIEBwYXJhbSAgICB7U3RyaW5nfSAgICBkaXJlY3Rpb24KICAgICAqIEByZXR1cm5zICB7Qm9vbGVhbn0gICBpc192ZXJ0aWNhbAogICAgICovCiAgICBpc1ZlcnRpY2FsOiBmdW5jdGlvbiBpc1ZlcnRpY2FsKGRpcmVjdGlvbikgewogICAgICByZXR1cm4gKGRpcmVjdGlvbiA9PSBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fVVAgfHwgZGlyZWN0aW9uID09IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9ET1dOKTsKICAgIH0sCgoKICAgIC8qKgogICAgICogc3RvcCBicm93c2VyIGRlZmF1bHQgYmVoYXZpb3Igd2l0aCBjc3MgY2xhc3MKICAgICAqIEBwYXJhbSAgIHtIdG1sRWxlbWVudH0gICBlbGVtZW50CiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgY3NzX2NsYXNzCiAgICAgKi8KICAgIHN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yOiBmdW5jdGlvbiBzdG9wRGVmYXVsdEJyb3dzZXJCZWhhdmlvcihlbGVtZW50LCBjc3NfY2xhc3MpIHsKICAgICAgLy8gY2hhbmdlZCBmcm9tIG1ha2luZyBtYW55IHN0eWxlIGNoYW5nZXMgdG8ganVzdCBhZGRpbmcgYSBwcmVzZXQgY2xhc3NuYW1lCiAgICAgIC8vIGxlc3MgRE9NIG1hbmlwdWxhdGlvbnMsIGxlc3MgY29kZSwgYW5kIGVhc2llciB0byBjb250cm9sIGluIHRoZSBDU1Mgc2lkZSBvZiB0aGluZ3MKICAgICAgLy8gaGFtbWVyLmpzIGRvZXNuJ3QgY29tZSB3aXRoIENTUywgYnV0IGlvbmljIGRvZXMsIHdoaWNoIGlzIHdoeSB3ZSBwcmVmZXIgdGhpcyBtZXRob2QKICAgICAgaWYoZWxlbWVudCAmJiBlbGVtZW50LmNsYXNzTGlzdCkgewogICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZChjc3NfY2xhc3MpOwogICAgICAgIGVsZW1lbnQub25zZWxlY3RzdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9OwoKCiAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uID0gewogICAgLy8gY29udGFpbnMgYWxsIHJlZ2lzdHJlZCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcyBpbiB0aGUgY29ycmVjdCBvcmRlcgogICAgZ2VzdHVyZXM6IFtdLAoKICAgIC8vIGRhdGEgb2YgdGhlIGN1cnJlbnQgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBkZXRlY3Rpb24gc2Vzc2lvbgogICAgY3VycmVudDogbnVsbCwKCiAgICAvLyB0aGUgcHJldmlvdXMgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBzZXNzaW9uIGRhdGEKICAgIC8vIGlzIGEgZnVsbCBjbG9uZSBvZiB0aGUgcHJldmlvdXMgZ2VzdHVyZS5jdXJyZW50IG9iamVjdAogICAgcHJldmlvdXM6IG51bGwsCgogICAgLy8gd2hlbiB0aGlzIGJlY29tZXMgdHJ1ZSwgbm8gZ2VzdHVyZXMgYXJlIGZpcmVkCiAgICBzdG9wcGVkOiBmYWxzZSwKCgogICAgLyoqCiAgICAgKiBzdGFydCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGRldGVjdGlvbgogICAgICogQHBhcmFtICAge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfSAgIGluc3QKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICAgICAgZXZlbnREYXRhCiAgICAgKi8KICAgIHN0YXJ0RGV0ZWN0OiBmdW5jdGlvbiBzdGFydERldGVjdChpbnN0LCBldmVudERhdGEpIHsKICAgICAgLy8gYWxyZWFkeSBidXN5IHdpdGggYSBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGRldGVjdGlvbiBvbiBhbiBlbGVtZW50CiAgICAgIGlmKHRoaXMuY3VycmVudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5zdG9wcGVkID0gZmFsc2U7CgogICAgICB0aGlzLmN1cnJlbnQgPSB7CiAgICAgICAgaW5zdCAgICAgICAgOiBpbnN0LCAvLyByZWZlcmVuY2UgdG8gaW9uaWMuR2VzdHVyZXNJbnN0YW5jZSB3ZSdyZSB3b3JraW5nIGZvcgogICAgICAgIHN0YXJ0RXZlbnQgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZXh0ZW5kKHt9LCBldmVudERhdGEpLCAvLyBzdGFydCBldmVudERhdGEgZm9yIGRpc3RhbmNlcywgdGltaW5nIGV0YwogICAgICAgIGxhc3RFdmVudCAgIDogZmFsc2UsIC8vIGxhc3QgZXZlbnREYXRhCiAgICAgICAgbmFtZSAgICAgICAgOiAnJyAvLyBjdXJyZW50IGdlc3R1cmUgd2UncmUgaW4vZGV0ZWN0ZWQsIGNhbiBiZSAndGFwJywgJ2hvbGQnIGV0YwogICAgICB9OwoKICAgICAgdGhpcy5kZXRlY3QoZXZlbnREYXRhKTsKICAgIH0sCgoKICAgIC8qKgogICAgICogaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBkZXRlY3Rpb24KICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIGV2ZW50RGF0YQogICAgICovCiAgICBkZXRlY3Q6IGZ1bmN0aW9uIGRldGVjdChldmVudERhdGEpIHsKICAgICAgaWYoIXRoaXMuY3VycmVudCB8fCB0aGlzLnN0b3BwZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIGV4dGVuZCBldmVudCBkYXRhIHdpdGggY2FsY3VsYXRpb25zIGFib3V0IHNjYWxlLCBkaXN0YW5jZSBldGMKICAgICAgZXZlbnREYXRhID0gdGhpcy5leHRlbmRFdmVudERhdGEoZXZlbnREYXRhKTsKCiAgICAgIC8vIGluc3RhbmNlIG9wdGlvbnMKICAgICAgdmFyIGluc3Rfb3B0aW9ucyA9IHRoaXMuY3VycmVudC5pbnN0Lm9wdGlvbnM7CgogICAgICAvLyBjYWxsIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgaGFuZGxlcnMKICAgICAgZm9yKHZhciBnPTAsbGVuPXRoaXMuZ2VzdHVyZXMubGVuZ3RoOyBnPGxlbjsgZysrKSB7CiAgICAgICAgdmFyIGdlc3R1cmUgPSB0aGlzLmdlc3R1cmVzW2ddOwoKICAgICAgICAvLyBvbmx5IHdoZW4gdGhlIGluc3RhbmNlIG9wdGlvbnMgaGF2ZSBlbmFibGVkIHRoaXMgZ2VzdHVyZQogICAgICAgIGlmKCF0aGlzLnN0b3BwZWQgJiYgaW5zdF9vcHRpb25zW2dlc3R1cmUubmFtZV0gIT09IGZhbHNlKSB7CiAgICAgICAgICAvLyBpZiBhIGhhbmRsZXIgcmV0dXJucyBmYWxzZSwgd2Ugc3RvcCB3aXRoIHRoZSBkZXRlY3Rpb24KICAgICAgICAgIGlmKGdlc3R1cmUuaGFuZGxlci5jYWxsKGdlc3R1cmUsIGV2ZW50RGF0YSwgdGhpcy5jdXJyZW50Lmluc3QpID09PSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnN0b3BEZXRlY3QoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBzdG9yZSBhcyBwcmV2aW91cyBldmVudCBldmVudAogICAgICBpZih0aGlzLmN1cnJlbnQpIHsKICAgICAgICB0aGlzLmN1cnJlbnQubGFzdEV2ZW50ID0gZXZlbnREYXRhOwogICAgICB9CgogICAgICAvLyBlbmRldmVudCwgYnV0IG5vdCB0aGUgbGFzdCB0b3VjaCwgc28gZG9udCBzdG9wCiAgICAgIGlmKGV2ZW50RGF0YS5ldmVudFR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EICYmICFldmVudERhdGEudG91Y2hlcy5sZW5ndGgtMSkgewogICAgICAgIHRoaXMuc3RvcERldGVjdCgpOwogICAgICB9CgogICAgICByZXR1cm4gZXZlbnREYXRhOwogICAgfSwKCgogICAgLyoqCiAgICAgKiBjbGVhciB0aGUgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSB2YXJzCiAgICAgKiB0aGlzIGlzIGNhbGxlZCBvbiBlbmREZXRlY3QsIGJ1dCBjYW4gYWxzbyBiZSB1c2VkIHdoZW4gYSBmaW5hbCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGhhcyBiZWVuIGRldGVjdGVkCiAgICAgKiB0byBzdG9wIG90aGVyIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzIGZyb20gYmVpbmcgZmlyZWQKICAgICAqLwogICAgc3RvcERldGVjdDogZnVuY3Rpb24gc3RvcERldGVjdCgpIHsKICAgICAgLy8gY2xvbmUgY3VycmVudCBkYXRhIHRvIHRoZSBzdG9yZSBhcyB0aGUgcHJldmlvdXMgZ2VzdHVyZQogICAgICAvLyB1c2VkIGZvciB0aGUgZG91YmxlIHRhcCBnZXN0dXJlLCBzaW5jZSB0aGlzIGlzIGFuIG90aGVyIGdlc3R1cmUgZGV0ZWN0IHNlc3Npb24KICAgICAgdGhpcy5wcmV2aW91cyA9IGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCh7fSwgdGhpcy5jdXJyZW50KTsKCiAgICAgIC8vIHJlc2V0IHRoZSBjdXJyZW50CiAgICAgIHRoaXMuY3VycmVudCA9IG51bGw7CgogICAgICAvLyBzdG9wcGVkIQogICAgICB0aGlzLnN0b3BwZWQgPSB0cnVlOwogICAgfSwKCgogICAgLyoqCiAgICAgKiBleHRlbmQgZXZlbnREYXRhIGZvciBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcwogICAgICogQHBhcmFtICAge09iamVjdH0gICBldgogICAgICogQHJldHVybnMge09iamVjdH0gICBldgogICAgICovCiAgICBleHRlbmRFdmVudERhdGE6IGZ1bmN0aW9uIGV4dGVuZEV2ZW50RGF0YShldikgewogICAgICB2YXIgc3RhcnRFdiA9IHRoaXMuY3VycmVudC5zdGFydEV2ZW50OwoKICAgICAgLy8gaWYgdGhlIHRvdWNoZXMgY2hhbmdlLCBzZXQgdGhlIG5ldyB0b3VjaGVzIG92ZXIgdGhlIHN0YXJ0RXZlbnQgdG91Y2hlcwogICAgICAvLyB0aGlzIGJlY2F1c2UgdG91Y2hldmVudHMgZG9uJ3QgaGF2ZSBhbGwgdGhlIHRvdWNoZXMgb24gdG91Y2hzdGFydCwgb3IgdGhlCiAgICAgIC8vIHVzZXIgbXVzdCBwbGFjZSBoaXMgZmluZ2VycyBhdCB0aGUgRVhBQ1Qgc2FtZSB0aW1lIG9uIHRoZSBzY3JlZW4sIHdoaWNoIGlzIG5vdCByZWFsaXN0aWMKICAgICAgLy8gYnV0LCBzb21ldGltZXMgaXQgaGFwcGVucyB0aGF0IGJvdGggZmluZ2VycyBhcmUgdG91Y2hpbmcgYXQgdGhlIEVYQUNUIHNhbWUgdGltZQogICAgICBpZihzdGFydEV2ICYmIChldi50b3VjaGVzLmxlbmd0aCAhPSBzdGFydEV2LnRvdWNoZXMubGVuZ3RoIHx8IGV2LnRvdWNoZXMgPT09IHN0YXJ0RXYudG91Y2hlcykpIHsKICAgICAgICAvLyBleHRlbmQgMSBsZXZlbCBkZWVwIHRvIGdldCB0aGUgdG91Y2hsaXN0IHdpdGggdGhlIHRvdWNoIG9iamVjdHMKICAgICAgICBzdGFydEV2LnRvdWNoZXMgPSBbXTsKICAgICAgICBmb3IodmFyIGk9MCxsZW49ZXYudG91Y2hlcy5sZW5ndGg7IGk8bGVuOyBpKyspIHsKICAgICAgICAgIHN0YXJ0RXYudG91Y2hlcy5wdXNoKGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCh7fSwgZXYudG91Y2hlc1tpXSkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGRlbHRhX3RpbWUgPSBldi50aW1lU3RhbXAgLSBzdGFydEV2LnRpbWVTdGFtcCwKICAgICAgICAgIGRlbHRhX3ggPSBldi5jZW50ZXIucGFnZVggLSBzdGFydEV2LmNlbnRlci5wYWdlWCwKICAgICAgICAgIGRlbHRhX3kgPSBldi5jZW50ZXIucGFnZVkgLSBzdGFydEV2LmNlbnRlci5wYWdlWSwKICAgICAgICAgIHZlbG9jaXR5ID0gaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0VmVsb2NpdHkoZGVsdGFfdGltZSwgZGVsdGFfeCwgZGVsdGFfeSk7CgogICAgICBpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoZXYsIHsKICAgICAgICBkZWx0YVRpbWUgICA6IGRlbHRhX3RpbWUsCgogICAgICAgIGRlbHRhWCAgICAgIDogZGVsdGFfeCwKICAgICAgICBkZWx0YVkgICAgICA6IGRlbHRhX3ksCgogICAgICAgIHZlbG9jaXR5WCAgIDogdmVsb2NpdHkueCwKICAgICAgICB2ZWxvY2l0eVkgICA6IHZlbG9jaXR5LnksCgogICAgICAgIGRpc3RhbmNlICAgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0RGlzdGFuY2Uoc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCiAgICAgICAgYW5nbGUgICAgICAgOiBpb25pYy5HZXN0dXJlcy51dGlscy5nZXRBbmdsZShzdGFydEV2LmNlbnRlciwgZXYuY2VudGVyKSwKICAgICAgICBkaXJlY3Rpb24gICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldERpcmVjdGlvbihzdGFydEV2LmNlbnRlciwgZXYuY2VudGVyKSwKCiAgICAgICAgc2NhbGUgICAgICAgOiBpb25pYy5HZXN0dXJlcy51dGlscy5nZXRTY2FsZShzdGFydEV2LnRvdWNoZXMsIGV2LnRvdWNoZXMpLAogICAgICAgIHJvdGF0aW9uICAgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0Um90YXRpb24oc3RhcnRFdi50b3VjaGVzLCBldi50b3VjaGVzKSwKCiAgICAgICAgc3RhcnRFdmVudCAgOiBzdGFydEV2CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGV2OwogICAgfSwKCgogICAgLyoqCiAgICAgKiByZWdpc3RlciBuZXcgZ2VzdHVyZQogICAgICogQHBhcmFtICAge09iamVjdH0gICAgZ2VzdHVyZSBvYmplY3QsIHNlZSBnZXN0dXJlcy5qcyBmb3IgZG9jdW1lbnRhdGlvbgogICAgICogQHJldHVybnMge0FycmF5fSAgICAgZ2VzdHVyZXMKICAgICAqLwogICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIHJlZ2lzdGVyKGdlc3R1cmUpIHsKICAgICAgLy8gYWRkIGFuIGVuYWJsZSBnZXN0dXJlIG9wdGlvbnMgaWYgdGhlcmUgaXMgbm8gZ2l2ZW4KICAgICAgdmFyIG9wdGlvbnMgPSBnZXN0dXJlLmRlZmF1bHRzIHx8IHt9OwogICAgICBpZihvcHRpb25zW2dlc3R1cmUubmFtZV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgIG9wdGlvbnNbZ2VzdHVyZS5uYW1lXSA9IHRydWU7CiAgICAgIH0KCiAgICAgIC8vIGV4dGVuZCBpb25pYy5HZXN0dXJlcyBkZWZhdWx0IG9wdGlvbnMgd2l0aCB0aGUgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBvcHRpb25zCiAgICAgIGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZChpb25pYy5HZXN0dXJlcy5kZWZhdWx0cywgb3B0aW9ucywgdHJ1ZSk7CgogICAgICAvLyBzZXQgaXRzIGluZGV4CiAgICAgIGdlc3R1cmUuaW5kZXggPSBnZXN0dXJlLmluZGV4IHx8IDEwMDA7CgogICAgICAvLyBhZGQgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSB0byB0aGUgbGlzdAogICAgICB0aGlzLmdlc3R1cmVzLnB1c2goZ2VzdHVyZSk7CgogICAgICAvLyBzb3J0IHRoZSBsaXN0IGJ5IGluZGV4CiAgICAgIHRoaXMuZ2VzdHVyZXMuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgaWYgKGEuaW5kZXggPCBiLmluZGV4KSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIGlmIChhLmluZGV4ID4gYi5pbmRleCkgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9KTsKCiAgICAgIHJldHVybiB0aGlzLmdlc3R1cmVzOwogICAgfQogIH07CgoKICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcyA9IGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzIHx8IHt9OwoKICAvKioKICAgKiBDdXN0b20gZ2VzdHVyZXMKICAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgKgogICAqIEdlc3R1cmUgb2JqZWN0CiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBUaGUgb2JqZWN0IHN0cnVjdHVyZSBvZiBhIGdlc3R1cmU6CiAgICoKICAgKiB7IG5hbWU6ICdteWdlc3R1cmUnLAogICAqICAgaW5kZXg6IDEzMzcsCiAgICogICBkZWZhdWx0czogewogICAqICAgICBteWdlc3R1cmVfb3B0aW9uOiB0cnVlCiAgICogICB9CiAgICogICBoYW5kbGVyOiBmdW5jdGlvbih0eXBlLCBldiwgaW5zdCkgewogICAqICAgICAvLyB0cmlnZ2VyIGdlc3R1cmUgZXZlbnQKICAgKiAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwogICAqICAgfQogICAqIH0KCiAgICogQHBhcmFtICAge1N0cmluZ30gICAgbmFtZQogICAqIHRoaXMgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBnZXN0dXJlLCBsb3dlcmNhc2UKICAgKiBpdCBpcyBhbHNvIGJlaW5nIHVzZWQgdG8gZGlzYWJsZS9lbmFibGUgdGhlIGdlc3R1cmUgcGVyIGluc3RhbmNlIGNvbmZpZy4KICAgKgogICAqIEBwYXJhbSAgIHtOdW1iZXJ9ICAgIFtpbmRleD0xMDAwXQogICAqIHRoZSBpbmRleCBvZiB0aGUgZ2VzdHVyZSwgd2hlcmUgaXQgaXMgZ29pbmcgdG8gYmUgaW4gdGhlIHN0YWNrIG9mIGdlc3R1cmVzIGRldGVjdGlvbgogICAqIGxpa2Ugd2hlbiB5b3UgYnVpbGQgYW4gZ2VzdHVyZSB0aGF0IGRlcGVuZHMgb24gdGhlIGRyYWcgZ2VzdHVyZSwgaXQgaXMgYSBnb29kCiAgICogaWRlYSB0byBwbGFjZSBpdCBhZnRlciB0aGUgaW5kZXggb2YgdGhlIGRyYWcgZ2VzdHVyZS4KICAgKgogICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIFtkZWZhdWx0cz17fV0KICAgKiB0aGUgZGVmYXVsdCBzZXR0aW5ncyBvZiB0aGUgZ2VzdHVyZS4gdGhlc2UgYXJlIGFkZGVkIHRvIHRoZSBpbnN0YW5jZSBzZXR0aW5ncywKICAgKiBhbmQgY2FuIGJlIG92ZXJydWxlZCBwZXIgaW5zdGFuY2UuIHlvdSBjYW4gYWxzbyBhZGQgdGhlIG5hbWUgb2YgdGhlIGdlc3R1cmUsCiAgICogYnV0IHRoaXMgaXMgYWxzbyBhZGRlZCBieSBkZWZhdWx0IChhbmQgc2V0IHRvIHRydWUpLgogICAqCiAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgaGFuZGxlcgogICAqIHRoaXMgaGFuZGxlcyB0aGUgZ2VzdHVyZSBkZXRlY3Rpb24gb2YgeW91ciBjdXN0b20gZ2VzdHVyZSBhbmQgcmVjZWl2ZXMgdGhlCiAgICogZm9sbG93aW5nIGFyZ3VtZW50czoKICAgKgogICAqICAgICAgQHBhcmFtICB7T2JqZWN0fSAgICBldmVudERhdGEKICAgKiAgICAgIGV2ZW50IGRhdGEgY29udGFpbmluZyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICogICAgICAgICAgdGltZVN0YW1wICAge051bWJlcn0gICAgICAgIHRpbWUgdGhlIGV2ZW50IG9jY3VycmVkCiAgICogICAgICAgICAgdGFyZ2V0ICAgICAge0hUTUxFbGVtZW50fSAgIHRhcmdldCBlbGVtZW50CiAgICogICAgICAgICAgdG91Y2hlcyAgICAge0FycmF5fSAgICAgICAgIHRvdWNoZXMgKGZpbmdlcnMsIHBvaW50ZXJzLCBtb3VzZSkgb24gdGhlIHNjcmVlbgogICAqICAgICAgICAgIHBvaW50ZXJUeXBlIHtTdHJpbmd9ICAgICAgICBraW5kIG9mIHBvaW50ZXIgdGhhdCB3YXMgdXNlZC4gbWF0Y2hlcyBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFfFRPVUNICiAgICogICAgICAgICAgY2VudGVyICAgICAge09iamVjdH0gICAgICAgIGNlbnRlciBwb3NpdGlvbiBvZiB0aGUgdG91Y2hlcy4gY29udGFpbnMgcGFnZVggYW5kIHBhZ2VZCiAgICogICAgICAgICAgZGVsdGFUaW1lICAge051bWJlcn0gICAgICAgIHRoZSB0b3RhbCB0aW1lIG9mIHRoZSB0b3VjaGVzIGluIHRoZSBzY3JlZW4KICAgKiAgICAgICAgICBkZWx0YVggICAgICB7TnVtYmVyfSAgICAgICAgdGhlIGRlbHRhIG9uIHggYXhpcyB3ZSBoYXZlZCBtb3ZlZAogICAqICAgICAgICAgIGRlbHRhWSAgICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgZGVsdGEgb24geSBheGlzIHdlIGhhdmVkIG1vdmVkCiAgICogICAgICAgICAgdmVsb2NpdHlYICAge051bWJlcn0gICAgICAgIHRoZSB2ZWxvY2l0eSBvbiB0aGUgeAogICAqICAgICAgICAgIHZlbG9jaXR5WSAgIHtOdW1iZXJ9ICAgICAgICB0aGUgdmVsb2NpdHkgb24geQogICAqICAgICAgICAgIGFuZ2xlICAgICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgYW5nbGUgd2UgYXJlIG1vdmluZwogICAqICAgICAgICAgIGRpcmVjdGlvbiAgIHtTdHJpbmd9ICAgICAgICB0aGUgZGlyZWN0aW9uIHdlIGFyZSBtb3ZpbmcuIG1hdGNoZXMgaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1VQfERPV058TEVGVHxSSUdIVAogICAqICAgICAgICAgIGRpc3RhbmNlICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgZGlzdGFuY2Ugd2UgaGF2ZWQgbW92ZWQKICAgKiAgICAgICAgICBzY2FsZSAgICAgICB7TnVtYmVyfSAgICAgICAgc2NhbGluZyBvZiB0aGUgdG91Y2hlcywgbmVlZHMgMiB0b3VjaGVzCiAgICogICAgICAgICAgcm90YXRpb24gICAge051bWJlcn0gICAgICAgIHJvdGF0aW9uIG9mIHRoZSB0b3VjaGVzLCBuZWVkcyAyIHRvdWNoZXMgKgogICAqICAgICAgICAgIGV2ZW50VHlwZSAgIHtTdHJpbmd9ICAgICAgICBtYXRjaGVzIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUfE1PVkV8RU5ECiAgICogICAgICAgICAgc3JjRXZlbnQgICAge09iamVjdH0gICAgICAgIHRoZSBzb3VyY2UgZXZlbnQsIGxpa2UgVG91Y2hTdGFydCBvciBNb3VzZURvd24gKgogICAqICAgICAgICAgIHN0YXJ0RXZlbnQgIHtPYmplY3R9ICAgICAgICBjb250YWlucyB0aGUgc2FtZSBwcm9wZXJ0aWVzIGFzIGFib3ZlLAogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXQgZnJvbSB0aGUgZmlyc3QgdG91Y2guIHRoaXMgaXMgdXNlZCB0byBjYWxjdWxhdGUKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzdGFuY2VzLCBkZWx0YVRpbWUsIHNjYWxpbmcgZXRjCiAgICoKICAgKiAgICAgIEBwYXJhbSAge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfSAgICBpbnN0CiAgICogICAgICB0aGUgaW5zdGFuY2Ugd2UgYXJlIGRvaW5nIHRoZSBkZXRlY3Rpb24gZm9yLiB5b3UgY2FuIGdldCB0aGUgb3B0aW9ucyBmcm9tCiAgICogICAgICB0aGUgaW5zdC5vcHRpb25zIG9iamVjdCBhbmQgdHJpZ2dlciB0aGUgZ2VzdHVyZSBldmVudCBieSBjYWxsaW5nIGluc3QudHJpZ2dlcgogICAqCiAgICoKICAgKiBIYW5kbGUgZ2VzdHVyZXMKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGluc2lkZSB0aGUgaGFuZGxlciB5b3UgY2FuIGdldC9zZXQgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uaWMuY3VycmVudC4gVGhpcyBpcyB0aGUgY3VycmVudAogICAqIGRldGVjdGlvbiBzZXNzaW9uaWMuIEl0IGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXMKICAgKiAgICAgIEBwYXJhbSAge1N0cmluZ30gICAgbmFtZQogICAqICAgICAgY29udGFpbnMgdGhlIG5hbWUgb2YgdGhlIGdlc3R1cmUgd2UgaGF2ZSBkZXRlY3RlZC4gaXQgaGFzIG5vdCBhIHJlYWwgZnVuY3Rpb24sCiAgICogICAgICBvbmx5IHRvIGNoZWNrIGluIG90aGVyIGdlc3R1cmVzIGlmIHNvbWV0aGluZyBpcyBkZXRlY3RlZC4KICAgKiAgICAgIGxpa2UgaW4gdGhlIGRyYWcgZ2VzdHVyZSB3ZSBzZXQgaXQgdG8gJ2RyYWcnIGFuZCBpbiB0aGUgc3dpcGUgZ2VzdHVyZSB3ZSBjYW4KICAgKiAgICAgIGNoZWNrIGlmIHRoZSBjdXJyZW50IGdlc3R1cmUgaXMgJ2RyYWcnIGJ5IGFjY2Vzc2luZyBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb25pYy5jdXJyZW50Lm5hbWUKICAgKgogICAqICAgICAgcmVhZG9ubHkKICAgKiAgICAgIEBwYXJhbSAge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfSAgICBpbnN0CiAgICogICAgICB0aGUgaW5zdGFuY2Ugd2UgZG8gdGhlIGRldGVjdGlvbiBmb3IKICAgKgogICAqICAgICAgcmVhZG9ubHkKICAgKiAgICAgIEBwYXJhbSAge09iamVjdH0gICAgc3RhcnRFdmVudAogICAqICAgICAgY29udGFpbnMgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGZpcnN0IGdlc3R1cmUgZGV0ZWN0aW9uIGluIHRoaXMgc2Vzc2lvbmljLgogICAqICAgICAgVXNlZCBmb3IgY2FsY3VsYXRpb25zIGFib3V0IHRpbWluZywgZGlzdGFuY2UsIGV0Yy4KICAgKgogICAqICAgICAgcmVhZG9ubHkKICAgKiAgICAgIEBwYXJhbSAge09iamVjdH0gICAgbGFzdEV2ZW50CiAgICogICAgICBjb250YWlucyBhbGwgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGxhc3QgZ2VzdHVyZSBkZXRlY3QgaW4gdGhpcyBzZXNzaW9uaWMuCiAgICoKICAgKiBhZnRlciB0aGUgZ2VzdHVyZSBkZXRlY3Rpb24gc2Vzc2lvbiBoYXMgYmVlbiBjb21wbGV0ZWQgKHVzZXIgaGFzIHJlbGVhc2VkIHRoZSBzY3JlZW4pCiAgICogdGhlIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLmN1cnJlbnQgb2JqZWN0IGlzIGNvcGllZCBpbnRvIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLnByZXZpb3VzLAogICAqIHRoaXMgaXMgdXNlZnVsbCBmb3IgZ2VzdHVyZXMgbGlrZSBkb3VibGV0YXAsIHdoZXJlIHlvdSBuZWVkIHRvIGtub3cgaWYgdGhlCiAgICogcHJldmlvdXMgZ2VzdHVyZSB3YXMgYSB0YXAKICAgKgogICAqIG9wdGlvbnMgdGhhdCBoYXZlIGJlZW4gc2V0IGJ5IHRoZSBpbnN0YW5jZSBjYW4gYmUgcmVjZWl2ZWQgYnkgY2FsbGluZyBpbnN0Lm9wdGlvbnMKICAgKgogICAqIFlvdSBjYW4gdHJpZ2dlciBhIGdlc3R1cmUgZXZlbnQgYnkgY2FsbGluZyBpbnN0LnRyaWdnZXIoIm15Z2VzdHVyZSIsIGV2ZW50KS4KICAgKiBUaGUgZmlyc3QgcGFyYW0gaXMgdGhlIG5hbWUgb2YgeW91ciBnZXN0dXJlLCB0aGUgc2Vjb25kIHRoZSBldmVudCBhcmd1bWVudAogICAqCiAgICoKICAgKiBSZWdpc3RlciBnZXN0dXJlcwogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogV2hlbiBhbiBnZXN0dXJlIGlzIGFkZGVkIHRvIHRoZSBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcyBvYmplY3QsIGl0IGlzIGF1dG8gcmVnaXN0ZXJlZAogICAqIGF0IHRoZSBzZXR1cCBvZiB0aGUgZmlyc3QgaW9uaWMuR2VzdHVyZXMgaW5zdGFuY2UuIFlvdSBjYW4gYWxzbyBjYWxsIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLnJlZ2lzdGVyCiAgICogbWFudWFsbHkgYW5kIHBhc3MgeW91ciBnZXN0dXJlIG9iamVjdCBhcyBhIHBhcmFtCiAgICoKICAgKi8KCiAgLyoqCiAgICogSG9sZAogICAqIFRvdWNoIHN0YXlzIGF0IHRoZSBzYW1lIHBsYWNlIGZvciB4IHRpbWUKICAgKiBldmVudHMgIGhvbGQKICAgKi8KICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5Ib2xkID0gewogICAgbmFtZTogJ2hvbGQnLAogICAgaW5kZXg6IDEwLAogICAgZGVmYXVsdHM6IHsKICAgICAgaG9sZF90aW1lb3V0CTogNTAwLAogICAgICBob2xkX3RocmVzaG9sZAk6IDEKICAgIH0sCiAgICB0aW1lcjogbnVsbCwKICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGhvbGRHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUOgogICAgICAgICAgLy8gY2xlYXIgYW55IHJ1bm5pbmcgdGltZXJzCiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgogICAgICAgICAgLy8gc2V0IHRoZSBnZXN0dXJlIHNvIHdlIGNhbiBjaGVjayBpbiB0aGUgdGltZW91dCBpZiBpdCBzdGlsbCBpcwogICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSA9IHRoaXMubmFtZTsKCiAgICAgICAgICAvLyBzZXQgdGltZXIgYW5kIGlmIGFmdGVyIHRoZSB0aW1lb3V0IGl0IHN0aWxsIGlzIGhvbGQsCiAgICAgICAgICAvLyB3ZSB0cmlnZ2VyIHRoZSBob2xkIGV2ZW50CiAgICAgICAgICB0aGlzLnRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSA9PSAnaG9sZCcpIHsKICAgICAgICAgICAgICBpb25pYy50YXAuY2FuY2VsQ2xpY2soKTsKICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ2hvbGQnLCBldik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIGluc3Qub3B0aW9ucy5ob2xkX3RpbWVvdXQpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgICAgLy8gd2hlbiB5b3UgbW92ZSBvciBlbmQgd2UgY2xlYXIgdGhlIHRpbWVyCiAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFOgogICAgICAgICAgaWYoZXYuZGlzdGFuY2UgPiBpbnN0Lm9wdGlvbnMuaG9sZF90aHJlc2hvbGQpIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EOgogICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9OwoKCiAgLyoqCiAgICogVGFwL0RvdWJsZVRhcAogICAqIFF1aWNrIHRvdWNoIGF0IGEgcGxhY2Ugb3IgZG91YmxlIGF0IHRoZSBzYW1lIHBsYWNlCiAgICogZXZlbnRzICB0YXAsIGRvdWJsZXRhcAogICAqLwogIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLlRhcCA9IHsKICAgIG5hbWU6ICd0YXAnLAogICAgaW5kZXg6IDEwMCwKICAgIGRlZmF1bHRzOiB7CiAgICAgIHRhcF9tYXhfdG91Y2h0aW1lCTogMjUwLAogICAgICB0YXBfbWF4X2Rpc3RhbmNlCTogMTAsCiAgICAgIHRhcF9hbHdheXMJCQk6IHRydWUsCiAgICAgIGRvdWJsZXRhcF9kaXN0YW5jZQk6IDIwLAogICAgICBkb3VibGV0YXBfaW50ZXJ2YWwJOiAzMDAKICAgIH0sCiAgICBoYW5kbGVyOiBmdW5jdGlvbiB0YXBHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQgJiYgZXYuc3JjRXZlbnQudHlwZSAhPSAndG91Y2hjYW5jZWwnKSB7CiAgICAgICAgLy8gcHJldmlvdXMgZ2VzdHVyZSwgZm9yIHRoZSBkb3VibGUgdGFwIHNpbmNlIHRoZXNlIGFyZSB0d28gZGlmZmVyZW50IGdlc3R1cmUgZGV0ZWN0aW9ucwogICAgICAgIHZhciBwcmV2ID0gaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLnByZXZpb3VzLAogICAgICAgIGRpZF9kb3VibGV0YXAgPSBmYWxzZTsKCiAgICAgICAgLy8gd2hlbiB0aGUgdG91Y2h0aW1lIGlzIGhpZ2hlciB0aGVuIHRoZSBtYXggdG91Y2ggdGltZQogICAgICAgIC8vIG9yIHdoZW4gdGhlIG1vdmluZyBkaXN0YW5jZSBpcyB0b28gbXVjaAogICAgICAgIGlmKGV2LmRlbHRhVGltZSA+IGluc3Qub3B0aW9ucy50YXBfbWF4X3RvdWNodGltZSB8fAogICAgICAgICAgICBldi5kaXN0YW5jZSA+IGluc3Qub3B0aW9ucy50YXBfbWF4X2Rpc3RhbmNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgIC8vIGNoZWNrIGlmIGRvdWJsZSB0YXAKICAgICAgICBpZihwcmV2ICYmIHByZXYubmFtZSA9PSAndGFwJyAmJgogICAgICAgICAgICAoZXYudGltZVN0YW1wIC0gcHJldi5sYXN0RXZlbnQudGltZVN0YW1wKSA8IGluc3Qub3B0aW9ucy5kb3VibGV0YXBfaW50ZXJ2YWwgJiYKICAgICAgICAgICAgZXYuZGlzdGFuY2UgPCBpbnN0Lm9wdGlvbnMuZG91YmxldGFwX2Rpc3RhbmNlKSB7CiAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdkb3VibGV0YXAnLCBldik7CiAgICAgICAgICAgICAgZGlkX2RvdWJsZXRhcCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gZG8gYSBzaW5nbGUgdGFwCiAgICAgICAgaWYoIWRpZF9kb3VibGV0YXAgfHwgaW5zdC5vcHRpb25zLnRhcF9hbHdheXMpIHsKICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSAndGFwJzsKICAgICAgICAgIGluc3QudHJpZ2dlcigndGFwJywgZXYpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgoKICAvKioKICAgKiBTd2lwZQogICAqIHRyaWdnZXJzIHN3aXBlIGV2ZW50cyB3aGVuIHRoZSBlbmQgdmVsb2NpdHkgaXMgYWJvdmUgdGhlIHRocmVzaG9sZAogICAqIGV2ZW50cyAgc3dpcGUsIHN3aXBlbGVmdCwgc3dpcGVyaWdodCwgc3dpcGV1cCwgc3dpcGVkb3duCiAgICovCiAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuU3dpcGUgPSB7CiAgICBuYW1lOiAnc3dpcGUnLAogICAgaW5kZXg6IDQwLAogICAgZGVmYXVsdHM6IHsKICAgICAgLy8gc2V0IDAgZm9yIHVubGltaXRlZCwgYnV0IHRoaXMgY2FuIGNvbmZsaWN0IHdpdGggdHJhbnNmb3JtCiAgICAgIHN3aXBlX21heF90b3VjaGVzICA6IDEsCiAgICAgIHN3aXBlX3ZlbG9jaXR5ICAgICA6IDAuNwogICAgfSwKICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHN3aXBlR2VzdHVyZShldiwgaW5zdCkgewogICAgICBpZihldi5ldmVudFR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EKSB7CiAgICAgICAgLy8gbWF4IHRvdWNoZXMKICAgICAgICBpZihpbnN0Lm9wdGlvbnMuc3dpcGVfbWF4X3RvdWNoZXMgPiAwICYmCiAgICAgICAgICAgIGV2LnRvdWNoZXMubGVuZ3RoID4gaW5zdC5vcHRpb25zLnN3aXBlX21heF90b3VjaGVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgIC8vIHdoZW4gdGhlIGRpc3RhbmNlIHdlIG1vdmVkIGlzIHRvbyBzbWFsbCB3ZSBza2lwIHRoaXMgZ2VzdHVyZQogICAgICAgIC8vIG9yIHdlIGNhbiBiZSBhbHJlYWR5IGluIGRyYWdnaW5nCiAgICAgICAgaWYoZXYudmVsb2NpdHlYID4gaW5zdC5vcHRpb25zLnN3aXBlX3ZlbG9jaXR5IHx8CiAgICAgICAgICAgIGV2LnZlbG9jaXR5WSA+IGluc3Qub3B0aW9ucy5zd2lwZV92ZWxvY2l0eSkgewogICAgICAgICAgICAgIC8vIHRyaWdnZXIgc3dpcGUgZXZlbnRzCiAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwogICAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKyBldi5kaXJlY3Rpb24sIGV2KTsKICAgICAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCgogIC8qKgogICAqIERyYWcKICAgKiBNb3ZlIHdpdGggeCBmaW5nZXJzIChkZWZhdWx0IDEpIGFyb3VuZCBvbiB0aGUgcGFnZS4gQmxvY2tpbmcgdGhlIHNjcm9sbGluZyB3aGVuCiAgICogbW92aW5nIGxlZnQgYW5kIHJpZ2h0IGlzIGEgZ29vZCBwcmFjdGljZS4gV2hlbiBhbGwgdGhlIGRyYWcgZXZlbnRzIGFyZSBibG9ja2luZwogICAqIHlvdSBkaXNhYmxlIHNjcm9sbGluZyBvbiB0aGF0IGFyZWEuCiAgICogZXZlbnRzICBkcmFnLCBkcmFwbGVmdCwgZHJhZ3JpZ2h0LCBkcmFndXAsIGRyYWdkb3duCiAgICovCiAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuRHJhZyA9IHsKICAgIG5hbWU6ICdkcmFnJywKICAgIGluZGV4OiA1MCwKICAgIGRlZmF1bHRzOiB7CiAgICAgIGRyYWdfbWluX2Rpc3RhbmNlIDogMTAsCiAgICAgIC8vIFNldCBjb3JyZWN0X2Zvcl9kcmFnX21pbl9kaXN0YW5jZSB0byB0cnVlIHRvIG1ha2UgdGhlIHN0YXJ0aW5nIHBvaW50IG9mIHRoZSBkcmFnCiAgICAgIC8vIGJlIGNhbGN1bGF0ZWQgZnJvbSB3aGVyZSB0aGUgZHJhZyB3YXMgdHJpZ2dlcmVkLCBub3QgZnJvbSB3aGVyZSB0aGUgdG91Y2ggc3RhcnRlZC4KICAgICAgLy8gVXNlZnVsIHRvIGF2b2lkIGEgamVyay1zdGFydGluZyBkcmFnLCB3aGljaCBjYW4gbWFrZSBmaW5lLWFkanVzdG1lbnRzCiAgICAgIC8vIHRocm91Z2ggZHJhZ2dpbmcgZGlmZmljdWx0LCBhbmQgYmUgdmlzdWFsbHkgdW5hcHBlYWxpbmcuCiAgICAgIGNvcnJlY3RfZm9yX2RyYWdfbWluX2Rpc3RhbmNlIDogdHJ1ZSwKICAgICAgLy8gc2V0IDAgZm9yIHVubGltaXRlZCwgYnV0IHRoaXMgY2FuIGNvbmZsaWN0IHdpdGggdHJhbnNmb3JtCiAgICAgIGRyYWdfbWF4X3RvdWNoZXMgIDogMSwKICAgICAgLy8gcHJldmVudCBkZWZhdWx0IGJyb3dzZXIgYmVoYXZpb3Igd2hlbiBkcmFnZ2luZyBvY2N1cnMKICAgICAgLy8gYmUgY2FyZWZ1bCB3aXRoIGl0LCBpdCBtYWtlcyB0aGUgZWxlbWVudCBhIGJsb2NraW5nIGVsZW1lbnQKICAgICAgLy8gd2hlbiB5b3UgYXJlIHVzaW5nIHRoZSBkcmFnIGdlc3R1cmUsIGl0IGlzIGEgZ29vZCBwcmFjdGljZSB0byBzZXQgdGhpcyB0cnVlCiAgICAgIGRyYWdfYmxvY2tfaG9yaXpvbnRhbCAgIDogdHJ1ZSwKICAgICAgZHJhZ19ibG9ja192ZXJ0aWNhbCAgICAgOiB0cnVlLAogICAgICAvLyBkcmFnX2xvY2tfdG9fYXhpcyBrZWVwcyB0aGUgZHJhZyBnZXN0dXJlIG9uIHRoZSBheGlzIHRoYXQgaXQgc3RhcnRlZCBvbiwKICAgICAgLy8gSXQgZGlzYWxsb3dzIHZlcnRpY2FsIGRpcmVjdGlvbnMgaWYgdGhlIGluaXRpYWwgZGlyZWN0aW9uIHdhcyBob3Jpem9udGFsLCBhbmQgdmljZSB2ZXJzYS4KICAgICAgZHJhZ19sb2NrX3RvX2F4aXMgICAgICAgOiBmYWxzZSwKICAgICAgLy8gZHJhZyBsb2NrIG9ubHkga2lja3MgaW4gd2hlbiBkaXN0YW5jZSA+IGRyYWdfbG9ja19taW5fZGlzdGFuY2UKICAgICAgLy8gVGhpcyB3YXksIGxvY2tpbmcgb2NjdXJzIG9ubHkgd2hlbiB0aGUgZGlzdGFuY2UgaGFzIGJlY29tZSBsYXJnZSBlbm91Z2ggdG8gcmVsaWFibHkgZGV0ZXJtaW5lIHRoZSBkaXJlY3Rpb24KICAgICAgZHJhZ19sb2NrX21pbl9kaXN0YW5jZSA6IDI1CiAgICB9LAogICAgdHJpZ2dlcmVkOiBmYWxzZSwKICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGRyYWdHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgIC8vIGN1cnJlbnQgZ2VzdHVyZSBpc250IGRyYWcsIGJ1dCBkcmFnZ2VkIGlzIHRydWUKICAgICAgLy8gdGhpcyBtZWFucyBhbiBvdGhlciBnZXN0dXJlIGlzIGJ1c3kuIG5vdyBjYWxsIGRyYWdlbmQKICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSAhPSB0aGlzLm5hbWUgJiYgdGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBtYXggdG91Y2hlcwogICAgICBpZihpbnN0Lm9wdGlvbnMuZHJhZ19tYXhfdG91Y2hlcyA+IDAgJiYKICAgICAgICAgIGV2LnRvdWNoZXMubGVuZ3RoID4gaW5zdC5vcHRpb25zLmRyYWdfbWF4X3RvdWNoZXMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgc3dpdGNoKGV2LmV2ZW50VHlwZSkgewogICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQ6CiAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRToKICAgICAgICAgIC8vIHdoZW4gdGhlIGRpc3RhbmNlIHdlIG1vdmVkIGlzIHRvbyBzbWFsbCB3ZSBza2lwIHRoaXMgZ2VzdHVyZQogICAgICAgICAgLy8gb3Igd2UgY2FuIGJlIGFscmVhZHkgaW4gZHJhZ2dpbmcKICAgICAgICAgIGlmKGV2LmRpc3RhbmNlIDwgaW5zdC5vcHRpb25zLmRyYWdfbWluX2Rpc3RhbmNlICYmCiAgICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSAhPSB0aGlzLm5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgLy8gd2UgYXJlIGRyYWdnaW5nIQogICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSAhPSB0aGlzLm5hbWUpIHsKICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSA9IHRoaXMubmFtZTsKICAgICAgICAgICAgaWYgKGluc3Qub3B0aW9ucy5jb3JyZWN0X2Zvcl9kcmFnX21pbl9kaXN0YW5jZSkgewogICAgICAgICAgICAgIC8vIFdoZW4gYSBkcmFnIGlzIHRyaWdnZXJlZCwgc2V0IHRoZSBldmVudCBjZW50ZXIgdG8gZHJhZ19taW5fZGlzdGFuY2UgcGl4ZWxzIGZyb20gdGhlIG9yaWdpbmFsIGV2ZW50IGNlbnRlci4KICAgICAgICAgICAgICAvLyBXaXRob3V0IHRoaXMgY29ycmVjdGlvbiwgdGhlIGRyYWdnZWQgZGlzdGFuY2Ugd291bGQganVtcHN0YXJ0IGF0IGRyYWdfbWluX2Rpc3RhbmNlIHBpeGVscyBpbnN0ZWFkIG9mIGF0IDAuCiAgICAgICAgICAgICAgLy8gSXQgbWlnaHQgYmUgdXNlZnVsIHRvIHNhdmUgdGhlIG9yaWdpbmFsIHN0YXJ0IHBvaW50IHNvbWV3aGVyZQogICAgICAgICAgICAgIHZhciBmYWN0b3IgPSBNYXRoLmFicyhpbnN0Lm9wdGlvbnMuZHJhZ19taW5fZGlzdGFuY2UvZXYuZGlzdGFuY2UpOwogICAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50LnN0YXJ0RXZlbnQuY2VudGVyLnBhZ2VYICs9IGV2LmRlbHRhWCAqIGZhY3RvcjsKICAgICAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5zdGFydEV2ZW50LmNlbnRlci5wYWdlWSArPSBldi5kZWx0YVkgKiBmYWN0b3I7CgogICAgICAgICAgICAgIC8vIHJlY2FsY3VsYXRlIGV2ZW50IGRhdGEgdXNpbmcgbmV3IHN0YXJ0IHBvaW50CiAgICAgICAgICAgICAgZXYgPSBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uZXh0ZW5kRXZlbnREYXRhKGV2KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIGxvY2sgZHJhZyB0byBheGlzPwogICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubGFzdEV2ZW50LmRyYWdfbG9ja2VkX3RvX2F4aXMgfHwgKGluc3Qub3B0aW9ucy5kcmFnX2xvY2tfdG9fYXhpcyAmJiBpbnN0Lm9wdGlvbnMuZHJhZ19sb2NrX21pbl9kaXN0YW5jZTw9ZXYuZGlzdGFuY2UpKSB7CiAgICAgICAgICAgIGV2LmRyYWdfbG9ja2VkX3RvX2F4aXMgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RfZGlyZWN0aW9uID0gaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubGFzdEV2ZW50LmRpcmVjdGlvbjsKICAgICAgICAgIGlmKGV2LmRyYWdfbG9ja2VkX3RvX2F4aXMgJiYgbGFzdF9kaXJlY3Rpb24gIT09IGV2LmRpcmVjdGlvbikgewogICAgICAgICAgICAvLyBrZWVwIGRpcmVjdGlvbiBvbiB0aGUgYXhpcyB0aGF0IHRoZSBkcmFnIGdlc3R1cmUgc3RhcnRlZCBvbgogICAgICAgICAgICBpZihpb25pYy5HZXN0dXJlcy51dGlscy5pc1ZlcnRpY2FsKGxhc3RfZGlyZWN0aW9uKSkgewogICAgICAgICAgICAgIGV2LmRpcmVjdGlvbiA9IChldi5kZWx0YVkgPCAwKSA/IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9VUCA6IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9ET1dOOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGV2LmRpcmVjdGlvbiA9IChldi5kZWx0YVggPCAwKSA/IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9MRUZUIDogaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1JJR0hUOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZmlyc3QgdGltZSwgdHJpZ2dlciBkcmFnc3RhcnQgZXZlbnQKICAgICAgICAgIGlmKCF0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnc3RhcnQnLCBldik7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyB0cmlnZ2VyIG5vcm1hbCBldmVudAogICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwoKICAgICAgICAgIC8vIGRpcmVjdGlvbiBldmVudCwgbGlrZSBkcmFnZG93bgogICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArIGV2LmRpcmVjdGlvbiwgZXYpOwoKICAgICAgICAgIC8vIGJsb2NrIHRoZSBicm93c2VyIGV2ZW50cwogICAgICAgICAgaWYoIChpbnN0Lm9wdGlvbnMuZHJhZ19ibG9ja192ZXJ0aWNhbCAmJiBpb25pYy5HZXN0dXJlcy51dGlscy5pc1ZlcnRpY2FsKGV2LmRpcmVjdGlvbikpIHx8CiAgICAgICAgICAgICAgKGluc3Qub3B0aW9ucy5kcmFnX2Jsb2NrX2hvcml6b250YWwgJiYgIWlvbmljLkdlc3R1cmVzLnV0aWxzLmlzVmVydGljYWwoZXYuZGlyZWN0aW9uKSkpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EOgogICAgICAgICAgLy8gdHJpZ2dlciBkcmFnZW5kCiAgICAgICAgICBpZih0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH07CgoKICAvKioKICAgKiBUcmFuc2Zvcm0KICAgKiBVc2VyIHdhbnQgdG8gc2NhbGUgb3Igcm90YXRlIHdpdGggMiBmaW5nZXJzCiAgICogZXZlbnRzICB0cmFuc2Zvcm0sIHBpbmNoLCBwaW5jaGluLCBwaW5jaG91dCwgcm90YXRlCiAgICovCiAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuVHJhbnNmb3JtID0gewogICAgbmFtZTogJ3RyYW5zZm9ybScsCiAgICBpbmRleDogNDUsCiAgICBkZWZhdWx0czogewogICAgICAvLyBmYWN0b3IsIG5vIHNjYWxlIGlzIDEsIHpvb21pbiBpcyB0byAwIGFuZCB6b29tb3V0IHVudGlsIGhpZ2hlciB0aGVuIDEKICAgICAgdHJhbnNmb3JtX21pbl9zY2FsZSAgICAgOiAwLjAxLAogICAgICAvLyByb3RhdGlvbiBpbiBkZWdyZWVzCiAgICAgIHRyYW5zZm9ybV9taW5fcm90YXRpb24gIDogMSwKICAgICAgLy8gcHJldmVudCBkZWZhdWx0IGJyb3dzZXIgYmVoYXZpb3Igd2hlbiB0d28gdG91Y2hlcyBhcmUgb24gdGhlIHNjcmVlbgogICAgICAvLyBidXQgaXQgbWFrZXMgdGhlIGVsZW1lbnQgYSBibG9ja2luZyBlbGVtZW50CiAgICAgIC8vIHdoZW4geW91IGFyZSB1c2luZyB0aGUgdHJhbnNmb3JtIGdlc3R1cmUsIGl0IGlzIGEgZ29vZCBwcmFjdGljZSB0byBzZXQgdGhpcyB0cnVlCiAgICAgIHRyYW5zZm9ybV9hbHdheXNfYmxvY2sgIDogZmFsc2UKICAgIH0sCiAgICB0cmlnZ2VyZWQ6IGZhbHNlLAogICAgaGFuZGxlcjogZnVuY3Rpb24gdHJhbnNmb3JtR2VzdHVyZShldiwgaW5zdCkgewogICAgICAvLyBjdXJyZW50IGdlc3R1cmUgaXNudCBkcmFnLCBidXQgZHJhZ2dlZCBpcyB0cnVlCiAgICAgIC8vIHRoaXMgbWVhbnMgYW4gb3RoZXIgZ2VzdHVyZSBpcyBidXN5LiBub3cgY2FsbCBkcmFnZW5kCiAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lICYmIHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ2VuZCcsIGV2KTsKICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gYXRsZWFzdCBtdWx0aXRvdWNoCiAgICAgIGlmKGV2LnRvdWNoZXMubGVuZ3RoIDwgMikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gcHJldmVudCBkZWZhdWx0IHdoZW4gdHdvIGZpbmdlcnMgYXJlIG9uIHRoZSBzY3JlZW4KICAgICAgaWYoaW5zdC5vcHRpb25zLnRyYW5zZm9ybV9hbHdheXNfYmxvY2spIHsKICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CgogICAgICBzd2l0Y2goZXYuZXZlbnRUeXBlKSB7CiAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVDoKICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFOgogICAgICAgICAgdmFyIHNjYWxlX3RocmVzaG9sZCA9IE1hdGguYWJzKDEtZXYuc2NhbGUpOwogICAgICAgICAgdmFyIHJvdGF0aW9uX3RocmVzaG9sZCA9IE1hdGguYWJzKGV2LnJvdGF0aW9uKTsKCiAgICAgICAgICAvLyB3aGVuIHRoZSBkaXN0YW5jZSB3ZSBtb3ZlZCBpcyB0b28gc21hbGwgd2Ugc2tpcCB0aGlzIGdlc3R1cmUKICAgICAgICAgIC8vIG9yIHdlIGNhbiBiZSBhbHJlYWR5IGluIGRyYWdnaW5nCiAgICAgICAgICBpZihzY2FsZV90aHJlc2hvbGQgPCBpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX21pbl9zY2FsZSAmJgogICAgICAgICAgICAgIHJvdGF0aW9uX3RocmVzaG9sZCA8IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3JvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2Zvcm1pbmchCiAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5uYW1lID0gdGhpcy5uYW1lOwoKICAgICAgICAgIC8vIGZpcnN0IHRpbWUsIHRyaWdnZXIgZHJhZ3N0YXJ0IGV2ZW50CiAgICAgICAgICBpZighdGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ3N0YXJ0JywgZXYpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOyAvLyBiYXNpYyB0cmFuc2Zvcm0gZXZlbnQKCiAgICAgICAgICAvLyB0cmlnZ2VyIHJvdGF0ZSBldmVudAogICAgICAgICAgaWYocm90YXRpb25fdGhyZXNob2xkID4gaW5zdC5vcHRpb25zLnRyYW5zZm9ybV9taW5fcm90YXRpb24pIHsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdyb3RhdGUnLCBldik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gdHJpZ2dlciBwaW5jaCBldmVudAogICAgICAgICAgaWYoc2NhbGVfdGhyZXNob2xkID4gaW5zdC5vcHRpb25zLnRyYW5zZm9ybV9taW5fc2NhbGUpIHsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdwaW5jaCcsIGV2KTsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdwaW5jaCcrICgoZXYuc2NhbGUgPCAxKSA/ICdpbicgOiAnb3V0JyksIGV2KTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORDoKICAgICAgICAgIC8vIHRyaWdnZXIgZHJhZ2VuZAogICAgICAgICAgaWYodGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ2VuZCcsIGV2KTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9OwoKCiAgLyoqCiAgICogVG91Y2gKICAgKiBDYWxsZWQgYXMgZmlyc3QsIHRlbGxzIHRoZSB1c2VyIGhhcyB0b3VjaGVkIHRoZSBzY3JlZW4KICAgKiBldmVudHMgIHRvdWNoCiAgICovCiAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuVG91Y2ggPSB7CiAgICBuYW1lOiAndG91Y2gnLAogICAgaW5kZXg6IC1JbmZpbml0eSwKICAgIGRlZmF1bHRzOiB7CiAgICAgIC8vIGNhbGwgcHJldmVudERlZmF1bHQgYXQgdG91Y2hzdGFydCwgYW5kIG1ha2VzIHRoZSBlbGVtZW50IGJsb2NraW5nIGJ5CiAgICAgIC8vIGRpc2FibGluZyB0aGUgc2Nyb2xsaW5nIG9mIHRoZSBwYWdlLCBidXQgaXQgaW1wcm92ZXMgZ2VzdHVyZXMgbGlrZQogICAgICAvLyB0cmFuc2Zvcm1pbmcgYW5kIGRyYWdnaW5nLgogICAgICAvLyBiZSBjYXJlZnVsIHdpdGggdXNpbmcgdGhpcywgaXQgY2FuIGJlIHZlcnkgYW5ub3lpbmcgZm9yIHVzZXJzIHRvIGJlIHN0dWNrCiAgICAgIC8vIG9uIHRoZSBwYWdlCiAgICAgIHByZXZlbnRfZGVmYXVsdDogZmFsc2UsCgogICAgICAvLyBkaXNhYmxlIG1vdXNlIGV2ZW50cywgc28gb25seSB0b3VjaCAob3IgcGVuISkgaW5wdXQgdHJpZ2dlcnMgZXZlbnRzCiAgICAgIHByZXZlbnRfbW91c2VldmVudHM6IGZhbHNlCiAgICB9LAogICAgaGFuZGxlcjogZnVuY3Rpb24gdG91Y2hHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgIGlmKGluc3Qub3B0aW9ucy5wcmV2ZW50X21vdXNlZXZlbnRzICYmIGV2LnBvaW50ZXJUeXBlID09IGlvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0UpIHsKICAgICAgICBldi5zdG9wRGV0ZWN0KCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZihpbnN0Lm9wdGlvbnMucHJldmVudF9kZWZhdWx0KSB7CiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgfQoKICAgICAgaWYoZXYuZXZlbnRUeXBlID09ICBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVCkgewogICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICAgICAgfQogICAgfQogIH07CgoKICAvKioKICAgKiBSZWxlYXNlCiAgICogQ2FsbGVkIGFzIGxhc3QsIHRlbGxzIHRoZSB1c2VyIGhhcyByZWxlYXNlZCB0aGUgc2NyZWVuCiAgICogZXZlbnRzICByZWxlYXNlCiAgICovCiAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuUmVsZWFzZSA9IHsKICAgIG5hbWU6ICdyZWxlYXNlJywKICAgIGluZGV4OiBJbmZpbml0eSwKICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHJlbGVhc2VHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EKSB7CiAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwogICAgICB9CiAgICB9CiAgfTsKfSkod2luZG93LmlvbmljKTsKCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCBpb25pYykgewoKICB2YXIgSU9TID0gJ2lvcyc7CiAgdmFyIEFORFJPSUQgPSAnYW5kcm9pZCc7CiAgdmFyIFdJTkRPV1NfUEhPTkUgPSAnd2luZG93c3Bob25lJzsKCiAgLyoqCiAgICogQG5nZG9jIHV0aWxpdHkKICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybQogICAqIEBtb2R1bGUgaW9uaWMKICAgKi8KICBpb25pYy5QbGF0Zm9ybSA9IHsKCiAgICAvLyBQdXQgbmF2aWdhdG9yIG9uIHBsYXRmb3JtIHNvIGl0IGNhbiBiZSBtb2NrZWQgYW5kIHNldAogICAgLy8gdGhlIGJyb3dzZXIgZG9lcyBub3QgYWxsb3cgd2luZG93Lm5hdmlnYXRvciB0byBiZSBzZXQKICAgIG5hdmlnYXRvcjogd2luZG93Lm5hdmlnYXRvciwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNSZWFkeQogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGRldmljZSBpcyByZWFkeS4KICAgICAqLwogICAgaXNSZWFkeTogZmFsc2UsCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNGdWxsU2NyZWVuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZGV2aWNlIGlzIGZ1bGxzY3JlZW4uCiAgICAgKi8KICAgIGlzRnVsbFNjcmVlbjogZmFsc2UsCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jcGxhdGZvcm1zCiAgICAgKiBAcmV0dXJucyB7QXJyYXkoc3RyaW5nKX0gQW4gYXJyYXkgb2YgYWxsIHBsYXRmb3JtcyBmb3VuZC4KICAgICAqLwogICAgcGxhdGZvcm1zOiBudWxsLAogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2dyYWRlCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBXaGF0IGdyYWRlIHRoZSBjdXJyZW50IHBsYXRmb3JtIGlzLgogICAgICovCiAgICBncmFkZTogbnVsbCwKICAgIHVhOiBuYXZpZ2F0b3IudXNlckFnZW50LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jcmVhZHkKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVHJpZ2dlciBhIGNhbGxiYWNrIG9uY2UgdGhlIGRldmljZSBpcyByZWFkeSwgb3IgaW1tZWRpYXRlbHkKICAgICAqIGlmIHRoZSBkZXZpY2UgaXMgYWxyZWFkeSByZWFkeS4gVGhpcyBtZXRob2QgY2FuIGJlIHJ1biBmcm9tCiAgICAgKiBhbnl3aGVyZSBhbmQgZG9lcyBub3QgbmVlZCB0byBiZSB3cmFwcGVkIGJ5IGFueSBhZGRpdG9uYWwgbWV0aG9kcy4KICAgICAqIFdoZW4gdGhlIGFwcCBpcyB3aXRoaW4gYSBXZWJWaWV3IChDb3Jkb3ZhKSwgaXQnbGwgZmlyZQogICAgICogdGhlIGNhbGxiYWNrIG9uY2UgdGhlIGRldmljZSBpcyByZWFkeS4gSWYgdGhlIGFwcCBpcyB3aXRoaW4KICAgICAqIGEgd2ViIGJyb3dzZXIsIGl0J2xsIGZpcmUgdGhlIGNhbGxiYWNrIGFmdGVyIGB3aW5kb3cubG9hZGAuCiAgICAgKiBQbGVhc2UgcmVtZW1iZXIgdGhhdCBDb3Jkb3ZhIGZlYXR1cmVzIChDYW1lcmEsIEZpbGVTeXN0ZW0sIGV0Yykgc3RpbGwKICAgICAqIHdpbGwgbm90IHdvcmsgaW4gYSB3ZWIgYnJvd3Nlci4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsLgogICAgICovCiAgICByZWFkeTogZnVuY3Rpb24oY2IpIHsKICAgICAgLy8gcnVuIHRocm91Z2ggdGFza3MgdG8gY29tcGxldGUgbm93IHRoYXQgdGhlIGRldmljZSBpcyByZWFkeQogICAgICBpZih0aGlzLmlzUmVhZHkpIHsKICAgICAgICBjYigpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIHRoZSBwbGF0Zm9ybSBpc24ndCByZWFkeSB5ZXQsIGFkZCBpdCB0byB0aGlzIGFycmF5CiAgICAgICAgLy8gd2hpY2ggd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgcGxhdGZvcm0gaXMgcmVhZHkKICAgICAgICByZWFkeUNhbGxiYWNrcy5wdXNoKGNiKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGRldGVjdDogZnVuY3Rpb24oKSB7CiAgICAgIGlvbmljLlBsYXRmb3JtLl9jaGVja1BsYXRmb3JtcygpOwoKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgLy8gb25seSBhZGQgdG8gdGhlIGJvZHkgY2xhc3MgaWYgd2UgZ290IHBsYXRmb3JtIGluZm8KICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgaW9uaWMuUGxhdGZvcm0ucGxhdGZvcm1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ3BsYXRmb3JtLScgKyBpb25pYy5QbGF0Zm9ybS5wbGF0Zm9ybXNbaV0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jc2V0R3JhZGUKICAgICAqIEBkZXNjcmlwdGlvbiBTZXQgdGhlIGdyYWRlIG9mIHRoZSBkZXZpY2U6ICdhJywgJ2InLCBvciAnYycuICdhJyBpcyB0aGUgYmVzdAogICAgICogKG1vc3QgY3NzIGZlYXR1cmVzIGVuYWJsZWQpLCAnYycgaXMgdGhlIHdvcnN0LiAgQnkgZGVmYXVsdCwgc2V0cyB0aGUgZ3JhZGUKICAgICAqIGRlcGVuZGluZyBvbiB0aGUgY3VycmVudCBkZXZpY2UuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZ3JhZGUgVGhlIG5ldyBncmFkZSB0byBzZXQuCiAgICAgKi8KICAgIHNldEdyYWRlOiBmdW5jdGlvbihncmFkZSkgewogICAgICB2YXIgb2xkR3JhZGUgPSB0aGlzLmdyYWRlOwogICAgICB0aGlzLmdyYWRlID0gZ3JhZGU7CiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICBpZiAob2xkR3JhZGUpIHsKICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnZ3JhZGUtJyArIG9sZEdyYWRlKTsKICAgICAgICB9CiAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdncmFkZS0nICsgZ3JhZGUpOwogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNkZXZpY2UKICAgICAqIEBkZXNjcmlwdGlvbiBSZXR1cm4gdGhlIGN1cnJlbnQgZGV2aWNlIChnaXZlbiBieSBjb3Jkb3ZhKS4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFRoZSBkZXZpY2Ugb2JqZWN0LgogICAgICovCiAgICBkZXZpY2U6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gd2luZG93LmRldmljZSB8fCB7fTsKICAgIH0sCgogICAgX2NoZWNrUGxhdGZvcm1zOiBmdW5jdGlvbihwbGF0Zm9ybXMpIHsKICAgICAgdGhpcy5wbGF0Zm9ybXMgPSBbXTsKICAgICAgdmFyIGdyYWRlID0gJ2EnOwoKICAgICAgaWYodGhpcy5pc1dlYlZpZXcoKSkgewogICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2goJ3dlYnZpZXcnKTsKICAgICAgICB0aGlzLnBsYXRmb3Jtcy5wdXNoKCdjb3Jkb3ZhJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wbGF0Zm9ybXMucHVzaCgnYnJvd3NlcicpOwogICAgICB9CiAgICAgIGlmKHRoaXMuaXNJUGFkKCkpIHRoaXMucGxhdGZvcm1zLnB1c2goJ2lwYWQnKTsKCiAgICAgIHZhciBwbGF0Zm9ybSA9IHRoaXMucGxhdGZvcm0oKTsKICAgICAgaWYocGxhdGZvcm0pIHsKICAgICAgICB0aGlzLnBsYXRmb3Jtcy5wdXNoKHBsYXRmb3JtKTsKCiAgICAgICAgdmFyIHZlcnNpb24gPSB0aGlzLnZlcnNpb24oKTsKICAgICAgICBpZih2ZXJzaW9uKSB7CiAgICAgICAgICB2YXIgdiA9IHZlcnNpb24udG9TdHJpbmcoKTsKICAgICAgICAgIGlmKHYuaW5kZXhPZignLicpID4gMCkgewogICAgICAgICAgICB2ID0gdi5yZXBsYWNlKCcuJywgJ18nKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHYgKz0gJ18wJzsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2gocGxhdGZvcm0gKyB2LnNwbGl0KCdfJylbMF0pOwogICAgICAgICAgdGhpcy5wbGF0Zm9ybXMucHVzaChwbGF0Zm9ybSArIHYpOwoKICAgICAgICAgIGlmKHRoaXMuaXNBbmRyb2lkKCkgJiYgdmVyc2lvbiA8IDQuNCkgewogICAgICAgICAgICBncmFkZSA9ICh2ZXJzaW9uIDwgNCA/ICdjJyA6ICdiJyk7CiAgICAgICAgICB9IGVsc2UgaWYodGhpcy5pc1dpbmRvd3NQaG9uZSgpKSB7CiAgICAgICAgICAgIGdyYWRlID0gJ2InOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5zZXRHcmFkZShncmFkZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNXZWJWaWV3CiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gQ2hlY2sgaWYgd2UgYXJlIHJ1bm5pbmcgd2l0aGluIGEgV2ViVmlldyAoc3VjaCBhcyBDb3Jkb3ZhKS4KICAgICAqLwogICAgaXNXZWJWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICEoIXdpbmRvdy5jb3Jkb3ZhICYmICF3aW5kb3cuUGhvbmVHYXAgJiYgIXdpbmRvdy5waG9uZWdhcCk7CiAgICB9LAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNpc0lQYWQKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHdlIGFyZSBydW5uaW5nIG9uIGlQYWQuCiAgICAgKi8KICAgIGlzSVBhZDogZnVuY3Rpb24oKSB7CiAgICAgIGlmKCAvaVBhZC9pLnRlc3QoaW9uaWMuUGxhdGZvcm0ubmF2aWdhdG9yLnBsYXRmb3JtKSApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gL2lQYWQvaS50ZXN0KHRoaXMudWEpOwogICAgfSwKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNJT1MKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHdlIGFyZSBydW5uaW5nIG9uIGlPUy4KICAgICAqLwogICAgaXNJT1M6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pcyhJT1MpOwogICAgfSwKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNBbmRyb2lkCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB3ZSBhcmUgcnVubmluZyBvbiBBbmRyb2lkLgogICAgICovCiAgICBpc0FuZHJvaWQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pcyhBTkRST0lEKTsKICAgIH0sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzV2luZG93c1Bob25lCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB3ZSBhcmUgcnVubmluZyBvbiBXaW5kb3dzIFBob25lLgogICAgICovCiAgICBpc1dpbmRvd3NQaG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlzKFdJTkRPV1NfUEhPTkUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3BsYXRmb3JtCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgbmFtZSBvZiB0aGUgY3VycmVudCBwbGF0Zm9ybS4KICAgICAqLwogICAgcGxhdGZvcm06IGZ1bmN0aW9uKCkgewogICAgICAvLyBzaW5nbGV0b24gdG8gZ2V0IHRoZSBwbGF0Zm9ybSBuYW1lCiAgICAgIGlmKHBsYXRmb3JtTmFtZSA9PT0gbnVsbCkgdGhpcy5zZXRQbGF0Zm9ybSh0aGlzLmRldmljZSgpLnBsYXRmb3JtKTsKICAgICAgcmV0dXJuIHBsYXRmb3JtTmFtZTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBzZXRQbGF0Zm9ybTogZnVuY3Rpb24obikgewogICAgICBpZih0eXBlb2YgbiAhPSAndW5kZWZpbmVkJyAmJiBuICE9PSBudWxsICYmIG4ubGVuZ3RoKSB7CiAgICAgICAgcGxhdGZvcm1OYW1lID0gbi50b0xvd2VyQ2FzZSgpOwogICAgICB9IGVsc2UgaWYodGhpcy51YS5pbmRleE9mKCdBbmRyb2lkJykgPiAwKSB7CiAgICAgICAgcGxhdGZvcm1OYW1lID0gQU5EUk9JRDsKICAgICAgfSBlbHNlIGlmKHRoaXMudWEuaW5kZXhPZignaVBob25lJykgPiAtMSB8fCB0aGlzLnVhLmluZGV4T2YoJ2lQYWQnKSA+IC0xIHx8IHRoaXMudWEuaW5kZXhPZignaVBvZCcpID4gLTEpIHsKICAgICAgICBwbGF0Zm9ybU5hbWUgPSBJT1M7CiAgICAgIH0gZWxzZSBpZih0aGlzLnVhLmluZGV4T2YoJ1dpbmRvd3MgUGhvbmUnKSA+IC0xKSB7CiAgICAgICAgcGxhdGZvcm1OYW1lID0gV0lORE9XU19QSE9ORTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwbGF0Zm9ybU5hbWUgPSBpb25pYy5QbGF0Zm9ybS5uYXZpZ2F0b3IucGxhdGZvcm0gJiYgbmF2aWdhdG9yLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCkuc3BsaXQoJyAnKVswXSB8fCAnJzsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3ZlcnNpb24KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSB2ZXJzaW9uIG9mIHRoZSBjdXJyZW50IGRldmljZSBwbGF0Zm9ybS4KICAgICAqLwogICAgdmVyc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIHNpbmdsZXRvbiB0byBnZXQgdGhlIHBsYXRmb3JtIHZlcnNpb24KICAgICAgaWYocGxhdGZvcm1WZXJzaW9uID09PSBudWxsKSB0aGlzLnNldFZlcnNpb24odGhpcy5kZXZpY2UoKS52ZXJzaW9uKTsKICAgICAgcmV0dXJuIHBsYXRmb3JtVmVyc2lvbjsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBzZXRWZXJzaW9uOiBmdW5jdGlvbih2KSB7CiAgICAgIGlmKHR5cGVvZiB2ICE9ICd1bmRlZmluZWQnICYmIHYgIT09IG51bGwpIHsKICAgICAgICB2ID0gdi5zcGxpdCgnLicpOwogICAgICAgIHYgPSBwYXJzZUZsb2F0KHZbMF0gKyAnLicgKyAodi5sZW5ndGggPiAxID8gdlsxXSA6IDApKTsKICAgICAgICBpZighaXNOYU4odikpIHsKICAgICAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IHY7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICBwbGF0Zm9ybVZlcnNpb24gPSAwOwoKICAgICAgLy8gZmFsbGJhY2sgdG8gdXNlci1hZ2VudCBjaGVja2luZwogICAgICB2YXIgcE5hbWUgPSB0aGlzLnBsYXRmb3JtKCk7CiAgICAgIHZhciB2ZXJzaW9uTWF0Y2ggPSB7CiAgICAgICAgJ2FuZHJvaWQnOiAvQW5kcm9pZCAoXGQrKS4oXGQrKT8vLAogICAgICAgICdpb3MnOiAvT1MgKFxkKylfKFxkKyk/LywKICAgICAgICAnd2luZG93c3Bob25lJzogL1dpbmRvd3MgUGhvbmUgKFxkKykuKFxkKyk/LwogICAgICB9OwogICAgICBpZih2ZXJzaW9uTWF0Y2hbcE5hbWVdKSB7CiAgICAgICAgdiA9IHRoaXMudWEubWF0Y2goIHZlcnNpb25NYXRjaFtwTmFtZV0gKTsKICAgICAgICBpZih2ICYmICB2Lmxlbmd0aCA+IDIpIHsKICAgICAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IHBhcnNlRmxvYXQoIHZbMV0gKyAnLicgKyB2WzJdICk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIENoZWNrIGlmIHRoZSBwbGF0Zm9ybSBpcyB0aGUgb25lIGRldGVjdGVkIGJ5IGNvcmRvdmEKICAgIGlzOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgIHR5cGUgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgIC8vIGNoZWNrIGlmIGl0IGhhcyBhbiBhcnJheSBvZiBwbGF0Zm9ybXMKICAgICAgaWYodGhpcy5wbGF0Zm9ybXMpIHsKICAgICAgICBmb3IodmFyIHggPSAwOyB4IDwgdGhpcy5wbGF0Zm9ybXMubGVuZ3RoOyB4KyspIHsKICAgICAgICAgIGlmKHRoaXMucGxhdGZvcm1zW3hdID09PSB0eXBlKSByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZXhhY3QgbWF0Y2gKICAgICAgdmFyIHBOYW1lID0gdGhpcy5wbGF0Zm9ybSgpOwogICAgICBpZihwTmFtZSkgewogICAgICAgIHJldHVybiBwTmFtZSA9PT0gdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICB9CgogICAgICAvLyBBIHF1aWNrIGhhY2sgZm9yIHRvIGNoZWNrIHVzZXJBZ2VudAogICAgICByZXR1cm4gdGhpcy51YS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodHlwZSkgPj0gMDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNleGl0QXBwCiAgICAgKiBAZGVzY3JpcHRpb24gRXhpdCB0aGUgYXBwLgogICAgICovCiAgICBleGl0QXBwOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZWFkeShmdW5jdGlvbigpewogICAgICAgIG5hdmlnYXRvci5hcHAgJiYgbmF2aWdhdG9yLmFwcC5leGl0QXBwICYmIG5hdmlnYXRvci5hcHAuZXhpdEFwcCgpOwogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNzaG93U3RhdHVzQmFyCiAgICAgKiBAZGVzY3JpcHRpb24gU2hvd3Mgb3IgaGlkZXMgdGhlIGRldmljZSBzdGF0dXMgYmFyIChpbiBDb3Jkb3ZhKS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2hvdWxkU2hvdyBXaGV0aGVyIG9yIG5vdCB0byBzaG93IHRoZSBzdGF0dXMgYmFyLgogICAgICovCiAgICBzaG93U3RhdHVzQmFyOiBmdW5jdGlvbih2YWwpIHsKICAgICAgLy8gT25seSB1c2VmdWwgd2hlbiBydW4gd2l0aGluIGNvcmRvdmEKICAgICAgdGhpcy5fc2hvd1N0YXR1c0JhciA9IHZhbDsKICAgICAgdGhpcy5yZWFkeShmdW5jdGlvbigpewogICAgICAgIC8vIHJ1biB0aGlzIG9ubHkgd2hlbiBvciBpZiB0aGUgcGxhdGZvcm0gKGNvcmRvdmEpIGlzIHJlYWR5CiAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgICBpZihpb25pYy5QbGF0Zm9ybS5fc2hvd1N0YXR1c0JhcikgewogICAgICAgICAgICAvLyB0aGV5IGRvIG5vdCB3YW50IGl0IHRvIGJlIGZ1bGwgc2NyZWVuCiAgICAgICAgICAgIHdpbmRvdy5TdGF0dXNCYXIgJiYgd2luZG93LlN0YXR1c0Jhci5zaG93KCk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnc3RhdHVzLWJhci1oaWRlJyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBpdCBzaG91bGQgYmUgZnVsbCBzY3JlZW4KICAgICAgICAgICAgd2luZG93LlN0YXR1c0JhciAmJiB3aW5kb3cuU3RhdHVzQmFyLmhpZGUoKTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdzdGF0dXMtYmFyLWhpZGUnKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jZnVsbFNjcmVlbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXRzIHdoZXRoZXIgdGhlIGFwcCBpcyBmdWxsc2NyZWVuIG9yIG5vdCAoaW4gQ29yZG92YSkuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93RnVsbFNjcmVlbiBXaGV0aGVyIG9yIG5vdCB0byBzZXQgdGhlIGFwcCB0byBmdWxsc2NyZWVuLiBEZWZhdWx0cyB0byB0cnVlLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvd1N0YXR1c0JhciBXaGV0aGVyIG9yIG5vdCB0byBzaG93IHRoZSBkZXZpY2UncyBzdGF0dXMgYmFyLiBEZWZhdWx0cyB0byBmYWxzZS4KICAgICAqLwogICAgZnVsbFNjcmVlbjogZnVuY3Rpb24oc2hvd0Z1bGxTY3JlZW4sIHNob3dTdGF0dXNCYXIpIHsKICAgICAgLy8gc2hvd0Z1bGxTY3JlZW46IGRlZmF1bHQgaXMgdHJ1ZSBpZiBubyBwYXJhbSBwcm92aWRlZAogICAgICB0aGlzLmlzRnVsbFNjcmVlbiA9IChzaG93RnVsbFNjcmVlbiAhPT0gZmFsc2UpOwoKICAgICAgLy8gYWRkL3JlbW92ZSB0aGUgZnVsbHNjcmVlbiBjbGFzc25hbWUgdG8gdGhlIGJvZHkKICAgICAgaW9uaWMuRG9tVXRpbC5yZWFkeShmdW5jdGlvbigpewogICAgICAgIC8vIHJ1biB0aGlzIG9ubHkgd2hlbiBvciBpZiB0aGUgRE9NIGlzIHJlYWR5CiAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgICAvLyBmaXhpbmcgcGFuZSBoZWlnaHQgYmVmb3JlIHdlIGFkanVzdCB0aGlzCiAgICAgICAgICBwYW5lcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3BhbmUnKTsKICAgICAgICAgIGZvcih2YXIgaSA9IDA7aTxwYW5lcy5sZW5ndGg7aSsrKXsKICAgICAgICAgICAgcGFuZXNbaV0uc3R5bGUuaGVpZ2h0ID0gcGFuZXNbaV0ub2Zmc2V0SGVpZ2h0KyJweCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZihpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4pIHsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdmdWxsc2NyZWVuJyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2Z1bGxzY3JlZW4nKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAvLyBzaG93U3RhdHVzQmFyOiBkZWZhdWx0IGlzIGZhbHNlIGlmIG5vIHBhcmFtIHByb3ZpZGVkCiAgICAgICAgaW9uaWMuUGxhdGZvcm0uc2hvd1N0YXR1c0JhciggKHNob3dTdGF0dXNCYXIgPT09IHRydWUpICk7CiAgICAgIH0pOwogICAgfQoKICB9OwoKICB2YXIgcGxhdGZvcm1OYW1lID0gbnVsbCwgLy8ganVzdCB0aGUgbmFtZSwgbGlrZSBpT1Mgb3IgQW5kcm9pZAogIHBsYXRmb3JtVmVyc2lvbiA9IG51bGwsIC8vIGEgZmxvYXQgb2YgdGhlIG1ham9yIGFuZCBtaW5vciwgbGlrZSA3LjEKICByZWFkeUNhbGxiYWNrcyA9IFtdOwoKICAvLyBzZXR1cCBsaXN0ZW5lcnMgdG8ga25vdyB3aGVuIHRoZSBkZXZpY2UgaXMgcmVhZHkgdG8gZ28KICBmdW5jdGlvbiBvbldpbmRvd0xvYWQoKSB7CiAgICBpZihpb25pYy5QbGF0Zm9ybS5pc1dlYlZpZXcoKSkgewogICAgICAvLyB0aGUgd2luZG93IGFuZCBzY3JpcHRzIGFyZSBmdWxseSBsb2FkZWQsIGFuZCBhIGNvcmRvdmEvcGhvbmVnYXAKICAgICAgLy8gb2JqZWN0IGV4aXN0cyB0aGVuIGxldCdzIGxpc3RlbiBmb3IgdGhlIGRldmljZXJlYWR5CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImRldmljZXJlYWR5Iiwgb25QbGF0Zm9ybVJlYWR5LCBmYWxzZSk7CiAgICB9IGVsc2UgewogICAgICAvLyB0aGUgd2luZG93IGFuZCBzY3JpcHRzIGFyZSBmdWxseSBsb2FkZWQsIGJ1dCB0aGUgd2luZG93IG9iamVjdCBkb2Vzbid0IGhhdmUgdGhlCiAgICAgIC8vIGNvcmRvdmEvcGhvbmVnYXAgb2JqZWN0LCBzbyBpdHMganVzdCBhIGJyb3dzZXIsIG5vdCBhIHdlYnZpZXcgd3JhcHBlZCB3LyBjb3Jkb3ZhCiAgICAgIG9uUGxhdGZvcm1SZWFkeSgpOwogICAgfQogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImxvYWQiLCBvbldpbmRvd0xvYWQsIGZhbHNlKTsKICB9CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBvbldpbmRvd0xvYWQsIGZhbHNlKTsKCiAgZnVuY3Rpb24gb25QbGF0Zm9ybVJlYWR5KCkgewogICAgLy8gdGhlIGRldmljZSBpcyBhbGwgc2V0IHRvIGdvLCBpbml0IG91ciBvd24gc3R1ZmYgdGhlbiBmaXJlIG9mZiBvdXIgZXZlbnQKICAgIGlvbmljLlBsYXRmb3JtLmlzUmVhZHkgPSB0cnVlOwogICAgaW9uaWMuUGxhdGZvcm0uZGV0ZWN0KCk7CiAgICBmb3IodmFyIHg9MDsgeDxyZWFkeUNhbGxiYWNrcy5sZW5ndGg7IHgrKykgewogICAgICAvLyBmaXJlIG9mZiBhbGwgdGhlIGNhbGxiYWNrcyB0aGF0IHdlcmUgYWRkZWQgYmVmb3JlIHRoZSBwbGF0Zm9ybSB3YXMgcmVhZHkKICAgICAgcmVhZHlDYWxsYmFja3NbeF0oKTsKICAgIH0KICAgIHJlYWR5Q2FsbGJhY2tzID0gW107CiAgICBpb25pYy50cmlnZ2VyKCdwbGF0Zm9ybXJlYWR5JywgeyB0YXJnZXQ6IGRvY3VtZW50IH0pOwoKICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ3BsYXRmb3JtLXJlYWR5Jyk7CiAgICB9KTsKICB9Cgp9KSh0aGlzLCBkb2N1bWVudCwgaW9uaWMpOwoKKGZ1bmN0aW9uKGRvY3VtZW50LCBpb25pYykgewogICd1c2Ugc3RyaWN0JzsKCiAgLy8gSW9uaWMgQ1NTIHBvbHlmaWxscwogIGlvbmljLkNTUyA9IHt9OwoKICAoZnVuY3Rpb24oKSB7CgogICAgLy8gdHJhbnNmb3JtCiAgICB2YXIgaSwga2V5cyA9IFsnd2Via2l0VHJhbnNmb3JtJywgJ3RyYW5zZm9ybScsICctd2Via2l0LXRyYW5zZm9ybScsICd3ZWJraXQtdHJhbnNmb3JtJywKICAgICAgICAgICAgICAgICAgICctbW96LXRyYW5zZm9ybScsICdtb3otdHJhbnNmb3JtJywgJ01velRyYW5zZm9ybScsICdtb3pUcmFuc2Zvcm0nLCAnbXNUcmFuc2Zvcm0nXTsKCiAgICBmb3IoaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZVtrZXlzW2ldXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaW9uaWMuQ1NTLlRSQU5TRk9STSA9IGtleXNbaV07CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICAvLyB0cmFuc2l0aW9uCiAgICBrZXlzID0gWyd3ZWJraXRUcmFuc2l0aW9uJywgJ21velRyYW5zaXRpb24nLCAnbXNUcmFuc2l0aW9uJywgJ3RyYW5zaXRpb24nXTsKICAgIGZvcihpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlW2tleXNbaV1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpb25pYy5DU1MuVFJBTlNJVElPTiA9IGtleXNbaV07CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgfSkoKTsKCiAgLy8gY2xhc3NMaXN0IHBvbHlmaWxsIGZvciB0aGVtIG9sZGVyIEFuZHJvaWRzCiAgLy8gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vZGV2b25nb3ZldHQvMTM4MTgzOQogIGlmICghKCJjbGFzc0xpc3QiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIHR5cGVvZiBIVE1MRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShIVE1MRWxlbWVudC5wcm90b3R5cGUsICdjbGFzc0xpc3QnLCB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZShmbikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgeCwgY2xhc3NlcyA9IHNlbGYuY2xhc3NOYW1lLnNwbGl0KC9ccysvKTsKCiAgICAgICAgICAgIGZvcih4PTA7IHg8YXJndW1lbnRzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgICAgICAgZm4oY2xhc3NlcywgY2xhc3Nlcy5pbmRleE9mKGFyZ3VtZW50c1t4XSksIGFyZ3VtZW50c1t4XSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGYuY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCIgIik7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGFkZDogdXBkYXRlKGZ1bmN0aW9uKGNsYXNzZXMsIGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICB+aW5kZXggfHwgY2xhc3Nlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0pLAoKICAgICAgICAgIHJlbW92ZTogdXBkYXRlKGZ1bmN0aW9uKGNsYXNzZXMsIGluZGV4KSB7CiAgICAgICAgICAgIH5pbmRleCAmJiBjbGFzc2VzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9KSwKCiAgICAgICAgICB0b2dnbGU6IHVwZGF0ZShmdW5jdGlvbihjbGFzc2VzLCBpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgfmluZGV4ID8gY2xhc3Nlcy5zcGxpY2UoaW5kZXgsIDEpIDogY2xhc3Nlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0pLAoKICAgICAgICAgIGNvbnRhaW5zOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gISF+c2VsZi5jbGFzc05hbWUuc3BsaXQoL1xzKy8pLmluZGV4T2YodmFsdWUpOwogICAgICAgICAgfSwKCiAgICAgICAgICBpdGVtOiBmdW5jdGlvbihpKSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmLmNsYXNzTmFtZS5zcGxpdCgvXHMrLylbaV0gfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgfQogICAgfSk7CiAgfQoKfSkoZG9jdW1lbnQsIGlvbmljKTsKCgovKioKICogQG5nZG9jIHBhZ2UKICogQG5hbWUgdGFwCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqIE9uIHRvdWNoIGRldmljZXMgc3VjaCBhcyBhIHBob25lIG9yIHRhYmxldCwgc29tZSBicm93c2VycyBpbXBsZW1lbnQgYSAzMDBtcyBkZWxheSBiZXR3ZWVuCiAqIHRoZSB0aW1lIHRoZSB1c2VyIHN0b3BzIHRvdWNoaW5nIHRoZSBkaXNwbGF5IGFuZCB0aGUgbW9tZW50IHRoZSBicm93c2VyIGV4ZWN1dGVzIHRoZQogKiBjbGljay4gVGhpcyBkZWxheSB3YXMgaW5pdGlhbGx5IGludHJvZHVjZWQgc28gdGhlIGJyb3dzZXIgY2FuIGtub3cgd2hldGhlciB0aGUgdXNlciB3YW50cyB0bwogKiBkb3VibGUtdGFwIHRvIHpvb20gaW4gb24gdGhlIHdlYnBhZ2UuICBCYXNpY2FsbHksIHRoZSBicm93c2VyIHdhaXRzIHJvdWdobHkgMzAwbXMgdG8gc2VlIGlmCiAqIHRoZSB1c2VyIGlzIGRvdWJsZS10YXBwaW5nLCBvciBqdXN0IHRhcHBpbmcgb24gdGhlIGRpc3BsYXkgb25jZS4KICoKICogT3V0IG9mIHRoZSBib3gsIElvbmljIGF1dG9tYXRpY2FsbHkgcmVtb3ZlcyB0aGUgMzAwbXMgZGVsYXkgaW4gb3JkZXIgdG8gbWFrZSBJb25pYyBhcHBzCiAqIGZlZWwgbW9yZSAibmF0aXZlIiBsaWtlLiBSZXN1bHRpbmdseSwgb3RoZXIgc29sdXRpb25zIHN1Y2ggYXMKICogW2Zhc3RjbGlja10oaHR0cHM6Ly9naXRodWIuY29tL2Z0bGFicy9mYXN0Y2xpY2spIGFuZCBBbmd1bGFyJ3MKICogW25nVG91Y2hdKGh0dHBzOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZ1RvdWNoKSBzaG91bGQgbm90IGJlIGluY2x1ZGVkLCB0byBhdm9pZCBjb25mbGljdHMuCiAqCiAqIFNvbWUgYnJvd3NlcnMgYWxyZWFkeSByZW1vdmUgdGhlIGRlbGF5IHdpdGggY2VydGFpbiBzZXR0aW5ncywgc3VjaCBhcyB0aGUgQ1NTIHByb3BlcnR5CiAqIGB0b3VjaC1ldmVudHM6IG5vbmVgIG9yIHdpdGggc3BlY2lmaWMgbWV0YSB0YWcgdmlld3BvcnQgdmFsdWVzLiBIb3dldmVyLCBlYWNoIG9mIHRoZXNlCiAqIGJyb3dzZXJzIHN0aWxsIGhhbmRsZSBjbGlja3MgZGlmZmVyZW50bHksIHN1Y2ggYXMgd2hlbiB0byBmaXJlIG9mZiBvciBjYW5jZWwgdGhlIGV2ZW50CiAqIChsaWtlIHNjcm9sbGluZyB3aGVuIHRoZSB0YXJnZXQgaXMgYSBidXR0b24sIG9yIGhvbGRpbmcgYSBidXR0b24gZG93bikuCiAqIEZvciBicm93c2VycyB0aGF0IGFscmVhZHkgcmVtb3ZlIHRoZSAzMDBtcyBkZWxheSwgY29uc2lkZXIgSW9uaWMncyB0YXAgc3lzdGVtIGFzIGEgd2F5IHRvCiAqIG5vcm1hbGl6ZSBob3cgY2xpY2tzIGFyZSBoYW5kbGVkIGFjcm9zcyB0aGUgdmFyaW91cyBkZXZpY2VzIHNvIHRoZXJlJ3MgYW4gZXhwZWN0ZWQgcmVzcG9uc2UKICogbm8gbWF0dGVyIHdoYXQgdGhlIGRldmljZSwgcGxhdGZvcm0gb3IgdmVyc2lvbi4gQWRkaXRpb25hbGx5LCBJb25pYyB3aWxsIHByZXZlbnQKICogZ2hvc3RjbGlja3Mgd2hpY2ggZXZlbiBicm93c2VycyB0aGF0IHJlbW92ZSB0aGUgZGVsYXkgc3RpbGwgZXhwZXJpZW5jZS4KICoKICogSW4gc29tZSBjYXNlcywgdGhpcmQtcGFydHkgbGlicmFyaWVzIG1heSBhbHNvIGJlIHdvcmtpbmcgd2l0aCB0b3VjaCBldmVudHMgd2hpY2ggY2FuIGludGVyZmVyZQogKiB3aXRoIHRoZSB0YXAgc3lzdGVtLiBGb3IgZXhhbXBsZSwgbWFwcGluZyBsaWJyYXJpZXMgbGlrZSBHb29nbGUgb3IgTGVhZmxldCBNYXBzIG9mdGVuIGltcGxlbWVudAogKiBhIHRvdWNoIGRldGVjdGlvbiBzeXN0ZW0gd2hpY2ggY29uZmxpY3RzIHdpdGggSW9uaWMncyB0YXAgc3lzdGVtLgogKgogKiAjIyMgRGlzYWJsaW5nIHRoZSB0YXAgc3lzdGVtCiAqCiAqIFRvIGRpc2FibGUgdGhlIHRhcCBmb3IgYW4gZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBjaGlsZHJlbiBlbGVtZW50cywKICogYWRkIHRoZSBhdHRyaWJ1dGUgYGRhdGEtdGFwLWRpc2FibGVkPSJ0cnVlImAuCiAqCiAqIGBgYGh0bWwKICogPGRpdiBkYXRhLXRhcC1kaXNhYmxlZD0idHJ1ZSI+CiAqICAgICA8ZGl2IGlkPSJnb29nbGUtbWFwIj48L2Rpdj4KICogPC9kaXY+CiAqIGBgYAogKgogKiAjIyMgQWRkaXRpb25hbCBOb3RlczoKICoKICogLSBJb25pYyB0YXAgIHdvcmtzIHdpdGggSW9uaWMncyBKYXZhU2NyaXB0IHNjcm9sbGluZwogKiAtIEVsZW1lbnRzIGNhbiBjb21lIGFuZCBnbyBmcm9tIHRoZSBET00gYW5kIElvbmljIHRhcCBkb2Vzbid0IGtlZXAgYWRkaW5nIGFuZCByZW1vdmluZwogKiAgIGxpc3RlbmVycwogKiAtIE5vICJ0YXAgZGVsYXkiIGFmdGVyIHRoZSBmaXJzdCAidGFwIiAoeW91IGNhbiB0YXAgYXMgZmFzdCBhcyB5b3Ugd2FudCwgdGhleSBhbGwgY2xpY2spCiAqIC0gTWluaW1hbCBldmVudHMgbGlzdGVuZXJzLCBvbmx5IGJlaW5nIGFkZGVkIHRvIGRvY3VtZW50CiAqIC0gQ29ycmVjdCBmb2N1cyBpbi9vdXQgb24gZWFjaCBpbnB1dCB0eXBlIChzZWxlY3QsIHRleHRlYXJlYSwgcmFuZ2UpIG9uIGVhY2ggcGxhdGZvcm0vZGV2aWNlCiAqIC0gU2hvd3MgYW5kIGhpZGVzIHZpcnR1YWwga2V5Ym9hcmQgY29ycmVjdGx5IGZvciBlYWNoIHBsYXRmb3JtL2RldmljZQogKiAtIFdvcmtzIHdpdGggbGFiZWxzIHN1cnJvdW5kaW5nIGlucHV0cwogKiAtIERvZXMgbm90IGZpcmUgb2ZmIGEgY2xpY2sgaWYgdGhlIHVzZXIgbW92ZXMgdGhlIHBvaW50ZXIgdG9vIGZhcgogKiAtIEFkZHMgYW5kIHJlbW92ZXMgYW4gJ2FjdGl2YXRlZCcgY3NzIGNsYXNzCiAqIC0gTXVsdGlwbGUgW3VuaXQgdGVzdHNdKGh0dHBzOi8vZ2l0aHViLmNvbS9kcmlmdHljby9pb25pYy9ibG9iL21hc3Rlci90ZXN0L3VuaXQvdXRpbHMvdGFwLnVuaXQuanMpIGZvciBlYWNoIHNjZW5hcmlvCiAqCiAqLwovKgoKIElPTklDIFRBUAogLS0tLS0tLS0tLS0tLS0tCiAtIEJvdGggdG91Y2ggYW5kIG1vdXNlIGV2ZW50cyBhcmUgYWRkZWQgdG8gdGhlIGRvY3VtZW50LmJvZHkgb24gRE9NIHJlYWR5CiAtIElmIGEgdG91Y2ggZXZlbnQgaGFwcGVucywgaXQgZG9lcyBub3QgdXNlIG1vdXNlIGV2ZW50IGxpc3RlbmVycwogLSBPbiB0b3VjaGVuZCwgaWYgdGhlIGRpc3RhbmNlIGJldHdlZW4gc3RhcnQgYW5kIGVuZCB3YXMgc21hbGwsIHRyaWdnZXIgYSBjbGljawogLSBJbiB0aGUgdHJpZ2dlcmVkIGNsaWNrIGV2ZW50LCBhZGQgYSAnaXNJb25pY1RhcCcgcHJvcGVydHkKIC0gVGhlIHRyaWdnZXJlZCBjbGljayByZWNlaXZlcyB0aGUgc2FtZSB4LHkgY29vcmRpbmF0ZXMgYXMgYXMgdGhlIGVuZCBldmVudAogLSBPbiBkb2N1bWVudC5ib2R5IGNsaWNrIGxpc3RlbmVyICh3aXRoIHVzZUNhcHR1cmU9dHJ1ZSksIG9ubHkgYWxsb3cgY2xpY2tzIHdpdGggJ2lzSW9uaWNUYXAnCiAtIFRyaWdnZXJpbmcgY2xpY2tzIHdpdGggbW91c2UgZXZlbnRzIHdvcmsgdGhlIHNhbWUgYXMgdG91Y2gsIGV4Y2VwdCB3aXRoIG1vdXNlZG93bi9tb3VzZXVwCiAtIFRhcHBpbmcgaW5wdXRzIGlzIGRpc2FibGVkIGR1cmluZyBzY3JvbGxpbmcKKi8KCnZhciB0YXBEb2M7IC8vIHRoZSBlbGVtZW50IHdoaWNoIHRoZSBsaXN0ZW5lcnMgYXJlIG9uIChkb2N1bWVudC5ib2R5KQp2YXIgdGFwQWN0aXZlRWxlOyAvLyB0aGUgZWxlbWVudCB3aGljaCBpcyBhY3RpdmUgKHByb2JhYmx5IGhhcyBmb2N1cykKdmFyIHRhcEVuYWJsZWRUb3VjaEV2ZW50czsKdmFyIHRhcE1vdXNlUmVzZXRUaW1lcjsKdmFyIHRhcFBvaW50ZXJNb3ZlZDsKdmFyIHRhcFBvaW50ZXJTdGFydDsKdmFyIHRhcFRvdWNoRm9jdXNlZElucHV0Owp2YXIgdGFwTGFzdFRvdWNoVGFyZ2V0Owp2YXIgdGFwVG91Y2hNb3ZlTGlzdGVuZXIgPSAndG91Y2htb3ZlJzsKCi8vIGhvdyBtdWNoIHRoZSBjb29yZGluYXRlcyBjYW4gYmUgb2ZmIGJldHdlZW4gc3RhcnQvZW5kLCBidXQgc3RpbGwgYSBjbGljawp2YXIgVEFQX1JFTEVBU0VfVE9MRVJBTkNFID0gNjsgLy8gZGVmYXVsdCB0b2xlcmFuY2UKdmFyIFRBUF9SRUxFQVNFX0JVVFRPTl9UT0xFUkFOQ0UgPSA1MDsgLy8gYnV0dG9uIGVsZW1lbnRzIHNob3VsZCBoYXZlIGEgbGFyZ2VyIHRvbGVyYW5jZQoKdmFyIHRhcEV2ZW50TGlzdGVuZXJzID0gewogICdjbGljayc6IHRhcENsaWNrR2F0ZUtlZXBlciwKCiAgJ21vdXNlZG93bic6IHRhcE1vdXNlRG93biwKICAnbW91c2V1cCc6IHRhcE1vdXNlVXAsCiAgJ21vdXNlbW92ZSc6IHRhcE1vdXNlTW92ZSwKCiAgJ3RvdWNoc3RhcnQnOiB0YXBUb3VjaFN0YXJ0LAogICd0b3VjaGVuZCc6IHRhcFRvdWNoRW5kLAogICd0b3VjaGNhbmNlbCc6IHRhcFRvdWNoQ2FuY2VsLAogICd0b3VjaG1vdmUnOiB0YXBUb3VjaE1vdmUsCgogICdwb2ludGVyZG93bic6IHRhcFRvdWNoU3RhcnQsCiAgJ3BvaW50ZXJ1cCc6IHRhcFRvdWNoRW5kLAogICdwb2ludGVyY2FuY2VsJzogdGFwVG91Y2hDYW5jZWwsCiAgJ3BvaW50ZXJtb3ZlJzogdGFwVG91Y2hNb3ZlLAoKICAnTVNQb2ludGVyRG93bic6IHRhcFRvdWNoU3RhcnQsCiAgJ01TUG9pbnRlclVwJzogdGFwVG91Y2hFbmQsCiAgJ01TUG9pbnRlckNhbmNlbCc6IHRhcFRvdWNoQ2FuY2VsLAogICdNU1BvaW50ZXJNb3ZlJzogdGFwVG91Y2hNb3ZlLAoKICAnZm9jdXNpbic6IHRhcEZvY3VzSW4sCiAgJ2ZvY3Vzb3V0JzogdGFwRm9jdXNPdXQKfTsKCmlvbmljLnRhcCA9IHsKCiAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGVsZSkgewogICAgdGFwRG9jID0gZWxlOwoKICAgIHRhcEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdHJ1ZSwgdHJ1ZSk7CiAgICB0YXBFdmVudExpc3RlbmVyKCdtb3VzZXVwJyk7CiAgICB0YXBFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nKTsKCiAgICBpZiggd2luZG93Lm5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCApIHsKICAgICAgdGFwRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nKTsKICAgICAgdGFwRXZlbnRMaXN0ZW5lcigncG9pbnRlcnVwJyk7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3BvaW50Y2FuY2VsJyk7CiAgICAgIHRhcFRvdWNoTW92ZUxpc3RlbmVyID0gJ3BvaW50ZXJtb3ZlJzsKCiAgICB9IGVsc2UgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgewogICAgICB0YXBFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJEb3duJyk7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlclVwJyk7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlckNhbmNlbCcpOwogICAgICB0YXBUb3VjaE1vdmVMaXN0ZW5lciA9ICdNU1BvaW50ZXJNb3ZlJzsKCiAgICB9IGVsc2UgewogICAgICB0YXBFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jyk7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJyk7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJyk7CiAgICB9CgogICAgdGFwRXZlbnRMaXN0ZW5lcignZm9jdXNpbicpOwogICAgdGFwRXZlbnRMaXN0ZW5lcignZm9jdXNvdXQnKTsKCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGZvcih2YXIgdHlwZSBpbiB0YXBFdmVudExpc3RlbmVycykgewogICAgICAgIHRhcEV2ZW50TGlzdGVuZXIodHlwZSwgZmFsc2UpOwogICAgICB9CiAgICAgIHRhcERvYyA9IG51bGw7CiAgICAgIHRhcEFjdGl2ZUVsZSA9IG51bGw7CiAgICAgIHRhcEVuYWJsZWRUb3VjaEV2ZW50cyA9IGZhbHNlOwogICAgICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKICAgICAgdGFwUG9pbnRlclN0YXJ0ID0gbnVsbDsKICAgIH07CiAgfSwKCiAgaWdub3JlU2Nyb2xsU3RhcnQ6IGZ1bmN0aW9uKGUpIHsKICAgIHJldHVybiAoZS5kZWZhdWx0UHJldmVudGVkKSB8fCAgLy8gZGVmYXVsdFByZXZlbnRlZCBoYXMgYmVlbiBhc3NpZ25lZCBieSBhbm90aGVyIGNvbXBvbmVudCBoYW5kbGluZyB0aGUgZXZlbnQKICAgICAgICAgICAoL14oZmlsZXxyYW5nZSkkL2kpLnRlc3QoZS50YXJnZXQudHlwZSkgfHwKICAgICAgICAgICAoZS50YXJnZXQuZGF0YXNldCA/IGUudGFyZ2V0LmRhdGFzZXQucHJldmVudFNjcm9sbCA6IGUudGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1wcmV2ZW50LXNjcm9sbCcpKSA9PSAndHJ1ZScgfHwgLy8gbWFudWFsbHkgc2V0IHdpdGhpbiBhbiBlbGVtZW50cyBhdHRyaWJ1dGVzCiAgICAgICAgICAgKCEhKC9eKG9iamVjdHxlbWJlZCkkL2kpLnRlc3QoZS50YXJnZXQudGFnTmFtZSkpIHx8ICAvLyBmbGFzaC9tb3ZpZS9vYmplY3QgdG91Y2hlcyBzaG91bGQgbm90IHRyeSB0byBzY3JvbGwKICAgICAgICAgICBpb25pYy50YXAuaXNFbGVtZW50VGFwRGlzYWJsZWQoZS50YXJnZXQpOyAvLyBjaGVjayBpZiB0aGlzIGVsZW1lbnQsIG9yIGFuIGFuY2VzdG9yLCBoYXMgYGRhdGEtdGFwLWRpc2FibGVkYCBhdHRyaWJ1dGUKICB9LAoKICBpc1RleHRJbnB1dDogZnVuY3Rpb24oZWxlKSB7CiAgICByZXR1cm4gISFlbGUgJiYKICAgICAgICAgICAoZWxlLnRhZ05hbWUgPT0gJ1RFWFRBUkVBJyB8fAogICAgICAgICAgICBlbGUuY29udGVudEVkaXRhYmxlID09PSAndHJ1ZScgfHwKICAgICAgICAgICAgKGVsZS50YWdOYW1lID09ICdJTlBVVCcgJiYgISgvXihyYWRpb3xjaGVja2JveHxyYW5nZXxmaWxlfHN1Ym1pdHxyZXNldCkkL2kpLnRlc3QoZWxlLnR5cGUpKSApOwogIH0sCgogIGlzRGF0ZUlucHV0OiBmdW5jdGlvbihlbGUpIHsKICAgIHJldHVybiAhIWVsZSAmJgogICAgICAgICAgICAoZWxlLnRhZ05hbWUgPT0gJ0lOUFVUJyAmJiAoL14oZGF0ZXx0aW1lfGRhdGV0aW1lLWxvY2FsfG1vbnRofHdlZWspJC9pKS50ZXN0KGVsZS50eXBlKSk7CiAgfSwKCiAgaXNMYWJlbFdpdGhUZXh0SW5wdXQ6IGZ1bmN0aW9uKGVsZSkgewogICAgdmFyIGNvbnRhaW5lciA9IHRhcENvbnRhaW5pbmdFbGVtZW50KGVsZSwgZmFsc2UpOwoKICAgIHJldHVybiAhIWNvbnRhaW5lciAmJgogICAgICAgICAgIGlvbmljLnRhcC5pc1RleHRJbnB1dCggdGFwVGFyZ2V0RWxlbWVudCggY29udGFpbmVyICkgKTsKICB9LAoKICBjb250YWluc09ySXNUZXh0SW5wdXQ6IGZ1bmN0aW9uKGVsZSkgewogICAgcmV0dXJuIGlvbmljLnRhcC5pc1RleHRJbnB1dChlbGUpIHx8IGlvbmljLnRhcC5pc0xhYmVsV2l0aFRleHRJbnB1dChlbGUpOwogIH0sCgogIGNsb25lRm9jdXNlZElucHV0OiBmdW5jdGlvbihjb250YWluZXIsIHNjcm9sbEludGFuY2UpIHsKICAgIGlmKGlvbmljLnRhcC5oYXNDaGVja2VkQ2xvbmUpIHJldHVybjsKICAgIGlvbmljLnRhcC5oYXNDaGVja2VkQ2xvbmUgPSB0cnVlOwoKICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICB2YXIgZm9jdXNJbnB1dCA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCc6Zm9jdXMnKTsKICAgICAgaWYoIGlvbmljLnRhcC5pc1RleHRJbnB1dChmb2N1c0lucHV0KSApIHsKICAgICAgICB2YXIgY2xvbmVkSW5wdXQgPSBmb2N1c0lucHV0LnBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvcignLmNsb25lZC10ZXh0LWlucHV0Jyk7CiAgICAgICAgaWYoIWNsb25lZElucHV0KSB7CiAgICAgICAgICBjbG9uZWRJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZm9jdXNJbnB1dC50YWdOYW1lKTsKICAgICAgICAgIGNsb25lZElucHV0LnBsYWNlaG9sZGVyID0gZm9jdXNJbnB1dC5wbGFjZWhvbGRlcjsKICAgICAgICAgIGNsb25lZElucHV0LnR5cGUgPSBmb2N1c0lucHV0LnR5cGU7CiAgICAgICAgICBjbG9uZWRJbnB1dC52YWx1ZSA9IGZvY3VzSW5wdXQudmFsdWU7CiAgICAgICAgICBjbG9uZWRJbnB1dC5zdHlsZSA9IGZvY3VzSW5wdXQuc3R5bGU7CiAgICAgICAgICBjbG9uZWRJbnB1dC5jbGFzc05hbWUgPSBmb2N1c0lucHV0LmNsYXNzTmFtZTsKICAgICAgICAgIGNsb25lZElucHV0LmNsYXNzTGlzdC5hZGQoJ2Nsb25lZC10ZXh0LWlucHV0Jyk7CiAgICAgICAgICBjbG9uZWRJbnB1dC5yZWFkT25seSA9IHRydWU7CiAgICAgICAgICBpZiAoZm9jdXNJbnB1dC5pc0NvbnRlbnRFZGl0YWJsZSkgewogICAgICAgICAgICBjbG9uZWRJbnB1dC5jb250ZW50RWRpdGFibGUgPSBmb2N1c0lucHV0LmNvbnRlbnRFZGl0YWJsZTsKICAgICAgICAgICAgY2xvbmVkSW5wdXQuaW5uZXJIVE1MID0gZm9jdXNJbnB1dC5pbm5lckhUTUw7CiAgICAgICAgICB9CiAgICAgICAgICBmb2N1c0lucHV0LnBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNsb25lZElucHV0LCBmb2N1c0lucHV0KTsKICAgICAgICAgIGZvY3VzSW5wdXQuc3R5bGUudG9wID0gZm9jdXNJbnB1dC5vZmZzZXRUb3A7CiAgICAgICAgICBmb2N1c0lucHV0LmNsYXNzTGlzdC5hZGQoJ3ByZXZpb3VzLWlucHV0LWZvY3VzJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9LAoKICBoYXNDaGVja2VkQ2xvbmU6IGZhbHNlLAoKICByZW1vdmVDbG9uZWRJbnB1dHM6IGZ1bmN0aW9uKGNvbnRhaW5lciwgc2Nyb2xsSW50YW5jZSkgewogICAgaW9uaWMudGFwLmhhc0NoZWNrZWRDbG9uZSA9IGZhbHNlOwoKICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICB2YXIgY2xvbmVkSW5wdXRzID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoJy5jbG9uZWQtdGV4dC1pbnB1dCcpOwogICAgICB2YXIgcHJldmlvdXNJbnB1dEZvY3VzID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoJy5wcmV2aW91cy1pbnB1dC1mb2N1cycpOwogICAgICB2YXIgeDsKCiAgICAgIGZvcih4PTA7IHg8Y2xvbmVkSW5wdXRzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgY2xvbmVkSW5wdXRzW3hdLnBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGNsb25lZElucHV0c1t4XSApOwogICAgICB9CgogICAgICBmb3IoeD0wOyB4PHByZXZpb3VzSW5wdXRGb2N1cy5sZW5ndGg7IHgrKykgewogICAgICAgIHByZXZpb3VzSW5wdXRGb2N1c1t4XS5jbGFzc0xpc3QucmVtb3ZlKCdwcmV2aW91cy1pbnB1dC1mb2N1cycpOwogICAgICAgIHByZXZpb3VzSW5wdXRGb2N1c1t4XS5zdHlsZS50b3AgPSAnJzsKICAgICAgICBwcmV2aW91c0lucHV0Rm9jdXNbeF0uZm9jdXMoKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgcmVxdWlyZXNOYXRpdmVDbGljazogZnVuY3Rpb24oZWxlKSB7CiAgICBpZighZWxlIHx8IGVsZS5kaXNhYmxlZCB8fCAoL14oZmlsZXxyYW5nZSkkL2kpLnRlc3QoZWxlLnR5cGUpIHx8ICgvXihvYmplY3R8dmlkZW8pJC9pKS50ZXN0KGVsZS50YWdOYW1lKSB8fCBpb25pYy50YXAuaXNMYWJlbENvbnRhaW5pbmdGaWxlSW5wdXQoZWxlKSApIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gaW9uaWMudGFwLmlzRWxlbWVudFRhcERpc2FibGVkKGVsZSk7CiAgfSwKCiAgaXNMYWJlbENvbnRhaW5pbmdGaWxlSW5wdXQ6IGZ1bmN0aW9uKGVsZSkgewogICAgdmFyIGxibCA9IHRhcENvbnRhaW5pbmdFbGVtZW50KGVsZSk7CiAgICBpZihsYmwudGFnTmFtZSAhPT0gJ0xBQkVMJykgcmV0dXJuIGZhbHNlOwogICAgdmFyIGZpbGVJbnB1dCA9IGxibC5xdWVyeVNlbGVjdG9yKCdpbnB1dFt0eXBlPWZpbGVdJyk7CiAgICBpZihmaWxlSW5wdXQgJiYgZmlsZUlucHV0LmRpc2FibGVkID09PSBmYWxzZSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgaXNFbGVtZW50VGFwRGlzYWJsZWQ6IGZ1bmN0aW9uKGVsZSkgewogICAgaWYoZWxlICYmIGVsZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICB2YXIgZWxlbWVudCA9IGVsZTsKICAgICAgd2hpbGUoZWxlbWVudCkgewogICAgICAgIGlmKCAoZWxlbWVudC5kYXRhc2V0ID8gZWxlbWVudC5kYXRhc2V0LnRhcERpc2FibGVkIDogZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGFwLWRpc2FibGVkJykpID09ICd0cnVlJyApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnRFbGVtZW50OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgc2V0VG9sZXJhbmNlOiBmdW5jdGlvbihyZWxlYXNlVG9sZXJhbmNlLCByZWxlYXNlQnV0dG9uVG9sZXJhbmNlKSB7CiAgICBUQVBfUkVMRUFTRV9UT0xFUkFOQ0UgPSByZWxlYXNlVG9sZXJhbmNlOwogICAgVEFQX1JFTEVBU0VfQlVUVE9OX1RPTEVSQU5DRSA9IHJlbGVhc2VCdXR0b25Ub2xlcmFuY2U7CiAgfSwKCiAgY2FuY2VsQ2xpY2s6IGZ1bmN0aW9uKCkgewogICAgLy8gdXNlZCB0byBjYW5jZWwgYW55IHNpbXVsYXRlZCBjbGlja3Mgd2hpY2ggbWF5IGhhcHBlbiBvbiBhIHRvdWNoZW5kL21vdXNldXAKICAgIC8vIGdlc3R1cmVzIHVzZXMgdGhpcyBtZXRob2Qgd2l0aGluIGl0cyB0YXAgYW5kIGhvbGQgZXZlbnRzCiAgICB0YXBQb2ludGVyTW92ZWQgPSB0cnVlOwogIH0sCgogIHBvaW50ZXJDb29yZDogZnVuY3Rpb24oZXZlbnQpIHsKICAgIC8vIFRoaXMgbWV0aG9kIGNhbiBnZXQgY29vcmRpbmF0ZXMgZm9yIGJvdGggYSBtb3VzZSBjbGljawogICAgLy8gb3IgYSB0b3VjaCBkZXBlbmRpbmcgb24gdGhlIGdpdmVuIGV2ZW50CiAgICB2YXIgYyA9IHsgeDowLCB5OjAgfTsKICAgIGlmKGV2ZW50KSB7CiAgICAgIHZhciB0b3VjaGVzID0gZXZlbnQudG91Y2hlcyAmJiBldmVudC50b3VjaGVzLmxlbmd0aCA/IGV2ZW50LnRvdWNoZXMgOiBbZXZlbnRdOwogICAgICB2YXIgZSA9IChldmVudC5jaGFuZ2VkVG91Y2hlcyAmJiBldmVudC5jaGFuZ2VkVG91Y2hlc1swXSkgfHwgdG91Y2hlc1swXTsKICAgICAgaWYoZSkgewogICAgICAgIGMueCA9IGUuY2xpZW50WCB8fCBlLnBhZ2VYIHx8IDA7CiAgICAgICAgYy55ID0gZS5jbGllbnRZIHx8IGUucGFnZVkgfHwgMDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGM7CiAgfQoKfTsKCmZ1bmN0aW9uIHRhcEV2ZW50TGlzdGVuZXIodHlwZSwgZW5hYmxlLCB1c2VDYXB0dXJlKSB7CiAgaWYoZW5hYmxlICE9PSBmYWxzZSkgewogICAgdGFwRG9jLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgdGFwRXZlbnRMaXN0ZW5lcnNbdHlwZV0sIHVzZUNhcHR1cmUpOwogIH0gZWxzZSB7CiAgICB0YXBEb2MucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCB0YXBFdmVudExpc3RlbmVyc1t0eXBlXSk7CiAgfQp9CgpmdW5jdGlvbiB0YXBDbGljayhlKSB7CiAgLy8gc2ltdWxhdGUgYSBub3JtYWwgY2xpY2sgYnkgcnVubmluZyB0aGUgZWxlbWVudCdzIGNsaWNrIG1ldGhvZCB0aGVuIGZvY3VzIG9uIGl0CiAgdmFyIGNvbnRhaW5lciA9IHRhcENvbnRhaW5pbmdFbGVtZW50KGUudGFyZ2V0KTsKICB2YXIgZWxlID0gdGFwVGFyZ2V0RWxlbWVudChjb250YWluZXIpOwoKICBpZiggaW9uaWMudGFwLnJlcXVpcmVzTmF0aXZlQ2xpY2soZWxlKSB8fCB0YXBQb2ludGVyTW92ZWQgKSByZXR1cm4gZmFsc2U7CgogIHZhciBjID0gaW9uaWMudGFwLnBvaW50ZXJDb29yZChlKTsKCiAgdm9pZCAwOwogIHRyaWdnZXJNb3VzZUV2ZW50KCdjbGljaycsIGVsZSwgYy54LCBjLnkpOwoKICAvLyBpZiBpdCdzIGFuIGlucHV0LCBmb2N1cyBpbiBvbiB0aGUgdGFyZ2V0LCBvdGhlcndpc2UgYmx1cgogIHRhcEhhbmRsZUZvY3VzKGVsZSk7Cn0KCmZ1bmN0aW9uIHRyaWdnZXJNb3VzZUV2ZW50KHR5cGUsIGVsZSwgeCwgeSkgewogIC8vIHVzaW5nIGluaXRNb3VzZUV2ZW50IGluc3RlYWQgb2YgTW91c2VFdmVudCBmb3Igb3VyIEFuZHJvaWQgZnJpZW5kcwogIHZhciBjbGlja0V2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CiAgY2xpY2tFdmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDEsIDAsIDAsIHgsIHksIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKICBjbGlja0V2ZW50LmlzSW9uaWNUYXAgPSB0cnVlOwogIGVsZS5kaXNwYXRjaEV2ZW50KGNsaWNrRXZlbnQpOwp9CgpmdW5jdGlvbiB0YXBDbGlja0dhdGVLZWVwZXIoZSkgewogIGlmKGUudGFyZ2V0LnR5cGUgPT0gJ3N1Ym1pdCcgJiYgZS5kZXRhaWwgPT09IDApIHsKICAgIC8vIGRvIG5vdCBwcmV2ZW50IGNsaWNrIGlmIGl0IGNhbWUgZnJvbSBhbiAiRW50ZXIiIG9yICJHbyIga2V5cHJlc3Mgc3VibWl0CiAgICByZXR1cm47CiAgfQoKICAvLyBkbyBub3QgYWxsb3cgdGhyb3VnaCBhbnkgY2xpY2sgZXZlbnRzIHRoYXQgd2VyZSBub3QgY3JlYXRlZCBieSBpb25pYy50YXAKICBpZiggKGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyAmJiBpb25pYy50YXAuY29udGFpbnNPcklzVGV4dElucHV0KGUudGFyZ2V0KSApIHx8CiAgICAgICghZS5pc0lvbmljVGFwICYmICFpb25pYy50YXAucmVxdWlyZXNOYXRpdmVDbGljayhlLnRhcmdldCkpICkgewogICAgdm9pZCAwOwogICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICBpZiggIWlvbmljLnRhcC5pc0xhYmVsV2l0aFRleHRJbnB1dChlLnRhcmdldCkgKSB7CiAgICAgIC8vIGxhYmVscyBjbGlja3MgZnJvbSBuYXRpdmUgc2hvdWxkIG5vdCBwcmV2ZW50RGVmYXVsdCBvdGhlcnNpemUga2V5Ym9hcmQgd2lsbCBub3Qgc2hvdyBvbiBpbnB1dCBmb2N1cwogICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9CgovLyBNT1VTRQpmdW5jdGlvbiB0YXBNb3VzZURvd24oZSkgewogIGlmKGUuaXNJb25pY1RhcCB8fCB0YXBJZ25vcmVFdmVudChlKSkgcmV0dXJuOwoKICBpZih0YXBFbmFibGVkVG91Y2hFdmVudHMpIHsKICAgIHZvaWQgMDsKICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgaWYoICghaW9uaWMudGFwLmlzVGV4dElucHV0KGUudGFyZ2V0KSB8fCB0YXBMYXN0VG91Y2hUYXJnZXQgIT09IGUudGFyZ2V0KSAmJiAhKC9eKHNlbGVjdHxvcHRpb24pJC9pKS50ZXN0KGUudGFyZ2V0LnRhZ05hbWUpICkgewogICAgICAvLyBJZiB5b3UgcHJldmVudERlZmF1bHQgb24gYSB0ZXh0IGlucHV0IHRoZW4geW91IGNhbm5vdCBtb3ZlIGl0cyB0ZXh0IGNhcmV0L2N1cnNvci4KICAgICAgLy8gQWxsb3cgdGhyb3VnaCBvbmx5IHRoZSB0ZXh0IGlucHV0IGRlZmF1bHQuIEhvd2V2ZXIsIHdpdGhvdXQgcHJldmVudERlZmF1bHQgb24gYW4KICAgICAgLy8gaW5wdXQgdGhlIDMwMG1zIGRlbGF5IGNhbiBjaGFuZ2UgZm9jdXMgb24gaW5wdXRzIGFmdGVyIHRoZSBrZXlib2FyZCBzaG93cyB1cC4KICAgICAgLy8gVGhlIGZvY3VzaW4gZXZlbnQgaGFuZGxlcyB0aGUgY2hhbmNlIG9mIGZvY3VzIGNoYW5naW5nIGFmdGVyIHRoZSBrZXlib2FyZCBzaG93cy4KICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHRhcFBvaW50ZXJNb3ZlZCA9IGZhbHNlOwogIHRhcFBvaW50ZXJTdGFydCA9IGlvbmljLnRhcC5wb2ludGVyQ29vcmQoZSk7CgogIHRhcEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScpOwogIGlvbmljLmFjdGl2YXRvci5zdGFydChlKTsKfQoKZnVuY3Rpb24gdGFwTW91c2VVcChlKSB7CiAgaWYodGFwRW5hYmxlZFRvdWNoRXZlbnRzKSB7CiAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgaWYoIHRhcElnbm9yZUV2ZW50KGUpIHx8ICgvXihzZWxlY3R8b3B0aW9uKSQvaSkudGVzdChlLnRhcmdldC50YWdOYW1lKSApIHJldHVybiBmYWxzZTsKCiAgaWYoICF0YXBIYXNQb2ludGVyTW92ZWQoZSkgKSB7CiAgICB0YXBDbGljayhlKTsKICB9CiAgdGFwRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgZmFsc2UpOwogIGlvbmljLmFjdGl2YXRvci5lbmQoKTsKICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKfQoKZnVuY3Rpb24gdGFwTW91c2VNb3ZlKGUpIHsKICBpZiggdGFwSGFzUG9pbnRlck1vdmVkKGUpICkgewogICAgdGFwRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgZmFsc2UpOwogICAgaW9uaWMuYWN0aXZhdG9yLmVuZCgpOwogICAgdGFwUG9pbnRlck1vdmVkID0gdHJ1ZTsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0KCgovLyBUT1VDSApmdW5jdGlvbiB0YXBUb3VjaFN0YXJ0KGUpIHsKICBpZiggdGFwSWdub3JlRXZlbnQoZSkgKSByZXR1cm47CgogIHRhcFBvaW50ZXJNb3ZlZCA9IGZhbHNlOwoKICB0YXBFbmFibGVUb3VjaEV2ZW50cygpOwogIHRhcFBvaW50ZXJTdGFydCA9IGlvbmljLnRhcC5wb2ludGVyQ29vcmQoZSk7CgogIHRhcEV2ZW50TGlzdGVuZXIodGFwVG91Y2hNb3ZlTGlzdGVuZXIpOwogIGlvbmljLmFjdGl2YXRvci5zdGFydChlKTsKCiAgaWYoIGlvbmljLlBsYXRmb3JtLmlzSU9TKCkgJiYgaW9uaWMudGFwLmlzTGFiZWxXaXRoVGV4dElucHV0KGUudGFyZ2V0KSApIHsKICAgIC8vIGlmIHRoZSB0YXBwZWQgZWxlbWVudCBpcyBhIGxhYmVsLCB3aGljaCBoYXMgYSBjaGlsZCBpbnB1dAogICAgLy8gdGhlbiBwcmV2ZW50RGVmYXVsdCBzbyBpT1MgZG9lc24ndCB1Z2x5IGF1dG8gc2Nyb2xsIHRvIHRoZSBpbnB1dAogICAgLy8gYnV0IGRvIG5vdCBwcmV2ZW50IGRlZmF1bHQgb24gQW5kcm9pZCBvciBlbHNlIHlvdSBjYW5ub3QgbW92ZSB0aGUgdGV4dCBjYXJldAogICAgLy8gYW5kIGRvIG5vdCBwcmV2ZW50IGRlZmF1bHQgb24gQW5kcm9pZCBvciBlbHNlIG5vIHZpcnR1YWwga2V5Ym9hcmQgc2hvd3MgdXAKCiAgICB2YXIgdGV4dElucHV0ID0gdGFwVGFyZ2V0RWxlbWVudCggdGFwQ29udGFpbmluZ0VsZW1lbnQoZS50YXJnZXQpICk7CiAgICBpZiggdGV4dElucHV0ICE9PSB0YXBBY3RpdmVFbGUgKSB7CiAgICAgIC8vIGRvbid0IHByZXZlbnREZWZhdWx0IG9uIGFuIGFscmVhZHkgZm9jdXNlZCBpbnB1dCBvciBlbHNlIGlPUydzIHRleHQgY2FyZXQgaXNuJ3QgdXNhYmxlCiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHRhcFRvdWNoRW5kKGUpIHsKICBpZiggdGFwSWdub3JlRXZlbnQoZSkgKSByZXR1cm47CgogIHRhcEVuYWJsZVRvdWNoRXZlbnRzKCk7CiAgaWYoICF0YXBIYXNQb2ludGVyTW92ZWQoZSkgKSB7CiAgICB0YXBDbGljayhlKTsKCiAgICBpZiggKC9eKHNlbGVjdHxvcHRpb24pJC9pKS50ZXN0KGUudGFyZ2V0LnRhZ05hbWUpICkgewogICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9CiAgfQoKICB0YXBMYXN0VG91Y2hUYXJnZXQgPSBlLnRhcmdldDsKICB0YXBUb3VjaENhbmNlbCgpOwp9CgpmdW5jdGlvbiB0YXBUb3VjaE1vdmUoZSkgewogIGlmKCB0YXBIYXNQb2ludGVyTW92ZWQoZSkgKSB7CiAgICB0YXBQb2ludGVyTW92ZWQgPSB0cnVlOwogICAgdGFwRXZlbnRMaXN0ZW5lcih0YXBUb3VjaE1vdmVMaXN0ZW5lciwgZmFsc2UpOwogICAgaW9uaWMuYWN0aXZhdG9yLmVuZCgpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KfQoKZnVuY3Rpb24gdGFwVG91Y2hDYW5jZWwoZSkgewogIHRhcEV2ZW50TGlzdGVuZXIodGFwVG91Y2hNb3ZlTGlzdGVuZXIsIGZhbHNlKTsKICBpb25pYy5hY3RpdmF0b3IuZW5kKCk7CiAgdGFwUG9pbnRlck1vdmVkID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIHRhcEVuYWJsZVRvdWNoRXZlbnRzKCkgewogIHRhcEVuYWJsZWRUb3VjaEV2ZW50cyA9IHRydWU7CiAgY2xlYXJUaW1lb3V0KHRhcE1vdXNlUmVzZXRUaW1lcik7CiAgdGFwTW91c2VSZXNldFRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgdGFwRW5hYmxlZFRvdWNoRXZlbnRzID0gZmFsc2U7CiAgfSwgMjAwMCk7Cn0KCmZ1bmN0aW9uIHRhcElnbm9yZUV2ZW50KGUpIHsKICBpZihlLmlzVGFwSGFuZGxlZCkgcmV0dXJuIHRydWU7CiAgZS5pc1RhcEhhbmRsZWQgPSB0cnVlOwoKICBpZiggaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nICYmIGlvbmljLnRhcC5jb250YWluc09ySXNUZXh0SW5wdXQoZS50YXJnZXQpICkgewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgcmV0dXJuIHRydWU7CiAgfQp9CgpmdW5jdGlvbiB0YXBIYW5kbGVGb2N1cyhlbGUpIHsKICB0YXBUb3VjaEZvY3VzZWRJbnB1dCA9IG51bGw7CgogIHZhciB0cmlnZ2VyRm9jdXNJbiA9IGZhbHNlOwoKICBpZihlbGUudGFnTmFtZSA9PSAnU0VMRUNUJykgewogICAgLy8gdHJpY2sgdG8gZm9yY2UgQW5kcm9pZCBvcHRpb25zIHRvIHNob3cgdXAKICAgIHRyaWdnZXJNb3VzZUV2ZW50KCdtb3VzZWRvd24nLCBlbGUsIDAsIDApOwogICAgZWxlLmZvY3VzICYmIGVsZS5mb2N1cygpOwogICAgdHJpZ2dlckZvY3VzSW4gPSB0cnVlOwoKICB9IGVsc2UgaWYodGFwQWN0aXZlRWxlbWVudCgpID09PSBlbGUpIHsKICAgIC8vIGFscmVhZHkgaXMgdGhlIGFjdGl2ZSBlbGVtZW50IGFuZCBoYXMgZm9jdXMKICAgIHRyaWdnZXJGb2N1c0luID0gdHJ1ZTsKCiAgfSBlbHNlIGlmKCAoL14oaW5wdXR8dGV4dGFyZWEpJC9pKS50ZXN0KGVsZS50YWdOYW1lKSB8fCBlbGUuaXNDb250ZW50RWRpdGFibGUgKSB7CiAgICB0cmlnZ2VyRm9jdXNJbiA9IHRydWU7CiAgICBlbGUuZm9jdXMgJiYgZWxlLmZvY3VzKCk7CiAgICBlbGUudmFsdWUgPSBlbGUudmFsdWU7CiAgICBpZiggdGFwRW5hYmxlZFRvdWNoRXZlbnRzICkgewogICAgICB0YXBUb3VjaEZvY3VzZWRJbnB1dCA9IGVsZTsKICAgIH0KCiAgfSBlbHNlIHsKICAgIHRhcEZvY3VzT3V0QWN0aXZlKCk7CiAgfQoKICBpZih0cmlnZ2VyRm9jdXNJbikgewogICAgdGFwQWN0aXZlRWxlbWVudChlbGUpOwogICAgaW9uaWMudHJpZ2dlcignaW9uaWMuZm9jdXNpbicsIHsKICAgICAgdGFyZ2V0OiBlbGUKICAgIH0sIHRydWUpOwogIH0KfQoKZnVuY3Rpb24gdGFwRm9jdXNPdXRBY3RpdmUoKSB7CiAgdmFyIGVsZSA9IHRhcEFjdGl2ZUVsZW1lbnQoKTsKICBpZihlbGUgJiYgKCgvXihpbnB1dHx0ZXh0YXJlYXxzZWxlY3QpJC9pKS50ZXN0KGVsZS50YWdOYW1lKSB8fCBlbGUuaXNDb250ZW50RWRpdGFibGUpICkgewogICAgdm9pZCAwOwogICAgZWxlLmJsdXIoKTsKICB9CiAgdGFwQWN0aXZlRWxlbWVudChudWxsKTsKfQoKZnVuY3Rpb24gdGFwRm9jdXNJbihlKSB7CiAgLy8gQmVjYXVzZSBhIHRleHQgaW5wdXQgZG9lc24ndCBwcmV2ZW50RGVmYXVsdCAoc28gdGhlIGNhcmV0IHN0aWxsIHdvcmtzKSB0aGVyZSdzIGEgY2hhbmNlCiAgLy8gdGhhdCBpdCdzIG1vdXNlZG93biBldmVudCAzMDBtcyBsYXRlciB3aWxsIGNoYW5nZSB0aGUgZm9jdXMgdG8gYW5vdGhlciBlbGVtZW50IGFmdGVyCiAgLy8gdGhlIGtleWJvYXJkIHNob3dzIHVwLgoKICBpZiggdGFwRW5hYmxlZFRvdWNoRXZlbnRzICYmCiAgICAgIGlvbmljLnRhcC5pc1RleHRJbnB1dCggdGFwQWN0aXZlRWxlbWVudCgpICkgJiYKICAgICAgaW9uaWMudGFwLmlzVGV4dElucHV0KHRhcFRvdWNoRm9jdXNlZElucHV0KSAmJgogICAgICB0YXBUb3VjaEZvY3VzZWRJbnB1dCAhPT0gZS50YXJnZXQgKSB7CgogICAgLy8gMSkgVGhlIHBvaW50ZXIgaXMgZnJvbSB0b3VjaCBldmVudHMKICAgIC8vIDIpIFRoZXJlIGlzIGFuIGFjdGl2ZSBlbGVtZW50IHdoaWNoIGlzIGEgdGV4dCBpbnB1dAogICAgLy8gMykgQSB0ZXh0IGlucHV0IHdhcyBqdXN0IHNldCB0byBiZSBmb2N1c2VkIG9uIGJ5IGEgdG91Y2ggZXZlbnQKICAgIC8vIDQpIEEgbmV3IGZvY3VzIGhhcyBiZWVuIHNldCwgaG93ZXZlciB0aGUgdGFyZ2V0IGlzbid0IHRoZSBvbmUgdGhlIHRvdWNoIGV2ZW50IHdhbnRlZAogICAgdm9pZCAwOwogICAgdGFwVG91Y2hGb2N1c2VkSW5wdXQuZm9jdXMoKTsKICAgIHRhcFRvdWNoRm9jdXNlZElucHV0ID0gbnVsbDsKICB9CiAgaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIHRhcEZvY3VzT3V0KCkgewogIHRhcEFjdGl2ZUVsZW1lbnQobnVsbCk7Cn0KCmZ1bmN0aW9uIHRhcEFjdGl2ZUVsZW1lbnQoZWxlKSB7CiAgaWYoYXJndW1lbnRzLmxlbmd0aCkgewogICAgdGFwQWN0aXZlRWxlID0gZWxlOwogIH0KICByZXR1cm4gdGFwQWN0aXZlRWxlIHx8IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7Cn0KCmZ1bmN0aW9uIHRhcEhhc1BvaW50ZXJNb3ZlZChlbmRFdmVudCkgewogIGlmKCFlbmRFdmVudCB8fCBlbmRFdmVudC50YXJnZXQubm9kZVR5cGUgIT09IDEgfHwgIXRhcFBvaW50ZXJTdGFydCB8fCAoIHRhcFBvaW50ZXJTdGFydC54ID09PSAwICYmIHRhcFBvaW50ZXJTdGFydC55ID09PSAwICkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIGVuZENvb3JkaW5hdGVzID0gaW9uaWMudGFwLnBvaW50ZXJDb29yZChlbmRFdmVudCk7CgogIHZhciBoYXNDbGFzc0xpc3QgPSAhIShlbmRFdmVudC50YXJnZXQuY2xhc3NMaXN0ICYmIGVuZEV2ZW50LnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMpOwogIHZhciByZWxlYXNlVG9sZXJhbmNlID0gaGFzQ2xhc3NMaXN0ICYgZW5kRXZlbnQudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnYnV0dG9uJykgPwogICAgVEFQX1JFTEVBU0VfQlVUVE9OX1RPTEVSQU5DRSA6CiAgICBUQVBfUkVMRUFTRV9UT0xFUkFOQ0U7CgogIHJldHVybiBNYXRoLmFicyh0YXBQb2ludGVyU3RhcnQueCAtIGVuZENvb3JkaW5hdGVzLngpID4gcmVsZWFzZVRvbGVyYW5jZSB8fAogICAgICAgICBNYXRoLmFicyh0YXBQb2ludGVyU3RhcnQueSAtIGVuZENvb3JkaW5hdGVzLnkpID4gcmVsZWFzZVRvbGVyYW5jZTsKfQoKZnVuY3Rpb24gdGFwQ29udGFpbmluZ0VsZW1lbnQoZWxlLCBhbGxvd1NlbGYpIHsKICB2YXIgY2xpbWJFbGUgPSBlbGU7CiAgZm9yKHZhciB4PTA7IHg8NjsgeCsrKSB7CiAgICBpZighY2xpbWJFbGUpIGJyZWFrOwogICAgaWYoY2xpbWJFbGUudGFnTmFtZSA9PT0gJ0xBQkVMJykgcmV0dXJuIGNsaW1iRWxlOwogICAgY2xpbWJFbGUgPSBjbGltYkVsZS5wYXJlbnRFbGVtZW50OwogIH0KICBpZihhbGxvd1NlbGYgIT09IGZhbHNlKSByZXR1cm4gZWxlOwp9CgpmdW5jdGlvbiB0YXBUYXJnZXRFbGVtZW50KGVsZSkgewogIGlmKGVsZSAmJiBlbGUudGFnTmFtZSA9PT0gJ0xBQkVMJykgewogICAgaWYoZWxlLmNvbnRyb2wpIHJldHVybiBlbGUuY29udHJvbDsKCiAgICAvLyBvbGRlciBkZXZpY2VzIGRvIG5vdCBzdXBwb3J0IHRoZSAiY29udHJvbCIgcHJvcGVydHkKICAgIGlmKGVsZS5xdWVyeVNlbGVjdG9yKSB7CiAgICAgIHZhciBjb250cm9sID0gZWxlLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0LHRleHRhcmVhLHNlbGVjdCcpOwogICAgICBpZihjb250cm9sKSByZXR1cm4gY29udHJvbDsKICAgIH0KICB9CiAgcmV0dXJuIGVsZTsKfQoKaW9uaWMuRG9tVXRpbC5yZWFkeShmdW5jdGlvbigpewogIHZhciBuZyA9IHR5cGVvZiBhbmd1bGFyICE9PSAndW5kZWZpbmVkJyA/IGFuZ3VsYXIgOiBudWxsOwogIC8vZG8gbm90aGluZyBmb3IgZTJlIHRlc3RzCiAgaWYgKCFuZyB8fCAobmcgJiYgIW5nLnNjZW5hcmlvKSkgewogICAgaW9uaWMudGFwLnJlZ2lzdGVyKGRvY3VtZW50KTsKICB9Cn0pOwoKKGZ1bmN0aW9uKGRvY3VtZW50LCBpb25pYykgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIHF1ZXVlRWxlbWVudHMgPSB7fTsgICAvLyBlbGVtZW50cyB0aGF0IHNob3VsZCBnZXQgYW4gYWN0aXZlIHN0YXRlIGluIFhYIG1pbGxpc2Vjb25kcwogIHZhciBhY3RpdmVFbGVtZW50cyA9IHt9OyAgLy8gZWxlbWVudHMgdGhhdCBhcmUgY3VycmVudGx5IGFjdGl2ZQogIHZhciBrZXlJZCA9IDA7ICAgICAgICAgICAgLy8gYSBjb3VudGVyIGZvciB1bmlxdWUga2V5cyBmb3IgdGhlIGFib3ZlIG9qZWN0cwogIHZhciBBQ1RJVkFURURfQ0xBU1MgPSAnYWN0aXZhdGVkJzsKCiAgaW9uaWMuYWN0aXZhdG9yID0gewoKICAgIHN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIHdoZW4gYW4gZWxlbWVudCBpcyB0b3VjaGVkL2NsaWNrZWQsIGl0IGNsaW1icyB1cCBhIGZldwogICAgICAvLyBwYXJlbnRzIHRvIHNlZSBpZiBpdCBpcyBhbiAuaXRlbSBvciAuYnV0dG9uIGVsZW1lbnQKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKCBpb25pYy50YXAucmVxdWlyZXNOYXRpdmVDbGljayhlLnRhcmdldCkgKSByZXR1cm47CiAgICAgICAgdmFyIGVsZSA9IGUudGFyZ2V0OwogICAgICAgIHZhciBlbGVUb0FjdGl2YXRlOwoKICAgICAgICBmb3IodmFyIHg9MDsgeDw2OyB4KyspIHsKICAgICAgICAgIGlmKCFlbGUgfHwgZWxlLm5vZGVUeXBlICE9PSAxKSBicmVhazsKICAgICAgICAgIGlmKGVsZVRvQWN0aXZhdGUgJiYgZWxlLmNsYXNzTGlzdC5jb250YWlucygnaXRlbScpKSB7CiAgICAgICAgICAgIGVsZVRvQWN0aXZhdGUgPSBlbGU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYoIGVsZS50YWdOYW1lID09ICdBJyB8fCBlbGUudGFnTmFtZSA9PSAnQlVUVE9OJyB8fCBlbGUuaGFzQXR0cmlidXRlKCduZy1jbGljaycpICkgewogICAgICAgICAgICBlbGVUb0FjdGl2YXRlID0gZWxlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCBlbGUuY2xhc3NMaXN0LmNvbnRhaW5zKCdidXR0b24nKSApIHsKICAgICAgICAgICAgZWxlVG9BY3RpdmF0ZSA9IGVsZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBubyBzZW5zZSBjbGltYmluZyBwYXN0IHRoZXNlCiAgICAgICAgICBpZihlbGUuY2xhc3NMaXN0LmNvbnRhaW5zKCdwYW5lJykgfHwgZWxlLnRhZ05hbWUgPT0gJ0JPRFknIHx8IGVsZS50YWdOYW1lID09ICdJT04tQ09OVEVOVCcpewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGVsZSA9IGVsZS5wYXJlbnRFbGVtZW50OwogICAgICAgIH0KCiAgICAgICAgaWYoZWxlVG9BY3RpdmF0ZSkgewogICAgICAgICAgLy8gcXVldWUgdGhhdCB0aGlzIGVsZW1lbnQgc2hvdWxkIGJlIHNldCB0byBhY3RpdmUKICAgICAgICAgIHF1ZXVlRWxlbWVudHNba2V5SWRdID0gZWxlVG9BY3RpdmF0ZTsKCiAgICAgICAgICAvLyBpbiBYWCBtaWxsaXNlY29uZHMsIHNldCB0aGUgcXVldWVkIGVsZW1lbnRzIHRvIGFjdGl2ZQogICAgICAgICAgaWYoZS50eXBlID09PSAndG91Y2hzdGFydCcpIHsKICAgICAgICAgICAgc2VsZi5fYWN0aXZhdGVUaW1lb3V0ID0gc2V0VGltZW91dChhY3RpdmF0ZUVsZW1lbnRzLCA4MCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYWN0aXZhdGVFbGVtZW50cyk7CiAgICAgICAgICB9CgogICAgICAgICAga2V5SWQgPSAoa2V5SWQgPiAxOSA/IDAgOiBrZXlJZCArIDEpOwogICAgICAgIH0KCiAgICAgIH0pOwogICAgfSwKCiAgICBlbmQ6IGZ1bmN0aW9uKCkgewogICAgICAvLyBjbGVhciBvdXQgYW55IGFjdGl2ZS9xdWV1ZWQgZWxlbWVudHMgYWZ0ZXIgWFggbWlsbGlzZWNvbmRzCiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9hY3RpdmF0ZVRpbWVvdXQpOwogICAgICBzZXRUaW1lb3V0KGNsZWFyLCAyMDApOwogICAgfQoKICB9OwoKICBmdW5jdGlvbiBjbGVhcigpIHsKICAgIC8vIGNsZWFyIG91dCBhbnkgZWxlbWVudHMgdGhhdCBhcmUgcXVldWVkIHRvIGJlIHNldCB0byBhY3RpdmUKICAgIHF1ZXVlRWxlbWVudHMgPSB7fTsKCiAgICAvLyBpbiB0aGUgbmV4dCBmcmFtZSwgcmVtb3ZlIHRoZSBhY3RpdmUgY2xhc3MgZnJvbSBhbGwgYWN0aXZlIGVsZW1lbnRzCiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZGVhY3RpdmF0ZUVsZW1lbnRzKTsKICB9CgogIGZ1bmN0aW9uIGFjdGl2YXRlRWxlbWVudHMoKSB7CiAgICAvLyBhY3RpdmF0ZSBhbGwgZWxlbWVudHMgaW4gdGhlIHF1ZXVlCiAgICBmb3IodmFyIGtleSBpbiBxdWV1ZUVsZW1lbnRzKSB7CiAgICAgIGlmKHF1ZXVlRWxlbWVudHNba2V5XSkgewogICAgICAgIHF1ZXVlRWxlbWVudHNba2V5XS5jbGFzc0xpc3QuYWRkKEFDVElWQVRFRF9DTEFTUyk7CiAgICAgICAgYWN0aXZlRWxlbWVudHNba2V5XSA9IHF1ZXVlRWxlbWVudHNba2V5XTsKICAgICAgfQogICAgfQogICAgcXVldWVFbGVtZW50cyA9IHt9OwogIH0KCiAgZnVuY3Rpb24gZGVhY3RpdmF0ZUVsZW1lbnRzKCkgewogICAgZm9yKHZhciBrZXkgaW4gYWN0aXZlRWxlbWVudHMpIHsKICAgICAgaWYoYWN0aXZlRWxlbWVudHNba2V5XSkgewogICAgICAgIGFjdGl2ZUVsZW1lbnRzW2tleV0uY2xhc3NMaXN0LnJlbW92ZShBQ1RJVkFURURfQ0xBU1MpOwogICAgICAgIGRlbGV0ZSBhY3RpdmVFbGVtZW50c1trZXldOwogICAgICB9CiAgICB9CiAgfQoKfSkoZG9jdW1lbnQsIGlvbmljKTsKCihmdW5jdGlvbihpb25pYykgewoKICAvKiBmb3IgbmV4dFVpZCgpIGZ1bmN0aW9uIGJlbG93ICovCiAgdmFyIHVpZCA9IFsnMCcsJzAnLCcwJ107CgogIC8qKgogICAqIFZhcmlvdXMgdXRpbGl0aWVzIHVzZWQgdGhyb3VnaG91dCBJb25pYwogICAqCiAgICogU29tZSBvZiB0aGVzZSBhcmUgYWRvcHRlZCBmcm9tIHVuZGVyc2NvcmUuanMgYW5kIGJhY2tib25lLmpzLCBib3RoIGFsc28gTUlUIGxpY2Vuc2VkLgogICAqLwogIGlvbmljLlV0aWxzID0gewoKICAgIGFycmF5TW92ZTogZnVuY3Rpb24gKGFyciwgb2xkX2luZGV4LCBuZXdfaW5kZXgpIHsKICAgICAgaWYgKG5ld19pbmRleCA+PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgdmFyIGsgPSBuZXdfaW5kZXggLSBhcnIubGVuZ3RoOwogICAgICAgIHdoaWxlICgoay0tKSArIDEpIHsKICAgICAgICAgIGFyci5wdXNoKHVuZGVmaW5lZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFyci5zcGxpY2UobmV3X2luZGV4LCAwLCBhcnIuc3BsaWNlKG9sZF9pbmRleCwgMSlbMF0pOwogICAgICByZXR1cm4gYXJyOwogICAgfSwKCiAgICAvKioKICAgICAqIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dAogICAgICovCiAgICBwcm94eTogZnVuY3Rpb24oZnVuYywgY29udGV4dCkgewogICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIH07CiAgICB9LAoKICAgIC8qKgogICAgICogT25seSBjYWxsIGEgZnVuY3Rpb24gb25jZSBpbiB0aGUgZ2l2ZW4gaW50ZXJ2YWwuCiAgICAgKgogICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufSB0aGUgZnVuY3Rpb24gdG8gY2FsbAogICAgICogQHBhcmFtIHdhaXQge2ludH0gaG93IGxvbmcgdG8gd2FpdCBiZWZvcmUvYWZ0ZXIgdG8gYWxsb3cgZnVuY3Rpb24gY2FsbHMKICAgICAqIEBwYXJhbSBpbW1lZGlhdGUge2Jvb2xlYW59IHdoZXRoZXIgdG8gY2FsbCBpbW1lZGlhdGVseSBvciBhZnRlciB0aGUgd2FpdCBpbnRlcnZhbAogICAgICovCiAgICAgZGVib3VuY2U6IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgICB2YXIgdGltZW91dCwgYXJncywgY29udGV4dCwgdGltZXN0YW1wLCByZXN1bHQ7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICAgIHRpbWVzdGFtcCA9IG5ldyBEYXRlKCk7CiAgICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbGFzdCA9IChuZXcgRGF0ZSgpKSAtIHRpbWVzdGFtcDsKICAgICAgICAgIGlmIChsYXN0IDwgd2FpdCkgewogICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIGlmICghaW1tZWRpYXRlKSByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgICAgfQogICAgICAgIGlmIChjYWxsTm93KSByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9LAoKICAgIC8qKgogICAgICogVGhyb3R0bGUgdGhlIGdpdmVuIGZ1biwgb25seSBhbGxvd2luZyBpdCB0byBiZQogICAgICogY2FsbGVkIGF0IG1vc3QgZXZlcnkgYHdhaXRgIG1zLgogICAgICovCiAgICB0aHJvdHRsZTogZnVuY3Rpb24oZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwogICAgICB2YXIgdGltZW91dCA9IG51bGw7CiAgICAgIHZhciBwcmV2aW91cyA9IDA7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBEYXRlLm5vdygpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH07CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICBpZiAoIXByZXZpb3VzICYmIG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UpIHByZXZpb3VzID0gbm93OwogICAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICBwcmV2aW91cyA9IG5vdzsKICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfSBlbHNlIGlmICghdGltZW91dCAmJiBvcHRpb25zLnRyYWlsaW5nICE9PSBmYWxzZSkgewogICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHJlbWFpbmluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9LAogICAgIC8vIEJvcnJvd2VkIGZyb20gQmFja2JvbmUuanMncyBleHRlbmQKICAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAgICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogICAgIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgICBpbmhlcml0OiBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgICAgdmFyIGNoaWxkOwoKICAgICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgICAgaWYgKHByb3RvUHJvcHMgJiYgcHJvdG9Qcm9wcy5oYXNPd25Qcm9wZXJ0eSgnY29uc3RydWN0b3InKSkgewogICAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgICAgfSBlbHNlIHsKICAgICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgICAgfQoKICAgICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgICAgIGlvbmljLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgogICAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwogICAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZSgpOwoKICAgICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAgIC8vIGlmIHN1cHBsaWVkLgogICAgICBpZiAocHJvdG9Qcm9wcykgaW9uaWMuZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCiAgICAgIC8vIGxhdGVyLgogICAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgICAgcmV0dXJuIGNoaWxkOwogICAgfSwKCiAgICAvLyBFeHRlbmQgYWRhcHRlZCBmcm9tIFVuZGVyc2NvcmUuanMKICAgIGV4dGVuZDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICB2YXIgc291cmNlID0gYXJnc1tpXTsKICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgICAgfQogICAgICAgICB9CiAgICAgICB9CiAgICAgICByZXR1cm4gb2JqOwogICAgfSwKCiAgICAvKioKICAgICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAgICoKICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICovCiAgICBuZXh0VWlkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGluZGV4ID0gdWlkLmxlbmd0aDsKICAgICAgdmFyIGRpZ2l0OwoKICAgICAgd2hpbGUoaW5kZXgpIHsKICAgICAgICBpbmRleC0tOwogICAgICAgIGRpZ2l0ID0gdWlkW2luZGV4XS5jaGFyQ29kZUF0KDApOwogICAgICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgICAgICB1aWRbaW5kZXhdID0gJ0EnOwogICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRpZ2l0ID09IDkwICAvKidaJyovKSB7CiAgICAgICAgICB1aWRbaW5kZXhdID0gJzAnOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB1aWRbaW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShkaWdpdCArIDEpOwogICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdWlkLnVuc2hpZnQoJzAnKTsKICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgIH0KICB9OwoKICAvLyBCaW5kIGEgZmV3IG9mIHRoZSBtb3N0IHVzZWZ1bCBmdW5jdGlvbnMgdG8gdGhlIGlvbmljIHNjb3BlCiAgaW9uaWMuaW5oZXJpdCA9IGlvbmljLlV0aWxzLmluaGVyaXQ7CiAgaW9uaWMuZXh0ZW5kID0gaW9uaWMuVXRpbHMuZXh0ZW5kOwogIGlvbmljLnRocm90dGxlID0gaW9uaWMuVXRpbHMudGhyb3R0bGU7CiAgaW9uaWMucHJveHkgPSBpb25pYy5VdGlscy5wcm94eTsKICBpb25pYy5kZWJvdW5jZSA9IGlvbmljLlV0aWxzLmRlYm91bmNlOwoKfSkod2luZG93LmlvbmljKTsKCi8qKgogKiBAbmdkb2MgcGFnZQogKiBAbmFtZSBrZXlib2FyZAogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKiBPbiBib3RoIEFuZHJvaWQgYW5kIGlPUywgSW9uaWMgd2lsbCBhdHRlbXB0IHRvIHByZXZlbnQgdGhlIGtleWJvYXJkIGZyb20KICogb2JzY3VyaW5nIGlucHV0cyBhbmQgZm9jdXNhYmxlIGVsZW1lbnRzIHdoZW4gaXQgYXBwZWFycyBieSBzY3JvbGxpbmcgdGhlbQogKiBpbnRvIHZpZXcuICBJbiBvcmRlciBmb3IgdGhpcyB0byB3b3JrLCBhbnkgZm9jdXNhYmxlIGVsZW1lbnRzIG11c3QgYmUgd2l0aGluCiAqIGEgW1Njcm9sbCBWaWV3XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tL2RvY3MvYXBpL2RpcmVjdGl2ZS9pb25TY3JvbGwvKQogKiBvciBhIGRpcmVjdGl2ZSBzdWNoIGFzIFtDb250ZW50XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tL2RvY3MvYXBpL2RpcmVjdGl2ZS9pb25Db250ZW50LykKICogdGhhdCBoYXMgYSBTY3JvbGwgVmlldy4KICoKICogSXQgd2lsbCBhbHNvIGF0dGVtcHQgdG8gcHJldmVudCB0aGUgbmF0aXZlIG92ZXJmbG93IHNjcm9sbGluZyBvbiBmb2N1cywKICogd2hpY2ggY2FuIGNhdXNlIGxheW91dCBpc3N1ZXMgc3VjaCBhcyBwdXNoaW5nIGhlYWRlcnMgdXAgYW5kIG91dCBvZiB2aWV3LgogKgogKiBUaGUga2V5Ym9hcmQgZml4ZXMgd29yayBiZXN0IGluIGNvbmp1bmN0aW9uIHdpdGggdGhlCiAqIFtJb25pYyBLZXlib2FyZCBQbHVnaW5dKGh0dHBzOi8vZ2l0aHViLmNvbS9kcmlmdHljby9pb25pYy1wbHVnaW5zLWtleWJvYXJkKSwKICogYWx0aG91Z2ggaXQgd2lsbCBwZXJmb3JtIHJlYXNvbmFibHkgd2VsbCB3aXRob3V0LiAgSG93ZXZlciwgaWYgeW91IGFyZSB1c2luZwogKiBDb3Jkb3ZhIHRoZXJlIGlzIG5vIHJlYXNvbiBub3QgdG8gdXNlIHRoZSBwbHVnaW4uCiAqCiAqICMjIyBIaWRlIHdoZW4ga2V5Ym9hcmQgc2hvd3MKICoKICogVG8gaGlkZSBhbiBlbGVtZW50IHdoZW4gdGhlIGtleWJvYXJkIGlzIG9wZW4sIGFkZCB0aGUgY2xhc3MgYGhpZGUtb24ta2V5Ym9hcmQtb3BlbmAuCiAqCiAqIGBgYGh0bWwKICogPGRpdiBjbGFzcz0iaGlkZS1vbi1rZXlib2FyZC1vcGVuIj4KICogICA8ZGl2IGlkPSJnb29nbGUtbWFwIj48L2Rpdj4KICogPC9kaXY+CiAqIGBgYAogKiAtLS0tLS0tLS0tCiAqCiAqICMjIyBQbHVnaW4gVXNhZ2UKICogSW5mb3JtYXRpb24gb24gdXNpbmcgdGhlIHBsdWdpbiBjYW4gYmUgZm91bmQgYXQKICogW2h0dHBzOi8vZ2l0aHViLmNvbS9kcmlmdHljby9pb25pYy1wbHVnaW5zLWtleWJvYXJkXShodHRwczovL2dpdGh1Yi5jb20vZHJpZnR5Y28vaW9uaWMtcGx1Z2lucy1rZXlib2FyZCkuCiAqCiAqIC0tLS0tLS0tLS0KICoKICogIyMjIEFuZHJvaWQgTm90ZXMKICogLSBJZiB5b3VyIGFwcCBpcyBydW5uaW5nIGluIGZ1bGxzY3JlZW4sIGkuZS4geW91IGhhdmUKICogICBgPHByZWZlcmVuY2UgbmFtZT0iRnVsbHNjcmVlbiIgdmFsdWU9InRydWUiIC8+YCBpbiB5b3VyIGBjb25maWcueG1sYCBmaWxlCiAqICAgeW91IHdpbGwgbmVlZCB0byBzZXQgYGlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbiA9IHRydWVgIG1hbnVhbGx5LgogKgogKiAtIFlvdSBjYW4gY29uZmlndXJlIHRoZSBiZWhhdmlvciBvZiB0aGUgd2ViIHZpZXcgd2hlbiB0aGUga2V5Ym9hcmQgc2hvd3MgYnkgc2V0dGluZwogKiAgIFthbmRyb2lkOndpbmRvd1NvZnRJbnB1dE1vZGVdKGh0dHA6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vcmVmZXJlbmNlL2FuZHJvaWQvUi5hdHRyLmh0bWwjd2luZG93U29mdElucHV0TW9kZSkKICogICB0byBlaXRoZXIgYGFkanVzdFBhbmAsIGBhZGp1c3RSZXNpemVgIG9yIGBhZGp1c3ROb3RoaW5nYCBpbiB5b3VyIGFwcCdzCiAqICAgYWN0aXZpdHkgaW4gYEFuZHJvaWRNYW5pZmVzdC54bWxgLiBgYWRqdXN0UmVzaXplYCBpcyB0aGUgcmVjb21tZW5kZWQgc2V0dGluZwogKiAgIGZvciBJb25pYywgYnV0IGlmIGZvciBzb21lIHJlYXNvbiB5b3UgZG8gdXNlIGBhZGp1c3RQYW5gIHlvdSB3aWxsIG5lZWQgdG8KICogICBzZXQgYGlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbiA9IHRydWVgLgogKgogKiAgIGBgYHhtbAogKiAgIDxhY3Rpdml0eSBhbmRyb2lkOndpbmRvd1NvZnRJbnB1dE1vZGU9ImFkanVzdFJlc2l6ZSI+CiAqCiAqICAgYGBgCiAqCiAqICMjIyBpT1MgTm90ZXMKICogLSBJZiB0aGUgY29udGVudCBvZiB5b3VyIGFwcCAoaW5jbHVkaW5nIHRoZSBoZWFkZXIpIGlzIGJlaW5nIHB1c2hlZCB1cCBhbmQKICogICBvdXQgb2YgdmlldyBvbiBpbnB1dCBmb2N1cywgdHJ5IHNldHRpbmcgYGNvcmRvdmEucGx1Z2lucy5LZXlib2FyZC5kaXNhYmxlU2Nyb2xsKHRydWUpYC4KICogICBUaGlzIGRvZXMgKipub3QqKiBkaXNhYmxlIHNjcm9sbGluZyBpbiB0aGUgSW9uaWMgc2Nyb2xsIHZpZXcsIHJhdGhlciBpdAogKiAgIGRpc2FibGVzIHRoZSBuYXRpdmUgb3ZlcmZsb3cgc2Nyb2xsaW5nIHRoYXQgaGFwcGVucyBhdXRvbWF0aWNhbGx5IGFzIGEKICogICByZXN1bHQgb2YgZm9jdXNpbmcgb24gaW5wdXRzIGJlbG93IHRoZSBrZXlib2FyZC4KICoKICovCgp2YXIga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCA9IGdldFZpZXdwb3J0SGVpZ2h0KCk7CnZhciBrZXlib2FyZElzT3BlbjsKdmFyIGtleWJvYXJkQWN0aXZlRWxlbWVudDsKdmFyIGtleWJvYXJkRm9jdXNPdXRUaW1lcjsKdmFyIGtleWJvYXJkRm9jdXNJblRpbWVyOwp2YXIga2V5Ym9hcmRMYXN0U2hvdyA9IDA7Cgp2YXIgS0VZQk9BUkRfT1BFTl9DU1MgPSAna2V5Ym9hcmQtb3Blbic7CnZhciBTQ1JPTExfQ09OVEFJTkVSX0NTUyA9ICdzY3JvbGwnOwoKaW9uaWMua2V5Ym9hcmQgPSB7CiAgaXNPcGVuOiBmYWxzZSwKICBoZWlnaHQ6IG51bGwsCiAgbGFuZHNjYXBlOiBmYWxzZSwKfTsKCmZ1bmN0aW9uIGtleWJvYXJkSW5pdCgpIHsKICBpZigga2V5Ym9hcmRIYXNQbHVnaW4oKSApIHsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCduYXRpdmUua2V5Ym9hcmRzaG93Jywga2V5Ym9hcmROYXRpdmVTaG93KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCduYXRpdmUua2V5Ym9hcmRoaWRlJywga2V5Ym9hcmRGb2N1c091dCk7CgogICAgLy9kZXByZWNhdGVkCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbmF0aXZlLnNob3drZXlib2FyZCcsIGtleWJvYXJkTmF0aXZlU2hvdyk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbmF0aXZlLmhpZGVrZXlib2FyZCcsIGtleWJvYXJkRm9jdXNPdXQpOwoKICB9IGVsc2UgewogICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdmb2N1c291dCcsIGtleWJvYXJkRm9jdXNPdXQpOwogIH0KCiAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdpb25pYy5mb2N1c2luJywga2V5Ym9hcmRCcm93c2VyRm9jdXNJbik7CiAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdmb2N1c2luJywga2V5Ym9hcmRCcm93c2VyRm9jdXNJbik7CgogIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcignb3JpZW50YXRpb25jaGFuZ2UnLCBrZXlib2FyZE9yaWVudGF0aW9uQ2hhbmdlKTsKCiAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyRG93biIsIGtleWJvYXJkSW5pdCk7CiAgfSBlbHNlIHsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBrZXlib2FyZEluaXQpOwogIH0KfQoKZnVuY3Rpb24ga2V5Ym9hcmROYXRpdmVTaG93KGUpIHsKICBjbGVhclRpbWVvdXQoa2V5Ym9hcmRGb2N1c091dFRpbWVyKTsKICBpb25pYy5rZXlib2FyZC5oZWlnaHQgPSBlLmtleWJvYXJkSGVpZ2h0Owp9CgpmdW5jdGlvbiBrZXlib2FyZEJyb3dzZXJGb2N1c0luKGUpIHsKICBpZiggIWUudGFyZ2V0IHx8ICFpb25pYy50YXAuaXNUZXh0SW5wdXQoZS50YXJnZXQpIHx8IGlvbmljLnRhcC5pc0RhdGVJbnB1dChlLnRhcmdldCkgfHwgIWtleWJvYXJkSXNXaXRoaW5TY3JvbGwoZS50YXJnZXQpICkgcmV0dXJuOwoKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5Ym9hcmRPbktleURvd24sIGZhbHNlKTsKCiAgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgPSAwOwogIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcignLnNjcm9sbC1jb250ZW50Jykuc2Nyb2xsVG9wID0gMDsKCiAga2V5Ym9hcmRBY3RpdmVFbGVtZW50ID0gZS50YXJnZXQ7CgogIGtleWJvYXJkU2V0U2hvdyhlKTsKfQoKZnVuY3Rpb24ga2V5Ym9hcmRTZXRTaG93KGUpIHsKICBjbGVhclRpbWVvdXQoa2V5Ym9hcmRGb2N1c0luVGltZXIpOwogIGNsZWFyVGltZW91dChrZXlib2FyZEZvY3VzT3V0VGltZXIpOwoKICBrZXlib2FyZEZvY3VzSW5UaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgIGlmICgga2V5Ym9hcmRMYXN0U2hvdyArIDM1MCA+IERhdGUubm93KCkgKSByZXR1cm47CiAgICBrZXlib2FyZExhc3RTaG93ID0gRGF0ZS5ub3coKTsKICAgIHZhciBrZXlib2FyZEhlaWdodDsKICAgIHZhciBlbGVtZW50Qm91bmRzID0ga2V5Ym9hcmRBY3RpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgdmFyIGNvdW50ID0gMDsKCiAgICB2YXIgcG9sbEtleWJvYXJkSGVpZ2h0ID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKCiAgICAgIGtleWJvYXJkSGVpZ2h0ID0ga2V5Ym9hcmRHZXRIZWlnaHQoKTsKICAgICAgaWYgKGNvdW50ID4gMTApewogICAgICAgIGNsZWFySW50ZXJ2YWwocG9sbEtleWJvYXJkSGVpZ2h0KTsKICAgICAgICAvL3dhaXRlZCBsb25nIGVub3VnaCwganVzdCBndWVzcwogICAgICAgIGtleWJvYXJkSGVpZ2h0ID0gMjc1OwogICAgICB9CiAgICAgIGlmIChrZXlib2FyZEhlaWdodCl7CiAgICAgICAga2V5Ym9hcmRTaG93KGUudGFyZ2V0LCBlbGVtZW50Qm91bmRzLnRvcCwgZWxlbWVudEJvdW5kcy5ib3R0b20sIGtleWJvYXJkVmlld3BvcnRIZWlnaHQsIGtleWJvYXJkSGVpZ2h0KTsKICAgICAgICBjbGVhckludGVydmFsKHBvbGxLZXlib2FyZEhlaWdodCk7CiAgICAgIH0KICAgICAgY291bnQrKzsKCiAgICB9LCAxMDApOwogIH0sIDMyKTsKfQoKZnVuY3Rpb24ga2V5Ym9hcmRTaG93KGVsZW1lbnQsIGVsZW1lbnRUb3AsIGVsZW1lbnRCb3R0b20sIHZpZXdwb3J0SGVpZ2h0LCBrZXlib2FyZEhlaWdodCkgewogIHZhciBkZXRhaWxzID0gewogICAgdGFyZ2V0OiBlbGVtZW50LAogICAgZWxlbWVudFRvcDogTWF0aC5yb3VuZChlbGVtZW50VG9wKSwKICAgIGVsZW1lbnRCb3R0b206IE1hdGgucm91bmQoZWxlbWVudEJvdHRvbSksCiAgICBrZXlib2FyZEhlaWdodDoga2V5Ym9hcmRIZWlnaHQsCiAgICB2aWV3cG9ydEhlaWdodDogdmlld3BvcnRIZWlnaHQKICB9OwoKICBkZXRhaWxzLmhhc1BsdWdpbiA9IGtleWJvYXJkSGFzUGx1Z2luKCk7CgogIGRldGFpbHMuY29udGVudEhlaWdodCA9IHZpZXdwb3J0SGVpZ2h0IC0ga2V5Ym9hcmRIZWlnaHQ7CgogIHZvaWQgMDsKCiAgLy8gZmlndXJlIG91dCBpZiB0aGUgZWxlbWVudCBpcyB1bmRlciB0aGUga2V5Ym9hcmQKICBkZXRhaWxzLmlzRWxlbWVudFVuZGVyS2V5Ym9hcmQgPSAoZGV0YWlscy5lbGVtZW50Qm90dG9tID4gZGV0YWlscy5jb250ZW50SGVpZ2h0KTsKCiAgaW9uaWMua2V5Ym9hcmQuaXNPcGVuID0gdHJ1ZTsKCiAgLy8gc2VuZCBldmVudCBzbyB0aGUgc2Nyb2xsIHZpZXcgYWRqdXN0cwogIGtleWJvYXJkQWN0aXZlRWxlbWVudCA9IGVsZW1lbnQ7CiAgaW9uaWMudHJpZ2dlcignc2Nyb2xsQ2hpbGRJbnRvVmlldycsIGRldGFpbHMsIHRydWUpOwoKICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZChLRVlCT0FSRF9PUEVOX0NTUyk7CiAgfSk7CgogIC8vIGFueSBzaG93aW5nIHBhcnQgb2YgdGhlIGRvY3VtZW50IHRoYXQgaXNuJ3Qgd2l0aGluIHRoZSBzY3JvbGwgdGhlIHVzZXIKICAvLyBjb3VsZCB0b3VjaG1vdmUgYW5kIGNhdXNlIHNvbWUgdWdseSBjaGFuZ2VzIHRvIHRoZSBhcHAsIHNvIGRpc2FibGUKICAvLyBhbnkgdG91Y2htb3ZlIGV2ZW50cyB3aGlsZSB0aGUga2V5Ym9hcmQgaXMgb3BlbiB1c2luZyBlLnByZXZlbnREZWZhdWx0KCkKICBpZiAod2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkKSB7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJNb3ZlIiwga2V5Ym9hcmRQcmV2ZW50RGVmYXVsdCwgZmFsc2UpOwogIH0gZWxzZSB7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBrZXlib2FyZFByZXZlbnREZWZhdWx0LCBmYWxzZSk7CiAgfQoKICByZXR1cm4gZGV0YWlsczsKfQoKZnVuY3Rpb24ga2V5Ym9hcmRGb2N1c091dChlKSB7CiAgY2xlYXJUaW1lb3V0KGtleWJvYXJkRm9jdXNPdXRUaW1lcik7CgogIGtleWJvYXJkRm9jdXNPdXRUaW1lciA9IHNldFRpbWVvdXQoa2V5Ym9hcmRIaWRlLCAzNTApOwp9CgpmdW5jdGlvbiBrZXlib2FyZEhpZGUoKSB7CiAgdm9pZCAwOwogIGlvbmljLmtleWJvYXJkLmlzT3BlbiA9IGZhbHNlOwoKICBpb25pYy50cmlnZ2VyKCdyZXNldFNjcm9sbFZpZXcnLCB7CiAgICB0YXJnZXQ6IGtleWJvYXJkQWN0aXZlRWxlbWVudAogIH0sIHRydWUpOwoKICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZShLRVlCT0FSRF9PUEVOX0NTUyk7CiAgfSk7CgogIC8vIHRoZSBrZXlib2FyZCBpcyBnb25lIG5vdywgcmVtb3ZlIHRoZSB0b3VjaG1vdmUgdGhhdCBkaXNhYmxlcyBuYXRpdmUgc2Nyb2xsCiAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyTW92ZSIsIGtleWJvYXJkUHJldmVudERlZmF1bHQpOwogIH0gZWxzZSB7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBrZXlib2FyZFByZXZlbnREZWZhdWx0KTsKICB9CiAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGtleWJvYXJkT25LZXlEb3duKTsKfQoKZnVuY3Rpb24ga2V5Ym9hcmRVcGRhdGVWaWV3cG9ydEhlaWdodCgpIHsKICBpZiggZ2V0Vmlld3BvcnRIZWlnaHQoKSA+IGtleWJvYXJkVmlld3BvcnRIZWlnaHQgKSB7CiAgICBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0ID0gZ2V0Vmlld3BvcnRIZWlnaHQoKTsKICB9Cn0KCmZ1bmN0aW9uIGtleWJvYXJkT25LZXlEb3duKGUpIHsKICBpZiggaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nICkgewogICAga2V5Ym9hcmRQcmV2ZW50RGVmYXVsdChlKTsKICB9Cn0KCmZ1bmN0aW9uIGtleWJvYXJkUHJldmVudERlZmF1bHQoZSkgewogIGlmKCBlLnRhcmdldC50YWdOYW1lICE9PSAnVEVYVEFSRUEnICkgewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogIH0KfQoKZnVuY3Rpb24ga2V5Ym9hcmRPcmllbnRhdGlvbkNoYW5nZSgpIHsKICB2YXIgdXBkYXRlZFZpZXdwb3J0SGVpZ2h0ID0gZ2V0Vmlld3BvcnRIZWlnaHQoKTsKCiAgLy90b28gc2xvdywgaGF2ZSB0byB3YWl0IGZvciB1cGRhdGVkIGhlaWdodAogIGlmICh1cGRhdGVkVmlld3BvcnRIZWlnaHQgPT09IGtleWJvYXJkVmlld3BvcnRIZWlnaHQpewogICAgdmFyIGNvdW50ID0gMDsKICAgIHZhciBwb2xsVmlld3BvcnRIZWlnaHQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpewogICAgICAvL2dpdmUgdXAKICAgICAgaWYgKGNvdW50ID4gMTApewogICAgICAgIGNsZWFySW50ZXJ2YWwocG9sbFZpZXdwb3J0SGVpZ2h0KTsKICAgICAgfQoKICAgICAgdXBkYXRlZFZpZXdwb3J0SGVpZ2h0ID0gZ2V0Vmlld3BvcnRIZWlnaHQoKTsKCiAgICAgIGlmICh1cGRhdGVkVmlld3BvcnRIZWlnaHQgIT09IGtleWJvYXJkVmlld3BvcnRIZWlnaHQpewogICAgICAgIGlmICh1cGRhdGVkVmlld3BvcnRIZWlnaHQgPCBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0KXsKICAgICAgICAgIGlvbmljLmtleWJvYXJkLmxhbmRzY2FwZSA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlvbmljLmtleWJvYXJkLmxhbmRzY2FwZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0ID0gdXBkYXRlZFZpZXdwb3J0SGVpZ2h0OwogICAgICAgIGNsZWFySW50ZXJ2YWwocG9sbFZpZXdwb3J0SGVpZ2h0KTsKICAgICAgfQogICAgICBjb3VudCsrOwoKICAgIH0sIDUwKTsKICB9IGVsc2UgewogICAga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCA9IHVwZGF0ZWRWaWV3cG9ydEhlaWdodDsKICB9Cn0KCmZ1bmN0aW9uIGtleWJvYXJkR2V0SGVpZ2h0KCkgewogIC8vIGNoZWNrIGlmIHdlIGFyZSBhbHJlYWR5IGhhdmUgYSBrZXlib2FyZCBoZWlnaHQgZnJvbSB0aGUgcGx1Z2luCiAgaWYgKCBpb25pYy5rZXlib2FyZC5oZWlnaHQgKSB7CiAgICByZXR1cm4gaW9uaWMua2V5Ym9hcmQuaGVpZ2h0OwogIH0KCiAgaWYgKCBpb25pYy5QbGF0Zm9ybS5pc0FuZHJvaWQoKSApewogICAgLy9zaG91bGQgYmUgdXNpbmcgdGhlIHBsdWdpbiwgbm8gd2F5IHRvIGtub3cgaG93IGJpZyB0aGUga2V5Ym9hcmQgaXMsIHNvIGd1ZXNzCiAgICBpZiAoIGlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbiApewogICAgICByZXR1cm4gMjc1OwogICAgfQogICAgLy9vdGhlcndpc2UsIHdhaXQgZm9yIHRoZSBzY3JlZW4gdG8gcmVzaXplCiAgICBpZiAoIGdldFZpZXdwb3J0SGVpZ2h0KCkgPCBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0ICl7CiAgICAgIHJldHVybiBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0IC0gZ2V0Vmlld3BvcnRIZWlnaHQoKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAwOwogICAgfQogIH0KCiAgLy8gZmFsbGJhY2sgZm9yIHdoZW4gaXRzIHRoZSB3ZWJ2aWV3IHdpdGhvdXQgdGhlIHBsdWdpbgogIC8vIG9yIGZvciBqdXN0IHRoZSBzdGFuZGFyZCB3ZWIgYnJvd3NlcgogIGlmKCBpb25pYy5QbGF0Zm9ybS5pc0lPUygpICkgewogICAgaWYgKCBpb25pYy5rZXlib2FyZC5sYW5kc2NhcGUgKXsKICAgICAgcmV0dXJuIDIwNjsKICAgIH0KCiAgICBpZiAoIWlvbmljLlBsYXRmb3JtLmlzV2ViVmlldygpKXsKICAgICAgcmV0dXJuIDIxNjsKICAgIH0KCiAgICByZXR1cm4gMjYwOwogIH0KCiAgLy8gc2FmZSBndWVzcwogIHJldHVybiAyNzU7Cn0KCmZ1bmN0aW9uIGdldFZpZXdwb3J0SGVpZ2h0KCkgewogIHJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgc2NyZWVuLmhlaWdodDsKfQoKZnVuY3Rpb24ga2V5Ym9hcmRJc1dpdGhpblNjcm9sbChlbGUpIHsKICB3aGlsZShlbGUpIHsKICAgIGlmKGVsZS5jbGFzc0xpc3QuY29udGFpbnMoU0NST0xMX0NPTlRBSU5FUl9DU1MpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZWxlID0gZWxlLnBhcmVudEVsZW1lbnQ7CiAgfQogIHJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24ga2V5Ym9hcmRIYXNQbHVnaW4oKSB7CiAgcmV0dXJuICEhKHdpbmRvdy5jb3Jkb3ZhICYmIGNvcmRvdmEucGx1Z2lucyAmJiBjb3Jkb3ZhLnBsdWdpbnMuS2V5Ym9hcmQpOwp9Cgppb25pYy5QbGF0Zm9ybS5yZWFkeShmdW5jdGlvbigpIHsKICBrZXlib2FyZFVwZGF0ZVZpZXdwb3J0SGVpZ2h0KCk7CgogIC8vIEFuZHJvaWQgc29tZXRpbWVzIHJlcG9ydHMgYmFkIGlubmVySGVpZ2h0IG9uIHdpbmRvdy5sb2FkCiAgLy8gdHJ5IGl0IGFnYWluIGluIGEgbGlsIGJpdCB0byBwbGF5IGl0IHNhZmUKICBzZXRUaW1lb3V0KGtleWJvYXJkVXBkYXRlVmlld3BvcnRIZWlnaHQsIDk5OSk7CgogIC8vIG9ubHkgaW5pdGlhbGl6ZSB0aGUgYWRqdXN0bWVudHMgZm9yIHRoZSB2aXJ0dWFsIGtleWJvYXJkCiAgLy8gaWYgYSB0b3VjaHN0YXJ0IGV2ZW50IGhhcHBlbnMKICBpZiAod2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkKSB7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJEb3duIiwga2V5Ym9hcmRJbml0LCBmYWxzZSk7CiAgfSBlbHNlIHsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBrZXlib2FyZEluaXQsIGZhbHNlKTsKICB9Cn0pOwoKCgp2YXIgdmlld3BvcnRUYWc7CnZhciB2aWV3cG9ydFByb3BlcnRpZXMgPSB7fTsKCmlvbmljLnZpZXdwb3J0ID0gewogIG9yaWVudGF0aW9uOiBmdW5jdGlvbigpIHsKICAgIC8vIDAgPSBQb3J0cmFpdAogICAgLy8gOTAgPSBMYW5kc2NhcGUKICAgIC8vIG5vdCB1c2luZyB3aW5kb3cub3JpZW50YXRpb24gYmVjYXVzZSBlYWNoIGRldmljZSBoYXMgYSBkaWZmZXJlbnQgaW1wbGVtZW50YXRpb24KICAgIHJldHVybiAod2luZG93LmlubmVyV2lkdGggPiB3aW5kb3cuaW5uZXJIZWlnaHQgPyA5MCA6IDApOwogIH0KfTsKCmZ1bmN0aW9uIHZpZXdwb3J0TG9hZFRhZygpIHsKICB2YXIgeDsKCiAgZm9yKHg9MDsgeDxkb2N1bWVudC5oZWFkLmNoaWxkcmVuLmxlbmd0aDsgeCsrKSB7CiAgICBpZihkb2N1bWVudC5oZWFkLmNoaWxkcmVuW3hdLm5hbWUgPT0gJ3ZpZXdwb3J0JykgewogICAgICB2aWV3cG9ydFRhZyA9IGRvY3VtZW50LmhlYWQuY2hpbGRyZW5beF07CiAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgaWYodmlld3BvcnRUYWcpIHsKICAgIHZhciBwcm9wcyA9IHZpZXdwb3J0VGFnLmNvbnRlbnQudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9ccysvZywgJycpLnNwbGl0KCcsJyk7CiAgICB2YXIga2V5VmFsdWU7CiAgICBmb3IoeD0wOyB4PHByb3BzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmKHByb3BzW3hdKSB7CiAgICAgICAga2V5VmFsdWUgPSBwcm9wc1t4XS5zcGxpdCgnPScpOwogICAgICAgIHZpZXdwb3J0UHJvcGVydGllc1sga2V5VmFsdWVbMF0gXSA9IChrZXlWYWx1ZS5sZW5ndGggPiAxID8ga2V5VmFsdWVbMV0gOiAnXycpOwogICAgICB9CiAgICB9CiAgICB2aWV3cG9ydFVwZGF0ZSgpOwogIH0KfQoKZnVuY3Rpb24gdmlld3BvcnRVcGRhdGUoKSB7CiAgLy8gdW5pdCB0ZXN0cyBpbiB2aWV3cG9ydC51bml0LmpzCgogIHZhciBpbml0V2lkdGggPSB2aWV3cG9ydFByb3BlcnRpZXMud2lkdGg7CiAgdmFyIGluaXRIZWlnaHQgPSB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0OwogIHZhciBwID0gaW9uaWMuUGxhdGZvcm07CiAgdmFyIHZlcnNpb24gPSBwLnZlcnNpb24oKTsKICB2YXIgREVWSUNFX1dJRFRIID0gJ2RldmljZS13aWR0aCc7CiAgdmFyIERFVklDRV9IRUlHSFQgPSAnZGV2aWNlLWhlaWdodCc7CiAgdmFyIG9yaWVudGF0aW9uID0gaW9uaWMudmlld3BvcnQub3JpZW50YXRpb24oKTsKCiAgLy8gTW9zdCB0aW1lcyB3ZSdyZSByZW1vdmluZyB0aGUgaGVpZ2h0IGFuZCBhZGRpbmcgdGhlIHdpZHRoCiAgLy8gU28gdGhpcyBpcyB0aGUgZGVmYXVsdCB0byBzdGFydCB3aXRoLCB0aGVuIG1vZGlmeSBwZXIgcGxhdGZvcm0vdmVyc2lvbi9vcmVpbnRhdGlvbgogIGRlbGV0ZSB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0OwogIHZpZXdwb3J0UHJvcGVydGllcy53aWR0aCA9IERFVklDRV9XSURUSDsKCiAgaWYoIHAuaXNJUGFkKCkgKSB7CiAgICAvLyBpUGFkCgogICAgaWYoIHZlcnNpb24gPiA3ICkgewogICAgICAvLyBpUGFkID49IDcuMQogICAgICAvLyBodHRwczovL2lzc3Vlcy5hcGFjaGUub3JnL2ppcmEvYnJvd3NlL0NCLTQzMjMKICAgICAgZGVsZXRlIHZpZXdwb3J0UHJvcGVydGllcy53aWR0aDsKCiAgICB9IGVsc2UgewogICAgICAvLyBpUGFkIDw9IDcuMAoKICAgICAgaWYoIHAuaXNXZWJWaWV3KCkgKSB7CiAgICAgICAgLy8gaVBhZCA8PSA3LjAgV2ViVmlldwoKICAgICAgICBpZiggb3JpZW50YXRpb24gPT0gOTAgKSB7CiAgICAgICAgICAvLyBpUGFkIDw9IDcuMCBXZWJWaWV3IExhbmRzY2FwZQogICAgICAgICAgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodCA9ICcwJzsKCiAgICAgICAgfSBlbHNlIGlmKHZlcnNpb24gPT0gNykgewogICAgICAgICAgLy8gaVBhZCA8PSA3LjAgV2ViVmlldyBQb3J0YWl0CiAgICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gREVWSUNFX0hFSUdIVDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaVBhZCA8PSA2LjEgQnJvd3NlcgogICAgICAgIGlmKHZlcnNpb24gPCA3KSB7CiAgICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gJzAnOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICB9IGVsc2UgaWYoIHAuaXNJT1MoKSApIHsKICAgIC8vIGlQaG9uZQoKICAgIGlmKCBwLmlzV2ViVmlldygpICkgewogICAgICAvLyBpUGhvbmUgV2ViVmlldwoKICAgICAgaWYodmVyc2lvbiA+IDcpIHsKICAgICAgICAvLyBpUGhvbmUgPj0gNy4xIFdlYlZpZXcKICAgICAgICBkZWxldGUgdmlld3BvcnRQcm9wZXJ0aWVzLndpZHRoOwoKICAgICAgfSBlbHNlIGlmKHZlcnNpb24gPCA3KSB7CiAgICAgICAgLy8gaVBob25lIDw9IDYuMSBXZWJWaWV3CiAgICAgICAgLy8gaWYgaGVpZ2h0IHdhcyBzZXQgaXQgbmVlZHMgdG8gZ2V0IHJlbW92ZWQgd2l0aCB0aGlzIGhhY2sgZm9yIDw9IDYuMQogICAgICAgIGlmKCBpbml0SGVpZ2h0ICkgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodCA9ICcwJzsKCiAgICAgIH0gZWxzZSBpZih2ZXJzaW9uID09IDcpIHsKICAgICAgICAvL2lQaG9uZSA9PSA3LjAgV2ViVmlldwogICAgICAgIHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQgPSBERVZJQ0VfSEVJR0hUOwogICAgICB9CgogICAgfSBlbHNlIHsKICAgICAgLy8gaVBob25lIEJyb3dzZXIKCiAgICAgIGlmICh2ZXJzaW9uIDwgNykgewogICAgICAgIC8vIGlQaG9uZSA8PSA2LjEgQnJvd3NlcgogICAgICAgIC8vIGlmIGhlaWdodCB3YXMgc2V0IGl0IG5lZWRzIHRvIGdldCByZW1vdmVkIHdpdGggdGhpcyBoYWNrIGZvciA8PSA2LjEKICAgICAgICBpZiggaW5pdEhlaWdodCApIHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQgPSAnMCc7CiAgICAgIH0KICAgIH0KCiAgfQoKICAvLyBvbmx5IHVwZGF0ZSB0aGUgdmlld3BvcnQgdGFnIGlmIHRoZXJlIHdhcyBhIGNoYW5nZQogIGlmKGluaXRXaWR0aCAhPT0gdmlld3BvcnRQcm9wZXJ0aWVzLndpZHRoIHx8IGluaXRIZWlnaHQgIT09IHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQpIHsKICAgIHZpZXdwb3J0VGFnVXBkYXRlKCk7CiAgfQp9CgpmdW5jdGlvbiB2aWV3cG9ydFRhZ1VwZGF0ZSgpIHsKICB2YXIga2V5LCBwcm9wcyA9IFtdOwogIGZvcihrZXkgaW4gdmlld3BvcnRQcm9wZXJ0aWVzKSB7CiAgICBpZiggdmlld3BvcnRQcm9wZXJ0aWVzW2tleV0gKSB7CiAgICAgIHByb3BzLnB1c2goa2V5ICsgKHZpZXdwb3J0UHJvcGVydGllc1trZXldID09ICdfJyA/ICcnIDogJz0nICsgdmlld3BvcnRQcm9wZXJ0aWVzW2tleV0pICk7CiAgICB9CiAgfQoKICB2aWV3cG9ydFRhZy5jb250ZW50ID0gcHJvcHMuam9pbignLCAnKTsKfQoKaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAgdmlld3BvcnRMb2FkVGFnKCk7CgogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJvcmllbnRhdGlvbmNoYW5nZSIsIGZ1bmN0aW9uKCl7CiAgICBzZXRUaW1lb3V0KHZpZXdwb3J0VXBkYXRlLCAxMDAwKTsKICB9LCBmYWxzZSk7Cn0pOwoKKGZ1bmN0aW9uKGlvbmljKSB7Cid1c2Ugc3RyaWN0JzsKICBpb25pYy52aWV3cy5WaWV3ID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQgPSBpb25pYy5pbmhlcml0OwoKICBpb25pYy5leHRlbmQoaW9uaWMudmlld3MuVmlldy5wcm90b3R5cGUsIHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkge30KICB9KTsKCn0pKHdpbmRvdy5pb25pYyk7CgovKgogKiBTY3JvbGxlcgogKiBodHRwOi8vZ2l0aHViLmNvbS96eW5nYS9zY3JvbGxlcgogKgogKiBDb3B5cmlnaHQgMjAxMSwgWnluZ2EgSW5jLgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuCiAqIGh0dHBzOi8vcmF3LmdpdGh1Yi5jb20venluZ2Evc2Nyb2xsZXIvbWFzdGVyL01JVC1MSUNFTlNFLnR4dAogKgogKiBCYXNlZCBvbiB0aGUgd29yayBvZjogVW5pZnkgUHJvamVjdCAodW5pZnktcHJvamVjdC5vcmcpCiAqIGh0dHA6Ly91bmlmeS1wcm9qZWN0Lm9yZwogKiBDb3B5cmlnaHQgMjAxMSwgRGV1dHNjaGUgVGVsZWtvbSBBRwogKiBMaWNlbnNlOiBNSVQgKyBBcGFjaGUgKFYyKQogKi8KCi8qIGpzaGludCBlcW51bGw6IHRydWUgKi8KCi8qKgogKiBHZW5lcmljIGFuaW1hdGlvbiBjbGFzcyB3aXRoIHN1cHBvcnQgZm9yIGRyb3BwZWQgZnJhbWVzIGJvdGggb3B0aW9uYWwgZWFzaW5nIGFuZCBkdXJhdGlvbi4KICoKICogT3B0aW9uYWwgZHVyYXRpb24gaXMgdXNlZnVsIHdoZW4gdGhlIGxpZmV0aW1lIGlzIGRlZmluZWQgYnkgYW5vdGhlciBjb25kaXRpb24gdGhhbiB0aW1lCiAqIGUuZy4gc3BlZWQgb2YgYW4gYW5pbWF0aW5nIG9iamVjdCwgZXRjLgogKgogKiBEcm9wcGVkIGZyYW1lIGxvZ2ljIGFsbG93cyB0byBrZWVwIHVzaW5nIHRoZSBzYW1lIHVwZGF0ZXIgbG9naWMgaW5kZXBlbmRlbnQgZnJvbSB0aGUgYWN0dWFsCiAqIHJlbmRlcmluZy4gVGhpcyBlYXNlcyBhIGxvdCBvZiBjYXNlcyB3aGVyZSBpdCBtaWdodCBiZSBwcmV0dHkgY29tcGxleCB0byBicmVhayBkb3duIGEgc3RhdGUKICogYmFzZWQgb24gdGhlIHB1cmUgdGltZSBkaWZmZXJlbmNlLgogKi8KdmFyIHp5bmdhQ29yZSA9IHsgZWZmZWN0OiB7fSB9OwooZnVuY3Rpb24oZ2xvYmFsKSB7CiAgdmFyIHRpbWUgPSBEYXRlLm5vdyB8fCBmdW5jdGlvbigpIHsKICAgIHJldHVybiArbmV3IERhdGUoKTsKICB9OwogIHZhciBkZXNpcmVkRnJhbWVzID0gNjA7CiAgdmFyIG1pbGxpc2Vjb25kc1BlclNlY29uZCA9IDEwMDA7CiAgdmFyIHJ1bm5pbmcgPSB7fTsKICB2YXIgY291bnRlciA9IDE7CgogIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZSA9IHsKCiAgICAvKioKICAgICAqIEEgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHdyYXBwZXIgLyBwb2x5ZmlsbC4KICAgICAqCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufSBUaGUgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBiZWZvcmUgdGhlIG5leHQgcmVwYWludC4KICAgICAqIEBwYXJhbSByb290IHtIVE1MRWxlbWVudH0gVGhlIHJvb3QgZWxlbWVudCBmb3IgdGhlIHJlcGFpbnQKICAgICAqLwogICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lOiAoZnVuY3Rpb24oKSB7CgogICAgICAvLyBDaGVjayBmb3IgcmVxdWVzdCBhbmltYXRpb24gRnJhbWUgc3VwcG9ydAogICAgICB2YXIgcmVxdWVzdEZyYW1lID0gZ2xvYmFsLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCBnbG9iYWwud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IGdsb2JhbC5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgZ2xvYmFsLm9SZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CiAgICAgIHZhciBpc05hdGl2ZSA9ICEhcmVxdWVzdEZyYW1lOwoKICAgICAgaWYgKHJlcXVlc3RGcmFtZSAmJiAhL3JlcXVlc3RBbmltYXRpb25GcmFtZVwoXClccypce1xzKlxbbmF0aXZlIGNvZGVcXVxzKlx9L2kudGVzdChyZXF1ZXN0RnJhbWUudG9TdHJpbmcoKSkpIHsKICAgICAgICBpc05hdGl2ZSA9IGZhbHNlOwogICAgICB9CgogICAgICBpZiAoaXNOYXRpdmUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2ssIHJvb3QpIHsKICAgICAgICAgIHJlcXVlc3RGcmFtZShjYWxsYmFjaywgcm9vdCk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgdmFyIFRBUkdFVF9GUFMgPSA2MDsKICAgICAgdmFyIHJlcXVlc3RzID0ge307CiAgICAgIHZhciByZXF1ZXN0Q291bnQgPSAwOwogICAgICB2YXIgcmFmSGFuZGxlID0gMTsKICAgICAgdmFyIGludGVydmFsSGFuZGxlID0gbnVsbDsKICAgICAgdmFyIGxhc3RBY3RpdmUgPSArbmV3IERhdGUoKTsKCiAgICAgIHJldHVybiBmdW5jdGlvbihjYWxsYmFjaywgcm9vdCkgewogICAgICAgIHZhciBjYWxsYmFja0hhbmRsZSA9IHJhZkhhbmRsZSsrOwoKICAgICAgICAvLyBTdG9yZSBjYWxsYmFjawogICAgICAgIHJlcXVlc3RzW2NhbGxiYWNrSGFuZGxlXSA9IGNhbGxiYWNrOwogICAgICAgIHJlcXVlc3RDb3VudCsrOwoKICAgICAgICAvLyBDcmVhdGUgdGltZW91dCBhdCBmaXJzdCByZXF1ZXN0CiAgICAgICAgaWYgKGludGVydmFsSGFuZGxlID09PSBudWxsKSB7CgogICAgICAgICAgaW50ZXJ2YWxIYW5kbGUgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciB0aW1lID0gK25ldyBEYXRlKCk7CiAgICAgICAgICAgIHZhciBjdXJyZW50UmVxdWVzdHMgPSByZXF1ZXN0czsKCiAgICAgICAgICAgIC8vIFJlc2V0IGRhdGEgc3RydWN0dXJlIGJlZm9yZSBleGVjdXRpbmcgY2FsbGJhY2tzCiAgICAgICAgICAgIHJlcXVlc3RzID0ge307CiAgICAgICAgICAgIHJlcXVlc3RDb3VudCA9IDA7CgogICAgICAgICAgICBmb3IodmFyIGtleSBpbiBjdXJyZW50UmVxdWVzdHMpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudFJlcXVlc3RzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRSZXF1ZXN0c1trZXldKHRpbWUpOwogICAgICAgICAgICAgICAgbGFzdEFjdGl2ZSA9IHRpbWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEaXNhYmxlIHRoZSB0aW1lb3V0IHdoZW4gbm90aGluZyBoYXBwZW5zIGZvciBhIGNlcnRhaW4KICAgICAgICAgICAgLy8gcGVyaW9kIG9mIHRpbWUKICAgICAgICAgICAgaWYgKHRpbWUgLSBsYXN0QWN0aXZlID4gMjUwMCkgewogICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxIYW5kbGUpOwogICAgICAgICAgICAgIGludGVydmFsSGFuZGxlID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0sIDEwMDAgLyBUQVJHRVRfRlBTKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjYWxsYmFja0hhbmRsZTsKICAgICAgfTsKCiAgICB9KSgpLAoKCiAgICAvKioKICAgICAqIFN0b3BzIHRoZSBnaXZlbiBhbmltYXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIGlkIHtJbnRlZ2VyfSBVbmlxdWUgYW5pbWF0aW9uIElECiAgICAgKiBAcmV0dXJuIHtCb29sZWFufSBXaGV0aGVyIHRoZSBhbmltYXRpb24gd2FzIHN0b3BwZWQgKGFrYSwgd2FzIHJ1bm5pbmcgYmVmb3JlKQogICAgICovCiAgICBzdG9wOiBmdW5jdGlvbihpZCkgewogICAgICB2YXIgY2xlYXJlZCA9IHJ1bm5pbmdbaWRdICE9IG51bGw7CiAgICAgIGlmIChjbGVhcmVkKSB7CiAgICAgICAgcnVubmluZ1tpZF0gPSBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gY2xlYXJlZDsKICAgIH0sCgoKICAgIC8qKgogICAgICogV2hldGhlciB0aGUgZ2l2ZW4gYW5pbWF0aW9uIGlzIHN0aWxsIHJ1bm5pbmcuCiAgICAgKgogICAgICogQHBhcmFtIGlkIHtJbnRlZ2VyfSBVbmlxdWUgYW5pbWF0aW9uIElECiAgICAgKiBAcmV0dXJuIHtCb29sZWFufSBXaGV0aGVyIHRoZSBhbmltYXRpb24gaXMgc3RpbGwgcnVubmluZwogICAgICovCiAgICBpc1J1bm5pbmc6IGZ1bmN0aW9uKGlkKSB7CiAgICAgIHJldHVybiBydW5uaW5nW2lkXSAhPSBudWxsOwogICAgfSwKCgogICAgLyoqCiAgICAgKiBTdGFydCB0aGUgYW5pbWF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBzdGVwQ2FsbGJhY2sge0Z1bmN0aW9ufSBQb2ludGVyIHRvIGZ1bmN0aW9uIHdoaWNoIGlzIGV4ZWN1dGVkIG9uIGV2ZXJ5IHN0ZXAuCiAgICAgKiAgIFNpZ25hdHVyZSBvZiB0aGUgbWV0aG9kIHNob3VsZCBiZSBgZnVuY3Rpb24ocGVyY2VudCwgbm93LCB2aXJ0dWFsKSB7IHJldHVybiBjb250aW51ZVdpdGhBbmltYXRpb247IH1gCiAgICAgKiBAcGFyYW0gdmVyaWZ5Q2FsbGJhY2sge0Z1bmN0aW9ufSBFeGVjdXRlZCBiZWZvcmUgZXZlcnkgYW5pbWF0aW9uIHN0ZXAuCiAgICAgKiAgIFNpZ25hdHVyZSBvZiB0aGUgbWV0aG9kIHNob3VsZCBiZSBgZnVuY3Rpb24oKSB7IHJldHVybiBjb250aW51ZVdpdGhBbmltYXRpb247IH1gCiAgICAgKiBAcGFyYW0gY29tcGxldGVkQ2FsbGJhY2sge0Z1bmN0aW9ufQogICAgICogICBTaWduYXR1cmUgb2YgdGhlIG1ldGhvZCBzaG91bGQgYmUgYGZ1bmN0aW9uKGRyb3BwZWRGcmFtZXMsIGZpbmlzaGVkQW5pbWF0aW9uKSB7fWAKICAgICAqIEBwYXJhbSBkdXJhdGlvbiB7SW50ZWdlcn0gTWlsbGlzZWNvbmRzIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgKiBAcGFyYW0gZWFzaW5nTWV0aG9kIHtGdW5jdGlvbn0gUG9pbnRlciB0byBlYXNpbmcgZnVuY3Rpb24KICAgICAqICAgU2lnbmF0dXJlIG9mIHRoZSBtZXRob2Qgc2hvdWxkIGJlIGBmdW5jdGlvbihwZXJjZW50KSB7IHJldHVybiBtb2RpZmllZFZhbHVlOyB9YAogICAgICogQHBhcmFtIHJvb3Qge0VsZW1lbnR9IFJlbmRlciByb290LCB3aGVuIGF2YWlsYWJsZS4gVXNlZCBmb3IgaW50ZXJuYWwKICAgICAqICAgdXNhZ2Ugb2YgcmVxdWVzdEFuaW1hdGlvbkZyYW1lLgogICAgICogQHJldHVybiB7SW50ZWdlcn0gSWRlbnRpZmllciBvZiBhbmltYXRpb24uIENhbiBiZSB1c2VkIHRvIHN0b3AgaXQgYW55IHRpbWUuCiAgICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbihzdGVwQ2FsbGJhY2ssIHZlcmlmeUNhbGxiYWNrLCBjb21wbGV0ZWRDYWxsYmFjaywgZHVyYXRpb24sIGVhc2luZ01ldGhvZCwgcm9vdCkgewoKICAgICAgdmFyIHN0YXJ0ID0gdGltZSgpOwogICAgICB2YXIgbGFzdEZyYW1lID0gc3RhcnQ7CiAgICAgIHZhciBwZXJjZW50ID0gMDsKICAgICAgdmFyIGRyb3BDb3VudGVyID0gMDsKICAgICAgdmFyIGlkID0gY291bnRlcisrOwoKICAgICAgaWYgKCFyb290KSB7CiAgICAgICAgcm9vdCA9IGRvY3VtZW50LmJvZHk7CiAgICAgIH0KCiAgICAgIC8vIENvbXBhY3RpbmcgcnVubmluZyBkYiBhdXRvbWF0aWNhbGx5IGV2ZXJ5IGZldyBuZXcgYW5pbWF0aW9ucwogICAgICBpZiAoaWQgJSAyMCA9PT0gMCkgewogICAgICAgIHZhciBuZXdSdW5uaW5nID0ge307CiAgICAgICAgZm9yICh2YXIgdXNlZElkIGluIHJ1bm5pbmcpIHsKICAgICAgICAgIG5ld1J1bm5pbmdbdXNlZElkXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJ1bm5pbmcgPSBuZXdSdW5uaW5nOwogICAgICB9CgogICAgICAvLyBUaGlzIGlzIHRoZSBpbnRlcm5hbCBzdGVwIG1ldGhvZCB3aGljaCBpcyBjYWxsZWQgZXZlcnkgZmV3IG1pbGxpc2Vjb25kcwogICAgICB2YXIgc3RlcCA9IGZ1bmN0aW9uKHZpcnR1YWwpIHsKCiAgICAgICAgLy8gTm9ybWFsaXplIHZpcnR1YWwgdmFsdWUKICAgICAgICB2YXIgcmVuZGVyID0gdmlydHVhbCAhPT0gdHJ1ZTsKCiAgICAgICAgLy8gR2V0IGN1cnJlbnQgdGltZQogICAgICAgIHZhciBub3cgPSB0aW1lKCk7CgogICAgICAgIC8vIFZlcmlmaWNhdGlvbiBpcyBleGVjdXRlZCBiZWZvcmUgbmV4dCBhbmltYXRpb24gc3RlcAogICAgICAgIGlmICghcnVubmluZ1tpZF0gfHwgKHZlcmlmeUNhbGxiYWNrICYmICF2ZXJpZnlDYWxsYmFjayhpZCkpKSB7CgogICAgICAgICAgcnVubmluZ1tpZF0gPSBudWxsOwogICAgICAgICAgY29tcGxldGVkQ2FsbGJhY2sgJiYgY29tcGxldGVkQ2FsbGJhY2soZGVzaXJlZEZyYW1lcyAtIChkcm9wQ291bnRlciAvICgobm93IC0gc3RhcnQpIC8gbWlsbGlzZWNvbmRzUGVyU2Vjb25kKSksIGlkLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm47CgogICAgICAgIH0KCiAgICAgICAgLy8gRm9yIHRoZSBjdXJyZW50IHJlbmRlcmluZyB0byBhcHBseSBsZXQncyB1cGRhdGUgb21pdHRlZCBzdGVwcyBpbiBtZW1vcnkuCiAgICAgICAgLy8gVGhpcyBpcyBpbXBvcnRhbnQgdG8gYnJpbmcgaW50ZXJuYWwgc3RhdGUgdmFyaWFibGVzIHVwLXRvLWRhdGUgd2l0aCBwcm9ncmVzcyBpbiB0aW1lLgogICAgICAgIGlmIChyZW5kZXIpIHsKCiAgICAgICAgICB2YXIgZHJvcHBlZEZyYW1lcyA9IE1hdGgucm91bmQoKG5vdyAtIGxhc3RGcmFtZSkgLyAobWlsbGlzZWNvbmRzUGVyU2Vjb25kIC8gZGVzaXJlZEZyYW1lcykpIC0gMTsKICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgTWF0aC5taW4oZHJvcHBlZEZyYW1lcywgNCk7IGorKykgewogICAgICAgICAgICBzdGVwKHRydWUpOwogICAgICAgICAgICBkcm9wQ291bnRlcisrOwogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIC8vIENvbXB1dGUgcGVyY2VudCB2YWx1ZQogICAgICAgIGlmIChkdXJhdGlvbikgewogICAgICAgICAgcGVyY2VudCA9IChub3cgLSBzdGFydCkgLyBkdXJhdGlvbjsKICAgICAgICAgIGlmIChwZXJjZW50ID4gMSkgewogICAgICAgICAgICBwZXJjZW50ID0gMTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEV4ZWN1dGUgc3RlcCBjYWxsYmFjaywgdGhlbi4uLgogICAgICAgIHZhciB2YWx1ZSA9IGVhc2luZ01ldGhvZCA/IGVhc2luZ01ldGhvZChwZXJjZW50KSA6IHBlcmNlbnQ7CiAgICAgICAgaWYgKChzdGVwQ2FsbGJhY2sodmFsdWUsIG5vdywgcmVuZGVyKSA9PT0gZmFsc2UgfHwgcGVyY2VudCA9PT0gMSkgJiYgcmVuZGVyKSB7CiAgICAgICAgICBydW5uaW5nW2lkXSA9IG51bGw7CiAgICAgICAgICBjb21wbGV0ZWRDYWxsYmFjayAmJiBjb21wbGV0ZWRDYWxsYmFjayhkZXNpcmVkRnJhbWVzIC0gKGRyb3BDb3VudGVyIC8gKChub3cgLSBzdGFydCkgLyBtaWxsaXNlY29uZHNQZXJTZWNvbmQpKSwgaWQsIHBlcmNlbnQgPT09IDEgfHwgZHVyYXRpb24gPT0gbnVsbCk7CiAgICAgICAgfSBlbHNlIGlmIChyZW5kZXIpIHsKICAgICAgICAgIGxhc3RGcmFtZSA9IG5vdzsKICAgICAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoc3RlcCwgcm9vdCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgLy8gTWFyayBhcyBydW5uaW5nCiAgICAgIHJ1bm5pbmdbaWRdID0gdHJ1ZTsKCiAgICAgIC8vIEluaXQgZmlyc3Qgc3RlcAogICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHN0ZXAsIHJvb3QpOwoKICAgICAgLy8gUmV0dXJuIHVuaXF1ZSBhbmltYXRpb24gSUQKICAgICAgcmV0dXJuIGlkOwogICAgfQogIH07Cn0pKHRoaXMpOwoKLyoKICogU2Nyb2xsZXIKICogaHR0cDovL2dpdGh1Yi5jb20venluZ2Evc2Nyb2xsZXIKICoKICogQ29weXJpZ2h0IDIwMTEsIFp5bmdhIEluYy4KICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLgogKiBodHRwczovL3Jhdy5naXRodWIuY29tL3p5bmdhL3Njcm9sbGVyL21hc3Rlci9NSVQtTElDRU5TRS50eHQKICoKICogQmFzZWQgb24gdGhlIHdvcmsgb2Y6IFVuaWZ5IFByb2plY3QgKHVuaWZ5LXByb2plY3Qub3JnKQogKiBodHRwOi8vdW5pZnktcHJvamVjdC5vcmcKICogQ29weXJpZ2h0IDIwMTEsIERldXRzY2hlIFRlbGVrb20gQUcKICogTGljZW5zZTogTUlUICsgQXBhY2hlIChWMikKICovCgp2YXIgU2Nyb2xsZXI7CgooZnVuY3Rpb24oaW9uaWMpIHsKICB2YXIgTk9PUCA9IGZ1bmN0aW9uKCl7fTsKCiAgLy8gRWFzaW5nIEVxdWF0aW9ucyAoYykgMjAwMyBSb2JlcnQgUGVubmVyLCBhbGwgcmlnaHRzIHJlc2VydmVkLgogIC8vIE9wZW4gc291cmNlIHVuZGVyIHRoZSBCU0QgTGljZW5zZS4KCiAgLyoqCiAgICogQHBhcmFtIHBvcyB7TnVtYmVyfSBwb3NpdGlvbiBiZXR3ZWVuIDAgKHN0YXJ0IG9mIGVmZmVjdCkgYW5kIDEgKGVuZCBvZiBlZmZlY3QpCiAgKiovCiAgdmFyIGVhc2VPdXRDdWJpYyA9IGZ1bmN0aW9uKHBvcykgewogICAgcmV0dXJuIChNYXRoLnBvdygocG9zIC0gMSksIDMpICsgMSk7CiAgfTsKCiAgLyoqCiAgICogQHBhcmFtIHBvcyB7TnVtYmVyfSBwb3NpdGlvbiBiZXR3ZWVuIDAgKHN0YXJ0IG9mIGVmZmVjdCkgYW5kIDEgKGVuZCBvZiBlZmZlY3QpCiAgKiovCiAgdmFyIGVhc2VJbk91dEN1YmljID0gZnVuY3Rpb24ocG9zKSB7CiAgICBpZiAoKHBvcyAvPSAwLjUpIDwgMSkgewogICAgICByZXR1cm4gMC41ICogTWF0aC5wb3cocG9zLCAzKTsKICAgIH0KCiAgICByZXR1cm4gMC41ICogKE1hdGgucG93KChwb3MgLSAyKSwgMykgKyAyKTsKICB9OwoKCi8qKgogKiBpb25pYy52aWV3cy5TY3JvbGwKICogQSBwb3dlcmZ1bCBzY3JvbGwgdmlldyB3aXRoIHN1cHBvcnQgZm9yIGJvdW5jaW5nLCBwdWxsIHRvIHJlZnJlc2gsIGFuZCBwYWdpbmcuCiAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICBvcHRpb25zIG9wdGlvbnMgZm9yIHRoZSBzY3JvbGwgdmlldwogKiBAY2xhc3MgQSBzY3JvbGwgdmlldyBzeXN0ZW0KICogQG1lbWJlcm9mIGlvbmljLnZpZXdzCiAqLwppb25pYy52aWV3cy5TY3JvbGwgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLl9fY29udGFpbmVyID0gb3B0aW9ucy5lbDsKICAgIHRoaXMuX19jb250ZW50ID0gb3B0aW9ucy5lbC5maXJzdEVsZW1lbnRDaGlsZDsKCiAgICAvL1JlbW92ZSBhbnkgc2Nyb2xsVG9wIGF0dGFjaGVkIHRvIHRoZXNlIGVsZW1lbnRzOyB0aGV5IGFyZSB2aXJ0dWFsIHNjcm9sbCBub3cKICAgIC8vVGhpcyBhbHNvIHN0b3BzIG9uLWxvYWQtc2Nyb2xsLXRvLXdpbmRvdy5sb2NhdGlvbi5oYXNoIHRoYXQgdGhlIGJyb3dzZXIgZG9lcwogICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgaWYgKHNlbGYuX19jb250YWluZXIgJiYgc2VsZi5fX2NvbnRlbnQpIHsKICAgICAgICBzZWxmLl9fY29udGFpbmVyLnNjcm9sbFRvcCA9IDA7CiAgICAgICAgc2VsZi5fX2NvbnRlbnQuc2Nyb2xsVG9wID0gMDsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5vcHRpb25zID0gewoKICAgICAgLyoqIERpc2FibGUgc2Nyb2xsaW5nIG9uIHgtYXhpcyBieSBkZWZhdWx0ICovCiAgICAgIHNjcm9sbGluZ1g6IGZhbHNlLAogICAgICBzY3JvbGxiYXJYOiB0cnVlLAoKICAgICAgLyoqIEVuYWJsZSBzY3JvbGxpbmcgb24geS1heGlzICovCiAgICAgIHNjcm9sbGluZ1k6IHRydWUsCiAgICAgIHNjcm9sbGJhclk6IHRydWUsCgogICAgICBzdGFydFg6IDAsCiAgICAgIHN0YXJ0WTogMCwKCiAgICAgIC8qKiBUaGUgYW1vdW50IHRvIGRhbXBlbiBtb3VzZXdoZWVsIGV2ZW50cyAqLwogICAgICB3aGVlbERhbXBlbjogNiwKCiAgICAgIC8qKiBUaGUgbWluaW11bSBzaXplIHRoZSBzY3JvbGxiYXJzIHNjYWxlIHRvIHdoaWxlIHNjcm9sbGluZyAqLwogICAgICBtaW5TY3JvbGxiYXJTaXplWDogNSwKICAgICAgbWluU2Nyb2xsYmFyU2l6ZVk6IDUsCgogICAgICAvKiogU2Nyb2xsYmFyIGZhZGluZyBhZnRlciBzY3JvbGxpbmcgKi8KICAgICAgc2Nyb2xsYmFyc0ZhZGU6IHRydWUsCiAgICAgIHNjcm9sbGJhckZhZGVEZWxheTogMzAwLAogICAgICAvKiogVGhlIGluaXRpYWwgZmFkZSBkZWxheSB3aGVuIHRoZSBwYW5lIGlzIHJlc2l6ZWQgb3IgaW5pdGlhbGl6ZWQgKi8KICAgICAgc2Nyb2xsYmFyUmVzaXplRmFkZURlbGF5OiAxMDAwLAoKICAgICAgLyoqIEVuYWJsZSBhbmltYXRpb25zIGZvciBkZWNlbGVyYXRpb24sIHNuYXAgYmFjaywgem9vbWluZyBhbmQgc2Nyb2xsaW5nICovCiAgICAgIGFuaW1hdGluZzogdHJ1ZSwKCiAgICAgIC8qKiBkdXJhdGlvbiBmb3IgYW5pbWF0aW9ucyB0cmlnZ2VyZWQgYnkgc2Nyb2xsVG8vem9vbVRvICovCiAgICAgIGFuaW1hdGlvbkR1cmF0aW9uOiAyNTAsCgogICAgICAvKiogRW5hYmxlIGJvdW5jaW5nIChjb250ZW50IGNhbiBiZSBzbG93bHkgbW92ZWQgb3V0c2lkZSBhbmQganVtcHMgYmFjayBhZnRlciByZWxlYXNpbmcpICovCiAgICAgIGJvdW5jaW5nOiB0cnVlLAoKICAgICAgLyoqIEVuYWJsZSBsb2NraW5nIHRvIHRoZSBtYWluIGF4aXMgaWYgdXNlciBtb3ZlcyBvbmx5IHNsaWdodGx5IG9uIG9uZSBvZiB0aGVtIGF0IHN0YXJ0ICovCiAgICAgIGxvY2tpbmc6IHRydWUsCgogICAgICAvKiogRW5hYmxlIHBhZ2luYXRpb24gbW9kZSAoc3dpdGNoaW5nIGJldHdlZW4gZnVsbCBwYWdlIGNvbnRlbnQgcGFuZXMpICovCiAgICAgIHBhZ2luZzogZmFsc2UsCgogICAgICAvKiogRW5hYmxlIHNuYXBwaW5nIG9mIGNvbnRlbnQgdG8gYSBjb25maWd1cmVkIHBpeGVsIGdyaWQgKi8KICAgICAgc25hcHBpbmc6IGZhbHNlLAoKICAgICAgLyoqIEVuYWJsZSB6b29taW5nIG9mIGNvbnRlbnQgdmlhIEFQSSwgZmluZ2VycyBhbmQgbW91c2Ugd2hlZWwgKi8KICAgICAgem9vbWluZzogZmFsc2UsCgogICAgICAvKiogTWluaW11bSB6b29tIGxldmVsICovCiAgICAgIG1pblpvb206IDAuNSwKCiAgICAgIC8qKiBNYXhpbXVtIHpvb20gbGV2ZWwgKi8KICAgICAgbWF4Wm9vbTogMywKCiAgICAgIC8qKiBNdWx0aXBseSBvciBkZWNyZWFzZSBzY3JvbGxpbmcgc3BlZWQgKiovCiAgICAgIHNwZWVkTXVsdGlwbGllcjogMSwKCiAgICAgIGRlY2VsZXJhdGlvbjogMC45NywKCiAgICAgIC8qKiBDYWxsYmFjayB0aGF0IGlzIGZpcmVkIG9uIHRoZSBsYXRlciBvZiB0b3VjaCBlbmQgb3IgZGVjZWxlcmF0aW9uIGVuZCwKICAgICAgICBwcm92aWRlZCB0aGF0IGFub3RoZXIgc2Nyb2xsaW5nIGFjdGlvbiBoYXMgbm90IGJlZ3VuLiBVc2VkIHRvIGtub3cKICAgICAgICB3aGVuIHRvIGZhZGUgb3V0IGEgc2Nyb2xsYmFyLiAqLwogICAgICBzY3JvbGxpbmdDb21wbGV0ZTogTk9PUCwKCiAgICAgIC8qKiBUaGlzIGNvbmZpZ3VyZXMgdGhlIGFtb3VudCBvZiBjaGFuZ2UgYXBwbGllZCB0byBkZWNlbGVyYXRpb24gd2hlbiByZWFjaGluZyBib3VuZGFyaWVzICAqKi8KICAgICAgcGVuZXRyYXRpb25EZWNlbGVyYXRpb24gOiAwLjAzLAoKICAgICAgLyoqIFRoaXMgY29uZmlndXJlcyB0aGUgYW1vdW50IG9mIGNoYW5nZSBhcHBsaWVkIHRvIGFjY2VsZXJhdGlvbiB3aGVuIHJlYWNoaW5nIGJvdW5kYXJpZXMgICoqLwogICAgICBwZW5ldHJhdGlvbkFjY2VsZXJhdGlvbiA6IDAuMDgsCgogICAgICAvLyBUaGUgbXMgaW50ZXJ2YWwgZm9yIHRyaWdnZXJpbmcgc2Nyb2xsIGV2ZW50cwogICAgICBzY3JvbGxFdmVudEludGVydmFsOiAxMCwKCiAgICAgIGdldENvbnRlbnRXaWR0aDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KHNlbGYuX19jb250ZW50LnNjcm9sbFdpZHRoLCBzZWxmLl9fY29udGVudC5vZmZzZXRXaWR0aCk7CiAgICAgIH0sCiAgICAgIGdldENvbnRlbnRIZWlnaHQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBNYXRoLm1heChzZWxmLl9fY29udGVudC5zY3JvbGxIZWlnaHQsIHNlbGYuX19jb250ZW50Lm9mZnNldEhlaWdodCArIChzZWxmLl9fY29udGVudC5vZmZzZXRUb3AgKiAyKSk7CiAgICAgIH0KICAgIH07CgogICAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMpIHsKICAgICAgdGhpcy5vcHRpb25zW2tleV0gPSBvcHRpb25zW2tleV07CiAgICB9CgogICAgdGhpcy5oaW50UmVzaXplID0gaW9uaWMuZGVib3VuY2UoZnVuY3Rpb24oKSB7CiAgICAgIHNlbGYucmVzaXplKCk7CiAgICB9LCAxMDAwLCB0cnVlKTsKCiAgICB0aGlzLm9uU2Nyb2xsID0gZnVuY3Rpb24oKSB7CgogICAgICBpZighaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nKSB7CiAgICAgICAgc2V0VGltZW91dChzZWxmLnNldFNjcm9sbFN0YXJ0LCA1MCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHNlbGYuc2Nyb2xsVGltZXIpOwogICAgICAgIHNlbGYuc2Nyb2xsVGltZXIgPSBzZXRUaW1lb3V0KHNlbGYuc2V0U2Nyb2xsU3RvcCwgODApOwogICAgICB9CgogICAgfTsKCiAgICB0aGlzLnNldFNjcm9sbFN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyA9IE1hdGguYWJzKGlvbmljLnNjcm9sbC5sYXN0VG9wIC0gc2VsZi5fX3Njcm9sbFRvcCkgPiAxOwogICAgICBjbGVhclRpbWVvdXQoc2VsZi5zY3JvbGxUaW1lcik7CiAgICAgIHNlbGYuc2Nyb2xsVGltZXIgPSBzZXRUaW1lb3V0KHNlbGYuc2V0U2Nyb2xsU3RvcCwgODApOwogICAgfTsKCiAgICB0aGlzLnNldFNjcm9sbFN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nID0gZmFsc2U7CiAgICAgIGlvbmljLnNjcm9sbC5sYXN0VG9wID0gc2VsZi5fX3Njcm9sbFRvcDsKICAgIH07CgogICAgdGhpcy50cmlnZ2VyU2Nyb2xsRXZlbnQgPSBpb25pYy50aHJvdHRsZShmdW5jdGlvbigpIHsKICAgICAgc2VsZi5vblNjcm9sbCgpOwogICAgICBpb25pYy50cmlnZ2VyKCdzY3JvbGwnLCB7CiAgICAgICAgc2Nyb2xsVG9wOiBzZWxmLl9fc2Nyb2xsVG9wLAogICAgICAgIHNjcm9sbExlZnQ6IHNlbGYuX19zY3JvbGxMZWZ0LAogICAgICAgIHRhcmdldDogc2VsZi5fX2NvbnRhaW5lcgogICAgICB9KTsKICAgIH0sIHRoaXMub3B0aW9ucy5zY3JvbGxFdmVudEludGVydmFsKTsKCiAgICB0aGlzLnRyaWdnZXJTY3JvbGxFbmRFdmVudCA9IGZ1bmN0aW9uKCkgewogICAgICBpb25pYy50cmlnZ2VyKCdzY3JvbGxlbmQnLCB7CiAgICAgICAgc2Nyb2xsVG9wOiBzZWxmLl9fc2Nyb2xsVG9wLAogICAgICAgIHNjcm9sbExlZnQ6IHNlbGYuX19zY3JvbGxMZWZ0LAogICAgICAgIHRhcmdldDogc2VsZi5fX2NvbnRhaW5lcgogICAgICB9KTsKICAgIH07CgogICAgdGhpcy5fX3Njcm9sbExlZnQgPSB0aGlzLm9wdGlvbnMuc3RhcnRYOwogICAgdGhpcy5fX3Njcm9sbFRvcCA9IHRoaXMub3B0aW9ucy5zdGFydFk7CgogICAgLy8gR2V0IHRoZSByZW5kZXIgdXBkYXRlIGZ1bmN0aW9uLCBpbml0aWFsaXplIGV2ZW50IGhhbmRsZXJzLAogICAgLy8gYW5kIGNhbGN1bGF0ZSB0aGUgc2l6ZSBvZiB0aGUgc2Nyb2xsIGNvbnRhaW5lcgogICAgdGhpcy5fX2NhbGxiYWNrID0gdGhpcy5nZXRSZW5kZXJGbigpOwogICAgdGhpcy5fX2luaXRFdmVudEhhbmRsZXJzKCk7CiAgICB0aGlzLl9fY3JlYXRlU2Nyb2xsYmFycygpOwoKICB9LAoKICBydW46IGZ1bmN0aW9uKCkgewogICAgdGhpcy5yZXNpemUoKTsKCiAgICAvLyBGYWRlIHRoZW0gb3V0CiAgICB0aGlzLl9fZmFkZVNjcm9sbGJhcnMoJ291dCcsIHRoaXMub3B0aW9ucy5zY3JvbGxiYXJSZXNpemVGYWRlRGVsYXkpOwogIH0sCgoKCiAgLyoKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIElOVEVSTkFMIEZJRUxEUyA6OiBTVEFUVVMKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqLwoKICAvKiogV2hldGhlciBvbmx5IGEgc2luZ2xlIGZpbmdlciBpcyB1c2VkIGluIHRvdWNoIGhhbmRsaW5nICovCiAgX19pc1NpbmdsZVRvdWNoOiBmYWxzZSwKCiAgLyoqIFdoZXRoZXIgYSB0b3VjaCBldmVudCBzZXF1ZW5jZSBpcyBpbiBwcm9ncmVzcyAqLwogIF9faXNUcmFja2luZzogZmFsc2UsCgogIC8qKiBXaGV0aGVyIGEgZGVjZWxlcmF0aW9uIGFuaW1hdGlvbiB3ZW50IHRvIGNvbXBsZXRpb24uICovCiAgX19kaWREZWNlbGVyYXRpb25Db21wbGV0ZTogZmFsc2UsCgogIC8qKgogICAqIFdoZXRoZXIgYSBnZXN0dXJlIHpvb20vcm90YXRlIGV2ZW50IGlzIGluIHByb2dyZXNzLiBBY3RpdmF0ZXMgd2hlbgogICAqIGEgZ2VzdHVyZXN0YXJ0IGV2ZW50IGhhcHBlbnMuIFRoaXMgaGFzIGhpZ2hlciBwcmlvcml0eSB0aGFuIGRyYWdnaW5nLgogICAqLwogIF9faXNHZXN0dXJpbmc6IGZhbHNlLAoKICAvKioKICAgKiBXaGV0aGVyIHRoZSB1c2VyIGhhcyBtb3ZlZCBieSBzdWNoIGEgZGlzdGFuY2UgdGhhdCB3ZSBoYXZlIGVuYWJsZWQKICAgKiBkcmFnZ2luZyBtb2RlLiBIaW50OiBJdCdzIG9ubHkgZW5hYmxlZCBhZnRlciBzb21lIHBpeGVscyBvZiBtb3ZlbWVudCB0bwogICAqIG5vdCBpbnRlcnJ1cHQgd2l0aCBjbGlja3MgZXRjLgogICAqLwogIF9faXNEcmFnZ2luZzogZmFsc2UsCgogIC8qKgogICAqIE5vdCB0b3VjaGluZyBhbmQgZHJhZ2dpbmcgYW55bW9yZSwgYW5kIHNtb290aGx5IGFuaW1hdGluZyB0aGUKICAgKiB0b3VjaCBzZXF1ZW5jZSB1c2luZyBkZWNlbGVyYXRpb24uCiAgICovCiAgX19pc0RlY2VsZXJhdGluZzogZmFsc2UsCgogIC8qKgogICAqIFNtb290aGx5IGFuaW1hdGluZyB0aGUgY3VycmVudGx5IGNvbmZpZ3VyZWQgY2hhbmdlCiAgICovCiAgX19pc0FuaW1hdGluZzogZmFsc2UsCgoKCiAgLyoKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIElOVEVSTkFMIEZJRUxEUyA6OiBESU1FTlNJT05TCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKi8KCiAgLyoqIEF2YWlsYWJsZSBvdXRlciBsZWZ0IHBvc2l0aW9uIChmcm9tIGRvY3VtZW50IHBlcnNwZWN0aXZlKSAqLwogIF9fY2xpZW50TGVmdDogMCwKCiAgLyoqIEF2YWlsYWJsZSBvdXRlciB0b3AgcG9zaXRpb24gKGZyb20gZG9jdW1lbnQgcGVyc3BlY3RpdmUpICovCiAgX19jbGllbnRUb3A6IDAsCgogIC8qKiBBdmFpbGFibGUgb3V0ZXIgd2lkdGggKi8KICBfX2NsaWVudFdpZHRoOiAwLAoKICAvKiogQXZhaWxhYmxlIG91dGVyIGhlaWdodCAqLwogIF9fY2xpZW50SGVpZ2h0OiAwLAoKICAvKiogT3V0ZXIgd2lkdGggb2YgY29udGVudCAqLwogIF9fY29udGVudFdpZHRoOiAwLAoKICAvKiogT3V0ZXIgaGVpZ2h0IG9mIGNvbnRlbnQgKi8KICBfX2NvbnRlbnRIZWlnaHQ6IDAsCgogIC8qKiBTbmFwcGluZyB3aWR0aCBmb3IgY29udGVudCAqLwogIF9fc25hcFdpZHRoOiAxMDAsCgogIC8qKiBTbmFwcGluZyBoZWlnaHQgZm9yIGNvbnRlbnQgKi8KICBfX3NuYXBIZWlnaHQ6IDEwMCwKCiAgLyoqIEhlaWdodCB0byBhc3NpZ24gdG8gcmVmcmVzaCBhcmVhICovCiAgX19yZWZyZXNoSGVpZ2h0OiBudWxsLAoKICAvKiogV2hldGhlciB0aGUgcmVmcmVzaCBwcm9jZXNzIGlzIGVuYWJsZWQgd2hlbiB0aGUgZXZlbnQgaXMgcmVsZWFzZWQgbm93ICovCiAgX19yZWZyZXNoQWN0aXZlOiBmYWxzZSwKCiAgLyoqIENhbGxiYWNrIHRvIGV4ZWN1dGUgb24gYWN0aXZhdGlvbi4gVGhpcyBpcyBmb3Igc2lnbmFsbGluZyB0aGUgdXNlciBhYm91dCBhIHJlZnJlc2ggaXMgYWJvdXQgdG8gaGFwcGVuIHdoZW4gaGUgcmVsZWFzZSAqLwogIF9fcmVmcmVzaEFjdGl2YXRlOiBudWxsLAoKICAvKiogQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbiBkZWFjdGl2YXRpb24uIFRoaXMgaXMgZm9yIHNpZ25hbGxpbmcgdGhlIHVzZXIgYWJvdXQgdGhlIHJlZnJlc2ggYmVpbmcgY2FuY2VsbGVkICovCiAgX19yZWZyZXNoRGVhY3RpdmF0ZTogbnVsbCwKCiAgLyoqIENhbGxiYWNrIHRvIGV4ZWN1dGUgdG8gc3RhcnQgdGhlIGFjdHVhbCByZWZyZXNoLiBDYWxsIHtAbGluayAjcmVmcmVzaEZpbmlzaH0gd2hlbiBkb25lICovCiAgX19yZWZyZXNoU3RhcnQ6IG51bGwsCgogIC8qKiBab29tIGxldmVsICovCiAgX196b29tTGV2ZWw6IDEsCgogIC8qKiBTY3JvbGwgcG9zaXRpb24gb24geC1heGlzICovCiAgX19zY3JvbGxMZWZ0OiAwLAoKICAvKiogU2Nyb2xsIHBvc2l0aW9uIG9uIHktYXhpcyAqLwogIF9fc2Nyb2xsVG9wOiAwLAoKICAvKiogTWF4aW11bSBhbGxvd2VkIHNjcm9sbCBwb3NpdGlvbiBvbiB4LWF4aXMgKi8KICBfX21heFNjcm9sbExlZnQ6IDAsCgogIC8qKiBNYXhpbXVtIGFsbG93ZWQgc2Nyb2xsIHBvc2l0aW9uIG9uIHktYXhpcyAqLwogIF9fbWF4U2Nyb2xsVG9wOiAwLAoKICAvKiBTY2hlZHVsZWQgbGVmdCBwb3NpdGlvbiAoZmluYWwgcG9zaXRpb24gd2hlbiBhbmltYXRpbmcpICovCiAgX19zY2hlZHVsZWRMZWZ0OiAwLAoKICAvKiBTY2hlZHVsZWQgdG9wIHBvc2l0aW9uIChmaW5hbCBwb3NpdGlvbiB3aGVuIGFuaW1hdGluZykgKi8KICBfX3NjaGVkdWxlZFRvcDogMCwKCiAgLyogU2NoZWR1bGVkIHpvb20gbGV2ZWwgKGZpbmFsIHNjYWxlIHdoZW4gYW5pbWF0aW5nKSAqLwogIF9fc2NoZWR1bGVkWm9vbTogMCwKCgoKICAvKgogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgSU5URVJOQUwgRklFTERTIDo6IExBU1QgUE9TSVRJT05TCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKi8KCiAgLyoqIExlZnQgcG9zaXRpb24gb2YgZmluZ2VyIGF0IHN0YXJ0ICovCiAgX19sYXN0VG91Y2hMZWZ0OiBudWxsLAoKICAvKiogVG9wIHBvc2l0aW9uIG9mIGZpbmdlciBhdCBzdGFydCAqLwogIF9fbGFzdFRvdWNoVG9wOiBudWxsLAoKICAvKiogVGltZXN0YW1wIG9mIGxhc3QgbW92ZSBvZiBmaW5nZXIuIFVzZWQgdG8gbGltaXQgdHJhY2tpbmcgcmFuZ2UgZm9yIGRlY2VsZXJhdGlvbiBzcGVlZC4gKi8KICBfX2xhc3RUb3VjaE1vdmU6IG51bGwsCgogIC8qKiBMaXN0IG9mIHBvc2l0aW9ucywgdXNlcyB0aHJlZSBpbmRleGVzIGZvciBlYWNoIHN0YXRlOiBsZWZ0LCB0b3AsIHRpbWVzdGFtcCAqLwogIF9fcG9zaXRpb25zOiBudWxsLAoKCgogIC8qCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBJTlRFUk5BTCBGSUVMRFMgOjogREVDRUxFUkFUSU9OIFNVUFBPUlQKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqLwoKICAvKiogTWluaW11bSBsZWZ0IHNjcm9sbCBwb3NpdGlvbiBkdXJpbmcgZGVjZWxlcmF0aW9uICovCiAgX19taW5EZWNlbGVyYXRpb25TY3JvbGxMZWZ0OiBudWxsLAoKICAvKiogTWluaW11bSB0b3Agc2Nyb2xsIHBvc2l0aW9uIGR1cmluZyBkZWNlbGVyYXRpb24gKi8KICBfX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcDogbnVsbCwKCiAgLyoqIE1heGltdW0gbGVmdCBzY3JvbGwgcG9zaXRpb24gZHVyaW5nIGRlY2VsZXJhdGlvbiAqLwogIF9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsTGVmdDogbnVsbCwKCiAgLyoqIE1heGltdW0gdG9wIHNjcm9sbCBwb3NpdGlvbiBkdXJpbmcgZGVjZWxlcmF0aW9uICovCiAgX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3A6IG51bGwsCgogIC8qKiBDdXJyZW50IGZhY3RvciB0byBtb2RpZnkgaG9yaXpvbnRhbCBzY3JvbGwgcG9zaXRpb24gd2l0aCBvbiBldmVyeSBzdGVwICovCiAgX19kZWNlbGVyYXRpb25WZWxvY2l0eVg6IG51bGwsCgogIC8qKiBDdXJyZW50IGZhY3RvciB0byBtb2RpZnkgdmVydGljYWwgc2Nyb2xsIHBvc2l0aW9uIHdpdGggb24gZXZlcnkgc3RlcCAqLwogIF9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZOiBudWxsLAoKCiAgLyoqIHRoZSBicm93c2VyLXNwZWNpZmljIHByb3BlcnR5IHRvIHVzZSBmb3IgdHJhbnNmb3JtcyAqLwogIF9fdHJhbnNmb3JtUHJvcGVydHk6IG51bGwsCiAgX19wZXJzcGVjdGl2ZVByb3BlcnR5OiBudWxsLAoKICAvKiogc2Nyb2xsYmFyIGluZGljYXRvcnMgKi8KICBfX2luZGljYXRvclg6IG51bGwsCiAgX19pbmRpY2F0b3JZOiBudWxsLAoKICAvKiogVGltZW91dCBmb3Igc2Nyb2xsYmFyIGZhZGluZyAqLwogIF9fc2Nyb2xsYmFyRmFkZVRpbWVvdXQ6IG51bGwsCgogIC8qKiB3aGV0aGVyIHdlJ3ZlIHRyaWVkIHRvIHdhaXQgZm9yIHNpemUgYWxyZWFkeSAqLwogIF9fZGlkV2FpdEZvclNpemU6IG51bGwsCiAgX19zaXplclRpbWVvdXQ6IG51bGwsCgogIF9faW5pdEV2ZW50SGFuZGxlcnM6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIEV2ZW50IEhhbmRsZXIKICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9fY29udGFpbmVyOwoKICAgIHNlbGYuc2Nyb2xsQ2hpbGRJbnRvVmlldyA9IGZ1bmN0aW9uKGUpIHsKCiAgICAgIC8vZGlzdGFuY2UgZnJvbSBib3R0b20gb2Ygc2Nyb2xsdmlldyB0byB0b3Agb2Ygdmlld3BvcnQKICAgICAgdmFyIHNjcm9sbEJvdHRvbU9mZnNldFRvVG9wOwoKICAgICAgaWYoICFzZWxmLmlzU2Nyb2xsZWRJbnRvVmlldyApIHsKICAgICAgICAvLyBzaHJpbmsgc2Nyb2xsdmlldyBzbyB3ZSBjYW4gYWN0dWFsbHkgc2Nyb2xsIGlmIHRoZSBpbnB1dCBpcyBoaWRkZW4KICAgICAgICAvLyBpZiBpdCBpc24ndCBzaHJpbmsgc28gd2UgY2FuIHNjcm9sbCB0byBpbnB1dHMgdW5kZXIgdGhlIGtleWJvYXJkCiAgICAgICAgaWYgKGlvbmljLlBsYXRmb3JtLmlzSU9TKCkgfHwgaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuKXsKICAgICAgICAgIC8vIGlmIHRoZXJlIGFyZSB0aGluZ3MgYmVsb3cgdGhlIHNjcm9sbCB2aWV3IGFjY291bnQgZm9yIHRoZW0gYW5kCiAgICAgICAgICAvLyBzdWJ0cmFjdCB0aGVtIGZyb20gdGhlIGtleWJvYXJkIGhlaWdodCB3aGVuIHJlc2l6aW5nCiAgICAgICAgICBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcCA9IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207CiAgICAgICAgICB2YXIgc2Nyb2xsQm90dG9tT2Zmc2V0VG9Cb3R0b20gPSBlLmRldGFpbC52aWV3cG9ydEhlaWdodCAtIHNjcm9sbEJvdHRvbU9mZnNldFRvVG9wOwogICAgICAgICAgdmFyIGtleWJvYXJkT2Zmc2V0ID0gTWF0aC5tYXgoMCwgZS5kZXRhaWwua2V5Ym9hcmRIZWlnaHQgLSBzY3JvbGxCb3R0b21PZmZzZXRUb0JvdHRvbSk7CiAgICAgICAgICBjb250YWluZXIuc3R5bGUuaGVpZ2h0ID0gKGNvbnRhaW5lci5jbGllbnRIZWlnaHQgLSBrZXlib2FyZE9mZnNldCkgKyAicHgiOwogICAgICAgICAgY29udGFpbmVyLnN0eWxlLm92ZXJmbG93ID0gInZpc2libGUiOwogICAgICAgICAgLy91cGRhdGUgc2Nyb2xsIHZpZXcKICAgICAgICAgIHNlbGYucmVzaXplKCk7CiAgICAgICAgfQogICAgICAgIHNlbGYuaXNTY3JvbGxlZEludG9WaWV3ID0gdHJ1ZTsKICAgICAgfQoKICAgICAgLy9JZiB0aGUgZWxlbWVudCBpcyBwb3NpdGlvbmVkIHVuZGVyIHRoZSBrZXlib2FyZC4uLgogICAgICBpZiggZS5kZXRhaWwuaXNFbGVtZW50VW5kZXJLZXlib2FyZCApIHsKICAgICAgICB2YXIgZGVsYXk7CiAgICAgICAgLy8gV2FpdCBvbiBhbmRyb2lkIGZvciB3ZWIgdmlldyB0byByZXNpemUKICAgICAgICBpZiAoIGlvbmljLlBsYXRmb3JtLmlzQW5kcm9pZCgpICYmICFpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4gKSB7CiAgICAgICAgICAvLyBhbmRyb2lkIHkgdSByZXNpemUgc28gc2xvdwogICAgICAgICAgaWYgKCBpb25pYy5QbGF0Zm9ybS52ZXJzaW9uKCkgPCA0LjQpIHsKICAgICAgICAgICAgZGVsYXkgPSA1MDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBwcm9iYWJseSBvdmVya2lsbCBmb3IgY2hyb21lCiAgICAgICAgICAgIGRlbGF5ID0gMzUwOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWxheSA9IDgwOwogICAgICAgIH0KCiAgICAgICAgLy9QdXQgZWxlbWVudCBpbiBtaWRkbGUgb2YgdmlzaWJsZSBzY3JlZW4KICAgICAgICAvL1dhaXQgZm9yIGFuZHJvaWQgdG8gdXBkYXRlIHZpZXcgaGVpZ2h0IGFuZCByZXNpemUoKSB0byByZXNldCBzY3JvbGwgcG9zaXRpb24KICAgICAgICBpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgPSB0cnVlOwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgIC8vbWlkZGxlIG9mIHRoZSBzY3JvbGx2aWV3LCB3aGVyZSB3ZSB3YW50IHRvIHNjcm9sbCB0bwogICAgICAgICAgdmFyIHNjcm9sbE1pZHBvaW50T2Zmc2V0ID0gY29udGFpbmVyLmNsaWVudEhlaWdodCAqIDAuNTsKCiAgICAgICAgICBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcCA9IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207CiAgICAgICAgICAvL2Rpc3RhbmNlIGZyb20gdG9wIG9mIGZvY3VzZWQgZWxlbWVudCB0byB0aGUgYm90dG9tIG9mIHRoZSBzY3JvbGwgdmlldwogICAgICAgICAgdmFyIGVsZW1lbnRUb3BPZmZzZXRUb1Njcm9sbEJvdHRvbSA9IGUuZGV0YWlsLmVsZW1lbnRUb3AgLSBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcDsKCiAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gZWxlbWVudFRvcE9mZnNldFRvU2Nyb2xsQm90dG9tICArIHNjcm9sbE1pZHBvaW50T2Zmc2V0OwoKICAgICAgICAgIGlmIChzY3JvbGxUb3AgPiAwKXsKICAgICAgICAgICAgaW9uaWMudGFwLmNsb25lRm9jdXNlZElucHV0KGNvbnRhaW5lciwgc2VsZik7CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsQnkoMCwgc2Nyb2xsVG9wLCB0cnVlKTsKICAgICAgICAgICAgc2VsZi5vblNjcm9sbCgpOwogICAgICAgICAgfQogICAgICAgIH0sIGRlbGF5KTsKICAgICAgfQoKICAgICAgLy9Pbmx5IHRoZSBmaXJzdCBzY3JvbGxWaWV3IHBhcmVudCBvZiB0aGUgZWxlbWVudCB0aGF0IGJyb2FkY2FzdGVkIHRoaXMgZXZlbnQKICAgICAgLy8odGhlIGFjdGl2ZSBlbGVtZW50IHRoYXQgbmVlZHMgdG8gYmUgc2hvd24pIHNob3VsZCByZWNlaXZlIHRoaXMgZXZlbnQKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH07CgogICAgc2VsZi5yZXNldFNjcm9sbFZpZXcgPSBmdW5jdGlvbihlKSB7CiAgICAgIC8vcmV0dXJuIHNjcm9sbHZpZXcgdG8gb3JpZ2luYWwgaGVpZ2h0IG9uY2Uga2V5Ym9hcmQgaGFzIGhpZGRlbgogICAgICBzZWxmLmlzU2Nyb2xsZWRJbnRvVmlldyA9IGZhbHNlOwogICAgICBjb250YWluZXIuc3R5bGUuaGVpZ2h0ID0gIiI7CiAgICAgIGNvbnRhaW5lci5zdHlsZS5vdmVyZmxvdyA9ICIiOwogICAgICBzZWxmLnJlc2l6ZSgpOwogICAgICBpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgPSBmYWxzZTsKICAgIH07CgogICAgLy9Ccm9hZGNhc3RlZCB3aGVuIGtleWJvYXJkIGlzIHNob3duIG9uIHNvbWUgcGxhdGZvcm1zLgogICAgLy9TZWUganMvdXRpbHMva2V5Ym9hcmQuanMKICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGxDaGlsZEludG9WaWV3Jywgc2VsZi5zY3JvbGxDaGlsZEludG9WaWV3KTsKICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdyZXNldFNjcm9sbFZpZXcnLCBzZWxmLnJlc2V0U2Nyb2xsVmlldyk7CgogICAgZnVuY3Rpb24gZ2V0RXZlbnRUb3VjaGVzKGUpIHsKICAgICAgcmV0dXJuIGUudG91Y2hlcyAmJiBlLnRvdWNoZXMubGVuZ3RoID8gZS50b3VjaGVzIDogW3sKICAgICAgICBwYWdlWDogZS5wYWdlWCwKICAgICAgICBwYWdlWTogZS5wYWdlWQogICAgICB9XTsKICAgIH0KCiAgICBzZWxmLnRvdWNoU3RhcnQgPSBmdW5jdGlvbihlKSB7CiAgICAgIHNlbGYuc3RhcnRDb29yZGluYXRlcyA9IGlvbmljLnRhcC5wb2ludGVyQ29vcmQoZSk7CgogICAgICBpZiAoIGlvbmljLnRhcC5pZ25vcmVTY3JvbGxTdGFydChlKSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHNlbGYuX19pc0Rvd24gPSB0cnVlOwoKICAgICAgaWYoIGlvbmljLnRhcC5jb250YWluc09ySXNUZXh0SW5wdXQoZS50YXJnZXQpIHx8IGUudGFyZ2V0LnRhZ05hbWUgPT09ICdTRUxFQ1QnICkgewogICAgICAgIC8vIGRvIG5vdCBzdGFydCBpZiB0aGUgdGFyZ2V0IGlzIGEgdGV4dCBpbnB1dAogICAgICAgIC8vIGlmIHRoZXJlIGlzIGEgdG91Y2htb3ZlIG9uIHRoaXMgaW5wdXQsIHRoZW4gd2UgY2FuIHN0YXJ0IHRoZSBzY3JvbGwKICAgICAgICBzZWxmLl9faGFzU3RhcnRlZCA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgc2VsZi5fX2lzU2VsZWN0YWJsZSA9IHRydWU7CiAgICAgIHNlbGYuX19lbmFibGVTY3JvbGxZID0gdHJ1ZTsKICAgICAgc2VsZi5fX2hhc1N0YXJ0ZWQgPSB0cnVlOwogICAgICBzZWxmLmRvVG91Y2hTdGFydChnZXRFdmVudFRvdWNoZXMoZSksIGUudGltZVN0YW1wKTsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgfTsKCiAgICBzZWxmLnRvdWNoTW92ZSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYoIXNlbGYuX19pc0Rvd24gfHwKICAgICAgICBlLmRlZmF1bHRQcmV2ZW50ZWQgfHwKICAgICAgICAoZS50YXJnZXQudGFnTmFtZSA9PT0gJ1RFWFRBUkVBJyAmJiBlLnRhcmdldC5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJzpmb2N1cycpKSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmKCAhc2VsZi5fX2hhc1N0YXJ0ZWQgJiYgKCBpb25pYy50YXAuY29udGFpbnNPcklzVGV4dElucHV0KGUudGFyZ2V0KSB8fCBlLnRhcmdldC50YWdOYW1lID09PSAnU0VMRUNUJyApICkgewogICAgICAgIC8vIHRoZSB0YXJnZXQgaXMgYSB0ZXh0IGlucHV0IGFuZCBzY3JvbGwgaGFzIHN0YXJ0ZWQKICAgICAgICAvLyBzaW5jZSB0aGUgdGV4dCBpbnB1dCBkb2Vzbid0IHN0YXJ0IG9uIHRvdWNoU3RhcnQsIGRvIGl0IGhlcmUKICAgICAgICBzZWxmLl9faGFzU3RhcnRlZCA9IHRydWU7CiAgICAgICAgc2VsZi5kb1RvdWNoU3RhcnQoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCk7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYoc2VsZi5zdGFydENvb3JkaW5hdGVzKSB7CiAgICAgICAgLy8gd2UgaGF2ZSBzdGFydCBjb29yZGluYXRlcywgc28gZ2V0IHRoaXMgdG91Y2ggbW92ZSdzIGN1cnJlbnQgY29vcmRpbmF0ZXMKICAgICAgICB2YXIgY3VycmVudENvb3JkaW5hdGVzID0gaW9uaWMudGFwLnBvaW50ZXJDb29yZChlKTsKCiAgICAgICAgaWYoIHNlbGYuX19pc1NlbGVjdGFibGUgJiYKICAgICAgICAgICAgaW9uaWMudGFwLmlzVGV4dElucHV0KGUudGFyZ2V0KSAmJgogICAgICAgICAgICBNYXRoLmFicyhzZWxmLnN0YXJ0Q29vcmRpbmF0ZXMueCAtIGN1cnJlbnRDb29yZGluYXRlcy54KSA+IDIwICkgewogICAgICAgICAgLy8gdXNlciBzbGlkIHRoZSB0ZXh0IGlucHV0J3MgY2FyZXQgb24gaXRzIHggYXhpcywgZGlzYWJsZSBhbnkgZnV0dXJlIHkgc2Nyb2xsaW5nCiAgICAgICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWSA9IGZhbHNlOwogICAgICAgICAgc2VsZi5fX2lzU2VsZWN0YWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiggc2VsZi5fX2VuYWJsZVNjcm9sbFkgJiYgTWF0aC5hYnMoc2VsZi5zdGFydENvb3JkaW5hdGVzLnkgLSBjdXJyZW50Q29vcmRpbmF0ZXMueSkgPiAxMCApIHsKICAgICAgICAgIC8vIHVzZXIgc2Nyb2xsZWQgdGhlIGVudGlyZSB2aWV3IG9uIHRoZSB5IGF4aXMKICAgICAgICAgIC8vIGRpc2FibGVkIGJlaW5nIGFibGUgdG8gc2VsZWN0IHRleHQgb24gYW4gaW5wdXQKICAgICAgICAgIC8vIGhpZGUgdGhlIGlucHV0IHdoaWNoIGhhcyBmb2N1cywgYW5kIHNob3cgYSBjbG9uZWQgb25lIHRoYXQgZG9lc24ndCBoYXZlIGZvY3VzCiAgICAgICAgICBzZWxmLl9faXNTZWxlY3RhYmxlID0gZmFsc2U7CiAgICAgICAgICBpb25pYy50YXAuY2xvbmVGb2N1c2VkSW5wdXQoY29udGFpbmVyLCBzZWxmKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNlbGYuZG9Ub3VjaE1vdmUoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCwgZS5zY2FsZSk7CiAgICAgIHNlbGYuX19pc0Rvd24gPSB0cnVlOwogICAgfTsKCiAgICBzZWxmLnRvdWNoRW5kID0gZnVuY3Rpb24oZSkgewogICAgICBpZighc2VsZi5fX2lzRG93bikgcmV0dXJuOwoKICAgICAgc2VsZi5kb1RvdWNoRW5kKGUudGltZVN0YW1wKTsKICAgICAgc2VsZi5fX2lzRG93biA9IGZhbHNlOwogICAgICBzZWxmLl9faGFzU3RhcnRlZCA9IGZhbHNlOwogICAgICBzZWxmLl9faXNTZWxlY3RhYmxlID0gdHJ1ZTsKICAgICAgc2VsZi5fX2VuYWJsZVNjcm9sbFkgPSB0cnVlOwoKICAgICAgaWYoICFzZWxmLl9faXNEcmFnZ2luZyAmJiAhc2VsZi5fX2lzRGVjZWxlcmF0aW5nICYmICFzZWxmLl9faXNBbmltYXRpbmcgKSB7CiAgICAgICAgaW9uaWMudGFwLnJlbW92ZUNsb25lZElucHV0cyhjb250YWluZXIsIHNlbGYpOwogICAgICB9CiAgICB9OwoKICAgIGlmICgnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cpIHsKICAgICAgLy8gVG91Y2ggRXZlbnRzCiAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaHN0YXJ0Iiwgc2VsZi50b3VjaFN0YXJ0LCBmYWxzZSk7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInRvdWNobW92ZSIsIHNlbGYudG91Y2hNb3ZlLCBmYWxzZSk7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInRvdWNoZW5kIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaGNhbmNlbCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKCiAgICB9IGVsc2UgaWYgKHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQpIHsKICAgICAgLy8gUG9pbnRlciBFdmVudHMKICAgICAgY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgc2VsZi50b3VjaFN0YXJ0LCBmYWxzZSk7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJtb3ZlIiwgc2VsZi50b3VjaE1vdmUsIGZhbHNlKTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyY2FuY2VsIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwoKICAgIH0gZWxzZSBpZiAod2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkKSB7CiAgICAgIC8vIElFMTAsIFdQOCAoUG9pbnRlciBFdmVudHMpCiAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJEb3duIiwgc2VsZi50b3VjaFN0YXJ0LCBmYWxzZSk7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlck1vdmUiLCBzZWxmLnRvdWNoTW92ZSwgZmFsc2UpOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJVcCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyQ2FuY2VsIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwoKICAgIH0gZWxzZSB7CiAgICAgIC8vIE1vdXNlIEV2ZW50cwogICAgICB2YXIgbW91c2Vkb3duID0gZmFsc2U7CgogICAgICBzZWxmLm1vdXNlRG93biA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAoIGlvbmljLnRhcC5pZ25vcmVTY3JvbGxTdGFydChlKSB8fCBlLnRhcmdldC50YWdOYW1lID09PSAnU0VMRUNUJyApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgc2VsZi5kb1RvdWNoU3RhcnQoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCk7CgogICAgICAgIGlmKCAhaW9uaWMudGFwLmlzVGV4dElucHV0KGUudGFyZ2V0KSApIHsKICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgbW91c2Vkb3duID0gdHJ1ZTsKICAgICAgfTsKCiAgICAgIHNlbGYubW91c2VNb3ZlID0gZnVuY3Rpb24oZSkgewogICAgICAgIGlmICghbW91c2Vkb3duIHx8IGUuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgc2VsZi5kb1RvdWNoTW92ZShnZXRFdmVudFRvdWNoZXMoZSksIGUudGltZVN0YW1wKTsKCiAgICAgICAgbW91c2Vkb3duID0gdHJ1ZTsKICAgICAgfTsKCiAgICAgIHNlbGYubW91c2VVcCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAoIW1vdXNlZG93bikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgc2VsZi5kb1RvdWNoRW5kKGUudGltZVN0YW1wKTsKCiAgICAgICAgbW91c2Vkb3duID0gZmFsc2U7CiAgICAgIH07CgogICAgICBzZWxmLm1vdXNlV2hlZWwgPSBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKGUpIHsKICAgICAgICB2YXIgc2Nyb2xsUGFyZW50ID0gaW9uaWMuRG9tVXRpbC5nZXRQYXJlbnRPclNlbGZXaXRoQ2xhc3MoZS50YXJnZXQsICdpb25pYy1zY3JvbGwnKTsKICAgICAgICBpZiAoc2Nyb2xsUGFyZW50ID09PSBzZWxmLl9fY29udGFpbmVyKSB7CgogICAgICAgICAgc2VsZi5oaW50UmVzaXplKCk7CiAgICAgICAgICBzZWxmLnNjcm9sbEJ5KAogICAgICAgICAgICBlLndoZWVsRGVsdGFYL3NlbGYub3B0aW9ucy53aGVlbERhbXBlbiwKICAgICAgICAgICAgLWUud2hlZWxEZWx0YVkvc2VsZi5vcHRpb25zLndoZWVsRGFtcGVuCiAgICAgICAgICApOwoKICAgICAgICAgIHNlbGYuX19mYWRlU2Nyb2xsYmFycygnaW4nKTsKICAgICAgICAgIGNsZWFyVGltZW91dChzZWxmLl9fd2hlZWxIaWRlQmFyVGltZW91dCk7CiAgICAgICAgICBzZWxmLl9fd2hlZWxIaWRlQmFyVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuX19mYWRlU2Nyb2xsYmFycygnb3V0Jyk7CiAgICAgICAgICB9LCAxMDApOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgc2VsZi5tb3VzZURvd24sIGZhbHNlKTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgc2VsZi5tb3VzZU1vdmUsIGZhbHNlKTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW91c2V1cCIsIHNlbGYubW91c2VVcCwgZmFsc2UpOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgc2VsZi5tb3VzZVdoZWVsLCBmYWxzZSk7CiAgICB9CiAgfSwKCiAgX19jbGVhbnVwOiBmdW5jdGlvbigpIHsKICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9fY29udGFpbmVyOwogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywgc2VsZi50b3VjaFN0YXJ0KTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHNlbGYudG91Y2hNb3ZlKTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgc2VsZi50b3VjaEVuZCk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHNlbGYudG91Y2hDYW5jZWwpOwoKICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHNlbGYudG91Y2hTdGFydCk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJwb2ludGVybW92ZSIsIHNlbGYudG91Y2hNb3ZlKTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIHNlbGYudG91Y2hFbmQpOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigicG9pbnRlcmNhbmNlbCIsIHNlbGYudG91Y2hFbmQpOwoKICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJEb3duIiwgc2VsZi50b3VjaFN0YXJ0KTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlck1vdmUiLCBzZWxmLnRvdWNoTW92ZSk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJVcCIsIHNlbGYudG91Y2hFbmQpOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyQ2FuY2VsIiwgc2VsZi50b3VjaEVuZCk7CgogICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIHNlbGYubW91c2VEb3duKTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHNlbGYubW91c2VNb3ZlKTsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBzZWxmLm1vdXNlVXApOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIHNlbGYubW91c2VXaGVlbCk7CgogICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbENoaWxkSW50b1ZpZXcnLCBzZWxmLnNjcm9sbENoaWxkSW50b1ZpZXcpOwogICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2V0U2Nyb2xsVmlldycsIHNlbGYucmVzZXRTY3JvbGxWaWV3KTsKCiAgICBpb25pYy50YXAucmVtb3ZlQ2xvbmVkSW5wdXRzKGNvbnRhaW5lciwgc2VsZik7CgogICAgZGVsZXRlIHRoaXMuX19jb250YWluZXI7CiAgICBkZWxldGUgdGhpcy5fX2NvbnRlbnQ7CiAgICBkZWxldGUgdGhpcy5fX2luZGljYXRvclg7CiAgICBkZWxldGUgdGhpcy5fX2luZGljYXRvclk7CiAgICBkZWxldGUgdGhpcy5vcHRpb25zLmVsOwoKICAgIHRoaXMuX19jYWxsYmFjayA9IHRoaXMuc2Nyb2xsQ2hpbGRJbnRvVmlldyA9IHRoaXMucmVzZXRTY3JvbGxWaWV3ID0gYW5ndWxhci5ub29wOwoKICAgIHRoaXMubW91c2VNb3ZlID0gdGhpcy5tb3VzZURvd24gPSB0aGlzLm1vdXNlVXAgPSB0aGlzLm1vdXNlV2hlZWwgPQogICAgICB0aGlzLnRvdWNoU3RhcnQgPSB0aGlzLnRvdWNoTW92ZSA9IHRoaXMudG91Y2hFbmQgPSB0aGlzLnRvdWNoQ2FuY2VsID0gYW5ndWxhci5ub29wOwoKICAgIHRoaXMucmVzaXplID0gdGhpcy5zY3JvbGxUbyA9IHRoaXMuem9vbVRvID0KICAgICAgdGhpcy5fX3Njcm9sbGluZ0NvbXBsZXRlID0gYW5ndWxhci5ub29wOwogICAgY29udGFpbmVyID0gbnVsbDsKICB9LAoKICAvKiogQ3JlYXRlIGEgc2Nyb2xsIGJhciBkaXYgd2l0aCB0aGUgZ2l2ZW4gZGlyZWN0aW9uICoqLwogIF9fY3JlYXRlU2Nyb2xsYmFyOiBmdW5jdGlvbihkaXJlY3Rpb24pIHsKICAgIHZhciBiYXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgICAgaW5kaWNhdG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgogICAgaW5kaWNhdG9yLmNsYXNzTmFtZSA9ICdzY3JvbGwtYmFyLWluZGljYXRvcic7CgogICAgaWYoZGlyZWN0aW9uID09ICdoJykgewogICAgICBiYXIuY2xhc3NOYW1lID0gJ3Njcm9sbC1iYXIgc2Nyb2xsLWJhci1oJzsKICAgIH0gZWxzZSB7CiAgICAgIGJhci5jbGFzc05hbWUgPSAnc2Nyb2xsLWJhciBzY3JvbGwtYmFyLXYnOwogICAgfQoKICAgIGJhci5hcHBlbmRDaGlsZChpbmRpY2F0b3IpOwogICAgcmV0dXJuIGJhcjsKICB9LAoKICBfX2NyZWF0ZVNjcm9sbGJhcnM6IGZ1bmN0aW9uKCkgewogICAgdmFyIGluZGljYXRvclgsIGluZGljYXRvclk7CgogICAgaWYodGhpcy5vcHRpb25zLnNjcm9sbGluZ1gpIHsKICAgICAgaW5kaWNhdG9yWCA9IHsKICAgICAgICBlbDogdGhpcy5fX2NyZWF0ZVNjcm9sbGJhcignaCcpLAogICAgICAgIHNpemVSYXRpbzogMQogICAgICB9OwogICAgICBpbmRpY2F0b3JYLmluZGljYXRvciA9IGluZGljYXRvclguZWwuY2hpbGRyZW5bMF07CgogICAgICBpZih0aGlzLm9wdGlvbnMuc2Nyb2xsYmFyWCkgewogICAgICAgIHRoaXMuX19jb250YWluZXIuYXBwZW5kQ2hpbGQoaW5kaWNhdG9yWC5lbCk7CiAgICAgIH0KICAgICAgdGhpcy5fX2luZGljYXRvclggPSBpbmRpY2F0b3JYOwogICAgfQoKICAgIGlmKHRoaXMub3B0aW9ucy5zY3JvbGxpbmdZKSB7CiAgICAgIGluZGljYXRvclkgPSB7CiAgICAgICAgZWw6IHRoaXMuX19jcmVhdGVTY3JvbGxiYXIoJ3YnKSwKICAgICAgICBzaXplUmF0aW86IDEKICAgICAgfTsKICAgICAgaW5kaWNhdG9yWS5pbmRpY2F0b3IgPSBpbmRpY2F0b3JZLmVsLmNoaWxkcmVuWzBdOwoKICAgICAgaWYodGhpcy5vcHRpb25zLnNjcm9sbGJhclkpIHsKICAgICAgICB0aGlzLl9fY29udGFpbmVyLmFwcGVuZENoaWxkKGluZGljYXRvclkuZWwpOwogICAgICB9CiAgICAgIHRoaXMuX19pbmRpY2F0b3JZID0gaW5kaWNhdG9yWTsKICAgIH0KICB9LAoKICBfX3Jlc2l6ZVNjcm9sbGJhcnM6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIFVwZGF0ZSBob3JpeiBiYXIKICAgIGlmKHNlbGYuX19pbmRpY2F0b3JYKSB7CiAgICAgIHZhciB3aWR0aCA9IE1hdGgubWF4KE1hdGgucm91bmQoc2VsZi5fX2NsaWVudFdpZHRoICogc2VsZi5fX2NsaWVudFdpZHRoIC8gKHNlbGYuX19jb250ZW50V2lkdGgpKSwgMjApOwogICAgICBpZih3aWR0aCA+IHNlbGYuX19jb250ZW50V2lkdGgpIHsKICAgICAgICB3aWR0aCA9IDA7CiAgICAgIH0KICAgICAgc2VsZi5fX2luZGljYXRvclguc2l6ZSA9IHdpZHRoOwogICAgICBzZWxmLl9faW5kaWNhdG9yWC5taW5TY2FsZSA9IHRoaXMub3B0aW9ucy5taW5TY3JvbGxiYXJTaXplWCAvIHdpZHRoOwogICAgICBzZWxmLl9faW5kaWNhdG9yWC5pbmRpY2F0b3Iuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgIHNlbGYuX19pbmRpY2F0b3JYLm1heFBvcyA9IHNlbGYuX19jbGllbnRXaWR0aCAtIHdpZHRoOwogICAgICBzZWxmLl9faW5kaWNhdG9yWC5zaXplUmF0aW8gPSBzZWxmLl9fbWF4U2Nyb2xsTGVmdCA/IHNlbGYuX19pbmRpY2F0b3JYLm1heFBvcyAvIHNlbGYuX19tYXhTY3JvbGxMZWZ0IDogMTsKICAgIH0KCiAgICAvLyBVcGRhdGUgdmVydCBiYXIKICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB7CiAgICAgIHZhciBoZWlnaHQgPSBNYXRoLm1heChNYXRoLnJvdW5kKHNlbGYuX19jbGllbnRIZWlnaHQgKiBzZWxmLl9fY2xpZW50SGVpZ2h0IC8gKHNlbGYuX19jb250ZW50SGVpZ2h0KSksIDIwKTsKICAgICAgaWYoaGVpZ2h0ID4gc2VsZi5fX2NvbnRlbnRIZWlnaHQpIHsKICAgICAgICBoZWlnaHQgPSAwOwogICAgICB9CiAgICAgIHNlbGYuX19pbmRpY2F0b3JZLnNpemUgPSBoZWlnaHQ7CiAgICAgIHNlbGYuX19pbmRpY2F0b3JZLm1pblNjYWxlID0gdGhpcy5vcHRpb25zLm1pblNjcm9sbGJhclNpemVZIC8gaGVpZ2h0OwogICAgICBzZWxmLl9faW5kaWNhdG9yWS5tYXhQb3MgPSBzZWxmLl9fY2xpZW50SGVpZ2h0IC0gaGVpZ2h0OwogICAgICBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3Iuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JzsKICAgICAgc2VsZi5fX2luZGljYXRvclkuc2l6ZVJhdGlvID0gc2VsZi5fX21heFNjcm9sbFRvcCA/IHNlbGYuX19pbmRpY2F0b3JZLm1heFBvcyAvIHNlbGYuX19tYXhTY3JvbGxUb3AgOiAxOwogICAgfQogIH0sCgogIC8qKgogICAqIE1vdmUgYW5kIHNjYWxlIHRoZSBzY3JvbGxiYXJzIGFzIHRoZSBwYWdlIHNjcm9sbHMuCiAgICovCiAgX19yZXBvc2l0aW9uU2Nyb2xsYmFyczogZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIHdpZHRoLCBoZWlnaHRTY2FsZSwKICAgICAgICB3aWR0aERpZmYsIGhlaWdodERpZmYsCiAgICAgICAgeCwgeSwKICAgICAgICB4c3RvcCA9IDAsIHlzdG9wID0gMDsKCiAgICBpZihzZWxmLl9faW5kaWNhdG9yWCkgewogICAgICAvLyBIYW5kbGUgdGhlIFggc2Nyb2xsYmFyCgogICAgICAvLyBEb24ndCBnbyBhbGwgdGhlIHdheSB0byB0aGUgcmlnaHQgaWYgd2UgaGF2ZSBhIHZlcnRpY2FsIHNjcm9sbGJhciBhcyB3ZWxsCiAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB4c3RvcCA9IDEwOwoKICAgICAgeCA9IE1hdGgucm91bmQoc2VsZi5fX2luZGljYXRvclguc2l6ZVJhdGlvICogc2VsZi5fX3Njcm9sbExlZnQpIHx8IDAsCgogICAgICAvLyBUaGUgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGUgbGFzdCBjb250ZW50IFggcG9zaXRpb24sIGFuZCBvdXIgb3ZlcnNjcm9sbGVkIG9uZQogICAgICB3aWR0aERpZmYgPSBzZWxmLl9fc2Nyb2xsTGVmdCAtIChzZWxmLl9fbWF4U2Nyb2xsTGVmdCAtIHhzdG9wKTsKCiAgICAgIGlmKHNlbGYuX19zY3JvbGxMZWZ0IDwgMCkgewoKICAgICAgICB3aWR0aFNjYWxlID0gTWF0aC5tYXgoc2VsZi5fX2luZGljYXRvclgubWluU2NhbGUsCiAgICAgICAgICAgIChzZWxmLl9faW5kaWNhdG9yWC5zaXplIC0gTWF0aC5hYnMoc2VsZi5fX3Njcm9sbExlZnQpKSAvIHNlbGYuX19pbmRpY2F0b3JYLnNpemUpOwoKICAgICAgICAvLyBTdGF5IGF0IGxlZnQKICAgICAgICB4ID0gMDsKCiAgICAgICAgLy8gTWFrZSBzdXJlIHNjYWxlIGlzIHRyYW5zZm9ybWVkIGZyb20gdGhlIGxlZnQvY2VudGVyIG9yaWdpbiBwb2ludAogICAgICAgIHNlbGYuX19pbmRpY2F0b3JYLmluZGljYXRvci5zdHlsZVtzZWxmLl9fdHJhbnNmb3JtT3JpZ2luUHJvcGVydHldID0gJ2xlZnQgY2VudGVyJzsKICAgICAgfSBlbHNlIGlmKHdpZHRoRGlmZiA+IDApIHsKCiAgICAgICAgd2lkdGhTY2FsZSA9IE1hdGgubWF4KHNlbGYuX19pbmRpY2F0b3JYLm1pblNjYWxlLAogICAgICAgICAgICAoc2VsZi5fX2luZGljYXRvclguc2l6ZSAtIHdpZHRoRGlmZikgLyBzZWxmLl9faW5kaWNhdG9yWC5zaXplKTsKCiAgICAgICAgLy8gU3RheSBhdCB0aGUgZnVydGhlc3QgeCBmb3IgdGhlIHNjcm9sbGFibGUgdmlld3BvcnQKICAgICAgICB4ID0gc2VsZi5fX2luZGljYXRvclgubWF4UG9zIC0geHN0b3A7CgogICAgICAgIC8vIE1ha2Ugc3VyZSBzY2FsZSBpcyB0cmFuc2Zvcm1lZCBmcm9tIHRoZSByaWdodC9jZW50ZXIgb3JpZ2luIHBvaW50CiAgICAgICAgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLnN0eWxlW3NlbGYuX190cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eV0gPSAncmlnaHQgY2VudGVyJzsKCiAgICAgIH0gZWxzZSB7CgogICAgICAgIC8vIE5vcm1hbCBtb3Rpb24KICAgICAgICB4ID0gTWF0aC5taW4oc2VsZi5fX21heFNjcm9sbExlZnQsIE1hdGgubWF4KDAsIHgpKTsKICAgICAgICB3aWR0aFNjYWxlID0gMTsKCiAgICAgIH0KCiAgICAgIHNlbGYuX19pbmRpY2F0b3JYLmluZGljYXRvci5zdHlsZVtzZWxmLl9fdHJhbnNmb3JtUHJvcGVydHldID0gJ3RyYW5zbGF0ZTNkKCcgKyB4ICsgJ3B4LCAwLCAwKSBzY2FsZVgoJyArIHdpZHRoU2NhbGUgKyAnKSc7CiAgICB9CgogICAgaWYoc2VsZi5fX2luZGljYXRvclkpIHsKCiAgICAgIHkgPSBNYXRoLnJvdW5kKHNlbGYuX19pbmRpY2F0b3JZLnNpemVSYXRpbyAqIHNlbGYuX19zY3JvbGxUb3ApIHx8IDA7CgogICAgICAvLyBEb24ndCBnbyBhbGwgdGhlIHdheSB0byB0aGUgcmlnaHQgaWYgd2UgaGF2ZSBhIHZlcnRpY2FsIHNjcm9sbGJhciBhcyB3ZWxsCiAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JYKSB5c3RvcCA9IDEwOwoKICAgICAgaGVpZ2h0RGlmZiA9IHNlbGYuX19zY3JvbGxUb3AgLSAoc2VsZi5fX21heFNjcm9sbFRvcCAtIHlzdG9wKTsKCiAgICAgIGlmKHNlbGYuX19zY3JvbGxUb3AgPCAwKSB7CgogICAgICAgIGhlaWdodFNjYWxlID0gTWF0aC5tYXgoc2VsZi5fX2luZGljYXRvclkubWluU2NhbGUsIChzZWxmLl9faW5kaWNhdG9yWS5zaXplIC0gTWF0aC5hYnMoc2VsZi5fX3Njcm9sbFRvcCkpIC8gc2VsZi5fX2luZGljYXRvclkuc2l6ZSk7CgogICAgICAgIC8vIFN0YXkgYXQgdG9wCiAgICAgICAgeSA9IDA7CgogICAgICAgIC8vIE1ha2Ugc3VyZSBzY2FsZSBpcyB0cmFuc2Zvcm1lZCBmcm9tIHRoZSBjZW50ZXIvdG9wIG9yaWdpbiBwb2ludAogICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5zdHlsZVtzZWxmLl9fdHJhbnNmb3JtT3JpZ2luUHJvcGVydHldID0gJ2NlbnRlciB0b3AnOwoKICAgICAgfSBlbHNlIGlmKGhlaWdodERpZmYgPiAwKSB7CgogICAgICAgIGhlaWdodFNjYWxlID0gTWF0aC5tYXgoc2VsZi5fX2luZGljYXRvclkubWluU2NhbGUsIChzZWxmLl9faW5kaWNhdG9yWS5zaXplIC0gaGVpZ2h0RGlmZikgLyBzZWxmLl9faW5kaWNhdG9yWS5zaXplKTsKCiAgICAgICAgLy8gU3RheSBhdCBib3R0b20gb2Ygc2Nyb2xsYWJsZSB2aWV3cG9ydAogICAgICAgIHkgPSBzZWxmLl9faW5kaWNhdG9yWS5tYXhQb3MgLSB5c3RvcDsKCiAgICAgICAgLy8gTWFrZSBzdXJlIHNjYWxlIGlzIHRyYW5zZm9ybWVkIGZyb20gdGhlIGNlbnRlci9ib3R0b20gb3JpZ2luIHBvaW50CiAgICAgICAgc2VsZi5fX2luZGljYXRvclkuaW5kaWNhdG9yLnN0eWxlW3NlbGYuX190cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eV0gPSAnY2VudGVyIGJvdHRvbSc7CgogICAgICB9IGVsc2UgewoKICAgICAgICAvLyBOb3JtYWwgbW90aW9uCiAgICAgICAgeSA9IE1hdGgubWluKHNlbGYuX19tYXhTY3JvbGxUb3AsIE1hdGgubWF4KDAsIHkpKTsKICAgICAgICBoZWlnaHRTY2FsZSA9IDE7CgogICAgICB9CgogICAgICBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3Iuc3R5bGVbc2VsZi5fX3RyYW5zZm9ybVByb3BlcnR5XSA9ICd0cmFuc2xhdGUzZCgwLCcgKyB5ICsgJ3B4LCAwKSBzY2FsZVkoJyArIGhlaWdodFNjYWxlICsgJyknOwogICAgfQogIH0sCgogIF9fZmFkZVNjcm9sbGJhcnM6IGZ1bmN0aW9uKGRpcmVjdGlvbiwgZGVsYXkpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBpZighdGhpcy5vcHRpb25zLnNjcm9sbGJhcnNGYWRlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY2xhc3NOYW1lID0gJ3Njcm9sbC1iYXItZmFkZS1vdXQnOwoKICAgIGlmKHNlbGYub3B0aW9ucy5zY3JvbGxiYXJzRmFkZSA9PT0gdHJ1ZSkgewogICAgICBjbGVhclRpbWVvdXQoc2VsZi5fX3Njcm9sbGJhckZhZGVUaW1lb3V0KTsKCiAgICAgIGlmKGRpcmVjdGlvbiA9PSAnaW4nKSB7CiAgICAgICAgaWYoc2VsZi5fX2luZGljYXRvclgpIHsgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLmNsYXNzTGlzdC5yZW1vdmUoY2xhc3NOYW1lKTsgfQogICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB7IHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7IH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzZWxmLl9fc2Nyb2xsYmFyRmFkZVRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoc2VsZi5fX2luZGljYXRvclgpIHsgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsgfQogICAgICAgICAgaWYoc2VsZi5fX2luZGljYXRvclkpIHsgc2VsZi5fX2luZGljYXRvclkuaW5kaWNhdG9yLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsgfQogICAgICAgIH0sIGRlbGF5IHx8IHNlbGYub3B0aW9ucy5zY3JvbGxiYXJGYWRlRGVsYXkpOwogICAgICB9CiAgICB9CiAgfSwKCiAgX19zY3JvbGxpbmdDb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgIGlvbmljLnRhcC5yZW1vdmVDbG9uZWRJbnB1dHMoc2VsZi5fX2NvbnRhaW5lciwgc2VsZik7CgogICAgc2VsZi5fX2ZhZGVTY3JvbGxiYXJzKCdvdXQnKTsKICB9LAoKICByZXNpemU6IGZ1bmN0aW9uKCkgewogICAgLy8gVXBkYXRlIFNjcm9sbGVyIGRpbWVuc2lvbnMgZm9yIGNoYW5nZWQgY29udGVudAogICAgLy8gQWRkIHBhZGRpbmcgdG8gYm90dG9tIG9mIGNvbnRlbnQKICAgIHRoaXMuc2V0RGltZW5zaW9ucygKICAgICAgdGhpcy5fX2NvbnRhaW5lci5jbGllbnRXaWR0aCwKICAgICAgdGhpcy5fX2NvbnRhaW5lci5jbGllbnRIZWlnaHQsCiAgICAgIHRoaXMub3B0aW9ucy5nZXRDb250ZW50V2lkdGgoKSwKICAgICAgdGhpcy5vcHRpb25zLmdldENvbnRlbnRIZWlnaHQoKQogICAgKTsKICB9LAogIC8qCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBQVUJMSUMgQVBJCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKi8KCiAgZ2V0UmVuZGVyRm46IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBjb250ZW50ID0gdGhpcy5fX2NvbnRlbnQ7CgogICAgdmFyIGRvY1N0eWxlID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlOwoKICAgIHZhciBlbmdpbmU7CiAgICBpZiAoJ01vekFwcGVhcmFuY2UnIGluIGRvY1N0eWxlKSB7CiAgICAgIGVuZ2luZSA9ICdnZWNrbyc7CiAgICB9IGVsc2UgaWYgKCdXZWJraXRBcHBlYXJhbmNlJyBpbiBkb2NTdHlsZSkgewogICAgICBlbmdpbmUgPSAnd2Via2l0JzsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hdmlnYXRvci5jcHVDbGFzcyA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5naW5lID0gJ3RyaWRlbnQnOwogICAgfQoKICAgIHZhciB2ZW5kb3JQcmVmaXggPSB7CiAgICAgIHRyaWRlbnQ6ICdtcycsCiAgICAgIGdlY2tvOiAnTW96JywKICAgICAgd2Via2l0OiAnV2Via2l0JywKICAgICAgcHJlc3RvOiAnTycKICAgIH1bZW5naW5lXTsKCiAgICB2YXIgaGVscGVyRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdmFyIHVuZGVmOwoKICAgIHZhciBwZXJzcGVjdGl2ZVByb3BlcnR5ID0gdmVuZG9yUHJlZml4ICsgIlBlcnNwZWN0aXZlIjsKICAgIHZhciB0cmFuc2Zvcm1Qcm9wZXJ0eSA9IHZlbmRvclByZWZpeCArICJUcmFuc2Zvcm0iOwogICAgdmFyIHRyYW5zZm9ybU9yaWdpblByb3BlcnR5ID0gdmVuZG9yUHJlZml4ICsgJ1RyYW5zZm9ybU9yaWdpbic7CgogICAgc2VsZi5fX3BlcnNwZWN0aXZlUHJvcGVydHkgPSB0cmFuc2Zvcm1Qcm9wZXJ0eTsKICAgIHNlbGYuX190cmFuc2Zvcm1Qcm9wZXJ0eSA9IHRyYW5zZm9ybVByb3BlcnR5OwogICAgc2VsZi5fX3RyYW5zZm9ybU9yaWdpblByb3BlcnR5ID0gdHJhbnNmb3JtT3JpZ2luUHJvcGVydHk7CgogICAgaWYgKGhlbHBlckVsZW0uc3R5bGVbcGVyc3BlY3RpdmVQcm9wZXJ0eV0gIT09IHVuZGVmKSB7CgogICAgICByZXR1cm4gZnVuY3Rpb24obGVmdCwgdG9wLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgICBjb250ZW50LnN0eWxlW3RyYW5zZm9ybVByb3BlcnR5XSA9ICd0cmFuc2xhdGUzZCgnICsgKC1sZWZ0KSArICdweCwnICsgKC10b3ApICsgJ3B4LDApIHNjYWxlKCcgKyB6b29tICsgJyknOwogICAgICAgIHNlbGYuX19yZXBvc2l0aW9uU2Nyb2xsYmFycygpOwogICAgICAgIGlmKCF3YXNSZXNpemUpIHsKICAgICAgICAgIHNlbGYudHJpZ2dlclNjcm9sbEV2ZW50KCk7CiAgICAgICAgfQogICAgICB9OwoKICAgIH0gZWxzZSBpZiAoaGVscGVyRWxlbS5zdHlsZVt0cmFuc2Zvcm1Qcm9wZXJ0eV0gIT09IHVuZGVmKSB7CgogICAgICByZXR1cm4gZnVuY3Rpb24obGVmdCwgdG9wLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgICBjb250ZW50LnN0eWxlW3RyYW5zZm9ybVByb3BlcnR5XSA9ICd0cmFuc2xhdGUoJyArICgtbGVmdCkgKyAncHgsJyArICgtdG9wKSArICdweCkgc2NhbGUoJyArIHpvb20gKyAnKSc7CiAgICAgICAgc2VsZi5fX3JlcG9zaXRpb25TY3JvbGxiYXJzKCk7CiAgICAgICAgaWYoIXdhc1Jlc2l6ZSkgewogICAgICAgICAgc2VsZi50cmlnZ2VyU2Nyb2xsRXZlbnQoKTsKICAgICAgICB9CiAgICAgIH07CgogICAgfSBlbHNlIHsKCiAgICAgIHJldHVybiBmdW5jdGlvbihsZWZ0LCB0b3AsIHpvb20sIHdhc1Jlc2l6ZSkgewogICAgICAgIGNvbnRlbnQuc3R5bGUubWFyZ2luTGVmdCA9IGxlZnQgPyAoLWxlZnQvem9vbSkgKyAncHgnIDogJyc7CiAgICAgICAgY29udGVudC5zdHlsZS5tYXJnaW5Ub3AgPSB0b3AgPyAoLXRvcC96b29tKSArICdweCcgOiAnJzsKICAgICAgICBjb250ZW50LnN0eWxlLnpvb20gPSB6b29tIHx8ICcnOwogICAgICAgIHNlbGYuX19yZXBvc2l0aW9uU2Nyb2xsYmFycygpOwogICAgICAgIGlmKCF3YXNSZXNpemUpIHsKICAgICAgICAgIHNlbGYudHJpZ2dlclNjcm9sbEV2ZW50KCk7CiAgICAgICAgfQogICAgICB9OwoKICAgIH0KICB9LAoKCiAgLyoqCiAgICogQ29uZmlndXJlcyB0aGUgZGltZW5zaW9ucyBvZiB0aGUgY2xpZW50IChvdXRlcikgYW5kIGNvbnRlbnQgKGlubmVyKSBlbGVtZW50cy4KICAgKiBSZXF1aXJlcyB0aGUgYXZhaWxhYmxlIHNwYWNlIGZvciB0aGUgb3V0ZXIgZWxlbWVudCBhbmQgdGhlIG91dGVyIHNpemUgb2YgdGhlIGlubmVyIGVsZW1lbnQuCiAgICogQWxsIHZhbHVlcyB3aGljaCBhcmUgZmFsc3kgKG51bGwgb3IgemVybyBldGMuKSBhcmUgaWdub3JlZCBhbmQgdGhlIG9sZCB2YWx1ZSBpcyBrZXB0LgogICAqCiAgICogQHBhcmFtIGNsaWVudFdpZHRoIHtJbnRlZ2VyfSBJbm5lciB3aWR0aCBvZiBvdXRlciBlbGVtZW50CiAgICogQHBhcmFtIGNsaWVudEhlaWdodCB7SW50ZWdlcn0gSW5uZXIgaGVpZ2h0IG9mIG91dGVyIGVsZW1lbnQKICAgKiBAcGFyYW0gY29udGVudFdpZHRoIHtJbnRlZ2VyfSBPdXRlciB3aWR0aCBvZiBpbm5lciBlbGVtZW50CiAgICogQHBhcmFtIGNvbnRlbnRIZWlnaHQge0ludGVnZXJ9IE91dGVyIGhlaWdodCBvZiBpbm5lciBlbGVtZW50CiAgICovCiAgc2V0RGltZW5zaW9uczogZnVuY3Rpb24oY2xpZW50V2lkdGgsIGNsaWVudEhlaWdodCwgY29udGVudFdpZHRoLCBjb250ZW50SGVpZ2h0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgLy8gT25seSB1cGRhdGUgdmFsdWVzIHdoaWNoIGFyZSBkZWZpbmVkCiAgICBpZiAoY2xpZW50V2lkdGggPT09ICtjbGllbnRXaWR0aCkgewogICAgICBzZWxmLl9fY2xpZW50V2lkdGggPSBjbGllbnRXaWR0aDsKICAgIH0KCiAgICBpZiAoY2xpZW50SGVpZ2h0ID09PSArY2xpZW50SGVpZ2h0KSB7CiAgICAgIHNlbGYuX19jbGllbnRIZWlnaHQgPSBjbGllbnRIZWlnaHQ7CiAgICB9CgogICAgaWYgKGNvbnRlbnRXaWR0aCA9PT0gK2NvbnRlbnRXaWR0aCkgewogICAgICBzZWxmLl9fY29udGVudFdpZHRoID0gY29udGVudFdpZHRoOwogICAgfQoKICAgIGlmIChjb250ZW50SGVpZ2h0ID09PSArY29udGVudEhlaWdodCkgewogICAgICBzZWxmLl9fY29udGVudEhlaWdodCA9IGNvbnRlbnRIZWlnaHQ7CiAgICB9CgogICAgLy8gUmVmcmVzaCBtYXhpbXVtcwogICAgc2VsZi5fX2NvbXB1dGVTY3JvbGxNYXgoKTsKICAgIHNlbGYuX19yZXNpemVTY3JvbGxiYXJzKCk7CgogICAgLy8gUmVmcmVzaCBzY3JvbGwgcG9zaXRpb24KICAgIHNlbGYuc2Nyb2xsVG8oc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHRydWUsIG51bGwsIHRydWUpOwoKICB9LAoKCiAgLyoqCiAgICogU2V0cyB0aGUgY2xpZW50IGNvb3JkaW5hdGVzIGluIHJlbGF0aW9uIHRvIHRoZSBkb2N1bWVudC4KICAgKgogICAqIEBwYXJhbSBsZWZ0IHtJbnRlZ2VyfSBMZWZ0IHBvc2l0aW9uIG9mIG91dGVyIGVsZW1lbnQKICAgKiBAcGFyYW0gdG9wIHtJbnRlZ2VyfSBUb3AgcG9zaXRpb24gb2Ygb3V0ZXIgZWxlbWVudAogICAqLwogIHNldFBvc2l0aW9uOiBmdW5jdGlvbihsZWZ0LCB0b3ApIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgc2VsZi5fX2NsaWVudExlZnQgPSBsZWZ0IHx8IDA7CiAgICBzZWxmLl9fY2xpZW50VG9wID0gdG9wIHx8IDA7CgogIH0sCgoKICAvKioKICAgKiBDb25maWd1cmVzIHRoZSBzbmFwcGluZyAod2hlbiBzbmFwcGluZyBpcyBhY3RpdmUpCiAgICoKICAgKiBAcGFyYW0gd2lkdGgge0ludGVnZXJ9IFNuYXBwaW5nIHdpZHRoCiAgICogQHBhcmFtIGhlaWdodCB7SW50ZWdlcn0gU25hcHBpbmcgaGVpZ2h0CiAgICovCiAgc2V0U25hcFNpemU6IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgc2VsZi5fX3NuYXBXaWR0aCA9IHdpZHRoOwogICAgc2VsZi5fX3NuYXBIZWlnaHQgPSBoZWlnaHQ7CgogIH0sCgoKICAvKioKICAgKiBBY3RpdmF0ZXMgcHVsbC10by1yZWZyZXNoLiBBIHNwZWNpYWwgem9uZSBvbiB0aGUgdG9wIG9mIHRoZSBsaXN0IHRvIHN0YXJ0IGEgbGlzdCByZWZyZXNoIHdoZW5ldmVyCiAgICogdGhlIHVzZXIgZXZlbnQgaXMgcmVsZWFzZWQgZHVyaW5nIHZpc2liaWxpdHkgb2YgdGhpcyB6b25lLiBUaGlzIHdhcyBpbnRyb2R1Y2VkIGJ5IHNvbWUgYXBwcyBvbiBpT1MgbGlrZQogICAqIHRoZSBvZmZpY2lhbCBUd2l0dGVyIGNsaWVudC4KICAgKgogICAqIEBwYXJhbSBoZWlnaHQge0ludGVnZXJ9IEhlaWdodCBvZiBwdWxsLXRvLXJlZnJlc2ggem9uZSBvbiB0b3Agb2YgcmVuZGVyZWQgbGlzdAogICAqIEBwYXJhbSBhY3RpdmF0ZUNhbGxiYWNrIHtGdW5jdGlvbn0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbiBhY3RpdmF0aW9uLiBUaGlzIGlzIGZvciBzaWduYWxsaW5nIHRoZSB1c2VyIGFib3V0IGEgcmVmcmVzaCBpcyBhYm91dCB0byBoYXBwZW4gd2hlbiBoZSByZWxlYXNlLgogICAqIEBwYXJhbSBkZWFjdGl2YXRlQ2FsbGJhY2sge0Z1bmN0aW9ufSBDYWxsYmFjayB0byBleGVjdXRlIG9uIGRlYWN0aXZhdGlvbi4gVGhpcyBpcyBmb3Igc2lnbmFsbGluZyB0aGUgdXNlciBhYm91dCB0aGUgcmVmcmVzaCBiZWluZyBjYW5jZWxsZWQuCiAgICogQHBhcmFtIHN0YXJ0Q2FsbGJhY2sge0Z1bmN0aW9ufSBDYWxsYmFjayB0byBleGVjdXRlIHRvIHN0YXJ0IHRoZSByZWFsIGFzeW5jIHJlZnJlc2ggYWN0aW9uLiBDYWxsIHtAbGluayAjZmluaXNoUHVsbFRvUmVmcmVzaH0gYWZ0ZXIgZmluaXNoIG9mIHJlZnJlc2guCiAgICogQHBhcmFtIHNob3dDYWxsYmFjayB7RnVuY3Rpb259IENhbGxiYWNrIHRvIGV4ZWN1dGUgd2hlbiB0aGUgcmVmcmVzaGVyIHNob3VsZCBiZSBzaG93bi4gVGhpcyBpcyBmb3Igc2hvd2luZyB0aGUgcmVmcmVzaGVyIGR1cmluZyBhIG5lZ2F0aXZlIHNjcm9sbFRvcC4KICAgKiBAcGFyYW0gaGlkZUNhbGxiYWNrIHtGdW5jdGlvbn0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSB3aGVuIHRoZSByZWZyZXNoZXIgc2hvdWxkIGJlIGhpZGRlbi4gVGhpcyBpcyBmb3IgaGlkaW5nIHRoZSByZWZyZXNoZXIgd2hlbiBpdCdzIGJlaGluZCB0aGUgbmF2IGJhci4KICAgKi8KICBhY3RpdmF0ZVB1bGxUb1JlZnJlc2g6IGZ1bmN0aW9uKGhlaWdodCwgYWN0aXZhdGVDYWxsYmFjaywgZGVhY3RpdmF0ZUNhbGxiYWNrLCBzdGFydENhbGxiYWNrLCBzaG93Q2FsbGJhY2ssIGhpZGVDYWxsYmFjaykgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBzZWxmLl9fcmVmcmVzaEhlaWdodCA9IGhlaWdodDsKICAgIHNlbGYuX19yZWZyZXNoQWN0aXZhdGUgPSBhY3RpdmF0ZUNhbGxiYWNrOwogICAgc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlID0gZGVhY3RpdmF0ZUNhbGxiYWNrOwogICAgc2VsZi5fX3JlZnJlc2hTdGFydCA9IHN0YXJ0Q2FsbGJhY2s7CiAgICBzZWxmLl9fcmVmcmVzaFNob3cgPSBzaG93Q2FsbGJhY2s7CiAgICBzZWxmLl9fcmVmcmVzaEhpZGUgPSBoaWRlQ2FsbGJhY2s7CiAgfSwKCgogIC8qKgogICAqIFN0YXJ0cyBwdWxsLXRvLXJlZnJlc2ggbWFudWFsbHkuCiAgICovCiAgdHJpZ2dlclB1bGxUb1JlZnJlc2g6IGZ1bmN0aW9uKCkgewogICAgLy8gVXNlIHB1Ymxpc2ggaW5zdGVhZCBvZiBzY3JvbGxUbyB0byBhbGxvdyBzY3JvbGxpbmcgdG8gb3V0IG9mIGJvdW5kYXJ5IHBvc2l0aW9uCiAgICAvLyBXZSBkb24ndCBuZWVkIHRvIG5vcm1hbGl6ZSBzY3JvbGxMZWZ0LCB6b29tTGV2ZWwsIGV0Yy4gaGVyZSBiZWNhdXNlIHdlIG9ubHkgeS1zY3JvbGxpbmcgd2hlbiBwdWxsLXRvLXJlZnJlc2ggaXMgZW5hYmxlZAogICAgdGhpcy5fX3B1Ymxpc2godGhpcy5fX3Njcm9sbExlZnQsIC10aGlzLl9fcmVmcmVzaEhlaWdodCwgdGhpcy5fX3pvb21MZXZlbCwgdHJ1ZSk7CgogICAgaWYgKHRoaXMuX19yZWZyZXNoU3RhcnQpIHsKICAgICAgdGhpcy5fX3JlZnJlc2hTdGFydCgpOwogICAgfQogIH0sCgoKICAvKioKICAgKiBTaWduYWxpemVzIHRoYXQgcHVsbC10by1yZWZyZXNoIGlzIGZpbmlzaGVkLgogICAqLwogIGZpbmlzaFB1bGxUb1JlZnJlc2g6IGZ1bmN0aW9uKCkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBzZWxmLl9fcmVmcmVzaEFjdGl2ZSA9IGZhbHNlOwogICAgaWYgKHNlbGYuX19yZWZyZXNoRGVhY3RpdmF0ZSkgewogICAgICBzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUoKTsKICAgIH0KCiAgICBzZWxmLnNjcm9sbFRvKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fc2Nyb2xsVG9wLCB0cnVlKTsKCiAgfSwKCgogIC8qKgogICAqIFJldHVybnMgdGhlIHNjcm9sbCBwb3NpdGlvbiBhbmQgem9vbWluZyB2YWx1ZXMKICAgKgogICAqIEByZXR1cm4ge01hcH0gYGxlZnRgIGFuZCBgdG9wYCBzY3JvbGwgcG9zaXRpb24gYW5kIGB6b29tYCBsZXZlbAogICAqLwogIGdldFZhbHVlczogZnVuY3Rpb24oKSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IHNlbGYuX19zY3JvbGxMZWZ0LAogICAgICB0b3A6IHNlbGYuX19zY3JvbGxUb3AsCiAgICAgIHpvb206IHNlbGYuX196b29tTGV2ZWwKICAgIH07CgogIH0sCgoKICAvKioKICAgKiBSZXR1cm5zIHRoZSBtYXhpbXVtIHNjcm9sbCB2YWx1ZXMKICAgKgogICAqIEByZXR1cm4ge01hcH0gYGxlZnRgIGFuZCBgdG9wYCBtYXhpbXVtIHNjcm9sbCB2YWx1ZXMKICAgKi8KICBnZXRTY3JvbGxNYXg6IGZ1bmN0aW9uKCkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICByZXR1cm4gewogICAgICBsZWZ0OiBzZWxmLl9fbWF4U2Nyb2xsTGVmdCwKICAgICAgdG9wOiBzZWxmLl9fbWF4U2Nyb2xsVG9wCiAgICB9OwoKICB9LAoKCiAgLyoqCiAgICogWm9vbXMgdG8gdGhlIGdpdmVuIGxldmVsLiBTdXBwb3J0cyBvcHRpb25hbCBhbmltYXRpb24uIFpvb21zCiAgICogdGhlIGNlbnRlciB3aGVuIG5vIGNvb3JkaW5hdGVzIGFyZSBnaXZlbi4KICAgKgogICAqIEBwYXJhbSBsZXZlbCB7TnVtYmVyfSBMZXZlbCB0byB6b29tIHRvCiAgICogQHBhcmFtIGFuaW1hdGUge0Jvb2xlYW59IFdoZXRoZXIgdG8gdXNlIGFuaW1hdGlvbgogICAqIEBwYXJhbSBvcmlnaW5MZWZ0IHtOdW1iZXJ9IFpvb20gaW4gYXQgZ2l2ZW4gbGVmdCBjb29yZGluYXRlCiAgICogQHBhcmFtIG9yaWdpblRvcCB7TnVtYmVyfSBab29tIGluIGF0IGdpdmVuIHRvcCBjb29yZGluYXRlCiAgICovCiAgem9vbVRvOiBmdW5jdGlvbihsZXZlbCwgYW5pbWF0ZSwgb3JpZ2luTGVmdCwgb3JpZ2luVG9wKSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGlmICghc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJab29taW5nIGlzIG5vdCBlbmFibGVkISIpOwogICAgfQoKICAgIC8vIFN0b3AgZGVjZWxlcmF0aW9uCiAgICBpZiAoc2VsZi5fX2lzRGVjZWxlcmF0aW5nKSB7CiAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdG9wKHNlbGYuX19pc0RlY2VsZXJhdGluZyk7CiAgICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IGZhbHNlOwogICAgfQoKICAgIHZhciBvbGRMZXZlbCA9IHNlbGYuX196b29tTGV2ZWw7CgogICAgLy8gTm9ybWFsaXplIGlucHV0IG9yaWdpbiB0byBjZW50ZXIgb2Ygdmlld3BvcnQgaWYgbm90IGRlZmluZWQKICAgIGlmIChvcmlnaW5MZWZ0ID09IG51bGwpIHsKICAgICAgb3JpZ2luTGVmdCA9IHNlbGYuX19jbGllbnRXaWR0aCAvIDI7CiAgICB9CgogICAgaWYgKG9yaWdpblRvcCA9PSBudWxsKSB7CiAgICAgIG9yaWdpblRvcCA9IHNlbGYuX19jbGllbnRIZWlnaHQgLyAyOwogICAgfQoKICAgIC8vIExpbWl0IGxldmVsIGFjY29yZGluZyB0byBjb25maWd1cmF0aW9uCiAgICBsZXZlbCA9IE1hdGgubWF4KE1hdGgubWluKGxldmVsLCBzZWxmLm9wdGlvbnMubWF4Wm9vbSksIHNlbGYub3B0aW9ucy5taW5ab29tKTsKCiAgICAvLyBSZWNvbXB1dGUgbWF4aW11bSB2YWx1ZXMgd2hpbGUgdGVtcG9yYXJ5IHR3ZWFraW5nIG1heGltdW0gc2Nyb2xsIHJhbmdlcwogICAgc2VsZi5fX2NvbXB1dGVTY3JvbGxNYXgobGV2ZWwpOwoKICAgIC8vIFJlY29tcHV0ZSBsZWZ0IGFuZCB0b3AgY29vcmRpbmF0ZXMgYmFzZWQgb24gbmV3IHpvb20gbGV2ZWwKICAgIHZhciBsZWZ0ID0gKChvcmlnaW5MZWZ0ICsgc2VsZi5fX3Njcm9sbExlZnQpICogbGV2ZWwgLyBvbGRMZXZlbCkgLSBvcmlnaW5MZWZ0OwogICAgdmFyIHRvcCA9ICgob3JpZ2luVG9wICsgc2VsZi5fX3Njcm9sbFRvcCkgKiBsZXZlbCAvIG9sZExldmVsKSAtIG9yaWdpblRvcDsKCiAgICAvLyBMaW1pdCB4LWF4aXMKICAgIGlmIChsZWZ0ID4gc2VsZi5fX21heFNjcm9sbExlZnQpIHsKICAgICAgbGVmdCA9IHNlbGYuX19tYXhTY3JvbGxMZWZ0OwogICAgfSBlbHNlIGlmIChsZWZ0IDwgMCkgewogICAgICBsZWZ0ID0gMDsKICAgIH0KCiAgICAvLyBMaW1pdCB5LWF4aXMKICAgIGlmICh0b3AgPiBzZWxmLl9fbWF4U2Nyb2xsVG9wKSB7CiAgICAgIHRvcCA9IHNlbGYuX19tYXhTY3JvbGxUb3A7CiAgICB9IGVsc2UgaWYgKHRvcCA8IDApIHsKICAgICAgdG9wID0gMDsKICAgIH0KCiAgICAvLyBQdXNoIHZhbHVlcyBvdXQKICAgIHNlbGYuX19wdWJsaXNoKGxlZnQsIHRvcCwgbGV2ZWwsIGFuaW1hdGUpOwoKICB9LAoKCiAgLyoqCiAgICogWm9vbXMgdGhlIGNvbnRlbnQgYnkgdGhlIGdpdmVuIGZhY3Rvci4KICAgKgogICAqIEBwYXJhbSBmYWN0b3Ige051bWJlcn0gWm9vbSBieSBnaXZlbiBmYWN0b3IKICAgKiBAcGFyYW0gYW5pbWF0ZSB7Qm9vbGVhbn0gV2hldGhlciB0byB1c2UgYW5pbWF0aW9uCiAgICogQHBhcmFtIG9yaWdpbkxlZnQge051bWJlcn0gWm9vbSBpbiBhdCBnaXZlbiBsZWZ0IGNvb3JkaW5hdGUKICAgKiBAcGFyYW0gb3JpZ2luVG9wIHtOdW1iZXJ9IFpvb20gaW4gYXQgZ2l2ZW4gdG9wIGNvb3JkaW5hdGUKICAgKi8KICB6b29tQnk6IGZ1bmN0aW9uKGZhY3RvciwgYW5pbWF0ZSwgb3JpZ2luTGVmdCwgb3JpZ2luVG9wKSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHNlbGYuem9vbVRvKHNlbGYuX196b29tTGV2ZWwgKiBmYWN0b3IsIGFuaW1hdGUsIG9yaWdpbkxlZnQsIG9yaWdpblRvcCk7CgogIH0sCgoKICAvKioKICAgKiBTY3JvbGxzIHRvIHRoZSBnaXZlbiBwb3NpdGlvbi4gUmVzcGVjdCBsaW1pdGF0aW9ucyBhbmQgc25hcHBpbmcgYXV0b21hdGljYWxseS4KICAgKgogICAqIEBwYXJhbSBsZWZ0IHtOdW1iZXJ9IEhvcml6b250YWwgc2Nyb2xsIHBvc2l0aW9uLCBrZWVwcyBjdXJyZW50IGlmIHZhbHVlIGlzIDxjb2RlPm51bGw8L2NvZGU+CiAgICogQHBhcmFtIHRvcCB7TnVtYmVyfSBWZXJ0aWNhbCBzY3JvbGwgcG9zaXRpb24sIGtlZXBzIGN1cnJlbnQgaWYgdmFsdWUgaXMgPGNvZGU+bnVsbDwvY29kZT4KICAgKiBAcGFyYW0gYW5pbWF0ZSB7Qm9vbGVhbn0gV2hldGhlciB0aGUgc2Nyb2xsaW5nIHNob3VsZCBoYXBwZW4gdXNpbmcgYW4gYW5pbWF0aW9uCiAgICogQHBhcmFtIHpvb20ge051bWJlcn0gWm9vbSBsZXZlbCB0byBnbyB0bwogICAqLwogIHNjcm9sbFRvOiBmdW5jdGlvbihsZWZ0LCB0b3AsIGFuaW1hdGUsIHpvb20sIHdhc1Jlc2l6ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIFN0b3AgZGVjZWxlcmF0aW9uCiAgICBpZiAoc2VsZi5fX2lzRGVjZWxlcmF0aW5nKSB7CiAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdG9wKHNlbGYuX19pc0RlY2VsZXJhdGluZyk7CiAgICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IGZhbHNlOwogICAgfQoKICAgIC8vIENvcnJlY3QgY29vcmRpbmF0ZXMgYmFzZWQgb24gbmV3IHpvb20gbGV2ZWwKICAgIGlmICh6b29tICE9IG51bGwgJiYgem9vbSAhPT0gc2VsZi5fX3pvb21MZXZlbCkgewoKICAgICAgaWYgKCFzZWxmLm9wdGlvbnMuem9vbWluZykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiWm9vbWluZyBpcyBub3QgZW5hYmxlZCEiKTsKICAgICAgfQoKICAgICAgbGVmdCAqPSB6b29tOwogICAgICB0b3AgKj0gem9vbTsKCiAgICAgIC8vIFJlY29tcHV0ZSBtYXhpbXVtIHZhbHVlcyB3aGlsZSB0ZW1wb3JhcnkgdHdlYWtpbmcgbWF4aW11bSBzY3JvbGwgcmFuZ2VzCiAgICAgIHNlbGYuX19jb21wdXRlU2Nyb2xsTWF4KHpvb20pOwoKICAgIH0gZWxzZSB7CgogICAgICAvLyBLZWVwIHpvb20gd2hlbiBub3QgZGVmaW5lZAogICAgICB6b29tID0gc2VsZi5fX3pvb21MZXZlbDsKCiAgICB9CgogICAgaWYgKCFzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWCkgewoKICAgICAgbGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0OwoKICAgIH0gZWxzZSB7CgogICAgICBpZiAoc2VsZi5vcHRpb25zLnBhZ2luZykgewogICAgICAgIGxlZnQgPSBNYXRoLnJvdW5kKGxlZnQgLyBzZWxmLl9fY2xpZW50V2lkdGgpICogc2VsZi5fX2NsaWVudFdpZHRoOwogICAgICB9IGVsc2UgaWYgKHNlbGYub3B0aW9ucy5zbmFwcGluZykgewogICAgICAgIGxlZnQgPSBNYXRoLnJvdW5kKGxlZnQgLyBzZWxmLl9fc25hcFdpZHRoKSAqIHNlbGYuX19zbmFwV2lkdGg7CiAgICAgIH0KCiAgICB9CgogICAgaWYgKCFzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWSkgewoKICAgICAgdG9wID0gc2VsZi5fX3Njcm9sbFRvcDsKCiAgICB9IGVsc2UgewoKICAgICAgaWYgKHNlbGYub3B0aW9ucy5wYWdpbmcpIHsKICAgICAgICB0b3AgPSBNYXRoLnJvdW5kKHRvcCAvIHNlbGYuX19jbGllbnRIZWlnaHQpICogc2VsZi5fX2NsaWVudEhlaWdodDsKICAgICAgfSBlbHNlIGlmIChzZWxmLm9wdGlvbnMuc25hcHBpbmcpIHsKICAgICAgICB0b3AgPSBNYXRoLnJvdW5kKHRvcCAvIHNlbGYuX19zbmFwSGVpZ2h0KSAqIHNlbGYuX19zbmFwSGVpZ2h0OwogICAgICB9CgogICAgfQoKICAgIC8vIExpbWl0IGZvciBhbGxvd2VkIHJhbmdlcwogICAgbGVmdCA9IE1hdGgubWF4KE1hdGgubWluKHNlbGYuX19tYXhTY3JvbGxMZWZ0LCBsZWZ0KSwgMCk7CiAgICB0b3AgPSBNYXRoLm1heChNYXRoLm1pbihzZWxmLl9fbWF4U2Nyb2xsVG9wLCB0b3ApLCAwKTsKCiAgICAvLyBEb24ndCBhbmltYXRlIHdoZW4gbm8gY2hhbmdlIGRldGVjdGVkLCBzdGlsbCBjYWxsIHB1Ymxpc2ggdG8gbWFrZSBzdXJlCiAgICAvLyB0aGF0IHJlbmRlcmVkIHBvc2l0aW9uIGlzIHJlYWxseSBpbi1zeW5jIHdpdGggaW50ZXJuYWwgZGF0YQogICAgaWYgKGxlZnQgPT09IHNlbGYuX19zY3JvbGxMZWZ0ICYmIHRvcCA9PT0gc2VsZi5fX3Njcm9sbFRvcCkgewogICAgICBhbmltYXRlID0gZmFsc2U7CiAgICB9CgogICAgLy8gUHVibGlzaCBuZXcgdmFsdWVzCiAgICBzZWxmLl9fcHVibGlzaChsZWZ0LCB0b3AsIHpvb20sIGFuaW1hdGUsIHdhc1Jlc2l6ZSk7CgogIH0sCgoKICAvKioKICAgKiBTY3JvbGwgYnkgdGhlIGdpdmVuIG9mZnNldAogICAqCiAgICogQHBhcmFtIGxlZnQge051bWJlcn0gU2Nyb2xsIHgtYXhpcyBieSBnaXZlbiBvZmZzZXQKICAgKiBAcGFyYW0gdG9wIHtOdW1iZXJ9IFNjcm9sbCB5LWF4aXMgYnkgZ2l2ZW4gb2Zmc2V0CiAgICogQHBhcmFtIGFuaW1hdGUge0Jvb2xlYW59IFdoZXRoZXIgdG8gYW5pbWF0ZSB0aGUgZ2l2ZW4gY2hhbmdlCiAgICovCiAgc2Nyb2xsQnk6IGZ1bmN0aW9uKGxlZnQsIHRvcCwgYW5pbWF0ZSkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgc3RhcnRMZWZ0ID0gc2VsZi5fX2lzQW5pbWF0aW5nID8gc2VsZi5fX3NjaGVkdWxlZExlZnQgOiBzZWxmLl9fc2Nyb2xsTGVmdDsKICAgIHZhciBzdGFydFRvcCA9IHNlbGYuX19pc0FuaW1hdGluZyA/IHNlbGYuX19zY2hlZHVsZWRUb3AgOiBzZWxmLl9fc2Nyb2xsVG9wOwoKICAgIHNlbGYuc2Nyb2xsVG8oc3RhcnRMZWZ0ICsgKGxlZnQgfHwgMCksIHN0YXJ0VG9wICsgKHRvcCB8fCAwKSwgYW5pbWF0ZSk7CgogIH0sCgoKCiAgLyoKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIEVWRU5UIENBTExCQUNLUwogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICovCgogIC8qKgogICAqIE1vdXNlIHdoZWVsIGhhbmRsZXIgZm9yIHpvb21pbmcgc3VwcG9ydAogICAqLwogIGRvTW91c2Vab29tOiBmdW5jdGlvbih3aGVlbERlbHRhLCB0aW1lU3RhbXAsIHBhZ2VYLCBwYWdlWSkgewoKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjaGFuZ2UgPSB3aGVlbERlbHRhID4gMCA/IDAuOTcgOiAxLjAzOwoKICAgIHJldHVybiBzZWxmLnpvb21UbyhzZWxmLl9fem9vbUxldmVsICogY2hhbmdlLCBmYWxzZSwgcGFnZVggLSBzZWxmLl9fY2xpZW50TGVmdCwgcGFnZVkgLSBzZWxmLl9fY2xpZW50VG9wKTsKCiAgfSwKCiAgLyoqCiAgICogVG91Y2ggc3RhcnQgaGFuZGxlciBmb3Igc2Nyb2xsaW5nIHN1cHBvcnQKICAgKi8KICBkb1RvdWNoU3RhcnQ6IGZ1bmN0aW9uKHRvdWNoZXMsIHRpbWVTdGFtcCkgewogICAgdGhpcy5oaW50UmVzaXplKCk7CgogICAgaWYgKHRpbWVTdGFtcCBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgdGltZVN0YW1wID0gdGltZVN0YW1wLnZhbHVlT2YoKTsKICAgIH0KICAgIGlmICh0eXBlb2YgdGltZVN0YW1wICE9PSAibnVtYmVyIikgewogICAgICB0aW1lU3RhbXAgPSBEYXRlLm5vdygpOwogICAgfQoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBSZXNldCBpbnRlcnJ1cHRlZEFuaW1hdGlvbiBmbGFnCiAgICBzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gPSB0cnVlOwoKICAgIC8vIFN0b3AgZGVjZWxlcmF0aW9uCiAgICBpZiAoc2VsZi5fX2lzRGVjZWxlcmF0aW5nKSB7CiAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdG9wKHNlbGYuX19pc0RlY2VsZXJhdGluZyk7CiAgICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IGZhbHNlOwogICAgICBzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gPSB0cnVlOwogICAgfQoKICAgIC8vIFN0b3AgYW5pbWF0aW9uCiAgICBpZiAoc2VsZi5fX2lzQW5pbWF0aW5nKSB7CiAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdG9wKHNlbGYuX19pc0FuaW1hdGluZyk7CiAgICAgIHNlbGYuX19pc0FuaW1hdGluZyA9IGZhbHNlOwogICAgICBzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gPSB0cnVlOwogICAgfQoKICAgIC8vIFVzZSBjZW50ZXIgcG9pbnQgd2hlbiBkZWFsaW5nIHdpdGggdHdvIGZpbmdlcnMKICAgIHZhciBjdXJyZW50VG91Y2hMZWZ0LCBjdXJyZW50VG91Y2hUb3A7CiAgICB2YXIgaXNTaW5nbGVUb3VjaCA9IHRvdWNoZXMubGVuZ3RoID09PSAxOwogICAgaWYgKGlzU2luZ2xlVG91Y2gpIHsKICAgICAgY3VycmVudFRvdWNoTGVmdCA9IHRvdWNoZXNbMF0ucGFnZVg7CiAgICAgIGN1cnJlbnRUb3VjaFRvcCA9IHRvdWNoZXNbMF0ucGFnZVk7CiAgICB9IGVsc2UgewogICAgICBjdXJyZW50VG91Y2hMZWZ0ID0gTWF0aC5hYnModG91Y2hlc1swXS5wYWdlWCArIHRvdWNoZXNbMV0ucGFnZVgpIC8gMjsKICAgICAgY3VycmVudFRvdWNoVG9wID0gTWF0aC5hYnModG91Y2hlc1swXS5wYWdlWSArIHRvdWNoZXNbMV0ucGFnZVkpIC8gMjsKICAgIH0KCiAgICAvLyBTdG9yZSBpbml0aWFsIHBvc2l0aW9ucwogICAgc2VsZi5fX2luaXRpYWxUb3VjaExlZnQgPSBjdXJyZW50VG91Y2hMZWZ0OwogICAgc2VsZi5fX2luaXRpYWxUb3VjaFRvcCA9IGN1cnJlbnRUb3VjaFRvcDsKCiAgICAvLyBTdG9yZSBpbml0aWFsIHRvdWNoTGlzdCBmb3Igc2NhbGUgY2FsY3VsYXRpb24KICAgIHNlbGYuX19pbml0aWFsVG91Y2hlcyA9IHRvdWNoZXM7CgogICAgLy8gU3RvcmUgY3VycmVudCB6b29tIGxldmVsCiAgICBzZWxmLl9fem9vbUxldmVsU3RhcnQgPSBzZWxmLl9fem9vbUxldmVsOwoKICAgIC8vIFN0b3JlIGluaXRpYWwgdG91Y2ggcG9zaXRpb25zCiAgICBzZWxmLl9fbGFzdFRvdWNoTGVmdCA9IGN1cnJlbnRUb3VjaExlZnQ7CiAgICBzZWxmLl9fbGFzdFRvdWNoVG9wID0gY3VycmVudFRvdWNoVG9wOwoKICAgIC8vIFN0b3JlIGluaXRpYWwgbW92ZSB0aW1lIHN0YW1wCiAgICBzZWxmLl9fbGFzdFRvdWNoTW92ZSA9IHRpbWVTdGFtcDsKCiAgICAvLyBSZXNldCBpbml0aWFsIHNjYWxlCiAgICBzZWxmLl9fbGFzdFNjYWxlID0gMTsKCiAgICAvLyBSZXNldCBsb2NraW5nIGZsYWdzCiAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWCA9ICFpc1NpbmdsZVRvdWNoICYmIHNlbGYub3B0aW9ucy5zY3JvbGxpbmdYOwogICAgc2VsZi5fX2VuYWJsZVNjcm9sbFkgPSAhaXNTaW5nbGVUb3VjaCAmJiBzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWTsKCiAgICAvLyBSZXNldCB0cmFja2luZyBmbGFnCiAgICBzZWxmLl9faXNUcmFja2luZyA9IHRydWU7CgogICAgLy8gUmVzZXQgZGVjZWxlcmF0aW9uIGNvbXBsZXRlIGZsYWcKICAgIHNlbGYuX19kaWREZWNlbGVyYXRpb25Db21wbGV0ZSA9IGZhbHNlOwoKICAgIC8vIERyYWdnaW5nIHN0YXJ0cyBkaXJlY3RseSB3aXRoIHR3byBmaW5nZXJzLCBvdGhlcndpc2UgbGF6eSB3aXRoIGFuIG9mZnNldAogICAgc2VsZi5fX2lzRHJhZ2dpbmcgPSAhaXNTaW5nbGVUb3VjaDsKCiAgICAvLyBTb21lIGZlYXR1cmVzIGFyZSBkaXNhYmxlZCBpbiBtdWx0aSB0b3VjaCBzY2VuYXJpb3MKICAgIHNlbGYuX19pc1NpbmdsZVRvdWNoID0gaXNTaW5nbGVUb3VjaDsKCiAgICAvLyBDbGVhcmluZyBkYXRhIHN0cnVjdHVyZQogICAgc2VsZi5fX3Bvc2l0aW9ucyA9IFtdOwoKICB9LAoKCiAgLyoqCiAgICogVG91Y2ggbW92ZSBoYW5kbGVyIGZvciBzY3JvbGxpbmcgc3VwcG9ydAogICAqLwogIGRvVG91Y2hNb3ZlOiBmdW5jdGlvbih0b3VjaGVzLCB0aW1lU3RhbXAsIHNjYWxlKSB7CiAgICBpZiAodGltZVN0YW1wIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICB0aW1lU3RhbXAgPSB0aW1lU3RhbXAudmFsdWVPZigpOwogICAgfQogICAgaWYgKHR5cGVvZiB0aW1lU3RhbXAgIT09ICJudW1iZXIiKSB7CiAgICAgIHRpbWVTdGFtcCA9IERhdGUubm93KCk7CiAgICB9CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIElnbm9yZSBldmVudCB3aGVuIHRyYWNraW5nIGlzIG5vdCBlbmFibGVkIChldmVudCBtaWdodCBiZSBvdXRzaWRlIG9mIGVsZW1lbnQpCiAgICBpZiAoIXNlbGYuX19pc1RyYWNraW5nKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY3VycmVudFRvdWNoTGVmdCwgY3VycmVudFRvdWNoVG9wOwoKICAgIC8vIENvbXB1dGUgbW92ZSBiYXNlZCBhcm91bmQgb2YgY2VudGVyIG9mIGZpbmdlcnMKICAgIGlmICh0b3VjaGVzLmxlbmd0aCA9PT0gMikgewogICAgICBjdXJyZW50VG91Y2hMZWZ0ID0gTWF0aC5hYnModG91Y2hlc1swXS5wYWdlWCArIHRvdWNoZXNbMV0ucGFnZVgpIC8gMjsKICAgICAgY3VycmVudFRvdWNoVG9wID0gTWF0aC5hYnModG91Y2hlc1swXS5wYWdlWSArIHRvdWNoZXNbMV0ucGFnZVkpIC8gMjsKCiAgICAgIC8vIENhbGN1bGF0ZSBzY2FsZSB3aGVuIG5vdCBwcmVzZW50IGFuZCBvbmx5IHdoZW4gdG91Y2hlcyBhcmUgdXNlZAogICAgICBpZiAoIXNjYWxlICYmIHNlbGYub3B0aW9ucy56b29taW5nKSB7CiAgICAgICAgc2NhbGUgPSBzZWxmLl9fZ2V0U2NhbGUoc2VsZi5fX2luaXRpYWxUb3VjaGVzLCB0b3VjaGVzKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY3VycmVudFRvdWNoTGVmdCA9IHRvdWNoZXNbMF0ucGFnZVg7CiAgICAgIGN1cnJlbnRUb3VjaFRvcCA9IHRvdWNoZXNbMF0ucGFnZVk7CiAgICB9CgogICAgdmFyIHBvc2l0aW9ucyA9IHNlbGYuX19wb3NpdGlvbnM7CgogICAgLy8gQXJlIHdlIGFscmVhZHkgaXMgZHJhZ2dpbmcgbW9kZT8KICAgIGlmIChzZWxmLl9faXNEcmFnZ2luZykgewoKICAgICAgLy8gQ29tcHV0ZSBtb3ZlIGRpc3RhbmNlCiAgICAgIHZhciBtb3ZlWCA9IGN1cnJlbnRUb3VjaExlZnQgLSBzZWxmLl9fbGFzdFRvdWNoTGVmdDsKICAgICAgdmFyIG1vdmVZID0gY3VycmVudFRvdWNoVG9wIC0gc2VsZi5fX2xhc3RUb3VjaFRvcDsKCiAgICAgIC8vIFJlYWQgcHJldmlvdXMgc2Nyb2xsIHBvc2l0aW9uIGFuZCB6b29taW5nCiAgICAgIHZhciBzY3JvbGxMZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQ7CiAgICAgIHZhciBzY3JvbGxUb3AgPSBzZWxmLl9fc2Nyb2xsVG9wOwogICAgICB2YXIgbGV2ZWwgPSBzZWxmLl9fem9vbUxldmVsOwoKICAgICAgLy8gV29yayB3aXRoIHNjYWxpbmcKICAgICAgaWYgKHNjYWxlICE9IG51bGwgJiYgc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKCiAgICAgICAgdmFyIG9sZExldmVsID0gbGV2ZWw7CgogICAgICAgIC8vIFJlY29tcHV0ZSBsZXZlbCBiYXNlZCBvbiBwcmV2aW91cyBzY2FsZSBhbmQgbmV3IHNjYWxlCiAgICAgICAgbGV2ZWwgPSBsZXZlbCAvIHNlbGYuX19sYXN0U2NhbGUgKiBzY2FsZTsKCiAgICAgICAgLy8gTGltaXQgbGV2ZWwgYWNjb3JkaW5nIHRvIGNvbmZpZ3VyYXRpb24KICAgICAgICBsZXZlbCA9IE1hdGgubWF4KE1hdGgubWluKGxldmVsLCBzZWxmLm9wdGlvbnMubWF4Wm9vbSksIHNlbGYub3B0aW9ucy5taW5ab29tKTsKCiAgICAgICAgLy8gT25seSBkbyBmdXJ0aGVyIGNvbXB1dGlvbiB3aGVuIGNoYW5nZSBoYXBwZW5lZAogICAgICAgIGlmIChvbGRMZXZlbCAhPT0gbGV2ZWwpIHsKCiAgICAgICAgICAvLyBDb21wdXRlIHJlbGF0aXZlIGV2ZW50IHBvc2l0aW9uIHRvIGNvbnRhaW5lcgogICAgICAgICAgdmFyIGN1cnJlbnRUb3VjaExlZnRSZWwgPSBjdXJyZW50VG91Y2hMZWZ0IC0gc2VsZi5fX2NsaWVudExlZnQ7CiAgICAgICAgICB2YXIgY3VycmVudFRvdWNoVG9wUmVsID0gY3VycmVudFRvdWNoVG9wIC0gc2VsZi5fX2NsaWVudFRvcDsKCiAgICAgICAgICAvLyBSZWNvbXB1dGUgbGVmdCBhbmQgdG9wIGNvb3JkaW5hdGVzIGJhc2VkIG9uIG5ldyB6b29tIGxldmVsCiAgICAgICAgICBzY3JvbGxMZWZ0ID0gKChjdXJyZW50VG91Y2hMZWZ0UmVsICsgc2Nyb2xsTGVmdCkgKiBsZXZlbCAvIG9sZExldmVsKSAtIGN1cnJlbnRUb3VjaExlZnRSZWw7CiAgICAgICAgICBzY3JvbGxUb3AgPSAoKGN1cnJlbnRUb3VjaFRvcFJlbCArIHNjcm9sbFRvcCkgKiBsZXZlbCAvIG9sZExldmVsKSAtIGN1cnJlbnRUb3VjaFRvcFJlbDsKCiAgICAgICAgICAvLyBSZWNvbXB1dGUgbWF4IHNjcm9sbCB2YWx1ZXMKICAgICAgICAgIHNlbGYuX19jb21wdXRlU2Nyb2xsTWF4KGxldmVsKTsKCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoc2VsZi5fX2VuYWJsZVNjcm9sbFgpIHsKCiAgICAgICAgc2Nyb2xsTGVmdCAtPSBtb3ZlWCAqIHRoaXMub3B0aW9ucy5zcGVlZE11bHRpcGxpZXI7CiAgICAgICAgdmFyIG1heFNjcm9sbExlZnQgPSBzZWxmLl9fbWF4U2Nyb2xsTGVmdDsKCiAgICAgICAgaWYgKHNjcm9sbExlZnQgPiBtYXhTY3JvbGxMZWZ0IHx8IHNjcm9sbExlZnQgPCAwKSB7CgogICAgICAgICAgLy8gU2xvdyBkb3duIG9uIHRoZSBlZGdlcwogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5ib3VuY2luZykgewoKICAgICAgICAgICAgc2Nyb2xsTGVmdCArPSAobW92ZVggLyAyICAqIHRoaXMub3B0aW9ucy5zcGVlZE11bHRpcGxpZXIpOwoKICAgICAgICAgIH0gZWxzZSBpZiAoc2Nyb2xsTGVmdCA+IG1heFNjcm9sbExlZnQpIHsKCiAgICAgICAgICAgIHNjcm9sbExlZnQgPSBtYXhTY3JvbGxMZWZ0OwoKICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBzY3JvbGxMZWZ0ID0gMDsKCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBDb21wdXRlIG5ldyB2ZXJ0aWNhbCBzY3JvbGwgcG9zaXRpb24KICAgICAgaWYgKHNlbGYuX19lbmFibGVTY3JvbGxZKSB7CgogICAgICAgIHNjcm9sbFRvcCAtPSBtb3ZlWSAqIHRoaXMub3B0aW9ucy5zcGVlZE11bHRpcGxpZXI7CiAgICAgICAgdmFyIG1heFNjcm9sbFRvcCA9IHNlbGYuX19tYXhTY3JvbGxUb3A7CgogICAgICAgIGlmIChzY3JvbGxUb3AgPiBtYXhTY3JvbGxUb3AgfHwgc2Nyb2xsVG9wIDwgMCkgewoKICAgICAgICAgIC8vIFNsb3cgZG93biBvbiB0aGUgZWRnZXMKICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuYm91bmNpbmcgfHwgKHNlbGYuX19yZWZyZXNoSGVpZ2h0ICYmIHNjcm9sbFRvcCA8IDApKSB7CgogICAgICAgICAgICBzY3JvbGxUb3AgKz0gKG1vdmVZIC8gMiAqIHRoaXMub3B0aW9ucy5zcGVlZE11bHRpcGxpZXIpOwoKICAgICAgICAgICAgLy8gU3VwcG9ydCBwdWxsLXRvLXJlZnJlc2ggKG9ubHkgd2hlbiBvbmx5IHkgaXMgc2Nyb2xsYWJsZSkKICAgICAgICAgICAgaWYgKCFzZWxmLl9fZW5hYmxlU2Nyb2xsWCAmJiBzZWxmLl9fcmVmcmVzaEhlaWdodCAhPSBudWxsKSB7CgogICAgICAgICAgICAgIC8vIGhpZGUgdGhlIHJlZnJlc2hlciB3aGVuIGl0J3MgYmVoaW5kIHRoZSBoZWFkZXIgYmFyIGluIGNhc2Ugb2YgaGVhZGVyIHRyYW5zcGFyZW5jeQogICAgICAgICAgICAgIGlmKHNjcm9sbFRvcCA8IDApewogICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hIaWRkZW4gPSBmYWxzZTsKICAgICAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoU2hvdygpOwogICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hIaWRlKCk7CiAgICAgICAgICAgICAgICBzZWxmLl9fcmVmcmVzaEhpZGRlbiA9IHRydWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoIXNlbGYuX19yZWZyZXNoQWN0aXZlICYmIHNjcm9sbFRvcCA8PSAtc2VsZi5fX3JlZnJlc2hIZWlnaHQpIHsKCiAgICAgICAgICAgICAgICBzZWxmLl9fcmVmcmVzaEFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hBY3RpdmF0ZSkgewogICAgICAgICAgICAgICAgICBzZWxmLl9fcmVmcmVzaEFjdGl2YXRlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2VsZi5fX3JlZnJlc2hBY3RpdmUgJiYgc2Nyb2xsVG9wID4gLXNlbGYuX19yZWZyZXNoSGVpZ2h0KSB7CgogICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUpIHsKICAgICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgIH0gZWxzZSBpZiAoc2Nyb2xsVG9wID4gbWF4U2Nyb2xsVG9wKSB7CgogICAgICAgICAgICBzY3JvbGxUb3AgPSBtYXhTY3JvbGxUb3A7CgogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIHNjcm9sbFRvcCA9IDA7CgogICAgICAgICAgfQogICAgICAgIH1lbHNlIGlmKHNlbGYuX19yZWZyZXNoSGVpZ2h0ICYmICFzZWxmLl9fcmVmcmVzaEhpZGRlbil7CiAgICAgICAgICAvLyBpZiBhIHBvc2l0aXZlIHNjcm9sbCB2YWx1ZSBhbmQgdGhlIHJlZnJlc2hlciBpcyBzdGlsbCBub3QgaGlkZGVuLCBoaWRlIGl0CiAgICAgICAgICBzZWxmLl9fcmVmcmVzaEhpZGUoKTsKICAgICAgICAgIHNlbGYuX19yZWZyZXNoSGlkZGVuID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEtlZXAgbGlzdCBmcm9tIGdyb3dpbmcgaW5maW5pdGVseSAoaG9sZGluZyBtaW4gMTAsIG1heCAyMCBtZWFzdXJlIHBvaW50cykKICAgICAgaWYgKHBvc2l0aW9ucy5sZW5ndGggPiA2MCkgewogICAgICAgIHBvc2l0aW9ucy5zcGxpY2UoMCwgMzApOwogICAgICB9CgogICAgICAvLyBUcmFjayBzY3JvbGwgbW92ZW1lbnQgZm9yIGRlY2xlcmF0aW9uCiAgICAgIHBvc2l0aW9ucy5wdXNoKHNjcm9sbExlZnQsIHNjcm9sbFRvcCwgdGltZVN0YW1wKTsKCiAgICAgIC8vIFN5bmMgc2Nyb2xsIHBvc2l0aW9uCiAgICAgIHNlbGYuX19wdWJsaXNoKHNjcm9sbExlZnQsIHNjcm9sbFRvcCwgbGV2ZWwpOwoKICAgIC8vIE90aGVyd2lzZSBmaWd1cmUgb3V0IHdoZXRoZXIgd2UgYXJlIHN3aXRjaGluZyBpbnRvIGRyYWdnaW5nIG1vZGUgbm93LgogICAgfSBlbHNlIHsKCiAgICAgIHZhciBtaW5pbXVtVHJhY2tpbmdGb3JTY3JvbGwgPSBzZWxmLm9wdGlvbnMubG9ja2luZyA/IDMgOiAwOwogICAgICB2YXIgbWluaW11bVRyYWNraW5nRm9yRHJhZyA9IDU7CgogICAgICB2YXIgZGlzdGFuY2VYID0gTWF0aC5hYnMoY3VycmVudFRvdWNoTGVmdCAtIHNlbGYuX19pbml0aWFsVG91Y2hMZWZ0KTsKICAgICAgdmFyIGRpc3RhbmNlWSA9IE1hdGguYWJzKGN1cnJlbnRUb3VjaFRvcCAtIHNlbGYuX19pbml0aWFsVG91Y2hUb3ApOwoKICAgICAgc2VsZi5fX2VuYWJsZVNjcm9sbFggPSBzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWCAmJiBkaXN0YW5jZVggPj0gbWluaW11bVRyYWNraW5nRm9yU2Nyb2xsOwogICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWSA9IHNlbGYub3B0aW9ucy5zY3JvbGxpbmdZICYmIGRpc3RhbmNlWSA+PSBtaW5pbXVtVHJhY2tpbmdGb3JTY3JvbGw7CgogICAgICBwb3NpdGlvbnMucHVzaChzZWxmLl9fc2Nyb2xsTGVmdCwgc2VsZi5fX3Njcm9sbFRvcCwgdGltZVN0YW1wKTsKCiAgICAgIHNlbGYuX19pc0RyYWdnaW5nID0gKHNlbGYuX19lbmFibGVTY3JvbGxYIHx8IHNlbGYuX19lbmFibGVTY3JvbGxZKSAmJiAoZGlzdGFuY2VYID49IG1pbmltdW1UcmFja2luZ0ZvckRyYWcgfHwgZGlzdGFuY2VZID49IG1pbmltdW1UcmFja2luZ0ZvckRyYWcpOwogICAgICBpZiAoc2VsZi5fX2lzRHJhZ2dpbmcpIHsKICAgICAgICBzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gPSBmYWxzZTsKICAgICAgICBzZWxmLl9fZmFkZVNjcm9sbGJhcnMoJ2luJyk7CiAgICAgIH0KCiAgICB9CgogICAgLy8gVXBkYXRlIGxhc3QgdG91Y2ggcG9zaXRpb25zIGFuZCB0aW1lIHN0YW1wIGZvciBuZXh0IGV2ZW50CiAgICBzZWxmLl9fbGFzdFRvdWNoTGVmdCA9IGN1cnJlbnRUb3VjaExlZnQ7CiAgICBzZWxmLl9fbGFzdFRvdWNoVG9wID0gY3VycmVudFRvdWNoVG9wOwogICAgc2VsZi5fX2xhc3RUb3VjaE1vdmUgPSB0aW1lU3RhbXA7CiAgICBzZWxmLl9fbGFzdFNjYWxlID0gc2NhbGU7CgogIH0sCgoKICAvKioKICAgKiBUb3VjaCBlbmQgaGFuZGxlciBmb3Igc2Nyb2xsaW5nIHN1cHBvcnQKICAgKi8KICBkb1RvdWNoRW5kOiBmdW5jdGlvbih0aW1lU3RhbXApIHsKICAgIGlmICh0aW1lU3RhbXAgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgIHRpbWVTdGFtcCA9IHRpbWVTdGFtcC52YWx1ZU9mKCk7CiAgICB9CiAgICBpZiAodHlwZW9mIHRpbWVTdGFtcCAhPT0gIm51bWJlciIpIHsKICAgICAgdGltZVN0YW1wID0gRGF0ZS5ub3coKTsKICAgIH0KCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgLy8gSWdub3JlIGV2ZW50IHdoZW4gdHJhY2tpbmcgaXMgbm90IGVuYWJsZWQgKG5vIHRvdWNoc3RhcnQgZXZlbnQgb24gZWxlbWVudCkKICAgIC8vIFRoaXMgaXMgcmVxdWlyZWQgYXMgdGhpcyBsaXN0ZW5lciAoJ3RvdWNobW92ZScpIHNpdHMgb24gdGhlIGRvY3VtZW50IGFuZCBub3Qgb24gdGhlIGVsZW1lbnQgaXRzZWxmLgogICAgaWYgKCFzZWxmLl9faXNUcmFja2luZykgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gTm90IHRvdWNoaW5nIGFueW1vcmUgKHdoZW4gdHdvIGZpbmdlciBoaXQgdGhlIHNjcmVlbiB0aGVyZSBhcmUgdHdvIHRvdWNoIGVuZCBldmVudHMpCiAgICBzZWxmLl9faXNUcmFja2luZyA9IGZhbHNlOwoKICAgIC8vIEJlIHN1cmUgdG8gcmVzZXQgdGhlIGRyYWdnaW5nIGZsYWcgbm93LiBIZXJlIHdlIGFsc28gZGV0ZWN0IHdoZXRoZXIKICAgIC8vIHRoZSBmaW5nZXIgaGFzIG1vdmVkIGZhc3QgZW5vdWdoIHRvIHN3aXRjaCBpbnRvIGEgZGVjZWxlcmF0aW9uIGFuaW1hdGlvbi4KICAgIGlmIChzZWxmLl9faXNEcmFnZ2luZykgewoKICAgICAgLy8gUmVzZXQgZHJhZ2dpbmcgZmxhZwogICAgICBzZWxmLl9faXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgLy8gU3RhcnQgZGVjZWxlcmF0aW9uCiAgICAgIC8vIFZlcmlmeSB0aGF0IHRoZSBsYXN0IG1vdmUgZGV0ZWN0ZWQgd2FzIGluIHNvbWUgcmVsZXZhbnQgdGltZSBmcmFtZQogICAgICBpZiAoc2VsZi5fX2lzU2luZ2xlVG91Y2ggJiYgc2VsZi5vcHRpb25zLmFuaW1hdGluZyAmJiAodGltZVN0YW1wIC0gc2VsZi5fX2xhc3RUb3VjaE1vdmUpIDw9IDEwMCkgewoKICAgICAgICAvLyBUaGVuIGZpZ3VyZSBvdXQgd2hhdCB0aGUgc2Nyb2xsIHBvc2l0aW9uIHdhcyBhYm91dCAxMDBtcyBhZ28KICAgICAgICB2YXIgcG9zaXRpb25zID0gc2VsZi5fX3Bvc2l0aW9uczsKICAgICAgICB2YXIgZW5kUG9zID0gcG9zaXRpb25zLmxlbmd0aCAtIDE7CiAgICAgICAgdmFyIHN0YXJ0UG9zID0gZW5kUG9zOwoKICAgICAgICAvLyBNb3ZlIHBvaW50ZXIgdG8gcG9zaXRpb24gbWVhc3VyZWQgMTAwbXMgYWdvCiAgICAgICAgZm9yICh2YXIgaSA9IGVuZFBvczsgaSA+IDAgJiYgcG9zaXRpb25zW2ldID4gKHNlbGYuX19sYXN0VG91Y2hNb3ZlIC0gMTAwKTsgaSAtPSAzKSB7CiAgICAgICAgICBzdGFydFBvcyA9IGk7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBzdGFydCBhbmQgc3RvcCBwb3NpdGlvbiBpcyBpZGVudGljYWwgaW4gYSAxMDBtcyB0aW1lZnJhbWUsCiAgICAgICAgLy8gd2UgY2Fubm90IGNvbXB1dGUgYW55IHVzZWZ1bCBkZWNlbGVyYXRpb24uCiAgICAgICAgaWYgKHN0YXJ0UG9zICE9PSBlbmRQb3MpIHsKCiAgICAgICAgICAvLyBDb21wdXRlIHJlbGF0aXZlIG1vdmVtZW50IGJldHdlZW4gdGhlc2UgdHdvIHBvaW50cwogICAgICAgICAgdmFyIHRpbWVPZmZzZXQgPSBwb3NpdGlvbnNbZW5kUG9zXSAtIHBvc2l0aW9uc1tzdGFydFBvc107CiAgICAgICAgICB2YXIgbW92ZWRMZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQgLSBwb3NpdGlvbnNbc3RhcnRQb3MgLSAyXTsKICAgICAgICAgIHZhciBtb3ZlZFRvcCA9IHNlbGYuX19zY3JvbGxUb3AgLSBwb3NpdGlvbnNbc3RhcnRQb3MgLSAxXTsKCiAgICAgICAgICAvLyBCYXNlZCBvbiA1MG1zIGNvbXB1dGUgdGhlIG1vdmVtZW50IHRvIGFwcGx5IGZvciBlYWNoIHJlbmRlciBzdGVwCiAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYID0gbW92ZWRMZWZ0IC8gdGltZU9mZnNldCAqICgxMDAwIC8gNjApOwogICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSA9IG1vdmVkVG9wIC8gdGltZU9mZnNldCAqICgxMDAwIC8gNjApOwoKICAgICAgICAgIC8vIEhvdyBtdWNoIHZlbG9jaXR5IGlzIHJlcXVpcmVkIHRvIHN0YXJ0IHRoZSBkZWNlbGVyYXRpb24KICAgICAgICAgIHZhciBtaW5WZWxvY2l0eVRvU3RhcnREZWNlbGVyYXRpb24gPSBzZWxmLm9wdGlvbnMucGFnaW5nIHx8IHNlbGYub3B0aW9ucy5zbmFwcGluZyA/IDQgOiAxOwoKICAgICAgICAgIC8vIFZlcmlmeSB0aGF0IHdlIGhhdmUgZW5vdWdoIHZlbG9jaXR5IHRvIHN0YXJ0IGRlY2VsZXJhdGlvbgogICAgICAgICAgaWYgKE1hdGguYWJzKHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVgpID4gbWluVmVsb2NpdHlUb1N0YXJ0RGVjZWxlcmF0aW9uIHx8IE1hdGguYWJzKHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkpID4gbWluVmVsb2NpdHlUb1N0YXJ0RGVjZWxlcmF0aW9uKSB7CgogICAgICAgICAgICAvLyBEZWFjdGl2YXRlIHB1bGwtdG8tcmVmcmVzaCB3aGVuIGRlY2VsZXJhdGluZwogICAgICAgICAgICBpZiAoIXNlbGYuX19yZWZyZXNoQWN0aXZlKSB7CiAgICAgICAgICAgICAgc2VsZi5fX3N0YXJ0RGVjZWxlcmF0aW9uKHRpbWVTdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5fX3Njcm9sbGluZ0NvbXBsZXRlKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCh0aW1lU3RhbXAgLSBzZWxmLl9fbGFzdFRvdWNoTW92ZSkgPiAxMDApIHsKICAgICAgICBzZWxmLl9fc2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgICAgfQogICAgfQoKICAgIC8vIElmIHRoaXMgd2FzIGEgc2xvd2VyIG1vdmUgaXQgaXMgcGVyIGRlZmF1bHQgbm9uIGRlY2VsZXJhdGVkLCBidXQgdGhpcwogICAgLy8gc3RpbGwgbWVhbnMgdGhhdCB3ZSB3YW50IHNuYXAgYmFjayB0byB0aGUgYm91bmRzIHdoaWNoIGlzIGRvbmUgaGVyZS4KICAgIC8vIFRoaXMgaXMgcGxhY2VkIG91dHNpZGUgdGhlIGNvbmRpdGlvbiBhYm92ZSB0byBpbXByb3ZlIGVkZ2UgY2FzZSBzdGFiaWxpdHkKICAgIC8vIGUuZy4gdG91Y2hlbmQgZmlyZWQgd2l0aG91dCBlbmFibGVkIGRyYWdnaW5nLiBUaGlzIHNob3VsZCBub3JtYWxseSBkbyBub3QKICAgIC8vIGhhdmUgbW9kaWZpZWQgdGhlIHNjcm9sbCBwb3NpdGlvbnMgb3IgZXZlbiBzaG93ZWQgdGhlIHNjcm9sbGJhcnMgdGhvdWdoLgogICAgaWYgKCFzZWxmLl9faXNEZWNlbGVyYXRpbmcpIHsKCiAgICAgIGlmIChzZWxmLl9fcmVmcmVzaEFjdGl2ZSAmJiBzZWxmLl9fcmVmcmVzaFN0YXJ0KSB7CgogICAgICAgIC8vIFVzZSBwdWJsaXNoIGluc3RlYWQgb2Ygc2Nyb2xsVG8gdG8gYWxsb3cgc2Nyb2xsaW5nIHRvIG91dCBvZiBib3VuZGFyeSBwb3NpdGlvbgogICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gbm9ybWFsaXplIHNjcm9sbExlZnQsIHpvb21MZXZlbCwgZXRjLiBoZXJlIGJlY2F1c2Ugd2Ugb25seSB5LXNjcm9sbGluZyB3aGVuIHB1bGwtdG8tcmVmcmVzaCBpcyBlbmFibGVkCiAgICAgICAgc2VsZi5fX3B1Ymxpc2goc2VsZi5fX3Njcm9sbExlZnQsIC1zZWxmLl9fcmVmcmVzaEhlaWdodCwgc2VsZi5fX3pvb21MZXZlbCwgdHJ1ZSk7CgogICAgICAgIGlmIChzZWxmLl9fcmVmcmVzaFN0YXJ0KSB7CiAgICAgICAgICBzZWxmLl9fcmVmcmVzaFN0YXJ0KCk7CiAgICAgICAgfQoKICAgICAgfSBlbHNlIHsKCiAgICAgICAgaWYgKHNlbGYuX19pbnRlcnJ1cHRlZEFuaW1hdGlvbiB8fCBzZWxmLl9faXNEcmFnZ2luZykgewogICAgICAgICAgc2VsZi5fX3Njcm9sbGluZ0NvbXBsZXRlKCk7CiAgICAgICAgfQogICAgICAgIHNlbGYuc2Nyb2xsVG8oc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHRydWUsIHNlbGYuX196b29tTGV2ZWwpOwoKICAgICAgICAvLyBEaXJlY3RseSBzaWduYWxpemUgZGVhY3RpdmF0aW9uIChub3RoaW5nIHRvZG8gb24gcmVmcmVzaD8pCiAgICAgICAgaWYgKHNlbGYuX19yZWZyZXNoQWN0aXZlKSB7CgogICAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmUgPSBmYWxzZTsKICAgICAgICAgIGlmIChzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUpIHsKICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKCk7CiAgICAgICAgICB9CgogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIEZ1bGx5IGNsZWFudXAgbGlzdAogICAgc2VsZi5fX3Bvc2l0aW9ucy5sZW5ndGggPSAwOwoKICB9LAoKCgogIC8qCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBQUklWQVRFIEFQSQogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICovCgogIC8qKgogICAqIEFwcGxpZXMgdGhlIHNjcm9sbCBwb3NpdGlvbiB0byB0aGUgY29udGVudCBlbGVtZW50CiAgICoKICAgKiBAcGFyYW0gbGVmdCB7TnVtYmVyfSBMZWZ0IHNjcm9sbCBwb3NpdGlvbgogICAqIEBwYXJhbSB0b3Age051bWJlcn0gVG9wIHNjcm9sbCBwb3NpdGlvbgogICAqIEBwYXJhbSBhbmltYXRlIHtCb29sZWFufSBXaGV0aGVyIGFuaW1hdGlvbiBzaG91bGQgYmUgdXNlZCB0byBtb3ZlIHRvIHRoZSBuZXcgY29vcmRpbmF0ZXMKICAgKi8KICBfX3B1Ymxpc2g6IGZ1bmN0aW9uKGxlZnQsIHRvcCwgem9vbSwgYW5pbWF0ZSwgd2FzUmVzaXplKSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIFJlbWVtYmVyIHdoZXRoZXIgd2UgaGFkIGFuIGFuaW1hdGlvbiwgdGhlbiB3ZSB0cnkgdG8gY29udGludWUgYmFzZWQgb24gdGhlIGN1cnJlbnQgImRyaXZlIiBvZiB0aGUgYW5pbWF0aW9uCiAgICB2YXIgd2FzQW5pbWF0aW5nID0gc2VsZi5fX2lzQW5pbWF0aW5nOwogICAgaWYgKHdhc0FuaW1hdGluZykgewogICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RvcCh3YXNBbmltYXRpbmcpOwogICAgICBzZWxmLl9faXNBbmltYXRpbmcgPSBmYWxzZTsKICAgIH0KCiAgICBpZiAoYW5pbWF0ZSAmJiBzZWxmLm9wdGlvbnMuYW5pbWF0aW5nKSB7CgogICAgICAvLyBLZWVwIHNjaGVkdWxlZCBwb3NpdGlvbnMgZm9yIHNjcm9sbEJ5L3pvb21CeSBmdW5jdGlvbmFsaXR5CiAgICAgIHNlbGYuX19zY2hlZHVsZWRMZWZ0ID0gbGVmdDsKICAgICAgc2VsZi5fX3NjaGVkdWxlZFRvcCA9IHRvcDsKICAgICAgc2VsZi5fX3NjaGVkdWxlZFpvb20gPSB6b29tOwoKICAgICAgdmFyIG9sZExlZnQgPSBzZWxmLl9fc2Nyb2xsTGVmdDsKICAgICAgdmFyIG9sZFRvcCA9IHNlbGYuX19zY3JvbGxUb3A7CiAgICAgIHZhciBvbGRab29tID0gc2VsZi5fX3pvb21MZXZlbDsKCiAgICAgIHZhciBkaWZmTGVmdCA9IGxlZnQgLSBvbGRMZWZ0OwogICAgICB2YXIgZGlmZlRvcCA9IHRvcCAtIG9sZFRvcDsKICAgICAgdmFyIGRpZmZab29tID0gem9vbSAtIG9sZFpvb207CgogICAgICB2YXIgc3RlcCA9IGZ1bmN0aW9uKHBlcmNlbnQsIG5vdywgcmVuZGVyKSB7CgogICAgICAgIGlmIChyZW5kZXIpIHsKCiAgICAgICAgICBzZWxmLl9fc2Nyb2xsTGVmdCA9IG9sZExlZnQgKyAoZGlmZkxlZnQgKiBwZXJjZW50KTsKICAgICAgICAgIHNlbGYuX19zY3JvbGxUb3AgPSBvbGRUb3AgKyAoZGlmZlRvcCAqIHBlcmNlbnQpOwogICAgICAgICAgc2VsZi5fX3pvb21MZXZlbCA9IG9sZFpvb20gKyAoZGlmZlpvb20gKiBwZXJjZW50KTsKCiAgICAgICAgICAvLyBQdXNoIHZhbHVlcyBvdXQKICAgICAgICAgIGlmIChzZWxmLl9fY2FsbGJhY2spIHsKICAgICAgICAgICAgc2VsZi5fX2NhbGxiYWNrKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fc2Nyb2xsVG9wLCBzZWxmLl9fem9vbUxldmVsLCB3YXNSZXNpemUpOwogICAgICAgICAgfQoKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgdmVyaWZ5ID0gZnVuY3Rpb24oaWQpIHsKICAgICAgICByZXR1cm4gc2VsZi5fX2lzQW5pbWF0aW5nID09PSBpZDsKICAgICAgfTsKCiAgICAgIHZhciBjb21wbGV0ZWQgPSBmdW5jdGlvbihyZW5kZXJlZEZyYW1lc1BlclNlY29uZCwgYW5pbWF0aW9uSWQsIHdhc0ZpbmlzaGVkKSB7CiAgICAgICAgaWYgKGFuaW1hdGlvbklkID09PSBzZWxmLl9faXNBbmltYXRpbmcpIHsKICAgICAgICAgIHNlbGYuX19pc0FuaW1hdGluZyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc2VsZi5fX2RpZERlY2VsZXJhdGlvbkNvbXBsZXRlIHx8IHdhc0ZpbmlzaGVkKSB7CiAgICAgICAgICBzZWxmLl9fc2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgICAgICB9CgogICAgICAgIGlmIChzZWxmLm9wdGlvbnMuem9vbWluZykgewogICAgICAgICAgc2VsZi5fX2NvbXB1dGVTY3JvbGxNYXgoKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICAvLyBXaGVuIGNvbnRpbnVpbmcgYmFzZWQgb24gcHJldmlvdXMgYW5pbWF0aW9uIHdlIGNob29zZSBhbiBlYXNlLW91dCBhbmltYXRpb24gaW5zdGVhZCBvZiBlYXNlLWluLW91dAogICAgICBzZWxmLl9faXNBbmltYXRpbmcgPSB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RhcnQoc3RlcCwgdmVyaWZ5LCBjb21wbGV0ZWQsIHNlbGYub3B0aW9ucy5hbmltYXRpb25EdXJhdGlvbiwgd2FzQW5pbWF0aW5nID8gZWFzZU91dEN1YmljIDogZWFzZUluT3V0Q3ViaWMpOwoKICAgIH0gZWxzZSB7CgogICAgICBzZWxmLl9fc2NoZWR1bGVkTGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0ID0gbGVmdDsKICAgICAgc2VsZi5fX3NjaGVkdWxlZFRvcCA9IHNlbGYuX19zY3JvbGxUb3AgPSB0b3A7CiAgICAgIHNlbGYuX19zY2hlZHVsZWRab29tID0gc2VsZi5fX3pvb21MZXZlbCA9IHpvb207CgogICAgICAvLyBQdXNoIHZhbHVlcyBvdXQKICAgICAgaWYgKHNlbGYuX19jYWxsYmFjaykgewogICAgICAgIHNlbGYuX19jYWxsYmFjayhsZWZ0LCB0b3AsIHpvb20sIHdhc1Jlc2l6ZSk7CiAgICAgIH0KCiAgICAgIC8vIEZpeCBtYXggc2Nyb2xsIHJhbmdlcwogICAgICBpZiAoc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKICAgICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heCgpOwogICAgICB9CiAgICB9CiAgfSwKCgogIC8qKgogICAqIFJlY29tcHV0ZXMgc2Nyb2xsIG1pbmltdW0gdmFsdWVzIGJhc2VkIG9uIGNsaWVudCBkaW1lbnNpb25zIGFuZCBjb250ZW50IGRpbWVuc2lvbnMuCiAgICovCiAgX19jb21wdXRlU2Nyb2xsTWF4OiBmdW5jdGlvbih6b29tTGV2ZWwpIHsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgaWYgKHpvb21MZXZlbCA9PSBudWxsKSB7CiAgICAgIHpvb21MZXZlbCA9IHNlbGYuX196b29tTGV2ZWw7CiAgICB9CgogICAgc2VsZi5fX21heFNjcm9sbExlZnQgPSBNYXRoLm1heCgoc2VsZi5fX2NvbnRlbnRXaWR0aCAqIHpvb21MZXZlbCkgLSBzZWxmLl9fY2xpZW50V2lkdGgsIDApOwogICAgc2VsZi5fX21heFNjcm9sbFRvcCA9IE1hdGgubWF4KChzZWxmLl9fY29udGVudEhlaWdodCAqIHpvb21MZXZlbCkgLSBzZWxmLl9fY2xpZW50SGVpZ2h0LCAwKTsKCiAgICBpZighc2VsZi5fX2RpZFdhaXRGb3JTaXplICYmICFzZWxmLl9fbWF4U2Nyb2xsTGVmdCAmJiAhc2VsZi5fX21heFNjcm9sbFRvcCkgewogICAgICBzZWxmLl9fZGlkV2FpdEZvclNpemUgPSB0cnVlOwogICAgICBzZWxmLl9fd2FpdEZvclNpemUoKTsKICAgIH0KICB9LAoKCiAgLyoqCiAgICogSWYgdGhlIHNjcm9sbCB2aWV3IGlzbid0IHNpemVkIGNvcnJlY3RseSBvbiBzdGFydCwgd2FpdCB1bnRpbCB3ZSBoYXZlIGF0IGxlYXN0IHNvbWUgc2l6ZQogICAqLwogIF9fd2FpdEZvclNpemU6IGZ1bmN0aW9uKCkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBjbGVhclRpbWVvdXQoc2VsZi5fX3NpemVyVGltZW91dCk7CgogICAgdmFyIHNpemVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHNlbGYucmVzaXplKCk7CgogICAgICBpZigoc2VsZi5vcHRpb25zLnNjcm9sbGluZ1ggJiYgIXNlbGYuX19tYXhTY3JvbGxMZWZ0KSB8fCAoc2VsZi5vcHRpb25zLnNjcm9sbGluZ1kgJiYgIXNlbGYuX19tYXhTY3JvbGxUb3ApKSB7CiAgICAgICAgLy9zZWxmLl9fc2l6ZXJUaW1lb3V0ID0gc2V0VGltZW91dChzaXplciwgMTAwMCk7CiAgICAgIH0KICAgIH07CgogICAgc2l6ZXIoKTsKICAgIHNlbGYuX19zaXplclRpbWVvdXQgPSBzZXRUaW1lb3V0KHNpemVyLCAxMDAwKTsKICB9LAoKICAvKgogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgQU5JTUFUSU9OIChERUNFTEVSQVRJT04pIFNVUFBPUlQKICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqLwoKICAvKioKICAgKiBDYWxsZWQgd2hlbiBhIHRvdWNoIHNlcXVlbmNlIGVuZCBhbmQgdGhlIHNwZWVkIG9mIHRoZSBmaW5nZXIgd2FzIGhpZ2ggZW5vdWdoCiAgICogdG8gc3dpdGNoIGludG8gZGVjZWxlcmF0aW9uIG1vZGUuCiAgICovCiAgX19zdGFydERlY2VsZXJhdGlvbjogZnVuY3Rpb24odGltZVN0YW1wKSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGlmIChzZWxmLm9wdGlvbnMucGFnaW5nKSB7CgogICAgICB2YXIgc2Nyb2xsTGVmdCA9IE1hdGgubWF4KE1hdGgubWluKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fbWF4U2Nyb2xsTGVmdCksIDApOwogICAgICB2YXIgc2Nyb2xsVG9wID0gTWF0aC5tYXgoTWF0aC5taW4oc2VsZi5fX3Njcm9sbFRvcCwgc2VsZi5fX21heFNjcm9sbFRvcCksIDApOwogICAgICB2YXIgY2xpZW50V2lkdGggPSBzZWxmLl9fY2xpZW50V2lkdGg7CiAgICAgIHZhciBjbGllbnRIZWlnaHQgPSBzZWxmLl9fY2xpZW50SGVpZ2h0OwoKICAgICAgLy8gV2UgbGltaXQgZGVjZWxlcmF0aW9uIG5vdCB0byB0aGUgbWluL21heCB2YWx1ZXMgb2YgdGhlIGFsbG93ZWQgcmFuZ2UsIGJ1dCB0byB0aGUgc2l6ZSBvZiB0aGUgdmlzaWJsZSBjbGllbnQgYXJlYS4KICAgICAgLy8gRWFjaCBwYWdlIHNob3VsZCBoYXZlIGV4YWN0bHkgdGhlIHNpemUgb2YgdGhlIGNsaWVudCBhcmVhLgogICAgICBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCA9IE1hdGguZmxvb3Ioc2Nyb2xsTGVmdCAvIGNsaWVudFdpZHRoKSAqIGNsaWVudFdpZHRoOwogICAgICBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wID0gTWF0aC5mbG9vcihzY3JvbGxUb3AgLyBjbGllbnRIZWlnaHQpICogY2xpZW50SGVpZ2h0OwogICAgICBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCA9IE1hdGguY2VpbChzY3JvbGxMZWZ0IC8gY2xpZW50V2lkdGgpICogY2xpZW50V2lkdGg7CiAgICAgIHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3AgPSBNYXRoLmNlaWwoc2Nyb2xsVG9wIC8gY2xpZW50SGVpZ2h0KSAqIGNsaWVudEhlaWdodDsKCiAgICB9IGVsc2UgewoKICAgICAgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbExlZnQgPSAwOwogICAgICBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wID0gMDsKICAgICAgc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbExlZnQgPSBzZWxmLl9fbWF4U2Nyb2xsTGVmdDsKICAgICAgc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbFRvcCA9IHNlbGYuX19tYXhTY3JvbGxUb3A7CgogICAgfQoKICAgIC8vIFdyYXAgY2xhc3MgbWV0aG9kCiAgICB2YXIgc3RlcCA9IGZ1bmN0aW9uKHBlcmNlbnQsIG5vdywgcmVuZGVyKSB7CiAgICAgIHNlbGYuX19zdGVwVGhyb3VnaERlY2VsZXJhdGlvbihyZW5kZXIpOwogICAgfTsKCiAgICAvLyBIb3cgbXVjaCB2ZWxvY2l0eSBpcyByZXF1aXJlZCB0byBrZWVwIHRoZSBkZWNlbGVyYXRpb24gcnVubmluZwogICAgc2VsZi5fX21pblZlbG9jaXR5VG9LZWVwRGVjZWxlcmF0aW5nID0gc2VsZi5vcHRpb25zLnNuYXBwaW5nID8gNCA6IDAuMTsKCiAgICAvLyBEZXRlY3Qgd2hldGhlciBpdCdzIHN0aWxsIHdvcnRoIHRvIGNvbnRpbnVlIGFuaW1hdGluZyBzdGVwcwogICAgLy8gSWYgd2UgYXJlIGFscmVhZHkgc2xvdyBlbm91Z2ggdG8gbm90IGJlaW5nIHVzZXIgcGVyY2VpdmFibGUgYW55bW9yZSwgd2Ugc3RvcCB0aGUgd2hvbGUgcHJvY2VzcyBoZXJlLgogICAgdmFyIHZlcmlmeSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2hvdWxkQ29udGludWUgPSBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYKSA+PSBzZWxmLl9fbWluVmVsb2NpdHlUb0tlZXBEZWNlbGVyYXRpbmcgfHwKICAgICAgICBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZKSA+PSBzZWxmLl9fbWluVmVsb2NpdHlUb0tlZXBEZWNlbGVyYXRpbmc7CiAgICAgIGlmICghc2hvdWxkQ29udGludWUpIHsKICAgICAgICBzZWxmLl9fZGlkRGVjZWxlcmF0aW9uQ29tcGxldGUgPSB0cnVlOwoKICAgICAgICAvL01ha2Ugc3VyZSB0aGUgc2Nyb2xsIHZhbHVlcyBhcmUgd2l0aGluIHRoZSBib3VuZGFyaWVzIGFmdGVyIGEgYm91bmNlLAogICAgICAgIC8vbm90IGJlbG93IDAgb3IgYWJvdmUgbWF4aW11bQogICAgICAgIGlmIChzZWxmLm9wdGlvbnMuYm91bmNpbmcpIHsKICAgICAgICAgIHNlbGYuc2Nyb2xsVG8oCiAgICAgICAgICAgIE1hdGgubWluKCBNYXRoLm1heChzZWxmLl9fc2Nyb2xsTGVmdCwgMCksIHNlbGYuX19tYXhTY3JvbGxMZWZ0ICksCiAgICAgICAgICAgIE1hdGgubWluKCBNYXRoLm1heChzZWxmLl9fc2Nyb2xsVG9wLCAwKSwgc2VsZi5fX21heFNjcm9sbFRvcCApLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNob3VsZENvbnRpbnVlOwogICAgfTsKCiAgICB2YXIgY29tcGxldGVkID0gZnVuY3Rpb24ocmVuZGVyZWRGcmFtZXNQZXJTZWNvbmQsIGFuaW1hdGlvbklkLCB3YXNGaW5pc2hlZCkgewogICAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSBmYWxzZTsKICAgICAgaWYgKHNlbGYuX19kaWREZWNlbGVyYXRpb25Db21wbGV0ZSkgewogICAgICAgIHNlbGYuX19zY3JvbGxpbmdDb21wbGV0ZSgpOwogICAgICB9CgogICAgICAvLyBBbmltYXRlIHRvIGdyaWQgd2hlbiBzbmFwcGluZyBpcyBhY3RpdmUsIG90aGVyd2lzZSBqdXN0IGZpeCBvdXQtb2YtYm91bmRhcnkgcG9zaXRpb25zCiAgICAgIGlmKHNlbGYub3B0aW9ucy5wYWdpbmcpIHsKICAgICAgICBzZWxmLnNjcm9sbFRvKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fc2Nyb2xsVG9wLCBzZWxmLm9wdGlvbnMuc25hcHBpbmcpOwogICAgICB9CiAgICB9OwoKICAgIC8vIFN0YXJ0IGFuaW1hdGlvbiBhbmQgc3dpdGNoIG9uIGZsYWcKICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdGFydChzdGVwLCB2ZXJpZnksIGNvbXBsZXRlZCk7CgogIH0sCgoKICAvKioKICAgKiBDYWxsZWQgb24gZXZlcnkgc3RlcCBvZiB0aGUgYW5pbWF0aW9uCiAgICoKICAgKiBAcGFyYW0gaW5NZW1vcnkge0Jvb2xlYW59IFdoZXRoZXIgdG8gbm90IHJlbmRlciB0aGUgY3VycmVudCBzdGVwLCBidXQga2VlcCBpdCBpbiBtZW1vcnkgb25seS4gVXNlZCBpbnRlcm5hbGx5IG9ubHkhCiAgICovCiAgX19zdGVwVGhyb3VnaERlY2VsZXJhdGlvbjogZnVuY3Rpb24ocmVuZGVyKSB7CgogICAgdmFyIHNlbGYgPSB0aGlzOwoKCiAgICAvLwogICAgLy8gQ09NUFVURSBORVhUIFNDUk9MTCBQT1NJVElPTgogICAgLy8KCiAgICAvLyBBZGQgZGVjZWxlcmF0aW9uIHRvIHNjcm9sbCBwb3NpdGlvbgogICAgdmFyIHNjcm9sbExlZnQgPSBzZWxmLl9fc2Nyb2xsTGVmdCArIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVg7Ly8gKiBzZWxmLm9wdGlvbnMuZGVjZWxlcmF0aW9uKTsKICAgIHZhciBzY3JvbGxUb3AgPSBzZWxmLl9fc2Nyb2xsVG9wICsgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WTsvLyAqIHNlbGYub3B0aW9ucy5kZWNlbGVyYXRpb24pOwoKCiAgICAvLwogICAgLy8gSEFSRCBMSU1JVCBTQ1JPTEwgUE9TSVRJT04gRk9SIE5PTiBCT1VOQ0lORyBNT0RFCiAgICAvLwoKICAgIGlmICghc2VsZi5vcHRpb25zLmJvdW5jaW5nKSB7CgogICAgICB2YXIgc2Nyb2xsTGVmdEZpeGVkID0gTWF0aC5tYXgoTWF0aC5taW4oc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbExlZnQsIHNjcm9sbExlZnQpLCBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCk7CiAgICAgIGlmIChzY3JvbGxMZWZ0Rml4ZWQgIT09IHNjcm9sbExlZnQpIHsKICAgICAgICBzY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdEZpeGVkOwogICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVggPSAwOwogICAgICB9CgogICAgICB2YXIgc2Nyb2xsVG9wRml4ZWQgPSBNYXRoLm1heChNYXRoLm1pbihzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wLCBzY3JvbGxUb3ApLCBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wKTsKICAgICAgaWYgKHNjcm9sbFRvcEZpeGVkICE9PSBzY3JvbGxUb3ApIHsKICAgICAgICBzY3JvbGxUb3AgPSBzY3JvbGxUb3BGaXhlZDsKICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZID0gMDsKICAgICAgfQoKICAgIH0KCgogICAgLy8KICAgIC8vIFVQREFURSBTQ1JPTEwgUE9TSVRJT04KICAgIC8vCgogICAgaWYgKHJlbmRlcikgewoKICAgICAgc2VsZi5fX3B1Ymxpc2goc2Nyb2xsTGVmdCwgc2Nyb2xsVG9wLCBzZWxmLl9fem9vbUxldmVsKTsKCiAgICB9IGVsc2UgewoKICAgICAgc2VsZi5fX3Njcm9sbExlZnQgPSBzY3JvbGxMZWZ0OwogICAgICBzZWxmLl9fc2Nyb2xsVG9wID0gc2Nyb2xsVG9wOwoKICAgIH0KCgogICAgLy8KICAgIC8vIFNMT1cgRE9XTgogICAgLy8KCiAgICAvLyBTbG93IGRvd24gdmVsb2NpdHkgb24gZXZlcnkgaXRlcmF0aW9uCiAgICBpZiAoIXNlbGYub3B0aW9ucy5wYWdpbmcpIHsKCiAgICAgIC8vIFRoaXMgaXMgdGhlIGZhY3RvciBhcHBsaWVkIHRvIGV2ZXJ5IGl0ZXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uCiAgICAgIC8vIHRvIHNsb3cgZG93biB0aGUgcHJvY2Vzcy4gVGhpcyBzaG91bGQgZW11bGF0ZSBuYXR1cmFsIGJlaGF2aW9yIHdoZXJlCiAgICAgIC8vIG9iamVjdHMgc2xvdyBkb3duIHdoZW4gdGhlIGluaXRpYXRvciBvZiB0aGUgbW92ZW1lbnQgaXMgcmVtb3ZlZAogICAgICB2YXIgZnJpY3Rpb25GYWN0b3IgPSBzZWxmLm9wdGlvbnMuZGVjZWxlcmF0aW9uOwoKICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCAqPSBmcmljdGlvbkZhY3RvcjsKICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSAqPSBmcmljdGlvbkZhY3RvcjsKCiAgICB9CgoKICAgIC8vCiAgICAvLyBCT1VOQ0lORyBTVVBQT1JUCiAgICAvLwoKICAgIGlmIChzZWxmLm9wdGlvbnMuYm91bmNpbmcpIHsKCiAgICAgIHZhciBzY3JvbGxPdXRzaWRlWCA9IDA7CiAgICAgIHZhciBzY3JvbGxPdXRzaWRlWSA9IDA7CgogICAgICAvLyBUaGlzIGNvbmZpZ3VyZXMgdGhlIGFtb3VudCBvZiBjaGFuZ2UgYXBwbGllZCB0byBkZWNlbGVyYXRpb24vYWNjZWxlcmF0aW9uIHdoZW4gcmVhY2hpbmcgYm91bmRhcmllcwogICAgICB2YXIgcGVuZXRyYXRpb25EZWNlbGVyYXRpb24gPSBzZWxmLm9wdGlvbnMucGVuZXRyYXRpb25EZWNlbGVyYXRpb247CiAgICAgIHZhciBwZW5ldHJhdGlvbkFjY2VsZXJhdGlvbiA9IHNlbGYub3B0aW9ucy5wZW5ldHJhdGlvbkFjY2VsZXJhdGlvbjsKCiAgICAgIC8vIENoZWNrIGxpbWl0cwogICAgICBpZiAoc2Nyb2xsTGVmdCA8IHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxMZWZ0KSB7CiAgICAgICAgc2Nyb2xsT3V0c2lkZVggPSBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCAtIHNjcm9sbExlZnQ7CiAgICAgIH0gZWxzZSBpZiAoc2Nyb2xsTGVmdCA+IHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0KSB7CiAgICAgICAgc2Nyb2xsT3V0c2lkZVggPSBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCAtIHNjcm9sbExlZnQ7CiAgICAgIH0KCiAgICAgIGlmIChzY3JvbGxUb3AgPCBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wKSB7CiAgICAgICAgc2Nyb2xsT3V0c2lkZVkgPSBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wIC0gc2Nyb2xsVG9wOwogICAgICB9IGVsc2UgaWYgKHNjcm9sbFRvcCA+IHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3ApIHsKICAgICAgICBzY3JvbGxPdXRzaWRlWSA9IHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3AgLSBzY3JvbGxUb3A7CiAgICAgIH0KCiAgICAgIC8vIFNsb3cgZG93biB1bnRpbCBzbG93IGVub3VnaCwgdGhlbiBmbGlwIGJhY2sgdG8gc25hcCBwb3NpdGlvbgogICAgICBpZiAoc2Nyb2xsT3V0c2lkZVggIT09IDApIHsKICAgICAgICB2YXIgaXNIZWFkaW5nT3V0d2FyZHNYID0gc2Nyb2xsT3V0c2lkZVggKiBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYIDw9IHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxMZWZ0OwogICAgICAgIGlmIChpc0hlYWRpbmdPdXR3YXJkc1gpIHsKICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVggKz0gc2Nyb2xsT3V0c2lkZVggKiBwZW5ldHJhdGlvbkRlY2VsZXJhdGlvbjsKICAgICAgICB9CiAgICAgICAgdmFyIGlzU3RvcHBlZFggPSBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYKSA8PSBzZWxmLl9fbWluVmVsb2NpdHlUb0tlZXBEZWNlbGVyYXRpbmc7CiAgICAgICAgLy9JZiB3ZSdyZSBub3QgaGVhZGluZyBvdXR3YXJkcywgb3IgaWYgdGhlIGFib3ZlIHN0YXRlbWVudCBnb3QgdXMgYmVsb3cgbWluRGVjZWxlcmF0aW9uLCBnbyBiYWNrIHRvd2FyZHMgYm91bmRzCiAgICAgICAgaWYgKCFpc0hlYWRpbmdPdXR3YXJkc1ggfHwgaXNTdG9wcGVkWCkgewogICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCA9IHNjcm9sbE91dHNpZGVYICogcGVuZXRyYXRpb25BY2NlbGVyYXRpb247CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoc2Nyb2xsT3V0c2lkZVkgIT09IDApIHsKICAgICAgICB2YXIgaXNIZWFkaW5nT3V0d2FyZHNZID0gc2Nyb2xsT3V0c2lkZVkgKiBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZIDw9IHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxUb3A7CiAgICAgICAgaWYgKGlzSGVhZGluZ091dHdhcmRzWSkgewogICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSArPSBzY3JvbGxPdXRzaWRlWSAqIHBlbmV0cmF0aW9uRGVjZWxlcmF0aW9uOwogICAgICAgIH0KICAgICAgICB2YXIgaXNTdG9wcGVkWSA9IE1hdGguYWJzKHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkpIDw9IHNlbGYuX19taW5WZWxvY2l0eVRvS2VlcERlY2VsZXJhdGluZzsKICAgICAgICAvL0lmIHdlJ3JlIG5vdCBoZWFkaW5nIG91dHdhcmRzLCBvciBpZiB0aGUgYWJvdmUgc3RhdGVtZW50IGdvdCB1cyBiZWxvdyBtaW5EZWNlbGVyYXRpb24sIGdvIGJhY2sgdG93YXJkcyBib3VuZHMKICAgICAgICBpZiAoIWlzSGVhZGluZ091dHdhcmRzWSB8fCBpc1N0b3BwZWRZKSB7CiAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZID0gc2Nyb2xsT3V0c2lkZVkgKiBwZW5ldHJhdGlvbkFjY2VsZXJhdGlvbjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAoKCiAgLyoqCiAgICogY2FsY3VsYXRlIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHR3byB0b3VjaGVzCiAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gxCiAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gyCiAgICogQHJldHVybnMge051bWJlcn0gICAgZGlzdGFuY2UKICAgKi8KICBfX2dldERpc3RhbmNlOiBmdW5jdGlvbiBnZXREaXN0YW5jZSh0b3VjaDEsIHRvdWNoMikgewogICAgdmFyIHggPSB0b3VjaDIucGFnZVggLSB0b3VjaDEucGFnZVgsCiAgICB5ID0gdG91Y2gyLnBhZ2VZIC0gdG91Y2gxLnBhZ2VZOwogICAgcmV0dXJuIE1hdGguc3FydCgoeCp4KSArICh5KnkpKTsKICB9LAoKCiAgLyoqCiAgICogY2FsY3VsYXRlIHRoZSBzY2FsZSBmYWN0b3IgYmV0d2VlbiB0d28gdG91Y2hMaXN0cyAoZmluZ2VycykKICAgKiBubyBzY2FsZSBpcyAxLCBhbmQgZ29lcyBkb3duIHRvIDAgd2hlbiBwaW5jaGVkIHRvZ2V0aGVyLCBhbmQgYmlnZ2VyIHdoZW4gcGluY2hlZCBvdXQKICAgKiBAcGFyYW0gICB7QXJyYXl9ICAgICBzdGFydAogICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIGVuZAogICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIHNjYWxlCiAgICovCiAgX19nZXRTY2FsZTogZnVuY3Rpb24gZ2V0U2NhbGUoc3RhcnQsIGVuZCkgewoKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBuZWVkIHR3byBmaW5nZXJzLi4uCiAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgcmV0dXJuIHNlbGYuX19nZXREaXN0YW5jZShlbmRbMF0sIGVuZFsxXSkgLwogICAgICAgIHNlbGYuX19nZXREaXN0YW5jZShzdGFydFswXSwgc3RhcnRbMV0pOwogICAgfQogICAgcmV0dXJuIDE7CiAgfQp9KTsKCmlvbmljLnNjcm9sbCA9IHsKICBpc1Njcm9sbGluZzogZmFsc2UsCiAgbGFzdFRvcDogMAp9OwoKfSkoaW9uaWMpOwoKKGZ1bmN0aW9uKGlvbmljKSB7Cid1c2Ugc3RyaWN0JzsKCiAgaW9uaWMudmlld3MuSGVhZGVyQmFyID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgdGhpcy5lbCA9IG9wdHMuZWw7CgogICAgICBpb25pYy5leHRlbmQodGhpcywgewogICAgICAgIGFsaWduVGl0bGU6ICdjZW50ZXInCiAgICAgIH0sIG9wdHMpOwoKICAgICAgdGhpcy5hbGlnbigpOwogICAgfSwKCiAgICBhbGlnbjogZnVuY3Rpb24oYWxpZ24pIHsKCiAgICAgIGFsaWduIHx8IChhbGlnbiA9IHRoaXMuYWxpZ25UaXRsZSk7CgogICAgICAvLyBGaW5kIHRoZSB0aXRsZUVsIGVsZW1lbnQKICAgICAgdmFyIHRpdGxlRWwgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3IoJy50aXRsZScpOwogICAgICBpZighdGl0bGVFbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAvL1dlIGhhdmUgdG8gckFGIGhlcmUgc28gYWxsIG9mIHRoZSBlbGVtZW50cyBoYXZlIHRpbWUgdG8gaW5pdGlhbGl6ZQogICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGksIGMsIGNoaWxkU2l6ZTsKICAgICAgICB2YXIgY2hpbGROb2RlcyA9IHNlbGYuZWwuY2hpbGROb2RlczsKICAgICAgICB2YXIgbGVmdFdpZHRoID0gMDsKICAgICAgICB2YXIgcmlnaHRXaWR0aCA9IDA7CiAgICAgICAgdmFyIGlzQ291bnRpbmdSaWdodFdpZHRoID0gZmFsc2U7CgogICAgICAgIC8vIENvbXB1dGUgaG93IHdpZGUgdGhlIGxlZnQgY2hpbGRyZW4gYXJlCiAgICAgICAgLy8gU2tpcCBhbGwgdGl0bGVzICh0aGVyZSBtYXkgc3RpbGwgYmUgdHdvIHRpdGxlcywgb25lIGxlYXZpbmcgdGhlIGRvbSkKICAgICAgICAvLyBPbmNlIHdlIGVuY291bnRlciBhIHRpdGxlRWwsIHJlYWxpemUgd2UgYXJlIG5vdyBjb3VudGluZyB0aGUgcmlnaHQtYnV0dG9ucywgbm90IGxlZnQKICAgICAgICBmb3IoaSA9IDA7IGkgPCBjaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjID0gY2hpbGROb2Rlc1tpXTsKICAgICAgICAgIGlmIChjLnRhZ05hbWUgJiYgYy50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gJ2gxJykgewogICAgICAgICAgICBpc0NvdW50aW5nUmlnaHRXaWR0aCA9IHRydWU7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGNoaWxkU2l6ZSA9IG51bGw7CiAgICAgICAgICBpZihjLm5vZGVUeXBlID09IDMpIHsKICAgICAgICAgICAgdmFyIGJvdW5kcyA9IGlvbmljLkRvbVV0aWwuZ2V0VGV4dEJvdW5kcyhjKTsKICAgICAgICAgICAgaWYoYm91bmRzKSB7CiAgICAgICAgICAgICAgY2hpbGRTaXplID0gYm91bmRzLndpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYoYy5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgICAgIGNoaWxkU2l6ZSA9IGMub2Zmc2V0V2lkdGg7CiAgICAgICAgICB9CiAgICAgICAgICBpZihjaGlsZFNpemUpIHsKICAgICAgICAgICAgaWYgKGlzQ291bnRpbmdSaWdodFdpZHRoKSB7CiAgICAgICAgICAgICAgcmlnaHRXaWR0aCArPSBjaGlsZFNpemU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGVmdFdpZHRoICs9IGNoaWxkU2l6ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIG1hcmdpbiA9IE1hdGgubWF4KGxlZnRXaWR0aCwgcmlnaHRXaWR0aCkgKyAxMDsKCiAgICAgICAgLy9SZXNldCBsZWZ0IGFuZCByaWdodCBiZWZvcmUgc2V0dGluZyBhZ2FpbgogICAgICAgIHRpdGxlRWwuc3R5bGUubGVmdCA9IHRpdGxlRWwuc3R5bGUucmlnaHQgPSAnJzsKCiAgICAgICAgLy8gU2l6ZSBhbmQgYWxpZ24gdGhlIGhlYWRlciB0aXRsZUVsIGJhc2VkIG9uIHRoZSBzaXplcyBvZiB0aGUgbGVmdCBhbmQKICAgICAgICAvLyByaWdodCBjaGlsZHJlbiwgYW5kIHRoZSBkZXNpcmVkIGFsaWdubWVudCBtb2RlCiAgICAgICAgaWYoYWxpZ24gPT0gJ2NlbnRlcicpIHsKICAgICAgICAgIGlmKG1hcmdpbiA+IDEwKSB7CiAgICAgICAgICAgIHRpdGxlRWwuc3R5bGUubGVmdCA9IG1hcmdpbiArICdweCc7CiAgICAgICAgICAgIHRpdGxlRWwuc3R5bGUucmlnaHQgPSBtYXJnaW4gKyAncHgnOwogICAgICAgICAgfQogICAgICAgICAgaWYodGl0bGVFbC5vZmZzZXRXaWR0aCA8IHRpdGxlRWwuc2Nyb2xsV2lkdGgpIHsKICAgICAgICAgICAgaWYocmlnaHRXaWR0aCA+IDApIHsKICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLnJpZ2h0ID0gKHJpZ2h0V2lkdGggKyA1KSArICdweCc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYoYWxpZ24gPT0gJ2xlZnQnKSB7CiAgICAgICAgICB0aXRsZUVsLmNsYXNzTGlzdC5hZGQoJ3RpdGxlLWxlZnQnKTsKICAgICAgICAgIGlmKGxlZnRXaWR0aCA+IDApIHsKICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5sZWZ0ID0gKGxlZnRXaWR0aCArIDE1KSArICdweCc7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmKGFsaWduID09ICdyaWdodCcpIHsKICAgICAgICAgIHRpdGxlRWwuY2xhc3NMaXN0LmFkZCgndGl0bGUtcmlnaHQnKTsKICAgICAgICAgIGlmKHJpZ2h0V2lkdGggPiAwKSB7CiAgICAgICAgICAgIHRpdGxlRWwuc3R5bGUucmlnaHQgPSAocmlnaHRXaWR0aCArIDE1KSArICdweCc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9KTsKCn0pKGlvbmljKTsKCihmdW5jdGlvbihpb25pYykgewondXNlIHN0cmljdCc7CgogIHZhciBJVEVNX0NMQVNTID0gJ2l0ZW0nOwogIHZhciBJVEVNX0NPTlRFTlRfQ0xBU1MgPSAnaXRlbS1jb250ZW50JzsKICB2YXIgSVRFTV9TTElESU5HX0NMQVNTID0gJ2l0ZW0tc2xpZGluZyc7CiAgdmFyIElURU1fT1BUSU9OU19DTEFTUyA9ICdpdGVtLW9wdGlvbnMnOwogIHZhciBJVEVNX1BMQUNFSE9MREVSX0NMQVNTID0gJ2l0ZW0tcGxhY2Vob2xkZXInOwogIHZhciBJVEVNX1JFT1JERVJJTkdfQ0xBU1MgPSAnaXRlbS1yZW9yZGVyaW5nJzsKICB2YXIgSVRFTV9SRU9SREVSX0JUTl9DTEFTUyA9ICdpdGVtLXJlb3JkZXInOwoKICB2YXIgRHJhZ09wID0gZnVuY3Rpb24oKSB7fTsKICBEcmFnT3AucHJvdG90eXBlID0gewogICAgc3RhcnQ6IGZ1bmN0aW9uKGUpIHsKICAgIH0sCiAgICBkcmFnOiBmdW5jdGlvbihlKSB7CiAgICB9LAogICAgZW5kOiBmdW5jdGlvbihlKSB7CiAgICB9LAogICAgaXNTYW1lSXRlbTogZnVuY3Rpb24oaXRlbSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfTsKCiAgdmFyIFNsaWRlRHJhZyA9IGZ1bmN0aW9uKG9wdHMpIHsKICAgIHRoaXMuZHJhZ1RocmVzaG9sZFggPSBvcHRzLmRyYWdUaHJlc2hvbGRYIHx8IDEwOwogICAgdGhpcy5lbCA9IG9wdHMuZWw7CiAgICB0aGlzLmNhblN3aXBlID0gb3B0cy5jYW5Td2lwZTsKICB9OwoKICBTbGlkZURyYWcucHJvdG90eXBlID0gbmV3IERyYWdPcCgpOwoKICBTbGlkZURyYWcucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24oZSkgewogICAgdmFyIGNvbnRlbnQsIGJ1dHRvbnMsIG9mZnNldFgsIGJ1dHRvbnNXaWR0aDsKCiAgICBpZiAoIXRoaXMuY2FuU3dpcGUoKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYoZS50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKElURU1fQ09OVEVOVF9DTEFTUykpIHsKICAgICAgY29udGVudCA9IGUudGFyZ2V0OwogICAgfSBlbHNlIGlmKGUudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyhJVEVNX0NMQVNTKSkgewogICAgICBjb250ZW50ID0gZS50YXJnZXQucXVlcnlTZWxlY3RvcignLicgKyBJVEVNX0NPTlRFTlRfQ0xBU1MpOwogICAgfSBlbHNlIHsKICAgICAgY29udGVudCA9IGlvbmljLkRvbVV0aWwuZ2V0UGFyZW50V2l0aENsYXNzKGUudGFyZ2V0LCBJVEVNX0NPTlRFTlRfQ0xBU1MpOwogICAgfQoKICAgIC8vIElmIHdlIGRvbid0IGhhdmUgYSBjb250ZW50IGFyZWEgYXMgb25lIG9mIG91ciBjaGlsZHJlbiAob3Igb3Vyc2VsdmVzKSwgc2tpcAogICAgaWYoIWNvbnRlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIE1ha2Ugc3VyZSB3ZSBhcmVuJ3QgYW5pbWF0aW5nIGFzIHdlIHNsaWRlCiAgICBjb250ZW50LmNsYXNzTGlzdC5yZW1vdmUoSVRFTV9TTElESU5HX0NMQVNTKTsKCiAgICAvLyBHcmFiIHRoZSBzdGFydGluZyBYIHBvaW50IGZvciB0aGUgaXRlbSAoZm9yIGV4YW1wbGUsIHNvIHdlIGNhbiB0ZWxsIHdoZXRoZXIgaXQgaXMgb3BlbiBvciBjbG9zZWQgdG8gc3RhcnQpCiAgICBvZmZzZXRYID0gcGFyc2VGbG9hdChjb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dLnJlcGxhY2UoJ3RyYW5zbGF0ZTNkKCcsICcnKS5zcGxpdCgnLCcpWzBdKSB8fCAwOwoKICAgIC8vIEdyYWIgdGhlIGJ1dHRvbnMKICAgIGJ1dHRvbnMgPSBjb250ZW50LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignLicgKyBJVEVNX09QVElPTlNfQ0xBU1MpOwogICAgaWYoIWJ1dHRvbnMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgYnV0dG9ucy5jbGFzc0xpc3QucmVtb3ZlKCdpbnZpc2libGUnKTsKCiAgICBidXR0b25zV2lkdGggPSBidXR0b25zLm9mZnNldFdpZHRoOwoKICAgIHRoaXMuX2N1cnJlbnREcmFnID0gewogICAgICBidXR0b25zOiBidXR0b25zLAogICAgICBidXR0b25zV2lkdGg6IGJ1dHRvbnNXaWR0aCwKICAgICAgY29udGVudDogY29udGVudCwKICAgICAgc3RhcnRPZmZzZXRYOiBvZmZzZXRYCiAgICB9OwogIH07CgogIC8qKgogICAqIENoZWNrIGlmIHRoaXMgaXMgdGhlIHNhbWUgaXRlbSB0aGF0IHdhcyBwcmV2aW91c2x5IGRyYWdnZWQuCiAgICovCiAgU2xpZGVEcmFnLnByb3RvdHlwZS5pc1NhbWVJdGVtID0gZnVuY3Rpb24ob3ApIHsKICAgIGlmKG9wLl9sYXN0RHJhZyAmJiB0aGlzLl9jdXJyZW50RHJhZykgewogICAgICByZXR1cm4gdGhpcy5fY3VycmVudERyYWcuY29udGVudCA9PSBvcC5fbGFzdERyYWcuY29udGVudDsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9OwoKICBTbGlkZURyYWcucHJvdG90eXBlLmNsZWFuID0gZnVuY3Rpb24oZSkgewogICAgdmFyIGxhc3REcmFnID0gdGhpcy5fbGFzdERyYWc7CgogICAgaWYoIWxhc3REcmFnKSByZXR1cm47CgogICAgbGFzdERyYWcuY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNJVElPTl0gPSAnJzsKICAgIGxhc3REcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAnJzsKICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBsYXN0RHJhZy5idXR0b25zICYmIGxhc3REcmFnLmJ1dHRvbnMuY2xhc3NMaXN0LmFkZCgnaW52aXNpYmxlJyk7CiAgICAgIH0sIDI1MCk7CiAgICB9KTsKICB9OwoKICBTbGlkZURyYWcucHJvdG90eXBlLmRyYWcgPSBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKGUpIHsKICAgIHZhciBidXR0b25zV2lkdGg7CgogICAgLy8gV2UgcmVhbGx5IGFyZW4ndCBkcmFnZ2luZwogICAgaWYoIXRoaXMuX2N1cnJlbnREcmFnKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBDaGVjayBpZiB3ZSBzaG91bGQgc3RhcnQgZHJhZ2dpbmcuIENoZWNrIGlmIHdlJ3ZlIGRyYWdnZWQgcGFzdCB0aGUgdGhyZXNob2xkLAogICAgLy8gb3Igd2UgYXJlIHN0YXJ0aW5nIGZyb20gdGhlIG9wZW4gc3RhdGUuCiAgICBpZighdGhpcy5faXNEcmFnZ2luZyAmJgogICAgICAgICgoTWF0aC5hYnMoZS5nZXN0dXJlLmRlbHRhWCkgPiB0aGlzLmRyYWdUaHJlc2hvbGRYKSB8fAogICAgICAgIChNYXRoLmFicyh0aGlzLl9jdXJyZW50RHJhZy5zdGFydE9mZnNldFgpID4gMCkpKQogICAgewogICAgICB0aGlzLl9pc0RyYWdnaW5nID0gdHJ1ZTsKICAgIH0KCiAgICBpZih0aGlzLl9pc0RyYWdnaW5nKSB7CiAgICAgIGJ1dHRvbnNXaWR0aCA9IHRoaXMuX2N1cnJlbnREcmFnLmJ1dHRvbnNXaWR0aDsKCiAgICAgIC8vIEdyYWIgdGhlIG5ldyBYIHBvaW50LCBjYXBwaW5nIGl0IGF0IHplcm8KICAgICAgdmFyIG5ld1ggPSBNYXRoLm1pbigwLCB0aGlzLl9jdXJyZW50RHJhZy5zdGFydE9mZnNldFggKyBlLmdlc3R1cmUuZGVsdGFYKTsKCiAgICAgIC8vIElmIHRoZSBuZXcgWCBwb3NpdGlvbiBpcyBwYXN0IHRoZSBidXR0b25zLCB3ZSBuZWVkIHRvIHNsb3cgZG93biB0aGUgZHJhZyAocnViYmVyIGJhbmQgc3R5bGUpCiAgICAgIGlmKG5ld1ggPCAtYnV0dG9uc1dpZHRoKSB7CiAgICAgICAgLy8gQ2FsY3VsYXRlIHRoZSBuZXcgWCBwb3NpdGlvbiwgY2FwcGVkIGF0IHRoZSB0b3Agb2YgdGhlIGJ1dHRvbnMKICAgICAgICBuZXdYID0gTWF0aC5taW4oLWJ1dHRvbnNXaWR0aCwgLWJ1dHRvbnNXaWR0aCArICgoKGUuZ2VzdHVyZS5kZWx0YVggKyBidXR0b25zV2lkdGgpICogMC40KSkpOwogICAgICB9CgogICAgICB0aGlzLl9jdXJyZW50RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKCcgKyBuZXdYICsgJ3B4LCAwLCAwKSc7CiAgICAgIHRoaXMuX2N1cnJlbnREcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TSVRJT05dID0gJ25vbmUnOwogICAgfQogIH0pOwoKICBTbGlkZURyYWcucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uKGUsIGRvbmVDYWxsYmFjaykgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAvLyBUaGVyZSBpcyBubyBkcmFnLCBqdXN0IGVuZCBpbW1lZGlhdGVseQogICAgaWYoIXRoaXMuX2N1cnJlbnREcmFnKSB7CiAgICAgIGRvbmVDYWxsYmFjayAmJiBkb25lQ2FsbGJhY2soKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIElmIHdlIGFyZSBjdXJyZW50bHkgZHJhZ2dpbmcsIHdlIHdhbnQgdG8gc25hcCBiYWNrIGludG8gcGxhY2UKICAgIC8vIFRoZSBmaW5hbCByZXN0aW5nIHBvaW50IFggd2lsbCBiZSB0aGUgd2lkdGggb2YgdGhlIGV4cG9zZWQgYnV0dG9ucwogICAgdmFyIHJlc3RpbmdQb2ludCA9IC10aGlzLl9jdXJyZW50RHJhZy5idXR0b25zV2lkdGg7CgogICAgLy8gQ2hlY2sgaWYgdGhlIGRyYWcgZGlkbid0IGNsZWFyIHRoZSBidXR0b25zIG1pZC1wb2ludAogICAgLy8gYW5kIHdlIGFyZW4ndCBtb3ZpbmcgZmFzdCBlbm91Z2ggdG8gc3dpcGUgb3BlbgogICAgaWYoZS5nZXN0dXJlLmRlbHRhWCA+IC0odGhpcy5fY3VycmVudERyYWcuYnV0dG9uc1dpZHRoLzIpKSB7CgogICAgICAvLyBJZiB3ZSBhcmUgZ29pbmcgbGVmdCBidXQgdG9vIHNsb3csIG9yIGdvaW5nIHJpZ2h0LCBnbyBiYWNrIHRvIHJlc3RpbmcKICAgICAgaWYoZS5nZXN0dXJlLmRpcmVjdGlvbiA9PSAibGVmdCIgJiYgTWF0aC5hYnMoZS5nZXN0dXJlLnZlbG9jaXR5WCkgPCAwLjMpIHsKICAgICAgICByZXN0aW5nUG9pbnQgPSAwOwogICAgICB9IGVsc2UgaWYoZS5nZXN0dXJlLmRpcmVjdGlvbiA9PSAicmlnaHQiKSB7CiAgICAgICAgcmVzdGluZ1BvaW50ID0gMDsKICAgICAgfQoKICAgIH0KCiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgIGlmKHJlc3RpbmdQb2ludCA9PT0gMCkgewogICAgICAgIF90aGlzLl9jdXJyZW50RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJyc7CiAgICAgICAgdmFyIGJ1dHRvbnMgPSBfdGhpcy5fY3VycmVudERyYWcuYnV0dG9uczsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgYnV0dG9ucyAmJiBidXR0b25zLmNsYXNzTGlzdC5hZGQoJ2ludmlzaWJsZScpOwogICAgICAgIH0sIDI1MCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX3RoaXMuX2N1cnJlbnREcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoJyArIHJlc3RpbmdQb2ludCArICdweCwgMCwgMCknOwogICAgICB9CiAgICAgIF90aGlzLl9jdXJyZW50RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0lUSU9OXSA9ICcnOwoKCiAgICAgIC8vIEtpbGwgdGhlIGN1cnJlbnQgZHJhZwogICAgICBfdGhpcy5fbGFzdERyYWcgPSBfdGhpcy5fY3VycmVudERyYWc7CiAgICAgIF90aGlzLl9jdXJyZW50RHJhZyA9IG51bGw7CgogICAgICAvLyBXZSBhcmUgZG9uZSwgbm90aWZ5IGNhbGxlcgogICAgICBkb25lQ2FsbGJhY2sgJiYgZG9uZUNhbGxiYWNrKCk7CiAgICB9KTsKICB9OwoKICB2YXIgUmVvcmRlckRyYWcgPSBmdW5jdGlvbihvcHRzKSB7CiAgICB0aGlzLmRyYWdUaHJlc2hvbGRZID0gb3B0cy5kcmFnVGhyZXNob2xkWSB8fCAwOwogICAgdGhpcy5vblJlb3JkZXIgPSBvcHRzLm9uUmVvcmRlcjsKICAgIHRoaXMubGlzdEVsID0gb3B0cy5saXN0RWw7CiAgICB0aGlzLmVsID0gb3B0cy5lbDsKICAgIHRoaXMuc2Nyb2xsRWwgPSBvcHRzLnNjcm9sbEVsOwogICAgdGhpcy5zY3JvbGxWaWV3ID0gb3B0cy5zY3JvbGxWaWV3OwogICAgLy8gR2V0IHRoZSBUcnVlIFRvcCBvZiB0aGUgbGlzdCBlbCBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2ZpbmRwb3MuaHRtbAogICAgdGhpcy5saXN0RWxUcnVlVG9wID0gMDsKICAgIGlmICh0aGlzLmxpc3RFbC5vZmZzZXRQYXJlbnQpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMubGlzdEVsOwogICAgICBkbyB7CiAgICAgICAgdGhpcy5saXN0RWxUcnVlVG9wICs9IG9iai5vZmZzZXRUb3A7CiAgICAgICAgb2JqID0gb2JqLm9mZnNldFBhcmVudDsKICAgICAgfSB3aGlsZSAob2JqKTsKICAgIH0KICB9OwoKICBSZW9yZGVyRHJhZy5wcm90b3R5cGUgPSBuZXcgRHJhZ09wKCk7CgogIFJlb3JkZXJEcmFnLnByb3RvdHlwZS5fbW92ZUVsZW1lbnQgPSBmdW5jdGlvbihlKSB7CiAgICB2YXIgeSA9IGUuZ2VzdHVyZS5jZW50ZXIucGFnZVkgKwogICAgICB0aGlzLnNjcm9sbFZpZXcuZ2V0VmFsdWVzKCkudG9wIC0KICAgICAgKHRoaXMuX2N1cnJlbnREcmFnLmVsZW1lbnRIZWlnaHQgLyAyKSAtCiAgICAgIHRoaXMubGlzdEVsVHJ1ZVRvcDsKICAgIHRoaXMuZWwuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoMCwgJyt5KydweCwgMCknOwogIH07CgogIFJlb3JkZXJEcmFnLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKGUpIHsKICAgIHZhciBjb250ZW50OwoKICAgIHZhciBzdGFydEluZGV4ID0gaW9uaWMuRG9tVXRpbC5nZXRDaGlsZEluZGV4KHRoaXMuZWwsIHRoaXMuZWwubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICB2YXIgZWxlbWVudEhlaWdodCA9IHRoaXMuZWwuc2Nyb2xsSGVpZ2h0OwogICAgdmFyIHBsYWNlaG9sZGVyID0gdGhpcy5lbC5jbG9uZU5vZGUodHJ1ZSk7CgogICAgcGxhY2Vob2xkZXIuY2xhc3NMaXN0LmFkZChJVEVNX1BMQUNFSE9MREVSX0NMQVNTKTsKCiAgICB0aGlzLmVsLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCB0aGlzLmVsKTsKICAgIHRoaXMuZWwuY2xhc3NMaXN0LmFkZChJVEVNX1JFT1JERVJJTkdfQ0xBU1MpOwoKICAgIHRoaXMuX2N1cnJlbnREcmFnID0gewogICAgICBlbGVtZW50SGVpZ2h0OiBlbGVtZW50SGVpZ2h0LAogICAgICBzdGFydEluZGV4OiBzdGFydEluZGV4LAogICAgICBwbGFjZWhvbGRlcjogcGxhY2Vob2xkZXIsCiAgICAgIHNjcm9sbEhlaWdodDogc2Nyb2xsLAogICAgICBsaXN0OiBwbGFjZWhvbGRlci5wYXJlbnROb2RlCiAgICB9OwoKICAgIHRoaXMuX21vdmVFbGVtZW50KGUpOwogIH07CgogIFJlb3JkZXJEcmFnLnByb3RvdHlwZS5kcmFnID0gaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShmdW5jdGlvbihlKSB7CiAgICAvLyBXZSByZWFsbHkgYXJlbid0IGRyYWdnaW5nCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZighdGhpcy5fY3VycmVudERyYWcpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBzY3JvbGxZID0gMDsKICAgIHZhciBwYWdlWSA9IGUuZ2VzdHVyZS5jZW50ZXIucGFnZVk7CiAgICB2YXIgb2Zmc2V0ID0gdGhpcy5saXN0RWxUcnVlVG9wOwoKICAgIC8vSWYgd2UgaGF2ZSBhIHNjcm9sbFZpZXcsIGNoZWNrIHNjcm9sbCBib3VuZGFyaWVzIGZvciBkcmFnZ2VkIGVsZW1lbnQgYW5kIHNjcm9sbCBpZiBuZWNlc3NhcnkKICAgIGlmICh0aGlzLnNjcm9sbFZpZXcpIHsKCiAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLnNjcm9sbFZpZXcuX19jb250YWluZXI7CiAgICAgIHNjcm9sbFkgPSB0aGlzLnNjcm9sbFZpZXcuZ2V0VmFsdWVzKCkudG9wOwoKICAgICAgdmFyIGNvbnRhaW5lclRvcCA9IGNvbnRhaW5lci5vZmZzZXRUb3A7CiAgICAgIHZhciBwaXhlbHNQYXN0VG9wID0gY29udGFpbmVyVG9wIC0gcGFnZVkgKyB0aGlzLl9jdXJyZW50RHJhZy5lbGVtZW50SGVpZ2h0LzI7CiAgICAgIHZhciBwaXhlbHNQYXN0Qm90dG9tID0gcGFnZVkgKyB0aGlzLl9jdXJyZW50RHJhZy5lbGVtZW50SGVpZ2h0LzIgLSBjb250YWluZXJUb3AgLSBjb250YWluZXIub2Zmc2V0SGVpZ2h0OwoKICAgICAgaWYgKGUuZ2VzdHVyZS5kZWx0YVkgPCAwICYmIHBpeGVsc1Bhc3RUb3AgPiAwICYmIHNjcm9sbFkgPiAwKSB7CiAgICAgICAgdGhpcy5zY3JvbGxWaWV3LnNjcm9sbEJ5KG51bGwsIC1waXhlbHNQYXN0VG9wKTsKICAgICAgICAvL1RyaWdnZXIgYW5vdGhlciBkcmFnIHNvIHRoZSBzY3JvbGxpbmcga2VlcHMgZ29pbmcKICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLmRyYWcoZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGUuZ2VzdHVyZS5kZWx0YVkgPiAwICYmIHBpeGVsc1Bhc3RCb3R0b20gPiAwKSB7CiAgICAgICAgaWYgKHNjcm9sbFkgPCB0aGlzLnNjcm9sbFZpZXcuZ2V0U2Nyb2xsTWF4KCkudG9wKSB7CiAgICAgICAgICB0aGlzLnNjcm9sbFZpZXcuc2Nyb2xsQnkobnVsbCwgcGl4ZWxzUGFzdEJvdHRvbSk7CiAgICAgICAgICAvL1RyaWdnZXIgYW5vdGhlciBkcmFnIHNvIHRoZSBzY3JvbGxpbmcga2VlcHMgZ29pbmcKICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5kcmFnKGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gQ2hlY2sgaWYgd2Ugc2hvdWxkIHN0YXJ0IGRyYWdnaW5nLiBDaGVjayBpZiB3ZSd2ZSBkcmFnZ2VkIHBhc3QgdGhlIHRocmVzaG9sZCwKICAgIC8vIG9yIHdlIGFyZSBzdGFydGluZyBmcm9tIHRoZSBvcGVuIHN0YXRlLgogICAgaWYoIXRoaXMuX2lzRHJhZ2dpbmcgJiYgTWF0aC5hYnMoZS5nZXN0dXJlLmRlbHRhWSkgPiB0aGlzLmRyYWdUaHJlc2hvbGRZKSB7CiAgICAgIHRoaXMuX2lzRHJhZ2dpbmcgPSB0cnVlOwogICAgfQoKICAgIGlmKHRoaXMuX2lzRHJhZ2dpbmcpIHsKICAgICAgdGhpcy5fbW92ZUVsZW1lbnQoZSk7CgogICAgICB0aGlzLl9jdXJyZW50RHJhZy5jdXJyZW50WSA9IHNjcm9sbFkgKyBwYWdlWSAtIG9mZnNldDsKCiAgICAgIC8vIHRoaXMuX3Jlb3JkZXJJdGVtcygpOwogICAgfQogIH0pOwoKICAvLyBXaGVuIGFuIGl0ZW0gaXMgZHJhZ2dlZCwgd2UgbmVlZCB0byByZW9yZGVyIGFueSBpdGVtcyBmb3Igc29ydGluZyBwdXJwb3NlcwogIFJlb3JkZXJEcmFnLnByb3RvdHlwZS5fZ2V0UmVvcmRlckluZGV4ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGxhY2Vob2xkZXIgPSB0aGlzLl9jdXJyZW50RHJhZy5wbGFjZWhvbGRlcjsKICAgIHZhciBzaWJsaW5ncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMuX2N1cnJlbnREcmFnLnBsYWNlaG9sZGVyLnBhcmVudE5vZGUuY2hpbGRyZW4pCiAgICAgIC5maWx0ZXIoZnVuY3Rpb24oZWwpIHsKICAgICAgICByZXR1cm4gZWwubm9kZU5hbWUgPT09IHNlbGYuZWwubm9kZU5hbWUgJiYgZWwgIT09IHNlbGYuZWw7CiAgICAgIH0pOwoKICAgIHZhciBkcmFnT2Zmc2V0VG9wID0gdGhpcy5fY3VycmVudERyYWcuY3VycmVudFk7CiAgICB2YXIgZWw7CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gc2libGluZ3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgZWwgPSBzaWJsaW5nc1tpXTsKICAgICAgaWYgKGkgPT09IGxlbiAtIDEpIHsKICAgICAgICBpZiAoZHJhZ09mZnNldFRvcCA+IGVsLm9mZnNldFRvcCkgewogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGkgPT09IDApIHsKICAgICAgICBpZiAoZHJhZ09mZnNldFRvcCA8IGVsLm9mZnNldFRvcCArIGVsLm9mZnNldEhlaWdodCkgewogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGRyYWdPZmZzZXRUb3AgPiBlbC5vZmZzZXRUb3AgLSBlbC5vZmZzZXRIZWlnaHQgLyAyICYmCiAgICAgICAgICAgICAgICAgZHJhZ09mZnNldFRvcCA8IGVsLm9mZnNldFRvcCArIGVsLm9mZnNldEhlaWdodCkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5fY3VycmVudERyYWcuc3RhcnRJbmRleDsKICB9OwoKICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24oZSwgZG9uZUNhbGxiYWNrKSB7CiAgICBpZighdGhpcy5fY3VycmVudERyYWcpIHsKICAgICAgZG9uZUNhbGxiYWNrICYmIGRvbmVDYWxsYmFjaygpOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHBsYWNlaG9sZGVyID0gdGhpcy5fY3VycmVudERyYWcucGxhY2Vob2xkZXI7CiAgICB2YXIgZmluYWxJbmRleCA9IHRoaXMuX2dldFJlb3JkZXJJbmRleCgpOwoKICAgIC8vIFJlcG9zaXRpb24gdGhlIGVsZW1lbnQKICAgIHRoaXMuZWwuY2xhc3NMaXN0LnJlbW92ZShJVEVNX1JFT1JERVJJTkdfQ0xBU1MpOwogICAgdGhpcy5lbC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICcnOwoKICAgIHBsYWNlaG9sZGVyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMuZWwsIHBsYWNlaG9sZGVyKTsKICAgIHBsYWNlaG9sZGVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocGxhY2Vob2xkZXIpOwoKICAgIHRoaXMub25SZW9yZGVyICYmIHRoaXMub25SZW9yZGVyKHRoaXMuZWwsIHRoaXMuX2N1cnJlbnREcmFnLnN0YXJ0SW5kZXgsIGZpbmFsSW5kZXgpOwoKICAgIHRoaXMuX2N1cnJlbnREcmFnID0gbnVsbDsKICAgIGRvbmVDYWxsYmFjayAmJiBkb25lQ2FsbGJhY2soKTsKICB9OwoKCgogIC8qKgogICAqIFRoZSBMaXN0VmlldyBoYW5kbGVzIGEgbGlzdCBvZiBpdGVtcy4gSXQgd2lsbCBwcm9jZXNzIGRyYWcgYW5pbWF0aW9ucywgZWRpdCBtb2RlLAogICAqIGFuZCBvdGhlciBvcGVyYXRpb25zIHRoYXQgYXJlIGNvbW1vbiBvbiBtb2JpbGUgbGlzdHMgb3IgdGFibGUgdmlld3MuCiAgICovCiAgaW9uaWMudmlld3MuTGlzdFZpZXcgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgb3B0cyA9IGlvbmljLmV4dGVuZCh7CiAgICAgICAgb25SZW9yZGVyOiBmdW5jdGlvbihlbCwgb2xkSW5kZXgsIG5ld0luZGV4KSB7fSwKICAgICAgICB2aXJ0dWFsUmVtb3ZlVGhyZXNob2xkOiAtMjAwLAogICAgICAgIHZpcnR1YWxBZGRUaHJlc2hvbGQ6IDIwMCwKICAgICAgICBjYW5Td2lwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0sIG9wdHMpOwoKICAgICAgaW9uaWMuZXh0ZW5kKHRoaXMsIG9wdHMpOwoKICAgICAgaWYoIXRoaXMuaXRlbUhlaWdodCAmJiB0aGlzLmxpc3RFbCkgewogICAgICAgIHRoaXMuaXRlbUhlaWdodCA9IHRoaXMubGlzdEVsLmNoaWxkcmVuWzBdICYmIHBhcnNlSW50KHRoaXMubGlzdEVsLmNoaWxkcmVuWzBdLnN0eWxlLmhlaWdodCwgMTApOwogICAgICB9CgogICAgICAvL2lvbmljLnZpZXdzLkxpc3RWaWV3Ll9fc3VwZXJfXy5pbml0aWFsaXplLmNhbGwodGhpcywgb3B0cyk7CgogICAgICB0aGlzLm9uUmVmcmVzaCA9IG9wdHMub25SZWZyZXNoIHx8IGZ1bmN0aW9uKCkge307CiAgICAgIHRoaXMub25SZWZyZXNoT3BlbmluZyA9IG9wdHMub25SZWZyZXNoT3BlbmluZyB8fCBmdW5jdGlvbigpIHt9OwogICAgICB0aGlzLm9uUmVmcmVzaEhvbGRpbmcgPSBvcHRzLm9uUmVmcmVzaEhvbGRpbmcgfHwgZnVuY3Rpb24oKSB7fTsKCiAgICAgIHdpbmRvdy5pb25pYy5vbkdlc3R1cmUoJ3JlbGVhc2UnLCBmdW5jdGlvbihlKSB7CiAgICAgICAgX3RoaXMuX2hhbmRsZUVuZERyYWcoZSk7CiAgICAgIH0sIHRoaXMuZWwpOwoKICAgICAgd2luZG93LmlvbmljLm9uR2VzdHVyZSgnZHJhZycsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBfdGhpcy5faGFuZGxlRHJhZyhlKTsKICAgICAgfSwgdGhpcy5lbCk7CiAgICAgIC8vIFN0YXJ0IHRoZSBkcmFnIHN0YXRlcwogICAgICB0aGlzLl9pbml0RHJhZygpOwogICAgfSwKICAgIC8qKgogICAgICogQ2FsbGVkIHRvIHRlbGwgdGhlIGxpc3QgdG8gc3RvcCByZWZyZXNoaW5nLiBUaGlzIGlzIHVzZWZ1bAogICAgICogaWYgeW91IGFyZSByZWZyZXNoaW5nIHRoZSBsaXN0IGFuZCBhcmUgZG9uZSB3aXRoIHJlZnJlc2hpbmcuCiAgICAgKi8KICAgIHN0b3BSZWZyZXNoaW5nOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHJlZnJlc2hlciA9IHRoaXMuZWwucXVlcnlTZWxlY3RvcignLmxpc3QtcmVmcmVzaGVyJyk7CiAgICAgIHJlZnJlc2hlci5zdHlsZS5oZWlnaHQgPSAnMHB4JzsKICAgIH0sCgogICAgLyoqCiAgICAgKiBJZiB3ZSBzY3JvbGxlZCBhbmQgaGF2ZSB2aXJ0dWFsIG1vZGUgZW5hYmxlZCwgY29tcHV0ZSB0aGUgd2luZG93CiAgICAgKiBvZiBhY3RpdmUgZWxlbWVudHMgaW4gb3JkZXIgdG8gZmlndXJlIG91dCB0aGUgdmlld3BvcnQgdG8gcmVuZGVyLgogICAgICovCiAgICBkaWRTY3JvbGw6IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYodGhpcy5pc1ZpcnR1YWwpIHsKICAgICAgICB2YXIgaXRlbUhlaWdodCA9IHRoaXMuaXRlbUhlaWdodDsKCiAgICAgICAgLy8gVE9ETzogVGhpcyB3b3VsZCBiZSBpbmFjY3VyYXRlIGlmIHdlIGFyZSB3aW5kb3dlZAogICAgICAgIHZhciB0b3RhbEl0ZW1zID0gdGhpcy5saXN0RWwuY2hpbGRyZW4ubGVuZ3RoOwoKICAgICAgICAvLyBHcmFiIHRoZSB0b3RhbCBoZWlnaHQgb2YgdGhlIGxpc3QKICAgICAgICB2YXIgc2Nyb2xsSGVpZ2h0ID0gZS50YXJnZXQuc2Nyb2xsSGVpZ2h0OwoKICAgICAgICAvLyBHZXQgdGhlIHZpZXdwb3J0IGhlaWdodAogICAgICAgIHZhciB2aWV3cG9ydEhlaWdodCA9IHRoaXMuZWwucGFyZW50Tm9kZS5vZmZzZXRIZWlnaHQ7CgogICAgICAgIC8vIHNjcm9sbFRvcCBpcyB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24KICAgICAgICB2YXIgc2Nyb2xsVG9wID0gZS5zY3JvbGxUb3A7CgogICAgICAgIC8vIEhpZ2ggd2F0ZXIgaXMgdGhlIHBpeGVsIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBlbGVtZW50IHRvIGluY2x1ZGUgKGV2ZXJ5dGhpbmcgYmVmb3JlCiAgICAgICAgLy8gdGhhdCB3aWxsIGJlIHJlbW92ZWQpCiAgICAgICAgdmFyIGhpZ2hXYXRlciA9IE1hdGgubWF4KDAsIGUuc2Nyb2xsVG9wICsgdGhpcy52aXJ0dWFsUmVtb3ZlVGhyZXNob2xkKTsKCiAgICAgICAgLy8gTG93IHdhdGVyIGlzIHRoZSBwaXhlbCBwb3NpdGlvbiBvZiB0aGUgbGFzdCBlbGVtZW50IHRvIGluY2x1ZGUgKGV2ZXJ5dGhpbmcgYWZ0ZXIKICAgICAgICAvLyB0aGF0IHdpbGwgYmUgcmVtb3ZlZCkKICAgICAgICB2YXIgbG93V2F0ZXIgPSBNYXRoLm1pbihzY3JvbGxIZWlnaHQsIE1hdGguYWJzKGUuc2Nyb2xsVG9wKSArIHZpZXdwb3J0SGVpZ2h0ICsgdGhpcy52aXJ0dWFsQWRkVGhyZXNob2xkKTsKCiAgICAgICAgLy8gQ29tcHV0ZSBob3cgbWFueSBpdGVtcyBwZXIgdmlld3BvcnQgc2l6ZSBjYW4gc2hvdwogICAgICAgIHZhciBpdGVtc1BlclZpZXdwb3J0ID0gTWF0aC5mbG9vcigobG93V2F0ZXIgLSBoaWdoV2F0ZXIpIC8gaXRlbUhlaWdodCk7CgogICAgICAgIC8vIEdldCB0aGUgZmlyc3QgYW5kIGxhc3QgZWxlbWVudHMgaW4gdGhlIGxpc3QgYmFzZWQgb24gaG93IG1hbnkgY2FuIGZpdAogICAgICAgIC8vIGJldHdlZW4gdGhlIHBpeGVsIHJhbmdlIG9mIGxvd1dhdGVyIGFuZCBoaWdoV2F0ZXIKICAgICAgICB2YXIgZmlyc3QgPSBwYXJzZUludChNYXRoLmFicyhoaWdoV2F0ZXIgLyBpdGVtSGVpZ2h0KSwgMTApOwogICAgICAgIHZhciBsYXN0ID0gcGFyc2VJbnQoTWF0aC5hYnMobG93V2F0ZXIgLyBpdGVtSGVpZ2h0KSwgMTApOwoKICAgICAgICAvLyBHZXQgdGhlIGl0ZW1zIHdlIG5lZWQgdG8gcmVtb3ZlCiAgICAgICAgdGhpcy5fdmlydHVhbEl0ZW1zVG9SZW1vdmUgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLmxpc3RFbC5jaGlsZHJlbiwgMCwgZmlyc3QpOwoKICAgICAgICAvLyBHcmFiIHRoZSBub2RlcyB3ZSB3aWxsIGJlIHNob3dpbmcKICAgICAgICB2YXIgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLmxpc3RFbC5jaGlsZHJlbiwgZmlyc3QsIGZpcnN0ICsgaXRlbXNQZXJWaWV3cG9ydCk7CgogICAgICAgIHRoaXMucmVuZGVyVmlld3BvcnQgJiYgdGhpcy5yZW5kZXJWaWV3cG9ydChoaWdoV2F0ZXIsIGxvd1dhdGVyLCBmaXJzdCwgbGFzdCk7CiAgICAgIH0KICAgIH0sCgogICAgZGlkU3RvcFNjcm9sbGluZzogZnVuY3Rpb24oZSkgewogICAgICBpZih0aGlzLmlzVmlydHVhbCkgewogICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLl92aXJ0dWFsSXRlbXNUb1JlbW92ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGVsID0gdGhpcy5fdmlydHVhbEl0ZW1zVG9SZW1vdmVbaV07CiAgICAgICAgICAvL2VsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWwpOwogICAgICAgICAgdGhpcy5kaWRIaWRlSXRlbSAmJiB0aGlzLmRpZEhpZGVJdGVtKGkpOwogICAgICAgIH0KICAgICAgICAvLyBPbmNlIHNjcm9sbGluZyBzdG9wcywgY2hlY2sgaWYgd2UgbmVlZCB0byByZW1vdmUgb2xkIGl0ZW1zCgogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogQ2xlYXIgYW55IGFjdGl2ZSBkcmFnIGVmZmVjdHMgb24gdGhlIGxpc3QuCiAgICAgKi8KICAgIGNsZWFyRHJhZ0VmZmVjdHM6IGZ1bmN0aW9uKCkgewogICAgICBpZih0aGlzLl9sYXN0RHJhZ09wKSB7CiAgICAgICAgdGhpcy5fbGFzdERyYWdPcC5jbGVhbiAmJiB0aGlzLl9sYXN0RHJhZ09wLmNsZWFuKCk7CiAgICAgICAgdGhpcy5fbGFzdERyYWdPcCA9IG51bGw7CiAgICAgIH0KICAgIH0sCgogICAgX2luaXREcmFnOiBmdW5jdGlvbigpIHsKICAgICAgLy9pb25pYy52aWV3cy5MaXN0Vmlldy5fX3N1cGVyX18uX2luaXREcmFnLmNhbGwodGhpcyk7CgogICAgICAvLyBTdG9yZSB0aGUgbGFzdCBvbmUKICAgICAgdGhpcy5fbGFzdERyYWdPcCA9IHRoaXMuX2RyYWdPcDsKCiAgICAgIHRoaXMuX2RyYWdPcCA9IG51bGw7CiAgICB9LAoKICAgIC8vIFJldHVybiB0aGUgbGlzdCBpdGVtIGZyb20gdGhlIGdpdmVuIHRhcmdldAogICAgX2dldEl0ZW06IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICB3aGlsZSh0YXJnZXQpIHsKICAgICAgICBpZih0YXJnZXQuY2xhc3NMaXN0ICYmIHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoSVRFTV9DTEFTUykpIHsKICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfSwKCgogICAgX3N0YXJ0RHJhZzogZnVuY3Rpb24oZSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGRpZFN0YXJ0ID0gZmFsc2U7CgogICAgICB0aGlzLl9pc0RyYWdnaW5nID0gZmFsc2U7CgogICAgICB2YXIgbGFzdERyYWdPcCA9IHRoaXMuX2xhc3REcmFnT3A7CiAgICAgIHZhciBpdGVtOwoKICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBpcyBhIHJlb3JkZXIgZHJhZwogICAgICBpZihpb25pYy5Eb21VdGlsLmdldFBhcmVudE9yU2VsZldpdGhDbGFzcyhlLnRhcmdldCwgSVRFTV9SRU9SREVSX0JUTl9DTEFTUykgJiYgKGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gJ3VwJyB8fCBlLmdlc3R1cmUuZGlyZWN0aW9uID09ICdkb3duJykpIHsKICAgICAgICBpdGVtID0gdGhpcy5fZ2V0SXRlbShlLnRhcmdldCk7CgogICAgICAgIGlmKGl0ZW0pIHsKICAgICAgICAgIHRoaXMuX2RyYWdPcCA9IG5ldyBSZW9yZGVyRHJhZyh7CiAgICAgICAgICAgIGxpc3RFbDogdGhpcy5lbCwKICAgICAgICAgICAgZWw6IGl0ZW0sCiAgICAgICAgICAgIHNjcm9sbEVsOiB0aGlzLnNjcm9sbEVsLAogICAgICAgICAgICBzY3JvbGxWaWV3OiB0aGlzLnNjcm9sbFZpZXcsCiAgICAgICAgICAgIG9uUmVvcmRlcjogZnVuY3Rpb24oZWwsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgICBfdGhpcy5vblJlb3JkZXIgJiYgX3RoaXMub25SZW9yZGVyKGVsLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLl9kcmFnT3Auc3RhcnQoZSk7CiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBPciBjaGVjayBpZiB0aGlzIGlzIGEgc3dpcGUgdG8gdGhlIHNpZGUgZHJhZwogICAgICBlbHNlIGlmKCF0aGlzLl9kaWREcmFnVXBPckRvd24gJiYgKGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gJ2xlZnQnIHx8IGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gJ3JpZ2h0JykgJiYgTWF0aC5hYnMoZS5nZXN0dXJlLmRlbHRhWCkgPiA1KSB7CgogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGlzIGFuIGl0ZW0gd2l0aCBidXR0b25zCiAgICAgICAgaXRlbSA9IHRoaXMuX2dldEl0ZW0oZS50YXJnZXQpOwogICAgICAgIGlmKGl0ZW0gJiYgaXRlbS5xdWVyeVNlbGVjdG9yKCcuaXRlbS1vcHRpb25zJykpIHsKICAgICAgICAgIHRoaXMuX2RyYWdPcCA9IG5ldyBTbGlkZURyYWcoeyBlbDogdGhpcy5lbCwgY2FuU3dpcGU6IHRoaXMuY2FuU3dpcGUgfSk7CiAgICAgICAgICB0aGlzLl9kcmFnT3Auc3RhcnQoZSk7CiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBJZiB3ZSBoYWQgYSBsYXN0IGRyYWcgb3BlcmF0aW9uIGFuZCB0aGlzIGlzIGEgbmV3IG9uZSBvbiBhIGRpZmZlcmVudCBpdGVtLCBjbGVhbiB0aGF0IGxhc3Qgb25lCiAgICAgIGlmKGxhc3REcmFnT3AgJiYgdGhpcy5fZHJhZ09wICYmICF0aGlzLl9kcmFnT3AuaXNTYW1lSXRlbShsYXN0RHJhZ09wKSAmJiBlLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICBsYXN0RHJhZ09wLmNsZWFuICYmIGxhc3REcmFnT3AuY2xlYW4oKTsKICAgICAgfQogICAgfSwKCgogICAgX2hhbmRsZUVuZERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHRoaXMuX2RpZERyYWdVcE9yRG93biA9IGZhbHNlOwoKICAgICAgaWYoIXRoaXMuX2RyYWdPcCkgewogICAgICAgIC8vaW9uaWMudmlld3MuTGlzdFZpZXcuX19zdXBlcl9fLl9oYW5kbGVFbmREcmFnLmNhbGwodGhpcywgZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9kcmFnT3AuZW5kKGUsIGZ1bmN0aW9uKCkgewogICAgICAgIF90aGlzLl9pbml0RHJhZygpOwogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBQcm9jZXNzIHRoZSBkcmFnIGV2ZW50IHRvIG1vdmUgdGhlIGl0ZW0gdG8gdGhlIGxlZnQgb3IgcmlnaHQuCiAgICAgKi8KICAgIF9oYW5kbGVEcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXMsIGNvbnRlbnQsIGJ1dHRvbnM7CgogICAgICBpZihNYXRoLmFicyhlLmdlc3R1cmUuZGVsdGFZKSA+IDUpIHsKICAgICAgICB0aGlzLl9kaWREcmFnVXBPckRvd24gPSB0cnVlOwogICAgICB9CgogICAgICAvLyBJZiB3ZSBnZXQgYSBkcmFnIGV2ZW50LCBtYWtlIHN1cmUgd2UgYXJlbid0IGluIGFub3RoZXIgZHJhZywgdGhlbiBjaGVjayBpZiB3ZSBzaG91bGQKICAgICAgLy8gc3RhcnQgb25lCiAgICAgIGlmKCF0aGlzLmlzRHJhZ2dpbmcgJiYgIXRoaXMuX2RyYWdPcCkgewogICAgICAgIHRoaXMuX3N0YXJ0RHJhZyhlKTsKICAgICAgfQoKICAgICAgLy8gTm8gZHJhZyBzdGlsbCwgcGFzcyBpdCB1cAogICAgICBpZighdGhpcy5fZHJhZ09wKSB7CiAgICAgICAgLy9pb25pYy52aWV3cy5MaXN0Vmlldy5fX3N1cGVyX18uX2hhbmRsZURyYWcuY2FsbCh0aGlzLCBlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGUuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB0aGlzLl9kcmFnT3AuZHJhZyhlKTsKICAgIH0KCiAgfSk7Cgp9KShpb25pYyk7CgooZnVuY3Rpb24oaW9uaWMpIHsKJ3VzZSBzdHJpY3QnOwoKICBpb25pYy52aWV3cy5Nb2RhbCA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgIG9wdHMgPSBpb25pYy5leHRlbmQoewogICAgICAgIGZvY3VzRmlyc3RJbnB1dDogZmFsc2UsCiAgICAgICAgdW5mb2N1c09uSGlkZTogdHJ1ZSwKICAgICAgICBmb2N1c0ZpcnN0RGVsYXk6IDYwMCwKICAgICAgICBiYWNrZHJvcENsaWNrVG9DbG9zZTogdHJ1ZSwKICAgICAgICBoYXJkd2FyZUJhY2tCdXR0b25DbG9zZTogdHJ1ZSwKICAgICAgfSwgb3B0cyk7CgogICAgICBpb25pYy5leHRlbmQodGhpcywgb3B0cyk7CgogICAgICB0aGlzLmVsID0gb3B0cy5lbDsKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgaWYoc2VsZi5mb2N1c0ZpcnN0SW5wdXQpIHsKICAgICAgICAvLyBMZXQgYW55IGFuaW1hdGlvbnMgcnVuIGZpcnN0CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgaW5wdXQgPSBzZWxmLmVsLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0LCB0ZXh0YXJlYScpOwogICAgICAgICAgaW5wdXQgJiYgaW5wdXQuZm9jdXMgJiYgaW5wdXQuZm9jdXMoKTsKICAgICAgICB9LCBzZWxmLmZvY3VzRmlyc3REZWxheSk7CiAgICAgIH0KICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbigpIHsKICAgICAgLy8gVW5mb2N1cyBhbGwgZWxlbWVudHMKICAgICAgaWYodGhpcy51bmZvY3VzT25IaWRlKSB7CiAgICAgICAgdmFyIGlucHV0cyA9IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQsIHRleHRhcmVhJyk7CiAgICAgICAgLy8gTGV0IGFueSBhbmltYXRpb25zIHJ1biBmaXJzdAogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGlucHV0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpbnB1dHNbaV0uYmx1ciAmJiBpbnB1dHNbaV0uYmx1cigpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSk7Cgp9KShpb25pYyk7CgooZnVuY3Rpb24oaW9uaWMpIHsKJ3VzZSBzdHJpY3QnOwoKICAvKioKICAgKiBUaGUgc2lkZSBtZW51IHZpZXcgaGFuZGxlcyBvbmUgb2YgdGhlIHNpZGUgbWVudSdzIGluIGEgU2lkZSBNZW51IENvbnRyb2xsZXIKICAgKiBjb25maWd1cmF0aW9uLgogICAqIEl0IHRha2VzIGEgRE9NIHJlZmVyZW5jZSB0byB0aGF0IHNpZGUgbWVudSBlbGVtZW50LgogICAqLwogIGlvbmljLnZpZXdzLlNpZGVNZW51ID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgdGhpcy5lbCA9IG9wdHMuZWw7CiAgICAgIHRoaXMuaXNFbmFibGVkID0gKHR5cGVvZiBvcHRzLmlzRW5hYmxlZCA9PT0gJ3VuZGVmaW5lZCcpID8gdHJ1ZSA6IG9wdHMuaXNFbmFibGVkOwogICAgICB0aGlzLnNldFdpZHRoKG9wdHMud2lkdGgpOwogICAgfSwKICAgIGdldEZ1bGxXaWR0aDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLndpZHRoOwogICAgfSwKICAgIHNldFdpZHRoOiBmdW5jdGlvbih3aWR0aCkgewogICAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAgIHRoaXMuZWwuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICB9LAogICAgc2V0SXNFbmFibGVkOiBmdW5jdGlvbihpc0VuYWJsZWQpIHsKICAgICAgdGhpcy5pc0VuYWJsZWQgPSBpc0VuYWJsZWQ7CiAgICB9LAogICAgYnJpbmdVcDogZnVuY3Rpb24oKSB7CiAgICAgIGlmKHRoaXMuZWwuc3R5bGUuekluZGV4ICE9PSAnMCcpIHsKICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9ICcwJzsKICAgICAgfQogICAgfSwKICAgIHB1c2hEb3duOiBmdW5jdGlvbigpIHsKICAgICAgaWYodGhpcy5lbC5zdHlsZS56SW5kZXggIT09ICctMScpIHsKICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9ICctMSc7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgaW9uaWMudmlld3MuU2lkZU1lbnVDb250ZW50ID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgaW9uaWMuZXh0ZW5kKHRoaXMsIHsKICAgICAgICBhbmltYXRpb25DbGFzczogJ21lbnUtYW5pbWF0ZWQnLAogICAgICAgIG9uRHJhZzogZnVuY3Rpb24oZSkge30sCiAgICAgICAgb25FbmREcmFnOiBmdW5jdGlvbihlKSB7fQogICAgICB9LCBvcHRzKTsKCiAgICAgIGlvbmljLm9uR2VzdHVyZSgnZHJhZycsIGlvbmljLnByb3h5KHRoaXMuX29uRHJhZywgdGhpcyksIHRoaXMuZWwpOwogICAgICBpb25pYy5vbkdlc3R1cmUoJ3JlbGVhc2UnLCBpb25pYy5wcm94eSh0aGlzLl9vbkVuZERyYWcsIHRoaXMpLCB0aGlzLmVsKTsKICAgIH0sCiAgICBfb25EcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgIHRoaXMub25EcmFnICYmIHRoaXMub25EcmFnKGUpOwogICAgfSwKICAgIF9vbkVuZERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgdGhpcy5vbkVuZERyYWcgJiYgdGhpcy5vbkVuZERyYWcoZSk7CiAgICB9LAogICAgZGlzYWJsZUFuaW1hdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZWwuY2xhc3NMaXN0LnJlbW92ZSh0aGlzLmFuaW1hdGlvbkNsYXNzKTsKICAgIH0sCiAgICBlbmFibGVBbmltYXRpb246IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmVsLmNsYXNzTGlzdC5hZGQodGhpcy5hbmltYXRpb25DbGFzcyk7CiAgICB9LAogICAgZ2V0VHJhbnNsYXRlWDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KHRoaXMuZWwuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0ucmVwbGFjZSgndHJhbnNsYXRlM2QoJywgJycpLnNwbGl0KCcsJylbMF0pOwogICAgfSwKICAgIHNldFRyYW5zbGF0ZVg6IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oeCkgewogICAgICB0aGlzLmVsLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKCcgKyB4ICsgJ3B4LCAwLCAwKSc7CiAgICB9KQogIH0pOwoKfSkoaW9uaWMpOwoKLyoKICogQWRhcHRlZCBmcm9tIFN3aXBlLmpzIDIuMAogKgogKiBCcmFkIEJpcmRzYWxsCiAqIENvcHlyaWdodCAyMDEzLCBNSVQgTGljZW5zZQogKgoqLwoKKGZ1bmN0aW9uKGlvbmljKSB7Cid1c2Ugc3RyaWN0JzsKCmlvbmljLnZpZXdzLlNsaWRlciA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHZhciBzbGlkZXIgPSB0aGlzOwoKICAgIC8vIHV0aWxpdGllcwogICAgdmFyIG5vb3AgPSBmdW5jdGlvbigpIHt9OyAvLyBzaW1wbGUgbm8gb3BlcmF0aW9uIGZ1bmN0aW9uCiAgICB2YXIgb2ZmbG9hZEZuID0gZnVuY3Rpb24oZm4pIHsgc2V0VGltZW91dChmbiB8fCBub29wLCAwKTsgfTsgLy8gb2ZmbG9hZCBhIGZ1bmN0aW9ucyBleGVjdXRpb24KCiAgICAvLyBjaGVjayBicm93c2VyIGNhcGFiaWxpdGllcwogICAgdmFyIGJyb3dzZXIgPSB7CiAgICAgIGFkZEV2ZW50TGlzdGVuZXI6ICEhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIsCiAgICAgIHRvdWNoOiAoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KSB8fCB3aW5kb3cuRG9jdW1lbnRUb3VjaCAmJiBkb2N1bWVudCBpbnN0YW5jZW9mIERvY3VtZW50VG91Y2gsCiAgICAgIHRyYW5zaXRpb25zOiAoZnVuY3Rpb24odGVtcCkgewogICAgICAgIHZhciBwcm9wcyA9IFsndHJhbnNpdGlvblByb3BlcnR5JywgJ1dlYmtpdFRyYW5zaXRpb24nLCAnTW96VHJhbnNpdGlvbicsICdPVHJhbnNpdGlvbicsICdtc1RyYW5zaXRpb24nXTsKICAgICAgICBmb3IgKCB2YXIgaSBpbiBwcm9wcyApIGlmICh0ZW1wLnN0eWxlWyBwcm9wc1tpXSBdICE9PSB1bmRlZmluZWQpIHJldHVybiB0cnVlOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSkoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3dpcGUnKSkKICAgIH07CgoKICAgIHZhciBjb250YWluZXIgPSBvcHRpb25zLmVsOwoKICAgIC8vIHF1aXQgaWYgbm8gcm9vdCBlbGVtZW50CiAgICBpZiAoIWNvbnRhaW5lcikgcmV0dXJuOwogICAgdmFyIGVsZW1lbnQgPSBjb250YWluZXIuY2hpbGRyZW5bMF07CiAgICB2YXIgc2xpZGVzLCBzbGlkZVBvcywgd2lkdGgsIGxlbmd0aDsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIGluZGV4ID0gcGFyc2VJbnQob3B0aW9ucy5zdGFydFNsaWRlLCAxMCkgfHwgMDsKICAgIHZhciBzcGVlZCA9IG9wdGlvbnMuc3BlZWQgfHwgMzAwOwogICAgb3B0aW9ucy5jb250aW51b3VzID0gb3B0aW9ucy5jb250aW51b3VzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvbnRpbnVvdXMgOiB0cnVlOwoKICAgIGZ1bmN0aW9uIHNldHVwKCkgewoKICAgICAgLy8gY2FjaGUgc2xpZGVzCiAgICAgIHNsaWRlcyA9IGVsZW1lbnQuY2hpbGRyZW47CiAgICAgIGxlbmd0aCA9IHNsaWRlcy5sZW5ndGg7CgogICAgICAvLyBzZXQgY29udGludW91cyB0byBmYWxzZSBpZiBvbmx5IG9uZSBzbGlkZQogICAgICBpZiAoc2xpZGVzLmxlbmd0aCA8IDIpIG9wdGlvbnMuY29udGludW91cyA9IGZhbHNlOwoKICAgICAgLy9zcGVjaWFsIGNhc2UgaWYgdHdvIHNsaWRlcwogICAgICBpZiAoYnJvd3Nlci50cmFuc2l0aW9ucyAmJiBvcHRpb25zLmNvbnRpbnVvdXMgJiYgc2xpZGVzLmxlbmd0aCA8IDMpIHsKICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHNsaWRlc1swXS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudC5jaGlsZHJlblsxXS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgIHNsaWRlcyA9IGVsZW1lbnQuY2hpbGRyZW47CiAgICAgIH0KCiAgICAgIC8vIGNyZWF0ZSBhbiBhcnJheSB0byBzdG9yZSBjdXJyZW50IHBvc2l0aW9ucyBvZiBlYWNoIHNsaWRlCiAgICAgIHNsaWRlUG9zID0gbmV3IEFycmF5KHNsaWRlcy5sZW5ndGgpOwoKICAgICAgLy8gZGV0ZXJtaW5lIHdpZHRoIG9mIGVhY2ggc2xpZGUKICAgICAgd2lkdGggPSBjb250YWluZXIub2Zmc2V0V2lkdGggfHwgY29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoOwoKICAgICAgZWxlbWVudC5zdHlsZS53aWR0aCA9IChzbGlkZXMubGVuZ3RoICogd2lkdGgpICsgJ3B4JzsKCiAgICAgIC8vIHN0YWNrIGVsZW1lbnRzCiAgICAgIHZhciBwb3MgPSBzbGlkZXMubGVuZ3RoOwogICAgICB3aGlsZShwb3MtLSkgewoKICAgICAgICB2YXIgc2xpZGUgPSBzbGlkZXNbcG9zXTsKCiAgICAgICAgc2xpZGUuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgICAgc2xpZGUuc2V0QXR0cmlidXRlKCdkYXRhLWluZGV4JywgcG9zKTsKCiAgICAgICAgaWYgKGJyb3dzZXIudHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHNsaWRlLnN0eWxlLmxlZnQgPSAocG9zICogLXdpZHRoKSArICdweCc7CiAgICAgICAgICBtb3ZlKHBvcywgaW5kZXggPiBwb3MgPyAtd2lkdGggOiAoaW5kZXggPCBwb3MgPyB3aWR0aCA6IDApLCAwKTsKICAgICAgICB9CgogICAgICB9CgogICAgICAvLyByZXBvc2l0aW9uIGVsZW1lbnRzIGJlZm9yZSBhbmQgYWZ0ZXIgaW5kZXgKICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cyAmJiBicm93c2VyLnRyYW5zaXRpb25zKSB7CiAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgtMSksIC13aWR0aCwgMCk7CiAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgrMSksIHdpZHRoLCAwKTsKICAgICAgfQoKICAgICAgaWYgKCFicm93c2VyLnRyYW5zaXRpb25zKSBlbGVtZW50LnN0eWxlLmxlZnQgPSAoaW5kZXggKiAtd2lkdGgpICsgJ3B4JzsKCiAgICAgIGNvbnRhaW5lci5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoKICAgICAgb3B0aW9ucy5zbGlkZXNDaGFuZ2VkICYmIG9wdGlvbnMuc2xpZGVzQ2hhbmdlZCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHByZXYoKSB7CgogICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSBzbGlkZShpbmRleC0xKTsKICAgICAgZWxzZSBpZiAoaW5kZXgpIHNsaWRlKGluZGV4LTEpOwoKICAgIH0KCiAgICBmdW5jdGlvbiBuZXh0KCkgewoKICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgc2xpZGUoaW5kZXgrMSk7CiAgICAgIGVsc2UgaWYgKGluZGV4IDwgc2xpZGVzLmxlbmd0aCAtIDEpIHNsaWRlKGluZGV4KzEpOwoKICAgIH0KCiAgICBmdW5jdGlvbiBjaXJjbGUoaW5kZXgpIHsKCiAgICAgIC8vIGEgc2ltcGxlIHBvc2l0aXZlIG1vZHVsbyB1c2luZyBzbGlkZXMubGVuZ3RoCiAgICAgIHJldHVybiAoc2xpZGVzLmxlbmd0aCArIChpbmRleCAlIHNsaWRlcy5sZW5ndGgpKSAlIHNsaWRlcy5sZW5ndGg7CgogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWRlKHRvLCBzbGlkZVNwZWVkKSB7CgogICAgICAvLyBkbyBub3RoaW5nIGlmIGFscmVhZHkgb24gcmVxdWVzdGVkIHNsaWRlCiAgICAgIGlmIChpbmRleCA9PSB0bykgcmV0dXJuOwoKICAgICAgaWYgKGJyb3dzZXIudHJhbnNpdGlvbnMpIHsKCiAgICAgICAgdmFyIGRpcmVjdGlvbiA9IE1hdGguYWJzKGluZGV4LXRvKSAvIChpbmRleC10byk7IC8vIDE6IGJhY2t3YXJkLCAtMTogZm9yd2FyZAoKICAgICAgICAvLyBnZXQgdGhlIGFjdHVhbCBwb3NpdGlvbiBvZiB0aGUgc2xpZGUKICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSB7CiAgICAgICAgICB2YXIgbmF0dXJhbF9kaXJlY3Rpb24gPSBkaXJlY3Rpb247CiAgICAgICAgICBkaXJlY3Rpb24gPSAtc2xpZGVQb3NbY2lyY2xlKHRvKV0gLyB3aWR0aDsKCiAgICAgICAgICAvLyBpZiBnb2luZyBmb3J3YXJkIGJ1dCB0byA8IGluZGV4LCB1c2UgdG8gPSBzbGlkZXMubGVuZ3RoICsgdG8KICAgICAgICAgIC8vIGlmIGdvaW5nIGJhY2t3YXJkIGJ1dCB0byA+IGluZGV4LCB1c2UgdG8gPSAtc2xpZGVzLmxlbmd0aCArIHRvCiAgICAgICAgICBpZiAoZGlyZWN0aW9uICE9PSBuYXR1cmFsX2RpcmVjdGlvbikgdG8gPSAgLWRpcmVjdGlvbiAqIHNsaWRlcy5sZW5ndGggKyB0bzsKCiAgICAgICAgfQoKICAgICAgICB2YXIgZGlmZiA9IE1hdGguYWJzKGluZGV4LXRvKSAtIDE7CgogICAgICAgIC8vIG1vdmUgYWxsIHRoZSBzbGlkZXMgYmV0d2VlbiBpbmRleCBhbmQgdG8gaW4gdGhlIHJpZ2h0IGRpcmVjdGlvbgogICAgICAgIHdoaWxlIChkaWZmLS0pIG1vdmUoIGNpcmNsZSgodG8gPiBpbmRleCA/IHRvIDogaW5kZXgpIC0gZGlmZiAtIDEpLCB3aWR0aCAqIGRpcmVjdGlvbiwgMCk7CgogICAgICAgIHRvID0gY2lyY2xlKHRvKTsKCiAgICAgICAgbW92ZShpbmRleCwgd2lkdGggKiBkaXJlY3Rpb24sIHNsaWRlU3BlZWQgfHwgc3BlZWQpOwogICAgICAgIG1vdmUodG8sIDAsIHNsaWRlU3BlZWQgfHwgc3BlZWQpOwoKICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSBtb3ZlKGNpcmNsZSh0byAtIGRpcmVjdGlvbiksIC0od2lkdGggKiBkaXJlY3Rpb24pLCAwKTsgLy8gd2UgbmVlZCB0byBnZXQgdGhlIG5leHQgaW4gcGxhY2UKCiAgICAgIH0gZWxzZSB7CgogICAgICAgIHRvID0gY2lyY2xlKHRvKTsKICAgICAgICBhbmltYXRlKGluZGV4ICogLXdpZHRoLCB0byAqIC13aWR0aCwgc2xpZGVTcGVlZCB8fCBzcGVlZCk7CiAgICAgICAgLy9ubyBmYWxsYmFjayBmb3IgYSBjaXJjdWxhciBjb250aW51b3VzIGlmIHRoZSBicm93c2VyIGRvZXMgbm90IGFjY2VwdCB0cmFuc2l0aW9ucwogICAgICB9CgogICAgICBpbmRleCA9IHRvOwogICAgICBvZmZsb2FkRm4ob3B0aW9ucy5jYWxsYmFjayAmJiBvcHRpb25zLmNhbGxiYWNrKGluZGV4LCBzbGlkZXNbaW5kZXhdKSk7CiAgICB9CgogICAgZnVuY3Rpb24gbW92ZShpbmRleCwgZGlzdCwgc3BlZWQpIHsKCiAgICAgIHRyYW5zbGF0ZShpbmRleCwgZGlzdCwgc3BlZWQpOwogICAgICBzbGlkZVBvc1tpbmRleF0gPSBkaXN0OwoKICAgIH0KCiAgICBmdW5jdGlvbiB0cmFuc2xhdGUoaW5kZXgsIGRpc3QsIHNwZWVkKSB7CgogICAgICB2YXIgc2xpZGUgPSBzbGlkZXNbaW5kZXhdOwogICAgICB2YXIgc3R5bGUgPSBzbGlkZSAmJiBzbGlkZS5zdHlsZTsKCiAgICAgIGlmICghc3R5bGUpIHJldHVybjsKCiAgICAgIHN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9CiAgICAgIHN0eWxlLk1velRyYW5zaXRpb25EdXJhdGlvbiA9CiAgICAgIHN0eWxlLm1zVHJhbnNpdGlvbkR1cmF0aW9uID0KICAgICAgc3R5bGUuT1RyYW5zaXRpb25EdXJhdGlvbiA9CiAgICAgIHN0eWxlLnRyYW5zaXRpb25EdXJhdGlvbiA9IHNwZWVkICsgJ21zJzsKCiAgICAgIHN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICd0cmFuc2xhdGUoJyArIGRpc3QgKyAncHgsMCknICsgJ3RyYW5zbGF0ZVooMCknOwogICAgICBzdHlsZS5tc1RyYW5zZm9ybSA9CiAgICAgIHN0eWxlLk1velRyYW5zZm9ybSA9CiAgICAgIHN0eWxlLk9UcmFuc2Zvcm0gPSAndHJhbnNsYXRlWCgnICsgZGlzdCArICdweCknOwoKICAgIH0KCiAgICBmdW5jdGlvbiBhbmltYXRlKGZyb20sIHRvLCBzcGVlZCkgewoKICAgICAgLy8gaWYgbm90IGFuIGFuaW1hdGlvbiwganVzdCByZXBvc2l0aW9uCiAgICAgIGlmICghc3BlZWQpIHsKCiAgICAgICAgZWxlbWVudC5zdHlsZS5sZWZ0ID0gdG8gKyAncHgnOwogICAgICAgIHJldHVybjsKCiAgICAgIH0KCiAgICAgIHZhciBzdGFydCA9ICtuZXcgRGF0ZSgpOwoKICAgICAgdmFyIHRpbWVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciB0aW1lRWxhcCA9ICtuZXcgRGF0ZSgpIC0gc3RhcnQ7CgogICAgICAgIGlmICh0aW1lRWxhcCA+IHNwZWVkKSB7CgogICAgICAgICAgZWxlbWVudC5zdHlsZS5sZWZ0ID0gdG8gKyAncHgnOwoKICAgICAgICAgIGlmIChkZWxheSkgYmVnaW4oKTsKCiAgICAgICAgICBvcHRpb25zLnRyYW5zaXRpb25FbmQgJiYgb3B0aW9ucy50cmFuc2l0aW9uRW5kLmNhbGwoZXZlbnQsIGluZGV4LCBzbGlkZXNbaW5kZXhdKTsKCiAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVyKTsKICAgICAgICAgIHJldHVybjsKCiAgICAgICAgfQoKICAgICAgICBlbGVtZW50LnN0eWxlLmxlZnQgPSAoKCAodG8gLSBmcm9tKSAqIChNYXRoLmZsb29yKCh0aW1lRWxhcCAvIHNwZWVkKSAqIDEwMCkgLyAxMDApICkgKyBmcm9tKSArICdweCc7CgogICAgICB9LCA0KTsKCiAgICB9CgogICAgLy8gc2V0dXAgYXV0byBzbGlkZXNob3cKICAgIHZhciBkZWxheSA9IG9wdGlvbnMuYXV0byB8fCAwOwogICAgdmFyIGludGVydmFsOwoKICAgIGZ1bmN0aW9uIGJlZ2luKCkgewoKICAgICAgaW50ZXJ2YWwgPSBzZXRUaW1lb3V0KG5leHQsIGRlbGF5KTsKCiAgICB9CgogICAgZnVuY3Rpb24gc3RvcCgpIHsKCiAgICAgIGRlbGF5ID0gb3B0aW9ucy5hdXRvIHx8IDA7CiAgICAgIGNsZWFyVGltZW91dChpbnRlcnZhbCk7CgogICAgfQoKCiAgICAvLyBzZXR1cCBpbml0aWFsIHZhcnMKICAgIHZhciBzdGFydCA9IHt9OwogICAgdmFyIGRlbHRhID0ge307CiAgICB2YXIgaXNTY3JvbGxpbmc7CgogICAgLy8gc2V0dXAgZXZlbnQgY2FwdHVyaW5nCiAgICB2YXIgZXZlbnRzID0gewoKICAgICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYoZXZlbnQudHlwZSA9PSAnbW91c2Vkb3duJyB8fCBldmVudC50eXBlID09ICdtb3VzZXVwJyB8fCBldmVudC50eXBlID09ICdtb3VzZW1vdmUnKSB7CiAgICAgICAgICBldmVudC50b3VjaGVzID0gW3sKICAgICAgICAgICAgcGFnZVg6IGV2ZW50LnBhZ2VYLAogICAgICAgICAgICBwYWdlWTogZXZlbnQucGFnZVkKICAgICAgICAgIH1dOwogICAgICAgIH0KCiAgICAgICAgc3dpdGNoIChldmVudC50eXBlKSB7CiAgICAgICAgICBjYXNlICdtb3VzZWRvd24nOiB0aGlzLnN0YXJ0KGV2ZW50KTsgYnJlYWs7CiAgICAgICAgICBjYXNlICd0b3VjaHN0YXJ0JzogdGhpcy5zdGFydChldmVudCk7IGJyZWFrOwogICAgICAgICAgY2FzZSAndG91Y2htb3ZlJzogdGhpcy50b3VjaG1vdmUoZXZlbnQpOyBicmVhazsKICAgICAgICAgIGNhc2UgJ21vdXNlbW92ZSc6IHRoaXMudG91Y2htb3ZlKGV2ZW50KTsgYnJlYWs7CiAgICAgICAgICBjYXNlICd0b3VjaGVuZCc6IG9mZmxvYWRGbih0aGlzLmVuZChldmVudCkpOyBicmVhazsKICAgICAgICAgIGNhc2UgJ21vdXNldXAnOiBvZmZsb2FkRm4odGhpcy5lbmQoZXZlbnQpKTsgYnJlYWs7CiAgICAgICAgICBjYXNlICd3ZWJraXRUcmFuc2l0aW9uRW5kJzoKICAgICAgICAgIGNhc2UgJ21zVHJhbnNpdGlvbkVuZCc6CiAgICAgICAgICBjYXNlICdvVHJhbnNpdGlvbkVuZCc6CiAgICAgICAgICBjYXNlICdvdHJhbnNpdGlvbmVuZCc6CiAgICAgICAgICBjYXNlICd0cmFuc2l0aW9uZW5kJzogb2ZmbG9hZEZuKHRoaXMudHJhbnNpdGlvbkVuZChldmVudCkpOyBicmVhazsKICAgICAgICAgIGNhc2UgJ3Jlc2l6ZSc6IG9mZmxvYWRGbihzZXR1cCk7IGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnMuc3RvcFByb3BhZ2F0aW9uKSBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgIH0sCiAgICAgIHN0YXJ0OiBmdW5jdGlvbihldmVudCkgewoKICAgICAgICB2YXIgdG91Y2hlcyA9IGV2ZW50LnRvdWNoZXNbMF07CgogICAgICAgIC8vIG1lYXN1cmUgc3RhcnQgdmFsdWVzCiAgICAgICAgc3RhcnQgPSB7CgogICAgICAgICAgLy8gZ2V0IGluaXRpYWwgdG91Y2ggY29vcmRzCiAgICAgICAgICB4OiB0b3VjaGVzLnBhZ2VYLAogICAgICAgICAgeTogdG91Y2hlcy5wYWdlWSwKCiAgICAgICAgICAvLyBzdG9yZSB0aW1lIHRvIGRldGVybWluZSB0b3VjaCBkdXJhdGlvbgogICAgICAgICAgdGltZTogK25ldyBEYXRlKCkKCiAgICAgICAgfTsKCiAgICAgICAgLy8gdXNlZCBmb3IgdGVzdGluZyBmaXJzdCBtb3ZlIGV2ZW50CiAgICAgICAgaXNTY3JvbGxpbmcgPSB1bmRlZmluZWQ7CgogICAgICAgIC8vIHJlc2V0IGRlbHRhIGFuZCBlbmQgbWVhc3VyZW1lbnRzCiAgICAgICAgZGVsdGEgPSB7fTsKCiAgICAgICAgLy8gYXR0YWNoIHRvdWNobW92ZSBhbmQgdG91Y2hlbmQgbGlzdGVuZXJzCiAgICAgICAgaWYoYnJvd3Nlci50b3VjaCkgewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcywgZmFsc2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMsIGZhbHNlKTsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMsIGZhbHNlKTsKICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICB0b3VjaG1vdmU6IGZ1bmN0aW9uKGV2ZW50KSB7CgogICAgICAgIC8vIGVuc3VyZSBzd2lwaW5nIHdpdGggb25lIHRvdWNoIGFuZCBub3QgcGluY2hpbmcKICAgICAgICAvLyBlbnN1cmUgc2xpZGluZyBpcyBlbmFibGVkCiAgICAgICAgaWYgKGV2ZW50LnRvdWNoZXMubGVuZ3RoID4gMSB8fAogICAgICAgICAgICBldmVudC5zY2FsZSAmJiBldmVudC5zY2FsZSAhPT0gMSB8fAogICAgICAgICAgICBzbGlkZXIuc2xpZGVJc0Rpc2FibGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5kaXNhYmxlU2Nyb2xsKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICB2YXIgdG91Y2hlcyA9IGV2ZW50LnRvdWNoZXNbMF07CgogICAgICAgIC8vIG1lYXN1cmUgY2hhbmdlIGluIHggYW5kIHkKICAgICAgICBkZWx0YSA9IHsKICAgICAgICAgIHg6IHRvdWNoZXMucGFnZVggLSBzdGFydC54LAogICAgICAgICAgeTogdG91Y2hlcy5wYWdlWSAtIHN0YXJ0LnkKICAgICAgICB9OwoKICAgICAgICAvLyBkZXRlcm1pbmUgaWYgc2Nyb2xsaW5nIHRlc3QgaGFzIHJ1biAtIG9uZSB0aW1lIHRlc3QKICAgICAgICBpZiAoIHR5cGVvZiBpc1Njcm9sbGluZyA9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgaXNTY3JvbGxpbmcgPSAhISggaXNTY3JvbGxpbmcgfHwgTWF0aC5hYnMoZGVsdGEueCkgPCBNYXRoLmFicyhkZWx0YS55KSApOwogICAgICAgIH0KCiAgICAgICAgLy8gaWYgdXNlciBpcyBub3QgdHJ5aW5nIHRvIHNjcm9sbCB2ZXJ0aWNhbGx5CiAgICAgICAgaWYgKCFpc1Njcm9sbGluZykgewoKICAgICAgICAgIC8vIHByZXZlbnQgbmF0aXZlIHNjcm9sbGluZwogICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAvLyBzdG9wIHNsaWRlc2hvdwogICAgICAgICAgc3RvcCgpOwoKICAgICAgICAgIC8vIGluY3JlYXNlIHJlc2lzdGFuY2UgaWYgZmlyc3Qgb3IgbGFzdCBzbGlkZQogICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgeyAvLyB3ZSBkb24ndCBhZGQgcmVzaXN0YW5jZSBhdCB0aGUgZW5kCgogICAgICAgICAgICB0cmFuc2xhdGUoY2lyY2xlKGluZGV4LTEpLCBkZWx0YS54ICsgc2xpZGVQb3NbY2lyY2xlKGluZGV4LTEpXSwgMCk7CiAgICAgICAgICAgIHRyYW5zbGF0ZShpbmRleCwgZGVsdGEueCArIHNsaWRlUG9zW2luZGV4XSwgMCk7CiAgICAgICAgICAgIHRyYW5zbGF0ZShjaXJjbGUoaW5kZXgrMSksIGRlbHRhLnggKyBzbGlkZVBvc1tjaXJjbGUoaW5kZXgrMSldLCAwKTsKCiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgZGVsdGEueCA9CiAgICAgICAgICAgICAgZGVsdGEueCAvCiAgICAgICAgICAgICAgICAoICghaW5kZXggJiYgZGVsdGEueCA+IDAgfHwgICAgICAgICAvLyBpZiBmaXJzdCBzbGlkZSBhbmQgc2xpZGluZyBsZWZ0CiAgICAgICAgICAgICAgICAgIGluZGV4ID09IHNsaWRlcy5sZW5ndGggLSAxICYmICAgICAvLyBvciBpZiBsYXN0IHNsaWRlIGFuZCBzbGlkaW5nIHJpZ2h0CiAgICAgICAgICAgICAgICAgIGRlbHRhLnggPCAwICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgaWYgc2xpZGluZyBhdCBhbGwKICAgICAgICAgICAgICAgICkgPwogICAgICAgICAgICAgICAgKCBNYXRoLmFicyhkZWx0YS54KSAvIHdpZHRoICsgMSApICAgICAgLy8gZGV0ZXJtaW5lIHJlc2lzdGFuY2UgbGV2ZWwKICAgICAgICAgICAgICAgIDogMSApOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIHJlc2lzdGFuY2UgaWYgZmFsc2UKCiAgICAgICAgICAgIC8vIHRyYW5zbGF0ZSAxOjEKICAgICAgICAgICAgdHJhbnNsYXRlKGluZGV4LTEsIGRlbHRhLnggKyBzbGlkZVBvc1tpbmRleC0xXSwgMCk7CiAgICAgICAgICAgIHRyYW5zbGF0ZShpbmRleCwgZGVsdGEueCArIHNsaWRlUG9zW2luZGV4XSwgMCk7CiAgICAgICAgICAgIHRyYW5zbGF0ZShpbmRleCsxLCBkZWx0YS54ICsgc2xpZGVQb3NbaW5kZXgrMV0sIDApOwogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICB9LAogICAgICBlbmQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgogICAgICAgIC8vIG1lYXN1cmUgZHVyYXRpb24KICAgICAgICB2YXIgZHVyYXRpb24gPSArbmV3IERhdGUoKSAtIHN0YXJ0LnRpbWU7CgogICAgICAgIC8vIGRldGVybWluZSBpZiBzbGlkZSBhdHRlbXB0IHRyaWdnZXJzIG5leHQvcHJldiBzbGlkZQogICAgICAgIHZhciBpc1ZhbGlkU2xpZGUgPQogICAgICAgICAgICAgIE51bWJlcihkdXJhdGlvbikgPCAyNTAgJiYgICAgICAgICAvLyBpZiBzbGlkZSBkdXJhdGlvbiBpcyBsZXNzIHRoYW4gMjUwbXMKICAgICAgICAgICAgICBNYXRoLmFicyhkZWx0YS54KSA+IDIwIHx8ICAgICAgICAgLy8gYW5kIGlmIHNsaWRlIGFtdCBpcyBncmVhdGVyIHRoYW4gMjBweAogICAgICAgICAgICAgIE1hdGguYWJzKGRlbHRhLngpID4gd2lkdGgvMjsgICAgICAvLyBvciBpZiBzbGlkZSBhbXQgaXMgZ3JlYXRlciB0aGFuIGhhbGYgdGhlIHdpZHRoCgogICAgICAgIC8vIGRldGVybWluZSBpZiBzbGlkZSBhdHRlbXB0IGlzIHBhc3Qgc3RhcnQgYW5kIGVuZAogICAgICAgIHZhciBpc1Bhc3RCb3VuZHMgPSAoIWluZGV4ICYmIGRlbHRhLnggPiAwKSB8fCAgICAgIC8vIGlmIGZpcnN0IHNsaWRlIGFuZCBzbGlkZSBhbXQgaXMgZ3JlYXRlciB0aGFuIDAKICAgICAgICAgICAgICAoaW5kZXggPT0gc2xpZGVzLmxlbmd0aCAtIDEgJiYgZGVsdGEueCA8IDApOyAvLyBvciBpZiBsYXN0IHNsaWRlIGFuZCBzbGlkZSBhbXQgaXMgbGVzcyB0aGFuIDAKCiAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgaXNQYXN0Qm91bmRzID0gZmFsc2U7CgogICAgICAgIC8vIGRldGVybWluZSBkaXJlY3Rpb24gb2Ygc3dpcGUgKHRydWU6cmlnaHQsIGZhbHNlOmxlZnQpCiAgICAgICAgdmFyIGRpcmVjdGlvbiA9IGRlbHRhLnggPCAwOwoKICAgICAgICAvLyBpZiBub3Qgc2Nyb2xsaW5nIHZlcnRpY2FsbHkKICAgICAgICBpZiAoIWlzU2Nyb2xsaW5nKSB7CgogICAgICAgICAgaWYgKGlzVmFsaWRTbGlkZSAmJiAhaXNQYXN0Qm91bmRzKSB7CgogICAgICAgICAgICBpZiAoZGlyZWN0aW9uKSB7CgogICAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHsgLy8gd2UgbmVlZCB0byBnZXQgdGhlIG5leHQgaW4gdGhpcyBkaXJlY3Rpb24gaW4gcGxhY2UKCiAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleC0xKSwgLXdpZHRoLCAwKTsKICAgICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzIpLCB3aWR0aCwgMCk7CgogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtb3ZlKGluZGV4LTEsIC13aWR0aCwgMCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBtb3ZlKGluZGV4LCBzbGlkZVBvc1tpbmRleF0td2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleCsxKSwgc2xpZGVQb3NbY2lyY2xlKGluZGV4KzEpXS13aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgIGluZGV4ID0gY2lyY2xlKGluZGV4KzEpOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSB7IC8vIHdlIG5lZWQgdG8gZ2V0IHRoZSBuZXh0IGluIHRoaXMgZGlyZWN0aW9uIGluIHBsYWNlCgogICAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgrMSksIHdpZHRoLCAwKTsKICAgICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4LTIpLCAtd2lkdGgsIDApOwoKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbW92ZShpbmRleCsxLCB3aWR0aCwgMCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBtb3ZlKGluZGV4LCBzbGlkZVBvc1tpbmRleF0rd2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleC0xKSwgc2xpZGVQb3NbY2lyY2xlKGluZGV4LTEpXSt3aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgIGluZGV4ID0gY2lyY2xlKGluZGV4LTEpOwoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3B0aW9ucy5jYWxsYmFjayAmJiBvcHRpb25zLmNhbGxiYWNrKGluZGV4LCBzbGlkZXNbaW5kZXhdKTsKCiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgewoKICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleC0xKSwgLXdpZHRoLCBzcGVlZCk7CiAgICAgICAgICAgICAgbW92ZShpbmRleCwgMCwgc3BlZWQpOwogICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzEpLCB3aWR0aCwgc3BlZWQpOwoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgbW92ZShpbmRleC0xLCAtd2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgICBtb3ZlKGluZGV4LCAwLCBzcGVlZCk7CiAgICAgICAgICAgICAgbW92ZShpbmRleCsxLCB3aWR0aCwgc3BlZWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIC8vIGtpbGwgdG91Y2htb3ZlIGFuZCB0b3VjaGVuZCBldmVudCBsaXN0ZW5lcnMgdW50aWwgdG91Y2hzdGFydCBjYWxsZWQgYWdhaW4KICAgICAgICBpZihicm93c2VyLnRvdWNoKSB7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgfQoKICAgICAgfSwKICAgICAgdHJhbnNpdGlvbkVuZDogZnVuY3Rpb24oZXZlbnQpIHsKCiAgICAgICAgaWYgKHBhcnNlSW50KGV2ZW50LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtaW5kZXgnKSwgMTApID09IGluZGV4KSB7CgogICAgICAgICAgaWYgKGRlbGF5KSBiZWdpbigpOwoKICAgICAgICAgIG9wdGlvbnMudHJhbnNpdGlvbkVuZCAmJiBvcHRpb25zLnRyYW5zaXRpb25FbmQuY2FsbChldmVudCwgaW5kZXgsIHNsaWRlc1tpbmRleF0pOwoKICAgICAgICB9CgogICAgICB9CgogICAgfTsKCiAgICAvLyBQdWJsaWMgQVBJCiAgICB0aGlzLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICBzZXRUaW1lb3V0KHNldHVwKTsKICAgIH07CiAgICB0aGlzLnNldHVwID0gZnVuY3Rpb24oKSB7CiAgICAgIHNldHVwKCk7CiAgICB9OwoKICAgIHRoaXMuZW5hYmxlU2xpZGUgPSBmdW5jdGlvbihzaG91bGRFbmFibGUpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnNsaWRlSXNEaXNhYmxlZCA9ICFzaG91bGRFbmFibGU7CiAgICAgIH0KICAgICAgcmV0dXJuICF0aGlzLnNsaWRlSXNEaXNhYmxlZDsKICAgIH0sCiAgICB0aGlzLnNsaWRlID0gZnVuY3Rpb24odG8sIHNwZWVkKSB7CiAgICAgIC8vIGNhbmNlbCBzbGlkZXNob3cKICAgICAgc3RvcCgpOwoKICAgICAgc2xpZGUodG8sIHNwZWVkKTsKICAgIH07CgogICAgdGhpcy5wcmV2ID0gdGhpcy5wcmV2aW91cyA9IGZ1bmN0aW9uKCkgewogICAgICAvLyBjYW5jZWwgc2xpZGVzaG93CiAgICAgIHN0b3AoKTsKCiAgICAgIHByZXYoKTsKICAgIH07CgogICAgdGhpcy5uZXh0ID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIGNhbmNlbCBzbGlkZXNob3cKICAgICAgc3RvcCgpOwoKICAgICAgbmV4dCgpOwogICAgfTsKCiAgICB0aGlzLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgLy8gY2FuY2VsIHNsaWRlc2hvdwogICAgICBzdG9wKCk7CiAgICB9OwoKICAgIHRoaXMuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgYmVnaW4oKTsKICAgIH07CgogICAgdGhpcy5jdXJyZW50SW5kZXggPSBmdW5jdGlvbigpIHsKICAgICAgLy8gcmV0dXJuIGN1cnJlbnQgaW5kZXggcG9zaXRpb24KICAgICAgcmV0dXJuIGluZGV4OwogICAgfTsKCiAgICB0aGlzLnNsaWRlc0NvdW50ID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIHJldHVybiB0b3RhbCBudW1iZXIgb2Ygc2xpZGVzCiAgICAgIHJldHVybiBsZW5ndGg7CiAgICB9OwoKICAgIHRoaXMua2lsbCA9IGZ1bmN0aW9uKCkgewogICAgICAvLyBjYW5jZWwgc2xpZGVzaG93CiAgICAgIHN0b3AoKTsKCiAgICAgIC8vIHJlc2V0IGVsZW1lbnQKICAgICAgZWxlbWVudC5zdHlsZS53aWR0aCA9ICcnOwogICAgICBlbGVtZW50LnN0eWxlLmxlZnQgPSAnJzsKCiAgICAgIC8vIHJlc2V0IHNsaWRlcwogICAgICB2YXIgcG9zID0gc2xpZGVzLmxlbmd0aDsKICAgICAgd2hpbGUocG9zLS0pIHsKCiAgICAgICAgdmFyIHNsaWRlID0gc2xpZGVzW3Bvc107CiAgICAgICAgc2xpZGUuc3R5bGUud2lkdGggPSAnJzsKICAgICAgICBzbGlkZS5zdHlsZS5sZWZ0ID0gJyc7CgogICAgICAgIGlmIChicm93c2VyLnRyYW5zaXRpb25zKSB0cmFuc2xhdGUocG9zLCAwLCAwKTsKCiAgICAgIH0KCiAgICAgIC8vIHJlbW92ZWQgZXZlbnQgbGlzdGVuZXJzCiAgICAgIGlmIChicm93c2VyLmFkZEV2ZW50TGlzdGVuZXIpIHsKCiAgICAgICAgLy8gcmVtb3ZlIGN1cnJlbnQgZXZlbnQgbGlzdGVuZXJzCiAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtc1RyYW5zaXRpb25FbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ29UcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdvdHJhbnNpdGlvbmVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCBldmVudHMsIGZhbHNlKTsKCiAgICAgIH0KICAgICAgZWxzZSB7CgogICAgICAgIHdpbmRvdy5vbnJlc2l6ZSA9IG51bGw7CgogICAgICB9CiAgICB9OwoKICAgIHRoaXMubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAvLyB0cmlnZ2VyIHNldHVwCiAgICAgIHNldHVwKCk7CgogICAgICAvLyBzdGFydCBhdXRvIHNsaWRlc2hvdyBpZiBhcHBsaWNhYmxlCiAgICAgIGlmIChkZWxheSkgYmVnaW4oKTsKCgogICAgICAvLyBhZGQgZXZlbnQgbGlzdGVuZXJzCiAgICAgIGlmIChicm93c2VyLmFkZEV2ZW50TGlzdGVuZXIpIHsKCiAgICAgICAgLy8gc2V0IHRvdWNoc3RhcnQgZXZlbnQgb24gZWxlbWVudAogICAgICAgIGlmIChicm93c2VyLnRvdWNoKSB7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBldmVudHMsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGlmIChicm93c2VyLnRyYW5zaXRpb25zKSB7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbXNUcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ29UcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ290cmFuc2l0aW9uZW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIC8vIHNldCByZXNpemUgZXZlbnQgb24gd2luZG93CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGV2ZW50cywgZmFsc2UpOwoKICAgICAgfSBlbHNlIHsKCiAgICAgICAgd2luZG93Lm9ucmVzaXplID0gZnVuY3Rpb24gKCkgeyBzZXR1cCgpOyB9OyAvLyB0byBwbGF5IG5pY2Ugd2l0aCBvbGQgSUUKCiAgICAgIH0KICAgIH07CgogIH0KfSk7Cgp9KShpb25pYyk7CgooZnVuY3Rpb24oaW9uaWMpIHsKJ3VzZSBzdHJpY3QnOwoKICBpb25pYy52aWV3cy5Ub2dnbGUgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICB0aGlzLmVsID0gb3B0cy5lbDsKICAgICAgdGhpcy5jaGVja2JveCA9IG9wdHMuY2hlY2tib3g7CiAgICAgIHRoaXMudHJhY2sgPSBvcHRzLnRyYWNrOwogICAgICB0aGlzLmhhbmRsZSA9IG9wdHMuaGFuZGxlOwogICAgICB0aGlzLm9wZW5QZXJjZW50ID0gLTE7CiAgICAgIHRoaXMub25DaGFuZ2UgPSBvcHRzLm9uQ2hhbmdlIHx8IGZ1bmN0aW9uKCkge307CgogICAgICB0aGlzLnRyaWdnZXJUaHJlc2hvbGQgPSBvcHRzLnRyaWdnZXJUaHJlc2hvbGQgfHwgMjA7CgogICAgICB0aGlzLmRyYWdTdGFydEhhbmRsZXIgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgc2VsZi5kcmFnU3RhcnQoZSk7CiAgICAgIH07CiAgICAgIHRoaXMuZHJhZ0hhbmRsZXIgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgc2VsZi5kcmFnKGUpOwogICAgICB9OwogICAgICB0aGlzLmhvbGRIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgIHNlbGYuaG9sZChlKTsKICAgICAgfTsKICAgICAgdGhpcy5yZWxlYXNlSGFuZGxlciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBzZWxmLnJlbGVhc2UoZSk7CiAgICAgIH07CgogICAgICB0aGlzLmRyYWdTdGFydEdlc3R1cmUgPSBpb25pYy5vbkdlc3R1cmUoJ2RyYWdzdGFydCcsIHRoaXMuZHJhZ1N0YXJ0SGFuZGxlciwgdGhpcy5lbCk7CiAgICAgIHRoaXMuZHJhZ0dlc3R1cmUgPSBpb25pYy5vbkdlc3R1cmUoJ2RyYWcnLCB0aGlzLmRyYWdIYW5kbGVyLCB0aGlzLmVsKTsKICAgICAgdGhpcy5kcmFnSG9sZEdlc3R1cmUgPSBpb25pYy5vbkdlc3R1cmUoJ2hvbGQnLCB0aGlzLmhvbGRIYW5kbGVyLCB0aGlzLmVsKTsKICAgICAgdGhpcy5kcmFnUmVsZWFzZUdlc3R1cmUgPSBpb25pYy5vbkdlc3R1cmUoJ3JlbGVhc2UnLCB0aGlzLnJlbGVhc2VIYW5kbGVyLCB0aGlzLmVsKTsKICAgIH0sCgogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgIGlvbmljLm9mZkdlc3R1cmUodGhpcy5kcmFnU3RhcnRHZXN0dXJlLCAnZHJhZ3N0YXJ0JywgdGhpcy5kcmFnU3RhcnRHZXN0dXJlKTsKICAgICAgaW9uaWMub2ZmR2VzdHVyZSh0aGlzLmRyYWdHZXN0dXJlLCAnZHJhZycsIHRoaXMuZHJhZ0dlc3R1cmUpOwogICAgICBpb25pYy5vZmZHZXN0dXJlKHRoaXMuZHJhZ0hvbGRHZXN0dXJlLCAnaG9sZCcsIHRoaXMuaG9sZEhhbmRsZXIpOwogICAgICBpb25pYy5vZmZHZXN0dXJlKHRoaXMuZHJhZ1JlbGVhc2VHZXN0dXJlLCAncmVsZWFzZScsIHRoaXMucmVsZWFzZUhhbmRsZXIpOwogICAgfSwKCiAgICB0YXA6IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYodGhpcy5lbC5nZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJykgIT09ICdkaXNhYmxlZCcpIHsKICAgICAgICB0aGlzLnZhbCggIXRoaXMuY2hlY2tib3guY2hlY2tlZCApOwogICAgICB9CiAgICB9LAoKICAgIGRyYWdTdGFydDogZnVuY3Rpb24oZSkgewogICAgICBpZih0aGlzLmNoZWNrYm94LmRpc2FibGVkKSByZXR1cm47CgogICAgICB0aGlzLl9kcmFnSW5mbyA9IHsKICAgICAgICB3aWR0aDogdGhpcy5lbC5vZmZzZXRXaWR0aCwKICAgICAgICBsZWZ0OiB0aGlzLmVsLm9mZnNldExlZnQsCiAgICAgICAgcmlnaHQ6IHRoaXMuZWwub2Zmc2V0TGVmdCArIHRoaXMuZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgdHJpZ2dlclg6IHRoaXMuZWwub2Zmc2V0V2lkdGggLyAyLAogICAgICAgIGluaXRpYWxTdGF0ZTogdGhpcy5jaGVja2JveC5jaGVja2VkCiAgICAgIH07CgogICAgICAvLyBTdG9wIGFueSBwYXJlbnQgZHJhZ2dpbmcKICAgICAgZS5nZXN0dXJlLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAvLyBUcmlnZ2VyIGhvbGQgc3R5bGVzCiAgICAgIHRoaXMuaG9sZChlKTsKICAgIH0sCgogICAgZHJhZzogZnVuY3Rpb24oZSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmKCF0aGlzLl9kcmFnSW5mbykgeyByZXR1cm47IH0KCiAgICAgIC8vIFN0b3AgYW55IHBhcmVudCBkcmFnZ2luZwogICAgICBlLmdlc3R1cmUuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbihhbW91bnQpIHsKICAgICAgICBpZiAoIXNlbGYuX2RyYWdJbmZvKSB7IHJldHVybjsgfQoKICAgICAgICB2YXIgc2xpZGVQYWdlTGVmdCA9IHNlbGYudHJhY2sub2Zmc2V0TGVmdCArIChzZWxmLmhhbmRsZS5vZmZzZXRXaWR0aCAvIDIpOwogICAgICAgIHZhciBzbGlkZVBhZ2VSaWdodCA9IHNlbGYudHJhY2sub2Zmc2V0TGVmdCArIHNlbGYudHJhY2sub2Zmc2V0V2lkdGggLSAoc2VsZi5oYW5kbGUub2Zmc2V0V2lkdGggLyAyKTsKICAgICAgICB2YXIgZHggPSBlLmdlc3R1cmUuZGVsdGFYOwoKICAgICAgICB2YXIgcHggPSBlLmdlc3R1cmUudG91Y2hlc1swXS5wYWdlWCAtIHNlbGYuX2RyYWdJbmZvLmxlZnQ7CiAgICAgICAgdmFyIG14ID0gc2VsZi5fZHJhZ0luZm8ud2lkdGggLSBzZWxmLnRyaWdnZXJUaHJlc2hvbGQ7CgogICAgICAgIC8vIFRoZSBpbml0aWFsIHN0YXRlIHdhcyBvbiwgc28gInRlbmQgdG93YXJkcyIgb24KICAgICAgICBpZihzZWxmLl9kcmFnSW5mby5pbml0aWFsU3RhdGUpIHsKICAgICAgICAgIGlmKHB4IDwgc2VsZi50cmlnZ2VyVGhyZXNob2xkKSB7CiAgICAgICAgICAgIHNlbGYuc2V0T3BlblBlcmNlbnQoMCk7CiAgICAgICAgICB9IGVsc2UgaWYocHggPiBzZWxmLl9kcmFnSW5mby50cmlnZ2VyWCkgewogICAgICAgICAgICBzZWxmLnNldE9wZW5QZXJjZW50KDEwMCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFRoZSBpbml0aWFsIHN0YXRlIHdhcyBvZmYsIHNvICJ0ZW5kIHRvd2FyZHMiIG9mZgogICAgICAgICAgaWYocHggPCBzZWxmLl9kcmFnSW5mby50cmlnZ2VyWCkgewogICAgICAgICAgICBzZWxmLnNldE9wZW5QZXJjZW50KDApOwogICAgICAgICAgfSBlbHNlIGlmKHB4ID4gbXgpIHsKICAgICAgICAgICAgc2VsZi5zZXRPcGVuUGVyY2VudCgxMDApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIGVuZERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgdGhpcy5fZHJhZ0luZm8gPSBudWxsOwogICAgfSwKCiAgICBob2xkOiBmdW5jdGlvbihlKSB7CiAgICAgIHRoaXMuZWwuY2xhc3NMaXN0LmFkZCgnZHJhZ2dpbmcnKTsKICAgIH0sCiAgICByZWxlYXNlOiBmdW5jdGlvbihlKSB7CiAgICAgIHRoaXMuZWwuY2xhc3NMaXN0LnJlbW92ZSgnZHJhZ2dpbmcnKTsKICAgICAgdGhpcy5lbmREcmFnKGUpOwogICAgfSwKCgogICAgc2V0T3BlblBlcmNlbnQ6IGZ1bmN0aW9uKG9wZW5QZXJjZW50KSB7CiAgICAgIC8vIG9ubHkgbWFrZSBhIGNoYW5nZSBpZiB0aGUgbmV3IG9wZW4gcGVyY2VudCBoYXMgY2hhbmdlZAogICAgICBpZih0aGlzLm9wZW5QZXJjZW50IDwgMCB8fCAob3BlblBlcmNlbnQgPCAodGhpcy5vcGVuUGVyY2VudCAtIDMpIHx8IG9wZW5QZXJjZW50ID4gKHRoaXMub3BlblBlcmNlbnQgKyAzKSApICkgewogICAgICAgIHRoaXMub3BlblBlcmNlbnQgPSBvcGVuUGVyY2VudDsKCiAgICAgICAgaWYob3BlblBlcmNlbnQgPT09IDApIHsKICAgICAgICAgIHRoaXMudmFsKGZhbHNlKTsKICAgICAgICB9IGVsc2UgaWYob3BlblBlcmNlbnQgPT09IDEwMCkgewogICAgICAgICAgdGhpcy52YWwodHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBvcGVuUGl4ZWwgPSBNYXRoLnJvdW5kKCAob3BlblBlcmNlbnQgLyAxMDApICogdGhpcy50cmFjay5vZmZzZXRXaWR0aCAtICh0aGlzLmhhbmRsZS5vZmZzZXRXaWR0aCkgKTsKICAgICAgICAgIG9wZW5QaXhlbCA9IChvcGVuUGl4ZWwgPCAxID8gMCA6IG9wZW5QaXhlbCk7CiAgICAgICAgICB0aGlzLmhhbmRsZS5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgnICsgb3BlblBpeGVsICsgJ3B4LDAsMCknOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICB2YWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmKHZhbHVlID09PSB0cnVlIHx8IHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIGlmKHRoaXMuaGFuZGxlLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dICE9PSAiIikgewogICAgICAgICAgdGhpcy5oYW5kbGUuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAiIjsKICAgICAgICB9CiAgICAgICAgdGhpcy5jaGVja2JveC5jaGVja2VkID0gdmFsdWU7CiAgICAgICAgdGhpcy5vcGVuUGVyY2VudCA9ICh2YWx1ZSA/IDEwMCA6IDApOwogICAgICAgIHRoaXMub25DaGFuZ2UgJiYgdGhpcy5vbkNoYW5nZSgpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmNoZWNrYm94LmNoZWNrZWQ7CiAgICB9CgogIH0pOwoKfSkoaW9uaWMpOwoKfSkoKTsKLyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qKgogKiBAbGljZW5zZSBBbmd1bGFySlMgdjEuMi4xNwogKiAoYykgMjAxMC0yMDE0IEdvb2dsZSwgSW5jLiBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpIHsndXNlIHN0cmljdCc7CgovKioKICogQGRlc2NyaXB0aW9uCiAqCiAqIFRoaXMgb2JqZWN0IHByb3ZpZGVzIGEgdXRpbGl0eSBmb3IgcHJvZHVjaW5nIHJpY2ggRXJyb3IgbWVzc2FnZXMgd2l0aGluCiAqIEFuZ3VsYXIuIEl0IGNhbiBiZSBjYWxsZWQgYXMgZm9sbG93czoKICoKICogdmFyIGV4YW1wbGVNaW5FcnIgPSBtaW5FcnIoJ2V4YW1wbGUnKTsKICogdGhyb3cgZXhhbXBsZU1pbkVycignb25lJywgJ1RoaXMgezB9IGlzIHsxfScsIGZvbywgYmFyKTsKICoKICogVGhlIGFib3ZlIGNyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgbWluRXJyIGluIHRoZSBleGFtcGxlIG5hbWVzcGFjZS4gVGhlCiAqIHJlc3VsdGluZyBlcnJvciB3aWxsIGhhdmUgYSBuYW1lc3BhY2VkIGVycm9yIGNvZGUgb2YgZXhhbXBsZS5vbmUuICBUaGUKICogcmVzdWx0aW5nIGVycm9yIHdpbGwgcmVwbGFjZSB7MH0gd2l0aCB0aGUgdmFsdWUgb2YgZm9vLCBhbmQgezF9IHdpdGggdGhlCiAqIHZhbHVlIG9mIGJhci4gVGhlIG9iamVjdCBpcyBub3QgcmVzdHJpY3RlZCBpbiB0aGUgbnVtYmVyIG9mIGFyZ3VtZW50cyBpdCBjYW4KICogdGFrZS4KICoKICogSWYgZmV3ZXIgYXJndW1lbnRzIGFyZSBzcGVjaWZpZWQgdGhhbiBuZWNlc3NhcnkgZm9yIGludGVycG9sYXRpb24sIHRoZSBleHRyYQogKiBpbnRlcnBvbGF0aW9uIG1hcmtlcnMgd2lsbCBiZSBwcmVzZXJ2ZWQgaW4gdGhlIGZpbmFsIHN0cmluZy4KICoKICogU2luY2UgZGF0YSB3aWxsIGJlIHBhcnNlZCBzdGF0aWNhbGx5IGR1cmluZyBhIGJ1aWxkIHN0ZXAsIHNvbWUgcmVzdHJpY3Rpb25zCiAqIGFyZSBhcHBsaWVkIHdpdGggcmVzcGVjdCB0byBob3cgbWluRXJyIGluc3RhbmNlcyBhcmUgY3JlYXRlZCBhbmQgY2FsbGVkLgogKiBJbnN0YW5jZXMgc2hvdWxkIGhhdmUgbmFtZXMgb2YgdGhlIGZvcm0gbmFtZXNwYWNlTWluRXJyIGZvciBhIG1pbkVyciBjcmVhdGVkCiAqIHVzaW5nIG1pbkVycignbmFtZXNwYWNlJykgLiBFcnJvciBjb2RlcywgbmFtZXNwYWNlcyBhbmQgdGVtcGxhdGUgc3RyaW5ncwogKiBzaG91bGQgYWxsIGJlIHN0YXRpYyBzdHJpbmdzLCBub3QgdmFyaWFibGVzIG9yIGdlbmVyYWwgZXhwcmVzc2lvbnMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGUgVGhlIG5hbWVzcGFjZSB0byB1c2UgZm9yIHRoZSBuZXcgbWluRXJyIGluc3RhbmNlLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29kZTpzdHJpbmcsIHRlbXBsYXRlOnN0cmluZywgLi4udGVtcGxhdGVBcmdzKTogRXJyb3J9IG1pbkVyciBpbnN0YW5jZQogKi8KCmZ1bmN0aW9uIG1pbkVycihtb2R1bGUpIHsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvZGUgPSBhcmd1bWVudHNbMF0sCiAgICAgIHByZWZpeCA9ICdbJyArIChtb2R1bGUgPyBtb2R1bGUgKyAnOicgOiAnJykgKyBjb2RlICsgJ10gJywKICAgICAgdGVtcGxhdGUgPSBhcmd1bWVudHNbMV0sCiAgICAgIHRlbXBsYXRlQXJncyA9IGFyZ3VtZW50cywKICAgICAgc3RyaW5naWZ5ID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgIGlmICh0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gb2JqLnRvU3RyaW5nKCkucmVwbGFjZSgvIFx7W1xzXFNdKiQvLCAnJyk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuICd1bmRlZmluZWQnOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmopOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqOwogICAgICB9LAogICAgICBtZXNzYWdlLCBpOwoKICAgIG1lc3NhZ2UgPSBwcmVmaXggKyB0ZW1wbGF0ZS5yZXBsYWNlKC9ce1xkK1x9L2csIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICB2YXIgaW5kZXggPSArbWF0Y2guc2xpY2UoMSwgLTEpLCBhcmc7CgogICAgICBpZiAoaW5kZXggKyAyIDwgdGVtcGxhdGVBcmdzLmxlbmd0aCkgewogICAgICAgIGFyZyA9IHRlbXBsYXRlQXJnc1tpbmRleCArIDJdOwogICAgICAgIGlmICh0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gYXJnLnRvU3RyaW5nKCkucmVwbGFjZSgvID9ce1tcc1xTXSokLywgJycpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gdG9Kc29uKGFyZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcmc7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CgogICAgbWVzc2FnZSA9IG1lc3NhZ2UgKyAnXG5odHRwOi8vZXJyb3JzLmFuZ3VsYXJqcy5vcmcvMS4yLjE3LycgKwogICAgICAobW9kdWxlID8gbW9kdWxlICsgJy8nIDogJycpICsgY29kZTsKICAgIGZvciAoaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UgKyAoaSA9PSAyID8gJz8nIDogJyYnKSArICdwJyArIChpLTIpICsgJz0nICsKICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5KGFyZ3VtZW50c1tpXSkpOwogICAgfQoKICAgIHJldHVybiBuZXcgRXJyb3IobWVzc2FnZSk7CiAgfTsKfQoKLyogV2UgbmVlZCB0byB0ZWxsIGpzaGludCB3aGF0IHZhcmlhYmxlcyBhcmUgYmVpbmcgZXhwb3J0ZWQgKi8KLyogZ2xvYmFsCiAgICAtYW5ndWxhciwKICAgIC1tc2llLAogICAgLWpxTGl0ZSwKICAgIC1qUXVlcnksCiAgICAtc2xpY2UsCiAgICAtcHVzaCwKICAgIC10b1N0cmluZywKICAgIC1uZ01pbkVyciwKICAgIC1hbmd1bGFyTW9kdWxlLAogICAgLW5vZGVOYW1lXywKICAgIC11aWQsCgogICAgLWxvd2VyY2FzZSwKICAgIC11cHBlcmNhc2UsCiAgICAtbWFudWFsTG93ZXJjYXNlLAogICAgLW1hbnVhbFVwcGVyY2FzZSwKICAgIC1ub2RlTmFtZV8sCiAgICAtaXNBcnJheUxpa2UsCiAgICAtZm9yRWFjaCwKICAgIC1zb3J0ZWRLZXlzLAogICAgLWZvckVhY2hTb3J0ZWQsCiAgICAtcmV2ZXJzZVBhcmFtcywKICAgIC1uZXh0VWlkLAogICAgLXNldEhhc2hLZXksCiAgICAtZXh0ZW5kLAogICAgLWludCwKICAgIC1pbmhlcml0LAogICAgLW5vb3AsCiAgICAtaWRlbnRpdHksCiAgICAtdmFsdWVGbiwKICAgIC1pc1VuZGVmaW5lZCwKICAgIC1pc0RlZmluZWQsCiAgICAtaXNPYmplY3QsCiAgICAtaXNTdHJpbmcsCiAgICAtaXNOdW1iZXIsCiAgICAtaXNEYXRlLAogICAgLWlzQXJyYXksCiAgICAtaXNGdW5jdGlvbiwKICAgIC1pc1JlZ0V4cCwKICAgIC1pc1dpbmRvdywKICAgIC1pc1Njb3BlLAogICAgLWlzRmlsZSwKICAgIC1pc0Jsb2IsCiAgICAtaXNCb29sZWFuLAogICAgLXRyaW0sCiAgICAtaXNFbGVtZW50LAogICAgLW1ha2VNYXAsCiAgICAtbWFwLAogICAgLXNpemUsCiAgICAtaW5jbHVkZXMsCiAgICAtaW5kZXhPZiwKICAgIC1hcnJheVJlbW92ZSwKICAgIC1pc0xlYWZOb2RlLAogICAgLWNvcHksCiAgICAtc2hhbGxvd0NvcHksCiAgICAtZXF1YWxzLAogICAgLWNzcCwKICAgIC1jb25jYXQsCiAgICAtc2xpY2VBcmdzLAogICAgLWJpbmQsCiAgICAtdG9Kc29uUmVwbGFjZXIsCiAgICAtdG9Kc29uLAogICAgLWZyb21Kc29uLAogICAgLXRvQm9vbGVhbiwKICAgIC1zdGFydGluZ1RhZywKICAgIC10cnlEZWNvZGVVUklDb21wb25lbnQsCiAgICAtcGFyc2VLZXlWYWx1ZSwKICAgIC10b0tleVZhbHVlLAogICAgLWVuY29kZVVyaVNlZ21lbnQsCiAgICAtZW5jb2RlVXJpUXVlcnksCiAgICAtYW5ndWxhckluaXQsCiAgICAtYm9vdHN0cmFwLAogICAgLXNuYWtlX2Nhc2UsCiAgICAtYmluZEpRdWVyeSwKICAgIC1hc3NlcnRBcmcsCiAgICAtYXNzZXJ0QXJnRm4sCiAgICAtYXNzZXJ0Tm90SGFzT3duUHJvcGVydHksCiAgICAtZ2V0dGVyLAogICAgLWdldEJsb2NrRWxlbWVudHMsCiAgICAtaGFzT3duUHJvcGVydHksCgoqLwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgovKioKICogQG5nZG9jIG1vZHVsZQogKiBAbmFtZSBuZwogKiBAbW9kdWxlIG5nCiAqIEBkZXNjcmlwdGlvbgogKgogKiAjIG5nIChjb3JlIG1vZHVsZSkKICogVGhlIG5nIG1vZHVsZSBpcyBsb2FkZWQgYnkgZGVmYXVsdCB3aGVuIGFuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbiBpcyBzdGFydGVkLiBUaGUgbW9kdWxlIGl0c2VsZgogKiBjb250YWlucyB0aGUgZXNzZW50aWFsIGNvbXBvbmVudHMgZm9yIGFuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbiB0byBmdW5jdGlvbi4gVGhlIHRhYmxlIGJlbG93CiAqIGxpc3RzIGEgaGlnaCBsZXZlbCBicmVha2Rvd24gb2YgZWFjaCBvZiB0aGUgc2VydmljZXMvZmFjdG9yaWVzLCBmaWx0ZXJzLCBkaXJlY3RpdmVzIGFuZCB0ZXN0aW5nCiAqIGNvbXBvbmVudHMgYXZhaWxhYmxlIHdpdGhpbiB0aGlzIGNvcmUgbW9kdWxlLgogKgogKiA8ZGl2IGRvYy1tb2R1bGUtY29tcG9uZW50cz0ibmciPjwvZGl2PgogKi8KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5sb3dlcmNhc2UKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gbG93ZXJjYXNlLgogKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gbG93ZXJjYXNlLgogKiBAcmV0dXJucyB7c3RyaW5nfSBMb3dlcmNhc2VkIHN0cmluZy4KICovCnZhciBsb3dlcmNhc2UgPSBmdW5jdGlvbihzdHJpbmcpe3JldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7fTsKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci51cHBlcmNhc2UKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gdXBwZXJjYXNlLgogKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gdXBwZXJjYXNlLgogKiBAcmV0dXJucyB7c3RyaW5nfSBVcHBlcmNhc2VkIHN0cmluZy4KICovCnZhciB1cHBlcmNhc2UgPSBmdW5jdGlvbihzdHJpbmcpe3JldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvVXBwZXJDYXNlKCkgOiBzdHJpbmc7fTsKCgp2YXIgbWFudWFsTG93ZXJjYXNlID0gZnVuY3Rpb24ocykgewogIC8qIGpzaGludCBiaXR3aXNlOiBmYWxzZSAqLwogIHJldHVybiBpc1N0cmluZyhzKQogICAgICA/IHMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24oY2gpIHtyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShjaC5jaGFyQ29kZUF0KDApIHwgMzIpO30pCiAgICAgIDogczsKfTsKdmFyIG1hbnVhbFVwcGVyY2FzZSA9IGZ1bmN0aW9uKHMpIHsKICAvKiBqc2hpbnQgYml0d2lzZTogZmFsc2UgKi8KICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1thLXpdL2csIGZ1bmN0aW9uKGNoKSB7cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSAmIH4zMik7fSkKICAgICAgOiBzOwp9OwoKCi8vIFN0cmluZyN0b0xvd2VyQ2FzZSBhbmQgU3RyaW5nI3RvVXBwZXJDYXNlIGRvbid0IHByb2R1Y2UgY29ycmVjdCByZXN1bHRzIGluIGJyb3dzZXJzIHdpdGggVHVya2lzaAovLyBsb2NhbGUsIGZvciB0aGlzIHJlYXNvbiB3ZSBuZWVkIHRvIGRldGVjdCB0aGlzIGNhc2UgYW5kIHJlZGVmaW5lIGxvd2VyY2FzZS91cHBlcmNhc2UgbWV0aG9kcwovLyB3aXRoIGNvcnJlY3QgYnV0IHNsb3dlciBhbHRlcm5hdGl2ZXMuCmlmICgnaScgIT09ICdJJy50b0xvd2VyQ2FzZSgpKSB7CiAgbG93ZXJjYXNlID0gbWFudWFsTG93ZXJjYXNlOwogIHVwcGVyY2FzZSA9IG1hbnVhbFVwcGVyY2FzZTsKfQoKCnZhciAvKiogaG9sZHMgbWFqb3IgdmVyc2lvbiBudW1iZXIgZm9yIElFIG9yIE5hTiBmb3IgcmVhbCBicm93c2VycyAqLwogICAgbXNpZSwKICAgIGpxTGl0ZSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcgc2luY2UgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBhZnRlciB1cy4KICAgIGpRdWVyeSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcKICAgIHNsaWNlICAgICAgICAgICAgID0gW10uc2xpY2UsCiAgICBwdXNoICAgICAgICAgICAgICA9IFtdLnB1c2gsCiAgICB0b1N0cmluZyAgICAgICAgICA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCiAgICBuZ01pbkVyciAgICAgICAgICA9IG1pbkVycignbmcnKSwKCiAgICAvKiogQG5hbWUgYW5ndWxhciAqLwogICAgYW5ndWxhciAgICAgICAgICAgPSB3aW5kb3cuYW5ndWxhciB8fCAod2luZG93LmFuZ3VsYXIgPSB7fSksCiAgICBhbmd1bGFyTW9kdWxlLAogICAgbm9kZU5hbWVfLAogICAgdWlkICAgICAgICAgICAgICAgPSBbJzAnLCAnMCcsICcwJ107CgovKioKICogSUUgMTEgY2hhbmdlZCB0aGUgZm9ybWF0IG9mIHRoZSBVc2VyQWdlbnQgc3RyaW5nLgogKiBTZWUgaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTM3NTAzLmFzcHgKICovCm1zaWUgPSBpbnQoKC9tc2llIChcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdKTsKaWYgKGlzTmFOKG1zaWUpKSB7CiAgbXNpZSA9IGludCgoL3RyaWRlbnRcLy4qOyBydjooXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7Cn0KCgovKioKICogQHByaXZhdGUKICogQHBhcmFtIHsqfSBvYmoKICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIGBvYmpgIGlzIGFuIGFycmF5IG9yIGFycmF5LWxpa2Ugb2JqZWN0IChOb2RlTGlzdCwgQXJndW1lbnRzLAogKiAgICAgICAgICAgICAgICAgICBTdHJpbmcgLi4uKQogKi8KZnVuY3Rpb24gaXNBcnJheUxpa2Uob2JqKSB7CiAgaWYgKG9iaiA9PSBudWxsIHx8IGlzV2luZG93KG9iaikpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwoKICBpZiAob2JqLm5vZGVUeXBlID09PSAxICYmIGxlbmd0aCkgewogICAgcmV0dXJuIHRydWU7CiAgfQoKICByZXR1cm4gaXNTdHJpbmcob2JqKSB8fCBpc0FycmF5KG9iaikgfHwgbGVuZ3RoID09PSAwIHx8CiAgICAgICAgIHR5cGVvZiBsZW5ndGggPT09ICdudW1iZXInICYmIGxlbmd0aCA+IDAgJiYgKGxlbmd0aCAtIDEpIGluIG9iajsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmZvckVhY2gKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogSW52b2tlcyB0aGUgYGl0ZXJhdG9yYCBmdW5jdGlvbiBvbmNlIGZvciBlYWNoIGl0ZW0gaW4gYG9iamAgY29sbGVjdGlvbiwgd2hpY2ggY2FuIGJlIGVpdGhlciBhbgogKiBvYmplY3Qgb3IgYW4gYXJyYXkuIFRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIGlzIGludm9rZWQgd2l0aCBgaXRlcmF0b3IodmFsdWUsIGtleSlgLCB3aGVyZSBgdmFsdWVgCiAqIGlzIHRoZSB2YWx1ZSBvZiBhbiBvYmplY3QgcHJvcGVydHkgb3IgYW4gYXJyYXkgZWxlbWVudCBhbmQgYGtleWAgaXMgdGhlIG9iamVjdCBwcm9wZXJ0eSBrZXkgb3IKICogYXJyYXkgZWxlbWVudCBpbmRleC4gU3BlY2lmeWluZyBhIGBjb250ZXh0YCBmb3IgdGhlIGZ1bmN0aW9uIGlzIG9wdGlvbmFsLgogKgogKiBJdCBpcyB3b3J0aCBub3RpbmcgdGhhdCBgLmZvckVhY2hgIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciBpbmhlcml0ZWQgcHJvcGVydGllcyBiZWNhdXNlIGl0IGZpbHRlcnMKICogdXNpbmcgdGhlIGBoYXNPd25Qcm9wZXJ0eWAgbWV0aG9kLgogKgogICBgYGBqcwogICAgIHZhciB2YWx1ZXMgPSB7bmFtZTogJ21pc2tvJywgZ2VuZGVyOiAnbWFsZSd9OwogICAgIHZhciBsb2cgPSBbXTsKICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICB0aGlzLnB1c2goa2V5ICsgJzogJyArIHZhbHVlKTsKICAgICB9LCBsb2cpOwogICAgIGV4cGVjdChsb2cpLnRvRXF1YWwoWyduYW1lOiBtaXNrbycsICdnZW5kZXI6IG1hbGUnXSk7CiAgIGBgYAogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheX0gb2JqIE9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdG9yIEl0ZXJhdG9yIGZ1bmN0aW9uLgogKiBAcGFyYW0ge09iamVjdD19IGNvbnRleHQgT2JqZWN0IHRvIGJlY29tZSBjb250ZXh0IChgdGhpc2ApIGZvciB0aGUgaXRlcmF0b3IgZnVuY3Rpb24uCiAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl9IFJlZmVyZW5jZSB0byBgb2JqYC4KICovCmZ1bmN0aW9uIGZvckVhY2gob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogIHZhciBrZXk7CiAgaWYgKG9iaikgewogICAgaWYgKGlzRnVuY3Rpb24ob2JqKSkgewogICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAvLyBOZWVkIHRvIGNoZWNrIGlmIGhhc093blByb3BlcnR5IGV4aXN0cywKICAgICAgICAvLyBhcyBvbiBJRTggdGhlIHJlc3VsdCBvZiBxdWVyeVNlbGVjdG9yQWxsIGlzIGFuIG9iamVjdCB3aXRob3V0IGEgaGFzT3duUHJvcGVydHkgZnVuY3Rpb24KICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAnbGVuZ3RoJyAmJiBrZXkgIT0gJ25hbWUnICYmICghb2JqLmhhc093blByb3BlcnR5IHx8IG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSkgewogICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob2JqLmZvckVhY2ggJiYgb2JqLmZvckVhY2ggIT09IGZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChpc0FycmF5TGlrZShvYmopKSB7CiAgICAgIGZvciAoa2V5ID0gMDsga2V5IDwgb2JqLmxlbmd0aDsga2V5KyspCiAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG9iajsKfQoKZnVuY3Rpb24gc29ydGVkS2V5cyhvYmopIHsKICB2YXIga2V5cyA9IFtdOwogIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICBrZXlzLnB1c2goa2V5KTsKICAgIH0KICB9CiAgcmV0dXJuIGtleXMuc29ydCgpOwp9CgpmdW5jdGlvbiBmb3JFYWNoU29ydGVkKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIga2V5cyA9IHNvcnRlZEtleXMob2JqKTsKICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXlzW2ldXSwga2V5c1tpXSk7CiAgfQogIHJldHVybiBrZXlzOwp9CgoKLyoqCiAqIHdoZW4gdXNpbmcgZm9yRWFjaCB0aGUgcGFyYW1zIGFyZSB2YWx1ZSwga2V5LCBidXQgaXQgaXMgb2Z0ZW4gdXNlZnVsIHRvIGhhdmUga2V5LCB2YWx1ZS4KICogQHBhcmFtIHtmdW5jdGlvbihzdHJpbmcsICopfSBpdGVyYXRvckZuCiAqIEByZXR1cm5zIHtmdW5jdGlvbigqLCBzdHJpbmcpfQogKi8KZnVuY3Rpb24gcmV2ZXJzZVBhcmFtcyhpdGVyYXRvckZuKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsgaXRlcmF0b3JGbihrZXksIHZhbHVlKTsgfTsKfQoKLyoqCiAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAqIGNoYXJhY3RlcnMgc3VjaCBhcyAnMDEyQUJDJy4gVGhlIHJlYXNvbiB3aHkgd2UgYXJlIG5vdCB1c2luZyBzaW1wbHkgYSBudW1iZXIgY291bnRlciBpcyB0aGF0CiAqIHRoZSBudW1iZXIgc3RyaW5nIGdldHMgbG9uZ2VyIG92ZXIgdGltZSwgYW5kIGl0IGNhbiBhbHNvIG92ZXJmbG93LCB3aGVyZSBhcyB0aGUgbmV4dElkCiAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogKgogKiBAcmV0dXJucyB7c3RyaW5nfSBhbiB1bmlxdWUgYWxwaGEtbnVtZXJpYyBzdHJpbmcKICovCmZ1bmN0aW9uIG5leHRVaWQoKSB7CiAgdmFyIGluZGV4ID0gdWlkLmxlbmd0aDsKICB2YXIgZGlnaXQ7CgogIHdoaWxlKGluZGV4KSB7CiAgICBpbmRleC0tOwogICAgZGlnaXQgPSB1aWRbaW5kZXhdLmNoYXJDb2RlQXQoMCk7CiAgICBpZiAoZGlnaXQgPT0gNTcgLyonOScqLykgewogICAgICB1aWRbaW5kZXhdID0gJ0EnOwogICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgfQogICAgaWYgKGRpZ2l0ID09IDkwICAvKidaJyovKSB7CiAgICAgIHVpZFtpbmRleF0gPSAnMCc7CiAgICB9IGVsc2UgewogICAgICB1aWRbaW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShkaWdpdCArIDEpOwogICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgfQogIH0KICB1aWQudW5zaGlmdCgnMCcpOwogIHJldHVybiB1aWQuam9pbignJyk7Cn0KCgovKioKICogU2V0IG9yIGNsZWFyIHRoZSBoYXNoa2V5IGZvciBhbiBvYmplY3QuCiAqIEBwYXJhbSBvYmogb2JqZWN0CiAqIEBwYXJhbSBoIHRoZSBoYXNoa2V5ICghdHJ1dGh5IHRvIGRlbGV0ZSB0aGUgaGFzaGtleSkKICovCmZ1bmN0aW9uIHNldEhhc2hLZXkob2JqLCBoKSB7CiAgaWYgKGgpIHsKICAgIG9iai4kJGhhc2hLZXkgPSBoOwogIH0KICBlbHNlIHsKICAgIGRlbGV0ZSBvYmouJCRoYXNoS2V5OwogIH0KfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmV4dGVuZAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBhbGwgb2YgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUgYHNyY2Agb2JqZWN0KHMpCiAqIHRvIGBkc3RgLiBZb3UgY2FuIHNwZWNpZnkgbXVsdGlwbGUgYHNyY2Agb2JqZWN0cy4KICoKICogQHBhcmFtIHtPYmplY3R9IGRzdCBEZXN0aW5hdGlvbiBvYmplY3QuCiAqIEBwYXJhbSB7Li4uT2JqZWN0fSBzcmMgU291cmNlIG9iamVjdChzKS4KICogQHJldHVybnMge09iamVjdH0gUmVmZXJlbmNlIHRvIGBkc3RgLgogKi8KZnVuY3Rpb24gZXh0ZW5kKGRzdCkgewogIHZhciBoID0gZHN0LiQkaGFzaEtleTsKICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqICE9PSBkc3QpIHsKICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgc2V0SGFzaEtleShkc3QsaCk7CiAgcmV0dXJuIGRzdDsKfQoKZnVuY3Rpb24gaW50KHN0cikgewogIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKfQoKCmZ1bmN0aW9uIGluaGVyaXQocGFyZW50LCBleHRyYSkgewogIHJldHVybiBleHRlbmQobmV3IChleHRlbmQoZnVuY3Rpb24oKSB7fSwge3Byb3RvdHlwZTpwYXJlbnR9KSkoKSwgZXh0cmEpOwp9CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIubm9vcAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgbm8gb3BlcmF0aW9ucy4gVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogKiBmdW5jdGlvbmFsIHN0eWxlLgogICBgYGBqcwogICAgIGZ1bmN0aW9uIGZvbyhjYWxsYmFjaykgewogICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgKGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcCkocmVzdWx0KTsKICAgICB9CiAgIGBgYAogKi8KZnVuY3Rpb24gbm9vcCgpIHt9Cm5vb3AuJGluamVjdCA9IFtdOwoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pZGVudGl0eQogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBpdHMgZmlyc3QgYXJndW1lbnQuIFRoaXMgZnVuY3Rpb24gaXMgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogKiBmdW5jdGlvbmFsIHN0eWxlLgogKgogICBgYGBqcwogICAgIGZ1bmN0aW9uIHRyYW5zZm9ybWVyKHRyYW5zZm9ybWF0aW9uRm4sIHZhbHVlKSB7CiAgICAgICByZXR1cm4gKHRyYW5zZm9ybWF0aW9uRm4gfHwgYW5ndWxhci5pZGVudGl0eSkodmFsdWUpOwogICAgIH07CiAgIGBgYAogKi8KZnVuY3Rpb24gaWRlbnRpdHkoJCkge3JldHVybiAkO30KaWRlbnRpdHkuJGluamVjdCA9IFtdOwoKCmZ1bmN0aW9uIHZhbHVlRm4odmFsdWUpIHtyZXR1cm4gZnVuY3Rpb24oKSB7cmV0dXJuIHZhbHVlO307fQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzVW5kZWZpbmVkCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgdW5kZWZpbmVkLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyB1bmRlZmluZWQuCiAqLwpmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCc7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0RlZmluZWQKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBkZWZpbmVkLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBkZWZpbmVkLgogKi8KZnVuY3Rpb24gaXNEZWZpbmVkKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJzt9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYE9iamVjdGAuIFVubGlrZSBgdHlwZW9mYCBpbiBKYXZhU2NyaXB0LCBgbnVsbGBzIGFyZSBub3QKICogY29uc2lkZXJlZCB0byBiZSBvYmplY3RzLiBOb3RlIHRoYXQgSmF2YVNjcmlwdCBhcnJheXMgYXJlIG9iamVjdHMuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBPYmplY3RgIGJ1dCBub3QgYG51bGxgLgogKi8KZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpe3JldHVybiB2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCc7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc1N0cmluZwogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYFN0cmluZ2AuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFN0cmluZ2AuCiAqLwpmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZyc7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc051bWJlcgogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYE51bWJlcmAuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYE51bWJlcmAuCiAqLwpmdW5jdGlvbiBpc051bWJlcih2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcic7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0RhdGUKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgZGF0ZS4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRGF0ZWAuCiAqLwpmdW5jdGlvbiBpc0RhdGUodmFsdWUpIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IERhdGVdJzsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0FycmF5CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYEFycmF5YC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYEFycmF5YC4KICovCmZ1bmN0aW9uIGlzQXJyYXkodmFsdWUpIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IEFycmF5XSc7Cn0KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNGdW5jdGlvbgogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYEZ1bmN0aW9uYC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRnVuY3Rpb25gLgogKi8KZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJzt9CgoKLyoqCiAqIERldGVybWluZXMgaWYgYSB2YWx1ZSBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiBvYmplY3QuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFJlZ0V4cGAuCiAqLwpmdW5jdGlvbiBpc1JlZ0V4cCh2YWx1ZSkgewogIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgUmVnRXhwXSc7Cn0KCgovKioKICogQ2hlY2tzIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iamVjdC4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHsqfSBvYmogT2JqZWN0IHRvIGNoZWNrCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iai4KICovCmZ1bmN0aW9uIGlzV2luZG93KG9iaikgewogIHJldHVybiBvYmogJiYgb2JqLmRvY3VtZW50ICYmIG9iai5sb2NhdGlvbiAmJiBvYmouYWxlcnQgJiYgb2JqLnNldEludGVydmFsOwp9CgoKZnVuY3Rpb24gaXNTY29wZShvYmopIHsKICByZXR1cm4gb2JqICYmIG9iai4kZXZhbEFzeW5jICYmIG9iai4kd2F0Y2g7Cn0KCgpmdW5jdGlvbiBpc0ZpbGUob2JqKSB7CiAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgRmlsZV0nOwp9CgoKZnVuY3Rpb24gaXNCbG9iKG9iaikgewogIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEJsb2JdJzsKfQoKCmZ1bmN0aW9uIGlzQm9vbGVhbih2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJzsKfQoKCnZhciB0cmltID0gKGZ1bmN0aW9uKCkgewogIC8vIG5hdGl2ZSB0cmltIGlzIHdheSBmYXN0ZXI6IGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXItdHJpbS10ZXN0CiAgLy8gYnV0IElFIGRvZXNuJ3QgaGF2ZSBpdC4uLiA6LSgKICAvLyBUT0RPOiB3ZSBzaG91bGQgbW92ZSB0aGlzIGludG8gSUUvRVM1IHBvbHlmaWxsCiAgaWYgKCFTdHJpbmcucHJvdG90eXBlLnRyaW0pIHsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUucmVwbGFjZSgvXlxzXHMqLywgJycpLnJlcGxhY2UoL1xzXHMqJC8sICcnKSA6IHZhbHVlOwogICAgfTsKICB9CiAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUudHJpbSgpIDogdmFsdWU7CiAgfTsKfSkoKTsKCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNFbGVtZW50CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogKi8KZnVuY3Rpb24gaXNFbGVtZW50KG5vZGUpIHsKICByZXR1cm4gISEobm9kZSAmJgogICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICB8fCAobm9kZS5wcm9wICYmIG5vZGUuYXR0ciAmJiBub2RlLmZpbmQpKSk7ICAvLyB3ZSBoYXZlIGFuIG9uIGFuZCBmaW5kIG1ldGhvZCBwYXJ0IG9mIGpRdWVyeSBBUEkKfQoKLyoqCiAqIEBwYXJhbSBzdHIgJ2tleTEsa2V5MiwuLi4nCiAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHtrZXkxOnRydWUsIGtleTI6dHJ1ZSwgLi4ufQogKi8KZnVuY3Rpb24gbWFrZU1hcChzdHIpIHsKICB2YXIgb2JqID0ge30sIGl0ZW1zID0gc3RyLnNwbGl0KCIsIiksIGk7CiAgZm9yICggaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKyApCiAgICBvYmpbIGl0ZW1zW2ldIF0gPSB0cnVlOwogIHJldHVybiBvYmo7Cn0KCgppZiAobXNpZSA8IDkpIHsKICBub2RlTmFtZV8gPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICBlbGVtZW50ID0gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQgOiBlbGVtZW50WzBdOwogICAgcmV0dXJuIChlbGVtZW50LnNjb3BlTmFtZSAmJiBlbGVtZW50LnNjb3BlTmFtZSAhPSAnSFRNTCcpCiAgICAgID8gdXBwZXJjYXNlKGVsZW1lbnQuc2NvcGVOYW1lICsgJzonICsgZWxlbWVudC5ub2RlTmFtZSkgOiBlbGVtZW50Lm5vZGVOYW1lOwogIH07Cn0gZWxzZSB7CiAgbm9kZU5hbWVfID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQubm9kZU5hbWUgPyBlbGVtZW50Lm5vZGVOYW1lIDogZWxlbWVudFswXS5ub2RlTmFtZTsKICB9Owp9CgoKZnVuY3Rpb24gbWFwKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIgcmVzdWx0cyA9IFtdOwogIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogIH0pOwogIHJldHVybiByZXN1bHRzOwp9CgoKLyoqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXksIHRoZSBudW1iZXIgb2YgcHJvcGVydGllcyBhbiBvYmplY3QgaGFzLCBvcgogKiB0aGUgbGVuZ3RoIG9mIGEgc3RyaW5nLgogKgogKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAqIHtAbGluayBhbmd1bGFyLk9iamVjdH0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fHN0cmluZ30gb2JqIE9iamVjdCwgYXJyYXksIG9yIHN0cmluZyB0byBpbnNwZWN0LgogKiBAcGFyYW0ge2Jvb2xlYW59IFtvd25Qcm9wc09ubHk9ZmFsc2VdIENvdW50IG9ubHkgIm93biIgcHJvcGVydGllcyBpbiBhbiBvYmplY3QKICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG5vciBhbiBhcnJheS4KICovCmZ1bmN0aW9uIHNpemUob2JqLCBvd25Qcm9wc09ubHkpIHsKICB2YXIgY291bnQgPSAwLCBrZXk7CgogIGlmIChpc0FycmF5KG9iaikgfHwgaXNTdHJpbmcob2JqKSkgewogICAgcmV0dXJuIG9iai5sZW5ndGg7CiAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7CiAgICBmb3IgKGtleSBpbiBvYmopCiAgICAgIGlmICghb3duUHJvcHNPbmx5IHx8IG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKQogICAgICAgIGNvdW50Kys7CiAgfQoKICByZXR1cm4gY291bnQ7Cn0KCgpmdW5jdGlvbiBpbmNsdWRlcyhhcnJheSwgb2JqKSB7CiAgcmV0dXJuIGluZGV4T2YoYXJyYXksIG9iaikgIT0gLTE7Cn0KCmZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIG9iaikgewogIGlmIChhcnJheS5pbmRleE9mKSByZXR1cm4gYXJyYXkuaW5kZXhPZihvYmopOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBpZiAob2JqID09PSBhcnJheVtpXSkgcmV0dXJuIGk7CiAgfQogIHJldHVybiAtMTsKfQoKZnVuY3Rpb24gYXJyYXlSZW1vdmUoYXJyYXksIHZhbHVlKSB7CiAgdmFyIGluZGV4ID0gaW5kZXhPZihhcnJheSwgdmFsdWUpOwogIGlmIChpbmRleCA+PTApCiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpOwogIHJldHVybiB2YWx1ZTsKfQoKZnVuY3Rpb24gaXNMZWFmTm9kZSAobm9kZSkgewogIGlmIChub2RlKSB7CiAgICBzd2l0Y2ggKG5vZGUubm9kZU5hbWUpIHsKICAgIGNhc2UgIk9QVElPTiI6CiAgICBjYXNlICJQUkUiOgogICAgY2FzZSAiVElUTEUiOgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuY29weQogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGEgZGVlcCBjb3B5IG9mIGBzb3VyY2VgLCB3aGljaCBzaG91bGQgYmUgYW4gb2JqZWN0IG9yIGFuIGFycmF5LgogKgogKiAqIElmIG5vIGRlc3RpbmF0aW9uIGlzIHN1cHBsaWVkLCBhIGNvcHkgb2YgdGhlIG9iamVjdCBvciBhcnJheSBpcyBjcmVhdGVkLgogKiAqIElmIGEgZGVzdGluYXRpb24gaXMgcHJvdmlkZWQsIGFsbCBvZiBpdHMgZWxlbWVudHMgKGZvciBhcnJheSkgb3IgcHJvcGVydGllcyAoZm9yIG9iamVjdHMpCiAqICAgYXJlIGRlbGV0ZWQgYW5kIHRoZW4gYWxsIGVsZW1lbnRzL3Byb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIGFyZSBjb3BpZWQgdG8gaXQuCiAqICogSWYgYHNvdXJjZWAgaXMgbm90IGFuIG9iamVjdCBvciBhcnJheSAoaW5jLiBgbnVsbGAgYW5kIGB1bmRlZmluZWRgKSwgYHNvdXJjZWAgaXMgcmV0dXJuZWQuCiAqICogSWYgYHNvdXJjZWAgaXMgaWRlbnRpY2FsIHRvICdkZXN0aW5hdGlvbicgYW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duLgogKgogKiBAcGFyYW0geyp9IHNvdXJjZSBUaGUgc291cmNlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIG1ha2UgYSBjb3B5LgogKiAgICAgICAgICAgICAgICAgICBDYW4gYmUgYW55IHR5cGUsIGluY2x1ZGluZyBwcmltaXRpdmVzLCBgbnVsbGAsIGFuZCBgdW5kZWZpbmVkYC4KICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIERlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAqICAgICBwcm92aWRlZCwgbXVzdCBiZSBvZiB0aGUgc2FtZSB0eXBlIGFzIGBzb3VyY2VgLgogKiBAcmV0dXJucyB7Kn0gVGhlIGNvcHkgb3IgdXBkYXRlZCBgZGVzdGluYXRpb25gLCBpZiBgZGVzdGluYXRpb25gIHdhcyBzcGVjaWZpZWQuCiAqCiAqIEBleGFtcGxlCiA8ZXhhbXBsZT4KIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogPGRpdiBuZy1jb250cm9sbGVyPSJDb250cm9sbGVyIj4KIDxmb3JtIG5vdmFsaWRhdGUgY2xhc3M9InNpbXBsZS1mb3JtIj4KIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXNlci5uYW1lIiAvPjxiciAvPgogRS1tYWlsOiA8aW5wdXQgdHlwZT0iZW1haWwiIG5nLW1vZGVsPSJ1c2VyLmVtYWlsIiAvPjxiciAvPgogR2VuZGVyOiA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJ1c2VyLmdlbmRlciIgdmFsdWU9Im1hbGUiIC8+bWFsZQogPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0idXNlci5nZW5kZXIiIHZhbHVlPSJmZW1hbGUiIC8+ZmVtYWxlPGJyIC8+CiA8YnV0dG9uIG5nLWNsaWNrPSJyZXNldCgpIj5SRVNFVDwvYnV0dG9uPgogPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlKHVzZXIpIj5TQVZFPC9idXR0b24+CiA8L2Zvcm0+CiA8cHJlPmZvcm0gPSB7e3VzZXIgfCBqc29ufX08L3ByZT4KIDxwcmU+bWFzdGVyID0ge3ttYXN0ZXIgfCBqc29ufX08L3ByZT4KIDwvZGl2PgoKIDxzY3JpcHQ+CiBmdW5jdGlvbiBDb250cm9sbGVyKCRzY29wZSkgewogICAgJHNjb3BlLm1hc3Rlcj0ge307CgogICAgJHNjb3BlLnVwZGF0ZSA9IGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgLy8gRXhhbXBsZSB3aXRoIDEgYXJndW1lbnQKICAgICAgJHNjb3BlLm1hc3Rlcj0gYW5ndWxhci5jb3B5KHVzZXIpOwogICAgfTsKCiAgICAkc2NvcGUucmVzZXQgPSBmdW5jdGlvbigpIHsKICAgICAgLy8gRXhhbXBsZSB3aXRoIDIgYXJndW1lbnRzCiAgICAgIGFuZ3VsYXIuY29weSgkc2NvcGUubWFzdGVyLCAkc2NvcGUudXNlcik7CiAgICB9OwoKICAgICRzY29wZS5yZXNldCgpOwogIH0KIDwvc2NyaXB0PgogPC9maWxlPgogPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gY29weShzb3VyY2UsIGRlc3RpbmF0aW9uLCBzdGFja1NvdXJjZSwgc3RhY2tEZXN0KSB7CiAgaWYgKGlzV2luZG93KHNvdXJjZSkgfHwgaXNTY29wZShzb3VyY2UpKSB7CiAgICB0aHJvdyBuZ01pbkVycignY3B3cycsCiAgICAgICJDYW4ndCBjb3B5ISBNYWtpbmcgY29waWVzIG9mIFdpbmRvdyBvciBTY29wZSBpbnN0YW5jZXMgaXMgbm90IHN1cHBvcnRlZC4iKTsKICB9CgogIGlmICghZGVzdGluYXRpb24pIHsKICAgIGRlc3RpbmF0aW9uID0gc291cmNlOwogICAgaWYgKHNvdXJjZSkgewogICAgICBpZiAoaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwgW10sIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpOwogICAgICB9IGVsc2UgaWYgKGlzRGF0ZShzb3VyY2UpKSB7CiAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgRGF0ZShzb3VyY2UuZ2V0VGltZSgpKTsKICAgICAgfSBlbHNlIGlmIChpc1JlZ0V4cChzb3VyY2UpKSB7CiAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgUmVnRXhwKHNvdXJjZS5zb3VyY2UpOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCB7fSwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaWYgKHNvdXJjZSA9PT0gZGVzdGluYXRpb24pIHRocm93IG5nTWluRXJyKCdjcGknLAogICAgICAiQ2FuJ3QgY29weSEgU291cmNlIGFuZCBkZXN0aW5hdGlvbiBhcmUgaWRlbnRpY2FsLiIpOwoKICAgIHN0YWNrU291cmNlID0gc3RhY2tTb3VyY2UgfHwgW107CiAgICBzdGFja0Rlc3QgPSBzdGFja0Rlc3QgfHwgW107CgogICAgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgdmFyIGluZGV4ID0gaW5kZXhPZihzdGFja1NvdXJjZSwgc291cmNlKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIHN0YWNrRGVzdFtpbmRleF07CgogICAgICBzdGFja1NvdXJjZS5wdXNoKHNvdXJjZSk7CiAgICAgIHN0YWNrRGVzdC5wdXNoKGRlc3RpbmF0aW9uKTsKICAgIH0KCiAgICB2YXIgcmVzdWx0OwogICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICBkZXN0aW5hdGlvbi5sZW5ndGggPSAwOwogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICByZXN1bHQgPSBjb3B5KHNvdXJjZVtpXSwgbnVsbCwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgICAgaWYgKGlzT2JqZWN0KHNvdXJjZVtpXSkpIHsKICAgICAgICAgIHN0YWNrU291cmNlLnB1c2goc291cmNlW2ldKTsKICAgICAgICAgIHN0YWNrRGVzdC5wdXNoKHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGRlc3RpbmF0aW9uLnB1c2gocmVzdWx0KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGggPSBkZXN0aW5hdGlvbi4kJGhhc2hLZXk7CiAgICAgIGZvckVhY2goZGVzdGluYXRpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBkZWxldGUgZGVzdGluYXRpb25ba2V5XTsKICAgICAgfSk7CiAgICAgIGZvciAoIHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgcmVzdWx0ID0gY29weShzb3VyY2Vba2V5XSwgbnVsbCwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgICAgaWYgKGlzT2JqZWN0KHNvdXJjZVtrZXldKSkgewogICAgICAgICAgc3RhY2tTb3VyY2UucHVzaChzb3VyY2Vba2V5XSk7CiAgICAgICAgICBzdGFja0Rlc3QucHVzaChyZXN1bHQpOwogICAgICAgIH0KICAgICAgICBkZXN0aW5hdGlvbltrZXldID0gcmVzdWx0OwogICAgICB9CiAgICAgIHNldEhhc2hLZXkoZGVzdGluYXRpb24saCk7CiAgICB9CgogIH0KICByZXR1cm4gZGVzdGluYXRpb247Cn0KCi8qKgogKiBDcmVhdGVzIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdCwgYW4gYXJyYXkgb3IgYSBwcmltaXRpdmUKICovCmZ1bmN0aW9uIHNoYWxsb3dDb3B5KHNyYywgZHN0KSB7CiAgaWYgKGlzQXJyYXkoc3JjKSkgewogICAgZHN0ID0gZHN0IHx8IFtdOwoKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNyYy5sZW5ndGg7IGkrKykgewogICAgICBkc3RbaV0gPSBzcmNbaV07CiAgICB9CiAgfSBlbHNlIGlmIChpc09iamVjdChzcmMpKSB7CiAgICBkc3QgPSBkc3QgfHwge307CgogICAgZm9yICh2YXIga2V5IGluIHNyYykgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzcmMsIGtleSkgJiYgIShrZXkuY2hhckF0KDApID09PSAnJCcgJiYga2V5LmNoYXJBdCgxKSA9PT0gJyQnKSkgewogICAgICAgIGRzdFtrZXldID0gc3JjW2tleV07CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBkc3QgfHwgc3JjOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmVxdWFscwogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIHR3byBvYmplY3RzIG9yIHR3byB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQuIFN1cHBvcnRzIHZhbHVlIHR5cGVzLCByZWd1bGFyCiAqIGV4cHJlc3Npb25zLCBhcnJheXMgYW5kIG9iamVjdHMuCiAqCiAqIFR3byBvYmplY3RzIG9yIHZhbHVlcyBhcmUgY29uc2lkZXJlZCBlcXVpdmFsZW50IGlmIGF0IGxlYXN0IG9uZSBvZiB0aGUgZm9sbG93aW5nIGlzIHRydWU6CiAqCiAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBhcmUgb2YgdGhlIHNhbWUgdHlwZSBhbmQgYWxsIG9mIHRoZWlyIHByb3BlcnRpZXMgYXJlIGVxdWFsIGJ5CiAqICAgY29tcGFyaW5nIHRoZW0gd2l0aCBgYW5ndWxhci5lcXVhbHNgLgogKiAqIEJvdGggdmFsdWVzIGFyZSBOYU4uIChJbiBKYXZhU2NyaXB0LCBOYU4gPT0gTmFOID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIE5hTiBhcyBlcXVhbCkKICogKiBCb3RoIHZhbHVlcyByZXByZXNlbnQgdGhlIHNhbWUgcmVndWxhciBleHByZXNzaW9uIChJbiBKYXZhU2NyaXB0LAogKiAgIC9hYmMvID09IC9hYmMvID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXMgZXF1YWwgd2hlbiB0aGVpciB0ZXh0dWFsCiAqICAgcmVwcmVzZW50YXRpb24gbWF0Y2hlcykuCiAqCiAqIER1cmluZyBhIHByb3BlcnR5IGNvbXBhcmlzb24sIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZCBwcm9wZXJ0aWVzIHdpdGggbmFtZXMKICogdGhhdCBiZWdpbiB3aXRoIGAkYCBhcmUgaWdub3JlZC4KICoKICogU2NvcGUgYW5kIERPTVdpbmRvdyBvYmplY3RzIGFyZSBiZWluZyBjb21wYXJlZCBvbmx5IGJ5IGlkZW50aWZ5IChgPT09YCkuCiAqCiAqIEBwYXJhbSB7Kn0gbzEgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAqIEBwYXJhbSB7Kn0gbzIgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGFyZ3VtZW50cyBhcmUgZXF1YWwuCiAqLwpmdW5jdGlvbiBlcXVhbHMobzEsIG8yKSB7CiAgaWYgKG8xID09PSBvMikgcmV0dXJuIHRydWU7CiAgaWYgKG8xID09PSBudWxsIHx8IG8yID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgaWYgKG8xICE9PSBvMSAmJiBvMiAhPT0gbzIpIHJldHVybiB0cnVlOyAvLyBOYU4gPT09IE5hTgogIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgaWYgKHQxID09IHQyKSB7CiAgICBpZiAodDEgPT0gJ29iamVjdCcpIHsKICAgICAgaWYgKGlzQXJyYXkobzEpKSB7CiAgICAgICAgaWYgKCFpc0FycmF5KG8yKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmICgobGVuZ3RoID0gbzEubGVuZ3RoKSA9PSBvMi5sZW5ndGgpIHsKICAgICAgICAgIGZvcihrZXk9MDsga2V5PGxlbmd0aDsga2V5KyspIHsKICAgICAgICAgICAgaWYgKCFlcXVhbHMobzFba2V5XSwgbzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc0RhdGUobzEpKSB7CiAgICAgICAgcmV0dXJuIGlzRGF0ZShvMikgJiYgbzEuZ2V0VGltZSgpID09IG8yLmdldFRpbWUoKTsKICAgICAgfSBlbHNlIGlmIChpc1JlZ0V4cChvMSkgJiYgaXNSZWdFeHAobzIpKSB7CiAgICAgICAgcmV0dXJuIG8xLnRvU3RyaW5nKCkgPT0gbzIudG9TdHJpbmcoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNTY29wZShvMSkgfHwgaXNTY29wZShvMikgfHwgaXNXaW5kb3cobzEpIHx8IGlzV2luZG93KG8yKSB8fCBpc0FycmF5KG8yKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGtleVNldCA9IHt9OwogICAgICAgIGZvcihrZXkgaW4gbzEpIHsKICAgICAgICAgIGlmIChrZXkuY2hhckF0KDApID09PSAnJCcgfHwgaXNGdW5jdGlvbihvMVtrZXldKSkgY29udGludWU7CiAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAga2V5U2V0W2tleV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICBmb3Ioa2V5IGluIG8yKSB7CiAgICAgICAgICBpZiAoIWtleVNldC5oYXNPd25Qcm9wZXJ0eShrZXkpICYmCiAgICAgICAgICAgICAga2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmCiAgICAgICAgICAgICAgbzJba2V5XSAhPT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgIWlzRnVuY3Rpb24obzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CgoKZnVuY3Rpb24gY3NwKCkgewogIHJldHVybiAoZG9jdW1lbnQuc2VjdXJpdHlQb2xpY3kgJiYgZG9jdW1lbnQuc2VjdXJpdHlQb2xpY3kuaXNBY3RpdmUpIHx8CiAgICAgIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yICYmCiAgICAgICEhKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tuZy1jc3BdJykgfHwgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbmctY3NwXScpKSk7Cn0KCgpmdW5jdGlvbiBjb25jYXQoYXJyYXkxLCBhcnJheTIsIGluZGV4KSB7CiAgcmV0dXJuIGFycmF5MS5jb25jYXQoc2xpY2UuY2FsbChhcnJheTIsIGluZGV4KSk7Cn0KCmZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKfQoKCi8qIGpzaGludCAtVzEwMSAqLwovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuYmluZAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAqIGBmbmApLiBZb3UgY2FuIHN1cHBseSBvcHRpb25hbCBgYXJnc2AgdGhhdCBhcmUgcHJlYm91bmQgdG8gdGhlIGZ1bmN0aW9uLiBUaGlzIGZlYXR1cmUgaXMgYWxzbwogKiBrbm93biBhcyBbcGFydGlhbCBhcHBsaWNhdGlvbl0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9QYXJ0aWFsX2FwcGxpY2F0aW9uKSwgYXMKICogZGlzdGluZ3Vpc2hlZCBmcm9tIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZyNDb250cmFzdF93aXRoX3BhcnRpYWxfZnVuY3Rpb25fYXBwbGljYXRpb24pLgogKgogKiBAcGFyYW0ge09iamVjdH0gc2VsZiBDb250ZXh0IHdoaWNoIGBmbmAgc2hvdWxkIGJlIGV2YWx1YXRlZCBpbi4KICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBGdW5jdGlvbiB0byBiZSBib3VuZC4KICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gRnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgYGZuYCB3aXRoIGFsbCB0aGUgc3BlY2lmaWVkIGJpbmRpbmdzLgogKi8KLyoganNoaW50ICtXMTAxICovCmZ1bmN0aW9uIGJpbmQoc2VsZiwgZm4pIHsKICB2YXIgY3VycnlBcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBzbGljZUFyZ3MoYXJndW1lbnRzLCAyKSA6IFtdOwogIGlmIChpc0Z1bmN0aW9uKGZuKSAmJiAhKGZuIGluc3RhbmNlb2YgUmVnRXhwKSkgewogICAgcmV0dXJuIGN1cnJ5QXJncy5sZW5ndGgKICAgICAgPyBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgY3VycnlBcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpKQogICAgICAgICAgICA6IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncyk7CiAgICAgICAgfQogICAgICA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGgKICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBhcmd1bWVudHMpCiAgICAgICAgICAgIDogZm4uY2FsbChzZWxmKTsKICAgICAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBpbiBJRSwgbmF0aXZlIG1ldGhvZHMgYXJlIG5vdCBmdW5jdGlvbnMgc28gdGhleSBjYW5ub3QgYmUgYm91bmQgKG5vdGU6IHRoZXkgZG9uJ3QgbmVlZCB0byBiZSkKICAgIHJldHVybiBmbjsKICB9Cn0KCgpmdW5jdGlvbiB0b0pzb25SZXBsYWNlcihrZXksIHZhbHVlKSB7CiAgdmFyIHZhbCA9IHZhbHVlOwoKICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5LmNoYXJBdCgwKSA9PT0gJyQnKSB7CiAgICB2YWwgPSB1bmRlZmluZWQ7CiAgfSBlbHNlIGlmIChpc1dpbmRvdyh2YWx1ZSkpIHsKICAgIHZhbCA9ICckV0lORE9XJzsKICB9IGVsc2UgaWYgKHZhbHVlICYmICBkb2N1bWVudCA9PT0gdmFsdWUpIHsKICAgIHZhbCA9ICckRE9DVU1FTlQnOwogIH0gZWxzZSBpZiAoaXNTY29wZSh2YWx1ZSkpIHsKICAgIHZhbCA9ICckU0NPUEUnOwogIH0KCiAgcmV0dXJuIHZhbDsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci50b0pzb24KICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogU2VyaWFsaXplcyBpbnB1dCBpbnRvIGEgSlNPTi1mb3JtYXR0ZWQgc3RyaW5nLiBQcm9wZXJ0aWVzIHdpdGggbGVhZGluZyAkIGNoYXJhY3RlcnMgd2lsbCBiZQogKiBzdHJpcHBlZCBzaW5jZSBhbmd1bGFyIHVzZXMgdGhpcyBub3RhdGlvbiBpbnRlcm5hbGx5LgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IG9iaiBJbnB1dCB0byBiZSBzZXJpYWxpemVkIGludG8gSlNPTi4KICogQHBhcmFtIHtib29sZWFuPX0gcHJldHR5IElmIHNldCB0byB0cnVlLCB0aGUgSlNPTiBvdXRwdXQgd2lsbCBjb250YWluIG5ld2xpbmVzIGFuZCB3aGl0ZXNwYWNlLgogKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gSlNPTi1pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogKi8KZnVuY3Rpb24gdG9Kc29uKG9iaiwgcHJldHR5KSB7CiAgaWYgKHR5cGVvZiBvYmogPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdW5kZWZpbmVkOwogIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmosIHRvSnNvblJlcGxhY2VyLCBwcmV0dHkgPyAnICAnIDogbnVsbCk7Cn0KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuZnJvbUpzb24KICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGVzZXJpYWxpemVzIGEgSlNPTiBzdHJpbmcuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBqc29uIEpTT04gc3RyaW5nIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fHN0cmluZ3xudW1iZXJ9IERlc2VyaWFsaXplZCB0aGluZ3kuCiAqLwpmdW5jdGlvbiBmcm9tSnNvbihqc29uKSB7CiAgcmV0dXJuIGlzU3RyaW5nKGpzb24pCiAgICAgID8gSlNPTi5wYXJzZShqc29uKQogICAgICA6IGpzb247Cn0KCgpmdW5jdGlvbiB0b0Jvb2xlYW4odmFsdWUpIHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICB2YWx1ZSA9IHRydWU7CiAgfSBlbHNlIGlmICh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGggIT09IDApIHsKICAgIHZhciB2ID0gbG93ZXJjYXNlKCIiICsgdmFsdWUpOwogICAgdmFsdWUgPSAhKHYgPT0gJ2YnIHx8IHYgPT0gJzAnIHx8IHYgPT0gJ2ZhbHNlJyB8fCB2ID09ICdubycgfHwgdiA9PSAnbicgfHwgdiA9PSAnW10nKTsKICB9IGVsc2UgewogICAgdmFsdWUgPSBmYWxzZTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9CgovKioKICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBlbGVtZW50LgogKi8KZnVuY3Rpb24gc3RhcnRpbmdUYWcoZWxlbWVudCkgewogIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCkuY2xvbmUoKTsKICB0cnkgewogICAgLy8gdHVybnMgb3V0IElFIGRvZXMgbm90IGxldCB5b3Ugc2V0IC5odG1sKCkgb24gZWxlbWVudHMgd2hpY2gKICAgIC8vIGFyZSBub3QgYWxsb3dlZCB0byBoYXZlIGNoaWxkcmVuLiBTbyB3ZSBqdXN0IGlnbm9yZSBpdC4KICAgIGVsZW1lbnQuZW1wdHkoKTsKICB9IGNhdGNoKGUpIHt9CiAgLy8gQXMgUGVyIERPTSBTdGFuZGFyZHMKICB2YXIgVEVYVF9OT0RFID0gMzsKICB2YXIgZWxlbUh0bWwgPSBqcUxpdGUoJzxkaXY+JykuYXBwZW5kKGVsZW1lbnQpLmh0bWwoKTsKICB0cnkgewogICAgcmV0dXJuIGVsZW1lbnRbMF0ubm9kZVR5cGUgPT09IFRFWFRfTk9ERSA/IGxvd2VyY2FzZShlbGVtSHRtbCkgOgogICAgICAgIGVsZW1IdG1sLgogICAgICAgICAgbWF0Y2goL14oPFtePl0rPikvKVsxXS4KICAgICAgICAgIHJlcGxhY2UoL148KFtcd1wtXSspLywgZnVuY3Rpb24obWF0Y2gsIG5vZGVOYW1lKSB7IHJldHVybiAnPCcgKyBsb3dlcmNhc2Uobm9kZU5hbWUpOyB9KTsKICB9IGNhdGNoKGUpIHsKICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogIH0KCn0KCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgovKioKICogVHJpZXMgdG8gZGVjb2RlIHRoZSBVUkkgY29tcG9uZW50IHdpdGhvdXQgdGhyb3dpbmcgYW4gZXhjZXB0aW9uLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0gc3RyIHZhbHVlIHBvdGVudGlhbCBVUkkgY29tcG9uZW50IHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGNhbiBiZSBkZWNvZGVkCiAqIHdpdGggdGhlIGRlY29kZVVSSUNvbXBvbmVudCBmdW5jdGlvbi4KICovCmZ1bmN0aW9uIHRyeURlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkgewogIHRyeSB7CiAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICB9IGNhdGNoKGUpIHsKICAgIC8vIElnbm9yZSBhbnkgaW52YWxpZCB1cmkgY29tcG9uZW50CiAgfQp9CgoKLyoqCiAqIFBhcnNlcyBhbiBlc2NhcGVkIHVybCBxdWVyeSBzdHJpbmcgaW50byBrZXktdmFsdWUgcGFpcnMuCiAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZyxib29sZWFufEFycmF5Pn0KICovCmZ1bmN0aW9uIHBhcnNlS2V5VmFsdWUoLyoqc3RyaW5nKi9rZXlWYWx1ZSkgewogIHZhciBvYmogPSB7fSwga2V5X3ZhbHVlLCBrZXk7CiAgZm9yRWFjaCgoa2V5VmFsdWUgfHwgIiIpLnNwbGl0KCcmJyksIGZ1bmN0aW9uKGtleVZhbHVlKSB7CiAgICBpZiAoIGtleVZhbHVlICkgewogICAgICBrZXlfdmFsdWUgPSBrZXlWYWx1ZS5zcGxpdCgnPScpOwogICAgICBrZXkgPSB0cnlEZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzBdKTsKICAgICAgaWYgKCBpc0RlZmluZWQoa2V5KSApIHsKICAgICAgICB2YXIgdmFsID0gaXNEZWZpbmVkKGtleV92YWx1ZVsxXSkgPyB0cnlEZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzFdKSA6IHRydWU7CiAgICAgICAgaWYgKCFvYmpba2V5XSkgewogICAgICAgICAgb2JqW2tleV0gPSB2YWw7CiAgICAgICAgfSBlbHNlIGlmKGlzQXJyYXkob2JqW2tleV0pKSB7CiAgICAgICAgICBvYmpba2V5XS5wdXNoKHZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9ialtrZXldID0gW29ialtrZXldLHZhbF07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgcmV0dXJuIG9iajsKfQoKZnVuY3Rpb24gdG9LZXlWYWx1ZShvYmopIHsKICB2YXIgcGFydHMgPSBbXTsKICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGZvckVhY2godmFsdWUsIGZ1bmN0aW9uKGFycmF5VmFsdWUpIHsKICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSwgdHJ1ZSkgKwogICAgICAgICAgICAgICAgICAgKGFycmF5VmFsdWUgPT09IHRydWUgPyAnJyA6ICc9JyArIGVuY29kZVVyaVF1ZXJ5KGFycmF5VmFsdWUsIHRydWUpKSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5LCB0cnVlKSArCiAgICAgICAgICAgICAgICh2YWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkodmFsdWUsIHRydWUpKSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHBhcnRzLmxlbmd0aCA/IHBhcnRzLmpvaW4oJyYnKSA6ICcnOwp9CgoKLyoqCiAqIFdlIG5lZWQgb3VyIGN1c3RvbSBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFnZ3Jlc3NpdmUgYW5kIGRvZXNuJ3QgZm9sbG93CiAqIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IHdpdGggcmVnYXJkcyB0byB0aGUgY2hhcmFjdGVyIHNldCAocGNoYXIpIGFsbG93ZWQgaW4gcGF0aAogKiBzZWdtZW50czoKICogICAgc2VnbWVudCAgICAgICA9ICpwY2hhcgogKiAgICBwY2hhciAgICAgICAgID0gdW5yZXNlcnZlZCAvIHBjdC1lbmNvZGVkIC8gc3ViLWRlbGltcyAvICI6IiAvICJAIgogKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICogICAgdW5yZXNlcnZlZCAgICA9IEFMUEhBIC8gRElHSVQgLyAiLSIgLyAiLiIgLyAiXyIgLyAifiIKICogICAgc3ViLWRlbGltcyAgICA9ICIhIiAvICIkIiAvICImIiAvICInIiAvICIoIiAvICIpIgogKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAqLwpmdW5jdGlvbiBlbmNvZGVVcmlTZWdtZW50KHZhbCkgewogIHJldHVybiBlbmNvZGVVcmlRdWVyeSh2YWwsIHRydWUpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTI2L2dpLCAnJicpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTNEL2dpLCAnPScpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTJCL2dpLCAnKycpOwp9CgoKLyoqCiAqIFRoaXMgbWV0aG9kIGlzIGludGVuZGVkIGZvciBlbmNvZGluZyAqa2V5KiBvciAqdmFsdWUqIHBhcnRzIG9mIHF1ZXJ5IGNvbXBvbmVudC4gV2UgbmVlZCBhIGN1c3RvbQogKiBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFnZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICogZW5jb2RlZCBwZXIgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NjoKICogICAgcXVlcnkgICAgICAgPSAqKCBwY2hhciAvICIvIiAvICI/IiApCiAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAqICAgIHBjdC1lbmNvZGVkICAgPSAiJSIgSEVYRElHIEhFWERJRwogKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICovCmZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTQwL2dpLCAnQCcpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgICByZXBsYWNlKC8lMkMvZ2ksICcsJykuCiAgICAgICAgICAgICByZXBsYWNlKC8lMjAvZywgKHBjdEVuY29kZVNwYWNlcyA/ICclMjAnIDogJysnKSk7Cn0KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0FwcAogKiBAbW9kdWxlIG5nCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2FuZ3VsYXIuTW9kdWxlfSBuZ0FwcCBhbiBvcHRpb25hbCBhcHBsaWNhdGlvbgogKiAgIHtAbGluayBhbmd1bGFyLm1vZHVsZSBtb2R1bGV9IG5hbWUgdG8gbG9hZC4KICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIFVzZSB0aGlzIGRpcmVjdGl2ZSB0byAqKmF1dG8tYm9vdHN0cmFwKiogYW4gQW5ndWxhckpTIGFwcGxpY2F0aW9uLiBUaGUgYG5nQXBwYCBkaXJlY3RpdmUKICogZGVzaWduYXRlcyB0aGUgKipyb290IGVsZW1lbnQqKiBvZiB0aGUgYXBwbGljYXRpb24gYW5kIGlzIHR5cGljYWxseSBwbGFjZWQgbmVhciB0aGUgcm9vdCBlbGVtZW50CiAqIG9mIHRoZSBwYWdlIC0gZS5nLiBvbiB0aGUgYDxib2R5PmAgb3IgYDxodG1sPmAgdGFncy4KICoKICogT25seSBvbmUgQW5ndWxhckpTIGFwcGxpY2F0aW9uIGNhbiBiZSBhdXRvLWJvb3RzdHJhcHBlZCBwZXIgSFRNTCBkb2N1bWVudC4gVGhlIGZpcnN0IGBuZ0FwcGAKICogZm91bmQgaW4gdGhlIGRvY3VtZW50IHdpbGwgYmUgdXNlZCB0byBkZWZpbmUgdGhlIHJvb3QgZWxlbWVudCB0byBhdXRvLWJvb3RzdHJhcCBhcyBhbgogKiBhcHBsaWNhdGlvbi4gVG8gcnVuIG11bHRpcGxlIGFwcGxpY2F0aW9ucyBpbiBhbiBIVE1MIGRvY3VtZW50IHlvdSBtdXN0IG1hbnVhbGx5IGJvb3RzdHJhcCB0aGVtIHVzaW5nCiAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gaW5zdGVhZC4gQW5ndWxhckpTIGFwcGxpY2F0aW9ucyBjYW5ub3QgYmUgbmVzdGVkIHdpdGhpbiBlYWNoIG90aGVyLgogKgogKiBZb3UgY2FuIHNwZWNpZnkgYW4gKipBbmd1bGFySlMgbW9kdWxlKiogdG8gYmUgdXNlZCBhcyB0aGUgcm9vdCBtb2R1bGUgZm9yIHRoZSBhcHBsaWNhdGlvbi4gIFRoaXMKICogbW9kdWxlIHdpbGwgYmUgbG9hZGVkIGludG8gdGhlIHtAbGluayBhdXRvLiRpbmplY3Rvcn0gd2hlbiB0aGUgYXBwbGljYXRpb24gaXMgYm9vdHN0cmFwcGVkIGFuZAogKiBzaG91bGQgY29udGFpbiB0aGUgYXBwbGljYXRpb24gY29kZSBuZWVkZWQgb3IgaGF2ZSBkZXBlbmRlbmNpZXMgb24gb3RoZXIgbW9kdWxlcyB0aGF0IHdpbGwKICogY29udGFpbiB0aGUgY29kZS4gU2VlIHtAbGluayBhbmd1bGFyLm1vZHVsZX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAqCiAqIEluIHRoZSBleGFtcGxlIGJlbG93IGlmIHRoZSBgbmdBcHBgIGRpcmVjdGl2ZSB3ZXJlIG5vdCBwbGFjZWQgb24gdGhlIGBodG1sYCBlbGVtZW50IHRoZW4gdGhlCiAqIGRvY3VtZW50IHdvdWxkIG5vdCBiZSBjb21waWxlZCwgdGhlIGBBcHBDb250cm9sbGVyYCB3b3VsZCBub3QgYmUgaW5zdGFudGlhdGVkIGFuZCB0aGUgYHt7IGErYiB9fWAKICogd291bGQgbm90IGJlIHJlc29sdmVkIHRvIGAzYC4KICoKICogYG5nQXBwYCBpcyB0aGUgZWFzaWVzdCwgYW5kIG1vc3QgY29tbW9uLCB3YXkgdG8gYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLgogKgogPGV4YW1wbGUgbW9kdWxlPSJuZ0FwcERlbW8iPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJuZ0FwcERlbW9Db250cm9sbGVyIj4KICAgICBJIGNhbiBhZGQ6IHt7YX19ICsge3tifX0gPSAge3sgYStiIH19CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGFuZ3VsYXIubW9kdWxlKCduZ0FwcERlbW8nLCBbXSkuY29udHJvbGxlcignbmdBcHBEZW1vQ29udHJvbGxlcicsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICRzY29wZS5hID0gMTsKICAgICAkc2NvcGUuYiA9IDI7CiAgIH0pOwogICA8L2ZpbGU+CiA8L2V4YW1wbGU+CiAqCiAqLwpmdW5jdGlvbiBhbmd1bGFySW5pdChlbGVtZW50LCBib290c3RyYXApIHsKICB2YXIgZWxlbWVudHMgPSBbZWxlbWVudF0sCiAgICAgIGFwcEVsZW1lbnQsCiAgICAgIG1vZHVsZSwKICAgICAgbmFtZXMgPSBbJ25nOmFwcCcsICduZy1hcHAnLCAneC1uZy1hcHAnLCAnZGF0YS1uZy1hcHAnXSwKICAgICAgTkdfQVBQX0NMQVNTX1JFR0VYUCA9IC9cc25nWzpcLV1hcHAoOlxzKihbXHdcZF9dKyk7Pyk/XHMvOwoKICBmdW5jdGlvbiBhcHBlbmQoZWxlbWVudCkgewogICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogIH0KCiAgZm9yRWFjaChuYW1lcywgZnVuY3Rpb24obmFtZSkgewogICAgbmFtZXNbbmFtZV0gPSB0cnVlOwogICAgYXBwZW5kKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG5hbWUpKTsKICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoJzonLCAnXFw6Jyk7CiAgICBpZiAoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKSB7CiAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUpLCBhcHBlbmQpOwogICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLicgKyBuYW1lICsgJ1xcOicpLCBhcHBlbmQpOwogICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnWycgKyBuYW1lICsgJ10nKSwgYXBwZW5kKTsKICAgIH0KICB9KTsKCiAgZm9yRWFjaChlbGVtZW50cywgZnVuY3Rpb24oZWxlbWVudCkgewogICAgaWYgKCFhcHBFbGVtZW50KSB7CiAgICAgIHZhciBjbGFzc05hbWUgPSAnICcgKyBlbGVtZW50LmNsYXNzTmFtZSArICcgJzsKICAgICAgdmFyIG1hdGNoID0gTkdfQVBQX0NMQVNTX1JFR0VYUC5leGVjKGNsYXNzTmFtZSk7CiAgICAgIGlmIChtYXRjaCkgewogICAgICAgIGFwcEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIG1vZHVsZSA9IChtYXRjaFsyXSB8fCAnJykucmVwbGFjZSgvXHMrL2csICcsJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yRWFjaChlbGVtZW50LmF0dHJpYnV0ZXMsIGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgIGFwcEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICBtb2R1bGUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSk7CiAgaWYgKGFwcEVsZW1lbnQpIHsKICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICB9Cn0KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5ib290c3RyYXAKICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICogVXNlIHRoaXMgZnVuY3Rpb24gdG8gbWFudWFsbHkgc3RhcnQgdXAgYW5ndWxhciBhcHBsaWNhdGlvbi4KICoKICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICoKICogTm90ZSB0aGF0IG5nU2NlbmFyaW8tYmFzZWQgZW5kLXRvLWVuZCB0ZXN0cyBjYW5ub3QgdXNlIHRoaXMgZnVuY3Rpb24gdG8gYm9vdHN0cmFwIG1hbnVhbGx5LgogKiBUaGV5IG11c3QgdXNlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9LgogKgogKiBBbmd1bGFyIHdpbGwgZGV0ZWN0IGlmIGl0IGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBicm93c2VyIG1vcmUgdGhhbiBvbmNlIGFuZCBvbmx5IGFsbG93IHRoZQogKiBmaXJzdCBsb2FkZWQgc2NyaXB0IHRvIGJlIGJvb3RzdHJhcHBlZCBhbmQgd2lsbCByZXBvcnQgYSB3YXJuaW5nIHRvIHRoZSBicm93c2VyIGNvbnNvbGUgZm9yCiAqIGVhY2ggb2YgdGhlIHN1YnNlcXVlbnQgc2NyaXB0cy4gICBUaGlzIHByZXZlbnRzIHN0cmFuZ2UgcmVzdWx0cyBpbiBhcHBsaWNhdGlvbnMsIHdoZXJlIG90aGVyd2lzZQogKiBtdWx0aXBsZSBpbnN0YW5jZXMgb2YgQW5ndWxhciB0cnkgdG8gd29yayBvbiB0aGUgRE9NLgogKgogKiA8ZXhhbXBsZSBuYW1lPSJtdWx0aS1ib290c3RyYXAiIG1vZHVsZT0ibXVsdGktYm9vdHN0cmFwIj4KICogPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAqIDxzY3JpcHQgc3JjPSIuLi8uLi8uLi9hbmd1bGFyLmpzIj48L3NjcmlwdD4KICogPGRpdiBuZy1jb250cm9sbGVyPSJCcm9rZW5UYWJsZSI+CiAqICAgPHRhYmxlPgogKiAgIDx0cj4KICogICAgIDx0aCBuZy1yZXBlYXQ9ImhlYWRpbmcgaW4gaGVhZGluZ3MiPnt7aGVhZGluZ319PC90aD4KICogICA8L3RyPgogKiAgIDx0ciBuZy1yZXBlYXQ9ImZpbGxpbmcgaW4gZmlsbGluZ3MiPgogKiAgICAgPHRkIG5nLXJlcGVhdD0iZmlsbCBpbiBmaWxsaW5nIj57e2ZpbGx9fTwvdGQ+CiAqICAgPC90cj4KICogPC90YWJsZT4KICogPC9kaXY+CiAqIDwvZmlsZT4KICogPGZpbGUgbmFtZT0iY29udHJvbGxlci5qcyI+CiAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnbXVsdGktYm9vdHN0cmFwJywgW10pCiAqCiAqIC5jb250cm9sbGVyKCdCcm9rZW5UYWJsZScsIGZ1bmN0aW9uKCRzY29wZSkgewogKiAgICAgJHNjb3BlLmhlYWRpbmdzID0gWydPbmUnLCAnVHdvJywgJ1RocmVlJ107CiAqICAgICAkc2NvcGUuZmlsbGluZ3MgPSBbWzEsIDIsIDNdLCBbJ0EnLCAnQicsICdDJ10sIFs3LCA4LCA5XV07CiAqIH0pOwogKiA8L2ZpbGU+CiAqIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogKiBpdCgnc2hvdWxkIG9ubHkgaW5zZXJ0IG9uZSB0YWJsZSBjZWxsIGZvciBlYWNoIGl0ZW0gaW4gJHNjb3BlLmZpbGxpbmdzJywgZnVuY3Rpb24oKSB7CiAqICBleHBlY3QoZWxlbWVudC5hbGwoYnkuY3NzKCd0ZCcpKS5jb3VudCgpKQogKiAgICAgIC50b0JlKDkpOwogKiB9KTsKICogPC9maWxlPgogKiA8L2V4YW1wbGU+CiAqCiAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBET00gZWxlbWVudCB3aGljaCBpcyB0aGUgcm9vdCBvZiBhbmd1bGFyIGFwcGxpY2F0aW9uLgogKiBAcGFyYW0ge0FycmF5PFN0cmluZ3xGdW5jdGlvbnxBcnJheT49fSBtb2R1bGVzIGFuIGFycmF5IG9mIG1vZHVsZXMgdG8gbG9hZCBpbnRvIHRoZSBhcHBsaWNhdGlvbi4KICogICAgIEVhY2ggaXRlbSBpbiB0aGUgYXJyYXkgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIGEgcHJlZGVmaW5lZCBtb2R1bGUgb3IgYSAoREkgYW5ub3RhdGVkKQogKiAgICAgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGludm9rZWQgYnkgdGhlIGluamVjdG9yIGFzIGEgcnVuIGJsb2NrLgogKiAgICAgU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICogQHJldHVybnMge2F1dG8uJGluamVjdG9yfSBSZXR1cm5zIHRoZSBuZXdseSBjcmVhdGVkIGluamVjdG9yIGZvciB0aGlzIGFwcC4KICovCmZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgdmFyIGRvQm9vdHN0cmFwID0gZnVuY3Rpb24oKSB7CiAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgIGlmIChlbGVtZW50LmluamVjdG9yKCkpIHsKICAgICAgdmFyIHRhZyA9IChlbGVtZW50WzBdID09PSBkb2N1bWVudCkgPyAnZG9jdW1lbnQnIDogc3RhcnRpbmdUYWcoZWxlbWVudCk7CiAgICAgIHRocm93IG5nTWluRXJyKCdidHN0cnBkJywgIkFwcCBBbHJlYWR5IEJvb3RzdHJhcHBlZCB3aXRoIHRoaXMgRWxlbWVudCAnezB9JyIsIHRhZyk7CiAgICB9CgogICAgbW9kdWxlcyA9IG1vZHVsZXMgfHwgW107CiAgICBtb2R1bGVzLnVuc2hpZnQoWyckcHJvdmlkZScsIGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAgICAgICRwcm92aWRlLnZhbHVlKCckcm9vdEVsZW1lbnQnLCBlbGVtZW50KTsKICAgIH1dKTsKICAgIG1vZHVsZXMudW5zaGlmdCgnbmcnKTsKICAgIHZhciBpbmplY3RvciA9IGNyZWF0ZUluamVjdG9yKG1vZHVsZXMpOwogICAgaW5qZWN0b3IuaW52b2tlKFsnJHJvb3RTY29wZScsICckcm9vdEVsZW1lbnQnLCAnJGNvbXBpbGUnLCAnJGluamVjdG9yJywgJyRhbmltYXRlJywKICAgICAgIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBjb21waWxlLCBpbmplY3RvciwgYW5pbWF0ZSkgewogICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJGluamVjdG9yJywgaW5qZWN0b3IpOwogICAgICAgICAgY29tcGlsZShlbGVtZW50KShzY29wZSk7CiAgICAgICAgfSk7CiAgICAgIH1dCiAgICApOwogICAgcmV0dXJuIGluamVjdG9yOwogIH07CgogIHZhciBOR19ERUZFUl9CT09UU1RSQVAgPSAvXk5HX0RFRkVSX0JPT1RTVFJBUCEvOwoKICBpZiAod2luZG93ICYmICFOR19ERUZFUl9CT09UU1RSQVAudGVzdCh3aW5kb3cubmFtZSkpIHsKICAgIHJldHVybiBkb0Jvb3RzdHJhcCgpOwogIH0KCiAgd2luZG93Lm5hbWUgPSB3aW5kb3cubmFtZS5yZXBsYWNlKE5HX0RFRkVSX0JPT1RTVFJBUCwgJycpOwogIGFuZ3VsYXIucmVzdW1lQm9vdHN0cmFwID0gZnVuY3Rpb24oZXh0cmFNb2R1bGVzKSB7CiAgICBmb3JFYWNoKGV4dHJhTW9kdWxlcywgZnVuY3Rpb24obW9kdWxlKSB7CiAgICAgIG1vZHVsZXMucHVzaChtb2R1bGUpOwogICAgfSk7CiAgICBkb0Jvb3RzdHJhcCgpOwogIH07Cn0KCnZhciBTTkFLRV9DQVNFX1JFR0VYUCA9IC9bQS1aXS9nOwpmdW5jdGlvbiBzbmFrZV9jYXNlKG5hbWUsIHNlcGFyYXRvcikgewogIHNlcGFyYXRvciA9IHNlcGFyYXRvciB8fCAnXyc7CiAgcmV0dXJuIG5hbWUucmVwbGFjZShTTkFLRV9DQVNFX1JFR0VYUCwgZnVuY3Rpb24obGV0dGVyLCBwb3MpIHsKICAgIHJldHVybiAocG9zID8gc2VwYXJhdG9yIDogJycpICsgbGV0dGVyLnRvTG93ZXJDYXNlKCk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGJpbmRKUXVlcnkoKSB7CiAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogIC8vIFVzZSBqUXVlcnkgaWYgaXQgZXhpc3RzIHdpdGggcHJvcGVyIGZ1bmN0aW9uYWxpdHksIG90aGVyd2lzZSBkZWZhdWx0IHRvIHVzLgogIC8vIEFuZ3VsYXIgMS4yKyByZXF1aXJlcyBqUXVlcnkgMS43LjErIGZvciBvbigpL29mZigpIHN1cHBvcnQuCiAgaWYgKGpRdWVyeSAmJiBqUXVlcnkuZm4ub24pIHsKICAgIGpxTGl0ZSA9IGpRdWVyeTsKICAgIGV4dGVuZChqUXVlcnkuZm4sIHsKICAgICAgc2NvcGU6IEpRTGl0ZVByb3RvdHlwZS5zY29wZSwKICAgICAgaXNvbGF0ZVNjb3BlOiBKUUxpdGVQcm90b3R5cGUuaXNvbGF0ZVNjb3BlLAogICAgICBjb250cm9sbGVyOiBKUUxpdGVQcm90b3R5cGUuY29udHJvbGxlciwKICAgICAgaW5qZWN0b3I6IEpRTGl0ZVByb3RvdHlwZS5pbmplY3RvciwKICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlUHJvdG90eXBlLmluaGVyaXRlZERhdGEKICAgIH0pOwogICAgLy8gTWV0aG9kIHNpZ25hdHVyZToKICAgIC8vICAgICBqcUxpdGVQYXRjaEpRdWVyeVJlbW92ZShuYW1lLCBkaXNwYXRjaFRoaXMsIGZpbHRlckVsZW1zLCBnZXR0ZXJJZk5vQXJndW1lbnRzKQogICAganFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ3JlbW92ZScsIHRydWUsIHRydWUsIGZhbHNlKTsKICAgIGpxTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdlbXB0eScsIGZhbHNlLCBmYWxzZSwgZmFsc2UpOwogICAganFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ2h0bWwnLCBmYWxzZSwgZmFsc2UsIHRydWUpOwogIH0gZWxzZSB7CiAgICBqcUxpdGUgPSBKUUxpdGU7CiAgfQogIGFuZ3VsYXIuZWxlbWVudCA9IGpxTGl0ZTsKfQoKLyoqCiAqIHRocm93IGVycm9yIGlmIHRoZSBhcmd1bWVudCBpcyBmYWxzeS4KICovCmZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogIGlmICghYXJnKSB7CiAgICB0aHJvdyBuZ01pbkVycignYXJlcScsICJBcmd1bWVudCAnezB9JyBpcyB7MX0iLCAobmFtZSB8fCAnPycpLCAocmVhc29uIHx8ICJyZXF1aXJlZCIpKTsKICB9CiAgcmV0dXJuIGFyZzsKfQoKZnVuY3Rpb24gYXNzZXJ0QXJnRm4oYXJnLCBuYW1lLCBhY2NlcHRBcnJheUFubm90YXRpb24pIHsKICBpZiAoYWNjZXB0QXJyYXlBbm5vdGF0aW9uICYmIGlzQXJyYXkoYXJnKSkgewogICAgICBhcmcgPSBhcmdbYXJnLmxlbmd0aCAtIDFdOwogIH0KCiAgYXNzZXJ0QXJnKGlzRnVuY3Rpb24oYXJnKSwgbmFtZSwgJ25vdCBhIGZ1bmN0aW9uLCBnb3QgJyArCiAgICAgIChhcmcgJiYgdHlwZW9mIGFyZyA9PSAnb2JqZWN0JyA/IGFyZy5jb25zdHJ1Y3Rvci5uYW1lIHx8ICdPYmplY3QnIDogdHlwZW9mIGFyZykpOwogIHJldHVybiBhcmc7Cn0KCi8qKgogKiB0aHJvdyBlcnJvciBpZiB0aGUgbmFtZSBnaXZlbiBpcyBoYXNPd25Qcm9wZXJ0eQogKiBAcGFyYW0gIHtTdHJpbmd9IG5hbWUgICAgdGhlIG5hbWUgdG8gdGVzdAogKiBAcGFyYW0gIHtTdHJpbmd9IGNvbnRleHQgdGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIG5hbWUgaXMgdXNlZCwgc3VjaCBhcyBtb2R1bGUgb3IgZGlyZWN0aXZlCiAqLwpmdW5jdGlvbiBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCBjb250ZXh0KSB7CiAgaWYgKG5hbWUgPT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgIHRocm93IG5nTWluRXJyKCdiYWRuYW1lJywgImhhc093blByb3BlcnR5IGlzIG5vdCBhIHZhbGlkIHswfSBuYW1lIiwgY29udGV4dCk7CiAgfQp9CgovKioKICogUmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NpYmxlIGZyb20gdGhlIG9iamVjdCBieSBwYXRoLiBBbnkgdW5kZWZpbmVkIHRyYXZlcnNhbHMgYXJlIGlnbm9yZWQKICogQHBhcmFtIHtPYmplY3R9IG9iaiBzdGFydGluZyBvYmplY3QKICogQHBhcmFtIHtTdHJpbmd9IHBhdGggcGF0aCB0byB0cmF2ZXJzZQogKiBAcGFyYW0ge2Jvb2xlYW59IFtiaW5kRm5Ub1Njb3BlPXRydWVdCiAqIEByZXR1cm5zIHtPYmplY3R9IHZhbHVlIGFzIGFjY2Vzc2libGUgYnkgcGF0aAogKi8KLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCmZ1bmN0aW9uIGdldHRlcihvYmosIHBhdGgsIGJpbmRGblRvU2NvcGUpIHsKICBpZiAoIXBhdGgpIHJldHVybiBvYmo7CiAgdmFyIGtleXMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgdmFyIGtleTsKICB2YXIgbGFzdEluc3RhbmNlID0gb2JqOwogIHZhciBsZW4gPSBrZXlzLmxlbmd0aDsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAga2V5ID0ga2V5c1tpXTsKICAgIGlmIChvYmopIHsKICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgIH0KICB9CiAgaWYgKCFiaW5kRm5Ub1Njb3BlICYmIGlzRnVuY3Rpb24ob2JqKSkgewogICAgcmV0dXJuIGJpbmQobGFzdEluc3RhbmNlLCBvYmopOwogIH0KICByZXR1cm4gb2JqOwp9CgovKioKICogUmV0dXJuIHRoZSBET00gc2libGluZ3MgYmV0d2VlbiB0aGUgZmlyc3QgYW5kIGxhc3Qgbm9kZSBpbiB0aGUgZ2l2ZW4gYXJyYXkuCiAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IGxpa2Ugb2JqZWN0CiAqIEByZXR1cm5zIHtET01FbGVtZW50fSBvYmplY3QgY29udGFpbmluZyB0aGUgZWxlbWVudHMKICovCmZ1bmN0aW9uIGdldEJsb2NrRWxlbWVudHMobm9kZXMpIHsKICB2YXIgc3RhcnROb2RlID0gbm9kZXNbMF0sCiAgICAgIGVuZE5vZGUgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXTsKICBpZiAoc3RhcnROb2RlID09PSBlbmROb2RlKSB7CiAgICByZXR1cm4ganFMaXRlKHN0YXJ0Tm9kZSk7CiAgfQoKICB2YXIgZWxlbWVudCA9IHN0YXJ0Tm9kZTsKICB2YXIgZWxlbWVudHMgPSBbZWxlbWVudF07CgogIGRvIHsKICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5leHRTaWJsaW5nOwogICAgaWYgKCFlbGVtZW50KSBicmVhazsKICAgIGVsZW1lbnRzLnB1c2goZWxlbWVudCk7CiAgfSB3aGlsZSAoZWxlbWVudCAhPT0gZW5kTm9kZSk7CgogIHJldHVybiBqcUxpdGUoZWxlbWVudHMpOwp9CgovKioKICogQG5nZG9jIHR5cGUKICogQG5hbWUgYW5ndWxhci5Nb2R1bGUKICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICoKICogSW50ZXJmYWNlIGZvciBjb25maWd1cmluZyBhbmd1bGFyIHtAbGluayBhbmd1bGFyLm1vZHVsZSBtb2R1bGVzfS4KICovCgpmdW5jdGlvbiBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpIHsKCiAgdmFyICRpbmplY3Rvck1pbkVyciA9IG1pbkVycignJGluamVjdG9yJyk7CiAgdmFyIG5nTWluRXJyID0gbWluRXJyKCduZycpOwoKICBmdW5jdGlvbiBlbnN1cmUob2JqLCBuYW1lLCBmYWN0b3J5KSB7CiAgICByZXR1cm4gb2JqW25hbWVdIHx8IChvYmpbbmFtZV0gPSBmYWN0b3J5KCkpOwogIH0KCiAgdmFyIGFuZ3VsYXIgPSBlbnN1cmUod2luZG93LCAnYW5ndWxhcicsIE9iamVjdCk7CgogIC8vIFdlIG5lZWQgdG8gZXhwb3NlIGBhbmd1bGFyLiQkbWluRXJyYCB0byBtb2R1bGVzIHN1Y2ggYXMgYG5nUmVzb3VyY2VgIHRoYXQgcmVmZXJlbmNlIGl0IGR1cmluZyBib290c3RyYXAKICBhbmd1bGFyLiQkbWluRXJyID0gYW5ndWxhci4kJG1pbkVyciB8fCBtaW5FcnI7CgogIHJldHVybiBlbnN1cmUoYW5ndWxhciwgJ21vZHVsZScsIGZ1bmN0aW9uKCkgewogICAgLyoqIEB0eXBlIHtPYmplY3QuPHN0cmluZywgYW5ndWxhci5Nb2R1bGU+fSAqLwogICAgdmFyIG1vZHVsZXMgPSB7fTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5tb2R1bGUKICAgICAqIEBtb2R1bGUgbmcKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFRoZSBgYW5ndWxhci5tb2R1bGVgIGlzIGEgZ2xvYmFsIHBsYWNlIGZvciBjcmVhdGluZywgcmVnaXN0ZXJpbmcgYW5kIHJldHJpZXZpbmcgQW5ndWxhcgogICAgICogbW9kdWxlcy4KICAgICAqIEFsbCBtb2R1bGVzIChhbmd1bGFyIGNvcmUgb3IgM3JkIHBhcnR5KSB0aGF0IHNob3VsZCBiZSBhdmFpbGFibGUgdG8gYW4gYXBwbGljYXRpb24gbXVzdCBiZQogICAgICogcmVnaXN0ZXJlZCB1c2luZyB0aGlzIG1lY2hhbmlzbS4KICAgICAqCiAgICAgKiBXaGVuIHBhc3NlZCB0d28gb3IgbW9yZSBhcmd1bWVudHMsIGEgbmV3IG1vZHVsZSBpcyBjcmVhdGVkLiAgSWYgcGFzc2VkIG9ubHkgb25lIGFyZ3VtZW50LCBhbgogICAgICogZXhpc3RpbmcgbW9kdWxlICh0aGUgbmFtZSBwYXNzZWQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IHRvIGBtb2R1bGVgKSBpcyByZXRyaWV2ZWQuCiAgICAgKgogICAgICoKICAgICAqICMgTW9kdWxlCiAgICAgKgogICAgICogQSBtb2R1bGUgaXMgYSBjb2xsZWN0aW9uIG9mIHNlcnZpY2VzLCBkaXJlY3RpdmVzLCBmaWx0ZXJzLCBhbmQgY29uZmlndXJhdGlvbiBpbmZvcm1hdGlvbi4KICAgICAqIGBhbmd1bGFyLm1vZHVsZWAgaXMgdXNlZCB0byBjb25maWd1cmUgdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAvLyBDcmVhdGUgYSBuZXcgbW9kdWxlCiAgICAgKiB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnbXlNb2R1bGUnLCBbXSk7CiAgICAgKgogICAgICogLy8gcmVnaXN0ZXIgYSBuZXcgc2VydmljZQogICAgICogbXlNb2R1bGUudmFsdWUoJ2FwcE5hbWUnLCAnTXlDb29sQXBwJyk7CiAgICAgKgogICAgICogLy8gY29uZmlndXJlIGV4aXN0aW5nIHNlcnZpY2VzIGluc2lkZSBpbml0aWFsaXphdGlvbiBibG9ja3MuCiAgICAgKiBteU1vZHVsZS5jb25maWcoWyckbG9jYXRpb25Qcm92aWRlcicsIGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgKiAgIC8vIENvbmZpZ3VyZSBleGlzdGluZyBwcm92aWRlcnMKICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICogfV0pOwogICAgICogYGBgCiAgICAgKgogICAgICogVGhlbiB5b3UgY2FuIGNyZWF0ZSBhbiBpbmplY3RvciBhbmQgbG9hZCB5b3VyIG1vZHVsZXMgbGlrZSB0aGlzOgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiB2YXIgaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnLCAnbXlNb2R1bGUnXSkKICAgICAqIGBgYAogICAgICoKICAgICAqIEhvd2V2ZXIgaXQncyBtb3JlIGxpa2VseSB0aGF0IHlvdSdsbCBqdXN0IHVzZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0FwcCBuZ0FwcH0gb3IKICAgICAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gdG8gc2ltcGxpZnkgdGhpcyBwcm9jZXNzIGZvciB5b3UuCiAgICAgKgogICAgICogQHBhcmFtIHshc3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUgdG8gY3JlYXRlIG9yIHJldHJpZXZlLgo8PDw8PCogQHBhcmFtIHshQXJyYXkuPHN0cmluZz49fSByZXF1aXJlcyBJZiBzcGVjaWZpZWQgdGhlbiBuZXcgbW9kdWxlIGlzIGJlaW5nIGNyZWF0ZWQuIElmCj4+Pj4+KiAgICAgICAgdW5zcGVjaWZpZWQgdGhlbiB0aGUgbW9kdWxlIGlzIGJlaW5nIHJldHJpZXZlZCBmb3IgZnVydGhlciBjb25maWd1cmF0aW9uLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBmdW5jdGlvbiBmb3IgdGhlIG1vZHVsZS4gU2FtZSBhcwogICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWcgTW9kdWxlI2NvbmZpZygpfS4KICAgICAqIEByZXR1cm5zIHttb2R1bGV9IG5ldyBtb2R1bGUgd2l0aCB0aGUge0BsaW5rIGFuZ3VsYXIuTW9kdWxlfSBhcGkuCiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbiBtb2R1bGUobmFtZSwgcmVxdWlyZXMsIGNvbmZpZ0ZuKSB7CiAgICAgIHZhciBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eSA9IGZ1bmN0aW9uKG5hbWUsIGNvbnRleHQpIHsKICAgICAgICBpZiAobmFtZSA9PT0gJ2hhc093blByb3BlcnR5JykgewogICAgICAgICAgdGhyb3cgbmdNaW5FcnIoJ2JhZG5hbWUnLCAnaGFzT3duUHJvcGVydHkgaXMgbm90IGEgdmFsaWQgezB9IG5hbWUnLCBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnbW9kdWxlJyk7CiAgICAgIGlmIChyZXF1aXJlcyAmJiBtb2R1bGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgbW9kdWxlc1tuYW1lXSA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuc3VyZShtb2R1bGVzLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXJlcXVpcmVzKSB7CiAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ25vbW9kJywgIk1vZHVsZSAnezB9JyBpcyBub3QgYXZhaWxhYmxlISBZb3UgZWl0aGVyIG1pc3NwZWxsZWQgIiArCiAgICAgICAgICAgICAidGhlIG1vZHVsZSBuYW1lIG9yIGZvcmdvdCB0byBsb2FkIGl0LiBJZiByZWdpc3RlcmluZyBhIG1vZHVsZSBlbnN1cmUgdGhhdCB5b3UgIiArCiAgICAgICAgICAgICAic3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQuIiwgbmFtZSk7CiAgICAgICAgfQoKICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48QXJyYXkuPCo+Pn0gKi8KICAgICAgICB2YXIgaW52b2tlUXVldWUgPSBbXTsKCiAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEZ1bmN0aW9uPn0gKi8KICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CgogICAgICAgIHZhciBjb25maWcgPSBpbnZva2VMYXRlcignJGluamVjdG9yJywgJ2ludm9rZScpOwoKICAgICAgICAvKiogQHR5cGUge2FuZ3VsYXIuTW9kdWxlfSAqLwogICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IHsKICAgICAgICAgIC8vIFByaXZhdGUgc3RhdGUKICAgICAgICAgIF9pbnZva2VRdWV1ZTogaW52b2tlUXVldWUsCiAgICAgICAgICBfcnVuQmxvY2tzOiBydW5CbG9ja3MsCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3JlcXVpcmVzCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59IExpc3Qgb2YgbW9kdWxlIG5hbWVzIHdoaWNoIG11c3QgYmUgbG9hZGVkIGJlZm9yZSB0aGlzIG1vZHVsZS4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogSG9sZHMgdGhlIGxpc3Qgb2YgbW9kdWxlcyB3aGljaCB0aGUgaW5qZWN0b3Igd2lsbCBsb2FkIGJlZm9yZSB0aGUgY3VycmVudCBtb2R1bGUgaXMKICAgICAgICAgICAqIGxvYWRlZC4KICAgICAgICAgICAqLwogICAgICAgICAgcmVxdWlyZXM6IHJlcXVpcmVzLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNuYW1lCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBOYW1lIG9mIHRoZSBtb2R1bGUuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqLwogICAgICAgICAgbmFtZTogbmFtZSwKCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNwcm92aWRlcgogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlclR5cGUgQ29uc3RydWN0aW9uIGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlCiAgICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZS4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogICAgICAgICAgICovCiAgICAgICAgICBwcm92aWRlcjogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3Byb3ZpZGVyJyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmYWN0b3J5CiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyRnVuY3Rpb24gRnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI2ZhY3RvcnkgJHByb3ZpZGUuZmFjdG9yeSgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgZmFjdG9yeTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ2ZhY3RvcnknKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3NlcnZpY2UKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjc2VydmljZSAkcHJvdmlkZS5zZXJ2aWNlKCl9LgogICAgICAgICAgICovCiAgICAgICAgICBzZXJ2aWNlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnc2VydmljZScpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjdmFsdWUKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICogQHBhcmFtIHsqfSBvYmplY3QgU2VydmljZSBpbnN0YW5jZSBvYmplY3QuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSN2YWx1ZSAkcHJvdmlkZS52YWx1ZSgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgdmFsdWU6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICd2YWx1ZScpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uc3RhbnQKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGNvbnN0YW50IG5hbWUKICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IENvbnN0YW50IHZhbHVlLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBCZWNhdXNlIHRoZSBjb25zdGFudCBhcmUgZml4ZWQsIHRoZXkgZ2V0IGFwcGxpZWQgYmVmb3JlIG90aGVyIHByb3ZpZGUgbWV0aG9kcy4KICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNjb25zdGFudCAkcHJvdmlkZS5jb25zdGFudCgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgY29uc3RhbnQ6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdjb25zdGFudCcsICd1bnNoaWZ0JyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNhbmltYXRpb24KICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGFuaW1hdGlvbiBuYW1lCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBhbmltYXRpb25GYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBhbgogICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRpb24uCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiAqKk5PVEUqKjogYW5pbWF0aW9ucyB0YWtlIGVmZmVjdCBvbmx5IGlmIHRoZSAqKm5nQW5pbWF0ZSoqIG1vZHVsZSBpcyBsb2FkZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICoKICAgICAgICAgICAqIERlZmluZXMgYW4gYW5pbWF0aW9uIGhvb2sgdGhhdCBjYW4gYmUgbGF0ZXIgdXNlZCB3aXRoCiAgICAgICAgICAgKiB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlICRhbmltYXRlfSBzZXJ2aWNlIGFuZCBkaXJlY3RpdmVzIHRoYXQgdXNlIHRoaXMgc2VydmljZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBgYGBqcwogICAgICAgICAgICogbW9kdWxlLmFuaW1hdGlvbignLmFuaW1hdGlvbi1uYW1lJywgZnVuY3Rpb24oJGluamVjdDEsICRpbmplY3QyKSB7CiAgICAgICAgICAgKiAgIHJldHVybiB7CiAgICAgICAgICAgKiAgICAgZXZlbnROYW1lIDogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogICAgICAgICAgICogICAgICAgLy9jb2RlIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgKiAgICAgICAvL29uY2UgY29tcGxldGUsIHRoZW4gcnVuIGRvbmUoKQogICAgICAgICAgICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNhbmNlbGxhdGlvbkZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAqICAgICAgICAgLy9jb2RlIHRvIGNhbmNlbCB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgKiAgICAgICB9CiAgICAgICAgICAgKiAgICAgfQogICAgICAgICAgICogICB9CiAgICAgICAgICAgKiB9KQogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKgogICAgICAgICAgICogU2VlIHtAbGluayBuZ0FuaW1hdGUuJGFuaW1hdGVQcm92aWRlciNyZWdpc3RlciAkYW5pbWF0ZVByb3ZpZGVyLnJlZ2lzdGVyKCl9IGFuZAogICAgICAgICAgICoge0BsaW5rIG5nQW5pbWF0ZSBuZ0FuaW1hdGUgbW9kdWxlfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAqLwogICAgICAgICAgYW5pbWF0aW9uOiBpbnZva2VMYXRlcignJGFuaW1hdGVQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmlsdGVyCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBGaWx0ZXIgbmFtZS4KICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZpbHRlckZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIGZpbHRlci4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICovCiAgICAgICAgICBmaWx0ZXI6IGludm9rZUxhdGVyKCckZmlsdGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnRyb2xsZXIKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBDb250cm9sbGVyIG5hbWUsIG9yIGFuIG9iamVjdCBtYXAgb2YgY29udHJvbGxlcnMgd2hlcmUgdGhlCiAgICAgICAgICAgKiAgICBrZXlzIGFyZSB0aGUgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBjb25zdHJ1Y3RvcnMuCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25zdHJ1Y3RvciBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGNvbnRyb2xsZXJQcm92aWRlci5yZWdpc3RlcigpfS4KICAgICAgICAgICAqLwogICAgICAgICAgY29udHJvbGxlcjogaW52b2tlTGF0ZXIoJyRjb250cm9sbGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2RpcmVjdGl2ZQogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIERpcmVjdGl2ZSBuYW1lLCBvciBhbiBvYmplY3QgbWFwIG9mIGRpcmVjdGl2ZXMgd2hlcmUgdGhlCiAgICAgICAgICAgKiAgICBrZXlzIGFyZSB0aGUgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBmYWN0b3JpZXMuCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBkaXJlY3RpdmVGYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZgogICAgICAgICAgICogZGlyZWN0aXZlcy4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgZGlyZWN0aXZlOiBpbnZva2VMYXRlcignJGNvbXBpbGVQcm92aWRlcicsICdkaXJlY3RpdmUnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZwogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIG9uIG1vZHVsZSBsb2FkLiBVc2VmdWwgZm9yIHNlcnZpY2UKICAgICAgICAgICAqICAgIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIG5lZWRzIHRvIGJlIHBlcmZvcm1lZCBvbiBtb2R1bGUgbG9hZGluZy4KICAgICAgICAgICAqIEZvciBtb3JlIGFib3V0IGhvdyB0byBjb25maWd1cmUgc2VydmljZXMsIHNlZQogICAgICAgICAgICoge0BsaW5rIHByb3ZpZGVycyNwcm92aWRlcnNfcHJvdmlkZXItcmVjaXBlIFByb3ZpZGVyIFJlY2lwZX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIGNvbmZpZzogY29uZmlnLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcnVuCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpbml0aWFsaXphdGlvbkZuIEV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBhZnRlciBpbmplY3RvciBjcmVhdGlvbi4KICAgICAgICAgICAqICAgIFVzZWZ1bCBmb3IgYXBwbGljYXRpb24gaW5pdGlhbGl6YXRpb24uCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIHNob3VsZCBiZSBwZXJmb3JtZWQgd2hlbiB0aGUgaW5qZWN0b3IgaXMgZG9uZQogICAgICAgICAgICogbG9hZGluZyBhbGwgbW9kdWxlcy4KICAgICAgICAgICAqLwogICAgICAgICAgcnVuOiBmdW5jdGlvbihibG9jaykgewogICAgICAgICAgICBydW5CbG9ja3MucHVzaChibG9jayk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGlmIChjb25maWdGbikgewogICAgICAgICAgY29uZmlnKGNvbmZpZ0ZuKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAgbW9kdWxlSW5zdGFuY2U7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm92aWRlcgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2QKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZz19IGluc2VydE1ldGhvZAogICAgICAgICAqIEByZXR1cm5zIHthbmd1bGFyLk1vZHVsZX0KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXRlcihwcm92aWRlciwgbWV0aG9kLCBpbnNlcnRNZXRob2QpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW52b2tlUXVldWVbaW5zZXJ0TWV0aG9kIHx8ICdwdXNoJ10oW3Byb3ZpZGVyLCBtZXRob2QsIGFyZ3VtZW50c10pOwogICAgICAgICAgICByZXR1cm4gbW9kdWxlSW5zdGFuY2U7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwogIH0pOwoKfQoKLyogZ2xvYmFsCiAgICBhbmd1bGFyTW9kdWxlOiB0cnVlLAogICAgdmVyc2lvbjogdHJ1ZSwKCiAgICAkTG9jYWxlUHJvdmlkZXIsCiAgICAkQ29tcGlsZVByb3ZpZGVyLAoKICAgIGh0bWxBbmNob3JEaXJlY3RpdmUsCiAgICBpbnB1dERpcmVjdGl2ZSwKICAgIGlucHV0RGlyZWN0aXZlLAogICAgZm9ybURpcmVjdGl2ZSwKICAgIHNjcmlwdERpcmVjdGl2ZSwKICAgIHNlbGVjdERpcmVjdGl2ZSwKICAgIHN0eWxlRGlyZWN0aXZlLAogICAgb3B0aW9uRGlyZWN0aXZlLAogICAgbmdCaW5kRGlyZWN0aXZlLAogICAgbmdCaW5kSHRtbERpcmVjdGl2ZSwKICAgIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlLAogICAgbmdDbGFzc0RpcmVjdGl2ZSwKICAgIG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogICAgbmdDbGFzc09kZERpcmVjdGl2ZSwKICAgIG5nQ3NwRGlyZWN0aXZlLAogICAgbmdDbG9ha0RpcmVjdGl2ZSwKICAgIG5nQ29udHJvbGxlckRpcmVjdGl2ZSwKICAgIG5nRm9ybURpcmVjdGl2ZSwKICAgIG5nSGlkZURpcmVjdGl2ZSwKICAgIG5nSWZEaXJlY3RpdmUsCiAgICBuZ0luY2x1ZGVEaXJlY3RpdmUsCiAgICBuZ0luY2x1ZGVGaWxsQ29udGVudERpcmVjdGl2ZSwKICAgIG5nSW5pdERpcmVjdGl2ZSwKICAgIG5nTm9uQmluZGFibGVEaXJlY3RpdmUsCiAgICBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgIG5nUmVwZWF0RGlyZWN0aXZlLAogICAgbmdTaG93RGlyZWN0aXZlLAogICAgbmdTdHlsZURpcmVjdGl2ZSwKICAgIG5nU3dpdGNoRGlyZWN0aXZlLAogICAgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogICAgbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlLAogICAgbmdPcHRpb25zRGlyZWN0aXZlLAogICAgbmdUcmFuc2NsdWRlRGlyZWN0aXZlLAogICAgbmdNb2RlbERpcmVjdGl2ZSwKICAgIG5nTGlzdERpcmVjdGl2ZSwKICAgIG5nQ2hhbmdlRGlyZWN0aXZlLAogICAgcmVxdWlyZWREaXJlY3RpdmUsCiAgICByZXF1aXJlZERpcmVjdGl2ZSwKICAgIG5nVmFsdWVEaXJlY3RpdmUsCiAgICBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcywKICAgIG5nRXZlbnREaXJlY3RpdmVzLAoKICAgICRBbmNob3JTY3JvbGxQcm92aWRlciwKICAgICRBbmltYXRlUHJvdmlkZXIsCiAgICAkQnJvd3NlclByb3ZpZGVyLAogICAgJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgJENvbnRyb2xsZXJQcm92aWRlciwKICAgICREb2N1bWVudFByb3ZpZGVyLAogICAgJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlciwKICAgICRGaWx0ZXJQcm92aWRlciwKICAgICRJbnRlcnBvbGF0ZVByb3ZpZGVyLAogICAgJEludGVydmFsUHJvdmlkZXIsCiAgICAkSHR0cFByb3ZpZGVyLAogICAgJEh0dHBCYWNrZW5kUHJvdmlkZXIsCiAgICAkTG9jYXRpb25Qcm92aWRlciwKICAgICRMb2dQcm92aWRlciwKICAgICRQYXJzZVByb3ZpZGVyLAogICAgJFJvb3RTY29wZVByb3ZpZGVyLAogICAgJFFQcm92aWRlciwKICAgICQkU2FuaXRpemVVcmlQcm92aWRlciwKICAgICRTY2VQcm92aWRlciwKICAgICRTY2VEZWxlZ2F0ZVByb3ZpZGVyLAogICAgJFNuaWZmZXJQcm92aWRlciwKICAgICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAkVGltZW91dFByb3ZpZGVyLAogICAgJCRSQUZQcm92aWRlciwKICAgICQkQXN5bmNDYWxsYmFja1Byb3ZpZGVyLAogICAgJFdpbmRvd1Byb3ZpZGVyCiovCgoKLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgYW5ndWxhci52ZXJzaW9uCiAqIEBtb2R1bGUgbmcKICogQGRlc2NyaXB0aW9uCiAqIEFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IEFuZ3VsYXJKUyB2ZXJzaW9uLiBUaGlzIG9iamVjdCBoYXMgdGhlCiAqIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogKgogKiAtIGBmdWxsYCDigJMgYHtzdHJpbmd9YCDigJMgRnVsbCB2ZXJzaW9uIHN0cmluZywgc3VjaCBhcyAiMC45LjE4Ii4KICogLSBgbWFqb3JgIOKAkyBge251bWJlcn1gIOKAkyBNYWpvciB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMCIuCiAqIC0gYG1pbm9yYCDigJMgYHtudW1iZXJ9YCDigJMgTWlub3IgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjkiLgogKiAtIGBkb3RgIOKAkyBge251bWJlcn1gIOKAkyBEb3QgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjE4Ii4KICogLSBgY29kZU5hbWVgIOKAkyBge3N0cmluZ31gIOKAkyBDb2RlIG5hbWUgb2YgdGhlIHJlbGVhc2UsIHN1Y2ggYXMgImppZ2dsaW5nLWFybWZhdCIuCiAqLwp2YXIgdmVyc2lvbiA9IHsKICBmdWxsOiAnMS4yLjE3JywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogIG1pbm9yOiAyLAogIGRvdDogMTcsCiAgY29kZU5hbWU6ICdxdWFudHVtLWRpc2VudGFuZ2xlbWVudCcKfTsKCgpmdW5jdGlvbiBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcil7CiAgZXh0ZW5kKGFuZ3VsYXIsIHsKICAgICdib290c3RyYXAnOiBib290c3RyYXAsCiAgICAnY29weSc6IGNvcHksCiAgICAnZXh0ZW5kJzogZXh0ZW5kLAogICAgJ2VxdWFscyc6IGVxdWFscywKICAgICdlbGVtZW50JzoganFMaXRlLAogICAgJ2ZvckVhY2gnOiBmb3JFYWNoLAogICAgJ2luamVjdG9yJzogY3JlYXRlSW5qZWN0b3IsCiAgICAnbm9vcCc6bm9vcCwKICAgICdiaW5kJzpiaW5kLAogICAgJ3RvSnNvbic6IHRvSnNvbiwKICAgICdmcm9tSnNvbic6IGZyb21Kc29uLAogICAgJ2lkZW50aXR5JzppZGVudGl0eSwKICAgICdpc1VuZGVmaW5lZCc6IGlzVW5kZWZpbmVkLAogICAgJ2lzRGVmaW5lZCc6IGlzRGVmaW5lZCwKICAgICdpc1N0cmluZyc6IGlzU3RyaW5nLAogICAgJ2lzRnVuY3Rpb24nOiBpc0Z1bmN0aW9uLAogICAgJ2lzT2JqZWN0JzogaXNPYmplY3QsCiAgICAnaXNOdW1iZXInOiBpc051bWJlciwKICAgICdpc0VsZW1lbnQnOiBpc0VsZW1lbnQsCiAgICAnaXNBcnJheSc6IGlzQXJyYXksCiAgICAndmVyc2lvbic6IHZlcnNpb24sCiAgICAnaXNEYXRlJzogaXNEYXRlLAogICAgJ2xvd2VyY2FzZSc6IGxvd2VyY2FzZSwKICAgICd1cHBlcmNhc2UnOiB1cHBlcmNhc2UsCiAgICAnY2FsbGJhY2tzJzoge2NvdW50ZXI6IDB9LAogICAgJyQkbWluRXJyJzogbWluRXJyLAogICAgJyQkY3NwJzogY3NwCiAgfSk7CgogIGFuZ3VsYXJNb2R1bGUgPSBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpOwogIHRyeSB7CiAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGFuZ3VsYXJNb2R1bGUoJ25nTG9jYWxlJywgW10pLnByb3ZpZGVyKCckbG9jYWxlJywgJExvY2FsZVByb3ZpZGVyKTsKICB9CgogIGFuZ3VsYXJNb2R1bGUoJ25nJywgWyduZ0xvY2FsZSddLCBbJyRwcm92aWRlJywKICAgIGZ1bmN0aW9uIG5nTW9kdWxlKCRwcm92aWRlKSB7CiAgICAgIC8vICQkc2FuaXRpemVVcmlQcm92aWRlciBuZWVkcyB0byBiZSBiZWZvcmUgJGNvbXBpbGVQcm92aWRlciBhcyBpdCBpcyB1c2VkIGJ5IGl0LgogICAgICAkcHJvdmlkZS5wcm92aWRlcih7CiAgICAgICAgJCRzYW5pdGl6ZVVyaTogJCRTYW5pdGl6ZVVyaVByb3ZpZGVyCiAgICAgIH0pOwogICAgICAkcHJvdmlkZS5wcm92aWRlcignJGNvbXBpbGUnLCAkQ29tcGlsZVByb3ZpZGVyKS4KICAgICAgICBkaXJlY3RpdmUoewogICAgICAgICAgICBhOiBodG1sQW5jaG9yRGlyZWN0aXZlLAogICAgICAgICAgICBpbnB1dDogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgIHRleHRhcmVhOiBpbnB1dERpcmVjdGl2ZSwKICAgICAgICAgICAgZm9ybTogZm9ybURpcmVjdGl2ZSwKICAgICAgICAgICAgc2NyaXB0OiBzY3JpcHREaXJlY3RpdmUsCiAgICAgICAgICAgIHNlbGVjdDogc2VsZWN0RGlyZWN0aXZlLAogICAgICAgICAgICBzdHlsZTogc3R5bGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG9wdGlvbjogb3B0aW9uRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0JpbmQ6IG5nQmluZERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdCaW5kSHRtbDogbmdCaW5kSHRtbERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdCaW5kVGVtcGxhdGU6IG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NsYXNzOiBuZ0NsYXNzRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NsYXNzRXZlbjogbmdDbGFzc0V2ZW5EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2xhc3NPZGQ6IG5nQ2xhc3NPZGREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2xvYWs6IG5nQ2xvYWtEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ29udHJvbGxlcjogbmdDb250cm9sbGVyRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0Zvcm06IG5nRm9ybURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdIaWRlOiBuZ0hpZGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nSWY6IG5nSWZEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nSW5jbHVkZTogbmdJbmNsdWRlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0luaXQ6IG5nSW5pdERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdOb25CaW5kYWJsZTogbmdOb25CaW5kYWJsZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdQbHVyYWxpemU6IG5nUGx1cmFsaXplRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1JlcGVhdDogbmdSZXBlYXREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU2hvdzogbmdTaG93RGlyZWN0aXZlLAogICAgICAgICAgICBuZ1N0eWxlOiBuZ1N0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU3dpdGNoV2hlbjogbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1N3aXRjaERlZmF1bHQ6IG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nVHJhbnNjbHVkZTogbmdUcmFuc2NsdWRlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ01vZGVsOiBuZ01vZGVsRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0xpc3Q6IG5nTGlzdERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDaGFuZ2U6IG5nQ2hhbmdlRGlyZWN0aXZlLAogICAgICAgICAgICByZXF1aXJlZDogcmVxdWlyZWREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nUmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1ZhbHVlOiBuZ1ZhbHVlRGlyZWN0aXZlCiAgICAgICAgfSkuCiAgICAgICAgZGlyZWN0aXZlKHsKICAgICAgICAgIG5nSW5jbHVkZTogbmdJbmNsdWRlRmlsbENvbnRlbnREaXJlY3RpdmUKICAgICAgICB9KS4KICAgICAgICBkaXJlY3RpdmUobmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMpLgogICAgICAgIGRpcmVjdGl2ZShuZ0V2ZW50RGlyZWN0aXZlcyk7CiAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgJGFuaW1hdGU6ICRBbmltYXRlUHJvdmlkZXIsCiAgICAgICAgJGJyb3dzZXI6ICRCcm93c2VyUHJvdmlkZXIsCiAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICRjb250cm9sbGVyOiAkQ29udHJvbGxlclByb3ZpZGVyLAogICAgICAgICRkb2N1bWVudDogJERvY3VtZW50UHJvdmlkZXIsCiAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgJGZpbHRlcjogJEZpbHRlclByb3ZpZGVyLAogICAgICAgICRpbnRlcnBvbGF0ZTogJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICAgICAgJGludGVydmFsOiAkSW50ZXJ2YWxQcm92aWRlciwKICAgICAgICAkaHR0cDogJEh0dHBQcm92aWRlciwKICAgICAgICAkaHR0cEJhY2tlbmQ6ICRIdHRwQmFja2VuZFByb3ZpZGVyLAogICAgICAgICRsb2NhdGlvbjogJExvY2F0aW9uUHJvdmlkZXIsCiAgICAgICAgJGxvZzogJExvZ1Byb3ZpZGVyLAogICAgICAgICRwYXJzZTogJFBhcnNlUHJvdmlkZXIsCiAgICAgICAgJHJvb3RTY29wZTogJFJvb3RTY29wZVByb3ZpZGVyLAogICAgICAgICRxOiAkUVByb3ZpZGVyLAogICAgICAgICRzY2U6ICRTY2VQcm92aWRlciwKICAgICAgICAkc2NlRGVsZWdhdGU6ICRTY2VEZWxlZ2F0ZVByb3ZpZGVyLAogICAgICAgICRzbmlmZmVyOiAkU25pZmZlclByb3ZpZGVyLAogICAgICAgICR0ZW1wbGF0ZUNhY2hlOiAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyLAogICAgICAgICR0aW1lb3V0OiAkVGltZW91dFByb3ZpZGVyLAogICAgICAgICR3aW5kb3c6ICRXaW5kb3dQcm92aWRlciwKICAgICAgICAkJHJBRjogJCRSQUZQcm92aWRlciwKICAgICAgICAkJGFzeW5jQ2FsbGJhY2sgOiAkJEFzeW5jQ2FsbGJhY2tQcm92aWRlcgogICAgICB9KTsKICAgIH0KICBdKTsKfQoKLyogZ2xvYmFsCgogIC1KUUxpdGVQcm90b3R5cGUsCiAgLWFkZEV2ZW50TGlzdGVuZXJGbiwKICAtcmVtb3ZlRXZlbnRMaXN0ZW5lckZuLAogIC1CT09MRUFOX0FUVFIKKi8KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy9KUUxpdGUKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmVsZW1lbnQKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogV3JhcHMgYSByYXcgRE9NIGVsZW1lbnQgb3IgSFRNTCBzdHJpbmcgYXMgYSBbalF1ZXJ5XShodHRwOi8vanF1ZXJ5LmNvbSkgZWxlbWVudC4KICoKICogSWYgalF1ZXJ5IGlzIGF2YWlsYWJsZSwgYGFuZ3VsYXIuZWxlbWVudGAgaXMgYW4gYWxpYXMgZm9yIHRoZQogKiBbalF1ZXJ5XShodHRwOi8vYXBpLmpxdWVyeS5jb20valF1ZXJ5LykgZnVuY3Rpb24uIElmIGpRdWVyeSBpcyBub3QgYXZhaWxhYmxlLCBgYW5ndWxhci5lbGVtZW50YAogKiBkZWxlZ2F0ZXMgdG8gQW5ndWxhcidzIGJ1aWx0LWluIHN1YnNldCBvZiBqUXVlcnksIGNhbGxlZCAialF1ZXJ5IGxpdGUiIG9yICJqcUxpdGUuIgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1zdWNjZXNzIj5qcUxpdGUgaXMgYSB0aW55LCBBUEktY29tcGF0aWJsZSBzdWJzZXQgb2YgalF1ZXJ5IHRoYXQgYWxsb3dzCiAqIEFuZ3VsYXIgdG8gbWFuaXB1bGF0ZSB0aGUgRE9NIGluIGEgY3Jvc3MtYnJvd3NlciBjb21wYXRpYmxlIHdheS4gKipqcUxpdGUqKiBpbXBsZW1lbnRzIG9ubHkgdGhlIG1vc3QKICogY29tbW9ubHkgbmVlZGVkIGZ1bmN0aW9uYWxpdHkgd2l0aCB0aGUgZ29hbCBvZiBoYXZpbmcgYSB2ZXJ5IHNtYWxsIGZvb3RwcmludC48L2Rpdj4KICoKICogVG8gdXNlIGpRdWVyeSwgc2ltcGx5IGxvYWQgaXQgYmVmb3JlIGBET01Db250ZW50TG9hZGVkYCBldmVudCBmaXJlZC4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQiPioqTm90ZToqKiBhbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yCiAqIGpxTGl0ZTsgdGhleSBhcmUgbmV2ZXIgcmF3IERPTSByZWZlcmVuY2VzLjwvZGl2PgogKgogKiAjIyBBbmd1bGFyJ3MganFMaXRlCiAqIGpxTGl0ZSBwcm92aWRlcyBvbmx5IHRoZSBmb2xsb3dpbmcgalF1ZXJ5IG1ldGhvZHM6CiAqCiAqIC0gW2BhZGRDbGFzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FkZENsYXNzLykKICogLSBbYGFmdGVyKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWZ0ZXIvKQogKiAtIFtgYXBwZW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYXBwZW5kLykKICogLSBbYGF0dHIoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hdHRyLykKICogLSBbYGJpbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9iaW5kLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMsIHNlbGVjdG9ycyBvciBldmVudERhdGEKICogLSBbYGNoaWxkcmVuKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY2hpbGRyZW4vKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAqIC0gW2BjbG9uZSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nsb25lLykKICogLSBbYGNvbnRlbnRzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY29udGVudHMvKQogKiAtIFtgY3NzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY3NzLykKICogLSBbYGRhdGEoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9kYXRhLykKICogLSBbYGVtcHR5KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZW1wdHkvKQogKiAtIFtgZXEoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9lcS8pCiAqIC0gW2BmaW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZmluZC8pIC0gTGltaXRlZCB0byBsb29rdXBzIGJ5IHRhZyBuYW1lCiAqIC0gW2BoYXNDbGFzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2hhc0NsYXNzLykKICogLSBbYGh0bWwoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9odG1sLykKICogLSBbYG5leHQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9uZXh0LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogKiAtIFtgb24oKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9vbi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzLCBzZWxlY3RvcnMgb3IgZXZlbnREYXRhCiAqIC0gW2BvZmYoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9vZmYvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcyBvciBzZWxlY3RvcnMKICogLSBbYG9uZSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uZS8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzIG9yIHNlbGVjdG9ycwogKiAtIFtgcGFyZW50KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcGFyZW50LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogKiAtIFtgcHJlcGVuZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ByZXBlbmQvKQogKiAtIFtgcHJvcCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3Byb3AvKQogKiAtIFtgcmVhZHkoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZWFkeS8pCiAqIC0gW2ByZW1vdmUoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmUvKQogKiAtIFtgcmVtb3ZlQXR0cigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUF0dHIvKQogKiAtIFtgcmVtb3ZlQ2xhc3MoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVDbGFzcy8pCiAqIC0gW2ByZW1vdmVEYXRhKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlRGF0YS8pCiAqIC0gW2ByZXBsYWNlV2l0aCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlcGxhY2VXaXRoLykKICogLSBbYHRleHQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90ZXh0LykKICogLSBbYHRvZ2dsZUNsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdG9nZ2xlQ2xhc3MvKQogKiAtIFtgdHJpZ2dlckhhbmRsZXIoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90cmlnZ2VySGFuZGxlci8pIC0gUGFzc2VzIGEgZHVtbXkgZXZlbnQgb2JqZWN0IHRvIGhhbmRsZXJzLgogKiAtIFtgdW5iaW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdW5iaW5kLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMKICogLSBbYHZhbCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ZhbC8pCiAqIC0gW2B3cmFwKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vd3JhcC8pCiAqCiAqICMjIGpRdWVyeS9qcUxpdGUgRXh0cmFzCiAqIEFuZ3VsYXIgYWxzbyBwcm92aWRlcyB0aGUgZm9sbG93aW5nIGFkZGl0aW9uYWwgbWV0aG9kcyBhbmQgZXZlbnRzIHRvIGJvdGggalF1ZXJ5IGFuZCBqcUxpdGU6CiAqCiAqICMjIyBFdmVudHMKICogLSBgJGRlc3Ryb3lgIC0gQW5ndWxhckpTIGludGVyY2VwdHMgYWxsIGpxTGl0ZS9qUXVlcnkncyBET00gZGVzdHJ1Y3Rpb24gYXBpcyBhbmQgZmlyZXMgdGhpcyBldmVudAogKiAgICBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuICBUaGlzIGNhbiBiZSB1c2VkIHRvIGNsZWFuIHVwIGFueSAzcmQgcGFydHkgYmluZGluZ3MgdG8gdGhlIERPTQogKiAgICBlbGVtZW50IGJlZm9yZSBpdCBpcyByZW1vdmVkLgogKgogKiAjIyMgTWV0aG9kcwogKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICogICByZXRyaWV2ZXMgY29udHJvbGxlciBhc3NvY2lhdGVkIHdpdGggdGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZS4gSWYgYG5hbWVgIGlzIHByb3ZpZGVkIGFzCiAqICAgY2FtZWxDYXNlIGRpcmVjdGl2ZSBuYW1lLCB0aGVuIHRoZSBjb250cm9sbGVyIGZvciB0aGlzIGRpcmVjdGl2ZSB3aWxsIGJlIHJldHJpZXZlZCAoZS5nLgogKiAgIGAnbmdNb2RlbCdgKS4KICogLSBgaW5qZWN0b3IoKWAgLSByZXRyaWV2ZXMgdGhlIGluamVjdG9yIG9mIHRoZSBjdXJyZW50IGVsZW1lbnQgb3IgaXRzIHBhcmVudC4KICogLSBgc2NvcGUoKWAgLSByZXRyaWV2ZXMgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogKiAgIGVsZW1lbnQgb3IgaXRzIHBhcmVudC4KICogLSBgaXNvbGF0ZVNjb3BlKClgIC0gcmV0cmlldmVzIGFuIGlzb2xhdGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9IGlmIG9uZSBpcyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUKICogICBjdXJyZW50IGVsZW1lbnQuIFRoaXMgZ2V0dGVyIHNob3VsZCBiZSB1c2VkIG9ubHkgb24gZWxlbWVudHMgdGhhdCBjb250YWluIGEgZGlyZWN0aXZlIHdoaWNoIHN0YXJ0cyBhIG5ldyBpc29sYXRlCiAqICAgc2NvcGUuIENhbGxpbmcgYHNjb3BlKClgIG9uIHRoaXMgZWxlbWVudCBhbHdheXMgcmV0dXJucyB0aGUgb3JpZ2luYWwgbm9uLWlzb2xhdGUgc2NvcGUuCiAqIC0gYGluaGVyaXRlZERhdGEoKWAgLSBzYW1lIGFzIGBkYXRhKClgLCBidXQgd2Fsa3MgdXAgdGhlIERPTSB1bnRpbCBhIHZhbHVlIGlzIGZvdW5kIG9yIHRoZSB0b3AKICogICBwYXJlbnQgZWxlbWVudCBpcyByZWFjaGVkLgogKgogKiBAcGFyYW0ge3N0cmluZ3xET01FbGVtZW50fSBlbGVtZW50IEhUTUwgc3RyaW5nIG9yIERPTUVsZW1lbnQgdG8gYmUgd3JhcHBlZCBpbnRvIGpRdWVyeS4KICogQHJldHVybnMge09iamVjdH0galF1ZXJ5IG9iamVjdC4KICovCgp2YXIganFDYWNoZSA9IEpRTGl0ZS5jYWNoZSA9IHt9LAogICAganFOYW1lID0gSlFMaXRlLmV4cGFuZG8gPSAnbmcnICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICBqcUlkID0gMSwKICAgIGFkZEV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcgogICAgICA/IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7fQogICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pO30pLAogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyCiAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsgfQogICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOyB9KTsKCi8qCiAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgZnVuY3Rpb24gISEhCiAqLwp2YXIganFEYXRhID0gSlFMaXRlLl9kYXRhID0gZnVuY3Rpb24obm9kZSkgewogIC8valF1ZXJ5IGFsd2F5cyByZXR1cm5zIGFuIG9iamVjdCBvbiBjYWNoZSBtaXNzCiAgcmV0dXJuIHRoaXMuY2FjaGVbbm9kZVt0aGlzLmV4cGFuZG9dXSB8fCB7fTsKfTsKCmZ1bmN0aW9uIGpxTmV4dElkKCkgeyByZXR1cm4gKytqcUlkOyB9CgoKdmFyIFNQRUNJQUxfQ0hBUlNfUkVHRVhQID0gLyhbXDpcLVxfXSsoLikpL2c7CnZhciBNT1pfSEFDS19SRUdFWFAgPSAvXm1veihbQS1aXSkvOwp2YXIganFMaXRlTWluRXJyID0gbWluRXJyKCdqcUxpdGUnKTsKCi8qKgogKiBDb252ZXJ0cyBzbmFrZV9jYXNlIHRvIGNhbWVsQ2FzZS4KICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICovCmZ1bmN0aW9uIGNhbWVsQ2FzZShuYW1lKSB7CiAgcmV0dXJuIG5hbWUuCiAgICByZXBsYWNlKFNQRUNJQUxfQ0hBUlNfUkVHRVhQLCBmdW5jdGlvbihfLCBzZXBhcmF0b3IsIGxldHRlciwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiBvZmZzZXQgPyBsZXR0ZXIudG9VcHBlckNhc2UoKSA6IGxldHRlcjsKICAgIH0pLgogICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8galF1ZXJ5IG11dGF0aW9uIHBhdGNoCi8vCi8vIEluIGNvbmp1bmN0aW9uIHdpdGggYmluZEpRdWVyeSBpbnRlcmNlcHRzIGFsbCBqUXVlcnkncyBET00gZGVzdHJ1Y3Rpb24gYXBpcyBhbmQgZmlyZXMgYQovLyAkZGVzdHJveSBldmVudCBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuCi8vCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKZnVuY3Rpb24ganFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzLCBmaWx0ZXJFbGVtcywgZ2V0dGVySWZOb0FyZ3VtZW50cykgewogIHZhciBvcmlnaW5hbEpxRm4gPSBqUXVlcnkuZm5bbmFtZV07CiAgb3JpZ2luYWxKcUZuID0gb3JpZ2luYWxKcUZuLiRvcmlnaW5hbCB8fCBvcmlnaW5hbEpxRm47CiAgcmVtb3ZlUGF0Y2guJG9yaWdpbmFsID0gb3JpZ2luYWxKcUZuOwogIGpRdWVyeS5mbltuYW1lXSA9IHJlbW92ZVBhdGNoOwoKICBmdW5jdGlvbiByZW1vdmVQYXRjaChwYXJhbSkgewogICAgLy8ganNoaW50IC1XMDQwCiAgICB2YXIgbGlzdCA9IGZpbHRlckVsZW1zICYmIHBhcmFtID8gW3RoaXMuZmlsdGVyKHBhcmFtKV0gOiBbdGhpc10sCiAgICAgICAgZmlyZUV2ZW50ID0gZGlzcGF0Y2hUaGlzLAogICAgICAgIHNldCwgc2V0SW5kZXgsIHNldExlbmd0aCwKICAgICAgICBlbGVtZW50LCBjaGlsZEluZGV4LCBjaGlsZExlbmd0aCwgY2hpbGRyZW47CgogICAgaWYgKCFnZXR0ZXJJZk5vQXJndW1lbnRzIHx8IHBhcmFtICE9IG51bGwpIHsKICAgICAgd2hpbGUobGlzdC5sZW5ndGgpIHsKICAgICAgICBzZXQgPSBsaXN0LnNoaWZ0KCk7CiAgICAgICAgZm9yKHNldEluZGV4ID0gMCwgc2V0TGVuZ3RoID0gc2V0Lmxlbmd0aDsgc2V0SW5kZXggPCBzZXRMZW5ndGg7IHNldEluZGV4KyspIHsKICAgICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoc2V0W3NldEluZGV4XSk7CiAgICAgICAgICBpZiAoZmlyZUV2ZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQudHJpZ2dlckhhbmRsZXIoJyRkZXN0cm95Jyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmaXJlRXZlbnQgPSAhZmlyZUV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgZm9yKGNoaWxkSW5kZXggPSAwLCBjaGlsZExlbmd0aCA9IChjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSkubGVuZ3RoOwogICAgICAgICAgICAgIGNoaWxkSW5kZXggPCBjaGlsZExlbmd0aDsKICAgICAgICAgICAgICBjaGlsZEluZGV4KyspIHsKICAgICAgICAgICAgbGlzdC5wdXNoKGpRdWVyeShjaGlsZHJlbltjaGlsZEluZGV4XSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG9yaWdpbmFsSnFGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KfQoKdmFyIFNJTkdMRV9UQUdfUkVHRVhQID0gL148KFx3KylccypcLz8+KD86PFwvXDE+fCkkLzsKdmFyIEhUTUxfUkVHRVhQID0gLzx8JiM/XHcrOy87CnZhciBUQUdfTkFNRV9SRUdFWFAgPSAvPChbXHc6XSspLzsKdmFyIFhIVE1MX1RBR19SRUdFWFAgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpOwoKdmFyIHdyYXBNYXAgPSB7CiAgJ29wdGlvbic6IFsxLCAnPHNlbGVjdCBtdWx0aXBsZT0ibXVsdGlwbGUiPicsICc8L3NlbGVjdD4nXSwKCiAgJ3RoZWFkJzogWzEsICc8dGFibGU+JywgJzwvdGFibGU+J10sCiAgJ2NvbCc6IFsyLCAnPHRhYmxlPjxjb2xncm91cD4nLCAnPC9jb2xncm91cD48L3RhYmxlPiddLAogICd0cic6IFsyLCAnPHRhYmxlPjx0Ym9keT4nLCAnPC90Ym9keT48L3RhYmxlPiddLAogICd0ZCc6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddLAogICdfZGVmYXVsdCc6IFswLCAiIiwgIiJdCn07Cgp3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CndyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CndyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKZnVuY3Rpb24ganFMaXRlSXNUZXh0Tm9kZShodG1sKSB7CiAgcmV0dXJuICFIVE1MX1JFR0VYUC50ZXN0KGh0bWwpOwp9CgpmdW5jdGlvbiBqcUxpdGVCdWlsZEZyYWdtZW50KGh0bWwsIGNvbnRleHQpIHsKICB2YXIgZWxlbSwgdG1wLCB0YWcsIHdyYXAsCiAgICAgIGZyYWdtZW50ID0gY29udGV4dC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgIG5vZGVzID0gW10sIGksIGosIGpqOwoKICBpZiAoanFMaXRlSXNUZXh0Tm9kZShodG1sKSkgewogICAgLy8gQ29udmVydCBub24taHRtbCBpbnRvIGEgdGV4dCBub2RlCiAgICBub2Rlcy5wdXNoKGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoaHRtbCkpOwogIH0gZWxzZSB7CiAgICB0bXAgPSBmcmFnbWVudC5hcHBlbmRDaGlsZChjb250ZXh0LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTsKICAgIC8vIENvbnZlcnQgaHRtbCBpbnRvIERPTSBub2RlcwogICAgdGFnID0gKFRBR19OQU1FX1JFR0VYUC5leGVjKGh0bWwpIHx8IFsiIiwgIiJdKVsxXS50b0xvd2VyQ2FzZSgpOwogICAgd3JhcCA9IHdyYXBNYXBbdGFnXSB8fCB3cmFwTWFwLl9kZWZhdWx0OwogICAgdG1wLmlubmVySFRNTCA9ICc8ZGl2PiYjMTYwOzwvZGl2PicgKwogICAgICB3cmFwWzFdICsgaHRtbC5yZXBsYWNlKFhIVE1MX1RBR19SRUdFWFAsICI8JDE+PC8kMj4iKSArIHdyYXBbMl07CiAgICB0bXAucmVtb3ZlQ2hpbGQodG1wLmZpcnN0Q2hpbGQpOwoKICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgaSA9IHdyYXBbMF07CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICB9CgogICAgZm9yIChqPTAsIGpqPXRtcC5jaGlsZE5vZGVzLmxlbmd0aDsgajxqajsgKytqKSBub2Rlcy5wdXNoKHRtcC5jaGlsZE5vZGVzW2pdKTsKCiAgICB0bXAgPSBmcmFnbWVudC5maXJzdENoaWxkOwogICAgdG1wLnRleHRDb250ZW50ID0gIiI7CiAgfQoKICAvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CiAgZnJhZ21lbnQudGV4dENvbnRlbnQgPSAiIjsKICBmcmFnbWVudC5pbm5lckhUTUwgPSAiIjsgLy8gQ2xlYXIgaW5uZXIgSFRNTAogIHJldHVybiBub2RlczsKfQoKZnVuY3Rpb24ganFMaXRlUGFyc2VIVE1MKGh0bWwsIGNvbnRleHQpIHsKICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICB2YXIgcGFyc2VkOwoKICBpZiAoKHBhcnNlZCA9IFNJTkdMRV9UQUdfUkVHRVhQLmV4ZWMoaHRtbCkpKSB7CiAgICByZXR1cm4gW2NvbnRleHQuY3JlYXRlRWxlbWVudChwYXJzZWRbMV0pXTsKICB9CgogIHJldHVybiBqcUxpdGVCdWlsZEZyYWdtZW50KGh0bWwsIGNvbnRleHQpOwp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KZnVuY3Rpb24gSlFMaXRlKGVsZW1lbnQpIHsKICBpZiAoZWxlbWVudCBpbnN0YW5jZW9mIEpRTGl0ZSkgewogICAgcmV0dXJuIGVsZW1lbnQ7CiAgfQogIGlmIChpc1N0cmluZyhlbGVtZW50KSkgewogICAgZWxlbWVudCA9IHRyaW0oZWxlbWVudCk7CiAgfQogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBKUUxpdGUpKSB7CiAgICBpZiAoaXNTdHJpbmcoZWxlbWVudCkgJiYgZWxlbWVudC5jaGFyQXQoMCkgIT0gJzwnKSB7CiAgICAgIHRocm93IGpxTGl0ZU1pbkVycignbm9zZWwnLCAnTG9va2luZyB1cCBlbGVtZW50cyB2aWEgc2VsZWN0b3JzIGlzIG5vdCBzdXBwb3J0ZWQgYnkganFMaXRlISBTZWU6IGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL2FuZ3VsYXIuZWxlbWVudCcpOwogICAgfQogICAgcmV0dXJuIG5ldyBKUUxpdGUoZWxlbWVudCk7CiAgfQoKICBpZiAoaXNTdHJpbmcoZWxlbWVudCkpIHsKICAgIGpxTGl0ZUFkZE5vZGVzKHRoaXMsIGpxTGl0ZVBhcnNlSFRNTChlbGVtZW50KSk7CiAgICB2YXIgZnJhZ21lbnQgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpKTsKICAgIGZyYWdtZW50LmFwcGVuZCh0aGlzKTsKICB9IGVsc2UgewogICAganFMaXRlQWRkTm9kZXModGhpcywgZWxlbWVudCk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVDbG9uZShlbGVtZW50KSB7CiAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwp9CgpmdW5jdGlvbiBqcUxpdGVEZWFsb2MoZWxlbWVudCl7CiAganFMaXRlUmVtb3ZlRGF0YShlbGVtZW50KTsKICBmb3IgKCB2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGpxTGl0ZURlYWxvYyhjaGlsZHJlbltpXSk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVPZmYoZWxlbWVudCwgdHlwZSwgZm4sIHVuc3VwcG9ydGVkKSB7CiAgaWYgKGlzRGVmaW5lZCh1bnN1cHBvcnRlZCkpIHRocm93IGpxTGl0ZU1pbkVycignb2ZmYXJncycsICdqcUxpdGUjb2ZmKCkgZG9lcyBub3Qgc3VwcG9ydCB0aGUgYHNlbGVjdG9yYCBhcmd1bWVudCcpOwoKICB2YXIgZXZlbnRzID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgaGFuZGxlID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgaWYgKCFoYW5kbGUpIHJldHVybjsgLy9ubyBsaXN0ZW5lcnMgcmVnaXN0ZXJlZAoKICBpZiAoaXNVbmRlZmluZWQodHlwZSkpIHsKICAgIGZvckVhY2goZXZlbnRzLCBmdW5jdGlvbihldmVudEhhbmRsZXIsIHR5cGUpIHsKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGV2ZW50SGFuZGxlcik7CiAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICB9KTsKICB9IGVsc2UgewogICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKGZuKSkgewogICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudHNbdHlwZV0pOwogICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXJyYXlSZW1vdmUoZXZlbnRzW3R5cGVdIHx8IFtdLCBmbik7CiAgICAgIH0KICAgIH0pOwogIH0KfQoKZnVuY3Rpb24ganFMaXRlUmVtb3ZlRGF0YShlbGVtZW50LCBuYW1lKSB7CiAgdmFyIGV4cGFuZG9JZCA9IGVsZW1lbnRbanFOYW1lXSwKICAgICAgZXhwYW5kb1N0b3JlID0ganFDYWNoZVtleHBhbmRvSWRdOwoKICBpZiAoZXhwYW5kb1N0b3JlKSB7CiAgICBpZiAobmFtZSkgewogICAgICBkZWxldGUganFDYWNoZVtleHBhbmRvSWRdLmRhdGFbbmFtZV07CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZXhwYW5kb1N0b3JlLmhhbmRsZSkgewogICAgICBleHBhbmRvU3RvcmUuZXZlbnRzLiRkZXN0cm95ICYmIGV4cGFuZG9TdG9yZS5oYW5kbGUoe30sICckZGVzdHJveScpOwogICAgICBqcUxpdGVPZmYoZWxlbWVudCk7CiAgICB9CiAgICBkZWxldGUganFDYWNoZVtleHBhbmRvSWRdOwogICAgZWxlbWVudFtqcU5hbWVdID0gdW5kZWZpbmVkOyAvLyBpZSBkb2VzIG5vdCBhbGxvdyBkZWxldGlvbiBvZiBhdHRyaWJ1dGVzIG9uIGVsZW1lbnRzLgogIH0KfQoKZnVuY3Rpb24ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsIGtleSwgdmFsdWUpIHsKICB2YXIgZXhwYW5kb0lkID0gZWxlbWVudFtqcU5hbWVdLAogICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZCB8fCAtMV07CgogIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICBpZiAoIWV4cGFuZG9TdG9yZSkgewogICAgICBlbGVtZW50W2pxTmFtZV0gPSBleHBhbmRvSWQgPSBqcU5leHRJZCgpOwogICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF0gPSB7fTsKICAgIH0KICAgIGV4cGFuZG9TdG9yZVtrZXldID0gdmFsdWU7CiAgfSBlbHNlIHsKICAgIHJldHVybiBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlW2tleV07CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVEYXRhKGVsZW1lbnQsIGtleSwgdmFsdWUpIHsKICB2YXIgZGF0YSA9IGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZGF0YScpLAogICAgICBpc1NldHRlciA9IGlzRGVmaW5lZCh2YWx1ZSksCiAgICAgIGtleURlZmluZWQgPSAhaXNTZXR0ZXIgJiYgaXNEZWZpbmVkKGtleSksCiAgICAgIGlzU2ltcGxlR2V0dGVyID0ga2V5RGVmaW5lZCAmJiAhaXNPYmplY3Qoa2V5KTsKCiAgaWYgKCFkYXRhICYmICFpc1NpbXBsZUdldHRlcikgewogICAganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJywgZGF0YSA9IHt9KTsKICB9CgogIGlmIChpc1NldHRlcikgewogICAgZGF0YVtrZXldID0gdmFsdWU7CiAgfSBlbHNlIHsKICAgIGlmIChrZXlEZWZpbmVkKSB7CiAgICAgIGlmIChpc1NpbXBsZUdldHRlcikgewogICAgICAgIC8vIGRvbid0IGNyZWF0ZSBkYXRhIGluIHRoaXMgY2FzZS4KICAgICAgICByZXR1cm4gZGF0YSAmJiBkYXRhW2tleV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZXh0ZW5kKGRhdGEsIGtleSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBkYXRhOwogICAgfQogIH0KfQoKZnVuY3Rpb24ganFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICBpZiAoIWVsZW1lbnQuZ2V0QXR0cmlidXRlKSByZXR1cm4gZmFsc2U7CiAgcmV0dXJuICgoIiAiICsgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIikucmVwbGFjZSgvW1xuXHRdL2csICIgIikuCiAgICAgIGluZGV4T2YoICIgIiArIHNlbGVjdG9yICsgIiAiICkgPiAtMSk7Cn0KCmZ1bmN0aW9uIGpxTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICBpZiAoY3NzQ2xhc3NlcyAmJiBlbGVtZW50LnNldEF0dHJpYnV0ZSkgewogICAgZm9yRWFjaChjc3NDbGFzc2VzLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGNzc0NsYXNzKSB7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdjbGFzcycsIHRyaW0oCiAgICAgICAgICAoIiAiICsgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIikKICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgLnJlcGxhY2UoIiAiICsgdHJpbShjc3NDbGFzcykgKyAiICIsICIgIikpCiAgICAgICk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICBpZiAoY3NzQ2xhc3NlcyAmJiBlbGVtZW50LnNldEF0dHJpYnV0ZSkgewogICAgdmFyIGV4aXN0aW5nQ2xhc3NlcyA9ICgnICcgKyAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgJyAnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpOwoKICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICBjc3NDbGFzcyA9IHRyaW0oY3NzQ2xhc3MpOwogICAgICBpZiAoZXhpc3RpbmdDbGFzc2VzLmluZGV4T2YoJyAnICsgY3NzQ2xhc3MgKyAnICcpID09PSAtMSkgewogICAgICAgIGV4aXN0aW5nQ2xhc3NlcyArPSBjc3NDbGFzcyArICcgJzsKICAgICAgfQogICAgfSk7CgogICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdHJpbShleGlzdGluZ0NsYXNzZXMpKTsKICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUFkZE5vZGVzKHJvb3QsIGVsZW1lbnRzKSB7CiAgaWYgKGVsZW1lbnRzKSB7CiAgICBlbGVtZW50cyA9ICghZWxlbWVudHMubm9kZU5hbWUgJiYgaXNEZWZpbmVkKGVsZW1lbnRzLmxlbmd0aCkgJiYgIWlzV2luZG93KGVsZW1lbnRzKSkKICAgICAgPyBlbGVtZW50cwogICAgICA6IFsgZWxlbWVudHMgXTsKICAgIGZvcih2YXIgaT0wOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgcm9vdC5wdXNoKGVsZW1lbnRzW2ldKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUNvbnRyb2xsZXIoZWxlbWVudCwgbmFtZSkgewogIHJldHVybiBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckJyArIChuYW1lIHx8ICduZ0NvbnRyb2xsZXInICkgKyAnQ29udHJvbGxlcicpOwp9CgpmdW5jdGlvbiBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKCiAgLy8gaWYgZWxlbWVudCBpcyB0aGUgZG9jdW1lbnQgb2JqZWN0IHdvcmsgd2l0aCB0aGUgaHRtbCBlbGVtZW50IGluc3RlYWQKICAvLyB0aGlzIG1ha2VzICQoZG9jdW1lbnQpLnNjb3BlKCkgcG9zc2libGUKICBpZihlbGVtZW50WzBdLm5vZGVUeXBlID09IDkpIHsKICAgIGVsZW1lbnQgPSBlbGVtZW50LmZpbmQoJ2h0bWwnKTsKICB9CiAgdmFyIG5hbWVzID0gaXNBcnJheShuYW1lKSA/IG5hbWUgOiBbbmFtZV07CgogIHdoaWxlIChlbGVtZW50Lmxlbmd0aCkgewogICAgdmFyIG5vZGUgPSBlbGVtZW50WzBdOwogICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbmFtZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICBpZiAoKHZhbHVlID0gZWxlbWVudC5kYXRhKG5hbWVzW2ldKSkgIT09IHVuZGVmaW5lZCkgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8vIElmIGRlYWxpbmcgd2l0aCBhIGRvY3VtZW50IGZyYWdtZW50IG5vZGUgd2l0aCBhIGhvc3QgZWxlbWVudCwgYW5kIG5vIHBhcmVudCwgdXNlIHRoZSBob3N0CiAgICAvLyBlbGVtZW50IGFzIHRoZSBwYXJlbnQuIFRoaXMgZW5hYmxlcyBkaXJlY3RpdmVzIHdpdGhpbiBhIFNoYWRvdyBET00gb3IgcG9seWZpbGxlZCBTaGFkb3cgRE9NCiAgICAvLyB0byBsb29rdXAgcGFyZW50IGNvbnRyb2xsZXJzLgogICAgZWxlbWVudCA9IGpxTGl0ZShub2RlLnBhcmVudE5vZGUgfHwgKG5vZGUubm9kZVR5cGUgPT09IDExICYmIG5vZGUuaG9zdCkpOwogIH0KfQoKZnVuY3Rpb24ganFMaXRlRW1wdHkoZWxlbWVudCkgewogIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gZWxlbWVudC5jaGlsZE5vZGVzOyBpIDwgY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAganFMaXRlRGVhbG9jKGNoaWxkTm9kZXNbaV0pOwogIH0KICB3aGlsZSAoZWxlbWVudC5maXJzdENoaWxkKSB7CiAgICBlbGVtZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQuZmlyc3RDaGlsZCk7CiAgfQp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIHdoaWNoIGFyZSBkZWNsYXJlZCBkaXJlY3RseS4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCnZhciBKUUxpdGVQcm90b3R5cGUgPSBKUUxpdGUucHJvdG90eXBlID0gewogIHJlYWR5OiBmdW5jdGlvbihmbikgewogICAgdmFyIGZpcmVkID0gZmFsc2U7CgogICAgZnVuY3Rpb24gdHJpZ2dlcigpIHsKICAgICAgaWYgKGZpcmVkKSByZXR1cm47CiAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgZm4oKTsKICAgIH0KCiAgICAvLyBjaGVjayBpZiBkb2N1bWVudCBhbHJlYWR5IGlzIGxvYWRlZAogICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpewogICAgICBzZXRUaW1lb3V0KHRyaWdnZXIpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5vbignRE9NQ29udGVudExvYWRlZCcsIHRyaWdnZXIpOyAvLyB3b3JrcyBmb3IgbW9kZXJuIGJyb3dzZXJzIGFuZCBJRTkKICAgICAgLy8gd2UgY2FuIG5vdCB1c2UganFMaXRlIHNpbmNlIHdlIGFyZSBub3QgZG9uZSBsb2FkaW5nIGFuZCBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGxhdGVyLgogICAgICAvLyBqc2hpbnQgLVcwNjQKICAgICAgSlFMaXRlKHdpbmRvdykub24oJ2xvYWQnLCB0cmlnZ2VyKTsgLy8gZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCBmb3Igb3RoZXJzCiAgICAgIC8vIGpzaGludCArVzA2NAogICAgfQogIH0sCiAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgdmFyIHZhbHVlID0gW107CiAgICBmb3JFYWNoKHRoaXMsIGZ1bmN0aW9uKGUpeyB2YWx1ZS5wdXNoKCcnICsgZSk7fSk7CiAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICB9LAoKICBlcTogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIChpbmRleCA+PSAwKSA/IGpxTGl0ZSh0aGlzW2luZGV4XSkgOiBqcUxpdGUodGhpc1t0aGlzLmxlbmd0aCArIGluZGV4XSk7CiAgfSwKCiAgbGVuZ3RoOiAwLAogIHB1c2g6IHB1c2gsCiAgc29ydDogW10uc29ydCwKICBzcGxpY2U6IFtdLnNwbGljZQp9OwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIEZ1bmN0aW9ucyBpdGVyYXRpbmcgZ2V0dGVyL3NldHRlcnMuCi8vIHRoZXNlIGZ1bmN0aW9ucyByZXR1cm4gc2VsZiBvbiBzZXR0ZXIgYW5kCi8vIHZhbHVlIG9uIGdldC4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCnZhciBCT09MRUFOX0FUVFIgPSB7fTsKZm9yRWFjaCgnbXVsdGlwbGUsc2VsZWN0ZWQsY2hlY2tlZCxkaXNhYmxlZCxyZWFkT25seSxyZXF1aXJlZCxvcGVuJy5zcGxpdCgnLCcpLCBmdW5jdGlvbih2YWx1ZSkgewogIEJPT0xFQU5fQVRUUltsb3dlcmNhc2UodmFsdWUpXSA9IHZhbHVlOwp9KTsKdmFyIEJPT0xFQU5fRUxFTUVOVFMgPSB7fTsKZm9yRWFjaCgnaW5wdXQsc2VsZWN0LG9wdGlvbix0ZXh0YXJlYSxidXR0b24sZm9ybSxkZXRhaWxzJy5zcGxpdCgnLCcpLCBmdW5jdGlvbih2YWx1ZSkgewogIEJPT0xFQU5fRUxFTUVOVFNbdXBwZXJjYXNlKHZhbHVlKV0gPSB0cnVlOwp9KTsKCmZ1bmN0aW9uIGdldEJvb2xlYW5BdHRyTmFtZShlbGVtZW50LCBuYW1lKSB7CiAgLy8gY2hlY2sgZG9tIGxhc3Qgc2luY2Ugd2Ugd2lsbCBtb3N0IGxpa2VseSBmYWlsIG9uIG5hbWUKICB2YXIgYm9vbGVhbkF0dHIgPSBCT09MRUFOX0FUVFJbbmFtZS50b0xvd2VyQ2FzZSgpXTsKCiAgLy8gYm9vbGVhbkF0dHIgaXMgaGVyZSB0d2ljZSB0byBtaW5pbWl6ZSBET00gYWNjZXNzCiAgcmV0dXJuIGJvb2xlYW5BdHRyICYmIEJPT0xFQU5fRUxFTUVOVFNbZWxlbWVudC5ub2RlTmFtZV0gJiYgYm9vbGVhbkF0dHI7Cn0KCmZvckVhY2goewogIGRhdGE6IGpxTGl0ZURhdGEsCiAgaW5oZXJpdGVkRGF0YToganFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgc2NvcGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIC8vIENhbid0IHVzZSBqcUxpdGVEYXRhIGhlcmUgZGlyZWN0bHkgc28gd2Ugc3RheSBjb21wYXRpYmxlIHdpdGggalF1ZXJ5IQogICAgcmV0dXJuIGpxTGl0ZShlbGVtZW50KS5kYXRhKCckc2NvcGUnKSB8fCBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQucGFyZW50Tm9kZSB8fCBlbGVtZW50LCBbJyRpc29sYXRlU2NvcGUnLCAnJHNjb3BlJ10pOwogIH0sCgogIGlzb2xhdGVTY29wZTogZnVuY3Rpb24oZWxlbWVudCkgewogICAgLy8gQ2FuJ3QgdXNlIGpxTGl0ZURhdGEgaGVyZSBkaXJlY3RseSBzbyB3ZSBzdGF5IGNvbXBhdGlibGUgd2l0aCBqUXVlcnkhCiAgICByZXR1cm4ganFMaXRlKGVsZW1lbnQpLmRhdGEoJyRpc29sYXRlU2NvcGUnKSB8fCBqcUxpdGUoZWxlbWVudCkuZGF0YSgnJGlzb2xhdGVTY29wZU5vVGVtcGxhdGUnKTsKICB9LAoKICBjb250cm9sbGVyOiBqcUxpdGVDb250cm9sbGVyLAoKICBpbmplY3RvcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgcmV0dXJuIGpxTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRpbmplY3RvcicpOwogIH0sCgogIHJlbW92ZUF0dHI6IGZ1bmN0aW9uKGVsZW1lbnQsbmFtZSkgewogICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgfSwKCiAgaGFzQ2xhc3M6IGpxTGl0ZUhhc0NsYXNzLAoKICBjc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICBuYW1lID0gY2FtZWxDYXNlKG5hbWUpOwoKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGVsZW1lbnQuc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciB2YWw7CgogICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgLy8gdGhpcyBpcyBzb21lIElFIHNwZWNpZmljIHdlaXJkbmVzcyB0aGF0IGpRdWVyeSAxLjYuNCBkb2VzIG5vdCBzdXJlIHdoeQogICAgICAgIHZhbCA9IGVsZW1lbnQuY3VycmVudFN0eWxlICYmIGVsZW1lbnQuY3VycmVudFN0eWxlW25hbWVdOwogICAgICAgIGlmICh2YWwgPT09ICcnKSB2YWwgPSAnYXV0byc7CiAgICAgIH0KCiAgICAgIHZhbCA9IHZhbCB8fCBlbGVtZW50LnN0eWxlW25hbWVdOwoKICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgIC8vIGpxdWVyeSB3ZWlyZG5lc3MgOi0vCiAgICAgICAgdmFsID0gKHZhbCA9PT0gJycpID8gdW5kZWZpbmVkIDogdmFsOwogICAgICB9CgogICAgICByZXR1cm4gIHZhbDsKICAgIH0KICB9LAoKICBhdHRyOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lLCB2YWx1ZSl7CiAgICB2YXIgbG93ZXJjYXNlZE5hbWUgPSBsb3dlcmNhc2UobmFtZSk7CiAgICBpZiAoQk9PTEVBTl9BVFRSW2xvd2VyY2FzZWROYW1lXSkgewogICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgIGlmICghIXZhbHVlKSB7CiAgICAgICAgICBlbGVtZW50W25hbWVdID0gdHJ1ZTsKICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIGxvd2VyY2FzZWROYW1lKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudFtuYW1lXSA9IGZhbHNlOwogICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobG93ZXJjYXNlZE5hbWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gKGVsZW1lbnRbbmFtZV0gfHwKICAgICAgICAgICAgICAgICAoZWxlbWVudC5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbShuYW1lKXx8IG5vb3ApLnNwZWNpZmllZCkKICAgICAgICAgICAgICAgPyBsb3dlcmNhc2VkTmFtZQogICAgICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgLy8gdGhlIGV4dHJhIGFyZ3VtZW50ICIyIiBpcyB0byBnZXQgdGhlIHJpZ2h0IHRoaW5nIGZvciBhLmhyZWYgaW4gSUUsIHNlZSBqUXVlcnkgY29kZQogICAgICAvLyBzb21lIGVsZW1lbnRzIChlLmcuIERvY3VtZW50KSBkb24ndCBoYXZlIGdldCBhdHRyaWJ1dGUsIHNvIHJldHVybiB1bmRlZmluZWQKICAgICAgdmFyIHJldCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5hbWUsIDIpOwogICAgICAvLyBub3JtYWxpemUgbm9uLWV4aXN0aW5nIGF0dHJpYnV0ZXMgdG8gdW5kZWZpbmVkIChhcyBqUXVlcnkpCiAgICAgIHJldHVybiByZXQgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICB9CiAgfSwKCiAgcHJvcDogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGVsZW1lbnRbbmFtZV0gPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBlbGVtZW50W25hbWVdOwogICAgfQogIH0sCgogIHRleHQ6IChmdW5jdGlvbigpIHsKICAgIHZhciBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWSA9IFtdOwogICAgaWYgKG1zaWUgPCA5KSB7CiAgICAgIE5PREVfVFlQRV9URVhUX1BST1BFUlRZWzFdID0gJ2lubmVyVGV4dCc7ICAgIC8qKiBFbGVtZW50ICoqLwogICAgICBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVszXSA9ICdub2RlVmFsdWUnOyAgICAvKiogVGV4dCAqKi8KICAgIH0gZWxzZSB7CiAgICAgIE5PREVfVFlQRV9URVhUX1BST1BFUlRZWzFdID0gICAgICAgICAgICAgICAgIC8qKiBFbGVtZW50ICoqLwogICAgICBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVszXSA9ICd0ZXh0Q29udGVudCc7ICAvKiogVGV4dCAqKi8KICAgIH0KICAgIGdldFRleHQuJGR2ID0gJyc7CiAgICByZXR1cm4gZ2V0VGV4dDsKCiAgICBmdW5jdGlvbiBnZXRUZXh0KGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgIHZhciB0ZXh0UHJvcCA9IE5PREVfVFlQRV9URVhUX1BST1BFUlRZW2VsZW1lbnQubm9kZVR5cGVdOwogICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRleHRQcm9wID8gZWxlbWVudFt0ZXh0UHJvcF0gOiAnJzsKICAgICAgfQogICAgICBlbGVtZW50W3RleHRQcm9wXSA9IHZhbHVlOwogICAgfQogIH0pKCksCgogIHZhbDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgaWYgKG5vZGVOYW1lXyhlbGVtZW50KSA9PT0gJ1NFTEVDVCcgJiYgZWxlbWVudC5tdWx0aXBsZSkgewogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBmb3JFYWNoKGVsZW1lbnQub3B0aW9ucywgZnVuY3Rpb24gKG9wdGlvbikgewogICAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICByZXN1bHQucHVzaChvcHRpb24udmFsdWUgfHwgb3B0aW9uLnRleHQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHQubGVuZ3RoID09PSAwID8gbnVsbCA6IHJlc3VsdDsKICAgICAgfQogICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgIH0KICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICB9LAoKICBodG1sOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUw7CiAgICB9CiAgICBmb3IgKHZhciBpID0gMCwgY2hpbGROb2RlcyA9IGVsZW1lbnQuY2hpbGROb2RlczsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAganFMaXRlRGVhbG9jKGNoaWxkTm9kZXNbaV0pOwogICAgfQogICAgZWxlbWVudC5pbm5lckhUTUwgPSB2YWx1ZTsKICB9LAoKICBlbXB0eToganFMaXRlRW1wdHkKfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogIC8qKgogICAqIFByb3BlcnRpZXM6IHdyaXRlcyByZXR1cm4gc2VsZWN0aW9uLCByZWFkcyByZXR1cm4gZmlyc3QgdmFsdWUKICAgKi8KICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgdmFyIGksIGtleTsKCiAgICAvLyBqcUxpdGVIYXNDbGFzcyBoYXMgb25seSB0d28gYXJndW1lbnRzLCBidXQgaXMgYSBnZXR0ZXItb25seSBmbiwgc28gd2UgbmVlZCB0byBzcGVjaWFsLWNhc2UgaXQKICAgIC8vIGluIGEgd2F5IHRoYXQgc3Vydml2ZXMgbWluaWZpY2F0aW9uLgogICAgLy8ganFMaXRlRW1wdHkgdGFrZXMgbm8gYXJndW1lbnRzIGJ1dCBpcyBhIHNldHRlci4KICAgIGlmIChmbiAhPT0ganFMaXRlRW1wdHkgJiYKICAgICAgICAoKChmbi5sZW5ndGggPT0gMiAmJiAoZm4gIT09IGpxTGl0ZUhhc0NsYXNzICYmIGZuICE9PSBqcUxpdGVDb250cm9sbGVyKSkgPyBhcmcxIDogYXJnMikgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgaWYgKGlzT2JqZWN0KGFyZzEpKSB7CgogICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBidXQgdGhlIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSB0aGUga2V5L3ZhbHVlcwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoZm4gPT09IGpxTGl0ZURhdGEpIHsKICAgICAgICAgICAgLy8gZGF0YSgpIHRha2VzIHRoZSB3aG9sZSBvYmplY3QgaW4galF1ZXJ5CiAgICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChrZXkgaW4gYXJnMSkgewogICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGtleSwgYXJnMVtrZXldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB3ZSBhcmUgYSByZWFkLCBzbyByZWFkIHRoZSBmaXJzdCBjaGlsZC4KICAgICAgICB2YXIgdmFsdWUgPSBmbi4kZHY7CiAgICAgICAgLy8gT25seSBpZiB3ZSBoYXZlICRkdiBkbyB3ZSBpdGVyYXRlIG92ZXIgYWxsLCBvdGhlcndpc2UgaXQgaXMganVzdCB0aGUgZmlyc3QgZWxlbWVudC4KICAgICAgICB2YXIgamogPSAodmFsdWUgPT09IHVuZGVmaW5lZCkgPyBNYXRoLm1pbih0aGlzLmxlbmd0aCwgMSkgOiB0aGlzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgIHZhciBub2RlVmFsdWUgPSBmbih0aGlzW2pdLCBhcmcxLCBhcmcyKTsKICAgICAgICAgIHZhbHVlID0gdmFsdWUgPyB2YWx1ZSArIG5vZGVWYWx1ZSA6IG5vZGVWYWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgc28gYXBwbHkgdG8gYWxsIGNoaWxkcmVuCiAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH07Cn0pOwoKZnVuY3Rpb24gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykgewogIHZhciBldmVudEhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQsIHR5cGUpIHsKICAgIGlmICghZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBmdW5jdGlvbigpIHsKICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvL2llCiAgICAgIH07CiAgICB9CgogICAgaWYgKCFldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICB9OwogICAgfQoKICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICB9CgogICAgaWYgKGlzVW5kZWZpbmVkKGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpKSB7CiAgICAgIHZhciBwcmV2ZW50ID0gZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgcHJldmVudC5jYWxsKGV2ZW50KTsKICAgICAgfTsKICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IGZhbHNlOwogICAgfQoKICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZXZlbnQuZGVmYXVsdFByZXZlbnRlZCB8fCBldmVudC5yZXR1cm5WYWx1ZSA9PT0gZmFsc2U7CiAgICB9OwoKICAgIC8vIENvcHkgZXZlbnQgaGFuZGxlcnMgaW4gY2FzZSBldmVudCBoYW5kbGVycyBhcnJheSBpcyBtb2RpZmllZCBkdXJpbmcgZXhlY3V0aW9uLgogICAgdmFyIGV2ZW50SGFuZGxlcnNDb3B5ID0gc2hhbGxvd0NvcHkoZXZlbnRzW3R5cGUgfHwgZXZlbnQudHlwZV0gfHwgW10pOwoKICAgIGZvckVhY2goZXZlbnRIYW5kbGVyc0NvcHksIGZ1bmN0aW9uKGZuKSB7CiAgICAgIGZuLmNhbGwoZWxlbWVudCwgZXZlbnQpOwogICAgfSk7CgogICAgLy8gUmVtb3ZlIG1vbmtleS1wYXRjaGVkIG1ldGhvZHMgKElFKSwKICAgIC8vIGFzIHRoZXkgd291bGQgY2F1c2UgbWVtb3J5IGxlYWtzIGluIElFOC4KICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgLy8gSUU3LzggZG9lcyBub3QgYWxsb3cgdG8gZGVsZXRlIHByb3BlcnR5IG9uIG5hdGl2ZSBvYmplY3QKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBudWxsOwogICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24gPSBudWxsOwogICAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgLy8gSXQgc2hvdWxkbid0IGFmZmVjdCBub3JtYWwgYnJvd3NlcnMgKG5hdGl2ZSBtZXRob2RzIGFyZSBkZWZpbmVkIG9uIHByb3RvdHlwZSkuCiAgICAgIGRlbGV0ZSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgZGVsZXRlIGV2ZW50LnN0b3BQcm9wYWdhdGlvbjsKICAgICAgZGVsZXRlIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZDsKICAgIH0KICB9OwogIGV2ZW50SGFuZGxlci5lbGVtID0gZWxlbWVudDsKICByZXR1cm4gZXZlbnRIYW5kbGVyOwp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyB0cmF2ZXJzYWwuCi8vIFRoZXNlIGZ1bmN0aW9ucyBjaGFpbiByZXN1bHRzIGludG8gYSBzaW5nbGUKLy8gc2VsZWN0b3IuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwpmb3JFYWNoKHsKICByZW1vdmVEYXRhOiBqcUxpdGVSZW1vdmVEYXRhLAoKICBkZWFsb2M6IGpxTGl0ZURlYWxvYywKCiAgb246IGZ1bmN0aW9uIG9uRm4oZWxlbWVudCwgdHlwZSwgZm4sIHVuc3VwcG9ydGVkKXsKICAgIGlmIChpc0RlZmluZWQodW5zdXBwb3J0ZWQpKSB0aHJvdyBqcUxpdGVNaW5FcnIoJ29uYXJncycsICdqcUxpdGUjb24oKSBkb2VzIG5vdCBzdXBwb3J0IHRoZSBgc2VsZWN0b3JgIG9yIGBldmVudERhdGFgIHBhcmFtZXRlcnMnKTsKCiAgICB2YXIgZXZlbnRzID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgICBoYW5kbGUgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2hhbmRsZScpOwoKICAgIGlmICghZXZlbnRzKSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycsIGV2ZW50cyA9IHt9KTsKICAgIGlmICghaGFuZGxlKSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2hhbmRsZScsIGhhbmRsZSA9IGNyZWF0ZUV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudHMpKTsKCiAgICBmb3JFYWNoKHR5cGUuc3BsaXQoJyAnKSwgZnVuY3Rpb24odHlwZSl7CiAgICAgIHZhciBldmVudEZucyA9IGV2ZW50c1t0eXBlXTsKCiAgICAgIGlmICghZXZlbnRGbnMpIHsKICAgICAgICBpZiAodHlwZSA9PSAnbW91c2VlbnRlcicgfHwgdHlwZSA9PSAnbW91c2VsZWF2ZScpIHsKICAgICAgICAgIHZhciBjb250YWlucyA9IGRvY3VtZW50LmJvZHkuY29udGFpbnMgfHwgZG9jdW1lbnQuYm9keS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/CiAgICAgICAgICBmdW5jdGlvbiggYSwgYiApIHsKICAgICAgICAgICAgLy8ganNoaW50IGJpdHdpc2U6IGZhbHNlCiAgICAgICAgICAgIHZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgPyBhLmRvY3VtZW50RWxlbWVudCA6IGEsCiAgICAgICAgICAgIGJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwogICAgICAgICAgICByZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKICAgICAgICAgICAgICBhZG93bi5jb250YWlucyA/CiAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMoIGJ1cCApIDoKICAgICAgICAgICAgICBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGJ1cCApICYgMTYKICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgfSA6CiAgICAgICAgICAgIGZ1bmN0aW9uKCBhLCBiICkgewogICAgICAgICAgICAgIGlmICggYiApIHsKICAgICAgICAgICAgICAgIHdoaWxlICggKGIgPSBiLnBhcmVudE5vZGUpICkgewogICAgICAgICAgICAgICAgICBpZiAoIGIgPT09IGEgKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwoKICAgICAgICAgIC8vIFJlZmVyIHRvIGpRdWVyeSdzIGltcGxlbWVudGF0aW9uIG9mIG1vdXNlZW50ZXIgJiBtb3VzZWxlYXZlCiAgICAgICAgICAvLyBSZWFkIGFib3V0IG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmU6CiAgICAgICAgICAvLyBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2V2ZW50c19tb3VzZS5odG1sI2xpbms4CiAgICAgICAgICB2YXIgZXZlbnRtYXAgPSB7IG1vdXNlbGVhdmUgOiAibW91c2VvdXQiLCBtb3VzZWVudGVyIDogIm1vdXNlb3ZlciJ9OwoKICAgICAgICAgIG9uRm4oZWxlbWVudCwgZXZlbnRtYXBbdHlwZV0sIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgLy8gRm9yIG1vdXNlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgogICAgICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgICAgICBpZiAoICFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWNvbnRhaW5zKHRhcmdldCwgcmVsYXRlZCkpICl7CiAgICAgICAgICAgICAgaGFuZGxlKGV2ZW50LCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgaGFuZGxlKTsKICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgIH0KICAgICAgICBldmVudEZucyA9IGV2ZW50c1t0eXBlXTsKICAgICAgfQogICAgICBldmVudEZucy5wdXNoKGZuKTsKICAgIH0pOwogIH0sCgogIG9mZjoganFMaXRlT2ZmLAoKICBvbmU6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgIC8vYWRkIHRoZSBsaXN0ZW5lciB0d2ljZSBzbyB0aGF0IHdoZW4gaXQgaXMgY2FsbGVkCiAgICAvL3lvdSBjYW4gcmVtb3ZlIHRoZSBvcmlnaW5hbCBmdW5jdGlvbiBhbmQgc3RpbGwgYmUKICAgIC8vYWJsZSB0byBjYWxsIGVsZW1lbnQub2ZmKGV2LCBmbikgbm9ybWFsbHkKICAgIGVsZW1lbnQub24odHlwZSwgZnVuY3Rpb24gb25GbigpIHsKICAgICAgZWxlbWVudC5vZmYodHlwZSwgZm4pOwogICAgICBlbGVtZW50Lm9mZih0eXBlLCBvbkZuKTsKICAgIH0pOwogICAgZWxlbWVudC5vbih0eXBlLCBmbik7CiAgfSwKCiAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKGVsZW1lbnQsIHJlcGxhY2VOb2RlKSB7CiAgICB2YXIgaW5kZXgsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIGpxTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgIGZvckVhY2gobmV3IEpRTGl0ZShyZXBsYWNlTm9kZSksIGZ1bmN0aW9uKG5vZGUpewogICAgICBpZiAoaW5kZXgpIHsKICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG5vZGUsIGVsZW1lbnQpOwogICAgICB9CiAgICAgIGluZGV4ID0gbm9kZTsKICAgIH0pOwogIH0sCgogIGNoaWxkcmVuOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgIGZvckVhY2goZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDEpCiAgICAgICAgY2hpbGRyZW4ucHVzaChlbGVtZW50KTsKICAgIH0pOwogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0sCgogIGNvbnRlbnRzOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5jb250ZW50RG9jdW1lbnQgfHwgZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOwogIH0sCgogIGFwcGVuZDogZnVuY3Rpb24oZWxlbWVudCwgbm9kZSkgewogICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbihjaGlsZCl7CiAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxIHx8IGVsZW1lbnQubm9kZVR5cGUgPT09IDExKSB7CiAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIHByZXBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKSB7CiAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQuZmlyc3RDaGlsZDsKICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbihjaGlsZCl7CiAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgd3JhcDogZnVuY3Rpb24oZWxlbWVudCwgd3JhcE5vZGUpIHsKICAgIHdyYXBOb2RlID0ganFMaXRlKHdyYXBOb2RlKVswXTsKICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICBpZiAocGFyZW50KSB7CiAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQod3JhcE5vZGUsIGVsZW1lbnQpOwogICAgfQogICAgd3JhcE5vZGUuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgfSwKCiAgcmVtb3ZlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICBqcUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgaWYgKHBhcmVudCkgcGFyZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogIH0sCgogIGFmdGVyOiBmdW5jdGlvbihlbGVtZW50LCBuZXdFbGVtZW50KSB7CiAgICB2YXIgaW5kZXggPSBlbGVtZW50LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICBmb3JFYWNoKG5ldyBKUUxpdGUobmV3RWxlbWVudCksIGZ1bmN0aW9uKG5vZGUpewogICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgaW5kZXggPSBub2RlOwogICAgfSk7CiAgfSwKCiAgYWRkQ2xhc3M6IGpxTGl0ZUFkZENsYXNzLAogIHJlbW92ZUNsYXNzOiBqcUxpdGVSZW1vdmVDbGFzcywKCiAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yLCBjb25kaXRpb24pIHsKICAgIGlmIChzZWxlY3RvcikgewogICAgICBmb3JFYWNoKHNlbGVjdG9yLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGNsYXNzTmFtZSl7CiAgICAgICAgdmFyIGNsYXNzQ29uZGl0aW9uID0gY29uZGl0aW9uOwogICAgICAgIGlmIChpc1VuZGVmaW5lZChjbGFzc0NvbmRpdGlvbikpIHsKICAgICAgICAgIGNsYXNzQ29uZGl0aW9uID0gIWpxTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgfQogICAgICAgIChjbGFzc0NvbmRpdGlvbiA/IGpxTGl0ZUFkZENsYXNzIDoganFMaXRlUmVtb3ZlQ2xhc3MpKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgIH0pOwogICAgfQogIH0sCgogIHBhcmVudDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7CiAgfSwKCiAgbmV4dDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgaWYgKGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nKSB7CiAgICAgIHJldHVybiBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZzsKICAgIH0KCiAgICAvLyBJRTggZG9lc24ndCBoYXZlIG5leHRFbGVtZW50U2libGluZwogICAgdmFyIGVsbSA9IGVsZW1lbnQubmV4dFNpYmxpbmc7CiAgICB3aGlsZSAoZWxtICE9IG51bGwgJiYgZWxtLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgIGVsbSA9IGVsbS5uZXh0U2libGluZzsKICAgIH0KICAgIHJldHVybiBlbG07CiAgfSwKCiAgZmluZDogZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgIGlmIChlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKSB7CiAgICAgIHJldHVybiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICB9LAoKICBjbG9uZToganFMaXRlQ2xvbmUsCgogIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbihlbGVtZW50LCBldmVudE5hbWUsIGV2ZW50RGF0YSkgewogICAgdmFyIGV2ZW50Rm5zID0gKGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJykgfHwge30pW2V2ZW50TmFtZV07CgogICAgZXZlbnREYXRhID0gZXZlbnREYXRhIHx8IFtdOwoKICAgIHZhciBldmVudCA9IFt7CiAgICAgIHByZXZlbnREZWZhdWx0OiBub29wLAogICAgICBzdG9wUHJvcGFnYXRpb246IG5vb3AKICAgIH1dOwoKICAgIGZvckVhY2goZXZlbnRGbnMsIGZ1bmN0aW9uKGZuKSB7CiAgICAgIGZuLmFwcGx5KGVsZW1lbnQsIGV2ZW50LmNvbmNhdChldmVudERhdGEpKTsKICAgIH0pOwogIH0KfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogIC8qKgogICAqIGNoYWluaW5nIGZ1bmN0aW9ucwogICAqLwogIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbihhcmcxLCBhcmcyLCBhcmczKSB7CiAgICB2YXIgdmFsdWU7CiAgICBmb3IodmFyIGk9MDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gZm4odGhpc1tpXSwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIC8vIGFueSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGEgdmFsdWUgbmVlZHMgdG8gYmUgd3JhcHBlZAogICAgICAgICAgdmFsdWUgPSBqcUxpdGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBqcUxpdGVBZGROb2Rlcyh2YWx1ZSwgZm4odGhpc1tpXSwgYXJnMSwgYXJnMiwgYXJnMykpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNEZWZpbmVkKHZhbHVlKSA/IHZhbHVlIDogdGhpczsKICB9OwoKICAvLyBiaW5kIGxlZ2FjeSBiaW5kL3VuYmluZCB0byBvbi9vZmYKICBKUUxpdGUucHJvdG90eXBlLmJpbmQgPSBKUUxpdGUucHJvdG90eXBlLm9uOwogIEpRTGl0ZS5wcm90b3R5cGUudW5iaW5kID0gSlFMaXRlLnByb3RvdHlwZS5vZmY7Cn0pOwoKLyoqCiAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICogSGFzaCBvZiBhOgogKiAgc3RyaW5nIGlzIHN0cmluZwogKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICogIG9iamVjdCBpcyBlaXRoZXIgcmVzdWx0IG9mIGNhbGxpbmcgJCRoYXNoS2V5IGZ1bmN0aW9uIG9uIHRoZSBvYmplY3Qgb3IgdW5pcXVlbHkgZ2VuZXJhdGVkIGlkLAogKiAgICAgICAgIHRoYXQgaXMgYWxzbyBhc3NpZ25lZCB0byB0aGUgJCRoYXNoS2V5IHByb3BlcnR5IG9mIHRoZSBvYmplY3QuCiAqCiAqIEBwYXJhbSBvYmoKICogQHJldHVybnMge3N0cmluZ30gaGFzaCBzdHJpbmcgc3VjaCB0aGF0IHRoZSBzYW1lIGlucHV0IHdpbGwgaGF2ZSB0aGUgc2FtZSBoYXNoIHN0cmluZy4KICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogKi8KZnVuY3Rpb24gaGFzaEtleShvYmopIHsKICB2YXIgb2JqVHlwZSA9IHR5cGVvZiBvYmosCiAgICAgIGtleTsKCiAgaWYgKG9ialR5cGUgPT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsKSB7CiAgICBpZiAodHlwZW9mIChrZXkgPSBvYmouJCRoYXNoS2V5KSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIC8vIG11c3QgaW52b2tlIG9uIG9iamVjdCB0byBrZWVwIHRoZSByaWdodCB0aGlzCiAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgIH0gZWxzZSBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG5leHRVaWQoKTsKICAgIH0KICB9IGVsc2UgewogICAga2V5ID0gb2JqOwogIH0KCiAgcmV0dXJuIG9ialR5cGUgKyAnOicgKyBrZXk7Cn0KCi8qKgogKiBIYXNoTWFwIHdoaWNoIGNhbiB1c2Ugb2JqZWN0cyBhcyBrZXlzCiAqLwpmdW5jdGlvbiBIYXNoTWFwKGFycmF5KXsKICBmb3JFYWNoKGFycmF5LCB0aGlzLnB1dCwgdGhpcyk7Cn0KSGFzaE1hcC5wcm90b3R5cGUgPSB7CiAgLyoqCiAgICogU3RvcmUga2V5IHZhbHVlIHBhaXIKICAgKiBAcGFyYW0ga2V5IGtleSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgKiBAcGFyYW0gdmFsdWUgdmFsdWUgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICovCiAgcHV0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICB0aGlzW2hhc2hLZXkoa2V5KV0gPSB2YWx1ZTsKICB9LAoKICAvKioKICAgKiBAcGFyYW0ga2V5CiAgICogQHJldHVybnMge09iamVjdH0gdGhlIHZhbHVlIGZvciB0aGUga2V5CiAgICovCiAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgIHJldHVybiB0aGlzW2hhc2hLZXkoa2V5KV07CiAgfSwKCiAgLyoqCiAgICogUmVtb3ZlIHRoZSBrZXkvdmFsdWUgcGFpcgogICAqIEBwYXJhbSBrZXkKICAgKi8KICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgewogICAgdmFyIHZhbHVlID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgZGVsZXRlIHRoaXNba2V5XTsKICAgIHJldHVybiB2YWx1ZTsKICB9Cn07CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBtb2R1bGUgbmcKICogQG5hbWUgYW5ndWxhci5pbmplY3RvcgogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlcyBhbiBpbmplY3RvciBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIGZvciByZXRyaWV2aW5nIHNlcnZpY2VzIGFzIHdlbGwgYXMgZm9yCiAqIGRlcGVuZGVuY3kgaW5qZWN0aW9uIChzZWUge0BsaW5rIGd1aWRlL2RpIGRlcGVuZGVuY3kgaW5qZWN0aW9ufSkuCiAqCgogKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBtb2R1bGVzIEEgbGlzdCBvZiBtb2R1bGUgZnVuY3Rpb25zIG9yIHRoZWlyIGFsaWFzZXMuIFNlZQogKiAgICAgICAge0BsaW5rIGFuZ3VsYXIubW9kdWxlfS4gVGhlIGBuZ2AgbW9kdWxlIG11c3QgYmUgZXhwbGljaXRseSBhZGRlZC4KICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEluamVjdG9yIGZ1bmN0aW9uLiBTZWUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAqCiAqIEBleGFtcGxlCiAqIFR5cGljYWwgdXNhZ2UKICogYGBganMKICogICAvLyBjcmVhdGUgYW4gaW5qZWN0b3IKICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJ10pOwogKgogKiAgIC8vIHVzZSB0aGUgaW5qZWN0b3IgdG8ga2ljayBvZmYgeW91ciBhcHBsaWNhdGlvbgogKiAgIC8vIHVzZSB0aGUgdHlwZSBpbmZlcmVuY2UgdG8gYXV0byBpbmplY3QgYXJndW1lbnRzLCBvciB1c2UgaW1wbGljaXQgaW5qZWN0aW9uCiAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGRvY3VtZW50KXsKICogICAgICRjb21waWxlKCRkb2N1bWVudCkoJHJvb3RTY29wZSk7CiAqICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICogICB9KTsKICogYGBgCiAqCiAqIFNvbWV0aW1lcyB5b3Ugd2FudCB0byBnZXQgYWNjZXNzIHRvIHRoZSBpbmplY3RvciBvZiBhIGN1cnJlbnRseSBydW5uaW5nIEFuZ3VsYXIgYXBwCiAqIGZyb20gb3V0c2lkZSBBbmd1bGFyLiBQZXJoYXBzLCB5b3Ugd2FudCB0byBpbmplY3QgYW5kIGNvbXBpbGUgc29tZSBtYXJrdXAgYWZ0ZXIgdGhlCiAqIGFwcGxpY2F0aW9uIGhhcyBiZWVuIGJvb3RzdHJhcHBlZC4gWW91IGNhbiBkbyB0aGlzIHVzaW5nIHRoZSBleHRyYSBgaW5qZWN0b3IoKWAgYWRkZWQKICogdG8gSlF1ZXJ5L2pxTGl0ZSBlbGVtZW50cy4gU2VlIHtAbGluayBhbmd1bGFyLmVsZW1lbnR9LgogKgogKiAqVGhpcyBpcyBmYWlybHkgcmFyZSBidXQgY291bGQgYmUgdGhlIGNhc2UgaWYgYSB0aGlyZCBwYXJ0eSBsaWJyYXJ5IGlzIGluamVjdGluZyB0aGUKICogbWFya3VwLioKICoKICogSW4gdGhlIGZvbGxvd2luZyBleGFtcGxlIGEgbmV3IGJsb2NrIG9mIEhUTUwgY29udGFpbmluZyBhIGBuZy1jb250cm9sbGVyYAogKiBkaXJlY3RpdmUgaXMgYWRkZWQgdG8gdGhlIGVuZCBvZiB0aGUgZG9jdW1lbnQgYm9keSBieSBKUXVlcnkuIFdlIHRoZW4gY29tcGlsZSBhbmQgbGluawogKiBpdCBpbnRvIHRoZSBjdXJyZW50IEFuZ3VsYXJKUyBzY29wZS4KICoKICogYGBganMKICogdmFyICRkaXYgPSAkKCc8ZGl2IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+e3tjb250ZW50LmxhYmVsfX08L2Rpdj4nKTsKICogJChkb2N1bWVudC5ib2R5KS5hcHBlbmQoJGRpdik7CiAqCiAqIGFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuaW5qZWN0b3IoKS5pbnZva2UoZnVuY3Rpb24oJGNvbXBpbGUpIHsKICogICB2YXIgc2NvcGUgPSBhbmd1bGFyLmVsZW1lbnQoJGRpdikuc2NvcGUoKTsKICogICAkY29tcGlsZSgkZGl2KShzY29wZSk7CiAqIH0pOwogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBtb2R1bGUKICogQG5hbWUgYXV0bwogKiBAZGVzY3JpcHRpb24KICoKICogSW1wbGljaXQgbW9kdWxlIHdoaWNoIGdldHMgYXV0b21hdGljYWxseSBhZGRlZCB0byBlYWNoIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LgogKi8KCnZhciBGTl9BUkdTID0gL15mdW5jdGlvblxzKlteXChdKlwoXHMqKFteXCldKilcKS9tOwp2YXIgRk5fQVJHX1NQTElUID0gLywvOwp2YXIgRk5fQVJHID0gL15ccyooXz8pKFxTKz8pXDFccyokLzsKdmFyIFNUUklQX0NPTU1FTlRTID0gLygoXC9cLy4qJCl8KFwvXCpbXHNcU10qP1wqXC8pKS9tZzsKdmFyICRpbmplY3Rvck1pbkVyciA9IG1pbkVycignJGluamVjdG9yJyk7CmZ1bmN0aW9uIGFubm90YXRlKGZuKSB7CiAgdmFyICRpbmplY3QsCiAgICAgIGZuVGV4dCwKICAgICAgYXJnRGVjbCwKICAgICAgbGFzdDsKCiAgaWYgKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSB7CiAgICBpZiAoISgkaW5qZWN0ID0gZm4uJGluamVjdCkpIHsKICAgICAgJGluamVjdCA9IFtdOwogICAgICBpZiAoZm4ubGVuZ3RoKSB7CiAgICAgICAgZm5UZXh0ID0gZm4udG9TdHJpbmcoKS5yZXBsYWNlKFNUUklQX0NPTU1FTlRTLCAnJyk7CiAgICAgICAgYXJnRGVjbCA9IGZuVGV4dC5tYXRjaChGTl9BUkdTKTsKICAgICAgICBmb3JFYWNoKGFyZ0RlY2xbMV0uc3BsaXQoRk5fQVJHX1NQTElUKSwgZnVuY3Rpb24oYXJnKXsKICAgICAgICAgIGFyZy5yZXBsYWNlKEZOX0FSRywgZnVuY3Rpb24oYWxsLCB1bmRlcnNjb3JlLCBuYW1lKXsKICAgICAgICAgICAgJGluamVjdC5wdXNoKG5hbWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZm4uJGluamVjdCA9ICRpbmplY3Q7CiAgICB9CiAgfSBlbHNlIGlmIChpc0FycmF5KGZuKSkgewogICAgbGFzdCA9IGZuLmxlbmd0aCAtIDE7CiAgICBhc3NlcnRBcmdGbihmbltsYXN0XSwgJ2ZuJyk7CiAgICAkaW5qZWN0ID0gZm4uc2xpY2UoMCwgbGFzdCk7CiAgfSBlbHNlIHsKICAgIGFzc2VydEFyZ0ZuKGZuLCAnZm4nLCB0cnVlKTsKICB9CiAgcmV0dXJuICRpbmplY3Q7Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpbmplY3RvcgogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICoKICogYCRpbmplY3RvcmAgaXMgdXNlZCB0byByZXRyaWV2ZSBvYmplY3QgaW5zdGFuY2VzIGFzIGRlZmluZWQgYnkKICoge0BsaW5rIGF1dG8uJHByb3ZpZGUgcHJvdmlkZXJ9LCBpbnN0YW50aWF0ZSB0eXBlcywgaW52b2tlIG1ldGhvZHMsCiAqIGFuZCBsb2FkIG1vZHVsZXMuCiAqCiAqIFRoZSBmb2xsb3dpbmcgYWx3YXlzIGhvbGRzIHRydWU6CiAqCiAqIGBgYGpzCiAqICAgdmFyICRpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoKTsKICogICBleHBlY3QoJGluamVjdG9yLmdldCgnJGluamVjdG9yJykpLnRvQmUoJGluamVjdG9yKTsKICogICBleHBlY3QoJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkaW5qZWN0b3IpewogKiAgICAgcmV0dXJuICRpbmplY3RvcjsKICogICB9KS50b0JlKCRpbmplY3Rvcik7CiAqIGBgYAogKgogKiAjIEluamVjdGlvbiBGdW5jdGlvbiBBbm5vdGF0aW9uCiAqCiAqIEphdmFTY3JpcHQgZG9lcyBub3QgaGF2ZSBhbm5vdGF0aW9ucywgYW5kIGFubm90YXRpb25zIGFyZSBuZWVkZWQgZm9yIGRlcGVuZGVuY3kgaW5qZWN0aW9uLiBUaGUKICogZm9sbG93aW5nIGFyZSBhbGwgdmFsaWQgd2F5cyBvZiBhbm5vdGF0aW5nIGZ1bmN0aW9uIHdpdGggaW5qZWN0aW9uIGFyZ3VtZW50cyBhbmQgYXJlIGVxdWl2YWxlbnQuCiAqCiAqIGBgYGpzCiAqICAgLy8gaW5mZXJyZWQgKG9ubHkgd29ya3MgaWYgY29kZSBub3QgbWluaWZpZWQvb2JmdXNjYXRlZCkKICogICAkaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKHNlcnZpY2VBKXt9KTsKICoKICogICAvLyBhbm5vdGF0ZWQKICogICBmdW5jdGlvbiBleHBsaWNpdChzZXJ2aWNlQSkge307CiAqICAgZXhwbGljaXQuJGluamVjdCA9IFsnc2VydmljZUEnXTsKICogICAkaW5qZWN0b3IuaW52b2tlKGV4cGxpY2l0KTsKICoKICogICAvLyBpbmxpbmUKICogICAkaW5qZWN0b3IuaW52b2tlKFsnc2VydmljZUEnLCBmdW5jdGlvbihzZXJ2aWNlQSl7fV0pOwogKiBgYGAKICoKICogIyMgSW5mZXJlbmNlCiAqCiAqIEluIEphdmFTY3JpcHQgY2FsbGluZyBgdG9TdHJpbmcoKWAgb24gYSBmdW5jdGlvbiByZXR1cm5zIHRoZSBmdW5jdGlvbiBkZWZpbml0aW9uLiBUaGUgZGVmaW5pdGlvbgogKiBjYW4gdGhlbiBiZSBwYXJzZWQgYW5kIHRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY2FuIGJlIGV4dHJhY3RlZC4gKk5PVEU6KiBUaGlzIGRvZXMgbm90IHdvcmsgd2l0aAogKiBtaW5pZmljYXRpb24sIGFuZCBvYmZ1c2NhdGlvbiB0b29scyBzaW5jZSB0aGVzZSB0b29scyBjaGFuZ2UgdGhlIGFyZ3VtZW50IG5hbWVzLgogKgogKiAjIyBgJGluamVjdGAgQW5ub3RhdGlvbgogKiBCeSBhZGRpbmcgYW4gYCRpbmplY3RgIHByb3BlcnR5IG9udG8gYSBmdW5jdGlvbiB0aGUgaW5qZWN0aW9uIHBhcmFtZXRlcnMgY2FuIGJlIHNwZWNpZmllZC4KICoKICogIyMgSW5saW5lCiAqIEFzIGFuIGFycmF5IG9mIGluamVjdGlvbiBuYW1lcywgd2hlcmUgdGhlIGxhc3QgaXRlbSBpbiB0aGUgYXJyYXkgaXMgdGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGluamVjdG9yI2dldAogKgogKiBAZGVzY3JpcHRpb24KICogUmV0dXJuIGFuIGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdG8gcmV0cmlldmUuCiAqIEByZXR1cm4geyp9IFRoZSBpbnN0YW5jZS4KICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkaW5qZWN0b3IjaW52b2tlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBJbnZva2UgdGhlIG1ldGhvZCBhbmQgc3VwcGx5IHRoZSBtZXRob2QgYXJndW1lbnRzIGZyb20gdGhlIGAkaW5qZWN0b3JgLgogKgogKiBAcGFyYW0geyFGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4gRnVuY3Rpb24gcGFyYW1ldGVycyBhcmUgaW5qZWN0ZWQgYWNjb3JkaW5nIHRvIHRoZQogKiAgIHtAbGluayBndWlkZS9kaSAkaW5qZWN0IEFubm90YXRpb259IHJ1bGVzLgogKiBAcGFyYW0ge09iamVjdD19IHNlbGYgVGhlIGB0aGlzYCBmb3IgdGhlIGludm9rZWQgbWV0aG9kLgogKiBAcGFyYW0ge09iamVjdD19IGxvY2FscyBPcHRpb25hbCBvYmplY3QuIElmIHByZXNldCB0aGVuIGFueSBhcmd1bWVudCBuYW1lcyBhcmUgcmVhZCBmcm9tIHRoaXMKICogICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0IGZpcnN0LCBiZWZvcmUgdGhlIGAkaW5qZWN0b3JgIGlzIGNvbnN1bHRlZC4KICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSByZXR1cm5lZCBieSB0aGUgaW52b2tlZCBgZm5gIGZ1bmN0aW9uLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRpbmplY3RvciNoYXMKICoKICogQGRlc2NyaXB0aW9uCiAqIEFsbG93cyB0aGUgdXNlciB0byBxdWVyeSBpZiB0aGUgcGFydGljdWxhciBzZXJ2aWNlIGV4aXN0cy4KICoKICogQHBhcmFtIHtzdHJpbmd9IE5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gcXVlcnkuCiAqIEByZXR1cm5zIHtib29sZWFufSByZXR1cm5zIHRydWUgaWYgaW5qZWN0b3IgaGFzIGdpdmVuIHNlcnZpY2UuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGluamVjdG9yI2luc3RhbnRpYXRlCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgSlMgdHlwZS4gVGhlIG1ldGhvZCB0YWtlcyBhIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpbnZva2VzIHRoZSBuZXcKICogb3BlcmF0b3IsIGFuZCBzdXBwbGllcyBhbGwgb2YgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24gYXMgc3BlY2lmaWVkIGJ5IHRoZQogKiBjb25zdHJ1Y3RvciBhbm5vdGF0aW9uLgogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBUeXBlIEFubm90YXRlZCBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzCiAqIG9iamVjdCBmaXJzdCwgYmVmb3JlIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAqIEByZXR1cm5zIHtPYmplY3R9IG5ldyBpbnN0YW5jZSBvZiBgVHlwZWAuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGluamVjdG9yI2Fubm90YXRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBSZXR1cm5zIGFuIGFycmF5IG9mIHNlcnZpY2UgbmFtZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIHJlcXVlc3RpbmcgZm9yIGluamVjdGlvbi4gVGhpcyBBUEkgaXMKICogdXNlZCBieSB0aGUgaW5qZWN0b3IgdG8gZGV0ZXJtaW5lIHdoaWNoIHNlcnZpY2VzIG5lZWQgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24gd2hlbiB0aGUKICogZnVuY3Rpb24gaXMgaW52b2tlZC4gVGhlcmUgYXJlIHRocmVlIHdheXMgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIGNhbiBiZSBhbm5vdGF0ZWQgd2l0aCB0aGUgbmVlZGVkCiAqIGRlcGVuZGVuY2llcy4KICoKICogIyBBcmd1bWVudCBuYW1lcwogKgogKiBUaGUgc2ltcGxlc3QgZm9ybSBpcyB0byBleHRyYWN0IHRoZSBkZXBlbmRlbmNpZXMgZnJvbSB0aGUgYXJndW1lbnRzIG9mIHRoZSBmdW5jdGlvbi4gVGhpcyBpcyBkb25lCiAqIGJ5IGNvbnZlcnRpbmcgdGhlIGZ1bmN0aW9uIGludG8gYSBzdHJpbmcgdXNpbmcgYHRvU3RyaW5nKClgIG1ldGhvZCBhbmQgZXh0cmFjdGluZyB0aGUgYXJndW1lbnQKICogbmFtZXMuCiAqIGBgYGpzCiAqICAgLy8gR2l2ZW4KICogICBmdW5jdGlvbiBNeUNvbnRyb2xsZXIoJHNjb3BlLCAkcm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICoKICogICAvLyBUaGVuCiAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogKiBgYGAKICoKICogVGhpcyBtZXRob2QgZG9lcyBub3Qgd29yayB3aXRoIGNvZGUgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24uIEZvciB0aGlzIHJlYXNvbiB0aGUgZm9sbG93aW5nCiAqIGFubm90YXRpb24gc3RyYXRlZ2llcyBhcmUgc3VwcG9ydGVkLgogKgogKiAjIFRoZSBgJGluamVjdGAgcHJvcGVydHkKICoKICogSWYgYSBmdW5jdGlvbiBoYXMgYW4gYCRpbmplY3RgIHByb3BlcnR5IGFuZCBpdHMgdmFsdWUgaXMgYW4gYXJyYXkgb2Ygc3RyaW5ncywgdGhlbiB0aGUgc3RyaW5ncwogKiByZXByZXNlbnQgbmFtZXMgb2Ygc2VydmljZXMgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24uCiAqIGBgYGpzCiAqICAgLy8gR2l2ZW4KICogICB2YXIgTXlDb250cm9sbGVyID0gZnVuY3Rpb24ob2JmdXNjYXRlZFNjb3BlLCBvYmZ1c2NhdGVkUm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICogICAvLyBEZWZpbmUgZnVuY3Rpb24gZGVwZW5kZW5jaWVzCiAqICAgTXlDb250cm9sbGVyWyckaW5qZWN0J10gPSBbJyRzY29wZScsICckcm91dGUnXTsKICoKICogICAvLyBUaGVuCiAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogKiBgYGAKICoKICogIyBUaGUgYXJyYXkgbm90YXRpb24KICoKICogSXQgaXMgb2Z0ZW4gZGVzaXJhYmxlIHRvIGlubGluZSBJbmplY3RlZCBmdW5jdGlvbnMgYW5kIHRoYXQncyB3aGVuIHNldHRpbmcgdGhlIGAkaW5qZWN0YCBwcm9wZXJ0eQogKiBpcyB2ZXJ5IGluY29udmVuaWVudC4gSW4gdGhlc2Ugc2l0dWF0aW9ucyB1c2luZyB0aGUgYXJyYXkgbm90YXRpb24gdG8gc3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGluCiAqIGEgd2F5IHRoYXQgc3Vydml2ZXMgbWluaWZpY2F0aW9uIGlzIGEgYmV0dGVyIGNob2ljZToKICoKICogYGBganMKICogICAvLyBXZSB3aXNoIHRvIHdyaXRlIHRoaXMgKG5vdCBtaW5pZmljYXRpb24gLyBvYmZ1c2NhdGlvbiBzYWZlKQogKiAgIGluamVjdG9yLmludm9rZShmdW5jdGlvbigkY29tcGlsZSwgJHJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfSk7CiAqCiAqICAgLy8gV2UgYXJlIGZvcmNlZCB0byB3cml0ZSBicmVhayBpbmxpbmluZwogKiAgIHZhciB0bXBGbiA9IGZ1bmN0aW9uKG9iZnVzY2F0ZWRDb21waWxlLCBvYmZ1c2NhdGVkUm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9OwogKiAgIHRtcEZuLiRpbmplY3QgPSBbJyRjb21waWxlJywgJyRyb290U2NvcGUnXTsKICogICBpbmplY3Rvci5pbnZva2UodG1wRm4pOwogKgogKiAgIC8vIFRvIGJldHRlciBzdXBwb3J0IGlubGluZSBmdW5jdGlvbiB0aGUgaW5saW5lIGFubm90YXRpb24gaXMgc3VwcG9ydGVkCiAqICAgaW5qZWN0b3IuaW52b2tlKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZkNvbXBpbGUsIG9iZlJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfV0pOwogKgogKiAgIC8vIFRoZXJlZm9yZQogKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZSgKICogICAgICBbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZ1c18kY29tcGlsZSwgb2JmdXNfJHJvb3RTY29wZSkge31dKQogKiAgICApLnRvRXF1YWwoWyckY29tcGlsZScsICckcm9vdFNjb3BlJ10pOwogKiBgYGAKICoKICogQHBhcmFtIHtGdW5jdGlvbnxBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gZm4gRnVuY3Rpb24gZm9yIHdoaWNoIGRlcGVuZGVudCBzZXJ2aWNlIG5hbWVzIG5lZWQgdG8KICogYmUgcmV0cmlldmVkIGFzIGRlc2NyaWJlZCBhYm92ZS4KICoKICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBUaGUgbmFtZXMgb2YgdGhlIHNlcnZpY2VzIHdoaWNoIHRoZSBmdW5jdGlvbiByZXF1aXJlcy4KICovCgoKCgovKioKICogQG5nZG9jIG9iamVjdAogKiBAbmFtZSAkcHJvdmlkZQogKgogKiBAZGVzY3JpcHRpb24KICoKICogVGhlIHtAbGluayBhdXRvLiRwcm92aWRlICRwcm92aWRlfSBzZXJ2aWNlIGhhcyBhIG51bWJlciBvZiBtZXRob2RzIGZvciByZWdpc3RlcmluZyBjb21wb25lbnRzCiAqIHdpdGggdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBNYW55IG9mIHRoZXNlIGZ1bmN0aW9ucyBhcmUgYWxzbyBleHBvc2VkIG9uCiAqIHtAbGluayBhbmd1bGFyLk1vZHVsZX0uCiAqCiAqIEFuIEFuZ3VsYXIgKipzZXJ2aWNlKiogaXMgYSBzaW5nbGV0b24gb2JqZWN0IGNyZWF0ZWQgYnkgYSAqKnNlcnZpY2UgZmFjdG9yeSoqLiAgVGhlc2UgKipzZXJ2aWNlCiAqIGZhY3RvcmllcyoqIGFyZSBmdW5jdGlvbnMgd2hpY2gsIGluIHR1cm4sIGFyZSBjcmVhdGVkIGJ5IGEgKipzZXJ2aWNlIHByb3ZpZGVyKiouCiAqIFRoZSAqKnNlcnZpY2UgcHJvdmlkZXJzKiogYXJlIGNvbnN0cnVjdG9yIGZ1bmN0aW9ucy4gV2hlbiBpbnN0YW50aWF0ZWQgdGhleSBtdXN0IGNvbnRhaW4gYQogKiBwcm9wZXJ0eSBjYWxsZWQgYCRnZXRgLCB3aGljaCBob2xkcyB0aGUgKipzZXJ2aWNlIGZhY3RvcnkqKiBmdW5jdGlvbi4KICoKICogV2hlbiB5b3UgcmVxdWVzdCBhIHNlcnZpY2UsIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfSBpcyByZXNwb25zaWJsZSBmb3IgZmluZGluZyB0aGUKICogY29ycmVjdCAqKnNlcnZpY2UgcHJvdmlkZXIqKiwgaW5zdGFudGlhdGluZyBpdCBhbmQgdGhlbiBjYWxsaW5nIGl0cyBgJGdldGAgKipzZXJ2aWNlIGZhY3RvcnkqKgogKiBmdW5jdGlvbiB0byBnZXQgdGhlIGluc3RhbmNlIG9mIHRoZSAqKnNlcnZpY2UqKi4KICoKICogT2Z0ZW4gc2VydmljZXMgaGF2ZSBubyBjb25maWd1cmF0aW9uIG9wdGlvbnMgYW5kIHRoZXJlIGlzIG5vIG5lZWQgdG8gYWRkIG1ldGhvZHMgdG8gdGhlIHNlcnZpY2UKICogcHJvdmlkZXIuICBUaGUgcHJvdmlkZXIgd2lsbCBiZSBubyBtb3JlIHRoYW4gYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB3aXRoIGEgYCRnZXRgIHByb3BlcnR5LiBGb3IKICogdGhlc2UgY2FzZXMgdGhlIHtAbGluayBhdXRvLiRwcm92aWRlICRwcm92aWRlfSBzZXJ2aWNlIGhhcyBhZGRpdGlvbmFsIGhlbHBlciBtZXRob2RzIHRvIHJlZ2lzdGVyCiAqIHNlcnZpY2VzIHdpdGhvdXQgc3BlY2lmeWluZyBhIHByb3ZpZGVyLgogKgogKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI3Byb3ZpZGVyIHByb3ZpZGVyKHByb3ZpZGVyKX0gLSByZWdpc3RlcnMgYSAqKnNlcnZpY2UgcHJvdmlkZXIqKiB3aXRoIHRoZQogKiAgICAge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0KICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNjb25zdGFudCBjb25zdGFudChvYmopfSAtIHJlZ2lzdGVycyBhIHZhbHVlL29iamVjdCB0aGF0IGNhbiBiZSBhY2Nlc3NlZCBieQogKiAgICAgcHJvdmlkZXJzIGFuZCBzZXJ2aWNlcy4KICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSN2YWx1ZSB2YWx1ZShvYmopfSAtIHJlZ2lzdGVycyBhIHZhbHVlL29iamVjdCB0aGF0IGNhbiBvbmx5IGJlIGFjY2Vzc2VkIGJ5CiAqICAgICBzZXJ2aWNlcywgbm90IHByb3ZpZGVycy4KICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNmYWN0b3J5IGZhY3RvcnkoZm4pfSAtIHJlZ2lzdGVycyBhIHNlcnZpY2UgKipmYWN0b3J5IGZ1bmN0aW9uKiosIGBmbmAsCiAqICAgICB0aGF0IHdpbGwgYmUgd3JhcHBlZCBpbiBhICoqc2VydmljZSBwcm92aWRlcioqIG9iamVjdCwgd2hvc2UgYCRnZXRgIHByb3BlcnR5IHdpbGwgY29udGFpbiB0aGUKICogICAgIGdpdmVuIGZhY3RvcnkgZnVuY3Rpb24uCiAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjc2VydmljZSBzZXJ2aWNlKGNsYXNzKX0gLSByZWdpc3RlcnMgYSAqKmNvbnN0cnVjdG9yIGZ1bmN0aW9uKiosIGBjbGFzc2AKICogICAgIHRoYXQgd2lsbCBiZSB3cmFwcGVkIGluIGEgKipzZXJ2aWNlIHByb3ZpZGVyKiogb2JqZWN0LCB3aG9zZSBgJGdldGAgcHJvcGVydHkgd2lsbCBpbnN0YW50aWF0ZQogKiAgICAgIGEgbmV3IG9iamVjdCB1c2luZyB0aGUgZ2l2ZW4gY29uc3RydWN0b3IgZnVuY3Rpb24uCiAqCiAqIFNlZSB0aGUgaW5kaXZpZHVhbCBtZXRob2RzIGZvciBtb3JlIGluZm9ybWF0aW9uIGFuZCBleGFtcGxlcy4KICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSNwcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICoKICogUmVnaXN0ZXIgYSAqKnByb3ZpZGVyIGZ1bmN0aW9uKiogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uIFByb3ZpZGVyIGZ1bmN0aW9ucwogKiBhcmUgY29uc3RydWN0b3IgZnVuY3Rpb25zLCB3aG9zZSBpbnN0YW5jZXMgYXJlIHJlc3BvbnNpYmxlIGZvciAicHJvdmlkaW5nIiBhIGZhY3RvcnkgZm9yIGEKICogc2VydmljZS4KICoKICogU2VydmljZSBwcm92aWRlciBuYW1lcyBzdGFydCB3aXRoIHRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNlIHRoZXkgcHJvdmlkZSBmb2xsb3dlZCBieSBgUHJvdmlkZXJgLgogKiBGb3IgZXhhbXBsZSwgdGhlIHtAbGluayBuZy4kbG9nICRsb2d9IHNlcnZpY2UgaGFzIGEgcHJvdmlkZXIgY2FsbGVkCiAqIHtAbGluayBuZy4kbG9nUHJvdmlkZXIgJGxvZ1Byb3ZpZGVyfS4KICoKICogU2VydmljZSBwcm92aWRlciBvYmplY3RzIGNhbiBoYXZlIGFkZGl0aW9uYWwgbWV0aG9kcyB3aGljaCBhbGxvdyBjb25maWd1cmF0aW9uIG9mIHRoZSBwcm92aWRlcgogKiBhbmQgaXRzIHNlcnZpY2UuIEltcG9ydGFudGx5LCB5b3UgY2FuIGNvbmZpZ3VyZSB3aGF0IGtpbmQgb2Ygc2VydmljZSBpcyBjcmVhdGVkIGJ5IHRoZSBgJGdldGAKICogbWV0aG9kLCBvciBob3cgdGhhdCBzZXJ2aWNlIHdpbGwgYWN0LiBGb3IgZXhhbXBsZSwgdGhlIHtAbGluayBuZy4kbG9nUHJvdmlkZXIgJGxvZ1Byb3ZpZGVyfSBoYXMgYQogKiBtZXRob2Qge0BsaW5rIG5nLiRsb2dQcm92aWRlciNkZWJ1Z0VuYWJsZWQgZGVidWdFbmFibGVkfQogKiB3aGljaCBsZXRzIHlvdSBzcGVjaWZ5IHdoZXRoZXIgdGhlIHtAbGluayBuZy4kbG9nICRsb2d9IHNlcnZpY2Ugd2lsbCBsb2cgZGVidWcgbWVzc2FnZXMgdG8gdGhlCiAqIGNvbnNvbGUgb3Igbm90LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuIE5PVEU6IHRoZSBwcm92aWRlciB3aWxsIGJlIGF2YWlsYWJsZSB1bmRlciBgbmFtZSArCiAgICAgICAgICAgICAgICAgICAgICAgICdQcm92aWRlcidgIGtleS4KICogQHBhcmFtIHsoT2JqZWN0fGZ1bmN0aW9uKCkpfSBwcm92aWRlciBJZiB0aGUgcHJvdmlkZXIgaXM6CiAqCiAqICAgLSBgT2JqZWN0YDogdGhlbiBpdCBzaG91bGQgaGF2ZSBhIGAkZ2V0YCBtZXRob2QuIFRoZSBgJGdldGAgbWV0aG9kIHdpbGwgYmUgaW52b2tlZCB1c2luZwogKiAgICAge0BsaW5rIGF1dG8uJGluamVjdG9yI2ludm9rZSAkaW5qZWN0b3IuaW52b2tlKCl9IHdoZW4gYW4gaW5zdGFuY2UgbmVlZHMgdG8gYmUgY3JlYXRlZC4KICogICAtIGBDb25zdHJ1Y3RvcmA6IGEgbmV3IGluc3RhbmNlIG9mIHRoZSBwcm92aWRlciB3aWxsIGJlIGNyZWF0ZWQgdXNpbmcKICogICAgIHtAbGluayBhdXRvLiRpbmplY3RvciNpbnN0YW50aWF0ZSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoKX0sIHRoZW4gdHJlYXRlZCBhcyBgb2JqZWN0YC4KICoKICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQoKICogQGV4YW1wbGUKICoKICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGhvdyB0byBjcmVhdGUgYSBzaW1wbGUgZXZlbnQgdHJhY2tpbmcgc2VydmljZSBhbmQgcmVnaXN0ZXIgaXQgdXNpbmcKICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjcHJvdmlkZXIgJHByb3ZpZGUucHJvdmlkZXIoKX0uCiAqCiAqIGBgYGpzCiAqICAvLyBEZWZpbmUgdGhlIGV2ZW50VHJhY2tlciBwcm92aWRlcgogKiAgZnVuY3Rpb24gRXZlbnRUcmFja2VyUHJvdmlkZXIoKSB7CiAqICAgIHZhciB0cmFja2luZ1VybCA9ICcvdHJhY2snOwogKgogKiAgICAvLyBBIHByb3ZpZGVyIG1ldGhvZCBmb3IgY29uZmlndXJpbmcgd2hlcmUgdGhlIHRyYWNrZWQgZXZlbnRzIHNob3VsZCBiZWVuIHNhdmVkCiAqICAgIHRoaXMuc2V0VHJhY2tpbmdVcmwgPSBmdW5jdGlvbih1cmwpIHsKICogICAgICB0cmFja2luZ1VybCA9IHVybDsKICogICAgfTsKICoKICogICAgLy8gVGhlIHNlcnZpY2UgZmFjdG9yeSBmdW5jdGlvbgogKiAgICB0aGlzLiRnZXQgPSBbJyRodHRwJywgZnVuY3Rpb24oJGh0dHApIHsKICogICAgICB2YXIgdHJhY2tlZEV2ZW50cyA9IHt9OwogKiAgICAgIHJldHVybiB7CiAqICAgICAgICAvLyBDYWxsIHRoaXMgdG8gdHJhY2sgYW4gZXZlbnQKICogICAgICAgIGV2ZW50OiBmdW5jdGlvbihldmVudCkgewogKiAgICAgICAgICB2YXIgY291bnQgPSB0cmFja2VkRXZlbnRzW2V2ZW50XSB8fCAwOwogKiAgICAgICAgICBjb3VudCArPSAxOwogKiAgICAgICAgICB0cmFja2VkRXZlbnRzW2V2ZW50XSA9IGNvdW50OwogKiAgICAgICAgICByZXR1cm4gY291bnQ7CiAqICAgICAgICB9LAogKiAgICAgICAgLy8gQ2FsbCB0aGlzIHRvIHNhdmUgdGhlIHRyYWNrZWQgZXZlbnRzIHRvIHRoZSB0cmFja2luZ1VybAogKiAgICAgICAgc2F2ZTogZnVuY3Rpb24oKSB7CiAqICAgICAgICAgICRodHRwLnBvc3QodHJhY2tpbmdVcmwsIHRyYWNrZWRFdmVudHMpOwogKiAgICAgICAgfQogKiAgICAgIH07CiAqICAgIH1dOwogKiAgfQogKgogKiAgZGVzY3JpYmUoJ2V2ZW50VHJhY2tlcicsIGZ1bmN0aW9uKCkgewogKiAgICB2YXIgcG9zdFNweTsKICoKICogICAgYmVmb3JlRWFjaChtb2R1bGUoZnVuY3Rpb24oJHByb3ZpZGUpIHsKICogICAgICAvLyBSZWdpc3RlciB0aGUgZXZlbnRUcmFja2VyIHByb3ZpZGVyCiAqICAgICAgJHByb3ZpZGUucHJvdmlkZXIoJ2V2ZW50VHJhY2tlcicsIEV2ZW50VHJhY2tlclByb3ZpZGVyKTsKICogICAgfSkpOwogKgogKiAgICBiZWZvcmVFYWNoKG1vZHVsZShmdW5jdGlvbihldmVudFRyYWNrZXJQcm92aWRlcikgewogKiAgICAgIC8vIENvbmZpZ3VyZSBldmVudFRyYWNrZXIgcHJvdmlkZXIKICogICAgICBldmVudFRyYWNrZXJQcm92aWRlci5zZXRUcmFja2luZ1VybCgnL2N1c3RvbS10cmFjaycpOwogKiAgICB9KSk7CiAqCiAqICAgIGl0KCd0cmFja3MgZXZlbnRzJywgaW5qZWN0KGZ1bmN0aW9uKGV2ZW50VHJhY2tlcikgewogKiAgICAgIGV4cGVjdChldmVudFRyYWNrZXIuZXZlbnQoJ2xvZ2luJykpLnRvRXF1YWwoMSk7CiAqICAgICAgZXhwZWN0KGV2ZW50VHJhY2tlci5ldmVudCgnbG9naW4nKSkudG9FcXVhbCgyKTsKICogICAgfSkpOwogKgogKiAgICBpdCgnc2F2ZXMgdG8gdGhlIHRyYWNraW5nIHVybCcsIGluamVjdChmdW5jdGlvbihldmVudFRyYWNrZXIsICRodHRwKSB7CiAqICAgICAgcG9zdFNweSA9IHNweU9uKCRodHRwLCAncG9zdCcpOwogKiAgICAgIGV2ZW50VHJhY2tlci5ldmVudCgnbG9naW4nKTsKICogICAgICBldmVudFRyYWNrZXIuc2F2ZSgpOwogKiAgICAgIGV4cGVjdChwb3N0U3B5KS50b0hhdmVCZWVuQ2FsbGVkKCk7CiAqICAgICAgZXhwZWN0KHBvc3RTcHkubW9zdFJlY2VudENhbGwuYXJnc1swXSkubm90LnRvRXF1YWwoJy90cmFjaycpOwogKiAgICAgIGV4cGVjdChwb3N0U3B5Lm1vc3RSZWNlbnRDYWxsLmFyZ3NbMF0pLnRvRXF1YWwoJy9jdXN0b20tdHJhY2snKTsKICogICAgICBleHBlY3QocG9zdFNweS5tb3N0UmVjZW50Q2FsbC5hcmdzWzFdKS50b0VxdWFsKHsgJ2xvZ2luJzogMSB9KTsKICogICAgfSkpOwogKiAgfSk7CiAqIGBgYAogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRwcm92aWRlI2ZhY3RvcnkKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlZ2lzdGVyIGEgKipzZXJ2aWNlIGZhY3RvcnkqKiwgd2hpY2ggd2lsbCBiZSBjYWxsZWQgdG8gcmV0dXJuIHRoZSBzZXJ2aWNlIGluc3RhbmNlLgogKiBUaGlzIGlzIHNob3J0IGZvciByZWdpc3RlcmluZyBhIHNlcnZpY2Ugd2hlcmUgaXRzIHByb3ZpZGVyIGNvbnNpc3RzIG9mIG9ubHkgYSBgJGdldGAgcHJvcGVydHksCiAqIHdoaWNoIGlzIHRoZSBnaXZlbiBzZXJ2aWNlIGZhY3RvcnkgZnVuY3Rpb24uCiAqIFlvdSBzaG91bGQgdXNlIHtAbGluayBhdXRvLiRwcm92aWRlI2ZhY3RvcnkgJHByb3ZpZGUuZmFjdG9yeShnZXRGbil9IGlmIHlvdSBkbyBub3QgbmVlZCB0bwogKiBjb25maWd1cmUgeW91ciBzZXJ2aWNlIGluIGEgcHJvdmlkZXIuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICogQHBhcmFtIHtmdW5jdGlvbigpfSAkZ2V0Rm4gVGhlICRnZXRGbiBmb3IgdGhlIGluc3RhbmNlIGNyZWF0aW9uLiBJbnRlcm5hbGx5IHRoaXMgaXMgYSBzaG9ydCBoYW5kCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBgJHByb3ZpZGUucHJvdmlkZXIobmFtZSwgeyRnZXQ6ICRnZXRGbn0pYC4KICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogKgogKiBAZXhhbXBsZQogKiBIZXJlIGlzIGFuIGV4YW1wbGUgb2YgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlCiAqIGBgYGpzCiAqICAgJHByb3ZpZGUuZmFjdG9yeSgncGluZycsIFsnJGh0dHAnLCBmdW5jdGlvbigkaHR0cCkgewogKiAgICAgcmV0dXJuIGZ1bmN0aW9uIHBpbmcoKSB7CiAqICAgICAgIHJldHVybiAkaHR0cC5zZW5kKCcvcGluZycpOwogKiAgICAgfTsKICogICB9XSk7CiAqIGBgYAogKiBZb3Ugd291bGQgdGhlbiBpbmplY3QgYW5kIHVzZSB0aGlzIHNlcnZpY2UgbGlrZSB0aGlzOgogKiBgYGBqcwogKiAgIHNvbWVNb2R1bGUuY29udHJvbGxlcignQ3RybCcsIFsncGluZycsIGZ1bmN0aW9uKHBpbmcpIHsKICogICAgIHBpbmcoKTsKICogICB9XSk7CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSNzZXJ2aWNlCiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWdpc3RlciBhICoqc2VydmljZSBjb25zdHJ1Y3RvcioqLCB3aGljaCB3aWxsIGJlIGludm9rZWQgd2l0aCBgbmV3YCB0byBjcmVhdGUgdGhlIHNlcnZpY2UKICogaW5zdGFuY2UuCiAqIFRoaXMgaXMgc2hvcnQgZm9yIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB3aGVyZSBpdHMgcHJvdmlkZXIncyBgJGdldGAgcHJvcGVydHkgaXMgdGhlIHNlcnZpY2UKICogY29uc3RydWN0b3IgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gaW5zdGFudGlhdGUgdGhlIHNlcnZpY2UgaW5zdGFuY2UuCiAqCiAqIFlvdSBzaG91bGQgdXNlIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZShjbGFzcyl9IGlmIHlvdSBkZWZpbmUgeW91ciBzZXJ2aWNlCiAqIGFzIGEgdHlwZS9jbGFzcy4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25zdHJ1Y3RvciBBIGNsYXNzIChjb25zdHJ1Y3RvciBmdW5jdGlvbikgdGhhdCB3aWxsIGJlIGluc3RhbnRpYXRlZC4KICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogKgogKiBAZXhhbXBsZQogKiBIZXJlIGlzIGFuIGV4YW1wbGUgb2YgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlIHVzaW5nCiAqIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZShjbGFzcyl9LgogKiBgYGBqcwogKiAgIHZhciBQaW5nID0gZnVuY3Rpb24oJGh0dHApIHsKICogICAgIHRoaXMuJGh0dHAgPSAkaHR0cDsKICogICB9OwogKgogKiAgIFBpbmcuJGluamVjdCA9IFsnJGh0dHAnXTsKICoKICogICBQaW5nLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24oKSB7CiAqICAgICByZXR1cm4gdGhpcy4kaHR0cC5nZXQoJy9waW5nJyk7CiAqICAgfTsKICogICAkcHJvdmlkZS5zZXJ2aWNlKCdwaW5nJywgUGluZyk7CiAqIGBgYAogKiBZb3Ugd291bGQgdGhlbiBpbmplY3QgYW5kIHVzZSB0aGlzIHNlcnZpY2UgbGlrZSB0aGlzOgogKiBgYGBqcwogKiAgIHNvbWVNb2R1bGUuY29udHJvbGxlcignQ3RybCcsIFsncGluZycsIGZ1bmN0aW9uKHBpbmcpIHsKICogICAgIHBpbmcuc2VuZCgpOwogKiAgIH1dKTsKICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRwcm92aWRlI3ZhbHVlCiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWdpc3RlciBhICoqdmFsdWUgc2VydmljZSoqIHdpdGggdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LCBzdWNoIGFzIGEgc3RyaW5nLCBhCiAqIG51bWJlciwgYW4gYXJyYXksIGFuIG9iamVjdCBvciBhIGZ1bmN0aW9uLiAgVGhpcyBpcyBzaG9ydCBmb3IgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlIHdoZXJlIGl0cwogKiBwcm92aWRlcidzIGAkZ2V0YCBwcm9wZXJ0eSBpcyBhIGZhY3RvcnkgZnVuY3Rpb24gdGhhdCB0YWtlcyBubyBhcmd1bWVudHMgYW5kIHJldHVybnMgdGhlICoqdmFsdWUKICogc2VydmljZSoqLgogKgogKiBWYWx1ZSBzZXJ2aWNlcyBhcmUgc2ltaWxhciB0byBjb25zdGFudCBzZXJ2aWNlcywgZXhjZXB0IHRoYXQgdGhleSBjYW5ub3QgYmUgaW5qZWN0ZWQgaW50byBhCiAqIG1vZHVsZSBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIChzZWUge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZ30pIGJ1dCB0aGV5IGNhbiBiZSBvdmVycmlkZGVuIGJ5CiAqIGFuIEFuZ3VsYXIKICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjZGVjb3JhdG9yIGRlY29yYXRvcn0uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUuCiAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICoKICogQGV4YW1wbGUKICogSGVyZSBhcmUgc29tZSBleGFtcGxlcyBvZiBjcmVhdGluZyB2YWx1ZSBzZXJ2aWNlcy4KICogYGBganMKICogICAkcHJvdmlkZS52YWx1ZSgnQURNSU5fVVNFUicsICdhZG1pbicpOwogKgogKiAgICRwcm92aWRlLnZhbHVlKCdSb2xlTG9va3VwJywgeyBhZG1pbjogMCwgd3JpdGVyOiAxLCByZWFkZXI6IDIgfSk7CiAqCiAqICAgJHByb3ZpZGUudmFsdWUoJ2hhbGZPZicsIGZ1bmN0aW9uKHZhbHVlKSB7CiAqICAgICByZXR1cm4gdmFsdWUgLyAyOwogKiAgIH0pOwogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHByb3ZpZGUjY29uc3RhbnQKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlZ2lzdGVyIGEgKipjb25zdGFudCBzZXJ2aWNlKiosIHN1Y2ggYXMgYSBzdHJpbmcsIGEgbnVtYmVyLCBhbiBhcnJheSwgYW4gb2JqZWN0IG9yIGEgZnVuY3Rpb24sCiAqIHdpdGggdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBVbmxpa2Uge0BsaW5rIGF1dG8uJHByb3ZpZGUjdmFsdWUgdmFsdWV9IGl0IGNhbiBiZQogKiBpbmplY3RlZCBpbnRvIGEgbW9kdWxlIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gKHNlZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGUjY29uZmlnfSkgYW5kIGl0IGNhbm5vdAogKiBiZSBvdmVycmlkZGVuIGJ5IGFuIEFuZ3VsYXIge0BsaW5rIGF1dG8uJHByb3ZpZGUjZGVjb3JhdG9yIGRlY29yYXRvcn0uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBjb25zdGFudC4KICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgY29uc3RhbnQgdmFsdWUuCiAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgaW5zdGFuY2UKICoKICogQGV4YW1wbGUKICogSGVyZSBhIHNvbWUgZXhhbXBsZXMgb2YgY3JlYXRpbmcgY29uc3RhbnRzOgogKiBgYGBqcwogKiAgICRwcm92aWRlLmNvbnN0YW50KCdTSEFSRF9IRUlHSFQnLCAzMDYpOwogKgogKiAgICRwcm92aWRlLmNvbnN0YW50KCdNWV9DT0xPVVJTJywgWydyZWQnLCAnYmx1ZScsICdncmV5J10pOwogKgogKiAgICRwcm92aWRlLmNvbnN0YW50KCdkb3VibGUnLCBmdW5jdGlvbih2YWx1ZSkgewogKiAgICAgcmV0dXJuIHZhbHVlICogMjsKICogICB9KTsKICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRwcm92aWRlI2RlY29yYXRvcgogKiBAZGVzY3JpcHRpb24KICoKICogUmVnaXN0ZXIgYSAqKnNlcnZpY2UgZGVjb3JhdG9yKiogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uIEEgc2VydmljZSBkZWNvcmF0b3IKICogaW50ZXJjZXB0cyB0aGUgY3JlYXRpb24gb2YgYSBzZXJ2aWNlLCBhbGxvd2luZyBpdCB0byBvdmVycmlkZSBvciBtb2RpZnkgdGhlIGJlaGF2aW91ciBvZiB0aGUKICogc2VydmljZS4gVGhlIG9iamVjdCByZXR1cm5lZCBieSB0aGUgZGVjb3JhdG9yIG1heSBiZSB0aGUgb3JpZ2luYWwgc2VydmljZSwgb3IgYSBuZXcgc2VydmljZQogKiBvYmplY3Qgd2hpY2ggcmVwbGFjZXMgb3Igd3JhcHMgYW5kIGRlbGVnYXRlcyB0byB0aGUgb3JpZ2luYWwgc2VydmljZS4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gZGVjb3JhdGUuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZGVjb3JhdG9yIFRoaXMgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIHdoZW4gdGhlIHNlcnZpY2UgbmVlZHMgdG8gYmUKICogICAgaW5zdGFudGlhdGVkIGFuZCBzaG91bGQgcmV0dXJuIHRoZSBkZWNvcmF0ZWQgc2VydmljZSBpbnN0YW5jZS4gVGhlIGZ1bmN0aW9uIGlzIGNhbGxlZCB1c2luZwogKiAgICB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yI2ludm9rZSBpbmplY3Rvci5pbnZva2V9IG1ldGhvZCBhbmQgaXMgdGhlcmVmb3JlIGZ1bGx5IGluamVjdGFibGUuCiAqICAgIExvY2FsIGluamVjdGlvbiBhcmd1bWVudHM6CiAqCiAqICAgICogYCRkZWxlZ2F0ZWAgLSBUaGUgb3JpZ2luYWwgc2VydmljZSBpbnN0YW5jZSwgd2hpY2ggY2FuIGJlIG1vbmtleSBwYXRjaGVkLCBjb25maWd1cmVkLAogKiAgICAgIGRlY29yYXRlZCBvciBkZWxlZ2F0ZWQgdG8uCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUgd2UgZGVjb3JhdGUgdGhlIHtAbGluayBuZy4kbG9nICRsb2d9IHNlcnZpY2UgdG8gY29udmVydCB3YXJuaW5ncyB0byBlcnJvcnMgYnkgaW50ZXJjZXB0aW5nCiAqIGNhbGxzIHRvIHtAbGluayBuZy4kbG9nI2Vycm9yICRsb2cud2FybigpfS4KICogYGBganMKICogICAkcHJvdmlkZS5kZWNvcmF0b3IoJyRsb2cnLCBbJyRkZWxlZ2F0ZScsIGZ1bmN0aW9uKCRkZWxlZ2F0ZSkgewogKiAgICAgJGRlbGVnYXRlLndhcm4gPSAkZGVsZWdhdGUuZXJyb3I7CiAqICAgICByZXR1cm4gJGRlbGVnYXRlOwogKiAgIH1dKTsKICogYGBgCiAqLwoKCmZ1bmN0aW9uIGNyZWF0ZUluamVjdG9yKG1vZHVsZXNUb0xvYWQpIHsKICB2YXIgSU5TVEFOVElBVElORyA9IHt9LAogICAgICBwcm92aWRlclN1ZmZpeCA9ICdQcm92aWRlcicsCiAgICAgIHBhdGggPSBbXSwKICAgICAgbG9hZGVkTW9kdWxlcyA9IG5ldyBIYXNoTWFwKCksCiAgICAgIHByb3ZpZGVyQ2FjaGUgPSB7CiAgICAgICAgJHByb3ZpZGU6IHsKICAgICAgICAgICAgcHJvdmlkZXI6IHN1cHBvcnRPYmplY3QocHJvdmlkZXIpLAogICAgICAgICAgICBmYWN0b3J5OiBzdXBwb3J0T2JqZWN0KGZhY3RvcnkpLAogICAgICAgICAgICBzZXJ2aWNlOiBzdXBwb3J0T2JqZWN0KHNlcnZpY2UpLAogICAgICAgICAgICB2YWx1ZTogc3VwcG9ydE9iamVjdCh2YWx1ZSksCiAgICAgICAgICAgIGNvbnN0YW50OiBzdXBwb3J0T2JqZWN0KGNvbnN0YW50KSwKICAgICAgICAgICAgZGVjb3JhdG9yOiBkZWNvcmF0b3IKICAgICAgICAgIH0KICAgICAgfSwKICAgICAgcHJvdmlkZXJJbmplY3RvciA9IChwcm92aWRlckNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKHByb3ZpZGVyQ2FjaGUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ3VucHInLCAiVW5rbm93biBwcm92aWRlcjogezB9IiwgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgfSkpLAogICAgICBpbnN0YW5jZUNhY2hlID0ge30sCiAgICAgIGluc3RhbmNlSW5qZWN0b3IgPSAoaW5zdGFuY2VDYWNoZS4kaW5qZWN0b3IgPQogICAgICAgICAgY3JlYXRlSW50ZXJuYWxJbmplY3RvcihpbnN0YW5jZUNhY2hlLCBmdW5jdGlvbihzZXJ2aWNlbmFtZSkgewogICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlbmFtZSArIHByb3ZpZGVyU3VmZml4KTsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKHByb3ZpZGVyLiRnZXQsIHByb3ZpZGVyKTsKICAgICAgICAgIH0pKTsKCgogIGZvckVhY2gobG9hZE1vZHVsZXMobW9kdWxlc1RvTG9hZCksIGZ1bmN0aW9uKGZuKSB7IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGZuIHx8IG5vb3ApOyB9KTsKCiAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3I7CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vICRwcm92aWRlcgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICBmdW5jdGlvbiBzdXBwb3J0T2JqZWN0KGRlbGVnYXRlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICBpZiAoaXNPYmplY3Qoa2V5KSkgewogICAgICAgIGZvckVhY2goa2V5LCByZXZlcnNlUGFyYW1zKGRlbGVnYXRlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRlbGVnYXRlKGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gcHJvdmlkZXIobmFtZSwgcHJvdmlkZXJfKSB7CiAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnc2VydmljZScpOwogICAgaWYgKGlzRnVuY3Rpb24ocHJvdmlkZXJfKSB8fCBpc0FycmF5KHByb3ZpZGVyXykpIHsKICAgICAgcHJvdmlkZXJfID0gcHJvdmlkZXJJbmplY3Rvci5pbnN0YW50aWF0ZShwcm92aWRlcl8pOwogICAgfQogICAgaWYgKCFwcm92aWRlcl8uJGdldCkgewogICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ3BnZXQnLCAiUHJvdmlkZXIgJ3swfScgbXVzdCBkZWZpbmUgJGdldCBmYWN0b3J5IG1ldGhvZC4iLCBuYW1lKTsKICAgIH0KICAgIHJldHVybiBwcm92aWRlckNhY2hlW25hbWUgKyBwcm92aWRlclN1ZmZpeF0gPSBwcm92aWRlcl87CiAgfQoKICBmdW5jdGlvbiBmYWN0b3J5KG5hbWUsIGZhY3RvcnlGbikgeyByZXR1cm4gcHJvdmlkZXIobmFtZSwgeyAkZ2V0OiBmYWN0b3J5Rm4gfSk7IH0KCiAgZnVuY3Rpb24gc2VydmljZShuYW1lLCBjb25zdHJ1Y3RvcikgewogICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgWyckaW5qZWN0b3InLCBmdW5jdGlvbigkaW5qZWN0b3IpIHsKICAgICAgcmV0dXJuICRpbmplY3Rvci5pbnN0YW50aWF0ZShjb25zdHJ1Y3Rvcik7CiAgICB9XSk7CiAgfQoKICBmdW5jdGlvbiB2YWx1ZShuYW1lLCB2YWwpIHsgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWVGbih2YWwpKTsgfQoKICBmdW5jdGlvbiBjb25zdGFudChuYW1lLCB2YWx1ZSkgewogICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ2NvbnN0YW50Jyk7CiAgICBwcm92aWRlckNhY2hlW25hbWVdID0gdmFsdWU7CiAgICBpbnN0YW5jZUNhY2hlW25hbWVdID0gdmFsdWU7CiAgfQoKICBmdW5jdGlvbiBkZWNvcmF0b3Ioc2VydmljZU5hbWUsIGRlY29yRm4pIHsKICAgIHZhciBvcmlnUHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlTmFtZSArIHByb3ZpZGVyU3VmZml4KSwKICAgICAgICBvcmlnJGdldCA9IG9yaWdQcm92aWRlci4kZ2V0OwoKICAgIG9yaWdQcm92aWRlci4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcmlnSW5zdGFuY2UgPSBpbnN0YW5jZUluamVjdG9yLmludm9rZShvcmlnJGdldCwgb3JpZ1Byb3ZpZGVyKTsKICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHskZGVsZWdhdGU6IG9yaWdJbnN0YW5jZX0pOwogICAgfTsKICB9CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vIE1vZHVsZSBMb2FkaW5nCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgZnVuY3Rpb24gbG9hZE1vZHVsZXMobW9kdWxlc1RvTG9hZCl7CiAgICB2YXIgcnVuQmxvY2tzID0gW10sIG1vZHVsZUZuLCBpbnZva2VRdWV1ZSwgaSwgaWk7CiAgICBmb3JFYWNoKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICBpZiAobG9hZGVkTW9kdWxlcy5nZXQobW9kdWxlKSkgcmV0dXJuOwogICAgICBsb2FkZWRNb2R1bGVzLnB1dChtb2R1bGUsIHRydWUpOwoKICAgICAgdHJ5IHsKICAgICAgICBpZiAoaXNTdHJpbmcobW9kdWxlKSkgewogICAgICAgICAgbW9kdWxlRm4gPSBhbmd1bGFyTW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICBydW5CbG9ja3MgPSBydW5CbG9ja3MuY29uY2F0KGxvYWRNb2R1bGVzKG1vZHVsZUZuLnJlcXVpcmVzKSkuY29uY2F0KG1vZHVsZUZuLl9ydW5CbG9ja3MpOwoKICAgICAgICAgIGZvcihpbnZva2VRdWV1ZSA9IG1vZHVsZUZuLl9pbnZva2VRdWV1ZSwgaSA9IDAsIGlpID0gaW52b2tlUXVldWUubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICB2YXIgaW52b2tlQXJncyA9IGludm9rZVF1ZXVlW2ldLAogICAgICAgICAgICAgICAgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgIHByb3ZpZGVyW2ludm9rZUFyZ3NbMV1dLmFwcGx5KHByb3ZpZGVyLCBpbnZva2VBcmdzWzJdKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXNzZXJ0QXJnRm4obW9kdWxlLCAnbW9kdWxlJyk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgbW9kdWxlID0gbW9kdWxlW21vZHVsZS5sZW5ndGggLSAxXTsKICAgICAgICB9CiAgICAgICAgaWYgKGUubWVzc2FnZSAmJiBlLnN0YWNrICYmIGUuc3RhY2suaW5kZXhPZihlLm1lc3NhZ2UpID09IC0xKSB7CiAgICAgICAgICAvLyBTYWZhcmkgJiBGRidzIHN0YWNrIHRyYWNlcyBkb24ndCBjb250YWluIGVycm9yLm1lc3NhZ2UgY29udGVudAogICAgICAgICAgLy8gdW5saWtlIHRob3NlIG9mIENocm9tZSBhbmQgSUUKICAgICAgICAgIC8vIFNvIGlmIHN0YWNrIGRvZXNuJ3QgY29udGFpbiBtZXNzYWdlLCB3ZSBjcmVhdGUgYSBuZXcgc3RyaW5nIHRoYXQgY29udGFpbnMgYm90aC4KICAgICAgICAgIC8vIFNpbmNlIGVycm9yLnN0YWNrIGlzIHJlYWQtb25seSBpbiBTYWZhcmksIEknbSBvdmVycmlkaW5nIGUgYW5kIG5vdCBlLnN0YWNrIGhlcmUuCiAgICAgICAgICAvKiBqc2hpbnQgLVcwMjIgKi8KICAgICAgICAgIGUgPSBlLm1lc3NhZ2UgKyAnXG4nICsgZS5zdGFjazsKICAgICAgICB9CiAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCdtb2R1bGVycicsICJGYWlsZWQgdG8gaW5zdGFudGlhdGUgbW9kdWxlIHswfSBkdWUgdG86XG57MX0iLAogICAgICAgICAgICAgICAgICBtb2R1bGUsIGUuc3RhY2sgfHwgZS5tZXNzYWdlIHx8IGUpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBydW5CbG9ja3M7CiAgfQoKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBpbnRlcm5hbCBJbmplY3RvcgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgZnVuY3Rpb24gZ2V0U2VydmljZShzZXJ2aWNlTmFtZSkgewogICAgICBpZiAoY2FjaGUuaGFzT3duUHJvcGVydHkoc2VydmljZU5hbWUpKSB7CiAgICAgICAgaWYgKGNhY2hlW3NlcnZpY2VOYW1lXSA9PT0gSU5TVEFOVElBVElORykgewogICAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCdjZGVwJywgJ0NpcmN1bGFyIGRlcGVuZGVuY3kgZm91bmQ6IHswfScsIHBhdGguam9pbignIDwtICcpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlW3NlcnZpY2VOYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0cnkgewogICAgICAgICAgcGF0aC51bnNoaWZ0KHNlcnZpY2VOYW1lKTsKICAgICAgICAgIGNhY2hlW3NlcnZpY2VOYW1lXSA9IElOU1RBTlRJQVRJTkc7CiAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICAgIGRlbGV0ZSBjYWNoZVtzZXJ2aWNlTmFtZV07CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIHBhdGguc2hpZnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2UoZm4sIHNlbGYsIGxvY2Fscyl7CiAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAkaW5qZWN0ID0gYW5ub3RhdGUoZm4pLAogICAgICAgICAgbGVuZ3RoLCBpLAogICAgICAgICAga2V5OwoKICAgICAgZm9yKGkgPSAwLCBsZW5ndGggPSAkaW5qZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAga2V5ID0gJGluamVjdFtpXTsKICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignaXRrbicsCiAgICAgICAgICAgICAgICAgICdJbmNvcnJlY3QgaW5qZWN0aW9uIHRva2VuISBFeHBlY3RlZCBzZXJ2aWNlIG5hbWUgYXMgc3RyaW5nLCBnb3QgezB9Jywga2V5KTsKICAgICAgICB9CiAgICAgICAgYXJncy5wdXNoKAogICAgICAgICAgbG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkpCiAgICAgICAgICA/IGxvY2Fsc1trZXldCiAgICAgICAgICA6IGdldFNlcnZpY2Uoa2V5KQogICAgICAgICk7CiAgICAgIH0KICAgICAgaWYgKCFmbi4kaW5qZWN0KSB7CiAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHdlIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgZm4gPSBmbltsZW5ndGhdOwogICAgICB9CgogICAgICAvLyBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtaW52b2tlLWFwcGx5LXZzLXN3aXRjaAogICAgICAvLyAjNTM4OAogICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoVHlwZSwgbG9jYWxzKSB7CiAgICAgIHZhciBDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICBpbnN0YW5jZSwgcmV0dXJuZWRWYWx1ZTsKCiAgICAgIC8vIENoZWNrIGlmIFR5cGUgaXMgYW5ub3RhdGVkIGFuZCB1c2UganVzdCB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXQgbi0xIGFzIHBhcmFtZXRlcgogICAgICAvLyBlLmcuIHNvbWVNb2R1bGUuZmFjdG9yeSgnZ3JlZXRlcicsIFsnJHdpbmRvdycsIGZ1bmN0aW9uKHJlbmFtZWQkd2luZG93KSB7fV0pOwogICAgICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAoaXNBcnJheShUeXBlKSA/IFR5cGVbVHlwZS5sZW5ndGggLSAxXSA6IFR5cGUpLnByb3RvdHlwZTsKICAgICAgaW5zdGFuY2UgPSBuZXcgQ29uc3RydWN0b3IoKTsKICAgICAgcmV0dXJuZWRWYWx1ZSA9IGludm9rZShUeXBlLCBpbnN0YW5jZSwgbG9jYWxzKTsKCiAgICAgIHJldHVybiBpc09iamVjdChyZXR1cm5lZFZhbHVlKSB8fCBpc0Z1bmN0aW9uKHJldHVybmVkVmFsdWUpID8gcmV0dXJuZWRWYWx1ZSA6IGluc3RhbmNlOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGludm9rZTogaW52b2tlLAogICAgICBpbnN0YW50aWF0ZTogaW5zdGFudGlhdGUsCiAgICAgIGdldDogZ2V0U2VydmljZSwKICAgICAgYW5ub3RhdGU6IGFubm90YXRlLAogICAgICBoYXM6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICByZXR1cm4gcHJvdmlkZXJDYWNoZS5oYXNPd25Qcm9wZXJ0eShuYW1lICsgcHJvdmlkZXJTdWZmaXgpIHx8IGNhY2hlLmhhc093blByb3BlcnR5KG5hbWUpOwogICAgICB9CiAgICB9OwogIH0KfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRhbmNob3JTY3JvbGwKICogQGtpbmQgZnVuY3Rpb24KICogQHJlcXVpcmVzICR3aW5kb3cKICogQHJlcXVpcmVzICRsb2NhdGlvbgogKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogKgogKiBAZGVzY3JpcHRpb24KICogV2hlbiBjYWxsZWQsIGl0IGNoZWNrcyBjdXJyZW50IHZhbHVlIG9mIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xscyB0byB0aGUgcmVsYXRlZCBlbGVtZW50LAogKiBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAqIFtIdG1sNSBzcGVjXShodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdGhlLWluZGljYXRlZC1wYXJ0LW9mLXRoZS1kb2N1bWVudCkuCiAqCiAqIEl0IGFsc28gd2F0Y2hlcyB0aGUgYCRsb2NhdGlvbi5oYXNoKClgIGFuZCBzY3JvbGxzIHdoZW5ldmVyIGl0IGNoYW5nZXMgdG8gbWF0Y2ggYW55IGFuY2hvci4KICogVGhpcyBjYW4gYmUgZGlzYWJsZWQgYnkgY2FsbGluZyBgJGFuY2hvclNjcm9sbFByb3ZpZGVyLmRpc2FibGVBdXRvU2Nyb2xsaW5nKClgLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgaWQ9InNjcm9sbEFyZWEiIG5nLWNvbnRyb2xsZXI9IlNjcm9sbEN0cmwiPgogICAgICAgICA8YSBuZy1jbGljaz0iZ290b0JvdHRvbSgpIj5HbyB0byBib3R0b208L2E+CiAgICAgICAgIDxhIGlkPSJib3R0b20iPjwvYT4gWW91J3JlIGF0IHRoZSBib3R0b20hCiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgIGZ1bmN0aW9uIFNjcm9sbEN0cmwoJHNjb3BlLCAkbG9jYXRpb24sICRhbmNob3JTY3JvbGwpIHsKICAgICAgICAgJHNjb3BlLmdvdG9Cb3R0b20gPSBmdW5jdGlvbiAoKXsKICAgICAgICAgICAvLyBzZXQgdGhlIGxvY2F0aW9uLmhhc2ggdG8gdGhlIGlkIG9mCiAgICAgICAgICAgLy8gdGhlIGVsZW1lbnQgeW91IHdpc2ggdG8gc2Nyb2xsIHRvLgogICAgICAgICAgICRsb2NhdGlvbi5oYXNoKCdib3R0b20nKTsKCiAgICAgICAgICAgLy8gY2FsbCAkYW5jaG9yU2Nyb2xsKCkKICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgIH07CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAjc2Nyb2xsQXJlYSB7CiAgICAgICAgIGhlaWdodDogMzUwcHg7CiAgICAgICAgIG92ZXJmbG93OiBhdXRvOwogICAgICAgfQoKICAgICAgICNib3R0b20gewogICAgICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgICAgbWFyZ2luLXRvcDogMjAwMHB4OwogICAgICAgfQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gJEFuY2hvclNjcm9sbFByb3ZpZGVyKCkgewoKICB2YXIgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSB0cnVlOwoKICB0aGlzLmRpc2FibGVBdXRvU2Nyb2xsaW5nID0gZnVuY3Rpb24oKSB7CiAgICBhdXRvU2Nyb2xsaW5nRW5hYmxlZCA9IGZhbHNlOwogIH07CgogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9jYXRpb24nLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKCR3aW5kb3csICRsb2NhdGlvbiwgJHJvb3RTY29wZSkgewogICAgdmFyIGRvY3VtZW50ID0gJHdpbmRvdy5kb2N1bWVudDsKCiAgICAvLyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGZpcnN0IGFuY2hvciBmcm9tIGEgTm9kZUxpc3QKICAgIC8vIGNhbid0IHVzZSBmaWx0ZXIuZmlsdGVyLCBhcyBpdCBhY2NlcHRzIG9ubHkgaW5zdGFuY2VzIG9mIEFycmF5CiAgICAvLyBhbmQgSUUgY2FuJ3QgY29udmVydCBOb2RlTGlzdCB0byBhbiBhcnJheSB1c2luZyBbXS5zbGljZQogICAgLy8gVE9ETyh2b2p0YSk6IHVzZSBmaWx0ZXIgaWYgd2UgY2hhbmdlIGl0IHRvIGFjY2VwdCBsaXN0cyBhcyB3ZWxsCiAgICBmdW5jdGlvbiBnZXRGaXJzdEFuY2hvcihsaXN0KSB7CiAgICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgICBmb3JFYWNoKGxpc3QsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICBpZiAoIXJlc3VsdCAmJiBsb3dlcmNhc2UoZWxlbWVudC5ub2RlTmFtZSkgPT09ICdhJykgcmVzdWx0ID0gZWxlbWVudDsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gc2Nyb2xsKCkgewogICAgICB2YXIgaGFzaCA9ICRsb2NhdGlvbi5oYXNoKCksIGVsbTsKCiAgICAgIC8vIGVtcHR5IGhhc2gsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgIGlmICghaGFzaCkgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKCiAgICAgIC8vIGVsZW1lbnQgd2l0aCBnaXZlbiBpZAogICAgICBlbHNlIGlmICgoZWxtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFzaCkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgIC8vIGZpcnN0IGFuY2hvciB3aXRoIGdpdmVuIG5hbWUgOi1ECiAgICAgIGVsc2UgaWYgKChlbG0gPSBnZXRGaXJzdEFuY2hvcihkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZShoYXNoKSkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgIC8vIG5vIGVsZW1lbnQgYW5kIGhhc2ggPT0gJ3RvcCcsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgIGVsc2UgaWYgKGhhc2ggPT09ICd0b3AnKSAkd2luZG93LnNjcm9sbFRvKDAsIDApOwogICAgfQoKICAgIC8vIGRvZXMgbm90IHNjcm9sbCB3aGVuIHVzZXIgY2xpY2tzIG9uIGFuY2hvciBsaW5rIHRoYXQgaXMgY3VycmVudGx5IG9uCiAgICAvLyAobm8gdXJsIGNoYW5nZSwgbm8gJGxvY2F0aW9uLmhhc2goKSBjaGFuZ2UpLCBicm93c2VyIG5hdGl2ZSBkb2VzIHNjcm9sbAogICAgaWYgKGF1dG9TY3JvbGxpbmdFbmFibGVkKSB7CiAgICAgICRyb290U2NvcGUuJHdhdGNoKGZ1bmN0aW9uIGF1dG9TY3JvbGxXYXRjaCgpIHtyZXR1cm4gJGxvY2F0aW9uLmhhc2goKTt9LAogICAgICAgIGZ1bmN0aW9uIGF1dG9TY3JvbGxXYXRjaEFjdGlvbigpIHsKICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhzY3JvbGwpOwogICAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiBzY3JvbGw7CiAgfV07Cn0KCnZhciAkYW5pbWF0ZU1pbkVyciA9IG1pbkVycignJGFuaW1hdGUnKTsKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGFuaW1hdGVQcm92aWRlcgogKgogKiBAZGVzY3JpcHRpb24KICogRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiAkYW5pbWF0ZSB0aGF0IGRvZXNuJ3QgcGVyZm9ybSBhbnkgYW5pbWF0aW9ucywgaW5zdGVhZCBqdXN0CiAqIHN5bmNocm9ub3VzbHkgcGVyZm9ybXMgRE9NCiAqIHVwZGF0ZXMgYW5kIGNhbGxzIGRvbmUoKSBjYWxsYmFja3MuCiAqCiAqIEluIG9yZGVyIHRvIGVuYWJsZSBhbmltYXRpb25zIHRoZSBuZ0FuaW1hdGUgbW9kdWxlIGhhcyB0byBiZSBsb2FkZWQuCiAqCiAqIFRvIHNlZSB0aGUgZnVuY3Rpb25hbCBpbXBsZW1lbnRhdGlvbiBjaGVjayBvdXQgc3JjL25nQW5pbWF0ZS9hbmltYXRlLmpzCiAqLwp2YXIgJEFuaW1hdGVQcm92aWRlciA9IFsnJHByb3ZpZGUnLCBmdW5jdGlvbigkcHJvdmlkZSkgewoKCiAgdGhpcy4kJHNlbGVjdG9ycyA9IHt9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRhbmltYXRlUHJvdmlkZXIjcmVnaXN0ZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVycyBhIG5ldyBpbmplY3RhYmxlIGFuaW1hdGlvbiBmYWN0b3J5IGZ1bmN0aW9uLiBUaGUgZmFjdG9yeSBmdW5jdGlvbiBwcm9kdWNlcyB0aGUKICAgKiBhbmltYXRpb24gb2JqZWN0IHdoaWNoIGNvbnRhaW5zIGNhbGxiYWNrIGZ1bmN0aW9ucyBmb3IgZWFjaCBldmVudCB0aGF0IGlzIGV4cGVjdGVkIHRvIGJlCiAgICogYW5pbWF0ZWQuCiAgICoKICAgKiAgICogYGV2ZW50Rm5gOiBgZnVuY3Rpb24oRWxlbWVudCwgZG9uZUZ1bmN0aW9uKWAgVGhlIGVsZW1lbnQgdG8gYW5pbWF0ZSwgdGhlIGBkb25lRnVuY3Rpb25gCiAgICogICBtdXN0IGJlIGNhbGxlZCBvbmNlIHRoZSBlbGVtZW50IGFuaW1hdGlvbiBpcyBjb21wbGV0ZS4gSWYgYSBmdW5jdGlvbiBpcyByZXR1cm5lZCB0aGVuIHRoZQogICAqICAgYW5pbWF0aW9uIHNlcnZpY2Ugd2lsbCB1c2UgdGhpcyBmdW5jdGlvbiB0byBjYW5jZWwgdGhlIGFuaW1hdGlvbiB3aGVuZXZlciBhIGNhbmNlbCBldmVudCBpcwogICAqICAgdHJpZ2dlcmVkLgogICAqCiAgICoKICAgKiBgYGBqcwogICAqICAgcmV0dXJuIHsKICAgICAqICAgICBldmVudEZuIDogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogICAgICogICAgICAgLy9jb2RlIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgKiAgICAgICAvL29uY2UgY29tcGxldGUsIHRoZW4gcnVuIGRvbmUoKQogICAgICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNhbmNlbGxhdGlvbkZ1bmN0aW9uKCkgewogICAgICogICAgICAgICAvL2NvZGUgdG8gY2FuY2VsIHRoZSBhbmltYXRpb24KICAgICAqICAgICAgIH0KICAgICAqICAgICB9CiAgICAgKiAgIH0KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24uCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmFjdG9yeSBUaGUgZmFjdG9yeSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgdG8gcmV0dXJuIHRoZSBhbmltYXRpb24KICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC4KICAgKi8KICB0aGlzLnJlZ2lzdGVyID0gZnVuY3Rpb24obmFtZSwgZmFjdG9yeSkgewogICAgdmFyIGtleSA9IG5hbWUgKyAnLWFuaW1hdGlvbic7CiAgICBpZiAobmFtZSAmJiBuYW1lLmNoYXJBdCgwKSAhPSAnLicpIHRocm93ICRhbmltYXRlTWluRXJyKCdub3Rjc2VsJywKICAgICAgICAiRXhwZWN0aW5nIGNsYXNzIHNlbGVjdG9yIHN0YXJ0aW5nIHdpdGggJy4nIGdvdCAnezB9Jy4iLCBuYW1lKTsKICAgIHRoaXMuJCRzZWxlY3RvcnNbbmFtZS5zdWJzdHIoMSldID0ga2V5OwogICAgJHByb3ZpZGUuZmFjdG9yeShrZXksIGZhY3RvcnkpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyI2NsYXNzTmFtZUZpbHRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyBhbmQvb3IgcmV0dXJucyB0aGUgQ1NTIGNsYXNzIHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIGNoZWNrZWQgd2hlbiBwZXJmb3JtaW5nCiAgICogYW4gYW5pbWF0aW9uLiBVcG9uIGJvb3RzdHJhcCB0aGUgY2xhc3NOYW1lRmlsdGVyIHZhbHVlIGlzIG5vdCBzZXQgYXQgYWxsIGFuZCB3aWxsCiAgICogdGhlcmVmb3JlIGVuYWJsZSAkYW5pbWF0ZSB0byBhdHRlbXB0IHRvIHBlcmZvcm0gYW4gYW5pbWF0aW9uIG9uIGFueSBlbGVtZW50LgogICAqIFdoZW4gc2V0dGluZyB0aGUgY2xhc3NOYW1lRmlsdGVyIHZhbHVlLCBhbmltYXRpb25zIHdpbGwgb25seSBiZSBwZXJmb3JtZWQgb24gZWxlbWVudHMKICAgKiB0aGF0IHN1Y2Nlc3NmdWxseSBtYXRjaCB0aGUgZmlsdGVyIGV4cHJlc3Npb24uIFRoaXMgaW4gdHVybiBjYW4gYm9vc3QgcGVyZm9ybWFuY2UKICAgKiBmb3IgbG93LXBvd2VyZWQgZGV2aWNlcyBhcyB3ZWxsIGFzIGFwcGxpY2F0aW9ucyBjb250YWluaW5nIGEgbG90IG9mIHN0cnVjdHVyYWwgb3BlcmF0aW9ucy4KICAgKiBAcGFyYW0ge1JlZ0V4cD19IGV4cHJlc3Npb24gVGhlIGNsYXNzTmFtZSBleHByZXNzaW9uIHdoaWNoIHdpbGwgYmUgY2hlY2tlZCBhZ2FpbnN0IGFsbCBhbmltYXRpb25zCiAgICogQHJldHVybiB7UmVnRXhwfSBUaGUgY3VycmVudCBDU1MgY2xhc3NOYW1lIGV4cHJlc3Npb24gdmFsdWUuIElmIG51bGwgdGhlbiB0aGVyZSBpcyBubyBleHByZXNzaW9uIHZhbHVlCiAgICovCiAgdGhpcy5jbGFzc05hbWVGaWx0ZXIgPSBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIHRoaXMuJCRjbGFzc05hbWVGaWx0ZXIgPSAoZXhwcmVzc2lvbiBpbnN0YW5jZW9mIFJlZ0V4cCkgPyBleHByZXNzaW9uIDogbnVsbDsKICAgIH0KICAgIHJldHVybiB0aGlzLiQkY2xhc3NOYW1lRmlsdGVyOwogIH07CgogIHRoaXMuJGdldCA9IFsnJHRpbWVvdXQnLCAnJCRhc3luY0NhbGxiYWNrJywgZnVuY3Rpb24oJHRpbWVvdXQsICQkYXN5bmNDYWxsYmFjaykgewoKICAgIGZ1bmN0aW9uIGFzeW5jKGZuKSB7CiAgICAgIGZuICYmICQkYXN5bmNDYWxsYmFjayhmbik7CiAgICB9CgogICAgLyoqCiAgICAgKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBuYW1lICRhbmltYXRlCiAgICAgKiBAZGVzY3JpcHRpb24gVGhlICRhbmltYXRlIHNlcnZpY2UgcHJvdmlkZXMgcnVkaW1lbnRhcnkgRE9NIG1hbmlwdWxhdGlvbiBmdW5jdGlvbnMgdG8KICAgICAqIGluc2VydCwgcmVtb3ZlIGFuZCBtb3ZlIGVsZW1lbnRzIHdpdGhpbiB0aGUgRE9NLCBhcyB3ZWxsIGFzIGFkZGluZyBhbmQgcmVtb3ZpbmcgY2xhc3Nlcy4KICAgICAqIFRoaXMgc2VydmljZSBpcyB0aGUgY29yZSBzZXJ2aWNlIHVzZWQgYnkgdGhlIG5nQW5pbWF0ZSAkYW5pbWF0b3Igc2VydmljZSB3aGljaCBwcm92aWRlcwogICAgICogaGlnaC1sZXZlbCBhbmltYXRpb24gaG9va3MgZm9yIENTUyBhbmQgSmF2YVNjcmlwdC4KICAgICAqCiAgICAgKiAkYW5pbWF0ZSBpcyBhdmFpbGFibGUgaW4gdGhlIEFuZ3VsYXJKUyBjb3JlLCBob3dldmVyLCB0aGUgbmdBbmltYXRlIG1vZHVsZSBtdXN0IGJlIGluY2x1ZGVkCiAgICAgKiB0byBlbmFibGUgZnVsbCBvdXQgYW5pbWF0aW9uIHN1cHBvcnQuIE90aGVyd2lzZSwgJGFuaW1hdGUgd2lsbCBvbmx5IHBlcmZvcm0gc2ltcGxlIERPTQogICAgICogbWFuaXB1bGF0aW9uIG9wZXJhdGlvbnMuCiAgICAgKgogICAgICogVG8gbGVhcm4gbW9yZSBhYm91dCBlbmFibGluZyBhbmltYXRpb24gc3VwcG9ydCwgY2xpY2sgaGVyZSB0byB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZQogICAgICogbmdBbmltYXRlIG1vZHVsZSBwYWdlfSBhcyB3ZWxsIGFzIHRoZSB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlIG5nQW5pbWF0ZSAkYW5pbWF0ZSBzZXJ2aWNlCiAgICAgKiBwYWdlfS4KICAgICAqLwogICAgcmV0dXJuIHsKCiAgICAgIC8qKgogICAgICAgKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRhbmltYXRlI2VudGVyCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqIEBkZXNjcmlwdGlvbiBJbnNlcnRzIHRoZSBlbGVtZW50IGludG8gdGhlIERPTSBlaXRoZXIgYWZ0ZXIgdGhlIGBhZnRlcmAgZWxlbWVudCBvciB3aXRoaW4KICAgICAgICogICB0aGUgYHBhcmVudGAgZWxlbWVudC4gT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGJlIGluc2VydGVkIGludG8gdGhlIERPTQogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHBhcmVudCB0aGUgcGFyZW50IGVsZW1lbnQgd2hpY2ggd2lsbCBhcHBlbmQgdGhlIGVsZW1lbnQgYXMKICAgICAgICogICBhIGNoaWxkIChpZiB0aGUgYWZ0ZXIgZWxlbWVudCBpcyBub3QgcHJlc2VudCkKICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlciB0aGUgc2libGluZyBlbGVtZW50IHdoaWNoIHdpbGwgYXBwZW5kIHRoZSBlbGVtZW50CiAgICAgICAqICAgYWZ0ZXIgaXRzZWxmCiAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb249fSBkb25lIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGVsZW1lbnQgaGFzIGJlZW4KICAgICAgICogICBpbnNlcnRlZCBpbnRvIHRoZSBET00KICAgICAgICovCiAgICAgIGVudGVyIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSkgewogICAgICAgIGlmIChhZnRlcikgewogICAgICAgICAgYWZ0ZXIuYWZ0ZXIoZWxlbWVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghcGFyZW50IHx8ICFwYXJlbnRbMF0pIHsKICAgICAgICAgICAgcGFyZW50ID0gYWZ0ZXIucGFyZW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJlbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgICBhc3luYyhkb25lKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRhbmltYXRlI2xlYXZlCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmVzIHRoZSBlbGVtZW50IGZyb20gdGhlIERPTS4gT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlCiAgICAgICAqICAgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBET00KICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBhZnRlciB0aGUgZWxlbWVudCBoYXMgYmVlbgogICAgICAgKiAgIHJlbW92ZWQgZnJvbSB0aGUgRE9NCiAgICAgICAqLwogICAgICBsZWF2ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsKICAgICAgICBlbGVtZW50LnJlbW92ZSgpOwogICAgICAgIGFzeW5jKGRvbmUpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjbW92ZQogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gTW92ZXMgdGhlIHBvc2l0aW9uIG9mIHRoZSBwcm92aWRlZCBlbGVtZW50IHdpdGhpbiB0aGUgRE9NIHRvIGJlIHBsYWNlZAogICAgICAgKiBlaXRoZXIgYWZ0ZXIgdGhlIGBhZnRlcmAgZWxlbWVudCBvciBpbnNpZGUgb2YgdGhlIGBwYXJlbnRgIGVsZW1lbnQuIE9uY2UgY29tcGxldGUsIHRoZQogICAgICAgKiBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBiZSBtb3ZlZCBhcm91bmQgd2l0aGluIHRoZQogICAgICAgKiAgIERPTQogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHBhcmVudCB0aGUgcGFyZW50IGVsZW1lbnQgd2hlcmUgdGhlIGVsZW1lbnQgd2lsbCBiZQogICAgICAgKiAgIGluc2VydGVkIGludG8gKGlmIHRoZSBhZnRlciBlbGVtZW50IGlzIG5vdCBwcmVzZW50KQogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGFmdGVyIHRoZSBzaWJsaW5nIGVsZW1lbnQgd2hlcmUgdGhlIGVsZW1lbnQgd2lsbCBiZQogICAgICAgKiAgIHBvc2l0aW9uZWQgbmV4dCB0bwogICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIHByb3ZpZGVkKSB0aGF0IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgdGhlCiAgICAgICAqICAgZWxlbWVudCBoYXMgYmVlbiBtb3ZlZCB0byBpdHMgbmV3IHBvc2l0aW9uCiAgICAgICAqLwogICAgICBtb3ZlIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSkgewogICAgICAgIC8vIERvIG5vdCByZW1vdmUgZWxlbWVudCBiZWZvcmUgaW5zZXJ0LiBSZW1vdmluZyB3aWxsIGNhdXNlIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoZQogICAgICAgIC8vIGVsZW1lbnQgdG8gYmUgZHJvcHBlZC4gSW5zZXJ0IHdpbGwgaW1wbGljaXRseSBkbyB0aGUgcmVtb3ZlLgogICAgICAgIHRoaXMuZW50ZXIoZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNhZGRDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gQWRkcyB0aGUgcHJvdmlkZWQgY2xhc3NOYW1lIENTUyBjbGFzcyB2YWx1ZSB0byB0aGUgcHJvdmlkZWQgZWxlbWVudC4gT25jZQogICAgICAgKiBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGhhdmUgdGhlIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgKiAgIGFkZGVkIHRvIGl0CiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUgdGhlIENTUyBjbGFzcyB3aGljaCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb249fSBkb25lIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgcHJvdmlkZWQpIHRoYXQgd2lsbCBiZSBmaXJlZCBhZnRlciB0aGUKICAgICAgICogICBjbGFzc05hbWUgdmFsdWUgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICovCiAgICAgIGFkZENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7CiAgICAgICAgY2xhc3NOYW1lID0gaXNTdHJpbmcoY2xhc3NOYW1lKSA/CiAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgOgogICAgICAgICAgICAgICAgICAgICAgaXNBcnJheShjbGFzc05hbWUpID8gY2xhc3NOYW1lLmpvaW4oJyAnKSA6ICcnOwogICAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgIGpxTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgfSk7CiAgICAgICAgYXN5bmMoZG9uZSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNyZW1vdmVDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlcyB0aGUgcHJvdmlkZWQgY2xhc3NOYW1lIENTUyBjbGFzcyB2YWx1ZSBmcm9tIHRoZSBwcm92aWRlZCBlbGVtZW50LgogICAgICAgKiBPbmNlIGNvbXBsZXRlLCB0aGUgZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgaGF2ZSB0aGUgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAqICAgcmVtb3ZlZCBmcm9tIGl0CiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUgdGhlIENTUyBjbGFzcyB3aGljaCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIHByb3ZpZGVkKSB0aGF0IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgdGhlCiAgICAgICAqICAgY2xhc3NOYW1lIHZhbHVlIGhhcyBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgKi8KICAgICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmUpIHsKICAgICAgICBjbGFzc05hbWUgPSBpc1N0cmluZyhjbGFzc05hbWUpID8KICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA6CiAgICAgICAgICAgICAgICAgICAgICBpc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWUuam9pbignICcpIDogJyc7CiAgICAgICAgZm9yRWFjaChlbGVtZW50LCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAganFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICB9KTsKICAgICAgICBhc3luYyhkb25lKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRhbmltYXRlI3NldENsYXNzCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqIEBkZXNjcmlwdGlvbiBBZGRzIGFuZC9vciByZW1vdmVzIHRoZSBnaXZlbiBDU1MgY2xhc3NlcyB0byBhbmQgZnJvbSB0aGUgZWxlbWVudC4KICAgICAgICogT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGhhdmUgaXRzIENTUyBjbGFzc2VzIGNoYW5nZWQKICAgICAgICogICByZW1vdmVkIGZyb20gaXQKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGFkZCB0aGUgQ1NTIGNsYXNzZXMgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVtb3ZlIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZQogICAgICAgKiAgIENTUyBjbGFzc2VzIGhhdmUgYmVlbiBzZXQgb24gdGhlIGVsZW1lbnQKICAgICAgICovCiAgICAgIHNldENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIGRvbmUpIHsKICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICBqcUxpdGVBZGRDbGFzcyhlbGVtZW50LCBhZGQpOwogICAgICAgICAganFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgcmVtb3ZlKTsKICAgICAgICB9KTsKICAgICAgICBhc3luYyhkb25lKTsKICAgICAgfSwKCiAgICAgIGVuYWJsZWQgOiBub29wCiAgICB9OwogIH1dOwp9XTsKCmZ1bmN0aW9uICQkQXN5bmNDYWxsYmFja1Byb3ZpZGVyKCl7CiAgdGhpcy4kZ2V0ID0gWyckJHJBRicsICckdGltZW91dCcsIGZ1bmN0aW9uKCQkckFGLCAkdGltZW91dCkgewogICAgcmV0dXJuICQkckFGLnN1cHBvcnRlZAogICAgICA/IGZ1bmN0aW9uKGZuKSB7IHJldHVybiAkJHJBRihmbik7IH0KICAgICAgOiBmdW5jdGlvbihmbikgewogICAgICAgIHJldHVybiAkdGltZW91dChmbiwgMCwgZmFsc2UpOwogICAgICB9OwogIH1dOwp9CgovKioKICogISBUaGlzIGlzIGEgcHJpdmF0ZSB1bmRvY3VtZW50ZWQgc2VydmljZSAhCiAqCiAqIEBuYW1lICRicm93c2VyCiAqIEByZXF1aXJlcyAkbG9nCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIG9iamVjdCBoYXMgdHdvIGdvYWxzOgogKgogKiAtIGhpZGUgYWxsIHRoZSBnbG9iYWwgc3RhdGUgaW4gdGhlIGJyb3dzZXIgY2F1c2VkIGJ5IHRoZSB3aW5kb3cgb2JqZWN0CiAqIC0gYWJzdHJhY3QgYXdheSBhbGwgdGhlIGJyb3dzZXIgc3BlY2lmaWMgZmVhdHVyZXMgYW5kIGluY29uc2lzdGVuY2llcwogKgogKiBGb3IgdGVzdHMgd2UgcHJvdmlkZSB7QGxpbmsgbmdNb2NrLiRicm93c2VyIG1vY2sgaW1wbGVtZW50YXRpb259IG9mIHRoZSBgJGJyb3dzZXJgCiAqIHNlcnZpY2UsIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBjb252ZW5pZW50IHRlc3Rpbmcgb2YgdGhlIGFwcGxpY2F0aW9uIHdpdGhvdXQgdGhlIGludGVyYWN0aW9uIHdpdGgKICogdGhlIHJlYWwgYnJvd3NlciBhcGlzLgogKi8KLyoqCiAqIEBwYXJhbSB7b2JqZWN0fSB3aW5kb3cgVGhlIGdsb2JhbCB3aW5kb3cgb2JqZWN0LgogKiBAcGFyYW0ge29iamVjdH0gZG9jdW1lbnQgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gWEhSIFhNTEh0dHBSZXF1ZXN0IGNvbnN0cnVjdG9yLgogKiBAcGFyYW0ge29iamVjdH0gJGxvZyBjb25zb2xlLmxvZyBvciBhbiBvYmplY3Qgd2l0aCB0aGUgc2FtZSBpbnRlcmZhY2UuCiAqIEBwYXJhbSB7b2JqZWN0fSAkc25pZmZlciAkc25pZmZlciBzZXJ2aWNlCiAqLwpmdW5jdGlvbiBCcm93c2VyKHdpbmRvdywgZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKSB7CiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByYXdEb2N1bWVudCA9IGRvY3VtZW50WzBdLAogICAgICBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiwKICAgICAgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5LAogICAgICBzZXRUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQsCiAgICAgIGNsZWFyVGltZW91dCA9IHdpbmRvdy5jbGVhclRpbWVvdXQsCiAgICAgIHBlbmRpbmdEZWZlcklkcyA9IHt9OwoKICBzZWxmLmlzTW9jayA9IGZhbHNlOwoKICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSAwOwogIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MgPSBbXTsKCiAgLy8gVE9ETyh2b2p0YSk6IHJlbW92ZSB0aGlzIHRlbXBvcmFyeSBhcGkKICBzZWxmLiQkY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QgPSBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdDsKICBzZWxmLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSBmdW5jdGlvbigpIHsgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsgfTsKCiAgLyoqCiAgICogRXhlY3V0ZXMgdGhlIGBmbmAgZnVuY3Rpb24oc3VwcG9ydHMgY3VycnlpbmcpIGFuZCBkZWNyZW1lbnRzIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYAogICAqIGNvdW50ZXIuIElmIHRoZSBjb3VudGVyIHJlYWNoZXMgMCwgYWxsIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYCBhcmUgZXhlY3V0ZWQuCiAgICovCiAgZnVuY3Rpb24gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pIHsKICAgIHRyeSB7CiAgICAgIGZuLmFwcGx5KG51bGwsIHNsaWNlQXJncyhhcmd1bWVudHMsIDEpKTsKICAgIH0gZmluYWxseSB7CiAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgIHdoaWxlKG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wb3AoKSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkbG9nLmVycm9yKGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogQHByaXZhdGUKICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyB1c2VkIG9ubHkgYnkgc2NlbmFyaW8gcnVubmVyCiAgICogVE9ETyh2b2p0YSk6IHByZWZpeCB0aGlzIG1ldGhvZCB3aXRoICQkID8KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNhbGxiYWNrIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBubyBvdXRzdGFuZGluZyByZXF1ZXN0CiAgICovCiAgc2VsZi5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIC8vIGZvcmNlIGJyb3dzZXIgdG8gZXhlY3V0ZSBhbGwgcG9sbEZucyAtIHRoaXMgaXMgbmVlZGVkIHNvIHRoYXQgY29va2llcyBhbmQgb3RoZXIgcG9sbGVycyBmaXJlCiAgICAvLyBhdCBzb21lIGRldGVybWluaXN0aWMgdGltZSBpbiByZXNwZWN0IHRvIHRoZSB0ZXN0IHJ1bm5lcidzIGFjdGlvbnMuIExlYXZpbmcgdGhpbmdzIHVwIHRvIHRoZQogICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgZm9yRWFjaChwb2xsRm5zLCBmdW5jdGlvbihwb2xsRm4peyBwb2xsRm4oKTsgfSk7CgogICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9IGVsc2UgewogICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBQb2xsIFdhdGNoZXIgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICB2YXIgcG9sbEZucyA9IFtdLAogICAgICBwb2xsVGltZW91dDsKCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjYWRkUG9sbEZuCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIFBvbGwgZnVuY3Rpb24gdG8gYWRkCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBZGRzIGEgZnVuY3Rpb24gdG8gdGhlIGxpc3Qgb2YgZnVuY3Rpb25zIHRoYXQgcG9sbGVyIHBlcmlvZGljYWxseSBleGVjdXRlcywKICAgKiBhbmQgc3RhcnRzIHBvbGxpbmcgaWYgbm90IHN0YXJ0ZWQgeWV0LgogICAqCiAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IHRoZSBhZGRlZCBmdW5jdGlvbgogICAqLwogIHNlbGYuYWRkUG9sbEZuID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmIChpc1VuZGVmaW5lZChwb2xsVGltZW91dCkpIHN0YXJ0UG9sbGVyKDEwMCwgc2V0VGltZW91dCk7CiAgICBwb2xsRm5zLnB1c2goZm4pOwogICAgcmV0dXJuIGZuOwogIH07CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnRlcnZhbCBIb3cgb2Z0ZW4gc2hvdWxkIGJyb3dzZXIgY2FsbCBwb2xsIGZ1bmN0aW9ucyAobXMpCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzZXRUaW1lb3V0IFJlZmVyZW5jZSB0byBhIHJlYWwgb3IgZmFrZSBgc2V0VGltZW91dGAgZnVuY3Rpb24uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb25maWd1cmVzIHRoZSBwb2xsZXIgdG8gcnVuIGluIHRoZSBzcGVjaWZpZWQgaW50ZXJ2YWxzLCB1c2luZyB0aGUgc3BlY2lmaWVkCiAgICogc2V0VGltZW91dCBmbiBhbmQga2lja3MgaXQgb2ZmLgogICAqLwogIGZ1bmN0aW9uIHN0YXJ0UG9sbGVyKGludGVydmFsLCBzZXRUaW1lb3V0KSB7CiAgICAoZnVuY3Rpb24gY2hlY2soKSB7CiAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24ocG9sbEZuKXsgcG9sbEZuKCk7IH0pOwogICAgICBwb2xsVGltZW91dCA9IHNldFRpbWVvdXQoY2hlY2ssIGludGVydmFsKTsKICAgIH0pKCk7CiAgfQoKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vIFVSTCBBUEkKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICB2YXIgbGFzdEJyb3dzZXJVcmwgPSBsb2NhdGlvbi5ocmVmLAogICAgICBiYXNlRWxlbWVudCA9IGRvY3VtZW50LmZpbmQoJ2Jhc2UnKSwKICAgICAgbmV3TG9jYXRpb24gPSBudWxsOwoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciN1cmwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEdFVFRFUjoKICAgKiBXaXRob3V0IGFueSBhcmd1bWVudCwgdGhpcyBtZXRob2QganVzdCByZXR1cm5zIGN1cnJlbnQgdmFsdWUgb2YgbG9jYXRpb24uaHJlZi4KICAgKgogICAqIFNFVFRFUjoKICAgKiBXaXRoIGF0IGxlYXN0IG9uZSBhcmd1bWVudCwgdGhpcyBtZXRob2Qgc2V0cyB1cmwgdG8gbmV3IHZhbHVlLgogICAqIElmIGh0bWw1IGhpc3RvcnkgYXBpIHN1cHBvcnRlZCwgcHVzaFN0YXRlL3JlcGxhY2VTdGF0ZSBpcyB1c2VkLCBvdGhlcndpc2UKICAgKiBsb2NhdGlvbi5ocmVmL2xvY2F0aW9uLnJlcGxhY2UgaXMgdXNlZC4KICAgKiBSZXR1cm5zIGl0cyBvd24gaW5zdGFuY2UgdG8gYWxsb3cgY2hhaW5pbmcKICAgKgogICAqIE5PVEU6IHRoaXMgYXBpIGlzIGludGVuZGVkIGZvciB1c2Ugb25seSBieSB0aGUgJGxvY2F0aW9uIHNlcnZpY2UuIFBsZWFzZSB1c2UgdGhlCiAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gY2hhbmdlIHVybC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgTmV3IHVybCAod2hlbiB1c2VkIGFzIHNldHRlcikKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSByZXBsYWNlIFNob3VsZCBuZXcgdXJsIHJlcGxhY2UgY3VycmVudCBoaXN0b3J5IHJlY29yZCA/CiAgICovCiAgc2VsZi51cmwgPSBmdW5jdGlvbih1cmwsIHJlcGxhY2UpIHsKICAgIC8vIEFuZHJvaWQgQnJvd3NlciBCRkNhY2hlIGNhdXNlcyBsb2NhdGlvbiwgaGlzdG9yeSByZWZlcmVuY2UgdG8gYmVjb21lIHN0YWxlLgogICAgaWYgKGxvY2F0aW9uICE9PSB3aW5kb3cubG9jYXRpb24pIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgaWYgKGhpc3RvcnkgIT09IHdpbmRvdy5oaXN0b3J5KSBoaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CgogICAgLy8gc2V0dGVyCiAgICBpZiAodXJsKSB7CiAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSB1cmwpIHJldHVybjsKICAgICAgbGFzdEJyb3dzZXJVcmwgPSB1cmw7CiAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSB7CiAgICAgICAgaWYgKHJlcGxhY2UpIGhpc3RvcnkucmVwbGFjZVN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgIGVsc2UgewogICAgICAgICAgaGlzdG9yeS5wdXNoU3RhdGUobnVsbCwgJycsIHVybCk7CiAgICAgICAgICAvLyBDcmF6eSBPcGVyYSBCdWc6IGh0dHA6Ly9teS5vcGVyYS5jb20vY29tbXVuaXR5L2ZvcnVtcy90b3BpYy5kbWw/aWQ9MTE4NTQ2MgogICAgICAgICAgYmFzZUVsZW1lbnQuYXR0cignaHJlZicsIGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG5ld0xvY2F0aW9uID0gdXJsOwogICAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKHVybCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzZWxmOwogICAgLy8gZ2V0dGVyCiAgICB9IGVsc2UgewogICAgICAvLyAtIG5ld0xvY2F0aW9uIGlzIGEgd29ya2Fyb3VuZCBmb3IgYW4gSUU3LTkgaXNzdWUgd2l0aCBsb2NhdGlvbi5yZXBsYWNlIGFuZCBsb2NhdGlvbi5ocmVmCiAgICAgIC8vICAgbWV0aG9kcyBub3QgdXBkYXRpbmcgbG9jYXRpb24uaHJlZiBzeW5jaHJvbm91c2x5LgogICAgICAvLyAtIHRoZSByZXBsYWNlbWVudCBpcyBhIHdvcmthcm91bmQgZm9yIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQwNzE3MgogICAgICByZXR1cm4gbmV3TG9jYXRpb24gfHwgbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8lMjcvZywiJyIpOwogICAgfQogIH07CgogIHZhciB1cmxDaGFuZ2VMaXN0ZW5lcnMgPSBbXSwKICAgICAgdXJsQ2hhbmdlSW5pdCA9IGZhbHNlOwoKICBmdW5jdGlvbiBmaXJlVXJsQ2hhbmdlKCkgewogICAgbmV3TG9jYXRpb24gPSBudWxsOwogICAgaWYgKGxhc3RCcm93c2VyVXJsID09IHNlbGYudXJsKCkpIHJldHVybjsKCiAgICBsYXN0QnJvd3NlclVybCA9IHNlbGYudXJsKCk7CiAgICBmb3JFYWNoKHVybENoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgbGlzdGVuZXIoc2VsZi51cmwoKSk7CiAgICB9KTsKICB9CgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI29uVXJsQ2hhbmdlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlciBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLCB3aGVuIHVybCBjaGFuZ2VzLgogICAqCiAgICogSXQncyBvbmx5IGNhbGxlZCB3aGVuIHRoZSB1cmwgaXMgY2hhbmdlZCBmcm9tIG91dHNpZGUgb2YgYW5ndWxhcjoKICAgKiAtIHVzZXIgdHlwZXMgZGlmZmVyZW50IHVybCBpbnRvIGFkZHJlc3MgYmFyCiAgICogLSB1c2VyIGNsaWNrcyBvbiBoaXN0b3J5IChmb3J3YXJkL2JhY2spIGJ1dHRvbgogICAqIC0gdXNlciBjbGlja3Mgb24gYSBsaW5rCiAgICoKICAgKiBJdCdzIG5vdCBjYWxsZWQgd2hlbiB1cmwgaXMgY2hhbmdlZCBieSAkYnJvd3Nlci51cmwoKSBtZXRob2QKICAgKgogICAqIFRoZSBsaXN0ZW5lciBnZXRzIGNhbGxlZCB3aXRoIG5ldyB1cmwgYXMgcGFyYW1ldGVyLgogICAqCiAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBtb25pdG9yIHVybCBjaGFuZ2VzIGluIGFuZ3VsYXIgYXBwcy4KICAgKgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nKX0gbGlzdGVuZXIgTGlzdGVuZXIgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdXJsIGNoYW5nZXMuCiAgICogQHJldHVybiB7ZnVuY3Rpb24oc3RyaW5nKX0gUmV0dXJucyB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBmbiAtIGhhbmR5IGlmIHRoZSBmbiBpcyBhbm9ueW1vdXMuCiAgICovCiAgc2VsZi5vblVybENoYW5nZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAvLyBUT0RPKHZvanRhKTogcmVmYWN0b3IgdG8gdXNlIG5vZGUncyBzeW50YXggZm9yIGV2ZW50cwogICAgaWYgKCF1cmxDaGFuZ2VJbml0KSB7CiAgICAgIC8vIFdlIGxpc3RlbiBvbiBib3RoIChoYXNoY2hhbmdlL3BvcHN0YXRlKSB3aGVuIGF2YWlsYWJsZSwgYXMgc29tZSBicm93c2VycyAoZS5nLiBPcGVyYSkKICAgICAgLy8gZG9uJ3QgZmlyZSBwb3BzdGF0ZSB3aGVuIHVzZXIgY2hhbmdlIHRoZSBhZGRyZXNzIGJhciBhbmQgZG9uJ3QgZmlyZSBoYXNoY2hhbmdlIHdoZW4gdXJsCiAgICAgIC8vIGNoYW5nZWQgYnkgcHVzaC9yZXBsYWNlU3RhdGUKCiAgICAgIC8vIGh0bWw1IGhpc3RvcnkgYXBpIC0gcG9wc3RhdGUgZXZlbnQKICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIGpxTGl0ZSh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAvLyBoYXNoY2hhbmdlIGV2ZW50CiAgICAgIGlmICgkc25pZmZlci5oYXNoY2hhbmdlKSBqcUxpdGUod2luZG93KS5vbignaGFzaGNoYW5nZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAvLyBwb2xsaW5nCiAgICAgIGVsc2Ugc2VsZi5hZGRQb2xsRm4oZmlyZVVybENoYW5nZSk7CgogICAgICB1cmxDaGFuZ2VJbml0ID0gdHJ1ZTsKICAgIH0KCiAgICB1cmxDaGFuZ2VMaXN0ZW5lcnMucHVzaChjYWxsYmFjayk7CiAgICByZXR1cm4gY2FsbGJhY2s7CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBNaXNjIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI2Jhc2VIcmVmCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXR1cm5zIGN1cnJlbnQgPGJhc2UgaHJlZj4KICAgKiAoYWx3YXlzIHJlbGF0aXZlIC0gd2l0aG91dCBkb21haW4pCiAgICoKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgY3VycmVudCBiYXNlIGhyZWYKICAgKi8KICBzZWxmLmJhc2VIcmVmID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgaHJlZiA9IGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKTsKICAgIHJldHVybiBocmVmID8gaHJlZi5yZXBsYWNlKC9eKGh0dHBzP1w6KT9cL1wvW15cL10qLywgJycpIDogJyc7CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBDb29raWVzIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIGxhc3RDb29raWVzID0ge307CiAgdmFyIGxhc3RDb29raWVTdHJpbmcgPSAnJzsKICB2YXIgY29va2llUGF0aCA9IHNlbGYuYmFzZUhyZWYoKTsKCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjY29va2llcwogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIENvb2tpZSBuYW1lCiAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBDb29raWUgdmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBjb29raWVzIG1ldGhvZCBwcm92aWRlcyBhICdwcml2YXRlJyBsb3cgbGV2ZWwgYWNjZXNzIHRvIGJyb3dzZXIgY29va2llcy4KICAgKiBJdCBpcyBub3QgbWVhbnQgdG8gYmUgdXNlZCBkaXJlY3RseSwgdXNlIHRoZSAkY29va2llIHNlcnZpY2UgaW5zdGVhZC4KICAgKgogICAqIFRoZSByZXR1cm4gdmFsdWVzIHZhcnkgZGVwZW5kaW5nIG9uIHRoZSBhcmd1bWVudHMgdGhhdCB0aGUgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCBhcyBmb2xsb3dzOgogICAqCiAgICogLSBjb29raWVzKCkgLT4gaGFzaCBvZiBhbGwgY29va2llcywgdGhpcyBpcyBOT1QgYSBjb3B5IG9mIHRoZSBpbnRlcm5hbCBzdGF0ZSwgc28gZG8gbm90IG1vZGlmeQogICAqICAgaXQKICAgKiAtIGNvb2tpZXMobmFtZSwgdmFsdWUpIC0+IHNldCBuYW1lIHRvIHZhbHVlLCBpZiB2YWx1ZSBpcyB1bmRlZmluZWQgZGVsZXRlIHRoZSBjb29raWUKICAgKiAtIGNvb2tpZXMobmFtZSkgLT4gdGhlIHNhbWUgYXMgKG5hbWUsIHVuZGVmaW5lZCkgPT0gREVMRVRFUyAobm8gb25lIGNhbGxzIGl0IHJpZ2h0IG5vdyB0aGF0CiAgICogICB3YXkpCiAgICoKICAgKiBAcmV0dXJucyB7T2JqZWN0fSBIYXNoIG9mIGFsbCBjb29raWVzIChpZiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyKQogICAqLwogIHNlbGYuY29va2llcyA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAvKiBnbG9iYWwgZXNjYXBlOiBmYWxzZSwgdW5lc2NhcGU6IGZhbHNlICovCiAgICB2YXIgY29va2llTGVuZ3RoLCBjb29raWVBcnJheSwgY29va2llLCBpLCBpbmRleDsKCiAgICBpZiAobmFtZSkgewogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICI9O3BhdGg9IiArIGNvb2tpZVBhdGggKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICI7ZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgY29va2llTGVuZ3RoID0gKHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICc9JyArIGVzY2FwZSh2YWx1ZSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc7cGF0aD0nICsgY29va2llUGF0aCkubGVuZ3RoICsgMTsKCiAgICAgICAgICAvLyBwZXIgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMjEwOS50eHQgYnJvd3NlciBtdXN0IGFsbG93IGF0IG1pbmltdW06CiAgICAgICAgICAvLyAtIDMwMCBjb29raWVzCiAgICAgICAgICAvLyAtIDIwIGNvb2tpZXMgcGVyIHVuaXF1ZSBkb21haW4KICAgICAgICAgIC8vIC0gNDA5NiBieXRlcyBwZXIgY29va2llCiAgICAgICAgICBpZiAoY29va2llTGVuZ3RoID4gNDA5NikgewogICAgICAgICAgICAkbG9nLndhcm4oIkNvb2tpZSAnIisgbmFtZSArCiAgICAgICAgICAgICAgIicgcG9zc2libHkgbm90IHNldCBvciBvdmVyZmxvd2VkIGJlY2F1c2UgaXQgd2FzIHRvbyBsYXJnZSAoIisKICAgICAgICAgICAgICBjb29raWVMZW5ndGggKyAiID4gNDA5NiBieXRlcykhIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAocmF3RG9jdW1lbnQuY29va2llICE9PSBsYXN0Q29va2llU3RyaW5nKSB7CiAgICAgICAgbGFzdENvb2tpZVN0cmluZyA9IHJhd0RvY3VtZW50LmNvb2tpZTsKICAgICAgICBjb29raWVBcnJheSA9IGxhc3RDb29raWVTdHJpbmcuc3BsaXQoIjsgIik7CiAgICAgICAgbGFzdENvb2tpZXMgPSB7fTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvb2tpZUFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb29raWUgPSBjb29raWVBcnJheVtpXTsKICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgIGlmIChpbmRleCA+IDApIHsgLy9pZ25vcmUgbmFtZWxlc3MgY29va2llcwogICAgICAgICAgICBuYW1lID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZygwLCBpbmRleCkpOwogICAgICAgICAgICAvLyB0aGUgZmlyc3QgdmFsdWUgdGhhdCBpcyBzZWVuIGZvciBhIGNvb2tpZSBpcyB0aGUgbW9zdAogICAgICAgICAgICAvLyBzcGVjaWZpYyBvbmUuICB2YWx1ZXMgZm9yIHRoZSBzYW1lIGNvb2tpZSBuYW1lIHRoYXQKICAgICAgICAgICAgLy8gZm9sbG93IGFyZSBmb3IgbGVzcyBzcGVjaWZpYyBwYXRocy4KICAgICAgICAgICAgaWYgKGxhc3RDb29raWVzW25hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBsYXN0Q29va2llc1tuYW1lXSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoaW5kZXggKyAxKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3RDb29raWVzOwogICAgfQogIH07CgoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciNkZWZlcgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcnJlZC4KICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBvZiBtaWxsaXNlY29uZHMgdG8gZGVmZXIgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbi4KICAgKiBAcmV0dXJucyB7Kn0gRGVmZXJJZCB0aGF0IGNhbiBiZSB1c2VkIHRvIGNhbmNlbCB0aGUgdGFzayB2aWEgYCRicm93c2VyLmRlZmVyLmNhbmNlbCgpYC4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEV4ZWN1dGVzIGEgZm4gYXN5bmNocm9ub3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAqCiAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICoKICAgKi8KICBzZWxmLmRlZmVyID0gZnVuY3Rpb24oZm4sIGRlbGF5KSB7CiAgICB2YXIgdGltZW91dElkOwogICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsKICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pOwogICAgfSwgZGVsYXkgfHwgMCk7CiAgICBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXSA9IHRydWU7CiAgICByZXR1cm4gdGltZW91dElkOwogIH07CgoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciNkZWZlci5jYW5jZWwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbmNlbHMgYSBkZWZlcnJlZCB0YXNrIGlkZW50aWZpZWQgd2l0aCBgZGVmZXJJZGAuCiAgICoKICAgKiBAcGFyYW0geyp9IGRlZmVySWQgVG9rZW4gcmV0dXJuZWQgYnkgdGhlIGAkYnJvd3Nlci5kZWZlcmAgZnVuY3Rpb24uCiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVsbHkKICAgKiAgICAgICAgICAgICAgICAgICAgY2FuY2VsZWQuCiAgICovCiAgc2VsZi5kZWZlci5jYW5jZWwgPSBmdW5jdGlvbihkZWZlcklkKSB7CiAgICBpZiAocGVuZGluZ0RlZmVySWRzW2RlZmVySWRdKSB7CiAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF07CiAgICAgIGNsZWFyVGltZW91dChkZWZlcklkKTsKICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cgp9CgpmdW5jdGlvbiAkQnJvd3NlclByb3ZpZGVyKCl7CiAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRsb2cnLCAnJHNuaWZmZXInLCAnJGRvY3VtZW50JywKICAgICAgZnVuY3Rpb24oICR3aW5kb3csICAgJGxvZywgICAkc25pZmZlciwgICAkZG9jdW1lbnQpewogICAgICAgIHJldHVybiBuZXcgQnJvd3Nlcigkd2luZG93LCAkZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKTsKICAgICAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkY2FjaGVGYWN0b3J5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGYWN0b3J5IHRoYXQgY29uc3RydWN0cyB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0cyBhbmQgZ2l2ZXMgYWNjZXNzIHRvCiAqIHRoZW0uCiAqCiAqIGBgYGpzCiAqCiAqICB2YXIgY2FjaGUgPSAkY2FjaGVGYWN0b3J5KCdjYWNoZUlkJyk7CiAqICBleHBlY3QoJGNhY2hlRmFjdG9yeS5nZXQoJ2NhY2hlSWQnKSkudG9CZShjYWNoZSk7CiAqICBleHBlY3QoJGNhY2hlRmFjdG9yeS5nZXQoJ25vU3VjaENhY2hlSWQnKSkubm90LnRvQmVEZWZpbmVkKCk7CiAqCiAqICBjYWNoZS5wdXQoImtleSIsICJ2YWx1ZSIpOwogKiAgY2FjaGUucHV0KCJhbm90aGVyIGtleSIsICJhbm90aGVyIHZhbHVlIik7CiAqCiAqICAvLyBXZSd2ZSBzcGVjaWZpZWQgbm8gb3B0aW9ucyBvbiBjcmVhdGlvbgogKiAgZXhwZWN0KGNhY2hlLmluZm8oKSkudG9FcXVhbCh7aWQ6ICdjYWNoZUlkJywgc2l6ZTogMn0pOwogKgogKiBgYGAKICoKICoKICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiB0aGUgbmV3bHkgY3JlYXRlZCBjYWNoZS4KICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0IHRoYXQgc3BlY2lmaWVzIHRoZSBjYWNoZSBiZWhhdmlvci4gUHJvcGVydGllczoKICoKICogICAtIGB7bnVtYmVyPX1gIGBjYXBhY2l0eWAg4oCUIHR1cm5zIHRoZSBjYWNoZSBpbnRvIExSVSBjYWNoZS4KICoKICogQHJldHVybnMge29iamVjdH0gTmV3bHkgY3JlYXRlZCBjYWNoZSBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHNldCBvZiBtZXRob2RzOgogKgogKiAtIGB7b2JqZWN0fWAgYGluZm8oKWAg4oCUIFJldHVybnMgaWQsIHNpemUsIGFuZCBvcHRpb25zIG9mIGNhY2hlLgogKiAtIGB7eyp9fWAgYHB1dCh7c3RyaW5nfSBrZXksIHsqfSB2YWx1ZSlgIOKAlCBQdXRzIGEgbmV3IGtleS12YWx1ZSBwYWlyIGludG8gdGhlIGNhY2hlIGFuZCByZXR1cm5zCiAqICAgaXQuCiAqIC0gYHt7Kn19YCBgZ2V0KHtzdHJpbmd9IGtleSlgIOKAlCBSZXR1cm5zIGNhY2hlZCB2YWx1ZSBmb3IgYGtleWAgb3IgdW5kZWZpbmVkIGZvciBjYWNoZSBtaXNzLgogKiAtIGB7dm9pZH1gIGByZW1vdmUoe3N0cmluZ30ga2V5KWAg4oCUIFJlbW92ZXMgYSBrZXktdmFsdWUgcGFpciBmcm9tIHRoZSBjYWNoZS4KICogLSBge3ZvaWR9YCBgcmVtb3ZlQWxsKClgIOKAlCBSZW1vdmVzIGFsbCBjYWNoZWQgdmFsdWVzLgogKiAtIGB7dm9pZH1gIGBkZXN0cm95KClgIOKAlCBSZW1vdmVzIHJlZmVyZW5jZXMgdG8gdGhpcyBjYWNoZSBmcm9tICRjYWNoZUZhY3RvcnkuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0iY2FjaGVFeGFtcGxlQXBwIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ2FjaGVDb250cm9sbGVyIj4KICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJuZXdDYWNoZUtleSIgcGxhY2Vob2xkZXI9IktleSI+CiAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ibmV3Q2FjaGVWYWx1ZSIgcGxhY2Vob2xkZXI9IlZhbHVlIj4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0icHV0KG5ld0NhY2hlS2V5LCBuZXdDYWNoZVZhbHVlKSI+Q2FjaGU8L2J1dHRvbj4KCiAgICAgICAgIDxwIG5nLWlmPSJrZXlzLmxlbmd0aCI+Q2FjaGVkIFZhbHVlczwvcD4KICAgICAgICAgPGRpdiBuZy1yZXBlYXQ9ImtleSBpbiBrZXlzIj4KICAgICAgICAgICA8c3BhbiBuZy1iaW5kPSJrZXkiPjwvc3Bhbj4KICAgICAgICAgICA8c3Bhbj46IDwvc3Bhbj4KICAgICAgICAgICA8YiBuZy1iaW5kPSJjYWNoZS5nZXQoa2V5KSI+PC9iPgogICAgICAgICA8L2Rpdj4KCiAgICAgICAgIDxwPkNhY2hlIEluZm88L3A+CiAgICAgICAgIDxkaXYgbmctcmVwZWF0PSIoa2V5LCB2YWx1ZSkgaW4gY2FjaGUuaW5mbygpIj4KICAgICAgICAgICA8c3BhbiBuZy1iaW5kPSJrZXkiPjwvc3Bhbj4KICAgICAgICAgICA8c3Bhbj46IDwvc3Bhbj4KICAgICAgICAgICA8YiBuZy1iaW5kPSJ2YWx1ZSI+PC9iPgogICAgICAgICA8L2Rpdj4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgYW5ndWxhci5tb2R1bGUoJ2NhY2hlRXhhbXBsZUFwcCcsIFtdKS4KICAgICAgICAgY29udHJvbGxlcignQ2FjaGVDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGNhY2hlRmFjdG9yeScsIGZ1bmN0aW9uKCRzY29wZSwgJGNhY2hlRmFjdG9yeSkgewogICAgICAgICAgICRzY29wZS5rZXlzID0gW107CiAgICAgICAgICAgJHNjb3BlLmNhY2hlID0gJGNhY2hlRmFjdG9yeSgnY2FjaGVJZCcpOwogICAgICAgICAgICRzY29wZS5wdXQgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAkc2NvcGUuY2FjaGUucHV0KGtleSwgdmFsdWUpOwogICAgICAgICAgICAgJHNjb3BlLmtleXMucHVzaChrZXkpOwogICAgICAgICAgIH07CiAgICAgICAgIH1dKTsKICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgIHAgewogICAgICAgICBtYXJnaW46IDEwcHggMCAzcHg7CiAgICAgICB9CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiAkQ2FjaGVGYWN0b3J5UHJvdmlkZXIoKSB7CgogIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNhY2hlcyA9IHt9OwoKICAgIGZ1bmN0aW9uIGNhY2hlRmFjdG9yeShjYWNoZUlkLCBvcHRpb25zKSB7CiAgICAgIGlmIChjYWNoZUlkIGluIGNhY2hlcykgewogICAgICAgIHRocm93IG1pbkVycignJGNhY2hlRmFjdG9yeScpKCdpaWQnLCAiQ2FjaGVJZCAnezB9JyBpcyBhbHJlYWR5IHRha2VuISIsIGNhY2hlSWQpOwogICAgICB9CgogICAgICB2YXIgc2l6ZSA9IDAsCiAgICAgICAgICBzdGF0cyA9IGV4dGVuZCh7fSwgb3B0aW9ucywge2lkOiBjYWNoZUlkfSksCiAgICAgICAgICBkYXRhID0ge30sCiAgICAgICAgICBjYXBhY2l0eSA9IChvcHRpb25zICYmIG9wdGlvbnMuY2FwYWNpdHkpIHx8IE51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICBscnVIYXNoID0ge30sCiAgICAgICAgICBmcmVzaEVuZCA9IG51bGwsCiAgICAgICAgICBzdGFsZUVuZCA9IG51bGw7CgogICAgICAvKioKICAgICAgICogQG5nZG9jIHR5cGUKICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQSBjYWNoZSBvYmplY3QgdXNlZCB0byBzdG9yZSBhbmQgcmV0cmlldmUgZGF0YSwgcHJpbWFyaWx5IHVzZWQgYnkKICAgICAgICoge0BsaW5rICRodHRwICRodHRwfSBhbmQgdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6c2NyaXB0IHNjcmlwdH0gZGlyZWN0aXZlIHRvIGNhY2hlCiAgICAgICAqIHRlbXBsYXRlcyBhbmQgb3RoZXIgZGF0YS4KICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogIGFuZ3VsYXIubW9kdWxlKCdzdXBlckNhY2hlJykKICAgICAgICogICAgLmZhY3RvcnkoJ3N1cGVyQ2FjaGUnLCBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbigkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAqICAgICAgcmV0dXJuICRjYWNoZUZhY3RvcnkoJ3N1cGVyLWNhY2hlJyk7CiAgICAgICAqICAgIH1dKTsKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqIEV4YW1wbGUgdGVzdDoKICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogIGl0KCdzaG91bGQgYmVoYXZlIGxpa2UgYSBjYWNoZScsIGluamVjdChmdW5jdGlvbihzdXBlckNhY2hlKSB7CiAgICAgICAqICAgIHN1cGVyQ2FjaGUucHV0KCdrZXknLCAndmFsdWUnKTsKICAgICAgICogICAgc3VwZXJDYWNoZS5wdXQoJ2Fub3RoZXIga2V5JywgJ2Fub3RoZXIgdmFsdWUnKTsKICAgICAgICoKICAgICAgICogICAgZXhwZWN0KHN1cGVyQ2FjaGUuaW5mbygpKS50b0VxdWFsKHsKICAgICAgICogICAgICBpZDogJ3N1cGVyLWNhY2hlJywKICAgICAgICogICAgICBzaXplOiAyCiAgICAgICAqICAgIH0pOwogICAgICAgKgogICAgICAgKiAgICBzdXBlckNhY2hlLnJlbW92ZSgnYW5vdGhlciBrZXknKTsKICAgICAgICogICAgZXhwZWN0KHN1cGVyQ2FjaGUuZ2V0KCdhbm90aGVyIGtleScpKS50b0JlVW5kZWZpbmVkKCk7CiAgICAgICAqCiAgICAgICAqICAgIHN1cGVyQ2FjaGUucmVtb3ZlQWxsKCk7CiAgICAgICAqICAgIGV4cGVjdChzdXBlckNhY2hlLmluZm8oKSkudG9FcXVhbCh7CiAgICAgICAqICAgICAgaWQ6ICdzdXBlci1jYWNoZScsCiAgICAgICAqICAgICAgc2l6ZTogMAogICAgICAgKiAgICB9KTsKICAgICAgICogIH0pKTsKICAgICAgICogYGBgCiAgICAgICAqLwogICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNwdXQKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogSW5zZXJ0cyBhIG5hbWVkIGVudHJ5IGludG8gdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3QgdG8gYmUKICAgICAgICAgKiByZXRyaWV2ZWQgbGF0ZXIsIGFuZCBpbmNyZW1lbnRpbmcgdGhlIHNpemUgb2YgdGhlIGNhY2hlIGlmIHRoZSBrZXkgd2FzIG5vdCBhbHJlYWR5CiAgICAgICAgICogcHJlc2VudCBpbiB0aGUgY2FjaGUuIElmIGJlaGF2aW5nIGxpa2UgYW4gTFJVIGNhY2hlLCBpdCB3aWxsIGFsc28gcmVtb3ZlIHN0YWxlCiAgICAgICAgICogZW50cmllcyBmcm9tIHRoZSBzZXQuCiAgICAgICAgICoKICAgICAgICAgKiBJdCB3aWxsIG5vdCBpbnNlcnQgdW5kZWZpbmVkIHZhbHVlcyBpbnRvIHRoZSBjYWNoZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgdGhlIGtleSB1bmRlciB3aGljaCB0aGUgY2FjaGVkIGRhdGEgaXMgc3RvcmVkLgogICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgdGhlIHZhbHVlIHRvIHN0b3JlIGFsb25nc2lkZSB0aGUga2V5LiBJZiBpdCBpcyB1bmRlZmluZWQsIHRoZSBrZXkKICAgICAgICAgKiAgICB3aWxsIG5vdCBiZSBzdG9yZWQuCiAgICAgICAgICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSBzdG9yZWQuCiAgICAgICAgICovCiAgICAgICAgcHV0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICBpZiAoY2FwYWNpdHkgPCBOdW1iZXIuTUFYX1ZBTFVFKSB7CiAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XSB8fCAobHJ1SGFzaFtrZXldID0ge2tleToga2V5fSk7CgogICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSByZXR1cm47CiAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgIGRhdGFba2V5XSA9IHZhbHVlOwoKICAgICAgICAgIGlmIChzaXplID4gY2FwYWNpdHkpIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmUoc3RhbGVFbmQua2V5KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjZ2V0CiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJldHJpZXZlcyBuYW1lZCBkYXRhIHN0b3JlZCBpbiB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgdGhlIGtleSBvZiB0aGUgZGF0YSB0byBiZSByZXRyaWV2ZWQKICAgICAgICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHN0b3JlZC4KICAgICAgICAgKi8KICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYgKGNhcGFjaXR5IDwgTnVtYmVyLk1BWF9WQUxVRSkgewogICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZGF0YVtrZXldOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNyZW1vdmUKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmVtb3ZlcyBhbiBlbnRyeSBmcm9tIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSB0aGUga2V5IG9mIHRoZSBlbnRyeSB0byBiZSByZW1vdmVkCiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmIChjYXBhY2l0eSA8IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgaWYgKCFscnVFbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IGZyZXNoRW5kKSBmcmVzaEVuZCA9IGxydUVudHJ5LnA7CiAgICAgICAgICAgIGlmIChscnVFbnRyeSA9PSBzdGFsZUVuZCkgc3RhbGVFbmQgPSBscnVFbnRyeS5uOwogICAgICAgICAgICBsaW5rKGxydUVudHJ5Lm4sbHJ1RW50cnkucCk7CgogICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgfQoKICAgICAgICAgIGRlbGV0ZSBkYXRhW2tleV07CiAgICAgICAgICBzaXplLS07CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI3JlbW92ZUFsbAogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDbGVhcnMgdGhlIGNhY2hlIG9iamVjdCBvZiBhbnkgZW50cmllcy4KICAgICAgICAgKi8KICAgICAgICByZW1vdmVBbGw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZGF0YSA9IHt9OwogICAgICAgICAgc2l6ZSA9IDA7CiAgICAgICAgICBscnVIYXNoID0ge307CiAgICAgICAgICBmcmVzaEVuZCA9IHN0YWxlRW5kID0gbnVsbDsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjZGVzdHJveQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBEZXN0cm95cyB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdCBlbnRpcmVseSwKICAgICAgICAgKiByZW1vdmluZyBpdCBmcm9tIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSBzZXQuCiAgICAgICAgICovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICBkYXRhID0gbnVsbDsKICAgICAgICAgIHN0YXRzID0gbnVsbDsKICAgICAgICAgIGxydUhhc2ggPSBudWxsOwogICAgICAgICAgZGVsZXRlIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjaW5mbwogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZXRyaWV2ZSBpbmZvcm1hdGlvbiByZWdhcmRpbmcgYSBwYXJ0aWN1bGFyIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGFuIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAgICAgKiAgIDx1bD4KICAgICAgICAgKiAgICAgPGxpPioqaWQqKjogdGhlIGlkIG9mIHRoZSBjYWNoZSBpbnN0YW5jZTwvbGk+CiAgICAgICAgICogICAgIDxsaT4qKnNpemUqKjogdGhlIG51bWJlciBvZiBlbnRyaWVzIGtlcHQgaW4gdGhlIGNhY2hlIGluc3RhbmNlPC9saT4KICAgICAgICAgKiAgICAgPGxpPioqLi4uKio6IGFueSBhZGRpdGlvbmFsIHByb3BlcnRpZXMgZnJvbSB0aGUgb3B0aW9ucyBvYmplY3Qgd2hlbiBjcmVhdGluZyB0aGUKICAgICAgICAgKiAgICAgICBjYWNoZS48L2xpPgogICAgICAgICAqICAgPC91bD4KICAgICAgICAgKi8KICAgICAgICBpbmZvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7c2l6ZTogc2l6ZX0pOwogICAgICAgIH0KICAgICAgfTsKCgogICAgICAvKioKICAgICAgICogbWFrZXMgdGhlIGBlbnRyeWAgdGhlIGZyZXNoRW5kIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICovCiAgICAgIGZ1bmN0aW9uIHJlZnJlc2goZW50cnkpIHsKICAgICAgICBpZiAoZW50cnkgIT0gZnJlc2hFbmQpIHsKICAgICAgICAgIGlmICghc3RhbGVFbmQpIHsKICAgICAgICAgICAgc3RhbGVFbmQgPSBlbnRyeTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RhbGVFbmQgPT0gZW50cnkpIHsKICAgICAgICAgICAgc3RhbGVFbmQgPSBlbnRyeS5uOwogICAgICAgICAgfQoKICAgICAgICAgIGxpbmsoZW50cnkubiwgZW50cnkucCk7CiAgICAgICAgICBsaW5rKGVudHJ5LCBmcmVzaEVuZCk7CiAgICAgICAgICBmcmVzaEVuZCA9IGVudHJ5OwogICAgICAgICAgZnJlc2hFbmQubiA9IG51bGw7CiAgICAgICAgfQogICAgICB9CgoKICAgICAgLyoqCiAgICAgICAqIGJpZGlyZWN0aW9uYWxseSBsaW5rcyB0d28gZW50cmllcyBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAqLwogICAgICBmdW5jdGlvbiBsaW5rKG5leHRFbnRyeSwgcHJldkVudHJ5KSB7CiAgICAgICAgaWYgKG5leHRFbnRyeSAhPSBwcmV2RW50cnkpIHsKICAgICAgICAgIGlmIChuZXh0RW50cnkpIG5leHRFbnRyeS5wID0gcHJldkVudHJ5OyAvL3Agc3RhbmRzIGZvciBwcmV2aW91cywgJ3ByZXYnIGRpZG4ndCBtaW5pZnkKICAgICAgICAgIGlmIChwcmV2RW50cnkpIHByZXZFbnRyeS5uID0gbmV4dEVudHJ5OyAvL24gc3RhbmRzIGZvciBuZXh0LCAnbmV4dCcgZGlkbid0IG1pbmlmeQogICAgICAgIH0KICAgICAgfQogICAgfQoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjYWNoZUZhY3RvcnkjaW5mbwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogR2V0IGluZm9ybWF0aW9uIGFib3V0IGFsbCB0aGUgY2FjaGVzIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWQKICAgKgogICAqIEByZXR1cm5zIHtPYmplY3R9IC0ga2V5LXZhbHVlIG1hcCBvZiBgY2FjaGVJZGAgdG8gdGhlIHJlc3VsdCBvZiBjYWxsaW5nIGBjYWNoZSNpbmZvYAogICAqLwogICAgY2FjaGVGYWN0b3J5LmluZm8gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGluZm8gPSB7fTsKICAgICAgZm9yRWFjaChjYWNoZXMsIGZ1bmN0aW9uKGNhY2hlLCBjYWNoZUlkKSB7CiAgICAgICAgaW5mb1tjYWNoZUlkXSA9IGNhY2hlLmluZm8oKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBpbmZvOwogICAgfTsKCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5I2dldAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogR2V0IGFjY2VzcyB0byBhIGNhY2hlIG9iamVjdCBieSB0aGUgYGNhY2hlSWRgIHVzZWQgd2hlbiBpdCB3YXMgY3JlYXRlZC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUlkIE5hbWUgb3IgaWQgb2YgYSBjYWNoZSB0byBhY2Nlc3MuCiAgICogQHJldHVybnMge29iamVjdH0gQ2FjaGUgb2JqZWN0IGlkZW50aWZpZWQgYnkgdGhlIGNhY2hlSWQgb3IgdW5kZWZpbmVkIGlmIG5vIHN1Y2ggY2FjaGUuCiAgICovCiAgICBjYWNoZUZhY3RvcnkuZ2V0ID0gZnVuY3Rpb24oY2FjaGVJZCkgewogICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdOwogICAgfTsKCgogICAgcmV0dXJuIGNhY2hlRmFjdG9yeTsKICB9Owp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHRlbXBsYXRlQ2FjaGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBmaXJzdCB0aW1lIGEgdGVtcGxhdGUgaXMgdXNlZCwgaXQgaXMgbG9hZGVkIGluIHRoZSB0ZW1wbGF0ZSBjYWNoZSBmb3IgcXVpY2sgcmV0cmlldmFsLiBZb3UKICogY2FuIGxvYWQgdGVtcGxhdGVzIGRpcmVjdGx5IGludG8gdGhlIGNhY2hlIGluIGEgYHNjcmlwdGAgdGFnLCBvciBieSBjb25zdW1pbmcgdGhlCiAqIGAkdGVtcGxhdGVDYWNoZWAgc2VydmljZSBkaXJlY3RseS4KICoKICogQWRkaW5nIHZpYSB0aGUgYHNjcmlwdGAgdGFnOgogKgogKiBgYGBodG1sCiAqICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGVJZC5odG1sIj4KICogICAgIDxwPlRoaXMgaXMgdGhlIGNvbnRlbnQgb2YgdGhlIHRlbXBsYXRlPC9wPgogKiAgIDwvc2NyaXB0PgogKiBgYGAKICoKICogKipOb3RlOioqIHRoZSBgc2NyaXB0YCB0YWcgY29udGFpbmluZyB0aGUgdGVtcGxhdGUgZG9lcyBub3QgbmVlZCB0byBiZSBpbmNsdWRlZCBpbiB0aGUgYGhlYWRgIG9mCiAqIHRoZSBkb2N1bWVudCwgYnV0IGl0IG11c3QgYmUgYmVsb3cgdGhlIGBuZy1hcHBgIGRlZmluaXRpb24uCiAqCiAqIEFkZGluZyB2aWEgdGhlICR0ZW1wbGF0ZUNhY2hlIHNlcnZpY2U6CiAqCiAqIGBgYGpzCiAqIHZhciBteUFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFtdKTsKICogbXlBcHAucnVuKGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAqICAgJHRlbXBsYXRlQ2FjaGUucHV0KCd0ZW1wbGF0ZUlkLmh0bWwnLCAnVGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGUnKTsKICogfSk7CiAqIGBgYAogKgogKiBUbyByZXRyaWV2ZSB0aGUgdGVtcGxhdGUgbGF0ZXIsIHNpbXBseSB1c2UgaXQgaW4geW91ciBIVE1MOgogKiBgYGBodG1sCiAqIDxkaXYgbmctaW5jbHVkZT0iICd0ZW1wbGF0ZUlkLmh0bWwnICI+PC9kaXY+CiAqIGBgYAogKgogKiBvciBnZXQgaXQgdmlhIEphdmFzY3JpcHQ6CiAqIGBgYGpzCiAqICR0ZW1wbGF0ZUNhY2hlLmdldCgndGVtcGxhdGVJZC5odG1sJykKICogYGBgCiAqCiAqIFNlZSB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fS4KICoKICovCmZ1bmN0aW9uICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckY2FjaGVGYWN0b3J5JywgZnVuY3Rpb24oJGNhY2hlRmFjdG9yeSkgewogICAgcmV0dXJuICRjYWNoZUZhY3RvcnkoJ3RlbXBsYXRlcycpOwogIH1dOwp9CgovKiAhIFZBUklBQkxFL0ZVTkNUSU9OIE5BTUlORyBDT05WRU5USU9OUyBUSEFUIEFQUExZIFRPIFRISVMgRklMRSEKICoKICogRE9NLXJlbGF0ZWQgdmFyaWFibGVzOgogKgogKiAtICJub2RlIiAtIERPTSBOb2RlCiAqIC0gImVsZW1lbnQiIC0gRE9NIEVsZW1lbnQgb3IgTm9kZQogKiAtICIkbm9kZSIgb3IgIiRlbGVtZW50IiAtIGpxTGl0ZS13cmFwcGVkIG5vZGUgb3IgZWxlbWVudAogKgogKgogKiBDb21waWxlciByZWxhdGVkIHN0dWZmOgogKgogKiAtICJsaW5rRm4iIC0gbGlua2luZyBmbiBvZiBhIHNpbmdsZSBkaXJlY3RpdmUKICogLSAibm9kZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIHBhcnRpY3VsYXIgbm9kZQogKiAtICJjaGlsZExpbmtGbiIgLSAgZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgY2hpbGQgbm9kZXMgb2YgYSBwYXJ0aWN1bGFyIG5vZGUKICogLSAiY29tcG9zaXRlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgY29tcGlsYXRpb24gcm9vdCAobm9kZUxpc3QpCiAqLwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkY29tcGlsZQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ29tcGlsZXMgYW4gSFRNTCBzdHJpbmcgb3IgRE9NIGludG8gYSB0ZW1wbGF0ZSBhbmQgcHJvZHVjZXMgYSB0ZW1wbGF0ZSBmdW5jdGlvbiwgd2hpY2gKICogY2FuIHRoZW4gYmUgdXNlZCB0byBsaW5rIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIGBzY29wZWB9IGFuZCB0aGUgdGVtcGxhdGUgdG9nZXRoZXIuCiAqCiAqIFRoZSBjb21waWxhdGlvbiBpcyBhIHByb2Nlc3Mgb2Ygd2Fsa2luZyB0aGUgRE9NIHRyZWUgYW5kIG1hdGNoaW5nIERPTSBlbGVtZW50cyB0bwogKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogVGhpcyBkb2N1bWVudCBpcyBhbiBpbi1kZXB0aCByZWZlcmVuY2Ugb2YgYWxsIGRpcmVjdGl2ZSBvcHRpb25zLgogKiBGb3IgYSBnZW50bGUgaW50cm9kdWN0aW9uIHRvIGRpcmVjdGl2ZXMgd2l0aCBleGFtcGxlcyBvZiBjb21tb24gdXNlIGNhc2VzLAogKiBzZWUgdGhlIHtAbGluayBndWlkZS9kaXJlY3RpdmUgZGlyZWN0aXZlIGd1aWRlfS4KICogPC9kaXY+CiAqCiAqICMjIENvbXByZWhlbnNpdmUgRGlyZWN0aXZlIEFQSQogKgogKiBUaGVyZSBhcmUgbWFueSBkaWZmZXJlbnQgb3B0aW9ucyBmb3IgYSBkaXJlY3RpdmUuCiAqCiAqIFRoZSBkaWZmZXJlbmNlIHJlc2lkZXMgaW4gdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZmFjdG9yeSBmdW5jdGlvbi4KICogWW91IGNhbiBlaXRoZXIgcmV0dXJuIGEgIkRpcmVjdGl2ZSBEZWZpbml0aW9uIE9iamVjdCIgKHNlZSBiZWxvdykgdGhhdCBkZWZpbmVzIHRoZSBkaXJlY3RpdmUgcHJvcGVydGllcywKICogb3IganVzdCB0aGUgYHBvc3RMaW5rYCBmdW5jdGlvbiAoYWxsIG90aGVyIHByb3BlcnRpZXMgd2lsbCBoYXZlIHRoZSBkZWZhdWx0IHZhbHVlcykuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXN1Y2Nlc3MiPgogKiAqKkJlc3QgUHJhY3RpY2U6KiogSXQncyByZWNvbW1lbmRlZCB0byB1c2UgdGhlICJkaXJlY3RpdmUgZGVmaW5pdGlvbiBvYmplY3QiIGZvcm0uCiAqIDwvZGl2PgogKgogKiBIZXJlJ3MgYW4gZXhhbXBsZSBkaXJlY3RpdmUgZGVjbGFyZWQgd2l0aCBhIERpcmVjdGl2ZSBEZWZpbml0aW9uIE9iamVjdDoKICoKICogYGBganMKICogICB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSguLi4pOwogKgogKiAgIG15TW9kdWxlLmRpcmVjdGl2ZSgnZGlyZWN0aXZlTmFtZScsIGZ1bmN0aW9uIGZhY3RvcnkoaW5qZWN0YWJsZXMpIHsKICogICAgIHZhciBkaXJlY3RpdmVEZWZpbml0aW9uT2JqZWN0ID0gewogKiAgICAgICBwcmlvcml0eTogMCwKICogICAgICAgdGVtcGxhdGU6ICc8ZGl2PjwvZGl2PicsIC8vIG9yIC8vIGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsgLi4uIH0sCiAqICAgICAgIC8vIG9yCiAqICAgICAgIC8vIHRlbXBsYXRlVXJsOiAnZGlyZWN0aXZlLmh0bWwnLCAvLyBvciAvLyBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7IC4uLiB9LAogKiAgICAgICB0cmFuc2NsdWRlOiBmYWxzZSwKICogICAgICAgcmVzdHJpY3Q6ICdBJywKICogICAgICAgc2NvcGU6IGZhbHNlLAogKiAgICAgICBjb250cm9sbGVyOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsICR0cmFuc2NsdWRlLCBvdGhlckluamVjdGFibGVzKSB7IC4uLiB9LAogKiAgICAgICBjb250cm9sbGVyQXM6ICdzdHJpbmdBbGlhcycsCiAqICAgICAgIHJlcXVpcmU6ICdzaWJsaW5nRGlyZWN0aXZlTmFtZScsIC8vIG9yIC8vIFsnXnBhcmVudERpcmVjdGl2ZU5hbWUnLCAnP29wdGlvbmFsRGlyZWN0aXZlTmFtZScsICc/Xm9wdGlvbmFsUGFyZW50J10sCiAqICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIGNvbXBpbGUodEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSkgewogKiAgICAgICAgIHJldHVybiB7CiAqICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIHByZUxpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIpIHsgLi4uIH0sCiAqICAgICAgICAgICBwb3N0OiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfQogKiAgICAgICAgIH0KICogICAgICAgICAvLyBvcgogKiAgICAgICAgIC8vIHJldHVybiBmdW5jdGlvbiBwb3N0TGluayggLi4uICkgeyAuLi4gfQogKiAgICAgICB9LAogKiAgICAgICAvLyBvcgogKiAgICAgICAvLyBsaW5rOiB7CiAqICAgICAgIC8vICBwcmU6IGZ1bmN0aW9uIHByZUxpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIpIHsgLi4uIH0sCiAqICAgICAgIC8vICBwb3N0OiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfQogKiAgICAgICAvLyB9CiAqICAgICAgIC8vIG9yCiAqICAgICAgIC8vIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKCAuLi4gKSB7IC4uLiB9CiAqICAgICB9OwogKiAgICAgcmV0dXJuIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3Q7CiAqICAgfSk7CiAqIGBgYAogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIEFueSB1bnNwZWNpZmllZCBvcHRpb25zIHdpbGwgdXNlIHRoZSBkZWZhdWx0IHZhbHVlLiBZb3UgY2FuIHNlZSB0aGUgZGVmYXVsdCB2YWx1ZXMgYmVsb3cuCiAqIDwvZGl2PgogKgogKiBUaGVyZWZvcmUgdGhlIGFib3ZlIGNhbiBiZSBzaW1wbGlmaWVkIGFzOgogKgogKiBgYGBqcwogKiAgIHZhciBteU1vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKC4uLik7CiAqCiAqICAgbXlNb2R1bGUuZGlyZWN0aXZlKCdkaXJlY3RpdmVOYW1lJywgZnVuY3Rpb24gZmFjdG9yeShpbmplY3RhYmxlcykgewogKiAgICAgdmFyIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3QgPSB7CiAqICAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzKSB7IC4uLiB9CiAqICAgICB9OwogKiAgICAgcmV0dXJuIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3Q7CiAqICAgICAvLyBvcgogKiAgICAgLy8gcmV0dXJuIGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzKSB7IC4uLiB9CiAqICAgfSk7CiAqIGBgYAogKgogKgogKgogKiAjIyMgRGlyZWN0aXZlIERlZmluaXRpb24gT2JqZWN0CiAqCiAqIFRoZSBkaXJlY3RpdmUgZGVmaW5pdGlvbiBvYmplY3QgcHJvdmlkZXMgaW5zdHJ1Y3Rpb25zIHRvIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUKICogY29tcGlsZXJ9LiBUaGUgYXR0cmlidXRlcyBhcmU6CiAqCiAqICMjIyMgYHByaW9yaXR5YAogKiBXaGVuIHRoZXJlIGFyZSBtdWx0aXBsZSBkaXJlY3RpdmVzIGRlZmluZWQgb24gYSBzaW5nbGUgRE9NIGVsZW1lbnQsIHNvbWV0aW1lcyBpdAogKiBpcyBuZWNlc3NhcnkgdG8gc3BlY2lmeSB0aGUgb3JkZXIgaW4gd2hpY2ggdGhlIGRpcmVjdGl2ZXMgYXJlIGFwcGxpZWQuIFRoZSBgcHJpb3JpdHlgIGlzIHVzZWQKICogdG8gc29ydCB0aGUgZGlyZWN0aXZlcyBiZWZvcmUgdGhlaXIgYGNvbXBpbGVgIGZ1bmN0aW9ucyBnZXQgY2FsbGVkLiBQcmlvcml0eSBpcyBkZWZpbmVkIGFzIGEKICogbnVtYmVyLiBEaXJlY3RpdmVzIHdpdGggZ3JlYXRlciBudW1lcmljYWwgYHByaW9yaXR5YCBhcmUgY29tcGlsZWQgZmlyc3QuIFByZS1saW5rIGZ1bmN0aW9ucwogKiBhcmUgYWxzbyBydW4gaW4gcHJpb3JpdHkgb3JkZXIsIGJ1dCBwb3N0LWxpbmsgZnVuY3Rpb25zIGFyZSBydW4gaW4gcmV2ZXJzZSBvcmRlci4gVGhlIG9yZGVyCiAqIG9mIGRpcmVjdGl2ZXMgd2l0aCB0aGUgc2FtZSBwcmlvcml0eSBpcyB1bmRlZmluZWQuIFRoZSBkZWZhdWx0IHByaW9yaXR5IGlzIGAwYC4KICoKICogIyMjIyBgdGVybWluYWxgCiAqIElmIHNldCB0byB0cnVlIHRoZW4gdGhlIGN1cnJlbnQgYHByaW9yaXR5YCB3aWxsIGJlIHRoZSBsYXN0IHNldCBvZiBkaXJlY3RpdmVzCiAqIHdoaWNoIHdpbGwgZXhlY3V0ZSAoYW55IGRpcmVjdGl2ZXMgYXQgdGhlIGN1cnJlbnQgcHJpb3JpdHkgd2lsbCBzdGlsbCBleGVjdXRlCiAqIGFzIHRoZSBvcmRlciBvZiBleGVjdXRpb24gb24gc2FtZSBgcHJpb3JpdHlgIGlzIHVuZGVmaW5lZCkuCiAqCiAqICMjIyMgYHNjb3BlYAogKiAqKklmIHNldCB0byBgdHJ1ZWAsKiogdGhlbiBhIG5ldyBzY29wZSB3aWxsIGJlIGNyZWF0ZWQgZm9yIHRoaXMgZGlyZWN0aXZlLiBJZiBtdWx0aXBsZSBkaXJlY3RpdmVzIG9uIHRoZQogKiBzYW1lIGVsZW1lbnQgcmVxdWVzdCBhIG5ldyBzY29wZSwgb25seSBvbmUgbmV3IHNjb3BlIGlzIGNyZWF0ZWQuIFRoZSBuZXcgc2NvcGUgcnVsZSBkb2VzIG5vdAogKiBhcHBseSBmb3IgdGhlIHJvb3Qgb2YgdGhlIHRlbXBsYXRlIHNpbmNlIHRoZSByb290IG9mIHRoZSB0ZW1wbGF0ZSBhbHdheXMgZ2V0cyBhIG5ldyBzY29wZS4KICoKICogKipJZiBzZXQgdG8gYHt9YCAob2JqZWN0IGhhc2gpLCoqIHRoZW4gYSBuZXcgImlzb2xhdGUiIHNjb3BlIGlzIGNyZWF0ZWQuIFRoZSAnaXNvbGF0ZScgc2NvcGUgZGlmZmVycyBmcm9tCiAqIG5vcm1hbCBzY29wZSBpbiB0aGF0IGl0IGRvZXMgbm90IHByb3RvdHlwaWNhbGx5IGluaGVyaXQgZnJvbSB0aGUgcGFyZW50IHNjb3BlLiBUaGlzIGlzIHVzZWZ1bAogKiB3aGVuIGNyZWF0aW5nIHJldXNhYmxlIGNvbXBvbmVudHMsIHdoaWNoIHNob3VsZCBub3QgYWNjaWRlbnRhbGx5IHJlYWQgb3IgbW9kaWZ5IGRhdGEgaW4gdGhlCiAqIHBhcmVudCBzY29wZS4KICoKICogVGhlICdpc29sYXRlJyBzY29wZSB0YWtlcyBhbiBvYmplY3QgaGFzaCB3aGljaCBkZWZpbmVzIGEgc2V0IG9mIGxvY2FsIHNjb3BlIHByb3BlcnRpZXMKICogZGVyaXZlZCBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFRoZXNlIGxvY2FsIHByb3BlcnRpZXMgYXJlIHVzZWZ1bCBmb3IgYWxpYXNpbmcgdmFsdWVzIGZvcgogKiB0ZW1wbGF0ZXMuIExvY2FscyBkZWZpbml0aW9uIGlzIGEgaGFzaCBvZiBsb2NhbCBzY29wZSBwcm9wZXJ0eSB0byBpdHMgc291cmNlOgogKgogKiAqIGBAYCBvciBgQGF0dHJgIC0gYmluZCBhIGxvY2FsIHNjb3BlIHByb3BlcnR5IHRvIHRoZSB2YWx1ZSBvZiBET00gYXR0cmlidXRlLiBUaGUgcmVzdWx0IGlzCiAqICAgYWx3YXlzIGEgc3RyaW5nIHNpbmNlIERPTSBhdHRyaWJ1dGVzIGFyZSBzdHJpbmdzLiBJZiBubyBgYXR0cmAgbmFtZSBpcyBzcGVjaWZpZWQgIHRoZW4gdGhlCiAqICAgYXR0cmlidXRlIG5hbWUgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2FtZSBhcyB0aGUgbG9jYWwgbmFtZS4KICogICBHaXZlbiBgPHdpZGdldCBteS1hdHRyPSJoZWxsbyB7e25hbWV9fSI+YCBhbmQgd2lkZ2V0IGRlZmluaXRpb24KICogICBvZiBgc2NvcGU6IHsgbG9jYWxOYW1lOidAbXlBdHRyJyB9YCwgdGhlbiB3aWRnZXQgc2NvcGUgcHJvcGVydHkgYGxvY2FsTmFtZWAgd2lsbCByZWZsZWN0CiAqICAgdGhlIGludGVycG9sYXRlZCB2YWx1ZSBvZiBgaGVsbG8ge3tuYW1lfX1gLiBBcyB0aGUgYG5hbWVgIGF0dHJpYnV0ZSBjaGFuZ2VzIHNvIHdpbGwgdGhlCiAqICAgYGxvY2FsTmFtZWAgcHJvcGVydHkgb24gdGhlIHdpZGdldCBzY29wZS4gVGhlIGBuYW1lYCBpcyByZWFkIGZyb20gdGhlIHBhcmVudCBzY29wZSAobm90CiAqICAgY29tcG9uZW50IHNjb3BlKS4KICoKICogKiBgPWAgb3IgYD1hdHRyYCAtIHNldCB1cCBiaS1kaXJlY3Rpb25hbCBiaW5kaW5nIGJldHdlZW4gYSBsb2NhbCBzY29wZSBwcm9wZXJ0eSBhbmQgdGhlCiAqICAgcGFyZW50IHNjb3BlIHByb3BlcnR5IG9mIG5hbWUgZGVmaW5lZCB2aWEgdGhlIHZhbHVlIG9mIHRoZSBgYXR0cmAgYXR0cmlidXRlLiBJZiBubyBgYXR0cmAKICogICBuYW1lIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBhdHRyaWJ1dGUgbmFtZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzYW1lIGFzIHRoZSBsb2NhbCBuYW1lLgogKiAgIEdpdmVuIGA8d2lkZ2V0IG15LWF0dHI9InBhcmVudE1vZGVsIj5gIGFuZCB3aWRnZXQgZGVmaW5pdGlvbiBvZgogKiAgIGBzY29wZTogeyBsb2NhbE1vZGVsOic9bXlBdHRyJyB9YCwgdGhlbiB3aWRnZXQgc2NvcGUgcHJvcGVydHkgYGxvY2FsTW9kZWxgIHdpbGwgcmVmbGVjdCB0aGUKICogICB2YWx1ZSBvZiBgcGFyZW50TW9kZWxgIG9uIHRoZSBwYXJlbnQgc2NvcGUuIEFueSBjaGFuZ2VzIHRvIGBwYXJlbnRNb2RlbGAgd2lsbCBiZSByZWZsZWN0ZWQKICogICBpbiBgbG9jYWxNb2RlbGAgYW5kIGFueSBjaGFuZ2VzIGluIGBsb2NhbE1vZGVsYCB3aWxsIHJlZmxlY3QgaW4gYHBhcmVudE1vZGVsYC4gSWYgdGhlIHBhcmVudAogKiAgIHNjb3BlIHByb3BlcnR5IGRvZXNuJ3QgZXhpc3QsIGl0IHdpbGwgdGhyb3cgYSBOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OIGV4Y2VwdGlvbi4gWW91CiAqICAgY2FuIGF2b2lkIHRoaXMgYmVoYXZpb3IgdXNpbmcgYD0/YCBvciBgPT9hdHRyYCBpbiBvcmRlciB0byBmbGFnIHRoZSBwcm9wZXJ0eSBhcyBvcHRpb25hbC4KICoKICogKiBgJmAgb3IgYCZhdHRyYCAtIHByb3ZpZGVzIGEgd2F5IHRvIGV4ZWN1dGUgYW4gZXhwcmVzc2lvbiBpbiB0aGUgY29udGV4dCBvZiB0aGUgcGFyZW50IHNjb3BlLgogKiAgIElmIG5vIGBhdHRyYCBuYW1lIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBhdHRyaWJ1dGUgbmFtZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzYW1lIGFzIHRoZQogKiAgIGxvY2FsIG5hbWUuIEdpdmVuIGA8d2lkZ2V0IG15LWF0dHI9ImNvdW50ID0gY291bnQgKyB2YWx1ZSI+YCBhbmQgd2lkZ2V0IGRlZmluaXRpb24gb2YKICogICBgc2NvcGU6IHsgbG9jYWxGbjonJm15QXR0cicgfWAsIHRoZW4gaXNvbGF0ZSBzY29wZSBwcm9wZXJ0eSBgbG9jYWxGbmAgd2lsbCBwb2ludCB0bwogKiAgIGEgZnVuY3Rpb24gd3JhcHBlciBmb3IgdGhlIGBjb3VudCA9IGNvdW50ICsgdmFsdWVgIGV4cHJlc3Npb24uIE9mdGVuIGl0J3MgZGVzaXJhYmxlIHRvCiAqICAgcGFzcyBkYXRhIGZyb20gdGhlIGlzb2xhdGVkIHNjb3BlIHZpYSBhbiBleHByZXNzaW9uIGFuZCB0byB0aGUgcGFyZW50IHNjb3BlLCB0aGlzIGNhbiBiZQogKiAgIGRvbmUgYnkgcGFzc2luZyBhIG1hcCBvZiBsb2NhbCB2YXJpYWJsZSBuYW1lcyBhbmQgdmFsdWVzIGludG8gdGhlIGV4cHJlc3Npb24gd3JhcHBlciBmbi4KICogICBGb3IgZXhhbXBsZSwgaWYgdGhlIGV4cHJlc3Npb24gaXMgYGluY3JlbWVudChhbW91bnQpYCB0aGVuIHdlIGNhbiBzcGVjaWZ5IHRoZSBhbW91bnQgdmFsdWUKICogICBieSBjYWxsaW5nIHRoZSBgbG9jYWxGbmAgYXMgYGxvY2FsRm4oe2Ftb3VudDogMjJ9KWAuCiAqCiAqCiAqCiAqICMjIyMgYGNvbnRyb2xsZXJgCiAqIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIFRoZSBjb250cm9sbGVyIGlzIGluc3RhbnRpYXRlZCBiZWZvcmUgdGhlCiAqIHByZS1saW5raW5nIHBoYXNlIGFuZCBpdCBpcyBzaGFyZWQgd2l0aCBvdGhlciBkaXJlY3RpdmVzIChzZWUKICogYHJlcXVpcmVgIGF0dHJpYnV0ZSkuIFRoaXMgYWxsb3dzIHRoZSBkaXJlY3RpdmVzIHRvIGNvbW11bmljYXRlIHdpdGggZWFjaCBvdGhlciBhbmQgYXVnbWVudAogKiBlYWNoIG90aGVyJ3MgYmVoYXZpb3IuIFRoZSBjb250cm9sbGVyIGlzIGluamVjdGFibGUgKGFuZCBzdXBwb3J0cyBicmFja2V0IG5vdGF0aW9uKSB3aXRoIHRoZSBmb2xsb3dpbmcgbG9jYWxzOgogKgogKiAqIGAkc2NvcGVgIC0gQ3VycmVudCBzY29wZSBhc3NvY2lhdGVkIHdpdGggdGhlIGVsZW1lbnQKICogKiBgJGVsZW1lbnRgIC0gQ3VycmVudCBlbGVtZW50CiAqICogYCRhdHRyc2AgLSBDdXJyZW50IGF0dHJpYnV0ZXMgb2JqZWN0IGZvciB0aGUgZWxlbWVudAogKiAqIGAkdHJhbnNjbHVkZWAgLSBBIHRyYW5zY2x1ZGUgbGlua2luZyBmdW5jdGlvbiBwcmUtYm91bmQgdG8gdGhlIGNvcnJlY3QgdHJhbnNjbHVzaW9uIHNjb3BlLgogKiAgICBUaGUgc2NvcGUgY2FuIGJlIG92ZXJyaWRkZW4gYnkgYW4gb3B0aW9uYWwgZmlyc3QgYXJndW1lbnQuCiAqICAgYGZ1bmN0aW9uKFtzY29wZV0sIGNsb25lTGlua2luZ0ZuKWAuCiAqCiAqCiAqICMjIyMgYHJlcXVpcmVgCiAqIFJlcXVpcmUgYW5vdGhlciBkaXJlY3RpdmUgYW5kIGluamVjdCBpdHMgY29udHJvbGxlciBhcyB0aGUgZm91cnRoIGFyZ3VtZW50IHRvIHRoZSBsaW5raW5nIGZ1bmN0aW9uLiBUaGUKICogYHJlcXVpcmVgIHRha2VzIGEgc3RyaW5nIG5hbWUgKG9yIGFycmF5IG9mIHN0cmluZ3MpIG9mIHRoZSBkaXJlY3RpdmUocykgdG8gcGFzcyBpbi4gSWYgYW4gYXJyYXkgaXMgdXNlZCwgdGhlCiAqIGluamVjdGVkIGFyZ3VtZW50IHdpbGwgYmUgYW4gYXJyYXkgaW4gY29ycmVzcG9uZGluZyBvcmRlci4gSWYgbm8gc3VjaCBkaXJlY3RpdmUgY2FuIGJlCiAqIGZvdW5kLCBvciBpZiB0aGUgZGlyZWN0aXZlIGRvZXMgbm90IGhhdmUgYSBjb250cm9sbGVyLCB0aGVuIGFuIGVycm9yIGlzIHJhaXNlZC4gVGhlIG5hbWUgY2FuIGJlIHByZWZpeGVkIHdpdGg6CiAqCiAqICogKG5vIHByZWZpeCkgLSBMb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgb24gdGhlIGN1cnJlbnQgZWxlbWVudC4gVGhyb3cgYW4gZXJyb3IgaWYgbm90IGZvdW5kLgogKiAqIGA/YCAtIEF0dGVtcHQgdG8gbG9jYXRlIHRoZSByZXF1aXJlZCBjb250cm9sbGVyIG9yIHBhc3MgYG51bGxgIHRvIHRoZSBgbGlua2AgZm4gaWYgbm90IGZvdW5kLgogKiAqIGBeYCAtIExvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBieSBzZWFyY2hpbmcgdGhlIGVsZW1lbnQncyBwYXJlbnRzLiBUaHJvdyBhbiBlcnJvciBpZiBub3QgZm91bmQuCiAqICogYD9eYCAtIEF0dGVtcHQgdG8gbG9jYXRlIHRoZSByZXF1aXJlZCBjb250cm9sbGVyIGJ5IHNlYXJjaGluZyB0aGUgZWxlbWVudCdzIHBhcmVudHMgb3IgcGFzcyBgbnVsbGAgdG8gdGhlCiAqICAgYGxpbmtgIGZuIGlmIG5vdCBmb3VuZC4KICoKICoKICogIyMjIyBgY29udHJvbGxlckFzYAogKiBDb250cm9sbGVyIGFsaWFzIGF0IHRoZSBkaXJlY3RpdmUgc2NvcGUuIEFuIGFsaWFzIGZvciB0aGUgY29udHJvbGxlciBzbyBpdAogKiBjYW4gYmUgcmVmZXJlbmNlZCBhdCB0aGUgZGlyZWN0aXZlIHRlbXBsYXRlLiBUaGUgZGlyZWN0aXZlIG5lZWRzIHRvIGRlZmluZSBhIHNjb3BlIGZvciB0aGlzCiAqIGNvbmZpZ3VyYXRpb24gdG8gYmUgdXNlZC4gVXNlZnVsIGluIHRoZSBjYXNlIHdoZW4gZGlyZWN0aXZlIGlzIHVzZWQgYXMgY29tcG9uZW50LgogKgogKgogKiAjIyMjIGByZXN0cmljdGAKICogU3RyaW5nIG9mIHN1YnNldCBvZiBgRUFDTWAgd2hpY2ggcmVzdHJpY3RzIHRoZSBkaXJlY3RpdmUgdG8gYSBzcGVjaWZpYyBkaXJlY3RpdmUKICogZGVjbGFyYXRpb24gc3R5bGUuIElmIG9taXR0ZWQsIHRoZSBkZWZhdWx0IChhdHRyaWJ1dGVzIG9ubHkpIGlzIHVzZWQuCiAqCiAqICogYEVgIC0gRWxlbWVudCBuYW1lOiBgPG15LWRpcmVjdGl2ZT48L215LWRpcmVjdGl2ZT5gCiAqICogYEFgIC0gQXR0cmlidXRlIChkZWZhdWx0KTogYDxkaXYgbXktZGlyZWN0aXZlPSJleHAiPjwvZGl2PmAKICogKiBgQ2AgLSBDbGFzczogYDxkaXYgY2xhc3M9Im15LWRpcmVjdGl2ZTogZXhwOyI+PC9kaXY+YAogKiAqIGBNYCAtIENvbW1lbnQ6IGA8IS0tIGRpcmVjdGl2ZTogbXktZGlyZWN0aXZlIGV4cCAtLT5gCiAqCiAqCiAqICMjIyMgYHRlbXBsYXRlYAogKiByZXBsYWNlIHRoZSBjdXJyZW50IGVsZW1lbnQgd2l0aCB0aGUgY29udGVudHMgb2YgdGhlIEhUTUwuIFRoZSByZXBsYWNlbWVudCBwcm9jZXNzCiAqIG1pZ3JhdGVzIGFsbCBvZiB0aGUgYXR0cmlidXRlcyAvIGNsYXNzZXMgZnJvbSB0aGUgb2xkIGVsZW1lbnQgdG8gdGhlIG5ldyBvbmUuIFNlZSB0aGUKICoge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSNjcmVhdGluZy1jdXN0b20tZGlyZWN0aXZlc19jcmVhdGluZy1kaXJlY3RpdmVzX3RlbXBsYXRlLWV4cGFuZGluZy1kaXJlY3RpdmUKICogRGlyZWN0aXZlcyBHdWlkZX0gZm9yIGFuIGV4YW1wbGUuCiAqCiAqIFlvdSBjYW4gc3BlY2lmeSBgdGVtcGxhdGVgIGFzIGEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgdGVtcGxhdGUgb3IgYXMgYSBmdW5jdGlvbiB3aGljaCB0YWtlcwogKiB0d28gYXJndW1lbnRzIGB0RWxlbWVudGAgYW5kIGB0QXR0cnNgIChkZXNjcmliZWQgaW4gdGhlIGBjb21waWxlYCBmdW5jdGlvbiBhcGkgYmVsb3cpIGFuZAogKiByZXR1cm5zIGEgc3RyaW5nIHZhbHVlIHJlcHJlc2VudGluZyB0aGUgdGVtcGxhdGUuCiAqCiAqCiAqICMjIyMgYHRlbXBsYXRlVXJsYAogKiBTYW1lIGFzIGB0ZW1wbGF0ZWAgYnV0IHRoZSB0ZW1wbGF0ZSBpcyBsb2FkZWQgZnJvbSB0aGUgc3BlY2lmaWVkIFVSTC4gQmVjYXVzZQogKiB0aGUgdGVtcGxhdGUgbG9hZGluZyBpcyBhc3luY2hyb25vdXMgdGhlIGNvbXBpbGF0aW9uL2xpbmtpbmcgaXMgc3VzcGVuZGVkIHVudGlsIHRoZSB0ZW1wbGF0ZQogKiBpcyBsb2FkZWQuCiAqCiAqIFlvdSBjYW4gc3BlY2lmeSBgdGVtcGxhdGVVcmxgIGFzIGEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgVVJMIG9yIGFzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgdHdvCiAqIGFyZ3VtZW50cyBgdEVsZW1lbnRgIGFuZCBgdEF0dHJzYCAoZGVzY3JpYmVkIGluIHRoZSBgY29tcGlsZWAgZnVuY3Rpb24gYXBpIGJlbG93KSBhbmQgcmV0dXJucwogKiBhIHN0cmluZyB2YWx1ZSByZXByZXNlbnRpbmcgdGhlIHVybC4gIEluIGVpdGhlciBjYXNlLCB0aGUgdGVtcGxhdGUgVVJMIGlzIHBhc3NlZCB0aHJvdWdoIHtAbGluawogKiBhcGkvbmcuJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwgJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9LgogKgogKgogKiAjIyMjIGByZXBsYWNlYCAoWypERVBSRUNBVEVEKiFdLCB3aWxsIGJlIHJlbW92ZWQgaW4gbmV4dCBtYWpvciByZWxlYXNlKQogKiBzcGVjaWZ5IHdoZXJlIHRoZSB0ZW1wbGF0ZSBzaG91bGQgYmUgaW5zZXJ0ZWQuIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAqCiAqICogYHRydWVgIC0gdGhlIHRlbXBsYXRlIHdpbGwgcmVwbGFjZSB0aGUgY3VycmVudCBlbGVtZW50LgogKiAqIGBmYWxzZWAgLSB0aGUgdGVtcGxhdGUgd2lsbCByZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgY3VycmVudCBlbGVtZW50LgogKgogKgogKiAjIyMjIGB0cmFuc2NsdWRlYAogKiBjb21waWxlIHRoZSBjb250ZW50IG9mIHRoZSBlbGVtZW50IGFuZCBtYWtlIGl0IGF2YWlsYWJsZSB0byB0aGUgZGlyZWN0aXZlLgogKiBUeXBpY2FsbHkgdXNlZCB3aXRoIHtAbGluayBuZy5kaXJlY3RpdmU6bmdUcmFuc2NsdWRlCiAqIG5nVHJhbnNjbHVkZX0uIFRoZSBhZHZhbnRhZ2Ugb2YgdHJhbnNjbHVzaW9uIGlzIHRoYXQgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmVjZWl2ZXMgYQogKiB0cmFuc2NsdXNpb24gZnVuY3Rpb24gd2hpY2ggaXMgcHJlLWJvdW5kIHRvIHRoZSBjb3JyZWN0IHNjb3BlLiBJbiBhIHR5cGljYWwgc2V0dXAgdGhlIHdpZGdldAogKiBjcmVhdGVzIGFuIGBpc29sYXRlYCBzY29wZSwgYnV0IHRoZSB0cmFuc2NsdXNpb24gaXMgbm90IGEgY2hpbGQsIGJ1dCBhIHNpYmxpbmcgb2YgdGhlIGBpc29sYXRlYAogKiBzY29wZS4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSBmb3IgdGhlIHdpZGdldCB0byBoYXZlIHByaXZhdGUgc3RhdGUsIGFuZCB0aGUgdHJhbnNjbHVzaW9uIHRvCiAqIGJlIGJvdW5kIHRvIHRoZSBwYXJlbnQgKHByZS1gaXNvbGF0ZWApIHNjb3BlLgogKgogKiAqIGB0cnVlYCAtIHRyYW5zY2x1ZGUgdGhlIGNvbnRlbnQgb2YgdGhlIGRpcmVjdGl2ZS4KICogKiBgJ2VsZW1lbnQnYCAtIHRyYW5zY2x1ZGUgdGhlIHdob2xlIGVsZW1lbnQgaW5jbHVkaW5nIGFueSBkaXJlY3RpdmVzIGRlZmluZWQgYXQgbG93ZXIgcHJpb3JpdHkuCiAqCiAqCiAqICMjIyMgYGNvbXBpbGVgCiAqCiAqIGBgYGpzCiAqICAgZnVuY3Rpb24gY29tcGlsZSh0RWxlbWVudCwgdEF0dHJzLCB0cmFuc2NsdWRlKSB7IC4uLiB9CiAqIGBgYAogKgogKiBUaGUgY29tcGlsZSBmdW5jdGlvbiBkZWFscyB3aXRoIHRyYW5zZm9ybWluZyB0aGUgdGVtcGxhdGUgRE9NLiBTaW5jZSBtb3N0IGRpcmVjdGl2ZXMgZG8gbm90IGRvCiAqIHRlbXBsYXRlIHRyYW5zZm9ybWF0aW9uLCBpdCBpcyBub3QgdXNlZCBvZnRlbi4gVGhlIGNvbXBpbGUgZnVuY3Rpb24gdGFrZXMgdGhlIGZvbGxvd2luZyBhcmd1bWVudHM6CiAqCiAqICAgKiBgdEVsZW1lbnRgIC0gdGVtcGxhdGUgZWxlbWVudCAtIFRoZSBlbGVtZW50IHdoZXJlIHRoZSBkaXJlY3RpdmUgaGFzIGJlZW4gZGVjbGFyZWQuIEl0IGlzCiAqICAgICBzYWZlIHRvIGRvIHRlbXBsYXRlIHRyYW5zZm9ybWF0aW9uIG9uIHRoZSBlbGVtZW50IGFuZCBjaGlsZCBlbGVtZW50cyBvbmx5LgogKgogKiAgICogYHRBdHRyc2AgLSB0ZW1wbGF0ZSBhdHRyaWJ1dGVzIC0gTm9ybWFsaXplZCBsaXN0IG9mIGF0dHJpYnV0ZXMgZGVjbGFyZWQgb24gdGhpcyBlbGVtZW50IHNoYXJlZAogKiAgICAgYmV0d2VlbiBhbGwgZGlyZWN0aXZlIGNvbXBpbGUgZnVuY3Rpb25zLgogKgogKiAgICogYHRyYW5zY2x1ZGVgIC0gIFsqREVQUkVDQVRFRCohXSBBIHRyYW5zY2x1ZGUgbGlua2luZyBmdW5jdGlvbjogYGZ1bmN0aW9uKHNjb3BlLCBjbG9uZUxpbmtpbmdGbilgCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogVGhlIHRlbXBsYXRlIGluc3RhbmNlIGFuZCB0aGUgbGluayBpbnN0YW5jZSBtYXkgYmUgZGlmZmVyZW50IG9iamVjdHMgaWYgdGhlIHRlbXBsYXRlIGhhcwogKiBiZWVuIGNsb25lZC4gRm9yIHRoaXMgcmVhc29uIGl0IGlzICoqbm90Kiogc2FmZSB0byBkbyBhbnl0aGluZyBvdGhlciB0aGFuIERPTSB0cmFuc2Zvcm1hdGlvbnMgdGhhdAogKiBhcHBseSB0byBhbGwgY2xvbmVkIERPTSBub2RlcyB3aXRoaW4gdGhlIGNvbXBpbGUgZnVuY3Rpb24uIFNwZWNpZmljYWxseSwgRE9NIGxpc3RlbmVyIHJlZ2lzdHJhdGlvbgogKiBzaG91bGQgYmUgZG9uZSBpbiBhIGxpbmtpbmcgZnVuY3Rpb24gcmF0aGVyIHRoYW4gaW4gYSBjb21waWxlIGZ1bmN0aW9uLgogKiA8L2Rpdj4KCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogVGhlIGNvbXBpbGUgZnVuY3Rpb24gY2Fubm90IGhhbmRsZSBkaXJlY3RpdmVzIHRoYXQgcmVjdXJzaXZlbHkgdXNlIHRoZW1zZWx2ZXMgaW4gdGhlaXIKICogb3duIHRlbXBsYXRlcyBvciBjb21waWxlIGZ1bmN0aW9ucy4gQ29tcGlsaW5nIHRoZXNlIGRpcmVjdGl2ZXMgcmVzdWx0cyBpbiBhbiBpbmZpbml0ZSBsb29wIGFuZCBhCiAqIHN0YWNrIG92ZXJmbG93IGVycm9ycy4KICoKICogVGhpcyBjYW4gYmUgYXZvaWRlZCBieSBtYW51YWxseSB1c2luZyAkY29tcGlsZSBpbiB0aGUgcG9zdExpbmsgZnVuY3Rpb24gdG8gaW1wZXJhdGl2ZWx5IGNvbXBpbGUKICogYSBkaXJlY3RpdmUncyB0ZW1wbGF0ZSBpbnN0ZWFkIG9mIHJlbHlpbmcgb24gYXV0b21hdGljIHRlbXBsYXRlIGNvbXBpbGF0aW9uIHZpYSBgdGVtcGxhdGVgIG9yCiAqIGB0ZW1wbGF0ZVVybGAgZGVjbGFyYXRpb24gb3IgbWFudWFsIGNvbXBpbGF0aW9uIGluc2lkZSB0aGUgY29tcGlsZSBmdW5jdGlvbi4KICogPC9kaXY+CiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWVycm9yIj4KICogKipOb3RlOioqIFRoZSBgdHJhbnNjbHVkZWAgZnVuY3Rpb24gdGhhdCBpcyBwYXNzZWQgdG8gdGhlIGNvbXBpbGUgZnVuY3Rpb24gaXMgZGVwcmVjYXRlZCwgYXMgaXQKICogICBlLmcuIGRvZXMgbm90IGtub3cgYWJvdXQgdGhlIHJpZ2h0IG91dGVyIHNjb3BlLiBQbGVhc2UgdXNlIHRoZSB0cmFuc2NsdWRlIGZ1bmN0aW9uIHRoYXQgaXMgcGFzc2VkCiAqICAgdG8gdGhlIGxpbmsgZnVuY3Rpb24gaW5zdGVhZC4KICogPC9kaXY+CgogKiBBIGNvbXBpbGUgZnVuY3Rpb24gY2FuIGhhdmUgYSByZXR1cm4gdmFsdWUgd2hpY2ggY2FuIGJlIGVpdGhlciBhIGZ1bmN0aW9uIG9yIGFuIG9iamVjdC4KICoKICogKiByZXR1cm5pbmcgYSAocG9zdC1saW5rKSBmdW5jdGlvbiAtIGlzIGVxdWl2YWxlbnQgdG8gcmVnaXN0ZXJpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gdmlhIHRoZQogKiAgIGBsaW5rYCBwcm9wZXJ0eSBvZiB0aGUgY29uZmlnIG9iamVjdCB3aGVuIHRoZSBjb21waWxlIGZ1bmN0aW9uIGlzIGVtcHR5LgogKgogKiAqIHJldHVybmluZyBhbiBvYmplY3Qgd2l0aCBmdW5jdGlvbihzKSByZWdpc3RlcmVkIHZpYSBgcHJlYCBhbmQgYHBvc3RgIHByb3BlcnRpZXMgLSBhbGxvd3MgeW91IHRvCiAqICAgY29udHJvbCB3aGVuIGEgbGlua2luZyBmdW5jdGlvbiBzaG91bGQgYmUgY2FsbGVkIGR1cmluZyB0aGUgbGlua2luZyBwaGFzZS4gU2VlIGluZm8gYWJvdXQKICogICBwcmUtbGlua2luZyBhbmQgcG9zdC1saW5raW5nIGZ1bmN0aW9ucyBiZWxvdy4KICoKICoKICogIyMjIyBgbGlua2AKICogVGhpcyBwcm9wZXJ0eSBpcyB1c2VkIG9ubHkgaWYgdGhlIGBjb21waWxlYCBwcm9wZXJ0eSBpcyBub3QgZGVmaW5lZC4KICoKICogYGBganMKICogICBmdW5jdGlvbiBsaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzLCBjb250cm9sbGVyLCB0cmFuc2NsdWRlRm4pIHsgLi4uIH0KICogYGBgCiAqCiAqIFRoZSBsaW5rIGZ1bmN0aW9uIGlzIHJlc3BvbnNpYmxlIGZvciByZWdpc3RlcmluZyBET00gbGlzdGVuZXJzIGFzIHdlbGwgYXMgdXBkYXRpbmcgdGhlIERPTS4gSXQgaXMKICogZXhlY3V0ZWQgYWZ0ZXIgdGhlIHRlbXBsYXRlIGhhcyBiZWVuIGNsb25lZC4gVGhpcyBpcyB3aGVyZSBtb3N0IG9mIHRoZSBkaXJlY3RpdmUgbG9naWMgd2lsbCBiZQogKiBwdXQuCiAqCiAqICAgKiBgc2NvcGVgIC0ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IC0gVGhlIHNjb3BlIHRvIGJlIHVzZWQgYnkgdGhlCiAqICAgICBkaXJlY3RpdmUgZm9yIHJlZ2lzdGVyaW5nIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVzfS4KICoKICogICAqIGBpRWxlbWVudGAgLSBpbnN0YW5jZSBlbGVtZW50IC0gVGhlIGVsZW1lbnQgd2hlcmUgdGhlIGRpcmVjdGl2ZSBpcyB0byBiZSB1c2VkLiBJdCBpcyBzYWZlIHRvCiAqICAgICBtYW5pcHVsYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGUgZWxlbWVudCBvbmx5IGluIGBwb3N0TGlua2AgZnVuY3Rpb24gc2luY2UgdGhlIGNoaWxkcmVuIGhhdmUKICogICAgIGFscmVhZHkgYmVlbiBsaW5rZWQuCiAqCiAqICAgKiBgaUF0dHJzYCAtIGluc3RhbmNlIGF0dHJpYnV0ZXMgLSBOb3JtYWxpemVkIGxpc3Qgb2YgYXR0cmlidXRlcyBkZWNsYXJlZCBvbiB0aGlzIGVsZW1lbnQgc2hhcmVkCiAqICAgICBiZXR3ZWVuIGFsbCBkaXJlY3RpdmUgbGlua2luZyBmdW5jdGlvbnMuCiAqCiAqICAgKiBgY29udHJvbGxlcmAgLSBhIGNvbnRyb2xsZXIgaW5zdGFuY2UgLSBBIGNvbnRyb2xsZXIgaW5zdGFuY2UgaWYgYXQgbGVhc3Qgb25lIGRpcmVjdGl2ZSBvbiB0aGUKICogICAgIGVsZW1lbnQgZGVmaW5lcyBhIGNvbnRyb2xsZXIuIFRoZSBjb250cm9sbGVyIGlzIHNoYXJlZCBhbW9uZyBhbGwgdGhlIGRpcmVjdGl2ZXMsIHdoaWNoIGFsbG93cwogKiAgICAgdGhlIGRpcmVjdGl2ZXMgdG8gdXNlIHRoZSBjb250cm9sbGVycyBhcyBhIGNvbW11bmljYXRpb24gY2hhbm5lbC4KICoKICogICAqIGB0cmFuc2NsdWRlRm5gIC0gQSB0cmFuc2NsdWRlIGxpbmtpbmcgZnVuY3Rpb24gcHJlLWJvdW5kIHRvIHRoZSBjb3JyZWN0IHRyYW5zY2x1c2lvbiBzY29wZS4KICogICAgIFRoZSBzY29wZSBjYW4gYmUgb3ZlcnJpZGRlbiBieSBhbiBvcHRpb25hbCBmaXJzdCBhcmd1bWVudC4gVGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgYCR0cmFuc2NsdWRlYAogKiAgICAgcGFyYW1ldGVyIG9mIGRpcmVjdGl2ZSBjb250cm9sbGVycy4KICogICAgIGBmdW5jdGlvbihbc2NvcGVdLCBjbG9uZUxpbmtpbmdGbilgLgogKgogKgogKiAjIyMjIFByZS1saW5raW5nIGZ1bmN0aW9uCiAqCiAqIEV4ZWN1dGVkIGJlZm9yZSB0aGUgY2hpbGQgZWxlbWVudHMgYXJlIGxpbmtlZC4gTm90IHNhZmUgdG8gZG8gRE9NIHRyYW5zZm9ybWF0aW9uIHNpbmNlIHRoZQogKiBjb21waWxlciBsaW5raW5nIGZ1bmN0aW9uIHdpbGwgZmFpbCB0byBsb2NhdGUgdGhlIGNvcnJlY3QgZWxlbWVudHMgZm9yIGxpbmtpbmcuCiAqCiAqICMjIyMgUG9zdC1saW5raW5nIGZ1bmN0aW9uCiAqCiAqIEV4ZWN1dGVkIGFmdGVyIHRoZSBjaGlsZCBlbGVtZW50cyBhcmUgbGlua2VkLiBJdCBpcyBzYWZlIHRvIGRvIERPTSB0cmFuc2Zvcm1hdGlvbiBpbiB0aGUgcG9zdC1saW5raW5nIGZ1bmN0aW9uLgogKgogKiA8YSBuYW1lPSJBdHRyaWJ1dGVzIj48L2E+CiAqICMjIyBBdHRyaWJ1dGVzCiAqCiAqIFRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMgQXR0cmlidXRlc30gb2JqZWN0IC0gcGFzc2VkIGFzIGEgcGFyYW1ldGVyIGluIHRoZQogKiBgbGluaygpYCBvciBgY29tcGlsZSgpYCBmdW5jdGlvbnMuIEl0IGhhcyBhIHZhcmlldHkgb2YgdXNlcy4KICoKICogYWNjZXNzaW5nICpOb3JtYWxpemVkIGF0dHJpYnV0ZSBuYW1lczoqCiAqIERpcmVjdGl2ZXMgbGlrZSAnbmdCaW5kJyBjYW4gYmUgZXhwcmVzc2VkIGluIG1hbnkgd2F5czogJ25nOmJpbmQnLCBgZGF0YS1uZy1iaW5kYCwgb3IgJ3gtbmctYmluZCcuCiAqIHRoZSBhdHRyaWJ1dGVzIG9iamVjdCBhbGxvd3MgZm9yIG5vcm1hbGl6ZWQgYWNjZXNzIHRvCiAqICAgdGhlIGF0dHJpYnV0ZXMuCiAqCiAqICogKkRpcmVjdGl2ZSBpbnRlci1jb21tdW5pY2F0aW9uOiogQWxsIGRpcmVjdGl2ZXMgc2hhcmUgdGhlIHNhbWUgaW5zdGFuY2Ugb2YgdGhlIGF0dHJpYnV0ZXMKICogICBvYmplY3Qgd2hpY2ggYWxsb3dzIHRoZSBkaXJlY3RpdmVzIHRvIHVzZSB0aGUgYXR0cmlidXRlcyBvYmplY3QgYXMgaW50ZXIgZGlyZWN0aXZlCiAqICAgY29tbXVuaWNhdGlvbi4KICoKICogKiAqU3VwcG9ydHMgaW50ZXJwb2xhdGlvbjoqIEludGVycG9sYXRpb24gYXR0cmlidXRlcyBhcmUgYXNzaWduZWQgdG8gdGhlIGF0dHJpYnV0ZSBvYmplY3QKICogICBhbGxvd2luZyBvdGhlciBkaXJlY3RpdmVzIHRvIHJlYWQgdGhlIGludGVycG9sYXRlZCB2YWx1ZS4KICoKICogKiAqT2JzZXJ2aW5nIGludGVycG9sYXRlZCBhdHRyaWJ1dGVzOiogVXNlIGAkb2JzZXJ2ZWAgdG8gb2JzZXJ2ZSB0aGUgdmFsdWUgY2hhbmdlcyBvZiBhdHRyaWJ1dGVzCiAqICAgdGhhdCBjb250YWluIGludGVycG9sYXRpb24gKGUuZy4gYHNyYz0ie3tiYXJ9fSJgKS4gTm90IG9ubHkgaXMgdGhpcyB2ZXJ5IGVmZmljaWVudCBidXQgaXQncyBhbHNvCiAqICAgdGhlIG9ubHkgd2F5IHRvIGVhc2lseSBnZXQgdGhlIGFjdHVhbCB2YWx1ZSBiZWNhdXNlIGR1cmluZyB0aGUgbGlua2luZyBwaGFzZSB0aGUgaW50ZXJwb2xhdGlvbgogKiAgIGhhc24ndCBiZWVuIGV2YWx1YXRlZCB5ZXQgYW5kIHNvIHRoZSB2YWx1ZSBpcyBhdCB0aGlzIHRpbWUgc2V0IHRvIGB1bmRlZmluZWRgLgogKgogKiBgYGBqcwogKiBmdW5jdGlvbiBsaW5raW5nRm4oc2NvcGUsIGVsbSwgYXR0cnMsIGN0cmwpIHsKICogICAvLyBnZXQgdGhlIGF0dHJpYnV0ZSB2YWx1ZQogKiAgIGNvbnNvbGUubG9nKGF0dHJzLm5nTW9kZWwpOwogKgogKiAgIC8vIGNoYW5nZSB0aGUgYXR0cmlidXRlCiAqICAgYXR0cnMuJHNldCgnbmdNb2RlbCcsICduZXcgdmFsdWUnKTsKICoKICogICAvLyBvYnNlcnZlIGNoYW5nZXMgdG8gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZQogKiAgIGF0dHJzLiRvYnNlcnZlKCduZ01vZGVsJywgZnVuY3Rpb24odmFsdWUpIHsKICogICAgIGNvbnNvbGUubG9nKCduZ01vZGVsIGhhcyBjaGFuZ2VkIHZhbHVlIHRvICcgKyB2YWx1ZSk7CiAqICAgfSk7CiAqIH0KICogYGBgCiAqCiAqIEJlbG93IGlzIGFuIGV4YW1wbGUgdXNpbmcgYCRjb21waWxlUHJvdmlkZXJgLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlKio6IFR5cGljYWxseSBkaXJlY3RpdmVzIGFyZSByZWdpc3RlcmVkIHdpdGggYG1vZHVsZS5kaXJlY3RpdmVgLiBUaGUgZXhhbXBsZSBiZWxvdyBpcwogKiB0byBpbGx1c3RyYXRlIGhvdyBgJGNvbXBpbGVgIHdvcmtzLgogKiA8L2Rpdj4KICoKIDxleGFtcGxlIG1vZHVsZT0iY29tcGlsZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgPHNjcmlwdD4KICAgICAgYW5ndWxhci5tb2R1bGUoJ2NvbXBpbGUnLCBbXSwgZnVuY3Rpb24oJGNvbXBpbGVQcm92aWRlcikgewogICAgICAgIC8vIGNvbmZpZ3VyZSBuZXcgJ2NvbXBpbGUnIGRpcmVjdGl2ZSBieSBwYXNzaW5nIGEgZGlyZWN0aXZlCiAgICAgICAgLy8gZmFjdG9yeSBmdW5jdGlvbi4gVGhlIGZhY3RvcnkgZnVuY3Rpb24gaW5qZWN0cyB0aGUgJyRjb21waWxlJwogICAgICAgICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCdjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICAgICAgICAgIC8vIGRpcmVjdGl2ZSBmYWN0b3J5IGNyZWF0ZXMgYSBsaW5rIGZ1bmN0aW9uCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbihzY29wZSkgewogICAgICAgICAgICAgICAgIC8vIHdhdGNoIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBmb3IgY2hhbmdlcwogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmNvbXBpbGUpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlICdjb21waWxlJyBleHByZXNzaW9uIGNoYW5nZXMKICAgICAgICAgICAgICAgIC8vIGFzc2lnbiBpdCBpbnRvIHRoZSBjdXJyZW50IERPTQogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBuZXcgRE9NIGFuZCBsaW5rIGl0IHRvIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAvLyBzY29wZS4KICAgICAgICAgICAgICAgIC8vIE5PVEU6IHdlIG9ubHkgY29tcGlsZSAuY2hpbGROb2RlcyBzbyB0aGF0CiAgICAgICAgICAgICAgICAvLyB3ZSBkb24ndCBnZXQgaW50byBpbmZpbml0ZSBsb29wIGNvbXBpbGluZyBvdXJzZWx2ZXMKICAgICAgICAgICAgICAgICRjb21waWxlKGVsZW1lbnQuY29udGVudHMoKSkoc2NvcGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgfSkKICAgICAgfSk7CgogICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS5uYW1lID0gJ0FuZ3VsYXInOwogICAgICAgICRzY29wZS5odG1sID0gJ0hlbGxvIHt7bmFtZX19JzsKICAgICAgfQogICAgPC9zY3JpcHQ+CiAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICA8aW5wdXQgbmctbW9kZWw9Im5hbWUiPiA8YnI+CiAgICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0iaHRtbCI+PC90ZXh0YXJlYT4gPGJyPgogICAgICA8ZGl2IGNvbXBpbGU9Imh0bWwiPjwvZGl2PgogICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgaXQoJ3Nob3VsZCBhdXRvIGNvbXBpbGUnLCBmdW5jdGlvbigpIHsKICAgICAgIHZhciB0ZXh0YXJlYSA9ICQoJ3RleHRhcmVhJyk7CiAgICAgICB2YXIgb3V0cHV0ID0gJCgnZGl2W2NvbXBpbGVdJyk7CiAgICAgICAvLyBUaGUgaW5pdGlhbCBzdGF0ZSByZWFkcyAnSGVsbG8gQW5ndWxhcicuCiAgICAgICBleHBlY3Qob3V0cHV0LmdldFRleHQoKSkudG9CZSgnSGVsbG8gQW5ndWxhcicpOwogICAgICAgdGV4dGFyZWEuY2xlYXIoKTsKICAgICAgIHRleHRhcmVhLnNlbmRLZXlzKCd7e25hbWV9fSEnKTsKICAgICAgIGV4cGVjdChvdXRwdXQuZ2V0VGV4dCgpKS50b0JlKCdBbmd1bGFyIScpOwogICAgIH0pOwogICA8L2ZpbGU+CiA8L2V4YW1wbGU+CgogKgogKgogKiBAcGFyYW0ge3N0cmluZ3xET01FbGVtZW50fSBlbGVtZW50IEVsZW1lbnQgb3IgSFRNTCBzdHJpbmcgdG8gY29tcGlsZSBpbnRvIGEgdGVtcGxhdGUgZnVuY3Rpb24uCiAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZSwgY2xvbmVBdHRhY2hGbj0pfSB0cmFuc2NsdWRlIGZ1bmN0aW9uIGF2YWlsYWJsZSB0byBkaXJlY3RpdmVzLgogKiBAcGFyYW0ge251bWJlcn0gbWF4UHJpb3JpdHkgb25seSBhcHBseSBkaXJlY3RpdmVzIGxvd2VyIHRoYW4gZ2l2ZW4gcHJpb3JpdHkgKE9ubHkgZWZmZWN0cyB0aGUKICogICAgICAgICAgICAgICAgIHJvb3QgZWxlbWVudChzKSwgbm90IHRoZWlyIGNoaWxkcmVuKQogKiBAcmV0dXJucyB7ZnVuY3Rpb24oc2NvcGUsIGNsb25lQXR0YWNoRm49KX0gYSBsaW5rIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogKiAoYSBET00gZWxlbWVudC90cmVlKSB0byBhIHNjb3BlLiBXaGVyZToKICoKICogICogYHNjb3BlYCAtIEEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uCiAqICAqIGBjbG9uZUF0dGFjaEZuYCAtIElmIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZCwgdGhlbiB0aGUgbGluayBmdW5jdGlvbiB3aWxsIGNsb25lIHRoZQogKiAgYHRlbXBsYXRlYCBhbmQgY2FsbCB0aGUgYGNsb25lQXR0YWNoRm5gIGZ1bmN0aW9uIGFsbG93aW5nIHRoZSBjYWxsZXIgdG8gYXR0YWNoIHRoZQogKiAgY2xvbmVkIGVsZW1lbnRzIHRvIHRoZSBET00gZG9jdW1lbnQgYXQgdGhlIGFwcHJvcHJpYXRlIHBsYWNlLiBUaGUgYGNsb25lQXR0YWNoRm5gIGlzCiAqICBjYWxsZWQgYXM6IDxicj4gYGNsb25lQXR0YWNoRm4oY2xvbmVkRWxlbWVudCwgc2NvcGUpYCB3aGVyZToKICoKICogICAgICAqIGBjbG9uZWRFbGVtZW50YCAtIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGBlbGVtZW50YCBwYXNzZWQgaW50byB0aGUgY29tcGlsZXIuCiAqICAgICAgKiBgc2NvcGVgIC0gaXMgdGhlIGN1cnJlbnQgc2NvcGUgd2l0aCB3aGljaCB0aGUgbGlua2luZyBmdW5jdGlvbiBpcyB3b3JraW5nIHdpdGguCiAqCiAqIENhbGxpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmV0dXJucyB0aGUgZWxlbWVudCBvZiB0aGUgdGVtcGxhdGUuIEl0IGlzIGVpdGhlciB0aGUgb3JpZ2luYWwKICogZWxlbWVudCBwYXNzZWQgaW4sIG9yIHRoZSBjbG9uZSBvZiB0aGUgZWxlbWVudCBpZiB0aGUgYGNsb25lQXR0YWNoRm5gIGlzIHByb3ZpZGVkLgogKgogKiBBZnRlciBsaW5raW5nIHRoZSB2aWV3IGlzIG5vdCB1cGRhdGVkIHVudGlsIGFmdGVyIGEgY2FsbCB0byAkZGlnZXN0IHdoaWNoIHR5cGljYWxseSBpcyBkb25lIGJ5CiAqIEFuZ3VsYXIgYXV0b21hdGljYWxseS4KICoKICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAqCiAqIC0gSWYgeW91IGFyZSBub3QgYXNraW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHRvIGNsb25lIHRoZSB0ZW1wbGF0ZSwgY3JlYXRlIHRoZSBET00gZWxlbWVudChzKQogKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAqICAgYGBganMKICogICAgIHZhciBlbGVtZW50ID0gJGNvbXBpbGUoJzxwPnt7dG90YWx9fTwvcD4nKShzY29wZSk7CiAqICAgYGBgCiAqCiAqIC0gaWYgb24gdGhlIG90aGVyIGhhbmQsIHlvdSBuZWVkIHRoZSBlbGVtZW50IHRvIGJlIGNsb25lZCwgdGhlIHZpZXcgcmVmZXJlbmNlIGZyb20gdGhlIG9yaWdpbmFsCiAqICAgZXhhbXBsZSB3b3VsZCBub3QgcG9pbnQgdG8gdGhlIGNsb25lLCBidXQgcmF0aGVyIHRvIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZSB0aGF0IHdhcyBjbG9uZWQuIEluCiAqICAgdGhpcyBjYXNlLCB5b3UgY2FuIGFjY2VzcyB0aGUgY2xvbmUgdmlhIHRoZSBjbG9uZUF0dGFjaEZuOgogKiAgIGBgYGpzCiAqICAgICB2YXIgdGVtcGxhdGVFbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAqICAgICAgICAgc2NvcGUgPSAuLi4uOwogKgogKiAgICAgdmFyIGNsb25lZEVsZW1lbnQgPSAkY29tcGlsZSh0ZW1wbGF0ZUVsZW1lbnQpKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkgewogKiAgICAgICAvL2F0dGFjaCB0aGUgY2xvbmUgdG8gRE9NIGRvY3VtZW50IGF0IHRoZSByaWdodCBwbGFjZQogKiAgICAgfSk7CiAqCiAqICAgICAvL25vdyB3ZSBoYXZlIHJlZmVyZW5jZSB0byB0aGUgY2xvbmVkIERPTSB2aWEgYGNsb25lZEVsZW1lbnRgCiAqICAgYGBgCiAqCiAqCiAqIEZvciBpbmZvcm1hdGlvbiBvbiBob3cgdGhlIGNvbXBpbGVyIHdvcmtzLCBzZWUgdGhlCiAqIHtAbGluayBndWlkZS9jb21waWxlciBBbmd1bGFyIEhUTUwgQ29tcGlsZXJ9IHNlY3Rpb24gb2YgdGhlIERldmVsb3BlciBHdWlkZS4KICovCgp2YXIgJGNvbXBpbGVNaW5FcnIgPSBtaW5FcnIoJyRjb21waWxlJyk7CgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqLwokQ29tcGlsZVByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJywgJyQkc2FuaXRpemVVcmlQcm92aWRlciddOwpmdW5jdGlvbiAkQ29tcGlsZVByb3ZpZGVyKCRwcm92aWRlLCAkJHNhbml0aXplVXJpUHJvdmlkZXIpIHsKICB2YXIgaGFzRGlyZWN0aXZlcyA9IHt9LAogICAgICBTdWZmaXggPSAnRGlyZWN0aXZlJywKICAgICAgQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQID0gL15ccypkaXJlY3RpdmVcOlxzKihbXGRcd19cLV0rKVxzKyguKikkLywKICAgICAgQ0xBU1NfRElSRUNUSVZFX1JFR0VYUCA9IC8oKFtcZFx3X1wtXSspKD86XDooW147XSspKT87PykvOwoKICAvLyBSZWY6IGh0dHA6Ly9kZXZlbG9wZXJzLndoYXR3Zy5vcmcvd2ViYXBwYXBpcy5odG1sI2V2ZW50LWhhbmRsZXItaWRsLWF0dHJpYnV0ZXMKICAvLyBUaGUgYXNzdW1wdGlvbiBpcyB0aGF0IGZ1dHVyZSBET00gZXZlbnQgYXR0cmlidXRlIG5hbWVzIHdpbGwgYmVnaW4gd2l0aAogIC8vICdvbicgYW5kIGJlIGNvbXBvc2VkIG9mIG9ubHkgRW5nbGlzaCBsZXR0ZXJzLgogIHZhciBFVkVOVF9IQU5ETEVSX0FUVFJfUkVHRVhQID0gL14ob25bYS16XSt8Zm9ybWFjdGlvbikkLzsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVyIGEgbmV3IGRpcmVjdGl2ZSB3aXRoIHRoZSBjb21waWxlci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBOYW1lIG9mIHRoZSBkaXJlY3RpdmUgaW4gY2FtZWwtY2FzZSAoaS5lLiA8Y29kZT5uZ0JpbmQ8L2NvZGU+IHdoaWNoCiAgICogICAgd2lsbCBtYXRjaCBhcyA8Y29kZT5uZy1iaW5kPC9jb2RlPiksIG9yIGFuIG9iamVjdCBtYXAgb2YgZGlyZWN0aXZlcyB3aGVyZSB0aGUga2V5cyBhcmUgdGhlCiAgICogICAgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBmYWN0b3JpZXMuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxBcnJheX0gZGlyZWN0aXZlRmFjdG9yeSBBbiBpbmplY3RhYmxlIGRpcmVjdGl2ZSBmYWN0b3J5IGZ1bmN0aW9uLiBTZWUKICAgKiAgICB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlfSBmb3IgbW9yZSBpbmZvLgogICAqIEByZXR1cm5zIHtuZy4kY29tcGlsZVByb3ZpZGVyfSBTZWxmIGZvciBjaGFpbmluZy4KICAgKi8KICAgdGhpcy5kaXJlY3RpdmUgPSBmdW5jdGlvbiByZWdpc3RlckRpcmVjdGl2ZShuYW1lLCBkaXJlY3RpdmVGYWN0b3J5KSB7CiAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnZGlyZWN0aXZlJyk7CiAgICBpZiAoaXNTdHJpbmcobmFtZSkpIHsKICAgICAgYXNzZXJ0QXJnKGRpcmVjdGl2ZUZhY3RvcnksICdkaXJlY3RpdmVGYWN0b3J5Jyk7CiAgICAgIGlmICghaGFzRGlyZWN0aXZlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0gPSBbXTsKICAgICAgICAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBTdWZmaXgsIFsnJGluamVjdG9yJywgJyRleGNlcHRpb25IYW5kbGVyJywKICAgICAgICAgIGZ1bmN0aW9uKCRpbmplY3RvciwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZXMgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChoYXNEaXJlY3RpdmVzW25hbWVdLCBmdW5jdGlvbihkaXJlY3RpdmVGYWN0b3J5LCBpbmRleCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlID0gJGluamVjdG9yLmludm9rZShkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGRpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlID0geyBjb21waWxlOiB2YWx1ZUZuKGRpcmVjdGl2ZSkgfTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRpcmVjdGl2ZS5jb21waWxlICYmIGRpcmVjdGl2ZS5saW5rKSB7CiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5jb21waWxlID0gdmFsdWVGbihkaXJlY3RpdmUubGluayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkaXJlY3RpdmUucHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHkgfHwgMDsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5pbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgZGlyZWN0aXZlLm5hbWUgPSBkaXJlY3RpdmUubmFtZSB8fCBuYW1lOwogICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZSB8fCAoZGlyZWN0aXZlLmNvbnRyb2xsZXIgJiYgZGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0ID0gZGlyZWN0aXZlLnJlc3RyaWN0IHx8ICdBJzsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaChkaXJlY3RpdmUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgICAgICAgfV0pOwogICAgICB9CiAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0ucHVzaChkaXJlY3RpdmVGYWN0b3J5KTsKICAgIH0gZWxzZSB7CiAgICAgIGZvckVhY2gobmFtZSwgcmV2ZXJzZVBhcmFtcyhyZWdpc3RlckRpcmVjdGl2ZSkpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyI2FIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgKgogICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICoKICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGFbaHJlZl0gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdGAKICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICoKICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgKi8KICB0aGlzLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24ocmVnZXhwKSB7CiAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgJCRzYW5pdGl6ZVVyaVByb3ZpZGVyLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0KHJlZ2V4cCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICQkc2FuaXRpemVVcmlQcm92aWRlci5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCgpOwogICAgfQogIH07CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNvbXBpbGVQcm92aWRlciNpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV0cmlldmVzIG9yIG92ZXJyaWRlcyB0aGUgZGVmYXVsdCByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIGZvciB3aGl0ZWxpc3Rpbmcgb2Ygc2FmZQogICAqIHVybHMgZHVyaW5nIGltZ1tzcmNdIHNhbml0aXphdGlvbi4KICAgKgogICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICoKICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGltZ1tzcmNdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8KICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0YAogICAqIHJlZ3VsYXIgZXhwcmVzc2lvbi4gSWYgYSBtYXRjaCBpcyBmb3VuZCwgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlLAogICAqIHRoZSBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpcyBpdCB3cml0dGVuIGludG8gdGhlIERPTS4KICAgKgogICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAqLwogIHRoaXMuaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24ocmVnZXhwKSB7CiAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgJCRzYW5pdGl6ZVVyaVByb3ZpZGVyLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdChyZWdleHApOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAkJHNhbml0aXplVXJpUHJvdmlkZXIuaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0KCk7CiAgICB9CiAgfTsKCiAgdGhpcy4kZ2V0ID0gWwogICAgICAgICAgICAnJGluamVjdG9yJywgJyRpbnRlcnBvbGF0ZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcGFyc2UnLAogICAgICAgICAgICAnJGNvbnRyb2xsZXInLCAnJHJvb3RTY29wZScsICckZG9jdW1lbnQnLCAnJHNjZScsICckYW5pbWF0ZScsICckJHNhbml0aXplVXJpJywKICAgIGZ1bmN0aW9uKCRpbmplY3RvciwgICAkaW50ZXJwb2xhdGUsICAgJGV4Y2VwdGlvbkhhbmRsZXIsICAgJGh0dHAsICAgJHRlbXBsYXRlQ2FjaGUsICAgJHBhcnNlLAogICAgICAgICAgICAgJGNvbnRyb2xsZXIsICAgJHJvb3RTY29wZSwgICAkZG9jdW1lbnQsICAgJHNjZSwgICAkYW5pbWF0ZSwgICAkJHNhbml0aXplVXJpKSB7CgogICAgdmFyIEF0dHJpYnV0ZXMgPSBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIHRoaXMuJCRlbGVtZW50ID0gZWxlbWVudDsKICAgICAgdGhpcy4kYXR0ciA9IGF0dHIgfHwge307CiAgICB9OwoKICAgIEF0dHJpYnV0ZXMucHJvdG90eXBlID0gewogICAgICAkbm9ybWFsaXplOiBkaXJlY3RpdmVOb3JtYWxpemUsCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGFkZENsYXNzCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBBZGRzIHRoZSBDU1MgY2xhc3MgdmFsdWUgc3BlY2lmaWVkIGJ5IHRoZSBjbGFzc1ZhbCBwYXJhbWV0ZXIgdG8gdGhlIGVsZW1lbnQuIElmIGFuaW1hdGlvbnMKICAgICAgICogYXJlIGVuYWJsZWQgdGhlbiBhbiBhbmltYXRpb24gd2lsbCBiZSB0cmlnZ2VyZWQgZm9yIHRoZSBjbGFzcyBhZGRpdGlvbi4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzVmFsIFRoZSBjbGFzc05hbWUgdmFsdWUgdGhhdCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAqLwogICAgICAkYWRkQ2xhc3MgOiBmdW5jdGlvbihjbGFzc1ZhbCkgewogICAgICAgIGlmKGNsYXNzVmFsICYmIGNsYXNzVmFsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICRhbmltYXRlLmFkZENsYXNzKHRoaXMuJCRlbGVtZW50LCBjbGFzc1ZhbCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJHJlbW92ZUNsYXNzCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBSZW1vdmVzIHRoZSBDU1MgY2xhc3MgdmFsdWUgc3BlY2lmaWVkIGJ5IHRoZSBjbGFzc1ZhbCBwYXJhbWV0ZXIgZnJvbSB0aGUgZWxlbWVudC4gSWYKICAgICAgICogYW5pbWF0aW9ucyBhcmUgZW5hYmxlZCB0aGVuIGFuIGFuaW1hdGlvbiB3aWxsIGJlIHRyaWdnZXJlZCBmb3IgdGhlIGNsYXNzIHJlbW92YWwuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc1ZhbCBUaGUgY2xhc3NOYW1lIHZhbHVlIHRoYXQgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICovCiAgICAgICRyZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGNsYXNzVmFsKSB7CiAgICAgICAgaWYoY2xhc3NWYWwgJiYgY2xhc3NWYWwubGVuZ3RoID4gMCkgewogICAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3ModGhpcy4kJGVsZW1lbnQsIGNsYXNzVmFsKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkdXBkYXRlQ2xhc3MKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEFkZHMgYW5kIHJlbW92ZXMgdGhlIGFwcHJvcHJpYXRlIENTUyBjbGFzcyB2YWx1ZXMgdG8gdGhlIGVsZW1lbnQgYmFzZWQgb24gdGhlIGRpZmZlcmVuY2UKICAgICAgICogYmV0d2VlbiB0aGUgbmV3IGFuZCBvbGQgQ1NTIGNsYXNzIHZhbHVlcyAoc3BlY2lmaWVkIGFzIG5ld0NsYXNzZXMgYW5kIG9sZENsYXNzZXMpLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3Q2xhc3NlcyBUaGUgY3VycmVudCBDU1MgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRDbGFzc2VzIFRoZSBmb3JtZXIgQ1NTIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgKi8KICAgICAgJHVwZGF0ZUNsYXNzIDogZnVuY3Rpb24obmV3Q2xhc3Nlcywgb2xkQ2xhc3NlcykgewogICAgICAgIHZhciB0b0FkZCA9IHRva2VuRGlmZmVyZW5jZShuZXdDbGFzc2VzLCBvbGRDbGFzc2VzKTsKICAgICAgICB2YXIgdG9SZW1vdmUgPSB0b2tlbkRpZmZlcmVuY2Uob2xkQ2xhc3NlcywgbmV3Q2xhc3Nlcyk7CgogICAgICAgIGlmKHRvQWRkLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3ModGhpcy4kJGVsZW1lbnQsIHRvUmVtb3ZlKTsKICAgICAgICB9IGVsc2UgaWYodG9SZW1vdmUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcyh0aGlzLiQkZWxlbWVudCwgdG9BZGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAkYW5pbWF0ZS5zZXRDbGFzcyh0aGlzLiQkZWxlbWVudCwgdG9BZGQsIHRvUmVtb3ZlKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogU2V0IGEgbm9ybWFsaXplZCBhdHRyaWJ1dGUgb24gdGhlIGVsZW1lbnQgaW4gYSB3YXkgc3VjaCB0aGF0IGFsbCBkaXJlY3RpdmVzCiAgICAgICAqIGNhbiBzaGFyZSB0aGUgYXR0cmlidXRlLiBUaGlzIGZ1bmN0aW9uIHByb3Blcmx5IGhhbmRsZXMgYm9vbGVhbiBhdHRyaWJ1dGVzLgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IE5vcm1hbGl6ZWQga2V5LiAoaWUgbmdBdHRyaWJ1dGUpCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfGJvb2xlYW59IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuIElmIGBudWxsYCBhdHRyaWJ1dGUgd2lsbCBiZSBkZWxldGVkLgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB3cml0ZUF0dHIgSWYgZmFsc2UsIGRvZXMgbm90IHdyaXRlIHRoZSB2YWx1ZSB0byBET00gZWxlbWVudCBhdHRyaWJ1dGUuCiAgICAgICAqICAgICBEZWZhdWx0cyB0byB0cnVlLgogICAgICAgKiBAcGFyYW0ge3N0cmluZz19IGF0dHJOYW1lIE9wdGlvbmFsIG5vbmUgbm9ybWFsaXplZCBuYW1lLiBEZWZhdWx0cyB0byBrZXkuCiAgICAgICAqLwogICAgICAkc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlLCB3cml0ZUF0dHIsIGF0dHJOYW1lKSB7CiAgICAgICAgLy8gVE9ETzogZGVjaWRlIHdoZXRoZXIgb3Igbm90IHRvIHRocm93IGFuIGVycm9yIGlmICJjbGFzcyIKICAgICAgICAvL2lzIHNldCB0aHJvdWdoIHRoaXMgZnVuY3Rpb24gc2luY2UgaXQgbWF5IGNhdXNlICR1cGRhdGVDbGFzcyB0bwogICAgICAgIC8vYmVjb21lIHVuc3RhYmxlLgoKICAgICAgICB2YXIgYm9vbGVhbktleSA9IGdldEJvb2xlYW5BdHRyTmFtZSh0aGlzLiQkZWxlbWVudFswXSwga2V5KSwKICAgICAgICAgICAgbm9ybWFsaXplZFZhbCwKICAgICAgICAgICAgbm9kZU5hbWU7CgogICAgICAgIGlmIChib29sZWFuS2V5KSB7CiAgICAgICAgICB0aGlzLiQkZWxlbWVudC5wcm9wKGtleSwgdmFsdWUpOwogICAgICAgICAgYXR0ck5hbWUgPSBib29sZWFuS2V5OwogICAgICAgIH0KCiAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgIC8vIHRyYW5zbGF0ZSBub3JtYWxpemVkIGtleSB0byBhY3R1YWwga2V5CiAgICAgICAgaWYgKGF0dHJOYW1lKSB7CiAgICAgICAgICB0aGlzLiRhdHRyW2tleV0gPSBhdHRyTmFtZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXR0ck5hbWUgPSB0aGlzLiRhdHRyW2tleV07CiAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lID0gc25ha2VfY2FzZShrZXksICctJyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBub2RlTmFtZSA9IG5vZGVOYW1lXyh0aGlzLiQkZWxlbWVudCk7CgogICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gYW5kIGltZ1tzcmNdIHZhbHVlcwogICAgICAgIGlmICgobm9kZU5hbWUgPT09ICdBJyAmJiBrZXkgPT09ICdocmVmJykgfHwKICAgICAgICAgICAgKG5vZGVOYW1lID09PSAnSU1HJyAmJiBrZXkgPT09ICdzcmMnKSkgewogICAgICAgICAgdGhpc1trZXldID0gdmFsdWUgPSAkJHNhbml0aXplVXJpKHZhbHVlLCBrZXkgPT09ICdzcmMnKTsKICAgICAgICB9CgogICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5yZW1vdmVBdHRyKGF0dHJOYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LmF0dHIoYXR0ck5hbWUsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGZpcmUgb2JzZXJ2ZXJzCiAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVyczsKICAgICAgICAkJG9ic2VydmVycyAmJiBmb3JFYWNoKCQkb2JzZXJ2ZXJzW2tleV0sIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmbih2YWx1ZSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRvYnNlcnZlCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBPYnNlcnZlcyBhbiBpbnRlcnBvbGF0ZWQgYXR0cmlidXRlLgogICAgICAgKgogICAgICAgKiBUaGUgb2JzZXJ2ZXIgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIG9uY2UgZHVyaW5nIHRoZSBuZXh0IGAkZGlnZXN0YCBmb2xsb3dpbmcKICAgICAgICogY29tcGlsYXRpb24uIFRoZSBvYnNlcnZlciBpcyB0aGVuIGludm9rZWQgd2hlbmV2ZXIgdGhlIGludGVycG9sYXRlZCB2YWx1ZQogICAgICAgKiBjaGFuZ2VzLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IE5vcm1hbGl6ZWQga2V5LiAoaWUgbmdBdHRyaWJ1dGUpIC4KICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihpbnRlcnBvbGF0ZWRWYWx1ZSl9IGZuIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIKICAgICAgICAgICAgICAgIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBjaGFuZ2VzLgogICAgICAgKiAgICAgICAgU2VlIHRoZSB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlI0F0dHJpYnV0ZXMgRGlyZWN0aXZlc30gZ3VpZGUgZm9yIG1vcmUgaW5mby4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IHRoZSBgZm5gIHBhcmFtZXRlci4KICAgICAgICovCiAgICAgICRvYnNlcnZlOiBmdW5jdGlvbihrZXksIGZuKSB7CiAgICAgICAgdmFyIGF0dHJzID0gdGhpcywKICAgICAgICAgICAgJCRvYnNlcnZlcnMgPSAoYXR0cnMuJCRvYnNlcnZlcnMgfHwgKGF0dHJzLiQkb2JzZXJ2ZXJzID0ge30pKSwKICAgICAgICAgICAgbGlzdGVuZXJzID0gKCQkb2JzZXJ2ZXJzW2tleV0gfHwgKCQkb2JzZXJ2ZXJzW2tleV0gPSBbXSkpOwoKICAgICAgICBsaXN0ZW5lcnMucHVzaChmbik7CiAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCFsaXN0ZW5lcnMuJCRpbnRlcikgewogICAgICAgICAgICAvLyBubyBvbmUgcmVnaXN0ZXJlZCBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiwgc28gbGV0cyBjYWxsIGl0IG1hbnVhbGx5CiAgICAgICAgICAgIGZuKGF0dHJzW2tleV0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmbjsKICAgICAgfQogICAgfTsKCiAgICB2YXIgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICBlbmRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCksCiAgICAgICAgZGVub3JtYWxpemVUZW1wbGF0ZSA9IChzdGFydFN5bWJvbCA9PSAne3snIHx8IGVuZFN5bWJvbCAgPT0gJ319JykKICAgICAgICAgICAgPyBpZGVudGl0eQogICAgICAgICAgICA6IGZ1bmN0aW9uIGRlbm9ybWFsaXplVGVtcGxhdGUodGVtcGxhdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZSgvXHtcey9nLCBzdGFydFN5bWJvbCkucmVwbGFjZSgvfX0vZywgZW5kU3ltYm9sKTsKICAgICAgICB9LAogICAgICAgIE5HX0FUVFJfQklORElORyA9IC9ebmdBdHRyW0EtWl0vOwoKCiAgICByZXR1cm4gY29tcGlsZTsKCiAgICAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgZnVuY3Rpb24gY29tcGlsZSgkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgaWYgKCEoJGNvbXBpbGVOb2RlcyBpbnN0YW5jZW9mIGpxTGl0ZSkpIHsKICAgICAgICAvLyBqcXVlcnkgYWx3YXlzIHJld3JhcHMsIHdoZXJlYXMgd2UgbmVlZCB0byBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgc2VsZWN0b3Igc28gdGhhdCB3ZSBjYW4KICAgICAgICAvLyBtb2RpZnkgaXQuCiAgICAgICAgJGNvbXBpbGVOb2RlcyA9IGpxTGl0ZSgkY29tcGlsZU5vZGVzKTsKICAgICAgfQogICAgICAvLyBXZSBjYW4gbm90IGNvbXBpbGUgdG9wIGxldmVsIHRleHQgZWxlbWVudHMgc2luY2UgdGV4dCBub2RlcyBjYW4gYmUgbWVyZ2VkIGFuZCB3ZSB3aWxsCiAgICAgIC8vIG5vdCBiZSBhYmxlIHRvIGF0dGFjaCBzY29wZSBkYXRhIHRvIHRoZW0sIHNvIHdlIHdpbGwgd3JhcCB0aGVtIGluIDxzcGFuPgogICAgICBmb3JFYWNoKCRjb21waWxlTm9kZXMsIGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzIC8qIHRleHQgbm9kZSAqLyAmJiBub2RlLm5vZGVWYWx1ZS5tYXRjaCgvXFMrLykgLyogbm9uLWVtcHR5ICovICkgewogICAgICAgICAgJGNvbXBpbGVOb2Rlc1tpbmRleF0gPSBub2RlID0ganFMaXRlKG5vZGUpLndyYXAoJzxzcGFuPjwvc3Bhbj4nKS5wYXJlbnQoKVswXTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB2YXIgY29tcG9zaXRlTGlua0ZuID0KICAgICAgICAgICAgICBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlcywgdHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLCBwcmV2aW91c0NvbXBpbGVDb250ZXh0KTsKICAgICAgc2FmZUFkZENsYXNzKCRjb21waWxlTm9kZXMsICduZy1zY29wZScpOwogICAgICByZXR1cm4gZnVuY3Rpb24gcHVibGljTGlua0ZuKHNjb3BlLCBjbG9uZUNvbm5lY3RGbiwgdHJhbnNjbHVkZUNvbnRyb2xsZXJzKXsKICAgICAgICBhc3NlcnRBcmcoc2NvcGUsICdzY29wZScpOwogICAgICAgIC8vIGltcG9ydGFudCEhOiB3ZSBtdXN0IGNhbGwgb3VyIGpxTGl0ZS5jbG9uZSgpIHNpbmNlIHRoZSBqUXVlcnkgb25lIGlzIHRyeWluZyB0byBiZSBzbWFydAogICAgICAgIC8vIGFuZCBzb21ldGltZXMgY2hhbmdlcyB0aGUgc3RydWN0dXJlIG9mIHRoZSBET00uCiAgICAgICAgdmFyICRsaW5rTm9kZSA9IGNsb25lQ29ubmVjdEZuCiAgICAgICAgICA/IEpRTGl0ZVByb3RvdHlwZS5jbG9uZS5jYWxsKCRjb21waWxlTm9kZXMpIC8vIElNUE9SVEFOVCEhIQogICAgICAgICAgOiAkY29tcGlsZU5vZGVzOwoKICAgICAgICBmb3JFYWNoKHRyYW5zY2x1ZGVDb250cm9sbGVycywgZnVuY3Rpb24oaW5zdGFuY2UsIG5hbWUpIHsKICAgICAgICAgICRsaW5rTm9kZS5kYXRhKCckJyArIG5hbWUgKyAnQ29udHJvbGxlcicsIGluc3RhbmNlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQXR0YWNoIHNjb3BlIG9ubHkgdG8gbm9uLXRleHQgbm9kZXMuCiAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSAkbGlua05vZGUubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICAgIHZhciBub2RlID0gJGxpbmtOb2RlW2ldLAogICAgICAgICAgICAgIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZTsKICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gMSAvKiBlbGVtZW50ICovIHx8IG5vZGVUeXBlID09PSA5IC8qIGRvY3VtZW50ICovKSB7CiAgICAgICAgICAgICRsaW5rTm9kZS5lcShpKS5kYXRhKCckc2NvcGUnLCBzY29wZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY2xvbmVDb25uZWN0Rm4pIGNsb25lQ29ubmVjdEZuKCRsaW5rTm9kZSwgc2NvcGUpOwogICAgICAgIGlmIChjb21wb3NpdGVMaW5rRm4pIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgJGxpbmtOb2RlLCAkbGlua05vZGUpOwogICAgICAgIHJldHVybiAkbGlua05vZGU7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gc2FmZUFkZENsYXNzKCRlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgdHJ5IHsKICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAvLyBpZ25vcmUsIHNpbmNlIGl0IG1lYW5zIHRoYXQgd2UgYXJlIHRyeWluZyB0byBzZXQgY2xhc3Mgb24KICAgICAgICAvLyBTVkcgZWxlbWVudCwgd2hlcmUgY2xhc3MgbmFtZSBpcyByZWFkLW9ubHkuCiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENvbXBpbGUgZnVuY3Rpb24gbWF0Y2hlcyBlYWNoIG5vZGUgaW4gbm9kZUxpc3QgYWdhaW5zdCB0aGUgZGlyZWN0aXZlcy4gT25jZSBhbGwgZGlyZWN0aXZlcwogICAgICogZm9yIGEgcGFydGljdWxhciBub2RlIGFyZSBjb2xsZWN0ZWQgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGUgY29tcGlsZQogICAgICogZnVuY3Rpb25zIHJldHVybiB2YWx1ZXMgLSB0aGUgbGlua2luZyBmdW5jdGlvbnMgLSBhcmUgY29tYmluZWQgaW50byBhIGNvbXBvc2l0ZSBsaW5raW5nCiAgICAgKiBmdW5jdGlvbiwgd2hpY2ggaXMgdGhlIGEgbGlua2luZyBmdW5jdGlvbiBmb3IgdGhlIG5vZGUuCiAgICAgKgogICAgICogQHBhcmFtIHtOb2RlTGlzdH0gbm9kZUxpc3QgYW4gYXJyYXkgb2Ygbm9kZXMgb3IgTm9kZUxpc3QgdG8gY29tcGlsZQogICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlLCBjbG9uZUF0dGFjaEZuPSl9IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudD19ICRyb290RWxlbWVudCBJZiB0aGUgbm9kZUxpc3QgaXMgdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGF0aW9uIHRyZWUgdGhlbgogICAgICogICAgICAgIHRoZSByb290RWxlbWVudCBtdXN0IGJlIHNldCB0aGUganFMaXRlIGNvbGxlY3Rpb24gb2YgdGhlIGNvbXBpbGUgcm9vdC4gVGhpcyBpcwogICAgICogICAgICAgIG5lZWRlZCBzbyB0aGF0IHRoZSBqcUxpdGUgY29sbGVjdGlvbiBpdGVtcyBjYW4gYmUgcmVwbGFjZWQgd2l0aCB3aWRnZXRzLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBtYXhQcmlvcml0eSBNYXggZGlyZWN0aXZlIHByaW9yaXR5LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBBIGNvbXBvc2l0ZSBsaW5raW5nIGZ1bmN0aW9uIG9mIGFsbCBvZiB0aGUgbWF0Y2hlZCBkaXJlY3RpdmVzIG9yIG51bGwuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbXBpbGVOb2Rlcyhub2RlTGlzdCwgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0KSB7CiAgICAgIHZhciBsaW5rRm5zID0gW10sCiAgICAgICAgICBhdHRycywgZGlyZWN0aXZlcywgbm9kZUxpbmtGbiwgY2hpbGROb2RlcywgY2hpbGRMaW5rRm4sIGxpbmtGbkZvdW5kOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgIGF0dHJzID0gbmV3IEF0dHJpYnV0ZXMoKTsKCiAgICAgICAgLy8gd2UgbXVzdCBhbHdheXMgcmVmZXIgdG8gbm9kZUxpc3RbaV0gc2luY2UgdGhlIG5vZGVzIGNhbiBiZSByZXBsYWNlZCB1bmRlcm5lYXRoIHVzLgogICAgICAgIGRpcmVjdGl2ZXMgPSBjb2xsZWN0RGlyZWN0aXZlcyhub2RlTGlzdFtpXSwgW10sIGF0dHJzLCBpID09PSAwID8gbWF4UHJpb3JpdHkgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZ25vcmVEaXJlY3RpdmUpOwoKICAgICAgICBub2RlTGlua0ZuID0gKGRpcmVjdGl2ZXMubGVuZ3RoKQogICAgICAgICAgICA/IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBub2RlTGlzdFtpXSwgYXR0cnMsIHRyYW5zY2x1ZGVGbiwgJHJvb3RFbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsIFtdLCBbXSwgcHJldmlvdXNDb21waWxlQ29udGV4dCkKICAgICAgICAgICAgOiBudWxsOwoKICAgICAgICBpZiAobm9kZUxpbmtGbiAmJiBub2RlTGlua0ZuLnNjb3BlKSB7CiAgICAgICAgICBzYWZlQWRkQ2xhc3MoanFMaXRlKG5vZGVMaXN0W2ldKSwgJ25nLXNjb3BlJyk7CiAgICAgICAgfQoKICAgICAgICBjaGlsZExpbmtGbiA9IChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4udGVybWluYWwgfHwKICAgICAgICAgICAgICAgICAgICAgICEoY2hpbGROb2RlcyA9IG5vZGVMaXN0W2ldLmNoaWxkTm9kZXMpIHx8CiAgICAgICAgICAgICAgICAgICAgICAhY2hpbGROb2Rlcy5sZW5ndGgpCiAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICA6IGNvbXBpbGVOb2RlcyhjaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPyBub2RlTGlua0ZuLnRyYW5zY2x1ZGUgOiB0cmFuc2NsdWRlRm4pOwoKICAgICAgICBsaW5rRm5zLnB1c2gobm9kZUxpbmtGbiwgY2hpbGRMaW5rRm4pOwogICAgICAgIGxpbmtGbkZvdW5kID0gbGlua0ZuRm91bmQgfHwgbm9kZUxpbmtGbiB8fCBjaGlsZExpbmtGbjsKICAgICAgICAvL3VzZSB0aGUgcHJldmlvdXMgY29udGV4dCBvbmx5IGZvciB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgdmlydHVhbCBncm91cAogICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQgPSBudWxsOwogICAgICB9CgogICAgICAvLyByZXR1cm4gYSBsaW5raW5nIGZ1bmN0aW9uIGlmIHdlIGhhdmUgZm91bmQgYW55dGhpbmcsIG51bGwgb3RoZXJ3aXNlCiAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICBmdW5jdGlvbiBjb21wb3NpdGVMaW5rRm4oc2NvcGUsIG5vZGVMaXN0LCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgdmFyIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBub2RlLCAkbm9kZSwgY2hpbGRTY29wZSwgY2hpbGRUcmFuc2NsdWRlRm4sIGksIGlpLCBuOwoKICAgICAgICAvLyBjb3B5IG5vZGVMaXN0IHNvIHRoYXQgbGlua2luZyBkb2Vzbid0IGJyZWFrIGR1ZSB0byBsaXZlIGxpc3QgdXBkYXRlcy4KICAgICAgICB2YXIgbm9kZUxpc3RMZW5ndGggPSBub2RlTGlzdC5sZW5ndGgsCiAgICAgICAgICAgIHN0YWJsZU5vZGVMaXN0ID0gbmV3IEFycmF5KG5vZGVMaXN0TGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZUxpc3RMZW5ndGg7IGkrKykgewogICAgICAgICAgc3RhYmxlTm9kZUxpc3RbaV0gPSBub2RlTGlzdFtpXTsKICAgICAgICB9CgogICAgICAgIGZvcihpID0gMCwgbiA9IDAsIGlpID0gbGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgbisrKSB7CiAgICAgICAgICBub2RlID0gc3RhYmxlTm9kZUxpc3Rbbl07CiAgICAgICAgICBub2RlTGlua0ZuID0gbGlua0Zuc1tpKytdOwogICAgICAgICAgY2hpbGRMaW5rRm4gPSBsaW5rRm5zW2krK107CiAgICAgICAgICAkbm9kZSA9IGpxTGl0ZShub2RlKTsKCiAgICAgICAgICBpZiAobm9kZUxpbmtGbikgewogICAgICAgICAgICBpZiAobm9kZUxpbmtGbi5zY29wZSkgewogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgJG5vZGUuZGF0YSgnJHNjb3BlJywgY2hpbGRTY29wZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gbm9kZUxpbmtGbi50cmFuc2NsdWRlOwogICAgICAgICAgICBpZiAoY2hpbGRUcmFuc2NsdWRlRm4gfHwgKCFib3VuZFRyYW5zY2x1ZGVGbiAmJiB0cmFuc2NsdWRlRm4pKSB7CiAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgJHJvb3RFbGVtZW50LAogICAgICAgICAgICAgICAgY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIGNoaWxkVHJhbnNjbHVkZUZuIHx8IHRyYW5zY2x1ZGVGbikKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkTGlua0ZuKSB7CiAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJvdW5kVHJhbnNjbHVkZUZuKHNjb3BlLCB0cmFuc2NsdWRlRm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGJvdW5kVHJhbnNjbHVkZUZuKHRyYW5zY2x1ZGVkU2NvcGUsIGNsb25lRm4sIGNvbnRyb2xsZXJzKSB7CiAgICAgICAgdmFyIHNjb3BlQ3JlYXRlZCA9IGZhbHNlOwoKICAgICAgICBpZiAoIXRyYW5zY2x1ZGVkU2NvcGUpIHsKICAgICAgICAgIHRyYW5zY2x1ZGVkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICB0cmFuc2NsdWRlZFNjb3BlLiQkdHJhbnNjbHVkZWQgPSB0cnVlOwogICAgICAgICAgc2NvcGVDcmVhdGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHZhciBjbG9uZSA9IHRyYW5zY2x1ZGVGbih0cmFuc2NsdWRlZFNjb3BlLCBjbG9uZUZuLCBjb250cm9sbGVycyk7CiAgICAgICAgaWYgKHNjb3BlQ3JlYXRlZCkgewogICAgICAgICAgY2xvbmUub24oJyRkZXN0cm95JywgYmluZCh0cmFuc2NsdWRlZFNjb3BlLCB0cmFuc2NsdWRlZFNjb3BlLiRkZXN0cm95KSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgKiBzb3J0ZWQuCiAgICAgKgogICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0gZGlyZWN0aXZlcyBBbiBhcnJheSB0byB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYWRkZWQgdG8uIFRoaXMgYXJyYXkgaXMgc29ydGVkIGJlZm9yZQogICAgICogICAgICAgIHRoZSBmdW5jdGlvbiByZXR1cm5zLgogICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAqLwogICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgIGF0dHJzTWFwID0gYXR0cnMuJGF0dHIsCiAgICAgICAgICBtYXRjaCwKICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgIHN3aXRjaChub2RlVHlwZSkgewogICAgICAgIGNhc2UgMTogLyogRWxlbWVudCAqLwogICAgICAgICAgLy8gdXNlIHRoZSBub2RlIG5hbWU6IDxkaXJlY3RpdmU+CiAgICAgICAgICBhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywKICAgICAgICAgICAgICBkaXJlY3RpdmVOb3JtYWxpemUobm9kZU5hbWVfKG5vZGUpLnRvTG93ZXJDYXNlKCkpLCAnRScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpOwoKICAgICAgICAgIC8vIGl0ZXJhdGUgb3ZlciB0aGUgYXR0cmlidXRlcwogICAgICAgICAgZm9yICh2YXIgYXR0ciwgbmFtZSwgbk5hbWUsIG5nQXR0ck5hbWUsIHZhbHVlLCBuQXR0cnMgPSBub2RlLmF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAgICBqID0gMCwgamogPSBuQXR0cnMgJiYgbkF0dHJzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgdmFyIGF0dHJTdGFydE5hbWUgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGF0dHJFbmROYW1lID0gZmFsc2U7CgogICAgICAgICAgICBhdHRyID0gbkF0dHJzW2pdOwogICAgICAgICAgICBpZiAoIW1zaWUgfHwgbXNpZSA+PSA4IHx8IGF0dHIuc3BlY2lmaWVkKSB7CiAgICAgICAgICAgICAgbmFtZSA9IGF0dHIubmFtZTsKICAgICAgICAgICAgICAvLyBzdXBwb3J0IG5nQXR0ciBhdHRyaWJ1dGUgYmluZGluZwogICAgICAgICAgICAgIG5nQXR0ck5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobmFtZSk7CiAgICAgICAgICAgICAgaWYgKE5HX0FUVFJfQklORElORy50ZXN0KG5nQXR0ck5hbWUpKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gc25ha2VfY2FzZShuZ0F0dHJOYW1lLnN1YnN0cig2KSwgJy0nKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciBkaXJlY3RpdmVOTmFtZSA9IG5nQXR0ck5hbWUucmVwbGFjZSgvKFN0YXJ0fEVuZCkkLywgJycpOwogICAgICAgICAgICAgIGlmIChuZ0F0dHJOYW1lID09PSBkaXJlY3RpdmVOTmFtZSArICdTdGFydCcpIHsKICAgICAgICAgICAgICAgIGF0dHJTdGFydE5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgYXR0ckVuZE5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtIDUpICsgJ2VuZCc7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHIoMCwgbmFtZS5sZW5ndGggLSA2KTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgYXR0cnNNYXBbbk5hbWVdID0gbmFtZTsKICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB2YWx1ZSA9IHRyaW0oYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBuTmFtZSkpIHsKICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYWRkQXR0ckludGVycG9sYXRlRGlyZWN0aXZlKG5vZGUsIGRpcmVjdGl2ZXMsIHZhbHVlLCBuTmFtZSk7CiAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsIGF0dHJTdGFydE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyRW5kTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyB1c2UgY2xhc3MgYXMgZGlyZWN0aXZlCiAgICAgICAgICBjbGFzc05hbWUgPSBub2RlLmNsYXNzTmFtZTsKICAgICAgICAgIGlmIChpc1N0cmluZyhjbGFzc05hbWUpICYmIGNsYXNzTmFtZSAhPT0gJycpIHsKICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ0MnLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFszXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZS5zdWJzdHIobWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDM6IC8qIFRleHQgTm9kZSAqLwogICAgICAgICAgYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgODogLyogQ29tbWVudCAqLwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbWF0Y2ggPSBDT01NRU5UX0RJUkVDVElWRV9SRUdFWFAuZXhlYyhub2RlLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG1hdGNoWzFdKTsKICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnTScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cmltKG1hdGNoWzJdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gdHVybnMgb3V0IHRoYXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIElFOSB0aHJvd3MgZXJyb3JzIHdoZW4gb25lIGF0dGVtcHRzIHRvIHJlYWQKICAgICAgICAgICAgLy8gY29tbWVudCdzIG5vZGUgdmFsdWUuCiAgICAgICAgICAgIC8vIEp1c3QgaWdub3JlIGl0IGFuZCBjb250aW51ZS4gKENhbid0IHNlZW0gdG8gcmVwcm9kdWNlIGluIHRlc3QgY2FzZS4pCiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgZGlyZWN0aXZlcy5zb3J0KGJ5UHJpb3JpdHkpOwogICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgIH0KCiAgICAvKioKICAgICAqIEdpdmVuIGEgbm9kZSB3aXRoIGFuIGRpcmVjdGl2ZS1zdGFydCBpdCBjb2xsZWN0cyBhbGwgb2YgdGhlIHNpYmxpbmdzIHVudGlsIGl0IGZpbmRzCiAgICAgKiBkaXJlY3RpdmUtZW5kLgogICAgICogQHBhcmFtIG5vZGUKICAgICAqIEBwYXJhbSBhdHRyU3RhcnQKICAgICAqIEBwYXJhbSBhdHRyRW5kCiAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAqLwogICAgZnVuY3Rpb24gZ3JvdXBTY2FuKG5vZGUsIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICB2YXIgbm9kZXMgPSBbXTsKICAgICAgdmFyIGRlcHRoID0gMDsKICAgICAgaWYgKGF0dHJTdGFydCAmJiBub2RlLmhhc0F0dHJpYnV0ZSAmJiBub2RlLmhhc0F0dHJpYnV0ZShhdHRyU3RhcnQpKSB7CiAgICAgICAgdmFyIHN0YXJ0Tm9kZSA9IG5vZGU7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd1dGVyZGlyJywKICAgICAgICAgICAgICAgICAgICAgICJVbnRlcm1pbmF0ZWQgYXR0cmlidXRlLCBmb3VuZCAnezB9JyBidXQgbm8gbWF0Y2hpbmcgJ3sxfScgZm91bmQuIiwKICAgICAgICAgICAgICAgICAgICAgIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxIC8qKiBFbGVtZW50ICoqLykgewogICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0clN0YXJ0KSkgZGVwdGgrKzsKICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJFbmQpKSBkZXB0aC0tOwogICAgICAgICAgfQogICAgICAgICAgbm9kZXMucHVzaChub2RlKTsKICAgICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgIH0gd2hpbGUgKGRlcHRoID4gMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZXMucHVzaChub2RlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGpxTGl0ZShub2Rlcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBXcmFwcGVyIGZvciBsaW5raW5nIGZ1bmN0aW9uIHdoaWNoIGNvbnZlcnRzIG5vcm1hbCBsaW5raW5nIGZ1bmN0aW9uIGludG8gYSBncm91cGVkCiAgICAgKiBsaW5raW5nIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIGxpbmtGbgogICAgICogQHBhcmFtIGF0dHJTdGFydAogICAgICogQHBhcmFtIGF0dHJFbmQKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0KICAgICAqLwogICAgZnVuY3Rpb24gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIobGlua0ZuLCBhdHRyU3RhcnQsIGF0dHJFbmQpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMsIHRyYW5zY2x1ZGVGbikgewogICAgICAgIGVsZW1lbnQgPSBncm91cFNjYW4oZWxlbWVudFswXSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICByZXR1cm4gbGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMsIHRyYW5zY2x1ZGVGbik7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBPbmNlIHRoZSBkaXJlY3RpdmVzIGhhdmUgYmVlbiBjb2xsZWN0ZWQsIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb25zIGFyZSBleGVjdXRlZC4gVGhpcyBtZXRob2QKICAgICAqIGlzIHJlc3BvbnNpYmxlIGZvciBpbmxpbmluZyBkaXJlY3RpdmUgdGVtcGxhdGVzIGFzIHdlbGwgYXMgdGVybWluYXRpbmcgdGhlIGFwcGxpY2F0aW9uCiAgICAgKiBvZiB0aGUgZGlyZWN0aXZlcyBpZiB0aGUgdGVybWluYWwgZGlyZWN0aXZlIGhhcyBiZWVuIHJlYWNoZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gZGlyZWN0aXZlcyBBcnJheSBvZiBjb2xsZWN0ZWQgZGlyZWN0aXZlcyB0byBleGVjdXRlIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb24uCiAgICAgKiAgICAgICAgdGhpcyBuZWVkcyB0byBiZSBwcmUtc29ydGVkIGJ5IHByaW9yaXR5IG9yZGVyLgogICAgICogQHBhcmFtIHtOb2RlfSBjb21waWxlTm9kZSBUaGUgcmF3IERPTSBub2RlIHRvIGFwcGx5IHRoZSBjb21waWxlIGZ1bmN0aW9ucyB0bwogICAgICogQHBhcmFtIHtPYmplY3R9IHRlbXBsYXRlQXR0cnMgVGhlIHNoYXJlZCBhdHRyaWJ1dGUgZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZSwgY2xvbmVBdHRhY2hGbj0pfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSBhcmd1bWVudCBpcyBhdXRvLWdlbmVyYXRlZCB0byB0aGUgbmV3CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAqIEBwYXJhbSB7SlFMaXRlfSBqcUNvbGxlY3Rpb24gSWYgd2UgYXJlIHdvcmtpbmcgb24gdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZSB0aGVuIHRoaXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJndW1lbnQgaGFzIHRoZSByb290IGpxTGl0ZSBhcnJheSBzbyB0aGF0IHdlIGNhbiByZXBsYWNlIG5vZGVzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uIGl0LgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBvcmlnaW5hbFJlcGxhY2VEaXJlY3RpdmUgQW4gb3B0aW9uYWwgZGlyZWN0aXZlIHRoYXQgd2lsbCBiZSBpZ25vcmVkIHdoZW4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGluZyB0aGUgdHJhbnNjbHVzaW9uLgogICAgICogQHBhcmFtIHtBcnJheS48RnVuY3Rpb24+fSBwcmVMaW5rRm5zCiAgICAgKiBAcGFyYW0ge0FycmF5LjxGdW5jdGlvbj59IHBvc3RMaW5rRm5zCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJldmlvdXNDb21waWxlQ29udGV4dCBDb250ZXh0IHVzZWQgZm9yIHByZXZpb3VzIGNvbXBpbGF0aW9uIG9mIHRoZSBjdXJyZW50CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IGxpbmtGbgogICAgICovCiAgICBmdW5jdGlvbiBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIHRyYW5zY2x1ZGVGbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUNvbGxlY3Rpb24sIG9yaWdpbmFsUmVwbGFjZURpcmVjdGl2ZSwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCkgewogICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0ID0gcHJldmlvdXNDb21waWxlQ29udGV4dCB8fCB7fTsKCiAgICAgIHZhciB0ZXJtaW5hbFByaW9yaXR5ID0gLU51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICBuZXdTY29wZURpcmVjdGl2ZSwKICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gcHJldmlvdXNDb21waWxlQ29udGV4dC5jb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQubmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLAogICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0LnRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQubm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgIGhhc1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSBmYWxzZSwKICAgICAgICAgIGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlID0gcHJldmlvdXNDb21waWxlQ29udGV4dC5oYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0ganFMaXRlKGNvbXBpbGVOb2RlKSwKICAgICAgICAgIGRpcmVjdGl2ZSwKICAgICAgICAgIGRpcmVjdGl2ZU5hbWUsCiAgICAgICAgICAkdGVtcGxhdGUsCiAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gb3JpZ2luYWxSZXBsYWNlRGlyZWN0aXZlLAogICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSB0cmFuc2NsdWRlRm4sCiAgICAgICAgICBsaW5rRm4sCiAgICAgICAgICBkaXJlY3RpdmVWYWx1ZTsKCiAgICAgIC8vIGV4ZWN1dGVzIGFsbCBkaXJlY3RpdmVzIG9uIHRoZSBjdXJyZW50IGVsZW1lbnQKICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgIHZhciBhdHRyU3RhcnQgPSBkaXJlY3RpdmUuJCRzdGFydDsKICAgICAgICB2YXIgYXR0ckVuZCA9IGRpcmVjdGl2ZS4kJGVuZDsKCiAgICAgICAgLy8gY29sbGVjdCBtdWx0aWJsb2NrIHNlY3Rpb25zCiAgICAgICAgaWYgKGF0dHJTdGFydCkgewogICAgICAgICAgJGNvbXBpbGVOb2RlID0gZ3JvdXBTY2FuKGNvbXBpbGVOb2RlLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgIH0KICAgICAgICAkdGVtcGxhdGUgPSB1bmRlZmluZWQ7CgogICAgICAgIGlmICh0ZXJtaW5hbFByaW9yaXR5ID4gZGlyZWN0aXZlLnByaW9yaXR5KSB7CiAgICAgICAgICBicmVhazsgLy8gcHJldmVudCBmdXJ0aGVyIHByb2Nlc3Npbmcgb2YgZGlyZWN0aXZlcwogICAgICAgIH0KCiAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnNjb3BlKSB7CiAgICAgICAgICBuZXdTY29wZURpcmVjdGl2ZSA9IG5ld1Njb3BlRGlyZWN0aXZlIHx8IGRpcmVjdGl2ZTsKCiAgICAgICAgICAvLyBza2lwIHRoZSBjaGVjayBmb3IgZGlyZWN0aXZlcyB3aXRoIGFzeW5jIHRlbXBsYXRlcywgd2UnbGwgY2hlY2sgdGhlIGRlcml2ZWQgc3luYwogICAgICAgICAgLy8gZGlyZWN0aXZlIHdoZW4gdGhlIHRlbXBsYXRlIGFycml2ZXMKICAgICAgICAgIGlmICghZGlyZWN0aXZlLnRlbXBsYXRlVXJsKSB7CiAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCduZXcvaXNvbGF0ZWQgc2NvcGUnLCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGRpcmVjdGl2ZVZhbHVlKSkgewogICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZS5uYW1lOwoKICAgICAgICBpZiAoIWRpcmVjdGl2ZS50ZW1wbGF0ZVVybCAmJiBkaXJlY3RpdmUuY29udHJvbGxlcikgewogICAgICAgICAgZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuY29udHJvbGxlcjsKICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gY29udHJvbGxlckRpcmVjdGl2ZXMgfHwge307CiAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgiJyIgKyBkaXJlY3RpdmVOYW1lICsgIicgY29udHJvbGxlciIsCiAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0sIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gZGlyZWN0aXZlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnRyYW5zY2x1ZGUpIHsKICAgICAgICAgIGhhc1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSB0cnVlOwoKICAgICAgICAgIC8vIFNwZWNpYWwgY2FzZSBuZ0lmIGFuZCBuZ1JlcGVhdCBzbyB0aGF0IHdlIGRvbid0IGNvbXBsYWluIGFib3V0IGR1cGxpY2F0ZSB0cmFuc2NsdXNpb24uCiAgICAgICAgICAvLyBUaGlzIG9wdGlvbiBzaG91bGQgb25seSBiZSB1c2VkIGJ5IGRpcmVjdGl2ZXMgdGhhdCBrbm93IGhvdyB0byBzYWZlbHkgaGFuZGxlIGVsZW1lbnQgdHJhbnNjbHVzaW9uLAogICAgICAgICAgLy8gd2hlcmUgdGhlIHRyYW5zY2x1ZGVkIG5vZGVzIGFyZSBhZGRlZCBvciByZXBsYWNlZCBhZnRlciBsaW5raW5nLgogICAgICAgICAgaWYgKCFkaXJlY3RpdmUuJCR0bGIpIHsKICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RyYW5zY2x1c2lvbicsIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPT0gJ2VsZW1lbnQnKSB7CiAgICAgICAgICAgIGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eTsKICAgICAgICAgICAgJHRlbXBsYXRlID0gZ3JvdXBTY2FuKGNvbXBpbGVOb2RlLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICAkY29tcGlsZU5vZGUgPSB0ZW1wbGF0ZUF0dHJzLiQkZWxlbWVudCA9CiAgICAgICAgICAgICAgICBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnICcgKyBkaXJlY3RpdmVOYW1lICsgJzogJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZUF0dHJzW2RpcmVjdGl2ZU5hbWVdICsgJyAnKSk7CiAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwogICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sIGpxTGl0ZShzbGljZUFyZ3MoJHRlbXBsYXRlKSksIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbiwgdGVybWluYWxQcmlvcml0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgJiYgcmVwbGFjZURpcmVjdGl2ZS5uYW1lLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvbid0IHBhc3MgaW46CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gY29udHJvbGxlckRpcmVjdGl2ZXMgLSBvdGhlcndpc2Ugd2UnbGwgY3JlYXRlIGR1cGxpY2F0ZXMgY29udHJvbGxlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgb3IgdGVtcGxhdGVEaXJlY3RpdmUgLSBjb21iaW5pbmcgdGVtcGxhdGVzIHdpdGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICBlbGVtZW50IHRyYW5zY2x1c2lvbiBkb2Vzbid0IG1ha2Ugc2Vuc2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgb25seSBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlIHNvIHRoYXQgd2UgcHJldmVudCBwdXR0aW5nIHRyYW5zY2x1c2lvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiB0aGUgc2FtZSBlbGVtZW50IG1vcmUgdGhhbiBvbmNlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlOiBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZShqcUxpdGVDbG9uZShjb21waWxlTm9kZSkpLmNvbnRlbnRzKCk7CiAgICAgICAgICAgICRjb21waWxlTm9kZS5lbXB0eSgpOyAvLyBjbGVhciBjb250ZW50cwogICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IGNvbXBpbGUoJHRlbXBsYXRlLCB0cmFuc2NsdWRlRm4pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZW1wbGF0ZSkgewogICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RlbXBsYXRlJywgdGVtcGxhdGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwoKICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gKGlzRnVuY3Rpb24oZGlyZWN0aXZlLnRlbXBsYXRlKSkKICAgICAgICAgICAgICA/IGRpcmVjdGl2ZS50ZW1wbGF0ZSgkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMpCiAgICAgICAgICAgICAgOiBkaXJlY3RpdmUudGVtcGxhdGU7CgogICAgICAgICAgZGlyZWN0aXZlVmFsdWUgPSBkZW5vcm1hbGl6ZVRlbXBsYXRlKGRpcmVjdGl2ZVZhbHVlKTsKCiAgICAgICAgICBpZiAoZGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgaWYgKGpxTGl0ZUlzVGV4dE5vZGUoZGlyZWN0aXZlVmFsdWUpKSB7CiAgICAgICAgICAgICAgJHRlbXBsYXRlID0gW107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKHRyaW0oZGlyZWN0aXZlVmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21waWxlTm9kZSA9ICR0ZW1wbGF0ZVswXTsKCiAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndHBscnQnLAogICAgICAgICAgICAgICAgICAiVGVtcGxhdGUgZm9yIGRpcmVjdGl2ZSAnezB9JyBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB7MX0iLAogICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOYW1lLCAnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlcGxhY2VXaXRoKGpxQ29sbGVjdGlvbiwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICB2YXIgbmV3VGVtcGxhdGVBdHRycyA9IHskYXR0cjoge319OwoKICAgICAgICAgICAgLy8gY29tYmluZSBkaXJlY3RpdmVzIGZyb20gdGhlIG9yaWdpbmFsIG5vZGUgYW5kIGZyb20gdGhlIHRlbXBsYXRlOgogICAgICAgICAgICAvLyAtIHRha2UgdGhlIGFycmF5IG9mIGRpcmVjdGl2ZXMgZm9yIHRoaXMgZWxlbWVudAogICAgICAgICAgICAvLyAtIHNwbGl0IGl0IGludG8gdHdvIHBhcnRzLCB0aG9zZSB0aGF0IGFscmVhZHkgYXBwbGllZCAocHJvY2Vzc2VkKSBhbmQgdGhvc2UgdGhhdCB3ZXJlbid0ICh1bnByb2Nlc3NlZCkKICAgICAgICAgICAgLy8gLSBjb2xsZWN0IGRpcmVjdGl2ZXMgZnJvbSB0aGUgdGVtcGxhdGUgYW5kIHNvcnQgdGhlbSBieSBwcmlvcml0eQogICAgICAgICAgICAvLyAtIGNvbWJpbmUgZGlyZWN0aXZlcyBhczogcHJvY2Vzc2VkICsgdGVtcGxhdGUgKyB1bnByb2Nlc3NlZAogICAgICAgICAgICB2YXIgdGVtcGxhdGVEaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMoY29tcGlsZU5vZGUsIFtdLCBuZXdUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgdmFyIHVucHJvY2Vzc2VkRGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuc3BsaWNlKGkgKyAxLCBkaXJlY3RpdmVzLmxlbmd0aCAtIChpICsgMSkpOwoKICAgICAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSkgewogICAgICAgICAgICAgIG1hcmtEaXJlY3RpdmVzQXNJc29sYXRlKHRlbXBsYXRlRGlyZWN0aXZlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuY29uY2F0KHRlbXBsYXRlRGlyZWN0aXZlcykuY29uY2F0KHVucHJvY2Vzc2VkRGlyZWN0aXZlcyk7CiAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRlbXBsYXRlQXR0cnMsIG5ld1RlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGRpcmVjdGl2ZVZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKCiAgICAgICAgICBpZiAoZGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBub2RlTGlua0ZuID0gY29tcGlsZVRlbXBsYXRlVXJsKGRpcmVjdGl2ZXMuc3BsaWNlKGksIGRpcmVjdGl2ZXMubGVuZ3RoIC0gaSksICRjb21waWxlTm9kZSwKICAgICAgICAgICAgICB0ZW1wbGF0ZUF0dHJzLCBqcUNvbGxlY3Rpb24sIGNoaWxkVHJhbnNjbHVkZUZuLCBwcmVMaW5rRm5zLCBwb3N0TGlua0ZucywgewogICAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXM6IGNvbnRyb2xsZXJEaXJlY3RpdmVzLAogICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlOiBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZTogdGVtcGxhdGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlOiBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAoZGlyZWN0aXZlLmNvbXBpbGUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxpbmtGbiA9IGRpcmVjdGl2ZS5jb21waWxlKCRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihsaW5rRm4pKSB7CiAgICAgICAgICAgICAgYWRkTGlua0ZucyhudWxsLCBsaW5rRm4sIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobGlua0ZuKSB7CiAgICAgICAgICAgICAgYWRkTGlua0ZucyhsaW5rRm4ucHJlLCBsaW5rRm4ucG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkY29tcGlsZU5vZGUpKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmUudGVybWluYWwpIHsKICAgICAgICAgIG5vZGVMaW5rRm4udGVybWluYWwgPSB0cnVlOwogICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IE1hdGgubWF4KHRlcm1pbmFsUHJpb3JpdHksIGRpcmVjdGl2ZS5wcmlvcml0eSk7CiAgICAgICAgfQoKICAgICAgfQoKICAgICAgbm9kZUxpbmtGbi5zY29wZSA9IG5ld1Njb3BlRGlyZWN0aXZlICYmIG5ld1Njb3BlRGlyZWN0aXZlLnNjb3BlID09PSB0cnVlOwogICAgICBub2RlTGlua0ZuLnRyYW5zY2x1ZGUgPSBoYXNUcmFuc2NsdWRlRGlyZWN0aXZlICYmIGNoaWxkVHJhbnNjbHVkZUZuOwogICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0Lmhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlID0gaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmU7CgogICAgICAvLyBtaWdodCBiZSBub3JtYWwgb3IgZGVsYXllZCBub2RlTGlua0ZuIGRlcGVuZGluZyBvbiBpZiB0ZW1wbGF0ZVVybCBpcyBwcmVzZW50CiAgICAgIHJldHVybiBub2RlTGlua0ZuOwoKICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgIGZ1bmN0aW9uIGFkZExpbmtGbnMocHJlLCBwb3N0LCBhdHRyU3RhcnQsIGF0dHJFbmQpIHsKICAgICAgICBpZiAocHJlKSB7CiAgICAgICAgICBpZiAoYXR0clN0YXJ0KSBwcmUgPSBncm91cEVsZW1lbnRzTGlua0ZuV3JhcHBlcihwcmUsIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICBwcmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgcHJlLmRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmVOYW1lOwogICAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9PT0gZGlyZWN0aXZlIHx8IGRpcmVjdGl2ZS4kJGlzb2xhdGVTY29wZSkgewogICAgICAgICAgICBwcmUgPSBjbG9uZUFuZEFubm90YXRlRm4ocHJlLCB7aXNvbGF0ZVNjb3BlOiB0cnVlfSk7CiAgICAgICAgICB9CiAgICAgICAgICBwcmVMaW5rRm5zLnB1c2gocHJlKTsKICAgICAgICB9CiAgICAgICAgaWYgKHBvc3QpIHsKICAgICAgICAgIGlmIChhdHRyU3RhcnQpIHBvc3QgPSBncm91cEVsZW1lbnRzTGlua0ZuV3JhcHBlcihwb3N0LCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgcG9zdC5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmU7CiAgICAgICAgICBwb3N0LmRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmVOYW1lOwogICAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9PT0gZGlyZWN0aXZlIHx8IGRpcmVjdGl2ZS4kJGlzb2xhdGVTY29wZSkgewogICAgICAgICAgICBwb3N0ID0gY2xvbmVBbmRBbm5vdGF0ZUZuKHBvc3QsIHtpc29sYXRlU2NvcGU6IHRydWV9KTsKICAgICAgICAgIH0KICAgICAgICAgIHBvc3RMaW5rRm5zLnB1c2gocG9zdCk7CiAgICAgICAgfQogICAgICB9CgoKICAgICAgZnVuY3Rpb24gZ2V0Q29udHJvbGxlcnMoZGlyZWN0aXZlTmFtZSwgcmVxdWlyZSwgJGVsZW1lbnQsIGVsZW1lbnRDb250cm9sbGVycykgewogICAgICAgIHZhciB2YWx1ZSwgcmV0cmlldmFsTWV0aG9kID0gJ2RhdGEnLCBvcHRpb25hbCA9IGZhbHNlOwogICAgICAgIGlmIChpc1N0cmluZyhyZXF1aXJlKSkgewogICAgICAgICAgd2hpbGUoKHZhbHVlID0gcmVxdWlyZS5jaGFyQXQoMCkpID09ICdeJyB8fCB2YWx1ZSA9PSAnPycpIHsKICAgICAgICAgICAgcmVxdWlyZSA9IHJlcXVpcmUuc3Vic3RyKDEpOwogICAgICAgICAgICBpZiAodmFsdWUgPT0gJ14nKSB7CiAgICAgICAgICAgICAgcmV0cmlldmFsTWV0aG9kID0gJ2luaGVyaXRlZERhdGEnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbmFsID0gb3B0aW9uYWwgfHwgdmFsdWUgPT0gJz8nOwogICAgICAgICAgfQogICAgICAgICAgdmFsdWUgPSBudWxsOwoKICAgICAgICAgIGlmIChlbGVtZW50Q29udHJvbGxlcnMgJiYgcmV0cmlldmFsTWV0aG9kID09PSAnZGF0YScpIHsKICAgICAgICAgICAgdmFsdWUgPSBlbGVtZW50Q29udHJvbGxlcnNbcmVxdWlyZV07CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlIHx8ICRlbGVtZW50W3JldHJpZXZhbE1ldGhvZF0oJyQnICsgcmVxdWlyZSArICdDb250cm9sbGVyJyk7CgogICAgICAgICAgaWYgKCF2YWx1ZSAmJiAhb3B0aW9uYWwpIHsKICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ2N0cmVxJywKICAgICAgICAgICAgICAgICJDb250cm9sbGVyICd7MH0nLCByZXF1aXJlZCBieSBkaXJlY3RpdmUgJ3sxfScsIGNhbid0IGJlIGZvdW5kISIsCiAgICAgICAgICAgICAgICByZXF1aXJlLCBkaXJlY3RpdmVOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkocmVxdWlyZSkpIHsKICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICBmb3JFYWNoKHJlcXVpcmUsIGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgICAgICAgICAgdmFsdWUucHVzaChnZXRDb250cm9sbGVycyhkaXJlY3RpdmVOYW1lLCByZXF1aXJlLCAkZWxlbWVudCwgZWxlbWVudENvbnRyb2xsZXJzKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CgoKICAgICAgZnVuY3Rpb24gbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgdmFyIGF0dHJzLCAkZWxlbWVudCwgaSwgaWksIGxpbmtGbiwgY29udHJvbGxlciwgaXNvbGF0ZVNjb3BlLCBlbGVtZW50Q29udHJvbGxlcnMgPSB7fSwgdHJhbnNjbHVkZUZuOwoKICAgICAgICBpZiAoY29tcGlsZU5vZGUgPT09IGxpbmtOb2RlKSB7CiAgICAgICAgICBhdHRycyA9IHRlbXBsYXRlQXR0cnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGF0dHJzID0gc2hhbGxvd0NvcHkodGVtcGxhdGVBdHRycywgbmV3IEF0dHJpYnV0ZXMoanFMaXRlKGxpbmtOb2RlKSwgdGVtcGxhdGVBdHRycy4kYXR0cikpOwogICAgICAgIH0KICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSkgewogICAgICAgICAgdmFyIExPQ0FMX1JFR0VYUCA9IC9eXHMqKFtAPSZdKShcPz8pXHMqKFx3KilccyokLzsKICAgICAgICAgIHZhciAkbGlua05vZGUgPSBqcUxpdGUobGlua05vZGUpOwoKICAgICAgICAgIGlzb2xhdGVTY29wZSA9IHNjb3BlLiRuZXcodHJ1ZSk7CgogICAgICAgICAgaWYgKHRlbXBsYXRlRGlyZWN0aXZlICYmICh0ZW1wbGF0ZURpcmVjdGl2ZSA9PT0gbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlIHx8CiAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPT09IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS4kJG9yaWdpbmFsRGlyZWN0aXZlKSkgewogICAgICAgICAgICAkbGlua05vZGUuZGF0YSgnJGlzb2xhdGVTY29wZScsIGlzb2xhdGVTY29wZSkgOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJGxpbmtOb2RlLmRhdGEoJyRpc29sYXRlU2NvcGVOb1RlbXBsYXRlJywgaXNvbGF0ZVNjb3BlKTsKICAgICAgICAgIH0KCgoKICAgICAgICAgIHNhZmVBZGRDbGFzcygkbGlua05vZGUsICduZy1pc29sYXRlLXNjb3BlJyk7CgogICAgICAgICAgZm9yRWFjaChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuc2NvcGUsIGZ1bmN0aW9uKGRlZmluaXRpb24sIHNjb3BlTmFtZSkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBkZWZpbml0aW9uLm1hdGNoKExPQ0FMX1JFR0VYUCkgfHwgW10sCiAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IG1hdGNoWzNdIHx8IHNjb3BlTmFtZSwKICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gKG1hdGNoWzJdID09ICc/JyksCiAgICAgICAgICAgICAgICBtb2RlID0gbWF0Y2hbMV0sIC8vIEAsID0sIG9yICYKICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSwKICAgICAgICAgICAgICAgIHBhcmVudEdldCwgcGFyZW50U2V0LCBjb21wYXJlOwoKICAgICAgICAgICAgaXNvbGF0ZVNjb3BlLiQkaXNvbGF0ZUJpbmRpbmdzW3Njb3BlTmFtZV0gPSBtb2RlICsgYXR0ck5hbWU7CgogICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKCiAgICAgICAgICAgICAgY2FzZSAnQCc6CiAgICAgICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZShhdHRyTmFtZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYXR0cnMuJCRvYnNlcnZlcnNbYXR0ck5hbWVdLiQkc2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgICAgIGlmKCBhdHRyc1thdHRyTmFtZV0gKSB7CiAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gcHJvdmlkZWQgdGhlbiB3ZSB0cmlnZ2VyIGFuIGludGVycG9sYXRpb24gdG8gZW5zdXJlCiAgICAgICAgICAgICAgICAgIC8vIHRoZSB2YWx1ZSBpcyB0aGVyZSBmb3IgdXNlIGluIHRoZSBsaW5rIGZuCiAgICAgICAgICAgICAgICAgIGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gJGludGVycG9sYXRlKGF0dHJzW2F0dHJOYW1lXSkoc2NvcGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgJz0nOgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbmFsICYmICFhdHRyc1thdHRyTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICBpZiAocGFyZW50R2V0LmxpdGVyYWwpIHsKICAgICAgICAgICAgICAgICAgY29tcGFyZSA9IGVxdWFsczsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbXBhcmUgPSBmdW5jdGlvbihhLGIpIHsgcmV0dXJuIGEgPT09IGI7IH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnRTZXQgPSBwYXJlbnRHZXQuYXNzaWduIHx8IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAvLyByZXNldCB0aGUgY2hhbmdlLCBvciB3ZSB3aWxsIHRocm93IHRoaXMgZXhjZXB0aW9uIG9uIGV2ZXJ5ICRkaWdlc3QKICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRHZXQoc2NvcGUpOwogICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignbm9uYXNzaWduJywKICAgICAgICAgICAgICAgICAgICAgICJFeHByZXNzaW9uICd7MH0nIHVzZWQgd2l0aCBkaXJlY3RpdmUgJ3sxfScgaXMgbm9uLWFzc2lnbmFibGUhIiwKICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW2F0dHJOYW1lXSwgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHNjb3BlKTsKICAgICAgICAgICAgICAgIGlzb2xhdGVTY29wZS4kd2F0Y2goZnVuY3Rpb24gcGFyZW50VmFsdWVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFZhbHVlID0gcGFyZW50R2V0KHNjb3BlKTsKICAgICAgICAgICAgICAgICAgaWYgKCFjb21wYXJlKHBhcmVudFZhbHVlLCBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgb3V0IG9mIHN5bmMgYW5kIG5lZWQgdG8gY29weQogICAgICAgICAgICAgICAgICAgIGlmICghY29tcGFyZShwYXJlbnRWYWx1ZSwgbGFzdFZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgLy8gcGFyZW50IGNoYW5nZWQgYW5kIGl0IGhhcyBwcmVjZWRlbmNlCiAgICAgICAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudFZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgcGFyZW50IGNhbiBiZSBhc3NpZ25lZCB0aGVuIGRvIHNvCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTZXQoc2NvcGUsIHBhcmVudFZhbHVlID0gaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gbGFzdFZhbHVlID0gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICB9LCBudWxsLCBwYXJlbnRHZXQubGl0ZXJhbCk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAnJic6CiAgICAgICAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgIGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gZnVuY3Rpb24obG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRHZXQoc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignaXNjcCcsCiAgICAgICAgICAgICAgICAgICAgIkludmFsaWQgaXNvbGF0ZSBzY29wZSBkZWZpbml0aW9uIGZvciBkaXJlY3RpdmUgJ3swfScuIiArCiAgICAgICAgICAgICAgICAgICAgIiBEZWZpbml0aW9uOiB7Li4uIHsxfTogJ3syfScgLi4ufSIsCiAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUsIHNjb3BlTmFtZSwgZGVmaW5pdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB0cmFuc2NsdWRlRm4gPSBib3VuZFRyYW5zY2x1ZGVGbiAmJiBjb250cm9sbGVyc0JvdW5kVHJhbnNjbHVkZTsKICAgICAgICBpZiAoY29udHJvbGxlckRpcmVjdGl2ZXMpIHsKICAgICAgICAgIGZvckVhY2goY29udHJvbGxlckRpcmVjdGl2ZXMsIGZ1bmN0aW9uKGRpcmVjdGl2ZSkgewogICAgICAgICAgICB2YXIgbG9jYWxzID0gewogICAgICAgICAgICAgICRzY29wZTogZGlyZWN0aXZlID09PSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgfHwgZGlyZWN0aXZlLiQkaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsCiAgICAgICAgICAgICAgJGVsZW1lbnQ6ICRlbGVtZW50LAogICAgICAgICAgICAgICRhdHRyczogYXR0cnMsCiAgICAgICAgICAgICAgJHRyYW5zY2x1ZGU6IHRyYW5zY2x1ZGVGbgogICAgICAgICAgICB9LCBjb250cm9sbGVySW5zdGFuY2U7CgogICAgICAgICAgICBjb250cm9sbGVyID0gZGlyZWN0aXZlLmNvbnRyb2xsZXI7CiAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBhdHRyc1tkaXJlY3RpdmUubmFtZV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRyb2xsZXJJbnN0YW5jZSA9ICRjb250cm9sbGVyKGNvbnRyb2xsZXIsIGxvY2Fscyk7CiAgICAgICAgICAgIC8vIEZvciBkaXJlY3RpdmVzIHdpdGggZWxlbWVudCB0cmFuc2NsdXNpb24gdGhlIGVsZW1lbnQgaXMgYSBjb21tZW50LAogICAgICAgICAgICAvLyBidXQgalF1ZXJ5IC5kYXRhIGRvZXNuJ3Qgc3VwcG9ydCBhdHRhY2hpbmcgZGF0YSB0byBjb21tZW50IG5vZGVzIGFzIGl0J3MgaGFyZCB0bwogICAgICAgICAgICAvLyBjbGVhbiB1cCAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODMzNSkuCiAgICAgICAgICAgIC8vIEluc3RlYWQsIHdlIHNhdmUgdGhlIGNvbnRyb2xsZXJzIGZvciB0aGUgZWxlbWVudCBpbiBhIGxvY2FsIGhhc2ggYW5kIGF0dGFjaCB0byAuZGF0YQogICAgICAgICAgICAvLyBsYXRlciwgb25jZSB3ZSBoYXZlIHRoZSBhY3R1YWwgZWxlbWVudC4KICAgICAgICAgICAgZWxlbWVudENvbnRyb2xsZXJzW2RpcmVjdGl2ZS5uYW1lXSA9IGNvbnRyb2xsZXJJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSkgewogICAgICAgICAgICAgICRlbGVtZW50LmRhdGEoJyQnICsgZGlyZWN0aXZlLm5hbWUgKyAnQ29udHJvbGxlcicsIGNvbnRyb2xsZXJJbnN0YW5jZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXJlY3RpdmUuY29udHJvbGxlckFzKSB7CiAgICAgICAgICAgICAgbG9jYWxzLiRzY29wZVtkaXJlY3RpdmUuY29udHJvbGxlckFzXSA9IGNvbnRyb2xsZXJJbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBQUkVMSU5LSU5HCiAgICAgICAgZm9yKGkgPSAwLCBpaSA9IHByZUxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGlua0ZuID0gcHJlTGlua0Zuc1tpXTsKICAgICAgICAgICAgbGlua0ZuKGxpbmtGbi5pc29sYXRlU2NvcGUgPyBpc29sYXRlU2NvcGUgOiBzY29wZSwgJGVsZW1lbnQsIGF0dHJzLAogICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLmRpcmVjdGl2ZU5hbWUsIGxpbmtGbi5yZXF1aXJlLCAkZWxlbWVudCwgZWxlbWVudENvbnRyb2xsZXJzKSwgdHJhbnNjbHVkZUZuKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFJFQ1VSU0lPTgogICAgICAgIC8vIFdlIG9ubHkgcGFzcyB0aGUgaXNvbGF0ZSBzY29wZSwgaWYgdGhlIGlzb2xhdGUgZGlyZWN0aXZlIGhhcyBhIHRlbXBsYXRlLAogICAgICAgIC8vIG90aGVyd2lzZSB0aGUgY2hpbGQgZWxlbWVudHMgZG8gbm90IGJlbG9uZyB0byB0aGUgaXNvbGF0ZSBkaXJlY3RpdmUuCiAgICAgICAgdmFyIHNjb3BlVG9DaGlsZCA9IHNjb3BlOwogICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgJiYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS50ZW1wbGF0ZSB8fCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUudGVtcGxhdGVVcmwgPT09IG51bGwpKSB7CiAgICAgICAgICBzY29wZVRvQ2hpbGQgPSBpc29sYXRlU2NvcGU7CiAgICAgICAgfQogICAgICAgIGNoaWxkTGlua0ZuICYmIGNoaWxkTGlua0ZuKHNjb3BlVG9DaGlsZCwgbGlua05vZGUuY2hpbGROb2RlcywgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CgogICAgICAgIC8vIFBPU1RMSU5LSU5HCiAgICAgICAgZm9yKGkgPSBwb3N0TGlua0Zucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGlua0ZuID0gcG9zdExpbmtGbnNbaV07CiAgICAgICAgICAgIGxpbmtGbihsaW5rRm4uaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgIGxpbmtGbi5yZXF1aXJlICYmIGdldENvbnRyb2xsZXJzKGxpbmtGbi5kaXJlY3RpdmVOYW1lLCBsaW5rRm4ucmVxdWlyZSwgJGVsZW1lbnQsIGVsZW1lbnRDb250cm9sbGVycyksIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIGlzIHRoZSBmdW5jdGlvbiB0aGF0IGlzIGluamVjdGVkIGFzIGAkdHJhbnNjbHVkZWAuCiAgICAgICAgZnVuY3Rpb24gY29udHJvbGxlcnNCb3VuZFRyYW5zY2x1ZGUoc2NvcGUsIGNsb25lQXR0YWNoRm4pIHsKICAgICAgICAgIHZhciB0cmFuc2NsdWRlQ29udHJvbGxlcnM7CgogICAgICAgICAgLy8gbm8gc2NvcGUgcGFzc2VkCiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgY2xvbmVBdHRhY2hGbiA9IHNjb3BlOwogICAgICAgICAgICBzY29wZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgdHJhbnNjbHVkZUNvbnRyb2xsZXJzID0gZWxlbWVudENvbnRyb2xsZXJzOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBib3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgY2xvbmVBdHRhY2hGbiwgdHJhbnNjbHVkZUNvbnRyb2xsZXJzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtYXJrRGlyZWN0aXZlc0FzSXNvbGF0ZShkaXJlY3RpdmVzKSB7CiAgICAgIC8vIG1hcmsgYWxsIGRpcmVjdGl2ZXMgYXMgbmVlZGluZyBpc29sYXRlIHNjb3BlLgogICAgICBmb3IgKHZhciBqID0gMCwgamogPSBkaXJlY3RpdmVzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICBkaXJlY3RpdmVzW2pdID0gaW5oZXJpdChkaXJlY3RpdmVzW2pdLCB7JCRpc29sYXRlU2NvcGU6IHRydWV9KTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogbG9va3MgdXAgdGhlIGRpcmVjdGl2ZSBhbmQgZGVjb3JhdGVzIGl0IHdpdGggZXhjZXB0aW9uIGhhbmRsaW5nIGFuZCBwcm9wZXIgcGFyYW1ldGVycy4gV2UKICAgICAqIGNhbGwgdGhpcyB0aGUgYm91bmREaXJlY3RpdmUuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgbmFtZSBvZiB0aGUgZGlyZWN0aXZlIHRvIGxvb2sgdXAuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYXRpb24gVGhlIGRpcmVjdGl2ZSBtdXN0IGJlIGZvdW5kIGluIHNwZWNpZmljIGZvcm1hdC4KICAgICAqICAgU3RyaW5nIGNvbnRhaW5pbmcgYW55IG9mIHRoZXNlcyBjaGFyYWN0ZXJzOgogICAgICoKICAgICAqICAgKiBgRWA6IGVsZW1lbnQgbmFtZQogICAgICogICAqIGBBJzogYXR0cmlidXRlCiAgICAgKiAgICogYENgOiBjbGFzcwogICAgICogICAqIGBNYDogY29tbWVudAogICAgICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgZGlyZWN0aXZlIHdhcyBhZGRlZC4KICAgICAqLwogICAgZnVuY3Rpb24gYWRkRGlyZWN0aXZlKHREaXJlY3RpdmVzLCBuYW1lLCBsb2NhdGlvbiwgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwgc3RhcnRBdHRyTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRBdHRyTmFtZSkgewogICAgICBpZiAobmFtZSA9PT0gaWdub3JlRGlyZWN0aXZlKSByZXR1cm4gbnVsbDsKICAgICAgdmFyIG1hdGNoID0gbnVsbDsKICAgICAgaWYgKGhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBmb3IodmFyIGRpcmVjdGl2ZSwgZGlyZWN0aXZlcyA9ICRpbmplY3Rvci5nZXQobmFtZSArIFN1ZmZpeCksCiAgICAgICAgICAgIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgIGlmICggKG1heFByaW9yaXR5ID09PSB1bmRlZmluZWQgfHwgbWF4UHJpb3JpdHkgPiBkaXJlY3RpdmUucHJpb3JpdHkpICYmCiAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0LmluZGV4T2YobG9jYXRpb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgaWYgKHN0YXJ0QXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGluaGVyaXQoZGlyZWN0aXZlLCB7JCRzdGFydDogc3RhcnRBdHRyTmFtZSwgJCRlbmQ6IGVuZEF0dHJOYW1lfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHREaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICBtYXRjaCA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaChlKSB7ICRleGNlcHRpb25IYW5kbGVyKGUpOyB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICogb24gdGhlIHRlbXBsYXRlIG5lZWQgdG8gYmUgbWVyZ2VkIHdpdGggdGhlIGV4aXN0aW5nIGF0dHJpYnV0ZXMgaW4gdGhlIERPTS4KICAgICAqIFRoZSBkZXNpcmVkIGVmZmVjdCBpcyB0byBoYXZlIGJvdGggb2YgdGhlIGF0dHJpYnV0ZXMgcHJlc2VudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZHN0IGRlc3RpbmF0aW9uIGF0dHJpYnV0ZXMgKG9yaWdpbmFsIERPTSkKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzcmMgc291cmNlIGF0dHJpYnV0ZXMgKGZyb20gdGhlIGRpcmVjdGl2ZSB0ZW1wbGF0ZSkKICAgICAqLwogICAgZnVuY3Rpb24gbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXMoZHN0LCBzcmMpIHsKICAgICAgdmFyIHNyY0F0dHIgPSBzcmMuJGF0dHIsCiAgICAgICAgICBkc3RBdHRyID0gZHN0LiRhdHRyLAogICAgICAgICAgJGVsZW1lbnQgPSBkc3QuJCRlbGVtZW50OwoKICAgICAgLy8gcmVhcHBseSB0aGUgb2xkIGF0dHJpYnV0ZXMgdG8gdGhlIG5ldyBlbGVtZW50CiAgICAgIGZvckVhY2goZHN0LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICBpZiAoc3JjW2tleV0gJiYgc3JjW2tleV0gIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHZhbHVlICs9IChrZXkgPT09ICdzdHlsZScgPyAnOycgOiAnICcpICsgc3JjW2tleV07CiAgICAgICAgICB9CiAgICAgICAgICBkc3QuJHNldChrZXksIHZhbHVlLCB0cnVlLCBzcmNBdHRyW2tleV0pOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyBjb3B5IHRoZSBuZXcgYXR0cmlidXRlcyBvbiB0aGUgb2xkIGF0dHJzIG9iamVjdAogICAgICBmb3JFYWNoKHNyYywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmIChrZXkgPT0gJ2NsYXNzJykgewogICAgICAgICAgc2FmZUFkZENsYXNzKCRlbGVtZW50LCB2YWx1ZSk7CiAgICAgICAgICBkc3RbJ2NsYXNzJ10gPSAoZHN0WydjbGFzcyddID8gZHN0WydjbGFzcyddICsgJyAnIDogJycpICsgdmFsdWU7CiAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJ3N0eWxlJykgewogICAgICAgICAgJGVsZW1lbnQuYXR0cignc3R5bGUnLCAkZWxlbWVudC5hdHRyKCdzdHlsZScpICsgJzsnICsgdmFsdWUpOwogICAgICAgICAgZHN0WydzdHlsZSddID0gKGRzdFsnc3R5bGUnXSA/IGRzdFsnc3R5bGUnXSArICc7JyA6ICcnKSArIHZhbHVlOwogICAgICAgICAgLy8gYGRzdGAgd2lsbCBuZXZlciBjb250YWluIGhhc093blByb3BlcnR5IGFzIERPTSBwYXJzZXIgd29uJ3QgbGV0IGl0LgogICAgICAgICAgLy8gWW91IHdpbGwgZ2V0IGFuICJJbnZhbGlkQ2hhcmFjdGVyRXJyb3I6IERPTSBFeGNlcHRpb24gNSIgZXJyb3IgaWYgeW91CiAgICAgICAgICAvLyBoYXZlIGFuIGF0dHJpYnV0ZSBsaWtlICJoYXMtb3duLXByb3BlcnR5IiBvciAiZGF0YS1oYXMtb3duLXByb3BlcnR5IiwgZXRjLgogICAgICAgIH0gZWxzZSBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcgJiYgIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgZHN0QXR0cltrZXldID0gc3JjQXR0cltrZXldOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLCAkY29tcGlsZU5vZGUsIHRBdHRycywKICAgICAgICAkcm9vdEVsZW1lbnQsIGNoaWxkVHJhbnNjbHVkZUZuLCBwcmVMaW5rRm5zLCBwb3N0TGlua0ZucywgcHJldmlvdXNDb21waWxlQ29udGV4dCkgewogICAgICB2YXIgbGlua1F1ZXVlID0gW10sCiAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiwKICAgICAgICAgIGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwKICAgICAgICAgIGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGUgPSAkY29tcGlsZU5vZGVbMF0sCiAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUgPSBkaXJlY3RpdmVzLnNoaWZ0KCksCiAgICAgICAgICAvLyBUaGUgZmFjdCB0aGF0IHdlIGhhdmUgdG8gY29weSBhbmQgcGF0Y2ggdGhlIGRpcmVjdGl2ZSBzZWVtcyB3cm9uZyEKICAgICAgICAgIGRlcml2ZWRTeW5jRGlyZWN0aXZlID0gZXh0ZW5kKHt9LCBvcmlnQXN5bmNEaXJlY3RpdmUsIHsKICAgICAgICAgICAgdGVtcGxhdGVVcmw6IG51bGwsIHRyYW5zY2x1ZGU6IG51bGwsIHJlcGxhY2U6IG51bGwsICQkb3JpZ2luYWxEaXJlY3RpdmU6IG9yaWdBc3luY0RpcmVjdGl2ZQogICAgICAgICAgfSksCiAgICAgICAgICB0ZW1wbGF0ZVVybCA9IChpc0Z1bmN0aW9uKG9yaWdBc3luY0RpcmVjdGl2ZS50ZW1wbGF0ZVVybCkpCiAgICAgICAgICAgICAgPyBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmwoJGNvbXBpbGVOb2RlLCB0QXR0cnMpCiAgICAgICAgICAgICAgOiBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmw7CgogICAgICAkY29tcGlsZU5vZGUuZW1wdHkoKTsKCiAgICAgICRodHRwLmdldCgkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybCh0ZW1wbGF0ZVVybCksIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS4KICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgICAgIHZhciBjb21waWxlTm9kZSwgdGVtcFRlbXBsYXRlQXR0cnMsICR0ZW1wbGF0ZSwgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbjsKCiAgICAgICAgICBjb250ZW50ID0gZGVub3JtYWxpemVUZW1wbGF0ZShjb250ZW50KTsKCiAgICAgICAgICBpZiAob3JpZ0FzeW5jRGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgaWYgKGpxTGl0ZUlzVGV4dE5vZGUoY29udGVudCkpIHsKICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBbXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUodHJpbShjb250ZW50KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbHJ0JywKICAgICAgICAgICAgICAgICAgIlRlbXBsYXRlIGZvciBkaXJlY3RpdmUgJ3swfScgbXVzdCBoYXZlIGV4YWN0bHkgb25lIHJvb3QgZWxlbWVudC4gezF9IiwKICAgICAgICAgICAgICAgICAgb3JpZ0FzeW5jRGlyZWN0aXZlLm5hbWUsIHRlbXBsYXRlVXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGVtcFRlbXBsYXRlQXR0cnMgPSB7JGF0dHI6IHt9fTsKICAgICAgICAgICAgcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKGNvbXBpbGVOb2RlLCBbXSwgdGVtcFRlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KG9yaWdBc3luY0RpcmVjdGl2ZS5zY29wZSkpIHsKICAgICAgICAgICAgICBtYXJrRGlyZWN0aXZlc0FzSXNvbGF0ZSh0ZW1wbGF0ZURpcmVjdGl2ZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpcmVjdGl2ZXMgPSB0ZW1wbGF0ZURpcmVjdGl2ZXMuY29uY2F0KGRpcmVjdGl2ZXMpOwogICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0QXR0cnMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZTsKICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoY29udGVudCk7CiAgICAgICAgICB9CgogICAgICAgICAgZGlyZWN0aXZlcy51bnNoaWZ0KGRlcml2ZWRTeW5jRGlyZWN0aXZlKTsKCiAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiA9IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdEF0dHJzLAogICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGUsIG9yaWdBc3luY0RpcmVjdGl2ZSwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsCiAgICAgICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCk7CiAgICAgICAgICBmb3JFYWNoKCRyb290RWxlbWVudCwgZnVuY3Rpb24obm9kZSwgaSkgewogICAgICAgICAgICBpZiAobm9kZSA9PSBjb21waWxlTm9kZSkgewogICAgICAgICAgICAgICRyb290RWxlbWVudFtpXSA9ICRjb21waWxlTm9kZVswXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlWzBdLmNoaWxkTm9kZXMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKCgogICAgICAgICAgd2hpbGUobGlua1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICB2YXIgc2NvcGUgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgIGJlZm9yZVRlbXBsYXRlTGlua05vZGUgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgIGxpbmtSb290RWxlbWVudCA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgYm91bmRUcmFuc2NsdWRlRm4gPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgIGxpbmtOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwoKICAgICAgICAgICAgaWYgKGJlZm9yZVRlbXBsYXRlTGlua05vZGUgIT09IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICB2YXIgb2xkQ2xhc3NlcyA9IGJlZm9yZVRlbXBsYXRlTGlua05vZGUuY2xhc3NOYW1lOwoKICAgICAgICAgICAgICBpZiAoIShwcmV2aW91c0NvbXBpbGVDb250ZXh0Lmhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlICYmCiAgICAgICAgICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZS5yZXBsYWNlKSkgewogICAgICAgICAgICAgICAgLy8gaXQgd2FzIGNsb25lZCB0aGVyZWZvcmUgd2UgaGF2ZSB0byBjbG9uZSBhcyB3ZWxsLgogICAgICAgICAgICAgICAgbGlua05vZGUgPSBqcUxpdGVDbG9uZShjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXBsYWNlV2l0aChsaW5rUm9vdEVsZW1lbnQsIGpxTGl0ZShiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlKSwgbGlua05vZGUpOwoKICAgICAgICAgICAgICAvLyBDb3B5IGluIENTUyBjbGFzc2VzIGZyb20gb3JpZ2luYWwgbm9kZQogICAgICAgICAgICAgIHNhZmVBZGRDbGFzcyhqcUxpdGUobGlua05vZGUpLCBvbGRDbGFzc2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4udHJhbnNjbHVkZSkgewogICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4gPSBjcmVhdGVCb3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4udHJhbnNjbHVkZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbiA9IGJvdW5kVHJhbnNjbHVkZUZuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsCiAgICAgICAgICAgICAgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICB9CiAgICAgICAgICBsaW5rUXVldWUgPSBudWxsOwogICAgICAgIH0pLgogICAgICAgIGVycm9yKGZ1bmN0aW9uKHJlc3BvbnNlLCBjb2RlLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd0cGxvYWQnLCAnRmFpbGVkIHRvIGxvYWQgdGVtcGxhdGU6IHswfScsIGNvbmZpZy51cmwpOwogICAgICAgIH0pOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGRlbGF5ZWROb2RlTGlua0ZuKGlnbm9yZUNoaWxkTGlua0ZuLCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgaWYgKGxpbmtRdWV1ZSkgewogICAgICAgICAgbGlua1F1ZXVlLnB1c2goc2NvcGUpOwogICAgICAgICAgbGlua1F1ZXVlLnB1c2gobm9kZSk7CiAgICAgICAgICBsaW5rUXVldWUucHVzaChyb290RWxlbWVudCk7CiAgICAgICAgICBsaW5rUXVldWUucHVzaChib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIFNvcnRpbmcgZnVuY3Rpb24gZm9yIGJvdW5kIGRpcmVjdGl2ZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJ5UHJpb3JpdHkoYSwgYikgewogICAgICB2YXIgZGlmZiA9IGIucHJpb3JpdHkgLSBhLnByaW9yaXR5OwogICAgICBpZiAoZGlmZiAhPT0gMCkgcmV0dXJuIGRpZmY7CiAgICAgIGlmIChhLm5hbWUgIT09IGIubmFtZSkgcmV0dXJuIChhLm5hbWUgPCBiLm5hbWUpID8gLTEgOiAxOwogICAgICByZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGFzc2VydE5vRHVwbGljYXRlKHdoYXQsIHByZXZpb3VzRGlyZWN0aXZlLCBkaXJlY3RpdmUsIGVsZW1lbnQpIHsKICAgICAgaWYgKHByZXZpb3VzRGlyZWN0aXZlKSB7CiAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ211bHRpZGlyJywgJ011bHRpcGxlIGRpcmVjdGl2ZXMgW3swfSwgezF9XSBhc2tpbmcgZm9yIHsyfSBvbjogezN9JywKICAgICAgICAgICAgcHJldmlvdXNEaXJlY3RpdmUubmFtZSwgZGlyZWN0aXZlLm5hbWUsIHdoYXQsIHN0YXJ0aW5nVGFnKGVsZW1lbnQpKTsKICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgdGV4dCkgewogICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh0ZXh0LCB0cnVlKTsKICAgICAgaWYgKGludGVycG9sYXRlRm4pIHsKICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgcHJpb3JpdHk6IDAsCiAgICAgICAgICBjb21waWxlOiB2YWx1ZUZuKGZ1bmN0aW9uIHRleHRJbnRlcnBvbGF0ZUxpbmtGbihzY29wZSwgbm9kZSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gbm9kZS5wYXJlbnQoKSwKICAgICAgICAgICAgICAgIGJpbmRpbmdzID0gcGFyZW50LmRhdGEoJyRiaW5kaW5nJykgfHwgW107CiAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goaW50ZXJwb2xhdGVGbik7CiAgICAgICAgICAgIHNhZmVBZGRDbGFzcyhwYXJlbnQuZGF0YSgnJGJpbmRpbmcnLCBiaW5kaW5ncyksICduZy1iaW5kaW5nJyk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBub2RlWzBdLm5vZGVWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gZ2V0VHJ1c3RlZENvbnRleHQobm9kZSwgYXR0ck5vcm1hbGl6ZWROYW1lKSB7CiAgICAgIGlmIChhdHRyTm9ybWFsaXplZE5hbWUgPT0gInNyY2RvYyIpIHsKICAgICAgICByZXR1cm4gJHNjZS5IVE1MOwogICAgICB9CiAgICAgIHZhciB0YWcgPSBub2RlTmFtZV8obm9kZSk7CiAgICAgIC8vIG1hY3Rpb25beGxpbms6aHJlZl0gY2FuIHNvdXJjZSBTVkcuICBJdCdzIG5vdCBsaW1pdGVkIHRvIDxtYWN0aW9uPi4KICAgICAgaWYgKGF0dHJOb3JtYWxpemVkTmFtZSA9PSAieGxpbmtIcmVmIiB8fAogICAgICAgICAgKHRhZyA9PSAiRk9STSIgJiYgYXR0ck5vcm1hbGl6ZWROYW1lID09ICJhY3Rpb24iKSB8fAogICAgICAgICAgKHRhZyAhPSAiSU1HIiAmJiAoYXR0ck5vcm1hbGl6ZWROYW1lID09ICJzcmMiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyTm9ybWFsaXplZE5hbWUgPT0gIm5nU3JjIikpKSB7CiAgICAgICAgcmV0dXJuICRzY2UuUkVTT1VSQ0VfVVJMOwogICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbmFtZSkgewogICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh2YWx1ZSwgdHJ1ZSk7CgogICAgICAvLyBubyBpbnRlcnBvbGF0aW9uIGZvdW5kIC0+IGlnbm9yZQogICAgICBpZiAoIWludGVycG9sYXRlRm4pIHJldHVybjsKCgogICAgICBpZiAobmFtZSA9PT0gIm11bHRpcGxlIiAmJiBub2RlTmFtZV8obm9kZSkgPT09ICJTRUxFQ1QiKSB7CiAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoInNlbG11bHRpIiwKICAgICAgICAgICAgIkJpbmRpbmcgdG8gdGhlICdtdWx0aXBsZScgYXR0cmlidXRlIGlzIG5vdCBzdXBwb3J0ZWQuIEVsZW1lbnQ6IHswfSIsCiAgICAgICAgICAgIHN0YXJ0aW5nVGFnKG5vZGUpKTsKICAgICAgfQoKICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHByZTogZnVuY3Rpb24gYXR0ckludGVycG9sYXRlUHJlTGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgJCRvYnNlcnZlcnMgPSAoYXR0ci4kJG9ic2VydmVycyB8fCAoYXR0ci4kJG9ic2VydmVycyA9IHt9KSk7CgogICAgICAgICAgICAgICAgaWYgKEVWRU5UX0hBTkRMRVJfQVRUUl9SRUdFWFAudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignbm9kb21ldmVudHMnLAogICAgICAgICAgICAgICAgICAgICAgIkludGVycG9sYXRpb25zIGZvciBIVE1MIERPTSBldmVudCBhdHRyaWJ1dGVzIGFyZSBkaXNhbGxvd2VkLiAgUGxlYXNlIHVzZSB0aGUgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm5nLSB2ZXJzaW9ucyAoc3VjaCBhcyBuZy1jbGljayBpbnN0ZWFkIG9mIG9uY2xpY2spIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBpbnRlcnBvbGF0ZSBhZ2FpbiwgaW4gY2FzZSB0aGUgYXR0cmlidXRlIHZhbHVlIGhhcyBiZWVuIHVwZGF0ZWQKICAgICAgICAgICAgICAgIC8vIChlLmcuIGJ5IGFub3RoZXIgZGlyZWN0aXZlJ3MgY29tcGlsZSBmdW5jdGlvbikKICAgICAgICAgICAgICAgIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoYXR0cltuYW1lXSwgdHJ1ZSwgZ2V0VHJ1c3RlZENvbnRleHQobm9kZSwgbmFtZSkpOwoKICAgICAgICAgICAgICAgIC8vIGlmIGF0dHJpYnV0ZSB3YXMgdXBkYXRlZCBzbyB0aGF0IHRoZXJlIGlzIG5vIGludGVycG9sYXRpb24gZ29pbmcgb24gd2UgZG9uJ3Qgd2FudCB0bwogICAgICAgICAgICAgICAgLy8gcmVnaXN0ZXIgYW55IG9ic2VydmVycwogICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gVE9ETyhpKTogdGhpcyBzaG91bGQgbGlrZWx5IGJlIGF0dHIuJHNldChuYW1lLCBpdGVycG9sYXRlRm4oc2NvcGUpIHNvIHRoYXQgd2UgcmVzZXQgdGhlCiAgICAgICAgICAgICAgICAvLyBhY3R1YWwgYXR0ciB2YWx1ZQogICAgICAgICAgICAgICAgYXR0cltuYW1lXSA9IGludGVycG9sYXRlRm4oc2NvcGUpOwogICAgICAgICAgICAgICAgKCQkb2JzZXJ2ZXJzW25hbWVdIHx8ICgkJG9ic2VydmVyc1tuYW1lXSA9IFtdKSkuJCRpbnRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAoYXR0ci4kJG9ic2VydmVycyAmJiBhdHRyLiQkb2JzZXJ2ZXJzW25hbWVdLiQkc2NvcGUgfHwgc2NvcGUpLgogICAgICAgICAgICAgICAgICAkd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIC8vc3BlY2lhbCBjYXNlIGZvciBjbGFzcyBhdHRyaWJ1dGUgYWRkaXRpb24gKyByZW1vdmFsCiAgICAgICAgICAgICAgICAgICAgLy9zbyB0aGF0IGNsYXNzIGNoYW5nZXMgY2FuIHRhcCBpbnRvIHRoZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAvL2hvb2tzIHByb3ZpZGVkIGJ5IHRoZSAkYW5pbWF0ZSBzZXJ2aWNlLiBCZSBzdXJlIHRvCiAgICAgICAgICAgICAgICAgICAgLy9za2lwIGFuaW1hdGlvbnMgd2hlbiB0aGUgZmlyc3QgZGlnZXN0IG9jY3VycyAod2hlbgogICAgICAgICAgICAgICAgICAgIC8vYm90aCB0aGUgbmV3IGFuZCB0aGUgb2xkIHZhbHVlcyBhcmUgdGhlIHNhbWUpIHNpbmNlCiAgICAgICAgICAgICAgICAgICAgLy90aGUgQ1NTIGNsYXNzZXMgYXJlIHRoZSBub24taW50ZXJwb2xhdGVkIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIGlmKG5hbWUgPT09ICdjbGFzcycgJiYgbmV3VmFsdWUgIT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHVwZGF0ZUNsYXNzKG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChuYW1lLCBuZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIFRoaXMgaXMgYSBzcGVjaWFsIGpxTGl0ZS5yZXBsYWNlV2l0aCwgd2hpY2ggY2FuIHJlcGxhY2UgaXRlbXMgd2hpY2gKICAgICAqIGhhdmUgbm8gcGFyZW50cywgcHJvdmlkZWQgdGhhdCB0aGUgY29udGFpbmluZyBqcUxpdGUgY29sbGVjdGlvbiBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0pxTGl0ZT19ICRyb290RWxlbWVudCBUaGUgcm9vdCBvZiB0aGUgY29tcGlsZSB0cmVlLiBVc2VkIHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluIHRoZSByb290IG9mIHRoZSB0cmVlLgogICAgICogQHBhcmFtIHtKcUxpdGV9IGVsZW1lbnRzVG9SZW1vdmUgVGhlIGpxTGl0ZSBlbGVtZW50IHdoaWNoIHdlIGFyZSBnb2luZyB0byByZXBsYWNlLiBXZSBrZWVwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgc2hlbGwsIGJ1dCByZXBsYWNlIGl0cyBET00gbm9kZSByZWZlcmVuY2UuCiAgICAgKiBAcGFyYW0ge05vZGV9IG5ld05vZGUgVGhlIG5ldyBET00gbm9kZS4KICAgICAqLwogICAgZnVuY3Rpb24gcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCBlbGVtZW50c1RvUmVtb3ZlLCBuZXdOb2RlKSB7CiAgICAgIHZhciBmaXJzdEVsZW1lbnRUb1JlbW92ZSA9IGVsZW1lbnRzVG9SZW1vdmVbMF0sCiAgICAgICAgICByZW1vdmVDb3VudCA9IGVsZW1lbnRzVG9SZW1vdmUubGVuZ3RoLAogICAgICAgICAgcGFyZW50ID0gZmlyc3RFbGVtZW50VG9SZW1vdmUucGFyZW50Tm9kZSwKICAgICAgICAgIGksIGlpOwoKICAgICAgaWYgKCRyb290RWxlbWVudCkgewogICAgICAgIGZvcihpID0gMCwgaWkgPSAkcm9vdEVsZW1lbnQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgaWYgKCRyb290RWxlbWVudFtpXSA9PSBmaXJzdEVsZW1lbnRUb1JlbW92ZSkgewogICAgICAgICAgICAkcm9vdEVsZW1lbnRbaSsrXSA9IG5ld05vZGU7CiAgICAgICAgICAgIGZvciAodmFyIGogPSBpLCBqMiA9IGogKyByZW1vdmVDb3VudCAtIDEsCiAgICAgICAgICAgICAgICAgICAgIGpqID0gJHJvb3RFbGVtZW50Lmxlbmd0aDsKICAgICAgICAgICAgICAgICBqIDwgamo7IGorKywgajIrKykgewogICAgICAgICAgICAgIGlmIChqMiA8IGpqKSB7CiAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbal0gPSAkcm9vdEVsZW1lbnRbajJdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgJHJvb3RFbGVtZW50W2pdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAkcm9vdEVsZW1lbnQubGVuZ3RoIC09IHJlbW92ZUNvdW50IC0gMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChuZXdOb2RlLCBmaXJzdEVsZW1lbnRUb1JlbW92ZSk7CiAgICAgIH0KICAgICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChmaXJzdEVsZW1lbnRUb1JlbW92ZSk7CiAgICAgIG5ld05vZGVbanFMaXRlLmV4cGFuZG9dID0gZmlyc3RFbGVtZW50VG9SZW1vdmVbanFMaXRlLmV4cGFuZG9dOwogICAgICBmb3IgKHZhciBrID0gMSwga2sgPSBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aDsgayA8IGtrOyBrKyspIHsKICAgICAgICB2YXIgZWxlbWVudCA9IGVsZW1lbnRzVG9SZW1vdmVba107CiAgICAgICAganFMaXRlKGVsZW1lbnQpLnJlbW92ZSgpOyAvLyBtdXN0IGRvIHRoaXMgd2F5IHRvIGNsZWFuIHVwIGV4cGFuZG8KICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICBkZWxldGUgZWxlbWVudHNUb1JlbW92ZVtrXTsKICAgICAgfQoKICAgICAgZWxlbWVudHNUb1JlbW92ZVswXSA9IG5ld05vZGU7CiAgICAgIGVsZW1lbnRzVG9SZW1vdmUubGVuZ3RoID0gMTsKICAgIH0KCgogICAgZnVuY3Rpb24gY2xvbmVBbmRBbm5vdGF0ZUZuKGZuLCBhbm5vdGF0aW9uKSB7CiAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oKSB7IHJldHVybiBmbi5hcHBseShudWxsLCBhcmd1bWVudHMpOyB9LCBmbiwgYW5ub3RhdGlvbik7CiAgICB9CiAgfV07Cn0KCnZhciBQUkVGSVhfUkVHRVhQID0gL14oeFtcOlwtX118ZGF0YVtcOlwtX10pL2k7Ci8qKgogKiBDb252ZXJ0cyBhbGwgYWNjZXB0ZWQgZGlyZWN0aXZlcyBmb3JtYXQgaW50byBwcm9wZXIgZGlyZWN0aXZlIG5hbWUuCiAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogKiAgIG15OkRpcmVjdGl2ZQogKiAgIG15LWRpcmVjdGl2ZQogKiAgIHgtbXktZGlyZWN0aXZlCiAqICAgZGF0YS1teTpkaXJlY3RpdmUKICoKICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICovCmZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKfQoKLyoqCiAqIEBuZ2RvYyB0eXBlCiAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NCiAqIGVsZW1lbnQgYXR0cmlidXRlcy4gVGhlIHZhbHVlcyByZWZsZWN0IGN1cnJlbnQgYmluZGluZyBzdGF0ZSBge3sgfX1gLiBUaGUgbm9ybWFsaXphdGlvbiBpcwogKiBuZWVkZWQgc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICoKICogYGBgCiAqICAgIDxzcGFuIG5nOmJpbmQ9ImEiIG5nLWJpbmQ9ImEiIGRhdGEtbmctYmluZD0iYSIgeC1uZy1iaW5kPSJhIj4KICogYGBgCiAqLwoKLyoqCiAqIEBuZ2RvYyBwcm9wZXJ0eQogKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkYXR0cgogKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogKiAgICAgICAgICAgICAgICAgICBuZWVkZWQgdG8gZG8gcmV2ZXJzZSBsb29rdXAgZnJvbSBub3JtYWxpemVkIG5hbWUgYmFjayB0byBhY3R1YWwgbmFtZS4KICovCgoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJHNldAogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogU2V0IERPTSBlbGVtZW50IGF0dHJpYnV0ZSB2YWx1ZS4KICoKICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTm9ybWFsaXplZCBlbGVtZW50IGF0dHJpYnV0ZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byBtb2RpZnkuIFRoZSBuYW1lIGlzCiAqICAgICAgICAgIHJldmVyc2UtdHJhbnNsYXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhdHRyICRhdHRyfQogKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFZhbHVlIHRvIHNldCB0aGUgYXR0cmlidXRlIHRvLiBUaGUgdmFsdWUgY2FuIGJlIGFuIGludGVycG9sYXRlZCBzdHJpbmcuCiAqLwoKCgovKioKICogQ2xvc3VyZSBjb21waWxlciB0eXBlIGluZm9ybWF0aW9uCiAqLwoKZnVuY3Rpb24gbm9kZXNldExpbmtpbmdGbigKICAvKiBhbmd1bGFyLlNjb3BlICovIHNjb3BlLAogIC8qIE5vZGVMaXN0ICovIG5vZGVMaXN0LAogIC8qIEVsZW1lbnQgKi8gcm9vdEVsZW1lbnQsCiAgLyogZnVuY3Rpb24oRnVuY3Rpb24pICovIGJvdW5kVHJhbnNjbHVkZUZuCil7fQoKZnVuY3Rpb24gZGlyZWN0aXZlTGlua2luZ0ZuKAogIC8qIG5vZGVzZXRMaW5raW5nRm4gKi8gbm9kZXNldExpbmtpbmdGbiwKICAvKiBhbmd1bGFyLlNjb3BlICovIHNjb3BlLAogIC8qIE5vZGUgKi8gbm9kZSwKICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgope30KCmZ1bmN0aW9uIHRva2VuRGlmZmVyZW5jZShzdHIxLCBzdHIyKSB7CiAgdmFyIHZhbHVlcyA9ICcnLAogICAgICB0b2tlbnMxID0gc3RyMS5zcGxpdCgvXHMrLyksCiAgICAgIHRva2VuczIgPSBzdHIyLnNwbGl0KC9ccysvKTsKCiAgb3V0ZXI6CiAgZm9yKHZhciBpID0gMDsgaSA8IHRva2VuczEubGVuZ3RoOyBpKyspIHsKICAgIHZhciB0b2tlbiA9IHRva2VuczFbaV07CiAgICBmb3IodmFyIGogPSAwOyBqIDwgdG9rZW5zMi5sZW5ndGg7IGorKykgewogICAgICBpZih0b2tlbiA9PSB0b2tlbnMyW2pdKSBjb250aW51ZSBvdXRlcjsKICAgIH0KICAgIHZhbHVlcyArPSAodmFsdWVzLmxlbmd0aCA+IDAgPyAnICcgOiAnJykgKyB0b2tlbjsKICB9CiAgcmV0dXJuIHZhbHVlczsKfQoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkY29udHJvbGxlclByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUge0BsaW5rIG5nLiRjb250cm9sbGVyICRjb250cm9sbGVyIHNlcnZpY2V9IGlzIHVzZWQgYnkgQW5ndWxhciB0byBjcmVhdGUgbmV3CiAqIGNvbnRyb2xsZXJzLgogKgogKiBUaGlzIHByb3ZpZGVyIGFsbG93cyBjb250cm9sbGVyIHJlZ2lzdHJhdGlvbiB2aWEgdGhlCiAqIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyIHJlZ2lzdGVyfSBtZXRob2QuCiAqLwpmdW5jdGlvbiAkQ29udHJvbGxlclByb3ZpZGVyKCkgewogIHZhciBjb250cm9sbGVycyA9IHt9LAogICAgICBDTlRSTF9SRUcgPSAvXihcUyspKFxzK2FzXHMrKFx3KykpPyQvOwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgQ29udHJvbGxlciBuYW1lLCBvciBhbiBvYmplY3QgbWFwIG9mIGNvbnRyb2xsZXJzIHdoZXJlIHRoZSBrZXlzIGFyZQogICAqICAgIHRoZSBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGNvbnN0cnVjdG9ycy4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufEFycmF5fSBjb25zdHJ1Y3RvciBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZuIChvcHRpb25hbGx5IGRlY29yYXRlZCB3aXRoIERJCiAgICogICAgYW5ub3RhdGlvbnMgaW4gdGhlIGFycmF5IG5vdGF0aW9uKS4KICAgKi8KICB0aGlzLnJlZ2lzdGVyID0gZnVuY3Rpb24obmFtZSwgY29uc3RydWN0b3IpIHsKICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdjb250cm9sbGVyJyk7CiAgICBpZiAoaXNPYmplY3QobmFtZSkpIHsKICAgICAgZXh0ZW5kKGNvbnRyb2xsZXJzLCBuYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnRyb2xsZXJzW25hbWVdID0gY29uc3RydWN0b3I7CiAgICB9CiAgfTsKCgogIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyR3aW5kb3cnLCBmdW5jdGlvbigkaW5qZWN0b3IsICR3aW5kb3cpIHsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSAkY29udHJvbGxlcgogICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICoKICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb25zdHJ1Y3RvciBJZiBjYWxsZWQgd2l0aCBhIGZ1bmN0aW9uIHRoZW4gaXQncyBjb25zaWRlcmVkIHRvIGJlIHRoZQogICAgICogICAgY29udHJvbGxlciBjb25zdHJ1Y3RvciBmdW5jdGlvbi4gT3RoZXJ3aXNlIGl0J3MgY29uc2lkZXJlZCB0byBiZSBhIHN0cmluZyB3aGljaCBpcyB1c2VkCiAgICAgKiAgICB0byByZXRyaWV2ZSB0aGUgY29udHJvbGxlciBjb25zdHJ1Y3RvciB1c2luZyB0aGUgZm9sbG93aW5nIHN0ZXBzOgogICAgICoKICAgICAqICAgICogY2hlY2sgaWYgYSBjb250cm9sbGVyIHdpdGggZ2l2ZW4gbmFtZSBpcyByZWdpc3RlcmVkIHZpYSBgJGNvbnRyb2xsZXJQcm92aWRlcmAKICAgICAqICAgICogY2hlY2sgaWYgZXZhbHVhdGluZyB0aGUgc3RyaW5nIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybnMgYSBjb25zdHJ1Y3RvcgogICAgICogICAgKiBjaGVjayBgd2luZG93W2NvbnN0cnVjdG9yXWAgb24gdGhlIGdsb2JhbCBgd2luZG93YCBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbG9jYWxzIEluamVjdGlvbiBsb2NhbHMgZm9yIENvbnRyb2xsZXIuCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEluc3RhbmNlIG9mIGdpdmVuIGNvbnRyb2xsZXIuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBgJGNvbnRyb2xsZXJgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIGluc3RhbnRpYXRpbmcgY29udHJvbGxlcnMuCiAgICAgKgogICAgICogSXQncyBqdXN0IGEgc2ltcGxlIGNhbGwgdG8ge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0sIGJ1dCBleHRyYWN0ZWQgaW50bwogICAgICogYSBzZXJ2aWNlLCBzbyB0aGF0IG9uZSBjYW4gb3ZlcnJpZGUgdGhpcyBzZXJ2aWNlIHdpdGggW0JDIHZlcnNpb25dKGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzE2NDk3ODgpLgogICAgICovCiAgICByZXR1cm4gZnVuY3Rpb24oZXhwcmVzc2lvbiwgbG9jYWxzKSB7CiAgICAgIHZhciBpbnN0YW5jZSwgbWF0Y2gsIGNvbnN0cnVjdG9yLCBpZGVudGlmaWVyOwoKICAgICAgaWYoaXNTdHJpbmcoZXhwcmVzc2lvbikpIHsKICAgICAgICBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goQ05UUkxfUkVHKSwKICAgICAgICBjb25zdHJ1Y3RvciA9IG1hdGNoWzFdLAogICAgICAgIGlkZW50aWZpZXIgPSBtYXRjaFszXTsKICAgICAgICBleHByZXNzaW9uID0gY29udHJvbGxlcnMuaGFzT3duUHJvcGVydHkoY29uc3RydWN0b3IpCiAgICAgICAgICAgID8gY29udHJvbGxlcnNbY29uc3RydWN0b3JdCiAgICAgICAgICAgIDogZ2V0dGVyKGxvY2Fscy4kc2NvcGUsIGNvbnN0cnVjdG9yLCB0cnVlKSB8fCBnZXR0ZXIoJHdpbmRvdywgY29uc3RydWN0b3IsIHRydWUpOwoKICAgICAgICBhc3NlcnRBcmdGbihleHByZXNzaW9uLCBjb25zdHJ1Y3RvciwgdHJ1ZSk7CiAgICAgIH0KCiAgICAgIGluc3RhbmNlID0gJGluamVjdG9yLmluc3RhbnRpYXRlKGV4cHJlc3Npb24sIGxvY2Fscyk7CgogICAgICBpZiAoaWRlbnRpZmllcikgewogICAgICAgIGlmICghKGxvY2FscyAmJiB0eXBlb2YgbG9jYWxzLiRzY29wZSA9PSAnb2JqZWN0JykpIHsKICAgICAgICAgIHRocm93IG1pbkVycignJGNvbnRyb2xsZXInKSgnbm9zY3AnLAogICAgICAgICAgICAgICJDYW5ub3QgZXhwb3J0IGNvbnRyb2xsZXIgJ3swfScgYXMgJ3sxfSchIE5vICRzY29wZSBvYmplY3QgcHJvdmlkZWQgdmlhIGBsb2NhbHNgLiIsCiAgICAgICAgICAgICAgY29uc3RydWN0b3IgfHwgZXhwcmVzc2lvbi5uYW1lLCBpZGVudGlmaWVyKTsKICAgICAgICB9CgogICAgICAgIGxvY2Fscy4kc2NvcGVbaWRlbnRpZmllcl0gPSBpbnN0YW5jZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgfTsKICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRkb2N1bWVudAogKiBAcmVxdWlyZXMgJHdpbmRvdwogKgogKiBAZGVzY3JpcHRpb24KICogQSB7QGxpbmsgYW5ndWxhci5lbGVtZW50IGpRdWVyeSBvciBqcUxpdGV9IHdyYXBwZXIgZm9yIHRoZSBicm93c2VyJ3MgYHdpbmRvdy5kb2N1bWVudGAgb2JqZWN0LgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogICAgICAgICA8cD4kZG9jdW1lbnQgdGl0bGU6IDxiIG5nLWJpbmQ9InRpdGxlIj48L2I+PC9wPgogICAgICAgICA8cD53aW5kb3cuZG9jdW1lbnQgdGl0bGU6IDxiIG5nLWJpbmQ9IndpbmRvd1RpdGxlIj48L2I+PC9wPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICBmdW5jdGlvbiBNYWluQ3RybCgkc2NvcGUsICRkb2N1bWVudCkgewogICAgICAgICAkc2NvcGUudGl0bGUgPSAkZG9jdW1lbnRbMF0udGl0bGU7CiAgICAgICAgICRzY29wZS53aW5kb3dUaXRsZSA9IGFuZ3VsYXIuZWxlbWVudCh3aW5kb3cuZG9jdW1lbnQpWzBdLnRpdGxlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gJERvY3VtZW50UHJvdmlkZXIoKXsKICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbih3aW5kb3cpewogICAgcmV0dXJuIGpxTGl0ZSh3aW5kb3cuZG9jdW1lbnQpOwogIH1dOwp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGV4Y2VwdGlvbkhhbmRsZXIKICogQHJlcXVpcmVzIG5nLiRsb2cKICoKICogQGRlc2NyaXB0aW9uCiAqIEFueSB1bmNhdWdodCBleGNlcHRpb24gaW4gYW5ndWxhciBleHByZXNzaW9ucyBpcyBkZWxlZ2F0ZWQgdG8gdGhpcyBzZXJ2aWNlLgogKiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzaW1wbHkgZGVsZWdhdGVzIHRvIGAkbG9nLmVycm9yYCB3aGljaCBsb2dzIGl0IGludG8KICogdGhlIGJyb3dzZXIgY29uc29sZS4KICoKICogSW4gdW5pdCB0ZXN0cywgaWYgYGFuZ3VsYXItbW9ja3MuanNgIGlzIGxvYWRlZCwgdGhpcyBzZXJ2aWNlIGlzIG92ZXJyaWRkZW4gYnkKICoge0BsaW5rIG5nTW9jay4kZXhjZXB0aW9uSGFuZGxlciBtb2NrICRleGNlcHRpb25IYW5kbGVyfSB3aGljaCBhaWRzIGluIHRlc3RpbmcuCiAqCiAqICMjIEV4YW1wbGU6CiAqCiAqIGBgYGpzCiAqICAgYW5ndWxhci5tb2R1bGUoJ2V4Y2VwdGlvbk92ZXJyaWRlJywgW10pLmZhY3RvcnkoJyRleGNlcHRpb25IYW5kbGVyJywgZnVuY3Rpb24gKCkgewogKiAgICAgcmV0dXJuIGZ1bmN0aW9uIChleGNlcHRpb24sIGNhdXNlKSB7CiAqICAgICAgIGV4Y2VwdGlvbi5tZXNzYWdlICs9ICcgKGNhdXNlZCBieSAiJyArIGNhdXNlICsgJyIpJzsKICogICAgICAgdGhyb3cgZXhjZXB0aW9uOwogKiAgICAgfTsKICogICB9KTsKICogYGBgCiAqCiAqIFRoaXMgZXhhbXBsZSB3aWxsIG92ZXJyaWRlIHRoZSBub3JtYWwgYWN0aW9uIG9mIGAkZXhjZXB0aW9uSGFuZGxlcmAsIHRvIG1ha2UgYW5ndWxhcgogKiBleGNlcHRpb25zIGZhaWwgaGFyZCB3aGVuIHRoZXkgaGFwcGVuLCBpbnN0ZWFkIG9mIGp1c3QgbG9nZ2luZyB0byB0aGUgY29uc29sZS4KICoKICogQHBhcmFtIHtFcnJvcn0gZXhjZXB0aW9uIEV4Y2VwdGlvbiBhc3NvY2lhdGVkIHdpdGggdGhlIGVycm9yLgogKiBAcGFyYW0ge3N0cmluZz19IGNhdXNlIG9wdGlvbmFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjb250ZXh0IGluIHdoaWNoCiAqICAgICAgIHRoZSBlcnJvciB3YXMgdGhyb3duLgogKgogKi8KZnVuY3Rpb24gJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRsb2cnLCBmdW5jdGlvbigkbG9nKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZXhjZXB0aW9uLCBjYXVzZSkgewogICAgICAkbG9nLmVycm9yLmFwcGx5KCRsb2csIGFyZ3VtZW50cyk7CiAgICB9OwogIH1dOwp9CgovKioKICogUGFyc2UgaGVhZGVycyBpbnRvIGtleSB2YWx1ZSBvYmplY3QKICoKICogQHBhcmFtIHtzdHJpbmd9IGhlYWRlcnMgUmF3IGhlYWRlcnMgYXMgYSBzdHJpbmcKICogQHJldHVybnMge09iamVjdH0gUGFyc2VkIGhlYWRlcnMgYXMga2V5IHZhbHVlIG9iamVjdAogKi8KZnVuY3Rpb24gcGFyc2VIZWFkZXJzKGhlYWRlcnMpIHsKICB2YXIgcGFyc2VkID0ge30sIGtleSwgdmFsLCBpOwoKICBpZiAoIWhlYWRlcnMpIHJldHVybiBwYXJzZWQ7CgogIGZvckVhY2goaGVhZGVycy5zcGxpdCgnXG4nKSwgZnVuY3Rpb24obGluZSkgewogICAgaSA9IGxpbmUuaW5kZXhPZignOicpOwogICAga2V5ID0gbG93ZXJjYXNlKHRyaW0obGluZS5zdWJzdHIoMCwgaSkpKTsKICAgIHZhbCA9IHRyaW0obGluZS5zdWJzdHIoaSArIDEpKTsKCiAgICBpZiAoa2V5KSB7CiAgICAgIGlmIChwYXJzZWRba2V5XSkgewogICAgICAgIHBhcnNlZFtrZXldICs9ICcsICcgKyB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyc2VkW2tleV0gPSB2YWw7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgcmV0dXJuIHBhcnNlZDsKfQoKCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBhY2Nlc3MgdG8gcGFyc2VkIGhlYWRlcnMuCiAqCiAqIEhlYWRlcnMgYXJlIGxhenkgcGFyc2VkIHdoZW4gZmlyc3QgcmVxdWVzdGVkLgogKiBAc2VlIHBhcnNlSGVhZGVycwogKgogKiBAcGFyYW0geyhzdHJpbmd8T2JqZWN0KX0gaGVhZGVycyBIZWFkZXJzIHRvIHByb3ZpZGUgYWNjZXNzIHRvLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oc3RyaW5nPSl9IFJldHVybnMgYSBnZXR0ZXIgZnVuY3Rpb24gd2hpY2ggaWYgY2FsbGVkIHdpdGg6CiAqCiAqICAgLSBpZiBjYWxsZWQgd2l0aCBzaW5nbGUgYW4gYXJndW1lbnQgcmV0dXJucyBhIHNpbmdsZSBoZWFkZXIgdmFsdWUgb3IgbnVsbAogKiAgIC0gaWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIGhlYWRlcnMuCiAqLwpmdW5jdGlvbiBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpIHsKICB2YXIgaGVhZGVyc09iaiA9IGlzT2JqZWN0KGhlYWRlcnMpID8gaGVhZGVycyA6IHVuZGVmaW5lZDsKCiAgcmV0dXJuIGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmICghaGVhZGVyc09iaikgaGVhZGVyc09iaiA9ICBwYXJzZUhlYWRlcnMoaGVhZGVycyk7CgogICAgaWYgKG5hbWUpIHsKICAgICAgcmV0dXJuIGhlYWRlcnNPYmpbbG93ZXJjYXNlKG5hbWUpXSB8fCBudWxsOwogICAgfQoKICAgIHJldHVybiBoZWFkZXJzT2JqOwogIH07Cn0KCgovKioKICogQ2hhaW4gYWxsIGdpdmVuIGZ1bmN0aW9ucwogKgogKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgZm9yIGJvdGggcmVxdWVzdCBhbmQgcmVzcG9uc2UgdHJhbnNmb3JtaW5nCiAqCiAqIEBwYXJhbSB7Kn0gZGF0YSBEYXRhIHRvIHRyYW5zZm9ybS4KICogQHBhcmFtIHtmdW5jdGlvbihzdHJpbmc9KX0gaGVhZGVycyBIdHRwIGhlYWRlcnMgZ2V0dGVyIGZuLgogKiBAcGFyYW0geyhGdW5jdGlvbnxBcnJheS48RnVuY3Rpb24+KX0gZm5zIEZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIGZ1bmN0aW9ucy4KICogQHJldHVybnMgeyp9IFRyYW5zZm9ybWVkIGRhdGEuCiAqLwpmdW5jdGlvbiB0cmFuc2Zvcm1EYXRhKGRhdGEsIGhlYWRlcnMsIGZucykgewogIGlmIChpc0Z1bmN0aW9uKGZucykpCiAgICByZXR1cm4gZm5zKGRhdGEsIGhlYWRlcnMpOwoKICBmb3JFYWNoKGZucywgZnVuY3Rpb24oZm4pIHsKICAgIGRhdGEgPSBmbihkYXRhLCBoZWFkZXJzKTsKICB9KTsKCiAgcmV0dXJuIGRhdGE7Cn0KCgpmdW5jdGlvbiBpc1N1Y2Nlc3Moc3RhdHVzKSB7CiAgcmV0dXJuIDIwMCA8PSBzdGF0dXMgJiYgc3RhdHVzIDwgMzAwOwp9CgoKZnVuY3Rpb24gJEh0dHBQcm92aWRlcigpIHsKICB2YXIgSlNPTl9TVEFSVCA9IC9eXHMqKFxbfFx7W15ce10pLywKICAgICAgSlNPTl9FTkQgPSAvW1x9XF1dXHMqJC8sCiAgICAgIFBST1RFQ1RJT05fUFJFRklYID0gL15cKVxdXH0nLD9cbi8sCiAgICAgIENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OID0geydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04J307CgogIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAvLyB0cmFuc2Zvcm0gaW5jb21pbmcgcmVzcG9uc2UgZGF0YQogICAgdHJhbnNmb3JtUmVzcG9uc2U6IFtmdW5jdGlvbihkYXRhKSB7CiAgICAgIGlmIChpc1N0cmluZyhkYXRhKSkgewogICAgICAgIC8vIHN0cmlwIGpzb24gdnVsbmVyYWJpbGl0eSBwcm90ZWN0aW9uIHByZWZpeAogICAgICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UoUFJPVEVDVElPTl9QUkVGSVgsICcnKTsKICAgICAgICBpZiAoSlNPTl9TVEFSVC50ZXN0KGRhdGEpICYmIEpTT05fRU5ELnRlc3QoZGF0YSkpCiAgICAgICAgICBkYXRhID0gZnJvbUpzb24oZGF0YSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9XSwKCiAgICAvLyB0cmFuc2Zvcm0gb3V0Z29pbmcgcmVxdWVzdCBkYXRhCiAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBbZnVuY3Rpb24oZCkgewogICAgICByZXR1cm4gaXNPYmplY3QoZCkgJiYgIWlzRmlsZShkKSAmJiAhaXNCbG9iKGQpID8gdG9Kc29uKGQpIDogZDsKICAgIH1dLAoKICAgIC8vIGRlZmF1bHQgaGVhZGVycwogICAgaGVhZGVyczogewogICAgICBjb21tb246IHsKICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKicKICAgICAgfSwKICAgICAgcG9zdDogICBzaGFsbG93Q29weShDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTiksCiAgICAgIHB1dDogICAgc2hhbGxvd0NvcHkoQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04pLAogICAgICBwYXRjaDogIHNoYWxsb3dDb3B5KENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OKQogICAgfSwKCiAgICB4c3JmQ29va2llTmFtZTogJ1hTUkYtVE9LRU4nLAogICAgeHNyZkhlYWRlck5hbWU6ICdYLVhTUkYtVE9LRU4nCiAgfTsKCiAgLyoqCiAgICogQXJlIG9yZGVyZWQgYnkgcmVxdWVzdCwgaS5lLiB0aGV5IGFyZSBhcHBsaWVkIGluIHRoZSBzYW1lIG9yZGVyIGFzIHRoZQogICAqIGFycmF5LCBvbiByZXF1ZXN0LCBidXQgcmV2ZXJzZSBvcmRlciwgb24gcmVzcG9uc2UuCiAgICovCiAgdmFyIGludGVyY2VwdG9yRmFjdG9yaWVzID0gdGhpcy5pbnRlcmNlcHRvcnMgPSBbXTsKCiAgLyoqCiAgICogRm9yIGhpc3RvcmljYWwgcmVhc29ucywgcmVzcG9uc2UgaW50ZXJjZXB0b3JzIGFyZSBvcmRlcmVkIGJ5IHRoZSBvcmRlciBpbiB3aGljaAogICAqIHRoZXkgYXJlIGFwcGxpZWQgdG8gdGhlIHJlc3BvbnNlLiAoVGhpcyBpcyB0aGUgb3Bwb3NpdGUgb2YgaW50ZXJjZXB0b3JGYWN0b3JpZXMpCiAgICovCiAgdmFyIHJlc3BvbnNlSW50ZXJjZXB0b3JGYWN0b3JpZXMgPSB0aGlzLnJlc3BvbnNlSW50ZXJjZXB0b3JzID0gW107CgogIHRoaXMuJGdldCA9IFsnJGh0dHBCYWNrZW5kJywgJyRicm93c2VyJywgJyRjYWNoZUZhY3RvcnknLCAnJHJvb3RTY29wZScsICckcScsICckaW5qZWN0b3InLAogICAgICBmdW5jdGlvbigkaHR0cEJhY2tlbmQsICRicm93c2VyLCAkY2FjaGVGYWN0b3J5LCAkcm9vdFNjb3BlLCAkcSwgJGluamVjdG9yKSB7CgogICAgdmFyIGRlZmF1bHRDYWNoZSA9ICRjYWNoZUZhY3RvcnkoJyRodHRwJyk7CgogICAgLyoqCiAgICAgKiBJbnRlcmNlcHRvcnMgc3RvcmVkIGluIHJldmVyc2Ugb3JkZXIuIElubmVyIGludGVyY2VwdG9ycyBiZWZvcmUgb3V0ZXIgaW50ZXJjZXB0b3JzLgogICAgICogVGhlIHJldmVyc2FsIGlzIG5lZWRlZCBzbyB0aGF0IHdlIGNhbiBidWlsZCB1cCB0aGUgaW50ZXJjZXB0aW9uIGNoYWluIGFyb3VuZCB0aGUKICAgICAqIHNlcnZlciByZXF1ZXN0LgogICAgICovCiAgICB2YXIgcmV2ZXJzZWRJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICBmb3JFYWNoKGludGVyY2VwdG9yRmFjdG9yaWVzLCBmdW5jdGlvbihpbnRlcmNlcHRvckZhY3RvcnkpIHsKICAgICAgcmV2ZXJzZWRJbnRlcmNlcHRvcnMudW5zaGlmdChpc1N0cmluZyhpbnRlcmNlcHRvckZhY3RvcnkpCiAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3JGYWN0b3J5KSA6ICRpbmplY3Rvci5pbnZva2UoaW50ZXJjZXB0b3JGYWN0b3J5KSk7CiAgICB9KTsKCiAgICBmb3JFYWNoKHJlc3BvbnNlSW50ZXJjZXB0b3JGYWN0b3JpZXMsIGZ1bmN0aW9uKGludGVyY2VwdG9yRmFjdG9yeSwgaW5kZXgpIHsKICAgICAgdmFyIHJlc3BvbnNlRm4gPSBpc1N0cmluZyhpbnRlcmNlcHRvckZhY3RvcnkpCiAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgOiAkaW5qZWN0b3IuaW52b2tlKGludGVyY2VwdG9yRmFjdG9yeSk7CgogICAgICAvKioKICAgICAgICogUmVzcG9uc2UgaW50ZXJjZXB0b3JzIGdvIGJlZm9yZSAiYXJvdW5kIiBpbnRlcmNlcHRvcnMgKG5vIHJlYWwgcmVhc29uLCBqdXN0CiAgICAgICAqIGhhZCB0byBwaWNrIG9uZS4pIEJ1dCB0aGV5IGFyZSBhbHJlYWR5IHJldmVyc2VkLCBzbyB3ZSBjYW4ndCB1c2UgdW5zaGlmdCwgaGVuY2UKICAgICAgICogdGhlIHNwbGljZS4KICAgICAgICovCiAgICAgIHJldmVyc2VkSW50ZXJjZXB0b3JzLnNwbGljZShpbmRleCwgMCwgewogICAgICAgIHJlc3BvbnNlOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgcmV0dXJuIHJlc3BvbnNlRm4oJHEud2hlbihyZXNwb25zZSkpOwogICAgICAgIH0sCiAgICAgICAgcmVzcG9uc2VFcnJvcjogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIHJldHVybiByZXNwb25zZUZuKCRxLnJlamVjdChyZXNwb25zZSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqIEBuYW1lICRodHRwCiAgICAgKiBAcmVxdWlyZXMgbmcuJGh0dHBCYWNrZW5kCiAgICAgKiBAcmVxdWlyZXMgJGNhY2hlRmFjdG9yeQogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqIEByZXF1aXJlcyAkcQogICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGAkaHR0cGAgc2VydmljZSBpcyBhIGNvcmUgQW5ndWxhciBzZXJ2aWNlIHRoYXQgZmFjaWxpdGF0ZXMgY29tbXVuaWNhdGlvbiB3aXRoIHRoZSByZW1vdGUKICAgICAqIEhUVFAgc2VydmVycyB2aWEgdGhlIGJyb3dzZXIncyBbWE1MSHR0cFJlcXVlc3RdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL3htbGh0dHByZXF1ZXN0KQogICAgICogb2JqZWN0IG9yIHZpYSBbSlNPTlBdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlApLgogICAgICoKICAgICAqIEZvciB1bml0IHRlc3RpbmcgYXBwbGljYXRpb25zIHRoYXQgdXNlIGAkaHR0cGAgc2VydmljZSwgc2VlCiAgICAgKiB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCAkaHR0cEJhY2tlbmQgbW9ja30uCiAgICAgKgogICAgICogRm9yIGEgaGlnaGVyIGxldmVsIG9mIGFic3RyYWN0aW9uLCBwbGVhc2UgY2hlY2sgb3V0IHRoZSB7QGxpbmsgbmdSZXNvdXJjZS4kcmVzb3VyY2UKICAgICAqICRyZXNvdXJjZX0gc2VydmljZS4KICAgICAqCiAgICAgKiBUaGUgJGh0dHAgQVBJIGlzIGJhc2VkIG9uIHRoZSB7QGxpbmsgbmcuJHEgZGVmZXJyZWQvcHJvbWlzZSBBUElzfSBleHBvc2VkIGJ5CiAgICAgKiB0aGUgJHEgc2VydmljZS4gV2hpbGUgZm9yIHNpbXBsZSB1c2FnZSBwYXR0ZXJucyB0aGlzIGRvZXNuJ3QgbWF0dGVyIG11Y2gsIGZvciBhZHZhbmNlZCB1c2FnZQogICAgICogaXQgaXMgaW1wb3J0YW50IHRvIGZhbWlsaWFyaXplIHlvdXJzZWxmIHdpdGggdGhlc2UgQVBJcyBhbmQgdGhlIGd1YXJhbnRlZXMgdGhleSBwcm92aWRlLgogICAgICoKICAgICAqCiAgICAgKiAjIEdlbmVyYWwgdXNhZ2UKICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBmdW5jdGlvbiB3aGljaCB0YWtlcyBhIHNpbmdsZSBhcmd1bWVudCDigJQgYSBjb25maWd1cmF0aW9uIG9iamVjdCDigJQKICAgICAqIHRoYXQgaXMgdXNlZCB0byBnZW5lcmF0ZSBhbiBIVFRQIHJlcXVlc3QgYW5kIHJldHVybnMgIGEge0BsaW5rIG5nLiRxIHByb21pc2V9CiAgICAgKiB3aXRoIHR3byAkaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgJGh0dHAoe21ldGhvZDogJ0dFVCcsIHVybDogJy9zb21lVXJsJ30pLgogICAgICogICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIHRoaXMgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAqICAgICAgIC8vIHdoZW4gdGhlIHJlc3BvbnNlIGlzIGF2YWlsYWJsZQogICAgICogICAgIH0pLgogICAgICogICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyBjYWxsZWQgYXN5bmNocm9ub3VzbHkgaWYgYW4gZXJyb3Igb2NjdXJzCiAgICAgKiAgICAgICAvLyBvciBzZXJ2ZXIgcmV0dXJucyByZXNwb25zZSB3aXRoIGFuIGVycm9yIHN0YXR1cy4KICAgICAqICAgICB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqIFNpbmNlIHRoZSByZXR1cm5lZCB2YWx1ZSBvZiBjYWxsaW5nIHRoZSAkaHR0cCBmdW5jdGlvbiBpcyBhIGBwcm9taXNlYCwgeW91IGNhbiBhbHNvIHVzZQogICAgICogdGhlIGB0aGVuYCBtZXRob2QgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzLCBhbmQgdGhlc2UgY2FsbGJhY2tzIHdpbGwgcmVjZWl2ZSBhIHNpbmdsZSBhcmd1bWVudCDigJMKICAgICAqIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlc3BvbnNlLiBTZWUgdGhlIEFQSSBzaWduYXR1cmUgYW5kIHR5cGUgaW5mbyBiZWxvdyBmb3IgbW9yZQogICAgICogZGV0YWlscy4KICAgICAqCiAgICAgKiBBIHJlc3BvbnNlIHN0YXR1cyBjb2RlIGJldHdlZW4gMjAwIGFuZCAyOTkgaXMgY29uc2lkZXJlZCBhIHN1Y2Nlc3Mgc3RhdHVzIGFuZAogICAgICogd2lsbCByZXN1bHQgaW4gdGhlIHN1Y2Nlc3MgY2FsbGJhY2sgYmVpbmcgY2FsbGVkLiBOb3RlIHRoYXQgaWYgdGhlIHJlc3BvbnNlIGlzIGEgcmVkaXJlY3QsCiAgICAgKiBYTUxIdHRwUmVxdWVzdCB3aWxsIHRyYW5zcGFyZW50bHkgZm9sbG93IGl0LCBtZWFuaW5nIHRoYXQgdGhlIGVycm9yIGNhbGxiYWNrIHdpbGwgbm90IGJlCiAgICAgKiBjYWxsZWQgZm9yIHN1Y2ggcmVzcG9uc2VzLgogICAgICoKICAgICAqICMgV3JpdGluZyBVbml0IFRlc3RzIHRoYXQgdXNlICRodHRwCiAgICAgKiBXaGVuIHVuaXQgdGVzdGluZyAodXNpbmcge0BsaW5rIG5nTW9jayBuZ01vY2t9KSwgaXQgaXMgbmVjZXNzYXJ5IHRvIGNhbGwKICAgICAqIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kI2ZsdXNoICRodHRwQmFja2VuZC5mbHVzaCgpfSB0byBmbHVzaCBlYWNoIHBlbmRpbmcKICAgICAqIHJlcXVlc3QgdXNpbmcgdHJhaW5lZCByZXNwb25zZXMuCiAgICAgKgogICAgICogYGBgCiAgICAgKiAkaHR0cEJhY2tlbmQuZXhwZWN0R0VUKC4uLik7CiAgICAgKiAkaHR0cC5nZXQoLi4uKTsKICAgICAqICRodHRwQmFja2VuZC5mbHVzaCgpOwogICAgICogYGBgCiAgICAgKgogICAgICogIyBTaG9ydGN1dCBtZXRob2RzCiAgICAgKgogICAgICogU2hvcnRjdXQgbWV0aG9kcyBhcmUgYWxzbyBhdmFpbGFibGUuIEFsbCBzaG9ydGN1dCBtZXRob2RzIHJlcXVpcmUgcGFzc2luZyBpbiB0aGUgVVJMLCBhbmQKICAgICAqIHJlcXVlc3QgZGF0YSBtdXN0IGJlIHBhc3NlZCBpbiBmb3IgUE9TVC9QVVQgcmVxdWVzdHMuCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgJGh0dHAuZ2V0KCcvc29tZVVybCcpLnN1Y2Nlc3Moc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAqICAgJGh0dHAucG9zdCgnL3NvbWVVcmwnLCBkYXRhKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBDb21wbGV0ZSBsaXN0IG9mIHNob3J0Y3V0IG1ldGhvZHM6CiAgICAgKgogICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZ2V0ICRodHRwLmdldH0KICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2hlYWQgJGh0dHAuaGVhZH0KICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3Bvc3QgJGh0dHAucG9zdH0KICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3B1dCAkaHR0cC5wdXR9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNkZWxldGUgJGh0dHAuZGVsZXRlfQogICAgICogLSB7QGxpbmsgbmcuJGh0dHAjanNvbnAgJGh0dHAuanNvbnB9CiAgICAgKgogICAgICoKICAgICAqICMgU2V0dGluZyBIVFRQIEhlYWRlcnMKICAgICAqCiAgICAgKiBUaGUgJGh0dHAgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIGNlcnRhaW4gSFRUUCBoZWFkZXJzIHRvIGFsbCByZXF1ZXN0cy4gVGhlc2UgZGVmYXVsdHMKICAgICAqIGNhbiBiZSBmdWxseSBjb25maWd1cmVkIGJ5IGFjY2Vzc2luZyB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVyc2AgY29uZmlndXJhdGlvbgogICAgICogb2JqZWN0LCB3aGljaCBjdXJyZW50bHkgY29udGFpbnMgdGhpcyBkZWZhdWx0IGNvbmZpZ3VyYXRpb246CiAgICAgKgogICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbmAgKGhlYWRlcnMgdGhhdCBhcmUgY29tbW9uIGZvciBhbGwgcmVxdWVzdHMpOgogICAgICogICAtIGBBY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICogLyAqYAogICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnBvc3RgOiAoaGVhZGVyIGRlZmF1bHRzIGZvciBQT1NUIHJlcXVlc3RzKQogICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgKiAtIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMucHV0YCAoaGVhZGVyIGRlZmF1bHRzIGZvciBQVVQgcmVxdWVzdHMpCiAgICAgKiAgIC0gYENvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbmAKICAgICAqCiAgICAgKiBUbyBhZGQgb3Igb3ZlcndyaXRlIHRoZXNlIGRlZmF1bHRzLCBzaW1wbHkgYWRkIG9yIHJlbW92ZSBhIHByb3BlcnR5IGZyb20gdGhlc2UgY29uZmlndXJhdGlvbgogICAgICogb2JqZWN0cy4gVG8gYWRkIGhlYWRlcnMgZm9yIGFuIEhUVFAgbWV0aG9kIG90aGVyIHRoYW4gUE9TVCBvciBQVVQsIHNpbXBseSBhZGQgYSBuZXcgb2JqZWN0CiAgICAgKiB3aXRoIHRoZSBsb3dlcmNhc2VkIEhUVFAgbWV0aG9kIG5hbWUgYXMgdGhlIGtleSwgZS5nLgogICAgICogYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5nZXQgPSB7ICdNeS1IZWFkZXInIDogJ3ZhbHVlJyB9LgogICAgICoKICAgICAqIFRoZSBkZWZhdWx0cyBjYW4gYWxzbyBiZSBzZXQgYXQgcnVudGltZSB2aWEgdGhlIGAkaHR0cC5kZWZhdWx0c2Agb2JqZWN0IGluIHRoZSBzYW1lCiAgICAgKiBmYXNoaW9uLiBGb3IgZXhhbXBsZToKICAgICAqCiAgICAgKiBgYGAKICAgICAqIG1vZHVsZS5ydW4oZnVuY3Rpb24oJGh0dHApIHsKICAgICAqICAgJGh0dHAuZGVmYXVsdHMuaGVhZGVycy5jb21tb24uQXV0aG9yaXphdGlvbiA9ICdCYXNpYyBZbVZsY0RwaWIyOXcnCiAgICAgKiB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqIEluIGFkZGl0aW9uLCB5b3UgY2FuIHN1cHBseSBhIGBoZWFkZXJzYCBwcm9wZXJ0eSBpbiB0aGUgY29uZmlnIG9iamVjdCBwYXNzZWQgd2hlbgogICAgICogY2FsbGluZyBgJGh0dHAoY29uZmlnKWAsIHdoaWNoIG92ZXJyaWRlcyB0aGUgZGVmYXVsdHMgd2l0aG91dCBjaGFuZ2luZyB0aGVtIGdsb2JhbGx5LgogICAgICoKICAgICAqCiAgICAgKiAjIFRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzCiAgICAgKgogICAgICogQm90aCByZXF1ZXN0cyBhbmQgcmVzcG9uc2VzIGNhbiBiZSB0cmFuc2Zvcm1lZCB1c2luZyB0cmFuc2Zvcm0gZnVuY3Rpb25zLiBCeSBkZWZhdWx0LCBBbmd1bGFyCiAgICAgKiBhcHBsaWVzIHRoZXNlIHRyYW5zZm9ybWF0aW9uczoKICAgICAqCiAgICAgKiBSZXF1ZXN0IHRyYW5zZm9ybWF0aW9uczoKICAgICAqCiAgICAgKiAtIElmIHRoZSBgZGF0YWAgcHJvcGVydHkgb2YgdGhlIHJlcXVlc3QgY29uZmlndXJhdGlvbiBvYmplY3QgY29udGFpbnMgYW4gb2JqZWN0LCBzZXJpYWxpemUgaXQKICAgICAqICAgaW50byBKU09OIGZvcm1hdC4KICAgICAqCiAgICAgKiBSZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgKgogICAgICogIC0gSWYgWFNSRiBwcmVmaXggaXMgZGV0ZWN0ZWQsIHN0cmlwIGl0IChzZWUgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMgc2VjdGlvbiBiZWxvdykuCiAgICAgKiAgLSBJZiBKU09OIHJlc3BvbnNlIGlzIGRldGVjdGVkLCBkZXNlcmlhbGl6ZSBpdCB1c2luZyBhIEpTT04gcGFyc2VyLgogICAgICoKICAgICAqIFRvIGdsb2JhbGx5IGF1Z21lbnQgb3Igb3ZlcnJpZGUgdGhlIGRlZmF1bHQgdHJhbnNmb3JtcywgbW9kaWZ5IHRoZQogICAgICogYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdGAgYW5kIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlYAogICAgICogcHJvcGVydGllcy4gVGhlc2UgcHJvcGVydGllcyBhcmUgYnkgZGVmYXVsdCBhbiBhcnJheSBvZiB0cmFuc2Zvcm0gZnVuY3Rpb25zLCB3aGljaCBhbGxvd3MgeW91CiAgICAgKiB0byBgcHVzaGAgb3IgYHVuc2hpZnRgIGEgbmV3IHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIGludG8gdGhlIHRyYW5zZm9ybWF0aW9uIGNoYWluLiBZb3UgY2FuCiAgICAgKiBhbHNvIGRlY2lkZSB0byBjb21wbGV0ZWx5IG92ZXJyaWRlIGFueSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyBieSBhc3NpZ25pbmcgeW91cgogICAgICogdHJhbnNmb3JtYXRpb24gZnVuY3Rpb25zIHRvIHRoZXNlIHByb3BlcnRpZXMgZGlyZWN0bHkgd2l0aG91dCB0aGUgYXJyYXkgd3JhcHBlci4gIFRoZXNlIGRlZmF1bHRzCiAgICAgKiBhcmUgYWdhaW4gYXZhaWxhYmxlIG9uIHRoZSAkaHR0cCBmYWN0b3J5IGF0IHJ1bi10aW1lLCB3aGljaCBtYXkgYmUgdXNlZnVsIGlmIHlvdSBoYXZlIHJ1bi10aW1lCiAgICAgKiBzZXJ2aWNlcyB5b3Ugd2lzaCB0byBiZSBpbnZvbHZlZCBpbiB5b3VyIHRyYW5zZm9ybWF0aW9ucy4KICAgICAqCiAgICAgKiBTaW1pbGFybHksIHRvIGxvY2FsbHkgb3ZlcnJpZGUgdGhlIHJlcXVlc3QvcmVzcG9uc2UgdHJhbnNmb3JtcywgYXVnbWVudCB0aGUKICAgICAqIGB0cmFuc2Zvcm1SZXF1ZXN0YCBhbmQvb3IgYHRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQKICAgICAqIGludG8gYCRodHRwYC4KICAgICAqCiAgICAgKgogICAgICogIyBDYWNoaW5nCiAgICAgKgogICAgICogVG8gZW5hYmxlIGNhY2hpbmcsIHNldCB0aGUgcmVxdWVzdCBjb25maWd1cmF0aW9uIGBjYWNoZWAgcHJvcGVydHkgdG8gYHRydWVgICh0byB1c2UgZGVmYXVsdAogICAgICogY2FjaGUpIG9yIHRvIGEgY3VzdG9tIGNhY2hlIG9iamVjdCAoYnVpbHQgd2l0aCB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSBgJGNhY2hlRmFjdG9yeWB9KS4KICAgICAqIFdoZW4gdGhlIGNhY2hlIGlzIGVuYWJsZWQsIGAkaHR0cGAgc3RvcmVzIHRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIgaW4gdGhlIHNwZWNpZmllZAogICAgICogY2FjaGUuIFRoZSBuZXh0IHRpbWUgdGhlIHNhbWUgcmVxdWVzdCBpcyBtYWRlLCB0aGUgcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gdGhlIGNhY2hlIHdpdGhvdXQKICAgICAqIHNlbmRpbmcgYSByZXF1ZXN0IHRvIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogTm90ZSB0aGF0IGV2ZW4gaWYgdGhlIHJlc3BvbnNlIGlzIHNlcnZlZCBmcm9tIGNhY2hlLCBkZWxpdmVyeSBvZiB0aGUgZGF0YSBpcyBhc3luY2hyb25vdXMgaW4KICAgICAqIHRoZSBzYW1lIHdheSB0aGF0IHJlYWwgcmVxdWVzdHMgYXJlLgogICAgICoKICAgICAqIElmIHRoZXJlIGFyZSBtdWx0aXBsZSBHRVQgcmVxdWVzdHMgZm9yIHRoZSBzYW1lIFVSTCB0aGF0IHNob3VsZCBiZSBjYWNoZWQgdXNpbmcgdGhlIHNhbWUKICAgICAqIGNhY2hlLCBidXQgdGhlIGNhY2hlIGlzIG5vdCBwb3B1bGF0ZWQgeWV0LCBvbmx5IG9uZSByZXF1ZXN0IHRvIHRoZSBzZXJ2ZXIgd2lsbCBiZSBtYWRlIGFuZAogICAgICogdGhlIHJlbWFpbmluZyByZXF1ZXN0cyB3aWxsIGJlIGZ1bGZpbGxlZCB1c2luZyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgZmlyc3QgcmVxdWVzdC4KICAgICAqCiAgICAgKiBZb3UgY2FuIGNoYW5nZSB0aGUgZGVmYXVsdCBjYWNoZSB0byBhIG5ldyBvYmplY3QgKGJ1aWx0IHdpdGgKICAgICAqIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5IGAkY2FjaGVGYWN0b3J5YH0pIGJ5IHVwZGF0aW5nIHRoZQogICAgICoge0BsaW5rIG5nLiRodHRwI3Byb3BlcnRpZXNfZGVmYXVsdHMgYCRodHRwLmRlZmF1bHRzLmNhY2hlYH0gcHJvcGVydHkuIEFsbCByZXF1ZXN0cyB3aG8gc2V0CiAgICAgKiB0aGVpciBgY2FjaGVgIHByb3BlcnR5IHRvIGB0cnVlYCB3aWxsIG5vdyB1c2UgdGhpcyBjYWNoZSBvYmplY3QuCiAgICAgKgogICAgICogSWYgeW91IHNldCB0aGUgZGVmYXVsdCBjYWNoZSB0byBgZmFsc2VgIHRoZW4gb25seSByZXF1ZXN0cyB0aGF0IHNwZWNpZnkgdGhlaXIgb3duIGN1c3RvbQogICAgICogY2FjaGUgb2JqZWN0IHdpbGwgYmUgY2FjaGVkLgogICAgICoKICAgICAqICMgSW50ZXJjZXB0b3JzCiAgICAgKgogICAgICogQmVmb3JlIHlvdSBzdGFydCBjcmVhdGluZyBpbnRlcmNlcHRvcnMsIGJlIHN1cmUgdG8gdW5kZXJzdGFuZCB0aGUKICAgICAqIHtAbGluayBuZy4kcSAkcSBhbmQgZGVmZXJyZWQvcHJvbWlzZSBBUElzfS4KICAgICAqCiAgICAgKiBGb3IgcHVycG9zZXMgb2YgZ2xvYmFsIGVycm9yIGhhbmRsaW5nLCBhdXRoZW50aWNhdGlvbiwgb3IgYW55IGtpbmQgb2Ygc3luY2hyb25vdXMgb3IKICAgICAqIGFzeW5jaHJvbm91cyBwcmUtcHJvY2Vzc2luZyBvZiByZXF1ZXN0IG9yIHBvc3Rwcm9jZXNzaW5nIG9mIHJlc3BvbnNlcywgaXQgaXMgZGVzaXJhYmxlIHRvIGJlCiAgICAgKiBhYmxlIHRvIGludGVyY2VwdCByZXF1ZXN0cyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIHRvIHRoZSBzZXJ2ZXIgYW5kCiAgICAgKiByZXNwb25zZXMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCBvdmVyIHRvIHRoZSBhcHBsaWNhdGlvbiBjb2RlIHRoYXQKICAgICAqIGluaXRpYXRlZCB0aGVzZSByZXF1ZXN0cy4gVGhlIGludGVyY2VwdG9ycyBsZXZlcmFnZSB0aGUge0BsaW5rIG5nLiRxCiAgICAgKiBwcm9taXNlIEFQSXN9IHRvIGZ1bGZpbGwgdGhpcyBuZWVkIGZvciBib3RoIHN5bmNocm9ub3VzIGFuZCBhc3luY2hyb25vdXMgcHJlLXByb2Nlc3NpbmcuCiAgICAgKgogICAgICogVGhlIGludGVyY2VwdG9ycyBhcmUgc2VydmljZSBmYWN0b3JpZXMgdGhhdCBhcmUgcmVnaXN0ZXJlZCB3aXRoIHRoZSBgJGh0dHBQcm92aWRlcmAgYnkKICAgICAqIGFkZGluZyB0aGVtIHRvIHRoZSBgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnNgIGFycmF5LiBUaGUgZmFjdG9yeSBpcyBjYWxsZWQgYW5kCiAgICAgKiBpbmplY3RlZCB3aXRoIGRlcGVuZGVuY2llcyAoaWYgc3BlY2lmaWVkKSBhbmQgcmV0dXJucyB0aGUgaW50ZXJjZXB0b3IuCiAgICAgKgogICAgICogVGhlcmUgYXJlIHR3byBraW5kcyBvZiBpbnRlcmNlcHRvcnMgKGFuZCB0d28ga2luZHMgb2YgcmVqZWN0aW9uIGludGVyY2VwdG9ycyk6CiAgICAgKgogICAgICogICAqIGByZXF1ZXN0YDogaW50ZXJjZXB0b3JzIGdldCBjYWxsZWQgd2l0aCBhIGh0dHAgYGNvbmZpZ2Agb2JqZWN0LiBUaGUgZnVuY3Rpb24gaXMgZnJlZSB0bwogICAgICogICAgIG1vZGlmeSB0aGUgYGNvbmZpZ2Agb2JqZWN0IG9yIGNyZWF0ZSBhIG5ldyBvbmUuIFRoZSBmdW5jdGlvbiBuZWVkcyB0byByZXR1cm4gdGhlIGBjb25maWdgCiAgICAgKiAgICAgb2JqZWN0IGRpcmVjdGx5LCBvciBhIHByb21pc2UgY29udGFpbmluZyB0aGUgYGNvbmZpZ2Agb3IgYSBuZXcgYGNvbmZpZ2Agb2JqZWN0LgogICAgICogICAqIGByZXF1ZXN0RXJyb3JgOiBpbnRlcmNlcHRvciBnZXRzIGNhbGxlZCB3aGVuIGEgcHJldmlvdXMgaW50ZXJjZXB0b3IgdGhyZXcgYW4gZXJyb3Igb3IKICAgICAqICAgICByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICogICAqIGByZXNwb25zZWA6IGludGVyY2VwdG9ycyBnZXQgY2FsbGVkIHdpdGggaHR0cCBgcmVzcG9uc2VgIG9iamVjdC4gVGhlIGZ1bmN0aW9uIGlzIGZyZWUgdG8KICAgICAqICAgICBtb2RpZnkgdGhlIGByZXNwb25zZWAgb2JqZWN0IG9yIGNyZWF0ZSBhIG5ldyBvbmUuIFRoZSBmdW5jdGlvbiBuZWVkcyB0byByZXR1cm4gdGhlIGByZXNwb25zZWAKICAgICAqICAgICBvYmplY3QgZGlyZWN0bHksIG9yIGFzIGEgcHJvbWlzZSBjb250YWluaW5nIHRoZSBgcmVzcG9uc2VgIG9yIGEgbmV3IGByZXNwb25zZWAgb2JqZWN0LgogICAgICogICAqIGByZXNwb25zZUVycm9yYDogaW50ZXJjZXB0b3IgZ2V0cyBjYWxsZWQgd2hlbiBhIHByZXZpb3VzIGludGVyY2VwdG9yIHRocmV3IGFuIGVycm9yIG9yCiAgICAgKiAgICAgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbi4KICAgICAqCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIGFzIGEgc2VydmljZQogICAgICogICAkcHJvdmlkZS5mYWN0b3J5KCdteUh0dHBJbnRlcmNlcHRvcicsIGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gewogICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgKiAgICAgICAncmVxdWVzdCc6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICogICAgICAgICByZXR1cm4gY29uZmlnOwogICAgICogICAgICAgfSwKICAgICAqCiAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAqICAgICAgJ3JlcXVlc3RFcnJvcic6IGZ1bmN0aW9uKHJlamVjdGlvbikgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVqZWN0aW9uKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVqZWN0aW9uKTsKICAgICAqICAgICAgIH0sCiAgICAgKgogICAgICoKICAgICAqCiAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAqICAgICAgICdyZXNwb25zZSc6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgKiAgICAgICAgIHJldHVybiByZXNwb25zZTsKICAgICAqICAgICAgIH0sCiAgICAgKgogICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgKiAgICAgICdyZXNwb25zZUVycm9yJzogZnVuY3Rpb24ocmVqZWN0aW9uKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBlcnJvcgogICAgICogICAgICAgICBpZiAoY2FuUmVjb3ZlcihyZWplY3Rpb24pKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZWplY3Rpb24pOwogICAgICogICAgICAgfQogICAgICogICAgIH07CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAqCiAgICAgKgogICAgICogICAvLyBhbHRlcm5hdGl2ZWx5LCByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgKiAgICRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzLnB1c2goZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICogICAgIHJldHVybiB7CiAgICAgKiAgICAgICdyZXF1ZXN0JzogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgKiAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlCiAgICAgKiAgICAgICB9LAogICAgICoKICAgICAqICAgICAgICdyZXNwb25zZSc6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgKiAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlCiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfTsKICAgICAqICAgfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiAjIFJlc3BvbnNlIGludGVyY2VwdG9ycyAoREVQUkVDQVRFRCkKICAgICAqCiAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICoge0BsaW5rIG5nLiRxICRxIGFuZCBkZWZlcnJlZC9wcm9taXNlIEFQSXN9LgogICAgICoKICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uIG9yIGFueSBraW5kIG9mIHN5bmNocm9ub3VzIG9yCiAgICAgKiBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZyBvZiByZWNlaXZlZCByZXNwb25zZXMsIGl0IGlzIGRlc2lyYWJsZSB0byBiZSBhYmxlIHRvIGludGVyY2VwdAogICAgICogcmVzcG9uc2VzIGZvciBodHRwIHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgb3ZlciB0byB0aGUgYXBwbGljYXRpb24gY29kZSB0aGF0CiAgICAgKiBpbml0aWF0ZWQgdGhlc2UgcmVxdWVzdHMuIFRoZSByZXNwb25zZSBpbnRlcmNlcHRvcnMgbGV2ZXJhZ2UgdGhlIHtAbGluayBuZy4kcQogICAgICogcHJvbWlzZSBhcGlzfSB0byBmdWxmaWwgdGhpcyBuZWVkIGZvciBib3RoIHN5bmNocm9ub3VzIGFuZCBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZy4KICAgICAqCiAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlICRodHRwUHJvdmlkZXIgYnkKICAgICAqIGFkZGluZyB0aGVtIHRvIHRoZSBgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9yc2AgYXJyYXkuIFRoZSBmYWN0b3J5IGlzIGNhbGxlZCBhbmQKICAgICAqIGluamVjdGVkIHdpdGggZGVwZW5kZW5jaWVzIChpZiBzcGVjaWZpZWQpIGFuZCByZXR1cm5zIHRoZSBpbnRlcmNlcHRvciAg4oCUIGEgZnVuY3Rpb24gdGhhdAogICAgICogdGFrZXMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gYW5kIHJldHVybnMgdGhlIG9yaWdpbmFsIG9yIGEgbmV3IHByb21pc2UuCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIGFzIGEgc2VydmljZQogICAgICogICAkcHJvdmlkZS5mYWN0b3J5KCdteUh0dHBJbnRlcmNlcHRvcicsIGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICogICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICogICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgKiAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVzcG9uc2UpKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZXNwb25zZSk7CiAgICAgKiAgICAgICB9KTsKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKCdteUh0dHBJbnRlcmNlcHRvcicpOwogICAgICoKICAgICAqCiAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciB2aWEgYW4gYW5vbnltb3VzIGZhY3RvcnkKICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICogICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKgogICAgICogIyBTZWN1cml0eSBDb25zaWRlcmF0aW9ucwogICAgICoKICAgICAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMsIGNvbnNpZGVyIHNlY3VyaXR5IHRocmVhdHMgZnJvbToKICAgICAqCiAgICAgKiAtIFtKU09OIHZ1bG5lcmFiaWxpdHldKGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweCkKICAgICAqIC0gW1hTUkZdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkpCiAgICAgKgogICAgICogQm90aCBzZXJ2ZXIgYW5kIHRoZSBjbGllbnQgbXVzdCBjb29wZXJhdGUgaW4gb3JkZXIgdG8gZWxpbWluYXRlIHRoZXNlIHRocmVhdHMuIEFuZ3VsYXIgY29tZXMKICAgICAqIHByZS1jb25maWd1cmVkIHdpdGggc3RyYXRlZ2llcyB0aGF0IGFkZHJlc3MgdGhlc2UgaXNzdWVzLCBidXQgZm9yIHRoaXMgdG8gd29yayBiYWNrZW5kIHNlcnZlcgogICAgICogY29vcGVyYXRpb24gaXMgcmVxdWlyZWQuCiAgICAgKgogICAgICogIyMgSlNPTiBWdWxuZXJhYmlsaXR5IFByb3RlY3Rpb24KICAgICAqCiAgICAgKiBBIFtKU09OIHZ1bG5lcmFiaWxpdHldKGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweCkKICAgICAqIGFsbG93cyB0aGlyZCBwYXJ0eSB3ZWJzaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAgICAgKiBbSlNPTlBdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlApIHJlcXVlc3QgdW5kZXIgc29tZSBjb25kaXRpb25zLiBUbwogICAgICogY291bnRlciB0aGlzIHlvdXIgc2VydmVyIGNhbiBwcmVmaXggYWxsIEpTT04gcmVxdWVzdHMgd2l0aCBmb2xsb3dpbmcgc3RyaW5nIGAiKV19JyxcbiJgLgogICAgICogQW5ndWxhciB3aWxsIGF1dG9tYXRpY2FsbHkgc3RyaXAgdGhlIHByZWZpeCBiZWZvcmUgcHJvY2Vzc2luZyBpdCBhcyBKU09OLgogICAgICoKICAgICAqIEZvciBleGFtcGxlIGlmIHlvdXIgc2VydmVyIG5lZWRzIHRvIHJldHVybjoKICAgICAqIGBgYGpzCiAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgKiBgYGAKICAgICAqCiAgICAgKiB3aGljaCBpcyB2dWxuZXJhYmxlIHRvIGF0dGFjaywgeW91ciBzZXJ2ZXIgY2FuIHJldHVybjoKICAgICAqIGBgYGpzCiAgICAgKiApXX0nLAogICAgICogWydvbmUnLCd0d28nXQogICAgICogYGBgCiAgICAgKgogICAgICogQW5ndWxhciB3aWxsIHN0cmlwIHRoZSBwcmVmaXgsIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSBKU09OLgogICAgICoKICAgICAqCiAgICAgKiAjIyBDcm9zcyBTaXRlIFJlcXVlc3QgRm9yZ2VyeSAoWFNSRikgUHJvdGVjdGlvbgogICAgICoKICAgICAqIFtYU1JGXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Nyb3NzLXNpdGVfcmVxdWVzdF9mb3JnZXJ5KSBpcyBhIHRlY2huaXF1ZSBieSB3aGljaAogICAgICogYW4gdW5hdXRob3JpemVkIHNpdGUgY2FuIGdhaW4geW91ciB1c2VyJ3MgcHJpdmF0ZSBkYXRhLiBBbmd1bGFyIHByb3ZpZGVzIGEgbWVjaGFuaXNtCiAgICAgKiB0byBjb3VudGVyIFhTUkYuIFdoZW4gcGVyZm9ybWluZyBYSFIgcmVxdWVzdHMsIHRoZSAkaHR0cCBzZXJ2aWNlIHJlYWRzIGEgdG9rZW4gZnJvbSBhIGNvb2tpZQogICAgICogKGJ5IGRlZmF1bHQsIGBYU1JGLVRPS0VOYCkgYW5kIHNldHMgaXQgYXMgYW4gSFRUUCBoZWFkZXIgKGBYLVhTUkYtVE9LRU5gKS4gU2luY2Ugb25seQogICAgICogSmF2YVNjcmlwdCB0aGF0IHJ1bnMgb24geW91ciBkb21haW4gY291bGQgcmVhZCB0aGUgY29va2llLCB5b3VyIHNlcnZlciBjYW4gYmUgYXNzdXJlZCB0aGF0CiAgICAgKiB0aGUgWEhSIGNhbWUgZnJvbSBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4uIFRoZSBoZWFkZXIgd2lsbCBub3QgYmUgc2V0IGZvcgogICAgICogY3Jvc3MtZG9tYWluIHJlcXVlc3RzLgogICAgICoKICAgICAqIFRvIHRha2UgYWR2YW50YWdlIG9mIHRoaXMsIHlvdXIgc2VydmVyIG5lZWRzIHRvIHNldCBhIHRva2VuIGluIGEgSmF2YVNjcmlwdCByZWFkYWJsZSBzZXNzaW9uCiAgICAgKiBjb29raWUgY2FsbGVkIGBYU1JGLVRPS0VOYCBvbiB0aGUgZmlyc3QgSFRUUCBHRVQgcmVxdWVzdC4gT24gc3Vic2VxdWVudCBYSFIgcmVxdWVzdHMgdGhlCiAgICAgKiBzZXJ2ZXIgY2FuIHZlcmlmeSB0aGF0IHRoZSBjb29raWUgbWF0Y2hlcyBgWC1YU1JGLVRPS0VOYCBIVFRQIGhlYWRlciwgYW5kIHRoZXJlZm9yZSBiZSBzdXJlCiAgICAgKiB0aGF0IG9ubHkgSmF2YVNjcmlwdCBydW5uaW5nIG9uIHlvdXIgZG9tYWluIGNvdWxkIGhhdmUgc2VudCB0aGUgcmVxdWVzdC4gVGhlIHRva2VuIG11c3QgYmUKICAgICAqIHVuaXF1ZSBmb3IgZWFjaCB1c2VyIGFuZCBtdXN0IGJlIHZlcmlmaWFibGUgYnkgdGhlIHNlcnZlciAodG8gcHJldmVudCB0aGUgSmF2YVNjcmlwdCBmcm9tCiAgICAgKiBtYWtpbmcgdXAgaXRzIG93biB0b2tlbnMpLiBXZSByZWNvbW1lbmQgdGhhdCB0aGUgdG9rZW4gaXMgYSBkaWdlc3Qgb2YgeW91ciBzaXRlJ3MKICAgICAqIGF1dGhlbnRpY2F0aW9uIGNvb2tpZSB3aXRoIGEgW3NhbHRdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1NhbHRfKGNyeXB0b2dyYXBoeSkpCiAgICAgKiBmb3IgYWRkZWQgc2VjdXJpdHkuCiAgICAgKgogICAgICogVGhlIG5hbWUgb2YgdGhlIGhlYWRlcnMgY2FuIGJlIHNwZWNpZmllZCB1c2luZyB0aGUgeHNyZkhlYWRlck5hbWUgYW5kIHhzcmZDb29raWVOYW1lCiAgICAgKiBwcm9wZXJ0aWVzIG9mIGVpdGhlciAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzIGF0IGNvbmZpZy10aW1lLCAkaHR0cC5kZWZhdWx0cyBhdCBydW4tdGltZSwKICAgICAqIG9yIHRoZSBwZXItcmVxdWVzdCBjb25maWcgb2JqZWN0LgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29uZmlnIE9iamVjdCBkZXNjcmliaW5nIHRoZSByZXF1ZXN0IHRvIGJlIG1hZGUgYW5kIGhvdyBpdCBzaG91bGQgYmUKICAgICAqICAgIHByb2Nlc3NlZC4gVGhlIG9iamVjdCBoYXMgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKgogICAgICogICAgLSAqKm1ldGhvZCoqIOKAkyBge3N0cmluZ31gIOKAkyBIVFRQIG1ldGhvZCAoZS5nLiAnR0VUJywgJ1BPU1QnLCBldGMpCiAgICAgKiAgICAtICoqdXJsKiog4oCTIGB7c3RyaW5nfWAg4oCTIEFic29sdXRlIG9yIHJlbGF0aXZlIFVSTCBvZiB0aGUgcmVzb3VyY2UgdGhhdCBpcyBiZWluZyByZXF1ZXN0ZWQuCiAgICAgKiAgICAtICoqcGFyYW1zKiog4oCTIGB7T2JqZWN0LjxzdHJpbmd8T2JqZWN0Pn1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBvYmplY3RzIHdoaWNoIHdpbGwgYmUgdHVybmVkCiAgICAgKiAgICAgIHRvIGA/a2V5MT12YWx1ZTEma2V5Mj12YWx1ZTJgIGFmdGVyIHRoZSB1cmwuIElmIHRoZSB2YWx1ZSBpcyBub3QgYSBzdHJpbmcsIGl0IHdpbGwgYmUKICAgICAqICAgICAgSlNPTmlmaWVkLgogICAgICogICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIERhdGEgdG8gYmUgc2VudCBhcyB0aGUgcmVxdWVzdCBtZXNzYWdlIGRhdGEuCiAgICAgKiAgICAtICoqaGVhZGVycyoqIOKAkyBge09iamVjdH1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBmdW5jdGlvbnMgd2hpY2ggcmV0dXJuIHN0cmluZ3MgcmVwcmVzZW50aW5nCiAgICAgKiAgICAgIEhUVFAgaGVhZGVycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuIElmIHRoZSByZXR1cm4gdmFsdWUgb2YgYSBmdW5jdGlvbiBpcyBudWxsLCB0aGUKICAgICAqICAgICAgaGVhZGVyIHdpbGwgbm90IGJlIHNlbnQuCiAgICAgKiAgICAtICoqeHNyZkhlYWRlck5hbWUqKiDigJMgYHtzdHJpbmd9YCDigJMgTmFtZSBvZiBIVFRQIGhlYWRlciB0byBwb3B1bGF0ZSB3aXRoIHRoZSBYU1JGIHRva2VuLgogICAgICogICAgLSAqKnhzcmZDb29raWVOYW1lKiog4oCTIGB7c3RyaW5nfWAg4oCTIE5hbWUgb2YgY29va2llIGNvbnRhaW5pbmcgdGhlIFhTUkYgdG9rZW4uCiAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVxdWVzdCoqIOKAkwogICAgICogICAgICBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgKiAgICAgIHJlcXVlc3QgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICogICAgLSAqKnRyYW5zZm9ybVJlc3BvbnNlKiog4oCTCiAgICAgKiAgICAgIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAqICAgICAgcmVzcG9uc2UgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBkZXNlcmlhbGl6ZWQpIHZlcnNpb24uCiAgICAgKiAgICAtICoqY2FjaGUqKiDigJMgYHtib29sZWFufENhY2hlfWAg4oCTIElmIHRydWUsIGEgZGVmYXVsdCAkaHR0cCBjYWNoZSB3aWxsIGJlIHVzZWQgdG8gY2FjaGUgdGhlCiAgICAgKiAgICAgIEdFVCByZXF1ZXN0LCBvdGhlcndpc2UgaWYgYSBjYWNoZSBpbnN0YW5jZSBidWlsdCB3aXRoCiAgICAgKiAgICAgIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LCB0aGlzIGNhY2hlIHdpbGwgYmUgdXNlZCBmb3IKICAgICAqICAgICAgY2FjaGluZy4KICAgICAqICAgIC0gKip0aW1lb3V0Kiog4oCTIGB7bnVtYmVyfFByb21pc2V9YCDigJMgdGltZW91dCBpbiBtaWxsaXNlY29uZHMsIG9yIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICogICAgICB0aGF0IHNob3VsZCBhYm9ydCB0aGUgcmVxdWVzdCB3aGVuIHJlc29sdmVkLgogICAgICogICAgLSAqKndpdGhDcmVkZW50aWFscyoqIC0gYHtib29sZWFufWAgLSB3aGV0aGVyIHRvIHNldCB0aGUgYHdpdGhDcmVkZW50aWFsc2AgZmxhZyBvbiB0aGUKICAgICAqICAgICAgWEhSIG9iamVjdC4gU2VlIFtyZXF1ZXN0cyB3aXRoIGNyZWRlbnRpYWxzXWh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL2h0dHBfYWNjZXNzX2NvbnRyb2wjc2VjdGlvbl81CiAgICAgKiAgICAgIGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogICAgLSAqKnJlc3BvbnNlVHlwZSoqIC0gYHtzdHJpbmd9YCAtIHNlZQogICAgICogICAgICBbcmVxdWVzdFR5cGVdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL1hNTEh0dHBSZXF1ZXN0I3Jlc3BvbnNlVHlwZSkuCiAgICAgKgogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBSZXR1cm5zIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IG9iamVjdCB3aXRoIHRoZQogICAgICogICBzdGFuZGFyZCBgdGhlbmAgbWV0aG9kIGFuZCB0d28gaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuIFRoZSBgdGhlbmAKICAgICAqICAgbWV0aG9kIHRha2VzIHR3byBhcmd1bWVudHMgYSBzdWNjZXNzIGFuZCBhbiBlcnJvciBjYWxsYmFjayB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aXRoIGEKICAgICAqICAgcmVzcG9uc2Ugb2JqZWN0LiBUaGUgYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgIG1ldGhvZHMgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCAtIGEgZnVuY3Rpb24gdGhhdAogICAgICogICB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IHN1Y2NlZWRzIG9yIGZhaWxzIHJlc3BlY3RpdmVseS4gVGhlIGFyZ3VtZW50cyBwYXNzZWQgaW50bwogICAgICogICB0aGVzZSBmdW5jdGlvbnMgYXJlIGRlc3RydWN0dXJlZCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVzcG9uc2Ugb2JqZWN0IHBhc3NlZCBpbnRvIHRoZQogICAgICogICBgdGhlbmAgbWV0aG9kLiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGVzZSBwcm9wZXJ0aWVzOgogICAgICoKICAgICAqICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIFRoZSByZXNwb25zZSBib2R5IHRyYW5zZm9ybWVkIHdpdGggdGhlIHRyYW5zZm9ybQogICAgICogICAgIGZ1bmN0aW9ucy4KICAgICAqICAgLSAqKnN0YXR1cyoqIOKAkyBge251bWJlcn1gIOKAkyBIVFRQIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZS4KICAgICAqICAgLSAqKmhlYWRlcnMqKiDigJMgYHtmdW5jdGlvbihbaGVhZGVyTmFtZV0pfWAg4oCTIEhlYWRlciBnZXR0ZXIgZnVuY3Rpb24uCiAgICAgKiAgIC0gKipjb25maWcqKiDigJMgYHtPYmplY3R9YCDigJMgVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHRoYXQgd2FzIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIHJlcXVlc3QuCiAgICAgKiAgIC0gKipzdGF0dXNUZXh0Kiog4oCTIGB7c3RyaW5nfWAg4oCTIEhUVFAgc3RhdHVzIHRleHQgb2YgdGhlIHJlc3BvbnNlLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPE9iamVjdD59IHBlbmRpbmdSZXF1ZXN0cyBBcnJheSBvZiBjb25maWcgb2JqZWN0cyBmb3IgY3VycmVudGx5IHBlbmRpbmcKICAgICAqICAgcmVxdWVzdHMuIFRoaXMgaXMgcHJpbWFyaWx5IG1lYW50IHRvIGJlIHVzZWQgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGUKPGV4YW1wbGU+CjxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogIDxkaXYgbmctY29udHJvbGxlcj0iRmV0Y2hDdHJsIj4KICAgIDxzZWxlY3QgbmctbW9kZWw9Im1ldGhvZCI+CiAgICAgIDxvcHRpb24+R0VUPC9vcHRpb24+CiAgICAgIDxvcHRpb24+SlNPTlA8L29wdGlvbj4KICAgIDwvc2VsZWN0PgogICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJ1cmwiIHNpemU9IjgwIi8+CiAgICA8YnV0dG9uIGlkPSJmZXRjaGJ0biIgbmctY2xpY2s9ImZldGNoKCkiPmZldGNoPC9idXR0b24+PGJyPgogICAgPGJ1dHRvbiBpZD0ic2FtcGxlZ2V0YnRuIiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0dFVCcsICdodHRwLWhlbGxvLmh0bWwnKSI+U2FtcGxlIEdFVDwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0ic2FtcGxlanNvbnBidG4iCiAgICAgIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLAogICAgICAgICAgICAgICAgICAgICdodHRwczovL2FuZ3VsYXJqcy5vcmcvZ3JlZXQucGhwP2NhbGxiYWNrPUpTT05fQ0FMTEJBQ0smbmFtZT1TdXBlciUyMEhlcm8nKSI+CiAgICAgIFNhbXBsZSBKU09OUAogICAgPC9idXR0b24+CiAgICA8YnV0dG9uIGlkPSJpbnZhbGlkanNvbnBidG4iCiAgICAgIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLCAnaHR0cHM6Ly9hbmd1bGFyanMub3JnL2RvZXNudGV4aXN0JmNhbGxiYWNrPUpTT05fQ0FMTEJBQ0snKSI+CiAgICAgICAgSW52YWxpZCBKU09OUAogICAgICA8L2J1dHRvbj4KICAgIDxwcmU+aHR0cCBzdGF0dXMgY29kZToge3tzdGF0dXN9fTwvcHJlPgogICAgPHByZT5odHRwIHJlc3BvbnNlIGRhdGE6IHt7ZGF0YX19PC9wcmU+CiAgPC9kaXY+CjwvZmlsZT4KPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICBmdW5jdGlvbiBGZXRjaEN0cmwoJHNjb3BlLCAkaHR0cCwgJHRlbXBsYXRlQ2FjaGUpIHsKICAgICRzY29wZS5tZXRob2QgPSAnR0VUJzsKICAgICRzY29wZS51cmwgPSAnaHR0cC1oZWxsby5odG1sJzsKCiAgICAkc2NvcGUuZmV0Y2ggPSBmdW5jdGlvbigpIHsKICAgICAgJHNjb3BlLmNvZGUgPSBudWxsOwogICAgICAkc2NvcGUucmVzcG9uc2UgPSBudWxsOwoKICAgICAgJGh0dHAoe21ldGhvZDogJHNjb3BlLm1ldGhvZCwgdXJsOiAkc2NvcGUudXJsLCBjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS4KICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cykgewogICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgICRzY29wZS5kYXRhID0gZGF0YTsKICAgICAgICB9KS4KICAgICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICRzY29wZS5kYXRhID0gZGF0YSB8fCAiUmVxdWVzdCBmYWlsZWQiOwogICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgfSk7CiAgICB9OwoKICAgICRzY29wZS51cGRhdGVNb2RlbCA9IGZ1bmN0aW9uKG1ldGhvZCwgdXJsKSB7CiAgICAgICRzY29wZS5tZXRob2QgPSBtZXRob2Q7CiAgICAgICRzY29wZS51cmwgPSB1cmw7CiAgICB9OwogIH0KPC9maWxlPgo8ZmlsZSBuYW1lPSJodHRwLWhlbGxvLmh0bWwiPgogIEhlbGxvLCAkaHR0cCEKPC9maWxlPgo8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICB2YXIgc3RhdHVzID0gZWxlbWVudChieS5iaW5kaW5nKCdzdGF0dXMnKSk7CiAgdmFyIGRhdGEgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2RhdGEnKSk7CiAgdmFyIGZldGNoQnRuID0gZWxlbWVudChieS5pZCgnZmV0Y2hidG4nKSk7CiAgdmFyIHNhbXBsZUdldEJ0biA9IGVsZW1lbnQoYnkuaWQoJ3NhbXBsZWdldGJ0bicpKTsKICB2YXIgc2FtcGxlSnNvbnBCdG4gPSBlbGVtZW50KGJ5LmlkKCdzYW1wbGVqc29ucGJ0bicpKTsKICB2YXIgaW52YWxpZEpzb25wQnRuID0gZWxlbWVudChieS5pZCgnaW52YWxpZGpzb25wYnRuJykpOwoKICBpdCgnc2hvdWxkIG1ha2UgYW4geGhyIEdFVCByZXF1ZXN0JywgZnVuY3Rpb24oKSB7CiAgICBzYW1wbGVHZXRCdG4uY2xpY2soKTsKICAgIGZldGNoQnRuLmNsaWNrKCk7CiAgICBleHBlY3Qoc3RhdHVzLmdldFRleHQoKSkudG9NYXRjaCgnMjAwJyk7CiAgICBleHBlY3QoZGF0YS5nZXRUZXh0KCkpLnRvTWF0Y2goL0hlbGxvLCBcJGh0dHAhLyk7CiAgfSk7CgogIGl0KCdzaG91bGQgbWFrZSBhIEpTT05QIHJlcXVlc3QgdG8gYW5ndWxhcmpzLm9yZycsIGZ1bmN0aW9uKCkgewogICAgc2FtcGxlSnNvbnBCdG4uY2xpY2soKTsKICAgIGZldGNoQnRuLmNsaWNrKCk7CiAgICBleHBlY3Qoc3RhdHVzLmdldFRleHQoKSkudG9NYXRjaCgnMjAwJyk7CiAgICBleHBlY3QoZGF0YS5nZXRUZXh0KCkpLnRvTWF0Y2goL1N1cGVyIEhlcm8hLyk7CiAgfSk7CgogIGl0KCdzaG91bGQgbWFrZSBKU09OUCByZXF1ZXN0IHRvIGludmFsaWQgVVJMIGFuZCBpbnZva2UgdGhlIGVycm9yIGhhbmRsZXInLAogICAgICBmdW5jdGlvbigpIHsKICAgIGludmFsaWRKc29ucEJ0bi5jbGljaygpOwogICAgZmV0Y2hCdG4uY2xpY2soKTsKICAgIGV4cGVjdChzdGF0dXMuZ2V0VGV4dCgpKS50b01hdGNoKCcwJyk7CiAgICBleHBlY3QoZGF0YS5nZXRUZXh0KCkpLnRvTWF0Y2goJ1JlcXVlc3QgZmFpbGVkJyk7CiAgfSk7CjwvZmlsZT4KPC9leGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiAkaHR0cChyZXF1ZXN0Q29uZmlnKSB7CiAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgbWV0aG9kOiAnZ2V0JywKICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBkZWZhdWx0cy50cmFuc2Zvcm1SZXF1ZXN0LAogICAgICAgIHRyYW5zZm9ybVJlc3BvbnNlOiBkZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZQogICAgICB9OwogICAgICB2YXIgaGVhZGVycyA9IG1lcmdlSGVhZGVycyhyZXF1ZXN0Q29uZmlnKTsKCiAgICAgIGV4dGVuZChjb25maWcsIHJlcXVlc3RDb25maWcpOwogICAgICBjb25maWcuaGVhZGVycyA9IGhlYWRlcnM7CiAgICAgIGNvbmZpZy5tZXRob2QgPSB1cHBlcmNhc2UoY29uZmlnLm1ldGhvZCk7CgogICAgICB2YXIgeHNyZlZhbHVlID0gdXJsSXNTYW1lT3JpZ2luKGNvbmZpZy51cmwpCiAgICAgICAgICA/ICRicm93c2VyLmNvb2tpZXMoKVtjb25maWcueHNyZkNvb2tpZU5hbWUgfHwgZGVmYXVsdHMueHNyZkNvb2tpZU5hbWVdCiAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgaWYgKHhzcmZWYWx1ZSkgewogICAgICAgIGhlYWRlcnNbKGNvbmZpZy54c3JmSGVhZGVyTmFtZSB8fCBkZWZhdWx0cy54c3JmSGVhZGVyTmFtZSldID0geHNyZlZhbHVlOwogICAgICB9CgoKICAgICAgdmFyIHNlcnZlclJlcXVlc3QgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICBoZWFkZXJzID0gY29uZmlnLmhlYWRlcnM7CiAgICAgICAgdmFyIHJlcURhdGEgPSB0cmFuc2Zvcm1EYXRhKGNvbmZpZy5kYXRhLCBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpLCBjb25maWcudHJhbnNmb3JtUmVxdWVzdCk7CgogICAgICAgIC8vIHN0cmlwIGNvbnRlbnQtdHlwZSBpZiBkYXRhIGlzIHVuZGVmaW5lZAogICAgICAgIGlmIChpc1VuZGVmaW5lZChjb25maWcuZGF0YSkpIHsKICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGhlYWRlcikgewogICAgICAgICAgICBpZiAobG93ZXJjYXNlKGhlYWRlcikgPT09ICdjb250ZW50LXR5cGUnKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1VuZGVmaW5lZChjb25maWcud2l0aENyZWRlbnRpYWxzKSAmJiAhaXNVbmRlZmluZWQoZGVmYXVsdHMud2l0aENyZWRlbnRpYWxzKSkgewogICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscyA9IGRlZmF1bHRzLndpdGhDcmVkZW50aWFsczsKICAgICAgICB9CgogICAgICAgIC8vIHNlbmQgcmVxdWVzdAogICAgICAgIHJldHVybiBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgaGVhZGVycykudGhlbih0cmFuc2Zvcm1SZXNwb25zZSwgdHJhbnNmb3JtUmVzcG9uc2UpOwogICAgICB9OwoKICAgICAgdmFyIGNoYWluID0gW3NlcnZlclJlcXVlc3QsIHVuZGVmaW5lZF07CiAgICAgIHZhciBwcm9taXNlID0gJHEud2hlbihjb25maWcpOwoKICAgICAgLy8gYXBwbHkgaW50ZXJjZXB0b3JzCiAgICAgIGZvckVhY2gocmV2ZXJzZWRJbnRlcmNlcHRvcnMsIGZ1bmN0aW9uKGludGVyY2VwdG9yKSB7CiAgICAgICAgaWYgKGludGVyY2VwdG9yLnJlcXVlc3QgfHwgaW50ZXJjZXB0b3IucmVxdWVzdEVycm9yKSB7CiAgICAgICAgICBjaGFpbi51bnNoaWZ0KGludGVyY2VwdG9yLnJlcXVlc3QsIGludGVyY2VwdG9yLnJlcXVlc3RFcnJvcik7CiAgICAgICAgfQogICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXNwb25zZSB8fCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKSB7CiAgICAgICAgICBjaGFpbi5wdXNoKGludGVyY2VwdG9yLnJlc3BvbnNlLCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgd2hpbGUoY2hhaW4ubGVuZ3RoKSB7CiAgICAgICAgdmFyIHRoZW5GbiA9IGNoYWluLnNoaWZ0KCk7CiAgICAgICAgdmFyIHJlamVjdEZuID0gY2hhaW4uc2hpZnQoKTsKCiAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbih0aGVuRm4sIHJlamVjdEZuKTsKICAgICAgfQoKICAgICAgcHJvbWlzZS5zdWNjZXNzID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgfTsKCiAgICAgIHByb21pc2UuZXJyb3IgPSBmdW5jdGlvbihmbikgewogICAgICAgIHByb21pc2UudGhlbihudWxsLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgZm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICB9OwoKICAgICAgcmV0dXJuIHByb21pc2U7CgogICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1SZXNwb25zZShyZXNwb25zZSkgewogICAgICAgIC8vIG1ha2UgYSBjb3B5IHNpbmNlIHRoZSByZXNwb25zZSBtdXN0IGJlIGNhY2hlYWJsZQogICAgICAgIHZhciByZXNwID0gZXh0ZW5kKHt9LCByZXNwb25zZSwgewogICAgICAgICAgZGF0YTogdHJhbnNmb3JtRGF0YShyZXNwb25zZS5kYXRhLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcudHJhbnNmb3JtUmVzcG9uc2UpCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIChpc1N1Y2Nlc3MocmVzcG9uc2Uuc3RhdHVzKSkKICAgICAgICAgID8gcmVzcAogICAgICAgICAgOiAkcS5yZWplY3QocmVzcCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG1lcmdlSGVhZGVycyhjb25maWcpIHsKICAgICAgICB2YXIgZGVmSGVhZGVycyA9IGRlZmF1bHRzLmhlYWRlcnMsCiAgICAgICAgICAgIHJlcUhlYWRlcnMgPSBleHRlbmQoe30sIGNvbmZpZy5oZWFkZXJzKSwKICAgICAgICAgICAgZGVmSGVhZGVyTmFtZSwgbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSwgcmVxSGVhZGVyTmFtZTsKCiAgICAgICAgZGVmSGVhZGVycyA9IGV4dGVuZCh7fSwgZGVmSGVhZGVycy5jb21tb24sIGRlZkhlYWRlcnNbbG93ZXJjYXNlKGNvbmZpZy5tZXRob2QpXSk7CgogICAgICAgIC8vIGV4ZWN1dGUgaWYgaGVhZGVyIHZhbHVlIGlzIGZ1bmN0aW9uCiAgICAgICAgZXhlY0hlYWRlcnMoZGVmSGVhZGVycyk7CiAgICAgICAgZXhlY0hlYWRlcnMocmVxSGVhZGVycyk7CgogICAgICAgIC8vIHVzaW5nIGZvci1pbiBpbnN0ZWFkIG9mIGZvckVhY2ggdG8gYXZvaWQgdW5lY2Vzc2FyeSBpdGVyYXRpb24gYWZ0ZXIgaGVhZGVyIGhhcyBiZWVuIGZvdW5kCiAgICAgICAgZGVmYXVsdEhlYWRlcnNJdGVyYXRpb246CiAgICAgICAgZm9yIChkZWZIZWFkZXJOYW1lIGluIGRlZkhlYWRlcnMpIHsKICAgICAgICAgIGxvd2VyY2FzZURlZkhlYWRlck5hbWUgPSBsb3dlcmNhc2UoZGVmSGVhZGVyTmFtZSk7CgogICAgICAgICAgZm9yIChyZXFIZWFkZXJOYW1lIGluIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShyZXFIZWFkZXJOYW1lKSA9PT0gbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSkgewogICAgICAgICAgICAgIGNvbnRpbnVlIGRlZmF1bHRIZWFkZXJzSXRlcmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmVxSGVhZGVyc1tkZWZIZWFkZXJOYW1lXSA9IGRlZkhlYWRlcnNbZGVmSGVhZGVyTmFtZV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVxSGVhZGVyczsKCiAgICAgICAgZnVuY3Rpb24gZXhlY0hlYWRlcnMoaGVhZGVycykgewogICAgICAgICAgdmFyIGhlYWRlckNvbnRlbnQ7CgogICAgICAgICAgZm9yRWFjaChoZWFkZXJzLCBmdW5jdGlvbihoZWFkZXJGbiwgaGVhZGVyKSB7CiAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGhlYWRlckZuKSkgewogICAgICAgICAgICAgIGhlYWRlckNvbnRlbnQgPSBoZWFkZXJGbigpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJDb250ZW50ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGhlYWRlcnNbaGVhZGVyXSA9IGhlYWRlckNvbnRlbnQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBoZWFkZXJzW2hlYWRlcl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMgPSBbXTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI2dldAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEdFVGAgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaHR0cCNkZWxldGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBERUxFVEVgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGh0dHAjaGVhZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEhFQURgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGh0dHAjanNvbnAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBKU09OUGAgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgU2hvdWxkIGNvbnRhaW4gYEpTT05fQ0FMTEJBQ0tgIHN0cmluZy4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwogICAgY3JlYXRlU2hvcnRNZXRob2RzKCdnZXQnLCAnZGVsZXRlJywgJ2hlYWQnLCAnanNvbnAnKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI3Bvc3QKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQT1NUYCByZXF1ZXN0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgKiBAcGFyYW0geyp9IGRhdGEgUmVxdWVzdCBjb250ZW50CiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI3B1dAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBVVGAgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICovCiAgICBjcmVhdGVTaG9ydE1ldGhvZHNXaXRoRGF0YSgncG9zdCcsICdwdXQnKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICogQG5hbWUgJGh0dHAjZGVmYXVsdHMKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJ1bnRpbWUgZXF1aXZhbGVudCBvZiB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHNgIHByb3BlcnR5LiBBbGxvd3MgY29uZmlndXJhdGlvbiBvZgogICAgICAgICAqIGRlZmF1bHQgaGVhZGVycywgd2l0aENyZWRlbnRpYWxzIGFzIHdlbGwgYXMgcmVxdWVzdCBhbmQgcmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zLgogICAgICAgICAqCiAgICAgICAgICogU2VlICJTZXR0aW5nIEhUVFAgSGVhZGVycyIgYW5kICJUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcyIgc2VjdGlvbnMgYWJvdmUuCiAgICAgICAgICovCiAgICAkaHR0cC5kZWZhdWx0cyA9IGRlZmF1bHRzOwoKCiAgICByZXR1cm4gJGh0dHA7CgoKICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kcyhuYW1lcykgewogICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24odXJsLCBjb25maWcpIHsKICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgdXJsOiB1cmwKICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgICB9KTsKICAgIH0KCgogICAgZnVuY3Rpb24gY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEobmFtZSkgewogICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24odXJsLCBkYXRhLCBjb25maWcpIHsKICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgICB9KTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBNYWtlcyB0aGUgcmVxdWVzdC4KICAgICAqCiAgICAgKiAhISEgQUNDRVNTRVMgQ0xPU1VSRSBWQVJTOgogICAgICogJGh0dHBCYWNrZW5kLCBkZWZhdWx0cywgJGxvZywgJHJvb3RTY29wZSwgZGVmYXVsdENhY2hlLCAkaHR0cC5wZW5kaW5nUmVxdWVzdHMKICAgICAqLwogICAgZnVuY3Rpb24gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpIHsKICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKSwKICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgY2FjaGUsCiAgICAgICAgICBjYWNoZWRSZXNwLAogICAgICAgICAgdXJsID0gYnVpbGRVcmwoY29uZmlnLnVybCwgY29uZmlnLnBhcmFtcyk7CgogICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMucHVzaChjb25maWcpOwogICAgICBwcm9taXNlLnRoZW4ocmVtb3ZlUGVuZGluZ1JlcSwgcmVtb3ZlUGVuZGluZ1JlcSk7CgoKICAgICAgaWYgKChjb25maWcuY2FjaGUgfHwgZGVmYXVsdHMuY2FjaGUpICYmIGNvbmZpZy5jYWNoZSAhPT0gZmFsc2UgJiYgY29uZmlnLm1ldGhvZCA9PSAnR0VUJykgewogICAgICAgIGNhY2hlID0gaXNPYmplY3QoY29uZmlnLmNhY2hlKSA/IGNvbmZpZy5jYWNoZQogICAgICAgICAgICAgIDogaXNPYmplY3QoZGVmYXVsdHMuY2FjaGUpID8gZGVmYXVsdHMuY2FjaGUKICAgICAgICAgICAgICA6IGRlZmF1bHRDYWNoZTsKICAgICAgfQoKICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgY2FjaGVkUmVzcCA9IGNhY2hlLmdldCh1cmwpOwogICAgICAgIGlmIChpc0RlZmluZWQoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgIGlmIChjYWNoZWRSZXNwLnRoZW4pIHsKICAgICAgICAgICAgLy8gY2FjaGVkIHJlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50LCBidXQgdGhlcmUgaXMgbm8gcmVzcG9uc2UgeWV0CiAgICAgICAgICAgIGNhY2hlZFJlc3AudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFJlc3A7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBzZXJ2aW5nIGZyb20gY2FjaGUKICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwWzFdLCBjYWNoZWRSZXNwWzBdLCBzaGFsbG93Q29weShjYWNoZWRSZXNwWzJdKSwgY2FjaGVkUmVzcFszXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcCwgMjAwLCB7fSwgJ09LJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gcHV0IHRoZSBwcm9taXNlIGZvciB0aGUgbm9uLXRyYW5zZm9ybWVkIHJlc3BvbnNlIGludG8gY2FjaGUgYXMgYSBwbGFjZWhvbGRlcgogICAgICAgICAgY2FjaGUucHV0KHVybCwgcHJvbWlzZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBpZiB3ZSB3b24ndCBoYXZlIHRoZSByZXNwb25zZSBpbiBjYWNoZSwgc2VuZCB0aGUgcmVxdWVzdCB0byB0aGUgYmFja2VuZAogICAgICBpZiAoaXNVbmRlZmluZWQoY2FjaGVkUmVzcCkpIHsKICAgICAgICAkaHR0cEJhY2tlbmQoY29uZmlnLm1ldGhvZCwgdXJsLCByZXFEYXRhLCBkb25lLCByZXFIZWFkZXJzLCBjb25maWcudGltZW91dCwKICAgICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscywgY29uZmlnLnJlc3BvbnNlVHlwZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9taXNlOwoKCiAgICAgIC8qKgogICAgICAgKiBDYWxsYmFjayByZWdpc3RlcmVkIHRvICRodHRwQmFja2VuZCgpOgogICAgICAgKiAgLSBjYWNoZXMgdGhlIHJlc3BvbnNlIGlmIGRlc2lyZWQKICAgICAgICogIC0gcmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlCiAgICAgICAqICAtIGNhbGxzICRhcHBseQogICAgICAgKi8KICAgICAgZnVuY3Rpb24gZG9uZShzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KSB7CiAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICBpZiAoaXNTdWNjZXNzKHN0YXR1cykpIHsKICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgW3N0YXR1cywgcmVzcG9uc2UsIHBhcnNlSGVhZGVycyhoZWFkZXJzU3RyaW5nKSwgc3RhdHVzVGV4dF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gcmVtb3ZlIHByb21pc2UgZnJvbSB0aGUgY2FjaGUKICAgICAgICAgICAgY2FjaGUucmVtb3ZlKHVybCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KTsKICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgfQoKCiAgICAgIC8qKgogICAgICAgKiBSZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UuCiAgICAgICAqLwogICAgICBmdW5jdGlvbiByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzLCBzdGF0dXNUZXh0KSB7CiAgICAgICAgLy8gbm9ybWFsaXplIGludGVybmFsIHN0YXR1c2VzIHRvIDAKICAgICAgICBzdGF0dXMgPSBNYXRoLm1heChzdGF0dXMsIDApOwoKICAgICAgICAoaXNTdWNjZXNzKHN0YXR1cykgPyBkZWZlcnJlZC5yZXNvbHZlIDogZGVmZXJyZWQucmVqZWN0KSh7CiAgICAgICAgICBkYXRhOiByZXNwb25zZSwKICAgICAgICAgIHN0YXR1czogc3RhdHVzLAogICAgICAgICAgaGVhZGVyczogaGVhZGVyc0dldHRlcihoZWFkZXJzKSwKICAgICAgICAgIGNvbmZpZzogY29uZmlnLAogICAgICAgICAgc3RhdHVzVGV4dCA6IHN0YXR1c1RleHQKICAgICAgICB9KTsKICAgICAgfQoKCiAgICAgIGZ1bmN0aW9uIHJlbW92ZVBlbmRpbmdSZXEoKSB7CiAgICAgICAgdmFyIGlkeCA9IGluZGV4T2YoJGh0dHAucGVuZGluZ1JlcXVlc3RzLCBjb25maWcpOwogICAgICAgIGlmIChpZHggIT09IC0xKSAkaHR0cC5wZW5kaW5nUmVxdWVzdHMuc3BsaWNlKGlkeCwgMSk7CiAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gYnVpbGRVcmwodXJsLCBwYXJhbXMpIHsKICAgICAgICAgIGlmICghcGFyYW1zKSByZXR1cm4gdXJsOwogICAgICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgICAgICBmb3JFYWNoU29ydGVkKHBhcmFtcywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgaXNVbmRlZmluZWQodmFsdWUpKSByZXR1cm47CiAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHZhbHVlID0gW3ZhbHVlXTsKCiAgICAgICAgICAgIGZvckVhY2godmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICBpZiAoaXNPYmplY3QodikpIHsKICAgICAgICAgICAgICAgIHYgPSB0b0pzb24odik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5KSArICc9JyArCiAgICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVVcmlRdWVyeSh2KSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgICBpZihwYXJ0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHVybCArPSAoKHVybC5pbmRleE9mKCc/JykgPT0gLTEpID8gJz8nIDogJyYnKSArIHBhcnRzLmpvaW4oJyYnKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgfQoKCiAgfV07Cn0KCmZ1bmN0aW9uIGNyZWF0ZVhocihtZXRob2QpIHsKICAgIC8vaWYgSUUgYW5kIHRoZSBtZXRob2QgaXMgbm90IFJGQzI2MTYgY29tcGxpYW50LCBvciBpZiBYTUxIdHRwUmVxdWVzdAogICAgLy9pcyBub3QgYXZhaWxhYmxlLCB0cnkgZ2V0dGluZyBhbiBBY3RpdmVYT2JqZWN0LiBPdGhlcndpc2UsIHVzZSBYTUxIdHRwUmVxdWVzdAogICAgLy9pZiBpdCBpcyBhdmFpbGFibGUKICAgIGlmIChtc2llIDw9IDggJiYgKCFtZXRob2QubWF0Y2goL14oZ2V0fHBvc3R8aGVhZHxwdXR8ZGVsZXRlfG9wdGlvbnMpJC9pKSB8fAogICAgICAhd2luZG93LlhNTEh0dHBSZXF1ZXN0KSkgewogICAgICByZXR1cm4gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MSFRUUCIpOwogICAgfSBlbHNlIGlmICh3aW5kb3cuWE1MSHR0cFJlcXVlc3QpIHsKICAgICAgcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsKICAgIH0KCiAgICB0aHJvdyBtaW5FcnIoJyRodHRwQmFja2VuZCcpKCdub3hocicsICJUaGlzIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBYTUxIdHRwUmVxdWVzdC4iKTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRodHRwQmFja2VuZAogKiBAcmVxdWlyZXMgJHdpbmRvdwogKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBIVFRQIGJhY2tlbmQgdXNlZCBieSB0aGUge0BsaW5rIG5nLiRodHRwIHNlcnZpY2V9IHRoYXQgZGVsZWdhdGVzIHRvCiAqIFhNTEh0dHBSZXF1ZXN0IG9iamVjdCBvciBKU09OUCBhbmQgZGVhbHMgd2l0aCBicm93c2VyIGluY29tcGF0aWJpbGl0aWVzLgogKgogKiBZb3Ugc2hvdWxkIG5ldmVyIG5lZWQgdG8gdXNlIHRoaXMgc2VydmljZSBkaXJlY3RseSwgaW5zdGVhZCB1c2UgdGhlIGhpZ2hlci1sZXZlbCBhYnN0cmFjdGlvbnM6CiAqIHtAbGluayBuZy4kaHR0cCAkaHR0cH0gb3Ige0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlICRyZXNvdXJjZX0uCiAqCiAqIER1cmluZyB0ZXN0aW5nIHRoaXMgaW1wbGVtZW50YXRpb24gaXMgc3dhcHBlZCB3aXRoIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kIG1vY2sKICogJGh0dHBCYWNrZW5kfSB3aGljaCBjYW4gYmUgdHJhaW5lZCB3aXRoIHJlc3BvbnNlcy4KICovCmZ1bmN0aW9uICRIdHRwQmFja2VuZFByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJGJyb3dzZXInLCAnJHdpbmRvdycsICckZG9jdW1lbnQnLCBmdW5jdGlvbigkYnJvd3NlciwgJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICByZXR1cm4gY3JlYXRlSHR0cEJhY2tlbmQoJGJyb3dzZXIsIGNyZWF0ZVhociwgJGJyb3dzZXIuZGVmZXIsICR3aW5kb3cuYW5ndWxhci5jYWxsYmFja3MsICRkb2N1bWVudFswXSk7CiAgfV07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBjcmVhdGVYaHIsICRicm93c2VyRGVmZXIsIGNhbGxiYWNrcywgcmF3RG9jdW1lbnQpIHsKICB2YXIgQUJPUlRFRCA9IC0xOwoKICAvLyBUT0RPKHZvanRhKTogZml4IHRoZSBzaWduYXR1cmUKICByZXR1cm4gZnVuY3Rpb24obWV0aG9kLCB1cmwsIHBvc3QsIGNhbGxiYWNrLCBoZWFkZXJzLCB0aW1lb3V0LCB3aXRoQ3JlZGVudGlhbHMsIHJlc3BvbnNlVHlwZSkgewogICAgdmFyIHN0YXR1czsKICAgICRicm93c2VyLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQoKTsKICAgIHVybCA9IHVybCB8fCAkYnJvd3Nlci51cmwoKTsKCiAgICBpZiAobG93ZXJjYXNlKG1ldGhvZCkgPT0gJ2pzb25wJykgewogICAgICB2YXIgY2FsbGJhY2tJZCA9ICdfJyArIChjYWxsYmFja3MuY291bnRlcisrKS50b1N0cmluZygzNik7CiAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBjYWxsYmFja3NbY2FsbGJhY2tJZF0uZGF0YSA9IGRhdGE7CiAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmNhbGxlZCA9IHRydWU7CiAgICAgIH07CgogICAgICB2YXIganNvbnBEb25lID0ganNvbnBSZXEodXJsLnJlcGxhY2UoJ0pTT05fQ0FMTEJBQ0snLCAnYW5ndWxhci5jYWxsYmFja3MuJyArIGNhbGxiYWNrSWQpLAogICAgICAgICAgY2FsbGJhY2tJZCwgZnVuY3Rpb24oc3RhdHVzLCB0ZXh0KSB7CiAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMsIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhLCAiIiwgdGV4dCk7CiAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdID0gbm9vcDsKICAgICAgfSk7CiAgICB9IGVsc2UgewoKICAgICAgdmFyIHhociA9IGNyZWF0ZVhocihtZXRob2QpOwoKICAgICAgeGhyLm9wZW4obWV0aG9kLCB1cmwsIHRydWUpOwogICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gSW4gSUU2IGFuZCA3LCB0aGlzIG1pZ2h0IGJlIGNhbGxlZCBzeW5jaHJvbm91c2x5IHdoZW4geGhyLnNlbmQgYmVsb3cgaXMgY2FsbGVkIGFuZCB0aGUKICAgICAgLy8gcmVzcG9uc2UgaXMgaW4gdGhlIGNhY2hlLiB0aGUgcHJvbWlzZSBhcGkgd2lsbCBlbnN1cmUgdGhhdCB0byB0aGUgYXBwIGNvZGUgdGhlIGFwaSBpcwogICAgICAvLyBhbHdheXMgYXN5bmMKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIG9ucmVhZHlzdGF0ZWNoYW5nZSBtaWdodCBnZXQgY2FsbGVkIG11bHRpcGxlIHRpbWVzIHdpdGggcmVhZHlTdGF0ZSA9PT0gNCBvbiBtb2JpbGUgd2Via2l0IGNhdXNlZCBieQogICAgICAgIC8vIHhocnMgdGhhdCBhcmUgcmVzb2x2ZWQgd2hpbGUgdGhlIGFwcCBpcyBpbiB0aGUgYmFja2dyb3VuZCAoc2VlICM1NDI2KS4KICAgICAgICAvLyBzaW5jZSBjYWxsaW5nIGNvbXBsZXRlUmVxdWVzdCBzZXRzIHRoZSBgeGhyYCB2YXJpYWJsZSB0byBudWxsLCB3ZSBqdXN0IGNoZWNrIGlmIGl0J3Mgbm90IG51bGwgYmVmb3JlCiAgICAgICAgLy8gY29udGludWluZwogICAgICAgIC8vCiAgICAgICAgLy8gd2UgY2FuJ3Qgc2V0IHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgdG8gdW5kZWZpbmVkIG9yIGRlbGV0ZSBpdCBiZWNhdXNlIHRoYXQgYnJlYWtzIElFOCAobWV0aG9kPVBBVENIKSBhbmQKICAgICAgICAvLyBTYWZhcmkgcmVzcGVjdGl2ZWx5LgogICAgICAgIGlmICh4aHIgJiYgeGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgdmFyIHJlc3BvbnNlSGVhZGVycyA9IG51bGwsCiAgICAgICAgICAgICAgcmVzcG9uc2UgPSBudWxsOwoKICAgICAgICAgIGlmKHN0YXR1cyAhPT0gQUJPUlRFRCkgewogICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAvLyByZXNwb25zZVRleHQgaXMgdGhlIG9sZC1zY2hvb2wgd2F5IG9mIHJldHJpZXZpbmcgcmVzcG9uc2UgKHN1cHBvcnRlZCBieSBJRTggJiA5KQogICAgICAgICAgICAvLyByZXNwb25zZS9yZXNwb25zZVR5cGUgcHJvcGVydGllcyB3ZXJlIGludHJvZHVjZWQgaW4gWEhSIExldmVsMiBzcGVjIChzdXBwb3J0ZWQgYnkgSUUxMCkKICAgICAgICAgICAgcmVzcG9uc2UgPSAoJ3Jlc3BvbnNlJyBpbiB4aHIpID8geGhyLnJlc3BvbnNlIDogeGhyLnJlc3BvbnNlVGV4dDsKICAgICAgICAgIH0KCiAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssCiAgICAgICAgICAgICAgc3RhdHVzIHx8IHhoci5zdGF0dXMsCiAgICAgICAgICAgICAgcmVzcG9uc2UsCiAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzLAogICAgICAgICAgICAgIHhoci5zdGF0dXNUZXh0IHx8ICcnKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAod2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmIChyZXNwb25zZVR5cGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9IHJlc3BvbnNlVHlwZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAvLyBXZWJLaXQgYWRkZWQgc3VwcG9ydCBmb3IgdGhlIGpzb24gcmVzcG9uc2VUeXBlIHZhbHVlIG9uIDA5LzAzLzIwMTMKICAgICAgICAgIC8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD03MzY0OC4gVmVyc2lvbnMgb2YgU2FmYXJpIHByaW9yIHRvIDcgYXJlCiAgICAgICAgICAvLyBrbm93biB0byB0aHJvdyB3aGVuIHNldHRpbmcgdGhlIHZhbHVlICJqc29uIiBhcyB0aGUgcmVzcG9uc2UgdHlwZS4gT3RoZXIgb2xkZXIKICAgICAgICAgIC8vIGJyb3dzZXJzIGltcGxlbWVudGluZyB0aGUgcmVzcG9uc2VUeXBlCiAgICAgICAgICAvLwogICAgICAgICAgLy8gVGhlIGpzb24gcmVzcG9uc2UgdHlwZSBjYW4gYmUgaWdub3JlZCBpZiBub3Qgc3VwcG9ydGVkLCBiZWNhdXNlIEpTT04gcGF5bG9hZHMgYXJlCiAgICAgICAgICAvLyBwYXJzZWQgb24gdGhlIGNsaWVudC1zaWRlIHJlZ2FyZGxlc3MuCiAgICAgICAgICBpZiAocmVzcG9uc2VUeXBlICE9PSAnanNvbicpIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHhoci5zZW5kKHBvc3QgfHwgbnVsbCk7CiAgICB9CgogICAgaWYgKHRpbWVvdXQgPiAwKSB7CiAgICAgIHZhciB0aW1lb3V0SWQgPSAkYnJvd3NlckRlZmVyKHRpbWVvdXRSZXF1ZXN0LCB0aW1lb3V0KTsKICAgIH0gZWxzZSBpZiAodGltZW91dCAmJiB0aW1lb3V0LnRoZW4pIHsKICAgICAgdGltZW91dC50aGVuKHRpbWVvdXRSZXF1ZXN0KTsKICAgIH0KCgogICAgZnVuY3Rpb24gdGltZW91dFJlcXVlc3QoKSB7CiAgICAgIHN0YXR1cyA9IEFCT1JURUQ7CiAgICAgIGpzb25wRG9uZSAmJiBqc29ucERvbmUoKTsKICAgICAgeGhyICYmIHhoci5hYm9ydCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCkgewogICAgICAvLyBjYW5jZWwgdGltZW91dCBhbmQgc3Vic2VxdWVudCB0aW1lb3V0IHByb21pc2UgcmVzb2x1dGlvbgogICAgICB0aW1lb3V0SWQgJiYgJGJyb3dzZXJEZWZlci5jYW5jZWwodGltZW91dElkKTsKICAgICAganNvbnBEb25lID0geGhyID0gbnVsbDsKCiAgICAgIC8vIGZpeCBzdGF0dXMgY29kZSB3aGVuIGl0IGlzIDAgKDAgc3RhdHVzIGlzIHVuZG9jdW1lbnRlZCkuCiAgICAgIC8vIE9jY3VycyB3aGVuIGFjY2Vzc2luZyBmaWxlIHJlc291cmNlcyBvciBvbiBBbmRyb2lkIDQuMSBzdG9jayBicm93c2VyCiAgICAgIC8vIHdoaWxlIHJldHJpZXZpbmcgZmlsZXMgZnJvbSBhcHBsaWNhdGlvbiBjYWNoZS4KICAgICAgaWYgKHN0YXR1cyA9PT0gMCkgewogICAgICAgIHN0YXR1cyA9IHJlc3BvbnNlID8gMjAwIDogdXJsUmVzb2x2ZSh1cmwpLnByb3RvY29sID09ICdmaWxlJyA/IDQwNCA6IDA7CiAgICAgIH0KCiAgICAgIC8vIG5vcm1hbGl6ZSBJRSBidWcgKGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzE0NTApCiAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PT0gMTIyMyA/IDIwNCA6IHN0YXR1czsKICAgICAgc3RhdHVzVGV4dCA9IHN0YXR1c1RleHQgfHwgJyc7CgogICAgICBjYWxsYmFjayhzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KTsKICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiBqc29ucFJlcSh1cmwsIGNhbGxiYWNrSWQsIGRvbmUpIHsKICAgIC8vIHdlIGNhbid0IHVzZSBqUXVlcnkvanFMaXRlIGhlcmUgYmVjYXVzZSBqUXVlcnkgZG9lcyBjcmF6eSBzaGl0IHdpdGggc2NyaXB0IGVsZW1lbnRzLCBlLmcuOgogICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgLy8gLSBhZGRzIGFuZCBpbW1lZGlhdGVseSByZW1vdmVzIHNjcmlwdCBlbGVtZW50cyBmcm9tIHRoZSBkb2N1bWVudAogICAgdmFyIHNjcmlwdCA9IHJhd0RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLCBjYWxsYmFjayA9IG51bGw7CiAgICBzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwogICAgc2NyaXB0LnNyYyA9IHVybDsKICAgIHNjcmlwdC5hc3luYyA9IHRydWU7CgogICAgY2FsbGJhY2sgPSBmdW5jdGlvbihldmVudCkgewogICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oc2NyaXB0LCAibG9hZCIsIGNhbGxiYWNrKTsKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKHNjcmlwdCwgImVycm9yIiwgY2FsbGJhY2spOwogICAgICByYXdEb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgIHNjcmlwdCA9IG51bGw7CiAgICAgIHZhciBzdGF0dXMgPSAtMTsKICAgICAgdmFyIHRleHQgPSAidW5rbm93biI7CgogICAgICBpZiAoZXZlbnQpIHsKICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImxvYWQiICYmICFjYWxsYmFja3NbY2FsbGJhY2tJZF0uY2FsbGVkKSB7CiAgICAgICAgICBldmVudCA9IHsgdHlwZTogImVycm9yIiB9OwogICAgICAgIH0KICAgICAgICB0ZXh0ID0gZXZlbnQudHlwZTsKICAgICAgICBzdGF0dXMgPSBldmVudC50eXBlID09PSAiZXJyb3IiID8gNDA0IDogMjAwOwogICAgICB9CgogICAgICBpZiAoZG9uZSkgewogICAgICAgIGRvbmUoc3RhdHVzLCB0ZXh0KTsKICAgICAgfQogICAgfTsKCiAgICBhZGRFdmVudExpc3RlbmVyRm4oc2NyaXB0LCAibG9hZCIsIGNhbGxiYWNrKTsKICAgIGFkZEV2ZW50TGlzdGVuZXJGbihzY3JpcHQsICJlcnJvciIsIGNhbGxiYWNrKTsKCiAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgIHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoaXNTdHJpbmcoc2NyaXB0LnJlYWR5U3RhdGUpICYmIC9sb2FkZWR8Y29tcGxldGUvLnRlc3Qoc2NyaXB0LnJlYWR5U3RhdGUpKSB7CiAgICAgICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgIGNhbGxiYWNrKHsKICAgICAgICAgICAgdHlwZTogJ2xvYWQnCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgcmF3RG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgcmV0dXJuIGNhbGxiYWNrOwogIH0KfQoKdmFyICRpbnRlcnBvbGF0ZU1pbkVyciA9IG1pbkVycignJGludGVycG9sYXRlJyk7CgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBVc2VkIGZvciBjb25maWd1cmluZyB0aGUgaW50ZXJwb2xhdGlvbiBtYXJrdXAuIERlZmF1bHRzIHRvIGB7e2AgYW5kIGB9fWAuCiAqCiAqIEBleGFtcGxlCjxleGFtcGxlIG1vZHVsZT0iY3VzdG9tSW50ZXJwb2xhdGlvbkFwcCI+CjxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgo8c2NyaXB0PgogIHZhciBjdXN0b21JbnRlcnBvbGF0aW9uQXBwID0gYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUludGVycG9sYXRpb25BcHAnLCBbXSk7CgogIGN1c3RvbUludGVycG9sYXRpb25BcHAuY29uZmlnKGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZVByb3ZpZGVyKSB7CiAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5zdGFydFN5bWJvbCgnLy8nKTsKICAgICRpbnRlcnBvbGF0ZVByb3ZpZGVyLmVuZFN5bWJvbCgnLy8nKTsKICB9KTsKCgogIGN1c3RvbUludGVycG9sYXRpb25BcHAuY29udHJvbGxlcignRGVtb0NvbnRyb2xsZXInLCBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sYWJlbCA9ICJUaGlzIGJpbmRpbmcgaXMgYnJvdWdodCB5b3UgYnkgLy8gaW50ZXJwb2xhdGlvbiBzeW1ib2xzLiI7CiAgfSk7Cjwvc2NyaXB0Pgo8ZGl2IG5nLWFwcD0iQXBwIiBuZy1jb250cm9sbGVyPSJEZW1vQ29udHJvbGxlciBhcyBkZW1vIj4KICAgIC8vZGVtby5sYWJlbC8vCjwvZGl2Pgo8L2ZpbGU+CjxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogIGl0KCdzaG91bGQgaW50ZXJwb2xhdGUgYmluZGluZyB3aXRoIGN1c3RvbSBzeW1ib2xzJywgZnVuY3Rpb24oKSB7CiAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdkZW1vLmxhYmVsJykpLmdldFRleHQoKSkudG9CZSgnVGhpcyBiaW5kaW5nIGlzIGJyb3VnaHQgeW91IGJ5IC8vIGludGVycG9sYXRpb24gc3ltYm9scy4nKTsKICB9KTsKPC9maWxlPgo8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiAkSW50ZXJwb2xhdGVQcm92aWRlcigpIHsKICB2YXIgc3RhcnRTeW1ib2wgPSAne3snOwogIHZhciBlbmRTeW1ib2wgPSAnfX0nOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTeW1ib2wgdG8gZGVub3RlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIHN0YXJ0aW5nIHN5bWJvbCB0by4KICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAqLwogIHRoaXMuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICBpZiAodmFsdWUpIHsKICAgICAgc3RhcnRTeW1ib2wgPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbAogICAqIEBkZXNjcmlwdGlvbgogICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBuZXcgdmFsdWUgdG8gc2V0IHRoZSBlbmRpbmcgc3ltYm9sIHRvLgogICAqIEByZXR1cm5zIHtzdHJpbmd8c2VsZn0gUmV0dXJucyB0aGUgc3ltYm9sIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcyBzZXR0ZXIuCiAgICovCiAgdGhpcy5lbmRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICBpZiAodmFsdWUpIHsKICAgICAgZW5kU3ltYm9sID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVuZFN5bWJvbDsKICAgIH0KICB9OwoKCiAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJHNjZScsIGZ1bmN0aW9uKCRwYXJzZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRzY2UpIHsKICAgIHZhciBzdGFydFN5bWJvbExlbmd0aCA9IHN0YXJ0U3ltYm9sLmxlbmd0aCwKICAgICAgICBlbmRTeW1ib2xMZW5ndGggPSBlbmRTeW1ib2wubGVuZ3RoOwoKICAgIC8qKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZQogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcmVxdWlyZXMgJHBhcnNlCiAgICAgKiBAcmVxdWlyZXMgJHNjZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIENvbXBpbGVzIGEgc3RyaW5nIHdpdGggbWFya3VwIGludG8gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gVGhpcyBzZXJ2aWNlIGlzIHVzZWQgYnkgdGhlCiAgICAgKiBIVE1MIHtAbGluayBuZy4kY29tcGlsZSAkY29tcGlsZX0gc2VydmljZSBmb3IgZGF0YSBiaW5kaW5nLiBTZWUKICAgICAqIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciAkaW50ZXJwb2xhdGVQcm92aWRlcn0gZm9yIGNvbmZpZ3VyaW5nIHRoZQogICAgICogaW50ZXJwb2xhdGlvbiBtYXJrdXAuCiAgICAgKgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAgIHZhciAkaW50ZXJwb2xhdGUgPSAuLi47IC8vIGluamVjdGVkCiAgICAgKiAgIHZhciBleHAgPSAkaW50ZXJwb2xhdGUoJ0hlbGxvIHt7bmFtZSB8IHVwcGVyY2FzZX19IScpOwogICAgICogICBleHBlY3QoZXhwKHtuYW1lOidBbmd1bGFyJ30pLnRvRXF1YWwoJ0hlbGxvIEFOR1VMQVIhJyk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgVGhlIHRleHQgd2l0aCBtYXJrdXAgdG8gaW50ZXJwb2xhdGUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBtdXN0SGF2ZUV4cHJlc3Npb24gaWYgc2V0IHRvIHRydWUgdGhlbiB0aGUgaW50ZXJwb2xhdGlvbiBzdHJpbmcgbXVzdCBoYXZlCiAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIGluIG9yZGVyIHRvIHJldHVybiBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBTdHJpbmdzIHdpdGggbm8KICAgICAqICAgIGVtYmVkZGVkIGV4cHJlc3Npb24gd2lsbCByZXR1cm4gbnVsbCBmb3IgdGhlIGludGVycG9sYXRpb24gZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHRydXN0ZWRDb250ZXh0IHdoZW4gcHJvdmlkZWQsIHRoZSByZXR1cm5lZCBmdW5jdGlvbiBwYXNzZXMgdGhlIGludGVycG9sYXRlZAogICAgICogICAgcmVzdWx0IHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWQoaW50ZXJwb2xhdGVkUmVzdWx0LAogICAgICogICAgdHJ1c3RlZENvbnRleHQpfSBiZWZvcmUgcmV0dXJuaW5nIGl0LiAgUmVmZXIgdG8gdGhlIHtAbGluayBuZy4kc2NlICRzY2V9IHNlcnZpY2UgdGhhdAogICAgICogICAgcHJvdmlkZXMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgZm9yIGRldGFpbHMuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCl9IGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24gd2hpY2ggaXMgdXNlZCB0byBjb21wdXRlIHRoZQogICAgICogICAgaW50ZXJwb2xhdGVkIHN0cmluZy4gVGhlIGZ1bmN0aW9uIGhhcyB0aGVzZSBwYXJhbWV0ZXJzOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgOiBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MgYXJlIGV2YWx1YXRlZAogICAgICogICAgICBhZ2FpbnN0LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJGludGVycG9sYXRlKHRleHQsIG11c3RIYXZlRXhwcmVzc2lvbiwgdHJ1c3RlZENvbnRleHQpIHsKICAgICAgdmFyIHN0YXJ0SW5kZXgsCiAgICAgICAgICBlbmRJbmRleCwKICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICBsZW5ndGggPSB0ZXh0Lmxlbmd0aCwKICAgICAgICAgIGhhc0ludGVycG9sYXRpb24gPSBmYWxzZSwKICAgICAgICAgIGZuLAogICAgICAgICAgZXhwLAogICAgICAgICAgY29uY2F0ID0gW107CgogICAgICB3aGlsZShpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmICggKChzdGFydEluZGV4ID0gdGV4dC5pbmRleE9mKHN0YXJ0U3ltYm9sLCBpbmRleCkpICE9IC0xKSAmJgogICAgICAgICAgICAgKChlbmRJbmRleCA9IHRleHQuaW5kZXhPZihlbmRTeW1ib2wsIHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCkpICE9IC0xKSApIHsKICAgICAgICAgIChpbmRleCAhPSBzdGFydEluZGV4KSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4LCBzdGFydEluZGV4KSk7CiAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICBmbi5leHAgPSBleHA7CiAgICAgICAgICBpbmRleCA9IGVuZEluZGV4ICsgZW5kU3ltYm9sTGVuZ3RoOwogICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIHdlIGRpZCBub3QgZmluZCBhbnl0aGluZywgc28gd2UgaGF2ZSB0byBhZGQgdGhlIHJlbWFpbmRlciB0byB0aGUgcGFydHMgYXJyYXkKICAgICAgICAgIChpbmRleCAhPSBsZW5ndGgpICYmIHBhcnRzLnB1c2godGV4dC5zdWJzdHJpbmcoaW5kZXgpKTsKICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCEobGVuZ3RoID0gcGFydHMubGVuZ3RoKSkgewogICAgICAgIC8vIHdlIGFkZGVkLCBub3RoaW5nLCBtdXN0IGhhdmUgYmVlbiBhbiBlbXB0eSBzdHJpbmcuCiAgICAgICAgcGFydHMucHVzaCgnJyk7CiAgICAgICAgbGVuZ3RoID0gMTsKICAgICAgfQoKICAgICAgLy8gQ29uY2F0ZW5hdGluZyBleHByZXNzaW9ucyBtYWtlcyBpdCBoYXJkIHRvIHJlYXNvbiBhYm91dCB3aGV0aGVyIHNvbWUgY29tYmluYXRpb24gb2YKICAgICAgLy8gY29uY2F0ZW5hdGVkIHZhbHVlcyBhcmUgdW5zYWZlIHRvIHVzZSBhbmQgY291bGQgZWFzaWx5IGxlYWQgdG8gWFNTLiAgQnkgcmVxdWlyaW5nIHRoYXQgYQogICAgICAvLyBzaW5nbGUgZXhwcmVzc2lvbiBiZSB1c2VkIGZvciBpZnJhbWVbc3JjXSwgb2JqZWN0W3NyY10sIGV0Yy4sIHdlIGVuc3VyZSB0aGF0IHRoZSB2YWx1ZQogICAgICAvLyB0aGF0J3MgdXNlZCBpcyBhc3NpZ25lZCBvciBjb25zdHJ1Y3RlZCBieSBzb21lIEpTIGNvZGUgc29tZXdoZXJlIHRoYXQgaXMgbW9yZSB0ZXN0YWJsZSBvcgogICAgICAvLyBtYWtlIGl0IG9idmlvdXMgdGhhdCB5b3UgYm91bmQgdGhlIHZhbHVlIHRvIHNvbWUgdXNlciBjb250cm9sbGVkIHZhbHVlLiAgVGhpcyBoZWxwcyByZWR1Y2UKICAgICAgLy8gdGhlIGxvYWQgd2hlbiBhdWRpdGluZyBmb3IgWFNTIGlzc3Vlcy4KICAgICAgaWYgKHRydXN0ZWRDb250ZXh0ICYmIHBhcnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIHRocm93ICRpbnRlcnBvbGF0ZU1pbkVycignbm9jb25jYXQnLAogICAgICAgICAgICAgICJFcnJvciB3aGlsZSBpbnRlcnBvbGF0aW5nOiB7MH1cblN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGRpc2FsbG93cyAiICsKICAgICAgICAgICAgICAiaW50ZXJwb2xhdGlvbnMgdGhhdCBjb25jYXRlbmF0ZSBtdWx0aXBsZSBleHByZXNzaW9ucyB3aGVuIGEgdHJ1c3RlZCB2YWx1ZSBpcyAiICsKICAgICAgICAgICAgICAicmVxdWlyZWQuICBTZWUgaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcuJHNjZSIsIHRleHQpOwogICAgICB9CgogICAgICBpZiAoIW11c3RIYXZlRXhwcmVzc2lvbiAgfHwgaGFzSW50ZXJwb2xhdGlvbikgewogICAgICAgIGNvbmNhdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgZm4gPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpaSA9IGxlbmd0aCwgcGFydDsgaTxpaTsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiAocGFydCA9IHBhcnRzW2ldKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBwYXJ0ID0gcGFydChjb250ZXh0KTsKICAgICAgICAgICAgICAgIGlmICh0cnVzdGVkQ29udGV4dCkgewogICAgICAgICAgICAgICAgICBwYXJ0ID0gJHNjZS5nZXRUcnVzdGVkKHRydXN0ZWRDb250ZXh0LCBwYXJ0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHBhcnQgPSAkc2NlLnZhbHVlT2YocGFydCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocGFydCA9PSBudWxsKSB7IC8vIG51bGwgfHwgdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgIHBhcnQgPSAnJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHBhcnQpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXNlICdudW1iZXInOgogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSAnJyArIHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdG9Kc29uKHBhcnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25jYXRbaV0gPSBwYXJ0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb25jYXQuam9pbignJyk7CiAgICAgICAgICB9CiAgICAgICAgICBjYXRjaChlcnIpIHsKICAgICAgICAgICAgdmFyIG5ld0VyciA9ICRpbnRlcnBvbGF0ZU1pbkVycignaW50ZXJyJywgIkNhbid0IGludGVycG9sYXRlOiB7MH1cbnsxfSIsIHRleHQsCiAgICAgICAgICAgICAgICBlcnIudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKG5ld0Vycik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmbi5leHAgPSB0ZXh0OwogICAgICAgIGZuLnBhcnRzID0gcGFydHM7CiAgICAgICAgcmV0dXJuIGZuOwogICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGludGVycG9sYXRlI3N0YXJ0U3ltYm9sCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICAgKgogICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbH0gdG8gY2hhbmdlCiAgICAgKiB0aGUgc3ltYm9sLgogICAgICoKICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHN0YXJ0IHN5bWJvbC4KICAgICAqLwogICAgJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzdGFydFN5bWJvbDsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGludGVycG9sYXRlI2VuZFN5bWJvbAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAqCiAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2x9IHRvIGNoYW5nZQogICAgICogdGhlIHN5bWJvbC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBlbmQgc3ltYm9sLgogICAgICovCiAgICAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICB9OwoKICAgIHJldHVybiAkaW50ZXJwb2xhdGU7CiAgfV07Cn0KCmZ1bmN0aW9uICRJbnRlcnZhbFByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckd2luZG93JywgJyRxJywKICAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICAgJHdpbmRvdywgICAkcSkgewogICAgdmFyIGludGVydmFscyA9IHt9OwoKCiAgICAgLyoqCiAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgKiBAbmFtZSAkaW50ZXJ2YWwKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIEFuZ3VsYXIncyB3cmFwcGVyIGZvciBgd2luZG93LnNldEludGVydmFsYC4gVGhlIGBmbmAgZnVuY3Rpb24gaXMgZXhlY3V0ZWQgZXZlcnkgYGRlbGF5YAogICAgICAqIG1pbGxpc2Vjb25kcy4KICAgICAgKgogICAgICAqIFRoZSByZXR1cm4gdmFsdWUgb2YgcmVnaXN0ZXJpbmcgYW4gaW50ZXJ2YWwgZnVuY3Rpb24gaXMgYSBwcm9taXNlLiBUaGlzIHByb21pc2Ugd2lsbCBiZQogICAgICAqIG5vdGlmaWVkIHVwb24gZWFjaCB0aWNrIG9mIHRoZSBpbnRlcnZhbCwgYW5kIHdpbGwgYmUgcmVzb2x2ZWQgYWZ0ZXIgYGNvdW50YCBpdGVyYXRpb25zLCBvcgogICAgICAqIHJ1biBpbmRlZmluaXRlbHkgaWYgYGNvdW50YCBpcyBub3QgZGVmaW5lZC4gVGhlIHZhbHVlIG9mIHRoZSBub3RpZmljYXRpb24gd2lsbCBiZSB0aGUKICAgICAgKiBudW1iZXIgb2YgaXRlcmF0aW9ucyB0aGF0IGhhdmUgcnVuLgogICAgICAqIFRvIGNhbmNlbCBhbiBpbnRlcnZhbCwgY2FsbCBgJGludGVydmFsLmNhbmNlbChwcm9taXNlKWAuCiAgICAgICoKICAgICAgKiBJbiB0ZXN0cyB5b3UgY2FuIHVzZSB7QGxpbmsgbmdNb2NrLiRpbnRlcnZhbCNmbHVzaCBgJGludGVydmFsLmZsdXNoKG1pbGxpcylgfSB0bwogICAgICAqIG1vdmUgZm9yd2FyZCBieSBgbWlsbGlzYCBtaWxsaXNlY29uZHMgYW5kIHRyaWdnZXIgYW55IGZ1bmN0aW9ucyBzY2hlZHVsZWQgdG8gcnVuIGluIHRoYXQKICAgICAgKiB0aW1lLgogICAgICAqCiAgICAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICAgICogKipOb3RlKio6IEludGVydmFscyBjcmVhdGVkIGJ5IHRoaXMgc2VydmljZSBtdXN0IGJlIGV4cGxpY2l0bHkgZGVzdHJveWVkIHdoZW4geW91IGFyZSBmaW5pc2hlZAogICAgICAqIHdpdGggdGhlbS4gIEluIHBhcnRpY3VsYXIgdGhleSBhcmUgbm90IGF1dG9tYXRpY2FsbHkgZGVzdHJveWVkIHdoZW4gYSBjb250cm9sbGVyJ3Mgc2NvcGUgb3IgYQogICAgICAqIGRpcmVjdGl2ZSdzIGVsZW1lbnQgYXJlIGRlc3Ryb3llZC4KICAgICAgKiBZb3Ugc2hvdWxkIHRha2UgdGhpcyBpbnRvIGNvbnNpZGVyYXRpb24gYW5kIG1ha2Ugc3VyZSB0byBhbHdheXMgY2FuY2VsIHRoZSBpbnRlcnZhbCBhdCB0aGUKICAgICAgKiBhcHByb3ByaWF0ZSBtb21lbnQuICBTZWUgdGhlIGV4YW1wbGUgYmVsb3cgZm9yIG1vcmUgZGV0YWlscyBvbiBob3cgYW5kIHdoZW4gdG8gZG8gdGhpcy4KICAgICAgKiA8L2Rpdj4KICAgICAgKgogICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgcmVwZWF0ZWRseS4KICAgICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIGVhY2ggZnVuY3Rpb24gY2FsbC4KICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtjb3VudD0wXSBOdW1iZXIgb2YgdGltZXMgdG8gcmVwZWF0LiBJZiBub3Qgc2V0LCBvciAwLCB3aWxsIHJlcGVhdAogICAgICAqICAgaW5kZWZpbml0ZWx5LgogICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCB3aWxsIGJlIG5vdGlmaWVkIG9uIGVhY2ggaXRlcmF0aW9uLgogICAgICAqCiAgICAgICogQGV4YW1wbGUKICAgICAgKiA8ZXhhbXBsZSBtb2R1bGU9InRpbWUiPgogICAgICAqICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICogICAgIDxzY3JpcHQ+CiAgICAgICogICAgICAgZnVuY3Rpb24gQ3RybDIoJHNjb3BlLCRpbnRlcnZhbCkgewogICAgICAqICAgICAgICAgJHNjb3BlLmZvcm1hdCA9ICdNL2QveXkgaDptbTpzcyBhJzsKICAgICAgKiAgICAgICAgICRzY29wZS5ibG9vZF8xID0gMTAwOwogICAgICAqICAgICAgICAgJHNjb3BlLmJsb29kXzIgPSAxMjA7CiAgICAgICoKICAgICAgKiAgICAgICAgIHZhciBzdG9wOwogICAgICAqICAgICAgICAgJHNjb3BlLmZpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgIC8vIERvbid0IHN0YXJ0IGEgbmV3IGZpZ2h0IGlmIHdlIGFyZSBhbHJlYWR5IGZpZ2h0aW5nCiAgICAgICogICAgICAgICAgIGlmICggYW5ndWxhci5pc0RlZmluZWQoc3RvcCkgKSByZXR1cm47CiAgICAgICoKICAgICAgKiAgICAgICAgICAgc3RvcCA9ICRpbnRlcnZhbChmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgICBpZiAoJHNjb3BlLmJsb29kXzEgPiAwICYmICRzY29wZS5ibG9vZF8yID4gMCkgewogICAgICAqICAgICAgICAgICAgICAgICAkc2NvcGUuYmxvb2RfMSA9ICRzY29wZS5ibG9vZF8xIC0gMzsKICAgICAgKiAgICAgICAgICAgICAgICAgJHNjb3BlLmJsb29kXzIgPSAkc2NvcGUuYmxvb2RfMiAtIDQ7CiAgICAgICogICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgKiAgICAgICAgICAgICAgICAgJHNjb3BlLnN0b3BGaWdodCgpOwogICAgICAqICAgICAgICAgICAgIH0KICAgICAgKiAgICAgICAgICAgfSwgMTAwKTsKICAgICAgKiAgICAgICAgIH07CiAgICAgICoKICAgICAgKiAgICAgICAgICRzY29wZS5zdG9wRmlnaHQgPSBmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKHN0b3ApKSB7CiAgICAgICogICAgICAgICAgICAgJGludGVydmFsLmNhbmNlbChzdG9wKTsKICAgICAgKiAgICAgICAgICAgICBzdG9wID0gdW5kZWZpbmVkOwogICAgICAqICAgICAgICAgICB9CiAgICAgICogICAgICAgICB9OwogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUucmVzZXRGaWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAkc2NvcGUuYmxvb2RfMSA9IDEwMDsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmJsb29kXzIgPSAxMjA7CiAgICAgICogICAgICAgICB9CiAgICAgICoKICAgICAgKiAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBpbnRlcnZhbCBpcyBkZXN0cm95ZWQgdG9vCiAgICAgICogICAgICAgICAgICRzY29wZS5zdG9wRmlnaHQoKTsKICAgICAgKiAgICAgICAgIH0pOwogICAgICAqICAgICAgIH0KICAgICAgKgogICAgICAqICAgICAgIGFuZ3VsYXIubW9kdWxlKCd0aW1lJywgW10pCiAgICAgICogICAgICAgICAvLyBSZWdpc3RlciB0aGUgJ215Q3VycmVudFRpbWUnIGRpcmVjdGl2ZSBmYWN0b3J5IG1ldGhvZC4KICAgICAgKiAgICAgICAgIC8vIFdlIGluamVjdCAkaW50ZXJ2YWwgYW5kIGRhdGVGaWx0ZXIgc2VydmljZSBzaW5jZSB0aGUgZmFjdG9yeSBtZXRob2QgaXMgREkuCiAgICAgICogICAgICAgICAuZGlyZWN0aXZlKCdteUN1cnJlbnRUaW1lJywgZnVuY3Rpb24oJGludGVydmFsLCBkYXRlRmlsdGVyKSB7CiAgICAgICogICAgICAgICAgIC8vIHJldHVybiB0aGUgZGlyZWN0aXZlIGxpbmsgZnVuY3Rpb24uIChjb21waWxlIGZ1bmN0aW9uIG5vdCBuZWVkZWQpCiAgICAgICogICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgKiAgICAgICAgICAgICB2YXIgZm9ybWF0LCAgLy8gZGF0ZSBmb3JtYXQKICAgICAgKiAgICAgICAgICAgICBzdG9wVGltZTsgLy8gc28gdGhhdCB3ZSBjYW4gY2FuY2VsIHRoZSB0aW1lIHVwZGF0ZXMKICAgICAgKgogICAgICAqICAgICAgICAgICAgIC8vIHVzZWQgdG8gdXBkYXRlIHRoZSBVSQogICAgICAqICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRpbWUoKSB7CiAgICAgICogICAgICAgICAgICAgICBlbGVtZW50LnRleHQoZGF0ZUZpbHRlcihuZXcgRGF0ZSgpLCBmb3JtYXQpKTsKICAgICAgKiAgICAgICAgICAgICB9CiAgICAgICoKICAgICAgKiAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgZXhwcmVzc2lvbiwgYW5kIHVwZGF0ZSB0aGUgVUkgb24gY2hhbmdlLgogICAgICAqICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRycy5teUN1cnJlbnRUaW1lLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAqICAgICAgICAgICAgICAgZm9ybWF0ID0gdmFsdWU7CiAgICAgICogICAgICAgICAgICAgICB1cGRhdGVUaW1lKCk7CiAgICAgICogICAgICAgICAgICAgfSk7CiAgICAgICoKICAgICAgKiAgICAgICAgICAgICBzdG9wVGltZSA9ICRpbnRlcnZhbCh1cGRhdGVUaW1lLCAxMDAwKTsKICAgICAgKgogICAgICAqICAgICAgICAgICAgIC8vIGxpc3RlbiBvbiBET00gZGVzdHJveSAocmVtb3ZhbCkgZXZlbnQsIGFuZCBjYW5jZWwgdGhlIG5leHQgVUkgdXBkYXRlCiAgICAgICogICAgICAgICAgICAgLy8gdG8gcHJldmVudCB1cGRhdGluZyB0aW1lIG9mdGVyIHRoZSBET00gZWxlbWVudCB3YXMgcmVtb3ZlZC4KICAgICAgKiAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgICAgICAkaW50ZXJ2YWwuY2FuY2VsKHN0b3BUaW1lKTsKICAgICAgKiAgICAgICAgICAgICB9KTsKICAgICAgKiAgICAgICAgICAgfQogICAgICAqICAgICAgICAgfSk7CiAgICAgICogICAgIDwvc2NyaXB0PgogICAgICAqCiAgICAgICogICAgIDxkaXY+CiAgICAgICogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsMiI+CiAgICAgICogICAgICAgICBEYXRlIGZvcm1hdDogPGlucHV0IG5nLW1vZGVsPSJmb3JtYXQiPiA8aHIvPgogICAgICAqICAgICAgICAgQ3VycmVudCB0aW1lIGlzOiA8c3BhbiBteS1jdXJyZW50LXRpbWU9ImZvcm1hdCI+PC9zcGFuPgogICAgICAqICAgICAgICAgPGhyLz4KICAgICAgKiAgICAgICAgIEJsb29kIDEgOiA8Zm9udCBjb2xvcj0ncmVkJz57e2Jsb29kXzF9fTwvZm9udD4KICAgICAgKiAgICAgICAgIEJsb29kIDIgOiA8Zm9udCBjb2xvcj0ncmVkJz57e2Jsb29kXzJ9fTwvZm9udD4KICAgICAgKiAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLW5nLWNsaWNrPSJmaWdodCgpIj5GaWdodDwvYnV0dG9uPgogICAgICAqICAgICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGRhdGEtbmctY2xpY2s9InN0b3BGaWdodCgpIj5TdG9wRmlnaHQ8L2J1dHRvbj4KICAgICAgKiAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLW5nLWNsaWNrPSJyZXNldEZpZ2h0KCkiPnJlc2V0RmlnaHQ8L2J1dHRvbj4KICAgICAgKiAgICAgICA8L2Rpdj4KICAgICAgKiAgICAgPC9kaXY+CiAgICAgICoKICAgICAgKiAgIDwvZmlsZT4KICAgICAgKiA8L2V4YW1wbGU+CiAgICAgICovCiAgICBmdW5jdGlvbiBpbnRlcnZhbChmbiwgZGVsYXksIGNvdW50LCBpbnZva2VBcHBseSkgewogICAgICB2YXIgc2V0SW50ZXJ2YWwgPSAkd2luZG93LnNldEludGVydmFsLAogICAgICAgICAgY2xlYXJJbnRlcnZhbCA9ICR3aW5kb3cuY2xlYXJJbnRlcnZhbCwKICAgICAgICAgIGRlZmVycmVkID0gJHEuZGVmZXIoKSwKICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgaXRlcmF0aW9uID0gMCwKICAgICAgICAgIHNraXBBcHBseSA9IChpc0RlZmluZWQoaW52b2tlQXBwbHkpICYmICFpbnZva2VBcHBseSk7CgogICAgICBjb3VudCA9IGlzRGVmaW5lZChjb3VudCkgPyBjb3VudCA6IDA7CgogICAgICBwcm9taXNlLnRoZW4obnVsbCwgbnVsbCwgZm4pOwoKICAgICAgcHJvbWlzZS4kJGludGVydmFsSWQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiB0aWNrKCkgewogICAgICAgIGRlZmVycmVkLm5vdGlmeShpdGVyYXRpb24rKyk7CgogICAgICAgIGlmIChjb3VudCA+IDAgJiYgaXRlcmF0aW9uID49IGNvdW50KSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGl0ZXJhdGlvbik7CiAgICAgICAgICBjbGVhckludGVydmFsKHByb21pc2UuJCRpbnRlcnZhbElkKTsKICAgICAgICAgIGRlbGV0ZSBpbnRlcnZhbHNbcHJvbWlzZS4kJGludGVydmFsSWRdOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFza2lwQXBwbHkpICRyb290U2NvcGUuJGFwcGx5KCk7CgogICAgICB9LCBkZWxheSk7CgogICAgICBpbnRlcnZhbHNbcHJvbWlzZS4kJGludGVydmFsSWRdID0gZGVmZXJyZWQ7CgogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KCgogICAgIC8qKgogICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgKiBAbmFtZSAkaW50ZXJ2YWwjY2FuY2VsCiAgICAgICoKICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgKiBDYW5jZWxzIGEgdGFzayBhc3NvY2lhdGVkIHdpdGggdGhlIGBwcm9taXNlYC4KICAgICAgKgogICAgICAqIEBwYXJhbSB7cHJvbWlzZX0gcHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCRpbnRlcnZhbGAgZnVuY3Rpb24uCiAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIHdhcyBzdWNjZXNzZnVsbHkgY2FuY2VsZWQuCiAgICAgICovCiAgICBpbnRlcnZhbC5jYW5jZWwgPSBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgIGlmIChwcm9taXNlICYmIHByb21pc2UuJCRpbnRlcnZhbElkIGluIGludGVydmFscykgewogICAgICAgIGludGVydmFsc1twcm9taXNlLiQkaW50ZXJ2YWxJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgIGNsZWFySW50ZXJ2YWwocHJvbWlzZS4kJGludGVydmFsSWQpOwogICAgICAgIGRlbGV0ZSBpbnRlcnZhbHNbcHJvbWlzZS4kJGludGVydmFsSWRdOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgcmV0dXJuIGludGVydmFsOwogIH1dOwp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGxvY2FsZQogKgogKiBAZGVzY3JpcHRpb24KICogJGxvY2FsZSBzZXJ2aWNlIHByb3ZpZGVzIGxvY2FsaXphdGlvbiBydWxlcyBmb3IgdmFyaW91cyBBbmd1bGFyIGNvbXBvbmVudHMuIEFzIG9mIHJpZ2h0IG5vdyB0aGUKICogb25seSBwdWJsaWMgYXBpIGlzOgogKgogKiAqIGBpZGAg4oCTIGB7c3RyaW5nfWAg4oCTIGxvY2FsZSBpZCBmb3JtYXR0ZWQgYXMgYGxhbmd1YWdlSWQtY291bnRyeUlkYCAoZS5nLiBgZW4tdXNgKQogKi8KZnVuY3Rpb24gJExvY2FsZVByb3ZpZGVyKCl7CiAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBpZDogJ2VuLXVzJywKCiAgICAgIE5VTUJFUl9GT1JNQVRTOiB7CiAgICAgICAgREVDSU1BTF9TRVA6ICcuJywKICAgICAgICBHUk9VUF9TRVA6ICcsJywKICAgICAgICBQQVRURVJOUzogWwogICAgICAgICAgeyAvLyBEZWNpbWFsIFBhdHRlcm4KICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICBtaW5GcmFjOiAwLAogICAgICAgICAgICBtYXhGcmFjOiAzLAogICAgICAgICAgICBwb3NQcmU6ICcnLAogICAgICAgICAgICBwb3NTdWY6ICcnLAogICAgICAgICAgICBuZWdQcmU6ICctJywKICAgICAgICAgICAgbmVnU3VmOiAnJywKICAgICAgICAgICAgZ1NpemU6IDMsCiAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgfSx7IC8vQ3VycmVuY3kgUGF0dGVybgogICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgIG1pbkZyYWM6IDIsCiAgICAgICAgICAgIG1heEZyYWM6IDIsCiAgICAgICAgICAgIHBvc1ByZTogJ1x1MDBBNCcsCiAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgIG5lZ1ByZTogJyhcdTAwQTQnLAogICAgICAgICAgICBuZWdTdWY6ICcpJywKICAgICAgICAgICAgZ1NpemU6IDMsCiAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgfQogICAgICAgIF0sCiAgICAgICAgQ1VSUkVOQ1lfU1lNOiAnJCcKICAgICAgfSwKCiAgICAgIERBVEVUSU1FX0ZPUk1BVFM6IHsKICAgICAgICBNT05USDoKICAgICAgICAgICAgJ0phbnVhcnksRmVicnVhcnksTWFyY2gsQXByaWwsTWF5LEp1bmUsSnVseSxBdWd1c3QsU2VwdGVtYmVyLE9jdG9iZXIsTm92ZW1iZXIsRGVjZW1iZXInCiAgICAgICAgICAgIC5zcGxpdCgnLCcpLAogICAgICAgIFNIT1JUTU9OVEg6ICAnSmFuLEZlYixNYXIsQXByLE1heSxKdW4sSnVsLEF1ZyxTZXAsT2N0LE5vdixEZWMnLnNwbGl0KCcsJyksCiAgICAgICAgREFZOiAnU3VuZGF5LE1vbmRheSxUdWVzZGF5LFdlZG5lc2RheSxUaHVyc2RheSxGcmlkYXksU2F0dXJkYXknLnNwbGl0KCcsJyksCiAgICAgICAgU0hPUlREQVk6ICdTdW4sTW9uLFR1ZSxXZWQsVGh1LEZyaSxTYXQnLnNwbGl0KCcsJyksCiAgICAgICAgQU1QTVM6IFsnQU0nLCdQTSddLAogICAgICAgIG1lZGl1bTogJ01NTSBkLCB5IGg6bW06c3MgYScsCiAgICAgICAgc2hvcnQ6ICdNL2QveXkgaDptbSBhJywKICAgICAgICBmdWxsRGF0ZTogJ0VFRUUsIE1NTU0gZCwgeScsCiAgICAgICAgbG9uZ0RhdGU6ICdNTU1NIGQsIHknLAogICAgICAgIG1lZGl1bURhdGU6ICdNTU0gZCwgeScsCiAgICAgICAgc2hvcnREYXRlOiAnTS9kL3l5JywKICAgICAgICBtZWRpdW1UaW1lOiAnaDptbTpzcyBhJywKICAgICAgICBzaG9ydFRpbWU6ICdoOm1tIGEnCiAgICAgIH0sCgogICAgICBwbHVyYWxDYXQ6IGZ1bmN0aW9uKG51bSkgewogICAgICAgIGlmIChudW0gPT09IDEpIHsKICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgIH0KICAgIH07CiAgfTsKfQoKdmFyIFBBVEhfTUFUQ0ggPSAvXihbXlw/I10qKShcPyhbXiNdKikpPygjKC4qKSk/JC8sCiAgICBERUZBVUxUX1BPUlRTID0geydodHRwJzogODAsICdodHRwcyc6IDQ0MywgJ2Z0cCc6IDIxfTsKdmFyICRsb2NhdGlvbk1pbkVyciA9IG1pbkVycignJGxvY2F0aW9uJyk7CgoKLyoqCiAqIEVuY29kZSBwYXRoIHVzaW5nIGVuY29kZVVyaVNlZ21lbnQsIGlnbm9yaW5nIGZvcndhcmQgc2xhc2hlcwogKgogKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBQYXRoIHRvIGVuY29kZQogKiBAcmV0dXJucyB7c3RyaW5nfQogKi8KZnVuY3Rpb24gZW5jb2RlUGF0aChwYXRoKSB7CiAgdmFyIHNlZ21lbnRzID0gcGF0aC5zcGxpdCgnLycpLAogICAgICBpID0gc2VnbWVudHMubGVuZ3RoOwoKICB3aGlsZSAoaS0tKSB7CiAgICBzZWdtZW50c1tpXSA9IGVuY29kZVVyaVNlZ21lbnQoc2VnbWVudHNbaV0pOwogIH0KCiAgcmV0dXJuIHNlZ21lbnRzLmpvaW4oJy8nKTsKfQoKZnVuY3Rpb24gcGFyc2VBYnNvbHV0ZVVybChhYnNvbHV0ZVVybCwgbG9jYXRpb25PYmosIGFwcEJhc2UpIHsKICB2YXIgcGFyc2VkVXJsID0gdXJsUmVzb2x2ZShhYnNvbHV0ZVVybCwgYXBwQmFzZSk7CgogIGxvY2F0aW9uT2JqLiQkcHJvdG9jb2wgPSBwYXJzZWRVcmwucHJvdG9jb2w7CiAgbG9jYXRpb25PYmouJCRob3N0ID0gcGFyc2VkVXJsLmhvc3RuYW1lOwogIGxvY2F0aW9uT2JqLiQkcG9ydCA9IGludChwYXJzZWRVcmwucG9ydCkgfHwgREVGQVVMVF9QT1JUU1twYXJzZWRVcmwucHJvdG9jb2xdIHx8IG51bGw7Cn0KCgpmdW5jdGlvbiBwYXJzZUFwcFVybChyZWxhdGl2ZVVybCwgbG9jYXRpb25PYmosIGFwcEJhc2UpIHsKICB2YXIgcHJlZml4ZWQgPSAocmVsYXRpdmVVcmwuY2hhckF0KDApICE9PSAnLycpOwogIGlmIChwcmVmaXhlZCkgewogICAgcmVsYXRpdmVVcmwgPSAnLycgKyByZWxhdGl2ZVVybDsKICB9CiAgdmFyIG1hdGNoID0gdXJsUmVzb2x2ZShyZWxhdGl2ZVVybCwgYXBwQmFzZSk7CiAgbG9jYXRpb25PYmouJCRwYXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KHByZWZpeGVkICYmIG1hdGNoLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nID8KICAgICAgbWF0Y2gucGF0aG5hbWUuc3Vic3RyaW5nKDEpIDogbWF0Y2gucGF0aG5hbWUpOwogIGxvY2F0aW9uT2JqLiQkc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShtYXRjaC5zZWFyY2gpOwogIGxvY2F0aW9uT2JqLiQkaGFzaCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5oYXNoKTsKCiAgLy8gbWFrZSBzdXJlIHBhdGggc3RhcnRzIHdpdGggJy8nOwogIGlmIChsb2NhdGlvbk9iai4kJHBhdGggJiYgbG9jYXRpb25PYmouJCRwYXRoLmNoYXJBdCgwKSAhPSAnLycpIHsKICAgIGxvY2F0aW9uT2JqLiQkcGF0aCA9ICcvJyArIGxvY2F0aW9uT2JqLiQkcGF0aDsKICB9Cn0KCgovKioKICoKICogQHBhcmFtIHtzdHJpbmd9IGJlZ2luCiAqIEBwYXJhbSB7c3RyaW5nfSB3aG9sZQogKiBAcmV0dXJucyB7c3RyaW5nfSByZXR1cm5zIHRleHQgZnJvbSB3aG9sZSBhZnRlciBiZWdpbiBvciB1bmRlZmluZWQgaWYgaXQgZG9lcyBub3QgYmVnaW4gd2l0aAogKiAgICAgICAgICAgICAgICAgICBleHBlY3RlZCBzdHJpbmcuCiAqLwpmdW5jdGlvbiBiZWdpbnNXaXRoKGJlZ2luLCB3aG9sZSkgewogIGlmICh3aG9sZS5pbmRleE9mKGJlZ2luKSA9PT0gMCkgewogICAgcmV0dXJuIHdob2xlLnN1YnN0cihiZWdpbi5sZW5ndGgpOwogIH0KfQoKCmZ1bmN0aW9uIHN0cmlwSGFzaCh1cmwpIHsKICB2YXIgaW5kZXggPSB1cmwuaW5kZXhPZignIycpOwogIHJldHVybiBpbmRleCA9PSAtMSA/IHVybCA6IHVybC5zdWJzdHIoMCwgaW5kZXgpOwp9CgoKZnVuY3Rpb24gc3RyaXBGaWxlKHVybCkgewogIHJldHVybiB1cmwuc3Vic3RyKDAsIHN0cmlwSGFzaCh1cmwpLmxhc3RJbmRleE9mKCcvJykgKyAxKTsKfQoKLyogcmV0dXJuIHRoZSBzZXJ2ZXIgb25seSAoc2NoZW1lOi8vaG9zdDpwb3J0KSAqLwpmdW5jdGlvbiBzZXJ2ZXJCYXNlKHVybCkgewogIHJldHVybiB1cmwuc3Vic3RyaW5nKDAsIHVybC5pbmRleE9mKCcvJywgdXJsLmluZGV4T2YoJy8vJykgKyAyKSk7Cn0KCgovKioKICogTG9jYXRpb25IdG1sNVVybCByZXByZXNlbnRzIGFuIHVybAogKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gSFRNTDUgbW9kZSBpcyBlbmFibGVkIGFuZCBzdXBwb3J0ZWQKICoKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBCYXNlIGFwcGxpY2F0aW9uIGJhc2UgVVJMCiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUHJlZml4IHVybCBwYXRoIHByZWZpeAogKi8KZnVuY3Rpb24gTG9jYXRpb25IdG1sNVVybChhcHBCYXNlLCBiYXNlUHJlZml4KSB7CiAgdGhpcy4kJGh0bWw1ID0gdHJ1ZTsKICBiYXNlUHJlZml4ID0gYmFzZVByZWZpeCB8fCAnJzsKICB2YXIgYXBwQmFzZU5vRmlsZSA9IHN0cmlwRmlsZShhcHBCYXNlKTsKICBwYXJzZUFic29sdXRlVXJsKGFwcEJhc2UsIHRoaXMsIGFwcEJhc2UpOwoKCiAgLyoqCiAgICogUGFyc2UgZ2l2ZW4gaHRtbDUgKHJlZ3VsYXIpIHVybCBzdHJpbmcgaW50byBwcm9wZXJ0aWVzCiAgICogQHBhcmFtIHtzdHJpbmd9IG5ld0Fic29sdXRlVXJsIEhUTUw1IHVybAogICAqIEBwcml2YXRlCiAgICovCiAgdGhpcy4kJHBhcnNlID0gZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgcGF0aFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKTsKICAgIGlmICghaXNTdHJpbmcocGF0aFVybCkpIHsKICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpcHRocHJmeCcsICdJbnZhbGlkIHVybCAiezB9IiwgbWlzc2luZyBwYXRoIHByZWZpeCAiezF9Ii4nLCB1cmwsCiAgICAgICAgICBhcHBCYXNlTm9GaWxlKTsKICAgIH0KCiAgICBwYXJzZUFwcFVybChwYXRoVXJsLCB0aGlzLCBhcHBCYXNlKTsKCiAgICBpZiAoIXRoaXMuJCRwYXRoKSB7CiAgICAgIHRoaXMuJCRwYXRoID0gJy8nOwogICAgfQoKICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgfTsKCiAgLyoqCiAgICogQ29tcG9zZSB1cmwgYW5kIHVwZGF0ZSBgYWJzVXJsYCBwcm9wZXJ0eQogICAqIEBwcml2YXRlCiAgICovCiAgdGhpcy4kJGNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICB0aGlzLiQkYWJzVXJsID0gYXBwQmFzZU5vRmlsZSArIHRoaXMuJCR1cmwuc3Vic3RyKDEpOyAvLyBmaXJzdCBjaGFyIGlzIGFsd2F5cyAnLycKICB9OwoKICB0aGlzLiQkcmV3cml0ZSA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIGFwcFVybCwgcHJldkFwcFVybDsKCiAgICBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2UsIHVybCkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgIHByZXZBcHBVcmwgPSBhcHBVcmw7CiAgICAgIGlmICggKGFwcFVybCA9IGJlZ2luc1dpdGgoYmFzZVByZWZpeCwgYXBwVXJsKSkgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICByZXR1cm4gYXBwQmFzZU5vRmlsZSArIChiZWdpbnNXaXRoKCcvJywgYXBwVXJsKSB8fCBhcHBVcmwpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBhcHBCYXNlICsgcHJldkFwcFVybDsKICAgICAgfQogICAgfSBlbHNlIGlmICggKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKSkgIT09IHVuZGVmaW5lZCApIHsKICAgICAgcmV0dXJuIGFwcEJhc2VOb0ZpbGUgKyBhcHBVcmw7CiAgICB9IGVsc2UgaWYgKGFwcEJhc2VOb0ZpbGUgPT0gdXJsICsgJy8nKSB7CiAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlOwogICAgfQogIH07Cn0KCgovKioKICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gZGV2ZWxvcGVyIGRvZXNuJ3Qgb3B0IGludG8gaHRtbDUgbW9kZS4KICogSXQgYWxzbyBzZXJ2ZXMgYXMgdGhlIGJhc2UgY2xhc3MgZm9yIGh0bWw1IG1vZGUgZmFsbGJhY2sgb24gbGVnYWN5IGJyb3dzZXJzLgogKgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggaGFzaGJhbmcgcHJlZml4CiAqLwpmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICB2YXIgYXBwQmFzZU5vRmlsZSA9IHN0cmlwRmlsZShhcHBCYXNlKTsKCiAgcGFyc2VBYnNvbHV0ZVVybChhcHBCYXNlLCB0aGlzLCBhcHBCYXNlKTsKCgogIC8qKgogICAqIFBhcnNlIGdpdmVuIGhhc2hiYW5nIHVybCBpbnRvIHByb3BlcnRpZXMKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIEhhc2hiYW5nIHVybAogICAqIEBwcml2YXRlCiAgICovCiAgdGhpcy4kJHBhcnNlID0gZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgd2l0aG91dEJhc2VVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2UsIHVybCkgfHwgYmVnaW5zV2l0aChhcHBCYXNlTm9GaWxlLCB1cmwpOwogICAgdmFyIHdpdGhvdXRIYXNoVXJsID0gd2l0aG91dEJhc2VVcmwuY2hhckF0KDApID09ICcjJwogICAgICAgID8gYmVnaW5zV2l0aChoYXNoUHJlZml4LCB3aXRob3V0QmFzZVVybCkKICAgICAgICA6ICh0aGlzLiQkaHRtbDUpCiAgICAgICAgICA/IHdpdGhvdXRCYXNlVXJsCiAgICAgICAgICA6ICcnOwoKICAgIGlmICghaXNTdHJpbmcod2l0aG91dEhhc2hVcmwpKSB7CiAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaWhzaHByZngnLCAnSW52YWxpZCB1cmwgInswfSIsIG1pc3NpbmcgaGFzaCBwcmVmaXggInsxfSIuJywgdXJsLAogICAgICAgICAgaGFzaFByZWZpeCk7CiAgICB9CiAgICBwYXJzZUFwcFVybCh3aXRob3V0SGFzaFVybCwgdGhpcywgYXBwQmFzZSk7CgogICAgdGhpcy4kJHBhdGggPSByZW1vdmVXaW5kb3dzRHJpdmVOYW1lKHRoaXMuJCRwYXRoLCB3aXRob3V0SGFzaFVybCwgYXBwQmFzZSk7CgogICAgdGhpcy4kJGNvbXBvc2UoKTsKCiAgICAvKgogICAgICogSW4gV2luZG93cywgb24gYW4gYW5jaG9yIG5vZGUgb24gZG9jdW1lbnRzIGxvYWRlZCBmcm9tCiAgICAgKiB0aGUgZmlsZXN5c3RlbSwgdGhlIGJyb3dzZXIgd2lsbCByZXR1cm4gYSBwYXRobmFtZQogICAgICogcHJlZml4ZWQgd2l0aCB0aGUgZHJpdmUgbmFtZSAoJy9DOi9wYXRoJykgd2hlbiBhCiAgICAgKiBwYXRobmFtZSB3aXRob3V0IGEgZHJpdmUgaXMgc2V0OgogICAgICogICogYS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnL2ZvbycpCiAgICAgKiAgICogYS5wYXRobmFtZSA9PT0gJy9DOi9mb28nIC8vdHJ1ZQogICAgICoKICAgICAqIEluc2lkZSBvZiBBbmd1bGFyLCB3ZSdyZSBhbHdheXMgdXNpbmcgcGF0aG5hbWVzIHRoYXQKICAgICAqIGRvIG5vdCBpbmNsdWRlIGRyaXZlIG5hbWVzIGZvciByb3V0aW5nLgogICAgICovCiAgICBmdW5jdGlvbiByZW1vdmVXaW5kb3dzRHJpdmVOYW1lIChwYXRoLCB1cmwsIGJhc2UpIHsKICAgICAgLyoKICAgICAgTWF0Y2hlcyBwYXRocyBmb3IgZmlsZSBwcm90b2NvbCBvbiB3aW5kb3dzLAogICAgICBzdWNoIGFzIC9DOi9mb28vYmFyLCBhbmQgY2FwdHVyZXMgb25seSAvZm9vL2Jhci4KICAgICAgKi8KICAgICAgdmFyIHdpbmRvd3NGaWxlUGF0aEV4cCA9IC9eXC9bQS1aXTooXC8uKikvOwoKICAgICAgdmFyIGZpcnN0UGF0aFNlZ21lbnRNYXRjaDsKCiAgICAgIC8vR2V0IHRoZSByZWxhdGl2ZSBwYXRoIGZyb20gdGhlIGlucHV0IFVSTC4KICAgICAgaWYgKHVybC5pbmRleE9mKGJhc2UpID09PSAwKSB7CiAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoYmFzZSwgJycpOwogICAgICB9CgogICAgICAvLyBUaGUgaW5wdXQgVVJMIGludGVudGlvbmFsbHkgY29udGFpbnMgYSBmaXJzdCBwYXRoIHNlZ21lbnQgdGhhdCBlbmRzIHdpdGggYSBjb2xvbi4KICAgICAgaWYgKHdpbmRvd3NGaWxlUGF0aEV4cC5leGVjKHVybCkpIHsKICAgICAgICByZXR1cm4gcGF0aDsKICAgICAgfQoKICAgICAgZmlyc3RQYXRoU2VnbWVudE1hdGNoID0gd2luZG93c0ZpbGVQYXRoRXhwLmV4ZWMocGF0aCk7CiAgICAgIHJldHVybiBmaXJzdFBhdGhTZWdtZW50TWF0Y2ggPyBmaXJzdFBhdGhTZWdtZW50TWF0Y2hbMV0gOiBwYXRoOwogICAgfQogIH07CgogIC8qKgogICAqIENvbXBvc2UgaGFzaGJhbmcgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgdGhpcy4kJGFic1VybCA9IGFwcEJhc2UgKyAodGhpcy4kJHVybCA/IGhhc2hQcmVmaXggKyB0aGlzLiQkdXJsIDogJycpOwogIH07CgogIHRoaXMuJCRyZXdyaXRlID0gZnVuY3Rpb24odXJsKSB7CiAgICBpZihzdHJpcEhhc2goYXBwQmFzZSkgPT0gc3RyaXBIYXNoKHVybCkpIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0KICB9Owp9CgoKLyoqCiAqIExvY2F0aW9uSGFzaGJhbmdVcmwgcmVwcmVzZW50cyB1cmwKICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGh0bWw1IGhpc3RvcnkgYXBpIGlzIGVuYWJsZWQgYnV0IHRoZSBicm93c2VyCiAqIGRvZXMgbm90IHN1cHBvcnQgaXQuCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogKiBAcGFyYW0ge3N0cmluZ30gaGFzaFByZWZpeCBoYXNoYmFuZyBwcmVmaXgKICovCmZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICB0aGlzLiQkaHRtbDUgPSB0cnVlOwogIExvY2F0aW9uSGFzaGJhbmdVcmwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CgogIHRoaXMuJCRyZXdyaXRlID0gZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgYXBwVXJsOwoKICAgIGlmICggYXBwQmFzZSA9PSBzdHJpcEhhc2godXJsKSApIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0gZWxzZSBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCkpICkgewogICAgICByZXR1cm4gYXBwQmFzZSArIGhhc2hQcmVmaXggKyBhcHBVcmw7CiAgICB9IGVsc2UgaWYgKCBhcHBCYXNlTm9GaWxlID09PSB1cmwgKyAnLycpIHsKICAgICAgcmV0dXJuIGFwcEJhc2VOb0ZpbGU7CiAgICB9CiAgfTsKCiAgdGhpcy4kJGNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICAvLyBpbmNsdWRlIGhhc2hQcmVmaXggaW4gJCRhYnNVcmwgd2hlbiAkJHVybCBpcyBlbXB0eSBzbyBJRTggJiA5IGRvIG5vdCByZWxvYWQgcGFnZSBiZWNhdXNlIG9mIHJlbW92YWwgb2YgJyMnCiAgICB0aGlzLiQkYWJzVXJsID0gYXBwQmFzZSArIGhhc2hQcmVmaXggKyB0aGlzLiQkdXJsOwogIH07Cgp9CgoKTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwucHJvdG90eXBlID0KICBMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSA9CiAgTG9jYXRpb25IdG1sNVVybC5wcm90b3R5cGUgPSB7CgogIC8qKgogICAqIEFyZSB3ZSBpbiBodG1sNSBtb2RlPwogICAqIEBwcml2YXRlCiAgICovCiAgJCRodG1sNTogZmFsc2UsCgogIC8qKgogICAqIEhhcyBhbnkgY2hhbmdlIGJlZW4gcmVwbGFjaW5nID8KICAgKiBAcHJpdmF0ZQogICAqLwogICQkcmVwbGFjZTogZmFsc2UsCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jYWJzVXJsCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgKgogICAqIFJldHVybiBmdWxsIHVybCByZXByZXNlbnRhdGlvbiB3aXRoIGFsbCBzZWdtZW50cyBlbmNvZGVkIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgKiBbUkZDIDM5ODZdKGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0KS4KICAgKgogICAqIEByZXR1cm4ge3N0cmluZ30gZnVsbCB1cmwKICAgKi8KICBhYnNVcmw6IGxvY2F0aW9uR2V0dGVyKCckJGFic1VybCcpLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3VybAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAqCiAgICogUmV0dXJuIHVybCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKSB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICoKICAgKiBDaGFuZ2UgcGF0aCwgc2VhcmNoIGFuZCBoYXNoLCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSB1cmwgTmV3IHVybCB3aXRob3V0IGJhc2UgcHJlZml4IChlLmcuIGAvcGF0aD9hPWIjaGFzaGApCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXBsYWNlIFRoZSBwYXRoIHRoYXQgd2lsbCBiZSBjaGFuZ2VkCiAgICogQHJldHVybiB7c3RyaW5nfSB1cmwKICAgKi8KICB1cmw6IGZ1bmN0aW9uKHVybCwgcmVwbGFjZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHVybCkpCiAgICAgIHJldHVybiB0aGlzLiQkdXJsOwoKICAgIHZhciBtYXRjaCA9IFBBVEhfTUFUQ0guZXhlYyh1cmwpOwogICAgaWYgKG1hdGNoWzFdKSB0aGlzLnBhdGgoZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzFdKSk7CiAgICBpZiAobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pIHRoaXMuc2VhcmNoKG1hdGNoWzNdIHx8ICcnKTsKICAgIHRoaXMuaGFzaChtYXRjaFs1XSB8fCAnJywgcmVwbGFjZSk7CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNwcm90b2NvbAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICoKICAgKiBSZXR1cm4gcHJvdG9jb2wgb2YgY3VycmVudCB1cmwuCiAgICoKICAgKiBAcmV0dXJuIHtzdHJpbmd9IHByb3RvY29sIG9mIGN1cnJlbnQgdXJsCiAgICovCiAgcHJvdG9jb2w6IGxvY2F0aW9uR2V0dGVyKCckJHByb3RvY29sJyksCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jaG9zdAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICoKICAgKiBSZXR1cm4gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgKgogICAqIEByZXR1cm4ge3N0cmluZ30gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgKi8KICBob3N0OiBsb2NhdGlvbkdldHRlcignJCRob3N0JyksCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jcG9ydAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICoKICAgKiBSZXR1cm4gcG9ydCBvZiBjdXJyZW50IHVybC4KICAgKgogICAqIEByZXR1cm4ge051bWJlcn0gcG9ydAogICAqLwogIHBvcnQ6IGxvY2F0aW9uR2V0dGVyKCckJHBvcnQnKSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNwYXRoCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICoKICAgKiBSZXR1cm4gcGF0aCBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICoKICAgKiBDaGFuZ2UgcGF0aCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAqCiAgICogTm90ZTogUGF0aCBzaG91bGQgYWx3YXlzIGJlZ2luIHdpdGggZm9yd2FyZCBzbGFzaCAoLyksIHRoaXMgbWV0aG9kIHdpbGwgYWRkIHRoZSBmb3J3YXJkIHNsYXNoCiAgICogaWYgaXQgaXMgbWlzc2luZy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcGF0aCBOZXcgcGF0aAogICAqIEByZXR1cm4ge3N0cmluZ30gcGF0aAogICAqLwogIHBhdGg6IGxvY2F0aW9uR2V0dGVyU2V0dGVyKCckJHBhdGgnLCBmdW5jdGlvbihwYXRoKSB7CiAgICByZXR1cm4gcGF0aC5jaGFyQXQoMCkgPT0gJy8nID8gcGF0aCA6ICcvJyArIHBhdGg7CiAgfSksCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jc2VhcmNoCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICoKICAgKiBSZXR1cm4gc2VhcmNoIHBhcnQgKGFzIG9iamVjdCkgb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAqCiAgICogQ2hhbmdlIHNlYXJjaCBwYXJ0IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICoKICAgKgogICAqIGBgYGpzCiAgICogLy8gZ2l2ZW4gdXJsIGh0dHA6Ly9leGFtcGxlLmNvbS8jL3NvbWUvcGF0aD9mb289YmFyJmJhej14b3hvCiAgICogdmFyIHNlYXJjaE9iamVjdCA9ICRsb2NhdGlvbi5zZWFyY2goKTsKICAgKiAvLyA9PiB7Zm9vOiAnYmFyJywgYmF6OiAneG94byd9CiAgICoKICAgKgogICAqIC8vIHNldCBmb28gdG8gJ3lpcGVlJwogICAqICRsb2NhdGlvbi5zZWFyY2goJ2ZvbycsICd5aXBlZScpOwogICAqIC8vID0+ICRsb2NhdGlvbgogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0LjxzdHJpbmc+fE9iamVjdC48QXJyYXkuPHN0cmluZz4+fSBzZWFyY2ggTmV3IHNlYXJjaCBwYXJhbXMgLSBzdHJpbmcgb3IKICAgKiBoYXNoIG9iamVjdC4KICAgKgogICAqIFdoZW4gY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQgdGhlIG1ldGhvZCBhY3RzIGFzIGEgc2V0dGVyLCBzZXR0aW5nIHRoZSBgc2VhcmNoYCBjb21wb25lbnQKICAgKiBvZiBgJGxvY2F0aW9uYCB0byB0aGUgc3BlY2lmaWVkIHZhbHVlLgogICAqCiAgICogSWYgdGhlIGFyZ3VtZW50IGlzIGEgaGFzaCBvYmplY3QgY29udGFpbmluZyBhbiBhcnJheSBvZiB2YWx1ZXMsIHRoZXNlIHZhbHVlcyB3aWxsIGJlIGVuY29kZWQKICAgKiBhcyBkdXBsaWNhdGUgc2VhcmNoIHBhcmFtZXRlcnMgaW4gdGhlIHVybC4KICAgKgogICAqIEBwYXJhbSB7KHN0cmluZ3xBcnJheTxzdHJpbmc+KT19IHBhcmFtVmFsdWUgSWYgYHNlYXJjaGAgaXMgYSBzdHJpbmcsIHRoZW4gYHBhcmFtVmFsdWVgIHdpbGwKICAgKiBvdmVycmlkZSBvbmx5IGEgc2luZ2xlIHNlYXJjaCBwcm9wZXJ0eS4KICAgKgogICAqIElmIGBwYXJhbVZhbHVlYCBpcyBhbiBhcnJheSwgaXQgd2lsbCBvdmVycmlkZSB0aGUgcHJvcGVydHkgb2YgdGhlIGBzZWFyY2hgIGNvbXBvbmVudCBvZgogICAqIGAkbG9jYXRpb25gIHNwZWNpZmllZCB2aWEgdGhlIGZpcnN0IGFyZ3VtZW50LgogICAqCiAgICogSWYgYHBhcmFtVmFsdWVgIGlzIGBudWxsYCwgdGhlIHByb3BlcnR5IHNwZWNpZmllZCB2aWEgdGhlIGZpcnN0IGFyZ3VtZW50IHdpbGwgYmUgZGVsZXRlZC4KICAgKgogICAqIEByZXR1cm4ge09iamVjdH0gSWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgdGhlIHBhcnNlZCBgc2VhcmNoYCBvYmplY3QuIElmIGNhbGxlZCB3aXRoCiAgICogb25lIG9yIG1vcmUgYXJndW1lbnRzIHJldHVybnMgYCRsb2NhdGlvbmAgb2JqZWN0IGl0c2VsZi4KICAgKi8KICBzZWFyY2g6IGZ1bmN0aW9uKHNlYXJjaCwgcGFyYW1WYWx1ZSkgewogICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gdGhpcy4kJHNlYXJjaDsKICAgICAgY2FzZSAxOgogICAgICAgIGlmIChpc1N0cmluZyhzZWFyY2gpKSB7CiAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShzZWFyY2gpOwogICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc2VhcmNoKSkgewogICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IHNlYXJjaDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpc3JjaGFyZycsCiAgICAgICAgICAgICAgJ1RoZSBmaXJzdCBhcmd1bWVudCBvZiB0aGUgYCRsb2NhdGlvbiNzZWFyY2goKWAgY2FsbCBtdXN0IGJlIGEgc3RyaW5nIG9yIGFuIG9iamVjdC4nKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHBhcmFtVmFsdWUpIHx8IHBhcmFtVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLiQkc2VhcmNoW3NlYXJjaF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJCRzZWFyY2hbc2VhcmNoXSA9IHBhcmFtVmFsdWU7CiAgICAgICAgfQogICAgfQoKICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI2hhc2gKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgKgogICAqIFJldHVybiBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgKgogICAqIENoYW5nZSBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IGhhc2ggTmV3IGhhc2ggZnJhZ21lbnQKICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhhc2gKICAgKi8KICBoYXNoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRoYXNoJywgaWRlbnRpdHkpLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3JlcGxhY2UKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIElmIGNhbGxlZCwgYWxsIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGR1cmluZyBjdXJyZW50IGAkZGlnZXN0YCB3aWxsIGJlIHJlcGxhY2luZyBjdXJyZW50IGhpc3RvcnkKICAgKiByZWNvcmQsIGluc3RlYWQgb2YgYWRkaW5nIG5ldyBvbmUuCiAgICovCiAgcmVwbGFjZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLiQkcmVwbGFjZSA9IHRydWU7CiAgICByZXR1cm4gdGhpczsKICB9Cn07CgpmdW5jdGlvbiBsb2NhdGlvbkdldHRlcihwcm9wZXJ0eSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKICB9Owp9CgoKZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXJTZXR0ZXIocHJvcGVydHksIHByZXByb2Nlc3MpIHsKICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKCiAgICB0aGlzW3Byb3BlcnR5XSA9IHByZXByb2Nlc3ModmFsdWUpOwogICAgdGhpcy4kJGNvbXBvc2UoKTsKCiAgICByZXR1cm4gdGhpczsKICB9Owp9CgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRsb2NhdGlvbgogKgogKiBAcmVxdWlyZXMgJHJvb3RFbGVtZW50CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgJGxvY2F0aW9uIHNlcnZpY2UgcGFyc2VzIHRoZSBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIgKGJhc2VkIG9uIHRoZQogKiBbd2luZG93LmxvY2F0aW9uXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi93aW5kb3cubG9jYXRpb24pKSBhbmQgbWFrZXMgdGhlIFVSTAogKiBhdmFpbGFibGUgdG8geW91ciBhcHBsaWNhdGlvbi4gQ2hhbmdlcyB0byB0aGUgVVJMIGluIHRoZSBhZGRyZXNzIGJhciBhcmUgcmVmbGVjdGVkIGludG8KICogJGxvY2F0aW9uIHNlcnZpY2UgYW5kIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGFyZSByZWZsZWN0ZWQgaW50byB0aGUgYnJvd3NlciBhZGRyZXNzIGJhci4KICoKICogKipUaGUgJGxvY2F0aW9uIHNlcnZpY2U6KioKICoKICogLSBFeHBvc2VzIHRoZSBjdXJyZW50IFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciwgc28geW91IGNhbgogKiAgIC0gV2F0Y2ggYW5kIG9ic2VydmUgdGhlIFVSTC4KICogICAtIENoYW5nZSB0aGUgVVJMLgogKiAtIFN5bmNocm9uaXplcyB0aGUgVVJMIHdpdGggdGhlIGJyb3dzZXIgd2hlbiB0aGUgdXNlcgogKiAgIC0gQ2hhbmdlcyB0aGUgYWRkcmVzcyBiYXIuCiAqICAgLSBDbGlja3MgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gKG9yIGNsaWNrcyBhIEhpc3RvcnkgbGluaykuCiAqICAgLSBDbGlja3Mgb24gYSBsaW5rLgogKiAtIFJlcHJlc2VudHMgdGhlIFVSTCBvYmplY3QgYXMgYSBzZXQgb2YgbWV0aG9kcyAocHJvdG9jb2wsIGhvc3QsIHBvcnQsIHBhdGgsIHNlYXJjaCwgaGFzaCkuCiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB7QGxpbmsgZ3VpZGUvJGxvY2F0aW9uIERldmVsb3BlciBHdWlkZTogVXNpbmcgJGxvY2F0aW9ufQogKi8KCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGxvY2F0aW9uUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqIFVzZSB0aGUgYCRsb2NhdGlvblByb3ZpZGVyYCB0byBjb25maWd1cmUgaG93IHRoZSBhcHBsaWNhdGlvbiBkZWVwIGxpbmtpbmcgcGF0aHMgYXJlIHN0b3JlZC4KICovCmZ1bmN0aW9uICRMb2NhdGlvblByb3ZpZGVyKCl7CiAgdmFyIGhhc2hQcmVmaXggPSAnJywKICAgICAgaHRtbDVNb2RlID0gZmFsc2U7CgogIC8qKgogICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAqIEBuYW1lICRsb2NhdGlvblByb3ZpZGVyI2hhc2hQcmVmaXgKICAgKiBAZGVzY3JpcHRpb24KICAgKiBAcGFyYW0ge3N0cmluZz19IHByZWZpeCBQcmVmaXggZm9yIGhhc2ggcGFydCAoY29udGFpbmluZyBwYXRoIGFuZCBzZWFyY2gpCiAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgKi8KICB0aGlzLmhhc2hQcmVmaXggPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIGlmIChpc0RlZmluZWQocHJlZml4KSkgewogICAgICBoYXNoUHJlZml4ID0gcHJlZml4OwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBoYXNoUHJlZml4OwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAqIEBuYW1lICRsb2NhdGlvblByb3ZpZGVyI2h0bWw1TW9kZQogICAqIEBkZXNjcmlwdGlvbgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG1vZGUgVXNlIEhUTUw1IHN0cmF0ZWd5IGlmIGF2YWlsYWJsZS4KICAgKiBAcmV0dXJucyB7Kn0gY3VycmVudCB2YWx1ZSBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAqLwogIHRoaXMuaHRtbDVNb2RlID0gZnVuY3Rpb24obW9kZSkgewogICAgaWYgKGlzRGVmaW5lZChtb2RlKSkgewogICAgICBodG1sNU1vZGUgPSBtb2RlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBodG1sNU1vZGU7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIGV2ZW50CiAgICogQG5hbWUgJGxvY2F0aW9uIyRsb2NhdGlvbkNoYW5nZVN0YXJ0CiAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAqIEBkZXNjcmlwdGlvbgogICAqIEJyb2FkY2FzdGVkIGJlZm9yZSBhIFVSTCB3aWxsIGNoYW5nZS4gVGhpcyBjaGFuZ2UgY2FuIGJlIHByZXZlbnRlZCBieSBjYWxsaW5nCiAgICogYHByZXZlbnREZWZhdWx0YCBtZXRob2Qgb2YgdGhlIGV2ZW50LiBTZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBmb3IgbW9yZQogICAqIGRldGFpbHMgYWJvdXQgZXZlbnQgb2JqZWN0LiBVcG9uIHN1Y2Nlc3NmdWwgY2hhbmdlCiAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiNldmVudHNfJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcyAkbG9jYXRpb25DaGFuZ2VTdWNjZXNzfSBpcyBmaXJlZC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBhbmd1bGFyRXZlbnQgU3ludGhldGljIGV2ZW50IG9iamVjdC4KICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3VXJsIE5ldyBVUkwKICAgKiBAcGFyYW0ge3N0cmluZz19IG9sZFVybCBVUkwgdGhhdCB3YXMgYmVmb3JlIGl0IHdhcyBjaGFuZ2VkLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgZXZlbnQKICAgKiBAbmFtZSAkbG9jYXRpb24jJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcwogICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBCcm9hZGNhc3RlZCBhZnRlciBhIFVSTCB3YXMgY2hhbmdlZC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBhbmd1bGFyRXZlbnQgU3ludGhldGljIGV2ZW50IG9iamVjdC4KICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3VXJsIE5ldyBVUkwKICAgKiBAcGFyYW0ge3N0cmluZz19IG9sZFVybCBVUkwgdGhhdCB3YXMgYmVmb3JlIGl0IHdhcyBjaGFuZ2VkLgogICAqLwoKICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywKICAgICAgZnVuY3Rpb24oICRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHNuaWZmZXIsICAgJHJvb3RFbGVtZW50KSB7CiAgICB2YXIgJGxvY2F0aW9uLAogICAgICAgIExvY2F0aW9uTW9kZSwKICAgICAgICBiYXNlSHJlZiA9ICRicm93c2VyLmJhc2VIcmVmKCksIC8vIGlmIGJhc2VbaHJlZl0gaXMgdW5kZWZpbmVkLCBpdCBkZWZhdWx0cyB0byAnJwogICAgICAgIGluaXRpYWxVcmwgPSAkYnJvd3Nlci51cmwoKSwKICAgICAgICBhcHBCYXNlOwoKICAgIGlmIChodG1sNU1vZGUpIHsKICAgICAgYXBwQmFzZSA9IHNlcnZlckJhc2UoaW5pdGlhbFVybCkgKyAoYmFzZUhyZWYgfHwgJy8nKTsKICAgICAgTG9jYXRpb25Nb2RlID0gJHNuaWZmZXIuaGlzdG9yeSA/IExvY2F0aW9uSHRtbDVVcmwgOiBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybDsKICAgIH0gZWxzZSB7CiAgICAgIGFwcEJhc2UgPSBzdHJpcEhhc2goaW5pdGlhbFVybCk7CiAgICAgIExvY2F0aW9uTW9kZSA9IExvY2F0aW9uSGFzaGJhbmdVcmw7CiAgICB9CiAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25Nb2RlKGFwcEJhc2UsICcjJyArIGhhc2hQcmVmaXgpOwogICAgJGxvY2F0aW9uLiQkcGFyc2UoJGxvY2F0aW9uLiQkcmV3cml0ZShpbml0aWFsVXJsKSk7CgogICAgJHJvb3RFbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIC8vIFRPRE8odm9qdGEpOiByZXdyaXRlIGxpbmsgd2hlbiBvcGVuaW5nIGluIG5ldyB0YWIvd2luZG93IChpbiBsZWdhY3kgYnJvd3NlcikKICAgICAgLy8gY3VycmVudGx5IHdlIG9wZW4gbmljZSB1cmwgbGluayBhbmQgcmVkaXJlY3QgdGhlbgoKICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC53aGljaCA9PSAyKSByZXR1cm47CgogICAgICB2YXIgZWxtID0ganFMaXRlKGV2ZW50LnRhcmdldCk7CgogICAgICAvLyB0cmF2ZXJzZSB0aGUgRE9NIHVwIHRvIGZpbmQgZmlyc3QgQSB0YWcKICAgICAgd2hpbGUgKGxvd2VyY2FzZShlbG1bMF0ubm9kZU5hbWUpICE9PSAnYScpIHsKICAgICAgICAvLyBpZ25vcmUgcmV3cml0aW5nIGlmIG5vIEEgdGFnIChyZWFjaGVkIHJvb3QgZWxlbWVudCwgb3Igbm8gcGFyZW50IC0gcmVtb3ZlZCBmcm9tIGRvY3VtZW50KQogICAgICAgIGlmIChlbG1bMF0gPT09ICRyb290RWxlbWVudFswXSB8fCAhKGVsbSA9IGVsbS5wYXJlbnQoKSlbMF0pIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGFic0hyZWYgPSBlbG0ucHJvcCgnaHJlZicpOwoKICAgICAgaWYgKGlzT2JqZWN0KGFic0hyZWYpICYmIGFic0hyZWYudG9TdHJpbmcoKSA9PT0gJ1tvYmplY3QgU1ZHQW5pbWF0ZWRTdHJpbmddJykgewogICAgICAgIC8vIFNWR0FuaW1hdGVkU3RyaW5nLmFuaW1WYWwgc2hvdWxkIGJlIGlkZW50aWNhbCB0byBTVkdBbmltYXRlZFN0cmluZy5iYXNlVmFsLCB1bmxlc3MgZHVyaW5nCiAgICAgICAgLy8gYW4gYW5pbWF0aW9uLgogICAgICAgIGFic0hyZWYgPSB1cmxSZXNvbHZlKGFic0hyZWYuYW5pbVZhbCkuaHJlZjsKICAgICAgfQoKICAgICAgLy8gTWFrZSByZWxhdGl2ZSBsaW5rcyB3b3JrIGluIEhUTUw1IG1vZGUgZm9yIGxlZ2FjeSBicm93c2VycyAob3IgYXQgbGVhc3QgSUU4ICYgOSkKICAgICAgLy8gVGhlIGhyZWYgc2hvdWxkIGJlIGEgcmVndWxhciB1cmwgZS5nLiAvbGluay9zb21ld2hlcmUgb3IgbGluay9zb21ld2hlcmUgb3IgLi4vc29tZXdoZXJlIG9yCiAgICAgIC8vIHNvbWV3aGVyZSNhbmNob3Igb3IgaHR0cDovL2V4YW1wbGUuY29tL3NvbWV3aGVyZQogICAgICBpZiAoTG9jYXRpb25Nb2RlID09PSBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCkgewogICAgICAgIC8vIGdldCB0aGUgYWN0dWFsIGhyZWYgYXR0cmlidXRlIC0gc2VlCiAgICAgICAgLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2RkMzQ3MTQ4KHY9dnMuODUpLmFzcHgKICAgICAgICB2YXIgaHJlZiA9IGVsbS5hdHRyKCdocmVmJykgfHwgZWxtLmF0dHIoJ3hsaW5rOmhyZWYnKTsKCiAgICAgICAgaWYgKGhyZWYuaW5kZXhPZignOi8vJykgPCAwKSB7ICAgICAgICAgLy8gSWdub3JlIGFic29sdXRlIFVSTHMKICAgICAgICAgIHZhciBwcmVmaXggPSAnIycgKyBoYXNoUHJlZml4OwogICAgICAgICAgaWYgKGhyZWZbMF0gPT0gJy8nKSB7CiAgICAgICAgICAgIC8vIGFic29sdXRlIHBhdGggLSByZXBsYWNlIG9sZCBwYXRoCiAgICAgICAgICAgIGFic0hyZWYgPSBhcHBCYXNlICsgcHJlZml4ICsgaHJlZjsKICAgICAgICAgIH0gZWxzZSBpZiAoaHJlZlswXSA9PSAnIycpIHsKICAgICAgICAgICAgLy8gbG9jYWwgYW5jaG9yCiAgICAgICAgICAgIGFic0hyZWYgPSBhcHBCYXNlICsgcHJlZml4ICsgKCRsb2NhdGlvbi5wYXRoKCkgfHwgJy8nKSArIGhyZWY7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyByZWxhdGl2ZSBwYXRoIC0gam9pbiB3aXRoIGN1cnJlbnQgcGF0aAogICAgICAgICAgICB2YXIgc3RhY2sgPSAkbG9jYXRpb24ucGF0aCgpLnNwbGl0KCIvIiksCiAgICAgICAgICAgICAgcGFydHMgPSBocmVmLnNwbGl0KCIvIik7CiAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaTxwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmIChwYXJ0c1tpXSA9PSAiLiIpCiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICBlbHNlIGlmIChwYXJ0c1tpXSA9PSAiLi4iKQogICAgICAgICAgICAgICAgc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgZWxzZSBpZiAocGFydHNbaV0ubGVuZ3RoKQogICAgICAgICAgICAgICAgc3RhY2sucHVzaChwYXJ0c1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWJzSHJlZiA9IGFwcEJhc2UgKyBwcmVmaXggKyBzdGFjay5qb2luKCcvJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgcmV3cml0dGVuVXJsID0gJGxvY2F0aW9uLiQkcmV3cml0ZShhYnNIcmVmKTsKCiAgICAgIGlmIChhYnNIcmVmICYmICFlbG0uYXR0cigndGFyZ2V0JykgJiYgcmV3cml0dGVuVXJsICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgaWYgKHJld3JpdHRlblVybCAhPSAkYnJvd3Nlci51cmwoKSkgewogICAgICAgICAgLy8gdXBkYXRlIGxvY2F0aW9uIG1hbnVhbGx5CiAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgIC8vIGhhY2sgdG8gd29yayBhcm91bmQgRkY2IGJ1ZyA2ODQyMDggd2hlbiBzY2VuYXJpbyBydW5uZXIgY2xpY2tzIG9uIGxpbmtzCiAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgoKICAgIC8vIHJld3JpdGUgaGFzaGJhbmcgdXJsIDw+IGh0bWw1IHVybAogICAgaWYgKCRsb2NhdGlvbi5hYnNVcmwoKSAhPSBpbml0aWFsVXJsKSB7CiAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIHRydWUpOwogICAgfQoKICAgIC8vIHVwZGF0ZSAkbG9jYXRpb24gd2hlbiAkYnJvd3NlciB1cmwgY2hhbmdlcwogICAgJGJyb3dzZXIub25VcmxDaGFuZ2UoZnVuY3Rpb24obmV3VXJsKSB7CiAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gbmV3VXJsKSB7CiAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG9sZFVybCA9ICRsb2NhdGlvbi5hYnNVcmwoKTsKCiAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShuZXdVcmwpOwogICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCBuZXdVcmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZFVybCkuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShvbGRVcmwpOwogICAgICAgICAgICAkYnJvd3Nlci51cmwob2xkVXJsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIHVwZGF0ZSBicm93c2VyCiAgICB2YXIgY2hhbmdlQ291bnRlciA9IDA7CiAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiAkbG9jYXRpb25XYXRjaCgpIHsKICAgICAgdmFyIG9sZFVybCA9ICRicm93c2VyLnVybCgpOwogICAgICB2YXIgY3VycmVudFJlcGxhY2UgPSAkbG9jYXRpb24uJCRyZXBsYWNlOwoKICAgICAgaWYgKCFjaGFuZ2VDb3VudGVyIHx8IG9sZFVybCAhPSAkbG9jYXRpb24uYWJzVXJsKCkpIHsKICAgICAgICBjaGFuZ2VDb3VudGVyKys7CiAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCAkbG9jYXRpb24uYWJzVXJsKCksIG9sZFVybCkuCiAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShvbGRVcmwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgY3VycmVudFJlcGxhY2UpOwogICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgJGxvY2F0aW9uLiQkcmVwbGFjZSA9IGZhbHNlOwoKICAgICAgcmV0dXJuIGNoYW5nZUNvdW50ZXI7CiAgICB9KTsKCiAgICByZXR1cm4gJGxvY2F0aW9uOwoKICAgIGZ1bmN0aW9uIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKSB7CiAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKTsKICAgIH0KfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkbG9nCiAqIEByZXF1aXJlcyAkd2luZG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTaW1wbGUgc2VydmljZSBmb3IgbG9nZ2luZy4gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzYWZlbHkgd3JpdGVzIHRoZSBtZXNzYWdlCiAqIGludG8gdGhlIGJyb3dzZXIncyBjb25zb2xlIChpZiBwcmVzZW50KS4KICoKICogVGhlIG1haW4gcHVycG9zZSBvZiB0aGlzIHNlcnZpY2UgaXMgdG8gc2ltcGxpZnkgZGVidWdnaW5nIGFuZCB0cm91Ymxlc2hvb3RpbmcuCiAqCiAqIFRoZSBkZWZhdWx0IGlzIHRvIGxvZyBgZGVidWdgIG1lc3NhZ2VzLiBZb3UgY2FuIHVzZQogKiB7QGxpbmsgbmcuJGxvZ1Byb3ZpZGVyIG5nLiRsb2dQcm92aWRlciNkZWJ1Z0VuYWJsZWR9IHRvIGNoYW5nZSB0aGlzLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgZnVuY3Rpb24gTG9nQ3RybCgkc2NvcGUsICRsb2cpIHsKICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAkc2NvcGUubWVzc2FnZSA9ICdIZWxsbyBXb3JsZCEnOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iTG9nQ3RybCI+CiAgICAgICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICAgICAgTWVzc2FnZToKICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJtZXNzYWdlIi8+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy53YXJuKG1lc3NhZ2UpIj53YXJuPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cuaW5mbyhtZXNzYWdlKSI+aW5mbzwvYnV0dG9uPgogICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkbG9nUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqIFVzZSB0aGUgYCRsb2dQcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gbG9ncyBtZXNzYWdlcwogKi8KZnVuY3Rpb24gJExvZ1Byb3ZpZGVyKCl7CiAgdmFyIGRlYnVnID0gdHJ1ZSwKICAgICAgc2VsZiA9IHRoaXM7CgogIC8qKgogICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAqIEBuYW1lICRsb2dQcm92aWRlciNkZWJ1Z0VuYWJsZWQKICAgKiBAZGVzY3JpcHRpb24KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBmbGFnIGVuYWJsZSBvciBkaXNhYmxlIGRlYnVnIGxldmVsIG1lc3NhZ2VzCiAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgKi8KICB0aGlzLmRlYnVnRW5hYmxlZCA9IGZ1bmN0aW9uKGZsYWcpIHsKICAgIGlmIChpc0RlZmluZWQoZmxhZykpIHsKICAgICAgZGVidWcgPSBmbGFnOwogICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZGVidWc7CiAgICB9CiAgfTsKCiAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24oJHdpbmRvdyl7CiAgICByZXR1cm4gewogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkbG9nI2xvZwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYSBsb2cgbWVzc2FnZQogICAgICAgKi8KICAgICAgbG9nOiBjb25zb2xlTG9nKCdsb2cnKSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRsb2cjaW5mbwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYW4gaW5mb3JtYXRpb24gbWVzc2FnZQogICAgICAgKi8KICAgICAgaW5mbzogY29uc29sZUxvZygnaW5mbycpLAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGxvZyN3YXJuCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgKi8KICAgICAgd2FybjogY29uc29sZUxvZygnd2FybicpLAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGxvZyNlcnJvcgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYW4gZXJyb3IgbWVzc2FnZQogICAgICAgKi8KICAgICAgZXJyb3I6IGNvbnNvbGVMb2coJ2Vycm9yJyksCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkbG9nI2RlYnVnCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBXcml0ZSBhIGRlYnVnIG1lc3NhZ2UKICAgICAgICovCiAgICAgIGRlYnVnOiAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBmbiA9IGNvbnNvbGVMb2coJ2RlYnVnJyk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChkZWJ1ZykgewogICAgICAgICAgICBmbi5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0oKSkKICAgIH07CgogICAgZnVuY3Rpb24gZm9ybWF0RXJyb3IoYXJnKSB7CiAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgICAgIGFyZyA9IChhcmcubWVzc2FnZSAmJiBhcmcuc3RhY2suaW5kZXhPZihhcmcubWVzc2FnZSkgPT09IC0xKQogICAgICAgICAgICAgID8gJ0Vycm9yOiAnICsgYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnN0YWNrCiAgICAgICAgICAgICAgOiBhcmcuc3RhY2s7CiAgICAgICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgICAgICBhcmcgPSBhcmcubWVzc2FnZSArICdcbicgKyBhcmcuc291cmNlVVJMICsgJzonICsgYXJnLmxpbmU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhcmc7CiAgICB9CgogICAgZnVuY3Rpb24gY29uc29sZUxvZyh0eXBlKSB7CiAgICAgIHZhciBjb25zb2xlID0gJHdpbmRvdy5jb25zb2xlIHx8IHt9LAogICAgICAgICAgbG9nRm4gPSBjb25zb2xlW3R5cGVdIHx8IGNvbnNvbGUubG9nIHx8IG5vb3AsCiAgICAgICAgICBoYXNBcHBseSA9IGZhbHNlOwoKICAgICAgLy8gTm90ZTogcmVhZGluZyBsb2dGbi5hcHBseSB0aHJvd3MgYW4gZXJyb3IgaW4gSUUxMSBpbiBJRTggZG9jdW1lbnQgbW9kZS4KICAgICAgLy8gVGhlIHJlYXNvbiBiZWhpbmQgdGhpcyBpcyB0aGF0IGNvbnNvbGUubG9nIGhhcyB0eXBlICJvYmplY3QiIGluIElFOC4uLgogICAgICB0cnkgewogICAgICAgIGhhc0FwcGx5ID0gISFsb2dGbi5hcHBseTsKICAgICAgfSBjYXRjaCAoZSkge30KCiAgICAgIGlmIChoYXNBcHBseSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgIGFyZ3MucHVzaChmb3JtYXRFcnJvcihhcmcpKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGxvZ0ZuLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIC8vIHdlIGFyZSBJRSB3aGljaCBlaXRoZXIgZG9lc24ndCBoYXZlIHdpbmRvdy5jb25zb2xlID0+IHRoaXMgaXMgbm9vcCBhbmQgd2UgZG8gbm90aGluZywKICAgICAgLy8gb3Igd2UgYXJlIElFIHdoZXJlIGNvbnNvbGUubG9nIGRvZXNuJ3QgaGF2ZSBhcHBseSBzbyB3ZSBsb2cgYXQgbGVhc3QgZmlyc3QgMiBhcmdzCiAgICAgIHJldHVybiBmdW5jdGlvbihhcmcxLCBhcmcyKSB7CiAgICAgICAgbG9nRm4oYXJnMSwgYXJnMiA9PSBudWxsID8gJycgOiBhcmcyKTsKICAgICAgfTsKICAgIH0KICB9XTsKfQoKdmFyICRwYXJzZU1pbkVyciA9IG1pbkVycignJHBhcnNlJyk7CnZhciBwcm9taXNlV2FybmluZ0NhY2hlID0ge307CnZhciBwcm9taXNlV2FybmluZzsKCi8vIFNhbmRib3hpbmcgQW5ndWxhciBFeHByZXNzaW9ucwovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gQW5ndWxhciBleHByZXNzaW9ucyBhcmUgZ2VuZXJhbGx5IGNvbnNpZGVyZWQgc2FmZSBiZWNhdXNlIHRoZXNlIGV4cHJlc3Npb25zIG9ubHkgaGF2ZSBkaXJlY3QKLy8gYWNjZXNzIHRvICRzY29wZSBhbmQgbG9jYWxzLiBIb3dldmVyLCBvbmUgY2FuIG9idGFpbiB0aGUgYWJpbGl0eSB0byBleGVjdXRlIGFyYml0cmFyeSBKUyBjb2RlIGJ5Ci8vIG9idGFpbmluZyBhIHJlZmVyZW5jZSB0byBuYXRpdmUgSlMgZnVuY3Rpb25zIHN1Y2ggYXMgdGhlIEZ1bmN0aW9uIGNvbnN0cnVjdG9yLgovLwovLyBBcyBhbiBleGFtcGxlLCBjb25zaWRlciB0aGUgZm9sbG93aW5nIEFuZ3VsYXIgZXhwcmVzc2lvbjoKLy8KLy8gICB7fS50b1N0cmluZy5jb25zdHJ1Y3RvcihhbGVydCgiZXZpbCBKUyBjb2RlIikpCi8vCi8vIFdlIHdhbnQgdG8gcHJldmVudCB0aGlzIHR5cGUgb2YgYWNjZXNzLiBGb3IgdGhlIHNha2Ugb2YgcGVyZm9ybWFuY2UsIGR1cmluZyB0aGUgbGV4aW5nIHBoYXNlIHdlCi8vIGRpc2FsbG93IGFueSAiZG90dGVkIiBhY2Nlc3MgdG8gYW55IG1lbWJlciBuYW1lZCAiY29uc3RydWN0b3IiLgovLwovLyBGb3IgcmVmbGVjdGl2ZSBjYWxscyAoYVtiXSkgd2UgY2hlY2sgdGhhdCB0aGUgdmFsdWUgb2YgdGhlIGxvb2t1cCBpcyBub3QgdGhlIEZ1bmN0aW9uIGNvbnN0cnVjdG9yCi8vIHdoaWxlIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24sIHdoaWNoIGlzIGEgc3Ryb25nZXIgYnV0IG1vcmUgZXhwZW5zaXZlIHRlc3QuIFNpbmNlIHJlZmxlY3RpdmUKLy8gY2FsbHMgYXJlIGV4cGVuc2l2ZSBhbnl3YXksIHRoaXMgaXMgbm90IHN1Y2ggYSBiaWcgZGVhbCBjb21wYXJlZCB0byBzdGF0aWMgZGVyZWZlcmVuY2luZy4KLy8KLy8gVGhpcyBzYW5kYm94aW5nIHRlY2huaXF1ZSBpcyBub3QgcGVyZmVjdCBhbmQgZG9lc24ndCBhaW0gdG8gYmUuIFRoZSBnb2FsIGlzIHRvIHByZXZlbnQgZXhwbG9pdHMKLy8gYWdhaW5zdCB0aGUgZXhwcmVzc2lvbiBsYW5ndWFnZSwgYnV0IG5vdCB0byBwcmV2ZW50IGV4cGxvaXRzIHRoYXQgd2VyZSBlbmFibGVkIGJ5IGV4cG9zaW5nCi8vIHNlbnNpdGl2ZSBKYXZhU2NyaXB0IG9yIGJyb3dzZXIgYXBpcyBvbiBTY29wZS4gRXhwb3Npbmcgc3VjaCBvYmplY3RzIG9uIGEgU2NvcGUgaXMgbmV2ZXIgYSBnb29kCi8vIHByYWN0aWNlIGFuZCB0aGVyZWZvcmUgd2UgYXJlIG5vdCBldmVuIHRyeWluZyB0byBwcm90ZWN0IGFnYWluc3QgaW50ZXJhY3Rpb24gd2l0aCBhbiBvYmplY3QKLy8gZXhwbGljaXRseSBleHBvc2VkIGluIHRoaXMgd2F5LgovLwovLyBBIGRldmVsb3BlciBjb3VsZCBmb2lsIHRoZSBuYW1lIGNoZWNrIGJ5IGFsaWFzaW5nIHRoZSBGdW5jdGlvbiBjb25zdHJ1Y3RvciB1bmRlciBhIGRpZmZlcmVudAovLyBuYW1lIG9uIHRoZSBzY29wZS4KLy8KLy8gSW4gZ2VuZXJhbCwgaXQgaXMgbm90IHBvc3NpYmxlIHRvIGFjY2VzcyBhIFdpbmRvdyBvYmplY3QgZnJvbSBhbiBhbmd1bGFyIGV4cHJlc3Npb24gdW5sZXNzIGEKLy8gd2luZG93IG9yIHNvbWUgRE9NIG9iamVjdCB0aGF0IGhhcyBhIHJlZmVyZW5jZSB0byB3aW5kb3cgaXMgcHVibGlzaGVkIG9udG8gYSBTY29wZS4KCmZ1bmN0aW9uIGVuc3VyZVNhZmVNZW1iZXJOYW1lKG5hbWUsIGZ1bGxFeHByZXNzaW9uKSB7CiAgaWYgKG5hbWUgPT09ICJjb25zdHJ1Y3RvciIpIHsKICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY2ZsZCcsCiAgICAgICAgJ1JlZmVyZW5jaW5nICJjb25zdHJ1Y3RvciIgZmllbGQgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICB9CiAgcmV0dXJuIG5hbWU7Cn0KCmZ1bmN0aW9uIGVuc3VyZVNhZmVPYmplY3Qob2JqLCBmdWxsRXhwcmVzc2lvbikgewogIC8vIG5pZnR5IGNoZWNrIGlmIG9iaiBpcyBGdW5jdGlvbiB0aGF0IGlzIGZhc3QgYW5kIHdvcmtzIGFjcm9zcyBpZnJhbWVzIGFuZCBvdGhlciBjb250ZXh0cwogIGlmIChvYmopIHsKICAgIGlmIChvYmouY29uc3RydWN0b3IgPT09IG9iaikgewogICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWNmbicsCiAgICAgICAgICAnUmVmZXJlbmNpbmcgRnVuY3Rpb24gaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfSBlbHNlIGlmICgvLyBpc1dpbmRvdyhvYmopCiAgICAgICAgb2JqLmRvY3VtZW50ICYmIG9iai5sb2NhdGlvbiAmJiBvYmouYWxlcnQgJiYgb2JqLnNldEludGVydmFsKSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY3dpbmRvdycsCiAgICAgICAgICAnUmVmZXJlbmNpbmcgdGhlIFdpbmRvdyBpbiBBbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRpc2FsbG93ZWQhIEV4cHJlc3Npb246IHswfScsCiAgICAgICAgICBmdWxsRXhwcmVzc2lvbik7CiAgICB9IGVsc2UgaWYgKC8vIGlzRWxlbWVudChvYmopCiAgICAgICAgb2JqLmNoaWxkcmVuICYmIChvYmoubm9kZU5hbWUgfHwgKG9iai5wcm9wICYmIG9iai5hdHRyICYmIG9iai5maW5kKSkpIHsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZG9tJywKICAgICAgICAgICdSZWZlcmVuY2luZyBET00gbm9kZXMgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfQogIH0KICByZXR1cm4gb2JqOwp9Cgp2YXIgT1BFUkFUT1JTID0gewogICAgLyoganNoaW50IGJpdHdpc2UgOiBmYWxzZSAqLwogICAgJ251bGwnOmZ1bmN0aW9uKCl7cmV0dXJuIG51bGw7fSwKICAgICd0cnVlJzpmdW5jdGlvbigpe3JldHVybiB0cnVlO30sCiAgICAnZmFsc2UnOmZ1bmN0aW9uKCl7cmV0dXJuIGZhbHNlO30sCiAgICB1bmRlZmluZWQ6bm9vcCwKICAgICcrJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7CiAgICAgIGE9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsKICAgICAgaWYgKGlzRGVmaW5lZChhKSkgewogICAgICAgIGlmIChpc0RlZmluZWQoYikpIHsKICAgICAgICAgIHJldHVybiBhICsgYjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGE7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzRGVmaW5lZChiKT9iOnVuZGVmaW5lZDt9LAogICAgJy0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXsKICAgICAgICAgIGE9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgIHJldHVybiAoaXNEZWZpbmVkKGEpP2E6MCktKGlzRGVmaW5lZChiKT9iOjApOwogICAgICAgIH0sCiAgICAnKic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykqYihzZWxmLCBsb2NhbHMpO30sCiAgICAnLyc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykvYihzZWxmLCBsb2NhbHMpO30sCiAgICAnJSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscyklYihzZWxmLCBsb2NhbHMpO30sCiAgICAnXic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscyleYihzZWxmLCBsb2NhbHMpO30sCiAgICAnPSc6bm9vcCwKICAgICc9PT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSwgYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT09PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJyE9PSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLCBiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpIT09YihzZWxmLCBsb2NhbHMpO30sCiAgICAnPT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICchPSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykhPWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJzwnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPGIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz4nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJzw9JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKTw9YihzZWxmLCBsb2NhbHMpO30sCiAgICAnPj0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPj1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICcmJic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykmJmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJ3x8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKXx8YihzZWxmLCBsb2NhbHMpO30sCiAgICAnJic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykmYihzZWxmLCBsb2NhbHMpO30sCi8vICAgICd8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGF8Yjt9LAogICAgJ3wnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYihzZWxmLCBsb2NhbHMpKHNlbGYsIGxvY2FscywgYShzZWxmLCBsb2NhbHMpKTt9LAogICAgJyEnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSl7cmV0dXJuICFhKHNlbGYsIGxvY2Fscyk7fQp9OwovKiBqc2hpbnQgYml0d2lzZTogdHJ1ZSAqLwp2YXIgRVNDQVBFID0geyJuIjoiXG4iLCAiZiI6IlxmIiwgInIiOiJcciIsICJ0IjoiXHQiLCAidiI6Ilx2IiwgIiciOiInIiwgJyInOiciJ307CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgovKioKICogQGNvbnN0cnVjdG9yCiAqLwp2YXIgTGV4ZXIgPSBmdW5jdGlvbiAob3B0aW9ucykgewogIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7Cn07CgpMZXhlci5wcm90b3R5cGUgPSB7CiAgY29uc3RydWN0b3I6IExleGVyLAoKICBsZXg6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwoKICAgIHRoaXMuaW5kZXggPSAwOwogICAgdGhpcy5jaCA9IHVuZGVmaW5lZDsKICAgIHRoaXMubGFzdENoID0gJzonOyAvLyBjYW4gc3RhcnQgcmVnZXhwCgogICAgdGhpcy50b2tlbnMgPSBbXTsKCiAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgdGhpcy5jaCA9IHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCk7CiAgICAgIGlmICh0aGlzLmlzKCciXCcnKSkgewogICAgICAgIHRoaXMucmVhZFN0cmluZyh0aGlzLmNoKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTnVtYmVyKHRoaXMuY2gpIHx8IHRoaXMuaXMoJy4nKSAmJiB0aGlzLmlzTnVtYmVyKHRoaXMucGVlaygpKSkgewogICAgICAgIHRoaXMucmVhZE51bWJlcigpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNJZGVudCh0aGlzLmNoKSkgewogICAgICAgIHRoaXMucmVhZElkZW50KCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pcygnKCl7fVtdLiw7Oj8nKSkgewogICAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgICAgaW5kZXg6IHRoaXMuaW5kZXgsCiAgICAgICAgICB0ZXh0OiB0aGlzLmNoCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNXaGl0ZXNwYWNlKHRoaXMuY2gpKSB7CiAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjaDIgPSB0aGlzLmNoICsgdGhpcy5wZWVrKCk7CiAgICAgICAgdmFyIGNoMyA9IGNoMiArIHRoaXMucGVlaygyKTsKICAgICAgICB2YXIgZm4gPSBPUEVSQVRPUlNbdGhpcy5jaF07CiAgICAgICAgdmFyIGZuMiA9IE9QRVJBVE9SU1tjaDJdOwogICAgICAgIHZhciBmbjMgPSBPUEVSQVRPUlNbY2gzXTsKICAgICAgICBpZiAoZm4zKSB7CiAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHtpbmRleDogdGhpcy5pbmRleCwgdGV4dDogY2gzLCBmbjogZm4zfSk7CiAgICAgICAgICB0aGlzLmluZGV4ICs9IDM7CiAgICAgICAgfSBlbHNlIGlmIChmbjIpIHsKICAgICAgICAgIHRoaXMudG9rZW5zLnB1c2goe2luZGV4OiB0aGlzLmluZGV4LCB0ZXh0OiBjaDIsIGZuOiBmbjJ9KTsKICAgICAgICAgIHRoaXMuaW5kZXggKz0gMjsKICAgICAgICB9IGVsc2UgaWYgKGZuKSB7CiAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgICAgaW5kZXg6IHRoaXMuaW5kZXgsCiAgICAgICAgICAgIHRleHQ6IHRoaXMuY2gsCiAgICAgICAgICAgIGZuOiBmbgogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmluZGV4ICs9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAnLCB0aGlzLmluZGV4LCB0aGlzLmluZGV4ICsgMSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMubGFzdENoID0gdGhpcy5jaDsKICAgIH0KICAgIHJldHVybiB0aGlzLnRva2VuczsKICB9LAoKICBpczogZnVuY3Rpb24oY2hhcnMpIHsKICAgIHJldHVybiBjaGFycy5pbmRleE9mKHRoaXMuY2gpICE9PSAtMTsKICB9LAoKICB3YXM6IGZ1bmN0aW9uKGNoYXJzKSB7CiAgICByZXR1cm4gY2hhcnMuaW5kZXhPZih0aGlzLmxhc3RDaCkgIT09IC0xOwogIH0sCgogIHBlZWs6IGZ1bmN0aW9uKGkpIHsKICAgIHZhciBudW0gPSBpIHx8IDE7CiAgICByZXR1cm4gKHRoaXMuaW5kZXggKyBudW0gPCB0aGlzLnRleHQubGVuZ3RoKSA/IHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCArIG51bSkgOiBmYWxzZTsKICB9LAoKICBpc051bWJlcjogZnVuY3Rpb24oY2gpIHsKICAgIHJldHVybiAoJzAnIDw9IGNoICYmIGNoIDw9ICc5Jyk7CiAgfSwKCiAgaXNXaGl0ZXNwYWNlOiBmdW5jdGlvbihjaCkgewogICAgLy8gSUUgdHJlYXRzIG5vbi1icmVha2luZyBzcGFjZSBhcyBcdTAwQTAKICAgIHJldHVybiAoY2ggPT09ICcgJyB8fCBjaCA9PT0gJ1xyJyB8fCBjaCA9PT0gJ1x0JyB8fAogICAgICAgICAgICBjaCA9PT0gJ1xuJyB8fCBjaCA9PT0gJ1x2JyB8fCBjaCA9PT0gJ1x1MDBBMCcpOwogIH0sCgogIGlzSWRlbnQ6IGZ1bmN0aW9uKGNoKSB7CiAgICByZXR1cm4gKCdhJyA8PSBjaCAmJiBjaCA8PSAneicgfHwKICAgICAgICAgICAgJ0EnIDw9IGNoICYmIGNoIDw9ICdaJyB8fAogICAgICAgICAgICAnXycgPT09IGNoIHx8IGNoID09PSAnJCcpOwogIH0sCgogIGlzRXhwT3BlcmF0b3I6IGZ1bmN0aW9uKGNoKSB7CiAgICByZXR1cm4gKGNoID09PSAnLScgfHwgY2ggPT09ICcrJyB8fCB0aGlzLmlzTnVtYmVyKGNoKSk7CiAgfSwKCiAgdGhyb3dFcnJvcjogZnVuY3Rpb24oZXJyb3IsIHN0YXJ0LCBlbmQpIHsKICAgIGVuZCA9IGVuZCB8fCB0aGlzLmluZGV4OwogICAgdmFyIGNvbFN0ciA9IChpc0RlZmluZWQoc3RhcnQpCiAgICAgICAgICAgID8gJ3MgJyArIHN0YXJ0ICsgICctJyArIHRoaXMuaW5kZXggKyAnIFsnICsgdGhpcy50ZXh0LnN1YnN0cmluZyhzdGFydCwgZW5kKSArICddJwogICAgICAgICAgICA6ICcgJyArIGVuZCk7CiAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2xleGVycicsICdMZXhlciBFcnJvcjogezB9IGF0IGNvbHVtbnsxfSBpbiBleHByZXNzaW9uIFt7Mn1dLicsCiAgICAgICAgZXJyb3IsIGNvbFN0ciwgdGhpcy50ZXh0KTsKICB9LAoKICByZWFkTnVtYmVyOiBmdW5jdGlvbigpIHsKICAgIHZhciBudW1iZXIgPSAnJzsKICAgIHZhciBzdGFydCA9IHRoaXMuaW5kZXg7CiAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgdmFyIGNoID0gbG93ZXJjYXNlKHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCkpOwogICAgICBpZiAoY2ggPT0gJy4nIHx8IHRoaXMuaXNOdW1iZXIoY2gpKSB7CiAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBwZWVrQ2ggPSB0aGlzLnBlZWsoKTsKICAgICAgICBpZiAoY2ggPT0gJ2UnICYmIHRoaXMuaXNFeHBPcGVyYXRvcihwZWVrQ2gpKSB7CiAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgIHBlZWtDaCAmJiB0aGlzLmlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgICghcGVla0NoIHx8ICF0aGlzLmlzTnVtYmVyKHBlZWtDaCkpICYmCiAgICAgICAgICAgIG51bWJlci5jaGFyQXQobnVtYmVyLmxlbmd0aCAtIDEpID09ICdlJykgewogICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdJbnZhbGlkIGV4cG9uZW50Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmluZGV4Kys7CiAgICB9CiAgICBudW1iZXIgPSAxICogbnVtYmVyOwogICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgIGluZGV4OiBzdGFydCwKICAgICAgdGV4dDogbnVtYmVyLAogICAgICBsaXRlcmFsOiB0cnVlLAogICAgICBjb25zdGFudDogdHJ1ZSwKICAgICAgZm46IGZ1bmN0aW9uKCkgeyByZXR1cm4gbnVtYmVyOyB9CiAgICB9KTsKICB9LAoKICByZWFkSWRlbnQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIHBhcnNlciA9IHRoaXM7CgogICAgdmFyIGlkZW50ID0gJyc7CiAgICB2YXIgc3RhcnQgPSB0aGlzLmluZGV4OwoKICAgIHZhciBsYXN0RG90LCBwZWVrSW5kZXgsIG1ldGhvZE5hbWUsIGNoOwoKICAgIHdoaWxlICh0aGlzLmluZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICBjaCA9IHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCk7CiAgICAgIGlmIChjaCA9PT0gJy4nIHx8IHRoaXMuaXNJZGVudChjaCkgfHwgdGhpcy5pc051bWJlcihjaCkpIHsKICAgICAgICBpZiAoY2ggPT09ICcuJykgbGFzdERvdCA9IHRoaXMuaW5kZXg7CiAgICAgICAgaWRlbnQgKz0gY2g7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgdGhpcy5pbmRleCsrOwogICAgfQoKICAgIC8vY2hlY2sgaWYgdGhpcyBpcyBub3QgYSBtZXRob2QgaW52b2NhdGlvbiBhbmQgaWYgaXQgaXMgYmFjayBvdXQgdG8gbGFzdCBkb3QKICAgIGlmIChsYXN0RG90KSB7CiAgICAgIHBlZWtJbmRleCA9IHRoaXMuaW5kZXg7CiAgICAgIHdoaWxlIChwZWVrSW5kZXggPCB0aGlzLnRleHQubGVuZ3RoKSB7CiAgICAgICAgY2ggPSB0aGlzLnRleHQuY2hhckF0KHBlZWtJbmRleCk7CiAgICAgICAgaWYgKGNoID09PSAnKCcpIHsKICAgICAgICAgIG1ldGhvZE5hbWUgPSBpZGVudC5zdWJzdHIobGFzdERvdCAtIHN0YXJ0ICsgMSk7CiAgICAgICAgICBpZGVudCA9IGlkZW50LnN1YnN0cigwLCBsYXN0RG90IC0gc3RhcnQpOwogICAgICAgICAgdGhpcy5pbmRleCA9IHBlZWtJbmRleDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5pc1doaXRlc3BhY2UoY2gpKSB7CiAgICAgICAgICBwZWVrSW5kZXgrKzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CgoKICAgIHZhciB0b2tlbiA9IHsKICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICB0ZXh0OiBpZGVudAogICAgfTsKCiAgICAvLyBPUEVSQVRPUlMgaXMgb3VyIG93biBvYmplY3Qgc28gd2UgZG9uJ3QgbmVlZCB0byB1c2Ugc3BlY2lhbCBoYXNPd25Qcm9wZXJ0eUZuCiAgICBpZiAoT1BFUkFUT1JTLmhhc093blByb3BlcnR5KGlkZW50KSkgewogICAgICB0b2tlbi5mbiA9IE9QRVJBVE9SU1tpZGVudF07CiAgICAgIHRva2VuLmxpdGVyYWwgPSB0cnVlOwogICAgICB0b2tlbi5jb25zdGFudCA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oaWRlbnQsIHRoaXMub3B0aW9ucywgdGhpcy50ZXh0KTsKICAgICAgdG9rZW4uZm4gPSBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgcmV0dXJuIChnZXR0ZXIoc2VsZiwgbG9jYWxzKSk7CiAgICAgIH0sIHsKICAgICAgICBhc3NpZ246IGZ1bmN0aW9uKHNlbGYsIHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gc2V0dGVyKHNlbGYsIGlkZW50LCB2YWx1ZSwgcGFyc2VyLnRleHQsIHBhcnNlci5vcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIHRoaXMudG9rZW5zLnB1c2godG9rZW4pOwoKICAgIGlmIChtZXRob2ROYW1lKSB7CiAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgIGluZGV4Omxhc3REb3QsCiAgICAgICAgdGV4dDogJy4nCiAgICAgIH0pOwogICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICBpbmRleDogbGFzdERvdCArIDEsCiAgICAgICAgdGV4dDogbWV0aG9kTmFtZQogICAgICB9KTsKICAgIH0KICB9LAoKICByZWFkU3RyaW5nOiBmdW5jdGlvbihxdW90ZSkgewogICAgdmFyIHN0YXJ0ID0gdGhpcy5pbmRleDsKICAgIHRoaXMuaW5kZXgrKzsKICAgIHZhciBzdHJpbmcgPSAnJzsKICAgIHZhciByYXdTdHJpbmcgPSBxdW90ZTsKICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgIHdoaWxlICh0aGlzLmluZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICB2YXIgY2ggPSB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpOwogICAgICByYXdTdHJpbmcgKz0gY2g7CiAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICBpZiAoY2ggPT09ICd1JykgewogICAgICAgICAgdmFyIGhleCA9IHRoaXMudGV4dC5zdWJzdHJpbmcodGhpcy5pbmRleCArIDEsIHRoaXMuaW5kZXggKyA1KTsKICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0ludmFsaWQgdW5pY29kZSBlc2NhcGUgW1xcdScgKyBoZXggKyAnXScpOwogICAgICAgICAgdGhpcy5pbmRleCArPSA0OwogICAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQoaGV4LCAxNikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgIGlmIChyZXApIHsKICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXNjYXBlID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICdcXCcpIHsKICAgICAgICBlc2NhcGUgPSB0cnVlOwogICAgICB9IGVsc2UgaWYgKGNoID09PSBxdW90ZSkgewogICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgIHRleHQ6IHJhd1N0cmluZywKICAgICAgICAgIHN0cmluZzogc3RyaW5nLAogICAgICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgICAgIGNvbnN0YW50OiB0cnVlLAogICAgICAgICAgZm46IGZ1bmN0aW9uKCkgeyByZXR1cm4gc3RyaW5nOyB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgfQogICAgICB0aGlzLmluZGV4Kys7CiAgICB9CiAgICB0aGlzLnRocm93RXJyb3IoJ1VudGVybWluYXRlZCBxdW90ZScsIHN0YXJ0KTsKICB9Cn07CgoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKi8KdmFyIFBhcnNlciA9IGZ1bmN0aW9uIChsZXhlciwgJGZpbHRlciwgb3B0aW9ucykgewogIHRoaXMubGV4ZXIgPSBsZXhlcjsKICB0aGlzLiRmaWx0ZXIgPSAkZmlsdGVyOwogIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7Cn07CgpQYXJzZXIuWkVSTyA9IGV4dGVuZChmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIDA7Cn0sIHsKICBjb25zdGFudDogdHJ1ZQp9KTsKClBhcnNlci5wcm90b3R5cGUgPSB7CiAgY29uc3RydWN0b3I6IFBhcnNlciwKCiAgcGFyc2U6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwoKICAgIHRoaXMudG9rZW5zID0gdGhpcy5sZXhlci5sZXgodGV4dCk7CgogICAgdmFyIHZhbHVlID0gdGhpcy5zdGF0ZW1lbnRzKCk7CgogICAgaWYgKHRoaXMudG9rZW5zLmxlbmd0aCAhPT0gMCkgewogICAgICB0aGlzLnRocm93RXJyb3IoJ2lzIGFuIHVuZXhwZWN0ZWQgdG9rZW4nLCB0aGlzLnRva2Vuc1swXSk7CiAgICB9CgogICAgdmFsdWUubGl0ZXJhbCA9ICEhdmFsdWUubGl0ZXJhbDsKICAgIHZhbHVlLmNvbnN0YW50ID0gISF2YWx1ZS5jb25zdGFudDsKCiAgICByZXR1cm4gdmFsdWU7CiAgfSwKCiAgcHJpbWFyeTogZnVuY3Rpb24gKCkgewogICAgdmFyIHByaW1hcnk7CiAgICBpZiAodGhpcy5leHBlY3QoJygnKSkgewogICAgICBwcmltYXJ5ID0gdGhpcy5maWx0ZXJDaGFpbigpOwogICAgICB0aGlzLmNvbnN1bWUoJyknKTsKICAgIH0gZWxzZSBpZiAodGhpcy5leHBlY3QoJ1snKSkgewogICAgICBwcmltYXJ5ID0gdGhpcy5hcnJheURlY2xhcmF0aW9uKCk7CiAgICB9IGVsc2UgaWYgKHRoaXMuZXhwZWN0KCd7JykpIHsKICAgICAgcHJpbWFyeSA9IHRoaXMub2JqZWN0KCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgdG9rZW4gPSB0aGlzLmV4cGVjdCgpOwogICAgICBwcmltYXJ5ID0gdG9rZW4uZm47CiAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgIHRoaXMudGhyb3dFcnJvcignbm90IGEgcHJpbWFyeSBleHByZXNzaW9uJywgdG9rZW4pOwogICAgICB9CiAgICAgIHByaW1hcnkubGl0ZXJhbCA9ICEhdG9rZW4ubGl0ZXJhbDsKICAgICAgcHJpbWFyeS5jb25zdGFudCA9ICEhdG9rZW4uY29uc3RhbnQ7CiAgICB9CgogICAgdmFyIG5leHQsIGNvbnRleHQ7CiAgICB3aGlsZSAoKG5leHQgPSB0aGlzLmV4cGVjdCgnKCcsICdbJywgJy4nKSkpIHsKICAgICAgaWYgKG5leHQudGV4dCA9PT0gJygnKSB7CiAgICAgICAgcHJpbWFyeSA9IHRoaXMuZnVuY3Rpb25DYWxsKHByaW1hcnksIGNvbnRleHQpOwogICAgICAgIGNvbnRleHQgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgcHJpbWFyeSA9IHRoaXMub2JqZWN0SW5kZXgocHJpbWFyeSk7CiAgICAgIH0gZWxzZSBpZiAobmV4dC50ZXh0ID09PSAnLicpIHsKICAgICAgICBjb250ZXh0ID0gcHJpbWFyeTsKICAgICAgICBwcmltYXJ5ID0gdGhpcy5maWVsZEFjY2VzcyhwcmltYXJ5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0lNUE9TU0lCTEUnKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHByaW1hcnk7CiAgfSwKCiAgdGhyb3dFcnJvcjogZnVuY3Rpb24obXNnLCB0b2tlbikgewogICAgdGhyb3cgJHBhcnNlTWluRXJyKCdzeW50YXgnLAogICAgICAgICdTeW50YXggRXJyb3I6IFRva2VuIFwnezB9XCcgezF9IGF0IGNvbHVtbiB7Mn0gb2YgdGhlIGV4cHJlc3Npb24gW3szfV0gc3RhcnRpbmcgYXQgW3s0fV0uJywKICAgICAgICAgIHRva2VuLnRleHQsIG1zZywgKHRva2VuLmluZGV4ICsgMSksIHRoaXMudGV4dCwgdGhpcy50ZXh0LnN1YnN0cmluZyh0b2tlbi5pbmRleCkpOwogIH0sCgogIHBlZWtUb2tlbjogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy50b2tlbnMubGVuZ3RoID09PSAwKQogICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ3Vlb2UnLCAnVW5leHBlY3RlZCBlbmQgb2YgZXhwcmVzc2lvbjogezB9JywgdGhpcy50ZXh0KTsKICAgIHJldHVybiB0aGlzLnRva2Vuc1swXTsKICB9LAoKICBwZWVrOiBmdW5jdGlvbihlMSwgZTIsIGUzLCBlNCkgewogICAgaWYgKHRoaXMudG9rZW5zLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIHRva2VuID0gdGhpcy50b2tlbnNbMF07CiAgICAgIHZhciB0ID0gdG9rZW4udGV4dDsKICAgICAgaWYgKHQgPT09IGUxIHx8IHQgPT09IGUyIHx8IHQgPT09IGUzIHx8IHQgPT09IGU0IHx8CiAgICAgICAgICAoIWUxICYmICFlMiAmJiAhZTMgJiYgIWU0KSkgewogICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIGV4cGVjdDogZnVuY3Rpb24oZTEsIGUyLCBlMywgZTQpewogICAgdmFyIHRva2VuID0gdGhpcy5wZWVrKGUxLCBlMiwgZTMsIGU0KTsKICAgIGlmICh0b2tlbikgewogICAgICB0aGlzLnRva2Vucy5zaGlmdCgpOwogICAgICByZXR1cm4gdG9rZW47CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgY29uc3VtZTogZnVuY3Rpb24oZTEpewogICAgaWYgKCF0aGlzLmV4cGVjdChlMSkpIHsKICAgICAgdGhpcy50aHJvd0Vycm9yKCdpcyB1bmV4cGVjdGVkLCBleHBlY3RpbmcgWycgKyBlMSArICddJywgdGhpcy5wZWVrKCkpOwogICAgfQogIH0sCgogIHVuYXJ5Rm46IGZ1bmN0aW9uKGZuLCByaWdodCkgewogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbihzZWxmLCBsb2NhbHMpIHsKICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgcmlnaHQpOwogICAgfSwgewogICAgICBjb25zdGFudDpyaWdodC5jb25zdGFudAogICAgfSk7CiAgfSwKCiAgdGVybmFyeUZuOiBmdW5jdGlvbihsZWZ0LCBtaWRkbGUsIHJpZ2h0KXsKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKXsKICAgICAgcmV0dXJuIGxlZnQoc2VsZiwgbG9jYWxzKSA/IG1pZGRsZShzZWxmLCBsb2NhbHMpIDogcmlnaHQoc2VsZiwgbG9jYWxzKTsKICAgIH0sIHsKICAgICAgY29uc3RhbnQ6IGxlZnQuY29uc3RhbnQgJiYgbWlkZGxlLmNvbnN0YW50ICYmIHJpZ2h0LmNvbnN0YW50CiAgICB9KTsKICB9LAoKICBiaW5hcnlGbjogZnVuY3Rpb24obGVmdCwgZm4sIHJpZ2h0KSB7CiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCBsZWZ0LCByaWdodCk7CiAgICB9LCB7CiAgICAgIGNvbnN0YW50OmxlZnQuY29uc3RhbnQgJiYgcmlnaHQuY29uc3RhbnQKICAgIH0pOwogIH0sCgogIHN0YXRlbWVudHM6IGZ1bmN0aW9uKCkgewogICAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmICh0aGlzLnRva2Vucy5sZW5ndGggPiAwICYmICF0aGlzLnBlZWsoJ30nLCAnKScsICc7JywgJ10nKSkKICAgICAgICBzdGF0ZW1lbnRzLnB1c2godGhpcy5maWx0ZXJDaGFpbigpKTsKICAgICAgaWYgKCF0aGlzLmV4cGVjdCgnOycpKSB7CiAgICAgICAgLy8gb3B0aW1pemUgZm9yIHRoZSBjb21tb24gY2FzZSB3aGVyZSB0aGVyZSBpcyBvbmx5IG9uZSBzdGF0ZW1lbnQuCiAgICAgICAgLy8gVE9ETyhzaXplKTogbWF5YmUgd2Ugc2hvdWxkIG5vdCBzdXBwb3J0IG11bHRpcGxlIHN0YXRlbWVudHM/CiAgICAgICAgcmV0dXJuIChzdGF0ZW1lbnRzLmxlbmd0aCA9PT0gMSkKICAgICAgICAgICAgPyBzdGF0ZW1lbnRzWzBdCiAgICAgICAgICAgIDogZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgfTsKICAgICAgfQogICAgfQogIH0sCgogIGZpbHRlckNoYWluOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJ3wnKSkpIHsKICAgICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5maWx0ZXIoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgIH0KICAgIH0KICB9LAoKICBmaWx0ZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIHRva2VuID0gdGhpcy5leHBlY3QoKTsKICAgIHZhciBmbiA9IHRoaXMuJGZpbHRlcih0b2tlbi50ZXh0KTsKICAgIHZhciBhcmdzRm4gPSBbXTsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnOicpKSkgewogICAgICAgIGFyZ3NGbi5wdXNoKHRoaXMuZXhwcmVzc2lvbigpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZm5JbnZva2UgPSBmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGlucHV0KSB7CiAgICAgICAgICB2YXIgYXJncyA9IFtpbnB1dF07CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGZuSW52b2tlOwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9LAoKICBleHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFzc2lnbm1lbnQoKTsKICB9LAoKICBhc3NpZ25tZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy50ZXJuYXJ5KCk7CiAgICB2YXIgcmlnaHQ7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJz0nKSkpIHsKICAgICAgaWYgKCFsZWZ0LmFzc2lnbikgewogICAgICAgIHRoaXMudGhyb3dFcnJvcignaW1wbGllcyBhc3NpZ25tZW50IGJ1dCBbJyArCiAgICAgICAgICAgIHRoaXMudGV4dC5zdWJzdHJpbmcoMCwgdG9rZW4uaW5kZXgpICsgJ10gY2FuIG5vdCBiZSBhc3NpZ25lZCB0bycsIHRva2VuKTsKICAgICAgfQogICAgICByaWdodCA9IHRoaXMudGVybmFyeSgpOwogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzY29wZSwgcmlnaHQoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICB0ZXJuYXJ5OiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5sb2dpY2FsT1IoKTsKICAgIHZhciBtaWRkbGU7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJz8nKSkpIHsKICAgICAgbWlkZGxlID0gdGhpcy50ZXJuYXJ5KCk7CiAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnOicpKSkgewogICAgICAgIHJldHVybiB0aGlzLnRlcm5hcnlGbihsZWZ0LCBtaWRkbGUsIHRoaXMudGVybmFyeSgpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2V4cGVjdGVkIDonLCB0b2tlbik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBsZWZ0OwogICAgfQogIH0sCgogIGxvZ2ljYWxPUjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMubG9naWNhbEFORCgpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCd8fCcpKSkgewogICAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLmxvZ2ljYWxBTkQoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgIH0KICAgIH0KICB9LAoKICBsb2dpY2FsQU5EOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5lcXVhbGl0eSgpOwogICAgdmFyIHRva2VuOwogICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCcmJicpKSkgewogICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5sb2dpY2FsQU5EKCkpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgZXF1YWxpdHk6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlZnQgPSB0aGlzLnJlbGF0aW9uYWwoKTsKICAgIHZhciB0b2tlbjsKICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnPT0nLCchPScsJz09PScsJyE9PScpKSkgewogICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5lcXVhbGl0eSgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIHJlbGF0aW9uYWw6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlZnQgPSB0aGlzLmFkZGl0aXZlKCk7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJzwnLCAnPicsICc8PScsICc+PScpKSkgewogICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5yZWxhdGlvbmFsKCkpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgYWRkaXRpdmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlZnQgPSB0aGlzLm11bHRpcGxpY2F0aXZlKCk7CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSAoKHRva2VuID0gdGhpcy5leHBlY3QoJysnLCctJykpKSB7CiAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLm11bHRpcGxpY2F0aXZlKCkpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgbXVsdGlwbGljYXRpdmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlZnQgPSB0aGlzLnVuYXJ5KCk7CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSAoKHRva2VuID0gdGhpcy5leHBlY3QoJyonLCcvJywnJScpKSkgewogICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy51bmFyeSgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIHVuYXJ5OiBmdW5jdGlvbigpIHsKICAgIHZhciB0b2tlbjsKICAgIGlmICh0aGlzLmV4cGVjdCgnKycpKSB7CiAgICAgIHJldHVybiB0aGlzLnByaW1hcnkoKTsKICAgIH0gZWxzZSBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJy0nKSkpIHsKICAgICAgcmV0dXJuIHRoaXMuYmluYXJ5Rm4oUGFyc2VyLlpFUk8sIHRva2VuLmZuLCB0aGlzLnVuYXJ5KCkpOwogICAgfSBlbHNlIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnIScpKSkgewogICAgICByZXR1cm4gdGhpcy51bmFyeUZuKHRva2VuLmZuLCB0aGlzLnVuYXJ5KCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMucHJpbWFyeSgpOwogICAgfQogIH0sCgogIGZpZWxkQWNjZXNzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgIHZhciBwYXJzZXIgPSB0aGlzOwogICAgdmFyIGZpZWxkID0gdGhpcy5leHBlY3QoKS50ZXh0OwogICAgdmFyIGdldHRlciA9IGdldHRlckZuKGZpZWxkLCB0aGlzLm9wdGlvbnMsIHRoaXMudGV4dCk7CgogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbihzY29wZSwgbG9jYWxzLCBzZWxmKSB7CiAgICAgIHJldHVybiBnZXR0ZXIoc2VsZiB8fCBvYmplY3Qoc2NvcGUsIGxvY2FscykpOwogICAgfSwgewogICAgICBhc3NpZ246IGZ1bmN0aW9uKHNjb3BlLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgcmV0dXJuIHNldHRlcihvYmplY3Qoc2NvcGUsIGxvY2FscyksIGZpZWxkLCB2YWx1ZSwgcGFyc2VyLnRleHQsIHBhcnNlci5vcHRpb25zKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgb2JqZWN0SW5kZXg6IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHBhcnNlciA9IHRoaXM7CgogICAgdmFyIGluZGV4Rm4gPSB0aGlzLmV4cHJlc3Npb24oKTsKICAgIHRoaXMuY29uc3VtZSgnXScpOwoKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgIHZhciBvID0gb2JqKHNlbGYsIGxvY2FscyksCiAgICAgICAgICBpID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgdiwgcDsKCiAgICAgIGlmICghbykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgdiA9IGVuc3VyZVNhZmVPYmplY3Qob1tpXSwgcGFyc2VyLnRleHQpOwogICAgICBpZiAodiAmJiB2LnRoZW4gJiYgcGFyc2VyLm9wdGlvbnMudW53cmFwUHJvbWlzZXMpIHsKICAgICAgICBwID0gdjsKICAgICAgICBpZiAoISgnJCR2JyBpbiB2KSkgewogICAgICAgICAgcC4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24odmFsKSB7IHAuJCR2ID0gdmFsOyB9KTsKICAgICAgICB9CiAgICAgICAgdiA9IHYuJCR2OwogICAgICB9CiAgICAgIHJldHVybiB2OwogICAgfSwgewogICAgICBhc3NpZ246IGZ1bmN0aW9uKHNlbGYsIHZhbHVlLCBsb2NhbHMpIHsKICAgICAgICB2YXIga2V5ID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpOwogICAgICAgIC8vIHByZXZlbnQgb3ZlcndyaXRpbmcgb2YgRnVuY3Rpb24uY29uc3RydWN0b3Igd2hpY2ggd291bGQgYnJlYWsgZW5zdXJlU2FmZU9iamVjdCBjaGVjawogICAgICAgIHZhciBzYWZlID0gZW5zdXJlU2FmZU9iamVjdChvYmooc2VsZiwgbG9jYWxzKSwgcGFyc2VyLnRleHQpOwogICAgICAgIHJldHVybiBzYWZlW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgZnVuY3Rpb25DYWxsOiBmdW5jdGlvbihmbiwgY29udGV4dEdldHRlcikgewogICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgaWYgKHRoaXMucGVla1Rva2VuKCkudGV4dCAhPT0gJyknKSB7CiAgICAgIGRvIHsKICAgICAgICBhcmdzRm4ucHVzaCh0aGlzLmV4cHJlc3Npb24oKSk7CiAgICAgIH0gd2hpbGUgKHRoaXMuZXhwZWN0KCcsJykpOwogICAgfQogICAgdGhpcy5jb25zdW1lKCcpJyk7CgogICAgdmFyIHBhcnNlciA9IHRoaXM7CgogICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgdmFyIGNvbnRleHQgPSBjb250ZXh0R2V0dGVyID8gY29udGV4dEdldHRlcihzY29wZSwgbG9jYWxzKSA6IHNjb3BlOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzRm4ubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNjb3BlLCBsb2NhbHMpKTsKICAgICAgfQogICAgICB2YXIgZm5QdHIgPSBmbihzY29wZSwgbG9jYWxzLCBjb250ZXh0KSB8fCBub29wOwoKICAgICAgZW5zdXJlU2FmZU9iamVjdChjb250ZXh0LCBwYXJzZXIudGV4dCk7CiAgICAgIGVuc3VyZVNhZmVPYmplY3QoZm5QdHIsIHBhcnNlci50ZXh0KTsKCiAgICAgIC8vIElFIHN0dXBpZGl0eSEgKElFIGRvZXNuJ3QgaGF2ZSBhcHBseSBmb3Igc29tZSBuYXRpdmUgZnVuY3Rpb25zKQogICAgICB2YXIgdiA9IGZuUHRyLmFwcGx5CiAgICAgICAgICAgID8gZm5QdHIuYXBwbHkoY29udGV4dCwgYXJncykKICAgICAgICAgICAgOiBmblB0cihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKCiAgICAgIHJldHVybiBlbnN1cmVTYWZlT2JqZWN0KHYsIHBhcnNlci50ZXh0KTsKICAgIH07CiAgfSwKCiAgLy8gVGhpcyBpcyB1c2VkIHdpdGgganNvbiBhcnJheSBkZWNsYXJhdGlvbgogIGFycmF5RGVjbGFyYXRpb246IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlbGVtZW50Rm5zID0gW107CiAgICB2YXIgYWxsQ29uc3RhbnQgPSB0cnVlOwogICAgaWYgKHRoaXMucGVla1Rva2VuKCkudGV4dCAhPT0gJ10nKSB7CiAgICAgIGRvIHsKICAgICAgICBpZiAodGhpcy5wZWVrKCddJykpIHsKICAgICAgICAgIC8vIFN1cHBvcnQgdHJhaWxpbmcgY29tbWFzIHBlciBFUzUuMS4KICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICB2YXIgZWxlbWVudEZuID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICAgICAgZWxlbWVudEZucy5wdXNoKGVsZW1lbnRGbik7CiAgICAgICAgaWYgKCFlbGVtZW50Rm4uY29uc3RhbnQpIHsKICAgICAgICAgIGFsbENvbnN0YW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9IHdoaWxlICh0aGlzLmV4cGVjdCgnLCcpKTsKICAgIH0KICAgIHRoaXMuY29uc3VtZSgnXScpOwoKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW1lbnRGbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcnJheS5wdXNoKGVsZW1lbnRGbnNbaV0oc2VsZiwgbG9jYWxzKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5OwogICAgfSwgewogICAgICBsaXRlcmFsOiB0cnVlLAogICAgICBjb25zdGFudDogYWxsQ29uc3RhbnQKICAgIH0pOwogIH0sCgogIG9iamVjdDogZnVuY3Rpb24gKCkgewogICAgdmFyIGtleVZhbHVlcyA9IFtdOwogICAgdmFyIGFsbENvbnN0YW50ID0gdHJ1ZTsKICAgIGlmICh0aGlzLnBlZWtUb2tlbigpLnRleHQgIT09ICd9JykgewogICAgICBkbyB7CiAgICAgICAgaWYgKHRoaXMucGVlaygnfScpKSB7CiAgICAgICAgICAvLyBTdXBwb3J0IHRyYWlsaW5nIGNvbW1hcyBwZXIgRVM1LjEuCiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgdmFyIHRva2VuID0gdGhpcy5leHBlY3QoKSwKICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICB0aGlzLmNvbnN1bWUoJzonKTsKICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmV4cHJlc3Npb24oKTsKICAgICAgICBrZXlWYWx1ZXMucHVzaCh7a2V5OiBrZXksIHZhbHVlOiB2YWx1ZX0pOwogICAgICAgIGlmICghdmFsdWUuY29uc3RhbnQpIHsKICAgICAgICAgIGFsbENvbnN0YW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9IHdoaWxlICh0aGlzLmV4cGVjdCgnLCcpKTsKICAgIH0KICAgIHRoaXMuY29uc3VtZSgnfScpOwoKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgIHZhciBvYmplY3QgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIga2V5VmFsdWUgPSBrZXlWYWx1ZXNbaV07CiAgICAgICAgb2JqZWN0W2tleVZhbHVlLmtleV0gPSBrZXlWYWx1ZS52YWx1ZShzZWxmLCBsb2NhbHMpOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9LCB7CiAgICAgIGxpdGVyYWw6IHRydWUsCiAgICAgIGNvbnN0YW50OiBhbGxDb25zdGFudAogICAgfSk7CiAgfQp9OwoKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIFBhcnNlciBoZWxwZXIgZnVuY3Rpb25zCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgpmdW5jdGlvbiBzZXR0ZXIob2JqLCBwYXRoLCBzZXRWYWx1ZSwgZnVsbEV4cCwgb3B0aW9ucykgewogIC8vbmVlZGVkPwogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICB2YXIgZWxlbWVudCA9IHBhdGguc3BsaXQoJy4nKSwga2V5OwogIGZvciAodmFyIGkgPSAwOyBlbGVtZW50Lmxlbmd0aCA+IDE7IGkrKykgewogICAga2V5ID0gZW5zdXJlU2FmZU1lbWJlck5hbWUoZWxlbWVudC5zaGlmdCgpLCBmdWxsRXhwKTsKICAgIHZhciBwcm9wZXJ0eU9iaiA9IG9ialtrZXldOwogICAgaWYgKCFwcm9wZXJ0eU9iaikgewogICAgICBwcm9wZXJ0eU9iaiA9IHt9OwogICAgICBvYmpba2V5XSA9IHByb3BlcnR5T2JqOwogICAgfQogICAgb2JqID0gcHJvcGVydHlPYmo7CiAgICBpZiAob2JqLnRoZW4gJiYgb3B0aW9ucy51bndyYXBQcm9taXNlcykgewogICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgaWYgKCEoIiQkdiIgaW4gb2JqKSkgewogICAgICAgIChmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsgfQogICAgICAgICkob2JqKTsKICAgICAgfQogICAgICBpZiAob2JqLiQkdiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgb2JqLiQkdiA9IHt9OwogICAgICB9CiAgICAgIG9iaiA9IG9iai4kJHY7CiAgICB9CiAgfQogIGtleSA9IGVuc3VyZVNhZmVNZW1iZXJOYW1lKGVsZW1lbnQuc2hpZnQoKSwgZnVsbEV4cCk7CiAgb2JqW2tleV0gPSBzZXRWYWx1ZTsKICByZXR1cm4gc2V0VmFsdWU7Cn0KCnZhciBnZXR0ZXJGbkNhY2hlID0ge307CgovKioKICogSW1wbGVtZW50YXRpb24gb2YgdGhlICJCbGFjayBIb2xlIiB2YXJpYW50IGZyb206CiAqIC0gaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhcmpzLXBhcnNlLWdldHRlci80CiAqIC0gaHR0cDovL2pzcGVyZi5jb20vcGF0aC1ldmFsdWF0aW9uLXNpbXBsaWZpZWQvNwogKi8KZnVuY3Rpb24gY3NwU2FmZUdldHRlckZuKGtleTAsIGtleTEsIGtleTIsIGtleTMsIGtleTQsIGZ1bGxFeHAsIG9wdGlvbnMpIHsKICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkwLCBmdWxsRXhwKTsKICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkxLCBmdWxsRXhwKTsKICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkyLCBmdWxsRXhwKTsKICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkzLCBmdWxsRXhwKTsKICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXk0LCBmdWxsRXhwKTsKCiAgcmV0dXJuICFvcHRpb25zLnVud3JhcFByb21pc2VzCiAgICAgID8gZnVuY3Rpb24gY3NwU2FmZUdldHRlcihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICB2YXIgcGF0aFZhbCA9IChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlOwoKICAgICAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiBwYXRoVmFsOwogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MF07CgogICAgICAgICAgaWYgKCFrZXkxKSByZXR1cm4gcGF0aFZhbDsKICAgICAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkxXTsKCiAgICAgICAgICBpZiAoIWtleTIpIHJldHVybiBwYXRoVmFsOwogICAgICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwoKICAgICAgICAgIGlmICgha2V5MykgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5M107CgogICAgICAgICAgaWYgKCFrZXk0KSByZXR1cm4gcGF0aFZhbDsKICAgICAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXk0XTsKCiAgICAgICAgICByZXR1cm4gcGF0aFZhbDsKICAgICAgICB9CiAgICAgIDogZnVuY3Rpb24gY3NwU2FmZVByb21pc2VFbmFibGVkR2V0dGVyKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGUsCiAgICAgICAgICAgICAgcHJvbWlzZTsKCiAgICAgICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkwXTsKICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFrZXkxKSByZXR1cm4gcGF0aFZhbDsKICAgICAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkxXTsKICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFrZXkyKSByZXR1cm4gcGF0aFZhbDsKICAgICAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkyXTsKICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFrZXkzKSByZXR1cm4gcGF0aFZhbDsKICAgICAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkzXTsKICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFrZXk0KSByZXR1cm4gcGF0aFZhbDsKICAgICAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXk0XTsKICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGF0aFZhbDsKICAgICAgICB9Owp9CgpmdW5jdGlvbiBzaW1wbGVHZXR0ZXJGbjEoa2V5MCwgZnVsbEV4cCkgewogIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTAsIGZ1bGxFeHApOwoKICByZXR1cm4gZnVuY3Rpb24gc2ltcGxlR2V0dGVyRm4xKHNjb3BlLCBsb2NhbHMpIHsKICAgIGlmIChzY29wZSA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgcmV0dXJuICgobG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkwKSkgPyBsb2NhbHMgOiBzY29wZSlba2V5MF07CiAgfTsKfQoKZnVuY3Rpb24gc2ltcGxlR2V0dGVyRm4yKGtleTAsIGtleTEsIGZ1bGxFeHApIHsKICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkwLCBmdWxsRXhwKTsKICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkxLCBmdWxsRXhwKTsKCiAgcmV0dXJuIGZ1bmN0aW9uIHNpbXBsZUdldHRlckZuMihzY29wZSwgbG9jYWxzKSB7CiAgICBpZiAoc2NvcGUgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIHNjb3BlID0gKChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlKVtrZXkwXTsKICAgIHJldHVybiBzY29wZSA9PSBudWxsID8gdW5kZWZpbmVkIDogc2NvcGVba2V5MV07CiAgfTsKfQoKZnVuY3Rpb24gZ2V0dGVyRm4ocGF0aCwgb3B0aW9ucywgZnVsbEV4cCkgewogIC8vIENoZWNrIHdoZXRoZXIgdGhlIGNhY2hlIGhhcyB0aGlzIGdldHRlciBhbHJlYWR5LgogIC8vIFdlIGNhbiB1c2UgaGFzT3duUHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIGNhY2hlIGJlY2F1c2Ugd2UgZW5zdXJlLAogIC8vIHNlZSBiZWxvdywgdGhhdCB0aGUgY2FjaGUgbmV2ZXIgc3RvcmVzIGEgcGF0aCBjYWxsZWQgJ2hhc093blByb3BlcnR5JwogIGlmIChnZXR0ZXJGbkNhY2hlLmhhc093blByb3BlcnR5KHBhdGgpKSB7CiAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICB9CgogIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGgsCiAgICAgIGZuOwoKICAvLyBXaGVuIHdlIGhhdmUgb25seSAxIG9yIDIgdG9rZW5zLCB1c2Ugb3B0aW1pemVkIHNwZWNpYWwgY2FzZSBjbG9zdXJlcy4KICAvLyBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtcGFyc2UtZ2V0dGVyLzYKICBpZiAoIW9wdGlvbnMudW53cmFwUHJvbWlzZXMgJiYgcGF0aEtleXNMZW5ndGggPT09IDEpIHsKICAgIGZuID0gc2ltcGxlR2V0dGVyRm4xKHBhdGhLZXlzWzBdLCBmdWxsRXhwKTsKICB9IGVsc2UgaWYgKCFvcHRpb25zLnVud3JhcFByb21pc2VzICYmIHBhdGhLZXlzTGVuZ3RoID09PSAyKSB7CiAgICBmbiA9IHNpbXBsZUdldHRlckZuMihwYXRoS2V5c1swXSwgcGF0aEtleXNbMV0sIGZ1bGxFeHApOwogIH0gZWxzZSBpZiAob3B0aW9ucy5jc3ApIHsKICAgIGlmIChwYXRoS2V5c0xlbmd0aCA8IDYpIHsKICAgICAgZm4gPSBjc3BTYWZlR2V0dGVyRm4ocGF0aEtleXNbMF0sIHBhdGhLZXlzWzFdLCBwYXRoS2V5c1syXSwgcGF0aEtleXNbM10sIHBhdGhLZXlzWzRdLCBmdWxsRXhwLAogICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgZm4gPSBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIGkgPSAwLCB2YWw7CiAgICAgICAgZG8gewogICAgICAgICAgdmFsID0gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzW2krK10sIHBhdGhLZXlzW2krK10sIHBhdGhLZXlzW2krK10sIHBhdGhLZXlzW2krK10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aEtleXNbaSsrXSwgZnVsbEV4cCwgb3B0aW9ucykoc2NvcGUsIGxvY2Fscyk7CgogICAgICAgICAgbG9jYWxzID0gdW5kZWZpbmVkOyAvLyBjbGVhciBhZnRlciBmaXJzdCBpdGVyYXRpb24KICAgICAgICAgIHNjb3BlID0gdmFsOwogICAgICAgIH0gd2hpbGUgKGkgPCBwYXRoS2V5c0xlbmd0aCk7CiAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgfTsKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGNvZGUgPSAndmFyIHA7XG4nOwogICAgZm9yRWFjaChwYXRoS2V5cywgZnVuY3Rpb24oa2V5LCBpbmRleCkgewogICAgICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXksIGZ1bGxFeHApOwogICAgICBjb2RlICs9ICdpZihzID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICAgICAncz0nKyAoaW5kZXgKICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHNpbXBseSBkZXJlZmVyZW5jZSAncycgb24gYW55IC5kb3Qgbm90YXRpb24KICAgICAgICAgICAgICAgICAgICAgID8gJ3MnCiAgICAgICAgICAgICAgICAgICAgICAvLyBidXQgaWYgd2UgYXJlIGZpcnN0IHRoZW4gd2UgY2hlY2sgbG9jYWxzIGZpcnN0LCBhbmQgaWYgc28gcmVhZCBpdCBmaXJzdAogICAgICAgICAgICAgICAgICAgICAgOiAnKChrJiZrLmhhc093blByb3BlcnR5KCInICsga2V5ICsgJyIpKT9rOnMpJykgKyAnWyInICsga2V5ICsgJyJdJyArICc7XG4nICsKICAgICAgICAgICAgICAob3B0aW9ucy51bndyYXBQcm9taXNlcwogICAgICAgICAgICAgICAgPyAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgICAgICAgJyBwdygiJyArIGZ1bGxFeHAucmVwbGFjZSgvKFsiXHJcbl0pL2csICdcXCQxJykgKyAnIik7XG4nICsKICAgICAgICAgICAgICAgICAgJyBpZiAoISgiJCR2IiBpbiBzKSkge1xuJyArCiAgICAgICAgICAgICAgICAgICAgJyBwPXM7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHAuJCR2ID0gdW5kZWZpbmVkO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJyBwLnRoZW4oZnVuY3Rpb24odikge3AuJCR2PXY7fSk7XG4nICsKICAgICAgICAgICAgICAgICAgICAnfVxuJyArCiAgICAgICAgICAgICAgICAgICcgcz1zLiQkdlxuJyArCiAgICAgICAgICAgICAgICAnfVxuJwogICAgICAgICAgICAgICAgOiAnJyk7CiAgICB9KTsKICAgIGNvZGUgKz0gJ3JldHVybiBzOyc7CgogICAgLyoganNoaW50IC1XMDU0ICovCiAgICB2YXIgZXZhbGVkRm5HZXR0ZXIgPSBuZXcgRnVuY3Rpb24oJ3MnLCAnaycsICdwdycsIGNvZGUpOyAvLyBzPXNjb3BlLCBrPWxvY2FscywgcHc9cHJvbWlzZVdhcm5pbmcKICAgIC8qIGpzaGludCArVzA1NCAqLwogICAgZXZhbGVkRm5HZXR0ZXIudG9TdHJpbmcgPSB2YWx1ZUZuKGNvZGUpOwogICAgZm4gPSBvcHRpb25zLnVud3JhcFByb21pc2VzID8gZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICByZXR1cm4gZXZhbGVkRm5HZXR0ZXIoc2NvcGUsIGxvY2FscywgcHJvbWlzZVdhcm5pbmcpOwogICAgfSA6IGV2YWxlZEZuR2V0dGVyOwogIH0KCiAgLy8gT25seSBjYWNoZSB0aGUgdmFsdWUgaWYgaXQncyBub3QgZ29pbmcgdG8gbWVzcyB1cCB0aGUgY2FjaGUgb2JqZWN0CiAgLy8gVGhpcyBpcyBtb3JlIHBlcmZvcm1hbnQgdGhhdCB1c2luZyBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwKICBpZiAocGF0aCAhPT0gJ2hhc093blByb3BlcnR5JykgewogICAgZ2V0dGVyRm5DYWNoZVtwYXRoXSA9IGZuOwogIH0KICByZXR1cm4gZm47Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHBhcnNlCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4KICoKICogYGBganMKICogICB2YXIgZ2V0dGVyID0gJHBhcnNlKCd1c2VyLm5hbWUnKTsKICogICB2YXIgc2V0dGVyID0gZ2V0dGVyLmFzc2lnbjsKICogICB2YXIgY29udGV4dCA9IHt1c2VyOntuYW1lOidhbmd1bGFyJ319OwogKiAgIHZhciBsb2NhbHMgPSB7dXNlcjp7bmFtZTonbG9jYWwnfX07CiAqCiAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0KSkudG9FcXVhbCgnYW5ndWxhcicpOwogKiAgIHNldHRlcihjb250ZXh0LCAnbmV3VmFsdWUnKTsKICogICBleHBlY3QoY29udGV4dC51c2VyLm5hbWUpLnRvRXF1YWwoJ25ld1ZhbHVlJyk7CiAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0LCBsb2NhbHMpKS50b0VxdWFsKCdsb2NhbCcpOwogKiBgYGAKICoKICoKICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICoKICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogKiAgICAgIGBjb250ZXh0YC4KICoKICogICAgVGhlIHJldHVybmVkIGZ1bmN0aW9uIGFsc28gaGFzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICogICAgICAqIGBsaXRlcmFsYCDigJMgYHtib29sZWFufWAg4oCTIHdoZXRoZXIgdGhlIGV4cHJlc3Npb24ncyB0b3AtbGV2ZWwgbm9kZSBpcyBhIEphdmFTY3JpcHQKICogICAgICAgIGxpdGVyYWwuCiAqICAgICAgKiBgY29uc3RhbnRgIOKAkyBge2Jvb2xlYW59YCDigJMgd2hldGhlciB0aGUgZXhwcmVzc2lvbiBpcyBtYWRlIGVudGlyZWx5IG9mIEphdmFTY3JpcHQKICogICAgICAgIGNvbnN0YW50IGxpdGVyYWxzLgogKiAgICAgICogYGFzc2lnbmAg4oCTIGB7P2Z1bmN0aW9uKGNvbnRleHQsIHZhbHVlKX1gIOKAkyBpZiB0aGUgZXhwcmVzc2lvbiBpcyBhc3NpZ25hYmxlLCB0aGlzIHdpbGwgYmUKICogICAgICAgIHNldCB0byBhIGZ1bmN0aW9uIHRvIGNoYW5nZSBpdHMgdmFsdWUgb24gdGhlIGdpdmVuIGNvbnRleHQuCiAqCiAqLwoKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJHBhcnNlUHJvdmlkZXIKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIGAkcGFyc2VQcm92aWRlcmAgY2FuIGJlIHVzZWQgZm9yIGNvbmZpZ3VyaW5nIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSB7QGxpbmsgbmcuJHBhcnNlICRwYXJzZX0KICogIHNlcnZpY2UuCiAqLwpmdW5jdGlvbiAkUGFyc2VQcm92aWRlcigpIHsKICB2YXIgY2FjaGUgPSB7fTsKCiAgdmFyICRwYXJzZU9wdGlvbnMgPSB7CiAgICBjc3A6IGZhbHNlLAogICAgdW53cmFwUHJvbWlzZXM6IGZhbHNlLAogICAgbG9nUHJvbWlzZVdhcm5pbmdzOiB0cnVlCiAgfTsKCgogIC8qKgogICAqIEBkZXByZWNhdGVkIFByb21pc2UgdW53cmFwcGluZyB2aWEgJHBhcnNlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgZnV0dXJlLgogICAqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRwYXJzZVByb3ZpZGVyI3Vud3JhcFByb21pc2VzCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiAqKlRoaXMgZmVhdHVyZSBpcyBkZXByZWNhdGVkLCBzZWUgZGVwcmVjYXRpb24gbm90ZXMgYmVsb3cgZm9yIG1vcmUgaW5mbyoqCiAgICoKICAgKiBJZiBzZXQgdG8gdHJ1ZSAoZGVmYXVsdCBpcyBmYWxzZSksICRwYXJzZSB3aWxsIHVud3JhcCBwcm9taXNlcyBhdXRvbWF0aWNhbGx5IHdoZW4gYSBwcm9taXNlIGlzCiAgICogZm91bmQgYXQgYW55IHBhcnQgb2YgdGhlIGV4cHJlc3Npb24uIEluIG90aGVyIHdvcmRzLCBpZiBzZXQgdG8gdHJ1ZSwgdGhlIGV4cHJlc3Npb24gd2lsbCBhbHdheXMKICAgKiByZXN1bHQgaW4gYSBub24tcHJvbWlzZSB2YWx1ZS4KICAgKgogICAqIFdoaWxlIHRoZSBwcm9taXNlIGlzIHVucmVzb2x2ZWQsIGl0J3MgdHJlYXRlZCBhcyB1bmRlZmluZWQsIGJ1dCBvbmNlIHJlc29sdmVkIGFuZCBmdWxmaWxsZWQsCiAgICogdGhlIGZ1bGZpbGxtZW50IHZhbHVlIGlzIHVzZWQgaW4gcGxhY2Ugb2YgdGhlIHByb21pc2Ugd2hpbGUgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgKgogICAqICoqRGVwcmVjYXRpb24gbm90aWNlKioKICAgKgogICAqIFRoaXMgaXMgYSBmZWF0dXJlIHRoYXQgZGlkbid0IHByb3ZlIHRvIGJlIHdpbGRseSB1c2VmdWwgb3IgcG9wdWxhciwgcHJpbWFyaWx5IGJlY2F1c2Ugb2YgdGhlCiAgICogZGljaG90b215IGJldHdlZW4gZGF0YSBhY2Nlc3MgaW4gdGVtcGxhdGVzIChhY2Nlc3NlZCBhcyByYXcgdmFsdWVzKSBhbmQgY29udHJvbGxlciBjb2RlCiAgICogKGFjY2Vzc2VkIGFzIHByb21pc2VzKS4KICAgKgogICAqIEluIG1vc3QgY29kZSB3ZSBlbmRlZCB1cCByZXNvbHZpbmcgcHJvbWlzZXMgbWFudWFsbHkgaW4gY29udHJvbGxlcnMgYW55d2F5IGFuZCB0aHVzIHVuaWZ5aW5nCiAgICogdGhlIG1vZGVsIGFjY2VzcyB0aGVyZS4KICAgKgogICAqIE90aGVyIGRvd25zaWRlcyBvZiBhdXRvbWF0aWMgcHJvbWlzZSB1bndyYXBwaW5nOgogICAqCiAgICogLSB3aGVuIGJ1aWxkaW5nIGNvbXBvbmVudHMgaXQncyBvZnRlbiBkZXNpcmFibGUgdG8gcmVjZWl2ZSB0aGUgcmF3IHByb21pc2VzCiAgICogLSBhZGRzIGNvbXBsZXhpdHkgYW5kIHNsb3dzIGRvd24gZXhwcmVzc2lvbiBldmFsdWF0aW9uCiAgICogLSBtYWtlcyBleHByZXNzaW9uIGNvZGUgcHJlLWdlbmVyYXRpb24gdW5hdHRyYWN0aXZlIGR1ZSB0byB0aGUgYW1vdW50IG9mIGNvZGUgdGhhdCBuZWVkcyB0byBiZQogICAqICAgZ2VuZXJhdGVkCiAgICogLSBtYWtlcyBJREUgYXV0by1jb21wbGV0aW9uIGFuZCB0b29sIHN1cHBvcnQgaGFyZAogICAqCiAgICogKipXYXJuaW5nIExvZ3MqKgogICAqCiAgICogSWYgdGhlIHVud3JhcHBpbmcgaXMgZW5hYmxlZCwgQW5ndWxhciB3aWxsIGxvZyBhIHdhcm5pbmcgYWJvdXQgZWFjaCBleHByZXNzaW9uIHRoYXQgdW53cmFwcyBhCiAgICogcHJvbWlzZSAodG8gcmVkdWNlIHRoZSBub2lzZSwgZWFjaCBleHByZXNzaW9uIGlzIGxvZ2dlZCBvbmx5IG9uY2UpLiBUbyBkaXNhYmxlIHRoaXMgbG9nZ2luZyB1c2UKICAgKiBgJHBhcnNlUHJvdmlkZXIubG9nUHJvbWlzZVdhcm5pbmdzKGZhbHNlKWAgYXBpLgogICAqCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBOZXcgdmFsdWUuCiAgICogQHJldHVybnMge2Jvb2xlYW58c2VsZn0gUmV0dXJucyB0aGUgY3VycmVudCBzZXR0aW5nIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcwogICAqICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRlci4KICAgKi8KICB0aGlzLnVud3JhcFByb21pc2VzID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICRwYXJzZU9wdGlvbnMudW53cmFwUHJvbWlzZXMgPSAhIXZhbHVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAkcGFyc2VPcHRpb25zLnVud3JhcFByb21pc2VzOwogICAgfQogIH07CgoKICAvKioKICAgKiBAZGVwcmVjYXRlZCBQcm9taXNlIHVud3JhcHBpbmcgdmlhICRwYXJzZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIGZ1dHVyZS4KICAgKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcGFyc2VQcm92aWRlciNsb2dQcm9taXNlV2FybmluZ3MKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIENvbnRyb2xzIHdoZXRoZXIgQW5ndWxhciBzaG91bGQgbG9nIGEgd2FybmluZyBvbiBhbnkgZW5jb3VudGVyIG9mIGEgcHJvbWlzZSBpbiBhbiBleHByZXNzaW9uLgogICAqCiAgICogVGhlIGRlZmF1bHQgaXMgc2V0IHRvIGB0cnVlYC4KICAgKgogICAqIFRoaXMgc2V0dGluZyBhcHBsaWVzIG9ubHkgaWYgYCRwYXJzZVByb3ZpZGVyLnVud3JhcFByb21pc2VzYCBzZXR0aW5nIGlzIHNldCB0byB0cnVlIGFzIHdlbGwuCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBOZXcgdmFsdWUuCiAgICogQHJldHVybnMge2Jvb2xlYW58c2VsZn0gUmV0dXJucyB0aGUgY3VycmVudCBzZXR0aW5nIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcwogICAqICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRlci4KICAgKi8KIHRoaXMubG9nUHJvbWlzZVdhcm5pbmdzID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICRwYXJzZU9wdGlvbnMubG9nUHJvbWlzZVdhcm5pbmdzID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICRwYXJzZU9wdGlvbnMubG9nUHJvbWlzZVdhcm5pbmdzOwogICAgfQogIH07CgoKICB0aGlzLiRnZXQgPSBbJyRmaWx0ZXInLCAnJHNuaWZmZXInLCAnJGxvZycsIGZ1bmN0aW9uKCRmaWx0ZXIsICRzbmlmZmVyLCAkbG9nKSB7CiAgICAkcGFyc2VPcHRpb25zLmNzcCA9ICRzbmlmZmVyLmNzcDsKCiAgICBwcm9taXNlV2FybmluZyA9IGZ1bmN0aW9uIHByb21pc2VXYXJuaW5nRm4oZnVsbEV4cCkgewogICAgICBpZiAoISRwYXJzZU9wdGlvbnMubG9nUHJvbWlzZVdhcm5pbmdzIHx8IHByb21pc2VXYXJuaW5nQ2FjaGUuaGFzT3duUHJvcGVydHkoZnVsbEV4cCkpIHJldHVybjsKICAgICAgcHJvbWlzZVdhcm5pbmdDYWNoZVtmdWxsRXhwXSA9IHRydWU7CiAgICAgICRsb2cud2FybignWyRwYXJzZV0gUHJvbWlzZSBmb3VuZCBpbiB0aGUgZXhwcmVzc2lvbiBgJyArIGZ1bGxFeHAgKyAnYC4gJyArCiAgICAgICAgICAnQXV0b21hdGljIHVud3JhcHBpbmcgb2YgcHJvbWlzZXMgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkZXByZWNhdGVkLicpOwogICAgfTsKCiAgICByZXR1cm4gZnVuY3Rpb24oZXhwKSB7CiAgICAgIHZhciBwYXJzZWRFeHByZXNzaW9uOwoKICAgICAgc3dpdGNoICh0eXBlb2YgZXhwKSB7CiAgICAgICAgY2FzZSAnc3RyaW5nJzoKCiAgICAgICAgICBpZiAoY2FjaGUuaGFzT3duUHJvcGVydHkoZXhwKSkgewogICAgICAgICAgICByZXR1cm4gY2FjaGVbZXhwXTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoJHBhcnNlT3B0aW9ucyk7CiAgICAgICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcihsZXhlciwgJGZpbHRlciwgJHBhcnNlT3B0aW9ucyk7CiAgICAgICAgICBwYXJzZWRFeHByZXNzaW9uID0gcGFyc2VyLnBhcnNlKGV4cCk7CgogICAgICAgICAgaWYgKGV4cCAhPT0gJ2hhc093blByb3BlcnR5JykgewogICAgICAgICAgICAvLyBPbmx5IGNhY2hlIHRoZSB2YWx1ZSBpZiBpdCdzIG5vdCBnb2luZyB0byBtZXNzIHVwIHRoZSBjYWNoZSBvYmplY3QKICAgICAgICAgICAgLy8gVGhpcyBpcyBtb3JlIHBlcmZvcm1hbnQgdGhhdCB1c2luZyBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwKICAgICAgICAgICAgY2FjaGVbZXhwXSA9IHBhcnNlZEV4cHJlc3Npb247CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHBhcnNlZEV4cHJlc3Npb247CgogICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICAgIHJldHVybiBleHA7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gbm9vcDsKICAgICAgfQogICAgfTsKICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRxCiAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHByb21pc2UvZGVmZXJyZWQgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0tyaXMgS293YWwncyBRXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3EpLgogKgogKiBbVGhlIENvbW1vbkpTIFByb21pc2UgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmNvbW1vbmpzLm9yZy93aWtpL1Byb21pc2VzKSBkZXNjcmliZXMgYSBwcm9taXNlIGFzIGFuCiAqIGludGVyZmFjZSBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCByZXByZXNlbnRzIHRoZSByZXN1bHQgb2YgYW4gYWN0aW9uIHRoYXQgaXMKICogcGVyZm9ybWVkIGFzeW5jaHJvbm91c2x5LCBhbmQgbWF5IG9yIG1heSBub3QgYmUgZmluaXNoZWQgYXQgYW55IGdpdmVuIHBvaW50IGluIHRpbWUuCiAqCiAqIEZyb20gdGhlIHBlcnNwZWN0aXZlIG9mIGRlYWxpbmcgd2l0aCBlcnJvciBoYW5kbGluZywgZGVmZXJyZWQgYW5kIHByb21pc2UgQVBJcyBhcmUgdG8KICogYXN5bmNocm9ub3VzIHByb2dyYW1taW5nIHdoYXQgYHRyeWAsIGBjYXRjaGAgYW5kIGB0aHJvd2Aga2V5d29yZHMgYXJlIHRvIHN5bmNocm9ub3VzIHByb2dyYW1taW5nLgogKgogKiBgYGBqcwogKiAgIC8vIGZvciB0aGUgcHVycG9zZSBvZiB0aGlzIGV4YW1wbGUgbGV0J3MgYXNzdW1lIHRoYXQgdmFyaWFibGVzIGAkcWAsIGBzY29wZWAgYW5kIGBva1RvR3JlZXRgCiAqICAgLy8gYXJlIGF2YWlsYWJsZSBpbiB0aGUgY3VycmVudCBsZXhpY2FsIHNjb3BlICh0aGV5IGNvdWxkIGhhdmUgYmVlbiBpbmplY3RlZCBvciBwYXNzZWQgaW4pLgogKgogKiAgIGZ1bmN0aW9uIGFzeW5jR3JlZXQobmFtZSkgewogKiAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICoKICogICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgICAgIC8vIHNpbmNlIHRoaXMgZm4gZXhlY3V0ZXMgYXN5bmMgaW4gYSBmdXR1cmUgdHVybiBvZiB0aGUgZXZlbnQgbG9vcCwgd2UgbmVlZCB0byB3cmFwCiAqICAgICAgIC8vIG91ciBjb2RlIGludG8gYW4gJGFwcGx5IGNhbGwgc28gdGhhdCB0aGUgbW9kZWwgY2hhbmdlcyBhcmUgcHJvcGVybHkgb2JzZXJ2ZWQuCiAqICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICogICAgICAgICBkZWZlcnJlZC5ub3RpZnkoJ0Fib3V0IHRvIGdyZWV0ICcgKyBuYW1lICsgJy4nKTsKICoKICogICAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCdIZWxsbywgJyArIG5hbWUgKyAnIScpOwogKiAgICAgICAgIH0gZWxzZSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICogICAgICAgICB9CiAqICAgICAgIH0pOwogKiAgICAgfSwgMTAwMCk7CiAqCiAqICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICogICB9CiAqCiAqICAgdmFyIHByb21pc2UgPSBhc3luY0dyZWV0KCdSb2JpbiBIb29kJyk7CiAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAqICAgICBhbGVydCgnU3VjY2VzczogJyArIGdyZWV0aW5nKTsKICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogKiAgIH0sIGZ1bmN0aW9uKHVwZGF0ZSkgewogKiAgICAgYWxlcnQoJ0dvdCBub3RpZmljYXRpb246ICcgKyB1cGRhdGUpOwogKiAgIH0pOwogKiBgYGAKICoKICogQXQgZmlyc3QgaXQgbWlnaHQgbm90IGJlIG9idmlvdXMgd2h5IHRoaXMgZXh0cmEgY29tcGxleGl0eSBpcyB3b3J0aCB0aGUgdHJvdWJsZS4gVGhlIHBheW9mZgogKiBjb21lcyBpbiB0aGUgd2F5IG9mIGd1YXJhbnRlZXMgdGhhdCBwcm9taXNlIGFuZCBkZWZlcnJlZCBBUElzIG1ha2UsIHNlZQogKiBodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3VuY29tbW9uanMvYmxvYi9tYXN0ZXIvcHJvbWlzZXMvc3BlY2lmaWNhdGlvbi5tZC4KICoKICogQWRkaXRpb25hbGx5IHRoZSBwcm9taXNlIGFwaSBhbGxvd3MgZm9yIGNvbXBvc2l0aW9uIHRoYXQgaXMgdmVyeSBoYXJkIHRvIGRvIHdpdGggdGhlCiAqIHRyYWRpdGlvbmFsIGNhbGxiYWNrIChbQ1BTXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NvbnRpbnVhdGlvbi1wYXNzaW5nX3N0eWxlKSkgYXBwcm9hY2guCiAqIEZvciBtb3JlIG9uIHRoaXMgcGxlYXNlIHNlZSB0aGUgW1EgZG9jdW1lbnRhdGlvbl0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKSBlc3BlY2lhbGx5IHRoZQogKiBzZWN0aW9uIG9uIHNlcmlhbCBvciBwYXJhbGxlbCBqb2luaW5nIG9mIHByb21pc2VzLgogKgogKgogKiAjIFRoZSBEZWZlcnJlZCBBUEkKICoKICogQSBuZXcgaW5zdGFuY2Ugb2YgZGVmZXJyZWQgaXMgY29uc3RydWN0ZWQgYnkgY2FsbGluZyBgJHEuZGVmZXIoKWAuCiAqCiAqIFRoZSBwdXJwb3NlIG9mIHRoZSBkZWZlcnJlZCBvYmplY3QgaXMgdG8gZXhwb3NlIHRoZSBhc3NvY2lhdGVkIFByb21pc2UgaW5zdGFuY2UgYXMgd2VsbCBhcyBBUElzCiAqIHRoYXQgY2FuIGJlIHVzZWQgZm9yIHNpZ25hbGluZyB0aGUgc3VjY2Vzc2Z1bCBvciB1bnN1Y2Nlc3NmdWwgY29tcGxldGlvbiwgYXMgd2VsbCBhcyB0aGUgc3RhdHVzCiAqIG9mIHRoZSB0YXNrLgogKgogKiAqKk1ldGhvZHMqKgogKgogKiAtIGByZXNvbHZlKHZhbHVlKWAg4oCTIHJlc29sdmVzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHZhbHVlYC4gSWYgdGhlIHZhbHVlIGlzIGEgcmVqZWN0aW9uCiAqICAgY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLCB0aGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGluc3RlYWQuCiAqIC0gYHJlamVjdChyZWFzb24pYCDigJMgcmVqZWN0cyB0aGUgZGVyaXZlZCBwcm9taXNlIHdpdGggdGhlIGByZWFzb25gLiBUaGlzIGlzIGVxdWl2YWxlbnQgdG8KICogICByZXNvbHZpbmcgaXQgd2l0aCBhIHJlamVjdGlvbiBjb25zdHJ1Y3RlZCB2aWEgYCRxLnJlamVjdGAuCiAqIC0gYG5vdGlmeSh2YWx1ZSlgIC0gcHJvdmlkZXMgdXBkYXRlcyBvbiB0aGUgc3RhdHVzIG9mIHRoZSBwcm9taXNlJ3MgZXhlY3V0aW9uLiBUaGlzIG1heSBiZSBjYWxsZWQKICogICBtdWx0aXBsZSB0aW1lcyBiZWZvcmUgdGhlIHByb21pc2UgaXMgZWl0aGVyIHJlc29sdmVkIG9yIHJlamVjdGVkLgogKgogKiAqKlByb3BlcnRpZXMqKgogKgogKiAtIHByb21pc2Ug4oCTIGB7UHJvbWlzZX1gIOKAkyBwcm9taXNlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcyBkZWZlcnJlZC4KICoKICoKICogIyBUaGUgUHJvbWlzZSBBUEkKICoKICogQSBuZXcgcHJvbWlzZSBpbnN0YW5jZSBpcyBjcmVhdGVkIHdoZW4gYSBkZWZlcnJlZCBpbnN0YW5jZSBpcyBjcmVhdGVkIGFuZCBjYW4gYmUgcmV0cmlldmVkIGJ5CiAqIGNhbGxpbmcgYGRlZmVycmVkLnByb21pc2VgLgogKgogKiBUaGUgcHVycG9zZSBvZiB0aGUgcHJvbWlzZSBvYmplY3QgaXMgdG8gYWxsb3cgZm9yIGludGVyZXN0ZWQgcGFydGllcyB0byBnZXQgYWNjZXNzIHRvIHRoZSByZXN1bHQKICogb2YgdGhlIGRlZmVycmVkIHRhc2sgd2hlbiBpdCBjb21wbGV0ZXMuCiAqCiAqICoqTWV0aG9kcyoqCiAqCiAqIC0gYHRoZW4oc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrLCBub3RpZnlDYWxsYmFjaylgIOKAkyByZWdhcmRsZXNzIG9mIHdoZW4gdGhlIHByb21pc2Ugd2FzIG9yCiAqICAgd2lsbCBiZSByZXNvbHZlZCBvciByZWplY3RlZCwgYHRoZW5gIGNhbGxzIG9uZSBvZiB0aGUgc3VjY2VzcyBvciBlcnJvciBjYWxsYmFja3MgYXN5bmNocm9ub3VzbHkKICogICBhcyBzb29uIGFzIHRoZSByZXN1bHQgaXMgYXZhaWxhYmxlLiBUaGUgY2FsbGJhY2tzIGFyZSBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudDogdGhlIHJlc3VsdAogKiAgIG9yIHJlamVjdGlvbiByZWFzb24uIEFkZGl0aW9uYWxseSwgdGhlIG5vdGlmeSBjYWxsYmFjayBtYXkgYmUgY2FsbGVkIHplcm8gb3IgbW9yZSB0aW1lcyB0bwogKiAgIHByb3ZpZGUgYSBwcm9ncmVzcyBpbmRpY2F0aW9uLCBiZWZvcmUgdGhlIHByb21pc2UgaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQuCiAqCiAqICAgVGhpcyBtZXRob2QgKnJldHVybnMgYSBuZXcgcHJvbWlzZSogd2hpY2ggaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlCiAqICAgYHN1Y2Nlc3NDYWxsYmFja2AsIGBlcnJvckNhbGxiYWNrYC4gSXQgYWxzbyBub3RpZmllcyB2aWEgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUKICogICBgbm90aWZ5Q2FsbGJhY2tgIG1ldGhvZC4gVGhlIHByb21pc2UgY2FuIG5vdCBiZSByZXNvbHZlZCBvciByZWplY3RlZCBmcm9tIHRoZSBub3RpZnlDYWxsYmFjawogKiAgIG1ldGhvZC4KICoKICogLSBgY2F0Y2goZXJyb3JDYWxsYmFjaylgIOKAkyBzaG9ydGhhbmQgZm9yIGBwcm9taXNlLnRoZW4obnVsbCwgZXJyb3JDYWxsYmFjaylgCiAqCiAqIC0gYGZpbmFsbHkoY2FsbGJhY2spYCDigJMgYWxsb3dzIHlvdSB0byBvYnNlcnZlIGVpdGhlciB0aGUgZnVsZmlsbG1lbnQgb3IgcmVqZWN0aW9uIG9mIGEgcHJvbWlzZSwKICogICBidXQgdG8gZG8gc28gd2l0aG91dCBtb2RpZnlpbmcgdGhlIGZpbmFsIHZhbHVlLiBUaGlzIGlzIHVzZWZ1bCB0byByZWxlYXNlIHJlc291cmNlcyBvciBkbyBzb21lCiAqICAgY2xlYW4tdXAgdGhhdCBuZWVkcyB0byBiZSBkb25lIHdoZXRoZXIgdGhlIHByb21pc2Ugd2FzIHJlamVjdGVkIG9yIHJlc29sdmVkLiBTZWUgdGhlIFtmdWxsCiAqICAgc3BlY2lmaWNhdGlvbl0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xL3dpa2kvQVBJLVJlZmVyZW5jZSNwcm9taXNlZmluYWxseWNhbGxiYWNrKSBmb3IKICogICBtb3JlIGluZm9ybWF0aW9uLgogKgogKiAgIEJlY2F1c2UgYGZpbmFsbHlgIGlzIGEgcmVzZXJ2ZWQgd29yZCBpbiBKYXZhU2NyaXB0IGFuZCByZXNlcnZlZCBrZXl3b3JkcyBhcmUgbm90IHN1cHBvcnRlZCBhcwogKiAgIHByb3BlcnR5IG5hbWVzIGJ5IEVTMywgeW91J2xsIG5lZWQgdG8gaW52b2tlIHRoZSBtZXRob2QgbGlrZSBgcHJvbWlzZVsnZmluYWxseSddKGNhbGxiYWNrKWAgdG8KICogICBtYWtlIHlvdXIgY29kZSBJRTggYW5kIEFuZHJvaWQgMi54IGNvbXBhdGlibGUuCiAqCiAqICMgQ2hhaW5pbmcgcHJvbWlzZXMKICoKICogQmVjYXVzZSBjYWxsaW5nIHRoZSBgdGhlbmAgbWV0aG9kIG9mIGEgcHJvbWlzZSByZXR1cm5zIGEgbmV3IGRlcml2ZWQgcHJvbWlzZSwgaXQgaXMgZWFzaWx5CiAqIHBvc3NpYmxlIHRvIGNyZWF0ZSBhIGNoYWluIG9mIHByb21pc2VzOgogKgogKiBgYGBqcwogKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICogICAgIHJldHVybiByZXN1bHQgKyAxOwogKiAgIH0pOwogKgogKiAgIC8vIHByb21pc2VCIHdpbGwgYmUgcmVzb2x2ZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgcHJvbWlzZUEgaXMgcmVzb2x2ZWQgYW5kIGl0cyB2YWx1ZQogKiAgIC8vIHdpbGwgYmUgdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAqIGBgYAogKgogKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAqIHByb21pc2UgKHdoaWNoIHdpbGwgZGVmZXIgaXRzIHJlc29sdXRpb24gZnVydGhlciksIGl0IGlzIHBvc3NpYmxlIHRvIHBhdXNlL2RlZmVyIHJlc29sdXRpb24gb2YKICogdGhlIHByb21pc2VzIGF0IGFueSBwb2ludCBpbiB0aGUgY2hhaW4uIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgdG8gaW1wbGVtZW50IHBvd2VyZnVsIEFQSXMgbGlrZQogKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICoKICoKICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogKgogKiAgVGhlcmUgYXJlIHR3byBtYWluIGRpZmZlcmVuY2VzOgogKgogKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAqICAgbWVjaGFuaXNtIGluIGFuZ3VsYXIsIHdoaWNoIG1lYW5zIGZhc3RlciBwcm9wYWdhdGlvbiBvZiByZXNvbHV0aW9uIG9yIHJlamVjdGlvbiBpbnRvIHlvdXIKICogICBtb2RlbHMgYW5kIGF2b2lkaW5nIHVubmVjZXNzYXJ5IGJyb3dzZXIgcmVwYWludHMsIHdoaWNoIHdvdWxkIHJlc3VsdCBpbiBmbGlja2VyaW5nIFVJLgogKiAtIFEgaGFzIG1hbnkgbW9yZSBmZWF0dXJlcyB0aGFuICRxLCBidXQgdGhhdCBjb21lcyBhdCBhIGNvc3Qgb2YgYnl0ZXMuICRxIGlzIHRpbnksIGJ1dCBjb250YWlucwogKiAgIGFsbCB0aGUgaW1wb3J0YW50IGZ1bmN0aW9uYWxpdHkgbmVlZGVkIGZvciBjb21tb24gYXN5bmMgdGFza3MuCiAqCiAqICAjIFRlc3RpbmcKICoKICogIGBgYGpzCiAqICAgIGl0KCdzaG91bGQgc2ltdWxhdGUgcHJvbWlzZScsIGluamVjdChmdW5jdGlvbigkcSwgJHJvb3RTY29wZSkgewogKiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAqICAgICAgdmFyIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlOwogKiAgICAgIHZhciByZXNvbHZlZFZhbHVlOwogKgogKiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgeyByZXNvbHZlZFZhbHVlID0gdmFsdWU7IH0pOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqCiAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICogICAgICBkZWZlcnJlZC5yZXNvbHZlKDEyMyk7CiAqICAgICAgLy8gTm90ZSB0aGF0IHRoZSAndGhlbicgZnVuY3Rpb24gZG9lcyBub3QgZ2V0IGNhbGxlZCBzeW5jaHJvbm91c2x5LgogKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAqICAgICAgLy8gaXQgZ290IGNhbGxlZCBzeW5jaHJvbm91c2x5IG9yIGFzeW5jaHJvbm91c2x5LgogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqCiAqICAgICAgLy8gUHJvcGFnYXRlIHByb21pc2UgcmVzb2x1dGlvbiB0byAndGhlbicgZnVuY3Rpb25zIHVzaW5nICRhcHBseSgpLgogKiAgICAgICRyb290U2NvcGUuJGFwcGx5KCk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvRXF1YWwoMTIzKTsKICogICAgfSkpOwogKiAgYGBgCiAqLwpmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgcmV0dXJuIHFGYWN0b3J5KGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhjYWxsYmFjayk7CiAgICB9LCAkZXhjZXB0aW9uSGFuZGxlcik7CiAgfV07Cn0KCgovKioKICogQ29uc3RydWN0cyBhIHByb21pc2UgbWFuYWdlci4KICoKICogQHBhcmFtIHtmdW5jdGlvbihGdW5jdGlvbil9IG5leHRUaWNrIEZ1bmN0aW9uIGZvciBleGVjdXRpbmcgZnVuY3Rpb25zIGluIHRoZSBuZXh0IHR1cm4uCiAqIEBwYXJhbSB7ZnVuY3Rpb24oLi4uKil9IGV4Y2VwdGlvbkhhbmRsZXIgRnVuY3Rpb24gaW50byB3aGljaCB1bmV4cGVjdGVkIGV4Y2VwdGlvbnMgYXJlIHBhc3NlZCBmb3IKICogICAgIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICogQHJldHVybnMge29iamVjdH0gUHJvbWlzZSBtYW5hZ2VyLgogKi8KZnVuY3Rpb24gcUZhY3RvcnkobmV4dFRpY2ssIGV4Y2VwdGlvbkhhbmRsZXIpIHsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRxI2RlZmVyCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBgRGVmZXJyZWRgIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGEgdGFzayB3aGljaCB3aWxsIGZpbmlzaCBpbiB0aGUgZnV0dXJlLgogICAqCiAgICogQHJldHVybnMge0RlZmVycmVkfSBSZXR1cm5zIGEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkLgogICAqLwogIHZhciBkZWZlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICB2YWx1ZSwgZGVmZXJyZWQ7CgogICAgZGVmZXJyZWQgPSB7CgogICAgICByZXNvbHZlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHBlbmRpbmc7CiAgICAgICAgICBwZW5kaW5nID0gdW5kZWZpbmVkOwogICAgICAgICAgdmFsdWUgPSByZWYodmFsKTsKCiAgICAgICAgICBpZiAoY2FsbGJhY2tzLmxlbmd0aCkgewogICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gY2FsbGJhY2tzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgdmFsdWUudGhlbihjYWxsYmFja1swXSwgY2FsbGJhY2tbMV0sIGNhbGxiYWNrWzJdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKCgogICAgICByZWplY3Q6IGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIGRlZmVycmVkLnJlc29sdmUoY3JlYXRlSW50ZXJuYWxSZWplY3RlZFByb21pc2UocmVhc29uKSk7CiAgICAgIH0sCgoKICAgICAgbm90aWZ5OiBmdW5jdGlvbihwcm9ncmVzcykgewogICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gcGVuZGluZzsKCiAgICAgICAgICBpZiAocGVuZGluZy5sZW5ndGgpIHsKICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrWzJdKHByb2dyZXNzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKCgogICAgICBwcm9taXNlOiB7CiAgICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzYmFjaykgewogICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CgogICAgICAgICAgdmFyIHdyYXBwZWRDYWxsYmFjayA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2sgOiBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKSk7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgd3JhcHBlZEVycmJhY2sgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoaXNGdW5jdGlvbihlcnJiYWNrKSA/IGVycmJhY2sgOiBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgd3JhcHBlZFByb2dyZXNzYmFjayA9IGZ1bmN0aW9uKHByb2dyZXNzKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVzdWx0Lm5vdGlmeSgoaXNGdW5jdGlvbihwcm9ncmVzc2JhY2spID8gcHJvZ3Jlc3NiYWNrIDogZGVmYXVsdENhbGxiYWNrKShwcm9ncmVzcykpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgIHBlbmRpbmcucHVzaChbd3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjaywgd3JhcHBlZFByb2dyZXNzYmFja10pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrLCB3cmFwcGVkUHJvZ3Jlc3NiYWNrKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgfSwKCiAgICAgICAgImNhdGNoIjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB0aGlzLnRoZW4obnVsbCwgY2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgICJmaW5hbGx5IjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICBmdW5jdGlvbiBtYWtlUHJvbWlzZSh2YWx1ZSwgcmVzb2x2ZWQpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gaGFuZGxlQ2FsbGJhY2sodmFsdWUsIGlzUmVzb2x2ZWQpIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrT3V0cHV0ID0gbnVsbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjYWxsYmFja091dHB1dCA9IChjYWxsYmFjayB8fGRlZmF1bHRDYWxsYmFjaykoKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKGUsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2FsbGJhY2tPdXRwdXQgJiYgaXNGdW5jdGlvbihjYWxsYmFja091dHB1dC50aGVuKSkgewogICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja091dHB1dC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKHZhbHVlLCBpc1Jlc29sdmVkKTsKICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKGVycm9yLCBmYWxzZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKHZhbHVlLCBpc1Jlc29sdmVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB0aGlzLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUNhbGxiYWNrKHZhbHVlLCB0cnVlKTsKICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVDYWxsYmFjayhlcnJvciwgZmFsc2UpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBkZWZlcnJlZDsKICB9OwoKCiAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgJiYgaXNGdW5jdGlvbih2YWx1ZS50aGVuKSkgcmV0dXJuIHZhbHVlOwogICAgcmV0dXJuIHsKICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKGNhbGxiYWNrKHZhbHVlKSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICB9CiAgICB9OwogIH07CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHEjcmVqZWN0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgc3BlY2lmaWVkIGByZWFzb25gLiBUaGlzIGFwaSBzaG91bGQgYmUKICAgKiB1c2VkIHRvIGZvcndhcmQgcmVqZWN0aW9uIGluIGEgY2hhaW4gb2YgcHJvbWlzZXMuIElmIHlvdSBhcmUgZGVhbGluZyB3aXRoIHRoZSBsYXN0IHByb21pc2UgaW4KICAgKiBhIHByb21pc2UgY2hhaW4sIHlvdSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IGl0LgogICAqCiAgICogV2hlbiBjb21wYXJpbmcgZGVmZXJyZWRzL3Byb21pc2VzIHRvIHRoZSBmYW1pbGlhciBiZWhhdmlvciBvZiB0cnkvY2F0Y2gvdGhyb3csIHRoaW5rIG9mCiAgICogYHJlamVjdGAgYXMgdGhlIGB0aHJvd2Aga2V5d29yZCBpbiBKYXZhU2NyaXB0LiBUaGlzIGFsc28gbWVhbnMgdGhhdCBpZiB5b3UgImNhdGNoIiBhbiBlcnJvciB2aWEKICAgKiBhIHByb21pc2UgZXJyb3IgY2FsbGJhY2sgYW5kIHlvdSB3YW50IHRvIGZvcndhcmQgdGhlIGVycm9yIHRvIHRoZSBwcm9taXNlIGRlcml2ZWQgZnJvbSB0aGUKICAgKiBjdXJyZW50IHByb21pc2UsIHlvdSBoYXZlIHRvICJyZXRocm93IiB0aGUgZXJyb3IgYnkgcmV0dXJuaW5nIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYQogICAqIGByZWplY3RgLgogICAqCiAgICogYGBganMKICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgKiAgICAgLy8gc3VjY2VzczogZG8gc29tZXRoaW5nIGFuZCByZXNvbHZlIHByb21pc2VCCiAgICogICAgIC8vICAgICAgICAgIHdpdGggdGhlIG9sZCBvciBhIG5ldyByZXN1bHQKICAgKiAgICAgcmV0dXJuIHJlc3VsdDsKICAgKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAqICAgICAvLyBlcnJvcjogaGFuZGxlIHRoZSBlcnJvciBpZiBwb3NzaWJsZSBhbmQKICAgKiAgICAgLy8gICAgICAgIHJlc29sdmUgcHJvbWlzZUIgd2l0aCBuZXdQcm9taXNlT3JWYWx1ZSwKICAgKiAgICAgLy8gICAgICAgIG90aGVyd2lzZSBmb3J3YXJkIHRoZSByZWplY3Rpb24gdG8gcHJvbWlzZUIKICAgKiAgICAgaWYgKGNhbkhhbmRsZShyZWFzb24pKSB7CiAgICogICAgICAvLyBoYW5kbGUgdGhlIGVycm9yIGFuZCByZWNvdmVyCiAgICogICAgICByZXR1cm4gbmV3UHJvbWlzZU9yVmFsdWU7CiAgICogICAgIH0KICAgKiAgICAgcmV0dXJuICRxLnJlamVjdChyZWFzb24pOwogICAqICAgfSk7CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0geyp9IHJlYXNvbiBDb25zdGFudCwgbWVzc2FnZSwgZXhjZXB0aW9uIG9yIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlamVjdGlvbiByZWFzb24uCiAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2FzIGFscmVhZHkgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgYHJlYXNvbmAuCiAgICovCiAgdmFyIHJlamVjdCA9IGZ1bmN0aW9uKHJlYXNvbikgewogICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICByZXN1bHQucmVqZWN0KHJlYXNvbik7CiAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgfTsKCiAgdmFyIGNyZWF0ZUludGVybmFsUmVqZWN0ZWRQcm9taXNlID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICByZXR1cm4gewogICAgICB0aGVuOiBmdW5jdGlvbihjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwogICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICB9CiAgICB9OwogIH07CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHEjd2hlbgogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBXcmFwcyBhbiBvYmplY3QgdGhhdCBtaWdodCBiZSBhIHZhbHVlIG9yIGEgKDNyZCBwYXJ0eSkgdGhlbi1hYmxlIHByb21pc2UgaW50byBhICRxIHByb21pc2UuCiAgICogVGhpcyBpcyB1c2VmdWwgd2hlbiB5b3UgYXJlIGRlYWxpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCBtaWdodCBvciBtaWdodCBub3QgYmUgYSBwcm9taXNlLCBvciBpZgogICAqIHRoZSBwcm9taXNlIGNvbWVzIGZyb20gYSBzb3VyY2UgdGhhdCBjYW4ndCBiZSB0cnVzdGVkLgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBWYWx1ZSBvciBhIHByb21pc2UKICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2Ugb2YgdGhlIHBhc3NlZCB2YWx1ZSBvciBwcm9taXNlCiAgICovCiAgdmFyIHdoZW4gPSBmdW5jdGlvbih2YWx1ZSwgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzYmFjaykgewogICAgdmFyIHJlc3VsdCA9IGRlZmVyKCksCiAgICAgICAgZG9uZTsKCiAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gKGlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2sgOiBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgd3JhcHBlZEVycmJhY2sgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgIHJldHVybiByZWplY3QoZSk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIHdyYXBwZWRQcm9ncmVzc2JhY2sgPSBmdW5jdGlvbihwcm9ncmVzcykgewogICAgICB0cnkgewogICAgICAgIHJldHVybiAoaXNGdW5jdGlvbihwcm9ncmVzc2JhY2spID8gcHJvZ3Jlc3NiYWNrIDogZGVmYXVsdENhbGxiYWNrKShwcm9ncmVzcyk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICB9CiAgICB9OwoKICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICByZWYodmFsdWUpLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgIHJlc3VsdC5yZXNvbHZlKHJlZih2YWx1ZSkudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrLCB3cmFwcGVkUHJvZ3Jlc3NiYWNrKSk7CiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgcmVzdWx0LnJlc29sdmUod3JhcHBlZEVycmJhY2socmVhc29uKSk7CiAgICAgIH0sIGZ1bmN0aW9uKHByb2dyZXNzKSB7CiAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICByZXN1bHQubm90aWZ5KHdyYXBwZWRQcm9ncmVzc2JhY2socHJvZ3Jlc3MpKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgfTsKCgogIGZ1bmN0aW9uIGRlZmF1bHRDYWxsYmFjayh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KCgogIGZ1bmN0aW9uIGRlZmF1bHRFcnJiYWNrKHJlYXNvbikgewogICAgcmV0dXJuIHJlamVjdChyZWFzb24pOwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcSNhbGwKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ29tYmluZXMgbXVsdGlwbGUgcHJvbWlzZXMgaW50byBhIHNpbmdsZSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgd2hlbiBhbGwgb2YgdGhlIGlucHV0CiAgICogcHJvbWlzZXMgYXJlIHJlc29sdmVkLgogICAqCiAgICogQHBhcmFtIHtBcnJheS48UHJvbWlzZT58T2JqZWN0LjxQcm9taXNlPn0gcHJvbWlzZXMgQW4gYXJyYXkgb3IgaGFzaCBvZiBwcm9taXNlcy4KICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHNpbmdsZSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIGFuIGFycmF5L2hhc2ggb2YgdmFsdWVzLAogICAqICAgZWFjaCB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBwcm9taXNlIGF0IHRoZSBzYW1lIGluZGV4L2tleSBpbiB0aGUgYHByb21pc2VzYCBhcnJheS9oYXNoLgogICAqICAgSWYgYW55IG9mIHRoZSBwcm9taXNlcyBpcyByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLCB0aGlzIHJlc3VsdGluZyBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQKICAgKiAgIHdpdGggdGhlIHNhbWUgcmVqZWN0aW9uIHZhbHVlLgogICAqLwogIGZ1bmN0aW9uIGFsbChwcm9taXNlcykgewogICAgdmFyIGRlZmVycmVkID0gZGVmZXIoKSwKICAgICAgICBjb3VudGVyID0gMCwKICAgICAgICByZXN1bHRzID0gaXNBcnJheShwcm9taXNlcykgPyBbXSA6IHt9OwoKICAgIGZvckVhY2gocHJvbWlzZXMsIGZ1bmN0aW9uKHByb21pc2UsIGtleSkgewogICAgICBjb3VudGVyKys7CiAgICAgIHJlZihwcm9taXNlKS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHJlc3VsdHMuaGFzT3duUHJvcGVydHkoa2V5KSkgcmV0dXJuOwogICAgICAgIHJlc3VsdHNba2V5XSA9IHZhbHVlOwogICAgICAgIGlmICghKC0tY291bnRlcikpIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIGlmIChyZXN1bHRzLmhhc093blByb3BlcnR5KGtleSkpIHJldHVybjsKICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBpZiAoY291bnRlciA9PT0gMCkgewogICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgfQoKICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogIH0KCiAgcmV0dXJuIHsKICAgIGRlZmVyOiBkZWZlciwKICAgIHJlamVjdDogcmVqZWN0LAogICAgd2hlbjogd2hlbiwKICAgIGFsbDogYWxsCiAgfTsKfQoKZnVuY3Rpb24gJCRSQUZQcm92aWRlcigpeyAvL3JBRgogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckdGltZW91dCcsIGZ1bmN0aW9uKCR3aW5kb3csICR0aW1lb3V0KSB7CiAgICB2YXIgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gJHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICAgIHZhciBjYW5jZWxBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cud2Via2l0Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cud2Via2l0Q2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICAgIHZhciByYWZTdXBwb3J0ZWQgPSAhIXJlcXVlc3RBbmltYXRpb25GcmFtZTsKICAgIHZhciByYWYgPSByYWZTdXBwb3J0ZWQKICAgICAgPyBmdW5jdGlvbihmbikgewogICAgICAgICAgdmFyIGlkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZuKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoaWQpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIDogZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIHZhciB0aW1lciA9ICR0aW1lb3V0KGZuLCAxNi42NiwgZmFsc2UpOyAvLyAxMDAwIC8gNjAgPSAxNi42NjYKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHRpbWVvdXQuY2FuY2VsKHRpbWVyKTsKICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICByYWYuc3VwcG9ydGVkID0gcmFmU3VwcG9ydGVkOwoKICAgIHJldHVybiByYWY7CiAgfV07Cn0KCi8qKgogKiBERVNJR04gTk9URVMKICoKICogVGhlIGRlc2lnbiBkZWNpc2lvbnMgYmVoaW5kIHRoZSBzY29wZSBhcmUgaGVhdmlseSBmYXZvcmVkIGZvciBzcGVlZCBhbmQgbWVtb3J5IGNvbnN1bXB0aW9uLgogKgogKiBUaGUgdHlwaWNhbCB1c2Ugb2Ygc2NvcGUgaXMgdG8gd2F0Y2ggdGhlIGV4cHJlc3Npb25zLCB3aGljaCBtb3N0IG9mIHRoZSB0aW1lIHJldHVybiB0aGUgc2FtZQogKiB2YWx1ZSBhcyBsYXN0IHRpbWUgc28gd2Ugb3B0aW1pemUgdGhlIG9wZXJhdGlvbi4KICoKICogQ2xvc3VyZXMgY29uc3RydWN0aW9uIGlzIGV4cGVuc2l2ZSBpbiB0ZXJtcyBvZiBzcGVlZCBhcyB3ZWxsIGFzIG1lbW9yeToKICogICAtIE5vIGNsb3N1cmVzLCBpbnN0ZWFkIHVzZSBwcm90b3R5cGljYWwgaW5oZXJpdGFuY2UgZm9yIEFQSQogKiAgIC0gSW50ZXJuYWwgc3RhdGUgbmVlZHMgdG8gYmUgc3RvcmVkIG9uIHNjb3BlIGRpcmVjdGx5LCB3aGljaCBtZWFucyB0aGF0IHByaXZhdGUgc3RhdGUgaXMKICogICAgIGV4cG9zZWQgYXMgJCRfX19fIHByb3BlcnRpZXMKICoKICogTG9vcCBvcGVyYXRpb25zIGFyZSBvcHRpbWl6ZWQgYnkgdXNpbmcgd2hpbGUoY291bnQtLSkgeyAuLi4gfQogKiAgIC0gdGhpcyBtZWFucyB0aGF0IGluIG9yZGVyIHRvIGtlZXAgdGhlIHNhbWUgb3JkZXIgb2YgZXhlY3V0aW9uIGFzIGFkZGl0aW9uIHdlIGhhdmUgdG8gYWRkCiAqICAgICBpdGVtcyB0byB0aGUgYXJyYXkgYXQgdGhlIGJlZ2lubmluZyAodW5zaGlmdCkgaW5zdGVhZCBvZiBhdCB0aGUgZW5kIChwdXNoKQogKgogKiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgYW5kIHJlbW92ZWQgb2Z0ZW4KICogICAtIFVzaW5nIGFuIGFycmF5IHdvdWxkIGJlIHNsb3cgc2luY2UgaW5zZXJ0cyBpbiBtaWRkbGUgYXJlIGV4cGVuc2l2ZSBzbyB3ZSB1c2UgbGlua2VkIGxpc3QKICoKICogVGhlcmUgYXJlIGZldyB3YXRjaGVzIHRoZW4gYSBsb3Qgb2Ygb2JzZXJ2ZXJzLiBUaGlzIGlzIHdoeSB5b3UgZG9uJ3Qgd2FudCB0aGUgb2JzZXJ2ZXIgdG8gYmUKICogaW1wbGVtZW50ZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHdhdGNoLiBXYXRjaCByZXF1aXJlcyByZXR1cm4gb2YgaW5pdGlhbGl6YXRpb24gZnVuY3Rpb24gd2hpY2gKICogYXJlIGV4cGVuc2l2ZSB0byBjb25zdHJ1Y3QuCiAqLwoKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJHJvb3RTY29wZVByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBQcm92aWRlciBmb3IgdGhlICRyb290U2NvcGUgc2VydmljZS4KICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcm9vdFNjb3BlUHJvdmlkZXIjZGlnZXN0VHRsCiAqIEBkZXNjcmlwdGlvbgogKgogKiBTZXRzIHRoZSBudW1iZXIgb2YgYCRkaWdlc3RgIGl0ZXJhdGlvbnMgdGhlIHNjb3BlIHNob3VsZCBhdHRlbXB0IHRvIGV4ZWN1dGUgYmVmb3JlIGdpdmluZyB1cCBhbmQKICogYXNzdW1pbmcgdGhhdCB0aGUgbW9kZWwgaXMgdW5zdGFibGUuCiAqCiAqIFRoZSBjdXJyZW50IGRlZmF1bHQgaXMgMTAgaXRlcmF0aW9ucy4KICoKICogSW4gY29tcGxleCBhcHBsaWNhdGlvbnMgaXQncyBwb3NzaWJsZSB0aGF0IHRoZSBkZXBlbmRlbmNpZXMgYmV0d2VlbiBgJHdhdGNoYHMgd2lsbCByZXN1bHQgaW4KICogc2V2ZXJhbCBkaWdlc3QgaXRlcmF0aW9ucy4gSG93ZXZlciBpZiBhbiBhcHBsaWNhdGlvbiBuZWVkcyBtb3JlIHRoYW4gdGhlIGRlZmF1bHQgMTAgZGlnZXN0CiAqIGl0ZXJhdGlvbnMgZm9yIGl0cyBtb2RlbCB0byBzdGFiaWxpemUgdGhlbiB5b3Ugc2hvdWxkIGludmVzdGlnYXRlIHdoYXQgaXMgY2F1c2luZyB0aGUgbW9kZWwgdG8KICogY29udGludW91c2x5IGNoYW5nZSBkdXJpbmcgdGhlIGRpZ2VzdC4KICoKICogSW5jcmVhc2luZyB0aGUgVFRMIGNvdWxkIGhhdmUgcGVyZm9ybWFuY2UgaW1wbGljYXRpb25zLCBzbyB5b3Ugc2hvdWxkIG5vdCBjaGFuZ2UgaXQgd2l0aG91dAogKiBwcm9wZXIganVzdGlmaWNhdGlvbi4KICoKICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IFRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMuCiAqLwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkcm9vdFNjb3BlCiAqIEBkZXNjcmlwdGlvbgogKgogKiBFdmVyeSBhcHBsaWNhdGlvbiBoYXMgYSBzaW5nbGUgcm9vdCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAqIEFsbCBvdGhlciBzY29wZXMgYXJlIGRlc2NlbmRhbnQgc2NvcGVzIG9mIHRoZSByb290IHNjb3BlLiBTY29wZXMgcHJvdmlkZSBzZXBhcmF0aW9uCiAqIGJldHdlZW4gdGhlIG1vZGVsIGFuZCB0aGUgdmlldywgdmlhIGEgbWVjaGFuaXNtIGZvciB3YXRjaGluZyB0aGUgbW9kZWwgZm9yIGNoYW5nZXMuCiAqIFRoZXkgYWxzbyBwcm92aWRlIGFuIGV2ZW50IGVtaXNzaW9uL2Jyb2FkY2FzdCBhbmQgc3Vic2NyaXB0aW9uIGZhY2lsaXR5LiBTZWUgdGhlCiAqIHtAbGluayBndWlkZS9zY29wZSBkZXZlbG9wZXIgZ3VpZGUgb24gc2NvcGVzfS4KICovCmZ1bmN0aW9uICRSb290U2NvcGVQcm92aWRlcigpewogIHZhciBUVEwgPSAxMDsKICB2YXIgJHJvb3RTY29wZU1pbkVyciA9IG1pbkVycignJHJvb3RTY29wZScpOwogIHZhciBsYXN0RGlydHlXYXRjaCA9IG51bGw7CgogIHRoaXMuZGlnZXN0VHRsID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIFRUTCA9IHZhbHVlOwogICAgfQogICAgcmV0dXJuIFRUTDsKICB9OwoKICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckcGFyc2UnLCAnJGJyb3dzZXInLAogICAgICBmdW5jdGlvbiggJGluamVjdG9yLCAgICRleGNlcHRpb25IYW5kbGVyLCAgICRwYXJzZSwgICAkYnJvd3NlcikgewoKICAgIC8qKgogICAgICogQG5nZG9jIHR5cGUKICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgcm9vdCBzY29wZSBjYW4gYmUgcmV0cmlldmVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZSAkcm9vdFNjb3BlfSBrZXkgZnJvbSB0aGUKICAgICAqIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgdXNpbmcgdGhlCiAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3ICRuZXcoKX0gbWV0aG9kLiAoTW9zdCBzY29wZXMgYXJlIGNyZWF0ZWQgYXV0b21hdGljYWxseSB3aGVuCiAgICAgKiBjb21waWxlZCBIVE1MIHRlbXBsYXRlIGlzIGV4ZWN1dGVkLikKICAgICAqCiAgICAgKiBIZXJlIGlzIGEgc2ltcGxlIHNjb3BlIHNuaXBwZXQgdG8gc2hvdyBob3cgeW91IGNhbiBpbnRlcmFjdCB3aXRoIHRoZSBzY29wZS4KICAgICAqIGBgYGh0bWwKICAgICAqIDxmaWxlIHNyYz0iLi90ZXN0L25nL3Jvb3RTY29wZVNwZWMuanMiIHRhZz0iZG9jczEiIC8+CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiAjIEluaGVyaXRhbmNlCiAgICAgKiBBIHNjb3BlIGNhbiBpbmhlcml0IGZyb20gYSBwYXJlbnQgc2NvcGUsIGFzIGluIHRoaXMgZXhhbXBsZToKICAgICAqIGBgYGpzCiAgICAgICAgIHZhciBwYXJlbnQgPSAkcm9vdFNjb3BlOwogICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnQuJG5ldygpOwoKICAgICAgICAgcGFyZW50LnNhbHV0YXRpb24gPSAiSGVsbG8iOwogICAgICAgICBjaGlsZC5uYW1lID0gIldvcmxkIjsKICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ0hlbGxvJyk7CgogICAgICAgICBjaGlsZC5zYWx1dGF0aW9uID0gIldlbGNvbWUiOwogICAgICAgICBleHBlY3QoY2hpbGQuc2FsdXRhdGlvbikudG9FcXVhbCgnV2VsY29tZScpOwogICAgICAgICBleHBlY3QocGFyZW50LnNhbHV0YXRpb24pLnRvRXF1YWwoJ0hlbGxvJyk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24oKT49fSBwcm92aWRlcnMgTWFwIG9mIHNlcnZpY2UgZmFjdG9yeSB3aGljaCBuZWVkIHRvIGJlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkIGZvciB0aGUgY3VycmVudCBzY29wZS4gRGVmYXVsdHMgdG8ge0BsaW5rIG5nfS4KICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsICo+PX0gaW5zdGFuY2VDYWNoZSBQcm92aWRlcyBwcmUtaW5zdGFudGlhdGVkIHNlcnZpY2VzIHdoaWNoIHNob3VsZAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBlbmQvb3ZlcnJpZGUgc2VydmljZXMgcHJvdmlkZWQgYnkgYHByb3ZpZGVyc2AuIFRoaXMgaXMgaGFuZHkKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hlbiB1bml0LXRlc3RpbmcgYW5kIGhhdmluZyB0aGUgbmVlZCB0byBvdmVycmlkZSBhIGRlZmF1bHQKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE5ld2x5IGNyZWF0ZWQgc2NvcGUuCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiBTY29wZSgpIHsKICAgICAgdGhpcy4kaWQgPSBuZXh0VWlkKCk7CiAgICAgIHRoaXMuJCRwaGFzZSA9IHRoaXMuJHBhcmVudCA9IHRoaXMuJCR3YXRjaGVycyA9CiAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRuZXh0U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZyA9CiAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgdGhpc1sndGhpcyddID0gdGhpcy4kcm9vdCA9ICB0aGlzOwogICAgICB0aGlzLiQkZGVzdHJveWVkID0gZmFsc2U7CiAgICAgIHRoaXMuJCRhc3luY1F1ZXVlID0gW107CiAgICAgIHRoaXMuJCRwb3N0RGlnZXN0UXVldWUgPSBbXTsKICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwogICAgICB0aGlzLiQkbGlzdGVuZXJDb3VudCA9IHt9OwogICAgICB0aGlzLiQkaXNvbGF0ZUJpbmRpbmdzID0ge307CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGlkCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBVbmlxdWUgc2NvcGUgSUQgKG1vbm90b25pY2FsbHkgaW5jcmVhc2luZyBhbHBoYW51bWVyaWMgc2VxdWVuY2UpIHVzZWZ1bCBmb3IKICAgICAqICAgZGVidWdnaW5nLgogICAgICovCgoKICAgIFNjb3BlLnByb3RvdHlwZSA9IHsKICAgICAgY29uc3RydWN0b3I6IFNjb3BlLAogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRuZXcKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgKgogICAgICAgKiBUaGUgcGFyZW50IHNjb3BlIHdpbGwgcHJvcGFnYXRlIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZQogICAgICAgKiBzY29wZSBoaWVyYXJjaHkgdXNpbmcge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kgJGRlc3Ryb3koKX0uCiAgICAgICAqCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcwogICAgICAgKiBkZXNpcmVkIGZvciB0aGUgc2NvcGUgYW5kIGl0cyBjaGlsZCBzY29wZXMgdG8gYmUgcGVybWFuZW50bHkgZGV0YWNoZWQgZnJvbSB0aGUgcGFyZW50IGFuZAogICAgICAgKiB0aHVzIHN0b3AgcGFydGljaXBhdGluZyBpbiBtb2RlbCBjaGFuZ2UgZGV0ZWN0aW9uIGFuZCBsaXN0ZW5lciBub3RpZmljYXRpb24gYnkgaW52b2tpbmcuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNvbGF0ZSBJZiB0cnVlLCB0aGVuIHRoZSBzY29wZSBkb2VzIG5vdCBwcm90b3R5cGljYWxseSBpbmhlcml0IGZyb20gdGhlCiAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgKiAgICAgICAgIFdoZW4gY3JlYXRpbmcgd2lkZ2V0cywgaXQgaXMgdXNlZnVsIGZvciB0aGUgd2lkZ2V0IHRvIG5vdCBhY2NpZGVudGFsbHkgcmVhZCBwYXJlbnQKICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICoKICAgICAgICogQHJldHVybnMge09iamVjdH0gVGhlIG5ld2x5IGNyZWF0ZWQgY2hpbGQgc2NvcGUuCiAgICAgICAqCiAgICAgICAqLwogICAgICAkbmV3OiBmdW5jdGlvbihpc29sYXRlKSB7CiAgICAgICAgdmFyIENoaWxkU2NvcGUsCiAgICAgICAgICAgIGNoaWxkOwoKICAgICAgICBpZiAoaXNvbGF0ZSkgewogICAgICAgICAgY2hpbGQgPSBuZXcgU2NvcGUoKTsKICAgICAgICAgIGNoaWxkLiRyb290ID0gdGhpcy4kcm9vdDsKICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IHRoZXJlIGlzIGp1c3Qgb25lIGFzeW5jIHF1ZXVlIHBlciAkcm9vdFNjb3BlIGFuZCBpdHMgY2hpbGRyZW4KICAgICAgICAgIGNoaWxkLiQkYXN5bmNRdWV1ZSA9IHRoaXMuJCRhc3luY1F1ZXVlOwogICAgICAgICAgY2hpbGQuJCRwb3N0RGlnZXN0UXVldWUgPSB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBPbmx5IGNyZWF0ZSBhIGNoaWxkIHNjb3BlIGNsYXNzIGlmIHNvbWVib2R5IGFza3MgZm9yIG9uZSwKICAgICAgICAgIC8vIGJ1dCBjYWNoZSBpdCB0byBhbGxvdyB0aGUgVk0gdG8gb3B0aW1pemUgbG9va3Vwcy4KICAgICAgICAgIGlmICghdGhpcy4kJGNoaWxkU2NvcGVDbGFzcykgewogICAgICAgICAgICB0aGlzLiQkY2hpbGRTY29wZUNsYXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhpcy4kJHdhdGNoZXJzID0gdGhpcy4kJG5leHRTaWJsaW5nID0KICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkSGVhZCA9IHRoaXMuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgIHRoaXMuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJDb3VudCA9IHt9OwogICAgICAgICAgICAgIHRoaXMuJGlkID0gbmV4dFVpZCgpOwogICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFNjb3BlQ2xhc3MgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLiQkY2hpbGRTY29wZUNsYXNzLnByb3RvdHlwZSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBjaGlsZCA9IG5ldyB0aGlzLiQkY2hpbGRTY29wZUNsYXNzKCk7CiAgICAgICAgfQogICAgICAgIGNoaWxkWyd0aGlzJ10gPSBjaGlsZDsKICAgICAgICBjaGlsZC4kcGFyZW50ID0gdGhpczsKICAgICAgICBjaGlsZC4kJHByZXZTaWJsaW5nID0gdGhpcy4kJGNoaWxkVGFpbDsKICAgICAgICBpZiAodGhpcy4kJGNoaWxkSGVhZCkgewogICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbC4kJG5leHRTaWJsaW5nID0gY2hpbGQ7CiAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJHdhdGNoCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBSZWdpc3RlcnMgYSBgbGlzdGVuZXJgIGNhbGxiYWNrIHRvIGJlIGV4ZWN1dGVkIHdoZW5ldmVyIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjaGFuZ2VzLgogICAgICAgKgogICAgICAgKiAtIFRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBjYWxsZWQgb24gZXZlcnkgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAqICAgJGRpZ2VzdCgpfSBhbmQgc2hvdWxkIHJldHVybiB0aGUgdmFsdWUgdGhhdCB3aWxsIGJlIHdhdGNoZWQuIChTaW5jZQogICAgICAgKiAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSByZXJ1bnMgd2hlbiBpdCBkZXRlY3RzIGNoYW5nZXMgdGhlCiAgICAgICAqICAgYHdhdGNoRXhwcmVzc2lvbmAgY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyCiAgICAgICAqICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZCBzaG91bGQgYmUgaWRlbXBvdGVudC4pCiAgICAgICAqIC0gVGhlIGBsaXN0ZW5lcmAgaXMgY2FsbGVkIG9ubHkgd2hlbiB0aGUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCBgd2F0Y2hFeHByZXNzaW9uYCBhbmQgdGhlCiAgICAgICAqICAgcHJldmlvdXMgY2FsbCB0byBgd2F0Y2hFeHByZXNzaW9uYCBhcmUgbm90IGVxdWFsICh3aXRoIHRoZSBleGNlcHRpb24gb2YgdGhlIGluaXRpYWwgcnVuLAogICAgICAgKiAgIHNlZSBiZWxvdykuIEluZXF1YWxpdHkgaXMgZGV0ZXJtaW5lZCBhY2NvcmRpbmcgdG8gcmVmZXJlbmNlIGluZXF1YWxpdHksCiAgICAgICAqICAgW3N0cmljdCBjb21wYXJpc29uXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9PcGVyYXRvcnMvQ29tcGFyaXNvbl9PcGVyYXRvcnMpCiAgICAgICAqICAgIHZpYSB0aGUgYCE9PWAgSmF2YXNjcmlwdCBvcGVyYXRvciwgdW5sZXNzIGBvYmplY3RFcXVhbGl0eSA9PSB0cnVlYAogICAgICAgKiAgIChzZWUgbmV4dCBwb2ludCkKICAgICAgICogLSBXaGVuIGBvYmplY3RFcXVhbGl0eSA9PSB0cnVlYCwgaW5lcXVhbGl0eSBvZiB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgaXMgZGV0ZXJtaW5lZAogICAgICAgKiAgIGFjY29yZGluZyB0byB0aGUge0BsaW5rIGFuZ3VsYXIuZXF1YWxzfSBmdW5jdGlvbi4gVG8gc2F2ZSB0aGUgdmFsdWUgb2YgdGhlIG9iamVjdCBmb3IKICAgICAgICogICBsYXRlciBjb21wYXJpc29uLCB0aGUge0BsaW5rIGFuZ3VsYXIuY29weX0gZnVuY3Rpb24gaXMgdXNlZC4gVGhpcyB0aGVyZWZvcmUgbWVhbnMgdGhhdAogICAgICAgKiAgIHdhdGNoaW5nIGNvbXBsZXggb2JqZWN0cyB3aWxsIGhhdmUgYWR2ZXJzZSBtZW1vcnkgYW5kIHBlcmZvcm1hbmNlIGltcGxpY2F0aW9ucy4KICAgICAgICogLSBUaGUgd2F0Y2ggYGxpc3RlbmVyYCBtYXkgY2hhbmdlIHRoZSBtb2RlbCwgd2hpY2ggbWF5IHRyaWdnZXIgb3RoZXIgYGxpc3RlbmVyYHMgdG8gZmlyZS4KICAgICAgICogICBUaGlzIGlzIGFjaGlldmVkIGJ5IHJlcnVubmluZyB0aGUgd2F0Y2hlcnMgdW50aWwgbm8gY2hhbmdlcyBhcmUgZGV0ZWN0ZWQuIFRoZSByZXJ1bgogICAgICAgKiAgIGl0ZXJhdGlvbiBsaW1pdCBpcyAxMCB0byBwcmV2ZW50IGFuIGluZmluaXRlIGxvb3AgZGVhZGxvY2suCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gaXMgY2FsbGVkLAogICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aCBubyBgbGlzdGVuZXJgLiAoU2luY2UgYHdhdGNoRXhwcmVzc2lvbmAKICAgICAgICogY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUgd2hlbiBhCiAgICAgICAqIGNoYW5nZSBpcyBkZXRlY3RlZCwgYmUgcHJlcGFyZWQgZm9yIG11bHRpcGxlIGNhbGxzIHRvIHlvdXIgbGlzdGVuZXIuKQogICAgICAgKgogICAgICAgKiBBZnRlciBhIHdhdGNoZXIgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBzY29wZSwgdGhlIGBsaXN0ZW5lcmAgZm4gaXMgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgICAqICh2aWEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWxBc3luYyAkZXZhbEFzeW5jfSkgdG8gaW5pdGlhbGl6ZSB0aGUKICAgICAgICogd2F0Y2hlci4gSW4gcmFyZSBjYXNlcywgdGhpcyBpcyB1bmRlc2lyYWJsZSBiZWNhdXNlIHRoZSBsaXN0ZW5lciBpcyBjYWxsZWQgd2hlbiB0aGUgcmVzdWx0CiAgICAgICAqIG9mIGB3YXRjaEV4cHJlc3Npb25gIGRpZG4ndCBjaGFuZ2UuIFRvIGRldGVjdCB0aGlzIHNjZW5hcmlvIHdpdGhpbiB0aGUgYGxpc3RlbmVyYCBmbiwgeW91CiAgICAgICAqIGNhbiBjb21wYXJlIHRoZSBgbmV3VmFsYCBhbmQgYG9sZFZhbGAuIElmIHRoZXNlIHR3byB2YWx1ZXMgYXJlIGlkZW50aWNhbCAoYD09PWApIHRoZW4gdGhlCiAgICAgICAqIGxpc3RlbmVyIHdhcyBjYWxsZWQgZHVlIHRvIGluaXRpYWxpemF0aW9uLgogICAgICAgKgogICAgICAgKiBUaGUgZXhhbXBsZSBiZWxvdyBjb250YWlucyBhbiBpbGx1c3RyYXRpb24gb2YgdXNpbmcgYSBmdW5jdGlvbiBhcyB5b3VyICR3YXRjaCBsaXN0ZW5lcgogICAgICAgKgogICAgICAgKgogICAgICAgKiAjIEV4YW1wbGUKICAgICAgICogYGBganMKICAgICAgICAgICAvLyBsZXQncyBhc3N1bWUgdGhhdCBzY29wZSB3YXMgZGVwZW5kZW5jeSBpbmplY3RlZCBhcyB0aGUgJHJvb3RTY29wZQogICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGU7CiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOwogICAgICAgICAgIH0pOwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgLy8gdGhlIGxpc3RlbmVyIGlzIGFsd2F5cyBjYWxsZWQgZHVyaW5nIHRoZSBmaXJzdCAkZGlnZXN0IGxvb3AgYWZ0ZXIgaXQgd2FzIHJlZ2lzdGVyZWQKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIC8vIGJ1dCBub3cgaXQgd2lsbCBub3QgYmUgY2FsbGVkIHVubGVzcyB0aGUgdmFsdWUgY2hhbmdlcwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgyKTsKCgoKICAgICAgICAgICAvLyBVc2luZyBhIGxpc3RlbmVyIGZ1bmN0aW9uCiAgICAgICAgICAgdmFyIGZvb2Q7CiAgICAgICAgICAgc2NvcGUuZm9vZENvdW50ZXIgPSAwOwogICAgICAgICAgIGV4cGVjdChzY29wZS5mb29kQ291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBsaXN0ZW5lciBmdW5jdGlvbgogICAgICAgICAgICAgZnVuY3Rpb24oKSB7IHJldHVybiBmb29kOyB9LAogICAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgY2hhbmdlIGhhbmRsZXIKICAgICAgICAgICAgIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICBpZiAoIG5ld1ZhbHVlICE9PSBvbGRWYWx1ZSApIHsKICAgICAgICAgICAgICAgICAvLyBPbmx5IGluY3JlbWVudCB0aGUgY291bnRlciBpZiB0aGUgdmFsdWUgY2hhbmdlZAogICAgICAgICAgICAgICAgIHNjb3BlLmZvb2RDb3VudGVyID0gc2NvcGUuZm9vZENvdW50ZXIgKyAxOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgICB9CiAgICAgICAgICAgKTsKICAgICAgICAgICAvLyBObyBkaWdlc3QgaGFzIGJlZW4gcnVuIHNvIHRoZSBjb3VudGVyIHdpbGwgYmUgemVybwogICAgICAgICAgIGV4cGVjdChzY29wZS5mb29kQ291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgLy8gUnVuIHRoZSBkaWdlc3QgYnV0IHNpbmNlIGZvb2QgaGFzIG5vdCBjaGFuZ2VkIGNvdW50IHdpbGwgc3RpbGwgYmUgemVybwogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIC8vIFVwZGF0ZSBmb29kIGFuZCBydW4gZGlnZXN0LiAgTm93IHRoZSBjb3VudGVyIHdpbGwgaW5jcmVtZW50CiAgICAgICAgICAgZm9vZCA9ICdjaGVlc2VidXJnZXInOwogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICoKICAgICAgICoKICAgICAgICogQHBhcmFtIHsoZnVuY3Rpb24oKXxzdHJpbmcpfSB3YXRjaEV4cHJlc3Npb24gRXhwcmVzc2lvbiB0aGF0IGlzIGV2YWx1YXRlZCBvbiBlYWNoCiAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEEgY2hhbmdlIGluIHRoZSByZXR1cm4gdmFsdWUgdHJpZ2dlcnMKICAgICAgICogICAgYSBjYWxsIHRvIHRoZSBgbGlzdGVuZXJgLgogICAgICAgKgogICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBgc2NvcGVgIGFzIGEgcGFyYW1ldGVyLgogICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyk9fSBsaXN0ZW5lciBDYWxsYmFjayBjYWxsZWQgd2hlbmV2ZXIgdGhlIHJldHVybiB2YWx1ZSBvZgogICAgICAgKiAgIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjaGFuZ2VzLgogICAgICAgKgogICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICogICAgLSBgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlLCBzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZXMgYXMKICAgICAgICogICAgICBwYXJhbWV0ZXJzLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvYmplY3RFcXVhbGl0eSBDb21wYXJlIGZvciBvYmplY3QgZXF1YWxpdHkgdXNpbmcge0BsaW5rIGFuZ3VsYXIuZXF1YWxzfSBpbnN0ZWFkIG9mCiAgICAgICAqICAgICBjb21wYXJpbmcgZm9yIHJlZmVyZW5jZSBlcXVhbGl0eS4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICovCiAgICAgICR3YXRjaDogZnVuY3Rpb24od2F0Y2hFeHAsIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSkgewogICAgICAgIHZhciBzY29wZSA9IHRoaXMsCiAgICAgICAgICAgIGdldCA9IGNvbXBpbGVUb0ZuKHdhdGNoRXhwLCAnd2F0Y2gnKSwKICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzLAogICAgICAgICAgICB3YXRjaGVyID0gewogICAgICAgICAgICAgIGZuOiBsaXN0ZW5lciwKICAgICAgICAgICAgICBsYXN0OiBpbml0V2F0Y2hWYWwsCiAgICAgICAgICAgICAgZ2V0OiBnZXQsCiAgICAgICAgICAgICAgZXhwOiB3YXRjaEV4cCwKICAgICAgICAgICAgICBlcTogISFvYmplY3RFcXVhbGl0eQogICAgICAgICAgICB9OwoKICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CgogICAgICAgIC8vIGluIHRoZSBjYXNlIHVzZXIgcGFzcyBzdHJpbmcsIHdlIG5lZWQgdG8gY29tcGlsZSBpdCwgZG8gd2UgcmVhbGx5IG5lZWQgdGhpcyA/CiAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgdmFyIGxpc3RlbkZuID0gY29tcGlsZVRvRm4obGlzdGVuZXIgfHwgbm9vcCwgJ2xpc3RlbmVyJyk7CiAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24obmV3VmFsLCBvbGRWYWwsIHNjb3BlKSB7bGlzdGVuRm4oc2NvcGUpO307CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHdhdGNoRXhwID09ICdzdHJpbmcnICYmIGdldC5jb25zdGFudCkgewogICAgICAgICAgdmFyIG9yaWdpbmFsRm4gPSB3YXRjaGVyLmZuOwogICAgICAgICAgd2F0Y2hlci5mbiA9IGZ1bmN0aW9uKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkgewogICAgICAgICAgICBvcmlnaW5hbEZuLmNhbGwodGhpcywgbmV3VmFsLCBvbGRWYWwsIHNjb3BlKTsKICAgICAgICAgICAgYXJyYXlSZW1vdmUoYXJyYXksIHdhdGNoZXIpOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGlmICghYXJyYXkpIHsKICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycyA9IFtdOwogICAgICAgIH0KICAgICAgICAvLyB3ZSB1c2UgdW5zaGlmdCBzaW5jZSB3ZSB1c2UgYSB3aGlsZSBsb29wIGluICRkaWdlc3QgZm9yIHNwZWVkLgogICAgICAgIC8vIHRoZSB3aGlsZSBsb29wIHJlYWRzIGluIHJldmVyc2Ugb3JkZXIuCiAgICAgICAgYXJyYXkudW5zaGlmdCh3YXRjaGVyKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGRlcmVnaXN0ZXJXYXRjaCgpIHsKICAgICAgICAgIGFycmF5UmVtb3ZlKGFycmF5LCB3YXRjaGVyKTsKICAgICAgICAgIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKICAgICAgICB9OwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJHdhdGNoQ29sbGVjdGlvbgogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hhbGxvdyB3YXRjaGVzIHRoZSBwcm9wZXJ0aWVzIG9mIGFuIG9iamVjdCBhbmQgZmlyZXMgd2hlbmV2ZXIgYW55IG9mIHRoZSBwcm9wZXJ0aWVzIGNoYW5nZQogICAgICAgKiAoZm9yIGFycmF5cywgdGhpcyBpbXBsaWVzIHdhdGNoaW5nIHRoZSBhcnJheSBpdGVtczsgZm9yIG9iamVjdCBtYXBzLCB0aGlzIGltcGxpZXMgd2F0Y2hpbmcKICAgICAgICogdGhlIHByb3BlcnRpZXMpLiBJZiBhIGNoYW5nZSBpcyBkZXRlY3RlZCwgdGhlIGBsaXN0ZW5lcmAgY2FsbGJhY2sgaXMgZmlyZWQuCiAgICAgICAqCiAgICAgICAqIC0gVGhlIGBvYmpgIGNvbGxlY3Rpb24gaXMgb2JzZXJ2ZWQgdmlhIHN0YW5kYXJkICR3YXRjaCBvcGVyYXRpb24gYW5kIGlzIGV4YW1pbmVkIG9uIGV2ZXJ5CiAgICAgICAqICAgY2FsbCB0byAkZGlnZXN0KCkgdG8gc2VlIGlmIGFueSBpdGVtcyBoYXZlIGJlZW4gYWRkZWQsIHJlbW92ZWQsIG9yIG1vdmVkLgogICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCB3aGVuZXZlciBhbnl0aGluZyB3aXRoaW4gdGhlIGBvYmpgIGhhcyBjaGFuZ2VkLiBFeGFtcGxlcyBpbmNsdWRlCiAgICAgICAqICAgYWRkaW5nLCByZW1vdmluZywgYW5kIG1vdmluZyBpdGVtcyBiZWxvbmdpbmcgdG8gYW4gb2JqZWN0IG9yIGFycmF5LgogICAgICAgKgogICAgICAgKgogICAgICAgKiAjIEV4YW1wbGUKICAgICAgICogYGBganMKICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsnaWdvcicsICdtYXRpYXMnLCAnbWlza28nLCAnamFtZXMnXTsKICAgICAgICAgICRzY29wZS5kYXRhQ291bnQgPSA0OwoKICAgICAgICAgICRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKCduYW1lcycsIGZ1bmN0aW9uKG5ld05hbWVzLCBvbGROYW1lcykgewogICAgICAgICAgICAkc2NvcGUuZGF0YUNvdW50ID0gbmV3TmFtZXMubGVuZ3RoOwogICAgICAgICAgfSk7CgogICAgICAgICAgZXhwZWN0KCRzY29wZS5kYXRhQ291bnQpLnRvRXF1YWwoNCk7CiAgICAgICAgICAkc2NvcGUuJGRpZ2VzdCgpOwoKICAgICAgICAgIC8vc3RpbGwgYXQgNCAuLi4gbm8gY2hhbmdlcwogICAgICAgICAgZXhwZWN0KCRzY29wZS5kYXRhQ291bnQpLnRvRXF1YWwoNCk7CgogICAgICAgICAgJHNjb3BlLm5hbWVzLnBvcCgpOwogICAgICAgICAgJHNjb3BlLiRkaWdlc3QoKTsKCiAgICAgICAgICAvL25vdyB0aGVyZSdzIGJlZW4gYSBjaGFuZ2UKICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDMpOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd8ZnVuY3Rpb24oc2NvcGUpfSBvYmogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LiBUaGUKICAgICAgICogICAgZXhwcmVzc2lvbiB2YWx1ZSBzaG91bGQgZXZhbHVhdGUgdG8gYW4gb2JqZWN0IG9yIGFuIGFycmF5IHdoaWNoIGlzIG9ic2VydmVkIG9uIGVhY2gKICAgICAgICogICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZS4gQW55IHNoYWxsb3cgY2hhbmdlIHdpdGhpbiB0aGUKICAgICAgICogICAgY29sbGVjdGlvbiB3aWxsIHRyaWdnZXIgYSBjYWxsIHRvIHRoZSBgbGlzdGVuZXJgLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKG5ld0NvbGxlY3Rpb24sIG9sZENvbGxlY3Rpb24sIHNjb3BlKX0gbGlzdGVuZXIgYSBjYWxsYmFjayBmdW5jdGlvbiBjYWxsZWQKICAgICAgICogICAgd2hlbiBhIGNoYW5nZSBpcyBkZXRlY3RlZC4KICAgICAgICogICAgLSBUaGUgYG5ld0NvbGxlY3Rpb25gIG9iamVjdCBpcyB0aGUgbmV3bHkgbW9kaWZpZWQgZGF0YSBvYnRhaW5lZCBmcm9tIHRoZSBgb2JqYCBleHByZXNzaW9uCiAgICAgICAqICAgIC0gVGhlIGBvbGRDb2xsZWN0aW9uYCBvYmplY3QgaXMgYSBjb3B5IG9mIHRoZSBmb3JtZXIgY29sbGVjdGlvbiBkYXRhLgogICAgICAgKiAgICAgIER1ZSB0byBwZXJmb3JtYW5jZSBjb25zaWRlcmF0aW9ucywgdGhlYG9sZENvbGxlY3Rpb25gIHZhbHVlIGlzIGNvbXB1dGVkIG9ubHkgaWYgdGhlCiAgICAgICAqICAgICAgYGxpc3RlbmVyYCBmdW5jdGlvbiBkZWNsYXJlcyB0d28gb3IgbW9yZSBhcmd1bWVudHMuCiAgICAgICAqICAgIC0gVGhlIGBzY29wZWAgYXJndW1lbnQgcmVmZXJzIHRvIHRoZSBjdXJyZW50IHNjb3BlLgogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlLXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4gV2hlbiB0aGUKICAgICAgICogICAgZGUtcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLCB0aGUgaW50ZXJuYWwgd2F0Y2ggb3BlcmF0aW9uIGlzIHRlcm1pbmF0ZWQuCiAgICAgICAqLwogICAgICAkd2F0Y2hDb2xsZWN0aW9uOiBmdW5jdGlvbihvYmosIGxpc3RlbmVyKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIC8vIHRoZSBjdXJyZW50IHZhbHVlLCB1cGRhdGVkIG9uIGVhY2ggZGlydHktY2hlY2sgcnVuCiAgICAgICAgdmFyIG5ld1ZhbHVlOwogICAgICAgIC8vIGEgc2hhbGxvdyBjb3B5IG9mIHRoZSBuZXdWYWx1ZSBmcm9tIHRoZSBsYXN0IGRpcnR5LWNoZWNrIHJ1biwKICAgICAgICAvLyB1cGRhdGVkIHRvIG1hdGNoIG5ld1ZhbHVlIGR1cmluZyBkaXJ0eS1jaGVjayBydW4KICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgLy8gYSBzaGFsbG93IGNvcHkgb2YgdGhlIG5ld1ZhbHVlIGZyb20gd2hlbiB0aGUgbGFzdCBjaGFuZ2UgaGFwcGVuZWQKICAgICAgICB2YXIgdmVyeU9sZFZhbHVlOwogICAgICAgIC8vIG9ubHkgdHJhY2sgdmVyeU9sZFZhbHVlIGlmIHRoZSBsaXN0ZW5lciBpcyBhc2tpbmcgZm9yIGl0CiAgICAgICAgdmFyIHRyYWNrVmVyeU9sZFZhbHVlID0gKGxpc3RlbmVyLmxlbmd0aCA+IDEpOwogICAgICAgIHZhciBjaGFuZ2VEZXRlY3RlZCA9IDA7CiAgICAgICAgdmFyIG9iakdldHRlciA9ICRwYXJzZShvYmopOwogICAgICAgIHZhciBpbnRlcm5hbEFycmF5ID0gW107CiAgICAgICAgdmFyIGludGVybmFsT2JqZWN0ID0ge307CiAgICAgICAgdmFyIGluaXRSdW4gPSB0cnVlOwogICAgICAgIHZhciBvbGRMZW5ndGggPSAwOwoKICAgICAgICBmdW5jdGlvbiAkd2F0Y2hDb2xsZWN0aW9uV2F0Y2goKSB7CiAgICAgICAgICBuZXdWYWx1ZSA9IG9iakdldHRlcihzZWxmKTsKICAgICAgICAgIHZhciBuZXdMZW5ndGgsIGtleTsKCiAgICAgICAgICBpZiAoIWlzT2JqZWN0KG5ld1ZhbHVlKSkgeyAvLyBpZiBwcmltaXRpdmUKICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgIG9sZFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5TGlrZShuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBpbnRlcm5hbEFycmF5KSB7CiAgICAgICAgICAgICAgLy8gd2UgYXJlIHRyYW5zaXRpb25pbmcgZnJvbSBzb21ldGhpbmcgd2hpY2ggd2FzIG5vdCBhbiBhcnJheSBpbnRvIGFycmF5LgogICAgICAgICAgICAgIG9sZFZhbHVlID0gaW50ZXJuYWxBcnJheTsKICAgICAgICAgICAgICBvbGRMZW5ndGggPSBvbGRWYWx1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0xlbmd0aCA9IG5ld1ZhbHVlLmxlbmd0aDsKCiAgICAgICAgICAgIGlmIChvbGRMZW5ndGggIT09IG5ld0xlbmd0aCkgewogICAgICAgICAgICAgIC8vIGlmIGxlbmd0aHMgZG8gbm90IG1hdGNoIHdlIG5lZWQgdG8gdHJpZ2dlciBjaGFuZ2Ugbm90aWZpY2F0aW9uCiAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICBvbGRWYWx1ZS5sZW5ndGggPSBvbGRMZW5ndGggPSBuZXdMZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gY29weSB0aGUgaXRlbXMgdG8gb2xkVmFsdWUgYW5kIGxvb2sgZm9yIGNoYW5nZXMuCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3TGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgYm90aE5hTiA9IChvbGRWYWx1ZVtpXSAhPT0gb2xkVmFsdWVbaV0pICYmCiAgICAgICAgICAgICAgICAgIChuZXdWYWx1ZVtpXSAhPT0gbmV3VmFsdWVbaV0pOwogICAgICAgICAgICAgIGlmICghYm90aE5hTiAmJiAob2xkVmFsdWVbaV0gIT09IG5ld1ZhbHVlW2ldKSkgewogICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgIG9sZFZhbHVlW2ldID0gbmV3VmFsdWVbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAob2xkVmFsdWUgIT09IGludGVybmFsT2JqZWN0KSB7CiAgICAgICAgICAgICAgLy8gd2UgYXJlIHRyYW5zaXRpb25pbmcgZnJvbSBzb21ldGhpbmcgd2hpY2ggd2FzIG5vdCBhbiBvYmplY3QgaW50byBvYmplY3QuCiAgICAgICAgICAgICAgb2xkVmFsdWUgPSBpbnRlcm5hbE9iamVjdCA9IHt9OwogICAgICAgICAgICAgIG9sZExlbmd0aCA9IDA7CiAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBjb3B5IHRoZSBpdGVtcyB0byBvbGRWYWx1ZSBhbmQgbG9vayBmb3IgY2hhbmdlcy4KICAgICAgICAgICAgbmV3TGVuZ3RoID0gMDsKICAgICAgICAgICAgZm9yIChrZXkgaW4gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBpZiAobmV3VmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgbmV3TGVuZ3RoKys7CiAgICAgICAgICAgICAgICBpZiAob2xkVmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICBpZiAob2xkVmFsdWVba2V5XSAhPT0gbmV3VmFsdWVba2V5XSkgewogICAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG9sZExlbmd0aCsrOwogICAgICAgICAgICAgICAgICBvbGRWYWx1ZVtrZXldID0gbmV3VmFsdWVba2V5XTsKICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZExlbmd0aCA+IG5ld0xlbmd0aCkgewogICAgICAgICAgICAgIC8vIHdlIHVzZWQgdG8gaGF2ZSBtb3JlIGtleXMsIG5lZWQgdG8gZmluZCB0aGVtIGFuZCBkZXN0cm95IHRoZW0uCiAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICBmb3Ioa2V5IGluIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkVmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhbmV3VmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICBvbGRMZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgZGVsZXRlIG9sZFZhbHVlW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hhbmdlRGV0ZWN0ZWQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiAkd2F0Y2hDb2xsZWN0aW9uQWN0aW9uKCkgewogICAgICAgICAgaWYgKGluaXRSdW4pIHsKICAgICAgICAgICAgaW5pdFJ1biA9IGZhbHNlOwogICAgICAgICAgICBsaXN0ZW5lcihuZXdWYWx1ZSwgbmV3VmFsdWUsIHNlbGYpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlzdGVuZXIobmV3VmFsdWUsIHZlcnlPbGRWYWx1ZSwgc2VsZik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gbWFrZSBhIGNvcHkgZm9yIHRoZSBuZXh0IHRpbWUgYSBjb2xsZWN0aW9uIGlzIGNoYW5nZWQKICAgICAgICAgIGlmICh0cmFja1ZlcnlPbGRWYWx1ZSkgewogICAgICAgICAgICBpZiAoIWlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgIC8vcHJpbWl0aXZlCiAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2UobmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0gbmV3IEFycmF5KG5ld1ZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdWYWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlW2ldID0gbmV3VmFsdWVbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgeyAvLyBpZiBvYmplY3QKICAgICAgICAgICAgICB2ZXJ5T2xkVmFsdWUgPSB7fTsKICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG5ld1ZhbHVlLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZVtrZXldID0gbmV3VmFsdWVba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLiR3YXRjaCgkd2F0Y2hDb2xsZWN0aW9uV2F0Y2gsICR3YXRjaENvbGxlY3Rpb25BY3Rpb24pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBQcm9jZXNzZXMgYWxsIG9mIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcnN9IG9mIHRoZSBjdXJyZW50IHNjb3BlIGFuZAogICAgICAgKiBpdHMgY2hpbGRyZW4uIEJlY2F1c2UgYSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcn0ncyBsaXN0ZW5lciBjYW4gY2hhbmdlCiAgICAgICAqIHRoZSBtb2RlbCwgdGhlIGAkZGlnZXN0KClgIGtlZXBzIGNhbGxpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30KICAgICAgICogdW50aWwgbm8gbW9yZSBsaXN0ZW5lcnMgYXJlIGZpcmluZy4gVGhpcyBtZWFucyB0aGF0IGl0IGlzIHBvc3NpYmxlIHRvIGdldCBpbnRvIGFuIGluZmluaXRlCiAgICAgICAqIGxvb3AuIFRoaXMgZnVuY3Rpb24gd2lsbCB0aHJvdyBgJ01heGltdW0gaXRlcmF0aW9uIGxpbWl0IGV4Y2VlZGVkLidgIGlmIHRoZSBudW1iZXIgb2YKICAgICAgICogaXRlcmF0aW9ucyBleGNlZWRzIDEwLgogICAgICAgKgogICAgICAgKiBVc3VhbGx5LCB5b3UgZG9uJ3QgY2FsbCBgJGRpZ2VzdCgpYCBkaXJlY3RseSBpbgogICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlciBjb250cm9sbGVyc30gb3IgaW4KICAgICAgICoge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogICAgICAgKiBJbnN0ZWFkLCB5b3Ugc2hvdWxkIGNhbGwge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseSgpfSAodHlwaWNhbGx5IGZyb20gd2l0aGluCiAgICAgICAqIGEge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9KSwgd2hpY2ggd2lsbCBmb3JjZSBhIGAkZGlnZXN0KClgLgogICAgICAgKgogICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciBgJGRpZ2VzdCgpYCBpcyBjYWxsZWQsCiAgICAgICAqIHlvdSBjYW4gcmVnaXN0ZXIgYSBgd2F0Y2hFeHByZXNzaW9uYCBmdW5jdGlvbiB3aXRoCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCAkd2F0Y2goKX0gd2l0aCBubyBgbGlzdGVuZXJgLgogICAgICAgKgogICAgICAgKiBJbiB1bml0IHRlc3RzLCB5b3UgbWF5IG5lZWQgdG8gY2FsbCBgJGRpZ2VzdCgpYCB0byBzaW11bGF0ZSB0aGUgc2NvcGUgbGlmZSBjeWNsZS4KICAgICAgICoKICAgICAgICogIyBFeGFtcGxlCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnbWlza28nOwogICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsKICAgICAgICAgICB9KTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIC8vIHRoZSBsaXN0ZW5lciBpcyBhbHdheXMgY2FsbGVkIGR1cmluZyB0aGUgZmlyc3QgJGRpZ2VzdCBsb29wIGFmdGVyIGl0IHdhcyByZWdpc3RlcmVkCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAvLyBidXQgbm93IGl0IHdpbGwgbm90IGJlIGNhbGxlZCB1bmxlc3MgdGhlIHZhbHVlIGNoYW5nZXMKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdhZGFtJzsKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMik7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKi8KICAgICAgJGRpZ2VzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHdhdGNoLCB2YWx1ZSwgbGFzdCwKICAgICAgICAgICAgd2F0Y2hlcnMsCiAgICAgICAgICAgIGFzeW5jUXVldWUgPSB0aGlzLiQkYXN5bmNRdWV1ZSwKICAgICAgICAgICAgcG9zdERpZ2VzdFF1ZXVlID0gdGhpcy4kJHBvc3REaWdlc3RRdWV1ZSwKICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICBkaXJ0eSwgdHRsID0gVFRMLAogICAgICAgICAgICBuZXh0LCBjdXJyZW50LCB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgICB3YXRjaExvZyA9IFtdLAogICAgICAgICAgICBsb2dJZHgsIGxvZ01zZywgYXN5bmNUYXNrOwoKICAgICAgICBiZWdpblBoYXNlKCckZGlnZXN0Jyk7CgogICAgICAgIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKCiAgICAgICAgZG8geyAvLyAid2hpbGUgZGlydHkiIGxvb3AKICAgICAgICAgIGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0OwoKICAgICAgICAgIHdoaWxlKGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYXN5bmNUYXNrID0gYXN5bmNRdWV1ZS5zaGlmdCgpOwogICAgICAgICAgICAgIGFzeW5jVGFzay5zY29wZS4kZXZhbChhc3luY1Rhc2suZXhwcmVzc2lvbik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdERpcnR5V2F0Y2ggPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIHRyYXZlcnNlU2NvcGVzTG9vcDoKICAgICAgICAgIGRvIHsgLy8gInRyYXZlcnNlIHRoZSBzY29wZXMiIGxvb3AKICAgICAgICAgICAgaWYgKCh3YXRjaGVycyA9IGN1cnJlbnQuJCR3YXRjaGVycykpIHsKICAgICAgICAgICAgICAvLyBwcm9jZXNzIG91ciB3YXRjaGVzCiAgICAgICAgICAgICAgbGVuZ3RoID0gd2F0Y2hlcnMubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgd2F0Y2ggPSB3YXRjaGVyc1tsZW5ndGhdOwogICAgICAgICAgICAgICAgICAvLyBNb3N0IGNvbW1vbiB3YXRjaGVzIGFyZSBvbiBwcmltaXRpdmVzLCBpbiB3aGljaCBjYXNlIHdlIGNhbiBzaG9ydAogICAgICAgICAgICAgICAgICAvLyBjaXJjdWl0IGl0IHdpdGggPT09IG9wZXJhdG9yLCBvbmx5IHdoZW4gPT09IGZhaWxzIGRvIHdlIHVzZSAuZXF1YWxzCiAgICAgICAgICAgICAgICAgIGlmICh3YXRjaCkgewogICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPSB3YXRjaC5nZXQoY3VycmVudCkpICE9PSAobGFzdCA9IHdhdGNoLmxhc3QpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICEod2F0Y2guZXEKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZXF1YWxzKHZhbHVlLCBsYXN0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAodHlwZW9mIHZhbHVlID09ICdudW1iZXInICYmIHR5cGVvZiBsYXN0ID09ICdudW1iZXInCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBpc05hTih2YWx1ZSkgJiYgaXNOYU4obGFzdCkpKSkgewogICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgbGFzdERpcnR5V2F0Y2ggPSB3YXRjaDsKICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmxhc3QgPSB3YXRjaC5lcSA/IGNvcHkodmFsdWUsIG51bGwpIDogdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5mbih2YWx1ZSwgKChsYXN0ID09PSBpbml0V2F0Y2hWYWwpID8gdmFsdWUgOiBsYXN0KSwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHRsIDwgNSkgewogICAgICAgICAgICAgICAgICAgICAgICBsb2dJZHggPSA0IC0gdHRsOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXdhdGNoTG9nW2xvZ0lkeF0pIHdhdGNoTG9nW2xvZ0lkeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nTXNnID0gKGlzRnVuY3Rpb24od2F0Y2guZXhwKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2ZuOiAnICsgKHdhdGNoLmV4cC5uYW1lIHx8IHdhdGNoLmV4cC50b1N0cmluZygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB3YXRjaC5leHA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ01zZyArPSAnOyBuZXdWYWw6ICcgKyB0b0pzb24odmFsdWUpICsgJzsgb2xkVmFsOiAnICsgdG9Kc29uKGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZ1tsb2dJZHhdLnB1c2gobG9nTXNnKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHdhdGNoID09PSBsYXN0RGlydHlXYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIG1vc3QgcmVjZW50bHkgZGlydHkgd2F0Y2hlciBpcyBub3cgY2xlYW4sIHNob3J0IGNpcmN1aXQgc2luY2UgdGhlIHJlbWFpbmluZyB3YXRjaGVycwogICAgICAgICAgICAgICAgICAgICAgLy8gaGF2ZSBhbHJlYWR5IGJlZW4gdGVzdGVkLgogICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIHRyYXZlcnNlU2NvcGVzTG9vcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEluc2FuaXR5IFdhcm5pbmc6IHNjb3BlIGRlcHRoLWZpcnN0IHRyYXZlcnNhbAogICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRicm9hZGNhc3QKICAgICAgICAgICAgaWYgKCEobmV4dCA9IChjdXJyZW50LiQkY2hpbGRIZWFkIHx8CiAgICAgICAgICAgICAgICAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICAgIHdoaWxlKGN1cnJlbnQgIT09IHRhcmdldCAmJiAhKG5leHQgPSBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSk7CgogICAgICAgICAgLy8gYGJyZWFrIHRyYXZlcnNlU2NvcGVzTG9vcDtgIHRha2VzIHVzIHRvIGhlcmUKCiAgICAgICAgICBpZigoZGlydHkgfHwgYXN5bmNRdWV1ZS5sZW5ndGgpICYmICEodHRsLS0pKSB7CiAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgdGhyb3cgJHJvb3RTY29wZU1pbkVycignaW5mZGlnJywKICAgICAgICAgICAgICAgICd7MH0gJGRpZ2VzdCgpIGl0ZXJhdGlvbnMgcmVhY2hlZC4gQWJvcnRpbmchXG4nICsKICAgICAgICAgICAgICAgICdXYXRjaGVycyBmaXJlZCBpbiB0aGUgbGFzdCA1IGl0ZXJhdGlvbnM6IHsxfScsCiAgICAgICAgICAgICAgICBUVEwsIHRvSnNvbih3YXRjaExvZykpOwogICAgICAgICAgfQoKICAgICAgICB9IHdoaWxlIChkaXJ0eSB8fCBhc3luY1F1ZXVlLmxlbmd0aCk7CgogICAgICAgIGNsZWFyUGhhc2UoKTsKCiAgICAgICAgd2hpbGUocG9zdERpZ2VzdFF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcG9zdERpZ2VzdFF1ZXVlLnNoaWZ0KCkoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiBzY29wZSBiZWluZyBkZXN0cm95ZWQKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEJyb2FkY2FzdGVkIHdoZW4gYSBzY29wZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBiZWluZyBkZXN0cm95ZWQuCiAgICAgICAqCiAgICAgICAqIE5vdGUgdGhhdCwgaW4gQW5ndWxhckpTLCB0aGVyZSBpcyBhbHNvIGEgYCRkZXN0cm95YCBqUXVlcnkgZXZlbnQsIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICAgICAqIGNsZWFuIHVwIERPTSBiaW5kaW5ncyBiZWZvcmUgYW4gZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTS4KICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBSZW1vdmVzIHRoZSBjdXJyZW50IHNjb3BlIChhbmQgYWxsIG9mIGl0cyBjaGlsZHJlbikgZnJvbSB0aGUgcGFyZW50IHNjb3BlLiBSZW1vdmFsIGltcGxpZXMKICAgICAgICogdGhhdCBjYWxscyB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gd2lsbCBubyBsb25nZXIKICAgICAgICogcHJvcGFnYXRlIHRvIHRoZSBjdXJyZW50IHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4uIFJlbW92YWwgYWxzbyBpbXBsaWVzIHRoYXQgdGhlIGN1cnJlbnQKICAgICAgICogc2NvcGUgaXMgZWxpZ2libGUgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4KICAgICAgICoKICAgICAgICogVGhlIGAkZGVzdHJveSgpYCBpcyB1c3VhbGx5IHVzZWQgYnkgZGlyZWN0aXZlcyBzdWNoIGFzCiAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9IGZvciBtYW5hZ2luZyB0aGUKICAgICAgICogdW5yb2xsaW5nIG9mIHRoZSBsb29wLgogICAgICAgKgogICAgICAgKiBKdXN0IGJlZm9yZSBhIHNjb3BlIGlzIGRlc3Ryb3llZCwgYSBgJGRlc3Ryb3lgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoaXMgc2NvcGUuCiAgICAgICAqIEFwcGxpY2F0aW9uIGNvZGUgY2FuIHJlZ2lzdGVyIGEgYCRkZXN0cm95YCBldmVudCBoYW5kbGVyIHRoYXQgd2lsbCBnaXZlIGl0IGEgY2hhbmNlIHRvCiAgICAgICAqIHBlcmZvcm0gYW55IG5lY2Vzc2FyeSBjbGVhbnVwLgogICAgICAgKgogICAgICAgKiBOb3RlIHRoYXQsIGluIEFuZ3VsYXJKUywgdGhlcmUgaXMgYWxzbyBhIGAkZGVzdHJveWAgalF1ZXJ5IGV2ZW50LCB3aGljaCBjYW4gYmUgdXNlZCB0bwogICAgICAgKiBjbGVhbiB1cCBET00gYmluZGluZ3MgYmVmb3JlIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00uCiAgICAgICAqLwogICAgICAkZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gd2UgY2FuJ3QgZGVzdHJveSB0aGUgcm9vdCBzY29wZSBvciBhIHNjb3BlIHRoYXQgaGFzIGJlZW4gYWxyZWFkeSBkZXN0cm95ZWQKICAgICAgICBpZiAodGhpcy4kJGRlc3Ryb3llZCkgcmV0dXJuOwogICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLiRwYXJlbnQ7CgogICAgICAgIHRoaXMuJGJyb2FkY2FzdCgnJGRlc3Ryb3knKTsKICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gdHJ1ZTsKICAgICAgICBpZiAodGhpcyA9PT0gJHJvb3RTY29wZSkgcmV0dXJuOwoKICAgICAgICBmb3JFYWNoKHRoaXMuJCRsaXN0ZW5lckNvdW50LCBiaW5kKG51bGwsIGRlY3JlbWVudExpc3RlbmVyQ291bnQsIHRoaXMpKTsKCiAgICAgICAgLy8gc2V2ZXIgYWxsIHRoZSByZWZlcmVuY2VzIHRvIHBhcmVudCBzY29wZXMgKGFmdGVyIHRoaXMgY2xlYW51cCwgdGhlIGN1cnJlbnQgc2NvcGUgc2hvdWxkCiAgICAgICAgLy8gbm90IGJlIHJldGFpbmVkIGJ5IGFueSBvZiBvdXIgcmVmZXJlbmNlcyBhbmQgc2hvdWxkIGJlIGVsaWdpYmxlIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24pCiAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkSGVhZCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZEhlYWQgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkVGFpbCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZFRhaWwgPSB0aGlzLiQkcHJldlNpYmxpbmc7CiAgICAgICAgaWYgKHRoaXMuJCRwcmV2U2libGluZykgdGhpcy4kJHByZXZTaWJsaW5nLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgaWYgKHRoaXMuJCRuZXh0U2libGluZykgdGhpcy4kJG5leHRTaWJsaW5nLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmc7CgoKICAgICAgICAvLyBBbGwgb2YgdGhlIGNvZGUgYmVsb3cgaXMgYm9ndXMgY29kZSB0aGF0IHdvcmtzIGFyb3VuZCBWOCdzIG1lbW9yeSBsZWFrIHZpYSBvcHRpbWl6ZWQgY29kZQogICAgICAgIC8vIGFuZCBpbmxpbmUgY2FjaGVzLgogICAgICAgIC8vCiAgICAgICAgLy8gc2VlOgogICAgICAgIC8vIC0gaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTIwNzMjYzI2CiAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy82Nzk0I2lzc3VlY29tbWVudC0zODY0ODkwOQogICAgICAgIC8vIC0gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvMTMxMyNpc3N1ZWNvbW1lbnQtMTAzNzg0NTEKCiAgICAgICAgdGhpcy4kcGFyZW50ID0gdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJGNoaWxkSGVhZCA9CiAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSB0aGlzLiRyb290ID0gbnVsbDsKCiAgICAgICAgLy8gZG9uJ3QgcmVzZXQgdGhlc2UgdG8gbnVsbCBpbiBjYXNlIHNvbWUgYXN5bmMgdGFzayB0cmllcyB0byByZWdpc3RlciBhIGxpc3RlbmVyL3dhdGNoL3Rhc2sKICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgdGhpcy4kJHdhdGNoZXJzID0gdGhpcy4kJGFzeW5jUXVldWUgPSB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlID0gW107CgogICAgICAgIC8vIHByZXZlbnQgTlBFcyBzaW5jZSB0aGVzZSBtZXRob2RzIGhhdmUgcmVmZXJlbmNlcyB0byBwcm9wZXJ0aWVzIHdlIG51bGxlZCBvdXQKICAgICAgICB0aGlzLiRkZXN0cm95ID0gdGhpcy4kZGlnZXN0ID0gdGhpcy4kYXBwbHkgPSBub29wOwogICAgICAgIHRoaXMuJG9uID0gdGhpcy4kd2F0Y2ggPSBmdW5jdGlvbigpIHsgcmV0dXJuIG5vb3A7IH07CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRldmFsCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBFeGVjdXRlcyB0aGUgYGV4cHJlc3Npb25gIG9uIHRoZSBjdXJyZW50IHNjb3BlIGFuZCByZXR1cm5zIHRoZSByZXN1bHQuIEFueSBleGNlcHRpb25zIGluCiAgICAgICAqIHRoZSBleHByZXNzaW9uIGFyZSBwcm9wYWdhdGVkICh1bmNhdWdodCkuIFRoaXMgaXMgdXNlZnVsIHdoZW4gZXZhbHVhdGluZyBBbmd1bGFyCiAgICAgICAqIGV4cHJlc3Npb25zLgogICAgICAgKgogICAgICAgKiAjIEV4YW1wbGUKICAgICAgICogYGBganMKICAgICAgICAgICB2YXIgc2NvcGUgPSBuZy4kcm9vdFNjb3BlLlNjb3BlKCk7CiAgICAgICAgICAgc2NvcGUuYSA9IDE7CiAgICAgICAgICAgc2NvcGUuYiA9IDI7CgogICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbCgnYStiJykpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKGZ1bmN0aW9uKHNjb3BlKXsgcmV0dXJuIHNjb3BlLmEgKyBzY29wZS5iOyB9KSkudG9FcXVhbCgzKTsKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cHJlc3Npb24gQW4gYW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICAgKgogICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCB0aGUgY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICoKICAgICAgICogQHBhcmFtIHsob2JqZWN0KT19IGxvY2FscyBMb2NhbCB2YXJpYWJsZXMgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluIHNjb3BlLgogICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLgogICAgICAgKi8KICAgICAgJGV2YWw6IGZ1bmN0aW9uKGV4cHIsIGxvY2FscykgewogICAgICAgIHJldHVybiAkcGFyc2UoZXhwcikodGhpcywgbG9jYWxzKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGV2YWxBc3luYwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRXhlY3V0ZXMgdGhlIGV4cHJlc3Npb24gb24gdGhlIGN1cnJlbnQgc2NvcGUgYXQgYSBsYXRlciBwb2ludCBpbiB0aW1lLgogICAgICAgKgogICAgICAgKiBUaGUgYCRldmFsQXN5bmNgIG1ha2VzIG5vIGd1YXJhbnRlZXMgYXMgdG8gd2hlbiB0aGUgYGV4cHJlc3Npb25gIHdpbGwgYmUgZXhlY3V0ZWQsIG9ubHkKICAgICAgICogdGhhdDoKICAgICAgICoKICAgICAgICogICAtIGl0IHdpbGwgZXhlY3V0ZSBhZnRlciB0aGUgZnVuY3Rpb24gdGhhdCBzY2hlZHVsZWQgdGhlIGV2YWx1YXRpb24gKHByZWZlcmFibHkgYmVmb3JlIERPTQogICAgICAgKiAgICAgcmVuZGVyaW5nKS4KICAgICAgICogICAtIGF0IGxlYXN0IG9uZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QgY3ljbGV9IHdpbGwgYmUgcGVyZm9ybWVkIGFmdGVyCiAgICAgICAqICAgICBgZXhwcmVzc2lvbmAgZXhlY3V0aW9uLgogICAgICAgKgogICAgICAgKiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICoge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgKgogICAgICAgKiBfX05vdGU6X18gaWYgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGAkZGlnZXN0YCBjeWNsZSwgYSBuZXcgYCRkaWdlc3RgIGN5Y2xlCiAgICAgICAqIHdpbGwgYmUgc2NoZWR1bGVkLiBIb3dldmVyLCBpdCBpcyBlbmNvdXJhZ2VkIHRvIGFsd2F5cyBjYWxsIGNvZGUgdGhhdCBjaGFuZ2VzIHRoZSBtb2RlbAogICAgICAgKiBmcm9tIHdpdGhpbiBhbiBgJGFwcGx5YCBjYWxsLiBUaGF0IGluY2x1ZGVzIGNvZGUgZXZhbHVhdGVkIHZpYSBgJGV2YWxBc3luY2AuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cHJlc3Npb24gQW4gYW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICAgKgogICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgKgogICAgICAgKi8KICAgICAgJGV2YWxBc3luYzogZnVuY3Rpb24oZXhwcikgewogICAgICAgIC8vIGlmIHdlIGFyZSBvdXRzaWRlIG9mIGFuICRkaWdlc3QgbG9vcCBhbmQgdGhpcyBpcyB0aGUgZmlyc3QgdGltZSB3ZSBhcmUgc2NoZWR1bGluZyBhc3luYwogICAgICAgIC8vIHRhc2sgYWxzbyBzY2hlZHVsZSBhc3luYyBhdXRvLWZsdXNoCiAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UgJiYgISRyb290U2NvcGUuJCRhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLiQkYXN5bmNRdWV1ZS5wdXNoKHtzY29wZTogdGhpcywgZXhwcmVzc2lvbjogZXhwcn0pOwogICAgICB9LAoKICAgICAgJCRwb3N0RGlnZXN0IDogZnVuY3Rpb24oZm4pIHsKICAgICAgICB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlLnB1c2goZm4pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkYXBwbHkKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIGAkYXBwbHkoKWAgaXMgdXNlZCB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gYW5ndWxhciBmcm9tIG91dHNpZGUgb2YgdGhlIGFuZ3VsYXIKICAgICAgICogZnJhbWV3b3JrLiAoRm9yIGV4YW1wbGUgZnJvbSBicm93c2VyIERPTSBldmVudHMsIHNldFRpbWVvdXQsIFhIUiBvciB0aGlyZCBwYXJ0eSBsaWJyYXJpZXMpLgogICAgICAgKiBCZWNhdXNlIHdlIGFyZSBjYWxsaW5nIGludG8gdGhlIGFuZ3VsYXIgZnJhbWV3b3JrIHdlIG5lZWQgdG8gcGVyZm9ybSBwcm9wZXIgc2NvcGUgbGlmZQogICAgICAgKiBjeWNsZSBvZiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgZXhjZXB0aW9uIGhhbmRsaW5nfSwKICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCBleGVjdXRpbmcgd2F0Y2hlc30uCiAgICAgICAqCiAgICAgICAqICMjIExpZmUgY3ljbGUKICAgICAgICoKICAgICAgICogIyBQc2V1ZG8tQ29kZSBvZiBgJGFwcGx5KClgCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAgZnVuY3Rpb24gJGFwcGx5KGV4cHIpIHsKICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgIHJldHVybiAkZXZhbChleHByKTsKICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAkcm9vdC4kZGlnZXN0KCk7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgfQogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICoKICAgICAgICogU2NvcGUncyBgJGFwcGx5KClgIG1ldGhvZCB0cmFuc2l0aW9ucyB0aHJvdWdoIHRoZSBmb2xsb3dpbmcgc3RhZ2VzOgogICAgICAgKgogICAgICAgKiAxLiBUaGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgZXhlY3V0ZWQgdXNpbmcgdGhlCiAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsICRldmFsKCl9IG1ldGhvZC4KICAgICAgICogMi4gQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAqICAgIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICogMy4gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaH0gbGlzdGVuZXJzIGFyZSBmaXJlZCBpbW1lZGlhdGVseSBhZnRlciB0aGUKICAgICAgICogICAgZXhwcmVzc2lvbiB3YXMgZXhlY3V0ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBtZXRob2QuCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAqCiAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICoKICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICovCiAgICAgICRhcHBseTogZnVuY3Rpb24oZXhwcikgewogICAgICAgIHRyeSB7CiAgICAgICAgICBiZWdpblBoYXNlKCckYXBwbHknKTsKICAgICAgICAgIHJldHVybiB0aGlzLiRldmFsKGV4cHIpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkb24KICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIExpc3RlbnMgb24gZXZlbnRzIG9mIGEgZ2l2ZW4gdHlwZS4gU2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRlbWl0ICRlbWl0fSBmb3IKICAgICAgICogZGlzY3Vzc2lvbiBvZiBldmVudCBsaWZlIGN5Y2xlLgogICAgICAgKgogICAgICAgKiBUaGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gZm9ybWF0IGlzOiBgZnVuY3Rpb24oZXZlbnQsIGFyZ3MuLi4pYC4gVGhlIGBldmVudGAgb2JqZWN0CiAgICAgICAqIHBhc3NlZCBpbnRvIHRoZSBsaXN0ZW5lciBoYXMgdGhlIGZvbGxvd2luZyBhdHRyaWJ1dGVzOgogICAgICAgKgogICAgICAgKiAgIC0gYHRhcmdldFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIHNjb3BlIG9uIHdoaWNoIHRoZSBldmVudCB3YXMgYCRlbWl0YC1lZCBvcgogICAgICAgKiAgICAgYCRicm9hZGNhc3RgLWVkLgogICAgICAgKiAgIC0gYGN1cnJlbnRTY29wZWAgLSBge1Njb3BlfWA6IHRoZSBjdXJyZW50IHNjb3BlIHdoaWNoIGlzIGhhbmRsaW5nIHRoZSBldmVudC4KICAgICAgICogICAtIGBuYW1lYCAtIGB7c3RyaW5nfWA6IG5hbWUgb2YgdGhlIGV2ZW50LgogICAgICAgKiAgIC0gYHN0b3BQcm9wYWdhdGlvbmAgLSBge2Z1bmN0aW9uPX1gOiBjYWxsaW5nIGBzdG9wUHJvcGFnYXRpb25gIGZ1bmN0aW9uIHdpbGwgY2FuY2VsCiAgICAgICAqICAgICBmdXJ0aGVyIGV2ZW50IHByb3BhZ2F0aW9uIChhdmFpbGFibGUgb25seSBmb3IgZXZlbnRzIHRoYXQgd2VyZSBgJGVtaXRgLWVkKS4KICAgICAgICogICAtIGBwcmV2ZW50RGVmYXVsdGAgLSBge2Z1bmN0aW9ufWA6IGNhbGxpbmcgYHByZXZlbnREZWZhdWx0YCBzZXRzIGBkZWZhdWx0UHJldmVudGVkYCBmbGFnCiAgICAgICAqICAgICB0byB0cnVlLgogICAgICAgKiAgIC0gYGRlZmF1bHRQcmV2ZW50ZWRgIC0gYHtib29sZWFufWA6IHRydWUgaWYgYHByZXZlbnREZWZhdWx0YCB3YXMgY2FsbGVkLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGxpc3RlbiBvbi4KICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudCwgLi4uYXJncyl9IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgZXZlbnQgaXMgZW1pdHRlZC4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICovCiAgICAgICRvbjogZnVuY3Rpb24obmFtZSwgbGlzdGVuZXIpIHsKICAgICAgICB2YXIgbmFtZWRMaXN0ZW5lcnMgPSB0aGlzLiQkbGlzdGVuZXJzW25hbWVdOwogICAgICAgIGlmICghbmFtZWRMaXN0ZW5lcnMpIHsKICAgICAgICAgIHRoaXMuJCRsaXN0ZW5lcnNbbmFtZV0gPSBuYW1lZExpc3RlbmVycyA9IFtdOwogICAgICAgIH0KICAgICAgICBuYW1lZExpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKCiAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmICghY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0pIHsKICAgICAgICAgICAgY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gPSAwOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0rKzsKICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudCkpOwoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaW5kZXhPZihuYW1lZExpc3RlbmVycywgbGlzdGVuZXIpXSA9IG51bGw7CiAgICAgICAgICBkZWNyZW1lbnRMaXN0ZW5lckNvdW50KHNlbGYsIDEsIG5hbWUpOwogICAgICAgIH07CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZW1pdAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgdXB3YXJkcyB0aHJvdWdoIHRoZSBzY29wZSBoaWVyYXJjaHkgbm90aWZ5aW5nIHRoZQogICAgICAgKiByZWdpc3RlcmVkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gbGlzdGVuZXJzLgogICAgICAgKgogICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkZW1pdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IGxpc3RlbmluZyBmb3IgYG5hbWVgIGV2ZW50IG9uIHRoaXMgc2NvcGUgZ2V0CiAgICAgICAqIG5vdGlmaWVkLiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgdHJhdmVyc2VzIHVwd2FyZHMgdG93YXJkIHRoZSByb290IHNjb3BlIGFuZCBjYWxscyBhbGwKICAgICAgICogcmVnaXN0ZXJlZCBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IHdpbGwgc3RvcCBwcm9wYWdhdGluZyBpZiBvbmUgb2YgdGhlIGxpc3RlbmVycwogICAgICAgKiBjYW5jZWxzIGl0LgogICAgICAgKgogICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGVtaXQuCiAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBvbmUgb3IgbW9yZSBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCAoc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0pLgogICAgICAgKi8KICAgICAgJGVtaXQ6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICB2YXIgZW1wdHkgPSBbXSwKICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMsCiAgICAgICAgICAgIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uID0gZmFsc2UsCiAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHNjb3BlLAogICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7c3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTt9LAogICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbGlzdGVuZXJBcmdzID0gY29uY2F0KFtldmVudF0sIGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgIGksIGxlbmd0aDsKCiAgICAgICAgZG8gewogICAgICAgICAgbmFtZWRMaXN0ZW5lcnMgPSBzY29wZS4kJGxpc3RlbmVyc1tuYW1lXSB8fCBlbXB0eTsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IHNjb3BlOwogICAgICAgICAgZm9yIChpPTAsIGxlbmd0aD1uYW1lZExpc3RlbmVycy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIC8vIGlmIGxpc3RlbmVycyB3ZXJlIGRlcmVnaXN0ZXJlZCwgZGVmcmFnbWVudCB0aGUgYXJyYXkKICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVyc1tpXSkgewogICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAvL2FsbG93IGFsbCBsaXN0ZW5lcnMgYXR0YWNoZWQgdG8gdGhlIGN1cnJlbnQgc2NvcGUgdG8gcnVuCiAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvL2lmIGFueSBsaXN0ZW5lciBvbiB0aGUgY3VycmVudCBzY29wZSBzdG9wcyBwcm9wYWdhdGlvbiwgcHJldmVudCBidWJibGluZwogICAgICAgICAgaWYgKHN0b3BQcm9wYWdhdGlvbikgcmV0dXJuIGV2ZW50OwogICAgICAgICAgLy90cmF2ZXJzZSB1cHdhcmRzCiAgICAgICAgICBzY29wZSA9IHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgfSB3aGlsZSAoc2NvcGUpOwoKICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkYnJvYWRjYXN0CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCBkb3dud2FyZHMgdG8gYWxsIGNoaWxkIHNjb3BlcyAoYW5kIHRoZWlyIGNoaWxkcmVuKSBub3RpZnlpbmcgdGhlCiAgICAgICAqIHJlZ2lzdGVyZWQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBsaXN0ZW5lcnMuCiAgICAgICAqCiAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRicm9hZGNhc3RgIHdhcyBjYWxsZWQuIEFsbAogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldAogICAgICAgKiBub3RpZmllZC4gQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHByb3BhZ2F0ZXMgdG8gYWxsIGRpcmVjdCBhbmQgaW5kaXJlY3Qgc2NvcGVzIG9mIHRoZSBjdXJyZW50CiAgICAgICAqIHNjb3BlIGFuZCBjYWxscyBhbGwgcmVnaXN0ZXJlZCBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IGNhbm5vdCBiZSBjYW5jZWxlZC4KICAgICAgICoKICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAqIG9udG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBicm9hZGNhc3QuCiAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBvbmUgb3IgbW9yZSBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICovCiAgICAgICRicm9hZGNhc3Q6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgY3VycmVudCA9IHRhcmdldCwKICAgICAgICAgICAgbmV4dCA9IHRhcmdldCwKICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICB0YXJnZXRTY29wZTogdGFyZ2V0LAogICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbGlzdGVuZXJBcmdzID0gY29uY2F0KFtldmVudF0sIGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgIGxpc3RlbmVycywgaSwgbGVuZ3RoOwoKICAgICAgICAvL2Rvd24gd2hpbGUgeW91IGNhbiwgdGhlbiB1cCBhbmQgbmV4dCBzaWJsaW5nIG9yIHVwIGFuZCBuZXh0IHNpYmxpbmcgdW50aWwgYmFjayBhdCByb290CiAgICAgICAgd2hpbGUgKChjdXJyZW50ID0gbmV4dCkpIHsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IGN1cnJlbnQ7CiAgICAgICAgICBsaXN0ZW5lcnMgPSBjdXJyZW50LiQkbGlzdGVuZXJzW25hbWVdIHx8IFtdOwogICAgICAgICAgZm9yIChpPTAsIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICBpZiAoIWxpc3RlbmVyc1tpXSkgewogICAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5hcHBseShudWxsLCBsaXN0ZW5lckFyZ3MpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIEluc2FuaXR5IFdhcm5pbmc6IHNjb3BlIGRlcHRoLWZpcnN0IHRyYXZlcnNhbAogICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGRpZ2VzdAogICAgICAgICAgLy8gKHRob3VnaCBpdCBkaWZmZXJzIGR1ZSB0byBoYXZpbmcgdGhlIGV4dHJhIGNoZWNrIGZvciAkJGxpc3RlbmVyQ291bnQpCiAgICAgICAgICBpZiAoIShuZXh0ID0gKChjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSAmJiBjdXJyZW50LiQkY2hpbGRIZWFkKSB8fAogICAgICAgICAgICAgIChjdXJyZW50ICE9PSB0YXJnZXQgJiYgY3VycmVudC4kJG5leHRTaWJsaW5nKSkpKSB7CiAgICAgICAgICAgIHdoaWxlKGN1cnJlbnQgIT09IHRhcmdldCAmJiAhKG5leHQgPSBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9CiAgICB9OwoKICAgIHZhciAkcm9vdFNjb3BlID0gbmV3IFNjb3BlKCk7CgogICAgcmV0dXJuICRyb290U2NvcGU7CgoKICAgIGZ1bmN0aW9uIGJlZ2luUGhhc2UocGhhc2UpIHsKICAgICAgaWYgKCRyb290U2NvcGUuJCRwaGFzZSkgewogICAgICAgIHRocm93ICRyb290U2NvcGVNaW5FcnIoJ2lucHJvZycsICd7MH0gYWxyZWFkeSBpbiBwcm9ncmVzcycsICRyb290U2NvcGUuJCRwaGFzZSk7CiAgICAgIH0KCiAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IHBoYXNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFyUGhhc2UoKSB7CiAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gY29tcGlsZVRvRm4oZXhwLCBuYW1lKSB7CiAgICAgIHZhciBmbiA9ICRwYXJzZShleHApOwogICAgICBhc3NlcnRBcmdGbihmbiwgbmFtZSk7CiAgICAgIHJldHVybiBmbjsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNyZW1lbnRMaXN0ZW5lckNvdW50KGN1cnJlbnQsIGNvdW50LCBuYW1lKSB7CiAgICAgIGRvIHsKICAgICAgICBjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSAtPSBjb3VudDsKCiAgICAgICAgaWYgKGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdID09PSAwKSB7CiAgICAgICAgICBkZWxldGUgY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV07CiAgICAgICAgfQogICAgICB9IHdoaWxlICgoY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudCkpOwogICAgfQoKICAgIC8qKgogICAgICogZnVuY3Rpb24gdXNlZCBhcyBhbiBpbml0aWFsIHZhbHVlIGZvciB3YXRjaGVycy4KICAgICAqIGJlY2F1c2UgaXQncyB1bmlxdWUgd2UgY2FuIGVhc2lseSB0ZWxsIGl0IGFwYXJ0IGZyb20gb3RoZXIgdmFsdWVzCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluaXRXYXRjaFZhbCgpIHt9CiAgfV07Cn0KCi8qKgogKiBAZGVzY3JpcHRpb24KICogUHJpdmF0ZSBzZXJ2aWNlIHRvIHNhbml0aXplIHVyaXMgZm9yIGxpbmtzIGFuZCBpbWFnZXMuIFVzZWQgYnkgJGNvbXBpbGUgYW5kICRzYW5pdGl6ZS4KICovCmZ1bmN0aW9uICQkU2FuaXRpemVVcmlQcm92aWRlcigpIHsKICB2YXIgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSAvXlxzKihodHRwcz98ZnRwfG1haWx0b3x0ZWx8ZmlsZSk6LywKICAgIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8ZmlsZSk6fGRhdGE6aW1hZ2VcLy87CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgKgogICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICoKICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGFbaHJlZl0gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdGAKICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICoKICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgKi8KICB0aGlzLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24ocmVnZXhwKSB7CiAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogIH07CgoKICAvKioKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICogdXJscyBkdXJpbmcgaW1nW3NyY10gc2FuaXRpemF0aW9uLgogICAqCiAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgKgogICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gaW1nW3NyY10gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3RgCiAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAqCiAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICovCiAgdGhpcy5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgIGlmIChpc0RlZmluZWQocmVnZXhwKSkgewogICAgICBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdDsKICB9OwoKICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmdW5jdGlvbiBzYW5pdGl6ZVVyaSh1cmksIGlzSW1hZ2UpIHsKICAgICAgdmFyIHJlZ2V4ID0gaXNJbWFnZSA/IGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA6IGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgICB2YXIgbm9ybWFsaXplZFZhbDsKICAgICAgLy8gTk9URTogdXJsUmVzb2x2ZSgpIGRvZXNuJ3Qgc3VwcG9ydCBJRSA8IDggc28gd2UgZG9uJ3Qgc2FuaXRpemUgZm9yIHRoYXQgY2FzZS4KICAgICAgaWYgKCFtc2llIHx8IG1zaWUgPj0gOCApIHsKICAgICAgICBub3JtYWxpemVkVmFsID0gdXJsUmVzb2x2ZSh1cmkpLmhyZWY7CiAgICAgICAgaWYgKG5vcm1hbGl6ZWRWYWwgIT09ICcnICYmICFub3JtYWxpemVkVmFsLm1hdGNoKHJlZ2V4KSkgewogICAgICAgICAgcmV0dXJuICd1bnNhZmU6Jytub3JtYWxpemVkVmFsOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdXJpOwogICAgfTsKICB9Owp9Cgp2YXIgJHNjZU1pbkVyciA9IG1pbkVycignJHNjZScpOwoKdmFyIFNDRV9DT05URVhUUyA9IHsKICBIVE1MOiAnaHRtbCcsCiAgQ1NTOiAnY3NzJywKICBVUkw6ICd1cmwnLAogIC8vIFJFU09VUkNFX1VSTCBpcyBhIHN1YnR5cGUgb2YgVVJMIHVzZWQgaW4gY29udGV4dHMgd2hlcmUgYSBwcml2aWxlZ2VkIHJlc291cmNlIGlzIHNvdXJjZWQgZnJvbSBhCiAgLy8gdXJsLiAgKGUuZy4gbmctaW5jbHVkZSwgc2NyaXB0IHNyYywgdGVtcGxhdGVVcmwpCiAgUkVTT1VSQ0VfVVJMOiAncmVzb3VyY2VVcmwnLAogIEpTOiAnanMnCn07CgovLyBIZWxwZXIgZnVuY3Rpb25zIGZvbGxvdy4KCi8vIENvcGllZCBmcm9tOgovLyBodHRwOi8vZG9jcy5jbG9zdXJlLWxpYnJhcnkuZ29vZ2xlY29kZS5jb20vZ2l0L2Nsb3N1cmVfZ29vZ19zdHJpbmdfc3RyaW5nLmpzLnNvdXJjZS5odG1sI2xpbmU5NjIKLy8gUHJlcmVxOiBzIGlzIGEgc3RyaW5nLgpmdW5jdGlvbiBlc2NhcGVGb3JSZWdleHAocykgewogIHJldHVybiBzLnJlcGxhY2UoLyhbLSgpXFtcXXt9Kz8qLiRcXnwsOiM8IVxcXSkvZywgJ1xcJDEnKS4KICAgICAgICAgICByZXBsYWNlKC9ceDA4L2csICdcXHgwOCcpOwp9CgoKZnVuY3Rpb24gYWRqdXN0TWF0Y2hlcihtYXRjaGVyKSB7CiAgaWYgKG1hdGNoZXIgPT09ICdzZWxmJykgewogICAgcmV0dXJuIG1hdGNoZXI7CiAgfSBlbHNlIGlmIChpc1N0cmluZyhtYXRjaGVyKSkgewogICAgLy8gU3RyaW5ncyBtYXRjaCBleGFjdGx5IGV4Y2VwdCBmb3IgMiB3aWxkY2FyZHMgLSAnKicgYW5kICcqKicuCiAgICAvLyAnKicgbWF0Y2hlcyBhbnkgY2hhcmFjdGVyIGV4Y2VwdCB0aG9zZSBmcm9tIHRoZSBzZXQgJzovLj8mJy4KICAgIC8vICcqKicgbWF0Y2hlcyBhbnkgY2hhcmFjdGVyIChsaWtlIC4qIGluIGEgUmVnRXhwKS4KICAgIC8vIE1vcmUgdGhhbiAyIConcyByYWlzZXMgYW4gZXJyb3IgYXMgaXQncyBpbGwgZGVmaW5lZC4KICAgIGlmIChtYXRjaGVyLmluZGV4T2YoJyoqKicpID4gLTEpIHsKICAgICAgdGhyb3cgJHNjZU1pbkVycignaXdjYXJkJywKICAgICAgICAgICdJbGxlZ2FsIHNlcXVlbmNlICoqKiBpbiBzdHJpbmcgbWF0Y2hlci4gIFN0cmluZzogezB9JywgbWF0Y2hlcik7CiAgICB9CiAgICBtYXRjaGVyID0gZXNjYXBlRm9yUmVnZXhwKG1hdGNoZXIpLgogICAgICAgICAgICAgICAgICByZXBsYWNlKCdcXCpcXConLCAnLionKS4KICAgICAgICAgICAgICAgICAgcmVwbGFjZSgnXFwqJywgJ1teOi8uPyY7XSonKTsKICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIG1hdGNoZXIgKyAnJCcpOwogIH0gZWxzZSBpZiAoaXNSZWdFeHAobWF0Y2hlcikpIHsKICAgIC8vIFRoZSBvbmx5IG90aGVyIHR5cGUgb2YgbWF0Y2hlciBhbGxvd2VkIGlzIGEgUmVnZXhwLgogICAgLy8gTWF0Y2ggZW50aXJlIFVSTCAvIGRpc2FsbG93IHBhcnRpYWwgbWF0Y2hlcy4KICAgIC8vIEZsYWdzIGFyZSByZXNldCAoaS5lLiBubyBnbG9iYWwsIGlnbm9yZUNhc2Ugb3IgbXVsdGlsaW5lKQogICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgbWF0Y2hlci5zb3VyY2UgKyAnJCcpOwogIH0gZWxzZSB7CiAgICB0aHJvdyAkc2NlTWluRXJyKCdpbWF0Y2hlcicsCiAgICAgICAgJ01hdGNoZXJzIG1heSBvbmx5IGJlICJzZWxmIiwgc3RyaW5nIHBhdHRlcm5zIG9yIFJlZ0V4cCBvYmplY3RzJyk7CiAgfQp9CgoKZnVuY3Rpb24gYWRqdXN0TWF0Y2hlcnMobWF0Y2hlcnMpIHsKICB2YXIgYWRqdXN0ZWRNYXRjaGVycyA9IFtdOwogIGlmIChpc0RlZmluZWQobWF0Y2hlcnMpKSB7CiAgICBmb3JFYWNoKG1hdGNoZXJzLCBmdW5jdGlvbihtYXRjaGVyKSB7CiAgICAgIGFkanVzdGVkTWF0Y2hlcnMucHVzaChhZGp1c3RNYXRjaGVyKG1hdGNoZXIpKTsKICAgIH0pOwogIH0KICByZXR1cm4gYWRqdXN0ZWRNYXRjaGVyczsKfQoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkc2NlRGVsZWdhdGUKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIGAkc2NlRGVsZWdhdGVgIGlzIGEgc2VydmljZSB0aGF0IGlzIHVzZWQgYnkgdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIHByb3ZpZGUge0BsaW5rIG5nLiRzY2UgU3RyaWN0CiAqIENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSl9IHNlcnZpY2VzIHRvIEFuZ3VsYXJKUy4KICoKICogVHlwaWNhbGx5LCB5b3Ugd291bGQgY29uZmlndXJlIG9yIG92ZXJyaWRlIHRoZSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlICRzY2VEZWxlZ2F0ZX0gaW5zdGVhZCBvZgogKiB0aGUgYCRzY2VgIHNlcnZpY2UgdG8gY3VzdG9taXplIHRoZSB3YXkgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgd29ya3MgaW4gQW5ndWxhckpTLiAgVGhpcyBpcwogKiBiZWNhdXNlLCB3aGlsZSB0aGUgYCRzY2VgIHByb3ZpZGVzIG51bWVyb3VzIHNob3J0aGFuZCBtZXRob2RzLCBldGMuLCB5b3UgcmVhbGx5IG9ubHkgbmVlZCB0bwogKiBvdmVycmlkZSAzIGNvcmUgZnVuY3Rpb25zIChgdHJ1c3RBc2AsIGBnZXRUcnVzdGVkYCBhbmQgYHZhbHVlT2ZgKSB0byByZXBsYWNlIHRoZSB3YXkgdGhpbmdzCiAqIHdvcmsgYmVjYXVzZSBgJHNjZWAgZGVsZWdhdGVzIHRvIGAkc2NlRGVsZWdhdGVgIGZvciB0aGVzZSBvcGVyYXRpb25zLgogKgogKiBSZWZlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIgJHNjZURlbGVnYXRlUHJvdmlkZXJ9IHRvIGNvbmZpZ3VyZSB0aGlzIHNlcnZpY2UuCiAqCiAqIFRoZSBkZWZhdWx0IGluc3RhbmNlIG9mIGAkc2NlRGVsZWdhdGVgIHNob3VsZCB3b3JrIG91dCBvZiB0aGUgYm94IHdpdGggbGl0dGxlIHBhaW4uICBXaGlsZSB5b3UKICogY2FuIG92ZXJyaWRlIGl0IGNvbXBsZXRlbHkgdG8gY2hhbmdlIHRoZSBiZWhhdmlvciBvZiBgJHNjZWAsIHRoZSBjb21tb24gY2FzZSB3b3VsZAogKiBpbnZvbHZlIGNvbmZpZ3VyaW5nIHRoZSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIgJHNjZURlbGVnYXRlUHJvdmlkZXJ9IGluc3RlYWQgYnkgc2V0dGluZwogKiB5b3VyIG93biB3aGl0ZWxpc3RzIGFuZCBibGFja2xpc3RzIGZvciB0cnVzdGluZyBVUkxzIHVzZWQgZm9yIGxvYWRpbmcgQW5ndWxhckpTIHJlc291cmNlcyBzdWNoIGFzCiAqIHRlbXBsYXRlcy4gIFJlZmVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdAogKiAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybFdoaXRlbGlzdH0gYW5kIHtAbGluawogKiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdCAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybEJsYWNrbGlzdH0KICovCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRzY2VEZWxlZ2F0ZVByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUgYCRzY2VEZWxlZ2F0ZVByb3ZpZGVyYCBwcm92aWRlciBhbGxvd3MgZGV2ZWxvcGVycyB0byBjb25maWd1cmUgdGhlIHtAbGluayBuZy4kc2NlRGVsZWdhdGUKICogJHNjZURlbGVnYXRlfSBzZXJ2aWNlLiAgVGhpcyBhbGxvd3Mgb25lIHRvIGdldC9zZXQgdGhlIHdoaXRlbGlzdHMgYW5kIGJsYWNrbGlzdHMgdXNlZCB0byBlbnN1cmUKICogdGhhdCB0aGUgVVJMcyB1c2VkIGZvciBzb3VyY2luZyBBbmd1bGFyIHRlbXBsYXRlcyBhcmUgc2FmZS4gIFJlZmVyIHtAbGluawogKiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybFdoaXRlbGlzdH0gYW5kCiAqIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdCAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybEJsYWNrbGlzdH0KICoKICogRm9yIHRoZSBnZW5lcmFsIGRldGFpbHMgYWJvdXQgdGhpcyBzZXJ2aWNlIGluIEFuZ3VsYXIsIHJlYWQgdGhlIG1haW4gcGFnZSBmb3Ige0BsaW5rIG5nLiRzY2UKICogU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSl9LgogKgogKiAqKkV4YW1wbGUqKjogIENvbnNpZGVyIHRoZSBmb2xsb3dpbmcgY2FzZS4gPGEgbmFtZT0iZXhhbXBsZSI+PC9hPgogKgogKiAtIHlvdXIgYXBwIGlzIGhvc3RlZCBhdCB1cmwgYGh0dHA6Ly9teWFwcC5leGFtcGxlLmNvbS9gCiAqIC0gYnV0IHNvbWUgb2YgeW91ciB0ZW1wbGF0ZXMgYXJlIGhvc3RlZCBvbiBvdGhlciBkb21haW5zIHlvdSBjb250cm9sIHN1Y2ggYXMKICogICBgaHR0cDovL3NydjAxLmFzc2V0cy5leGFtcGxlLmNvbS9gLMKgIGBodHRwOi8vc3J2MDIuYXNzZXRzLmV4YW1wbGUuY29tL2AsIGV0Yy4KICogLSBhbmQgeW91IGhhdmUgYW4gb3BlbiByZWRpcmVjdCBhdCBgaHR0cDovL215YXBwLmV4YW1wbGUuY29tL2NsaWNrVGhydT8uLi5gLgogKgogKiBIZXJlIGlzIHdoYXQgYSBzZWN1cmUgY29uZmlndXJhdGlvbiBmb3IgdGhpcyBzY2VuYXJpbyBtaWdodCBsb29rIGxpa2U6CiAqCiAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICogICAgYW5ndWxhci5tb2R1bGUoJ215QXBwJywgW10pLmNvbmZpZyhmdW5jdGlvbigkc2NlRGVsZWdhdGVQcm92aWRlcikgewogKiAgICAgICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsV2hpdGVsaXN0KFsKICogICAgICAgIC8vIEFsbG93IHNhbWUgb3JpZ2luIHJlc291cmNlIGxvYWRzLgogKiAgICAgICAgJ3NlbGYnLAogKiAgICAgICAgLy8gQWxsb3cgbG9hZGluZyBmcm9tIG91ciBhc3NldHMgZG9tYWluLiAgTm90aWNlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gKiBhbmQgKiouCiAqICAgICAgICAnaHR0cDovL3NydiouYXNzZXRzLmV4YW1wbGUuY29tLyoqJ10pOwogKgogKiAgICAgIC8vIFRoZSBibGFja2xpc3Qgb3ZlcnJpZGVzIHRoZSB3aGl0ZWxpc3Qgc28gdGhlIG9wZW4gcmVkaXJlY3QgaGVyZSBpcyBibG9ja2VkLgogKiAgICAgICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0KFsKICogICAgICAgICdodHRwOi8vbXlhcHAuZXhhbXBsZS5jb20vY2xpY2tUaHJ1KionXSk7CiAqICAgICAgfSk7CiAqIDwvcHJlPgogKi8KCmZ1bmN0aW9uICRTY2VEZWxlZ2F0ZVByb3ZpZGVyKCkgewogIHRoaXMuU0NFX0NPTlRFWFRTID0gU0NFX0NPTlRFWFRTOwoKICAvLyBSZXNvdXJjZSBVUkxzIGNhbiBhbHNvIGJlIHRydXN0ZWQgYnkgcG9saWN5LgogIHZhciByZXNvdXJjZVVybFdoaXRlbGlzdCA9IFsnc2VsZiddLAogICAgICByZXNvdXJjZVVybEJsYWNrbGlzdCA9IFtdOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQHBhcmFtIHtBcnJheT19IHdoaXRlbGlzdCBXaGVuIHByb3ZpZGVkLCByZXBsYWNlcyB0aGUgcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2l0aCB0aGUgdmFsdWUKICAgKiAgICAgcHJvdmlkZWQuICBUaGlzIG11c3QgYmUgYW4gYXJyYXkgb3IgbnVsbC4gIEEgc25hcHNob3Qgb2YgdGhpcyBhcnJheSBpcyB1c2VkIHNvIGZ1cnRoZXIKICAgKiAgICAgY2hhbmdlcyB0byB0aGUgYXJyYXkgYXJlIGlnbm9yZWQuCiAgICoKICAgKiAgICAgRm9sbG93IHtAbGluayBuZy4kc2NlI3Jlc291cmNlVXJsUGF0dGVybkl0ZW0gdGhpcyBsaW5rfSBmb3IgYSBkZXNjcmlwdGlvbiBvZiB0aGUgaXRlbXMKICAgKiAgICAgYWxsb3dlZCBpbiB0aGlzIGFycmF5LgogICAqCiAgICogICAgIE5vdGU6ICoqYW4gZW1wdHkgd2hpdGVsaXN0IGFycmF5IHdpbGwgYmxvY2sgYWxsIFVSTHMqKiEKICAgKgogICAqIEByZXR1cm4ge0FycmF5fSB0aGUgY3VycmVudGx5IHNldCB3aGl0ZWxpc3QgYXJyYXkuCiAgICoKICAgKiBUaGUgKipkZWZhdWx0IHZhbHVlKiogd2hlbiBubyB3aGl0ZWxpc3QgaGFzIGJlZW4gZXhwbGljaXRseSBzZXQgaXMgYFsnc2VsZiddYCBhbGxvd2luZyBvbmx5CiAgICogc2FtZSBvcmlnaW4gcmVzb3VyY2UgcmVxdWVzdHMuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzL0dldHMgdGhlIHdoaXRlbGlzdCBvZiB0cnVzdGVkIHJlc291cmNlIFVSTHMuCiAgICovCiAgdGhpcy5yZXNvdXJjZVVybFdoaXRlbGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBhZGp1c3RNYXRjaGVycyh2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gcmVzb3VyY2VVcmxXaGl0ZWxpc3Q7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBwYXJhbSB7QXJyYXk9fSBibGFja2xpc3QgV2hlbiBwcm92aWRlZCwgcmVwbGFjZXMgdGhlIHJlc291cmNlVXJsQmxhY2tsaXN0IHdpdGggdGhlIHZhbHVlCiAgICogICAgIHByb3ZpZGVkLiAgVGhpcyBtdXN0IGJlIGFuIGFycmF5IG9yIG51bGwuICBBIHNuYXBzaG90IG9mIHRoaXMgYXJyYXkgaXMgdXNlZCBzbyBmdXJ0aGVyCiAgICogICAgIGNoYW5nZXMgdG8gdGhlIGFycmF5IGFyZSBpZ25vcmVkLgogICAqCiAgICogICAgIEZvbGxvdyB7QGxpbmsgbmcuJHNjZSNyZXNvdXJjZVVybFBhdHRlcm5JdGVtIHRoaXMgbGlua30gZm9yIGEgZGVzY3JpcHRpb24gb2YgdGhlIGl0ZW1zCiAgICogICAgIGFsbG93ZWQgaW4gdGhpcyBhcnJheS4KICAgKgogICAqICAgICBUaGUgdHlwaWNhbCB1c2FnZSBmb3IgdGhlIGJsYWNrbGlzdCBpcyB0byAqKmJsb2NrCiAgICogICAgIFtvcGVuIHJlZGlyZWN0c10oaHR0cDovL2N3ZS5taXRyZS5vcmcvZGF0YS9kZWZpbml0aW9ucy82MDEuaHRtbCkqKiBzZXJ2ZWQgYnkgeW91ciBkb21haW4gYXMKICAgKiAgICAgdGhlc2Ugd291bGQgb3RoZXJ3aXNlIGJlIHRydXN0ZWQgYnV0IGFjdHVhbGx5IHJldHVybiBjb250ZW50IGZyb20gdGhlIHJlZGlyZWN0ZWQgZG9tYWluLgogICAqCiAgICogICAgIEZpbmFsbHksICoqdGhlIGJsYWNrbGlzdCBvdmVycmlkZXMgdGhlIHdoaXRlbGlzdCoqIGFuZCBoYXMgdGhlIGZpbmFsIHNheS4KICAgKgogICAqIEByZXR1cm4ge0FycmF5fSB0aGUgY3VycmVudGx5IHNldCBibGFja2xpc3QgYXJyYXkuCiAgICoKICAgKiBUaGUgKipkZWZhdWx0IHZhbHVlKiogd2hlbiBubyB3aGl0ZWxpc3QgaGFzIGJlZW4gZXhwbGljaXRseSBzZXQgaXMgdGhlIGVtcHR5IGFycmF5IChpLmUuIHRoZXJlCiAgICogaXMgbm8gYmxhY2tsaXN0LikKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMvR2V0cyB0aGUgYmxhY2tsaXN0IG9mIHRydXN0ZWQgcmVzb3VyY2UgVVJMcy4KICAgKi8KCiAgdGhpcy5yZXNvdXJjZVVybEJsYWNrbGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgcmVzb3VyY2VVcmxCbGFja2xpc3QgPSBhZGp1c3RNYXRjaGVycyh2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gcmVzb3VyY2VVcmxCbGFja2xpc3Q7CiAgfTsKCiAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCBmdW5jdGlvbigkaW5qZWN0b3IpIHsKCiAgICB2YXIgaHRtbFNhbml0aXplciA9IGZ1bmN0aW9uIGh0bWxTYW5pdGl6ZXIoaHRtbCkgewogICAgICB0aHJvdyAkc2NlTWluRXJyKCd1bnNhZmUnLCAnQXR0ZW1wdGluZyB0byB1c2UgYW4gdW5zYWZlIHZhbHVlIGluIGEgc2FmZSBjb250ZXh0LicpOwogICAgfTsKCiAgICBpZiAoJGluamVjdG9yLmhhcygnJHNhbml0aXplJykpIHsKICAgICAgaHRtbFNhbml0aXplciA9ICRpbmplY3Rvci5nZXQoJyRzYW5pdGl6ZScpOwogICAgfQoKCiAgICBmdW5jdGlvbiBtYXRjaFVybChtYXRjaGVyLCBwYXJzZWRVcmwpIHsKICAgICAgaWYgKG1hdGNoZXIgPT09ICdzZWxmJykgewogICAgICAgIHJldHVybiB1cmxJc1NhbWVPcmlnaW4ocGFyc2VkVXJsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkZWZpbml0ZWx5IGEgcmVnZXguICBTZWUgYWRqdXN0TWF0Y2hlcnMoKQogICAgICAgIHJldHVybiAhIW1hdGNoZXIuZXhlYyhwYXJzZWRVcmwuaHJlZik7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1Jlc291cmNlVXJsQWxsb3dlZEJ5UG9saWN5KHVybCkgewogICAgICB2YXIgcGFyc2VkVXJsID0gdXJsUmVzb2x2ZSh1cmwudG9TdHJpbmcoKSk7CiAgICAgIHZhciBpLCBuLCBhbGxvd2VkID0gZmFsc2U7CiAgICAgIC8vIEVuc3VyZSB0aGF0IGF0IGxlYXN0IG9uZSBpdGVtIGZyb20gdGhlIHdoaXRlbGlzdCBhbGxvd3MgdGhpcyB1cmwuCiAgICAgIGZvciAoaSA9IDAsIG4gPSByZXNvdXJjZVVybFdoaXRlbGlzdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgICBpZiAobWF0Y2hVcmwocmVzb3VyY2VVcmxXaGl0ZWxpc3RbaV0sIHBhcnNlZFVybCkpIHsKICAgICAgICAgIGFsbG93ZWQgPSB0cnVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChhbGxvd2VkKSB7CiAgICAgICAgLy8gRW5zdXJlIHRoYXQgbm8gaXRlbSBmcm9tIHRoZSBibGFja2xpc3QgYmxvY2tlZCB0aGlzIHVybC4KICAgICAgICBmb3IgKGkgPSAwLCBuID0gcmVzb3VyY2VVcmxCbGFja2xpc3QubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICBpZiAobWF0Y2hVcmwocmVzb3VyY2VVcmxCbGFja2xpc3RbaV0sIHBhcnNlZFVybCkpIHsKICAgICAgICAgICAgYWxsb3dlZCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFsbG93ZWQ7CiAgICB9CgogICAgZnVuY3Rpb24gZ2VuZXJhdGVIb2xkZXJUeXBlKEJhc2UpIHsKICAgICAgdmFyIGhvbGRlclR5cGUgPSBmdW5jdGlvbiBUcnVzdGVkVmFsdWVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZSkgewogICAgICAgIHRoaXMuJCR1bndyYXBUcnVzdGVkVmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0cnVzdGVkVmFsdWU7CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgaWYgKEJhc2UpIHsKICAgICAgICBob2xkZXJUeXBlLnByb3RvdHlwZSA9IG5ldyBCYXNlKCk7CiAgICAgIH0KICAgICAgaG9sZGVyVHlwZS5wcm90b3R5cGUudmFsdWVPZiA9IGZ1bmN0aW9uIHNjZVZhbHVlT2YoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuJCR1bndyYXBUcnVzdGVkVmFsdWUoKTsKICAgICAgfTsKICAgICAgaG9sZGVyVHlwZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiBzY2VUb1N0cmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpLnRvU3RyaW5nKCk7CiAgICAgIH07CiAgICAgIHJldHVybiBob2xkZXJUeXBlOwogICAgfQoKICAgIHZhciB0cnVzdGVkVmFsdWVIb2xkZXJCYXNlID0gZ2VuZXJhdGVIb2xkZXJUeXBlKCksCiAgICAgICAgYnlUeXBlID0ge307CgogICAgYnlUeXBlW1NDRV9DT05URVhUUy5IVE1MXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuQ1NTXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuVVJMXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuSlNdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgYnlUeXBlW1NDRV9DT05URVhUUy5SRVNPVVJDRV9VUkxdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKGJ5VHlwZVtTQ0VfQ09OVEVYVFMuVVJMXSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyBhbiBvYmplY3QgdGhhdCBpcyB0cnVzdGVkIGJ5IGFuZ3VsYXIgZm9yIHVzZSBpbiBzcGVjaWZpZWQgc3RyaWN0CiAgICAgKiBjb250ZXh0dWFsIGVzY2FwaW5nIGNvbnRleHRzIChzdWNoIGFzIG5nLWJpbmQtaHRtbCwgbmctaW5jbHVkZSwgYW55IHNyYwogICAgICogYXR0cmlidXRlIGludGVycG9sYXRpb24sIGFueSBkb20gZXZlbnQgYmluZGluZyBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbgogICAgICogc3VjaCBhcyBmb3Igb25jbGljaywgIGV0Yy4pIHRoYXQgdXNlcyB0aGUgcHJvdmlkZWQgdmFsdWUuCiAgICAgKiBTZWUge0BsaW5rIG5nLiRzY2UgJHNjZX0gZm9yIGVuYWJsaW5nIHN0cmljdCBjb250ZXh0dWFsIGVzY2FwaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIGNvbnRleHQgaW4gd2hpY2ggdGhpcyB2YWx1ZSBpcyBzYWZlIGZvciB1c2UuICBlLmcuIHVybCwKICAgICAqICAgcmVzb3VyY2VVcmwsIGh0bWwsIGpzIGFuZCBjc3MuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0aGF0IHRoYXQgc2hvdWxkIGJlIGNvbnNpZGVyZWQgdHJ1c3RlZC9zYWZlLgogICAgICogQHJldHVybnMgeyp9IEEgdmFsdWUgdGhhdCBjYW4gYmUgdXNlZCB0byBzdGFuZCBpbiBmb3IgdGhlIHByb3ZpZGVkIGB2YWx1ZWAgaW4gcGxhY2VzCiAgICAgKiB3aGVyZSBBbmd1bGFyIGV4cGVjdHMgYSAkc2NlLnRydXN0QXMoKSByZXR1cm4gdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRydXN0QXModHlwZSwgdHJ1c3RlZFZhbHVlKSB7CiAgICAgIHZhciBDb25zdHJ1Y3RvciA9IChieVR5cGUuaGFzT3duUHJvcGVydHkodHlwZSkgPyBieVR5cGVbdHlwZV0gOiBudWxsKTsKICAgICAgaWYgKCFDb25zdHJ1Y3RvcikgewogICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2ljb250ZXh0JywKICAgICAgICAgICAgJ0F0dGVtcHRlZCB0byB0cnVzdCBhIHZhbHVlIGluIGludmFsaWQgY29udGV4dC4gQ29udGV4dDogezB9OyBWYWx1ZTogezF9JywKICAgICAgICAgICAgdHlwZSwgdHJ1c3RlZFZhbHVlKTsKICAgICAgfQogICAgICBpZiAodHJ1c3RlZFZhbHVlID09PSBudWxsIHx8IHRydXN0ZWRWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHRydXN0ZWRWYWx1ZSA9PT0gJycpIHsKICAgICAgICByZXR1cm4gdHJ1c3RlZFZhbHVlOwogICAgICB9CiAgICAgIC8vIEFsbCB0aGUgY3VycmVudCBjb250ZXh0cyBpbiBTQ0VfQ09OVEVYVFMgaGFwcGVuIHRvIGJlIHN0cmluZ3MuICBJbiBvcmRlciB0byBhdm9pZCB0cnVzdGluZwogICAgICAvLyBtdXRhYmxlIG9iamVjdHMsIHdlIGVuc3VyZSBoZXJlIHRoYXQgdGhlIHZhbHVlIHBhc3NlZCBpbiBpcyBhY3R1YWxseSBhIHN0cmluZy4KICAgICAgaWYgKHR5cGVvZiB0cnVzdGVkVmFsdWUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgdGhyb3cgJHNjZU1pbkVycignaXR5cGUnLAogICAgICAgICAgICAnQXR0ZW1wdGVkIHRvIHRydXN0IGEgbm9uLXN0cmluZyB2YWx1ZSBpbiBhIGNvbnRlbnQgcmVxdWlyaW5nIGEgc3RyaW5nOiBDb250ZXh0OiB7MH0nLAogICAgICAgICAgICB0eXBlKTsKICAgICAgfQogICAgICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKHRydXN0ZWRWYWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlRGVsZWdhdGUjdmFsdWVPZgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSWYgdGhlIHBhc3NlZCBwYXJhbWV0ZXIgaGFkIGJlZW4gcmV0dXJuZWQgYnkgYSBwcmlvciBjYWxsIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICogYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0sIHJldHVybnMgdGhlIHZhbHVlIHRoYXQgaGFkIGJlZW4gcGFzc2VkIHRvIHtAbGluawogICAgICogbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0uCiAgICAgKgogICAgICogSWYgdGhlIHBhc3NlZCBwYXJhbWV0ZXIgaXMgbm90IGEgdmFsdWUgdGhhdCBoYWQgYmVlbiByZXR1cm5lZCBieSB7QGxpbmsKICAgICAqIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LCByZXR1cm5zIGl0IGFzLWlzLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHJlc3VsdCBvZiBhIHByaW9yIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfQogICAgICogICAgICBjYWxsIG9yIGFueXRoaW5nIGVsc2UuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIGB2YWx1ZWAgdGhhdCB3YXMgb3JpZ2luYWxseSBwcm92aWRlZCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBpZiBgdmFsdWVgIGlzIHRoZSByZXN1bHQgb2Ygc3VjaCBhIGNhbGwuICBPdGhlcndpc2UsIHJldHVybnMKICAgICAqICAgICBgdmFsdWVgIHVuY2hhbmdlZC4KICAgICAqLwogICAgZnVuY3Rpb24gdmFsdWVPZihtYXliZVRydXN0ZWQpIHsKICAgICAgaWYgKG1heWJlVHJ1c3RlZCBpbnN0YW5jZW9mIHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpIHsKICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZURlbGVnYXRlI2dldFRydXN0ZWQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRha2VzIHRoZSByZXN1bHQgb2YgYSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gY2FsbCBhbmQKICAgICAqIHJldHVybnMgdGhlIG9yaWdpbmFsbHkgc3VwcGxpZWQgdmFsdWUgaWYgdGhlIHF1ZXJpZWQgY29udGV4dCB0eXBlIGlzIGEgc3VwZXJ0eXBlIG9mIHRoZQogICAgICogY3JlYXRlZCB0eXBlLiAgSWYgdGhpcyBjb25kaXRpb24gaXNuJ3Qgc2F0aXNmaWVkLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIGNvbnRleHQgaW4gd2hpY2ggdGhpcyB2YWx1ZSBpcyB0byBiZSB1c2VkLgogICAgICogQHBhcmFtIHsqfSBtYXliZVRydXN0ZWQgVGhlIHJlc3VsdCBvZiBhIHByaW9yIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICogICAgIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9IGNhbGwuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHZhbHVlIHRoZSB3YXMgb3JpZ2luYWxseSBwcm92aWRlZCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBpZiB2YWxpZCBpbiB0aGlzIGNvbnRleHQuICBPdGhlcndpc2UsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldFRydXN0ZWQodHlwZSwgbWF5YmVUcnVzdGVkKSB7CiAgICAgIGlmIChtYXliZVRydXN0ZWQgPT09IG51bGwgfHwgbWF5YmVUcnVzdGVkID09PSB1bmRlZmluZWQgfHwgbWF5YmVUcnVzdGVkID09PSAnJykgewogICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgIH0KICAgICAgdmFyIGNvbnN0cnVjdG9yID0gKGJ5VHlwZS5oYXNPd25Qcm9wZXJ0eSh0eXBlKSA/IGJ5VHlwZVt0eXBlXSA6IG51bGwpOwogICAgICBpZiAoY29uc3RydWN0b3IgJiYgbWF5YmVUcnVzdGVkIGluc3RhbmNlb2YgY29uc3RydWN0b3IpIHsKICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCk7CiAgICAgIH0KICAgICAgLy8gSWYgd2UgZ2V0IGhlcmUsIHRoZW4gd2UgbWF5IG9ubHkgdGFrZSBvbmUgb2YgdHdvIGFjdGlvbnMuCiAgICAgIC8vIDEuIHNhbml0aXplIHRoZSB2YWx1ZSBmb3IgdGhlIHJlcXVlc3RlZCB0eXBlLCBvcgogICAgICAvLyAyLiB0aHJvdyBhbiBleGNlcHRpb24uCiAgICAgIGlmICh0eXBlID09PSBTQ0VfQ09OVEVYVFMuUkVTT1VSQ0VfVVJMKSB7CiAgICAgICAgaWYgKGlzUmVzb3VyY2VVcmxBbGxvd2VkQnlQb2xpY3kobWF5YmVUcnVzdGVkKSkgewogICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgJHNjZU1pbkVycignaW5zZWN1cmwnLAogICAgICAgICAgICAgICdCbG9ja2VkIGxvYWRpbmcgcmVzb3VyY2UgZnJvbSB1cmwgbm90IGFsbG93ZWQgYnkgJHNjZURlbGVnYXRlIHBvbGljeS4gIFVSTDogezB9JywKICAgICAgICAgICAgICBtYXliZVRydXN0ZWQudG9TdHJpbmcoKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09IFNDRV9DT05URVhUUy5IVE1MKSB7CiAgICAgICAgcmV0dXJuIGh0bWxTYW5pdGl6ZXIobWF5YmVUcnVzdGVkKTsKICAgICAgfQogICAgICB0aHJvdyAkc2NlTWluRXJyKCd1bnNhZmUnLCAnQXR0ZW1wdGluZyB0byB1c2UgYW4gdW5zYWZlIHZhbHVlIGluIGEgc2FmZSBjb250ZXh0LicpOwogICAgfQoKICAgIHJldHVybiB7IHRydXN0QXM6IHRydXN0QXMsCiAgICAgICAgICAgICBnZXRUcnVzdGVkOiBnZXRUcnVzdGVkLAogICAgICAgICAgICAgdmFsdWVPZjogdmFsdWVPZiB9OwogIH1dOwp9CgoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkc2NlUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqCiAqIFRoZSAkc2NlUHJvdmlkZXIgcHJvdmlkZXIgYWxsb3dzIGRldmVsb3BlcnMgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgbmcuJHNjZSAkc2NlfSBzZXJ2aWNlLgogKiAtICAgZW5hYmxlL2Rpc2FibGUgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSkgaW4gYSBtb2R1bGUKICogLSAgIG92ZXJyaWRlIHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHdpdGggYSBjdXN0b20gZGVsZWdhdGUKICoKICogUmVhZCBtb3JlIGFib3V0IHtAbGluayBuZy4kc2NlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfS4KICovCgovKiBqc2hpbnQgbWF4bGVuOiBmYWxzZSovCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHNjZQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICoKICogYCRzY2VgIGlzIGEgc2VydmljZSB0aGF0IHByb3ZpZGVzIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIHNlcnZpY2VzIHRvIEFuZ3VsYXJKUy4KICoKICogIyBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZwogKgogKiBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKSBpcyBhIG1vZGUgaW4gd2hpY2ggQW5ndWxhckpTIHJlcXVpcmVzIGJpbmRpbmdzIGluIGNlcnRhaW4KICogY29udGV4dHMgdG8gcmVzdWx0IGluIGEgdmFsdWUgdGhhdCBpcyBtYXJrZWQgYXMgc2FmZSB0byB1c2UgZm9yIHRoYXQgY29udGV4dC4gIE9uZSBleGFtcGxlIG9mCiAqIHN1Y2ggYSBjb250ZXh0IGlzIGJpbmRpbmcgYXJiaXRyYXJ5IGh0bWwgY29udHJvbGxlZCBieSB0aGUgdXNlciB2aWEgYG5nLWJpbmQtaHRtbGAuICBXZSByZWZlcgogKiB0byB0aGVzZSBjb250ZXh0cyBhcyBwcml2aWxlZ2VkIG9yIFNDRSBjb250ZXh0cy4KICoKICogQXMgb2YgdmVyc2lvbiAxLjIsIEFuZ3VsYXIgc2hpcHMgd2l0aCBTQ0UgZW5hYmxlZCBieSBkZWZhdWx0LgogKgogKiBOb3RlOiAgV2hlbiBlbmFibGVkICh0aGUgZGVmYXVsdCksIElFOCBpbiBxdWlya3MgbW9kZSBpcyBub3Qgc3VwcG9ydGVkLiAgSW4gdGhpcyBtb2RlLCBJRTggYWxsb3dzCiAqIG9uZSB0byBleGVjdXRlIGFyYml0cmFyeSBqYXZhc2NyaXB0IGJ5IHRoZSB1c2Ugb2YgdGhlIGV4cHJlc3Npb24oKSBzeW50YXguICBSZWZlcgogKiA8aHR0cDovL2Jsb2dzLm1zZG4uY29tL2IvaWUvYXJjaGl2ZS8yMDA4LzEwLzE2L2VuZGluZy1leHByZXNzaW9ucy5hc3B4PiB0byBsZWFybiBtb3JlIGFib3V0IHRoZW0uCiAqIFlvdSBjYW4gZW5zdXJlIHlvdXIgZG9jdW1lbnQgaXMgaW4gc3RhbmRhcmRzIG1vZGUgYW5kIG5vdCBxdWlya3MgbW9kZSBieSBhZGRpbmcgYDwhZG9jdHlwZSBodG1sPmAKICogdG8gdGhlIHRvcCBvZiB5b3VyIEhUTUwgZG9jdW1lbnQuCiAqCiAqIFNDRSBhc3Npc3RzIGluIHdyaXRpbmcgY29kZSBpbiB3YXkgdGhhdCAoYSkgaXMgc2VjdXJlIGJ5IGRlZmF1bHQgYW5kIChiKSBtYWtlcyBhdWRpdGluZyBmb3IKICogc2VjdXJpdHkgdnVsbmVyYWJpbGl0aWVzIHN1Y2ggYXMgWFNTLCBjbGlja2phY2tpbmcsIGV0Yy4gYSBsb3QgZWFzaWVyLgogKgogKiBIZXJlJ3MgYW4gZXhhbXBsZSBvZiBhIGJpbmRpbmcgaW4gYSBwcml2aWxlZ2VkIGNvbnRleHQ6CiAqCiAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICogICAgIDxpbnB1dCBuZy1tb2RlbD0idXNlckh0bWwiPgogKiAgICAgPGRpdiBuZy1iaW5kLWh0bWw9InVzZXJIdG1sIj4KICogPC9wcmU+CiAqCiAqIE5vdGljZSB0aGF0IGBuZy1iaW5kLWh0bWxgIGlzIGJvdW5kIHRvIGB1c2VySHRtbGAgY29udHJvbGxlZCBieSB0aGUgdXNlci4gIFdpdGggU0NFCiAqIGRpc2FibGVkLCB0aGlzIGFwcGxpY2F0aW9uIGFsbG93cyB0aGUgdXNlciB0byByZW5kZXIgYXJiaXRyYXJ5IEhUTUwgaW50byB0aGUgRElWLgogKiBJbiBhIG1vcmUgcmVhbGlzdGljIGV4YW1wbGUsIG9uZSBtYXkgYmUgcmVuZGVyaW5nIHVzZXIgY29tbWVudHMsIGJsb2cgYXJ0aWNsZXMsIGV0Yy4gdmlhCiAqIGJpbmRpbmdzLiAgKEhUTUwgaXMganVzdCBvbmUgZXhhbXBsZSBvZiBhIGNvbnRleHQgd2hlcmUgcmVuZGVyaW5nIHVzZXIgY29udHJvbGxlZCBpbnB1dCBjcmVhdGVzCiAqIHNlY3VyaXR5IHZ1bG5lcmFiaWxpdGllcy4pCiAqCiAqIEZvciB0aGUgY2FzZSBvZiBIVE1MLCB5b3UgbWlnaHQgdXNlIGEgbGlicmFyeSwgZWl0aGVyIG9uIHRoZSBjbGllbnQgc2lkZSwgb3Igb24gdGhlIHNlcnZlciBzaWRlLAogKiB0byBzYW5pdGl6ZSB1bnNhZmUgSFRNTCBiZWZvcmUgYmluZGluZyB0byB0aGUgdmFsdWUgYW5kIHJlbmRlcmluZyBpdCBpbiB0aGUgZG9jdW1lbnQuCiAqCiAqIEhvdyB3b3VsZCB5b3UgZW5zdXJlIHRoYXQgZXZlcnkgcGxhY2UgdGhhdCB1c2VkIHRoZXNlIHR5cGVzIG9mIGJpbmRpbmdzIHdhcyBib3VuZCB0byBhIHZhbHVlIHRoYXQKICogd2FzIHNhbml0aXplZCBieSB5b3VyIGxpYnJhcnkgKG9yIHJldHVybmVkIGFzIHNhZmUgZm9yIHJlbmRlcmluZyBieSB5b3VyIHNlcnZlcj8pICBIb3cgY2FuIHlvdQogKiBlbnN1cmUgdGhhdCB5b3UgZGlkbid0IGFjY2lkZW50YWxseSBkZWxldGUgdGhlIGxpbmUgdGhhdCBzYW5pdGl6ZWQgdGhlIHZhbHVlLCBvciByZW5hbWVkIHNvbWUKICogcHJvcGVydGllcy9maWVsZHMgYW5kIGZvcmdvdCB0byB1cGRhdGUgdGhlIGJpbmRpbmcgdG8gdGhlIHNhbml0aXplZCB2YWx1ZT8KICoKICogVG8gYmUgc2VjdXJlIGJ5IGRlZmF1bHQsIHlvdSB3YW50IHRvIGVuc3VyZSB0aGF0IGFueSBzdWNoIGJpbmRpbmdzIGFyZSBkaXNhbGxvd2VkIHVubGVzcyB5b3UgY2FuCiAqIGRldGVybWluZSB0aGF0IHNvbWV0aGluZyBleHBsaWNpdGx5IHNheXMgaXQncyBzYWZlIHRvIHVzZSBhIHZhbHVlIGZvciBiaW5kaW5nIGluIHRoYXQKICogY29udGV4dC4gIFlvdSBjYW4gdGhlbiBhdWRpdCB5b3VyIGNvZGUgKGEgc2ltcGxlIGdyZXAgd291bGQgZG8pIHRvIGVuc3VyZSB0aGF0IHRoaXMgaXMgb25seSBkb25lCiAqIGZvciB0aG9zZSB2YWx1ZXMgdGhhdCB5b3UgY2FuIGVhc2lseSB0ZWxsIGFyZSBzYWZlIC0gYmVjYXVzZSB0aGV5IHdlcmUgcmVjZWl2ZWQgZnJvbSB5b3VyIHNlcnZlciwKICogc2FuaXRpemVkIGJ5IHlvdXIgbGlicmFyeSwgZXRjLiAgWW91IGNhbiBvcmdhbml6ZSB5b3VyIGNvZGViYXNlIHRvIGhlbHAgd2l0aCB0aGlzIC0gcGVyaGFwcwogKiBhbGxvd2luZyBvbmx5IHRoZSBmaWxlcyBpbiBhIHNwZWNpZmljIGRpcmVjdG9yeSB0byBkbyB0aGlzLiAgRW5zdXJpbmcgdGhhdCB0aGUgaW50ZXJuYWwgQVBJCiAqIGV4cG9zZWQgYnkgdGhhdCBjb2RlIGRvZXNuJ3QgbWFya3VwIGFyYml0cmFyeSB2YWx1ZXMgYXMgc2FmZSB0aGVuIGJlY29tZXMgYSBtb3JlIG1hbmFnZWFibGUgdGFzay4KICoKICogSW4gdGhlIGNhc2Ugb2YgQW5ndWxhckpTJyBTQ0Ugc2VydmljZSwgb25lIHVzZXMge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9CiAqIChhbmQgc2hvcnRoYW5kIG1ldGhvZHMgc3VjaCBhcyB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzSHRtbCAkc2NlLnRydXN0QXNIdG1sfSwgZXRjLikgdG8KICogb2J0YWluIHZhbHVlcyB0aGF0IHdpbGwgYmUgYWNjZXB0ZWQgYnkgU0NFIC8gcHJpdmlsZWdlZCBjb250ZXh0cy4KICoKICoKICogIyMgSG93IGRvZXMgaXQgd29yaz8KICoKICogSW4gcHJpdmlsZWdlZCBjb250ZXh0cywgZGlyZWN0aXZlcyBhbmQgY29kZSB3aWxsIGJpbmQgdG8gdGhlIHJlc3VsdCBvZiB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkCiAqICRzY2UuZ2V0VHJ1c3RlZChjb250ZXh0LCB2YWx1ZSl9IHJhdGhlciB0aGFuIHRvIHRoZSB2YWx1ZSBkaXJlY3RseS4gIERpcmVjdGl2ZXMgdXNlIHtAbGluawogKiBuZy4kc2NlI3BhcnNlICRzY2UucGFyc2VBc30gcmF0aGVyIHRoYW4gYCRwYXJzZWAgdG8gd2F0Y2ggYXR0cmlidXRlIGJpbmRpbmdzLCB3aGljaCBwZXJmb3JtcyB0aGUKICoge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWR9IGJlaGluZCB0aGUgc2NlbmVzIG9uIG5vbi1jb25zdGFudCBsaXRlcmFscy4KICoKICogQXMgYW4gZXhhbXBsZSwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IHVzZXMge0BsaW5rCiAqIG5nLiRzY2UjcGFyc2VBc0h0bWwgJHNjZS5wYXJzZUFzSHRtbChiaW5kaW5nIGV4cHJlc3Npb24pfS4gIEhlcmUncyB0aGUgYWN0dWFsIGNvZGUgKHNsaWdodGx5CiAqIHNpbXBsaWZpZWQpOgogKgogKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAqICAgdmFyIG5nQmluZEh0bWxEaXJlY3RpdmUgPSBbJyRzY2UnLCBmdW5jdGlvbigkc2NlKSB7CiAqICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICogICAgICAgc2NvcGUuJHdhdGNoKCRzY2UucGFyc2VBc0h0bWwoYXR0ci5uZ0JpbmRIdG1sKSwgZnVuY3Rpb24odmFsdWUpIHsKICogICAgICAgICBlbGVtZW50Lmh0bWwodmFsdWUgfHwgJycpOwogKiAgICAgICB9KTsKICogICAgIH07CiAqICAgfV07CiAqIDwvcHJlPgogKgogKiAjIyBJbXBhY3Qgb24gbG9hZGluZyB0ZW1wbGF0ZXMKICoKICogVGhpcyBhcHBsaWVzIGJvdGggdG8gdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIGBuZy1pbmNsdWRlYH0gZGlyZWN0aXZlIGFzIHdlbGwgYXMKICogYHRlbXBsYXRlVXJsYCdzIHNwZWNpZmllZCBieSB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogKgogKiBCeSBkZWZhdWx0LCBBbmd1bGFyIG9ubHkgbG9hZHMgdGVtcGxhdGVzIGZyb20gdGhlIHNhbWUgZG9tYWluIGFuZCBwcm90b2NvbCBhcyB0aGUgYXBwbGljYXRpb24KICogZG9jdW1lbnQuICBUaGlzIGlzIGRvbmUgYnkgY2FsbGluZyB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwKICogJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9IG9uIHRoZSB0ZW1wbGF0ZSBVUkwuICBUbyBsb2FkIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgYW5kL29yCiAqIHByb3RvY29scywgeW91IG1heSBlaXRoZXIgZWl0aGVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3QKICogdGhlbX0gb3Ige0BsaW5rIG5nLiRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsIHdyYXAgaXR9IGludG8gYSB0cnVzdGVkIHZhbHVlLgogKgogKiAqUGxlYXNlIG5vdGUqOgogKiBUaGUgYnJvd3NlcidzCiAqIFtTYW1lIE9yaWdpbiBQb2xpY3ldKGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvYnJvd3NlcnNlYy93aWtpL1BhcnQyI1NhbWUtb3JpZ2luX3BvbGljeV9mb3JfWE1MSHR0cFJlcXVlc3QpCiAqIGFuZCBbQ3Jvc3MtT3JpZ2luIFJlc291cmNlIFNoYXJpbmcgKENPUlMpXShodHRwOi8vd3d3LnczLm9yZy9UUi9jb3JzLykKICogcG9saWN5IGFwcGx5IGluIGFkZGl0aW9uIHRvIHRoaXMgYW5kIG1heSBmdXJ0aGVyIHJlc3RyaWN0IHdoZXRoZXIgdGhlIHRlbXBsYXRlIGlzIHN1Y2Nlc3NmdWxseQogKiBsb2FkZWQuICBUaGlzIG1lYW5zIHRoYXQgd2l0aG91dCB0aGUgcmlnaHQgQ09SUyBwb2xpY3ksIGxvYWRpbmcgdGVtcGxhdGVzIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluCiAqIHdvbid0IHdvcmsgb24gYWxsIGJyb3dzZXJzLiAgQWxzbywgbG9hZGluZyB0ZW1wbGF0ZXMgZnJvbSBgZmlsZTovL2AgVVJMIGRvZXMgbm90IHdvcmsgb24gc29tZQogKiBicm93c2Vycy4KICoKICogIyMgVGhpcyBmZWVscyBsaWtlIHRvbyBtdWNoIG92ZXJoZWFkIGZvciB0aGUgZGV2ZWxvcGVyPwogKgogKiBJdCdzIGltcG9ydGFudCB0byByZW1lbWJlciB0aGF0IFNDRSBvbmx5IGFwcGxpZXMgdG8gaW50ZXJwb2xhdGlvbiBleHByZXNzaW9ucy4KICoKICogSWYgeW91ciBleHByZXNzaW9ucyBhcmUgY29uc3RhbnQgbGl0ZXJhbHMsIHRoZXkncmUgYXV0b21hdGljYWxseSB0cnVzdGVkIGFuZCB5b3UgZG9uJ3QgbmVlZCB0bwogKiBjYWxsIGAkc2NlLnRydXN0QXNgIG9uIHRoZW0gKHJlbWVtYmVyIHRvIGluY2x1ZGUgdGhlIGBuZ1Nhbml0aXplYCBtb2R1bGUpIChlLmcuCiAqIGA8ZGl2IG5nLWJpbmQtaHRtbD0iJzxiPmltcGxpY2l0bHkgdHJ1c3RlZDwvYj4nIj48L2Rpdj5gKSBqdXN0IHdvcmtzLgogKgogKiBBZGRpdGlvbmFsbHksIGBhW2hyZWZdYCBhbmQgYGltZ1tzcmNdYCBhdXRvbWF0aWNhbGx5IHNhbml0aXplIHRoZWlyIFVSTHMgYW5kIGRvIG5vdCBwYXNzIHRoZW0KICogdGhyb3VnaCB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkICRzY2UuZ2V0VHJ1c3RlZH0uICBTQ0UgZG9lc24ndCBwbGF5IGEgcm9sZSBoZXJlLgogKgogKiBUaGUgaW5jbHVkZWQge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSAkc2NlRGVsZWdhdGV9IGNvbWVzIHdpdGggc2FuZSBkZWZhdWx0cyB0byBhbGxvdyB5b3UgdG8gbG9hZAogKiB0ZW1wbGF0ZXMgaW4gYG5nLWluY2x1ZGVgIGZyb20geW91ciBhcHBsaWNhdGlvbidzIGRvbWFpbiB3aXRob3V0IGhhdmluZyB0byBldmVuIGtub3cgYWJvdXQgU0NFLgogKiBJdCBibG9ja3MgbG9hZGluZyB0ZW1wbGF0ZXMgZnJvbSBvdGhlciBkb21haW5zIG9yIGxvYWRpbmcgdGVtcGxhdGVzIG92ZXIgaHR0cCBmcm9tIGFuIGh0dHBzCiAqIHNlcnZlZCBkb2N1bWVudC4gIFlvdSBjYW4gY2hhbmdlIHRoZXNlIGJ5IHNldHRpbmcgeW91ciBvd24gY3VzdG9tIHtAbGluawogKiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3RzfSBhbmQge0BsaW5rCiAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0IGJsYWNrbGlzdHN9IGZvciBtYXRjaGluZyBzdWNoIFVSTHMuCiAqCiAqIFRoaXMgc2lnbmlmaWNhbnRseSByZWR1Y2VzIHRoZSBvdmVyaGVhZC4gIEl0IGlzIGZhciBlYXNpZXIgdG8gcGF5IHRoZSBzbWFsbCBvdmVyaGVhZCBhbmQgaGF2ZSBhbgogKiBhcHBsaWNhdGlvbiB0aGF0J3Mgc2VjdXJlIGFuZCBjYW4gYmUgYXVkaXRlZCB0byB2ZXJpZnkgdGhhdCB3aXRoIG11Y2ggbW9yZSBlYXNlIHRoYW4gYm9sdGluZwogKiBzZWN1cml0eSBvbnRvIGFuIGFwcGxpY2F0aW9uIGxhdGVyLgogKgogKiA8YSBuYW1lPSJjb250ZXh0cyI+PC9hPgogKiAjIyBXaGF0IHRydXN0ZWQgY29udGV4dCB0eXBlcyBhcmUgc3VwcG9ydGVkPwogKgogKiB8IENvbnRleHQgICAgICAgICAgICAgfCBOb3RlcyAgICAgICAgICB8CiAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLXwKICogfCBgJHNjZS5IVE1MYCAgICAgICAgIHwgRm9yIEhUTUwgdGhhdCdzIHNhZmUgdG8gc291cmNlIGludG8gdGhlIGFwcGxpY2F0aW9uLiAgVGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdCaW5kSHRtbCBuZ0JpbmRIdG1sfSBkaXJlY3RpdmUgdXNlcyB0aGlzIGNvbnRleHQgZm9yIGJpbmRpbmdzLiBJZiBhbiB1bnNhZmUgdmFsdWUgaXMgZW5jb3VudGVyZWQgYW5kIHRoZSB7QGxpbmsgbmdTYW5pdGl6ZSAkc2FuaXRpemV9IG1vZHVsZSBpcyBwcmVzZW50IHRoaXMgd2lsbCBzYW5pdGl6ZSB0aGUgdmFsdWUgaW5zdGVhZCBvZiB0aHJvd2luZyBhbiBlcnJvci4gfAogKiB8IGAkc2NlLkNTU2AgICAgICAgICAgfCBGb3IgQ1NTIHRoYXQncyBzYWZlIHRvIHNvdXJjZSBpbnRvIHRoZSBhcHBsaWNhdGlvbi4gIEN1cnJlbnRseSB1bnVzZWQuICBGZWVsIGZyZWUgdG8gdXNlIGl0IGluIHlvdXIgb3duIGRpcmVjdGl2ZXMuIHwKICogfCBgJHNjZS5VUkxgICAgICAgICAgIHwgRm9yIFVSTHMgdGhhdCBhcmUgc2FmZSB0byBmb2xsb3cgYXMgbGlua3MuICBDdXJyZW50bHkgdW51c2VkIChgPGEgaHJlZj1gIGFuZCBgPGltZyBzcmM9YCBzYW5pdGl6ZSB0aGVpciB1cmxzIGFuZCBkb24ndCBjb25zdGl0dXRlIGFuIFNDRSBjb250ZXh0LiB8CiAqIHwgYCRzY2UuUkVTT1VSQ0VfVVJMYCB8IEZvciBVUkxzIHRoYXQgYXJlIG5vdCBvbmx5IHNhZmUgdG8gZm9sbG93IGFzIGxpbmtzLCBidXQgd2hvc2UgY29udGVudHMgYXJlIGFsc28gc2FmZSB0byBpbmNsdWRlIGluIHlvdXIgYXBwbGljYXRpb24uICBFeGFtcGxlcyBpbmNsdWRlIGBuZy1pbmNsdWRlYCwgYHNyY2AgLyBgbmdTcmNgIGJpbmRpbmdzIGZvciB0YWdzIG90aGVyIHRoYW4gYElNR2AgKGUuZy4gYElGUkFNRWAsIGBPQkpFQ1RgLCBldGMuKSAgPGJyPjxicj5Ob3RlIHRoYXQgYCRzY2UuUkVTT1VSQ0VfVVJMYCBtYWtlcyBhIHN0cm9uZ2VyIHN0YXRlbWVudCBhYm91dCB0aGUgVVJMIHRoYW4gYCRzY2UuVVJMYCBkb2VzIGFuZCB0aGVyZWZvcmUgY29udGV4dHMgcmVxdWlyaW5nIHZhbHVlcyB0cnVzdGVkIGZvciBgJHNjZS5SRVNPVVJDRV9VUkxgIGNhbiBiZSB1c2VkIGFueXdoZXJlIHRoYXQgdmFsdWVzIHRydXN0ZWQgZm9yIGAkc2NlLlVSTGAgYXJlIHJlcXVpcmVkLiB8CiAqIHwgYCRzY2UuSlNgICAgICAgICAgICB8IEZvciBKYXZhU2NyaXB0IHRoYXQgaXMgc2FmZSB0byBleGVjdXRlIGluIHlvdXIgYXBwbGljYXRpb24ncyBjb250ZXh0LiAgQ3VycmVudGx5IHVudXNlZC4gIEZlZWwgZnJlZSB0byB1c2UgaXQgaW4geW91ciBvd24gZGlyZWN0aXZlcy4gfAogKgogKiAjIyBGb3JtYXQgb2YgaXRlbXMgaW4ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHJlc291cmNlVXJsV2hpdGVsaXN0fS97QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgQmxhY2tsaXN0fSA8YSBuYW1lPSJyZXNvdXJjZVVybFBhdHRlcm5JdGVtIj48L2E+CiAqCiAqICBFYWNoIGVsZW1lbnQgaW4gdGhlc2UgYXJyYXlzIG11c3QgYmUgb25lIG9mIHRoZSBmb2xsb3dpbmc6CiAqCiAqICAtICoqJ3NlbGYnKioKICogICAgLSBUaGUgc3BlY2lhbCAqKnN0cmluZyoqLCBgJ3NlbGYnYCwgY2FuIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBhbGwgVVJMcyBvZiB0aGUgKipzYW1lCiAqICAgICAgZG9tYWluKiogYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVzaW5nIHRoZSAqKnNhbWUgcHJvdG9jb2wqKi4KICogIC0gKipTdHJpbmcqKiAoZXhjZXB0IHRoZSBzcGVjaWFsIHZhbHVlIGAnc2VsZidgKQogKiAgICAtIFRoZSBzdHJpbmcgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBmdWxsICpub3JtYWxpemVkIC8gYWJzb2x1dGUgVVJMKiBvZiB0aGUgcmVzb3VyY2UKICogICAgICBiZWluZyB0ZXN0ZWQgKHN1YnN0cmluZyBtYXRjaGVzIGFyZSBub3QgZ29vZCBlbm91Z2guKQogKiAgICAtIFRoZXJlIGFyZSBleGFjdGx5ICoqdHdvIHdpbGRjYXJkIHNlcXVlbmNlcyoqIC0gYCpgIGFuZCBgKipgLiAgQWxsIG90aGVyIGNoYXJhY3RlcnMKICogICAgICBtYXRjaCB0aGVtc2VsdmVzLgogKiAgICAtIGAqYDogbWF0Y2hlcyB6ZXJvIG9yIG1vcmUgb2NjdXJyZW5jZXMgb2YgYW55IGNoYXJhY3RlciBvdGhlciB0aGFuIG9uZSBvZiB0aGUgZm9sbG93aW5nIDYKICogICAgICBjaGFyYWN0ZXJzOiAnYDpgJywgJ2AvYCcsICdgLmAnLCAnYD9gJywgJ2AmYCcgYW5kICc7Jy4gIEl0J3MgYSB1c2VmdWwgd2lsZGNhcmQgZm9yIHVzZQogKiAgICAgIGluIGEgd2hpdGVsaXN0LgogKiAgICAtIGAqKmA6IG1hdGNoZXMgemVybyBvciBtb3JlIG9jY3VycmVuY2VzIG9mICphbnkqIGNoYXJhY3Rlci4gIEFzIHN1Y2gsIGl0J3Mgbm90CiAqICAgICAgbm90IGFwcHJvcHJpYXRlIHRvIHVzZSBpbiBmb3IgYSBzY2hlbWUsIGRvbWFpbiwgZXRjLiBhcyBpdCB3b3VsZCBtYXRjaCB0b28gbXVjaC4gIChlLmcuCiAqICAgICAgaHR0cDovLyoqLmV4YW1wbGUuY29tLyB3b3VsZCBtYXRjaCBodHRwOi8vZXZpbC5jb20vP2lnbm9yZT0uZXhhbXBsZS5jb20vIGFuZCB0aGF0IG1pZ2h0CiAqICAgICAgbm90IGhhdmUgYmVlbiB0aGUgaW50ZW50aW9uLikgIEl0cyB1c2FnZSBhdCB0aGUgdmVyeSBlbmQgb2YgdGhlIHBhdGggaXMgb2suICAoZS5nLgogKiAgICAgIGh0dHA6Ly9mb28uZXhhbXBsZS5jb20vdGVtcGxhdGVzLyoqKS4KICogIC0gKipSZWdFeHAqKiAoKnNlZSBjYXZlYXQgYmVsb3cqKQogKiAgICAtICpDYXZlYXQqOiAgV2hpbGUgcmVndWxhciBleHByZXNzaW9ucyBhcmUgcG93ZXJmdWwgYW5kIG9mZmVyIGdyZWF0IGZsZXhpYmlsaXR5LCAgdGhlaXIgc3ludGF4CiAqICAgICAgKGFuZCBhbGwgdGhlIGluZXZpdGFibGUgZXNjYXBpbmcpIG1ha2VzIHRoZW0gKmhhcmRlciB0byBtYWludGFpbiouICBJdCdzIGVhc3kgdG8KICogICAgICBhY2NpZGVudGFsbHkgaW50cm9kdWNlIGEgYnVnIHdoZW4gb25lIHVwZGF0ZXMgYSBjb21wbGV4IGV4cHJlc3Npb24gKGltaG8sIGFsbCByZWdleGVzIHNob3VsZAogKiAgICAgIGhhdmUgZ29vZCB0ZXN0IGNvdmVyYWdlLikuICBGb3IgaW5zdGFuY2UsIHRoZSB1c2Ugb2YgYC5gIGluIHRoZSByZWdleCBpcyBjb3JyZWN0IG9ubHkgaW4gYQogKiAgICAgIHNtYWxsIG51bWJlciBvZiBjYXNlcy4gIEEgYC5gIGNoYXJhY3RlciBpbiB0aGUgcmVnZXggdXNlZCB3aGVuIG1hdGNoaW5nIHRoZSBzY2hlbWUgb3IgYQogKiAgICAgIHN1YmRvbWFpbiBjb3VsZCBiZSBtYXRjaGVkIGFnYWluc3QgYSBgOmAgb3IgbGl0ZXJhbCBgLmAgdGhhdCB3YXMgbGlrZWx5IG5vdCBpbnRlbmRlZC4gICBJdAogKiAgICAgIGlzIGhpZ2hseSByZWNvbW1lbmRlZCB0byB1c2UgdGhlIHN0cmluZyBwYXR0ZXJucyBhbmQgb25seSBmYWxsIGJhY2sgdG8gcmVndWxhciBleHByZXNzaW9ucwogKiAgICAgIGlmIHRoZXkgYXMgYSBsYXN0IHJlc29ydC4KICogICAgLSBUaGUgcmVndWxhciBleHByZXNzaW9uIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgUmVnRXhwIChpLmUuIG5vdCBhIHN0cmluZy4pICBJdCBpcwogKiAgICAgIG1hdGNoZWQgYWdhaW5zdCB0aGUgKiplbnRpcmUqKiAqbm9ybWFsaXplZCAvIGFic29sdXRlIFVSTCogb2YgdGhlIHJlc291cmNlIGJlaW5nIHRlc3RlZAogKiAgICAgIChldmVuIHdoZW4gdGhlIFJlZ0V4cCBkaWQgbm90IGhhdmUgdGhlIGBeYCBhbmQgYCRgIGNvZGVzLikgIEluIGFkZGl0aW9uLCBhbnkgZmxhZ3MKICogICAgICBwcmVzZW50IG9uIHRoZSBSZWdFeHAgKHN1Y2ggYXMgbXVsdGlsaW5lLCBnbG9iYWwsIGlnbm9yZUNhc2UpIGFyZSBpZ25vcmVkLgogKiAgICAtIElmIHlvdSBhcmUgZ2VuZXJhdGluZyB5b3VyIEphdmFTY3JpcHQgZnJvbSBzb21lIG90aGVyIHRlbXBsYXRpbmcgZW5naW5lIChub3QKICogICAgICByZWNvbW1lbmRlZCwgZS5nLiBpbiBpc3N1ZSBbIzQwMDZdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzQwMDYpKSwKICogICAgICByZW1lbWJlciB0byBlc2NhcGUgeW91ciByZWd1bGFyIGV4cHJlc3Npb24gKGFuZCBiZSBhd2FyZSB0aGF0IHlvdSBtaWdodCBuZWVkIG1vcmUgdGhhbgogKiAgICAgIG9uZSBsZXZlbCBvZiBlc2NhcGluZyBkZXBlbmRpbmcgb24geW91ciB0ZW1wbGF0aW5nIGVuZ2luZSBhbmQgdGhlIHdheSB5b3UgaW50ZXJwb2xhdGVkCiAqICAgICAgdGhlIHZhbHVlLikgIERvIG1ha2UgdXNlIG9mIHlvdXIgcGxhdGZvcm0ncyBlc2NhcGluZyBtZWNoYW5pc20gYXMgaXQgbWlnaHQgYmUgZ29vZAogKiAgICAgIGVub3VnaCBiZWZvcmUgY29kaW5nIHlvdXIgb3duLiAgZS5nLiBSdWJ5IGhhcwogKiAgICAgIFtSZWdleHAuZXNjYXBlKHN0cildKGh0dHA6Ly93d3cucnVieS1kb2Mub3JnL2NvcmUtMi4wLjAvUmVnZXhwLmh0bWwjbWV0aG9kLWMtZXNjYXBlKQogKiAgICAgIGFuZCBQeXRob24gaGFzIFtyZS5lc2NhcGVdKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9yZS5odG1sI3JlLmVzY2FwZSkuCiAqICAgICAgSmF2YXNjcmlwdCBsYWNrcyBhIHNpbWlsYXIgYnVpbHQgaW4gZnVuY3Rpb24gZm9yIGVzY2FwaW5nLiAgVGFrZSBhIGxvb2sgYXQgR29vZ2xlCiAqICAgICAgQ2xvc3VyZSBsaWJyYXJ5J3MgW2dvb2cuc3RyaW5nLnJlZ0V4cEVzY2FwZShzKV0oCiAqICAgICAgaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfc3RyaW5nX3N0cmluZy5qcy5zb3VyY2UuaHRtbCNsaW5lOTYyKS4KICoKICogUmVmZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSBmb3IgYW4gZXhhbXBsZS4KICoKICogIyMgU2hvdyBtZSBhbiBleGFtcGxlIHVzaW5nIFNDRS4KICoKICogQGV4YW1wbGUKPGV4YW1wbGUgbW9kdWxlPSJteVNjZUFwcCIgZGVwcz0iYW5ndWxhci1zYW5pdGl6ZS5qcyI+CjxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogIDxkaXYgbmctY29udHJvbGxlcj0ibXlBcHBDb250cm9sbGVyIGFzIG15Q3RybCI+CiAgICA8aSBuZy1iaW5kLWh0bWw9Im15Q3RybC5leHBsaWNpdGx5VHJ1c3RlZEh0bWwiIGlkPSJleHBsaWNpdGx5VHJ1c3RlZEh0bWwiPjwvaT48YnI+PGJyPgogICAgPGI+VXNlciBjb21tZW50czwvYj48YnI+CiAgICBCeSBkZWZhdWx0LCBIVE1MIHRoYXQgaXNuJ3QgZXhwbGljaXRseSB0cnVzdGVkIChlLmcuIEFsaWNlJ3MgY29tbWVudCkgaXMgc2FuaXRpemVkIHdoZW4KICAgICRzYW5pdGl6ZSBpcyBhdmFpbGFibGUuICBJZiAkc2FuaXRpemUgaXNuJ3QgYXZhaWxhYmxlLCB0aGlzIHJlc3VsdHMgaW4gYW4gZXJyb3IgaW5zdGVhZCBvZiBhbgogICAgZXhwbG9pdC4KICAgIDxkaXYgY2xhc3M9IndlbGwiPgogICAgICA8ZGl2IG5nLXJlcGVhdD0idXNlckNvbW1lbnQgaW4gbXlDdHJsLnVzZXJDb21tZW50cyI+CiAgICAgICAgPGI+e3t1c2VyQ29tbWVudC5uYW1lfX08L2I+OgogICAgICAgIDxzcGFuIG5nLWJpbmQtaHRtbD0idXNlckNvbW1lbnQuaHRtbENvbW1lbnQiIGNsYXNzPSJodG1sQ29tbWVudCI+PC9zcGFuPgogICAgICAgIDxicj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KPC9maWxlPgoKPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICB2YXIgbXlTY2VBcHAgPSBhbmd1bGFyLm1vZHVsZSgnbXlTY2VBcHAnLCBbJ25nU2FuaXRpemUnXSk7CgogIG15U2NlQXBwLmNvbnRyb2xsZXIoIm15QXBwQ29udHJvbGxlciIsIGZ1bmN0aW9uIG15QXBwQ29udHJvbGxlcigkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICRzY2UpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgICRodHRwLmdldCgidGVzdF9kYXRhLmpzb24iLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuc3VjY2VzcyhmdW5jdGlvbih1c2VyQ29tbWVudHMpIHsKICAgICAgc2VsZi51c2VyQ29tbWVudHMgPSB1c2VyQ29tbWVudHM7CiAgICB9KTsKICAgIHNlbGYuZXhwbGljaXRseVRydXN0ZWRIdG1sID0gJHNjZS50cnVzdEFzSHRtbCgKICAgICAgICAnPHNwYW4gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9JnF1b3Q7RXhwbGljaXRseSB0cnVzdGVkIEhUTUwgYnlwYXNzZXMgJyArCiAgICAgICAgJ3Nhbml0aXphdGlvbi4mcXVvdDsiPkhvdmVyIG92ZXIgdGhpcyB0ZXh0Ljwvc3Bhbj4nKTsKICB9KTsKPC9maWxlPgoKPGZpbGUgbmFtZT0idGVzdF9kYXRhLmpzb24iPgpbCiAgeyAibmFtZSI6ICJBbGljZSIsCiAgICAiaHRtbENvbW1lbnQiOgogICAgICAgICI8c3BhbiBvbm1vdXNlb3Zlcj0ndGhpcy50ZXh0Q29udGVudD1cIlBXTjNEIVwiJz5JcyA8aT5hbnlvbmU8L2k+IHJlYWRpbmcgdGhpcz88L3NwYW4+IgogIH0sCiAgeyAibmFtZSI6ICJCb2IiLAogICAgImh0bWxDb21tZW50IjogIjxpPlllcyE8L2k+ICBBbSBJIHRoZSBvbmx5IG90aGVyIG9uZT8iCiAgfQpdCjwvZmlsZT4KCjxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogIGRlc2NyaWJlKCdTQ0UgZG9jIGRlbW8nLCBmdW5jdGlvbigpIHsKICAgIGl0KCdzaG91bGQgc2FuaXRpemUgdW50cnVzdGVkIHZhbHVlcycsIGZ1bmN0aW9uKCkgewogICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5odG1sQ29tbWVudCcpKS5nZXRJbm5lckh0bWwoKSkKICAgICAgICAgIC50b0JlKCc8c3Bhbj5JcyA8aT5hbnlvbmU8L2k+IHJlYWRpbmcgdGhpcz88L3NwYW4+Jyk7CiAgICB9KTsKCiAgICBpdCgnc2hvdWxkIE5PVCBzYW5pdGl6ZSBleHBsaWNpdGx5IHRydXN0ZWQgdmFsdWVzJywgZnVuY3Rpb24oKSB7CiAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdleHBsaWNpdGx5VHJ1c3RlZEh0bWwnKSkuZ2V0SW5uZXJIdG1sKCkpLnRvQmUoCiAgICAgICAgICAnPHNwYW4gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9JnF1b3Q7RXhwbGljaXRseSB0cnVzdGVkIEhUTUwgYnlwYXNzZXMgJyArCiAgICAgICAgICAnc2FuaXRpemF0aW9uLiZxdW90OyI+SG92ZXIgb3ZlciB0aGlzIHRleHQuPC9zcGFuPicpOwogICAgfSk7CiAgfSk7CjwvZmlsZT4KPC9leGFtcGxlPgogKgogKgogKgogKiAjIyBDYW4gSSBkaXNhYmxlIFNDRSBjb21wbGV0ZWx5PwogKgogKiBZZXMsIHlvdSBjYW4uICBIb3dldmVyLCB0aGlzIGlzIHN0cm9uZ2x5IGRpc2NvdXJhZ2VkLiAgU0NFIGdpdmVzIHlvdSBhIGxvdCBvZiBzZWN1cml0eSBiZW5lZml0cwogKiBmb3IgbGl0dGxlIGNvZGluZyBvdmVyaGVhZC4gIEl0IHdpbGwgYmUgbXVjaCBoYXJkZXIgdG8gdGFrZSBhbiBTQ0UgZGlzYWJsZWQgYXBwbGljYXRpb24gYW5kCiAqIGVpdGhlciBzZWN1cmUgaXQgb24geW91ciBvd24gb3IgZW5hYmxlIFNDRSBhdCBhIGxhdGVyIHN0YWdlLiAgSXQgbWlnaHQgbWFrZSBzZW5zZSB0byBkaXNhYmxlIFNDRQogKiBmb3IgY2FzZXMgd2hlcmUgeW91IGhhdmUgYSBsb3Qgb2YgZXhpc3RpbmcgY29kZSB0aGF0IHdhcyB3cml0dGVuIGJlZm9yZSBTQ0Ugd2FzIGludHJvZHVjZWQgYW5kCiAqIHlvdSdyZSBtaWdyYXRpbmcgdGhlbSBhIG1vZHVsZSBhdCBhIHRpbWUuCiAqCiAqIFRoYXQgc2FpZCwgaGVyZSdzIGhvdyB5b3UgY2FuIGNvbXBsZXRlbHkgZGlzYWJsZSBTQ0U6CiAqCiAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICogICBhbmd1bGFyLm1vZHVsZSgnbXlBcHBXaXRoU2NlRGlzYWJsZWRteUFwcCcsIFtdKS5jb25maWcoZnVuY3Rpb24oJHNjZVByb3ZpZGVyKSB7CiAqICAgICAvLyBDb21wbGV0ZWx5IGRpc2FibGUgU0NFLiAgRm9yIGRlbW9uc3RyYXRpb24gcHVycG9zZXMgb25seSEKICogICAgIC8vIERvIG5vdCB1c2UgaW4gbmV3IHByb2plY3RzLgogKiAgICAgJHNjZVByb3ZpZGVyLmVuYWJsZWQoZmFsc2UpOwogKiAgIH0pOwogKiA8L3ByZT4KICoKICovCi8qIGpzaGludCBtYXhsZW46IDEwMCAqLwoKZnVuY3Rpb24gJFNjZVByb3ZpZGVyKCkgewogIHZhciBlbmFibGVkID0gdHJ1ZTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRzY2VQcm92aWRlciNlbmFibGVkCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHZhbHVlIElmIHByb3ZpZGVkLCB0aGVuIGVuYWJsZXMvZGlzYWJsZXMgU0NFLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgU0NFIGlzIGVuYWJsZWQsIGZhbHNlIG90aGVyd2lzZS4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEVuYWJsZXMvZGlzYWJsZXMgU0NFIGFuZCByZXR1cm5zIHRoZSBjdXJyZW50IHZhbHVlLgogICAqLwogIHRoaXMuZW5hYmxlZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgZW5hYmxlZCA9ICEhdmFsdWU7CiAgICB9CiAgICByZXR1cm4gZW5hYmxlZDsKICB9OwoKCiAgLyogRGVzaWduIG5vdGVzIG9uIHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGZvciBTQ0UuCiAgICoKICAgKiBUaGUgQVBJIGNvbnRyYWN0IGZvciB0aGUgU0NFIGRlbGVnYXRlCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFRoZSBTQ0UgZGVsZWdhdGUgb2JqZWN0IG11c3QgcHJvdmlkZSB0aGUgZm9sbG93aW5nIDMgbWV0aG9kczoKICAgKgogICAqIC0gdHJ1c3RBcyhjb250ZXh0RW51bSwgdmFsdWUpCiAgICogICAgIFRoaXMgbWV0aG9kIGlzIHVzZWQgdG8gdGVsbCB0aGUgU0NFIHNlcnZpY2UgdGhhdCB0aGUgcHJvdmlkZWQgdmFsdWUgaXMgT0sgdG8gdXNlIGluIHRoZQogICAqICAgICBjb250ZXh0cyBzcGVjaWZpZWQgYnkgY29udGV4dEVudW0uICBJdCBtdXN0IHJldHVybiBhbiBvYmplY3QgdGhhdCB3aWxsIGJlIGFjY2VwdGVkIGJ5CiAgICogICAgIGdldFRydXN0ZWQoKSBmb3IgYSBjb21wYXRpYmxlIGNvbnRleHRFbnVtIGFuZCByZXR1cm4gdGhpcyB2YWx1ZS4KICAgKgogICAqIC0gdmFsdWVPZih2YWx1ZSkKICAgKiAgICAgRm9yIHZhbHVlcyB0aGF0IHdlcmUgbm90IHByb2R1Y2VkIGJ5IHRydXN0QXMoKSwgcmV0dXJuIHRoZW0gYXMgaXMuICBGb3IgdmFsdWVzIHRoYXQgd2VyZQogICAqICAgICBwcm9kdWNlZCBieSB0cnVzdEFzKCksIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyBpbnB1dCB2YWx1ZSB0byB0cnVzdEFzLiAgQmFzaWNhbGx5LCBpZgogICAqICAgICB0cnVzdEFzIGlzIHdyYXBwaW5nIHRoZSBnaXZlbiB2YWx1ZXMgaW50byBzb21lIHR5cGUsIHRoaXMgb3BlcmF0aW9uIHVud3JhcHMgaXQgd2hlbiBnaXZlbgogICAqICAgICBzdWNoIGEgdmFsdWUuCiAgICoKICAgKiAtIGdldFRydXN0ZWQoY29udGV4dEVudW0sIHZhbHVlKQogICAqICAgICBUaGlzIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gdGhlIGEgdmFsdWUgdGhhdCBpcyBzYWZlIHRvIHVzZSBpbiB0aGUgY29udGV4dCBzcGVjaWZpZWQgYnkKICAgKiAgICAgY29udGV4dEVudW0gb3IgdGhyb3cgYW5kIGV4Y2VwdGlvbiBvdGhlcndpc2UuCiAgICoKICAgKiBOT1RFOiBUaGlzIGNvbnRyYWN0IGRlbGliZXJhdGVseSBkb2VzIE5PVCBzdGF0ZSB0aGF0IHZhbHVlcyByZXR1cm5lZCBieSB0cnVzdEFzKCkgbXVzdCBiZQogICAqIG9wYXF1ZSBvciB3cmFwcGVkIGluIHNvbWUgaG9sZGVyIG9iamVjdC4gIFRoYXQgaGFwcGVucyB0byBiZSBhbiBpbXBsZW1lbnRhdGlvbiBkZXRhaWwuICBGb3IKICAgKiBpbnN0YW5jZSwgYW4gaW1wbGVtZW50YXRpb24gY291bGQgbWFpbnRhaW4gYSByZWdpc3RyeSBvZiBhbGwgdHJ1c3RlZCBvYmplY3RzIGJ5IGNvbnRleHQuICBJbgogICAqIHN1Y2ggYSBjYXNlLCB0cnVzdEFzKCkgd291bGQgcmV0dXJuIHRoZSBzYW1lIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgaW4uICBnZXRUcnVzdGVkKCkgd291bGQKICAgKiByZXR1cm4gdGhlIHNhbWUgb2JqZWN0IHBhc3NlZCBpbiBpZiBpdCB3YXMgZm91bmQgaW4gdGhlIHJlZ2lzdHJ5IHVuZGVyIGEgY29tcGF0aWJsZSBjb250ZXh0IG9yCiAgICogdGhyb3cgYW4gZXhjZXB0aW9uIG90aGVyd2lzZS4gIEFuIGltcGxlbWVudGF0aW9uIG1pZ2h0IG9ubHkgd3JhcCB2YWx1ZXMgc29tZSBvZiB0aGUgdGltZSBiYXNlZAogICAqIG9uIHNvbWUgY3JpdGVyaWEuICBnZXRUcnVzdGVkKCkgbWlnaHQgcmV0dXJuIGEgdmFsdWUgYW5kIG5vdCB0aHJvdyBhbiBleGNlcHRpb24gZm9yIHNwZWNpYWwKICAgKiBjb25zdGFudHMgb3Igb2JqZWN0cyBldmVuIGlmIG5vdCB3cmFwcGVkLiAgQWxsIHN1Y2ggaW1wbGVtZW50YXRpb25zIGZ1bGZpbGwgdGhpcyBjb250cmFjdC4KICAgKgogICAqCiAgICogQSBub3RlIG9uIHRoZSBpbmhlcml0YW5jZSBtb2RlbCBmb3IgU0NFIGNvbnRleHRzCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSSd2ZSB1c2VkIGluaGVyaXRhbmNlIGFuZCBtYWRlIFJFU09VUkNFX1VSTCB3cmFwcGVkIHR5cGVzIGEgc3VidHlwZSBvZiBVUkwgd3JhcHBlZCB0eXBlcy4gIFRoaXMKICAgKiBpcyBwdXJlbHkgYW4gaW1wbGVtZW50YXRpb24gZGV0YWlscy4KICAgKgogICAqIFRoZSBjb250cmFjdCBpcyBzaW1wbHkgdGhpczoKICAgKgogICAqICAgICBnZXRUcnVzdGVkKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSkgc3VjY2VlZGluZyBpbXBsaWVzIHRoYXQgZ2V0VHJ1c3RlZCgkc2NlLlVSTCwgdmFsdWUpCiAgICogICAgIHdpbGwgYWxzbyBzdWNjZWVkLgogICAqCiAgICogSW5oZXJpdGFuY2UgaGFwcGVucyB0byBjYXB0dXJlIHRoaXMgaW4gYSBuYXR1cmFsIHdheS4gIEluIHNvbWUgZnV0dXJlLCB3ZQogICAqIG1heSBub3QgdXNlIGluaGVyaXRhbmNlIGFueW1vcmUuICBUaGF0IGlzIE9LIGJlY2F1c2Ugbm8gY29kZSBvdXRzaWRlIG9mCiAgICogc2NlLmpzIGFuZCBzY2VTcGVjcy5qcyB3b3VsZCBuZWVkIHRvIGJlIGF3YXJlIG9mIHRoaXMgZGV0YWlsLgogICAqLwoKICB0aGlzLiRnZXQgPSBbJyRwYXJzZScsICckc25pZmZlcicsICckc2NlRGVsZWdhdGUnLCBmdW5jdGlvbigKICAgICAgICAgICAgICAgICRwYXJzZSwgICAkc25pZmZlciwgICAkc2NlRGVsZWdhdGUpIHsKICAgIC8vIFByZXJlcTogRW5zdXJlIHRoYXQgd2UncmUgbm90IHJ1bm5pbmcgaW4gSUU4IHF1aXJrcyBtb2RlLiAgSW4gdGhhdCBtb2RlLCBJRSBhbGxvd3MKICAgIC8vIHRoZSAiZXhwcmVzc2lvbihqYXZhc2NyaXB0IGV4cHJlc3Npb24pIiBzeW50YXggd2hpY2ggaXMgaW5zZWN1cmUuCiAgICBpZiAoZW5hYmxlZCAmJiAkc25pZmZlci5tc2llICYmICRzbmlmZmVyLm1zaWVEb2N1bWVudE1vZGUgPCA4KSB7CiAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2llcXVpcmtzJywKICAgICAgICAnU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgZG9lcyBub3Qgc3VwcG9ydCBJbnRlcm5ldCBFeHBsb3JlciB2ZXJzaW9uIDwgOSBpbiBxdWlya3MgJyArCiAgICAgICAgJ21vZGUuICBZb3UgY2FuIGZpeCB0aGlzIGJ5IGFkZGluZyB0aGUgdGV4dCA8IWRvY3R5cGUgaHRtbD4gdG8gdGhlIHRvcCBvZiB5b3VyIEhUTUwgJyArCiAgICAgICAgJ2RvY3VtZW50LiAgU2VlIGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRzY2UgZm9yIG1vcmUgaW5mb3JtYXRpb24uJyk7CiAgICB9CgogICAgdmFyIHNjZSA9IHNoYWxsb3dDb3B5KFNDRV9DT05URVhUUyk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI2lzRW5hYmxlZAogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIFNDRSBpcyBlbmFibGVkLCBmYWxzZSBvdGhlcndpc2UuICBJZiB5b3Ugd2FudCB0byBzZXQgdGhlIHZhbHVlLCB5b3UKICAgICAqIGhhdmUgdG8gZG8gaXQgYXQgbW9kdWxlIGNvbmZpZyB0aW1lIG9uIHtAbGluayBuZy4kc2NlUHJvdmlkZXIgJHNjZVByb3ZpZGVyfS4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybnMgYSBib29sZWFuIGluZGljYXRpbmcgaWYgU0NFIGlzIGVuYWJsZWQuCiAgICAgKi8KICAgIHNjZS5pc0VuYWJsZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBlbmFibGVkOwogICAgfTsKICAgIHNjZS50cnVzdEFzID0gJHNjZURlbGVnYXRlLnRydXN0QXM7CiAgICBzY2UuZ2V0VHJ1c3RlZCA9ICRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkOwogICAgc2NlLnZhbHVlT2YgPSAkc2NlRGVsZWdhdGUudmFsdWVPZjsKCiAgICBpZiAoIWVuYWJsZWQpIHsKICAgICAgc2NlLnRydXN0QXMgPSBzY2UuZ2V0VHJ1c3RlZCA9IGZ1bmN0aW9uKHR5cGUsIHZhbHVlKSB7IHJldHVybiB2YWx1ZTsgfTsKICAgICAgc2NlLnZhbHVlT2YgPSBpZGVudGl0eTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjcGFyc2UKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbnZlcnRzIEFuZ3VsYXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaW50byBhIGZ1bmN0aW9uLiAgVGhpcyBpcyBsaWtlIHtAbGluawogICAgICogbmcuJHBhcnNlICRwYXJzZX0gYW5kIGlzIGlkZW50aWNhbCB3aGVuIHRoZSBleHByZXNzaW9uIGlzIGEgbGl0ZXJhbCBjb25zdGFudC4gIE90aGVyd2lzZSwgaXQKICAgICAqIHdyYXBzIHRoZSBleHByZXNzaW9uIGluIGEgY2FsbCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkICRzY2UuZ2V0VHJ1c3RlZCgqdHlwZSosCiAgICAgKiAqcmVzdWx0Kil9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgU0NFIGNvbnRleHQgaW4gd2hpY2ggdGhpcyByZXN1bHQgd2lsbCBiZSB1c2VkLgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwogICAgc2NlLnBhcnNlQXMgPSBmdW5jdGlvbiBzY2VQYXJzZUFzKHR5cGUsIGV4cHIpIHsKICAgICAgdmFyIHBhcnNlZCA9ICRwYXJzZShleHByKTsKICAgICAgaWYgKHBhcnNlZC5saXRlcmFsICYmIHBhcnNlZC5jb25zdGFudCkgewogICAgICAgIHJldHVybiBwYXJzZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHNjZVBhcnNlQXNUcnVzdGVkKHNlbGYsIGxvY2FscykgewogICAgICAgICAgcmV0dXJuIHNjZS5nZXRUcnVzdGVkKHR5cGUsIHBhcnNlZChzZWxmLCBsb2NhbHMpKTsKICAgICAgICB9OwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSN0cnVzdEFzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZWxlZ2F0ZXMgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LiAgQXMgc3VjaCwKICAgICAqIHJldHVybnMgYW4gb2JqZWN0IHRoYXQgaXMgdHJ1c3RlZCBieSBhbmd1bGFyIGZvciB1c2UgaW4gc3BlY2lmaWVkIHN0cmljdCBjb250ZXh0dWFsCiAgICAgKiBlc2NhcGluZyBjb250ZXh0cyAoc3VjaCBhcyBuZy1iaW5kLWh0bWwsIG5nLWluY2x1ZGUsIGFueSBzcmMgYXR0cmlidXRlCiAgICAgKiBpbnRlcnBvbGF0aW9uLCBhbnkgZG9tIGV2ZW50IGJpbmRpbmcgYXR0cmlidXRlIGludGVycG9sYXRpb24gc3VjaCBhcyBmb3Igb25jbGljaywgIGV0Yy4pCiAgICAgKiB0aGF0IHVzZXMgdGhlIHByb3ZpZGVkIHZhbHVlLiAgU2VlICoge0BsaW5rIG5nLiRzY2UgJHNjZX0gZm9yIGVuYWJsaW5nIHN0cmljdCBjb250ZXh0dWFsCiAgICAgKiBlc2NhcGluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgc2FmZSBmb3IgdXNlLiAgZS5nLiB1cmwsCiAgICAgKiAgIHJlc291cmNlX3VybCwgaHRtbCwganMgYW5kIGNzcy4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRoYXQgdGhhdCBzaG91bGQgYmUgY29uc2lkZXJlZCB0cnVzdGVkL3NhZmUuCiAgICAgKiBAcmV0dXJucyB7Kn0gQSB2YWx1ZSB0aGF0IGNhbiBiZSB1c2VkIHRvIHN0YW5kIGluIGZvciB0aGUgcHJvdmlkZWQgYHZhbHVlYCBpbiBwbGFjZXMKICAgICAqIHdoZXJlIEFuZ3VsYXIgZXhwZWN0cyBhICRzY2UudHJ1c3RBcygpIHJldHVybiB2YWx1ZS4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSN0cnVzdEFzSHRtbAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNIdG1sKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRIdG1sCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkSHRtbCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgKiAgICAgb25seSBhY2NlcHQgZXhwcmVzc2lvbnMgdGhhdCBhcmUgZWl0aGVyIGxpdGVyYWwgY29uc3RhbnRzIG9yIGFyZSB0aGUKICAgICAqICAgICByZXR1cm4gdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSN0cnVzdEFzVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc1VybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRVcmwKICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRVcmwodmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc1Jlc291cmNlVXJsKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICogQHJldHVybnMgeyp9IEFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmwodmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlIHJldHVybgogICAgICogICAgIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc0pzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc0pzKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkpTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkSnMKICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRKcyh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgKiAgICAgb25seSBhY2NlcHQgZXhwcmVzc2lvbnMgdGhhdCBhcmUgZWl0aGVyIGxpdGVyYWwgY29uc3RhbnRzIG9yIGFyZSB0aGUKICAgICAqICAgICByZXR1cm4gdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZWxlZ2F0ZXMgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZGB9LiAgQXMgc3VjaCwKICAgICAqIHRha2VzIHRoZSByZXN1bHQgb2YgYSB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfSgpIGNhbGwgYW5kIHJldHVybnMgdGhlCiAgICAgKiBvcmlnaW5hbGx5IHN1cHBsaWVkIHZhbHVlIGlmIHRoZSBxdWVyaWVkIGNvbnRleHQgdHlwZSBpcyBhIHN1cGVydHlwZSBvZiB0aGUgY3JlYXRlZCB0eXBlLgogICAgICogSWYgdGhpcyBjb25kaXRpb24gaXNuJ3Qgc2F0aXNmaWVkLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIGNvbnRleHQgaW4gd2hpY2ggdGhpcyB2YWx1ZSBpcyB0byBiZSB1c2VkLgogICAgICogQHBhcmFtIHsqfSBtYXliZVRydXN0ZWQgVGhlIHJlc3VsdCBvZiBhIHByaW9yIHtAbGluayBuZy4kc2NlI3RydXN0QXMgYCRzY2UudHJ1c3RBc2B9CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsLgogICAgICogQHJldHVybnMgeyp9IFRoZSB2YWx1ZSB0aGUgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8KICAgICAqICAgICAgICAgICAgICB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfSBpZiB2YWxpZCBpbiB0aGlzIGNvbnRleHQuCiAgICAgKiAgICAgICAgICAgICAgT3RoZXJ3aXNlLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI2dldFRydXN0ZWRIdG1sCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZEh0bWwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuSFRNTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlLmdldFRydXN0ZWRgLgogICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkhUTUwsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkQ3NzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZENzcyh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5DU1MsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5DU1MsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZFVybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkSnMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5nZXRUcnVzdGVkSnModmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuSlMsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5KUywgdmFsdWUpYAogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNIdG1sCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UucGFyc2VBc0h0bWwoZXhwcmVzc2lvbiBzdHJpbmcpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZSBgJHNjZS5wYXJzZUFzKCRzY2UuSFRNTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNDc3MKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzQ3NzKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLkNTUywgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNVcmwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzVXJsKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLlVSTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNSZXNvdXJjZVVybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNSZXNvdXJjZVVybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzSnMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzSnModmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZSBgJHNjZS5wYXJzZUFzKCRzY2UuSlMsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwoKICAgIC8vIFNob3J0aGFuZCBkZWxlZ2F0aW9ucy4KICAgIHZhciBwYXJzZSA9IHNjZS5wYXJzZUFzLAogICAgICAgIGdldFRydXN0ZWQgPSBzY2UuZ2V0VHJ1c3RlZCwKICAgICAgICB0cnVzdEFzID0gc2NlLnRydXN0QXM7CgogICAgZm9yRWFjaChTQ0VfQ09OVEVYVFMsIGZ1bmN0aW9uIChlbnVtVmFsdWUsIG5hbWUpIHsKICAgICAgdmFyIGxOYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgICBzY2VbY2FtZWxDYXNlKCJwYXJzZV9hc18iICsgbE5hbWUpXSA9IGZ1bmN0aW9uIChleHByKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlKGVudW1WYWx1ZSwgZXhwcik7CiAgICAgIH07CiAgICAgIHNjZVtjYW1lbENhc2UoImdldF90cnVzdGVkXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGdldFRydXN0ZWQoZW51bVZhbHVlLCB2YWx1ZSk7CiAgICAgIH07CiAgICAgIHNjZVtjYW1lbENhc2UoInRydXN0X2FzXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRydXN0QXMoZW51bVZhbHVlLCB2YWx1ZSk7CiAgICAgIH07CiAgICB9KTsKCiAgICByZXR1cm4gc2NlOwogIH1dOwp9CgovKioKICogISEhIFRoaXMgaXMgYW4gdW5kb2N1bWVudGVkICJwcml2YXRlIiBzZXJ2aWNlICEhIQogKgogKiBAbmFtZSAkc25pZmZlcgogKiBAcmVxdWlyZXMgJHdpbmRvdwogKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAqCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGlzdG9yeSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaHRtbDUgaGlzdG9yeSBhcGkgPwogKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc2hjaGFuZ2UgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGhhc2hjaGFuZ2UgZXZlbnQgPwogKiBAcHJvcGVydHkge2Jvb2xlYW59IHRyYW5zaXRpb25zIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBDU1MgdHJhbnNpdGlvbiBldmVudHMgPwogKiBAcHJvcGVydHkge2Jvb2xlYW59IGFuaW1hdGlvbnMgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IENTUyBhbmltYXRpb24gZXZlbnRzID8KICoKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgaXMgdmVyeSBzaW1wbGUgaW1wbGVtZW50YXRpb24gb2YgdGVzdGluZyBicm93c2VyJ3MgZmVhdHVyZXMuCiAqLwpmdW5jdGlvbiAkU25pZmZlclByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckZG9jdW1lbnQnLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQpIHsKICAgIHZhciBldmVudFN1cHBvcnQgPSB7fSwKICAgICAgICBhbmRyb2lkID0KICAgICAgICAgIGludCgoL2FuZHJvaWQgKFxkKykvLmV4ZWMobG93ZXJjYXNlKCgkd2luZG93Lm5hdmlnYXRvciB8fCB7fSkudXNlckFnZW50KSkgfHwgW10pWzFdKSwKICAgICAgICBib3hlZSA9IC9Cb3hlZS9pLnRlc3QoKCR3aW5kb3cubmF2aWdhdG9yIHx8IHt9KS51c2VyQWdlbnQpLAogICAgICAgIGRvY3VtZW50ID0gJGRvY3VtZW50WzBdIHx8IHt9LAogICAgICAgIGRvY3VtZW50TW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZSwKICAgICAgICB2ZW5kb3JQcmVmaXgsCiAgICAgICAgdmVuZG9yUmVnZXggPSAvXihNb3p8d2Via2l0fE98bXMpKD89W0EtWl0pLywKICAgICAgICBib2R5U3R5bGUgPSBkb2N1bWVudC5ib2R5ICYmIGRvY3VtZW50LmJvZHkuc3R5bGUsCiAgICAgICAgdHJhbnNpdGlvbnMgPSBmYWxzZSwKICAgICAgICBhbmltYXRpb25zID0gZmFsc2UsCiAgICAgICAgbWF0Y2g7CgogICAgaWYgKGJvZHlTdHlsZSkgewogICAgICBmb3IodmFyIHByb3AgaW4gYm9keVN0eWxlKSB7CiAgICAgICAgaWYobWF0Y2ggPSB2ZW5kb3JSZWdleC5leGVjKHByb3ApKSB7CiAgICAgICAgICB2ZW5kb3JQcmVmaXggPSBtYXRjaFswXTsKICAgICAgICAgIHZlbmRvclByZWZpeCA9IHZlbmRvclByZWZpeC5zdWJzdHIoMCwgMSkudG9VcHBlckNhc2UoKSArIHZlbmRvclByZWZpeC5zdWJzdHIoMSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmKCF2ZW5kb3JQcmVmaXgpIHsKICAgICAgICB2ZW5kb3JQcmVmaXggPSAoJ1dlYmtpdE9wYWNpdHknIGluIGJvZHlTdHlsZSkgJiYgJ3dlYmtpdCc7CiAgICAgIH0KCiAgICAgIHRyYW5zaXRpb25zID0gISEoKCd0cmFuc2l0aW9uJyBpbiBib2R5U3R5bGUpIHx8ICh2ZW5kb3JQcmVmaXggKyAnVHJhbnNpdGlvbicgaW4gYm9keVN0eWxlKSk7CiAgICAgIGFuaW1hdGlvbnMgID0gISEoKCdhbmltYXRpb24nIGluIGJvZHlTdHlsZSkgfHwgKHZlbmRvclByZWZpeCArICdBbmltYXRpb24nIGluIGJvZHlTdHlsZSkpOwoKICAgICAgaWYgKGFuZHJvaWQgJiYgKCF0cmFuc2l0aW9uc3x8IWFuaW1hdGlvbnMpKSB7CiAgICAgICAgdHJhbnNpdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdFRyYW5zaXRpb24pOwogICAgICAgIGFuaW1hdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdEFuaW1hdGlvbik7CiAgICAgIH0KICAgIH0KCgogICAgcmV0dXJuIHsKICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgIC8vIHNvIGxldCdzIG5vdCB1c2UgdGhlIGhpc3RvcnkgQVBJIGF0IGFsbC4KICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2FuZHJvaWQvaXNzdWVzL2RldGFpbD9pZD0xNzQ3MQogICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKCiAgICAgIC8vIG9sZGVyIHdlYmtpdCBicm93c2VyICg1MzMuOSkgb24gQm94ZWUgYm94IGhhcyBleGFjdGx5IHRoZSBzYW1lIHByb2JsZW0gYXMgQW5kcm9pZCBoYXMKICAgICAgLy8gc28gbGV0J3Mgbm90IHVzZSB0aGUgaGlzdG9yeSBBUEkgYWxzbwogICAgICAvLyBXZSBhcmUgcHVycG9zZWZ1bGx5IHVzaW5nIGAhKGFuZHJvaWQgPCA0KWAgdG8gY292ZXIgdGhlIGNhc2Ugd2hlbiBgYW5kcm9pZGAgaXMgdW5kZWZpbmVkCiAgICAgIC8vIGpzaGludCAtVzAxOAogICAgICBoaXN0b3J5OiAhISgkd2luZG93Lmhpc3RvcnkgJiYgJHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSAmJiAhKGFuZHJvaWQgPCA0KSAmJiAhYm94ZWUpLAogICAgICAvLyBqc2hpbnQgK1cwMTgKICAgICAgaGFzaGNoYW5nZTogJ29uaGFzaGNoYW5nZScgaW4gJHdpbmRvdyAmJgogICAgICAgICAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICAgICAgICAgKCFkb2N1bWVudE1vZGUgfHwgZG9jdW1lbnRNb2RlID4gNyksCiAgICAgIGhhc0V2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICAgIC8vIElFOSBpbXBsZW1lbnRzICdpbnB1dCcgZXZlbnQgaXQncyBzbyBmdWJhcmVkIHRoYXQgd2UgcmF0aGVyIHByZXRlbmQgdGhhdCBpdCBkb2Vzbid0IGhhdmUKICAgICAgICAvLyBpdC4gSW4gcGFydGljdWxhciB0aGUgZXZlbnQgaXMgbm90IGZpcmVkIHdoZW4gYmFja3NwYWNlIG9yIGRlbGV0ZSBrZXkgYXJlIHByZXNzZWQgb3IKICAgICAgICAvLyB3aGVuIGN1dCBvcGVyYXRpb24gaXMgcGVyZm9ybWVkLgogICAgICAgIGlmIChldmVudCA9PSAnaW5wdXQnICYmIG1zaWUgPT0gOSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnRTdXBwb3J0W2V2ZW50XSkpIHsKICAgICAgICAgIHZhciBkaXZFbG0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgIGV2ZW50U3VwcG9ydFtldmVudF0gPSAnb24nICsgZXZlbnQgaW4gZGl2RWxtOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGV2ZW50U3VwcG9ydFtldmVudF07CiAgICAgIH0sCiAgICAgIGNzcDogY3NwKCksCiAgICAgIHZlbmRvclByZWZpeDogdmVuZG9yUHJlZml4LAogICAgICB0cmFuc2l0aW9ucyA6IHRyYW5zaXRpb25zLAogICAgICBhbmltYXRpb25zIDogYW5pbWF0aW9ucywKICAgICAgYW5kcm9pZDogYW5kcm9pZCwKICAgICAgbXNpZSA6IG1zaWUsCiAgICAgIG1zaWVEb2N1bWVudE1vZGU6IGRvY3VtZW50TW9kZQogICAgfTsKICB9XTsKfQoKZnVuY3Rpb24gJFRpbWVvdXRQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHEnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgICAkYnJvd3NlciwgICAkcSwgICAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgdmFyIGRlZmVycmVkcyA9IHt9OwoKCiAgICAgLyoqCiAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgKiBAbmFtZSAkdGltZW91dAogICAgICAqCiAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICogQW5ndWxhcidzIHdyYXBwZXIgZm9yIGB3aW5kb3cuc2V0VGltZW91dGAuIFRoZSBgZm5gIGZ1bmN0aW9uIGlzIHdyYXBwZWQgaW50byBhIHRyeS9jYXRjaAogICAgICAqIGJsb2NrIGFuZCBkZWxlZ2F0ZXMgYW55IGV4Y2VwdGlvbnMgdG8KICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICoKICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGEgdGltZW91dCBmdW5jdGlvbiBpcyBhIHByb21pc2UsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgd2hlbgogICAgICAqIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgYW5kIHRoZSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICAqCiAgICAgICogVG8gY2FuY2VsIGEgdGltZW91dCByZXF1ZXN0LCBjYWxsIGAkdGltZW91dC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAqCiAgICAgICogSW4gdGVzdHMgeW91IGNhbiB1c2Uge0BsaW5rIG5nTW9jay4kdGltZW91dCBgJHRpbWVvdXQuZmx1c2goKWB9IHRvCiAgICAgICogc3luY2hyb25vdXNseSBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogICAgICAqCiAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBBIGZ1bmN0aW9uLCB3aG9zZSBleGVjdXRpb24gc2hvdWxkIGJlIGRlbGF5ZWQuCiAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbZGVsYXk9MF0gRGVsYXkgaW4gbWlsbGlzZWNvbmRzLgogICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICogQHJldHVybnMge1Byb21pc2V9IFByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gVGhlIHZhbHVlIHRoaXMKICAgICAgKiAgIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIGlzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBmbmAgZnVuY3Rpb24uCiAgICAgICoKICAgICAgKi8KICAgIGZ1bmN0aW9uIHRpbWVvdXQoZm4sIGRlbGF5LCBpbnZva2VBcHBseSkgewogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2UsCiAgICAgICAgICBza2lwQXBwbHkgPSAoaXNEZWZpbmVkKGludm9rZUFwcGx5KSAmJiAhaW52b2tlQXBwbHkpLAogICAgICAgICAgdGltZW91dElkOwoKICAgICAgdGltZW91dElkID0gJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZm4oKSk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7CiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9CiAgICAgICAgZmluYWxseSB7CiAgICAgICAgICBkZWxldGUgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFza2lwQXBwbHkpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgIH0sIGRlbGF5KTsKCiAgICAgIHByb21pc2UuJCR0aW1lb3V0SWQgPSB0aW1lb3V0SWQ7CiAgICAgIGRlZmVycmVkc1t0aW1lb3V0SWRdID0gZGVmZXJyZWQ7CgogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KCgogICAgIC8qKgogICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgKiBAbmFtZSAkdGltZW91dCNjYW5jZWwKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIENhbmNlbHMgYSB0YXNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgYHByb21pc2VgLiBBcyBhIHJlc3VsdCBvZiB0aGlzLCB0aGUgcHJvbWlzZSB3aWxsIGJlCiAgICAgICogcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbi4KICAgICAgKgogICAgICAqIEBwYXJhbSB7UHJvbWlzZT19IHByb21pc2UgUHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCR0aW1lb3V0YCBmdW5jdGlvbi4KICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgaGFzbid0IGV4ZWN1dGVkIHlldCBhbmQgd2FzIHN1Y2Nlc3NmdWxseQogICAgICAqICAgY2FuY2VsZWQuCiAgICAgICovCiAgICB0aW1lb3V0LmNhbmNlbCA9IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgaWYgKHByb21pc2UgJiYgcHJvbWlzZS4kJHRpbWVvdXRJZCBpbiBkZWZlcnJlZHMpIHsKICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgIGRlbGV0ZSBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF07CiAgICAgICAgcmV0dXJuICRicm93c2VyLmRlZmVyLmNhbmNlbChwcm9taXNlLiQkdGltZW91dElkKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIHJldHVybiB0aW1lb3V0OwogIH1dOwp9CgovLyBOT1RFOiAgVGhlIHVzYWdlIG9mIHdpbmRvdyBhbmQgZG9jdW1lbnQgaW5zdGVhZCBvZiAkd2luZG93IGFuZCAkZG9jdW1lbnQgaGVyZSBpcwovLyBkZWxpYmVyYXRlLiAgVGhpcyBzZXJ2aWNlIGRlcGVuZHMgb24gdGhlIHNwZWNpZmljIGJlaGF2aW9yIG9mIGFuY2hvciBub2RlcyBjcmVhdGVkIGJ5IHRoZQovLyBicm93c2VyIChyZXNvbHZpbmcgYW5kIHBhcnNpbmcgVVJMcykgdGhhdCBpcyB1bmxpa2VseSB0byBiZSBwcm92aWRlZCBieSBtb2NrIG9iamVjdHMgYW5kCi8vIGNhdXNlIHVzIHRvIGJyZWFrIHRlc3RzLiAgSW4gYWRkaXRpb24sIHdoZW4gdGhlIGJyb3dzZXIgcmVzb2x2ZXMgYSBVUkwgZm9yIFhIUiwgaXQKLy8gZG9lc24ndCBrbm93IGFib3V0IG1vY2tlZCBsb2NhdGlvbnMgYW5kIHJlc29sdmVzIFVSTHMgdG8gdGhlIHJlYWwgZG9jdW1lbnQgLSB3aGljaCBpcwovLyBleGFjdGx5IHRoZSBiZWhhdmlvciBuZWVkZWQgaGVyZS4gIFRoZXJlIGlzIGxpdHRsZSB2YWx1ZSBpcyBtb2NraW5nIHRoZXNlIG91dCBmb3IgdGhpcwovLyBzZXJ2aWNlLgp2YXIgdXJsUGFyc2luZ05vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CnZhciBvcmlnaW5VcmwgPSB1cmxSZXNvbHZlKHdpbmRvdy5sb2NhdGlvbi5ocmVmLCB0cnVlKTsKCgovKioKICoKICogSW1wbGVtZW50YXRpb24gTm90ZXMgZm9yIG5vbi1JRSBicm93c2VycwogKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAqIEFzc2lnbmluZyBhIFVSTCB0byB0aGUgaHJlZiBwcm9wZXJ0eSBvZiBhbiBhbmNob3IgRE9NIG5vZGUsIGV2ZW4gb25lIGF0dGFjaGVkIHRvIHRoZSBET00sCiAqIHJlc3VsdHMgYm90aCBpbiB0aGUgbm9ybWFsaXppbmcgYW5kIHBhcnNpbmcgb2YgdGhlIFVSTC4gIE5vcm1hbGl6aW5nIG1lYW5zIHRoYXQgYSByZWxhdGl2ZQogKiBVUkwgd2lsbCBiZSByZXNvbHZlZCBpbnRvIGFuIGFic29sdXRlIFVSTCBpbiB0aGUgY29udGV4dCBvZiB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQuCiAqIFBhcnNpbmcgbWVhbnMgdGhhdCB0aGUgYW5jaG9yIG5vZGUncyBob3N0LCBob3N0bmFtZSwgcHJvdG9jb2wsIHBvcnQsIHBhdGhuYW1lIGFuZCByZWxhdGVkCiAqIHByb3BlcnRpZXMgYXJlIGFsbCBwb3B1bGF0ZWQgdG8gcmVmbGVjdCB0aGUgbm9ybWFsaXplZCBVUkwuICBUaGlzIGFwcHJvYWNoIGhhcyB3aWRlCiAqIGNvbXBhdGliaWxpdHkgLSBTYWZhcmkgMSssIE1vemlsbGEgMSssIE9wZXJhIDcrLGUgZXRjLiAgU2VlCiAqIGh0dHA6Ly93d3cuYXB0YW5hLmNvbS9yZWZlcmVuY2UvaHRtbC9hcGkvSFRNTEFuY2hvckVsZW1lbnQuaHRtbAogKgogKiBJbXBsZW1lbnRhdGlvbiBOb3RlcyBmb3IgSUUKICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAqIElFID49IDggYW5kIDw9IDEwIG5vcm1hbGl6ZXMgdGhlIFVSTCB3aGVuIGFzc2lnbmVkIHRvIHRoZSBhbmNob3Igbm9kZSBzaW1pbGFyIHRvIHRoZSBvdGhlcgogKiBicm93c2Vycy4gIEhvd2V2ZXIsIHRoZSBwYXJzZWQgY29tcG9uZW50cyB3aWxsIG5vdCBiZSBzZXQgaWYgdGhlIFVSTCBhc3NpZ25lZCBkaWQgbm90IHNwZWNpZnkKICogdGhlbS4gIChlLmcuIGlmIHlvdSBhc3NpZ24gYS5ocmVmID0gImZvbyIsIHRoZW4gYS5wcm90b2NvbCwgYS5ob3N0LCBldGMuIHdpbGwgYmUgZW1wdHkuKSAgV2UKICogd29yayBhcm91bmQgdGhhdCBieSBwZXJmb3JtaW5nIHRoZSBwYXJzaW5nIGluIGEgMm5kIHN0ZXAgYnkgdGFraW5nIGEgcHJldmlvdXNseSBub3JtYWxpemVkCiAqIFVSTCAoZS5nLiBieSBhc3NpZ25pbmcgdG8gYS5ocmVmKSBhbmQgYXNzaWduaW5nIGl0IGEuaHJlZiBhZ2Fpbi4gIFRoaXMgY29ycmVjdGx5IHBvcHVsYXRlcyB0aGUKICogcHJvcGVydGllcyBzdWNoIGFzIHByb3RvY29sLCBob3N0bmFtZSwgcG9ydCwgZXRjLgogKgogKiBJRTcgZG9lcyBub3Qgbm9ybWFsaXplIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byBhbiBhbmNob3Igbm9kZS4gIChBcHBhcmVudGx5LCBpdCBkb2VzLCBpZiBvbmUKICogdXNlcyB0aGUgaW5uZXIgSFRNTCBhcHByb2FjaCB0byBhc3NpZ24gdGhlIFVSTCBhcyBwYXJ0IG9mIGFuIEhUTUwgc25pcHBldCAtCiAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzQ3MjcyOSkgIEhvd2V2ZXIsIHNldHRpbmcgaW1nW3NyY10gZG9lcyBub3JtYWxpemUgdGhlIFVSTC4KICogVW5mb3J0dW5hdGVseSwgc2V0dGluZyBpbWdbc3JjXSB0byBzb21ldGhpbmcgbGlrZSAiamF2YXNjcmlwdDpmb28iIG9uIElFIHRocm93cyBhbiBleGNlcHRpb24uCiAqIFNpbmNlIHRoZSBwcmltYXJ5IHVzYWdlIGZvciBub3JtYWxpemluZyBVUkxzIGlzIHRvIHNhbml0aXplIHN1Y2ggVVJMcywgd2UgY2FuJ3QgdXNlIHRoYXQKICogbWV0aG9kIGFuZCBJRSA8IDggaXMgdW5zdXBwb3J0ZWQuCiAqCiAqIFJlZmVyZW5jZXM6CiAqICAgaHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvSFRNTEFuY2hvckVsZW1lbnQKICogICBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICogICBodHRwOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jdXJsdXRpbHMKICogICBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3B1bGwvMjkwMgogKiAgIGh0dHA6Ly9qYW1lcy5wYWRvbHNleS5jb20vamF2YXNjcmlwdC9wYXJzaW5nLXVybHMtd2l0aC10aGUtZG9tLwogKgogKiBAa2luZCBmdW5jdGlvbgogKiBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBVUkwgdG8gYmUgcGFyc2VkLgogKiBAZGVzY3JpcHRpb24gTm9ybWFsaXplcyBhbmQgcGFyc2VzIGEgVVJMLgogKiBAcmV0dXJucyB7b2JqZWN0fSBSZXR1cm5zIHRoZSBub3JtYWxpemVkIFVSTCBhcyBhIGRpY3Rpb25hcnkuCiAqCiAqICAgfCBtZW1iZXIgbmFtZSAgIHwgRGVzY3JpcHRpb24gICAgfAogKiAgIHwtLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLXwKICogICB8IGhyZWYgICAgICAgICAgfCBBIG5vcm1hbGl6ZWQgdmVyc2lvbiBvZiB0aGUgcHJvdmlkZWQgVVJMIGlmIGl0IHdhcyBub3QgYW4gYWJzb2x1dGUgVVJMIHwKICogICB8IHByb3RvY29sICAgICAgfCBUaGUgcHJvdG9jb2wgaW5jbHVkaW5nIHRoZSB0cmFpbGluZyBjb2xvbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogICB8IGhvc3QgICAgICAgICAgfCBUaGUgaG9zdCBhbmQgcG9ydCAoaWYgdGhlIHBvcnQgaXMgbm9uLWRlZmF1bHQpIG9mIHRoZSBub3JtYWxpemVkVXJsICAgIHwKICogICB8IHNlYXJjaCAgICAgICAgfCBUaGUgc2VhcmNoIHBhcmFtcywgbWludXMgdGhlIHF1ZXN0aW9uIG1hcmsgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogICB8IGhhc2ggICAgICAgICAgfCBUaGUgaGFzaCBzdHJpbmcsIG1pbnVzIHRoZSBoYXNoIHN5bWJvbAogKiAgIHwgaG9zdG5hbWUgICAgICB8IFRoZSBob3N0bmFtZQogKiAgIHwgcG9ydCAgICAgICAgICB8IFRoZSBwb3J0LCB3aXRob3V0ICI6IgogKiAgIHwgcGF0aG5hbWUgICAgICB8IFRoZSBwYXRobmFtZSwgYmVnaW5uaW5nIHdpdGggIi8iCiAqCiAqLwpmdW5jdGlvbiB1cmxSZXNvbHZlKHVybCwgYmFzZSkgewogIHZhciBocmVmID0gdXJsOwoKICBpZiAobXNpZSkgewogICAgLy8gTm9ybWFsaXplIGJlZm9yZSBwYXJzZS4gIFJlZmVyIEltcGxlbWVudGF0aW9uIE5vdGVzIG9uIHdoeSB0aGlzIGlzCiAgICAvLyBkb25lIGluIHR3byBzdGVwcyBvbiBJRS4KICAgIHVybFBhcnNpbmdOb2RlLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGhyZWYpOwogICAgaHJlZiA9IHVybFBhcnNpbmdOb2RlLmhyZWY7CiAgfQoKICB1cmxQYXJzaW5nTm9kZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBocmVmKTsKCiAgLy8gdXJsUGFyc2luZ05vZGUgcHJvdmlkZXMgdGhlIFVybFV0aWxzIGludGVyZmFjZSAtIGh0dHA6Ly91cmwuc3BlYy53aGF0d2cub3JnLyN1cmx1dGlscwogIHJldHVybiB7CiAgICBocmVmOiB1cmxQYXJzaW5nTm9kZS5ocmVmLAogICAgcHJvdG9jb2w6IHVybFBhcnNpbmdOb2RlLnByb3RvY29sID8gdXJsUGFyc2luZ05vZGUucHJvdG9jb2wucmVwbGFjZSgvOiQvLCAnJykgOiAnJywKICAgIGhvc3Q6IHVybFBhcnNpbmdOb2RlLmhvc3QsCiAgICBzZWFyY2g6IHVybFBhcnNpbmdOb2RlLnNlYXJjaCA/IHVybFBhcnNpbmdOb2RlLnNlYXJjaC5yZXBsYWNlKC9eXD8vLCAnJykgOiAnJywKICAgIGhhc2g6IHVybFBhcnNpbmdOb2RlLmhhc2ggPyB1cmxQYXJzaW5nTm9kZS5oYXNoLnJlcGxhY2UoL14jLywgJycpIDogJycsCiAgICBob3N0bmFtZTogdXJsUGFyc2luZ05vZGUuaG9zdG5hbWUsCiAgICBwb3J0OiB1cmxQYXJzaW5nTm9kZS5wb3J0LAogICAgcGF0aG5hbWU6ICh1cmxQYXJzaW5nTm9kZS5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJykKICAgICAgPyB1cmxQYXJzaW5nTm9kZS5wYXRobmFtZQogICAgICA6ICcvJyArIHVybFBhcnNpbmdOb2RlLnBhdGhuYW1lCiAgfTsKfQoKLyoqCiAqIFBhcnNlIGEgcmVxdWVzdCBVUkwgYW5kIGRldGVybWluZSB3aGV0aGVyIHRoaXMgaXMgYSBzYW1lLW9yaWdpbiByZXF1ZXN0IGFzIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudC4KICoKICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSByZXF1ZXN0VXJsIFRoZSB1cmwgb2YgdGhlIHJlcXVlc3QgYXMgYSBzdHJpbmcgdGhhdCB3aWxsIGJlIHJlc29sdmVkCiAqIG9yIGEgcGFyc2VkIFVSTCBvYmplY3QuCiAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByZXF1ZXN0IGlzIGZvciB0aGUgc2FtZSBvcmlnaW4gYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogKi8KZnVuY3Rpb24gdXJsSXNTYW1lT3JpZ2luKHJlcXVlc3RVcmwpIHsKICB2YXIgcGFyc2VkID0gKGlzU3RyaW5nKHJlcXVlc3RVcmwpKSA/IHVybFJlc29sdmUocmVxdWVzdFVybCkgOiByZXF1ZXN0VXJsOwogIHJldHVybiAocGFyc2VkLnByb3RvY29sID09PSBvcmlnaW5VcmwucHJvdG9jb2wgJiYKICAgICAgICAgIHBhcnNlZC5ob3N0ID09PSBvcmlnaW5VcmwuaG9zdCk7Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkd2luZG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHJlZmVyZW5jZSB0byB0aGUgYnJvd3NlcidzIGB3aW5kb3dgIG9iamVjdC4gV2hpbGUgYHdpbmRvd2AKICogaXMgZ2xvYmFsbHkgYXZhaWxhYmxlIGluIEphdmFTY3JpcHQsIGl0IGNhdXNlcyB0ZXN0YWJpbGl0eSBwcm9ibGVtcywgYmVjYXVzZQogKiBpdCBpcyBhIGdsb2JhbCB2YXJpYWJsZS4gSW4gYW5ndWxhciB3ZSBhbHdheXMgcmVmZXIgdG8gaXQgdGhyb3VnaCB0aGUKICogYCR3aW5kb3dgIHNlcnZpY2UsIHNvIGl0IG1heSBiZSBvdmVycmlkZGVuLCByZW1vdmVkIG9yIG1vY2tlZCBmb3IgdGVzdGluZy4KICoKICogRXhwcmVzc2lvbnMsIGxpa2UgdGhlIG9uZSBkZWZpbmVkIGZvciB0aGUgYG5nQ2xpY2tgIGRpcmVjdGl2ZSBpbiB0aGUgZXhhbXBsZQogKiBiZWxvdywgYXJlIGV2YWx1YXRlZCB3aXRoIHJlc3BlY3QgdG8gdGhlIGN1cnJlbnQgc2NvcGUuICBUaGVyZWZvcmUsIHRoZXJlIGlzCiAqIG5vIHJpc2sgb2YgaW5hZHZlcnRlbnRseSBjb2RpbmcgaW4gYSBkZXBlbmRlbmN5IG9uIGEgZ2xvYmFsIHZhbHVlIGluIHN1Y2ggYW4KICogZXhwcmVzc2lvbi4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSwgJHdpbmRvdykgewogICAgICAgICAgICRzY29wZS5ncmVldGluZyA9ICdIZWxsbywgV29ybGQhJzsKICAgICAgICAgICAkc2NvcGUuZG9HcmVldGluZyA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICAgICAgICAgICAgICR3aW5kb3cuYWxlcnQoZ3JlZXRpbmcpOwogICAgICAgICAgIH07CiAgICAgICAgIH0KICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJncmVldGluZyIgLz4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iZG9HcmVldGluZyhncmVldGluZykiPkFMRVJUPC9idXR0b24+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIGl0KCdzaG91bGQgZGlzcGxheSB0aGUgZ3JlZXRpbmcgaW4gdGhlIGlucHV0IGJveCcsIGZ1bmN0aW9uKCkgewogICAgICAgZWxlbWVudChieS5tb2RlbCgnZ3JlZXRpbmcnKSkuc2VuZEtleXMoJ0hlbGxvLCBFMkUgVGVzdHMnKTsKICAgICAgIC8vIElmIHdlIGNsaWNrIHRoZSBidXR0b24gaXQgd2lsbCBibG9jayB0aGUgdGVzdCBydW5uZXIKICAgICAgIC8vIGVsZW1lbnQoJzpidXR0b24nKS5jbGljaygpOwogICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uICRXaW5kb3dQcm92aWRlcigpewogIHRoaXMuJGdldCA9IHZhbHVlRm4od2luZG93KTsKfQoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkZmlsdGVyUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqCiAqIEZpbHRlcnMgYXJlIGp1c3QgZnVuY3Rpb25zIHdoaWNoIHRyYW5zZm9ybSBpbnB1dCB0byBhbiBvdXRwdXQuIEhvd2V2ZXIgZmlsdGVycyBuZWVkIHRvIGJlCiAqIERlcGVuZGVuY3kgSW5qZWN0ZWQuIFRvIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcwogKiBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzIHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyBhIGZpbHRlciBmdW5jdGlvbi4KICoKICogYGBganMKICogICAvLyBGaWx0ZXIgcmVnaXN0cmF0aW9uCiAqICAgZnVuY3Rpb24gTXlNb2R1bGUoJHByb3ZpZGUsICRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgLy8gY3JlYXRlIGEgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBpbmplY3Rpb24gKG5vdCBhbHdheXMgbmVlZGVkKQogKiAgICAgJHByb3ZpZGUudmFsdWUoJ2dyZWV0JywgZnVuY3Rpb24obmFtZSl7CiAqICAgICAgIHJldHVybiAnSGVsbG8gJyArIG5hbWUgKyAnISc7CiAqICAgICB9KTsKICoKICogICAgIC8vIHJlZ2lzdGVyIGEgZmlsdGVyIGZhY3Rvcnkgd2hpY2ggdXNlcyB0aGUKICogICAgIC8vIGdyZWV0IHNlcnZpY2UgdG8gZGVtb25zdHJhdGUgREkuCiAqICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ2dyZWV0JywgZnVuY3Rpb24oZ3JlZXQpewogKiAgICAgICAvLyByZXR1cm4gdGhlIGZpbHRlciBmdW5jdGlvbiB3aGljaCB1c2VzIHRoZSBncmVldCBzZXJ2aWNlCiAqICAgICAgIC8vIHRvIGdlbmVyYXRlIHNhbHV0YXRpb24KICogICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRleHQpIHsKICogICAgICAgICAvLyBmaWx0ZXJzIG5lZWQgdG8gYmUgZm9yZ2l2aW5nIHNvIGNoZWNrIGlucHV0IHZhbGlkaXR5CiAqICAgICAgICAgcmV0dXJuIHRleHQgJiYgZ3JlZXQodGV4dCkgfHwgdGV4dDsKICogICAgICAgfTsKICogICAgIH0pOwogKiAgIH0KICogYGBgCiAqCiAqIFRoZSBmaWx0ZXIgZnVuY3Rpb24gaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBgJGluamVjdG9yYCB1bmRlciB0aGUgZmlsdGVyIG5hbWUgc3VmZml4IHdpdGgKICogYEZpbHRlcmAuCiAqCiAqIGBgYGpzCiAqICAgaXQoJ3Nob3VsZCBiZSB0aGUgc2FtZSBpbnN0YW5jZScsIGluamVjdCgKICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ3JldmVyc2UnLCBmdW5jdGlvbigpewogKiAgICAgICAgIHJldHVybiAuLi47CiAqICAgICAgIH0pOwogKiAgICAgfSwKICogICAgIGZ1bmN0aW9uKCRmaWx0ZXIsIHJldmVyc2VGaWx0ZXIpIHsKICogICAgICAgZXhwZWN0KCRmaWx0ZXIoJ3JldmVyc2UnKSkudG9CZShyZXZlcnNlRmlsdGVyKTsKICogICAgIH0pOwogKiBgYGAKICoKICoKICogRm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgaG93IGFuZ3VsYXIgZmlsdGVycyB3b3JrLCBhbmQgaG93IHRvIGNyZWF0ZSB5b3VyIG93biBmaWx0ZXJzLCBzZWUKICoge0BsaW5rIGd1aWRlL2ZpbHRlciBGaWx0ZXJzfSBpbiB0aGUgQW5ndWxhciBEZXZlbG9wZXIgR3VpZGUuCiAqLwovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIKICogQGRlc2NyaXB0aW9uCiAqIFJlZ2lzdGVyIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uLgogKgogKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmaWx0ZXIgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBpbmplY3RhYmxlLgogKi8KCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGZpbHRlcgogKiBAa2luZCBmdW5jdGlvbgogKiBAZGVzY3JpcHRpb24KICogRmlsdGVycyBhcmUgdXNlZCBmb3IgZm9ybWF0dGluZyBkYXRhIGRpc3BsYXllZCB0byB0aGUgdXNlci4KICoKICogVGhlIGdlbmVyYWwgc3ludGF4IGluIHRlbXBsYXRlcyBpcyBhcyBmb2xsb3dzOgogKgogKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICoKICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHRvIHJldHJpZXZlCiAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG5hbWU9IiRmaWx0ZXIiIG1vZHVsZT0iZmlsdGVyRXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ik1haW5DdHJsIj4KICAgICAgICA8aDM+e3sgb3JpZ2luYWxUZXh0IH19PC9oMz4KICAgICAgICA8aDM+e3sgZmlsdGVyZWRUZXh0IH19PC9oMz4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgYW5ndWxhci5tb2R1bGUoJ2ZpbHRlckV4YW1wbGUnLCBbXSkKICAgICAgLmNvbnRyb2xsZXIoJ01haW5DdHJsJywgZnVuY3Rpb24oJHNjb3BlLCAkZmlsdGVyKSB7CiAgICAgICAgJHNjb3BlLm9yaWdpbmFsVGV4dCA9ICdoZWxsbyc7CiAgICAgICAgJHNjb3BlLmZpbHRlcmVkVGV4dCA9ICRmaWx0ZXIoJ3VwcGVyY2FzZScpKCRzY29wZS5vcmlnaW5hbFRleHQpOwogICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAqLwokRmlsdGVyUHJvdmlkZXIuJGluamVjdCA9IFsnJHByb3ZpZGUnXTsKZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlcgogICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24sIG9yIGFuIG9iamVjdCBtYXAgb2YgZmlsdGVycyB3aGVyZQogICAqICAgIHRoZSBrZXlzIGFyZSB0aGUgZmlsdGVyIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgZmlsdGVyIGZhY3Rvcmllcy4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZWdpc3RlcmVkIGZpbHRlciBpbnN0YW5jZSwgb3IgaWYgYSBtYXAgb2YgZmlsdGVycyB3YXMgcHJvdmlkZWQgdGhlbiBhIG1hcAogICAqICAgIG9mIHRoZSByZWdpc3RlcmVkIGZpbHRlciBpbnN0YW5jZXMuCiAgICovCiAgZnVuY3Rpb24gcmVnaXN0ZXIobmFtZSwgZmFjdG9yeSkgewogICAgaWYoaXNPYmplY3QobmFtZSkpIHsKICAgICAgdmFyIGZpbHRlcnMgPSB7fTsKICAgICAgZm9yRWFjaChuYW1lLCBmdW5jdGlvbihmaWx0ZXIsIGtleSkgewogICAgICAgIGZpbHRlcnNba2V5XSA9IHJlZ2lzdGVyKGtleSwgZmlsdGVyKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBmaWx0ZXJzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICRwcm92aWRlLmZhY3RvcnkobmFtZSArIHN1ZmZpeCwgZmFjdG9yeSk7CiAgICB9CiAgfQogIHRoaXMucmVnaXN0ZXIgPSByZWdpc3RlcjsKCiAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCBmdW5jdGlvbigkaW5qZWN0b3IpIHsKICAgIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHJldHVybiAkaW5qZWN0b3IuZ2V0KG5hbWUgKyBzdWZmaXgpOwogICAgfTsKICB9XTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAvKiBnbG9iYWwKICAgIGN1cnJlbmN5RmlsdGVyOiBmYWxzZSwKICAgIGRhdGVGaWx0ZXI6IGZhbHNlLAogICAgZmlsdGVyRmlsdGVyOiBmYWxzZSwKICAgIGpzb25GaWx0ZXI6IGZhbHNlLAogICAgbGltaXRUb0ZpbHRlcjogZmFsc2UsCiAgICBsb3dlcmNhc2VGaWx0ZXI6IGZhbHNlLAogICAgbnVtYmVyRmlsdGVyOiBmYWxzZSwKICAgIG9yZGVyQnlGaWx0ZXI6IGZhbHNlLAogICAgdXBwZXJjYXNlRmlsdGVyOiBmYWxzZSwKICAqLwoKICByZWdpc3RlcignY3VycmVuY3knLCBjdXJyZW5jeUZpbHRlcik7CiAgcmVnaXN0ZXIoJ2RhdGUnLCBkYXRlRmlsdGVyKTsKICByZWdpc3RlcignZmlsdGVyJywgZmlsdGVyRmlsdGVyKTsKICByZWdpc3RlcignanNvbicsIGpzb25GaWx0ZXIpOwogIHJlZ2lzdGVyKCdsaW1pdFRvJywgbGltaXRUb0ZpbHRlcik7CiAgcmVnaXN0ZXIoJ2xvd2VyY2FzZScsIGxvd2VyY2FzZUZpbHRlcik7CiAgcmVnaXN0ZXIoJ251bWJlcicsIG51bWJlckZpbHRlcik7CiAgcmVnaXN0ZXIoJ29yZGVyQnknLCBvcmRlckJ5RmlsdGVyKTsKICByZWdpc3RlcigndXBwZXJjYXNlJywgdXBwZXJjYXNlRmlsdGVyKTsKfQoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgZmlsdGVyCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICoKICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIHNvdXJjZSBhcnJheS4KICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fGZ1bmN0aW9uKCl9IGV4cHJlc3Npb24gVGhlIHByZWRpY2F0ZSB0byBiZSB1c2VkIGZvciBzZWxlY3RpbmcgaXRlbXMgZnJvbQogKiAgIGBhcnJheWAuCiAqCiAqICAgQ2FuIGJlIG9uZSBvZjoKICoKICogICAtIGBzdHJpbmdgOiBUaGUgc3RyaW5nIGlzIGV2YWx1YXRlZCBhcyBhbiBleHByZXNzaW9uIGFuZCB0aGUgcmVzdWx0aW5nIHZhbHVlIGlzIHVzZWQgZm9yIHN1YnN0cmluZyBtYXRjaCBhZ2FpbnN0CiAqICAgICB0aGUgY29udGVudHMgb2YgdGhlIGBhcnJheWAuIEFsbCBzdHJpbmdzIG9yIG9iamVjdHMgd2l0aCBzdHJpbmcgcHJvcGVydGllcyBpbiBgYXJyYXlgIHRoYXQgY29udGFpbiB0aGlzIHN0cmluZwogKiAgICAgd2lsbCBiZSByZXR1cm5lZC4gVGhlIHByZWRpY2F0ZSBjYW4gYmUgbmVnYXRlZCBieSBwcmVmaXhpbmcgdGhlIHN0cmluZyB3aXRoIGAhYC4KICoKICogICAtIGBPYmplY3RgOiBBIHBhdHRlcm4gb2JqZWN0IGNhbiBiZSB1c2VkIHRvIGZpbHRlciBzcGVjaWZpYyBwcm9wZXJ0aWVzIG9uIG9iamVjdHMgY29udGFpbmVkCiAqICAgICBieSBgYXJyYXlgLiBGb3IgZXhhbXBsZSBge25hbWU6Ik0iLCBwaG9uZToiMSJ9YCBwcmVkaWNhdGUgd2lsbCByZXR1cm4gYW4gYXJyYXkgb2YgaXRlbXMKICogICAgIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgIGNvbnRhaW5pbmcgIk0iIGFuZCBwcm9wZXJ0eSBgcGhvbmVgIGNvbnRhaW5pbmcgIjEiLiBBIHNwZWNpYWwKICogICAgIHByb3BlcnR5IG5hbWUgYCRgIGNhbiBiZSB1c2VkIChhcyBpbiBgeyQ6InRleHQifWApIHRvIGFjY2VwdCBhIG1hdGNoIGFnYWluc3QgYW55CiAqICAgICBwcm9wZXJ0eSBvZiB0aGUgb2JqZWN0LiBUaGF0J3MgZXF1aXZhbGVudCB0byB0aGUgc2ltcGxlIHN1YnN0cmluZyBtYXRjaCB3aXRoIGEgYHN0cmluZ2AKICogICAgIGFzIGRlc2NyaWJlZCBhYm92ZS4KICoKICogICAtIGBmdW5jdGlvbih2YWx1ZSlgOiBBIHByZWRpY2F0ZSBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byB3cml0ZSBhcmJpdHJhcnkgZmlsdGVycy4gVGhlIGZ1bmN0aW9uIGlzCiAqICAgICBjYWxsZWQgZm9yIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgLiBUaGUgZmluYWwgcmVzdWx0IGlzIGFuIGFycmF5IG9mIHRob3NlIGVsZW1lbnRzIHRoYXQKICogICAgIHRoZSBwcmVkaWNhdGUgcmV0dXJuZWQgdHJ1ZSBmb3IuCiAqCiAqIEBwYXJhbSB7ZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCl8dHJ1ZXx1bmRlZmluZWR9IGNvbXBhcmF0b3IgQ29tcGFyYXRvciB3aGljaCBpcyB1c2VkIGluCiAqICAgICBkZXRlcm1pbmluZyBpZiB0aGUgZXhwZWN0ZWQgdmFsdWUgKGZyb20gdGhlIGZpbHRlciBleHByZXNzaW9uKSBhbmQgYWN0dWFsIHZhbHVlIChmcm9tCiAqICAgICB0aGUgb2JqZWN0IGluIHRoZSBhcnJheSkgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYSBtYXRjaC4KICoKICogICBDYW4gYmUgb25lIG9mOgogKgogKiAgIC0gYGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQpYDoKICogICAgIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGdpdmVuIHRoZSBvYmplY3QgdmFsdWUgYW5kIHRoZSBwcmVkaWNhdGUgdmFsdWUgdG8gY29tcGFyZSBhbmQKICogICAgIHNob3VsZCByZXR1cm4gdHJ1ZSBpZiB0aGUgaXRlbSBzaG91bGQgYmUgaW5jbHVkZWQgaW4gZmlsdGVyZWQgcmVzdWx0LgogKgogKiAgIC0gYHRydWVgOiBBIHNob3J0aGFuZCBmb3IgYGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQpIHsgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKGV4cGVjdGVkLCBhY3R1YWwpfWAuCiAqICAgICB0aGlzIGlzIGVzc2VudGlhbGx5IHN0cmljdCBjb21wYXJpc29uIG9mIGV4cGVjdGVkIGFuZCBhY3R1YWwuCiAqCiAqICAgLSBgZmFsc2V8dW5kZWZpbmVkYDogQSBzaG9ydCBoYW5kIGZvciBhIGZ1bmN0aW9uIHdoaWNoIHdpbGwgbG9vayBmb3IgYSBzdWJzdHJpbmcgbWF0Y2ggaW4gY2FzZQogKiAgICAgaW5zZW5zaXRpdmUgd2F5LgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTI3Nid9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzgwMC1CSUctTUFSWSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJ30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWV0dGUnLCBwaG9uZTonNTU1LTU2NzgnfV0iPjwvZGl2PgoKICAgICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICAgIDx0YWJsZSBpZD0ic2VhcmNoVGV4dFJlc3VsdHMiPgogICAgICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoVGV4dCI+CiAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgICAgICA8L3RyPgogICAgICAgPC90YWJsZT4KICAgICAgIDxocj4KICAgICAgIEFueTogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2guJCI+IDxicj4KICAgICAgIE5hbWUgb25seSA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC5uYW1lIj48YnI+CiAgICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLnBob25lIj48YnI+CiAgICAgICBFcXVhbGl0eSA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJzdHJpY3QiPjxicj4KICAgICAgIDx0YWJsZSBpZD0ic2VhcmNoT2JqUmVzdWx0cyI+CiAgICAgICAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48L3RyPgogICAgICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmRPYmogaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2g6c3RyaWN0Ij4KICAgICAgICAgICA8dGQ+e3tmcmllbmRPYmoubmFtZX19PC90ZD4KICAgICAgICAgICA8dGQ+e3tmcmllbmRPYmoucGhvbmV9fTwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICA8L3RhYmxlPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIHZhciBleHBlY3RGcmllbmROYW1lcyA9IGZ1bmN0aW9uKGV4cGVjdGVkTmFtZXMsIGtleSkgewogICAgICAgICBlbGVtZW50LmFsbChieS5yZXBlYXRlcihrZXkgKyAnIGluIGZyaWVuZHMnKS5jb2x1bW4oa2V5ICsgJy5uYW1lJykpLnRoZW4oZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICAgYXJyLmZvckVhY2goZnVuY3Rpb24od2QsIGkpIHsKICAgICAgICAgICAgIGV4cGVjdCh3ZC5nZXRUZXh0KCkpLnRvTWF0Y2goZXhwZWN0ZWROYW1lc1tpXSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIH0pOwogICAgICAgfTsKCiAgICAgICBpdCgnc2hvdWxkIHNlYXJjaCBhY3Jvc3MgYWxsIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgc3RyaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzZWFyY2hUZXh0ID0gZWxlbWVudChieS5tb2RlbCgnc2VhcmNoVGV4dCcpKTsKICAgICAgICAgc2VhcmNoVGV4dC5jbGVhcigpOwogICAgICAgICBzZWFyY2hUZXh0LnNlbmRLZXlzKCdtJyk7CiAgICAgICAgIGV4cGVjdEZyaWVuZE5hbWVzKFsnTWFyeScsICdNaWtlJywgJ0FkYW0nXSwgJ2ZyaWVuZCcpOwoKICAgICAgICAgc2VhcmNoVGV4dC5jbGVhcigpOwogICAgICAgICBzZWFyY2hUZXh0LnNlbmRLZXlzKCc3NicpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ0pvaG4nLCAnSnVsaWUnXSwgJ2ZyaWVuZCcpOwogICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggaW4gc3BlY2lmaWMgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBwcmVkaWNhdGUgb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzZWFyY2hBbnkgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzZWFyY2guJCcpKTsKICAgICAgICAgc2VhcmNoQW55LmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaEFueS5zZW5kS2V5cygnaScpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ01hcnknLCAnTWlrZScsICdKdWxpZScsICdKdWxpZXR0ZSddLCAnZnJpZW5kT2JqJyk7CiAgICAgICB9KTsKICAgICAgIGl0KCdzaG91bGQgdXNlIGEgZXF1YWwgY29tcGFyaXNvbiB3aGVuIGNvbXBhcmF0b3IgaXMgdHJ1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgc2VhcmNoTmFtZSA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlYXJjaC5uYW1lJykpOwogICAgICAgICB2YXIgc3RyaWN0ID0gZWxlbWVudChieS5tb2RlbCgnc3RyaWN0JykpOwogICAgICAgICBzZWFyY2hOYW1lLmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaE5hbWUuc2VuZEtleXMoJ0p1bGllJyk7CiAgICAgICAgIHN0cmljdC5jbGljaygpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ0p1bGllJ10sICdmcmllbmRPYmonKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gZmlsdGVyRmlsdGVyKCkgewogIHJldHVybiBmdW5jdGlvbihhcnJheSwgZXhwcmVzc2lvbiwgY29tcGFyYXRvcikgewogICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwoKICAgIHZhciBjb21wYXJhdG9yVHlwZSA9IHR5cGVvZihjb21wYXJhdG9yKSwKICAgICAgICBwcmVkaWNhdGVzID0gW107CgogICAgcHJlZGljYXRlcy5jaGVjayA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcHJlZGljYXRlcy5sZW5ndGg7IGorKykgewogICAgICAgIGlmKCFwcmVkaWNhdGVzW2pdKHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CgogICAgaWYgKGNvbXBhcmF0b3JUeXBlICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIGlmIChjb21wYXJhdG9yVHlwZSA9PT0gJ2Jvb2xlYW4nICYmIGNvbXBhcmF0b3IpIHsKICAgICAgICBjb21wYXJhdG9yID0gZnVuY3Rpb24ob2JqLCB0ZXh0KSB7CiAgICAgICAgICByZXR1cm4gYW5ndWxhci5lcXVhbHMob2JqLCB0ZXh0KTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbXBhcmF0b3IgPSBmdW5jdGlvbihvYmosIHRleHQpIHsKICAgICAgICAgIGlmIChvYmogJiYgdGV4dCAmJiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgdGV4dCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgZm9yICh2YXIgb2JqS2V5IGluIG9iaikgewogICAgICAgICAgICAgIGlmIChvYmpLZXkuY2hhckF0KDApICE9PSAnJCcgJiYgaGFzT3duUHJvcGVydHkuY2FsbChvYmosIG9iaktleSkgJiYKICAgICAgICAgICAgICAgICAgY29tcGFyYXRvcihvYmpbb2JqS2V5XSwgdGV4dFtvYmpLZXldKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHRleHQgPSAoJycrdGV4dCkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiAoJycrb2JqKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGV4dCkgPiAtMTsKICAgICAgICB9OwogICAgICB9CiAgICB9CgogICAgdmFyIHNlYXJjaCA9IGZ1bmN0aW9uKG9iaiwgdGV4dCl7CiAgICAgIGlmICh0eXBlb2YgdGV4dCA9PSAnc3RyaW5nJyAmJiB0ZXh0LmNoYXJBdCgwKSA9PT0gJyEnKSB7CiAgICAgICAgcmV0dXJuICFzZWFyY2gob2JqLCB0ZXh0LnN1YnN0cigxKSk7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7CiAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgcmV0dXJuIGNvbXBhcmF0b3Iob2JqLCB0ZXh0KTsKICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdGV4dCkgewogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgIHJldHVybiBjb21wYXJhdG9yKG9iaiwgdGV4dCk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgZm9yICggdmFyIG9iaktleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGlmIChvYmpLZXkuY2hhckF0KDApICE9PSAnJCcgJiYgc2VhcmNoKG9ialtvYmpLZXldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgY2FzZSAiYXJyYXkiOgogICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChzZWFyY2gob2JqW2ldLCB0ZXh0KSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfTsKICAgIHN3aXRjaCAodHlwZW9mIGV4cHJlc3Npb24pIHsKICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgLy8gU2V0IHVwIGV4cHJlc3Npb24gb2JqZWN0IGFuZCBmYWxsIHRocm91Z2gKICAgICAgICBleHByZXNzaW9uID0geyQ6ZXhwcmVzc2lvbn07CiAgICAgICAgLy8ganNoaW50IC1XMDg2CiAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgLy8ganNoaW50ICtXMDg2CiAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgIChmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZXhwcmVzc2lvbltwYXRoXSA9PSAndW5kZWZpbmVkJykgcmV0dXJuOwogICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gc2VhcmNoKHBhdGggPT0gJyQnID8gdmFsdWUgOiAodmFsdWUgJiYgdmFsdWVbcGF0aF0pLCBleHByZXNzaW9uW3BhdGhdKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KShrZXkpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAnZnVuY3Rpb24nOgogICAgICAgIHByZWRpY2F0ZXMucHVzaChleHByZXNzaW9uKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICB9CiAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgIGZvciAoIHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICBpZiAocHJlZGljYXRlcy5jaGVjayh2YWx1ZSkpIHsKICAgICAgICBmaWx0ZXJlZC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpbHRlcmVkOwogIH07Cn0KCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGN1cnJlbmN5CiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAqIHN5bWJvbCBmb3IgY3VycmVudCBsb2NhbGUgaXMgdXNlZC4KICoKICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAqIEBwYXJhbSB7c3RyaW5nPX0gc3ltYm9sIEN1cnJlbmN5IHN5bWJvbCBvciBpZGVudGlmaWVyIHRvIGJlIGRpc3BsYXllZC4KICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIG51bWJlci4KICoKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5hbW91bnQgPSAxMjM0LjU2OwogICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIG5nLW1vZGVsPSJhbW91bnQiPiA8YnI+CiAgICAgICAgIGRlZmF1bHQgY3VycmVuY3kgc3ltYm9sICgkKTogPHNwYW4gaWQ9ImN1cnJlbmN5LWRlZmF1bHQiPnt7YW1vdW50IHwgY3VycmVuY3l9fTwvc3Bhbj48YnI+CiAgICAgICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKTogPHNwYW4+e3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fTwvc3Bhbj4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgaW5pdCB3aXRoIDEyMzQuNTYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2N1cnJlbmN5LWRlZmF1bHQnKSkuZ2V0VGV4dCgpKS50b0JlKCckMSwyMzQuNTYnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLmdldFRleHQoKSkudG9CZSgnVVNEJDEsMjM0LjU2Jyk7CiAgICAgICB9KTsKICAgICAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlmIChicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdzYWZhcmknKSB7CiAgICAgICAgICAgLy8gU2FmYXJpIGRvZXMgbm90IHVuZGVyc3RhbmQgdGhlIG1pbnVzIGtleS4gU2VlCiAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvcHJvdHJhY3Rvci9pc3N1ZXMvNDgxCiAgICAgICAgICAgcmV0dXJuOwogICAgICAgICB9CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2Ftb3VudCcpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdhbW91bnQnKSkuc2VuZEtleXMoJy0xMjM0Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjdXJyZW5jeS1kZWZhdWx0JykpLmdldFRleHQoKSkudG9CZSgnKCQxLDIzNC4wMCknKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLmdldFRleHQoKSkudG9CZSgnKFVTRCQxLDIzNC4wMCknKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KY3VycmVuY3lGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwpmdW5jdGlvbiBjdXJyZW5jeUZpbHRlcigkbG9jYWxlKSB7CiAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogIHJldHVybiBmdW5jdGlvbihhbW91bnQsIGN1cnJlbmN5U3ltYm9sKXsKICAgIGlmIChpc1VuZGVmaW5lZChjdXJyZW5jeVN5bWJvbCkpIGN1cnJlbmN5U3ltYm9sID0gZm9ybWF0cy5DVVJSRU5DWV9TWU07CiAgICByZXR1cm4gZm9ybWF0TnVtYmVyKGFtb3VudCwgZm9ybWF0cy5QQVRURVJOU1sxXSwgZm9ybWF0cy5HUk9VUF9TRVAsIGZvcm1hdHMuREVDSU1BTF9TRVAsIDIpLgogICAgICAgICAgICAgICAgcmVwbGFjZSgvXHUwMEE0L2csIGN1cnJlbmN5U3ltYm9sKTsKICB9Owp9CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBudW1iZXIKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEZvcm1hdHMgYSBudW1iZXIgYXMgdGV4dC4KICoKICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAqCiAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gbnVtYmVyIE51bWJlciB0byBmb3JtYXQuCiAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gZnJhY3Rpb25TaXplIE51bWJlciBvZiBkZWNpbWFsIHBsYWNlcyB0byByb3VuZCB0aGUgbnVtYmVyIHRvLgogKiBJZiB0aGlzIGlzIG5vdCBwcm92aWRlZCB0aGVuIHRoZSBmcmFjdGlvbiBzaXplIGlzIGNvbXB1dGVkIGZyb20gdGhlIGN1cnJlbnQgbG9jYWxlJ3MgbnVtYmVyCiAqIGZvcm1hdHRpbmcgcGF0dGVybi4gSW4gdGhlIGNhc2Ugb2YgdGhlIGRlZmF1bHQgbG9jYWxlLCBpdCB3aWxsIGJlIDMuCiAqIEByZXR1cm5zIHtzdHJpbmd9IE51bWJlciByb3VuZGVkIHRvIGRlY2ltYWxQbGFjZXMgYW5kIHBsYWNlcyBhIOKAnCzigJ0gYWZ0ZXIgZWFjaCB0aGlyZCBkaWdpdC4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS52YWwgPSAxMjM0LjU2Nzg5OwogICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIEVudGVyIG51bWJlcjogPGlucHV0IG5nLW1vZGVsPSd2YWwnPjxicj4KICAgICAgICAgRGVmYXVsdCBmb3JtYXR0aW5nOiA8c3BhbiBpZD0nbnVtYmVyLWRlZmF1bHQnPnt7dmFsIHwgbnVtYmVyfX08L3NwYW4+PGJyPgogICAgICAgICBObyBmcmFjdGlvbnM6IDxzcGFuPnt7dmFsIHwgbnVtYmVyOjB9fTwvc3Bhbj48YnI+CiAgICAgICAgIE5lZ2F0aXZlIG51bWJlcjogPHNwYW4+e3stdmFsIHwgbnVtYmVyOjR9fTwvc3Bhbj4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgZm9ybWF0IG51bWJlcnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ251bWJlci1kZWZhdWx0JykpLmdldFRleHQoKSkudG9CZSgnMSwyMzQuNTY4Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLmdldFRleHQoKSkudG9CZSgnMSwyMzUnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnLXZhbCB8IG51bWJlcjo0JykpLmdldFRleHQoKSkudG9CZSgnLTEsMjM0LjU2NzknKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbCcpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWwnKSkuc2VuZEtleXMoJzMzNzQuMzMzJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdudW1iZXItZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJzMsMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS5nZXRUZXh0KCkpLnRvQmUoJzMsMzc0Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS5nZXRUZXh0KCkpLnRvQmUoJy0zLDM3NC4zMzMwJyk7CiAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgpudW1iZXJGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwpmdW5jdGlvbiBudW1iZXJGaWx0ZXIoJGxvY2FsZSkgewogIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICByZXR1cm4gZnVuY3Rpb24obnVtYmVyLCBmcmFjdGlvblNpemUpIHsKICAgIHJldHVybiBmb3JtYXROdW1iZXIobnVtYmVyLCBmb3JtYXRzLlBBVFRFUk5TWzBdLCBmb3JtYXRzLkdST1VQX1NFUCwgZm9ybWF0cy5ERUNJTUFMX1NFUCwKICAgICAgZnJhY3Rpb25TaXplKTsKICB9Owp9Cgp2YXIgREVDSU1BTF9TRVAgPSAnLic7CmZ1bmN0aW9uIGZvcm1hdE51bWJlcihudW1iZXIsIHBhdHRlcm4sIGdyb3VwU2VwLCBkZWNpbWFsU2VwLCBmcmFjdGlvblNpemUpIHsKICBpZiAobnVtYmVyID09IG51bGwgfHwgIWlzRmluaXRlKG51bWJlcikgfHwgaXNPYmplY3QobnVtYmVyKSkgcmV0dXJuICcnOwoKICB2YXIgaXNOZWdhdGl2ZSA9IG51bWJlciA8IDA7CiAgbnVtYmVyID0gTWF0aC5hYnMobnVtYmVyKTsKICB2YXIgbnVtU3RyID0gbnVtYmVyICsgJycsCiAgICAgIGZvcm1hdGVkVGV4dCA9ICcnLAogICAgICBwYXJ0cyA9IFtdOwoKICB2YXIgaGFzRXhwb25lbnQgPSBmYWxzZTsKICBpZiAobnVtU3RyLmluZGV4T2YoJ2UnKSAhPT0gLTEpIHsKICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgaWYgKG1hdGNoICYmIG1hdGNoWzJdID09ICctJyAmJiBtYXRjaFszXSA+IGZyYWN0aW9uU2l6ZSArIDEpIHsKICAgICAgbnVtU3RyID0gJzAnOwogICAgfSBlbHNlIHsKICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICBoYXNFeHBvbmVudCA9IHRydWU7CiAgICB9CiAgfQoKICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICB2YXIgZnJhY3Rpb25MZW4gPSAobnVtU3RyLnNwbGl0KERFQ0lNQUxfU0VQKVsxXSB8fCAnJykubGVuZ3RoOwoKICAgIC8vIGRldGVybWluZSBmcmFjdGlvblNpemUgaWYgaXQgaXMgbm90IHNwZWNpZmllZAogICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgZnJhY3Rpb25TaXplID0gTWF0aC5taW4oTWF0aC5tYXgocGF0dGVybi5taW5GcmFjLCBmcmFjdGlvbkxlbiksIHBhdHRlcm4ubWF4RnJhYyk7CiAgICB9CgogICAgdmFyIHBvdyA9IE1hdGgucG93KDEwLCBmcmFjdGlvblNpemUgKyAxKTsKICAgIG51bWJlciA9IE1hdGguZmxvb3IobnVtYmVyICogcG93ICsgNSkgLyBwb3c7CiAgICB2YXIgZnJhY3Rpb24gPSAoJycgKyBudW1iZXIpLnNwbGl0KERFQ0lNQUxfU0VQKTsKICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgZnJhY3Rpb24gPSBmcmFjdGlvblsxXSB8fCAnJzsKCiAgICB2YXIgaSwgcG9zID0gMCwKICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICBncm91cCA9IHBhdHRlcm4uZ1NpemU7CgogICAgaWYgKHdob2xlLmxlbmd0aCA+PSAobGdyb3VwICsgZ3JvdXApKSB7CiAgICAgIHBvcyA9IHdob2xlLmxlbmd0aCAtIGxncm91cDsKICAgICAgZm9yIChpID0gMDsgaSA8IHBvczsgaSsrKSB7CiAgICAgICAgaWYgKChwb3MgLSBpKSVncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICBmb3JtYXRlZFRleHQgKz0gZ3JvdXBTZXA7CiAgICAgICAgfQogICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGkgPSBwb3M7IGkgPCB3aG9sZS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoKHdob2xlLmxlbmd0aCAtIGkpJWxncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IGdyb3VwU2VwOwogICAgICB9CiAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICB9CgogICAgLy8gZm9ybWF0IGZyYWN0aW9uIHBhcnQuCiAgICB3aGlsZShmcmFjdGlvbi5sZW5ndGggPCBmcmFjdGlvblNpemUpIHsKICAgICAgZnJhY3Rpb24gKz0gJzAnOwogICAgfQoKICAgIGlmIChmcmFjdGlvblNpemUgJiYgZnJhY3Rpb25TaXplICE9PSAiMCIpIGZvcm1hdGVkVGV4dCArPSBkZWNpbWFsU2VwICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgfSBlbHNlIHsKCiAgICBpZiAoZnJhY3Rpb25TaXplID4gMCAmJiBudW1iZXIgPiAtMSAmJiBudW1iZXIgPCAxKSB7CiAgICAgIGZvcm1hdGVkVGV4dCA9IG51bWJlci50b0ZpeGVkKGZyYWN0aW9uU2l6ZSk7CiAgICB9CiAgfQoKICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1ByZSA6IHBhdHRlcm4ucG9zUHJlKTsKICBwYXJ0cy5wdXNoKGZvcm1hdGVkVGV4dCk7CiAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdTdWYgOiBwYXR0ZXJuLnBvc1N1Zik7CiAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwp9CgpmdW5jdGlvbiBwYWROdW1iZXIobnVtLCBkaWdpdHMsIHRyaW0pIHsKICB2YXIgbmVnID0gJyc7CiAgaWYgKG51bSA8IDApIHsKICAgIG5lZyA9ICAnLSc7CiAgICBudW0gPSAtbnVtOwogIH0KICBudW0gPSAnJyArIG51bTsKICB3aGlsZShudW0ubGVuZ3RoIDwgZGlnaXRzKSBudW0gPSAnMCcgKyBudW07CiAgaWYgKHRyaW0pCiAgICBudW0gPSBudW0uc3Vic3RyKG51bS5sZW5ndGggLSBkaWdpdHMpOwogIHJldHVybiBuZWcgKyBudW07Cn0KCgpmdW5jdGlvbiBkYXRlR2V0dGVyKG5hbWUsIHNpemUsIG9mZnNldCwgdHJpbSkgewogIG9mZnNldCA9IG9mZnNldCB8fCAwOwogIHJldHVybiBmdW5jdGlvbihkYXRlKSB7CiAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgIGlmIChvZmZzZXQgPiAwIHx8IHZhbHVlID4gLW9mZnNldCkKICAgICAgdmFsdWUgKz0gb2Zmc2V0OwogICAgaWYgKHZhbHVlID09PSAwICYmIG9mZnNldCA9PSAtMTIgKSB2YWx1ZSA9IDEyOwogICAgcmV0dXJuIHBhZE51bWJlcih2YWx1ZSwgc2l6ZSwgdHJpbSk7CiAgfTsKfQoKZnVuY3Rpb24gZGF0ZVN0ckdldHRlcihuYW1lLCBzaG9ydEZvcm0pIHsKICByZXR1cm4gZnVuY3Rpb24oZGF0ZSwgZm9ybWF0cykgewogICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICB2YXIgZ2V0ID0gdXBwZXJjYXNlKHNob3J0Rm9ybSA/ICgnU0hPUlQnICsgbmFtZSkgOiBuYW1lKTsKCiAgICByZXR1cm4gZm9ybWF0c1tnZXRdW3ZhbHVlXTsKICB9Owp9CgpmdW5jdGlvbiB0aW1lWm9uZUdldHRlcihkYXRlKSB7CiAgdmFyIHpvbmUgPSAtMSAqIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICB2YXIgcGFkZGVkWm9uZSA9ICh6b25lID49IDApID8gIisiIDogIiI7CgogIHBhZGRlZFpvbmUgKz0gcGFkTnVtYmVyKE1hdGhbem9uZSA+IDAgPyAnZmxvb3InIDogJ2NlaWwnXSh6b25lIC8gNjApLCAyKSArCiAgICAgICAgICAgICAgICBwYWROdW1iZXIoTWF0aC5hYnMoem9uZSAlIDYwKSwgMik7CgogIHJldHVybiBwYWRkZWRab25lOwp9CgpmdW5jdGlvbiBhbXBtR2V0dGVyKGRhdGUsIGZvcm1hdHMpIHsKICByZXR1cm4gZGF0ZS5nZXRIb3VycygpIDwgMTIgPyBmb3JtYXRzLkFNUE1TWzBdIDogZm9ybWF0cy5BTVBNU1sxXTsKfQoKdmFyIERBVEVfRk9STUFUUyA9IHsKICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgeXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMiwgMCwgdHJ1ZSksCiAgICAgeTogZGF0ZUdldHRlcignRnVsbFllYXInLCAxKSwKICBNTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcpLAogICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICBNTTogZGF0ZUdldHRlcignTW9udGgnLCAyLCAxKSwKICAgICBNOiBkYXRlR2V0dGVyKCdNb250aCcsIDEsIDEpLAogICAgZGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAyKSwKICAgICBkOiBkYXRlR2V0dGVyKCdEYXRlJywgMSksCiAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgaGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiwgLTEyKSwKICAgICBoOiBkYXRlR2V0dGVyKCdIb3VycycsIDEsIC0xMiksCiAgICBtbTogZGF0ZUdldHRlcignTWludXRlcycsIDIpLAogICAgIG06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAxKSwKICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogICAgIC8vIHdoaWxlIElTTyA4NjAxIHJlcXVpcmVzIGZyYWN0aW9ucyB0byBiZSBwcmVmaXhlZCB3aXRoIGAuYCBvciBgLGAKICAgICAvLyB3ZSBjYW4gYmUganVzdCBzYWZlbHkgcmVseSBvbiB1c2luZyBgc3NzYCBzaW5jZSB3ZSBjdXJyZW50bHkgZG9uJ3Qgc3VwcG9ydCBzaW5nbGUgb3IgdHdvIGRpZ2l0IGZyYWN0aW9ucwogICBzc3M6IGRhdGVHZXR0ZXIoJ01pbGxpc2Vjb25kcycsIDMpLAogIEVFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScpLAogICBFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScsIHRydWUpLAogICAgIGE6IGFtcG1HZXR0ZXIsCiAgICAgWjogdGltZVpvbmVHZXR0ZXIKfTsKCnZhciBEQVRFX0ZPUk1BVFNfU1BMSVQgPSAvKCg/OlteeU1kSGhtc2FaRSddKyl8KD86Jyg/OlteJ118JycpKicpfCg/OkUrfHkrfE0rfGQrfEgrfGgrfG0rfHMrfGF8WikpKC4qKS8sCiAgICBOVU1CRVJfU1RSSU5HID0gL15cLT9cZCskLzsKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGRhdGUKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqICAgRm9ybWF0cyBgZGF0ZWAgdG8gYSBzdHJpbmcgYmFzZWQgb24gdGhlIHJlcXVlc3RlZCBgZm9ybWF0YC4KICoKICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGJlIGNvbXBvc2VkIG9mIHRoZSBmb2xsb3dpbmcgZWxlbWVudHM6CiAqCiAqICAgKiBgJ3l5eXknYDogNCBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyIChlLmcuIEFEIDEgPT4gMDAwMSwgQUQgMjAxMCA9PiAyMDEwKQogKiAgICogYCd5eSdgOiAyIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIHBhZGRlZCAoMDAtOTkpLiAoZS5nLiBBRCAyMDAxID0+IDAxLCBBRCAyMDEwID0+IDEwKQogKiAgICogYCd5J2A6IDEgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgZS5nLiAoQUQgMSA9PiAxLCBBRCAxOTkgPT4gMTk5KQogKiAgICogYCdNTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbnVhcnktRGVjZW1iZXIpCiAqICAgKiBgJ01NTSdgOiBNb250aCBpbiB5ZWFyIChKYW4tRGVjKQogKiAgICogYCdNTSdgOiBNb250aCBpbiB5ZWFyLCBwYWRkZWQgKDAxLTEyKQogKiAgICogYCdNJ2A6IE1vbnRoIGluIHllYXIgKDEtMTIpCiAqICAgKiBgJ2RkJ2A6IERheSBpbiBtb250aCwgcGFkZGVkICgwMS0zMSkKICogICAqIGAnZCdgOiBEYXkgaW4gbW9udGggKDEtMzEpCiAqICAgKiBgJ0VFRUUnYDogRGF5IGluIFdlZWssKFN1bmRheS1TYXR1cmRheSkKICogICAqIGAnRUVFJ2A6IERheSBpbiBXZWVrLCAoU3VuLVNhdCkKICogICAqIGAnSEgnYDogSG91ciBpbiBkYXksIHBhZGRlZCAoMDAtMjMpCiAqICAgKiBgJ0gnYDogSG91ciBpbiBkYXkgKDAtMjMpCiAqICAgKiBgJ2hoJ2A6IEhvdXIgaW4gYW0vcG0sIHBhZGRlZCAoMDEtMTIpCiAqICAgKiBgJ2gnYDogSG91ciBpbiBhbS9wbSwgKDEtMTIpCiAqICAgKiBgJ21tJ2A6IE1pbnV0ZSBpbiBob3VyLCBwYWRkZWQgKDAwLTU5KQogKiAgICogYCdtJ2A6IE1pbnV0ZSBpbiBob3VyICgwLTU5KQogKiAgICogYCdzcydgOiBTZWNvbmQgaW4gbWludXRlLCBwYWRkZWQgKDAwLTU5KQogKiAgICogYCdzJ2A6IFNlY29uZCBpbiBtaW51dGUgKDAtNTkpCiAqICAgKiBgJy5zc3MnIG9yICcsc3NzJ2A6IE1pbGxpc2Vjb25kIGluIHNlY29uZCwgcGFkZGVkICgwMDAtOTk5KQogKiAgICogYCdhJ2A6IGFtL3BtIG1hcmtlcgogKiAgICogYCdaJ2A6IDQgZGlnaXQgKCtzaWduKSByZXByZXNlbnRhdGlvbiBvZiB0aGUgdGltZXpvbmUgb2Zmc2V0ICgtMTIwMC0rMTIwMCkKICoKICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGFsc28gYmUgb25lIG9mIHRoZSBmb2xsb3dpbmcgcHJlZGVmaW5lZAogKiAgIHtAbGluayBndWlkZS9pMThuIGxvY2FsaXphYmxlIGZvcm1hdHN9OgogKgogKiAgICogYCdtZWRpdW0nYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5IGg6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUKICogICAgIChlLmcuIFNlcCAzLCAyMDEwIDEyOjA1OjA4IHBtKQogKiAgICogYCdzaG9ydCdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5IGg6bW0gYSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIDkvMy8xMCAxMjowNSBwbSkKICogICAqIGAnZnVsbERhdGUnYDogZXF1aXZhbGVudCB0byBgJ0VFRUUsIE1NTU0gZCx5J2AgZm9yIGVuX1VTICBsb2NhbGUKICogICAgIChlLmcuIEZyaWRheSwgU2VwdGVtYmVyIDMsIDIwMTApCiAqICAgKiBgJ2xvbmdEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXB0ZW1iZXIgMywgMjAxMCkKICogICAqIGAnbWVkaXVtRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXAgMywgMjAxMCkKICogICAqIGAnc2hvcnREYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXknYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDkvMy8xMCkKICogICAqIGAnbWVkaXVtVGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbTpzcyBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNTowOCBwbSkKICogICAqIGAnc2hvcnRUaW1lJ2A6IGVxdWl2YWxlbnQgdG8gYCdoOm1tIGEnYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1IHBtKQogKgogKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gY29udGFpbiBsaXRlcmFsIHZhbHVlcy4gVGhlc2UgbmVlZCB0byBiZSBxdW90ZWQgd2l0aCBzaW5nbGUgcXVvdGVzIChlLmcuCiAqICAgYCJoICdpbiB0aGUgbW9ybmluZyciYCkuIEluIG9yZGVyIHRvIG91dHB1dCBzaW5nbGUgcXVvdGUsIHVzZSB0d28gc2luZ2xlIHF1b3RlcyBpbiBhIHNlcXVlbmNlCiAqICAgKGUuZy4gYCJoICdvJydjbG9jayciYCkuCiAqCiAqIEBwYXJhbSB7KERhdGV8bnVtYmVyfHN0cmluZyl9IGRhdGUgRGF0ZSB0byBmb3JtYXQgZWl0aGVyIGFzIERhdGUgb2JqZWN0LCBtaWxsaXNlY29uZHMgKHN0cmluZyBvcgogKiAgICBudW1iZXIpIG9yIHZhcmlvdXMgSVNPIDg2MDEgZGF0ZXRpbWUgc3RyaW5nIGZvcm1hdHMgKGUuZy4geXl5eS1NTS1kZFRISDptbTpzcy5TU1NaIGFuZCBpdHMKICogICAgc2hvcnRlciB2ZXJzaW9ucyBsaWtlIHl5eXktTU0tZGRUSEg6bW1aLCB5eXl5LU1NLWRkIG9yIHl5eXlNTWRkVEhIbW1zc1opLiBJZiBubyB0aW1lem9uZSBpcwogKiAgICBzcGVjaWZpZWQgaW4gdGhlIHN0cmluZyBpbnB1dCwgdGhlIHRpbWUgaXMgY29uc2lkZXJlZCB0byBiZSBpbiB0aGUgbG9jYWwgdGltZXpvbmUuCiAqIEBwYXJhbSB7c3RyaW5nPX0gZm9ybWF0IEZvcm1hdHRpbmcgcnVsZXMgKHNlZSBEZXNjcmlwdGlvbikuIElmIG5vdCBzcGVjaWZpZWQsCiAqICAgIGBtZWRpdW1EYXRlYCBpcyB1c2VkLgogKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgc3RyaW5nIG9yIHRoZSBpbnB1dCBpZiBpbnB1dCBpcyBub3QgcmVjb2duaXplZCBhcyBkYXRlL21pbGxpcy4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PC9zcGFuPjoKICAgICAgICAgICA8c3Bhbj57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08L3NwYW4+PGJyPgogICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWid9fTwvc3Bhbj46CiAgICAgICAgICA8c3Bhbj57ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08L3NwYW4+PGJyPgogICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj46CiAgICAgICAgICA8c3Bhbj57eycxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj48YnI+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJyIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKEFNfFBNKS8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJyIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC8yMDEwXC0xMFwtMlxkIFxkezJ9OlxkezJ9OlxkezJ9IChcLXxcKyk/XGR7NH0vKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJyIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC8xMFwvMlxkXC8yMDEwIEAgXGR7MSwyfTpcZHsyfShBTXxQTSkvKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZGF0ZUZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CmZ1bmN0aW9uIGRhdGVGaWx0ZXIoJGxvY2FsZSkgewoKCiAgdmFyIFJfSVNPODYwMV9TVFIgPSAvXihcZHs0fSktPyhcZFxkKS0/KFxkXGQpKD86VChcZFxkKSg/Ojo/KFxkXGQpKD86Oj8oXGRcZCkoPzpcLihcZCspKT8pPyk/KFp8KFsrLV0pKFxkXGQpOj8oXGRcZCkpPyk/JC87CiAgICAgICAgICAgICAgICAgICAgIC8vIDEgICAgICAgIDIgICAgICAgMyAgICAgICAgIDQgICAgICAgICAgNSAgICAgICAgICA2ICAgICAgICAgIDcgICAgICAgICAgOCAgOSAgICAgMTAgICAgICAxMQogIGZ1bmN0aW9uIGpzb25TdHJpbmdUb0RhdGUoc3RyaW5nKSB7CiAgICB2YXIgbWF0Y2g7CiAgICBpZiAobWF0Y2ggPSBzdHJpbmcubWF0Y2goUl9JU084NjAxX1NUUikpIHsKICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgwKSwKICAgICAgICAgIHR6SG91ciA9IDAsCiAgICAgICAgICB0ek1pbiAgPSAwLAogICAgICAgICAgZGF0ZVNldHRlciA9IG1hdGNoWzhdID8gZGF0ZS5zZXRVVENGdWxsWWVhciA6IGRhdGUuc2V0RnVsbFllYXIsCiAgICAgICAgICB0aW1lU2V0dGVyID0gbWF0Y2hbOF0gPyBkYXRlLnNldFVUQ0hvdXJzIDogZGF0ZS5zZXRIb3VyczsKCiAgICAgIGlmIChtYXRjaFs5XSkgewogICAgICAgIHR6SG91ciA9IGludChtYXRjaFs5XSArIG1hdGNoWzEwXSk7CiAgICAgICAgdHpNaW4gPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMV0pOwogICAgICB9CiAgICAgIGRhdGVTZXR0ZXIuY2FsbChkYXRlLCBpbnQobWF0Y2hbMV0pLCBpbnQobWF0Y2hbMl0pIC0gMSwgaW50KG1hdGNoWzNdKSk7CiAgICAgIHZhciBoID0gaW50KG1hdGNoWzRdfHwwKSAtIHR6SG91cjsKICAgICAgdmFyIG0gPSBpbnQobWF0Y2hbNV18fDApIC0gdHpNaW47CiAgICAgIHZhciBzID0gaW50KG1hdGNoWzZdfHwwKTsKICAgICAgdmFyIG1zID0gTWF0aC5yb3VuZChwYXJzZUZsb2F0KCcwLicgKyAobWF0Y2hbN118fDApKSAqIDEwMDApOwogICAgICB0aW1lU2V0dGVyLmNhbGwoZGF0ZSwgaCwgbSwgcywgbXMpOwogICAgICByZXR1cm4gZGF0ZTsKICAgIH0KICAgIHJldHVybiBzdHJpbmc7CiAgfQoKCiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUsIGZvcm1hdCkgewogICAgdmFyIHRleHQgPSAnJywKICAgICAgICBwYXJ0cyA9IFtdLAogICAgICAgIGZuLCBtYXRjaDsKCiAgICBmb3JtYXQgPSBmb3JtYXQgfHwgJ21lZGl1bURhdGUnOwogICAgZm9ybWF0ID0gJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTW2Zvcm1hdF0gfHwgZm9ybWF0OwogICAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICAgIGlmIChOVU1CRVJfU1RSSU5HLnRlc3QoZGF0ZSkpIHsKICAgICAgICBkYXRlID0gaW50KGRhdGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGUgPSBqc29uU3RyaW5nVG9EYXRlKGRhdGUpOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzTnVtYmVyKGRhdGUpKSB7CiAgICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTsKICAgIH0KCiAgICBpZiAoIWlzRGF0ZShkYXRlKSkgewogICAgICByZXR1cm4gZGF0ZTsKICAgIH0KCiAgICB3aGlsZShmb3JtYXQpIHsKICAgICAgbWF0Y2ggPSBEQVRFX0ZPUk1BVFNfU1BMSVQuZXhlYyhmb3JtYXQpOwogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBwYXJ0cyA9IGNvbmNhdChwYXJ0cywgbWF0Y2gsIDEpOwogICAgICAgIGZvcm1hdCA9IHBhcnRzLnBvcCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICB9CiAgICB9CgogICAgZm9yRWFjaChwYXJ0cywgZnVuY3Rpb24odmFsdWUpewogICAgICBmbiA9IERBVEVfRk9STUFUU1t2YWx1ZV07CiAgICAgIHRleHQgKz0gZm4gPyBmbihkYXRlLCAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMpCiAgICAgICAgICAgICAgICAgOiB2YWx1ZS5yZXBsYWNlKC8oXid8JyQpL2csICcnKS5yZXBsYWNlKC8nJy9nLCAiJyIpOwogICAgfSk7CgogICAgcmV0dXJuIHRleHQ7CiAgfTsKfQoKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGpzb24KICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqICAgQWxsb3dzIHlvdSB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBvYmplY3QgaW50byBKU09OIHN0cmluZy4KICoKICogICBUaGlzIGZpbHRlciBpcyBtb3N0bHkgdXNlZnVsIGZvciBkZWJ1Z2dpbmcuIFdoZW4gdXNpbmcgdGhlIGRvdWJsZSBjdXJseSB7e3ZhbHVlfX0gbm90YXRpb24KICogICB0aGUgYmluZGluZyBpcyBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBKU09OLgogKgogKiBAcGFyYW0geyp9IG9iamVjdCBBbnkgSmF2YVNjcmlwdCBvYmplY3QgKGluY2x1ZGluZyBhcnJheXMgYW5kIHByaW1pdGl2ZSB0eXBlcykgdG8gZmlsdGVyLgogKiBAcmV0dXJucyB7c3RyaW5nfSBKU09OIHN0cmluZy4KICoKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8cHJlPnt7IHsnbmFtZSc6J3ZhbHVlJ30gfCBqc29uIH19PC9wcmU+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBqc29uaWZ5IGZpbHRlcmVkIG9iamVjdHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygieyduYW1lJzondmFsdWUnfSIpKS5nZXRUZXh0KCkpLnRvTWF0Y2goL1x7XG4gICJuYW1lIjogPyJ2YWx1ZSJcbn0vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKgogKi8KZnVuY3Rpb24ganNvbkZpbHRlcigpIHsKICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICByZXR1cm4gdG9Kc29uKG9iamVjdCwgdHJ1ZSk7CiAgfTsKfQoKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGxvd2VyY2FzZQogKiBAa2luZCBmdW5jdGlvbgogKiBAZGVzY3JpcHRpb24KICogQ29udmVydHMgc3RyaW5nIHRvIGxvd2VyY2FzZS4KICogQHNlZSBhbmd1bGFyLmxvd2VyY2FzZQogKi8KdmFyIGxvd2VyY2FzZUZpbHRlciA9IHZhbHVlRm4obG93ZXJjYXNlKTsKCgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSB1cHBlcmNhc2UKICogQGtpbmQgZnVuY3Rpb24KICogQGRlc2NyaXB0aW9uCiAqIENvbnZlcnRzIHN0cmluZyB0byB1cHBlcmNhc2UuCiAqIEBzZWUgYW5ndWxhci51cHBlcmNhc2UKICovCnZhciB1cHBlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKHVwcGVyY2FzZSk7CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBsaW1pdFRvCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGEgbmV3IGFycmF5IG9yIHN0cmluZyBjb250YWluaW5nIG9ubHkgYSBzcGVjaWZpZWQgbnVtYmVyIG9mIGVsZW1lbnRzLiBUaGUgZWxlbWVudHMKICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5IG9yIHN0cmluZywgYXMgc3BlY2lmaWVkIGJ5CiAqIHRoZSB2YWx1ZSBhbmQgc2lnbiAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIG9mIGBsaW1pdGAuCiAqCiAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBpbnB1dCBTb3VyY2UgYXJyYXkgb3Igc3RyaW5nIHRvIGJlIGxpbWl0ZWQuCiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkgb3Igc3RyaW5nLiBJZiB0aGUgYGxpbWl0YCBudW1iZXIKICogICAgIGlzIHBvc2l0aXZlLCBgbGltaXRgIG51bWJlciBvZiBpdGVtcyBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNvdXJjZSBhcnJheS9zdHJpbmcgYXJlIGNvcGllZC4KICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheS9zdHJpbmcKICogICAgIGFyZSBjb3BpZWQuIFRoZSBgbGltaXRgIHdpbGwgYmUgdHJpbW1lZCBpZiBpdCBleGNlZWRzIGBhcnJheS5sZW5ndGhgCiAqIEByZXR1cm5zIHtBcnJheXxzdHJpbmd9IEEgbmV3IHN1Yi1hcnJheSBvciBzdWJzdHJpbmcgb2YgbGVuZ3RoIGBsaW1pdGAgb3IgbGVzcyBpZiBpbnB1dCBhcnJheQogKiAgICAgaGFkIGxlc3MgdGhhbiBgbGltaXRgIGVsZW1lbnRzLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLm51bWJlcnMgPSBbMSwyLDMsNCw1LDYsNyw4LDldOwogICAgICAgICAgICRzY29wZS5sZXR0ZXJzID0gImFiY2RlZmdoaSI7CiAgICAgICAgICAgJHNjb3BlLm51bUxpbWl0ID0gMzsKICAgICAgICAgICAkc2NvcGUubGV0dGVyTGltaXQgPSAzOwogICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIExpbWl0IHt7bnVtYmVyc319IHRvOiA8aW5wdXQgdHlwZT0iaW50ZWdlciIgbmctbW9kZWw9Im51bUxpbWl0Ij4KICAgICAgICAgPHA+T3V0cHV0IG51bWJlcnM6IHt7IG51bWJlcnMgfCBsaW1pdFRvOm51bUxpbWl0IH19PC9wPgogICAgICAgICBMaW1pdCB7e2xldHRlcnN9fSB0bzogPGlucHV0IHR5cGU9ImludGVnZXIiIG5nLW1vZGVsPSJsZXR0ZXJMaW1pdCI+CiAgICAgICAgIDxwPk91dHB1dCBsZXR0ZXJzOiB7eyBsZXR0ZXJzIHwgbGltaXRUbzpsZXR0ZXJMaW1pdCB9fTwvcD4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIHZhciBudW1MaW1pdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbnVtTGltaXQnKSk7CiAgICAgICB2YXIgbGV0dGVyTGltaXRJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ2xldHRlckxpbWl0JykpOwogICAgICAgdmFyIGxpbWl0ZWROdW1iZXJzID0gZWxlbWVudChieS5iaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpudW1MaW1pdCcpKTsKICAgICAgIHZhciBsaW1pdGVkTGV0dGVycyA9IGVsZW1lbnQoYnkuYmluZGluZygnbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQnKSk7CgogICAgICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtYmVyIGFycmF5IHRvIGZpcnN0IHRocmVlIGl0ZW1zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChudW1MaW1pdElucHV0LmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnMycpOwogICAgICAgICBleHBlY3QobGV0dGVyTGltaXRJbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWROdW1iZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IG51bWJlcnM6IFsxLDIsM10nKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWRMZXR0ZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IGxldHRlcnM6IGFiYycpOwogICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIG91dHB1dCB3aGVuIC0zIGlzIGVudGVyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgbnVtTGltaXRJbnB1dC5jbGVhcigpOwogICAgICAgICBudW1MaW1pdElucHV0LnNlbmRLZXlzKCctMycpOwogICAgICAgICBsZXR0ZXJMaW1pdElucHV0LmNsZWFyKCk7CiAgICAgICAgIGxldHRlckxpbWl0SW5wdXQuc2VuZEtleXMoJy0zJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTnVtYmVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBudW1iZXJzOiBbNyw4LDldJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTGV0dGVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBsZXR0ZXJzOiBnaGknKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgbm90IGV4Y2VlZCB0aGUgbWF4aW11bSBzaXplIG9mIGlucHV0IGFycmF5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIG51bUxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbnVtTGltaXRJbnB1dC5zZW5kS2V5cygnMTAwJyk7CiAgICAgICAgIGxldHRlckxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbGV0dGVyTGltaXRJbnB1dC5zZW5kS2V5cygnMTAwJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTnVtYmVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBudW1iZXJzOiBbMSwyLDMsNCw1LDYsNyw4LDldJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTGV0dGVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBsZXR0ZXJzOiBhYmNkZWZnaGknKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gbGltaXRUb0ZpbHRlcigpewogIHJldHVybiBmdW5jdGlvbihpbnB1dCwgbGltaXQpIHsKICAgIGlmICghaXNBcnJheShpbnB1dCkgJiYgIWlzU3RyaW5nKGlucHV0KSkgcmV0dXJuIGlucHV0OwoKICAgIGlmIChNYXRoLmFicyhOdW1iZXIobGltaXQpKSA9PT0gSW5maW5pdHkpIHsKICAgICAgbGltaXQgPSBOdW1iZXIobGltaXQpOwogICAgfSBlbHNlIHsKICAgICAgbGltaXQgPSBpbnQobGltaXQpOwogICAgfQoKICAgIGlmIChpc1N0cmluZyhpbnB1dCkpIHsKICAgICAgLy9OYU4gY2hlY2sgb24gbGltaXQKICAgICAgaWYgKGxpbWl0KSB7CiAgICAgICAgcmV0dXJuIGxpbWl0ID49IDAgPyBpbnB1dC5zbGljZSgwLCBsaW1pdCkgOiBpbnB1dC5zbGljZShsaW1pdCwgaW5wdXQubGVuZ3RoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gIiI7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgb3V0ID0gW10sCiAgICAgIGksIG47CgogICAgLy8gaWYgYWJzKGxpbWl0KSBleGNlZWRzIG1heGltdW0gbGVuZ3RoLCB0cmltIGl0CiAgICBpZiAobGltaXQgPiBpbnB1dC5sZW5ndGgpCiAgICAgIGxpbWl0ID0gaW5wdXQubGVuZ3RoOwogICAgZWxzZSBpZiAobGltaXQgPCAtaW5wdXQubGVuZ3RoKQogICAgICBsaW1pdCA9IC1pbnB1dC5sZW5ndGg7CgogICAgaWYgKGxpbWl0ID4gMCkgewogICAgICBpID0gMDsKICAgICAgbiA9IGxpbWl0OwogICAgfSBlbHNlIHsKICAgICAgaSA9IGlucHV0Lmxlbmd0aCArIGxpbWl0OwogICAgICBuID0gaW5wdXQubGVuZ3RoOwogICAgfQoKICAgIGZvciAoOyBpPG47IGkrKykgewogICAgICBvdXQucHVzaChpbnB1dFtpXSk7CiAgICB9CgogICAgcmV0dXJuIG91dDsKICB9Owp9CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBvcmRlckJ5CiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBPcmRlcnMgYSBzcGVjaWZpZWQgYGFycmF5YCBieSB0aGUgYGV4cHJlc3Npb25gIHByZWRpY2F0ZS4gSXQgaXMgb3JkZXJlZCBhbHBoYWJldGljYWxseQogKiBmb3Igc3RyaW5ncyBhbmQgbnVtZXJpY2FsbHkgZm9yIG51bWJlcnMuIE5vdGU6IGlmIHlvdSBub3RpY2UgbnVtYmVycyBhcmUgbm90IGJlaW5nIHNvcnRlZAogKiBjb3JyZWN0bHksIG1ha2Ugc3VyZSB0aGV5IGFyZSBhY3R1YWxseSBiZWluZyBzYXZlZCBhcyBudW1iZXJzIGFuZCBub3Qgc3RyaW5ncy4KICoKICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNvcnQuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKil8c3RyaW5nfEFycmF5LjwoZnVuY3Rpb24oKil8c3RyaW5nKT59IGV4cHJlc3Npb24gQSBwcmVkaWNhdGUgdG8gYmUKICogICAgdXNlZCBieSB0aGUgY29tcGFyYXRvciB0byBkZXRlcm1pbmUgdGhlIG9yZGVyIG9mIGVsZW1lbnRzLgogKgogKiAgICBDYW4gYmUgb25lIG9mOgogKgogKiAgICAtIGBmdW5jdGlvbmA6IEdldHRlciBmdW5jdGlvbi4gVGhlIHJlc3VsdCBvZiB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUgc29ydGVkIHVzaW5nIHRoZQogKiAgICAgIGA8YCwgYD1gLCBgPmAgb3BlcmF0b3IuCiAqICAgIC0gYHN0cmluZ2A6IEFuIEFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0IHRvIG9yZGVyIGJ5LCBzdWNoIGFzICduYW1lJwogKiAgICAgIHRvIHNvcnQgYnkgYSBwcm9wZXJ0eSBjYWxsZWQgJ25hbWUnLiBPcHRpb25hbGx5IHByZWZpeGVkIHdpdGggYCtgIG9yIGAtYCB0byBjb250cm9sCiAqICAgICAgYXNjZW5kaW5nIG9yIGRlc2NlbmRpbmcgc29ydCBvcmRlciAoZm9yIGV4YW1wbGUsICtuYW1lIG9yIC1uYW1lKS4KICogICAgLSBgQXJyYXlgOiBBbiBhcnJheSBvZiBmdW5jdGlvbiBvciBzdHJpbmcgcHJlZGljYXRlcy4gVGhlIGZpcnN0IHByZWRpY2F0ZSBpbiB0aGUgYXJyYXkKICogICAgICBpcyB1c2VkIGZvciBzb3J0aW5nLCBidXQgd2hlbiB0d28gaXRlbXMgYXJlIGVxdWl2YWxlbnQsIHRoZSBuZXh0IHByZWRpY2F0ZSBpcyB1c2VkLgogKgogKiBAcGFyYW0ge2Jvb2xlYW49fSByZXZlcnNlIFJldmVyc2UgdGhlIG9yZGVyIG9mIHRoZSBhcnJheS4KICogQHJldHVybnMge0FycmF5fSBTb3J0ZWQgY29weSBvZiB0aGUgc291cmNlIGFycmF5LgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPQogICAgICAgICAgICAgICBbe25hbWU6J0pvaG4nLCBwaG9uZTonNTU1LTEyMTInLCBhZ2U6MTB9LAogICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonNTU1LTk4NzYnLCBhZ2U6MTl9LAogICAgICAgICAgICAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnLCBhZ2U6MjF9LAogICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnLCBhZ2U6MzV9LAogICAgICAgICAgICAgICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1JywgYWdlOjI5fV0KICAgICAgICAgICAkc2NvcGUucHJlZGljYXRlID0gJy1hZ2UnOwogICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIDxwcmU+U29ydGluZyBwcmVkaWNhdGUgPSB7e3ByZWRpY2F0ZX19OyByZXZlcnNlID0ge3tyZXZlcnNlfX08L3ByZT4KICAgICAgICAgPGhyLz4KICAgICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGU9JyciPnVuc29ydGVkPC9hPiBdCiAgICAgICAgIDx0YWJsZSBjbGFzcz0iZnJpZW5kIj4KICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ25hbWUnOyByZXZlcnNlPWZhbHNlIj5OYW1lPC9hPgogICAgICAgICAgICAgICAgICg8YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnLW5hbWUnOyByZXZlcnNlPWZhbHNlIj5ePC9hPik8L3RoPgogICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdhZ2UnOyByZXZlcnNlPSFyZXZlcnNlIj5BZ2U8L2E+PC90aD4KICAgICAgICAgICA8L3RyPgogICAgICAgICAgIDx0ciBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIHwgb3JkZXJCeTpwcmVkaWNhdGU6cmV2ZXJzZSI+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgICAgICAgICAgPC90cj4KICAgICAgICAgPC90YWJsZT4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKgogKiBJdCdzIGFsc28gcG9zc2libGUgdG8gY2FsbCB0aGUgb3JkZXJCeSBmaWx0ZXIgbWFudWFsbHksIGJ5IGluamVjdGluZyBgJGZpbHRlcmAsIHJldHJpZXZpbmcgdGhlCiAqIGZpbHRlciByb3V0aW5lIHdpdGggYCRmaWx0ZXIoJ29yZGVyQnknKWAsIGFuZCBjYWxsaW5nIHRoZSByZXR1cm5lZCBmaWx0ZXIgcm91dGluZSB3aXRoIHRoZQogKiBkZXNpcmVkIHBhcmFtZXRlcnMuCiAqCiAqIEV4YW1wbGU6CiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGU+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICA8dGFibGUgY2xhc3M9ImZyaWVuZCI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJyZXZlcnNlPWZhbHNlO29yZGVyKCduYW1lJywgZmFsc2UpIj5OYW1lPC9hPgogICAgICAgICAgICAgICg8YSBocmVmPSIiIG5nLWNsaWNrPSJvcmRlcignLW5hbWUnLGZhbHNlKSI+XjwvYT4pPC90aD4KICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InJldmVyc2U9IXJldmVyc2U7b3JkZXIoJ3Bob25lJywgcmV2ZXJzZSkiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icmV2ZXJzZT0hcmV2ZXJzZTtvcmRlcignYWdlJyxyZXZlcnNlKSI+QWdlPC9hPjwvdGg+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMiPgogICAgICAgICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgICAgICAgICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICAgICAgICAgPC90cj4KICAgICAgICA8L3RhYmxlPgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KCiAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSwgJGZpbHRlcikgewogICAgICAgIHZhciBvcmRlckJ5ID0gJGZpbHRlcignb3JkZXJCeScpOwogICAgICAgICRzY29wZS5mcmllbmRzID0gWwogICAgICAgICAgeyBuYW1lOiAnSm9obicsICAgIHBob25lOiAnNTU1LTEyMTInLCAgICBhZ2U6IDEwIH0sCiAgICAgICAgICB7IG5hbWU6ICdNYXJ5JywgICAgcGhvbmU6ICc1NTUtOTg3NicsICAgIGFnZTogMTkgfSwKICAgICAgICAgIHsgbmFtZTogJ01pa2UnLCAgICBwaG9uZTogJzU1NS00MzIxJywgICAgYWdlOiAyMSB9LAogICAgICAgICAgeyBuYW1lOiAnQWRhbScsICAgIHBob25lOiAnNTU1LTU2NzgnLCAgICBhZ2U6IDM1IH0sCiAgICAgICAgICB7IG5hbWU6ICdKdWxpZScsICAgcGhvbmU6ICc1NTUtODc2NScsICAgIGFnZTogMjkgfQogICAgICAgIF07CgogICAgICAgICRzY29wZS5vcmRlciA9IGZ1bmN0aW9uKHByZWRpY2F0ZSwgcmV2ZXJzZSkgewogICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPSBvcmRlckJ5KCRzY29wZS5mcmllbmRzLCBwcmVkaWNhdGUsIHJldmVyc2UpOwogICAgICAgIH07CiAgICAgICAgJHNjb3BlLm9yZGVyKCctYWdlJyxmYWxzZSk7CiAgICAgIH0KICAgIDwvZmlsZT4KPC9leGFtcGxlPgogKi8Kb3JkZXJCeUZpbHRlci4kaW5qZWN0ID0gWyckcGFyc2UnXTsKZnVuY3Rpb24gb3JkZXJCeUZpbHRlcigkcGFyc2UpewogIHJldHVybiBmdW5jdGlvbihhcnJheSwgc29ydFByZWRpY2F0ZSwgcmV2ZXJzZU9yZGVyKSB7CiAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICBpZiAoIXNvcnRQcmVkaWNhdGUpIHJldHVybiBhcnJheTsKICAgIHNvcnRQcmVkaWNhdGUgPSBpc0FycmF5KHNvcnRQcmVkaWNhdGUpID8gc29ydFByZWRpY2F0ZTogW3NvcnRQcmVkaWNhdGVdOwogICAgc29ydFByZWRpY2F0ZSA9IG1hcChzb3J0UHJlZGljYXRlLCBmdW5jdGlvbihwcmVkaWNhdGUpewogICAgICB2YXIgZGVzY2VuZGluZyA9IGZhbHNlLCBnZXQgPSBwcmVkaWNhdGUgfHwgaWRlbnRpdHk7CiAgICAgIGlmIChpc1N0cmluZyhwcmVkaWNhdGUpKSB7CiAgICAgICAgaWYgKChwcmVkaWNhdGUuY2hhckF0KDApID09ICcrJyB8fCBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJykpIHsKICAgICAgICAgIGRlc2NlbmRpbmcgPSBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJzsKICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIGdldCA9ICRwYXJzZShwcmVkaWNhdGUpOwogICAgICAgIGlmIChnZXQuY29uc3RhbnQpIHsKICAgICAgICAgIHZhciBrZXkgPSBnZXQoKTsKICAgICAgICAgIHJldHVybiByZXZlcnNlQ29tcGFyYXRvcihmdW5jdGlvbihhLGIpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmUoYVtrZXldLCBiW2tleV0pOwogICAgICAgICAgfSwgZGVzY2VuZGluZyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXZlcnNlQ29tcGFyYXRvcihmdW5jdGlvbihhLGIpewogICAgICAgIHJldHVybiBjb21wYXJlKGdldChhKSxnZXQoYikpOwogICAgICB9LCBkZXNjZW5kaW5nKTsKICAgIH0pOwogICAgdmFyIGFycmF5Q29weSA9IFtdOwogICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsgYXJyYXlDb3B5LnB1c2goYXJyYXlbaV0pOyB9CiAgICByZXR1cm4gYXJyYXlDb3B5LnNvcnQocmV2ZXJzZUNvbXBhcmF0b3IoY29tcGFyYXRvciwgcmV2ZXJzZU9yZGVyKSk7CgogICAgZnVuY3Rpb24gY29tcGFyYXRvcihvMSwgbzIpewogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3J0UHJlZGljYXRlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGNvbXAgPSBzb3J0UHJlZGljYXRlW2ldKG8xLCBvMik7CiAgICAgICAgaWYgKGNvbXAgIT09IDApIHJldHVybiBjb21wOwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfQogICAgZnVuY3Rpb24gcmV2ZXJzZUNvbXBhcmF0b3IoY29tcCwgZGVzY2VuZGluZykgewogICAgICByZXR1cm4gdG9Cb29sZWFuKGRlc2NlbmRpbmcpCiAgICAgICAgICA/IGZ1bmN0aW9uKGEsYil7cmV0dXJuIGNvbXAoYixhKTt9CiAgICAgICAgICA6IGNvbXA7CiAgICB9CiAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2Mil7CiAgICAgIHZhciB0MSA9IHR5cGVvZiB2MTsKICAgICAgdmFyIHQyID0gdHlwZW9mIHYyOwogICAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHsKICAgICAgICAgICB2MSA9IHYxLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgdjIgPSB2Mi50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0KICAgICAgICBpZiAodjEgPT09IHYyKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gdjEgPCB2MiA/IC0xIDogMTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgfQogICAgfQogIH07Cn0KCmZ1bmN0aW9uIG5nRGlyZWN0aXZlKGRpcmVjdGl2ZSkgewogIGlmIChpc0Z1bmN0aW9uKGRpcmVjdGl2ZSkpIHsKICAgIGRpcmVjdGl2ZSA9IHsKICAgICAgbGluazogZGlyZWN0aXZlCiAgICB9OwogIH0KICBkaXJlY3RpdmUucmVzdHJpY3QgPSBkaXJlY3RpdmUucmVzdHJpY3QgfHwgJ0FDJzsKICByZXR1cm4gdmFsdWVGbihkaXJlY3RpdmUpOwp9CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBNb2RpZmllcyB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiB0aGUgaHRtbCBBIHRhZyBzbyB0aGF0IHRoZSBkZWZhdWx0IGFjdGlvbiBpcyBwcmV2ZW50ZWQgd2hlbgogKiB0aGUgaHJlZiBhdHRyaWJ1dGUgaXMgZW1wdHkuCiAqCiAqIFRoaXMgY2hhbmdlIHBlcm1pdHMgdGhlIGVhc3kgY3JlYXRpb24gb2YgYWN0aW9uIGxpbmtzIHdpdGggdGhlIGBuZ0NsaWNrYCBkaXJlY3RpdmUKICogd2l0aG91dCBjaGFuZ2luZyB0aGUgbG9jYXRpb24gb3IgY2F1c2luZyBwYWdlIHJlbG9hZHMsIGUuZy46CiAqIGA8YSBocmVmPSIiIG5nLWNsaWNrPSJsaXN0LmFkZEl0ZW0oKSI+QWRkIEl0ZW08L2E+YAogKi8KdmFyIGh0bWxBbmNob3JEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICByZXN0cmljdDogJ0UnLAogIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKCiAgICBpZiAobXNpZSA8PSA4KSB7CgogICAgICAvLyB0dXJuIDxhIGhyZWYgbmctY2xpY2s9Ii4uIj5saW5rPC9hPiBpbnRvIGEgc3R5bGFibGUgbGluayBpbiBJRQogICAgICAvLyBidXQgb25seSBpZiBpdCBkb2Vzbid0IGhhdmUgbmFtZSBhdHRyaWJ1dGUsIGluIHdoaWNoIGNhc2UgaXQncyBhbiBhbmNob3IKICAgICAgaWYgKCFhdHRyLmhyZWYgJiYgIWF0dHIubmFtZSkgewogICAgICAgIGF0dHIuJHNldCgnaHJlZicsICcnKTsKICAgICAgfQoKICAgICAgLy8gYWRkIGEgY29tbWVudCBub2RlIHRvIGFuY2hvcnMgdG8gd29ya2Fyb3VuZCBJRSBidWcgdGhhdCBjYXVzZXMgZWxlbWVudCBjb250ZW50IHRvIGJlIHJlc2V0CiAgICAgIC8vIHRvIG5ldyBhdHRyaWJ1dGUgY29udGVudCBpZiBhdHRyaWJ1dGUgaXMgdXBkYXRlZCB3aXRoIHZhbHVlIGNvbnRhaW5pbmcgQCBhbmQgZWxlbWVudCBhbHNvCiAgICAgIC8vIGNvbnRhaW5zIHZhbHVlIHdpdGggQAogICAgICAvLyBzZWUgaXNzdWUgIzE5NDkKICAgICAgZWxlbWVudC5hcHBlbmQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnSUUgZml4JykpOwogICAgfQoKICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLnhsaW5rSHJlZiAmJiAhYXR0ci5uYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCkgewogICAgICAgIC8vIFNWR0FFbGVtZW50IGRvZXMgbm90IHVzZSB0aGUgaHJlZiBhdHRyaWJ1dGUsIGJ1dCByYXRoZXIgdGhlICd4bGlua0hyZWYnIGF0dHJpYnV0ZS4KICAgICAgICB2YXIgaHJlZiA9IHRvU3RyaW5nLmNhbGwoZWxlbWVudC5wcm9wKCdocmVmJykpID09PSAnW29iamVjdCBTVkdBbmltYXRlZFN0cmluZ10nID8KICAgICAgICAgICAgICAgICAgICd4bGluazpocmVmJyA6ICdocmVmJzsKICAgICAgICBlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgbm8gaHJlZiB1cmwsIHRoZW4gZG9uJ3QgbmF2aWdhdGUgYW55d2hlcmUuCiAgICAgICAgICBpZiAoIWVsZW1lbnQuYXR0cihocmVmKSkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfQogIH0KfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0hyZWYKICogQHJlc3RyaWN0IEEKICogQHByaW9yaXR5IDk5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYW4gaHJlZiBhdHRyaWJ1dGUgd2lsbAogKiBtYWtlIHRoZSBsaW5rIGdvIHRvIHRoZSB3cm9uZyBVUkwgaWYgdGhlIHVzZXIgY2xpY2tzIGl0IGJlZm9yZQogKiBBbmd1bGFyIGhhcyBhIGNoYW5jZSB0byByZXBsYWNlIHRoZSBge3toYXNofX1gIG1hcmt1cCB3aXRoIGl0cwogKiB2YWx1ZS4gVW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgbWFya3VwIHRoZSBsaW5rIHdpbGwgYmUgYnJva2VuCiAqIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICoKICogVGhlIGBuZ0hyZWZgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogKgogKiBUaGUgd3Jvbmcgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogKiBgYGAKICoKICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxhIG5nLWhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogKiBgYGAKICoKICogQGVsZW1lbnQgQQogKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ0hyZWYgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgdmFyaW91cyBjb21iaW5hdGlvbnMgb2YgYGhyZWZgLCBgbmctaHJlZmAgYW5kIGBuZy1jbGlja2AgYXR0cmlidXRlcwogKiBpbiBsaW5rcyBhbmQgdGhlaXIgZGlmZmVyZW50IGJlaGF2aW9yczoKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8aW5wdXQgbmctbW9kZWw9InZhbHVlIiAvPjxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTIiIGhyZWY9IiIgbmctY2xpY2s9InZhbHVlID0gMiI+bGluayAyPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTMiIG5nLWhyZWY9Ii97eycxMjMnfX0iPmxpbmsgMzwvYT4gKGxpbmssIHJlbG9hZCEpPGJyIC8+CiAgICAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTUiIG5hbWU9Inh4eCIgbmctY2xpY2s9InZhbHVlID0gNSI+YW5jaG9yPC9hPiAobm8gbGluayk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay02IiBuZy1ocmVmPSJ7e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgbG9jYXRpb24pCiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiB3aXRob3V0IHZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTEnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzEnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTEnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUoJycpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay0yJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0yJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKCcnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGFuZCBjaGFuZ2UgdXJsIHdoZW4gbmctaHJlZiBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTMnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvTWF0Y2goL1wvMTIzJC8pOwoKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstMycpKS5jbGljaygpOwoKICAgICAgICAgIC8vIEF0IHRoaXMgcG9pbnQsIHdlIG5hdmlnYXRlIGF3YXkgZnJvbSBhbiBBbmd1bGFyIHBhZ2UsIHNvIHdlIG5lZWQKICAgICAgICAgIC8vIHRvIHVzZSBicm93c2VyLmRyaXZlciB0byBnZXQgdGhlIGJhc2Ugd2ViZHJpdmVyLgoKICAgICAgICAgIGJyb3dzZXIud2FpdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXIuZHJpdmVyLmdldEN1cnJlbnRVcmwoKS50aGVuKGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgIHJldHVybiB1cmwubWF0Y2goL1wvMTIzJC8pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIDEwMDAsICdwYWdlIHNob3VsZCBuYXZpZ2F0ZSB0byAvMTIzJyk7CiAgICAgICAgfSk7CgogICAgICAgIHhpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstNCcpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9FcXVhbCgnNCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmstNCcpKS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTUnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzUnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTUnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUobnVsbCk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgb25seSBjaGFuZ2UgdXJsIHdoZW4gb25seSBuZy1ocmVmJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5jbGVhcigpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuc2VuZEtleXMoJzYnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTYnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvTWF0Y2goL1wvNiQvKTsKCiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTYnKSkuY2xpY2soKTsKCiAgICAgICAgICAvLyBBdCB0aGlzIHBvaW50LCB3ZSBuYXZpZ2F0ZSBhd2F5IGZyb20gYW4gQW5ndWxhciBwYWdlLCBzbyB3ZSBuZWVkCiAgICAgICAgICAvLyB0byB1c2UgYnJvd3Nlci5kcml2ZXIgdG8gZ2V0IHRoZSBiYXNlIHdlYmRyaXZlci4KICAgICAgICAgIGJyb3dzZXIud2FpdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXIuZHJpdmVyLmdldEN1cnJlbnRVcmwoKS50aGVuKGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgIHJldHVybiB1cmwubWF0Y2goL1wvNiQvKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCAxMDAwLCAncGFnZSBzaG91bGQgbmF2aWdhdGUgdG8gLzYnKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU3JjCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSA5OQogKgogKiBAZGVzY3JpcHRpb24KICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGEgYHNyY2AgYXR0cmlidXRlIGRvZXNuJ3QKICogd29yayByaWdodDogVGhlIGJyb3dzZXIgd2lsbCBmZXRjaCBmcm9tIHRoZSBVUkwgd2l0aCB0aGUgbGl0ZXJhbAogKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICogYHt7aGFzaH19YC4gVGhlIGBuZ1NyY2AgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAqCiAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAqIGBgYGh0bWwKICogPGltZyBzcmM9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogKiBgYGAKICoKICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxpbWcgbmctc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogYGBgCiAqCiAqIEBlbGVtZW50IElNRwogKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ1NyYyBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTcmNzZXQKICogQHJlc3RyaWN0IEEKICogQHByaW9yaXR5IDk5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYSBgc3Jjc2V0YCBhdHRyaWJ1dGUgZG9lc24ndAogKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAqIHRleHQgYHt7aGFzaH19YCB1bnRpbCBBbmd1bGFyIHJlcGxhY2VzIHRoZSBleHByZXNzaW9uIGluc2lkZQogKiBge3toYXNofX1gLiBUaGUgYG5nU3Jjc2V0YCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICoKICogVGhlIGJ1Z2d5IHdheSB0byB3cml0ZSBpdDoKICogYGBgaHRtbAogKiA8aW1nIHNyY3NldD0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19IDJ4Ii8+CiAqIGBgYAogKgogKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAqIGBgYGh0bWwKICogPGltZyBuZy1zcmNzZXQ9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSAyeCIvPgogKiBgYGAKICoKICogQGVsZW1lbnQgSU1HCiAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nU3Jjc2V0IGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0Rpc2FibGVkCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIFRoZSBmb2xsb3dpbmcgbWFya3VwIHdpbGwgbWFrZSB0aGUgYnV0dG9uIGVuYWJsZWQgb24gQ2hyb21lL0ZpcmVmb3ggYnV0IG5vdCBvbiBJRTggYW5kIG9sZGVyIElFczoKICogYGBgaHRtbAogKiA8ZGl2IG5nLWluaXQ9InNjb3BlID0geyBpc0Rpc2FibGVkOiBmYWxzZSB9Ij4KICogIDxidXR0b24gZGlzYWJsZWQ9Int7c2NvcGUuaXNEaXNhYmxlZH19Ij5EaXNhYmxlZDwvYnV0dG9uPgogKiA8L2Rpdj4KICogYGBgCiAqCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIGRpc2FibGVkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICogVGhlIGBuZ0Rpc2FibGVkYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBkaXNhYmxlZGAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgYnV0dG9uJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJ2J1dHRvbicpKS5nZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnY2hlY2tlZCcpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCdidXR0b24nKSkuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICoKICogQGVsZW1lbnQgSU5QVVQKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0Rpc2FibGVkIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJkaXNhYmxlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDaGVja2VkCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIGNoZWNrZWQuIChUaGVpciBwcmVzZW5jZSBtZWFucyB0cnVlIGFuZCB0aGVpciBhYnNlbmNlIG1lYW5zIGZhbHNlLikKICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICogYmluZGluZyBpbmZvcm1hdGlvbiB3b3VsZCBiZSBsb3N0IHdoZW4gdGhlIGJyb3dzZXIgcmVtb3ZlcyB0aGUgYXR0cmlidXRlLgogKiBUaGUgYG5nQ2hlY2tlZGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgY2hlY2tlZGAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJtYXN0ZXIiPjxici8+CiAgICAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGJvdGggY2hlY2tCb3hlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2NoZWNrU2xhdmUnKSkuZ2V0QXR0cmlidXRlKCdjaGVja2VkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnbWFzdGVyJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY2hlY2tTbGF2ZScpKS5nZXRBdHRyaWJ1dGUoJ2NoZWNrZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqCiAqIEBlbGVtZW50IElOUFVUCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDaGVja2VkIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJjaGVja2VkIiB3aWxsIGJlIHNldCBvbiB0aGUgZWxlbWVudAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1JlYWRvbmx5CiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIHJlYWRvbmx5LiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICogVGhlIGBuZ1JlYWRvbmx5YCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGByZWFkb25seWAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICBDaGVjayBtZSB0byBtYWtlIHRleHQgcmVhZG9ubHk6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLXJlYWRvbmx5PSJjaGVja2VkIiB2YWx1ZT0iSSdtIEFuZ3VsYXIiLz4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICBpdCgnc2hvdWxkIHRvZ2dsZSByZWFkb25seSBhdHRyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJ1t0eXBlPSJ0ZXh0Il0nKSkuZ2V0QXR0cmlidXRlKCdyZWFkb25seScpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnW3R5cGU9InRleHQiXScpKS5nZXRBdHRyaWJ1dGUoJ3JlYWRvbmx5JykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKgogKiBAZWxlbWVudCBJTlBVVAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nUmVhZG9ubHkgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSwKICogICAgIHRoZW4gc3BlY2lhbCBhdHRyaWJ1dGUgInJlYWRvbmx5IiB3aWxsIGJlIHNldCBvbiB0aGUgZWxlbWVudAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1NlbGVjdGVkCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIHNlbGVjdGVkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICogVGhlIGBuZ1NlbGVjdGVkYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBzZWxlY3RlZGAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICBDaGVjayBtZSB0byBzZWxlY3Q6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InNlbGVjdGVkIj48YnIvPgogICAgICAgIDxzZWxlY3Q+CiAgICAgICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbiBpZD0iZ3JlZXQiIG5nLXNlbGVjdGVkPSJzZWxlY3RlZCI+R3JlZXRpbmdzITwvb3B0aW9uPgogICAgICAgIDwvc2VsZWN0PgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgc2VsZWN0IEdyZWV0aW5ncyEnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdncmVldCcpKS5nZXRBdHRyaWJ1dGUoJ3NlbGVjdGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc2VsZWN0ZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdncmVldCcpKS5nZXRBdHRyaWJ1dGUoJ3NlbGVjdGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKgogKiBAZWxlbWVudCBPUFRJT04KICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1NlbGVjdGVkIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJzZWxlY3RlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ09wZW4KICogQHJlc3RyaWN0IEEKICogQHByaW9yaXR5IDEwMAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIEhUTUwgc3BlY2lmaWNhdGlvbiBkb2VzIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSB2YWx1ZXMgb2YgYm9vbGVhbiBhdHRyaWJ1dGVzCiAqIHN1Y2ggYXMgb3Blbi4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAqIFRoZSBgbmdPcGVuYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBvcGVuYCBhdHRyaWJ1dGUuCiAqIFRoaXMgY29tcGxlbWVudGFyeSBkaXJlY3RpdmUgaXMgbm90IHJlbW92ZWQgYnkgdGhlIGJyb3dzZXIgYW5kIHNvIHByb3ZpZGVzCiAqIGEgcGVybWFuZW50IHJlbGlhYmxlIHBsYWNlIHRvIHN0b3JlIHRoZSBiaW5kaW5nIGluZm9ybWF0aW9uLgogKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIENoZWNrIG1lIGNoZWNrIG11bHRpcGxlOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJvcGVuIj48YnIvPgogICAgICAgICA8ZGV0YWlscyBpZD0iZGV0YWlscyIgbmctb3Blbj0ib3BlbiI+CiAgICAgICAgICAgIDxzdW1tYXJ5PlNob3cvSGlkZSBtZTwvc3VtbWFyeT4KICAgICAgICAgPC9kZXRhaWxzPgogICAgICAgPC9maWxlPgogICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgIGl0KCdzaG91bGQgdG9nZ2xlIG9wZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZGV0YWlscycpKS5nZXRBdHRyaWJ1dGUoJ29wZW4nKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnb3BlbicpKS5jbGljaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdkZXRhaWxzJykpLmdldEF0dHJpYnV0ZSgnb3BlbicpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgIH0pOwogICAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICoKICogQGVsZW1lbnQgREVUQUlMUwogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nT3BlbiBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAib3BlbiIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgp2YXIgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMgPSB7fTsKCgovLyBib29sZWFuIGF0dHJzIGFyZSBldmFsdWF0ZWQKZm9yRWFjaChCT09MRUFOX0FUVFIsIGZ1bmN0aW9uKHByb3BOYW1lLCBhdHRyTmFtZSkgewogIC8vIGJpbmRpbmcgdG8gbXVsdGlwbGUgaXMgbm90IHN1cHBvcnRlZAogIGlmIChwcm9wTmFtZSA9PSAibXVsdGlwbGUiKSByZXR1cm47CgogIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBwcmlvcml0eTogMTAwLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25vcm1hbGl6ZWRdLCBmdW5jdGlvbiBuZ0Jvb2xlYW5BdHRyV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgISF2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfTsKfSk7CgoKLy8gbmctc3JjLCBuZy1zcmNzZXQsIG5nLWhyZWYgYXJlIGludGVycG9sYXRlZApmb3JFYWNoKFsnc3JjJywgJ3NyY3NldCcsICdocmVmJ10sIGZ1bmN0aW9uKGF0dHJOYW1lKSB7CiAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHByaW9yaXR5OiA5OSwgLy8gaXQgbmVlZHMgdG8gcnVuIGFmdGVyIHRoZSBhdHRyaWJ1dGVzIGFyZSBpbnRlcnBvbGF0ZWQKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICB2YXIgcHJvcE5hbWUgPSBhdHRyTmFtZSwKICAgICAgICAgICAgbmFtZSA9IGF0dHJOYW1lOwoKICAgICAgICBpZiAoYXR0ck5hbWUgPT09ICdocmVmJyAmJgogICAgICAgICAgICB0b1N0cmluZy5jYWxsKGVsZW1lbnQucHJvcCgnaHJlZicpKSA9PT0gJ1tvYmplY3QgU1ZHQW5pbWF0ZWRTdHJpbmddJykgewogICAgICAgICAgbmFtZSA9ICd4bGlua0hyZWYnOwogICAgICAgICAgYXR0ci4kYXR0cltuYW1lXSA9ICd4bGluazpocmVmJzsKICAgICAgICAgIHByb3BOYW1lID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGF0dHIuJG9ic2VydmUobm9ybWFsaXplZCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICghdmFsdWUpCiAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIHZhbHVlKTsKCiAgICAgICAgICAvLyBvbiBJRSwgaWYgIm5nOnNyYyIgZGlyZWN0aXZlIGRlY2xhcmF0aW9uIGlzIHVzZWQgYW5kICJzcmMiIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAvLyB0aGVuIGNhbGxpbmcgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3NyYycsICdmb28nKSBkb2Vzbid0IGRvIGFueXRoaW5nLCBzbyB3ZSBuZWVkCiAgICAgICAgICAvLyB0byBzZXQgdGhlIHByb3BlcnR5IGFzIHdlbGwgdG8gYWNoaWV2ZSB0aGUgZGVzaXJlZCBlZmZlY3QuCiAgICAgICAgICAvLyB3ZSB1c2UgYXR0clthdHRyTmFtZV0gdmFsdWUgc2luY2UgJHNldCBjYW4gc2FuaXRpemUgdGhlIHVybC4KICAgICAgICAgIGlmIChtc2llICYmIHByb3BOYW1lKSBlbGVtZW50LnByb3AocHJvcE5hbWUsIGF0dHJbbmFtZV0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH07Cn0pOwoKLyogZ2xvYmFsIC1udWxsRm9ybUN0cmwgKi8KdmFyIG51bGxGb3JtQ3RybCA9IHsKICAkYWRkQ29udHJvbDogbm9vcCwKICAkcmVtb3ZlQ29udHJvbDogbm9vcCwKICAkc2V0VmFsaWRpdHk6IG5vb3AsCiAgJHNldERpcnR5OiBub29wLAogICRzZXRQcmlzdGluZTogbm9vcAp9OwoKLyoqCiAqIEBuZ2RvYyB0eXBlCiAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIKICoKICogQHByb3BlcnR5IHtib29sZWFufSAkcHJpc3RpbmUgVHJ1ZSBpZiB1c2VyIGhhcyBub3QgaW50ZXJhY3RlZCB3aXRoIHRoZSBmb3JtIHlldC4KICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybS4KICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiBhbGwgb2YgdGhlIGNvbnRhaW5pbmcgZm9ybXMgYW5kIGNvbnRyb2xzIGFyZSB2YWxpZC4KICogQHByb3BlcnR5IHtib29sZWFufSAkaW52YWxpZCBUcnVlIGlmIGF0IGxlYXN0IG9uZSBjb250YWluaW5nIGNvbnRyb2wgb3IgZm9ybSBpcyBpbnZhbGlkLgogKgogKiBAcHJvcGVydHkge09iamVjdH0gJGVycm9yIElzIGFuIG9iamVjdCBoYXNoLCBjb250YWluaW5nIHJlZmVyZW5jZXMgdG8gYWxsIGludmFsaWQgY29udHJvbHMgb3IKICogIGZvcm1zLCB3aGVyZToKICoKICogIC0ga2V5cyBhcmUgdmFsaWRhdGlvbiB0b2tlbnMgKGVycm9yIG5hbWVzKSwKICogIC0gdmFsdWVzIGFyZSBhcnJheXMgb2YgY29udHJvbHMgb3IgZm9ybXMgdGhhdCBhcmUgaW52YWxpZCBmb3IgZ2l2ZW4gZXJyb3IgbmFtZS4KICoKICoKICogIEJ1aWx0LWluIHZhbGlkYXRpb24gdG9rZW5zOgogKgogKiAgLSBgZW1haWxgCiAqICAtIGBtYXhgCiAqICAtIGBtYXhsZW5ndGhgCiAqICAtIGBtaW5gCiAqICAtIGBtaW5sZW5ndGhgCiAqICAtIGBudW1iZXJgCiAqICAtIGBwYXR0ZXJuYAogKiAgLSBgcmVxdWlyZWRgCiAqICAtIGB1cmxgCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBgRm9ybUNvbnRyb2xsZXJgIGtlZXBzIHRyYWNrIG9mIGFsbCBpdHMgY29udHJvbHMgYW5kIG5lc3RlZCBmb3JtcyBhcyB3ZWxsIGFzIHRoZSBzdGF0ZSBvZiB0aGVtLAogKiBzdWNoIGFzIGJlaW5nIHZhbGlkL2ludmFsaWQgb3IgZGlydHkvcHJpc3RpbmUuCiAqCiAqIEVhY2gge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGZvcm19IGRpcmVjdGl2ZSBjcmVhdGVzIGFuIGluc3RhbmNlCiAqIG9mIGBGb3JtQ29udHJvbGxlcmAuCiAqCiAqLwovL2Fza3MgZm9yICRzY29wZSB0byBmb29sIHRoZSBCQyBjb250cm9sbGVyIG1vZHVsZQpGb3JtQ29udHJvbGxlci4kaW5qZWN0ID0gWyckZWxlbWVudCcsICckYXR0cnMnLCAnJHNjb3BlJywgJyRhbmltYXRlJ107CmZ1bmN0aW9uIEZvcm1Db250cm9sbGVyKGVsZW1lbnQsIGF0dHJzLCAkc2NvcGUsICRhbmltYXRlKSB7CiAgdmFyIGZvcm0gPSB0aGlzLAogICAgICBwYXJlbnRGb3JtID0gZWxlbWVudC5wYXJlbnQoKS5jb250cm9sbGVyKCdmb3JtJykgfHwgbnVsbEZvcm1DdHJsLAogICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgIGVycm9ycyA9IGZvcm0uJGVycm9yID0ge30sCiAgICAgIGNvbnRyb2xzID0gW107CgogIC8vIGluaXQgc3RhdGUKICBmb3JtLiRuYW1lID0gYXR0cnMubmFtZSB8fCBhdHRycy5uZ0Zvcm07CiAgZm9ybS4kZGlydHkgPSBmYWxzZTsKICBmb3JtLiRwcmlzdGluZSA9IHRydWU7CiAgZm9ybS4kdmFsaWQgPSB0cnVlOwogIGZvcm0uJGludmFsaWQgPSBmYWxzZTsKCiAgcGFyZW50Rm9ybS4kYWRkQ29udHJvbChmb3JtKTsKCiAgLy8gU2V0dXAgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgY29udHJvbAogIGVsZW1lbnQuYWRkQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpOwogIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwoKICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogIGZ1bmN0aW9uIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQsIHZhbGlkYXRpb25FcnJvcktleSkgewogICAgdmFsaWRhdGlvbkVycm9yS2V5ID0gdmFsaWRhdGlvbkVycm9yS2V5ID8gJy0nICsgc25ha2VfY2FzZSh2YWxpZGF0aW9uRXJyb3JLZXksICctJykgOiAnJzsKICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIChpc1ZhbGlkID8gSU5WQUxJRF9DTEFTUyA6IFZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCAoaXNWYWxpZCA/IFZBTElEX0NMQVNTIDogSU5WQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJGFkZENvbnRyb2wKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVyIGEgY29udHJvbCB3aXRoIHRoZSBmb3JtLgogICAqCiAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgbGlua2VkLgogICAqLwogIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICAvLyBCcmVha2luZyBjaGFuZ2UgLSBiZWZvcmUsIGlucHV0cyB3aG9zZSBuYW1lIHdhcyAiaGFzT3duUHJvcGVydHkiIHdlcmUgcXVpZXRseSBpZ25vcmVkCiAgICAvLyBhbmQgbm90IGFkZGVkIHRvIHRoZSBzY29wZS4gIE5vdyB3ZSB0aHJvdyBhbiBlcnJvci4KICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KGNvbnRyb2wuJG5hbWUsICdpbnB1dCcpOwogICAgY29udHJvbHMucHVzaChjb250cm9sKTsKCiAgICBpZiAoY29udHJvbC4kbmFtZSkgewogICAgICBmb3JtW2NvbnRyb2wuJG5hbWVdID0gY29udHJvbDsKICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlciMkcmVtb3ZlQ29udHJvbAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGVyZWdpc3RlciBhIGNvbnRyb2wgZnJvbSB0aGUgZm9ybS4KICAgKgogICAqIElucHV0IGVsZW1lbnRzIHVzaW5nIG5nTW9kZWxDb250cm9sbGVyIGRvIHRoaXMgYXV0b21hdGljYWxseSB3aGVuIHRoZXkgYXJlIGRlc3Ryb3llZC4KICAgKi8KICBmb3JtLiRyZW1vdmVDb250cm9sID0gZnVuY3Rpb24oY29udHJvbCkgewogICAgaWYgKGNvbnRyb2wuJG5hbWUgJiYgZm9ybVtjb250cm9sLiRuYW1lXSA9PT0gY29udHJvbCkgewogICAgICBkZWxldGUgZm9ybVtjb250cm9sLiRuYW1lXTsKICAgIH0KICAgIGZvckVhY2goZXJyb3JzLCBmdW5jdGlvbihxdWV1ZSwgdmFsaWRhdGlvblRva2VuKSB7CiAgICAgIGZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgdHJ1ZSwgY29udHJvbCk7CiAgICB9KTsKCiAgICBhcnJheVJlbW92ZShjb250cm9scywgY29udHJvbCk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIHRoZSB2YWxpZGl0eSBvZiBhIGZvcm0gY29udHJvbC4KICAgKgogICAqIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gcGFyZW50IGZvcm1zLgogICAqLwogIGZvcm0uJHNldFZhbGlkaXR5ID0gZnVuY3Rpb24odmFsaWRhdGlvblRva2VuLCBpc1ZhbGlkLCBjb250cm9sKSB7CiAgICB2YXIgcXVldWUgPSBlcnJvcnNbdmFsaWRhdGlvblRva2VuXTsKCiAgICBpZiAoaXNWYWxpZCkgewogICAgICBpZiAocXVldWUpIHsKICAgICAgICBhcnJheVJlbW92ZShxdWV1ZSwgY29udHJvbCk7CiAgICAgICAgaWYgKCFxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgIGludmFsaWRDb3VudC0tOwogICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgICAgICAgIGZvcm0uJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBmYWxzZTsKICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUsIHZhbGlkYXRpb25Ub2tlbik7CiAgICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGZvcm0pOwogICAgICAgIH0KICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgIH0KICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgaWYgKGluY2x1ZGVzKHF1ZXVlLCBjb250cm9sKSkgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIGVycm9yc1t2YWxpZGF0aW9uVG9rZW5dID0gcXVldWUgPSBbXTsKICAgICAgICBpbnZhbGlkQ291bnQrKzsKICAgICAgICB0b2dnbGVWYWxpZENzcyhmYWxzZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIGZhbHNlLCBmb3JtKTsKICAgICAgfQogICAgICBxdWV1ZS5wdXNoKGNvbnRyb2wpOwoKICAgICAgZm9ybS4kdmFsaWQgPSBmYWxzZTsKICAgICAgZm9ybS4kaW52YWxpZCA9IHRydWU7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldERpcnR5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIHRoZSBmb3JtIHRvIGEgZGlydHkgc3RhdGUuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIGFkZCB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBmb3JtIHRvIGEgZGlydHkKICAgKiBzdGF0ZSAobmctZGlydHkgY2xhc3MpLiBUaGlzIG1ldGhvZCB3aWxsIGFsc28gcHJvcGFnYXRlIHRvIHBhcmVudCBmb3Jtcy4KICAgKi8KICBmb3JtLiRzZXREaXJ0eSA9IGZ1bmN0aW9uKCkgewogICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MpOwogICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgRElSVFlfQ0xBU1MpOwogICAgZm9ybS4kZGlydHkgPSB0cnVlOwogICAgZm9ybS4kcHJpc3RpbmUgPSBmYWxzZTsKICAgIHBhcmVudEZvcm0uJHNldERpcnR5KCk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFByaXN0aW5lCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIHRoZSBmb3JtIHRvIGl0cyBwcmlzdGluZSBzdGF0ZS4KICAgKgogICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgdG8gcmVtb3ZlIHRoZSAnbmctZGlydHknIGNsYXNzIGFuZCBzZXQgdGhlIGZvcm0gdG8gaXRzIHByaXN0aW5lCiAgICogc3RhdGUgKG5nLXByaXN0aW5lIGNsYXNzKS4gVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBhbGwgdGhlIGNvbnRyb2xzIGNvbnRhaW5lZAogICAqIGluIHRoaXMgZm9ybS4KICAgKgogICAqIFNldHRpbmcgYSBmb3JtIGJhY2sgdG8gYSBwcmlzdGluZSBzdGF0ZSBpcyBvZnRlbiB1c2VmdWwgd2hlbiB3ZSB3YW50IHRvICdyZXVzZScgYSBmb3JtIGFmdGVyCiAgICogc2F2aW5nIG9yIHJlc2V0dGluZyBpdC4KICAgKi8KICBmb3JtLiRzZXRQcmlzdGluZSA9IGZ1bmN0aW9uICgpIHsKICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsIFBSSVNUSU5FX0NMQVNTKTsKICAgIGZvcm0uJGRpcnR5ID0gZmFsc2U7CiAgICBmb3JtLiRwcmlzdGluZSA9IHRydWU7CiAgICBmb3JFYWNoKGNvbnRyb2xzLCBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgIGNvbnRyb2wuJHNldFByaXN0aW5lKCk7CiAgICB9KTsKICB9Owp9CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdGb3JtCiAqIEByZXN0cmljdCBFQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIE5lc3RhYmxlIGFsaWFzIG9mIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBgZm9ybWB9IGRpcmVjdGl2ZS4gSFRNTAogKiBkb2VzIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGZvcm0gZWxlbWVudHMuIEl0IGlzIHVzZWZ1bCB0byBuZXN0IGZvcm1zLCBmb3IgZXhhbXBsZSBpZiB0aGUgdmFsaWRpdHkgb2YgYQogKiBzdWItZ3JvdXAgb2YgY29udHJvbHMgbmVlZHMgdG8gYmUgZGV0ZXJtaW5lZC4KICoKICogTm90ZTogdGhlIHB1cnBvc2Ugb2YgYG5nRm9ybWAgaXMgdG8gZ3JvdXAgY29udHJvbHMsCiAqIGJ1dCBub3QgdG8gYmUgYSByZXBsYWNlbWVudCBmb3IgdGhlIGA8Zm9ybT5gIHRhZyB3aXRoIGFsbCBvZiBpdHMgY2FwYWJpbGl0aWVzCiAqIChlLmcuIHBvc3RpbmcgdG8gdGhlIHNlcnZlciwgLi4uKS4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBuZ0Zvcm18bmFtZSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogKgogKi8KCiAvKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmb3JtCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEaXJlY3RpdmUgdGhhdCBpbnN0YW50aWF0ZXMKICoge0BsaW5rIGZvcm0uRm9ybUNvbnRyb2xsZXIgRm9ybUNvbnRyb2xsZXJ9LgogKgogKiBJZiB0aGUgYG5hbWVgIGF0dHJpYnV0ZSBpcyBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgaXMgcHVibGlzaGVkIG9udG8gdGhlIGN1cnJlbnQgc2NvcGUgdW5kZXIKICogdGhpcyBuYW1lLgogKgogKiAjIEFsaWFzOiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0KICoKICogSW4gQW5ndWxhciBmb3JtcyBjYW4gYmUgbmVzdGVkLiBUaGlzIG1lYW5zIHRoYXQgdGhlIG91dGVyIGZvcm0gaXMgdmFsaWQgd2hlbiBhbGwgb2YgdGhlIGNoaWxkCiAqIGZvcm1zIGFyZSB2YWxpZCBhcyB3ZWxsLiBIb3dldmVyLCBicm93c2VycyBkbyBub3QgYWxsb3cgbmVzdGluZyBvZiBgPGZvcm0+YCBlbGVtZW50cywgc28KICogQW5ndWxhciBwcm92aWRlcyB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0gYG5nRm9ybWB9IGRpcmVjdGl2ZSB3aGljaCBiZWhhdmVzIGlkZW50aWNhbGx5IHRvCiAqIGA8Zm9ybT5gIGJ1dCBjYW4gYmUgbmVzdGVkLiAgVGhpcyBhbGxvd3MgeW91IHRvIGhhdmUgbmVzdGVkIGZvcm1zLCB3aGljaCBpcyB2ZXJ5IHVzZWZ1bCB3aGVuCiAqIHVzaW5nIEFuZ3VsYXIgdmFsaWRhdGlvbiBkaXJlY3RpdmVzIGluIGZvcm1zIHRoYXQgYXJlIGR5bmFtaWNhbGx5IGdlbmVyYXRlZCB1c2luZyB0aGUKICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBgbmdSZXBlYXRgfSBkaXJlY3RpdmUuIFNpbmNlIHlvdSBjYW5ub3QgZHluYW1pY2FsbHkgZ2VuZXJhdGUgdGhlIGBuYW1lYAogKiBhdHRyaWJ1dGUgb2YgaW5wdXQgZWxlbWVudHMgdXNpbmcgaW50ZXJwb2xhdGlvbiwgeW91IGhhdmUgdG8gd3JhcCBlYWNoIHNldCBvZiByZXBlYXRlZCBpbnB1dHMgaW4gYW4KICogYG5nRm9ybWAgZGlyZWN0aXZlIGFuZCBuZXN0IHRoZXNlIGluIGFuIG91dGVyIGBmb3JtYCBlbGVtZW50LgogKgogKgogKiAjIENTUyBjbGFzc2VzCiAqICAtIGBuZy12YWxpZGAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIHZhbGlkLgogKiAgLSBgbmctaW52YWxpZGAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIGludmFsaWQuCiAqICAtIGBuZy1wcmlzdGluZWAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIHByaXN0aW5lLgogKiAgLSBgbmctZGlydHlgIGlzIHNldCBpZiB0aGUgZm9ybSBpcyBkaXJ0eS4KICoKICogS2VlcCBpbiBtaW5kIHRoYXQgbmdBbmltYXRlIGNhbiBkZXRlY3QgZWFjaCBvZiB0aGVzZSBjbGFzc2VzIHdoZW4gYWRkZWQgYW5kIHJlbW92ZWQuCiAqCiAqCiAqICMgU3VibWl0dGluZyBhIGZvcm0gYW5kIHByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uCiAqCiAqIFNpbmNlIHRoZSByb2xlIG9mIGZvcm1zIGluIGNsaWVudC1zaWRlIEFuZ3VsYXIgYXBwbGljYXRpb25zIGlzIGRpZmZlcmVudCB0aGFuIGluIGNsYXNzaWNhbAogKiByb3VuZHRyaXAgYXBwcywgaXQgaXMgZGVzaXJhYmxlIGZvciB0aGUgYnJvd3NlciBub3QgdG8gdHJhbnNsYXRlIHRoZSBmb3JtIHN1Ym1pc3Npb24gaW50byBhIGZ1bGwKICogcGFnZSByZWxvYWQgdGhhdCBzZW5kcyB0aGUgZGF0YSB0byB0aGUgc2VydmVyLiBJbnN0ZWFkIHNvbWUgamF2YXNjcmlwdCBsb2dpYyBzaG91bGQgYmUgdHJpZ2dlcmVkCiAqIHRvIGhhbmRsZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGluIGFuIGFwcGxpY2F0aW9uLXNwZWNpZmljIHdheS4KICoKICogRm9yIHRoaXMgcmVhc29uLCBBbmd1bGFyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAoZm9ybSBzdWJtaXNzaW9uIHRvIHRoZSBzZXJ2ZXIpIHVubGVzcyB0aGUKICogYDxmb3JtPmAgZWxlbWVudCBoYXMgYW4gYGFjdGlvbmAgYXR0cmlidXRlIHNwZWNpZmllZC4KICoKICogWW91IGNhbiB1c2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcgdHdvIHdheXMgdG8gc3BlY2lmeSB3aGF0IGphdmFzY3JpcHQgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbgogKiBhIGZvcm0gaXMgc3VibWl0dGVkOgogKgogKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9IGRpcmVjdGl2ZSBvbiB0aGUgZm9ybSBlbGVtZW50CiAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9IGRpcmVjdGl2ZSBvbiB0aGUgZmlyc3QKICAqICBidXR0b24gb3IgaW5wdXQgZmllbGQgb2YgdHlwZSBzdWJtaXQgKGlucHV0W3R5cGU9c3VibWl0XSkKICoKICogVG8gcHJldmVudCBkb3VibGUgZXhlY3V0aW9uIG9mIHRoZSBoYW5kbGVyLCB1c2Ugb25seSBvbmUgb2YgdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9CiAqIG9yIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfSBkaXJlY3RpdmVzLgogKiBUaGlzIGlzIGJlY2F1c2Ugb2YgdGhlIGZvbGxvd2luZyBmb3JtIHN1Ym1pc3Npb24gcnVsZXMgaW4gdGhlIEhUTUwgc3BlY2lmaWNhdGlvbjoKICoKICogLSBJZiBhIGZvcm0gaGFzIG9ubHkgb25lIGlucHV0IGZpZWxkIHRoZW4gaGl0dGluZyBlbnRlciBpbiB0aGlzIGZpZWxkIHRyaWdnZXJzIGZvcm0gc3VibWl0CiAqIChgbmdTdWJtaXRgKQogKiAtIGlmIGEgZm9ybSBoYXMgMisgaW5wdXQgZmllbGRzIGFuZCBubyBidXR0b25zIG9yIGlucHV0W3R5cGU9c3VibWl0XSB0aGVuIGhpdHRpbmcgZW50ZXIKICogZG9lc24ndCB0cmlnZ2VyIHN1Ym1pdAogKiAtIGlmIGEgZm9ybSBoYXMgb25lIG9yIG1vcmUgaW5wdXQgZmllbGRzIGFuZCBvbmUgb3IgbW9yZSBidXR0b25zIG9yIGlucHV0W3R5cGU9c3VibWl0XSB0aGVuCiAqIGhpdHRpbmcgZW50ZXIgaW4gYW55IG9mIHRoZSBpbnB1dCBmaWVsZHMgd2lsbCB0cmlnZ2VyIHRoZSBjbGljayBoYW5kbGVyIG9uIHRoZSAqZmlyc3QqIGJ1dHRvbiBvcgogKiBpbnB1dFt0eXBlPXN1Ym1pdF0gKGBuZ0NsaWNrYCkgKmFuZCogYSBzdWJtaXQgaGFuZGxlciBvbiB0aGUgZW5jbG9zaW5nIGZvcm0gKGBuZ1N1Ym1pdGApCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogKgogKiAjIyBBbmltYXRpb24gSG9va3MKICoKICogQW5pbWF0aW9ucyBpbiBuZ0Zvcm0gYXJlIHRyaWdnZXJlZCB3aGVuIGFueSBvZiB0aGUgYXNzb2NpYXRlZCBDU1MgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIHJlbW92ZWQuCiAqIFRoZXNlIGNsYXNzZXMgYXJlOiBgLm5nLXByaXN0aW5lYCwgYC5uZy1kaXJ0eWAsIGAubmctaW52YWxpZGAgYW5kIGAubmctdmFsaWRgIGFzIHdlbGwgYXMgYW55CiAqIG90aGVyIHZhbGlkYXRpb25zIHRoYXQgYXJlIHBlcmZvcm1lZCB3aXRoaW4gdGhlIGZvcm0uIEFuaW1hdGlvbnMgaW4gbmdGb3JtIGFyZSBzaW1pbGFyIHRvIGhvdwogKiB0aGV5IHdvcmsgaW4gbmdDbGFzcyBhbmQgYW5pbWF0aW9ucyBjYW4gYmUgaG9va2VkIGludG8gdXNpbmcgQ1NTIHRyYW5zaXRpb25zLCBrZXlmcmFtZXMgYXMgd2VsbAogKiBhcyBKUyBhbmltYXRpb25zLgogKgogKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgYSBzaW1wbGUgd2F5IHRvIHV0aWxpemUgQ1NTIHRyYW5zaXRpb25zIHRvIHN0eWxlIGEgZm9ybSBlbGVtZW50CiAqIHRoYXQgaGFzIGJlZW4gcmVuZGVyZWQgYXMgaW52YWxpZCBhZnRlciBpdCBoYXMgYmVlbiB2YWxpZGF0ZWQ6CiAqCiAqIDxwcmU+CiAqIC8vYmUgc3VyZSB0byBpbmNsdWRlIG5nQW5pbWF0ZSBhcyBhIG1vZHVsZSB0byBob29rIGludG8gbW9yZQogKiAvL2FkdmFuY2VkIGFuaW1hdGlvbnMKICogLm15LWZvcm0gewogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiAgIGJhY2tncm91bmQ6IHdoaXRlOwogKiB9CiAqIC5teS1mb3JtLm5nLWludmFsaWQgewogKiAgIGJhY2tncm91bmQ6IHJlZDsKICogICBjb2xvcjp3aGl0ZTsKICogfQogKiA8L3ByZT4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSIgZml4QmFzZT0idHJ1ZSI+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlclR5cGUgPSAnZ3Vlc3QnOwogICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxzdHlsZT4KICAgICAgICAubXktZm9ybSB7CiAgICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgICB9CiAgICAgICAgLm15LWZvcm0ubmctaW52YWxpZCB7CiAgICAgICAgICBiYWNrZ3JvdW5kOiByZWQ7CiAgICAgICAgfQogICAgICAgPC9zdHlsZT4KICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCIgY2xhc3M9Im15LWZvcm0iPgogICAgICAgICB1c2VyVHlwZTogPGlucHV0IG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idXNlclR5cGUiIHJlcXVpcmVkPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgICAgIDx0dD51c2VyVHlwZSA9IHt7dXNlclR5cGV9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICAgICA8L2Zvcm0+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXNlclR5cGUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3VzZXJUeXBlJykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyVHlwZS5nZXRUZXh0KCkpLnRvQ29udGFpbignZ3Vlc3QnKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB1c2VyVHlwZSA9IGVsZW1lbnQoYnkuYmluZGluZygndXNlclR5cGUnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgdXNlcklucHV0ID0gZWxlbWVudChieS5tb2RlbCgndXNlclR5cGUnKSk7CgogICAgICAgICAgdXNlcklucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VySW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyVHlwZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3VzZXJUeXBlID0nKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKgogKi8KdmFyIGZvcm1EaXJlY3RpdmVGYWN0b3J5ID0gZnVuY3Rpb24oaXNOZ0Zvcm0pIHsKICByZXR1cm4gWyckdGltZW91dCcsIGZ1bmN0aW9uKCR0aW1lb3V0KSB7CiAgICB2YXIgZm9ybURpcmVjdGl2ZSA9IHsKICAgICAgbmFtZTogJ2Zvcm0nLAogICAgICByZXN0cmljdDogaXNOZ0Zvcm0gPyAnRUFDJyA6ICdFJywKICAgICAgY29udHJvbGxlcjogRm9ybUNvbnRyb2xsZXIsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBmb3JtRWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewogICAgICAgICAgICBpZiAoIWF0dHIuYWN0aW9uKSB7CiAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QgdXNlIGpxIGV2ZW50cyBiZWNhdXNlIGlmIGEgZm9ybSBpcyBkZXN0cm95ZWQgZHVyaW5nIHN1Ym1pc3Npb24gdGhlIGRlZmF1bHQKICAgICAgICAgICAgICAvLyBhY3Rpb24gaXMgbm90IHByZXZlbnRlZC4gc2VlICMxMjM4CiAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAvLyBJRSA5IGlzIG5vdCBhZmZlY3RlZCBiZWNhdXNlIGl0IGRvZXNuJ3QgZmlyZSBhIHN1Ym1pdCBldmVudCBhbmQgdHJ5IHRvIGRvIGEgZnVsbAogICAgICAgICAgICAgIC8vIHBhZ2UgcmVsb2FkIGlmIHRoZSBmb3JtIHdhcyBkZXN0cm95ZWQgYnkgc3VibWlzc2lvbiBvZiB0aGUgZm9ybSB2aWEgYSBjbGljayBoYW5kbGVyCiAgICAgICAgICAgICAgLy8gb24gYSBidXR0b24gaW4gdGhlIGZvcm0uIExvb2tzIGxpa2UgYW4gSUU5IHNwZWNpZmljIGJ1Zy4KICAgICAgICAgICAgICB2YXIgcHJldmVudERlZmF1bHRMaXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICAgICAgICAgICAgICA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgOiBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvLyBJRQogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihmb3JtRWxlbWVudFswXSwgJ3N1Ym1pdCcsIHByZXZlbnREZWZhdWx0TGlzdGVuZXIpOwoKICAgICAgICAgICAgICAvLyB1bnJlZ2lzdGVyIHRoZSBwcmV2ZW50RGVmYXVsdCBsaXN0ZW5lciBzbyB0aGF0IHdlIGRvbid0IG5vdCBsZWFrIG1lbW9yeSBidXQgaW4gYQogICAgICAgICAgICAgIC8vIHdheSB0aGF0IHdpbGwgYWNoaWV2ZSB0aGUgcHJldmVudGlvbiBvZiB0aGUgZGVmYXVsdCBhY3Rpb24uCiAgICAgICAgICAgICAgZm9ybUVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgcHJldmVudERlZmF1bHRMaXN0ZW5lcik7CiAgICAgICAgICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBwYXJlbnRGb3JtQ3RybCA9IGZvcm1FbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSwKICAgICAgICAgICAgICAgIGFsaWFzID0gYXR0ci5uYW1lIHx8IGF0dHIubmdGb3JtOwoKICAgICAgICAgICAgaWYgKGFsaWFzKSB7CiAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgY29udHJvbGxlciwgYWxpYXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJlbnRGb3JtQ3RybCkgewogICAgICAgICAgICAgIGZvcm1FbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcGFyZW50Rm9ybUN0cmwuJHJlbW92ZUNvbnRyb2woY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgdW5kZWZpbmVkLCBhbGlhcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBleHRlbmQoY29udHJvbGxlciwgbnVsbEZvcm1DdHJsKTsgLy9zdG9wIHByb3BhZ2F0aW5nIGNoaWxkIGRlc3RydWN0aW9uIGhhbmRsZXJzIHVwd2FyZHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIGZvcm1EaXJlY3RpdmU7CiAgfV07Cn07Cgp2YXIgZm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KCk7CnZhciBuZ0Zvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSh0cnVlKTsKCi8qIGdsb2JhbAoKICAgIC1WQUxJRF9DTEFTUywKICAgIC1JTlZBTElEX0NMQVNTLAogICAgLVBSSVNUSU5FX0NMQVNTLAogICAgLURJUlRZX0NMQVNTCiovCgp2YXIgVVJMX1JFR0VYUCA9IC9eKGZ0cHxodHRwfGh0dHBzKTpcL1wvKFx3Kzp7MCwxfVx3KkApPyhcUyspKDpbMC05XSspPyhcL3xcLyhbXHcjITouPys9JiVAIVwtXC9dKSk/JC87CnZhciBFTUFJTF9SRUdFWFAgPSAvXlthLXowLTkhIyQlJicqKy89P15fYHt8fX4uLV0rQFthLXowLTktXSsoXC5bYS16MC05LV0rKSokL2k7CnZhciBOVU1CRVJfUkVHRVhQID0gL15ccyooXC18XCspPyhcZCt8KFxkKihcLlxkKikpKVxzKiQvOwoKdmFyIGlucHV0VHlwZSA9IHsKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbdGV4dF0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFN0YW5kYXJkIEhUTUwgdGV4dCBpbnB1dCB3aXRoIGFuZ3VsYXIgZGF0YSBiaW5kaW5nLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAqICAgIG1pbmxlbmd0aC4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICogICAgbWF4bGVuZ3RoLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtuZ1RyaW09dHJ1ZV0gSWYgc2V0IHRvIGZhbHNlIEFuZ3VsYXIgd2lsbCBub3QgYXV0b21hdGljYWxseSB0cmltIHRoZSBpbnB1dC4KICAgKgogICAqIEBleGFtcGxlCiAgICAgIDxleGFtcGxlIG5hbWU9InRleHQtaW5wdXQtZGlyZWN0aXZlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnZ3Vlc3QnOwogICAgICAgICAgICAgJHNjb3BlLndvcmQgPSAvXlxzKlx3KlxzKiQvOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgU2luZ2xlIHdvcmQ6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZy1wYXR0ZXJuPSJ3b3JkIiByZXF1aXJlZCBuZy10cmltPSJmYWxzZSI+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucGF0dGVybiI+CiAgICAgICAgICAgICBTaW5nbGUgd29yZCBvbmx5ITwvc3Bhbj4KCiAgICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgdmFyIHRleHQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwoKICAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvQ29udGFpbignZ3Vlc3QnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0VxdWFsKCd0ZXh0ID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG11bHRpIHdvcmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJ2hlbGxvIHdvcmxkJyk7CgogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgKi8KICAndGV4dCc6IHRleHRJbnB1dFR5cGUsCgoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFtudW1iZXJdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUZXh0IGlucHV0IHdpdGggbnVtYmVyIHZhbGlkYXRpb24gYW5kIHRyYW5zZm9ybWF0aW9uLiBTZXRzIHRoZSBgbnVtYmVyYCB2YWxpZGF0aW9uCiAgICogZXJyb3IgaWYgbm90IGEgdmFsaWQgbnVtYmVyLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG1pbiBTZXRzIHRoZSBgbWluYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBsZXNzIHRoYW4gYG1pbmAuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBtYXggU2V0cyB0aGUgYG1heGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgZ3JlYXRlciB0aGFuIGBtYXhgLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICogICAgbWlubGVuZ3RoLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgKiAgICBtYXhsZW5ndGguCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJudW1iZXItaW5wdXQtZGlyZWN0aXZlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnZhbHVlID0gMTI7CiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICBOdW1iZXI6IDxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgbWluPSIwIiBtYXg9Ijk5IiByZXF1aXJlZD4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5udW1iZXIiPgogICAgICAgICAgICAgTm90IHZhbGlkIG51bWJlciE8L3NwYW4+CiAgICAgICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZX19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICB2YXIgdmFsdWUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlJykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvQ29udGFpbignMTInKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwogICAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnMTIzJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ251bWJlcic6IG51bWJlcklucHV0VHlwZSwKCgogIC8qKgogICAqIEBuZ2RvYyBpbnB1dAogICAqIEBuYW1lIGlucHV0W3VybF0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRleHQgaW5wdXQgd2l0aCBVUkwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYHVybGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIGNvbnRlbnQgaXMgbm90IGEKICAgKiB2YWxpZCBVUkwuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICogICAgbWlubGVuZ3RoLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgKiAgICBtYXhsZW5ndGguCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJ1cmwtaW5wdXQtZGlyZWN0aXZlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnaHR0cDovL2dvb2dsZS5jb20nOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgVVJMOiA8aW5wdXQgdHlwZT0idXJsIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiIHJlcXVpcmVkPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnVybCI+CiAgICAgICAgICAgICBOb3QgdmFsaWQgdXJsITwvc3Bhbj4KICAgICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci51cmwgPSB7eyEhbXlGb3JtLiRlcnJvci51cmx9fTwvdHQ+PGJyLz4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICB2YXIgdGV4dCA9IGVsZW1lbnQoYnkuYmluZGluZygndGV4dCcpKTsKICAgICAgICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKICAgICAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RleHQnKSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9Db250YWluKCdodHRwOi8vZ29vZ2xlLmNvbScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnJyk7CgogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvRXF1YWwoJ3RleHQgPScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IHVybCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnYm94Jyk7CgogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgKi8KICAndXJsJzogdXJsSW5wdXRUeXBlLAoKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbZW1haWxdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUZXh0IGlucHV0IHdpdGggZW1haWwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYGVtYWlsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiBub3QgYSB2YWxpZCBlbWFpbAogICAqIGFkZHJlc3MuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICogICAgbWlubGVuZ3RoLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgKiAgICBtYXhsZW5ndGguCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJlbWFpbC1pbnB1dC1kaXJlY3RpdmUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdtZUBleGFtcGxlLmNvbSc7CiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgICAgRW1haWw6IDxpbnB1dCB0eXBlPSJlbWFpbCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5lbWFpbCI+CiAgICAgICAgICAgICAgIE5vdCB2YWxpZCBlbWFpbCE8L3NwYW4+CiAgICAgICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IuZW1haWwgPSB7eyEhbXlGb3JtLiRlcnJvci5lbWFpbH19PC90dD48YnIvPgogICAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgdmFyIHRleHQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwoKICAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvQ29udGFpbignbWVAZXhhbXBsZS5jb20nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvRXF1YWwoJ3RleHQgPScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IGVtYWlsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCd4eHgnKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAqLwogICdlbWFpbCc6IGVtYWlsSW5wdXRUeXBlLAoKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbcmFkaW9dCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBIVE1MIHJhZGlvIGJ1dHRvbi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKiBAcGFyYW0ge3N0cmluZ30gbmdWYWx1ZSBBbmd1bGFyIGV4cHJlc3Npb24gd2hpY2ggc2V0cyB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkCiAgICogICAgYmUgc2V0IHdoZW4gc2VsZWN0ZWQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJyYWRpby1pbnB1dC1kaXJlY3RpdmUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUuY29sb3IgPSAnYmx1ZSc7CiAgICAgICAgICAgICAkc2NvcGUuc3BlY2lhbFZhbHVlID0gewogICAgICAgICAgICAgICAiaWQiOiAiMTIzNDUiLAogICAgICAgICAgICAgICAidmFsdWUiOiAiZ3JlZW4iCiAgICAgICAgICAgICB9OwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJyZWQiPiAgUmVkIDxici8+CiAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIG5nLXZhbHVlPSJzcGVjaWFsVmFsdWUiPiBHcmVlbiA8YnIvPgogICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0iYmx1ZSI+IEJsdWUgPGJyLz4KICAgICAgICAgICA8dHQ+Y29sb3IgPSB7e2NvbG9yIHwganNvbn19PC90dD48YnIvPgogICAgICAgICAgPC9mb3JtPgogICAgICAgICAgTm90ZSB0aGF0IGBuZy12YWx1ZT0ic3BlY2lhbFZhbHVlImAgc2V0cyByYWRpbyBpdGVtJ3MgdmFsdWUgdG8gYmUgdGhlIHZhbHVlIG9mIGAkc2NvcGUuc3BlY2lhbFZhbHVlYC4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29sb3IgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2NvbG9yJykpOwoKICAgICAgICAgICAgZXhwZWN0KGNvbG9yLmdldFRleHQoKSkudG9Db250YWluKCdibHVlJyk7CgogICAgICAgICAgICBlbGVtZW50LmFsbChieS5tb2RlbCgnY29sb3InKSkuZ2V0KDApLmNsaWNrKCk7CgogICAgICAgICAgICBleHBlY3QoY29sb3IuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3JlZCcpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ3JhZGlvJzogcmFkaW9JbnB1dFR5cGUsCgoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFtjaGVja2JveF0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEhUTUwgY2hlY2tib3guCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0iY2hlY2tib3gtaW5wdXQtZGlyZWN0aXZlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnZhbHVlMSA9IHRydWU7CiAgICAgICAgICAgICAkc2NvcGUudmFsdWUyID0gJ1lFUycKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgIFZhbHVlMTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0idmFsdWUxIj4gPGJyLz4KICAgICAgICAgICBWYWx1ZTI6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMiIKICAgICAgICAgICAgICAgICAgICAgICAgICBuZy10cnVlLXZhbHVlPSJZRVMiIG5nLWZhbHNlLXZhbHVlPSJOTyI+IDxici8+CiAgICAgICAgICAgPHR0PnZhbHVlMSA9IHt7dmFsdWUxfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0PnZhbHVlMiA9IHt7dmFsdWUyfX08L3R0Pjxici8+CiAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlMSA9IGVsZW1lbnQoYnkuYmluZGluZygndmFsdWUxJykpOwogICAgICAgICAgICB2YXIgdmFsdWUyID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZTInKSk7CgogICAgICAgICAgICBleHBlY3QodmFsdWUxLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZTIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ1lFUycpOwoKICAgICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUxJykpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlMicpKS5jbGljaygpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMS5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMi5nZXRUZXh0KCkpLnRvQ29udGFpbignTk8nKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAqLwogICdjaGVja2JveCc6IGNoZWNrYm94SW5wdXRUeXBlLAoKICAnaGlkZGVuJzogbm9vcCwKICAnYnV0dG9uJzogbm9vcCwKICAnc3VibWl0Jzogbm9vcCwKICAncmVzZXQnOiBub29wLAogICdmaWxlJzogbm9vcAp9OwoKLy8gQSBoZWxwZXIgZnVuY3Rpb24gdG8gY2FsbCAkc2V0VmFsaWRpdHkgYW5kIHJldHVybiB0aGUgdmFsdWUgLyB1bmRlZmluZWQsCi8vIGEgcGF0dGVybiB0aGF0IGlzIHJlcGVhdGVkIGEgbG90IGluIHRoZSBpbnB1dCB2YWxpZGF0aW9uIGxvZ2ljLgpmdW5jdGlvbiB2YWxpZGF0ZShjdHJsLCB2YWxpZGF0b3JOYW1lLCB2YWxpZGl0eSwgdmFsdWUpewogIGN0cmwuJHNldFZhbGlkaXR5KHZhbGlkYXRvck5hbWUsIHZhbGlkaXR5KTsKICByZXR1cm4gdmFsaWRpdHkgPyB2YWx1ZSA6IHVuZGVmaW5lZDsKfQoKCmZ1bmN0aW9uIGFkZE5hdGl2ZUh0bWw1VmFsaWRhdG9ycyhjdHJsLCB2YWxpZGF0b3JOYW1lLCBlbGVtZW50KSB7CiAgdmFyIHZhbGlkaXR5ID0gZWxlbWVudC5wcm9wKCd2YWxpZGl0eScpOwogIGlmIChpc09iamVjdCh2YWxpZGl0eSkpIHsKICAgIHZhciB2YWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAvLyBEb24ndCBvdmVyd3JpdGUgcHJldmlvdXMgdmFsaWRhdGlvbiwgZG9uJ3QgY29uc2lkZXIgdmFsdWVNaXNzaW5nIHRvIGFwcGx5IChuZy1yZXF1aXJlZCBjYW4KICAgICAgLy8gcGVyZm9ybSB0aGUgcmVxdWlyZWQgdmFsaWRhdGlvbikKICAgICAgaWYgKCFjdHJsLiRlcnJvclt2YWxpZGF0b3JOYW1lXSAmJiAodmFsaWRpdHkuYmFkSW5wdXQgfHwgdmFsaWRpdHkuY3VzdG9tRXJyb3IgfHwKICAgICAgICAgIHZhbGlkaXR5LnR5cGVNaXNtYXRjaCkgJiYgIXZhbGlkaXR5LnZhbHVlTWlzc2luZykgewogICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KHZhbGlkYXRvck5hbWUsIGZhbHNlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICAgIGN0cmwuJHBhcnNlcnMucHVzaCh2YWxpZGF0b3IpOwogIH0KfQoKZnVuY3Rpb24gdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgdmFyIHZhbGlkaXR5ID0gZWxlbWVudC5wcm9wKCd2YWxpZGl0eScpOwogIHZhciBwbGFjZWhvbGRlciA9IGVsZW1lbnRbMF0ucGxhY2Vob2xkZXIsIG5vZXZlbnQgPSB7fTsKCiAgLy8gSW4gY29tcG9zaXRpb24gbW9kZSwgdXNlcnMgYXJlIHN0aWxsIGlucHV0aW5nIGludGVybWVkaWF0ZSB0ZXh0IGJ1ZmZlciwKICAvLyBob2xkIHRoZSBsaXN0ZW5lciB1bnRpbCBjb21wb3NpdGlvbiBpcyBkb25lLgogIC8vIE1vcmUgYWJvdXQgY29tcG9zaXRpb24gZXZlbnRzOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvQ29tcG9zaXRpb25FdmVudAogIGlmICghJHNuaWZmZXIuYW5kcm9pZCkgewogICAgdmFyIGNvbXBvc2luZyA9IGZhbHNlOwoKICAgIGVsZW1lbnQub24oJ2NvbXBvc2l0aW9uc3RhcnQnLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgIGNvbXBvc2luZyA9IHRydWU7CiAgICB9KTsKCiAgICBlbGVtZW50Lm9uKCdjb21wb3NpdGlvbmVuZCcsIGZ1bmN0aW9uKCkgewogICAgICBjb21wb3NpbmcgPSBmYWxzZTsKICAgICAgbGlzdGVuZXIoKTsKICAgIH0pOwogIH0KCiAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24oZXYpIHsKICAgIGlmIChjb21wb3NpbmcpIHJldHVybjsKICAgIHZhciB2YWx1ZSA9IGVsZW1lbnQudmFsKCk7CgogICAgLy8gSUUgKDExIGFuZCB1bmRlcikgc2VlbSB0byBlbWl0IGFuICdpbnB1dCcgZXZlbnQgaWYgdGhlIHBsYWNlaG9sZGVyIHZhbHVlIGNoYW5nZXMuCiAgICAvLyBXZSBkb24ndCB3YW50IHRvIGRpcnR5IHRoZSB2YWx1ZSB3aGVuIHRoaXMgaGFwcGVucywgc28gd2UgYWJvcnQgaGVyZS4gVW5mb3J0dW5hdGVseSwKICAgIC8vIElFIGFsc28gc2VuZHMgaW5wdXQgZXZlbnRzIGZvciBvdGhlciBub24taW5wdXQtcmVsYXRlZCB0aGluZ3MsIChzdWNoIGFzIGZvY3VzaW5nIG9uIGEKICAgIC8vIGZvcm0gY29udHJvbCksIHNvIHRoaXMgY2hhbmdlIGlzIG5vdCBlbnRpcmVseSBlbm91Z2ggdG8gc29sdmUgdGhpcy4KICAgIGlmIChtc2llICYmIChldiB8fCBub2V2ZW50KS50eXBlID09PSAnaW5wdXQnICYmIGVsZW1lbnRbMF0ucGxhY2Vob2xkZXIgIT09IHBsYWNlaG9sZGVyKSB7CiAgICAgIHBsYWNlaG9sZGVyID0gZWxlbWVudFswXS5wbGFjZWhvbGRlcjsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIEJ5IGRlZmF1bHQgd2Ugd2lsbCB0cmltIHRoZSB2YWx1ZQogICAgLy8gSWYgdGhlIGF0dHJpYnV0ZSBuZy10cmltIGV4aXN0cyB3ZSB3aWxsIGF2b2lkIHRyaW1taW5nCiAgICAvLyBlLmcuIDxpbnB1dCBuZy1tb2RlbD0iZm9vIiBuZy10cmltPSJmYWxzZSI+CiAgICBpZiAodG9Cb29sZWFuKGF0dHIubmdUcmltIHx8ICdUJykpIHsKICAgICAgdmFsdWUgPSB0cmltKHZhbHVlKTsKICAgIH0KCiAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSB8fAogICAgICAgIC8vIElmIHRoZSB2YWx1ZSBpcyBzdGlsbCBlbXB0eS9mYWxzeSwgYW5kIHRoZXJlIGlzIG5vIGByZXF1aXJlZGAgZXJyb3IsIHJ1biB2YWxpZGF0b3JzCiAgICAgICAgLy8gYWdhaW4uIFRoaXMgZW5hYmxlcyBIVE1MNSBjb25zdHJhaW50IHZhbGlkYXRpb24gZXJyb3JzIHRvIGFmZmVjdCBBbmd1bGFyIHZhbGlkYXRpb24KICAgICAgICAvLyBldmVuIHdoZW4gdGhlIGZpcnN0IGNoYXJhY3RlciBlbnRlcmVkIGNhdXNlcyBhbiBlcnJvci4KICAgICAgICAodmFsaWRpdHkgJiYgdmFsdWUgPT09ICcnICYmICF2YWxpZGl0eS52YWx1ZU1pc3NpbmcpKSB7CiAgICAgIGlmIChzY29wZS4kJHBoYXNlKSB7CiAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gaWYgdGhlIGJyb3dzZXIgZG9lcyBzdXBwb3J0ICJpbnB1dCIgZXZlbnQsIHdlIGFyZSBmaW5lIC0gZXhjZXB0IG9uIElFOSB3aGljaCBkb2Vzbid0IGZpcmUgdGhlCiAgLy8gaW5wdXQgZXZlbnQgb24gYmFja3NwYWNlLCBkZWxldGUgb3IgY3V0CiAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdpbnB1dCcpKSB7CiAgICBlbGVtZW50Lm9uKCdpbnB1dCcsIGxpc3RlbmVyKTsKICB9IGVsc2UgewogICAgdmFyIHRpbWVvdXQ7CgogICAgdmFyIGRlZmVyTGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgdGltZW91dCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIGVsZW1lbnQub24oJ2tleWRvd24nLCBmdW5jdGlvbihldmVudCkgewogICAgICB2YXIga2V5ID0gZXZlbnQua2V5Q29kZTsKCiAgICAgIC8vIGlnbm9yZQogICAgICAvLyAgICBjb21tYW5kICAgICAgICAgICAgbW9kaWZpZXJzICAgICAgICAgICAgICAgICAgIGFycm93cwogICAgICBpZiAoa2V5ID09PSA5MSB8fCAoMTUgPCBrZXkgJiYga2V5IDwgMTkpIHx8ICgzNyA8PSBrZXkgJiYga2V5IDw9IDQwKSkgcmV0dXJuOwoKICAgICAgZGVmZXJMaXN0ZW5lcigpOwogICAgfSk7CgogICAgLy8gaWYgdXNlciBtb2RpZmllcyBpbnB1dCB2YWx1ZSB1c2luZyBjb250ZXh0IG1lbnUgaW4gSUUsIHdlIG5lZWQgInBhc3RlIiBhbmQgImN1dCIgZXZlbnRzIHRvIGNhdGNoIGl0CiAgICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ3Bhc3RlJykpIHsKICAgICAgZWxlbWVudC5vbigncGFzdGUgY3V0JywgZGVmZXJMaXN0ZW5lcik7CiAgICB9CiAgfQoKICAvLyBpZiB1c2VyIHBhc3RlIGludG8gaW5wdXQgdXNpbmcgbW91c2Ugb24gb2xkZXIgYnJvd3NlcgogIC8vIG9yIGZvcm0gYXV0b2NvbXBsZXRlIG9uIG5ld2VyIGJyb3dzZXIsIHdlIG5lZWQgImNoYW5nZSIgZXZlbnQgdG8gY2F0Y2ggaXQKICBlbGVtZW50Lm9uKCdjaGFuZ2UnLCBsaXN0ZW5lcik7CgogIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgZWxlbWVudC52YWwoY3RybC4kaXNFbXB0eShjdHJsLiR2aWV3VmFsdWUpID8gJycgOiBjdHJsLiR2aWV3VmFsdWUpOwogIH07CgogIC8vIHBhdHRlcm4gdmFsaWRhdG9yCiAgdmFyIHBhdHRlcm4gPSBhdHRyLm5nUGF0dGVybiwKICAgICAgcGF0dGVyblZhbGlkYXRvciwKICAgICAgbWF0Y2g7CgogIGlmIChwYXR0ZXJuKSB7CiAgICB2YXIgdmFsaWRhdGVSZWdleCA9IGZ1bmN0aW9uKHJlZ2V4cCwgdmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICdwYXR0ZXJuJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgcmVnZXhwLnRlc3QodmFsdWUpLCB2YWx1ZSk7CiAgICB9OwogICAgbWF0Y2ggPSBwYXR0ZXJuLm1hdGNoKC9eXC8oLiopXC8oW2dpbV0qKSQvKTsKICAgIGlmIChtYXRjaCkgewogICAgICBwYXR0ZXJuID0gbmV3IFJlZ0V4cChtYXRjaFsxXSwgbWF0Y2hbMl0pOwogICAgICBwYXR0ZXJuVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsaWRhdGVSZWdleChwYXR0ZXJuLCB2YWx1ZSk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBwYXR0ZXJuVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgcGF0dGVybk9iaiA9IHNjb3BlLiRldmFsKHBhdHRlcm4pOwoKICAgICAgICBpZiAoIXBhdHRlcm5PYmogfHwgIXBhdHRlcm5PYmoudGVzdCkgewogICAgICAgICAgdGhyb3cgbWluRXJyKCduZ1BhdHRlcm4nKSgnbm9yZWdleHAnLAogICAgICAgICAgICAnRXhwZWN0ZWQgezB9IHRvIGJlIGEgUmVnRXhwIGJ1dCB3YXMgezF9LiBFbGVtZW50OiB7Mn0nLCBwYXR0ZXJuLAogICAgICAgICAgICBwYXR0ZXJuT2JqLCBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWxpZGF0ZVJlZ2V4KHBhdHRlcm5PYmosIHZhbHVlKTsKICAgICAgfTsKICAgIH0KCiAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgfQoKICAvLyBtaW4gbGVuZ3RoIHZhbGlkYXRvcgogIGlmIChhdHRyLm5nTWlubGVuZ3RoKSB7CiAgICB2YXIgbWlubGVuZ3RoID0gaW50KGF0dHIubmdNaW5sZW5ndGgpOwogICAgdmFyIG1pbkxlbmd0aFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnbWlubGVuZ3RoJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgdmFsdWUubGVuZ3RoID49IG1pbmxlbmd0aCwgdmFsdWUpOwogICAgfTsKCiAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluTGVuZ3RoVmFsaWRhdG9yKTsKICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5MZW5ndGhWYWxpZGF0b3IpOwogIH0KCiAgLy8gbWF4IGxlbmd0aCB2YWxpZGF0b3IKICBpZiAoYXR0ci5uZ01heGxlbmd0aCkgewogICAgdmFyIG1heGxlbmd0aCA9IGludChhdHRyLm5nTWF4bGVuZ3RoKTsKICAgIHZhciBtYXhMZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ21heGxlbmd0aCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlLmxlbmd0aCA8PSBtYXhsZW5ndGgsIHZhbHVlKTsKICAgIH07CgogICAgY3RybC4kcGFyc2Vycy5wdXNoKG1heExlbmd0aFZhbGlkYXRvcik7CiAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICB9Cn0KCmZ1bmN0aW9uIG51bWJlcklucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB2YXIgZW1wdHkgPSBjdHJsLiRpc0VtcHR5KHZhbHVlKTsKICAgIGlmIChlbXB0eSB8fCBOVU1CRVJfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCB0cnVlKTsKICAgICAgcmV0dXJuIHZhbHVlID09PSAnJyA/IG51bGwgOiAoZW1wdHkgPyB2YWx1ZSA6IHBhcnNlRmxvYXQodmFsdWUpKTsKICAgIH0gZWxzZSB7CiAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CiAgfSk7CgogIGFkZE5hdGl2ZUh0bWw1VmFsaWRhdG9ycyhjdHJsLCAnbnVtYmVyJywgZWxlbWVudCk7CgogIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkodmFsdWUpID8gJycgOiAnJyArIHZhbHVlOwogIH0pOwoKICBpZiAoYXR0ci5taW4pIHsKICAgIHZhciBtaW5WYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgbWluID0gcGFyc2VGbG9hdChhdHRyLm1pbik7CiAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnbWluJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgdmFsdWUgPj0gbWluLCB2YWx1ZSk7CiAgICB9OwoKICAgIGN0cmwuJHBhcnNlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1pblZhbGlkYXRvcik7CiAgfQoKICBpZiAoYXR0ci5tYXgpIHsKICAgIHZhciBtYXhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgbWF4ID0gcGFyc2VGbG9hdChhdHRyLm1heCk7CiAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnbWF4JywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgdmFsdWUgPD0gbWF4LCB2YWx1ZSk7CiAgICB9OwoKICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1heFZhbGlkYXRvcik7CiAgfQoKICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnbnVtYmVyJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgaXNOdW1iZXIodmFsdWUpLCB2YWx1ZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIHVybElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgdmFyIHVybFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ3VybCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IFVSTF9SRUdFWFAudGVzdCh2YWx1ZSksIHZhbHVlKTsKICB9OwoKICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKICBjdHJsLiRwYXJzZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKfQoKZnVuY3Rpb24gZW1haWxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogIHZhciBlbWFpbFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ2VtYWlsJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgRU1BSUxfUkVHRVhQLnRlc3QodmFsdWUpLCB2YWx1ZSk7CiAgfTsKCiAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICBjdHJsLiRwYXJzZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwp9CgpmdW5jdGlvbiByYWRpb0lucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogIC8vIG1ha2UgdGhlIG5hbWUgdW5pcXVlLCBpZiBub3QgZGVmaW5lZAogIGlmIChpc1VuZGVmaW5lZChhdHRyLm5hbWUpKSB7CiAgICBlbGVtZW50LmF0dHIoJ25hbWUnLCBuZXh0VWlkKCkpOwogIH0KCiAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgIGlmIChlbGVtZW50WzBdLmNoZWNrZWQpIHsKICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhdHRyLnZhbHVlKTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHZhbHVlID0gYXR0ci52YWx1ZTsKICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9ICh2YWx1ZSA9PSBjdHJsLiR2aWV3VmFsdWUpOwogIH07CgogIGF0dHIuJG9ic2VydmUoJ3ZhbHVlJywgY3RybC4kcmVuZGVyKTsKfQoKZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICB2YXIgdHJ1ZVZhbHVlID0gYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgZmFsc2VWYWx1ZSA9IGF0dHIubmdGYWxzZVZhbHVlOwoKICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICBlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICBjdHJsLiRzZXRWaWV3VmFsdWUoZWxlbWVudFswXS5jaGVja2VkKTsKICAgIH0pOwogIH0pOwoKICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGN0cmwuJHZpZXdWYWx1ZTsKICB9OwoKICAvLyBPdmVycmlkZSB0aGUgc3RhbmRhcmQgYCRpc0VtcHR5YCBiZWNhdXNlIGEgdmFsdWUgb2YgYGZhbHNlYCBtZWFucyBlbXB0eSBpbiBhIGNoZWNrYm94LgogIGN0cmwuJGlzRW1wdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9PSB0cnVlVmFsdWU7CiAgfTsKCiAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IHRydWVWYWx1ZTsKICB9KTsKCiAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogIH0pOwp9CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgdGV4dGFyZWEKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIEhUTUwgdGV4dGFyZWEgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIFRoZSBkYXRhLWJpbmRpbmcgYW5kIHZhbGlkYXRpb24KICogcHJvcGVydGllcyBvZiB0aGlzIGVsZW1lbnQgYXJlIGV4YWN0bHkgdGhlIHNhbWUgYXMgdGhvc2Ugb2YgdGhlCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXQgZWxlbWVudH0uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICogICAgbWlubGVuZ3RoLgogKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAqICAgIG1heGxlbmd0aC4KICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpbnB1dAogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogSFRNTCBpbnB1dCBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gSW5wdXQgY29udHJvbCBmb2xsb3dzIEhUTUw1IGlucHV0IHR5cGVzCiAqIGFuZCBwb2x5ZmlsbHMgdGhlIEhUTUw1IHZhbGlkYXRpb24gYmVoYXZpb3IgZm9yIG9sZGVyIGJyb3dzZXJzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBuZ1JlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgaWYgc2V0IHRvIHRydWUKICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICogICAgbWlubGVuZ3RoLgogKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAqICAgIG1heGxlbmd0aC4KICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGUgbmFtZT0iaW5wdXQtZGlyZWN0aXZlIj4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS51c2VyID0ge25hbWU6ICdndWVzdCcsIGxhc3Q6ICd2aXNpdG9yJ307CiAgICAgICAgIH0KICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIj4KICAgICAgICAgICBVc2VyIG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ1c2VyTmFtZSIgbmctbW9kZWw9InVzZXIubmFtZSIgcmVxdWlyZWQ+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0udXNlck5hbWUuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgICAgICAgTGFzdCBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibGFzdE5hbWUiIG5nLW1vZGVsPSJ1c2VyLmxhc3QiCiAgICAgICAgICAgICBuZy1taW5sZW5ndGg9IjMiIG5nLW1heGxlbmd0aD0iMTAiPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5taW5sZW5ndGgiPgogICAgICAgICAgICAgVG9vIHNob3J0ITwvc3Bhbj4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWF4bGVuZ3RoIj4KICAgICAgICAgICAgIFRvbyBsb25nITwvc3Bhbj48YnI+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPGhyPgogICAgICAgICA8dHQ+dXNlciA9IHt7dXNlcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLnVzZXJOYW1lLiR2YWxpZCA9IHt7bXlGb3JtLnVzZXJOYW1lLiR2YWxpZH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0udXNlck5hbWUuJGVycm9yID0ge3tteUZvcm0udXNlck5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kdmFsaWQgPSB7e215Rm9ybS5sYXN0TmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLmxhc3ROYW1lLiRlcnJvciA9IHt7bXlGb3JtLmxhc3ROYW1lLiRlcnJvcn19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLm1pbmxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1pbmxlbmd0aH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLm1heGxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1heGxlbmd0aH19PC90dD48YnI+CiAgICAgICA8L2Rpdj4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICB2YXIgdXNlciA9IGVsZW1lbnQoYnkuYmluZGluZygne3t1c2VyfX0nKSk7CiAgICAgICAgdmFyIHVzZXJOYW1lVmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS51c2VyTmFtZS4kdmFsaWQnKSk7CiAgICAgICAgdmFyIGxhc3ROYW1lVmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kdmFsaWQnKSk7CiAgICAgICAgdmFyIGxhc3ROYW1lRXJyb3IgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSk7CiAgICAgICAgdmFyIGZvcm1WYWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKTsKICAgICAgICB2YXIgdXNlck5hbWVJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXIubmFtZScpKTsKICAgICAgICB2YXIgdXNlckxhc3RJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXIubGFzdCcpKTsKCiAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QodXNlck5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHkgd2hlbiByZXF1aXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlck5hbWVJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlck5hbWVJbnB1dC5zZW5kS2V5cygnJyk7CgogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibGFzdCI6InZpc2l0b3IifScpOwogICAgICAgICAgZXhwZWN0KHVzZXJOYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIHZhbGlkIGlmIGVtcHR5IHdoZW4gbWluIGxlbmd0aCBpcyBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzZXJMYXN0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIHVzZXJMYXN0SW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiIifScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxlc3MgdGhhbiByZXF1aXJlZCBtaW4gbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2VyTGFzdElucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VyTGFzdElucHV0LnNlbmRLZXlzKCd4eCcpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZUVycm9yLmdldFRleHQoKSkudG9Db250YWluKCdtaW5sZW5ndGgnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsb25nZXIgdGhhbiBtYXggbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2VyTGFzdElucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VyTGFzdElucHV0LnNlbmRLZXlzKCdzb21lIHJpZGljdWxvdXNseSBsb25nIG5hbWUnKTsKCiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QifScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVFcnJvci5nZXRUZXh0KCkpLnRvQ29udGFpbignbWF4bGVuZ3RoJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqLwp2YXIgaW5wdXREaXJlY3RpdmUgPSBbJyRicm93c2VyJywgJyRzbmlmZmVyJywgZnVuY3Rpb24oJGJyb3dzZXIsICRzbmlmZmVyKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgaWYgKGN0cmwpIHsKICAgICAgICAoaW5wdXRUeXBlW2xvd2VyY2FzZShhdHRyLnR5cGUpXSB8fCBpbnB1dFR5cGUudGV4dCkoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnJvd3Nlcik7CiAgICAgIH0KICAgIH0KICB9Owp9XTsKCnZhciBWQUxJRF9DTEFTUyA9ICduZy12YWxpZCcsCiAgICBJTlZBTElEX0NMQVNTID0gJ25nLWludmFsaWQnLAogICAgUFJJU1RJTkVfQ0xBU1MgPSAnbmctcHJpc3RpbmUnLAogICAgRElSVFlfQ0xBU1MgPSAnbmctZGlydHknOwoKLyoqCiAqIEBuZ2RvYyB0eXBlCiAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICoKICogQHByb3BlcnR5IHtzdHJpbmd9ICR2aWV3VmFsdWUgQWN0dWFsIHN0cmluZyB2YWx1ZSBpbiB0aGUgdmlldy4KICogQHByb3BlcnR5IHsqfSAkbW9kZWxWYWx1ZSBUaGUgdmFsdWUgaW4gdGhlIG1vZGVsLCB0aGF0IHRoZSBjb250cm9sIGlzIGJvdW5kIHRvLgogKiBAcHJvcGVydHkge0FycmF5LjxGdW5jdGlvbj59ICRwYXJzZXJzIEFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlLCBhcyBhIHBpcGVsaW5lLCB3aGVuZXZlcgogICAgICAgdGhlIGNvbnRyb2wgcmVhZHMgdmFsdWUgZnJvbSB0aGUgRE9NLiAgRWFjaCBmdW5jdGlvbiBpcyBjYWxsZWQsIGluIHR1cm4sIHBhc3NpbmcgdGhlIHZhbHVlCiAgICAgICB0aHJvdWdoIHRvIHRoZSBuZXh0LiBUaGUgbGFzdCByZXR1cm4gdmFsdWUgaXMgdXNlZCB0byBwb3B1bGF0ZSB0aGUgbW9kZWwuCiAgICAgICBVc2VkIHRvIHNhbml0aXplIC8gY29udmVydCB0aGUgdmFsdWUgYXMgd2VsbCBhcyB2YWxpZGF0aW9uLiBGb3IgdmFsaWRhdGlvbiwKICAgICAgIHRoZSBwYXJzZXJzIHNob3VsZCB1cGRhdGUgdGhlIHZhbGlkaXR5IHN0YXRlIHVzaW5nCiAgICAgICB7QGxpbmsgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VmFsaWRpdHkgJHNldFZhbGlkaXR5KCl9LAogICAgICAgYW5kIHJldHVybiBgdW5kZWZpbmVkYCBmb3IgaW52YWxpZCB2YWx1ZXMuCgogKgogKiBAcHJvcGVydHkge0FycmF5LjxGdW5jdGlvbj59ICRmb3JtYXR0ZXJzIEFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlLCBhcyBhIHBpcGVsaW5lLCB3aGVuZXZlcgogICAgICAgdGhlIG1vZGVsIHZhbHVlIGNoYW5nZXMuIEVhY2ggZnVuY3Rpb24gaXMgY2FsbGVkLCBpbiB0dXJuLCBwYXNzaW5nIHRoZSB2YWx1ZSB0aHJvdWdoIHRvIHRoZQogICAgICAgbmV4dC4gVXNlZCB0byBmb3JtYXQgLyBjb252ZXJ0IHZhbHVlcyBmb3IgZGlzcGxheSBpbiB0aGUgY29udHJvbCBhbmQgdmFsaWRhdGlvbi4KICogYGBganMKICogZnVuY3Rpb24gZm9ybWF0dGVyKHZhbHVlKSB7CiAqICAgaWYgKHZhbHVlKSB7CiAqICAgICByZXR1cm4gdmFsdWUudG9VcHBlckNhc2UoKTsKICogICB9CiAqIH0KICogbmdNb2RlbC4kZm9ybWF0dGVycy5wdXNoKGZvcm1hdHRlcik7CiAqIGBgYAogKgogKiBAcHJvcGVydHkge0FycmF5LjxGdW5jdGlvbj59ICR2aWV3Q2hhbmdlTGlzdGVuZXJzIEFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlIHdoZW5ldmVyIHRoZQogKiAgICAgdmlldyB2YWx1ZSBoYXMgY2hhbmdlZC4gSXQgaXMgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzLCBhbmQgaXRzIHJldHVybiB2YWx1ZSBpcyBpZ25vcmVkLgogKiAgICAgVGhpcyBjYW4gYmUgdXNlZCBpbiBwbGFjZSBvZiBhZGRpdGlvbmFsICR3YXRjaGVzIGFnYWluc3QgdGhlIG1vZGVsIHZhbHVlLgogKgogKiBAcHJvcGVydHkge09iamVjdH0gJGVycm9yIEFuIG9iamVjdCBoYXNoIHdpdGggYWxsIGVycm9ycyBhcyBrZXlzLgogKgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGNvbnRyb2wgeWV0LgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sLgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICR2YWxpZCBUcnVlIGlmIHRoZXJlIGlzIG5vIGVycm9yLgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGVycm9yIG9uIHRoZSBjb250cm9sLgogKgogKiBAZGVzY3JpcHRpb24KICoKICogYE5nTW9kZWxDb250cm9sbGVyYCBwcm92aWRlcyBBUEkgZm9yIHRoZSBgbmctbW9kZWxgIGRpcmVjdGl2ZS4gVGhlIGNvbnRyb2xsZXIgY29udGFpbnMKICogc2VydmljZXMgZm9yIGRhdGEtYmluZGluZywgdmFsaWRhdGlvbiwgQ1NTIHVwZGF0ZXMsIGFuZCB2YWx1ZSBmb3JtYXR0aW5nIGFuZCBwYXJzaW5nLiBJdAogKiBwdXJwb3NlZnVsbHkgZG9lcyBub3QgY29udGFpbiBhbnkgbG9naWMgd2hpY2ggZGVhbHMgd2l0aCBET00gcmVuZGVyaW5nIG9yIGxpc3RlbmluZyB0bwogKiBET00gZXZlbnRzLiBTdWNoIERPTSByZWxhdGVkIGxvZ2ljIHNob3VsZCBiZSBwcm92aWRlZCBieSBvdGhlciBkaXJlY3RpdmVzIHdoaWNoIG1ha2UgdXNlIG9mCiAqIGBOZ01vZGVsQ29udHJvbGxlcmAgZm9yIGRhdGEtYmluZGluZy4KICoKICogIyMgQ3VzdG9tIENvbnRyb2wgRXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIHdpdGggYSBjdXN0b20gY29udHJvbCB0byBhY2hpZXZlCiAqIGRhdGEtYmluZGluZy4gTm90aWNlIGhvdyBkaWZmZXJlbnQgZGlyZWN0aXZlcyAoYGNvbnRlbnRlZGl0YWJsZWAsIGBuZy1tb2RlbGAsIGFuZCBgcmVxdWlyZWRgKQogKiBjb2xsYWJvcmF0ZSB0b2dldGhlciB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIHJlc3VsdC4KICoKICogTm90ZSB0aGF0IGBjb250ZW50ZWRpdGFibGVgIGlzIGFuIEhUTUw1IGF0dHJpYnV0ZSwgd2hpY2ggdGVsbHMgdGhlIGJyb3dzZXIgdG8gbGV0IHRoZSBlbGVtZW50CiAqIGNvbnRlbnRzIGJlIGVkaXRlZCBpbiBwbGFjZSBieSB0aGUgdXNlci4gIFRoaXMgd2lsbCBub3Qgd29yayBvbiBvbGRlciBicm93c2Vycy4KICoKICogV2UgYXJlIHVzaW5nIHRoZSB7QGxpbmsgbmcuc2VydmljZTokc2NlICRzY2V9IHNlcnZpY2UgaGVyZSBhbmQgaW5jbHVkZSB0aGUge0BsaW5rIG5nU2FuaXRpemUgJHNhbml0aXplfQogKiBtb2R1bGUgdG8gYXV0b21hdGljYWxseSByZW1vdmUgImJhZCIgY29udGVudCBsaWtlIGlubGluZSBldmVudCBsaXN0ZW5lciAoZS5nLiBgPHNwYW4gb25jbGljaz0iLi4uIj5gKS4KICogSG93ZXZlciwgYXMgd2UgYXJlIHVzaW5nIGAkc2NlYCB0aGUgbW9kZWwgY2FuIHN0aWxsIGRlY2lkZSB0byB0byBwcm92aWRlIHVuc2FmZSBjb250ZW50IGlmIGl0IG1hcmtzCiAqIHRoYXQgY29udGVudCB1c2luZyB0aGUgYCRzY2VgIHNlcnZpY2UuCiAqCiAqIDxleGFtcGxlIG5hbWU9Ik5nTW9kZWxDb250cm9sbGVyIiBtb2R1bGU9ImN1c3RvbUNvbnRyb2wiIGRlcHM9ImFuZ3VsYXItc2FuaXRpemUuanMiPgogICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgW2NvbnRlbnRlZGl0YWJsZV0gewogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgIG1pbi1oZWlnaHQ6IDIwcHg7CiAgICAgIH0KCiAgICAgIC5uZy1pbnZhbGlkIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZWQ7CiAgICAgIH0KCiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICBhbmd1bGFyLm1vZHVsZSgnY3VzdG9tQ29udHJvbCcsIFsnbmdTYW5pdGl6ZSddKS4KICAgICAgICBkaXJlY3RpdmUoJ2NvbnRlbnRlZGl0YWJsZScsIFsnJHNjZScsIGZ1bmN0aW9uKCRzY2UpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsIC8vIG9ubHkgYWN0aXZhdGUgb24gZWxlbWVudCBhdHRyaWJ1dGUKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywgLy8gZ2V0IGEgaG9sZCBvZiBOZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIG5nTW9kZWwpIHsKICAgICAgICAgICAgICBpZighbmdNb2RlbCkgcmV0dXJuOyAvLyBkbyBub3RoaW5nIGlmIG5vIG5nLW1vZGVsCgogICAgICAgICAgICAgIC8vIFNwZWNpZnkgaG93IFVJIHNob3VsZCBiZSB1cGRhdGVkCiAgICAgICAgICAgICAgbmdNb2RlbC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwoJHNjZS5nZXRUcnVzdGVkSHRtbChuZ01vZGVsLiR2aWV3VmFsdWUgfHwgJycpKTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIGNoYW5nZSBldmVudHMgdG8gZW5hYmxlIGJpbmRpbmcKICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdibHVyIGtleXVwIGNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KHJlYWQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlYWQoKTsgLy8gaW5pdGlhbGl6ZQoKICAgICAgICAgICAgICAvLyBXcml0ZSBkYXRhIHRvIHRoZSBtb2RlbAogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlYWQoKSB7CiAgICAgICAgICAgICAgICB2YXIgaHRtbCA9IGVsZW1lbnQuaHRtbCgpOwogICAgICAgICAgICAgICAgLy8gV2hlbiB3ZSBjbGVhciB0aGUgY29udGVudCBlZGl0YWJsZSB0aGUgYnJvd3NlciBsZWF2ZXMgYSA8YnI+IGJlaGluZAogICAgICAgICAgICAgICAgLy8gSWYgc3RyaXAtYnIgYXR0cmlidXRlIGlzIHByb3ZpZGVkIHRoZW4gd2Ugc3RyaXAgdGhpcyBvdXQKICAgICAgICAgICAgICAgIGlmKCBhdHRycy5zdHJpcEJyICYmIGh0bWwgPT0gJzxicj4nICkgewogICAgICAgICAgICAgICAgICBodG1sID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZ01vZGVsLiRzZXRWaWV3VmFsdWUoaHRtbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH1dKTsKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICAgICAgPGRpdiBjb250ZW50ZWRpdGFibGUKICAgICAgICAgICAgbmFtZT0ibXlXaWRnZXQiIG5nLW1vZGVsPSJ1c2VyQ29udGVudCIKICAgICAgICAgICAgc3RyaXAtYnI9InRydWUiCiAgICAgICAgICAgIHJlcXVpcmVkPkNoYW5nZSBtZSE8L2Rpdj4KICAgICAgICA8c3BhbiBuZy1zaG93PSJteUZvcm0ubXlXaWRnZXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+CiAgICAgICA8aHI+CiAgICAgICA8dGV4dGFyZWEgbmctbW9kZWw9InVzZXJDb250ZW50Ij48L3RleHRhcmVhPgogICAgICA8L2Zvcm0+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgIGl0KCdzaG91bGQgZGF0YS1iaW5kIGFuZCBiZWNvbWUgaW52YWxpZCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnc2FmYXJpJyB8fCBicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdmaXJlZm94JykgewogICAgICAgIC8vIFNhZmFyaURyaXZlciBjYW4ndCBoYW5kbGUgY29udGVudGVkaXRhYmxlCiAgICAgICAgLy8gYW5kIEZpcmVmb3ggZHJpdmVyIGNhbid0IGNsZWFyIGNvbnRlbnRlZGl0YWJsZXMgdmVyeSB3ZWxsCiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjb250ZW50RWRpdGFibGUgPSBlbGVtZW50KGJ5LmNzcygnW2NvbnRlbnRlZGl0YWJsZV0nKSk7CiAgICAgIHZhciBjb250ZW50ID0gJ0NoYW5nZSBtZSEnOwoKICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS5nZXRUZXh0KCkpLnRvRXF1YWwoY29udGVudCk7CgogICAgICBjb250ZW50RWRpdGFibGUuY2xlYXIoKTsKICAgICAgY29udGVudEVkaXRhYmxlLnNlbmRLZXlzKHByb3RyYWN0b3IuS2V5LkJBQ0tfU1BBQ0UpOwogICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLmdldFRleHQoKSkudG9FcXVhbCgnJyk7CiAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b01hdGNoKC9uZy1pbnZhbGlkLXJlcXVpcmVkLyk7CiAgICB9KTsKICAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKgogKgogKi8KdmFyIE5nTW9kZWxDb250cm9sbGVyID0gWyckc2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGF0dHJzJywgJyRlbGVtZW50JywgJyRwYXJzZScsICckYW5pbWF0ZScsCiAgICBmdW5jdGlvbigkc2NvcGUsICRleGNlcHRpb25IYW5kbGVyLCAkYXR0ciwgJGVsZW1lbnQsICRwYXJzZSwgJGFuaW1hdGUpIHsKICB0aGlzLiR2aWV3VmFsdWUgPSBOdW1iZXIuTmFOOwogIHRoaXMuJG1vZGVsVmFsdWUgPSBOdW1iZXIuTmFOOwogIHRoaXMuJHBhcnNlcnMgPSBbXTsKICB0aGlzLiRmb3JtYXR0ZXJzID0gW107CiAgdGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycyA9IFtdOwogIHRoaXMuJHByaXN0aW5lID0gdHJ1ZTsKICB0aGlzLiRkaXJ0eSA9IGZhbHNlOwogIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICB0aGlzLiRpbnZhbGlkID0gZmFsc2U7CiAgdGhpcy4kbmFtZSA9ICRhdHRyLm5hbWU7CgogIHZhciBuZ01vZGVsR2V0ID0gJHBhcnNlKCRhdHRyLm5nTW9kZWwpLAogICAgICBuZ01vZGVsU2V0ID0gbmdNb2RlbEdldC5hc3NpZ247CgogIGlmICghbmdNb2RlbFNldCkgewogICAgdGhyb3cgbWluRXJyKCduZ01vZGVsJykoJ25vbmFzc2lnbicsICJFeHByZXNzaW9uICd7MH0nIGlzIG5vbi1hc3NpZ25hYmxlLiBFbGVtZW50OiB7MX0iLAogICAgICAgICRhdHRyLm5nTW9kZWwsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkcmVuZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiB0aGUgdmlldyBuZWVkcyB0byBiZSB1cGRhdGVkLiBJdCBpcyBleHBlY3RlZCB0aGF0IHRoZSB1c2VyIG9mIHRoZSBuZy1tb2RlbAogICAqIGRpcmVjdGl2ZSB3aWxsIGltcGxlbWVudCB0aGlzIG1ldGhvZC4KICAgKi8KICB0aGlzLiRyZW5kZXIgPSBub29wOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkaXNFbXB0eQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBpcyBjYWxsZWQgd2hlbiB3ZSBuZWVkIHRvIGRldGVybWluZSBpZiB0aGUgdmFsdWUgb2YgdGhlIGlucHV0IGlzIGVtcHR5LgogICAqCiAgICogRm9yIGluc3RhbmNlLCB0aGUgcmVxdWlyZWQgZGlyZWN0aXZlIGRvZXMgdGhpcyB0byB3b3JrIG91dCBpZiB0aGUgaW5wdXQgaGFzIGRhdGEgb3Igbm90LgogICAqIFRoZSBkZWZhdWx0IGAkaXNFbXB0eWAgZnVuY3Rpb24gY2hlY2tzIHdoZXRoZXIgdGhlIHZhbHVlIGlzIGB1bmRlZmluZWRgLCBgJydgLCBgbnVsbGAgb3IgYE5hTmAuCiAgICoKICAgKiBZb3UgY2FuIG92ZXJyaWRlIHRoaXMgZm9yIGlucHV0IGRpcmVjdGl2ZXMgd2hvc2UgY29uY2VwdCBvZiBiZWluZyBlbXB0eSBpcyBkaWZmZXJlbnQgdG8gdGhlCiAgICogZGVmYXVsdC4gVGhlIGBjaGVja2JveElucHV0VHlwZWAgZGlyZWN0aXZlIGRvZXMgdGhpcyBiZWNhdXNlIGluIGl0cyBjYXNlIGEgdmFsdWUgb2YgYGZhbHNlYAogICAqIGltcGxpZXMgZW1wdHkuCiAgICoKICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGVtcHR5LgogICAqLwogIHRoaXMuJGlzRW1wdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGlzVW5kZWZpbmVkKHZhbHVlKSB8fCB2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlOwogIH07CgogIHZhciBwYXJlbnRGb3JtID0gJGVsZW1lbnQuaW5oZXJpdGVkRGF0YSgnJGZvcm1Db250cm9sbGVyJykgfHwgbnVsbEZvcm1DdHJsLAogICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgICRlcnJvciA9IHRoaXMuJGVycm9yID0ge307IC8vIGtlZXAgaW52YWxpZCBrZXlzIGhlcmUKCgogIC8vIFNldHVwIGluaXRpYWwgc3RhdGUgb2YgdGhlIGNvbnRyb2wKICAkZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogIC8vIGNvbnZlbmllbmNlIG1ldGhvZCBmb3IgZWFzeSB0b2dnbGluZyBvZiBjbGFzc2VzCiAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICB2YWxpZGF0aW9uRXJyb3JLZXkgPSB2YWxpZGF0aW9uRXJyb3JLZXkgPyAnLScgKyBzbmFrZV9jYXNlKHZhbGlkYXRpb25FcnJvcktleSwgJy0nKSA6ICcnOwogICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoJGVsZW1lbnQsIChpc1ZhbGlkID8gSU5WQUxJRF9DTEFTUyA6IFZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAkYW5pbWF0ZS5hZGRDbGFzcygkZWxlbWVudCwgKGlzVmFsaWQgPyBWQUxJRF9DTEFTUyA6IElOVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWYWxpZGl0eQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgKiBkb2VzIG5vdCBub3RpZnkgZm9ybSBpZiBnaXZlbiB2YWxpZGF0b3IgaXMgYWxyZWFkeSBtYXJrZWQgYXMgaW52YWxpZCkuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWxpZGF0aW9uRXJyb3JLZXkgTmFtZSBvZiB0aGUgdmFsaWRhdG9yLiB0aGUgYHZhbGlkYXRpb25FcnJvcktleWAgd2lsbCBhc3NpZ24KICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICogICAgICAgIFRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCBzaG91bGQgYmUgaW4gY2FtZWxDYXNlIGFuZCB3aWxsIGdldCBjb252ZXJ0ZWQgaW50byBkYXNoLWNhc2UKICAgKiAgICAgICAgZm9yIGNsYXNzIG5hbWUuIEV4YW1wbGU6IGBteUVycm9yYCB3aWxsIHJlc3VsdCBpbiBgbmctdmFsaWQtbXktZXJyb3JgIGFuZCBgbmctaW52YWxpZC1teS1lcnJvcmAKICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNWYWxpZCBXaGV0aGVyIHRoZSBjdXJyZW50IHN0YXRlIGlzIHZhbGlkICh0cnVlKSBvciBpbnZhbGlkIChmYWxzZSkuCiAgICovCiAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbih2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQpIHsKICAgIC8vIFB1cnBvc2VmdWwgdXNlIG9mICEgaGVyZSB0byBjYXN0IGlzVmFsaWQgdG8gYm9vbGVhbiBpbiBjYXNlIGl0IGlzIHVuZGVmaW5lZAogICAgLy8ganNoaW50IC1XMDE4CiAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPT09ICFpc1ZhbGlkKSByZXR1cm47CiAgICAvLyBqc2hpbnQgK1cwMTgKCiAgICBpZiAoaXNWYWxpZCkgewogICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0pIGludmFsaWRDb3VudC0tOwogICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwogICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICB0aGlzLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlKTsKICAgICAgdGhpcy4kaW52YWxpZCA9IHRydWU7CiAgICAgIHRoaXMuJHZhbGlkID0gZmFsc2U7CiAgICAgIGludmFsaWRDb3VudCsrOwogICAgfQoKICAgICRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID0gIWlzVmFsaWQ7CiAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpOwoKICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCwgdGhpcyk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFByaXN0aW5lCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIHRoZSBjb250cm9sIHRvIGl0cyBwcmlzdGluZSBzdGF0ZS4KICAgKgogICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgdG8gcmVtb3ZlIHRoZSAnbmctZGlydHknIGNsYXNzIGFuZCBzZXQgdGhlIGNvbnRyb2wgdG8gaXRzIHByaXN0aW5lCiAgICogc3RhdGUgKG5nLXByaXN0aW5lIGNsYXNzKS4KICAgKi8KICB0aGlzLiRzZXRQcmlzdGluZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcygkZWxlbWVudCwgRElSVFlfQ0xBU1MpOwogICAgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsIFBSSVNUSU5FX0NMQVNTKTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0Vmlld1ZhbHVlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVcGRhdGUgdGhlIHZpZXcgdmFsdWUuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIHdoZW4gdGhlIHZpZXcgdmFsdWUgY2hhbmdlcywgdHlwaWNhbGx5IGZyb20gd2l0aGluIGEgRE9NIGV2ZW50IGhhbmRsZXIuCiAgICogRm9yIGV4YW1wbGUge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0gYW5kCiAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpzZWxlY3Qgc2VsZWN0fSBkaXJlY3RpdmVzIGNhbGwgaXQuCiAgICoKICAgKiBJdCB3aWxsIHVwZGF0ZSB0aGUgJHZpZXdWYWx1ZSwgdGhlbiBwYXNzIHRoaXMgdmFsdWUgdGhyb3VnaCBlYWNoIG9mIHRoZSBmdW5jdGlvbnMgaW4gYCRwYXJzZXJzYCwKICAgKiB3aGljaCBpbmNsdWRlcyBhbnkgdmFsaWRhdG9ycy4gVGhlIHZhbHVlIHRoYXQgY29tZXMgb3V0IG9mIHRoaXMgYCRwYXJzZXJzYCBwaXBlbGluZSwgYmUgYXBwbGllZCB0bwogICAqIGAkbW9kZWxWYWx1ZWAgYW5kIHRoZSAqKmV4cHJlc3Npb24qKiBzcGVjaWZpZWQgaW4gdGhlIGBuZy1tb2RlbGAgYXR0cmlidXRlLgogICAqCiAgICogTGFzdGx5LCBhbGwgdGhlIHJlZ2lzdGVyZWQgY2hhbmdlIGxpc3RlbmVycywgaW4gdGhlIGAkdmlld0NoYW5nZUxpc3RlbmVyc2AgbGlzdCwgYXJlIGNhbGxlZC4KICAgKgogICAqIE5vdGUgdGhhdCBjYWxsaW5nIHRoaXMgZnVuY3Rpb24gZG9lcyBub3QgdHJpZ2dlciBhIGAkZGlnZXN0YC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSBmcm9tIHRoZSB2aWV3LgogICAqLwogIHRoaXMuJHNldFZpZXdWYWx1ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB0aGlzLiR2aWV3VmFsdWUgPSB2YWx1ZTsKCiAgICAvLyBjaGFuZ2UgdG8gZGlydHkKICAgIGlmICh0aGlzLiRwcmlzdGluZSkgewogICAgICB0aGlzLiRkaXJ0eSA9IHRydWU7CiAgICAgIHRoaXMuJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKCRlbGVtZW50LCBQUklTVElORV9DTEFTUyk7CiAgICAgICRhbmltYXRlLmFkZENsYXNzKCRlbGVtZW50LCBESVJUWV9DTEFTUyk7CiAgICAgIHBhcmVudEZvcm0uJHNldERpcnR5KCk7CiAgICB9CgogICAgZm9yRWFjaCh0aGlzLiRwYXJzZXJzLCBmdW5jdGlvbihmbikgewogICAgICB2YWx1ZSA9IGZuKHZhbHVlKTsKICAgIH0pOwoKICAgIGlmICh0aGlzLiRtb2RlbFZhbHVlICE9PSB2YWx1ZSkgewogICAgICB0aGlzLiRtb2RlbFZhbHVlID0gdmFsdWU7CiAgICAgIG5nTW9kZWxTZXQoJHNjb3BlLCB2YWx1ZSk7CiAgICAgIGZvckVhY2godGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLy8gbW9kZWwgLT4gdmFsdWUKICB2YXIgY3RybCA9IHRoaXM7CgogICRzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdNb2RlbFdhdGNoKCkgewogICAgdmFyIHZhbHVlID0gbmdNb2RlbEdldCgkc2NvcGUpOwoKICAgIC8vIGlmIHNjb3BlIG1vZGVsIHZhbHVlIGFuZCBuZ01vZGVsIHZhbHVlIGFyZSBvdXQgb2Ygc3luYwogICAgaWYgKGN0cmwuJG1vZGVsVmFsdWUgIT09IHZhbHVlKSB7CgogICAgICB2YXIgZm9ybWF0dGVycyA9IGN0cmwuJGZvcm1hdHRlcnMsCiAgICAgICAgICBpZHggPSBmb3JtYXR0ZXJzLmxlbmd0aDsKCiAgICAgIGN0cmwuJG1vZGVsVmFsdWUgPSB2YWx1ZTsKICAgICAgd2hpbGUoaWR4LS0pIHsKICAgICAgICB2YWx1ZSA9IGZvcm1hdHRlcnNbaWR4XSh2YWx1ZSk7CiAgICAgIH0KCiAgICAgIGlmIChjdHJsLiR2aWV3VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgY3RybC4kdmlld1ZhbHVlID0gdmFsdWU7CiAgICAgICAgY3RybC4kcmVuZGVyKCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfSk7Cn1dOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW9kZWwKICoKICogQGVsZW1lbnQgaW5wdXQKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdNb2RlbGAgZGlyZWN0aXZlIGJpbmRzIGFuIGBpbnB1dGAsYHNlbGVjdGAsIGB0ZXh0YXJlYWAgKG9yIGN1c3RvbSBmb3JtIGNvbnRyb2wpIHRvIGEKICogcHJvcGVydHkgb24gdGhlIHNjb3BlIHVzaW5nIHtAbGluayBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIE5nTW9kZWxDb250cm9sbGVyfSwKICogd2hpY2ggaXMgY3JlYXRlZCBhbmQgZXhwb3NlZCBieSB0aGlzIGRpcmVjdGl2ZS4KICoKICogYG5nTW9kZWxgIGlzIHJlc3BvbnNpYmxlIGZvcjoKICoKICogLSBCaW5kaW5nIHRoZSB2aWV3IGludG8gdGhlIG1vZGVsLCB3aGljaCBvdGhlciBkaXJlY3RpdmVzIHN1Y2ggYXMgYGlucHV0YCwgYHRleHRhcmVhYCBvciBgc2VsZWN0YAogKiAgIHJlcXVpcmUuCiAqIC0gUHJvdmlkaW5nIHZhbGlkYXRpb24gYmVoYXZpb3IgKGkuZS4gcmVxdWlyZWQsIG51bWJlciwgZW1haWwsIHVybCkuCiAqIC0gS2VlcGluZyB0aGUgc3RhdGUgb2YgdGhlIGNvbnRyb2wgKHZhbGlkL2ludmFsaWQsIGRpcnR5L3ByaXN0aW5lLCB2YWxpZGF0aW9uIGVycm9ycykuCiAqIC0gU2V0dGluZyByZWxhdGVkIGNzcyBjbGFzc2VzIG9uIHRoZSBlbGVtZW50IChgbmctdmFsaWRgLCBgbmctaW52YWxpZGAsIGBuZy1kaXJ0eWAsIGBuZy1wcmlzdGluZWApIGluY2x1ZGluZyBhbmltYXRpb25zLgogKiAtIFJlZ2lzdGVyaW5nIHRoZSBjb250cm9sIHdpdGggaXRzIHBhcmVudCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0uCiAqCiAqIE5vdGU6IGBuZ01vZGVsYCB3aWxsIHRyeSB0byBiaW5kIHRvIHRoZSBwcm9wZXJ0eSBnaXZlbiBieSBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uIG9uIHRoZQogKiBjdXJyZW50IHNjb3BlLiBJZiB0aGUgcHJvcGVydHkgZG9lc24ndCBhbHJlYWR5IGV4aXN0IG9uIHRoaXMgc2NvcGUsIGl0IHdpbGwgYmUgY3JlYXRlZAogKiBpbXBsaWNpdGx5IGFuZCBhZGRlZCB0byB0aGUgc2NvcGUuCiAqCiAqIEZvciBiZXN0IHByYWN0aWNlcyBvbiB1c2luZyBgbmdNb2RlbGAsIHNlZToKICoKICogIC0gW2h0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvd2lraS9VbmRlcnN0YW5kaW5nLVNjb3Blc10KICoKICogRm9yIGJhc2ljIGV4YW1wbGVzLCBob3cgdG8gdXNlIGBuZ01vZGVsYCwgc2VlOgogKgogKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0fQogKiAgICAtIHtAbGluayBpbnB1dFt0ZXh0XSB0ZXh0fQogKiAgICAtIHtAbGluayBpbnB1dFtjaGVja2JveF0gY2hlY2tib3h9CiAqICAgIC0ge0BsaW5rIGlucHV0W3JhZGlvXSByYWRpb30KICogICAgLSB7QGxpbmsgaW5wdXRbbnVtYmVyXSBudW1iZXJ9CiAqICAgIC0ge0BsaW5rIGlucHV0W2VtYWlsXSBlbWFpbH0KICogICAgLSB7QGxpbmsgaW5wdXRbdXJsXSB1cmx9CiAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0KICogIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTp0ZXh0YXJlYSB0ZXh0YXJlYX0KICoKICogIyBDU1MgY2xhc3NlcwogKiBUaGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIGFyZSBhZGRlZCBhbmQgcmVtb3ZlZCBvbiB0aGUgYXNzb2NpYXRlZCBpbnB1dC9zZWxlY3QvdGV4dGFyZWEgZWxlbWVudAogKiBkZXBlbmRpbmcgb24gdGhlIHZhbGlkaXR5IG9mIHRoZSBtb2RlbC4KICoKICogIC0gYG5nLXZhbGlkYCBpcyBzZXQgaWYgdGhlIG1vZGVsIGlzIHZhbGlkLgogKiAgLSBgbmctaW52YWxpZGAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyBpbnZhbGlkLgogKiAgLSBgbmctcHJpc3RpbmVgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgcHJpc3RpbmUuCiAqICAtIGBuZy1kaXJ0eWAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyBkaXJ0eS4KICoKICogS2VlcCBpbiBtaW5kIHRoYXQgbmdBbmltYXRlIGNhbiBkZXRlY3QgZWFjaCBvZiB0aGVzZSBjbGFzc2VzIHdoZW4gYWRkZWQgYW5kIHJlbW92ZWQuCiAqCiAqICMjIEFuaW1hdGlvbiBIb29rcwogKgogKiBBbmltYXRpb25zIHdpdGhpbiBtb2RlbHMgYXJlIHRyaWdnZXJlZCB3aGVuIGFueSBvZiB0aGUgYXNzb2NpYXRlZCBDU1MgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIHJlbW92ZWQKICogb24gdGhlIGlucHV0IGVsZW1lbnQgd2hpY2ggaXMgYXR0YWNoZWQgdG8gdGhlIG1vZGVsLiBUaGVzZSBjbGFzc2VzIGFyZTogYC5uZy1wcmlzdGluZWAsIGAubmctZGlydHlgLAogKiBgLm5nLWludmFsaWRgIGFuZCBgLm5nLXZhbGlkYCBhcyB3ZWxsIGFzIGFueSBvdGhlciB2YWxpZGF0aW9ucyB0aGF0IGFyZSBwZXJmb3JtZWQgb24gdGhlIG1vZGVsIGl0c2VsZi4KICogVGhlIGFuaW1hdGlvbnMgdGhhdCBhcmUgdHJpZ2dlcmVkIHdpdGhpbiBuZ01vZGVsIGFyZSBzaW1pbGFyIHRvIGhvdyB0aGV5IHdvcmsgaW4gbmdDbGFzcyBhbmQKICogYW5pbWF0aW9ucyBjYW4gYmUgaG9va2VkIGludG8gdXNpbmcgQ1NTIHRyYW5zaXRpb25zLCBrZXlmcmFtZXMgYXMgd2VsbCBhcyBKUyBhbmltYXRpb25zLgogKgogKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgYSBzaW1wbGUgd2F5IHRvIHV0aWxpemUgQ1NTIHRyYW5zaXRpb25zIHRvIHN0eWxlIGFuIGlucHV0IGVsZW1lbnQKICogdGhhdCBoYXMgYmVlbiByZW5kZXJlZCBhcyBpbnZhbGlkIGFmdGVyIGl0IGhhcyBiZWVuIHZhbGlkYXRlZDoKICoKICogPHByZT4KICogLy9iZSBzdXJlIHRvIGluY2x1ZGUgbmdBbmltYXRlIGFzIGEgbW9kdWxlIHRvIGhvb2sgaW50byBtb3JlCiAqIC8vYWR2YW5jZWQgYW5pbWF0aW9ucwogKiAubXktaW5wdXQgewogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiAgIGJhY2tncm91bmQ6IHdoaXRlOwogKiB9CiAqIC5teS1pbnB1dC5uZy1pbnZhbGlkIHsKICogICBiYWNrZ3JvdW5kOiByZWQ7CiAqICAgY29sb3I6d2hpdGU7CiAqIH0KICogPC9wcmU+CiAqCiAqIEBleGFtcGxlCiAqIDxleGFtcGxlIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSIgZml4QmFzZT0idHJ1ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUudmFsID0gJzEnOwogICAgICAgIH0KICAgICAgIDwvc2NyaXB0PgogICAgICAgPHN0eWxlPgogICAgICAgICAubXktaW5wdXQgewogICAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICAgICAgIH0KICAgICAgICAgLm15LWlucHV0Lm5nLWludmFsaWQgewogICAgICAgICAgIGNvbG9yOndoaXRlOwogICAgICAgICAgIGJhY2tncm91bmQ6IHJlZDsKICAgICAgICAgfQogICAgICAgPC9zdHlsZT4KICAgICAgIFVwZGF0ZSBpbnB1dCB0byBzZWUgdHJhbnNpdGlvbnMgd2hlbiB2YWxpZC9pbnZhbGlkLgogICAgICAgSW50ZWdlciBpcyBhIHZhbGlkIHZhbHVlLgogICAgICAgPGZvcm0gbmFtZT0idGVzdEZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8aW5wdXQgbmctbW9kZWw9InZhbCIgbmctcGF0dGVybj0iL15cZCskLyIgbmFtZT0iYW5pbSIgY2xhc3M9Im15LWlucHV0IiAvPgogICAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKi8KdmFyIG5nTW9kZWxEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVxdWlyZTogWyduZ01vZGVsJywgJ14/Zm9ybSddLAogICAgY29udHJvbGxlcjogTmdNb2RlbENvbnRyb2xsZXIsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgLy8gbm90aWZ5IG90aGVycywgZXNwZWNpYWxseSBwYXJlbnQgZm9ybXMKCiAgICAgIHZhciBtb2RlbEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgIGZvcm1DdHJsID0gY3RybHNbMV0gfHwgbnVsbEZvcm1DdHJsOwoKICAgICAgZm9ybUN0cmwuJGFkZENvbnRyb2wobW9kZWxDdHJsKTsKCiAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICBmb3JtQ3RybC4kcmVtb3ZlQ29udHJvbChtb2RlbEN0cmwpOwogICAgICB9KTsKICAgIH0KICB9Owp9OwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2hhbmdlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFdmFsdWF0ZSB0aGUgZ2l2ZW4gZXhwcmVzc2lvbiB3aGVuIHRoZSB1c2VyIGNoYW5nZXMgdGhlIGlucHV0LgogKiBUaGUgZXhwcmVzc2lvbiBpcyBldmFsdWF0ZWQgaW1tZWRpYXRlbHksIHVubGlrZSB0aGUgSmF2YVNjcmlwdCBvbmNoYW5nZSBldmVudAogKiB3aGljaCBvbmx5IHRyaWdnZXJzIGF0IHRoZSBlbmQgb2YgYSBjaGFuZ2UgKHVzdWFsbHksIHdoZW4gdGhlIHVzZXIgbGVhdmVzIHRoZQogKiBmb3JtIGVsZW1lbnQgb3IgcHJlc3NlcyB0aGUgcmV0dXJuIGtleSkuCiAqIFRoZSBleHByZXNzaW9uIGlzIG5vdCBldmFsdWF0ZWQgd2hlbiB0aGUgdmFsdWUgY2hhbmdlIGlzIGNvbWluZyBmcm9tIHRoZSBtb2RlbC4KICoKICogTm90ZSwgdGhpcyBkaXJlY3RpdmUgcmVxdWlyZXMgYG5nTW9kZWxgIHRvIGJlIHByZXNlbnQuCiAqCiAqIEBlbGVtZW50IGlucHV0CiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDaGFuZ2Uge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbiBjaGFuZ2UKICogaW4gaW5wdXQgdmFsdWUuCiAqCiAqIEBleGFtcGxlCiAqIDxleGFtcGxlIG5hbWU9Im5nQ2hhbmdlLWRpcmVjdGl2ZSI+CiAqICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAqICAgICA8c2NyaXB0PgogKiAgICAgICBmdW5jdGlvbiBDb250cm9sbGVyKCRzY29wZSkgewogKiAgICAgICAgICRzY29wZS5jb3VudGVyID0gMDsKICogICAgICAgICAkc2NvcGUuY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAqICAgICAgICAgICAkc2NvcGUuY291bnRlcisrOwogKiAgICAgICAgIH07CiAqICAgICAgIH0KICogICAgIDwvc2NyaXB0PgogKiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDb250cm9sbGVyIj4KICogICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY29uZmlybWVkIiBuZy1jaGFuZ2U9ImNoYW5nZSgpIiBpZD0ibmctY2hhbmdlLWV4YW1wbGUxIiAvPgogKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTIiIC8+CiAqICAgICAgIDxsYWJlbCBmb3I9Im5nLWNoYW5nZS1leGFtcGxlMiI+Q29uZmlybWVkPC9sYWJlbD48YnIgLz4KICogICAgICAgPHR0PmRlYnVnID0ge3tjb25maXJtZWR9fTwvdHQ+PGJyLz4KICogICAgICAgPHR0PmNvdW50ZXIgPSB7e2NvdW50ZXJ9fTwvdHQ+PGJyLz4KICogICAgIDwvZGl2PgogKiAgIDwvZmlsZT4KICogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogICAgIHZhciBjb3VudGVyID0gZWxlbWVudChieS5iaW5kaW5nKCdjb3VudGVyJykpOwogKiAgICAgdmFyIGRlYnVnID0gZWxlbWVudChieS5iaW5kaW5nKCdjb25maXJtZWQnKSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gdmlldycsIGZ1bmN0aW9uKCkgewogKiAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvQ29udGFpbignMCcpOwogKgogKiAgICAgICBlbGVtZW50KGJ5LmlkKCduZy1jaGFuZ2UtZXhhbXBsZTEnKSkuY2xpY2soKTsKICoKICogICAgICAgZXhwZWN0KGNvdW50ZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzEnKTsKICogICAgICAgZXhwZWN0KGRlYnVnLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAqICAgICB9KTsKICoKICogICAgIGl0KCdzaG91bGQgbm90IGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gbW9kZWwnLCBmdW5jdGlvbigpIHsKICogICAgICAgZWxlbWVudChieS5pZCgnbmctY2hhbmdlLWV4YW1wbGUyJykpLmNsaWNrKCk7CgogKiAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvQ29udGFpbignMCcpOwogKiAgICAgICBleHBlY3QoZGVidWcuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICogICAgIH0pOwogKiAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKi8KdmFyIG5nQ2hhbmdlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgcmVxdWlyZTogJ25nTW9kZWwnLAogIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICBjdHJsLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgIHNjb3BlLiRldmFsKGF0dHIubmdDaGFuZ2UpOwogICAgfSk7CiAgfQp9KTsKCgp2YXIgcmVxdWlyZWREaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbG0sIGF0dHIsIGN0cmwpIHsKICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgIGF0dHIucmVxdWlyZWQgPSB0cnVlOyAvLyBmb3JjZSB0cnV0aHkgaW4gY2FzZSB3ZSBhcmUgb24gbm9uIGlucHV0IGVsZW1lbnQKCiAgICAgIHZhciB2YWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmIChhdHRyLnJlcXVpcmVkICYmIGN0cmwuJGlzRW1wdHkodmFsdWUpKSB7CiAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncmVxdWlyZWQnLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIHRydWUpOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaCh2YWxpZGF0b3IpOwogICAgICBjdHJsLiRwYXJzZXJzLnVuc2hpZnQodmFsaWRhdG9yKTsKCiAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFsaWRhdG9yKGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgIH0pOwogICAgfQogIH07Cn07CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdMaXN0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUZXh0IGlucHV0IHRoYXQgY29udmVydHMgYmV0d2VlbiBhIGRlbGltaXRlZCBzdHJpbmcgYW5kIGFuIGFycmF5IG9mIHN0cmluZ3MuIFRoZSBkZWxpbWl0ZXIKICogY2FuIGJlIGEgZml4ZWQgc3RyaW5nIChieSBkZWZhdWx0IGEgY29tbWEpIG9yIGEgcmVndWxhciBleHByZXNzaW9uLgogKgogKiBAZWxlbWVudCBpbnB1dAogKiBAcGFyYW0ge3N0cmluZz19IG5nTGlzdCBvcHRpb25hbCBkZWxpbWl0ZXIgdGhhdCBzaG91bGQgYmUgdXNlZCB0byBzcGxpdCB0aGUgdmFsdWUuIElmCiAqICAgc3BlY2lmaWVkIGluIGZvcm0gYC9zb21ldGhpbmcvYCB0aGVuIHRoZSB2YWx1ZSB3aWxsIGJlIGNvbnZlcnRlZCBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGUgbmFtZT0ibmdMaXN0LWRpcmVjdGl2ZSI+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ2lnb3InLCAnbWlza28nLCAndm9qdGEnXTsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBMaXN0OiA8aW5wdXQgbmFtZT0ibmFtZXNJbnB1dCIgbmctbW9kZWw9Im5hbWVzIiBuZy1saXN0IHJlcXVpcmVkPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5uYW1lc0lucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8YnI+CiAgICAgICAgIDx0dD5uYW1lcyA9IHt7bmFtZXN9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCA9IHt7bXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5uYW1lc0lucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgPC9mb3JtPgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIHZhciBsaXN0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCduYW1lcycpKTsKICAgICAgICB2YXIgbmFtZXMgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3t7bmFtZXN9fScpKTsKICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKTsKICAgICAgICB2YXIgZXJyb3IgPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5lcnJvcicpKTsKCiAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QobmFtZXMuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ1siaWdvciIsIm1pc2tvIiwidm9qdGEiXScpOwogICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICBleHBlY3QoZXJyb3IuZ2V0Q3NzVmFsdWUoJ2Rpc3BsYXknKSkudG9CZSgnbm9uZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGxpc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgbGlzdElucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICBleHBlY3QobmFtZXMuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJycpOwogICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGVycm9yLmdldENzc1ZhbHVlKCdkaXNwbGF5JykpLm5vdC50b0JlKCdub25lJyk7ICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIG5nTGlzdERpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICB2YXIgbWF0Y2ggPSAvXC8oLiopXC8vLmV4ZWMoYXR0ci5uZ0xpc3QpLAogICAgICAgICAgc2VwYXJhdG9yID0gbWF0Y2ggJiYgbmV3IFJlZ0V4cChtYXRjaFsxXSkgfHwgYXR0ci5uZ0xpc3QgfHwgJywnOwoKICAgICAgdmFyIHBhcnNlID0gZnVuY3Rpb24odmlld1ZhbHVlKSB7CiAgICAgICAgLy8gSWYgdGhlIHZpZXdWYWx1ZSBpcyBpbnZhbGlkIChzYXkgcmVxdWlyZWQgYnV0IGVtcHR5KSBpdCB3aWxsIGJlIGB1bmRlZmluZWRgCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZpZXdWYWx1ZSkpIHJldHVybjsKCiAgICAgICAgdmFyIGxpc3QgPSBbXTsKCiAgICAgICAgaWYgKHZpZXdWYWx1ZSkgewogICAgICAgICAgZm9yRWFjaCh2aWV3VmFsdWUuc3BsaXQoc2VwYXJhdG9yKSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlKSBsaXN0LnB1c2godHJpbSh2YWx1ZSkpOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgfTsKCiAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChwYXJzZSk7CiAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIHZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9KTsKCiAgICAgIC8vIE92ZXJyaWRlIHRoZSBzdGFuZGFyZCAkaXNFbXB0eSBiZWNhdXNlIGFuIGVtcHR5IGFycmF5IG1lYW5zIHRoZSBpbnB1dCBpcyBlbXB0eS4KICAgICAgY3RybC4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuICF2YWx1ZSB8fCAhdmFsdWUubGVuZ3RoOwogICAgICB9OwogICAgfQogIH07Cn07CgoKdmFyIENPTlNUQU5UX1ZBTFVFX1JFR0VYUCA9IC9eKHRydWV8ZmFsc2V8XGQrKSQvOwovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1ZhbHVlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBCaW5kcyB0aGUgZ2l2ZW4gZXhwcmVzc2lvbiB0byB0aGUgdmFsdWUgb2YgYGlucHV0W3NlbGVjdF1gIG9yIGBpbnB1dFtyYWRpb11gLCBzbwogKiB0aGF0IHdoZW4gdGhlIGVsZW1lbnQgaXMgc2VsZWN0ZWQsIHRoZSBgbmdNb2RlbGAgb2YgdGhhdCBlbGVtZW50IGlzIHNldCB0byB0aGUKICogYm91bmQgdmFsdWUuCiAqCiAqIGBuZ1ZhbHVlYCBpcyB1c2VmdWwgd2hlbiBkeW5hbWljYWxseSBnZW5lcmF0aW5nIGxpc3RzIG9mIHJhZGlvIGJ1dHRvbnMgdXNpbmcgYG5nLXJlcGVhdGAsIGFzCiAqIHNob3duIGJlbG93LgogKgogKiBAZWxlbWVudCBpbnB1dAogKiBAcGFyYW0ge3N0cmluZz19IG5nVmFsdWUgYW5ndWxhciBleHByZXNzaW9uLCB3aG9zZSB2YWx1ZSB3aWxsIGJlIGJvdW5kIHRvIHRoZSBgdmFsdWVgIGF0dHJpYnV0ZQogKiAgIG9mIHRoZSBgaW5wdXRgIGVsZW1lbnQKICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlIG5hbWU9Im5nVmFsdWUtZGlyZWN0aXZlIj4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLm5hbWVzID0gWydwaXp6YScsICd1bmljb3JucycsICdyb2JvdHMnXTsKICAgICAgICAgICAgJHNjb3BlLm15ID0geyBmYXZvcml0ZTogJ3VuaWNvcm5zJyB9OwogICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICAgPGZvcm0gbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICA8aDI+V2hpY2ggaXMgeW91ciBmYXZvcml0ZT88L2gyPgogICAgICAgICAgICA8bGFiZWwgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIiBmb3I9Int7bmFtZX19Ij4KICAgICAgICAgICAgICB7e25hbWV9fQogICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIKICAgICAgICAgICAgICAgICAgICAgbmctbW9kZWw9Im15LmZhdm9yaXRlIgogICAgICAgICAgICAgICAgICAgICBuZy12YWx1ZT0ibmFtZSIKICAgICAgICAgICAgICAgICAgICAgaWQ9Int7bmFtZX19IgogICAgICAgICAgICAgICAgICAgICBuYW1lPSJmYXZvcml0ZSI+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICA8ZGl2PllvdSBjaG9zZSB7e215LmZhdm9yaXRlfX08L2Rpdj4KICAgICAgICA8L2Zvcm0+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgdmFyIGZhdm9yaXRlID0gZWxlbWVudChieS5iaW5kaW5nKCdteS5mYXZvcml0ZScpKTsKCiAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZmF2b3JpdGUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3VuaWNvcm5zJyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBiaW5kIHRoZSB2YWx1ZXMgdG8gdGhlIGlucHV0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudC5hbGwoYnkubW9kZWwoJ215LmZhdm9yaXRlJykpLmdldCgwKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGZhdm9yaXRlLmdldFRleHQoKSkudG9Db250YWluKCdwaXp6YScpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdWYWx1ZURpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICBwcmlvcml0eTogMTAwLAogICAgY29tcGlsZTogZnVuY3Rpb24odHBsLCB0cGxBdHRyKSB7CiAgICAgIGlmIChDT05TVEFOVF9WQUxVRV9SRUdFWFAudGVzdCh0cGxBdHRyLm5nVmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5nVmFsdWVDb25zdGFudExpbmsoc2NvcGUsIGVsbSwgYXR0cikgewogICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHNjb3BlLiRldmFsKGF0dHIubmdWYWx1ZSkpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5nVmFsdWVMaW5rKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nVmFsdWUsIGZ1bmN0aW9uIHZhbHVlV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9Owp9OwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdCaW5kCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0JpbmRgIGF0dHJpYnV0ZSB0ZWxscyBBbmd1bGFyIHRvIHJlcGxhY2UgdGhlIHRleHQgY29udGVudCBvZiB0aGUgc3BlY2lmaWVkIEhUTUwgZWxlbWVudAogKiB3aXRoIHRoZSB2YWx1ZSBvZiBhIGdpdmVuIGV4cHJlc3Npb24sIGFuZCB0byB1cGRhdGUgdGhlIHRleHQgY29udGVudCB3aGVuIHRoZSB2YWx1ZSBvZiB0aGF0CiAqIGV4cHJlc3Npb24gY2hhbmdlcy4KICoKICogVHlwaWNhbGx5LCB5b3UgZG9uJ3QgdXNlIGBuZ0JpbmRgIGRpcmVjdGx5LCBidXQgaW5zdGVhZCB5b3UgdXNlIHRoZSBkb3VibGUgY3VybHkgbWFya3VwIGxpa2UKICogYHt7IGV4cHJlc3Npb24gfX1gIHdoaWNoIGlzIHNpbWlsYXIgYnV0IGxlc3MgdmVyYm9zZS4KICoKICogSXQgaXMgcHJlZmVyYWJsZSB0byB1c2UgYG5nQmluZGAgaW5zdGVhZCBvZiBge3sgZXhwcmVzc2lvbiB9fWAgd2hlbiBhIHRlbXBsYXRlIGlzIG1vbWVudGFyaWx5CiAqIGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMgcmF3IHN0YXRlIGJlZm9yZSBBbmd1bGFyIGNvbXBpbGVzIGl0LiBTaW5jZSBgbmdCaW5kYCBpcyBhbgogKiBlbGVtZW50IGF0dHJpYnV0ZSwgaXQgbWFrZXMgdGhlIGJpbmRpbmdzIGludmlzaWJsZSB0byB0aGUgdXNlciB3aGlsZSB0aGUgcGFnZSBpcyBsb2FkaW5nLgogKgogKiBBbiBhbHRlcm5hdGl2ZSBzb2x1dGlvbiB0byB0aGlzIHByb2JsZW0gd291bGQgYmUgdXNpbmcgdGhlCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbG9hayBuZ0Nsb2FrfSBkaXJlY3RpdmUuCiAqCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICoKICogQGV4YW1wbGUKICogRW50ZXIgYSBuYW1lIGluIHRoZSBMaXZlIFByZXZpZXcgdGV4dCBib3g7IHRoZSBncmVldGluZyBiZWxvdyB0aGUgdGV4dCBib3ggY2hhbmdlcyBpbnN0YW50bHkuCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXaGlybGVkJzsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBFbnRlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiPjxicj4KICAgICAgICAgSGVsbG8gPHNwYW4gbmctYmluZD0ibmFtZSI+PC9zcGFuPiEKICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgbmFtZUlucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbmFtZScpKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ25hbWUnKSkuZ2V0VGV4dCgpKS50b0JlKCdXaGlybGVkJyk7CiAgICAgICAgIG5hbWVJbnB1dC5jbGVhcigpOwogICAgICAgICBuYW1lSW5wdXQuc2VuZEtleXMoJ3dvcmxkJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ25hbWUnKSkuZ2V0VGV4dCgpKS50b0JlKCd3b3JsZCcpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdCaW5kRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICBlbGVtZW50LmFkZENsYXNzKCduZy1iaW5kaW5nJykuZGF0YSgnJGJpbmRpbmcnLCBhdHRyLm5nQmluZCk7CiAgc2NvcGUuJHdhdGNoKGF0dHIubmdCaW5kLCBmdW5jdGlvbiBuZ0JpbmRXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgLy8gV2UgYXJlIHB1cnBvc2VmdWxseSB1c2luZyA9PSBoZXJlIHJhdGhlciB0aGFuID09PSBiZWNhdXNlIHdlIHdhbnQgdG8KICAgIC8vIGNhdGNoIHdoZW4gdmFsdWUgaXMgIm51bGwgb3IgdW5kZWZpbmVkIgogICAgLy8ganNoaW50IC1XMDQxCiAgICBlbGVtZW50LnRleHQodmFsdWUgPT0gdW5kZWZpbmVkID8gJycgOiB2YWx1ZSk7CiAgfSk7Cn0pOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQmluZFRlbXBsYXRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQmluZFRlbXBsYXRlYCBkaXJlY3RpdmUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICogdGV4dCBjb250ZW50IHNob3VsZCBiZSByZXBsYWNlZCB3aXRoIHRoZSBpbnRlcnBvbGF0aW9uIG9mIHRoZSB0ZW1wbGF0ZQogKiBpbiB0aGUgYG5nQmluZFRlbXBsYXRlYCBhdHRyaWJ1dGUuCiAqIFVubGlrZSBgbmdCaW5kYCwgdGhlIGBuZ0JpbmRUZW1wbGF0ZWAgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAqIGV4cHJlc3Npb25zLiBUaGlzIGRpcmVjdGl2ZSBpcyBuZWVkZWQgc2luY2Ugc29tZSBIVE1MIGVsZW1lbnRzCiAqIChzdWNoIGFzIFRJVExFIGFuZCBPUFRJT04pIGNhbm5vdCBjb250YWluIFNQQU4gZWxlbWVudHMuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge3N0cmluZ30gbmdCaW5kVGVtcGxhdGUgdGVtcGxhdGUgb2YgZm9ybQogKiAgIDx0dD57ezwvdHQ+IDx0dD5leHByZXNzaW9uPC90dD4gPHR0Pn19PC90dD4gdG8gZXZhbC4KICoKICogQGV4YW1wbGUKICogVHJ5IGl0IGhlcmU6IGVudGVyIHRleHQgaW4gdGV4dCBib3ggYW5kIHdhdGNoIHRoZSBncmVldGluZyBjaGFuZ2UuCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUuc2FsdXRhdGlvbiA9ICdIZWxsbyc7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV29ybGQnOwogICAgICAgICB9CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzYWx1dGF0aW9uIj48YnI+CiAgICAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgICAgPHByZSBuZy1iaW5kLXRlbXBsYXRlPSJ7e3NhbHV0YXRpb259fSB7e25hbWV9fSEiPjwvcHJlPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1iaW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzYWx1dGF0aW9uRWxlbSA9IGVsZW1lbnQoYnkuYmluZGluZygnc2FsdXRhdGlvbicpKTsKICAgICAgICAgdmFyIHNhbHV0YXRpb25JbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3NhbHV0YXRpb24nKSk7CiAgICAgICAgIHZhciBuYW1lSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCduYW1lJykpOwoKICAgICAgICAgZXhwZWN0KHNhbHV0YXRpb25FbGVtLmdldFRleHQoKSkudG9CZSgnSGVsbG8gV29ybGQhJyk7CgogICAgICAgICBzYWx1dGF0aW9uSW5wdXQuY2xlYXIoKTsKICAgICAgICAgc2FsdXRhdGlvbklucHV0LnNlbmRLZXlzKCdHcmVldGluZ3MnKTsKICAgICAgICAgbmFtZUlucHV0LmNsZWFyKCk7CiAgICAgICAgIG5hbWVJbnB1dC5zZW5kS2V5cygndXNlcicpOwoKICAgICAgICAgZXhwZWN0KHNhbHV0YXRpb25FbGVtLmdldFRleHQoKSkudG9CZSgnR3JlZXRpbmdzIHVzZXIhJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSA9IFsnJGludGVycG9sYXRlJywgZnVuY3Rpb24oJGludGVycG9sYXRlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci5uZ0JpbmRUZW1wbGF0ZSkpOwogICAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgaW50ZXJwb2xhdGVGbik7CiAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGVsZW1lbnQudGV4dCh2YWx1ZSk7CiAgICB9KTsKICB9Owp9XTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0JpbmRIdG1sCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGEgYmluZGluZyB0aGF0IHdpbGwgaW5uZXJIVE1MIHRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgYGV4cHJlc3Npb25gIGludG8gdGhlIGN1cnJlbnQKICogZWxlbWVudCBpbiBhIHNlY3VyZSB3YXkuICBCeSBkZWZhdWx0LCB0aGUgaW5uZXJIVE1MLWVkIGNvbnRlbnQgd2lsbCBiZSBzYW5pdGl6ZWQgdXNpbmcgdGhlIHtAbGluawogKiBuZ1Nhbml0aXplLiRzYW5pdGl6ZSAkc2FuaXRpemV9IHNlcnZpY2UuICBUbyB1dGlsaXplIHRoaXMgZnVuY3Rpb25hbGl0eSwgZW5zdXJlIHRoYXQgYCRzYW5pdGl6ZWAKICogaXMgYXZhaWxhYmxlLCBmb3IgZXhhbXBsZSwgYnkgaW5jbHVkaW5nIHtAbGluayBuZ1Nhbml0aXplfSBpbiB5b3VyIG1vZHVsZSdzIGRlcGVuZGVuY2llcyAobm90IGluCiAqIGNvcmUgQW5ndWxhci4pICBZb3UgbWF5IGFsc28gYnlwYXNzIHNhbml0aXphdGlvbiBmb3IgdmFsdWVzIHlvdSBrbm93IGFyZSBzYWZlLiBUbyBkbyBzbywgYmluZCB0bwogKiBhbiBleHBsaWNpdGx5IHRydXN0ZWQgdmFsdWUgdmlhIHtAbGluayBuZy4kc2NlI3RydXN0QXNIdG1sICRzY2UudHJ1c3RBc0h0bWx9LiAgU2VlIHRoZSBleGFtcGxlCiAqIHVuZGVyIHtAbGluayBuZy4kc2NlI0V4YW1wbGUgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSl9LgogKgogKiBOb3RlOiBJZiBhIGAkc2FuaXRpemVgIHNlcnZpY2UgaXMgdW5hdmFpbGFibGUgYW5kIHRoZSBib3VuZCB2YWx1ZSBpc24ndCBleHBsaWNpdGx5IHRydXN0ZWQsIHlvdQogKiB3aWxsIGhhdmUgYW4gZXhjZXB0aW9uIChpbnN0ZWFkIG9mIGFuIGV4cGxvaXQuKQogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0JpbmRIdG1sIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlLgogKgogKiBAZXhhbXBsZQogICBUcnkgaXQgaGVyZTogZW50ZXIgdGV4dCBpbiB0ZXh0IGJveCBhbmQgd2F0Y2ggdGhlIGdyZWV0aW5nIGNoYW5nZS4KCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdCaW5kSHRtbEV4YW1wbGUiIGRlcHM9ImFuZ3VsYXItc2FuaXRpemUuanMiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJuZ0JpbmRIdG1sQ3RybCI+CiAgICAgICAgPHAgbmctYmluZC1odG1sPSJteUhUTUwiPjwvcD4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgIGFuZ3VsYXIubW9kdWxlKCduZ0JpbmRIdG1sRXhhbXBsZScsIFsnbmdTYW5pdGl6ZSddKQoKICAgICAgIC5jb250cm9sbGVyKCduZ0JpbmRIdG1sQ3RybCcsIFsnJHNjb3BlJywgZnVuY3Rpb24gbmdCaW5kSHRtbEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICRzY29wZS5teUhUTUwgPQogICAgICAgICAgICAnSSBhbSBhbiA8Y29kZT5IVE1MPC9jb2RlPnN0cmluZyB3aXRoIDxhIGhyZWY9IiMiPmxpbmtzITwvYT4gYW5kIG90aGVyIDxlbT5zdHVmZjwvZW0+JzsKICAgICAgIH1dKTsKICAgICA8L2ZpbGU+CgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1iaW5kLWh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbXlIVE1MJykpLmdldFRleHQoKSkudG9CZSgKICAgICAgICAgICAgICdJIGFtIGFuIEhUTUxzdHJpbmcgd2l0aCBsaW5rcyEgYW5kIG90aGVyIHN0dWZmJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0JpbmRIdG1sRGlyZWN0aXZlID0gWyckc2NlJywgJyRwYXJzZScsIGZ1bmN0aW9uKCRzY2UsICRwYXJzZSkgewogIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgYXR0ci5uZ0JpbmRIdG1sKTsKCiAgICB2YXIgcGFyc2VkID0gJHBhcnNlKGF0dHIubmdCaW5kSHRtbCk7CiAgICBmdW5jdGlvbiBnZXRTdHJpbmdWYWx1ZSgpIHsgcmV0dXJuIChwYXJzZWQoc2NvcGUpIHx8ICcnKS50b1N0cmluZygpOyB9CgogICAgc2NvcGUuJHdhdGNoKGdldFN0cmluZ1ZhbHVlLCBmdW5jdGlvbiBuZ0JpbmRIdG1sV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgZWxlbWVudC5odG1sKCRzY2UuZ2V0VHJ1c3RlZEh0bWwocGFyc2VkKHNjb3BlKSkgfHwgJycpOwogICAgfSk7CiAgfTsKfV07CgpmdW5jdGlvbiBjbGFzc0RpcmVjdGl2ZShuYW1lLCBzZWxlY3RvcikgewogIG5hbWUgPSAnbmdDbGFzcycgKyBuYW1lOwogIHJldHVybiBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQUMnLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHZhciBvbGRWYWw7CgogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25hbWVdLCBuZ0NsYXNzV2F0Y2hBY3Rpb24sIHRydWUpOwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCdjbGFzcycsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBuZ0NsYXNzV2F0Y2hBY3Rpb24oc2NvcGUuJGV2YWwoYXR0cltuYW1lXSkpOwogICAgICAgIH0pOwoKCiAgICAgICAgaWYgKG5hbWUgIT09ICduZ0NsYXNzJykgewogICAgICAgICAgc2NvcGUuJHdhdGNoKCckaW5kZXgnLCBmdW5jdGlvbigkaW5kZXgsIG9sZCRpbmRleCkgewogICAgICAgICAgICAvLyBqc2hpbnQgYml0d2lzZTogZmFsc2UKICAgICAgICAgICAgdmFyIG1vZCA9ICRpbmRleCAmIDE7CiAgICAgICAgICAgIGlmIChtb2QgIT09IChvbGQkaW5kZXggJiAxKSkgewogICAgICAgICAgICAgIHZhciBjbGFzc2VzID0gYXJyYXlDbGFzc2VzKHNjb3BlLiRldmFsKGF0dHJbbmFtZV0pKTsKICAgICAgICAgICAgICBtb2QgPT09IHNlbGVjdG9yID8KICAgICAgICAgICAgICAgIGFkZENsYXNzZXMoY2xhc3NlcykgOgogICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3NlcyhjbGFzc2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRDbGFzc2VzKGNsYXNzZXMpIHsKICAgICAgICAgIHZhciBuZXdDbGFzc2VzID0gZGlnZXN0Q2xhc3NDb3VudHMoY2xhc3NlcywgMSk7CiAgICAgICAgICBhdHRyLiRhZGRDbGFzcyhuZXdDbGFzc2VzKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNsYXNzZXMoY2xhc3NlcykgewogICAgICAgICAgdmFyIG5ld0NsYXNzZXMgPSBkaWdlc3RDbGFzc0NvdW50cyhjbGFzc2VzLCAtMSk7CiAgICAgICAgICBhdHRyLiRyZW1vdmVDbGFzcyhuZXdDbGFzc2VzKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRpZ2VzdENsYXNzQ291bnRzIChjbGFzc2VzLCBjb3VudCkgewogICAgICAgICAgdmFyIGNsYXNzQ291bnRzID0gZWxlbWVudC5kYXRhKCckY2xhc3NDb3VudHMnKSB8fCB7fTsKICAgICAgICAgIHZhciBjbGFzc2VzVG9VcGRhdGUgPSBbXTsKICAgICAgICAgIGZvckVhY2goY2xhc3NlcywgZnVuY3Rpb24gKGNsYXNzTmFtZSkgewogICAgICAgICAgICBpZiAoY291bnQgPiAwIHx8IGNsYXNzQ291bnRzW2NsYXNzTmFtZV0pIHsKICAgICAgICAgICAgICBjbGFzc0NvdW50c1tjbGFzc05hbWVdID0gKGNsYXNzQ291bnRzW2NsYXNzTmFtZV0gfHwgMCkgKyBjb3VudDsKICAgICAgICAgICAgICBpZiAoY2xhc3NDb3VudHNbY2xhc3NOYW1lXSA9PT0gKyhjb3VudCA+IDApKSB7CiAgICAgICAgICAgICAgICBjbGFzc2VzVG9VcGRhdGUucHVzaChjbGFzc05hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBlbGVtZW50LmRhdGEoJyRjbGFzc0NvdW50cycsIGNsYXNzQ291bnRzKTsKICAgICAgICAgIHJldHVybiBjbGFzc2VzVG9VcGRhdGUuam9pbignICcpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2xhc3NlcyAob2xkQ2xhc3NlcywgbmV3Q2xhc3NlcykgewogICAgICAgICAgdmFyIHRvQWRkID0gYXJyYXlEaWZmZXJlbmNlKG5ld0NsYXNzZXMsIG9sZENsYXNzZXMpOwogICAgICAgICAgdmFyIHRvUmVtb3ZlID0gYXJyYXlEaWZmZXJlbmNlKG9sZENsYXNzZXMsIG5ld0NsYXNzZXMpOwogICAgICAgICAgdG9SZW1vdmUgPSBkaWdlc3RDbGFzc0NvdW50cyh0b1JlbW92ZSwgLTEpOwogICAgICAgICAgdG9BZGQgPSBkaWdlc3RDbGFzc0NvdW50cyh0b0FkZCwgMSk7CgogICAgICAgICAgaWYgKHRvQWRkLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCB0b1JlbW92ZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRvUmVtb3ZlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCB0b0FkZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkYW5pbWF0ZS5zZXRDbGFzcyhlbGVtZW50LCB0b0FkZCwgdG9SZW1vdmUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbmdDbGFzc1dhdGNoQWN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgaWYgKHNlbGVjdG9yID09PSB0cnVlIHx8IHNjb3BlLiRpbmRleCAlIDIgPT09IHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHZhciBuZXdDbGFzc2VzID0gYXJyYXlDbGFzc2VzKG5ld1ZhbCB8fCBbXSk7CiAgICAgICAgICAgIGlmICghb2xkVmFsKSB7CiAgICAgICAgICAgICAgYWRkQ2xhc3NlcyhuZXdDbGFzc2VzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghZXF1YWxzKG5ld1ZhbCxvbGRWYWwpKSB7CiAgICAgICAgICAgICAgdmFyIG9sZENsYXNzZXMgPSBhcnJheUNsYXNzZXMob2xkVmFsKTsKICAgICAgICAgICAgICB1cGRhdGVDbGFzc2VzKG9sZENsYXNzZXMsIG5ld0NsYXNzZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBvbGRWYWwgPSBzaGFsbG93Q29weShuZXdWYWwpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBhcnJheURpZmZlcmVuY2UodG9rZW5zMSwgdG9rZW5zMikgewogICAgICB2YXIgdmFsdWVzID0gW107CgogICAgICBvdXRlcjoKICAgICAgZm9yKHZhciBpID0gMDsgaSA8IHRva2VuczEubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnMxW2ldOwogICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCB0b2tlbnMyLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZih0b2tlbiA9PSB0b2tlbnMyW2pdKSBjb250aW51ZSBvdXRlcjsKICAgICAgICB9CiAgICAgICAgdmFsdWVzLnB1c2godG9rZW4pOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9CgogICAgZnVuY3Rpb24gYXJyYXlDbGFzc2VzIChjbGFzc1ZhbCkgewogICAgICBpZiAoaXNBcnJheShjbGFzc1ZhbCkpIHsKICAgICAgICByZXR1cm4gY2xhc3NWYWw7CiAgICAgIH0gZWxzZSBpZiAoaXNTdHJpbmcoY2xhc3NWYWwpKSB7CiAgICAgICAgcmV0dXJuIGNsYXNzVmFsLnNwbGl0KCcgJyk7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoY2xhc3NWYWwpKSB7CiAgICAgICAgdmFyIGNsYXNzZXMgPSBbXSwgaSA9IDA7CiAgICAgICAgZm9yRWFjaChjbGFzc1ZhbCwgZnVuY3Rpb24odiwgaykgewogICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KGsuc3BsaXQoJyAnKSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNsYXNzZXM7CiAgICAgIH0KICAgICAgcmV0dXJuIGNsYXNzVmFsOwogICAgfQogIH1dOwp9CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NsYXNzCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0NsYXNzYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBkeW5hbWljYWxseSBzZXQgQ1NTIGNsYXNzZXMgb24gYW4gSFRNTCBlbGVtZW50IGJ5IGRhdGFiaW5kaW5nCiAqIGFuIGV4cHJlc3Npb24gdGhhdCByZXByZXNlbnRzIGFsbCBjbGFzc2VzIHRvIGJlIGFkZGVkLgogKgogKiBUaGUgZGlyZWN0aXZlIG9wZXJhdGVzIGluIHRocmVlIGRpZmZlcmVudCB3YXlzLCBkZXBlbmRpbmcgb24gd2hpY2ggb2YgdGhyZWUgdHlwZXMgdGhlIGV4cHJlc3Npb24KICogZXZhbHVhdGVzIHRvOgogKgogKiAxLiBJZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBzdHJpbmcsIHRoZSBzdHJpbmcgc2hvdWxkIGJlIG9uZSBvciBtb3JlIHNwYWNlLWRlbGltaXRlZCBjbGFzcwogKiBuYW1lcy4KICoKICogMi4gSWYgdGhlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGFuIGFycmF5LCBlYWNoIGVsZW1lbnQgb2YgdGhlIGFycmF5IHNob3VsZCBiZSBhIHN0cmluZyB0aGF0IGlzCiAqIG9uZSBvciBtb3JlIHNwYWNlLWRlbGltaXRlZCBjbGFzcyBuYW1lcy4KICoKICogMy4gSWYgdGhlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGFuIG9iamVjdCwgdGhlbiBmb3IgZWFjaCBrZXktdmFsdWUgcGFpciBvZiB0aGUKICogb2JqZWN0IHdpdGggYSB0cnV0aHkgdmFsdWUgdGhlIGNvcnJlc3BvbmRpbmcga2V5IGlzIHVzZWQgYXMgYSBjbGFzcyBuYW1lLgogKgogKiBUaGUgZGlyZWN0aXZlIHdvbid0IGFkZCBkdXBsaWNhdGUgY2xhc3NlcyBpZiBhIHBhcnRpY3VsYXIgY2xhc3Mgd2FzIGFscmVhZHkgc2V0LgogKgogKiBXaGVuIHRoZSBleHByZXNzaW9uIGNoYW5nZXMsIHRoZSBwcmV2aW91c2x5IGFkZGVkIGNsYXNzZXMgYXJlIHJlbW92ZWQgYW5kIG9ubHkgdGhlbiB0aGUKICogbmV3IGNsYXNzZXMgYXJlIGFkZGVkLgogKgogKiBAYW5pbWF0aW9ucwogKiBhZGQgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBjbGFzcyBpcyBhcHBsaWVkIHRvIHRoZSBlbGVtZW50CiAqIHJlbW92ZSAtIGhhcHBlbnMganVzdCBiZWZvcmUgdGhlIGNsYXNzIGlzIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcwogKiAgIG5hbWVzLCBhbiBhcnJheSwgb3IgYSBtYXAgb2YgY2xhc3MgbmFtZXMgdG8gYm9vbGVhbiB2YWx1ZXMuIEluIHRoZSBjYXNlIG9mIGEgbWFwLCB0aGUKICogICBuYW1lcyBvZiB0aGUgcHJvcGVydGllcyB3aG9zZSB2YWx1ZXMgYXJlIHRydXRoeSB3aWxsIGJlIGFkZGVkIGFzIGNzcyBjbGFzc2VzIHRvIHRoZQogKiAgIGVsZW1lbnQuCiAqCiAqIEBleGFtcGxlIEV4YW1wbGUgdGhhdCBkZW1vbnN0cmF0ZXMgYmFzaWMgYmluZGluZ3MgdmlhIG5nQ2xhc3MgZGlyZWN0aXZlLgogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxwIG5nLWNsYXNzPSJ7c3RyaWtlOiBkZWxldGVkLCBib2xkOiBpbXBvcnRhbnQsIHJlZDogZXJyb3J9Ij5NYXAgU3ludGF4IEV4YW1wbGU8L3A+CiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJkZWxldGVkIj4gZGVsZXRlZCAoYXBwbHkgInN0cmlrZSIgY2xhc3MpPGJyPgogICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iaW1wb3J0YW50Ij4gaW1wb3J0YW50IChhcHBseSAiYm9sZCIgY2xhc3MpPGJyPgogICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iZXJyb3IiPiBlcnJvciAoYXBwbHkgInJlZCIgY2xhc3MpCiAgICAgICA8aHI+CiAgICAgICA8cCBuZy1jbGFzcz0ic3R5bGUiPlVzaW5nIFN0cmluZyBTeW50YXg8L3A+CiAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InN0eWxlIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCBzdHJpa2UgcmVkIj4KICAgICAgIDxocj4KICAgICAgIDxwIG5nLWNsYXNzPSJbc3R5bGUxLCBzdHlsZTIsIHN0eWxlM10iPlVzaW5nIEFycmF5IFN5bnRheDwvcD4KICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUxIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCwgc3RyaWtlIG9yIHJlZCI+PGJyPgogICAgICAgPGlucHV0IG5nLW1vZGVsPSJzdHlsZTIiIHBsYWNlaG9sZGVyPSJUeXBlOiBib2xkLCBzdHJpa2Ugb3IgcmVkIj48YnI+CiAgICAgICA8aW5wdXQgbmctbW9kZWw9InN0eWxlMyIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQsIHN0cmlrZSBvciByZWQiPjxicj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgIC5zdHJpa2UgewogICAgICAgICB0ZXh0LWRlY29yYXRpb246IGxpbmUtdGhyb3VnaDsKICAgICAgIH0KICAgICAgIC5ib2xkIHsKICAgICAgICAgICBmb250LXdlaWdodDogYm9sZDsKICAgICAgIH0KICAgICAgIC5yZWQgewogICAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgdmFyIHBzID0gZWxlbWVudC5hbGwoYnkuY3NzKCdwJykpOwoKICAgICAgIGl0KCdzaG91bGQgbGV0IHlvdSB0b2dnbGUgdGhlIGNsYXNzJywgZnVuY3Rpb24oKSB7CgogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC50b01hdGNoKC9ib2xkLyk7CiAgICAgICAgIGV4cGVjdChwcy5maXJzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkubm90LnRvTWF0Y2goL3JlZC8pOwoKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnaW1wb3J0YW50JykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChwcy5maXJzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9NYXRjaCgvYm9sZC8pOwoKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnZXJyb3InKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHBzLmZpcnN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b01hdGNoKC9yZWQvKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgbGV0IHlvdSB0b2dnbGUgc3RyaW5nIGV4YW1wbGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHBzLmdldCgxKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJycpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZScpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZScpKS5zZW5kS2V5cygncmVkJyk7CiAgICAgICAgIGV4cGVjdChwcy5nZXQoMSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b0JlKCdyZWQnKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdhcnJheSBleGFtcGxlIHNob3VsZCBoYXZlIDMgY2xhc3NlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QocHMubGFzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9CZSgnJyk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlMScpKS5zZW5kS2V5cygnYm9sZCcpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZTInKSkuc2VuZEtleXMoJ3N0cmlrZScpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZTMnKSkuc2VuZEtleXMoJ3JlZCcpOwogICAgICAgICBleHBlY3QocHMubGFzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9CZSgnYm9sZCBzdHJpa2UgcmVkJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KCiAgICMjIEFuaW1hdGlvbnMKCiAgIFRoZSBleGFtcGxlIGJlbG93IGRlbW9uc3RyYXRlcyBob3cgdG8gcGVyZm9ybSBhbmltYXRpb25zIHVzaW5nIG5nQ2xhc3MuCgogICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGlucHV0IGlkPSJzZXRidG4iIHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15VmFyPSdteS1jbGFzcyciPgogICAgICA8aW5wdXQgaWQ9ImNsZWFyYnRuIiB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15VmFyPScnIj4KICAgICAgPGJyPgogICAgICA8c3BhbiBjbGFzcz0iYmFzZS1jbGFzcyIgbmctY2xhc3M9Im15VmFyIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgIC5iYXNlLWNsYXNzIHsKICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgIH0KCiAgICAgICAuYmFzZS1jbGFzcy5teS1jbGFzcyB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICAgIGZvbnQtc2l6ZTozZW07CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5iYXNlLWNsYXNzJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkubm90LgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CgogICAgICAgICBlbGVtZW50KGJ5LmlkKCdzZXRidG4nKSkuY2xpY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnLmJhc2UtY2xhc3MnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwoKICAgICAgICAgZWxlbWVudChieS5pZCgnY2xlYXJidG4nKSkuY2xpY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnLmJhc2UtY2xhc3MnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS5ub3QuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgoKCiAgICMjIG5nQ2xhc3MgYW5kIHByZS1leGlzdGluZyBDU1MzIFRyYW5zaXRpb25zL0FuaW1hdGlvbnMKICAgVGhlIG5nQ2xhc3MgZGlyZWN0aXZlIHN0aWxsIHN1cHBvcnRzIENTUzMgVHJhbnNpdGlvbnMvQW5pbWF0aW9ucyBldmVuIGlmIHRoZXkgZG8gbm90IGZvbGxvdyB0aGUgbmdBbmltYXRlIENTUyBuYW1pbmcgc3RydWN0dXJlLgogICBVcG9uIGFuaW1hdGlvbiBuZ0FuaW1hdGUgd2lsbCBhcHBseSBzdXBwbGVtZW50YXJ5IENTUyBjbGFzc2VzIHRvIHRyYWNrIHRoZSBzdGFydCBhbmQgZW5kIG9mIGFuIGFuaW1hdGlvbiwgYnV0IHRoaXMgd2lsbCBub3QgaGluZGVyCiAgIGFueSBwcmUtZXhpc3RpbmcgQ1NTIHRyYW5zaXRpb25zIGFscmVhZHkgb24gdGhlIGVsZW1lbnQuIFRvIGdldCBhbiBpZGVhIG9mIHdoYXQgaGFwcGVucyBkdXJpbmcgYSBjbGFzcy1iYXNlZCBhbmltYXRpb24sIGJlIHN1cmUKICAgdG8gdmlldyB0aGUgc3RlcCBieSBzdGVwIGRldGFpbHMgb2Yge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZSNhZGRjbGFzcyAkYW5pbWF0ZS5hZGRDbGFzc30gYW5kCiAgIHtAbGluayBuZ0FuaW1hdGUuJGFuaW1hdGUjcmVtb3ZlY2xhc3MgJGFuaW1hdGUucmVtb3ZlQ2xhc3N9LgogKi8KdmFyIG5nQ2xhc3NEaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnJywgdHJ1ZSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NsYXNzT2RkCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCB0aGV5IHdvcmsgaW4KICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlIGVmZmVjdCBvbmx5IG9uIG9kZCAoZXZlbikgcm93cy4KICoKICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gdGhlIHNjb3BlIG9mIGFuCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzT2RkIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPG9sIG5nLWluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgICAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICAgICAgICAgIHt7bmFtZX19CiAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgPC9saT4KICAgICAgICA8L29sPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDApLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygxKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9ldmVuLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0NsYXNzT2RkRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ09kZCcsIDApOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDbGFzc0V2ZW4KICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyBuZ0NsYXNzfSwgZXhjZXB0IHRoZXkgd29yayBpbgogKiBjb25qdW5jdGlvbiB3aXRoIGBuZ1JlcGVhdGAgYW5kIHRha2UgZWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogKgogKiBUaGlzIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCBvbmx5IHdpdGhpbiB0aGUgc2NvcGUgb2YgYW4KICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NFdmVuIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZQogKiAgIHJlc3VsdCBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPG9sIG5nLWluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgICAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICAgICAgICAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgPC9saT4KICAgICAgICA8L29sPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDApLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygxKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9ldmVuLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdFdmVuJywgMSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0Nsb2FrCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBBbmd1bGFyIGh0bWwgdGVtcGxhdGUgZnJvbSBiZWluZyBicmllZmx5CiAqIGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMgcmF3ICh1bmNvbXBpbGVkKSBmb3JtIHdoaWxlIHlvdXIgYXBwbGljYXRpb24gaXMgbG9hZGluZy4gVXNlIHRoaXMKICogZGlyZWN0aXZlIHRvIGF2b2lkIHRoZSB1bmRlc2lyYWJsZSBmbGlja2VyIGVmZmVjdCBjYXVzZWQgYnkgdGhlIGh0bWwgdGVtcGxhdGUgZGlzcGxheS4KICoKICogVGhlIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCB0byB0aGUgYDxib2R5PmAgZWxlbWVudCwgYnV0IHRoZSBwcmVmZXJyZWQgdXNhZ2UgaXMgdG8gYXBwbHkKICogbXVsdGlwbGUgYG5nQ2xvYWtgIGRpcmVjdGl2ZXMgdG8gc21hbGwgcG9ydGlvbnMgb2YgdGhlIHBhZ2UgdG8gcGVybWl0IHByb2dyZXNzaXZlIHJlbmRlcmluZwogKiBvZiB0aGUgYnJvd3NlciB2aWV3LgogKgogKiBgbmdDbG9ha2Agd29ya3MgaW4gY29vcGVyYXRpb24gd2l0aCB0aGUgZm9sbG93aW5nIGNzcyBydWxlIGVtYmVkZGVkIHdpdGhpbiBgYW5ndWxhci5qc2AgYW5kCiAqIGBhbmd1bGFyLm1pbi5qc2AuCiAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogKgogKiBgYGBjc3MKICogW25nXDpjbG9ha10sIFtuZy1jbG9ha10sIFtkYXRhLW5nLWNsb2FrXSwgW3gtbmctY2xvYWtdLCAubmctY2xvYWssIC54LW5nLWNsb2FrIHsKICogICBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7CiAqIH0KICogYGBgCiAqCiAqIFdoZW4gdGhpcyBjc3MgcnVsZSBpcyBsb2FkZWQgYnkgdGhlIGJyb3dzZXIsIGFsbCBodG1sIGVsZW1lbnRzIChpbmNsdWRpbmcgdGhlaXIgY2hpbGRyZW4pIHRoYXQKICogYXJlIHRhZ2dlZCB3aXRoIHRoZSBgbmdDbG9ha2AgZGlyZWN0aXZlIGFyZSBoaWRkZW4uIFdoZW4gQW5ndWxhciBlbmNvdW50ZXJzIHRoaXMgZGlyZWN0aXZlCiAqIGR1cmluZyB0aGUgY29tcGlsYXRpb24gb2YgdGhlIHRlbXBsYXRlIGl0IGRlbGV0ZXMgdGhlIGBuZ0Nsb2FrYCBlbGVtZW50IGF0dHJpYnV0ZSwgbWFraW5nCiAqIHRoZSBjb21waWxlZCBlbGVtZW50IHZpc2libGUuCiAqCiAqIEZvciB0aGUgYmVzdCByZXN1bHQsIHRoZSBgYW5ndWxhci5qc2Agc2NyaXB0IG11c3QgYmUgbG9hZGVkIGluIHRoZSBoZWFkIHNlY3Rpb24gb2YgdGhlIGh0bWwKICogZG9jdW1lbnQ7IGFsdGVybmF0aXZlbHksIHRoZSBjc3MgcnVsZSBhYm92ZSBtdXN0IGJlIGluY2x1ZGVkIGluIHRoZSBleHRlcm5hbCBzdHlsZXNoZWV0IG9mIHRoZQogKiBhcHBsaWNhdGlvbi4KICoKICogTGVnYWN5IGJyb3dzZXJzLCBsaWtlIElFNywgZG8gbm90IHByb3ZpZGUgYXR0cmlidXRlIHNlbGVjdG9yIHN1cHBvcnQgKGFkZGVkIGluIENTUyAyLjEpIHNvIHRoZXkKICogY2Fubm90IG1hdGNoIHRoZSBgW25nXDpjbG9ha11gIHNlbGVjdG9yLiBUbyB3b3JrIGFyb3VuZCB0aGlzIGxpbWl0YXRpb24sIHlvdSBtdXN0IGFkZCB0aGUgY3NzCiAqIGNsYXNzIGBuZy1jbG9ha2AgaW4gYWRkaXRpb24gdG8gdGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgYXMgc2hvd24gaW4gdGhlIGV4YW1wbGUgYmVsb3cuCiAqCiAqIEBlbGVtZW50IEFOWQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTEiIG5nLWNsb2FrPnt7ICdoZWxsbycgfX08L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTIiIG5nLWNsb2FrIGNsYXNzPSJuZy1jbG9hayI+e3sgJ2hlbGxvIElFNycgfX08L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgdGVtcGxhdGUgZGlyZWN0aXZlIGFuZCBjc3MgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KCQoJyN0ZW1wbGF0ZTEnKS5nZXRBdHRyaWJ1dGUoJ25nLWNsb2FrJykpLgogICAgICAgICAgIHRvQmVOdWxsKCk7CiAgICAgICAgIGV4cGVjdCgkKCcjdGVtcGxhdGUyJykuZ2V0QXR0cmlidXRlKCduZy1jbG9haycpKS4KICAgICAgICAgICB0b0JlTnVsbCgpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqCiAqLwp2YXIgbmdDbG9ha0RpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICBhdHRyLiRzZXQoJ25nQ2xvYWsnLCB1bmRlZmluZWQpOwogICAgZWxlbWVudC5yZW1vdmVDbGFzcygnbmctY2xvYWsnKTsKICB9Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDb250cm9sbGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlIGF0dGFjaGVzIGEgY29udHJvbGxlciBjbGFzcyB0byB0aGUgdmlldy4gVGhpcyBpcyBhIGtleSBhc3BlY3Qgb2YgaG93IGFuZ3VsYXIKICogc3VwcG9ydHMgdGhlIHByaW5jaXBsZXMgYmVoaW5kIHRoZSBNb2RlbC1WaWV3LUNvbnRyb2xsZXIgZGVzaWduIHBhdHRlcm4uCiAqCiAqIE1WQyBjb21wb25lbnRzIGluIGFuZ3VsYXI6CiAqCiAqICogTW9kZWwg4oCUIFRoZSBNb2RlbCBpcyBzY29wZSBwcm9wZXJ0aWVzOyBzY29wZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSBET00gd2hlcmUgc2NvcGUgcHJvcGVydGllcwogKiAgIGFyZSBhY2Nlc3NlZCB0aHJvdWdoIGJpbmRpbmdzLgogKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIHRoYXQgaXMgcmVuZGVyZWQgaW50byB0aGUgVmlldy4KICogKiBDb250cm9sbGVyIOKAlCBUaGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlIHNwZWNpZmllcyBhIENvbnRyb2xsZXIgY2xhc3M7IHRoZSBjbGFzcyBjb250YWlucyBidXNpbmVzcwogKiAgIGxvZ2ljIGJlaGluZCB0aGUgYXBwbGljYXRpb24gdG8gZGVjb3JhdGUgdGhlIHNjb3BlIHdpdGggZnVuY3Rpb25zIGFuZCB2YWx1ZXMKICoKICogTm90ZSB0aGF0IHlvdSBjYW4gYWxzbyBhdHRhY2ggY29udHJvbGxlcnMgdG8gdGhlIERPTSBieSBkZWNsYXJpbmcgaXQgaW4gYSByb3V0ZSBkZWZpbml0aW9uCiAqIHZpYSB0aGUge0BsaW5rIG5nUm91dGUuJHJvdXRlICRyb3V0ZX0gc2VydmljZS4gQSBjb21tb24gbWlzdGFrZSBpcyB0byBkZWNsYXJlIHRoZSBjb250cm9sbGVyCiAqIGFnYWluIHVzaW5nIGBuZy1jb250cm9sbGVyYCBpbiB0aGUgdGVtcGxhdGUgaXRzZWxmLiAgVGhpcyB3aWxsIGNhdXNlIHRoZSBjb250cm9sbGVyIHRvIGJlIGF0dGFjaGVkCiAqIGFuZCBleGVjdXRlZCB0d2ljZS4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBzY29wZQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ29udHJvbGxlciBOYW1lIG9mIGEgZ2xvYmFsbHkgYWNjZXNzaWJsZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBvciBhbgogKiAgICAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gdGhhdCBvbiB0aGUgY3VycmVudCBzY29wZSBldmFsdWF0ZXMgdG8gYQogKiAgICAgY29uc3RydWN0b3IgZnVuY3Rpb24uIFRoZSBjb250cm9sbGVyIGluc3RhbmNlIGNhbiBiZSBwdWJsaXNoZWQgaW50byBhIHNjb3BlIHByb3BlcnR5CiAqICAgICBieSBzcGVjaWZ5aW5nIGBhcyBwcm9wZXJ0eU5hbWVgLgogKgogKiBAZXhhbXBsZQogKiBIZXJlIGlzIGEgc2ltcGxlIGZvcm0gZm9yIGVkaXRpbmcgdXNlciBjb250YWN0IGluZm9ybWF0aW9uLiBBZGRpbmcsIHJlbW92aW5nLCBjbGVhcmluZywgYW5kCiAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAqIGVhc2lseSBiZSBjYWxsZWQgZnJvbSB0aGUgYW5ndWxhciBtYXJrdXAuIEFueSBjaGFuZ2VzIHRvIHRoZSBkYXRhIGFyZSBhdXRvbWF0aWNhbGx5IHJlZmxlY3RlZAogKiBpbiB0aGUgVmlldyB3aXRob3V0IHRoZSBuZWVkIGZvciBhIG1hbnVhbCB1cGRhdGUuCiAqCiAqIFR3byBkaWZmZXJlbnQgZGVjbGFyYXRpb24gc3R5bGVzIGFyZSBpbmNsdWRlZCBiZWxvdzoKICoKICogKiBvbmUgYmluZHMgbWV0aG9kcyBhbmQgcHJvcGVydGllcyBkaXJlY3RseSBvbnRvIHRoZSBjb250cm9sbGVyIHVzaW5nIGB0aGlzYDoKICogYG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjEgYXMgc2V0dGluZ3MiYAogKiAqIG9uZSBpbmplY3RzIGAkc2NvcGVgIGludG8gdGhlIGNvbnRyb2xsZXI6CiAqIGBuZy1jb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIyImAKICoKICogVGhlIHNlY29uZCBvcHRpb24gaXMgbW9yZSBjb21tb24gaW4gdGhlIEFuZ3VsYXIgY29tbXVuaXR5LCBhbmQgaXMgZ2VuZXJhbGx5IHVzZWQgaW4gYm9pbGVycGxhdGVzCiAqIGFuZCBpbiB0aGlzIGd1aWRlLiBIb3dldmVyLCB0aGVyZSBhcmUgYWR2YW50YWdlcyB0byBiaW5kaW5nIHByb3BlcnRpZXMgZGlyZWN0bHkgdG8gdGhlIGNvbnRyb2xsZXIKICogYW5kIGF2b2lkaW5nIHNjb3BlLgogKgogKiAqIFVzaW5nIGBjb250cm9sbGVyIGFzYCBtYWtlcyBpdCBvYnZpb3VzIHdoaWNoIGNvbnRyb2xsZXIgeW91IGFyZSBhY2Nlc3NpbmcgaW4gdGhlIHRlbXBsYXRlIHdoZW4KICogbXVsdGlwbGUgY29udHJvbGxlcnMgYXBwbHkgdG8gYW4gZWxlbWVudC4KICogKiBJZiB5b3UgYXJlIHdyaXRpbmcgeW91ciBjb250cm9sbGVycyBhcyBjbGFzc2VzIHlvdSBoYXZlIGVhc2llciBhY2Nlc3MgdG8gdGhlIHByb3BlcnRpZXMgYW5kCiAqIG1ldGhvZHMsIHdoaWNoIHdpbGwgYXBwZWFyIG9uIHRoZSBzY29wZSwgZnJvbSBpbnNpZGUgdGhlIGNvbnRyb2xsZXIgY29kZS4KICogKiBTaW5jZSB0aGVyZSBpcyBhbHdheXMgYSBgLmAgaW4gdGhlIGJpbmRpbmdzLCB5b3UgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCBwcm90b3R5cGFsCiAqIGluaGVyaXRhbmNlIG1hc2tpbmcgcHJpbWl0aXZlcy4KICoKICogVGhpcyBleGFtcGxlIGRlbW9uc3RyYXRlcyB0aGUgYGNvbnRyb2xsZXIgYXNgIHN5bnRheC4KICoKICogPGV4YW1wbGUgbmFtZT0ibmdDb250cm9sbGVyQXMiPgogKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogKiAgICA8ZGl2IGlkPSJjdHJsLWFzLWV4bXBsIiBuZy1jb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIxIGFzIHNldHRpbmdzIj4KICogICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InNldHRpbmdzLm5hbWUiLz4KICogICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICogICAgICBDb250YWN0OgogKiAgICAgIDx1bD4KICogICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMiPgogKiAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb250YWN0LnR5cGUiPgogKiAgICAgICAgICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAqICAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICogICAgICAgICAgPC9zZWxlY3Q+CiAqICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iY29udGFjdC52YWx1ZSIvPgogKiAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmNsZWFyQ29udGFjdChjb250YWN0KSI+Y2xlYXI8L2E+CiAqICAgICAgICAgIHwgPGEgaHJlZj0iIiBuZy1jbGljaz0ic2V0dGluZ3MucmVtb3ZlQ29udGFjdChjb250YWN0KSI+WDwvYT4gXQogKiAgICAgICAgPC9saT4KICogICAgICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICogICAgIDwvdWw+CiAqICAgIDwvZGl2PgogKiAgIDwvZmlsZT4KICogICA8ZmlsZSBuYW1lPSJhcHAuanMiPgogKiAgICBmdW5jdGlvbiBTZXR0aW5nc0NvbnRyb2xsZXIxKCkgewogKiAgICAgIHRoaXMubmFtZSA9ICJKb2huIFNtaXRoIjsKICogICAgICB0aGlzLmNvbnRhY3RzID0gWwogKiAgICAgICAge3R5cGU6ICdwaG9uZScsIHZhbHVlOiAnNDA4IDU1NSAxMjEyJ30sCiAqICAgICAgICB7dHlwZTogJ2VtYWlsJywgdmFsdWU6ICdqb2huLnNtaXRoQGV4YW1wbGUub3JnJ30gXTsKICogICAgfQogKgogKiAgICBTZXR0aW5nc0NvbnRyb2xsZXIxLnByb3RvdHlwZS5ncmVldCA9IGZ1bmN0aW9uKCkgewogKiAgICAgIGFsZXJ0KHRoaXMubmFtZSk7CiAqICAgIH07CiAqCiAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICogICAgICB0aGlzLmNvbnRhY3RzLnB1c2goe3R5cGU6ICdlbWFpbCcsIHZhbHVlOiAneW91cm5hbWVAZXhhbXBsZS5vcmcnfSk7CiAqICAgIH07CiAqCiAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLnJlbW92ZUNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0VG9SZW1vdmUpIHsKICogICAgIHZhciBpbmRleCA9IHRoaXMuY29udGFjdHMuaW5kZXhPZihjb250YWN0VG9SZW1vdmUpOwogKiAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICogICAgfTsKICoKICogICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuY2xlYXJDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdCkgewogKiAgICAgIGNvbnRhY3QudHlwZSA9ICdwaG9uZSc7CiAqICAgICAgY29udGFjdC52YWx1ZSA9ICcnOwogKiAgICB9OwogKiAgIDwvZmlsZT4KICogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlciBhcycsIGZ1bmN0aW9uKCkgewogKiAgICAgICB2YXIgY29udGFpbmVyID0gZWxlbWVudChieS5pZCgnY3RybC1hcy1leG1wbCcpKTsKICogICAgICAgICBleHBlY3QoY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdzZXR0aW5ncy5uYW1lJykpCiAqICAgICAgICAgICAuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAqCiAqICAgICAgIHZhciBmaXJzdFJlcGVhdCA9CiAqICAgICAgICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMnKS5yb3coMCkpOwogKiAgICAgICB2YXIgc2Vjb25kUmVwZWF0ID0KICogICAgICAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBzZXR0aW5ncy5jb250YWN0cycpLnJvdygxKSk7CiAqCiAqICAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAqCiAqICAgICAgIGV4cGVjdChzZWNvbmRSZXBlYXQuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAgLnRvQmUoJ2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnKTsKICoKICogICAgICAgZmlyc3RSZXBlYXQuZmluZEVsZW1lbnQoYnkubGlua1RleHQoJ2NsZWFyJykpLmNsaWNrKCk7CiAqCiAqICAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgICAudG9CZSgnJyk7CiAqCiAqICAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5saW5rVGV4dCgnYWRkJykpLmNsaWNrKCk7CiAqCiAqICAgICAgIGV4cGVjdChjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMnKS5yb3coMikpCiAqICAgICAgICAgICAuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkKICogICAgICAgICAgIC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgICAudG9CZSgneW91cm5hbWVAZXhhbXBsZS5vcmcnKTsKICogICAgIH0pOwogKiAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKgogKiBUaGlzIGV4YW1wbGUgZGVtb25zdHJhdGVzIHRoZSAiYXR0YWNoIHRvIGAkc2NvcGVgIiBzdHlsZSBvZiBjb250cm9sbGVyLgogKgogKiA8ZXhhbXBsZSBuYW1lPSJuZ0NvbnRyb2xsZXIiPgogKiAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAqICAgPGRpdiBpZD0iY3RybC1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMiI+CiAqICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiLz4KICogICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0iZ3JlZXQoKSI+Z3JlZXQ8L2E+IF08YnIvPgogKiAgICAgQ29udGFjdDoKICogICAgIDx1bD4KICogICAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAqICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICogICAgICAgICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAqICAgICAgICAgICAgPG9wdGlvbj5lbWFpbDwvb3B0aW9uPgogKiAgICAgICAgIDwvc2VsZWN0PgogKiAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iY29udGFjdC52YWx1ZSIvPgogKiAgICAgICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0iY2xlYXJDb250YWN0KGNvbnRhY3QpIj5jbGVhcjwvYT4KICogICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICogICAgICAgPC9saT4KICogICAgICAgPGxpPlsgPGEgaHJlZj0iIiBuZy1jbGljaz0iYWRkQ29udGFjdCgpIj5hZGQ8L2E+IF08L2xpPgogKiAgICA8L3VsPgogKiAgIDwvZGl2PgogKiAgPC9maWxlPgogKiAgPGZpbGUgbmFtZT0iYXBwLmpzIj4KICogICBmdW5jdGlvbiBTZXR0aW5nc0NvbnRyb2xsZXIyKCRzY29wZSkgewogKiAgICAgJHNjb3BlLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAqICAgICAkc2NvcGUuY29udGFjdHMgPSBbCiAqICAgICAgIHt0eXBlOidwaG9uZScsIHZhbHVlOic0MDggNTU1IDEyMTInfSwKICogICAgICAge3R5cGU6J2VtYWlsJywgdmFsdWU6J2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwogKgogKiAgICAgJHNjb3BlLmdyZWV0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgIGFsZXJ0KCRzY29wZS5uYW1lKTsKICogICAgIH07CiAqCiAqICAgICAkc2NvcGUuYWRkQ29udGFjdCA9IGZ1bmN0aW9uKCkgewogKiAgICAgICAkc2NvcGUuY29udGFjdHMucHVzaCh7dHlwZTonZW1haWwnLCB2YWx1ZToneW91cm5hbWVAZXhhbXBsZS5vcmcnfSk7CiAqICAgICB9OwogKgogKiAgICAgJHNjb3BlLnJlbW92ZUNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0VG9SZW1vdmUpIHsKICogICAgICAgdmFyIGluZGV4ID0gJHNjb3BlLmNvbnRhY3RzLmluZGV4T2YoY29udGFjdFRvUmVtb3ZlKTsKICogICAgICAgJHNjb3BlLmNvbnRhY3RzLnNwbGljZShpbmRleCwgMSk7CiAqICAgICB9OwogKgogKiAgICAgJHNjb3BlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICogICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICogICAgICAgY29udGFjdC52YWx1ZSA9ICcnOwogKiAgICAgfTsKICogICB9CiAqICA8L2ZpbGU+CiAqICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogICAgaXQoJ3Nob3VsZCBjaGVjayBjb250cm9sbGVyJywgZnVuY3Rpb24oKSB7CiAqICAgICAgdmFyIGNvbnRhaW5lciA9IGVsZW1lbnQoYnkuaWQoJ2N0cmwtZXhtcGwnKSk7CiAqCiAqICAgICAgZXhwZWN0KGNvbnRhaW5lci5maW5kRWxlbWVudChieS5tb2RlbCgnbmFtZScpKQogKiAgICAgICAgICAuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAqCiAqICAgICAgdmFyIGZpcnN0UmVwZWF0ID0KICogICAgICAgICAgY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIGNvbnRhY3RzJykucm93KDApKTsKICogICAgICB2YXIgc2Vjb25kUmVwZWF0ID0KICogICAgICAgICAgY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIGNvbnRhY3RzJykucm93KDEpKTsKICoKICogICAgICBleHBlY3QoZmlyc3RSZXBlYXQuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAqICAgICAgZXhwZWN0KHNlY29uZFJlcGVhdC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAqCiAqICAgICAgZmlyc3RSZXBlYXQuZmluZEVsZW1lbnQoYnkubGlua1RleHQoJ2NsZWFyJykpLmNsaWNrKCk7CiAqCiAqICAgICAgZXhwZWN0KGZpcnN0UmVwZWF0LmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgLnRvQmUoJycpOwogKgogKiAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5saW5rVGV4dCgnYWRkJykpLmNsaWNrKCk7CiAqCiAqICAgICAgZXhwZWN0KGNvbnRhaW5lci5maW5kRWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBjb250YWN0cycpLnJvdygyKSkKICogICAgICAgICAgLmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpCiAqICAgICAgICAgIC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgIC50b0JlKCd5b3VybmFtZUBleGFtcGxlLm9yZycpOwogKiAgICB9KTsKICogIDwvZmlsZT4KICo8L2V4YW1wbGU+CgogKi8KdmFyIG5nQ29udHJvbGxlckRpcmVjdGl2ZSA9IFtmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgc2NvcGU6IHRydWUsCiAgICBjb250cm9sbGVyOiAnQCcsCiAgICBwcmlvcml0eTogNTAwCiAgfTsKfV07CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NzcAogKgogKiBAZWxlbWVudCBodG1sCiAqIEBkZXNjcmlwdGlvbgogKiBFbmFibGVzIFtDU1AgKENvbnRlbnQgU2VjdXJpdHkgUG9saWN5KV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSBzdXBwb3J0LgogKgogKiBUaGlzIGlzIG5lY2Vzc2FyeSB3aGVuIGRldmVsb3BpbmcgdGhpbmdzIGxpa2UgR29vZ2xlIENocm9tZSBFeHRlbnNpb25zLgogKgogKiBDU1AgZm9yYmlkcyBhcHBzIHRvIHVzZSBgZXZhbGAgb3IgYEZ1bmN0aW9uKHN0cmluZylgIGdlbmVyYXRlZCBmdW5jdGlvbnMgKGFtb25nIG90aGVyIHRoaW5ncykuCiAqIEZvciB1cyB0byBiZSBjb21wYXRpYmxlLCB3ZSBqdXN0IG5lZWQgdG8gaW1wbGVtZW50IHRoZSAiZ2V0dGVyRm4iIGluICRwYXJzZSB3aXRob3V0IHZpb2xhdGluZwogKiBhbnkgb2YgdGhlc2UgcmVzdHJpY3Rpb25zLgogKgogKiBBbmd1bGFySlMgdXNlcyBgRnVuY3Rpb24oc3RyaW5nKWAgZ2VuZXJhdGVkIGZ1bmN0aW9ucyBhcyBhIHNwZWVkIG9wdGltaXphdGlvbi4gQXBwbHlpbmcgdGhlIGBuZ0NzcGAKICogZGlyZWN0aXZlIHdpbGwgY2F1c2UgQW5ndWxhciB0byB1c2UgQ1NQIGNvbXBhdGliaWxpdHkgbW9kZS4gV2hlbiB0aGlzIG1vZGUgaXMgb24gQW5ndWxhckpTIHdpbGwKICogZXZhbHVhdGUgYWxsIGV4cHJlc3Npb25zIHVwIHRvIDMwJSBzbG93ZXIgdGhhbiBpbiBub24tQ1NQIG1vZGUsIGJ1dCBubyBzZWN1cml0eSB2aW9sYXRpb25zIHdpbGwKICogYmUgcmFpc2VkLgogKgogKiBDU1AgZm9yYmlkcyBKYXZhU2NyaXB0IHRvIGlubGluZSBzdHlsZXNoZWV0IHJ1bGVzLiBJbiBub24gQ1NQIG1vZGUgQW5ndWxhciBhdXRvbWF0aWNhbGx5CiAqIGluY2x1ZGVzIHNvbWUgQ1NTIHJ1bGVzIChlLmcuIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbG9hayBuZ0Nsb2FrfSkuCiAqIFRvIG1ha2UgdGhvc2UgZGlyZWN0aXZlcyB3b3JrIGluIENTUCBtb2RlLCBpbmNsdWRlIHRoZSBgYW5ndWxhci1jc3AuY3NzYCBtYW51YWxseS4KICoKICogSW4gb3JkZXIgdG8gdXNlIHRoaXMgZmVhdHVyZSBwdXQgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIG9uIHRoZSByb290IGVsZW1lbnQgb2YgdGhlIGFwcGxpY2F0aW9uLgogKgogKiAqTm90ZTogVGhpcyBkaXJlY3RpdmUgaXMgb25seSBhdmFpbGFibGUgaW4gdGhlIGBuZy1jc3BgIGFuZCBgZGF0YS1uZy1jc3BgIGF0dHJpYnV0ZSBmb3JtLioKICoKICogQGV4YW1wbGUKICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0byBhcHBseSB0aGUgYG5nQ3NwYCBkaXJlY3RpdmUgdG8gdGhlIGBodG1sYCB0YWcuCiAgIGBgYGh0bWwKICAgICA8IWRvY3R5cGUgaHRtbD4KICAgICA8aHRtbCBuZy1hcHAgbmctY3NwPgogICAgIC4uLgogICAgIC4uLgogICAgIDwvaHRtbD4KICAgYGBgCiAqLwoKLy8gbmdDc3AgaXMgbm90IGltcGxlbWVudGVkIGFzIGEgcHJvcGVyIGRpcmVjdGl2ZSBhbnkgbW9yZSwgYmVjYXVzZSB3ZSBuZWVkIGl0IGJlIHByb2Nlc3NlZCB3aGlsZSB3ZSBib290c3RyYXAKLy8gdGhlIHN5c3RlbSAoYmVmb3JlICRwYXJzZSBpcyBpbnN0YW50aWF0ZWQpLCBmb3IgdGhpcyByZWFzb24gd2UganVzdCBoYXZlIGEgY3NwKCkgZm4gdGhhdCBsb29rcyBmb3IgbmctY3NwIGF0dHJpYnV0ZQovLyBhbnl3aGVyZSBpbiB0aGUgY3VycmVudCBkb2MKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2xpY2sKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBuZ0NsaWNrIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIHdoZW4KICogYW4gZWxlbWVudCBpcyBjbGlja2VkLgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogY2xpY2suICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudAogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnY291bnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKCcwJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCdidXR0b24nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnY291bnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKCcxJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCi8qCiAqIEEgZGlyZWN0aXZlIHRoYXQgYWxsb3dzIGNyZWF0aW9uIG9mIGN1c3RvbSBvbmNsaWNrIGhhbmRsZXJzIHRoYXQgYXJlIGRlZmluZWQgYXMgYW5ndWxhcgogKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAqCiAqIEV2ZW50cyB0aGF0IGFyZSBoYW5kbGVkIHZpYSB0aGVzZSBoYW5kbGVyIGFyZSBhbHdheXMgY29uZmlndXJlZCBub3QgdG8gcHJvcGFnYXRlIGZ1cnRoZXIuCiAqLwp2YXIgbmdFdmVudERpcmVjdGl2ZXMgPSB7fTsKZm9yRWFjaCgKICAnY2xpY2sgZGJsY2xpY2sgbW91c2Vkb3duIG1vdXNldXAgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlbW92ZSBtb3VzZWVudGVyIG1vdXNlbGVhdmUga2V5ZG93biBrZXl1cCBrZXlwcmVzcyBzdWJtaXQgZm9jdXMgYmx1ciBjb3B5IGN1dCBwYXN0ZScuc3BsaXQoJyAnKSwKICBmdW5jdGlvbihuYW1lKSB7CiAgICB2YXIgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIG5hbWUpOwogICAgbmdFdmVudERpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0gPSBbJyRwYXJzZScsIGZ1bmN0aW9uKCRwYXJzZSkgewogICAgICByZXR1cm4gewogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cltkaXJlY3RpdmVOYW1lXSk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgZWxlbWVudC5vbihsb3dlcmNhc2UobmFtZSksIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6ZXZlbnR9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH1dOwogIH0KKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nRGJsY2xpY2sKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdEYmxjbGlja2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gYSBkYmxjbGljayBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdEYmxjbGljayB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGEgZGJsY2xpY2suIChUaGUgRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctZGJsY2xpY2s9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKG9uIGRvdWJsZSBjbGljaykKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZWRvd24KICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBuZ01vdXNlZG93biBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWRvd24gZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2Vkb3duIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogbW91c2Vkb3duLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctbW91c2Vkb3duPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50IChvbiBtb3VzZSBkb3duKQogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vdXNldXAKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNldXAgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2V1cCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIG1vdXNldXAuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1tb3VzZXVwPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50IChvbiBtb3VzZSB1cCkKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vdXNlb3ZlcgogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VvdmVyIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlb3ZlciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIG1vdXNlb3Zlci4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNlb3Zlcj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBpcyBvdmVyKQogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vdXNlZW50ZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlZW50ZXIgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VlbnRlciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIG1vdXNlZW50ZXIuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1tb3VzZWVudGVyPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50ICh3aGVuIG1vdXNlIGVudGVycykKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZWxlYXZlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWxlYXZlIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbGVhdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZWxlYXZlLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctbW91c2VsZWF2ZT0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBsZWF2ZXMpCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW91c2Vtb3ZlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZW1vdmUgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2Vtb3ZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogbW91c2Vtb3ZlLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctbW91c2Vtb3ZlPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50ICh3aGVuIG1vdXNlIG1vdmVzKQogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0tleWRvd24KICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleWRvd24gZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5ZG93biB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGtleWRvd24uIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8aW5wdXQgbmcta2V5ZG93bj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICBrZXkgZG93biBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nS2V5dXAKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXVwIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXVwIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICoga2V5dXAuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHA+VHlwaW5nIGluIHRoZSBpbnB1dCBib3ggYmVsb3cgdXBkYXRlcyB0aGUga2V5IGNvdW50PC9wPgogICAgICAgPGlucHV0IG5nLWtleXVwPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+IGtleSB1cCBjb3VudDoge3tjb3VudH19CgogICAgICAgPHA+VHlwaW5nIGluIHRoZSBpbnB1dCBib3ggYmVsb3cgdXBkYXRlcyB0aGUga2V5Y29kZTwvcD4KICAgICAgIDxpbnB1dCBuZy1rZXl1cD0iZXZlbnQ9JGV2ZW50Ij4KICAgICAgIDxwPmV2ZW50IGtleUNvZGU6IHt7IGV2ZW50LmtleUNvZGUgfX08L3A+CiAgICAgICA8cD5ldmVudCBhbHRLZXk6IHt7IGV2ZW50LmFsdEtleSB9fTwvcD4KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdLZXlwcmVzcwogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24ga2V5cHJlc3MgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5cHJlc3Mge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBrZXlwcmVzcy4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0KICogYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxpbnB1dCBuZy1rZXlwcmVzcz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICBrZXkgcHJlc3MgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1N1Ym1pdAogKgogKiBAZGVzY3JpcHRpb24KICogRW5hYmxlcyBiaW5kaW5nIGFuZ3VsYXIgZXhwcmVzc2lvbnMgdG8gb25zdWJtaXQgZXZlbnRzLgogKgogKiBBZGRpdGlvbmFsbHkgaXQgcHJldmVudHMgdGhlIGRlZmF1bHQgYWN0aW9uICh3aGljaCBmb3IgZm9ybSBtZWFucyBzZW5kaW5nIHRoZSByZXF1ZXN0IHRvIHRoZQogKiBzZXJ2ZXIgYW5kIHJlbG9hZGluZyB0aGUgY3VycmVudCBwYWdlKSwgYnV0IG9ubHkgaWYgdGhlIGZvcm0gZG9lcyBub3QgY29udGFpbiBgYWN0aW9uYCwKICogYGRhdGEtYWN0aW9uYCwgb3IgYHgtYWN0aW9uYCBhdHRyaWJ1dGVzLgogKgogKiBAZWxlbWVudCBmb3JtCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdWJtaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4KICogKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUubGlzdCA9IFtdOwogICAgICAgICAgJHNjb3BlLnRleHQgPSAnaGVsbG8nOwogICAgICAgICAgJHNjb3BlLnN1Ym1pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoJHNjb3BlLnRleHQpIHsKICAgICAgICAgICAgICAkc2NvcGUubGlzdC5wdXNoKHRoaXMudGV4dCk7CiAgICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIDwvc2NyaXB0PgogICAgICA8Zm9ybSBuZy1zdWJtaXQ9InN1Ym1pdCgpIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICBFbnRlciB0ZXh0IGFuZCBoaXQgZW50ZXI6CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJ0ZXh0IiBuYW1lPSJ0ZXh0IiAvPgogICAgICAgIDxpbnB1dCB0eXBlPSJzdWJtaXQiIGlkPSJzdWJtaXQiIHZhbHVlPSJTdWJtaXQiIC8+CiAgICAgICAgPHByZT5saXN0PXt7bGlzdH19PC9wcmU+CiAgICAgIDwvZm9ybT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN1Ym1pdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9CZSgnbGlzdD1bXScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3N1Ym1pdCcpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9Db250YWluKCdoZWxsbycpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pbnB1dCgndGV4dCcpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJycpOwogICAgICAgfSk7CiAgICAgICBpdCgnc2hvdWxkIGlnbm9yZSBlbXB0eSBzdHJpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2xpc3QnKSkuZ2V0VGV4dCgpKS50b0JlKCdsaXN0PVtdJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCcjc3VibWl0JykpLmNsaWNrKCk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCcjc3VibWl0JykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2xpc3QnKSkuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2hlbGxvJyk7CiAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdGb2N1cwogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gZm9jdXMgZXZlbnQuCiAqCiAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0ZvY3VzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogZm9jdXMuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdCbHVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBibHVyIGV2ZW50LgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCbHVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogYmx1ci4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NvcHkKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGNvcHkgZXZlbnQuCiAqCiAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NvcHkge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBjb3B5LiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxpbnB1dCBuZy1jb3B5PSJjb3BpZWQ9dHJ1ZSIgbmctaW5pdD0iY29waWVkPWZhbHNlOyB2YWx1ZT0nY29weSBtZSciIG5nLW1vZGVsPSJ2YWx1ZSI+CiAgICAgIGNvcGllZDoge3tjb3BpZWR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ3V0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBjdXQgZXZlbnQuCiAqCiAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0N1dCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGN1dC4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8aW5wdXQgbmctY3V0PSJjdXQ9dHJ1ZSIgbmctaW5pdD0iY3V0PWZhbHNlOyB2YWx1ZT0nY3V0IG1lJyIgbmctbW9kZWw9InZhbHVlIj4KICAgICAgY3V0OiB7e2N1dH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdQYXN0ZQogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gcGFzdGUgZXZlbnQuCiAqCiAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1Bhc3RlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogcGFzdGUuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGlucHV0IG5nLXBhc3RlPSJwYXN0ZT10cnVlIiBuZy1pbml0PSJwYXN0ZT1mYWxzZSIgcGxhY2Vob2xkZXI9J3Bhc3RlIGhlcmUnPgogICAgICBwYXN0ZWQ6IHt7cGFzdGV9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nSWYKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdJZmAgZGlyZWN0aXZlIHJlbW92ZXMgb3IgcmVjcmVhdGVzIGEgcG9ydGlvbiBvZiB0aGUgRE9NIHRyZWUgYmFzZWQgb24gYW4KICoge2V4cHJlc3Npb259LiBJZiB0aGUgZXhwcmVzc2lvbiBhc3NpZ25lZCB0byBgbmdJZmAgZXZhbHVhdGVzIHRvIGEgZmFsc2UKICogdmFsdWUgdGhlbiB0aGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSwgb3RoZXJ3aXNlIGEgY2xvbmUgb2YgdGhlCiAqIGVsZW1lbnQgaXMgcmVpbnNlcnRlZCBpbnRvIHRoZSBET00uCiAqCiAqIGBuZ0lmYCBkaWZmZXJzIGZyb20gYG5nU2hvd2AgYW5kIGBuZ0hpZGVgIGluIHRoYXQgYG5nSWZgIGNvbXBsZXRlbHkgcmVtb3ZlcyBhbmQgcmVjcmVhdGVzIHRoZQogKiBlbGVtZW50IGluIHRoZSBET00gcmF0aGVyIHRoYW4gY2hhbmdpbmcgaXRzIHZpc2liaWxpdHkgdmlhIHRoZSBgZGlzcGxheWAgY3NzIHByb3BlcnR5LiAgQSBjb21tb24KICogY2FzZSB3aGVuIHRoaXMgZGlmZmVyZW5jZSBpcyBzaWduaWZpY2FudCBpcyB3aGVuIHVzaW5nIGNzcyBzZWxlY3RvcnMgdGhhdCByZWx5IG9uIGFuIGVsZW1lbnQncwogKiBwb3NpdGlvbiB3aXRoaW4gdGhlIERPTSwgc3VjaCBhcyB0aGUgYDpmaXJzdC1jaGlsZGAgb3IgYDpsYXN0LWNoaWxkYCBwc2V1ZG8tY2xhc3Nlcy4KICoKICogTm90ZSB0aGF0IHdoZW4gYW4gZWxlbWVudCBpcyByZW1vdmVkIHVzaW5nIGBuZ0lmYCBpdHMgc2NvcGUgaXMgZGVzdHJveWVkIGFuZCBhIG5ldyBzY29wZQogKiBpcyBjcmVhdGVkIHdoZW4gdGhlIGVsZW1lbnQgaXMgcmVzdG9yZWQuICBUaGUgc2NvcGUgY3JlYXRlZCB3aXRoaW4gYG5nSWZgIGluaGVyaXRzIGZyb20KICogaXRzIHBhcmVudCBzY29wZSB1c2luZwogKiBbcHJvdG90eXBhbCBpbmhlcml0YW5jZV0oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy93aWtpL1RoZS1OdWFuY2VzLW9mLVNjb3BlLVByb3RvdHlwYWwtSW5oZXJpdGFuY2UpLgogKiBBbiBpbXBvcnRhbnQgaW1wbGljYXRpb24gb2YgdGhpcyBpcyBpZiBgbmdNb2RlbGAgaXMgdXNlZCB3aXRoaW4gYG5nSWZgIHRvIGJpbmQgdG8KICogYSBqYXZhc2NyaXB0IHByaW1pdGl2ZSBkZWZpbmVkIGluIHRoZSBwYXJlbnQgc2NvcGUuIEluIHRoaXMgY2FzZSBhbnkgbW9kaWZpY2F0aW9ucyBtYWRlIHRvIHRoZQogKiB2YXJpYWJsZSB3aXRoaW4gdGhlIGNoaWxkIHNjb3BlIHdpbGwgb3ZlcnJpZGUgKGhpZGUpIHRoZSB2YWx1ZSBpbiB0aGUgcGFyZW50IHNjb3BlLgogKgogKiBBbHNvLCBgbmdJZmAgcmVjcmVhdGVzIGVsZW1lbnRzIHVzaW5nIHRoZWlyIGNvbXBpbGVkIHN0YXRlLiBBbiBleGFtcGxlIG9mIHRoaXMgYmVoYXZpb3IKICogaXMgaWYgYW4gZWxlbWVudCdzIGNsYXNzIGF0dHJpYnV0ZSBpcyBkaXJlY3RseSBtb2RpZmllZCBhZnRlciBpdCdzIGNvbXBpbGVkLCB1c2luZyBzb21ldGhpbmcgbGlrZQogKiBqUXVlcnkncyBgLmFkZENsYXNzKClgIG1ldGhvZCwgYW5kIHRoZSBlbGVtZW50IGlzIGxhdGVyIHJlbW92ZWQuIFdoZW4gYG5nSWZgIHJlY3JlYXRlcyB0aGUgZWxlbWVudAogKiB0aGUgYWRkZWQgY2xhc3Mgd2lsbCBiZSBsb3N0IGJlY2F1c2UgdGhlIG9yaWdpbmFsIGNvbXBpbGVkIHN0YXRlIGlzIHVzZWQgdG8gcmVnZW5lcmF0ZSB0aGUgZWxlbWVudC4KICoKICogQWRkaXRpb25hbGx5LCB5b3UgY2FuIHByb3ZpZGUgYW5pbWF0aW9ucyB2aWEgdGhlIGBuZ0FuaW1hdGVgIG1vZHVsZSB0byBhbmltYXRlIHRoZSBgZW50ZXJgCiAqIGFuZCBgbGVhdmVgIGVmZmVjdHMuCiAqCiAqIEBhbmltYXRpb25zCiAqIGVudGVyIC0gaGFwcGVucyBqdXN0IGFmdGVyIHRoZSBuZ0lmIGNvbnRlbnRzIGNoYW5nZSBhbmQgYSBuZXcgRE9NIGVsZW1lbnQgaXMgY3JlYXRlZCBhbmQgaW5qZWN0ZWQgaW50byB0aGUgbmdJZiBjb250YWluZXIKICogbGVhdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBuZ0lmIGNvbnRlbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTQogKgogKiBAZWxlbWVudCBBTlkKICogQHNjb3BlCiAqIEBwcmlvcml0eSA2MDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0lmIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyBmYWxzeSB0aGVuCiAqICAgICB0aGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSB0cmVlLiBJZiBpdCBpcyB0cnV0aHkgYSBjb3B5IG9mIHRoZSBjb21waWxlZAogKiAgICAgZWxlbWVudCBpcyBhZGRlZCB0byB0aGUgRE9NIHRyZWUuCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiIG5nLWluaXQ9ImNoZWNrZWQ9dHJ1ZSIgLz48YnIvPgogICAgICBTaG93IHdoZW4gY2hlY2tlZDoKICAgICAgPHNwYW4gbmctaWY9ImNoZWNrZWQiIGNsYXNzPSJhbmltYXRlLWlmIj4KICAgICAgICBJJ20gcmVtb3ZlZCB3aGVuIHRoZSBjaGVja2JveCBpcyB1bmNoZWNrZWQuCiAgICAgIDwvc3Bhbj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgLmFuaW1hdGUtaWYgewogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLWlmLm5nLWVudGVyLCAuYW5pbWF0ZS1pZi5uZy1sZWF2ZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1pZi5uZy1lbnRlciwKICAgICAgLmFuaW1hdGUtaWYubmctbGVhdmUubmctbGVhdmUtYWN0aXZlIHsKICAgICAgICBvcGFjaXR5OjA7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLWlmLm5nLWxlYXZlLAogICAgICAuYW5pbWF0ZS1pZi5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogICAgICAgIG9wYWNpdHk6MTsKICAgICAgfQogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCnZhciBuZ0lmRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgcmV0dXJuIHsKICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgIHByaW9yaXR5OiA2MDAsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgIHJlc3RyaWN0OiAnQScsCiAgICAkJHRsYjogdHJ1ZSwKICAgIGxpbms6IGZ1bmN0aW9uICgkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgICAgICB2YXIgYmxvY2ssIGNoaWxkU2NvcGUsIHByZXZpb3VzRWxlbWVudHM7CiAgICAgICAgJHNjb3BlLiR3YXRjaCgkYXR0ci5uZ0lmLCBmdW5jdGlvbiBuZ0lmV2F0Y2hBY3Rpb24odmFsdWUpIHsKCiAgICAgICAgICBpZiAodG9Cb29sZWFuKHZhbHVlKSkgewogICAgICAgICAgICBpZiAoIWNoaWxkU2NvcGUpIHsKICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gJHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICAkdHJhbnNjbHVkZShjaGlsZFNjb3BlLCBmdW5jdGlvbiAoY2xvbmUpIHsKICAgICAgICAgICAgICAgIGNsb25lW2Nsb25lLmxlbmd0aCsrXSA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyBlbmQgbmdJZjogJyArICRhdHRyLm5nSWYgKyAnICcpOwogICAgICAgICAgICAgICAgLy8gTm90ZTogV2Ugb25seSBuZWVkIHRoZSBmaXJzdC9sYXN0IG5vZGUgb2YgdGhlIGNsb25lZCBub2Rlcy4KICAgICAgICAgICAgICAgIC8vIEhvd2V2ZXIsIHdlIG5lZWQgdG8ga2VlcCB0aGUgcmVmZXJlbmNlIHRvIHRoZSBqcWxpdGUgd3JhcHBlciBhcyBpdCBtaWdodCBiZSBjaGFuZ2VkIGxhdGVyCiAgICAgICAgICAgICAgICAvLyBieSBhIGRpcmVjdGl2ZSB3aXRoIHRlbXBsYXRlVXJsIHdoZW4gaXRzIHRlbXBsYXRlIGFycml2ZXMuCiAgICAgICAgICAgICAgICBibG9jayA9IHsKICAgICAgICAgICAgICAgICAgY2xvbmU6IGNsb25lCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2xvbmUsICRlbGVtZW50LnBhcmVudCgpLCAkZWxlbWVudCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmKHByZXZpb3VzRWxlbWVudHMpIHsKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzLnJlbW92ZSgpOwogICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNoaWxkU2NvcGUpIHsKICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoYmxvY2spIHsKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzID0gZ2V0QmxvY2tFbGVtZW50cyhibG9jay5jbG9uZSk7CiAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUocHJldmlvdXNFbGVtZW50cywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzID0gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBibG9jayA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICB9Owp9XTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nSW5jbHVkZQogKiBAcmVzdHJpY3QgRUNBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGZXRjaGVzLCBjb21waWxlcyBhbmQgaW5jbHVkZXMgYW4gZXh0ZXJuYWwgSFRNTCBmcmFnbWVudC4KICoKICogQnkgZGVmYXVsdCwgdGhlIHRlbXBsYXRlIFVSTCBpcyByZXN0cmljdGVkIHRvIHRoZSBzYW1lIGRvbWFpbiBhbmQgcHJvdG9jb2wgYXMgdGhlCiAqIGFwcGxpY2F0aW9uIGRvY3VtZW50LiBUaGlzIGlzIGRvbmUgYnkgY2FsbGluZyB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwKICogJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9IG9uIGl0LiBUbyBsb2FkIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgb3IgcHJvdG9jb2xzCiAqIHlvdSBtYXkgZWl0aGVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3QgdGhlbX0gb3IKICogW3dyYXAgdGhlbV0obmcuJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwpIGFzIHRydXN0ZWQgdmFsdWVzLiBSZWZlciB0byBBbmd1bGFyJ3Mge0BsaW5rCiAqIG5nLiRzY2UgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmd9LgogKgogKiBJbiBhZGRpdGlvbiwgdGhlIGJyb3dzZXIncwogKiBbU2FtZSBPcmlnaW4gUG9saWN5XShodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Jyb3dzZXJzZWMvd2lraS9QYXJ0MiNTYW1lLW9yaWdpbl9wb2xpY3lfZm9yX1hNTEh0dHBSZXF1ZXN0KQogKiBhbmQgW0Nyb3NzLU9yaWdpbiBSZXNvdXJjZSBTaGFyaW5nIChDT1JTKV0oaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8pCiAqIHBvbGljeSBtYXkgZnVydGhlciByZXN0cmljdCB3aGV0aGVyIHRoZSB0ZW1wbGF0ZSBpcyBzdWNjZXNzZnVsbHkgbG9hZGVkLgogKiBGb3IgZXhhbXBsZSwgYG5nSW5jbHVkZWAgd29uJ3Qgd29yayBmb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzIG9uIGFsbCBicm93c2VycyBhbmQgZm9yIGBmaWxlOi8vYAogKiBhY2Nlc3Mgb24gc29tZSBicm93c2Vycy4KICoKICogQGFuaW1hdGlvbnMKICogZW50ZXIgLSBhbmltYXRpb24gaXMgdXNlZCB0byBicmluZyBuZXcgY29udGVudCBpbnRvIHRoZSBicm93c2VyLgogKiBsZWF2ZSAtIGFuaW1hdGlvbiBpcyB1c2VkIHRvIGFuaW1hdGUgZXhpc3RpbmcgY29udGVudCBhd2F5LgogKgogKiBUaGUgZW50ZXIgYW5kIGxlYXZlIGFuaW1hdGlvbiBvY2N1ciBjb25jdXJyZW50bHkuCiAqCiAqIEBzY29wZQogKiBAcHJpb3JpdHkgNDAwCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuZ0luY2x1ZGV8c3JjIGFuZ3VsYXIgZXhwcmVzc2lvbiBldmFsdWF0aW5nIHRvIFVSTC4gSWYgdGhlIHNvdXJjZSBpcyBhIHN0cmluZyBjb25zdGFudCwKICogICAgICAgICAgICAgICAgIG1ha2Ugc3VyZSB5b3Ugd3JhcCBpdCBpbiAqKnNpbmdsZSoqIHF1b3RlcywgZS5nLiBgc3JjPSInbXlQYXJ0aWFsVGVtcGxhdGUuaHRtbCciYC4KICogQHBhcmFtIHtzdHJpbmc9fSBvbmxvYWQgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuIGEgbmV3IHBhcnRpYWwgaXMgbG9hZGVkLgogKgogKiBAcGFyYW0ge3N0cmluZz19IGF1dG9zY3JvbGwgV2hldGhlciBgbmdJbmNsdWRlYCBzaG91bGQgY2FsbCB7QGxpbmsgbmcuJGFuY2hvclNjcm9sbAogKiAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGx9IHRvIHNjcm9sbCB0aGUgdmlld3BvcnQgYWZ0ZXIgdGhlIGNvbnRlbnQgaXMgbG9hZGVkLgogKgogKiAgICAgICAgICAgICAgICAgIC0gSWYgdGhlIGF0dHJpYnV0ZSBpcyBub3Qgc2V0LCBkaXNhYmxlIHNjcm9sbGluZy4KICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgc2V0IHdpdGhvdXQgdmFsdWUsIGVuYWJsZSBzY3JvbGxpbmcuCiAqICAgICAgICAgICAgICAgICAgLSBPdGhlcndpc2UgZW5hYmxlIHNjcm9sbGluZyBvbmx5IGlmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnV0aHkgdmFsdWUuCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgPHNlbGVjdCBuZy1tb2RlbD0idGVtcGxhdGUiIG5nLW9wdGlvbnM9InQubmFtZSBmb3IgdCBpbiB0ZW1wbGF0ZXMiPgogICAgICAgIDxvcHRpb24gdmFsdWU9IiI+KGJsYW5rKTwvb3B0aW9uPgogICAgICAgPC9zZWxlY3Q+CiAgICAgICB1cmwgb2YgdGhlIHRlbXBsYXRlOiA8dHQ+e3t0ZW1wbGF0ZS51cmx9fTwvdHQ+CiAgICAgICA8aHIvPgogICAgICAgPGRpdiBjbGFzcz0ic2xpZGUtYW5pbWF0ZS1jb250YWluZXIiPgogICAgICAgICA8ZGl2IGNsYXNzPSJzbGlkZS1hbmltYXRlIiBuZy1pbmNsdWRlPSJ0ZW1wbGF0ZS51cmwiPjwvZGl2PgogICAgICAgPC9kaXY+CiAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS50ZW1wbGF0ZXMgPQogICAgICAgICAgWyB7IG5hbWU6ICd0ZW1wbGF0ZTEuaHRtbCcsIHVybDogJ3RlbXBsYXRlMS5odG1sJ30sCiAgICAgICAgICAgIHsgbmFtZTogJ3RlbXBsYXRlMi5odG1sJywgdXJsOiAndGVtcGxhdGUyLmh0bWwnfSBdOwogICAgICAgICRzY29wZS50ZW1wbGF0ZSA9ICRzY29wZS50ZW1wbGF0ZXNbMF07CiAgICAgIH0KICAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTEuaHRtbCI+CiAgICAgIENvbnRlbnQgb2YgdGVtcGxhdGUxLmh0bWwKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMi5odG1sIj4KICAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTIuaHRtbAogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuc2xpZGUtYW5pbWF0ZS1jb250YWluZXIgewogICAgICAgIHBvc2l0aW9uOnJlbGF0aXZlOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBoZWlnaHQ6NDBweDsKICAgICAgICBvdmVyZmxvdzpoaWRkZW47CiAgICAgIH0KCiAgICAgIC5zbGlkZS1hbmltYXRlIHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgICAgIC5zbGlkZS1hbmltYXRlLm5nLWVudGVyLCAuc2xpZGUtYW5pbWF0ZS5uZy1sZWF2ZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwoKICAgICAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAgICB0b3A6MDsKICAgICAgICBsZWZ0OjA7CiAgICAgICAgcmlnaHQ6MDsKICAgICAgICBib3R0b206MDsKICAgICAgICBkaXNwbGF5OmJsb2NrOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgfQoKICAgICAgLnNsaWRlLWFuaW1hdGUubmctZW50ZXIgewogICAgICAgIHRvcDotNTBweDsKICAgICAgfQogICAgICAuc2xpZGUtYW5pbWF0ZS5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogICAgICAgIHRvcDowOwogICAgICB9CgogICAgICAuc2xpZGUtYW5pbWF0ZS5uZy1sZWF2ZSB7CiAgICAgICAgdG9wOjA7CiAgICAgIH0KICAgICAgLnNsaWRlLWFuaW1hdGUubmctbGVhdmUubmctbGVhdmUtYWN0aXZlIHsKICAgICAgICB0b3A6NTBweDsKICAgICAgfQogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIHZhciB0ZW1wbGF0ZVNlbGVjdCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RlbXBsYXRlJykpOwogICAgICB2YXIgaW5jbHVkZUVsZW0gPSBlbGVtZW50KGJ5LmNzcygnW25nLWluY2x1ZGVdJykpOwoKICAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlMS5odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KGluY2x1ZGVFbGVtLmdldFRleHQoKSkudG9NYXRjaCgvQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbC8pOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTIuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdmaXJlZm94JykgewogICAgICAgICAgLy8gRmlyZWZveCBjYW4ndCBoYW5kbGUgdXNpbmcgc2VsZWN0cwogICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3Byb3RyYWN0b3IvaXNzdWVzLzQ4MAogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0ZW1wbGF0ZVNlbGVjdC5jbGljaygpOwogICAgICAgIHRlbXBsYXRlU2VsZWN0LmVsZW1lbnQuYWxsKGJ5LmNzcygnb3B0aW9uJykpLmdldCgyKS5jbGljaygpOwogICAgICAgIGV4cGVjdChpbmNsdWRlRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWwvKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGNoYW5nZSB0byBibGFuaycsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdmaXJlZm94JykgewogICAgICAgICAgLy8gRmlyZWZveCBjYW4ndCBoYW5kbGUgdXNpbmcgc2VsZWN0cwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0ZW1wbGF0ZVNlbGVjdC5jbGljaygpOwogICAgICAgIHRlbXBsYXRlU2VsZWN0LmVsZW1lbnQuYWxsKGJ5LmNzcygnb3B0aW9uJykpLmdldCgwKS5jbGljaygpOwogICAgICAgIGV4cGVjdChpbmNsdWRlRWxlbS5pc1ByZXNlbnQoKSkudG9CZShmYWxzZSk7CiAgICAgIH0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBldmVudAogKiBAbmFtZSBuZ0luY2x1ZGUjJGluY2x1ZGVDb250ZW50UmVxdWVzdGVkCiAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgc2NvcGUgbmdJbmNsdWRlIHdhcyBkZWNsYXJlZCBpbgogKiBAZGVzY3JpcHRpb24KICogRW1pdHRlZCBldmVyeSB0aW1lIHRoZSBuZ0luY2x1ZGUgY29udGVudCBpcyByZXF1ZXN0ZWQuCiAqLwoKCi8qKgogKiBAbmdkb2MgZXZlbnQKICogQG5hbWUgbmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudExvYWRlZAogKiBAZXZlbnRUeXBlIGVtaXQgb24gdGhlIGN1cnJlbnQgbmdJbmNsdWRlIHNjb3BlCiAqIEBkZXNjcmlwdGlvbgogKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nSW5jbHVkZSBjb250ZW50IGlzIHJlbG9hZGVkLgogKi8KdmFyIG5nSW5jbHVkZURpcmVjdGl2ZSA9IFsnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJGFuY2hvclNjcm9sbCcsICckYW5pbWF0ZScsICckc2NlJywKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oJGh0dHAsICAgJHRlbXBsYXRlQ2FjaGUsICAgJGFuY2hvclNjcm9sbCwgICAkYW5pbWF0ZSwgICAkc2NlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRUNBJywKICAgIHByaW9yaXR5OiA0MDAsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgIGNvbnRyb2xsZXI6IGFuZ3VsYXIubm9vcCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgdmFyIHNyY0V4cCA9IGF0dHIubmdJbmNsdWRlIHx8IGF0dHIuc3JjLAogICAgICAgICAgb25sb2FkRXhwID0gYXR0ci5vbmxvYWQgfHwgJycsCiAgICAgICAgICBhdXRvU2Nyb2xsRXhwID0gYXR0ci5hdXRvc2Nyb2xsOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwLAogICAgICAgICAgICBjdXJyZW50U2NvcGUsCiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudCwKICAgICAgICAgICAgY3VycmVudEVsZW1lbnQ7CgogICAgICAgIHZhciBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihwcmV2aW91c0VsZW1lbnQpIHsKICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYoY3VycmVudFNjb3BlKSB7CiAgICAgICAgICAgIGN1cnJlbnRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYoY3VycmVudEVsZW1lbnQpIHsKICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoY3VycmVudEVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQgPSBjdXJyZW50RWxlbWVudDsKICAgICAgICAgICAgY3VycmVudEVsZW1lbnQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNjb3BlLiR3YXRjaCgkc2NlLnBhcnNlQXNSZXNvdXJjZVVybChzcmNFeHApLCBmdW5jdGlvbiBuZ0luY2x1ZGVXYXRjaEFjdGlvbihzcmMpIHsKICAgICAgICAgIHZhciBhZnRlckFuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGF1dG9TY3JvbGxFeHApICYmICghYXV0b1Njcm9sbEV4cCB8fCBzY29wZS4kZXZhbChhdXRvU2Nyb2xsRXhwKSkpIHsKICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdGhpc0NoYW5nZUlkID0gKytjaGFuZ2VDb3VudGVyOwoKICAgICAgICAgIGlmIChzcmMpIHsKICAgICAgICAgICAgJGh0dHAuZ2V0KHNyYywge2NhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLnN1Y2Nlc3MoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkICE9PSBjaGFuZ2VDb3VudGVyKSByZXR1cm47CiAgICAgICAgICAgICAgdmFyIG5ld1Njb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgIGN0cmwudGVtcGxhdGUgPSByZXNwb25zZTsKCiAgICAgICAgICAgICAgLy8gTm90ZTogVGhpcyB3aWxsIGFsc28gbGluayBhbGwgY2hpbGRyZW4gb2YgbmctaW5jbHVkZSB0aGF0IHdlcmUgY29udGFpbmVkIGluIHRoZSBvcmlnaW5hbAogICAgICAgICAgICAgIC8vIGh0bWwuIElmIHRoYXQgY29udGVudCBjb250YWlucyBjb250cm9sbGVycywgLi4uIHRoZXkgY291bGQgcG9sbHV0ZS9jaGFuZ2UgdGhlIHNjb3BlLgogICAgICAgICAgICAgIC8vIEhvd2V2ZXIsIHVzaW5nIG5nLWluY2x1ZGUgb24gYW4gZWxlbWVudCB3aXRoIGFkZGl0aW9uYWwgY29udGVudCBkb2VzIG5vdCBtYWtlIHNlbnNlLi4uCiAgICAgICAgICAgICAgLy8gTm90ZTogV2UgY2FuJ3QgcmVtb3ZlIHRoZW0gaW4gdGhlIGNsb25lQXR0Y2hGbiBvZiAkdHJhbnNjbHVkZSBhcyB0aGF0CiAgICAgICAgICAgICAgLy8gZnVuY3Rpb24gaXMgY2FsbGVkIGJlZm9yZSBsaW5raW5nIHRoZSBjb250ZW50LCB3aGljaCB3b3VsZCBhcHBseSBjaGlsZAogICAgICAgICAgICAgIC8vIGRpcmVjdGl2ZXMgdG8gbm9uIGV4aXN0aW5nIGVsZW1lbnRzLgogICAgICAgICAgICAgIHZhciBjbG9uZSA9ICR0cmFuc2NsdWRlKG5ld1Njb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICAgICAgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCgpOwogICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2xvbmUsIG51bGwsICRlbGVtZW50LCBhZnRlckFuaW1hdGlvbik7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG5ld1Njb3BlOwogICAgICAgICAgICAgIGN1cnJlbnRFbGVtZW50ID0gY2xvbmU7CgogICAgICAgICAgICAgIGN1cnJlbnRTY29wZS4kZW1pdCgnJGluY2x1ZGVDb250ZW50TG9hZGVkJyk7CiAgICAgICAgICAgICAgc2NvcGUuJGV2YWwob25sb2FkRXhwKTsKICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCA9PT0gY2hhbmdlQ291bnRlcikgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudFJlcXVlc3RlZCcpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCgpOwogICAgICAgICAgICBjdHJsLnRlbXBsYXRlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9Owp9XTsKCi8vIFRoaXMgZGlyZWN0aXZlIGlzIGNhbGxlZCBkdXJpbmcgdGhlICR0cmFuc2NsdWRlIGNhbGwgb2YgdGhlIGZpcnN0IGBuZ0luY2x1ZGVgIGRpcmVjdGl2ZS4KLy8gSXQgd2lsbCByZXBsYWNlIGFuZCBjb21waWxlIHRoZSBjb250ZW50IG9mIHRoZSBlbGVtZW50IHdpdGggdGhlIGxvYWRlZCB0ZW1wbGF0ZS4KLy8gV2UgbmVlZCB0aGlzIGRpcmVjdGl2ZSBzbyB0aGF0IHRoZSBlbGVtZW50IGNvbnRlbnQgaXMgYWxyZWFkeSBmaWxsZWQgd2hlbgovLyB0aGUgbGluayBmdW5jdGlvbiBvZiBhbm90aGVyIGRpcmVjdGl2ZSBvbiB0aGUgc2FtZSBlbGVtZW50IGFzIG5nSW5jbHVkZQovLyBpcyBjYWxsZWQuCnZhciBuZ0luY2x1ZGVGaWxsQ29udGVudERpcmVjdGl2ZSA9IFsnJGNvbXBpbGUnLAogIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgIHByaW9yaXR5OiAtNDAwLAogICAgICByZXF1aXJlOiAnbmdJbmNsdWRlJywKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybCkgewogICAgICAgICRlbGVtZW50Lmh0bWwoY3RybC50ZW1wbGF0ZSk7CiAgICAgICAgJGNvbXBpbGUoJGVsZW1lbnQuY29udGVudHMoKSkoc2NvcGUpOwogICAgICB9CiAgICB9OwogIH1dOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdJbml0CiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0luaXRgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIGV2YWx1YXRlIGFuIGV4cHJlc3Npb24gaW4gdGhlCiAqIGN1cnJlbnQgc2NvcGUuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWVycm9yIj4KICogVGhlIG9ubHkgYXBwcm9wcmlhdGUgdXNlIG9mIGBuZ0luaXRgIGlzIGZvciBhbGlhc2luZyBzcGVjaWFsIHByb3BlcnRpZXMgb2YKICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBgbmdSZXBlYXRgfSwgYXMgc2VlbiBpbiB0aGUgZGVtbyBiZWxvdy4gQmVzaWRlcyB0aGlzIGNhc2UsIHlvdQogKiBzaG91bGQgdXNlIHtAbGluayBndWlkZS9jb250cm9sbGVyIGNvbnRyb2xsZXJzfSByYXRoZXIgdGhhbiBgbmdJbml0YAogKiB0byBpbml0aWFsaXplIHZhbHVlcyBvbiBhIHNjb3BlLgogKiA8L2Rpdj4KICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZSoqOiBJZiB5b3UgaGF2ZSBhc3NpZ25tZW50IGluIGBuZ0luaXRgIGFsb25nIHdpdGgge0BsaW5rIG5nLiRmaWx0ZXIgYCRmaWx0ZXJgfSwgbWFrZQogKiBzdXJlIHlvdSBoYXZlIHBhcmVudGhlc2lzIGZvciBjb3JyZWN0IHByZWNlZGVuY2U6CiAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICogICA8ZGl2IG5nLWluaXQ9InRlc3QxID0gKGRhdGEgfCBvcmRlckJ5OiduYW1lJykiPjwvZGl2PgogKiA8L3ByZT4KICogPC9kaXY+CiAqCiAqIEBwcmlvcml0eSA0NTAKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdJbml0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAkc2NvcGUubGlzdCA9IFtbJ2EnLCAnYiddLCBbJ2MnLCAnZCddXTsKICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxkaXYgbmctcmVwZWF0PSJpbm5lckxpc3QgaW4gbGlzdCIgbmctaW5pdD0ib3V0ZXJJbmRleCA9ICRpbmRleCI+CiAgICAgICA8ZGl2IG5nLXJlcGVhdD0idmFsdWUgaW4gaW5uZXJMaXN0IiBuZy1pbml0PSJpbm5lckluZGV4ID0gJGluZGV4Ij4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJleGFtcGxlLWluaXQiPmxpc3RbIHt7b3V0ZXJJbmRleH19IF1bIHt7aW5uZXJJbmRleH19IF0gPSB7e3ZhbHVlfX07PC9zcGFuPgogICAgICAgPC9kaXY+CiAgICAgPC9kaXY+CiAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgYWxpYXMgaW5kZXggcG9zaXRpb25zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBlbGVtZW50cyA9IGVsZW1lbnQuYWxsKGJ5LmNzcygnLmV4YW1wbGUtaW5pdCcpKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnRzLmdldCgwKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3RbIDAgXVsgMCBdID0gYTsnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnRzLmdldCgxKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3RbIDAgXVsgMSBdID0gYjsnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnRzLmdldCgyKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3RbIDEgXVsgMCBdID0gYzsnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnRzLmdldCgzKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3RbIDEgXVsgMSBdID0gZDsnKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KdmFyIG5nSW5pdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICBwcmlvcml0eTogNDUwLAogIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICBzY29wZS4kZXZhbChhdHRycy5uZ0luaXQpOwogICAgICB9CiAgICB9OwogIH0KfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ05vbkJpbmRhYmxlCiAqIEByZXN0cmljdCBBQwogKiBAcHJpb3JpdHkgMTAwMAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ05vbkJpbmRhYmxlYCBkaXJlY3RpdmUgdGVsbHMgQW5ndWxhciBub3QgdG8gY29tcGlsZSBvciBiaW5kIHRoZSBjb250ZW50cyBvZiB0aGUgY3VycmVudAogKiBET00gZWxlbWVudC4gVGhpcyBpcyB1c2VmdWwgaWYgdGhlIGVsZW1lbnQgY29udGFpbnMgd2hhdCBhcHBlYXJzIHRvIGJlIEFuZ3VsYXIgZGlyZWN0aXZlcyBhbmQKICogYmluZGluZ3MgYnV0IHdoaWNoIHNob3VsZCBiZSBpZ25vcmVkIGJ5IEFuZ3VsYXIuIFRoaXMgY291bGQgYmUgdGhlIGNhc2UgaWYgeW91IGhhdmUgYSBzaXRlIHRoYXQKICogZGlzcGxheXMgc25pcHBldHMgb2YgY29kZSwgZm9yIGluc3RhbmNlLgogKgogKiBAZWxlbWVudCBBTlkKICoKICogQGV4YW1wbGUKICogSW4gdGhpcyBleGFtcGxlIHRoZXJlIGFyZSB0d28gbG9jYXRpb25zIHdoZXJlIGEgc2ltcGxlIGludGVycG9sYXRpb24gYmluZGluZyAoYHt7fX1gKSBpcyBwcmVzZW50LAogKiBidXQgdGhlIG9uZSB3cmFwcGVkIGluIGBuZ05vbkJpbmRhYmxlYCBpcyBsZWZ0IGFsb25lLgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGU+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxkaXY+Tm9ybWFsOiB7ezEgKyAyfX08L2Rpdj4KICAgICAgICA8ZGl2IG5nLW5vbi1iaW5kYWJsZT5JZ25vcmVkOiB7ezEgKyAyfX08L2Rpdj4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctbm9uLWJpbmRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJzEgKyAyJykpLmdldFRleHQoKSkudG9Db250YWluKCczJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50LmFsbChieS5jc3MoJ2RpdicpKS5sYXN0KCkuZ2V0VGV4dCgpKS50b01hdGNoKC8xIFwrIDIvKTsKICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdOb25CaW5kYWJsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsgdGVybWluYWw6IHRydWUsIHByaW9yaXR5OiAxMDAwIH0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdQbHVyYWxpemUKICogQHJlc3RyaWN0IEVBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBgbmdQbHVyYWxpemVgIGlzIGEgZGlyZWN0aXZlIHRoYXQgZGlzcGxheXMgbWVzc2FnZXMgYWNjb3JkaW5nIHRvIGVuLVVTIGxvY2FsaXphdGlvbiBydWxlcy4KICogVGhlc2UgcnVsZXMgYXJlIGJ1bmRsZWQgd2l0aCBhbmd1bGFyLmpzLCBidXQgY2FuIGJlIG92ZXJyaWRkZW4KICogKHNlZSB7QGxpbmsgZ3VpZGUvaTE4biBBbmd1bGFyIGkxOG59IGRldiBndWlkZSkuIFlvdSBjb25maWd1cmUgbmdQbHVyYWxpemUgZGlyZWN0aXZlCiAqIGJ5IHNwZWNpZnlpbmcgdGhlIG1hcHBpbmdzIGJldHdlZW4KICogW3BsdXJhbCBjYXRlZ29yaWVzXShodHRwOi8vdW5pY29kZS5vcmcvcmVwb3MvY2xkci10bXAvdHJ1bmsvZGlmZi9zdXBwbGVtZW50YWwvbGFuZ3VhZ2VfcGx1cmFsX3J1bGVzLmh0bWwpCiAqIGFuZCB0aGUgc3RyaW5ncyB0byBiZSBkaXNwbGF5ZWQuCiAqCiAqICMgUGx1cmFsIGNhdGVnb3JpZXMgYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcwogKiBUaGVyZSBhcmUgdHdvCiAqIFtwbHVyYWwgY2F0ZWdvcmllc10oaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sKQogKiBpbiBBbmd1bGFyJ3MgZGVmYXVsdCBlbi1VUyBsb2NhbGU6ICJvbmUiIGFuZCAib3RoZXIiLgogKgogKiBXaGlsZSBhIHBsdXJhbCBjYXRlZ29yeSBtYXkgbWF0Y2ggbWFueSBudW1iZXJzIChmb3IgZXhhbXBsZSwgaW4gZW4tVVMgbG9jYWxlLCAib3RoZXIiIGNhbiBtYXRjaAogKiBhbnkgbnVtYmVyIHRoYXQgaXMgbm90IDEpLCBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBjYW4gb25seSBtYXRjaCBvbmUgbnVtYmVyLiBGb3IgZXhhbXBsZSwgdGhlCiAqIGV4cGxpY2l0IG51bWJlciBydWxlIGZvciAiMyIgbWF0Y2hlcyB0aGUgbnVtYmVyIDMuIFRoZXJlIGFyZSBleGFtcGxlcyBvZiBwbHVyYWwgY2F0ZWdvcmllcwogKiBhbmQgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIHRocm91Z2hvdXQgdGhlIHJlc3Qgb2YgdGhpcyBkb2N1bWVudGF0aW9uLgogKgogKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplCiAqIFlvdSBjb25maWd1cmUgbmdQbHVyYWxpemUgYnkgcHJvdmlkaW5nIDIgYXR0cmlidXRlczogYGNvdW50YCBhbmQgYHdoZW5gLgogKiBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCBhdHRyaWJ1dGUsIGBvZmZzZXRgLgogKgogKiBUaGUgdmFsdWUgb2YgdGhlIGBjb3VudGAgYXR0cmlidXRlIGNhbiBiZSBlaXRoZXIgYSBzdHJpbmcgb3IgYW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24KICogQW5ndWxhciBleHByZXNzaW9ufTsgdGhlc2UgYXJlIGV2YWx1YXRlZCBvbiB0aGUgY3VycmVudCBzY29wZSBmb3IgaXRzIGJvdW5kIHZhbHVlLgogKgogKiBUaGUgYHdoZW5gIGF0dHJpYnV0ZSBzcGVjaWZpZXMgdGhlIG1hcHBpbmdzIGJldHdlZW4gcGx1cmFsIGNhdGVnb3JpZXMgYW5kIHRoZSBhY3R1YWwKICogc3RyaW5nIHRvIGJlIGRpc3BsYXllZC4gVGhlIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUgc2hvdWxkIGJlIGEgSlNPTiBvYmplY3QuCiAqCiAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gY29uZmlndXJlIG5nUGx1cmFsaXplOgogKgogKiBgYGBodG1sCiAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICAgICAgICAgICAgICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJzEgcGVyc29uIGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t9IHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAqIDwvbmctcGx1cmFsaXplPgogKmBgYAogKgogKiBJbiB0aGUgZXhhbXBsZSwgYCIwOiBOb2JvZHkgaXMgdmlld2luZy4iYCBpcyBhbiBleHBsaWNpdCBudW1iZXIgcnVsZS4gSWYgeW91IGRpZCBub3QKICogc3BlY2lmeSB0aGlzIHJ1bGUsIDAgd291bGQgYmUgbWF0Y2hlZCB0byB0aGUgIm90aGVyIiBjYXRlZ29yeSBhbmQgIjAgcGVvcGxlIGFyZSB2aWV3aW5nIgogKiB3b3VsZCBiZSBzaG93biBpbnN0ZWFkIG9mICJOb2JvZHkgaXMgdmlld2luZyIuIFlvdSBjYW4gc3BlY2lmeSBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IKICogb3RoZXIgbnVtYmVycywgZm9yIGV4YW1wbGUgMTIsIHNvIHRoYXQgaW5zdGVhZCBvZiBzaG93aW5nICIxMiBwZW9wbGUgYXJlIHZpZXdpbmciLCB5b3UgY2FuCiAqIHNob3cgImEgZG96ZW4gcGVvcGxlIGFyZSB2aWV3aW5nIi4KICoKICogWW91IGNhbiB1c2UgYSBzZXQgb2YgY2xvc2VkIGJyYWNlcyAoYHt9YCkgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIG51bWJlciB0aGF0IHlvdSB3YW50IHN1YnN0aXR1dGVkCiAqIGludG8gcGx1cmFsaXplZCBzdHJpbmdzLiBJbiB0aGUgcHJldmlvdXMgZXhhbXBsZSwgQW5ndWxhciB3aWxsIHJlcGxhY2UgYHt9YCB3aXRoCiAqIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT5ge3twZXJzb25Db3VudH19YDwvc3Bhbj4uIFRoZSBjbG9zZWQgYnJhY2VzIGB7fWAgaXMgYSBwbGFjZWhvbGRlcgogKiBmb3IgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7bnVtYmVyRXhwcmVzc2lvbn19PC9zcGFuPi4KICoKICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZSB3aXRoIG9mZnNldAogKiBUaGUgYG9mZnNldGAgYXR0cmlidXRlIGFsbG93cyBmdXJ0aGVyIGN1c3RvbWl6YXRpb24gb2YgcGx1cmFsaXplZCB0ZXh0LCB3aGljaCBjYW4gcmVzdWx0IGluCiAqIGEgYmV0dGVyIHVzZXIgZXhwZXJpZW5jZS4gRm9yIGV4YW1wbGUsIGluc3RlYWQgb2YgdGhlIG1lc3NhZ2UgIjQgcGVvcGxlIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLAogKiB5b3UgbWlnaHQgZGlzcGxheSAiSm9obiwgS2F0ZSBhbmQgMiBvdGhlcnMgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIuCiAqIFRoZSBvZmZzZXQgYXR0cmlidXRlIGFsbG93cyB5b3UgdG8gb2Zmc2V0IGEgbnVtYmVyIGJ5IGFueSBkZXNpcmVkIHZhbHVlLgogKiBMZXQncyB0YWtlIGEgbG9vayBhdCBhbiBleGFtcGxlOgogKgogKiBgYGBodG1sCiAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogKiAgICAgICAgICAgICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnMSc6ICd7e3BlcnNvbjF9fSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICcyJzogJ3t7cGVyc29uMX19IGFuZCB7e3BlcnNvbjJ9fSBhcmUgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCB7fSBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogKiA8L25nLXBsdXJhbGl6ZT4KICogYGBgCiAqCiAqIE5vdGljZSB0aGF0IHdlIGFyZSBzdGlsbCB1c2luZyB0d28gcGx1cmFsIGNhdGVnb3JpZXMob25lLCBvdGhlciksIGJ1dCB3ZSBhZGRlZAogKiB0aHJlZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgMCwgMSBhbmQgMi4KICogV2hlbiBvbmUgcGVyc29uLCBwZXJoYXBzIEpvaG4sIHZpZXdzIHRoZSBkb2N1bWVudCwgIkpvaG4gaXMgdmlld2luZyIgd2lsbCBiZSBzaG93bi4KICogV2hlbiB0aHJlZSBwZW9wbGUgdmlldyB0aGUgZG9jdW1lbnQsIG5vIGV4cGxpY2l0IG51bWJlciBydWxlIGlzIGZvdW5kLCBzbwogKiBhbiBvZmZzZXQgb2YgMiBpcyB0YWtlbiBvZmYgMywgYW5kIEFuZ3VsYXIgdXNlcyAxIHRvIGRlY2lkZSB0aGUgcGx1cmFsIGNhdGVnb3J5LgogKiBJbiB0aGlzIGNhc2UsIHBsdXJhbCBjYXRlZ29yeSAnb25lJyBpcyBtYXRjaGVkIGFuZCAiSm9obiwgTWFycnkgYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmciCiAqIGlzIHNob3duLgogKgogKiBOb3RlIHRoYXQgd2hlbiB5b3Ugc3BlY2lmeSBvZmZzZXRzLCB5b3UgbXVzdCBwcm92aWRlIGV4cGxpY2l0IG51bWJlciBydWxlcyBmb3IKICogbnVtYmVycyBmcm9tIDAgdXAgdG8gYW5kIGluY2x1ZGluZyB0aGUgb2Zmc2V0LiBJZiB5b3UgdXNlIGFuIG9mZnNldCBvZiAzLCBmb3IgZXhhbXBsZSwKICogeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yIDAsIDEsIDIgYW5kIDMuIFlvdSBtdXN0IGFsc28gcHJvdmlkZSBwbHVyYWwgc3RyaW5ncyBmb3IKICogcGx1cmFsIGNhdGVnb3JpZXMgIm9uZSIgYW5kICJvdGhlciIuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfGV4cHJlc3Npb259IGNvdW50IFRoZSB2YXJpYWJsZSB0byBiZSBib3VuZCB0by4KICogQHBhcmFtIHtzdHJpbmd9IHdoZW4gVGhlIG1hcHBpbmcgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcnkgdG8gaXRzIGNvcnJlc3BvbmRpbmcgc3RyaW5ncy4KICogQHBhcmFtIHtudW1iZXI9fSBvZmZzZXQgT2Zmc2V0IHRvIGRlZHVjdCBmcm9tIHRoZSB0b3RhbCBudW1iZXIuCiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPHNjcmlwdD4KICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5wZXJzb24xID0gJ0lnb3InOwogICAgICAgICAgICAkc2NvcGUucGVyc29uMiA9ICdNaXNrbyc7CiAgICAgICAgICAgICRzY29wZS5wZXJzb25Db3VudCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgIFBlcnNvbiAxOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMSIgdmFsdWU9Iklnb3IiIC8+PGJyLz4KICAgICAgICAgIFBlcnNvbiAyOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMiIgdmFsdWU9Ik1pc2tvIiAvPjxici8+CiAgICAgICAgICBOdW1iZXIgb2YgUGVvcGxlOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uQ291bnQiIHZhbHVlPSIxIiAvPjxici8+CgogICAgICAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIHNpbXBsZSBwbHVyYWxpemF0aW9uIHJ1bGVzIGZvciBlbiBsb2NhbGUgLS0tPgogICAgICAgICAgV2l0aG91dCBPZmZzZXQ6CiAgICAgICAgICA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJzEgcGVyc29uIGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICAgICAgPC9uZy1wbHVyYWxpemU+PGJyPgoKICAgICAgICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBvZmZzZXQgLS0tPgogICAgICAgICAgV2l0aCBPZmZzZXQoMik6CiAgICAgICAgICA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIgb2Zmc2V0PTIKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMSc6ICd7e3BlcnNvbjF9fSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCB7fSBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICAgICAgPC9uZy1wbHVyYWxpemU+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBzaG93IGNvcnJlY3QgcGx1cmFsaXplZCBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB3aXRob3V0T2Zmc2V0ID0gZWxlbWVudC5hbGwoYnkuY3NzKCduZy1wbHVyYWxpemUnKSkuZ2V0KDApOwogICAgICAgICAgdmFyIHdpdGhPZmZzZXQgPSBlbGVtZW50LmFsbChieS5jc3MoJ25nLXBsdXJhbGl6ZScpKS5nZXQoMSk7CiAgICAgICAgICB2YXIgY291bnRJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbkNvdW50JykpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnMSBwZXJzb24gaXMgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciBpcyB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzAnKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ05vYm9keSBpcyB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdOb2JvZHkgaXMgdmlld2luZy4nKTsKCiAgICAgICAgICBjb3VudElucHV0LmNsZWFyKCk7CiAgICAgICAgICBjb3VudElucHV0LnNlbmRLZXlzKCcyJyk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCcyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciBhbmQgTWlza28gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgY291bnRJbnB1dC5jbGVhcigpOwogICAgICAgICAgY291bnRJbnB1dC5zZW5kS2V5cygnMycpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnMyBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ0lnb3IsIE1pc2tvIGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzQnKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJzQgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdJZ29yLCBNaXNrbyBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBzaG93IGRhdGEtYm91bmQgbmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB3aXRoT2Zmc2V0ID0gZWxlbWVudC5hbGwoYnkuY3NzKCduZy1wbHVyYWxpemUnKSkuZ2V0KDEpOwogICAgICAgICAgdmFyIHBlcnNvbkNvdW50ID0gZWxlbWVudChieS5tb2RlbCgncGVyc29uQ291bnQnKSk7CiAgICAgICAgICB2YXIgcGVyc29uMSA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbjEnKSk7CiAgICAgICAgICB2YXIgcGVyc29uMiA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbjInKSk7CiAgICAgICAgICBwZXJzb25Db3VudC5jbGVhcigpOwogICAgICAgICAgcGVyc29uQ291bnQuc2VuZEtleXMoJzQnKTsKICAgICAgICAgIHBlcnNvbjEuY2xlYXIoKTsKICAgICAgICAgIHBlcnNvbjEuc2VuZEtleXMoJ0RpJyk7CiAgICAgICAgICBwZXJzb24yLmNsZWFyKCk7CiAgICAgICAgICBwZXJzb24yLnNlbmRLZXlzKCdWb2p0YScpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdEaSwgVm9qdGEgYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdQbHVyYWxpemVEaXJlY3RpdmUgPSBbJyRsb2NhbGUnLCAnJGludGVycG9sYXRlJywgZnVuY3Rpb24oJGxvY2FsZSwgJGludGVycG9sYXRlKSB7CiAgdmFyIEJSQUNFID0gL3t9L2c7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRUEnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgdmFyIG51bWJlckV4cCA9IGF0dHIuY291bnQsCiAgICAgICAgICB3aGVuRXhwID0gYXR0ci4kYXR0ci53aGVuICYmIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLndoZW4pLCAvLyB3ZSBoYXZlIHt7fX0gaW4gYXR0cnMKICAgICAgICAgIG9mZnNldCA9IGF0dHIub2Zmc2V0IHx8IDAsCiAgICAgICAgICB3aGVucyA9IHNjb3BlLiRldmFsKHdoZW5FeHApIHx8IHt9LAogICAgICAgICAgd2hlbnNFeHBGbnMgPSB7fSwKICAgICAgICAgIHN0YXJ0U3ltYm9sID0gJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sKCksCiAgICAgICAgICBlbmRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCksCiAgICAgICAgICBpc1doZW4gPSAvXndoZW4oTWludXMpPyguKykkLzsKCiAgICAgIGZvckVhY2goYXR0ciwgZnVuY3Rpb24oZXhwcmVzc2lvbiwgYXR0cmlidXRlTmFtZSkgewogICAgICAgIGlmIChpc1doZW4udGVzdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgd2hlbnNbbG93ZXJjYXNlKGF0dHJpYnV0ZU5hbWUucmVwbGFjZSgnd2hlbicsICcnKS5yZXBsYWNlKCdNaW51cycsICctJykpXSA9CiAgICAgICAgICAgIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyW2F0dHJpYnV0ZU5hbWVdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBmb3JFYWNoKHdoZW5zLCBmdW5jdGlvbihleHByZXNzaW9uLCBrZXkpIHsKICAgICAgICB3aGVuc0V4cEZuc1trZXldID0KICAgICAgICAgICRpbnRlcnBvbGF0ZShleHByZXNzaW9uLnJlcGxhY2UoQlJBQ0UsIHN0YXJ0U3ltYm9sICsgbnVtYmVyRXhwICsgJy0nICsKICAgICAgICAgICAgb2Zmc2V0ICsgZW5kU3ltYm9sKSk7CiAgICAgIH0pOwoKICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2goKSB7CiAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VGbG9hdChzY29wZS4kZXZhbChudW1iZXJFeHApKTsKCiAgICAgICAgaWYgKCFpc05hTih2YWx1ZSkpIHsKICAgICAgICAgIC8vaWYgZXhwbGljaXQgbnVtYmVyIHJ1bGUgc3VjaCBhcyAxLCAyLCAzLi4uIGlzIGRlZmluZWQsIGp1c3QgdXNlIGl0LiBPdGhlcndpc2UsCiAgICAgICAgICAvL2NoZWNrIGl0IGFnYWluc3QgcGx1cmFsaXphdGlvbiBydWxlcyBpbiAkbG9jYWxlIHNlcnZpY2UKICAgICAgICAgIGlmICghKHZhbHVlIGluIHdoZW5zKSkgdmFsdWUgPSAkbG9jYWxlLnBsdXJhbENhdCh2YWx1ZSAtIG9mZnNldCk7CiAgICAgICAgICAgcmV0dXJuIHdoZW5zRXhwRm5zW3ZhbHVlXShzY29wZSwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CiAgICAgIH0sIGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgZWxlbWVudC50ZXh0KG5ld1ZhbCk7CiAgICAgIH0pOwogICAgfQogIH07Cn1dOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdSZXBlYXQKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdSZXBlYXRgIGRpcmVjdGl2ZSBpbnN0YW50aWF0ZXMgYSB0ZW1wbGF0ZSBvbmNlIHBlciBpdGVtIGZyb20gYSBjb2xsZWN0aW9uLiBFYWNoIHRlbXBsYXRlCiAqIGluc3RhbmNlIGdldHMgaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwKICogYW5kIGAkaW5kZXhgIGlzIHNldCB0byB0aGUgaXRlbSBpbmRleCBvciBrZXkuCiAqCiAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogKgogKiB8IFZhcmlhYmxlICB8IFR5cGUgICAgICAgICAgICB8IERldGFpbHMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwtLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICogfCBgJGluZGV4YCAgfCB7QHR5cGUgbnVtYmVyfSAgfCBpdGVyYXRvciBvZmZzZXQgb2YgdGhlIHJlcGVhdGVkIGVsZW1lbnQgKDAuLmxlbmd0aC0xKSAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IGAkZmlyc3RgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgZmlyc3QgaW4gdGhlIGl0ZXJhdG9yLiAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwgYCRtaWRkbGVgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBiZXR3ZWVuIHRoZSBmaXJzdCBhbmQgbGFzdCBpbiB0aGUgaXRlcmF0b3IuIHwKICogfCBgJGxhc3RgICAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLiAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IGAkZXZlbmAgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIGl0ZXJhdG9yIHBvc2l0aW9uIGAkaW5kZXhgIGlzIGV2ZW4gKG90aGVyd2lzZSBmYWxzZSkuICAgICAgICAgICB8CiAqIHwgYCRvZGRgICAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgaXRlcmF0b3IgcG9zaXRpb24gYCRpbmRleGAgaXMgb2RkIChvdGhlcndpc2UgZmFsc2UpLiAgICAgICAgICAgIHwKICoKICogQ3JlYXRpbmcgYWxpYXNlcyBmb3IgdGhlc2UgcHJvcGVydGllcyBpcyBwb3NzaWJsZSB3aXRoIHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbml0IGBuZ0luaXRgfS4KICogVGhpcyBtYXkgYmUgdXNlZnVsIHdoZW4sIGZvciBpbnN0YW5jZSwgbmVzdGluZyBuZ1JlcGVhdHMuCiAqCiAqICMgU3BlY2lhbCByZXBlYXQgc3RhcnQgYW5kIGVuZCBwb2ludHMKICogVG8gcmVwZWF0IGEgc2VyaWVzIG9mIGVsZW1lbnRzIGluc3RlYWQgb2YganVzdCBvbmUgcGFyZW50IGVsZW1lbnQsIG5nUmVwZWF0IChhcyB3ZWxsIGFzIG90aGVyIG5nIGRpcmVjdGl2ZXMpIHN1cHBvcnRzIGV4dGVuZGluZwogKiB0aGUgcmFuZ2Ugb2YgdGhlIHJlcGVhdGVyIGJ5IGRlZmluaW5nIGV4cGxpY2l0IHN0YXJ0IGFuZCBlbmQgcG9pbnRzIGJ5IHVzaW5nICoqbmctcmVwZWF0LXN0YXJ0KiogYW5kICoqbmctcmVwZWF0LWVuZCoqIHJlc3BlY3RpdmVseS4KICogVGhlICoqbmctcmVwZWF0LXN0YXJ0KiogZGlyZWN0aXZlIHdvcmtzIHRoZSBzYW1lIGFzICoqbmctcmVwZWF0KiosIGJ1dCB3aWxsIHJlcGVhdCBhbGwgdGhlIEhUTUwgY29kZSAoaW5jbHVkaW5nIHRoZSB0YWcgaXQncyBkZWZpbmVkIG9uKQogKiB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBlbmRpbmcgSFRNTCB0YWcgd2hlcmUgKipuZy1yZXBlYXQtZW5kKiogaXMgcGxhY2VkLgogKgogKiBUaGUgZXhhbXBsZSBiZWxvdyBtYWtlcyB1c2Ugb2YgdGhpcyBmZWF0dXJlOgogKiBgYGBodG1sCiAqICAgPGhlYWRlciBuZy1yZXBlYXQtc3RhcnQ9Iml0ZW0gaW4gaXRlbXMiPgogKiAgICAgSGVhZGVyIHt7IGl0ZW0gfX0KICogICA8L2hlYWRlcj4KICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICogICAgIEJvZHkge3sgaXRlbSB9fQogKiAgIDwvZGl2PgogKiAgIDxmb290ZXIgbmctcmVwZWF0LWVuZD4KICogICAgIEZvb3RlciB7eyBpdGVtIH19CiAqICAgPC9mb290ZXI+CiAqIGBgYAogKgogKiBBbmQgd2l0aCBhbiBpbnB1dCBvZiB7QHR5cGUgWydBJywnQiddfSBmb3IgdGhlIGl0ZW1zIHZhcmlhYmxlIGluIHRoZSBleGFtcGxlIGFib3ZlLCB0aGUgb3V0cHV0IHdpbGwgZXZhbHVhdGUgdG86CiAqIGBgYGh0bWwKICogICA8aGVhZGVyPgogKiAgICAgSGVhZGVyIEEKICogICA8L2hlYWRlcj4KICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICogICAgIEJvZHkgQQogKiAgIDwvZGl2PgogKiAgIDxmb290ZXI+CiAqICAgICBGb290ZXIgQQogKiAgIDwvZm9vdGVyPgogKiAgIDxoZWFkZXI+CiAqICAgICBIZWFkZXIgQgogKiAgIDwvaGVhZGVyPgogKiAgIDxkaXYgY2xhc3M9ImJvZHkiPgogKiAgICAgQm9keSBCCiAqICAgPC9kaXY+CiAqICAgPGZvb3Rlcj4KICogICAgIEZvb3RlciBCCiAqICAgPC9mb290ZXI+CiAqIGBgYAogKgogKiBUaGUgY3VzdG9tIHN0YXJ0IGFuZCBlbmQgcG9pbnRzIGZvciBuZ1JlcGVhdCBhbHNvIHN1cHBvcnQgYWxsIG90aGVyIEhUTUwgZGlyZWN0aXZlIHN5bnRheCBmbGF2b3JzIHByb3ZpZGVkIGluIEFuZ3VsYXJKUyAoc3VjaAogKiBhcyAqKmRhdGEtbmctcmVwZWF0LXN0YXJ0KiosICoqeC1uZy1yZXBlYXQtc3RhcnQqKiBhbmQgKipuZzpyZXBlYXQtc3RhcnQqKikuCiAqCiAqIEBhbmltYXRpb25zCiAqICoqLmVudGVyKiogLSB3aGVuIGEgbmV3IGl0ZW0gaXMgYWRkZWQgdG8gdGhlIGxpc3Qgb3Igd2hlbiBhbiBpdGVtIGlzIHJldmVhbGVkIGFmdGVyIGEgZmlsdGVyCiAqCiAqICoqLmxlYXZlKiogLSB3aGVuIGFuIGl0ZW0gaXMgcmVtb3ZlZCBmcm9tIHRoZSBsaXN0IG9yIHdoZW4gYW4gaXRlbSBpcyBmaWx0ZXJlZCBvdXQKICoKICogKioubW92ZSoqIC0gd2hlbiBhbiBhZGphY2VudCBpdGVtIGlzIGZpbHRlcmVkIG91dCBjYXVzaW5nIGEgcmVvcmRlciBvciB3aGVuIHRoZSBpdGVtIGNvbnRlbnRzIGFyZSByZW9yZGVyZWQKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBzY29wZQogKiBAcHJpb3JpdHkgMTAwMAogKiBAcGFyYW0ge3JlcGVhdF9leHByZXNzaW9ufSBuZ1JlcGVhdCBUaGUgZXhwcmVzc2lvbiBpbmRpY2F0aW5nIGhvdyB0byBlbnVtZXJhdGUgYSBjb2xsZWN0aW9uLiBUaGVzZQogKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAqCiAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgYWxidW0gaW4gYXJ0aXN0LmFsYnVtc2AuCiAqCiAqICAgKiBgKGtleSwgdmFsdWUpIGluIGV4cHJlc3Npb25gIOKAkyB3aGVyZSBga2V5YCBhbmQgYHZhbHVlYCBjYW4gYmUgYW55IHVzZXIgZGVmaW5lZCBpZGVudGlmaWVycywKICogICAgIGFuZCBgZXhwcmVzc2lvbmAgaXMgdGhlIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgKG5hbWUsIGFnZSkgaW4geydhZGFtJzoxMCwgJ2FtYWxpZSc6MTJ9YC4KICoKICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uIHRyYWNrIGJ5IHRyYWNraW5nX2V4cHJlc3Npb25gIOKAkyBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCB0cmFja2luZyBmdW5jdGlvbgogKiAgICAgd2hpY2ggY2FuIGJlIHVzZWQgdG8gYXNzb2NpYXRlIHRoZSBvYmplY3RzIGluIHRoZSBjb2xsZWN0aW9uIHdpdGggdGhlIERPTSBlbGVtZW50cy4gSWYgbm8gdHJhY2tpbmcgZnVuY3Rpb24KICogICAgIGlzIHNwZWNpZmllZCB0aGUgbmctcmVwZWF0IGFzc29jaWF0ZXMgZWxlbWVudHMgYnkgaWRlbnRpdHkgaW4gdGhlIGNvbGxlY3Rpb24uIEl0IGlzIGFuIGVycm9yIHRvIGhhdmUKICogICAgIG1vcmUgdGhhbiBvbmUgdHJhY2tpbmcgZnVuY3Rpb24gdG8gcmVzb2x2ZSB0byB0aGUgc2FtZSBrZXkuIChUaGlzIHdvdWxkIG1lYW4gdGhhdCB0d28gZGlzdGluY3Qgb2JqZWN0cyBhcmUKICogICAgIG1hcHBlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudCwgd2hpY2ggaXMgbm90IHBvc3NpYmxlLikgIEZpbHRlcnMgc2hvdWxkIGJlIGFwcGxpZWQgdG8gdGhlIGV4cHJlc3Npb24sCiAqICAgICBiZWZvcmUgc3BlY2lmeWluZyBhIHRyYWNraW5nIGV4cHJlc3Npb24uCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXNgIGlzIGVxdWl2YWxlbnQgdG8gYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgJGlkKGl0ZW0pYC4gVGhpcyBpbXBsaWVzIHRoYXQgdGhlIERPTSBlbGVtZW50cwogKiAgICAgd2lsbCBiZSBhc3NvY2lhdGVkIGJ5IGl0ZW0gaWRlbnRpdHkgaW4gdGhlIGFycmF5LgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5ICRpZChpdGVtKWAuIEEgYnVpbHQgaW4gYCRpZCgpYCBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byBhc3NpZ24gYSB1bmlxdWUKICogICAgIGAkJGhhc2hLZXlgIHByb3BlcnR5IHRvIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXkuIFRoaXMgcHJvcGVydHkgaXMgdGhlbiB1c2VkIGFzIGEga2V5IHRvIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnRzCiAqICAgICB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGl0ZW0gaW4gdGhlIGFycmF5IGJ5IGlkZW50aXR5LiBNb3ZpbmcgdGhlIHNhbWUgb2JqZWN0IGluIGFycmF5IHdvdWxkIG1vdmUgdGhlIERPTQogKiAgICAgZWxlbWVudCBpbiB0aGUgc2FtZSB3YXkgaW4gdGhlIERPTS4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSBpdGVtLmlkYCBpcyBhIHR5cGljYWwgcGF0dGVybiB3aGVuIHRoZSBpdGVtcyBjb21lIGZyb20gdGhlIGRhdGFiYXNlLiBJbiB0aGlzCiAqICAgICBjYXNlIHRoZSBvYmplY3QgaWRlbnRpdHkgZG9lcyBub3QgbWF0dGVyLiBUd28gb2JqZWN0cyBhcmUgY29uc2lkZXJlZCBlcXVpdmFsZW50IGFzIGxvbmcgYXMgdGhlaXIgYGlkYAogKiAgICAgcHJvcGVydHkgaXMgc2FtZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB8IGZpbHRlcjpzZWFyY2hUZXh0IHRyYWNrIGJ5IGl0ZW0uaWRgIGlzIGEgcGF0dGVybiB0aGF0IG1pZ2h0IGJlIHVzZWQgdG8gYXBwbHkgYSBmaWx0ZXIKICogICAgIHRvIGl0ZW1zIGluIGNvbmp1bmN0aW9uIHdpdGggYSB0cmFja2luZyBleHByZXNzaW9uLgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICogdGhlbiB1c2VzIGBuZ1JlcGVhdGAgdG8gZGlzcGxheSBldmVyeSBwZXJzb246CiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gWwogICAgICAgIHtuYW1lOidKb2huJywgYWdlOjI1LCBnZW5kZXI6J2JveSd9LAogICAgICAgIHtuYW1lOidKZXNzaWUnLCBhZ2U6MzAsIGdlbmRlcjonZ2lybCd9LAogICAgICAgIHtuYW1lOidKb2hhbm5hJywgYWdlOjI4LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICB7bmFtZTonSm95JywgYWdlOjE1LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICB7bmFtZTonTWFyeScsIGFnZToyOCwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAge25hbWU6J1BldGVyJywgYWdlOjk1LCBnZW5kZXI6J2JveSd9LAogICAgICAgIHtuYW1lOidTZWJhc3RpYW4nLCBhZ2U6NTAsIGdlbmRlcjonYm95J30sCiAgICAgICAge25hbWU6J0VyaWthJywgYWdlOjI3LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICB7bmFtZTonUGF0cmljaycsIGFnZTo0MCwgZ2VuZGVyOidib3knfSwKICAgICAgICB7bmFtZTonU2FtYW50aGEnLCBhZ2U6NjAsIGdlbmRlcjonZ2lybCd9CiAgICAgIF0iPgogICAgICAgIEkgaGF2ZSB7e2ZyaWVuZHMubGVuZ3RofX0gZnJpZW5kcy4gVGhleSBhcmU6CiAgICAgICAgPGlucHV0IHR5cGU9InNlYXJjaCIgbmctbW9kZWw9InEiIHBsYWNlaG9sZGVyPSJmaWx0ZXIgZnJpZW5kcy4uLiIgLz4KICAgICAgICA8dWwgY2xhc3M9ImV4YW1wbGUtYW5pbWF0ZS1jb250YWluZXIiPgogICAgICAgICAgPGxpIGNsYXNzPSJhbmltYXRlLXJlcGVhdCIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpxIj4KICAgICAgICAgICAgW3t7JGluZGV4ICsgMX19XSB7e2ZyaWVuZC5uYW1lfX0gd2hvIGlzIHt7ZnJpZW5kLmFnZX19IHllYXJzIG9sZC4KICAgICAgICAgIDwvbGk+CiAgICAgICAgPC91bD4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyIHsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgbGlzdC1zdHlsZTpub25lOwogICAgICAgIG1hcmdpbjowOwogICAgICAgIHBhZGRpbmc6MCAxMHB4OwogICAgICB9CgogICAgICAuYW5pbWF0ZS1yZXBlYXQgewogICAgICAgIGxpbmUtaGVpZ2h0OjQwcHg7CiAgICAgICAgbGlzdC1zdHlsZTpub25lOwogICAgICAgIGJveC1zaXppbmc6Ym9yZGVyLWJveDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLW1vdmUsCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlciwKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbGVhdmUubmctbGVhdmUtYWN0aXZlLAogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbW92ZSwKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWVudGVyIHsKICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgbWF4LWhlaWdodDowOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbGVhdmUsCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1tb3ZlLm5nLW1vdmUtYWN0aXZlLAogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgbWF4LWhlaWdodDo0MHB4OwogICAgICB9CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIGZyaWVuZHMgPSBlbGVtZW50LmFsbChieS5yZXBlYXRlcignZnJpZW5kIGluIGZyaWVuZHMnKSk7CgogICAgICBpdCgnc2hvdWxkIHJlbmRlciBpbml0aWFsIGRhdGEgc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMuY291bnQoKSkudG9CZSgxMCk7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMuZ2V0KDApLmdldFRleHQoKSkudG9FcXVhbCgnWzFdIEpvaG4gd2hvIGlzIDI1IHllYXJzIG9sZC4nKTsKICAgICAgICBleHBlY3QoZnJpZW5kcy5nZXQoMSkuZ2V0VGV4dCgpKS50b0VxdWFsKCdbMl0gSmVzc2llIHdobyBpcyAzMCB5ZWFycyBvbGQuJyk7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMubGFzdCgpLmdldFRleHQoKSkudG9FcXVhbCgnWzEwXSBTYW1hbnRoYSB3aG8gaXMgNjAgeWVhcnMgb2xkLicpOwogICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2ZyaWVuZHMubGVuZ3RoJykpLmdldFRleHQoKSkKICAgICAgICAgICAgLnRvTWF0Y2goIkkgaGF2ZSAxMCBmcmllbmRzLiBUaGV5IGFyZToiKTsKICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgcmVwZWF0ZXIgd2hlbiBmaWx0ZXIgcHJlZGljYXRlIGNoYW5nZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuY291bnQoKSkudG9CZSgxMCk7CgogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdxJykpLnNlbmRLZXlzKCdtYScpOwoKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuY291bnQoKSkudG9CZSgyKTsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuZ2V0KDApLmdldFRleHQoKSkudG9FcXVhbCgnWzFdIE1hcnkgd2hvIGlzIDI4IHllYXJzIG9sZC4nKTsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMubGFzdCgpLmdldFRleHQoKSkudG9FcXVhbCgnWzJdIFNhbWFudGhhIHdobyBpcyA2MCB5ZWFycyBvbGQuJyk7CiAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIG5nUmVwZWF0RGlyZWN0aXZlID0gWyckcGFyc2UnLCAnJGFuaW1hdGUnLCBmdW5jdGlvbigkcGFyc2UsICRhbmltYXRlKSB7CiAgdmFyIE5HX1JFTU9WRUQgPSAnJCROR19SRU1PVkVEJzsKICB2YXIgbmdSZXBlYXRNaW5FcnIgPSBtaW5FcnIoJ25nUmVwZWF0Jyk7CiAgcmV0dXJuIHsKICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgIHByaW9yaXR5OiAxMDAwLAogICAgdGVybWluYWw6IHRydWUsCiAgICAkJHRsYjogdHJ1ZSwKICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJsLCAkdHJhbnNjbHVkZSl7CiAgICAgICAgdmFyIGV4cHJlc3Npb24gPSAkYXR0ci5uZ1JlcGVhdDsKICAgICAgICB2YXIgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKC9eXHMqKFtcc1xTXSs/KVxzK2luXHMrKFtcc1xTXSs/KSg/OlxzK3RyYWNrXHMrYnlccysoW1xzXFNdKz8pKT9ccyokLyksCiAgICAgICAgICB0cmFja0J5RXhwLCB0cmFja0J5RXhwR2V0dGVyLCB0cmFja0J5SWRFeHBGbiwgdHJhY2tCeUlkQXJyYXlGbiwgdHJhY2tCeUlkT2JqRm4sCiAgICAgICAgICBsaHMsIHJocywgdmFsdWVJZGVudGlmaWVyLCBrZXlJZGVudGlmaWVyLAogICAgICAgICAgaGFzaEZuTG9jYWxzID0geyRpZDogaGFzaEtleX07CgogICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdpZXhwJywgIkV4cGVjdGVkIGV4cHJlc3Npb24gaW4gZm9ybSBvZiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uX1sgdHJhY2sgYnkgX2lkX10nIGJ1dCBnb3QgJ3swfScuIiwKICAgICAgICAgICAgZXhwcmVzc2lvbik7CiAgICAgICAgfQoKICAgICAgICBsaHMgPSBtYXRjaFsxXTsKICAgICAgICByaHMgPSBtYXRjaFsyXTsKICAgICAgICB0cmFja0J5RXhwID0gbWF0Y2hbM107CgogICAgICAgIGlmICh0cmFja0J5RXhwKSB7CiAgICAgICAgICB0cmFja0J5RXhwR2V0dGVyID0gJHBhcnNlKHRyYWNrQnlFeHApOwogICAgICAgICAgdHJhY2tCeUlkRXhwRm4gPSBmdW5jdGlvbihrZXksIHZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAvLyBhc3NpZ24ga2V5LCB2YWx1ZSwgYW5kICRpbmRleCB0byB0aGUgbG9jYWxzIHNvIHRoYXQgdGhleSBjYW4gYmUgdXNlZCBpbiBoYXNoIGZ1bmN0aW9ucwogICAgICAgICAgICBpZiAoa2V5SWRlbnRpZmllcikgaGFzaEZuTG9jYWxzW2tleUlkZW50aWZpZXJdID0ga2V5OwogICAgICAgICAgICBoYXNoRm5Mb2NhbHNbdmFsdWVJZGVudGlmaWVyXSA9IHZhbHVlOwogICAgICAgICAgICBoYXNoRm5Mb2NhbHMuJGluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgIHJldHVybiB0cmFja0J5RXhwR2V0dGVyKCRzY29wZSwgaGFzaEZuTG9jYWxzKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRyYWNrQnlJZEFycmF5Rm4gPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBoYXNoS2V5KHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgICB0cmFja0J5SWRPYmpGbiA9IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIG1hdGNoID0gbGhzLm1hdGNoKC9eKD86KFtcJFx3XSspfFwoKFtcJFx3XSspXHMqLFxzKihbXCRcd10rKVwpKSQvKTsKICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICB0aHJvdyBuZ1JlcGVhdE1pbkVycignaWlkZXhwJywgIidfaXRlbV8nIGluICdfaXRlbV8gaW4gX2NvbGxlY3Rpb25fJyBzaG91bGQgYmUgYW4gaWRlbnRpZmllciBvciAnKF9rZXlfLCBfdmFsdWVfKScgZXhwcmVzc2lvbiwgYnV0IGdvdCAnezB9Jy4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxocyk7CiAgICAgICAgfQogICAgICAgIHZhbHVlSWRlbnRpZmllciA9IG1hdGNoWzNdIHx8IG1hdGNoWzFdOwogICAgICAgIGtleUlkZW50aWZpZXIgPSBtYXRjaFsyXTsKCiAgICAgICAgLy8gU3RvcmUgYSBsaXN0IG9mIGVsZW1lbnRzIGZyb20gcHJldmlvdXMgcnVuLiBUaGlzIGlzIGEgaGFzaCB3aGVyZSBrZXkgaXMgdGhlIGl0ZW0gZnJvbSB0aGUKICAgICAgICAvLyBpdGVyYXRvciwgYW5kIHRoZSB2YWx1ZSBpcyBvYmplY3RzIHdpdGggZm9sbG93aW5nIHByb3BlcnRpZXMuCiAgICAgICAgLy8gICAtIHNjb3BlOiBib3VuZCBzY29wZQogICAgICAgIC8vICAgLSBlbGVtZW50OiBwcmV2aW91cyBlbGVtZW50LgogICAgICAgIC8vICAgLSBpbmRleDogcG9zaXRpb24KICAgICAgICB2YXIgbGFzdEJsb2NrTWFwID0ge307CgogICAgICAgIC8vd2F0Y2ggcHJvcHMKICAgICAgICAkc2NvcGUuJHdhdGNoQ29sbGVjdGlvbihyaHMsIGZ1bmN0aW9uIG5nUmVwZWF0QWN0aW9uKGNvbGxlY3Rpb24pewogICAgICAgICAgdmFyIGluZGV4LCBsZW5ndGgsCiAgICAgICAgICAgICAgcHJldmlvdXNOb2RlID0gJGVsZW1lbnRbMF0sICAgICAvLyBjdXJyZW50IHBvc2l0aW9uIG9mIHRoZSBub2RlCiAgICAgICAgICAgICAgbmV4dE5vZGUsCiAgICAgICAgICAgICAgLy8gU2FtZSBhcyBsYXN0QmxvY2tNYXAgYnV0IGl0IGhhcyB0aGUgY3VycmVudCBzdGF0ZS4gSXQgd2lsbCBiZWNvbWUgdGhlCiAgICAgICAgICAgICAgLy8gbGFzdEJsb2NrTWFwIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi4KICAgICAgICAgICAgICBuZXh0QmxvY2tNYXAgPSB7fSwKICAgICAgICAgICAgICBhcnJheUxlbmd0aCwKICAgICAgICAgICAgICBjaGlsZFNjb3BlLAogICAgICAgICAgICAgIGtleSwgdmFsdWUsIC8vIGtleS92YWx1ZSBvZiBpdGVyYXRpb24KICAgICAgICAgICAgICB0cmFja0J5SWQsCiAgICAgICAgICAgICAgdHJhY2tCeUlkRm4sCiAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMsCiAgICAgICAgICAgICAgYmxvY2ssICAgICAgIC8vIGxhc3Qgb2JqZWN0IGluZm9ybWF0aW9uIHtzY29wZSwgZWxlbWVudCwgaWR9CiAgICAgICAgICAgICAgbmV4dEJsb2NrT3JkZXIgPSBbXSwKICAgICAgICAgICAgICBlbGVtZW50c1RvUmVtb3ZlOwoKCiAgICAgICAgICBpZiAoaXNBcnJheUxpa2UoY29sbGVjdGlvbikpIHsKICAgICAgICAgICAgY29sbGVjdGlvbktleXMgPSBjb2xsZWN0aW9uOwogICAgICAgICAgICB0cmFja0J5SWRGbiA9IHRyYWNrQnlJZEV4cEZuIHx8IHRyYWNrQnlJZEFycmF5Rm47CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cmFja0J5SWRGbiA9IHRyYWNrQnlJZEV4cEZuIHx8IHRyYWNrQnlJZE9iakZuOwogICAgICAgICAgICAvLyBpZiBvYmplY3QsIGV4dHJhY3Qga2V5cywgc29ydCB0aGVtIGFuZCB1c2UgdG8gZGV0ZXJtaW5lIG9yZGVyIG9mIGl0ZXJhdGlvbiBvdmVyIG9iaiBwcm9wcwogICAgICAgICAgICBjb2xsZWN0aW9uS2V5cyA9IFtdOwogICAgICAgICAgICBmb3IgKGtleSBpbiBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb24uaGFzT3duUHJvcGVydHkoa2V5KSAmJiBrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMucHVzaChrZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb2xsZWN0aW9uS2V5cy5zb3J0KCk7CiAgICAgICAgICB9CgogICAgICAgICAgYXJyYXlMZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7CgogICAgICAgICAgLy8gbG9jYXRlIGV4aXN0aW5nIGl0ZW1zCiAgICAgICAgICBsZW5ndGggPSBuZXh0QmxvY2tPcmRlci5sZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7CiAgICAgICAgICBmb3IoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgIGtleSA9IChjb2xsZWN0aW9uID09PSBjb2xsZWN0aW9uS2V5cykgPyBpbmRleCA6IGNvbGxlY3Rpb25LZXlzW2luZGV4XTsKICAgICAgICAgICB2YWx1ZSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICB0cmFja0J5SWQgPSB0cmFja0J5SWRGbihrZXksIHZhbHVlLCBpbmRleCk7CiAgICAgICAgICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkodHJhY2tCeUlkLCAnYHRyYWNrIGJ5YCBpZCcpOwogICAgICAgICAgIGlmKGxhc3RCbG9ja01hcC5oYXNPd25Qcm9wZXJ0eSh0cmFja0J5SWQpKSB7CiAgICAgICAgICAgICBibG9jayA9IGxhc3RCbG9ja01hcFt0cmFja0J5SWRdOwogICAgICAgICAgICAgZGVsZXRlIGxhc3RCbG9ja01hcFt0cmFja0J5SWRdOwogICAgICAgICAgICAgbmV4dEJsb2NrTWFwW3RyYWNrQnlJZF0gPSBibG9jazsKICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyW2luZGV4XSA9IGJsb2NrOwogICAgICAgICAgIH0gZWxzZSBpZiAobmV4dEJsb2NrTWFwLmhhc093blByb3BlcnR5KHRyYWNrQnlJZCkpIHsKICAgICAgICAgICAgIC8vIHJlc3RvcmUgbGFzdEJsb2NrTWFwCiAgICAgICAgICAgICBmb3JFYWNoKG5leHRCbG9ja09yZGVyLCBmdW5jdGlvbihibG9jaykgewogICAgICAgICAgICAgICBpZiAoYmxvY2sgJiYgYmxvY2suc2NvcGUpIGxhc3RCbG9ja01hcFtibG9jay5pZF0gPSBibG9jazsKICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgLy8gVGhpcyBpcyBhIGR1cGxpY2F0ZSBhbmQgd2UgbmVlZCB0byB0aHJvdyBhbiBlcnJvcgogICAgICAgICAgICAgdGhyb3cgbmdSZXBlYXRNaW5FcnIoJ2R1cGVzJywgIkR1cGxpY2F0ZXMgaW4gYSByZXBlYXRlciBhcmUgbm90IGFsbG93ZWQuIFVzZSAndHJhY2sgYnknIGV4cHJlc3Npb24gdG8gc3BlY2lmeSB1bmlxdWUga2V5cy4gUmVwZWF0ZXI6IHswfSwgRHVwbGljYXRlIGtleTogezF9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24sICAgICAgIHRyYWNrQnlJZCk7CiAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgIC8vIG5ldyBuZXZlciBiZWZvcmUgc2VlbiBibG9jawogICAgICAgICAgICAgbmV4dEJsb2NrT3JkZXJbaW5kZXhdID0geyBpZDogdHJhY2tCeUlkIH07CiAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbdHJhY2tCeUlkXSA9IGZhbHNlOwogICAgICAgICAgIH0KICAgICAgICAgfQoKICAgICAgICAgIC8vIHJlbW92ZSBleGlzdGluZyBpdGVtcwogICAgICAgICAgZm9yIChrZXkgaW4gbGFzdEJsb2NrTWFwKSB7CiAgICAgICAgICAgIC8vIGxhc3RCbG9ja01hcCBpcyBvdXIgb3duIG9iamVjdCBzbyB3ZSBkb24ndCBuZWVkIHRvIHVzZSBzcGVjaWFsIGhhc093blByb3BlcnR5Rm4KICAgICAgICAgICAgaWYgKGxhc3RCbG9ja01hcC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgYmxvY2sgPSBsYXN0QmxvY2tNYXBba2V5XTsKICAgICAgICAgICAgICBlbGVtZW50c1RvUmVtb3ZlID0gZ2V0QmxvY2tFbGVtZW50cyhibG9jay5jbG9uZSk7CiAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoZWxlbWVudHNUb1JlbW92ZSk7CiAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50c1RvUmVtb3ZlLCBmdW5jdGlvbihlbGVtZW50KSB7IGVsZW1lbnRbTkdfUkVNT1ZFRF0gPSB0cnVlOyB9KTsKICAgICAgICAgICAgICBibG9jay5zY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gd2UgYXJlIG5vdCB1c2luZyBmb3JFYWNoIGZvciBwZXJmIHJlYXNvbnMgKHRyeWluZyB0byBhdm9pZCAjY2FsbCkKICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIGtleSA9IChjb2xsZWN0aW9uID09PSBjb2xsZWN0aW9uS2V5cykgPyBpbmRleCA6IGNvbGxlY3Rpb25LZXlzW2luZGV4XTsKICAgICAgICAgICAgdmFsdWUgPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgIGJsb2NrID0gbmV4dEJsb2NrT3JkZXJbaW5kZXhdOwogICAgICAgICAgICBpZiAobmV4dEJsb2NrT3JkZXJbaW5kZXggLSAxXSkgcHJldmlvdXNOb2RlID0gZ2V0QmxvY2tFbmQobmV4dEJsb2NrT3JkZXJbaW5kZXggLSAxXSk7CgogICAgICAgICAgICBpZiAoYmxvY2suc2NvcGUpIHsKICAgICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGFscmVhZHkgc2VlbiB0aGlzIG9iamVjdCwgdGhlbiB3ZSBuZWVkIHRvIHJldXNlIHRoZQogICAgICAgICAgICAgIC8vIGFzc29jaWF0ZWQgc2NvcGUvZWxlbWVudAogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBibG9jay5zY29wZTsKCiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBwcmV2aW91c05vZGU7CiAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBuZXh0Tm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICB9IHdoaWxlKG5leHROb2RlICYmIG5leHROb2RlW05HX1JFTU9WRURdKTsKCiAgICAgICAgICAgICAgaWYgKGdldEJsb2NrU3RhcnQoYmxvY2spICE9IG5leHROb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBleGlzdGluZyBpdGVtIHdoaWNoIGdvdCBtb3ZlZAogICAgICAgICAgICAgICAgJGFuaW1hdGUubW92ZShnZXRCbG9ja0VsZW1lbnRzKGJsb2NrLmNsb25lKSwgbnVsbCwganFMaXRlKHByZXZpb3VzTm9kZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBnZXRCbG9ja0VuZChibG9jayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gbmV3IGl0ZW0gd2hpY2ggd2UgZG9uJ3Qga25vdyBhYm91dAogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSAkc2NvcGUuJG5ldygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjaGlsZFNjb3BlW3ZhbHVlSWRlbnRpZmllcl0gPSB2YWx1ZTsKICAgICAgICAgICAgaWYgKGtleUlkZW50aWZpZXIpIGNoaWxkU2NvcGVba2V5SWRlbnRpZmllcl0gPSBrZXk7CiAgICAgICAgICAgIGNoaWxkU2NvcGUuJGluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgIGNoaWxkU2NvcGUuJGZpcnN0ID0gKGluZGV4ID09PSAwKTsKICAgICAgICAgICAgY2hpbGRTY29wZS4kbGFzdCA9IChpbmRleCA9PT0gKGFycmF5TGVuZ3RoIC0gMSkpOwogICAgICAgICAgICBjaGlsZFNjb3BlLiRtaWRkbGUgPSAhKGNoaWxkU2NvcGUuJGZpcnN0IHx8IGNoaWxkU2NvcGUuJGxhc3QpOwogICAgICAgICAgICAvLyBqc2hpbnQgYml0d2lzZTogZmFsc2UKICAgICAgICAgICAgY2hpbGRTY29wZS4kb2RkID0gIShjaGlsZFNjb3BlLiRldmVuID0gKGluZGV4JjEpID09PSAwKTsKICAgICAgICAgICAgLy8ganNoaW50IGJpdHdpc2U6IHRydWUKCiAgICAgICAgICAgIGlmICghYmxvY2suc2NvcGUpIHsKICAgICAgICAgICAgICAkdHJhbnNjbHVkZShjaGlsZFNjb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICAgICAgY2xvbmVbY2xvbmUubGVuZ3RoKytdID0gZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnIGVuZCBuZ1JlcGVhdDogJyArIGV4cHJlc3Npb24gKyAnICcpOwogICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2xvbmUsIG51bGwsIGpxTGl0ZShwcmV2aW91c05vZGUpKTsKICAgICAgICAgICAgICAgIHByZXZpb3VzTm9kZSA9IGNsb25lOwogICAgICAgICAgICAgICAgYmxvY2suc2NvcGUgPSBjaGlsZFNjb3BlOwogICAgICAgICAgICAgICAgLy8gTm90ZTogV2Ugb25seSBuZWVkIHRoZSBmaXJzdC9sYXN0IG5vZGUgb2YgdGhlIGNsb25lZCBub2Rlcy4KICAgICAgICAgICAgICAgIC8vIEhvd2V2ZXIsIHdlIG5lZWQgdG8ga2VlcCB0aGUgcmVmZXJlbmNlIHRvIHRoZSBqcWxpdGUgd3JhcHBlciBhcyBpdCBtaWdodCBiZSBjaGFuZ2VkIGxhdGVyCiAgICAgICAgICAgICAgICAvLyBieSBhIGRpcmVjdGl2ZSB3aXRoIHRlbXBsYXRlVXJsIHdoZW4gaXRzIHRlbXBsYXRlIGFycml2ZXMuCiAgICAgICAgICAgICAgICBibG9jay5jbG9uZSA9IGNsb25lOwogICAgICAgICAgICAgICAgbmV4dEJsb2NrTWFwW2Jsb2NrLmlkXSA9IGJsb2NrOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBsYXN0QmxvY2tNYXAgPSBuZXh0QmxvY2tNYXA7CiAgICAgICAgfSk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gZ2V0QmxvY2tTdGFydChibG9jaykgewogICAgcmV0dXJuIGJsb2NrLmNsb25lWzBdOwogIH0KCiAgZnVuY3Rpb24gZ2V0QmxvY2tFbmQoYmxvY2spIHsKICAgIHJldHVybiBibG9jay5jbG9uZVtibG9jay5jbG9uZS5sZW5ndGggLSAxXTsKICB9Cn1dOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTaG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nU2hvd2AgZGlyZWN0aXZlIHNob3dzIG9yIGhpZGVzIHRoZSBnaXZlbiBIVE1MIGVsZW1lbnQgYmFzZWQgb24gdGhlIGV4cHJlc3Npb24KICogcHJvdmlkZWQgdG8gdGhlIG5nU2hvdyBhdHRyaWJ1dGUuIFRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiBieSByZW1vdmluZyBvciBhZGRpbmcKICogdGhlIGBuZy1oaWRlYCBDU1MgY2xhc3Mgb250byB0aGUgZWxlbWVudC4gVGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzIGlzIHByZWRlZmluZWQKICogaW4gQW5ndWxhckpTIGFuZCBzZXRzIHRoZSBkaXNwbGF5IHN0eWxlIHRvIG5vbmUgKHVzaW5nIGFuICFpbXBvcnRhbnQgZmxhZykuCiAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogKgogKiBgYGBodG1sCiAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyB0cnV0aHkgKGVsZW1lbnQgaXMgdmlzaWJsZSkgLS0+CiAqIDxkaXYgbmctc2hvdz0ibXlWYWx1ZSI+PC9kaXY+CiAqCiAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyBoaWRkZW4pIC0tPgogKiA8ZGl2IG5nLXNob3c9Im15VmFsdWUiIGNsYXNzPSJuZy1oaWRlIj48L2Rpdj4KICogYGBgCiAqCiAqIFdoZW4gdGhlIG5nU2hvdyBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBmYWxzZSB0aGVuIHRoZSBuZy1oaWRlIENTUyBjbGFzcyBpcyBhZGRlZCB0byB0aGUgY2xhc3MgYXR0cmlidXRlCiAqIG9uIHRoZSBlbGVtZW50IGNhdXNpbmcgaXQgdG8gYmVjb21lIGhpZGRlbi4gV2hlbiB0cnVlLCB0aGUgbmctaGlkZSBDU1MgY2xhc3MgaXMgcmVtb3ZlZAogKiBmcm9tIHRoZSBlbGVtZW50IGNhdXNpbmcgdGhlIGVsZW1lbnQgbm90IHRvIGFwcGVhciBoaWRkZW4uCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogSGVyZSBpcyBhIGxpc3Qgb2YgdmFsdWVzIHRoYXQgbmdTaG93IHdpbGwgY29uc2lkZXIgYXMgYSBmYWxzeSB2YWx1ZSAoY2FzZSBpbnNlbnNpdGl2ZSk6PGJyIC8+CiAqICJmIiAvICIwIiAvICJmYWxzZSIgLyAibm8iIC8gIm4iIC8gIltdIgogKiA8L2Rpdj4KICoKICogIyMgV2h5IGlzICFpbXBvcnRhbnQgdXNlZD8KICoKICogWW91IG1heSBiZSB3b25kZXJpbmcgd2h5ICFpbXBvcnRhbnQgaXMgdXNlZCBmb3IgdGhlIC5uZy1oaWRlIENTUyBjbGFzcy4gVGhpcyBpcyBiZWNhdXNlIHRoZSBgLm5nLWhpZGVgIHNlbGVjdG9yCiAqIGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbiBieSBoZWF2aWVyIHNlbGVjdG9ycy4gRm9yIGV4YW1wbGUsIHNvbWV0aGluZyBhcyBzaW1wbGUKICogYXMgY2hhbmdpbmcgdGhlIGRpc3BsYXkgc3R5bGUgb24gYSBIVE1MIGxpc3QgaXRlbSB3b3VsZCBtYWtlIGhpZGRlbiBlbGVtZW50cyBhcHBlYXIgdmlzaWJsZS4KICogVGhpcyBhbHNvIGJlY29tZXMgYSBiaWdnZXIgaXNzdWUgd2hlbiBkZWFsaW5nIHdpdGggQ1NTIGZyYW1ld29ya3MuCiAqCiAqIEJ5IHVzaW5nICFpbXBvcnRhbnQsIHRoZSBzaG93IGFuZCBoaWRlIGJlaGF2aW9yIHdpbGwgd29yayBhcyBleHBlY3RlZCBkZXNwaXRlIGFueSBjbGFzaCBiZXR3ZWVuIENTUyBzZWxlY3RvcgogKiBzcGVjaWZpY2l0eSAod2hlbiAhaW1wb3J0YW50IGlzbid0IHVzZWQgd2l0aCBhbnkgY29uZmxpY3Rpbmcgc3R5bGVzKS4gSWYgYSBkZXZlbG9wZXIgY2hvb3NlcyB0byBvdmVycmlkZSB0aGUKICogc3R5bGluZyB0byBjaGFuZ2UgaG93IHRvIGhpZGUgYW4gZWxlbWVudCB0aGVuIGl0IGlzIGp1c3QgYSBtYXR0ZXIgb2YgdXNpbmcgIWltcG9ydGFudCBpbiB0aGVpciBvd24gQ1NTIGNvZGUuCiAqCiAqICMjIyBPdmVycmlkaW5nIC5uZy1oaWRlCiAqCiAqIEJ5IGRlZmF1bHQsIHRoZSBgLm5nLWhpZGVgIGNsYXNzIHdpbGwgc3R5bGUgdGhlIGVsZW1lbnQgd2l0aCBgZGlzcGxheTpub25lIWltcG9ydGFudGAuIElmIHlvdSB3aXNoIHRvIGNoYW5nZQogKiB0aGUgaGlkZSBiZWhhdmlvciB3aXRoIG5nU2hvdy9uZ0hpZGUgdGhlbiB0aGlzIGNhbiBiZSBhY2hpZXZlZCBieSByZXN0YXRpbmcgdGhlIHN0eWxlcyBmb3IgdGhlIGAubmctaGlkZWAKICogY2xhc3MgaW4gQ1NTOgogKgogKiBgYGBjc3MKICogLm5nLWhpZGUgewogKiAgIC8vdGhpcyBpcyBqdXN0IGFub3RoZXIgZm9ybSBvZiBoaWRpbmcgYW4gZWxlbWVudAogKiAgIGRpc3BsYXk6YmxvY2shaW1wb3J0YW50OwogKiAgIHBvc2l0aW9uOmFic29sdXRlOwogKiAgIHRvcDotOTk5OXB4OwogKiAgIGxlZnQ6LTk5OTlweDsKICogfQogKiBgYGAKICoKICogQnkgZGVmYXVsdCB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSBpbiBDU1MgYW55dGhpbmcgYW5kIHRoZSBhbmltYXRpb25zIHdpbGwgd29yayBhcm91bmQgdGhlIGRpc3BsYXkgc3R5bGUuCiAqCiAqICMjIEEgbm90ZSBhYm91dCBhbmltYXRpb25zIHdpdGggbmdTaG93CiAqCiAqIEFuaW1hdGlvbnMgaW4gbmdTaG93L25nSGlkZSB3b3JrIHdpdGggdGhlIHNob3cgYW5kIGhpZGUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZCB3aGVuIHRoZSBkaXJlY3RpdmUgZXhwcmVzc2lvbgogKiBpcyB0cnVlIGFuZCBmYWxzZS4gVGhpcyBzeXN0ZW0gd29ya3MgbGlrZSB0aGUgYW5pbWF0aW9uIHN5c3RlbSBwcmVzZW50IHdpdGggbmdDbGFzcyBleGNlcHQgdGhhdAogKiB5b3UgbXVzdCBhbHNvIGluY2x1ZGUgdGhlICFpbXBvcnRhbnQgZmxhZyB0byBvdmVycmlkZSB0aGUgZGlzcGxheSBwcm9wZXJ0eQogKiBzbyB0aGF0IHlvdSBjYW4gcGVyZm9ybSBhbiBhbmltYXRpb24gd2hlbiB0aGUgZWxlbWVudCBpcyBoaWRkZW4gZHVyaW5nIHRoZSB0aW1lIG9mIHRoZSBhbmltYXRpb24uCiAqCiAqIGBgYGNzcwogKiAvLwogKiAvL2Egd29ya2luZyBleGFtcGxlIGNhbiBiZSBmb3VuZCBhdCB0aGUgYm90dG9tIG9mIHRoaXMgcGFnZQogKiAvLwogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCwgLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgewogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiB9CiAqCiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQubmctaGlkZS1hZGQtYWN0aXZlIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgeyAuLi4gfQogKiAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZS5uZy1oaWRlLXJlbW92ZS1hY3RpdmUgeyAuLi4gfQogKiBgYGAKICoKICogS2VlcCBpbiBtaW5kIHRoYXQsIGFzIG9mIEFuZ3VsYXJKUyB2ZXJzaW9uIDEuMi4xNyAoYW5kIDEuMy4wLWJldGEuMTEpLCB0aGVyZSBpcyBubyBuZWVkIHRvIGNoYW5nZSB0aGUgZGlzcGxheQogKiBwcm9wZXJ0eSB0byBibG9jayBkdXJpbmcgYW5pbWF0aW9uIHN0YXRlcy0tbmdBbmltYXRlIHdpbGwgaGFuZGxlIHRoZSBzdHlsZSB0b2dnbGluZyBhdXRvbWF0aWNhbGx5IGZvciB5b3UuCiAqCiAqIEBhbmltYXRpb25zCiAqIGFkZENsYXNzOiAubmctaGlkZSAtIGhhcHBlbnMgYWZ0ZXIgdGhlIG5nU2hvdyBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIHRydXRoeSB2YWx1ZSBhbmQgdGhlIGp1c3QgYmVmb3JlIGNvbnRlbnRzIGFyZSBzZXQgdG8gdmlzaWJsZQogKiByZW1vdmVDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBub24gdHJ1dGh5IHZhbHVlIGFuZCBqdXN0IGJlZm9yZSB0aGUgY29udGVudHMgYXJlIHNldCB0byBoaWRkZW4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTaG93IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkKICogICAgIHRoZW4gdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICoKICogQGV4YW1wbGUKICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICAgPGRpdj4KICAgICAgICBTaG93OgogICAgICAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1zaG93IiBuZy1zaG93PSJjaGVja2VkIj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXRodW1icy11cCI+PC9zcGFuPiBJIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2PgogICAgICAgIEhpZGU6CiAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLXNob3ciIG5nLWhpZGU9ImNoZWNrZWQiPgogICAgICAgICAgPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdGh1bWJzLWRvd24iPjwvc3Bhbj4gSSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImdseXBoaWNvbnMuY3NzIj4KICAgICAgQGltcG9ydCB1cmwoLy9uZXRkbmEuYm9vdHN0cmFwY2RuLmNvbS9ib290c3RyYXAvMy4wLjAvY3NzL2Jvb3RzdHJhcC1nbHlwaGljb25zLmNzcyk7CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgIC5hbmltYXRlLXNob3cgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgbGluZS1oZWlnaHQ6MjBweDsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlIHsKICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgIG9wYWNpdHk6MDsKICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgfQoKICAgICAgLmNoZWNrLWVsZW1lbnQgewogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdGh1bWJzVXAgPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLXVwJykpOwogICAgICB2YXIgdGh1bWJzRG93biA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuLmdseXBoaWNvbi10aHVtYnMtZG93bicpKTsKCiAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc2hvdyAvIG5nLWhpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZUZhbHN5KCk7CiAgICAgICAgZXhwZWN0KHRodW1ic0Rvd24uaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwoKICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdjaGVja2VkJykpLmNsaWNrKCk7CgogICAgICAgIGV4cGVjdCh0aHVtYnNVcC5pc0Rpc3BsYXllZCgpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgZXhwZWN0KHRodW1ic0Rvd24uaXNEaXNwbGF5ZWQoKSkudG9CZUZhbHN5KCk7CiAgICAgIH0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCnZhciBuZ1Nob3dEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nU2hvdywgZnVuY3Rpb24gbmdTaG93V2F0Y2hBY3Rpb24odmFsdWUpewogICAgICAkYW5pbWF0ZVt0b0Jvb2xlYW4odmFsdWUpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddKGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICB9KTsKICB9Owp9XTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0hpZGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdIaWRlYCBkaXJlY3RpdmUgc2hvd3Mgb3IgaGlkZXMgdGhlIGdpdmVuIEhUTUwgZWxlbWVudCBiYXNlZCBvbiB0aGUgZXhwcmVzc2lvbgogKiBwcm92aWRlZCB0byB0aGUgbmdIaWRlIGF0dHJpYnV0ZS4gVGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIGJ5IHJlbW92aW5nIG9yIGFkZGluZwogKiB0aGUgYG5nLWhpZGVgIENTUyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50LiBUaGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgcHJlZGVmaW5lZAogKiBpbiBBbmd1bGFySlMgYW5kIHNldHMgdGhlIGRpc3BsYXkgc3R5bGUgdG8gbm9uZSAodXNpbmcgYW4gIWltcG9ydGFudCBmbGFnKS4KICogRm9yIENTUCBtb2RlIHBsZWFzZSBhZGQgYGFuZ3VsYXItY3NwLmNzc2AgdG8geW91ciBodG1sIGZpbGUgKHNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ3NwIG5nQ3NwfSkuCiAqCiAqIGBgYGh0bWwKICogPCEtLSB3aGVuICRzY29wZS5teVZhbHVlIGlzIHRydXRoeSAoZWxlbWVudCBpcyBoaWRkZW4pIC0tPgogKiA8ZGl2IG5nLWhpZGU9Im15VmFsdWUiIGNsYXNzPSJuZy1oaWRlIj48L2Rpdj4KICoKICogPCEtLSB3aGVuICRzY29wZS5teVZhbHVlIGlzIGZhbHN5IChlbGVtZW50IGlzIHZpc2libGUpIC0tPgogKiA8ZGl2IG5nLWhpZGU9Im15VmFsdWUiPjwvZGl2PgogKiBgYGAKICoKICogV2hlbiB0aGUgbmdIaWRlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUgdGhlbiB0aGUgLm5nLWhpZGUgQ1NTIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBjbGFzcyBhdHRyaWJ1dGUKICogb24gdGhlIGVsZW1lbnQgY2F1c2luZyBpdCB0byBiZWNvbWUgaGlkZGVuLiBXaGVuIGZhbHNlLCB0aGUgbmctaGlkZSBDU1MgY2xhc3MgaXMgcmVtb3ZlZAogKiBmcm9tIHRoZSBlbGVtZW50IGNhdXNpbmcgdGhlIGVsZW1lbnQgbm90IHRvIGFwcGVhciBoaWRkZW4uCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogSGVyZSBpcyBhIGxpc3Qgb2YgdmFsdWVzIHRoYXQgbmdIaWRlIHdpbGwgY29uc2lkZXIgYXMgYSBmYWxzeSB2YWx1ZSAoY2FzZSBpbnNlbnNpdGl2ZSk6PGJyIC8+CiAqICJmIiAvICIwIiAvICJmYWxzZSIgLyAibm8iIC8gIm4iIC8gIltdIgogKiA8L2Rpdj4KICoKICogIyMgV2h5IGlzICFpbXBvcnRhbnQgdXNlZD8KICoKICogWW91IG1heSBiZSB3b25kZXJpbmcgd2h5ICFpbXBvcnRhbnQgaXMgdXNlZCBmb3IgdGhlIC5uZy1oaWRlIENTUyBjbGFzcy4gVGhpcyBpcyBiZWNhdXNlIHRoZSBgLm5nLWhpZGVgIHNlbGVjdG9yCiAqIGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbiBieSBoZWF2aWVyIHNlbGVjdG9ycy4gRm9yIGV4YW1wbGUsIHNvbWV0aGluZyBhcyBzaW1wbGUKICogYXMgY2hhbmdpbmcgdGhlIGRpc3BsYXkgc3R5bGUgb24gYSBIVE1MIGxpc3QgaXRlbSB3b3VsZCBtYWtlIGhpZGRlbiBlbGVtZW50cyBhcHBlYXIgdmlzaWJsZS4KICogVGhpcyBhbHNvIGJlY29tZXMgYSBiaWdnZXIgaXNzdWUgd2hlbiBkZWFsaW5nIHdpdGggQ1NTIGZyYW1ld29ya3MuCiAqCiAqIEJ5IHVzaW5nICFpbXBvcnRhbnQsIHRoZSBzaG93IGFuZCBoaWRlIGJlaGF2aW9yIHdpbGwgd29yayBhcyBleHBlY3RlZCBkZXNwaXRlIGFueSBjbGFzaCBiZXR3ZWVuIENTUyBzZWxlY3RvcgogKiBzcGVjaWZpY2l0eSAod2hlbiAhaW1wb3J0YW50IGlzbid0IHVzZWQgd2l0aCBhbnkgY29uZmxpY3Rpbmcgc3R5bGVzKS4gSWYgYSBkZXZlbG9wZXIgY2hvb3NlcyB0byBvdmVycmlkZSB0aGUKICogc3R5bGluZyB0byBjaGFuZ2UgaG93IHRvIGhpZGUgYW4gZWxlbWVudCB0aGVuIGl0IGlzIGp1c3QgYSBtYXR0ZXIgb2YgdXNpbmcgIWltcG9ydGFudCBpbiB0aGVpciBvd24gQ1NTIGNvZGUuCiAqCiAqICMjIyBPdmVycmlkaW5nIC5uZy1oaWRlCiAqCiAqIEJ5IGRlZmF1bHQsIHRoZSBgLm5nLWhpZGVgIGNsYXNzIHdpbGwgc3R5bGUgdGhlIGVsZW1lbnQgd2l0aCBgZGlzcGxheTpub25lIWltcG9ydGFudGAuIElmIHlvdSB3aXNoIHRvIGNoYW5nZQogKiB0aGUgaGlkZSBiZWhhdmlvciB3aXRoIG5nU2hvdy9uZ0hpZGUgdGhlbiB0aGlzIGNhbiBiZSBhY2hpZXZlZCBieSByZXN0YXRpbmcgdGhlIHN0eWxlcyBmb3IgdGhlIGAubmctaGlkZWAKICogY2xhc3MgaW4gQ1NTOgogKgogKiBgYGBjc3MKICogLm5nLWhpZGUgewogKiAgIC8vdGhpcyBpcyBqdXN0IGFub3RoZXIgZm9ybSBvZiBoaWRpbmcgYW4gZWxlbWVudAogKiAgIGRpc3BsYXk6YmxvY2shaW1wb3J0YW50OwogKiAgIHBvc2l0aW9uOmFic29sdXRlOwogKiAgIHRvcDotOTk5OXB4OwogKiAgIGxlZnQ6LTk5OTlweDsKICogfQogKiBgYGAKICoKICogQnkgZGVmYXVsdCB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSBpbiBDU1MgYW55dGhpbmcgYW5kIHRoZSBhbmltYXRpb25zIHdpbGwgd29yayBhcm91bmQgdGhlIGRpc3BsYXkgc3R5bGUuCiAqCiAqICMjIEEgbm90ZSBhYm91dCBhbmltYXRpb25zIHdpdGggbmdIaWRlCiAqCiAqIEFuaW1hdGlvbnMgaW4gbmdTaG93L25nSGlkZSB3b3JrIHdpdGggdGhlIHNob3cgYW5kIGhpZGUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZCB3aGVuIHRoZSBkaXJlY3RpdmUgZXhwcmVzc2lvbgogKiBpcyB0cnVlIGFuZCBmYWxzZS4gVGhpcyBzeXN0ZW0gd29ya3MgbGlrZSB0aGUgYW5pbWF0aW9uIHN5c3RlbSBwcmVzZW50IHdpdGggbmdDbGFzcywgZXhjZXB0IHRoYXQgdGhlIGAubmctaGlkZWAKICogQ1NTIGNsYXNzIGlzIGFkZGVkIGFuZCByZW1vdmVkIGZvciB5b3UgaW5zdGVhZCBvZiB5b3VyIG93biBDU1MgY2xhc3MuCiAqCiAqIGBgYGNzcwogKiAvLwogKiAvL2Egd29ya2luZyBleGFtcGxlIGNhbiBiZSBmb3VuZCBhdCB0aGUgYm90dG9tIG9mIHRoaXMgcGFnZQogKiAvLwogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCwgLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgewogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiB9CiAqCiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQubmctaGlkZS1hZGQtYWN0aXZlIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgeyAuLi4gfQogKiAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZS5uZy1oaWRlLXJlbW92ZS1hY3RpdmUgeyAuLi4gfQogKiBgYGAKICoKICogS2VlcCBpbiBtaW5kIHRoYXQsIGFzIG9mIEFuZ3VsYXJKUyB2ZXJzaW9uIDEuMi4xNyAoYW5kIDEuMy4wLWJldGEuMTEpLCB0aGVyZSBpcyBubyBuZWVkIHRvIGNoYW5nZSB0aGUgZGlzcGxheQogKiBwcm9wZXJ0eSB0byBibG9jayBkdXJpbmcgYW5pbWF0aW9uIHN0YXRlcy0tbmdBbmltYXRlIHdpbGwgaGFuZGxlIHRoZSBzdHlsZSB0b2dnbGluZyBhdXRvbWF0aWNhbGx5IGZvciB5b3UuCiAqCiAqIEBhbmltYXRpb25zCiAqIHJlbW92ZUNsYXNzOiAubmctaGlkZSAtIGhhcHBlbnMgYWZ0ZXIgdGhlIG5nSGlkZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gaGlkZGVuCiAqIGFkZENsYXNzOiAubmctaGlkZSAtIGhhcHBlbnMgYWZ0ZXIgdGhlIG5nSGlkZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIG5vbiB0cnV0aHkgdmFsdWUgYW5kIGp1c3QgYmVmb3JlIHRoZSBjb250ZW50cyBhcmUgc2V0IHRvIHZpc2libGUKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdIaWRlIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkgdGhlbgogKiAgICAgdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICoKICogQGV4YW1wbGUKICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICAgPGRpdj4KICAgICAgICBTaG93OgogICAgICAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1oaWRlIiBuZy1zaG93PSJjaGVja2VkIj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXRodW1icy11cCI+PC9zcGFuPiBJIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2PgogICAgICAgIEhpZGU6CiAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLWhpZGUiIG5nLWhpZGU9ImNoZWNrZWQiPgogICAgICAgICAgPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdGh1bWJzLWRvd24iPjwvc3Bhbj4gSSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImdseXBoaWNvbnMuY3NzIj4KICAgICAgQGltcG9ydCB1cmwoLy9uZXRkbmEuYm9vdHN0cmFwY2RuLmNvbS9ib290c3RyYXAvMy4wLjAvY3NzL2Jvb3RzdHJhcC1nbHlwaGljb25zLmNzcyk7CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgIC5hbmltYXRlLWhpZGUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgbGluZS1oZWlnaHQ6MjBweDsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtaGlkZS5uZy1oaWRlIHsKICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgIG9wYWNpdHk6MDsKICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgfQoKICAgICAgLmNoZWNrLWVsZW1lbnQgewogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdGh1bWJzVXAgPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLXVwJykpOwogICAgICB2YXIgdGh1bWJzRG93biA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuLmdseXBoaWNvbi10aHVtYnMtZG93bicpKTsKCiAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc2hvdyAvIG5nLWhpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZUZhbHN5KCk7CiAgICAgICAgZXhwZWN0KHRodW1ic0Rvd24uaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwoKICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdjaGVja2VkJykpLmNsaWNrKCk7CgogICAgICAgIGV4cGVjdCh0aHVtYnNVcC5pc0Rpc3BsYXllZCgpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgZXhwZWN0KHRodW1ic0Rvd24uaXNEaXNwbGF5ZWQoKSkudG9CZUZhbHN5KCk7CiAgICAgIH0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCnZhciBuZ0hpZGVEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nSGlkZSwgZnVuY3Rpb24gbmdIaWRlV2F0Y2hBY3Rpb24odmFsdWUpewogICAgICAkYW5pbWF0ZVt0b0Jvb2xlYW4odmFsdWUpID8gJ2FkZENsYXNzJyA6ICdyZW1vdmVDbGFzcyddKGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICB9KTsKICB9Owp9XTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU3R5bGUKICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nU3R5bGVgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNldCBDU1Mgc3R5bGUgb24gYW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3R5bGUKICoKICoge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gd2hpY2ggZXZhbHMgdG8gYW4KICogb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAqIGtleXMuCiAqCiAqIFNpbmNlIHNvbWUgQ1NTIHN0eWxlIG5hbWVzIGFyZSBub3QgdmFsaWQga2V5cyBmb3IgYW4gb2JqZWN0LCB0aGV5IG11c3QgYmUgcXVvdGVkLgogKiBTZWUgdGhlICdiYWNrZ3JvdW5kLWNvbG9yJyBzdHlsZSBpbiB0aGUgZXhhbXBsZSBiZWxvdy4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCBjb2xvciIgbmctY2xpY2s9Im15U3R5bGU9e2NvbG9yOidyZWQnfSI+CiAgICAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCBiYWNrZ3JvdW5kIiBuZy1jbGljaz0ibXlTdHlsZT17J2JhY2tncm91bmQtY29sb3InOidibHVlJ30iPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15U3R5bGU9e30iPgogICAgICAgIDxici8+CiAgICAgICAgPHNwYW4gbmctc3R5bGU9Im15U3R5bGUiPlNhbXBsZSBUZXh0PC9zcGFuPgogICAgICAgIDxwcmU+bXlTdHlsZT17e215U3R5bGV9fTwvcHJlPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgc3BhbiB7CiAgICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICB2YXIgY29sb3JTcGFuID0gZWxlbWVudChieS5jc3MoJ3NwYW4nKSk7CgogICAgICAgaWl0KCdzaG91bGQgY2hlY2sgbmctc3R5bGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgwLCAwLCAwLCAxKScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnaW5wdXRbdmFsdWU9XCdzZXQgY29sb3JcJ10nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgyNTUsIDAsIDAsIDEpJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCdpbnB1dFt2YWx1ZT1jbGVhcl0nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgwLCAwLCAwLCAxKScpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdTdHlsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgc2NvcGUuJHdhdGNoKGF0dHIubmdTdHlsZSwgZnVuY3Rpb24gbmdTdHlsZVdhdGNoQWN0aW9uKG5ld1N0eWxlcywgb2xkU3R5bGVzKSB7CiAgICBpZiAob2xkU3R5bGVzICYmIChuZXdTdHlsZXMgIT09IG9sZFN0eWxlcykpIHsKICAgICAgZm9yRWFjaChvbGRTdHlsZXMsIGZ1bmN0aW9uKHZhbCwgc3R5bGUpIHsgZWxlbWVudC5jc3Moc3R5bGUsICcnKTt9KTsKICAgIH0KICAgIGlmIChuZXdTdHlsZXMpIGVsZW1lbnQuY3NzKG5ld1N0eWxlcyk7CiAgfSwgdHJ1ZSk7Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTd2l0Y2gKICogQHJlc3RyaWN0IEVBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nU3dpdGNoYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBjb25kaXRpb25hbGx5IHN3YXAgRE9NIHN0cnVjdHVyZSBvbiB5b3VyIHRlbXBsYXRlIGJhc2VkIG9uIGEgc2NvcGUgZXhwcmVzc2lvbi4KICogRWxlbWVudHMgd2l0aGluIGBuZ1N3aXRjaGAgYnV0IHdpdGhvdXQgYG5nU3dpdGNoV2hlbmAgb3IgYG5nU3dpdGNoRGVmYXVsdGAgZGlyZWN0aXZlcyB3aWxsIGJlIHByZXNlcnZlZCBhdCB0aGUgbG9jYXRpb24KICogYXMgc3BlY2lmaWVkIGluIHRoZSB0ZW1wbGF0ZS4KICoKICogVGhlIGRpcmVjdGl2ZSBpdHNlbGYgd29ya3Mgc2ltaWxhciB0byBuZ0luY2x1ZGUsIGhvd2V2ZXIsIGluc3RlYWQgb2YgZG93bmxvYWRpbmcgdGVtcGxhdGUgY29kZSAob3IgbG9hZGluZyBpdAogKiBmcm9tIHRoZSB0ZW1wbGF0ZSBjYWNoZSksIGBuZ1N3aXRjaGAgc2ltcGx5IGNob29zZXMgb25lIG9mIHRoZSBuZXN0ZWQgZWxlbWVudHMgYW5kIG1ha2VzIGl0IHZpc2libGUgYmFzZWQgb24gd2hpY2ggZWxlbWVudAogKiBtYXRjaGVzIHRoZSB2YWx1ZSBvYnRhaW5lZCBmcm9tIHRoZSBldmFsdWF0ZWQgZXhwcmVzc2lvbi4gSW4gb3RoZXIgd29yZHMsIHlvdSBkZWZpbmUgYSBjb250YWluZXIgZWxlbWVudAogKiAod2hlcmUgeW91IHBsYWNlIHRoZSBkaXJlY3RpdmUpLCBwbGFjZSBhbiBleHByZXNzaW9uIG9uIHRoZSAqKmBvbj0iLi4uImAgYXR0cmlidXRlKioKICogKG9yIHRoZSAqKmBuZy1zd2l0Y2g9Ii4uLiJgIGF0dHJpYnV0ZSoqKSwgZGVmaW5lIGFueSBpbm5lciBlbGVtZW50cyBpbnNpZGUgb2YgdGhlIGRpcmVjdGl2ZSBhbmQgcGxhY2UKICogYSB3aGVuIGF0dHJpYnV0ZSBwZXIgZWxlbWVudC4gVGhlIHdoZW4gYXR0cmlidXRlIGlzIHVzZWQgdG8gaW5mb3JtIG5nU3dpdGNoIHdoaWNoIGVsZW1lbnQgdG8gZGlzcGxheSB3aGVuIHRoZSBvbgogKiBleHByZXNzaW9uIGlzIGV2YWx1YXRlZC4gSWYgYSBtYXRjaGluZyBleHByZXNzaW9uIGlzIG5vdCBmb3VuZCB2aWEgYSB3aGVuIGF0dHJpYnV0ZSB0aGVuIGFuIGVsZW1lbnQgd2l0aCB0aGUgZGVmYXVsdAogKiBhdHRyaWJ1dGUgaXMgZGlzcGxheWVkLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1pbmZvIj4KICogQmUgYXdhcmUgdGhhdCB0aGUgYXR0cmlidXRlIHZhbHVlcyB0byBtYXRjaCBhZ2FpbnN0IGNhbm5vdCBiZSBleHByZXNzaW9ucy4gVGhleSBhcmUgaW50ZXJwcmV0ZWQKICogYXMgbGl0ZXJhbCBzdHJpbmcgdmFsdWVzIHRvIG1hdGNoIGFnYWluc3QuCiAqIEZvciBleGFtcGxlLCAqKmBuZy1zd2l0Y2gtd2hlbj0ic29tZVZhbCJgKiogd2lsbCBtYXRjaCBhZ2FpbnN0IHRoZSBzdHJpbmcgYCJzb21lVmFsImAgbm90IGFnYWluc3QgdGhlCiAqIHZhbHVlIG9mIHRoZSBleHByZXNzaW9uIGAkc2NvcGUuc29tZVZhbGAuCiAqIDwvZGl2PgoKICogQGFuaW1hdGlvbnMKICogZW50ZXIgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1N3aXRjaCBjb250ZW50cyBjaGFuZ2UgYW5kIHRoZSBtYXRjaGVkIGNoaWxkIGVsZW1lbnQgaXMgcGxhY2VkIGluc2lkZSB0aGUgY29udGFpbmVyCiAqIGxlYXZlIC0gaGFwcGVucyBqdXN0IGFmdGVyIHRoZSBuZ1N3aXRjaCBjb250ZW50cyBjaGFuZ2UgYW5kIGp1c3QgYmVmb3JlIHRoZSBmb3JtZXIgY29udGVudHMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NCiAqCiAqIEB1c2FnZQogKgogKiBgYGAKICogPEFOWSBuZy1zd2l0Y2g9ImV4cHJlc3Npb24iPgogKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUxIj4uLi48L0FOWT4KICogICA8QU5ZIG5nLXN3aXRjaC13aGVuPSJtYXRjaFZhbHVlMiI+Li4uPC9BTlk+CiAqICAgPEFOWSBuZy1zd2l0Y2gtZGVmYXVsdD4uLi48L0FOWT4KICogPC9BTlk+CiAqIGBgYAogKgogKgogKiBAc2NvcGUKICogQHByaW9yaXR5IDgwMAogKiBAcGFyYW0geyp9IG5nU3dpdGNofG9uIGV4cHJlc3Npb24gdG8gbWF0Y2ggYWdhaW5zdCA8dHQ+bmctc3dpdGNoLXdoZW48L3R0Pi4KICogT24gY2hpbGQgZWxlbWVudHMgYWRkOgogKgogKiAqIGBuZ1N3aXRjaFdoZW5gOiB0aGUgY2FzZSBzdGF0ZW1lbnQgdG8gbWF0Y2ggYWdhaW5zdC4gSWYgbWF0Y2ggdGhlbiB0aGlzCiAqICAgY2FzZSB3aWxsIGJlIGRpc3BsYXllZC4gSWYgdGhlIHNhbWUgbWF0Y2ggYXBwZWFycyBtdWx0aXBsZSB0aW1lcywgYWxsIHRoZQogKiAgIGVsZW1lbnRzIHdpbGwgYmUgZGlzcGxheWVkLgogKiAqIGBuZ1N3aXRjaERlZmF1bHRgOiB0aGUgZGVmYXVsdCBjYXNlIHdoZW4gbm8gb3RoZXIgY2FzZSBtYXRjaC4gSWYgdGhlcmUKICogICBhcmUgbXVsdGlwbGUgZGVmYXVsdCBjYXNlcywgYWxsIG9mIHRoZW0gd2lsbCBiZSBkaXNwbGF5ZWQgd2hlbiBubyBvdGhlcgogKiAgIGNhc2UgbWF0Y2guCiAqCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJzZWxlY3Rpb24iIG5nLW9wdGlvbnM9Iml0ZW0gZm9yIGl0ZW0gaW4gaXRlbXMiPgogICAgICAgIDwvc2VsZWN0PgogICAgICAgIDx0dD5zZWxlY3Rpb249e3tzZWxlY3Rpb259fTwvdHQ+CiAgICAgICAgPGhyLz4KICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaC1jb250YWluZXIiCiAgICAgICAgICBuZy1zd2l0Y2ggb249InNlbGVjdGlvbiI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFuaW1hdGUtc3dpdGNoIiBuZy1zd2l0Y2gtd2hlbj0ic2V0dGluZ3MiPlNldHRpbmdzIERpdjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaCIgbmctc3dpdGNoLXdoZW49ImhvbWUiPkhvbWUgU3BhbjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaCIgbmctc3dpdGNoLWRlZmF1bHQ+ZGVmYXVsdDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLml0ZW1zID0gWydzZXR0aW5ncycsICdob21lJywgJ290aGVyJ107CiAgICAgICAgJHNjb3BlLnNlbGVjdGlvbiA9ICRzY29wZS5pdGVtc1swXTsKICAgICAgfQogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyIHsKICAgICAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgaGVpZ2h0OjQwcHg7CiAgICAgICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1zd2l0Y2ggewogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtc3dpdGNoLm5nLWFuaW1hdGUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKCiAgICAgICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICAgICAgdG9wOjA7CiAgICAgICAgbGVmdDowOwogICAgICAgIHJpZ2h0OjA7CiAgICAgICAgYm90dG9tOjA7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1sZWF2ZS5uZy1sZWF2ZS1hY3RpdmUsCiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1lbnRlciB7CiAgICAgICAgdG9wOi01MHB4OwogICAgICB9CiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1sZWF2ZSwKICAgICAgLmFuaW1hdGUtc3dpdGNoLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgdG9wOjA7CiAgICAgIH0KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgc3dpdGNoRWxlbSA9IGVsZW1lbnQoYnkuY3NzKCdbbmctc3dpdGNoXScpKTsKICAgICAgdmFyIHNlbGVjdCA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlbGVjdGlvbicpKTsKCiAgICAgIGl0KCdzaG91bGQgc3RhcnQgaW4gc2V0dGluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3Qoc3dpdGNoRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL1NldHRpbmdzIERpdi8pOwogICAgICB9KTsKICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gaG9tZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGVjdC5lbGVtZW50LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMSkuY2xpY2soKTsKICAgICAgICBleHBlY3Qoc3dpdGNoRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL0hvbWUgU3Bhbi8pOwogICAgICB9KTsKICAgICAgaXQoJ3Nob3VsZCBzZWxlY3QgZGVmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGVjdC5lbGVtZW50LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMikuY2xpY2soKTsKICAgICAgICBleHBlY3Qoc3dpdGNoRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL2RlZmF1bHQvKTsKICAgICAgfSk7CiAgICA8L2ZpbGU+CiAgPC9leGFtcGxlPgogKi8KdmFyIG5nU3dpdGNoRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRUEnLAogICAgcmVxdWlyZTogJ25nU3dpdGNoJywKCiAgICAvLyBhc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgZnVuY3Rpb24gbmdTd2l0Y2hDb250cm9sbGVyKCkgewogICAgIHRoaXMuY2FzZXMgPSB7fTsKICAgIH1dLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIG5nU3dpdGNoQ29udHJvbGxlcikgewogICAgICB2YXIgd2F0Y2hFeHByID0gYXR0ci5uZ1N3aXRjaCB8fCBhdHRyLm9uLAogICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlcyA9IFtdLAogICAgICAgICAgc2VsZWN0ZWRFbGVtZW50cyA9IFtdLAogICAgICAgICAgcHJldmlvdXNFbGVtZW50cyA9IFtdLAogICAgICAgICAgc2VsZWN0ZWRTY29wZXMgPSBbXTsKCiAgICAgIHNjb3BlLiR3YXRjaCh3YXRjaEV4cHIsIGZ1bmN0aW9uIG5nU3dpdGNoV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgaSwgaWk7CiAgICAgICAgZm9yIChpID0gMCwgaWkgPSBwcmV2aW91c0VsZW1lbnRzLmxlbmd0aDsgaSA8IGlpOyArK2kpIHsKICAgICAgICAgIHByZXZpb3VzRWxlbWVudHNbaV0ucmVtb3ZlKCk7CiAgICAgICAgfQogICAgICAgIHByZXZpb3VzRWxlbWVudHMubGVuZ3RoID0gMDsKCiAgICAgICAgZm9yIChpID0gMCwgaWkgPSBzZWxlY3RlZFNjb3Blcy5sZW5ndGg7IGkgPCBpaTsgKytpKSB7CiAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSBzZWxlY3RlZEVsZW1lbnRzW2ldOwogICAgICAgICAgc2VsZWN0ZWRTY29wZXNbaV0uJGRlc3Ryb3koKTsKICAgICAgICAgIHByZXZpb3VzRWxlbWVudHNbaV0gPSBzZWxlY3RlZDsKICAgICAgICAgICRhbmltYXRlLmxlYXZlKHNlbGVjdGVkLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHNlbGVjdGVkRWxlbWVudHMubGVuZ3RoID0gMDsKICAgICAgICBzZWxlY3RlZFNjb3Blcy5sZW5ndGggPSAwOwoKICAgICAgICBpZiAoKHNlbGVjdGVkVHJhbnNjbHVkZXMgPSBuZ1N3aXRjaENvbnRyb2xsZXIuY2FzZXNbJyEnICsgdmFsdWVdIHx8IG5nU3dpdGNoQ29udHJvbGxlci5jYXNlc1snPyddKSkgewogICAgICAgICAgc2NvcGUuJGV2YWwoYXR0ci5jaGFuZ2UpOwogICAgICAgICAgZm9yRWFjaChzZWxlY3RlZFRyYW5zY2x1ZGVzLCBmdW5jdGlvbihzZWxlY3RlZFRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgdmFyIHNlbGVjdGVkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgIHNlbGVjdGVkU2NvcGVzLnB1c2goc2VsZWN0ZWRTY29wZSk7CiAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZS50cmFuc2NsdWRlKHNlbGVjdGVkU2NvcGUsIGZ1bmN0aW9uKGNhc2VFbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIGFuY2hvciA9IHNlbGVjdGVkVHJhbnNjbHVkZS5lbGVtZW50OwoKICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzLnB1c2goY2FzZUVsZW1lbnQpOwogICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNhc2VFbGVtZW50LCBhbmNob3IucGFyZW50KCksIGFuY2hvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9Owp9XTsKCnZhciBuZ1N3aXRjaFdoZW5EaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogIHByaW9yaXR5OiA4MDAsCiAgcmVxdWlyZTogJ15uZ1N3aXRjaCcsCiAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dID0gKGN0cmwuY2FzZXNbJyEnICsgYXR0cnMubmdTd2l0Y2hXaGVuXSB8fCBbXSk7CiAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0ucHVzaCh7IHRyYW5zY2x1ZGU6ICR0cmFuc2NsdWRlLCBlbGVtZW50OiBlbGVtZW50IH0pOwogIH0KfSk7Cgp2YXIgbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICBwcmlvcml0eTogODAwLAogIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgY3RybC5jYXNlc1snPyddID0gKGN0cmwuY2FzZXNbJz8nXSB8fCBbXSk7CiAgICBjdHJsLmNhc2VzWyc/J10ucHVzaCh7IHRyYW5zY2x1ZGU6ICR0cmFuc2NsdWRlLCBlbGVtZW50OiBlbGVtZW50IH0pOwogICB9Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdUcmFuc2NsdWRlCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogRGlyZWN0aXZlIHRoYXQgbWFya3MgdGhlIGluc2VydGlvbiBwb2ludCBmb3IgdGhlIHRyYW5zY2x1ZGVkIERPTSBvZiB0aGUgbmVhcmVzdCBwYXJlbnQgZGlyZWN0aXZlIHRoYXQgdXNlcyB0cmFuc2NsdXNpb24uCiAqCiAqIEFueSBleGlzdGluZyBjb250ZW50IG9mIHRoZSBlbGVtZW50IHRoYXQgdGhpcyBkaXJlY3RpdmUgaXMgcGxhY2VkIG9uIHdpbGwgYmUgcmVtb3ZlZCBiZWZvcmUgdGhlIHRyYW5zY2x1ZGVkIGNvbnRlbnQgaXMgaW5zZXJ0ZWQuCiAqCiAqIEBlbGVtZW50IEFOWQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9InRyYW5zY2x1ZGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudGl0bGUgPSAnTG9yZW0gSXBzdW0nOwogICAgICAgICAgICRzY29wZS50ZXh0ID0gJ05lcXVlIHBvcnJvIHF1aXNxdWFtIGVzdCBxdWkgZG9sb3JlbSBpcHN1bSBxdWlhIGRvbG9yLi4uJzsKICAgICAgICAgfQoKICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3RyYW5zY2x1ZGUnLCBbXSkKICAgICAgICAgIC5kaXJlY3RpdmUoJ3BhbmUnLCBmdW5jdGlvbigpewogICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICAgICAgICAgc2NvcGU6IHsgdGl0bGU6J0AnIH0sCiAgICAgICAgICAgICAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6IGdyYXkiPnt7dGl0bGV9fTwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICAgICAgIH07CiAgICAgICAgIH0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8aW5wdXQgbmctbW9kZWw9InRpdGxlIj48YnI+CiAgICAgICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idGV4dCI+PC90ZXh0YXJlYT4gPGJyLz4KICAgICAgICAgPHBhbmUgdGl0bGU9Int7dGl0bGV9fSI+e3t0ZXh0fX08L3BhbmU+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBoYXZlIHRyYW5zY2x1ZGVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdGl0bGVFbGVtZW50ID0gZWxlbWVudChieS5tb2RlbCgndGl0bGUnKSk7CiAgICAgICAgICB0aXRsZUVsZW1lbnQuY2xlYXIoKTsKICAgICAgICAgIHRpdGxlRWxlbWVudC5zZW5kS2V5cygnVElUTEUnKTsKICAgICAgICAgIHZhciB0ZXh0RWxlbWVudCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RleHQnKSk7CiAgICAgICAgICB0ZXh0RWxlbWVudC5jbGVhcigpOwogICAgICAgICAgdGV4dEVsZW1lbnQuc2VuZEtleXMoJ1RFWFQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3RpdGxlJykpLmdldFRleHQoKSkudG9FcXVhbCgnVElUTEUnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSkuZ2V0VGV4dCgpKS50b0VxdWFsKCdURVhUJyk7CiAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqCiAqLwp2YXIgbmdUcmFuc2NsdWRlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgY29udHJvbGxlciwgJHRyYW5zY2x1ZGUpIHsKICAgIGlmICghJHRyYW5zY2x1ZGUpIHsKICAgICAgdGhyb3cgbWluRXJyKCduZ1RyYW5zY2x1ZGUnKSgnb3JwaGFuJywKICAgICAgICdJbGxlZ2FsIHVzZSBvZiBuZ1RyYW5zY2x1ZGUgZGlyZWN0aXZlIGluIHRoZSB0ZW1wbGF0ZSEgJyArCiAgICAgICAnTm8gcGFyZW50IGRpcmVjdGl2ZSB0aGF0IHJlcXVpcmVzIGEgdHJhbnNjbHVzaW9uIGZvdW5kLiAnICsKICAgICAgICdFbGVtZW50OiB7MH0nLAogICAgICAgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgIH0KCiAgICAkdHJhbnNjbHVkZShmdW5jdGlvbihjbG9uZSkgewogICAgICAkZWxlbWVudC5lbXB0eSgpOwogICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgfSk7CiAgfQp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIHNjcmlwdAogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogTG9hZCB0aGUgY29udGVudCBvZiBhIGA8c2NyaXB0PmAgZWxlbWVudCBpbnRvIHtAbGluayBuZy4kdGVtcGxhdGVDYWNoZSBgJHRlbXBsYXRlQ2FjaGVgfSwgc28gdGhhdCB0aGUKICogdGVtcGxhdGUgY2FuIGJlIHVzZWQgYnkge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUgYG5nSW5jbHVkZWB9LAogKiB7QGxpbmsgbmdSb3V0ZS5kaXJlY3RpdmU6bmdWaWV3IGBuZ1ZpZXdgfSwgb3Ige0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4gVGhlIHR5cGUgb2YgdGhlCiAqIGA8c2NyaXB0PmAgZWxlbWVudCBtdXN0IGJlIHNwZWNpZmllZCBhcyBgdGV4dC9uZy10ZW1wbGF0ZWAsIGFuZCBhIGNhY2hlIG5hbWUgZm9yIHRoZSB0ZW1wbGF0ZSBtdXN0IGJlCiAqIGFzc2lnbmVkIHRocm91Z2ggdGhlIGVsZW1lbnQncyBgaWRgLCB3aGljaCBjYW4gdGhlbiBiZSB1c2VkIGFzIGEgZGlyZWN0aXZlJ3MgYHRlbXBsYXRlVXJsYC4KICoKICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgTXVzdCBiZSBzZXQgdG8gYCd0ZXh0L25nLXRlbXBsYXRlJ2AuCiAqIEBwYXJhbSB7c3RyaW5nfSBpZCBDYWNoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZS4KICoKICogQGV4YW1wbGUKICA8ZXhhbXBsZT4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSIvdHBsLmh0bWwiPgogICAgICAgIENvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLgogICAgICA8L3NjcmlwdD4KCiAgICAgIDxhIG5nLWNsaWNrPSJjdXJyZW50VHBsPScvdHBsLmh0bWwnIiBpZD0idHBsLWxpbmsiPkxvYWQgaW5saW5lZCB0ZW1wbGF0ZTwvYT4KICAgICAgPGRpdiBpZD0idHBsLWNvbnRlbnQiIG5nLWluY2x1ZGUgc3JjPSJjdXJyZW50VHBsIj48L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUgZGVmaW5lZCBpbnNpZGUgc2NyaXB0IHRhZycsIGZ1bmN0aW9uKCkgewogICAgICAgIGVsZW1lbnQoYnkuY3NzKCcjdHBsLWxpbmsnKSkuY2xpY2soKTsKICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJyN0cGwtY29udGVudCcpKS5nZXRUZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLyk7CiAgICAgIH0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCnZhciBzY3JpcHREaXJlY3RpdmUgPSBbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHRlcm1pbmFsOiB0cnVlLAogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAgIC8vIElFIGlzIG5vdCBjb25zaXN0ZW50LCBpbiBzY3JpcHRzIHdlIGhhdmUgdG8gcmVhZCAudGV4dCBidXQgaW4gb3RoZXIgbm9kZXMgd2UgaGF2ZSB0byByZWFkIC50ZXh0Q29udGVudAogICAgICAgICAgICB0ZXh0ID0gZWxlbWVudFswXS50ZXh0OwoKICAgICAgICAkdGVtcGxhdGVDYWNoZS5wdXQodGVtcGxhdGVVcmwsIHRleHQpOwogICAgICB9CiAgICB9CiAgfTsKfV07Cgp2YXIgbmdPcHRpb25zTWluRXJyID0gbWluRXJyKCduZ09wdGlvbnMnKTsKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgc2VsZWN0CiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBIVE1MIGBTRUxFQ1RgIGVsZW1lbnQgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4KICoKICogIyBgbmdPcHRpb25zYAogKgogKiBUaGUgYG5nT3B0aW9uc2AgYXR0cmlidXRlIGNhbiBiZSB1c2VkIHRvIGR5bmFtaWNhbGx5IGdlbmVyYXRlIGEgbGlzdCBvZiBgPG9wdGlvbj5gCiAqIGVsZW1lbnRzIGZvciB0aGUgYDxzZWxlY3Q+YCBlbGVtZW50IHVzaW5nIHRoZSBhcnJheSBvciBvYmplY3Qgb2J0YWluZWQgYnkgZXZhbHVhdGluZyB0aGUKICogYG5nT3B0aW9uc2AgY29tcHJlaGVuc2lvbl9leHByZXNzaW9uLgogKgogKiBXaGVuIGFuIGl0ZW0gaW4gdGhlIGA8c2VsZWN0PmAgbWVudSBpcyBzZWxlY3RlZCwgdGhlIGFycmF5IGVsZW1lbnQgb3Igb2JqZWN0IHByb3BlcnR5CiAqIHJlcHJlc2VudGVkIGJ5IHRoZSBzZWxlY3RlZCBvcHRpb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgaWRlbnRpZmllZCBieSB0aGUgYG5nTW9kZWxgCiAqIGRpcmVjdGl2ZS4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZToqKiBgbmdNb2RlbGAgY29tcGFyZXMgYnkgcmVmZXJlbmNlLCBub3QgdmFsdWUuIFRoaXMgaXMgaW1wb3J0YW50IHdoZW4gYmluZGluZyB0byBhbgogKiBhcnJheSBvZiBvYmplY3RzLiBTZWUgYW4gZXhhbXBsZSBbaW4gdGhpcyBqc2ZpZGRsZV0oaHR0cDovL2pzZmlkZGxlLm5ldC9xV3pUYi8pLgogKiA8L2Rpdj4KICoKICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogKiBiZSBuZXN0ZWQgaW50byB0aGUgYDxzZWxlY3Q+YCBlbGVtZW50LiBUaGlzIGVsZW1lbnQgd2lsbCB0aGVuIHJlcHJlc2VudCB0aGUgYG51bGxgIG9yICJub3Qgc2VsZWN0ZWQiCiAqIG9wdGlvbi4gU2VlIGV4YW1wbGUgYmVsb3cgZm9yIGRlbW9uc3RyYXRpb24uCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogYG5nT3B0aW9uc2AgcHJvdmlkZXMgYW4gaXRlcmF0b3IgZmFjaWxpdHkgZm9yIHRoZSBgPG9wdGlvbj5gIGVsZW1lbnQgd2hpY2ggc2hvdWxkIGJlIHVzZWQgaW5zdGVhZAogKiBvZiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fSB3aGVuIHlvdSB3YW50IHRoZQogKiBgc2VsZWN0YCBtb2RlbCB0byBiZSBib3VuZCB0byBhIG5vbi1zdHJpbmcgdmFsdWUuIFRoaXMgaXMgYmVjYXVzZSBhbiBvcHRpb24gZWxlbWVudCBjYW4gb25seQogKiBiZSBib3VuZCB0byBzdHJpbmcgdmFsdWVzIGF0IHByZXNlbnQuCiAqIDwvZGl2PgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBUaGUgY29udHJvbCBpcyBjb25zaWRlcmVkIHZhbGlkIG9ubHkgaWYgdmFsdWUgaXMgZW50ZXJlZC4KICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbj19IG5nT3B0aW9ucyBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICoKICogICAqIGZvciBhcnJheSBkYXRhIHNvdXJjZXM6CiAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICogICAgICogYGxhYmVsYCAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgICoqYHRyYWNrIGJ5YCoqIGB0cmFja2V4cHJgCiAqICAgKiBmb3Igb2JqZWN0IGRhdGEgc291cmNlczoKICogICAgICogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICogICAgICogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvciAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYAogKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICoKICogV2hlcmU6CiAqCiAqICAgKiBgYXJyYXlgIC8gYG9iamVjdGA6IGFuIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIGFycmF5IC8gb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICogICAqIGB2YWx1ZWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gZWFjaCBpdGVtIGluIHRoZSBgYXJyYXlgIG9yIGVhY2ggcHJvcGVydHkgdmFsdWUKICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogKiAgICogYGtleWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gYSBwcm9wZXJ0eSBuYW1lIGluIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAqICAgKiBgbGFiZWxgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHRoZSBsYWJlbCBmb3IgYDxvcHRpb24+YCBlbGVtZW50LiBUaGUKICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICogICAqIGBzZWxlY3RgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBvZiB0aGUgcGFyZW50IGA8c2VsZWN0PmAKICogICAgICBlbGVtZW50LiBJZiBub3Qgc3BlY2lmaWVkLCBgc2VsZWN0YCBleHByZXNzaW9uIHdpbGwgZGVmYXVsdCB0byBgdmFsdWVgLgogKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogKiAgICAgIERPTSBlbGVtZW50LgogKiAgICogYHRyYWNrZXhwcmA6IFVzZWQgd2hlbiB3b3JraW5nIHdpdGggYW4gYXJyYXkgb2Ygb2JqZWN0cy4gVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZQogKiAgICAgIHVzZWQgdG8gaWRlbnRpZnkgdGhlIG9iamVjdHMgaW4gdGhlIGFycmF5LiBUaGUgYHRyYWNrZXhwcmAgd2lsbCBtb3N0IGxpa2VseSByZWZlciB0byB0aGUKICogICAgIGB2YWx1ZWAgdmFyaWFibGUgKGUuZy4gYHZhbHVlLnByb3BlcnR5TmFtZWApLgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGU+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxzY3JpcHQ+CiAgICAgICAgZnVuY3Rpb24gTXlDbnRybCgkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS5jb2xvcnMgPSBbCiAgICAgICAgICAgIHtuYW1lOidibGFjaycsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOid3aGl0ZScsIHNoYWRlOidsaWdodCd9LAogICAgICAgICAgICB7bmFtZToncmVkJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J2JsdWUnLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZToneWVsbG93Jywgc2hhZGU6J2xpZ2h0J30KICAgICAgICAgIF07CiAgICAgICAgICAkc2NvcGUubXlDb2xvciA9ICRzY29wZS5jb2xvcnNbMl07IC8vIHJlZAogICAgICAgIH0KICAgICAgICA8L3NjcmlwdD4KICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ik15Q250cmwiPgogICAgICAgICAgPHVsPgogICAgICAgICAgICA8bGkgbmctcmVwZWF0PSJjb2xvciBpbiBjb2xvcnMiPgogICAgICAgICAgICAgIE5hbWU6IDxpbnB1dCBuZy1tb2RlbD0iY29sb3IubmFtZSI+CiAgICAgICAgICAgICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5zcGxpY2UoJGluZGV4LCAxKSI+WDwvYT5dCiAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgIDxsaT4KICAgICAgICAgICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICAgICAgICAgICA8L2xpPgogICAgICAgICAgPC91bD4KICAgICAgICAgIDxoci8+CiAgICAgICAgICBDb2xvciAobnVsbCBub3QgYWxsb3dlZCk6CiAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJteUNvbG9yIiBuZy1vcHRpb25zPSJjb2xvci5uYW1lIGZvciBjb2xvciBpbiBjb2xvcnMiPjwvc2VsZWN0Pjxicj4KCiAgICAgICAgICBDb2xvciAobnVsbCBhbGxvd2VkKToKICAgICAgICAgIDxzcGFuICBjbGFzcz0ibnVsbGFibGUiPgogICAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJteUNvbG9yIiBuZy1vcHRpb25zPSJjb2xvci5uYW1lIGZvciBjb2xvciBpbiBjb2xvcnMiPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+LS0gY2hvb3NlIGNvbG9yIC0tPC9vcHRpb24+CiAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgPC9zcGFuPjxici8+CgogICAgICAgICAgQ29sb3IgZ3JvdXBlZCBieSBzaGFkZToKICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9Im15Q29sb3IiIG5nLW9wdGlvbnM9ImNvbG9yLm5hbWUgZ3JvdXAgYnkgY29sb3Iuc2hhZGUgZm9yIGNvbG9yIGluIGNvbG9ycyI+CiAgICAgICAgICA8L3NlbGVjdD48YnIvPgoKCiAgICAgICAgICBTZWxlY3QgPGEgaHJlZiBuZy1jbGljaz0ibXlDb2xvciA9IHsgbmFtZTonbm90IGluIGxpc3QnLCBzaGFkZTogJ290aGVyJyB9Ij5ib2d1czwvYT4uPGJyPgogICAgICAgICAgPGhyLz4KICAgICAgICAgIEN1cnJlbnRseSBzZWxlY3RlZDoge3sge3NlbGVjdGVkX2NvbG9yOm15Q29sb3J9ICB9fQogICAgICAgICAgPGRpdiBzdHlsZT0iYm9yZGVyOnNvbGlkIDFweCBibGFjazsgaGVpZ2h0OjIwcHgiCiAgICAgICAgICAgICAgIG5nLXN0eWxlPSJ7J2JhY2tncm91bmQtY29sb3InOm15Q29sb3IubmFtZX0iPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctb3B0aW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpteUNvbG9yfScpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJ3JlZCcpOwogICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5LnNlbGVjdCgnbXlDb2xvcicpKS5maXJzdCgpLmNsaWNrKCk7CiAgICAgICAgICAgZWxlbWVudC5hbGwoYnkuY3NzKCdzZWxlY3RbbmctbW9kZWw9Im15Q29sb3IiXSBvcHRpb24nKSkuZmlyc3QoKS5jbGljaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpteUNvbG9yfScpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJ2JsYWNrJyk7CiAgICAgICAgICAgZWxlbWVudChieS5jc3MoJy5udWxsYWJsZSBzZWxlY3RbbmctbW9kZWw9Im15Q29sb3IiXScpKS5jbGljaygpOwogICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5LmNzcygnLm51bGxhYmxlIHNlbGVjdFtuZy1tb2RlbD0ibXlDb2xvciJdIG9wdGlvbicpKS5maXJzdCgpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygne3NlbGVjdGVkX2NvbG9yOm15Q29sb3J9JykpLmdldFRleHQoKSkudG9NYXRjaCgnbnVsbCcpOwogICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KCnZhciBuZ09wdGlvbnNEaXJlY3RpdmUgPSB2YWx1ZUZuKHsgdGVybWluYWw6IHRydWUgfSk7Ci8vIGpzaGludCBtYXhsZW46IGZhbHNlCnZhciBzZWxlY3REaXJlY3RpdmUgPSBbJyRjb21waWxlJywgJyRwYXJzZScsIGZ1bmN0aW9uKCRjb21waWxlLCAgICRwYXJzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgLy8wMDAwMTExMTExMTExMTAwMDAwMDAwMDAwMjIyMjIyMjIyMjAwMDAwMDAwMDAwMDAwMDAwMDAwMDMzMzMzMzMzMzMwMDAwMDAwMDAwMDAwMDQ0NDQ0NDQ0NDQ0NDQ0NDAwMDAwMDAwMDU1NTU1NTU1NTU1NTU1NTAwMDAwMDA2NjY2NjY2NjY2NjY2NjYwMDAwMDAwMDAwMDAwMDA3Nzc3Nzc3Nzc3MDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODgKICB2YXIgTkdfT1BUSU9OU19SRUdFWFAgPSAvXlxzKihbXHNcU10rPykoPzpccythc1xzKyhbXHNcU10rPykpPyg/OlxzK2dyb3VwXHMrYnlccysoW1xzXFNdKz8pKT9ccytmb3JccysoPzooW1wkXHddW1wkXHddKil8KD86XChccyooW1wkXHddW1wkXHddKilccyosXHMqKFtcJFx3XVtcJFx3XSopXHMqXCkpKVxzK2luXHMrKFtcc1xTXSs/KSg/OlxzK3RyYWNrXHMrYnlccysoW1xzXFNdKz8pKT8kLywKICAgICAgbnVsbE1vZGVsQ3RybCA9IHskc2V0Vmlld1ZhbHVlOiBub29wfTsKLy8ganNoaW50IG1heGxlbjogMTAwCgogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVxdWlyZTogWydzZWxlY3QnLCAnP25nTW9kZWwnXSwKICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uKCRlbGVtZW50LCAkc2NvcGUsICRhdHRycykgewogICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICBvcHRpb25zTWFwID0ge30sCiAgICAgICAgICBuZ01vZGVsQ3RybCA9IG51bGxNb2RlbEN0cmwsCiAgICAgICAgICBudWxsT3B0aW9uLAogICAgICAgICAgdW5rbm93bk9wdGlvbjsKCgogICAgICBzZWxmLmRhdGFib3VuZCA9ICRhdHRycy5uZ01vZGVsOwoKCiAgICAgIHNlbGYuaW5pdCA9IGZ1bmN0aW9uKG5nTW9kZWxDdHJsXywgbnVsbE9wdGlvbl8sIHVua25vd25PcHRpb25fKSB7CiAgICAgICAgbmdNb2RlbEN0cmwgPSBuZ01vZGVsQ3RybF87CiAgICAgICAgbnVsbE9wdGlvbiA9IG51bGxPcHRpb25fOwogICAgICAgIHVua25vd25PcHRpb24gPSB1bmtub3duT3B0aW9uXzsKICAgICAgfTsKCgogICAgICBzZWxmLmFkZE9wdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkodmFsdWUsICcib3B0aW9uIHZhbHVlIicpOwogICAgICAgIG9wdGlvbnNNYXBbdmFsdWVdID0gdHJ1ZTsKCiAgICAgICAgaWYgKG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUgPT0gdmFsdWUpIHsKICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgIH07CgoKICAgICAgc2VsZi5yZW1vdmVPcHRpb24gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLmhhc09wdGlvbih2YWx1ZSkpIHsKICAgICAgICAgIGRlbGV0ZSBvcHRpb25zTWFwW3ZhbHVlXTsKICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVW5rbm93bk9wdGlvbih2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKCiAgICAgIHNlbGYucmVuZGVyVW5rbm93bk9wdGlvbiA9IGZ1bmN0aW9uKHZhbCkgewogICAgICAgIHZhciB1bmtub3duVmFsID0gJz8gJyArIGhhc2hLZXkodmFsKSArICcgPyc7CiAgICAgICAgdW5rbm93bk9wdGlvbi52YWwodW5rbm93blZhbCk7CiAgICAgICAgJGVsZW1lbnQucHJlcGVuZCh1bmtub3duT3B0aW9uKTsKICAgICAgICAkZWxlbWVudC52YWwodW5rbm93blZhbCk7CiAgICAgICAgdW5rbm93bk9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyBuZWVkZWQgZm9yIElFCiAgICAgIH07CgoKICAgICAgc2VsZi5oYXNPcHRpb24gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBvcHRpb25zTWFwLmhhc093blByb3BlcnR5KHZhbHVlKTsKICAgICAgfTsKCiAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gZGlzYWJsZSB1bmtub3duIG9wdGlvbiBzbyB0aGF0IHdlIGRvbid0IGRvIHdvcmsgd2hlbiB0aGUgd2hvbGUgc2VsZWN0IGlzIGJlaW5nIGRlc3Ryb3llZAogICAgICAgIHNlbGYucmVuZGVyVW5rbm93bk9wdGlvbiA9IG5vb3A7CiAgICAgIH0pOwogICAgfV0sCgogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgIC8vIGlmIG5nTW9kZWwgaXMgbm90IGRlZmluZWQsIHdlIGRvbid0IG5lZWQgdG8gZG8gYW55dGhpbmcKICAgICAgaWYgKCFjdHJsc1sxXSkgcmV0dXJuOwoKICAgICAgdmFyIHNlbGVjdEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgIG5nTW9kZWxDdHJsID0gY3RybHNbMV0sCiAgICAgICAgICBtdWx0aXBsZSA9IGF0dHIubXVsdGlwbGUsCiAgICAgICAgICBvcHRpb25zRXhwID0gYXR0ci5uZ09wdGlvbnMsCiAgICAgICAgICBudWxsT3B0aW9uID0gZmFsc2UsIC8vIGlmIGZhbHNlLCB1c2VyIHdpbGwgbm90IGJlIGFibGUgdG8gc2VsZWN0IGl0ICh1c2VkIGJ5IG5nT3B0aW9ucykKICAgICAgICAgIGVtcHR5T3B0aW9uLAogICAgICAgICAgLy8gd2UgY2FuJ3QganVzdCBqcUxpdGUoJzxvcHRpb24+Jykgc2luY2UganFMaXRlIGlzIG5vdCBzbWFydCBlbm91Z2gKICAgICAgICAgIC8vIHRvIGNyZWF0ZSBpdCBpbiA8c2VsZWN0PiBhbmQgSUUgYmFyZnMgb3RoZXJ3aXNlLgogICAgICAgICAgb3B0aW9uVGVtcGxhdGUgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpLAogICAgICAgICAgb3B0R3JvdXBUZW1wbGF0ZSA9anFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICAgICAgdW5rbm93bk9wdGlvbiA9IG9wdGlvblRlbXBsYXRlLmNsb25lKCk7CgogICAgICAvLyBmaW5kICJudWxsIiBvcHRpb24KICAgICAgZm9yKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCksIGlpID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGlmIChjaGlsZHJlbltpXS52YWx1ZSA9PT0gJycpIHsKICAgICAgICAgIGVtcHR5T3B0aW9uID0gbnVsbE9wdGlvbiA9IGNoaWxkcmVuLmVxKGkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWxlY3RDdHJsLmluaXQobmdNb2RlbEN0cmwsIG51bGxPcHRpb24sIHVua25vd25PcHRpb24pOwoKICAgICAgLy8gcmVxdWlyZWQgdmFsaWRhdG9yCiAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgIG5nTW9kZWxDdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAhdmFsdWUgfHwgdmFsdWUubGVuZ3RoID09PSAwOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zRXhwKSBzZXR1cEFzT3B0aW9ucyhzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICBlbHNlIGlmIChtdWx0aXBsZSkgc2V0dXBBc011bHRpcGxlKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCk7CiAgICAgIGVsc2Ugc2V0dXBBc1NpbmdsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwsIHNlbGVjdEN0cmwpOwoKCiAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgoKICAgICAgZnVuY3Rpb24gc2V0dXBBc1NpbmdsZShzY29wZSwgc2VsZWN0RWxlbWVudCwgbmdNb2RlbEN0cmwsIHNlbGVjdEN0cmwpIHsKICAgICAgICBuZ01vZGVsQ3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdmlld1ZhbHVlID0gbmdNb2RlbEN0cmwuJHZpZXdWYWx1ZTsKCiAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgc2VsZWN0RWxlbWVudC52YWwodmlld1ZhbHVlKTsKICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxlY3RDdHJsLnJlbmRlclVua25vd25PcHRpb24odmlld1ZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZpZXdWYWx1ZShzZWxlY3RFbGVtZW50LnZhbCgpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzZXR1cEFzTXVsdGlwbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICB2YXIgbGFzdFZpZXc7CiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgaXRlbXMgPSBuZXcgSGFzaE1hcChjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgZm9yRWFjaChzZWxlY3RFbGVtZW50LmZpbmQoJ29wdGlvbicpLCBmdW5jdGlvbihvcHRpb24pIHsKICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gaXNEZWZpbmVkKGl0ZW1zLmdldChvcHRpb24udmFsdWUpKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIC8vIHdlIGhhdmUgdG8gZG8gaXQgb24gZWFjaCB3YXRjaCBzaW5jZSBuZ01vZGVsIHdhdGNoZXMgcmVmZXJlbmNlLCBidXQKICAgICAgICAvLyB3ZSBuZWVkIHRvIHdvcmsgb2YgYW4gYXJyYXksIHNvIHdlIG5lZWQgdG8gc2VlIGlmIGFueXRoaW5nIHdhcyBpbnNlcnRlZC9yZW1vdmVkCiAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHNlbGVjdE11bHRpcGxlV2F0Y2goKSB7CiAgICAgICAgICBpZiAoIWVxdWFscyhsYXN0VmlldywgY3RybC4kdmlld1ZhbHVlKSkgewogICAgICAgICAgICBsYXN0VmlldyA9IHNoYWxsb3dDb3B5KGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5maW5kKCdvcHRpb24nKSwgZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgYXJyYXkucHVzaChvcHRpb24udmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhcnJheSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gc2V0dXBBc09wdGlvbnMoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICB2YXIgbWF0Y2g7CgogICAgICAgIGlmICghKG1hdGNoID0gb3B0aW9uc0V4cC5tYXRjaChOR19PUFRJT05TX1JFR0VYUCkpKSB7CiAgICAgICAgICB0aHJvdyBuZ09wdGlvbnNNaW5FcnIoJ2lleHAnLAogICAgICAgICAgICAiRXhwZWN0ZWQgZXhwcmVzc2lvbiBpbiBmb3JtIG9mICIgKwogICAgICAgICAgICAiJ19zZWxlY3RfIChhcyBfbGFiZWxfKT8gZm9yIChfa2V5XywpP192YWx1ZV8gaW4gX2NvbGxlY3Rpb25fJyIgKwogICAgICAgICAgICAiIGJ1dCBnb3QgJ3swfScuIEVsZW1lbnQ6IHsxfSIsCiAgICAgICAgICAgIG9wdGlvbnNFeHAsIHN0YXJ0aW5nVGFnKHNlbGVjdEVsZW1lbnQpKTsKICAgICAgICB9CgogICAgICAgIHZhciBkaXNwbGF5Rm4gPSAkcGFyc2UobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pLAogICAgICAgICAgICB2YWx1ZU5hbWUgPSBtYXRjaFs0XSB8fCBtYXRjaFs2XSwKICAgICAgICAgICAga2V5TmFtZSA9IG1hdGNoWzVdLAogICAgICAgICAgICBncm91cEJ5Rm4gPSAkcGFyc2UobWF0Y2hbM10gfHwgJycpLAogICAgICAgICAgICB2YWx1ZUZuID0gJHBhcnNlKG1hdGNoWzJdID8gbWF0Y2hbMV0gOiB2YWx1ZU5hbWUpLAogICAgICAgICAgICB2YWx1ZXNGbiA9ICRwYXJzZShtYXRjaFs3XSksCiAgICAgICAgICAgIHRyYWNrID0gbWF0Y2hbOF0sCiAgICAgICAgICAgIHRyYWNrRm4gPSB0cmFjayA/ICRwYXJzZShtYXRjaFs4XSkgOiBudWxsLAogICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFycmF5IG9mIGFycmF5IG9mIGV4aXN0aW5nIG9wdGlvbiBncm91cHMgaW4gRE9NLgogICAgICAgICAgICAvLyBXZSB0cnkgdG8gcmV1c2UgdGhlc2UgaWYgcG9zc2libGUKICAgICAgICAgICAgLy8gLSBvcHRpb25Hcm91cHNDYWNoZVswXSBpcyB0aGUgb3B0aW9ucyB3aXRoIG5vIG9wdGlvbiBncm91cAogICAgICAgICAgICAvLyAtIG9wdGlvbkdyb3Vwc0NhY2hlWz9dWzBdIGlzIHRoZSBwYXJlbnQ6IGVpdGhlciB0aGUgU0VMRUNUIG9yIE9QVEdST1VQIGVsZW1lbnQKICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUgPSBbW3tlbGVtZW50OiBzZWxlY3RFbGVtZW50LCBsYWJlbDonJ31dXTsKCiAgICAgICAgaWYgKG51bGxPcHRpb24pIHsKICAgICAgICAgIC8vIGNvbXBpbGUgdGhlIGVsZW1lbnQgc2luY2UgdGhlcmUgbWlnaHQgYmUgYmluZGluZ3MgaW4gaXQKICAgICAgICAgICRjb21waWxlKG51bGxPcHRpb24pKHNjb3BlKTsKCiAgICAgICAgICAvLyByZW1vdmUgdGhlIGNsYXNzLCB3aGljaCBpcyBhZGRlZCBhdXRvbWF0aWNhbGx5IGJlY2F1c2Ugd2UgcmVjb21waWxlIHRoZSBlbGVtZW50IGFuZCBpdAogICAgICAgICAgLy8gYmVjb21lcyB0aGUgY29tcGlsYXRpb24gcm9vdAogICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmVDbGFzcygnbmctc2NvcGUnKTsKCiAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHJlbW92ZSBpdCBiZWZvcmUgY2FsbGluZyBzZWxlY3RFbGVtZW50LmVtcHR5KCkgYmVjYXVzZSBvdGhlcndpc2UgSUUgd2lsbAogICAgICAgICAgLy8gcmVtb3ZlIHRoZSBsYWJlbCBmcm9tIHRoZSBlbGVtZW50LiB3dGY/CiAgICAgICAgICBudWxsT3B0aW9uLnJlbW92ZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gY2xlYXIgY29udGVudHMsIHdlJ2xsIGFkZCB3aGF0J3MgbmVlZGVkIGJhc2VkIG9uIHRoZSBtb2RlbAogICAgICAgIHNlbGVjdEVsZW1lbnQuZW1wdHkoKTsKCiAgICAgICAgc2VsZWN0RWxlbWVudC5vbignY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24gPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICAgIGtleSwgdmFsdWUsIG9wdGlvbkVsZW1lbnQsIGluZGV4LCBncm91cEluZGV4LCBsZW5ndGgsIGdyb3VwTGVuZ3RoLCB0cmFja0luZGV4OwoKICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXgrKykgewogICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgZm9yKGluZGV4ID0gMSwgbGVuZ3RoID0gb3B0aW9uR3JvdXAubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcHRpb25FbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgICAgIGZvciAodHJhY2tJbmRleCA9IDA7IHRyYWNrSW5kZXggPCBjb2xsZWN0aW9uLmxlbmd0aDsgdHJhY2tJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gY29sbGVjdGlvblt0cmFja0luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4oc2NvcGUsIGxvY2FscykgPT0ga2V5KSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhbHVlLnB1c2godmFsdWVGbihzY29wZSwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAga2V5ID0gc2VsZWN0RWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICcnKXsKICAgICAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgZm9yICh0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IGNvbGxlY3Rpb24ubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25bdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4oc2NvcGUsIGxvY2FscykgPT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgbnVsbCBvcHRpb24ncyBzZWxlY3RlZCBwcm9wZXJ0eSBoZXJlIHNvICRyZW5kZXIgY2xlYW5zIGl0IHVwIGNvcnJlY3RseQogICAgICAgICAgICAgIGlmIChvcHRpb25Hcm91cHNDYWNoZVswXS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9uR3JvdXBzQ2FjaGVbMF1bMV0uaWQgIT09IGtleSkgewogICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZVswXVsxXS5zZWxlY3RlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJHJlbmRlciA9IHJlbmRlcjsKCiAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGNhbid0IHdlIG9wdGltaXplIHRoaXMgPwogICAgICAgIHNjb3BlLiR3YXRjaChyZW5kZXIpOwoKICAgICAgICBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgICAgICAgLy8gVGVtcG9yYXJ5IGxvY2F0aW9uIGZvciB0aGUgb3B0aW9uIGdyb3VwcyBiZWZvcmUgd2UgcmVuZGVyIHRoZW0KICAgICAgICAgIHZhciBvcHRpb25Hcm91cHMgPSB7Jyc6W119LAogICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZXMgPSBbJyddLAogICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSwKICAgICAgICAgICAgICBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQsIGV4aXN0aW5nT3B0aW9ucywgZXhpc3RpbmdPcHRpb24sCiAgICAgICAgICAgICAgbW9kZWxWYWx1ZSA9IGN0cmwuJG1vZGVsVmFsdWUsCiAgICAgICAgICAgICAgdmFsdWVzID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgIGtleXMgPSBrZXlOYW1lID8gc29ydGVkS2V5cyh2YWx1ZXMpIDogdmFsdWVzLAogICAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgICBncm91cExlbmd0aCwgbGVuZ3RoLAogICAgICAgICAgICAgIGdyb3VwSW5kZXgsIGluZGV4LAogICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgIHNlbGVjdGVkLAogICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gZmFsc2UsIC8vIG5vdGhpbmcgaXMgc2VsZWN0ZWQgeWV0CiAgICAgICAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgICAgICAgZWxlbWVudCwKICAgICAgICAgICAgICBsYWJlbDsKCiAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgaWYgKHRyYWNrRm4gJiYgaXNBcnJheShtb2RlbFZhbHVlKSkgewogICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gbmV3IEhhc2hNYXAoW10pOwogICAgICAgICAgICAgIGZvciAodmFyIHRyYWNrSW5kZXggPSAwOyB0cmFja0luZGV4IDwgbW9kZWxWYWx1ZS5sZW5ndGg7IHRyYWNrSW5kZXgrKykgewogICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBtb2RlbFZhbHVlW3RyYWNrSW5kZXhdOwogICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQucHV0KHRyYWNrRm4oc2NvcGUsIGxvY2FscyksIG1vZGVsVmFsdWVbdHJhY2tJbmRleF0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKG1vZGVsVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gV2Ugbm93IGJ1aWxkIHVwIHRoZSBsaXN0IG9mIG9wdGlvbnMgd2UgbmVlZCAod2UgbWVyZ2UgbGF0ZXIpCiAgICAgICAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID0ga2V5cy5sZW5ndGgsIGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgogICAgICAgICAgICBrZXkgPSBpbmRleDsKICAgICAgICAgICAgaWYgKGtleU5hbWUpIHsKICAgICAgICAgICAgICBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgICAgICAgICBpZiAoIGtleS5jaGFyQXQoMCkgPT09ICckJyApIGNvbnRpbnVlOwogICAgICAgICAgICAgIGxvY2Fsc1trZXlOYW1lXSA9IGtleTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSB2YWx1ZXNba2V5XTsKCiAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IGdyb3VwQnlGbihzY29wZSwgbG9jYWxzKSB8fCAnJzsKICAgICAgICAgICAgaWYgKCEob3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSkpIHsKICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdID0gW107CiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcy5wdXNoKG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBpc0RlZmluZWQoCiAgICAgICAgICAgICAgICBzZWxlY3RlZFNldC5yZW1vdmUodHJhY2tGbiA/IHRyYWNrRm4oc2NvcGUsIGxvY2FscykgOiB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgIHZhciBtb2RlbENhc3QgPSB7fTsKICAgICAgICAgICAgICAgIG1vZGVsQ2FzdFt2YWx1ZU5hbWVdID0gbW9kZWxWYWx1ZTsKICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gdHJhY2tGbihzY29wZSwgbW9kZWxDYXN0KSA9PT0gdHJhY2tGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBtb2RlbFZhbHVlID09PSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IHNlbGVjdGVkU2V0IHx8IHNlbGVjdGVkOyAvLyBzZWUgaWYgYXQgbGVhc3Qgb25lIGl0ZW0gaXMgc2VsZWN0ZWQKICAgICAgICAgICAgfQogICAgICAgICAgICBsYWJlbCA9IGRpc3BsYXlGbihzY29wZSwgbG9jYWxzKTsgLy8gd2hhdCB3aWxsIGJlIHNlZW4gYnkgdGhlIHVzZXIKCiAgICAgICAgICAgIC8vIGRvaW5nIGRpc3BsYXlGbihzY29wZSwgbG9jYWxzKSB8fCAnJyBvdmVyd3JpdGVzIHplcm8gdmFsdWVzCiAgICAgICAgICAgIGxhYmVsID0gaXNEZWZpbmVkKGxhYmVsKSA/IGxhYmVsIDogJyc7CiAgICAgICAgICAgIG9wdGlvbkdyb3VwLnB1c2goewogICAgICAgICAgICAgIC8vIGVpdGhlciB0aGUgaW5kZXggaW50byBhcnJheSBvciBrZXkgZnJvbSBvYmplY3QKICAgICAgICAgICAgICBpZDogdHJhY2tGbiA/IHRyYWNrRm4oc2NvcGUsIGxvY2FscykgOiAoa2V5TmFtZSA/IGtleXNbaW5kZXhdIDogaW5kZXgpLAogICAgICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgICAgICBzZWxlY3RlZDogc2VsZWN0ZWQgICAgICAgICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBiZSBzZWxlY3RlZAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgaWYgKG51bGxPcHRpb24gfHwgbW9kZWxWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIC8vIGluc2VydCBudWxsIG9wdGlvbiBpZiB3ZSBoYXZlIGEgcGxhY2Vob2xkZXIsIG9yIHRoZSBtb2RlbCBpcyBudWxsCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDonJywgbGFiZWw6JycsIHNlbGVjdGVkOiFzZWxlY3RlZFNldH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFzZWxlY3RlZFNldCkgewogICAgICAgICAgICAgIC8vIG9wdGlvbiBjb3VsZCBub3QgYmUgZm91bmQsIHdlIGhhdmUgdG8gaW5zZXJ0IHRoZSB1bmRlZmluZWQgaXRlbQogICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6Jz8nLCBsYWJlbDonJywgc2VsZWN0ZWQ6dHJ1ZX0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTm93IHdlIG5lZWQgdG8gdXBkYXRlIHRoZSBsaXN0IG9mIERPTSBub2RlcyB0byBtYXRjaCB0aGUgb3B0aW9uR3JvdXBzIHdlIGNvbXB1dGVkIGFib3ZlCiAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3VwTmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgIGdyb3VwSW5kZXgrKykgewogICAgICAgICAgICAvLyBjdXJyZW50IG9wdGlvbiBncm91cCBuYW1lIG9yICcnIGlmIG5vIGdyb3VwCiAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAvLyBsaXN0IG9mIG9wdGlvbnMgZm9yIHRoYXQgZ3JvdXAuIChmaXJzdCBpdGVtIGhhcyB0aGUgcGFyZW50KQogICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdOwoKICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBncm93IHRoZSBvcHRpb25Hcm91cHMKICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IHsKICAgICAgICAgICAgICAgIGVsZW1lbnQ6IG9wdEdyb3VwVGVtcGxhdGUuY2xvbmUoKS5hdHRyKCdsYWJlbCcsIG9wdGlvbkdyb3VwTmFtZSksCiAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uR3JvdXAubGFiZWwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IFtleGlzdGluZ1BhcmVudF07CiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucHVzaChleGlzdGluZ09wdGlvbnMpOwogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYXBwZW5kKGV4aXN0aW5nUGFyZW50LmVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IG9wdGlvbkdyb3Vwc0NhY2hlW2dyb3VwSW5kZXhdOwogICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gZXhpc3RpbmdPcHRpb25zWzBdOyAgLy8gZWl0aGVyIFNFTEVDVCAobm8gZ3JvdXApIG9yIE9QVEdST1VQIGVsZW1lbnQKCiAgICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSBPUFRHUk9VUCBsYWJlbCBpZiBub3QgdGhlIHNhbWUuCiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUGFyZW50LmxhYmVsICE9IG9wdGlvbkdyb3VwTmFtZSkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQuZWxlbWVudC5hdHRyKCdsYWJlbCcsIGV4aXN0aW5nUGFyZW50LmxhYmVsID0gb3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gbnVsbDsgIC8vIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcKICAgICAgICAgICAgZm9yKGluZGV4ID0gMCwgbGVuZ3RoID0gb3B0aW9uR3JvdXAubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbkdyb3VwW2luZGV4XTsKICAgICAgICAgICAgICBpZiAoKGV4aXN0aW5nT3B0aW9uID0gZXhpc3RpbmdPcHRpb25zW2luZGV4KzFdKSkgewogICAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gZXhpc3RpbmdPcHRpb24uZWxlbWVudDsKICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5sYWJlbCAhPT0gb3B0aW9uLmxhYmVsKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnRleHQoZXhpc3RpbmdPcHRpb24ubGFiZWwgPSBvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmlkICE9PSBvcHRpb24uaWQpIHsKICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudmFsKGV4aXN0aW5nT3B0aW9uLmlkID0gb3B0aW9uLmlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGxhc3RFbGVtZW50LnByb3AoJ3NlbGVjdGVkJykgcHJvdmlkZWQgYnkgalF1ZXJ5IGhhcyBzaWRlLWVmZmVjdHMKICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5zZWxlY3RlZCAhPT0gb3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgKGV4aXN0aW5nT3B0aW9uLnNlbGVjdGVkID0gb3B0aW9uLnNlbGVjdGVkKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGdyb3cgZWxlbWVudHMKCiAgICAgICAgICAgICAgICAvLyBpZiBpdCdzIGEgbnVsbCBvcHRpb24KICAgICAgICAgICAgICAgIGlmIChvcHRpb24uaWQgPT09ICcnICYmIG51bGxPcHRpb24pIHsKICAgICAgICAgICAgICAgICAgLy8gcHV0IGJhY2sgdGhlIHByZS1jb21waWxlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBudWxsT3B0aW9uOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8galF1ZXJ5KHYxLjQuMikgQnVnOiBXZSBzaG91bGQgYmUgYWJsZSB0byBjaGFpbiB0aGUgbWV0aG9kIGNhbGxzLCBidXQKICAgICAgICAgICAgICAgICAgLy8gaW4gdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSBvbiBzb21lIGJyb3dzZXIgdGhlIC50ZXh0KCkgcmV0dXJucyBhIHN0cmluZwogICAgICAgICAgICAgICAgICAvLyByYXRoZXIgdGhlbiB0aGUgZWxlbWVudC4KICAgICAgICAgICAgICAgICAgKGVsZW1lbnQgPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgLnZhbChvcHRpb24uaWQpCiAgICAgICAgICAgICAgICAgICAgICAuYXR0cignc2VsZWN0ZWQnLCBvcHRpb24uc2VsZWN0ZWQpCiAgICAgICAgICAgICAgICAgICAgICAudGV4dChvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wdXNoKGV4aXN0aW5nT3B0aW9uID0gewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbi5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBpZDogb3B0aW9uLmlkLAogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBvcHRpb24uc2VsZWN0ZWQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGxhc3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LmFmdGVyKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQuZWxlbWVudC5hcHBlbmQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZXhjZXNzaXZlIE9QVElPTnMgaW4gYSBncm91cAogICAgICAgICAgICBpbmRleCsrOyAvLyBpbmNyZW1lbnQgc2luY2UgdGhlIGV4aXN0aW5nT3B0aW9uc1swXSBpcyBwYXJlbnQgZWxlbWVudCBub3QgT1BUSU9OCiAgICAgICAgICAgIHdoaWxlKGV4aXN0aW5nT3B0aW9ucy5sZW5ndGggPiBpbmRleCkgewogICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wb3AoKS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICAgIHdoaWxlKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA+IGdyb3VwSW5kZXgpIHsKICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucG9wKClbMF0uZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Owp9XTsKCnZhciBvcHRpb25EaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogIHZhciBudWxsU2VsZWN0Q3RybCA9IHsKICAgIGFkZE9wdGlvbjogbm9vcCwKICAgIHJlbW92ZU9wdGlvbjogbm9vcAogIH07CgogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcHJpb3JpdHk6IDEwMCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIudmFsdWUpKSB7CiAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoZWxlbWVudC50ZXh0KCksIHRydWUpOwogICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIGVsZW1lbnQudGV4dCgpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICB2YXIgc2VsZWN0Q3RybE5hbWUgPSAnJHNlbGVjdENvbnRyb2xsZXInLAogICAgICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpLAogICAgICAgICAgICBzZWxlY3RDdHJsID0gcGFyZW50LmRhdGEoc2VsZWN0Q3RybE5hbWUpIHx8CiAgICAgICAgICAgICAgcGFyZW50LnBhcmVudCgpLmRhdGEoc2VsZWN0Q3RybE5hbWUpOyAvLyBpbiBjYXNlIHdlIGFyZSBpbiBvcHRncm91cAoKICAgICAgICBpZiAoc2VsZWN0Q3RybCAmJiBzZWxlY3RDdHJsLmRhdGFib3VuZCkgewogICAgICAgICAgLy8gRm9yIHNvbWUgcmVhc29uIE9wZXJhIGRlZmF1bHRzIHRvIHRydWUgYW5kIGlmIG5vdCBvdmVycmlkZGVuIHRoaXMgbWVzc2VzIHVwIHRoZSByZXBlYXRlci4KICAgICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdGhlIHZpZXcgdG8gZHJpdmUgdGhlIGluaXRpYWxpemF0aW9uIG9mIHRoZSBtb2RlbCBhbnl3YXkuCiAgICAgICAgICBlbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxlY3RDdHJsID0gbnVsbFNlbGVjdEN0cmw7CiAgICAgICAgfQoKICAgICAgICBpZiAoaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgc2NvcGUuJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlV2F0Y2hBY3Rpb24obmV3VmFsLCBvbGRWYWwpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIG5ld1ZhbCk7CiAgICAgICAgICAgIGlmIChuZXdWYWwgIT09IG9sZFZhbCkgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24ob2xkVmFsKTsKICAgICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24obmV3VmFsKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxlY3RDdHJsLmFkZE9wdGlvbihhdHRyLnZhbHVlKTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxlY3RDdHJsLnJlbW92ZU9wdGlvbihhdHRyLnZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9Owp9XTsKCnZhciBzdHlsZURpcmVjdGl2ZSA9IHZhbHVlRm4oewogIHJlc3RyaWN0OiAnRScsCiAgdGVybWluYWw6IHRydWUKfSk7CgogIGlmICh3aW5kb3cuYW5ndWxhci5ib290c3RyYXApIHsKICAgIC8vQW5ndWxhckpTIGlzIGFscmVhZHkgbG9hZGVkLCBzbyB3ZSBjYW4gcmV0dXJuIGhlcmUuLi4KICAgIGNvbnNvbGUubG9nKCdXQVJOSU5HOiBUcmllZCB0byBsb2FkIGFuZ3VsYXIgbW9yZSB0aGFuIG9uY2UuJyk7CiAgICByZXR1cm47CiAgfQoKICAvL3RyeSB0byBiaW5kIHRvIGpxdWVyeSBub3cgc28gdGhhdCBvbmUgY2FuIHdyaXRlIGFuZ3VsYXIuZWxlbWVudCgpLnJlYWQoKQogIC8vYnV0IHdlIHdpbGwgcmViaW5kIG9uIGJvb3RzdHJhcCBhZ2Fpbi4KICBiaW5kSlF1ZXJ5KCk7CgogIHB1Ymxpc2hFeHRlcm5hbEFQSShhbmd1bGFyKTsKCiAganFMaXRlKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHsKICAgIGFuZ3VsYXJJbml0KGRvY3VtZW50LCBib290c3RyYXApOwogIH0pOwoKfSkod2luZG93LCBkb2N1bWVudCk7Cgohd2luZG93LmFuZ3VsYXIuJCRjc3AoKSAmJiB3aW5kb3cuYW5ndWxhci5lbGVtZW50KGRvY3VtZW50KS5maW5kKCdoZWFkJykucHJlcGVuZCgnPHN0eWxlIHR5cGU9InRleHQvY3NzIj5AY2hhcnNldCAiVVRGLTgiO1tuZ1xcOmNsb2FrXSxbbmctY2xvYWtdLFtkYXRhLW5nLWNsb2FrXSxbeC1uZy1jbG9ha10sLm5nLWNsb2FrLC54LW5nLWNsb2FrLC5uZy1oaWRle2Rpc3BsYXk6bm9uZSAhaW1wb3J0YW50O31uZ1xcOmZvcm17ZGlzcGxheTpibG9jazt9Lm5nLWFuaW1hdGUtYmxvY2stdHJhbnNpdGlvbnN7dHJhbnNpdGlvbjowcyBhbGwhaW1wb3J0YW50Oy13ZWJraXQtdHJhbnNpdGlvbjowcyBhbGwhaW1wb3J0YW50O30ubmctaGlkZS1hZGQtYWN0aXZlLC5uZy1oaWRlLXJlbW92ZXtkaXNwbGF5OmJsb2NrIWltcG9ydGFudDt9PC9zdHlsZT4nKTsKLyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qKgogKiBAbGljZW5zZSBBbmd1bGFySlMgdjEuMi4xNwogKiAoYykgMjAxMC0yMDE0IEdvb2dsZSwgSW5jLiBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbih3aW5kb3csIGFuZ3VsYXIsIHVuZGVmaW5lZCkgeyd1c2Ugc3RyaWN0JzsKCi8qIGpzaGludCBtYXhsZW46IGZhbHNlICovCgovKioKICogQG5nZG9jIG1vZHVsZQogKiBAbmFtZSBuZ0FuaW1hdGUKICogQGRlc2NyaXB0aW9uCiAqCiAqICMgbmdBbmltYXRlCiAqCiAqIFRoZSBgbmdBbmltYXRlYCBtb2R1bGUgcHJvdmlkZXMgc3VwcG9ydCBmb3IgSmF2YVNjcmlwdCwgQ1NTMyB0cmFuc2l0aW9uIGFuZCBDU1MzIGtleWZyYW1lIGFuaW1hdGlvbiBob29rcyB3aXRoaW4gZXhpc3RpbmcgY29yZSBhbmQgY3VzdG9tIGRpcmVjdGl2ZXMuCiAqCiAqCiAqIDxkaXYgZG9jLW1vZHVsZS1jb21wb25lbnRzPSJuZ0FuaW1hdGUiPjwvZGl2PgogKgogKiAjIFVzYWdlCiAqCiAqIFRvIHNlZSBhbmltYXRpb25zIGluIGFjdGlvbiwgYWxsIHRoYXQgaXMgcmVxdWlyZWQgaXMgdG8gZGVmaW5lIHRoZSBhcHByb3ByaWF0ZSBDU1MgY2xhc3NlcwogKiBvciB0byByZWdpc3RlciBhIEphdmFTY3JpcHQgYW5pbWF0aW9uIHZpYSB0aGUgbXlNb2R1bGUuYW5pbWF0aW9uKCkgZnVuY3Rpb24uIFRoZSBkaXJlY3RpdmVzIHRoYXQgc3VwcG9ydCBhbmltYXRpb24gYXV0b21hdGljYWxseSBhcmU6CiAqIGBuZ1JlcGVhdGAsIGBuZ0luY2x1ZGVgLCBgbmdJZmAsIGBuZ1N3aXRjaGAsIGBuZ1Nob3dgLCBgbmdIaWRlYCwgYG5nVmlld2AgYW5kIGBuZ0NsYXNzYC4gQ3VzdG9tIGRpcmVjdGl2ZXMgY2FuIHRha2UgYWR2YW50YWdlIG9mIGFuaW1hdGlvbgogKiBieSB1c2luZyB0aGUgYCRhbmltYXRlYCBzZXJ2aWNlLgogKgogKiBCZWxvdyBpcyBhIG1vcmUgZGV0YWlsZWQgYnJlYWtkb3duIG9mIHRoZSBzdXBwb3J0ZWQgYW5pbWF0aW9uIGV2ZW50cyBwcm92aWRlZCBieSBwcmUtZXhpc3RpbmcgbmcgZGlyZWN0aXZlczoKICoKICogfCBEaXJlY3RpdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBTdXBwb3J0ZWQgQW5pbWF0aW9ucyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQjdXNhZ2VfYW5pbWF0aW9ucyBuZ1JlcGVhdH0gICAgICAgICB8IGVudGVyLCBsZWF2ZSBhbmQgbW92ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmdSb3V0ZS5kaXJlY3RpdmU6bmdWaWV3I3VzYWdlX2FuaW1hdGlvbnMgbmdWaWV3fSAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUjdXNhZ2VfYW5pbWF0aW9ucyBuZ0luY2x1ZGV9ICAgICAgIHwgZW50ZXIgYW5kIGxlYXZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdTd2l0Y2gjdXNhZ2VfYW5pbWF0aW9ucyBuZ1N3aXRjaH0gICAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSWYjdXNhZ2VfYW5pbWF0aW9ucyBuZ0lmfSAgICAgICAgICAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzI3VzYWdlX2FuaW1hdGlvbnMgbmdDbGFzc30gICAgICAgICAgIHwgYWRkIGFuZCByZW1vdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdTaG93I3VzYWdlX2FuaW1hdGlvbnMgbmdTaG93ICYgbmdIaWRlfSAgICB8IGFkZCBhbmQgcmVtb3ZlICh0aGUgbmctaGlkZSBjbGFzcyB2YWx1ZSkgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0jdXNhZ2VfYW5pbWF0aW9ucyBmb3JtfSAgICAgICAgICAgICAgICAgfCBhZGQgYW5kIHJlbW92ZSAoZGlydHksIHByaXN0aW5lLCB2YWxpZCwgaW52YWxpZCAmIGFsbCBvdGhlciB2YWxpZGF0aW9ucykgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbCN1c2FnZV9hbmltYXRpb25zIG5nTW9kZWx9ICAgICAgICAgICB8IGFkZCBhbmQgcmVtb3ZlIChkaXJ0eSwgcHJpc3RpbmUsIHZhbGlkLCBpbnZhbGlkICYgYWxsIG90aGVyIHZhbGlkYXRpb25zKSAgICAgICAgICAgICAgICB8CiAqCiAqIFlvdSBjYW4gZmluZCBvdXQgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhbmltYXRpb25zIHVwb24gdmlzaXRpbmcgZWFjaCBkaXJlY3RpdmUgcGFnZS4KICoKICogQmVsb3cgaXMgYW4gZXhhbXBsZSBvZiBob3cgdG8gYXBwbHkgYW5pbWF0aW9ucyB0byBhIGRpcmVjdGl2ZSB0aGF0IHN1cHBvcnRzIGFuaW1hdGlvbiBob29rczoKICoKICogYGBgaHRtbAogKiA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogKiAuc2xpZGUubmctZW50ZXIsIC5zbGlkZS5uZy1sZWF2ZSB7CiAqICAgLXdlYmtpdC10cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogfQogKgogKiAuc2xpZGUubmctZW50ZXIgeyB9ICAgICAgICAvJiM0Mjsgc3RhcnRpbmcgYW5pbWF0aW9ucyBmb3IgZW50ZXIgJiM0MjsvCiAqIC5zbGlkZS5uZy1lbnRlci1hY3RpdmUgeyB9IC8mIzQyOyB0ZXJtaW5hbCBhbmltYXRpb25zIGZvciBlbnRlciAmIzQyOy8KICogLnNsaWRlLm5nLWxlYXZlIHsgfSAgICAgICAgLyYjNDI7IHN0YXJ0aW5nIGFuaW1hdGlvbnMgZm9yIGxlYXZlICYjNDI7LwogKiAuc2xpZGUubmctbGVhdmUtYWN0aXZlIHsgfSAvJiM0MjsgdGVybWluYWwgYW5pbWF0aW9ucyBmb3IgbGVhdmUgJiM0MjsvCiAqIDwvc3R5bGU+CiAqCiAqIDwhLS0KICogdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIC5uZy1lbnRlciBhbmQgLm5nLWxlYXZlIHRvIHRoZSBlbGVtZW50CiAqIHRvIHRyaWdnZXIgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbnMKICogLS0+CiAqIDxBTlkgY2xhc3M9InNsaWRlIiBuZy1pbmNsdWRlPSIuLi4iPjwvQU5ZPgogKiBgYGAKICoKICogS2VlcCBpbiBtaW5kIHRoYXQgaWYgYW4gYW5pbWF0aW9uIGlzIHJ1bm5pbmcsIGFueSBjaGlsZCBlbGVtZW50cyBjYW5ub3QgYmUgYW5pbWF0ZWQgdW50aWwgdGhlIHBhcmVudCBlbGVtZW50J3MKICogYW5pbWF0aW9uIGhhcyBjb21wbGV0ZWQuCiAqCiAqIDxoMj5DU1MtZGVmaW5lZCBBbmltYXRpb25zPC9oMj4KICogVGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYXBwbHkgdHdvIENTUyBjbGFzc2VzIHRvIHRoZSBhbmltYXRlZCBlbGVtZW50IGFuZCB0aGVzZSB0d28gQ1NTIGNsYXNzZXMKICogYXJlIGRlc2lnbmVkIHRvIGNvbnRhaW4gdGhlIHN0YXJ0IGFuZCBlbmQgQ1NTIHN0eWxpbmcuIEJvdGggQ1NTIHRyYW5zaXRpb25zIGFuZCBrZXlmcmFtZSBhbmltYXRpb25zIGFyZSBzdXBwb3J0ZWQKICogYW5kIGNhbiBiZSB1c2VkIHRvIHBsYXkgYWxvbmcgd2l0aCB0aGlzIG5hbWluZyBzdHJ1Y3R1cmUuCiAqCiAqIFRoZSBmb2xsb3dpbmcgY29kZSBiZWxvdyBkZW1vbnN0cmF0ZXMgaG93IHRvIHBlcmZvcm0gYW5pbWF0aW9ucyB1c2luZyAqKkNTUyB0cmFuc2l0aW9ucyoqIHdpdGggQW5ndWxhcjoKICoKICogYGBgaHRtbAogKiA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogKiAvJiM0MjsKICogIFRoZSBhbmltYXRlIGNsYXNzIGlzIGFwYXJ0IG9mIHRoZSBlbGVtZW50IGFuZCB0aGUgbmctZW50ZXIgY2xhc3MKICogIGlzIGF0dGFjaGVkIHRvIHRoZSBlbGVtZW50IG9uY2UgdGhlIGVudGVyIGFuaW1hdGlvbiBldmVudCBpcyB0cmlnZ2VyZWQKICogJiM0MjsvCiAqIC5yZXZlYWwtYW5pbWF0aW9uLm5nLWVudGVyIHsKICogIC13ZWJraXQtdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsgLyYjNDI7IFNhZmFyaS9DaHJvbWUgJiM0MjsvCiAqICB0cmFuc2l0aW9uOiAxcyBsaW5lYXIgYWxsOyAvJiM0MjsgQWxsIG90aGVyIG1vZGVybiBicm93c2VycyBhbmQgSUUxMCsgJiM0MjsvCiAqCiAqICAvJiM0MjsgVGhlIGFuaW1hdGlvbiBwcmVwYXJhdGlvbiBjb2RlICYjNDI7LwogKiAgb3BhY2l0eTogMDsKICogfQogKgogKiAvJiM0MjsKICogIEtlZXAgaW4gbWluZCB0aGF0IHlvdSB3YW50IHRvIGNvbWJpbmUgYm90aCBDU1MKICogIGNsYXNzZXMgdG9nZXRoZXIgdG8gYXZvaWQgYW55IENTUy1zcGVjaWZpY2l0eQogKiAgY29uZmxpY3RzCiAqICYjNDI7LwogKiAucmV2ZWFsLWFuaW1hdGlvbi5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogKiAgLyYjNDI7IFRoZSBhbmltYXRpb24gY29kZSBpdHNlbGYgJiM0MjsvCiAqICBvcGFjaXR5OiAxOwogKiB9CiAqIDwvc3R5bGU+CiAqCiAqIDxkaXYgY2xhc3M9InZpZXctY29udGFpbmVyIj4KICogICA8ZGl2IG5nLXZpZXcgY2xhc3M9InJldmVhbC1hbmltYXRpb24iPjwvZGl2PgogKiA8L2Rpdj4KICogYGBgCiAqCiAqIFRoZSBmb2xsb3dpbmcgY29kZSBiZWxvdyBkZW1vbnN0cmF0ZXMgaG93IHRvIHBlcmZvcm0gYW5pbWF0aW9ucyB1c2luZyAqKkNTUyBhbmltYXRpb25zKiogd2l0aCBBbmd1bGFyOgogKgogKiBgYGBodG1sCiAqIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAqIC5yZXZlYWwtYW5pbWF0aW9uLm5nLWVudGVyIHsKICogICAtd2Via2l0LWFuaW1hdGlvbjogZW50ZXJfc2VxdWVuY2UgMXMgbGluZWFyOyAvJiM0MjsgU2FmYXJpL0Nocm9tZSAmIzQyOy8KICogICBhbmltYXRpb246IGVudGVyX3NlcXVlbmNlIDFzIGxpbmVhcjsgLyYjNDI7IElFMTArIGFuZCBGdXR1cmUgQnJvd3NlcnMgJiM0MjsvCiAqIH0KICogQC13ZWJraXQta2V5ZnJhbWVzIGVudGVyX3NlcXVlbmNlIHsKICogICBmcm9tIHsgb3BhY2l0eTowOyB9CiAqICAgdG8geyBvcGFjaXR5OjE7IH0KICogfQogKiBAa2V5ZnJhbWVzIGVudGVyX3NlcXVlbmNlIHsKICogICBmcm9tIHsgb3BhY2l0eTowOyB9CiAqICAgdG8geyBvcGFjaXR5OjE7IH0KICogfQogKiA8L3N0eWxlPgogKgogKiA8ZGl2IGNsYXNzPSJ2aWV3LWNvbnRhaW5lciI+CiAqICAgPGRpdiBuZy12aWV3IGNsYXNzPSJyZXZlYWwtYW5pbWF0aW9uIj48L2Rpdj4KICogPC9kaXY+CiAqIGBgYAogKgogKiBCb3RoIENTUzMgYW5pbWF0aW9ucyBhbmQgdHJhbnNpdGlvbnMgY2FuIGJlIHVzZWQgdG9nZXRoZXIgYW5kIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBmaWd1cmUgb3V0IHRoZSBjb3JyZWN0IGR1cmF0aW9uIGFuZCBkZWxheSB0aW1pbmcuCiAqCiAqIFVwb24gRE9NIG11dGF0aW9uLCB0aGUgZXZlbnQgY2xhc3MgaXMgYWRkZWQgZmlyc3QgKHNvbWV0aGluZyBsaWtlIGBuZy1lbnRlcmApLCB0aGVuIHRoZSBicm93c2VyIHByZXBhcmVzIGl0c2VsZiB0byBhZGQKICogdGhlIGFjdGl2ZSBjbGFzcyAoaW4gdGhpcyBjYXNlIGBuZy1lbnRlci1hY3RpdmVgKSB3aGljaCB0aGVuIHRyaWdnZXJzIHRoZSBhbmltYXRpb24uIFRoZSBhbmltYXRpb24gbW9kdWxlIHdpbGwgYXV0b21hdGljYWxseQogKiBkZXRlY3QgdGhlIENTUyBjb2RlIHRvIGRldGVybWluZSB3aGVuIHRoZSBhbmltYXRpb24gZW5kcy4gT25jZSB0aGUgYW5pbWF0aW9uIGlzIG92ZXIgdGhlbiBib3RoIENTUyBjbGFzc2VzIHdpbGwgYmUKICogcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIGEgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IENTUyB0cmFuc2l0aW9ucyBvciBDU1MgYW5pbWF0aW9ucyB0aGVuIHRoZSBhbmltYXRpb24gd2lsbCBzdGFydCBhbmQgZW5kCiAqIGltbWVkaWF0ZWx5IHJlc3VsdGluZyBpbiBhIERPTSBlbGVtZW50IHRoYXQgaXMgYXQgaXRzIGZpbmFsIHN0YXRlLiBUaGlzIGZpbmFsIHN0YXRlIGlzIHdoZW4gdGhlIERPTSBlbGVtZW50CiAqIGhhcyBubyBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gY2xhc3NlcyBhcHBsaWVkIHRvIGl0LgogKgogKiA8aDM+Q1NTIFN0YWdnZXJpbmcgQW5pbWF0aW9uczwvaDM+CiAqIEEgU3RhZ2dlcmluZyBhbmltYXRpb24gaXMgYSBjb2xsZWN0aW9uIG9mIGFuaW1hdGlvbnMgdGhhdCBhcmUgaXNzdWVkIHdpdGggYSBzbGlnaHQgZGVsYXkgaW4gYmV0d2VlbiBlYWNoIHN1Y2Nlc3NpdmUgb3BlcmF0aW9uIHJlc3VsdGluZyBpbiBhCiAqIGN1cnRhaW4tbGlrZSBlZmZlY3QuIFRoZSBuZ0FuaW1hdGUgbW9kdWxlLCBhcyBvZiAxLjIuMCwgc3VwcG9ydHMgc3RhZ2dlcmluZyBhbmltYXRpb25zIGFuZCB0aGUgc3RhZ2dlciBlZmZlY3QgY2FuIGJlCiAqIHBlcmZvcm1lZCBieSBjcmVhdGluZyBhICoqbmctRVZFTlQtc3RhZ2dlcioqIENTUyBjbGFzcyBhbmQgYXR0YWNoaW5nIHRoYXQgY2xhc3MgdG8gdGhlIGJhc2UgQ1NTIGNsYXNzIHVzZWQgZm9yCiAqIHRoZSBhbmltYXRpb24uIFRoZSBzdHlsZSBwcm9wZXJ0eSBleHBlY3RlZCB3aXRoaW4gdGhlIHN0YWdnZXIgY2xhc3MgY2FuIGVpdGhlciBiZSBhICoqdHJhbnNpdGlvbi1kZWxheSoqIG9yIGFuCiAqICoqYW5pbWF0aW9uLWRlbGF5KiogcHJvcGVydHkgKG9yIGJvdGggaWYgeW91ciBhbmltYXRpb24gY29udGFpbnMgYm90aCB0cmFuc2l0aW9ucyBhbmQga2V5ZnJhbWUgYW5pbWF0aW9ucykuCiAqCiAqIGBgYGNzcwogKiAubXktYW5pbWF0aW9uLm5nLWVudGVyIHsKICogICAvJiM0Mjsgc3RhbmRhcmQgdHJhbnNpdGlvbiBjb2RlICYjNDI7LwogKiAgIC13ZWJraXQtdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsKICogICB0cmFuc2l0aW9uOiAxcyBsaW5lYXIgYWxsOwogKiAgIG9wYWNpdHk6MDsKICogfQogKiAubXktYW5pbWF0aW9uLm5nLWVudGVyLXN0YWdnZXIgewogKiAgIC8mIzQyOyB0aGlzIHdpbGwgaGF2ZSBhIDEwMG1zIGRlbGF5IGJldHdlZW4gZWFjaCBzdWNjZXNzaXZlIGxlYXZlIGFuaW1hdGlvbiAmIzQyOy8KICogICAtd2Via2l0LXRyYW5zaXRpb24tZGVsYXk6IDAuMXM7CiAqICAgdHJhbnNpdGlvbi1kZWxheTogMC4xczsKICoKICogICAvJiM0MjsgaW4gY2FzZSB0aGUgc3RhZ2dlciBkb2Vzbid0IHdvcmsgdGhlbiB0aGVzZSB0d28gdmFsdWVzCiAqICAgIG11c3QgYmUgc2V0IHRvIDAgdG8gYXZvaWQgYW4gYWNjaWRlbnRhbCBDU1MgaW5oZXJpdGFuY2UgJiM0MjsvCiAqICAgLXdlYmtpdC10cmFuc2l0aW9uLWR1cmF0aW9uOiAwczsKICogICB0cmFuc2l0aW9uLWR1cmF0aW9uOiAwczsKICogfQogKiAubXktYW5pbWF0aW9uLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAqICAgLyYjNDI7IHN0YW5kYXJkIHRyYW5zaXRpb24gc3R5bGVzICYjNDI7LwogKiAgIG9wYWNpdHk6MTsKICogfQogKiBgYGAKICoKICogU3RhZ2dlcmluZyBhbmltYXRpb25zIHdvcmsgYnkgZGVmYXVsdCBpbiBuZ1JlcGVhdCAoc28gbG9uZyBhcyB0aGUgQ1NTIGNsYXNzIGlzIGRlZmluZWQpLiBPdXRzaWRlIG9mIG5nUmVwZWF0LCB0byB1c2Ugc3RhZ2dlcmluZyBhbmltYXRpb25zCiAqIG9uIHlvdXIgb3duLCB0aGV5IGNhbiBiZSB0cmlnZ2VyZWQgYnkgZmlyaW5nIG11bHRpcGxlIGNhbGxzIHRvIHRoZSBzYW1lIGV2ZW50IG9uICRhbmltYXRlLiBIb3dldmVyLCB0aGUgcmVzdHJpY3Rpb25zIHN1cnJvdW5kaW5nIHRoaXMKICogYXJlIHRoYXQgZWFjaCBvZiB0aGUgZWxlbWVudHMgbXVzdCBoYXZlIHRoZSBzYW1lIENTUyBjbGFzc05hbWUgdmFsdWUgYXMgd2VsbCBhcyB0aGUgc2FtZSBwYXJlbnQgZWxlbWVudC4gQSBzdGFnZ2VyIG9wZXJhdGlvbgogKiB3aWxsIGFsc28gYmUgcmVzZXQgaWYgbW9yZSB0aGFuIDEwbXMgaGFzIHBhc3NlZCBhZnRlciB0aGUgbGFzdCBhbmltYXRpb24gaGFzIGJlZW4gZmlyZWQuCiAqCiAqIFRoZSBmb2xsb3dpbmcgY29kZSB3aWxsIGlzc3VlIHRoZSAqKm5nLWxlYXZlLXN0YWdnZXIqKiBldmVudCBvbiB0aGUgZWxlbWVudCBwcm92aWRlZDoKICoKICogYGBganMKICogdmFyIGtpZHMgPSBwYXJlbnQuY2hpbGRyZW4oKTsKICoKICogJGFuaW1hdGUubGVhdmUoa2lkc1swXSk7IC8vc3RhZ2dlciBpbmRleD0wCiAqICRhbmltYXRlLmxlYXZlKGtpZHNbMV0pOyAvL3N0YWdnZXIgaW5kZXg9MQogKiAkYW5pbWF0ZS5sZWF2ZShraWRzWzJdKTsgLy9zdGFnZ2VyIGluZGV4PTIKICogJGFuaW1hdGUubGVhdmUoa2lkc1szXSk7IC8vc3RhZ2dlciBpbmRleD0zCiAqICRhbmltYXRlLmxlYXZlKGtpZHNbNF0pOyAvL3N0YWdnZXIgaW5kZXg9NAogKgogKiAkdGltZW91dChmdW5jdGlvbigpIHsKICogICAvL3N0YWdnZXIgaGFzIHJlc2V0IGl0c2VsZgogKiAgICRhbmltYXRlLmxlYXZlKGtpZHNbNV0pOyAvL3N0YWdnZXIgaW5kZXg9MAogKiAgICRhbmltYXRlLmxlYXZlKGtpZHNbNl0pOyAvL3N0YWdnZXIgaW5kZXg9MQogKiB9LCAxMDAsIGZhbHNlKTsKICogYGBgCiAqCiAqIFN0YWdnZXIgYW5pbWF0aW9ucyBhcmUgY3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIHdpdGhpbiBDU1MtZGVmaW5lZCBhbmltYXRpb25zLgogKgogKiA8aDI+SmF2YVNjcmlwdC1kZWZpbmVkIEFuaW1hdGlvbnM8L2gyPgogKiBJbiB0aGUgZXZlbnQgdGhhdCB5b3UgZG8gbm90IHdhbnQgdG8gdXNlIENTUzMgdHJhbnNpdGlvbnMgb3IgQ1NTMyBhbmltYXRpb25zIG9yIGlmIHlvdSB3aXNoIHRvIG9mZmVyIGFuaW1hdGlvbnMgb24gYnJvd3NlcnMgdGhhdCBkbyBub3QKICogeWV0IHN1cHBvcnQgQ1NTIHRyYW5zaXRpb25zL2FuaW1hdGlvbnMsIHRoZW4geW91IGNhbiBtYWtlIHVzZSBvZiBKYXZhU2NyaXB0IGFuaW1hdGlvbnMgZGVmaW5lZCBpbnNpZGUgb2YgeW91ciBBbmd1bGFySlMgbW9kdWxlLgogKgogKiBgYGBqcwogKiAvLyFhbm5vdGF0ZT0iWW91ckFwcCIgWW91ciBBbmd1bGFySlMgTW9kdWxlfFJlcGxhY2UgdGhpcyBvciBuZ01vZHVsZSB3aXRoIHRoZSBtb2R1bGUgdGhhdCB5b3UgdXNlZCB0byBkZWZpbmUgeW91ciBhcHBsaWNhdGlvbi4KICogdmFyIG5nTW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ1lvdXJBcHAnLCBbJ25nQW5pbWF0ZSddKTsKICogbmdNb2R1bGUuYW5pbWF0aW9uKCcubXktY3JhenktYW5pbWF0aW9uJywgZnVuY3Rpb24oKSB7CiAqICAgcmV0dXJuIHsKICogICAgIGVudGVyOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAqICAgICAgIC8vcnVuIHRoZSBhbmltYXRpb24gaGVyZSBhbmQgY2FsbCBkb25lIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogKiAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAqICAgICAgICAgLy90aGlzIChvcHRpb25hbCkgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgYW5pbWF0aW9uCiAqICAgICAgICAgLy9jb21wbGV0ZXMgb3Igd2hlbiB0aGUgYW5pbWF0aW9uIGlzIGNhbmNlbGxlZCAodGhlIGNhbmNlbGxlZAogKiAgICAgICAgIC8vZmxhZyB3aWxsIGJlIHNldCB0byB0cnVlIGlmIGNhbmNlbGxlZCkuCiAqICAgICAgIH07CiAqICAgICB9LAogKiAgICAgbGVhdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsgfSwKICogICAgIG1vdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsgfSwKICoKICogICAgIC8vYW5pbWF0aW9uIHRoYXQgY2FuIGJlIHRyaWdnZXJlZCBiZWZvcmUgdGhlIGNsYXNzIGlzIGFkZGVkCiAqICAgICBiZWZvcmVBZGRDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGNsYXNzIGlzIGFkZGVkCiAqICAgICBhZGRDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYmVmb3JlIHRoZSBjbGFzcyBpcyByZW1vdmVkCiAqICAgICBiZWZvcmVSZW1vdmVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGNsYXNzIGlzIHJlbW92ZWQKICogICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmUpIHsgfQogKiAgIH07CiAqIH0pOwogKiBgYGAKICoKICogSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgYXJlIGNyZWF0ZWQgd2l0aCBhIENTUy1saWtlIGNsYXNzIHNlbGVjdG9yIGFuZCBhIGNvbGxlY3Rpb24gb2YgZXZlbnRzIHdoaWNoIGFyZSBzZXQgdG8gcnVuCiAqIGEgamF2YXNjcmlwdCBjYWxsYmFjayBmdW5jdGlvbi4gV2hlbiBhbiBhbmltYXRpb24gaXMgdHJpZ2dlcmVkLCAkYW5pbWF0ZSB3aWxsIGxvb2sgZm9yIGEgbWF0Y2hpbmcgYW5pbWF0aW9uIHdoaWNoIGZpdHMKICogdGhlIGVsZW1lbnQncyBDU1MgY2xhc3MgYXR0cmlidXRlIHZhbHVlIGFuZCB0aGVuIHJ1biB0aGUgbWF0Y2hpbmcgYW5pbWF0aW9uIGV2ZW50IGZ1bmN0aW9uIChpZiBmb3VuZCkuCiAqIEluIG90aGVyIHdvcmRzLCBpZiB0aGUgQ1NTIGNsYXNzZXMgcHJlc2VudCBvbiB0aGUgYW5pbWF0ZWQgZWxlbWVudCBtYXRjaCBhbnkgb2YgdGhlIEphdmFTY3JpcHQgYW5pbWF0aW9ucyB0aGVuIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsCiAqIGJlIGV4ZWN1dGVkLiBJdCBzaG91bGQgYmUgYWxzbyBub3RlZCB0aGF0IG9ubHkgc2ltcGxlLCBzaW5nbGUgY2xhc3Mgc2VsZWN0b3JzIGFyZSBhbGxvd2VkIChjb21wb3VuZCBjbGFzcyBzZWxlY3RvcnMgYXJlIG5vdCBzdXBwb3J0ZWQpLgogKgogKiBXaXRoaW4gYSBKYXZhU2NyaXB0IGFuaW1hdGlvbiwgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdmFyaW91cyBldmVudCBjYWxsYmFjayBhbmltYXRpb24gZnVuY3Rpb25zIGlzIGV4cGVjdGVkIHRvIGJlIHJldHVybmVkLgogKiBBcyBleHBsYWluZWQgYWJvdmUsIHRoZXNlIGNhbGxiYWNrcyBhcmUgdHJpZ2dlcmVkIGJhc2VkIG9uIHRoZSBhbmltYXRpb24gZXZlbnQuIFRoZXJlZm9yZSBpZiBhbiBlbnRlciBhbmltYXRpb24gaXMgcnVuLAogKiBhbmQgdGhlIEphdmFTY3JpcHQgYW5pbWF0aW9uIGlzIGZvdW5kLCB0aGVuIHRoZSBlbnRlciBjYWxsYmFjayB3aWxsIGhhbmRsZSB0aGF0IGFuaW1hdGlvbiAoaW4gYWRkaXRpb24gdG8gdGhlIENTUyBrZXlmcmFtZSBhbmltYXRpb24KICogb3IgdHJhbnNpdGlvbiBjb2RlIHRoYXQgaXMgZGVmaW5lZCB2aWEgYSBzdHlsZXNoZWV0KS4KICoKICovCgphbmd1bGFyLm1vZHVsZSgnbmdBbmltYXRlJywgWyduZyddKQoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBUaGUgYCRhbmltYXRlUHJvdmlkZXJgIGFsbG93cyBkZXZlbG9wZXJzIHRvIHJlZ2lzdGVyIEphdmFTY3JpcHQgYW5pbWF0aW9uIGV2ZW50IGhhbmRsZXJzIGRpcmVjdGx5IGluc2lkZSBvZiBhIG1vZHVsZS4KICAgKiBXaGVuIGFuIGFuaW1hdGlvbiBpcyB0cmlnZ2VyZWQsIHRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgcXVlcnkgdGhlICRhbmltYXRlIHNlcnZpY2UgdG8gZmluZCBhbnkgYW5pbWF0aW9ucyB0aGF0IG1hdGNoCiAgICogdGhlIHByb3ZpZGVkIG5hbWUgdmFsdWUuCiAgICoKICAgKiBSZXF1aXJlcyB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIHRvIGJlIGluc3RhbGxlZC4KICAgKgogICAqIFBsZWFzZSB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIG92ZXJ2aWV3IHBhZ2UgbGVhcm4gbW9yZSBhYm91dCBob3cgdG8gdXNlIGFuaW1hdGlvbnMgaW4geW91ciBhcHBsaWNhdGlvbi4KICAgKgogICAqLwoKICAvL3RoaXMgcHJpdmF0ZSBzZXJ2aWNlIGlzIG9ubHkgdXNlZCB3aXRoaW4gQ1NTLWVuYWJsZWQgYW5pbWF0aW9ucwogIC8vSUU4ICsgSUU5IGRvIG5vdCBzdXBwb3J0IHJBRiBuYXRpdmVseSwgYnV0IHRoYXQgaXMgZmluZSBzaW5jZSB0aGV5CiAgLy9hbHNvIGRvbid0IHN1cHBvcnQgdHJhbnNpdGlvbnMgYW5kIGtleWZyYW1lcyB3aGljaCBtZWFucyB0aGF0IHRoZSBjb2RlCiAgLy9iZWxvdyB3aWxsIG5ldmVyIGJlIHVzZWQgYnkgdGhlIHR3byBicm93c2Vycy4KICAuZmFjdG9yeSgnJCRhbmltYXRlUmVmbG93JywgWyckJHJBRicsICckZG9jdW1lbnQnLCBmdW5jdGlvbigkJHJBRiwgJGRvY3VtZW50KSB7CiAgICB2YXIgYm9kID0gJGRvY3VtZW50WzBdLmJvZHk7CiAgICByZXR1cm4gZnVuY3Rpb24oZm4pIHsKICAgICAgLy90aGUgcmV0dXJuZWQgZnVuY3Rpb24gYWN0cyBhcyB0aGUgY2FuY2VsbGF0aW9uIGZ1bmN0aW9uCiAgICAgIHJldHVybiAkJHJBRihmdW5jdGlvbigpIHsKICAgICAgICAvL3RoZSBsaW5lIGJlbG93IHdpbGwgZm9yY2UgdGhlIGJyb3dzZXIgdG8gcGVyZm9ybSBhIHJlcGFpbnQKICAgICAgICAvL3NvIHRoYXQgYWxsIHRoZSBhbmltYXRlZCBlbGVtZW50cyB3aXRoaW4gdGhlIGFuaW1hdGlvbiBmcmFtZQogICAgICAgIC8vd2lsbCBiZSBwcm9wZXJseSB1cGRhdGVkIGFuZCBkcmF3biBvbiBzY3JlZW4uIFRoaXMgaXMKICAgICAgICAvL3JlcXVpcmVkIHRvIHBlcmZvcm0gbXVsdGktY2xhc3MgQ1NTIGJhc2VkIGFuaW1hdGlvbnMgd2l0aAogICAgICAgIC8vRmlyZWZveC4gRE8gTk9UIFJFTU9WRSBUSElTIExJTkUuCiAgICAgICAgdmFyIGEgPSBib2Qub2Zmc2V0V2lkdGggKyAxOwogICAgICAgIGZuKCk7CiAgICAgIH0pOwogICAgfTsKICB9XSkKCiAgLmNvbmZpZyhbJyRwcm92aWRlJywgJyRhbmltYXRlUHJvdmlkZXInLCBmdW5jdGlvbigkcHJvdmlkZSwgJGFuaW1hdGVQcm92aWRlcikgewogICAgdmFyIG5vb3AgPSBhbmd1bGFyLm5vb3A7CiAgICB2YXIgZm9yRWFjaCA9IGFuZ3VsYXIuZm9yRWFjaDsKICAgIHZhciBzZWxlY3RvcnMgPSAkYW5pbWF0ZVByb3ZpZGVyLiQkc2VsZWN0b3JzOwoKICAgIHZhciBFTEVNRU5UX05PREUgPSAxOwogICAgdmFyIE5HX0FOSU1BVEVfU1RBVEUgPSAnJCRuZ0FuaW1hdGVTdGF0ZSc7CiAgICB2YXIgTkdfQU5JTUFURV9DTEFTU19OQU1FID0gJ25nLWFuaW1hdGUnOwogICAgdmFyIHJvb3RBbmltYXRlU3RhdGUgPSB7cnVubmluZzogdHJ1ZX07CgogICAgZnVuY3Rpb24gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpIHsKICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGVsZW1lbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgZWxtID0gZWxlbWVudFtpXTsKICAgICAgICBpZihlbG0ubm9kZVR5cGUgPT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICByZXR1cm4gZWxtOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHByZXBhcmVFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQgJiYgYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KSB7CiAgICAgIHJldHVybiBhbmd1bGFyLmVsZW1lbnQoZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc01hdGNoaW5nRWxlbWVudChlbG0xLCBlbG0yKSB7CiAgICAgIHJldHVybiBleHRyYWN0RWxlbWVudE5vZGUoZWxtMSkgPT0gZXh0cmFjdEVsZW1lbnROb2RlKGVsbTIpOwogICAgfQoKICAgICRwcm92aWRlLmRlY29yYXRvcignJGFuaW1hdGUnLCBbJyRkZWxlZ2F0ZScsICckaW5qZWN0b3InLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywgJyQkYXN5bmNDYWxsYmFjaycsICckcm9vdFNjb3BlJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigkZGVsZWdhdGUsICAgJGluamVjdG9yLCAgICRzbmlmZmVyLCAgICRyb290RWxlbWVudCwgICAkJGFzeW5jQ2FsbGJhY2ssICAgICRyb290U2NvcGUsICAgJGRvY3VtZW50KSB7CgogICAgICB2YXIgZ2xvYmFsQW5pbWF0aW9uQ291bnRlciA9IDA7CiAgICAgICRyb290RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIHJvb3RBbmltYXRlU3RhdGUpOwoKICAgICAgLy8gZGlzYWJsZSBhbmltYXRpb25zIGR1cmluZyBib290c3RyYXAsIGJ1dCBvbmNlIHdlIGJvb3RzdHJhcHBlZCwgd2FpdCBhZ2FpbgogICAgICAvLyBmb3IgYW5vdGhlciBkaWdlc3QgdW50aWwgZW5hYmxpbmcgYW5pbWF0aW9ucy4gVGhlIHJlYXNvbiB3aHkgd2UgZGlnZXN0IHR3aWNlCiAgICAgIC8vIGlzIGJlY2F1c2UgYWxsIHN0cnVjdHVyYWwgYW5pbWF0aW9ucyAoZW50ZXIsIGxlYXZlIGFuZCBtb3ZlKSBhbGwgcGVyZm9ybSBhCiAgICAgIC8vIHBvc3QgZGlnZXN0IG9wZXJhdGlvbiBiZWZvcmUgYW5pbWF0aW5nLiBJZiB3ZSBvbmx5IHdhaXQgZm9yIGEgc2luZ2xlIGRpZ2VzdAogICAgICAvLyB0byBwYXNzIHRoZW4gdGhlIHN0cnVjdHVyYWwgYW5pbWF0aW9uIHdvdWxkIHJlbmRlciBpdHMgYW5pbWF0aW9uIG9uIHBhZ2UgbG9hZC4KICAgICAgLy8gKHdoaWNoIGlzIHdoYXQgd2UncmUgdHJ5aW5nIHRvIGF2b2lkIHdoZW4gdGhlIGFwcGxpY2F0aW9uIGZpcnN0IGJvb3RzIHVwLikKICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLnJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICB2YXIgY2xhc3NOYW1lRmlsdGVyID0gJGFuaW1hdGVQcm92aWRlci5jbGFzc05hbWVGaWx0ZXIoKTsKICAgICAgdmFyIGlzQW5pbWF0YWJsZUNsYXNzTmFtZSA9ICFjbGFzc05hbWVGaWx0ZXIKICAgICAgICAgICAgICA/IGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgICAgICAgIDogZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2xhc3NOYW1lRmlsdGVyLnRlc3QoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9OwoKICAgICAgZnVuY3Rpb24gbG9va3VwKG5hbWUpIHsKICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXSwKICAgICAgICAgICAgICBmbGFnTWFwID0ge30sCiAgICAgICAgICAgICAgY2xhc3NlcyA9IG5hbWUuc3Vic3RyKDEpLnNwbGl0KCcuJyk7CgogICAgICAgICAgLy90aGUgZW1wdHkgc3RyaW5nIHZhbHVlIGlzIHRoZSBkZWZhdWx0IGFuaW1hdGlvbgogICAgICAgICAgLy9vcGVyYXRpb24gd2hpY2ggcGVyZm9ybXMgQ1NTIHRyYW5zaXRpb24gYW5kIGtleWZyYW1lCiAgICAgICAgICAvL2FuaW1hdGlvbnMgc25pZmZpbmcuIFRoaXMgaXMgYWx3YXlzIGluY2x1ZGVkIGZvciBlYWNoCiAgICAgICAgICAvL2VsZW1lbnQgYW5pbWF0aW9uIHByb2NlZHVyZSBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cwogICAgICAgICAgLy90cmFuc2l0aW9ucyBhbmQvb3Iga2V5ZnJhbWUgYW5pbWF0aW9ucy4gVGhlIGRlZmF1bHQKICAgICAgICAgIC8vYW5pbWF0aW9uIGlzIGFkZGVkIHRvIHRoZSB0b3Agb2YgdGhlIGxpc3QgdG8gcHJldmVudAogICAgICAgICAgLy9hbnkgcHJldmlvdXMgYW5pbWF0aW9ucyBmcm9tIGFmZmVjdGluZyB0aGUgZWxlbWVudCBzdHlsaW5nCiAgICAgICAgICAvL3ByaW9yIHRvIHRoZSBlbGVtZW50IGJlaW5nIGFuaW1hdGVkLgogICAgICAgICAgaWYgKCRzbmlmZmVyLnRyYW5zaXRpb25zIHx8ICRzbmlmZmVyLmFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKCRpbmplY3Rvci5nZXQoc2VsZWN0b3JzWycnXSkpOwogICAgICAgICAgfQoKICAgICAgICAgIGZvcih2YXIgaT0wOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIga2xhc3MgPSBjbGFzc2VzW2ldLAogICAgICAgICAgICAgICAgc2VsZWN0b3JGYWN0b3J5TmFtZSA9IHNlbGVjdG9yc1trbGFzc107CiAgICAgICAgICAgIGlmKHNlbGVjdG9yRmFjdG9yeU5hbWUgJiYgIWZsYWdNYXBba2xhc3NdKSB7CiAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKCRpbmplY3Rvci5nZXQoc2VsZWN0b3JGYWN0b3J5TmFtZSkpOwogICAgICAgICAgICAgIGZsYWdNYXBba2xhc3NdID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRpb25SdW5uZXIoZWxlbWVudCwgYW5pbWF0aW9uRXZlbnQsIGNsYXNzTmFtZSkgewogICAgICAgIC8vdHJhbnNjbHVkZWQgZGlyZWN0aXZlcyBtYXkgc29tZXRpbWVzIGZpcmUgYW4gYW5pbWF0aW9uIHVzaW5nIG9ubHkgY29tbWVudCBub2RlcwogICAgICAgIC8vYmVzdCB0byBjYXRjaCB0aGlzIGVhcmx5IG9uIHRvIHByZXZlbnQgYW55IGFuaW1hdGlvbiBvcGVyYXRpb25zIGZyb20gb2NjdXJyaW5nCiAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50WzBdOwogICAgICAgIGlmKCFub2RlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaXNTZXRDbGFzc09wZXJhdGlvbiA9IGFuaW1hdGlvbkV2ZW50ID09ICdzZXRDbGFzcyc7CiAgICAgICAgdmFyIGlzQ2xhc3NCYXNlZCA9IGlzU2V0Q2xhc3NPcGVyYXRpb24gfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uRXZlbnQgPT0gJ2FkZENsYXNzJyB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRpb25FdmVudCA9PSAncmVtb3ZlQ2xhc3MnOwoKICAgICAgICB2YXIgY2xhc3NOYW1lQWRkLCBjbGFzc05hbWVSZW1vdmU7CiAgICAgICAgaWYoYW5ndWxhci5pc0FycmF5KGNsYXNzTmFtZSkpIHsKICAgICAgICAgIGNsYXNzTmFtZUFkZCA9IGNsYXNzTmFtZVswXTsKICAgICAgICAgIGNsYXNzTmFtZVJlbW92ZSA9IGNsYXNzTmFtZVsxXTsKICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZUFkZCArICcgJyArIGNsYXNzTmFtZVJlbW92ZTsKICAgICAgICB9CgogICAgICAgIHZhciBjdXJyZW50Q2xhc3NOYW1lID0gZWxlbWVudC5hdHRyKCdjbGFzcycpOwogICAgICAgIHZhciBjbGFzc2VzID0gY3VycmVudENsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZTsKICAgICAgICBpZighaXNBbmltYXRhYmxlQ2xhc3NOYW1lKGNsYXNzZXMpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgYmVmb3JlQ29tcGxldGUgPSBub29wLAogICAgICAgICAgICBiZWZvcmVDYW5jZWwgPSBbXSwKICAgICAgICAgICAgYmVmb3JlID0gW10sCiAgICAgICAgICAgIGFmdGVyQ29tcGxldGUgPSBub29wLAogICAgICAgICAgICBhZnRlckNhbmNlbCA9IFtdLAogICAgICAgICAgICBhZnRlciA9IFtdOwoKICAgICAgICB2YXIgYW5pbWF0aW9uTG9va3VwID0gKCcgJyArIGNsYXNzZXMpLnJlcGxhY2UoL1xzKy9nLCcuJyk7CiAgICAgICAgZm9yRWFjaChsb29rdXAoYW5pbWF0aW9uTG9va3VwKSwgZnVuY3Rpb24oYW5pbWF0aW9uRmFjdG9yeSkgewogICAgICAgICAgdmFyIGNyZWF0ZWQgPSByZWdpc3RlckFuaW1hdGlvbihhbmltYXRpb25GYWN0b3J5LCBhbmltYXRpb25FdmVudCk7CiAgICAgICAgICBpZighY3JlYXRlZCAmJiBpc1NldENsYXNzT3BlcmF0aW9uKSB7CiAgICAgICAgICAgIHJlZ2lzdGVyQW5pbWF0aW9uKGFuaW1hdGlvbkZhY3RvcnksICdhZGRDbGFzcycpOwogICAgICAgICAgICByZWdpc3RlckFuaW1hdGlvbihhbmltYXRpb25GYWN0b3J5LCAncmVtb3ZlQ2xhc3MnKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgZXZlbnQpIHsKICAgICAgICAgIHZhciBhZnRlckZuID0gYW5pbWF0aW9uRmFjdG9yeVtldmVudF07CiAgICAgICAgICB2YXIgYmVmb3JlRm4gPSBhbmltYXRpb25GYWN0b3J5WydiZWZvcmUnICsgZXZlbnQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBldmVudC5zdWJzdHIoMSldOwogICAgICAgICAgaWYoYWZ0ZXJGbiB8fCBiZWZvcmVGbikgewogICAgICAgICAgICBpZihldmVudCA9PSAnbGVhdmUnKSB7CiAgICAgICAgICAgICAgYmVmb3JlRm4gPSBhZnRlckZuOwogICAgICAgICAgICAgIC8vd2hlbiBzZXQgYXMgbnVsbCB0aGVuIGFuaW1hdGlvbiBrbm93cyB0byBza2lwIHRoaXMgcGhhc2UKICAgICAgICAgICAgICBhZnRlckZuID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBhZnRlci5wdXNoKHsKICAgICAgICAgICAgICBldmVudCA6IGV2ZW50LCBmbiA6IGFmdGVyRm4KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGJlZm9yZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCA6IGV2ZW50LCBmbiA6IGJlZm9yZUZuCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJ1bihmbnMsIGNhbmNlbGxhdGlvbnMsIGFsbENvbXBsZXRlRm4pIHsKICAgICAgICAgIHZhciBhbmltYXRpb25zID0gW107CiAgICAgICAgICBmb3JFYWNoKGZucywgZnVuY3Rpb24oYW5pbWF0aW9uKSB7CiAgICAgICAgICAgIGFuaW1hdGlvbi5mbiAmJiBhbmltYXRpb25zLnB1c2goYW5pbWF0aW9uKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICBmdW5jdGlvbiBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKGluZGV4KSB7CiAgICAgICAgICAgIGlmKGNhbmNlbGxhdGlvbnMpIHsKICAgICAgICAgICAgICAoY2FuY2VsbGF0aW9uc1tpbmRleF0gfHwgbm9vcCkoKTsKICAgICAgICAgICAgICBpZigrK2NvdW50IDwgYW5pbWF0aW9ucy5sZW5ndGgpIHJldHVybjsKICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBhbGxDb21wbGV0ZUZuKCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy9UaGUgY29kZSBiZWxvdyBhZGRzIGRpcmVjdGx5IHRvIHRoZSBhcnJheSBpbiBvcmRlciB0byB3b3JrIHdpdGgKICAgICAgICAgIC8vYm90aCBzeW5jIGFuZCBhc3luYyBhbmltYXRpb25zLiBTeW5jIGFuaW1hdGlvbnMgYXJlIHdoZW4gdGhlIGRvbmUoKQogICAgICAgICAgLy9vcGVyYXRpb24gaXMgY2FsbGVkIHJpZ2h0IGF3YXkuIERPIE5PVCBSRUZBQ1RPUiEKICAgICAgICAgIGZvckVhY2goYW5pbWF0aW9ucywgZnVuY3Rpb24oYW5pbWF0aW9uLCBpbmRleCkgewogICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKGluZGV4KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc3dpdGNoKGFuaW1hdGlvbi5ldmVudCkgewogICAgICAgICAgICAgIGNhc2UgJ3NldENsYXNzJzoKICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMucHVzaChhbmltYXRpb24uZm4oZWxlbWVudCwgY2xhc3NOYW1lQWRkLCBjbGFzc05hbWVSZW1vdmUsIHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdhZGRDbGFzcyc6CiAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIGNsYXNzTmFtZUFkZCB8fCBjbGFzc05hbWUsICAgICBwcm9ncmVzcykpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAncmVtb3ZlQ2xhc3MnOgogICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucy5wdXNoKGFuaW1hdGlvbi5mbihlbGVtZW50LCBjbGFzc05hbWVSZW1vdmUgfHwgY2xhc3NOYW1lLCAgcHJvZ3Jlc3MpKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgaWYoY2FuY2VsbGF0aW9ucyAmJiBjYW5jZWxsYXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBhbGxDb21wbGV0ZUZuKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgbm9kZSA6IG5vZGUsCiAgICAgICAgICBldmVudCA6IGFuaW1hdGlvbkV2ZW50LAogICAgICAgICAgY2xhc3NOYW1lIDogY2xhc3NOYW1lLAogICAgICAgICAgaXNDbGFzc0Jhc2VkIDogaXNDbGFzc0Jhc2VkLAogICAgICAgICAgaXNTZXRDbGFzc09wZXJhdGlvbiA6IGlzU2V0Q2xhc3NPcGVyYXRpb24sCiAgICAgICAgICBiZWZvcmUgOiBmdW5jdGlvbihhbGxDb21wbGV0ZUZuKSB7CiAgICAgICAgICAgIGJlZm9yZUNvbXBsZXRlID0gYWxsQ29tcGxldGVGbjsKICAgICAgICAgICAgcnVuKGJlZm9yZSwgYmVmb3JlQ2FuY2VsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBiZWZvcmVDb21wbGV0ZSA9IG5vb3A7CiAgICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBhZnRlciA6IGZ1bmN0aW9uKGFsbENvbXBsZXRlRm4pIHsKICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSA9IGFsbENvbXBsZXRlRm47CiAgICAgICAgICAgIHJ1bihhZnRlciwgYWZ0ZXJDYW5jZWwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGFmdGVyQ29tcGxldGUgPSBub29wOwogICAgICAgICAgICAgIGFsbENvbXBsZXRlRm4oKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgY2FuY2VsIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKGJlZm9yZUNhbmNlbCkgewogICAgICAgICAgICAgIGZvckVhY2goYmVmb3JlQ2FuY2VsLCBmdW5jdGlvbihjYW5jZWxGbikgewogICAgICAgICAgICAgICAgKGNhbmNlbEZuIHx8IG5vb3ApKHRydWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGJlZm9yZUNvbXBsZXRlKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGFmdGVyQ2FuY2VsKSB7CiAgICAgICAgICAgICAgZm9yRWFjaChhZnRlckNhbmNlbCwgZnVuY3Rpb24oY2FuY2VsRm4pIHsKICAgICAgICAgICAgICAgIChjYW5jZWxGbiB8fCBub29wKSh0cnVlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBhZnRlckNvbXBsZXRlKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICAqIEBuYW1lICRhbmltYXRlCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBUaGUgYCRhbmltYXRlYCBzZXJ2aWNlIHByb3ZpZGVzIGFuaW1hdGlvbiBkZXRlY3Rpb24gc3VwcG9ydCB3aGlsZSBwZXJmb3JtaW5nIERPTSBvcGVyYXRpb25zIChlbnRlciwgbGVhdmUgYW5kIG1vdmUpIGFzIHdlbGwgYXMgZHVyaW5nIGFkZENsYXNzIGFuZCByZW1vdmVDbGFzcyBvcGVyYXRpb25zLgogICAgICAgKiBXaGVuIGFueSBvZiB0aGVzZSBvcGVyYXRpb25zIGFyZSBydW4sIHRoZSAkYW5pbWF0ZSBzZXJ2aWNlCiAgICAgICAqIHdpbGwgZXhhbWluZSBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgKHdoaWNoIGFyZSBkZWZpbmVkIGJ5IHVzaW5nIHRoZSAkYW5pbWF0ZVByb3ZpZGVyIHByb3ZpZGVyIG9iamVjdCkKICAgICAgICogYXMgd2VsbCBhcyBhbnkgQ1NTLWRlZmluZWQgYW5pbWF0aW9ucyBhZ2FpbnN0IHRoZSBDU1MgY2xhc3NlcyBwcmVzZW50IG9uIHRoZSBlbGVtZW50IG9uY2UgdGhlIERPTSBvcGVyYXRpb24gaXMgcnVuLgogICAgICAgKgogICAgICAgKiBUaGUgYCRhbmltYXRlYCBzZXJ2aWNlIGlzIHVzZWQgYmVoaW5kIHRoZSBzY2VuZXMgd2l0aCBwcmUtZXhpc3RpbmcgZGlyZWN0aXZlcyBhbmQgYW5pbWF0aW9uIHdpdGggdGhlc2UgZGlyZWN0aXZlcwogICAgICAgKiB3aWxsIHdvcmsgb3V0IG9mIHRoZSBib3ggd2l0aG91dCBhbnkgZXh0cmEgY29uZmlndXJhdGlvbi4KICAgICAgICoKICAgICAgICogUmVxdWlyZXMgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSB0byBiZSBpbnN0YWxsZWQuCiAgICAgICAqCiAgICAgICAqIFBsZWFzZSB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIG92ZXJ2aWV3IHBhZ2UgbGVhcm4gbW9yZSBhYm91dCBob3cgdG8gdXNlIGFuaW1hdGlvbnMgaW4geW91ciBhcHBsaWNhdGlvbi4KICAgICAgICoKICAgICAgICovCiAgICAgIHJldHVybiB7CiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2VudGVyCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFwcGVuZHMgdGhlIGVsZW1lbnQgdG8gdGhlIHBhcmVudEVsZW1lbnQgZWxlbWVudCB0aGF0IHJlc2lkZXMgaW4gdGhlIGRvY3VtZW50IGFuZCB0aGVuIHJ1bnMgdGhlIGVudGVyIGFuaW1hdGlvbi4gT25jZQogICAgICAgICAqIHRoZSBhbmltYXRpb24gaXMgc3RhcnRlZCwgdGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyB3aWxsIGJlIHByZXNlbnQgb24gdGhlIGVsZW1lbnQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyBlbnRlciBhbmltYXRpb246CiAgICAgICAgICoKICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSB8CiAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAqIHwgMS4gJGFuaW1hdGUuZW50ZXIoLi4uKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDIuIGVsZW1lbnQgaXMgaW5zZXJ0ZWQgaW50byB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IG9yIGJlc2lkZSB0aGUgYWZ0ZXJFbGVtZW50IGVsZW1lbnQgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAzLiAkYW5pbWF0ZSBydW5zIGFueSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNC4gdGhlIC5uZy1lbnRlciBjbGFzcyBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIiICAgIHwKICAgICAgICAgKiB8IDUuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIiAgICB8CiAgICAgICAgICogfCA2LiAkYW5pbWF0ZSB3YWl0cyBmb3IgMTBtcyAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1lbnRlciIgICAgfAogICAgICAgICAqIHwgNy4gdGhlIC5uZy1lbnRlci1hY3RpdmUgYW5kIC5uZy1hbmltYXRlLWFjdGl2ZSBjbGFzc2VzIGFyZSBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1lbnRlciBuZy1lbnRlci1hY3RpdmUiIHwKICAgICAgICAgKiB8IDguICRhbmltYXRlIHdhaXRzIGZvciBYIG1pbGxpc2Vjb25kcyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIG5nLWVudGVyIG5nLWVudGVyLWFjdGl2ZSIgfAogICAgICAgICAqIHwgOS4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDEwLiBUaGUgZG9uZUNhbGxiYWNrKCkgY2FsbGJhY2sgaXMgZmlyZWQgKGlmIHByb3ZpZGVkKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgZW50ZXIgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnRFbGVtZW50IHRoZSBwYXJlbnQgZWxlbWVudCBvZiB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBlbnRlciBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGFmdGVyRWxlbWVudCB0aGUgc2libGluZyBlbGVtZW50ICh3aGljaCBpcyB0aGUgcHJldmlvdXMgZWxlbWVudCkgb2YgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgZW50ZXIgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICovCiAgICAgICAgZW50ZXIgOiBmdW5jdGlvbihlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIHBhcmVudEVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChwYXJlbnRFbGVtZW50KTsKICAgICAgICAgIGFmdGVyRWxlbWVudCA9IHByZXBhcmVFbGVtZW50KGFmdGVyRWxlbWVudCk7CgogICAgICAgICAgdGhpcy5lbmFibGVkKGZhbHNlLCBlbGVtZW50KTsKICAgICAgICAgICRkZWxlZ2F0ZS5lbnRlcihlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQpOwogICAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ2VudGVyJywgJ25nLWVudGVyJywgZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBub29wLCBkb25lQ2FsbGJhY2spOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2xlYXZlCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJ1bnMgdGhlIGxlYXZlIGFuaW1hdGlvbiBvcGVyYXRpb24gYW5kLCB1cG9uIGNvbXBsZXRpb24sIHJlbW92ZXMgdGhlIGVsZW1lbnQgZnJvbSB0aGUgRE9NLiBPbmNlCiAgICAgICAgICogdGhlIGFuaW1hdGlvbiBpcyBzdGFydGVkLCB0aGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIHdpbGwgYmUgYWRkZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyBsZWF2ZSBhbmltYXRpb246CiAgICAgICAgICoKICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSB8CiAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAqIHwgMS4gJGFuaW1hdGUubGVhdmUoLi4uKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDIuICRhbmltYXRlIHJ1bnMgYW55IEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICB8CiAgICAgICAgICogfCAzLiB0aGUgLm5nLWxlYXZlIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1sZWF2ZSIgICAgfAogICAgICAgICAqIHwgNC4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbGVhdmUiICAgIHwKICAgICAgICAgKiB8IDUuICRhbmltYXRlIHdhaXRzIGZvciAxMG1zICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZlIiAgICB8CiAgICAgICAgICogfCA2LiB0aGUgLm5nLWxlYXZlLWFjdGl2ZSBhbmQgLm5nLWFuaW1hdGUtYWN0aXZlIGNsYXNzZXMgaXMgYWRkZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgbmctbGVhdmUgbmctbGVhdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSB3YWl0cyBmb3IgWCBtaWxsaXNlY29uZHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1sZWF2ZSBuZy1sZWF2ZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDguIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA5LiBUaGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IC4uLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMTAuIFRoZSBkb25lQ2FsbGJhY2soKSBjYWxsYmFjayBpcyBmaXJlZCAoaWYgcHJvdmlkZWQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCAuLi4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBsZWF2ZSBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBkb25lQ2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgKi8KICAgICAgICBsZWF2ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIGNhbmNlbENoaWxkQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgIHRoaXMuZW5hYmxlZChmYWxzZSwgZWxlbWVudCk7CiAgICAgICAgICAkcm9vdFNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcGVyZm9ybUFuaW1hdGlvbignbGVhdmUnLCAnbmctbGVhdmUnLCBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCksIG51bGwsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRkZWxlZ2F0ZS5sZWF2ZShlbGVtZW50KTsKICAgICAgICAgICAgfSwgZG9uZUNhbGxiYWNrKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNtb3ZlCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEZpcmVzIHRoZSBtb3ZlIERPTSBvcGVyYXRpb24uIEp1c3QgYmVmb3JlIHRoZSBhbmltYXRpb24gc3RhcnRzLCB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgZWl0aGVyIGFwcGVuZCBpdCBpbnRvIHRoZSBwYXJlbnRFbGVtZW50IGNvbnRhaW5lciBvcgogICAgICAgICAqIGFkZCB0aGUgZWxlbWVudCBkaXJlY3RseSBhZnRlciB0aGUgYWZ0ZXJFbGVtZW50IGVsZW1lbnQgaWYgcHJlc2VudC4gVGhlbiB0aGUgbW92ZSBhbmltYXRpb24gd2lsbCBiZSBydW4uIE9uY2UKICAgICAgICAgKiB0aGUgYW5pbWF0aW9uIGlzIHN0YXJ0ZWQsIHRoZSBmb2xsb3dpbmcgQ1NTIGNsYXNzZXMgd2lsbCBiZSBhZGRlZCBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb246CiAgICAgICAgICoKICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIG1vdmUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgKiB8IDEuICRhbmltYXRlLm1vdmUoLi4uKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAyLiBlbGVtZW50IGlzIG1vdmVkIGludG8gdGhlIHBhcmVudEVsZW1lbnQgZWxlbWVudCBvciBiZXNpZGUgdGhlIGFmdGVyRWxlbWVudCBlbGVtZW50ICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gJGFuaW1hdGUgcnVucyBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDQuIHRoZSAubmctbW92ZSBjbGFzcyBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmUiICAgICB8CiAgICAgICAgICogfCA1LiAkYW5pbWF0ZSBzY2FucyB0aGUgZWxlbWVudCBzdHlsZXMgdG8gZ2V0IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gZHVyYXRpb24gYW5kIGRlbGF5ICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1tb3ZlIiAgICAgfAogICAgICAgICAqIHwgNi4gJGFuaW1hdGUgd2FpdHMgZm9yIDEwbXMgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbW92ZSIgICAgIHwKICAgICAgICAgKiB8IDcuIHRoZSAubmctbW92ZS1hY3RpdmUgYW5kIC5uZy1hbmltYXRlLWFjdGl2ZSBjbGFzc2VzIGlzIGFkZGVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIG5nLW1vdmUgbmctbW92ZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDguICRhbmltYXRlIHdhaXRzIGZvciBYIG1pbGxpc2Vjb25kcyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIG5nLW1vdmUgbmctbW92ZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDkuIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMC4gVGhlIGRvbmVDYWxsYmFjaygpIGNhbGxiYWNrIGlzIGZpcmVkIChpZiBwcm92aWRlZCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIG1vdmUgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnRFbGVtZW50IHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgb2YgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgbW92ZSBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGFmdGVyRWxlbWVudCB0aGUgc2libGluZyBlbGVtZW50ICh3aGljaCBpcyB0aGUgcHJldmlvdXMgZWxlbWVudCkgb2YgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgbW92ZSBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBkb25lQ2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgKi8KICAgICAgICBtb3ZlIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBkb25lQ2FsbGJhY2spIHsKICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBwYXJlbnRFbGVtZW50ID0gcHJlcGFyZUVsZW1lbnQocGFyZW50RWxlbWVudCk7CiAgICAgICAgICBhZnRlckVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChhZnRlckVsZW1lbnQpOwoKICAgICAgICAgIGNhbmNlbENoaWxkQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgIHRoaXMuZW5hYmxlZChmYWxzZSwgZWxlbWVudCk7CiAgICAgICAgICAkZGVsZWdhdGUubW92ZShlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQpOwogICAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ21vdmUnLCAnbmctbW92ZScsIGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCwgbm9vcCwgZG9uZUNhbGxiYWNrKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNhZGRDbGFzcwogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVHJpZ2dlcnMgYSBjdXN0b20gYW5pbWF0aW9uIGV2ZW50IGJhc2VkIG9mZiB0aGUgY2xhc3NOYW1lIHZhcmlhYmxlIGFuZCB0aGVuIGF0dGFjaGVzIHRoZSBjbGFzc05hbWUgdmFsdWUgdG8gdGhlIGVsZW1lbnQgYXMgYSBDU1MgY2xhc3MuCiAgICAgICAgICogVW5saWtlIHRoZSBvdGhlciBhbmltYXRpb24gbWV0aG9kcywgdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIHN1ZmZpeCB0aGUgY2xhc3NOYW1lIHZhbHVlIHdpdGgge0B0eXBlIC1hZGR9IGluIG9yZGVyIHRvIHByb3ZpZGUKICAgICAgICAgKiB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHRoZSBzZXR1cCBhbmQgYWN0aXZlIENTUyBjbGFzc2VzIGluIG9yZGVyIHRvIHRyaWdnZXIgdGhlIGFuaW1hdGlvbiAodGhpcyB3aWxsIGJlIHNraXBwZWQgaWYgbm8gQ1NTIHRyYW5zaXRpb25zCiAgICAgICAgICogb3Iga2V5ZnJhbWVzIGFyZSBkZWZpbmVkIG9uIHRoZSAtYWRkIG9yIGJhc2UgQ1NTIGNsYXNzKS4KICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgYWRkQ2xhc3MgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSB8CiAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCAnc3VwZXInKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAyLiAkYW5pbWF0ZSBydW5zIGFueSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICB8CiAgICAgICAgICogfCAzLiB0aGUgLnN1cGVyLWFkZCBjbGFzcyBhcmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLWFkZCIgICB8CiAgICAgICAgICogfCA0LiAkYW5pbWF0ZSBzY2FucyB0aGUgZWxlbWVudCBzdHlsZXMgdG8gZ2V0IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gZHVyYXRpb24gYW5kIGRlbGF5ICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLWFkZCIgICB8CiAgICAgICAgICogfCA1LiAkYW5pbWF0ZSB3YWl0cyBmb3IgMTBtcyAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLWFkZCIgICB8CiAgICAgICAgICogfCA2LiB0aGUgLnN1cGVyLCAuc3VwZXItYWRkLWFjdGl2ZSBhbmQgLm5nLWFuaW1hdGUtYWN0aXZlIGNsYXNzZXMgYXJlIGFkZGVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIHN1cGVyIHN1cGVyLWFkZCBzdXBlci1hZGQtYWN0aXZlIiAgICAgICAgICB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSB3YWl0cyBmb3IgWCBtaWxsaXNlY29uZHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBzdXBlci1hZGQgc3VwZXItYWRkLWFjdGl2ZSIgIHwKICAgICAgICAgKiB8IDguIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDkuIFRoZSBzdXBlciBjbGFzcyBpcyBrZXB0IG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDEwLiBUaGUgZG9uZUNhbGxiYWNrKCkgY2FsbGJhY2sgaXMgZmlyZWQgKGlmIHByb3ZpZGVkKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgYW5pbWF0ZWQKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3MgdGhhdCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50IGFuZCB0aGVuIGFuaW1hdGVkCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICovCiAgICAgICAgYWRkQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIGVsZW1lbnQgPSBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdhZGRDbGFzcycsIGNsYXNzTmFtZSwgZWxlbWVudCwgbnVsbCwgbnVsbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRkZWxlZ2F0ZS5hZGRDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgfSwgZG9uZUNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjcmVtb3ZlQ2xhc3MKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRyaWdnZXJzIGEgY3VzdG9tIGFuaW1hdGlvbiBldmVudCBiYXNlZCBvZmYgdGhlIGNsYXNzTmFtZSB2YXJpYWJsZSBhbmQgdGhlbiByZW1vdmVzIHRoZSBDU1MgY2xhc3MgcHJvdmlkZWQgYnkgdGhlIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgICAqIGZyb20gdGhlIGVsZW1lbnQuIFVubGlrZSB0aGUgb3RoZXIgYW5pbWF0aW9uIG1ldGhvZHMsIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBzdWZmaXggdGhlIGNsYXNzTmFtZSB2YWx1ZSB3aXRoIHtAdHlwZSAtcmVtb3ZlfSBpbgogICAgICAgICAqIG9yZGVyIHRvIHByb3ZpZGUgdGhlIGFuaW1hdGUgc2VydmljZSB0aGUgc2V0dXAgYW5kIGFjdGl2ZSBDU1MgY2xhc3NlcyBpbiBvcmRlciB0byB0cmlnZ2VyIHRoZSBhbmltYXRpb24gKHRoaXMgd2lsbCBiZSBza2lwcGVkIGlmCiAgICAgICAgICogbm8gQ1NTIHRyYW5zaXRpb25zIG9yIGtleWZyYW1lcyBhcmUgZGVmaW5lZCBvbiB0aGUgLXJlbW92ZSBvciBiYXNlIENTUyBjbGFzc2VzKS4KICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgcmVtb3ZlQ2xhc3MgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlICAgICB8CiAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgKiB8IDEuICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsICdzdXBlcicpIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIiICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gJGFuaW1hdGUgcnVucyBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIiAgICAgICB8CiAgICAgICAgICogfCAzLiB0aGUgLnN1cGVyLXJlbW92ZSBjbGFzcyBhcmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIG5nLWFuaW1hdGUgc3VwZXItcmVtb3ZlInwKICAgICAgICAgKiB8IDQuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUiICAgfAogICAgICAgICAqIHwgNS4gJGFuaW1hdGUgd2FpdHMgZm9yIDEwbXMgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSIgICB8CiAgICAgICAgICogfCA2LiB0aGUgLnN1cGVyLXJlbW92ZS1hY3RpdmUgYW5kIC5uZy1hbmltYXRlLWFjdGl2ZSBjbGFzc2VzIGFyZSBhZGRlZCBhbmQgLnN1cGVyIGlzIHJlbW92ZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgc3VwZXItcmVtb3ZlIHN1cGVyLXJlbW92ZS1hY3RpdmUiICAgICAgICAgIHwKICAgICAgICAgKiB8IDcuICRhbmltYXRlIHdhaXRzIGZvciBYIG1pbGxpc2Vjb25kcyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBzdXBlci1yZW1vdmUgc3VwZXItcmVtb3ZlLWFjdGl2ZSIgICB8CiAgICAgICAgICogfCA4LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDkuIFRoZSBkb25lQ2FsbGJhY2soKSBjYWxsYmFjayBpcyBmaXJlZCAoaWYgcHJvdmlkZWQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIGFuaW1hdGVkCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHRoYXQgd2lsbCBiZSBhbmltYXRlZCBhbmQgdGhlbiByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBkb25lQ2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgKi8KICAgICAgICByZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZUNhbGxiYWNrKSB7CiAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgZWxlbWVudCA9IHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ3JlbW92ZUNsYXNzJywgY2xhc3NOYW1lLCBlbGVtZW50LCBudWxsLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJGRlbGVnYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICB9LCBkb25lQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKgogICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNzZXRDbGFzcwogICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gQWRkcyBhbmQvb3IgcmVtb3ZlcyB0aGUgZ2l2ZW4gQ1NTIGNsYXNzZXMgdG8gYW5kIGZyb20gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgKiBPbmNlIGNvbXBsZXRlLCB0aGUgZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGl0cyBDU1MgY2xhc3NlcyBjaGFuZ2VkCiAgICAgICAgICAgKiAgIHJlbW92ZWQgZnJvbSBpdAogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGFkZCB0aGUgQ1NTIGNsYXNzZXMgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHJlbW92ZSB0aGUgQ1NTIGNsYXNzIHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIHByb3ZpZGVkKSB0aGF0IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgdGhlCiAgICAgICAgICAgKiAgIENTUyBjbGFzc2VzIGhhdmUgYmVlbiBzZXQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAqLwogICAgICAgIHNldENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIGVsZW1lbnQgPSBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdzZXRDbGFzcycsIFthZGQsIHJlbW92ZV0sIGVsZW1lbnQsIG51bGwsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkZGVsZWdhdGUuc2V0Q2xhc3MoZWxlbWVudCwgYWRkLCByZW1vdmUpOwogICAgICAgICAgfSwgZG9uZUNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjZW5hYmxlZAogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBJZiBwcm92aWRlZCB0aGVuIHNldCB0aGUgYW5pbWF0aW9uIG9uIG9yIG9mZi4KICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgSWYgcHJvdmlkZWQgdGhlbiB0aGUgZWxlbWVudCB3aWxsIGJlIHVzZWQgdG8gcmVwcmVzZW50IHRoZSBlbmFibGUvZGlzYWJsZSBvcGVyYXRpb24KICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBDdXJyZW50IGFuaW1hdGlvbiBzdGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEdsb2JhbGx5IGVuYWJsZXMvZGlzYWJsZXMgYW5pbWF0aW9ucy4KICAgICAgICAgKgogICAgICAgICovCiAgICAgICAgZW5hYmxlZCA6IGZ1bmN0aW9uKHZhbHVlLCBlbGVtZW50KSB7CiAgICAgICAgICBzd2l0Y2goYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgaWYodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgICAgICAgICAgZGF0YS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSwgZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLmRpc2FibGVkID0gIXZhbHVlOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdmFsdWUgPSAhcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gISF2YWx1ZTsKICAgICAgICAgfQogICAgICB9OwoKICAgICAgLyoKICAgICAgICBhbGwgYW5pbWF0aW9ucyBjYWxsIHRoaXMgc2hhcmVkIGFuaW1hdGlvbiB0cmlnZ2VyaW5nIGZ1bmN0aW9uIGludGVybmFsbHkuCiAgICAgICAgVGhlIGFuaW1hdGlvbkV2ZW50IHZhcmlhYmxlIHJlZmVycyB0byB0aGUgSmF2YVNjcmlwdCBhbmltYXRpb24gZXZlbnQgdGhhdCB3aWxsIGJlIHRyaWdnZXJlZAogICAgICAgIGFuZCB0aGUgY2xhc3NOYW1lIHZhbHVlIGlzIHRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24gdGhhdCB3aWxsIGJlIGFwcGxpZWQgd2l0aGluIHRoZQogICAgICAgIENTUyBjb2RlLiBFbGVtZW50LCBwYXJlbnRFbGVtZW50IGFuZCBhZnRlckVsZW1lbnQgYXJlIHByb3ZpZGVkIERPTSBlbGVtZW50cyBmb3IgdGhlIGFuaW1hdGlvbgogICAgICAgIGFuZCB0aGUgb25Db21wbGV0ZSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBmdWxseSBjb21wbGV0ZS4KICAgICAgKi8KICAgICAgZnVuY3Rpb24gcGVyZm9ybUFuaW1hdGlvbihhbmltYXRpb25FdmVudCwgY2xhc3NOYW1lLCBlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIGRvbU9wZXJhdGlvbiwgZG9uZUNhbGxiYWNrKSB7CgogICAgICAgIHZhciBydW5uZXIgPSBhbmltYXRpb25SdW5uZXIoZWxlbWVudCwgYW5pbWF0aW9uRXZlbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgaWYoIXJ1bm5lcikgewogICAgICAgICAgZmlyZURPTU9wZXJhdGlvbigpOwogICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGNsb3NlQW5pbWF0aW9uKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjbGFzc05hbWUgPSBydW5uZXIuY2xhc3NOYW1lOwogICAgICAgIHZhciBlbGVtZW50RXZlbnRzID0gYW5ndWxhci5lbGVtZW50Ll9kYXRhKHJ1bm5lci5ub2RlKTsKICAgICAgICBlbGVtZW50RXZlbnRzID0gZWxlbWVudEV2ZW50cyAmJiBlbGVtZW50RXZlbnRzLmV2ZW50czsKCiAgICAgICAgaWYgKCFwYXJlbnRFbGVtZW50KSB7CiAgICAgICAgICBwYXJlbnRFbGVtZW50ID0gYWZ0ZXJFbGVtZW50ID8gYWZ0ZXJFbGVtZW50LnBhcmVudCgpIDogZWxlbWVudC5wYXJlbnQoKTsKICAgICAgICB9CgogICAgICAgIHZhciBuZ0FuaW1hdGVTdGF0ZSAgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CiAgICAgICAgdmFyIHJ1bm5pbmdBbmltYXRpb25zICAgICA9IG5nQW5pbWF0ZVN0YXRlLmFjdGl2ZSB8fCB7fTsKICAgICAgICB2YXIgdG90YWxBY3RpdmVBbmltYXRpb25zID0gbmdBbmltYXRlU3RhdGUudG90YWxBY3RpdmUgfHwgMDsKICAgICAgICB2YXIgbGFzdEFuaW1hdGlvbiAgICAgICAgID0gbmdBbmltYXRlU3RhdGUubGFzdDsKCiAgICAgICAgLy9vbmx5IGFsbG93IGFuaW1hdGlvbnMgaWYgdGhlIGN1cnJlbnRseSBydW5uaW5nIGFuaW1hdGlvbiBpcyBub3Qgc3RydWN0dXJhbAogICAgICAgIC8vb3IgaWYgdGhlcmUgaXMgbm8gYW5pbWF0aW9uIHJ1bm5pbmcgYXQgYWxsCiAgICAgICAgdmFyIHNraXBBbmltYXRpb25zID0gcnVubmVyLmlzQ2xhc3NCYXNlZCA/CiAgICAgICAgICBuZ0FuaW1hdGVTdGF0ZS5kaXNhYmxlZCB8fCAobGFzdEFuaW1hdGlvbiAmJiAhbGFzdEFuaW1hdGlvbi5pc0NsYXNzQmFzZWQpIDoKICAgICAgICAgIGZhbHNlOwoKICAgICAgICAvL3NraXAgdGhlIGFuaW1hdGlvbiBpZiBhbmltYXRpb25zIGFyZSBkaXNhYmxlZCwgYSBwYXJlbnQgaXMgYWxyZWFkeSBiZWluZyBhbmltYXRlZCwKICAgICAgICAvL3RoZSBlbGVtZW50IGlzIG5vdCBjdXJyZW50bHkgYXR0YWNoZWQgdG8gdGhlIGRvY3VtZW50IGJvZHkgb3IgdGhlbiBjb21wbGV0ZWx5IGNsb3NlCiAgICAgICAgLy90aGUgYW5pbWF0aW9uIGlmIGFueSBtYXRjaGluZyBhbmltYXRpb25zIGFyZSBub3QgZm91bmQgYXQgYWxsLgogICAgICAgIC8vTk9URTogSUU4ICsgSUU5IHNob3VsZCBjbG9zZSBwcm9wZXJseSAocnVuIGNsb3NlQW5pbWF0aW9uKCkpIGluIGNhc2UgYW4gYW5pbWF0aW9uIHdhcyBmb3VuZC4KICAgICAgICBpZiAoc2tpcEFuaW1hdGlvbnMgfHwgYW5pbWF0aW9uc0Rpc2FibGVkKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQpKSB7CiAgICAgICAgICBmaXJlRE9NT3BlcmF0aW9uKCk7CiAgICAgICAgICBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgZmlyZUFmdGVyQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgY2xvc2VBbmltYXRpb24oKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBza2lwQW5pbWF0aW9uID0gZmFsc2U7CiAgICAgICAgaWYodG90YWxBY3RpdmVBbmltYXRpb25zID4gMCkgewogICAgICAgICAgdmFyIGFuaW1hdGlvbnNUb0NhbmNlbCA9IFtdOwogICAgICAgICAgaWYoIXJ1bm5lci5pc0NsYXNzQmFzZWQpIHsKICAgICAgICAgICAgaWYoYW5pbWF0aW9uRXZlbnQgPT0gJ2xlYXZlJyAmJiBydW5uaW5nQW5pbWF0aW9uc1snbmctbGVhdmUnXSkgewogICAgICAgICAgICAgIHNraXBBbmltYXRpb24gPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vY2FuY2VsIGFsbCBhbmltYXRpb25zIHdoZW4gYSBzdHJ1Y3R1cmFsIGFuaW1hdGlvbiB0YWtlcyBwbGFjZQogICAgICAgICAgICAgIGZvcih2YXIga2xhc3MgaW4gcnVubmluZ0FuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnNUb0NhbmNlbC5wdXNoKHJ1bm5pbmdBbmltYXRpb25zW2tsYXNzXSk7CiAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIGtsYXNzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcnVubmluZ0FuaW1hdGlvbnMgPSB7fTsKICAgICAgICAgICAgICB0b3RhbEFjdGl2ZUFuaW1hdGlvbnMgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYobGFzdEFuaW1hdGlvbi5ldmVudCA9PSAnc2V0Q2xhc3MnKSB7CiAgICAgICAgICAgIGFuaW1hdGlvbnNUb0NhbmNlbC5wdXNoKGxhc3RBbmltYXRpb24pOwogICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmKHJ1bm5pbmdBbmltYXRpb25zW2NsYXNzTmFtZV0pIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBydW5uaW5nQW5pbWF0aW9uc1tjbGFzc05hbWVdOwogICAgICAgICAgICBpZihjdXJyZW50LmV2ZW50ID09IGFuaW1hdGlvbkV2ZW50KSB7CiAgICAgICAgICAgICAgc2tpcEFuaW1hdGlvbiA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYW5pbWF0aW9uc1RvQ2FuY2VsLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYoYW5pbWF0aW9uc1RvQ2FuY2VsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgZm9yRWFjaChhbmltYXRpb25zVG9DYW5jZWwsIGZ1bmN0aW9uKG9wZXJhdGlvbikgewogICAgICAgICAgICAgIG9wZXJhdGlvbi5jYW5jZWwoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihydW5uZXIuaXNDbGFzc0Jhc2VkICYmICFydW5uZXIuaXNTZXRDbGFzc09wZXJhdGlvbiAmJiAhc2tpcEFuaW1hdGlvbikgewogICAgICAgICAgc2tpcEFuaW1hdGlvbiA9IChhbmltYXRpb25FdmVudCA9PSAnYWRkQ2xhc3MnKSA9PSBlbGVtZW50Lmhhc0NsYXNzKGNsYXNzTmFtZSk7IC8vb3Bwb3NpdGUgb2YgWE9SCiAgICAgICAgfQoKICAgICAgICBpZihza2lwQW5pbWF0aW9uKSB7CiAgICAgICAgICBmaXJlRE9NT3BlcmF0aW9uKCk7CiAgICAgICAgICBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgZmlyZUFmdGVyQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgZmlyZURvbmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZihhbmltYXRpb25FdmVudCA9PSAnbGVhdmUnKSB7CiAgICAgICAgICAvL3RoZXJlJ3Mgbm8gbmVlZCB0byBldmVyIHJlbW92ZSB0aGUgbGlzdGVuZXIgc2luY2UgdGhlIGVsZW1lbnQKICAgICAgICAgIC8vd2lsbCBiZSByZW1vdmVkIChkZXN0cm95ZWQpIGFmdGVyIHRoZSBsZWF2ZSBhbmltYXRpb24gZW5kcyBvcgogICAgICAgICAgLy9pcyBjYW5jZWxsZWQgbWlkd2F5CiAgICAgICAgICBlbGVtZW50Lm9uZSgnJGRlc3Ryb3knLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KHRoaXMpOwogICAgICAgICAgICB2YXIgc3RhdGUgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgIGlmKHN0YXRlKSB7CiAgICAgICAgICAgICAgdmFyIGFjdGl2ZUxlYXZlQW5pbWF0aW9uID0gc3RhdGUuYWN0aXZlWyduZy1sZWF2ZSddOwogICAgICAgICAgICAgIGlmKGFjdGl2ZUxlYXZlQW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVMZWF2ZUFuaW1hdGlvbi5jYW5jZWwoKTsKICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgJ25nLWxlYXZlJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vdGhlIG5nLWFuaW1hdGUgY2xhc3MgZG9lcyBub3RoaW5nLCBidXQgaXQncyBoZXJlIHRvIGFsbG93IGZvcgogICAgICAgIC8vcGFyZW50IGFuaW1hdGlvbnMgdG8gZmluZCBhbmQgY2FuY2VsIGNoaWxkIGFuaW1hdGlvbnMgd2hlbiBuZWVkZWQKICAgICAgICBlbGVtZW50LmFkZENsYXNzKE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSk7CgogICAgICAgIHZhciBsb2NhbEFuaW1hdGlvbkNvdW50ID0gZ2xvYmFsQW5pbWF0aW9uQ291bnRlcisrOwogICAgICAgIHRvdGFsQWN0aXZlQW5pbWF0aW9ucysrOwogICAgICAgIHJ1bm5pbmdBbmltYXRpb25zW2NsYXNzTmFtZV0gPSBydW5uZXI7CgogICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCB7CiAgICAgICAgICBsYXN0IDogcnVubmVyLAogICAgICAgICAgYWN0aXZlIDogcnVubmluZ0FuaW1hdGlvbnMsCiAgICAgICAgICBpbmRleCA6IGxvY2FsQW5pbWF0aW9uQ291bnQsCiAgICAgICAgICB0b3RhbEFjdGl2ZSA6IHRvdGFsQWN0aXZlQW5pbWF0aW9ucwogICAgICAgIH0pOwoKICAgICAgICAvL2ZpcnN0IHdlIHJ1biB0aGUgYmVmb3JlIGFuaW1hdGlvbnMgYW5kIHdoZW4gYWxsIG9mIHRob3NlIGFyZSBjb21wbGV0ZQogICAgICAgIC8vdGhlbiB3ZSBwZXJmb3JtIHRoZSBET00gb3BlcmF0aW9uIGFuZCBydW4gdGhlIG5leHQgc2V0IG9mIGFuaW1hdGlvbnMKICAgICAgICBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpOwogICAgICAgIHJ1bm5lci5iZWZvcmUoZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgIGNhbmNlbGxlZCA9IGNhbmNlbGxlZCB8fAogICAgICAgICAgICAgICAgICAgICAgICAhZGF0YSB8fCAhZGF0YS5hY3RpdmVbY2xhc3NOYW1lXSB8fAogICAgICAgICAgICAgICAgICAgICAgICAocnVubmVyLmlzQ2xhc3NCYXNlZCAmJiBkYXRhLmFjdGl2ZVtjbGFzc05hbWVdLmV2ZW50ICE9IGFuaW1hdGlvbkV2ZW50KTsKCiAgICAgICAgICBmaXJlRE9NT3BlcmF0aW9uKCk7CiAgICAgICAgICBpZihjYW5jZWxsZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgY2xvc2VBbmltYXRpb24oKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgcnVubmVyLmFmdGVyKGNsb3NlQW5pbWF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgZnVuY3Rpb24gZmlyZURPTUNhbGxiYWNrKGFuaW1hdGlvblBoYXNlKSB7CiAgICAgICAgICB2YXIgZXZlbnROYW1lID0gJyRhbmltYXRlOicgKyBhbmltYXRpb25QaGFzZTsKICAgICAgICAgIGlmKGVsZW1lbnRFdmVudHMgJiYgZWxlbWVudEV2ZW50c1tldmVudE5hbWVdICYmIGVsZW1lbnRFdmVudHNbZXZlbnROYW1lXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICQkYXN5bmNDYWxsYmFjayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKGV2ZW50TmFtZSwgewogICAgICAgICAgICAgICAgZXZlbnQgOiBhbmltYXRpb25FdmVudCwKICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA6IGNsYXNzTmFtZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCkgewogICAgICAgICAgZmlyZURPTUNhbGxiYWNrKCdiZWZvcmUnKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKSB7CiAgICAgICAgICBmaXJlRE9NQ2FsbGJhY2soJ2FmdGVyJyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaXJlRG9uZUNhbGxiYWNrQXN5bmMoKSB7CiAgICAgICAgICBmaXJlRE9NQ2FsbGJhY2soJ2Nsb3NlJyk7CiAgICAgICAgICBpZihkb25lQ2FsbGJhY2spIHsKICAgICAgICAgICAgJCRhc3luY0NhbGxiYWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGRvbmVDYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vaXQgaXMgbGVzcyBjb21wbGljYXRlZCB0byB1c2UgYSBmbGFnIHRoYW4gbWFuYWdpbmcgYW5kIGNhbmNlbGluZwogICAgICAgIC8vdGltZW91dHMgY29udGFpbmluZyBtdWx0aXBsZSBjYWxsYmFja3MuCiAgICAgICAgZnVuY3Rpb24gZmlyZURPTU9wZXJhdGlvbigpIHsKICAgICAgICAgIGlmKCFmaXJlRE9NT3BlcmF0aW9uLmhhc0JlZW5SdW4pIHsKICAgICAgICAgICAgZmlyZURPTU9wZXJhdGlvbi5oYXNCZWVuUnVuID0gdHJ1ZTsKICAgICAgICAgICAgZG9tT3BlcmF0aW9uKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjbG9zZUFuaW1hdGlvbigpIHsKICAgICAgICAgIGlmKCFjbG9zZUFuaW1hdGlvbi5oYXNCZWVuUnVuKSB7CiAgICAgICAgICAgIGNsb3NlQW5pbWF0aW9uLmhhc0JlZW5SdW4gPSB0cnVlOwogICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgICAgIC8qIG9ubHkgc3RydWN0dXJhbCBhbmltYXRpb25zIHdhaXQgZm9yIHJlZmxvdyBiZWZvcmUgcmVtb3ZpbmcgYW4KICAgICAgICAgICAgICAgICBhbmltYXRpb24sIGJ1dCBjbGFzcy1iYXNlZCBhbmltYXRpb25zIGRvbid0LiBBbiBleGFtcGxlIG9mIHRoaXMKICAgICAgICAgICAgICAgICBmYWlsaW5nIHdvdWxkIGJlIHdoZW4gYSBwYXJlbnQgSFRNTCB0YWcgaGFzIGEgbmctY2xhc3MgYXR0cmlidXRlCiAgICAgICAgICAgICAgICAgY2F1c2luZyBBTEwgZGlyZWN0aXZlcyBiZWxvdyB0byBza2lwIGFuaW1hdGlvbnMgZHVyaW5nIHRoZSBkaWdlc3QgKi8KICAgICAgICAgICAgICBpZihydW5uZXIgJiYgcnVubmVyLmlzQ2xhc3NCYXNlZCkgewogICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkJGFzeW5jQ2FsbGJhY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgICAgICAgICAgICBpZihsb2NhbEFuaW1hdGlvbkNvdW50ID09IGRhdGEuaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uRXZlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCBkYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmlyZURvbmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBjYW5jZWxDaGlsZEFuaW1hdGlvbnMoZWxlbWVudCkgewogICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICB2YXIgbm9kZXMgPSBhbmd1bGFyLmlzRnVuY3Rpb24obm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKSA/CiAgICAgICAgICAgIG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShOR19BTklNQVRFX0NMQVNTX05BTUUpIDoKICAgICAgICAgICAgbm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSk7CiAgICAgICAgICBmb3JFYWNoKG5vZGVzLCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgICBpZihkYXRhICYmIGRhdGEuYWN0aXZlKSB7CiAgICAgICAgICAgICAgZm9yRWFjaChkYXRhLmFjdGl2ZSwgZnVuY3Rpb24ocnVubmVyKSB7CiAgICAgICAgICAgICAgICBydW5uZXIuY2FuY2VsKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICBpZihpc01hdGNoaW5nRWxlbWVudChlbGVtZW50LCAkcm9vdEVsZW1lbnQpKSB7CiAgICAgICAgICBpZighcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZCkgewogICAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLnJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5zdHJ1Y3R1cmFsID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmKGNsYXNzTmFtZSkgewogICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CgogICAgICAgICAgdmFyIHJlbW92ZUFuaW1hdGlvbnMgPSBjbGFzc05hbWUgPT09IHRydWU7CiAgICAgICAgICBpZighcmVtb3ZlQW5pbWF0aW9ucyAmJiBkYXRhLmFjdGl2ZSAmJiBkYXRhLmFjdGl2ZVtjbGFzc05hbWVdKSB7CiAgICAgICAgICAgIGRhdGEudG90YWxBY3RpdmUtLTsKICAgICAgICAgICAgZGVsZXRlIGRhdGEuYWN0aXZlW2NsYXNzTmFtZV07CiAgICAgICAgICB9CgogICAgICAgICAgaWYocmVtb3ZlQW5pbWF0aW9ucyB8fCAhZGF0YS50b3RhbEFjdGl2ZSkgewogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGlvbnNEaXNhYmxlZChlbGVtZW50LCBwYXJlbnRFbGVtZW50KSB7CiAgICAgICAgaWYgKHJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQpIHJldHVybiB0cnVlOwoKICAgICAgICBpZihpc01hdGNoaW5nRWxlbWVudChlbGVtZW50LCAkcm9vdEVsZW1lbnQpKSB7CiAgICAgICAgICByZXR1cm4gcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZCB8fCByb290QW5pbWF0ZVN0YXRlLnJ1bm5pbmc7CiAgICAgICAgfQoKICAgICAgICBkbyB7CiAgICAgICAgICAvL3RoZSBlbGVtZW50IGRpZCBub3QgcmVhY2ggdGhlIHJvb3QgZWxlbWVudCB3aGljaCBtZWFucyB0aGF0IGl0CiAgICAgICAgICAvL2lzIG5vdCBhcGFydCBvZiB0aGUgRE9NLiBUaGVyZWZvcmUgdGhlcmUgaXMgbm8gcmVhc29uIHRvIGRvCiAgICAgICAgICAvL2FueSBhbmltYXRpb25zIG9uIGl0CiAgICAgICAgICBpZihwYXJlbnRFbGVtZW50Lmxlbmd0aCA9PT0gMCkgYnJlYWs7CgogICAgICAgICAgdmFyIGlzUm9vdCA9IGlzTWF0Y2hpbmdFbGVtZW50KHBhcmVudEVsZW1lbnQsICRyb290RWxlbWVudCk7CiAgICAgICAgICB2YXIgc3RhdGUgPSBpc1Jvb3QgPyByb290QW5pbWF0ZVN0YXRlIDogcGFyZW50RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgdmFyIHJlc3VsdCA9IHN0YXRlICYmICghIXN0YXRlLmRpc2FibGVkIHx8IHN0YXRlLnJ1bm5pbmcgfHwgc3RhdGUudG90YWxBY3RpdmUgPiAwKTsKICAgICAgICAgIGlmKGlzUm9vdCB8fCByZXN1bHQpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZihpc1Jvb3QpIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICB3aGlsZShwYXJlbnRFbGVtZW50ID0gcGFyZW50RWxlbWVudC5wYXJlbnQoKSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9XSk7CgogICAgJGFuaW1hdGVQcm92aWRlci5yZWdpc3RlcignJywgWyckd2luZG93JywgJyRzbmlmZmVyJywgJyR0aW1lb3V0JywgJyQkYW5pbWF0ZVJlZmxvdycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCR3aW5kb3csICAgJHNuaWZmZXIsICAgJHRpbWVvdXQsICAgJCRhbmltYXRlUmVmbG93KSB7CiAgICAgIC8vIERldGVjdCBwcm9wZXIgdHJhbnNpdGlvbmVuZC9hbmltYXRpb25lbmQgZXZlbnQgbmFtZXMuCiAgICAgIHZhciBDU1NfUFJFRklYID0gJycsIFRSQU5TSVRJT05fUFJPUCwgVFJBTlNJVElPTkVORF9FVkVOVCwgQU5JTUFUSU9OX1BST1AsIEFOSU1BVElPTkVORF9FVkVOVDsKCiAgICAgIC8vIElmIHVucHJlZml4ZWQgZXZlbnRzIGFyZSBub3Qgc3VwcG9ydGVkIGJ1dCB3ZWJraXQtcHJlZml4ZWQgYXJlLCB1c2UgdGhlIGxhdHRlci4KICAgICAgLy8gT3RoZXJ3aXNlLCBqdXN0IHVzZSBXM0MgbmFtZXMsIGJyb3dzZXJzIG5vdCBzdXBwb3J0aW5nIHRoZW0gYXQgYWxsIHdpbGwganVzdCBpZ25vcmUgdGhlbS4KICAgICAgLy8gTm90ZTogQ2hyb21lIGltcGxlbWVudHMgYHdpbmRvdy5vbndlYmtpdGFuaW1hdGlvbmVuZGAgYW5kIGRvZXNuJ3QgaW1wbGVtZW50IGB3aW5kb3cub25hbmltYXRpb25lbmRgCiAgICAgIC8vIGJ1dCBhdCB0aGUgc2FtZSB0aW1lIGRpc3BhdGNoZXMgdGhlIGBhbmltYXRpb25lbmRgIGV2ZW50IGFuZCBub3QgYHdlYmtpdEFuaW1hdGlvbkVuZGAuCiAgICAgIC8vIFJlZ2lzdGVyIGJvdGggZXZlbnRzIGluIGNhc2UgYHdpbmRvdy5vbmFuaW1hdGlvbmVuZGAgaXMgbm90IHN1cHBvcnRlZCBiZWNhdXNlIG9mIHRoYXQsCiAgICAgIC8vIGRvIHRoZSBzYW1lIGZvciBgdHJhbnNpdGlvbmVuZGAgYXMgU2FmYXJpIGlzIGxpa2VseSB0byBleGhpYml0IHNpbWlsYXIgYmVoYXZpb3IuCiAgICAgIC8vIEFsc28sIHRoZSBvbmx5IG1vZGVybiBicm93c2VyIHRoYXQgdXNlcyB2ZW5kb3IgcHJlZml4ZXMgZm9yIHRyYW5zaXRpb25zL2tleWZyYW1lcyBpcyB3ZWJraXQKICAgICAgLy8gdGhlcmVmb3JlIHRoZXJlIGlzIG5vIHJlYXNvbiB0byB0ZXN0IGFueW1vcmUgZm9yIG90aGVyIHZlbmRvciBwcmVmaXhlczogaHR0cDovL2Nhbml1c2UuY29tLyNzZWFyY2g9dHJhbnNpdGlvbgogICAgICBpZiAod2luZG93Lm9udHJhbnNpdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdHRyYW5zaXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIENTU19QUkVGSVggPSAnLXdlYmtpdC0nOwogICAgICAgIFRSQU5TSVRJT05fUFJPUCA9ICdXZWJraXRUcmFuc2l0aW9uJzsKICAgICAgICBUUkFOU0lUSU9ORU5EX0VWRU5UID0gJ3dlYmtpdFRyYW5zaXRpb25FbmQgdHJhbnNpdGlvbmVuZCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVFJBTlNJVElPTl9QUk9QID0gJ3RyYW5zaXRpb24nOwogICAgICAgIFRSQU5TSVRJT05FTkRfRVZFTlQgPSAndHJhbnNpdGlvbmVuZCc7CiAgICAgIH0KCiAgICAgIGlmICh3aW5kb3cub25hbmltYXRpb25lbmQgPT09IHVuZGVmaW5lZCAmJiB3aW5kb3cub253ZWJraXRhbmltYXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIENTU19QUkVGSVggPSAnLXdlYmtpdC0nOwogICAgICAgIEFOSU1BVElPTl9QUk9QID0gJ1dlYmtpdEFuaW1hdGlvbic7CiAgICAgICAgQU5JTUFUSU9ORU5EX0VWRU5UID0gJ3dlYmtpdEFuaW1hdGlvbkVuZCBhbmltYXRpb25lbmQnOwogICAgICB9IGVsc2UgewogICAgICAgIEFOSU1BVElPTl9QUk9QID0gJ2FuaW1hdGlvbic7CiAgICAgICAgQU5JTUFUSU9ORU5EX0VWRU5UID0gJ2FuaW1hdGlvbmVuZCc7CiAgICAgIH0KCiAgICAgIHZhciBEVVJBVElPTl9LRVkgPSAnRHVyYXRpb24nOwogICAgICB2YXIgUFJPUEVSVFlfS0VZID0gJ1Byb3BlcnR5JzsKICAgICAgdmFyIERFTEFZX0tFWSA9ICdEZWxheSc7CiAgICAgIHZhciBBTklNQVRJT05fSVRFUkFUSU9OX0NPVU5UX0tFWSA9ICdJdGVyYXRpb25Db3VudCc7CiAgICAgIHZhciBOR19BTklNQVRFX1BBUkVOVF9LRVkgPSAnJCRuZ0FuaW1hdGVLZXknOwogICAgICB2YXIgTkdfQU5JTUFURV9DU1NfREFUQV9LRVkgPSAnJCRuZ0FuaW1hdGVDU1MzRGF0YSc7CiAgICAgIHZhciBOR19BTklNQVRFX0JMT0NLX0NMQVNTX05BTUUgPSAnbmctYW5pbWF0ZS1ibG9jay10cmFuc2l0aW9ucyc7CiAgICAgIHZhciBFTEFQU0VEX1RJTUVfTUFYX0RFQ0lNQUxfUExBQ0VTID0gMzsKICAgICAgdmFyIENMT1NJTkdfVElNRV9CVUZGRVIgPSAxLjU7CiAgICAgIHZhciBPTkVfU0VDT05EID0gMTAwMDsKCiAgICAgIHZhciBsb29rdXBDYWNoZSA9IHt9OwogICAgICB2YXIgcGFyZW50Q291bnRlciA9IDA7CiAgICAgIHZhciBhbmltYXRpb25SZWZsb3dRdWV1ZSA9IFtdOwogICAgICB2YXIgY2FuY2VsQW5pbWF0aW9uUmVmbG93OwogICAgICBmdW5jdGlvbiBhZnRlclJlZmxvdyhlbGVtZW50LCBjYWxsYmFjaykgewogICAgICAgIGlmKGNhbmNlbEFuaW1hdGlvblJlZmxvdykgewogICAgICAgICAgY2FuY2VsQW5pbWF0aW9uUmVmbG93KCk7CiAgICAgICAgfQogICAgICAgIGFuaW1hdGlvblJlZmxvd1F1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgIGNhbmNlbEFuaW1hdGlvblJlZmxvdyA9ICQkYW5pbWF0ZVJlZmxvdyhmdW5jdGlvbigpIHsKICAgICAgICAgIGZvckVhY2goYW5pbWF0aW9uUmVmbG93UXVldWUsIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBhbmltYXRpb25SZWZsb3dRdWV1ZSA9IFtdOwogICAgICAgICAgY2FuY2VsQW5pbWF0aW9uUmVmbG93ID0gbnVsbDsKICAgICAgICAgIGxvb2t1cENhY2hlID0ge307CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHZhciBjbG9zaW5nVGltZXIgPSBudWxsOwogICAgICB2YXIgY2xvc2luZ1RpbWVzdGFtcCA9IDA7CiAgICAgIHZhciBhbmltYXRpb25FbGVtZW50UXVldWUgPSBbXTsKICAgICAgZnVuY3Rpb24gYW5pbWF0aW9uQ2xvc2VIYW5kbGVyKGVsZW1lbnQsIHRvdGFsVGltZSkgewogICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQobm9kZSk7CgogICAgICAgIC8vdGhpcyBpdGVtIHdpbGwgYmUgZ2FyYmFnZSBjb2xsZWN0ZWQgYnkgdGhlIGNsb3NpbmcKICAgICAgICAvL2FuaW1hdGlvbiB0aW1lb3V0CiAgICAgICAgYW5pbWF0aW9uRWxlbWVudFF1ZXVlLnB1c2goZWxlbWVudCk7CgogICAgICAgIC8vYnV0IGl0IG1heSBub3QgbmVlZCB0byBjYW5jZWwgb3V0IHRoZSBleGlzdGluZyB0aW1lb3V0CiAgICAgICAgLy9pZiB0aGUgdGltZXN0YW1wIGlzIGxlc3MgdGhhbiB0aGUgcHJldmlvdXMgb25lCiAgICAgICAgdmFyIGZ1dHVyZVRpbWVzdGFtcCA9IERhdGUubm93KCkgKyB0b3RhbFRpbWU7CiAgICAgICAgaWYoZnV0dXJlVGltZXN0YW1wIDw9IGNsb3NpbmdUaW1lc3RhbXApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgICR0aW1lb3V0LmNhbmNlbChjbG9zaW5nVGltZXIpOwoKICAgICAgICBjbG9zaW5nVGltZXN0YW1wID0gZnV0dXJlVGltZXN0YW1wOwogICAgICAgIGNsb3NpbmdUaW1lciA9ICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgY2xvc2VBbGxBbmltYXRpb25zKGFuaW1hdGlvbkVsZW1lbnRRdWV1ZSk7CiAgICAgICAgICBhbmltYXRpb25FbGVtZW50UXVldWUgPSBbXTsKICAgICAgICB9LCB0b3RhbFRpbWUsIGZhbHNlKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2xvc2VBbGxBbmltYXRpb25zKGVsZW1lbnRzKSB7CiAgICAgICAgZm9yRWFjaChlbGVtZW50cywgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgdmFyIGVsZW1lbnREYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICAgIGlmKGVsZW1lbnREYXRhKSB7CiAgICAgICAgICAgIChlbGVtZW50RGF0YS5jbG9zZUFuaW1hdGlvbkZuIHx8IG5vb3ApKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldEVsZW1lbnRBbmltYXRpb25EZXRhaWxzKGVsZW1lbnQsIGNhY2hlS2V5KSB7CiAgICAgICAgdmFyIGRhdGEgPSBjYWNoZUtleSA/IGxvb2t1cENhY2hlW2NhY2hlS2V5XSA6IG51bGw7CiAgICAgICAgaWYoIWRhdGEpIHsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb24gPSAwOwogICAgICAgICAgdmFyIHRyYW5zaXRpb25EZWxheSA9IDA7CiAgICAgICAgICB2YXIgYW5pbWF0aW9uRHVyYXRpb24gPSAwOwogICAgICAgICAgdmFyIGFuaW1hdGlvbkRlbGF5ID0gMDsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uRGVsYXlTdHlsZTsKICAgICAgICAgIHZhciBhbmltYXRpb25EZWxheVN0eWxlOwogICAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvblN0eWxlOwogICAgICAgICAgdmFyIHRyYW5zaXRpb25Qcm9wZXJ0eVN0eWxlOwoKICAgICAgICAgIC8vd2Ugd2FudCBhbGwgdGhlIHN0eWxlcyBkZWZpbmVkIGJlZm9yZSBhbmQgYWZ0ZXIKICAgICAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudFN0eWxlcyA9ICR3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50KSB8fCB7fTsKCiAgICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uU3R5bGUgPSBlbGVtZW50U3R5bGVzW1RSQU5TSVRJT05fUFJPUCArIERVUkFUSU9OX0tFWV07CgogICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbiA9IE1hdGgubWF4KHBhcnNlTWF4VGltZSh0cmFuc2l0aW9uRHVyYXRpb25TdHlsZSksIHRyYW5zaXRpb25EdXJhdGlvbik7CgogICAgICAgICAgICAgIHRyYW5zaXRpb25Qcm9wZXJ0eVN0eWxlID0gZWxlbWVudFN0eWxlc1tUUkFOU0lUSU9OX1BST1AgKyBQUk9QRVJUWV9LRVldOwoKICAgICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXlTdHlsZSA9IGVsZW1lbnRTdHlsZXNbVFJBTlNJVElPTl9QUk9QICsgREVMQVlfS0VZXTsKCiAgICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5ICA9IE1hdGgubWF4KHBhcnNlTWF4VGltZSh0cmFuc2l0aW9uRGVsYXlTdHlsZSksIHRyYW5zaXRpb25EZWxheSk7CgogICAgICAgICAgICAgIGFuaW1hdGlvbkRlbGF5U3R5bGUgPSBlbGVtZW50U3R5bGVzW0FOSU1BVElPTl9QUk9QICsgREVMQVlfS0VZXTsKCiAgICAgICAgICAgICAgYW5pbWF0aW9uRGVsYXkgICA9IE1hdGgubWF4KHBhcnNlTWF4VGltZShhbmltYXRpb25EZWxheVN0eWxlKSwgYW5pbWF0aW9uRGVsYXkpOwoKICAgICAgICAgICAgICB2YXIgYUR1cmF0aW9uICA9IHBhcnNlTWF4VGltZShlbGVtZW50U3R5bGVzW0FOSU1BVElPTl9QUk9QICsgRFVSQVRJT05fS0VZXSk7CgogICAgICAgICAgICAgIGlmKGFEdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgIGFEdXJhdGlvbiAqPSBwYXJzZUludChlbGVtZW50U3R5bGVzW0FOSU1BVElPTl9QUk9QICsgQU5JTUFUSU9OX0lURVJBVElPTl9DT1VOVF9LRVldLCAxMCkgfHwgMTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGFuaW1hdGlvbkR1cmF0aW9uID0gTWF0aC5tYXgoYUR1cmF0aW9uLCBhbmltYXRpb25EdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgZGF0YSA9IHsKICAgICAgICAgICAgdG90YWwgOiAwLAogICAgICAgICAgICB0cmFuc2l0aW9uUHJvcGVydHlTdHlsZTogdHJhbnNpdGlvblByb3BlcnR5U3R5bGUsCiAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvblN0eWxlOiB0cmFuc2l0aW9uRHVyYXRpb25TdHlsZSwKICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5U3R5bGU6IHRyYW5zaXRpb25EZWxheVN0eWxlLAogICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXk6IHRyYW5zaXRpb25EZWxheSwKICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uOiB0cmFuc2l0aW9uRHVyYXRpb24sCiAgICAgICAgICAgIGFuaW1hdGlvbkRlbGF5U3R5bGU6IGFuaW1hdGlvbkRlbGF5U3R5bGUsCiAgICAgICAgICAgIGFuaW1hdGlvbkRlbGF5OiBhbmltYXRpb25EZWxheSwKICAgICAgICAgICAgYW5pbWF0aW9uRHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uCiAgICAgICAgICB9OwogICAgICAgICAgaWYoY2FjaGVLZXkpIHsKICAgICAgICAgICAgbG9va3VwQ2FjaGVbY2FjaGVLZXldID0gZGF0YTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHBhcnNlTWF4VGltZShzdHIpIHsKICAgICAgICB2YXIgbWF4VmFsdWUgPSAwOwogICAgICAgIHZhciB2YWx1ZXMgPSBhbmd1bGFyLmlzU3RyaW5nKHN0cikgPwogICAgICAgICAgc3RyLnNwbGl0KC9ccyosXHMqLykgOgogICAgICAgICAgW107CiAgICAgICAgZm9yRWFjaCh2YWx1ZXMsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBtYXhWYWx1ZSA9IE1hdGgubWF4KHBhcnNlRmxvYXQodmFsdWUpIHx8IDAsIG1heFZhbHVlKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWF4VmFsdWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldENhY2hlS2V5KGVsZW1lbnQpIHsKICAgICAgICB2YXIgcGFyZW50RWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7CiAgICAgICAgdmFyIHBhcmVudElEID0gcGFyZW50RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfUEFSRU5UX0tFWSk7CiAgICAgICAgaWYoIXBhcmVudElEKSB7CiAgICAgICAgICBwYXJlbnRFbGVtZW50LmRhdGEoTkdfQU5JTUFURV9QQVJFTlRfS0VZLCArK3BhcmVudENvdW50ZXIpOwogICAgICAgICAgcGFyZW50SUQgPSBwYXJlbnRDb3VudGVyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyZW50SUQgKyAnLScgKyBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRlU2V0dXAoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgY2FsY3VsYXRpb25EZWNvcmF0b3IpIHsKICAgICAgICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShlbGVtZW50KTsKICAgICAgICB2YXIgZXZlbnRDYWNoZUtleSA9IGNhY2hlS2V5ICsgJyAnICsgY2xhc3NOYW1lOwogICAgICAgIHZhciBpdGVtSW5kZXggPSBsb29rdXBDYWNoZVtldmVudENhY2hlS2V5XSA/ICsrbG9va3VwQ2FjaGVbZXZlbnRDYWNoZUtleV0udG90YWwgOiAwOwoKICAgICAgICB2YXIgc3RhZ2dlciA9IHt9OwogICAgICAgIGlmKGl0ZW1JbmRleCA+IDApIHsKICAgICAgICAgIHZhciBzdGFnZ2VyQ2xhc3NOYW1lID0gY2xhc3NOYW1lICsgJy1zdGFnZ2VyJzsKICAgICAgICAgIHZhciBzdGFnZ2VyQ2FjaGVLZXkgPSBjYWNoZUtleSArICcgJyArIHN0YWdnZXJDbGFzc05hbWU7CiAgICAgICAgICB2YXIgYXBwbHlDbGFzc2VzID0gIWxvb2t1cENhY2hlW3N0YWdnZXJDYWNoZUtleV07CgogICAgICAgICAgYXBwbHlDbGFzc2VzICYmIGVsZW1lbnQuYWRkQ2xhc3Moc3RhZ2dlckNsYXNzTmFtZSk7CgogICAgICAgICAgc3RhZ2dlciA9IGdldEVsZW1lbnRBbmltYXRpb25EZXRhaWxzKGVsZW1lbnQsIHN0YWdnZXJDYWNoZUtleSk7CgogICAgICAgICAgYXBwbHlDbGFzc2VzICYmIGVsZW1lbnQucmVtb3ZlQ2xhc3Moc3RhZ2dlckNsYXNzTmFtZSk7CiAgICAgICAgfQoKICAgICAgICAvKiB0aGUgYW5pbWF0aW9uIGl0c2VsZiBtYXkgbmVlZCB0byBhZGQvcmVtb3ZlIHNwZWNpYWwgQ1NTIGNsYXNzZXMKICAgICAgICAgKiBiZWZvcmUgY2FsY3VsYXRpbmcgdGhlIGFubWF0aW9uIHN0eWxlcyAqLwogICAgICAgIGNhbGN1bGF0aW9uRGVjb3JhdG9yID0gY2FsY3VsYXRpb25EZWNvcmF0b3IgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGZuKSB7IHJldHVybiBmbigpOyB9OwoKICAgICAgICBlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CgogICAgICAgIHZhciBmb3JtZXJEYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKSB8fCB7fTsKCiAgICAgICAgdmFyIHRpbWluZ3MgPSBjYWxjdWxhdGlvbkRlY29yYXRvcihmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBldmVudENhY2hlS2V5KTsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbiA9IHRpbWluZ3MudHJhbnNpdGlvbkR1cmF0aW9uOwogICAgICAgIHZhciBhbmltYXRpb25EdXJhdGlvbiA9IHRpbWluZ3MuYW5pbWF0aW9uRHVyYXRpb247CiAgICAgICAgaWYodHJhbnNpdGlvbkR1cmF0aW9uID09PSAwICYmIGFuaW1hdGlvbkR1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DU1NfREFUQV9LRVksIHsKICAgICAgICAgIHJ1bm5pbmcgOiBmb3JtZXJEYXRhLnJ1bm5pbmcgfHwgMCwKICAgICAgICAgIGl0ZW1JbmRleCA6IGl0ZW1JbmRleCwKICAgICAgICAgIHN0YWdnZXIgOiBzdGFnZ2VyLAogICAgICAgICAgdGltaW5ncyA6IHRpbWluZ3MsCiAgICAgICAgICBjbG9zZUFuaW1hdGlvbkZuIDogbm9vcAogICAgICAgIH0pOwoKICAgICAgICAvL3RlbXBvcmFyaWx5IGRpc2FibGUgdGhlIHRyYW5zaXRpb24gc28gdGhhdCB0aGUgZW50ZXIgc3R5bGVzCiAgICAgICAgLy9kb24ndCBhbmltYXRlIHR3aWNlICh0aGlzIGlzIGhlcmUgdG8gYXZvaWQgYSBidWcgaW4gQ2hyb21lL0ZGKS4KICAgICAgICB2YXIgaXNDdXJyZW50bHlBbmltYXRpbmcgPSBmb3JtZXJEYXRhLnJ1bm5pbmcgPiAwIHx8IGFuaW1hdGlvbkV2ZW50ID09ICdzZXRDbGFzcyc7CiAgICAgICAgaWYodHJhbnNpdGlvbkR1cmF0aW9uID4gMCkgewogICAgICAgICAgYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUsIGlzQ3VycmVudGx5QW5pbWF0aW5nKTsKICAgICAgICB9CgogICAgICAgIC8vc3RhZ2dlcmluZyBrZXlmcmFtZSBhbmltYXRpb25zIHdvcmsgYnkgYWRqdXN0aW5nIHRoZSBgYW5pbWF0aW9uLWRlbGF5YCBDU1MgcHJvcGVydHkKICAgICAgICAvL29uIHRoZSBnaXZlbiBlbGVtZW50LCBob3dldmVyLCB0aGUgZGVsYXkgdmFsdWUgY2FuIG9ubHkgY2FsY3VsYXRlZCBhZnRlciB0aGUgcmVmbG93CiAgICAgICAgLy9zaW5jZSBieSB0aGF0IHRpbWUgJGFuaW1hdGUga25vd3MgaG93IG1hbnkgZWxlbWVudHMgYXJlIGJlaW5nIGFuaW1hdGVkLiBUaGVyZWZvcmUsCiAgICAgICAgLy91bnRpbCB0aGUgcmVmbG93IG9jY3VycyB0aGUgZWxlbWVudCBuZWVkcyB0byBiZSBibG9ja2VkICh3aGVyZSB0aGUga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICAgICAgLy9pcyBzZXQgdG8gYG5vbmUgMHNgKS4gVGhpcyBibG9ja2luZyBtZWNoYW5pc20gc2hvdWxkIG9ubHkgYmUgc2V0IGZvciB3aGVuIGEgc3RhZ2dlcgogICAgICAgIC8vYW5pbWF0aW9uIGlzIGRldGVjdGVkIGFuZCB3aGVuIHRoZSBlbGVtZW50IGl0ZW0gaW5kZXggaXMgZ3JlYXRlciB0aGFuIDAuCiAgICAgICAgaWYoYW5pbWF0aW9uRHVyYXRpb24gPiAwICYmIHN0YWdnZXIuYW5pbWF0aW9uRGVsYXkgPiAwICYmIHN0YWdnZXIuYW5pbWF0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgIGJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGlzU3RydWN0dXJhbEFuaW1hdGlvbihjbGFzc05hbWUpIHsKICAgICAgICByZXR1cm4gY2xhc3NOYW1lID09ICduZy1lbnRlcicgfHwgY2xhc3NOYW1lID09ICduZy1tb3ZlJyB8fCBjbGFzc05hbWUgPT0gJ25nLWxlYXZlJzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUsIGlzQW5pbWF0aW5nKSB7CiAgICAgICAgaWYoaXNTdHJ1Y3R1cmFsQW5pbWF0aW9uKGNsYXNzTmFtZSkgfHwgIWlzQW5pbWF0aW5nKSB7CiAgICAgICAgICBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkuc3R5bGVbVFJBTlNJVElPTl9QUk9QICsgUFJPUEVSVFlfS0VZXSA9ICdub25lJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhOR19BTklNQVRFX0JMT0NLX0NMQVNTX05BTUUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYmxvY2tLZXlmcmFtZUFuaW1hdGlvbnMoZWxlbWVudCkgewogICAgICAgIGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KS5zdHlsZVtBTklNQVRJT05fUFJPUF0gPSAnbm9uZSAwcyc7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICB2YXIgcHJvcCA9IFRSQU5TSVRJT05fUFJPUCArIFBST1BFUlRZX0tFWTsKICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICBpZihub2RlLnN0eWxlW3Byb3BdICYmIG5vZGUuc3R5bGVbcHJvcF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgbm9kZS5zdHlsZVtwcm9wXSA9ICcnOwogICAgICAgIH0KICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKE5HX0FOSU1BVEVfQkxPQ0tfQ0xBU1NfTkFNRSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHVuYmxvY2tLZXlmcmFtZUFuaW1hdGlvbnMoZWxlbWVudCkgewogICAgICAgIHZhciBwcm9wID0gQU5JTUFUSU9OX1BST1A7CiAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgaWYobm9kZS5zdHlsZVtwcm9wXSAmJiBub2RlLnN0eWxlW3Byb3BdLmxlbmd0aCA+IDApIHsKICAgICAgICAgIG5vZGUuc3R5bGVbcHJvcF0gPSAnJzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGVSdW4oYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUpIHsKICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICB2YXIgZWxlbWVudERhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DU1NfREFUQV9LRVkpOwogICAgICAgIGlmKG5vZGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpLmluZGV4T2YoY2xhc3NOYW1lKSA9PSAtMSB8fCAhZWxlbWVudERhdGEpIHsKICAgICAgICAgIGFjdGl2ZUFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgYWN0aXZlQ2xhc3NOYW1lID0gJyc7CiAgICAgICAgZm9yRWFjaChjbGFzc05hbWUuc3BsaXQoJyAnKSwgZnVuY3Rpb24oa2xhc3MsIGkpIHsKICAgICAgICAgIGFjdGl2ZUNsYXNzTmFtZSArPSAoaSA+IDAgPyAnICcgOiAnJykgKyBrbGFzcyArICctYWN0aXZlJzsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIHN0YWdnZXIgPSBlbGVtZW50RGF0YS5zdGFnZ2VyOwogICAgICAgIHZhciB0aW1pbmdzID0gZWxlbWVudERhdGEudGltaW5nczsKICAgICAgICB2YXIgaXRlbUluZGV4ID0gZWxlbWVudERhdGEuaXRlbUluZGV4OwogICAgICAgIHZhciBtYXhEdXJhdGlvbiA9IE1hdGgubWF4KHRpbWluZ3MudHJhbnNpdGlvbkR1cmF0aW9uLCB0aW1pbmdzLmFuaW1hdGlvbkR1cmF0aW9uKTsKICAgICAgICB2YXIgbWF4RGVsYXkgPSBNYXRoLm1heCh0aW1pbmdzLnRyYW5zaXRpb25EZWxheSwgdGltaW5ncy5hbmltYXRpb25EZWxheSk7CiAgICAgICAgdmFyIG1heERlbGF5VGltZSA9IG1heERlbGF5ICogT05FX1NFQ09ORDsKCiAgICAgICAgdmFyIHN0YXJ0VGltZSA9IERhdGUubm93KCk7CiAgICAgICAgdmFyIGNzczNBbmltYXRpb25FdmVudHMgPSBBTklNQVRJT05FTkRfRVZFTlQgKyAnICcgKyBUUkFOU0lUSU9ORU5EX0VWRU5UOwoKICAgICAgICB2YXIgc3R5bGUgPSAnJywgYXBwbGllZFN0eWxlcyA9IFtdOwogICAgICAgIGlmKHRpbWluZ3MudHJhbnNpdGlvbkR1cmF0aW9uID4gMCkgewogICAgICAgICAgdmFyIHByb3BlcnR5U3R5bGUgPSB0aW1pbmdzLnRyYW5zaXRpb25Qcm9wZXJ0eVN0eWxlOwogICAgICAgICAgaWYocHJvcGVydHlTdHlsZS5pbmRleE9mKCdhbGwnKSA9PSAtMSkgewogICAgICAgICAgICBzdHlsZSArPSBDU1NfUFJFRklYICsgJ3RyYW5zaXRpb24tcHJvcGVydHk6ICcgKyBwcm9wZXJ0eVN0eWxlICsgJzsnOwogICAgICAgICAgICBzdHlsZSArPSBDU1NfUFJFRklYICsgJ3RyYW5zaXRpb24tZHVyYXRpb246ICcgKyB0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvblN0eWxlICsgJzsnOwogICAgICAgICAgICBhcHBsaWVkU3R5bGVzLnB1c2goQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLXByb3BlcnR5Jyk7CiAgICAgICAgICAgIGFwcGxpZWRTdHlsZXMucHVzaChDU1NfUFJFRklYICsgJ3RyYW5zaXRpb24tZHVyYXRpb24nKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKGl0ZW1JbmRleCA+IDApIHsKICAgICAgICAgIGlmKHN0YWdnZXIudHJhbnNpdGlvbkRlbGF5ID4gMCAmJiBzdGFnZ2VyLnRyYW5zaXRpb25EdXJhdGlvbiA9PT0gMCkgewogICAgICAgICAgICB2YXIgZGVsYXlTdHlsZSA9IHRpbWluZ3MudHJhbnNpdGlvbkRlbGF5U3R5bGU7CiAgICAgICAgICAgIHN0eWxlICs9IENTU19QUkVGSVggKyAndHJhbnNpdGlvbi1kZWxheTogJyArCiAgICAgICAgICAgICAgICAgICAgIHByZXBhcmVTdGFnZ2VyRGVsYXkoZGVsYXlTdHlsZSwgc3RhZ2dlci50cmFuc2l0aW9uRGVsYXksIGl0ZW1JbmRleCkgKyAnOyAnOwogICAgICAgICAgICBhcHBsaWVkU3R5bGVzLnB1c2goQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLWRlbGF5Jyk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYoc3RhZ2dlci5hbmltYXRpb25EZWxheSA+IDAgJiYgc3RhZ2dlci5hbmltYXRpb25EdXJhdGlvbiA9PT0gMCkgewogICAgICAgICAgICBzdHlsZSArPSBDU1NfUFJFRklYICsgJ2FuaW1hdGlvbi1kZWxheTogJyArCiAgICAgICAgICAgICAgICAgICAgIHByZXBhcmVTdGFnZ2VyRGVsYXkodGltaW5ncy5hbmltYXRpb25EZWxheVN0eWxlLCBzdGFnZ2VyLmFuaW1hdGlvbkRlbGF5LCBpdGVtSW5kZXgpICsgJzsgJzsKICAgICAgICAgICAgYXBwbGllZFN0eWxlcy5wdXNoKENTU19QUkVGSVggKyAnYW5pbWF0aW9uLWRlbGF5Jyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihhcHBsaWVkU3R5bGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIC8vdGhlIGVsZW1lbnQgYmVpbmcgYW5pbWF0ZWQgbWF5IHNvbWV0aW1lcyBjb250YWluIGNvbW1lbnQgbm9kZXMgaW4KICAgICAgICAgIC8vdGhlIGpxTGl0ZSBvYmplY3QsIHNvIHdlJ3JlIHNhZmUgdG8gdXNlIGEgc2luZ2xlIHZhcmlhYmxlIHRvIGhvdXNlCiAgICAgICAgICAvL3RoZSBzdHlsZXMgc2luY2UgdGhlcmUgaXMgYWx3YXlzIG9ubHkgb25lIGVsZW1lbnQgYmVpbmcgYW5pbWF0ZWQKICAgICAgICAgIHZhciBvbGRTdHlsZSA9IG5vZGUuZ2V0QXR0cmlidXRlKCdzdHlsZScpIHx8ICcnOwogICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgb2xkU3R5bGUgKyAnOyAnICsgc3R5bGUpOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudC5vbihjc3MzQW5pbWF0aW9uRXZlbnRzLCBvbkFuaW1hdGlvblByb2dyZXNzKTsKICAgICAgICBlbGVtZW50LmFkZENsYXNzKGFjdGl2ZUNsYXNzTmFtZSk7CiAgICAgICAgZWxlbWVudERhdGEuY2xvc2VBbmltYXRpb25GbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgb25FbmQoKTsKICAgICAgICAgIGFjdGl2ZUFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHN0YWdnZXJUaW1lICAgICAgID0gaXRlbUluZGV4ICogKE1hdGgubWF4KHN0YWdnZXIuYW5pbWF0aW9uRGVsYXksIHN0YWdnZXIudHJhbnNpdGlvbkRlbGF5KSB8fCAwKTsKICAgICAgICB2YXIgYW5pbWF0aW9uVGltZSAgICAgPSAobWF4RGVsYXkgKyBtYXhEdXJhdGlvbikgKiBDTE9TSU5HX1RJTUVfQlVGRkVSOwogICAgICAgIHZhciB0b3RhbFRpbWUgICAgICAgICA9IChzdGFnZ2VyVGltZSArIGFuaW1hdGlvblRpbWUpICogT05FX1NFQ09ORDsKCiAgICAgICAgZWxlbWVudERhdGEucnVubmluZysrOwogICAgICAgIGFuaW1hdGlvbkNsb3NlSGFuZGxlcihlbGVtZW50LCB0b3RhbFRpbWUpOwogICAgICAgIHJldHVybiBvbkVuZDsKCiAgICAgICAgLy8gVGhpcyB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgY2FsbGVkIGJ5ICRhbmltYXRlIHNvCiAgICAgICAgLy8gdGhlcmUgaXMgbm8gbmVlZCB0byBhdHRhY2ggdGhpcyBpbnRlcm5hbGx5IHRvIHRoZQogICAgICAgIC8vIHRpbWVvdXQgZG9uZSBtZXRob2QuCiAgICAgICAgZnVuY3Rpb24gb25FbmQoY2FuY2VsbGVkKSB7CiAgICAgICAgICBlbGVtZW50Lm9mZihjc3MzQW5pbWF0aW9uRXZlbnRzLCBvbkFuaW1hdGlvblByb2dyZXNzKTsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3NOYW1lKTsKICAgICAgICAgIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgICBmb3IgKHZhciBpIGluIGFwcGxpZWRTdHlsZXMpIHsKICAgICAgICAgICAgbm9kZS5zdHlsZS5yZW1vdmVQcm9wZXJ0eShhcHBsaWVkU3R5bGVzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uQW5pbWF0aW9uUHJvZ3Jlc3MoZXZlbnQpIHsKICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgdmFyIGV2ID0gZXZlbnQub3JpZ2luYWxFdmVudCB8fCBldmVudDsKICAgICAgICAgIHZhciB0aW1lU3RhbXAgPSBldi4kbWFudWFsVGltZVN0YW1wIHx8IGV2LnRpbWVTdGFtcCB8fCBEYXRlLm5vdygpOwoKICAgICAgICAgIC8qIEZpcmVmb3ggKG9yIHBvc3NpYmx5IGp1c3QgR2Vja28pIGxpa2VzIHRvIG5vdCByb3VuZCB2YWx1ZXMgdXAKICAgICAgICAgICAqIHdoZW4gYSBtcyBtZWFzdXJlbWVudCBpcyB1c2VkIGZvciB0aGUgYW5pbWF0aW9uICovCiAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBwYXJzZUZsb2F0KGV2LmVsYXBzZWRUaW1lLnRvRml4ZWQoRUxBUFNFRF9USU1FX01BWF9ERUNJTUFMX1BMQUNFUykpOwoKICAgICAgICAgIC8qICRtYW51YWxUaW1lU3RhbXAgaXMgYSBtb2NrZWQgdGltZVN0YW1wIHZhbHVlIHdoaWNoIGlzIHNldAogICAgICAgICAgICogd2l0aGluIGJyb3dzZXJUcmlnZ2VyKCkuIFRoaXMgaXMgb25seSBoZXJlIHNvIHRoYXQgdGVzdHMgY2FuCiAgICAgICAgICAgKiBtb2NrIGFuaW1hdGlvbnMgcHJvcGVybHkuIFJlYWwgZXZlbnRzIGZhbGxiYWNrIHRvIGV2ZW50LnRpbWVTdGFtcCwKICAgICAgICAgICAqIG9yLCBpZiB0aGV5IGRvbid0LCB0aGVuIGEgdGltZVN0YW1wIGlzIGF1dG9tYXRpY2FsbHkgY3JlYXRlZCBmb3IgdGhlbS4KICAgICAgICAgICAqIFdlJ3JlIGNoZWNraW5nIHRvIHNlZSBpZiB0aGUgdGltZVN0YW1wIHN1cnBhc3NlcyB0aGUgZXhwZWN0ZWQgZGVsYXksCiAgICAgICAgICAgKiBidXQgd2UncmUgdXNpbmcgZWxhcHNlZFRpbWUgaW5zdGVhZCBvZiB0aGUgdGltZVN0YW1wIG9uIHRoZSAybmQKICAgICAgICAgICAqIHByZS1jb25kaXRpb24gc2luY2UgYW5pbWF0aW9ucyBzb21ldGltZXMgY2xvc2Ugb2ZmIGVhcmx5ICovCiAgICAgICAgICBpZihNYXRoLm1heCh0aW1lU3RhbXAgLSBzdGFydFRpbWUsIDApID49IG1heERlbGF5VGltZSAmJiBlbGFwc2VkVGltZSA+PSBtYXhEdXJhdGlvbikgewogICAgICAgICAgICBhY3RpdmVBbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gcHJlcGFyZVN0YWdnZXJEZWxheShkZWxheVN0eWxlLCBzdGFnZ2VyRGVsYXksIGluZGV4KSB7CiAgICAgICAgdmFyIHN0eWxlID0gJyc7CiAgICAgICAgZm9yRWFjaChkZWxheVN0eWxlLnNwbGl0KCcsJyksIGZ1bmN0aW9uKHZhbCwgaSkgewogICAgICAgICAgc3R5bGUgKz0gKGkgPiAwID8gJywnIDogJycpICsKICAgICAgICAgICAgICAgICAgIChpbmRleCAqIHN0YWdnZXJEZWxheSArIHBhcnNlSW50KHZhbCwgMTApKSArICdzJzsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gc3R5bGU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGVCZWZvcmUoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgY2FsY3VsYXRpb25EZWNvcmF0b3IpIHsKICAgICAgICBpZihhbmltYXRlU2V0dXAoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgY2FsY3VsYXRpb25EZWNvcmF0b3IpKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICAgIGNhbmNlbGxlZCAmJiBhbmltYXRlQ2xvc2UoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRlQWZ0ZXIoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYWZ0ZXJBbmltYXRpb25Db21wbGV0ZSkgewogICAgICAgIGlmKGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSkpIHsKICAgICAgICAgIHJldHVybiBhbmltYXRlUnVuKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhbmltYXRlQ2xvc2UoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGUoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGUpIHsKICAgICAgICAvL0lmIHRoZSBhbmltYXRlU2V0dXAgZnVuY3Rpb24gZG9lc24ndCBib3RoZXIgcmV0dXJuaW5nIGEKICAgICAgICAvL2NhbmNlbGxhdGlvbiBmdW5jdGlvbiB0aGVuIGl0IG1lYW5zIHRoYXQgdGhlcmUgaXMgbm8gYW5pbWF0aW9uCiAgICAgICAgLy90byBwZXJmb3JtIGF0IGFsbAogICAgICAgIHZhciBwcmVSZWZsb3dDYW5jZWxsYXRpb24gPSBhbmltYXRlQmVmb3JlKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgIGlmKCFwcmVSZWZsb3dDYW5jZWxsYXRpb24pIHsKICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvL1RoZXJlIGFyZSB0d28gY2FuY2VsbGF0aW9uIGZ1bmN0aW9uczogb25lIGlzIGJlZm9yZSB0aGUgZmlyc3QKICAgICAgICAvL3JlZmxvdyBhbmltYXRpb24gYW5kIHRoZSBzZWNvbmQgaXMgZHVyaW5nIHRoZSBhY3RpdmUgc3RhdGUKICAgICAgICAvL2FuaW1hdGlvbi4gVGhlIGZpcnN0IGZ1bmN0aW9uIHdpbGwgdGFrZSBjYXJlIG9mIHJlbW92aW5nIHRoZQogICAgICAgIC8vZGF0YSBmcm9tIHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgbm90IG1ha2UgdGhlIDJuZCBhbmltYXRpb24KICAgICAgICAvL2hhcHBlbiBpbiB0aGUgZmlyc3QgcGxhY2UKICAgICAgICB2YXIgY2FuY2VsID0gcHJlUmVmbG93Q2FuY2VsbGF0aW9uOwogICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdW5ibG9ja1RyYW5zaXRpb25zKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICB1bmJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgLy9vbmNlIHRoZSByZWZsb3cgaXMgY29tcGxldGUgdGhlbiB3ZSBwb2ludCBjYW5jZWwgdG8KICAgICAgICAgIC8vdGhlIG5ldyBjYW5jZWxsYXRpb24gZnVuY3Rpb24gd2hpY2ggd2lsbCByZW1vdmUgYWxsIG9mIHRoZQogICAgICAgICAgLy9hbmltYXRpb24gcHJvcGVydGllcyBmcm9tIHRoZSBhY3RpdmUgYW5pbWF0aW9uCiAgICAgICAgICBjYW5jZWwgPSBhbmltYXRlQWZ0ZXIoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGUpOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICAoY2FuY2VsIHx8IG5vb3ApKGNhbmNlbGxlZCk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgaWYoZGF0YS5ydW5uaW5nKSB7CiAgICAgICAgICAgIGRhdGEucnVubmluZy0tOwogICAgICAgICAgfQogICAgICAgICAgaWYoIWRhdGEucnVubmluZyB8fCBkYXRhLnJ1bm5pbmcgPT09IDApIHsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVEYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgZW50ZXIgOiBmdW5jdGlvbihlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgIHJldHVybiBhbmltYXRlKCdlbnRlcicsIGVsZW1lbnQsICduZy1lbnRlcicsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgfSwKCiAgICAgICAgbGVhdmUgOiBmdW5jdGlvbihlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgIHJldHVybiBhbmltYXRlKCdsZWF2ZScsIGVsZW1lbnQsICduZy1sZWF2ZScsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgfSwKCiAgICAgICAgbW92ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgcmV0dXJuIGFuaW1hdGUoJ21vdmUnLCBlbGVtZW50LCAnbmctbW92ZScsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgfSwKCiAgICAgICAgYmVmb3JlU2V0Q2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gc3VmZml4Q2xhc3NlcyhyZW1vdmUsICctcmVtb3ZlJykgKyAnICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHN1ZmZpeENsYXNzZXMoYWRkLCAnLWFkZCcpOwogICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ3NldENsYXNzJywgZWxlbWVudCwgY2xhc3NOYW1lLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAvKiB3aGVuIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSBhbiBlbGVtZW50IHRoZW4gdGhlIHRyYW5zaXRpb24gc3R5bGUKICAgICAgICAgICAgICogdGhhdCBpcyBhcHBsaWVkIGlzIHRoZSB0cmFuc2l0aW9uIGRlZmluZWQgb24gdGhlIGVsZW1lbnQgd2l0aG91dCB0aGUKICAgICAgICAgICAgICogQ1NTIGNsYXNzIGJlaW5nIHRoZXJlLiBUaGlzIGlzIGhvdyBDU1MzIGZ1bmN0aW9ucyBvdXRzaWRlIG9mIG5nQW5pbWF0ZS4KICAgICAgICAgICAgICogaHR0cDovL3BsbmtyLmNvL2VkaXQvajhPemdUTnhIVGI0bjN6THlqR1c/cD1wcmV2aWV3ICovCiAgICAgICAgICAgIHZhciBrbGFzcyA9IGVsZW1lbnQuYXR0cignY2xhc3MnKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhyZW1vdmUpOwogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGFkZCk7CiAgICAgICAgICAgIHZhciB0aW1pbmdzID0gZm4oKTsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKCdjbGFzcycsIGtsYXNzKTsKICAgICAgICAgICAgcmV0dXJuIHRpbWluZ3M7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZihjYW5jZWxsYXRpb25NZXRob2QpIHsKICAgICAgICAgICAgYWZ0ZXJSZWZsb3coZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdW5ibG9ja1RyYW5zaXRpb25zKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgdW5ibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICB9CiAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICB9LAoKICAgICAgICBiZWZvcmVBZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICB2YXIgY2FuY2VsbGF0aW9uTWV0aG9kID0gYW5pbWF0ZUJlZm9yZSgnYWRkQ2xhc3MnLCBlbGVtZW50LCBzdWZmaXhDbGFzc2VzKGNsYXNzTmFtZSwgJy1hZGQnKSwgZnVuY3Rpb24oZm4pIHsKCiAgICAgICAgICAgIC8qIHdoZW4gYSBDU1MgY2xhc3MgaXMgYWRkZWQgdG8gYW4gZWxlbWVudCB0aGVuIHRoZSB0cmFuc2l0aW9uIHN0eWxlIHRoYXQKICAgICAgICAgICAgICogaXMgYXBwbGllZCBpcyB0aGUgdHJhbnNpdGlvbiBkZWZpbmVkIG9uIHRoZSBlbGVtZW50IHdoZW4gdGhlIENTUyBjbGFzcwogICAgICAgICAgICAgKiBpcyBhZGRlZCBhdCB0aGUgdGltZSBvZiB0aGUgYW5pbWF0aW9uLiBUaGlzIGlzIGhvdyBDU1MzIGZ1bmN0aW9ucwogICAgICAgICAgICAgKiBvdXRzaWRlIG9mIG5nQW5pbWF0ZS4gKi8KICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB2YXIgdGltaW5ncyA9IGZuKCk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgcmV0dXJuIHRpbWluZ3M7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZihjYW5jZWxsYXRpb25NZXRob2QpIHsKICAgICAgICAgICAgYWZ0ZXJSZWZsb3coZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdW5ibG9ja1RyYW5zaXRpb25zKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgdW5ibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICB9CiAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICB9LAoKICAgICAgICBzZXRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFkZCwgcmVtb3ZlLCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgIHJlbW92ZSA9IHN1ZmZpeENsYXNzZXMocmVtb3ZlLCAnLXJlbW92ZScpOwogICAgICAgICAgYWRkID0gc3VmZml4Q2xhc3NlcyhhZGQsICctYWRkJyk7CiAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gcmVtb3ZlICsgJyAnICsgYWRkOwogICAgICAgICAgcmV0dXJuIGFuaW1hdGVBZnRlcignc2V0Q2xhc3MnLCBlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgfSwKCiAgICAgICAgYWRkQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgcmV0dXJuIGFuaW1hdGVBZnRlcignYWRkQ2xhc3MnLCBlbGVtZW50LCBzdWZmaXhDbGFzc2VzKGNsYXNzTmFtZSwgJy1hZGQnKSwgYW5pbWF0aW9uQ29tcGxldGVkKTsKICAgICAgICB9LAoKICAgICAgICBiZWZvcmVSZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICB2YXIgY2FuY2VsbGF0aW9uTWV0aG9kID0gYW5pbWF0ZUJlZm9yZSgncmVtb3ZlQ2xhc3MnLCBlbGVtZW50LCBzdWZmaXhDbGFzc2VzKGNsYXNzTmFtZSwgJy1yZW1vdmUnKSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgLyogd2hlbiBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gYW4gZWxlbWVudCB0aGVuIHRoZSB0cmFuc2l0aW9uIHN0eWxlCiAgICAgICAgICAgICAqIHRoYXQgaXMgYXBwbGllZCBpcyB0aGUgdHJhbnNpdGlvbiBkZWZpbmVkIG9uIHRoZSBlbGVtZW50IHdpdGhvdXQgdGhlCiAgICAgICAgICAgICAqIENTUyBjbGFzcyBiZWluZyB0aGVyZS4gVGhpcyBpcyBob3cgQ1NTMyBmdW5jdGlvbnMgb3V0c2lkZSBvZiBuZ0FuaW1hdGUuCiAgICAgICAgICAgICAqIGh0dHA6Ly9wbG5rci5jby9lZGl0L2o4T3pnVE54SFRiNG4zekx5akdXP3A9cHJldmlldyAqLwogICAgICAgICAgICB2YXIga2xhc3MgPSBlbGVtZW50LmF0dHIoJ2NsYXNzJyk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgdmFyIHRpbWluZ3MgPSBmbigpOwogICAgICAgICAgICBlbGVtZW50LmF0dHIoJ2NsYXNzJywga2xhc3MpOwogICAgICAgICAgICByZXR1cm4gdGltaW5nczsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmKGNhbmNlbGxhdGlvbk1ldGhvZCkgewogICAgICAgICAgICBhZnRlclJlZmxvdyhlbGVtZW50LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1bmJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB1bmJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGNhbmNlbGxhdGlvbk1ldGhvZDsKICAgICAgICAgIH0KICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZCgpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZUNsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ3JlbW92ZUNsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctcmVtb3ZlJyksIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgZnVuY3Rpb24gc3VmZml4Q2xhc3NlcyhjbGFzc2VzLCBzdWZmaXgpIHsKICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyc7CiAgICAgICAgY2xhc3NlcyA9IGFuZ3VsYXIuaXNBcnJheShjbGFzc2VzKSA/IGNsYXNzZXMgOiBjbGFzc2VzLnNwbGl0KC9ccysvKTsKICAgICAgICBmb3JFYWNoKGNsYXNzZXMsIGZ1bmN0aW9uKGtsYXNzLCBpKSB7CiAgICAgICAgICBpZihrbGFzcyAmJiBrbGFzcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNsYXNzTmFtZSArPSAoaSA+IDAgPyAnICcgOiAnJykgKyBrbGFzcyArIHN1ZmZpeDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY2xhc3NOYW1lOwogICAgICB9CiAgICB9XSk7CiAgfV0pOwoKCn0pKHdpbmRvdywgd2luZG93LmFuZ3VsYXIpOwoKLyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qKgogKiBAbGljZW5zZSBBbmd1bGFySlMgdjEuMi4xNwogKiAoYykgMjAxMC0yMDE0IEdvb2dsZSwgSW5jLiBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbih3aW5kb3csIGFuZ3VsYXIsIHVuZGVmaW5lZCkgeyd1c2Ugc3RyaWN0JzsKCnZhciAkc2FuaXRpemVNaW5FcnIgPSBhbmd1bGFyLiQkbWluRXJyKCckc2FuaXRpemUnKTsKCi8qKgogKiBAbmdkb2MgbW9kdWxlCiAqIEBuYW1lIG5nU2FuaXRpemUKICogQGRlc2NyaXB0aW9uCiAqCiAqICMgbmdTYW5pdGl6ZQogKgogKiBUaGUgYG5nU2FuaXRpemVgIG1vZHVsZSBwcm92aWRlcyBmdW5jdGlvbmFsaXR5IHRvIHNhbml0aXplIEhUTUwuCiAqCiAqCiAqIDxkaXYgZG9jLW1vZHVsZS1jb21wb25lbnRzPSJuZ1Nhbml0aXplIj48L2Rpdj4KICoKICogU2VlIHtAbGluayBuZ1Nhbml0aXplLiRzYW5pdGl6ZSBgJHNhbml0aXplYH0gZm9yIHVzYWdlLgogKi8KCi8qCiAqIEhUTUwgUGFyc2VyIEJ5IE1pc2tvIEhldmVyeSAobWlza29AaGV2ZXJ5LmNvbSkKICogYmFzZWQgb246ICBIVE1MIFBhcnNlciBCeSBKb2huIFJlc2lnIChlam9obi5vcmcpCiAqIE9yaWdpbmFsIGNvZGUgYnkgRXJpayBBcnZpZHNzb24sIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogaHR0cDovL2VyaWsuZWFlLm5ldC9zaW1wbGVodG1scGFyc2VyL3NpbXBsZWh0bWxwYXJzZXIuanMKICoKICogLy8gVXNlIGxpa2Ugc286CiAqIGh0bWxQYXJzZXIoaHRtbFN0cmluZywgewogKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICogICAgIGVuZDogZnVuY3Rpb24odGFnKSB7fSwKICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAqIH0pOwogKgogKi8KCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHNhbml0aXplCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAgIFRoZSBpbnB1dCBpcyBzYW5pdGl6ZWQgYnkgcGFyc2luZyB0aGUgaHRtbCBpbnRvIHRva2Vucy4gQWxsIHNhZmUgdG9rZW5zIChmcm9tIGEgd2hpdGVsaXN0KSBhcmUKICogICB0aGVuIHNlcmlhbGl6ZWQgYmFjayB0byBwcm9wZXJseSBlc2NhcGVkIGh0bWwgc3RyaW5nLiBUaGlzIG1lYW5zIHRoYXQgbm8gdW5zYWZlIGlucHV0IGNhbiBtYWtlCiAqICAgaXQgaW50byB0aGUgcmV0dXJuZWQgc3RyaW5nLCBob3dldmVyLCBzaW5jZSBvdXIgcGFyc2VyIGlzIG1vcmUgc3RyaWN0IHRoYW4gYSB0eXBpY2FsIGJyb3dzZXIKICogICBwYXJzZXIsIGl0J3MgcG9zc2libGUgdGhhdCBzb21lIG9ic2N1cmUgaW5wdXQsIHdoaWNoIHdvdWxkIGJlIHJlY29nbml6ZWQgYXMgdmFsaWQgSFRNTCBieSBhCiAqICAgYnJvd3Nlciwgd29uJ3QgbWFrZSBpdCB0aHJvdWdoIHRoZSBzYW5pdGl6ZXIuCiAqICAgVGhlIHdoaXRlbGlzdCBpcyBjb25maWd1cmVkIHVzaW5nIHRoZSBmdW5jdGlvbnMgYGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0YCBhbmQKICogICBgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0YCBvZiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciBgJGNvbXBpbGVQcm92aWRlcmB9LgogKgogKiBAcGFyYW0ge3N0cmluZ30gaHRtbCBIdG1sIGlucHV0LgogKiBAcmV0dXJucyB7c3RyaW5nfSBTYW5pdGl6ZWQgaHRtbC4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1Nhbml0aXplIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPHNjcmlwdD4KICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlLCAkc2NlKSB7CiAgICAgICAgICRzY29wZS5zbmlwcGV0ID0KICAgICAgICAgICAnPHAgc3R5bGU9ImNvbG9yOmJsdWUiPmFuIGh0bWxcbicgKwogICAgICAgICAgICc8ZW0gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9XCdQV04zRCFcJyI+Y2xpY2sgaGVyZTwvZW0+XG4nICsKICAgICAgICAgICAnc25pcHBldDwvcD4nOwogICAgICAgICAkc2NvcGUuZGVsaWJlcmF0ZWx5VHJ1c3REYW5nZXJvdXNTbmlwcGV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgcmV0dXJuICRzY2UudHJ1c3RBc0h0bWwoJHNjb3BlLnNuaXBwZXQpOwogICAgICAgICB9OwogICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgU25pcHBldDogPHRleHRhcmVhIG5nLW1vZGVsPSJzbmlwcGV0IiBjb2xzPSI2MCIgcm93cz0iMyI+PC90ZXh0YXJlYT4KICAgICAgIDx0YWJsZT4KICAgICAgICAgPHRyPgogICAgICAgICAgIDx0ZD5EaXJlY3RpdmU8L3RkPgogICAgICAgICAgIDx0ZD5Ib3c8L3RkPgogICAgICAgICAgIDx0ZD5Tb3VyY2U8L3RkPgogICAgICAgICAgIDx0ZD5SZW5kZXJlZDwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0iYmluZC1odG1sLXdpdGgtc2FuaXRpemUiPgogICAgICAgICAgIDx0ZD5uZy1iaW5kLWh0bWw8L3RkPgogICAgICAgICAgIDx0ZD5BdXRvbWF0aWNhbGx5IHVzZXMgJHNhbml0aXplPC90ZD4KICAgICAgICAgICA8dGQ+PHByZT4mbHQ7ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldCImZ3Q7PGJyLz4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICAgICAgICAgIDx0ZD48ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldCI+PC9kaXY+PC90ZD4KICAgICAgICAgPC90cj4KICAgICAgICAgPHRyIGlkPSJiaW5kLWh0bWwtd2l0aC10cnVzdCI+CiAgICAgICAgICAgPHRkPm5nLWJpbmQtaHRtbDwvdGQ+CiAgICAgICAgICAgPHRkPkJ5cGFzcyAkc2FuaXRpemUgYnkgZXhwbGljaXRseSB0cnVzdGluZyB0aGUgZGFuZ2Vyb3VzIHZhbHVlPC90ZD4KICAgICAgICAgICA8dGQ+CiAgICAgICAgICAgPHByZT4mbHQ7ZGl2IG5nLWJpbmQtaHRtbD0iZGVsaWJlcmF0ZWx5VHJ1c3REYW5nZXJvdXNTbmlwcGV0KCkiJmd0OwombHQ7L2RpdiZndDs8L3ByZT4KICAgICAgICAgICA8L3RkPgogICAgICAgICAgIDx0ZD48ZGl2IG5nLWJpbmQtaHRtbD0iZGVsaWJlcmF0ZWx5VHJ1c3REYW5nZXJvdXNTbmlwcGV0KCkiPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0iYmluZC1kZWZhdWx0Ij4KICAgICAgICAgICA8dGQ+bmctYmluZDwvdGQ+CiAgICAgICAgICAgPHRkPkF1dG9tYXRpY2FsbHkgZXNjYXBlczwvdGQ+CiAgICAgICAgICAgPHRkPjxwcmU+Jmx0O2RpdiBuZy1iaW5kPSJzbmlwcGV0IiZndDs8YnIvPiZsdDsvZGl2Jmd0OzwvcHJlPjwvdGQ+CiAgICAgICAgICAgPHRkPjxkaXYgbmctYmluZD0ic25pcHBldCI+PC9kaXY+PC90ZD4KICAgICAgICAgPC90cj4KICAgICAgIDwvdGFibGU+CiAgICAgICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICBpdCgnc2hvdWxkIHNhbml0aXplIHRoZSBodG1sIHNuaXBwZXQgYnkgZGVmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1odG1sLXdpdGgtc2FuaXRpemUgZGl2JykpLmdldElubmVySHRtbCgpKS4KICAgICAgICAgdG9CZSgnPHA+YW4gaHRtbFxuPGVtPmNsaWNrIGhlcmU8L2VtPlxuc25pcHBldDwvcD4nKTsKICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBpbmxpbmUgcmF3IHNuaXBwZXQgaWYgYm91bmQgdG8gYSB0cnVzdGVkIHZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJyNiaW5kLWh0bWwtd2l0aC10cnVzdCBkaXYnKSkuZ2V0SW5uZXJIdG1sKCkpLgogICAgICAgICB0b0JlKCI8cCBzdHlsZT1cImNvbG9yOmJsdWVcIj5hbiBodG1sXG4iICsKICAgICAgICAgICAgICAiPGVtIG9ubW91c2VvdmVyPVwidGhpcy50ZXh0Q29udGVudD0nUFdOM0QhJ1wiPmNsaWNrIGhlcmU8L2VtPlxuIiArCiAgICAgICAgICAgICAgInNuaXBwZXQ8L3A+Iik7CiAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgZXNjYXBlIHNuaXBwZXQgd2l0aG91dCBhbnkgZmlsdGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJyNiaW5kLWRlZmF1bHQgZGl2JykpLmdldElubmVySHRtbCgpKS4KICAgICAgICAgdG9CZSgiJmx0O3Agc3R5bGU9XCJjb2xvcjpibHVlXCImZ3Q7YW4gaHRtbFxuIiArCiAgICAgICAgICAgICAgIiZsdDtlbSBvbm1vdXNlb3Zlcj1cInRoaXMudGV4dENvbnRlbnQ9J1BXTjNEISdcIiZndDtjbGljayBoZXJlJmx0Oy9lbSZndDtcbiIgKwogICAgICAgICAgICAgICJzbmlwcGV0Jmx0Oy9wJmd0OyIpOwogICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgZWxlbWVudChieS5tb2RlbCgnc25pcHBldCcpKS5jbGVhcigpOwogICAgICAgZWxlbWVudChieS5tb2RlbCgnc25pcHBldCcpKS5zZW5kS2V5cygnbmV3IDxiIG9uY2xpY2s9ImFsZXJ0KDEpIj50ZXh0PC9iPicpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1odG1sLXdpdGgtc2FuaXRpemUgZGl2JykpLmdldElubmVySHRtbCgpKS4KICAgICAgICAgdG9CZSgnbmV3IDxiPnRleHQ8L2I+Jyk7CiAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJyNiaW5kLWh0bWwtd2l0aC10cnVzdCBkaXYnKSkuZ2V0SW5uZXJIdG1sKCkpLnRvQmUoCiAgICAgICAgICduZXcgPGIgb25jbGljaz0iYWxlcnQoMSkiPnRleHQ8L2I+Jyk7CiAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJyNiaW5kLWRlZmF1bHQgZGl2JykpLmdldElubmVySHRtbCgpKS50b0JlKAogICAgICAgICAibmV3ICZsdDtiIG9uY2xpY2s9XCJhbGVydCgxKVwiJmd0O3RleHQmbHQ7L2ImZ3Q7Iik7CiAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gJFNhbml0aXplUHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckJHNhbml0aXplVXJpJywgZnVuY3Rpb24oJCRzYW5pdGl6ZVVyaSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgdmFyIGJ1ZiA9IFtdOwogICAgICBodG1sUGFyc2VyKGh0bWwsIGh0bWxTYW5pdGl6ZVdyaXRlcihidWYsIGZ1bmN0aW9uKHVyaSwgaXNJbWFnZSkgewogICAgICAgIHJldHVybiAhL151bnNhZmUvLnRlc3QoJCRzYW5pdGl6ZVVyaSh1cmksIGlzSW1hZ2UpKTsKICAgICAgfSkpOwogICAgICByZXR1cm4gYnVmLmpvaW4oJycpOwogICAgfTsKICB9XTsKfQoKZnVuY3Rpb24gc2FuaXRpemVUZXh0KGNoYXJzKSB7CiAgdmFyIGJ1ZiA9IFtdOwogIHZhciB3cml0ZXIgPSBodG1sU2FuaXRpemVXcml0ZXIoYnVmLCBhbmd1bGFyLm5vb3ApOwogIHdyaXRlci5jaGFycyhjaGFycyk7CiAgcmV0dXJuIGJ1Zi5qb2luKCcnKTsKfQoKCi8vIFJlZ3VsYXIgRXhwcmVzc2lvbnMgZm9yIHBhcnNpbmcgdGFncyBhbmQgYXR0cmlidXRlcwp2YXIgU1RBUlRfVEFHX1JFR0VYUCA9CiAgICAgICAvXjxccyooW1x3Oi1dKykoKD86XHMrW1x3Oi1dKyg/OlxzKj1ccyooPzooPzoiW14iXSoiKXwoPzonW14nXSonKXxbXj5cc10rKSk/KSopXHMqKFwvPylccyo+LywKICBFTkRfVEFHX1JFR0VYUCA9IC9ePFxzKlwvXHMqKFtcdzotXSspW14+XSo+LywKICBBVFRSX1JFR0VYUCA9IC8oW1x3Oi1dKykoPzpccyo9XHMqKD86KD86IigoPzpbXiJdKSopIil8KD86JygoPzpbXiddKSopJyl8KFtePlxzXSspKSk/L2csCiAgQkVHSU5fVEFHX1JFR0VYUCA9IC9ePC8sCiAgQkVHSU5HX0VORF9UQUdFX1JFR0VYUCA9IC9ePFxzKlwvLywKICBDT01NRU5UX1JFR0VYUCA9IC88IS0tKC4qPyktLT4vZywKICBET0NUWVBFX1JFR0VYUCA9IC88IURPQ1RZUEUoW14+XSo/KT4vaSwKICBDREFUQV9SRUdFWFAgPSAvPCFcW0NEQVRBXFsoLio/KV1dPi9nLAogIFNVUlJPR0FURV9QQUlSX1JFR0VYUCA9IC9bXHVEODAwLVx1REJGRl1bXHVEQzAwLVx1REZGRl0vZywKICAvLyBNYXRjaCBldmVyeXRoaW5nIG91dHNpZGUgb2Ygbm9ybWFsIGNoYXJzIGFuZCAiIChxdW90ZSBjaGFyYWN0ZXIpCiAgTk9OX0FMUEhBTlVNRVJJQ19SRUdFWFAgPSAvKFteXCMtfnwgfCFdKS9nOwoKCi8vIEdvb2Qgc291cmNlIG9mIGluZm8gYWJvdXQgZWxlbWVudHMgYW5kIGF0dHJpYnV0ZXMKLy8gaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI3NlbWFudGljcwovLyBodHRwOi8vc2ltb24uaHRtbDUub3JnL2h0bWwtZWxlbWVudHMKCi8vIFNhZmUgVm9pZCBFbGVtZW50cyAtIEhUTUw1Ci8vIGh0dHA6Ly9kZXYudzMub3JnL2h0bWw1L3NwZWMvT3ZlcnZpZXcuaHRtbCN2b2lkLWVsZW1lbnRzCnZhciB2b2lkRWxlbWVudHMgPSBtYWtlTWFwKCJhcmVhLGJyLGNvbCxocixpbWcsd2JyIik7CgovLyBFbGVtZW50cyB0aGF0IHlvdSBjYW4sIGludGVudGlvbmFsbHksIGxlYXZlIG9wZW4gKGFuZCB3aGljaCBjbG9zZSB0aGVtc2VsdmVzKQovLyBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjb3B0aW9uYWwtdGFncwp2YXIgb3B0aW9uYWxFbmRUYWdCbG9ja0VsZW1lbnRzID0gbWFrZU1hcCgiY29sZ3JvdXAsZGQsZHQsbGkscCx0Ym9keSx0ZCx0Zm9vdCx0aCx0aGVhZCx0ciIpLAogICAgb3B0aW9uYWxFbmRUYWdJbmxpbmVFbGVtZW50cyA9IG1ha2VNYXAoInJwLHJ0IiksCiAgICBvcHRpb25hbEVuZFRhZ0VsZW1lbnRzID0gYW5ndWxhci5leHRlbmQoe30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uYWxFbmRUYWdJbmxpbmVFbGVtZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25hbEVuZFRhZ0Jsb2NrRWxlbWVudHMpOwoKLy8gU2FmZSBCbG9jayBFbGVtZW50cyAtIEhUTUw1CnZhciBibG9ja0VsZW1lbnRzID0gYW5ndWxhci5leHRlbmQoe30sIG9wdGlvbmFsRW5kVGFnQmxvY2tFbGVtZW50cywgbWFrZU1hcCgiYWRkcmVzcyxhcnRpY2xlLCIgKwogICAgICAgICJhc2lkZSxibG9ja3F1b3RlLGNhcHRpb24sY2VudGVyLGRlbCxkaXIsZGl2LGRsLGZpZ3VyZSxmaWdjYXB0aW9uLGZvb3RlcixoMSxoMixoMyxoNCxoNSwiICsKICAgICAgICAiaDYsaGVhZGVyLGhncm91cCxocixpbnMsbWFwLG1lbnUsbmF2LG9sLHByZSxzY3JpcHQsc2VjdGlvbix0YWJsZSx1bCIpKTsKCi8vIElubGluZSBFbGVtZW50cyAtIEhUTUw1CnZhciBpbmxpbmVFbGVtZW50cyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBvcHRpb25hbEVuZFRhZ0lubGluZUVsZW1lbnRzLCBtYWtlTWFwKCJhLGFiYnIsYWNyb255bSxiLCIgKwogICAgICAgICJiZGksYmRvLGJpZyxicixjaXRlLGNvZGUsZGVsLGRmbixlbSxmb250LGksaW1nLGlucyxrYmQsbGFiZWwsbWFwLG1hcmsscSxydWJ5LHJwLHJ0LHMsIiArCiAgICAgICAgInNhbXAsc21hbGwsc3BhbixzdHJpa2Usc3Ryb25nLHN1YixzdXAsdGltZSx0dCx1LHZhciIpKTsKCgovLyBTcGVjaWFsIEVsZW1lbnRzIChjYW4gY29udGFpbiBhbnl0aGluZykKdmFyIHNwZWNpYWxFbGVtZW50cyA9IG1ha2VNYXAoInNjcmlwdCxzdHlsZSIpOwoKdmFyIHZhbGlkRWxlbWVudHMgPSBhbmd1bGFyLmV4dGVuZCh7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkRWxlbWVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tFbGVtZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmxpbmVFbGVtZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25hbEVuZFRhZ0VsZW1lbnRzKTsKCi8vQXR0cmlidXRlcyB0aGF0IGhhdmUgaHJlZiBhbmQgaGVuY2UgbmVlZCB0byBiZSBzYW5pdGl6ZWQKdmFyIHVyaUF0dHJzID0gbWFrZU1hcCgiYmFja2dyb3VuZCxjaXRlLGhyZWYsbG9uZ2Rlc2Msc3JjLHVzZW1hcCIpOwp2YXIgdmFsaWRBdHRycyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCB1cmlBdHRycywgbWFrZU1hcCgKICAgICdhYmJyLGFsaWduLGFsdCxheGlzLGJnY29sb3IsYm9yZGVyLGNlbGxwYWRkaW5nLGNlbGxzcGFjaW5nLGNsYXNzLGNsZWFyLCcrCiAgICAnY29sb3IsY29scyxjb2xzcGFuLGNvbXBhY3QsY29vcmRzLGRpcixmYWNlLGhlYWRlcnMsaGVpZ2h0LGhyZWZsYW5nLGhzcGFjZSwnKwogICAgJ2lzbWFwLGxhbmcsbGFuZ3VhZ2Usbm9ocmVmLG5vd3JhcCxyZWwscmV2LHJvd3Mscm93c3BhbixydWxlcywnKwogICAgJ3Njb3BlLHNjcm9sbGluZyxzaGFwZSxzaXplLHNwYW4sc3RhcnQsc3VtbWFyeSx0YXJnZXQsdGl0bGUsdHlwZSwnKwogICAgJ3ZhbGlnbix2YWx1ZSx2c3BhY2Usd2lkdGgnKSk7CgpmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoJywnKSwgaTsKICBmb3IgKGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIG9ialtpdGVtc1tpXV0gPSB0cnVlOwogIHJldHVybiBvYmo7Cn0KCgovKioKICogQGV4YW1wbGUKICogaHRtbFBhcnNlcihodG1sU3RyaW5nLCB7CiAqICAgICBzdGFydDogZnVuY3Rpb24odGFnLCBhdHRycywgdW5hcnkpIHt9LAogKiAgICAgZW5kOiBmdW5jdGlvbih0YWcpIHt9LAogKiAgICAgY2hhcnM6IGZ1bmN0aW9uKHRleHQpIHt9LAogKiAgICAgY29tbWVudDogZnVuY3Rpb24odGV4dCkge30KICogfSk7CiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBodG1sIHN0cmluZwogKiBAcGFyYW0ge29iamVjdH0gaGFuZGxlcgogKi8KZnVuY3Rpb24gaHRtbFBhcnNlciggaHRtbCwgaGFuZGxlciApIHsKICB2YXIgaW5kZXgsIGNoYXJzLCBtYXRjaCwgc3RhY2sgPSBbXSwgbGFzdCA9IGh0bWw7CiAgc3RhY2subGFzdCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gc3RhY2tbIHN0YWNrLmxlbmd0aCAtIDEgXTsgfTsKCiAgd2hpbGUgKCBodG1sICkgewogICAgY2hhcnMgPSB0cnVlOwoKICAgIC8vIE1ha2Ugc3VyZSB3ZSdyZSBub3QgaW4gYSBzY3JpcHQgb3Igc3R5bGUgZWxlbWVudAogICAgaWYgKCAhc3RhY2subGFzdCgpIHx8ICFzcGVjaWFsRWxlbWVudHNbIHN0YWNrLmxhc3QoKSBdICkgewoKICAgICAgLy8gQ29tbWVudAogICAgICBpZiAoIGh0bWwuaW5kZXhPZigiPCEtLSIpID09PSAwICkgewogICAgICAgIC8vIGNvbW1lbnRzIGNvbnRhaW5pbmcgLS0gYXJlIG5vdCBhbGxvd2VkIHVubGVzcyB0aGV5IHRlcm1pbmF0ZSB0aGUgY29tbWVudAogICAgICAgIGluZGV4ID0gaHRtbC5pbmRleE9mKCItLSIsIDQpOwoKICAgICAgICBpZiAoIGluZGV4ID49IDAgJiYgaHRtbC5sYXN0SW5kZXhPZigiLS0+IiwgaW5kZXgpID09PSBpbmRleCkgewogICAgICAgICAgaWYgKGhhbmRsZXIuY29tbWVudCkgaGFuZGxlci5jb21tZW50KCBodG1sLnN1YnN0cmluZyggNCwgaW5kZXggKSApOwogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBpbmRleCArIDMgKTsKICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgfQogICAgICAvLyBET0NUWVBFCiAgICAgIH0gZWxzZSBpZiAoIERPQ1RZUEVfUkVHRVhQLnRlc3QoaHRtbCkgKSB7CiAgICAgICAgbWF0Y2ggPSBodG1sLm1hdGNoKCBET0NUWVBFX1JFR0VYUCApOwoKICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgaHRtbCA9IGh0bWwucmVwbGFjZSggbWF0Y2hbMF0sICcnKTsKICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgfQogICAgICAvLyBlbmQgdGFnCiAgICAgIH0gZWxzZSBpZiAoIEJFR0lOR19FTkRfVEFHRV9SRUdFWFAudGVzdChodG1sKSApIHsKICAgICAgICBtYXRjaCA9IGh0bWwubWF0Y2goIEVORF9UQUdfUkVHRVhQICk7CgogICAgICAgIGlmICggbWF0Y2ggKSB7CiAgICAgICAgICBodG1sID0gaHRtbC5zdWJzdHJpbmcoIG1hdGNoWzBdLmxlbmd0aCApOwogICAgICAgICAgbWF0Y2hbMF0ucmVwbGFjZSggRU5EX1RBR19SRUdFWFAsIHBhcnNlRW5kVGFnICk7CiAgICAgICAgICBjaGFycyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgIC8vIHN0YXJ0IHRhZwogICAgICB9IGVsc2UgaWYgKCBCRUdJTl9UQUdfUkVHRVhQLnRlc3QoaHRtbCkgKSB7CiAgICAgICAgbWF0Y2ggPSBodG1sLm1hdGNoKCBTVEFSVF9UQUdfUkVHRVhQICk7CgogICAgICAgIGlmICggbWF0Y2ggKSB7CiAgICAgICAgICBodG1sID0gaHRtbC5zdWJzdHJpbmcoIG1hdGNoWzBdLmxlbmd0aCApOwogICAgICAgICAgbWF0Y2hbMF0ucmVwbGFjZSggU1RBUlRfVEFHX1JFR0VYUCwgcGFyc2VTdGFydFRhZyApOwogICAgICAgICAgY2hhcnMgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICggY2hhcnMgKSB7CiAgICAgICAgaW5kZXggPSBodG1sLmluZGV4T2YoIjwiKTsKCiAgICAgICAgdmFyIHRleHQgPSBpbmRleCA8IDAgPyBodG1sIDogaHRtbC5zdWJzdHJpbmcoIDAsIGluZGV4ICk7CiAgICAgICAgaHRtbCA9IGluZGV4IDwgMCA/ICIiIDogaHRtbC5zdWJzdHJpbmcoIGluZGV4ICk7CgogICAgICAgIGlmIChoYW5kbGVyLmNoYXJzKSBoYW5kbGVyLmNoYXJzKCBkZWNvZGVFbnRpdGllcyh0ZXh0KSApOwogICAgICB9CgogICAgfSBlbHNlIHsKICAgICAgaHRtbCA9IGh0bWwucmVwbGFjZShuZXcgUmVnRXhwKCIoLiopPFxccypcXC9cXHMqIiArIHN0YWNrLmxhc3QoKSArICJbXj5dKj4iLCAnaScpLAogICAgICAgIGZ1bmN0aW9uKGFsbCwgdGV4dCl7CiAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKENPTU1FTlRfUkVHRVhQLCAiJDEiKS5yZXBsYWNlKENEQVRBX1JFR0VYUCwgIiQxIik7CgogICAgICAgICAgaWYgKGhhbmRsZXIuY2hhcnMpIGhhbmRsZXIuY2hhcnMoIGRlY29kZUVudGl0aWVzKHRleHQpICk7CgogICAgICAgICAgcmV0dXJuICIiOwogICAgICB9KTsKCiAgICAgIHBhcnNlRW5kVGFnKCAiIiwgc3RhY2subGFzdCgpICk7CiAgICB9CgogICAgaWYgKCBodG1sID09IGxhc3QgKSB7CiAgICAgIHRocm93ICRzYW5pdGl6ZU1pbkVycignYmFkcGFyc2UnLCAiVGhlIHNhbml0aXplciB3YXMgdW5hYmxlIHRvIHBhcnNlIHRoZSBmb2xsb3dpbmcgYmxvY2sgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAib2YgaHRtbDogezB9IiwgaHRtbCk7CiAgICB9CiAgICBsYXN0ID0gaHRtbDsKICB9CgogIC8vIENsZWFuIHVwIGFueSByZW1haW5pbmcgdGFncwogIHBhcnNlRW5kVGFnKCk7CgogIGZ1bmN0aW9uIHBhcnNlU3RhcnRUYWcoIHRhZywgdGFnTmFtZSwgcmVzdCwgdW5hcnkgKSB7CiAgICB0YWdOYW1lID0gYW5ndWxhci5sb3dlcmNhc2UodGFnTmFtZSk7CiAgICBpZiAoIGJsb2NrRWxlbWVudHNbIHRhZ05hbWUgXSApIHsKICAgICAgd2hpbGUgKCBzdGFjay5sYXN0KCkgJiYgaW5saW5lRWxlbWVudHNbIHN0YWNrLmxhc3QoKSBdICkgewogICAgICAgIHBhcnNlRW5kVGFnKCAiIiwgc3RhY2subGFzdCgpICk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoIG9wdGlvbmFsRW5kVGFnRWxlbWVudHNbIHRhZ05hbWUgXSAmJiBzdGFjay5sYXN0KCkgPT0gdGFnTmFtZSApIHsKICAgICAgcGFyc2VFbmRUYWcoICIiLCB0YWdOYW1lICk7CiAgICB9CgogICAgdW5hcnkgPSB2b2lkRWxlbWVudHNbIHRhZ05hbWUgXSB8fCAhIXVuYXJ5OwoKICAgIGlmICggIXVuYXJ5ICkKICAgICAgc3RhY2sucHVzaCggdGFnTmFtZSApOwoKICAgIHZhciBhdHRycyA9IHt9OwoKICAgIHJlc3QucmVwbGFjZShBVFRSX1JFR0VYUCwKICAgICAgZnVuY3Rpb24obWF0Y2gsIG5hbWUsIGRvdWJsZVF1b3RlZFZhbHVlLCBzaW5nbGVRdW90ZWRWYWx1ZSwgdW5xdW90ZWRWYWx1ZSkgewogICAgICAgIHZhciB2YWx1ZSA9IGRvdWJsZVF1b3RlZFZhbHVlCiAgICAgICAgICB8fCBzaW5nbGVRdW90ZWRWYWx1ZQogICAgICAgICAgfHwgdW5xdW90ZWRWYWx1ZQogICAgICAgICAgfHwgJyc7CgogICAgICAgIGF0dHJzW25hbWVdID0gZGVjb2RlRW50aXRpZXModmFsdWUpOwogICAgfSk7CiAgICBpZiAoaGFuZGxlci5zdGFydCkgaGFuZGxlci5zdGFydCggdGFnTmFtZSwgYXR0cnMsIHVuYXJ5ICk7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUVuZFRhZyggdGFnLCB0YWdOYW1lICkgewogICAgdmFyIHBvcyA9IDAsIGk7CiAgICB0YWdOYW1lID0gYW5ndWxhci5sb3dlcmNhc2UodGFnTmFtZSk7CiAgICBpZiAoIHRhZ05hbWUgKQogICAgICAvLyBGaW5kIHRoZSBjbG9zZXN0IG9wZW5lZCB0YWcgb2YgdGhlIHNhbWUgdHlwZQogICAgICBmb3IgKCBwb3MgPSBzdGFjay5sZW5ndGggLSAxOyBwb3MgPj0gMDsgcG9zLS0gKQogICAgICAgIGlmICggc3RhY2tbIHBvcyBdID09IHRhZ05hbWUgKQogICAgICAgICAgYnJlYWs7CgogICAgaWYgKCBwb3MgPj0gMCApIHsKICAgICAgLy8gQ2xvc2UgYWxsIHRoZSBvcGVuIGVsZW1lbnRzLCB1cCB0aGUgc3RhY2sKICAgICAgZm9yICggaSA9IHN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gcG9zOyBpLS0gKQogICAgICAgIGlmIChoYW5kbGVyLmVuZCkgaGFuZGxlci5lbmQoIHN0YWNrWyBpIF0gKTsKCiAgICAgIC8vIFJlbW92ZSB0aGUgb3BlbiBlbGVtZW50cyBmcm9tIHRoZSBzdGFjawogICAgICBzdGFjay5sZW5ndGggPSBwb3M7CiAgICB9CiAgfQp9Cgp2YXIgaGlkZGVuUHJlPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInByZSIpOwp2YXIgc3BhY2VSZSA9IC9eKFxzKikoW1xzXFNdKj8pKFxzKikkLzsKLyoqCiAqIGRlY29kZXMgYWxsIGVudGl0aWVzIGludG8gcmVndWxhciBzdHJpbmcKICogQHBhcmFtIHZhbHVlCiAqIEByZXR1cm5zIHtzdHJpbmd9IEEgc3RyaW5nIHdpdGggZGVjb2RlZCBlbnRpdGllcy4KICovCmZ1bmN0aW9uIGRlY29kZUVudGl0aWVzKHZhbHVlKSB7CiAgaWYgKCF2YWx1ZSkgeyByZXR1cm4gJyc7IH0KCiAgLy8gTm90ZTogSUU4IGRvZXMgbm90IHByZXNlcnZlIHNwYWNlcyBhdCB0aGUgc3RhcnQvZW5kIG9mIGlubmVySFRNTAogIC8vIHNvIHdlIG11c3QgY2FwdHVyZSB0aGVtIGFuZCByZWF0dGFjaCB0aGVtIGFmdGVyd2FyZAogIHZhciBwYXJ0cyA9IHNwYWNlUmUuZXhlYyh2YWx1ZSk7CiAgdmFyIHNwYWNlQmVmb3JlID0gcGFydHNbMV07CiAgdmFyIHNwYWNlQWZ0ZXIgPSBwYXJ0c1szXTsKICB2YXIgY29udGVudCA9IHBhcnRzWzJdOwogIGlmIChjb250ZW50KSB7CiAgICBoaWRkZW5QcmUuaW5uZXJIVE1MPWNvbnRlbnQucmVwbGFjZSgvPC9nLCImbHQ7Iik7CiAgICAvLyBpbm5lclRleHQgZGVwZW5kcyBvbiBzdHlsaW5nIGFzIGl0IGRvZXNuJ3QgZGlzcGxheSBoaWRkZW4gZWxlbWVudHMuCiAgICAvLyBUaGVyZWZvcmUsIGl0J3MgYmV0dGVyIHRvIHVzZSB0ZXh0Q29udGVudCBub3QgdG8gY2F1c2UgdW5uZWNlc3NhcnkKICAgIC8vIHJlZmxvd3MuIEhvd2V2ZXIsIElFPDkgZG9uJ3Qgc3VwcG9ydCB0ZXh0Q29udGVudCBzbyB0aGUgaW5uZXJUZXh0CiAgICAvLyBmYWxsYmFjayBpcyBuZWNlc3NhcnkuCiAgICBjb250ZW50ID0gJ3RleHRDb250ZW50JyBpbiBoaWRkZW5QcmUgPwogICAgICBoaWRkZW5QcmUudGV4dENvbnRlbnQgOiBoaWRkZW5QcmUuaW5uZXJUZXh0OwogIH0KICByZXR1cm4gc3BhY2VCZWZvcmUgKyBjb250ZW50ICsgc3BhY2VBZnRlcjsKfQoKLyoqCiAqIEVzY2FwZXMgYWxsIHBvdGVudGlhbGx5IGRhbmdlcm91cyBjaGFyYWN0ZXJzLCBzbyB0aGF0IHRoZQogKiByZXN1bHRpbmcgc3RyaW5nIGNhbiBiZSBzYWZlbHkgaW5zZXJ0ZWQgaW50byBhdHRyaWJ1dGUgb3IKICogZWxlbWVudCB0ZXh0LgogKiBAcGFyYW0gdmFsdWUKICogQHJldHVybnMge3N0cmluZ30gZXNjYXBlZCB0ZXh0CiAqLwpmdW5jdGlvbiBlbmNvZGVFbnRpdGllcyh2YWx1ZSkgewogIHJldHVybiB2YWx1ZS4KICAgIHJlcGxhY2UoLyYvZywgJyZhbXA7JykuCiAgICByZXBsYWNlKFNVUlJPR0FURV9QQUlSX1JFR0VYUCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBoaSA9IHZhbHVlLmNoYXJDb2RlQXQoMCk7CiAgICAgIHZhciBsb3cgPSB2YWx1ZS5jaGFyQ29kZUF0KDEpOwogICAgICByZXR1cm4gJyYjJyArICgoKGhpIC0gMHhEODAwKSAqIDB4NDAwKSArIChsb3cgLSAweERDMDApICsgMHgxMDAwMCkgKyAnOyc7CiAgICB9KS4KICAgIHJlcGxhY2UoTk9OX0FMUEhBTlVNRVJJQ19SRUdFWFAsIGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICcmIycgKyB2YWx1ZS5jaGFyQ29kZUF0KDApICsgJzsnOwogICAgfSkuCiAgICByZXBsYWNlKC88L2csICcmbHQ7JykuCiAgICByZXBsYWNlKC8+L2csICcmZ3Q7Jyk7Cn0KCi8qKgogKiBjcmVhdGUgYW4gSFRNTC9YTUwgd3JpdGVyIHdoaWNoIHdyaXRlcyB0byBidWZmZXIKICogQHBhcmFtIHtBcnJheX0gYnVmIHVzZSBidWYuamFpbignJykgdG8gZ2V0IG91dCBzYW5pdGl6ZWQgaHRtbCBzdHJpbmcKICogQHJldHVybnMge29iamVjdH0gaW4gdGhlIGZvcm0gb2YgewogKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICogICAgIGVuZDogZnVuY3Rpb24odGFnKSB7fSwKICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAqIH0KICovCmZ1bmN0aW9uIGh0bWxTYW5pdGl6ZVdyaXRlcihidWYsIHVyaVZhbGlkYXRvcil7CiAgdmFyIGlnbm9yZSA9IGZhbHNlOwogIHZhciBvdXQgPSBhbmd1bGFyLmJpbmQoYnVmLCBidWYucHVzaCk7CiAgcmV0dXJuIHsKICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSl7CiAgICAgIHRhZyA9IGFuZ3VsYXIubG93ZXJjYXNlKHRhZyk7CiAgICAgIGlmICghaWdub3JlICYmIHNwZWNpYWxFbGVtZW50c1t0YWddKSB7CiAgICAgICAgaWdub3JlID0gdGFnOwogICAgICB9CiAgICAgIGlmICghaWdub3JlICYmIHZhbGlkRWxlbWVudHNbdGFnXSA9PT0gdHJ1ZSkgewogICAgICAgIG91dCgnPCcpOwogICAgICAgIG91dCh0YWcpOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChhdHRycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CiAgICAgICAgICB2YXIgbGtleT1hbmd1bGFyLmxvd2VyY2FzZShrZXkpOwogICAgICAgICAgdmFyIGlzSW1hZ2UgPSAodGFnID09PSAnaW1nJyAmJiBsa2V5ID09PSAnc3JjJykgfHwgKGxrZXkgPT09ICdiYWNrZ3JvdW5kJyk7CiAgICAgICAgICBpZiAodmFsaWRBdHRyc1tsa2V5XSA9PT0gdHJ1ZSAmJgogICAgICAgICAgICAodXJpQXR0cnNbbGtleV0gIT09IHRydWUgfHwgdXJpVmFsaWRhdG9yKHZhbHVlLCBpc0ltYWdlKSkpIHsKICAgICAgICAgICAgb3V0KCcgJyk7CiAgICAgICAgICAgIG91dChrZXkpOwogICAgICAgICAgICBvdXQoJz0iJyk7CiAgICAgICAgICAgIG91dChlbmNvZGVFbnRpdGllcyh2YWx1ZSkpOwogICAgICAgICAgICBvdXQoJyInKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBvdXQodW5hcnkgPyAnLz4nIDogJz4nKTsKICAgICAgfQogICAgfSwKICAgIGVuZDogZnVuY3Rpb24odGFnKXsKICAgICAgICB0YWcgPSBhbmd1bGFyLmxvd2VyY2FzZSh0YWcpOwogICAgICAgIGlmICghaWdub3JlICYmIHZhbGlkRWxlbWVudHNbdGFnXSA9PT0gdHJ1ZSkgewogICAgICAgICAgb3V0KCc8LycpOwogICAgICAgICAgb3V0KHRhZyk7CiAgICAgICAgICBvdXQoJz4nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRhZyA9PSBpZ25vcmUpIHsKICAgICAgICAgIGlnbm9yZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgIGNoYXJzOiBmdW5jdGlvbihjaGFycyl7CiAgICAgICAgaWYgKCFpZ25vcmUpIHsKICAgICAgICAgIG91dChlbmNvZGVFbnRpdGllcyhjaGFycykpOwogICAgICAgIH0KICAgICAgfQogIH07Cn0KCgovLyBkZWZpbmUgbmdTYW5pdGl6ZSBtb2R1bGUgYW5kIHJlZ2lzdGVyICRzYW5pdGl6ZSBzZXJ2aWNlCmFuZ3VsYXIubW9kdWxlKCduZ1Nhbml0aXplJywgW10pLnByb3ZpZGVyKCckc2FuaXRpemUnLCAkU2FuaXRpemVQcm92aWRlcik7CgovKiBnbG9iYWwgc2FuaXRpemVUZXh0OiBmYWxzZSAqLwoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgbGlua3kKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEZpbmRzIGxpbmtzIGluIHRleHQgaW5wdXQgYW5kIHR1cm5zIHRoZW0gaW50byBodG1sIGxpbmtzLiBTdXBwb3J0cyBodHRwL2h0dHBzL2Z0cC9tYWlsdG8gYW5kCiAqIHBsYWluIGVtYWlsIGFkZHJlc3MgbGlua3MuCiAqCiAqIFJlcXVpcmVzIHRoZSB7QGxpbmsgbmdTYW5pdGl6ZSBgbmdTYW5pdGl6ZWB9IG1vZHVsZSB0byBiZSBpbnN0YWxsZWQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IElucHV0IHRleHQuCiAqIEBwYXJhbSB7c3RyaW5nfSB0YXJnZXQgV2luZG93IChfYmxhbmt8X3NlbGZ8X3BhcmVudHxfdG9wKSBvciBuYW1lZCBmcmFtZSB0byBvcGVuIGxpbmtzIGluLgogKiBAcmV0dXJucyB7c3RyaW5nfSBIdG1sLWxpbmtpZmllZCB0ZXh0LgogKgogKiBAdXNhZ2UKICAgPHNwYW4gbmctYmluZC1odG1sPSJsaW5reV9leHByZXNzaW9uIHwgbGlua3kiPjwvc3Bhbj4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1Nhbml0aXplIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnNuaXBwZXQgPQogICAgICAgICAgICAgJ1ByZXR0eSB0ZXh0IHdpdGggc29tZSBsaW5rczpcbicrCiAgICAgICAgICAgICAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvLFxuJysKICAgICAgICAgICAgICdtYWlsdG86dXNAc29tZXdoZXJlLm9yZyxcbicrCiAgICAgICAgICAgICAnYW5vdGhlckBzb21ld2hlcmUub3JnLFxuJysKICAgICAgICAgICAgICdhbmQgb25lIG1vcmU6IGZ0cDovLzEyNy4wLjAuMS8uJzsKICAgICAgICAgICAkc2NvcGUuc25pcHBldFdpdGhUYXJnZXQgPSAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvJzsKICAgICAgICAgfQogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgU25pcHBldDogPHRleHRhcmVhIG5nLW1vZGVsPSJzbmlwcGV0IiBjb2xzPSI2MCIgcm93cz0iMyI+PC90ZXh0YXJlYT4KICAgICAgIDx0YWJsZT4KICAgICAgICAgPHRyPgogICAgICAgICAgIDx0ZD5GaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD5Tb3VyY2U8L3RkPgogICAgICAgICAgIDx0ZD5SZW5kZXJlZDwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0ibGlua3ktZmlsdGVyIj4KICAgICAgICAgICA8dGQ+bGlua3kgZmlsdGVyPC90ZD4KICAgICAgICAgICA8dGQ+CiAgICAgICAgICAgICA8cHJlPiZsdDtkaXYgbmctYmluZC1odG1sPSJzbmlwcGV0IHwgbGlua3kiJmd0Ozxicj4mbHQ7L2RpdiZndDs8L3ByZT4KICAgICAgICAgICA8L3RkPgogICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgIDxkaXYgbmctYmluZC1odG1sPSJzbmlwcGV0IHwgbGlua3kiPjwvZGl2PgogICAgICAgICAgIDwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0ibGlua3ktdGFyZ2V0Ij4KICAgICAgICAgIDx0ZD5saW5reSB0YXJnZXQ8L3RkPgogICAgICAgICAgPHRkPgogICAgICAgICAgICA8cHJlPiZsdDtkaXYgbmctYmluZC1odG1sPSJzbmlwcGV0V2l0aFRhcmdldCB8IGxpbmt5OidfYmxhbmsnIiZndDs8YnI+Jmx0Oy9kaXYmZ3Q7PC9wcmU+CiAgICAgICAgICA8L3RkPgogICAgICAgICAgPHRkPgogICAgICAgICAgICA8ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldFdpdGhUYXJnZXQgfCBsaW5reTonX2JsYW5rJyI+PC9kaXY+CiAgICAgICAgICA8L3RkPgogICAgICAgICA8L3RyPgogICAgICAgICA8dHIgaWQ9ImVzY2FwZWQtaHRtbCI+CiAgICAgICAgICAgPHRkPm5vIGZpbHRlcjwvdGQ+CiAgICAgICAgICAgPHRkPjxwcmU+Jmx0O2RpdiBuZy1iaW5kPSJzbmlwcGV0IiZndDs8YnI+Jmx0Oy9kaXYmZ3Q7PC9wcmU+PC90ZD4KICAgICAgICAgICA8dGQ+PGRpdiBuZy1iaW5kPSJzbmlwcGV0Ij48L2Rpdj48L3RkPgogICAgICAgICA8L3RyPgogICAgICAgPC90YWJsZT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGxpbmtpZnkgdGhlIHNuaXBwZXQgd2l0aCB1cmxzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5reS1maWx0ZXInKSkuZWxlbWVudChieS5iaW5kaW5nKCdzbmlwcGV0IHwgbGlua3knKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgIHRvQmUoJ1ByZXR0eSB0ZXh0IHdpdGggc29tZSBsaW5rczogaHR0cDovL2FuZ3VsYXJqcy5vcmcvLCB1c0Bzb21ld2hlcmUub3JnLCAnICsKICAgICAgICAgICAgICAgICAgJ2Fub3RoZXJAc29tZXdoZXJlLm9yZywgYW5kIG9uZSBtb3JlOiBmdHA6Ly8xMjcuMC4wLjEvLicpOwogICAgICAgICBleHBlY3QoZWxlbWVudC5hbGwoYnkuY3NzKCcjbGlua3ktZmlsdGVyIGEnKSkuY291bnQoKSkudG9FcXVhbCg0KTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgbm90IGxpbmtpZnkgc25pcHBldCB3aXRob3V0IHRoZSBsaW5reSBmaWx0ZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2VzY2FwZWQtaHRtbCcpKS5lbGVtZW50KGJ5LmJpbmRpbmcoJ3NuaXBwZXQnKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgIHRvQmUoJ1ByZXR0eSB0ZXh0IHdpdGggc29tZSBsaW5rczogaHR0cDovL2FuZ3VsYXJqcy5vcmcvLCBtYWlsdG86dXNAc29tZXdoZXJlLm9yZywgJyArCiAgICAgICAgICAgICAgICAgICdhbm90aGVyQHNvbWV3aGVyZS5vcmcsIGFuZCBvbmUgbW9yZTogZnRwOi8vMTI3LjAuMC4xLy4nKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQuYWxsKGJ5LmNzcygnI2VzY2FwZWQtaHRtbCBhJykpLmNvdW50KCkpLnRvRXF1YWwoMCk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzbmlwcGV0JykpLmNsZWFyKCk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3NuaXBwZXQnKSkuc2VuZEtleXMoJ25ldyBodHRwOi8vbGluay4nKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmt5LWZpbHRlcicpKS5lbGVtZW50KGJ5LmJpbmRpbmcoJ3NuaXBwZXQgfCBsaW5reScpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICAgdG9CZSgnbmV3IGh0dHA6Ly9saW5rLicpOwogICAgICAgICBleHBlY3QoZWxlbWVudC5hbGwoYnkuY3NzKCcjbGlua3ktZmlsdGVyIGEnKSkuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2VzY2FwZWQtaHRtbCcpKS5lbGVtZW50KGJ5LmJpbmRpbmcoJ3NuaXBwZXQnKSkuZ2V0VGV4dCgpKQogICAgICAgICAgICAgLnRvQmUoJ25ldyBodHRwOi8vbGluay4nKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgd29yayB3aXRoIHRoZSB0YXJnZXQgcHJvcGVydHknLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGlua3ktdGFyZ2V0JykpLgogICAgICAgICAgICBlbGVtZW50KGJ5LmJpbmRpbmcoInNuaXBwZXRXaXRoVGFyZ2V0IHwgbGlua3k6J19ibGFuayciKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgdG9CZSgnaHR0cDovL2FuZ3VsYXJqcy5vcmcvJyk7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjbGlua3ktdGFyZ2V0IGEnKSkuZ2V0QXR0cmlidXRlKCd0YXJnZXQnKSkudG9FcXVhbCgnX2JsYW5rJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmFuZ3VsYXIubW9kdWxlKCduZ1Nhbml0aXplJykuZmlsdGVyKCdsaW5reScsIFsnJHNhbml0aXplJywgZnVuY3Rpb24oJHNhbml0aXplKSB7CiAgdmFyIExJTktZX1VSTF9SRUdFWFAgPQogICAgICAgIC8oKGZ0cHxodHRwcz8pOlwvXC98KG1haWx0bzopP1tBLVphLXowLTkuXyUrLV0rQClcUypbXlxzLjssKCl7fTw+XS8sCiAgICAgIE1BSUxUT19SRUdFWFAgPSAvXm1haWx0bzovOwoKICByZXR1cm4gZnVuY3Rpb24odGV4dCwgdGFyZ2V0KSB7CiAgICBpZiAoIXRleHQpIHJldHVybiB0ZXh0OwogICAgdmFyIG1hdGNoOwogICAgdmFyIHJhdyA9IHRleHQ7CiAgICB2YXIgaHRtbCA9IFtdOwogICAgdmFyIHVybDsKICAgIHZhciBpOwogICAgd2hpbGUgKChtYXRjaCA9IHJhdy5tYXRjaChMSU5LWV9VUkxfUkVHRVhQKSkpIHsKICAgICAgLy8gV2UgY2FuIG5vdCBlbmQgaW4gdGhlc2UgYXMgdGhleSBhcmUgc29tZXRpbWVzIGZvdW5kIGF0IHRoZSBlbmQgb2YgdGhlIHNlbnRlbmNlCiAgICAgIHVybCA9IG1hdGNoWzBdOwogICAgICAvLyBpZiB3ZSBkaWQgbm90IG1hdGNoIGZ0cC9odHRwL21haWx0byB0aGVuIGFzc3VtZSBtYWlsdG8KICAgICAgaWYgKG1hdGNoWzJdID09IG1hdGNoWzNdKSB1cmwgPSAnbWFpbHRvOicgKyB1cmw7CiAgICAgIGkgPSBtYXRjaC5pbmRleDsKICAgICAgYWRkVGV4dChyYXcuc3Vic3RyKDAsIGkpKTsKICAgICAgYWRkTGluayh1cmwsIG1hdGNoWzBdLnJlcGxhY2UoTUFJTFRPX1JFR0VYUCwgJycpKTsKICAgICAgcmF3ID0gcmF3LnN1YnN0cmluZyhpICsgbWF0Y2hbMF0ubGVuZ3RoKTsKICAgIH0KICAgIGFkZFRleHQocmF3KTsKICAgIHJldHVybiAkc2FuaXRpemUoaHRtbC5qb2luKCcnKSk7CgogICAgZnVuY3Rpb24gYWRkVGV4dCh0ZXh0KSB7CiAgICAgIGlmICghdGV4dCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBodG1sLnB1c2goc2FuaXRpemVUZXh0KHRleHQpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRMaW5rKHVybCwgdGV4dCkgewogICAgICBodG1sLnB1c2goJzxhICcpOwogICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQodGFyZ2V0KSkgewogICAgICAgIGh0bWwucHVzaCgndGFyZ2V0PSInKTsKICAgICAgICBodG1sLnB1c2godGFyZ2V0KTsKICAgICAgICBodG1sLnB1c2goJyIgJyk7CiAgICAgIH0KICAgICAgaHRtbC5wdXNoKCdocmVmPSInKTsKICAgICAgaHRtbC5wdXNoKHVybCk7CiAgICAgIGh0bWwucHVzaCgnIj4nKTsKICAgICAgYWRkVGV4dCh0ZXh0KTsKICAgICAgaHRtbC5wdXNoKCc8L2E+Jyk7CiAgICB9CiAgfTsKfV0pOwoKCn0pKHdpbmRvdywgd2luZG93LmFuZ3VsYXIpOwoKLyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qKgogKiBTdGF0ZS1iYXNlZCByb3V0aW5nIGZvciBBbmd1bGFySlMKICogQHZlcnNpb24gdjAuMi4xMAogKiBAbGluayBodHRwOi8vYW5ndWxhci11aS5naXRodWIuY29tLwogKiBAbGljZW5zZSBNSVQgTGljZW5zZSwgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVQKICovCgovKiBjb21tb25qcyBwYWNrYWdlIG1hbmFnZXIgc3VwcG9ydCAoZWcgY29tcG9uZW50anMpICovCmlmICh0eXBlb2YgbW9kdWxlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZXhwb3J0cyAhPT0gInVuZGVmaW5lZCIgJiYgbW9kdWxlLmV4cG9ydHMgPT09IGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzID0gJ3VpLnJvdXRlcic7Cn0KCihmdW5jdGlvbiAod2luZG93LCBhbmd1bGFyLCB1bmRlZmluZWQpIHsKLypqc2hpbnQgZ2xvYmFsc3RyaWN0OnRydWUqLwovKmdsb2JhbCBhbmd1bGFyOmZhbHNlKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIGlzRGVmaW5lZCA9IGFuZ3VsYXIuaXNEZWZpbmVkLAogICAgaXNGdW5jdGlvbiA9IGFuZ3VsYXIuaXNGdW5jdGlvbiwKICAgIGlzU3RyaW5nID0gYW5ndWxhci5pc1N0cmluZywKICAgIGlzT2JqZWN0ID0gYW5ndWxhci5pc09iamVjdCwKICAgIGlzQXJyYXkgPSBhbmd1bGFyLmlzQXJyYXksCiAgICBmb3JFYWNoID0gYW5ndWxhci5mb3JFYWNoLAogICAgZXh0ZW5kID0gYW5ndWxhci5leHRlbmQsCiAgICBjb3B5ID0gYW5ndWxhci5jb3B5OwoKZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbigpIHt9LCB7IHByb3RvdHlwZTogcGFyZW50IH0pKSgpLCBleHRyYSk7Cn0KCmZ1bmN0aW9uIG1lcmdlKGRzdCkgewogIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogIT09IGRzdCkgewogICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmICghZHN0Lmhhc093blByb3BlcnR5KGtleSkpIGRzdFtrZXldID0gdmFsdWU7CiAgICAgIH0pOwogICAgfQogIH0pOwogIHJldHVybiBkc3Q7Cn0KCi8qKgogKiBGaW5kcyB0aGUgY29tbW9uIGFuY2VzdG9yIHBhdGggYmV0d2VlbiB0d28gc3RhdGVzLgogKgogKiBAcGFyYW0ge09iamVjdH0gZmlyc3QgVGhlIGZpcnN0IHN0YXRlLgogKiBAcGFyYW0ge09iamVjdH0gc2Vjb25kIFRoZSBzZWNvbmQgc3RhdGUuCiAqIEByZXR1cm4ge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIHN0YXRlIG5hbWVzIGluIGRlc2NlbmRpbmcgb3JkZXIsIG5vdCBpbmNsdWRpbmcgdGhlIHJvb3QuCiAqLwpmdW5jdGlvbiBhbmNlc3RvcnMoZmlyc3QsIHNlY29uZCkgewogIHZhciBwYXRoID0gW107CgogIGZvciAodmFyIG4gaW4gZmlyc3QucGF0aCkgewogICAgaWYgKGZpcnN0LnBhdGhbbl0gIT09IHNlY29uZC5wYXRoW25dKSBicmVhazsKICAgIHBhdGgucHVzaChmaXJzdC5wYXRoW25dKTsKICB9CiAgcmV0dXJuIHBhdGg7Cn0KCi8qKgogKiBJRTgtc2FmZSB3cmFwcGVyIGZvciBgT2JqZWN0LmtleXMoKWAuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgQSBKYXZhU2NyaXB0IG9iamVjdC4KICogQHJldHVybiB7QXJyYXl9IFJldHVybnMgdGhlIGtleXMgb2YgdGhlIG9iamVjdCBhcyBhbiBhcnJheS4KICovCmZ1bmN0aW9uIGtleXMob2JqZWN0KSB7CiAgaWYgKE9iamVjdC5rZXlzKSB7CiAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KTsKICB9CiAgdmFyIHJlc3VsdCA9IFtdOwoKICBhbmd1bGFyLmZvckVhY2gob2JqZWN0LCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgcmVzdWx0LnB1c2goa2V5KTsKICB9KTsKICByZXR1cm4gcmVzdWx0Owp9CgovKioKICogSUU4LXNhZmUgd3JhcHBlciBmb3IgYEFycmF5LnByb3RvdHlwZS5pbmRleE9mKClgLgogKgogKiBAcGFyYW0ge0FycmF5fSBhcnJheSBBIEphdmFTY3JpcHQgYXJyYXkuCiAqIEBwYXJhbSB7Kn0gdmFsdWUgQSB2YWx1ZSB0byBzZWFyY2ggdGhlIGFycmF5IGZvci4KICogQHJldHVybiB7TnVtYmVyfSBSZXR1cm5zIHRoZSBhcnJheSBpbmRleCB2YWx1ZSBvZiBgdmFsdWVgLCBvciBgLTFgIGlmIG5vdCBwcmVzZW50LgogKi8KZnVuY3Rpb24gYXJyYXlTZWFyY2goYXJyYXksIHZhbHVlKSB7CiAgaWYgKEFycmF5LnByb3RvdHlwZS5pbmRleE9mKSB7CiAgICByZXR1cm4gYXJyYXkuaW5kZXhPZih2YWx1ZSwgTnVtYmVyKGFyZ3VtZW50c1syXSkgfHwgMCk7CiAgfQogIHZhciBsZW4gPSBhcnJheS5sZW5ndGggPj4+IDAsIGZyb20gPSBOdW1iZXIoYXJndW1lbnRzWzJdKSB8fCAwOwogIGZyb20gPSAoZnJvbSA8IDApID8gTWF0aC5jZWlsKGZyb20pIDogTWF0aC5mbG9vcihmcm9tKTsKCiAgaWYgKGZyb20gPCAwKSBmcm9tICs9IGxlbjsKCiAgZm9yICg7IGZyb20gPCBsZW47IGZyb20rKykgewogICAgaWYgKGZyb20gaW4gYXJyYXkgJiYgYXJyYXlbZnJvbV0gPT09IHZhbHVlKSByZXR1cm4gZnJvbTsKICB9CiAgcmV0dXJuIC0xOwp9CgovKioKICogTWVyZ2VzIGEgc2V0IG9mIHBhcmFtZXRlcnMgd2l0aCBhbGwgcGFyYW1ldGVycyBpbmhlcml0ZWQgYmV0d2VlbiB0aGUgY29tbW9uIHBhcmVudHMgb2YgdGhlCiAqIGN1cnJlbnQgc3RhdGUgYW5kIGEgZ2l2ZW4gZGVzdGluYXRpb24gc3RhdGUuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBjdXJyZW50UGFyYW1zIFRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBzdGF0ZSBwYXJhbWV0ZXJzICgkc3RhdGVQYXJhbXMpLgogKiBAcGFyYW0ge09iamVjdH0gbmV3UGFyYW1zIFRoZSBzZXQgb2YgcGFyYW1ldGVycyB3aGljaCB3aWxsIGJlIGNvbXBvc2l0ZWQgd2l0aCBpbmhlcml0ZWQgcGFyYW1zLgogKiBAcGFyYW0ge09iamVjdH0gJGN1cnJlbnQgSW50ZXJuYWwgZGVmaW5pdGlvbiBvZiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBjdXJyZW50IHN0YXRlLgogKiBAcGFyYW0ge09iamVjdH0gJHRvIEludGVybmFsIGRlZmluaXRpb24gb2Ygb2JqZWN0IHJlcHJlc2VudGluZyBzdGF0ZSB0byB0cmFuc2l0aW9uIHRvLgogKi8KZnVuY3Rpb24gaW5oZXJpdFBhcmFtcyhjdXJyZW50UGFyYW1zLCBuZXdQYXJhbXMsICRjdXJyZW50LCAkdG8pIHsKICB2YXIgcGFyZW50cyA9IGFuY2VzdG9ycygkY3VycmVudCwgJHRvKSwgcGFyZW50UGFyYW1zLCBpbmhlcml0ZWQgPSB7fSwgaW5oZXJpdExpc3QgPSBbXTsKCiAgZm9yICh2YXIgaSBpbiBwYXJlbnRzKSB7CiAgICBpZiAoIXBhcmVudHNbaV0ucGFyYW1zIHx8ICFwYXJlbnRzW2ldLnBhcmFtcy5sZW5ndGgpIGNvbnRpbnVlOwogICAgcGFyZW50UGFyYW1zID0gcGFyZW50c1tpXS5wYXJhbXM7CgogICAgZm9yICh2YXIgaiBpbiBwYXJlbnRQYXJhbXMpIHsKICAgICAgaWYgKGFycmF5U2VhcmNoKGluaGVyaXRMaXN0LCBwYXJlbnRQYXJhbXNbal0pID49IDApIGNvbnRpbnVlOwogICAgICBpbmhlcml0TGlzdC5wdXNoKHBhcmVudFBhcmFtc1tqXSk7CiAgICAgIGluaGVyaXRlZFtwYXJlbnRQYXJhbXNbal1dID0gY3VycmVudFBhcmFtc1twYXJlbnRQYXJhbXNbal1dOwogICAgfQogIH0KICByZXR1cm4gZXh0ZW5kKHt9LCBpbmhlcml0ZWQsIG5ld1BhcmFtcyk7Cn0KCi8qKgogKiBOb3JtYWxpemVzIGEgc2V0IG9mIHZhbHVlcyB0byBzdHJpbmcgb3IgYG51bGxgLCBmaWx0ZXJpbmcgdGhlbSBieSBhIGxpc3Qgb2Yga2V5cy4KICoKICogQHBhcmFtIHtBcnJheX0ga2V5cyBUaGUgbGlzdCBvZiBrZXlzIHRvIG5vcm1hbGl6ZS9yZXR1cm4uCiAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZXMgQW4gb2JqZWN0IGhhc2ggb2YgdmFsdWVzIHRvIG5vcm1hbGl6ZS4KICogQHJldHVybiB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBoYXNoIG9mIG5vcm1hbGl6ZWQgc3RyaW5nIHZhbHVlcy4KICovCmZ1bmN0aW9uIG5vcm1hbGl6ZShrZXlzLCB2YWx1ZXMpIHsKICB2YXIgbm9ybWFsaXplZCA9IHt9OwoKICBmb3JFYWNoKGtleXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIgdmFsdWUgPSB2YWx1ZXNbbmFtZV07CiAgICBub3JtYWxpemVkW25hbWVdID0gKHZhbHVlICE9IG51bGwpID8gU3RyaW5nKHZhbHVlKSA6IG51bGw7CiAgfSk7CiAgcmV0dXJuIG5vcm1hbGl6ZWQ7Cn0KCi8qKgogKiBQZXJmb3JtcyBhIG5vbi1zdHJpY3QgY29tcGFyaXNvbiBvZiB0aGUgc3Vic2V0IG9mIHR3byBvYmplY3RzLCBkZWZpbmVkIGJ5IGEgbGlzdCBvZiBrZXlzLgogKgogKiBAcGFyYW0ge09iamVjdH0gYSBUaGUgZmlyc3Qgb2JqZWN0LgogKiBAcGFyYW0ge09iamVjdH0gYiBUaGUgc2Vjb25kIG9iamVjdC4KICogQHBhcmFtIHtBcnJheX0ga2V5cyBUaGUgbGlzdCBvZiBrZXlzIHdpdGhpbiBlYWNoIG9iamVjdCB0byBjb21wYXJlLiBJZiB0aGUgbGlzdCBpcyBlbXB0eSBvciBub3Qgc3BlY2lmaWVkLAogKiAgICAgICAgICAgICAgICAgICAgIGl0IGRlZmF1bHRzIHRvIHRoZSBsaXN0IG9mIGtleXMgaW4gYGFgLgogKiBAcmV0dXJuIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUga2V5cyBtYXRjaCwgb3RoZXJ3aXNlIGBmYWxzZWAuCiAqLwpmdW5jdGlvbiBlcXVhbEZvcktleXMoYSwgYiwga2V5cykgewogIGlmICgha2V5cykgewogICAga2V5cyA9IFtdOwogICAgZm9yICh2YXIgbiBpbiBhKSBrZXlzLnB1c2gobik7IC8vIFVzZWQgaW5zdGVhZCBvZiBPYmplY3Qua2V5cygpIGZvciBJRTggY29tcGF0aWJpbGl0eQogIH0KCiAgZm9yICh2YXIgaT0wOyBpPGtleXMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBrID0ga2V5c1tpXTsKICAgIGlmIChhW2tdICE9IGJba10pIHJldHVybiBmYWxzZTsgLy8gTm90ICc9PT0nLCB2YWx1ZXMgYXJlbid0IG5lY2Vzc2FyaWx5IG5vcm1hbGl6ZWQKICB9CiAgcmV0dXJuIHRydWU7Cn0KCi8qKgogKiBSZXR1cm5zIHRoZSBzdWJzZXQgb2YgYW4gb2JqZWN0LCBiYXNlZCBvbiBhIGxpc3Qgb2Yga2V5cy4KICoKICogQHBhcmFtIHtBcnJheX0ga2V5cwogKiBAcGFyYW0ge09iamVjdH0gdmFsdWVzCiAqIEByZXR1cm4ge0Jvb2xlYW59IFJldHVybnMgYSBzdWJzZXQgb2YgYHZhbHVlc2AuCiAqLwpmdW5jdGlvbiBmaWx0ZXJCeUtleXMoa2V5cywgdmFsdWVzKSB7CiAgdmFyIGZpbHRlcmVkID0ge307CgogIGZvckVhY2goa2V5cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgIGZpbHRlcmVkW25hbWVdID0gdmFsdWVzW25hbWVdOwogIH0pOwogIHJldHVybiBmaWx0ZXJlZDsKfQovKioKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIHVpLnJvdXRlci51dGlsCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAjIHVpLnJvdXRlci51dGlsIHN1Yi1tb2R1bGUKICoKICogVGhpcyBtb2R1bGUgaXMgYSBkZXBlbmRlbmN5IG9mIG90aGVyIHN1Yi1tb2R1bGVzLiBEbyBub3QgaW5jbHVkZSB0aGlzIG1vZHVsZSBhcyBhIGRlcGVuZGVuY3kKICogaW4geW91ciBhbmd1bGFyIGFwcCAodXNlIHtAbGluayB1aS5yb3V0ZXJ9IG1vZHVsZSBpbnN0ZWFkKS4KICoKICovCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIudXRpbCcsIFsnbmcnXSk7CgovKioKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIKICogCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIudXRpbAogKgogKiBAZGVzY3JpcHRpb24KICogIyB1aS5yb3V0ZXIucm91dGVyIHN1Yi1tb2R1bGUKICoKICogVGhpcyBtb2R1bGUgaXMgYSBkZXBlbmRlbmN5IG9mIG90aGVyIHN1Yi1tb2R1bGVzLiBEbyBub3QgaW5jbHVkZSB0aGlzIG1vZHVsZSBhcyBhIGRlcGVuZGVuY3kKICogaW4geW91ciBhbmd1bGFyIGFwcCAodXNlIHtAbGluayB1aS5yb3V0ZXJ9IG1vZHVsZSBpbnN0ZWFkKS4KICovCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIucm91dGVyJywgWyd1aS5yb3V0ZXIudXRpbCddKTsKCi8qKgogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgdWkucm91dGVyLnN0YXRlCiAqIAogKiBAcmVxdWlyZXMgdWkucm91dGVyLnJvdXRlcgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwKICoKICogQGRlc2NyaXB0aW9uCiAqICMgdWkucm91dGVyLnN0YXRlIHN1Yi1tb2R1bGUKICoKICogVGhpcyBtb2R1bGUgaXMgYSBkZXBlbmRlbmN5IG9mIHRoZSBtYWluIHVpLnJvdXRlciBtb2R1bGUuIERvIG5vdCBpbmNsdWRlIHRoaXMgbW9kdWxlIGFzIGEgZGVwZW5kZW5jeQogKiBpbiB5b3VyIGFuZ3VsYXIgYXBwICh1c2Uge0BsaW5rIHVpLnJvdXRlcn0gbW9kdWxlIGluc3RlYWQpLgogKiAKICovCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnLCBbJ3VpLnJvdXRlci5yb3V0ZXInLCAndWkucm91dGVyLnV0aWwnXSk7CgovKioKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIHVpLnJvdXRlcgogKgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAjIHVpLnJvdXRlcgogKiAKICogIyMgVGhlIG1haW4gbW9kdWxlIGZvciB1aS5yb3V0ZXIgCiAqIFRoZXJlIGFyZSBzZXZlcmFsIHN1Yi1tb2R1bGVzIGluY2x1ZGVkIHdpdGggdGhlIHVpLnJvdXRlciBtb2R1bGUsIGhvd2V2ZXIgb25seSB0aGlzIG1vZHVsZSBpcyBuZWVkZWQKICogYXMgYSBkZXBlbmRlbmN5IHdpdGhpbiB5b3VyIGFuZ3VsYXIgYXBwLiBUaGUgb3RoZXIgbW9kdWxlcyBhcmUgZm9yIG9yZ2FuaXphdGlvbiBwdXJwb3Nlcy4gCiAqCiAqIFRoZSBtb2R1bGVzIGFyZToKICogKiB1aS5yb3V0ZXIgLSB0aGUgbWFpbiAidW1icmVsbGEiIG1vZHVsZQogKiAqIHVpLnJvdXRlci5yb3V0ZXIgLSAKICogCiAqICpZb3UnbGwgbmVlZCB0byBpbmNsdWRlICoqb25seSoqIHRoaXMgbW9kdWxlIGFzIHRoZSBkZXBlbmRlbmN5IHdpdGhpbiB5b3VyIGFuZ3VsYXIgYXBwLioKICogCiAqIDxwcmU+CiAqIDwhZG9jdHlwZSBodG1sPgogKiA8aHRtbCBuZy1hcHA9Im15QXBwIj4KICogPGhlYWQ+CiAqICAgPHNjcmlwdCBzcmM9ImpzL2FuZ3VsYXIuanMiPjwvc2NyaXB0PgogKiAgIDwhLS0gSW5jbHVkZSB0aGUgdWktcm91dGVyIHNjcmlwdCAtLT4KICogICA8c2NyaXB0IHNyYz0ianMvYW5ndWxhci11aS1yb3V0ZXIubWluLmpzIj48L3NjcmlwdD4KICogICA8c2NyaXB0PgogKiAgICAgLy8gLi4uYW5kIGFkZCAndWkucm91dGVyJyBhcyBhIGRlcGVuZGVuY3kKICogICAgIHZhciBteUFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFsndWkucm91dGVyJ10pOwogKiAgIDwvc2NyaXB0PgogKiA8L2hlYWQ+CiAqIDxib2R5PgogKiA8L2JvZHk+CiAqIDwvaHRtbD4KICogPC9wcmU+CiAqLwphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyJywgWyd1aS5yb3V0ZXIuc3RhdGUnXSk7Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLmNvbXBhdCcsIFsndWkucm91dGVyJ10pOwoKLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHJlc29sdmUKICoKICogQHJlcXVpcmVzICRxCiAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICoKICogQGRlc2NyaXB0aW9uCiAqIE1hbmFnZXMgcmVzb2x1dGlvbiBvZiAoYWN5Y2xpYykgZ3JhcGhzIG9mIHByb21pc2VzLgogKi8KJFJlc29sdmUuJGluamVjdCA9IFsnJHEnLCAnJGluamVjdG9yJ107CmZ1bmN0aW9uICRSZXNvbHZlKCAgJHEsICAgICRpbmplY3RvcikgewogIAogIHZhciBWSVNJVF9JTl9QUk9HUkVTUyA9IDEsCiAgICAgIFZJU0lUX0RPTkUgPSAyLAogICAgICBOT1RISU5HID0ge30sCiAgICAgIE5PX0RFUEVOREVOQ0lFUyA9IFtdLAogICAgICBOT19MT0NBTFMgPSBOT1RISU5HLAogICAgICBOT19QQVJFTlQgPSBleHRlbmQoJHEud2hlbihOT1RISU5HKSwgeyAkJHByb21pc2VzOiBOT1RISU5HLCAkJHZhbHVlczogTk9USElORyB9KTsKICAKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHJlc29sdmUjc3R1ZHkKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHJlc29sdmUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFN0dWRpZXMgYSBzZXQgb2YgaW52b2NhYmxlcyB0aGF0IGFyZSBsaWtlbHkgdG8gYmUgdXNlZCBtdWx0aXBsZSB0aW1lcy4KICAgKiA8cHJlPgogICAqICRyZXNvbHZlLnN0dWR5KGludm9jYWJsZXMpKGxvY2FscywgcGFyZW50LCBzZWxmKQogICAqIDwvcHJlPgogICAqIGlzIGVxdWl2YWxlbnQgdG8KICAgKiA8cHJlPgogICAqICRyZXNvbHZlLnJlc29sdmUoaW52b2NhYmxlcywgbG9jYWxzLCBwYXJlbnQsIHNlbGYpCiAgICogPC9wcmU+CiAgICogYnV0IHRoZSBmb3JtZXIgaXMgbW9yZSBlZmZpY2llbnQgKGluIGZhY3QgYHJlc29sdmVgIGp1c3QgY2FsbHMgYHN0dWR5YCAKICAgKiBpbnRlcm5hbGx5KS4KICAgKgogICAqIEBwYXJhbSB7b2JqZWN0fSBpbnZvY2FibGVzIEludm9jYWJsZSBvYmplY3RzCiAgICogQHJldHVybiB7ZnVuY3Rpb259IGEgZnVuY3Rpb24gdG8gcGFzcyBpbiBsb2NhbHMsIHBhcmVudCBhbmQgc2VsZgogICAqLwogIHRoaXMuc3R1ZHkgPSBmdW5jdGlvbiAoaW52b2NhYmxlcykgewogICAgaWYgKCFpc09iamVjdChpbnZvY2FibGVzKSkgdGhyb3cgbmV3IEVycm9yKCInaW52b2NhYmxlcycgbXVzdCBiZSBhbiBvYmplY3QiKTsKICAgIAogICAgLy8gUGVyZm9ybSBhIHRvcG9sb2dpY2FsIHNvcnQgb2YgaW52b2NhYmxlcyB0byBidWlsZCBhbiBvcmRlcmVkIHBsYW4KICAgIHZhciBwbGFuID0gW10sIGN5Y2xlID0gW10sIHZpc2l0ZWQgPSB7fTsKICAgIGZ1bmN0aW9uIHZpc2l0KHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKHZpc2l0ZWRba2V5XSA9PT0gVklTSVRfRE9ORSkgcmV0dXJuOwogICAgICAKICAgICAgY3ljbGUucHVzaChrZXkpOwogICAgICBpZiAodmlzaXRlZFtrZXldID09PSBWSVNJVF9JTl9QUk9HUkVTUykgewogICAgICAgIGN5Y2xlLnNwbGljZSgwLCBjeWNsZS5pbmRleE9mKGtleSkpOwogICAgICAgIHRocm93IG5ldyBFcnJvcigiQ3ljbGljIGRlcGVuZGVuY3k6ICIgKyBjeWNsZS5qb2luKCIgLT4gIikpOwogICAgICB9CiAgICAgIHZpc2l0ZWRba2V5XSA9IFZJU0lUX0lOX1BST0dSRVNTOwogICAgICAKICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgIHBsYW4ucHVzaChrZXksIFsgZnVuY3Rpb24oKSB7IHJldHVybiAkaW5qZWN0b3IuZ2V0KHZhbHVlKTsgfV0sIE5PX0RFUEVOREVOQ0lFUyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBhcmFtcyA9ICRpbmplY3Rvci5hbm5vdGF0ZSh2YWx1ZSk7CiAgICAgICAgZm9yRWFjaChwYXJhbXMsIGZ1bmN0aW9uIChwYXJhbSkgewogICAgICAgICAgaWYgKHBhcmFtICE9PSBrZXkgJiYgaW52b2NhYmxlcy5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHZpc2l0KGludm9jYWJsZXNbcGFyYW1dLCBwYXJhbSk7CiAgICAgICAgfSk7CiAgICAgICAgcGxhbi5wdXNoKGtleSwgdmFsdWUsIHBhcmFtcyk7CiAgICAgIH0KICAgICAgCiAgICAgIGN5Y2xlLnBvcCgpOwogICAgICB2aXNpdGVkW2tleV0gPSBWSVNJVF9ET05FOwogICAgfQogICAgZm9yRWFjaChpbnZvY2FibGVzLCB2aXNpdCk7CiAgICBpbnZvY2FibGVzID0gY3ljbGUgPSB2aXNpdGVkID0gbnVsbDsgLy8gcGxhbiBpcyBhbGwgdGhhdCdzIHJlcXVpcmVkCiAgICAKICAgIGZ1bmN0aW9uIGlzUmVzb2x2ZSh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3QodmFsdWUpICYmIHZhbHVlLnRoZW4gJiYgdmFsdWUuJCRwcm9taXNlczsKICAgIH0KICAgIAogICAgcmV0dXJuIGZ1bmN0aW9uIChsb2NhbHMsIHBhcmVudCwgc2VsZikgewogICAgICBpZiAoaXNSZXNvbHZlKGxvY2FscykgJiYgc2VsZiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgc2VsZiA9IHBhcmVudDsgcGFyZW50ID0gbG9jYWxzOyBsb2NhbHMgPSBudWxsOwogICAgICB9CiAgICAgIGlmICghbG9jYWxzKSBsb2NhbHMgPSBOT19MT0NBTFM7CiAgICAgIGVsc2UgaWYgKCFpc09iamVjdChsb2NhbHMpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCInbG9jYWxzJyBtdXN0IGJlIGFuIG9iamVjdCIpOwogICAgICB9ICAgICAgIAogICAgICBpZiAoIXBhcmVudCkgcGFyZW50ID0gTk9fUEFSRU5UOwogICAgICBlbHNlIGlmICghaXNSZXNvbHZlKHBhcmVudCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIidwYXJlbnQnIG11c3QgYmUgYSBwcm9taXNlIHJldHVybmVkIGJ5ICRyZXNvbHZlLnJlc29sdmUoKSIpOwogICAgICB9CiAgICAgIAogICAgICAvLyBUbyBjb21wbGV0ZSB0aGUgb3ZlcmFsbCByZXNvbHV0aW9uLCB3ZSBoYXZlIHRvIHdhaXQgZm9yIHRoZSBwYXJlbnQKICAgICAgLy8gcHJvbWlzZSBhbmQgZm9yIHRoZSBwcm9taXNlIGZvciBlYWNoIGludm9rYWJsZSBpbiBvdXIgcGxhbi4KICAgICAgdmFyIHJlc29sdXRpb24gPSAkcS5kZWZlcigpLAogICAgICAgICAgcmVzdWx0ID0gcmVzb2x1dGlvbi5wcm9taXNlLAogICAgICAgICAgcHJvbWlzZXMgPSByZXN1bHQuJCRwcm9taXNlcyA9IHt9LAogICAgICAgICAgdmFsdWVzID0gZXh0ZW5kKHt9LCBsb2NhbHMpLAogICAgICAgICAgd2FpdCA9IDEgKyBwbGFuLmxlbmd0aC8zLAogICAgICAgICAgbWVyZ2VkID0gZmFsc2U7CiAgICAgICAgICAKICAgICAgZnVuY3Rpb24gZG9uZSgpIHsKICAgICAgICAvLyBNZXJnZSBwYXJlbnQgdmFsdWVzIHdlIGhhdmVuJ3QgZ290IHlldCBhbmQgcHVibGlzaCBvdXIgb3duICQkdmFsdWVzCiAgICAgICAgaWYgKCEtLXdhaXQpIHsKICAgICAgICAgIGlmICghbWVyZ2VkKSBtZXJnZSh2YWx1ZXMsIHBhcmVudC4kJHZhbHVlcyk7IAogICAgICAgICAgcmVzdWx0LiQkdmFsdWVzID0gdmFsdWVzOwogICAgICAgICAgcmVzdWx0LiQkcHJvbWlzZXMgPSB0cnVlOyAvLyBrZWVwIGZvciBpc1Jlc29sdmUoKQogICAgICAgICAgcmVzb2x1dGlvbi5yZXNvbHZlKHZhbHVlcyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICBmdW5jdGlvbiBmYWlsKHJlYXNvbikgewogICAgICAgIHJlc3VsdC4kJGZhaWx1cmUgPSByZWFzb247CiAgICAgICAgcmVzb2x1dGlvbi5yZWplY3QocmVhc29uKTsKICAgICAgfQogICAgICAKICAgICAgLy8gU2hvcnQtY2lyY3VpdCBpZiBwYXJlbnQgaGFzIGFscmVhZHkgZmFpbGVkCiAgICAgIGlmIChpc0RlZmluZWQocGFyZW50LiQkZmFpbHVyZSkpIHsKICAgICAgICBmYWlsKHBhcmVudC4kJGZhaWx1cmUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIE1lcmdlIHBhcmVudCB2YWx1ZXMgaWYgdGhlIHBhcmVudCBoYXMgYWxyZWFkeSByZXNvbHZlZCwgb3IgbWVyZ2UKICAgICAgLy8gcGFyZW50IHByb21pc2VzIGFuZCB3YWl0IGlmIHRoZSBwYXJlbnQgcmVzb2x2ZSBpcyBzdGlsbCBpbiBwcm9ncmVzcy4KICAgICAgaWYgKHBhcmVudC4kJHZhbHVlcykgewogICAgICAgIG1lcmdlZCA9IG1lcmdlKHZhbHVlcywgcGFyZW50LiQkdmFsdWVzKTsKICAgICAgICBkb25lKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZXh0ZW5kKHByb21pc2VzLCBwYXJlbnQuJCRwcm9taXNlcyk7CiAgICAgICAgcGFyZW50LnRoZW4oZG9uZSwgZmFpbCk7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFByb2Nlc3MgZWFjaCBpbnZvY2FibGUgaW4gdGhlIHBsYW4sIGJ1dCBpZ25vcmUgYW55IHdoZXJlIGEgbG9jYWwgb2YgdGhlIHNhbWUgbmFtZSBleGlzdHMuCiAgICAgIGZvciAodmFyIGk9MCwgaWk9cGxhbi5sZW5ndGg7IGk8aWk7IGkrPTMpIHsKICAgICAgICBpZiAobG9jYWxzLmhhc093blByb3BlcnR5KHBsYW5baV0pKSBkb25lKCk7CiAgICAgICAgZWxzZSBpbnZva2UocGxhbltpXSwgcGxhbltpKzFdLCBwbGFuW2krMl0pOwogICAgICB9CiAgICAgIAogICAgICBmdW5jdGlvbiBpbnZva2Uoa2V5LCBpbnZvY2FibGUsIHBhcmFtcykgewogICAgICAgIC8vIENyZWF0ZSBhIGRlZmVycmVkIGZvciB0aGlzIGludm9jYXRpb24uIEZhaWx1cmVzIHdpbGwgcHJvcGFnYXRlIHRvIHRoZSByZXNvbHV0aW9uIGFzIHdlbGwuCiAgICAgICAgdmFyIGludm9jYXRpb24gPSAkcS5kZWZlcigpLCB3YWl0UGFyYW1zID0gMDsKICAgICAgICBmdW5jdGlvbiBvbmZhaWx1cmUocmVhc29uKSB7CiAgICAgICAgICBpbnZvY2F0aW9uLnJlamVjdChyZWFzb24pOwogICAgICAgICAgZmFpbChyZWFzb24pOwogICAgICAgIH0KICAgICAgICAvLyBXYWl0IGZvciBhbnkgcGFyYW1ldGVyIHRoYXQgd2UgaGF2ZSBhIHByb21pc2UgZm9yIChlaXRoZXIgZnJvbSBwYXJlbnQgb3IgZnJvbSB0aGlzCiAgICAgICAgLy8gcmVzb2x2ZTsgaW4gdGhhdCBjYXNlIHN0dWR5KCkgd2lsbCBoYXZlIG1hZGUgc3VyZSBpdCdzIG9yZGVyZWQgYmVmb3JlIHVzIGluIHRoZSBwbGFuKS4KICAgICAgICBmb3JFYWNoKHBhcmFtcywgZnVuY3Rpb24gKGRlcCkgewogICAgICAgICAgaWYgKHByb21pc2VzLmhhc093blByb3BlcnR5KGRlcCkgJiYgIWxvY2Fscy5oYXNPd25Qcm9wZXJ0eShkZXApKSB7CiAgICAgICAgICAgIHdhaXRQYXJhbXMrKzsKICAgICAgICAgICAgcHJvbWlzZXNbZGVwXS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgICAgICB2YWx1ZXNbZGVwXSA9IHJlc3VsdDsKICAgICAgICAgICAgICBpZiAoISgtLXdhaXRQYXJhbXMpKSBwcm9jZWVkKCk7CiAgICAgICAgICAgIH0sIG9uZmFpbHVyZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYgKCF3YWl0UGFyYW1zKSBwcm9jZWVkKCk7CiAgICAgICAgZnVuY3Rpb24gcHJvY2VlZCgpIHsKICAgICAgICAgIGlmIChpc0RlZmluZWQocmVzdWx0LiQkZmFpbHVyZSkpIHJldHVybjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGludm9jYXRpb24ucmVzb2x2ZSgkaW5qZWN0b3IuaW52b2tlKGludm9jYWJsZSwgc2VsZiwgdmFsdWVzKSk7CiAgICAgICAgICAgIGludm9jYXRpb24ucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgICAgICB2YWx1ZXNba2V5XSA9IHJlc3VsdDsKICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgIH0sIG9uZmFpbHVyZSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIG9uZmFpbHVyZShlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gUHVibGlzaCBwcm9taXNlIHN5bmNocm9ub3VzbHk7IGludm9jYXRpb25zIGZ1cnRoZXIgZG93biBpbiB0aGUgcGxhbiBtYXkgZGVwZW5kIG9uIGl0LgogICAgICAgIHByb21pc2VzW2tleV0gPSBpbnZvY2F0aW9uLnByb21pc2U7CiAgICAgIH0KICAgICAgCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CiAgCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHJlc29sdmUjcmVzb2x2ZQogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kcmVzb2x2ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVzb2x2ZXMgYSBzZXQgb2YgaW52b2NhYmxlcy4gQW4gaW52b2NhYmxlIGlzIGEgZnVuY3Rpb24gdG8gYmUgaW52b2tlZCB2aWEgCiAgICogYCRpbmplY3Rvci5pbnZva2UoKWAsIGFuZCBjYW4gaGF2ZSBhbiBhcmJpdHJhcnkgbnVtYmVyIG9mIGRlcGVuZGVuY2llcy4gCiAgICogQW4gaW52b2NhYmxlIGNhbiBlaXRoZXIgcmV0dXJuIGEgdmFsdWUgZGlyZWN0bHksCiAgICogb3IgYSBgJHFgIHByb21pc2UuIElmIGEgcHJvbWlzZSBpcyByZXR1cm5lZCBpdCB3aWxsIGJlIHJlc29sdmVkIGFuZCB0aGUgCiAgICogcmVzdWx0aW5nIHZhbHVlIHdpbGwgYmUgdXNlZCBpbnN0ZWFkLiBEZXBlbmRlbmNpZXMgb2YgaW52b2NhYmxlcyBhcmUgcmVzb2x2ZWQgCiAgICogKGluIHRoaXMgb3JkZXIgb2YgcHJlY2VkZW5jZSkKICAgKgogICAqIC0gZnJvbSB0aGUgc3BlY2lmaWVkIGBsb2NhbHNgCiAgICogLSBmcm9tIGFub3RoZXIgaW52b2NhYmxlIHRoYXQgaXMgcGFydCBvZiB0aGlzIGAkcmVzb2x2ZWAgY2FsbAogICAqIC0gZnJvbSBhbiBpbnZvY2FibGUgdGhhdCBpcyBpbmhlcml0ZWQgZnJvbSBhIGBwYXJlbnRgIGNhbGwgdG8gYCRyZXNvbHZlYCAKICAgKiAgIChvciByZWN1cnNpdmVseQogICAqIC0gZnJvbSBhbnkgYW5jZXN0b3IgYCRyZXNvbHZlYCBvZiB0aGF0IHBhcmVudCkuCiAgICoKICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkcmVzb2x2ZWAgaXMgYSBwcm9taXNlIGZvciBhbiBvYmplY3QgdGhhdCBjb250YWlucyAKICAgKiAoaW4gdGhpcyBvcmRlciBvZiBwcmVjZWRlbmNlKQogICAqCiAgICogLSBhbnkgYGxvY2Fsc2AgKGlmIHNwZWNpZmllZCkKICAgKiAtIHRoZSByZXNvbHZlZCByZXR1cm4gdmFsdWVzIG9mIGFsbCBpbmplY3RhYmxlcwogICAqIC0gYW55IHZhbHVlcyBpbmhlcml0ZWQgZnJvbSBhIGBwYXJlbnRgIGNhbGwgdG8gYCRyZXNvbHZlYCAoaWYgc3BlY2lmaWVkKQogICAqCiAgICogVGhlIHByb21pc2Ugd2lsbCByZXNvbHZlIGFmdGVyIHRoZSBgcGFyZW50YCBwcm9taXNlIChpZiBhbnkpIGFuZCBhbGwgcHJvbWlzZXMgCiAgICogcmV0dXJuZWQgYnkgaW5qZWN0YWJsZXMgaGF2ZSBiZWVuIHJlc29sdmVkLiBJZiBhbnkgaW52b2NhYmxlIAogICAqIChvciBgJGluamVjdG9yLmludm9rZWApIHRocm93cyBhbiBleGNlcHRpb24sIG9yIGlmIGEgcHJvbWlzZSByZXR1cm5lZCBieSBhbiAKICAgKiBpbnZvY2FibGUgaXMgcmVqZWN0ZWQsIHRoZSBgJHJlc29sdmVgIHByb21pc2UgaXMgaW1tZWRpYXRlbHkgcmVqZWN0ZWQgd2l0aCB0aGUgCiAgICogc2FtZSBlcnJvci4gQSByZWplY3Rpb24gb2YgYSBgcGFyZW50YCBwcm9taXNlIChpZiBzcGVjaWZpZWQpIHdpbGwgbGlrZXdpc2UgYmUgCiAgICogcHJvcGFnYXRlZCBpbW1lZGlhdGVseS4gT25jZSB0aGUgYCRyZXNvbHZlYCBwcm9taXNlIGhhcyBiZWVuIHJlamVjdGVkLCBubyAKICAgKiBmdXJ0aGVyIGludm9jYWJsZXMgd2lsbCBiZSBjYWxsZWQuCiAgICogCiAgICogQ3ljbGljIGRlcGVuZGVuY2llcyBiZXR3ZWVuIGludm9jYWJsZXMgYXJlIG5vdCBwZXJtaXR0ZWQgYW5kIHdpbGwgY2F1ZXMgYCRyZXNvbHZlYAogICAqIHRvIHRocm93IGFuIGVycm9yLiBBcyBhIHNwZWNpYWwgY2FzZSwgYW4gaW5qZWN0YWJsZSBjYW4gZGVwZW5kIG9uIGEgcGFyYW1ldGVyIAogICAqIHdpdGggdGhlIHNhbWUgbmFtZSBhcyB0aGUgaW5qZWN0YWJsZSwgd2hpY2ggd2lsbCBiZSBmdWxmaWxsZWQgZnJvbSB0aGUgYHBhcmVudGAgCiAgICogaW5qZWN0YWJsZSBvZiB0aGUgc2FtZSBuYW1lLiBUaGlzIGFsbG93cyBpbmhlcml0ZWQgdmFsdWVzIHRvIGJlIGRlY29yYXRlZC4gCiAgICogTm90ZSB0aGF0IGluIHRoaXMgY2FzZSBhbnkgb3RoZXIgaW5qZWN0YWJsZSBpbiB0aGUgc2FtZSBgJHJlc29sdmVgIHdpdGggdGhlIHNhbWUKICAgKiBkZXBlbmRlbmN5IHdvdWxkIHNlZSB0aGUgZGVjb3JhdGVkIHZhbHVlLCBub3QgdGhlIGluaGVyaXRlZCB2YWx1ZS4KICAgKgogICAqIE5vdGUgdGhhdCBtaXNzaW5nIGRlcGVuZGVuY2llcyAtLSB1bmxpa2UgY3ljbGljIGRlcGVuZGVuY2llcyAtLSB3aWxsIGNhdXNlIGFuIAogICAqIChhc3luY2hyb25vdXMpIHJlamVjdGlvbiBvZiB0aGUgYCRyZXNvbHZlYCBwcm9taXNlIHJhdGhlciB0aGFuIGEgKHN5bmNocm9ub3VzKSAKICAgKiBleGNlcHRpb24uCiAgICoKICAgKiBJbnZvY2FibGVzIGFyZSBpbnZva2VkIGVhZ2VybHkgYXMgc29vbiBhcyBhbGwgZGVwZW5kZW5jaWVzIGFyZSBhdmFpbGFibGUuIAogICAqIFRoaXMgaXMgdHJ1ZSBldmVuIGZvciBkZXBlbmRlbmNpZXMgaW5oZXJpdGVkIGZyb20gYSBgcGFyZW50YCBjYWxsIHRvIGAkcmVzb2x2ZWAuCiAgICoKICAgKiBBcyBhIHNwZWNpYWwgY2FzZSwgYW4gaW52b2NhYmxlIGNhbiBiZSBhIHN0cmluZywgaW4gd2hpY2ggY2FzZSBpdCBpcyB0YWtlbiB0byAKICAgKiBiZSBhIHNlcnZpY2UgbmFtZSB0byBiZSBwYXNzZWQgdG8gYCRpbmplY3Rvci5nZXQoKWAuIFRoaXMgaXMgc3VwcG9ydGVkIHByaW1hcmlseSAKICAgKiBmb3IgYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgd2l0aCB0aGUgYHJlc29sdmVgIHByb3BlcnR5IG9mIGAkcm91dGVQcm92aWRlcmAgCiAgICogcm91dGVzLgogICAqCiAgICogQHBhcmFtIHtvYmplY3R9IGludm9jYWJsZXMgZnVuY3Rpb25zIHRvIGludm9rZSBvciAKICAgKiBgJGluamVjdG9yYCBzZXJ2aWNlcyB0byBmZXRjaC4KICAgKiBAcGFyYW0ge29iamVjdH0gbG9jYWxzICB2YWx1ZXMgdG8gbWFrZSBhdmFpbGFibGUgdG8gdGhlIGluamVjdGFibGVzCiAgICogQHBhcmFtIHtvYmplY3R9IHBhcmVudCAgYSBwcm9taXNlIHJldHVybmVkIGJ5IGFub3RoZXIgY2FsbCB0byBgJHJlc29sdmVgLgogICAqIEBwYXJhbSB7b2JqZWN0fSBzZWxmICB0aGUgYHRoaXNgIGZvciB0aGUgaW52b2tlZCBtZXRob2RzCiAgICogQHJldHVybiB7b2JqZWN0fSBQcm9taXNlIGZvciBhbiBvYmplY3QgdGhhdCBjb250YWlucyB0aGUgcmVzb2x2ZWQgcmV0dXJuIHZhbHVlCiAgICogb2YgYWxsIGludm9jYWJsZXMsIGFzIHdlbGwgYXMgYW55IGluaGVyaXRlZCBhbmQgbG9jYWwgdmFsdWVzLgogICAqLwogIHRoaXMucmVzb2x2ZSA9IGZ1bmN0aW9uIChpbnZvY2FibGVzLCBsb2NhbHMsIHBhcmVudCwgc2VsZikgewogICAgcmV0dXJuIHRoaXMuc3R1ZHkoaW52b2NhYmxlcykobG9jYWxzLCBwYXJlbnQsIHNlbGYpOwogIH07Cn0KCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIudXRpbCcpLnNlcnZpY2UoJyRyZXNvbHZlJywgJFJlc29sdmUpOwoKCi8qKgogKiBAbmdkb2Mgb2JqZWN0CiAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkKICoKICogQHJlcXVpcmVzICRodHRwCiAqIEByZXF1aXJlcyAkdGVtcGxhdGVDYWNoZQogKiBAcmVxdWlyZXMgJGluamVjdG9yCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTZXJ2aWNlLiBNYW5hZ2VzIGxvYWRpbmcgb2YgdGVtcGxhdGVzLgogKi8KJFRlbXBsYXRlRmFjdG9yeS4kaW5qZWN0ID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckaW5qZWN0b3InXTsKZnVuY3Rpb24gJFRlbXBsYXRlRmFjdG9yeSggICRodHRwLCAgICR0ZW1wbGF0ZUNhY2hlLCAgICRpbmplY3RvcikgewoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21Db25maWcKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhIHRlbXBsYXRlIGZyb20gYSBjb25maWd1cmF0aW9uIG9iamVjdC4gCiAgICoKICAgKiBAcGFyYW0ge29iamVjdH0gY29uZmlnIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciB3aGljaCB0byBsb2FkIGEgdGVtcGxhdGUuIAogICAqIFRoZSBmb2xsb3dpbmcgcHJvcGVydGllcyBhcmUgc2VhcmNoIGluIHRoZSBzcGVjaWZpZWQgb3JkZXIsIGFuZCB0aGUgZmlyc3Qgb25lIAogICAqIHRoYXQgaXMgZGVmaW5lZCBpcyB1c2VkIHRvIGNyZWF0ZSB0aGUgdGVtcGxhdGU6CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IGNvbmZpZy50ZW1wbGF0ZSBodG1sIHN0cmluZyB0ZW1wbGF0ZSBvciBmdW5jdGlvbiB0byAKICAgKiBsb2FkIHZpYSB7QGxpbmsgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tU3RyaW5nIGZyb21TdHJpbmd9LgogICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gY29uZmlnLnRlbXBsYXRlVXJsIHVybCB0byBsb2FkIG9yIGEgZnVuY3Rpb24gcmV0dXJuaW5nIAogICAqIHRoZSB1cmwgdG8gbG9hZCB2aWEge0BsaW5rIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkjZnJvbVVybCBmcm9tVXJsfS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWcudGVtcGxhdGVQcm92aWRlciBmdW5jdGlvbiB0byBpbnZva2UgdmlhIAogICAqIHtAbGluayB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21Qcm92aWRlciBmcm9tUHJvdmlkZXJ9LgogICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgIFBhcmFtZXRlcnMgdG8gcGFzcyB0byB0aGUgdGVtcGxhdGUgZnVuY3Rpb24uCiAgICogQHBhcmFtIHtvYmplY3R9IGxvY2FscyBMb2NhbHMgdG8gcGFzcyB0byBgaW52b2tlYCBpZiB0aGUgdGVtcGxhdGUgaXMgbG9hZGVkIAogICAqIHZpYSBhIGB0ZW1wbGF0ZVByb3ZpZGVyYC4gRGVmYXVsdHMgdG8gYHsgcGFyYW1zOiBwYXJhbXMgfWAuCiAgICoKICAgKiBAcmV0dXJuIHtzdHJpbmd8b2JqZWN0fSAgVGhlIHRlbXBsYXRlIGh0bWwgYXMgYSBzdHJpbmcsIG9yIGEgcHJvbWlzZSBmb3IgCiAgICogdGhhdCBzdHJpbmcsb3IgYG51bGxgIGlmIG5vIHRlbXBsYXRlIGlzIGNvbmZpZ3VyZWQuCiAgICovCiAgdGhpcy5mcm9tQ29uZmlnID0gZnVuY3Rpb24gKGNvbmZpZywgcGFyYW1zLCBsb2NhbHMpIHsKICAgIHJldHVybiAoCiAgICAgIGlzRGVmaW5lZChjb25maWcudGVtcGxhdGUpID8gdGhpcy5mcm9tU3RyaW5nKGNvbmZpZy50ZW1wbGF0ZSwgcGFyYW1zKSA6CiAgICAgIGlzRGVmaW5lZChjb25maWcudGVtcGxhdGVVcmwpID8gdGhpcy5mcm9tVXJsKGNvbmZpZy50ZW1wbGF0ZVVybCwgcGFyYW1zKSA6CiAgICAgIGlzRGVmaW5lZChjb25maWcudGVtcGxhdGVQcm92aWRlcikgPyB0aGlzLmZyb21Qcm92aWRlcihjb25maWcudGVtcGxhdGVQcm92aWRlciwgcGFyYW1zLCBsb2NhbHMpIDoKICAgICAgbnVsbAogICAgKTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21TdHJpbmcKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhIHRlbXBsYXRlIGZyb20gYSBzdHJpbmcgb3IgYSBmdW5jdGlvbiByZXR1cm5pbmcgYSBzdHJpbmcuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IHRlbXBsYXRlIGh0bWwgdGVtcGxhdGUgYXMgYSBzdHJpbmcgb3IgZnVuY3Rpb24gdGhhdCAKICAgKiByZXR1cm5zIGFuIGh0bWwgdGVtcGxhdGUgYXMgYSBzdHJpbmcuCiAgICogQHBhcmFtIHtvYmplY3R9IHBhcmFtcyBQYXJhbWV0ZXJzIHRvIHBhc3MgdG8gdGhlIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAqCiAgICogQHJldHVybiB7c3RyaW5nfG9iamVjdH0gVGhlIHRlbXBsYXRlIGh0bWwgYXMgYSBzdHJpbmcsIG9yIGEgcHJvbWlzZSBmb3IgdGhhdCAKICAgKiBzdHJpbmcuCiAgICovCiAgdGhpcy5mcm9tU3RyaW5nID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBwYXJhbXMpIHsKICAgIHJldHVybiBpc0Z1bmN0aW9uKHRlbXBsYXRlKSA/IHRlbXBsYXRlKHBhcmFtcykgOiB0ZW1wbGF0ZTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21VcmwKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAqIAogICAqIEBkZXNjcmlwdGlvbgogICAqIExvYWRzIGEgdGVtcGxhdGUgZnJvbSB0aGUgYSBVUkwgdmlhIGAkaHR0cGAgYW5kIGAkdGVtcGxhdGVDYWNoZWAuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xGdW5jdGlvbn0gdXJsIHVybCBvZiB0aGUgdGVtcGxhdGUgdG8gbG9hZCwgb3IgYSBmdW5jdGlvbiAKICAgKiB0aGF0IHJldHVybnMgYSB1cmwuCiAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyBQYXJhbWV0ZXJzIHRvIHBhc3MgdG8gdGhlIHVybCBmdW5jdGlvbi4KICAgKiBAcmV0dXJuIHtzdHJpbmd8UHJvbWlzZS48c3RyaW5nPn0gVGhlIHRlbXBsYXRlIGh0bWwgYXMgYSBzdHJpbmcsIG9yIGEgcHJvbWlzZSAKICAgKiBmb3IgdGhhdCBzdHJpbmcuCiAgICovCiAgdGhpcy5mcm9tVXJsID0gZnVuY3Rpb24gKHVybCwgcGFyYW1zKSB7CiAgICBpZiAoaXNGdW5jdGlvbih1cmwpKSB1cmwgPSB1cmwocGFyYW1zKTsKICAgIGlmICh1cmwgPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICBlbHNlIHJldHVybiAkaHR0cAogICAgICAgIC5nZXQodXJsLCB7IGNhY2hlOiAkdGVtcGxhdGVDYWNoZSB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7IHJldHVybiByZXNwb25zZS5kYXRhOyB9KTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21VcmwKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhIHRlbXBsYXRlIGJ5IGludm9raW5nIGFuIGluamVjdGFibGUgcHJvdmlkZXIgZnVuY3Rpb24uCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlciBGdW5jdGlvbiB0byBpbnZva2UgdmlhIGAkaW5qZWN0b3IuaW52b2tlYAogICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgUGFyYW1ldGVycyBmb3IgdGhlIHRlbXBsYXRlLgogICAqIEBwYXJhbSB7T2JqZWN0fSBsb2NhbHMgTG9jYWxzIHRvIHBhc3MgdG8gYGludm9rZWAuIERlZmF1bHRzIHRvIAogICAqIGB7IHBhcmFtczogcGFyYW1zIH1gLgogICAqIEByZXR1cm4ge3N0cmluZ3xQcm9taXNlLjxzdHJpbmc+fSBUaGUgdGVtcGxhdGUgaHRtbCBhcyBhIHN0cmluZywgb3IgYSBwcm9taXNlIAogICAqIGZvciB0aGF0IHN0cmluZy4KICAgKi8KICB0aGlzLmZyb21Qcm92aWRlciA9IGZ1bmN0aW9uIChwcm92aWRlciwgcGFyYW1zLCBsb2NhbHMpIHsKICAgIHJldHVybiAkaW5qZWN0b3IuaW52b2tlKHByb3ZpZGVyLCBudWxsLCBsb2NhbHMgfHwgeyBwYXJhbXM6IHBhcmFtcyB9KTsKICB9Owp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnV0aWwnKS5zZXJ2aWNlKCckdGVtcGxhdGVGYWN0b3J5JywgJFRlbXBsYXRlRmFjdG9yeSk7CgovKioKICogQG5nZG9jIG9iamVjdAogKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIE1hdGNoZXMgVVJMcyBhZ2FpbnN0IHBhdHRlcm5zIGFuZCBleHRyYWN0cyBuYW1lZCBwYXJhbWV0ZXJzIGZyb20gdGhlIHBhdGggb3IgdGhlIHNlYXJjaAogKiBwYXJ0IG9mIHRoZSBVUkwuIEEgVVJMIHBhdHRlcm4gY29uc2lzdHMgb2YgYSBwYXRoIHBhdHRlcm4sIG9wdGlvbmFsbHkgZm9sbG93ZWQgYnkgJz8nIGFuZCBhIGxpc3QKICogb2Ygc2VhcmNoIHBhcmFtZXRlcnMuIE11bHRpcGxlIHNlYXJjaCBwYXJhbWV0ZXIgbmFtZXMgYXJlIHNlcGFyYXRlZCBieSAnJicuIFNlYXJjaCBwYXJhbWV0ZXJzCiAqIGRvIG5vdCBpbmZsdWVuY2Ugd2hldGhlciBvciBub3QgYSBVUkwgaXMgbWF0Y2hlZCwgYnV0IHRoZWlyIHZhbHVlcyBhcmUgcGFzc2VkIHRocm91Z2ggaW50bwogKiB0aGUgbWF0Y2hlZCBwYXJhbWV0ZXJzIHJldHVybmVkIGJ5IHtAbGluayB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIjbWV0aG9kc19leGVjIGV4ZWN9LgogKiAKICogUGF0aCBwYXJhbWV0ZXIgcGxhY2Vob2xkZXJzIGNhbiBiZSBzcGVjaWZpZWQgdXNpbmcgc2ltcGxlIGNvbG9uL2NhdGNoLWFsbCBzeW50YXggb3IgY3VybHkgYnJhY2UKICogc3ludGF4LCB3aGljaCBvcHRpb25hbGx5IGFsbG93cyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgdGhlIHBhcmFtZXRlciB0byBiZSBzcGVjaWZpZWQ6CiAqCiAqICogYCc6J2AgbmFtZSAtIGNvbG9uIHBsYWNlaG9sZGVyCiAqICogYCcqJ2AgbmFtZSAtIGNhdGNoLWFsbCBwbGFjZWhvbGRlcgogKiAqIGAneycgbmFtZSAnfSdgIC0gY3VybHkgcGxhY2Vob2xkZXIKICogKiBgJ3snIG5hbWUgJzonIHJlZ2V4cCAnfSdgIC0gY3VybHkgcGxhY2Vob2xkZXIgd2l0aCByZWdleHAuIFNob3VsZCB0aGUgcmVnZXhwIGl0c2VsZiBjb250YWluCiAqICAgY3VybHkgYnJhY2VzLCB0aGV5IG11c3QgYmUgaW4gbWF0Y2hlZCBwYWlycyBvciBlc2NhcGVkIHdpdGggYSBiYWNrc2xhc2guCiAqCiAqIFBhcmFtZXRlciBuYW1lcyBtYXkgY29udGFpbiBvbmx5IHdvcmQgY2hhcmFjdGVycyAobGF0aW4gbGV0dGVycywgZGlnaXRzLCBhbmQgdW5kZXJzY29yZSkgYW5kCiAqIG11c3QgYmUgdW5pcXVlIHdpdGhpbiB0aGUgcGF0dGVybiAoYWNyb3NzIGJvdGggcGF0aCBhbmQgc2VhcmNoIHBhcmFtZXRlcnMpLiBGb3IgY29sb24gCiAqIHBsYWNlaG9sZGVycyBvciBjdXJseSBwbGFjZWhvbGRlcnMgd2l0aG91dCBhbiBleHBsaWNpdCByZWdleHAsIGEgcGF0aCBwYXJhbWV0ZXIgbWF0Y2hlcyBhbnkKICogbnVtYmVyIG9mIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiAnLycuIEZvciBjYXRjaC1hbGwgcGxhY2Vob2xkZXJzIHRoZSBwYXRoIHBhcmFtZXRlciBtYXRjaGVzCiAqIGFueSBudW1iZXIgb2YgY2hhcmFjdGVycy4KICogCiAqIEV4YW1wbGVzOgogKiAKICogKiBgJy9oZWxsby8nYCAtIE1hdGNoZXMgb25seSBpZiB0aGUgcGF0aCBpcyBleGFjdGx5ICcvaGVsbG8vJy4gVGhlcmUgaXMgbm8gc3BlY2lhbCB0cmVhdG1lbnQgZm9yCiAqICAgdHJhaWxpbmcgc2xhc2hlcywgYW5kIHBhdHRlcm5zIGhhdmUgdG8gbWF0Y2ggdGhlIGVudGlyZSBwYXRoLCBub3QganVzdCBhIHByZWZpeC4KICogKiBgJy91c2VyLzppZCdgIC0gTWF0Y2hlcyAnL3VzZXIvYm9iJyBvciAnL3VzZXIvMTIzNCEhIScgb3IgZXZlbiAnL3VzZXIvJyBidXQgbm90ICcvdXNlcicgb3IKICogICAnL3VzZXIvYm9iL2RldGFpbHMnLiBUaGUgc2Vjb25kIHBhdGggc2VnbWVudCB3aWxsIGJlIGNhcHR1cmVkIGFzIHRoZSBwYXJhbWV0ZXIgJ2lkJy4KICogKiBgJy91c2VyL3tpZH0nYCAtIFNhbWUgYXMgdGhlIHByZXZpb3VzIGV4YW1wbGUsIGJ1dCB1c2luZyBjdXJseSBicmFjZSBzeW50YXguCiAqICogYCcvdXNlci97aWQ6W14vXSp9J2AgLSBTYW1lIGFzIHRoZSBwcmV2aW91cyBleGFtcGxlLgogKiAqIGAnL3VzZXIve2lkOlswLTlhLWZBLUZdezEsOH19J2AgLSBTaW1pbGFyIHRvIHRoZSBwcmV2aW91cyBleGFtcGxlLCBidXQgb25seSBtYXRjaGVzIGlmIHRoZSBpZAogKiAgIHBhcmFtZXRlciBjb25zaXN0cyBvZiAxIHRvIDggaGV4IGRpZ2l0cy4KICogKiBgJy9maWxlcy97cGF0aDouKn0nYCAtIE1hdGNoZXMgYW55IFVSTCBzdGFydGluZyB3aXRoICcvZmlsZXMvJyBhbmQgY2FwdHVyZXMgdGhlIHJlc3Qgb2YgdGhlCiAqICAgcGF0aCBpbnRvIHRoZSBwYXJhbWV0ZXIgJ3BhdGgnLgogKiAqIGAnL2ZpbGVzLypwYXRoJ2AgLSBkaXR0by4KICoKICogQHBhcmFtIHtzdHJpbmd9IHBhdHRlcm4gIHRoZSBwYXR0ZXJuIHRvIGNvbXBpbGUgaW50byBhIG1hdGNoZXIuCiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwcmVmaXggIEEgc3RhdGljIHByZWZpeCBvZiB0aGlzIHBhdHRlcm4uIFRoZSBtYXRjaGVyIGd1YXJhbnRlZXMgdGhhdCBhbnkKICogICBVUkwgbWF0Y2hpbmcgdGhpcyBtYXRjaGVyIChpLmUuIGFueSBzdHJpbmcgZm9yIHdoaWNoIHtAbGluayB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIjbWV0aG9kc19leGVjIGV4ZWMoKX0gcmV0dXJucwogKiAgIG5vbi1udWxsKSB3aWxsIHN0YXJ0IHdpdGggdGhpcyBwcmVmaXguCiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzb3VyY2UgIFRoZSBwYXR0ZXJuIHRoYXQgd2FzIHBhc3NlZCBpbnRvIHRoZSBjb250cnVjdG9yCiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzb3VyY2VQYXRoICBUaGUgcGF0aCBwb3J0aW9uIG9mIHRoZSBzb3VyY2UgcHJvcGVydHkKICoKICogQHByb3BlcnR5IHtzdHJpbmd9IHNvdXJjZVNlYXJjaCAgVGhlIHNlYXJjaCBwb3J0aW9uIG9mIHRoZSBzb3VyY2UgcHJvcGVydHkKICoKICogQHByb3BlcnR5IHtzdHJpbmd9IHJlZ2V4ICBUaGUgY29uc3RydWN0ZWQgcmVnZXggdGhhdCB3aWxsIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCB0aGUgdXJsIHdoZW4gCiAqICAgaXQgaXMgdGltZSB0byBkZXRlcm1pbmUgd2hpY2ggdXJsIHdpbGwgbWF0Y2guCiAqCiAqIEByZXR1cm5zIHtPYmplY3R9ICBOZXcgVXJsTWF0Y2hlciBvYmplY3QKICovCmZ1bmN0aW9uIFVybE1hdGNoZXIocGF0dGVybikgewoKICAvLyBGaW5kIGFsbCBwbGFjZWhvbGRlcnMgYW5kIGNyZWF0ZSBhIGNvbXBpbGVkIHBhdHRlcm4sIHVzaW5nIGVpdGhlciBjbGFzc2ljIG9yIGN1cmx5IHN5bnRheDoKICAvLyAgICcqJyBuYW1lCiAgLy8gICAnOicgbmFtZQogIC8vICAgJ3snIG5hbWUgJ30nCiAgLy8gICAneycgbmFtZSAnOicgcmVnZXhwICd9JwogIC8vIFRoZSByZWd1bGFyIGV4cHJlc3Npb24gaXMgc29tZXdoYXQgY29tcGxpY2F0ZWQgZHVlIHRvIHRoZSBuZWVkIHRvIGFsbG93IGN1cmx5IGJyYWNlcwogIC8vIGluc2lkZSB0aGUgcmVndWxhciBleHByZXNzaW9uLiBUaGUgcGxhY2Vob2xkZXIgcmVnZXhwIGJyZWFrcyBkb3duIGFzIGZvbGxvd3M6CiAgLy8gICAgKFs6Kl0pKFx3KykgICAgICAgICAgICAgICBjbGFzc2ljIHBsYWNlaG9sZGVyICgkMSAvICQyKQogIC8vICAgIFx7KFx3KykoPzpcOiggLi4uICkpP1x9ICAgY3VybHkgYnJhY2UgcGxhY2Vob2xkZXIgKCQzKSB3aXRoIG9wdGlvbmFsIHJlZ2V4cCAuLi4gKCQ0KQogIC8vICAgICg/OiAuLi4gfCAuLi4gfCAuLi4gKSsgICAgdGhlIHJlZ2V4cCBjb25zaXN0cyBvZiBhbnkgbnVtYmVyIG9mIGF0b21zLCBhbiBhdG9tIGJlaW5nIGVpdGhlcgogIC8vICAgIFtee31cXF0rICAgICAgICAgICAgICAgICAgLSBhbnl0aGluZyBvdGhlciB0aGFuIGN1cmx5IGJyYWNlcyBvciBiYWNrc2xhc2gKICAvLyAgICBcXC4gICAgICAgICAgICAgICAgICAgICAgIC0gYSBiYWNrc2xhc2ggZXNjYXBlCiAgLy8gICAgXHsoPzpbXnt9XFxdK3xcXC4pKlx9ICAgICAtIGEgbWF0Y2hlZCBzZXQgb2YgY3VybHkgYnJhY2VzIGNvbnRhaW5pbmcgb3RoZXIgYXRvbXMKICB2YXIgcGxhY2Vob2xkZXIgPSAvKFs6Kl0pKFx3Kyl8XHsoXHcrKSg/Olw6KCg/Oltee31cXF0rfFxcLnxceyg/Oltee31cXF0rfFxcLikqXH0pKykpP1x9L2csCiAgICAgIG5hbWVzID0ge30sIGNvbXBpbGVkID0gJ14nLCBsYXN0ID0gMCwgbSwKICAgICAgc2VnbWVudHMgPSB0aGlzLnNlZ21lbnRzID0gW10sCiAgICAgIHBhcmFtcyA9IHRoaXMucGFyYW1zID0gW107CgogIGZ1bmN0aW9uIGFkZFBhcmFtZXRlcihpZCkgewogICAgaWYgKCEvXlx3KygtK1x3KykqJC8udGVzdChpZCkpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXIgbmFtZSAnIiArIGlkICsgIicgaW4gcGF0dGVybiAnIiArIHBhdHRlcm4gKyAiJyIpOwogICAgaWYgKG5hbWVzW2lkXSkgdGhyb3cgbmV3IEVycm9yKCJEdXBsaWNhdGUgcGFyYW1ldGVyIG5hbWUgJyIgKyBpZCArICInIGluIHBhdHRlcm4gJyIgKyBwYXR0ZXJuICsgIiciKTsKICAgIG5hbWVzW2lkXSA9IHRydWU7CiAgICBwYXJhbXMucHVzaChpZCk7CiAgfQoKICBmdW5jdGlvbiBxdW90ZVJlZ0V4cChzdHJpbmcpIHsKICAgIHJldHVybiBzdHJpbmcucmVwbGFjZSgvW1xcXFtcXVxeJCorPy4oKXx7fV0vZywgIlxcJCYiKTsKICB9CgogIHRoaXMuc291cmNlID0gcGF0dGVybjsKCiAgLy8gU3BsaXQgaW50byBzdGF0aWMgc2VnbWVudHMgc2VwYXJhdGVkIGJ5IHBhdGggcGFyYW1ldGVyIHBsYWNlaG9sZGVycy4KICAvLyBUaGUgbnVtYmVyIG9mIHNlZ21lbnRzIGlzIGFsd2F5cyAxIG1vcmUgdGhhbiB0aGUgbnVtYmVyIG9mIHBhcmFtZXRlcnMuCiAgdmFyIGlkLCByZWdleHAsIHNlZ21lbnQ7CiAgd2hpbGUgKChtID0gcGxhY2Vob2xkZXIuZXhlYyhwYXR0ZXJuKSkpIHsKICAgIGlkID0gbVsyXSB8fCBtWzNdOyAvLyBJRVs3OF0gcmV0dXJucyAnJyBmb3IgdW5tYXRjaGVkIGdyb3VwcyBpbnN0ZWFkIG9mIG51bGwKICAgIHJlZ2V4cCA9IG1bNF0gfHwgKG1bMV0gPT0gJyonID8gJy4qJyA6ICdbXi9dKicpOwogICAgc2VnbWVudCA9IHBhdHRlcm4uc3Vic3RyaW5nKGxhc3QsIG0uaW5kZXgpOwogICAgaWYgKHNlZ21lbnQuaW5kZXhPZignPycpID49IDApIGJyZWFrOyAvLyB3ZSdyZSBpbnRvIHRoZSBzZWFyY2ggcGFydAogICAgY29tcGlsZWQgKz0gcXVvdGVSZWdFeHAoc2VnbWVudCkgKyAnKCcgKyByZWdleHAgKyAnKSc7CiAgICBhZGRQYXJhbWV0ZXIoaWQpOwogICAgc2VnbWVudHMucHVzaChzZWdtZW50KTsKICAgIGxhc3QgPSBwbGFjZWhvbGRlci5sYXN0SW5kZXg7CiAgfQogIHNlZ21lbnQgPSBwYXR0ZXJuLnN1YnN0cmluZyhsYXN0KTsKCiAgLy8gRmluZCBhbnkgc2VhcmNoIHBhcmFtZXRlciBuYW1lcyBhbmQgcmVtb3ZlIHRoZW0gZnJvbSB0aGUgbGFzdCBzZWdtZW50CiAgdmFyIGkgPSBzZWdtZW50LmluZGV4T2YoJz8nKTsKICBpZiAoaSA+PSAwKSB7CiAgICB2YXIgc2VhcmNoID0gdGhpcy5zb3VyY2VTZWFyY2ggPSBzZWdtZW50LnN1YnN0cmluZyhpKTsKICAgIHNlZ21lbnQgPSBzZWdtZW50LnN1YnN0cmluZygwLCBpKTsKICAgIHRoaXMuc291cmNlUGF0aCA9IHBhdHRlcm4uc3Vic3RyaW5nKDAsIGxhc3QraSk7CgogICAgLy8gQWxsb3cgcGFyYW1ldGVycyB0byBiZSBzZXBhcmF0ZWQgYnkgJz8nIGFzIHdlbGwgYXMgJyYnIHRvIG1ha2UgY29uY2F0KCkgZWFzaWVyCiAgICBmb3JFYWNoKHNlYXJjaC5zdWJzdHJpbmcoMSkuc3BsaXQoL1smP10vKSwgYWRkUGFyYW1ldGVyKTsKICB9IGVsc2UgewogICAgdGhpcy5zb3VyY2VQYXRoID0gcGF0dGVybjsKICAgIHRoaXMuc291cmNlU2VhcmNoID0gJyc7CiAgfQoKICBjb21waWxlZCArPSBxdW90ZVJlZ0V4cChzZWdtZW50KSArICckJzsKICBzZWdtZW50cy5wdXNoKHNlZ21lbnQpOwogIHRoaXMucmVnZXhwID0gbmV3IFJlZ0V4cChjb21waWxlZCk7CiAgdGhpcy5wcmVmaXggPSBzZWdtZW50c1swXTsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIjY29uY2F0CiAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFJldHVybnMgYSBuZXcgbWF0Y2hlciBmb3IgYSBwYXR0ZXJuIGNvbnN0cnVjdGVkIGJ5IGFwcGVuZGluZyB0aGUgcGF0aCBwYXJ0IGFuZCBhZGRpbmcgdGhlCiAqIHNlYXJjaCBwYXJhbWV0ZXJzIG9mIHRoZSBzcGVjaWZpZWQgcGF0dGVybiB0byB0aGlzIHBhdHRlcm4uIFRoZSBjdXJyZW50IHBhdHRlcm4gaXMgbm90CiAqIG1vZGlmaWVkLiBUaGlzIGNhbiBiZSB1bmRlcnN0b29kIGFzIGNyZWF0aW5nIGEgcGF0dGVybiBmb3IgVVJMcyB0aGF0IGFyZSByZWxhdGl2ZSB0byAob3IKICogc3VmZml4ZXMgb2YpIHRoZSBjdXJyZW50IHBhdHRlcm4uCiAqCiAqIEBleGFtcGxlCiAqIFRoZSBmb2xsb3dpbmcgdHdvIG1hdGNoZXJzIGFyZSBlcXVpdmFsZW50OgogKiBgYGAKICogbmV3IFVybE1hdGNoZXIoJy91c2VyL3tpZH0/cScpLmNvbmNhdCgnL2RldGFpbHM/ZGF0ZScpOwogKiBuZXcgVXJsTWF0Y2hlcignL3VzZXIve2lkfS9kZXRhaWxzP3EmZGF0ZScpOwogKiBgYGAKICoKICogQHBhcmFtIHtzdHJpbmd9IHBhdHRlcm4gIFRoZSBwYXR0ZXJuIHRvIGFwcGVuZC4KICogQHJldHVybnMge3VpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gIEEgbWF0Y2hlciBmb3IgdGhlIGNvbmNhdGVuYXRlZCBwYXR0ZXJuLgogKi8KVXJsTWF0Y2hlci5wcm90b3R5cGUuY29uY2F0ID0gZnVuY3Rpb24gKHBhdHRlcm4pIHsKICAvLyBCZWNhdXNlIG9yZGVyIG9mIHNlYXJjaCBwYXJhbWV0ZXJzIGlzIGlycmVsZXZhbnQsIHdlIGNhbiBhZGQgb3VyIG93biBzZWFyY2gKICAvLyBwYXJhbWV0ZXJzIHRvIHRoZSBlbmQgb2YgdGhlIG5ldyBwYXR0ZXJuLiBQYXJzZSB0aGUgbmV3IHBhdHRlcm4gYnkgaXRzZWxmCiAgLy8gYW5kIHRoZW4gam9pbiB0aGUgYml0cyB0b2dldGhlciwgYnV0IGl0J3MgbXVjaCBlYXNpZXIgdG8gZG8gdGhpcyBvbiBhIHN0cmluZyBsZXZlbC4KICByZXR1cm4gbmV3IFVybE1hdGNoZXIodGhpcy5zb3VyY2VQYXRoICsgcGF0dGVybiArIHRoaXMuc291cmNlU2VhcmNoKTsKfTsKClVybE1hdGNoZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNvdXJjZTsKfTsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI2V4ZWMKICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcgogKgogKiBAZGVzY3JpcHRpb24KICogVGVzdHMgdGhlIHNwZWNpZmllZCBwYXRoIGFnYWluc3QgdGhpcyBtYXRjaGVyLCBhbmQgcmV0dXJucyBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgY2FwdHVyZWQKICogcGFyYW1ldGVyIHZhbHVlcywgb3IgbnVsbCBpZiB0aGUgcGF0aCBkb2VzIG5vdCBtYXRjaC4gVGhlIHJldHVybmVkIG9iamVjdCBjb250YWlucyB0aGUgdmFsdWVzCiAqIG9mIGFueSBzZWFyY2ggcGFyYW1ldGVycyB0aGF0IGFyZSBtZW50aW9uZWQgaW4gdGhlIHBhdHRlcm4sIGJ1dCB0aGVpciB2YWx1ZSBtYXkgYmUgbnVsbCBpZgogKiB0aGV5IGFyZSBub3QgcHJlc2VudCBpbiBgc2VhcmNoUGFyYW1zYC4gVGhpcyBtZWFucyB0aGF0IHNlYXJjaCBwYXJhbWV0ZXJzIGFyZSBhbHdheXMgdHJlYXRlZAogKiBhcyBvcHRpb25hbC4KICoKICogQGV4YW1wbGUKICogYGBgCiAqIG5ldyBVcmxNYXRjaGVyKCcvdXNlci97aWR9P3EmcicpLmV4ZWMoJy91c2VyL2JvYicsIHsgeDonMScsIHE6J2hlbGxvJyB9KTsKICogLy8gcmV0dXJucyB7IGlkOidib2InLCBxOidoZWxsbycsIHI6bnVsbCB9CiAqIGBgYAogKgogKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAgVGhlIFVSTCBwYXRoIHRvIG1hdGNoLCBlLmcuIGAkbG9jYXRpb24ucGF0aCgpYC4KICogQHBhcmFtIHtPYmplY3R9IHNlYXJjaFBhcmFtcyAgVVJMIHNlYXJjaCBwYXJhbWV0ZXJzLCBlLmcuIGAkbG9jYXRpb24uc2VhcmNoKClgLgogKiBAcmV0dXJucyB7T2JqZWN0fSAgVGhlIGNhcHR1cmVkIHBhcmFtZXRlciB2YWx1ZXMuCiAqLwpVcmxNYXRjaGVyLnByb3RvdHlwZS5leGVjID0gZnVuY3Rpb24gKHBhdGgsIHNlYXJjaFBhcmFtcykgewogIHZhciBtID0gdGhpcy5yZWdleHAuZXhlYyhwYXRoKTsKICBpZiAoIW0pIHJldHVybiBudWxsOwoKICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXMsIG5Ub3RhbCA9IHBhcmFtcy5sZW5ndGgsCiAgICBuUGF0aCA9IHRoaXMuc2VnbWVudHMubGVuZ3RoLTEsCiAgICB2YWx1ZXMgPSB7fSwgaTsKCiAgaWYgKG5QYXRoICE9PSBtLmxlbmd0aCAtIDEpIHRocm93IG5ldyBFcnJvcigiVW5iYWxhbmNlZCBjYXB0dXJlIGdyb3VwIGluIHJvdXRlICciICsgdGhpcy5zb3VyY2UgKyAiJyIpOwoKICBmb3IgKGk9MDsgaTxuUGF0aDsgaSsrKSB2YWx1ZXNbcGFyYW1zW2ldXSA9IG1baSsxXTsKICBmb3IgKC8qKi87IGk8blRvdGFsOyBpKyspIHZhbHVlc1twYXJhbXNbaV1dID0gc2VhcmNoUGFyYW1zW3BhcmFtc1tpXV07CgogIHJldHVybiB2YWx1ZXM7Cn07CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlciNwYXJhbWV0ZXJzCiAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFJldHVybnMgdGhlIG5hbWVzIG9mIGFsbCBwYXRoIGFuZCBzZWFyY2ggcGFyYW1ldGVycyBvZiB0aGlzIHBhdHRlcm4gaW4gYW4gdW5zcGVjaWZpZWQgb3JkZXIuCiAqIAogKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59ICBBbiBhcnJheSBvZiBwYXJhbWV0ZXIgbmFtZXMuIE11c3QgYmUgdHJlYXRlZCBhcyByZWFkLW9ubHkuIElmIHRoZQogKiAgICBwYXR0ZXJuIGhhcyBubyBwYXJhbWV0ZXJzLCBhbiBlbXB0eSBhcnJheSBpcyByZXR1cm5lZC4KICovClVybE1hdGNoZXIucHJvdG90eXBlLnBhcmFtZXRlcnMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMucGFyYW1zOwp9OwoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIjZm9ybWF0CiAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYSBVUkwgdGhhdCBtYXRjaGVzIHRoaXMgcGF0dGVybiBieSBzdWJzdGl0dXRpbmcgdGhlIHNwZWNpZmllZCB2YWx1ZXMKICogZm9yIHRoZSBwYXRoIGFuZCBzZWFyY2ggcGFyYW1ldGVycy4gTnVsbCB2YWx1ZXMgZm9yIHBhdGggcGFyYW1ldGVycyBhcmUKICogdHJlYXRlZCBhcyBlbXB0eSBzdHJpbmdzLgogKgogKiBAZXhhbXBsZQogKiBgYGAKICogbmV3IFVybE1hdGNoZXIoJy91c2VyL3tpZH0/cScpLmZvcm1hdCh7IGlkOidib2InLCBxOid5ZXMnIH0pOwogKiAvLyByZXR1cm5zICcvdXNlci9ib2I/cT15ZXMnCiAqIGBgYAogKgogKiBAcGFyYW0ge09iamVjdH0gdmFsdWVzICB0aGUgdmFsdWVzIHRvIHN1YnN0aXR1dGUgZm9yIHRoZSBwYXJhbWV0ZXJzIGluIHRoaXMgcGF0dGVybi4KICogQHJldHVybnMge3N0cmluZ30gIHRoZSBmb3JtYXR0ZWQgVVJMIChwYXRoIGFuZCBvcHRpb25hbGx5IHNlYXJjaCBwYXJ0KS4KICovClVybE1hdGNoZXIucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uICh2YWx1ZXMpIHsKICB2YXIgc2VnbWVudHMgPSB0aGlzLnNlZ21lbnRzLCBwYXJhbXMgPSB0aGlzLnBhcmFtczsKICBpZiAoIXZhbHVlcykgcmV0dXJuIHNlZ21lbnRzLmpvaW4oJycpOwoKICB2YXIgblBhdGggPSBzZWdtZW50cy5sZW5ndGgtMSwgblRvdGFsID0gcGFyYW1zLmxlbmd0aCwKICAgIHJlc3VsdCA9IHNlZ21lbnRzWzBdLCBpLCBzZWFyY2gsIHZhbHVlOwoKICBmb3IgKGk9MDsgaTxuUGF0aDsgaSsrKSB7CiAgICB2YWx1ZSA9IHZhbHVlc1twYXJhbXNbaV1dOwogICAgLy8gVE9ETzogTWF5YmUgd2Ugc2hvdWxkIHRocm93IG9uIG51bGwgaGVyZT8gSXQncyBub3QgcmVhbGx5IGdvb2Qgc3R5bGUgdG8gdXNlICcnIGFuZCBudWxsIGludGVyY2hhbmdlYWJsZXkKICAgIGlmICh2YWx1ZSAhPSBudWxsKSByZXN1bHQgKz0gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgIHJlc3VsdCArPSBzZWdtZW50c1tpKzFdOwogIH0KICBmb3IgKC8qKi87IGk8blRvdGFsOyBpKyspIHsKICAgIHZhbHVlID0gdmFsdWVzW3BhcmFtc1tpXV07CiAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICByZXN1bHQgKz0gKHNlYXJjaCA/ICcmJyA6ICc/JykgKyBwYXJhbXNbaV0gKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICBzZWFyY2ggPSB0cnVlOwogICAgfQogIH0KCiAgcmV0dXJuIHJlc3VsdDsKfTsKCgoKLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGYWN0b3J5IGZvciB7QGxpbmsgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyfSBpbnN0YW5jZXMuIFRoZSBmYWN0b3J5IGlzIGFsc28gYXZhaWxhYmxlIHRvIHByb3ZpZGVycwogKiB1bmRlciB0aGUgbmFtZSBgJHVybE1hdGNoZXJGYWN0b3J5UHJvdmlkZXJgLgogKi8KZnVuY3Rpb24gJFVybE1hdGNoZXJGYWN0b3J5KCkgewoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnkjY29tcGlsZQogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSB7QGxpbmsgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyfSBmb3IgdGhlIHNwZWNpZmllZCBwYXR0ZXJuLgogICAqICAgCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdHRlcm4gIFRoZSBVUkwgcGF0dGVybi4KICAgKiBAcmV0dXJucyB7dWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyfSAgVGhlIFVybE1hdGNoZXIuCiAgICovCiAgdGhpcy5jb21waWxlID0gZnVuY3Rpb24gKHBhdHRlcm4pIHsKICAgIHJldHVybiBuZXcgVXJsTWF0Y2hlcihwYXR0ZXJuKTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnkjaXNNYXRjaGVyCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBzcGVjaWZpZWQgb2JqZWN0IGlzIGEgVXJsTWF0Y2hlciwgb3IgZmFsc2Ugb3RoZXJ3aXNlLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCAgVGhlIG9iamVjdCB0byBwZXJmb3JtIHRoZSB0eXBlIGNoZWNrIGFnYWluc3QuCiAgICogQHJldHVybnMge0Jvb2xlYW59ICBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgb2JqZWN0IGhhcyB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczogYGV4ZWNgLCBgZm9ybWF0YCwgYW5kIGBjb25jYXRgLgogICAqLwogIHRoaXMuaXNNYXRjaGVyID0gZnVuY3Rpb24gKG8pIHsKICAgIHJldHVybiBpc09iamVjdChvKSAmJiBpc0Z1bmN0aW9uKG8uZXhlYykgJiYgaXNGdW5jdGlvbihvLmZvcm1hdCkgJiYgaXNGdW5jdGlvbihvLmNvbmNhdCk7CiAgfTsKICAKICAvKiBObyBuZWVkIHRvIGRvY3VtZW50ICRnZXQsIHNpbmNlIGl0IHJldHVybnMgdGhpcyAqLwogIHRoaXMuJGdldCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzOwogIH07Cn0KCi8vIFJlZ2lzdGVyIGFzIGEgcHJvdmlkZXIgc28gaXQncyBhdmFpbGFibGUgdG8gb3RoZXIgcHJvdmlkZXJzCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIudXRpbCcpLnByb3ZpZGVyKCckdXJsTWF0Y2hlckZhY3RvcnknLCAkVXJsTWF0Y2hlckZhY3RvcnkpOwoKLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIKICoKICogQHJlcXVpcmVzIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBgJHVybFJvdXRlclByb3ZpZGVyYCBoYXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHdhdGNoaW5nIGAkbG9jYXRpb25gLiAKICogV2hlbiBgJGxvY2F0aW9uYCBjaGFuZ2VzIGl0IHJ1bnMgdGhyb3VnaCBhIGxpc3Qgb2YgcnVsZXMgb25lIGJ5IG9uZSB1bnRpbCBhIAogKiBtYXRjaCBpcyBmb3VuZC4gYCR1cmxSb3V0ZXJQcm92aWRlcmAgaXMgdXNlZCBiZWhpbmQgdGhlIHNjZW5lcyBhbnl0aW1lIHlvdSBzcGVjaWZ5IAogKiBhIHVybCBpbiBhIHN0YXRlIGNvbmZpZ3VyYXRpb24uIEFsbCB1cmxzIGFyZSBjb21waWxlZCBpbnRvIGEgVXJsTWF0Y2hlciBvYmplY3QuCiAqCiAqIFRoZXJlIGFyZSBzZXZlcmFsIG1ldGhvZHMgb24gYCR1cmxSb3V0ZXJQcm92aWRlcmAgdGhhdCBtYWtlIGl0IHVzZWZ1bCB0byB1c2UgZGlyZWN0bHkKICogaW4geW91ciBtb2R1bGUgY29uZmlnLgogKi8KJFVybFJvdXRlclByb3ZpZGVyLiRpbmplY3QgPSBbJyR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyJ107CmZ1bmN0aW9uICRVcmxSb3V0ZXJQcm92aWRlciggICR1cmxNYXRjaGVyRmFjdG9yeSkgewogIHZhciBydWxlcyA9IFtdLCAKICAgICAgb3RoZXJ3aXNlID0gbnVsbDsKCiAgLy8gUmV0dXJucyBhIHN0cmluZyB0aGF0IGlzIGEgcHJlZml4IG9mIGFsbCBzdHJpbmdzIG1hdGNoaW5nIHRoZSBSZWdFeHAKICBmdW5jdGlvbiByZWdFeHBQcmVmaXgocmUpIHsKICAgIHZhciBwcmVmaXggPSAvXlxeKCg/OlxcW15hLXpBLVowLTldfFteXFxcW1xdXF4kKis/LigpfHt9XSspKikvLmV4ZWMocmUuc291cmNlKTsKICAgIHJldHVybiAocHJlZml4ICE9IG51bGwpID8gcHJlZml4WzFdLnJlcGxhY2UoL1xcKC4pL2csICIkMSIpIDogJyc7CiAgfQoKICAvLyBJbnRlcnBvbGF0ZXMgbWF0Y2hlZCB2YWx1ZXMgaW50byBhIFN0cmluZy5yZXBsYWNlKCktc3R5bGUgcGF0dGVybgogIGZ1bmN0aW9uIGludGVycG9sYXRlKHBhdHRlcm4sIG1hdGNoKSB7CiAgICByZXR1cm4gcGF0dGVybi5yZXBsYWNlKC9cJChcJHxcZHsxLDJ9KS8sIGZ1bmN0aW9uIChtLCB3aGF0KSB7CiAgICAgIHJldHVybiBtYXRjaFt3aGF0ID09PSAnJCcgPyAwIDogTnVtYmVyKHdoYXQpXTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIjcnVsZQogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGVmaW5lcyBydWxlcyB0aGF0IGFyZSB1c2VkIGJ5IGAkdXJsUm91dGVyUHJvdmlkZXIgdG8gZmluZCBtYXRjaGVzIGZvcgogICAqIHNwZWNpZmljIFVSTHMuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIDxwcmU+CiAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlci5yb3V0ZXInXSk7CiAgICoKICAgKiBhcHAuY29uZmlnKGZ1bmN0aW9uICgkdXJsUm91dGVyUHJvdmlkZXIpIHsKICAgKiAgIC8vIEhlcmUncyBhbiBleGFtcGxlIG9mIGhvdyB5b3UgbWlnaHQgYWxsb3cgY2FzZSBpbnNlbnNpdGl2ZSB1cmxzCiAgICogICAkdXJsUm91dGVyUHJvdmlkZXIucnVsZShmdW5jdGlvbiAoJGluamVjdG9yLCAkbG9jYXRpb24pIHsKICAgKiAgICAgdmFyIHBhdGggPSAkbG9jYXRpb24ucGF0aCgpLAogICAqICAgICAgICAgbm9ybWFsaXplZCA9IHBhdGgudG9Mb3dlckNhc2UoKTsKICAgKgogICAqICAgICBpZiAocGF0aCAhPT0gbm9ybWFsaXplZCkgewogICAqICAgICAgIHJldHVybiBub3JtYWxpemVkOwogICAqICAgICB9CiAgICogICB9KTsKICAgKiB9KTsKICAgKiA8L3ByZT4KICAgKgogICAqIEBwYXJhbSB7b2JqZWN0fSBydWxlIEhhbmRsZXIgZnVuY3Rpb24gdGhhdCB0YWtlcyBgJGluamVjdG9yYCBhbmQgYCRsb2NhdGlvbmAKICAgKiBzZXJ2aWNlcyBhcyBhcmd1bWVudHMuIFlvdSBjYW4gdXNlIHRoZW0gdG8gcmV0dXJuIGEgdmFsaWQgcGF0aCBhcyBhIHN0cmluZy4KICAgKgogICAqIEByZXR1cm4ge29iamVjdH0gJHVybFJvdXRlclByb3ZpZGVyIC0gJHVybFJvdXRlclByb3ZpZGVyIGluc3RhbmNlCiAgICovCiAgdGhpcy5ydWxlID0KICAgIGZ1bmN0aW9uIChydWxlKSB7CiAgICAgIGlmICghaXNGdW5jdGlvbihydWxlKSkgdGhyb3cgbmV3IEVycm9yKCIncnVsZScgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgIHJ1bGVzLnB1c2gocnVsZSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyI290aGVyd2lzZQogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGVmaW5lcyBhIHBhdGggdGhhdCBpcyB1c2VkIHdoZW4gYW4gaW52YWxpZWQgcm91dGUgaXMgcmVxdWVzdGVkLgogICAqCiAgICogQGV4YW1wbGUKICAgKiA8cHJlPgogICAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXIucm91dGVyJ10pOwogICAqCiAgICogYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHVybFJvdXRlclByb3ZpZGVyKSB7CiAgICogICAvLyBpZiB0aGUgcGF0aCBkb2Vzbid0IG1hdGNoIGFueSBvZiB0aGUgdXJscyB5b3UgY29uZmlndXJlZAogICAqICAgLy8gb3RoZXJ3aXNlIHdpbGwgdGFrZSBjYXJlIG9mIHJvdXRpbmcgdGhlIHVzZXIgdG8gdGhlCiAgICogICAvLyBzcGVjaWZpZWQgdXJsCiAgICogICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvaW5kZXgnKTsKICAgKgogICAqICAgLy8gRXhhbXBsZSBvZiB1c2luZyBmdW5jdGlvbiBydWxlIGFzIHBhcmFtCiAgICogICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKGZ1bmN0aW9uICgkaW5qZWN0b3IsICRsb2NhdGlvbikgewogICAqICAgICAuLi4KICAgKiAgIH0pOwogICAqIH0pOwogICAqIDwvcHJlPgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBydWxlIFRoZSB1cmwgcGF0aCB5b3Ugd2FudCB0byByZWRpcmVjdCB0byBvciBhIGZ1bmN0aW9uIAogICAqIHJ1bGUgdGhhdCByZXR1cm5zIHRoZSB1cmwgcGF0aC4gVGhlIGZ1bmN0aW9uIHZlcnNpb24gaXMgcGFzc2VkIHR3byBwYXJhbXM6IAogICAqIGAkaW5qZWN0b3JgIGFuZCBgJGxvY2F0aW9uYCBzZXJ2aWNlcy4KICAgKgogICAqIEByZXR1cm4ge29iamVjdH0gJHVybFJvdXRlclByb3ZpZGVyIC0gJHVybFJvdXRlclByb3ZpZGVyIGluc3RhbmNlCiAgICovCiAgdGhpcy5vdGhlcndpc2UgPQogICAgZnVuY3Rpb24gKHJ1bGUpIHsKICAgICAgaWYgKGlzU3RyaW5nKHJ1bGUpKSB7CiAgICAgICAgdmFyIHJlZGlyZWN0ID0gcnVsZTsKICAgICAgICBydWxlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gcmVkaXJlY3Q7IH07CiAgICAgIH0KICAgICAgZWxzZSBpZiAoIWlzRnVuY3Rpb24ocnVsZSkpIHRocm93IG5ldyBFcnJvcigiJ3J1bGUnIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICBvdGhlcndpc2UgPSBydWxlOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CgoKICBmdW5jdGlvbiBoYW5kbGVJZk1hdGNoKCRpbmplY3RvciwgaGFuZGxlciwgbWF0Y2gpIHsKICAgIGlmICghbWF0Y2gpIHJldHVybiBmYWxzZTsKICAgIHZhciByZXN1bHQgPSAkaW5qZWN0b3IuaW52b2tlKGhhbmRsZXIsIGhhbmRsZXIsIHsgJG1hdGNoOiBtYXRjaCB9KTsKICAgIHJldHVybiBpc0RlZmluZWQocmVzdWx0KSA/IHJlc3VsdCA6IHRydWU7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlciN3aGVuCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlcnMgYSBoYW5kbGVyIGZvciBhIGdpdmVuIHVybCBtYXRjaGluZy4gaWYgaGFuZGxlIGlzIGEgc3RyaW5nLCBpdCBpcwogICAqIHRyZWF0ZWQgYXMgYSByZWRpcmVjdCwgYW5kIGlzIGludGVycG9sYXRlZCBhY2NvcmRpbmcgdG8gdGhlIHN5eW50YXggb2YgbWF0Y2gKICAgKiAoaS5lLiBsaWtlIFN0cmluZy5yZXBsYWNlKCkgZm9yIFJlZ0V4cCwgb3IgbGlrZSBhIFVybE1hdGNoZXIgcGF0dGVybiBvdGhlcndpc2UpLgogICAqCiAgICogSWYgdGhlIGhhbmRsZXIgaXMgYSBmdW5jdGlvbiwgaXQgaXMgaW5qZWN0YWJsZS4gSXQgZ2V0cyBpbnZva2VkIGlmIGAkbG9jYXRpb25gCiAgICogbWF0Y2hlcy4gWW91IGhhdmUgdGhlIG9wdGlvbiBvZiBpbmplY3QgdGhlIG1hdGNoIG9iamVjdCBhcyBgJG1hdGNoYC4KICAgKgogICAqIFRoZSBoYW5kbGVyIGNhbiByZXR1cm4KICAgKgogICAqIC0gKipmYWxzeSoqIHRvIGluZGljYXRlIHRoYXQgdGhlIHJ1bGUgZGlkbid0IG1hdGNoIGFmdGVyIGFsbCwgdGhlbiBgJHVybFJvdXRlcmAKICAgKiAgIHdpbGwgY29udGludWUgdHJ5aW5nIHRvIGZpbmQgYW5vdGhlciBvbmUgdGhhdCBtYXRjaGVzLgogICAqIC0gKipzdHJpbmcqKiB3aGljaCBpcyB0cmVhdGVkIGFzIGEgcmVkaXJlY3QgYW5kIHBhc3NlZCB0byBgJGxvY2F0aW9uLnVybCgpYAogICAqIC0gKip2b2lkKiogb3IgYW55ICoqdHJ1dGh5KiogdmFsdWUgdGVsbHMgYCR1cmxSb3V0ZXJgIHRoYXQgdGhlIHVybCB3YXMgaGFuZGxlZC4KICAgKgogICAqIEBleGFtcGxlCiAgICogPHByZT4KICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyLnJvdXRlciddKTsKICAgKgogICAqIGFwcC5jb25maWcoZnVuY3Rpb24gKCR1cmxSb3V0ZXJQcm92aWRlcikgewogICAqICAgJHVybFJvdXRlclByb3ZpZGVyLndoZW4oJHN0YXRlLnVybCwgZnVuY3Rpb24gKCRtYXRjaCwgJHN0YXRlUGFyYW1zKSB7CiAgICogICAgIGlmICgkc3RhdGUuJGN1cnJlbnQubmF2aWdhYmxlICE9PSBzdGF0ZSB8fAogICAqICAgICAgICAgIWVxdWFsRm9yS2V5cygkbWF0Y2gsICRzdGF0ZVBhcmFtcykgewogICAqICAgICAgJHN0YXRlLnRyYW5zaXRpb25UbyhzdGF0ZSwgJG1hdGNoLCBmYWxzZSk7CiAgICogICAgIH0KICAgKiAgIH0pOwogICAqIH0pOwogICAqIDwvcHJlPgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSB3aGF0IFRoZSBpbmNvbWluZyBwYXRoIHRoYXQgeW91IHdhbnQgdG8gcmVkaXJlY3QuCiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBoYW5kbGVyIFRoZSBwYXRoIHlvdSB3YW50IHRvIHJlZGlyZWN0IHlvdXIgdXNlciB0by4KICAgKi8KICB0aGlzLndoZW4gPQogICAgZnVuY3Rpb24gKHdoYXQsIGhhbmRsZXIpIHsKICAgICAgdmFyIHJlZGlyZWN0LCBoYW5kbGVySXNTdHJpbmcgPSBpc1N0cmluZyhoYW5kbGVyKTsKICAgICAgaWYgKGlzU3RyaW5nKHdoYXQpKSB3aGF0ID0gJHVybE1hdGNoZXJGYWN0b3J5LmNvbXBpbGUod2hhdCk7CgogICAgICBpZiAoIWhhbmRsZXJJc1N0cmluZyAmJiAhaXNGdW5jdGlvbihoYW5kbGVyKSAmJiAhaXNBcnJheShoYW5kbGVyKSkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgJ2hhbmRsZXInIGluIHdoZW4oKSIpOwoKICAgICAgdmFyIHN0cmF0ZWdpZXMgPSB7CiAgICAgICAgbWF0Y2hlcjogZnVuY3Rpb24gKHdoYXQsIGhhbmRsZXIpIHsKICAgICAgICAgIGlmIChoYW5kbGVySXNTdHJpbmcpIHsKICAgICAgICAgICAgcmVkaXJlY3QgPSAkdXJsTWF0Y2hlckZhY3RvcnkuY29tcGlsZShoYW5kbGVyKTsKICAgICAgICAgICAgaGFuZGxlciA9IFsnJG1hdGNoJywgZnVuY3Rpb24gKCRtYXRjaCkgeyByZXR1cm4gcmVkaXJlY3QuZm9ybWF0KCRtYXRjaCk7IH1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAoJGluamVjdG9yLCAkbG9jYXRpb24pIHsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUlmTWF0Y2goJGluamVjdG9yLCBoYW5kbGVyLCB3aGF0LmV4ZWMoJGxvY2F0aW9uLnBhdGgoKSwgJGxvY2F0aW9uLnNlYXJjaCgpKSk7CiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIHByZWZpeDogaXNTdHJpbmcod2hhdC5wcmVmaXgpID8gd2hhdC5wcmVmaXggOiAnJwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByZWdleDogZnVuY3Rpb24gKHdoYXQsIGhhbmRsZXIpIHsKICAgICAgICAgIGlmICh3aGF0Lmdsb2JhbCB8fCB3aGF0LnN0aWNreSkgdGhyb3cgbmV3IEVycm9yKCJ3aGVuKCkgUmVnRXhwIG11c3Qgbm90IGJlIGdsb2JhbCBvciBzdGlja3kiKTsKCiAgICAgICAgICBpZiAoaGFuZGxlcklzU3RyaW5nKSB7CiAgICAgICAgICAgIHJlZGlyZWN0ID0gaGFuZGxlcjsKICAgICAgICAgICAgaGFuZGxlciA9IFsnJG1hdGNoJywgZnVuY3Rpb24gKCRtYXRjaCkgeyByZXR1cm4gaW50ZXJwb2xhdGUocmVkaXJlY3QsICRtYXRjaCk7IH1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAoJGluamVjdG9yLCAkbG9jYXRpb24pIHsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUlmTWF0Y2goJGluamVjdG9yLCBoYW5kbGVyLCB3aGF0LmV4ZWMoJGxvY2F0aW9uLnBhdGgoKSkpOwogICAgICAgICAgfSwgewogICAgICAgICAgICBwcmVmaXg6IHJlZ0V4cFByZWZpeCh3aGF0KQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIGNoZWNrID0geyBtYXRjaGVyOiAkdXJsTWF0Y2hlckZhY3RvcnkuaXNNYXRjaGVyKHdoYXQpLCByZWdleDogd2hhdCBpbnN0YW5jZW9mIFJlZ0V4cCB9OwoKICAgICAgZm9yICh2YXIgbiBpbiBjaGVjaykgewogICAgICAgIGlmIChjaGVja1tuXSkgewogICAgICAgICAgcmV0dXJuIHRoaXMucnVsZShzdHJhdGVnaWVzW25dKHdoYXQsIGhhbmRsZXIpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCAnd2hhdCcgaW4gd2hlbigpIik7CiAgICB9OwoKICAvKioKICAgKiBAbmdkb2Mgb2JqZWN0CiAgICogQG5hbWUgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyCiAgICoKICAgKiBAcmVxdWlyZXMgJGxvY2F0aW9uCiAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqLwogIHRoaXMuJGdldCA9CiAgICBbICAgICAgICAnJGxvY2F0aW9uJywgJyRyb290U2NvcGUnLCAnJGluamVjdG9yJywKICAgIGZ1bmN0aW9uICgkbG9jYXRpb24sICAgJHJvb3RTY29wZSwgICAkaW5qZWN0b3IpIHsKICAgICAgLy8gVE9ETzogT3B0aW1pemUgZ3JvdXBzIG9mIHJ1bGVzIHdpdGggbm9uLWVtcHR5IHByZWZpeCBpbnRvIHNvbWUgc29ydCBvZiBkZWNpc2lvbiB0cmVlCiAgICAgIGZ1bmN0aW9uIHVwZGF0ZShldnQpIHsKICAgICAgICBpZiAoZXZ0ICYmIGV2dC5kZWZhdWx0UHJldmVudGVkKSByZXR1cm47CiAgICAgICAgZnVuY3Rpb24gY2hlY2socnVsZSkgewogICAgICAgICAgdmFyIGhhbmRsZWQgPSBydWxlKCRpbmplY3RvciwgJGxvY2F0aW9uKTsKICAgICAgICAgIGlmIChoYW5kbGVkKSB7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhoYW5kbGVkKSkgJGxvY2F0aW9uLnJlcGxhY2UoKS51cmwoaGFuZGxlZCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgbj1ydWxlcy5sZW5ndGgsIGk7CiAgICAgICAgZm9yIChpPTA7IGk8bjsgaSsrKSB7CiAgICAgICAgICBpZiAoY2hlY2socnVsZXNbaV0pKSByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIGFsd2F5cyBjaGVjayBvdGhlcndpc2UgbGFzdCB0byBhbGxvdyBkeW5hbWljIHVwZGF0ZXMgdG8gdGhlIHNldCBvZiBydWxlcwogICAgICAgIGlmIChvdGhlcndpc2UpIGNoZWNrKG90aGVyd2lzZSk7CiAgICAgIH0KCiAgICAgICRyb290U2NvcGUuJG9uKCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgdXBkYXRlKTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyI3N5bmMKICAgICAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUcmlnZ2VycyBhbiB1cGRhdGU7IHRoZSBzYW1lIHVwZGF0ZSB0aGF0IGhhcHBlbnMgd2hlbiB0aGUgYWRkcmVzcyBiYXIgdXJsIGNoYW5nZXMsIGFrYSBgJGxvY2F0aW9uQ2hhbmdlU3VjY2Vzc2AuCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgdXNlZnVsIHdoZW4geW91IG5lZWQgdG8gdXNlIGBwcmV2ZW50RGVmYXVsdCgpYCBvbiB0aGUgYCRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3NgIGV2ZW50LCAKICAgICAgICAgKiBwZXJmb3JtIHNvbWUgY3VzdG9tIGxvZ2ljIChyb3V0ZSBwcm90ZWN0aW9uLCBhdXRoLCBjb25maWcsIHJlZGlyZWN0aW9uLCBldGMpIGFuZCB0aGVuIGZpbmFsbHkgcHJvY2VlZCAKICAgICAgICAgKiB3aXRoIHRoZSB0cmFuc2l0aW9uIGJ5IGNhbGxpbmcgYCR1cmxSb3V0ZXIuc3luYygpYC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICogPHByZT4KICAgICAgICAgKiBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXInXSk7CiAgICAgICAgICogICAucnVuKGZ1bmN0aW9uKCRyb290U2NvcGUsICR1cmxSb3V0ZXIpIHsKICAgICAgICAgKiAgICAgJHJvb3RTY29wZS4kb24oJyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbihldnQpIHsKICAgICAgICAgKiAgICAgICAvLyBIYWx0IHN0YXRlIGNoYW5nZSBmcm9tIGV2ZW4gc3RhcnRpbmcKICAgICAgICAgKiAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgKiAgICAgICAvLyBQZXJmb3JtIGN1c3RvbSBsb2dpYwogICAgICAgICAqICAgICAgIHZhciBtZWV0c1JlcXVpcmVtZW50ID0gLi4uCiAgICAgICAgICogICAgICAgLy8gQ29udGludWUgd2l0aCB0aGUgdXBkYXRlIGFuZCBzdGF0ZSB0cmFuc2l0aW9uIGlmIGxvZ2ljIGFsbG93cwogICAgICAgICAqICAgICAgIGlmIChtZWV0c1JlcXVpcmVtZW50KSAkdXJsUm91dGVyLnN5bmMoKTsKICAgICAgICAgKiAgICAgfSk7CiAgICAgICAgICogfSk7CiAgICAgICAgICogPC9wcmU+CiAgICAgICAgICovCiAgICAgICAgc3luYzogZnVuY3Rpb24gKCkgewogICAgICAgICAgdXBkYXRlKCk7CiAgICAgICAgfQogICAgICB9OwogICAgfV07Cn0KCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIucm91dGVyJykucHJvdmlkZXIoJyR1cmxSb3V0ZXInLCAkVXJsUm91dGVyUHJvdmlkZXIpOwoKLyoqCiAqIEBuZ2RvYyBvYmplY3QKICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyCiAqCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5UHJvdmlkZXIKICogQHJlcXVpcmVzICRsb2NhdGlvblByb3ZpZGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbmV3IGAkc3RhdGVQcm92aWRlcmAgd29ya3Mgc2ltaWxhciB0byBBbmd1bGFyJ3MgdjEgcm91dGVyLCBidXQgaXQgZm9jdXNlcyBwdXJlbHkKICogb24gc3RhdGUuCiAqCiAqIEEgc3RhdGUgY29ycmVzcG9uZHMgdG8gYSAicGxhY2UiIGluIHRoZSBhcHBsaWNhdGlvbiBpbiB0ZXJtcyBvZiB0aGUgb3ZlcmFsbCBVSSBhbmQKICogbmF2aWdhdGlvbi4gQSBzdGF0ZSBkZXNjcmliZXMgKHZpYSB0aGUgY29udHJvbGxlciAvIHRlbXBsYXRlIC8gdmlldyBwcm9wZXJ0aWVzKSB3aGF0CiAqIHRoZSBVSSBsb29rcyBsaWtlIGFuZCBkb2VzIGF0IHRoYXQgcGxhY2UuCiAqCiAqIFN0YXRlcyBvZnRlbiBoYXZlIHRoaW5ncyBpbiBjb21tb24sIGFuZCB0aGUgcHJpbWFyeSB3YXkgb2YgZmFjdG9yaW5nIG91dCB0aGVzZQogKiBjb21tb25hbGl0aWVzIGluIHRoaXMgbW9kZWwgaXMgdmlhIHRoZSBzdGF0ZSBoaWVyYXJjaHksIGkuZS4gcGFyZW50L2NoaWxkIHN0YXRlcyBha2EKICogbmVzdGVkIHN0YXRlcy4KICoKICogVGhlIGAkc3RhdGVQcm92aWRlcmAgcHJvdmlkZXMgaW50ZXJmYWNlcyB0byBkZWNsYXJlIHRoZXNlIHN0YXRlcyBmb3IgeW91ciBhcHAuCiAqLwokU3RhdGVQcm92aWRlci4kaW5qZWN0ID0gWyckdXJsUm91dGVyUHJvdmlkZXInLCAnJHVybE1hdGNoZXJGYWN0b3J5UHJvdmlkZXInLCAnJGxvY2F0aW9uUHJvdmlkZXInXTsKZnVuY3Rpb24gJFN0YXRlUHJvdmlkZXIoICAgJHVybFJvdXRlclByb3ZpZGVyLCAgICR1cmxNYXRjaGVyRmFjdG9yeSwgICAgICAgICAgICRsb2NhdGlvblByb3ZpZGVyKSB7CgogIHZhciByb290LCBzdGF0ZXMgPSB7fSwgJHN0YXRlLCBxdWV1ZSA9IHt9LCBhYnN0cmFjdEtleSA9ICdhYnN0cmFjdCc7CgogIC8vIEJ1aWxkcyBzdGF0ZSBwcm9wZXJ0aWVzIGZyb20gZGVmaW5pdGlvbiBwYXNzZWQgdG8gcmVnaXN0ZXJTdGF0ZSgpCiAgdmFyIHN0YXRlQnVpbGRlciA9IHsKCiAgICAvLyBEZXJpdmUgcGFyZW50IHN0YXRlIGZyb20gYSBoaWVyYXJjaGljYWwgbmFtZSBvbmx5IGlmICdwYXJlbnQnIGlzIG5vdCBleHBsaWNpdGx5IGRlZmluZWQuCiAgICAvLyBzdGF0ZS5jaGlsZHJlbiA9IFtdOwogICAgLy8gaWYgKHBhcmVudCkgcGFyZW50LmNoaWxkcmVuLnB1c2goc3RhdGUpOwogICAgcGFyZW50OiBmdW5jdGlvbihzdGF0ZSkgewogICAgICBpZiAoaXNEZWZpbmVkKHN0YXRlLnBhcmVudCkgJiYgc3RhdGUucGFyZW50KSByZXR1cm4gZmluZFN0YXRlKHN0YXRlLnBhcmVudCk7CiAgICAgIC8vIHJlZ2V4IG1hdGNoZXMgYW55IHZhbGlkIGNvbXBvc2l0ZSBzdGF0ZSBuYW1lCiAgICAgIC8vIHdvdWxkIG1hdGNoICJjb250YWN0Lmxpc3QiIGJ1dCBub3QgImNvbnRhY3RzIgogICAgICB2YXIgY29tcG9zaXRlTmFtZSA9IC9eKC4rKVwuW14uXSskLy5leGVjKHN0YXRlLm5hbWUpOwogICAgICByZXR1cm4gY29tcG9zaXRlTmFtZSA/IGZpbmRTdGF0ZShjb21wb3NpdGVOYW1lWzFdKSA6IHJvb3Q7CiAgICB9LAoKICAgIC8vIGluaGVyaXQgJ2RhdGEnIGZyb20gcGFyZW50IGFuZCBvdmVycmlkZSBieSBvd24gdmFsdWVzIChpZiBhbnkpCiAgICBkYXRhOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICBpZiAoc3RhdGUucGFyZW50ICYmIHN0YXRlLnBhcmVudC5kYXRhKSB7CiAgICAgICAgc3RhdGUuZGF0YSA9IHN0YXRlLnNlbGYuZGF0YSA9IGV4dGVuZCh7fSwgc3RhdGUucGFyZW50LmRhdGEsIHN0YXRlLmRhdGEpOwogICAgICB9CiAgICAgIHJldHVybiBzdGF0ZS5kYXRhOwogICAgfSwKCiAgICAvLyBCdWlsZCBhIFVSTE1hdGNoZXIgaWYgbmVjZXNzYXJ5LCBlaXRoZXIgdmlhIGEgcmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMCiAgICB1cmw6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgIHZhciB1cmwgPSBzdGF0ZS51cmw7CgogICAgICBpZiAoaXNTdHJpbmcodXJsKSkgewogICAgICAgIGlmICh1cmwuY2hhckF0KDApID09ICdeJykgewogICAgICAgICAgcmV0dXJuICR1cmxNYXRjaGVyRmFjdG9yeS5jb21waWxlKHVybC5zdWJzdHJpbmcoMSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKHN0YXRlLnBhcmVudC5uYXZpZ2FibGUgfHwgcm9vdCkudXJsLmNvbmNhdCh1cmwpOwogICAgICB9CgogICAgICBpZiAoJHVybE1hdGNoZXJGYWN0b3J5LmlzTWF0Y2hlcih1cmwpIHx8IHVybCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHVybDsKICAgICAgfQogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgdXJsICciICsgdXJsICsgIicgaW4gc3RhdGUgJyIgKyBzdGF0ZSArICInIik7CiAgICB9LAoKICAgIC8vIEtlZXAgdHJhY2sgb2YgdGhlIGNsb3Nlc3QgYW5jZXN0b3Igc3RhdGUgdGhhdCBoYXMgYSBVUkwgKGkuZS4gaXMgbmF2aWdhYmxlKQogICAgbmF2aWdhYmxlOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICByZXR1cm4gc3RhdGUudXJsID8gc3RhdGUgOiAoc3RhdGUucGFyZW50ID8gc3RhdGUucGFyZW50Lm5hdmlnYWJsZSA6IG51bGwpOwogICAgfSwKCiAgICAvLyBEZXJpdmUgcGFyYW1ldGVycyBmb3IgdGhpcyBzdGF0ZSBhbmQgZW5zdXJlIHRoZXkncmUgYSBzdXBlci1zZXQgb2YgcGFyZW50J3MgcGFyYW1ldGVycwogICAgcGFyYW1zOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICBpZiAoIXN0YXRlLnBhcmFtcykgewogICAgICAgIHJldHVybiBzdGF0ZS51cmwgPyBzdGF0ZS51cmwucGFyYW1ldGVycygpIDogc3RhdGUucGFyZW50LnBhcmFtczsKICAgICAgfQogICAgICBpZiAoIWlzQXJyYXkoc3RhdGUucGFyYW1zKSkgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHBhcmFtcyBpbiBzdGF0ZSAnIiArIHN0YXRlICsgIiciKTsKICAgICAgaWYgKHN0YXRlLnVybCkgdGhyb3cgbmV3IEVycm9yKCJCb3RoIHBhcmFtcyBhbmQgdXJsIHNwZWNpY2lmaWVkIGluIHN0YXRlICciICsgc3RhdGUgKyAiJyIpOwogICAgICByZXR1cm4gc3RhdGUucGFyYW1zOwogICAgfSwKCiAgICAvLyBJZiB0aGVyZSBpcyBubyBleHBsaWNpdCBtdWx0aS12aWV3IGNvbmZpZ3VyYXRpb24sIG1ha2Ugb25lIHVwIHNvIHdlIGRvbid0IGhhdmUKICAgIC8vIHRvIGhhbmRsZSBib3RoIGNhc2VzIGluIHRoZSB2aWV3IGRpcmVjdGl2ZSBsYXRlci4gTm90ZSB0aGF0IGhhdmluZyBhbiBleHBsaWNpdAogICAgLy8gJ3ZpZXdzJyBwcm9wZXJ0eSB3aWxsIG1lYW4gdGhlIGRlZmF1bHQgdW5uYW1lZCB2aWV3IHByb3BlcnRpZXMgYXJlIGlnbm9yZWQuIFRoaXMKICAgIC8vIGlzIGFsc28gYSBnb29kIHRpbWUgdG8gcmVzb2x2ZSB2aWV3IG5hbWVzIHRvIGFic29sdXRlIG5hbWVzLCBzbyBldmVyeXRoaW5nIGlzIGEKICAgIC8vIHN0cmFpZ2h0IGxvb2t1cCBhdCBsaW5rIHRpbWUuCiAgICB2aWV3czogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgdmFyIHZpZXdzID0ge307CgogICAgICBmb3JFYWNoKGlzRGVmaW5lZChzdGF0ZS52aWV3cykgPyBzdGF0ZS52aWV3cyA6IHsgJyc6IHN0YXRlIH0sIGZ1bmN0aW9uICh2aWV3LCBuYW1lKSB7CiAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignQCcpIDwgMCkgbmFtZSArPSAnQCcgKyBzdGF0ZS5wYXJlbnQubmFtZTsKICAgICAgICB2aWV3c1tuYW1lXSA9IHZpZXc7CiAgICAgIH0pOwogICAgICByZXR1cm4gdmlld3M7CiAgICB9LAoKICAgIG93blBhcmFtczogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgaWYgKCFzdGF0ZS5wYXJlbnQpIHsKICAgICAgICByZXR1cm4gc3RhdGUucGFyYW1zOwogICAgICB9CiAgICAgIHZhciBwYXJhbU5hbWVzID0ge307IGZvckVhY2goc3RhdGUucGFyYW1zLCBmdW5jdGlvbiAocCkgeyBwYXJhbU5hbWVzW3BdID0gdHJ1ZTsgfSk7CgogICAgICBmb3JFYWNoKHN0YXRlLnBhcmVudC5wYXJhbXMsIGZ1bmN0aW9uIChwKSB7CiAgICAgICAgaWYgKCFwYXJhbU5hbWVzW3BdKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgcmVxdWlyZWQgcGFyYW1ldGVyICciICsgcCArICInIGluIHN0YXRlICciICsgc3RhdGUubmFtZSArICInIik7CiAgICAgICAgfQogICAgICAgIHBhcmFtTmFtZXNbcF0gPSBmYWxzZTsKICAgICAgfSk7CiAgICAgIHZhciBvd25QYXJhbXMgPSBbXTsKCiAgICAgIGZvckVhY2gocGFyYW1OYW1lcywgZnVuY3Rpb24gKG93biwgcCkgewogICAgICAgIGlmIChvd24pIG93blBhcmFtcy5wdXNoKHApOwogICAgICB9KTsKICAgICAgcmV0dXJuIG93blBhcmFtczsKICAgIH0sCgogICAgLy8gS2VlcCBhIGZ1bGwgcGF0aCBmcm9tIHRoZSByb290IGRvd24gdG8gdGhpcyBzdGF0ZSBhcyB0aGlzIGlzIG5lZWRlZCBmb3Igc3RhdGUgYWN0aXZhdGlvbi4KICAgIHBhdGg6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgIHJldHVybiBzdGF0ZS5wYXJlbnQgPyBzdGF0ZS5wYXJlbnQucGF0aC5jb25jYXQoc3RhdGUpIDogW107IC8vIGV4Y2x1ZGUgcm9vdCBmcm9tIHBhdGgKICAgIH0sCgogICAgLy8gU3BlZWQgdXAgJHN0YXRlLmNvbnRhaW5zKCkgYXMgaXQncyB1c2VkIGEgbG90CiAgICBpbmNsdWRlczogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgdmFyIGluY2x1ZGVzID0gc3RhdGUucGFyZW50ID8gZXh0ZW5kKHt9LCBzdGF0ZS5wYXJlbnQuaW5jbHVkZXMpIDoge307CiAgICAgIGluY2x1ZGVzW3N0YXRlLm5hbWVdID0gdHJ1ZTsKICAgICAgcmV0dXJuIGluY2x1ZGVzOwogICAgfSwKCiAgICAkZGVsZWdhdGVzOiB7fQogIH07CgogIGZ1bmN0aW9uIGlzUmVsYXRpdmUoc3RhdGVOYW1lKSB7CiAgICByZXR1cm4gc3RhdGVOYW1lLmluZGV4T2YoIi4iKSA9PT0gMCB8fCBzdGF0ZU5hbWUuaW5kZXhPZigiXiIpID09PSAwOwogIH0KCiAgZnVuY3Rpb24gZmluZFN0YXRlKHN0YXRlT3JOYW1lLCBiYXNlKSB7CiAgICB2YXIgaXNTdHIgPSBpc1N0cmluZyhzdGF0ZU9yTmFtZSksCiAgICAgICAgbmFtZSAgPSBpc1N0ciA/IHN0YXRlT3JOYW1lIDogc3RhdGVPck5hbWUubmFtZSwKICAgICAgICBwYXRoICA9IGlzUmVsYXRpdmUobmFtZSk7CgogICAgaWYgKHBhdGgpIHsKICAgICAgaWYgKCFiYXNlKSB0aHJvdyBuZXcgRXJyb3IoIk5vIHJlZmVyZW5jZSBwb2ludCBnaXZlbiBmb3IgcGF0aCAnIiAgKyBuYW1lICsgIiciKTsKICAgICAgdmFyIHJlbCA9IG5hbWUuc3BsaXQoIi4iKSwgaSA9IDAsIHBhdGhMZW5ndGggPSByZWwubGVuZ3RoLCBjdXJyZW50ID0gYmFzZTsKCiAgICAgIGZvciAoOyBpIDwgcGF0aExlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJlbFtpXSA9PT0gIiIgJiYgaSA9PT0gMCkgewogICAgICAgICAgY3VycmVudCA9IGJhc2U7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlbFtpXSA9PT0gIl4iKSB7CiAgICAgICAgICBpZiAoIWN1cnJlbnQucGFyZW50KSB0aHJvdyBuZXcgRXJyb3IoIlBhdGggJyIgKyBuYW1lICsgIicgbm90IHZhbGlkIGZvciBzdGF0ZSAnIiArIGJhc2UubmFtZSArICInIik7CiAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5wYXJlbnQ7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcmVsID0gcmVsLnNsaWNlKGkpLmpvaW4oIi4iKTsKICAgICAgbmFtZSA9IGN1cnJlbnQubmFtZSArIChjdXJyZW50Lm5hbWUgJiYgcmVsID8gIi4iIDogIiIpICsgcmVsOwogICAgfQogICAgdmFyIHN0YXRlID0gc3RhdGVzW25hbWVdOwoKICAgIGlmIChzdGF0ZSAmJiAoaXNTdHIgfHwgKCFpc1N0ciAmJiAoc3RhdGUgPT09IHN0YXRlT3JOYW1lIHx8IHN0YXRlLnNlbGYgPT09IHN0YXRlT3JOYW1lKSkpKSB7CiAgICAgIHJldHVybiBzdGF0ZTsKICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiBxdWV1ZVN0YXRlKHBhcmVudE5hbWUsIHN0YXRlKSB7CiAgICBpZiAoIXF1ZXVlW3BhcmVudE5hbWVdKSB7CiAgICAgIHF1ZXVlW3BhcmVudE5hbWVdID0gW107CiAgICB9CiAgICBxdWV1ZVtwYXJlbnROYW1lXS5wdXNoKHN0YXRlKTsKICB9CgogIGZ1bmN0aW9uIHJlZ2lzdGVyU3RhdGUoc3RhdGUpIHsKICAgIC8vIFdyYXAgYSBuZXcgb2JqZWN0IGFyb3VuZCB0aGUgc3RhdGUgc28gd2UgY2FuIHN0b3JlIG91ciBwcml2YXRlIGRldGFpbHMgZWFzaWx5LgogICAgc3RhdGUgPSBpbmhlcml0KHN0YXRlLCB7CiAgICAgIHNlbGY6IHN0YXRlLAogICAgICByZXNvbHZlOiBzdGF0ZS5yZXNvbHZlIHx8IHt9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLm5hbWU7IH0KICAgIH0pOwoKICAgIHZhciBuYW1lID0gc3RhdGUubmFtZTsKICAgIGlmICghaXNTdHJpbmcobmFtZSkgfHwgbmFtZS5pbmRleE9mKCdAJykgPj0gMCkgdGhyb3cgbmV3IEVycm9yKCJTdGF0ZSBtdXN0IGhhdmUgYSB2YWxpZCBuYW1lIik7CiAgICBpZiAoc3RhdGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB0aHJvdyBuZXcgRXJyb3IoIlN0YXRlICciICsgbmFtZSArICInJyBpcyBhbHJlYWR5IGRlZmluZWQiKTsKCiAgICAvLyBHZXQgcGFyZW50IG5hbWUKICAgIHZhciBwYXJlbnROYW1lID0gKG5hbWUuaW5kZXhPZignLicpICE9PSAtMSkgPyBuYW1lLnN1YnN0cmluZygwLCBuYW1lLmxhc3RJbmRleE9mKCcuJykpCiAgICAgICAgOiAoaXNTdHJpbmcoc3RhdGUucGFyZW50KSkgPyBzdGF0ZS5wYXJlbnQKICAgICAgICA6ICcnOwoKICAgIC8vIElmIHBhcmVudCBpcyBub3QgcmVnaXN0ZXJlZCB5ZXQsIGFkZCBzdGF0ZSB0byBxdWV1ZSBhbmQgcmVnaXN0ZXIgbGF0ZXIKICAgIGlmIChwYXJlbnROYW1lICYmICFzdGF0ZXNbcGFyZW50TmFtZV0pIHsKICAgICAgcmV0dXJuIHF1ZXVlU3RhdGUocGFyZW50TmFtZSwgc3RhdGUuc2VsZik7CiAgICB9CgogICAgZm9yICh2YXIga2V5IGluIHN0YXRlQnVpbGRlcikgewogICAgICBpZiAoaXNGdW5jdGlvbihzdGF0ZUJ1aWxkZXJba2V5XSkpIHN0YXRlW2tleV0gPSBzdGF0ZUJ1aWxkZXJba2V5XShzdGF0ZSwgc3RhdGVCdWlsZGVyLiRkZWxlZ2F0ZXNba2V5XSk7CiAgICB9CiAgICBzdGF0ZXNbbmFtZV0gPSBzdGF0ZTsKCiAgICAvLyBSZWdpc3RlciB0aGUgc3RhdGUgaW4gdGhlIGdsb2JhbCBzdGF0ZSBsaXN0IGFuZCB3aXRoICR1cmxSb3V0ZXIgaWYgbmVjZXNzYXJ5LgogICAgaWYgKCFzdGF0ZVthYnN0cmFjdEtleV0gJiYgc3RhdGUudXJsKSB7CiAgICAgICR1cmxSb3V0ZXJQcm92aWRlci53aGVuKHN0YXRlLnVybCwgWyckbWF0Y2gnLCAnJHN0YXRlUGFyYW1zJywgZnVuY3Rpb24gKCRtYXRjaCwgJHN0YXRlUGFyYW1zKSB7CiAgICAgICAgaWYgKCRzdGF0ZS4kY3VycmVudC5uYXZpZ2FibGUgIT0gc3RhdGUgfHwgIWVxdWFsRm9yS2V5cygkbWF0Y2gsICRzdGF0ZVBhcmFtcykpIHsKICAgICAgICAgICRzdGF0ZS50cmFuc2l0aW9uVG8oc3RhdGUsICRtYXRjaCwgeyBsb2NhdGlvbjogZmFsc2UgfSk7CiAgICAgICAgfQogICAgICB9XSk7CiAgICB9CgogICAgLy8gUmVnaXN0ZXIgYW55IHF1ZXVlZCBjaGlsZHJlbgogICAgaWYgKHF1ZXVlW25hbWVdKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVbbmFtZV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICByZWdpc3RlclN0YXRlKHF1ZXVlW25hbWVdW2ldKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBzdGF0ZTsKICB9CgogIC8vIENoZWNrcyB0ZXh0IHRvIHNlZSBpZiBpdCBsb29rcyBsaWtlIGEgZ2xvYi4KICBmdW5jdGlvbiBpc0dsb2IgKHRleHQpIHsKICAgIHJldHVybiB0ZXh0LmluZGV4T2YoJyonKSA+IC0xOwogIH0KCiAgLy8gUmV0dXJucyB0cnVlIGlmIGdsb2IgbWF0Y2hlcyBjdXJyZW50ICRzdGF0ZSBuYW1lLgogIGZ1bmN0aW9uIGRvZXNTdGF0ZU1hdGNoR2xvYiAoZ2xvYikgewogICAgdmFyIGdsb2JTZWdtZW50cyA9IGdsb2Iuc3BsaXQoJy4nKSwKICAgICAgICBzZWdtZW50cyA9ICRzdGF0ZS4kY3VycmVudC5uYW1lLnNwbGl0KCcuJyk7CgogICAgLy9tYXRjaCBncmVlZHkgc3RhcnRzCiAgICBpZiAoZ2xvYlNlZ21lbnRzWzBdID09PSAnKionKSB7CiAgICAgICBzZWdtZW50cyA9IHNlZ21lbnRzLnNsaWNlKHNlZ21lbnRzLmluZGV4T2YoZ2xvYlNlZ21lbnRzWzFdKSk7CiAgICAgICBzZWdtZW50cy51bnNoaWZ0KCcqKicpOwogICAgfQogICAgLy9tYXRjaCBncmVlZHkgZW5kcwogICAgaWYgKGdsb2JTZWdtZW50c1tnbG9iU2VnbWVudHMubGVuZ3RoIC0gMV0gPT09ICcqKicpIHsKICAgICAgIHNlZ21lbnRzLnNwbGljZShzZWdtZW50cy5pbmRleE9mKGdsb2JTZWdtZW50c1tnbG9iU2VnbWVudHMubGVuZ3RoIC0gMl0pICsgMSwgTnVtYmVyLk1BWF9WQUxVRSk7CiAgICAgICBzZWdtZW50cy5wdXNoKCcqKicpOwogICAgfQoKICAgIGlmIChnbG9iU2VnbWVudHMubGVuZ3RoICE9IHNlZ21lbnRzLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy9tYXRjaCBzaW5nbGUgc3RhcnMKICAgIGZvciAodmFyIGkgPSAwLCBsID0gZ2xvYlNlZ21lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBpZiAoZ2xvYlNlZ21lbnRzW2ldID09PSAnKicpIHsKICAgICAgICBzZWdtZW50c1tpXSA9ICcqJzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBzZWdtZW50cy5qb2luKCcnKSA9PT0gZ2xvYlNlZ21lbnRzLmpvaW4oJycpOwogIH0KCgogIC8vIEltcGxpY2l0IHJvb3Qgc3RhdGUgdGhhdCBpcyBhbHdheXMgYWN0aXZlCiAgcm9vdCA9IHJlZ2lzdGVyU3RhdGUoewogICAgbmFtZTogJycsCiAgICB1cmw6ICdeJywKICAgIHZpZXdzOiBudWxsLAogICAgJ2Fic3RyYWN0JzogdHJ1ZQogIH0pOwogIHJvb3QubmF2aWdhYmxlID0gbnVsbDsKCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlciNkZWNvcmF0b3IKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBbGxvd3MgeW91IHRvIGV4dGVuZCAoY2FyZWZ1bGx5KSBvciBvdmVycmlkZSAoYXQgeW91ciBvd24gcGVyaWwpIHRoZSAKICAgKiBgc3RhdGVCdWlsZGVyYCBvYmplY3QgdXNlZCBpbnRlcm5hbGx5IGJ5IGAkc3RhdGVQcm92aWRlcmAuIFRoaXMgY2FuIGJlIHVzZWQgCiAgICogdG8gYWRkIGN1c3RvbSBmdW5jdGlvbmFsaXR5IHRvIHVpLXJvdXRlciwgZm9yIGV4YW1wbGUgaW5mZXJyaW5nIHRlbXBsYXRlVXJsIAogICAqIGJhc2VkIG9uIHRoZSBzdGF0ZSBuYW1lLgogICAqCiAgICogV2hlbiBwYXNzaW5nIG9ubHkgYSBuYW1lLCBpdCByZXR1cm5zIHRoZSBjdXJyZW50IChvcmlnaW5hbCBvciBkZWNvcmF0ZWQpIGJ1aWxkZXIKICAgKiBmdW5jdGlvbiB0aGF0IG1hdGNoZXMgYG5hbWVgLgogICAqCiAgICogVGhlIGJ1aWxkZXIgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIGRlY29yYXRlZCBhcmUgbGlzdGVkIGJlbG93LiBUaG91Z2ggbm90IGFsbAogICAqIG5lY2Vzc2FyaWx5IGhhdmUgYSBnb29kIHVzZSBjYXNlIGZvciBkZWNvcmF0aW9uLCB0aGF0IGlzIHVwIHRvIHlvdSB0byBkZWNpZGUuCiAgICoKICAgKiBJbiBhZGRpdGlvbiwgdXNlcnMgY2FuIGF0dGFjaCBjdXN0b20gZGVjb3JhdG9ycywgd2hpY2ggd2lsbCBnZW5lcmF0ZSBuZXcgCiAgICogcHJvcGVydGllcyB3aXRoaW4gdGhlIHN0YXRlJ3MgaW50ZXJuYWwgZGVmaW5pdGlvbi4gVGhlcmUgaXMgY3VycmVudGx5IG5vIGNsZWFyIAogICAqIHVzZS1jYXNlIGZvciB0aGlzIGJleW9uZCBhY2Nlc3NpbmcgaW50ZXJuYWwgc3RhdGVzIChpLmUuICRzdGF0ZS4kY3VycmVudCksIAogICAqIGhvd2V2ZXIsIGV4cGVjdCB0aGlzIHRvIGJlY29tZSBpbmNyZWFzaW5nbHkgcmVsZXZhbnQgYXMgd2UgaW50cm9kdWNlIGFkZGl0aW9uYWwgCiAgICogbWV0YS1wcm9ncmFtbWluZyBmZWF0dXJlcy4KICAgKgogICAqICoqV2FybmluZyoqOiBEZWNvcmF0b3JzIHNob3VsZCBub3QgYmUgaW50ZXJkZXBlbmRlbnQgYmVjYXVzZSB0aGUgb3JkZXIgb2YgCiAgICogZXhlY3V0aW9uIG9mIHRoZSBidWlsZGVyIGZ1bmN0aW9ucyBpbiBub24tZGV0ZXJtaW5pc3RpYy4gQnVpbGRlciBmdW5jdGlvbnMgCiAgICogc2hvdWxkIG9ubHkgYmUgZGVwZW5kZW50IG9uIHRoZSBzdGF0ZSBkZWZpbml0aW9uIG9iamVjdCBhbmQgc3VwZXIgZnVuY3Rpb24uCiAgICoKICAgKgogICAqIEV4aXN0aW5nIGJ1aWxkZXIgZnVuY3Rpb25zIGFuZCBjdXJyZW50IHJldHVybiB2YWx1ZXM6CiAgICoKICAgKiAtICoqcGFyZW50KiogYHtvYmplY3R9YCAtIHJldHVybnMgdGhlIHBhcmVudCBzdGF0ZSBvYmplY3QuCiAgICogLSAqKmRhdGEqKiBge29iamVjdH1gIC0gcmV0dXJucyBzdGF0ZSBkYXRhLCBpbmNsdWRpbmcgYW55IGluaGVyaXRlZCBkYXRhIHRoYXQgaXMgbm90CiAgICogICBvdmVycmlkZGVuIGJ5IG93biB2YWx1ZXMgKGlmIGFueSkuCiAgICogLSAqKnVybCoqIGB7b2JqZWN0fWAgLSByZXR1cm5zIGEge2xpbmsgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyfSBvciBudWxsLgogICAqIC0gKipuYXZpZ2FibGUqKiBge29iamVjdH1gIC0gcmV0dXJucyBjbG9zZXN0IGFuY2VzdG9yIHN0YXRlIHRoYXQgaGFzIGEgVVJMIChha2EgaXMgCiAgICogICBuYXZpZ2FibGUpLgogICAqIC0gKipwYXJhbXMqKiBge29iamVjdH1gIC0gcmV0dXJucyBhbiBhcnJheSBvZiBzdGF0ZSBwYXJhbXMgdGhhdCBhcmUgZW5zdXJlZCB0byAKICAgKiAgIGJlIGEgc3VwZXItc2V0IG9mIHBhcmVudCdzIHBhcmFtcy4KICAgKiAtICoqdmlld3MqKiBge29iamVjdH1gIC0gcmV0dXJucyBhIHZpZXdzIG9iamVjdCB3aGVyZSBlYWNoIGtleSBpcyBhbiBhYnNvbHV0ZSB2aWV3IAogICAqICAgbmFtZSAoaS5lLiAidmlld05hbWVAc3RhdGVOYW1lIikgYW5kIGVhY2ggdmFsdWUgaXMgdGhlIGNvbmZpZyBvYmplY3QgCiAgICogICAodGVtcGxhdGUsIGNvbnRyb2xsZXIpIGZvciB0aGUgdmlldy4gRXZlbiB3aGVuIHlvdSBkb24ndCB1c2UgdGhlIHZpZXdzIG9iamVjdCAKICAgKiAgIGV4cGxpY2l0bHkgb24gYSBzdGF0ZSBjb25maWcsIG9uZSBpcyBzdGlsbCBjcmVhdGVkIGZvciB5b3UgaW50ZXJuYWxseS4KICAgKiAgIFNvIGJ5IGRlY29yYXRpbmcgdGhpcyBidWlsZGVyIGZ1bmN0aW9uIHlvdSBoYXZlIGFjY2VzcyB0byBkZWNvcmF0aW5nIHRlbXBsYXRlIAogICAqICAgYW5kIGNvbnRyb2xsZXIgcHJvcGVydGllcy4KICAgKiAtICoqb3duUGFyYW1zKiogYHtvYmplY3R9YCAtIHJldHVybnMgYW4gYXJyYXkgb2YgcGFyYW1zIHRoYXQgYmVsb25nIHRvIHRoZSBzdGF0ZSwgCiAgICogICBub3QgaW5jbHVkaW5nIGFueSBwYXJhbXMgZGVmaW5lZCBieSBhbmNlc3RvciBzdGF0ZXMuCiAgICogLSAqKnBhdGgqKiBge3N0cmluZ31gIC0gcmV0dXJucyB0aGUgZnVsbCBwYXRoIGZyb20gdGhlIHJvb3QgZG93biB0byB0aGlzIHN0YXRlLiAKICAgKiAgIE5lZWRlZCBmb3Igc3RhdGUgYWN0aXZhdGlvbi4KICAgKiAtICoqaW5jbHVkZXMqKiBge29iamVjdH1gIC0gcmV0dXJucyBhbiBvYmplY3QgdGhhdCBpbmNsdWRlcyBldmVyeSBzdGF0ZSB0aGF0IAogICAqICAgd291bGQgcGFzcyBhICckc3RhdGUuaW5jbHVkZXMoKScgdGVzdC4KICAgKgogICAqIEBleGFtcGxlCiAgICogPHByZT4KICAgKiAvLyBPdmVycmlkZSB0aGUgaW50ZXJuYWwgJ3ZpZXdzJyBidWlsZGVyIHdpdGggYSBmdW5jdGlvbiB0aGF0IHRha2VzIHRoZSBzdGF0ZQogICAqIC8vIGRlZmluaXRpb24sIGFuZCBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgZnVuY3Rpb24gYmVpbmcgb3ZlcnJpZGRlbjoKICAgKiAkc3RhdGVQcm92aWRlci5kZWNvcmF0b3IoJ3ZpZXdzJywgZnVuY3Rpb24gKCRzdGF0ZSwgcGFyZW50KSB7CiAgICogICB2YXIgcmVzdWx0ID0ge30sCiAgICogICAgICAgdmlld3MgPSBwYXJlbnQoc3RhdGUpOwogICAqCiAgICogICBhbmd1bGFyLmZvckVhY2godmlldywgZnVuY3Rpb24gKGNvbmZpZywgbmFtZSkgewogICAqICAgICB2YXIgYXV0b05hbWUgPSAoc3RhdGUubmFtZSArICcuJyArIG5hbWUpLnJlcGxhY2UoJy4nLCAnLycpOwogICAqICAgICBjb25maWcudGVtcGxhdGVVcmwgPSBjb25maWcudGVtcGxhdGVVcmwgfHwgJy9wYXJ0aWFscy8nICsgYXV0b05hbWUgKyAnLmh0bWwnOwogICAqICAgICByZXN1bHRbbmFtZV0gPSBjb25maWc7CiAgICogICB9KTsKICAgKiAgIHJldHVybiByZXN1bHQ7CiAgICogfSk7CiAgICoKICAgKiAkc3RhdGVQcm92aWRlci5zdGF0ZSgnaG9tZScsIHsKICAgKiAgIHZpZXdzOiB7CiAgICogICAgICdjb250YWN0Lmxpc3QnOiB7IGNvbnRyb2xsZXI6ICdMaXN0Q29udHJvbGxlcicgfSwKICAgKiAgICAgJ2NvbnRhY3QuaXRlbSc6IHsgY29udHJvbGxlcjogJ0l0ZW1Db250cm9sbGVyJyB9CiAgICogICB9CiAgICogfSk7CiAgICoKICAgKiAvLyAuLi4KICAgKgogICAqICRzdGF0ZS5nbygnaG9tZScpOwogICAqIC8vIEF1dG8tcG9wdWxhdGVzIGxpc3QgYW5kIGl0ZW0gdmlld3Mgd2l0aCAvcGFydGlhbHMvaG9tZS9jb250YWN0L2xpc3QuaHRtbCwKICAgKiAvLyBhbmQgL3BhcnRpYWxzL2hvbWUvY29udGFjdC9pdGVtLmh0bWwsIHJlc3BlY3RpdmVseS4KICAgKiA8L3ByZT4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBidWlsZGVyIGZ1bmN0aW9uIHRvIGRlY29yYXRlLiAKICAgKiBAcGFyYW0ge29iamVjdH0gZnVuYyBBIGZ1bmN0aW9uIHRoYXQgaXMgcmVzcG9uc2libGUgZm9yIGRlY29yYXRpbmcgdGhlIG9yaWdpbmFsIAogICAqIGJ1aWxkZXIgZnVuY3Rpb24uIFRoZSBmdW5jdGlvbiByZWNlaXZlcyB0d28gcGFyYW1ldGVyczoKICAgKgogICAqICAgLSBge29iamVjdH1gIC0gc3RhdGUgLSBUaGUgc3RhdGUgY29uZmlnIG9iamVjdC4KICAgKiAgIC0gYHtvYmplY3R9YCAtIHN1cGVyIC0gVGhlIG9yaWdpbmFsIGJ1aWxkZXIgZnVuY3Rpb24uCiAgICoKICAgKiBAcmV0dXJuIHtvYmplY3R9ICRzdGF0ZVByb3ZpZGVyIC0gJHN0YXRlUHJvdmlkZXIgaW5zdGFuY2UKICAgKi8KICB0aGlzLmRlY29yYXRvciA9IGRlY29yYXRvcjsKICBmdW5jdGlvbiBkZWNvcmF0b3IobmFtZSwgZnVuYykgewogICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICBpZiAoaXNTdHJpbmcobmFtZSkgJiYgIWlzRGVmaW5lZChmdW5jKSkgewogICAgICByZXR1cm4gc3RhdGVCdWlsZGVyW25hbWVdOwogICAgfQogICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpIHx8ICFpc1N0cmluZyhuYW1lKSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGlmIChzdGF0ZUJ1aWxkZXJbbmFtZV0gJiYgIXN0YXRlQnVpbGRlci4kZGVsZWdhdGVzW25hbWVdKSB7CiAgICAgIHN0YXRlQnVpbGRlci4kZGVsZWdhdGVzW25hbWVdID0gc3RhdGVCdWlsZGVyW25hbWVdOwogICAgfQogICAgc3RhdGVCdWlsZGVyW25hbWVdID0gZnVuYzsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyI3N0YXRlCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVnaXN0ZXJzIGEgc3RhdGUgY29uZmlndXJhdGlvbiB1bmRlciBhIGdpdmVuIHN0YXRlIG5hbWUuIFRoZSBzdGF0ZUNvbmZpZyBvYmplY3QKICAgKiBoYXMgdGhlIGZvbGxvd2luZyBhY2NlcHRhYmxlIHByb3BlcnRpZXMuCiAgICoKICAgKiA8YSBpZD0ndGVtcGxhdGUnPjwvYT4KICAgKgogICAqIC0gKipgdGVtcGxhdGVgKiogLSB7c3RyaW5nfGZ1bmN0aW9uPX0gLSBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zCiAgICogICBhbiBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nIHdoaWNoIHNob3VsZCBiZSB1c2VkIGJ5IHRoZSB1aVZpZXcgZGlyZWN0aXZlcy4gVGhpcyBwcm9wZXJ0eSAKICAgKiAgIHRha2VzIHByZWNlZGVuY2Ugb3ZlciB0ZW1wbGF0ZVVybC4KICAgKiAgIAogICAqICAgSWYgYHRlbXBsYXRlYCBpcyBhIGZ1bmN0aW9uLCBpdCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICAgKgogICAqICAgLSB7YXJyYXkuJmx0O29iamVjdCZndDt9IC0gc3RhdGUgcGFyYW1ldGVycyBleHRyYWN0ZWQgZnJvbSB0aGUgY3VycmVudCAkbG9jYXRpb24ucGF0aCgpIGJ5CiAgICogICAgIGFwcGx5aW5nIHRoZSBjdXJyZW50IHN0YXRlCiAgICoKICAgKiA8YSBpZD0ndGVtcGxhdGVVcmwnPjwvYT4KICAgKgogICAqIC0gKipgdGVtcGxhdGVVcmxgKiogLSB7c3RyaW5nfGZ1bmN0aW9uPX0gLSBwYXRoIG9yIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIHBhdGggdG8gYW4gaHRtbCAKICAgKiAgIHRlbXBsYXRlIHRoYXQgc2hvdWxkIGJlIHVzZWQgYnkgdWlWaWV3LgogICAqICAgCiAgICogICBJZiBgdGVtcGxhdGVVcmxgIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAqCiAgICogICAtIHthcnJheS4mbHQ7b2JqZWN0Jmd0O30gLSBzdGF0ZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBjdXJyZW50ICRsb2NhdGlvbi5wYXRoKCkgYnkgCiAgICogICAgIGFwcGx5aW5nIHRoZSBjdXJyZW50IHN0YXRlCiAgICoKICAgKiA8YSBpZD0ndGVtcGxhdGVQcm92aWRlcic+PC9hPgogICAqCiAgICogLSAqKmB0ZW1wbGF0ZVByb3ZpZGVyYCoqIC0ge2Z1bmN0aW9uPX0gLSBQcm92aWRlciBmdW5jdGlvbiB0aGF0IHJldHVybnMgSFRNTCBjb250ZW50CiAgICogICBzdHJpbmcuCiAgICoKICAgKiA8YSBpZD0nY29udHJvbGxlcic+PC9hPgogICAqCiAgICogLSAqKmBjb250cm9sbGVyYCoqIC0ge3N0cmluZ3xmdW5jdGlvbj19IC0gIENvbnRyb2xsZXIgZm4gdGhhdCBzaG91bGQgYmUgYXNzb2NpYXRlZCB3aXRoIG5ld2x5IAogICAqICAgcmVsYXRlZCBzY29wZSBvciB0aGUgbmFtZSBvZiBhIHJlZ2lzdGVyZWQgY29udHJvbGxlciBpZiBwYXNzZWQgYXMgYSBzdHJpbmcuCiAgICoKICAgKiA8YSBpZD0nY29udHJvbGxlclByb3ZpZGVyJz48L2E+CiAgICoKICAgKiAtICoqYGNvbnRyb2xsZXJQcm92aWRlcmAqKiAtIHtmdW5jdGlvbj19IC0gSW5qZWN0YWJsZSBwcm92aWRlciBmdW5jdGlvbiB0aGF0IHJldHVybnMKICAgKiAgIHRoZSBhY3R1YWwgY29udHJvbGxlciBvciBzdHJpbmcuCiAgICoKICAgKiA8YSBpZD0nY29udHJvbGxlckFzJz48L2E+CiAgICogCiAgICogLSAqKmBjb250cm9sbGVyQXNgKiog4oCTIHtzdHJpbmc9fSDigJMgQSBjb250cm9sbGVyIGFsaWFzIG5hbWUuIElmIHByZXNlbnQgdGhlIGNvbnRyb2xsZXIgd2lsbCBiZSAKICAgKiAgIHB1Ymxpc2hlZCB0byBzY29wZSB1bmRlciB0aGUgY29udHJvbGxlckFzIG5hbWUuCiAgICoKICAgKiA8YSBpZD0ncmVzb2x2ZSc+PC9hPgogICAqCiAgICogLSAqKmByZXNvbHZlYCoqIC0ge29iamVjdC4mbHQ7c3RyaW5nLCBmdW5jdGlvbiZndDs9fSAtIEFuIG9wdGlvbmFsIG1hcCBvZiBkZXBlbmRlbmNpZXMgd2hpY2ggCiAgICogICBzaG91bGQgYmUgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4gSWYgYW55IG9mIHRoZXNlIGRlcGVuZGVuY2llcyBhcmUgcHJvbWlzZXMsIAogICAqICAgdGhlIHJvdXRlciB3aWxsIHdhaXQgZm9yIHRoZW0gYWxsIHRvIGJlIHJlc29sdmVkIG9yIG9uZSB0byBiZSByZWplY3RlZCBiZWZvcmUgdGhlIAogICAqICAgY29udHJvbGxlciBpcyBpbnN0YW50aWF0ZWQuIElmIGFsbCB0aGUgcHJvbWlzZXMgYXJlIHJlc29sdmVkIHN1Y2Nlc3NmdWxseSwgdGhlIHZhbHVlcyAKICAgKiAgIG9mIHRoZSByZXNvbHZlZCBwcm9taXNlcyBhcmUgaW5qZWN0ZWQgYW5kICRzdGF0ZUNoYW5nZVN1Y2Nlc3MgZXZlbnQgaXMgZmlyZWQuIElmIGFueSAKICAgKiAgIG9mIHRoZSBwcm9taXNlcyBhcmUgcmVqZWN0ZWQgdGhlICRzdGF0ZUNoYW5nZUVycm9yIGV2ZW50IGlzIGZpcmVkLiBUaGUgbWFwIG9iamVjdCBpczoKICAgKiAgIAogICAqICAgLSBrZXkgLSB7c3RyaW5nfTogbmFtZSBvZiBkZXBlbmRlbmN5IHRvIGJlIGluamVjdGVkIGludG8gY29udHJvbGxlcgogICAqICAgLSBmYWN0b3J5IC0ge3N0cmluZ3xmdW5jdGlvbn06IElmIHN0cmluZyB0aGVuIGl0IGlzIGFsaWFzIGZvciBzZXJ2aWNlLiBPdGhlcndpc2UgaWYgZnVuY3Rpb24sIAogICAqICAgICBpdCBpcyBpbmplY3RlZCBhbmQgcmV0dXJuIHZhbHVlIGl0IHRyZWF0ZWQgYXMgZGVwZW5kZW5jeS4gSWYgcmVzdWx0IGlzIGEgcHJvbWlzZSwgaXQgaXMgCiAgICogICAgIHJlc29sdmVkIGJlZm9yZSBpdHMgdmFsdWUgaXMgaW5qZWN0ZWQgaW50byBjb250cm9sbGVyLgogICAqCiAgICogPGEgaWQ9J3VybCc+PC9hPgogICAqCiAgICogLSAqKmB1cmxgKiogLSB7c3RyaW5nPX0gLSBBIHVybCB3aXRoIG9wdGlvbmFsIHBhcmFtZXRlcnMuIFdoZW4gYSBzdGF0ZSBpcyBuYXZpZ2F0ZWQgb3IKICAgKiAgIHRyYW5zaXRpb25lZCB0bywgdGhlIGAkc3RhdGVQYXJhbXNgIHNlcnZpY2Ugd2lsbCBiZSBwb3B1bGF0ZWQgd2l0aCBhbnkgCiAgICogICBwYXJhbWV0ZXJzIHRoYXQgd2VyZSBwYXNzZWQuCiAgICoKICAgKiA8YSBpZD0ncGFyYW1zJz48L2E+CiAgICoKICAgKiAtICoqYHBhcmFtc2AqKiAtIHtvYmplY3Q9fSAtIEFuIGFycmF5IG9mIHBhcmFtZXRlciBuYW1lcyBvciByZWd1bGFyIGV4cHJlc3Npb25zLiBPbmx5IAogICAqICAgdXNlIHRoaXMgd2l0aGluIGEgc3RhdGUgaWYgeW91IGFyZSBub3QgdXNpbmcgdXJsLiBPdGhlcndpc2UgeW91IGNhbiBzcGVjaWZ5IHlvdXIKICAgKiAgIHBhcmFtZXRlcnMgd2l0aGluIHRoZSB1cmwuIFdoZW4gYSBzdGF0ZSBpcyBuYXZpZ2F0ZWQgb3IgdHJhbnNpdGlvbmVkIHRvLCB0aGUgCiAgICogICAkc3RhdGVQYXJhbXMgc2VydmljZSB3aWxsIGJlIHBvcHVsYXRlZCB3aXRoIGFueSBwYXJhbWV0ZXJzIHRoYXQgd2VyZSBwYXNzZWQuCiAgICoKICAgKiA8YSBpZD0ndmlld3MnPjwvYT4KICAgKgogICAqIC0gKipgdmlld3NgKiogLSB7b2JqZWN0PX0gLSBVc2UgdGhlIHZpZXdzIHByb3BlcnR5IHRvIHNldCB1cCBtdWx0aXBsZSB2aWV3cyBvciB0byB0YXJnZXQgdmlld3MKICAgKiAgIG1hbnVhbGx5L2V4cGxpY2l0bHkuCiAgICoKICAgKiA8YSBpZD0nYWJzdHJhY3QnPjwvYT4KICAgKgogICAqIC0gKipgYWJzdHJhY3RgKiogLSB7Ym9vbGVhbj19IC0gQW4gYWJzdHJhY3Qgc3RhdGUgd2lsbCBuZXZlciBiZSBkaXJlY3RseSBhY3RpdmF0ZWQsIAogICAqICAgYnV0IGNhbiBwcm92aWRlIGluaGVyaXRlZCBwcm9wZXJ0aWVzIHRvIGl0cyBjb21tb24gY2hpbGRyZW4gc3RhdGVzLgogICAqCiAgICogPGEgaWQ9J29uRW50ZXInPjwvYT4KICAgKgogICAqIC0gKipgb25FbnRlcmAqKiAtIHtvYmplY3Q9fSAtIENhbGxiYWNrIGZ1bmN0aW9uIGZvciB3aGVuIGEgc3RhdGUgaXMgZW50ZXJlZC4gR29vZCB3YXkKICAgKiAgIHRvIHRyaWdnZXIgYW4gYWN0aW9uIG9yIGRpc3BhdGNoIGFuIGV2ZW50LCBzdWNoIGFzIG9wZW5pbmcgYSBkaWFsb2cuCiAgICoKICAgKiA8YSBpZD0nb25FeGl0Jz48L2E+CiAgICoKICAgKiAtICoqYG9uRXhpdGAqKiAtIHtvYmplY3Q9fSAtIENhbGxiYWNrIGZ1bmN0aW9uIGZvciB3aGVuIGEgc3RhdGUgaXMgZXhpdGVkLiBHb29kIHdheSB0bwogICAqICAgdHJpZ2dlciBhbiBhY3Rpb24gb3IgZGlzcGF0Y2ggYW4gZXZlbnQsIHN1Y2ggYXMgb3BlbmluZyBhIGRpYWxvZy4KICAgKgogICAqIDxhIGlkPSdyZWxvYWRPblNlYXJjaCc+PC9hPgogICAqCiAgICogLSAqKmByZWxvYWRPblNlYXJjaCA9IHRydWVgKiogLSB7Ym9vbGVhbj19IC0gSWYgYGZhbHNlYCwgd2lsbCBub3QgcmV0cmlnZ2VyIHRoZSBzYW1lIHN0YXRlIAogICAqICAganVzdCBiZWNhdXNlIGEgc2VhcmNoL3F1ZXJ5IHBhcmFtZXRlciBoYXMgY2hhbmdlZCAodmlhICRsb2NhdGlvbi5zZWFyY2goKSBvciAkbG9jYXRpb24uaGFzaCgpKS4gCiAgICogICBVc2VmdWwgZm9yIHdoZW4geW91J2QgbGlrZSB0byBtb2RpZnkgJGxvY2F0aW9uLnNlYXJjaCgpIHdpdGhvdXQgdHJpZ2dlcmluZyBhIHJlbG9hZC4KICAgKgogICAqIDxhIGlkPSdkYXRhJz48L2E+CiAgICoKICAgKiAtICoqYGRhdGFgKiogLSB7b2JqZWN0PX0gLSBBcmJpdHJhcnkgZGF0YSBvYmplY3QsIHVzZWZ1bCBmb3IgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICoKICAgKiBAZXhhbXBsZQogICAqIDxwcmU+CiAgICogLy8gU29tZSBzdGF0ZSBuYW1lIGV4YW1wbGVzCiAgICoKICAgKiAvLyBzdGF0ZU5hbWUgY2FuIGJlIGEgc2luZ2xlIHRvcC1sZXZlbCBuYW1lIChtdXN0IGJlIHVuaXF1ZSkuCiAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUiLCB7fSk7CiAgICoKICAgKiAvLyBPciBpdCBjYW4gYmUgYSBuZXN0ZWQgc3RhdGUgbmFtZS4gVGhpcyBzdGF0ZSBpcyBhIGNoaWxkIG9mIHRoZSAKICAgKiAvLyBhYm92ZSAiaG9tZSIgc3RhdGUuCiAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUubmV3ZXN0Iiwge30pOwogICAqCiAgICogLy8gTmVzdCBzdGF0ZXMgYXMgZGVlcGx5IGFzIG5lZWRlZC4KICAgKiAkc3RhdGVQcm92aWRlci5zdGF0ZSgiaG9tZS5uZXdlc3QuYWJjLnh5ei5pbmNlcHRpb24iLCB7fSk7CiAgICoKICAgKiAvLyBzdGF0ZSgpIHJldHVybnMgJHN0YXRlUHJvdmlkZXIsIHNvIHlvdSBjYW4gY2hhaW4gc3RhdGUgZGVjbGFyYXRpb25zLgogICAqICRzdGF0ZVByb3ZpZGVyCiAgICogICAuc3RhdGUoImhvbWUiLCB7fSkKICAgKiAgIC5zdGF0ZSgiYWJvdXQiLCB7fSkKICAgKiAgIC5zdGF0ZSgiY29udGFjdHMiLCB7fSk7CiAgICogPC9wcmU+CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBBIHVuaXF1ZSBzdGF0ZSBuYW1lLCBlLmcuICJob21lIiwgImFib3V0IiwgImNvbnRhY3RzIi4gCiAgICogVG8gY3JlYXRlIGEgcGFyZW50L2NoaWxkIHN0YXRlIHVzZSBhIGRvdCwgZS5nLiAiYWJvdXQuc2FsZXMiLCAiaG9tZS5uZXdlc3QiLgogICAqIEBwYXJhbSB7b2JqZWN0fSBkZWZpbml0aW9uIFN0YXRlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LgogICAqLwogIHRoaXMuc3RhdGUgPSBzdGF0ZTsKICBmdW5jdGlvbiBzdGF0ZShuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAvKmpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgIGlmIChpc09iamVjdChuYW1lKSkgZGVmaW5pdGlvbiA9IG5hbWU7CiAgICBlbHNlIGRlZmluaXRpb24ubmFtZSA9IG5hbWU7CiAgICByZWdpc3RlclN0YXRlKGRlZmluaXRpb24pOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgb2JqZWN0CiAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAqCiAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgKiBAcmVxdWlyZXMgJHEKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiR2aWV3CiAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIudXRpbC4kcmVzb2x2ZQogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUGFyYW1zCiAgICoKICAgKiBAcHJvcGVydHkge29iamVjdH0gcGFyYW1zIEEgcGFyYW0gb2JqZWN0LCBlLmcuIHtzZWN0aW9uSWQ6IHNlY3Rpb24uaWQpfSwgdGhhdCAKICAgKiB5b3UnZCBsaWtlIHRvIHRlc3QgYWdhaW5zdCB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUuCiAgICogQHByb3BlcnR5IHtvYmplY3R9IGN1cnJlbnQgQSByZWZlcmVuY2UgdG8gdGhlIHN0YXRlJ3MgY29uZmlnIG9iamVjdC4gSG93ZXZlciAKICAgKiB5b3UgcGFzc2VkIGl0IGluLiBVc2VmdWwgZm9yIGFjY2Vzc2luZyBjdXN0b20gZGF0YS4KICAgKiBAcHJvcGVydHkge29iamVjdH0gdHJhbnNpdGlvbiBDdXJyZW50bHkgcGVuZGluZyB0cmFuc2l0aW9uLiBBIHByb21pc2UgdGhhdCdsbCAKICAgKiByZXNvbHZlIG9yIHJlamVjdC4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIGAkc3RhdGVgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIHJlcHJlc2VudGluZyBzdGF0ZXMgYXMgd2VsbCBhcyB0cmFuc2l0aW9uaW5nCiAgICogYmV0d2VlbiB0aGVtLiBJdCBhbHNvIHByb3ZpZGVzIGludGVyZmFjZXMgdG8gYXNrIGZvciBjdXJyZW50IHN0YXRlIG9yIGV2ZW4gc3RhdGVzCiAgICogeW91J3JlIGNvbWluZyBmcm9tLgogICAqLwogIC8vICR1cmxSb3V0ZXIgaXMgaW5qZWN0ZWQganVzdCB0byBlbnN1cmUgaXQgZ2V0cyBpbnN0YW50aWF0ZWQKICB0aGlzLiRnZXQgPSAkZ2V0OwogICRnZXQuJGluamVjdCA9IFsnJHJvb3RTY29wZScsICckcScsICckdmlldycsICckaW5qZWN0b3InLCAnJHJlc29sdmUnLCAnJHN0YXRlUGFyYW1zJywgJyRsb2NhdGlvbicsICckdXJsUm91dGVyJywgJyRicm93c2VyJ107CiAgZnVuY3Rpb24gJGdldCggICAkcm9vdFNjb3BlLCAgICRxLCAgICR2aWV3LCAgICRpbmplY3RvciwgICAkcmVzb2x2ZSwgICAkc3RhdGVQYXJhbXMsICAgJGxvY2F0aW9uLCAgICR1cmxSb3V0ZXIsICAgJGJyb3dzZXIpIHsKCiAgICB2YXIgVHJhbnNpdGlvblN1cGVyc2VkZWQgPSAkcS5yZWplY3QobmV3IEVycm9yKCd0cmFuc2l0aW9uIHN1cGVyc2VkZWQnKSk7CiAgICB2YXIgVHJhbnNpdGlvblByZXZlbnRlZCA9ICRxLnJlamVjdChuZXcgRXJyb3IoJ3RyYW5zaXRpb24gcHJldmVudGVkJykpOwogICAgdmFyIFRyYW5zaXRpb25BYm9ydGVkID0gJHEucmVqZWN0KG5ldyBFcnJvcigndHJhbnNpdGlvbiBhYm9ydGVkJykpOwogICAgdmFyIFRyYW5zaXRpb25GYWlsZWQgPSAkcS5yZWplY3QobmV3IEVycm9yKCd0cmFuc2l0aW9uIGZhaWxlZCcpKTsKICAgIHZhciBjdXJyZW50TG9jYXRpb24gPSAkbG9jYXRpb24udXJsKCk7CiAgICB2YXIgYmFzZUhyZWYgPSAkYnJvd3Nlci5iYXNlSHJlZigpOwoKICAgIGZ1bmN0aW9uIHN5bmNVcmwoKSB7CiAgICAgIGlmICgkbG9jYXRpb24udXJsKCkgIT09IGN1cnJlbnRMb2NhdGlvbikgewogICAgICAgICRsb2NhdGlvbi51cmwoY3VycmVudExvY2F0aW9uKTsKICAgICAgICAkbG9jYXRpb24ucmVwbGFjZSgpOwogICAgICB9CiAgICB9CgogICAgcm9vdC5sb2NhbHMgPSB7IHJlc29sdmU6IG51bGwsIGdsb2JhbHM6IHsgJHN0YXRlUGFyYW1zOiB7fSB9IH07CiAgICAkc3RhdGUgPSB7CiAgICAgIHBhcmFtczoge30sCiAgICAgIGN1cnJlbnQ6IHJvb3Quc2VsZiwKICAgICAgJGN1cnJlbnQ6IHJvb3QsCiAgICAgIHRyYW5zaXRpb246IG51bGwKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjcmVsb2FkCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSBtZXRob2QgdGhhdCBmb3JjZSByZWxvYWRzIHRoZSBjdXJyZW50IHN0YXRlLiBBbGwgcmVzb2x2ZXMgYXJlIHJlLXJlc29sdmVkLCBldmVudHMgYXJlIG5vdCByZS1maXJlZCwgCiAgICAgKiBhbmQgY29udHJvbGxlcnMgcmVpbnN0YW50aWF0ZWQgKGJ1ZyB3aXRoIGNvbnRyb2xsZXJzIHJlaW5zdGFudGlhdGluZyByaWdodCBub3csIGZpeGluZyBzb29uKS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqIHZhciBhcHAgYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyJ10pOwogICAgICoKICAgICAqIGFwcC5jb250cm9sbGVyKCdjdHJsJywgZnVuY3Rpb24gKCRzY29wZSwgJHN0YXRlKSB7CiAgICAgKiAgICRzY29wZS5yZWxvYWQgPSBmdW5jdGlvbigpewogICAgICogICAgICRzdGF0ZS5yZWxvYWQoKTsKICAgICAqICAgfQogICAgICogfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBgcmVsb2FkKClgIGlzIGp1c3QgYW4gYWxpYXMgZm9yOgogICAgICogPHByZT4KICAgICAqICRzdGF0ZS50cmFuc2l0aW9uVG8oJHN0YXRlLmN1cnJlbnQsICRzdGF0ZVBhcmFtcywgeyAKICAgICAqICAgcmVsb2FkOiB0cnVlLCBpbmhlcml0OiBmYWxzZSwgbm90aWZ5OiBmYWxzZSAKICAgICAqIH0pOwogICAgICogPC9wcmU+CiAgICAgKi8KICAgICRzdGF0ZS5yZWxvYWQgPSBmdW5jdGlvbiByZWxvYWQoKSB7CiAgICAgICRzdGF0ZS50cmFuc2l0aW9uVG8oJHN0YXRlLmN1cnJlbnQsICRzdGF0ZVBhcmFtcywgeyByZWxvYWQ6IHRydWUsIGluaGVyaXQ6IGZhbHNlLCBub3RpZnk6IGZhbHNlIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNnbwogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgdHJhbnNpdGlvbmluZyB0byBhIG5ldyBzdGF0ZS4gYCRzdGF0ZS5nb2AgY2FsbHMgCiAgICAgKiBgJHN0YXRlLnRyYW5zaXRpb25Ub2AgaW50ZXJuYWxseSBidXQgYXV0b21hdGljYWxseSBzZXRzIG9wdGlvbnMgdG8gCiAgICAgKiBgeyBsb2NhdGlvbjogdHJ1ZSwgaW5oZXJpdDogdHJ1ZSwgcmVsYXRpdmU6ICRzdGF0ZS4kY3VycmVudCwgbm90aWZ5OiB0cnVlIH1gLiAKICAgICAqIFRoaXMgYWxsb3dzIHlvdSB0byBlYXNpbHkgdXNlIGFuIGFic29sdXRlIG9yIHJlbGF0aXZlIHRvIHBhdGggYW5kIHNwZWNpZnkgCiAgICAgKiBvbmx5IHRoZSBwYXJhbWV0ZXJzIHlvdSdkIGxpa2UgdG8gdXBkYXRlICh3aGlsZSBsZXR0aW5nIHVuc3BlY2lmaWVkIHBhcmFtZXRlcnMgCiAgICAgKiBpbmhlcml0IGZyb20gdGhlIGN1cnJlbnRseSBhY3RpdmUgYW5jZXN0b3Igc3RhdGVzKS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXInXSk7CiAgICAgKgogICAgICogYXBwLmNvbnRyb2xsZXIoJ2N0cmwnLCBmdW5jdGlvbiAoJHNjb3BlLCAkc3RhdGUpIHsKICAgICAqICAgJHNjb3BlLmNoYW5nZVN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgICogICAgICRzdGF0ZS5nbygnY29udGFjdC5kZXRhaWwnKTsKICAgICAqICAgfTsKICAgICAqIH0pOwogICAgICogPC9wcmU+CiAgICAgKiA8aW1nIHNyYz0nLi4vbmdkb2NfYXNzZXRzL1N0YXRlR29FeGFtcGxlcy5wbmcnLz4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdG8gQWJzb2x1dGUgc3RhdGUgbmFtZSBvciByZWxhdGl2ZSBzdGF0ZSBwYXRoLiBTb21lIGV4YW1wbGVzOgogICAgICoKICAgICAqIC0gYCRzdGF0ZS5nbygnY29udGFjdC5kZXRhaWwnKWAgLSB3aWxsIGdvIHRvIHRoZSBgY29udGFjdC5kZXRhaWxgIHN0YXRlCiAgICAgKiAtIGAkc3RhdGUuZ28oJ14nKWAgLSB3aWxsIGdvIHRvIGEgcGFyZW50IHN0YXRlCiAgICAgKiAtIGAkc3RhdGUuZ28oJ14uc2libGluZycpYCAtIHdpbGwgZ28gdG8gYSBzaWJsaW5nIHN0YXRlCiAgICAgKiAtIGAkc3RhdGUuZ28oJy5jaGlsZC5ncmFuZGNoaWxkJylgIC0gd2lsbCBnbyB0byBncmFuZGNoaWxkIHN0YXRlCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3Q9fSBwYXJhbXMgQSBtYXAgb2YgdGhlIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHNlbnQgdG8gdGhlIHN0YXRlLCAKICAgICAqIHdpbGwgcG9wdWxhdGUgJHN0YXRlUGFyYW1zLiBBbnkgcGFyYW1ldGVycyB0aGF0IGFyZSBub3Qgc3BlY2lmaWVkIHdpbGwgYmUgaW5oZXJpdGVkIGZyb20gY3VycmVudGx5IAogICAgICogZGVmaW5lZCBwYXJhbWV0ZXJzLiBUaGlzIGFsbG93cywgZm9yIGV4YW1wbGUsIGdvaW5nIHRvIGEgc2libGluZyBzdGF0ZSB0aGF0IHNoYXJlcyBwYXJhbWV0ZXJzCiAgICAgKiBzcGVjaWZpZWQgaW4gYSBwYXJlbnQgc3RhdGUuIFBhcmFtZXRlciBpbmhlcml0YW5jZSBvbmx5IHdvcmtzIGJldHdlZW4gY29tbW9uIGFuY2VzdG9yIHN0YXRlcywgSS5lLgogICAgICogdHJhbnNpdGlvbmluZyB0byBhIHNpYmxpbmcgd2lsbCBnZXQgeW91IHRoZSBwYXJhbWV0ZXJzIGZvciBhbGwgcGFyZW50cywgdHJhbnNpdGlvbmluZyB0byBhIGNoaWxkCiAgICAgKiB3aWxsIGdldCB5b3UgYWxsIGN1cnJlbnQgcGFyYW1ldGVycywgZXRjLgogICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0LiBUaGUgb3B0aW9ucyBhcmU6CiAgICAgKgogICAgICogLSAqKmBsb2NhdGlvbmAqKiAtIHtib29sZWFuPXRydWV8c3RyaW5nPX0gLSBJZiBgdHJ1ZWAgd2lsbCB1cGRhdGUgdGhlIHVybCBpbiB0aGUgbG9jYXRpb24gYmFyLCBpZiBgZmFsc2VgCiAgICAgKiAgICB3aWxsIG5vdC4gSWYgc3RyaW5nLCBtdXN0IGJlIGAicmVwbGFjZSJgLCB3aGljaCB3aWxsIHVwZGF0ZSB1cmwgYW5kIGFsc28gcmVwbGFjZSBsYXN0IGhpc3RvcnkgcmVjb3JkLgogICAgICogLSAqKmBpbmhlcml0YCoqIC0ge2Jvb2xlYW49dHJ1ZX0sIElmIGB0cnVlYCB3aWxsIGluaGVyaXQgdXJsIHBhcmFtZXRlcnMgZnJvbSBjdXJyZW50IHVybC4KICAgICAqIC0gKipgcmVsYXRpdmVgKiogLSB7b2JqZWN0PSRzdGF0ZS4kY3VycmVudH0sIFdoZW4gdHJhbnNpdGlvbmluZyB3aXRoIHJlbGF0aXZlIHBhdGggKGUuZyAnXicpLCAKICAgICAqICAgIGRlZmluZXMgd2hpY2ggc3RhdGUgdG8gYmUgcmVsYXRpdmUgZnJvbS4KICAgICAqIC0gKipgbm90aWZ5YCoqIC0ge2Jvb2xlYW49dHJ1ZX0sIElmIGB0cnVlYCB3aWxsIGJyb2FkY2FzdCAkc3RhdGVDaGFuZ2VTdGFydCBhbmQgJHN0YXRlQ2hhbmdlU3VjY2VzcyBldmVudHMuCiAgICAgKiAtICoqYHJlbG9hZGAqKiAodjAuMi41KSAtIHtib29sZWFuPWZhbHNlfSwgSWYgYHRydWVgIHdpbGwgZm9yY2UgdHJhbnNpdGlvbiBldmVuIGlmIHRoZSBzdGF0ZSBvciBwYXJhbXMgCiAgICAgKiAgICBoYXZlIG5vdCBjaGFuZ2VkLCBha2EgYSByZWxvYWQgb2YgdGhlIHNhbWUgc3RhdGUuIEl0IGRpZmZlcnMgZnJvbSByZWxvYWRPblNlYXJjaCBiZWNhdXNlIHlvdSdkCiAgICAgKiAgICB1c2UgdGhpcyB3aGVuIHlvdSB3YW50IHRvIGZvcmNlIGEgcmVsb2FkIHdoZW4gKmV2ZXJ5dGhpbmcqIGlzIHRoZSBzYW1lLCBpbmNsdWRpbmcgc2VhcmNoIHBhcmFtcy4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHJlcHJlc2VudGluZyB0aGUgc3RhdGUgb2YgdGhlIG5ldyB0cmFuc2l0aW9uLgogICAgICoKICAgICAqIFBvc3NpYmxlIHN1Y2Nlc3MgdmFsdWVzOgogICAgICoKICAgICAqIC0gJHN0YXRlLmN1cnJlbnQKICAgICAqCiAgICAgKiA8YnIvPlBvc3NpYmxlIHJlamVjdGlvbiB2YWx1ZXM6CiAgICAgKgogICAgICogLSAndHJhbnNpdGlvbiBzdXBlcnNlZGVkJyAtIHdoZW4gYSBuZXdlciB0cmFuc2l0aW9uIGhhcyBiZWVuIHN0YXJ0ZWQgYWZ0ZXIgdGhpcyBvbmUKICAgICAqIC0gJ3RyYW5zaXRpb24gcHJldmVudGVkJyAtIHdoZW4gYGV2ZW50LnByZXZlbnREZWZhdWx0KClgIGhhcyBiZWVuIGNhbGxlZCBpbiBhIGAkc3RhdGVDaGFuZ2VTdGFydGAgbGlzdGVuZXIKICAgICAqIC0gJ3RyYW5zaXRpb24gYWJvcnRlZCcgLSB3aGVuIGBldmVudC5wcmV2ZW50RGVmYXVsdCgpYCBoYXMgYmVlbiBjYWxsZWQgaW4gYSBgJHN0YXRlTm90Rm91bmRgIGxpc3RlbmVyIG9yCiAgICAgKiAgIHdoZW4gYSBgJHN0YXRlTm90Rm91bmRgIGBldmVudC5yZXRyeWAgcHJvbWlzZSBlcnJvcnMuCiAgICAgKiAtICd0cmFuc2l0aW9uIGZhaWxlZCcgLSB3aGVuIGEgc3RhdGUgaGFzIGJlZW4gdW5zdWNjZXNzZnVsbHkgZm91bmQgYWZ0ZXIgMiB0cmllcy4KICAgICAqIC0gKnJlc29sdmUgZXJyb3IqIC0gd2hlbiBhbiBlcnJvciBoYXMgb2NjdXJyZWQgd2l0aCBhIGByZXNvbHZlYAogICAgICoKICAgICAqLwogICAgJHN0YXRlLmdvID0gZnVuY3Rpb24gZ28odG8sIHBhcmFtcywgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy50cmFuc2l0aW9uVG8odG8sIHBhcmFtcywgZXh0ZW5kKHsgaW5oZXJpdDogdHJ1ZSwgcmVsYXRpdmU6ICRzdGF0ZS4kY3VycmVudCB9LCBvcHRpb25zKSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI3RyYW5zaXRpb25UbwogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIExvdy1sZXZlbCBtZXRob2QgZm9yIHRyYW5zaXRpb25pbmcgdG8gYSBuZXcgc3RhdGUuIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI21ldGhvZHNfZ28gJHN0YXRlLmdvfQogICAgICogdXNlcyBgdHJhbnNpdGlvblRvYCBpbnRlcm5hbGx5LiBgJHN0YXRlLmdvYCBpcyByZWNvbW1lbmRlZCBpbiBtb3N0IHNpdHVhdGlvbnMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyJ10pOwogICAgICoKICAgICAqIGFwcC5jb250cm9sbGVyKCdjdHJsJywgZnVuY3Rpb24gKCRzY29wZSwgJHN0YXRlKSB7CiAgICAgKiAgICRzY29wZS5jaGFuZ2VTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAqICAgICAkc3RhdGUudHJhbnNpdGlvblRvKCdjb250YWN0LmRldGFpbCcpOwogICAgICogICB9OwogICAgICogfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdG8gU3RhdGUgbmFtZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gdG9QYXJhbXMgQSBtYXAgb2YgdGhlIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHNlbnQgdG8gdGhlIHN0YXRlLAogICAgICogd2lsbCBwb3B1bGF0ZSAkc3RhdGVQYXJhbXMuCiAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgT3B0aW9ucyBvYmplY3QuIFRoZSBvcHRpb25zIGFyZToKICAgICAqCiAgICAgKiAtICoqYGxvY2F0aW9uYCoqIC0ge2Jvb2xlYW49dHJ1ZXxzdHJpbmc9fSAtIElmIGB0cnVlYCB3aWxsIHVwZGF0ZSB0aGUgdXJsIGluIHRoZSBsb2NhdGlvbiBiYXIsIGlmIGBmYWxzZWAKICAgICAqICAgIHdpbGwgbm90LiBJZiBzdHJpbmcsIG11c3QgYmUgYCJyZXBsYWNlImAsIHdoaWNoIHdpbGwgdXBkYXRlIHVybCBhbmQgYWxzbyByZXBsYWNlIGxhc3QgaGlzdG9yeSByZWNvcmQuCiAgICAgKiAtICoqYGluaGVyaXRgKiogLSB7Ym9vbGVhbj1mYWxzZX0sIElmIGB0cnVlYCB3aWxsIGluaGVyaXQgdXJsIHBhcmFtZXRlcnMgZnJvbSBjdXJyZW50IHVybC4KICAgICAqIC0gKipgcmVsYXRpdmVgKiogLSB7b2JqZWN0PX0sIFdoZW4gdHJhbnNpdGlvbmluZyB3aXRoIHJlbGF0aXZlIHBhdGggKGUuZyAnXicpLCAKICAgICAqICAgIGRlZmluZXMgd2hpY2ggc3RhdGUgdG8gYmUgcmVsYXRpdmUgZnJvbS4KICAgICAqIC0gKipgbm90aWZ5YCoqIC0ge2Jvb2xlYW49dHJ1ZX0sIElmIGB0cnVlYCB3aWxsIGJyb2FkY2FzdCAkc3RhdGVDaGFuZ2VTdGFydCBhbmQgJHN0YXRlQ2hhbmdlU3VjY2VzcyBldmVudHMuCiAgICAgKiAtICoqYHJlbG9hZGAqKiAodjAuMi41KSAtIHtib29sZWFuPWZhbHNlfSwgSWYgYHRydWVgIHdpbGwgZm9yY2UgdHJhbnNpdGlvbiBldmVuIGlmIHRoZSBzdGF0ZSBvciBwYXJhbXMgCiAgICAgKiAgICBoYXZlIG5vdCBjaGFuZ2VkLCBha2EgYSByZWxvYWQgb2YgdGhlIHNhbWUgc3RhdGUuIEl0IGRpZmZlcnMgZnJvbSByZWxvYWRPblNlYXJjaCBiZWNhdXNlIHlvdSdkCiAgICAgKiAgICB1c2UgdGhpcyB3aGVuIHlvdSB3YW50IHRvIGZvcmNlIGEgcmVsb2FkIHdoZW4gKmV2ZXJ5dGhpbmcqIGlzIHRoZSBzYW1lLCBpbmNsdWRpbmcgc2VhcmNoIHBhcmFtcy4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHJlcHJlc2VudGluZyB0aGUgc3RhdGUgb2YgdGhlIG5ldyB0cmFuc2l0aW9uLiBTZWUKICAgICAqIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI21ldGhvZHNfZ28gJHN0YXRlLmdvfS4KICAgICAqLwogICAgJHN0YXRlLnRyYW5zaXRpb25UbyA9IGZ1bmN0aW9uIHRyYW5zaXRpb25Ubyh0bywgdG9QYXJhbXMsIG9wdGlvbnMpIHsKICAgICAgdG9QYXJhbXMgPSB0b1BhcmFtcyB8fCB7fTsKICAgICAgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgbG9jYXRpb246IHRydWUsIGluaGVyaXQ6IGZhbHNlLCByZWxhdGl2ZTogbnVsbCwgbm90aWZ5OiB0cnVlLCByZWxvYWQ6IGZhbHNlLCAkcmV0cnk6IGZhbHNlCiAgICAgIH0sIG9wdGlvbnMgfHwge30pOwoKICAgICAgdmFyIGZyb20gPSAkc3RhdGUuJGN1cnJlbnQsIGZyb21QYXJhbXMgPSAkc3RhdGUucGFyYW1zLCBmcm9tUGF0aCA9IGZyb20ucGF0aDsKICAgICAgdmFyIGV2dCwgdG9TdGF0ZSA9IGZpbmRTdGF0ZSh0bywgb3B0aW9ucy5yZWxhdGl2ZSk7CgogICAgICBpZiAoIWlzRGVmaW5lZCh0b1N0YXRlKSkgewogICAgICAgIC8vIEJyb2FkY2FzdCBub3QgZm91bmQgZXZlbnQgYW5kIGFib3J0IHRoZSB0cmFuc2l0aW9uIGlmIHByZXZlbnRlZAogICAgICAgIHZhciByZWRpcmVjdCA9IHsgdG86IHRvLCB0b1BhcmFtczogdG9QYXJhbXMsIG9wdGlvbnM6IG9wdGlvbnMgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSMkc3RhdGVOb3RGb3VuZAogICAgICAgICAqIEBldmVudE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogRmlyZWQgd2hlbiBhIHJlcXVlc3RlZCBzdGF0ZSAqKmNhbm5vdCBiZSBmb3VuZCoqIHVzaW5nIHRoZSBwcm92aWRlZCBzdGF0ZSBuYW1lIGR1cmluZyB0cmFuc2l0aW9uLgogICAgICAgICAqIFRoZSBldmVudCBpcyBicm9hZGNhc3QgYWxsb3dpbmcgYW55IGhhbmRsZXJzIGEgc2luZ2xlIGNoYW5jZSB0byBkZWFsIHdpdGggdGhlIGVycm9yICh1c3VhbGx5IGJ5CiAgICAgICAgICogbGF6eS1sb2FkaW5nIHRoZSB1bmZvdW5kIHN0YXRlKS4gQSBzcGVjaWFsIGB1bmZvdW5kU3RhdGVgIG9iamVjdCBpcyBwYXNzZWQgdG8gdGhlIGxpc3RlbmVyIGhhbmRsZXIsCiAgICAgICAgICogeW91IGNhbiBzZWUgaXRzIHRocmVlIHByb3BlcnRpZXMgaW4gdGhlIGV4YW1wbGUuIFlvdSBjYW4gdXNlIGBldmVudC5wcmV2ZW50RGVmYXVsdCgpYCB0byBhYm9ydCB0aGUKICAgICAgICAgKiB0cmFuc2l0aW9uIGFuZCB0aGUgcHJvbWlzZSByZXR1cm5lZCBmcm9tIGBnb2Agd2lsbCBiZSByZWplY3RlZCB3aXRoIGEgYCd0cmFuc2l0aW9uIGFib3J0ZWQnYCB2YWx1ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBFdmVudCBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHVuZm91bmRTdGF0ZSBVbmZvdW5kIFN0YXRlIGluZm9ybWF0aW9uLiBDb250YWluczogYHRvLCB0b1BhcmFtcywgb3B0aW9uc2AgcHJvcGVydGllcy4KICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSBmcm9tU3RhdGUgQ3VycmVudCBzdGF0ZSBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGZyb21QYXJhbXMgQ3VycmVudCBzdGF0ZSBwYXJhbXMuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAqCiAgICAgICAgICogPHByZT4KICAgICAgICAgKiAvLyBzb21ld2hlcmUsIGFzc3VtZSBsYXp5LnN0YXRlIGhhcyBub3QgYmVlbiBkZWZpbmVkCiAgICAgICAgICogJHN0YXRlLmdvKCJsYXp5LnN0YXRlIiwge2E6MSwgYjoyfSwge2luaGVyaXQ6ZmFsc2V9KTsKICAgICAgICAgKgogICAgICAgICAqIC8vIHNvbWV3aGVyZSBlbHNlCiAgICAgICAgICogJHNjb3BlLiRvbignJHN0YXRlTm90Rm91bmQnLAogICAgICAgICAqIGZ1bmN0aW9uKGV2ZW50LCB1bmZvdW5kU3RhdGUsIGZyb21TdGF0ZSwgZnJvbVBhcmFtcyl7CiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKHVuZm91bmRTdGF0ZS50byk7IC8vICJsYXp5LnN0YXRlIgogICAgICAgICAqICAgICBjb25zb2xlLmxvZyh1bmZvdW5kU3RhdGUudG9QYXJhbXMpOyAvLyB7YToxLCBiOjJ9CiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKHVuZm91bmRTdGF0ZS5vcHRpb25zKTsgLy8ge2luaGVyaXQ6ZmFsc2V9ICsgZGVmYXVsdCBvcHRpb25zCiAgICAgICAgICogfSkKICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgKi8KICAgICAgICBldnQgPSAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRzdGF0ZU5vdEZvdW5kJywgcmVkaXJlY3QsIGZyb20uc2VsZiwgZnJvbVBhcmFtcyk7CiAgICAgICAgaWYgKGV2dC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICBzeW5jVXJsKCk7CiAgICAgICAgICByZXR1cm4gVHJhbnNpdGlvbkFib3J0ZWQ7CiAgICAgICAgfQoKICAgICAgICAvLyBBbGxvdyB0aGUgaGFuZGxlciB0byByZXR1cm4gYSBwcm9taXNlIHRvIGRlZmVyIHN0YXRlIGxvb2t1cCByZXRyeQogICAgICAgIGlmIChldnQucmV0cnkpIHsKICAgICAgICAgIGlmIChvcHRpb25zLiRyZXRyeSkgewogICAgICAgICAgICBzeW5jVXJsKCk7CiAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uRmFpbGVkOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJldHJ5VHJhbnNpdGlvbiA9ICRzdGF0ZS50cmFuc2l0aW9uID0gJHEud2hlbihldnQucmV0cnkpOwogICAgICAgICAgcmV0cnlUcmFuc2l0aW9uLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChyZXRyeVRyYW5zaXRpb24gIT09ICRzdGF0ZS50cmFuc2l0aW9uKSByZXR1cm4gVHJhbnNpdGlvblN1cGVyc2VkZWQ7CiAgICAgICAgICAgIHJlZGlyZWN0Lm9wdGlvbnMuJHJldHJ5ID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuICRzdGF0ZS50cmFuc2l0aW9uVG8ocmVkaXJlY3QudG8sIHJlZGlyZWN0LnRvUGFyYW1zLCByZWRpcmVjdC5vcHRpb25zKTsKICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gVHJhbnNpdGlvbkFib3J0ZWQ7CiAgICAgICAgICB9KTsKICAgICAgICAgIHN5bmNVcmwoKTsKICAgICAgICAgIHJldHVybiByZXRyeVRyYW5zaXRpb247CiAgICAgICAgfQoKICAgICAgICAvLyBBbHdheXMgcmV0cnkgb25jZSBpZiB0aGUgJHN0YXRlTm90Rm91bmQgd2FzIG5vdCBwcmV2ZW50ZWQKICAgICAgICAvLyAoaGFuZGxlcyBlaXRoZXIgcmVkaXJlY3QgY2hhbmdlZCBvciBzdGF0ZSBsYXp5LWRlZmluaXRpb24pCiAgICAgICAgdG8gPSByZWRpcmVjdC50bzsKICAgICAgICB0b1BhcmFtcyA9IHJlZGlyZWN0LnRvUGFyYW1zOwogICAgICAgIG9wdGlvbnMgPSByZWRpcmVjdC5vcHRpb25zOwogICAgICAgIHRvU3RhdGUgPSBmaW5kU3RhdGUodG8sIG9wdGlvbnMucmVsYXRpdmUpOwogICAgICAgIGlmICghaXNEZWZpbmVkKHRvU3RhdGUpKSB7CiAgICAgICAgICBpZiAob3B0aW9ucy5yZWxhdGl2ZSkgdGhyb3cgbmV3IEVycm9yKCJDb3VsZCBub3QgcmVzb2x2ZSAnIiArIHRvICsgIicgZnJvbSBzdGF0ZSAnIiArIG9wdGlvbnMucmVsYXRpdmUgKyAiJyIpOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBzdWNoIHN0YXRlICciICsgdG8gKyAiJyIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodG9TdGF0ZVthYnN0cmFjdEtleV0pIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHRyYW5zaXRpb24gdG8gYWJzdHJhY3Qgc3RhdGUgJyIgKyB0byArICInIik7CiAgICAgIGlmIChvcHRpb25zLmluaGVyaXQpIHRvUGFyYW1zID0gaW5oZXJpdFBhcmFtcygkc3RhdGVQYXJhbXMsIHRvUGFyYW1zIHx8IHt9LCAkc3RhdGUuJGN1cnJlbnQsIHRvU3RhdGUpOwogICAgICB0byA9IHRvU3RhdGU7CgogICAgICB2YXIgdG9QYXRoID0gdG8ucGF0aDsKCiAgICAgIC8vIFN0YXJ0aW5nIGZyb20gdGhlIHJvb3Qgb2YgdGhlIHBhdGgsIGtlZXAgYWxsIGxldmVscyB0aGF0IGhhdmVuJ3QgY2hhbmdlZAogICAgICB2YXIga2VlcCwgc3RhdGUsIGxvY2FscyA9IHJvb3QubG9jYWxzLCB0b0xvY2FscyA9IFtdOwogICAgICBmb3IgKGtlZXAgPSAwLCBzdGF0ZSA9IHRvUGF0aFtrZWVwXTsKICAgICAgICAgICBzdGF0ZSAmJiBzdGF0ZSA9PT0gZnJvbVBhdGhba2VlcF0gJiYgZXF1YWxGb3JLZXlzKHRvUGFyYW1zLCBmcm9tUGFyYW1zLCBzdGF0ZS5vd25QYXJhbXMpICYmICFvcHRpb25zLnJlbG9hZDsKICAgICAgICAgICBrZWVwKyssIHN0YXRlID0gdG9QYXRoW2tlZXBdKSB7CiAgICAgICAgbG9jYWxzID0gdG9Mb2NhbHNba2VlcF0gPSBzdGF0ZS5sb2NhbHM7CiAgICAgIH0KCiAgICAgIC8vIElmIHdlJ3JlIGdvaW5nIHRvIHRoZSBzYW1lIHN0YXRlIGFuZCBhbGwgbG9jYWxzIGFyZSBrZXB0LCB3ZSd2ZSBnb3Qgbm90aGluZyB0byBkby4KICAgICAgLy8gQnV0IGNsZWFyICd0cmFuc2l0aW9uJywgYXMgd2Ugc3RpbGwgd2FudCB0byBjYW5jZWwgYW55IG90aGVyIHBlbmRpbmcgdHJhbnNpdGlvbnMuCiAgICAgIC8vIFRPRE86IFdlIG1heSBub3Qgd2FudCB0byBidW1wICd0cmFuc2l0aW9uJyBpZiB3ZSdyZSBjYWxsZWQgZnJvbSBhIGxvY2F0aW9uIGNoYW5nZSB0aGF0IHdlJ3ZlIGluaXRpYXRlZCBvdXJzZWx2ZXMsCiAgICAgIC8vIGJlY2F1c2Ugd2UgbWlnaHQgYWNjaWRlbnRhbGx5IGFib3J0IGEgbGVnaXRpbWF0ZSB0cmFuc2l0aW9uIGluaXRpYXRlZCBmcm9tIGNvZGU/CiAgICAgIGlmIChzaG91bGRUcmlnZ2VyUmVsb2FkKHRvLCBmcm9tLCBsb2NhbHMsIG9wdGlvbnMpICkgewogICAgICAgIGlmICggdG8uc2VsZi5yZWxvYWRPblNlYXJjaCAhPT0gZmFsc2UgKQogICAgICAgICAgc3luY1VybCgpOwogICAgICAgICRzdGF0ZS50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICByZXR1cm4gJHEud2hlbigkc3RhdGUuY3VycmVudCk7CiAgICAgIH0KCiAgICAgIC8vIE5vcm1hbGl6ZS9maWx0ZXIgcGFyYW1ldGVycyBiZWZvcmUgd2UgcGFzcyB0aGVtIHRvIGV2ZW50IGhhbmRsZXJzIGV0Yy4KICAgICAgdG9QYXJhbXMgPSBub3JtYWxpemUodG8ucGFyYW1zLCB0b1BhcmFtcyB8fCB7fSk7CgogICAgICAvLyBCcm9hZGNhc3Qgc3RhcnQgZXZlbnQgYW5kIGNhbmNlbCB0aGUgdHJhbnNpdGlvbiBpZiByZXF1ZXN0ZWQKICAgICAgaWYgKG9wdGlvbnMubm90aWZ5KSB7CiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSMkc3RhdGVDaGFuZ2VTdGFydAogICAgICAgICAqIEBldmVudE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogRmlyZWQgd2hlbiB0aGUgc3RhdGUgdHJhbnNpdGlvbiAqKmJlZ2lucyoqLiBZb3UgY2FuIHVzZSBgZXZlbnQucHJldmVudERlZmF1bHQoKWAKICAgICAgICAgKiB0byBwcmV2ZW50IHRoZSB0cmFuc2l0aW9uIGZyb20gaGFwcGVuaW5nIGFuZCB0aGVuIHRoZSB0cmFuc2l0aW9uIHByb21pc2Ugd2lsbCBiZQogICAgICAgICAqIHJlamVjdGVkIHdpdGggYSBgJ3RyYW5zaXRpb24gcHJldmVudGVkJ2AgdmFsdWUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IHRvU3RhdGUgVGhlIHN0YXRlIGJlaW5nIHRyYW5zaXRpb25lZCB0by4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdG9QYXJhbXMgVGhlIHBhcmFtcyBzdXBwbGllZCB0byB0aGUgYHRvU3RhdGVgLgogICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IGZyb21TdGF0ZSBUaGUgY3VycmVudCBzdGF0ZSwgcHJlLXRyYW5zaXRpb24uCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGZyb21QYXJhbXMgVGhlIHBhcmFtcyBzdXBwbGllZCB0byB0aGUgYGZyb21TdGF0ZWAuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAqCiAgICAgICAgICogPHByZT4KICAgICAgICAgKiAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3RhcnQnLAogICAgICAgICAqIGZ1bmN0aW9uKGV2ZW50LCB0b1N0YXRlLCB0b1BhcmFtcywgZnJvbVN0YXRlLCBmcm9tUGFyYW1zKXsKICAgICAgICAgKiAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgKiAgICAgLy8gdHJhbnNpdGlvblRvKCkgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIHdpdGgKICAgICAgICAgKiAgICAgLy8gYSAndHJhbnNpdGlvbiBwcmV2ZW50ZWQnIGVycm9yCiAgICAgICAgICogfSkKICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgKi8KICAgICAgICBldnQgPSAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRzdGF0ZUNoYW5nZVN0YXJ0JywgdG8uc2VsZiwgdG9QYXJhbXMsIGZyb20uc2VsZiwgZnJvbVBhcmFtcyk7CiAgICAgICAgaWYgKGV2dC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICBzeW5jVXJsKCk7CiAgICAgICAgICByZXR1cm4gVHJhbnNpdGlvblByZXZlbnRlZDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJlc29sdmUgbG9jYWxzIGZvciB0aGUgcmVtYWluaW5nIHN0YXRlcywgYnV0IGRvbid0IHVwZGF0ZSBhbnkgZ2xvYmFsIHN0YXRlIGp1c3QKICAgICAgLy8geWV0IC0tIGlmIGFueXRoaW5nIGZhaWxzIHRvIHJlc29sdmUgdGhlIGN1cnJlbnQgc3RhdGUgbmVlZHMgdG8gcmVtYWluIHVudG91Y2hlZC4KICAgICAgLy8gV2UgYWxzbyBzZXQgdXAgYW4gaW5oZXJpdGFuY2UgY2hhaW4gZm9yIHRoZSBsb2NhbHMgaGVyZS4gVGhpcyBhbGxvd3MgdGhlIHZpZXcgZGlyZWN0aXZlCiAgICAgIC8vIHRvIHF1aWNrbHkgbG9vayB1cCB0aGUgY29ycmVjdCBkZWZpbml0aW9uIGZvciBlYWNoIHZpZXcgaW4gdGhlIGN1cnJlbnQgc3RhdGUuIEV2ZW4KICAgICAgLy8gdGhvdWdoIHdlIGNyZWF0ZSB0aGUgbG9jYWxzIG9iamVjdCBpdHNlbGYgb3V0c2lkZSByZXNvbHZlU3RhdGUoKSwgaXQgaXMgaW5pdGlhbGx5CiAgICAgIC8vIGVtcHR5IGFuZCBnZXRzIGZpbGxlZCBhc3luY2hyb25vdXNseS4gV2UgbmVlZCB0byBrZWVwIHRyYWNrIG9mIHRoZSBwcm9taXNlIGZvciB0aGUKICAgICAgLy8gKGZ1bGx5IHJlc29sdmVkKSBjdXJyZW50IGxvY2FscywgYW5kIHBhc3MgdGhpcyBkb3duIHRoZSBjaGFpbi4KICAgICAgdmFyIHJlc29sdmVkID0gJHEud2hlbihsb2NhbHMpOwogICAgICBmb3IgKHZhciBsPWtlZXA7IGw8dG9QYXRoLmxlbmd0aDsgbCsrLCBzdGF0ZT10b1BhdGhbbF0pIHsKICAgICAgICBsb2NhbHMgPSB0b0xvY2Fsc1tsXSA9IGluaGVyaXQobG9jYWxzKTsKICAgICAgICByZXNvbHZlZCA9IHJlc29sdmVTdGF0ZShzdGF0ZSwgdG9QYXJhbXMsIHN0YXRlPT09dG8sIHJlc29sdmVkLCBsb2NhbHMpOwogICAgICB9CgogICAgICAvLyBPbmNlIGV2ZXJ5dGhpbmcgaXMgcmVzb2x2ZWQsIHdlIGFyZSByZWFkeSB0byBwZXJmb3JtIHRoZSBhY3R1YWwgdHJhbnNpdGlvbgogICAgICAvLyBhbmQgcmV0dXJuIGEgcHJvbWlzZSBmb3IgdGhlIG5ldyBzdGF0ZS4gV2UgYWxzbyBrZWVwIHRyYWNrIG9mIHdoYXQgdGhlCiAgICAgIC8vIGN1cnJlbnQgcHJvbWlzZSBpcywgc28gdGhhdCB3ZSBjYW4gZGV0ZWN0IG92ZXJsYXBwaW5nIHRyYW5zaXRpb25zIGFuZAogICAgICAvLyBrZWVwIG9ubHkgdGhlIG91dGNvbWUgb2YgdGhlIGxhc3QgdHJhbnNpdGlvbi4KICAgICAgdmFyIHRyYW5zaXRpb24gPSAkc3RhdGUudHJhbnNpdGlvbiA9IHJlc29sdmVkLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBsLCBlbnRlcmluZywgZXhpdGluZzsKCiAgICAgICAgaWYgKCRzdGF0ZS50cmFuc2l0aW9uICE9PSB0cmFuc2l0aW9uKSByZXR1cm4gVHJhbnNpdGlvblN1cGVyc2VkZWQ7CgogICAgICAgIC8vIEV4aXQgJ2Zyb20nIHN0YXRlcyBub3Qga2VwdAogICAgICAgIGZvciAobD1mcm9tUGF0aC5sZW5ndGgtMTsgbD49a2VlcDsgbC0tKSB7CiAgICAgICAgICBleGl0aW5nID0gZnJvbVBhdGhbbF07CiAgICAgICAgICBpZiAoZXhpdGluZy5zZWxmLm9uRXhpdCkgewogICAgICAgICAgICAkaW5qZWN0b3IuaW52b2tlKGV4aXRpbmcuc2VsZi5vbkV4aXQsIGV4aXRpbmcuc2VsZiwgZXhpdGluZy5sb2NhbHMuZ2xvYmFscyk7CiAgICAgICAgICB9CiAgICAgICAgICBleGl0aW5nLmxvY2FscyA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBFbnRlciAndG8nIHN0YXRlcyBub3Qga2VwdAogICAgICAgIGZvciAobD1rZWVwOyBsPHRvUGF0aC5sZW5ndGg7IGwrKykgewogICAgICAgICAgZW50ZXJpbmcgPSB0b1BhdGhbbF07CiAgICAgICAgICBlbnRlcmluZy5sb2NhbHMgPSB0b0xvY2Fsc1tsXTsKICAgICAgICAgIGlmIChlbnRlcmluZy5zZWxmLm9uRW50ZXIpIHsKICAgICAgICAgICAgJGluamVjdG9yLmludm9rZShlbnRlcmluZy5zZWxmLm9uRW50ZXIsIGVudGVyaW5nLnNlbGYsIGVudGVyaW5nLmxvY2Fscy5nbG9iYWxzKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFJ1biBpdCBhZ2FpbiwgdG8gY2F0Y2ggYW55IHRyYW5zaXRpb25zIGluIGNhbGxiYWNrcwogICAgICAgIGlmICgkc3RhdGUudHJhbnNpdGlvbiAhPT0gdHJhbnNpdGlvbikgcmV0dXJuIFRyYW5zaXRpb25TdXBlcnNlZGVkOwoKICAgICAgICAvLyBVcGRhdGUgZ2xvYmFscyBpbiAkc3RhdGUKICAgICAgICAkc3RhdGUuJGN1cnJlbnQgPSB0bzsKICAgICAgICAkc3RhdGUuY3VycmVudCA9IHRvLnNlbGY7CiAgICAgICAgJHN0YXRlLnBhcmFtcyA9IHRvUGFyYW1zOwogICAgICAgIGNvcHkoJHN0YXRlLnBhcmFtcywgJHN0YXRlUGFyYW1zKTsKICAgICAgICAkc3RhdGUudHJhbnNpdGlvbiA9IG51bGw7CgogICAgICAgIC8vIFVwZGF0ZSAkbG9jYXRpb24KICAgICAgICB2YXIgdG9OYXYgPSB0by5uYXZpZ2FibGU7CiAgICAgICAgaWYgKG9wdGlvbnMubG9jYXRpb24gJiYgdG9OYXYpIHsKICAgICAgICAgICRsb2NhdGlvbi51cmwodG9OYXYudXJsLmZvcm1hdCh0b05hdi5sb2NhbHMuZ2xvYmFscy4kc3RhdGVQYXJhbXMpKTsKCiAgICAgICAgICBpZiAob3B0aW9ucy5sb2NhdGlvbiA9PT0gJ3JlcGxhY2UnKSB7CiAgICAgICAgICAgICRsb2NhdGlvbi5yZXBsYWNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5ub3RpZnkpIHsKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlIyRzdGF0ZUNoYW5nZVN1Y2Nlc3MKICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEZpcmVkIG9uY2UgdGhlIHN0YXRlIHRyYW5zaXRpb24gaXMgKipjb21wbGV0ZSoqLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IEV2ZW50IG9iamVjdC4KICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSB0b1N0YXRlIFRoZSBzdGF0ZSBiZWluZyB0cmFuc2l0aW9uZWQgdG8uCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRvUGFyYW1zIFRoZSBwYXJhbXMgc3VwcGxpZWQgdG8gdGhlIGB0b1N0YXRlYC4KICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSBmcm9tU3RhdGUgVGhlIGN1cnJlbnQgc3RhdGUsIHByZS10cmFuc2l0aW9uLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmcm9tUGFyYW1zIFRoZSBwYXJhbXMgc3VwcGxpZWQgdG8gdGhlIGBmcm9tU3RhdGVgLgogICAgICAgICAqLwogICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgdG8uc2VsZiwgdG9QYXJhbXMsIGZyb20uc2VsZiwgZnJvbVBhcmFtcyk7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRMb2NhdGlvbiA9ICRsb2NhdGlvbi51cmwoKTsKCiAgICAgICAgcmV0dXJuICRzdGF0ZS5jdXJyZW50OwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBpZiAoJHN0YXRlLnRyYW5zaXRpb24gIT09IHRyYW5zaXRpb24pIHJldHVybiBUcmFuc2l0aW9uU3VwZXJzZWRlZDsKCiAgICAgICAgJHN0YXRlLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjJHN0YXRlQ2hhbmdlRXJyb3IKICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEZpcmVkIHdoZW4gYW4gKiplcnJvciBvY2N1cnMqKiBkdXJpbmcgdHJhbnNpdGlvbi4gSXQncyBpbXBvcnRhbnQgdG8gbm90ZSB0aGF0IGlmIHlvdQogICAgICAgICAqIGhhdmUgYW55IGVycm9ycyBpbiB5b3VyIHJlc29sdmUgZnVuY3Rpb25zIChqYXZhc2NyaXB0IGVycm9ycywgbm9uLWV4aXN0ZW50IHNlcnZpY2VzLCBldGMpCiAgICAgICAgICogdGhleSB3aWxsIG5vdCB0aHJvdyB0cmFkaXRpb25hbGx5LiBZb3UgbXVzdCBsaXN0ZW4gZm9yIHRoaXMgJHN0YXRlQ2hhbmdlRXJyb3IgZXZlbnQgdG8KICAgICAgICAgKiBjYXRjaCAqKkFMTCoqIGVycm9ycy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBFdmVudCBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gdG9TdGF0ZSBUaGUgc3RhdGUgYmVpbmcgdHJhbnNpdGlvbmVkIHRvLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0b1BhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgdG9TdGF0ZWAuCiAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gZnJvbVN0YXRlIFRoZSBjdXJyZW50IHN0YXRlLCBwcmUtdHJhbnNpdGlvbi4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZnJvbVBhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgZnJvbVN0YXRlYC4KICAgICAgICAgKiBAcGFyYW0ge0Vycm9yfSBlcnJvciBUaGUgcmVzb2x2ZSBlcnJvciBvYmplY3QuCiAgICAgICAgICovCiAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckc3RhdGVDaGFuZ2VFcnJvcicsIHRvLnNlbGYsIHRvUGFyYW1zLCBmcm9tLnNlbGYsIGZyb21QYXJhbXMsIGVycm9yKTsKICAgICAgICBzeW5jVXJsKCk7CgogICAgICAgIHJldHVybiAkcS5yZWplY3QoZXJyb3IpOwogICAgICB9KTsKCiAgICAgIHJldHVybiB0cmFuc2l0aW9uOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNpcwogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNpbWlsYXIgdG8ge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjbWV0aG9kc19pbmNsdWRlcyAkc3RhdGUuaW5jbHVkZXN9LAogICAgICogYnV0IG9ubHkgY2hlY2tzIGZvciB0aGUgZnVsbCBzdGF0ZSBuYW1lLiBJZiBwYXJhbXMgaXMgc3VwcGxpZWQgdGhlbiBpdCB3aWxsIGJlIAogICAgICogdGVzdGVkIGZvciBzdHJpY3QgZXF1YWxpdHkgYWdhaW5zdCB0aGUgY3VycmVudCBhY3RpdmUgcGFyYW1zIG9iamVjdCwgc28gYWxsIHBhcmFtcyAKICAgICAqIG11c3QgbWF0Y2ggd2l0aCBub25lIG1pc3NpbmcgYW5kIG5vIGV4dHJhcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqICRzdGF0ZS5pcygnY29udGFjdC5kZXRhaWxzLml0ZW0nKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgKiAkc3RhdGUuaXMoY29udGFjdERldGFpbEl0ZW1TdGF0ZU9iamVjdCk7IC8vIHJldHVybnMgdHJ1ZQogICAgICoKICAgICAqIC8vIGV2ZXJ5dGhpbmcgZWxzZSB3b3VsZCByZXR1cm4gZmFsc2UKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gc3RhdGVOYW1lIFRoZSBzdGF0ZSBuYW1lIG9yIHN0YXRlIG9iamVjdCB5b3UnZCBsaWtlIHRvIGNoZWNrLgogICAgICogQHBhcmFtIHtvYmplY3Q9fSBwYXJhbXMgQSBwYXJhbSBvYmplY3QsIGUuZy4gYHtzZWN0aW9uSWQ6IHNlY3Rpb24uaWR9YCwgdGhhdCB5b3UnZCBsaWtlIAogICAgICogdG8gdGVzdCBhZ2FpbnN0IHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgaXQgaXMgdGhlIHN0YXRlLgogICAgICovCiAgICAkc3RhdGUuaXMgPSBmdW5jdGlvbiBpcyhzdGF0ZU9yTmFtZSwgcGFyYW1zKSB7CiAgICAgIHZhciBzdGF0ZSA9IGZpbmRTdGF0ZShzdGF0ZU9yTmFtZSk7CgogICAgICBpZiAoIWlzRGVmaW5lZChzdGF0ZSkpIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CgogICAgICBpZiAoJHN0YXRlLiRjdXJyZW50ICE9PSBzdGF0ZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGlzRGVmaW5lZChwYXJhbXMpICYmIHBhcmFtcyAhPT0gbnVsbCA/IGFuZ3VsYXIuZXF1YWxzKCRzdGF0ZVBhcmFtcywgcGFyYW1zKSA6IHRydWU7CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI2luY2x1ZGVzCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSBtZXRob2QgdG8gZGV0ZXJtaW5lIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZSBpcyBlcXVhbCB0byBvciBpcyB0aGUgY2hpbGQgb2YgdGhlIAogICAgICogc3RhdGUgc3RhdGVOYW1lLiBJZiBhbnkgcGFyYW1zIGFyZSBwYXNzZWQgdGhlbiB0aGV5IHdpbGwgYmUgdGVzdGVkIGZvciBhIG1hdGNoIGFzIHdlbGwuCiAgICAgKiBOb3QgYWxsIHRoZSBwYXJhbWV0ZXJzIG5lZWQgdG8gYmUgcGFzc2VkLCBqdXN0IHRoZSBvbmVzIHlvdSdkIGxpa2UgdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAkc3RhdGUuJGN1cnJlbnQubmFtZSA9ICdjb250YWN0cy5kZXRhaWxzLml0ZW0nOwogICAgICoKICAgICAqICRzdGF0ZS5pbmNsdWRlcygiY29udGFjdHMiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImNvbnRhY3RzLmRldGFpbHMiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImNvbnRhY3RzLmRldGFpbHMuaXRlbSIpOyAvLyByZXR1cm5zIHRydWUKICAgICAqICRzdGF0ZS5pbmNsdWRlcygiY29udGFjdHMubGlzdCIpOyAvLyByZXR1cm5zIGZhbHNlCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImFib3V0Iik7IC8vIHJldHVybnMgZmFsc2UKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQmFzaWMgZ2xvYmluZyBwYXR0ZXJucyB3aWxsIGFsc28gd29yay4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqICRzdGF0ZS4kY3VycmVudC5uYW1lID0gJ2NvbnRhY3RzLmRldGFpbHMuaXRlbS51cmwnOwogICAgICoKICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKi5kZXRhaWxzLiouKiIpOyAvLyByZXR1cm5zIHRydWUKICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKi5kZXRhaWxzLioqIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICogJHN0YXRlLmluY2x1ZGVzKCIqKi5pdGVtLioqIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICogJHN0YXRlLmluY2x1ZGVzKCIqLmRldGFpbHMuaXRlbS51cmwiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgKiAkc3RhdGUuaW5jbHVkZXMoIiouZGV0YWlscy4qLnVybCIpOyAvLyByZXR1cm5zIHRydWUKICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKi5kZXRhaWxzLioiKTsgLy8gcmV0dXJucyBmYWxzZQogICAgICogJHN0YXRlLmluY2x1ZGVzKCJpdGVtLioqIik7IC8vIHJldHVybnMgZmFsc2UKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGF0ZU9yTmFtZSBBIHBhcnRpYWwgbmFtZSB0byBiZSBzZWFyY2hlZCBmb3Igd2l0aGluIHRoZSBjdXJyZW50IHN0YXRlIG5hbWUuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFyYW1zIEEgcGFyYW0gb2JqZWN0LCBlLmcuIGB7c2VjdGlvbklkOiBzZWN0aW9uLmlkfWAsIAogICAgICogdGhhdCB5b3UnZCBsaWtlIHRvIHRlc3QgYWdhaW5zdCB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIGl0IGRvZXMgaW5jbHVkZSB0aGUgc3RhdGUKICAgICAqLwoKICAgICRzdGF0ZS5pbmNsdWRlcyA9IGZ1bmN0aW9uIGluY2x1ZGVzKHN0YXRlT3JOYW1lLCBwYXJhbXMpIHsKICAgICAgaWYgKGlzU3RyaW5nKHN0YXRlT3JOYW1lKSAmJiBpc0dsb2Ioc3RhdGVPck5hbWUpKSB7CiAgICAgICAgaWYgKGRvZXNTdGF0ZU1hdGNoR2xvYihzdGF0ZU9yTmFtZSkpIHsKICAgICAgICAgIHN0YXRlT3JOYW1lID0gJHN0YXRlLiRjdXJyZW50Lm5hbWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBzdGF0ZSA9IGZpbmRTdGF0ZShzdGF0ZU9yTmFtZSk7CiAgICAgIGlmICghaXNEZWZpbmVkKHN0YXRlKSkgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIGlmICghaXNEZWZpbmVkKCRzdGF0ZS4kY3VycmVudC5pbmNsdWRlc1tzdGF0ZS5uYW1lXSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciB2YWxpZFBhcmFtcyA9IHRydWU7CiAgICAgIGFuZ3VsYXIuZm9yRWFjaChwYXJhbXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBpZiAoIWlzRGVmaW5lZCgkc3RhdGVQYXJhbXNba2V5XSkgfHwgJHN0YXRlUGFyYW1zW2tleV0gIT09IHZhbHVlKSB7CiAgICAgICAgICB2YWxpZFBhcmFtcyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiB2YWxpZFBhcmFtczsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI2hyZWYKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHVybCBnZW5lcmF0aW9uIG1ldGhvZCB0aGF0IHJldHVybnMgdGhlIGNvbXBpbGVkIHVybCBmb3IgdGhlIGdpdmVuIHN0YXRlIHBvcHVsYXRlZCB3aXRoIHRoZSBnaXZlbiBwYXJhbXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiBleHBlY3QoJHN0YXRlLmhyZWYoImFib3V0LnBlcnNvbiIsIHsgcGVyc29uOiAiYm9iIiB9KSkudG9FcXVhbCgiL2Fib3V0L2JvYiIpOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBzdGF0ZU9yTmFtZSBUaGUgc3RhdGUgbmFtZSBvciBzdGF0ZSBvYmplY3QgeW91J2QgbGlrZSB0byBnZW5lcmF0ZSBhIHVybCBmcm9tLgogICAgICogQHBhcmFtIHtvYmplY3Q9fSBwYXJhbXMgQW4gb2JqZWN0IG9mIHBhcmFtZXRlciB2YWx1ZXMgdG8gZmlsbCB0aGUgc3RhdGUncyByZXF1aXJlZCBwYXJhbWV0ZXJzLgogICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0LiBUaGUgb3B0aW9ucyBhcmU6CiAgICAgKgogICAgICogLSAqKmBsb3NzeWAqKiAtIHtib29sZWFuPXRydWV9IC0gIElmIHRydWUsIGFuZCBpZiB0aGVyZSBpcyBubyB1cmwgYXNzb2NpYXRlZCB3aXRoIHRoZSBzdGF0ZSBwcm92aWRlZCBpbiB0aGUKICAgICAqICAgIGZpcnN0IHBhcmFtZXRlciwgdGhlbiB0aGUgY29uc3RydWN0ZWQgaHJlZiB1cmwgd2lsbCBiZSBidWlsdCBmcm9tIHRoZSBmaXJzdCBuYXZpZ2FibGUgYW5jZXN0b3IgKGFrYQogICAgICogICAgYW5jZXN0b3Igd2l0aCBhIHZhbGlkIHVybCkuCiAgICAgKiAtICoqYGluaGVyaXRgKiogLSB7Ym9vbGVhbj1mYWxzZX0sIElmIGB0cnVlYCB3aWxsIGluaGVyaXQgdXJsIHBhcmFtZXRlcnMgZnJvbSBjdXJyZW50IHVybC4KICAgICAqIC0gKipgcmVsYXRpdmVgKiogLSB7b2JqZWN0PSRzdGF0ZS4kY3VycmVudH0sIFdoZW4gdHJhbnNpdGlvbmluZyB3aXRoIHJlbGF0aXZlIHBhdGggKGUuZyAnXicpLCAKICAgICAqICAgIGRlZmluZXMgd2hpY2ggc3RhdGUgdG8gYmUgcmVsYXRpdmUgZnJvbS4KICAgICAqIC0gKipgYWJzb2x1dGVgKiogLSB7Ym9vbGVhbj1mYWxzZX0sICBJZiB0cnVlIHdpbGwgZ2VuZXJhdGUgYW4gYWJzb2x1dGUgdXJsLCBlLmcuICJodHRwOi8vd3d3LmV4YW1wbGUuY29tL2Z1bGx1cmwiLgogICAgICogCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBjb21waWxlZCBzdGF0ZSB1cmwKICAgICAqLwogICAgJHN0YXRlLmhyZWYgPSBmdW5jdGlvbiBocmVmKHN0YXRlT3JOYW1lLCBwYXJhbXMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IGV4dGVuZCh7IGxvc3N5OiB0cnVlLCBpbmhlcml0OiBmYWxzZSwgYWJzb2x1dGU6IGZhbHNlLCByZWxhdGl2ZTogJHN0YXRlLiRjdXJyZW50IH0sIG9wdGlvbnMgfHwge30pOwogICAgICB2YXIgc3RhdGUgPSBmaW5kU3RhdGUoc3RhdGVPck5hbWUsIG9wdGlvbnMucmVsYXRpdmUpOwogICAgICBpZiAoIWlzRGVmaW5lZChzdGF0ZSkpIHJldHVybiBudWxsOwoKICAgICAgcGFyYW1zID0gaW5oZXJpdFBhcmFtcygkc3RhdGVQYXJhbXMsIHBhcmFtcyB8fCB7fSwgJHN0YXRlLiRjdXJyZW50LCBzdGF0ZSk7CiAgICAgIHZhciBuYXYgPSAoc3RhdGUgJiYgb3B0aW9ucy5sb3NzeSkgPyBzdGF0ZS5uYXZpZ2FibGUgOiBzdGF0ZTsKICAgICAgdmFyIHVybCA9IChuYXYgJiYgbmF2LnVybCkgPyBuYXYudXJsLmZvcm1hdChub3JtYWxpemUoc3RhdGUucGFyYW1zLCBwYXJhbXMgfHwge30pKSA6IG51bGw7CiAgICAgIGlmICghJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKCkgJiYgdXJsKSB7CiAgICAgICAgdXJsID0gIiMiICsgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgpICsgdXJsOwogICAgICB9CgogICAgICBpZiAoYmFzZUhyZWYgIT09ICcvJykgewogICAgICAgIGlmICgkbG9jYXRpb25Qcm92aWRlci5odG1sNU1vZGUoKSkgewogICAgICAgICAgdXJsID0gYmFzZUhyZWYuc2xpY2UoMCwgLTEpICsgdXJsOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5hYnNvbHV0ZSl7CiAgICAgICAgICB1cmwgPSBiYXNlSHJlZi5zbGljZSgxKSArIHVybDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmFic29sdXRlICYmIHVybCkgewogICAgICAgIHVybCA9ICRsb2NhdGlvbi5wcm90b2NvbCgpICsgJzovLycgKyAKICAgICAgICAgICAgICAkbG9jYXRpb24uaG9zdCgpICsgCiAgICAgICAgICAgICAgKCRsb2NhdGlvbi5wb3J0KCkgPT0gODAgfHwgJGxvY2F0aW9uLnBvcnQoKSA9PSA0NDMgPyAnJyA6ICc6JyArICRsb2NhdGlvbi5wb3J0KCkpICsgCiAgICAgICAgICAgICAgKCEkbG9jYXRpb25Qcm92aWRlci5odG1sNU1vZGUoKSAmJiB1cmwgPyAnLycgOiAnJykgKyAKICAgICAgICAgICAgICB1cmw7CiAgICAgIH0KICAgICAgcmV0dXJuIHVybDsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjZ2V0CiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyB0aGUgc3RhdGUgY29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGFueSBzcGVjaWZpYyBzdGF0ZSBvciBhbGwgc3RhdGVzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdD19IHN0YXRlT3JOYW1lIElmIHByb3ZpZGVkLCB3aWxsIG9ubHkgZ2V0IHRoZSBjb25maWcgZm9yCiAgICAgKiB0aGUgcmVxdWVzdGVkIHN0YXRlLiBJZiBub3QgcHJvdmlkZWQsIHJldHVybnMgYW4gYXJyYXkgb2YgQUxMIHN0YXRlIGNvbmZpZ3MuCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fGFycmF5fSBTdGF0ZSBjb25maWd1cmF0aW9uIG9iamVjdCBvciBhcnJheSBvZiBhbGwgb2JqZWN0cy4KICAgICAqLwogICAgJHN0YXRlLmdldCA9IGZ1bmN0aW9uIChzdGF0ZU9yTmFtZSwgY29udGV4dCkgewogICAgICBpZiAoIWlzRGVmaW5lZChzdGF0ZU9yTmFtZSkpIHsKICAgICAgICB2YXIgbGlzdCA9IFtdOwogICAgICAgIGZvckVhY2goc3RhdGVzLCBmdW5jdGlvbihzdGF0ZSkgeyBsaXN0LnB1c2goc3RhdGUuc2VsZik7IH0pOwogICAgICAgIHJldHVybiBsaXN0OwogICAgICB9CiAgICAgIHZhciBzdGF0ZSA9IGZpbmRTdGF0ZShzdGF0ZU9yTmFtZSwgY29udGV4dCk7CiAgICAgIHJldHVybiAoc3RhdGUgJiYgc3RhdGUuc2VsZikgPyBzdGF0ZS5zZWxmIDogbnVsbDsKICAgIH07CgogICAgZnVuY3Rpb24gcmVzb2x2ZVN0YXRlKHN0YXRlLCBwYXJhbXMsIHBhcmFtc0FyZUZpbHRlcmVkLCBpbmhlcml0ZWQsIGRzdCkgewogICAgICAvLyBNYWtlIGEgcmVzdHJpY3RlZCAkc3RhdGVQYXJhbXMgd2l0aCBvbmx5IHRoZSBwYXJhbWV0ZXJzIHRoYXQgYXBwbHkgdG8gdGhpcyBzdGF0ZSBpZgogICAgICAvLyBuZWNlc3NhcnkuIEluIGFkZGl0aW9uIHRvIGJlaW5nIGF2YWlsYWJsZSB0byB0aGUgY29udHJvbGxlciBhbmQgb25FbnRlci9vbkV4aXQgY2FsbGJhY2tzLAogICAgICAvLyB3ZSBhbHNvIG5lZWQgJHN0YXRlUGFyYW1zIHRvIGJlIGF2YWlsYWJsZSBmb3IgYW55ICRpbmplY3RvciBjYWxscyB3ZSBtYWtlIGR1cmluZyB0aGUKICAgICAgLy8gZGVwZW5kZW5jeSByZXNvbHV0aW9uIHByb2Nlc3MuCiAgICAgIHZhciAkc3RhdGVQYXJhbXMgPSAocGFyYW1zQXJlRmlsdGVyZWQpID8gcGFyYW1zIDogZmlsdGVyQnlLZXlzKHN0YXRlLnBhcmFtcywgcGFyYW1zKTsKICAgICAgdmFyIGxvY2FscyA9IHsgJHN0YXRlUGFyYW1zOiAkc3RhdGVQYXJhbXMgfTsKCiAgICAgIC8vIFJlc29sdmUgJ2dsb2JhbCcgZGVwZW5kZW5jaWVzIGZvciB0aGUgc3RhdGUsIGkuZS4gdGhvc2Ugbm90IHNwZWNpZmljIHRvIGEgdmlldy4KICAgICAgLy8gV2UncmUgYWxzbyBpbmNsdWRpbmcgJHN0YXRlUGFyYW1zIGluIHRoaXM7IHRoYXQgd2F5IHRoZSBwYXJhbWV0ZXJzIGFyZSByZXN0cmljdGVkCiAgICAgIC8vIHRvIHRoZSBzZXQgdGhhdCBzaG91bGQgYmUgdmlzaWJsZSB0byB0aGUgc3RhdGUsIGFuZCBhcmUgaW5kZXBlbmRlbnQgb2Ygd2hlbiB3ZSB1cGRhdGUKICAgICAgLy8gdGhlIGdsb2JhbCAkc3RhdGUgYW5kICRzdGF0ZVBhcmFtcyB2YWx1ZXMuCiAgICAgIGRzdC5yZXNvbHZlID0gJHJlc29sdmUucmVzb2x2ZShzdGF0ZS5yZXNvbHZlLCBsb2NhbHMsIGRzdC5yZXNvbHZlLCBzdGF0ZSk7CiAgICAgIHZhciBwcm9taXNlcyA9IFsgZHN0LnJlc29sdmUudGhlbihmdW5jdGlvbiAoZ2xvYmFscykgewogICAgICAgIGRzdC5nbG9iYWxzID0gZ2xvYmFsczsKICAgICAgfSkgXTsKICAgICAgaWYgKGluaGVyaXRlZCkgcHJvbWlzZXMucHVzaChpbmhlcml0ZWQpOwoKICAgICAgLy8gUmVzb2x2ZSB0ZW1wbGF0ZSBhbmQgZGVwZW5kZW5jaWVzIGZvciBhbGwgdmlld3MuCiAgICAgIGZvckVhY2goc3RhdGUudmlld3MsIGZ1bmN0aW9uICh2aWV3LCBuYW1lKSB7CiAgICAgICAgdmFyIGluamVjdGFibGVzID0gKHZpZXcucmVzb2x2ZSAmJiB2aWV3LnJlc29sdmUgIT09IHN0YXRlLnJlc29sdmUgPyB2aWV3LnJlc29sdmUgOiB7fSk7CiAgICAgICAgaW5qZWN0YWJsZXMuJHRlbXBsYXRlID0gWyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gJHZpZXcubG9hZChuYW1lLCB7IHZpZXc6IHZpZXcsIGxvY2FsczogbG9jYWxzLCBwYXJhbXM6ICRzdGF0ZVBhcmFtcywgbm90aWZ5OiBmYWxzZSB9KSB8fCAnJzsKICAgICAgICB9XTsKCiAgICAgICAgcHJvbWlzZXMucHVzaCgkcmVzb2x2ZS5yZXNvbHZlKGluamVjdGFibGVzLCBsb2NhbHMsIGRzdC5yZXNvbHZlLCBzdGF0ZSkudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICAvLyBSZWZlcmVuY2VzIHRvIHRoZSBjb250cm9sbGVyIChvbmx5IGluc3RhbnRpYXRlZCBhdCBsaW5rIHRpbWUpCiAgICAgICAgICBpZiAoaXNGdW5jdGlvbih2aWV3LmNvbnRyb2xsZXJQcm92aWRlcikgfHwgaXNBcnJheSh2aWV3LmNvbnRyb2xsZXJQcm92aWRlcikpIHsKICAgICAgICAgICAgdmFyIGluamVjdExvY2FscyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBpbmplY3RhYmxlcywgbG9jYWxzKTsKICAgICAgICAgICAgcmVzdWx0LiQkY29udHJvbGxlciA9ICRpbmplY3Rvci5pbnZva2Uodmlldy5jb250cm9sbGVyUHJvdmlkZXIsIG51bGwsIGluamVjdExvY2Fscyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQuJCRjb250cm9sbGVyID0gdmlldy5jb250cm9sbGVyOwogICAgICAgICAgfQogICAgICAgICAgLy8gUHJvdmlkZSBhY2Nlc3MgdG8gdGhlIHN0YXRlIGl0c2VsZiBmb3IgaW50ZXJuYWwgdXNlCiAgICAgICAgICByZXN1bHQuJCRzdGF0ZSA9IHN0YXRlOwogICAgICAgICAgcmVzdWx0LiQkY29udHJvbGxlckFzID0gdmlldy5jb250cm9sbGVyQXM7CiAgICAgICAgICBkc3RbbmFtZV0gPSByZXN1bHQ7CiAgICAgICAgfSkpOwogICAgICB9KTsKCiAgICAgIC8vIFdhaXQgZm9yIGFsbCB0aGUgcHJvbWlzZXMgYW5kIHRoZW4gcmV0dXJuIHRoZSBhY3RpdmF0aW9uIG9iamVjdAogICAgICByZXR1cm4gJHEuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgICAgICByZXR1cm4gZHN0OwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gJHN0YXRlOwogIH0KCiAgZnVuY3Rpb24gc2hvdWxkVHJpZ2dlclJlbG9hZCh0bywgZnJvbSwgbG9jYWxzLCBvcHRpb25zKSB7CiAgICBpZiAoIHRvID09PSBmcm9tICYmICgobG9jYWxzID09PSBmcm9tLmxvY2FscyAmJiAhb3B0aW9ucy5yZWxvYWQpIHx8ICh0by5zZWxmLnJlbG9hZE9uU2VhcmNoID09PSBmYWxzZSkpICkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnKQogIC52YWx1ZSgnJHN0YXRlUGFyYW1zJywge30pCiAgLnByb3ZpZGVyKCckc3RhdGUnLCAkU3RhdGVQcm92aWRlcik7CgoKJFZpZXdQcm92aWRlci4kaW5qZWN0ID0gW107CmZ1bmN0aW9uICRWaWV3UHJvdmlkZXIoKSB7CgogIHRoaXMuJGdldCA9ICRnZXQ7CiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kdmlldwogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkKICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKi8KICAkZ2V0LiRpbmplY3QgPSBbJyRyb290U2NvcGUnLCAnJHRlbXBsYXRlRmFjdG9yeSddOwogIGZ1bmN0aW9uICRnZXQoICAgJHJvb3RTY29wZSwgICAkdGVtcGxhdGVGYWN0b3J5KSB7CiAgICByZXR1cm4gewogICAgICAvLyAkdmlldy5sb2FkKCdmdWxsLnZpZXdOYW1lJywgeyB0ZW1wbGF0ZTogLi4uLCBjb250cm9sbGVyOiAuLi4sIHJlc29sdmU6IC4uLiwgYXN5bmM6IGZhbHNlLCBwYXJhbXM6IC4uLiB9KQogICAgICAvKioKICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kdmlldyNsb2FkCiAgICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHZpZXcKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIG5hbWUKICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgb3B0aW9uIG9iamVjdC4KICAgICAgICovCiAgICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQobmFtZSwgb3B0aW9ucykgewogICAgICAgIHZhciByZXN1bHQsIGRlZmF1bHRzID0gewogICAgICAgICAgdGVtcGxhdGU6IG51bGwsIGNvbnRyb2xsZXI6IG51bGwsIHZpZXc6IG51bGwsIGxvY2FsczogbnVsbCwgbm90aWZ5OiB0cnVlLCBhc3luYzogdHJ1ZSwgcGFyYW1zOiB7fQogICAgICAgIH07CiAgICAgICAgb3B0aW9ucyA9IGV4dGVuZChkZWZhdWx0cywgb3B0aW9ucyk7CgogICAgICAgIGlmIChvcHRpb25zLnZpZXcpIHsKICAgICAgICAgIHJlc3VsdCA9ICR0ZW1wbGF0ZUZhY3RvcnkuZnJvbUNvbmZpZyhvcHRpb25zLnZpZXcsIG9wdGlvbnMucGFyYW1zLCBvcHRpb25zLmxvY2Fscyk7CiAgICAgICAgfQogICAgICAgIGlmIChyZXN1bHQgJiYgb3B0aW9ucy5ub3RpZnkpIHsKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlIyR2aWV3Q29udGVudExvYWRpbmcKICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHZpZXcKICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBGaXJlZCBvbmNlIHRoZSB2aWV3ICoqYmVnaW5zIGxvYWRpbmcqKiwgKmJlZm9yZSogdGhlIERPTSBpcyByZW5kZXJlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBFdmVudCBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHZpZXdDb25maWcgVGhlIHZpZXcgY29uZmlnIHByb3BlcnRpZXMgKHRlbXBsYXRlLCBjb250cm9sbGVyLCBldGMpLgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgKgogICAgICAgICAqIDxwcmU+CiAgICAgICAgICogJHNjb3BlLiRvbignJHZpZXdDb250ZW50TG9hZGluZycsCiAgICAgICAgICogZnVuY3Rpb24oZXZlbnQsIHZpZXdDb25maWcpewogICAgICAgICAqICAgICAvLyBBY2Nlc3MgdG8gYWxsIHRoZSB2aWV3IGNvbmZpZyBwcm9wZXJ0aWVzLgogICAgICAgICAqICAgICAvLyBhbmQgb25lIHNwZWNpYWwgcHJvcGVydHkgJ3RhcmdldFZpZXcnCiAgICAgICAgICogICAgIC8vIHZpZXdDb25maWcudGFyZ2V0VmlldwogICAgICAgICAqIH0pOwogICAgICAgICAqIDwvcHJlPgogICAgICAgICAqLwogICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckdmlld0NvbnRlbnRMb2FkaW5nJywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH07CiAgfQp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykucHJvdmlkZXIoJyR2aWV3JywgJFZpZXdQcm92aWRlcik7CgovKioKICogQG5nZG9jIG9iamVjdAogKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbFByb3ZpZGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBQcm92aWRlciB0aGF0IHJldHVybnMgdGhlIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbH0gc2VydmljZSBmdW5jdGlvbi4KICovCmZ1bmN0aW9uICRWaWV3U2Nyb2xsUHJvdmlkZXIoKSB7CgogIHZhciB1c2VBbmNob3JTY3JvbGwgPSBmYWxzZTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGxQcm92aWRlciN1c2VBbmNob3JTY3JvbGwKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGxQcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV2ZXJ0cyBiYWNrIHRvIHVzaW5nIHRoZSBjb3JlIFtgJGFuY2hvclNjcm9sbGBdKGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRhbmNob3JTY3JvbGwpIHNlcnZpY2UgZm9yCiAgICogc2Nyb2xsaW5nIGJhc2VkIG9uIHRoZSB1cmwgYW5jaG9yLgogICAqLwogIHRoaXMudXNlQW5jaG9yU2Nyb2xsID0gZnVuY3Rpb24gKCkgewogICAgdXNlQW5jaG9yU2Nyb2xsID0gdHJ1ZTsKICB9OwoKICAvKioKICAgKiBAbmdkb2Mgb2JqZWN0CiAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGwKICAgKgogICAqIEByZXF1aXJlcyAkYW5jaG9yU2Nyb2xsCiAgICogQHJlcXVpcmVzICR0aW1lb3V0CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBXaGVuIGNhbGxlZCB3aXRoIGEganFMaXRlIGVsZW1lbnQsIGl0IHNjcm9sbHMgdGhlIGVsZW1lbnQgaW50byB2aWV3IChhZnRlciBhCiAgICogYCR0aW1lb3V0YCBzbyB0aGUgRE9NIGhhcyB0aW1lIHRvIHJlZnJlc2gpLgogICAqCiAgICogSWYgeW91IHByZWZlciB0byByZWx5IG9uIGAkYW5jaG9yU2Nyb2xsYCB0byBzY3JvbGwgdGhlIHZpZXcgdG8gdGhlIGFuY2hvciwKICAgKiB0aGlzIGNhbiBiZSBlbmFibGVkIGJ5IGNhbGxpbmcge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsUHJvdmlkZXIjbWV0aG9kc191c2VBbmNob3JTY3JvbGwgYCR1aVZpZXdTY3JvbGxQcm92aWRlci51c2VBbmNob3JTY3JvbGwoKWB9LgogICAqLwogIHRoaXMuJGdldCA9IFsnJGFuY2hvclNjcm9sbCcsICckdGltZW91dCcsIGZ1bmN0aW9uICgkYW5jaG9yU2Nyb2xsLCAkdGltZW91dCkgewogICAgaWYgKHVzZUFuY2hvclNjcm9sbCkgewogICAgICByZXR1cm4gJGFuY2hvclNjcm9sbDsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gKCRlbGVtZW50KSB7CiAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAkZWxlbWVudFswXS5zY3JvbGxJbnRvVmlldygpOwogICAgICB9LCAwLCBmYWxzZSk7CiAgICB9OwogIH1dOwp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykucHJvdmlkZXIoJyR1aVZpZXdTY3JvbGwnLCAkVmlld1Njcm9sbFByb3ZpZGVyKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktdmlldwogKgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogKiBAcmVxdWlyZXMgJGNvbXBpbGUKICogQHJlcXVpcmVzICRjb250cm9sbGVyCiAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsCiAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICoKICogQHJlc3RyaWN0IEVDQQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIHVpLXZpZXcgZGlyZWN0aXZlIHRlbGxzICRzdGF0ZSB3aGVyZSB0byBwbGFjZSB5b3VyIHRlbXBsYXRlcy4KICoKICogQHBhcmFtIHtzdHJpbmc9fSB1aS12aWV3IEEgdmlldyBuYW1lLiBUaGUgbmFtZSBzaG91bGQgYmUgdW5pcXVlIGFtb25nc3QgdGhlIG90aGVyIHZpZXdzIGluIHRoZQogKiBzYW1lIHN0YXRlLiBZb3UgY2FuIGhhdmUgdmlld3Mgb2YgdGhlIHNhbWUgbmFtZSB0aGF0IGxpdmUgaW4gZGlmZmVyZW50IHN0YXRlcy4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBhdXRvc2Nyb2xsIEl0IGFsbG93cyB5b3UgdG8gc2V0IHRoZSBzY3JvbGwgYmVoYXZpb3Igb2YgdGhlIGJyb3dzZXIgd2luZG93CiAqIHdoZW4gYSB2aWV3IGlzIHBvcHVsYXRlZC4gQnkgZGVmYXVsdCwgJGFuY2hvclNjcm9sbCBpcyBvdmVycmlkZGVuIGJ5IHVpLXJvdXRlcidzIGN1c3RvbSBzY3JvbGwKICogc2VydmljZSwge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsfS4gVGhpcyBjdXN0b20gc2VydmljZSBsZXQncyB5b3UKICogc2Nyb2xsIHVpLXZpZXcgZWxlbWVudHMgaW50byB2aWV3IHdoZW4gdGhleSBhcmUgcG9wdWxhdGVkIGR1cmluZyBhIHN0YXRlIGFjdGl2YXRpb24uCiAqCiAqICpOb3RlOiBUbyByZXZlcnQgYmFjayB0byBvbGQgW2AkYW5jaG9yU2Nyb2xsYF0oaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcuJGFuY2hvclNjcm9sbCkKICogZnVuY3Rpb25hbGl0eSwgY2FsbCBgJHVpVmlld1Njcm9sbFByb3ZpZGVyLnVzZUFuY2hvclNjcm9sbCgpYC4qCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gb25sb2FkIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbmV2ZXIgdGhlIHZpZXcgdXBkYXRlcy4KICogCiAqIEBleGFtcGxlCiAqIEEgdmlldyBjYW4gYmUgdW5uYW1lZCBvciBuYW1lZC4gCiAqIDxwcmU+CiAqIDwhLS0gVW5uYW1lZCAtLT4KICogPGRpdiB1aS12aWV3PjwvZGl2PiAKICogCiAqIDwhLS0gTmFtZWQgLS0+CiAqIDxkaXYgdWktdmlldz0idmlld05hbWUiPjwvZGl2PgogKiA8L3ByZT4KICoKICogWW91IGNhbiBvbmx5IGhhdmUgb25lIHVubmFtZWQgdmlldyB3aXRoaW4gYW55IHRlbXBsYXRlIChvciByb290IGh0bWwpLiBJZiB5b3UgYXJlIG9ubHkgdXNpbmcgYSAKICogc2luZ2xlIHZpZXcgYW5kIGl0IGlzIHVubmFtZWQgdGhlbiB5b3UgY2FuIHBvcHVsYXRlIGl0IGxpa2Ugc286CiAqIDxwcmU+CiAqIDxkaXYgdWktdmlldz48L2Rpdj4gCiAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwgewogKiAgIHRlbXBsYXRlOiAiPGgxPkhFTExPITwvaDE+IgogKiB9KQogKiA8L3ByZT4KICogCiAqIFRoZSBhYm92ZSBpcyBhIGNvbnZlbmllbnQgc2hvcnRjdXQgZXF1aXZhbGVudCB0byBzcGVjaWZ5aW5nIHlvdXIgdmlldyBleHBsaWNpdGx5IHdpdGggdGhlIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUHJvdmlkZXIjdmlld3MgYHZpZXdzYH0KICogY29uZmlnIHByb3BlcnR5LCBieSBuYW1lLCBpbiB0aGlzIGNhc2UgYW4gZW1wdHkgbmFtZToKICogPHByZT4KICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUiLCB7CiAqICAgdmlld3M6IHsKICogICAgICIiOiB7CiAqICAgICAgIHRlbXBsYXRlOiAiPGgxPkhFTExPITwvaDE+IgogKiAgICAgfQogKiAgIH0gICAgCiAqIH0pCiAqIDwvcHJlPgogKiAKICogQnV0IHR5cGljYWxseSB5b3UnbGwgb25seSB1c2UgdGhlIHZpZXdzIHByb3BlcnR5IGlmIHlvdSBuYW1lIHlvdXIgdmlldyBvciBoYXZlIG1vcmUgdGhhbiBvbmUgdmlldyAKICogaW4gdGhlIHNhbWUgdGVtcGxhdGUuIFRoZXJlJ3Mgbm90IHJlYWxseSBhIGNvbXBlbGxpbmcgcmVhc29uIHRvIG5hbWUgYSB2aWV3IGlmIGl0cyB0aGUgb25seSBvbmUsIAogKiBidXQgeW91IGNvdWxkIGlmIHlvdSB3YW50ZWQsIGxpa2Ugc286CiAqIDxwcmU+CiAqIDxkaXYgdWktdmlldz0ibWFpbiI+PC9kaXY+CiAqIDwvcHJlPiAKICogPHByZT4KICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUiLCB7CiAqICAgdmlld3M6IHsKICogICAgICJtYWluIjogewogKiAgICAgICB0ZW1wbGF0ZTogIjxoMT5IRUxMTyE8L2gxPiIKICogICAgIH0KICogICB9ICAgIAogKiB9KQogKiA8L3ByZT4KICogCiAqIFJlYWxseSB0aG91Z2gsIHlvdSdsbCB1c2Ugdmlld3MgdG8gc2V0IHVwIG11bHRpcGxlIHZpZXdzOgogKiA8cHJlPgogKiA8ZGl2IHVpLXZpZXc+PC9kaXY+CiAqIDxkaXYgdWktdmlldz0iY2hhcnQiPjwvZGl2PiAKICogPGRpdiB1aS12aWV3PSJkYXRhIj48L2Rpdj4gCiAqIDwvcHJlPgogKiAKICogPHByZT4KICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUiLCB7CiAqICAgdmlld3M6IHsKICogICAgICIiOiB7CiAqICAgICAgIHRlbXBsYXRlOiAiPGgxPkhFTExPITwvaDE+IgogKiAgICAgfSwKICogICAgICJjaGFydCI6IHsKICogICAgICAgdGVtcGxhdGU6ICI8Y2hhcnRfdGhpbmcvPiIKICogICAgIH0sCiAqICAgICAiZGF0YSI6IHsKICogICAgICAgdGVtcGxhdGU6ICI8ZGF0YV90aGluZy8+IgogKiAgICAgfQogKiAgIH0gICAgCiAqIH0pCiAqIDwvcHJlPgogKgogKiBFeGFtcGxlcyBmb3IgYGF1dG9zY3JvbGxgOgogKgogKiA8cHJlPgogKiA8IS0tIElmIGF1dG9zY3JvbGwgcHJlc2VudCB3aXRoIG5vIGV4cHJlc3Npb24sCiAqICAgICAgdGhlbiBzY3JvbGwgdWktdmlldyBpbnRvIHZpZXcgLS0+CiAqIDx1aS12aWV3IGF1dG9zY3JvbGwvPgogKgogKiA8IS0tIElmIGF1dG9zY3JvbGwgcHJlc2VudCB3aXRoIHZhbGlkIGV4cHJlc3Npb24sCiAqICAgICAgdGhlbiBzY3JvbGwgdWktdmlldyBpbnRvIHZpZXcgaWYgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZSAtLT4KICogPHVpLXZpZXcgYXV0b3Njcm9sbD0ndHJ1ZScvPgogKiA8dWktdmlldyBhdXRvc2Nyb2xsPSdmYWxzZScvPgogKiA8dWktdmlldyBhdXRvc2Nyb2xsPSdzY29wZVZhcmlhYmxlJy8+CiAqIDwvcHJlPgogKi8KJFZpZXdEaXJlY3RpdmUuJGluamVjdCA9IFsnJHN0YXRlJywgJyRpbmplY3RvcicsICckdWlWaWV3U2Nyb2xsJ107CmZ1bmN0aW9uICRWaWV3RGlyZWN0aXZlKCAgICRzdGF0ZSwgICAkaW5qZWN0b3IsICAgJHVpVmlld1Njcm9sbCkgewoKICBmdW5jdGlvbiBnZXRTZXJ2aWNlKCkgewogICAgcmV0dXJuICgkaW5qZWN0b3IuaGFzKSA/IGZ1bmN0aW9uKHNlcnZpY2UpIHsKICAgICAgcmV0dXJuICRpbmplY3Rvci5oYXMoc2VydmljZSkgPyAkaW5qZWN0b3IuZ2V0KHNlcnZpY2UpIDogbnVsbDsKICAgIH0gOiBmdW5jdGlvbihzZXJ2aWNlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuICRpbmplY3Rvci5nZXQoc2VydmljZSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKICB9CgogIHZhciBzZXJ2aWNlID0gZ2V0U2VydmljZSgpLAogICAgICAkYW5pbWF0b3IgPSBzZXJ2aWNlKCckYW5pbWF0b3InKSwKICAgICAgJGFuaW1hdGUgPSBzZXJ2aWNlKCckYW5pbWF0ZScpOwoKICAvLyBSZXR1cm5zIGEgc2V0IG9mIERPTSBtYW5pcHVsYXRpb24gZnVuY3Rpb25zIGJhc2VkIG9uIHdoaWNoIEFuZ3VsYXIgdmVyc2lvbgogIC8vIGl0IHNob3VsZCB1c2UKICBmdW5jdGlvbiBnZXRSZW5kZXJlcihhdHRycywgc2NvcGUpIHsKICAgIHZhciBzdGF0aWNzID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChlbGVtZW50LCB0YXJnZXQsIGNiKSB7IHRhcmdldC5hZnRlcihlbGVtZW50KTsgY2IoKTsgfSwKICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKGVsZW1lbnQsIGNiKSB7IGVsZW1lbnQucmVtb3ZlKCk7IGNiKCk7IH0KICAgICAgfTsKICAgIH07CgogICAgaWYgKCRhbmltYXRlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZW50ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHRhcmdldCwgY2IpIHsgJGFuaW1hdGUuZW50ZXIoZWxlbWVudCwgbnVsbCwgdGFyZ2V0LCBjYik7IH0sCiAgICAgICAgbGVhdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGNiKSB7ICRhbmltYXRlLmxlYXZlKGVsZW1lbnQsIGNiKTsgfQogICAgICB9OwogICAgfQoKICAgIGlmICgkYW5pbWF0b3IpIHsKICAgICAgdmFyIGFuaW1hdGUgPSAkYW5pbWF0b3IgJiYgJGFuaW1hdG9yKHNjb3BlLCBhdHRycyk7CgogICAgICByZXR1cm4gewogICAgICAgIGVudGVyOiBmdW5jdGlvbihlbGVtZW50LCB0YXJnZXQsIGNiKSB7YW5pbWF0ZS5lbnRlcihlbGVtZW50LCBudWxsLCB0YXJnZXQpOyBjYigpOyB9LAogICAgICAgIGxlYXZlOiBmdW5jdGlvbihlbGVtZW50LCBjYikgeyBhbmltYXRlLmxlYXZlKGVsZW1lbnQpOyBjYigpOyB9CiAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIHN0YXRpY3MoKTsKICB9CgogIHZhciBkaXJlY3RpdmUgPSB7CiAgICByZXN0cmljdDogJ0VDQScsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgIHByaW9yaXR5OiA0MDAsCiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICBjb21waWxlOiBmdW5jdGlvbiAodEVsZW1lbnQsIHRBdHRycywgJHRyYW5zY2x1ZGUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgJGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzRWwsIGN1cnJlbnRFbCwgY3VycmVudFNjb3BlLCBsYXRlc3RMb2NhbHMsCiAgICAgICAgICAgIG9ubG9hZEV4cCAgICAgPSBhdHRycy5vbmxvYWQgfHwgJycsCiAgICAgICAgICAgIGF1dG9TY3JvbGxFeHAgPSBhdHRycy5hdXRvc2Nyb2xsLAogICAgICAgICAgICByZW5kZXJlciAgICAgID0gZ2V0UmVuZGVyZXIoYXR0cnMsIHNjb3BlKTsKCiAgICAgICAgc2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1cGRhdGVWaWV3KGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgICBzY29wZS4kb24oJyR2aWV3Q29udGVudExvYWRpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVwZGF0ZVZpZXcoZmFsc2UpOwogICAgICAgIH0pOwoKICAgICAgICB1cGRhdGVWaWV3KHRydWUpOwoKICAgICAgICBmdW5jdGlvbiBjbGVhbnVwTGFzdFZpZXcoKSB7CiAgICAgICAgICBpZiAocHJldmlvdXNFbCkgewogICAgICAgICAgICBwcmV2aW91c0VsLnJlbW92ZSgpOwogICAgICAgICAgICBwcmV2aW91c0VsID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY3VycmVudFNjb3BlKSB7CiAgICAgICAgICAgIGN1cnJlbnRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjdXJyZW50RWwpIHsKICAgICAgICAgICAgcmVuZGVyZXIubGVhdmUoY3VycmVudEVsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBwcmV2aW91c0VsID0gbnVsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBwcmV2aW91c0VsID0gY3VycmVudEVsOwogICAgICAgICAgICBjdXJyZW50RWwgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVmlldyhmaXJzdFRpbWUpIHsKICAgICAgICAgIHZhciBuZXdTY29wZSAgICAgICAgPSBzY29wZS4kbmV3KCksCiAgICAgICAgICAgICAgbmFtZSAgICAgICAgICAgID0gY3VycmVudEVsICYmIGN1cnJlbnRFbC5kYXRhKCckdWlWaWV3TmFtZScpLAogICAgICAgICAgICAgIHByZXZpb3VzTG9jYWxzICA9IG5hbWUgJiYgJHN0YXRlLiRjdXJyZW50ICYmICRzdGF0ZS4kY3VycmVudC5sb2NhbHNbbmFtZV07CgogICAgICAgICAgaWYgKCFmaXJzdFRpbWUgJiYgcHJldmlvdXNMb2NhbHMgPT09IGxhdGVzdExvY2FscykgcmV0dXJuOyAvLyBub3RoaW5nIHRvIGRvCgogICAgICAgICAgdmFyIGNsb25lID0gJHRyYW5zY2x1ZGUobmV3U2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgIHJlbmRlcmVyLmVudGVyKGNsb25lLCAkZWxlbWVudCwgZnVuY3Rpb24gb25VaVZpZXdFbnRlcigpIHsKICAgICAgICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQoYXV0b1Njcm9sbEV4cCkgJiYgIWF1dG9TY3JvbGxFeHAgfHwgc2NvcGUuJGV2YWwoYXV0b1Njcm9sbEV4cCkpIHsKICAgICAgICAgICAgICAgICR1aVZpZXdTY3JvbGwoY2xvbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNsZWFudXBMYXN0VmlldygpOwogICAgICAgICAgfSk7CgogICAgICAgICAgbGF0ZXN0TG9jYWxzID0gJHN0YXRlLiRjdXJyZW50LmxvY2Fsc1tjbG9uZS5kYXRhKCckdWlWaWV3TmFtZScpXTsKCiAgICAgICAgICBjdXJyZW50RWwgPSBjbG9uZTsKICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG5ld1Njb3BlOwogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktdmlldyMkdmlld0NvbnRlbnRMb2FkZWQKICAgICAgICAgICAqIEBldmVudE9mIHVpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktdmlldwogICAgICAgICAgICogQGV2ZW50VHlwZSBlbWl0cyBvbiB1aS12aWV3IGRpcmVjdGl2ZSBzY29wZQogICAgICAgICAgICogQGRlc2NyaXB0aW9uICAgICAgICAgICAqCiAgICAgICAgICAgKiBGaXJlZCBvbmNlIHRoZSB2aWV3IGlzICoqbG9hZGVkKiosICphZnRlciogdGhlIERPTSBpcyByZW5kZXJlZC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50U2NvcGUuJGVtaXQoJyR2aWV3Q29udGVudExvYWRlZCcpOwogICAgICAgICAgY3VycmVudFNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH07CgogIHJldHVybiBkaXJlY3RpdmU7Cn0KCiRWaWV3RGlyZWN0aXZlRmlsbC4kaW5qZWN0ID0gWyckY29tcGlsZScsICckY29udHJvbGxlcicsICckc3RhdGUnXTsKZnVuY3Rpb24gJFZpZXdEaXJlY3RpdmVGaWxsICgkY29tcGlsZSwgJGNvbnRyb2xsZXIsICRzdGF0ZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0VDQScsCiAgICBwcmlvcml0eTogLTQwMCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uICh0RWxlbWVudCkgewogICAgICB2YXIgaW5pdGlhbCA9IHRFbGVtZW50Lmh0bWwoKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgJGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgdmFyIG5hbWUgICAgICA9IGF0dHJzLnVpVmlldyB8fCBhdHRycy5uYW1lIHx8ICcnLAogICAgICAgICAgICBpbmhlcml0ZWQgPSAkZWxlbWVudC5pbmhlcml0ZWREYXRhKCckdWlWaWV3Jyk7CgogICAgICAgIGlmIChuYW1lLmluZGV4T2YoJ0AnKSA8IDApIHsKICAgICAgICAgIG5hbWUgPSBuYW1lICsgJ0AnICsgKGluaGVyaXRlZCA/IGluaGVyaXRlZC5zdGF0ZS5uYW1lIDogJycpOwogICAgICAgIH0KCiAgICAgICAgJGVsZW1lbnQuZGF0YSgnJHVpVmlld05hbWUnLCBuYW1lKTsKCiAgICAgICAgdmFyIGN1cnJlbnQgPSAkc3RhdGUuJGN1cnJlbnQsCiAgICAgICAgICAgIGxvY2FscyAgPSBjdXJyZW50ICYmIGN1cnJlbnQubG9jYWxzW25hbWVdOwoKICAgICAgICBpZiAoISBsb2NhbHMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgICRlbGVtZW50LmRhdGEoJyR1aVZpZXcnLCB7IG5hbWU6IG5hbWUsIHN0YXRlOiBsb2NhbHMuJCRzdGF0ZSB9KTsKICAgICAgICAkZWxlbWVudC5odG1sKGxvY2Fscy4kdGVtcGxhdGUgPyBsb2NhbHMuJHRlbXBsYXRlIDogaW5pdGlhbCk7CgogICAgICAgIHZhciBsaW5rID0gJGNvbXBpbGUoJGVsZW1lbnQuY29udGVudHMoKSk7CgogICAgICAgIGlmIChsb2NhbHMuJCRjb250cm9sbGVyKSB7CiAgICAgICAgICBsb2NhbHMuJHNjb3BlID0gc2NvcGU7CiAgICAgICAgICB2YXIgY29udHJvbGxlciA9ICRjb250cm9sbGVyKGxvY2Fscy4kJGNvbnRyb2xsZXIsIGxvY2Fscyk7CiAgICAgICAgICBpZiAobG9jYWxzLiQkY29udHJvbGxlckFzKSB7CiAgICAgICAgICAgIHNjb3BlW2xvY2Fscy4kJGNvbnRyb2xsZXJBc10gPSBjb250cm9sbGVyOwogICAgICAgICAgfQogICAgICAgICAgJGVsZW1lbnQuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICAgICRlbGVtZW50LmNoaWxkcmVuKCkuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICB9CgogICAgICAgIGxpbmsoc2NvcGUpOwogICAgICB9OwogICAgfQogIH07Cn0KCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnKS5kaXJlY3RpdmUoJ3VpVmlldycsICRWaWV3RGlyZWN0aXZlKTsKYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpLmRpcmVjdGl2ZSgndWlWaWV3JywgJFZpZXdEaXJlY3RpdmVGaWxsKTsKCmZ1bmN0aW9uIHBhcnNlU3RhdGVSZWYocmVmKSB7CiAgdmFyIHBhcnNlZCA9IHJlZi5yZXBsYWNlKC9cbi9nLCAiICIpLm1hdGNoKC9eKFteKF0rPylccyooXCgoLiopXCkpPyQvKTsKICBpZiAoIXBhcnNlZCB8fCBwYXJzZWQubGVuZ3RoICE9PSA0KSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgc3RhdGUgcmVmICciICsgcmVmICsgIiciKTsKICByZXR1cm4geyBzdGF0ZTogcGFyc2VkWzFdLCBwYXJhbUV4cHI6IHBhcnNlZFszXSB8fCBudWxsIH07Cn0KCmZ1bmN0aW9uIHN0YXRlQ29udGV4dChlbCkgewogIHZhciBzdGF0ZURhdGEgPSBlbC5wYXJlbnQoKS5pbmhlcml0ZWREYXRhKCckdWlWaWV3Jyk7CgogIGlmIChzdGF0ZURhdGEgJiYgc3RhdGVEYXRhLnN0YXRlICYmIHN0YXRlRGF0YS5zdGF0ZS5uYW1lKSB7CiAgICByZXR1cm4gc3RhdGVEYXRhLnN0YXRlOwogIH0KfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgdWkucm91dGVyLnN0YXRlLmRpcmVjdGl2ZTp1aS1zcmVmCiAqCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAqIEByZXF1aXJlcyAkdGltZW91dAogKgogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogQSBkaXJlY3RpdmUgdGhhdCBiaW5kcyBhIGxpbmsgKGA8YT5gIHRhZykgdG8gYSBzdGF0ZS4gSWYgdGhlIHN0YXRlIGhhcyBhbiBhc3NvY2lhdGVkIAogKiBVUkwsIHRoZSBkaXJlY3RpdmUgd2lsbCBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlICYgdXBkYXRlIHRoZSBgaHJlZmAgYXR0cmlidXRlIHZpYSAKICogdGhlIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI21ldGhvZHNfaHJlZiAkc3RhdGUuaHJlZigpfSBtZXRob2QuIENsaWNraW5nIAogKiB0aGUgbGluayB3aWxsIHRyaWdnZXIgYSBzdGF0ZSB0cmFuc2l0aW9uIHdpdGggb3B0aW9uYWwgcGFyYW1ldGVycy4gCiAqCiAqIEFsc28gbWlkZGxlLWNsaWNraW5nLCByaWdodC1jbGlja2luZywgYW5kIGN0cmwtY2xpY2tpbmcgb24gdGhlIGxpbmsgd2lsbCBiZSAKICogaGFuZGxlZCBuYXRpdmVseSBieSB0aGUgYnJvd3Nlci4KICoKICogWW91IGNhbiBhbHNvIHVzZSByZWxhdGl2ZSBzdGF0ZSBwYXRocyB3aXRoaW4gdWktc3JlZiwganVzdCBsaWtlIHRoZSByZWxhdGl2ZSAKICogcGF0aHMgcGFzc2VkIHRvIGAkc3RhdGUuZ28oKWAuIFlvdSBqdXN0IG5lZWQgdG8gYmUgYXdhcmUgdGhhdCB0aGUgcGF0aCBpcyByZWxhdGl2ZQogKiB0byB0aGUgc3RhdGUgdGhhdCB0aGUgbGluayBsaXZlcyBpbiwgaW4gb3RoZXIgd29yZHMgdGhlIHN0YXRlIHRoYXQgbG9hZGVkIHRoZSAKICogdGVtcGxhdGUgY29udGFpbmluZyB0aGUgbGluay4KICoKICogWW91IGNhbiBzcGVjaWZ5IG9wdGlvbnMgdG8gcGFzcyB0byB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNnbyAkc3RhdGUuZ28oKX0KICogdXNpbmcgdGhlIGB1aS1zcmVmLW9wdHNgIGF0dHJpYnV0ZS4gT3B0aW9ucyBhcmUgcmVzdHJpY3RlZCB0byBgbG9jYXRpb25gLCBgaW5oZXJpdGAsCiAqIGFuZCBgcmVsb2FkYC4KICoKICogQGV4YW1wbGUKICogSGVyZSdzIGFuIGV4YW1wbGUgb2YgaG93IHlvdSdkIHVzZSB1aS1zcmVmIGFuZCBob3cgaXQgd291bGQgY29tcGlsZS4gSWYgeW91IGhhdmUgdGhlIAogKiBmb2xsb3dpbmcgdGVtcGxhdGU6CiAqIDxwcmU+CiAqIDxhIHVpLXNyZWY9ImhvbWUiPkhvbWU8L2E+IHwgPGEgdWktc3JlZj0iYWJvdXQiPkFib3V0PC9hPgogKiAKICogPHVsPgogKiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAqICAgICAgICAgPGEgdWktc3JlZj0iY29udGFjdHMuZGV0YWlsKHsgaWQ6IGNvbnRhY3QuaWQgfSkiPnt7IGNvbnRhY3QubmFtZSB9fTwvYT4KICogICAgIDwvbGk+CiAqIDwvdWw+CiAqIDwvcHJlPgogKiAKICogVGhlbiB0aGUgY29tcGlsZWQgaHRtbCB3b3VsZCBiZSAoYXNzdW1pbmcgSHRtbDVNb2RlIGlzIG9mZik6CiAqIDxwcmU+CiAqIDxhIGhyZWY9IiMvaG9tZSIgdWktc3JlZj0iaG9tZSI+SG9tZTwvYT4gfCA8YSBocmVmPSIjL2Fib3V0IiB1aS1zcmVmPSJhYm91dCI+QWJvdXQ8L2E+CiAqIAogKiA8dWw+CiAqICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICogICAgICAgICA8YSBocmVmPSIjL2NvbnRhY3RzLzEiIHVpLXNyZWY9ImNvbnRhY3RzLmRldGFpbCh7IGlkOiBjb250YWN0LmlkIH0pIj5Kb2U8L2E+CiAqICAgICA8L2xpPgogKiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAqICAgICAgICAgPGEgaHJlZj0iIy9jb250YWN0cy8yIiB1aS1zcmVmPSJjb250YWN0cy5kZXRhaWwoeyBpZDogY29udGFjdC5pZCB9KSI+QWxpY2U8L2E+CiAqICAgICA8L2xpPgogKiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAqICAgICAgICAgPGEgaHJlZj0iIy9jb250YWN0cy8zIiB1aS1zcmVmPSJjb250YWN0cy5kZXRhaWwoeyBpZDogY29udGFjdC5pZCB9KSI+Qm9iPC9hPgogKiAgICAgPC9saT4KICogPC91bD4KICoKICogPGEgdWktc3JlZj0iaG9tZSIgdWktc3JlZi1vcHRzPSJ7cmVsb2FkOiB0cnVlfSI+SG9tZTwvYT4KICogPC9wcmU+CiAqCiAqIEBwYXJhbSB7c3RyaW5nfSB1aS1zcmVmICdzdGF0ZU5hbWUnIGNhbiBiZSBhbnkgdmFsaWQgYWJzb2x1dGUgb3IgcmVsYXRpdmUgc3RhdGUKICogQHBhcmFtIHtPYmplY3R9IHVpLXNyZWYtb3B0cyBvcHRpb25zIHRvIHBhc3MgdG8ge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjZ28gJHN0YXRlLmdvKCl9CiAqLwokU3RhdGVSZWZEaXJlY3RpdmUuJGluamVjdCA9IFsnJHN0YXRlJywgJyR0aW1lb3V0J107CmZ1bmN0aW9uICRTdGF0ZVJlZkRpcmVjdGl2ZSgkc3RhdGUsICR0aW1lb3V0KSB7CiAgdmFyIGFsbG93ZWRPcHRpb25zID0gWydsb2NhdGlvbicsICdpbmhlcml0JywgJ3JlbG9hZCddOwoKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIHJlcXVpcmU6ICc/XnVpU3JlZkFjdGl2ZScsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIHVpU3JlZkFjdGl2ZSkgewogICAgICB2YXIgcmVmID0gcGFyc2VTdGF0ZVJlZihhdHRycy51aVNyZWYpOwogICAgICB2YXIgcGFyYW1zID0gbnVsbCwgdXJsID0gbnVsbCwgYmFzZSA9IHN0YXRlQ29udGV4dChlbGVtZW50KSB8fCAkc3RhdGUuJGN1cnJlbnQ7CiAgICAgIHZhciBpc0Zvcm0gPSBlbGVtZW50WzBdLm5vZGVOYW1lID09PSAiRk9STSI7CiAgICAgIHZhciBhdHRyID0gaXNGb3JtID8gImFjdGlvbiIgOiAiaHJlZiIsIG5hdiA9IHRydWU7CgogICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICByZWxhdGl2ZTogYmFzZQogICAgICB9OwogICAgICB2YXIgb3B0aW9uc092ZXJyaWRlID0gc2NvcGUuJGV2YWwoYXR0cnMudWlTcmVmT3B0cykgfHwge307CiAgICAgIGFuZ3VsYXIuZm9yRWFjaChhbGxvd2VkT3B0aW9ucywgZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgaWYgKG9wdGlvbiBpbiBvcHRpb25zT3ZlcnJpZGUpIHsKICAgICAgICAgIG9wdGlvbnNbb3B0aW9uXSA9IG9wdGlvbnNPdmVycmlkZVtvcHRpb25dOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICB2YXIgdXBkYXRlID0gZnVuY3Rpb24obmV3VmFsKSB7CiAgICAgICAgaWYgKG5ld1ZhbCkgcGFyYW1zID0gbmV3VmFsOwogICAgICAgIGlmICghbmF2KSByZXR1cm47CgogICAgICAgIHZhciBuZXdIcmVmID0gJHN0YXRlLmhyZWYocmVmLnN0YXRlLCBwYXJhbXMsIG9wdGlvbnMpOwoKICAgICAgICBpZiAodWlTcmVmQWN0aXZlKSB7CiAgICAgICAgICB1aVNyZWZBY3RpdmUuJCRzZXRTdGF0ZUluZm8ocmVmLnN0YXRlLCBwYXJhbXMpOwogICAgICAgIH0KICAgICAgICBpZiAoIW5ld0hyZWYpIHsKICAgICAgICAgIG5hdiA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbGVtZW50WzBdW2F0dHJdID0gbmV3SHJlZjsKICAgICAgfTsKCiAgICAgIGlmIChyZWYucGFyYW1FeHByKSB7CiAgICAgICAgc2NvcGUuJHdhdGNoKHJlZi5wYXJhbUV4cHIsIGZ1bmN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICBpZiAobmV3VmFsICE9PSBwYXJhbXMpIHVwZGF0ZShuZXdWYWwpOwogICAgICAgIH0sIHRydWUpOwogICAgICAgIHBhcmFtcyA9IHNjb3BlLiRldmFsKHJlZi5wYXJhbUV4cHIpOwogICAgICB9CiAgICAgIHVwZGF0ZSgpOwoKICAgICAgaWYgKGlzRm9ybSkgcmV0dXJuOwoKICAgICAgZWxlbWVudC5iaW5kKCJjbGljayIsIGZ1bmN0aW9uKGUpIHsKICAgICAgICB2YXIgYnV0dG9uID0gZS53aGljaCB8fCBlLmJ1dHRvbjsKICAgICAgICBpZiAoICEoYnV0dG9uID4gMSB8fCBlLmN0cmxLZXkgfHwgZS5tZXRhS2V5IHx8IGUuc2hpZnRLZXkgfHwgZWxlbWVudC5hdHRyKCd0YXJnZXQnKSkgKSB7CiAgICAgICAgICAvLyBIQUNLOiBUaGlzIGlzIHRvIGFsbG93IG5nLWNsaWNrcyB0byBiZSBwcm9jZXNzZWQgYmVmb3JlIHRoZSB0cmFuc2l0aW9uIGlzIGluaXRpYXRlZDoKICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkc3RhdGUuZ28ocmVmLnN0YXRlLCBwYXJhbXMsIG9wdGlvbnMpOwogICAgICAgICAgfSk7CiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9Owp9CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXNyZWYtYWN0aXZlCiAqCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUGFyYW1zCiAqIEByZXF1aXJlcyAkaW50ZXJwb2xhdGUKICoKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgZGlyZWN0aXZlIHdvcmtpbmcgYWxvbmdzaWRlIHVpLXNyZWYgdG8gYWRkIGNsYXNzZXMgdG8gYW4gZWxlbWVudCB3aGVuIHRoZSAKICogcmVsYXRlZCB1aS1zcmVmIGRpcmVjdGl2ZSdzIHN0YXRlIGlzIGFjdGl2ZSwgYW5kIHJlbW92aW5nIHRoZW0gd2hlbiBpdCBpcyBpbmFjdGl2ZS4KICogVGhlIHByaW1hcnkgdXNlLWNhc2UgaXMgdG8gc2ltcGxpZnkgdGhlIHNwZWNpYWwgYXBwZWFyYW5jZSBvZiBuYXZpZ2F0aW9uIG1lbnVzIAogKiByZWx5aW5nIG9uIGB1aS1zcmVmYCwgYnkgaGF2aW5nIHRoZSAiYWN0aXZlIiBzdGF0ZSdzIG1lbnUgYnV0dG9uIGFwcGVhciBkaWZmZXJlbnQsCiAqIGRpc3Rpbmd1aXNoaW5nIGl0IGZyb20gdGhlIGluYWN0aXZlIG1lbnUgaXRlbXMuCiAqCiAqIEBleGFtcGxlCiAqIEdpdmVuIHRoZSBmb2xsb3dpbmcgdGVtcGxhdGU6CiAqIDxwcmU+CiAqIDx1bD4KICogICA8bGkgdWktc3JlZi1hY3RpdmU9ImFjdGl2ZSIgY2xhc3M9Iml0ZW0iPgogKiAgICAgPGEgaHJlZiB1aS1zcmVmPSJhcHAudXNlcih7dXNlcjogJ2JpbGJvYmFnZ2lucyd9KSI+QGJpbGJvYmFnZ2luczwvYT4KICogICA8L2xpPgogKiA8L3VsPgogKiA8L3ByZT4KICogCiAqIFdoZW4gdGhlIGFwcCBzdGF0ZSBpcyAiYXBwLnVzZXIiLCBhbmQgY29udGFpbnMgdGhlIHN0YXRlIHBhcmFtZXRlciAidXNlciIgd2l0aCB2YWx1ZSAiYmlsYm9iYWdnaW5zIiwgCiAqIHRoZSByZXN1bHRpbmcgSFRNTCB3aWxsIGFwcGVhciBhcyAobm90ZSB0aGUgJ2FjdGl2ZScgY2xhc3MpOgogKiA8cHJlPgogKiA8dWw+CiAqICAgPGxpIHVpLXNyZWYtYWN0aXZlPSJhY3RpdmUiIGNsYXNzPSJpdGVtIGFjdGl2ZSI+CiAqICAgICA8YSB1aS1zcmVmPSJhcHAudXNlcih7dXNlcjogJ2JpbGJvYmFnZ2lucyd9KSIgaHJlZj0iL3VzZXJzL2JpbGJvYmFnZ2lucyI+QGJpbGJvYmFnZ2luczwvYT4KICogICA8L2xpPgogKiA8L3VsPgogKiA8L3ByZT4KICogCiAqIFRoZSBjbGFzcyBuYW1lIGlzIGludGVycG9sYXRlZCAqKm9uY2UqKiBkdXJpbmcgdGhlIGRpcmVjdGl2ZXMgbGluayB0aW1lIChhbnkgZnVydGhlciBjaGFuZ2VzIHRvIHRoZSAKICogaW50ZXJwb2xhdGVkIHZhbHVlIGFyZSBpZ25vcmVkKS4gCiAqIAogKiBNdWx0aXBsZSBjbGFzc2VzIG1heSBiZSBzcGVjaWZpZWQgaW4gYSBzcGFjZS1zZXBhcmF0ZWQgZm9ybWF0OgogKiA8cHJlPgogKiA8dWw+CiAqICAgPGxpIHVpLXNyZWYtYWN0aXZlPSdjbGFzczEgY2xhc3MyIGNsYXNzMyc+CiAqICAgICA8YSB1aS1zcmVmPSJhcHAudXNlciI+bGluazwvYT4KICogICA8L2xpPgogKiA8L3VsPgogKiA8L3ByZT4KICovCiRTdGF0ZUFjdGl2ZURpcmVjdGl2ZS4kaW5qZWN0ID0gWyckc3RhdGUnLCAnJHN0YXRlUGFyYW1zJywgJyRpbnRlcnBvbGF0ZSddOwpmdW5jdGlvbiAkU3RhdGVBY3RpdmVEaXJlY3RpdmUoJHN0YXRlLCAkc3RhdGVQYXJhbXMsICRpbnRlcnBvbGF0ZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogIkEiLAogICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCAnJGF0dHJzJywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgIHZhciBzdGF0ZSwgcGFyYW1zLCBhY3RpdmVDbGFzczsKCiAgICAgIC8vIFRoZXJlIHByb2JhYmx5IGlzbid0IG11Y2ggcG9pbnQgaW4gJG9ic2VydmluZyB0aGlzCiAgICAgIGFjdGl2ZUNsYXNzID0gJGludGVycG9sYXRlKCRhdHRycy51aVNyZWZBY3RpdmUgfHwgJycsIGZhbHNlKSgkc2NvcGUpOwoKICAgICAgLy8gQWxsb3cgdWlTcmVmIHRvIGNvbW11bmljYXRlIHdpdGggdWlTcmVmQWN0aXZlCiAgICAgIHRoaXMuJCRzZXRTdGF0ZUluZm8gPSBmdW5jdGlvbihuZXdTdGF0ZSwgbmV3UGFyYW1zKSB7CiAgICAgICAgc3RhdGUgPSAkc3RhdGUuZ2V0KG5ld1N0YXRlLCBzdGF0ZUNvbnRleHQoJGVsZW1lbnQpKTsKICAgICAgICBwYXJhbXMgPSBuZXdQYXJhbXM7CiAgICAgICAgdXBkYXRlKCk7CiAgICAgIH07CgogICAgICAkc2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgdXBkYXRlKTsKCiAgICAgIC8vIFVwZGF0ZSByb3V0ZSBzdGF0ZQogICAgICBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgICAgICAgaWYgKCRzdGF0ZS4kY3VycmVudC5zZWxmID09PSBzdGF0ZSAmJiBtYXRjaGVzUGFyYW1zKCkpIHsKICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGFjdGl2ZUNsYXNzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3MpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gbWF0Y2hlc1BhcmFtcygpIHsKICAgICAgICByZXR1cm4gIXBhcmFtcyB8fCBlcXVhbEZvcktleXMocGFyYW1zLCAkc3RhdGVQYXJhbXMpOwogICAgICB9CiAgICB9XQogIH07Cn0KCmFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnKQogIC5kaXJlY3RpdmUoJ3VpU3JlZicsICRTdGF0ZVJlZkRpcmVjdGl2ZSkKICAuZGlyZWN0aXZlKCd1aVNyZWZBY3RpdmUnLCAkU3RhdGVBY3RpdmVEaXJlY3RpdmUpOwoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgdWkucm91dGVyLnN0YXRlLmZpbHRlcjppc1N0YXRlCiAqCiAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUcmFuc2xhdGVzIHRvIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI21ldGhvZHNfaXMgJHN0YXRlLmlzKCJzdGF0ZU5hbWUiKX0uCiAqLwokSXNTdGF0ZUZpbHRlci4kaW5qZWN0ID0gWyckc3RhdGUnXTsKZnVuY3Rpb24gJElzU3RhdGVGaWx0ZXIoJHN0YXRlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHN0YXRlKSB7CiAgICByZXR1cm4gJHN0YXRlLmlzKHN0YXRlKTsKICB9Owp9CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZmlsdGVyOmluY2x1ZGVkQnlTdGF0ZQogKgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogVHJhbnNsYXRlcyB0byB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2luY2x1ZGVzICRzdGF0ZS5pbmNsdWRlcygnZnVsbE9yUGFydGlhbFN0YXRlTmFtZScpfS4KICovCiRJbmNsdWRlZEJ5U3RhdGVGaWx0ZXIuJGluamVjdCA9IFsnJHN0YXRlJ107CmZ1bmN0aW9uICRJbmNsdWRlZEJ5U3RhdGVGaWx0ZXIoJHN0YXRlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHN0YXRlKSB7CiAgICByZXR1cm4gJHN0YXRlLmluY2x1ZGVzKHN0YXRlKTsKICB9Owp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykKICAuZmlsdGVyKCdpc1N0YXRlJywgJElzU3RhdGVGaWx0ZXIpCiAgLmZpbHRlcignaW5jbHVkZWRCeVN0YXRlJywgJEluY2x1ZGVkQnlTdGF0ZUZpbHRlcik7CgovKgogKiBAbmdkb2Mgb2JqZWN0CiAqIEBuYW1lIHVpLnJvdXRlci5jb21wYXQuJHJvdXRlUHJvdmlkZXIKICoKICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlcgogKiBAcmVxdWlyZXMgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIGAkcm91dGVQcm92aWRlcmAgb2YgdGhlIGB1aS5yb3V0ZXIuY29tcGF0YCBtb2R1bGUgb3ZlcndyaXRlcyB0aGUgZXhpc3RpbmcKICogYHJvdXRlUHJvdmlkZXJgIGZyb20gdGhlIGNvcmUuIFRoaXMgaXMgZG9uZSB0byBwcm92aWRlIGNvbXBhdGliaWxpdHkgYmV0d2VlbgogKiB0aGUgVUkgUm91dGVyIGFuZCB0aGUgY29yZSByb3V0ZXIuCiAqCiAqIEl0IGFsc28gcHJvdmlkZXMgYSBgd2hlbigpYCBtZXRob2QgdG8gcmVnaXN0ZXIgcm91dGVzIHRoYXQgbWFwIHRvIGNlcnRhaW4gdXJscy4KICogQmVoaW5kIHRoZSBzY2VuZXMgaXQgYWN0dWFsbHkgZGVsZWdhdGVzIGVpdGhlciB0byAKICoge0BsaW5rIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyICR1cmxSb3V0ZXJQcm92aWRlcn0gb3IgdG8gdGhlIAogKiB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyICRzdGF0ZVByb3ZpZGVyfSB0byBwb3N0cHJvY2VzcyB0aGUgZ2l2ZW4gCiAqIHJvdXRlciBkZWZpbml0aW9uIG9iamVjdC4KICovCiRSb3V0ZVByb3ZpZGVyLiRpbmplY3QgPSBbJyRzdGF0ZVByb3ZpZGVyJywgJyR1cmxSb3V0ZXJQcm92aWRlciddOwpmdW5jdGlvbiAkUm91dGVQcm92aWRlciggICRzdGF0ZVByb3ZpZGVyLCAgICAkdXJsUm91dGVyUHJvdmlkZXIpIHsKCiAgdmFyIHJvdXRlcyA9IFtdOwoKICBvbkVudGVyUm91dGUuJGluamVjdCA9IFsnJCRzdGF0ZSddOwogIGZ1bmN0aW9uIG9uRW50ZXJSb3V0ZSggICAkJHN0YXRlKSB7CiAgICAvKmpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgIHRoaXMubG9jYWxzID0gJCRzdGF0ZS5sb2NhbHMuZ2xvYmFsczsKICAgIHRoaXMucGFyYW1zID0gdGhpcy5sb2NhbHMuJHN0YXRlUGFyYW1zOwogIH0KCiAgZnVuY3Rpb24gb25FeGl0Um91dGUoKSB7CiAgICAvKmpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgIHRoaXMubG9jYWxzID0gbnVsbDsKICAgIHRoaXMucGFyYW1zID0gbnVsbDsKICB9CgogIHRoaXMud2hlbiA9IHdoZW47CiAgLyoKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIuY29tcGF0LiRyb3V0ZVByb3ZpZGVyI3doZW4KICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLmNvbXBhdC4kcm91dGVQcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVnaXN0ZXJzIGEgcm91dGUgd2l0aCBhIGdpdmVuIHJvdXRlIGRlZmluaXRpb24gb2JqZWN0LiBUaGUgcm91dGUgZGVmaW5pdGlvbgogICAqIG9iamVjdCBoYXMgdGhlIHNhbWUgaW50ZXJmYWNlIHRoZSBhbmd1bGFyIGNvcmUgcm91dGUgZGVmaW5pdGlvbiBvYmplY3QgaGFzLgogICAqIAogICAqIEBleGFtcGxlCiAgICogPHByZT4KICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyLmNvbXBhdCddKTsKICAgKgogICAqIGFwcC5jb25maWcoZnVuY3Rpb24gKCRyb3V0ZVByb3ZpZGVyKSB7CiAgICogICAkcm91dGVQcm92aWRlci53aGVuKCdob21lJywgewogICAqICAgICBjb250cm9sbGVyOiBmdW5jdGlvbiAoKSB7IC4uLiB9LAogICAqICAgICB0ZW1wbGF0ZVVybDogJ3BhdGgvdG8vdGVtcGxhdGUnCiAgICogICB9KTsKICAgKiB9KTsKICAgKiA8L3ByZT4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVVJMIGFzIHN0cmluZwogICAqIEBwYXJhbSB7b2JqZWN0fSByb3V0ZSBSb3V0ZSBkZWZpbml0aW9uIG9iamVjdAogICAqCiAgICogQHJldHVybiB7b2JqZWN0fSAkcm91dGVQcm92aWRlciAtICRyb3V0ZVByb3ZpZGVyIGluc3RhbmNlCiAgICovCiAgZnVuY3Rpb24gd2hlbih1cmwsIHJvdXRlKSB7CiAgICAvKmpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgIGlmIChyb3V0ZS5yZWRpcmVjdFRvICE9IG51bGwpIHsKICAgICAgLy8gUmVkaXJlY3QsIGNvbmZpZ3VyZSBkaXJlY3RseSBvbiAkdXJsUm91dGVyUHJvdmlkZXIKICAgICAgdmFyIHJlZGlyZWN0ID0gcm91dGUucmVkaXJlY3RUbywgaGFuZGxlcjsKICAgICAgaWYgKGlzU3RyaW5nKHJlZGlyZWN0KSkgewogICAgICAgIGhhbmRsZXIgPSByZWRpcmVjdDsgLy8gbGVhdmUgJHVybFJvdXRlclByb3ZpZGVyIHRvIGhhbmRsZQogICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24ocmVkaXJlY3QpKSB7CiAgICAgICAgLy8gQWRhcHQgdG8gJHVybFJvdXRlclByb3ZpZGVyIEFQSQogICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbiAocGFyYW1zLCAkbG9jYXRpb24pIHsKICAgICAgICAgIHJldHVybiByZWRpcmVjdChwYXJhbXMsICRsb2NhdGlvbi5wYXRoKCksICRsb2NhdGlvbi5zZWFyY2goKSk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgJ3JlZGlyZWN0VG8nIGluIHdoZW4oKSIpOwogICAgICB9CiAgICAgICR1cmxSb3V0ZXJQcm92aWRlci53aGVuKHVybCwgaGFuZGxlcik7CiAgICB9IGVsc2UgewogICAgICAvLyBSZWd1bGFyIHJvdXRlLCBjb25maWd1cmUgYXMgc3RhdGUKICAgICAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoaW5oZXJpdChyb3V0ZSwgewogICAgICAgIHBhcmVudDogbnVsbCwKICAgICAgICBuYW1lOiAncm91dGU6JyArIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpLAogICAgICAgIHVybDogdXJsLAogICAgICAgIG9uRW50ZXI6IG9uRW50ZXJSb3V0ZSwKICAgICAgICBvbkV4aXQ6IG9uRXhpdFJvdXRlCiAgICAgIH0pKTsKICAgIH0KICAgIHJvdXRlcy5wdXNoKHJvdXRlKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLyoKICAgKiBAbmdkb2Mgb2JqZWN0CiAgICogQG5hbWUgdWkucm91dGVyLmNvbXBhdC4kcm91dGUKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgKiBAcmVxdWlyZXMgJHJvdXRlUGFyYW1zCiAgICoKICAgKiBAcHJvcGVydHkge29iamVjdH0gcm91dGVzIC0gQXJyYXkgb2YgcmVnaXN0ZXJlZCByb3V0ZXMuCiAgICogQHByb3BlcnR5IHtvYmplY3R9IHBhcmFtcyAtIEN1cnJlbnQgcm91dGUgcGFyYW1zIGFzIG9iamVjdC4KICAgKiBAcHJvcGVydHkge3N0cmluZ30gY3VycmVudCAtIE5hbWUgb2YgdGhlIGN1cnJlbnQgcm91dGUuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYCRyb3V0ZWAgc2VydmljZSBwcm92aWRlcyBpbnRlcmZhY2VzIHRvIGFjY2VzcyBkZWZpbmVkIHJvdXRlcy4gSXQgYWxzbyBsZXQncwogICAqIHlvdSBhY2Nlc3Mgcm91dGUgcGFyYW1zIHRocm91Z2ggYCRyb3V0ZVBhcmFtc2Agc2VydmljZSwgc28geW91IGhhdmUgZnVsbHkKICAgKiBjb250cm9sIG92ZXIgYWxsIHRoZSBzdHVmZiB5b3Ugd291bGQgYWN0dWFsbHkgZ2V0IGZyb20gYW5ndWxhcidzIGNvcmUgYCRyb3V0ZWAKICAgKiBzZXJ2aWNlLgogICAqLwogIHRoaXMuJGdldCA9ICRnZXQ7CiAgJGdldC4kaW5qZWN0ID0gWyckc3RhdGUnLCAnJHJvb3RTY29wZScsICckcm91dGVQYXJhbXMnXTsKICBmdW5jdGlvbiAkZ2V0KCAgICRzdGF0ZSwgICAkcm9vdFNjb3BlLCAgICRyb3V0ZVBhcmFtcykgewoKICAgIHZhciAkcm91dGUgPSB7CiAgICAgIHJvdXRlczogcm91dGVzLAogICAgICBwYXJhbXM6ICRyb3V0ZVBhcmFtcywKICAgICAgY3VycmVudDogdW5kZWZpbmVkCiAgICB9OwoKICAgIGZ1bmN0aW9uIHN0YXRlQXNSb3V0ZShzdGF0ZSkgewogICAgICByZXR1cm4gKHN0YXRlLm5hbWUgIT09ICcnKSA/IHN0YXRlIDogdW5kZWZpbmVkOwogICAgfQoKICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdGFydCcsIGZ1bmN0aW9uIChldiwgdG8sIHRvUGFyYW1zLCBmcm9tLCBmcm9tUGFyYW1zKSB7CiAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlU3RhcnQnLCBzdGF0ZUFzUm91dGUodG8pLCBzdGF0ZUFzUm91dGUoZnJvbSkpOwogICAgfSk7CgogICAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbiAoZXYsIHRvLCB0b1BhcmFtcywgZnJvbSwgZnJvbVBhcmFtcykgewogICAgICAkcm91dGUuY3VycmVudCA9IHN0YXRlQXNSb3V0ZSh0byk7CiAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlU3VjY2VzcycsIHN0YXRlQXNSb3V0ZSh0byksIHN0YXRlQXNSb3V0ZShmcm9tKSk7CiAgICAgIGNvcHkodG9QYXJhbXMsICRyb3V0ZS5wYXJhbXMpOwogICAgfSk7CgogICAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZUVycm9yJywgZnVuY3Rpb24gKGV2LCB0bywgdG9QYXJhbXMsIGZyb20sIGZyb21QYXJhbXMsIGVycm9yKSB7CiAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlRXJyb3InLCBzdGF0ZUFzUm91dGUodG8pLCBzdGF0ZUFzUm91dGUoZnJvbSksIGVycm9yKTsKICAgIH0pOwoKICAgIHJldHVybiAkcm91dGU7CiAgfQp9Cgphbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLmNvbXBhdCcpCiAgLnByb3ZpZGVyKCckcm91dGUnLCAkUm91dGVQcm92aWRlcikKICAuZGlyZWN0aXZlKCduZ1ZpZXcnLCAkVmlld0RpcmVjdGl2ZSk7Cn0pKHdpbmRvdywgd2luZG93LmFuZ3VsYXIpOwovKiEKICogaW9uaWMuYnVuZGxlLmpzIGlzIGEgY29uY2F0ZW5hdGlvbiBvZjoKICogaW9uaWMuanMsIGFuZ3VsYXIuanMsIGFuZ3VsYXItYW5pbWF0ZS5qcywKICogYW5ndWxhci1zYW5pdGl6ZS5qcywgYW5ndWxhci11aS1yb3V0ZXIuanMsCiAqIGFuZCBpb25pYy1hbmd1bGFyLmpzCiAqLwoKLyohCiAqIENvcHlyaWdodCAyMDE0IERyaWZ0eSBDby4KICogaHR0cDovL2RyaWZ0eS5jb20vCiAqCiAqIElvbmljLCB2MS4wLjAtYmV0YS4xMgogKiBBIHBvd2VyZnVsIEhUTUw1IG1vYmlsZSBhcHAgZnJhbWV3b3JrLgogKiBodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tLwogKgogKiBCeSBAbWF4bHluY2gsIEBiZW5qc3BlcnJ5LCBAYWRhbWRicmFkbGV5IDwzCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4gUGxlYXNlIHNlZSBMSUNFTlNFIGZvciBtb3JlIGluZm9ybWF0aW9uLgogKgogKi8KCihmdW5jdGlvbigpIHsKLyoKICogZGVwcmVjYXRlZC5qcwogKiBodHRwczovL2dpdGh1Yi5jb20vd2VhcmVmcmFjdGFsL2RlcHJlY2F0ZWQvCiAqIENvcHlyaWdodCAoYykgMjAxNCBGcmFjdGFsIDxjb250YWN0QHdlYXJlZnJhY3RhbC5jb20+CiAqIExpY2Vuc2UgTUlUCiAqLwovL0ludGVydmFsIG9iamVjdAp2YXIgZGVwcmVjYXRlZCA9IHsKICBtZXRob2Q6IGZ1bmN0aW9uKG1zZywgbG9nLCBmbikgewogICAgdmFyIGNhbGxlZCA9IGZhbHNlOwogICAgcmV0dXJuIGZ1bmN0aW9uIGRlcHJlY2F0ZWRNZXRob2QoKXsKICAgICAgaWYgKCFjYWxsZWQpIHsKICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgIGxvZyhtc2cpOwogICAgICB9CiAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9LAoKICBmaWVsZDogZnVuY3Rpb24obXNnLCBsb2csIHBhcmVudCwgZmllbGQsIHZhbCkgewogICAgdmFyIGNhbGxlZCA9IGZhbHNlOwogICAgdmFyIGdldHRlciA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICBsb2cobXNnKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsOwogICAgfTsKICAgIHZhciBzZXR0ZXIgPSBmdW5jdGlvbih2KSB7CiAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICBsb2cobXNnKTsKICAgICAgfQogICAgICB2YWwgPSB2OwogICAgICByZXR1cm4gdjsKICAgIH07CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocGFyZW50LCBmaWVsZCwgewogICAgICBnZXQ6IGdldHRlciwKICAgICAgc2V0OiBzZXR0ZXIsCiAgICAgIGVudW1lcmFibGU6IHRydWUKICAgIH0pOwogICAgcmV0dXJuOwogIH0KfTsKCgp2YXIgSW9uaWNNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnaW9uaWMnLCBbJ25nQW5pbWF0ZScsICduZ1Nhbml0aXplJywgJ3VpLnJvdXRlciddKSwKICBleHRlbmQgPSBhbmd1bGFyLmV4dGVuZCwKICBmb3JFYWNoID0gYW5ndWxhci5mb3JFYWNoLAogIGlzRGVmaW5lZCA9IGFuZ3VsYXIuaXNEZWZpbmVkLAogIGlzU3RyaW5nID0gYW5ndWxhci5pc1N0cmluZywKICBqcUxpdGUgPSBhbmd1bGFyLmVsZW1lbnQ7CgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY0FjdGlvblNoZWV0CiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBBY3Rpb24gU2hlZXQgaXMgYSBzbGlkZS11cCBwYW5lIHRoYXQgbGV0cyB0aGUgdXNlciBjaG9vc2UgZnJvbSBhIHNldCBvZiBvcHRpb25zLgogKiBEYW5nZXJvdXMgb3B0aW9ucyBhcmUgaGlnaGxpZ2h0ZWQgaW4gcmVkIGFuZCBtYWRlIG9idmlvdXMuCiAqCiAqIFRoZXJlIGFyZSBlYXN5IHdheXMgdG8gY2FuY2VsIG91dCBvZiB0aGUgYWN0aW9uIHNoZWV0LCBzdWNoIGFzIHRhcHBpbmcgdGhlIGJhY2tkcm9wIG9yIGV2ZW4KICogaGl0dGluZyBlc2NhcGUgb24gdGhlIGtleWJvYXJkIGZvciBkZXNrdG9wIHRlc3RpbmcuCiAqCiAqICFbQWN0aW9uIFNoZWV0XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tLnMzLmFtYXpvbmF3cy5jb20vZG9jcy9jb250cm9sbGVycy9hY3Rpb25TaGVldC5naWYpCiAqCiAqIEB1c2FnZQogKiBUbyB0cmlnZ2VyIGFuIEFjdGlvbiBTaGVldCBpbiB5b3VyIGNvZGUsIHVzZSB0aGUgJGlvbmljQWN0aW9uU2hlZXQgc2VydmljZSBpbiB5b3VyIGFuZ3VsYXIgY29udHJvbGxlcnM6CiAqCiAqIGBgYGpzCiAqIGFuZ3VsYXIubW9kdWxlKCdteVN1cGVyQXBwJywgWydpb25pYyddKQogKiAuY29udHJvbGxlcihmdW5jdGlvbigkc2NvcGUsICRpb25pY0FjdGlvblNoZWV0LCAkdGltZW91dCkgewogKgogKiAgLy8gVHJpZ2dlcmVkIG9uIGEgYnV0dG9uIGNsaWNrLCBvciBzb21lIG90aGVyIHRhcmdldAogKiAgJHNjb3BlLnNob3cgPSBmdW5jdGlvbigpIHsKICoKICogICAgLy8gU2hvdyB0aGUgYWN0aW9uIHNoZWV0CiAqICAgIHZhciBoaWRlU2hlZXQgPSAkaW9uaWNBY3Rpb25TaGVldC5zaG93KHsKICogICAgICBidXR0b25zOiBbCiAqICAgICAgICB7IHRleHQ6ICc8Yj5TaGFyZTwvYj4gVGhpcycgfSwKICogICAgICAgIHsgdGV4dDogJ01vdmUnIH0KICogICAgICBdLAogKiAgICAgIGRlc3RydWN0aXZlVGV4dDogJ0RlbGV0ZScsCiAqICAgICAgdGl0bGVUZXh0OiAnTW9kaWZ5IHlvdXIgYWxidW0nLAogKiAgICAgIGNhbmNlbFRleHQ6ICdDYW5jZWwnLAogKiAgICAgIGNhbmNlbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBhZGQgY2FuY2VsIGNvZGUuLgogICAgICAgIH0sCiAqICAgICAgYnV0dG9uQ2xpY2tlZDogZnVuY3Rpb24oaW5kZXgpIHsKICogICAgICAgIHJldHVybiB0cnVlOwogKiAgICAgIH0KICogICAgfSk7CiAqCiAqICAgIC8vIEZvciBleGFtcGxlJ3Mgc2FrZSwgaGlkZSB0aGUgc2hlZXQgYWZ0ZXIgdHdvIHNlY29uZHMKICogICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgICAgaGlkZVNoZWV0KCk7CiAqICAgIH0sIDIwMDApOwogKgogKiAgfTsKICogfSk7CiAqIGBgYAogKgogKi8KSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY0FjdGlvblNoZWV0JywgWwogICckcm9vdFNjb3BlJywKICAnJGNvbXBpbGUnLAogICckYW5pbWF0ZScsCiAgJyR0aW1lb3V0JywKICAnJGlvbmljVGVtcGxhdGVMb2FkZXInLAogICckaW9uaWNQbGF0Zm9ybScsCiAgJyRpb25pY0JvZHknLApmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGFuaW1hdGUsICR0aW1lb3V0LCAkaW9uaWNUZW1wbGF0ZUxvYWRlciwgJGlvbmljUGxhdGZvcm0sICRpb25pY0JvZHkpIHsKCiAgcmV0dXJuIHsKICAgIHNob3c6IGFjdGlvblNoZWV0CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY0FjdGlvblNoZWV0I3Nob3cKICAgKiBAZGVzY3JpcHRpb24KICAgKiBMb2FkIGFuZCByZXR1cm4gYSBuZXcgYWN0aW9uIHNoZWV0LgogICAqCiAgICogQSBuZXcgaXNvbGF0ZWQgc2NvcGUgd2lsbCBiZSBjcmVhdGVkIGZvciB0aGUKICAgKiBhY3Rpb24gc2hlZXQgYW5kIHRoZSBuZXcgZWxlbWVudCB3aWxsIGJlIGFwcGVuZGVkIGludG8gdGhlIGJvZHkuCiAgICoKICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBmb3IgdGhpcyBBY3Rpb25TaGVldC4gUHJvcGVydGllczoKICAgKgogICAqICAtIGBbT2JqZWN0XWAgYGJ1dHRvbnNgIFdoaWNoIGJ1dHRvbnMgdG8gc2hvdy4gIEVhY2ggYnV0dG9uIGlzIGFuIG9iamVjdCB3aXRoIGEgYHRleHRgIGZpZWxkLgogICAqICAtIGB7c3RyaW5nfWAgYHRpdGxlVGV4dGAgVGhlIHRpdGxlIHRvIHNob3cgb24gdGhlIGFjdGlvbiBzaGVldC4KICAgKiAgLSBge3N0cmluZz19YCBgY2FuY2VsVGV4dGAgdGhlIHRleHQgZm9yIGEgJ2NhbmNlbCcgYnV0dG9uIG9uIHRoZSBhY3Rpb24gc2hlZXQuCiAgICogIC0gYHtzdHJpbmc9fWAgYGRlc3RydWN0aXZlVGV4dGAgVGhlIHRleHQgZm9yIGEgJ2Rhbmdlcicgb24gdGhlIGFjdGlvbiBzaGVldC4KICAgKiAgLSBge2Z1bmN0aW9uPX1gIGBjYW5jZWxgIENhbGxlZCBpZiB0aGUgY2FuY2VsIGJ1dHRvbiBpcyBwcmVzc2VkLCB0aGUgYmFja2Ryb3AgaXMgdGFwcGVkIG9yCiAgICogICAgIHRoZSBoYXJkd2FyZSBiYWNrIGJ1dHRvbiBpcyBwcmVzc2VkLgogICAqICAtIGB7ZnVuY3Rpb249fWAgYGJ1dHRvbkNsaWNrZWRgIENhbGxlZCB3aGVuIG9uZSBvZiB0aGUgbm9uLWRlc3RydWN0aXZlIGJ1dHRvbnMgaXMgY2xpY2tlZCwKICAgKiAgICAgd2l0aCB0aGUgaW5kZXggb2YgdGhlIGJ1dHRvbiB0aGF0IHdhcyBjbGlja2VkIGFuZCB0aGUgYnV0dG9uIG9iamVjdC4gUmV0dXJuIHRydWUgdG8gY2xvc2UKICAgKiAgICAgdGhlIGFjdGlvbiBzaGVldCwgb3IgZmFsc2UgdG8ga2VlcCBpdCBvcGVuZWQuCiAgICogIC0gYHtmdW5jdGlvbj19YCBgZGVzdHJ1Y3RpdmVCdXR0b25DbGlja2VkYCBDYWxsZWQgd2hlbiB0aGUgZGVzdHJ1Y3RpdmUgYnV0dG9uIGlzIGNsaWNrZWQuCiAgICogICAgIFJldHVybiB0cnVlIHRvIGNsb3NlIHRoZSBhY3Rpb24gc2hlZXQsIG9yIGZhbHNlIHRvIGtlZXAgaXQgb3BlbmVkLgogICAqICAtICBge2Jvb2xlYW49fWAgYGNhbmNlbE9uU3RhdGVDaGFuZ2VgIFdoZXRoZXIgdG8gY2FuY2VsIHRoZSBhY3Rpb25TaGVldCB3aGVuIG5hdmlnYXRpbmcKICAgKiAgICAgdG8gYSBuZXcgc3RhdGUuICBEZWZhdWx0IHRydWUuCiAgICoKICAgKiBAcmV0dXJucyB7ZnVuY3Rpb259IGBoaWRlU2hlZXRgIEEgZnVuY3Rpb24gd2hpY2gsIHdoZW4gY2FsbGVkLCBoaWRlcyAmIGNhbmNlbHMgdGhlIGFjdGlvbiBzaGVldC4KICAgKi8KICBmdW5jdGlvbiBhY3Rpb25TaGVldChvcHRzKSB7CiAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlLiRuZXcodHJ1ZSk7CgogICAgYW5ndWxhci5leHRlbmQoc2NvcGUsIHsKICAgICAgY2FuY2VsOiBhbmd1bGFyLm5vb3AsCiAgICAgIGRlc3RydWN0aXZlQnV0dG9uQ2xpY2tlZDogYW5ndWxhci5ub29wLAogICAgICBidXR0b25DbGlja2VkOiBhbmd1bGFyLm5vb3AsCiAgICAgICRkZXJlZ2lzdGVyQmFja0J1dHRvbjogYW5ndWxhci5ub29wLAogICAgICBidXR0b25zOiBbXSwKICAgICAgY2FuY2VsT25TdGF0ZUNoYW5nZTogdHJ1ZQogICAgfSwgb3B0cyB8fCB7fSk7CgoKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlCiAgICB2YXIgZWxlbWVudCA9IHNjb3BlLmVsZW1lbnQgPSAkY29tcGlsZSgnPGlvbi1hY3Rpb24tc2hlZXQgYnV0dG9ucz0iYnV0dG9ucyI+PC9pb24tYWN0aW9uLXNoZWV0PicpKHNjb3BlKTsKCiAgICAvLyBHcmFiIHRoZSBzaGVldCBlbGVtZW50IGZvciBhbmltYXRpb24KICAgIHZhciBzaGVldEVsID0ganFMaXRlKGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLmFjdGlvbi1zaGVldC13cmFwcGVyJykpOwoKICAgIHZhciBzdGF0ZUNoYW5nZUxpc3RlbkRvbmUgPSBzY29wZS5jYW5jZWxPblN0YXRlQ2hhbmdlID8KICAgICAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbigpIHsgc2NvcGUuY2FuY2VsKCk7IH0pIDoKICAgICAgYW5ndWxhci5ub29wOwoKICAgIC8vIHJlbW92ZXMgdGhlIGFjdGlvblNoZWV0IGZyb20gdGhlIHNjcmVlbgogICAgc2NvcGUucmVtb3ZlU2hlZXQgPSBmdW5jdGlvbihkb25lKSB7CiAgICAgIGlmIChzY29wZS5yZW1vdmVkKSByZXR1cm47CgogICAgICBzY29wZS5yZW1vdmVkID0gdHJ1ZTsKICAgICAgc2hlZXRFbC5yZW1vdmVDbGFzcygnYWN0aW9uLXNoZWV0LXVwJyk7CiAgICAgICRpb25pY0JvZHkucmVtb3ZlQ2xhc3MoJ2FjdGlvbi1zaGVldC1vcGVuJyk7CiAgICAgIHNjb3BlLiRkZXJlZ2lzdGVyQmFja0J1dHRvbigpOwogICAgICBzdGF0ZUNoYW5nZUxpc3RlbkRvbmUoKTsKCiAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsICdhY3RpdmUnLCBmdW5jdGlvbigpIHsKICAgICAgICBzY29wZS4kZGVzdHJveSgpOwogICAgICAgIGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgLy8gc2NvcGUuY2FuY2VsLiRzY29wZSBpcyBkZWZpbmVkIG5lYXIgdGhlIGJvdHRvbQogICAgICAgIHNjb3BlLmNhbmNlbC4kc2NvcGUgPSBudWxsOwogICAgICAgIChkb25lIHx8IGFuZ3VsYXIubm9vcCkoKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHNjb3BlLnNob3dTaGVldCA9IGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgaWYgKHNjb3BlLnJlbW92ZWQpIHJldHVybjsKCiAgICAgICRpb25pY0JvZHkuYXBwZW5kKGVsZW1lbnQpCiAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ2FjdGlvbi1zaGVldC1vcGVuJyk7CgogICAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCAnYWN0aXZlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHNjb3BlLnJlbW92ZWQpIHJldHVybjsKICAgICAgICAoZG9uZSB8fCBhbmd1bGFyLm5vb3ApKCk7CiAgICAgIH0pOwogICAgICAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgIGlmIChzY29wZS5yZW1vdmVkKSByZXR1cm47CiAgICAgICAgc2hlZXRFbC5hZGRDbGFzcygnYWN0aW9uLXNoZWV0LXVwJyk7CiAgICAgIH0sIDIwLCBmYWxzZSk7CiAgICB9OwoKICAgIC8vIHJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbiByZXR1cm5zIGEgY2FsbGJhY2sgdG8gZGVyZWdpc3RlciB0aGUgYWN0aW9uCiAgICBzY29wZS4kZGVyZWdpc3RlckJhY2tCdXR0b24gPSAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICR0aW1lb3V0KHNjb3BlLmNhbmNlbCk7CiAgICAgIH0sCiAgICAgIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX0FDVElPTl9TSEVFVAogICAgKTsKCiAgICAvLyBjYWxsZWQgd2hlbiB0aGUgdXNlciBwcmVzc2VzIHRoZSBjYW5jZWwgYnV0dG9uCiAgICBzY29wZS5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgICAgLy8gYWZ0ZXIgdGhlIGFuaW1hdGlvbiBpcyBvdXQsIGNhbGwgdGhlIGNhbmNlbCBjYWxsYmFjawogICAgICBzY29wZS5yZW1vdmVTaGVldChvcHRzLmNhbmNlbCk7CiAgICB9OwoKICAgIHNjb3BlLmJ1dHRvbkNsaWNrZWQgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAvLyBDaGVjayBpZiB0aGUgYnV0dG9uIGNsaWNrIGV2ZW50IHJldHVybmVkIHRydWUsIHdoaWNoIG1lYW5zCiAgICAgIC8vIHdlIGNhbiBjbG9zZSB0aGUgYWN0aW9uIHNoZWV0CiAgICAgIGlmIChvcHRzLmJ1dHRvbkNsaWNrZWQoaW5kZXgsIG9wdHMuYnV0dG9uc1tpbmRleF0pID09PSB0cnVlKSB7CiAgICAgICAgc2NvcGUucmVtb3ZlU2hlZXQoKTsKICAgICAgfQogICAgfTsKCiAgICBzY29wZS5kZXN0cnVjdGl2ZUJ1dHRvbkNsaWNrZWQgPSBmdW5jdGlvbigpIHsKICAgICAgLy8gQ2hlY2sgaWYgdGhlIGRlc3RydWN0aXZlIGJ1dHRvbiBjbGljayBldmVudCByZXR1cm5lZCB0cnVlLCB3aGljaCBtZWFucwogICAgICAvLyB3ZSBjYW4gY2xvc2UgdGhlIGFjdGlvbiBzaGVldAogICAgICBpZiAob3B0cy5kZXN0cnVjdGl2ZUJ1dHRvbkNsaWNrZWQoKSA9PT0gdHJ1ZSkgewogICAgICAgIHNjb3BlLnJlbW92ZVNoZWV0KCk7CiAgICAgIH0KICAgIH07CgogICAgc2NvcGUuc2hvd1NoZWV0KCk7CgogICAgLy8gRXhwb3NlIHRoZSBzY29wZSBvbiAkaW9uaWNBY3Rpb25TaGVldCdzIHJldHVybiB2YWx1ZSBmb3IgdGhlIHNha2UKICAgIC8vIG9mIHRlc3RpbmcgaXQuCiAgICBzY29wZS5jYW5jZWwuJHNjb3BlID0gc2NvcGU7CgogICAgcmV0dXJuIHNjb3BlLmNhbmNlbDsKICB9Cn1dKTsKCgpqcUxpdGUucHJvdG90eXBlLmFkZENsYXNzID0gZnVuY3Rpb24oY3NzQ2xhc3NlcykgewogIHZhciB4LCB5LCBjc3NDbGFzcywgZWwsIHNwbGl0Q2xhc3NlcywgZXhpc3RpbmdDbGFzc2VzOwogIGlmIChjc3NDbGFzc2VzICYmIGNzc0NsYXNzZXMgIT0gJ25nLXNjb3BlJyAmJiBjc3NDbGFzc2VzICE9ICduZy1pc29sYXRlLXNjb3BlJykgewogICAgZm9yKHg9MDsgeDx0aGlzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGVsID0gdGhpc1t4XTsKICAgICAgaWYoZWwuc2V0QXR0cmlidXRlKSB7CgogICAgICAgIGlmKGNzc0NsYXNzZXMuaW5kZXhPZignICcpIDwgMCAmJiBlbC5jbGFzc0xpc3QuYWRkKSB7CiAgICAgICAgICBlbC5jbGFzc0xpc3QuYWRkKGNzc0NsYXNzZXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBleGlzdGluZ0NsYXNzZXMgPSAoJyAnICsgKGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAnICcpCiAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKTsKICAgICAgICAgIHNwbGl0Q2xhc3NlcyA9IGNzc0NsYXNzZXMuc3BsaXQoJyAnKTsKCiAgICAgICAgICBmb3IgKHk9MDsgeTxzcGxpdENsYXNzZXMubGVuZ3RoOyB5KyspIHsKICAgICAgICAgICAgY3NzQ2xhc3MgPSBzcGxpdENsYXNzZXNbeV0udHJpbSgpOwogICAgICAgICAgICBpZiAoZXhpc3RpbmdDbGFzc2VzLmluZGV4T2YoJyAnICsgY3NzQ2xhc3MgKyAnICcpID09PSAtMSkgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2xhc3NlcyArPSBjc3NDbGFzcyArICcgJzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIGV4aXN0aW5nQ2xhc3Nlcy50cmltKCkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICByZXR1cm4gdGhpczsKfTsKCmpxTGl0ZS5wcm90b3R5cGUucmVtb3ZlQ2xhc3MgPSBmdW5jdGlvbihjc3NDbGFzc2VzKSB7CiAgdmFyIHgsIHksIHNwbGl0Q2xhc3NlcywgY3NzQ2xhc3MsIGVsOwogIGlmIChjc3NDbGFzc2VzKSB7CiAgICBmb3IoeD0wOyB4PHRoaXMubGVuZ3RoOyB4KyspIHsKICAgICAgZWwgPSB0aGlzW3hdOwogICAgICBpZihlbC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICBpZihjc3NDbGFzc2VzLmluZGV4T2YoJyAnKSA8IDAgJiYgZWwuY2xhc3NMaXN0LnJlbW92ZSkgewogICAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjc3NDbGFzc2VzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3BsaXRDbGFzc2VzID0gY3NzQ2xhc3Nlcy5zcGxpdCgnICcpOwoKICAgICAgICAgIGZvciAoeT0wOyB5PHNwbGl0Q2xhc3Nlcy5sZW5ndGg7IHkrKykgewogICAgICAgICAgICBjc3NDbGFzcyA9IHNwbGl0Q2xhc3Nlc1t5XTsKICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsICgKICAgICAgICAgICAgICAgICgiICIgKyAoZWwuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoIiAiICsgY3NzQ2xhc3MudHJpbSgpICsgIiAiLCAiICIpKS50cmltKCkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHRoaXM7Cn07CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljQmFja2Ryb3AKICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24KICogU2hvd3MgYW5kIGhpZGVzIGEgYmFja2Ryb3Agb3ZlciB0aGUgVUkuICBBcHBlYXJzIGJlaGluZCBwb3B1cHMsIGxvYWRpbmcsCiAqIGFuZCBvdGhlciBvdmVybGF5cy4KICoKICogT2Z0ZW4sIG11bHRpcGxlIFVJIGNvbXBvbmVudHMgcmVxdWlyZSBhIGJhY2tkcm9wLCBidXQgb25seSBvbmUgYmFja2Ryb3AgaXMKICogZXZlciBuZWVkZWQgaW4gdGhlIERPTSBhdCBhIHRpbWUuCiAqCiAqIFRoZXJlZm9yZSwgZWFjaCBjb21wb25lbnQgdGhhdCByZXF1aXJlcyB0aGUgYmFja2Ryb3AgdG8gYmUgc2hvd24gY2FsbHMKICogYCRpb25pY0JhY2tkcm9wLnJldGFpbigpYCB3aGVuIGl0IHdhbnRzIHRoZSBiYWNrZHJvcCwgdGhlbiBgJGlvbmljQmFja2Ryb3AucmVsZWFzZSgpYAogKiB3aGVuIGl0IGlzIGRvbmUgd2l0aCB0aGUgYmFja2Ryb3AuCiAqCiAqIEZvciBlYWNoIHRpbWUgYHJldGFpbmAgaXMgY2FsbGVkLCB0aGUgYmFja2Ryb3Agd2lsbCBiZSBzaG93biB1bnRpbCBgcmVsZWFzZWAgaXMgY2FsbGVkLgogKgogKiBGb3IgZXhhbXBsZSwgaWYgYHJldGFpbmAgaXMgY2FsbGVkIHRocmVlIHRpbWVzLCB0aGUgYmFja2Ryb3Agd2lsbCBiZSBzaG93biB1bnRpbCBgcmVsZWFzZWAKICogaXMgY2FsbGVkIHRocmVlIHRpbWVzLgogKgogKiBAdXNhZ2UKICoKICogYGBganMKICogZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJGlvbmljQmFja2Ryb3AsICR0aW1lb3V0KSB7CiAqICAgLy9TaG93IGEgYmFja2Ryb3AgZm9yIG9uZSBzZWNvbmQKICogICAkc2NvcGUuYWN0aW9uID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNCYWNrZHJvcC5yZXRhaW4oKTsKICogICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgICAkaW9uaWNCYWNrZHJvcC5yZWxlYXNlKCk7CiAqICAgICB9LCAxMDAwKTsKICogICB9OwogKiB9CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY0JhY2tkcm9wJywgWwogICckZG9jdW1lbnQnLCAnJHRpbWVvdXQnLApmdW5jdGlvbigkZG9jdW1lbnQsICR0aW1lb3V0KSB7CgogIHZhciBlbCA9IGpxTGl0ZSgnPGRpdiBjbGFzcz0iYmFja2Ryb3AiPicpOwogIHZhciBiYWNrZHJvcEhvbGRzID0gMDsKCiAgJGRvY3VtZW50WzBdLmJvZHkuYXBwZW5kQ2hpbGQoZWxbMF0pOwoKICByZXR1cm4gewogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNCYWNrZHJvcCNyZXRhaW4KICAgICAqIEBkZXNjcmlwdGlvbiBSZXRhaW5zIHRoZSBiYWNrZHJvcC4KICAgICAqLwogICAgcmV0YWluOiByZXRhaW4sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0JhY2tkcm9wI3JlbGVhc2UKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVsZWFzZXMgdGhlIGJhY2tkcm9wLgogICAgICovCiAgICByZWxlYXNlOiByZWxlYXNlLAoKICAgIGdldEVsZW1lbnQ6IGdldEVsZW1lbnQsCgogICAgLy8gZXhwb3NlZCBmb3IgdGVzdGluZwogICAgX2VsZW1lbnQ6IGVsCiAgfTsKCiAgZnVuY3Rpb24gcmV0YWluKCkgewogICAgaWYgKCAoKytiYWNrZHJvcEhvbGRzKSA9PT0gMSApIHsKICAgICAgZWwuYWRkQ2xhc3MoJ3Zpc2libGUnKTsKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgIGJhY2tkcm9wSG9sZHMgJiYgZWwuYWRkQ2xhc3MoJ2FjdGl2ZScpOwogICAgICB9KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcmVsZWFzZSgpIHsKICAgIGlmICggKC0tYmFja2Ryb3BIb2xkcykgPT09IDAgKSB7CiAgICAgIGVsLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgIWJhY2tkcm9wSG9sZHMgJiYgZWwucmVtb3ZlQ2xhc3MoJ3Zpc2libGUnKTsKICAgICAgfSwgNDAwLCBmYWxzZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZXRFbGVtZW50KCkgewogICAgcmV0dXJuIGVsOwogIH0KCn1dKTsKCi8qKgogKiBAcHJpdmF0ZQogKi8KSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY0JpbmQnLCBbJyRwYXJzZScsICckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbigkcGFyc2UsICRpbnRlcnBvbGF0ZSkgewogIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSkoXD8/KVxzKihcdyopXHMqJC87CiAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBhdHRycywgYmluZERlZmluaXRpb24pIHsKICAgIGZvckVhY2goYmluZERlZmluaXRpb24gfHwge30sIGZ1bmN0aW9uIChkZWZpbml0aW9uLCBzY29wZU5hbWUpIHsKICAgICAgLy9BZGFwdGVkIGZyb20gYW5ndWxhci5qcyAkY29tcGlsZQogICAgICB2YXIgbWF0Y2ggPSBkZWZpbml0aW9uLm1hdGNoKExPQ0FMX1JFR0VYUCkgfHwgW10sCiAgICAgICAgYXR0ck5hbWUgPSBtYXRjaFszXSB8fCBzY29wZU5hbWUsCiAgICAgICAgbW9kZSA9IG1hdGNoWzFdLCAvLyBALCA9LCBvciAmCiAgICAgICAgcGFyZW50R2V0LAogICAgICAgIHVud2F0Y2g7CgogICAgICBzd2l0Y2gobW9kZSkgewogICAgICAgIGNhc2UgJ0AnOgogICAgICAgICAgaWYgKCFhdHRyc1thdHRyTmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYXR0cnMuJG9ic2VydmUoYXR0ck5hbWUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHNjb3BlW3Njb3BlTmFtZV0gPSB2YWx1ZTsKICAgICAgICAgIH0pOwogICAgICAgICAgLy8gd2UgdHJpZ2dlciBhbiBpbnRlcnBvbGF0aW9uIHRvIGVuc3VyZQogICAgICAgICAgLy8gdGhlIHZhbHVlIGlzIHRoZXJlIGZvciB1c2UgaW1tZWRpYXRlbHkKICAgICAgICAgIGlmIChhdHRyc1thdHRyTmFtZV0pIHsKICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9ICRpbnRlcnBvbGF0ZShhdHRyc1thdHRyTmFtZV0pKHNjb3BlKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICc9JzoKICAgICAgICAgIGlmICghYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHVud2F0Y2ggPSBzY29wZS4kd2F0Y2goYXR0cnNbYXR0ck5hbWVdLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vRGVzdHJveSBwYXJlbnQgc2NvcGUgd2F0Y2hlciB3aGVuIHRoaXMgc2NvcGUgaXMgZGVzdHJveWVkCiAgICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgdW53YXRjaCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnJic6CiAgICAgICAgICAvKiBqc2hpbnQgLVcwNDQgKi8KICAgICAgICAgIGlmIChhdHRyc1thdHRyTmFtZV0gJiYgYXR0cnNbYXR0ck5hbWVdLm1hdGNoKFJlZ0V4cChzY29wZU5hbWUgKyAnXCguKj9cKScpKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyYgZXhwcmVzc2lvbiBiaW5kaW5nICInICsgc2NvcGVOYW1lICsgJyIgbG9va3MgbGlrZSBpdCB3aWxsIHJlY3Vyc2l2ZWx5IGNhbGwgIicgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW2F0dHJOYW1lXSArICciIGFuZCBjYXVzZSBhIHN0YWNrIG92ZXJmbG93ISBQbGVhc2UgY2hvb3NlIGEgZGlmZmVyZW50IHNjb3BlTmFtZS4nKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IGZ1bmN0aW9uKGxvY2FscykgewogICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9KTsKICB9Owp9XSk7CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljQm9keQogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbiBBbiBhbmd1bGFyIHV0aWxpdHkgc2VydmljZSB0byBlYXNpbHkgYW5kIGVmZmljaWVudGx5CiAqIGFkZCBhbmQgcmVtb3ZlIENTUyBjbGFzc2VzIGZyb20gdGhlIGRvY3VtZW50J3MgYm9keSBlbGVtZW50LgogKi8KSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY0JvZHknLCBbJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCRkb2N1bWVudCkgewogIHJldHVybiB7CiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0JvZHkjYWRkCiAgICAgKiBAZGVzY3JpcHRpb24gQWRkIGEgY2xhc3MgdG8gdGhlIGRvY3VtZW50J3MgYm9keSBlbGVtZW50LgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzIEVhY2ggYXJndW1lbnQgd2lsbCBiZSBhZGRlZCB0byB0aGUgYm9keSBlbGVtZW50LgogICAgICogQHJldHVybnMgeyRpb25pY0JvZHl9IFRoZSAkaW9uaWNCb2R5IHNlcnZpY2Ugc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgICAqLwogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKCkgewogICAgICBmb3IodmFyIHg9MDsgeDxhcmd1bWVudHMubGVuZ3RoOyB4KyspIHsKICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5jbGFzc0xpc3QuYWRkKGFyZ3VtZW50c1t4XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNCb2R5I3JlbW92ZUNsYXNzCiAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlIGEgY2xhc3MgZnJvbSB0aGUgZG9jdW1lbnQncyBib2R5IGVsZW1lbnQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3MgRWFjaCBhcmd1bWVudCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgYm9keSBlbGVtZW50LgogICAgICogQHJldHVybnMgeyRpb25pY0JvZHl9IFRoZSAkaW9uaWNCb2R5IHNlcnZpY2Ugc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgICAqLwogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCkgewogICAgICBmb3IodmFyIHg9MDsgeDxhcmd1bWVudHMubGVuZ3RoOyB4KyspIHsKICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5jbGFzc0xpc3QucmVtb3ZlKGFyZ3VtZW50c1t4XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNCb2R5I2VuYWJsZUNsYXNzCiAgICAgKiBAZGVzY3JpcHRpb24gU2ltaWxhciB0byB0aGUgYGFkZGAgbWV0aG9kLCBleGNlcHQgdGhlIGZpcnN0IHBhcmFtZXRlciBhY2NlcHRzIGEgYm9vbGVhbgogICAgICogdmFsdWUgZGV0ZXJtaW5pbmcgaWYgdGhlIGNsYXNzIHNob3VsZCBiZSBhZGRlZCBvciByZW1vdmVkLiBSYXRoZXIgdGhhbiB3cml0aW5nIHVzZXIgY29kZSwKICAgICAqIHN1Y2ggYXMgImlmIHRydWUgdGhlbiBhZGQgdGhlIGNsYXNzLCBlbHNlIHRoZW4gcmVtb3ZlIHRoZSBjbGFzcyIsIHRoaXMgbWV0aG9kIGNhbiBiZQogICAgICogZ2l2ZW4gYSB0cnVlIG9yIGZhbHNlIHZhbHVlIHdoaWNoIHJlZHVjZXMgcmVkdW5kYW50IGNvZGUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNob3VsZEVuYWJsZUNsYXNzIEEgdHJ1ZS9mYWxzZSB2YWx1ZSBpZiB0aGUgY2xhc3Mgc2hvdWxkIGJlIGFkZGVkIG9yIHJlbW92ZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3MgRWFjaCByZW1haW5pbmcgYXJndW1lbnQgd291bGQgYmUgYWRkZWQgb3IgcmVtb3ZlZCBkZXBlbmRpbmcgb24KICAgICAqIHRoZSBmaXJzdCBhcmd1bWVudC4KICAgICAqIEByZXR1cm5zIHskaW9uaWNCb2R5fSBUaGUgJGlvbmljQm9keSBzZXJ2aWNlIHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICAgKi8KICAgIGVuYWJsZUNsYXNzOiBmdW5jdGlvbihzaG91bGRFbmFibGVDbGFzcykgewogICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykuc2xpY2UoMSk7CiAgICAgIGlmKHNob3VsZEVuYWJsZUNsYXNzKSB7CiAgICAgICAgdGhpcy5hZGRDbGFzcy5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJlbW92ZUNsYXNzLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljQm9keSNhcHBlbmQKICAgICAqIEBkZXNjcmlwdGlvbiBBcHBlbmQgYSBjaGlsZCB0byB0aGUgZG9jdW1lbnQncyBib2R5LgogICAgICogQHBhcmFtIHtlbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGJlIGFwcGVuZGVkIHRvIHRoZSBib2R5LiBUaGUgcGFzc2VkIGluIGVsZW1lbnQKICAgICAqIGNhbiBiZSBlaXRoZXIgYSBqcUxpdGUgZWxlbWVudCwgb3IgYSBET00gZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHskaW9uaWNCb2R5fSBUaGUgJGlvbmljQm9keSBzZXJ2aWNlIHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICAgKi8KICAgIGFwcGVuZDogZnVuY3Rpb24oZWxlKSB7CiAgICAgICRkb2N1bWVudFswXS5ib2R5LmFwcGVuZENoaWxkKCBlbGUubGVuZ3RoID8gZWxlWzBdIDogZWxlICk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljQm9keSNnZXQKICAgICAqIEBkZXNjcmlwdGlvbiBHZXQgdGhlIGRvY3VtZW50J3MgYm9keSBlbGVtZW50LgogICAgICogQHJldHVybnMge2VsZW1lbnR9IFJldHVybnMgdGhlIGRvY3VtZW50J3MgYm9keSBlbGVtZW50LgogICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gJGRvY3VtZW50WzBdLmJvZHk7CiAgICB9CiAgfTsKfV0pOwoKSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY0NsaWNrQmxvY2snLCBbCiAgJyRkb2N1bWVudCcsCiAgJyRpb25pY0JvZHknLAogICckdGltZW91dCcsCmZ1bmN0aW9uKCRkb2N1bWVudCwgJGlvbmljQm9keSwgJHRpbWVvdXQpIHsKICB2YXIgY2IgPSAkZG9jdW1lbnRbMF0uY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgY2IuY2xhc3NOYW1lID0gJ2NsaWNrLWJsb2NrJzsKICByZXR1cm4gewogICAgc2hvdzogZnVuY3Rpb24oKSB7CiAgICAgIGlmKGNiLnBhcmVudEVsZW1lbnQpIHsKICAgICAgICBjYi5jbGFzc0xpc3QucmVtb3ZlKCdoaWRlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgJGlvbmljQm9keS5hcHBlbmQoY2IpOwogICAgICB9CiAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgY2IuY2xhc3NMaXN0LmFkZCgnaGlkZScpOwogICAgICB9LCA1MDApOwogICAgfSwKICAgIGhpZGU6IGZ1bmN0aW9uKCkgewogICAgICBjYi5jbGFzc0xpc3QuYWRkKCdoaWRlJyk7CiAgICB9CiAgfTsKfV0pOwoKSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRjb2xsZWN0aW9uRGF0YVNvdXJjZScsIFsKICAnJGNhY2hlRmFjdG9yeScsCiAgJyRwYXJzZScsCiAgJyRyb290U2NvcGUnLApmdW5jdGlvbigkY2FjaGVGYWN0b3J5LCAkcGFyc2UsICRyb290U2NvcGUpIHsKICBmdW5jdGlvbiBoaWRlV2l0aFRyYW5zZm9ybShlbGVtZW50KSB7CiAgICBlbGVtZW50LmNzcyhpb25pYy5DU1MuVFJBTlNGT1JNLCAndHJhbnNsYXRlM2QoLTIwMDBweCwtMjAwMHB4LDApJyk7CiAgfQoKICBmdW5jdGlvbiBDb2xsZWN0aW9uUmVwZWF0RGF0YVNvdXJjZShvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLnNjb3BlID0gb3B0aW9ucy5zY29wZTsKICAgIHRoaXMudHJhbnNjbHVkZUZuID0gb3B0aW9ucy50cmFuc2NsdWRlRm47CiAgICB0aGlzLnRyYW5zY2x1ZGVQYXJlbnQgPSBvcHRpb25zLnRyYW5zY2x1ZGVQYXJlbnQ7CiAgICB0aGlzLmVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnQ7CgogICAgdGhpcy5rZXlFeHByID0gb3B0aW9ucy5rZXlFeHByOwogICAgdGhpcy5saXN0RXhwciA9IG9wdGlvbnMubGlzdEV4cHI7CiAgICB0aGlzLnRyYWNrQnlFeHByID0gb3B0aW9ucy50cmFja0J5RXhwcjsKCiAgICB0aGlzLmhlaWdodEdldHRlciA9IG9wdGlvbnMuaGVpZ2h0R2V0dGVyOwogICAgdGhpcy53aWR0aEdldHRlciA9IG9wdGlvbnMud2lkdGhHZXR0ZXI7CgogICAgdGhpcy5kaW1lbnNpb25zID0gW107CiAgICB0aGlzLmRhdGEgPSBbXTsKCiAgICB0aGlzLmF0dGFjaGVkSXRlbXMgPSB7fTsKICAgIHRoaXMuQkFDS1VQX0lURU1TX0xFTkdUSCA9IDIwOwogICAgdGhpcy5iYWNrdXBJdGVtc0FycmF5ID0gW107CiAgfQogIENvbGxlY3Rpb25SZXBlYXREYXRhU291cmNlLnByb3RvdHlwZSA9IHsKICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuaXNTZXR1cCkgcmV0dXJuOwogICAgICB0aGlzLmlzU2V0dXAgPSB0cnVlOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuQkFDS1VQX0lURU1TX0xFTkdUSDsgaSsrKSB7CiAgICAgICAgdGhpcy5kZXRhY2hJdGVtKHRoaXMuY3JlYXRlSXRlbSgpKTsKICAgICAgfQogICAgfSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmRpbWVuc2lvbnMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5iYWNrdXBJdGVtc0FycmF5Lmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuYXR0YWNoZWRJdGVtcyA9IHt9OwogICAgfSwKICAgIGNhbGN1bGF0ZURhdGFEaW1lbnNpb25zOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxvY2FscyA9IHt9OwogICAgICB0aGlzLmRpbWVuc2lvbnMgPSB0aGlzLmRhdGEubWFwKGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICAgIGxvY2Fsc1t0aGlzLmtleUV4cHJdID0gdmFsdWU7CiAgICAgICAgbG9jYWxzLiRpbmRleCA9IGluZGV4OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB3aWR0aDogdGhpcy53aWR0aEdldHRlcih0aGlzLnNjb3BlLCBsb2NhbHMpLAogICAgICAgICAgaGVpZ2h0OiB0aGlzLmhlaWdodEdldHRlcih0aGlzLnNjb3BlLCBsb2NhbHMpCiAgICAgICAgfTsKICAgICAgfSwgdGhpcyk7CiAgICAgIHRoaXMuZGltZW5zaW9ucyA9IHRoaXMuYmVmb3JlU2libGluZ3MuY29uY2F0KHRoaXMuZGltZW5zaW9ucykuY29uY2F0KHRoaXMuYWZ0ZXJTaWJsaW5ncyk7CiAgICAgIHRoaXMuZGF0YVN0YXJ0SW5kZXggPSB0aGlzLmJlZm9yZVNpYmxpbmdzLmxlbmd0aDsKICAgIH0sCiAgICBjcmVhdGVJdGVtOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGl0ZW0gPSB7fTsKCiAgICAgIGl0ZW0uc2NvcGUgPSB0aGlzLnNjb3BlLiRuZXcoKTsKICAgICAgdGhpcy50cmFuc2NsdWRlRm4oaXRlbS5zY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICBjbG9uZS5jc3MoJ3Bvc2l0aW9uJywgJ2Fic29sdXRlJyk7CiAgICAgICAgaXRlbS5lbGVtZW50ID0gY2xvbmU7CiAgICAgIH0pOwogICAgICB0aGlzLnRyYW5zY2x1ZGVQYXJlbnQuYXBwZW5kKGl0ZW0uZWxlbWVudCk7CgogICAgICByZXR1cm4gaXRlbTsKICAgIH0sCiAgICBnZXRJdGVtOiBmdW5jdGlvbihpbmRleCkgewogICAgICBpZiAoIChpdGVtID0gdGhpcy5hdHRhY2hlZEl0ZW1zW2luZGV4XSkgKSB7CiAgICAgICAgLy9kbyBub3RoaW5nLCB0aGUgaXRlbSBpcyBnb29kCiAgICAgIH0gZWxzZSBpZiAoIChpdGVtID0gdGhpcy5iYWNrdXBJdGVtc0FycmF5LnBvcCgpKSApIHsKICAgICAgICByZWNvbm5lY3RTY29wZShpdGVtLnNjb3BlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpdGVtID0gdGhpcy5jcmVhdGVJdGVtKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGl0ZW07CiAgICB9LAogICAgYXR0YWNoSXRlbUF0SW5kZXg6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgIGlmIChpbmRleCA8IHRoaXMuZGF0YVN0YXJ0SW5kZXgpIHsKICAgICAgICByZXR1cm4gdGhpcy5iZWZvcmVTaWJsaW5nc1tpbmRleF07CiAgICAgIH0KICAgICAgLy8gU3VidHJhY3Qgc28gd2Ugc3RhcnQgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGlzLmRhdGEsIGFmdGVyCiAgICAgIC8vIHRoaXMuYmVmb3JlU2libGluZ3MuCiAgICAgIGluZGV4IC09IHRoaXMuZGF0YVN0YXJ0SW5kZXg7CgogICAgICBpZiAoaW5kZXggPiB0aGlzLmRhdGEubGVuZ3RoIC0gMSkgewogICAgICAgIHJldHVybiB0aGlzLmFmdGVyU2libGluZ3NbaW5kZXggLSB0aGlzLmRhdGFTdGFydEluZGV4XTsKICAgICAgfQoKICAgICAgdmFyIGl0ZW0gPSB0aGlzLmdldEl0ZW0oaW5kZXgpOwogICAgICB2YXIgdmFsdWUgPSB0aGlzLmRhdGFbaW5kZXhdOwoKICAgICAgaWYgKGl0ZW0uaW5kZXggIT09IGluZGV4IHx8IGl0ZW0uc2NvcGVbdGhpcy5rZXlFeHByXSAhPT0gdmFsdWUpIHsKICAgICAgICBpdGVtLmluZGV4ID0gaXRlbS5zY29wZS4kaW5kZXggPSBpbmRleDsKICAgICAgICBpdGVtLnNjb3BlW3RoaXMua2V5RXhwcl0gPSB2YWx1ZTsKICAgICAgICBpdGVtLnNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICAgICAgaXRlbS5zY29wZS4kbGFzdCA9IChpbmRleCA9PT0gKHRoaXMuZ2V0TGVuZ3RoKCkgLSAxKSk7CiAgICAgICAgaXRlbS5zY29wZS4kbWlkZGxlID0gIShpdGVtLnNjb3BlLiRmaXJzdCB8fCBpdGVtLnNjb3BlLiRsYXN0KTsKICAgICAgICBpdGVtLnNjb3BlLiRvZGQgPSAhKGl0ZW0uc2NvcGUuJGV2ZW4gPSAoaW5kZXgmMSkgPT09IDApOwoKICAgICAgICAvL1dlIGNoYW5nZWQgdGhlIHNjb3BlLCBzbyBkaWdlc3QgaWYgbmVlZGVkCiAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgIGl0ZW0uc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmF0dGFjaGVkSXRlbXNbaW5kZXhdID0gaXRlbTsKCiAgICAgIHJldHVybiBpdGVtOwogICAgfSwKICAgIGRlc3Ryb3lJdGVtOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgIGl0ZW0uZWxlbWVudC5yZW1vdmUoKTsKICAgICAgaXRlbS5zY29wZS4kZGVzdHJveSgpOwogICAgICBpdGVtLnNjb3BlID0gbnVsbDsKICAgICAgaXRlbS5lbGVtZW50ID0gbnVsbDsKICAgIH0sCiAgICBkZXRhY2hJdGVtOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgIGRlbGV0ZSB0aGlzLmF0dGFjaGVkSXRlbXNbaXRlbS5pbmRleF07CgogICAgICAvL0lmIGl0J3MgYW4gb3V0c2lkZSBpdGVtLCBvbmx5IGhpZGUgaXQuIFRoZXNlIGl0ZW1zIGFyZW4ndCBwYXJ0IG9mIGNvbGxlY3Rpb24KICAgICAgLy9yZXBlYXQncyBsaXN0LCBvbmx5IHNpdCBvdXRzaWRlCiAgICAgIGlmIChpdGVtLmlzT3V0c2lkZSkgewogICAgICAgIGhpZGVXaXRoVHJhbnNmb3JtKGl0ZW0uZWxlbWVudCk7CiAgICAgIC8vIElmIHdlIGFyZSBhdCB0aGUgbGltaXQgb2YgYmFja3VwIGl0ZW1zLCBqdXN0IGdldCByaWQgb2YgdGhlIHRoaXMgZWxlbWVudAogICAgICB9IGVsc2UgaWYgKHRoaXMuYmFja3VwSXRlbXNBcnJheS5sZW5ndGggPj0gdGhpcy5CQUNLVVBfSVRFTVNfTEVOR1RIKSB7CiAgICAgICAgdGhpcy5kZXN0cm95SXRlbShpdGVtKTsKICAgICAgLy8gT3RoZXJ3aXNlLCBhZGQgaXQgdG8gb3VyIGJhY2t1cCBpdGVtcwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYmFja3VwSXRlbXNBcnJheS5wdXNoKGl0ZW0pOwogICAgICAgIGhpZGVXaXRoVHJhbnNmb3JtKGl0ZW0uZWxlbWVudCk7CiAgICAgICAgLy9Eb24ndCAuJGRlc3Ryb3koKSwganVzdCBzdG9wIHdhdGNoZXJzIGFuZCBldmVudHMgZmlyaW5nCiAgICAgICAgZGlzY29ubmVjdFNjb3BlKGl0ZW0uc2NvcGUpOwogICAgICB9CgogICAgfSwKICAgIGdldExlbmd0aDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmRpbWVuc2lvbnMgJiYgdGhpcy5kaW1lbnNpb25zLmxlbmd0aCB8fCAwOwogICAgfSwKICAgIHNldERhdGE6IGZ1bmN0aW9uKHZhbHVlLCBiZWZvcmVTaWJsaW5ncywgYWZ0ZXJTaWJsaW5ncykgewogICAgICB0aGlzLmRhdGEgPSB2YWx1ZSB8fCBbXTsKICAgICAgdGhpcy5iZWZvcmVTaWJsaW5ncyA9IGJlZm9yZVNpYmxpbmdzIHx8IFtdOwogICAgICB0aGlzLmFmdGVyU2libGluZ3MgPSBhZnRlclNpYmxpbmdzIHx8IFtdOwogICAgICB0aGlzLmNhbGN1bGF0ZURhdGFEaW1lbnNpb25zKCk7CgogICAgICB0aGlzLmFmdGVyU2libGluZ3MuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgaXRlbS5lbGVtZW50LmNzcyh7cG9zaXRpb246ICdhYnNvbHV0ZScsIHRvcDogJzAnLCBsZWZ0OiAnMCcgfSk7CiAgICAgICAgaGlkZVdpdGhUcmFuc2Zvcm0oaXRlbS5lbGVtZW50KTsKICAgICAgfSk7CiAgICB9LAogIH07CgogIHJldHVybiBDb2xsZWN0aW9uUmVwZWF0RGF0YVNvdXJjZTsKfV0pOwoKZnVuY3Rpb24gZGlzY29ubmVjdFNjb3BlKHNjb3BlKSB7CiAgaWYgKHNjb3BlLiRyb290ID09PSBzY29wZSkgewogICAgcmV0dXJuOyAvLyB3ZSBjYW4ndCBkaXNjb25uZWN0IHRoZSByb290IG5vZGU7CiAgfQogIHZhciBwYXJlbnQgPSBzY29wZS4kcGFyZW50OwogIHNjb3BlLiQkZGlzY29ubmVjdGVkID0gdHJ1ZTsKICAvLyBTZWUgU2NvcGUuJGRlc3Ryb3kKICBpZiAocGFyZW50LiQkY2hpbGRIZWFkID09PSBzY29wZSkgewogICAgcGFyZW50LiQkY2hpbGRIZWFkID0gc2NvcGUuJCRuZXh0U2libGluZzsKICB9CiAgaWYgKHBhcmVudC4kJGNoaWxkVGFpbCA9PT0gc2NvcGUpIHsKICAgIHBhcmVudC4kJGNoaWxkVGFpbCA9IHNjb3BlLiQkcHJldlNpYmxpbmc7CiAgfQogIGlmIChzY29wZS4kJHByZXZTaWJsaW5nKSB7CiAgICBzY29wZS4kJHByZXZTaWJsaW5nLiQkbmV4dFNpYmxpbmcgPSBzY29wZS4kJG5leHRTaWJsaW5nOwogIH0KICBpZiAoc2NvcGUuJCRuZXh0U2libGluZykgewogICAgc2NvcGUuJCRuZXh0U2libGluZy4kJHByZXZTaWJsaW5nID0gc2NvcGUuJCRwcmV2U2libGluZzsKICB9CiAgc2NvcGUuJCRuZXh0U2libGluZyA9IHNjb3BlLiQkcHJldlNpYmxpbmcgPSBudWxsOwp9CgpmdW5jdGlvbiByZWNvbm5lY3RTY29wZShzY29wZSkgewogIGlmIChzY29wZS4kcm9vdCA9PT0gc2NvcGUpIHsKICAgIHJldHVybjsgLy8gd2UgY2FuJ3QgZGlzY29ubmVjdCB0aGUgcm9vdCBub2RlOwogIH0KICBpZiAoIXNjb3BlLiQkZGlzY29ubmVjdGVkKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBwYXJlbnQgPSBzY29wZS4kcGFyZW50OwogIHNjb3BlLiQkZGlzY29ubmVjdGVkID0gZmFsc2U7CiAgLy8gU2VlIFNjb3BlLiRuZXcgZm9yIHRoaXMgbG9naWMuLi4KICBzY29wZS4kJHByZXZTaWJsaW5nID0gcGFyZW50LiQkY2hpbGRUYWlsOwogIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQpIHsKICAgIHBhcmVudC4kJGNoaWxkVGFpbC4kJG5leHRTaWJsaW5nID0gc2NvcGU7CiAgICBwYXJlbnQuJCRjaGlsZFRhaWwgPSBzY29wZTsKICB9IGVsc2UgewogICAgcGFyZW50LiQkY2hpbGRIZWFkID0gcGFyZW50LiQkY2hpbGRUYWlsID0gc2NvcGU7CiAgfQp9CgoKSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRjb2xsZWN0aW9uUmVwZWF0TWFuYWdlcicsIFsKICAnJHJvb3RTY29wZScsCiAgJyR0aW1lb3V0JywKZnVuY3Rpb24oJHJvb3RTY29wZSwgJHRpbWVvdXQpIHsKICAvKioKICAgKiBWb2NhYnVsYXJ5OiAicHJpbWFyeSIgYW5kICJzZWNvbmRhcnkiIHNpemUvZGlyZWN0aW9uL3Bvc2l0aW9uIG1lYW4KICAgKiAieSIgYW5kICJ4IiBmb3IgdmVydGljYWwgc2Nyb2xsaW5nLCBvciAieCIgYW5kICJ5IiBmb3IgaG9yaXpvbnRhbCBzY3JvbGxpbmcuCiAgICovCiAgZnVuY3Rpb24gQ29sbGVjdGlvblJlcGVhdE1hbmFnZXIob3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5kYXRhU291cmNlID0gb3B0aW9ucy5kYXRhU291cmNlOwogICAgdGhpcy5lbGVtZW50ID0gb3B0aW9ucy5lbGVtZW50OwogICAgdGhpcy5zY3JvbGxWaWV3ID0gb3B0aW9ucy5zY3JvbGxWaWV3OwoKICAgIHRoaXMuaXNWZXJ0aWNhbCA9ICEhdGhpcy5zY3JvbGxWaWV3Lm9wdGlvbnMuc2Nyb2xsaW5nWTsKICAgIHRoaXMucmVuZGVyZWRJdGVtcyA9IHt9OwogICAgdGhpcy5kaW1lbnNpb25zID0gW107CiAgICB0aGlzLnNldEN1cnJlbnRJbmRleCgwKTsKCiAgICAvL092ZXJyaWRlIHNjcm9sbHZpZXcncyByZW5kZXIgY2FsbGJhY2sKICAgIHRoaXMuc2Nyb2xsVmlldy5fXyRjYWxsYmFjayA9IHRoaXMuc2Nyb2xsVmlldy5fX2NhbGxiYWNrOwogICAgdGhpcy5zY3JvbGxWaWV3Ll9fY2FsbGJhY2sgPSBhbmd1bGFyLmJpbmQodGhpcywgdGhpcy5yZW5kZXJTY3JvbGwpOwoKICAgIGZ1bmN0aW9uIGdldFZpZXdwb3J0U2l6ZSgpIHsgcmV0dXJuIHNlbGYudmlld3BvcnRTaXplOyB9CiAgICAvL1NldCBnZXR0ZXJzIGFuZCBzZXR0ZXJzIHRvIG1hdGNoIHdoZXRoZXIgdGhpcyBzY3JvbGx2aWV3IGlzIHZlcnRpY2FsIG9yIG5vdAogICAgaWYgKHRoaXMuaXNWZXJ0aWNhbCkgewogICAgICB0aGlzLnNjcm9sbFZpZXcub3B0aW9ucy5nZXRDb250ZW50SGVpZ2h0ID0gZ2V0Vmlld3BvcnRTaXplOwoKICAgICAgdGhpcy5zY3JvbGxWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19zY3JvbGxUb3A7CiAgICAgIH07CiAgICAgIHRoaXMuc2Nyb2xsTWF4VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fbWF4U2Nyb2xsVG9wOwogICAgICB9OwogICAgICB0aGlzLnNjcm9sbFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fY2xpZW50SGVpZ2h0OwogICAgICB9OwogICAgICB0aGlzLnNlY29uZGFyeVNjcm9sbFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fY2xpZW50V2lkdGg7CiAgICAgIH07CiAgICAgIHRoaXMudHJhbnNmb3JtU3RyaW5nID0gZnVuY3Rpb24oeSwgeCkgewogICAgICAgIHJldHVybiAndHJhbnNsYXRlM2QoJyt4KydweCwnK3krJ3B4LDApJzsKICAgICAgfTsKICAgICAgdGhpcy5wcmltYXJ5RGltZW5zaW9uID0gZnVuY3Rpb24oZGltKSB7CiAgICAgICAgcmV0dXJuIGRpbS5oZWlnaHQ7CiAgICAgIH07CiAgICAgIHRoaXMuc2Vjb25kYXJ5RGltZW5zaW9uID0gZnVuY3Rpb24oZGltKSB7CiAgICAgICAgcmV0dXJuIGRpbS53aWR0aDsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc2Nyb2xsVmlldy5vcHRpb25zLmdldENvbnRlbnRXaWR0aCA9IGdldFZpZXdwb3J0U2l6ZTsKCiAgICAgIHRoaXMuc2Nyb2xsVmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fc2Nyb2xsTGVmdDsKICAgICAgfTsKICAgICAgdGhpcy5zY3JvbGxNYXhWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19tYXhTY3JvbGxMZWZ0OwogICAgICB9OwogICAgICB0aGlzLnNjcm9sbFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fY2xpZW50V2lkdGg7CiAgICAgIH07CiAgICAgIHRoaXMuc2Vjb25kYXJ5U2Nyb2xsU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19jbGllbnRIZWlnaHQ7CiAgICAgIH07CiAgICAgIHRoaXMudHJhbnNmb3JtU3RyaW5nID0gZnVuY3Rpb24oeCwgeSkgewogICAgICAgIHJldHVybiAndHJhbnNsYXRlM2QoJyt4KydweCwnK3krJ3B4LDApJzsKICAgICAgfTsKICAgICAgdGhpcy5wcmltYXJ5RGltZW5zaW9uID0gZnVuY3Rpb24oZGltKSB7CiAgICAgICAgcmV0dXJuIGRpbS53aWR0aDsKICAgICAgfTsKICAgICAgdGhpcy5zZWNvbmRhcnlEaW1lbnNpb24gPSBmdW5jdGlvbihkaW0pIHsKICAgICAgICByZXR1cm4gZGltLmhlaWdodDsKICAgICAgfTsKICAgIH0KICB9CgogIENvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyLnByb3RvdHlwZSA9IHsKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlbmRlcmVkSXRlbXMgPSB7fTsKICAgICAgdGhpcy5yZW5kZXIgPSBhbmd1bGFyLm5vb3A7CiAgICAgIHRoaXMuY2FsY3VsYXRlRGltZW5zaW9ucyA9IGFuZ3VsYXIubm9vcDsKICAgICAgdGhpcy5kaW1lbnNpb25zID0gW107CiAgICB9LAoKICAgIC8qCiAgICAgKiBQcmUtY2FsY3VsYXRlIHRoZSBwb3NpdGlvbiBvZiBhbGwgaXRlbXMgaW4gdGhlIGRhdGEgbGlzdC4KICAgICAqIERvIHRoaXMgdXNpbmcgdGhlIHByb3ZpZGVkIHdpZHRoIGFuZCBoZWlnaHQgKHByaW1hcnlTaXplIGFuZCBzZWNvbmRhcnlTaXplKQogICAgICogcHJvdmlkZWQgYnkgdGhlIGRhdGFTb3VyY2UuCiAgICAgKi8KICAgIGNhbGN1bGF0ZURpbWVuc2lvbnM6IGZ1bmN0aW9uKCkgewogICAgICAvKgogICAgICAgKiBGb3IgdGhlIHNha2Ugb2YgZXhwbGFuYXRpb25zIGJlbG93LCB3ZSdyZSBnb2luZyB0byBwcmV0ZW5kIHdlIGFyZSBzY3JvbGxpbmcKICAgICAgICogdmVydGljYWxseTogSXRlbXMgYXJlIGxhaWQgb3V0IHdpdGggcHJpbWFyeVNpemUgYmVpbmcgaGVpZ2h0LAogICAgICAgKiBzZWNvbmRhcnlTaXplIGJlaW5nIHdpZHRoLgogICAgICAgKi8KICAgICAgdmFyIHByaW1hcnlQb3MgPSAwOwogICAgICB2YXIgc2Vjb25kYXJ5UG9zID0gMDsKICAgICAgdmFyIHNlY29uZGFyeVNjcm9sbFNpemUgPSB0aGlzLnNlY29uZGFyeVNjcm9sbFNpemUoKTsKICAgICAgdmFyIHByZXZpb3VzSXRlbTsKCiAgICAgIHRoaXMuZGF0YVNvdXJjZS5iZWZvcmVTaWJsaW5ncyAmJiB0aGlzLmRhdGFTb3VyY2UuYmVmb3JlU2libGluZ3MuZm9yRWFjaChjYWxjdWxhdGVTaXplLCB0aGlzKTsKICAgICAgdmFyIGJlZm9yZVNpemUgPSBwcmltYXJ5UG9zICsgKHByZXZpb3VzSXRlbSA/IHByZXZpb3VzSXRlbS5wcmltYXJ5U2l6ZSA6IDApOwoKICAgICAgcHJpbWFyeVBvcyA9IHNlY29uZGFyeVBvcyA9IDA7CiAgICAgIHByZXZpb3VzSXRlbSA9IG51bGw7CgogICAgICB2YXIgZGltZW5zaW9ucyA9IHRoaXMuZGF0YVNvdXJjZS5kaW1lbnNpb25zLm1hcChjYWxjdWxhdGVTaXplLCB0aGlzKTsKICAgICAgdmFyIHRvdGFsU2l6ZSA9IHByaW1hcnlQb3MgKyAocHJldmlvdXNJdGVtID8gcHJldmlvdXNJdGVtLnByaW1hcnlTaXplIDogMCk7CgogICAgICByZXR1cm4gewogICAgICAgIGJlZm9yZVNpemU6IGJlZm9yZVNpemUsCiAgICAgICAgdG90YWxTaXplOiB0b3RhbFNpemUsCiAgICAgICAgZGltZW5zaW9uczogZGltZW5zaW9ucwogICAgICB9OwoKICAgICAgZnVuY3Rpb24gY2FsY3VsYXRlU2l6ZShkaW0pIHsKCiAgICAgICAgLy9FYWNoIGRpbWVuc2lvbiBpcyBhbiBvYmplY3Qge3dpZHRoOiBOdW1iZXIsIGhlaWdodDogTnVtYmVyfSBwcm92aWRlZCBieQogICAgICAgIC8vdGhlIGRhdGFTb3VyY2UKICAgICAgICB2YXIgcmVjdCA9IHsKICAgICAgICAgIC8vR2V0IHRoZSBoZWlnaHQgb3V0IG9mIHRoZSBkaW1lbnNpb24gb2JqZWN0CiAgICAgICAgICBwcmltYXJ5U2l6ZTogdGhpcy5wcmltYXJ5RGltZW5zaW9uKGRpbSksCiAgICAgICAgICAvL01heCBvdXQgdGhlIGl0ZW0ncyB3aWR0aCB0byB0aGUgd2lkdGggb2YgdGhlIHNjcm9sbHZpZXcKICAgICAgICAgIHNlY29uZGFyeVNpemU6IE1hdGgubWluKHRoaXMuc2Vjb25kYXJ5RGltZW5zaW9uKGRpbSksIHNlY29uZGFyeVNjcm9sbFNpemUpCiAgICAgICAgfTsKCiAgICAgICAgLy9JZiB0aGlzIGlzbid0IHRoZSBmaXJzdCBpdGVtCiAgICAgICAgaWYgKHByZXZpb3VzSXRlbSkgewogICAgICAgICAgLy9Nb3ZlIHRoZSBpdGVtJ3MgeCBwb3NpdGlvbiBvdmVyIGJ5IHRoZSB3aWR0aCBvZiB0aGUgcHJldmlvdXMgaXRlbQogICAgICAgICAgc2Vjb25kYXJ5UG9zICs9IHByZXZpb3VzSXRlbS5zZWNvbmRhcnlTaXplOwogICAgICAgICAgLy9JZiB0aGUgeSBwb3NpdGlvbiBpcyB0aGUgc2FtZSBhcyB0aGUgcHJldmlvdXMgaXRlbSBhbmQKICAgICAgICAgIC8vdGhlIHggcG9zaXRpb24gaXMgYmlnZ2VyIHRoYW4gdGhlIHNjcm9sbGVyJ3Mgd2lkdGgKICAgICAgICAgIGlmIChwcmV2aW91c0l0ZW0ucHJpbWFyeVBvcyA9PT0gcHJpbWFyeVBvcyAmJgogICAgICAgICAgICAgIHNlY29uZGFyeVBvcyArIHJlY3Quc2Vjb25kYXJ5U2l6ZSA+IHNlY29uZGFyeVNjcm9sbFNpemUpIHsKICAgICAgICAgICAgLy9UaGVuIGdvIHRvIHRoZSBuZXh0IHJvdywgd2l0aCB4IHBvc2l0aW9uIDAKICAgICAgICAgICAgc2Vjb25kYXJ5UG9zID0gMDsKICAgICAgICAgICAgcHJpbWFyeVBvcyArPSBwcmV2aW91c0l0ZW0ucHJpbWFyeVNpemU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWN0LnByaW1hcnlQb3MgPSBwcmltYXJ5UG9zOwogICAgICAgIHJlY3Quc2Vjb25kYXJ5UG9zID0gc2Vjb25kYXJ5UG9zOwoKICAgICAgICBwcmV2aW91c0l0ZW0gPSByZWN0OwogICAgICAgIHJldHVybiByZWN0OwogICAgICB9CiAgICB9LAogICAgcmVzaXplOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRoaXMuY2FsY3VsYXRlRGltZW5zaW9ucygpOwogICAgICB0aGlzLmRpbWVuc2lvbnMgPSByZXN1bHQuZGltZW5zaW9uczsKICAgICAgdGhpcy52aWV3cG9ydFNpemUgPSByZXN1bHQudG90YWxTaXplOwogICAgICB0aGlzLmJlZm9yZVNpemUgPSByZXN1bHQuYmVmb3JlU2l6ZTsKICAgICAgdGhpcy5zZXRDdXJyZW50SW5kZXgoMCk7CiAgICAgIHRoaXMucmVuZGVyKHRydWUpOwogICAgICB0aGlzLmRhdGFTb3VyY2Uuc2V0dXAoKTsKICAgIH0sCiAgICAvKgogICAgICogc2V0Q3VycmVudEluZGV4IHNldHMgdGhlIGluZGV4IGluIHRoZSBsaXN0IHRoYXQgbWF0Y2hlcyB0aGUgc2Nyb2xsZXIncyBwb3NpdGlvbi4KICAgICAqIEFsc28gc2F2ZSB0aGUgcG9zaXRpb24gaW4gdGhlIHNjcm9sbGVyIGZvciBuZXh0IGFuZCBwcmV2aW91cyBpdGVtcyAoaWYgdGhleSBleGlzdCkKICAgICAqLwogICAgc2V0Q3VycmVudEluZGV4OiBmdW5jdGlvbihpbmRleCwgaGVpZ2h0KSB7CiAgICAgIHZhciBjdXJyZW50UG9zID0gKHRoaXMuZGltZW5zaW9uc1tpbmRleF0gfHwge30pLnByaW1hcnlQb3MgfHwgMDsKICAgICAgdGhpcy5jdXJyZW50SW5kZXggPSBpbmRleDsKCiAgICAgIHRoaXMuaGFzUHJldkluZGV4ID0gaW5kZXggPiAwOwogICAgICBpZiAodGhpcy5oYXNQcmV2SW5kZXgpIHsKICAgICAgICB0aGlzLnByZXZpb3VzUG9zID0gTWF0aC5tYXgoCiAgICAgICAgICBjdXJyZW50UG9zIC0gdGhpcy5kaW1lbnNpb25zW2luZGV4IC0gMV0ucHJpbWFyeVNpemUsCiAgICAgICAgICB0aGlzLmRpbWVuc2lvbnNbaW5kZXggLSAxXS5wcmltYXJ5UG9zCiAgICAgICAgKTsKICAgICAgfQogICAgICB0aGlzLmhhc05leHRJbmRleCA9IGluZGV4ICsgMSA8IHRoaXMuZGF0YVNvdXJjZS5nZXRMZW5ndGgoKTsKICAgICAgaWYgKHRoaXMuaGFzTmV4dEluZGV4KSB7CiAgICAgICAgdGhpcy5uZXh0UG9zID0gTWF0aC5taW4oCiAgICAgICAgICBjdXJyZW50UG9zICsgdGhpcy5kaW1lbnNpb25zW2luZGV4ICsgMV0ucHJpbWFyeVNpemUsCiAgICAgICAgICB0aGlzLmRpbWVuc2lvbnNbaW5kZXggKyAxXS5wcmltYXJ5UG9zCiAgICAgICAgKTsKICAgICAgfQogICAgfSwKICAgIC8qKgogICAgICogb3ZlcnJpZGUgdGhlIHNjcm9sbGVyJ3MgcmVuZGVyIGNhbGxiYWNrIHRvIGNoZWNrIGlmIHdlIG5lZWQgdG8KICAgICAqIHJlLXJlbmRlciBvdXIgY29sbGVjdGlvbgogICAgICovCiAgICByZW5kZXJTY3JvbGw6IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24odHJhbnNmb3JtTGVmdCwgdHJhbnNmb3JtVG9wLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgaWYgKHRoaXMuaXNWZXJ0aWNhbCkgewogICAgICAgIHRoaXMucmVuZGVySWZOZWVkZWQodHJhbnNmb3JtVG9wKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJlbmRlcklmTmVlZGVkKHRyYW5zZm9ybUxlZnQpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX18kY2FsbGJhY2sodHJhbnNmb3JtTGVmdCwgdHJhbnNmb3JtVG9wLCB6b29tLCB3YXNSZXNpemUpOwogICAgfSksCgogICAgcmVuZGVySWZOZWVkZWQ6IGZ1bmN0aW9uKHNjcm9sbFBvcykgewogICAgICBpZiAoKHRoaXMuaGFzTmV4dEluZGV4ICYmIHNjcm9sbFBvcyA+PSB0aGlzLm5leHRQb3MpIHx8CiAgICAgICAgICAodGhpcy5oYXNQcmV2SW5kZXggJiYgc2Nyb2xsUG9zIDwgdGhpcy5wcmV2aW91c1BvcykpIHsKICAgICAgICAgICAvLyBNYXRoLmFicyh0cmFuc2Zvcm1Qb3MgLSB0aGlzLmxhc3RSZW5kZXJTY3JvbGxWYWx1ZSkgPiAxMDApIHsKICAgICAgICB0aGlzLnJlbmRlcigpOwogICAgICB9CiAgICB9LAogICAgLyoKICAgICAqIGdldEluZGV4Rm9yU2Nyb2xsVmFsdWU6IEdpdmVuIHRoZSBtb3N0IHJlY2VudCBkYXRhIGluZGV4IGFuZCBhIG5ldyBzY3JvbGxWYWx1ZSwKICAgICAqIGZpbmQgdGhlIGRhdGEgaW5kZXggdGhhdCBtYXRjaGVzIHRoYXQgc2Nyb2xsVmFsdWUuCiAgICAgKgogICAgICogU3RyYXRlZ3kgKGlmIHdlIGFyZSBzY3JvbGxpbmcgZG93bik6IGtlZXAgZ29pbmcgZm9yd2FyZCBpbiB0aGUgZGltZW5zaW9ucyBsaXN0LAogICAgICogc3RhcnRpbmcgYXQgdGhlIGdpdmVuIGluZGV4LCB1bnRpbCBhbiBpdGVtIHdpdGggaGVpZ2h0IG1hdGNoaW5nIHRoZSBuZXcgc2Nyb2xsVmFsdWUKICAgICAqIGlzIGZvdW5kLgogICAgICoKICAgICAqIFRoaXMgaXMgYSB3aGlsZSBsb29wLiBJbiB0aGUgd29yc3QgY2FzZSBpdCB3aWxsIGhhdmUgdG8gZ28gdGhyb3VnaCB0aGUgd2hvbGUgbGlzdAogICAgICogKGVnIHRvIHNjcm9sbCBmcm9tIHRvcCB0byBib3R0b20pLiAgVGhlIG1vc3QgY29tbW9uIGNhc2UgaXMgdG8gc2Nyb2xsCiAgICAgKiBkb3duIDEtMyBpdGVtcyBhdCBhIHRpbWUuCiAgICAgKgogICAgICogV2hpbGUgdGhpcyBpcyBub3QgYXMgZWZmaWNpZW50IGFzIGl0IGNvdWxkIGJlLCBvcHRpbWl6aW5nIGl0IGdpdmVzIG5vIG5vdGljZWFibGUKICAgICAqIGJlbmVmaXQuICBXZSB3b3VsZCBoYXZlIHRvIHVzZSBhIG5ldyBtZW1vcnktaW50ZW5zaXZlIGRhdGEgc3RydWN0dXJlIGZvciBkaW1lbnNpb25zCiAgICAgKiB0byBmdWxseSBvcHRpbWl6ZSBpdC4KICAgICAqLwogICAgZ2V0SW5kZXhGb3JTY3JvbGxWYWx1ZTogZnVuY3Rpb24oaSwgc2Nyb2xsVmFsdWUpIHsKICAgICAgdmFyIHJlY3Q7CiAgICAgIC8vU2Nyb2xsaW5nIHVwCiAgICAgIGlmIChzY3JvbGxWYWx1ZSA8PSB0aGlzLmRpbWVuc2lvbnNbaV0ucHJpbWFyeVBvcykgewogICAgICAgIHdoaWxlICggKHJlY3QgPSB0aGlzLmRpbWVuc2lvbnNbaSAtIDFdKSAmJiByZWN0LnByaW1hcnlQb3MgPiBzY3JvbGxWYWx1ZSkgewogICAgICAgICAgaS0tOwogICAgICAgIH0KICAgICAgLy9TY3JvbGxpbmcgZG93bgogICAgICB9IGVsc2UgewogICAgICAgIHdoaWxlICggKHJlY3QgPSB0aGlzLmRpbWVuc2lvbnNbaSArIDFdKSAmJiByZWN0LnByaW1hcnlQb3MgPCBzY3JvbGxWYWx1ZSkgewogICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gaTsKICAgIH0sCiAgICAvKgogICAgICogcmVuZGVyOiBGaWd1cmUgb3V0IHRoZSBzY3JvbGwgcG9zaXRpb24sIHRoZSBpbmRleCBtYXRjaGluZyBpdCwgYW5kIHRoZW4gdGVsbAogICAgICogdGhlIGRhdGEgc291cmNlIHRvIHJlbmRlciB0aGUgY29ycmVjdCBpdGVtcyBpbnRvIHRoZSBET00uCiAgICAgKi8KICAgIHJlbmRlcjogZnVuY3Rpb24oc2hvdWxkUmVkcmF3QWxsKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGk7CiAgICAgIHZhciBpc091dE9mQm91bmRzID0gKCB0aGlzLmN1cnJlbnRJbmRleCA+PSB0aGlzLmRhdGFTb3VyY2UuZ2V0TGVuZ3RoKCkgKTsKICAgICAgLy8gV2Ugd2FudCB0byByZW1vdmUgYWxsIHRoZSBpdGVtcyBhbmQgcmVkcmF3IGV2ZXJ5dGhpbmcgaWYgd2UncmUgb3V0IG9mIGJvdW5kcwogICAgICAvLyBvciBhIGZsYWcgaXMgcGFzc2VkIGluLgogICAgICBpZiAoaXNPdXRPZkJvdW5kcyB8fCBzaG91bGRSZWRyYXdBbGwpIHsKICAgICAgICBmb3IgKGkgaW4gdGhpcy5yZW5kZXJlZEl0ZW1zKSB7CiAgICAgICAgICB0aGlzLnJlbW92ZUl0ZW0oaSk7CiAgICAgICAgfQogICAgICAgIC8vIEp1c3QgZG9uJ3QgcmVuZGVyIGFueXRoaW5nIGlmIHdlJ3JlIG91dCBvZiBib3VuZHMKICAgICAgICBpZiAoaXNPdXRPZkJvdW5kcykgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcmVjdDsKICAgICAgdmFyIHNjcm9sbFZhbHVlID0gdGhpcy5zY3JvbGxWYWx1ZSgpOwogICAgICAvLyBTY3JvbGwgc2l6ZSA9IGhvdyBtYW55IHBpeGVscyBhcmUgdmlzaWJsZSBpbiB0aGUgc2Nyb2xsZXIgYXQgb25lIHRpbWUKICAgICAgdmFyIHNjcm9sbFNpemUgPSB0aGlzLnNjcm9sbFNpemUoKTsKICAgICAgLy8gV2UgdGFrZSB0aGUgY3VycmVudCBzY3JvbGwgdmFsdWUgYW5kIGFkZCBpdCB0byB0aGUgc2Nyb2xsU2l6ZSB0byBnZXQKICAgICAgLy8gd2hhdCBzY3JvbGxWYWx1ZSB0aGUgY3VycmVudCB2aXNpYmxlIHNjcm9sbCBhcmVhIGVuZHMgYXQuCiAgICAgIHZhciBzY3JvbGxTaXplRW5kID0gc2Nyb2xsU2l6ZSArIHNjcm9sbFZhbHVlOwogICAgICAvLyBHZXQgdGhlIG5ldyBzdGFydCBpbmRleCBmb3Igc2Nyb2xsaW5nLCBiYXNlZCBvbiB0aGUgY3VycmVudCBzY3JvbGxWYWx1ZSBhbmQKICAgICAgLy8gdGhlIG1vc3QgcmVjZW50IGtub3duIGluZGV4CiAgICAgIHZhciBzdGFydEluZGV4ID0gdGhpcy5nZXRJbmRleEZvclNjcm9sbFZhbHVlKHRoaXMuY3VycmVudEluZGV4LCBzY3JvbGxWYWx1ZSk7CgogICAgICAvLyBJZiB3ZSBhcmVuJ3Qgb24gdGhlIGZpcnN0IGl0ZW0sIGFkZCBvbmUgcm93IG9mIGl0ZW1zIGJlZm9yZSBzbyB0aGF0IHdoZW4gdGhlIHVzZXIgaXMKICAgICAgLy8gc2Nyb2xsaW5nIHVwIGhlIHNlZXMgdGhlIHByZXZpb3VzIGl0ZW0KICAgICAgdmFyIHJlbmRlclN0YXJ0SW5kZXggPSBNYXRoLm1heChzdGFydEluZGV4IC0gMSwgMCk7CiAgICAgIC8vIEtlZXAgYWRkaW5nIGl0ZW1zIHRvIHRoZSAnZXh0cmEgcm93IGFib3ZlJyB1bnRpbCB3ZSBnZXQgdG8gYSBuZXcgcm93LgogICAgICAvLyBUaGlzIGlzIGZvciB0aGUgY2FzZSB3aGVyZSB0aGVyZSBhcmUgbXVsdGlwbGUgaXRlbXMgb24gb25lIHJvdyBhYm92ZQogICAgICAvLyB0aGUgY3VycmVudCBpdGVtOyB3ZSB3YW50IHRvIGtlZXAgYWRkaW5nIGl0ZW1zIGFib3ZlIHVudGlsCiAgICAgIC8vIGEgbmV3IHJvdyBpcyByZWFjaGVkLgogICAgICB3aGlsZSAocmVuZGVyU3RhcnRJbmRleCA+IDAgJiYKICAgICAgICAgKHJlY3QgPSB0aGlzLmRpbWVuc2lvbnNbcmVuZGVyU3RhcnRJbmRleF0pICYmCiAgICAgICAgIHJlY3QucHJpbWFyeVBvcyA9PT0gdGhpcy5kaW1lbnNpb25zW3N0YXJ0SW5kZXggLSAxXS5wcmltYXJ5UG9zKSB7CiAgICAgICAgcmVuZGVyU3RhcnRJbmRleC0tOwogICAgICB9CgogICAgICAvLyBLZWVwIHJlbmRlcmluZyBpdGVtcywgYWRkaW5nIHRoZW0gdW50aWwgd2UgYXJlIHBhc3QgdGhlIGVuZCBvZiB0aGUgdmlzaWJsZSBzY3JvbGwgYXJlYQogICAgICBpID0gcmVuZGVyU3RhcnRJbmRleDsKICAgICAgd2hpbGUgKChyZWN0ID0gdGhpcy5kaW1lbnNpb25zW2ldKSAmJiAocmVjdC5wcmltYXJ5UG9zIC0gcmVjdC5wcmltYXJ5U2l6ZSA8IHNjcm9sbFNpemVFbmQpKSB7CiAgICAgICAgZG9SZW5kZXIoaSwgcmVjdCk7CiAgICAgICAgaSsrOwogICAgICB9CgogICAgICAvLyBSZW5kZXIgdHdvIGV4dHJhIGl0ZW1zIGF0IHRoZSBlbmQgYXMgYSBidWZmZXIKICAgICAgaWYgKHNlbGYuZGltZW5zaW9uc1tpXSkgewogICAgICAgIGRvUmVuZGVyKGksIHNlbGYuZGltZW5zaW9uc1tpXSk7CiAgICAgICAgaSsrOwogICAgICB9CiAgICAgIGlmIChzZWxmLmRpbWVuc2lvbnNbaV0pIHsKICAgICAgICBkb1JlbmRlcihpLCBzZWxmLmRpbWVuc2lvbnNbaV0pOwogICAgICB9CiAgICAgIHZhciByZW5kZXJFbmRJbmRleCA9IGk7CgogICAgICAvLyBSZW1vdmUgYW55IGl0ZW1zIHRoYXQgd2VyZSByZW5kZXJlZCBhbmQgYXJlbid0IHZpc2libGUgYW55bW9yZQogICAgICBmb3IgKHZhciByZW5kZXJJbmRleCBpbiB0aGlzLnJlbmRlcmVkSXRlbXMpIHsKICAgICAgICBpZiAocmVuZGVySW5kZXggPCByZW5kZXJTdGFydEluZGV4IHx8IHJlbmRlckluZGV4ID4gcmVuZGVyRW5kSW5kZXgpIHsKICAgICAgICAgIHRoaXMucmVtb3ZlSXRlbShyZW5kZXJJbmRleCk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnNldEN1cnJlbnRJbmRleChzdGFydEluZGV4KTsKCiAgICAgIGZ1bmN0aW9uIGRvUmVuZGVyKGRhdGFJbmRleCwgcmVjdCkgewogICAgICAgIGlmIChkYXRhSW5kZXggPCBzZWxmLmRhdGFTb3VyY2UuZGF0YVN0YXJ0SW5kZXgpIHsKICAgICAgICAgIC8vIGRvIG5vdGhpbmcKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5yZW5kZXJJdGVtKGRhdGFJbmRleCwgcmVjdC5wcmltYXJ5UG9zIC0gc2VsZi5iZWZvcmVTaXplLCByZWN0LnNlY29uZGFyeVBvcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVuZGVySXRlbTogZnVuY3Rpb24oZGF0YUluZGV4LCBwcmltYXJ5UG9zLCBzZWNvbmRhcnlQb3MpIHsKICAgICAgLy8gQXR0YWNoIGFuIGl0ZW0sIGFuZCBzZXQgaXRzIHRyYW5zZm9ybSBwb3NpdGlvbiB0byB0aGUgcmVxdWlyZWQgdmFsdWUKICAgICAgdmFyIGl0ZW0gPSB0aGlzLmRhdGFTb3VyY2UuYXR0YWNoSXRlbUF0SW5kZXgoZGF0YUluZGV4KTsKICAgICAgdm9pZCAwOwogICAgICBpZiAoaXRlbSAmJiBpdGVtLmVsZW1lbnQpIHsKICAgICAgICBpZiAoaXRlbS5wcmltYXJ5UG9zICE9PSBwcmltYXJ5UG9zIHx8IGl0ZW0uc2Vjb25kYXJ5UG9zICE9PSBzZWNvbmRhcnlQb3MpIHsKICAgICAgICAgIGl0ZW0uZWxlbWVudC5jc3MoaW9uaWMuQ1NTLlRSQU5TRk9STSwgdGhpcy50cmFuc2Zvcm1TdHJpbmcoCiAgICAgICAgICAgIHByaW1hcnlQb3MsIHNlY29uZGFyeVBvcwogICAgICAgICAgKSk7CiAgICAgICAgICBpdGVtLnByaW1hcnlQb3MgPSBwcmltYXJ5UG9zOwogICAgICAgICAgaXRlbS5zZWNvbmRhcnlQb3MgPSBzZWNvbmRhcnlQb3M7CiAgICAgICAgfQogICAgICAgIC8vIFNhdmUgdGhlIGl0ZW0gaW4gcmVuZGVyZWQgaXRlbXMKICAgICAgICB0aGlzLnJlbmRlcmVkSXRlbXNbZGF0YUluZGV4XSA9IGl0ZW07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgYW4gaXRlbSBhdCB0aGlzIGluZGV4IGRvZXNuJ3QgZXhpc3QgYW55bW9yZSwgYmUgc3VyZSB0byBkZWxldGUKICAgICAgICAvLyBpdCBmcm9tIHJlbmRlcmVkIGl0ZW1zCiAgICAgICAgZGVsZXRlIHRoaXMucmVuZGVyZWRJdGVtc1tkYXRhSW5kZXhdOwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlSXRlbTogZnVuY3Rpb24oZGF0YUluZGV4KSB7CiAgICAgIC8vIERldGFjaCBhIGdpdmVuIGl0ZW0KICAgICAgdmFyIGl0ZW0gPSB0aGlzLnJlbmRlcmVkSXRlbXNbZGF0YUluZGV4XTsKICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICBpdGVtLnByaW1hcnlQb3MgPSBpdGVtLnNlY29uZGFyeVBvcyA9IG51bGw7CiAgICAgICAgdGhpcy5kYXRhU291cmNlLmRldGFjaEl0ZW0oaXRlbSk7CiAgICAgICAgZGVsZXRlIHRoaXMucmVuZGVyZWRJdGVtc1tkYXRhSW5kZXhdOwogICAgICB9CiAgICB9CiAgfTsKCiAgcmV0dXJuIENvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyOwp9XSk7CgoKZnVuY3Rpb24gZGVsZWdhdGVTZXJ2aWNlKG1ldGhvZE5hbWVzKSB7CiAgcmV0dXJuIFsnJGxvZycsIGZ1bmN0aW9uKCRsb2cpIHsKICAgIHZhciBkZWxlZ2F0ZSA9IHRoaXM7CgogICAgdmFyIGluc3RhbmNlcyA9IHRoaXMuX2luc3RhbmNlcyA9IFtdOwogICAgdGhpcy5fcmVnaXN0ZXJJbnN0YW5jZSA9IGZ1bmN0aW9uKGluc3RhbmNlLCBoYW5kbGUpIHsKICAgICAgaW5zdGFuY2UuJCRkZWxlZ2F0ZUhhbmRsZSA9IGhhbmRsZTsKICAgICAgaW5zdGFuY2VzLnB1c2goaW5zdGFuY2UpOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGRlcmVnaXN0ZXIoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gaW5zdGFuY2VzLmluZGV4T2YoaW5zdGFuY2UpOwogICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgIGluc3RhbmNlcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CgogICAgdGhpcy4kZ2V0QnlIYW5kbGUgPSBmdW5jdGlvbihoYW5kbGUpIHsKICAgICAgaWYgKCFoYW5kbGUpIHsKICAgICAgICByZXR1cm4gZGVsZWdhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBJbnN0YW5jZUZvckhhbmRsZShoYW5kbGUpOwogICAgfTsKCiAgICAvKgogICAgICogQ3JlYXRlcyBhIG5ldyBvYmplY3QgdGhhdCB3aWxsIGhhdmUgYWxsIHRoZSBtZXRob2ROYW1lcyBnaXZlbiwKICAgICAqIGFuZCBjYWxsIHRoZW0gb24gdGhlIGdpdmVuIHRoZSBjb250cm9sbGVyIGluc3RhbmNlIG1hdGNoaW5nIGdpdmVuCiAgICAgKiBoYW5kbGUuCiAgICAgKiBUaGUgcmVhc29uIHdlIGRvbid0IGp1c3QgbGV0ICRnZXRCeUhhbmRsZSByZXR1cm4gdGhlIGNvbnRyb2xsZXIgaW5zdGFuY2UKICAgICAqIGl0c2VsZiBpcyB0aGF0IHRoZSBjb250cm9sbGVyIGluc3RhbmNlIG1pZ2h0IG5vdCBleGlzdCB5ZXQuCiAgICAgKgogICAgICogV2Ugd2FudCBwZW9wbGUgdG8gYmUgYWJsZSB0byBkbwogICAgICogYHZhciBpbnN0YW5jZSA9ICRpb25pY1Njcm9sbERlbGVnYXRlLiRnZXRCeUhhbmRsZSgnZm9vJylgIG9uIGNvbnRyb2xsZXIKICAgICAqIGluc3RhbnRpYXRpb24sIGJ1dCBvbiBjb250cm9sbGVyIGluc3RhbnRpYXRpb24gYSBjaGlsZCBkaXJlY3RpdmUKICAgICAqIG1heSBub3QgaGF2ZSBiZWVuIGNvbXBpbGVkIHlldCEKICAgICAqCiAgICAgKiBTbyB0aGlzIGlzIG91ciB3YXkgb2Ygc29sdmluZyB0aGlzIHByb2JsZW06IHdlIGNyZWF0ZSBhbiBvYmplY3QKICAgICAqIHRoYXQgd2lsbCBvbmx5IHRyeSB0byBmZXRjaCB0aGUgY29udHJvbGxlciB3aXRoIGdpdmVuIGhhbmRsZQogICAgICogb25jZSB0aGUgbWV0aG9kcyBhcmUgYWN0dWFsbHkgY2FsbGVkLgogICAgICovCiAgICBmdW5jdGlvbiBJbnN0YW5jZUZvckhhbmRsZShoYW5kbGUpIHsKICAgICAgdGhpcy5oYW5kbGUgPSBoYW5kbGU7CiAgICB9CiAgICBtZXRob2ROYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgSW5zdGFuY2VGb3JIYW5kbGUucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGhhbmRsZSA9IHRoaXMuaGFuZGxlOwogICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICAgIHZhciBtYXRjaGluZ0luc3RhbmNlc0ZvdW5kID0gMDsKICAgICAgICB2YXIgZmluYWxSZXN1bHQ7CiAgICAgICAgdmFyIHJlc3VsdDsKCiAgICAgICAgLy9UaGlzIGxvZ2ljIGlzIHJlcGVhdGVkIGJlbG93OyB3ZSBjb3VsZCBmYWN0b3Igc29tZSBvZiBpdCBvdXQgdG8gYSBmdW5jdGlvbgogICAgICAgIC8vYnV0IGRvbid0IGJlY2F1c2UgaXQgbGV0cyB0aGlzIG1ldGhvZCBiZSBtb3JlIHBlcmZvcm1hbnQgKG9uZSBsb29wIHZlcnN1cyAyKQogICAgICAgIGluc3RhbmNlcy5mb3JFYWNoKGZ1bmN0aW9uKGluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2UuJCRkZWxlZ2F0ZUhhbmRsZSA9PT0gaGFuZGxlKSB7CiAgICAgICAgICAgIG1hdGNoaW5nSW5zdGFuY2VzRm91bmQrKzsKICAgICAgICAgICAgcmVzdWx0ID0gaW5zdGFuY2VbbWV0aG9kTmFtZV0uYXBwbHkoaW5zdGFuY2UsIGFyZ3MpOwogICAgICAgICAgICAvL09ubHkgcmV0dXJuIHRoZSB2YWx1ZSBmcm9tIHRoZSBmaXJzdCBjYWxsCiAgICAgICAgICAgIGlmIChtYXRjaGluZ0luc3RhbmNlc0ZvdW5kID09PSAxKSB7CiAgICAgICAgICAgICAgZmluYWxSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKCFtYXRjaGluZ0luc3RhbmNlc0ZvdW5kKSB7CiAgICAgICAgICByZXR1cm4gJGxvZy53YXJuKAogICAgICAgICAgICAnRGVsZWdhdGUgZm9yIGhhbmRsZSAiJyt0aGlzLmhhbmRsZSsnIiBjb3VsZCBub3QgZmluZCBhICcgKwogICAgICAgICAgICAnY29ycmVzcG9uZGluZyBlbGVtZW50IHdpdGggZGVsZWdhdGUtaGFuZGxlPSInK3RoaXMuaGFuZGxlKyciISAnICsKICAgICAgICAgICAgbWV0aG9kTmFtZSArICcoKSB3YXMgbm90IGNhbGxlZCFcbicgKwogICAgICAgICAgICAnUG9zc2libGUgY2F1c2U6IElmIHlvdSBhcmUgY2FsbGluZyAnICsgbWV0aG9kTmFtZSArICcoKSBpbW1lZGlhdGVseSwgYW5kICcgKwogICAgICAgICAgICAneW91ciBlbGVtZW50IHdpdGggZGVsZWdhdGUtaGFuZGxlPSInICsgdGhpcy5oYW5kbGUgKyAnIiBpcyBhIGNoaWxkIG9mIHlvdXIgJyArCiAgICAgICAgICAgICdjb250cm9sbGVyLCB0aGVuIHlvdXIgZWxlbWVudCBtYXkgbm90IGJlIGNvbXBpbGVkIHlldC4gUHV0IGEgJHRpbWVvdXQgJyArCiAgICAgICAgICAgICdhcm91bmQgeW91ciBjYWxsIHRvICcgKyBtZXRob2ROYW1lICsgJygpIGFuZCB0cnkgYWdhaW4uJwogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmaW5hbFJlc3VsdDsKICAgICAgfTsKICAgICAgZGVsZWdhdGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICB2YXIgZmluYWxSZXN1bHQ7CiAgICAgICAgdmFyIHJlc3VsdDsKCiAgICAgICAgLy9UaGlzIGxvZ2ljIGlzIHJlcGVhdGVkIGFib3ZlCiAgICAgICAgaW5zdGFuY2VzLmZvckVhY2goZnVuY3Rpb24oaW5zdGFuY2UsIGluZGV4KSB7CiAgICAgICAgICByZXN1bHQgPSBpbnN0YW5jZVttZXRob2ROYW1lXS5hcHBseShpbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAvL09ubHkgcmV0dXJuIHRoZSB2YWx1ZSBmcm9tIHRoZSBmaXJzdCBjYWxsCiAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICAgICAgZmluYWxSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBmaW5hbFJlc3VsdDsKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIGNhbGxNZXRob2QoaW5zdGFuY2VzVG9Vc2UsIG1ldGhvZE5hbWUsIGFyZ3MpIHsKICAgICAgICB2YXIgZmluYWxSZXN1bHQ7CiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICBpbnN0YW5jZXNUb1VzZS5mb3JFYWNoKGZ1bmN0aW9uKGluc3RhbmNlLCBpbmRleCkgewogICAgICAgICAgcmVzdWx0ID0gaW5zdGFuY2VbbWV0aG9kTmFtZV0uYXBwbHkoaW5zdGFuY2UsIGFyZ3MpOwogICAgICAgICAgLy9NYWtlIGl0IHNvIHRoZSBmaXJzdCByZXN1bHQgaXMgdGhlIG9uZSByZXR1cm5lZAogICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGZpbmFsUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmaW5hbFJlc3VsdDsKICAgICAgfQogICAgfSk7CiAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNHZXN0dXJlCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uIEFuIGFuZ3VsYXIgc2VydmljZSBleHBvc2luZyBpb25pYwogKiB7QGxpbmsgaW9uaWMudXRpbGl0eTppb25pYy5FdmVudENvbnRyb2xsZXJ9J3MgZ2VzdHVyZXMuCiAqLwpJb25pY01vZHVsZQouZmFjdG9yeSgnJGlvbmljR2VzdHVyZScsIFtmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNHZXN0dXJlI29uCiAgICAgKiBAZGVzY3JpcHRpb24gQWRkIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIGdlc3R1cmUgb24gYW4gZWxlbWVudC4gU2VlIHtAbGluayBpb25pYy51dGlsaXR5OmlvbmljLkV2ZW50Q29udHJvbGxlciNvbkdlc3R1cmV9LgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZ2VzdHVyZSBldmVudCB0byBsaXN0ZW4gZm9yLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihlKX0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgZ2VzdHVyZQogICAgICogaGFwcGVucy4KICAgICAqIEBwYXJhbSB7ZWxlbWVudH0gJGVsZW1lbnQgVGhlIGFuZ3VsYXIgZWxlbWVudCB0byBsaXN0ZW4gZm9yIHRoZSBldmVudCBvbi4KICAgICAqIEByZXR1cm5zIHtpb25pYy5HZXN0dXJlfSBUaGUgZ2VzdHVyZSBvYmplY3QgKHVzZSB0aGlzIHRvIHJlbW92ZSB0aGUgZ2VzdHVyZSBsYXRlciBvbikuCiAgICAgKi8KICAgIG9uOiBmdW5jdGlvbihldmVudFR5cGUsIGNiLCAkZWxlbWVudCwgb3B0aW9ucykgewogICAgICByZXR1cm4gd2luZG93LmlvbmljLm9uR2VzdHVyZShldmVudFR5cGUsIGNiLCAkZWxlbWVudFswXSwgb3B0aW9ucyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNHZXN0dXJlI29mZgogICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBnZXN0dXJlIG9uIGFuIGVsZW1lbnQuIFNlZSB7QGxpbmsgaW9uaWMudXRpbGl0eTppb25pYy5FdmVudENvbnRyb2xsZXIjb2ZmR2VzdHVyZX0uCiAgICAgKiBAcGFyYW0ge2lvbmljLkdlc3R1cmV9IGdlc3R1cmUgVGhlIGdlc3R1cmUgdGhhdCBzaG91bGQgYmUgcmVtb3ZlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudFR5cGUgVGhlIGdlc3R1cmUgZXZlbnQgdG8gcmVtb3ZlIHRoZSBsaXN0ZW5lciBmb3IuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGUpfSBjYWxsYmFjayBUaGUgbGlzdGVuZXIgdG8gcmVtb3ZlLgogICAgICovCiAgICBvZmY6IGZ1bmN0aW9uKGdlc3R1cmUsIGV2ZW50VHlwZSwgY2IpIHsKICAgICAgcmV0dXJuIHdpbmRvdy5pb25pYy5vZmZHZXN0dXJlKGdlc3R1cmUsIGV2ZW50VHlwZSwgY2IpOwogICAgfQogIH07Cn1dKTsKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGlvbmljQ29uZmlnUHJvdmlkZXIKICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24gJGlvbmljQ29uZmlnUHJvdmlkZXIgY2FuIGJlIHVzZWQgZHVyaW5nIHRoZSBjb25maWd1cmF0aW9uIHBoYXNlIG9mIHlvdXIgYXBwCiAqIHRvIGNoYW5nZSBob3cgSW9uaWMgd29ya3MuCiAqCiAqIEB1c2FnZQogKiBgYGBqcwogKiB2YXIgbXlBcHAgPSBhbmd1bGFyLm1vZHVsZSgncmVhbGx5Q29vbEFwcCcsIFsnaW9uaWMnXSk7CiAqCiAqIG15QXBwLmNvbmZpZyhmdW5jdGlvbigkaW9uaWNDb25maWdQcm92aWRlcikgewogKiAgICRpb25pY0NvbmZpZ1Byb3ZpZGVyLnByZWZldGNoVGVtcGxhdGVzKGZhbHNlKTsKICogfSk7CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLnByb3ZpZGVyKCckaW9uaWNDb25maWcnLCBmdW5jdGlvbigpIHsKCiAgdmFyIHByb3ZpZGVyID0gdGhpczsKICB2YXIgY29uZmlnID0gewogICAgcHJlZmV0Y2hUZW1wbGF0ZXM6IHRydWUKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljQ29uZmlnUHJvdmlkZXIjcHJlZmV0Y2hUZW1wbGF0ZXMKICAgKiBAZGVzY3JpcHRpb24gU2V0IHdoZXRoZXIgSW9uaWMgc2hvdWxkIHByZWZldGNoIGFsbCB0ZW1wbGF0ZVVybHMgZGVmaW5lZCBpbgogICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlLiBEZWZhdWx0IHRydWUuIElmIHNldCB0byBmYWxzZSwgdGhlIHVzZXIgd2lsbCBoYXZlIHRvIHdhaXQKICAgKiBmb3IgYSB0ZW1wbGF0ZSB0byBiZSBmZXRjaGVkIHRoZSBmaXJzdCB0aW1lIGhlL3NoZSBpcyBnb2luZyB0byBhIGEgbmV3IHBhZ2UuCiAgICogQHBhcmFtIHNob3VsZFByZWZldGNoIFdoZXRoZXIgSW9uaWMgc2hvdWxkIHByZWZldGNoIHRlbXBsYXRlVXJscyBkZWZpbmVkIGluCiAgICogYCRzdGF0ZVByb3ZpZGVyLnN0YXRlKClgLiBEZWZhdWx0IHRydWUuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgSW9uaWMgd2lsbCBwcmVmZXRjaCB0ZW1wbGF0ZVVybHMgZGVmaW5lZCBpbiAkc3RhdGVQcm92aWRlci5zdGF0ZS4KICAgKi8KICB0aGlzLnByZWZldGNoVGVtcGxhdGVzID0gZnVuY3Rpb24obmV3VmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGNvbmZpZy5wcmVmZXRjaFRlbXBsYXRlcyA9IG5ld1ZhbHVlOwogICAgfQogICAgcmV0dXJuIGNvbmZpZy5wcmVmZXRjaFRlbXBsYXRlczsKICB9OwoKICAvLyBwcml2YXRlOiBTZXJ2aWNlIGRlZmluaXRpb24gZm9yIGludGVybmFsIElvbmljIHVzZQogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljQ29uZmlnCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBwcml2YXRlCiAgICovCiAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29uZmlnOwogIH07Cn0pOwoKCnZhciBMT0FESU5HX1RQTCA9CiAgJzxkaXYgY2xhc3M9ImxvYWRpbmctY29udGFpbmVyIj4nICsKICAgICc8ZGl2IGNsYXNzPSJsb2FkaW5nIj4nICsKICAgICc8L2Rpdj4nICsKICAnPC9kaXY+JzsKCnZhciBMT0FESU5HX0hJREVfREVQUkVDQVRFRCA9ICckaW9uaWNMb2FkaW5nIGluc3RhbmNlLmhpZGUoKSBoYXMgYmVlbiBkZXByZWNhdGVkLiBVc2UgJGlvbmljTG9hZGluZy5oaWRlKCkuJzsKdmFyIExPQURJTkdfU0hPV19ERVBSRUNBVEVEID0gJyRpb25pY0xvYWRpbmcgaW5zdGFuY2Uuc2hvdygpIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIFVzZSAkaW9uaWNMb2FkaW5nLnNob3coKS4nOwp2YXIgTE9BRElOR19TRVRfREVQUkVDQVRFRCA9ICckaW9uaWNMb2FkaW5nIGluc3RhbmNlLnNldENvbnRlbnQoKSBoYXMgYmVlbiBkZXByZWNhdGVkLiBVc2UgJGlvbmljTG9hZGluZy5zaG93KHsgdGVtcGxhdGU6IFwnbXkgY29udGVudFwnIH0pLic7CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljTG9hZGluZwogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKiBBbiBvdmVybGF5IHRoYXQgY2FuIGJlIHVzZWQgdG8gaW5kaWNhdGUgYWN0aXZpdHkgd2hpbGUgYmxvY2tpbmcgdXNlcgogKiBpbnRlcmFjdGlvbi4KICoKICogQHVzYWdlCiAqIGBgYGpzCiAqIGFuZ3VsYXIubW9kdWxlKCdMb2FkaW5nQXBwJywgWydpb25pYyddKQogKiAuY29udHJvbGxlcignTG9hZGluZ0N0cmwnLCBmdW5jdGlvbigkc2NvcGUsICRpb25pY0xvYWRpbmcpIHsKICogICAkc2NvcGUuc2hvdyA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljTG9hZGluZy5zaG93KHsKICogICAgICAgdGVtcGxhdGU6ICdMb2FkaW5nLi4uJwogKiAgICAgfSk7CiAqICAgfTsKICogICAkc2NvcGUuaGlkZSA9IGZ1bmN0aW9uKCl7CiAqICAgICAkaW9uaWNMb2FkaW5nLmhpZGUoKTsKICogICB9OwogKiB9KTsKICogYGBgCiAqLwovKioKICogQG5nZG9jIG9iamVjdAogKiBAbmFtZSAkaW9uaWNMb2FkaW5nQ29uZmlnCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqIFNldCB0aGUgZGVmYXVsdCBvcHRpb25zIHRvIGJlIHBhc3NlZCB0byB0aGUge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTG9hZGluZ30gc2VydmljZS4KICoKICogQHVzYWdlCiAqIGBgYGpzCiAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbJ2lvbmljJ10pCiAqIGFwcC5jb25zdGFudCgnJGlvbmljTG9hZGluZ0NvbmZpZycsIHsKICogICB0ZW1wbGF0ZTogJ0RlZmF1bHQgTG9hZGluZyBUZW1wbGF0ZS4uLicKICogfSk7CiAqIGFwcC5jb250cm9sbGVyKCdBcHBDdHJsJywgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNMb2FkaW5nKSB7CiAqICAgJHNjb3BlLnNob3dMb2FkaW5nID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNMb2FkaW5nLnNob3coKTsgLy9vcHRpb25zIGRlZmF1bHQgdG8gdmFsdWVzIGluICRpb25pY0xvYWRpbmdDb25maWcKICogICB9OwogKiB9KTsKICogYGBgCiAqLwpJb25pY01vZHVsZQouY29uc3RhbnQoJyRpb25pY0xvYWRpbmdDb25maWcnLCB7CiAgdGVtcGxhdGU6ICc8aSBjbGFzcz0iaW9uLWxvYWRpbmctZCI+PC9pPicKfSkKLmZhY3RvcnkoJyRpb25pY0xvYWRpbmcnLCBbCiAgJyRpb25pY0xvYWRpbmdDb25maWcnLAogICckaW9uaWNCb2R5JywKICAnJGlvbmljVGVtcGxhdGVMb2FkZXInLAogICckaW9uaWNCYWNrZHJvcCcsCiAgJyR0aW1lb3V0JywKICAnJHEnLAogICckbG9nJywKICAnJGNvbXBpbGUnLAogICckaW9uaWNQbGF0Zm9ybScsCmZ1bmN0aW9uKCRpb25pY0xvYWRpbmdDb25maWcsICRpb25pY0JvZHksICRpb25pY1RlbXBsYXRlTG9hZGVyLCAkaW9uaWNCYWNrZHJvcCwgJHRpbWVvdXQsICRxLCAkbG9nLCAkY29tcGlsZSwgJGlvbmljUGxhdGZvcm0pIHsKCiAgdmFyIGxvYWRlckluc3RhbmNlOwogIC8vZGVmYXVsdCB2YWx1ZXMKICB2YXIgZGVyZWdpc3RlckJhY2tBY3Rpb24gPSBhbmd1bGFyLm5vb3A7CiAgdmFyIGxvYWRpbmdTaG93RGVsYXkgPSAkcS53aGVuKCk7CgogIHJldHVybiB7CiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0xvYWRpbmcjc2hvdwogICAgICogQGRlc2NyaXB0aW9uIFNob3dzIGEgbG9hZGluZyBpbmRpY2F0b3IuIElmIHRoZSBpbmRpY2F0b3IgaXMgYWxyZWFkeSBzaG93biwKICAgICAqIGl0IHdpbGwgc2V0IHRoZSBvcHRpb25zIGdpdmVuIGFuZCBrZWVwIHRoZSBpbmRpY2F0b3Igc2hvd24uCiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0cyBUaGUgb3B0aW9ucyBmb3IgdGhlIGxvYWRpbmcgaW5kaWNhdG9yLiBBdmFpbGFibGUgcHJvcGVydGllczoKICAgICAqICAtIGB7c3RyaW5nPX1gIGB0ZW1wbGF0ZWAgVGhlIGh0bWwgY29udGVudCBvZiB0aGUgaW5kaWNhdG9yLgogICAgICogIC0gYHtzdHJpbmc9fWAgYHRlbXBsYXRlVXJsYCBUaGUgdXJsIG9mIGFuIGh0bWwgdGVtcGxhdGUgdG8gbG9hZCBhcyB0aGUgY29udGVudCBvZiB0aGUgaW5kaWNhdG9yLgogICAgICogIC0gYHtib29sZWFuPX1gIGBub0JhY2tkcm9wYCBXaGV0aGVyIHRvIGhpZGUgdGhlIGJhY2tkcm9wLiBCeSBkZWZhdWx0IGl0IHdpbGwgYmUgc2hvd24uCiAgICAgKiAgLSBge251bWJlcj19YCBgZGVsYXlgIEhvdyBtYW55IG1pbGxpc2Vjb25kcyB0byBkZWxheSBzaG93aW5nIHRoZSBpbmRpY2F0b3IuIEJ5IGRlZmF1bHQgdGhlcmUgaXMgbm8gZGVsYXkuCiAgICAgKiAgLSBge251bWJlcj19YCBgZHVyYXRpb25gIEhvdyBtYW55IG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIGF1dG9tYXRpY2FsbHkKICAgICAqICBoaWRpbmcgdGhlIGluZGljYXRvci4gQnkgZGVmYXVsdCwgdGhlIGluZGljYXRvciB3aWxsIGJlIHNob3duIHVudGlsIGAuaGlkZSgpYCBpcyBjYWxsZWQuCiAgICAgKi8KICAgIHNob3c6IHNob3dMb2FkZXIsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0xvYWRpbmcjaGlkZQogICAgICogQGRlc2NyaXB0aW9uIEhpZGVzIHRoZSBsb2FkaW5nIGluZGljYXRvciwgaWYgc2hvd24uCiAgICAgKi8KICAgIGhpZGU6IGhpZGVMb2FkZXIsCiAgICAvKioKICAgICAqIEBwcml2YXRlIGZvciB0ZXN0aW5nCiAgICAgKi8KICAgIF9nZXRMb2FkZXI6IGdldExvYWRlcgogIH07CgogIGZ1bmN0aW9uIGdldExvYWRlcigpIHsKICAgIGlmICghbG9hZGVySW5zdGFuY2UpIHsKICAgICAgbG9hZGVySW5zdGFuY2UgPSAkaW9uaWNUZW1wbGF0ZUxvYWRlci5jb21waWxlKHsKICAgICAgICB0ZW1wbGF0ZTogTE9BRElOR19UUEwsCiAgICAgICAgYXBwZW5kVG86ICRpb25pY0JvZHkuZ2V0KCkKICAgICAgfSkKICAgICAgLnRoZW4oZnVuY3Rpb24obG9hZGVyKSB7CiAgICAgICAgdmFyIHNlbGYgPSBsb2FkZXI7CgogICAgICAgIGxvYWRlci5zaG93ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgdmFyIHRlbXBsYXRlUHJvbWlzZSA9IG9wdGlvbnMudGVtcGxhdGVVcmwgPwogICAgICAgICAgICAkaW9uaWNUZW1wbGF0ZUxvYWRlci5sb2FkKG9wdGlvbnMudGVtcGxhdGVVcmwpIDoKICAgICAgICAgICAgLy9vcHRpb25zLmNvbnRlbnQ6IGRlcHJlY2F0ZWQKICAgICAgICAgICAgJHEud2hlbihvcHRpb25zLnRlbXBsYXRlIHx8IG9wdGlvbnMuY29udGVudCB8fCAnJyk7CgoKICAgICAgICAgIGlmICghdGhpcy5pc1Nob3duKSB7CiAgICAgICAgICAgIC8vb3B0aW9ucy5zaG93QmFja2Ryb3A6IGRlcHJlY2F0ZWQKICAgICAgICAgICAgdGhpcy5oYXNCYWNrZHJvcCA9ICFvcHRpb25zLm5vQmFja2Ryb3AgJiYgb3B0aW9ucy5zaG93QmFja2Ryb3AgIT09IGZhbHNlOwogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWNrZHJvcCkgewogICAgICAgICAgICAgICRpb25pY0JhY2tkcm9wLnJldGFpbigpOwogICAgICAgICAgICAgICRpb25pY0JhY2tkcm9wLmdldEVsZW1lbnQoKS5hZGRDbGFzcygnYmFja2Ryb3AtbG9hZGluZycpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG9wdGlvbnMuZHVyYXRpb24pIHsKICAgICAgICAgICAgJHRpbWVvdXQuY2FuY2VsKHRoaXMuZHVyYXRpb25UaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvblRpbWVvdXQgPSAkdGltZW91dCgKICAgICAgICAgICAgICBhbmd1bGFyLmJpbmQodGhpcywgdGhpcy5oaWRlKSwKICAgICAgICAgICAgICArb3B0aW9ucy5kdXJhdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgfQoKICAgICAgICAgIHRlbXBsYXRlUHJvbWlzZS50aGVuKGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgICAgICAgaWYgKGh0bWwpIHsKICAgICAgICAgICAgICB2YXIgbG9hZGluZyA9IHNlbGYuZWxlbWVudC5jaGlsZHJlbigpOwogICAgICAgICAgICAgIGxvYWRpbmcuaHRtbChodG1sKTsKICAgICAgICAgICAgICAkY29tcGlsZShsb2FkaW5nLmNvbnRlbnRzKCkpKHNlbGYuc2NvcGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL0Rvbid0IHNob3cgdW50aWwgdGVtcGxhdGUgY2hhbmdlcwogICAgICAgICAgICBpZiAoc2VsZi5pc1Nob3duKSB7CiAgICAgICAgICAgICAgc2VsZi5lbGVtZW50LmFkZENsYXNzKCd2aXNpYmxlJyk7CiAgICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYoc2VsZi5pc1Nob3duKSB7CiAgICAgICAgICAgICAgICAgIHNlbGYuZWxlbWVudC5hZGRDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICRpb25pY0JvZHkuYWRkQ2xhc3MoJ2xvYWRpbmctYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHRoaXMuaXNTaG93biA9IHRydWU7CiAgICAgICAgfTsKICAgICAgICBsb2FkZXIuaGlkZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHRoaXMuaXNTaG93bikgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWNrZHJvcCkgewogICAgICAgICAgICAgICRpb25pY0JhY2tkcm9wLnJlbGVhc2UoKTsKICAgICAgICAgICAgICAkaW9uaWNCYWNrZHJvcC5nZXRFbGVtZW50KCkucmVtb3ZlQ2xhc3MoJ2JhY2tkcm9wLWxvYWRpbmcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICAkaW9uaWNCb2R5LnJlbW92ZUNsYXNzKCdsb2FkaW5nLWFjdGl2ZScpOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICFzZWxmLmlzU2hvd24gJiYgc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCd2aXNpYmxlJyk7CiAgICAgICAgICAgIH0sIDIwMCk7CiAgICAgICAgICB9CiAgICAgICAgICAkdGltZW91dC5jYW5jZWwodGhpcy5kdXJhdGlvblRpbWVvdXQpOwogICAgICAgICAgdGhpcy5pc1Nob3duID0gZmFsc2U7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGxvYWRlcjsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbG9hZGVySW5zdGFuY2U7CiAgfQoKICBmdW5jdGlvbiBzaG93TG9hZGVyKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBleHRlbmQoJGlvbmljTG9hZGluZ0NvbmZpZyB8fCB7fSwgb3B0aW9ucyB8fCB7fSk7CiAgICB2YXIgZGVsYXkgPSBvcHRpb25zLmRlbGF5IHx8IG9wdGlvbnMuc2hvd0RlbGF5IHx8IDA7CgogICAgLy9JZiBsb2FkaW5nLnNob3coKSB3YXMgY2FsbGVkIHByZXZpb3VzbHksIGNhbmNlbCBpdCBhbmQgc2hvdyB3aXRoIG91ciBuZXcgb3B0aW9ucwogICAgbG9hZGluZ1Nob3dEZWxheSAmJiAkdGltZW91dC5jYW5jZWwobG9hZGluZ1Nob3dEZWxheSk7CiAgICBsb2FkaW5nU2hvd0RlbGF5ID0gJHRpbWVvdXQoYW5ndWxhci5ub29wLCBkZWxheSk7CgogICAgbG9hZGluZ1Nob3dEZWxheS50aGVuKGdldExvYWRlcikudGhlbihmdW5jdGlvbihsb2FkZXIpIHsKICAgICAgZGVyZWdpc3RlckJhY2tBY3Rpb24oKTsKICAgICAgLy9EaXNhYmxlIGhhcmR3YXJlIGJhY2sgYnV0dG9uIHdoaWxlIGxvYWRpbmcKICAgICAgZGVyZWdpc3RlckJhY2tBY3Rpb24gPSAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICAgICAgYW5ndWxhci5ub29wLAogICAgICAgIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX0xPQURJTkcKICAgICAgKTsKICAgICAgcmV0dXJuIGxvYWRlci5zaG93KG9wdGlvbnMpOwogICAgfSk7CgogICAgcmV0dXJuIHsKICAgICAgaGlkZTogZGVwcmVjYXRlZC5tZXRob2QoTE9BRElOR19ISURFX0RFUFJFQ0FURUQsICRsb2cuZXJyb3IsIGhpZGVMb2FkZXIpLAogICAgICBzaG93OiBkZXByZWNhdGVkLm1ldGhvZChMT0FESU5HX1NIT1dfREVQUkVDQVRFRCwgJGxvZy5lcnJvciwgZnVuY3Rpb24oKSB7CiAgICAgICAgc2hvd0xvYWRlcihvcHRpb25zKTsKICAgICAgfSksCiAgICAgIHNldENvbnRlbnQ6IGRlcHJlY2F0ZWQubWV0aG9kKExPQURJTkdfU0VUX0RFUFJFQ0FURUQsICRsb2cuZXJyb3IsIGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgICBnZXRMb2FkZXIoKS50aGVuKGZ1bmN0aW9uKGxvYWRlcikgewogICAgICAgICAgbG9hZGVyLnNob3coeyB0ZW1wbGF0ZTogY29udGVudCB9KTsKICAgICAgICB9KTsKICAgICAgfSkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBoaWRlTG9hZGVyKCkgewogICAgZGVyZWdpc3RlckJhY2tBY3Rpb24oKTsKICAgICR0aW1lb3V0LmNhbmNlbChsb2FkaW5nU2hvd0RlbGF5KTsKICAgIGdldExvYWRlcigpLnRoZW4oZnVuY3Rpb24obG9hZGVyKSB7CiAgICAgIGxvYWRlci5oaWRlKCk7CiAgICB9KTsKICB9Cn1dKTsKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNNb2RhbAogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWxhdGVkOiB7QGxpbmsgaW9uaWMuY29udHJvbGxlcjppb25pY01vZGFsIGlvbmljTW9kYWwgY29udHJvbGxlcn0uCiAqCiAqIFRoZSBNb2RhbCBpcyBhIGNvbnRlbnQgcGFuZSB0aGF0IGNhbiBnbyBvdmVyIHRoZSB1c2VyJ3MgbWFpbiB2aWV3CiAqIHRlbXBvcmFyaWx5LiAgVXN1YWxseSB1c2VkIGZvciBtYWtpbmcgYSBjaG9pY2Ugb3IgZWRpdGluZyBhbiBpdGVtLgogKgogKiBQdXQgdGhlIGNvbnRlbnQgb2YgdGhlIG1vZGFsIGluc2lkZSBvZiBhbiBgPGlvbi1tb2RhbC12aWV3PmAgZWxlbWVudC4KICoKICogTm90ZTogYSBtb2RhbCB3aWxsIGJyb2FkY2FzdCAnbW9kYWwuc2hvd24nLCAnbW9kYWwuaGlkZGVuJywgYW5kICdtb2RhbC5yZW1vdmVkJyBldmVudHMgZnJvbSBpdHMgb3JpZ2luYXRpbmcKICogc2NvcGUsIHBhc3NpbmcgaW4gaXRzZWxmIGFzIGFuIGV2ZW50IGFyZ3VtZW50LiBCb3RoIHRoZSBtb2RhbC5yZW1vdmVkIGFuZCBtb2RhbC5oaWRkZW4gZXZlbnRzIGFyZQogKiBjYWxsZWQgd2hlbiB0aGUgbW9kYWwgaXMgcmVtb3ZlZC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPHNjcmlwdCBpZD0ibXktbW9kYWwuaHRtbCIgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSI+CiAqICAgPGlvbi1tb2RhbC12aWV3PgogKiAgICAgPGlvbi1oZWFkZXItYmFyPgogKiAgICAgICA8aDEgY2xhc3M9InRpdGxlIj5NeSBNb2RhbCB0aXRsZTwvaDE+CiAqICAgICA8L2lvbi1oZWFkZXItYmFyPgogKiAgICAgPGlvbi1jb250ZW50PgogKiAgICAgICBIZWxsbyEKICogICAgIDwvaW9uLWNvbnRlbnQ+CiAqICAgPC9pb24tbW9kYWwtdmlldz4KICogPC9zY3JpcHQ+CiAqIGBgYAogKiBgYGBqcwogKiBhbmd1bGFyLm1vZHVsZSgndGVzdEFwcCcsIFsnaW9uaWMnXSkKICogLmNvbnRyb2xsZXIoJ015Q29udHJvbGxlcicsIGZ1bmN0aW9uKCRzY29wZSwgJGlvbmljTW9kYWwpIHsKICogICAkaW9uaWNNb2RhbC5mcm9tVGVtcGxhdGVVcmwoJ215LW1vZGFsLmh0bWwnLCB7CiAqICAgICBzY29wZTogJHNjb3BlLAogKiAgICAgYW5pbWF0aW9uOiAnc2xpZGUtaW4tdXAnCiAqICAgfSkudGhlbihmdW5jdGlvbihtb2RhbCkgewogKiAgICAgJHNjb3BlLm1vZGFsID0gbW9kYWw7CiAqICAgfSk7CiAqICAgJHNjb3BlLm9wZW5Nb2RhbCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJHNjb3BlLm1vZGFsLnNob3coKTsKICogICB9OwogKiAgICRzY29wZS5jbG9zZU1vZGFsID0gZnVuY3Rpb24oKSB7CiAqICAgICAkc2NvcGUubW9kYWwuaGlkZSgpOwogKiAgIH07CiAqICAgLy9DbGVhbnVwIHRoZSBtb2RhbCB3aGVuIHdlJ3JlIGRvbmUgd2l0aCBpdCEKICogICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogKiAgICAgJHNjb3BlLm1vZGFsLnJlbW92ZSgpOwogKiAgIH0pOwogKiAgIC8vIEV4ZWN1dGUgYWN0aW9uIG9uIGhpZGUgbW9kYWwKICogICAkc2NvcGUuJG9uKCdtb2RhbC5oaWRkZW4nLCBmdW5jdGlvbigpIHsKICogICAgIC8vIEV4ZWN1dGUgYWN0aW9uCiAqICAgfSk7CiAqICAgLy8gRXhlY3V0ZSBhY3Rpb24gb24gcmVtb3ZlIG1vZGFsCiAqICAgJHNjb3BlLiRvbignbW9kYWwucmVtb3ZlZCcsIGZ1bmN0aW9uKCkgewogKiAgICAgLy8gRXhlY3V0ZSBhY3Rpb24KICogICB9KTsKICogfSk7CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY01vZGFsJywgWwogICckcm9vdFNjb3BlJywKICAnJGlvbmljQm9keScsCiAgJyRjb21waWxlJywKICAnJHRpbWVvdXQnLAogICckaW9uaWNQbGF0Zm9ybScsCiAgJyRpb25pY1RlbXBsYXRlTG9hZGVyJywKICAnJHEnLAogICckbG9nJywKZnVuY3Rpb24oJHJvb3RTY29wZSwgJGlvbmljQm9keSwgJGNvbXBpbGUsICR0aW1lb3V0LCAkaW9uaWNQbGF0Zm9ybSwgJGlvbmljVGVtcGxhdGVMb2FkZXIsICRxLCAkbG9nKSB7CgogIC8qKgogICAqIEBuZ2RvYyBjb250cm9sbGVyCiAgICogQG5hbWUgaW9uaWNNb2RhbAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJbnN0YW50aWF0ZWQgYnkgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY01vZGFsfSBzZXJ2aWNlLgogICAqCiAgICogQmUgc3VyZSB0byBjYWxsIFtyZW1vdmUoKV0oI3JlbW92ZSkgd2hlbiB5b3UgYXJlIGRvbmUgd2l0aCBlYWNoIG1vZGFsCiAgICogdG8gY2xlYW4gaXQgdXAgYW5kIGF2b2lkIG1lbW9yeSBsZWFrcy4KICAgKgogICAqIE5vdGU6IGEgbW9kYWwgd2lsbCBicm9hZGNhc3QgJ21vZGFsLnNob3duJywgJ21vZGFsLmhpZGRlbicsIGFuZCAnbW9kYWwucmVtb3ZlZCcgZXZlbnRzIGZyb20gaXRzIG9yaWdpbmF0aW5nCiAgICogc2NvcGUsIHBhc3NpbmcgaW4gaXRzZWxmIGFzIGFuIGV2ZW50IGFyZ3VtZW50LiBOb3RlOiBib3RoIG1vZGFsLnJlbW92ZWQgYW5kIG1vZGFsLmhpZGRlbiBhcmUKICAgKiBjYWxsZWQgd2hlbiB0aGUgbW9kYWwgaXMgcmVtb3ZlZC4KICAgKi8KICB2YXIgTW9kYWxWaWV3ID0gaW9uaWMudmlld3MuTW9kYWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljTW9kYWwjaW5pdGlhbGl6ZQogICAgICogQGRlc2NyaXB0aW9uIENyZWF0ZXMgYSBuZXcgbW9kYWwgY29udHJvbGxlciBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIEFuIG9wdGlvbnMgb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICogIC0gYHtvYmplY3Q9fWAgYHNjb3BlYCBUaGUgc2NvcGUgdG8gYmUgYSBjaGlsZCBvZi4KICAgICAqICAgIERlZmF1bHQ6IGNyZWF0ZXMgYSBjaGlsZCBvZiAkcm9vdFNjb3BlLgogICAgICogIC0gYHtzdHJpbmc9fWAgYGFuaW1hdGlvbmAgVGhlIGFuaW1hdGlvbiB0byBzaG93ICYgaGlkZSB3aXRoLgogICAgICogICAgRGVmYXVsdDogJ3NsaWRlLWluLXVwJwogICAgICogIC0gYHtib29sZWFuPX1gIGBmb2N1c0ZpcnN0SW5wdXRgIFdoZXRoZXIgdG8gYXV0b2ZvY3VzIHRoZSBmaXJzdCBpbnB1dCBvZgogICAgICogICAgdGhlIG1vZGFsIHdoZW4gc2hvd24uICBEZWZhdWx0OiBmYWxzZS4KICAgICAqICAtIGB7Ym9vbGVhbj19YCBgYmFja2Ryb3BDbGlja1RvQ2xvc2VgIFdoZXRoZXIgdG8gY2xvc2UgdGhlIG1vZGFsIG9uIGNsaWNraW5nIHRoZSBiYWNrZHJvcC4KICAgICAqICAgIERlZmF1bHQ6IHRydWUuCiAgICAgKiAgLSBge2Jvb2xlYW49fWAgYGhhcmR3YXJlQmFja0J1dHRvbkNsb3NlYCBXaGV0aGVyIHRoZSBtb2RhbCBjYW4gYmUgY2xvc2VkIHVzaW5nIHRoZSBoYXJkd2FyZQogICAgICogICAgYmFjayBidXR0b24gb24gQW5kcm9pZCBhbmQgc2ltaWxhciBkZXZpY2VzLiAgRGVmYXVsdDogdHJ1ZS4KICAgICAqLwogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICBpb25pYy52aWV3cy5Nb2RhbC5wcm90b3R5cGUuaW5pdGlhbGl6ZS5jYWxsKHRoaXMsIG9wdHMpOwogICAgICB0aGlzLmFuaW1hdGlvbiA9IG9wdHMuYW5pbWF0aW9uIHx8ICdzbGlkZS1pbi11cCc7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgaW9uaWNNb2RhbCNzaG93CiAgICAgKiBAZGVzY3JpcHRpb24gU2hvdyB0aGlzIG1vZGFsIGluc3RhbmNlLgogICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBtb2RhbCBpcyBmaW5pc2hlZCBhbmltYXRpbmcgaW4uCiAgICAgKi8KICAgIHNob3c6IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICBpZihzZWxmLnNjb3BlLiQkZGVzdHJveWVkKSB7CiAgICAgICAgJGxvZy5lcnJvcignQ2Fubm90IGNhbGwgJyArICBzZWxmLnZpZXdUeXBlICsgJy5zaG93KCkgYWZ0ZXIgcmVtb3ZlKCkuIFBsZWFzZSBjcmVhdGUgYSBuZXcgJyArICBzZWxmLnZpZXdUeXBlICsgJyBpbnN0YW5jZS4nKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBtb2RhbEVsID0ganFMaXRlKHNlbGYubW9kYWxFbCk7CgogICAgICBzZWxmLmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGUnKTsKICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAkaW9uaWNCb2R5LmFkZENsYXNzKHNlbGYudmlld1R5cGUgKyAnLW9wZW4nKTsKICAgICAgfSwgNDAwKTsKCiAgICAgIGlmKCFzZWxmLmVsLnBhcmVudEVsZW1lbnQpIHsKICAgICAgICBtb2RhbEVsLmFkZENsYXNzKHNlbGYuYW5pbWF0aW9uKTsKICAgICAgICAkaW9uaWNCb2R5LmFwcGVuZChzZWxmLmVsKTsKICAgICAgfQoKICAgICAgaWYodGFyZ2V0ICYmIHNlbGYucG9zaXRpb25WaWV3KSB7CiAgICAgICAgc2VsZi5wb3NpdGlvblZpZXcodGFyZ2V0LCBtb2RhbEVsKTsKICAgICAgfQoKICAgICAgbW9kYWxFbC5hZGRDbGFzcygnbmctZW50ZXIgYWN0aXZlJykKICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnbmctbGVhdmUgbmctbGVhdmUtYWN0aXZlJyk7CgogICAgICBzZWxmLl9pc1Nob3duID0gdHJ1ZTsKICAgICAgc2VsZi5fZGVyZWdpc3RlckJhY2tCdXR0b24gPSAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICAgICAgc2VsZi5oYXJkd2FyZUJhY2tCdXR0b25DbG9zZSA/IGFuZ3VsYXIuYmluZChzZWxmLCBzZWxmLmhpZGUpIDogYW5ndWxhci5ub29wLAogICAgICAgIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX01PREFMCiAgICAgICk7CgogICAgICBzZWxmLl9pc09wZW5Qcm9taXNlID0gJHEuZGVmZXIoKTsKCiAgICAgIGlvbmljLnZpZXdzLk1vZGFsLnByb3RvdHlwZS5zaG93LmNhbGwoc2VsZik7CgogICAgICAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgIG1vZGFsRWwuYWRkQ2xhc3MoJ25nLWVudGVyLWFjdGl2ZScpOwogICAgICAgIGlvbmljLnRyaWdnZXIoJ3Jlc2l6ZScpOwogICAgICAgIHNlbGYuc2NvcGUuJHBhcmVudCAmJiBzZWxmLnNjb3BlLiRwYXJlbnQuJGJyb2FkY2FzdChzZWxmLnZpZXdUeXBlICsgJy5zaG93bicsIHNlbGYpOwogICAgICAgIHNlbGYuZWwuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgIH0sIDIwKTsKCiAgICAgIHJldHVybiAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAvL0FmdGVyIGFuaW1hdGluZyBpbiwgYWxsb3cgaGlkZSBvbiBiYWNrZHJvcCBjbGljawogICAgICAgIHNlbGYuJGVsLm9uKCdjbGljaycsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGlmIChzZWxmLmJhY2tkcm9wQ2xpY2tUb0Nsb3NlICYmIGUudGFyZ2V0ID09PSBzZWxmLmVsKSB7CiAgICAgICAgICAgIHNlbGYuaGlkZSgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LCA0MDApOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljTW9kYWwjaGlkZQogICAgICogQGRlc2NyaXB0aW9uIEhpZGUgdGhpcyBtb2RhbCBpbnN0YW5jZS4KICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgbW9kYWwgaXMgZmluaXNoZWQgYW5pbWF0aW5nIG91dC4KICAgICAqLwogICAgaGlkZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG1vZGFsRWwgPSBqcUxpdGUoc2VsZi5tb2RhbEVsKTsKCiAgICAgIHNlbGYuZWwuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgIG1vZGFsRWwuYWRkQ2xhc3MoJ25nLWxlYXZlJyk7CgogICAgICAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgIG1vZGFsRWwuYWRkQ2xhc3MoJ25nLWxlYXZlLWFjdGl2ZScpCiAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnbmctZW50ZXIgbmctZW50ZXItYWN0aXZlIGFjdGl2ZScpOwogICAgICB9LCAyMCk7CgogICAgICBzZWxmLiRlbC5vZmYoJ2NsaWNrJyk7CiAgICAgIHNlbGYuX2lzU2hvd24gPSBmYWxzZTsKICAgICAgc2VsZi5zY29wZS4kcGFyZW50ICYmIHNlbGYuc2NvcGUuJHBhcmVudC4kYnJvYWRjYXN0KHNlbGYudmlld1R5cGUgKyAnLmhpZGRlbicsIHNlbGYpOwogICAgICBzZWxmLl9kZXJlZ2lzdGVyQmFja0J1dHRvbiAmJiBzZWxmLl9kZXJlZ2lzdGVyQmFja0J1dHRvbigpOwoKICAgICAgaW9uaWMudmlld3MuTW9kYWwucHJvdG90eXBlLmhpZGUuY2FsbChzZWxmKTsKCiAgICAgIHJldHVybiAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgICRpb25pY0JvZHkucmVtb3ZlQ2xhc3Moc2VsZi52aWV3VHlwZSArICctb3BlbicpOwogICAgICAgIHNlbGYuZWwuY2xhc3NMaXN0LmFkZCgnaGlkZScpOwogICAgICB9LCBzZWxmLmhpZGVEZWxheSB8fCAzMjApOwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGlvbmljTW9kYWwjcmVtb3ZlCiAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlIHRoaXMgbW9kYWwgaW5zdGFuY2UgZnJvbSB0aGUgRE9NIGFuZCBjbGVhbiB1cC4KICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgbW9kYWwgaXMgZmluaXNoZWQgYW5pbWF0aW5nIG91dC4KICAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLnNjb3BlLiRwYXJlbnQgJiYgc2VsZi5zY29wZS4kcGFyZW50LiRicm9hZGNhc3Qoc2VsZi52aWV3VHlwZSArICcucmVtb3ZlZCcsIHNlbGYpOwoKICAgICAgcmV0dXJuIHNlbGYuaGlkZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5zY29wZS4kZGVzdHJveSgpOwogICAgICAgIHNlbGYuJGVsLnJlbW92ZSgpOwogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBpb25pY01vZGFsI2lzU2hvd24KICAgICAqIEByZXR1cm5zIGJvb2xlYW4gV2hldGhlciB0aGlzIG1vZGFsIGlzIGN1cnJlbnRseSBzaG93bi4KICAgICAqLwogICAgaXNTaG93bjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAhIXRoaXMuX2lzU2hvd247CiAgICB9CiAgfSk7CgogIHZhciBjcmVhdGVNb2RhbCA9IGZ1bmN0aW9uKHRlbXBsYXRlU3RyaW5nLCBvcHRpb25zKSB7CiAgICAvLyBDcmVhdGUgYSBuZXcgc2NvcGUgZm9yIHRoZSBtb2RhbAogICAgdmFyIHNjb3BlID0gb3B0aW9ucy5zY29wZSAmJiBvcHRpb25zLnNjb3BlLiRuZXcoKSB8fCAkcm9vdFNjb3BlLiRuZXcodHJ1ZSk7CgogICAgb3B0aW9ucy52aWV3VHlwZSA9IG9wdGlvbnMudmlld1R5cGUgfHwgJ21vZGFsJzsKCiAgICBleHRlbmQoc2NvcGUsIHsKICAgICAgJGhhc0hlYWRlcjogZmFsc2UsCiAgICAgICRoYXNTdWJoZWFkZXI6IGZhbHNlLAogICAgICAkaGFzRm9vdGVyOiBmYWxzZSwKICAgICAgJGhhc1N1YmZvb3RlcjogZmFsc2UsCiAgICAgICRoYXNUYWJzOiBmYWxzZSwKICAgICAgJGhhc1RhYnNUb3A6IGZhbHNlCiAgICB9KTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZQogICAgdmFyIGVsZW1lbnQgPSAkY29tcGlsZSgnPGlvbi0nICsgb3B0aW9ucy52aWV3VHlwZSArICc+JyArIHRlbXBsYXRlU3RyaW5nICsgJzwvaW9uLScgKyBvcHRpb25zLnZpZXdUeXBlICsgJz4nKShzY29wZSk7CgogICAgb3B0aW9ucy4kZWwgPSBlbGVtZW50OwogICAgb3B0aW9ucy5lbCA9IGVsZW1lbnRbMF07CiAgICBvcHRpb25zLm1vZGFsRWwgPSBvcHRpb25zLmVsLnF1ZXJ5U2VsZWN0b3IoJy4nICsgb3B0aW9ucy52aWV3VHlwZSk7CiAgICB2YXIgbW9kYWwgPSBuZXcgTW9kYWxWaWV3KG9wdGlvbnMpOwoKICAgIG1vZGFsLnNjb3BlID0gc2NvcGU7CgogICAgLy8gSWYgdGhpcyB3YXNuJ3QgYSBkZWZpbmVkIHNjb3BlLCB3ZSBjYW4gYXNzaWduIHRoZSB2aWV3VHlwZSB0byB0aGUgaXNvbGF0ZWQgc2NvcGUKICAgIC8vIHdlIGNyZWF0ZWQKICAgIGlmKCFvcHRpb25zLnNjb3BlKSB7CiAgICAgIHNjb3BlWyBvcHRpb25zLnZpZXdUeXBlIF0gPSBtb2RhbDsKICAgIH0KCiAgICByZXR1cm4gbW9kYWw7CiAgfTsKCiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTW9kYWwjZnJvbVRlbXBsYXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGVtcGxhdGVTdHJpbmcgVGhlIHRlbXBsYXRlIHN0cmluZyB0byB1c2UgYXMgdGhlIG1vZGFsJ3MKICAgICAqIGNvbnRlbnQuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBPcHRpb25zIHRvIGJlIHBhc3NlZCB7QGxpbmsgaW9uaWMuY29udHJvbGxlcjppb25pY01vZGFsI2luaXRpYWxpemUgaW9uaWNNb2RhbCNpbml0aWFsaXplfSBtZXRob2QuCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBbiBpbnN0YW5jZSBvZiBhbiB7QGxpbmsgaW9uaWMuY29udHJvbGxlcjppb25pY01vZGFsfQogICAgICogY29udHJvbGxlci4KICAgICAqLwogICAgZnJvbVRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZVN0cmluZywgb3B0aW9ucykgewogICAgICB2YXIgbW9kYWwgPSBjcmVhdGVNb2RhbCh0ZW1wbGF0ZVN0cmluZywgb3B0aW9ucyB8fCB7fSk7CiAgICAgIHJldHVybiBtb2RhbDsKICAgIH0sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY01vZGFsI2Zyb21UZW1wbGF0ZVVybAogICAgICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlVXJsIFRoZSB1cmwgdG8gbG9hZCB0aGUgdGVtcGxhdGUgZnJvbS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIE9wdGlvbnMgdG8gYmUgcGFzc2VkIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljTW9kYWwjaW5pdGlhbGl6ZSBpb25pY01vZGFsI2luaXRpYWxpemV9IG1ldGhvZC4KICAgICAqIG9wdGlvbnMgb2JqZWN0LgogICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBhbiBpbnN0YW5jZSBvZgogICAgICogYW4ge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNNb2RhbH0gY29udHJvbGxlci4KICAgICAqLwogICAgZnJvbVRlbXBsYXRlVXJsOiBmdW5jdGlvbih1cmwsIG9wdGlvbnMsIF8pIHsKICAgICAgdmFyIGNiOwogICAgICAvL0RlcHJlY2F0ZWQ6IGFsbG93IGEgY2FsbGJhY2sgYXMgc2Vjb25kIHBhcmFtZXRlci4gTm93IHdlIHJldHVybiBhIHByb21pc2UuCiAgICAgIGlmIChhbmd1bGFyLmlzRnVuY3Rpb24ob3B0aW9ucykpIHsKICAgICAgICBjYiA9IG9wdGlvbnM7CiAgICAgICAgb3B0aW9ucyA9IF87CiAgICAgIH0KICAgICAgcmV0dXJuICRpb25pY1RlbXBsYXRlTG9hZGVyLmxvYWQodXJsKS50aGVuKGZ1bmN0aW9uKHRlbXBsYXRlU3RyaW5nKSB7CiAgICAgICAgdmFyIG1vZGFsID0gY3JlYXRlTW9kYWwodGVtcGxhdGVTdHJpbmcsIG9wdGlvbnMgfHwge30pOwogICAgICAgIGNiICYmIGNiKG1vZGFsKTsKICAgICAgICByZXR1cm4gbW9kYWw7CiAgICAgIH0pOwogICAgfQogIH07Cn1dKTsKCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUKICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24KICogRGVsZWdhdGUgZm9yIGNvbnRyb2xsaW5nIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gZGlyZWN0aXZlLgogKgogKiBAdXNhZ2UKICoKICogYGBgaHRtbAogKiA8Ym9keSBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogKiAgIDxpb24tbmF2LWJhcj4KICogICAgIDxidXR0b24gbmctY2xpY2s9InNldE5hdlRpdGxlKCdiYW5hbmEnKSI+CiAqICAgICAgIFNldCB0aXRsZSB0byBiYW5hbmEhCiAqICAgICA8L2J1dHRvbj4KICogICA8L2lvbi1uYXYtYmFyPgogKiA8L2JvZHk+CiAqIGBgYAogKiBgYGBqcwogKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlLCAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSkgewogKiAgICRzY29wZS5zZXROYXZUaXRsZSA9IGZ1bmN0aW9uKHRpdGxlKSB7CiAqICAgICAkaW9uaWNOYXZCYXJEZWxlZ2F0ZS5zZXRUaXRsZSh0aXRsZSk7CiAqICAgfQogKiB9CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLnNlcnZpY2UoJyRpb25pY05hdkJhckRlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjYmFjawogICAqIEBkZXNjcmlwdGlvbiBHb2VzIGJhY2sgaW4gdGhlIHZpZXcgaGlzdG9yeS4KICAgKiBAcGFyYW0ge0RPTUV2ZW50PX0gZXZlbnQgVGhlIGV2ZW50IG9iamVjdCAoZWcgZnJvbSBhIHRhcCBldmVudCkKICAgKi8KICAnYmFjaycsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI2FsaWduCiAgICogQGRlc2NyaXB0aW9uIEFsaWducyB0aGUgdGl0bGUgd2l0aCB0aGUgYnV0dG9ucyBpbiBhIGdpdmVuIGRpcmVjdGlvbi4KICAgKiBAcGFyYW0ge3N0cmluZz19IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIHRvIHRoZSBhbGlnbiB0aGUgdGl0bGUgdGV4dCB0b3dhcmRzLgogICAqIEF2YWlsYWJsZTogJ2xlZnQnLCAncmlnaHQnLCAnY2VudGVyJy4gRGVmYXVsdDogJ2NlbnRlcicuCiAgICovCiAgJ2FsaWduJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjc2hvd0JhY2tCdXR0b24KICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXQvZ2V0IHdoZXRoZXIgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFja0J1dHRvbn0gaXMgc2hvd24KICAgKiAoaWYgaXQgZXhpc3RzKS4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93IFdoZXRoZXIgdG8gc2hvdyB0aGUgYmFjayBidXR0b24uCiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGJhY2sgYnV0dG9uIGlzIHNob3duLgogICAqLwogICdzaG93QmFja0J1dHRvbicsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI3Nob3dCYXIKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXQvZ2V0IHdoZXRoZXIgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfSBpcyBzaG93bi4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNob3cgV2hldGhlciB0byBzaG93IHRoZSBiYXIuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGJhciBpcyBzaG93bi4KICAgKi8KICAnc2hvd0JhcicsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI3NldFRpdGxlCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0IHRoZSB0aXRsZSBmb3IgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfS4KICAgKiBAcGFyYW0ge3N0cmluZ30gdGl0bGUgVGhlIG5ldyB0aXRsZSB0byBzaG93LgogICAqLwogICdzZXRUaXRsZScsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI2NoYW5nZVRpdGxlCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2hhbmdlIHRoZSB0aXRsZSwgdHJhbnNpdGlvbmluZyB0aGUgbmV3IHRpdGxlIGluIGFuZCB0aGUgb2xkIG9uZSBvdXQgaW4gYSBnaXZlbiBkaXJlY3Rpb24uCiAgICogQHBhcmFtIHtzdHJpbmd9IHRpdGxlIFRoZSBuZXcgdGl0bGUgdG8gc2hvdy4KICAgKiBAcGFyYW0ge3N0cmluZ30gZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gdG8gdHJhbnNpdGlvbiB0aGUgbmV3IHRpdGxlIGluLgogICAqIEF2YWlsYWJsZTogJ2ZvcndhcmQnLCAnYmFjaycuCiAgICovCiAgJ2NoYW5nZVRpdGxlJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjZ2V0VGl0bGUKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgY3VycmVudCB0aXRsZSBvZiB0aGUgbmF2YmFyLgogICAqLwogICdnZXRUaXRsZScsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI2dldFByZXZpb3VzVGl0bGUKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgcHJldmlvdXMgdGl0bGUgb2YgdGhlIG5hdmJhci4KICAgKi8KICAnZ2V0UHJldmlvdXNUaXRsZScKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjJGdldEJ5SGFuZGxlCiAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAqIEByZXR1cm5zIGBkZWxlZ2F0ZUluc3RhbmNlYCBBIGRlbGVnYXRlIGluc3RhbmNlIHRoYXQgY29udHJvbHMgb25seSB0aGUKICAgKiBuYXZCYXJzIHdpdGggZGVsZWdhdGUtaGFuZGxlIG1hdGNoaW5nIHRoZSBnaXZlbiBoYW5kbGUuCiAgICoKICAgKiBFeGFtcGxlOiBgJGlvbmljTmF2QmFyRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteUhhbmRsZScpLnNldFRpdGxlKCduZXdUaXRsZScpYAogICAqLwpdKSk7Cgp2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfVklFVyA9IDEwMDsKdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1NJREVfTUVOVSA9IDE1MDsKdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX01PREFMID0gMjAwOwp2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfQUNUSU9OX1NIRUVUID0gMzAwOwp2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfUE9QVVAgPSA0MDA7CnZhciBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9MT0FESU5HID0gNTAwOwoKZnVuY3Rpb24gY29tcG9uZW50Q29uZmlnKGRlZmF1bHRzKSB7CiAgZGVmYXVsdHMuJGdldCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gZGVmYXVsdHM7IH07CiAgcmV0dXJuIGRlZmF1bHRzOwp9CgpJb25pY01vZHVsZQouY29uc3RhbnQoJyRpb25pY1BsYXRmb3JtRGVmYXVsdHMnLCB7CiAgJ2lvcyc6IHsKICAgICckaW9uaWNOYXZCYXJDb25maWcnOiB7CiAgICAgIHRyYW5zaXRpb246ICduYXYtdGl0bGUtc2xpZGUtaW9zJywvL25hdi10aXRsZS1zbGlkZS1pb3M3JywKICAgICAgYWxpZ25UaXRsZTogJ2NlbnRlcicsCiAgICAgIGJhY2tCdXR0b25JY29uOiAnaW9uLWlvczctYXJyb3ctYmFjaycKICAgIH0sCiAgICAnJGlvbmljTmF2Vmlld0NvbmZpZyc6IHsKICAgICAgLy90cmFuc2l0aW9uOiAnc2xpZGUtbGVmdC1yaWdodC1pb3MnCiAgICAgIHRyYW5zaXRpb246ICdzbGlkZS1pb3MnCiAgICB9LAogICAgJyRpb25pY1RhYnNDb25maWcnOiB7CiAgICAgIHR5cGU6ICcnLAogICAgICBwb3NpdGlvbjogJycKICAgIH0KICB9LAogICdhbmRyb2lkJzogewogICAgJyRpb25pY05hdkJhckNvbmZpZyc6IHsKICAgICAgdHJhbnNpdGlvbjogJ25hdi10aXRsZS1zbGlkZS1mdWxsJywKICAgICAgYWxpZ25UaXRsZTogJ2NlbnRlcicsCiAgICAgIGJhY2tCdXR0b25JY29uOiAnaW9uLWlvczctYXJyb3ctYmFjaycKICAgIH0sCiAgICAnJGlvbmljTmF2Vmlld0NvbmZpZyc6IHsKICAgICAgdHJhbnNpdGlvbjogJ3NsaWRlLWZ1bGwnCiAgICB9LAogICAgJyRpb25pY1RhYnNDb25maWcnOiB7CiAgICAgIHR5cGU6ICd0YWJzLXN0cmlwZWQnLAogICAgICBwb3NpdGlvbjogJycKICAgIH0KICB9Cn0pOwoKCklvbmljTW9kdWxlLmNvbmZpZyhbCiAgJyRpb25pY1BsYXRmb3JtRGVmYXVsdHMnLAoKICAnJGluamVjdG9yJywKCmZ1bmN0aW9uKCRpb25pY1BsYXRmb3JtRGVmYXVsdHMsICRpbmplY3RvcikgewogIHZhciBwbGF0Zm9ybSA9IGlvbmljLlBsYXRmb3JtLnBsYXRmb3JtKCk7CgogIHZhciBhcHBseUNvbmZpZyA9IGZ1bmN0aW9uKHBsYXRmb3JtRGVmYXVsdHMpIHsKICAgIGZvckVhY2gocGxhdGZvcm1EZWZhdWx0cywgZnVuY3Rpb24oZGVmYXVsdHMsIGNvbnN0YW50TmFtZSkgewogICAgICBleHRlbmQoJGluamVjdG9yLmdldChjb25zdGFudE5hbWUpLCBkZWZhdWx0cyk7CiAgICB9KTsKICB9OwoKICBzd2l0Y2gocGxhdGZvcm0pIHsKICAgIGNhc2UgJ2lvcyc6CiAgICAgIGFwcGx5Q29uZmlnKCRpb25pY1BsYXRmb3JtRGVmYXVsdHMuaW9zKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdhbmRyb2lkJzoKICAgICAgYXBwbHlDb25maWcoJGlvbmljUGxhdGZvcm1EZWZhdWx0cy5hbmRyb2lkKTsKICAgICAgYnJlYWs7CiAgfQp9XSk7CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljUGxhdGZvcm0KICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24KICogQW4gYW5ndWxhciBhYnN0cmFjdGlvbiBvZiB7QGxpbmsgaW9uaWMudXRpbGl0eTppb25pYy5QbGF0Zm9ybX0uCiAqCiAqIFVzZWQgdG8gZGV0ZWN0IHRoZSBjdXJyZW50IHBsYXRmb3JtLCBhcyB3ZWxsIGFzIGRvIHRoaW5ncyBsaWtlIG92ZXJyaWRlIHRoZQogKiBBbmRyb2lkIGJhY2sgYnV0dG9uIGluIFBob25lR2FwL0NvcmRvdmEuCiAqLwpJb25pY01vZHVsZQoucHJvdmlkZXIoJyRpb25pY1BsYXRmb3JtJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgICRnZXQ6IFsnJHEnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKCRxLCAkcm9vdFNjb3BlKSB7CiAgICAgIHZhciBzZWxmID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGlvbmljUGxhdGZvcm0jb25IYXJkd2FyZUJhY2tCdXR0b24KICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTb21lIHBsYXRmb3JtcyBoYXZlIGEgaGFyZHdhcmUgYmFjayBidXR0b24sIHNvIHRoaXMgaXMgb25lIHdheSB0bwogICAgICAgICAqIGJpbmQgdG8gaXQuCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIHRvIHRyaWdnZXIgd2hlbiB0aGlzIGV2ZW50IG9jY3VycwogICAgICAgICAqLwogICAgICAgIG9uSGFyZHdhcmVCYWNrQnV0dG9uOiBmdW5jdGlvbihjYikgewogICAgICAgICAgaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2JhY2tidXR0b24nLCBjYiwgZmFsc2UpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRpb25pY1BsYXRmb3JtI29mZkhhcmR3YXJlQmFja0J1dHRvbgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lciBmb3IgdGhlIGJhY2tidXR0b24uCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGxpc3RlbmVyIGZ1bmN0aW9uIHRoYXQgd2FzCiAgICAgICAgICogb3JpZ2luYWxseSBib3VuZC4KICAgICAgICAgKi8KICAgICAgICBvZmZIYXJkd2FyZUJhY2tCdXR0b246IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICBpb25pYy5QbGF0Zm9ybS5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignYmFja2J1dHRvbicsIGZuKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaW9uaWNQbGF0Zm9ybSNyZWdpc3RlckJhY2tCdXR0b25BY3Rpb24KICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBhIGhhcmR3YXJlIGJhY2sgYnV0dG9uIGFjdGlvbi4gT25seSBvbmUgYWN0aW9uIHdpbGwgZXhlY3V0ZQogICAgICAgICAqIHdoZW4gdGhlIGJhY2sgYnV0dG9uIGlzIGNsaWNrZWQsIHNvIHRoaXMgbWV0aG9kIGRlY2lkZXMgd2hpY2ggb2YKICAgICAgICAgKiB0aGUgcmVnaXN0ZXJlZCBiYWNrIGJ1dHRvbiBhY3Rpb25zIGhhcyB0aGUgaGlnaGVzdCBwcmlvcml0eS4KICAgICAgICAgKgogICAgICAgICAqIEZvciBleGFtcGxlLCBpZiBhbiBhY3Rpb25zaGVldCBpcyBzaG93aW5nLCB0aGUgYmFjayBidXR0b24gc2hvdWxkCiAgICAgICAgICogY2xvc2UgdGhlIGFjdGlvbnNoZWV0LCBidXQgaXQgc2hvdWxkIG5vdCBhbHNvIGdvIGJhY2sgYSBwYWdlIHZpZXcKICAgICAgICAgKiBvciBjbG9zZSBhIG1vZGFsIHdoaWNoIG1heSBiZSBvcGVuLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIHdoZW4gdGhlIGJhY2sgYnV0dG9uIGlzIHByZXNzZWQsCiAgICAgICAgICogaWYgdGhpcyBsaXN0ZW5lciBpcyB0aGUgaGlnaGVzdCBwcmlvcml0eS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gcHJpb3JpdHkgT25seSB0aGUgaGlnaGVzdCBwcmlvcml0eSB3aWxsIGV4ZWN1dGUuCiAgICAgICAgICogQHBhcmFtIHsqPX0gYWN0aW9uSWQgVGhlIGlkIHRvIGFzc2lnbiB0aGlzIGFjdGlvbi4gRGVmYXVsdDogYQogICAgICAgICAqIHJhbmRvbSB1bmlxdWUgaWQuCiAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9ufSBBIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCB3aWxsIGRlcmVnaXN0ZXIKICAgICAgICAgKiB0aGlzIGJhY2tCdXR0b25BY3Rpb24uCiAgICAgICAgICovCiAgICAgICAgJGJhY2tCdXR0b25BY3Rpb25zOiB7fSwKICAgICAgICByZWdpc3RlckJhY2tCdXR0b25BY3Rpb246IGZ1bmN0aW9uKGZuLCBwcmlvcml0eSwgYWN0aW9uSWQpIHsKCiAgICAgICAgICBpZighc2VsZi5faGFzQmFja0J1dHRvbkhhbmRsZXIpIHsKICAgICAgICAgICAgLy8gYWRkIGEgYmFjayBidXR0b24gbGlzdGVuZXIgaWYgb25lIGhhc24ndCBiZWVuIHNldHVwIHlldAogICAgICAgICAgICBzZWxmLiRiYWNrQnV0dG9uQWN0aW9ucyA9IHt9OwogICAgICAgICAgICBzZWxmLm9uSGFyZHdhcmVCYWNrQnV0dG9uKHNlbGYuaGFyZHdhcmVCYWNrQnV0dG9uQ2xpY2spOwogICAgICAgICAgICBzZWxmLl9oYXNCYWNrQnV0dG9uSGFuZGxlciA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGFjdGlvbiA9IHsKICAgICAgICAgICAgaWQ6IChhY3Rpb25JZCA/IGFjdGlvbklkIDogaW9uaWMuVXRpbHMubmV4dFVpZCgpKSwKICAgICAgICAgICAgcHJpb3JpdHk6IChwcmlvcml0eSA/IHByaW9yaXR5IDogMCksCiAgICAgICAgICAgIGZuOiBmbgogICAgICAgICAgfTsKICAgICAgICAgIHNlbGYuJGJhY2tCdXR0b25BY3Rpb25zW2FjdGlvbi5pZF0gPSBhY3Rpb247CgogICAgICAgICAgLy8gcmV0dXJuIGEgZnVuY3Rpb24gdG8gZGUtcmVnaXN0ZXIgdGhpcyBiYWNrIGJ1dHRvbiBhY3Rpb24KICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZGVsZXRlIHNlbGYuJGJhY2tCdXR0b25BY3Rpb25zW2FjdGlvbi5pZF07CiAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgaGFyZHdhcmVCYWNrQnV0dG9uQ2xpY2s6IGZ1bmN0aW9uKGUpewogICAgICAgICAgLy8gbG9vcCB0aHJvdWdoIGFsbCB0aGUgcmVnaXN0ZXJlZCBiYWNrIGJ1dHRvbiBhY3Rpb25zCiAgICAgICAgICAvLyBhbmQgb25seSBydW4gdGhlIGxhc3Qgb25lIG9mIHRoZSBoaWdoZXN0IHByaW9yaXR5CiAgICAgICAgICB2YXIgcHJpb3JpdHlBY3Rpb24sIGFjdGlvbklkOwogICAgICAgICAgZm9yKGFjdGlvbklkIGluIHNlbGYuJGJhY2tCdXR0b25BY3Rpb25zKSB7CiAgICAgICAgICAgIGlmKCFwcmlvcml0eUFjdGlvbiB8fCBzZWxmLiRiYWNrQnV0dG9uQWN0aW9uc1thY3Rpb25JZF0ucHJpb3JpdHkgPj0gcHJpb3JpdHlBY3Rpb24ucHJpb3JpdHkpIHsKICAgICAgICAgICAgICBwcmlvcml0eUFjdGlvbiA9IHNlbGYuJGJhY2tCdXR0b25BY3Rpb25zW2FjdGlvbklkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYocHJpb3JpdHlBY3Rpb24pIHsKICAgICAgICAgICAgcHJpb3JpdHlBY3Rpb24uZm4oZSk7CiAgICAgICAgICAgIHJldHVybiBwcmlvcml0eUFjdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpczogZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgcmV0dXJuIGlvbmljLlBsYXRmb3JtLmlzKHR5cGUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaW9uaWNQbGF0Zm9ybSNyZWFkeQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRyaWdnZXIgYSBjYWxsYmFjayBvbmNlIHRoZSBkZXZpY2UgaXMgcmVhZHksCiAgICAgICAgICogb3IgaW1tZWRpYXRlbHkgaWYgdGhlIGRldmljZSBpcyBhbHJlYWR5IHJlYWR5LgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gY2FsbC4KICAgICAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIGRldmljZSBpcyByZWFkeS4KICAgICAgICAgKi8KICAgICAgICByZWFkeTogZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIHZhciBxID0gJHEuZGVmZXIoKTsKCiAgICAgICAgICBpb25pYy5QbGF0Zm9ybS5yZWFkeShmdW5jdGlvbigpewogICAgICAgICAgICBxLnJlc29sdmUoKTsKICAgICAgICAgICAgY2IgJiYgY2IoKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybiBxLnByb21pc2U7CiAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gc2VsZjsKICAgIH1dCiAgfTsKCn0pOwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNQb3BvdmVyCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlbGF0ZWQ6IHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljUG9wb3ZlciBpb25pY1BvcG92ZXIgY29udHJvbGxlcn0uCiAqCiAqIFRoZSBQb3BvdmVyIGlzIGEgdmlldyB0aGF0IGZsb2F0cyBhYm92ZSBhbiBhcHDigJlzIGNvbnRlbnQuIFBvcG92ZXJzIHByb3ZpZGUgYW4KICogZWFzeSB3YXkgdG8gcHJlc2VudCBvciBnYXRoZXIgaW5mb3JtYXRpb24gZnJvbSB0aGUgdXNlciBhbmQgYXJlCiAqIGNvbW1vbmx5IHVzZWQgaW4gdGhlIGZvbGxvd2luZyBzaXR1YXRpb25zOgogKgogKiAtIFNob3cgbW9yZSBpbmZvIGFib3V0IHRoZSBjdXJyZW50IHZpZXcKICogLSBTZWxlY3QgYSBjb21tb25seSB1c2VkIHRvb2wgb3IgY29uZmlndXJhdGlvbgogKiAtIFByZXNlbnQgYSBsaXN0IG9mIGFjdGlvbnMgdG8gcGVyZm9ybSBpbnNpZGUgb25lIG9mIHlvdXIgdmlld3MKICoKICogUHV0IHRoZSBjb250ZW50IG9mIHRoZSBwb3BvdmVyIGluc2lkZSBvZiBhbiBgPGlvbi1wb3BvdmVyLXZpZXc+YCBlbGVtZW50LgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8cD4KICogICA8YnV0dG9uIG5nLWNsaWNrPSJvcGVuUG9wb3ZlcigkZXZlbnQpIj5PcGVuIFBvcG92ZXI8L2J1dHRvbj4KICogPC9wPgogKgogKiA8c2NyaXB0IGlkPSJteS1wb3BvdmVyLmh0bWwiIHR5cGU9InRleHQvbmctdGVtcGxhdGUiPgogKiAgIDxpb24tcG9wb3Zlci12aWV3PgogKiAgICAgPGlvbi1oZWFkZXItYmFyPgogKiAgICAgICA8aDEgY2xhc3M9InRpdGxlIj5NeSBQb3BvdmVyIFRpdGxlPC9oMT4KICogICAgIDwvaW9uLWhlYWRlci1iYXI+CiAqICAgICA8aW9uLWNvbnRlbnQ+CiAqICAgICAgIEhlbGxvIQogKiAgICAgPC9pb24tY29udGVudD4KICogICA8L2lvbi1wb3BvdmVyLXZpZXc+CiAqIDwvc2NyaXB0PgogKiBgYGAKICogYGBganMKICogYW5ndWxhci5tb2R1bGUoJ3Rlc3RBcHAnLCBbJ2lvbmljJ10pCiAqIC5jb250cm9sbGVyKCdNeUNvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUsICRpb25pY1BvcG92ZXIpIHsKICogICAkaW9uaWNQb3BvdmVyLmZyb21UZW1wbGF0ZVVybCgnbXktcG9wb3Zlci5odG1sJywgewogKiAgICAgc2NvcGU6ICRzY29wZSwKICogICB9KS50aGVuKGZ1bmN0aW9uKHBvcG92ZXIpIHsKICogICAgICRzY29wZS5wb3BvdmVyID0gcG9wb3ZlcjsKICogICB9KTsKICogICAkc2NvcGUub3BlblBvcG92ZXIgPSBmdW5jdGlvbigkZXZlbnQpIHsKICogICAgICRzY29wZS5wb3BvdmVyLnNob3coJGV2ZW50KTsKICogICB9OwogKiAgICRzY29wZS5jbG9zZVBvcG92ZXIgPSBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5wb3BvdmVyLmhpZGUoKTsKICogICB9OwogKiAgIC8vQ2xlYW51cCB0aGUgcG9wb3ZlciB3aGVuIHdlJ3JlIGRvbmUgd2l0aCBpdCEKICogICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogKiAgICAgJHNjb3BlLnBvcG92ZXIucmVtb3ZlKCk7CiAqICAgfSk7CiAqICAgLy8gRXhlY3V0ZSBhY3Rpb24gb24gaGlkZSBwb3BvdmVyCiAqICAgJHNjb3BlLiRvbigncG9wb3Zlci5oaWRkZW4nLCBmdW5jdGlvbigpIHsKICogICAgIC8vIEV4ZWN1dGUgYWN0aW9uCiAqICAgfSk7CiAqICAgLy8gRXhlY3V0ZSBhY3Rpb24gb24gcmVtb3ZlIHBvcG92ZXIKICogICAkc2NvcGUuJG9uKCdwb3BvdmVyLnJlbW92ZWQnLCBmdW5jdGlvbigpIHsKICogICAgIC8vIEV4ZWN1dGUgYWN0aW9uCiAqICAgfSk7CiAqIH0pOwogKiBgYGAKICovCgoKSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY1BvcG92ZXInLCBbJyRpb25pY01vZGFsJywgJyRpb25pY1Bvc2l0aW9uJywgJyRkb2N1bWVudCcsICckd2luZG93JywKZnVuY3Rpb24oJGlvbmljTW9kYWwsICRpb25pY1Bvc2l0aW9uLCAkZG9jdW1lbnQsICR3aW5kb3cpIHsKCiAgdmFyIFBPUE9WRVJfQk9EWV9QQURESU5HID0gNjsKCiAgdmFyIFBPUE9WRVJfT1BUSU9OUyA9IHsKICAgIHZpZXdUeXBlOiAncG9wb3ZlcicsCiAgICBoaWRlRGVsYXk6IDEsCiAgICBhbmltYXRpb246ICdub25lJywKICAgIHBvc2l0aW9uVmlldzogcG9zaXRpb25WaWV3CiAgfTsKCiAgZnVuY3Rpb24gcG9zaXRpb25WaWV3KHRhcmdldCwgcG9wb3ZlckVsZSkgewogICAgdmFyIHRhcmdldEVsZSA9IGFuZ3VsYXIuZWxlbWVudCh0YXJnZXQudGFyZ2V0IHx8IHRhcmdldCk7CiAgICB2YXIgYnV0dG9uT2Zmc2V0ID0gJGlvbmljUG9zaXRpb24ub2Zmc2V0KCB0YXJnZXRFbGUgKTsKICAgIHZhciBwb3BvdmVyV2lkdGggPSBwb3BvdmVyRWxlLnByb3AoJ29mZnNldFdpZHRoJyk7CiAgICB2YXIgcG9wb3ZlckhlaWdodCA9IHBvcG92ZXJFbGUucHJvcCgnb2Zmc2V0SGVpZ2h0Jyk7CiAgICB2YXIgYm9keVdpZHRoID0gJGRvY3VtZW50WzBdLmJvZHkuY2xpZW50V2lkdGg7CiAgICAvLyBjbGllbnRIZWlnaHQgZG9lc24ndCB3b3JrIG9uIGFsbCBwbGF0Zm9ybXMgZm9yIGJvZHkKICAgIHZhciBib2R5SGVpZ2h0ID0gJHdpbmRvdy5pbm5lckhlaWdodDsKCiAgICB2YXIgcG9wb3ZlckNTUyA9IHsKICAgICAgbGVmdDogYnV0dG9uT2Zmc2V0LmxlZnQgKyBidXR0b25PZmZzZXQud2lkdGggLyAyIC0gcG9wb3ZlcldpZHRoIC8gMgogICAgfTsKICAgIHZhciBhcnJvd0VsZSA9IGpxTGl0ZShwb3BvdmVyRWxlWzBdLnF1ZXJ5U2VsZWN0b3IoJy5wb3BvdmVyLWFycm93JykpOwoKICAgIGlmIChwb3BvdmVyQ1NTLmxlZnQgPCBQT1BPVkVSX0JPRFlfUEFERElORykgewogICAgICBwb3BvdmVyQ1NTLmxlZnQgPSBQT1BPVkVSX0JPRFlfUEFERElORzsKICAgIH0gZWxzZSBpZihwb3BvdmVyQ1NTLmxlZnQgKyBwb3BvdmVyV2lkdGggKyBQT1BPVkVSX0JPRFlfUEFERElORyA+IGJvZHlXaWR0aCkgewogICAgICBwb3BvdmVyQ1NTLmxlZnQgPSBib2R5V2lkdGggLSBwb3BvdmVyV2lkdGggLSBQT1BPVkVSX0JPRFlfUEFERElORzsKICAgIH0KCiAgICAvLyBJZiB0aGUgcG9wb3ZlciB3aGVuIHBvcHBlZCBkb3duIHN0cmV0Y2hlcyBwYXN0IGJvdHRvbSBvZiBzY3JlZW4sCiAgICAvLyBtYWtlIGl0IHBvcCB1cAogICAgaWYgKGJ1dHRvbk9mZnNldC50b3AgKyBidXR0b25PZmZzZXQuaGVpZ2h0ICsgcG9wb3ZlckhlaWdodCA+IGJvZHlIZWlnaHQpIHsKICAgICAgcG9wb3ZlckNTUy50b3AgPSBidXR0b25PZmZzZXQudG9wIC0gcG9wb3ZlckhlaWdodDsKICAgICAgcG9wb3ZlckVsZS5yZW1vdmVDbGFzcygncG9wb3Zlci10b3AnKS5hZGRDbGFzcygncG9wb3Zlci1ib3R0b20nKTsKICAgIH0gZWxzZSB7CiAgICAgIHBvcG92ZXJDU1MudG9wID0gYnV0dG9uT2Zmc2V0LnRvcCArIGJ1dHRvbk9mZnNldC5oZWlnaHQ7CiAgICAgIHBvcG92ZXJFbGUucmVtb3ZlQ2xhc3MoJ3BvcG92ZXItYm90dG9tJykuYWRkQ2xhc3MoJ3BvcG92ZXItdG9wJyk7CiAgICB9CgogICAgYXJyb3dFbGUuY3NzKHsKICAgICAgbGVmdDogYnV0dG9uT2Zmc2V0LmxlZnQgKyBidXR0b25PZmZzZXQud2lkdGggLyAyIC0KICAgICAgICBhcnJvd0VsZS5wcm9wKCdvZmZzZXRXaWR0aCcpIC8gMiAtIHBvcG92ZXJDU1MubGVmdCArICdweCcKICAgIH0pOwoKICAgIHBvcG92ZXJFbGUuY3NzKHsKICAgICAgdG9wOiBwb3BvdmVyQ1NTLnRvcCArICdweCcsCiAgICAgIGxlZnQ6IHBvcG92ZXJDU1MubGVmdCArICdweCcsCiAgICAgIG1hcmdpbkxlZnQ6ICcwJywKICAgICAgb3BhY2l0eTogJzEnCiAgICB9KTsKCiAgfQoKICAvKioKICAgKiBAbmdkb2MgY29udHJvbGxlcgogICAqIEBuYW1lIGlvbmljUG9wb3ZlcgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJbnN0YW50aWF0ZWQgYnkgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1BvcG92ZXJ9IHNlcnZpY2UuCiAgICoKICAgKiBCZSBzdXJlIHRvIGNhbGwgW3JlbW92ZSgpXSgjcmVtb3ZlKSB3aGVuIHlvdSBhcmUgZG9uZSB3aXRoIGVhY2ggcG9wb3ZlcgogICAqIHRvIGNsZWFuIGl0IHVwIGFuZCBhdm9pZCBtZW1vcnkgbGVha3MuCiAgICoKICAgKiBOb3RlOiBhIHBvcG92ZXIgd2lsbCBicm9hZGNhc3QgJ3BvcG92ZXIuc2hvd24nLCAncG9wb3Zlci5oaWRkZW4nLCBhbmQgJ3BvcG92ZXIucmVtb3ZlZCcgZXZlbnRzIGZyb20gaXRzIG9yaWdpbmF0aW5nCiAgICogc2NvcGUsIHBhc3NpbmcgaW4gaXRzZWxmIGFzIGFuIGV2ZW50IGFyZ3VtZW50LiBCb3RoIHRoZSBwb3BvdmVyLnJlbW92ZWQgYW5kIHBvcG92ZXIuaGlkZGVuIGV2ZW50cyBhcmUKICAgKiBjYWxsZWQgd2hlbiB0aGUgcG9wb3ZlciBpcyByZW1vdmVkLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgaW9uaWNQb3BvdmVyI2luaXRpYWxpemUKICAgKiBAZGVzY3JpcHRpb24gQ3JlYXRlcyBhIG5ldyBwb3BvdmVyIGNvbnRyb2xsZXIgaW5zdGFuY2UuCiAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgQW4gb3B0aW9ucyBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICogIC0gYHtvYmplY3Q9fWAgYHNjb3BlYCBUaGUgc2NvcGUgdG8gYmUgYSBjaGlsZCBvZi4KICAgKiAgICBEZWZhdWx0OiBjcmVhdGVzIGEgY2hpbGQgb2YgJHJvb3RTY29wZS4KICAgKiAgLSBge2Jvb2xlYW49fWAgYGZvY3VzRmlyc3RJbnB1dGAgV2hldGhlciB0byBhdXRvZm9jdXMgdGhlIGZpcnN0IGlucHV0IG9mCiAgICogICAgdGhlIHBvcG92ZXIgd2hlbiBzaG93bi4gIERlZmF1bHQ6IGZhbHNlLgogICAqICAtIGB7Ym9vbGVhbj19YCBgYmFja2Ryb3BDbGlja1RvQ2xvc2VgIFdoZXRoZXIgdG8gY2xvc2UgdGhlIHBvcG92ZXIgb24gY2xpY2tpbmcgdGhlIGJhY2tkcm9wLgogICAqICAgIERlZmF1bHQ6IHRydWUuCiAgICogIC0gYHtib29sZWFuPX1gIGBoYXJkd2FyZUJhY2tCdXR0b25DbG9zZWAgV2hldGhlciB0aGUgcG9wb3ZlciBjYW4gYmUgY2xvc2VkIHVzaW5nIHRoZSBoYXJkd2FyZQogICAqICAgIGJhY2sgYnV0dG9uIG9uIEFuZHJvaWQgYW5kIHNpbWlsYXIgZGV2aWNlcy4gIERlZmF1bHQ6IHRydWUuCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBpb25pY1BvcG92ZXIjc2hvdwogICAqIEBkZXNjcmlwdGlvbiBTaG93IHRoaXMgcG9wb3ZlciBpbnN0YW5jZS4KICAgKiBAcGFyYW0geyRldmVudH0gJGV2ZW50IFRoZSAkZXZlbnQgb3IgdGFyZ2V0IGVsZW1lbnQgd2hpY2ggdGhlIHBvcG92ZXIgc2hvdWxkIGFsaWduCiAgICogaXRzZWxmIG5leHQgdG8uCiAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3BvdmVyIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBpbi4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGlvbmljUG9wb3ZlciNoaWRlCiAgICogQGRlc2NyaXB0aW9uIEhpZGUgdGhpcyBwb3BvdmVyIGluc3RhbmNlLgogICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wb3ZlciBpcyBmaW5pc2hlZCBhbmltYXRpbmcgb3V0LgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgaW9uaWNQb3BvdmVyI3JlbW92ZQogICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgdGhpcyBwb3BvdmVyIGluc3RhbmNlIGZyb20gdGhlIERPTSBhbmQgY2xlYW4gdXAuCiAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3BvdmVyIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBvdXQuCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBpb25pY1BvcG92ZXIjaXNTaG93bgogICAqIEByZXR1cm5zIGJvb2xlYW4gV2hldGhlciB0aGlzIHBvcG92ZXIgaXMgY3VycmVudGx5IHNob3duLgogICAqLwoKICByZXR1cm4gewogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNQb3BvdmVyI2Zyb21UZW1wbGF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlU3RyaW5nIFRoZSB0ZW1wbGF0ZSBzdHJpbmcgdG8gdXNlIGFzIHRoZSBwb3BvdmVycydzCiAgICAgKiBjb250ZW50LgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0byBiZSBwYXNzZWQgdG8gdGhlIGluaXRpYWxpemUgbWV0aG9kLgogICAgICogQHJldHVybnMge29iamVjdH0gQW4gaW5zdGFuY2Ugb2YgYW4ge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNQb3BvdmVyfQogICAgICogY29udHJvbGxlciAoJGlvbmljUG9wb3ZlciBpcyBidWlsdCBvbiB0b3Agb2YgJGlvbmljUG9wb3ZlcikuCiAgICAgKi8KICAgIGZyb21UZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVTdHJpbmcsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuICRpb25pY01vZGFsLmZyb21UZW1wbGF0ZSh0ZW1wbGF0ZVN0cmluZywgaW9uaWMuVXRpbHMuZXh0ZW5kKG9wdGlvbnMgfHwge30sIFBPUE9WRVJfT1BUSU9OUykgKTsKICAgIH0sCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1BvcG92ZXIjZnJvbVRlbXBsYXRlVXJsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGVtcGxhdGVVcmwgVGhlIHVybCB0byBsb2FkIHRoZSB0ZW1wbGF0ZSBmcm9tLgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0byBiZSBwYXNzZWQgdG8gdGhlIGluaXRpYWxpemUgbWV0aG9kLgogICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBhbiBpbnN0YW5jZSBvZgogICAgICogYW4ge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNQb3BvdmVyfSBjb250cm9sbGVyICgkaW9uaWNQb3BvdmVyIGlzIGJ1aWx0IG9uIHRvcCBvZiAkaW9uaWNQb3BvdmVyKS4KICAgICAqLwogICAgZnJvbVRlbXBsYXRlVXJsOiBmdW5jdGlvbih1cmwsIG9wdGlvbnMsIF8pIHsKICAgICAgcmV0dXJuICRpb25pY01vZGFsLmZyb21UZW1wbGF0ZVVybCh1cmwsIG9wdGlvbnMsIGlvbmljLlV0aWxzLmV4dGVuZChvcHRpb25zIHx8IHt9LCBQT1BPVkVSX09QVElPTlMpICk7CiAgICB9CiAgfTsKCn1dKTsKCgp2YXIgUE9QVVBfVFBMID0KICAnPGRpdiBjbGFzcz0icG9wdXAtY29udGFpbmVyIj4nICsKICAgICc8ZGl2IGNsYXNzPSJwb3B1cCI+JyArCiAgICAgICc8ZGl2IGNsYXNzPSJwb3B1cC1oZWFkIj4nICsKICAgICAgICAnPGgzIGNsYXNzPSJwb3B1cC10aXRsZSIgbmctYmluZC1odG1sPSJ0aXRsZSI+PC9oMz4nICsKICAgICAgICAnPGg1IGNsYXNzPSJwb3B1cC1zdWItdGl0bGUiIG5nLWJpbmQtaHRtbD0ic3ViVGl0bGUiIG5nLWlmPSJzdWJUaXRsZSI+PC9oNT4nICsKICAgICAgJzwvZGl2PicgKwogICAgICAnPGRpdiBjbGFzcz0icG9wdXAtYm9keSI+JyArCiAgICAgICc8L2Rpdj4nICsKICAgICAgJzxkaXYgY2xhc3M9InBvcHVwLWJ1dHRvbnMiPicgKwogICAgICAgICc8YnV0dG9uIG5nLXJlcGVhdD0iYnV0dG9uIGluIGJ1dHRvbnMiIG5nLWNsaWNrPSIkYnV0dG9uVGFwcGVkKGJ1dHRvbiwgJGV2ZW50KSIgY2xhc3M9ImJ1dHRvbiIgbmctY2xhc3M9ImJ1dHRvbi50eXBlIHx8IFwnYnV0dG9uLWRlZmF1bHRcJyIgbmctYmluZC1odG1sPSJidXR0b24udGV4dCI+PC9idXR0b24+JyArCiAgICAgICc8L2Rpdj4nICsKICAgICc8L2Rpdj4nICsKICAnPC9kaXY+JzsKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNQb3B1cAogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBFCiAqIEBjb2RlcGVuIHprbWhKCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUgSW9uaWMgUG9wdXAgc2VydmljZSBhbGxvd3MgcHJvZ3JhbW1hdGljYWxseSBjcmVhdGluZyBhbmQgc2hvd2luZyBwb3B1cAogKiB3aW5kb3dzIHRoYXQgcmVxdWlyZSB0aGUgdXNlciB0byByZXNwb25kIGluIG9yZGVyIHRvIGNvbnRpbnVlLgogKgogKiBUaGUgcG9wdXAgc3lzdGVtIGhhcyBzdXBwb3J0IGZvciBtb3JlIGZsZXhpYmxlIHZlcnNpb25zIG9mIHRoZSBidWlsdCBpbiBgYWxlcnQoKWAsIGBwcm9tcHQoKWAsCiAqIGFuZCBgY29uZmlybSgpYCBmdW5jdGlvbnMgdGhhdCB1c2VycyBhcmUgdXNlZCB0bywgaW4gYWRkaXRpb24gdG8gYWxsb3dpbmcgcG9wdXBzIHdpdGggY29tcGxldGVseQogKiBjdXN0b20gY29udGVudCBhbmQgbG9vay4KICoKICogQW4gaW5wdXQgY2FuIGJlIGdpdmVuIGFuIGBhdXRvZm9jdXNgIGF0dHJpYnV0ZSBzbyBpdCBhdXRvbWF0aWNhbGx5IHJlY2VpdmVzIGZvY3VzIHdoZW4KICogdGhlIHBvcHVwIGZpcnN0IHNob3dzLiBIb3dldmVyLCBkZXBlbmRpbmcgb24gY2VydGFpbiB1c2UtY2FzZXMgdGhpcyBjYW4gY2F1c2UgaXNzdWVzIHdpdGgKICogdGhlIHRhcC9jbGljayBzeXN0ZW0sIHdoaWNoIGlzIHdoeSBJb25pYyBwcmVmZXJzIHVzaW5nIHRoZSBgYXV0b2ZvY3VzYCBhdHRyaWJ1dGUgYXMKICogYW4gb3B0LWluIGZlYXR1cmUgYW5kIG5vdCB0aGUgZGVmYXVsdC4KICoKICogQHVzYWdlCiAqIEEgZmV3IGJhc2ljIGV4YW1wbGVzLCBzZWUgYmVsb3cgZm9yIGRldGFpbHMgYWJvdXQgYWxsIG9mIHRoZSBvcHRpb25zIGF2YWlsYWJsZS4KICoKICogYGBganMKICphbmd1bGFyLm1vZHVsZSgnbXlTdXBlckFwcCcsIFsnaW9uaWMnXSkKICouY29udHJvbGxlcignUG9wdXBDdHJsJyxmdW5jdGlvbigkc2NvcGUsICRpb25pY1BvcHVwLCAkdGltZW91dCkgewogKgogKiAvLyBUcmlnZ2VyZWQgb24gYSBidXR0b24gY2xpY2ssIG9yIHNvbWUgb3RoZXIgdGFyZ2V0CiAqICRzY29wZS5zaG93UG9wdXAgPSBmdW5jdGlvbigpIHsKICogICAkc2NvcGUuZGF0YSA9IHt9CiAqCiAqICAgLy8gQW4gZWxhYm9yYXRlLCBjdXN0b20gcG9wdXAKICogICB2YXIgbXlQb3B1cCA9ICRpb25pY1BvcHVwLnNob3coewogKiAgICAgdGVtcGxhdGU6ICc8aW5wdXQgdHlwZT0icGFzc3dvcmQiIG5nLW1vZGVsPSJkYXRhLndpZmkiPicsCiAqICAgICB0aXRsZTogJ0VudGVyIFdpLUZpIFBhc3N3b3JkJywKICogICAgIHN1YlRpdGxlOiAnUGxlYXNlIHVzZSBub3JtYWwgdGhpbmdzJywKICogICAgIHNjb3BlOiAkc2NvcGUsCiAqICAgICBidXR0b25zOiBbCiAqICAgICAgIHsgdGV4dDogJ0NhbmNlbCcgfSwKICogICAgICAgewogKiAgICAgICAgIHRleHQ6ICc8Yj5TYXZlPC9iPicsCiAqICAgICAgICAgdHlwZTogJ2J1dHRvbi1wb3NpdGl2ZScsCiAqICAgICAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHsKICogICAgICAgICAgIGlmICghJHNjb3BlLmRhdGEud2lmaSkgewogKiAgICAgICAgICAgICAvL2Rvbid0IGFsbG93IHRoZSB1c2VyIHRvIGNsb3NlIHVubGVzcyBoZSBlbnRlcnMgd2lmaSBwYXNzd29yZAogKiAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAqICAgICAgICAgICB9IGVsc2UgewogKiAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLmRhdGEud2lmaTsKICogICAgICAgICAgIH0KICogICAgICAgICB9CiAqICAgICAgIH0sCiAqICAgICBdCiAqICAgfSk7CiAqICAgbXlQb3B1cC50aGVuKGZ1bmN0aW9uKHJlcykgewogKiAgICAgY29uc29sZS5sb2coJ1RhcHBlZCEnLCByZXMpOwogKiAgIH0pOwogKiAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgIG15UG9wdXAuY2xvc2UoKTsgLy9jbG9zZSB0aGUgcG9wdXAgYWZ0ZXIgMyBzZWNvbmRzIGZvciBzb21lIHJlYXNvbgogKiAgIH0sIDMwMDApOwogKiAgfTsKICogIC8vIEEgY29uZmlybSBkaWFsb2cKICogICRzY29wZS5zaG93Q29uZmlybSA9IGZ1bmN0aW9uKCkgewogKiAgICB2YXIgY29uZmlybVBvcHVwID0gJGlvbmljUG9wdXAuY29uZmlybSh7CiAqICAgICAgdGl0bGU6ICdDb25zdW1lIEljZSBDcmVhbScsCiAqICAgICAgdGVtcGxhdGU6ICdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZWF0IHRoaXMgaWNlIGNyZWFtPycKICogICAgfSk7CiAqICAgIGNvbmZpcm1Qb3B1cC50aGVuKGZ1bmN0aW9uKHJlcykgewogKiAgICAgIGlmKHJlcykgewogKiAgICAgICAgY29uc29sZS5sb2coJ1lvdSBhcmUgc3VyZScpOwogKiAgICAgIH0gZWxzZSB7CiAqICAgICAgICBjb25zb2xlLmxvZygnWW91IGFyZSBub3Qgc3VyZScpOwogKiAgICAgIH0KICogICAgfSk7CiAqICB9OwogKgogKiAgLy8gQW4gYWxlcnQgZGlhbG9nCiAqICAkc2NvcGUuc2hvd0FsZXJ0ID0gZnVuY3Rpb24oKSB7CiAqICAgIHZhciBhbGVydFBvcHVwID0gJGlvbmljUG9wdXAuYWxlcnQoewogKiAgICAgIHRpdGxlOiAnRG9uXCd0IGVhdCB0aGF0IScsCiAqICAgICAgdGVtcGxhdGU6ICdJdCBtaWdodCB0YXN0ZSBnb29kJwogKiAgICB9KTsKICogICAgYWxlcnRQb3B1cC50aGVuKGZ1bmN0aW9uKHJlcykgewogKiAgICAgIGNvbnNvbGUubG9nKCdUaGFuayB5b3UgZm9yIG5vdCBlYXRpbmcgbXkgZGVsaWNpb3VzIGljZSBjcmVhbSBjb25lJyk7CiAqICAgIH0pOwogKiAgfTsKICp9KTsKICpgYGAKICovCgpJb25pY01vZHVsZQouZmFjdG9yeSgnJGlvbmljUG9wdXAnLCBbCiAgJyRpb25pY1RlbXBsYXRlTG9hZGVyJywKICAnJGlvbmljQmFja2Ryb3AnLAogICckcScsCiAgJyR0aW1lb3V0JywKICAnJHJvb3RTY29wZScsCiAgJyRpb25pY0JvZHknLAogICckY29tcGlsZScsCiAgJyRpb25pY1BsYXRmb3JtJywKZnVuY3Rpb24oJGlvbmljVGVtcGxhdGVMb2FkZXIsICRpb25pY0JhY2tkcm9wLCAkcSwgJHRpbWVvdXQsICRyb290U2NvcGUsICRpb25pY0JvZHksICRjb21waWxlLCAkaW9uaWNQbGF0Zm9ybSkgewogIC8vVE9ETyBhbGxvdyB0aGlzIHRvIGJlIGNvbmZpZ3VyZWQKICB2YXIgY29uZmlnID0gewogICAgc3RhY2tQdXNoRGVsYXk6IDc1CiAgfTsKICB2YXIgcG9wdXBTdGFjayA9IFtdOwogIHZhciAkaW9uaWNQb3B1cCA9IHsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG93IGEgY29tcGxleCBwb3B1cC4gVGhpcyBpcyB0aGUgbWFzdGVyIHNob3cgZnVuY3Rpb24gZm9yIGFsbCBwb3B1cHMuCiAgICAgKgogICAgICogQSBjb21wbGV4IHBvcHVwIGhhcyBhIGBidXR0b25zYCBhcnJheSwgd2l0aCBlYWNoIGJ1dHRvbiBoYXZpbmcgYSBgdGV4dGAgYW5kIGB0eXBlYAogICAgICogZmllbGQsIGluIGFkZGl0aW9uIHRvIGFuIGBvblRhcGAgZnVuY3Rpb24uICBUaGUgYG9uVGFwYCBmdW5jdGlvbiwgY2FsbGVkIHdoZW4KICAgICAqIHRoZSBjb3JyZXNwb25kaW5nYnV0dG9uIG9uIHRoZSBwb3B1cCBpcyB0YXBwZWQsIHdpbGwgYnkgZGVmYXVsdCBjbG9zZSB0aGUgcG9wdXAKICAgICAqIGFuZCByZXNvbHZlIHRoZSBwb3B1cCBwcm9taXNlIHdpdGggaXRzIHJldHVybiB2YWx1ZS4gIElmIHlvdSB3aXNoIHRvIHByZXZlbnQgdGhlCiAgICAgKiBkZWZhdWx0IGFuZCBrZWVwIHRoZSBwb3B1cCBvcGVuIG9uIGJ1dHRvbiB0YXAsIGNhbGwgYGV2ZW50LnByZXZlbnREZWZhdWx0KClgIG9uIHRoZQogICAgICogcGFzc2VkIGluIHRhcCBldmVudC4gIERldGFpbHMgYmVsb3cuCiAgICAgKgogICAgICogQG5hbWUgJGlvbmljUG9wdXAjc2hvdwogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHRoZSBuZXcgcG9wdXAsIG9mIHRoZSBmb3JtOgogICAgICoKICAgICAqIGBgYAogICAgICogewogICAgICogICB0aXRsZTogJycsIC8vIFN0cmluZy4gVGhlIHRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgc3ViVGl0bGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIHN1Yi10aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHRlbXBsYXRlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCBib2R5LgogICAgICogICB0ZW1wbGF0ZVVybDogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgVVJMIG9mIGFuIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwICAgYm9keS4KICAgICAqICAgc2NvcGU6IG51bGwsIC8vIFNjb3BlIChvcHRpb25hbCkuIEEgc2NvcGUgdG8gbGluayB0byB0aGUgcG9wdXAgY29udGVudC4KICAgICAqICAgYnV0dG9uczogW3sgLy9BcnJheVtPYmplY3RdIChvcHRpb25hbCkuIEJ1dHRvbnMgdG8gcGxhY2UgaW4gdGhlIHBvcHVwIGZvb3Rlci4KICAgICAqICAgICB0ZXh0OiAnQ2FuY2VsJywKICAgICAqICAgICB0eXBlOiAnYnV0dG9uLWRlZmF1bHQnLAogICAgICogICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgKiAgICAgICAvLyBlLnByZXZlbnREZWZhdWx0KCkgd2lsbCBzdG9wIHRoZSBwb3B1cCBmcm9tIGNsb3Npbmcgd2hlbiB0YXBwZWQuCiAgICAgKiAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgKiAgICAgfQogICAgICogICB9LCB7CiAgICAgKiAgICAgdGV4dDogJ09LJywKICAgICAqICAgICB0eXBlOiAnYnV0dG9uLXBvc2l0aXZlJywKICAgICAqICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogICAgICogICAgICAgLy8gUmV0dXJuaW5nIGEgdmFsdWUgd2lsbCBjYXVzZSB0aGUgcHJvbWlzZSB0byByZXNvbHZlIHdpdGggdGhlIGdpdmVuIHZhbHVlLgogICAgICogICAgICAgcmV0dXJuIHNjb3BlLmRhdGEucmVzcG9uc2U7CiAgICAgKiAgICAgfQogICAgICogICB9XQogICAgICogfQogICAgICogYGBgCiAgICAgKgogICAgICogQHJldHVybnMge29iamVjdH0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIHBvcHVwIGlzIGNsb3NlZC4gSGFzIGFuIGFkZGl0aW9uYWwKICAgICAqIGBjbG9zZWAgZnVuY3Rpb24sIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHByb2dyYW1tYXRpY2FsbHkgY2xvc2UgdGhlIHBvcHVwLgogICAgICovCiAgICBzaG93OiBzaG93UG9wdXAsCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNQb3B1cCNhbGVydAogICAgICogQGRlc2NyaXB0aW9uIFNob3cgYSBzaW1wbGUgYWxlcnQgcG9wdXAgd2l0aCBhIG1lc3NhZ2UgYW5kIG9uZSBidXR0b24gdGhhdCB0aGUgdXNlciBjYW4KICAgICAqIHRhcCB0byBjbG9zZSB0aGUgcG9wdXAuCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHNob3dpbmcgdGhlIGFsZXJ0LCBvZiB0aGUgZm9ybToKICAgICAqCiAgICAgKiBgYGAKICAgICAqIHsKICAgICAqICAgdGl0bGU6ICcnLCAvLyBTdHJpbmcuIFRoZSB0aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHN1YlRpdGxlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBzdWItdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICB0ZW1wbGF0ZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgYm9keS4KICAgICAqICAgdGVtcGxhdGVVcmw6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIFVSTCBvZiBhbiBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCAgIGJvZHkuCiAgICAgKiAgIG9rVGV4dDogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ09LJykuIFRoZSB0ZXh0IG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiAgIG9rVHlwZTogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ2J1dHRvbi1wb3NpdGl2ZScpLiBUaGUgdHlwZSBvZiB0aGUgT0sgYnV0dG9uLgogICAgICogfQogICAgICogYGBgCiAgICAgKgogICAgICogQHJldHVybnMge29iamVjdH0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIHBvcHVwIGlzIGNsb3NlZC4gSGFzIG9uZSBhZGRpdGlvbmFsCiAgICAgKiBmdW5jdGlvbiBgY2xvc2VgLCB3aGljaCBjYW4gYmUgY2FsbGVkIHdpdGggYW55IHZhbHVlIHRvIHByb2dyYW1tYXRpY2FsbHkgY2xvc2UgdGhlIHBvcHVwCiAgICAgKiB3aXRoIHRoZSBnaXZlbiB2YWx1ZS4KICAgICAqLwogICAgYWxlcnQ6IHNob3dBbGVydCwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1BvcHVwI2NvbmZpcm0KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvdyBhIHNpbXBsZSBjb25maXJtIHBvcHVwIHdpdGggYSBDYW5jZWwgYW5kIE9LIGJ1dHRvbi4KICAgICAqCiAgICAgKiBSZXNvbHZlcyB0aGUgcHJvbWlzZSB3aXRoIHRydWUgaWYgdGhlIHVzZXIgcHJlc3NlcyB0aGUgT0sgYnV0dG9uLCBhbmQgZmFsc2UgaWYgdGhlCiAgICAgKiB1c2VyIHByZXNzZXMgdGhlIENhbmNlbCBidXR0b24uCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHNob3dpbmcgdGhlIGNvbmZpcm0gcG9wdXAsIG9mIHRoZSBmb3JtOgogICAgICoKICAgICAqIGBgYAogICAgICogewogICAgICogICB0aXRsZTogJycsIC8vIFN0cmluZy4gVGhlIHRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgc3ViVGl0bGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIHN1Yi10aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHRlbXBsYXRlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCBib2R5LgogICAgICogICB0ZW1wbGF0ZVVybDogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgVVJMIG9mIGFuIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwICAgYm9keS4KICAgICAqICAgY2FuY2VsVGV4dDogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ0NhbmNlbCcpLiBUaGUgdGV4dCBvZiB0aGUgQ2FuY2VsIGJ1dHRvbi4KICAgICAqICAgY2FuY2VsVHlwZTogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ2J1dHRvbi1kZWZhdWx0JykuIFRoZSB0eXBlIG9mIHRoZSBDYW5jZWwgYnV0dG9uLgogICAgICogICBva1RleHQ6ICcnLCAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdPSycpLiBUaGUgdGV4dCBvZiB0aGUgT0sgYnV0dG9uLgogICAgICogICBva1R5cGU6ICcnLCAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdidXR0b24tcG9zaXRpdmUnKS4gVGhlIHR5cGUgb2YgdGhlIE9LIGJ1dHRvbi4KICAgICAqIH0KICAgICAqIGBgYAogICAgICoKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3B1cCBpcyBjbG9zZWQuIEhhcyBvbmUgYWRkaXRpb25hbAogICAgICogZnVuY3Rpb24gYGNsb3NlYCwgd2hpY2ggY2FuIGJlIGNhbGxlZCB3aXRoIGFueSB2YWx1ZSB0byBwcm9ncmFtbWF0aWNhbGx5IGNsb3NlIHRoZSBwb3B1cAogICAgICogd2l0aCB0aGUgZ2l2ZW4gdmFsdWUuCiAgICAgKi8KICAgIGNvbmZpcm06IHNob3dDb25maXJtLAoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljUG9wdXAjcHJvbXB0CiAgICAgKiBAZGVzY3JpcHRpb24gU2hvdyBhIHNpbXBsZSBwcm9tcHQgcG9wdXAsIHdoaWNoIGhhcyBhbiBpbnB1dCwgT0sgYnV0dG9uLCBhbmQgQ2FuY2VsIGJ1dHRvbi4KICAgICAqIFJlc29sdmVzIHRoZSBwcm9taXNlIHdpdGggdGhlIHZhbHVlIG9mIHRoZSBpbnB1dCBpZiB0aGUgdXNlciBwcmVzc2VzIE9LLCBhbmQgd2l0aCB1bmRlZmluZWQKICAgICAqIGlmIHRoZSB1c2VyIHByZXNzZXMgQ2FuY2VsLgogICAgICoKICAgICAqIGBgYGphdmFzY3JpcHQKICAgICAqICAkaW9uaWNQb3B1cC5wcm9tcHQoewogICAgICogICAgdGl0bGU6ICdQYXNzd29yZCBDaGVjaycsCiAgICAgKiAgICB0ZW1wbGF0ZTogJ0VudGVyIHlvdXIgc2VjcmV0IHBhc3N3b3JkJywKICAgICAqICAgIGlucHV0VHlwZTogJ3Bhc3N3b3JkJywKICAgICAqICAgIGlucHV0UGxhY2Vob2xkZXI6ICdZb3VyIHBhc3N3b3JkJwogICAgICogIH0pLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgKiAgICBjb25zb2xlLmxvZygnWW91ciBwYXNzd29yZCBpcycsIHJlcyk7CiAgICAgKiAgfSk7CiAgICAgKiBgYGAKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIGZvciBzaG93aW5nIHRoZSBwcm9tcHQgcG9wdXAsIG9mIHRoZSBmb3JtOgogICAgICoKICAgICAqIGBgYAogICAgICogewogICAgICogICB0aXRsZTogJycsIC8vIFN0cmluZy4gVGhlIHRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgc3ViVGl0bGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIHN1Yi10aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHRlbXBsYXRlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCBib2R5LgogICAgICogICB0ZW1wbGF0ZVVybDogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgVVJMIG9mIGFuIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwICAgYm9keS4KICAgICAqICAgaW5wdXRUeXBlOiAvLyBTdHJpbmcgKGRlZmF1bHQ6ICd0ZXh0JykuIFRoZSB0eXBlIG9mIGlucHV0IHRvIHVzZQogICAgICogICBpbnB1dFBsYWNlaG9sZGVyOiAvLyBTdHJpbmcgKGRlZmF1bHQ6ICcnKS4gQSBwbGFjZWhvbGRlciB0byB1c2UgZm9yIHRoZSBpbnB1dC4KICAgICAqICAgY2FuY2VsVGV4dDogLy8gU3RyaW5nIChkZWZhdWx0OiAnQ2FuY2VsJy4gVGhlIHRleHQgb2YgdGhlIENhbmNlbCBidXR0b24uCiAgICAgKiAgIGNhbmNlbFR5cGU6IC8vIFN0cmluZyAoZGVmYXVsdDogJ2J1dHRvbi1kZWZhdWx0JykuIFRoZSB0eXBlIG9mIHRoZSBDYW5jZWwgYnV0dG9uLgogICAgICogICBva1RleHQ6IC8vIFN0cmluZyAoZGVmYXVsdDogJ09LJykuIFRoZSB0ZXh0IG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiAgIG9rVHlwZTogLy8gU3RyaW5nIChkZWZhdWx0OiAnYnV0dG9uLXBvc2l0aXZlJykuIFRoZSB0eXBlIG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiB9CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wdXAgaXMgY2xvc2VkLiBIYXMgb25lIGFkZGl0aW9uYWwKICAgICAqIGZ1bmN0aW9uIGBjbG9zZWAsIHdoaWNoIGNhbiBiZSBjYWxsZWQgd2l0aCBhbnkgdmFsdWUgdG8gcHJvZ3JhbW1hdGljYWxseSBjbG9zZSB0aGUgcG9wdXAKICAgICAqIHdpdGggdGhlIGdpdmVuIHZhbHVlLgogICAgICovCiAgICBwcm9tcHQ6IHNob3dQcm9tcHQsCiAgICAvKioKICAgICAqIEBwcml2YXRlIGZvciB0ZXN0aW5nCiAgICAgKi8KICAgIF9jcmVhdGVQb3B1cDogY3JlYXRlUG9wdXAsCiAgICBfcG9wdXBTdGFjazogcG9wdXBTdGFjawogIH07CgogIHJldHVybiAkaW9uaWNQb3B1cDsKCiAgZnVuY3Rpb24gY3JlYXRlUG9wdXAob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgIHNjb3BlOiBudWxsLAogICAgICB0aXRsZTogJycsCiAgICAgIGJ1dHRvbnM6IFtdLAogICAgfSwgb3B0aW9ucyB8fCB7fSk7CgogICAgdmFyIHBvcHVwUHJvbWlzZSA9ICRpb25pY1RlbXBsYXRlTG9hZGVyLmNvbXBpbGUoewogICAgICB0ZW1wbGF0ZTogUE9QVVBfVFBMLAogICAgICBzY29wZTogb3B0aW9ucy5zY29wZSAmJiBvcHRpb25zLnNjb3BlLiRuZXcoKSwKICAgICAgYXBwZW5kVG86ICRpb25pY0JvZHkuZ2V0KCkKICAgIH0pOwogICAgdmFyIGNvbnRlbnRQcm9taXNlID0gb3B0aW9ucy50ZW1wbGF0ZVVybCA/CiAgICAgICRpb25pY1RlbXBsYXRlTG9hZGVyLmxvYWQob3B0aW9ucy50ZW1wbGF0ZVVybCkgOgogICAgICAkcS53aGVuKG9wdGlvbnMudGVtcGxhdGUgfHwgb3B0aW9ucy5jb250ZW50IHx8ICcnKTsKCiAgICByZXR1cm4gJHEuYWxsKFtwb3B1cFByb21pc2UsIGNvbnRlbnRQcm9taXNlXSkKICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdHMpIHsKICAgICAgdmFyIHNlbGYgPSByZXN1bHRzWzBdOwogICAgICB2YXIgY29udGVudCA9IHJlc3VsdHNbMV07CiAgICAgIHZhciByZXNwb25zZURlZmVycmVkID0gJHEuZGVmZXIoKTsKCiAgICAgIHNlbGYucmVzcG9uc2VEZWZlcnJlZCA9IHJlc3BvbnNlRGVmZXJyZWQ7CgogICAgICAvL0Nhbid0IG5nLWJpbmQtaHRtbCBmb3IgcG9wdXAtYm9keSBiZWNhdXNlIGl0IGNhbiBiZSBpbnNlY3VyZSBodG1sCiAgICAgIC8vKGVnIGFuIGlucHV0IGluIGNhc2Ugb2YgcHJvbXB0KQogICAgICB2YXIgYm9keSA9IGpxTGl0ZShzZWxmLmVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLnBvcHVwLWJvZHknKSk7CiAgICAgIGlmIChjb250ZW50KSB7CiAgICAgICAgYm9keS5odG1sKGNvbnRlbnQpOwogICAgICAgICRjb21waWxlKGJvZHkuY29udGVudHMoKSkoc2VsZi5zY29wZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYm9keS5yZW1vdmUoKTsKICAgICAgfQoKICAgICAgZXh0ZW5kKHNlbGYuc2NvcGUsIHsKICAgICAgICB0aXRsZTogb3B0aW9ucy50aXRsZSwKICAgICAgICBidXR0b25zOiBvcHRpb25zLmJ1dHRvbnMsCiAgICAgICAgc3ViVGl0bGU6IG9wdGlvbnMuc3ViVGl0bGUsCiAgICAgICAgJGJ1dHRvblRhcHBlZDogZnVuY3Rpb24oYnV0dG9uLCBldmVudCkgewogICAgICAgICAgdmFyIHJlc3VsdCA9IChidXR0b24ub25UYXAgfHwgYW5ndWxhci5ub29wKShldmVudCk7CiAgICAgICAgICBldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgZXZlbnQ7IC8vanF1ZXJ5IGV2ZW50cwoKICAgICAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICByZXNwb25zZURlZmVycmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgc2VsZi5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHNlbGYuaXNTaG93bikgcmV0dXJuOwoKICAgICAgICBzZWxmLmlzU2hvd24gPSB0cnVlOwogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgIC8vaWYgaGlkZGVuIHdoaWxlIHdhaXRpbmcgZm9yIHJhZiwgZG9uJ3Qgc2hvdwogICAgICAgICAgaWYgKCFzZWxmLmlzU2hvd24pIHJldHVybjsKCiAgICAgICAgICBzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoJ3BvcHVwLWhpZGRlbicpOwogICAgICAgICAgc2VsZi5lbGVtZW50LmFkZENsYXNzKCdwb3B1cC1zaG93aW5nIGFjdGl2ZScpOwogICAgICAgICAgZm9jdXNJbnB1dChzZWxmLmVsZW1lbnQpOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBzZWxmLmhpZGUgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgYW5ndWxhci5ub29wOwogICAgICAgIGlmICghc2VsZi5pc1Nob3duKSByZXR1cm4gY2FsbGJhY2soKTsKCiAgICAgICAgc2VsZi5pc1Nob3duID0gZmFsc2U7CiAgICAgICAgc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICBzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoJ3BvcHVwLWhpZGRlbicpOwogICAgICAgICR0aW1lb3V0KGNhbGxiYWNrLCAyNTApOwogICAgICB9OwogICAgICBzZWxmLnJlbW92ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChzZWxmLnJlbW92ZWQpIHJldHVybjsKCiAgICAgICAgc2VsZi5oaWRlKGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgc2VsZi5zY29wZS4kZGVzdHJveSgpOwogICAgICAgIH0pOwoKICAgICAgICBzZWxmLnJlbW92ZWQgPSB0cnVlOwogICAgICB9OwoKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIG9uSGFyZHdhcmVCYWNrQnV0dG9uKGUpIHsKICAgIHBvcHVwU3RhY2tbMF0gJiYgcG9wdXBTdGFja1swXS5yZXNwb25zZURlZmVycmVkLnJlc29sdmUoKTsKICB9CgogIGZ1bmN0aW9uIHNob3dQb3B1cChvcHRpb25zKSB7CiAgICB2YXIgcG9wdXBQcm9taXNlID0gJGlvbmljUG9wdXAuX2NyZWF0ZVBvcHVwKG9wdGlvbnMpOwogICAgdmFyIHByZXZpb3VzUG9wdXAgPSBwb3B1cFN0YWNrWzBdOwoKICAgIGlmIChwcmV2aW91c1BvcHVwKSB7CiAgICAgIHByZXZpb3VzUG9wdXAuaGlkZSgpOwogICAgfQoKICAgIHZhciByZXN1bHRQcm9taXNlID0gJHRpbWVvdXQoYW5ndWxhci5ub29wLCBwcmV2aW91c1BvcHVwID8gY29uZmlnLnN0YWNrUHVzaERlbGF5IDogMCkKICAgIC50aGVuKGZ1bmN0aW9uKCkgeyByZXR1cm4gcG9wdXBQcm9taXNlOyB9KQogICAgLnRoZW4oZnVuY3Rpb24ocG9wdXApIHsKICAgICAgaWYgKCFwcmV2aW91c1BvcHVwKSB7CiAgICAgICAgLy9BZGQgcG9wdXAtb3BlbiAmIGJhY2tkcm9wIGlmIHRoaXMgaXMgZmlyc3QgcG9wdXAKICAgICAgICAkaW9uaWNCb2R5LmFkZENsYXNzKCdwb3B1cC1vcGVuJyk7CiAgICAgICAgJGlvbmljQmFja2Ryb3AucmV0YWluKCk7CiAgICAgICAgLy9vbmx5IHNob3cgdGhlIGJhY2tkcm9wIG9uIHRoZSBmaXJzdCBwb3B1cAogICAgICAgICRpb25pY1BvcHVwLl9iYWNrQnV0dG9uQWN0aW9uRG9uZSA9ICRpb25pY1BsYXRmb3JtLnJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbigKICAgICAgICAgIG9uSGFyZHdhcmVCYWNrQnV0dG9uLAogICAgICAgICAgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfUE9QVVAKICAgICAgICApOwogICAgICB9CiAgICAgIHBvcHVwU3RhY2sudW5zaGlmdChwb3B1cCk7CiAgICAgIHBvcHVwLnNob3coKTsKCiAgICAgIC8vREVQUkVDQVRFRDogbm90aWZ5IHRoZSBwcm9taXNlIHdpdGggYW4gb2JqZWN0IHdpdGggYSBjbG9zZSBtZXRob2QKICAgICAgcG9wdXAucmVzcG9uc2VEZWZlcnJlZC5ub3RpZnkoewogICAgICAgIGNsb3NlOiByZXN1bHRQcm9taXNlLmNsb3NlCiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHBvcHVwLnJlc3BvbnNlRGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHZhciBpbmRleCA9IHBvcHVwU3RhY2suaW5kZXhPZihwb3B1cCk7CiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgICAgcG9wdXBTdGFjay5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgICBwb3B1cC5yZW1vdmUoKTsKCiAgICAgICAgdmFyIHByZXZpb3VzUG9wdXAgPSBwb3B1cFN0YWNrWzBdOwogICAgICAgIGlmIChwcmV2aW91c1BvcHVwKSB7CiAgICAgICAgICBwcmV2aW91c1BvcHVwLnNob3coKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy9SZW1vdmUgcG9wdXAtb3BlbiAmIGJhY2tkcm9wIGlmIHRoaXMgaXMgbGFzdCBwb3B1cAogICAgICAgICAgJGlvbmljQm9keS5yZW1vdmVDbGFzcygncG9wdXAtb3BlbicpOwogICAgICAgICAgJGlvbmljQmFja2Ryb3AucmVsZWFzZSgpOwogICAgICAgICAgKCRpb25pY1BvcHVwLl9iYWNrQnV0dG9uQWN0aW9uRG9uZSB8fCBhbmd1bGFyLm5vb3ApKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0pOwogICAgfSk7CgogICAgZnVuY3Rpb24gY2xvc2UocmVzdWx0KSB7CiAgICAgIHBvcHVwUHJvbWlzZS50aGVuKGZ1bmN0aW9uKHBvcHVwKSB7CiAgICAgICAgaWYgKCFwb3B1cC5yZW1vdmVkKSB7CiAgICAgICAgICBwb3B1cC5yZXNwb25zZURlZmVycmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmVzdWx0UHJvbWlzZS5jbG9zZSA9IGNsb3NlOwoKICAgIHJldHVybiByZXN1bHRQcm9taXNlOwogIH0KCiAgZnVuY3Rpb24gZm9jdXNJbnB1dChlbGVtZW50KSB7CiAgICB2YXIgZm9jdXNPbiA9IGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignW2F1dG9mb2N1c10nKTsKICAgIGlmIChmb2N1c09uKSB7CiAgICAgIGZvY3VzT24uZm9jdXMoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHNob3dBbGVydChvcHRzKSB7CiAgICByZXR1cm4gc2hvd1BvcHVwKCBleHRlbmQoewogICAgICBidXR0b25zOiBbewogICAgICAgIHRleHQ6IG9wdHMub2tUZXh0IHx8ICdPSycsCiAgICAgICAgdHlwZTogb3B0cy5va1R5cGUgfHwgJ2J1dHRvbi1wb3NpdGl2ZScsCiAgICAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfV0KICAgIH0sIG9wdHMgfHwge30pICk7CiAgfQoKICBmdW5jdGlvbiBzaG93Q29uZmlybShvcHRzKSB7CiAgICByZXR1cm4gc2hvd1BvcHVwKCBleHRlbmQoewogICAgICBidXR0b25zOiBbewogICAgICAgIHRleHQ6IG9wdHMuY2FuY2VsVGV4dCB8fCAnQ2FuY2VsJyAsCiAgICAgICAgdHlwZTogb3B0cy5jYW5jZWxUeXBlIHx8ICdidXR0b24tZGVmYXVsdCcsCiAgICAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIH0sIHsKICAgICAgICB0ZXh0OiBvcHRzLm9rVGV4dCB8fCAnT0snLAogICAgICAgIHR5cGU6IG9wdHMub2tUeXBlIHx8ICdidXR0b24tcG9zaXRpdmUnLAogICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7IHJldHVybiB0cnVlOyB9CiAgICAgIH1dCiAgICB9LCBvcHRzIHx8IHt9KSApOwogIH0KCiAgZnVuY3Rpb24gc2hvd1Byb21wdChvcHRzKSB7CiAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlLiRuZXcodHJ1ZSk7CiAgICBzY29wZS5kYXRhID0ge307CiAgICB2YXIgdGV4dCA9ICcnOwogICAgaWYob3B0cy50ZW1wbGF0ZSAmJiAvPFthLXpdW1xzXFNdKj4vaS50ZXN0KG9wdHMudGVtcGxhdGUpID09PSBmYWxzZSl7CiAgICAgIHRleHQgPSAnPHNwYW4+JytvcHRzLnRlbXBsYXRlKyc8L3NwYW4+JzsKICAgICAgZGVsZXRlIG9wdHMudGVtcGxhdGU7CiAgICB9CiAgICByZXR1cm4gc2hvd1BvcHVwKCBleHRlbmQoewogICAgICB0ZW1wbGF0ZTogdGV4dCsnPGlucHV0IG5nLW1vZGVsPSJkYXRhLnJlc3BvbnNlIiB0eXBlPSInICsgKG9wdHMuaW5wdXRUeXBlIHx8ICd0ZXh0JykgKwogICAgICAgICciIHBsYWNlaG9sZGVyPSInICsgKG9wdHMuaW5wdXRQbGFjZWhvbGRlciB8fCAnJykgKyAnIj4nLAogICAgICBzY29wZTogc2NvcGUsCiAgICAgIGJ1dHRvbnM6IFt7CiAgICAgICAgdGV4dDogb3B0cy5jYW5jZWxUZXh0IHx8ICdDYW5jZWwnLAogICAgICAgIHR5cGU6IG9wdHMuY2FuY2VsVHlwZXx8ICdidXR0b24tZGVmYXVsdCcsCiAgICAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHt9CiAgICAgIH0sIHsKICAgICAgICB0ZXh0OiBvcHRzLm9rVGV4dCB8fCAnT0snLAogICAgICAgIHR5cGU6IG9wdHMub2tUeXBlIHx8ICdidXR0b24tcG9zaXRpdmUnLAogICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICByZXR1cm4gc2NvcGUuZGF0YS5yZXNwb25zZSB8fCAnJzsKICAgICAgICB9CiAgICAgIH1dCiAgICB9LCBvcHRzIHx8IHt9KSApOwogIH0KfV0pOwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNQb3NpdGlvbgogKiBAbW9kdWxlIGlvbmljCiAqIEBkZXNjcmlwdGlvbgogKiBBIHNldCBvZiB1dGlsaXR5IG1ldGhvZHMgdGhhdCBjYW4gYmUgdXNlIHRvIHJldHJpZXZlIHBvc2l0aW9uIG9mIERPTSBlbGVtZW50cy4KICogSXQgaXMgbWVhbnQgdG8gYmUgdXNlZCB3aGVyZSB3ZSBuZWVkIHRvIGFic29sdXRlLXBvc2l0aW9uIERPTSBlbGVtZW50cyBpbgogKiByZWxhdGlvbiB0byBvdGhlciwgZXhpc3RpbmcgZWxlbWVudHMgKHRoaXMgaXMgdGhlIGNhc2UgZm9yIHRvb2x0aXBzLCBwb3BvdmVycywgZXRjLikuCiAqCiAqIEFkYXB0ZWQgZnJvbSBbQW5ndWxhclVJIEJvb3RzdHJhcF0oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItdWkvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL3NyYy9wb3NpdGlvbi9wb3NpdGlvbi5qcyksCiAqIChbbGljZW5zZV0oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItdWkvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpKQogKi8KSW9uaWNNb2R1bGUKLmZhY3RvcnkoJyRpb25pY1Bvc2l0aW9uJywgWyckZG9jdW1lbnQnLCAnJHdpbmRvdycsIGZ1bmN0aW9uICgkZG9jdW1lbnQsICR3aW5kb3cpIHsKCiAgZnVuY3Rpb24gZ2V0U3R5bGUoZWwsIGNzc3Byb3ApIHsKICAgIGlmIChlbC5jdXJyZW50U3R5bGUpIHsgLy9JRQogICAgICByZXR1cm4gZWwuY3VycmVudFN0eWxlW2Nzc3Byb3BdOwogICAgfSBlbHNlIGlmICgkd2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgcmV0dXJuICR3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbClbY3NzcHJvcF07CiAgICB9CiAgICAvLyBmaW5hbGx5IHRyeSBhbmQgZ2V0IGlubGluZSBzdHlsZQogICAgcmV0dXJuIGVsLnN0eWxlW2Nzc3Byb3BdOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgZ2l2ZW4gZWxlbWVudCBpcyBzdGF0aWNhbGx5IHBvc2l0aW9uZWQKICAgKiBAcGFyYW0gZWxlbWVudCAtIHJhdyBET00gZWxlbWVudAogICAqLwogIGZ1bmN0aW9uIGlzU3RhdGljUG9zaXRpb25lZChlbGVtZW50KSB7CiAgICByZXR1cm4gKGdldFN0eWxlKGVsZW1lbnQsICdwb3NpdGlvbicpIHx8ICdzdGF0aWMnICkgPT09ICdzdGF0aWMnOwogIH0KCiAgLyoqCiAgICogcmV0dXJucyB0aGUgY2xvc2VzdCwgbm9uLXN0YXRpY2FsbHkgcG9zaXRpb25lZCBwYXJlbnRPZmZzZXQgb2YgYSBnaXZlbiBlbGVtZW50CiAgICogQHBhcmFtIGVsZW1lbnQKICAgKi8KICB2YXIgcGFyZW50T2Zmc2V0RWwgPSBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgdmFyIGRvY0RvbUVsID0gJGRvY3VtZW50WzBdOwogICAgdmFyIG9mZnNldFBhcmVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50IHx8IGRvY0RvbUVsOwogICAgd2hpbGUgKG9mZnNldFBhcmVudCAmJiBvZmZzZXRQYXJlbnQgIT09IGRvY0RvbUVsICYmIGlzU3RhdGljUG9zaXRpb25lZChvZmZzZXRQYXJlbnQpICkgewogICAgICBvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwogICAgfQogICAgcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2NEb21FbDsKICB9OwoKICByZXR1cm4gewogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNQb3NpdGlvbiNwb3NpdGlvbgogICAgICogQGRlc2NyaXB0aW9uIEdldCB0aGUgY3VycmVudCBjb29yZGluYXRlcyBvZiB0aGUgZWxlbWVudCwgcmVsYXRpdmUgdG8gdGhlIG9mZnNldCBwYXJlbnQuCiAgICAgKiBSZWFkLW9ubHkgZXF1aXZhbGVudCBvZiBbalF1ZXJ5J3MgcG9zaXRpb24gZnVuY3Rpb25dKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wb3NpdGlvbi8pLgogICAgICogQHBhcmFtIHtlbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGdldCB0aGUgcG9zaXRpb24gb2YuCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBwcm9wZXJ0aWVzIHRvcCwgbGVmdCwgd2lkdGggYW5kIGhlaWdodC4KICAgICAqLwogICAgcG9zaXRpb246IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgIHZhciBlbEJDUiA9IHRoaXMub2Zmc2V0KGVsZW1lbnQpOwogICAgICB2YXIgb2Zmc2V0UGFyZW50QkNSID0geyB0b3A6IDAsIGxlZnQ6IDAgfTsKICAgICAgdmFyIG9mZnNldFBhcmVudEVsID0gcGFyZW50T2Zmc2V0RWwoZWxlbWVudFswXSk7CiAgICAgIGlmIChvZmZzZXRQYXJlbnRFbCAhPSAkZG9jdW1lbnRbMF0pIHsKICAgICAgICBvZmZzZXRQYXJlbnRCQ1IgPSB0aGlzLm9mZnNldChhbmd1bGFyLmVsZW1lbnQob2Zmc2V0UGFyZW50RWwpKTsKICAgICAgICBvZmZzZXRQYXJlbnRCQ1IudG9wICs9IG9mZnNldFBhcmVudEVsLmNsaWVudFRvcCAtIG9mZnNldFBhcmVudEVsLnNjcm9sbFRvcDsKICAgICAgICBvZmZzZXRQYXJlbnRCQ1IubGVmdCArPSBvZmZzZXRQYXJlbnRFbC5jbGllbnRMZWZ0IC0gb2Zmc2V0UGFyZW50RWwuc2Nyb2xsTGVmdDsKICAgICAgfQoKICAgICAgdmFyIGJvdW5kaW5nQ2xpZW50UmVjdCA9IGVsZW1lbnRbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgd2lkdGg6IGJvdW5kaW5nQ2xpZW50UmVjdC53aWR0aCB8fCBlbGVtZW50LnByb3AoJ29mZnNldFdpZHRoJyksCiAgICAgICAgaGVpZ2h0OiBib3VuZGluZ0NsaWVudFJlY3QuaGVpZ2h0IHx8IGVsZW1lbnQucHJvcCgnb2Zmc2V0SGVpZ2h0JyksCiAgICAgICAgdG9wOiBlbEJDUi50b3AgLSBvZmZzZXRQYXJlbnRCQ1IudG9wLAogICAgICAgIGxlZnQ6IGVsQkNSLmxlZnQgLSBvZmZzZXRQYXJlbnRCQ1IubGVmdAogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1Bvc2l0aW9uI29mZnNldAogICAgICogQGRlc2NyaXB0aW9uIEdldCB0aGUgY3VycmVudCBjb29yZGluYXRlcyBvZiB0aGUgZWxlbWVudCwgcmVsYXRpdmUgdG8gdGhlIGRvY3VtZW50LgogICAgICogUmVhZC1vbmx5IGVxdWl2YWxlbnQgb2YgW2pRdWVyeSdzIG9mZnNldCBmdW5jdGlvbl0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29mZnNldC8pLgogICAgICogQHBhcmFtIHtlbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGdldCB0aGUgb2Zmc2V0IG9mLgogICAgICogQHJldHVybnMge29iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgcHJvcGVydGllcyB0b3AsIGxlZnQsIHdpZHRoIGFuZCBoZWlnaHQuCiAgICAgKi8KICAgIG9mZnNldDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgdmFyIGJvdW5kaW5nQ2xpZW50UmVjdCA9IGVsZW1lbnRbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgd2lkdGg6IGJvdW5kaW5nQ2xpZW50UmVjdC53aWR0aCB8fCBlbGVtZW50LnByb3AoJ29mZnNldFdpZHRoJyksCiAgICAgICAgaGVpZ2h0OiBib3VuZGluZ0NsaWVudFJlY3QuaGVpZ2h0IHx8IGVsZW1lbnQucHJvcCgnb2Zmc2V0SGVpZ2h0JyksCiAgICAgICAgdG9wOiBib3VuZGluZ0NsaWVudFJlY3QudG9wICsgKCR3aW5kb3cucGFnZVlPZmZzZXQgfHwgJGRvY3VtZW50WzBdLmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3ApLAogICAgICAgIGxlZnQ6IGJvdW5kaW5nQ2xpZW50UmVjdC5sZWZ0ICsgKCR3aW5kb3cucGFnZVhPZmZzZXQgfHwgJGRvY3VtZW50WzBdLmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0KQogICAgICB9OwogICAgfQoKICB9Owp9XSk7CgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyBzY3JvbGxWaWV3cyAoY3JlYXRlZCBieQogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkNvbnRlbnR9IGFuZAogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNjcm9sbH0gZGlyZWN0aXZlcykuCiAqCiAqIE1ldGhvZHMgY2FsbGVkIGRpcmVjdGx5IG9uIHRoZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSBzZXJ2aWNlIHdpbGwgY29udHJvbCBhbGwgc2Nyb2xsCiAqIHZpZXdzLiAgVXNlIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTY3JvbGxEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUgJGdldEJ5SGFuZGxlfQogKiBtZXRob2QgdG8gY29udHJvbCBzcGVjaWZpYyBzY3JvbGxWaWV3cy4KICoKICogQHVzYWdlCiAqCiAqIGBgYGh0bWwKICogPGJvZHkgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogKiAgIDxpb24tY29udGVudD4KICogICAgIDxidXR0b24gbmctY2xpY2s9InNjcm9sbFRvcCgpIj5TY3JvbGwgdG8gVG9wITwvYnV0dG9uPgogKiAgIDwvaW9uLWNvbnRlbnQ+CiAqIDwvYm9keT4KICogYGBgCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIE1haW5DdHJsKCRzY29wZSwgJGlvbmljU2Nyb2xsRGVsZWdhdGUpIHsKICogICAkc2NvcGUuc2Nyb2xsVG9wID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS5zY3JvbGxUb3AoKTsKICogICB9OwogKiB9CiAqIGBgYAogKgogKiBFeGFtcGxlIG9mIGFkdmFuY2VkIHVzYWdlLCB3aXRoIHR3byBzY3JvbGwgYXJlYXMgdXNpbmcgYGRlbGVnYXRlLWhhbmRsZWAKICogZm9yIGZpbmUgY29udHJvbC4KICoKICogYGBgaHRtbAogKiA8Ym9keSBuZy1jb250cm9sbGVyPSJNYWluQ3RybCI+CiAqICAgPGlvbi1jb250ZW50IGRlbGVnYXRlLWhhbmRsZT0ibWFpblNjcm9sbCI+CiAqICAgICA8YnV0dG9uIG5nLWNsaWNrPSJzY3JvbGxNYWluVG9Ub3AoKSI+CiAqICAgICAgIFNjcm9sbCBjb250ZW50IHRvIHRvcCEKICogICAgIDwvYnV0dG9uPgogKiAgICAgPGlvbi1zY3JvbGwgZGVsZWdhdGUtaGFuZGxlPSJzbWFsbCIgc3R5bGU9ImhlaWdodDogMTAwcHg7Ij4KICogICAgICAgPGJ1dHRvbiBuZy1jbGljaz0ic2Nyb2xsU21hbGxUb1RvcCgpIj4KICogICAgICAgICBTY3JvbGwgc21hbGwgYXJlYSB0byB0b3AhCiAqICAgICAgIDwvYnV0dG9uPgogKiAgICAgPC9pb24tc2Nyb2xsPgogKiAgIDwvaW9uLWNvbnRlbnQ+CiAqIDwvYm9keT4KICogYGBgCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIE1haW5DdHJsKCRzY29wZSwgJGlvbmljU2Nyb2xsRGVsZWdhdGUpIHsKICogICAkc2NvcGUuc2Nyb2xsTWFpblRvVG9wID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ21haW5TY3JvbGwnKS5zY3JvbGxUb3AoKTsKICogICB9OwogKiAgICRzY29wZS5zY3JvbGxTbWFsbFRvVG9wID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ3NtYWxsJykuc2Nyb2xsVG9wKCk7CiAqICAgfTsKICogfQogKiBgYGAKICovCklvbmljTW9kdWxlCi5zZXJ2aWNlKCckaW9uaWNTY3JvbGxEZWxlZ2F0ZScsIGRlbGVnYXRlU2VydmljZShbCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3Jlc2l6ZQogICAqIEBkZXNjcmlwdGlvbiBUZWxsIHRoZSBzY3JvbGxWaWV3IHRvIHJlY2FsY3VsYXRlIHRoZSBzaXplIG9mIGl0cyBjb250YWluZXIuCiAgICovCiAgJ3Jlc2l6ZScsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3Njcm9sbFRvcAogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0aGUgc2Nyb2xsIHNob3VsZCBhbmltYXRlLgogICAqLwogICdzY3JvbGxUb3AnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNzY3JvbGxCb3R0b20KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRBbmltYXRlIFdoZXRoZXIgdGhlIHNjcm9sbCBzaG91bGQgYW5pbWF0ZS4KICAgKi8KICAnc2Nyb2xsQm90dG9tJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsVG8KICAgKiBAcGFyYW0ge251bWJlcn0gbGVmdCBUaGUgeC12YWx1ZSB0byBzY3JvbGwgdG8uCiAgICogQHBhcmFtIHtudW1iZXJ9IHRvcCBUaGUgeS12YWx1ZSB0byBzY3JvbGwgdG8uCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkQW5pbWF0ZSBXaGV0aGVyIHRoZSBzY3JvbGwgc2hvdWxkIGFuaW1hdGUuCiAgICovCiAgJ3Njcm9sbFRvJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsQnkKICAgKiBAcGFyYW0ge251bWJlcn0gbGVmdCBUaGUgeC1vZmZzZXQgdG8gc2Nyb2xsIGJ5LgogICAqIEBwYXJhbSB7bnVtYmVyfSB0b3AgVGhlIHktb2Zmc2V0IHRvIHNjcm9sbCBieS4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRBbmltYXRlIFdoZXRoZXIgdGhlIHNjcm9sbCBzaG91bGQgYW5pbWF0ZS4KICAgKi8KICAnc2Nyb2xsQnknLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSN6b29tVG8KICAgKiBAcGFyYW0ge251bWJlcn0gbGV2ZWwgTGV2ZWwgdG8gem9vbSB0by4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBhbmltYXRlIFdoZXRoZXIgdG8gYW5pbWF0ZSB0aGUgem9vbS4KICAgKiBAcGFyYW0ge251bWJlcj19IG9yaWdpbkxlZnQgWm9vbSBpbiBhdCBnaXZlbiBsZWZ0IGNvb3JkaW5hdGUuCiAgICogQHBhcmFtIHtudW1iZXI9fSBvcmlnaW5Ub3AgWm9vbSBpbiBhdCBnaXZlbiB0b3AgY29vcmRpbmF0ZS4KICAgKi8KICAnem9vbVRvJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjem9vbUJ5CiAgICogQHBhcmFtIHtudW1iZXJ9IGZhY3RvciBUaGUgZmFjdG9yIHRvIHpvb20gYnkuCiAgICogQHBhcmFtIHtib29sZWFuPX0gYW5pbWF0ZSBXaGV0aGVyIHRvIGFuaW1hdGUgdGhlIHpvb20uCiAgICogQHBhcmFtIHtudW1iZXI9fSBvcmlnaW5MZWZ0IFpvb20gaW4gYXQgZ2l2ZW4gbGVmdCBjb29yZGluYXRlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gb3JpZ2luVG9wIFpvb20gaW4gYXQgZ2l2ZW4gdG9wIGNvb3JkaW5hdGUuCiAgICovCiAgJ3pvb21CeScsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI2dldFNjcm9sbFBvc2l0aW9uCiAgICogQHJldHVybnMge29iamVjdH0gVGhlIHNjcm9sbCBwb3NpdGlvbiBvZiB0aGlzIHZpZXcsIHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAqICAtIGB7bnVtYmVyfWAgYGxlZnRgIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBoYXMgc2Nyb2xsZWQgZnJvbSB0aGUgbGVmdCAoc3RhcnRzIGF0IDApLgogICAqICAtIGB7bnVtYmVyfWAgYHRvcGAgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIGhhcyBzY3JvbGxlZCBmcm9tIHRoZSB0b3AgKHN0YXJ0cyBhdCAwKS4KICAgKi8KICAnZ2V0U2Nyb2xsUG9zaXRpb24nLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNhbmNob3JTY3JvbGwKICAgKiBAZGVzY3JpcHRpb24gVGVsbCB0aGUgc2Nyb2xsVmlldyB0byBzY3JvbGwgdG8gdGhlIGVsZW1lbnQgd2l0aCBhbiBpZAogICAqIG1hdGNoaW5nIHdpbmRvdy5sb2NhdGlvbi5oYXNoLgogICAqCiAgICogSWYgbm8gbWF0Y2hpbmcgZWxlbWVudCBpcyBmb3VuZCwgaXQgd2lsbCBzY3JvbGwgdG8gdG9wLgogICAqCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkQW5pbWF0ZSBXaGV0aGVyIHRoZSBzY3JvbGwgc2hvdWxkIGFuaW1hdGUuCiAgICovCiAgJ2FuY2hvclNjcm9sbCcsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI2dldFNjcm9sbFZpZXcKICAgKiBAcmV0dXJucyB7b2JqZWN0fSBUaGUgc2Nyb2xsVmlldyBhc3NvY2lhdGVkIHdpdGggdGhpcyBkZWxlZ2F0ZS4KICAgKi8KICAnZ2V0U2Nyb2xsVmlldycsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3JlbWVtYmVyU2Nyb2xsUG9zaXRpb24KICAgKiBAZGVzY3JpcHRpb24KICAgKiBXaWxsIG1ha2UgaXQgc28sIHdoZW4gdGhpcyBzY3JvbGxWaWV3IGlzIGRlc3Ryb3llZCAodXNlciBsZWF2ZXMgdGhlIHBhZ2UpLAogICAqIHRoZSBsYXN0IHNjcm9sbCBwb3NpdGlvbiB0aGUgcGFnZSB3YXMgb24gd2lsbCBiZSBzYXZlZCwgaW5kZXhlZCBieSB0aGUKICAgKiBnaXZlbiBpZC4KICAgKgogICAqIE5vdGU6IGZvciBwYWdlcyBhc3NvY2lhdGVkIHdpdGggYSB2aWV3IHVuZGVyIGFuIGlvbi1uYXYtdmlldywKICAgKiByZW1lbWJlclNjcm9sbFBvc2l0aW9uIGF1dG9tYXRpY2FsbHkgc2F2ZXMgdGhlaXIgc2Nyb2xsLgogICAqCiAgICogUmVsYXRlZCBtZXRob2RzOiBzY3JvbGxUb1JlbWVtYmVyZWRQb3NpdGlvbiwgZm9yZ2V0U2Nyb2xsUG9zaXRpb24gKGJlbG93KS4KICAgKgogICAqIEluIHRoZSBmb2xsb3dpbmcgZXhhbXBsZSwgdGhlIHNjcm9sbCBwb3NpdGlvbiBvZiB0aGUgaW9uLXNjcm9sbCBlbGVtZW50CiAgICogd2lsbCBwZXJzaXN0LCBldmVuIHdoZW4gdGhlIHVzZXIgY2hhbmdlcyB0aGUgdG9nZ2xlIHN3aXRjaC4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLXRvZ2dsZSBuZy1tb2RlbD0ic2hvdWxkU2hvd1Njcm9sbFZpZXciPjwvaW9uLXRvZ2dsZT4KICAgKiA8aW9uLXNjcm9sbCBkZWxlZ2F0ZS1oYW5kbGU9Im15U2Nyb2xsIiBuZy1pZj0ic2hvdWxkU2hvd1Njcm9sbFZpZXciPgogICAqICAgPGRpdiBuZy1jb250cm9sbGVyPSJTY3JvbGxDdHJsIj4KICAgKiAgICAgPGlvbi1saXN0PgogICAqICAgICAgIHslIHJhdyAlfTxpb24taXRlbSBuZy1yZXBlYXQ9ImkgaW4gaXRlbXMiPnt7aX19PC9pb24taXRlbT57JSBlbmRyYXcgJX0KICAgKiAgICAgPC9pb24tbGlzdD4KICAgKiAgIDwvZGl2PgogICAqIDwvaW9uLXNjcm9sbD4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIFNjcm9sbEN0cmwoJHNjb3BlLCAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSkgewogICAqICAgdmFyIGRlbGVnYXRlID0gJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteVNjcm9sbCcpOwogICAqCiAgICogICAvLyBQdXQgYW55IHVuaXF1ZSBJRCBoZXJlLiAgVGhlIHBvaW50IG9mIHRoaXMgaXM6IGV2ZXJ5IHRpbWUgdGhlIGNvbnRyb2xsZXIgaXMgcmVjcmVhdGVkCiAgICogICAvLyB3ZSB3YW50IHRvIGxvYWQgdGhlIGNvcnJlY3QgcmVtZW1iZXJlZCBzY3JvbGwgdmFsdWVzLgogICAqICAgZGVsZWdhdGUucmVtZW1iZXJTY3JvbGxQb3NpdGlvbignbXktc2Nyb2xsLWlkJyk7CiAgICogICBkZWxlZ2F0ZS5zY3JvbGxUb1JlbWVtYmVyZWRQb3NpdGlvbigpOwogICAqICAgJHNjb3BlLml0ZW1zID0gW107CiAgICogICBmb3IgKHZhciBpPTA7IGk8MTAwOyBpKyspIHsKICAgKiAgICAgJHNjb3BlLml0ZW1zLnB1c2goaSk7CiAgICogICB9CiAgICogfQogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlkIFRoZSBpZCB0byByZW1lbWJlciB0aGUgc2Nyb2xsIHBvc2l0aW9uIG9mIHRoaXMKICAgKiBzY3JvbGxWaWV3IGJ5LgogICAqLwogICdyZW1lbWJlclNjcm9sbFBvc2l0aW9uJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjZm9yZ2V0U2Nyb2xsUG9zaXRpb24KICAgKiBAZGVzY3JpcHRpb24KICAgKiBTdG9wIHJlbWVtYmVyaW5nIHRoZSBzY3JvbGwgcG9zaXRpb24gZm9yIHRoaXMgc2Nyb2xsVmlldy4KICAgKi8KICAnZm9yZ2V0U2Nyb2xsUG9zaXRpb24nLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNzY3JvbGxUb1JlbWVtYmVyZWRQb3NpdGlvbgogICAqIEBkZXNjcmlwdGlvbgogICAqIElmIHRoaXMgc2Nyb2xsVmlldyBoYXMgYW4gaWQgYXNzb2NpYXRlZCB3aXRoIGl0cyBzY3JvbGwgcG9zaXRpb24sCiAgICogKHRocm91Z2ggY2FsbGluZyByZW1lbWJlclNjcm9sbFBvc2l0aW9uKSwgYW5kIHRoYXQgcG9zaXRpb24gaXMgcmVtZW1iZXJlZCwKICAgKiBsb2FkIHRoZSBwb3NpdGlvbiBhbmQgc2Nyb2xsIHRvIGl0LgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0byBhbmltYXRlIHRoZSBzY3JvbGwuCiAgICovCiAgJ3Njcm9sbFRvUmVtZW1iZXJlZFBvc2l0aW9uJwogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUKICAgKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlCiAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAqIHNjcm9sbFZpZXdzIHdpdGggYGRlbGVnYXRlLWhhbmRsZWAgbWF0Y2hpbmcgdGhlIGdpdmVuIGhhbmRsZS4KICAgKgogICAqIEV4YW1wbGU6IGAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215LWhhbmRsZScpLnNjcm9sbFRvcCgpO2AKICAgKi8KXSkpOwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlCiAqIEBtb2R1bGUgaW9uaWMKICoKICogQGRlc2NyaXB0aW9uCiAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXN9IGRpcmVjdGl2ZS4KICoKICogTWV0aG9kcyBjYWxsZWQgZGlyZWN0bHkgb24gdGhlICRpb25pY1NpZGVNZW51RGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIHNpZGUKICogbWVudXMuICBVc2UgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1NpZGVNZW51RGVsZWdhdGUjJGdldEJ5SGFuZGxlICRnZXRCeUhhbmRsZX0KICogbWV0aG9kIHRvIGNvbnRyb2wgc3BlY2lmaWMgaW9uU2lkZU1lbnVzIGluc3RhbmNlcy4KICoKICogQHVzYWdlCiAqCiAqIGBgYGh0bWwKICogPGJvZHkgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogKiAgIDxpb24tc2lkZS1tZW51cz4KICogICAgIDxpb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAqICAgICAgIENvbnRlbnQhCiAqICAgICAgIDxidXR0b24gbmctY2xpY2s9InRvZ2dsZUxlZnRTaWRlTWVudSgpIj4KICogICAgICAgICBUb2dnbGUgTGVmdCBTaWRlIE1lbnUKICogICAgICAgPC9idXR0b24+CiAqICAgICA8L2lvbi1zaWRlLW1lbnUtY29udGVudD4KICogICAgIDxpb24tc2lkZS1tZW51IHNpZGU9ImxlZnQiPgogKiAgICAgICBMZWZ0IE1lbnUhCiAqICAgICA8aW9uLXNpZGUtbWVudT4KICogICA8L2lvbi1zaWRlLW1lbnVzPgogKiA8L2JvZHk+CiAqIGBgYAogKiBgYGBqcwogKiBmdW5jdGlvbiBNYWluQ3RybCgkc2NvcGUsICRpb25pY1NpZGVNZW51RGVsZWdhdGUpIHsKICogICAkc2NvcGUudG9nZ2xlTGVmdFNpZGVNZW51ID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTaWRlTWVudURlbGVnYXRlLnRvZ2dsZUxlZnQoKTsKICogICB9OwogKiB9CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLnNlcnZpY2UoJyRpb25pY1NpZGVNZW51RGVsZWdhdGUnLCBkZWxlZ2F0ZVNlcnZpY2UoWwogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI3RvZ2dsZUxlZnQKICAgKiBAZGVzY3JpcHRpb24gVG9nZ2xlIHRoZSBsZWZ0IHNpZGUgbWVudSAoaWYgaXQgZXhpc3RzKS4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBpc09wZW4gV2hldGhlciB0byBvcGVuIG9yIGNsb3NlIHRoZSBtZW51LgogICAqIERlZmF1bHQ6IFRvZ2dsZXMgdGhlIG1lbnUuCiAgICovCiAgJ3RvZ2dsZUxlZnQnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI3RvZ2dsZVJpZ2h0CiAgICogQGRlc2NyaXB0aW9uIFRvZ2dsZSB0aGUgcmlnaHQgc2lkZSBtZW51IChpZiBpdCBleGlzdHMpLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IGlzT3BlbiBXaGV0aGVyIHRvIG9wZW4gb3IgY2xvc2UgdGhlIG1lbnUuCiAgICogRGVmYXVsdDogVG9nZ2xlcyB0aGUgbWVudS4KICAgKi8KICAndG9nZ2xlUmlnaHQnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2dldE9wZW5SYXRpbwogICAqIEBkZXNjcmlwdGlvbiBHZXRzIHRoZSByYXRpbyBvZiBvcGVuIGFtb3VudCBvdmVyIG1lbnUgd2lkdGguIEZvciBleGFtcGxlLCBhCiAgICogbWVudSBvZiB3aWR0aCAxMDAgdGhhdCBpcyBvcGVuZWQgYnkgNTAgcGl4ZWxzIGlzIDUwJSBvcGVuZWQsIGFuZCB3b3VsZCByZXR1cm4KICAgKiBhIHJhdGlvIG9mIDAuNS4KICAgKgogICAqIEByZXR1cm5zIHtmbG9hdH0gMCBpZiBub3RoaW5nIGlzIG9wZW4sIGJldHdlZW4gMCBhbmQgMSBpZiBsZWZ0IG1lbnUgaXMKICAgKiBvcGVuZWQvb3BlbmluZywgYW5kIGJldHdlZW4gMCBhbmQgLTEgaWYgcmlnaHQgbWVudSBpcyBvcGVuZWQvb3BlbmluZy4KICAgKi8KICAnZ2V0T3BlblJhdGlvJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNpc09wZW4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciBlaXRoZXIgdGhlIGxlZnQgb3IgcmlnaHQgbWVudSBpcyBjdXJyZW50bHkgb3BlbmVkLgogICAqLwogICdpc09wZW4nLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2lzT3BlbkxlZnQKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgbGVmdCBtZW51IGlzIGN1cnJlbnRseSBvcGVuZWQuCiAgICovCiAgJ2lzT3BlbkxlZnQnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2lzT3BlblJpZ2h0CiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJpZ2h0IG1lbnUgaXMgY3VycmVudGx5IG9wZW5lZC4KICAgKi8KICAnaXNPcGVuUmlnaHQnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2NhbkRyYWdDb250ZW50CiAgICogQHBhcmFtIHtib29sZWFuPX0gY2FuRHJhZyBTZXQgd2hldGhlciB0aGUgY29udGVudCBjYW4gb3IgY2Fubm90IGJlIGRyYWdnZWQgdG8gb3BlbgogICAqIHNpZGUgbWVudXMuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGNvbnRlbnQgY2FuIGJlIGRyYWdnZWQgdG8gb3BlbiBzaWRlIG1lbnVzLgogICAqLwogICdjYW5EcmFnQ29udGVudCcsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NpZGVNZW51RGVsZWdhdGUjZWRnZURyYWdUaHJlc2hvbGQKICAgKiBAcGFyYW0ge2Jvb2xlYW58bnVtYmVyPX0gdmFsdWUgU2V0IHdoZXRoZXIgdGhlIGNvbnRlbnQgZHJhZyBjYW4gb25seSBzdGFydCBpZiBpdCBpcyBiZWxvdyBhIGNlcnRhaW4gdGhyZXNob2xkIGRpc3RhbmNlIGZyb20gdGhlIGVkZ2Ugb2YgdGhlIHNjcmVlbi4gQWNjZXB0cyB0aHJlZSBkaWZmZXJlbnQgdmFsdWVzOgogICAqICAtIElmIGEgbm9uLXplcm8gbnVtYmVyIGlzIGdpdmVuLCB0aGF0IG1hbnkgcGl4ZWxzIGlzIHVzZWQgYXMgdGhlIG1heGltdW0gYWxsb3dlZCBkaXN0YW5jZSBmcm9tIHRoZSBlZGdlIHRoYXQgc3RhcnRzIGRyYWdnaW5nIHRoZSBzaWRlIG1lbnUuCiAgICogIC0gSWYgdHJ1ZSBpcyBnaXZlbiwgdGhlIGRlZmF1bHQgbnVtYmVyIG9mIHBpeGVscyAoMjUpIGlzIHVzZWQgYXMgdGhlIG1heGltdW0gYWxsb3dlZCBkaXN0YW5jZS4KICAgKiAgLSBJZiBmYWxzZSBvciAwIGlzIGdpdmVuLCB0aGUgZWRnZSBkcmFnIHRocmVzaG9sZCBpcyBkaXNhYmxlZCwgYW5kIGRyYWdnaW5nIGZyb20gYW55d2hlcmUgb24gdGhlIGNvbnRlbnQgaXMgYWxsb3dlZC4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZHJhZyBjYW4gc3RhcnQgb25seSBmcm9tIHdpdGhpbiB0aGUgZWRnZSBvZiBzY3JlZW4gdGhyZXNob2xkLgogICAqLwogICdlZGdlRHJhZ1RocmVzaG9sZCcsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NpZGVNZW51RGVsZWdhdGUjJGdldEJ5SGFuZGxlCiAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAqIEByZXR1cm5zIGBkZWxlZ2F0ZUluc3RhbmNlYCBBIGRlbGVnYXRlIGluc3RhbmNlIHRoYXQgY29udHJvbHMgb25seSB0aGUKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51c30gZGlyZWN0aXZlcyB3aXRoIGBkZWxlZ2F0ZS1oYW5kbGVgIG1hdGNoaW5nCiAgICogdGhlIGdpdmVuIGhhbmRsZS4KICAgKgogICAqIEV4YW1wbGU6IGAkaW9uaWNTaWRlTWVudURlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXktaGFuZGxlJykudG9nZ2xlTGVmdCgpO2AKICAgKi8KXSkpOwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlc2NyaXB0aW9uCiAqIERlbGVnYXRlIHRoYXQgY29udHJvbHMgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2xpZGVCb3h9IGRpcmVjdGl2ZS4KICoKICogTWV0aG9kcyBjYWxsZWQgZGlyZWN0bHkgb24gdGhlICRpb25pY1NsaWRlQm94RGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIHNsaWRlIGJveGVzLiAgVXNlIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTbGlkZUJveERlbGVnYXRlIyRnZXRCeUhhbmRsZSAkZ2V0QnlIYW5kbGV9CiAqIG1ldGhvZCB0byBjb250cm9sIHNwZWNpZmljIHNsaWRlIGJveCBpbnN0YW5jZXMuCiAqCiAqIEB1c2FnZQogKgogKiBgYGBodG1sCiAqIDxib2R5IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAqICAgPGlvbi1zbGlkZS1ib3g+CiAqICAgICA8aW9uLXNsaWRlPgogKiAgICAgICA8ZGl2IGNsYXNzPSJib3ggYmx1ZSI+CiAqICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0ibmV4dFNsaWRlKCkiPk5leHQgc2xpZGUhPC9idXR0b24+CiAqICAgICAgIDwvZGl2PgogKiAgICAgPC9pb24tc2xpZGU+CiAqICAgICA8aW9uLXNsaWRlPgogKiAgICAgICA8ZGl2IGNsYXNzPSJib3ggcmVkIj4KICogICAgICAgICBTbGlkZSAyIQogKiAgICAgICA8L2Rpdj4KICogICAgIDwvaW9uLXNsaWRlPgogKiAgIDwvaW9uLXNsaWRlLWJveD4KICogPC9ib2R5PgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSkgewogKiAgICRzY29wZS5uZXh0U2xpZGUgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY1NsaWRlQm94RGVsZWdhdGUubmV4dCgpOwogKiAgIH0KICogfQogKiBgYGAKICovCklvbmljTW9kdWxlCi5zZXJ2aWNlKCckaW9uaWNTbGlkZUJveERlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSN1cGRhdGUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVcGRhdGUgdGhlIHNsaWRlYm94IChmb3IgZXhhbXBsZSBpZiB1c2luZyBBbmd1bGFyIHdpdGggbmctcmVwZWF0LAogICAqIHJlc2l6ZSBpdCBmb3IgdGhlIGVsZW1lbnRzIGluc2lkZSkuCiAgICovCiAgJ3VwZGF0ZScsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjc2xpZGUKICAgKiBAcGFyYW0ge251bWJlcn0gdG8gVGhlIGluZGV4IHRvIHNsaWRlIHRvLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gc3BlZWQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgZm9yIHRoZSBjaGFuZ2UgdG8gdGFrZS4KICAgKi8KICAnc2xpZGUnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI2VuYWJsZVNsaWRlCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkRW5hYmxlIFdoZXRoZXIgdG8gZW5hYmxlIHNsaWRpbmcgdGhlIHNsaWRlYm94LgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHNsaWRpbmcgaXMgZW5hYmxlZC4KICAgKi8KICAnZW5hYmxlU2xpZGUnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI3ByZXZpb3VzCiAgICogQGRlc2NyaXB0aW9uIEdvIHRvIHRoZSBwcmV2aW91cyBzbGlkZS4gV3JhcHMgYXJvdW5kIGlmIGF0IHRoZSBiZWdpbm5pbmcuCiAgICovCiAgJ3ByZXZpb3VzJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNuZXh0CiAgICogQGRlc2NyaXB0aW9uIEdvIHRvIHRoZSBuZXh0IHNsaWRlLiBXcmFwcyBhcm91bmQgaWYgYXQgdGhlIGVuZC4KICAgKi8KICAnbmV4dCcsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjc3RvcAogICAqIEBkZXNjcmlwdGlvbiBTdG9wIHNsaWRpbmcuIFRoZSBzbGlkZUJveCB3aWxsIG5vdCBtb3ZlIGFnYWluIHVudGlsCiAgICogZXhwbGljaXRseSB0b2xkIHRvIGRvIHNvLgogICAqLwogICdzdG9wJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNzdGFydAogICAqIEBkZXNjcmlwdGlvbiBTdGFydCBzbGlkaW5nIGFnYWluIGlmIHRoZSBzbGlkZUJveCB3YXMgc3RvcHBlZC4gCiAgICovCiAgJ3N0YXJ0JywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNjdXJyZW50SW5kZXgKICAgKiBAcmV0dXJucyBudW1iZXIgVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IHNsaWRlLgogICAqLwogICdjdXJyZW50SW5kZXgnLAogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI3NsaWRlc0NvdW50CiAgICogQHJldHVybnMgbnVtYmVyIFRoZSBudW1iZXIgb2Ygc2xpZGVzIHRoZXJlIGFyZSBjdXJyZW50bHkuCiAgICovCiAgJ3NsaWRlc0NvdW50JwogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAqIEBwYXJhbSB7c3RyaW5nfSBoYW5kbGUKICAgKiBAcmV0dXJucyBgZGVsZWdhdGVJbnN0YW5jZWAgQSBkZWxlZ2F0ZSBpbnN0YW5jZSB0aGF0IGNvbnRyb2xzIG9ubHkgdGhlCiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TbGlkZUJveH0gZGlyZWN0aXZlcyB3aXRoIGBkZWxlZ2F0ZS1oYW5kbGVgIG1hdGNoaW5nCiAgICogdGhlIGdpdmVuIGhhbmRsZS4KICAgKgogICAqIEV4YW1wbGU6IGAkaW9uaWNTbGlkZUJveERlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXktaGFuZGxlJykuc3RvcCgpO2AKICAgKi8KXSkpOwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaW9uaWNUYWJzRGVsZWdhdGUKICogQG1vZHVsZSBpb25pYwogKgogKiBAZGVzY3JpcHRpb24KICogRGVsZWdhdGUgZm9yIGNvbnRyb2xsaW5nIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblRhYnN9IGRpcmVjdGl2ZS4KICoKICogTWV0aG9kcyBjYWxsZWQgZGlyZWN0bHkgb24gdGhlICRpb25pY1RhYnNEZWxlZ2F0ZSBzZXJ2aWNlIHdpbGwgY29udHJvbCBhbGwgaW9uVGFicwogKiBkaXJlY3RpdmVzLiBVc2UgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1RhYnNEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUgJGdldEJ5SGFuZGxlfQogKiBtZXRob2QgdG8gY29udHJvbCBzcGVjaWZpYyBpb25UYWJzIGluc3RhbmNlcy4KICoKICogQHVzYWdlCiAqCiAqIGBgYGh0bWwKICogPGJvZHkgbmctY29udHJvbGxlcj0iTXlDdHJsIj4KICogICA8aW9uLXRhYnM+CiAqCiAqICAgICA8aW9uLXRhYiB0aXRsZT0iVGFiIDEiPgogKiAgICAgICBIZWxsbyB0YWIgMSEKICogICAgICAgPGJ1dHRvbiBuZy1jbGljaz0ic2VsZWN0VGFiV2l0aEluZGV4KDEpIj5TZWxlY3QgdGFiIDIhPC9idXR0b24+CiAqICAgICA8L2lvbi10YWI+CiAqICAgICA8aW9uLXRhYiB0aXRsZT0iVGFiIDIiPkhlbGxvIHRhYiAyITwvaW9uLXRhYj4KICoKICogICA8L2lvbi10YWJzPgogKiA8L2JvZHk+CiAqIGBgYAogKiBgYGBqcwogKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlLCAkaW9uaWNUYWJzRGVsZWdhdGUpIHsKICogICAkc2NvcGUuc2VsZWN0VGFiV2l0aEluZGV4ID0gZnVuY3Rpb24oaW5kZXgpIHsKICogICAgICRpb25pY1RhYnNEZWxlZ2F0ZS5zZWxlY3QoaW5kZXgpOwogKiAgIH0KICogfQogKiBgYGAKICovCklvbmljTW9kdWxlCi5zZXJ2aWNlKCckaW9uaWNUYWJzRGVsZWdhdGUnLCBkZWxlZ2F0ZVNlcnZpY2UoWwogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW9uaWNUYWJzRGVsZWdhdGUjc2VsZWN0CiAgICogQGRlc2NyaXB0aW9uIFNlbGVjdCB0aGUgdGFiIG1hdGNoaW5nIHRoZSBnaXZlbiBpbmRleC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBJbmRleCBvZiB0aGUgdGFiIHRvIHNlbGVjdC4KICAgKi8KICAnc2VsZWN0JywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljVGFic0RlbGVnYXRlI3NlbGVjdGVkSW5kZXgKICAgKiBAcmV0dXJucyBgbnVtYmVyYCBUaGUgaW5kZXggb2YgdGhlIHNlbGVjdGVkIHRhYiwgb3IgLTEuCiAgICovCiAgJ3NlbGVjdGVkSW5kZXgnCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY1RhYnNEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUKICAgKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlCiAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uVGFic30gZGlyZWN0aXZlcyB3aXRoIGBkZWxlZ2F0ZS1oYW5kbGVgIG1hdGNoaW5nCiAgICogdGhlIGdpdmVuIGhhbmRsZS4KICAgKgogICAqIEV4YW1wbGU6IGAkaW9uaWNUYWJzRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteS1oYW5kbGUnKS5zZWxlY3QoMCk7YAogICAqLwpdKSk7CgoKLy8gY2xvc3VyZSB0byBrZWVwIHRoaW5ncyBuZWF0CihmdW5jdGlvbigpIHsKICB2YXIgdGVtcGxhdGVzVG9DYWNoZSA9IFtdOwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpb25pY1RlbXBsYXRlQ2FjaGUKICogQG1vZHVsZSBpb25pYwogKiBAZGVzY3JpcHRpb24gQSBzZXJ2aWNlIHRoYXQgcHJlZW1wdGl2ZWx5IGNhY2hlcyB0ZW1wbGF0ZSBmaWxlcyB0byBlbGltaW5hdGUgdHJhbnNpdGlvbiBmbGlja2VyIGFuZCBib29zdCBwZXJmb3JtYW5jZS4KICogQHVzYWdlCiAqIFN0YXRlIHRlbXBsYXRlcyBhcmUgY2FjaGVkIGF1dG9tYXRpY2FsbHksIGJ1dCB5b3UgY2FuIG9wdGlvbmFsbHkgY2FjaGUgb3RoZXIgdGVtcGxhdGVzLgogKgogKiBgYGBqcwogKiAkaW9uaWNUZW1wbGF0ZUNhY2hlKCdteU5nSW5jbHVkZVRlbXBsYXRlLmh0bWwnKTsKICogYGBgCiAqCiAqIE9wdGlvbmFsbHkgZGlzYWJsZSBhbGwgcHJlZW1wdGl2ZSBjYWNoaW5nIHdpdGggdGhlIGAkaW9uaWNDb25maWdQcm92aWRlcmAgb3IgaW5kaXZpZHVhbCBzdGF0ZXMgYnkgc2V0dGluZyBgcHJlZmV0Y2hUZW1wbGF0ZWAKICogaW4gdGhlIGAkc3RhdGVgIGRlZmluaXRpb24KICoKICogYGBganMKICogICBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbJ2lvbmljJ10pCiAqICAgLmNvbmZpZyhmdW5jdGlvbigkc3RhdGVQcm92aWRlciwgJGlvbmljQ29uZmlnUHJvdmlkZXIpIHsKICoKICogICAgIC8vIGRpc2FibGUgcHJlZW1wdGl2ZSB0ZW1wbGF0ZSBjYWNoaW5nIGdsb2JhbGx5CiAqICAgICAkaW9uaWNDb25maWdQcm92aWRlci5wcmVmZXRjaFRlbXBsYXRlcyhmYWxzZSk7CiAqCiAqICAgICAvLyBkaXNhYmxlIGluZGl2aWR1YWwgc3RhdGVzCiAqICAgICAkc3RhdGVQcm92aWRlcgogKiAgICAgICAuc3RhdGUoJ3RhYnMnLCB7CiAqICAgICAgICAgdXJsOiAiL3RhYiIsCiAqICAgICAgICAgYWJzdHJhY3Q6IHRydWUsCiAqICAgICAgICAgcHJlZmV0Y2hUZW1wbGF0ZTogZmFsc2UsCiAqICAgICAgICAgdGVtcGxhdGVVcmw6ICJ0YWJzLXRlbXBsYXRlcy90YWJzLmh0bWwiCiAqICAgICAgIH0pCiAqICAgICAgIC5zdGF0ZSgndGFicy5ob21lJywgewogKiAgICAgICAgIHVybDogIi9ob21lIiwKICogICAgICAgICB2aWV3czogewogKiAgICAgICAgICAgJ2hvbWUtdGFiJzogewogKiAgICAgICAgICAgICBwcmVmZXRjaFRlbXBsYXRlOiBmYWxzZSwKICogICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICJ0YWJzLXRlbXBsYXRlcy9ob21lLmh0bWwiLAogKiAgICAgICAgICAgICBjb250cm9sbGVyOiAnSG9tZVRhYkN0cmwnCiAqICAgICAgICAgICB9CiAqICAgICAgICAgfQogKiAgICAgICB9KTsKICogICB9KTsKICogYGBgCiAqLwpJb25pY01vZHVsZQouZmFjdG9yeSgnJGlvbmljVGVtcGxhdGVDYWNoZScsIFsKJyRodHRwJywKJyR0ZW1wbGF0ZUNhY2hlJywKJyR0aW1lb3V0JywKJyRpb25pY0NvbmZpZycsCmZ1bmN0aW9uKCRodHRwLCAkdGVtcGxhdGVDYWNoZSwgJHRpbWVvdXQsICRpb25pY0NvbmZpZykgewogIHZhciB0b0NhY2hlID0gdGVtcGxhdGVzVG9DYWNoZSwKICAgICAgaGFzUnVuID0gZmFsc2U7CgogIGZ1bmN0aW9uICRpb25pY1RlbXBsYXRlQ2FjaGUodGVtcGxhdGVzKXsKICAgIGlmKHRvQ2FjaGUubGVuZ3RoID4gNTAwKSByZXR1cm4gZmFsc2U7CiAgICBpZih0eXBlb2YgdGVtcGxhdGVzID09PSAndW5kZWZpbmVkJylyZXR1cm4gcnVuKCk7CiAgICBpZihpc1N0cmluZyh0ZW1wbGF0ZXMpKXRlbXBsYXRlcyA9IFt0ZW1wbGF0ZXNdOwogICAgZm9yRWFjaCh0ZW1wbGF0ZXMsIGZ1bmN0aW9uKHRlbXBsYXRlKXsKICAgICAgdG9DYWNoZS5wdXNoKHRlbXBsYXRlKTsKICAgIH0pOwogICAgLy8gaXMgdGhpcyBpcyBiZWluZyBjYWxsZWQgYWZ0ZXIgdGhlIGluaXRpYWwgSW9uaWNNb2R1bGUucnVuKCkKICAgIGlmKGhhc1J1bikgcnVuKCk7CiAgfQoKICAvLyBydW4gdGhyb3VnaCBtZXRob2RzIC0gaW50ZXJuYWwgbWV0aG9kCiAgdmFyIHJ1biA9IGZ1bmN0aW9uKCl7CiAgICBpZigkaW9uaWNDb25maWcucHJlZmV0Y2hUZW1wbGF0ZXMgPT09IGZhbHNlKXJldHVybjsKICAgIC8vY29uc29sZS5sb2coJ3ByZWZldGNoaW5nJywgdG9DYWNoZSk7CiAgICAvL2ZvciB0ZXN0aW5nCiAgICAkaW9uaWNUZW1wbGF0ZUNhY2hlLl9ydW5Db3VudCsrOwoKICAgIGhhc1J1biA9IHRydWU7CiAgICAvLyBpZ25vcmUgaWYgcmFjZSBjb25kaXRpb24gYWxyZWFkeSB6ZXJvZWQgb3V0IGFycmF5CiAgICBpZih0b0NhY2hlLmxlbmd0aCA9PT0gMClyZXR1cm47CiAgICAvL2NvbnNvbGUubG9nKHRvQ2FjaGUpOwogICAgdmFyIGkgPSAwOwogICAgd2hpbGUgKCBpIDwgNSAmJiAodGVtcGxhdGUgPSB0b0NhY2hlLnBvcCgpKSApIHsKICAgICAgLy8gbm90ZSB0aGF0IGlubGluZSB0ZW1wbGF0ZXMgYXJlIGlnbm9yZWQgYnkgdGhpcyByZXF1ZXN0CiAgICAgIGlmIChpc1N0cmluZyh0ZW1wbGF0ZSkpICRodHRwLmdldCh0ZW1wbGF0ZSwgeyBjYWNoZTogJHRlbXBsYXRlQ2FjaGUgfSk7CiAgICAgIGkrKzsKICAgIH0KICAgIC8vIG9ubHkgcHJlbG9hZCA1IHRlbXBsYXRlcyBhIHNlY29uZAogICAgaWYodG9DYWNoZS5sZW5ndGgpJHRpbWVvdXQoZnVuY3Rpb24oKXtydW4oKTt9LCAxMDAwKTsKICB9OwoKICAvLyBleHBvc2luZyBmb3IgdGVzdGluZwogICRpb25pY1RlbXBsYXRlQ2FjaGUuX3J1bkNvdW50ID0gMDsKICAvLyBkZWZhdWx0IG1ldGhvZAogIHJldHVybiAkaW9uaWNUZW1wbGF0ZUNhY2hlOwp9XSkKCi8vIEludGVyY2VwdHMgdGhlICRzdGF0ZXByb3ZpZGVyLnN0YXRlKCkgY29tbWFuZCB0byBsb29rIGZvciB0ZW1wbGF0ZVVybHMgdGhhdCBjYW4gYmUgY2FjaGVkCi5jb25maWcoWwonJHN0YXRlUHJvdmlkZXInLAonJGlvbmljQ29uZmlnUHJvdmlkZXInLApmdW5jdGlvbigkc3RhdGVQcm92aWRlciwgJGlvbmljQ29uZmlnUHJvdmlkZXIpIHsKICB2YXIgc3RhdGVQcm92aWRlclN0YXRlID0gJHN0YXRlUHJvdmlkZXIuc3RhdGU7CiAgJHN0YXRlUHJvdmlkZXIuc3RhdGUgPSBmdW5jdGlvbihzdGF0ZU5hbWUsIGRlZmluaXRpb24pIHsKICAgIC8vIGRvbid0IGV2ZW4gYm90aGVyIGlmIGl0J3MgZGlzYWJsZWQuIG5vdGUsIGFub3RoZXIgY29uZmlnIG1heSBydW4gYWZ0ZXIgdGhpcywgc28gaXQncyBub3QgYSBjYXRjaC1hbGwKICAgIGlmKCRpb25pY0NvbmZpZ1Byb3ZpZGVyLnByZWZldGNoVGVtcGxhdGVzKCkgIT09IGZhbHNlKXsKICAgICAgdmFyIGVuYWJsZWQgPSBkZWZpbml0aW9uLnByZWZldGNoVGVtcGxhdGUgIT09IGZhbHNlOwogICAgICBpZihlbmFibGVkICYmIGlzU3RyaW5nKGRlZmluaXRpb24udGVtcGxhdGVVcmwpKXRlbXBsYXRlc1RvQ2FjaGUucHVzaChkZWZpbml0aW9uLnRlbXBsYXRlVXJsKTsKICAgICAgaWYoYW5ndWxhci5pc09iamVjdChkZWZpbml0aW9uLnZpZXdzKSl7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGRlZmluaXRpb24udmlld3MpewogICAgICAgICAgZW5hYmxlZCA9IGRlZmluaXRpb24udmlld3Nba2V5XS5wcmVmZXRjaFRlbXBsYXRlICE9PSBmYWxzZTsKICAgICAgICAgIGlmKGVuYWJsZWQgJiYgaXNTdHJpbmcoZGVmaW5pdGlvbi52aWV3c1trZXldLnRlbXBsYXRlVXJsKSkgdGVtcGxhdGVzVG9DYWNoZS5wdXNoKGRlZmluaXRpb24udmlld3Nba2V5XS50ZW1wbGF0ZVVybCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gc3RhdGVQcm92aWRlclN0YXRlLmNhbGwoJHN0YXRlUHJvdmlkZXIsIHN0YXRlTmFtZSwgZGVmaW5pdGlvbik7CiAgfTsKfV0pCgovLyBwcm9jZXNzIHRoZSB0ZW1wbGF0ZVVybHMgY29sbGVjdGVkIGJ5IHRoZSAkc3RhdGVQcm92aWRlciwgYWRkaW5nIHRoZW0gdG8gdGhlIGNhY2hlCi5ydW4oWwonJGlvbmljVGVtcGxhdGVDYWNoZScsCmZ1bmN0aW9uKCRpb25pY1RlbXBsYXRlQ2FjaGUpIHsKICAkaW9uaWNUZW1wbGF0ZUNhY2hlKCk7Cn1dKTsKCn0pKCk7CgpJb25pY01vZHVsZQouZmFjdG9yeSgnJGlvbmljVGVtcGxhdGVMb2FkZXInLCBbCiAgJyRjb21waWxlJywKICAnJGNvbnRyb2xsZXInLAogICckaHR0cCcsCiAgJyRxJywKICAnJHJvb3RTY29wZScsCiAgJyR0ZW1wbGF0ZUNhY2hlJywKZnVuY3Rpb24oJGNvbXBpbGUsICRjb250cm9sbGVyLCAkaHR0cCwgJHEsICRyb290U2NvcGUsICR0ZW1wbGF0ZUNhY2hlKSB7CgogIHJldHVybiB7CiAgICBsb2FkOiBmZXRjaFRlbXBsYXRlLAogICAgY29tcGlsZTogbG9hZEFuZENvbXBpbGUKICB9OwoKICBmdW5jdGlvbiBmZXRjaFRlbXBsYXRlKHVybCkgewogICAgcmV0dXJuICRodHRwLmdldCh1cmwsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KQogICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEgJiYgcmVzcG9uc2UuZGF0YS50cmltKCk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGxvYWRBbmRDb21waWxlKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICB0ZW1wbGF0ZTogJycsCiAgICAgIHRlbXBsYXRlVXJsOiAnJywKICAgICAgc2NvcGU6IG51bGwsCiAgICAgIGNvbnRyb2xsZXI6IG51bGwsCiAgICAgIGxvY2Fsczoge30sCiAgICAgIGFwcGVuZFRvOiBudWxsCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgdGVtcGxhdGVQcm9taXNlID0gb3B0aW9ucy50ZW1wbGF0ZVVybCA/CiAgICAgIHRoaXMubG9hZChvcHRpb25zLnRlbXBsYXRlVXJsKSA6CiAgICAgICRxLndoZW4ob3B0aW9ucy50ZW1wbGF0ZSk7CgogICAgcmV0dXJuIHRlbXBsYXRlUHJvbWlzZS50aGVuKGZ1bmN0aW9uKHRlbXBsYXRlKSB7CiAgICAgIHZhciBjb250cm9sbGVyOwogICAgICB2YXIgc2NvcGUgPSBvcHRpb25zLnNjb3BlIHx8ICRyb290U2NvcGUuJG5ldygpOwoKICAgICAgLy9JbmNhc2UgdGVtcGxhdGUgZG9lc24ndCBoYXZlIGp1c3Qgb25lIHJvb3QgZWxlbWVudCwgZG8gdGhpcwogICAgICB2YXIgZWxlbWVudCA9IGpxTGl0ZSgnPGRpdj4nKS5odG1sKHRlbXBsYXRlKS5jb250ZW50cygpOwoKICAgICAgaWYgKG9wdGlvbnMuY29udHJvbGxlcikgewogICAgICAgIGNvbnRyb2xsZXIgPSAkY29udHJvbGxlcigKICAgICAgICAgIG9wdGlvbnMuY29udHJvbGxlciwKICAgICAgICAgIGV4dGVuZChvcHRpb25zLmxvY2FscywgewogICAgICAgICAgICAkc2NvcGU6IHNjb3BlCiAgICAgICAgICB9KQogICAgICAgICk7CiAgICAgICAgZWxlbWVudC5jaGlsZHJlbigpLmRhdGEoJyRuZ0NvbnRyb2xsZXJDb250cm9sbGVyJywgY29udHJvbGxlcik7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMuYXBwZW5kVG8pIHsKICAgICAgICBqcUxpdGUob3B0aW9ucy5hcHBlbmRUbykuYXBwZW5kKGVsZW1lbnQpOwogICAgICB9CgogICAgICAkY29tcGlsZShlbGVtZW50KShzY29wZSk7CgogICAgICByZXR1cm4gewogICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgc2NvcGU6IHNjb3BlCiAgICAgIH07CiAgICB9KTsKICB9Cgp9XSk7CgovKioKICogQHByaXZhdGUKICogVE9ETyBkb2N1bWVudAogKi8KSW9uaWNNb2R1bGUKLnJ1bihbCiAgJyRyb290U2NvcGUnLAogICckc3RhdGUnLAogICckbG9jYXRpb24nLAogICckZG9jdW1lbnQnLAogICckYW5pbWF0ZScsCiAgJyRpb25pY1BsYXRmb3JtJywKICAnJGlvbmljVmlld1NlcnZpY2UnLApmdW5jdGlvbigkcm9vdFNjb3BlLCAkc3RhdGUsICRsb2NhdGlvbiwgJGRvY3VtZW50LCAkYW5pbWF0ZSwgJGlvbmljUGxhdGZvcm0sICRpb25pY1ZpZXdTZXJ2aWNlKSB7CgogIC8vIGluaXQgdGhlIHZhcmlhYmxlcyB0aGF0IGtlZXAgdHJhY2sgb2YgdGhlIHZpZXcgaGlzdG9yeQogICRyb290U2NvcGUuJHZpZXdIaXN0b3J5ID0gewogICAgaGlzdG9yaWVzOiB7IHJvb3Q6IHsgaGlzdG9yeUlkOiAncm9vdCcsIHBhcmVudEhpc3RvcnlJZDogbnVsbCwgc3RhY2s6IFtdLCBjdXJzb3I6IC0xIH0gfSwKICAgIHZpZXdzOiB7fSwKICAgIGJhY2tWaWV3OiBudWxsLAogICAgZm9yd2FyZFZpZXc6IG51bGwsCiAgICBjdXJyZW50VmlldzogbnVsbCwKICAgIGRpc2FibGVkUmVnaXN0cmFibGVUYWdOYW1lczogW10KICB9OwoKICAvLyBzZXQgdGhhdCB0aGVzZSBkaXJlY3RpdmVzIHNob3VsZCBub3QgYW5pbWF0ZSB3aGVuIHRyYW5zaXRpb25pbmcKICAvLyB0byBpdC4gSW5zdGVhZCwgdGhlIGNoaWxkcmVuIDx0YWI+IGRpcmVjdGl2ZXMgd291bGQgYW5pbWF0ZQogIGlmICgkaW9uaWNWaWV3U2VydmljZS5kaXNhYmxlUmVnaXN0ZXJCeVRhZ05hbWUpIHsKICAgICRpb25pY1ZpZXdTZXJ2aWNlLmRpc2FibGVSZWdpc3RlckJ5VGFnTmFtZSgnaW9uLXRhYnMnKTsKICAgICRpb25pY1ZpZXdTZXJ2aWNlLmRpc2FibGVSZWdpc3RlckJ5VGFnTmFtZSgnaW9uLXNpZGUtbWVudXMnKTsKICB9CgogICRyb290U2NvcGUuJG9uKCd2aWV3U3RhdGUuY2hhbmdlSGlzdG9yeScsIGZ1bmN0aW9uKGUsIGRhdGEpIHsKICAgIGlmKCFkYXRhKSByZXR1cm47CgogICAgdmFyIGhpc3QgPSAoZGF0YS5oaXN0b3J5SWQgPyAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXNbIGRhdGEuaGlzdG9yeUlkIF0gOiBudWxsICk7CiAgICBpZihoaXN0ICYmIGhpc3QuY3Vyc29yID4gLTEgJiYgaGlzdC5jdXJzb3IgPCBoaXN0LnN0YWNrLmxlbmd0aCkgewogICAgICAvLyB0aGUgaGlzdG9yeSB0aGV5J3JlIGdvaW5nIHRvIGFscmVhZHkgZXhpc3RzCiAgICAgIC8vIGdvIHRvIGl0J3MgbGFzdCB2aWV3IGluIGl0cyBzdGFjawogICAgICB2YXIgdmlldyA9IGhpc3Quc3RhY2tbIGhpc3QuY3Vyc29yIF07CiAgICAgIHJldHVybiB2aWV3LmdvKGRhdGEpOwogICAgfQoKICAgIC8vIHRoaXMgaGlzdG9yeSBkb2VzIG5vdCBoYXZlIGEgVVJMLCBidXQgaXQgZG9lcyBoYXZlIGEgdWlTcmVmCiAgICAvLyBmaWd1cmUgb3V0IGl0cyBVUkwgZnJvbSB0aGUgdWlTcmVmCiAgICBpZighZGF0YS51cmwgJiYgZGF0YS51aVNyZWYpIHsKICAgICAgZGF0YS51cmwgPSAkc3RhdGUuaHJlZihkYXRhLnVpU3JlZik7CiAgICB9CgogICAgaWYoZGF0YS51cmwpIHsKICAgICAgLy8gZG9uJ3QgbGV0IGl0IHN0YXJ0IHdpdGggYSAjLCBtZXNzZXMgd2l0aCAkbG9jYXRpb24udXJsKCkKICAgICAgaWYoZGF0YS51cmwuaW5kZXhPZignIycpID09PSAwKSB7CiAgICAgICAgZGF0YS51cmwgPSBkYXRhLnVybC5yZXBsYWNlKCcjJywgJycpOwogICAgICB9CiAgICAgIGlmKGRhdGEudXJsICE9PSAkbG9jYXRpb24udXJsKCkpIHsKICAgICAgICAvLyB3ZSd2ZSBnb3QgYSBnb29kIFVSTCwgcmVhZHkgR08hCiAgICAgICAgJGxvY2F0aW9uLnVybChkYXRhLnVybCk7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLy8gU2V0IHRoZSBkb2N1bWVudCB0aXRsZSB3aGVuIGEgbmV3IHZpZXcgaXMgc2hvd24KICAkcm9vdFNjb3BlLiRvbigndmlld1N0YXRlLnZpZXdFbnRlcicsIGZ1bmN0aW9uKGUsIGRhdGEpIHsKICAgIGlmKGRhdGEgJiYgZGF0YS50aXRsZSkgewogICAgICAkZG9jdW1lbnRbMF0udGl0bGUgPSBkYXRhLnRpdGxlOwogICAgfQogIH0pOwoKICAvLyBUcmlnZ2VyZWQgd2hlbiBkZXZpY2VzIHdpdGggYSBoYXJkd2FyZSBiYWNrIGJ1dHRvbiAoQW5kcm9pZCkgaXMgY2xpY2tlZCBieSB0aGUgdXNlcgogIC8vIFRoaXMgaXMgYSBDb3Jkb3ZhL1Bob25lZ2FwIHBsYXRmb3JtIHNwZWNpZmMgbWV0aG9kCiAgZnVuY3Rpb24gb25IYXJkd2FyZUJhY2tCdXR0b24oZSkgewogICAgaWYoJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuYmFja1ZpZXcpIHsKICAgICAgLy8gdGhlcmUgaXMgYSBiYWNrIHZpZXcsIGdvIHRvIGl0CiAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmJhY2tWaWV3LmdvKCk7CiAgICB9IGVsc2UgewogICAgICAvLyB0aGVyZSBpcyBubyBiYWNrIHZpZXcsIHNvIGNsb3NlIHRoZSBhcHAgaW5zdGVhZAogICAgICBpb25pYy5QbGF0Zm9ybS5leGl0QXBwKCk7CiAgICB9CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogICRpb25pY1BsYXRmb3JtLnJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbigKICAgIG9uSGFyZHdhcmVCYWNrQnV0dG9uLAogICAgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfVklFVwogICk7Cgp9XSkKCi5mYWN0b3J5KCckaW9uaWNWaWV3U2VydmljZScsIFsKICAnJHJvb3RTY29wZScsCiAgJyRzdGF0ZScsCiAgJyRsb2NhdGlvbicsCiAgJyR3aW5kb3cnLAogICckaW5qZWN0b3InLAogICckYW5pbWF0ZScsCiAgJyRpb25pY05hdlZpZXdDb25maWcnLAogICckaW9uaWNDbGlja0Jsb2NrJywKZnVuY3Rpb24oJHJvb3RTY29wZSwgJHN0YXRlLCAkbG9jYXRpb24sICR3aW5kb3csICRpbmplY3RvciwgJGFuaW1hdGUsICRpb25pY05hdlZpZXdDb25maWcsICRpb25pY0NsaWNrQmxvY2spIHsKCiAgdmFyIFZpZXcgPSBmdW5jdGlvbigpe307CiAgVmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIGlmKGRhdGEpIHsKICAgICAgZm9yKHZhciBuYW1lIGluIGRhdGEpIHRoaXNbbmFtZV0gPSBkYXRhW25hbWVdOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH07CiAgVmlldy5wcm90b3R5cGUuZ28gPSBmdW5jdGlvbigpIHsKCiAgICBpZih0aGlzLnN0YXRlTmFtZSkgewogICAgICByZXR1cm4gJHN0YXRlLmdvKHRoaXMuc3RhdGVOYW1lLCB0aGlzLnN0YXRlUGFyYW1zKTsKICAgIH0KCiAgICBpZih0aGlzLnVybCAmJiB0aGlzLnVybCAhPT0gJGxvY2F0aW9uLnVybCgpKSB7CgogICAgICBpZigkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5iYWNrVmlldyA9PT0gdGhpcykgewogICAgICAgIHJldHVybiAkd2luZG93Lmhpc3RvcnkuZ28oLTEpOwogICAgICB9IGVsc2UgaWYoJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuZm9yd2FyZFZpZXcgPT09IHRoaXMpIHsKICAgICAgICByZXR1cm4gJHdpbmRvdy5oaXN0b3J5LmdvKDEpOwogICAgICB9CgogICAgICAkbG9jYXRpb24udXJsKHRoaXMudXJsKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CiAgVmlldy5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgaWYodGhpcy5zY29wZSkgewogICAgICB0aGlzLnNjb3BlLiRkZXN0cm95ICYmIHRoaXMuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgdGhpcy5zY29wZSA9IG51bGw7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gY3JlYXRlVmlld0lkKHN0YXRlSWQpIHsKICAgIHJldHVybiBpb25pYy5VdGlscy5uZXh0VWlkKCk7CiAgfQoKICByZXR1cm4gewoKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihjb250YWluZXJTY29wZSwgZWxlbWVudCkgewoKICAgICAgdmFyIHZpZXdIaXN0b3J5ID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnksCiAgICAgICAgICBjdXJyZW50U3RhdGVJZCA9IHRoaXMuZ2V0Q3VycmVudFN0YXRlSWQoKSwKICAgICAgICAgIGhpc3QgPSB0aGlzLl9nZXRIaXN0b3J5KGNvbnRhaW5lclNjb3BlKSwKICAgICAgICAgIGN1cnJlbnRWaWV3ID0gdmlld0hpc3RvcnkuY3VycmVudFZpZXcsCiAgICAgICAgICBiYWNrVmlldyA9IHZpZXdIaXN0b3J5LmJhY2tWaWV3LAogICAgICAgICAgZm9yd2FyZFZpZXcgPSB2aWV3SGlzdG9yeS5mb3J3YXJkVmlldywKICAgICAgICAgIG5leHRWaWV3T3B0aW9ucyA9IHRoaXMubmV4dFZpZXdPcHRpb25zKCksCiAgICAgICAgICByc3AgPSB7CiAgICAgICAgICAgIHZpZXdJZDogbnVsbCwKICAgICAgICAgICAgbmF2QWN0aW9uOiBudWxsLAogICAgICAgICAgICBuYXZEaXJlY3Rpb246IG51bGwsCiAgICAgICAgICAgIGhpc3RvcnlJZDogaGlzdC5oaXN0b3J5SWQKICAgICAgICAgIH07CgogICAgICBpZihlbGVtZW50ICYmICF0aGlzLmlzVGFnTmFtZVJlZ2lzdHJhYmxlKGVsZW1lbnQpKSB7CiAgICAgICAgLy8gZmlyc3QgY2hlY2sgdG8gc2VlIGlmIHRoaXMgZWxlbWVudCBjYW4gZXZlbiBiZSByZWdpc3RlcmVkIGFzIGEgdmlldy4KICAgICAgICAvLyBDZXJ0YWluIHRhZ3MgYXJlIG9ubHkgY29udGFpbmVycyBmb3Igdmlld3MsIGJ1dCBhcmUgbm90IHZpZXdzIHRoZW1zZWx2ZXMuCiAgICAgICAgLy8gRm9yIGV4YW1wbGUsIHRoZSA8aW9uLXRhYnM+IGRpcmVjdGl2ZSBjb250YWlucyBhIDxpb24tdGFiPiBhbmQgdGhlIDxpb24tdGFiPiBpcyB0aGUKICAgICAgICAvLyB2aWV3LCBidXQgdGhlIDxpb24tdGFicz4gZGlyZWN0aXZlIGl0c2VsZiBzaG91bGQgbm90IGJlIHJlZ2lzdGVyZWQgYXMgYSB2aWV3LgogICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnZGlzYWJsZWRCeVRhZ05hbWUnOwogICAgICAgIHJldHVybiByc3A7CiAgICAgIH0KCiAgICAgIGlmKGN1cnJlbnRWaWV3ICYmCiAgICAgICAgIGN1cnJlbnRWaWV3LnN0YXRlSWQgPT09IGN1cnJlbnRTdGF0ZUlkICYmCiAgICAgICAgIGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCA9PT0gaGlzdC5oaXN0b3J5SWQpIHsKICAgICAgICAvLyBkbyBub3RoaW5nIGlmIGl0cyB0aGUgc2FtZSBzdGF0ZUlkIGluIHRoZSBzYW1lIGhpc3RvcnkKICAgICAgICByc3AubmF2QWN0aW9uID0gJ25vQ2hhbmdlJzsKICAgICAgICByZXR1cm4gcnNwOwogICAgICB9CgogICAgICBpZih2aWV3SGlzdG9yeS5mb3JjZWROYXYpIHsKICAgICAgICAvLyB3ZSd2ZSBwcmV2aW91c2x5IHNldCBleGFjdGx5IHdoYXQgdG8gZG8KICAgICAgICBpb25pYy5VdGlscy5leHRlbmQocnNwLCB2aWV3SGlzdG9yeS5mb3JjZWROYXYpOwogICAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmZvcmNlZE5hdiA9IG51bGw7CgogICAgICB9IGVsc2UgaWYoYmFja1ZpZXcgJiYgYmFja1ZpZXcuc3RhdGVJZCA9PT0gY3VycmVudFN0YXRlSWQpIHsKICAgICAgICAvLyB0aGV5IHdlbnQgYmFjayBvbmUsIHNldCB0aGUgb2xkIGN1cnJlbnQgdmlldyBhcyBhIGZvcndhcmQgdmlldwogICAgICAgIHJzcC52aWV3SWQgPSBiYWNrVmlldy52aWV3SWQ7CiAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdtb3ZlQmFjayc7CiAgICAgICAgcnNwLnZpZXdJZCA9IGJhY2tWaWV3LnZpZXdJZDsKICAgICAgICBpZihiYWNrVmlldy5oaXN0b3J5SWQgPT09IGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCkgewogICAgICAgICAgLy8gd2VudCBiYWNrIGluIHRoZSBzYW1lIGhpc3RvcnkKICAgICAgICAgIHJzcC5uYXZEaXJlY3Rpb24gPSAnYmFjayc7CiAgICAgICAgfQoKICAgICAgfSBlbHNlIGlmKGZvcndhcmRWaWV3ICYmIGZvcndhcmRWaWV3LnN0YXRlSWQgPT09IGN1cnJlbnRTdGF0ZUlkKSB7CiAgICAgICAgLy8gdGhleSB3ZW50IHRvIHRoZSBmb3J3YXJkIG9uZSwgc2V0IHRoZSBmb3J3YXJkIHZpZXcgdG8gbm8gbG9uZ2VyIGEgZm9yd2FyZCB2aWV3CiAgICAgICAgcnNwLnZpZXdJZCA9IGZvcndhcmRWaWV3LnZpZXdJZDsKICAgICAgICByc3AubmF2QWN0aW9uID0gJ21vdmVGb3J3YXJkJzsKICAgICAgICBpZihmb3J3YXJkVmlldy5oaXN0b3J5SWQgPT09IGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCkgewogICAgICAgICAgcnNwLm5hdkRpcmVjdGlvbiA9ICdmb3J3YXJkJzsKICAgICAgICB9CgogICAgICAgIHZhciBwYXJlbnRIaXN0b3J5ID0gdGhpcy5fZ2V0UGFyZW50SGlzdG9yeU9iaihjb250YWluZXJTY29wZSk7CiAgICAgICAgaWYoZm9yd2FyZFZpZXcuaGlzdG9yeUlkICYmIHBhcmVudEhpc3Rvcnkuc2NvcGUpIHsKICAgICAgICAgIC8vIGlmIGEgaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIGNyZWF0ZWQgYnkgdGhlIGZvcndhcmQgdmlldyB0aGVuIG1ha2Ugc3VyZSBpdCBzdGF5cyB0aGUgc2FtZQogICAgICAgICAgcGFyZW50SGlzdG9yeS5zY29wZS4kaGlzdG9yeUlkID0gZm9yd2FyZFZpZXcuaGlzdG9yeUlkOwogICAgICAgICAgcnNwLmhpc3RvcnlJZCA9IGZvcndhcmRWaWV3Lmhpc3RvcnlJZDsKICAgICAgICB9CgogICAgICB9IGVsc2UgaWYoY3VycmVudFZpZXcgJiYgY3VycmVudFZpZXcuaGlzdG9yeUlkICE9PSBoaXN0Lmhpc3RvcnlJZCAmJgogICAgICAgICAgICAgICAgaGlzdC5jdXJzb3IgPiAtMSAmJiBoaXN0LnN0YWNrLmxlbmd0aCA+IDAgJiYgaGlzdC5jdXJzb3IgPCBoaXN0LnN0YWNrLmxlbmd0aCAmJgogICAgICAgICAgICAgICAgaGlzdC5zdGFja1toaXN0LmN1cnNvcl0uc3RhdGVJZCA9PT0gY3VycmVudFN0YXRlSWQpIHsKICAgICAgICAvLyB0aGV5IGp1c3QgY2hhbmdlZCB0byBhIGRpZmZlcmVudCBoaXN0b3J5IGFuZCB0aGUgaGlzdG9yeSBhbHJlYWR5IGhhcyB2aWV3cyBpbiBpdAogICAgICAgIHJzcC52aWV3SWQgPSBoaXN0LnN0YWNrW2hpc3QuY3Vyc29yXS52aWV3SWQ7CiAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdtb3ZlQmFjayc7CgogICAgICB9IGVsc2UgewoKICAgICAgICAvLyBzZXQgYSBuZXcgdW5pcXVlIHZpZXdJZAogICAgICAgIHJzcC52aWV3SWQgPSBjcmVhdGVWaWV3SWQoY3VycmVudFN0YXRlSWQpOwoKICAgICAgICBpZihjdXJyZW50VmlldykgewogICAgICAgICAgLy8gc2V0IHRoZSBmb3J3YXJkIHZpZXcgaWYgdGhlcmUgaXMgYSBjdXJyZW50IHZpZXcgKGllOiBpZiBpdHMgbm90IHRoZSBmaXJzdCB2aWV3KQogICAgICAgICAgY3VycmVudFZpZXcuZm9yd2FyZFZpZXdJZCA9IHJzcC52aWV3SWQ7CgogICAgICAgICAgLy8gaXRzIG9ubHkgbW92aW5nIGZvcndhcmQgaWYgaXRzIGluIHRoZSBzYW1lIGhpc3RvcnkKICAgICAgICAgIGlmKGhpc3QuaGlzdG9yeUlkID09PSBjdXJyZW50Vmlldy5oaXN0b3J5SWQpIHsKICAgICAgICAgICAgcnNwLm5hdkRpcmVjdGlvbiA9ICdmb3J3YXJkJzsKICAgICAgICAgIH0KICAgICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnbmV3Vmlldyc7CgogICAgICAgICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYSBuZXcgZm9yd2FyZCB2aWV3CiAgICAgICAgICBpZihmb3J3YXJkVmlldyAmJiBjdXJyZW50Vmlldy5zdGF0ZUlkICE9PSBmb3J3YXJkVmlldy5zdGF0ZUlkKSB7CiAgICAgICAgICAgIC8vIHRoZXkgbmF2aWdhdGVkIHRvIGEgbmV3IHZpZXcgYnV0IHRoZSBzdGFjayBhbHJlYWR5IGhhcyBhIGZvcndhcmQgdmlldwogICAgICAgICAgICAvLyBzaW5jZSBpdHMgYSBuZXcgdmlldyByZW1vdmUgYW55IGZvcndhcmRzIHRoYXQgZXhpc3RlZAogICAgICAgICAgICB2YXIgZm9yd2FyZHNIaXN0b3J5ID0gdGhpcy5fZ2V0SGlzdG9yeUJ5SWQoZm9yd2FyZFZpZXcuaGlzdG9yeUlkKTsKICAgICAgICAgICAgaWYoZm9yd2FyZHNIaXN0b3J5KSB7CiAgICAgICAgICAgICAgLy8gdGhlIGZvcndhcmQgaGFzIGEgaGlzdG9yeQogICAgICAgICAgICAgIGZvcih2YXIgeD1mb3J3YXJkc0hpc3Rvcnkuc3RhY2subGVuZ3RoIC0gMTsgeCA+PSBmb3J3YXJkVmlldy5pbmRleDsgeC0tKSB7CiAgICAgICAgICAgICAgICAvLyBzdGFydGluZyBmcm9tIHRoZSBlbmQgZGVzdHJveSBhbGwgZm9yd2FyZHMgaW4gdGhpcyBoaXN0b3J5IGZyb20gdGhpcyBwb2ludAogICAgICAgICAgICAgICAgZm9yd2FyZHNIaXN0b3J5LnN0YWNrW3hdLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIGZvcndhcmRzSGlzdG9yeS5zdGFjay5zcGxpY2UoeCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyB0aGVyZSdzIG5vIGN1cnJlbnQgdmlldywgc28gdGhpcyBtdXN0IGJlIHRoZSBpbml0aWFsIHZpZXcKICAgICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnaW5pdGlhbFZpZXcnOwogICAgICAgIH0KCiAgICAgICAgLy8gYWRkIHRoZSBuZXcgdmlldwogICAgICAgIHZpZXdIaXN0b3J5LnZpZXdzW3JzcC52aWV3SWRdID0gdGhpcy5jcmVhdGVWaWV3KHsKICAgICAgICAgIHZpZXdJZDogcnNwLnZpZXdJZCwKICAgICAgICAgIGluZGV4OiBoaXN0LnN0YWNrLmxlbmd0aCwKICAgICAgICAgIGhpc3RvcnlJZDogaGlzdC5oaXN0b3J5SWQsCiAgICAgICAgICBiYWNrVmlld0lkOiAoY3VycmVudFZpZXcgJiYgY3VycmVudFZpZXcudmlld0lkID8gY3VycmVudFZpZXcudmlld0lkIDogbnVsbCksCiAgICAgICAgICBmb3J3YXJkVmlld0lkOiBudWxsLAogICAgICAgICAgc3RhdGVJZDogY3VycmVudFN0YXRlSWQsCiAgICAgICAgICBzdGF0ZU5hbWU6IHRoaXMuZ2V0Q3VycmVudFN0YXRlTmFtZSgpLAogICAgICAgICAgc3RhdGVQYXJhbXM6IHRoaXMuZ2V0Q3VycmVudFN0YXRlUGFyYW1zKCksCiAgICAgICAgICB1cmw6ICRsb2NhdGlvbi51cmwoKSwKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHJzcC5uYXZBY3Rpb24gPT0gJ21vdmVCYWNrJykgewogICAgICAgICAgLy9tb3ZlQmFjayhmcm9tLCB0byk7CiAgICAgICAgICAkcm9vdFNjb3BlLiRlbWl0KCckdmlld0hpc3Rvcnkudmlld0JhY2snLCBjdXJyZW50Vmlldy52aWV3SWQsIHJzcC52aWV3SWQpOwogICAgICAgIH0KCiAgICAgICAgLy8gYWRkIHRoZSBuZXcgdmlldyB0byB0aGlzIGhpc3RvcnkncyBzdGFjawogICAgICAgIGhpc3Quc3RhY2sucHVzaCh2aWV3SGlzdG9yeS52aWV3c1tyc3Audmlld0lkXSk7CiAgICAgIH0KCiAgICAgIGlmKG5leHRWaWV3T3B0aW9ucykgewogICAgICAgIGlmKG5leHRWaWV3T3B0aW9ucy5kaXNhYmxlQW5pbWF0ZSkgcnNwLm5hdkRpcmVjdGlvbiA9IG51bGw7CiAgICAgICAgaWYobmV4dFZpZXdPcHRpb25zLmRpc2FibGVCYWNrKSB2aWV3SGlzdG9yeS52aWV3c1tyc3Audmlld0lkXS5iYWNrVmlld0lkID0gbnVsbDsKICAgICAgICB0aGlzLm5leHRWaWV3T3B0aW9ucyhudWxsKTsKICAgICAgfQoKICAgICAgdGhpcy5zZXROYXZWaWV3cyhyc3Audmlld0lkKTsKCiAgICAgIGhpc3QuY3Vyc29yID0gdmlld0hpc3RvcnkuY3VycmVudFZpZXcuaW5kZXg7CgogICAgICByZXR1cm4gcnNwOwogICAgfSwKCiAgICBzZXROYXZWaWV3czogZnVuY3Rpb24odmlld0lkKSB7CiAgICAgIHZhciB2aWV3SGlzdG9yeSA9ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5OwoKICAgICAgdmlld0hpc3RvcnkuY3VycmVudFZpZXcgPSB0aGlzLl9nZXRWaWV3QnlJZCh2aWV3SWQpOwogICAgICB2aWV3SGlzdG9yeS5iYWNrVmlldyA9IHRoaXMuX2dldEJhY2tWaWV3KHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3KTsKICAgICAgdmlld0hpc3RvcnkuZm9yd2FyZFZpZXcgPSB0aGlzLl9nZXRGb3J3YXJkVmlldyh2aWV3SGlzdG9yeS5jdXJyZW50Vmlldyk7CgogICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyR2aWV3SGlzdG9yeS5oaXN0b3J5Q2hhbmdlJywgewogICAgICAgIHNob3dCYWNrOiAodmlld0hpc3RvcnkuYmFja1ZpZXcgJiYgdmlld0hpc3RvcnkuYmFja1ZpZXcuaGlzdG9yeUlkID09PSB2aWV3SGlzdG9yeS5jdXJyZW50Vmlldy5oaXN0b3J5SWQpCiAgICAgIH0pOwogICAgfSwKCiAgICByZWdpc3Rlckhpc3Rvcnk6IGZ1bmN0aW9uKHNjb3BlKSB7CiAgICAgIHNjb3BlLiRoaXN0b3J5SWQgPSBpb25pYy5VdGlscy5uZXh0VWlkKCk7CiAgICB9LAoKICAgIGNyZWF0ZVZpZXc6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgdmFyIG5ld1ZpZXcgPSBuZXcgVmlldygpOwogICAgICByZXR1cm4gbmV3Vmlldy5pbml0aWFsaXplKGRhdGEpOwogICAgfSwKCiAgICBnZXRDdXJyZW50VmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5jdXJyZW50VmlldzsKICAgIH0sCgogICAgZ2V0QmFja1ZpZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuYmFja1ZpZXc7CiAgICB9LAoKICAgIGdldEZvcndhcmRWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmZvcndhcmRWaWV3OwogICAgfSwKCiAgICBnZXROYXZEaXJlY3Rpb246IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkubmF2RGlyZWN0aW9uOwogICAgfSwKCiAgICBnZXRDdXJyZW50U3RhdGVOYW1lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICgkc3RhdGUgJiYgJHN0YXRlLmN1cnJlbnQgPyAkc3RhdGUuY3VycmVudC5uYW1lIDogbnVsbCk7CiAgICB9LAoKICAgIGlzQ3VycmVudFN0YXRlTmF2VmlldzogZnVuY3Rpb24obmF2VmlldykgewogICAgICByZXR1cm4gKCRzdGF0ZSAmJgogICAgICAgICAgICAgICRzdGF0ZS5jdXJyZW50ICYmCiAgICAgICAgICAgICAgJHN0YXRlLmN1cnJlbnQudmlld3MgJiYKICAgICAgICAgICAgICAkc3RhdGUuY3VycmVudC52aWV3c1tuYXZWaWV3XSA/IHRydWUgOiBmYWxzZSk7CiAgICB9LAoKICAgIGdldEN1cnJlbnRTdGF0ZVBhcmFtczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBydG47CiAgICAgIGlmICgkc3RhdGUgJiYgJHN0YXRlLnBhcmFtcykgewogICAgICAgIGZvcih2YXIga2V5IGluICRzdGF0ZS5wYXJhbXMpIHsKICAgICAgICAgIGlmKCRzdGF0ZS5wYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICBydG4gPSBydG4gfHwge307CiAgICAgICAgICAgIHJ0bltrZXldID0gJHN0YXRlLnBhcmFtc1trZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcnRuOwogICAgfSwKCiAgICBnZXRDdXJyZW50U3RhdGVJZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpZDsKICAgICAgaWYoJHN0YXRlICYmICRzdGF0ZS5jdXJyZW50ICYmICRzdGF0ZS5jdXJyZW50Lm5hbWUpIHsKICAgICAgICBpZCA9ICRzdGF0ZS5jdXJyZW50Lm5hbWU7CiAgICAgICAgaWYoJHN0YXRlLnBhcmFtcykgewogICAgICAgICAgZm9yKHZhciBrZXkgaW4gJHN0YXRlLnBhcmFtcykgewogICAgICAgICAgICBpZigkc3RhdGUucGFyYW1zLmhhc093blByb3BlcnR5KGtleSkgJiYgJHN0YXRlLnBhcmFtc1trZXldKSB7CiAgICAgICAgICAgICAgaWQgKz0gIl8iICsga2V5ICsgIj0iICsgJHN0YXRlLnBhcmFtc1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBpZDsKICAgICAgfQogICAgICAvLyBpZiBzb21ldGhpbmcgZ29lcyB3cm9uZyBtYWtlIHN1cmUgaXRzIGdvdCBhIHVuaXF1ZSBzdGF0ZUlkCiAgICAgIHJldHVybiBpb25pYy5VdGlscy5uZXh0VWlkKCk7CiAgICB9LAoKICAgIGdvVG9IaXN0b3J5Um9vdDogZnVuY3Rpb24oaGlzdG9yeUlkKSB7CiAgICAgIGlmKGhpc3RvcnlJZCkgewogICAgICAgIHZhciBoaXN0ID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBoaXN0b3J5SWQgXTsKICAgICAgICBpZihoaXN0ICYmIGhpc3Quc3RhY2subGVuZ3RoKSB7CiAgICAgICAgICBpZigkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5jdXJyZW50VmlldyAmJiAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5jdXJyZW50Vmlldy52aWV3SWQgPT09IGhpc3Quc3RhY2tbMF0udmlld0lkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmZvcmNlZE5hdiA9IHsKICAgICAgICAgICAgdmlld0lkOiBoaXN0LnN0YWNrWzBdLnZpZXdJZCwKICAgICAgICAgICAgbmF2QWN0aW9uOiAnbW92ZUJhY2snLAogICAgICAgICAgICBuYXZEaXJlY3Rpb246ICdiYWNrJwogICAgICAgICAgfTsKICAgICAgICAgIGhpc3Quc3RhY2tbMF0uZ28oKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgX2dldFZpZXdCeUlkOiBmdW5jdGlvbih2aWV3SWQpIHsKICAgICAgcmV0dXJuICh2aWV3SWQgPyAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS52aWV3c1sgdmlld0lkIF0gOiBudWxsICk7CiAgICB9LAoKICAgIF9nZXRCYWNrVmlldzogZnVuY3Rpb24odmlldykgewogICAgICByZXR1cm4gKHZpZXcgPyB0aGlzLl9nZXRWaWV3QnlJZCh2aWV3LmJhY2tWaWV3SWQpIDogbnVsbCApOwogICAgfSwKCiAgICBfZ2V0Rm9yd2FyZFZpZXc6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgcmV0dXJuICh2aWV3ID8gdGhpcy5fZ2V0Vmlld0J5SWQodmlldy5mb3J3YXJkVmlld0lkKSA6IG51bGwgKTsKICAgIH0sCgogICAgX2dldEhpc3RvcnlCeUlkOiBmdW5jdGlvbihoaXN0b3J5SWQpIHsKICAgICAgcmV0dXJuIChoaXN0b3J5SWQgPyAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXNbIGhpc3RvcnlJZCBdIDogbnVsbCApOwogICAgfSwKCiAgICBfZ2V0SGlzdG9yeTogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgdmFyIGhpc3RPYmogPSB0aGlzLl9nZXRQYXJlbnRIaXN0b3J5T2JqKHNjb3BlKTsKCiAgICAgIGlmKCAhJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBoaXN0T2JqLmhpc3RvcnlJZCBdICkgewogICAgICAgIC8vIHRoaXMgaGlzdG9yeSBvYmplY3QgZXhpc3RzIGluIHBhcmVudCBzY29wZSwgYnV0IGRvZXNuJ3QKICAgICAgICAvLyBleGlzdCBpbiB0aGUgaGlzdG9yeSBkYXRhIHlldAogICAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3Rvcmllc1sgaGlzdE9iai5oaXN0b3J5SWQgXSA9IHsKICAgICAgICAgIGhpc3RvcnlJZDogaGlzdE9iai5oaXN0b3J5SWQsCiAgICAgICAgICBwYXJlbnRIaXN0b3J5SWQ6IHRoaXMuX2dldFBhcmVudEhpc3RvcnlPYmooaGlzdE9iai5zY29wZS4kcGFyZW50KS5oaXN0b3J5SWQsCiAgICAgICAgICBzdGFjazogW10sCiAgICAgICAgICBjdXJzb3I6IC0xCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3Rvcmllc1sgaGlzdE9iai5oaXN0b3J5SWQgXTsKICAgIH0sCgogICAgX2dldFBhcmVudEhpc3RvcnlPYmo6IGZ1bmN0aW9uKHNjb3BlKSB7CiAgICAgIHZhciBwYXJlbnRTY29wZSA9IHNjb3BlOwogICAgICB3aGlsZShwYXJlbnRTY29wZSkgewogICAgICAgIGlmKHBhcmVudFNjb3BlLmhhc093blByb3BlcnR5KCckaGlzdG9yeUlkJykpIHsKICAgICAgICAgIC8vIHRoaXMgcGFyZW50IHNjb3BlIGhhcyBhIGhpc3RvcnlJZAogICAgICAgICAgcmV0dXJuIHsgaGlzdG9yeUlkOiBwYXJlbnRTY29wZS4kaGlzdG9yeUlkLCBzY29wZTogcGFyZW50U2NvcGUgfTsKICAgICAgICB9CiAgICAgICAgLy8gbm90aGluZyBmb3VuZCBrZWVwIGNsaW1iaW5nIHVwCiAgICAgICAgcGFyZW50U2NvcGUgPSBwYXJlbnRTY29wZS4kcGFyZW50OwogICAgICB9CiAgICAgIC8vIG5vIGhpc3RvcnkgZm9yIGZvciB0aGUgcGFyZW50LCB1c2UgdGhlIHJvb3QKICAgICAgcmV0dXJuIHsgaGlzdG9yeUlkOiAncm9vdCcsIHNjb3BlOiAkcm9vdFNjb3BlIH07CiAgICB9LAoKICAgIG5leHRWaWV3T3B0aW9uczogZnVuY3Rpb24ob3B0cykgewogICAgICBpZihhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5fbmV4dE9wdHMgPSBvcHRzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLl9uZXh0T3B0czsKICAgICAgfQogICAgfSwKCiAgICBnZXRSZW5kZXJlcjogZnVuY3Rpb24obmF2Vmlld0VsZW1lbnQsIG5hdlZpZXdBdHRycywgbmF2Vmlld1Njb3BlKSB7CiAgICAgIHZhciBzZXJ2aWNlID0gdGhpczsKICAgICAgdmFyIHJlZ2lzdGVyRGF0YTsKICAgICAgdmFyIGRvQW5pbWF0aW9uOwoKICAgICAgLy8gY2xpbWIgdXAgdGhlIERPTSBhbmQgc2VlIHdoaWNoIGFuaW1hdGlvbiBjbGFzc25hbWUgdG8gdXNlLCBpZiBhbnkKICAgICAgdmFyIGFuaW1hdGlvbkNsYXNzID0gZ2V0UGFyZW50QW5pbWF0aW9uQ2xhc3MobmF2Vmlld0VsZW1lbnRbMF0pOwoKICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50QW5pbWF0aW9uQ2xhc3MoZWwpIHsKICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyc7CiAgICAgICAgd2hpbGUoIWNsYXNzTmFtZSAmJiBlbCkgewogICAgICAgICAgY2xhc3NOYW1lID0gZWwuZ2V0QXR0cmlidXRlKCdhbmltYXRpb24nKTsKICAgICAgICAgIGVsID0gZWwucGFyZW50RWxlbWVudDsKICAgICAgICB9CgogICAgICAgIC8vIElmIHRoZXkgZG9uJ3QgaGF2ZSBhbiBhbmltYXRpb24gc2V0IGV4cGxpY2l0bHksIHVzZSB0aGUgdmFsdWUgaW4gdGhlIGNvbmZpZwogICAgICAgIGlmKCFjbGFzc05hbWUpIHsKICAgICAgICAgIHJldHVybiAkaW9uaWNOYXZWaWV3Q29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2xhc3NOYW1lOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzZXRBbmltYXRpb25DbGFzcygpIHsKICAgICAgICAvLyBhZGQgdGhlIGFuaW1hdGlvbiBDU1MgY2xhc3Mgd2UncmUgZ29ubmEgdXNlIHRvIHRyYW5zaXRpb24gYmV0d2VlbiB2aWV3cwogICAgICAgIGlmIChhbmltYXRpb25DbGFzcykgewogICAgICAgICAgbmF2Vmlld0VsZW1lbnRbMF0uY2xhc3NMaXN0LmFkZChhbmltYXRpb25DbGFzcyk7CiAgICAgICAgfQoKICAgICAgICBpZihyZWdpc3RlckRhdGEubmF2RGlyZWN0aW9uID09PSAnYmFjaycpIHsKICAgICAgICAgIC8vIGFuaW1hdGUgbGlrZSB3ZSdyZSBtb3ZpbmcgYmFja3dhcmQKICAgICAgICAgIG5hdlZpZXdFbGVtZW50WzBdLmNsYXNzTGlzdC5hZGQoJ3JldmVyc2UnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gZGVmYXVsdHMgdG8gYW5pbWF0ZSBmb3J3YXJkCiAgICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIHJldmVyc2UgY2xhc3MgaXNuJ3QgYWxyZWFkeSBhZGRlZAogICAgICAgICAgbmF2Vmlld0VsZW1lbnRbMF0uY2xhc3NMaXN0LnJlbW92ZSgncmV2ZXJzZScpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNob3VsZEFuaW1hdGUpIHsKCiAgICAgICAgcmV0dXJuIHsKCiAgICAgICAgICBlbnRlcjogZnVuY3Rpb24oZWxlbWVudCkgewoKICAgICAgICAgICAgaWYoZG9BbmltYXRpb24gJiYgc2hvdWxkQW5pbWF0ZSkgewogICAgICAgICAgICAgIC8vIGVudGVyIHdpdGggYW4gYW5pbWF0aW9uCiAgICAgICAgICAgICAgc2V0QW5pbWF0aW9uQ2xhc3MoKTsKCiAgICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctZW50ZXInKTsKICAgICAgICAgICAgICAkaW9uaWNDbGlja0Jsb2NrLnNob3coKTsKCiAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoZWxlbWVudCwgbmF2Vmlld0VsZW1lbnQsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGlvbmljQ2xpY2tCbG9jay5oaWRlKCk7CiAgICAgICAgICAgICAgICBpZiAoYW5pbWF0aW9uQ2xhc3MpIHsKICAgICAgICAgICAgICAgICAgbmF2Vmlld0VsZW1lbnRbMF0uY2xhc3NMaXN0LnJlbW92ZShhbmltYXRpb25DbGFzcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9IGVsc2UgaWYoIWRvQW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgJGlvbmljQ2xpY2tCbG9jay5oaWRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG5vIGFuaW1hdGlvbgogICAgICAgICAgICBuYXZWaWV3RWxlbWVudC5hcHBlbmQoZWxlbWVudCk7CiAgICAgICAgICB9LAoKICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBuYXZWaWV3RWxlbWVudC5jb250ZW50cygpOwoKICAgICAgICAgICAgaWYoZG9BbmltYXRpb24gJiYgc2hvdWxkQW5pbWF0ZSkgewogICAgICAgICAgICAgIC8vIGxlYXZlIHdpdGggYW4gYW5pbWF0aW9uCiAgICAgICAgICAgICAgc2V0QW5pbWF0aW9uQ2xhc3MoKTsKCiAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbm8gYW5pbWF0aW9uCiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICB9LAoKICAgICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIC8vIHJlZ2lzdGVyIGEgbmV3IHZpZXcKICAgICAgICAgICAgcmVnaXN0ZXJEYXRhID0gc2VydmljZS5yZWdpc3RlcihuYXZWaWV3U2NvcGUsIGVsZW1lbnQpOwogICAgICAgICAgICBkb0FuaW1hdGlvbiA9IChhbmltYXRpb25DbGFzcyAhPT0gbnVsbCAmJiByZWdpc3RlckRhdGEubmF2RGlyZWN0aW9uICE9PSBudWxsKTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyRGF0YTsKICAgICAgICAgIH0KCiAgICAgICAgfTsKICAgICAgfTsKICAgIH0sCgogICAgZGlzYWJsZVJlZ2lzdGVyQnlUYWdOYW1lOiBmdW5jdGlvbih0YWdOYW1lKSB7CiAgICAgIC8vIG5vdCBldmVyeSBlbGVtZW50IHNob3VsZCBhbmltYXRlIGJldHdlZSB0cmFuc2l0aW9ucwogICAgICAvLyBGb3IgZXhhbXBsZSwgdGhlIDxpb24tdGFicz4gZGlyZWN0aXZlIHNob3VsZCBub3QgYW5pbWF0ZSB3aGVuIGl0IGVudGVycywKICAgICAgLy8gYnV0IGluc3RlYWQgdGhlIDxpb24tdGFicz4gZGlyZWN0dmUgd291bGQganVzdCBzaG93LCBhbmQgaXRzIGNoaWxkcmVuCiAgICAgIC8vIDxpb24tdGFiPiBkaXJlY3RpdmVzIHdvdWxkIGRvIHRoZSBhbmltYXRpbmcsIGJ1dCA8aW9uLXRhYnM+IGl0c2VsZiBpcyBub3QgYSB2aWV3CiAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmRpc2FibGVkUmVnaXN0cmFibGVUYWdOYW1lcy5wdXNoKHRhZ05hbWUudG9VcHBlckNhc2UoKSk7CiAgICB9LAoKICAgIGlzVGFnTmFtZVJlZ2lzdHJhYmxlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIC8vIGNoZWNrIGlmIHRoaXMgZWxlbWVudCBoYXMgYSB0YWdOYW1lIChhdCBpdHMgcm9vdCwgbm90IHJlY3Vyc2l2ZWx5KQogICAgICAvLyB0aGF0IHNob3VsZG4ndCBiZSBhbmltYXRlZCwgbGlrZSA8aW9uLXRhYnM+IG9yIDxpb24tc2lkZS1tZW51PgogICAgICB2YXIgeCwgeSwgZGlzYWJsZWRUYWdzID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuZGlzYWJsZWRSZWdpc3RyYWJsZVRhZ05hbWVzOwogICAgICBmb3IoeD0wOyB4PGVsZW1lbnQubGVuZ3RoOyB4KyspIHsKICAgICAgICBpZihlbGVtZW50W3hdLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKICAgICAgICBmb3IoeT0wOyB5PGRpc2FibGVkVGFncy5sZW5ndGg7IHkrKykgewogICAgICAgICAgaWYoZWxlbWVudFt4XS50YWdOYW1lID09PSBkaXNhYmxlZFRhZ3NbeV0pIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgY2xlYXJIaXN0b3J5OiBmdW5jdGlvbigpIHsKICAgICAgdmFyCiAgICAgIGhpc3RvcmllcyA9ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3RvcmllcywKICAgICAgY3VycmVudFZpZXcgPSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5jdXJyZW50VmlldzsKCiAgICAgIGlmKGhpc3RvcmllcykgewogICAgICAgIGZvcih2YXIgaGlzdG9yeUlkIGluIGhpc3RvcmllcykgewoKICAgICAgICAgIGlmKGhpc3Rvcmllc1toaXN0b3J5SWRdLnN0YWNrKSB7CiAgICAgICAgICAgIGhpc3Rvcmllc1toaXN0b3J5SWRdLnN0YWNrID0gW107CiAgICAgICAgICAgIGhpc3Rvcmllc1toaXN0b3J5SWRdLmN1cnNvciA9IC0xOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKGN1cnJlbnRWaWV3ICYmIGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCA9PT0gaGlzdG9yeUlkKSB7CiAgICAgICAgICAgIGN1cnJlbnRWaWV3LmJhY2tWaWV3SWQgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50Vmlldy5mb3J3YXJkVmlld0lkID0gbnVsbDsKICAgICAgICAgICAgaGlzdG9yaWVzW2hpc3RvcnlJZF0uc3RhY2sucHVzaChjdXJyZW50Vmlldyk7CiAgICAgICAgICB9IGVsc2UgaWYoaGlzdG9yaWVzW2hpc3RvcnlJZF0uZGVzdHJveSkgewogICAgICAgICAgICBoaXN0b3JpZXNbaGlzdG9yeUlkXS5kZXN0cm95KCk7CiAgICAgICAgICB9CgogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yKHZhciB2aWV3SWQgaW4gJHJvb3RTY29wZS4kdmlld0hpc3Rvcnkudmlld3MpIHsKICAgICAgICBpZih2aWV3SWQgIT09IGN1cnJlbnRWaWV3LnZpZXdJZCkgewogICAgICAgICAgZGVsZXRlICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LnZpZXdzW3ZpZXdJZF07CiAgICAgICAgfQogICAgICB9CgogICAgICBpZihjdXJyZW50VmlldykgewogICAgICAgIHRoaXMuc2V0TmF2Vmlld3MoY3VycmVudFZpZXcudmlld0lkKTsKICAgICAgfQogICAgfQoKICB9OwoKfV0pOwoKLyoqCiAqIEBwcml2YXRlCiAqLwpJb25pY01vZHVsZS5jb25maWcoWwogICckcHJvdmlkZScsCmZ1bmN0aW9uKCRwcm92aWRlKSB7CiAgZnVuY3Rpb24gJExvY2F0aW9uRGVjb3JhdG9yKCRsb2NhdGlvbiwgJHRpbWVvdXQpIHsKCiAgICAkbG9jYXRpb24uX19oYXNoID0gJGxvY2F0aW9uLmhhc2g7CiAgICAvL0ZpeDogd2hlbiB3aW5kb3cubG9jYXRpb24uaGFzaCBpcyBzZXQsIHRoZSBzY3JvbGxhYmxlIGFyZWEKICAgIC8vZm91bmQgbmVhcmVzdCB0byBib2R5J3Mgc2Nyb2xsVG9wIGlzIHNldCB0byBzY3JvbGwgdG8gYW4gZWxlbWVudAogICAgLy93aXRoIHRoYXQgSUQuCiAgICAkbG9jYXRpb24uaGFzaCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBzY3JvbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2Nyb2xsLWNvbnRlbnQnKTsKICAgICAgICAgIGlmIChzY3JvbGwpCiAgICAgICAgICAgIHNjcm9sbC5zY3JvbGxUb3AgPSAwOwogICAgICAgIH0sIDAsIGZhbHNlKTsKICAgICAgfQogICAgICByZXR1cm4gJGxvY2F0aW9uLl9faGFzaCh2YWx1ZSk7CiAgICB9OwoKICAgIHJldHVybiAkbG9jYXRpb247CiAgfQoKICAkcHJvdmlkZS5kZWNvcmF0b3IoJyRsb2NhdGlvbicsIFsnJGRlbGVnYXRlJywgJyR0aW1lb3V0JywgJExvY2F0aW9uRGVjb3JhdG9yXSk7Cn1dKTsKCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlCiAqIEBtb2R1bGUgaW9uaWMKICoKICogQGRlc2NyaXB0aW9uCiAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0fSBkaXJlY3RpdmUuCiAqCiAqIE1ldGhvZHMgY2FsbGVkIGRpcmVjdGx5IG9uIHRoZSAkaW9uaWNMaXN0RGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIGxpc3RzLgogKiBVc2UgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY0xpc3REZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUgJGdldEJ5SGFuZGxlfQogKiBtZXRob2QgdG8gY29udHJvbCBzcGVjaWZpYyBpb25MaXN0IGluc3RhbmNlcy4KICoKICogQHVzYWdlCiAqCiAqIGBgYGBodG1sCiAqIDxpb24tY29udGVudCBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogKiAgIDxidXR0b24gY2xhc3M9ImJ1dHRvbiIgbmctY2xpY2s9InNob3dEZWxldGVCdXR0b25zKCkiPjwvYnV0dG9uPgogKiAgIDxpb24tbGlzdD4KICogICAgIDxpb24taXRlbSBuZy1yZXBlYXQ9ImkgaW4gaXRlbXMiPgogKiAgICAgICB7JSByYXcgJX1IZWxsbywge3tpfX0heyUgZW5kcmF3ICV9CiAqICAgICAgIDxpb24tZGVsZXRlLWJ1dHRvbiBjbGFzcz0iaW9uLW1pbnVzLWNpcmNsZWQiPjwvaW9uLWRlbGV0ZS1idXR0b24+CiAqICAgICA8L2lvbi1pdGVtPgogKiAgIDwvaW9uLWxpc3Q+CiAqIDwvaW9uLWNvbnRlbnQ+CiAqIGBgYAogKiBgYGBqcwogKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlLCAkaW9uaWNMaXN0RGVsZWdhdGUpIHsKICogICAkc2NvcGUuc2hvd0RlbGV0ZUJ1dHRvbnMgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY0xpc3REZWxlZ2F0ZS5zaG93RGVsZXRlKHRydWUpOwogKiAgIH07CiAqIH0KICogYGBgCiAqLwpJb25pY01vZHVsZQouc2VydmljZSgnJGlvbmljTGlzdERlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlI3Nob3dSZW9yZGVyCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvd1Jlb3JkZXIgU2V0IHdoZXRoZXIgb3Igbm90IHRoaXMgbGlzdCBpcyBzaG93aW5nIGl0cyByZW9yZGVyIGJ1dHRvbnMuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJlb3JkZXIgYnV0dG9ucyBhcmUgc2hvd24uCiAgICovCiAgJ3Nob3dSZW9yZGVyJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlI3Nob3dEZWxldGUKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93RGVsZXRlIFNldCB3aGV0aGVyIG9yIG5vdCB0aGlzIGxpc3QgaXMgc2hvd2luZyBpdHMgZGVsZXRlIGJ1dHRvbnMuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGRlbGV0ZSBidXR0b25zIGFyZSBzaG93bi4KICAgKi8KICAnc2hvd0RlbGV0ZScsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZSNjYW5Td2lwZUl0ZW1zCiAgICogQHBhcmFtIHtib29sZWFuPX0gY2FuU3dpcGVJdGVtcyBTZXQgd2hldGhlciBvciBub3QgdGhpcyBsaXN0IGlzIGFibGUgdG8gc3dpcGUgdG8gc2hvdwogICAqIG9wdGlvbiBidXR0b25zLgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBsaXN0IGlzIGFibGUgdG8gc3dpcGUgdG8gc2hvdyBvcHRpb24gYnV0dG9ucy4KICAgKi8KICAnY2FuU3dpcGVJdGVtcycsCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZSNjbG9zZU9wdGlvbkJ1dHRvbnMKICAgKiBAZGVzY3JpcHRpb24gQ2xvc2VzIGFueSBvcHRpb24gYnV0dG9ucyBvbiB0aGUgbGlzdCB0aGF0IGFyZSBzd2lwZWQgb3Blbi4KICAgKi8KICAnY2xvc2VPcHRpb25CdXR0b25zJywKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAqIEBwYXJhbSB7c3RyaW5nfSBoYW5kbGUKICAgKiBAcmV0dXJucyBgZGVsZWdhdGVJbnN0YW5jZWAgQSBkZWxlZ2F0ZSBpbnN0YW5jZSB0aGF0IGNvbnRyb2xzIG9ubHkgdGhlCiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0fSBkaXJlY3RpdmVzIHdpdGggYGRlbGVnYXRlLWhhbmRsZWAgbWF0Y2hpbmcKICAgKiB0aGUgZ2l2ZW4gaGFuZGxlLgogICAqCiAgICogRXhhbXBsZTogYCRpb25pY0xpc3REZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215LWhhbmRsZScpLnNob3dSZW9yZGVyKHRydWUpO2AKICAgKi8KXSkpCgouY29udHJvbGxlcignJGlvbmljTGlzdCcsIFsKICAnJHNjb3BlJywKICAnJGF0dHJzJywKICAnJHBhcnNlJywKICAnJGlvbmljTGlzdERlbGVnYXRlJywKZnVuY3Rpb24oJHNjb3BlLCAkYXR0cnMsICRwYXJzZSwgJGlvbmljTGlzdERlbGVnYXRlKSB7CgogIHZhciBpc1N3aXBlYWJsZSA9IHRydWU7CiAgdmFyIGlzUmVvcmRlclNob3duID0gZmFsc2U7CiAgdmFyIGlzRGVsZXRlU2hvd24gPSBmYWxzZTsKCiAgdmFyIGRlcmVnaXN0ZXJJbnN0YW5jZSA9ICRpb25pY0xpc3REZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCAkYXR0cnMuZGVsZWdhdGVIYW5kbGUpOwogICRzY29wZS4kb24oJyRkZXN0cm95JywgZGVyZWdpc3Rlckluc3RhbmNlKTsKCiAgdGhpcy5zaG93UmVvcmRlciA9IGZ1bmN0aW9uKHNob3cpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGlzUmVvcmRlclNob3duID0gISFzaG93OwogICAgfQogICAgcmV0dXJuIGlzUmVvcmRlclNob3duOwogIH07CgogIHRoaXMuc2hvd0RlbGV0ZSA9IGZ1bmN0aW9uKHNob3cpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGlzRGVsZXRlU2hvd24gPSAhIXNob3c7CiAgICB9CiAgICByZXR1cm4gaXNEZWxldGVTaG93bjsKICB9OwoKICB0aGlzLmNhblN3aXBlSXRlbXMgPSBmdW5jdGlvbihjYW4pIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGlzU3dpcGVhYmxlID0gISFjYW47CiAgICB9CiAgICByZXR1cm4gaXNTd2lwZWFibGU7CiAgfTsKCiAgdGhpcy5jbG9zZU9wdGlvbkJ1dHRvbnMgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMubGlzdFZpZXcgJiYgdGhpcy5saXN0Vmlldy5jbGVhckRyYWdFZmZlY3RzKCk7CiAgfTsKfV0pOwoKSW9uaWNNb2R1bGUKLmNvbnRyb2xsZXIoJyRpb25pY05hdkJhcicsIFsKICAnJHNjb3BlJywKICAnJGVsZW1lbnQnLAogICckYXR0cnMnLAogICckaW9uaWNWaWV3U2VydmljZScsCiAgJyRhbmltYXRlJywKICAnJGNvbXBpbGUnLAogICckaW9uaWNOYXZCYXJEZWxlZ2F0ZScsCmZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgJGlvbmljVmlld1NlcnZpY2UsICRhbmltYXRlLCAkY29tcGlsZSwgJGlvbmljTmF2QmFyRGVsZWdhdGUpIHsKICAvL0xldCB0aGUgcGFyZW50IGtub3cgYWJvdXQgb3VyIGNvbnRyb2xsZXIgdG9vIHNvIHRoYXQgY2hpbGRyZW4gb2YKICAvL3NpYmxpbmcgY29udGVudCBlbGVtZW50cyBjYW4ga25vdyBhYm91dCB1cwogICRlbGVtZW50LnBhcmVudCgpLmRhdGEoJyRpb25OYXZCYXJDb250cm9sbGVyJywgdGhpcyk7CgogIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCAkYXR0cnMuZGVsZWdhdGVIYW5kbGUpOwoKICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGRlcmVnaXN0ZXJJbnN0YW5jZSk7CgogICRzY29wZS4kb24oJyR2aWV3SGlzdG9yeS5oaXN0b3J5Q2hhbmdlJywgZnVuY3Rpb24oZSwgZGF0YSkgewogICAgYmFja0lzU2hvd24gPSAhIWRhdGEuc2hvd0JhY2s7CiAgfSk7CgogIHZhciBzZWxmID0gdGhpczsKCiAgdGhpcy5sZWZ0QnV0dG9uc0VsZW1lbnQgPSBqcUxpdGUoCiAgICAkZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCcuYnV0dG9ucy5sZWZ0LWJ1dHRvbnMnKQogICk7CiAgdGhpcy5yaWdodEJ1dHRvbnNFbGVtZW50ID0ganFMaXRlKAogICAgJGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLmJ1dHRvbnMucmlnaHQtYnV0dG9ucycpCiAgKTsKCiAgdGhpcy5iYWNrID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYmFja1ZpZXcgPSAkaW9uaWNWaWV3U2VydmljZS5nZXRCYWNrVmlldygpOwogICAgYmFja1ZpZXcgJiYgYmFja1ZpZXcuZ28oKTsKICAgIHJldHVybiBmYWxzZTsKICB9OwoKICB0aGlzLmFsaWduID0gZnVuY3Rpb24oZGlyZWN0aW9uKSB7CiAgICB0aGlzLl9oZWFkZXJCYXJWaWV3LmFsaWduKGRpcmVjdGlvbik7CiAgfTsKCiAgdGhpcy5zaG93QmFja0J1dHRvbiA9IGZ1bmN0aW9uKHNob3cpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICRzY29wZS5iYWNrQnV0dG9uU2hvd24gPSAhIXNob3c7CiAgICB9CiAgICByZXR1cm4gISEoJHNjb3BlLmhhc0JhY2tCdXR0b24gJiYgJHNjb3BlLmJhY2tCdXR0b25TaG93bik7CiAgfTsKCiAgdGhpcy5zaG93QmFyID0gZnVuY3Rpb24oc2hvdykgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgJHNjb3BlLmlzSW52aXNpYmxlID0gIXNob3c7CiAgICAgICRzY29wZS4kcGFyZW50LiRoYXNIZWFkZXIgPSAhIXNob3c7CiAgICB9CiAgICByZXR1cm4gISRzY29wZS5pc0ludmlzaWJsZTsKICB9OwoKICB0aGlzLnNldFRpdGxlID0gZnVuY3Rpb24odGl0bGUpIHsKICAgIGlmICgkc2NvcGUudGl0bGUgPT09IHRpdGxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgICRzY29wZS5vbGRUaXRsZSA9ICRzY29wZS50aXRsZTsKICAgICRzY29wZS50aXRsZSA9IHRpdGxlIHx8ICcnOwogIH07CgogIHRoaXMuY2hhbmdlVGl0bGUgPSBmdW5jdGlvbih0aXRsZSwgZGlyZWN0aW9uKSB7CiAgICBpZiAoJHNjb3BlLnRpdGxlID09PSB0aXRsZSkgewogICAgICAvLyBpZiB3ZSdyZSBub3QgYW5pbWF0aW5nIHRoZSB0aXRsZSwgYnV0IHRoZSBiYWNrIGJ1dHRvbiBiZWNvbWVzIGludmlzaWJsZQogICAgICBpZih0eXBlb2YgYmFja0lzU2hvd24gIT0gJ3VuZGVmaW5lZCcgJiYgIWJhY2tJc1Nob3duICYmICRzY29wZS5iYWNrQnV0dG9uU2hvd24pewogICAgICAgIGpxTGl0ZSgkZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCcuYmFjay1idXR0b24nKSkuYWRkQ2xhc3MoJ25nLWhpZGUnKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLnNldFRpdGxlKHRpdGxlKTsKICAgICRzY29wZS5pc1JldmVyc2UgPSBkaXJlY3Rpb24gPT0gJ2JhY2snOwogICAgJHNjb3BlLnNob3VsZEFuaW1hdGUgPSAhIWRpcmVjdGlvbjsKCiAgICBpZiAoISRzY29wZS5zaG91bGRBbmltYXRlKSB7CiAgICAgIC8vV2UncmUgZG9uZSEKICAgICAgdGhpcy5faGVhZGVyQmFyVmlldy5hbGlnbigpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fYW5pbWF0ZVRpdGxlcygpOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgdGhpcy5nZXRUaXRsZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICRzY29wZS50aXRsZSB8fCAnJzsKICB9OwoKICB0aGlzLmdldFByZXZpb3VzVGl0bGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiAkc2NvcGUub2xkVGl0bGUgfHwgJyc7CiAgfTsKCiAgLyoqCiAgICogRXhwb3NlZCBmb3IgdGVzdGluZwogICAqLwogIHRoaXMuX2FuaW1hdGVUaXRsZXMgPSBmdW5jdGlvbigpIHsKICAgIHZhciBvbGRUaXRsZUVsLCBuZXdUaXRsZUVsLCBjdXJyZW50VGl0bGVzOwoKICAgIC8vSWYgd2UgaGF2ZSBhbnkgdGl0bGUgcmlnaHQgbm93CiAgICAvLyhvciBtb3JlIHRoYW4gb25lLCB0aGV5IGNvdWxkIGJlIHRyYW5zaXRpb25pbmcgb24gc3dpdGNoKSwKICAgIC8vcmVwbGFjZSB0aGUgZmlyc3Qgb25lIHdpdGggYW4gb2xkVGl0bGUgZWxlbWVudAogICAgY3VycmVudFRpdGxlcyA9ICRlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJy50aXRsZScpOwogICAgaWYgKGN1cnJlbnRUaXRsZXMubGVuZ3RoKSB7CiAgICAgIG9sZFRpdGxlRWwgPSAkY29tcGlsZSgnPGgxIGNsYXNzPSJ0aXRsZSIgbmctYmluZC1odG1sPSJvbGRUaXRsZSI+PC9oMT4nKSgkc2NvcGUpOwogICAgICBqcUxpdGUoY3VycmVudFRpdGxlc1swXSkucmVwbGFjZVdpdGgob2xkVGl0bGVFbCk7CiAgICB9CiAgICAvL0NvbXBpbGUgbmV3IHRpdGxlCiAgICBuZXdUaXRsZUVsID0gJGNvbXBpbGUoJzxoMSBjbGFzcz0idGl0bGUgaW52aXNpYmxlIiBuZy1iaW5kLWh0bWw9InRpdGxlIj48L2gxPicpKCRzY29wZSk7CgogICAgLy9BbmltYXRlIGluIG9uIG5leHQgZnJhbWUKICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKCiAgICAgIG9sZFRpdGxlRWwgJiYgJGFuaW1hdGUubGVhdmUoanFMaXRlKG9sZFRpdGxlRWwpKTsKCiAgICAgIHZhciBpbnNlcnQgPSBvbGRUaXRsZUVsICYmIGpxTGl0ZShvbGRUaXRsZUVsKSB8fCBudWxsOwogICAgICAkYW5pbWF0ZS5lbnRlcihuZXdUaXRsZUVsLCAkZWxlbWVudCwgaW5zZXJ0LCBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLl9oZWFkZXJCYXJWaWV3LmFsaWduKCk7CiAgICAgIH0pOwoKICAgICAgLy9DbGVhbnVwIGFueSBvbGQgdGl0bGVzIGxlZnRvdmVyIChiZXNpZGVzIHRoZSBvbmUgd2UgYWxyZWFkeSBkaWQgcmVwbGFjZVdpdGggb24pCiAgICAgIGZvckVhY2goY3VycmVudFRpdGxlcywgZnVuY3Rpb24oZWwpIHsKICAgICAgICBpZiAoZWwgJiYgZWwucGFyZW50Tm9kZSkgewogICAgICAgICAgLy9Vc2UgLnJlbW92ZSgpIHRvIGNsZWFudXAgdGhpbmdzIGxpa2UgLmRhdGEoKQogICAgICAgICAganFMaXRlKGVsKS5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8kYXBwbHkgc28gYmluZGluZ3MgZmlyZQogICAgICAkc2NvcGUuJGRpZ2VzdCgpOwoKICAgICAgLy9TdG9wIGZsaWNrZXIgb2YgbmV3IHRpdGxlIG9uIGlvczcKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgIG5ld1RpdGxlRWxbMF0uY2xhc3NMaXN0LnJlbW92ZSgnaW52aXNpYmxlJyk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKfV0pOwoKCi8qKgogKiBAcHJpdmF0ZQogKi8KSW9uaWNNb2R1bGUKCi5mYWN0b3J5KCckJHNjcm9sbFZhbHVlQ2FjaGUnLCBmdW5jdGlvbigpIHsKICByZXR1cm4ge307Cn0pCgouY29udHJvbGxlcignJGlvbmljU2Nyb2xsJywgWwogICckc2NvcGUnLAogICdzY3JvbGxWaWV3T3B0aW9ucycsCiAgJyR0aW1lb3V0JywKICAnJHdpbmRvdycsCiAgJyQkc2Nyb2xsVmFsdWVDYWNoZScsCiAgJyRsb2NhdGlvbicsCiAgJyRyb290U2NvcGUnLAogICckZG9jdW1lbnQnLAogICckaW9uaWNTY3JvbGxEZWxlZ2F0ZScsCmZ1bmN0aW9uKCRzY29wZSwgc2Nyb2xsVmlld09wdGlvbnMsICR0aW1lb3V0LCAkd2luZG93LCAkJHNjcm9sbFZhbHVlQ2FjaGUsICRsb2NhdGlvbiwgJHJvb3RTY29wZSwgJGRvY3VtZW50LCAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSkgewoKICB2YXIgc2VsZiA9IHRoaXM7CiAgLy8gZm9yIHRlc3RpbmcKICB0aGlzLl9fdGltZW91dCA9ICR0aW1lb3V0OwoKICB0aGlzLl9zY3JvbGxWaWV3T3B0aW9ucyA9IHNjcm9sbFZpZXdPcHRpb25zOyAvL2ZvciB0ZXN0aW5nCgogIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50ID0gc2Nyb2xsVmlld09wdGlvbnMuZWw7CiAgdmFyICRlbGVtZW50ID0gdGhpcy4kZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKICB2YXIgc2Nyb2xsVmlldyA9IHRoaXMuc2Nyb2xsVmlldyA9IG5ldyBpb25pYy52aWV3cy5TY3JvbGwoc2Nyb2xsVmlld09wdGlvbnMpOwoKICAvL0F0dGFjaCBzZWxmIHRvIGVsZW1lbnQgYXMgYSBjb250cm9sbGVyIHNvIG90aGVyIGRpcmVjdGl2ZXMgY2FuIHJlcXVpcmUgdGhpcyBjb250cm9sbGVyCiAgLy90aHJvdWdoIGByZXF1aXJlOiAnJGlvbmljU2Nyb2xsJwogIC8vQWxzbyBhdHRhY2ggdG8gcGFyZW50IHNvIHRoYXQgc2libGluZyBlbGVtZW50cyBjYW4gcmVxdWlyZSB0aGlzCiAgKCRlbGVtZW50LnBhcmVudCgpLmxlbmd0aCA/ICRlbGVtZW50LnBhcmVudCgpIDogJGVsZW1lbnQpCiAgICAuZGF0YSgnJCRpb25pY1Njcm9sbENvbnRyb2xsZXInLCB0aGlzKTsKCiAgdmFyIGRlcmVnaXN0ZXJJbnN0YW5jZSA9ICRpb25pY1Njcm9sbERlbGVnYXRlLl9yZWdpc3Rlckluc3RhbmNlKAogICAgdGhpcywgc2Nyb2xsVmlld09wdGlvbnMuZGVsZWdhdGVIYW5kbGUKICApOwoKICBpZiAoIWFuZ3VsYXIuaXNEZWZpbmVkKHNjcm9sbFZpZXdPcHRpb25zLmJvdW5jaW5nKSkgewogICAgaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgIHNjcm9sbFZpZXcub3B0aW9ucy5ib3VuY2luZyA9IHRydWU7CgogICAgICBpZihpb25pYy5QbGF0Zm9ybS5pc0FuZHJvaWQoKSkgewogICAgICAgIC8vIE5vIGJvdW5jaW5nIGJ5IGRlZmF1bHQgb24gQW5kcm9pZAogICAgICAgIHNjcm9sbFZpZXcub3B0aW9ucy5ib3VuY2luZyA9IGZhbHNlOwogICAgICAgIC8vIEZhc3RlciBzY3JvbGwgZGVjZWwKICAgICAgICBzY3JvbGxWaWV3Lm9wdGlvbnMuZGVjZWxlcmF0aW9uID0gMC45NTsKICAgICAgfSBlbHNlIHsKICAgICAgfQogICAgfSk7CiAgfQoKICB2YXIgcmVzaXplID0gYW5ndWxhci5iaW5kKHNjcm9sbFZpZXcsIHNjcm9sbFZpZXcucmVzaXplKTsKICBpb25pYy5vbigncmVzaXplJywgcmVzaXplLCAkd2luZG93KTsKCiAgLy8gc2V0IGJ5IHJvb3RTY29wZSBsaXN0ZW5lciBpZiBuZWVkZWQKICB2YXIgYmFja0xpc3RlbkRvbmUgPSBhbmd1bGFyLm5vb3A7CiAgdmFyIHZpZXdDb250ZW50TG9hZGVkID0gYW5ndWxhci5ub29wOwoKICB2YXIgc2Nyb2xsRnVuYyA9IGZ1bmN0aW9uKGUpIHsKICAgIHZhciBkZXRhaWwgPSAoZS5vcmlnaW5hbEV2ZW50IHx8IGUpLmRldGFpbCB8fCB7fTsKICAgICRzY29wZS4kb25TY3JvbGwgJiYgJHNjb3BlLiRvblNjcm9sbCh7CiAgICAgIGV2ZW50OiBlLAogICAgICBzY3JvbGxUb3A6IGRldGFpbC5zY3JvbGxUb3AgfHwgMCwKICAgICAgc2Nyb2xsTGVmdDogZGV0YWlsLnNjcm9sbExlZnQgfHwgMAogICAgfSk7CiAgfTsKCiAgJGVsZW1lbnQub24oJ3Njcm9sbCcsIHNjcm9sbEZ1bmMgKTsKCiAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgIGRlcmVnaXN0ZXJJbnN0YW5jZSgpOwogICAgc2Nyb2xsVmlldy5fX2NsZWFudXAoKTsKICAgIGlvbmljLm9mZigncmVzaXplJywgcmVzaXplLCAkd2luZG93KTsKICAgICR3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgcmVzaXplKTsKICAgIHZpZXdDb250ZW50TG9hZGVkKCk7CiAgICBiYWNrTGlzdGVuRG9uZSgpOwogICAgaWYgKHNlbGYuX3JlbWVtYmVyU2Nyb2xsSWQpIHsKICAgICAgJCRzY3JvbGxWYWx1ZUNhY2hlW3NlbGYuX3JlbWVtYmVyU2Nyb2xsSWRdID0gc2Nyb2xsVmlldy5nZXRWYWx1ZXMoKTsKICAgIH0KICAgIHNjcm9sbFZpZXdPcHRpb25zID0gbnVsbDsKICAgIHNlbGYuX3Njcm9sbFZpZXdPcHRpb25zID0gbnVsbDsKICAgIHNlbGYuZWxlbWVudCA9IG51bGw7CiAgICAkZWxlbWVudC5vZmYoJ3Njcm9sbCcsIHNjcm9sbEZ1bmMpOwogICAgJGVsZW1lbnQgPSBudWxsOwogICAgc2VsZi4kZWxlbWVudCA9IG51bGw7CiAgICBzZWxmLnNjcm9sbFZpZXcgPSBudWxsOwogICAgc2Nyb2xsVmlldyA9IG51bGw7CiAgfSk7CgogIHZpZXdDb250ZW50TG9hZGVkID0gJHNjb3BlLiRvbignJHZpZXdDb250ZW50TG9hZGVkJywgZnVuY3Rpb24oZSwgaGlzdG9yeURhdGEpIHsKICAgIC8vb25seSB0aGUgdG9wLW1vc3Qgc2Nyb2xsIGFyZWEgdW5kZXIgYSB2aWV3IHNob3VsZCByZW1lbWJlciB0aGF0IHZpZXcncwogICAgLy9zY3JvbGwgcG9zaXRpb24KICAgIGlmIChlLmRlZmF1bHRQcmV2ZW50ZWQpIHsgcmV0dXJuOyB9CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgdmFyIHZpZXdJZCA9IGhpc3RvcnlEYXRhICYmIGhpc3RvcnlEYXRhLnZpZXdJZCB8fCAkc2NvcGUuJGhpc3RvcnlJZDsKICAgIGlmICh2aWV3SWQpIHsKICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5yZW1lbWJlclNjcm9sbFBvc2l0aW9uKHZpZXdJZCk7CiAgICAgICAgc2VsZi5zY3JvbGxUb1JlbWVtYmVyZWRQb3NpdGlvbigpOwoKICAgICAgICBiYWNrTGlzdGVuRG9uZSA9ICRyb290U2NvcGUuJG9uKCckdmlld0hpc3Rvcnkudmlld0JhY2snLCBmdW5jdGlvbihlLCBmcm9tVmlld0lkLCB0b1ZpZXdJZCkgewogICAgICAgICAgLy9XaGVuIGdvaW5nIGJhY2sgZnJvbSB0aGlzIHZpZXcsIGZvcmdldCBpdHMgc2F2ZWQgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgICBpZiAodmlld0lkID09PSBmcm9tVmlld0lkKSB7CiAgICAgICAgICAgIHNlbGYuZm9yZ2V0U2Nyb2xsUG9zaXRpb24oKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgMCwgZmFsc2UpOwogICAgfQogIH0pOwoKICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgIHNjcm9sbFZpZXcucnVuKCk7CiAgfSk7CgogIHRoaXMuX3JlbWVtYmVyU2Nyb2xsSWQgPSBudWxsOwoKICB0aGlzLmdldFNjcm9sbFZpZXcgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXc7CiAgfTsKCiAgdGhpcy5nZXRTY3JvbGxQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5nZXRWYWx1ZXMoKTsKICB9OwoKICB0aGlzLnJlc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICR0aW1lb3V0KHJlc2l6ZSkudGhlbihmdW5jdGlvbigpIHsKICAgICAgJGVsZW1lbnQudHJpZ2dlckhhbmRsZXIoJ3Njcm9sbC5yZXNpemUnKTsKICAgIH0pOwogIH07CgogIHRoaXMuc2Nyb2xsVG9wID0gZnVuY3Rpb24oc2hvdWxkQW5pbWF0ZSkgewogICAgdGhpcy5yZXNpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBzY3JvbGxWaWV3LnNjcm9sbFRvKDAsIDAsICEhc2hvdWxkQW5pbWF0ZSk7CiAgICB9KTsKICB9OwoKICB0aGlzLnNjcm9sbEJvdHRvbSA9IGZ1bmN0aW9uKHNob3VsZEFuaW1hdGUpIHsKICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgdmFyIG1heCA9IHNjcm9sbFZpZXcuZ2V0U2Nyb2xsTWF4KCk7CiAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsVG8obWF4LmxlZnQsIG1heC50b3AsICEhc2hvdWxkQW5pbWF0ZSk7CiAgICB9KTsKICB9OwoKICB0aGlzLnNjcm9sbFRvID0gZnVuY3Rpb24obGVmdCwgdG9wLCBzaG91bGRBbmltYXRlKSB7CiAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsVG8obGVmdCwgdG9wLCAhIXNob3VsZEFuaW1hdGUpOwogICAgfSk7CiAgfTsKCiAgdGhpcy56b29tVG8gPSBmdW5jdGlvbih6b29tLCBzaG91bGRBbmltYXRlLCBvcmlnaW5MZWZ0LCBvcmlnaW5Ub3ApIHsKICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgc2Nyb2xsVmlldy56b29tVG8oem9vbSwgISFzaG91bGRBbmltYXRlLCBvcmlnaW5MZWZ0LCBvcmlnaW5Ub3ApOwogICAgfSk7CiAgfTsKCiAgdGhpcy56b29tQnkgPSBmdW5jdGlvbih6b29tLCBzaG91bGRBbmltYXRlLCBvcmlnaW5MZWZ0LCBvcmlnaW5Ub3ApIHsKICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgc2Nyb2xsVmlldy56b29tQnkoem9vbSwgISFzaG91bGRBbmltYXRlLCBvcmlnaW5MZWZ0LCBvcmlnaW5Ub3ApOwogICAgfSk7CiAgfTsKCiAgdGhpcy5zY3JvbGxCeSA9IGZ1bmN0aW9uKGxlZnQsIHRvcCwgc2hvdWxkQW5pbWF0ZSkgewogICAgdGhpcy5yZXNpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBzY3JvbGxWaWV3LnNjcm9sbEJ5KGxlZnQsIHRvcCwgISFzaG91bGRBbmltYXRlKTsKICAgIH0pOwogIH07CgogIHRoaXMuYW5jaG9yU2Nyb2xsID0gZnVuY3Rpb24oc2hvdWxkQW5pbWF0ZSkgewogICAgdGhpcy5yZXNpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaGFzaCA9ICRsb2NhdGlvbi5oYXNoKCk7CiAgICAgIHZhciBlbG0gPSBoYXNoICYmICRkb2N1bWVudFswXS5nZXRFbGVtZW50QnlJZChoYXNoKTsKICAgICAgaWYgKCEoaGFzaCAmJiBlbG0pKSB7CiAgICAgICAgc2Nyb2xsVmlldy5zY3JvbGxUbygwLDAsICEhc2hvdWxkQW5pbWF0ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjdXJFbG0gPSBlbG07CiAgICAgIHZhciBzY3JvbGxMZWZ0ID0gMCwgc2Nyb2xsVG9wID0gMCwgbGV2ZWxzQ2xpbWJlZCA9IDA7CiAgICAgIGRvIHsKICAgICAgICBpZihjdXJFbG0gIT09IG51bGwpc2Nyb2xsTGVmdCArPSBjdXJFbG0ub2Zmc2V0TGVmdDsKICAgICAgICBpZihjdXJFbG0gIT09IG51bGwpc2Nyb2xsVG9wICs9IGN1ckVsbS5vZmZzZXRUb3A7CiAgICAgICAgY3VyRWxtID0gY3VyRWxtLm9mZnNldFBhcmVudDsKICAgICAgICBsZXZlbHNDbGltYmVkKys7CiAgICAgIH0gd2hpbGUgKGN1ckVsbS5hdHRyaWJ1dGVzICE9IHNlbGYuZWxlbWVudC5hdHRyaWJ1dGVzICYmIGN1ckVsbS5vZmZzZXRQYXJlbnQpOwogICAgICBzY3JvbGxWaWV3LnNjcm9sbFRvKHNjcm9sbExlZnQsIHNjcm9sbFRvcCwgISFzaG91bGRBbmltYXRlKTsKICAgIH0pOwogIH07CgogIHRoaXMucmVtZW1iZXJTY3JvbGxQb3NpdGlvbiA9IGZ1bmN0aW9uKGlkKSB7CiAgICBpZiAoIWlkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTXVzdCBzdXBwbHkgYW4gaWQgdG8gcmVtZW1iZXIgdGhlIHNjcm9sbCBieSEiKTsKICAgIH0KICAgIHRoaXMuX3JlbWVtYmVyU2Nyb2xsSWQgPSBpZDsKICB9OwogIHRoaXMuZm9yZ2V0U2Nyb2xsUG9zaXRpb24gPSBmdW5jdGlvbigpIHsKICAgIGRlbGV0ZSAkJHNjcm9sbFZhbHVlQ2FjaGVbdGhpcy5fcmVtZW1iZXJTY3JvbGxJZF07CiAgICB0aGlzLl9yZW1lbWJlclNjcm9sbElkID0gbnVsbDsKICB9OwogIHRoaXMuc2Nyb2xsVG9SZW1lbWJlcmVkUG9zaXRpb24gPSBmdW5jdGlvbihzaG91bGRBbmltYXRlKSB7CiAgICB2YXIgdmFsdWVzID0gJCRzY3JvbGxWYWx1ZUNhY2hlW3RoaXMuX3JlbWVtYmVyU2Nyb2xsSWRdOwogICAgaWYgKHZhbHVlcykgewogICAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgc2Nyb2xsVmlldy5zY3JvbGxUbygrdmFsdWVzLmxlZnQsICt2YWx1ZXMudG9wLCBzaG91bGRBbmltYXRlKTsKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICB0aGlzLl9zZXRSZWZyZXNoZXIgPSBmdW5jdGlvbihyZWZyZXNoZXJTY29wZSwgcmVmcmVzaGVyRWxlbWVudCkgewogICAgdmFyIHJlZnJlc2hlciA9IHRoaXMucmVmcmVzaGVyID0gcmVmcmVzaGVyRWxlbWVudDsKICAgIHZhciByZWZyZXNoZXJIZWlnaHQgPSBzZWxmLnJlZnJlc2hlci5jbGllbnRIZWlnaHQgfHwgMDsKICAgIHNjcm9sbFZpZXcuYWN0aXZhdGVQdWxsVG9SZWZyZXNoKHJlZnJlc2hlckhlaWdodCwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIGFjdGl2YXRlQ2FsbGJhY2sKICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICByZWZyZXNoZXJTY29wZS4kb25QdWxsaW5nKCk7CiAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgLy8gZGVhY3RpdmF0ZUNhbGxiYWNrCiAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIHJlZnJlc2hlci5jbGFzc0xpc3QucmVtb3ZlKCdyZWZyZXNoaW5nJyk7CiAgICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5hZGQoJ2ludmlzaWJsZScpOwogICAgICB9LDMwMCk7CiAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgLy8gc3RhcnRDYWxsYmFjawogICAgICByZWZyZXNoZXIuY2xhc3NMaXN0LmFkZCgncmVmcmVzaGluZycpOwogICAgICByZWZyZXNoZXJTY29wZS4kb25SZWZyZXNoKCk7CiAgICB9LGZ1bmN0aW9uKCl7CiAgICAgIC8vIHNob3dDYWxsYmFjawogICAgICByZWZyZXNoZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW52aXNpYmxlJyk7CiAgICB9LGZ1bmN0aW9uKCl7CiAgICAgIC8vIGhpZGVDYWxsYmFjawogICAgICByZWZyZXNoZXIuY2xhc3NMaXN0LmFkZCgnaW52aXNpYmxlJyk7CiAgICB9KTsKICB9Owp9XSk7CgoKSW9uaWNNb2R1bGUKLmNvbnRyb2xsZXIoJyRpb25pY1NpZGVNZW51cycsIFsKICAnJHNjb3BlJywKICAnJGF0dHJzJywKICAnJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZScsCiAgJyRpb25pY1BsYXRmb3JtJywKICAnJGlvbmljQm9keScsCmZ1bmN0aW9uKCRzY29wZSwgJGF0dHJzLCAkaW9uaWNTaWRlTWVudURlbGVnYXRlLCAkaW9uaWNQbGF0Zm9ybSwgJGlvbmljQm9keSkgewogIHZhciBzZWxmID0gdGhpczsKICB2YXIgcmlnaHRTaG93aW5nLCBsZWZ0U2hvd2luZywgaXNEcmFnZ2luZzsKICB2YXIgc3RhcnRYLCBsYXN0WCwgb2Zmc2V0WCwgaXNBc2lkZUV4cG9zZWQ7CgogIHNlbGYuJHNjb3BlID0gJHNjb3BlOwoKICBzZWxmLmluaXRpYWxpemUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBzZWxmLmxlZnQgPSBvcHRpb25zLmxlZnQ7CiAgICBzZWxmLnJpZ2h0ID0gb3B0aW9ucy5yaWdodDsKICAgIHNlbGYuc2V0Q29udGVudChvcHRpb25zLmNvbnRlbnQpOwogICAgc2VsZi5kcmFnVGhyZXNob2xkWCA9IG9wdGlvbnMuZHJhZ1RocmVzaG9sZFggfHwgMTA7CiAgfTsKCiAgLyoqCiAgICogU2V0IHRoZSBjb250ZW50IHZpZXcgY29udHJvbGxlciBpZiBub3QgcGFzc2VkIGluIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAqCiAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRlbnQKICAgKi8KICBzZWxmLnNldENvbnRlbnQgPSBmdW5jdGlvbihjb250ZW50KSB7CiAgICBpZihjb250ZW50KSB7CiAgICAgIHNlbGYuY29udGVudCA9IGNvbnRlbnQ7CgogICAgICBzZWxmLmNvbnRlbnQub25EcmFnID0gZnVuY3Rpb24oZSkgewogICAgICAgIHNlbGYuX2hhbmRsZURyYWcoZSk7CiAgICAgIH07CgogICAgICBzZWxmLmNvbnRlbnQuZW5kRHJhZyA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBzZWxmLl9lbmREcmFnKGUpOwogICAgICB9OwogICAgfQogIH07CgogIHNlbGYuaXNPcGVuTGVmdCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlbGYuZ2V0T3BlbkFtb3VudCgpID4gMDsKICB9OwoKICBzZWxmLmlzT3BlblJpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc2VsZi5nZXRPcGVuQW1vdW50KCkgPCAwOwogIH07CgogIC8qKgogICAqIFRvZ2dsZSB0aGUgbGVmdCBtZW51IHRvIG9wZW4gMTAwJQogICAqLwogIHNlbGYudG9nZ2xlTGVmdCA9IGZ1bmN0aW9uKHNob3VsZE9wZW4pIHsKICAgIHZhciBvcGVuQW1vdW50ID0gc2VsZi5nZXRPcGVuQW1vdW50KCk7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICBzaG91bGRPcGVuID0gb3BlbkFtb3VudCA8PSAwOwogICAgfQogICAgc2VsZi5jb250ZW50LmVuYWJsZUFuaW1hdGlvbigpOwogICAgaWYoIXNob3VsZE9wZW4pIHsKICAgICAgc2VsZi5vcGVuUGVyY2VudGFnZSgwKTsKICAgIH0gZWxzZSB7CiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoMTAwKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBUb2dnbGUgdGhlIHJpZ2h0IG1lbnUgdG8gb3BlbiAxMDAlCiAgICovCiAgc2VsZi50b2dnbGVSaWdodCA9IGZ1bmN0aW9uKHNob3VsZE9wZW4pIHsKICAgIHZhciBvcGVuQW1vdW50ID0gc2VsZi5nZXRPcGVuQW1vdW50KCk7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICBzaG91bGRPcGVuID0gb3BlbkFtb3VudCA+PSAwOwogICAgfQogICAgc2VsZi5jb250ZW50LmVuYWJsZUFuaW1hdGlvbigpOwogICAgaWYoIXNob3VsZE9wZW4pIHsKICAgICAgc2VsZi5vcGVuUGVyY2VudGFnZSgwKTsKICAgIH0gZWxzZSB7CiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoLTEwMCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQ2xvc2UgYWxsIG1lbnVzLgogICAqLwogIHNlbGYuY2xvc2UgPSBmdW5jdGlvbigpIHsKICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoMCk7CiAgfTsKCiAgLyoqCiAgICogQHJldHVybiB7ZmxvYXR9IFRoZSBhbW91bnQgdGhlIHNpZGUgbWVudSBpcyBvcGVuLCBlaXRoZXIgcG9zaXRpdmUgb3IgbmVnYXRpdmUgZm9yIGxlZnQgKHBvc2l0aXZlKSwgb3IgcmlnaHQgKG5lZ2F0aXZlKQogICAqLwogIHNlbGYuZ2V0T3BlbkFtb3VudCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlbGYuY29udGVudCAmJiBzZWxmLmNvbnRlbnQuZ2V0VHJhbnNsYXRlWCgpIHx8IDA7CiAgfTsKCiAgLyoqCiAgICogQHJldHVybiB7ZmxvYXR9IFRoZSByYXRpbyBvZiBvcGVuIGFtb3VudCBvdmVyIG1lbnUgd2lkdGguIEZvciBleGFtcGxlLCBhCiAgICogbWVudSBvZiB3aWR0aCAxMDAgb3BlbiA1MCBwaXhlbHMgd291bGQgYmUgb3BlbiA1MCUgb3IgYSByYXRpbyBvZiAwLjUuIFZhbHVlIGlzIG5lZ2F0aXZlCiAgICogZm9yIHJpZ2h0IG1lbnUuCiAgICovCiAgc2VsZi5nZXRPcGVuUmF0aW8gPSBmdW5jdGlvbigpIHsKICAgIHZhciBhbW91bnQgPSBzZWxmLmdldE9wZW5BbW91bnQoKTsKICAgIGlmKGFtb3VudCA+PSAwKSB7CiAgICAgIHJldHVybiBhbW91bnQgLyBzZWxmLmxlZnQud2lkdGg7CiAgICB9CiAgICByZXR1cm4gYW1vdW50IC8gc2VsZi5yaWdodC53aWR0aDsKICB9OwoKICBzZWxmLmlzT3BlbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlbGYuZ2V0T3BlbkFtb3VudCgpICE9PSAwOwogIH07CgogIC8qKgogICAqIEByZXR1cm4ge2Zsb2F0fSBUaGUgcGVyY2VudGFnZSBvZiBvcGVuIGFtb3VudCBvdmVyIG1lbnUgd2lkdGguIEZvciBleGFtcGxlLCBhCiAgICogbWVudSBvZiB3aWR0aCAxMDAgb3BlbiA1MCBwaXhlbHMgd291bGQgYmUgb3BlbiA1MCUuIFZhbHVlIGlzIG5lZ2F0aXZlCiAgICogZm9yIHJpZ2h0IG1lbnUuCiAgICovCiAgc2VsZi5nZXRPcGVuUGVyY2VudGFnZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlbGYuZ2V0T3BlblJhdGlvKCkgKiAxMDA7CiAgfTsKCiAgLyoqCiAgICogT3BlbiB0aGUgbWVudSB3aXRoIGEgZ2l2ZW4gcGVyY2VudGFnZSBhbW91bnQuCiAgICogQHBhcmFtIHtmbG9hdH0gcGVyY2VudGFnZSBUaGUgcGVyY2VudGFnZSAocG9zaXRpdmUgb3IgbmVnYXRpdmUgZm9yIGxlZnQvcmlnaHQpIHRvIG9wZW4gdGhlIG1lbnUuCiAgICovCiAgc2VsZi5vcGVuUGVyY2VudGFnZSA9IGZ1bmN0aW9uKHBlcmNlbnRhZ2UpIHsKICAgIHZhciBwID0gcGVyY2VudGFnZSAvIDEwMDsKCiAgICBpZihzZWxmLmxlZnQgJiYgcGVyY2VudGFnZSA+PSAwKSB7CiAgICAgIHNlbGYub3BlbkFtb3VudChzZWxmLmxlZnQud2lkdGggKiBwKTsKICAgIH0gZWxzZSBpZihzZWxmLnJpZ2h0ICYmIHBlcmNlbnRhZ2UgPCAwKSB7CiAgICAgIHZhciBtYXhSaWdodCA9IHNlbGYucmlnaHQud2lkdGg7CiAgICAgIHNlbGYub3BlbkFtb3VudChzZWxmLnJpZ2h0LndpZHRoICogcCk7CiAgICB9CgogICAgLy8gYWRkIHRoZSBDU1MgY2xhc3MgIm1lbnUtb3BlbiIgaWYgdGhlIHBlcmNlbnRhZ2UgZG9lcyBub3QKICAgIC8vIGVxdWFsIDAsIG90aGVyd2lzZSByZW1vdmUgdGhlIGNsYXNzIGZyb20gdGhlIGJvZHkgZWxlbWVudAogICAgJGlvbmljQm9keS5lbmFibGVDbGFzcyggKHBlcmNlbnRhZ2UgIT09IDApLCAnbWVudS1vcGVuJyk7CiAgfTsKCiAgLyoqCiAgICogT3BlbiB0aGUgbWVudSB0aGUgZ2l2ZW4gcGl4ZWwgYW1vdW50LgogICAqIEBwYXJhbSB7ZmxvYXR9IGFtb3VudCB0aGUgcGl4ZWwgYW1vdW50IHRvIG9wZW4gdGhlIG1lbnUuIFBvc2l0aXZlIHZhbHVlIGZvciBsZWZ0IG1lbnUsCiAgICogbmVnYXRpdmUgdmFsdWUgZm9yIHJpZ2h0IG1lbnUgKG9ubHkgb25lIG1lbnUgd2lsbCBiZSB2aXNpYmxlIGF0IGEgdGltZSkuCiAgICovCiAgc2VsZi5vcGVuQW1vdW50ID0gZnVuY3Rpb24oYW1vdW50KSB7CiAgICB2YXIgbWF4TGVmdCA9IHNlbGYubGVmdCAmJiBzZWxmLmxlZnQud2lkdGggfHwgMDsKICAgIHZhciBtYXhSaWdodCA9IHNlbGYucmlnaHQgJiYgc2VsZi5yaWdodC53aWR0aCB8fCAwOwoKICAgIC8vIENoZWNrIGlmIHdlIGNhbiBtb3ZlIHRvIHRoYXQgc2lkZSwgZGVwZW5kaW5nIGlmIHRoZSBsZWZ0L3JpZ2h0IHBhbmVsIGlzIGVuYWJsZWQKICAgIGlmKCEoc2VsZi5sZWZ0ICYmIHNlbGYubGVmdC5pc0VuYWJsZWQpICYmIGFtb3VudCA+IDApIHsKICAgICAgc2VsZi5jb250ZW50LnNldFRyYW5zbGF0ZVgoMCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZighKHNlbGYucmlnaHQgJiYgc2VsZi5yaWdodC5pc0VuYWJsZWQpICYmIGFtb3VudCA8IDApIHsKICAgICAgc2VsZi5jb250ZW50LnNldFRyYW5zbGF0ZVgoMCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZihsZWZ0U2hvd2luZyAmJiBhbW91bnQgPiBtYXhMZWZ0KSB7CiAgICAgIHNlbGYuY29udGVudC5zZXRUcmFuc2xhdGVYKG1heExlZnQpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYocmlnaHRTaG93aW5nICYmIGFtb3VudCA8IC1tYXhSaWdodCkgewogICAgICBzZWxmLmNvbnRlbnQuc2V0VHJhbnNsYXRlWCgtbWF4UmlnaHQpOwogICAgICByZXR1cm47CiAgICB9CgogICAgc2VsZi5jb250ZW50LnNldFRyYW5zbGF0ZVgoYW1vdW50KTsKCiAgICBpZihhbW91bnQgPj0gMCkgewogICAgICBsZWZ0U2hvd2luZyA9IHRydWU7CiAgICAgIHJpZ2h0U2hvd2luZyA9IGZhbHNlOwoKICAgICAgaWYoYW1vdW50ID4gMCkgewogICAgICAgIC8vIFB1c2ggdGhlIHotaW5kZXggb2YgdGhlIHJpZ2h0IG1lbnUgZG93bgogICAgICAgIHNlbGYucmlnaHQgJiYgc2VsZi5yaWdodC5wdXNoRG93biAmJiBzZWxmLnJpZ2h0LnB1c2hEb3duKCk7CiAgICAgICAgLy8gQnJpbmcgdGhlIHotaW5kZXggb2YgdGhlIGxlZnQgbWVudSB1cAogICAgICAgIHNlbGYubGVmdCAmJiBzZWxmLmxlZnQuYnJpbmdVcCAmJiBzZWxmLmxlZnQuYnJpbmdVcCgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByaWdodFNob3dpbmcgPSB0cnVlOwogICAgICBsZWZ0U2hvd2luZyA9IGZhbHNlOwoKICAgICAgLy8gQnJpbmcgdGhlIHotaW5kZXggb2YgdGhlIHJpZ2h0IG1lbnUgdXAKICAgICAgc2VsZi5yaWdodCAmJiBzZWxmLnJpZ2h0LmJyaW5nVXAgJiYgc2VsZi5yaWdodC5icmluZ1VwKCk7CiAgICAgIC8vIFB1c2ggdGhlIHotaW5kZXggb2YgdGhlIGxlZnQgbWVudSBkb3duCiAgICAgIHNlbGYubGVmdCAmJiBzZWxmLmxlZnQucHVzaERvd24gJiYgc2VsZi5sZWZ0LnB1c2hEb3duKCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogR2l2ZW4gYW4gZXZlbnQgb2JqZWN0LCBmaW5kIHRoZSBmaW5hbCByZXN0aW5nIHBvc2l0aW9uIG9mIHRoaXMgc2lkZQogICAqIG1lbnUuIEZvciBleGFtcGxlLCBpZiB0aGUgdXNlciAidGhyb3dzIiB0aGUgY29udGVudCB0byB0aGUgcmlnaHQgYW5kCiAgICogcmVsZWFzZXMgdGhlIHRvdWNoLCB0aGUgbGVmdCBtZW51IHNob3VsZCBzbmFwIG9wZW4gKGFuaW1hdGVkLCBvZiBjb3Vyc2UpLgogICAqCiAgICogQHBhcmFtIHtFdmVudH0gZSB0aGUgZ2VzdHVyZSBldmVudCB0byB1c2UgZm9yIHNuYXBwaW5nCiAgICovCiAgc2VsZi5zbmFwVG9SZXN0ID0gZnVuY3Rpb24oZSkgewogICAgLy8gV2Ugd2FudCB0byBhbmltYXRlIGF0IHRoZSBlbmQgb2YgdGhpcwogICAgc2VsZi5jb250ZW50LmVuYWJsZUFuaW1hdGlvbigpOwogICAgaXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgIC8vIENoZWNrIGhvdyBtdWNoIHRoZSBwYW5lbCBpcyBvcGVuIGFmdGVyIHRoZSBkcmFnLCBhbmQKICAgIC8vIHdoYXQgdGhlIGRyYWcgdmVsb2NpdHkgaXMKICAgIHZhciByYXRpbyA9IHNlbGYuZ2V0T3BlblJhdGlvKCk7CgogICAgaWYocmF0aW8gPT09IDApIHsKICAgICAgLy8gSnVzdCB0byBiZSBzYWZlCiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoMCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgdmVsb2NpdHlUaHJlc2hvbGQgPSAwLjM7CiAgICB2YXIgdmVsb2NpdHlYID0gZS5nZXN0dXJlLnZlbG9jaXR5WDsKICAgIHZhciBkaXJlY3Rpb24gPSBlLmdlc3R1cmUuZGlyZWN0aW9uOwoKICAgIC8vIEdvaW5nIHJpZ2h0LCBsZXNzIHRoYW4gaGFsZiwgdG9vIHNsb3cgKHNuYXAgYmFjaykKICAgIGlmKHJhdGlvID4gMCAmJiByYXRpbyA8IDAuNSAmJiBkaXJlY3Rpb24gPT0gJ3JpZ2h0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKDApOwogICAgfQoKICAgIC8vIEdvaW5nIGxlZnQsIG1vcmUgdGhhbiBoYWxmLCB0b28gc2xvdyAoc25hcCBiYWNrKQogICAgZWxzZSBpZihyYXRpbyA+IDAuNSAmJiBkaXJlY3Rpb24gPT0gJ2xlZnQnICYmIHZlbG9jaXR5WCA8IHZlbG9jaXR5VGhyZXNob2xkKSB7CiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoMTAwKTsKICAgIH0KCiAgICAvLyBHb2luZyBsZWZ0LCBsZXNzIHRoYW4gaGFsZiwgdG9vIHNsb3cgKHNuYXAgYmFjaykKICAgIGVsc2UgaWYocmF0aW8gPCAwICYmIHJhdGlvID4gLTAuNSAmJiBkaXJlY3Rpb24gPT0gJ2xlZnQnICYmIHZlbG9jaXR5WCA8IHZlbG9jaXR5VGhyZXNob2xkKSB7CiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoMCk7CiAgICB9CgogICAgLy8gR29pbmcgcmlnaHQsIG1vcmUgdGhhbiBoYWxmLCB0b28gc2xvdyAoc25hcCBiYWNrKQogICAgZWxzZSBpZihyYXRpbyA8IDAuNSAmJiBkaXJlY3Rpb24gPT0gJ3JpZ2h0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKC0xMDApOwogICAgfQoKICAgIC8vIEdvaW5nIHJpZ2h0LCBtb3JlIHRoYW4gaGFsZiwgb3IgcXVpY2tseSAoc25hcCBvcGVuKQogICAgZWxzZSBpZihkaXJlY3Rpb24gPT0gJ3JpZ2h0JyAmJiByYXRpbyA+PSAwICYmIChyYXRpbyA+PSAwLjUgfHwgdmVsb2NpdHlYID4gdmVsb2NpdHlUaHJlc2hvbGQpKSB7CiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoMTAwKTsKICAgIH0KCiAgICAvLyBHb2luZyBsZWZ0LCBtb3JlIHRoYW4gaGFsZiwgb3IgcXVpY2tseSAoc3BhbiBvcGVuKQogICAgZWxzZSBpZihkaXJlY3Rpb24gPT0gJ2xlZnQnICYmIHJhdGlvIDw9IDAgJiYgKHJhdGlvIDw9IC0wLjUgfHwgdmVsb2NpdHlYID4gdmVsb2NpdHlUaHJlc2hvbGQpKSB7CiAgICAgIHNlbGYub3BlblBlcmNlbnRhZ2UoLTEwMCk7CiAgICB9CgogICAgLy8gU25hcCBiYWNrIGZvciBzYWZldHkKICAgIGVsc2UgewogICAgICBzZWxmLm9wZW5QZXJjZW50YWdlKDApOwogICAgfQogIH07CgogIHNlbGYuaXNBc2lkZUV4cG9zZWQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiAhIWlzQXNpZGVFeHBvc2VkOwogIH07CgogIHNlbGYuZXhwb3NlQXNpZGUgPSBmdW5jdGlvbihzaG91bGRFeHBvc2VBc2lkZSkgewogICAgaXNBc2lkZUV4cG9zZWQgPSBzaG91bGRFeHBvc2VBc2lkZTsKCiAgICAvLyBzZXQgdGhlIGxlZnQgbWFyZ2V0IHdpZHRoIGlmIGl0IHNob3VsZCBiZSBleHBvc2VkCiAgICAvLyBvdGhlcndpc2Ugc2V0IGZhbHNlIHNvIHRoZXJlJ3Mgbm8gbGVmdCBtYXJnaW4KICAgIHNlbGYuY29udGVudC5zZXRNYXJnaW5MZWZ0KCBpc0FzaWRlRXhwb3NlZCA/IHNlbGYubGVmdC53aWR0aCA6IDAgKTsKCiAgICBzZWxmLiRzY29wZS4kZW1pdCgnJGlvbmljRXhwb3NlQXNpZGUnLCBpc0FzaWRlRXhwb3NlZCk7CiAgfTsKCiAgc2VsZi5hY3RpdmVBc2lkZVJlc2l6aW5nID0gZnVuY3Rpb24oaXNSZXNpemluZykgewogICAgJGlvbmljQm9keS5lbmFibGVDbGFzcyhpc1Jlc2l6aW5nLCAnYXNpZGUtcmVzaXppbmcnKTsKICB9OwoKICAvLyBFbmQgYSBkcmFnIHdpdGggdGhlIGdpdmVuIGV2ZW50CiAgc2VsZi5fZW5kRHJhZyA9IGZ1bmN0aW9uKGUpIHsKICAgIGlmKGlzQXNpZGVFeHBvc2VkKSByZXR1cm47CgogICAgaWYoaXNEcmFnZ2luZykgewogICAgICBzZWxmLnNuYXBUb1Jlc3QoZSk7CiAgICB9CiAgICBzdGFydFggPSBudWxsOwogICAgbGFzdFggPSBudWxsOwogICAgb2Zmc2V0WCA9IG51bGw7CiAgfTsKCiAgLy8gSGFuZGxlIGEgZHJhZyBldmVudAogIHNlbGYuX2hhbmRsZURyYWcgPSBmdW5jdGlvbihlKSB7CiAgICBpZihpc0FzaWRlRXhwb3NlZCkgcmV0dXJuOwoKICAgIC8vIElmIHdlIGRvbid0IGhhdmUgc3RhcnQgY29vcmRzLCBncmFiIGFuZCBzdG9yZSB0aGVtCiAgICBpZighc3RhcnRYKSB7CiAgICAgIHN0YXJ0WCA9IGUuZ2VzdHVyZS50b3VjaGVzWzBdLnBhZ2VYOwogICAgICBsYXN0WCA9IHN0YXJ0WDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEdyYWIgdGhlIGN1cnJlbnQgdGFwIGNvb3JkcwogICAgICBsYXN0WCA9IGUuZ2VzdHVyZS50b3VjaGVzWzBdLnBhZ2VYOwogICAgfQoKICAgIC8vIENhbGN1bGF0ZSBkaWZmZXJlbmNlIGZyb20gdGhlIHRhcCBwb2ludHMKICAgIGlmKCFpc0RyYWdnaW5nICYmIE1hdGguYWJzKGxhc3RYIC0gc3RhcnRYKSA+IHNlbGYuZHJhZ1RocmVzaG9sZFgpIHsKICAgICAgLy8gaWYgdGhlIGRpZmZlcmVuY2UgaXMgZ3JlYXRlciB0aGFuIHRocmVzaG9sZCwgc3RhcnQgZHJhZ2dpbmcgdXNpbmcgdGhlIGN1cnJlbnQKICAgICAgLy8gcG9pbnQgYXMgdGhlIHN0YXJ0aW5nIHBvaW50CiAgICAgIHN0YXJ0WCA9IGxhc3RYOwoKICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgIC8vIEluaXRpYWxpemUgZHJhZ2dpbmcKICAgICAgc2VsZi5jb250ZW50LmRpc2FibGVBbmltYXRpb24oKTsKICAgICAgb2Zmc2V0WCA9IHNlbGYuZ2V0T3BlbkFtb3VudCgpOwogICAgfQoKICAgIGlmKGlzRHJhZ2dpbmcpIHsKICAgICAgc2VsZi5vcGVuQW1vdW50KG9mZnNldFggKyAobGFzdFggLSBzdGFydFgpKTsKICAgIH0KICB9OwoKICBzZWxmLmNhbkRyYWdDb250ZW50ID0gZnVuY3Rpb24oY2FuRHJhZykgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgJHNjb3BlLmRyYWdDb250ZW50ID0gISFjYW5EcmFnOwogICAgfQogICAgcmV0dXJuICRzY29wZS5kcmFnQ29udGVudDsKICB9OwoKICBzZWxmLmVkZ2VUaHJlc2hvbGQgPSAyNTsKICBzZWxmLmVkZ2VUaHJlc2hvbGRFbmFibGVkID0gZmFsc2U7CiAgc2VsZi5lZGdlRHJhZ1RocmVzaG9sZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBpZiAoYW5ndWxhci5pc051bWJlcih2YWx1ZSkgJiYgdmFsdWUgPiAwKSB7CiAgICAgICAgc2VsZi5lZGdlVGhyZXNob2xkID0gdmFsdWU7CiAgICAgICAgc2VsZi5lZGdlVGhyZXNob2xkRW5hYmxlZCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5lZGdlVGhyZXNob2xkRW5hYmxlZCA9ICEhdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzZWxmLmVkZ2VUaHJlc2hvbGRFbmFibGVkOwogIH07CgogIHNlbGYuaXNEcmFnZ2FibGVUYXJnZXQgPSBmdW5jdGlvbihlKSB7CiAgICAvL09ubHkgcmVzdHJpY3QgZWRnZSB3aGVuIHNpZGVtZW51IGlzIGNsb3NlZCBhbmQgcmVzdHJpY3Rpb24gaXMgZW5hYmxlZAogICAgdmFyIHNob3VsZE9ubHlBbGxvd0VkZ2VEcmFnID0gc2VsZi5lZGdlVGhyZXNob2xkRW5hYmxlZCAmJiAhc2VsZi5pc09wZW4oKTsKICAgIHZhciBzdGFydFggPSBlLmdlc3R1cmUuc3RhcnRFdmVudCAmJiBlLmdlc3R1cmUuc3RhcnRFdmVudC5jZW50ZXIgJiYKICAgICAgZS5nZXN0dXJlLnN0YXJ0RXZlbnQuY2VudGVyLnBhZ2VYOwoKICAgIHZhciBkcmFnSXNXaXRoaW5Cb3VuZHMgPSAhc2hvdWxkT25seUFsbG93RWRnZURyYWcgfHwKICAgICAgc3RhcnRYIDw9IHNlbGYuZWRnZVRocmVzaG9sZCB8fAogICAgICBzdGFydFggPj0gc2VsZi5jb250ZW50Lm9mZnNldFdpZHRoIC0gc2VsZi5lZGdlVGhyZXNob2xkOwoKICAgIHJldHVybiAoJHNjb3BlLmRyYWdDb250ZW50IHx8IHNlbGYuaXNPcGVuKCkpICYmCiAgICAgICAgICAgZHJhZ0lzV2l0aGluQm91bmRzICYmCiAgICAgICAgICAgIWUuZ2VzdHVyZS5zcmNFdmVudC5kZWZhdWx0UHJldmVudGVkICYmCiAgICAgICAgICAgIWUudGFyZ2V0LnRhZ05hbWUubWF0Y2goL2lucHV0fHRleHRhcmVhfHNlbGVjdHxvYmplY3R8ZW1iZWQvaSkgJiYKICAgICAgICAgICAhZS50YXJnZXQuaXNDb250ZW50RWRpdGFibGUgJiYKICAgICAgICAgICAhKGUudGFyZ2V0LmRhdGFzZXQgPyBlLnRhcmdldC5kYXRhc2V0LnByZXZlbnRTY3JvbGwgOiBlLnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHJldmVudC1zY3JvbGwnKSA9PSAndHJ1ZScpOwogIH07CgogICRzY29wZS5zaWRlTWVudUNvbnRlbnRUcmFuc2xhdGVYID0gMDsKCiAgdmFyIGRlcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uID0gYW5ndWxhci5ub29wOwogIHZhciBjbG9zZVNpZGVNZW51ID0gYW5ndWxhci5iaW5kKHNlbGYsIHNlbGYuY2xvc2UpOwoKICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlbGYuZ2V0T3BlbkFtb3VudCgpICE9PSAwOwogIH0sIGZ1bmN0aW9uKGlzT3BlbikgewogICAgZGVyZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oKTsKICAgIGlmIChpc09wZW4pIHsKICAgICAgZGVyZWdpc3RlckJhY2tCdXR0b25BY3Rpb24gPSAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICAgICAgY2xvc2VTaWRlTWVudSwKICAgICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9TSURFX01FTlUKICAgICAgKTsKICAgIH0KICB9KTsKCiAgdmFyIGRlcmVnaXN0ZXJJbnN0YW5jZSA9ICRpb25pY1NpZGVNZW51RGVsZWdhdGUuX3JlZ2lzdGVySW5zdGFuY2UoCiAgICBzZWxmLCAkYXR0cnMuZGVsZWdhdGVIYW5kbGUKICApOwoKICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgZGVyZWdpc3Rlckluc3RhbmNlKCk7CiAgICBkZXJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbigpOwogIH0pOwoKICBzZWxmLmluaXRpYWxpemUoewogICAgbGVmdDogeyB3aWR0aDogMjc1IH0sCiAgICByaWdodDogeyB3aWR0aDogMjc1IH0KICB9KTsKCn1dKTsKCklvbmljTW9kdWxlCi5jb250cm9sbGVyKCckaW9uaWNUYWInLCBbCiAgJyRzY29wZScsCiAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAnJGF0dHJzJywKICAnJGxvY2F0aW9uJywKICAnJHN0YXRlJywKZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNWaWV3U2VydmljZSwgJGF0dHJzLCAkbG9jYXRpb24sICRzdGF0ZSkgewogIHRoaXMuJHNjb3BlID0gJHNjb3BlOwoKICAvL0FsbCBvZiB0aGVzZSBleHBvc2VkIGZvciB0ZXN0aW5nCiAgdGhpcy5ocmVmTWF0Y2hlc1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gJGF0dHJzLmhyZWYgJiYgJGxvY2F0aW9uLnBhdGgoKS5pbmRleE9mKAogICAgICAkYXR0cnMuaHJlZi5yZXBsYWNlKC9eIy8sICcnKS5yZXBsYWNlKC9cLyQvLCAnJykKICAgICkgPT09IDA7CiAgfTsKICB0aGlzLnNyZWZNYXRjaGVzU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiAkYXR0cnMudWlTcmVmICYmICRzdGF0ZS5pbmNsdWRlcyggJGF0dHJzLnVpU3JlZi5zcGxpdCgnKCcpWzBdICk7CiAgfTsKICB0aGlzLm5hdk5hbWVNYXRjaGVzU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLm5hdlZpZXdOYW1lICYmICRpb25pY1ZpZXdTZXJ2aWNlLmlzQ3VycmVudFN0YXRlTmF2Vmlldyh0aGlzLm5hdlZpZXdOYW1lKTsKICB9OwoKICB0aGlzLnRhYk1hdGNoZXNTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuaHJlZk1hdGNoZXNTdGF0ZSgpIHx8IHRoaXMuc3JlZk1hdGNoZXNTdGF0ZSgpIHx8IHRoaXMubmF2TmFtZU1hdGNoZXNTdGF0ZSgpOwogIH07Cn1dKTsKCklvbmljTW9kdWxlCi5jb250cm9sbGVyKCckaW9uaWNUYWJzJywgWwogICckc2NvcGUnLAogICckaW9uaWNWaWV3U2VydmljZScsCiAgJyRlbGVtZW50JywKZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNWaWV3U2VydmljZSwgJGVsZW1lbnQpIHsKICB2YXIgX3NlbGVjdGVkVGFiID0gbnVsbDsKICB2YXIgc2VsZiA9IHRoaXM7CiAgc2VsZi50YWJzID0gW107CgogIHNlbGYuc2VsZWN0ZWRJbmRleCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlbGYudGFicy5pbmRleE9mKF9zZWxlY3RlZFRhYik7CiAgfTsKICBzZWxmLnNlbGVjdGVkVGFiID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gX3NlbGVjdGVkVGFiOwogIH07CgogIHNlbGYuYWRkID0gZnVuY3Rpb24odGFiKSB7CiAgICAkaW9uaWNWaWV3U2VydmljZS5yZWdpc3Rlckhpc3RvcnkodGFiKTsKICAgIHNlbGYudGFicy5wdXNoKHRhYik7CiAgICBpZihzZWxmLnRhYnMubGVuZ3RoID09PSAxKSB7CiAgICAgIHNlbGYuc2VsZWN0KHRhYik7CiAgICB9CiAgfTsKCiAgc2VsZi5yZW1vdmUgPSBmdW5jdGlvbih0YWIpIHsKICAgIHZhciB0YWJJbmRleCA9IHNlbGYudGFicy5pbmRleE9mKHRhYik7CiAgICBpZiAodGFiSW5kZXggPT09IC0xKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIC8vVXNlIGEgZmllbGQgbGlrZSAnJHRhYlNlbGVjdGVkJyBzbyBkZXZlbG9wZXJzIHdvbid0IGFjY2lkZW50YWxseSBzZXQgaXQgaW4gY29udHJvbGxlcnMgZXRjCiAgICBpZiAodGFiLiR0YWJTZWxlY3RlZCkgewogICAgICBzZWxmLmRlc2VsZWN0KHRhYik7CiAgICAgIC8vVHJ5IHRvIHNlbGVjdCBhIG5ldyB0YWIgaWYgd2UncmUgcmVtb3ZpbmcgYSB0YWIKICAgICAgaWYgKHNlbGYudGFicy5sZW5ndGggPT09IDEpIHsKICAgICAgICAvL2RvIG5vdGhpbmcgaWYgdGhlcmUgYXJlIG5vIG90aGVyIHRhYnMgdG8gc2VsZWN0CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy9TZWxlY3QgcHJldmlvdXMgdGFiIGlmIGl0J3MgdGhlIGxhc3QgdGFiLCBlbHNlIHNlbGVjdCBuZXh0IHRhYgogICAgICAgIHZhciBuZXdUYWJJbmRleCA9IHRhYkluZGV4ID09PSBzZWxmLnRhYnMubGVuZ3RoIC0gMSA/IHRhYkluZGV4IC0gMSA6IHRhYkluZGV4ICsgMTsKICAgICAgICBzZWxmLnNlbGVjdChzZWxmLnRhYnNbbmV3VGFiSW5kZXhdKTsKICAgICAgfQogICAgfQogICAgc2VsZi50YWJzLnNwbGljZSh0YWJJbmRleCwgMSk7CiAgfTsKCiAgc2VsZi5kZXNlbGVjdCA9IGZ1bmN0aW9uKHRhYikgewogICAgaWYgKHRhYi4kdGFiU2VsZWN0ZWQpIHsKICAgICAgX3NlbGVjdGVkVGFiID0gbnVsbDsKICAgICAgdGFiLiR0YWJTZWxlY3RlZCA9IGZhbHNlOwogICAgICAodGFiLm9uRGVzZWxlY3QgfHwgYW5ndWxhci5ub29wKSgpOwogICAgfQogIH07CgogIHNlbGYuc2VsZWN0ID0gZnVuY3Rpb24odGFiLCBzaG91bGRFbWl0RXZlbnQpIHsKICAgIHZhciB0YWJJbmRleDsKICAgIGlmIChhbmd1bGFyLmlzTnVtYmVyKHRhYikpIHsKICAgICAgdGFiSW5kZXggPSB0YWI7CiAgICAgIHRhYiA9IHNlbGYudGFic1t0YWJJbmRleF07CiAgICB9IGVsc2UgewogICAgICB0YWJJbmRleCA9IHNlbGYudGFicy5pbmRleE9mKHRhYik7CiAgICB9CgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgc2hvdWxkRW1pdEV2ZW50ID0gISEodGFiLm5hdlZpZXdOYW1lIHx8IHRhYi51aVNyZWYpOwogICAgfQoKICAgIGlmIChfc2VsZWN0ZWRUYWIgJiYgX3NlbGVjdGVkVGFiLiRoaXN0b3J5SWQgPT0gdGFiLiRoaXN0b3J5SWQpIHsKICAgICAgaWYgKHNob3VsZEVtaXRFdmVudCkgewogICAgICAgICRpb25pY1ZpZXdTZXJ2aWNlLmdvVG9IaXN0b3J5Um9vdCh0YWIuJGhpc3RvcnlJZCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvckVhY2goc2VsZi50YWJzLCBmdW5jdGlvbih0YWIpIHsKICAgICAgICBzZWxmLmRlc2VsZWN0KHRhYik7CiAgICAgIH0pOwoKICAgICAgX3NlbGVjdGVkVGFiID0gdGFiOwogICAgICAvL1VzZSBhIGZ1bm55IG5hbWUgbGlrZSAkdGFiU2VsZWN0ZWQgc28gdGhlIGRldmVsb3BlciBkb2Vzbid0IG92ZXJ3cml0ZSB0aGUgdmFyIGluIGEgY2hpbGQgc2NvcGUKICAgICAgdGFiLiR0YWJTZWxlY3RlZCA9IHRydWU7CiAgICAgICh0YWIub25TZWxlY3QgfHwgYW5ndWxhci5ub29wKSgpOwoKICAgICAgaWYgKHNob3VsZEVtaXRFdmVudCkgewogICAgICAgIHZhciB2aWV3RGF0YSA9IHsKICAgICAgICAgIHR5cGU6ICd0YWInLAogICAgICAgICAgdGFiSW5kZXg6IHRhYkluZGV4LAogICAgICAgICAgaGlzdG9yeUlkOiB0YWIuJGhpc3RvcnlJZCwKICAgICAgICAgIG5hdlZpZXdOYW1lOiB0YWIubmF2Vmlld05hbWUsCiAgICAgICAgICBoYXNOYXZWaWV3OiAhIXRhYi5uYXZWaWV3TmFtZSwKICAgICAgICAgIHRpdGxlOiB0YWIudGl0bGUsCiAgICAgICAgICB1cmw6IHRhYi5ocmVmLAogICAgICAgICAgdWlTcmVmOiB0YWIudWlTcmVmCiAgICAgICAgfTsKICAgICAgICAkc2NvcGUuJGVtaXQoJ3ZpZXdTdGF0ZS5jaGFuZ2VIaXN0b3J5Jywgdmlld0RhdGEpOwogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKCi8qCiAqIFdlIGRvbid0IGRvY3VtZW50IHRoZSBpb25BY3Rpb25TaGVldCBkaXJlY3RpdmUsIHdlIGluc3RlYWQgZG9jdW1lbnQKICogdGhlICRpb25pY0FjdGlvblNoZWV0IHNlcnZpY2UKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbkFjdGlvblNoZWV0JywgWyckZG9jdW1lbnQnLCBmdW5jdGlvbigkZG9jdW1lbnQpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHNjb3BlOiB0cnVlLAogICAgcmVwbGFjZTogdHJ1ZSwKICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpewogICAgICB2YXIga2V5VXAgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYoZS53aGljaCA9PSAyNykgewogICAgICAgICAgJHNjb3BlLmNhbmNlbCgpOwogICAgICAgICAgJHNjb3BlLiRhcHBseSgpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciBiYWNrZHJvcENsaWNrID0gZnVuY3Rpb24oZSkgewogICAgICAgIGlmKGUudGFyZ2V0ID09ICRlbGVtZW50WzBdKSB7CiAgICAgICAgICAkc2NvcGUuY2FuY2VsKCk7CiAgICAgICAgICAkc2NvcGUuJGFwcGx5KCk7CiAgICAgICAgfQogICAgICB9OwogICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICRlbGVtZW50LnJlbW92ZSgpOwogICAgICAgICRkb2N1bWVudC51bmJpbmQoJ2tleXVwJywga2V5VXApOwogICAgICB9KTsKCiAgICAgICRkb2N1bWVudC5iaW5kKCdrZXl1cCcsIGtleVVwKTsKICAgICAgJGVsZW1lbnQuYmluZCgnY2xpY2snLCBiYWNrZHJvcENsaWNrKTsKICAgIH0sCiAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC1iYWNrZHJvcCI+JyArCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LXdyYXBwZXIiPicgKwogICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0Ij4nICsKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LWdyb3VwIj4nICsKICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJhY3Rpb24tc2hlZXQtdGl0bGUiIG5nLWlmPSJ0aXRsZVRleHQiIG5nLWJpbmQtaHRtbD0idGl0bGVUZXh0Ij48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICc8YnV0dG9uIGNsYXNzPSJidXR0b24iIG5nLWNsaWNrPSJidXR0b25DbGlja2VkKCRpbmRleCkiIG5nLXJlcGVhdD0iYnV0dG9uIGluIGJ1dHRvbnMiIG5nLWJpbmQtaHRtbD0iYnV0dG9uLnRleHQiPjwvYnV0dG9uPicgKwogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LWdyb3VwIiBuZy1pZj0iZGVzdHJ1Y3RpdmVUZXh0Ij4nICsKICAgICAgICAgICAgICAgICAgICAgICc8YnV0dG9uIGNsYXNzPSJidXR0b24gZGVzdHJ1Y3RpdmUiIG5nLWNsaWNrPSJkZXN0cnVjdGl2ZUJ1dHRvbkNsaWNrZWQoKSIgbmctYmluZC1odG1sPSJkZXN0cnVjdGl2ZVRleHQiPjwvYnV0dG9uPicgKwogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LWdyb3VwIiBuZy1pZj0iY2FuY2VsVGV4dCI+JyArCiAgICAgICAgICAgICAgICAgICAgICAnPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIiBuZy1jbGljaz0iY2FuY2VsKCkiIG5nLWJpbmQtaHRtbD0iY2FuY2VsVGV4dCI+PC9idXR0b24+JyArCiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgJzwvZGl2PicKICB9Owp9XSk7CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uQ2hlY2tib3gKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAY29kZXBlbiBocWNqdQogKiBAZGVzY3JpcHRpb24KICogVGhlIGNoZWNrYm94IGlzIG5vIGRpZmZlcmVudCB0aGFuIHRoZSBIVE1MIGNoZWNrYm94IGlucHV0LCBleGNlcHQgaXQncyBzdHlsZWQgZGlmZmVyZW50bHkuCiAqCiAqIFRoZSBjaGVja2JveCBiZWhhdmVzIGxpa2UgYW55IFtBbmd1bGFySlMgY2hlY2tib3hdKGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nL2lucHV0L2lucHV0W2NoZWNrYm94XSkuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxpb24tY2hlY2tib3ggbmctbW9kZWw9ImlzQ2hlY2tlZCI+Q2hlY2tib3ggTGFiZWw8L2lvbi1jaGVja2JveD4KICogYGBgCiAqLwoKSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uQ2hlY2tib3gnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcGxhY2U6IHRydWUsCiAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgIHRlbXBsYXRlOgogICAgICAnPGxhYmVsIGNsYXNzPSJpdGVtIGl0ZW0tY2hlY2tib3giPicgKwogICAgICAgICc8ZGl2IGNsYXNzPSJjaGVja2JveCBjaGVja2JveC1pbnB1dC1oaWRkZW4gZGlzYWJsZS1wb2ludGVyLWV2ZW50cyI+JyArCiAgICAgICAgICAnPGlucHV0IHR5cGU9ImNoZWNrYm94Ij4nICsKICAgICAgICAgICc8aSBjbGFzcz0iY2hlY2tib3gtaWNvbiI+PC9pPicgKwogICAgICAgICc8L2Rpdj4nICsKICAgICAgICAnPGRpdiBjbGFzcz0iaXRlbS1jb250ZW50IGRpc2FibGUtcG9pbnRlci1ldmVudHMiIG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICc8L2xhYmVsPicsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQuZmluZCgnaW5wdXQnKTsKICAgICAgZm9yRWFjaCh7CiAgICAgICAgJ25hbWUnOiBhdHRyLm5hbWUsCiAgICAgICAgJ25nLXZhbHVlJzogYXR0ci5uZ1ZhbHVlLAogICAgICAgICduZy1tb2RlbCc6IGF0dHIubmdNb2RlbCwKICAgICAgICAnbmctY2hlY2tlZCc6IGF0dHIubmdDaGVja2VkLAogICAgICAgICduZy1kaXNhYmxlZCc6IGF0dHIubmdEaXNhYmxlZCwKICAgICAgICAnbmctdHJ1ZS12YWx1ZSc6IGF0dHIubmdUcnVlVmFsdWUsCiAgICAgICAgJ25nLWZhbHNlLXZhbHVlJzogYXR0ci5uZ0ZhbHNlVmFsdWUsCiAgICAgICAgJ25nLWNoYW5nZSc6IGF0dHIubmdDaGFuZ2UKICAgICAgfSwgZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgaW5wdXQuYXR0cihuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgfTsKfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbW9kdWxlIGlvbmljCiAqIEBuYW1lIGNvbGxlY3Rpb25SZXBlYXQKICogQHJlc3RyaWN0IEEKICogQGNvZGVwZW4gbUZ5Z2gKICogQGRlc2NyaXB0aW9uCiAqIGBjb2xsZWN0aW9uLXJlcGVhdGAgaXMgYSBkaXJlY3RpdmUgdGhhdCBhbGxvd3MgeW91IHRvIHJlbmRlciBsaXN0cyB3aXRoCiAqIHRob3VzYW5kcyBvZiBpdGVtcyBpbiB0aGVtLCBhbmQgZXhwZXJpZW5jZSBsaXR0bGUgdG8gbm8gcGVyZm9ybWFuY2UgcGVuYWx0eS4KICoKICogRGVtbzoKICoKICogVGhlIGRpcmVjdGl2ZSByZW5kZXJzIG9udG8gdGhlIHNjcmVlbiBvbmx5IHRoZSBpdGVtcyB0aGF0IHNob3VsZCBiZSBjdXJyZW50bHkgdmlzaWJsZS4KICogU28gaWYgeW91IGhhdmUgMSwwMDAgaXRlbXMgaW4geW91ciBsaXN0IGJ1dCBvbmx5IHRlbiBmaXQgb24geW91ciBzY3JlZW4sCiAqIGNvbGxlY3Rpb24tcmVwZWF0IHdpbGwgb25seSByZW5kZXIgaW50byB0aGUgRE9NIHRoZSB0ZW4gdGhhdCBhcmUgaW4gdGhlIGN1cnJlbnQKICogc2Nyb2xsIHBvc2l0aW9uLgogKgogKiBIZXJlIGFyZSBhIGZldyB0aGluZ3MgdG8ga2VlcCBpbiBtaW5kIHdoaWxlIHVzaW5nIGNvbGxlY3Rpb24tcmVwZWF0OgogKgogKiAxLiBUaGUgZGF0YSBzdXBwbGllZCB0byBjb2xsZWN0aW9uLXJlcGVhdCBtdXN0IGJlIGFuIGFycmF5LgogKiAyLiBZb3UgbXVzdCBleHBsaWNpdGx5IHRlbGwgdGhlIGRpcmVjdGl2ZSB3aGF0IHNpemUgeW91ciBpdGVtcyB3aWxsIGJlIGluIHRoZSBET00sIHVzaW5nIGRpcmVjdGl2ZSBhdHRyaWJ1dGVzLgogKiBQaXhlbCBhbW91bnRzIG9yIHBlcmNlbnRhZ2VzIGFyZSBhbGxvd2VkIChzZWUgYmVsb3cpLgogKiAzLiBUaGUgZWxlbWVudHMgcmVuZGVyZWQgd2lsbCBiZSBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQ6IGJlIHN1cmUgdG8gbGV0IHlvdXIgQ1NTIHdvcmsgd2l0aAogKiB0aGlzIChzZWUgYmVsb3cpLgogKiA0LiBFYWNoIGNvbGxlY3Rpb24tcmVwZWF0IGxpc3Qgd2lsbCB0YWtlIHVwIGFsbCBvZiBpdHMgcGFyZW50IHNjcm9sbFZpZXcncyBzcGFjZS4KICogSWYgeW91IHdpc2ggdG8gaGF2ZSBtdWx0aXBsZSBsaXN0cyBvbiBvbmUgcGFnZSwgcHV0IGVhY2ggbGlzdCB3aXRoaW4gaXRzIG93bgogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNjcm9sbCBpb25TY3JvbGx9IGNvbnRhaW5lci4KICogNS4gWW91IHNob3VsZCBub3QgdXNlIHRoZSBuZy1zaG93IGFuZCBuZy1oaWRlIGRpcmVjdGl2ZXMgb24geW91ciBpb24tY29udGVudC9pb24tc2Nyb2xsIGVsZW1lbnRzIHRoYXQKICogaGF2ZSBhIGNvbGxlY3Rpb24tcmVwZWF0IGluc2lkZS4gIG5nLXNob3cgYW5kIG5nLWhpZGUgYXBwbHkgdGhlIGBkaXNwbGF5OiBub25lYCBjc3MgcnVsZSB0byB0aGUgY29udGVudCdzCiAqIHN0eWxlLCBjYXVzaW5nIHRoZSBzY3JvbGxWaWV3IHRvIHJlYWQgdGhlIHdpZHRoIGFuZCBoZWlnaHQgb2YgdGhlIGNvbnRlbnQgYXMgMC4gIFJlc3VsdGluZ2x5LAogKiBjb2xsZWN0aW9uLXJlcGVhdCB3aWxsIHJlbmRlciBlbGVtZW50cyB0aGF0IGhhdmUganVzdCBiZWVuIHVuLWhpZGRlbiBpbmNvcnJlY3RseS4KICoKICoKICogQHVzYWdlCiAqCiAqICMjIyMgQmFzaWMgVXNhZ2UgKHNpbmdsZSByb3dzIG9mIGl0ZW1zKQogKgogKiBOb3RpY2UgdHdvIHRoaW5ncyBoZXJlOiB3ZSB1c2Ugbmctc3R5bGUgdG8gc2V0IHRoZSBoZWlnaHQgb2YgdGhlIGl0ZW0gdG8gbWF0Y2gKICogd2hhdCB0aGUgcmVwZWF0ZXIgdGhpbmtzIG91ciBpdGVtIGhlaWdodCBpcy4gIEFkZGl0aW9uYWxseSwgd2UgYWRkIGEgY3NzIHJ1bGUKICogdG8gbWFrZSBvdXIgaXRlbSBzdHJldGNoIHRvIGZpdCB0aGUgZnVsbCBzY3JlZW4gKHNpbmNlIGl0IHdpbGwgYmUgYWJzb2x1dGVseQogKiBwb3NpdGlvbmVkKS4KICoKICogYGBgaHRtbAogKiA8aW9uLWNvbnRlbnQgbmctY29udHJvbGxlcj0iQ29udGVudEN0cmwiPgogKiAgIDxkaXYgY2xhc3M9Imxpc3QiPgogKiAgICAgPGRpdiBjbGFzcz0iaXRlbSBteS1pdGVtIgogKiAgICAgICBjb2xsZWN0aW9uLXJlcGVhdD0iaXRlbSBpbiBpdGVtcyIKICogICAgICAgY29sbGVjdGlvbi1pdGVtLXdpZHRoPSInMTAwJSciCiAqICAgICAgIGNvbGxlY3Rpb24taXRlbS1oZWlnaHQ9ImdldEl0ZW1IZWlnaHQoaXRlbSwgJGluZGV4KSIKICogICAgICAgbmctc3R5bGU9IntoZWlnaHQ6IGdldEl0ZW1IZWlnaHQoaXRlbSwgJGluZGV4KX0iPgogKiAgICAgICB7JSByYXcgJX17e2l0ZW19fXslIGVuZHJhdyAlfQogKiAgICAgPC9kaXY+CiAqICAgPC9kaXY+CiAqIDwvZGl2PgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gQ29udGVudEN0cmwoJHNjb3BlKSB7CiAqICAgJHNjb3BlLml0ZW1zID0gW107CiAqICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDAwOyBpKyspIHsKICogICAgICRzY29wZS5pdGVtcy5wdXNoKCdJdGVtICcgKyBpKTsKICogICB9CiAqCiAqICAgJHNjb3BlLmdldEl0ZW1IZWlnaHQgPSBmdW5jdGlvbihpdGVtLCBpbmRleCkgewogKiAgICAgLy9NYWtlIGV2ZW5seSBpbmRleGVkIGl0ZW1zIGJlIDEwcHggdGFsbGVyLCBmb3IgdGhlIHNha2Ugb2YgZXhhbXBsZQogKiAgICAgcmV0dXJuIChpbmRleCAlIDIpID09PSAwID8gNTAgOiA2MDsKICogICB9OwogKiB9CiAqIGBgYAogKiBgYGBjc3MKICogLm15LWl0ZW0gewogKiAgIGxlZnQ6IDA7CiAqICAgcmlnaHQ6IDA7CiAqIH0KICogYGBgCiAqCiAqICMjIyMgR3JpZCBVc2FnZSAodGhyZWUgaXRlbXMgcGVyIHJvdykKICoKICogYGBgaHRtbAogKiA8aW9uLWNvbnRlbnQ+CiAqICAgPGRpdiBjbGFzcz0iaXRlbSBpdGVtLWF2YXRhciBteS1pbWFnZS1pdGVtIgogKiAgICAgY29sbGVjdGlvbi1yZXBlYXQ9ImltYWdlIGluIGltYWdlcyIKICogICAgIGNvbGxlY3Rpb24taXRlbS13aWR0aD0iJzMzJSciCiAqICAgICBjb2xsZWN0aW9uLWl0ZW0taGVpZ2h0PSInMzMlJyI+CiAqICAgICA8aW1nIG5nLXNyYz0ie3tpbWFnZS5zcmN9fSI+CiAqICAgPC9kaXY+CiAqIDwvaW9uLWNvbnRlbnQ+CiAqIGBgYAogKiBQZXJjZW50YWdlIG9mIHRvdGFsIHZpc2libGUgbGlzdCBkaW1lbnNpb25zLiBUaGlzIGV4YW1wbGUgc2hvd3MgYSAzIGJ5IDMgbWF0cml4IHRoYXQgZml0cyBvbiB0aGUgc2NyZWVuICgzIHJvd3MgYW5kIDMgY29sdW1zKS4gTm90ZSB0aGF0IGRpbWVuc2lvbnMgYXJlIHVzZWQgaW4gdGhlIGNyZWF0aW9uIG9mIHRoZSBlbGVtZW50IGFuZCB0aGVyZWZvcmUgYSBtZWFzdXJlbWVudCBvZiB0aGUgaXRlbSBjYW5ubm90IGJlIHVzZWQgYXMgYW4gaW5wdXQgZGltZW5zaW9uLgogKiBgYGBjc3MKICogLm15LWltYWdlLWl0ZW0gaW1nIHsKICogICBoZWlnaHQ6IDMzJTsKICogICB3aWR0aDogMzMlOwogKiB9CiAqIGBgYAogKgogKiBAcGFyYW0ge2V4cHJlc3Npb259IGNvbGxlY3Rpb24tcmVwZWF0IFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFRoZXNlCiAqICAgZm9ybWF0cyBhcmUgY3VycmVudGx5IHN1cHBvcnRlZDoKICoKICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgdmFyaWFibGUgaXMgdGhlIHVzZXIgZGVmaW5lZCBsb29wIHZhcmlhYmxlIGFuZCBgZXhwcmVzc2lvbmAKICogICAgIGlzIGEgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBhbGJ1bSBpbiBhcnRpc3QuYWxidW1zYC4KICoKICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uIHRyYWNrIGJ5IHRyYWNraW5nX2V4cHJlc3Npb25gIOKAkyBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCB0cmFja2luZyBmdW5jdGlvbgogKiAgICAgd2hpY2ggY2FuIGJlIHVzZWQgdG8gYXNzb2NpYXRlIHRoZSBvYmplY3RzIGluIHRoZSBjb2xsZWN0aW9uIHdpdGggdGhlIERPTSBlbGVtZW50cy4gSWYgbm8gdHJhY2tpbmcgZnVuY3Rpb24KICogICAgIGlzIHNwZWNpZmllZCB0aGUgY29sbGVjdGlvbi1yZXBlYXQgYXNzb2NpYXRlcyBlbGVtZW50cyBieSBpZGVudGl0eSBpbiB0aGUgY29sbGVjdGlvbi4gSXQgaXMgYW4gZXJyb3IgdG8gaGF2ZQogKiAgICAgbW9yZSB0aGFuIG9uZSB0cmFja2luZyBmdW5jdGlvbiB0byByZXNvbHZlIHRvIHRoZSBzYW1lIGtleS4gKFRoaXMgd291bGQgbWVhbiB0aGF0IHR3byBkaXN0aW5jdCBvYmplY3RzIGFyZQogKiAgICAgbWFwcGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LCB3aGljaCBpcyBub3QgcG9zc2libGUuKSAgRmlsdGVycyBzaG91bGQgYmUgYXBwbGllZCB0byB0aGUgZXhwcmVzc2lvbiwKICogICAgIGJlZm9yZSBzcGVjaWZ5aW5nIGEgdHJhY2tpbmcgZXhwcmVzc2lvbi4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtc2AgaXMgZXF1aXZhbGVudCB0byBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSknLiBUaGlzIGltcGxpZXMgdGhhdCB0aGUgRE9NIGVsZW1lbnRzCiAqICAgICB3aWxsIGJlIGFzc29jaWF0ZWQgYnkgaXRlbSBpZGVudGl0eSBpbiB0aGUgYXJyYXkuCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgJGlkKGl0ZW0pYC4gQSBidWlsdCBpbiBgJGlkKClgIGZ1bmN0aW9uIGNhbiBiZSB1c2VkIHRvIGFzc2lnbiBhIHVuaXF1ZQogKiAgICAgYCQkaGFzaEtleWAgcHJvcGVydHkgdG8gZWFjaCBpdGVtIGluIHRoZSBhcnJheS4gVGhpcyBwcm9wZXJ0eSBpcyB0aGVuIHVzZWQgYXMgYSBrZXkgdG8gYXNzb2NpYXRlZCBET00gZWxlbWVudHMKICogICAgIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgaXRlbSBpbiB0aGUgYXJyYXkgYnkgaWRlbnRpdHkuIE1vdmluZyB0aGUgc2FtZSBvYmplY3QgaW4gYXJyYXkgd291bGQgbW92ZSB0aGUgRE9NCiAqICAgICBlbGVtZW50IGluIHRoZSBzYW1lIHdheSBpbiB0aGUgRE9NLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5IGl0ZW0uaWRgIGlzIGEgdHlwaWNhbCBwYXR0ZXJuIHdoZW4gdGhlIGl0ZW1zIGNvbWUgZnJvbSB0aGUgZGF0YWJhc2UuIEluIHRoaXMKICogICAgIGNhc2UgdGhlIG9iamVjdCBpZGVudGl0eSBkb2VzIG5vdCBtYXR0ZXIuIFR3byBvYmplY3RzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgYXMgbG9uZyBhcyB0aGVpciBgaWRgCiAqICAgICBwcm9wZXJ0eSBpcyBzYW1lLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHwgZmlsdGVyOnNlYXJjaFRleHQgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSBwYXR0ZXJuIHRoYXQgbWlnaHQgYmUgdXNlZCB0byBhcHBseSBhIGZpbHRlcgogKiAgICAgdG8gaXRlbXMgaW4gY29uanVuY3Rpb24gd2l0aCBhIHRyYWNraW5nIGV4cHJlc3Npb24uCiAqCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gY29sbGVjdGlvbi1pdGVtLXdpZHRoIFRoZSB3aWR0aCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudC4gIENhbiBiZSBhIG51bWJlciAoaW4gcGl4ZWxzKSBvciBhIHBlcmNlbnRhZ2UuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gY29sbGVjdGlvbi1pdGVtLWhlaWdodCBUaGUgaGVpZ2h0IG9mIHRoZSByZXBlYXRlZCBlbGVtZW50LiAgQ2FuIGJlIGEgbnVtYmVyIChpbiBwaXhlbHMpLCBvciBhIHBlcmNlbnRhZ2UuCiAqCiAqLwp2YXIgQ09MTEVDVElPTl9SRVBFQVRfU0NST0xMVklFV19YWV9FUlJPUiA9ICJDYW5ub3QgY3JlYXRlIGEgY29sbGVjdGlvbi1yZXBlYXQgd2l0aGluIGEgc2Nyb2xsVmlldyB0aGF0IGlzIHNjcm9sbGFibGUgb24gYm90aCB4IGFuZCB5IGF4aXMuICBDaG9vc2UgZWl0aGVyIHggZGlyZWN0aW9uIG9yIHkgZGlyZWN0aW9uLiI7CnZhciBDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX0hFSUdIVF9FUlJPUiA9ICJjb2xsZWN0aW9uLXJlcGVhdCBleHBlY3RlZCBhdHRyaWJ1dGUgY29sbGVjdGlvbi1pdGVtLWhlaWdodCB0byBiZSBhIGFuIGV4cHJlc3Npb24gdGhhdCByZXR1cm5zIGEgbnVtYmVyIChpbiBwaXhlbHMpIG9yIHBlcmNlbnRhZ2UuIjsKdmFyIENPTExFQ1RJT05fUkVQRUFUX0FUVFJfV0lEVEhfRVJST1IgPSAiY29sbGVjdGlvbi1yZXBlYXQgZXhwZWN0ZWQgYXR0cmlidXRlIGNvbGxlY3Rpb24taXRlbS13aWR0aCB0byBiZSBhIGFuIGV4cHJlc3Npb24gdGhhdCByZXR1cm5zIGEgbnVtYmVyIChpbiBwaXhlbHMpIG9yIHBlcmNlbnRhZ2UuIjsKdmFyIENPTExFQ1RJT05fUkVQRUFUX0FUVFJfUkVQRUFUX0VSUk9SID0gImNvbGxlY3Rpb24tcmVwZWF0IGV4cGVjdGVkIGV4cHJlc3Npb24gaW4gZm9ybSBvZiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uX1sgdHJhY2sgYnkgX2lkX10nIGJ1dCBnb3QgJyUnIjsKCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2NvbGxlY3Rpb25SZXBlYXQnLCBbCiAgJyRjb2xsZWN0aW9uUmVwZWF0TWFuYWdlcicsCiAgJyRjb2xsZWN0aW9uRGF0YVNvdXJjZScsCiAgJyRwYXJzZScsCmZ1bmN0aW9uKCRjb2xsZWN0aW9uUmVwZWF0TWFuYWdlciwgJGNvbGxlY3Rpb25EYXRhU291cmNlLCAkcGFyc2UpIHsKICByZXR1cm4gewogICAgcHJpb3JpdHk6IDEwMDAsCiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICQkdGxiOiB0cnVlLAogICAgcmVxdWlyZTogJ14kaW9uaWNTY3JvbGwnLAogICAgY29udHJvbGxlcjogW2Z1bmN0aW9uKCl7fV0sCiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2Nyb2xsQ3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgICAgdmFyIHdyYXAgPSBqcUxpdGUoJzxkaXYgc3R5bGU9InBvc2l0aW9uOnJlbGF0aXZlOyI+Jyk7CiAgICAgICRlbGVtZW50LnBhcmVudCgpWzBdLmluc2VydEJlZm9yZSh3cmFwWzBdLCAkZWxlbWVudFswXSk7CiAgICAgIHdyYXAuYXBwZW5kKCRlbGVtZW50KTsKCiAgICAgIHZhciBzY3JvbGxWaWV3ID0gc2Nyb2xsQ3RybC5zY3JvbGxWaWV3OwogICAgICBpZiAoc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1ggJiYgc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1kpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoQ09MTEVDVElPTl9SRVBFQVRfU0NST0xMVklFV19YWV9FUlJPUik7CiAgICAgIH0KCiAgICAgIHZhciBpc1ZlcnRpY2FsID0gISFzY3JvbGxWaWV3Lm9wdGlvbnMuc2Nyb2xsaW5nWTsKICAgICAgaWYgKGlzVmVydGljYWwgJiYgISRhdHRyLmNvbGxlY3Rpb25JdGVtSGVpZ2h0KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKENPTExFQ1RJT05fUkVQRUFUX0FUVFJfSEVJR0hUX0VSUk9SKTsKICAgICAgfSBlbHNlIGlmICghaXNWZXJ0aWNhbCAmJiAhJGF0dHIuY29sbGVjdGlvbkl0ZW1XaWR0aCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX1dJRFRIX0VSUk9SKTsKICAgICAgfQoKICAgICAgdmFyIGhlaWdodFBhcnNlZCA9ICRwYXJzZSgkYXR0ci5jb2xsZWN0aW9uSXRlbUhlaWdodCB8fCAnIjEwMCUiJyk7CiAgICAgIHZhciB3aWR0aFBhcnNlZCA9ICRwYXJzZSgkYXR0ci5jb2xsZWN0aW9uSXRlbVdpZHRoIHx8ICciMTAwJSInKTsKCiAgICAgIHZhciBoZWlnaHRHZXR0ZXIgPSBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGhlaWdodFBhcnNlZChzY29wZSwgbG9jYWxzKTsKICAgICAgICBpZiAoaXNTdHJpbmcocmVzdWx0KSAmJiByZXN1bHQuaW5kZXhPZignJScpID4gLTEpIHsKICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKHBhcnNlSW50KHJlc3VsdCwgMTApIC8gMTAwICogc2Nyb2xsVmlldy5fX2NsaWVudEhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHZhciB3aWR0aEdldHRlciA9IGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gd2lkdGhQYXJzZWQoc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgaWYgKGlzU3RyaW5nKHJlc3VsdCkgJiYgcmVzdWx0LmluZGV4T2YoJyUnKSA+IC0xKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihwYXJzZUludChyZXN1bHQsIDEwKSAvIDEwMCAqIHNjcm9sbFZpZXcuX19jbGllbnRXaWR0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CgogICAgICB2YXIgbWF0Y2ggPSAkYXR0ci5jb2xsZWN0aW9uUmVwZWF0Lm1hdGNoKC9eXHMqKFtcc1xTXSs/KVxzK2luXHMrKFtcc1xTXSs/KSg/OlxzK3RyYWNrXHMrYnlccysoW1xzXFNdKz8pKT9ccyokLyk7CiAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoQ09MTEVDVElPTl9SRVBFQVRfQVRUUl9SRVBFQVRfRVJST1IKICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoJyUnLCAkYXR0ci5jb2xsZWN0aW9uUmVwZWF0KSk7CiAgICAgIH0KICAgICAgdmFyIGtleUV4cHIgPSBtYXRjaFsxXTsKICAgICAgdmFyIGxpc3RFeHByID0gbWF0Y2hbMl07CiAgICAgIHZhciB0cmFja0J5RXhwciA9IG1hdGNoWzNdOwoKICAgICAgdmFyIGRhdGFTb3VyY2UgPSBuZXcgJGNvbGxlY3Rpb25EYXRhU291cmNlKHsKICAgICAgICBzY29wZTogJHNjb3BlLAogICAgICAgIHRyYW5zY2x1ZGVGbjogJHRyYW5zY2x1ZGUsCiAgICAgICAgdHJhbnNjbHVkZVBhcmVudDogJGVsZW1lbnQucGFyZW50KCksCiAgICAgICAga2V5RXhwcjoga2V5RXhwciwKICAgICAgICBsaXN0RXhwcjogbGlzdEV4cHIsCiAgICAgICAgdHJhY2tCeUV4cHI6IHRyYWNrQnlFeHByLAogICAgICAgIGhlaWdodEdldHRlcjogaGVpZ2h0R2V0dGVyLAogICAgICAgIHdpZHRoR2V0dGVyOiB3aWR0aEdldHRlcgogICAgICB9KTsKICAgICAgdmFyIGNvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyID0gbmV3ICRjb2xsZWN0aW9uUmVwZWF0TWFuYWdlcih7CiAgICAgICAgZGF0YVNvdXJjZTogZGF0YVNvdXJjZSwKICAgICAgICBlbGVtZW50OiBzY3JvbGxDdHJsLiRlbGVtZW50LAogICAgICAgIHNjcm9sbFZpZXc6IHNjcm9sbEN0cmwuc2Nyb2xsVmlldywKICAgICAgfSk7CgogICAgICAkc2NvcGUuJHdhdGNoQ29sbGVjdGlvbihsaXN0RXhwciwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgJiYgIWFuZ3VsYXIuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY29sbGVjdGlvbi1yZXBlYXQgZXhwZWN0cyBhbiBhcnJheSB0byByZXBlYXQgb3ZlciwgYnV0IGluc3RlYWQgZ290ICciICsgdHlwZW9mIHZhbHVlICsgIicuIik7CiAgICAgICAgfQogICAgICAgIHJlcmVuZGVyKHZhbHVlKTsKICAgICAgfSk7CgogICAgICAvLyBGaW5kIGV2ZXJ5IHNpYmxpbmcgYmVmb3JlIGFuZCBhZnRlciB0aGUgcmVwZWF0ZWQgaXRlbXMsIGFuZCBwYXNzIHRoZW0KICAgICAgLy8gdG8gdGhlIGRhdGFTb3VyY2UKICAgICAgdmFyIHNjcm9sbFZpZXdDb250ZW50ID0gc2Nyb2xsQ3RybC5zY3JvbGxWaWV3Ll9fY29udGVudDsKICAgICAgZnVuY3Rpb24gcmVyZW5kZXIodmFsdWUpIHsKICAgICAgICB2YXIgYmVmb3JlU2libGluZ3MgPSBbXTsKICAgICAgICB2YXIgYWZ0ZXJTaWJsaW5ncyA9IFtdOwogICAgICAgIHZhciBiZWZvcmUgPSB0cnVlOwoKICAgICAgICBmb3JFYWNoKHNjcm9sbFZpZXdDb250ZW50LmNoaWxkcmVuLCBmdW5jdGlvbihub2RlLCBpKSB7CiAgICAgICAgICBpZiAoIGlvbmljLkRvbVV0aWwuZWxlbWVudElzRGVzY2VuZGFudCgkZWxlbWVudFswXSwgbm9kZSwgc2Nyb2xsVmlld0NvbnRlbnQpICkgewogICAgICAgICAgICBiZWZvcmUgPSBmYWxzZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZSgnY29sbGVjdGlvbi1yZXBlYXQtaWdub3JlJykpIHJldHVybjsKICAgICAgICAgICAgdmFyIHdpZHRoID0gbm9kZS5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgdmFyIGhlaWdodCA9IG5vZGUub2Zmc2V0SGVpZ2h0OwogICAgICAgICAgICBpZiAod2lkdGggJiYgaGVpZ2h0KSB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBqcUxpdGUobm9kZSk7CiAgICAgICAgICAgICAgKGJlZm9yZSA/IGJlZm9yZVNpYmxpbmdzIDogYWZ0ZXJTaWJsaW5ncykucHVzaCh7CiAgICAgICAgICAgICAgICB3aWR0aDogbm9kZS5vZmZzZXRXaWR0aCwKICAgICAgICAgICAgICAgIGhlaWdodDogbm9kZS5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICAgICAgICAgICAgc2NvcGU6IGVsZW1lbnQuaXNvbGF0ZVNjb3BlKCkgfHwgZWxlbWVudC5zY29wZSgpLAogICAgICAgICAgICAgICAgaXNPdXRzaWRlOiB0cnVlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgc2Nyb2xsVmlldy5yZXNpemUoKTsKICAgICAgICBkYXRhU291cmNlLnNldERhdGEodmFsdWUsIGJlZm9yZVNpYmxpbmdzLCBhZnRlclNpYmxpbmdzKTsKICAgICAgICBjb2xsZWN0aW9uUmVwZWF0TWFuYWdlci5yZXNpemUoKTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZXJlbmRlck9uUmVzaXplKCkgewogICAgICAgIHJlcmVuZGVyKCRzY29wZS4kZXZhbChsaXN0RXhwcikpOwogICAgICB9CgogICAgICBzY3JvbGxDdHJsLiRlbGVtZW50Lm9uKCdzY3JvbGwucmVzaXplJywgcmVyZW5kZXJPblJlc2l6ZSk7CiAgICAgIGlvbmljLm9uKCdyZXNpemUnLCByZXJlbmRlck9uUmVzaXplLCB3aW5kb3cpOwoKICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICBjb2xsZWN0aW9uUmVwZWF0TWFuYWdlci5kZXN0cm95KCk7CiAgICAgICAgZGF0YVNvdXJjZS5kZXN0cm95KCk7CiAgICAgICAgaW9uaWMub2ZmKCdyZXNpemUnLCByZXJlbmRlck9uUmVzaXplLCB3aW5kb3cpOwogICAgICB9KTsKICAgIH0KICB9Owp9XSkKLmRpcmVjdGl2ZSh7CiAgbmdTcmM6IGNvbGxlY3Rpb25SZXBlYXRTcmNEaXJlY3RpdmUoJ25nU3JjJywgJ3NyYycpLAogIG5nU3Jjc2V0OiBjb2xsZWN0aW9uUmVwZWF0U3JjRGlyZWN0aXZlKCduZ1NyY3NldCcsICdzcmNzZXQnKSwKICBuZ0hyZWY6IGNvbGxlY3Rpb25SZXBlYXRTcmNEaXJlY3RpdmUoJ25nSHJlZicsICdocmVmJykKfSk7CgovLyBGaXggZm9yICMxNjc0Ci8vIFByb2JsZW06IGlmIGFuIG5nU3JjIG9yIG5nSHJlZiBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIGZhbHN5IHZhbHVlLCBpdCB3aWxsCi8vIG5vdCBlcmFzZSB0aGUgcHJldmlvdXMgdHJ1dGh5IHZhbHVlIG9mIHRoZSBocmVmLgovLyBJbiBjb2xsZWN0aW9uUmVwZWF0LCB3ZSByZS11c2UgZWxlbWVudHMgZnJvbSBiZWZvcmUuIFNvIGlmIHRoZSBuZ0hyZWYgZXhwcmVzc2lvbgovLyBldmFsdWF0ZXMgdG8gdHJ1dGh5IGZvciBpdGVtIDEgYW5kIHRoZW4gZmFsc3kgZm9yIGl0ZW0gMiwgaWYgYW4gZWxlbWVudCBjaGFuZ2VzCi8vIGZyb20gcmVwcmVzZW50aW5nIGl0ZW0gMSB0byByZXByZXNlbnRpbmcgaXRlbSAyLCBpdGVtIDIgd2lsbCBzdGlsbCBoYXZlCi8vIGl0ZW0gMSdzIGhyZWYgdmFsdWUuCi8vIFNvbHV0aW9uOiAgZXJhc2UgdGhlIGhyZWYgb3Igc3JjIGF0dHJpYnV0ZSBpZiBuZ0hyZWYvbmdTcmMgYXJlIGZhbHN5LgpmdW5jdGlvbiBjb2xsZWN0aW9uUmVwZWF0U3JjRGlyZWN0aXZlKG5nQXR0ck5hbWUsIGF0dHJOYW1lKSB7CiAgcmV0dXJuIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHByaW9yaXR5OiAnOTknLCAvLyBpdCBuZWVkcyB0byBydW4gYWZ0ZXIgdGhlIGF0dHJpYnV0ZXMgYXJlIGludGVycG9sYXRlZAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIGF0dHIuJG9ic2VydmUobmdBdHRyTmFtZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudFswXS5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH1dOwp9CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25Db250ZW50CiAqIEBtb2R1bGUgaW9uaWMKICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljU2Nyb2xsRGVsZWdhdGUKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBpb25Db250ZW50IGRpcmVjdGl2ZSBwcm92aWRlcyBhbiBlYXN5IHRvIHVzZSBjb250ZW50IGFyZWEgdGhhdCBjYW4gYmUgY29uZmlndXJlZAogKiB0byB1c2UgSW9uaWMncyBjdXN0b20gU2Nyb2xsIFZpZXcsIG9yIHRoZSBidWlsdCBpbiBvdmVyZmxvdyBzY3JvbGxpbmcgb2YgdGhlIGJyb3dzZXIuCiAqCiAqIFdoaWxlIHdlIHJlY29tbWVuZCB1c2luZyB0aGUgY3VzdG9tIFNjcm9sbCBmZWF0dXJlcyBpbiBJb25pYyBpbiBtb3N0IGNhc2VzLCBzb21ldGltZXMKICogKGZvciBwZXJmb3JtYW5jZSByZWFzb25zKSBvbmx5IHRoZSBicm93c2VyJ3MgbmF0aXZlIG92ZXJmbG93IHNjcm9sbGluZyB3aWxsIHN1ZmZpY2UsCiAqIGFuZCBzbyB3ZSd2ZSBtYWRlIGl0IGVhc3kgdG8gdG9nZ2xlIGJldHdlZW4gdGhlIElvbmljIHNjcm9sbCBpbXBsZW1lbnRhdGlvbiBhbmQKICogb3ZlcmZsb3cgc2Nyb2xsaW5nLgogKgogKiBZb3UgY2FuIGltcGxlbWVudCBwdWxsLXRvLXJlZnJlc2ggd2l0aCB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25SZWZyZXNoZXJ9CiAqIGRpcmVjdGl2ZSwgYW5kIGluZmluaXRlIHNjcm9sbGluZyB3aXRoIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkluZmluaXRlU2Nyb2xsfQogKiBkaXJlY3RpdmUuCiAqCiAqIEJlIGF3YXJlIHRoYXQgdGhpcyBkaXJlY3RpdmUgZ2V0cyBpdHMgb3duIGNoaWxkIHNjb3BlLiBJZiB5b3UgZG8gbm90IHVuZGVyc3RhbmQgd2h5IHRoaXMKICogaXMgaW1wb3J0YW50LCB5b3UgY2FuIHJlYWQgW2h0dHBzOi8vZG9jcy5hbmd1bGFyanMub3JnL2d1aWRlL3Njb3BlXShodHRwczovL2RvY3MuYW5ndWxhcmpzLm9yZy9ndWlkZS9zY29wZSkuCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIHNjcm9sbFZpZXcKICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTY3JvbGxEZWxlZ2F0ZX0uCiAqIEBwYXJhbSB7c3RyaW5nPX0gZGlyZWN0aW9uIFdoaWNoIHdheSB0byBzY3JvbGwuICd4JyBvciAneScgb3IgJ3h5Jy4gRGVmYXVsdCAneScuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGxvY2tpbmcgV2hldGhlciB0byBsb2NrIHNjcm9sbGluZyBpbiBvbmUgZGlyZWN0aW9uIGF0IGEgdGltZS4gVXNlZnVsIHRvIHNldCB0byBmYWxzZSB3aGVuIHpvb21lZCBpbiBvciBzY3JvbGxpbmcgaW4gdHdvIGRpcmVjdGlvbnMuIERlZmF1bHQgdHJ1ZS4KICogQHBhcmFtIHtib29sZWFuPX0gcGFkZGluZyBXaGV0aGVyIHRvIGFkZCBwYWRkaW5nIHRvIHRoZSBjb250ZW50LgogKiBvZiB0aGUgY29udGVudC4gIERlZmF1bHRzIHRvIHRydWUgb24gaU9TLCBmYWxzZSBvbiBBbmRyb2lkLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBzY3JvbGwgV2hldGhlciB0byBhbGxvdyBzY3JvbGxpbmcgb2YgY29udGVudC4gIERlZmF1bHRzIHRvIHRydWUuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IG92ZXJmbG93LXNjcm9sbCBXaGV0aGVyIHRvIHVzZSBvdmVyZmxvdy1zY3JvbGxpbmcgaW5zdGVhZCBvZgogKiBJb25pYyBzY3JvbGwuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IHNjcm9sbGJhci14IFdoZXRoZXIgdG8gc2hvdyB0aGUgaG9yaXpvbnRhbCBzY3JvbGxiYXIuIERlZmF1bHQgdHJ1ZS4KICogQHBhcmFtIHtib29sZWFuPX0gc2Nyb2xsYmFyLXkgV2hldGhlciB0byBzaG93IHRoZSB2ZXJ0aWNhbCBzY3JvbGxiYXIuIERlZmF1bHQgdHJ1ZS4KICogQHBhcmFtIHtzdHJpbmc9fSBzdGFydC15IEluaXRpYWwgdmVydGljYWwgc2Nyb2xsIHBvc2l0aW9uLiBEZWZhdWx0IDAuCiAqIG9mIHRoZSBjb250ZW50LiAgRGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MsIGZhbHNlIG9uIEFuZHJvaWQuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNjcm9sbCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gdGhlIGNvbnRlbnQgaXMgc2Nyb2xsZWQuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNjcm9sbC1jb21wbGV0ZSBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gYSBzY3JvbGwgYWN0aW9uIGNvbXBsZXRlcy4KICogQHBhcmFtIHtib29sZWFuPX0gaGFzLWJvdW5jaW5nIFdoZXRoZXIgdG8gYWxsb3cgc2Nyb2xsaW5nIHRvIGJvdW5jZSBwYXN0IHRoZSBlZGdlcwogKiBvZiB0aGUgY29udGVudC4gIERlZmF1bHRzIHRvIHRydWUgb24gaU9TLCBmYWxzZSBvbiBBbmRyb2lkLgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uQ29udGVudCcsIFsKICAnJHRpbWVvdXQnLAogICckY29udHJvbGxlcicsCiAgJyRpb25pY0JpbmQnLApmdW5jdGlvbigkdGltZW91dCwgJGNvbnRyb2xsZXIsICRpb25pY0JpbmQpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6ICdeP2lvbk5hdlZpZXcnLAogICAgc2NvcGU6IHRydWUsCiAgICBwcmlvcml0eTogODAwLAogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICB2YXIgaW5uZXJFbGVtZW50OwoKICAgICAgZWxlbWVudC5hZGRDbGFzcygnc2Nyb2xsLWNvbnRlbnQgaW9uaWMtc2Nyb2xsJyk7CgogICAgICBpZiAoYXR0ci5zY3JvbGwgIT0gJ2ZhbHNlJykgewogICAgICAgIC8vV2UgY2Fubm90IHVzZSBub3JtYWwgdHJhbnNjbHVkZSBoZXJlIGJlY2F1c2UgaXQgYnJlYWtzIGVsZW1lbnQuZGF0YSgpCiAgICAgICAgLy9pbmhlcml0YW5jZSBvbiBjb21waWxlCiAgICAgICAgaW5uZXJFbGVtZW50ID0ganFMaXRlKCc8ZGl2IGNsYXNzPSJzY3JvbGwiPjwvZGl2PicpOwogICAgICAgIGlubmVyRWxlbWVudC5hcHBlbmQoZWxlbWVudC5jb250ZW50cygpKTsKICAgICAgICBlbGVtZW50LmFwcGVuZChpbm5lckVsZW1lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3Njcm9sbC1jb250ZW50LWZhbHNlJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBuYXZWaWV3Q3RybCkgewogICAgICAgIHZhciBwYXJlbnRTY29wZSA9ICRzY29wZS4kcGFyZW50OwogICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gKHBhcmVudFNjb3BlLiRoYXNIZWFkZXIgPyAnIGhhcy1oZWFkZXInIDogJycpICArCiAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzU3ViaGVhZGVyID8gJyBoYXMtc3ViaGVhZGVyJyA6ICcnKSArCiAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzRm9vdGVyID8gJyBoYXMtZm9vdGVyJyA6ICcnKSArCiAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzU3ViZm9vdGVyID8gJyBoYXMtc3ViZm9vdGVyJyA6ICcnKSArCiAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzVGFicyA/ICcgaGFzLXRhYnMnIDogJycpICsKICAgICAgICAgICAgKHBhcmVudFNjb3BlLiRoYXNUYWJzVG9wID8gJyBoYXMtdGFicy10b3AnIDogJycpOwogICAgICAgIH0sIGZ1bmN0aW9uKGNsYXNzTmFtZSwgb2xkQ2xhc3NOYW1lKSB7CiAgICAgICAgICAkZWxlbWVudC5yZW1vdmVDbGFzcyhvbGRDbGFzc05hbWUpOwogICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICB9KTsKCiAgICAgICAgLy9Pbmx5IHRoaXMgaW9uQ29udGVudCBzaG91bGQgdXNlIHRoZXNlIHZhcmlhYmxlcyBmcm9tIHBhcmVudCBzY29wZXMKICAgICAgICAkc2NvcGUuJGhhc0hlYWRlciA9ICRzY29wZS4kaGFzU3ViaGVhZGVyID0KICAgICAgICAgICRzY29wZS4kaGFzRm9vdGVyID0gJHNjb3BlLiRoYXNTdWJmb290ZXIgPQogICAgICAgICAgJHNjb3BlLiRoYXNUYWJzID0gJHNjb3BlLiRoYXNUYWJzVG9wID0KICAgICAgICAgIGZhbHNlOwogICAgICAgICRpb25pY0JpbmQoJHNjb3BlLCAkYXR0ciwgewogICAgICAgICAgJG9uU2Nyb2xsOiAnJm9uU2Nyb2xsJywKICAgICAgICAgICRvblNjcm9sbENvbXBsZXRlOiAnJm9uU2Nyb2xsQ29tcGxldGUnLAogICAgICAgICAgaGFzQm91bmNpbmc6ICdAJywKICAgICAgICAgIHBhZGRpbmc6ICdAJywKICAgICAgICAgIGRpcmVjdGlvbjogJ0AnLAogICAgICAgICAgc2Nyb2xsYmFyWDogJ0AnLAogICAgICAgICAgc2Nyb2xsYmFyWTogJ0AnLAogICAgICAgICAgc3RhcnRYOiAnQCcsCiAgICAgICAgICBzdGFydFk6ICdAJywKICAgICAgICAgIHNjcm9sbEV2ZW50SW50ZXJ2YWw6ICdAJwogICAgICAgIH0pOwogICAgICAgICRzY29wZS5kaXJlY3Rpb24gPSAkc2NvcGUuZGlyZWN0aW9uIHx8ICd5JzsKCiAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLnBhZGRpbmcpKSB7CiAgICAgICAgICAkc2NvcGUuJHdhdGNoKCRhdHRyLnBhZGRpbmcsIGZ1bmN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgICAgIChpbm5lckVsZW1lbnQgfHwgJGVsZW1lbnQpLnRvZ2dsZUNsYXNzKCdwYWRkaW5nJywgISFuZXdWYWwpOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoJGF0dHIuc2Nyb2xsID09PSAiZmFsc2UiKSB7CiAgICAgICAgICAvL2RvIG5vdGhpbmcKICAgICAgICB9IGVsc2UgaWYoYXR0ci5vdmVyZmxvd1Njcm9sbCA9PT0gInRydWUiKSB7CiAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygnb3ZlcmZsb3ctc2Nyb2xsJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBzY3JvbGxWaWV3T3B0aW9ucyA9IHsKICAgICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgICBkZWxlZ2F0ZUhhbmRsZTogYXR0ci5kZWxlZ2F0ZUhhbmRsZSwKICAgICAgICAgICAgbG9ja2luZzogKGF0dHIubG9ja2luZyB8fCAndHJ1ZScpID09PSAndHJ1ZScsCiAgICAgICAgICAgIGJvdW5jaW5nOiAkc2NvcGUuJGV2YWwoJHNjb3BlLmhhc0JvdW5jaW5nKSwKICAgICAgICAgICAgc3RhcnRYOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnN0YXJ0WCkgfHwgMCwKICAgICAgICAgICAgc3RhcnRZOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnN0YXJ0WSkgfHwgMCwKICAgICAgICAgICAgc2Nyb2xsYmFyWDogJHNjb3BlLiRldmFsKCRzY29wZS5zY3JvbGxiYXJYKSAhPT0gZmFsc2UsCiAgICAgICAgICAgIHNjcm9sbGJhclk6ICRzY29wZS4kZXZhbCgkc2NvcGUuc2Nyb2xsYmFyWSkgIT09IGZhbHNlLAogICAgICAgICAgICBzY3JvbGxpbmdYOiAkc2NvcGUuZGlyZWN0aW9uLmluZGV4T2YoJ3gnKSA+PSAwLAogICAgICAgICAgICBzY3JvbGxpbmdZOiAkc2NvcGUuZGlyZWN0aW9uLmluZGV4T2YoJ3knKSA+PSAwLAogICAgICAgICAgICBzY3JvbGxFdmVudEludGVydmFsOiBwYXJzZUludCgkc2NvcGUuc2Nyb2xsRXZlbnRJbnRlcnZhbCwgMTApIHx8IDEwLAogICAgICAgICAgICBzY3JvbGxpbmdDb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJHNjb3BlLiRvblNjcm9sbENvbXBsZXRlKHsKICAgICAgICAgICAgICAgIHNjcm9sbFRvcDogdGhpcy5fX3Njcm9sbFRvcCwKICAgICAgICAgICAgICAgIHNjcm9sbExlZnQ6IHRoaXMuX19zY3JvbGxMZWZ0CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICAkY29udHJvbGxlcignJGlvbmljU2Nyb2xsJywgewogICAgICAgICAgICAkc2NvcGU6ICRzY29wZSwKICAgICAgICAgICAgc2Nyb2xsVmlld09wdGlvbnM6IHNjcm9sbFZpZXdPcHRpb25zCiAgICAgICAgICB9KTsKCiAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzY3JvbGxWaWV3T3B0aW9ucy5zY3JvbGxpbmdDb21wbGV0ZSA9IGFuZ3VsYXIubm9vcDsKICAgICAgICAgICAgZGVsZXRlIHNjcm9sbFZpZXdPcHRpb25zLmVsOwogICAgICAgICAgICBpbm5lckVsZW1lbnQgPSBudWxsOwogICAgICAgICAgICAkZWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIGF0dHIuJCRlbGVtZW50ID0gbnVsbDsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgIH0KICAgIH0KICB9Owp9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBleHBvc2VBc2lkZVdoZW4KICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXMKICoKICogQGRlc2NyaXB0aW9uCiAqIEl0IGlzIGNvbW1vbiBmb3IgYSB0YWJsZXQgYXBwbGljYXRpb24gdG8gaGlkZSBhIG1lbnUgd2hlbiBpbiBwb3J0cmFpdCBtb2RlLCBidXQgdG8gc2hvdyB0aGUKICogc2FtZSBtZW51IG9uIHRoZSBsZWZ0IHNpZGUgd2hlbiB0aGUgdGFibGV0IGlzIGluIGxhbmRzY2FwZSBtb2RlLiBUaGUgYGV4cG9zZUFzaWRlV2hlbmAgYXR0cmlidXRlCiAqIGRpcmVjdGl2ZSBjYW4gYmUgdXNlZCB0byBhY2NvbXBsaXNoIGEgc2ltaWxhciBpbnRlcmZhY2UuCiAqCiAqIEJ5IGRlZmF1bHQsIHNpZGUgbWVudXMgYXJlIGhpZGRlbiB1bmRlcm5lYXRoIGl0cyBzaWRlIG1lbnUgY29udGVudCwgYW5kIGNhbiBiZSBvcGVuZWQgYnkgZWl0aGVyCiAqIHN3aXBpbmcgdGhlIGNvbnRlbnQgbGVmdCBvciByaWdodCwgb3IgdG9nZ2xpbmcgYSBidXR0b24gdG8gc2hvdyB0aGUgc2lkZSBtZW51LiBIb3dldmVyLCBieSBhZGRpbmcgdGhlCiAqIGBleHBvc2VBc2lkZVdoZW5gIGF0dHJpYnV0ZSBkaXJlY3RpdmUgdG8gYW4ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudX0gZWxlbWVudCBkaXJlY3RpdmUsCiAqIGEgc2lkZSBtZW51IGNhbiBiZSBnaXZlbiBpbnN0cnVjdGlvbnMgb24gIndoZW4iIHRoZSBtZW51IHNob3VsZCBiZSBleHBvc2VkIChhbHdheXMgdmlld2FibGUpLiBGb3IKICogZXhhbXBsZSwgdGhlIGBleHBvc2UtYXNpZGUtd2hlbj0ibGFyZ2UiYCBhdHRyaWJ1dGUgd2lsbCBrZWVwIHRoZSBzaWRlIG1lbnUgaGlkZGVuIHdoZW4gdGhlIHZpZXdwb3J0J3MKICogd2lkdGggaXMgbGVzcyB0aGFuIGA3NjhweGAsIGJ1dCB3aGVuIHRoZSB2aWV3cG9ydCdzIHdpZHRoIGlzIGA3NjhweGAgb3IgZ3JlYXRlciwgdGhlIG1lbnUgd2lsbCB0aGVuCiAqIGFsd2F5cyBiZSBzaG93biBhbmQgY2FuIG5vIGxvbmdlciBiZSBvcGVuZWQgb3IgY2xvc2VkIGxpa2UgaXQgY291bGQgd2hlbiBpdCB3YXMgaGlkZGVuIGZvciBzbWFsbGVyCiAqIHZpZXdwb3J0cy4KICoKICogVXNpbmcgYGxhcmdlYCBhcyB0aGUgYXR0cmlidXRlJ3MgdmFsdWUgaXMgYSBzaG9ydGN1dCB2YWx1ZSB0byBgKG1pbi13aWR0aDo3NjhweClgIHNpbmNlIGl0IGlzCiAqIHRoZSBtb3N0IGNvbW1vbiB1c2UtY2FzZS4gSG93ZXZlciwgZm9yIGFkZGVkIGZsZXhpYmlsaXR5LCBhbnkgdmFsaWQgbWVkaWEgcXVlcnkgY291bGQgYmUgYWRkZWQKICogYXMgdGhlIHZhbHVlLCBzdWNoIGFzIGAobWluLXdpZHRoOjYwMHB4KWAgb3IgZXZlbiBtdWx0aXBsZSBxdWVyaWVzIHN1Y2ggYXMKICogYChtaW4td2lkdGg6NzUwcHgpIGFuZCAobWF4LXdpZHRoOjEyMDBweClgLgoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi1zaWRlLW1lbnVzPgogKiAgIDwhLS0gQ2VudGVyIGNvbnRlbnQgLS0+CiAqICAgPGlvbi1zaWRlLW1lbnUtY29udGVudD4KICogICA8L2lvbi1zaWRlLW1lbnUtY29udGVudD4KICoKICogICA8IS0tIExlZnQgbWVudSAtLT4KICogICA8aW9uLXNpZGUtbWVudSBleHBvc2UtYXNpZGUtd2hlbj0ibGFyZ2UiPgogKiAgIDwvaW9uLXNpZGUtbWVudT4KICogPC9pb24tc2lkZS1tZW51cz4KICogYGBgCiAqIEZvciBhIGNvbXBsZXRlIHNpZGUgbWVudSBleGFtcGxlLCBzZWUgdGhlCiAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVzfSBkb2N1bWVudGF0aW9uLgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnZXhwb3NlQXNpZGVXaGVuJywgWyckd2luZG93JywgZnVuY3Rpb24oJHdpbmRvdykgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgcmVxdWlyZTogJ15pb25TaWRlTWVudXMnLAogICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNpZGVNZW51Q3RybCkgewoKICAgICAgZnVuY3Rpb24gY2hlY2tBc2lkZUV4cG9zZSgpIHsKICAgICAgICB2YXIgbXEgPSAkYXR0ci5leHBvc2VBc2lkZVdoZW4gPT0gJ2xhcmdlJyA/ICcobWluLXdpZHRoOjc2OHB4KScgOiAkYXR0ci5leHBvc2VBc2lkZVdoZW47CiAgICAgICAgc2lkZU1lbnVDdHJsLmV4cG9zZUFzaWRlKCAkd2luZG93Lm1hdGNoTWVkaWEobXEpLm1hdGNoZXMgKTsKICAgICAgICBzaWRlTWVudUN0cmwuYWN0aXZlQXNpZGVSZXNpemluZyhmYWxzZSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIHNpZGVNZW51Q3RybC5hY3RpdmVBc2lkZVJlc2l6aW5nKHRydWUpOwogICAgICAgIGRlYm91bmNlZENoZWNrKCk7CiAgICAgIH0KCiAgICAgIHZhciBkZWJvdW5jZWRDaGVjayA9IGlvbmljLmRlYm91bmNlKGZ1bmN0aW9uKCkgewogICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKXsKICAgICAgICAgIGNoZWNrQXNpZGVFeHBvc2UoKTsKICAgICAgICB9KTsKICAgICAgfSwgMzAwLCBmYWxzZSk7CgogICAgICBjaGVja0FzaWRlRXhwb3NlKCk7CgogICAgICBpb25pYy5vbigncmVzaXplJywgb25SZXNpemUsICR3aW5kb3cpOwoKICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpewogICAgICAgIGlvbmljLm9mZigncmVzaXplJywgb25SZXNpemUsICR3aW5kb3cpOwogICAgICB9KTsKCiAgICB9CiAgfTsKfV0pOwoKCnZhciBHRVNUVVJFX0RJUkVDVElWRVMgPSAnb25Ib2xkIG9uVGFwIG9uVG91Y2ggb25SZWxlYXNlIG9uRHJhZyBvbkRyYWdVcCBvbkRyYWdSaWdodCBvbkRyYWdEb3duIG9uRHJhZ0xlZnQgb25Td2lwZSBvblN3aXBlVXAgb25Td2lwZVJpZ2h0IG9uU3dpcGVEb3duIG9uU3dpcGVMZWZ0Jy5zcGxpdCgnICcpOwoKR0VTVFVSRV9ESVJFQ1RJVkVTLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogIElvbmljTW9kdWxlLmRpcmVjdGl2ZShuYW1lLCBnZXN0dXJlRGlyZWN0aXZlKG5hbWUpKTsKfSk7CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25Ib2xkCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIFRvdWNoIHN0YXlzIGF0IHRoZSBzYW1lIGxvY2F0aW9uIGZvciA1MDBtcy4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGJ1dHRvbiBvbi1ob2xkPSJvbkhvbGQoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25UYXAKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogUXVpY2sgdG91Y2ggYXQgYSBsb2NhdGlvbi4gSWYgdGhlIGR1cmF0aW9uIG9mIHRoZSB0b3VjaCBnb2VzCiAqIGxvbmdlciB0aGFuIDI1MG1zIGl0IGlzIG5vIGxvbmdlciBhIHRhcCBnZXN0dXJlLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLXRhcD0ib25UYXAoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25Ub3VjaAogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDYWxsZWQgaW1tZWRpYXRlbHkgd2hlbiB0aGUgdXNlciBmaXJzdCBiZWdpbnMgYSB0b3VjaC4gVGhpcwogKiBnZXN0dXJlIGRvZXMgbm90IHdhaXQgZm9yIGEgdG91Y2hlbmQvbW91c2V1cC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGJ1dHRvbiBvbi10b3VjaD0ib25Ub3VjaCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBvblJlbGVhc2UKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogQ2FsbGVkIHdoZW4gdGhlIHVzZXIgZW5kcyBhIHRvdWNoLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLXJlbGVhc2U9Im9uUmVsZWFzZSgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBvbkRyYWcKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogTW92ZSB3aXRoIG9uZSB0b3VjaCBhcm91bmQgb24gdGhlIHBhZ2UuIEJsb2NraW5nIHRoZSBzY3JvbGxpbmcgd2hlbgogKiBtb3ZpbmcgbGVmdCBhbmQgcmlnaHQgaXMgYSBnb29kIHByYWN0aWNlLiBXaGVuIGFsbCB0aGUgZHJhZyBldmVudHMgYXJlCiAqIGJsb2NraW5nIHlvdSBkaXNhYmxlIHNjcm9sbGluZyBvbiB0aGF0IGFyZWEuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tZHJhZz0ib25EcmFnKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uRHJhZ1VwCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxlZCB3aGVuIHRoZSBlbGVtZW50IGlzIGRyYWdnZWQgdXAuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tZHJhZy11cD0ib25EcmFnVXAoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25EcmFnUmlnaHQKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogQ2FsbGVkIHdoZW4gdGhlIGVsZW1lbnQgaXMgZHJhZ2dlZCB0byB0aGUgcmlnaHQuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tZHJhZy1yaWdodD0ib25EcmFnUmlnaHQoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25EcmFnRG93bgogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDYWxsZWQgd2hlbiB0aGUgZWxlbWVudCBpcyBkcmFnZ2VkIGRvd24uCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tZHJhZy1kb3duPSJvbkRyYWdEb3duKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uRHJhZ0xlZnQKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogQ2FsbGVkIHdoZW4gdGhlIGVsZW1lbnQgaXMgZHJhZ2dlZCB0byB0aGUgbGVmdC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGJ1dHRvbiBvbi1kcmFnLWxlZnQ9Im9uRHJhZ0xlZnQoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25Td2lwZQogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDYWxsZWQgd2hlbiBhIG1vdmluZyB0b3VjaCBoYXMgYSBoaWdoIHZlbG9jaXR5IGluIGFueSBkaXJlY3Rpb24uCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tc3dpcGU9Im9uU3dpcGUoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25Td2lwZVVwCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxlZCB3aGVuIGEgbW92aW5nIHRvdWNoIGhhcyBhIGhpZ2ggdmVsb2NpdHkgbW92aW5nIHVwLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8YnV0dG9uIG9uLXN3aXBlLXVwPSJvblN3aXBlVXAoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25Td2lwZVJpZ2h0CiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxlZCB3aGVuIGEgbW92aW5nIHRvdWNoIGhhcyBhIGhpZ2ggdmVsb2NpdHkgbW92aW5nIHRvIHRoZSByaWdodC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGJ1dHRvbiBvbi1zd2lwZS1yaWdodD0ib25Td2lwZVJpZ2h0KCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG9uU3dpcGVEb3duCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxlZCB3aGVuIGEgbW92aW5nIHRvdWNoIGhhcyBhIGhpZ2ggdmVsb2NpdHkgbW92aW5nIGRvd24uCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tc3dpcGUtZG93bj0ib25Td2lwZURvd24oKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgb25Td2lwZUxlZnQKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogQ2FsbGVkIHdoZW4gYSBtb3ZpbmcgdG91Y2ggaGFzIGEgaGlnaCB2ZWxvY2l0eSBtb3ZpbmcgdG8gdGhlIGxlZnQuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxidXR0b24gb24tc3dpcGUtbGVmdD0ib25Td2lwZUxlZnQoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogKiBgYGAKICovCgoKZnVuY3Rpb24gZ2VzdHVyZURpcmVjdGl2ZShkaXJlY3RpdmVOYW1lKSB7CiAgcmV0dXJuIFsnJGlvbmljR2VzdHVyZScsICckcGFyc2UnLCBmdW5jdGlvbigkaW9uaWNHZXN0dXJlLCAkcGFyc2UpIHsKICAgIHZhciBldmVudFR5cGUgPSBkaXJlY3RpdmVOYW1lLnN1YnN0cigyKS50b0xvd2VyQ2FzZSgpOwoKICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICB2YXIgZm4gPSAkcGFyc2UoIGF0dHJbZGlyZWN0aXZlTmFtZV0gKTsKCiAgICAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgZm4oc2NvcGUsIHsKICAgICAgICAgICAgJGV2ZW50OiBldgogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICB2YXIgZ2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oZXZlbnRUeXBlLCBsaXN0ZW5lciwgZWxlbWVudCk7CgogICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoZ2VzdHVyZSwgZXZlbnRUeXBlLCBsaXN0ZW5lcik7CiAgICAgIH0pOwogICAgfTsKICB9XTsKfQoKCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbk5hdkJhcicsIHRhcFNjcm9sbFRvVG9wRGlyZWN0aXZlKCkpCi5kaXJlY3RpdmUoJ2lvbkhlYWRlckJhcicsIHRhcFNjcm9sbFRvVG9wRGlyZWN0aXZlKCkpCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25IZWFkZXJCYXIKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogQWRkcyBhIGZpeGVkIGhlYWRlciBiYXIgYWJvdmUgc29tZSBjb250ZW50LgogKgogKiBDYW4gYWxzbyBiZSBhIHN1YmhlYWRlciAobG93ZXIgZG93bikgaWYgdGhlICdiYXItc3ViaGVhZGVyJyBjbGFzcyBpcyBhcHBsaWVkLgogKiBTZWUgW3RoZSBoZWFkZXIgQ1NTIGRvY3NdKC9kb2NzL2NvbXBvbmVudHMvI3N1YmhlYWRlcikuCiAqCiAqIE5vdGU6IElmIHlvdSB1c2UgaW9uSGVhZGVyQmFyIGluIGNvbWJpbmF0aW9uIHdpdGggbmctaWYsIHRoZSBzdXJyb3VuZGluZyBjb250ZW50CiAqIHdpbGwgbm90IGFsaWduIGNvcnJlY3RseS4gIFRoaXMgd2lsbCBiZSBmaXhlZCBzb29uLgogKgogKiBAcGFyYW0ge3N0cmluZz19IGFsaWduLXRpdGxlIFdoZXJlIHRvIGFsaWduIHRoZSB0aXRsZS4gCiAqIEF2YWlsYWJsZTogJ2xlZnQnLCAncmlnaHQnLCBvciAnY2VudGVyJy4gIERlZmF1bHRzIHRvICdjZW50ZXInLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBuby10YXAtc2Nyb2xsIEJ5IGRlZmF1bHQsIHRoZSBoZWFkZXIgYmFyIHdpbGwgc2Nyb2xsIHRoZQogKiBjb250ZW50IHRvIHRoZSB0b3Agd2hlbiB0YXBwZWQuICBTZXQgbm8tdGFwLXNjcm9sbCB0byB0cnVlIHRvIGRpc2FibGUgdGhpcyAKICogYmVoYXZpb3IuCiAqIEF2YWlsYWJsZTogdHJ1ZSBvciBmYWxzZS4gIERlZmF1bHRzIHRvIGZhbHNlLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8aW9uLWhlYWRlci1iYXIgYWxpZ24tdGl0bGU9ImxlZnQiIGNsYXNzPSJiYXItcG9zaXRpdmUiPgogKiAgIDxkaXYgY2xhc3M9ImJ1dHRvbnMiPgogKiAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIiBuZy1jbGljaz0iZG9Tb21ldGhpbmcoKSI+TGVmdCBCdXR0b248L2J1dHRvbj4KICogICA8L2Rpdj4KICogICA8aDEgY2xhc3M9InRpdGxlIj5UaXRsZSE8L2gxPgogKiAgIDxkaXYgY2xhc3M9ImJ1dHRvbnMiPgogKiAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIj5SaWdodCBCdXR0b248L2J1dHRvbj4KICogICA8L2Rpdj4KICogPC9pb24taGVhZGVyLWJhcj4KICogPGlvbi1jb250ZW50PgogKiAgIFNvbWUgY29udGVudCEKICogPC9pb24tY29udGVudD4KICogYGBgCiAqLwouZGlyZWN0aXZlKCdpb25IZWFkZXJCYXInLCBoZWFkZXJGb290ZXJCYXJEaXJlY3RpdmUodHJ1ZSkpCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25Gb290ZXJCYXIKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogQWRkcyBhIGZpeGVkIGZvb3RlciBiYXIgYmVsb3cgc29tZSBjb250ZW50LgogKgogKiBDYW4gYWxzbyBiZSBhIHN1YmZvb3RlciAoaGlnaGVyIHVwKSBpZiB0aGUgJ2Jhci1zdWJmb290ZXInIGNsYXNzIGlzIGFwcGxpZWQuCiAqIFNlZSBbdGhlIGZvb3RlciBDU1MgZG9jc10oL2RvY3MvY29tcG9uZW50cy8jZm9vdGVyKS4KICoKICogTm90ZTogSWYgeW91IHVzZSBpb25Gb290ZXJCYXIgaW4gY29tYmluYXRpb24gd2l0aCBuZy1pZiwgdGhlIHN1cnJvdW5kaW5nIGNvbnRlbnQKICogd2lsbCBub3QgYWxpZ24gY29ycmVjdGx5LiAgVGhpcyB3aWxsIGJlIGZpeGVkIHNvb24uCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gYWxpZ24tdGl0bGUgV2hlcmUgdG8gYWxpZ24gdGhlIHRpdGxlLgogKiBBdmFpbGFibGU6ICdsZWZ0JywgJ3JpZ2h0Jywgb3IgJ2NlbnRlcicuICBEZWZhdWx0cyB0byAnY2VudGVyJy4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi1jb250ZW50PgogKiAgIFNvbWUgY29udGVudCEKICogPC9pb24tY29udGVudD4KICogPGlvbi1mb290ZXItYmFyIGFsaWduLXRpdGxlPSJsZWZ0IiBjbGFzcz0iYmFyLWFzc2VydGl2ZSI+CiAqICAgPGRpdiBjbGFzcz0iYnV0dG9ucyI+CiAqICAgICA8YnV0dG9uIGNsYXNzPSJidXR0b24iPkxlZnQgQnV0dG9uPC9idXR0b24+CiAqICAgPC9kaXY+CiAqICAgPGgxIGNsYXNzPSJ0aXRsZSI+VGl0bGUhPC9oMT4KICogICA8ZGl2IGNsYXNzPSJidXR0b25zIiBuZy1jbGljaz0iZG9Tb21ldGhpbmcoKSI+CiAqICAgICA8YnV0dG9uIGNsYXNzPSJidXR0b24iPlJpZ2h0IEJ1dHRvbjwvYnV0dG9uPgogKiAgIDwvZGl2PgogKiA8L2lvbi1mb290ZXItYmFyPgogKiBgYGAKICovCi5kaXJlY3RpdmUoJ2lvbkZvb3RlckJhcicsIGhlYWRlckZvb3RlckJhckRpcmVjdGl2ZShmYWxzZSkpOwoKZnVuY3Rpb24gdGFwU2Nyb2xsVG9Ub3BEaXJlY3RpdmUoKSB7CiAgcmV0dXJuIFsnJGlvbmljU2Nyb2xsRGVsZWdhdGUnLCBmdW5jdGlvbigkaW9uaWNTY3JvbGxEZWxlZ2F0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICBpZiAoJGF0dHIubm9UYXBTY3JvbGwgPT0gJ3RydWUnKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlvbmljLm9uKCd0YXAnLCBvblRhcCwgJGVsZW1lbnRbMF0pOwogICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpb25pYy5vZmYoJ3RhcCcsIG9uVGFwLCAkZWxlbWVudFswXSk7CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIG9uVGFwKGUpIHsKICAgICAgICAgIHZhciBkZXB0aCA9IDM7CiAgICAgICAgICB2YXIgY3VycmVudCA9IGUudGFyZ2V0OwogICAgICAgICAgLy9Eb24ndCBzY3JvbGwgdG8gdG9wIGluIGNlcnRhaW4gY2FzZXMKICAgICAgICAgIHdoaWxlIChkZXB0aC0tICYmIGN1cnJlbnQpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCdidXR0b24nKSB8fAogICAgICAgICAgICAgICAgY3VycmVudC50YWdOYW1lLm1hdGNoKC9pbnB1dHx0ZXh0YXJlYXxzZWxlY3QvaSkgfHwKICAgICAgICAgICAgICAgIGN1cnJlbnQuaXNDb250ZW50RWRpdGFibGUpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0b3VjaCA9IGUuZ2VzdHVyZSAmJiBlLmdlc3R1cmUudG91Y2hlc1swXSB8fCBlLmRldGFpbC50b3VjaGVzWzBdOwogICAgICAgICAgdmFyIGJvdW5kcyA9ICRlbGVtZW50WzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgaWYgKGlvbmljLkRvbVV0aWwucmVjdENvbnRhaW5zKAogICAgICAgICAgICB0b3VjaC5wYWdlWCwgdG91Y2gucGFnZVksCiAgICAgICAgICAgIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wIC0gMjAsCiAgICAgICAgICAgIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoLCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodAogICAgICAgICAgKSkgewogICAgICAgICAgICAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS5zY3JvbGxUb3AodHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dOwp9CgpmdW5jdGlvbiBoZWFkZXJGb290ZXJCYXJEaXJlY3RpdmUoaXNIZWFkZXIpIHsKICByZXR1cm4gW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoaXNIZWFkZXIgPyAnYmFyIGJhci1oZWFkZXInIDogJ2JhciBiYXItZm9vdGVyJyk7CiAgICAgICAgdmFyIHBhcmVudCA9ICRlbGVtZW50WzBdLnBhcmVudE5vZGU7CiAgICAgICAgaWYocGFyZW50LnF1ZXJ5U2VsZWN0b3IoJy50YWJzLXRvcCcpKSRlbGVtZW50LmFkZENsYXNzKCdoYXMtdGFicy10b3AnKTsKICAgICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgICB2YXIgaGIgPSBuZXcgaW9uaWMudmlld3MuSGVhZGVyQmFyKHsKICAgICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgICBhbGlnblRpdGxlOiAkYXR0ci5hbGlnblRpdGxlIHx8ICdjZW50ZXInCiAgICAgICAgICB9KTsKCiAgICAgICAgICB2YXIgZWwgPSAkZWxlbWVudFswXTsKCiAgICAgICAgICBpZiAoaXNIZWFkZXIpIHsKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsgcmV0dXJuIGVsLmNsYXNzTmFtZTsgfSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgaXNTaG93biA9IHZhbHVlLmluZGV4T2YoJ25nLWhpZGUnKSA9PT0gLTE7CiAgICAgICAgICAgICAgdmFyIGlzU3ViaGVhZGVyID0gdmFsdWUuaW5kZXhPZignYmFyLXN1YmhlYWRlcicpICE9PSAtMTsKICAgICAgICAgICAgICAkc2NvcGUuJGhhc0hlYWRlciA9IGlzU2hvd24gJiYgIWlzU3ViaGVhZGVyOwogICAgICAgICAgICAgICRzY29wZS4kaGFzU3ViaGVhZGVyID0gaXNTaG93biAmJiBpc1N1YmhlYWRlcjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzSGVhZGVyOwogICAgICAgICAgICAgIGRlbGV0ZSAkc2NvcGUuJGhhc1N1YmhlYWRlcjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgeyByZXR1cm4gZWwuY2xhc3NOYW1lOyB9LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHZhciBpc1Nob3duID0gdmFsdWUuaW5kZXhPZignbmctaGlkZScpID09PSAtMTsKICAgICAgICAgICAgICB2YXIgaXNTdWJmb290ZXIgPSB2YWx1ZS5pbmRleE9mKCdiYXItc3ViZm9vdGVyJykgIT09IC0xOwogICAgICAgICAgICAgICRzY29wZS4kaGFzRm9vdGVyID0gaXNTaG93biAmJiAhaXNTdWJmb290ZXI7CiAgICAgICAgICAgICAgJHNjb3BlLiRoYXNTdWJmb290ZXIgPSBpc1Nob3duICYmIGlzU3ViZm9vdGVyOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNGb290ZXI7CiAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzU3ViZm9vdGVyOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnJGhhc1RhYnMnLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAkZWxlbWVudC50b2dnbGVDbGFzcygnaGFzLXRhYnMnLCAhIXZhbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uSW5maW5pdGVTY3JvbGwKICogQG1vZHVsZSBpb25pYwogKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25Db250ZW50LCBpb25pYy5kaXJlY3RpdmU6aW9uU2Nyb2xsCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgaW9uSW5maW5pdGVTY3JvbGwgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gY2FsbCBhIGZ1bmN0aW9uIHdoZW5ldmVyCiAqIHRoZSB1c2VyIGdldHMgdG8gdGhlIGJvdHRvbSBvZiB0aGUgcGFnZSBvciBuZWFyIHRoZSBib3R0b20gb2YgdGhlIHBhZ2UuCiAqCiAqIFRoZSBleHByZXNzaW9uIHlvdSBwYXNzIGluIGZvciBgb24taW5maW5pdGVgIGlzIGNhbGxlZCB3aGVuIHRoZSB1c2VyIHNjcm9sbHMKICogZ3JlYXRlciB0aGFuIGBkaXN0YW5jZWAgYXdheSBmcm9tIHRoZSBib3R0b20gb2YgdGhlIGNvbnRlbnQuICBPbmNlIGBvbi1pbmZpbml0ZWAKICogaXMgZG9uZSBsb2FkaW5nIG5ldyBkYXRhLCBpdCBzaG91bGQgYnJvYWRjYXN0IHRoZSBgc2Nyb2xsLmluZmluaXRlU2Nyb2xsQ29tcGxldGVgCiAqIGV2ZW50IGZyb20geW91ciBjb250cm9sbGVyIChzZWUgYmVsb3cgZXhhbXBsZSkuCiAqCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gb24taW5maW5pdGUgV2hhdCB0byBjYWxsIHdoZW4gdGhlIHNjcm9sbGVyIHJlYWNoZXMgdGhlCiAqIGJvdHRvbS4KICogQHBhcmFtIHtzdHJpbmc9fSBkaXN0YW5jZSBUaGUgZGlzdGFuY2UgZnJvbSB0aGUgYm90dG9tIHRoYXQgdGhlIHNjcm9sbCBtdXN0CiAqIHJlYWNoIHRvIHRyaWdnZXIgdGhlIG9uLWluZmluaXRlIGV4cHJlc3Npb24uIERlZmF1bHQ6IDElLgogKiBAcGFyYW0ge3N0cmluZz19IGljb24gVGhlIGljb24gdG8gc2hvdyB3aGlsZSBsb2FkaW5nLiBEZWZhdWx0OiAnaW9uLWxvYWRpbmctZCcuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxpb24tY29udGVudCBuZy1jb250cm9sbGVyPSJNeUNvbnRyb2xsZXIiPgogKiAgIDxpb24tbGlzdD4KICogICAuLi4uCiAqICAgLi4uLgogKiAgIDwvaW9uLWxpc3Q+CiAqCiAqICAgPGlvbi1pbmZpbml0ZS1zY3JvbGwKICogICAgIG9uLWluZmluaXRlPSJsb2FkTW9yZSgpIgogKiAgICAgZGlzdGFuY2U9IjElIj4KICogICA8L2lvbi1pbmZpbml0ZS1zY3JvbGw+CiAqIDwvaW9uLWNvbnRlbnQ+CiAqIGBgYAogKiBgYGBqcwogKiBmdW5jdGlvbiBNeUNvbnRyb2xsZXIoJHNjb3BlLCAkaHR0cCkgewogKiAgICRzY29wZS5pdGVtcyA9IFtdOwogKiAgICRzY29wZS5sb2FkTW9yZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGh0dHAuZ2V0KCcvbW9yZS1pdGVtcycpLnN1Y2Nlc3MoZnVuY3Rpb24oaXRlbXMpIHsKICogICAgICAgdXNlSXRlbXMoaXRlbXMpOwogKiAgICAgICAkc2NvcGUuJGJyb2FkY2FzdCgnc2Nyb2xsLmluZmluaXRlU2Nyb2xsQ29tcGxldGUnKTsKICogICAgIH0pOwogKiAgIH07CiAqCiAqICAgJHNjb3BlLiRvbignc3RhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24oKSB7CiAqICAgICAkc2NvcGUubG9hZE1vcmUoKTsKICogICB9KTsKICogfQogKiBgYGAKICoKICogQW4gZWFzeSB0byB3YXkgdG8gc3RvcCBpbmZpbml0ZSBzY3JvbGwgb25jZSB0aGVyZSBpcyBubyBtb3JlIGRhdGEgdG8gbG9hZAogKiBpcyB0byB1c2UgYW5ndWxhcidzIGBuZy1pZmAgZGlyZWN0aXZlOgogKgogKiBgYGBodG1sCiAqIDxpb24taW5maW5pdGUtc2Nyb2xsCiAqICAgbmctaWY9Im1vcmVEYXRhQ2FuQmVMb2FkZWQoKSIKICogICBpY29uPSJpb24tbG9hZGluZy1jIgogKiAgIG9uLWluZmluaXRlPSJsb2FkTW9yZURhdGEoKSI+CiAqIDwvaW9uLWluZmluaXRlLXNjcm9sbD4KICogYGBgCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25JbmZpbml0ZVNjcm9sbCcsIFsnJHRpbWVvdXQnLCBmdW5jdGlvbigkdGltZW91dCkgewogIGZ1bmN0aW9uIGNhbGN1bGF0ZU1heFZhbHVlKGRpc3RhbmNlLCBtYXhpbXVtLCBpc1BlcmNlbnQpIHsKICAgIHJldHVybiBpc1BlcmNlbnQgPwogICAgICBtYXhpbXVtICogKDEgLSBwYXJzZUZsb2F0KGRpc3RhbmNlLDEwKSAvIDEwMCkgOgogICAgICBtYXhpbXVtIC0gcGFyc2VGbG9hdChkaXN0YW5jZSwgMTApOwogIH0KICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6IFsnXiRpb25pY1Njcm9sbCcsICdpb25JbmZpbml0ZVNjcm9sbCddLAogICAgdGVtcGxhdGU6ICc8aSBjbGFzcz0iaWNvbiB7e2ljb24oKX19IGljb24tcmVmcmVzaGluZyI+PC9pPicsCiAgICBzY29wZTogdHJ1ZSwKICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uKCRzY29wZSwgJGF0dHJzKSB7CiAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuc2Nyb2xsVmlldyA9IG51bGw7IC8vZ2l2ZW4gYnkgbGluayBmdW5jdGlvbgogICAgICB0aGlzLmdldE1heFNjcm9sbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkaXN0YW5jZSA9ICgkYXR0cnMuZGlzdGFuY2UgfHwgJzIuNSUnKS50cmltKCk7CiAgICAgICAgdmFyIGlzUGVyY2VudCA9IGRpc3RhbmNlLmluZGV4T2YoJyUnKSAhPT0gLTE7CiAgICAgICAgdmFyIG1heFZhbHVlcyA9IHRoaXMuc2Nyb2xsVmlldy5nZXRTY3JvbGxNYXgoKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVmdDogdGhpcy5zY3JvbGxWaWV3Lm9wdGlvbnMuc2Nyb2xsaW5nWCA/CiAgICAgICAgICAgIGNhbGN1bGF0ZU1heFZhbHVlKGRpc3RhbmNlLCBtYXhWYWx1ZXMubGVmdCwgaXNQZXJjZW50KSA6CiAgICAgICAgICAgIC0xLAogICAgICAgICAgdG9wOiB0aGlzLnNjcm9sbFZpZXcub3B0aW9ucy5zY3JvbGxpbmdZID8KICAgICAgICAgICAgY2FsY3VsYXRlTWF4VmFsdWUoZGlzdGFuY2UsIG1heFZhbHVlcy50b3AsIGlzUGVyY2VudCkgOgogICAgICAgICAgICAtMQogICAgICAgIH07CiAgICAgIH07CiAgICB9XSwKICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgY3RybHMpIHsKICAgICAgdmFyIHNjcm9sbEN0cmwgPSBjdHJsc1swXTsKICAgICAgdmFyIGluZmluaXRlU2Nyb2xsQ3RybCA9IGN0cmxzWzFdOwogICAgICB2YXIgc2Nyb2xsVmlldyA9IGluZmluaXRlU2Nyb2xsQ3RybC5zY3JvbGxWaWV3ID0gc2Nyb2xsQ3RybC5zY3JvbGxWaWV3OwoKICAgICAgJHNjb3BlLmljb24gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYW5ndWxhci5pc0RlZmluZWQoJGF0dHJzLmljb24pID8gJGF0dHJzLmljb24gOiAnaW9uLWxvYWRpbmctZCc7CiAgICAgIH07CgogICAgICB2YXIgb25JbmZpbml0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICRlbGVtZW50WzBdLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgIGluZmluaXRlU2Nyb2xsQ3RybC5pc0xvYWRpbmcgPSB0cnVlOwogICAgICAgICRzY29wZS4kcGFyZW50ICYmICRzY29wZS4kcGFyZW50LiRhcHBseSgkYXR0cnMub25JbmZpbml0ZSB8fCAnJyk7CiAgICAgIH07CgogICAgICB2YXIgZmluaXNoSW5maW5pdGVTY3JvbGwgPSBmdW5jdGlvbigpIHsKICAgICAgICAkZWxlbWVudFswXS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIHNjcm9sbFZpZXcucmVzaXplKCk7CiAgICAgICAgICBjaGVja0JvdW5kcygpOwogICAgICAgIH0sIDAsIGZhbHNlKTsKICAgICAgICBpbmZpbml0ZVNjcm9sbEN0cmwuaXNMb2FkaW5nID0gZmFsc2U7CiAgICAgIH07CgogICAgICAkc2NvcGUuJG9uKCdzY3JvbGwuaW5maW5pdGVTY3JvbGxDb21wbGV0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGZpbmlzaEluZmluaXRlU2Nyb2xsKCk7CiAgICAgIH0pOwoKICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICBzY3JvbGxDdHJsLiRlbGVtZW50Lm9mZignc2Nyb2xsJywgY2hlY2tCb3VuZHMpOwogICAgICB9KTsKCiAgICAgIHZhciBjaGVja0JvdW5kcyA9IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoY2hlY2tJbmZpbml0ZUJvdW5kcyk7CgogICAgICAvL0NoZWNrIGJvdW5kcyBvbiBzdGFydCwgYWZ0ZXIgc2Nyb2xsVmlldyBpcyBmdWxseSByZW5kZXJlZAogICAgICBzZXRUaW1lb3V0KGNoZWNrQm91bmRzKTsKICAgICAgc2Nyb2xsQ3RybC4kZWxlbWVudC5vbignc2Nyb2xsJywgY2hlY2tCb3VuZHMpOwoKICAgICAgZnVuY3Rpb24gY2hlY2tJbmZpbml0ZUJvdW5kcygpIHsKICAgICAgICBpZiAoaW5maW5pdGVTY3JvbGxDdHJsLmlzTG9hZGluZykgcmV0dXJuOwoKICAgICAgICB2YXIgc2Nyb2xsVmFsdWVzID0gc2Nyb2xsVmlldy5nZXRWYWx1ZXMoKTsKICAgICAgICB2YXIgbWF4U2Nyb2xsID0gaW5maW5pdGVTY3JvbGxDdHJsLmdldE1heFNjcm9sbCgpOwoKICAgICAgICBpZiAoKG1heFNjcm9sbC5sZWZ0ICE9PSAtMSAmJiBzY3JvbGxWYWx1ZXMubGVmdCA+PSBtYXhTY3JvbGwubGVmdCkgfHwKICAgICAgICAgICAgKG1heFNjcm9sbC50b3AgIT09IC0xICYmIHNjcm9sbFZhbHVlcy50b3AgPj0gbWF4U2Nyb2xsLnRvcCkpIHsKICAgICAgICAgIG9uSW5maW5pdGUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Owp9XSk7Cgp2YXIgSVRFTV9UUExfQ09OVEVOVF9BTkNIT1IgPQogICc8YSBjbGFzcz0iaXRlbS1jb250ZW50IiBuZy1ocmVmPSJ7eyRocmVmKCl9fSIgdGFyZ2V0PSJ7eyR0YXJnZXQoKX19Ij48L2E+JzsKdmFyIElURU1fVFBMX0NPTlRFTlQgPQogICc8ZGl2IGNsYXNzPSJpdGVtLWNvbnRlbnQiPjwvZGl2Pic7Ci8qKgoqIEBuZ2RvYyBkaXJlY3RpdmUKKiBAbmFtZSBpb25JdGVtCiogQHBhcmVudCBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdAoqIEBtb2R1bGUgaW9uaWMKKiBAcmVzdHJpY3QgRQoqIENyZWF0ZXMgYSBsaXN0LWl0ZW0gdGhhdCBjYW4gZWFzaWx5IGJlIHN3aXBlZCwKKiBkZWxldGVkLCByZW9yZGVyZWQsIGVkaXRlZCwgYW5kIG1vcmUuCioKKiBTZWUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0fSBmb3IgYSBjb21wbGV0ZSBleGFtcGxlICYgZXhwbGFuYXRpb24uCioKKiBDYW4gYmUgYXNzaWduZWQgYW55IGl0ZW0gY2xhc3MgbmFtZS4gU2VlIHRoZQoqIFtsaXN0IENTUyBkb2N1bWVudGF0aW9uXSgvZG9jcy9jb21wb25lbnRzLyNsaXN0KS4KKgoqIEB1c2FnZQoqCiogYGBgaHRtbAoqIDxpb24tbGlzdD4KKiAgIDxpb24taXRlbT5IZWxsbyE8L2lvbi1pdGVtPgoqICAgPGlvbi1pdGVtIGhyZWY9IiMvZGV0YWlsIj4KKiAgICAgTGluayB0byBkZXRhaWwgcGFnZQoqICAgPGlvbi1pdGVtPgoqIDwvaW9uLWxpc3Q+CiogYGBgCiovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbkl0ZW0nLCBbCiAgJyRhbmltYXRlJywKICAnJGNvbXBpbGUnLApmdW5jdGlvbigkYW5pbWF0ZSwgJGNvbXBpbGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICB0aGlzLiRzY29wZSA9ICRzY29wZTsKICAgICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50OwogICAgfV0sCiAgICBzY29wZTogdHJ1ZSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgdmFyIGlzQW5jaG9yID0gYW5ndWxhci5pc0RlZmluZWQoJGF0dHJzLmhyZWYpIHx8CiAgICAgICAgYW5ndWxhci5pc0RlZmluZWQoJGF0dHJzLm5nSHJlZikgfHwKICAgICAgICBhbmd1bGFyLmlzRGVmaW5lZCgkYXR0cnMudWlTcmVmKTsKICAgICAgdmFyIGlzQ29tcGxleEl0ZW0gPSBpc0FuY2hvciB8fAogICAgICAgIC8vTGFtZSB3YXkgb2YgdGVzdGluZywgYnV0IHdlIGhhdmUgdG8ga25vdyBhdCBjb21waWxlIHdoYXQgdG8gZG8gd2l0aCB0aGUgZWxlbWVudAogICAgICAgIC9pb24tKGRlbGV0ZXxvcHRpb258cmVvcmRlciktYnV0dG9uL2kudGVzdCgkZWxlbWVudC5odG1sKCkpOwoKICAgICAgICBpZiAoaXNDb21wbGV4SXRlbSkgewogICAgICAgICAgdmFyIGlubmVyRWxlbWVudCA9IGpxTGl0ZShpc0FuY2hvciA/IElURU1fVFBMX0NPTlRFTlRfQU5DSE9SIDogSVRFTV9UUExfQ09OVEVOVCk7CiAgICAgICAgICBpbm5lckVsZW1lbnQuYXBwZW5kKCRlbGVtZW50LmNvbnRlbnRzKCkpOwoKICAgICAgICAgICRlbGVtZW50LmFwcGVuZChpbm5lckVsZW1lbnQpOwogICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoJ2l0ZW0gaXRlbS1jb21wbGV4Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKCdpdGVtJyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgICAgICRzY29wZS4kaHJlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gJGF0dHJzLmhyZWYgfHwgJGF0dHJzLm5nSHJlZjsKICAgICAgICAgIH07CiAgICAgICAgICAkc2NvcGUuJHRhcmdldCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gJGF0dHJzLnRhcmdldCB8fCAnX3NlbGYnOwogICAgICAgICAgfTsKICAgICAgICB9OwogICAgfQogIH07Cn1dKTsKCnZhciBJVEVNX1RQTF9ERUxFVEVfQlVUVE9OID0KICAnPGRpdiBjbGFzcz0iaXRlbS1sZWZ0LWVkaXQgaXRlbS1kZWxldGUgZW5hYmxlLXBvaW50ZXItZXZlbnRzIj4nICsKICAnPC9kaXY+JzsKLyoqCiogQG5nZG9jIGRpcmVjdGl2ZQoqIEBuYW1lIGlvbkRlbGV0ZUJ1dHRvbgoqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkl0ZW0KKiBAbW9kdWxlIGlvbmljCiogQHJlc3RyaWN0IEUKKiBDcmVhdGVzIGEgZGVsZXRlIGJ1dHRvbiBpbnNpZGUgYSBsaXN0IGl0ZW0sIHRoYXQgaXMgdmlzaWJsZSB3aGVuIHRoZQoqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdCBpb25MaXN0IHBhcmVudCdzfSBgc2hvdy1kZWxldGVgIGV2YWx1YXRlcyB0byB0cnVlIG9yCiogYCRpb25pY0xpc3REZWxlZ2F0ZS5zaG93RGVsZXRlKHRydWUpYCBpcyBjYWxsZWQuCioKKiBUYWtlcyBhbnkgaW9uaWNvbiBhcyBhIGNsYXNzLgoqCiogU2VlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdH0gZm9yIGEgY29tcGxldGUgZXhhbXBsZSAmIGV4cGxhbmF0aW9uLgoqCiogQHVzYWdlCioKKiBgYGBodG1sCiogPGlvbi1saXN0IHNob3ctZGVsZXRlPSJzaG91bGRTaG93RGVsZXRlIj4KKiAgIDxpb24taXRlbT4KKiAgICAgPGlvbi1kZWxldGUtYnV0dG9uIGNsYXNzPSJpb24tbWludXMtY2lyY2xlZCI+PC9pb24tZGVsZXRlLWJ1dHRvbj4KKiAgICAgSGVsbG8sIGxpc3QgaXRlbSEKKiAgIDwvaW9uLWl0ZW0+CiogPC9pb24tbGlzdD4KKiA8aW9uLXRvZ2dsZSBuZy1tb2RlbD0ic2hvdWxkU2hvd0RlbGV0ZSI+CiogICBTaG93IERlbGV0ZT8KKiA8L2lvbi10b2dnbGU+CiogYGBgCiovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbkRlbGV0ZUJ1dHRvbicsIFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVxdWlyZTogWydeaW9uSXRlbScsICdeP2lvbkxpc3QnXSwKICAgIC8vUnVuIGJlZm9yZSBhbnl0aGluZyBlbHNlLCBzbyB3ZSBjYW4gbW92ZSBpdCBiZWZvcmUgb3RoZXIgZGlyZWN0aXZlcyBwcm9jZXNzCiAgICAvL2l0cyBsb2NhdGlvbiAoZWcgbmdJZiByZWxpZXMgb24gdGhlIGxvY2F0aW9uIG9mIHRoZSBkaXJlY3RpdmUgaW4gdGhlIGRvbSkKICAgIHByaW9yaXR5OiBOdW1iZXIuTUFYX1ZBTFVFLAogICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgIC8vQWRkIHRoZSBjbGFzc2VzIHdlIG5lZWQgZHVyaW5nIHRoZSBjb21waWxlIHBoYXNlLCBzbyB0aGF0IHRoZXkgc3RheQogICAgICAvL2V2ZW4gaWYgc29tZXRoaW5nIGVsc2UgbGlrZSBuZ0lmIHJlbW92ZXMgdGhlIGVsZW1lbnQgYW5kIHJlLWFkZHNzIGl0CiAgICAgICRhdHRyLiRzZXQoJ2NsYXNzJywgKCRhdHRyWydjbGFzcyddIHx8ICcnKSArICcgYnV0dG9uIGljb24gYnV0dG9uLWljb24nLCB0cnVlKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJscykgewogICAgICAgIHZhciBpdGVtQ3RybCA9IGN0cmxzWzBdOwogICAgICAgIHZhciBsaXN0Q3RybCA9IGN0cmxzWzFdOwogICAgICAgIHZhciBjb250YWluZXIgPSBqcUxpdGUoSVRFTV9UUExfREVMRVRFX0JVVFRPTik7CiAgICAgICAgY29udGFpbmVyLmFwcGVuZCgkZWxlbWVudCk7CiAgICAgICAgaXRlbUN0cmwuJGVsZW1lbnQuYXBwZW5kKGNvbnRhaW5lcikuYWRkQ2xhc3MoJ2l0ZW0tbGVmdC1lZGl0YWJsZScpOwoKICAgICAgICBpZiAobGlzdEN0cmwgJiYgbGlzdEN0cmwuc2hvd0RlbGV0ZSgpKSB7CiAgICAgICAgICBjb250YWluZXIuYWRkQ2xhc3MoJ3Zpc2libGUgYWN0aXZlJyk7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH07Cn1dKTsKCgpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpdGVtRmxvYXRpbmdMYWJlbCcsIGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0MnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgdmFyIGVsID0gZWxlbWVudFswXTsKICAgICAgdmFyIGlucHV0ID0gZWwucXVlcnlTZWxlY3RvcignaW5wdXQsIHRleHRhcmVhJyk7CiAgICAgIHZhciBpbnB1dExhYmVsID0gZWwucXVlcnlTZWxlY3RvcignLmlucHV0LWxhYmVsJyk7CgogICAgICBpZiAoICFpbnB1dCB8fCAhaW5wdXRMYWJlbCApIHJldHVybjsKCiAgICAgIHZhciBvbklucHV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCBpbnB1dC52YWx1ZSApIHsKICAgICAgICAgIGlucHV0TGFiZWwuY2xhc3NMaXN0LmFkZCgnaGFzLWlucHV0Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlucHV0TGFiZWwuY2xhc3NMaXN0LnJlbW92ZSgnaGFzLWlucHV0Jyk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBvbklucHV0KTsKCiAgICAgIHZhciBuZ01vZGVsQ3RybCA9IGFuZ3VsYXIuZWxlbWVudChpbnB1dCkuY29udHJvbGxlcignbmdNb2RlbCcpOwogICAgICBpZiAoIG5nTW9kZWxDdHJsICkgewogICAgICAgIG5nTW9kZWxDdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0LnZhbHVlID0gbmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSB8fCAnJzsKICAgICAgICAgIG9uSW5wdXQoKTsKICAgICAgICB9OwogICAgICB9CgogICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgaW5wdXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBvbklucHV0KTsKICAgICAgfSk7CiAgICB9CiAgfTsKfSk7Cgp2YXIgSVRFTV9UUExfT1BUSU9OX0JVVFRPTlMgPQogICc8ZGl2IGNsYXNzPSJpdGVtLW9wdGlvbnMgaW52aXNpYmxlIj4nICsKICAnPC9kaXY+JzsKLyoqCiogQG5nZG9jIGRpcmVjdGl2ZQoqIEBuYW1lIGlvbk9wdGlvbkJ1dHRvbgoqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkl0ZW0KKiBAbW9kdWxlIGlvbmljCiogQHJlc3RyaWN0IEUKKiBDcmVhdGVzIGFuIG9wdGlvbiBidXR0b24gaW5zaWRlIGEgbGlzdCBpdGVtLCB0aGF0IGlzIHZpc2libGUgd2hlbiB0aGUgaXRlbSBpcyBzd2lwZWQKKiB0byB0aGUgbGVmdCBieSB0aGUgdXNlci4gIFN3aXBlZCBvcGVuIG9wdGlvbiBidXR0b25zIGNhbiBiZSBoaWRkZW4gd2l0aAoqIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY0xpc3REZWxlZ2F0ZSNjbG9zZU9wdGlvbkJ1dHRvbnMgJGlvbmljTGlzdERlbGVnYXRlI2Nsb3NlT3B0aW9uQnV0dG9uc30uCioKKiBDYW4gYmUgYXNzaWduZWQgYW55IGJ1dHRvbiBjbGFzcy4KKgoqIFNlZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3R9IGZvciBhIGNvbXBsZXRlIGV4YW1wbGUgJiBleHBsYW5hdGlvbi4KKgoqIEB1c2FnZQoqCiogYGBgaHRtbAoqIDxpb24tbGlzdD4KKiAgIDxpb24taXRlbT4KKiAgICAgSSBsb3ZlIGtpdHRlbnMhCiogICAgIDxpb24tb3B0aW9uLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLXBvc2l0aXZlIj5TaGFyZTwvaW9uLW9wdGlvbi1idXR0b24+CiogICAgIDxpb24tb3B0aW9uLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLWFzc2VydGl2ZSI+RWRpdDwvaW9uLW9wdGlvbi1idXR0b24+CiogICA8L2lvbi1pdGVtPgoqIDwvaW9uLWxpc3Q+CiogYGBgCiovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbk9wdGlvbkJ1dHRvbicsIFsnJGNvbXBpbGUnLCBmdW5jdGlvbigkY29tcGlsZSkgewogIGZ1bmN0aW9uIHN0b3BQcm9wYWdhdGlvbihlKSB7CiAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogIH0KICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6ICdeaW9uSXRlbScsCiAgICBwcmlvcml0eTogTnVtYmVyLk1BWF9WQUxVRSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cikgewogICAgICAkYXR0ci4kc2V0KCdjbGFzcycsICgkYXR0clsnY2xhc3MnXSB8fCAnJykgKyAnIGJ1dHRvbicsIHRydWUpOwogICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGl0ZW1DdHJsKSB7CiAgICAgICAgaWYgKCFpdGVtQ3RybC5vcHRpb25zQ29udGFpbmVyKSB7CiAgICAgICAgICBpdGVtQ3RybC5vcHRpb25zQ29udGFpbmVyID0ganFMaXRlKElURU1fVFBMX09QVElPTl9CVVRUT05TKTsKICAgICAgICAgIGl0ZW1DdHJsLiRlbGVtZW50LmFwcGVuZChpdGVtQ3RybC5vcHRpb25zQ29udGFpbmVyKTsKICAgICAgICB9CiAgICAgICAgaXRlbUN0cmwub3B0aW9uc0NvbnRhaW5lci5hcHBlbmQoJGVsZW1lbnQpOwoKICAgICAgICAvL0Rvbid0IGJ1YmJsZSBjbGljayB1cCB0byBtYWluIC5pdGVtCiAgICAgICAgJGVsZW1lbnQub24oJ2NsaWNrJywgc3RvcFByb3BhZ2F0aW9uKTsKICAgICAgfTsKICAgIH0KICB9Owp9XSk7Cgp2YXIgSVRFTV9UUExfUkVPUkRFUl9CVVRUT04gPQogICc8ZGl2IGRhdGEtcHJldmVudC1zY3JvbGw9InRydWUiIGNsYXNzPSJpdGVtLXJpZ2h0LWVkaXQgaXRlbS1yZW9yZGVyIGVuYWJsZS1wb2ludGVyLWV2ZW50cyI+JyArCiAgJzwvZGl2Pic7CgovKioKKiBAbmdkb2MgZGlyZWN0aXZlCiogQG5hbWUgaW9uUmVvcmRlckJ1dHRvbgoqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkl0ZW0KKiBAbW9kdWxlIGlvbmljCiogQHJlc3RyaWN0IEUKKiBDcmVhdGVzIGEgcmVvcmRlciBidXR0b24gaW5zaWRlIGEgbGlzdCBpdGVtLCB0aGF0IGlzIHZpc2libGUgd2hlbiB0aGUKKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3QgaW9uTGlzdCBwYXJlbnQnc30gYHNob3ctcmVvcmRlcmAgZXZhbHVhdGVzIHRvIHRydWUgb3IKKiBgJGlvbmljTGlzdERlbGVnYXRlLnNob3dSZW9yZGVyKHRydWUpYCBpcyBjYWxsZWQuCioKKiBDYW4gYmUgZHJhZ2dlZCB0byByZW9yZGVyIGl0ZW1zIGluIHRoZSBsaXN0LiBUYWtlcyBhbnkgaW9uaWNvbiBjbGFzcy4KKgoqIE5vdGU6IFJlb3JkZXJpbmcgd29ya3MgYmVzdCB3aGVuIHVzZWQgd2l0aCBgbmctcmVwZWF0YC4gIEJlIHN1cmUgdGhhdCBhbGwgYGlvbi1pdGVtYCBjaGlsZHJlbiBvZiBhbiBgaW9uLWxpc3RgIGFyZSBwYXJ0IG9mIHRoZSBzYW1lIGBuZy1yZXBlYXRgIGV4cHJlc3Npb24uCioKKiBXaGVuIGFuIGl0ZW0gcmVvcmRlciBpcyBjb21wbGV0ZSwgdGhlIGV4cHJlc3Npb24gZ2l2ZW4gaW4gdGhlIGBvbi1yZW9yZGVyYCBhdHRyaWJ1dGUgaXMgY2FsbGVkLiBUaGUgYG9uLXJlb3JkZXJgIGV4cHJlc3Npb24gaXMgZ2l2ZW4gdHdvIGxvY2FscyB0aGF0IGNhbiBiZSB1c2VkOiBgJGZyb21JbmRleGAgYW5kIGAkdG9JbmRleGAuICBTZWUgYmVsb3cgZm9yIGFuIGV4YW1wbGUuCioKKiBMb29rIGF0IHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdH0gZm9yIG1vcmUgZXhhbXBsZXMuCioKKiBAdXNhZ2UKKgoqIGBgYGh0bWwKKiA8aW9uLWxpc3QgbmctY29udHJvbGxlcj0iTXlDdHJsIiBzaG93LXJlb3JkZXI9InRydWUiPgoqICAgPGlvbi1pdGVtIG5nLXJlcGVhdD0iaXRlbSBpbiBpdGVtcyI+CiogICAgIEl0ZW0ge3tpdGVtfX0KKiAgICAgPGlvbi1yZW9yZGVyLWJ1dHRvbiBjbGFzcz0iaW9uLW5hdmljb24iCiogICAgICAgICAgICAgICAgICAgICAgICAgb24tcmVvcmRlcj0ibW92ZUl0ZW0oaXRlbSwgJGZyb21JbmRleCwgJHRvSW5kZXgpIj4KKiAgICAgPC9pb24tcmVvcmRlci1idXR0b24+CiogICA8L2lvbi1pdGVtPgoqIDwvaW9uLWxpc3Q+CiogYGBgCiogYGBganMKKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlKSB7CiogICAkc2NvcGUuaXRlbXMgPSBbMSwgMiwgMywgNF07CiogICAkc2NvcGUubW92ZUl0ZW0gPSBmdW5jdGlvbihpdGVtLCBmcm9tSW5kZXgsIHRvSW5kZXgpIHsKKiAgICAgLy9Nb3ZlIHRoZSBpdGVtIGluIHRoZSBhcnJheQoqICAgICAkc2NvcGUuaXRlbXMuc3BsaWNlKGZyb21JbmRleCwgMSk7CiogICAgICRzY29wZS5pdGVtcy5zcGxpY2UodG9JbmRleCwgMCwgaXRlbSk7CiogICB9OwoqIH0KKiBgYGAKKgoqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXJlb3JkZXIgRXhwcmVzc2lvbiB0byBjYWxsIHdoZW4gYW4gaXRlbSBpcyByZW9yZGVyZWQuCiogUGFyYW1ldGVycyBnaXZlbjogJGZyb21JbmRleCwgJHRvSW5kZXguCiovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblJlb3JkZXJCdXR0b24nLCBbJyRhbmltYXRlJywgJyRwYXJzZScsIGZ1bmN0aW9uKCRhbmltYXRlLCAkcGFyc2UpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6IFsnXmlvbkl0ZW0nLCAnXj9pb25MaXN0J10sCiAgICBwcmlvcml0eTogTnVtYmVyLk1BWF9WQUxVRSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cikgewogICAgICAkYXR0ci4kc2V0KCdjbGFzcycsICgkYXR0clsnY2xhc3MnXSB8fCAnJykgKyAnIGJ1dHRvbiBpY29uIGJ1dHRvbi1pY29uJywgdHJ1ZSk7CiAgICAgICRlbGVtZW50WzBdLnNldEF0dHJpYnV0ZSgnZGF0YS1wcmV2ZW50LXNjcm9sbCcsIHRydWUpOwogICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmxzKSB7CiAgICAgICAgdmFyIGl0ZW1DdHJsID0gY3RybHNbMF07CiAgICAgICAgdmFyIGxpc3RDdHJsID0gY3RybHNbMV07CiAgICAgICAgdmFyIG9uUmVvcmRlckZuID0gJHBhcnNlKCRhdHRyLm9uUmVvcmRlcik7CgogICAgICAgICRzY29wZS4kb25SZW9yZGVyID0gZnVuY3Rpb24ob2xkSW5kZXgsIG5ld0luZGV4KSB7CiAgICAgICAgICBvblJlb3JkZXJGbigkc2NvcGUsIHsKICAgICAgICAgICAgJGZyb21JbmRleDogb2xkSW5kZXgsCiAgICAgICAgICAgICR0b0luZGV4OiBuZXdJbmRleAogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gcHJldmVudCBjbGlja3MgZnJvbSBidWJibGluZyB1cCB0byB0aGUgaXRlbQogICAgICAgIGlmKCEkYXR0ci5uZ0NsaWNrICYmICEkYXR0ci5vbkNsaWNrICYmICEkYXR0ci5vbmNsaWNrKXsKICAgICAgICAgICRlbGVtZW50WzBdLm9uY2xpY2sgPSBmdW5jdGlvbihlKXtlLnN0b3BQcm9wYWdhdGlvbigpOyByZXR1cm4gZmFsc2U7fTsKICAgICAgICB9CgogICAgICAgIHZhciBjb250YWluZXIgPSBqcUxpdGUoSVRFTV9UUExfUkVPUkRFUl9CVVRUT04pOwogICAgICAgIGNvbnRhaW5lci5hcHBlbmQoJGVsZW1lbnQpOwogICAgICAgIGl0ZW1DdHJsLiRlbGVtZW50LmFwcGVuZChjb250YWluZXIpLmFkZENsYXNzKCdpdGVtLXJpZ2h0LWVkaXRhYmxlJyk7CgogICAgICAgIGlmIChsaXN0Q3RybCAmJiBsaXN0Q3RybC5zaG93UmVvcmRlcigpKSB7CiAgICAgICAgICBjb250YWluZXIuYWRkQ2xhc3MoJ3Zpc2libGUgYWN0aXZlJyk7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH07Cn1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGtleWJvYXJkQXR0YWNoCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEEKICoKICogQGRlc2NyaXB0aW9uCiAqIGtleWJvYXJkLWF0dGFjaCBpcyBhbiBhdHRyaWJ1dGUgZGlyZWN0aXZlIHdoaWNoIHdpbGwgY2F1c2UgYW4gZWxlbWVudCB0byBmbG9hdCBhYm92ZQogKiB0aGUga2V5Ym9hcmQgd2hlbiB0aGUga2V5Ym9hcmQgc2hvd3MuIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRzIHRoZQogKiBbaW9uLWZvb3Rlci1iYXJdKHt7IHBhZ2UudmVyc2lvbkhyZWYgfX0vYXBpL2RpcmVjdGl2ZS9pb25Gb290ZXJCYXIvKSBkaXJlY3RpdmUuCiAqCiAqICMjIyBOb3RlcwogKiAtIFRoaXMgZGlyZWN0aXZlIHJlcXVpcmVzIHRoZQogKiBbSW9uaWMgS2V5Ym9hcmQgUGx1Z2luXShodHRwczovL2dpdGh1Yi5jb20vZHJpZnR5Y28vaW9uaWMtcGx1Z2lucy1rZXlib2FyZCkuCiAqIC0gT24gQW5kcm9pZCBub3QgaW4gZnVsbHNjcmVlbiBtb2RlLCBpLmUuIHlvdSBoYXZlCiAqICAgYDxwcmVmZXJlbmNlIG5hbWU9IkZ1bGxzY3JlZW4iIHZhbHVlPSJmYWxzZSIgLz5gIG9yIG5vIHByZWZlcmVuY2UgaW4geW91ciBgY29uZmlnLnhtbGAgZmlsZSwKICogICB0aGlzIGRpcmVjdGl2ZSBpcyB1bm5lY2Vzc2FyeSBzaW5jZSBpdCBpcyB0aGUgZGVmYXVsdCBiZWhhdmlvci4KICogLSBPbiBpT1MsIGlmIHRoZXJlIGlzIGFuIGlucHV0IGluIHlvdXIgZm9vdGVyLCB5b3Ugd2lsbCBuZWVkIHRvIHNldAogKiAgIGBjb3Jkb3ZhLnBsdWdpbnMuS2V5Ym9hcmQuZGlzYWJsZVNjcm9sbCh0cnVlKWAuCiAqCiAqIEB1c2FnZQogKgogKiBgYGBodG1sCiAqICA8aW9uLWZvb3Rlci1iYXIgYWxpZ24tdGl0bGU9ImxlZnQiIGtleWJvYXJkLWF0dGFjaCBjbGFzcz0iYmFyLWFzc2VydGl2ZSI+CiAqICAgIDxoMSBjbGFzcz0idGl0bGUiPlRpdGxlITwvaDE+CiAqICA8L2lvbi1mb290ZXItYmFyPgogKiBgYGAKICovCgpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdrZXlib2FyZEF0dGFjaCcsIGZ1bmN0aW9uKCkgewogIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgIGlvbmljLm9uKCduYXRpdmUua2V5Ym9hcmRzaG93Jywgb25TaG93LCB3aW5kb3cpOwogICAgaW9uaWMub24oJ25hdGl2ZS5rZXlib2FyZGhpZGUnLCBvbkhpZGUsIHdpbmRvdyk7CgogICAgLy9kZXByZWNhdGVkCiAgICBpb25pYy5vbignbmF0aXZlLnNob3drZXlib2FyZCcsIG9uU2hvdywgd2luZG93KTsKICAgIGlvbmljLm9uKCduYXRpdmUuaGlkZWtleWJvYXJkJywgb25IaWRlLCB3aW5kb3cpOwoKCiAgICB2YXIgc2Nyb2xsQ3RybDsKCiAgICBmdW5jdGlvbiBvblNob3coZSkgewogICAgICBpZiAoaW9uaWMuUGxhdGZvcm0uaXNBbmRyb2lkKCkgJiYgIWlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy9mb3IgdGVzdGluZwogICAgICB2YXIga2V5Ym9hcmRIZWlnaHQgPSBlLmtleWJvYXJkSGVpZ2h0IHx8IGUuZGV0YWlsLmtleWJvYXJkSGVpZ2h0OwogICAgICBlbGVtZW50LmNzcygnYm90dG9tJywga2V5Ym9hcmRIZWlnaHQgKyAicHgiKTsKICAgICAgc2Nyb2xsQ3RybCA9IGVsZW1lbnQuY29udHJvbGxlcignJGlvbmljU2Nyb2xsJyk7CiAgICAgIGlmICggc2Nyb2xsQ3RybCApIHsKICAgICAgICBzY3JvbGxDdHJsLnNjcm9sbFZpZXcuX19jb250YWluZXIuc3R5bGUuYm90dG9tID0ga2V5Ym9hcmRIZWlnaHQgKyBrZXlib2FyZEF0dGFjaEdldENsaWVudEhlaWdodChlbGVtZW50WzBdKSArICJweCI7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbkhpZGUoKSB7CiAgICAgIGlmIChpb25pYy5QbGF0Zm9ybS5pc0FuZHJvaWQoKSAmJiAhaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBlbGVtZW50LmNzcygnYm90dG9tJywgJycpOwogICAgICBpZiAoIHNjcm9sbEN0cmwgKSB7CiAgICAgICAgc2Nyb2xsQ3RybC5zY3JvbGxWaWV3Ll9fY29udGFpbmVyLnN0eWxlLmJvdHRvbSA9ICcnOwogICAgICB9CiAgICB9CgogICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICBpb25pYy5vZmYoJ25hdGl2ZS5rZXlib2FyZHNob3cnLCBvblNob3csIHdpbmRvdyk7CiAgICAgIGlvbmljLm9mZignbmF0aXZlLmtleWJvYXJkaGlkZScsIG9uSGlkZSwgd2luZG93KTsKCiAgICAgIC8vZGVwcmVjYXRlZAogICAgICBpb25pYy5vZmYoJ25hdGl2ZS5zaG93a2V5Ym9hcmQnLCBvblNob3csIHdpbmRvdyk7CiAgICAgIGlvbmljLm9mZignbmF0aXZlLmhpZGVrZXlib2FyZCcsIG9uSGlkZSwgd2luZG93KTsKICAgIH0pOwogIH07Cn0pOwoKZnVuY3Rpb24ga2V5Ym9hcmRBdHRhY2hHZXRDbGllbnRIZWlnaHQoZWxlbWVudCkgewogIHJldHVybiBlbGVtZW50LmNsaWVudEhlaWdodDsKfQoKLyoqCiogQG5nZG9jIGRpcmVjdGl2ZQoqIEBuYW1lIGlvbkxpc3QKKiBAbW9kdWxlIGlvbmljCiogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljTGlzdERlbGVnYXRlCiogQGNvZGVwZW4gSnNIamYKKiBAcmVzdHJpY3QgRQoqIEBkZXNjcmlwdGlvbgoqIFRoZSBMaXN0IGlzIGEgd2lkZWx5IHVzZWQgaW50ZXJmYWNlIGVsZW1lbnQgaW4gYWxtb3N0IGFueSBtb2JpbGUgYXBwLCBhbmQgY2FuIGluY2x1ZGUKKiBjb250ZW50IHJhbmdpbmcgZnJvbSBiYXNpYyB0ZXh0IGFsbCB0aGUgd2F5IHRvIGJ1dHRvbnMsIHRvZ2dsZXMsIGljb25zLCBhbmQgdGh1bWJuYWlscy4KKgoqIEJvdGggdGhlIGxpc3QsIHdoaWNoIGNvbnRhaW5zIGl0ZW1zLCBhbmQgdGhlIGxpc3QgaXRlbXMgdGhlbXNlbHZlcyBjYW4gYmUgYW55IEhUTUwKKiBlbGVtZW50LiBUaGUgY29udGFpbmluZyBlbGVtZW50IHJlcXVpcmVzIHRoZSBgbGlzdGAgY2xhc3MgYW5kIGVhY2ggbGlzdCBpdGVtIHJlcXVpcmVzCiogdGhlIGBpdGVtYCBjbGFzcy4KKgoqIEhvd2V2ZXIsIHVzaW5nIHRoZSBpb25MaXN0IGFuZCBpb25JdGVtIGRpcmVjdGl2ZXMgbWFrZSBpdCBlYXN5IHRvIHN1cHBvcnQgdmFyaW91cwoqIGludGVyYWN0aW9uIG1vZGVzIHN1Y2ggYXMgc3dpcGUgdG8gZWRpdCwgZHJhZyB0byByZW9yZGVyLCBhbmQgcmVtb3ZpbmcgaXRlbXMuCioKKiBSZWxhdGVkOiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkl0ZW19LCB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk9wdGlvbkJ1dHRvbn0KKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblJlb3JkZXJCdXR0b259LCB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkRlbGV0ZUJ1dHRvbn0sIFtgbGlzdCBDU1MgZG9jdW1lbnRhdGlvbmBdKC9kb2NzL2NvbXBvbmVudHMvI2xpc3QpLgoqCiogQHVzYWdlCioKKiBCYXNpYyBVc2FnZToKKgoqIGBgYGh0bWwKKiA8aW9uLWxpc3Q+CiogICA8aW9uLWl0ZW0gbmctcmVwZWF0PSJpdGVtIGluIGl0ZW1zIj4KKiAgICAgeyUgcmF3ICV9SGVsbG8sIHt7aXRlbX19IXslIGVuZHJhdyAlfQoqICAgPC9pb24taXRlbT4KKiA8L2lvbi1saXN0PgoqIGBgYAoqCiogQWR2YW5jZWQgVXNhZ2U6IFRodW1ibmFpbHMsIERlbGV0ZSBidXR0b25zLCBSZW9yZGVyaW5nLCBTd2lwaW5nCioKKiBgYGBodG1sCiogPGlvbi1saXN0IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCIKKiAgICAgICAgICAgc2hvdy1kZWxldGU9InNob3VsZFNob3dEZWxldGUiCiogICAgICAgICAgIHNob3ctcmVvcmRlcj0ic2hvdWxkU2hvd1Jlb3JkZXIiCiogICAgICAgICAgIGNhbi1zd2lwZT0ibGlzdENhblN3aXBlIj4KKiAgIDxpb24taXRlbSBuZy1yZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiCiogICAgICAgICAgICAgY2xhc3M9Iml0ZW0tdGh1bWJuYWlsLWxlZnQiPgoqCiogICAgIHslIHJhdyAlfTxpbWcgbmctc3JjPSJ7e2l0ZW0uaW1nfX0iPgoqICAgICA8aDI+e3tpdGVtLnRpdGxlfX08L2gyPgoqICAgICA8cD57e2l0ZW0uZGVzY3JpcHRpb259fTwvcD57JSBlbmRyYXcgJX0KKiAgICAgPGlvbi1vcHRpb24tYnV0dG9uIGNsYXNzPSJidXR0b24tcG9zaXRpdmUiCiogICAgICAgICAgICAgICAgICAgICAgICBuZy1jbGljaz0ic2hhcmUoaXRlbSkiPgoqICAgICAgIFNoYXJlCiogICAgIDwvaW9uLW9wdGlvbi1idXR0b24+CiogICAgIDxpb24tb3B0aW9uLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLWluZm8iCiogICAgICAgICAgICAgICAgICAgICAgICBuZy1jbGljaz0iZWRpdChpdGVtKSI+CiogICAgICAgRWRpdAoqICAgICA8L2lvbi1vcHRpb24tYnV0dG9uPgoqICAgICA8aW9uLWRlbGV0ZS1idXR0b24gY2xhc3M9Imlvbi1taW51cy1jaXJjbGVkIgoqICAgICAgICAgICAgICAgICAgICAgICAgbmctY2xpY2s9Iml0ZW1zLnNwbGljZSgkaW5kZXgsIDEpIj4KKiAgICAgPC9pb24tZGVsZXRlLWJ1dHRvbj4KKiAgICAgPGlvbi1yZW9yZGVyLWJ1dHRvbiBjbGFzcz0iaW9uLW5hdmljb24iCiogICAgICAgICAgICAgICAgICAgICAgICAgb24tcmVvcmRlcj0icmVvcmRlckl0ZW0oaXRlbSwgJGZyb21JbmRleCwgJHRvSW5kZXgpIj4KKiAgICAgPC9pb24tcmVvcmRlci1idXR0b24+CioKKiAgIDwvaW9uLWl0ZW0+CiogPC9pb24tbGlzdD4KKiBgYGAKKgoqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIGxpc3Qgd2l0aAoqIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY0xpc3REZWxlZ2F0ZX0uCiogQHBhcmFtIHR5cGUge3N0cmluZz19IFRoZSB0eXBlIG9mIGxpc3QgdG8gdXNlIChmb3IgZXhhbXBsZSwgbGlzdC1pbnNldCBmb3IgYW4gaW5zZXQgbGlzdCkKKiBAcGFyYW0gc2hvdy1kZWxldGUge2Jvb2xlYW49fSBXaGV0aGVyIHRoZSBkZWxldGUgYnV0dG9ucyBmb3IgdGhlIGl0ZW1zIGluIHRoZSBsaXN0IGFyZQoqIGN1cnJlbnRseSBzaG93biBvciBoaWRkZW4uCiogQHBhcmFtIHNob3ctcmVvcmRlciB7Ym9vbGVhbj19IFdoZXRoZXIgdGhlIHJlb3JkZXIgYnV0dG9ucyBmb3IgdGhlIGl0ZW1zIGluIHRoZSBsaXN0IGFyZQoqIGN1cnJlbnRseSBzaG93biBvciBoaWRkZW4uCiogQHBhcmFtIGNhbi1zd2lwZSB7Ym9vbGVhbj19IFdoZXRoZXIgdGhlIGl0ZW1zIGluIHRoZSBsaXN0IGFyZSBhbGxvd2VkIHRvIGJlIHN3aXBlZCB0byByZXZlYWwKKiBvcHRpb24gYnV0dG9ucy4gRGVmYXVsdDogdHJ1ZS4KKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uTGlzdCcsIFsKICAnJGFuaW1hdGUnLAogICckdGltZW91dCcsCmZ1bmN0aW9uKCRhbmltYXRlLCAkdGltZW91dCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVxdWlyZTogWydpb25MaXN0JywgJ14/JGlvbmljU2Nyb2xsJ10sCiAgICBjb250cm9sbGVyOiAnJGlvbmljTGlzdCcsCiAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgdmFyIGxpc3RFbCA9IGpxTGl0ZSgnPGRpdiBjbGFzcz0ibGlzdCI+JykKICAgICAgLmFwcGVuZCggJGVsZW1lbnQuY29udGVudHMoKSApCiAgICAgIC5hZGRDbGFzcygkYXR0ci50eXBlKTsKICAgICAgJGVsZW1lbnQuYXBwZW5kKGxpc3RFbCk7CgogICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCBjdHJscykgewogICAgICAgIHZhciBsaXN0Q3RybCA9IGN0cmxzWzBdOwogICAgICAgIHZhciBzY3JvbGxDdHJsID0gY3RybHNbMV07CgogICAgICAgIC8vV2FpdCBmb3IgY2hpbGQgZWxlbWVudHMgdG8gcmVuZGVyLi4uCiAgICAgICAgJHRpbWVvdXQoaW5pdCk7CgogICAgICAgIGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgICB2YXIgbGlzdFZpZXcgPSBsaXN0Q3RybC5saXN0VmlldyA9IG5ldyBpb25pYy52aWV3cy5MaXN0Vmlldyh7CiAgICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgICAgbGlzdEVsOiAkZWxlbWVudC5jaGlsZHJlbigpWzBdLAogICAgICAgICAgICBzY3JvbGxFbDogc2Nyb2xsQ3RybCAmJiBzY3JvbGxDdHJsLmVsZW1lbnQsCiAgICAgICAgICAgIHNjcm9sbFZpZXc6IHNjcm9sbEN0cmwgJiYgc2Nyb2xsQ3RybC5zY3JvbGxWaWV3LAogICAgICAgICAgICBvblJlb3JkZXI6IGZ1bmN0aW9uKGVsLCBvbGRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgICB2YXIgaXRlbVNjb3BlID0ganFMaXRlKGVsKS5zY29wZSgpOwogICAgICAgICAgICAgIGlmIChpdGVtU2NvcGUgJiYgaXRlbVNjb3BlLiRvblJlb3JkZXIpIHsKICAgICAgICAgICAgICAgIC8vTWFrZSBzdXJlIG9uUmVvcmRlciBpcyBjYWxsZWQgaW4gYXBwbHkgY3ljbGUsCiAgICAgICAgICAgICAgICAvL2J1dCBhbHNvIG1ha2Ugc3VyZSBpdCBoYXMgbm8gY29uZmxpY3RzIGJ5IGRvaW5nCiAgICAgICAgICAgICAgICAvLyRldmFsQXN5bmMKICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpdGVtU2NvcGUuJG9uUmVvcmRlcihvbGRJbmRleCwgbmV3SW5kZXgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW5Td2lwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGxpc3RDdHJsLmNhblN3aXBlSXRlbXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKGlzRGVmaW5lZCgkYXR0ci5jYW5Td2lwZSkpIHsKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnISEoJyArICRhdHRyLmNhblN3aXBlICsgJyknLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGxpc3RDdHJsLmNhblN3aXBlSXRlbXModmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0RlZmluZWQoJGF0dHIuc2hvd0RlbGV0ZSkpIHsKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnISEoJyArICRhdHRyLnNob3dEZWxldGUgKyAnKScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgbGlzdEN0cmwuc2hvd0RlbGV0ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGVmaW5lZCgkYXR0ci5zaG93UmVvcmRlcikpIHsKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnISEoJyArICRhdHRyLnNob3dSZW9yZGVyICsgJyknLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGxpc3RDdHJsLnNob3dSZW9yZGVyKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGxpc3RDdHJsLnNob3dEZWxldGUoKTsKICAgICAgICAgIH0sIGZ1bmN0aW9uKGlzU2hvd24sIHdhc1Nob3duKSB7CiAgICAgICAgICAgIC8vT25seSB1c2UgaXNTaG93bj1mYWxzZSBpZiBpdCB3YXMgYWxyZWFkeSBzaG93bgogICAgICAgICAgICBpZiAoIWlzU2hvd24gJiYgIXdhc1Nob3duKSB7IHJldHVybjsgfQoKICAgICAgICAgICAgaWYgKGlzU2hvd24pIGxpc3RDdHJsLmNsb3NlT3B0aW9uQnV0dG9ucygpOwogICAgICAgICAgICBsaXN0Q3RybC5jYW5Td2lwZUl0ZW1zKCFpc1Nob3duKTsKCiAgICAgICAgICAgICRlbGVtZW50LmNoaWxkcmVuKCkudG9nZ2xlQ2xhc3MoJ2xpc3QtbGVmdC1lZGl0aW5nJywgaXNTaG93bik7CiAgICAgICAgICAgICRlbGVtZW50LnRvZ2dsZUNsYXNzKCdkaXNhYmxlLXBvaW50ZXItZXZlbnRzJywgaXNTaG93bik7CgogICAgICAgICAgICB2YXIgZGVsZXRlQnV0dG9uID0ganFMaXRlKCRlbGVtZW50WzBdLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2l0ZW0tZGVsZXRlJykpOwogICAgICAgICAgICBzZXRCdXR0b25TaG93bihkZWxldGVCdXR0b24sIGxpc3RDdHJsLnNob3dEZWxldGUpOwogICAgICAgICAgfSk7CgogICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGxpc3RDdHJsLnNob3dSZW9yZGVyKCk7CiAgICAgICAgICB9LCBmdW5jdGlvbihpc1Nob3duLCB3YXNTaG93bikgewogICAgICAgICAgICAvL09ubHkgdXNlIGlzU2hvd249ZmFsc2UgaWYgaXQgd2FzIGFscmVhZHkgc2hvd24KICAgICAgICAgICAgaWYgKCFpc1Nob3duICYmICF3YXNTaG93bikgeyByZXR1cm47IH0KCiAgICAgICAgICAgIGlmIChpc1Nob3duKSBsaXN0Q3RybC5jbG9zZU9wdGlvbkJ1dHRvbnMoKTsKICAgICAgICAgICAgbGlzdEN0cmwuY2FuU3dpcGVJdGVtcyghaXNTaG93bik7CgogICAgICAgICAgICAkZWxlbWVudC5jaGlsZHJlbigpLnRvZ2dsZUNsYXNzKCdsaXN0LXJpZ2h0LWVkaXRpbmcnLCBpc1Nob3duKTsKICAgICAgICAgICAgJGVsZW1lbnQudG9nZ2xlQ2xhc3MoJ2Rpc2FibGUtcG9pbnRlci1ldmVudHMnLCBpc1Nob3duKTsKCiAgICAgICAgICAgIHZhciByZW9yZGVyQnV0dG9uID0ganFMaXRlKCRlbGVtZW50WzBdLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2l0ZW0tcmVvcmRlcicpKTsKICAgICAgICAgICAgc2V0QnV0dG9uU2hvd24ocmVvcmRlckJ1dHRvbiwgbGlzdEN0cmwuc2hvd1Jlb3JkZXIpOwogICAgICAgICAgfSk7CgogICAgICAgICAgZnVuY3Rpb24gc2V0QnV0dG9uU2hvd24oZWwsIHNob3duKSB7CiAgICAgICAgICAgIHNob3duKCkgJiYgZWwuYWRkQ2xhc3MoJ3Zpc2libGUnKSB8fCBlbC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzaG93bigpICYmIGVsLmFkZENsYXNzKCdhY3RpdmUnKSB8fCBlbC5yZW1vdmVDbGFzcygnaW52aXNpYmxlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgIH07CiAgICB9CiAgfTsKfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbWVudUNsb3NlCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDbG9zZXMgYSBzaWRlIG1lbnUgd2hpY2ggaXMgY3VycmVudGx5IG9wZW5lZC4KICoKICogQHVzYWdlCiAqIEJlbG93IGlzIGFuIGV4YW1wbGUgb2YgYSBsaW5rIHdpdGhpbiBhIHNpZGUgbWVudS4gVGFwcGluZyB0aGlzIGxpbmsgd291bGQKICogYXV0b21hdGljYWxseSBjbG9zZSB0aGUgY3VycmVudGx5IG9wZW5lZCBtZW51LgogKgogKiBgYGBodG1sCiAqIDxhIG1lbnUtY2xvc2UgaHJlZj0iIy9ob21lIiBjbGFzcz0iaXRlbSI+SG9tZTwvYT4KICogYGBgCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdtZW51Q2xvc2UnLCBbJyRpb25pY1ZpZXdTZXJ2aWNlJywgZnVuY3Rpb24oJGlvbmljVmlld1NlcnZpY2UpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBQycsCiAgICByZXF1aXJlOiAnXmlvblNpZGVNZW51cycsCiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2lkZU1lbnVDdHJsKSB7CiAgICAgICRlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oKXsKICAgICAgICBzaWRlTWVudUN0cmwuY2xvc2UoKTsKICAgICAgfSk7CiAgICB9CiAgfTsKfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbWVudVRvZ2dsZQogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVG9nZ2xlIGEgc2lkZSBtZW51IG9uIHRoZSBnaXZlbiBzaWRlCiAqCiAqIEB1c2FnZQogKiBCZWxvdyBpcyBhbiBleGFtcGxlIG9mIGEgbGluayB3aXRoaW4gYSBuYXYgYmFyLiBUYXBwaW5nIHRoaXMgbGluayB3b3VsZAogKiBhdXRvbWF0aWNhbGx5IG9wZW4gdGhlIGdpdmVuIHNpZGUgbWVudQogKgogKiBgYGBodG1sCiAqIDxpb24tdmlldz4KICogICA8aW9uLW5hdi1idXR0b25zIHNpZGU9ImxlZnQiPgogKiAgICA8YnV0dG9uIG1lbnUtdG9nZ2xlPSJsZWZ0IiBjbGFzcz0iYnV0dG9uIGJ1dHRvbi1pY29uIGljb24gaW9uLW5hdmljb24iPjwvYnV0dG9uPgogKiAgIDwvaW9uLW5hdi1idXR0b25zPgogKiAgLi4uCiAqIDwvaW9uLXZpZXc+CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnbWVudVRvZ2dsZScsIFsnJGlvbmljVmlld1NlcnZpY2UnLCBmdW5jdGlvbigkaW9uaWNWaWV3U2VydmljZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0FDJywKICAgIHJlcXVpcmU6ICdeaW9uU2lkZU1lbnVzJywKICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBzaWRlTWVudUN0cmwpIHsKICAgICAgdmFyIHNpZGUgPSAkYXR0ci5tZW51VG9nZ2xlIHx8ICdsZWZ0JzsKICAgICAgJGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbigpewogICAgICAgIGlmKHNpZGUgPT09ICdsZWZ0JykgewogICAgICAgICAgc2lkZU1lbnVDdHJsLnRvZ2dsZUxlZnQoKTsKICAgICAgICB9IGVsc2UgaWYoc2lkZSA9PT0gJ3JpZ2h0JykgewogICAgICAgICAgc2lkZU1lbnVDdHJsLnRvZ2dsZVJpZ2h0KCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9Owp9XSk7CgoKLyoKICogV2UgZG9uJ3QgZG9jdW1lbnQgdGhlIGlvbk1vZGFsIGRpcmVjdGl2ZSwgd2UgaW5zdGVhZCBkb2N1bWVudAogKiB0aGUgJGlvbmljTW9kYWwgc2VydmljZQogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uTW9kYWwnLCBbZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgcmVwbGFjZTogdHJ1ZSwKICAgIGNvbnRyb2xsZXI6IFtmdW5jdGlvbigpe31dLAogICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPSJtb2RhbC1iYWNrZHJvcCI+JyArCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibW9kYWwtd3JhcHBlciIgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAgICAgICAgICAgICc8L2Rpdj4nCiAgfTsKfV0pOwoKSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uTW9kYWxWaWV3JywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ21vZGFsJyk7CiAgICB9CiAgfTsKfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25OYXZCYWNrQnV0dG9uCiAqIEBtb2R1bGUgaW9uaWMKICogQHJlc3RyaWN0IEUKICogQHBhcmVudCBpb25OYXZCYXIKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYSBiYWNrIGJ1dHRvbiBpbnNpZGUgYW4ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9LgogKgogKiBXaWxsIHNob3cgdXAgd2hlbiB0aGUgdXNlciBpcyBhYmxlIHRvIGdvIGJhY2sgaW4gdGhlIGN1cnJlbnQgbmF2aWdhdGlvbiBzdGFjay4KICoKICogQnkgZGVmYXVsdCwgd2lsbCBnbyBiYWNrIHdoZW4gY2xpY2tlZC4gIElmIHlvdSB3aXNoIGZvciBtb3JlIGFkdmFuY2VkIGJlaGF2aW9yLCBzZWUgdGhlCiAqIGV4YW1wbGVzIGJlbG93LgogKgogKiBAdXNhZ2UKICoKICogV2l0aCBkZWZhdWx0IGNsaWNrIGFjdGlvbjoKICoKICogYGBgaHRtbAogKiA8aW9uLW5hdi1iYXI+CiAqICAgPGlvbi1uYXYtYmFjay1idXR0b24gY2xhc3M9ImJ1dHRvbi1jbGVhciI+CiAqICAgICA8aSBjbGFzcz0iaW9uLWFycm93LWxlZnQtYyI+PC9pPiBCYWNrCiAqICAgPC9pb24tbmF2LWJhY2stYnV0dG9uPgogKiA8L2lvbi1uYXYtYmFyPgogKiBgYGAKICoKICogV2l0aCBjdXN0b20gY2xpY2sgYWN0aW9uLCB1c2luZyB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNOYXZCYXJEZWxlZ2F0ZX06CiAqCiAqIGBgYGh0bWwKICogPGlvbi1uYXYtYmFyIG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAqICAgPGlvbi1uYXYtYmFjay1idXR0b24gY2xhc3M9ImJ1dHRvbi1jbGVhciIKICogICAgIG5nLWNsaWNrPSJnb0JhY2soKSI+CiAqICAgICA8aSBjbGFzcz0iaW9uLWFycm93LWxlZnQtYyI+PC9pPiBCYWNrCiAqICAgPC9pb24tbmF2LWJhY2stYnV0dG9uPgogKiA8L2lvbi1uYXYtYmFyPgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljTmF2QmFyRGVsZWdhdGUpIHsKICogICAkc2NvcGUuZ29CYWNrID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNOYXZCYXJEZWxlZ2F0ZS5iYWNrKCk7CiAqICAgfTsKICogfQogKiBgYGAKICoKICogRGlzcGxheWluZyB0aGUgcHJldmlvdXMgdGl0bGUgb24gdGhlIGJhY2sgYnV0dG9uLCBhZ2FpbiB1c2luZwogKiB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNOYXZCYXJEZWxlZ2F0ZX0uCiAqCiAqIGBgYGh0bWwKICogPGlvbi1uYXYtYmFyIG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAqICAgPGlvbi1uYXYtYmFjay1idXR0b24gY2xhc3M9ImJ1dHRvbi1pY29uIj4KICogICAgIDxpIGNsYXNzPSJpY29uIGlvbi1hcnJvdy1sZWZ0LWMiPjwvaT57JSByYXcgJX17e2dldFByZXZpb3VzVGl0bGUoKSB8fCAnQmFjayd9fXslIGVuZHJhdyAlfQogKiAgIDwvaW9uLW5hdi1iYWNrLWJ1dHRvbj4KICogPC9pb24tbmF2LWJhcj4KICogYGBgCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIE15Q3RybCgkc2NvcGUsICRpb25pY05hdkJhckRlbGVnYXRlKSB7CiAqICAgJHNjb3BlLmdldFByZXZpb3VzVGl0bGUgPSBmdW5jdGlvbigpIHsKICogICAgIHJldHVybiAkaW9uaWNOYXZCYXJEZWxlZ2F0ZS5nZXRQcmV2aW91c1RpdGxlKCk7CiAqICAgfTsKICogfQogKiBgYGAKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvbk5hdkJhY2tCdXR0b24nLCBbCiAgJyRhbmltYXRlJywKICAnJHJvb3RTY29wZScsCiAgJyRzYW5pdGl6ZScsCiAgJyRpb25pY05hdkJhckNvbmZpZycsCiAgJyRpb25pY05nQ2xpY2snLApmdW5jdGlvbigkYW5pbWF0ZSwgJHJvb3RTY29wZSwgJHNhbml0aXplLCAkaW9uaWNOYXZCYXJDb25maWcsICRpb25pY05nQ2xpY2spIHsKICB2YXIgYmFja0lzU2hvd24gPSBmYWxzZTsKICAvL0lmIHRoZSBjdXJyZW50IHZpZXdzdGF0ZSBkb2VzIG5vdCBhbGxvdyBhIGJhY2sgYnV0dG9uLAogIC8vYWx3YXlzIGhpZGUgaXQuCiAgJHJvb3RTY29wZS4kb24oJyR2aWV3SGlzdG9yeS5oaXN0b3J5Q2hhbmdlJywgZnVuY3Rpb24oZSwgZGF0YSkgewogICAgYmFja0lzU2hvd24gPSAhIWRhdGEuc2hvd0JhY2s7CiAgfSk7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiAnXmlvbk5hdkJhcicsCiAgICBjb21waWxlOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgIHRFbGVtZW50LmFkZENsYXNzKCdidXR0b24gYmFjay1idXR0b24gbmctaGlkZScpOwoKICAgICAgdmFyIGhhc0ljb25DaGlsZCA9ICEhKHRFbGVtZW50Lmh0bWwoKSB8fCAnJykubWF0Y2goL2NsYXNzPS4qP2lvbi0vKTsKCiAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgbmF2QmFyQ3RybCkgewoKICAgICAgICAvLyBBZGQgYSBkZWZhdWx0IGJhY2sgYnV0dG9uIGljb24gYmFzZWQgb24gdGhlIG5hdiBjb25maWcsIHVubGVzcyBvbmUgaXMgc2V0CiAgICAgICAgaWYgKCFoYXNJY29uQ2hpbGQgJiYgJGVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoJ2lvbi0nKSA9PT0gLTEpIHsKICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKCRpb25pY05hdkJhckNvbmZpZy5iYWNrQnV0dG9uSWNvbik7CiAgICAgICAgfQoKICAgICAgICAvL0RlZmF1bHQgdG8gbmdDbGljayBnb2luZyBiYWNrLCBidXQgZG9uJ3Qgb3ZlcnJpZGUgYSBjdXN0b20gb25lCiAgICAgICAgaWYgKCFpc0RlZmluZWQoJGF0dHIubmdDbGljaykpIHsKICAgICAgICAgICRpb25pY05nQ2xpY2soJHNjb3BlLCAkZWxlbWVudCwgbmF2QmFyQ3RybC5iYWNrKTsKICAgICAgICB9CgogICAgICAgIC8vTWFrZSBzdXJlIGJvdGggdGhhdCBhIGJhY2tCdXR0b24gaXMgYWxsb3dlZCBpbiB0aGUgZmlyc3QgcGxhY2UsCiAgICAgICAgLy9hbmQgdGhhdCBpdCBpcyBzaG93biBieSB0aGUgY3VycmVudCB2aWV3LgogICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihpc0RlZmluZWQoJGF0dHIuZnJvbVRpdGxlKSkgewogICAgICAgICAgICAkZWxlbWVudFswXS5pbm5lckhUTUwgPSAnPHNwYW4gY2xhc3M9ImJhY2stYnV0dG9uLXRpdGxlIj4nICsgJHNhbml0aXplKCRzY29wZS5vbGRUaXRsZSkgKyAnPC9zcGFuPic7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gISEoYmFja0lzU2hvd24gJiYgJHNjb3BlLmJhY2tCdXR0b25TaG93bik7CiAgICAgICAgfSwgaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShmdW5jdGlvbihzaG93KSB7CiAgICAgICAgICBpZiAoc2hvdykgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoJGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICAgICAgICBlbHNlICRhbmltYXRlLmFkZENsYXNzKCRlbGVtZW50LCAnbmctaGlkZScpOwogICAgICAgIH0pKTsKICAgICAgfTsKICAgIH0KICB9Owp9XSk7CgoKSW9uaWNNb2R1bGUuY29uc3RhbnQoJyRpb25pY05hdkJhckNvbmZpZycsIHsKICB0cmFuc2l0aW9uOiAnbmF2LXRpdGxlLXNsaWRlLWlvczcnLAogIGFsaWduVGl0bGU6ICdjZW50ZXInLAogIGJhY2tCdXR0b25JY29uOiAnaW9uLWlvczctYXJyb3ctYmFjaycKfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25OYXZCYXIKICogQG1vZHVsZSBpb25pYwogKiBAZGVsZWdhdGUgaW9uaWMuc2VydmljZTokaW9uaWNOYXZCYXJEZWxlZ2F0ZQogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogSWYgd2UgaGF2ZSBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdlZpZXd9IGRpcmVjdGl2ZSwgd2UgY2FuIGFsc28gY3JlYXRlIGFuCiAqIGA8aW9uLW5hdi1iYXI+YCwgd2hpY2ggd2lsbCBjcmVhdGUgYSB0b3BiYXIgdGhhdCB1cGRhdGVzIGFzIHRoZSBhcHBsaWNhdGlvbiBzdGF0ZSBjaGFuZ2VzLgogKgogKiBXZSBjYW4gYWRkIGEgYmFjayBidXR0b24gYnkgcHV0dGluZyBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhY2tCdXR0b259IGluc2lkZS4KICoKICogV2UgY2FuIGFkZCBidXR0b25zIGRlcGVuZGluZyBvbiB0aGUgY3VycmVudGx5IHZpc2libGUgdmlldyB1c2luZwogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJ1dHRvbnN9LgogKgogKiBBZGQgYW4gW2FuaW1hdGlvbiBjbGFzc10oL2RvY3MvY29tcG9uZW50cyNhbmltYXRpb25zKSB0byB0aGUgZWxlbWVudCB2aWEgdGhlCiAqIGBhbmltYXRpb25gIGF0dHJpYnV0ZSB0byBlbmFibGUgYW5pbWF0ZWQgY2hhbmdpbmcgb2YgdGl0bGVzIAogKiAocmVjb21tZW5kZWQ6ICduYXYtdGl0bGUtc2xpZGUtaW9zNycpLgogKgogKiBOb3RlIHRoYXQgdGhlIGlvbi1uYXYtYmFyIGVsZW1lbnQgd2lsbCBvbmx5IHdvcmsgY29ycmVjdGx5IGlmIHlvdXIgY29udGVudCBoYXMgYW4KICogaW9uVmlldyBhcm91bmQgaXQuCiAqCiAqIEB1c2FnZQogKgogKiBgYGBodG1sCiAqIDxib2R5IG5nLWFwcD0ic3RhcnRlciI+CiAqICAgPCEtLSBUaGUgbmF2IGJhciB0aGF0IHdpbGwgYmUgdXBkYXRlZCBhcyB3ZSBuYXZpZ2F0ZSAtLT4KICogICA8aW9uLW5hdi1iYXIgY2xhc3M9ImJhci1wb3NpdGl2ZSIgYW5pbWF0aW9uPSJuYXYtdGl0bGUtc2xpZGUtaW9zNyI+CiAqICAgPC9pb24tbmF2LWJhcj4KICoKICogICA8IS0tIHdoZXJlIHRoZSBpbml0aWFsIHZpZXcgdGVtcGxhdGUgd2lsbCBiZSByZW5kZXJlZCAtLT4KICogICA8aW9uLW5hdi12aWV3PgogKiAgICAgPGlvbi12aWV3PgogKiAgICAgICA8aW9uLWNvbnRlbnQ+SGVsbG8hPC9pb24tY29udGVudD4KICogICAgIDwvaW9uLXZpZXc+CiAqICAgPC9pb24tbmF2LXZpZXc+CiAqIDwvYm9keT4KICogYGBgCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIG5hdkJhcgogKiB3aXRoIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY05hdkJhckRlbGVnYXRlfS4KICogQHBhcmFtIGFsaWduLXRpdGxlIHtzdHJpbmc9fSBXaGVyZSB0byBhbGlnbiB0aGUgdGl0bGUgb2YgdGhlIG5hdmJhci4KICogQXZhaWxhYmxlOiAnbGVmdCcsICdyaWdodCcsICdjZW50ZXInLiBEZWZhdWx0cyB0byAnY2VudGVyJy4KICogQHBhcmFtIHtib29sZWFuPX0gbm8tdGFwLXNjcm9sbCBCeSBkZWZhdWx0LCB0aGUgbmF2YmFyIHdpbGwgc2Nyb2xsIHRoZSBjb250ZW50CiAqIHRvIHRoZSB0b3Agd2hlbiB0YXBwZWQuICBTZXQgbm8tdGFwLXNjcm9sbCB0byB0cnVlIHRvIGRpc2FibGUgdGhpcyBiZWhhdmlvci4KICoKICogPC90YWJsZT48YnIvPgogKgogKiAjIyMgQWx0ZXJuYXRpdmUgVXNhZ2UKICoKICogQWx0ZXJuYXRpdmVseSwgeW91IG1heSBwdXQgaW9uLW5hdi1iYXIgaW5zaWRlIG9mIGVhY2ggaW5kaXZpZHVhbCB2aWV3J3MgaW9uLXZpZXcgZWxlbWVudC4KICogVGhpcyB3aWxsIGFsbG93IHlvdSB0byBoYXZlIHRoZSB3aG9sZSBuYXZiYXIsIG5vdCBqdXN0IGl0cyBjb250ZW50cywgdHJhbnNpdGlvbiBldmVyeSB2aWV3IGNoYW5nZS4KICoKICogVGhpcyBpcyBzaW1pbGFyIHRvIHVzaW5nIGEgaGVhZGVyIGJhciBpbnNpZGUgeW91ciBpb24tdmlldywgZXhjZXB0IGl0IHdpbGwgaGF2ZSBhbGwgdGhlIHBvd2VyIG9mIGEgbmF2YmFyLgogKgogKiBJZiB5b3UgZG8gdGhpcywgc2ltcGx5IHB1dCBuYXYgYnV0dG9ucyBpbnNpZGUgdGhlIG5hdmJhciBpdHNlbGY7IGRvIG5vdCB1c2UgYDxpb24tbmF2LWJ1dHRvbnM+YC4KICoKICoKICogYGBgaHRtbAogKiA8aW9uLXZpZXcgdGl0bGU9Im15VGl0bGUiPgogKiAgIDxpb24tbmF2LWJhciBjbGFzcz0iYmFyLXBvc2l0aXZlIj4KICogICAgIDxpb24tbmF2LWJhY2stYnV0dG9uPgogKiAgICAgICBCYWNrCiAqICAgICA8L2lvbi1uYXYtYmFjay1idXR0b24+CiAqICAgICA8ZGl2IGNsYXNzPSJidXR0b25zIHJpZ2h0LWJ1dHRvbnMiPgogKiAgICAgICA8YnV0dG9uIGNsYXNzPSJidXR0b24iPgogKiAgICAgICAgIFJpZ2h0IEJ1dHRvbgogKiAgICAgICA8L2J1dHRvbj4KICogICAgIDwvZGl2PgogKiAgIDwvaW9uLW5hdi1iYXI+CiAqIDwvaW9uLXZpZXc+CiAqIGBgYAogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uTmF2QmFyJywgWwogICckaW9uaWNWaWV3U2VydmljZScsCiAgJyRyb290U2NvcGUnLAogICckYW5pbWF0ZScsCiAgJyRjb21waWxlJywKICAnJGlvbmljTmF2QmFyQ29uZmlnJywKZnVuY3Rpb24oJGlvbmljVmlld1NlcnZpY2UsICRyb290U2NvcGUsICRhbmltYXRlLCAkY29tcGlsZSwgJGlvbmljTmF2QmFyQ29uZmlnKSB7CgogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgY29udHJvbGxlcjogJyRpb25pY05hdkJhcicsCiAgICBzY29wZTogdHJ1ZSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgLy9XZSBjYW5ub3QgdHJhbnNjbHVkZSBoZXJlIGJlY2F1c2UgaXQgYnJlYWtzIGVsZW1lbnQuZGF0YSgpIGluaGVyaXRhbmNlIG9uIGNvbXBpbGUKICAgICAgdEVsZW1lbnQKICAgICAgICAuYWRkQ2xhc3MoJ2JhciBiYXItaGVhZGVyIG5hdi1iYXInKQogICAgICAgIC5hcHBlbmQoCiAgICAgICAgICAnPGRpdiBjbGFzcz0iYnV0dG9ucyBsZWZ0LWJ1dHRvbnMiPiAnICsKICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICc8aDEgbmctYmluZC1odG1sPSJ0aXRsZSIgY2xhc3M9InRpdGxlIj48L2gxPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9ImJ1dHRvbnMgcmlnaHQtYnV0dG9ucyI+ICcgKwogICAgICAgICAgJzwvZGl2PicKICAgICAgICApOwoKICAgICAgaWYgKGlzRGVmaW5lZCh0QXR0cnMuYW5pbWF0aW9uKSkgewogICAgICAgIHRFbGVtZW50LmFkZENsYXNzKHRBdHRycy5hbmltYXRpb24pOwogICAgICB9IGVsc2UgewogICAgICAgIHRFbGVtZW50LmFkZENsYXNzKCRpb25pY05hdkJhckNvbmZpZy50cmFuc2l0aW9uKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIG5hdkJhckN0cmwpIHsKICAgICAgICBuYXZCYXJDdHJsLl9oZWFkZXJCYXJWaWV3ID0gbmV3IGlvbmljLnZpZXdzLkhlYWRlckJhcih7CiAgICAgICAgICBlbDogJGVsZW1lbnRbMF0sCiAgICAgICAgICBhbGlnblRpdGxlOiAkYXR0ci5hbGlnblRpdGxlIHx8ICRpb25pY05hdkJhckNvbmZpZy5hbGlnblRpdGxlIHx8ICdjZW50ZXInCiAgICAgICAgfSk7CgogICAgICAgIC8vZGVmYXVsdHMKICAgICAgICAkc2NvcGUuYmFja0J1dHRvblNob3duID0gZmFsc2U7CiAgICAgICAgJHNjb3BlLnNob3VsZEFuaW1hdGUgPSB0cnVlOwogICAgICAgICRzY29wZS5pc1JldmVyc2UgPSBmYWxzZTsKICAgICAgICAkc2NvcGUuaXNJbnZpc2libGUgPSB0cnVlOwoKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgJHNjb3BlLiRwYXJlbnQuJGhhc0hlYWRlciA9IGZhbHNlOwogICAgICAgIH0pOwoKICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuICgkc2NvcGUuaXNSZXZlcnNlID8gJyByZXZlcnNlJyA6ICcnKSArCiAgICAgICAgICAgICgkc2NvcGUuaXNJbnZpc2libGUgPyAnIGludmlzaWJsZScgOiAnJykgKwogICAgICAgICAgICAoISRzY29wZS5zaG91bGRBbmltYXRlID8gJyBuby1hbmltYXRpb24nIDogJycpOwogICAgICAgIH0sIGZ1bmN0aW9uKGNsYXNzTmFtZSwgb2xkQ2xhc3NOYW1lKSB7CiAgICAgICAgICAkZWxlbWVudC5yZW1vdmVDbGFzcyhvbGRDbGFzc05hbWUpOwogICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH0KICB9Owp9XSk7CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uTmF2QnV0dG9ucwogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBFCiAqIEBwYXJlbnQgaW9uTmF2VmlldwogKgogKiBAZGVzY3JpcHRpb24KICogVXNlIGlvbk5hdkJ1dHRvbnMgdG8gc2V0IHRoZSBidXR0b25zIG9uIHlvdXIge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9CiAqIGZyb20gd2l0aGluIGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uVmlld30uCiAqCiAqIEFueSBidXR0b25zIHlvdSBkZWNsYXJlIHdpbGwgYmUgcGxhY2VkIG9udG8gdGhlIG5hdmJhcidzIGNvcnJlc3BvbmRpbmcgc2lkZSwKICogYW5kIHRoZW4gZGVzdHJveWVkIHdoZW4gdGhlIHVzZXIgbGVhdmVzIHRoZWlyIHBhcmVudCB2aWV3LgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8aW9uLW5hdi1iYXI+CiAqIDwvaW9uLW5hdi1iYXI+CiAqIDxpb24tbmF2LXZpZXc+CiAqICAgPGlvbi12aWV3PgogKiAgICAgPGlvbi1uYXYtYnV0dG9ucyBzaWRlPSJsZWZ0Ij4KICogICAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIiBuZy1jbGljaz0iZG9Tb21ldGhpbmcoKSI+CiAqICAgICAgICAgSSdtIGEgYnV0dG9uIG9uIHRoZSBsZWZ0IG9mIHRoZSBuYXZiYXIhCiAqICAgICAgIDwvYnV0dG9uPgogKiAgICAgPC9pb24tbmF2LWJ1dHRvbnM+CiAqICAgICA8aW9uLWNvbnRlbnQ+CiAqICAgICAgIFNvbWUgc3VwZXIgY29udGVudCBoZXJlIQogKiAgICAgPC9pb24tY29udGVudD4KICogICA8L2lvbi12aWV3PgogKiA8L2lvbi1uYXYtdmlldz4KICogYGBgCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBzaWRlIFRoZSBzaWRlIHRvIHBsYWNlIHRoZSBidXR0b25zIG9uIGluIHRoZSBwYXJlbnQKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9LiBBdmFpbGFibGU6ICdsZWZ0JyBvciAncmlnaHQnLgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uTmF2QnV0dG9ucycsIFsnJGNvbXBpbGUnLCAnJGFuaW1hdGUnLCBmdW5jdGlvbigkY29tcGlsZSwgJGFuaW1hdGUpIHsKICByZXR1cm4gewogICAgcmVxdWlyZTogJ15pb25OYXZCYXInLAogICAgcmVzdHJpY3Q6ICdFJywKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgdmFyIGNvbnRlbnQgPSAkZWxlbWVudC5jb250ZW50cygpLnJlbW92ZSgpOwogICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCBuYXZCYXJDdHJsKSB7CiAgICAgICAgdmFyIG5hdkVsZW1lbnQgPSAkYXR0cnMuc2lkZSA9PT0gJ3JpZ2h0JyA/CiAgICAgICAgICBuYXZCYXJDdHJsLnJpZ2h0QnV0dG9uc0VsZW1lbnQgOgogICAgICAgICAgbmF2QmFyQ3RybC5sZWZ0QnV0dG9uc0VsZW1lbnQ7CgogICAgICAgIC8vUHV0IGFsbCBvZiBvdXIgaW5zaWRlIGJ1dHRvbnMgaW50byB0aGVpciBvd24gc3BhbiwKICAgICAgICAvL3NvIHdlIGNhbiByZW1vdmUgdGhlbSBhbGwgd2hlbiB0aGlzIGVsZW1lbnQgZGllcyAtCiAgICAgICAgLy9ldmVuIGlmIHRoZSBidXR0b25zIGhhdmUgY2hhbmdlZCB0aHJvdWdoIGFuIG5nLXJlcGVhdCBvciB0aGUgbGlrZSwKICAgICAgICAvL3dlIGp1c3QgcmVtb3ZlIHRoZWlyIGRpdiBwYXJlbnQgYW5kIHRoZXkgYXJlIGdvbmUuCiAgICAgICAgdmFyIGJ1dHRvbnMgPSBqcUxpdGUoJzxzcGFuPicpLmFwcGVuZChjb250ZW50KTsKCiAgICAgICAgLy9Db21waWxlIGJ1dHRvbnMgaW5zaWRlIGNvbnRlbnQgc28gdGhleSBoYXZlIGFjY2VzcyB0byBldmVyeXRoaW5nCiAgICAgICAgLy9zb21ldGhpbmcgaW5zaWRlIGNvbnRlbnQgZG9lcyAoZWcgcGFyZW50IGlvbmljU2Nyb2xsKQogICAgICAgICRlbGVtZW50LmFwcGVuZChidXR0b25zKTsKICAgICAgICAkY29tcGlsZShidXR0b25zKSgkc2NvcGUpOwoKICAgICAgICAvL0FwcGVuZCBidXR0b25zIHRvIG5hdmJhcgogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgIC8vSWYgdGhlIHNjb3BlIGlzIGRlc3Ryb3llZCBiZWZvcmUgcmFmIHJ1bnMsIGJlIHN1cmUgbm90IHRvIGVudGVyCiAgICAgICAgICBpZiAoISRzY29wZS4kJGRlc3Ryb3llZCkgewogICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihidXR0b25zLCBuYXZFbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy9XaGVuIG91ciBpb24tbmF2LWJ1dHRvbnMgY29udGFpbmVyIGlzIGRlc3Ryb3llZCwKICAgICAgICAvL2Rlc3Ryb3kgZXZlcnl0aGluZyBpbiB0aGUgbmF2YmFyCiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICRhbmltYXRlLmxlYXZlKGJ1dHRvbnMpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBUaGUgb3JpZ2luYWwgZWxlbWVudCBpcyBqdXN0IGEgY29tcGxldGVseSBlbXB0eSA8aW9uLW5hdi1idXR0b25zPiBlbGVtZW50LgogICAgICAgIC8vIG1ha2UgaXQgaW52aXNpYmxlIGp1c3QgdG8gYmUgc3VyZSBpdCBkb2Vzbid0IGNoYW5nZSBhbnkgbGF5b3V0CiAgICAgICAgJGVsZW1lbnQuY3NzKCdkaXNwbGF5JywgJ25vbmUnKTsKICAgICAgfTsKICAgIH0KICB9Owp9XSk7CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmF2Q2xlYXIKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIG5hdi1jbGVhciBpcyBhbiBhdHRyaWJ1dGUgZGlyZWN0aXZlIHdoaWNoIHNob3VsZCBiZSB1c2VkIHdpdGggYW4gZWxlbWVudCB0aGF0IGNoYW5nZXMKICogdGhlIHZpZXcgb24gY2xpY2ssIGZvciBleGFtcGxlIGFuIGA8YSBocmVmPmAgb3IgYSBgPGJ1dHRvbiB1aS1zcmVmPmAuCiAqCiAqIG5hdi1jbGVhciB3aWxsIGNhdXNlIHRoZSBnaXZlbiBlbGVtZW50LCB3aGVuIGNsaWNrZWQsIHRvIGRpc2FibGUgdGhlIG5leHQgdmlldyB0cmFuc2l0aW9uLgogKiBUaGlzIGRpcmVjdGl2ZSBpcyB1c2VmdWwsIGZvciBleGFtcGxlLCBmb3IgbGlua3Mgd2l0aGluIGEgc2lkZU1lbnUuCiAqCiAqIEB1c2FnZQogKiBCZWxvdyBpcyBhIGxpbmsgaW4gYSBzaWRlIG1lbnUsIHdpdGggdGhlIG5hdi1jbGVhciBkaXJlY3RpdmUgYWRkZWQgdG8gaXQuCiAqIFRhcHBpbmcgdGhpcyBsaW5rIHdpbGwgZGlzYWJsZSBhbnkgYW5pbWF0aW9ucyB0aGF0IHdvdWxkIG5vcm1hbGx5IG9jY3VyCiAqIGJldHdlZW4gdmlld3MuCiAqCiAqIGBgYGh0bWwKICogPGEgbmF2LWNsZWFyIG1lbnUtY2xvc2UgaHJlZj0iIy9ob21lIiBjbGFzcz0iaXRlbSI+SG9tZTwvYT4KICogYGBgCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCduYXZDbGVhcicsIFsKICAnJGlvbmljVmlld1NlcnZpY2UnLAogICckc3RhdGUnLAogICckbG9jYXRpb24nLAogICckd2luZG93JywKICAnJHJvb3RTY29wZScsCmZ1bmN0aW9uKCRpb25pY1ZpZXdTZXJ2aWNlLCAkbG9jYXRpb24sICRzdGF0ZSwgJHdpbmRvdywgJHJvb3RTY29wZSkgewogICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VFcnJvcicsIGZ1bmN0aW9uKCkgewogICAgJGlvbmljVmlld1NlcnZpY2UubmV4dFZpZXdPcHRpb25zKG51bGwpOwogIH0pOwogIHJldHVybiB7CiAgICBwcmlvcml0eTogMTAwLAogICAgcmVzdHJpY3Q6ICdBQycsCiAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCkgewogICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgICB2YXIgdW5yZWdpc3Rlckxpc3RlbmVyOwogICAgICAgIGZ1bmN0aW9uIGxpc3RlbkZvclN0YXRlQ2hhbmdlKCkgewogICAgICAgICAgdW5yZWdpc3Rlckxpc3RlbmVyID0gJHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3RhcnQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJGlvbmljVmlld1NlcnZpY2UubmV4dFZpZXdPcHRpb25zKHsKICAgICAgICAgICAgICBkaXNhYmxlQW5pbWF0ZTogdHJ1ZSwKICAgICAgICAgICAgICBkaXNhYmxlQmFjazogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdW5yZWdpc3Rlckxpc3RlbmVyKCk7CiAgICAgICAgICB9KTsKICAgICAgICAgICR3aW5kb3cuc2V0VGltZW91dCh1bnJlZ2lzdGVyTGlzdGVuZXIsIDMwMCk7CiAgICAgICAgfQoKICAgICAgICAkZWxlbWVudC5vbignY2xpY2snLCBsaXN0ZW5Gb3JTdGF0ZUNoYW5nZSk7CiAgICAgIH0KICAgIH0KICB9Owp9XSk7CgpJb25pY01vZHVsZS5jb25zdGFudCgnJGlvbmljTmF2Vmlld0NvbmZpZycsIHsKICB0cmFuc2l0aW9uOiAnc2xpZGUtbGVmdC1yaWdodC1pb3M3Jwp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvbk5hdlZpZXcKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAY29kZXBlbiBvZHFDegogKgogKiBAZGVzY3JpcHRpb24KICogQXMgYSB1c2VyIG5hdmlnYXRlcyB0aHJvdWdob3V0IHlvdXIgYXBwLCBJb25pYyBpcyBhYmxlIHRvIGtlZXAgdHJhY2sgb2YgdGhlaXIKICogbmF2aWdhdGlvbiBoaXN0b3J5LiBCeSBrbm93aW5nIHRoZWlyIGhpc3RvcnksIHRyYW5zaXRpb25zIGJldHdlZW4gdmlld3MKICogY29ycmVjdGx5IHNsaWRlIGVpdGhlciBsZWZ0IG9yIHJpZ2h0LCBvciBubyB0cmFuc2l0aW9uIGF0IGFsbC4gQW4gYWRkaXRpb25hbAogKiBiZW5lZml0IHRvIElvbmljJ3MgbmF2aWdhdGlvbiBzeXN0ZW0gaXMgaXRzIGFiaWxpdHkgdG8gbWFuYWdlIG11bHRpcGxlCiAqIGhpc3Rvcmllcy4KICoKICogSW9uaWMgdXNlcyB0aGUgQW5ndWxhclVJIFJvdXRlciBtb2R1bGUgc28gYXBwIGludGVyZmFjZXMgY2FuIGJlIG9yZ2FuaXplZAogKiBpbnRvIHZhcmlvdXMgInN0YXRlcyIuIExpa2UgQW5ndWxhcidzIGNvcmUgJHJvdXRlIHNlcnZpY2UsIFVSTHMgY2FuIGJlIHVzZWQKICogdG8gY29udHJvbCB0aGUgdmlld3MuIEhvd2V2ZXIsIHRoZSBBbmd1bGFyVUkgUm91dGVyIHByb3ZpZGVzIGEgbW9yZSBwb3dlcmZ1bAogKiBzdGF0ZSBtYW5hZ2VyIGluIHRoYXQgc3RhdGVzIGFyZSBib3VuZCB0byBuYW1lZCwgbmVzdGVkLCBhbmQgcGFyYWxsZWwgdmlld3MsCiAqIGFsbG93aW5nIG1vcmUgdGhhbiBvbmUgdGVtcGxhdGUgdG8gYmUgcmVuZGVyZWQgb24gdGhlIHNhbWUgcGFnZS4KICogQWRkaXRpb25hbGx5LCBlYWNoIHN0YXRlIGlzIG5vdCByZXF1aXJlZCB0byBiZSBib3VuZCB0byBhIFVSTCwgYW5kIGRhdGEgY2FuCiAqIGJlIHB1c2hlZCB0byBlYWNoIHN0YXRlIHdoaWNoIGFsbG93cyBtdWNoIGZsZXhpYmlsaXR5LgogKgogKiBUaGUgaW9uTmF2VmlldyBkaXJlY3RpdmUgaXMgdXNlZCB0byByZW5kZXIgdGVtcGxhdGVzIGluIHlvdXIgYXBwbGljYXRpb24uIEVhY2ggdGVtcGxhdGUKICogaXMgcGFydCBvZiBhIHN0YXRlLiBTdGF0ZXMgYXJlIHVzdWFsbHkgbWFwcGVkIHRvIGEgdXJsLCBhbmQgYXJlIGRlZmluZWQgcHJvZ3JhbWF0aWNhbGx5CiAqIHVzaW5nIGFuZ3VsYXItdWktcm91dGVyIChzZWUgW3RoZWlyIGRvY3NdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyLXVpL3VpLXJvdXRlci93aWtpKSwKICogYW5kIHJlbWVtYmVyIHRvIHJlcGxhY2UgdWktdmlldyB3aXRoIGlvbi1uYXYtdmlldyBpbiBleGFtcGxlcykuCiAqCiAqIEB1c2FnZQogKiBJbiB0aGlzIGV4YW1wbGUsIHdlIHdpbGwgY3JlYXRlIGEgbmF2aWdhdGlvbiB2aWV3IHRoYXQgY29udGFpbnMgb3VyIGRpZmZlcmVudCBzdGF0ZXMgZm9yIHRoZSBhcHAuCiAqCiAqIFRvIGRvIHRoaXMsIGluIG91ciBtYXJrdXAgd2UgdXNlIGlvbk5hdlZpZXcgdG9wIGxldmVsIGRpcmVjdGl2ZS4gVG8gZGlzcGxheSBhIGhlYWRlciBiYXIgd2UgdXNlCiAqIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gZGlyZWN0aXZlIHRoYXQgdXBkYXRlcyBhcyB3ZSBuYXZpZ2F0ZSB0aHJvdWdoIHRoZQogKiBuYXZpZ2F0aW9uIHN0YWNrLgogKgogKiBZb3UgY2FuIHVzZSBhbnkgW2FuaW1hdGlvbiBjbGFzc10oL2RvY3MvY29tcG9uZW50cyNhbmltYXRpb25zKSBvbiB0aGUgbmF2VmlldydzIGBhbmltYXRpb25gIGF0dHJpYnV0ZQogKiB0byBoYXZlIGl0cyBwYWdlcyBhbmltYXRlLgogKgogKiBSZWNvbW1lbmRlZCBmb3IgcGFnZSB0cmFuc2l0aW9uczogJ3NsaWRlLWxlZnQtcmlnaHQnLCAnc2xpZGUtbGVmdC1yaWdodC1pb3M3JywgJ3NsaWRlLWluLXVwJy4KICoKICogYGBgaHRtbAogKiA8aW9uLW5hdi1iYXI+PC9pb24tbmF2LWJhcj4KICogPGlvbi1uYXYtdmlldyBhbmltYXRpb249InNsaWRlLWxlZnQtcmlnaHQiPgogKiAgIDwhLS0gQ2VudGVyIGNvbnRlbnQgLS0+CiAqIDwvaW9uLW5hdi12aWV3PgogKiBgYGAKICoKICogTmV4dCwgd2UgbmVlZCB0byBzZXR1cCBvdXIgc3RhdGVzIHRoYXQgd2lsbCBiZSByZW5kZXJlZC4KICoKICogYGBganMKICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFsnaW9uaWMnXSk7CiAqIGFwcC5jb25maWcoZnVuY3Rpb24oJHN0YXRlUHJvdmlkZXIpIHsKICogICAkc3RhdGVQcm92aWRlcgogKiAgIC5zdGF0ZSgnaW5kZXgnLCB7CiAqICAgICB1cmw6ICcvJywKICogICAgIHRlbXBsYXRlVXJsOiAnaG9tZS5odG1sJwogKiAgIH0pCiAqICAgLnN0YXRlKCdtdXNpYycsIHsKICogICAgIHVybDogJy9tdXNpYycsCiAqICAgICB0ZW1wbGF0ZVVybDogJ211c2ljLmh0bWwnCiAqICAgfSk7CiAqIH0pOwogKiBgYGAKICogVGhlbiBvbiBhcHAgc3RhcnQsICRzdGF0ZVByb3ZpZGVyIHdpbGwgbG9vayBhdCB0aGUgdXJsLCBzZWUgaXQgbWF0Y2hlcyB0aGUgaW5kZXggc3RhdGUsCiAqIGFuZCB0aGVuIHRyeSB0byBsb2FkIGhvbWUuaHRtbCBpbnRvIHRoZSBgPGlvbi1uYXYtdmlldz5gLgogKgogKiBQYWdlcyBhcmUgbG9hZGVkIGJ5IHRoZSBVUkxzIGdpdmVuLiBPbmUgc2ltcGxlIHdheSB0byBjcmVhdGUgdGVtcGxhdGVzIGluIEFuZ3VsYXIgaXMgdG8gcHV0CiAqIHRoZW0gZGlyZWN0bHkgaW50byB5b3VyIEhUTUwgZmlsZSBhbmQgdXNlIHRoZSBgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIj5gIHN5bnRheC4KICogU28gaGVyZSBpcyBvbmUgd2F5IHRvIHB1dCBob21lLmh0bWwgaW50byBvdXIgYXBwOgogKgogKiBgYGBodG1sCiAqIDxzY3JpcHQgaWQ9ImhvbWUiIHR5cGU9InRleHQvbmctdGVtcGxhdGUiPgogKiAgIDwhLS0gVGhlIHRpdGxlIG9mIHRoZSBpb24tdmlldyB3aWxsIGJlIHNob3duIG9uIHRoZSBuYXZiYXIgLS0+CiAqICAgPGlvbi12aWV3IHRpdGxlPSInSG9tZSciPgogKiAgICAgPGlvbi1jb250ZW50IG5nLWNvbnRyb2xsZXI9IkhvbWVDdHJsIj4KICogICAgICAgPCEtLSBUaGUgY29udGVudCBvZiB0aGUgcGFnZSAtLT4KICogICAgICAgPGEgaHJlZj0iIy9tdXNpYyI+R28gdG8gbXVzaWMgcGFnZSE8L2E+CiAqICAgICA8L2lvbi1jb250ZW50PgogKiAgIDwvaW9uLXZpZXc+CiAqIDwvc2NyaXB0PgogKiBgYGAKICoKICogVGhpcyBpcyBnb29kIHRvIGRvIGJlY2F1c2UgdGhlIHRlbXBsYXRlIHdpbGwgYmUgY2FjaGVkIGZvciB2ZXJ5IGZhc3QgbG9hZGluZywgaW5zdGVhZCBvZgogKiBoYXZpbmcgdG8gZmV0Y2ggdGhlbSBmcm9tIHRoZSBuZXR3b3JrLgogKgogKiBQbGVhc2UgdmlzaXQgW0FuZ3VsYXJVSSBSb3V0ZXIncyBkb2NzXShodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci11aS91aS1yb3V0ZXIvd2lraSkgZm9yCiAqIG1vcmUgaW5mby4gQmVsb3cgaXMgYSBncmVhdCB2aWRlbyBieSB0aGUgQW5ndWxhclVJIFJvdXRlciBndXlzIHRoYXQgbWF5IGhlbHAgdG8gZXhwbGFpbgogKiBob3cgaXQgYWxsIHdvcmtzOgogKgogKiA8aWZyYW1lIHdpZHRoPSI1NjAiIGhlaWdodD0iMzE1IiBzcmM9Ii8vd3d3LnlvdXR1YmUuY29tL2VtYmVkL2RxSlJvaDhNbkJvIgogKiBmcmFtZWJvcmRlcj0iMCIgYWxsb3dmdWxsc2NyZWVuPjwvaWZyYW1lPgogKgogKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgQSB2aWV3IG5hbWUuIFRoZSBuYW1lIHNob3VsZCBiZSB1bmlxdWUgYW1vbmdzdCB0aGUgb3RoZXIgdmlld3MgaW4gdGhlCiAqIHNhbWUgc3RhdGUuIFlvdSBjYW4gaGF2ZSB2aWV3cyBvZiB0aGUgc2FtZSBuYW1lIHRoYXQgbGl2ZSBpbiBkaWZmZXJlbnQgc3RhdGVzLiBGb3IgbW9yZQogKiBpbmZvcm1hdGlvbiwgc2VlIHVpLXJvdXRlcidzIFt1aS12aWV3IGRvY3VtZW50YXRpb25dKGh0dHA6Ly9hbmd1bGFyLXVpLmdpdGh1Yi5pby91aS1yb3V0ZXIvc2l0ZS8jL2FwaS91aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXZpZXcpLgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uTmF2VmlldycsIFsKICAnJGlvbmljVmlld1NlcnZpY2UnLAogICckc3RhdGUnLAogICckY29tcGlsZScsCiAgJyRjb250cm9sbGVyJywKICAnJGFuaW1hdGUnLApmdW5jdGlvbiggJGlvbmljVmlld1NlcnZpY2UsICAgJHN0YXRlLCAgICRjb21waWxlLCAgICRjb250cm9sbGVyLCAgICRhbmltYXRlKSB7CiAgLy8gSU9OSUMncyBmb3JrIG9mIEFuZ3VsYXIgVUkgUm91dGVyLCB2MC4yLjcKICAvLyB0aGUgbmF2VmlldyBoYW5kbGVzIHJlZ2lzdGVyaW5nIHZpZXdzIGluIHRoZSBoaXN0b3J5LCB3aGljaCBhbmltYXRpb24gdG8gdXNlLCBhbmQgd2hpY2gKICB2YXIgdmlld0lzVXBkYXRpbmcgPSBmYWxzZTsKCiAgdmFyIGRpcmVjdGl2ZSA9IHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgIHByaW9yaXR5OiAyMDAwLAogICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uKCl7fSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyLCB0cmFuc2NsdWRlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgbmF2Vmlld0N0cmwpIHsKICAgICAgICB2YXIgdmlld1Njb3BlLCB2aWV3TG9jYWxzLAogICAgICAgICAgbmFtZSA9IGF0dHJbZGlyZWN0aXZlLm5hbWVdIHx8IGF0dHIubmFtZSB8fCAnJywKICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnLAogICAgICAgICAgaW5pdGlhbFZpZXcgPSB0cmFuc2NsdWRlKHNjb3BlKTsKCiAgICAgICAgLy8gUHV0IGJhY2sgdGhlIGNvbXBpbGVkIGluaXRpYWwgdmlldwogICAgICAgIGVsZW1lbnQuYXBwZW5kKGluaXRpYWxWaWV3KTsKCiAgICAgICAgLy8gRmluZCB0aGUgZGV0YWlscyBvZiB0aGUgcGFyZW50IHZpZXcgZGlyZWN0aXZlIChpZiBhbnkpIGFuZCB1c2UgaXQKICAgICAgICAvLyB0byBkZXJpdmUgb3VyIG93biBxdWFsaWZpZWQgdmlldyBuYW1lLCB0aGVuIGhhbmcgb3VyIG93biBkZXRhaWxzCiAgICAgICAgLy8gb2ZmIHRoZSBET00gc28gY2hpbGQgZGlyZWN0aXZlcyBjYW4gZmluZCBpdC4KICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKS5pbmhlcml0ZWREYXRhKCckdWlWaWV3Jyk7CiAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignQCcpIDwgMCkgbmFtZSAgPSBuYW1lICsgJ0AnICsgKChwYXJlbnQgJiYgcGFyZW50LnN0YXRlKSA/IHBhcmVudC5zdGF0ZS5uYW1lIDogJycpOwogICAgICAgIHZhciB2aWV3ID0geyBuYW1lOiBuYW1lLCBzdGF0ZTogbnVsbCB9OwogICAgICAgIGVsZW1lbnQuZGF0YSgnJHVpVmlldycsIHZpZXcpOwoKICAgICAgICB2YXIgZXZlbnRIb29rID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodmlld0lzVXBkYXRpbmcpIHJldHVybjsKICAgICAgICAgIHZpZXdJc1VwZGF0aW5nID0gdHJ1ZTsKCiAgICAgICAgICB0cnkgeyB1cGRhdGVWaWV3KHRydWUpOyB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHZpZXdJc1VwZGF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgICB2aWV3SXNVcGRhdGluZyA9IGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIGV2ZW50SG9vayk7CiAgICAgICAgLy8gc2NvcGUuJG9uKCckdmlld0NvbnRlbnRMb2FkaW5nJywgZXZlbnRIb29rKTsKICAgICAgICB1cGRhdGVWaWV3KGZhbHNlKTsKCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVmlldyhkb0FuaW1hdGUpIHsKICAgICAgICAgIC8vPT09ZmFsc2UgYmVjYXVzZSAkYW5pbWF0ZS5lbmFibGVkKCkgaXMgYSBub29wIHdpdGhvdXQgYW5ndWxhci1hbmltYXRlIGluY2x1ZGVkCiAgICAgICAgICBpZiAoJGFuaW1hdGUuZW5hYmxlZCgpID09PSBmYWxzZSkgewogICAgICAgICAgICBkb0FuaW1hdGUgPSBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgbG9jYWxzID0gJHN0YXRlLiRjdXJyZW50ICYmICRzdGF0ZS4kY3VycmVudC5sb2NhbHNbbmFtZV07CiAgICAgICAgICBpZiAobG9jYWxzID09PSB2aWV3TG9jYWxzKSByZXR1cm47IC8vIG5vdGhpbmcgdG8gZG8KICAgICAgICAgIHZhciByZW5kZXJlciA9ICRpb25pY1ZpZXdTZXJ2aWNlLmdldFJlbmRlcmVyKGVsZW1lbnQsIGF0dHIsIHNjb3BlKTsKCiAgICAgICAgICAvLyBEZXN0cm95IHByZXZpb3VzIHZpZXcgc2NvcGUKICAgICAgICAgIGlmICh2aWV3U2NvcGUpIHsKICAgICAgICAgICAgdmlld1Njb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgIHZpZXdTY29wZSA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFsb2NhbHMpIHsKICAgICAgICAgICAgdmlld0xvY2FscyA9IG51bGw7CiAgICAgICAgICAgIHZpZXcuc3RhdGUgPSBudWxsOwoKICAgICAgICAgICAgLy8gUmVzdG9yZSB0aGUgaW5pdGlhbCB2aWV3CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmFwcGVuZChpbml0aWFsVmlldyk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBqcUxpdGUoJzxkaXY+PC9kaXY+JykuaHRtbChsb2NhbHMuJHRlbXBsYXRlKS5jb250ZW50cygpOwogICAgICAgICAgdmFyIHZpZXdSZWdpc3RlckRhdGEgPSByZW5kZXJlcigpLnJlZ2lzdGVyKG5ld0VsZW1lbnQpOwoKICAgICAgICAgIC8vIFJlbW92ZSBleGlzdGluZyBjb250ZW50CiAgICAgICAgICByZW5kZXJlcihkb0FuaW1hdGUpLmxlYXZlKCk7CgogICAgICAgICAgdmlld0xvY2FscyA9IGxvY2FsczsKICAgICAgICAgIHZpZXcuc3RhdGUgPSBsb2NhbHMuJCRzdGF0ZTsKCiAgICAgICAgICByZW5kZXJlcihkb0FuaW1hdGUpLmVudGVyKG5ld0VsZW1lbnQpOwoKICAgICAgICAgIHZhciBsaW5rID0gJGNvbXBpbGUobmV3RWxlbWVudCk7CiAgICAgICAgICB2aWV3U2NvcGUgPSBzY29wZS4kbmV3KCk7CgogICAgICAgICAgdmlld1Njb3BlLiRuYXZEaXJlY3Rpb24gPSB2aWV3UmVnaXN0ZXJEYXRhLm5hdkRpcmVjdGlvbjsKCiAgICAgICAgICBpZiAobG9jYWxzLiQkY29udHJvbGxlcikgewogICAgICAgICAgICBsb2NhbHMuJHNjb3BlID0gdmlld1Njb3BlOwogICAgICAgICAgICB2YXIgY29udHJvbGxlciA9ICRjb250cm9sbGVyKGxvY2Fscy4kJGNvbnRyb2xsZXIsIGxvY2Fscyk7CiAgICAgICAgICAgIGVsZW1lbnQuY2hpbGRyZW4oKS5kYXRhKCckbmdDb250cm9sbGVyQ29udHJvbGxlcicsIGNvbnRyb2xsZXIpOwogICAgICAgICAgfQogICAgICAgICAgbGluayh2aWV3U2NvcGUpOwoKICAgICAgICAgIHZhciB2aWV3SGlzdG9yeURhdGEgPSAkaW9uaWNWaWV3U2VydmljZS5fZ2V0Vmlld0J5SWQodmlld1JlZ2lzdGVyRGF0YS52aWV3SWQpIHx8IHt9OwogICAgICAgICAgdmlld1Njb3BlLiRicm9hZGNhc3QoJyR2aWV3Q29udGVudExvYWRlZCcsIHZpZXdIaXN0b3J5RGF0YSk7CgogICAgICAgICAgaWYgKG9ubG9hZEV4cCkgdmlld1Njb3BlLiRldmFsKG9ubG9hZEV4cCk7CgogICAgICAgICAgbmV3RWxlbWVudCA9IG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH07CiAgcmV0dXJuIGRpcmVjdGl2ZTsKfV0pOwoKCklvbmljTW9kdWxlCgouY29uZmlnKFsnJHByb3ZpZGUnLCBmdW5jdGlvbigkcHJvdmlkZSkgewogICRwcm92aWRlLmRlY29yYXRvcignbmdDbGlja0RpcmVjdGl2ZScsIFsnJGRlbGVnYXRlJywgZnVuY3Rpb24oJGRlbGVnYXRlKSB7CiAgICAvLyBkcm9wIHRoZSBkZWZhdWx0IG5nQ2xpY2sgZGlyZWN0aXZlCiAgICAkZGVsZWdhdGUuc2hpZnQoKTsKICAgIHJldHVybiAkZGVsZWdhdGU7CiAgfV0pOwp9XSkKCi8qKgogKiBAcHJpdmF0ZQogKi8KLmZhY3RvcnkoJyRpb25pY05nQ2xpY2snLCBbJyRwYXJzZScsIGZ1bmN0aW9uKCRwYXJzZSkgewogIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgY2xpY2tFeHByKSB7CiAgICB2YXIgY2xpY2tIYW5kbGVyID0gYW5ndWxhci5pc0Z1bmN0aW9uKGNsaWNrRXhwcikgPwogICAgICBjbGlja0V4cHIgOgogICAgICAkcGFyc2UoY2xpY2tFeHByKTsKCiAgICBlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICBjbGlja0hhbmRsZXIoc2NvcGUsIHskZXZlbnQ6IChldmVudCl9KTsKICAgICAgfSk7CiAgICB9KTsKCiAgICAvLyBIYWNrIGZvciBpT1MgU2FmYXJpJ3MgYmVuZWZpdC4gSXQgZ29lcyBzZWFyY2hpbmcgZm9yIG9uY2xpY2sgaGFuZGxlcnMgYW5kIGlzIGxpYWJsZSB0byBjbGljawogICAgLy8gc29tZXRoaW5nIGVsc2UgbmVhcmJ5LgogICAgZWxlbWVudC5vbmNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHsgfTsKICB9Owp9XSkKCi5kaXJlY3RpdmUoJ25nQ2xpY2snLCBbJyRpb25pY05nQ2xpY2snLCBmdW5jdGlvbigkaW9uaWNOZ0NsaWNrKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAkaW9uaWNOZ0NsaWNrKHNjb3BlLCBlbGVtZW50LCBhdHRyLm5nQ2xpY2spOwogIH07Cn1dKQoKLmRpcmVjdGl2ZSgnaW9uU3RvcEV2ZW50JywgZnVuY3Rpb24gKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgIGVsZW1lbnQuYmluZChhdHRyLmlvblN0b3BFdmVudCwgZXZlbnRTdG9wUHJvcGFnYXRpb24pOwogICAgfQogIH07Cn0pOwpmdW5jdGlvbiBldmVudFN0b3BQcm9wYWdhdGlvbihlKSB7CiAgZS5zdG9wUHJvcGFnYXRpb24oKTsKfQoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblBhbmUKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24gQSBzaW1wbGUgY29udGFpbmVyIHRoYXQgZml0cyBjb250ZW50LCB3aXRoIG5vIHNpZGUgZWZmZWN0cy4gIEFkZHMgdGhlICdwYW5lJyBjbGFzcyB0byB0aGUgZWxlbWVudC4KICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblBhbmUnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3BhbmUnKTsKICAgIH0KICB9Owp9KTsKCi8qCiAqIFdlIGRvbid0IGRvY3VtZW50IHRoZSBpb25Qb3BvdmVyIGRpcmVjdGl2ZSwgd2UgaW5zdGVhZCBkb2N1bWVudAogKiB0aGUgJGlvbmljUG9wb3ZlciBzZXJ2aWNlCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25Qb3BvdmVyJywgW2Z1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgIHJlcGxhY2U6IHRydWUsCiAgICBjb250cm9sbGVyOiBbZnVuY3Rpb24oKXt9XSwKICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0icG9wb3Zlci1iYWNrZHJvcCI+JyArCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0icG9wb3Zlci13cmFwcGVyIiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICAgICAgICc8L2Rpdj4nCiAgfTsKfV0pOwoKSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uUG9wb3ZlclZpZXcnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgZWxlbWVudC5hcHBlbmQoIGFuZ3VsYXIuZWxlbWVudCgnPGRpdiBjbGFzcz0icG9wb3Zlci1hcnJvdyI+PC9kaXY+JykgKTsKICAgICAgZWxlbWVudC5hZGRDbGFzcygncG9wb3ZlcicpOwogICAgfQogIH07Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uUmFkaW8KICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAY29kZXBlbiBzYW9CRwogKiBAZGVzY3JpcHRpb24KICogVGhlIHJhZGlvIGRpcmVjdGl2ZSBpcyBubyBkaWZmZXJlbnQgdGhhbiB0aGUgSFRNTCByYWRpbyBpbnB1dCwgZXhjZXB0IGl0J3Mgc3R5bGVkIGRpZmZlcmVudGx5LgogKgogKiBSYWRpbyBiZWhhdmVzIGxpa2UgYW55IFtBbmd1bGFySlMgcmFkaW9dKGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nL2lucHV0L2lucHV0W3JhZGlvXSkuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxpb24tcmFkaW8gbmctbW9kZWw9ImNob2ljZSIgbmctdmFsdWU9IidBJyI+Q2hvb3NlIEE8L2lvbi1yYWRpbz4KICogPGlvbi1yYWRpbyBuZy1tb2RlbD0iY2hvaWNlIiBuZy12YWx1ZT0iJ0InIj5DaG9vc2UgQjwvaW9uLXJhZGlvPgogKiA8aW9uLXJhZGlvIG5nLW1vZGVsPSJjaG9pY2UiIG5nLXZhbHVlPSInQyciPkNob29zZSBDPC9pb24tcmFkaW8+CiAqIGBgYAogKiAKICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFRoZSBuYW1lIG9mIHRoZSByYWRpbyBpbnB1dC4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gdmFsdWUgVGhlIHZhbHVlIG9mIHRoZSByYWRpbyBpbnB1dC4KICogQHBhcmFtIHtib29sZWFuPX0gZGlzYWJsZWQgVGhlIHN0YXRlIG9mIHRoZSByYWRpbyBpbnB1dC4KICogQHBhcmFtIHtzdHJpbmc9fSBpY29uIFRoZSBpY29uIHRvIHVzZSB3aGVuIHRoZSByYWRpbyBpbnB1dCBpcyBzZWxlY3RlZC4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gbmctdmFsdWUgQW5ndWxhciBlcXVpdmFsZW50IG9mIHRoZSB2YWx1ZSBhdHRyaWJ1dGUuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG5nLW1vZGVsIFRoZSBhbmd1bGFyIG1vZGVsIGZvciB0aGUgcmFkaW8gaW5wdXQuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IG5nLWRpc2FibGVkIEFuZ3VsYXIgZXF1aXZhbGVudCBvZiB0aGUgZGlzYWJsZWQgYXR0cmlidXRlLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBuZy1jaGFuZ2UgVHJpZ2dlcnMgZ2l2ZW4gZXhwcmVzc2lvbiB3aGVuIHJhZGlvIGlucHV0J3MgbW9kZWwgY2hhbmdlcwogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uUmFkaW8nLCBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcGxhY2U6IHRydWUsCiAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgIHRlbXBsYXRlOgogICAgICAnPGxhYmVsIGNsYXNzPSJpdGVtIGl0ZW0tcmFkaW8iPicgKwogICAgICAgICc8aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9InJhZGlvLWdyb3VwIj4nICsKICAgICAgICAnPGRpdiBjbGFzcz0iaXRlbS1jb250ZW50IGRpc2FibGUtcG9pbnRlci1ldmVudHMiIG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICAgJzxpIGNsYXNzPSJyYWRpby1pY29uIGRpc2FibGUtcG9pbnRlci1ldmVudHMgaWNvbiBpb24tY2hlY2ttYXJrIj48L2k+JyArCiAgICAgICc8L2xhYmVsPicsCgogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICBpZihhdHRyLmljb24pIGVsZW1lbnQuY2hpbGRyZW4oKS5lcSgyKS5yZW1vdmVDbGFzcygnaW9uLWNoZWNrbWFyaycpLmFkZENsYXNzKGF0dHIuaWNvbik7CiAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQuZmluZCgnaW5wdXQnKTsKICAgICAgZm9yRWFjaCh7CiAgICAgICAgICAnbmFtZSc6IGF0dHIubmFtZSwKICAgICAgICAgICd2YWx1ZSc6IGF0dHIudmFsdWUsCiAgICAgICAgICAnZGlzYWJsZWQnOiBhdHRyLmRpc2FibGVkLAogICAgICAgICAgJ25nLXZhbHVlJzogYXR0ci5uZ1ZhbHVlLAogICAgICAgICAgJ25nLW1vZGVsJzogYXR0ci5uZ01vZGVsLAogICAgICAgICAgJ25nLWRpc2FibGVkJzogYXR0ci5uZ0Rpc2FibGVkLAogICAgICAgICAgJ25nLWNoYW5nZSc6IGF0dHIubmdDaGFuZ2UKICAgICAgfSwgZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICBpbnB1dC5hdHRyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS5nZXRWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHNjb3BlLm5nVmFsdWUgfHwgYXR0ci52YWx1ZTsKICAgICAgICB9OwogICAgICB9OwogICAgfQogIH07Cn0pOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblJlZnJlc2hlcgogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBFCiAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkNvbnRlbnQsIGlvbmljLmRpcmVjdGl2ZTppb25TY3JvbGwKICogQGRlc2NyaXB0aW9uCiAqIEFsbG93cyB5b3UgdG8gYWRkIHB1bGwtdG8tcmVmcmVzaCB0byBhIHNjcm9sbFZpZXcuCiAqCiAqIFBsYWNlIGl0IGFzIHRoZSBmaXJzdCBjaGlsZCBvZiB5b3VyIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uQ29udGVudH0gb3IKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TY3JvbGx9IGVsZW1lbnQuCiAqCiAqIFdoZW4gcmVmcmVzaGluZyBpcyBjb21wbGV0ZSwgJGJyb2FkY2FzdCB0aGUgJ3Njcm9sbC5yZWZyZXNoQ29tcGxldGUnIGV2ZW50CiAqIGZyb20geW91ciBjb250cm9sbGVyLgogKgogKiBAdXNhZ2UKICoKICogYGBgaHRtbAogKiA8aW9uLWNvbnRlbnQgbmctY29udHJvbGxlcj0iTXlDb250cm9sbGVyIj4KICogICA8aW9uLXJlZnJlc2hlcgogKiAgICAgcHVsbGluZy10ZXh0PSJQdWxsIHRvIHJlZnJlc2guLi4iCiAqICAgICBvbi1yZWZyZXNoPSJkb1JlZnJlc2goKSI+CiAqICAgPC9pb24tcmVmcmVzaGVyPgogKiAgIDxpb24tbGlzdD4KICogICAgIDxpb24taXRlbSBuZy1yZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiPjwvaW9uLWl0ZW0+CiAqICAgPC9pb24tbGlzdD4KICogPC9pb24tY29udGVudD4KICogYGBgCiAqIGBgYGpzCiAqIGFuZ3VsYXIubW9kdWxlKCd0ZXN0QXBwJywgWydpb25pYyddKQogKiAuY29udHJvbGxlcignTXlDb250cm9sbGVyJywgZnVuY3Rpb24oJHNjb3BlLCAkaHR0cCkgewogKiAgICRzY29wZS5pdGVtcyA9IFsxLDIsM107CiAqICAgJHNjb3BlLmRvUmVmcmVzaCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGh0dHAuZ2V0KCcvbmV3LWl0ZW1zJykKICogICAgICAuc3VjY2VzcyhmdW5jdGlvbihuZXdJdGVtcykgewogKiAgICAgICAgJHNjb3BlLml0ZW1zID0gbmV3SXRlbXM7CiAqICAgICAgfSkKICogICAgICAuZmluYWxseShmdW5jdGlvbigpIHsKICogICAgICAgIC8vIFN0b3AgdGhlIGlvbi1yZWZyZXNoZXIgZnJvbSBzcGlubmluZwogKiAgICAgICAgJHNjb3BlLiRicm9hZGNhc3QoJ3Njcm9sbC5yZWZyZXNoQ29tcGxldGUnKTsKICogICAgICB9KTsKICogICB9OwogKiB9KTsKICogYGBgCiAqCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXJlZnJlc2ggQ2FsbGVkIHdoZW4gdGhlIHVzZXIgcHVsbHMgZG93biBlbm91Z2ggYW5kIGxldHMgZ28KICogb2YgdGhlIHJlZnJlc2hlci4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tcHVsbGluZyBDYWxsZWQgd2hlbiB0aGUgdXNlciBzdGFydHMgdG8gcHVsbCBkb3duCiAqIG9uIHRoZSByZWZyZXNoZXIuCiAqIEBwYXJhbSB7c3RyaW5nPX0gcHVsbGluZy1pY29uIFRoZSBpY29uIHRvIGRpc3BsYXkgd2hpbGUgdGhlIHVzZXIgaXMgcHVsbGluZyBkb3duLgogKiBEZWZhdWx0OiAnaW9uLWFycm93LWRvd24tYycuCiAqIEBwYXJhbSB7c3RyaW5nPX0gcHVsbGluZy10ZXh0IFRoZSB0ZXh0IHRvIGRpc3BsYXkgd2hpbGUgdGhlIHVzZXIgaXMgcHVsbGluZyBkb3duLgogKiBAcGFyYW0ge3N0cmluZz19IHJlZnJlc2hpbmctaWNvbiBUaGUgaWNvbiB0byBkaXNwbGF5IGFmdGVyIHVzZXIgbGV0cyBnbyBvZiB0aGUKICogcmVmcmVzaGVyLgogKiBAcGFyYW0ge3N0cmluZz19IHJlZnJlc2hpbmctdGV4dCBUaGUgdGV4dCB0byBkaXNwbGF5IGFmdGVyIHRoZSB1c2VyIGxldHMgZ28gb2YKICogdGhlIHJlZnJlc2hlci4KICoKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblJlZnJlc2hlcicsIFsnJGlvbmljQmluZCcsIGZ1bmN0aW9uKCRpb25pY0JpbmQpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcGxhY2U6IHRydWUsCiAgICByZXF1aXJlOiAnXiRpb25pY1Njcm9sbCcsCiAgICB0ZW1wbGF0ZToKICAgICc8ZGl2IGNsYXNzPSJzY3JvbGwtcmVmcmVzaGVyIiBjb2xsZWN0aW9uLXJlcGVhdC1pZ25vcmU+JyArCiAgICAgICc8ZGl2IGNsYXNzPSJpb25pYy1yZWZyZXNoZXItY29udGVudCIgJyArCiAgICAgICduZy1jbGFzcz0ie1wnaW9uaWMtcmVmcmVzaGVyLXdpdGgtdGV4dFwnOiBwdWxsaW5nVGV4dCB8fCByZWZyZXNoaW5nVGV4dH0iPicgKwogICAgICAgICc8ZGl2IGNsYXNzPSJpY29uLXB1bGxpbmciPicgKwogICAgICAgICAgJzxpIGNsYXNzPSJpY29uIHt7cHVsbGluZ0ljb259fSI+PC9pPicgKwogICAgICAgICc8L2Rpdj4nICsKICAgICAgICAnPGRpdiBjbGFzcz0idGV4dC1wdWxsaW5nIiBuZy1iaW5kLWh0bWw9InB1bGxpbmdUZXh0Ij48L2Rpdj4nICsKICAgICAgICAnPGkgY2xhc3M9Imljb24ge3tyZWZyZXNoaW5nSWNvbn19IGljb24tcmVmcmVzaGluZyI+PC9pPicgKwogICAgICAgICc8ZGl2IGNsYXNzPSJ0ZXh0LXJlZnJlc2hpbmciIG5nLWJpbmQtaHRtbD0icmVmcmVzaGluZ1RleHQiPjwvZGl2PicgKwogICAgICAnPC9kaXY+JyArCiAgICAnPC9kaXY+JywKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgaWYgKGFuZ3VsYXIuaXNVbmRlZmluZWQoJGF0dHJzLnB1bGxpbmdJY29uKSkgewogICAgICAgICRhdHRycy4kc2V0KCdwdWxsaW5nSWNvbicsICdpb24tYXJyb3ctZG93bi1jJyk7CiAgICAgIH0KICAgICAgaWYgKGFuZ3VsYXIuaXNVbmRlZmluZWQoJGF0dHJzLnJlZnJlc2hpbmdJY29uKSkgewogICAgICAgICRhdHRycy4kc2V0KCdyZWZyZXNoaW5nSWNvbicsICdpb24tbG9hZGluZy1kJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgc2Nyb2xsQ3RybCkgewogICAgICAgICRpb25pY0JpbmQoJHNjb3BlLCAkYXR0cnMsIHsKICAgICAgICAgIHB1bGxpbmdJY29uOiAnQCcsCiAgICAgICAgICBwdWxsaW5nVGV4dDogJ0AnLAogICAgICAgICAgcmVmcmVzaGluZ0ljb246ICdAJywKICAgICAgICAgIHJlZnJlc2hpbmdUZXh0OiAnQCcsCiAgICAgICAgICAkb25SZWZyZXNoOiAnJm9uUmVmcmVzaCcsCiAgICAgICAgICAkb25QdWxsaW5nOiAnJm9uUHVsbGluZycKICAgICAgICB9KTsKCiAgICAgICAgc2Nyb2xsQ3RybC5fc2V0UmVmcmVzaGVyKCRzY29wZSwgJGVsZW1lbnRbMF0pOwogICAgICAgICRzY29wZS4kb24oJ3Njcm9sbC5yZWZyZXNoQ29tcGxldGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICRzY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzY3JvbGxDdHJsLnNjcm9sbFZpZXcuZmluaXNoUHVsbFRvUmVmcmVzaCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfTsKfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uU2Nyb2xsCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljU2Nyb2xsRGVsZWdhdGUKICogQGNvZGVwZW4gbXdGdWgKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYSBzY3JvbGxhYmxlIGNvbnRhaW5lciBmb3IgYWxsIGNvbnRlbnQgaW5zaWRlLgogKgogKiBAdXNhZ2UKICoKICogQmFzaWMgdXNhZ2U6CiAqCiAqIGBgYGh0bWwKICogPGlvbi1zY3JvbGwgem9vbWluZz0idHJ1ZSIgZGlyZWN0aW9uPSJ4eSIgc3R5bGU9IndpZHRoOiA1MDBweDsgaGVpZ2h0OiA1MDBweCI+CiAqICAgPGRpdiBzdHlsZT0id2lkdGg6IDUwMDBweDsgaGVpZ2h0OiA1MDAwcHg7IGJhY2tncm91bmQ6IHVybCgnaHR0cHM6Ly91cGxvYWQud2lraW1lZGlhLm9yZy93aWtpcGVkaWEvY29tbW9ucy9hL2FkL0V1cm9wZV9nZW9sb2dpY2FsX21hcC1lbi5qcGcnKSByZXBlYXQiPjwvZGl2PgogKiAgPC9pb24tc2Nyb2xsPgogKiBgYGAKICoKICogTm90ZSB0aGF0IGl0J3MgaW1wb3J0YW50IHRvIHNldCB0aGUgaGVpZ2h0IG9mIHRoZSBzY3JvbGwgYm94IGFzIHdlbGwgYXMgdGhlIGhlaWdodCBvZiB0aGUgaW5uZXIKICogY29udGVudCB0byBlbmFibGUgc2Nyb2xsaW5nLiBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIHRvIGhhdmUgZnVsbCBjb250cm9sIG92ZXIgc2Nyb2xsYWJsZSBhcmVhcy4KICoKICogSWYgeW91J2QganVzdCBsaWtlIHRvIGhhdmUgYSBjZW50ZXIgY29udGVudCBzY3JvbGxpbmcgYXJlYSwgdXNlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uQ29udGVudH0gaW5zdGVhZC4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBkZWxlZ2F0ZS1oYW5kbGUgVGhlIGhhbmRsZSB1c2VkIHRvIGlkZW50aWZ5IHRoaXMgc2Nyb2xsVmlldwogKiB3aXRoIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1Njcm9sbERlbGVnYXRlfS4KICogQHBhcmFtIHtzdHJpbmc9fSBkaXJlY3Rpb24gV2hpY2ggd2F5IHRvIHNjcm9sbC4gJ3gnIG9yICd5JyBvciAneHknLiBEZWZhdWx0ICd5Jy4KICogQHBhcmFtIHtib29sZWFuPX0gbG9ja2luZyBXaGV0aGVyIHRvIGxvY2sgc2Nyb2xsaW5nIGluIG9uZSBkaXJlY3Rpb24gYXQgYSB0aW1lLiBVc2VmdWwgdG8gc2V0IHRvIGZhbHNlIHdoZW4gem9vbWVkIGluIG9yIHNjcm9sbGluZyBpbiB0d28gZGlyZWN0aW9ucy4gRGVmYXVsdCB0cnVlLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBwYWdpbmcgV2hldGhlciB0byBzY3JvbGwgd2l0aCBwYWdpbmcuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXJlZnJlc2ggQ2FsbGVkIG9uIHB1bGwtdG8tcmVmcmVzaCwgdHJpZ2dlcmVkIGJ5IGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uUmVmcmVzaGVyfS4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tc2Nyb2xsIENhbGxlZCB3aGVuZXZlciB0aGUgdXNlciBzY3JvbGxzLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBzY3JvbGxiYXIteCBXaGV0aGVyIHRvIHNob3cgdGhlIGhvcml6b250YWwgc2Nyb2xsYmFyLiBEZWZhdWx0IHRydWUuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IHNjcm9sbGJhci15IFdoZXRoZXIgdG8gc2hvdyB0aGUgdmVydGljYWwgc2Nyb2xsYmFyLiBEZWZhdWx0IHRydWUuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IHpvb21pbmcgV2hldGhlciB0byBzdXBwb3J0IHBpbmNoLXRvLXpvb20KICogQHBhcmFtIHtpbnRlZ2VyPX0gbWluLXpvb20gVGhlIHNtYWxsZXN0IHpvb20gYW1vdW50IGFsbG93ZWQgKGRlZmF1bHQgaXMgMC41KQogKiBAcGFyYW0ge2ludGVnZXI9fSBtYXgtem9vbSBUaGUgbGFyZ2VzdCB6b29tIGFtb3VudCBhbGxvd2VkIChkZWZhdWx0IGlzIDMpCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGhhcy1ib3VuY2luZyBXaGV0aGVyIHRvIGFsbG93IHNjcm9sbGluZyB0byBib3VuY2UgcGFzdCB0aGUgZWRnZXMKICogb2YgdGhlIGNvbnRlbnQuICBEZWZhdWx0cyB0byB0cnVlIG9uIGlPUywgZmFsc2Ugb24gQW5kcm9pZC4KICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblNjcm9sbCcsIFsKICAnJHRpbWVvdXQnLAogICckY29udHJvbGxlcicsCiAgJyRpb25pY0JpbmQnLApmdW5jdGlvbigkdGltZW91dCwgJGNvbnRyb2xsZXIsICRpb25pY0JpbmQpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHNjb3BlOiB0cnVlLAogICAgY29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgZWxlbWVudC5hZGRDbGFzcygnc2Nyb2xsLXZpZXcgaW9uaWMtc2Nyb2xsJyk7CgogICAgICAvL1dlIGNhbm5vdCB0cmFuc2NsdWRlIGhlcmUgYmVjYXVzZSBpdCBicmVha3MgZWxlbWVudC5kYXRhKCkgaW5oZXJpdGFuY2Ugb24gY29tcGlsZQogICAgICB2YXIgaW5uZXJFbGVtZW50ID0ganFMaXRlKCc8ZGl2IGNsYXNzPSJzY3JvbGwiPjwvZGl2PicpOwogICAgICBpbm5lckVsZW1lbnQuYXBwZW5kKGVsZW1lbnQuY29udGVudHMoKSk7CiAgICAgIGVsZW1lbnQuYXBwZW5kKGlubmVyRWxlbWVudCk7CgogICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgIHZhciBzY3JvbGxWaWV3LCBzY3JvbGxDdHJsOwoKICAgICAgICAkaW9uaWNCaW5kKCRzY29wZSwgJGF0dHIsIHsKICAgICAgICAgIGRpcmVjdGlvbjogJ0AnLAogICAgICAgICAgcGFnaW5nOiAnQCcsCiAgICAgICAgICAkb25TY3JvbGw6ICcmb25TY3JvbGwnLAogICAgICAgICAgc2Nyb2xsOiAnQCcsCiAgICAgICAgICBzY3JvbGxiYXJYOiAnQCcsCiAgICAgICAgICBzY3JvbGxiYXJZOiAnQCcsCiAgICAgICAgICB6b29taW5nOiAnQCcsCiAgICAgICAgICBtaW5ab29tOiAnQCcsCiAgICAgICAgICBtYXhab29tOiAnQCcKICAgICAgICB9KTsKICAgICAgICAkc2NvcGUuZGlyZWN0aW9uID0gJHNjb3BlLmRpcmVjdGlvbiB8fCAneSc7CgogICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZCgkYXR0ci5wYWRkaW5nKSkgewogICAgICAgICAgJHNjb3BlLiR3YXRjaCgkYXR0ci5wYWRkaW5nLCBmdW5jdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgaW5uZXJFbGVtZW50LnRvZ2dsZUNsYXNzKCdwYWRkaW5nJywgISFuZXdWYWwpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmKCRzY29wZS4kZXZhbCgkc2NvcGUucGFnaW5nKSA9PT0gdHJ1ZSkgewogICAgICAgICAgaW5uZXJFbGVtZW50LmFkZENsYXNzKCdzY3JvbGwtcGFnaW5nJyk7CiAgICAgICAgfQoKICAgICAgICBpZighJHNjb3BlLmRpcmVjdGlvbikgeyAkc2NvcGUuZGlyZWN0aW9uID0gJ3knOyB9CiAgICAgICAgdmFyIGlzUGFnaW5nID0gJHNjb3BlLiRldmFsKCRzY29wZS5wYWdpbmcpID09PSB0cnVlOwoKICAgICAgICB2YXIgc2Nyb2xsVmlld09wdGlvbnM9IHsKICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgIGRlbGVnYXRlSGFuZGxlOiAkYXR0ci5kZWxlZ2F0ZUhhbmRsZSwKICAgICAgICAgIGxvY2tpbmc6ICgkYXR0ci5sb2NraW5nIHx8ICd0cnVlJykgPT09ICd0cnVlJywKICAgICAgICAgIGJvdW5jaW5nOiAkc2NvcGUuJGV2YWwoJGF0dHIuaGFzQm91bmNpbmcpLAogICAgICAgICAgcGFnaW5nOiBpc1BhZ2luZywKICAgICAgICAgIHNjcm9sbGJhclg6ICRzY29wZS4kZXZhbCgkc2NvcGUuc2Nyb2xsYmFyWCkgIT09IGZhbHNlLAogICAgICAgICAgc2Nyb2xsYmFyWTogJHNjb3BlLiRldmFsKCRzY29wZS5zY3JvbGxiYXJZKSAhPT0gZmFsc2UsCiAgICAgICAgICBzY3JvbGxpbmdYOiAkc2NvcGUuZGlyZWN0aW9uLmluZGV4T2YoJ3gnKSA+PSAwLAogICAgICAgICAgc2Nyb2xsaW5nWTogJHNjb3BlLmRpcmVjdGlvbi5pbmRleE9mKCd5JykgPj0gMCwKICAgICAgICAgIHpvb21pbmc6ICRzY29wZS4kZXZhbCgkc2NvcGUuem9vbWluZykgPT09IHRydWUsCiAgICAgICAgICBtYXhab29tOiAkc2NvcGUuJGV2YWwoJHNjb3BlLm1heFpvb20pIHx8IDMsCiAgICAgICAgICBtaW5ab29tOiAkc2NvcGUuJGV2YWwoJHNjb3BlLm1pblpvb20pIHx8IDAuNQogICAgICAgIH07CiAgICAgICAgaWYgKGlzUGFnaW5nKSB7CiAgICAgICAgICBzY3JvbGxWaWV3T3B0aW9ucy5zcGVlZE11bHRpcGxpZXIgPSAwLjg7CiAgICAgICAgICBzY3JvbGxWaWV3T3B0aW9ucy5ib3VuY2luZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgc2Nyb2xsQ3RybCA9ICRjb250cm9sbGVyKCckaW9uaWNTY3JvbGwnLCB7CiAgICAgICAgICAkc2NvcGU6ICRzY29wZSwKICAgICAgICAgIHNjcm9sbFZpZXdPcHRpb25zOiBzY3JvbGxWaWV3T3B0aW9ucwogICAgICAgIH0pOwogICAgICAgIHNjcm9sbFZpZXcgPSAkc2NvcGUuJHBhcmVudC5zY3JvbGxWaWV3ID0gc2Nyb2xsQ3RybC5zY3JvbGxWaWV3OwogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uU2lkZU1lbnUKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXMKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgY29udGFpbmVyIGZvciBhIHNpZGUgbWVudSwgc2libGluZyB0byBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51Q29udGVudH0gZGlyZWN0aXZlLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8aW9uLXNpZGUtbWVudQogKiAgIHNpZGU9ImxlZnQiCiAqICAgd2lkdGg9Im15V2lkdGhWYWx1ZSArIDIwIgogKiAgIGlzLWVuYWJsZWQ9InNob3VsZExlZnRTaWRlTWVudUJlRW5hYmxlZCgpIj4KICogPC9pb24tc2lkZS1tZW51PgogKiBgYGAKICogRm9yIGEgY29tcGxldGUgc2lkZSBtZW51IGV4YW1wbGUsIHNlZSB0aGUKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXN9IGRvY3VtZW50YXRpb24uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBzaWRlIFdoaWNoIHNpZGUgdGhlIHNpZGUgbWVudSBpcyBjdXJyZW50bHkgb24uICBBbGxvd2VkIHZhbHVlczogJ2xlZnQnIG9yICdyaWdodCcuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IGlzLWVuYWJsZWQgV2hldGhlciB0aGlzIHNpZGUgbWVudSBpcyBlbmFibGVkLgogKiBAcGFyYW0ge251bWJlcj19IHdpZHRoIEhvdyBtYW55IHBpeGVscyB3aWRlIHRoZSBzaWRlIG1lbnUgc2hvdWxkIGJlLiAgRGVmYXVsdHMgdG8gMjc1LgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uU2lkZU1lbnUnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6ICdeaW9uU2lkZU1lbnVzJywKICAgIHNjb3BlOiB0cnVlLAogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICBhbmd1bGFyLmlzVW5kZWZpbmVkKGF0dHIuaXNFbmFibGVkKSAmJiBhdHRyLiRzZXQoJ2lzRW5hYmxlZCcsICd0cnVlJyk7CiAgICAgIGFuZ3VsYXIuaXNVbmRlZmluZWQoYXR0ci53aWR0aCkgJiYgYXR0ci4kc2V0KCd3aWR0aCcsICcyNzUnKTsKCiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ21lbnUgbWVudS0nICsgYXR0ci5zaWRlKTsKCiAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2lkZU1lbnVDdHJsKSB7CiAgICAgICAgJHNjb3BlLnNpZGUgPSAkYXR0ci5zaWRlIHx8ICdsZWZ0JzsKCiAgICAgICAgdmFyIHNpZGVNZW51ID0gc2lkZU1lbnVDdHJsWyRzY29wZS5zaWRlXSA9IG5ldyBpb25pYy52aWV3cy5TaWRlTWVudSh7CiAgICAgICAgICB3aWR0aDogMjc1LAogICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgaXNFbmFibGVkOiB0cnVlCiAgICAgICAgfSk7CgogICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIud2lkdGgsIGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdmFyIG51bWJlclZhbCA9ICt2YWw7CiAgICAgICAgICBpZiAobnVtYmVyVmFsICYmIG51bWJlclZhbCA9PSB2YWwpIHsKICAgICAgICAgICAgc2lkZU1lbnUuc2V0V2lkdGgoK3ZhbCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgJHNjb3BlLiR3YXRjaCgkYXR0ci5pc0VuYWJsZWQsIGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgc2lkZU1lbnUuc2V0SXNFbmFibGVkKCEhdmFsKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9Owp9KTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpb25TaWRlTWVudUNvbnRlbnQKICogQG1vZHVsZSBpb25pYwogKiBAcmVzdHJpY3QgRQogKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXMKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgY29udGFpbmVyIGZvciB0aGUgbWFpbiB2aXNpYmxlIGNvbnRlbnQsIHNpYmxpbmcgdG8gb25lIG9yIG1vcmUKICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudX0gZGlyZWN0aXZlcy4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi1zaWRlLW1lbnUtY29udGVudAogKiAgIGVkZ2UtZHJhZy10aHJlc2hvbGQ9InRydWUiCiAqICAgZHJhZy1jb250ZW50PSJ0cnVlIj4KICogPC9pb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAqIGBgYAogKiBGb3IgYSBjb21wbGV0ZSBzaWRlIG1lbnUgZXhhbXBsZSwgc2VlIHRoZQogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51c30gZG9jdW1lbnRhdGlvbi4KICoKICogQHBhcmFtIHtib29sZWFuPX0gZHJhZy1jb250ZW50IFdoZXRoZXIgdGhlIGNvbnRlbnQgY2FuIGJlIGRyYWdnZWQuIERlZmF1bHQgdHJ1ZS4KICogQHBhcmFtIHtib29sZWFufG51bWJlcj19IGVkZ2UtZHJhZy10aHJlc2hvbGQgV2hldGhlciB0aGUgY29udGVudCBkcmFnIGNhbiBvbmx5IHN0YXJ0IGlmIGl0IGlzIGJlbG93IGEgY2VydGFpbiB0aHJlc2hvbGQgZGlzdGFuY2UgZnJvbSB0aGUgZWRnZSBvZiB0aGUgc2NyZWVuLiAgRGVmYXVsdCBmYWxzZS4gQWNjZXB0cyB0aHJlZSB0eXBlcyBvZiB2YWx1ZXM6CiAgICogIC0gSWYgYSBub24temVybyBudW1iZXIgaXMgZ2l2ZW4sIHRoYXQgbWFueSBwaXhlbHMgaXMgdXNlZCBhcyB0aGUgbWF4aW11bSBhbGxvd2VkIGRpc3RhbmNlIGZyb20gdGhlIGVkZ2UgdGhhdCBzdGFydHMgZHJhZ2dpbmcgdGhlIHNpZGUgbWVudS4KICAgKiAgLSBJZiB0cnVlIGlzIGdpdmVuLCB0aGUgZGVmYXVsdCBudW1iZXIgb2YgcGl4ZWxzICgyNSkgaXMgdXNlZCBhcyB0aGUgbWF4aW11bSBhbGxvd2VkIGRpc3RhbmNlLgogICAqICAtIElmIGZhbHNlIG9yIDAgaXMgZ2l2ZW4sIHRoZSBlZGdlIGRyYWcgdGhyZXNob2xkIGlzIGRpc2FibGVkLCBhbmQgZHJhZ2dpbmcgZnJvbSBhbnl3aGVyZSBvbiB0aGUgY29udGVudCBpcyBhbGxvd2VkLgogKgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uU2lkZU1lbnVDb250ZW50JywgWwogICckdGltZW91dCcsCiAgJyRpb25pY0dlc3R1cmUnLAogICckd2luZG93JywKZnVuY3Rpb24oJHRpbWVvdXQsICRpb25pY0dlc3R1cmUsICR3aW5kb3cpIHsKCiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRUEnLCAvL0RFUFJFQ0FURUQgJ0EnCiAgICByZXF1aXJlOiAnXmlvblNpZGVNZW51cycsCiAgICBzY29wZTogdHJ1ZSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNpZGVNZW51Q3RybCkgewogICAgICAgIHZhciBzdGFydENvb3JkID0gbnVsbDsKICAgICAgICB2YXIgcHJpbWFyeVNjcm9sbEF4aXMgPSBudWxsOwoKICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygnbWVudS1jb250ZW50IHBhbmUnKTsKCiAgICAgICAgaWYgKGlzRGVmaW5lZChhdHRyLmRyYWdDb250ZW50KSkgewogICAgICAgICAgJHNjb3BlLiR3YXRjaChhdHRyLmRyYWdDb250ZW50LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBzaWRlTWVudUN0cmwuY2FuRHJhZ0NvbnRlbnQodmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNpZGVNZW51Q3RybC5jYW5EcmFnQ29udGVudCh0cnVlKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc0RlZmluZWQoYXR0ci5lZGdlRHJhZ1RocmVzaG9sZCkpIHsKICAgICAgICAgICRzY29wZS4kd2F0Y2goYXR0ci5lZGdlRHJhZ1RocmVzaG9sZCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgc2lkZU1lbnVDdHJsLmVkZ2VEcmFnVGhyZXNob2xkKHZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gTGlzdGVuIGZvciB0YXBzIG9uIHRoZSBjb250ZW50IHRvIGNsb3NlIHRoZSBtZW51CiAgICAgICAgZnVuY3Rpb24gb25Db250ZW50VGFwKGdlc3R1cmVFdnQpIHsKICAgICAgICAgIGlmKHNpZGVNZW51Q3RybC5nZXRPcGVuQW1vdW50KCkgIT09IDApIHsKICAgICAgICAgICAgc2lkZU1lbnVDdHJsLmNsb3NlKCk7CiAgICAgICAgICAgIGdlc3R1cmVFdnQuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBzdGFydENvb3JkID0gbnVsbDsKICAgICAgICAgICAgcHJpbWFyeVNjcm9sbEF4aXMgPSBudWxsOwogICAgICAgICAgfSBlbHNlIGlmKCFzdGFydENvb3JkKSB7CiAgICAgICAgICAgIHN0YXJ0Q29vcmQgPSBpb25pYy50YXAucG9pbnRlckNvb3JkKGdlc3R1cmVFdnQuZ2VzdHVyZS5zcmNFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbkRyYWdYKGUpIHsKICAgICAgICAgIGlmKCFzaWRlTWVudUN0cmwuaXNEcmFnZ2FibGVUYXJnZXQoZSkpIHJldHVybjsKCiAgICAgICAgICBpZiggZ2V0UHJpbWFyeVNjcm9sbEF4aXMoZSkgPT0gJ3gnKSB7CiAgICAgICAgICAgIHNpZGVNZW51Q3RybC5faGFuZGxlRHJhZyhlKTsKICAgICAgICAgICAgZS5nZXN0dXJlLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbkRyYWdZKGUpIHsKICAgICAgICAgIGlmKCBnZXRQcmltYXJ5U2Nyb2xsQXhpcyhlKSA9PSAneCcgKSB7CiAgICAgICAgICAgIGUuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25EcmFnUmVsZWFzZShlKSB7CiAgICAgICAgICBzaWRlTWVudUN0cmwuX2VuZERyYWcoZSk7CiAgICAgICAgICBzdGFydENvb3JkID0gbnVsbDsKICAgICAgICAgIHByaW1hcnlTY3JvbGxBeGlzID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldFByaW1hcnlTY3JvbGxBeGlzKGdlc3R1cmVFdnQpIHsKICAgICAgICAgIC8vIGdldHMgd2hldGhlciB0aGUgdXNlciBpcyBwcmltYXJpbHkgc2Nyb2xsaW5nIG9uIHRoZSBYIG9yIFkKICAgICAgICAgIC8vIElmIGEgbWFqb3JpdHkgb2YgdGhlIGRyYWcgaGFzIGJlZW4gb24gdGhlIFkgc2luY2UgdGhlIHN0YXJ0IG9mCiAgICAgICAgICAvLyB0aGUgZHJhZywgYnV0IHRoZSBYIGhhcyBtb3ZlZCBhIGxpdHRsZSBiaXQsIGl0J3Mgc3RpbGwgYSBZIGRyYWcKCiAgICAgICAgICBpZihwcmltYXJ5U2Nyb2xsQXhpcykgewogICAgICAgICAgICAvLyB3ZSBhbHJlYWR5IGZpZ3VyZWQgb3V0IHdoaWNoIHdheSB0aGV5J3JlIHNjcm9sbGluZwogICAgICAgICAgICByZXR1cm4gcHJpbWFyeVNjcm9sbEF4aXM7CiAgICAgICAgICB9CgogICAgICAgICAgaWYoZ2VzdHVyZUV2dCAmJiBnZXN0dXJlRXZ0Lmdlc3R1cmUpIHsKCiAgICAgICAgICAgIGlmKCFzdGFydENvb3JkKSB7CiAgICAgICAgICAgICAgLy8gZ2V0IHRoZSBzdGFydGluZyBwb2ludAogICAgICAgICAgICAgIHN0YXJ0Q29vcmQgPSBpb25pYy50YXAucG9pbnRlckNvb3JkKGdlc3R1cmVFdnQuZ2VzdHVyZS5zcmNFdmVudCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIHdlIGFscmVhZHkgaGF2ZSBhIHN0YXJ0aW5nIHBvaW50LCBmaWd1cmUgb3V0IHdoaWNoIGRpcmVjdGlvbiB0aGV5J3JlIGdvaW5nCiAgICAgICAgICAgICAgdmFyIGVuZENvb3JkID0gaW9uaWMudGFwLnBvaW50ZXJDb29yZChnZXN0dXJlRXZ0Lmdlc3R1cmUuc3JjRXZlbnQpOwoKICAgICAgICAgICAgICB2YXIgeERpc3RhbmNlID0gTWF0aC5hYnMoZW5kQ29vcmQueCAtIHN0YXJ0Q29vcmQueCk7CiAgICAgICAgICAgICAgdmFyIHlEaXN0YW5jZSA9IE1hdGguYWJzKGVuZENvb3JkLnkgLSBzdGFydENvb3JkLnkpOwoKICAgICAgICAgICAgICB2YXIgc2Nyb2xsQXhpcyA9ICggeERpc3RhbmNlIDwgeURpc3RhbmNlID8gJ3knIDogJ3gnICk7CgogICAgICAgICAgICAgIGlmKCBNYXRoLm1heCh4RGlzdGFuY2UsIHlEaXN0YW5jZSkgPiAzMCApIHsKICAgICAgICAgICAgICAgIC8vIG9rLCB3ZSBwcmV0dHkgbXVjaCBrbm93IHdoaWNoIHdheSB0aGV5J3JlIGdvaW5nCiAgICAgICAgICAgICAgICAvLyBsZXQncyBsb2NrIGl0IGluCiAgICAgICAgICAgICAgICBwcmltYXJ5U2Nyb2xsQXhpcyA9IHNjcm9sbEF4aXM7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gc2Nyb2xsQXhpczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICd4JzsKICAgICAgICB9CgogICAgICAgIHZhciBjb250ZW50ID0gewogICAgICAgICAgZWxlbWVudDogZWxlbWVudFswXSwKICAgICAgICAgIG9uRHJhZzogZnVuY3Rpb24oZSkge30sCiAgICAgICAgICBlbmREcmFnOiBmdW5jdGlvbihlKSB7fSwKICAgICAgICAgIGdldFRyYW5zbGF0ZVg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gJHNjb3BlLnNpZGVNZW51Q29udGVudFRyYW5zbGF0ZVggfHwgMDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXRUcmFuc2xhdGVYOiBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKGFtb3VudCkgewogICAgICAgICAgICB2YXIgeFRyYW5zZm9ybSA9IGNvbnRlbnQub2Zmc2V0WCArIGFtb3VudDsKICAgICAgICAgICAgJGVsZW1lbnRbMF0uc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoJyArIHhUcmFuc2Zvcm0gKyAncHgsMCwwKSc7CiAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRzY29wZS5zaWRlTWVudUNvbnRlbnRUcmFuc2xhdGVYID0gYW1vdW50OwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pLAogICAgICAgICAgc2V0TWFyZ2luTGVmdDogaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShmdW5jdGlvbihhbW91bnQpIHsKICAgICAgICAgICAgaWYoYW1vdW50KSB7CiAgICAgICAgICAgICAgJGVsZW1lbnRbMF0uc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoJyArIGFtb3VudCArICdweCwwLDApJzsKICAgICAgICAgICAgICAkZWxlbWVudFswXS5zdHlsZS53aWR0aCA9ICgkd2luZG93LmlubmVyV2lkdGggLSBhbW91bnQpICsgJ3B4JzsKICAgICAgICAgICAgICBjb250ZW50Lm9mZnNldFggPSBhbW91bnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJGVsZW1lbnRbMF0uc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoMCwwLDApJzsKICAgICAgICAgICAgICAkZWxlbWVudFswXS5zdHlsZS53aWR0aCA9ICcnOwogICAgICAgICAgICAgIGNvbnRlbnQub2Zmc2V0WCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pLAogICAgICAgICAgZW5hYmxlQW5pbWF0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHNjb3BlLmFuaW1hdGlvbkVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAkZWxlbWVudFswXS5jbGFzc0xpc3QuYWRkKCdtZW51LWFuaW1hdGVkJyk7CiAgICAgICAgICB9LAogICAgICAgICAgZGlzYWJsZUFuaW1hdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRzY29wZS5hbmltYXRpb25FbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICRlbGVtZW50WzBdLmNsYXNzTGlzdC5yZW1vdmUoJ21lbnUtYW5pbWF0ZWQnKTsKICAgICAgICAgIH0sCiAgICAgICAgICBvZmZzZXRYOiAwCiAgICAgICAgfTsKCiAgICAgICAgc2lkZU1lbnVDdHJsLnNldENvbnRlbnQoY29udGVudCk7CgogICAgICAgIC8vIGFkZCBnZXN0dXJlIGhhbmRsZXJzCiAgICAgICAgdmFyIGdlc3R1cmVPcHRzID0geyBzdG9wX2Jyb3dzZXJfYmVoYXZpb3I6IGZhbHNlIH07CiAgICAgICAgdmFyIGNvbnRlbnRUYXBHZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbigndGFwJywgb25Db250ZW50VGFwLCAkZWxlbWVudCwgZ2VzdHVyZU9wdHMpOwogICAgICAgIHZhciBkcmFnUmlnaHRHZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbignZHJhZ3JpZ2h0Jywgb25EcmFnWCwgJGVsZW1lbnQsIGdlc3R1cmVPcHRzKTsKICAgICAgICB2YXIgZHJhZ0xlZnRHZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbignZHJhZ2xlZnQnLCBvbkRyYWdYLCAkZWxlbWVudCwgZ2VzdHVyZU9wdHMpOwogICAgICAgIHZhciBkcmFnVXBHZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbignZHJhZ3VwJywgb25EcmFnWSwgJGVsZW1lbnQsIGdlc3R1cmVPcHRzKTsKICAgICAgICB2YXIgZHJhZ0Rvd25HZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbignZHJhZ2Rvd24nLCBvbkRyYWdZLCAkZWxlbWVudCwgZ2VzdHVyZU9wdHMpOwogICAgICAgIHZhciByZWxlYXNlR2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ3JlbGVhc2UnLCBvbkRyYWdSZWxlYXNlLCAkZWxlbWVudCwgZ2VzdHVyZU9wdHMpOwoKICAgICAgICAvLyBDbGVhbnVwCiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICRpb25pY0dlc3R1cmUub2ZmKGRyYWdMZWZ0R2VzdHVyZSwgJ2RyYWdsZWZ0Jywgb25EcmFnWCk7CiAgICAgICAgICAkaW9uaWNHZXN0dXJlLm9mZihkcmFnUmlnaHRHZXN0dXJlLCAnZHJhZ3JpZ2h0Jywgb25EcmFnWCk7CiAgICAgICAgICAkaW9uaWNHZXN0dXJlLm9mZihkcmFnVXBHZXN0dXJlLCAnZHJhZ3VwJywgb25EcmFnWSk7CiAgICAgICAgICAkaW9uaWNHZXN0dXJlLm9mZihkcmFnRG93bkdlc3R1cmUsICdkcmFnZG93bicsIG9uRHJhZ1kpOwogICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYocmVsZWFzZUdlc3R1cmUsICdyZWxlYXNlJywgb25EcmFnUmVsZWFzZSk7CiAgICAgICAgICAkaW9uaWNHZXN0dXJlLm9mZihjb250ZW50VGFwR2VzdHVyZSwgJ3RhcCcsIG9uQ29udGVudFRhcCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9Owp9XSk7CgpJb25pY01vZHVsZQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uU2lkZU1lbnVzCiAqIEBtb2R1bGUgaW9uaWMKICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljU2lkZU1lbnVEZWxlZ2F0ZQogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogQSBjb250YWluZXIgZWxlbWVudCBmb3Igc2lkZSBtZW51KHMpIGFuZCB0aGUgbWFpbiBjb250ZW50LiBBbGxvd3MgdGhlIGxlZnQKICogYW5kL29yIHJpZ2h0IHNpZGUgbWVudSB0byBiZSB0b2dnbGVkIGJ5IGRyYWdnaW5nIHRoZSBtYWluIGNvbnRlbnQgYXJlYSBzaWRlCiAqIHRvIHNpZGUuCiAqCiAqIFRvIGF1dG9tYXRpY2FsbHkgY2xvc2UgYW4gb3BlbmVkIG1lbnUgeW91IGNhbiBhZGQgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6bWVudUNsb3NlfQogKiBhdHRyaWJ1dGUgZGlyZWN0aXZlLiBJbmNsdWRpbmcgdGhlIGBtZW51LWNsb3NlYCBhdHRyaWJ1dGUgaXMgdXN1YWxseSBhZGRlZCB0bwogKiBsaW5rcyBhbmQgYnV0dG9ucyB3aXRoaW4gYGlvbi1zaWRlLW1lbnVgIGNvbnRlbnQsIHNvIHRoYXQgd2hlbiB0aGUgZWxlbWVudCBpcwogKiBjbGlja2VkIHRoZW4gdGhlIG9wZW5lZCBzaWRlIG1lbnUgd2lsbCBhdXRvbWF0aWNhbGx5IGNsb3NlLgogKgogKiBCeSBkZWZhdWx0LCBzaWRlIG1lbnVzIGFyZSBoaWRkZW4gdW5kZXJuZWF0aCBpdHMgc2lkZSBtZW51IGNvbnRlbnQsIGFuZCBjYW4gYmUgb3BlbmVkIGJ5CiAqIGVpdGhlciBzd2lwaW5nIHRoZSBjb250ZW50IGxlZnQgb3IgcmlnaHQsIG9yIHRvZ2dsaW5nIGEgYnV0dG9uIHRvIHNob3cgdGhlIHNpZGUgbWVudS4gSG93ZXZlciwKICogYnkgYWRkaW5nIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmV4cG9zZUFzaWRlV2hlbn0gYXR0cmlidXRlIGRpcmVjdGl2ZSB0byBhbgogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51fSBlbGVtZW50IGRpcmVjdGl2ZSwgYSBzaWRlIG1lbnUgY2FuIGJlIGdpdmVuIGluc3RydWN0aW9ucwogKiBvbiAid2hlbiIgdGhlIG1lbnUgc2hvdWxkIGJlIGV4cG9zZWQgKGFsd2F5cyB2aWV3YWJsZSkuCiAqCiAqICFbU2lkZSBNZW51XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tLnMzLmFtYXpvbmF3cy5jb20vZG9jcy9jb250cm9sbGVycy9zaWRlbWVudS5naWYpCiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHNpZGUgbWVudXMsIGNoZWNrIG91dDoKICoKICogLSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51Q29udGVudH0KICogLSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51fQogKiAtIHtAbGluayBpb25pYy5kaXJlY3RpdmU6bWVudUNsb3NlfQogKiAtIHtAbGluayBpb25pYy5kaXJlY3RpdmU6ZXhwb3NlQXNpZGVXaGVufQogKgogKiBAdXNhZ2UKICogVG8gdXNlIHNpZGUgbWVudXMsIGFkZCBhbiBgPGlvbi1zaWRlLW1lbnVzPmAgcGFyZW50IGVsZW1lbnQsCiAqIGFuIGA8aW9uLXNpZGUtbWVudS1jb250ZW50PmAgZm9yIHRoZSBjZW50ZXIgY29udGVudCwKICogYW5kIG9uZSBvciBtb3JlIGA8aW9uLXNpZGUtbWVudT5gIGRpcmVjdGl2ZXMuCiAqCiAqIGBgYGh0bWwKICogPGlvbi1zaWRlLW1lbnVzPgogKiAgIDwhLS0gQ2VudGVyIGNvbnRlbnQgLS0+CiAqICAgPGlvbi1zaWRlLW1lbnUtY29udGVudCBuZy1jb250cm9sbGVyPSJDb250ZW50Q29udHJvbGxlciI+CiAqICAgPC9pb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAqCiAqICAgPCEtLSBMZWZ0IG1lbnUgLS0+CiAqICAgPGlvbi1zaWRlLW1lbnUgc2lkZT0ibGVmdCI+CiAqICAgPC9pb24tc2lkZS1tZW51PgogKgogKiAgIDwhLS0gUmlnaHQgbWVudSAtLT4KICogICA8aW9uLXNpZGUtbWVudSBzaWRlPSJyaWdodCI+CiAqICAgPC9pb24tc2lkZS1tZW51PgogKiA8L2lvbi1zaWRlLW1lbnVzPgogKiBgYGAKICogYGBganMKICogZnVuY3Rpb24gQ29udGVudENvbnRyb2xsZXIoJHNjb3BlLCAkaW9uaWNTaWRlTWVudURlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnRvZ2dsZUxlZnQgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY1NpZGVNZW51RGVsZWdhdGUudG9nZ2xlTGVmdCgpOwogKiAgIH07CiAqIH0KICogYGBgCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIHNpZGUgbWVudQogKiB3aXRoIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1NpZGVNZW51RGVsZWdhdGV9LgogKgogKi8KLmRpcmVjdGl2ZSgnaW9uU2lkZU1lbnVzJywgWyckaW9uaWNCb2R5JywgZnVuY3Rpb24oJGlvbmljQm9keSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0VDQScsCiAgICBjb250cm9sbGVyOiAnJGlvbmljU2lkZU1lbnVzJywKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgYXR0ci4kc2V0KCdjbGFzcycsIChhdHRyWydjbGFzcyddIHx8ICcnKSArICcgdmlldycpOwoKICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlKSB7CgogICAgICAgICRzY29wZS4kb24oJyRpb25pY0V4cG9zZUFzaWRlJywgZnVuY3Rpb24oZXZ0LCBpc0FzaWRlRXhwb3NlZCl7CiAgICAgICAgICBpZighJHNjb3BlLiRleHBvc2VBc2lkZSkgJHNjb3BlLiRleHBvc2VBc2lkZSA9IHt9OwogICAgICAgICAgJHNjb3BlLiRleHBvc2VBc2lkZS5hY3RpdmUgPSBpc0FzaWRlRXhwb3NlZDsKICAgICAgICAgICRpb25pY0JvZHkuZW5hYmxlQ2xhc3MoaXNBc2lkZUV4cG9zZWQsICdhc2lkZS1vcGVuJyk7CiAgICAgICAgfSk7CgogICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKXsKICAgICAgICAgICRpb25pY0JvZHkucmVtb3ZlQ2xhc3MoJ21lbnUtb3BlbicsICdhc2lkZS1vcGVuJyk7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblNsaWRlQm94CiAqIEBtb2R1bGUgaW9uaWMKICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljU2xpZGVCb3hEZWxlZ2F0ZQogKiBAcmVzdHJpY3QgRQogKiBAZGVzY3JpcHRpb24KICogVGhlIFNsaWRlIEJveCBpcyBhIG11bHRpLXBhZ2UgY29udGFpbmVyIHdoZXJlIGVhY2ggcGFnZSBjYW4gYmUgc3dpcGVkIG9yIGRyYWdnZWQgYmV0d2VlbjoKICoKICogIVtTbGlkZUJveF0oaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS5zMy5hbWF6b25hd3MuY29tL2RvY3MvY29udHJvbGxlcnMvc2xpZGVCb3guZ2lmKQogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8aW9uLXNsaWRlLWJveCBvbi1zbGlkZS1jaGFuZ2VkPSJzbGlkZUhhc0NoYW5nZWQoJGluZGV4KSI+CiAqICAgPGlvbi1zbGlkZT4KICogICAgIDxkaXYgY2xhc3M9ImJveCBibHVlIj48aDE+QkxVRTwvaDE+PC9kaXY+CiAqICAgPC9pb24tc2xpZGU+CiAqICAgPGlvbi1zbGlkZT4KICogICAgIDxkaXYgY2xhc3M9ImJveCB5ZWxsb3ciPjxoMT5ZRUxMT1c8L2gxPjwvZGl2PgogKiAgIDwvaW9uLXNsaWRlPgogKiAgIDxpb24tc2xpZGU+CiAqICAgICA8ZGl2IGNsYXNzPSJib3ggcGluayI+PGgxPlBJTks8L2gxPjwvZGl2PgogKiAgIDwvaW9uLXNsaWRlPgogKiA8L2lvbi1zbGlkZS1ib3g+CiAqIGBgYAogKgogKiBAcGFyYW0ge3N0cmluZz19IGRlbGVnYXRlLWhhbmRsZSBUaGUgaGFuZGxlIHVzZWQgdG8gaWRlbnRpZnkgdGhpcyBzbGlkZUJveAogKiB3aXRoIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1NsaWRlQm94RGVsZWdhdGV9LgogKiBAcGFyYW0ge2Jvb2xlYW49fSBkb2VzLWNvbnRpbnVlIFdoZXRoZXIgdGhlIHNsaWRlIGJveCBzaG91bGQgbG9vcC4KICogQHBhcmFtIHtib29sZWFuPX0gYXV0by1wbGF5IFdoZXRoZXIgdGhlIHNsaWRlIGJveCBzaG91bGQgYXV0b21hdGljYWxseSBzbGlkZS4gRGVmYXVsdCB0cnVlIGlmIGRvZXMtY29udGludWUgaXMgdHJ1ZS4KICogQHBhcmFtIHtudW1iZXI9fSBzbGlkZS1pbnRlcnZhbCBIb3cgbWFueSBtaWxsaXNlY29uZHMgdG8gd2FpdCB0byBjaGFuZ2Ugc2xpZGVzIChpZiBkb2VzLWNvbnRpbnVlIGlzIHRydWUpLiBEZWZhdWx0cyB0byA0MDAwLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93LXBhZ2VyIFdoZXRoZXIgYSBwYWdlciBzaG91bGQgYmUgc2hvd24gZm9yIHRoaXMgc2xpZGUgYm94LgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBwYWdlci1jbGljayBFeHByZXNzaW9uIHRvIGNhbGwgd2hlbiBhIHBhZ2VyIGlzIGNsaWNrZWQgKGlmIHNob3ctcGFnZXIgaXMgdHJ1ZSkuIElzIHBhc3NlZCB0aGUgJ2luZGV4JyB2YXJpYWJsZS4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tc2xpZGUtY2hhbmdlZCBFeHByZXNzaW9uIGNhbGxlZCB3aGVuZXZlciB0aGUgc2xpZGUgaXMgY2hhbmdlZC4gIElzIHBhc3NlZCBhbiAnJGluZGV4JyB2YXJpYWJsZS4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gYWN0aXZlLXNsaWRlIE1vZGVsIHRvIGJpbmQgdGhlIGN1cnJlbnQgc2xpZGUgdG8uCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25TbGlkZUJveCcsIFsKICAnJHRpbWVvdXQnLAogICckY29tcGlsZScsCiAgJyRpb25pY1NsaWRlQm94RGVsZWdhdGUnLApmdW5jdGlvbigkdGltZW91dCwgJGNvbXBpbGUsICRpb25pY1NsaWRlQm94RGVsZWdhdGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcGxhY2U6IHRydWUsCiAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgc2NvcGU6IHsKICAgICAgYXV0b1BsYXk6ICc9JywKICAgICAgZG9lc0NvbnRpbnVlOiAnQCcsCiAgICAgIHNsaWRlSW50ZXJ2YWw6ICdAJywKICAgICAgc2hvd1BhZ2VyOiAnQCcsCiAgICAgIHBhZ2VyQ2xpY2s6ICcmJywKICAgICAgZGlzYWJsZVNjcm9sbDogJ0AnLAogICAgICBvblNsaWRlQ2hhbmdlZDogJyYnLAogICAgICBhY3RpdmVTbGlkZTogJz0/JwogICAgfSwKICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgJyRhdHRycycsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGNvbnRpbnVvdXMgPSAkc2NvcGUuJGV2YWwoJHNjb3BlLmRvZXNDb250aW51ZSkgPT09IHRydWU7CiAgICAgIHZhciBzaG91bGRBdXRvUGxheSA9IGlzRGVmaW5lZCgkYXR0cnMuYXV0b1BsYXkpID8gISEkc2NvcGUuYXV0b1BsYXkgOiBmYWxzZTsKICAgICAgdmFyIHNsaWRlSW50ZXJ2YWwgPSBzaG91bGRBdXRvUGxheSA/ICRzY29wZS4kZXZhbCgkc2NvcGUuc2xpZGVJbnRlcnZhbCkgfHwgNDAwMCA6IDA7CgogICAgICB2YXIgc2xpZGVyID0gbmV3IGlvbmljLnZpZXdzLlNsaWRlcih7CiAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgIGF1dG86IHNsaWRlSW50ZXJ2YWwsCiAgICAgICAgY29udGludW91czogY29udGludW91cywKICAgICAgICBzdGFydFNsaWRlOiAkc2NvcGUuYWN0aXZlU2xpZGUsCiAgICAgICAgc2xpZGVzQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAkc2NvcGUuY3VycmVudFNsaWRlID0gc2xpZGVyLmN1cnJlbnRJbmRleCgpOwoKICAgICAgICAgIC8vIFRyeSB0byB0cmlnZ2VyIGEgZGlnZXN0CiAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHt9KTsKICAgICAgICB9LAogICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihzbGlkZUluZGV4KSB7CiAgICAgICAgICAkc2NvcGUuY3VycmVudFNsaWRlID0gc2xpZGVJbmRleDsKICAgICAgICAgICRzY29wZS5vblNsaWRlQ2hhbmdlZCh7IGluZGV4OiAkc2NvcGUuY3VycmVudFNsaWRlLCAkaW5kZXg6ICRzY29wZS5jdXJyZW50U2xpZGV9KTsKICAgICAgICAgICRzY29wZS4kcGFyZW50LiRicm9hZGNhc3QoJ3NsaWRlQm94LnNsaWRlQ2hhbmdlZCcsIHNsaWRlSW5kZXgpOwogICAgICAgICAgJHNjb3BlLmFjdGl2ZVNsaWRlID0gc2xpZGVJbmRleDsKICAgICAgICAgIC8vIFRyeSB0byB0cmlnZ2VyIGEgZGlnZXN0CiAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHt9KTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgc2xpZGVyLmVuYWJsZVNsaWRlKCRzY29wZS4kZXZhbCgkYXR0cnMuZGlzYWJsZVNjcm9sbCkgIT09IHRydWUpOwoKICAgICAgJHNjb3BlLiR3YXRjaCgnYWN0aXZlU2xpZGUnLCBmdW5jdGlvbihudikgewogICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKG52KSl7CiAgICAgICAgICBzbGlkZXIuc2xpZGUobnYpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICAkc2NvcGUuJG9uKCdzbGlkZUJveC5uZXh0U2xpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICBzbGlkZXIubmV4dCgpOwogICAgICB9KTsKCiAgICAgICRzY29wZS4kb24oJ3NsaWRlQm94LnByZXZTbGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHNsaWRlci5wcmV2KCk7CiAgICAgIH0pOwoKICAgICAgJHNjb3BlLiRvbignc2xpZGVCb3guc2V0U2xpZGUnLCBmdW5jdGlvbihlLCBpbmRleCkgewogICAgICAgIHNsaWRlci5zbGlkZShpbmRleCk7CiAgICAgIH0pOwoKICAgICAgLy9FeHBvc2VkIGZvciB0ZXN0aW5nCiAgICAgIHRoaXMuX19zbGlkZXIgPSBzbGlkZXI7CgogICAgICB2YXIgZGVyZWdpc3Rlckluc3RhbmNlID0gJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZShzbGlkZXIsICRhdHRycy5kZWxlZ2F0ZUhhbmRsZSk7CiAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZGVyZWdpc3Rlckluc3RhbmNlKTsKCiAgICAgIHRoaXMuc2xpZGVzQ291bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2xpZGVyLnNsaWRlc0NvdW50KCk7CiAgICAgIH07CgogICAgICB0aGlzLm9uUGFnZXJDbGljayA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgdm9pZCAwOwogICAgICAgICRzY29wZS5wYWdlckNsaWNrKHtpbmRleDogaW5kZXh9KTsKICAgICAgfTsKCiAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHNsaWRlci5sb2FkKCk7CiAgICAgIH0pOwogICAgfV0sCiAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9InNsaWRlciI+JyArCiAgICAgICc8ZGl2IGNsYXNzPSJzbGlkZXItc2xpZGVzIiBuZy10cmFuc2NsdWRlPicgKwogICAgICAnPC9kaXY+JyArCiAgICAnPC9kaXY+JywKCiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2xpZGVCb3hDdHJsKSB7CiAgICAgIC8vIElmIHRoZSBwYWdlciBzaG91bGQgc2hvdywgYXBwZW5kIGl0IHRvIHRoZSBzbGlkZSBib3gKICAgICAgaWYoJHNjb3BlLiRldmFsKCRzY29wZS5zaG93UGFnZXIpICE9PSBmYWxzZSkgewogICAgICAgIHZhciBjaGlsZFNjb3BlID0gJHNjb3BlLiRuZXcoKTsKICAgICAgICB2YXIgcGFnZXIgPSBqcUxpdGUoJzxpb24tcGFnZXI+PC9pb24tcGFnZXI+Jyk7CiAgICAgICAgJGVsZW1lbnQuYXBwZW5kKHBhZ2VyKTsKICAgICAgICAkY29tcGlsZShwYWdlcikoY2hpbGRTY29wZSk7CiAgICAgIH0KICAgIH0KICB9Owp9XSkKLmRpcmVjdGl2ZSgnaW9uU2xpZGUnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6ICdeaW9uU2xpZGVCb3gnLAogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICBlbGVtZW50LmFkZENsYXNzKCdzbGlkZXItc2xpZGUnKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgIH07CiAgICB9LAogIH07Cn0pCgouZGlyZWN0aXZlKCdpb25QYWdlcicsIGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVwbGFjZTogdHJ1ZSwKICAgIHJlcXVpcmU6ICdeaW9uU2xpZGVCb3gnLAogICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPSJzbGlkZXItcGFnZXIiPjxzcGFuIGNsYXNzPSJzbGlkZXItcGFnZXItcGFnZSIgbmctcmVwZWF0PSJzbGlkZSBpbiBudW1TbGlkZXMoKSB0cmFjayBieSAkaW5kZXgiIG5nLWNsYXNzPSJ7YWN0aXZlOiAkaW5kZXggPT0gY3VycmVudFNsaWRlfSIgbmctY2xpY2s9InBhZ2VyQ2xpY2soJGluZGV4KSI+PGkgY2xhc3M9Imljb24gaW9uLXJlY29yZCI+PC9pPjwvc3Bhbj48L2Rpdj4nLAogICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNsaWRlQm94KSB7CiAgICAgIHZhciBzZWxlY3RQYWdlID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICB2YXIgY2hpbGRyZW4gPSAkZWxlbWVudFswXS5jaGlsZHJlbjsKICAgICAgICB2YXIgbGVuZ3RoID0gY2hpbGRyZW4ubGVuZ3RoOwogICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYoaSA9PSBpbmRleCkgewogICAgICAgICAgICBjaGlsZHJlbltpXS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoaWxkcmVuW2ldLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgICRzY29wZS5wYWdlckNsaWNrID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICBzbGlkZUJveC5vblBhZ2VyQ2xpY2soaW5kZXgpOwogICAgICB9OwoKICAgICAgJHNjb3BlLm51bVNsaWRlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgQXJyYXkoc2xpZGVCb3guc2xpZGVzQ291bnQoKSk7CiAgICAgIH07CgogICAgICAkc2NvcGUuJHdhdGNoKCdjdXJyZW50U2xpZGUnLCBmdW5jdGlvbih2KSB7CiAgICAgICAgc2VsZWN0UGFnZSh2KTsKICAgICAgfSk7CiAgICB9CiAgfTsKCn0pOwoKSW9uaWNNb2R1bGUuY29uc3RhbnQoJyRpb25pY1RhYkNvbmZpZycsIHsKICB0eXBlOiAnJwp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblRhYgogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBFCiAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvblRhYnMKICoKICogQGRlc2NyaXB0aW9uCiAqIENvbnRhaW5zIGEgdGFiJ3MgY29udGVudC4gIFRoZSBjb250ZW50IG9ubHkgZXhpc3RzIHdoaWxlIHRoZSBnaXZlbiB0YWIgaXMgc2VsZWN0ZWQuCiAqCiAqIEVhY2ggaW9uVGFiIGhhcyBpdHMgb3duIHZpZXcgaGlzdG9yeS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi10YWIKICogICB0aXRsZT0iVGFiISIKICogICBpY29uPSJteS1pY29uIgogKiAgIGhyZWY9IiMvdGFiL3RhYi1saW5rIgogKiAgIG9uLXNlbGVjdD0ib25UYWJTZWxlY3RlZCgpIgogKiAgIG9uLWRlc2VsZWN0PSJvblRhYkRlc2VsZWN0ZWQoKSI+CiAqIDwvaW9uLXRhYj4KICogYGBgCiAqIEZvciBhIGNvbXBsZXRlLCB3b3JraW5nIHRhYiBiYXIgZXhhbXBsZSwgc2VlIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblRhYnN9IGRvY3VtZW50YXRpb24uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSB0aXRsZSBUaGUgdGl0bGUgb2YgdGhlIHRhYi4KICogQHBhcmFtIHtzdHJpbmc9fSBocmVmIFRoZSBsaW5rIHRoYXQgdGhpcyB0YWIgd2lsbCBuYXZpZ2F0ZSB0byB3aGVuIHRhcHBlZC4KICogQHBhcmFtIHtzdHJpbmc9fSBpY29uIFRoZSBpY29uIG9mIHRoZSB0YWIuIElmIGdpdmVuLCB0aGlzIHdpbGwgYmVjb21lIHRoZSBkZWZhdWx0IGZvciBpY29uLW9uIGFuZCBpY29uLW9mZi4KICogQHBhcmFtIHtzdHJpbmc9fSBpY29uLW9uIFRoZSBpY29uIG9mIHRoZSB0YWIgd2hpbGUgaXQgaXMgc2VsZWN0ZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gaWNvbi1vZmYgVGhlIGljb24gb2YgdGhlIHRhYiB3aGlsZSBpdCBpcyBub3Qgc2VsZWN0ZWQuCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IGJhZGdlIFRoZSBiYWRnZSB0byBwdXQgb24gdGhpcyB0YWIgKHVzdWFsbHkgYSBudW1iZXIpLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBiYWRnZS1zdHlsZSBUaGUgc3R5bGUgb2YgYmFkZ2UgdG8gcHV0IG9uIHRoaXMgdGFiIChlZyB0YWJzLXBvc2l0aXZlKS4KICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tc2VsZWN0IENhbGxlZCB3aGVuIHRoaXMgdGFiIGlzIHNlbGVjdGVkLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1kZXNlbGVjdCBDYWxsZWQgd2hlbiB0aGlzIHRhYiBpcyBkZXNlbGVjdGVkLgogKiBAcGFyYW0ge2V4cHJlc3Npb249fSBuZy1jbGljayBCeSBkZWZhdWx0LCB0aGUgdGFiIHdpbGwgYmUgc2VsZWN0ZWQgb24gY2xpY2suIElmIG5nQ2xpY2sgaXMgc2V0LCBpdCB3aWxsIG5vdC4gIFlvdSBjYW4gZXhwbGljaXRseSBzd2l0Y2ggdGFicyB1c2luZyB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNUYWJzRGVsZWdhdGUjc2VsZWN0ICRpb25pY1RhYnNEZWxlZ2F0ZS5zZWxlY3QoKX0uCiAqLwpJb25pY01vZHVsZQouZGlyZWN0aXZlKCdpb25UYWInLCBbCiAgJyRyb290U2NvcGUnLAogICckYW5pbWF0ZScsCiAgJyRpb25pY0JpbmQnLAogICckY29tcGlsZScsCmZ1bmN0aW9uKCRyb290U2NvcGUsICRhbmltYXRlLCAkaW9uaWNCaW5kLCAkY29tcGlsZSkgewoKICAvL1JldHVybnMgJyBrZXk9InZhbHVlIicgaWYgdmFsdWUgZXhpc3RzCiAgZnVuY3Rpb24gYXR0clN0cihrLHYpIHsKICAgIHJldHVybiBhbmd1bGFyLmlzRGVmaW5lZCh2KSA/ICcgJyArIGsgKyAnPSInICsgdiArICciJyA6ICcnOwogIH0KICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6IFsnXmlvblRhYnMnLCAnaW9uVGFiJ10sCiAgICByZXBsYWNlOiB0cnVlLAogICAgY29udHJvbGxlcjogJyRpb25pY1RhYicsCiAgICBzY29wZTogdHJ1ZSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKCiAgICAgIC8vV2UgY3JlYXRlIHRoZSB0YWJOYXZUZW1wbGF0ZSBpbiB0aGUgY29tcGlsZSBwaGFzZSBzbyB0aGF0IHRoZQogICAgICAvL2F0dHJpYnV0ZXMgd2UgcGFzcyBkb3duIHdvbid0IGJlIGludGVycG9sYXRlZCB5ZXQgLSB3ZSB3YW50CiAgICAgIC8vdG8gcGFzcyBkb3duIHRoZSAncmF3JyB2ZXJzaW9ucyBvZiB0aGUgYXR0cmlidXRlcwogICAgICB2YXIgdGFiTmF2VGVtcGxhdGUgPSAnPGlvbi10YWItbmF2JyArCiAgICAgICAgYXR0clN0cignbmctY2xpY2snLCBhdHRyLm5nQ2xpY2spICsKICAgICAgICBhdHRyU3RyKCd0aXRsZScsIGF0dHIudGl0bGUpICsKICAgICAgICBhdHRyU3RyKCdpY29uJywgYXR0ci5pY29uKSArCiAgICAgICAgYXR0clN0cignaWNvbi1vbicsIGF0dHIuaWNvbk9uKSArCiAgICAgICAgYXR0clN0cignaWNvbi1vZmYnLCBhdHRyLmljb25PZmYpICsKICAgICAgICBhdHRyU3RyKCdiYWRnZScsIGF0dHIuYmFkZ2UpICsKICAgICAgICBhdHRyU3RyKCdiYWRnZS1zdHlsZScsIGF0dHIuYmFkZ2VTdHlsZSkgKwogICAgICAgIGF0dHJTdHIoJ2hpZGRlbicsIGF0dHIuaGlkZGVuKSArCiAgICAgICAgYXR0clN0cignY2xhc3MnLCBhdHRyWydjbGFzcyddKSArCiAgICAgICAgJz48L2lvbi10YWItbmF2Pic7CgogICAgICAvL1JlbW92ZSB0aGUgY29udGVudHMgb2YgdGhlIGVsZW1lbnQgc28gd2UgY2FuIGNvbXBpbGUgdGhlbSBsYXRlciwgaWYgdGFiIGlzIHNlbGVjdGVkCiAgICAgIC8vV2UgZG9uJ3QgdXNlIHJlZ3VsYXIgdHJhbnNjbHVzaW9uIGJlY2F1c2UgaXQgYnJlYWtzIGVsZW1lbnQgaW5oZXJpdGFuY2UKICAgICAgdmFyIHRhYkNvbnRlbnQgPSBqcUxpdGUoJzxkaXYgY2xhc3M9InBhbmUiPicpCiAgICAgICAgLmFwcGVuZCggZWxlbWVudC5jb250ZW50cygpLnJlbW92ZSgpICk7CgogICAgICByZXR1cm4gZnVuY3Rpb24gbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybHMpIHsKICAgICAgICB2YXIgY2hpbGRTY29wZTsKICAgICAgICB2YXIgY2hpbGRFbGVtZW50OwogICAgICAgIHZhciB0YWJzQ3RybCA9IGN0cmxzWzBdOwogICAgICAgIHZhciB0YWJDdHJsID0gY3RybHNbMV07CgogICAgICAgIHZhciBuYXZWaWV3ID0gdGFiQ29udGVudFswXS5xdWVyeVNlbGVjdG9yKCdpb24tbmF2LXZpZXcnKSB8fAogICAgICAgICAgdGFiQ29udGVudFswXS5xdWVyeVNlbGVjdG9yKCdkYXRhLWlvbi1uYXYtdmlldycpOwogICAgICAgIHZhciBuYXZWaWV3TmFtZSA9IG5hdlZpZXcgJiYgbmF2Vmlldy5nZXRBdHRyaWJ1dGUoJ25hbWUnKTsKCiAgICAgICAgJGlvbmljQmluZCgkc2NvcGUsICRhdHRyLCB7CiAgICAgICAgICBhbmltYXRlOiAnPScsCiAgICAgICAgICBvblNlbGVjdDogJyYnLAogICAgICAgICAgb25EZXNlbGVjdDogJyYnLAogICAgICAgICAgdGl0bGU6ICdAJywKICAgICAgICAgIHVpU3JlZjogJ0AnLAogICAgICAgICAgaHJlZjogJ0AnLAogICAgICAgIH0pOwoKICAgICAgICB0YWJzQ3RybC5hZGQoJHNjb3BlKTsKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdGFic0N0cmwucmVtb3ZlKCRzY29wZSk7CiAgICAgICAgICB0YWJOYXZFbGVtZW50Lmlzb2xhdGVTY29wZSgpLiRkZXN0cm95KCk7CiAgICAgICAgICB0YWJOYXZFbGVtZW50LnJlbW92ZSgpOwogICAgICAgIH0pOwoKICAgICAgICAvL1JlbW92ZSB0aXRsZSBhdHRyaWJ1dGUgc28gYnJvd3Nlci10b29sdGlwIGRvZXMgbm90IGFwZWFyCiAgICAgICAgJGVsZW1lbnRbMF0ucmVtb3ZlQXR0cmlidXRlKCd0aXRsZScpOwoKICAgICAgICBpZiAobmF2Vmlld05hbWUpIHsKICAgICAgICAgIHRhYkN0cmwubmF2Vmlld05hbWUgPSAkc2NvcGUubmF2Vmlld05hbWUgPSBuYXZWaWV3TmFtZTsKICAgICAgICB9CiAgICAgICAgJHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIHNlbGVjdElmTWF0Y2hlc1N0YXRlKTsKICAgICAgICBzZWxlY3RJZk1hdGNoZXNTdGF0ZSgpOwogICAgICAgIGZ1bmN0aW9uIHNlbGVjdElmTWF0Y2hlc1N0YXRlKCkgewogICAgICAgICAgaWYgKHRhYkN0cmwudGFiTWF0Y2hlc1N0YXRlKCkpIHsKICAgICAgICAgICAgdGFic0N0cmwuc2VsZWN0KCRzY29wZSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHRhYk5hdkVsZW1lbnQgPSBqcUxpdGUodGFiTmF2VGVtcGxhdGUpOwogICAgICAgIHRhYk5hdkVsZW1lbnQuZGF0YSgnJGlvblRhYnNDb250cm9sbGVyJywgdGFic0N0cmwpOwogICAgICAgIHRhYk5hdkVsZW1lbnQuZGF0YSgnJGlvblRhYkNvbnRyb2xsZXInLCB0YWJDdHJsKTsKICAgICAgICB0YWJzQ3RybC4kdGFic0VsZW1lbnQuYXBwZW5kKCRjb21waWxlKHRhYk5hdkVsZW1lbnQpKCRzY29wZSkpOwoKICAgICAgICAkc2NvcGUuJHdhdGNoKCckdGFiU2VsZWN0ZWQnLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgY2hpbGRTY29wZSAmJiBjaGlsZFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICBjaGlsZFNjb3BlID0gbnVsbDsKICAgICAgICAgIGNoaWxkRWxlbWVudCAmJiAkYW5pbWF0ZS5sZWF2ZShjaGlsZEVsZW1lbnQpOwogICAgICAgICAgY2hpbGRFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICBjaGlsZFNjb3BlID0gJHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgY2hpbGRFbGVtZW50ID0gdGFiQ29udGVudC5jbG9uZSgpOwogICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjaGlsZEVsZW1lbnQsIHRhYnNDdHJsLiRlbGVtZW50KTsKICAgICAgICAgICAgJGNvbXBpbGUoY2hpbGRFbGVtZW50KShjaGlsZFNjb3BlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgIH07CiAgICB9CiAgfTsKfV0pOwoKSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uVGFiTmF2JywgW2Z1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVwbGFjZTogdHJ1ZSwKICAgIHJlcXVpcmU6IFsnXmlvblRhYnMnLCAnXmlvblRhYiddLAogICAgdGVtcGxhdGU6CiAgICAnPGEgbmctY2xhc3M9IntcJ3RhYi1pdGVtLWFjdGl2ZVwnOiBpc1RhYkFjdGl2ZSgpLCBcJ2hhcy1iYWRnZVwnOmJhZGdlLCBcJ3RhYi1oaWRkZW5cJzppc0hpZGRlbigpfSIgJyArCiAgICAgICcgY2xhc3M9InRhYi1pdGVtIj4nICsKICAgICAgJzxzcGFuIGNsYXNzPSJiYWRnZSB7e2JhZGdlU3R5bGV9fSIgbmctaWY9ImJhZGdlIj57e2JhZGdlfX08L3NwYW4+JyArCiAgICAgICc8aSBjbGFzcz0iaWNvbiB7e2dldEljb25PbigpfX0iIG5nLWlmPSJnZXRJY29uT24oKSAmJiBpc1RhYkFjdGl2ZSgpIj48L2k+JyArCiAgICAgICc8aSBjbGFzcz0iaWNvbiB7e2dldEljb25PZmYoKX19IiBuZy1pZj0iZ2V0SWNvbk9mZigpICYmICFpc1RhYkFjdGl2ZSgpIj48L2k+JyArCiAgICAgICc8c3BhbiBjbGFzcz0idGFiLXRpdGxlIiBuZy1iaW5kLWh0bWw9InRpdGxlIj48L3NwYW4+JyArCiAgICAnPC9hPicsCiAgICBzY29wZTogewogICAgICB0aXRsZTogJ0AnLAogICAgICBpY29uOiAnQCcsCiAgICAgIGljb25PbjogJ0AnLAogICAgICBpY29uT2ZmOiAnQCcsCiAgICAgIGJhZGdlOiAnPScsCiAgICAgIGhpZGRlbjogJ0AnLAogICAgICBiYWRnZVN0eWxlOiAnQCcsCiAgICAgICdjbGFzcyc6ICdAJwogICAgfSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1ZGUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCBjdHJscykgewogICAgICAgIHZhciB0YWJzQ3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgdGFiQ3RybCA9IGN0cmxzWzFdOwoKICAgICAgICAvL1JlbW92ZSB0aXRsZSBhdHRyaWJ1dGUgc28gYnJvd3Nlci10b29sdGlwIGRvZXMgbm90IGFwZWFyCiAgICAgICAgJGVsZW1lbnRbMF0ucmVtb3ZlQXR0cmlidXRlKCd0aXRsZScpOwoKICAgICAgICAkc2NvcGUuc2VsZWN0VGFiID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgdGFic0N0cmwuc2VsZWN0KHRhYkN0cmwuJHNjb3BlLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIGlmICghJGF0dHJzLm5nQ2xpY2spIHsKICAgICAgICAgICRlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJHNjb3BlLnNlbGVjdFRhYihldmVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAkc2NvcGUuaXNIaWRkZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmKCRhdHRycy5oaWRkZW4gPT09ICd0cnVlJyB8fCAkYXR0cnMuaGlkZGVuID09PSB0cnVlKXJldHVybiB0cnVlOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgICAgICRzY29wZS5nZXRJY29uT24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAkc2NvcGUuaWNvbk9uIHx8ICRzY29wZS5pY29uOwogICAgICAgIH07CiAgICAgICAgJHNjb3BlLmdldEljb25PZmYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAkc2NvcGUuaWNvbk9mZiB8fCAkc2NvcGUuaWNvbjsKICAgICAgICB9OwoKICAgICAgICAkc2NvcGUuaXNUYWJBY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0YWJzQ3RybC5zZWxlY3RlZFRhYigpID09PSB0YWJDdHJsLiRzY29wZTsKICAgICAgICB9OwogICAgICB9OwogICAgfQogIH07Cn1dKTsKCklvbmljTW9kdWxlLmNvbnN0YW50KCckaW9uaWNUYWJzQ29uZmlnJywgewogIHBvc2l0aW9uOiAnJywKICB0eXBlOiAnJwp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlvblRhYnMKICogQG1vZHVsZSBpb25pYwogKiBAZGVsZWdhdGUgaW9uaWMuc2VydmljZTokaW9uaWNUYWJzRGVsZWdhdGUKICogQHJlc3RyaWN0IEUKICogQGNvZGVwZW4gS2JyekoKICoKICogQGRlc2NyaXB0aW9uCiAqIFBvd2VycyBhIG11bHRpLXRhYmJlZCBpbnRlcmZhY2Ugd2l0aCBhIFRhYiBCYXIgYW5kIGEgc2V0IG9mICJwYWdlcyIgdGhhdCBjYW4gYmUgdGFiYmVkCiAqIHRocm91Z2guCiAqCiAqIEFzc2lnbiBhbnkgW3RhYnMgY2xhc3NdKC9kb2NzL2NvbXBvbmVudHMjdGFicykgb3IKICogW2FuaW1hdGlvbiBjbGFzc10oL2RvY3MvY29tcG9uZW50cyNhbmltYXRpb24pIHRvIHRoZSBlbGVtZW50IHRvIGRlZmluZQogKiBpdHMgbG9vayBhbmQgZmVlbC4KICoKICogU2VlIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblRhYn0gZGlyZWN0aXZlJ3MgZG9jdW1lbnRhdGlvbiBmb3IgbW9yZSBkZXRhaWxzIG9uCiAqIGluZGl2aWR1YWwgdGFicy4KICoKICogTm90ZTogZG8gbm90IHBsYWNlIGlvbi10YWJzIGluc2lkZSBvZiBhbiBpb24tY29udGVudCBlbGVtZW50OyBpdCBoYXMgYmVlbiBrbm93biB0byBjYXVzZSBhCiAqIGNlcnRhaW4gQ1NTIGJ1Zy4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGlvbi10YWJzIGNsYXNzPSJ0YWJzLXBvc2l0aXZlIHRhYnMtaWNvbi1vbmx5Ij4KICoKICogICA8aW9uLXRhYiB0aXRsZT0iSG9tZSIgaWNvbi1vbj0iaW9uLWlvczctZmlsaW5nIiBpY29uLW9mZj0iaW9uLWlvczctZmlsaW5nLW91dGxpbmUiPgogKiAgICAgPCEtLSBUYWIgMSBjb250ZW50IC0tPgogKiAgIDwvaW9uLXRhYj4KICoKICogICA8aW9uLXRhYiB0aXRsZT0iQWJvdXQiIGljb24tb249Imlvbi1pb3M3LWNsb2NrIiBpY29uLW9mZj0iaW9uLWlvczctY2xvY2stb3V0bGluZSI+CiAqICAgICA8IS0tIFRhYiAyIGNvbnRlbnQgLS0+CiAqICAgPC9pb24tdGFiPgogKgogKiAgIDxpb24tdGFiIHRpdGxlPSJTZXR0aW5ncyIgaWNvbi1vbj0iaW9uLWlvczctZ2VhciIgaWNvbi1vZmY9Imlvbi1pb3M3LWdlYXItb3V0bGluZSI+CiAqICAgICA8IS0tIFRhYiAzIGNvbnRlbnQgLS0+CiAqICAgPC9pb24tdGFiPgogKgogKiA8L2lvbi10YWJzPgogKiBgYGAKICoKICogQHBhcmFtIHtzdHJpbmc9fSBkZWxlZ2F0ZS1oYW5kbGUgVGhlIGhhbmRsZSB1c2VkIHRvIGlkZW50aWZ5IHRoZXNlIHRhYnMKICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNUYWJzRGVsZWdhdGV9LgogKi8KCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblRhYnMnLCBbCiAgJyRpb25pY1ZpZXdTZXJ2aWNlJywgCiAgJyRpb25pY1RhYnNEZWxlZ2F0ZScsIAogICckaW9uaWNUYWJzQ29uZmlnJywgCmZ1bmN0aW9uKCRpb25pY1ZpZXdTZXJ2aWNlLCAkaW9uaWNUYWJzRGVsZWdhdGUsICRpb25pY1RhYnNDb25maWcpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHNjb3BlOiB0cnVlLAogICAgY29udHJvbGxlcjogJyRpb25pY1RhYnMnLAogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICBlbGVtZW50LmFkZENsYXNzKCd2aWV3Jyk7CiAgICAgIC8vV2UgY2Fubm90IHVzZSByZWd1bGFyIHRyYW5zY2x1ZGUgaGVyZSBiZWNhdXNlIGl0IGJyZWFrcyBlbGVtZW50LmRhdGEoKQogICAgICAvL2luaGVyaXRhbmNlIG9uIGNvbXBpbGUKICAgICAgdmFyIGlubmVyRWxlbWVudCA9IGpxTGl0ZSgnPGRpdiBjbGFzcz0idGFicyI+PC9kaXY+Jyk7CiAgICAgIGlubmVyRWxlbWVudC5hcHBlbmQoZWxlbWVudC5jb250ZW50cygpKTsKICAgICAgZWxlbWVudC5hcHBlbmQoaW5uZXJFbGVtZW50KTsKICAgICAgZWxlbWVudC5hZGRDbGFzcygkaW9uaWNUYWJzQ29uZmlnLnBvc2l0aW9uKTsKICAgICAgZWxlbWVudC5hZGRDbGFzcygkaW9uaWNUYWJzQ29uZmlnLnR5cGUpOwoKICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHRhYnNDdHJsKSB7CiAgICAgICAgdmFyIGRlcmVnaXN0ZXJJbnN0YW5jZSA9ICRpb25pY1RhYnNEZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZSgKICAgICAgICAgIHRhYnNDdHJsLCAkYXR0ci5kZWxlZ2F0ZUhhbmRsZQogICAgICAgICk7CgogICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZGVyZWdpc3Rlckluc3RhbmNlKTsKCiAgICAgICAgdGFic0N0cmwuJHNjb3BlID0gJHNjb3BlOwogICAgICAgIHRhYnNDdHJsLiRlbGVtZW50ID0gJGVsZW1lbnQ7CiAgICAgICAgdGFic0N0cmwuJHRhYnNFbGVtZW50ID0ganFMaXRlKCRlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJy50YWJzJykpOwoKICAgICAgICB2YXIgZWwgPSAkZWxlbWVudFswXTsKICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgeyByZXR1cm4gZWwuY2xhc3NOYW1lOyB9LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgdmFyIGlzVGFic1RvcCA9IHZhbHVlLmluZGV4T2YoJ3RhYnMtdG9wJykgIT09IC0xOwogICAgICAgICAgdmFyIGlzSGlkZGVuID0gdmFsdWUuaW5kZXhPZigndGFicy1pdGVtLWhpZGUnKSAhPT0gLTE7CiAgICAgICAgICAkc2NvcGUuJGhhc1RhYnMgPSAhaXNUYWJzVG9wICYmICFpc0hpZGRlbjsKICAgICAgICAgICRzY29wZS4kaGFzVGFic1RvcCA9IGlzVGFic1RvcCAmJiAhaXNIaWRkZW47CiAgICAgICAgfSk7CiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGRlbGV0ZSAkc2NvcGUuJGhhc1RhYnM7CiAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNUYWJzVG9wOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uVG9nZ2xlCiAqIEBtb2R1bGUgaW9uaWMKICogQGNvZGVwZW4gdGZBemoKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgdG9nZ2xlIGlzIGFuIGFuaW1hdGVkIHN3aXRjaCB3aGljaCBiaW5kcyBhIGdpdmVuIG1vZGVsIHRvIGEgYm9vbGVhbi4KICoKICogQWxsb3dzIGRyYWdnaW5nIG9mIHRoZSBzd2l0Y2gncyBudWIuCiAqCiAqIFRoZSB0b2dnbGUgYmVoYXZlcyBsaWtlIGFueSBbQW5ndWxhckpTIGNoZWNrYm94XShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy9pbnB1dC9pbnB1dFtjaGVja2JveF0pIG90aGVyd2lzZS4KICoKICogQHBhcmFtIHRvZ2dsZS1jbGFzcyB7c3RyaW5nPX0gU2V0cyB0aGUgQ1NTIGNsYXNzIG9uIHRoZSBpbm5lciBgbGFiZWwudG9nZ2xlYCBlbGVtZW50IGNyZWF0ZWQgYnkgdGhlIGRpcmVjdGl2ZS4KICoKICogQHVzYWdlCiAqIEJlbG93IGlzIGFuIGV4YW1wbGUgb2YgYSB0b2dnbGUgZGlyZWN0aXZlIHdoaWNoIGlzIHdpcmVkIHVwIHRvIHRoZSBgYWlycGxhbmVNb2RlYCBtb2RlbAogKiBhbmQgaGFzIHRoZSBgdG9nZ2xlLWNhbG1gIENTUyBjbGFzcyBhc3NpZ25lZCB0byB0aGUgaW5uZXIgZWxlbWVudC4KICoKICogYGBgaHRtbAogKiA8aW9uLXRvZ2dsZSBuZy1tb2RlbD0iYWlycGxhbmVNb2RlIiB0b2dnbGUtY2xhc3M9InRvZ2dsZS1jYWxtIj5BaXJwbGFuZSBNb2RlPC9pb24tdG9nZ2xlPgogKiBgYGAKICovCklvbmljTW9kdWxlCi5kaXJlY3RpdmUoJ2lvblRvZ2dsZScsIFsKICAnJGlvbmljR2VzdHVyZScsCiAgJyR0aW1lb3V0JywKZnVuY3Rpb24oJGlvbmljR2VzdHVyZSwgJHRpbWVvdXQpIHsKCiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXBsYWNlOiB0cnVlLAogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICB0ZW1wbGF0ZToKICAgICAgJzxkaXYgY2xhc3M9Iml0ZW0gaXRlbS10b2dnbGUiPicgKwogICAgICAgICc8ZGl2IG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICAgJzxsYWJlbCBjbGFzcz0idG9nZ2xlIj4nICsKICAgICAgICAgICc8aW5wdXQgdHlwZT0iY2hlY2tib3giPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9InRyYWNrIj4nICsKICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImhhbmRsZSI+PC9kaXY+JyArCiAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgJzwvbGFiZWw+JyArCiAgICAgICc8L2Rpdj4nLAoKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgdmFyIGlucHV0ID0gZWxlbWVudC5maW5kKCdpbnB1dCcpOwogICAgICBmb3JFYWNoKHsKICAgICAgICAnbmFtZSc6IGF0dHIubmFtZSwKICAgICAgICAnbmctdmFsdWUnOiBhdHRyLm5nVmFsdWUsCiAgICAgICAgJ25nLW1vZGVsJzogYXR0ci5uZ01vZGVsLAogICAgICAgICduZy1jaGVja2VkJzogYXR0ci5uZ0NoZWNrZWQsCiAgICAgICAgJ25nLWRpc2FibGVkJzogYXR0ci5uZ0Rpc2FibGVkLAogICAgICAgICduZy10cnVlLXZhbHVlJzogYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAnbmctZmFsc2UtdmFsdWUnOiBhdHRyLm5nRmFsc2VWYWx1ZSwKICAgICAgICAnbmctY2hhbmdlJzogYXR0ci5uZ0NoYW5nZQogICAgICB9LCBmdW5jdGlvbih2YWx1ZSwgbmFtZSkgewogICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICBpbnB1dC5hdHRyKG5hbWUsIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgaWYoYXR0ci50b2dnbGVDbGFzcykgewogICAgICAgIGVsZW1lbnRbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2xhYmVsJylbMF0uY2xhc3NMaXN0LmFkZChhdHRyLnRvZ2dsZUNsYXNzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgIHZhciBlbCwgY2hlY2tib3gsIHRyYWNrLCBoYW5kbGU7CgogICAgICAgICBlbCA9ICRlbGVtZW50WzBdLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdsYWJlbCcpWzBdOwogICAgICAgICBjaGVja2JveCA9IGVsLmNoaWxkcmVuWzBdOwogICAgICAgICB0cmFjayA9IGVsLmNoaWxkcmVuWzFdOwogICAgICAgICBoYW5kbGUgPSB0cmFjay5jaGlsZHJlblswXTsKCiAgICAgICAgIHZhciBuZ01vZGVsQ29udHJvbGxlciA9IGpxTGl0ZShjaGVja2JveCkuY29udHJvbGxlcignbmdNb2RlbCcpOwoKICAgICAgICAgJHNjb3BlLnRvZ2dsZSA9IG5ldyBpb25pYy52aWV3cy5Ub2dnbGUoewogICAgICAgICAgIGVsOiBlbCwKICAgICAgICAgICB0cmFjazogdHJhY2ssCiAgICAgICAgICAgY2hlY2tib3g6IGNoZWNrYm94LAogICAgICAgICAgIGhhbmRsZTogaGFuZGxlLAogICAgICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGlmKGNoZWNrYm94LmNoZWNrZWQpIHsKICAgICAgICAgICAgICAgbmdNb2RlbENvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZSh0cnVlKTsKICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgIG5nTW9kZWxDb250cm9sbGVyLiRzZXRWaWV3VmFsdWUoZmFsc2UpOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgJHNjb3BlLiRhcHBseSgpOwogICAgICAgICAgIH0KICAgICAgICAgfSk7CgogICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICRzY29wZS50b2dnbGUuZGVzdHJveSgpOwogICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KCiAgfTsKfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgaW9uVmlldwogKiBAbW9kdWxlIGlvbmljCiAqIEByZXN0cmljdCBFCiAqIEBwYXJlbnQgaW9uTmF2VmlldwogKgogKiBAZGVzY3JpcHRpb24KICogQSBjb250YWluZXIgZm9yIGNvbnRlbnQsIHVzZWQgdG8gdGVsbCBhIHBhcmVudCB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0KICogYWJvdXQgdGhlIGN1cnJlbnQgdmlldy4KICoKICogQHVzYWdlCiAqIEJlbG93IGlzIGFuIGV4YW1wbGUgd2hlcmUgb3VyIHBhZ2Ugd2lsbCBsb2FkIHdpdGggYSBuYXZiYXIgY29udGFpbmluZyAiTXkgUGFnZSIgYXMgdGhlIHRpdGxlLgogKgogKiBgYGBodG1sCiAqIDxpb24tbmF2LWJhcj48L2lvbi1uYXYtYmFyPgogKiA8aW9uLW5hdi12aWV3IGNsYXNzPSJzbGlkZS1sZWZ0LXJpZ2h0Ij4KICogICA8aW9uLXZpZXcgdGl0bGU9Ik15IFBhZ2UiPgogKiAgICAgPGlvbi1jb250ZW50PgogKiAgICAgICBIZWxsbyEKICogICAgIDwvaW9uLWNvbnRlbnQ+CiAqICAgPC9pb24tdmlldz4KICogPC9pb24tbmF2LXZpZXc+CiAqIGBgYAogKgogKiBAcGFyYW0ge3N0cmluZz19IHRpdGxlIFRoZSB0aXRsZSB0byBkaXNwbGF5IG9uIHRoZSBwYXJlbnQge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9LgogKiBAcGFyYW0ge2Jvb2xlYW49fSBoaWRlLWJhY2stYnV0dG9uIFdoZXRoZXIgdG8gaGlkZSB0aGUgYmFjayBidXR0b24gb24gdGhlIHBhcmVudAogKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gYnkgZGVmYXVsdC4KICogQHBhcmFtIHtib29sZWFuPX0gaGlkZS1uYXYtYmFyIFdoZXRoZXIgdG8gaGlkZSB0aGUgcGFyZW50CiAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfSBieSBkZWZhdWx0LgogKi8KSW9uaWNNb2R1bGUKLmRpcmVjdGl2ZSgnaW9uVmlldycsIFsnJGlvbmljVmlld1NlcnZpY2UnLCAnJHJvb3RTY29wZScsICckYW5pbWF0ZScsCiAgICAgICAgICAgZnVuY3Rpb24oICRpb25pY1ZpZXdTZXJ2aWNlLCAgICRyb290U2NvcGUsICAgJGFuaW1hdGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFQScsCiAgICBwcmlvcml0eTogMTAwMCwKICAgIHJlcXVpcmU6IFsnXj9pb25OYXZCYXInLCAnXj9pb25Nb2RhbCddLAogICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSkgewogICAgICB0RWxlbWVudC5hZGRDbGFzcygncGFuZScpOwogICAgICB0RWxlbWVudFswXS5yZW1vdmVBdHRyaWJ1dGUoJ3RpdGxlJyk7CgogICAgICByZXR1cm4gZnVuY3Rpb24gbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybHMpIHsKICAgICAgICB2YXIgbmF2QmFyQ3RybCA9IGN0cmxzWzBdOwogICAgICAgIHZhciBtb2RhbEN0cmwgPSBjdHJsc1sxXTsKCiAgICAgICAgLy9Eb24ndCB1c2UgdGhlIGlvblZpZXcgaWYgd2UncmUgaW5zaWRlIGEgbW9kYWwgb3IgdGhlcmUncyBubyBuYXZiYXIKICAgICAgICBpZiAoIW5hdkJhckN0cmwgfHwgbW9kYWxDdHJsKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQoJGF0dHIudGl0bGUpKSB7CgogICAgICAgICAgdmFyIGluaXRpYWxUaXRsZSA9ICRhdHRyLnRpdGxlOwogICAgICAgICAgbmF2QmFyQ3RybC5jaGFuZ2VUaXRsZShpbml0aWFsVGl0bGUsICRzY29wZS4kbmF2RGlyZWN0aW9uKTsKCiAgICAgICAgICAvLyB3YXRjaCBmb3IgY2hhbmdlcyBpbiB0aGUgdGl0bGUsIGRvbid0IHNldCBpbml0aWFsIHZhbHVlIGFzIGNoYW5nZVRpdGxlIGRvZXMgdGhhdAogICAgICAgICAgJGF0dHIuJG9ic2VydmUoJ3RpdGxlJywgZnVuY3Rpb24odmFsLCBvbGRWYWwpIHsKICAgICAgICAgICAgbmF2QmFyQ3RybC5zZXRUaXRsZSh2YWwpOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgaGlkZUJhY2tBdHRyID0gYW5ndWxhci5pc0RlZmluZWQoJGF0dHIuaGlkZUJhY2tCdXR0b24pID8KICAgICAgICAgICRhdHRyLmhpZGVCYWNrQnV0dG9uIDoKICAgICAgICAgICdmYWxzZSc7CiAgICAgICAgJHNjb3BlLiR3YXRjaChoaWRlQmFja0F0dHIsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAvLyBTaG91bGQgd2UgaGlkZSBhIGJhY2sgYnV0dG9uIHdoZW4gdGhpcyB0YWIgaXMgc2hvd24KICAgICAgICAgIG5hdkJhckN0cmwuc2hvd0JhY2tCdXR0b24oIXZhbHVlKTsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIGhpZGVOYXZBdHRyID0gYW5ndWxhci5pc0RlZmluZWQoJGF0dHIuaGlkZU5hdkJhcikgPwogICAgICAgICAgJGF0dHIuaGlkZU5hdkJhciA6CiAgICAgICAgICAnZmFsc2UnOwogICAgICAgICRzY29wZS4kd2F0Y2goaGlkZU5hdkF0dHIsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAvLyBTaG91bGQgdGhlIG5hdiBiYXIgYmUgaGlkZGVuIGZvciB0aGlzIHZpZXcgb3Igbm90PwogICAgICAgICAgbmF2QmFyQ3RybC5zaG93QmFyKCF2YWx1ZSk7CiAgICAgICAgfSk7CgogICAgICB9OwogICAgfQogIH07Cn1dKTsKCiFmdW5jdGlvbihlKXtpZigib2JqZWN0Ij09dHlwZW9mIGV4cG9ydHMmJiJ1bmRlZmluZWQiIT10eXBlb2YgbW9kdWxlKW1vZHVsZS5leHBvcnRzPWUoKTtlbHNlIGlmKCJmdW5jdGlvbiI9PXR5cGVvZiBkZWZpbmUmJmRlZmluZS5hbWQpZGVmaW5lKFtdLGUpO2Vsc2V7dmFyIGY7InVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3c/Zj13aW5kb3c6InVuZGVmaW5lZCIhPXR5cGVvZiBnbG9iYWw/Zj1nbG9iYWw6InVuZGVmaW5lZCIhPXR5cGVvZiBzZWxmJiYoZj1zZWxmKSxmLmNvbGxpZGU9ZSgpfX0oZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIil9dmFyIGY9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGYuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sZixmLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09ImZ1bmN0aW9uIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkoezE6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuNi4zCihmdW5jdGlvbigpIHsKICB2YXIgZ2V0TmFub1NlY29uZHMsIGhydGltZSwgbG9hZFRpbWU7CgogIGlmICgodHlwZW9mIHBlcmZvcm1hbmNlICE9PSAidW5kZWZpbmVkIiAmJiBwZXJmb3JtYW5jZSAhPT0gbnVsbCkgJiYgcGVyZm9ybWFuY2Uubm93KSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICB9OwogIH0gZWxzZSBpZiAoKHR5cGVvZiBwcm9jZXNzICE9PSAidW5kZWZpbmVkIiAmJiBwcm9jZXNzICE9PSBudWxsKSAmJiBwcm9jZXNzLmhydGltZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIChnZXROYW5vU2Vjb25kcygpIC0gbG9hZFRpbWUpIC8gMWU2OwogICAgfTsKICAgIGhydGltZSA9IHByb2Nlc3MuaHJ0aW1lOwogICAgZ2V0TmFub1NlY29uZHMgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGhyOwogICAgICBociA9IGhydGltZSgpOwogICAgICByZXR1cm4gaHJbMF0gKiAxZTkgKyBoclsxXTsKICAgIH07CiAgICBsb2FkVGltZSA9IGdldE5hbm9TZWNvbmRzKCk7CiAgfSBlbHNlIGlmIChEYXRlLm5vdykgewogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIERhdGUubm93KCkgLSBsb2FkVGltZTsKICAgIH07CiAgICBsb2FkVGltZSA9IERhdGUubm93KCk7CiAgfSBlbHNlIHsKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIGxvYWRUaW1lOwogICAgfTsKICAgIGxvYWRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgfQoKfSkuY2FsbCh0aGlzKTsKCi8qCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXBlcmZvcm1hbmNlLW5vdy5tYXAKKi8KCn0pLmNhbGwodGhpcyxfZGVyZXFfKCJxaERJUlQiKSkKfSx7InFoRElSVCI6MTN9XSwyOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXsKdmFyIG5vdyA9IF9kZXJlcV8oJ3BlcmZvcm1hbmNlLW5vdycpCiAgLCBnbG9iYWwgPSB0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyA/IHt9IDogd2luZG93CiAgLCB2ZW5kb3JzID0gWydtb3onLCAnd2Via2l0J10KICAsIHN1ZmZpeCA9ICdBbmltYXRpb25GcmFtZScKICAsIHJhZiA9IGdsb2JhbFsncmVxdWVzdCcgKyBzdWZmaXhdCiAgLCBjYWYgPSBnbG9iYWxbJ2NhbmNlbCcgKyBzdWZmaXhdIHx8IGdsb2JhbFsnY2FuY2VsUmVxdWVzdCcgKyBzdWZmaXhdCgpmb3IodmFyIGkgPSAwOyBpIDwgdmVuZG9ycy5sZW5ndGggJiYgIXJhZjsgaSsrKSB7CiAgcmFmID0gZ2xvYmFsW3ZlbmRvcnNbaV0gKyAnUmVxdWVzdCcgKyBzdWZmaXhdCiAgY2FmID0gZ2xvYmFsW3ZlbmRvcnNbaV0gKyAnQ2FuY2VsJyArIHN1ZmZpeF0KICAgICAgfHwgZ2xvYmFsW3ZlbmRvcnNbaV0gKyAnQ2FuY2VsUmVxdWVzdCcgKyBzdWZmaXhdCn0KCi8vIFNvbWUgdmVyc2lvbnMgb2YgRkYgaGF2ZSByQUYgYnV0IG5vdCBjQUYKaWYoIXJhZiB8fCAhY2FmKSB7CiAgdmFyIGxhc3QgPSAwCiAgICAsIGlkID0gMAogICAgLCBxdWV1ZSA9IFtdCiAgICAsIGZyYW1lRHVyYXRpb24gPSAxMDAwIC8gNjAKCiAgcmFmID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIGlmKHF1ZXVlLmxlbmd0aCA9PT0gMCkgewogICAgICB2YXIgX25vdyA9IG5vdygpCiAgICAgICAgLCBuZXh0ID0gTWF0aC5tYXgoMCwgZnJhbWVEdXJhdGlvbiAtIChfbm93IC0gbGFzdCkpCiAgICAgIGxhc3QgPSBuZXh0ICsgX25vdwogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjcCA9IHF1ZXVlLnNsaWNlKDApCiAgICAgICAgLy8gQ2xlYXIgcXVldWUgaGVyZSB0byBwcmV2ZW50CiAgICAgICAgLy8gY2FsbGJhY2tzIGZyb20gYXBwZW5kaW5nIGxpc3RlbmVycwogICAgICAgIC8vIHRvIHRoZSBjdXJyZW50IGZyYW1lJ3MgcXVldWUKICAgICAgICBxdWV1ZS5sZW5ndGggPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjcC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFjcFtpXS5jYW5jZWxsZWQpIHsKICAgICAgICAgICAgY3BbaV0uY2FsbGJhY2sobGFzdCkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIG5leHQpCiAgICB9CiAgICBxdWV1ZS5wdXNoKHsKICAgICAgaGFuZGxlOiArK2lkLAogICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgIGNhbmNlbGxlZDogZmFsc2UKICAgIH0pCiAgICByZXR1cm4gaWQKICB9CgogIGNhZiA9IGZ1bmN0aW9uKGhhbmRsZSkgewogICAgZm9yKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmKHF1ZXVlW2ldLmhhbmRsZSA9PT0gaGFuZGxlKSB7CiAgICAgICAgcXVldWVbaV0uY2FuY2VsbGVkID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkgewogIC8vIFdyYXAgaW4gYSBuZXcgZnVuY3Rpb24gdG8gcHJldmVudAogIC8vIGBjYW5jZWxgIHBvdGVudGlhbGx5IGJlaW5nIGFzc2lnbmVkCiAgLy8gdG8gdGhlIG5hdGl2ZSByQUYgZnVuY3Rpb24KICByZXR1cm4gcmFmLmFwcGx5KGdsb2JhbCwgYXJndW1lbnRzKQp9Cm1vZHVsZS5leHBvcnRzLmNhbmNlbCA9IGZ1bmN0aW9uKCkgewogIGNhZi5hcHBseShnbG9iYWwsIGFyZ3VtZW50cykKfQoKfSx7InBlcmZvcm1hbmNlLW5vdyI6M31dLDM6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz1fZGVyZXFfKDEpCn0seyJxaERJUlQiOjEzfV0sNDpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7CgovLyBJbnRlcnBvbGF0aW9uIGRpc2FibGVkIGZvciBub3cKLy8gdmFyIGludGVycG9sYXRlID0gcmVxdWlyZSgnLi9jb3JlL2ludGVycG9sYXRlJyk7Ci8vIHZhciBjc3NGZWF0dXJlID0gcmVxdWlyZSgnZmVhdHVyZS9jc3MnKTsKCnZhciB0aW1lbGluZSA9IF9kZXJlcV8oJy4vY29yZS90aW1lbGluZScpOwp2YXIgZHluYW1pY3MgPSBfZGVyZXFfKCcuL2NvcmUvZHluYW1pY3MnKTsKdmFyIGVhc2luZ0Z1bmN0aW9ucyA9IF9kZXJlcV8oJy4vY29yZS9lYXNpbmctZnVuY3Rpb25zJyk7Cgp2YXIgdWlkID0gX2RlcmVxXygnLi91dGlsL3VpZCcpOwp2YXIgRXZlbnRFbWl0dGVyID0gX2RlcmVxXygnLi91dGlsL3NpbXBsZS1lbWl0dGVyJyk7CgpmdW5jdGlvbiBjbGFtcChtaW4sIG4sIG1heCkgeyByZXR1cm4gTWF0aC5tYXgobWluLCBNYXRoLm1pbihuLCBtYXgpKTsgfQoKbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRvcjsKCmZ1bmN0aW9uIEFuaW1hdG9yKG9wdHMpIHsKICAvL2lmIGBuZXdgIGtleXdvcmQgaXNuJ3QgcHJvdmlkZWQsIGRvIGl0IGZvciB1c2VyCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEFuaW1hdG9yKSkgewogICAgcmV0dXJuIG5ldyBBbmltYXRvcihvcHRzKTsKICB9CgogIG9wdHMgPSBvcHRzIHx8IHt9OwoKICAvL1ByaXZhdGUgc3RhdGUgZ29lcyBpbiB0aGlzLl8KICB0aGlzLl8gPSB7CiAgICBpZDogdWlkKCksCiAgICBwZXJjZW50OiAwLAogICAgZHVyYXRpb246IDUwMCwKICAgIGlzUmV2ZXJzZTogZmFsc2UKICB9OwoKICB2YXIgZW1pdHRlciA9IHRoaXMuXy5lbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpOwogIHRoaXMuXy5vbkRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgIGVtaXR0ZXIuZW1pdCgnZGVzdHJveScpOwogIH07CiAgdGhpcy5fLm9uU3RvcCA9IGZ1bmN0aW9uKHdhc0NvbXBsZXRlZCkgewogICAgZW1pdHRlci5lbWl0KCdzdG9wJywgd2FzQ29tcGxldGVkKTsKICAgIHdhc0NvbXBsZXRlZCAmJiBlbWl0dGVyLmVtaXQoJ2NvbXBsZXRlJyk7CiAgfTsKICB0aGlzLl8ub25TdGFydCA9IGZ1bmN0aW9uKCkgewogICAgZW1pdHRlci5lbWl0KCdzdGFydCcpOwogIH07CiAgdGhpcy5fLm9uU3RlcCA9IGZ1bmN0aW9uKHYpIHsKICAgIGVtaXR0ZXIuZW1pdCgnc3RlcCcsIHYpOwogIH07CgogIG9wdHMuZHVyYXRpb24gJiYgdGhpcy5kdXJhdGlvbihvcHRzLmR1cmF0aW9uKTsKICBvcHRzLnBlcmNlbnQgJiYgdGhpcy5wZXJjZW50KG9wdHMucGVyY2VudCk7CiAgb3B0cy5lYXNpbmcgJiYgdGhpcy5lYXNpbmcob3B0cy5lYXNpbmcpOwogIG9wdHMucmV2ZXJzZSAmJiB0aGlzLnJldmVyc2Uob3B0cy5yZXZlcnNlKTsKfQoKQW5pbWF0b3IucHJvdG90eXBlID0gewoKICByZXZlcnNlOiBmdW5jdGlvbihyZXZlcnNlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICB0aGlzLl8uaXNSZXZlcnNlID0gISFyZXZlcnNlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiB0aGlzLl8uaXNSZXZlcnNlOwogIH0sCgogIGVhc2luZzogZnVuY3Rpb24oZWFzaW5nKSB7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiBlYXNpbmc7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlID09PSAnc3RyaW5nJyB8fCB0eXBlID09PSAnb2JqZWN0JykgewogICAgICAgIHRoaXMuXy5lYXNpbmcgPSBmaWd1cmVPdXRFYXNpbmcoZWFzaW5nKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiB0aGlzLl8uZWFzaW5nOwogIH0sCgogIHBlcmNlbnQ6IGZ1bmN0aW9uKHBlcmNlbnQpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGlmICh0eXBlb2YgcGVyY2VudCA9PT0gJ251bWJlcicpIHsKICAgICAgICB0aGlzLl8ucGVyY2VudCA9IGNsYW1wKDAsIHBlcmNlbnQsIDEpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcoKSkgewogICAgICAgIHRoaXMuXy5vblN0ZXAodGhpcy5fZ2V0VmFsdWVGb3JQZXJjZW50KHRoaXMuXy5wZXJjZW50KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fLnBlcmNlbnQ7CiAgfSwKCiAgZHVyYXRpb246IGZ1bmN0aW9uKGR1cmF0aW9uKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAnbnVtYmVyJyAmJiBkdXJhdGlvbiA+IDApIHsKICAgICAgICB0aGlzLl8uZHVyYXRpb24gPSBkdXJhdGlvbjsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiB0aGlzLl8uZHVyYXRpb247CiAgfSwKCiAgLyoqCiAgICogSW50ZXJwb2xhdGlvbiBpcyBkaXNhYmxlZCBmb3Igbm93LgogICAqLwogIC8vIGFkZEludGVycG9sYXRpb246IGZ1bmN0aW9uKGVsLCBzdGFydGluZ1N0eWxlcywgZW5kaW5nU3R5bGVzKSB7CiAgLy8gICB2YXIgaW50ZXJwb2xhdG9yczsKICAvLyAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgLy8gICAgIHN5bmNTdHlsZXMoc3RhcnRpbmdTdHlsZXMsIGVuZGluZ1N0eWxlcywgd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpKTsKICAvLyAgICAgaW50ZXJwb2xhdG9ycyA9IG1ha2VQcm9wZXJ0eUludGVycG9sYXRvcnMoc3RhcnRpbmdTdHlsZXMsIGVuZGluZ1N0eWxlcyk7CgogIC8vICAgICB0aGlzLm9uKCdzdGVwJywgc2V0U3R5bGVzKTsKICAvLyAgICAgcmV0dXJuIGZ1bmN0aW9uIHVuYmluZCgpIHsKICAvLyAgICAgICB0aGlzLm9mZignc3RlcCcsIHNldFN0eWxlcyk7CiAgLy8gICAgIH07CiAgLy8gICB9CiAgLy8gICBmdW5jdGlvbiBzZXRTdHlsZXModikgewogIC8vICAgICBmb3IgKHZhciBwcm9wZXJ0eSBpbiBpbnRlcnBvbGF0b3JzKSB7CiAgLy8gICAgICAgZWwuc3R5bGVbcHJvcGVydHldID0gaW50ZXJwb2xhdG9yc1twcm9wZXJ0eV0odik7CiAgLy8gICAgIH0KICAvLyAgIH0KICAvLyB9LAoKICBpc1J1bm5pbmc6IGZ1bmN0aW9uKCkgeyAKICAgIHJldHVybiAhIXRoaXMuXy5pc1J1bm5pbmc7IAogIH0sCgogIHByb21pc2U6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIHsKICAgICAgdGhlbjogZnVuY3Rpb24oY2IpIHsKICAgICAgICBzZWxmLm9uY2UoJ3N0b3AnLCBjYik7CiAgICAgIH0KICAgIH07CiAgfSwKCiAgb246IGZ1bmN0aW9uKGV2ZW50VHlwZSwgbGlzdGVuZXIpIHsKICAgIHRoaXMuXy5lbWl0dGVyLm9uKGV2ZW50VHlwZSwgbGlzdGVuZXIpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBvbmNlOiBmdW5jdGlvbihldmVudFR5cGUsIGxpc3RlbmVyKSB7CiAgICB0aGlzLl8uZW1pdHRlci5vbmNlKGV2ZW50VHlwZSwgbGlzdGVuZXIpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBvZmY6IGZ1bmN0aW9uKGV2ZW50VHlwZSwgbGlzdGVuZXIpIHsKICAgIHRoaXMuXy5lbWl0dGVyLm9mZihldmVudFR5cGUsIGxpc3RlbmVyKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zdG9wKCk7CiAgICB0aGlzLl8ub25EZXN0cm95KCk7CiAgICB0aGlzLm9mZigpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuXy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICB0aGlzLl8uaXNSdW5uaW5nID0gZmFsc2U7CiAgICB0aW1lbGluZS5hbmltYXRpb25TdG9wcGVkKHRoaXMpOwoKICAgIHRoaXMuXy5vblN0b3AodGhpcy5faXNDb21wbGV0ZSgpKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIHJlc3RhcnQ6IGZ1bmN0aW9uKGltbWVkaWF0ZSkgewogICAgaWYgKHRoaXMuXy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICB0aGlzLl8ucGVyY2VudCA9IHRoaXMuX2dldFN0YXJ0UGVyY2VudCgpOwoKICAgIHJldHVybiB0aGlzLnN0YXJ0KCEhaW1tZWRpYXRlKTsKICB9LAoKICBzdGFydDogZnVuY3Rpb24oaW1tZWRpYXRlKSB7CiAgICBpZiAodGhpcy5fLmlzUnVubmluZykgcmV0dXJuOwoKICAgIGlmIChpbW1lZGlhdGUpIHsKICAgICAgdGhpcy5fLm9uU3RlcCh0aGlzLl9nZXRWYWx1ZUZvclBlcmNlbnQodGhpcy5fLnBlcmNlbnQpKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuXy5pc1N0YXJ0aW5nID0gdHJ1ZTsKICAgIH0KCiAgICB0aGlzLl8uaXNSdW5uaW5nID0gdHJ1ZTsKICAgIHRpbWVsaW5lLmFuaW1hdGlvblN0YXJ0ZWQodGhpcyk7CgogICAgdGhpcy5fLm9uU3RhcnQoKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIF9pc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiAhdGhpcy5fLmlzUnVubmluZyAmJiAKICAgICAgdGhpcy5fLnBlcmNlbnQgPT09IHRoaXMuX2dldEVuZFBlcmNlbnQoKTsKICB9LAogIF9nZXRFbmRQZXJjZW50OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl8uaXNSZXZlcnNlID8gMCA6IDE7CiAgfSwKICBfZ2V0U3RhcnRQZXJjZW50OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl8uaXNSZXZlcnNlID8gMSA6IDA7CiAgfSwKCiAgX2dldFZhbHVlRm9yUGVyY2VudDogZnVuY3Rpb24ocGVyY2VudCkgewogICAgaWYgKHRoaXMuXy5lYXNpbmcpIHsKICAgICAgcmV0dXJuIHRoaXMuXy5lYXNpbmcocGVyY2VudCwgdGhpcy5fLmR1cmF0aW9uKTsKICAgIH0KICAgIHJldHVybiBwZXJjZW50OwogIH0sCgogIF90aWNrOiBmdW5jdGlvbihkZWx0YVQpIHsKICAgIHZhciBzdGF0ZSA9IHRoaXMuXzsKCiAgICAvL0ZpcnN0IHRpY2ssIGRvbid0IHVwIHRoZSBwZXJjZW50CiAgICBpZiAoc3RhdGUuaXNTdGFydGluZykgewogICAgICBzdGF0ZS5pc1N0YXJ0aW5nID0gZmFsc2U7CiAgICB9IGVsc2UgaWYgKHN0YXRlLmlzUmV2ZXJzZSkgewogICAgICBzdGF0ZS5wZXJjZW50ID0gTWF0aC5tYXgoMCwgc3RhdGUucGVyY2VudCAtIChkZWx0YVQgLyBzdGF0ZS5kdXJhdGlvbikpOwogICAgfSBlbHNlIHsKICAgICAgc3RhdGUucGVyY2VudCA9IE1hdGgubWluKDEsIHN0YXRlLnBlcmNlbnQgKyAoZGVsdGFUIC8gc3RhdGUuZHVyYXRpb24pKTsKICAgIH0KICAgIAogICAgc3RhdGUub25TdGVwKHRoaXMuX2dldFZhbHVlRm9yUGVyY2VudChzdGF0ZS5wZXJjZW50KSk7CgogICAgaWYgKHN0YXRlLnBlcmNlbnQgPT09IHRoaXMuX2dldEVuZFBlcmNlbnQoKSkgewogICAgICB0aGlzLnN0b3AoKTsKICAgIH0KICB9LAoKfTsKCmZ1bmN0aW9uIGZpZ3VyZU91dEVhc2luZyhlYXNpbmcpIHsKICBpZiAodHlwZW9mIGVhc2luZyA9PT0gJ29iamVjdCcpIHsKICAgIHZhciBkeW5hbWljVHlwZSA9IHR5cGVvZiBlYXNpbmcudHlwZSA9PT0gJ3N0cmluZycgJiYKICAgICAgZWFzaW5nLnR5cGUudG9Mb3dlckNhc2UoKS50cmltKCk7CgogICAgaWYgKCFkeW5hbWljc1tkeW5hbWljVHlwZV0pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICdJbnZhbGlkIGVhc2luZyBkeW5hbWljcyBvYmplY3QgdHlwZSAiJyArIGVhc2luZy50eXBlICsgJyIuICcgKwogICAgICAgICdBdmFpbGFibGUgZHluYW1pY3MgdHlwZXM6ICcgKyBPYmplY3Qua2V5cyhkeW5hbWljcykuam9pbignLCAnKSArICcuJwogICAgICApOwogICAgfQogICAgcmV0dXJuIGR5bmFtaWNzW2R5bmFtaWNUeXBlXShlYXNpbmcpOwoKICB9IGVsc2UgaWYgKHR5cGVvZiBlYXNpbmcgPT09ICdzdHJpbmcnKSB7CiAgICBlYXNpbmcgPSBlYXNpbmcudG9Mb3dlckNhc2UoKS50cmltKCk7CiAgICAKICAgIGlmIChlYXNpbmcuaW5kZXhPZignY3ViaWMtYmV6aWVyKCcpID09PSAwKSB7CiAgICAgIHZhciBwYXJ0cyA9IGVhc2luZwogICAgICAgIC5yZXBsYWNlKCdjdWJpYy1iZXppZXIoJywgJycpCiAgICAgICAgLnJlcGxhY2UoJyknLCAnJykKICAgICAgICAuc3BsaXQoJywnKQogICAgICAgIC5tYXAoZnVuY3Rpb24odikgewogICAgICAgICAgcmV0dXJuIHYudHJpbSgpOwogICAgICAgIH0pOwogICAgICByZXR1cm4gZWFzaW5nRnVuY3Rpb25zWydjdWJpYy1iZXppZXInXShwYXJ0c1swXSwgcGFydHNbMV0sIHBhcnRzWzJdLCBwYXJ0c1szXSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZm4gPSBlYXNpbmdGdW5jdGlvbnNbZWFzaW5nXTsKICAgICAgaWYgKCFmbikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICdJbnZhbGlkIGVhc2luZyBmdW5jdGlvbiAiJyArIGVhc2luZyArICciLiAnICsKICAgICAgICAgICdBdmFpbGFibGUgZWFzaW5nIGZ1bmN0aW9uczogJyArIE9iamVjdC5rZXlzKGVhc2luZ0Z1bmN0aW9ucykuam9pbignLCAnKSArICcuJwogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIGVhc2luZ0Z1bmN0aW9uc1tlYXNpbmddKCk7CiAgICB9CiAgfSBlbHNlIGlmICh0eXBlb2YgZWFzaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gZWFzaW5nOwogIH0KfQoKLy8gLyoKLy8gICogVHdlZW5pbmcgaGVscGVycwovLyAgKi8KLy8gZnVuY3Rpb24gc3luY1N0eWxlcyhzdGFydGluZ1N0eWxlcywgZW5kaW5nU3R5bGVzLCBjb21wdXRlZFN0eWxlKSB7Ci8vICAgdmFyIHByb3BlcnR5OwovLyAgIGZvciAocHJvcGVydHkgaW4gc3RhcnRpbmdTdHlsZXMpIHsKLy8gICAgIGlmICghZW5kaW5nU3R5bGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSkgewovLyAgICAgICBkZWxldGUgc3RhcnRpbmdTdHlsZXNbcHJvcGVydHldOwovLyAgICAgfQovLyAgIH0KLy8gICBmb3IgKHByb3BlcnR5IGluIGVuZGluZ1N0eWxlcykgewovLyAgICAgaWYgKCFzdGFydGluZ1N0eWxlcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHsKLy8gICAgICAgc3RhcnRpbmdTdHlsZXNbcHJvcGVydHldID0gY29tcHV0ZWRTdHlsZVt2ZW5kb3JpemVQcm9wZXJ0eU5hbWUocHJvcGVydHkpXTsKLy8gICAgIH0KLy8gICB9Ci8vIH0KCi8vIGZ1bmN0aW9uIG1ha2VQcm9wZXJ0eUludGVycG9sYXRvcnMoc3RhcnRpbmdTdHlsZXMsIGVuZGluZ1N0eWxlcykgewovLyAgIHZhciBpbnRlcnBvbGF0b3JzID0ge307Ci8vICAgdmFyIHByb3BlcnR5OwovLyAgIGZvciAocHJvcGVydHkgaW4gc3RhcnRpbmdTdHlsZXMpIHsKLy8gICAgIGludGVycG9sYXRvcnNbdmVuZG9yaXplUHJvcGVydHlOYW1lKHByb3BlcnR5KV0gPSBpbnRlcnBvbGF0ZS5wcm9wZXJ0eUludGVycG9sYXRvcigKLy8gICAgICAgcHJvcGVydHksIHN0YXJ0aW5nU3R5bGVzW3Byb3BlcnR5XSwgZW5kaW5nU3R5bGVzW3Byb3BlcnR5XQovLyAgICAgKTsKLy8gICB9Ci8vICAgcmV0dXJuIGludGVycG9sYXRvcnM7Ci8vIH0KCi8vIHZhciB0cmFuc2Zvcm1Qcm9wZXJ0eTsKLy8gZnVuY3Rpb24gdmVuZG9yaXplUHJvcGVydHlOYW1lKHByb3BlcnR5KSB7Ci8vICAgaWYgKHByb3BlcnR5ID09PSAndHJhbnNmb3JtJykgewovLyAgICAgLy9TZXQgdHJhbnNmb3JtUHJvcGVydHkgbGF6aWx5LCB0byBiZSBzdXJlIERPTSBoYXMgbG9hZGVkIGFscmVhZHkgd2hlbiB1c2luZyBpdAovLyAgICAgcmV0dXJuIHRyYW5zZm9ybVByb3BlcnR5IHx8IAovLyAgICAgICAodHJhbnNmb3JtUHJvcGVydHkgPSBjc3NGZWF0dXJlKCd0cmFuc2Zvcm0nKS5wcm9wZXJ0eSk7Ci8vICAgfSBlbHNlIHsKLy8gICAgIHJldHVybiBwcm9wZXJ0eTsKLy8gICB9Ci8vIH0KCn0seyIuL2NvcmUvZHluYW1pY3MiOjYsIi4vY29yZS9lYXNpbmctZnVuY3Rpb25zIjo3LCIuL2NvcmUvdGltZWxpbmUiOjgsIi4vdXRpbC9zaW1wbGUtZW1pdHRlciI6MTEsIi4vdXRpbC91aWQiOjEyfV0sNTpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7Ci8qCiAqIENvcHlyaWdodCAoQykgMjAwOCBBcHBsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dAogKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMKICogYXJlIG1ldDoKICogMS4gUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKICogICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgogKiAyLiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodAogKiAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlCiAqICAgIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiAqCiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgQVBQTEUgSU5DLiBgYEFTIElTJycgQU5EIEFOWQogKiBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRQogKiBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIKICogUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4gIElOIE5PIEVWRU5UIFNIQUxMIEFQUExFIElOQy4gT1IKICogQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsCiAqIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKICogUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SCiAqIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkKICogT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUCiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRQogKiBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgogKi8KCi8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtdHJhbnNpdGlvbnMvI3RyYW5zaXRpb24tZWFzaW5nLWZ1bmN0aW9uCm1vZHVsZS5leHBvcnRzID0gIHsKICAvKgogICAqIEBwYXJhbSB4IHtudW1iZXJ9IHRoZSB2YWx1ZSBvZiB4IGFsb25nIHRoZSBiZXppZXIgY3VydmUsIDAuMCA8PSB4IDw9IDEuMAogICAqIEBwYXJhbSBkdXJhdGlvbiB7bnVtYmVyfSB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbiBpbiBtaWxsaXNlY29uZHMKICAgKiBAcmV0dXJuIHtudW1iZXJ9IHRoZSB5IHZhbHVlIGFsb25nIHRoZSBiZXppZXIgY3VydmUKICAgKi8KICBsaW5lYXI6IHVuaXRCZXppZXIoMC4wLCAwLjAsIDEuMCwgMS4wKSwKCiAgLyoKICAgKiBAcGFyYW0geCB7bnVtYmVyfSB0aGUgdmFsdWUgb2YgeCBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlLCAwLjAgPD0geCA8PSAxLjAKICAgKiBAcGFyYW0gZHVyYXRpb24ge251bWJlcn0gdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb24gaW4gbWlsbGlzZWNvbmRzCiAgICogQHJldHVybiB7bnVtYmVyfSB0aGUgeSB2YWx1ZSBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlCiAgICovCiAgZWFzZTogdW5pdEJlemllcigwLjI1LCAwLjEsIDAuMjUsIDEuMCksCgogIC8qCiAgICogQHBhcmFtIHgge251bWJlcn0gdGhlIHZhbHVlIG9mIHggYWxvbmcgdGhlIGJlemllciBjdXJ2ZSwgMC4wIDw9IHggPD0gMS4wCiAgICogQHBhcmFtIGR1cmF0aW9uIHtudW1iZXJ9IHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGluIG1pbGxpc2Vjb25kcwogICAqIEByZXR1cm4ge251bWJlcn0gdGhlIHkgdmFsdWUgYWxvbmcgdGhlIGJlemllciBjdXJ2ZQogICAqLwogIGVhc2VJbjogdW5pdEJlemllcigwLjQyLCAwLCAxLjAsIDEuMCksCgogIC8qCiAgICogQHBhcmFtIHgge251bWJlcn0gdGhlIHZhbHVlIG9mIHggYWxvbmcgdGhlIGJlemllciBjdXJ2ZSwgMC4wIDw9IHggPD0gMS4wCiAgICogQHBhcmFtIGR1cmF0aW9uIHtudW1iZXJ9IHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGluIG1pbGxpc2Vjb25kcwogICAqIEByZXR1cm4ge251bWJlcn0gdGhlIHkgdmFsdWUgYWxvbmcgdGhlIGJlemllciBjdXJ2ZQogICAqLwogIGVhc2VPdXQ6IHVuaXRCZXppZXIoMCwgMCwgMC41OCwgMS4wKSwKCiAgLyoKICAgKiBAcGFyYW0geCB7bnVtYmVyfSB0aGUgdmFsdWUgb2YgeCBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlLCAwLjAgPD0geCA8PSAxLjAKICAgKiBAcGFyYW0gZHVyYXRpb24ge251bWJlcn0gdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb24gaW4gbWlsbGlzZWNvbmRzCiAgICogQHJldHVybiB7bnVtYmVyfSB0aGUgeSB2YWx1ZSBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlCiAgICovCiAgZWFzZUluT3V0OiB1bml0QmV6aWVyKDAuNDIsIDAsIDAuNTgsIDEuMCksCgogIC8qCiAgICogQHBhcmFtIHAxeCB7bnVtYmVyfSBYIGNvbXBvbmVudCBvZiBjb250cm9sIHBvaW50IDEKICAgKiBAcGFyYW0gcDF5IHtudW1iZXJ9IFkgY29tcG9uZW50IG9mIGNvbnRyb2wgcG9pbnQgMQogICAqIEBwYXJhbSBwMngge251bWJlcn0gWCBjb21wb25lbnQgb2YgY29udHJvbCBwb2ludCAyCiAgICogQHBhcmFtIHAyeSB7bnVtYmVyfSBZIGNvbXBvbmVudCBvZiBjb250cm9sIHBvaW50IDIKICAgKiBAcGFyYW0geCB7bnVtYmVyfSB0aGUgdmFsdWUgb2YgeCBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlLCAwLjAgPD0geCA8PSAxLjAKICAgKiBAcGFyYW0gZHVyYXRpb24ge251bWJlcn0gdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb24gaW4gbWlsbGlzZWNvbmRzCiAgICogQHJldHVybiB7bnVtYmVyfSB0aGUgeSB2YWx1ZSBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlCiAgICovCiAgY3ViaWNCZXppZXI6IGZ1bmN0aW9uKHAxeCwgcDF5LCBwMngsIHAyeSkgewogICAgcmV0dXJuIHVuaXRCZXppZXIocDF4LCBwMXksIHAyeCwgcDJ5KTsKICB9Cn07CgpmdW5jdGlvbiBCMSh0KSB7IHJldHVybiB0KnQqdDsgfQpmdW5jdGlvbiBCMih0KSB7IHJldHVybiAzKnQqdCooMS10KTsgfQpmdW5jdGlvbiBCMyh0KSB7IHJldHVybiAzKnQqKDEtdCkqKDEtdCk7IH0KZnVuY3Rpb24gQjQodCkgeyByZXR1cm4gKDEtdCkqKDEtdCkqKDEtdCk7IH0KCi8qCiAqIEphdmFTY3JpcHQgcG9ydCBvZiBXZWJraXQgaW1wbGVtZW50YXRpb24gb2YgQ1NTIGN1YmljLWJlemllcihwMXgucDF5LHAyeCxwMnkpIGJ5IGh0dHA6Ly9tY2subWUKICogaHR0cDovL3N2bi53ZWJraXQub3JnL3JlcG9zaXRvcnkvd2Via2l0L3RydW5rL1NvdXJjZS9XZWJDb3JlL3BsYXRmb3JtL2dyYXBoaWNzL1VuaXRCZXppZXIuaAogKi8KCi8qCiAqIER1cmF0aW9uIHZhbHVlIHRvIHVzZSB3aGVuIG9uZSBpcyBub3Qgc3BlY2lmaWVkICg0MDBtcyBpcyBhIGNvbW1vbiB2YWx1ZSkuCiAqIEBjb25zdAogKiBAdHlwZSB7bnVtYmVyfQogKi8KdmFyIERFRkFVTFRfRFVSQVRJT04gPSA0MDA7Ly9tcwoKLyoKICogVGhlIGVwc2lsb24gdmFsdWUgd2UgcGFzcyB0byBVbml0QmV6aWVyOjpzb2x2ZSBnaXZlbiB0aGF0IHRoZSBhbmltYXRpb24gaXMgZ29pbmcgdG8gcnVuIG92ZXIgfGR1cnwgc2Vjb25kcy4KICogVGhlIGxvbmdlciB0aGUgYW5pbWF0aW9uLCB0aGUgbW9yZSBwcmVjaXNpb24gd2UgbmVlZCBpbiB0aGUgZWFzaW5nIGZ1bmN0aW9uIHJlc3VsdCB0byBhdm9pZCB1Z2x5IGRpc2NvbnRpbnVpdGllcy4KICogaHR0cDovL3N2bi53ZWJraXQub3JnL3JlcG9zaXRvcnkvd2Via2l0L3RydW5rL1NvdXJjZS9XZWJDb3JlL3BhZ2UvYW5pbWF0aW9uL0FuaW1hdGlvbkJhc2UuY3BwCiAqLwpmdW5jdGlvbiBzb2x2ZUVwc2lsb24oZHVyYXRpb24pIHsKICByZXR1cm4gMS4wIC8gKDIwMC4wICogZHVyYXRpb24pOwp9CgovKgogKiBEZWZpbmVzIGEgY3ViaWMtYmV6aWVyIGN1cnZlIGdpdmVuIHRoZSBtaWRkbGUgdHdvIGNvbnRyb2wgcG9pbnRzLgogKiBOT1RFOiBmaXJzdCBhbmQgbGFzdCBjb250cm9sIHBvaW50cyBhcmUgaW1wbGljaXRseSAoMCwwKSBhbmQgKDEsMSkuCiAqIEBwYXJhbSBwMXgge251bWJlcn0gWCBjb21wb25lbnQgb2YgY29udHJvbCBwb2ludCAxCiAqIEBwYXJhbSBwMXkge251bWJlcn0gWSBjb21wb25lbnQgb2YgY29udHJvbCBwb2ludCAxCiAqIEBwYXJhbSBwMngge251bWJlcn0gWCBjb21wb25lbnQgb2YgY29udHJvbCBwb2ludCAyCiAqIEBwYXJhbSBwMnkge251bWJlcn0gWSBjb21wb25lbnQgb2YgY29udHJvbCBwb2ludCAyCiAqLwpmdW5jdGlvbiB1bml0QmV6aWVyKHAxeCwgcDF5LCBwMngsIHAyeSkgewoKICAvLyBwcml2YXRlIG1lbWJlcnMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gQ2FsY3VsYXRlIHRoZSBwb2x5bm9taWFsIGNvZWZmaWNpZW50cywgaW1wbGljaXQgZmlyc3QgYW5kIGxhc3QgY29udHJvbCBwb2ludHMgYXJlICgwLDApIGFuZCAoMSwxKS4KCiAgLyoKICAgKiBYIGNvbXBvbmVudCBvZiBCZXppZXIgY29lZmZpY2llbnQgQwogICAqIEBjb25zdAogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgdmFyIGN4ID0gMy4wICogcDF4OwoKICAvKgogICAqIFggY29tcG9uZW50IG9mIEJlemllciBjb2VmZmljaWVudCBCCiAgICogQGNvbnN0CiAgICogQHR5cGUge251bWJlcn0KICAgKi8KICB2YXIgYnggPSAzLjAgKiAocDJ4IC0gcDF4KSAtIGN4OwoKICAvKgogICAqIFggY29tcG9uZW50IG9mIEJlemllciBjb2VmZmljaWVudCBBCiAgICogQGNvbnN0CiAgICogQHR5cGUge251bWJlcn0KICAgKi8KICB2YXIgYXggPSAxLjAgLSBjeCAtYng7CgogIC8qCiAgICogWSBjb21wb25lbnQgb2YgQmV6aWVyIGNvZWZmaWNpZW50IEMKICAgKiBAY29uc3QKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIHZhciBjeSA9IDMuMCAqIHAxeTsKCiAgLyoKICAgKiBZIGNvbXBvbmVudCBvZiBCZXppZXIgY29lZmZpY2llbnQgQgogICAqIEBjb25zdAogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgdmFyIGJ5ID0gMy4wICogKHAyeSAtIHAxeSkgLSBjeTsKCiAgLyoKICAgKiBZIGNvbXBvbmVudCBvZiBCZXppZXIgY29lZmZpY2llbnQgQQogICAqIEBjb25zdAogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgdmFyIGF5ID0gMS4wIC0gY3kgLSBieTsKCiAgLyoKICAgKiBAcGFyYW0gdCB7bnVtYmVyfSBwYXJhbWV0cmljIGVhc2luZyB2YWx1ZQogICAqIEByZXR1cm4ge251bWJlcn0KICAgKi8KICB2YXIgc2FtcGxlQ3VydmVYID0gZnVuY3Rpb24odCkgewogICAgLy8gYGF4IHReMyArIGJ4IHReMiArIGN4IHQnIGV4cGFuZGVkIHVzaW5nIEhvcm5lcidzIHJ1bGUuCiAgICByZXR1cm4gKChheCAqIHQgKyBieCkgKiB0ICsgY3gpICogdDsKICB9OwoKICAvKgogICAqIEBwYXJhbSB0IHtudW1iZXJ9IHBhcmFtZXRyaWMgZWFzaW5nIHZhbHVlCiAgICogQHJldHVybiB7bnVtYmVyfQogICAqLwogIHZhciBzYW1wbGVDdXJ2ZVkgPSBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gKChheSAqIHQgKyBieSkgKiB0ICsgY3kpICogdDsKICB9OwoKICAvKgogICAqIEBwYXJhbSB0IHtudW1iZXJ9IHBhcmFtZXRyaWMgZWFzaW5nIHZhbHVlCiAgICogQHJldHVybiB7bnVtYmVyfQogICAqLwogIHZhciBzYW1wbGVDdXJ2ZURlcml2YXRpdmVYID0gZnVuY3Rpb24odCkgewogICAgcmV0dXJuICgzLjAgKiBheCAqIHQgKyAyLjAgKiBieCkgKiB0ICsgY3g7CiAgfTsKCiAgLyoKICAgKiBHaXZlbiBhbiB4IHZhbHVlLCBmaW5kIGEgcGFyYW1ldHJpYyB2YWx1ZSBpdCBjYW1lIGZyb20uCiAgICogQHBhcmFtIHgge251bWJlcn0gdmFsdWUgb2YgeCBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlLCAwLjAgPD0geCA8PSAxLjAKICAgKiBAcGFyYW0gZXBzaWxvbiB7bnVtYmVyfSBhY2N1cmFjeSBsaW1pdCBvZiB0IGZvciB0aGUgZ2l2ZW4geAogICAqIEByZXR1cm4ge251bWJlcn0gdGhlIHQgdmFsdWUgY29ycmVzcG9uZGluZyB0byB4CiAgICovCiAgdmFyIHNvbHZlQ3VydmVYID0gZnVuY3Rpb24oeCwgZXBzaWxvbikgewogICAgdmFyIHQwOwogICAgdmFyIHQxOwogICAgdmFyIHQyOwogICAgdmFyIHgyOwogICAgdmFyIGQyOwogICAgdmFyIGk7CgogICAgLy8gRmlyc3QgdHJ5IGEgZmV3IGl0ZXJhdGlvbnMgb2YgTmV3dG9uJ3MgbWV0aG9kIC0tIG5vcm1hbGx5IHZlcnkgZmFzdC4KICAgIGZvciAodDIgPSB4LCBpID0gMDsgaSA8IDg7IGkrKykgewogICAgICB4MiA9IHNhbXBsZUN1cnZlWCh0MikgLSB4OwogICAgICBpZiAoTWF0aC5hYnMgKHgyKSA8IGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gdDI7CiAgICAgIH0KICAgICAgZDIgPSBzYW1wbGVDdXJ2ZURlcml2YXRpdmVYKHQyKTsKICAgICAgaWYgKE1hdGguYWJzKGQyKSA8IDFlLTYpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICB0MiA9IHQyIC0geDIgLyBkMjsKICAgIH0KCiAgICAvLyBGYWxsIGJhY2sgdG8gdGhlIGJpc2VjdGlvbiBtZXRob2QgZm9yIHJlbGlhYmlsaXR5LgogICAgdDAgPSAwLjA7CiAgICB0MSA9IDEuMDsKICAgIHQyID0geDsKCiAgICBpZiAodDIgPCB0MCkgewogICAgICByZXR1cm4gdDA7CiAgICB9CiAgICBpZiAodDIgPiB0MSkgewogICAgICByZXR1cm4gdDE7CiAgICB9CgogICAgd2hpbGUgKHQwIDwgdDEpIHsKICAgICAgeDIgPSBzYW1wbGVDdXJ2ZVgodDIpOwogICAgICBpZiAoTWF0aC5hYnMoeDIgLSB4KSA8IGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gdDI7CiAgICAgIH0KICAgICAgaWYgKHggPiB4MikgewogICAgICAgIHQwID0gdDI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdDEgPSB0MjsKICAgICAgfQogICAgICB0MiA9ICh0MSAtIHQwKSAqIDAuNSArIHQwOwogICAgfQoKICAgIC8vIEZhaWx1cmUuCiAgICByZXR1cm4gdDI7CiAgfTsKCiAgLyoKICAgKiBAcGFyYW0geCB7bnVtYmVyfSB0aGUgdmFsdWUgb2YgeCBhbG9uZyB0aGUgYmV6aWVyIGN1cnZlLCAwLjAgPD0geCA8PSAxLjAKICAgKiBAcGFyYW0gZXBzaWxvbiB7bnVtYmVyfSB0aGUgYWNjdXJhY3kgb2YgdCBmb3IgdGhlIGdpdmVuIHgKICAgKiBAcmV0dXJuIHtudW1iZXJ9IHRoZSB5IHZhbHVlIGFsb25nIHRoZSBiZXppZXIgY3VydmUKICAgKi8KICB2YXIgc29sdmUgPSBmdW5jdGlvbih4LCBlcHNpbG9uKSB7CiAgICByZXR1cm4gc2FtcGxlQ3VydmVZKHNvbHZlQ3VydmVYKHgsIGVwc2lsb24pKTsKICB9OwoKICAvLyBwdWJsaWMgaW50ZXJmYWNlIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8qCiAgICogRmluZCB0aGUgeSBvZiB0aGUgY3ViaWMtYmV6aWVyIGZvciBhIGdpdmVuIHggd2l0aCBhY2N1cmFjeSBkZXRlcm1pbmVkIGJ5IHRoZSBhbmltYXRpb24gZHVyYXRpb24uCiAgICogQHBhcmFtIHgge251bWJlcn0gdGhlIHZhbHVlIG9mIHggYWxvbmcgdGhlIGJlemllciBjdXJ2ZSwgMC4wIDw9IHggPD0gMS4wCiAgICogQHBhcmFtIGR1cmF0aW9uIHtudW1iZXJ9IHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGluIG1pbGxpc2Vjb25kcwogICAqIEByZXR1cm4ge251bWJlcn0gdGhlIHkgdmFsdWUgYWxvbmcgdGhlIGJlemllciBjdXJ2ZQogICAqLwogIHJldHVybiBmdW5jdGlvbih4LCBkdXJhdGlvbikgewogICAgcmV0dXJuIHNvbHZlKHgsIHNvbHZlRXBzaWxvbigrZHVyYXRpb24gfHwgREVGQVVMVF9EVVJBVElPTikpOwogIH07Cn0KCgp9LHt9XSw2OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEEgSFVHRSB0aGFuayB5b3UgdG8gZHluYW1pY3MuanMgd2hpY2ggaW5zcGlyZWQgdGhlc2UgZHluYW1pY3Mgc2ltdWxhdGlvbnMuCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9taWNoYWVsdmlsbGFyL2R5bmFtaWNzLmpzCiAqCiAqIEFsc28gbGljZW5zZWQgdW5kZXIgTUlUCiAqLwoKdmFyIGV4dGVuZCA9IF9kZXJlcV8oJy4uL3V0aWwvZXh0ZW5kJyk7Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBzcHJpbmc6IGR5bmFtaWNzU3ByaW5nLAogIGdyYXZpdHk6IGR5bmFtaWNzR3Jhdml0eQp9OwoKdmFyIHNwcmluZ0RlZmF1bHRzID0gewogIGZyZXF1ZW5jeTogMTUsCiAgZnJpY3Rpb246IDIwMCwKICBhbnRpY2lwYXRpb25TdHJlbmd0aDogMCwKICBhbnRpY2lwYXRpb25TaXplOiAwCn07CmZ1bmN0aW9uIGR5bmFtaWNzU3ByaW5nKG9wdHMpIHsKICBvcHRzID0gZXh0ZW5kKHt9LCBzcHJpbmdEZWZhdWx0cywgb3B0cyB8fCB7fSk7CgogIHJldHVybiBmdW5jdGlvbiBhdCh0LCBkdXJhdGlvbikgewogICAgdmFyIEEsIEF0LCBhLCBhbmdsZSwgYiwgZGVjYWwsIGZyZXF1ZW5jeSwgZnJpY3Rpb24sIGZyaWN0aW9uVCwgcywgdiwgeTAsIHlTLAogICAgX29wdHMgPSBvcHRzOwogICAgZnJlcXVlbmN5ID0gTWF0aC5tYXgoMSwgb3B0cy5mcmVxdWVuY3kpOwogICAgZnJpY3Rpb24gPSBNYXRoLnBvdygyMCwgb3B0cy5mcmljdGlvbiAvIDEwMCk7CiAgICBzID0gb3B0cy5hbnRpY2lwYXRpb25TaXplIC8gMTAwOwogICAgZGVjYWwgPSBNYXRoLm1heCgwLCBzKTsKICAgIGZyaWN0aW9uVCA9ICh0IC8gKDEgLSBzKSkgLSAocyAvICgxIC0gcykpOwogICAgaWYgKHQgPCBzKSB7CiAgICAgIEEgPSBmdW5jdGlvbih0KSB7CiAgICAgICAgdmFyIE0sIGEsIGIsIHgwLCB4MTsKICAgICAgICBNID0gMC44OwogICAgICAgIHgwID0gcyAvICgxIC0gcyk7CiAgICAgICAgeDEgPSAwOwogICAgICAgIGIgPSAoeDAgLSAoTSAqIHgxKSkgLyAoeDAgLSB4MSk7CiAgICAgICAgYSA9IChNIC0gYikgLyB4MDsKICAgICAgICByZXR1cm4gKGEgKiB0ICogX29wdHMuYW50aWNpcGF0aW9uU3RyZW5ndGggLyAxMDApICsgYjsKICAgICAgfTsKICAgICAgeVMgPSAocyAvICgxIC0gcykpIC0gKHMgLyAoMSAtIHMpKTsKICAgICAgeTAgPSAoMCAvICgxIC0gcykpIC0gKHMgLyAoMSAtIHMpKTsKICAgICAgYiA9IE1hdGguYWNvcygxIC8gQSh5UykpOwogICAgICBhID0gKE1hdGguYWNvcygxIC8gQSh5MCkpIC0gYikgLyAoZnJlcXVlbmN5ICogKC1zKSk7CiAgICB9IGVsc2UgewogICAgICBBID0gZnVuY3Rpb24odCkgewogICAgICAgIHJldHVybiBNYXRoLnBvdyhmcmljdGlvbiAvIDEwLCAtdCkgKiAoMSAtIHQpOwogICAgICB9OwogICAgICBiID0gMDsKICAgICAgYSA9IDE7CiAgICB9CiAgICBBdCA9IEEoZnJpY3Rpb25UKTsKICAgIGFuZ2xlID0gZnJlcXVlbmN5ICogKHQgLSBzKSAqIGEgKyBiOwogICAgdiA9IDEgLSAoQXQgKiBNYXRoLmNvcyhhbmdsZSkpOwogICAgLy9yZXR1cm4gW3QsIHYsIEF0LCBmcmljdGlvblQsIGFuZ2xlXTsKICAgIHJldHVybiB2OwogIH07Cn0KCnZhciBncmF2aXR5RGVmYXVsdHMgPSB7CiAgYm91bmNlOiA0MCwKICBncmF2aXR5OiAxMDAwLAogIGluaXRpYWxGb3JjZTogZmFsc2UKfTsKZnVuY3Rpb24gZHluYW1pY3NHcmF2aXR5KG9wdHMpIHsKICBvcHRzID0gZXh0ZW5kKHt9LCBncmF2aXR5RGVmYXVsdHMsIG9wdHMgfHwge30pOwogIHZhciBjdXJ2ZXMgPSBbXTsKCiAgaW5pdCgpOwoKICByZXR1cm4gYXQ7CgogIGZ1bmN0aW9uIGxlbmd0aCgpIHsKICAgIHZhciBMLCBiLCBib3VuY2UsIGN1cnZlLCBncmF2aXR5OwogICAgYm91bmNlID0gTWF0aC5taW4ob3B0cy5ib3VuY2UgLyAxMDAsIDgwKTsKICAgIGdyYXZpdHkgPSBvcHRzLmdyYXZpdHkgLyAxMDA7CiAgICBiID0gTWF0aC5zcXJ0KDIgLyBncmF2aXR5KTsKICAgIGN1cnZlID0gewogICAgICBhOiAtYiwKICAgICAgYjogYiwKICAgICAgSDogMQogICAgfTsKICAgIGlmIChvcHRzLmluaXRpYWxGb3JjZSkgewogICAgICBjdXJ2ZS5hID0gMDsKICAgICAgY3VydmUuYiA9IGN1cnZlLmIgKiAyOwogICAgfQogICAgd2hpbGUgKGN1cnZlLkggPiAwLjAwMSkgewogICAgICBMID0gY3VydmUuYiAtIGN1cnZlLmE7CiAgICAgIGN1cnZlID0gewogICAgICAgIGE6IGN1cnZlLmIsCiAgICAgICAgYjogY3VydmUuYiArIEwgKiBib3VuY2UsCiAgICAgICAgSDogY3VydmUuSCAqIGJvdW5jZSAqIGJvdW5jZQogICAgICB9OwogICAgfQogICAgcmV0dXJuIGN1cnZlLmI7CiAgfQoKICBmdW5jdGlvbiBpbml0KCkgewogICAgdmFyIEwsIGIsIGJvdW5jZSwgY3VydmUsIGdyYXZpdHksIF9yZXN1bHRzOwoKICAgIEwgPSBsZW5ndGgoKTsKICAgIGdyYXZpdHkgPSAob3B0cy5ncmF2aXR5IC8gMTAwKSAqIEwgKiBMOwogICAgYm91bmNlID0gTWF0aC5taW4ob3B0cy5ib3VuY2UgLyAxMDAsIDgwKTsKICAgIGIgPSBNYXRoLnNxcnQoMiAvIGdyYXZpdHkpOwogICAgY3VydmVzID0gW107CiAgICBjdXJ2ZSA9IHsKICAgICAgYTogLWIsCiAgICAgIGI6IGIsCiAgICAgIEg6IDEKICAgIH07CiAgICBpZiAob3B0cy5pbml0aWFsRm9yY2UpIHsKICAgICAgY3VydmUuYSA9IDA7CiAgICAgIGN1cnZlLmIgPSBjdXJ2ZS5iICogMjsKICAgIH0KICAgIGN1cnZlcy5wdXNoKGN1cnZlKTsKICAgIF9yZXN1bHRzID0gW107CiAgICB3aGlsZSAoY3VydmUuYiA8IDEgJiYgY3VydmUuSCA+IDAuMDAxKSB7CiAgICAgIEwgPSBjdXJ2ZS5iIC0gY3VydmUuYTsKICAgICAgY3VydmUgPSB7CiAgICAgICAgYTogY3VydmUuYiwKICAgICAgICBiOiBjdXJ2ZS5iICsgTCAqIGJvdW5jZSwKICAgICAgICBIOiBjdXJ2ZS5IICogYm91bmNlICogYm91bmNlCiAgICAgIH07CiAgICAgIF9yZXN1bHRzLnB1c2goY3VydmVzLnB1c2goY3VydmUpKTsKICAgIH0KICAgIHJldHVybiBfcmVzdWx0czsKICB9CgogIGZ1bmN0aW9uIGNhbGN1bGF0ZUN1cnZlKGEsIGIsIEgsIHQpewogICAgdmFyIEwsIGMsIHQyOwogICAgTCA9IGIgLSBhOwogICAgdDIgPSAoMiAvIEwpICogdCAtIDEgLSAoYSAqIDIgLyBMKTsKICAgIGMgPSB0MiAqIHQyICogSCAtIEggKyAxOwogICAgaWYgKG9wdHMuaW5pdGlhbEZvcmNlKSB7CiAgICAgIGMgPSAxIC0gYzsKICAgIH0KICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gYXQodCwgZHVyYXRpb24pIHsKICAgIHZhciBib3VuY2UsIGN1cnZlLCBncmF2aXR5LCBpLCB2OwogICAgYm91bmNlID0gb3B0cy5ib3VuY2UgLyAxMDA7CiAgICBncmF2aXR5ID0gb3B0cy5ncmF2aXR5OwogICAgaSA9IDA7CiAgICBjdXJ2ZSA9IGN1cnZlc1tpXTsKICAgIHdoaWxlICghKHQgPj0gY3VydmUuYSAmJiB0IDw9IGN1cnZlLmIpKSB7CiAgICAgIGkgKz0gMTsKICAgICAgY3VydmUgPSBjdXJ2ZXNbaV07CiAgICAgIGlmICghY3VydmUpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgaWYgKCFjdXJ2ZSkgewogICAgICB2ID0gb3B0cy5pbml0aWFsRm9yY2UgPyAwIDogMTsKICAgIH0gZWxzZSB7CiAgICAgIHYgPSBjYWxjdWxhdGVDdXJ2ZShjdXJ2ZS5hLCBjdXJ2ZS5iLCBjdXJ2ZS5ILCB0KTsKICAgIH0KICAgIC8vcmV0dXJuIFt0LCB2XTsKICAgIHJldHVybiB2OwogIH0KCn07Cgp9LHsiLi4vdXRpbC9leHRlbmQiOjEwfV0sNzpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7CnZhciBkeW5hbWljcyA9IF9kZXJlcV8oJy4vZHluYW1pY3MnKTsKdmFyIGJlemllciA9IF9kZXJlcV8oJy4vYmV6aWVyJyk7Cgptb2R1bGUuZXhwb3J0cyA9IHsKICAnbGluZWFyJzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odCwgZHVyYXRpb24pIHsKICAgICAgcmV0dXJuIGJlemllci5saW5lYXIodCwgZHVyYXRpb24pOwogICAgfTsKICB9LAogICdlYXNlJzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odCwgZHVyYXRpb24pIHsKICAgICAgcmV0dXJuIGJlemllci5lYXNlKHQsIGR1cmF0aW9uKTsKICAgIH07CiAgfSwKICAnZWFzZS1pbic6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHQsIGR1cmF0aW9uKSB7CiAgICAgIHJldHVybiBiZXppZXIuZWFzZUluKHQsIGR1cmF0aW9uKTsKICAgIH07CiAgfSwKICAnZWFzZS1vdXQnOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmdW5jdGlvbih0LCBkdXJhdGlvbikgewogICAgICByZXR1cm4gYmV6aWVyLmVhc2VPdXQodCwgZHVyYXRpb24pOwogICAgfTsKICB9LAogICdlYXNlLWluLW91dCc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHQsIGR1cmF0aW9uKSB7CiAgICAgIHJldHVybiBiZXppZXIuZWFzZUluT3V0KHQsIGR1cmF0aW9uKTsKICAgIH07CiAgfSwKICAnY3ViaWMtYmV6aWVyJzogZnVuY3Rpb24oeDEsIHkxLCB4MiwgeTIsIGR1cmF0aW9uKSB7CiAgICB2YXIgYnogPSBiZXppZXIuY3ViaWNCZXppZXIoeDEsIHkxLCB4MiwgeTIpOy8vLCB0LCBkdXJhdGlvbik7CiAgICByZXR1cm4gZnVuY3Rpb24odCwgZHVyYXRpb24pIHsKICAgICAgcmV0dXJuIGJ6KHQsIGR1cmF0aW9uKTsKICAgIH07CiAgfQp9OwoKfSx7Ii4vYmV6aWVyIjo1LCIuL2R5bmFtaWNzIjo2fV0sODpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7Cgp2YXIgcmFmID0gX2RlcmVxXygncmFmJyk7CnZhciB0aW1lID0gX2RlcmVxXygncGVyZm9ybWFuY2Utbm93Jyk7Cgp2YXIgc2VsZiA9IG1vZHVsZS5leHBvcnRzID0gewogIF9ydW5uaW5nOiB7fSwKCiAgYW5pbWF0aW9uU3RhcnRlZDogZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgIHNlbGYuX3J1bm5pbmdbaW5zdGFuY2UuXy5pZF0gPSBpbnN0YW5jZTsKCiAgICBpZiAoIXNlbGYuaXNUaWNraW5nKSB7CiAgICAgIHNlbGYudGljaygpOwogICAgfQogIH0sCgogIGFuaW1hdGlvblN0b3BwZWQ6IGZ1bmN0aW9uKGluc3RhbmNlKSB7CiAgICBkZWxldGUgc2VsZi5fcnVubmluZ1tpbnN0YW5jZS5fLmlkXTsKICAgIHNlbGYubWF5YmVTdG9wVGlja2luZygpOwogIH0sCgogIHRpY2s6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxhc3RGcmFtZSA9IHRpbWUoKTsKCiAgICBzZWxmLmlzVGlja2luZyA9IHRydWU7CiAgICBzZWxmLl9yYWZJZCA9IHJhZihzdGVwKTsKCiAgICBmdW5jdGlvbiBzdGVwKCkgewogICAgICBzZWxmLl9yYWZJZCA9IHJhZihzdGVwKTsKCiAgICAgIC8vIEdldCBjdXJyZW50IHRpbWUKICAgICAgdmFyIG5vdyA9IHRpbWUoKTsKICAgICAgdmFyIGRlbHRhVCA9IG5vdyAtIGxhc3RGcmFtZTsKCiAgICAgIGZvciAodmFyIGFuaW1hdGlvbklkIGluIHNlbGYuX3J1bm5pbmcpIHsKICAgICAgICBzZWxmLl9ydW5uaW5nW2FuaW1hdGlvbklkXS5fdGljayhkZWx0YVQpOwogICAgICB9CgogICAgICBsYXN0RnJhbWUgPSBub3c7CiAgICB9CiAgfSwKCiAgbWF5YmVTdG9wVGlja2luZzogZnVuY3Rpb24oKSB7CiAgICBpZiAoc2VsZi5pc1RpY2tpbmcgJiYgIU9iamVjdC5rZXlzKHNlbGYuX3J1bm5pbmcpLmxlbmd0aCkgewogICAgICByYWYuY2FuY2VsKHNlbGYuX3JhZklkKTsKICAgICAgc2VsZi5pc1RpY2tpbmcgPSBmYWxzZTsKICAgIH0KICB9LAoKfTsKCgp9LHsicGVyZm9ybWFuY2Utbm93IjoxLCJyYWYiOjJ9XSw5OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7CiAgYW5pbWF0b3I6IF9kZXJlcV8oJy4vYW5pbWF0b3InKQp9OwoKfSx7Ii4vYW5pbWF0b3IiOjR9XSwxMDpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7CgovKgogKiBUaGVyZSByZWFsbHkgaXMgbm8gdGlueSBtaW5pbWFsIGV4dGVuZCgpIG9uIG5wbSB0byBmaW5kLAogKiBzbyB3ZSBqdXN0IHVzZSBvdXIgb3duLgogKi8KCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gZXh0ZW5kKG9iaikgewogICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgIGZvcih2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgdmFyIHNvdXJjZSA9IGFyZ3NbaV07CiAgICAgaWYgKHNvdXJjZSkgewogICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgfQogICAgIH0KICAgfQogICByZXR1cm4gb2JqOwp9OwoKfSx7fV0sMTE6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewoKLy8gQWxsIHdlIHdhbnQgaXMgYW4gZXZlbnRFbWl0dGVyIHRoYXQgZG9lc24ndCB1c2UgI2NhbGwgb3IgI2FwcGx5LAovLyBieSBleHBlY3RpbmcgMC0xIGFyZ3VtZW50cy4gCi8vIFdlIGNvdWxkbid0IGZpbmQgdGhpcyBvbiBucG0sIHNvIHdlIG1ha2Ugb3VyIG93bi4KCm1vZHVsZS5leHBvcnRzID0gU2ltcGxlRXZlbnRFbWl0dGVyOwoKZnVuY3Rpb24gU2ltcGxlRXZlbnRFbWl0dGVyKCkgewp9CgpTaW1wbGVFdmVudEVtaXR0ZXIucHJvdG90eXBlID0gewogIGxpc3RlbmVyczogW10sCiAgb246IGZ1bmN0aW9uKGV2ZW50VHlwZSwgZm4pIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHJldHVybjsKICAgIHRoaXMubGlzdGVuZXJzW2V2ZW50VHlwZV0gfHwgKHRoaXMubGlzdGVuZXJzW2V2ZW50VHlwZV0gPSBbXSk7CiAgICB0aGlzLmxpc3RlbmVyc1tldmVudFR5cGVdLnB1c2goZm4pOwogIH0sCiAgb25jZTogZnVuY3Rpb24oZXZlbnRUeXBlLCBmbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgZnVuY3Rpb24gb25jZUZuKCkgewogICAgICBzZWxmLm9mZihldmVudFR5cGUsIGZuKTsKICAgICAgc2VsZi5vZmYoZXZlbnRUeXBlLCBvbmNlRm4pOwogICAgfQogICAgdGhpcy5vbihldmVudFR5cGUsIGZuKTsKICAgIHRoaXMub24oZXZlbnRUeXBlLCBvbmNlRm4pOwogIH0sCiAgLy8gQnVpbHQtaW4gbGltaXRhdGlvbjogd2Ugb25seSBleHBlY3QgMC0xIGFyZ3VtZW50cwogIC8vIFRoaXMgaXMgdG8gc2F2ZSBhcyBtdWNoIHBlcmYgYXMgcG9zc2libGUgd2hlbiBzZW5kaW5nCiAgLy8gZXZlbnRzIGV2ZXJ5IGZyYW1lLgogIGVtaXQ6IGZ1bmN0aW9uKGV2ZW50VHlwZSwgZXZlbnRBcmcpIHsKICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1tldmVudFR5cGVdIHx8IFtdOwogICAgdmFyIGkgPSAwOwogICAgdmFyIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICBmb3IgKGk7IGkgPCBsZW47IGkrKykgbGlzdGVuZXJzW2ldICYmIGxpc3RlbmVyc1tpXShldmVudEFyZyk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKGk7IGkgPCBsZW47IGkrKykgbGlzdGVuZXJzW2ldICYmIGxpc3RlbmVyc1tpXSgpOwogICAgfQogIH0sCiAgb2ZmOiBmdW5jdGlvbihldmVudFR5cGUsIGZuVG9SZW1vdmUpIHsKICAgIGlmICghZXZlbnRUeXBlKSB7CiAgICAgIC8vUmVtb3ZlIGFsbCBsaXN0ZW5lcnMKICAgICAgZm9yICh2YXIgdHlwZSBpbiB0aGlzLmxpc3RlbmVycykgewogICAgICAgIHRoaXMub2ZmKHR5cGUpOwogICAgICB9CiAgICB9IGVsc2UgIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMubGlzdGVuZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgICBpZiAoIWZuVG9SZW1vdmUpIHsKICAgICAgICAgIGxpc3RlbmVycy5sZW5ndGggPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBsaXN0ZW5lcnMuaW5kZXhPZihmblRvUmVtb3ZlKTsKICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0gCn07Cgp9LHt9XSwxMjpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7CgovKioKICogbmV4dFVpZCgpIGZyb20gYW5ndWxhci5qcwogKiBMaWNlbnNlIE1JVAogKiBodHRwOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMKICoKICogQSBjb25zaXN0ZW50IHdheSBvZiBjcmVhdGluZyB1bmlxdWUgSURzIGluIGFuZ3VsYXIuIFRoZSBJRCBpcyBhIHNlcXVlbmNlIG9mIGFscGhhIG51bWVyaWMKICogY2hhcmFjdGVycyBzdWNoIGFzICcwMTJBQkMnLiBUaGUgcmVhc29uIHdoeSB3ZSBhcmUgbm90IHVzaW5nIHNpbXBseSBhIG51bWJlciBjb3VudGVyIGlzIHRoYXQKICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICogd2lsbCBncm93IG11Y2ggc2xvd2VyLCBpdCBpcyBhIHN0cmluZywgYW5kIGl0IHdpbGwgbmV2ZXIgb3ZlcmZsb3cuCiAqCiAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogKi8KdmFyIHVpZCA9IFtdOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBuZXh0VWlkKCkgewogIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgdmFyIGRpZ2l0OwoKICB3aGlsZShpbmRleCkgewogICAgaW5kZXgtLTsKICAgIGRpZ2l0ID0gdWlkW2luZGV4XS5jaGFyQ29kZUF0KDApOwogICAgaWYgKGRpZ2l0ID09IDU3IC8qJzknKi8pIHsKICAgICAgdWlkW2luZGV4XSA9ICdBJzsKICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgIH0KICAgIGlmIChkaWdpdCA9PSA5MCAgLyonWicqLykgewogICAgICB1aWRbaW5kZXhdID0gJzAnOwogICAgfSBlbHNlIHsKICAgICAgdWlkW2luZGV4XSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZGlnaXQgKyAxKTsKICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgIH0KICB9CiAgdWlkLnVuc2hpZnQoJzAnKTsKICByZXR1cm4gdWlkLmpvaW4oJycpOwp9OwoKfSx7fV0sMTM6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpewovLyBzaGltIGZvciB1c2luZyBwcm9jZXNzIGluIGJyb3dzZXIKCnZhciBwcm9jZXNzID0gbW9kdWxlLmV4cG9ydHMgPSB7fTsKCnByb2Nlc3MubmV4dFRpY2sgPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIGNhblNldEltbWVkaWF0ZSA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnCiAgICAmJiB3aW5kb3cuc2V0SW1tZWRpYXRlOwogICAgdmFyIGNhblBvc3QgPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJwogICAgJiYgd2luZG93LnBvc3RNZXNzYWdlICYmIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyCiAgICA7CgogICAgaWYgKGNhblNldEltbWVkaWF0ZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZikgeyByZXR1cm4gd2luZG93LnNldEltbWVkaWF0ZShmKSB9OwogICAgfQoKICAgIGlmIChjYW5Qb3N0KSB7CiAgICAgICAgdmFyIHF1ZXVlID0gW107CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGV2LnNvdXJjZTsKICAgICAgICAgICAgaWYgKChzb3VyY2UgPT09IHdpbmRvdyB8fCBzb3VyY2UgPT09IG51bGwpICYmIGV2LmRhdGEgPT09ICdwcm9jZXNzLXRpY2snKSB7CiAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gcXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiBuZXh0VGljayhmbikgewogICAgICAgICAgICBxdWV1ZS5wdXNoKGZuKTsKICAgICAgICAgICAgd2luZG93LnBvc3RNZXNzYWdlKCdwcm9jZXNzLXRpY2snLCAnKicpOwogICAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uIG5leHRUaWNrKGZuKSB7CiAgICAgICAgc2V0VGltZW91dChmbiwgMCk7CiAgICB9Owp9KSgpOwoKcHJvY2Vzcy50aXRsZSA9ICdicm93c2VyJzsKcHJvY2Vzcy5icm93c2VyID0gdHJ1ZTsKcHJvY2Vzcy5lbnYgPSB7fTsKcHJvY2Vzcy5hcmd2ID0gW107CgpmdW5jdGlvbiBub29wKCkge30KCnByb2Nlc3Mub24gPSBub29wOwpwcm9jZXNzLmFkZExpc3RlbmVyID0gbm9vcDsKcHJvY2Vzcy5vbmNlID0gbm9vcDsKcHJvY2Vzcy5vZmYgPSBub29wOwpwcm9jZXNzLnJlbW92ZUxpc3RlbmVyID0gbm9vcDsKcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBub29wOwpwcm9jZXNzLmVtaXQgPSBub29wOwoKcHJvY2Vzcy5iaW5kaW5nID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5iaW5kaW5nIGlzIG5vdCBzdXBwb3J0ZWQnKTsKfQoKLy8gVE9ETyhzaHR5bG1hbikKcHJvY2Vzcy5jd2QgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAnLycgfTsKcHJvY2Vzcy5jaGRpciA9IGZ1bmN0aW9uIChkaXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7Cn07Cgp9LHt9XX0se30sWzldKQooOSkKfSk7Cn0pKCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 05:07:58 GMT",
                    "Content-Length": "1530087",
                    "Date": "Fri, 07 Nov 2014 05:08:00 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}