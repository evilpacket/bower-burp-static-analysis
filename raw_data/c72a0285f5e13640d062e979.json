{
    "url": "http://localhost:9999/dperini/nwmatcher/test/jquery/qunit/testrunner.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.match(/^(.+?)(\\?.*)?$/)[1] + \"?\" + encodeURIComponent(target[0].innerText);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/dperini/nwmatcher/test/jquery/qunit/testrunner.js",
                "path": "/dperini/nwmatcher/test/jquery/qunit/testrunner.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kcGVyaW5pL253bWF0Y2hlci90ZXN0L2pxdWVyeS9xdW5pdC90ZXN0cnVubmVyLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTEwNjYNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMTk6NTQ6NDcgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDE5OjU0OjQ1IEdNVA0KDQovKgogKiBRVW5pdCAtIGpRdWVyeSB1bml0IHRlc3RydW5uZXIKICogCiAqIGh0dHA6Ly9kb2NzLmpxdWVyeS5jb20vUVVuaXQKICoKICogQ29weXJpZ2h0IChjKSAyMDA4IEpvaG4gUmVzaWcsIErDtnJuIFphZWZmZXJlcgogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgKE1JVC1MSUNFTlNFLnR4dCkKICogYW5kIEdQTCAoR1BMLUxJQ0VOU0UudHh0KSBsaWNlbnNlcy4KICoKICogJElkOiB0ZXN0cnVubmVyLmpzIDU4MjcgMjAwOC0wOC0xMyAxNzoxNDo0OFogam9lcm4uemFlZmZlcmVyICQKICoKICogTW9kaWZpZWQgdG8gcnVuIHNlbGVjdG9yIHRlc3Qgc3RhbmRhbG9uZSAoZGllZ28ucGVyaW5pQGdtYWlsLmNvbSkKICoKICovCgp2YXIgX2NvbmZpZyA9IHsKCWZpeHR1cmU6IG51bGwsCglUZXN0OiBbXSwKCXN0YXRzOiB7CgkJYWxsOiAwLAoJCWJhZDogMAoJfSwKCXF1ZXVlOiBbXSwKCWJsb2NraW5nOiB0cnVlLAoJdGltZW91dDogbnVsbCwKCWV4cGVjdGVkOiBudWxsLAoJY3VycmVudE1vZHVsZTogbnVsbCwKCWFzeW5jVGltZW91dDogMiAvLyBzZWNvbmRzIGZvciBhc3luYyB0aW1lb3V0Cn07CgppZiAobG9jYXRpb24uc2VhcmNoLmxlbmd0aCA+IDEpIHsKCS8vcmVzdHJpY3QgbW9kdWxlcy90ZXN0cyBieSBnZXQgcGFyYW1ldGVycwoJdmFyIHBhcm1zID0gbG9jYXRpb24uc2VhcmNoLnNsaWNlKDEpLnNwbGl0KCcmJyk7Cglmb3IgKHZhciBpID0gMDsgcGFybXMubGVuZ3RoID4gaTsgaSsrKSB7CgkJcGFybXNbaV0gPSBkZWNvZGVVUklDb21wb25lbnQocGFybXNbaV0pOwoJfQoJX2NvbmZpZy5maWx0ZXJzID0gcGFybXM7Cn0gZWxzZSB7CglfY29uZmlnLmZpbHRlcnMgPSBmYWxzZTsKfQoKdmFyIGlzTG9jYWwgPSAhISh3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wgPT0gJ2ZpbGU6Jyk7Cgp3aW5kb3cub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzZXJBZ2VudCcpLmlubmVySFRNTCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgcnVuVGVzdCgpOwp9CgpmdW5jdGlvbiBzeW5jaHJvbml6ZShjYWxsYmFjaykgewoJX2NvbmZpZy5xdWV1ZVtfY29uZmlnLnF1ZXVlLmxlbmd0aF0gPSBjYWxsYmFjazsKCWlmKCFfY29uZmlnLmJsb2NraW5nKSB7CgkJcHJvY2VzcygpOwoJfQp9CgpmdW5jdGlvbiBwcm9jZXNzKCkgewoJd2hpbGUoX2NvbmZpZy5xdWV1ZS5sZW5ndGggJiYgIV9jb25maWcuYmxvY2tpbmcpIHsKCQl2YXIgY2FsbCA9IF9jb25maWcucXVldWVbMF07CgkJX2NvbmZpZy5xdWV1ZSA9IF9jb25maWcucXVldWUuc2xpY2UoMSk7CgkJY2FsbCgpOwoJfQp9CgpmdW5jdGlvbiBzdG9wKGFsbG93RmFpbHVyZSkgewoJX2NvbmZpZy5ibG9ja2luZyA9IHRydWU7Cgl2YXIgaGFuZGxlciA9IGFsbG93RmFpbHVyZSA/IHN0YXJ0IDogZnVuY3Rpb24oKSB7CgkJb2soIGZhbHNlLCAiVGVzdCB0aW1lZCBvdXQiICk7CgkJc3RhcnQoKTsKCX07CgkvLyBEaXNhYmxlZCwgY2F1c2VkIHRvbyBtYW55IHJhbmRvbSBlcnJvcnMKCS8vX2NvbmZpZy50aW1lb3V0ID0gc2V0VGltZW91dChoYW5kbGVyLCBfY29uZmlnLmFzeW5jVGltZW91dCAqIDEwMDApOwp9CmZ1bmN0aW9uIHN0YXJ0KCkgewoJLy8gQSBzbGlnaHQgZGVsYXksIHRvIGF2b2lkIGFueSBjdXJyZW50IGNhbGxiYWNrcwoJc2V0VGltZW91dChmdW5jdGlvbigpewoJCWlmKF9jb25maWcudGltZW91dCkKCQkJY2xlYXJUaW1lb3V0KF9jb25maWcudGltZW91dCk7CgkJX2NvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoJCXByb2Nlc3MoKTsKCX0sIDEzKTsKfQoKZnVuY3Rpb24gdmFsaWRUZXN0KCBuYW1lICkgewoJdmFyIGZpbHRlcnMgPSBfY29uZmlnLmZpbHRlcnM7CglpZiggIWZpbHRlcnMgKQoJCXJldHVybiB0cnVlOwoKCXZhciBpID0gZmlsdGVycy5sZW5ndGgsCgkJcnVuID0gZmFsc2U7Cgl3aGlsZSggaS0tICl7CgkJdmFyIGZpbHRlciA9IGZpbHRlcnNbaV0sCgkJCW5vdCA9IGZpbHRlci5jaGFyQXQoMCkgPT0gJyEnOwoJCWlmKCBub3QgKSAKCQkJZmlsdGVyID0gZmlsdGVyLnNsaWNlKDEpOwoJCWlmKCBuYW1lLmluZGV4T2YoZmlsdGVyKSAhPSAtMSApCgkJCXJldHVybiAhbm90OwoJCWlmKCBub3QgKQoJCQlydW4gPSB0cnVlOwoJfQoJcmV0dXJuIHJ1bjsKfQoKZnVuY3Rpb24gcnVuVGVzdCgpIHsKCV9jb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCXZhciBzdGFydGVkID0gK25ldyBEYXRlOwoJX2NvbmZpZy5maXh0dXJlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4nKS5pbm5lckhUTUw7Ci8vCV9jb25maWcuYWpheFNldHRpbmdzID0galF1ZXJ5LmFqYXhTZXR0aW5nczsKCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCXZhciBvdXRwdXQgPQoJCQknPHAgaWQ9InRlc3RyZXN1bHQiIGNsYXNzPSJyZXN1bHQiPicgKwoJCQlbJ1Rlc3RzIGNvbXBsZXRlZCBpbiAnLCArbmV3IERhdGUgLSBzdGFydGVkLCAnIG1pbGxpc2Vjb25kcy48YnIvPicsCgkJCSc8c3BhbiBjbGFzcz0iYmFkIj4nLCBfY29uZmlnLnN0YXRzLmJhZCwgJzwvc3Bhbj4gdGVzdHMgb2YgPHNwYW4gY2xhc3M9ImFsbCI+JywKCQkJX2NvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IGZhaWxlZC48L3A+J10uam9pbignJyk7CgkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0b0RPTUZyYWdtZW50KG91dHB1dCkpOwoJCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdiYW5uZXInKS5jbGFzc05hbWUgPSBfY29uZmlnLnN0YXRzLmJhZCA/ICJmYWlsIiA6ICJwYXNzIjsKCX0pOwp9CgpmdW5jdGlvbiB0ZXN0KG5hbWUsIGNhbGxiYWNrLCBub3dhaXQpIHsKCWlmKF9jb25maWcuY3VycmVudE1vZHVsZSkKCQluYW1lID0gX2NvbmZpZy5jdXJyZW50TW9kdWxlICsgIiBtb2R1bGU6ICIgKyBuYW1lOwoJCQoJaWYgKCAhdmFsaWRUZXN0KG5hbWUpICkKCQlyZXR1cm47CgkJCglzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQlfY29uZmlnLlRlc3QgPSBbXTsKCQl0cnkgewoJCQljYWxsYmFjaygpOwoJCX0gY2F0Y2goZSkgewoJCQlpZiggdHlwZW9mIGNvbnNvbGUgIT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS5lcnJvciAmJiBjb25zb2xlLndhcm4gKSB7CgkJCQljb25zb2xlLmVycm9yKCJUZXN0ICIgKyBuYW1lICsgIiBkaWVkLCBleGNlcHRpb24gYW5kIHRlc3QgZm9sbG93cyIpOwoJCQkJY29uc29sZS5lcnJvcihlKTsKCQkJCWNvbnNvbGUud2FybihjYWxsYmFjay50b1N0cmluZygpKTsKCQkJfQoJCQlfY29uZmlnLlRlc3QucHVzaCggWyBmYWxzZSwgIkRpZWQgb24gdGVzdCAjIiArIChfY29uZmlnLlRlc3QubGVuZ3RoKzEpICsgIjogIiArIGUubWVzc2FnZSBdICk7CgkJfQoJfSk7CgoJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJdHJ5IHsKCQkJcmVzZXQoKTsKCQl9IGNhdGNoKGUpIHsKCQkJaWYoIHR5cGVvZiBjb25zb2xlICE9ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgewoJCQkJY29uc29sZS5lcnJvcigicmVzZXQoKSBmYWlsZWQsIGZvbGxvd2luZyBUZXN0ICIgKyBuYW1lICsgIiwgZXhjZXB0aW9uIGFuZCByZXNldCBmbiBmb2xsb3dzIik7CgkJCQljb25zb2xlLmVycm9yKGUpOwoJCQkJY29uc29sZS53YXJuKHJlc2V0LnRvU3RyaW5nKCkpOwoJCQl9CgkJfQoJCQoJCS8vIGRvbid0IG91dHB1dCBwYXVzZSB0ZXN0cwoJCWlmKG5vd2FpdCkgcmV0dXJuOwoJCQoJCWlmKF9jb25maWcuZXhwZWN0ZWQgJiYgX2NvbmZpZy5leHBlY3RlZCAhPSBfY29uZmlnLlRlc3QubGVuZ3RoKSB7CgkJCV9jb25maWcuVGVzdC5wdXNoKCBbIGZhbHNlLCAiRXhwZWN0ZWQgIiArIF9jb25maWcuZXhwZWN0ZWQgKyAiIGFzc2VydGlvbnMsIGJ1dCAiICsgX2NvbmZpZy5UZXN0Lmxlbmd0aCArICIgd2VyZSBydW4iIF0gKTsKCQl9CgkJX2NvbmZpZy5leHBlY3RlZCA9IG51bGw7CgkJCgkJdmFyIGdvb2QgPSAwLCBiYWQgPSAwOwoJCXZhciBvbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9sIik7CgkJb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCQl2YXIgbGkgPSAiIiwgc3RhdGUgPSAicGFzcyI7CgkJZm9yICggdmFyIGkgPSAwOyBpIDwgX2NvbmZpZy5UZXN0Lmxlbmd0aDsgaSsrICkgewoJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwoJCQlsaS5jbGFzc05hbWUgPSBfY29uZmlnLlRlc3RbaV1bMF0gPyAicGFzcyIgOiAiZmFpbCI7CgkJCWxpLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShfY29uZmlnLlRlc3RbaV1bMV0pICk7CgkJCW9sLmFwcGVuZENoaWxkKCBsaSApOwoJCQkKCQkJX2NvbmZpZy5zdGF0cy5hbGwrKzsKCQkJaWYgKCAhX2NvbmZpZy5UZXN0W2ldWzBdICkgewoJCQkJc3RhdGUgPSAiZmFpbCI7CgkJCQliYWQrKzsKCQkJCV9jb25maWcuc3RhdHMuYmFkKys7CgkJCX0gZWxzZSBnb29kKys7CgkJfQoJCgkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKCQlsaS5jbGFzc05hbWUgPSBzdGF0ZTsKCQoJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7CgkJYi5pbm5lckhUTUwgPSBuYW1lICsgIiA8YiBzdHlsZT0nY29sb3I6YmxhY2s7Jz4oPGIgY2xhc3M9J2ZhaWwnPiIgKyBiYWQgKyAiPC9iPiwgPGIgY2xhc3M9J3Bhc3MnPiIgKyBnb29kICsgIjwvYj4sICIgKyBfY29uZmlnLlRlc3QubGVuZ3RoICsgIik8L2I+IjsKCQliLm9uY2xpY2sgPSBmdW5jdGlvbigpewoJCQl2YXIgbiA9IHRoaXMubmV4dFNpYmxpbmc7CgkJCWlmICggbi5zdHlsZS5kaXNwbGF5ID09ICJub25lIiApCgkJCQluLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwoJCQllbHNlCgkJCQluLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkJfTsKICAgICAgICBpZiAoYi5hZGRFdmVudExpc3RlbmVyKQoJCQliLmFkZEV2ZW50TGlzdGVuZXIoJ2RibGNsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKCQkJCXZhciB0YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgic3Ryb25nIik7CgkJCQlpZiAoIHRhcmdldC5sZW5ndGggKSB7CgkJCQkJbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYubWF0Y2goL14oLis/KShcPy4qKT8kLylbMV0gKyAiPyIgKyBlbmNvZGVVUklDb21wb25lbnQodGFyZ2V0WzBdLnRleHRDb250ZW50KTsKCQkJCX0KCQkJfSwgZmFsc2UpOwoJCWVsc2UKCQkJYi5hdHRhY2hFdmVudCgnb25kYmxjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7CgkJCQl2YXIgdGFyZ2V0ID0gZXZlbnQuc3JjRWxlbWVudC5wYXJlbnROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzdHJvbmciKTsKCQkJCWlmICggdGFyZ2V0Lmxlbmd0aCApIHsKCQkJCQlsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5tYXRjaCgvXiguKz8pKFw/LiopPyQvKVsxXSArICI/IiArIGVuY29kZVVSSUNvbXBvbmVudCh0YXJnZXRbMF0uaW5uZXJUZXh0KTsKCQkJCX0KCQkJfSwgZmFsc2UpOwoKCQlsaS5hcHBlbmRDaGlsZCggYiApOwoJCWxpLmFwcGVuZENoaWxkKCBvbCApOwoJCgkJZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInRlc3RzIikuYXBwZW5kQ2hpbGQoIGxpICk7CQkKCX0pOwp9CgovLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMKZnVuY3Rpb24gbW9kdWxlKG1vZHVsZU5hbWUpIHsKCV9jb25maWcuY3VycmVudE1vZHVsZSA9IG1vZHVsZU5hbWU7Cn0KCi8qKgogKiBTcGVjaWZ5IHRoZSBudW1iZXIgb2YgZXhwZWN0ZWQgYXNzZXJ0aW9ucyB0byBndXJhbnRlZSB0aGF0IGZhaWxlZCB0ZXN0IChubyBhc3NlcnRpb25zIGFyZSBydW4gYXQgYWxsKSBkb24ndCBzbGlwIHRocm91Z2guCiAqLwpmdW5jdGlvbiBleHBlY3QoYXNzZXJ0cykgewoJX2NvbmZpZy5leHBlY3RlZCA9IGFzc2VydHM7Cn0KCi8qKgogKiBSZXNldHMgdGhlIHRlc3Qgc2V0dXAuIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBtb2RpZnkgdGhlIERPTS4KICovCmZ1bmN0aW9uIHJlc2V0KCkgewoJZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4nKS5pbm5lckhUTUwgPSBfY29uZmlnLmZpeHR1cmU7Ci8vCWpRdWVyeS5hamF4U2V0dGluZ3MgPSBqUXVlcnkuZXh0ZW5kKHt9LCBfY29uZmlnLmFqYXhTZXR0aW5ncyk7Cn0KCi8qKgogKiBBc3NlcnRzIHRydWUuCiAqIEBleGFtcGxlIG9rKCAkKCJhIikubGVuZ3RoID4gNSwgIlRoZXJlIG11c3QgYmUgYXQgbGVhc3QgNSBhbmNob3JzIiApOwogKi8KZnVuY3Rpb24gb2soYSwgbXNnKSB7CglfY29uZmlnLlRlc3QucHVzaCggWyAhIWEsIG1zZyBdICk7Cn0KCi8qKgogKiBBc3NlcnRzIHRoYXQgdHdvIGFycmF5cyBhcmUgdGhlIHNhbWUKICovCmZ1bmN0aW9uIGlzU2V0KGEsIGIsIG1zZykgewoJdmFyIHJldCA9IHRydWU7CglpZiAoIGEgJiYgYiAmJiBhLmxlbmd0aCAhPSB1bmRlZmluZWQgJiYgYS5sZW5ndGggPT0gYi5sZW5ndGggKSB7CgkJZm9yICggdmFyIGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKyApCgkJCWlmICggYVtpXSAhPSBiW2ldICkKCQkJCXJldCA9IGZhbHNlOwoJfSBlbHNlCgkJcmV0ID0gZmFsc2U7CglpZiAoICFyZXQgKQoJCV9jb25maWcuVGVzdC5wdXNoKCBbIHJldCwgbXNnICsgIiBleHBlY3RlZDogIiArIHNlcmlhbEFycmF5KGIpICsgIiByZXN1bHQ6ICIgKyBzZXJpYWxBcnJheShhKSBdICk7CgllbHNlIAoJCV9jb25maWcuVGVzdC5wdXNoKCBbIHJldCwgbXNnIF0gKTsKfQoKLyoqCiAqIEFzc2VydHMgdGhhdCB0d28gb2JqZWN0cyBhcmUgZXF1aXZhbGVudAogKi8KZnVuY3Rpb24gaXNPYmooYSwgYiwgbXNnKSB7Cgl2YXIgcmV0ID0gdHJ1ZTsKCQoJaWYgKCBhICYmIGIgKSB7CgkJZm9yICggdmFyIGkgaW4gYSApCgkJCWlmICggYVtpXSAhPSBiW2ldICkKCQkJCXJldCA9IGZhbHNlOwoKCQlmb3IgKCBpIGluIGIgKQoJCQlpZiAoIGFbaV0gIT0gYltpXSApCgkJCQlyZXQgPSBmYWxzZTsKCX0gZWxzZQoJCXJldCA9IGZhbHNlOwoKICAgIF9jb25maWcuVGVzdC5wdXNoKCBbIHJldCwgbXNnIF0gKTsKfQoKZnVuY3Rpb24gc2VyaWFsQXJyYXkoIGEgKSB7Cgl2YXIgciA9IFtdOwoJCglpZiAoIGEgJiYgYS5sZW5ndGggKQogICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgIHZhciBzdHIgPSBhW2ldLm5vZGVOYW1lOwogICAgICAgICAgICBpZiAoIHN0ciApIHsKICAgICAgICAgICAgICAgIHN0ciA9IHN0ci50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgaWYgKCBhW2ldLmlkICkKICAgICAgICAgICAgICAgICAgICBzdHIgKz0gIiMiICsgYVtpXS5pZDsKICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICBzdHIgPSBhW2ldOwogICAgICAgICAgICByLnB1c2goIHN0ciApOwogICAgICAgIH0KCglyZXR1cm4gIlsgIiArIHIuam9pbigiLCAiKSArICIgXSI7Cn0KCmZ1bmN0aW9uIGZsYXRNYXAoYSwgYmxvY2spIHsKCXZhciByZXN1bHQgPSBbXTsKCSQuZWFjaChhLCBmdW5jdGlvbigpIHsKCQl2YXIgeCA9IGJsb2NrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJaWYgKHggIT09IGZhbHNlKQoJCQlyZXN1bHQucHVzaCh4KTsKCX0pCglyZXR1cm4gcmVzdWx0Owp9CgpmdW5jdGlvbiBzZXJpYWxPYmplY3QoIGEgKSB7CglyZXR1cm4gInsgIiArIGZsYXRNYXAoYSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewoJCXJldHVybiBrZXkgKyAiOiAiICsgdmFsdWU7Cgl9KS5qb2luKCIsICIpICsgIiB9IjsKfQoKZnVuY3Rpb24gY29tcGFyZShhLCBiLCBtc2cpIHsKCXZhciByZXQgPSB0cnVlOwoJaWYgKCBhICYmIGIgJiYgYS5sZW5ndGggIT0gdW5kZWZpbmVkICYmIGEubGVuZ3RoID09IGIubGVuZ3RoICkgewoJCWZvciAoIHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKysgKQoJCQlmb3IodmFyIGtleSBpbiBhW2ldKSB7CgkJCQlpZiAoYVtpXVtrZXldLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CgkJCQkJZm9yICh2YXIgYXJyYXlLZXkgaW4gYVtpXVtrZXldKSB7CgkJCQkJCWlmIChhW2ldW2tleV1bYXJyYXlLZXldICE9IGJbaV1ba2V5XVthcnJheUtleV0pIHsKCQkJCQkJCXJldCA9IGZhbHNlOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIGlmIChhW2ldW2tleV0gIT0gYltpXVtrZXldKSB7CgkJCQkJcmV0ID0gZmFsc2UKCQkJCX0KCQkJfQoJfSBlbHNlCgkJcmV0ID0gZmFsc2U7CglvayggcmV0LCBtc2cgKyAiIGV4cGVjdGVkOiAiICsgc2VyaWFsQXJyYXkoYikgKyAiIHJlc3VsdDogIiArIHNlcmlhbEFycmF5KGEpICk7Cn0KCmZ1bmN0aW9uIGNvbXBhcmUyKGEsIGIsIG1zZykgewoJdmFyIHJldCA9IHRydWU7CglpZiAoIGEgJiYgYiApIHsKCQlmb3IodmFyIGtleSBpbiBhKSB7CgkJCWlmIChhW2tleV0uY29uc3RydWN0b3IgPT0gQXJyYXkpIHsKCQkJCWZvciAodmFyIGFycmF5S2V5IGluIGFba2V5XSkgewoJCQkJCWlmIChhW2tleV1bYXJyYXlLZXldICE9IGJba2V5XVthcnJheUtleV0pIHsKCQkJCQkJcmV0ID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgaWYgKGFba2V5XSAhPSBiW2tleV0pIHsKCQkJCXJldCA9IGZhbHNlCgkJCX0KCQl9CgkJZm9yKGtleSBpbiBiKSB7CgkJCWlmIChiW2tleV0uY29uc3RydWN0b3IgPT0gQXJyYXkpIHsKCQkJCWZvciAodmFyIGFycmF5S2V5IGluIGJba2V5XSkgewoJCQkJCWlmIChhW2tleV1bYXJyYXlLZXldICE9IGJba2V5XVthcnJheUtleV0pIHsKCQkJCQkJcmV0ID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgaWYgKGFba2V5XSAhPSBiW2tleV0pIHsKCQkJCXJldCA9IGZhbHNlCgkJCX0KCQl9Cgl9IGVsc2UKCQlyZXQgPSBmYWxzZTsKCW9rKCByZXQsIG1zZyArICIgZXhwZWN0ZWQ6ICIgKyBzZXJpYWxPYmplY3QoYikgKyAiIHJlc3VsdDogIiArIHNlcmlhbE9iamVjdChhKSApOwp9CgovKioKICogUmV0dXJucyBhbiBhcnJheSBvZiBlbGVtZW50cyB3aXRoIHRoZSBnaXZlbiBJRHMsIGVnLgogKiBAZXhhbXBsZSBxKCJtYWluIiwgImZvbyIsICJiYXIiKQogKiBAcmVzdWx0IFs8ZGl2IGlkPSJtYWluIj4sIDxzcGFuIGlkPSJmb28iPiwgPGlucHV0IGlkPSJiYXIiPl0KICovCmZ1bmN0aW9uIHEoKSB7Cgl2YXIgciA9IFtdOwoJZm9yICggdmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrICkKCQlyLnB1c2goIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBhcmd1bWVudHNbaV0gKSApOwoJcmV0dXJuIHI7Cn0KCi8qKgogKiBBc3NlcnRzIHRoYXQgYSBzZWxlY3QgbWF0Y2hlcyB0aGUgZ2l2ZW4gSURzCiAqIEBleGFtcGxlIHQoIkNoZWNrIGZvciBzb21ldGhpbmciLCAiLy9bYV0iLCBbImZvbyIsICJiYWFyIl0pOwogKiBAcmVzdWx0IHJldHVybnMgdHJ1ZSBpZiAiLy9bYV0iIHJldHVybiB0d28gZWxlbWVudHMgd2l0aCB0aGUgSURzICdmb28nIGFuZCAnYmFhcicKICovCmZ1bmN0aW9uIHQoYSxiLGMpIHsKCXZhciBmID0gTlcuRG9tLnNlbGVjdChiKTsKCXZhciBzID0gIiI7Cglmb3IgKCB2YXIgaSA9IDA7IGkgPCBmLmxlbmd0aDsgaSsrICkKCQlzICs9IChzICYmICIsIikgKyAnIicgKyBmW2ldLmlkICsgJyInOwoJaXNTZXQoZiwgcS5hcHBseShxLGMpLCBhICsgIiAoIiArIGIgKyAiKSIpOwp9CgovKioKICogQWRkIHJhbmRvbSBudW1iZXIgdG8gdXJsIHRvIHN0b3AgSUUgZnJvbSBjYWNoaW5nCiAqCiAqIEBleGFtcGxlIHVybCgiZGF0YS90ZXN0Lmh0bWwiKQogKiBAcmVzdWx0ICJkYXRhL3Rlc3QuaHRtbD8xMDUzODM1ODQyODk0MyIKICoKICogQGV4YW1wbGUgdXJsKCJkYXRhL3Rlc3QucGhwP2Zvbz1iYXIiKQogKiBAcmVzdWx0ICJkYXRhL3Rlc3QucGhwP2Zvbz1iYXImMTA1MzgzNTgzNDU1NTQiCiAqLwpmdW5jdGlvbiB1cmwodmFsdWUpIHsKCXJldHVybiB2YWx1ZSArICgvXD8vLnRlc3QodmFsdWUpID8gIiYiIDogIj8iKSArIG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgIiIgKyBwYXJzZUludChNYXRoLnJhbmRvbSgpKjEwMDAwMCk7Cn0KCi8qKgogKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4KICogUHJpbnRzIG91dCBib3RoIGFjdHVhbCBhbmQgZXhwZWN0ZWQgdmFsdWVzLgogKgogKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkKICoKICogQGV4YW1wbGUgZXF1YWxzKCAkLmZvcm1hdCgiUmVjZWl2ZWQgezB9IGJ5dGVzLiIsIDIpLCAiUmVjZWl2ZWQgMiBieXRlcy4iICk7CiAqCiAqIEBwYXJhbSBPYmplY3QgYWN0dWFsCiAqIEBwYXJhbSBPYmplY3QgZXhwZWN0ZWQKICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkKICovCmZ1bmN0aW9uIGVxdWFscyhhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7Cgl2YXIgcmVzdWx0ID0gZXhwZWN0ZWQgPT0gYWN0dWFsOwoJbWVzc2FnZSA9IG1lc3NhZ2UgfHwgKHJlc3VsdCA/ICJva2F5IiA6ICJmYWlsZWQiKTsKCV9jb25maWcuVGVzdC5wdXNoKCBbIHJlc3VsdCwgcmVzdWx0ID8gbWVzc2FnZSArICI6ICIgKyBleHBlY3RlZCA6IG1lc3NhZ2UgKyAiIGV4cGVjdGVkOiAiICsgZXhwZWN0ZWQgKyAiIGFjdHVhbDogIiArIGFjdHVhbCBdICk7Cn0KCi8qKgogKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuCiAqCiAqIEBleGFtcGxlIHRyaWdnZXJFdmVudCggZG9jdW1lbnQuYm9keSwgImNsaWNrIiApOwogKgogKiBAcGFyYW0gRE9NRWxlbWVudCBlbGVtCiAqIEBwYXJhbSBTdHJpbmcgdHlwZQogKi8KZnVuY3Rpb24gdHJpZ2dlckV2ZW50KCBlbGVtLCB0eXBlLCBldmVudCApIHsKCWlmICggZG9jdW1lbnQuY3JlYXRlRXZlbnQgKSB7CgkJZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKCQlldmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcsCgkJCTAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKCQllbGVtLmRpc3BhdGNoRXZlbnQoIGV2ZW50ICk7Cgl9IGVsc2UgaWYgKCBkb2N1bWVudC5jcmVhdGVFdmVudE9iamVjdCApIHsKCQllbGVtLmZpcmVFdmVudCgib24iK3R5cGUpOwoJfQp9Cg==",
                "body": "LyoKICogUVVuaXQgLSBqUXVlcnkgdW5pdCB0ZXN0cnVubmVyCiAqIAogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwOCBKb2huIFJlc2lnLCBKw7ZybiBaYWVmZmVyZXIKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpCiAqIGFuZCBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuCiAqCiAqICRJZDogdGVzdHJ1bm5lci5qcyA1ODI3IDIwMDgtMDgtMTMgMTc6MTQ6NDhaIGpvZXJuLnphZWZmZXJlciAkCiAqCiAqIE1vZGlmaWVkIHRvIHJ1biBzZWxlY3RvciB0ZXN0IHN0YW5kYWxvbmUgKGRpZWdvLnBlcmluaUBnbWFpbC5jb20pCiAqCiAqLwoKdmFyIF9jb25maWcgPSB7CglmaXh0dXJlOiBudWxsLAoJVGVzdDogW10sCglzdGF0czogewoJCWFsbDogMCwKCQliYWQ6IDAKCX0sCglxdWV1ZTogW10sCglibG9ja2luZzogdHJ1ZSwKCXRpbWVvdXQ6IG51bGwsCglleHBlY3RlZDogbnVsbCwKCWN1cnJlbnRNb2R1bGU6IG51bGwsCglhc3luY1RpbWVvdXQ6IDIgLy8gc2Vjb25kcyBmb3IgYXN5bmMgdGltZW91dAp9OwoKaWYgKGxvY2F0aW9uLnNlYXJjaC5sZW5ndGggPiAxKSB7CgkvL3Jlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMKCXZhciBwYXJtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpOwoJZm9yICh2YXIgaSA9IDA7IHBhcm1zLmxlbmd0aCA+IGk7IGkrKykgewoJCXBhcm1zW2ldID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhcm1zW2ldKTsKCX0KCV9jb25maWcuZmlsdGVycyA9IHBhcm1zOwp9IGVsc2UgewoJX2NvbmZpZy5maWx0ZXJzID0gZmFsc2U7Cn0KCnZhciBpc0xvY2FsID0gISEod2luZG93LmxvY2F0aW9uLnByb3RvY29sID09ICdmaWxlOicpOwoKd2luZG93Lm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyQWdlbnQnKS5pbm5lckhUTUwgPSBuYXZpZ2F0b3IudXNlckFnZW50OwogIHJ1blRlc3QoKTsKfQoKZnVuY3Rpb24gc3luY2hyb25pemUoY2FsbGJhY2spIHsKCV9jb25maWcucXVldWVbX2NvbmZpZy5xdWV1ZS5sZW5ndGhdID0gY2FsbGJhY2s7CglpZighX2NvbmZpZy5ibG9ja2luZykgewoJCXByb2Nlc3MoKTsKCX0KfQoKZnVuY3Rpb24gcHJvY2VzcygpIHsKCXdoaWxlKF9jb25maWcucXVldWUubGVuZ3RoICYmICFfY29uZmlnLmJsb2NraW5nKSB7CgkJdmFyIGNhbGwgPSBfY29uZmlnLnF1ZXVlWzBdOwoJCV9jb25maWcucXVldWUgPSBfY29uZmlnLnF1ZXVlLnNsaWNlKDEpOwoJCWNhbGwoKTsKCX0KfQoKZnVuY3Rpb24gc3RvcChhbGxvd0ZhaWx1cmUpIHsKCV9jb25maWcuYmxvY2tpbmcgPSB0cnVlOwoJdmFyIGhhbmRsZXIgPSBhbGxvd0ZhaWx1cmUgPyBzdGFydCA6IGZ1bmN0aW9uKCkgewoJCW9rKCBmYWxzZSwgIlRlc3QgdGltZWQgb3V0IiApOwoJCXN0YXJ0KCk7Cgl9OwoJLy8gRGlzYWJsZWQsIGNhdXNlZCB0b28gbWFueSByYW5kb20gZXJyb3JzCgkvL19jb25maWcudGltZW91dCA9IHNldFRpbWVvdXQoaGFuZGxlciwgX2NvbmZpZy5hc3luY1RpbWVvdXQgKiAxMDAwKTsKfQpmdW5jdGlvbiBzdGFydCgpIHsKCS8vIEEgc2xpZ2h0IGRlbGF5LCB0byBhdm9pZCBhbnkgY3VycmVudCBjYWxsYmFja3MKCXNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQlpZihfY29uZmlnLnRpbWVvdXQpCgkJCWNsZWFyVGltZW91dChfY29uZmlnLnRpbWVvdXQpOwoJCV9jb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCQlwcm9jZXNzKCk7Cgl9LCAxMyk7Cn0KCmZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsKCXZhciBmaWx0ZXJzID0gX2NvbmZpZy5maWx0ZXJzOwoJaWYoICFmaWx0ZXJzICkKCQlyZXR1cm4gdHJ1ZTsKCgl2YXIgaSA9IGZpbHRlcnMubGVuZ3RoLAoJCXJ1biA9IGZhbHNlOwoJd2hpbGUoIGktLSApewoJCXZhciBmaWx0ZXIgPSBmaWx0ZXJzW2ldLAoJCQlub3QgPSBmaWx0ZXIuY2hhckF0KDApID09ICchJzsKCQlpZiggbm90ICkgCgkJCWZpbHRlciA9IGZpbHRlci5zbGljZSgxKTsKCQlpZiggbmFtZS5pbmRleE9mKGZpbHRlcikgIT0gLTEgKQoJCQlyZXR1cm4gIW5vdDsKCQlpZiggbm90ICkKCQkJcnVuID0gdHJ1ZTsKCX0KCXJldHVybiBydW47Cn0KCmZ1bmN0aW9uIHJ1blRlc3QoKSB7CglfY29uZmlnLmJsb2NraW5nID0gZmFsc2U7Cgl2YXIgc3RhcnRlZCA9ICtuZXcgRGF0ZTsKCV9jb25maWcuZml4dHVyZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluJykuaW5uZXJIVE1MOwovLwlfY29uZmlnLmFqYXhTZXR0aW5ncyA9IGpRdWVyeS5hamF4U2V0dGluZ3M7CglzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQl2YXIgb3V0cHV0ID0KCQkJJzxwIGlkPSJ0ZXN0cmVzdWx0IiBjbGFzcz0icmVzdWx0Ij4nICsKCQkJWydUZXN0cyBjb21wbGV0ZWQgaW4gJywgK25ldyBEYXRlIC0gc3RhcnRlZCwgJyBtaWxsaXNlY29uZHMuPGJyLz4nLAoJCQknPHNwYW4gY2xhc3M9ImJhZCI+JywgX2NvbmZpZy5zdGF0cy5iYWQsICc8L3NwYW4+IHRlc3RzIG9mIDxzcGFuIGNsYXNzPSJhbGwiPicsCgkJCV9jb25maWcuc3RhdHMuYWxsLCAnPC9zcGFuPiBmYWlsZWQuPC9wPiddLmpvaW4oJycpOwoJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodG9ET01GcmFnbWVudChvdXRwdXQpKTsKCQlkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYmFubmVyJykuY2xhc3NOYW1lID0gX2NvbmZpZy5zdGF0cy5iYWQgPyAiZmFpbCIgOiAicGFzcyI7Cgl9KTsKfQoKZnVuY3Rpb24gdGVzdChuYW1lLCBjYWxsYmFjaywgbm93YWl0KSB7CglpZihfY29uZmlnLmN1cnJlbnRNb2R1bGUpCgkJbmFtZSA9IF9jb25maWcuY3VycmVudE1vZHVsZSArICIgbW9kdWxlOiAiICsgbmFtZTsKCQkKCWlmICggIXZhbGlkVGVzdChuYW1lKSApCgkJcmV0dXJuOwoJCQoJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJX2NvbmZpZy5UZXN0ID0gW107CgkJdHJ5IHsKCQkJY2FsbGJhY2soKTsKCQl9IGNhdGNoKGUpIHsKCQkJaWYoIHR5cGVvZiBjb25zb2xlICE9ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgewoJCQkJY29uc29sZS5lcnJvcigiVGVzdCAiICsgbmFtZSArICIgZGllZCwgZXhjZXB0aW9uIGFuZCB0ZXN0IGZvbGxvd3MiKTsKCQkJCWNvbnNvbGUuZXJyb3IoZSk7CgkJCQljb25zb2xlLndhcm4oY2FsbGJhY2sudG9TdHJpbmcoKSk7CgkJCX0KCQkJX2NvbmZpZy5UZXN0LnB1c2goIFsgZmFsc2UsICJEaWVkIG9uIHRlc3QgIyIgKyAoX2NvbmZpZy5UZXN0Lmxlbmd0aCsxKSArICI6ICIgKyBlLm1lc3NhZ2UgXSApOwoJCX0KCX0pOwoKCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCXRyeSB7CgkJCXJlc2V0KCk7CgkJfSBjYXRjaChlKSB7CgkJCWlmKCB0eXBlb2YgY29uc29sZSAhPSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLmVycm9yICYmIGNvbnNvbGUud2FybiApIHsKCQkJCWNvbnNvbGUuZXJyb3IoInJlc2V0KCkgZmFpbGVkLCBmb2xsb3dpbmcgVGVzdCAiICsgbmFtZSArICIsIGV4Y2VwdGlvbiBhbmQgcmVzZXQgZm4gZm9sbG93cyIpOwoJCQkJY29uc29sZS5lcnJvcihlKTsKCQkJCWNvbnNvbGUud2FybihyZXNldC50b1N0cmluZygpKTsKCQkJfQoJCX0KCQkKCQkvLyBkb24ndCBvdXRwdXQgcGF1c2UgdGVzdHMKCQlpZihub3dhaXQpIHJldHVybjsKCQkKCQlpZihfY29uZmlnLmV4cGVjdGVkICYmIF9jb25maWcuZXhwZWN0ZWQgIT0gX2NvbmZpZy5UZXN0Lmxlbmd0aCkgewoJCQlfY29uZmlnLlRlc3QucHVzaCggWyBmYWxzZSwgIkV4cGVjdGVkICIgKyBfY29uZmlnLmV4cGVjdGVkICsgIiBhc3NlcnRpb25zLCBidXQgIiArIF9jb25maWcuVGVzdC5sZW5ndGggKyAiIHdlcmUgcnVuIiBdICk7CgkJfQoJCV9jb25maWcuZXhwZWN0ZWQgPSBudWxsOwoJCQoJCXZhciBnb29kID0gMCwgYmFkID0gMDsKCQl2YXIgb2wgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvbCIpOwoJCW9sLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkJdmFyIGxpID0gIiIsIHN0YXRlID0gInBhc3MiOwoJCWZvciAoIHZhciBpID0gMDsgaSA8IF9jb25maWcuVGVzdC5sZW5ndGg7IGkrKyApIHsKCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKCQkJbGkuY2xhc3NOYW1lID0gX2NvbmZpZy5UZXN0W2ldWzBdID8gInBhc3MiIDogImZhaWwiOwoJCQlsaS5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoX2NvbmZpZy5UZXN0W2ldWzFdKSApOwoJCQlvbC5hcHBlbmRDaGlsZCggbGkgKTsKCQkJCgkJCV9jb25maWcuc3RhdHMuYWxsKys7CgkJCWlmICggIV9jb25maWcuVGVzdFtpXVswXSApIHsKCQkJCXN0YXRlID0gImZhaWwiOwoJCQkJYmFkKys7CgkJCQlfY29uZmlnLnN0YXRzLmJhZCsrOwoJCQl9IGVsc2UgZ29vZCsrOwoJCX0KCQoJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CgkJbGkuY2xhc3NOYW1lID0gc3RhdGU7CgkKCQl2YXIgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cm9uZyIpOwoJCWIuaW5uZXJIVE1MID0gbmFtZSArICIgPGIgc3R5bGU9J2NvbG9yOmJsYWNrOyc+KDxiIGNsYXNzPSdmYWlsJz4iICsgYmFkICsgIjwvYj4sIDxiIGNsYXNzPSdwYXNzJz4iICsgZ29vZCArICI8L2I+LCAiICsgX2NvbmZpZy5UZXN0Lmxlbmd0aCArICIpPC9iPiI7CgkJYi5vbmNsaWNrID0gZnVuY3Rpb24oKXsKCQkJdmFyIG4gPSB0aGlzLm5leHRTaWJsaW5nOwoJCQlpZiAoIG4uc3R5bGUuZGlzcGxheSA9PSAibm9uZSIgKQoJCQkJbi5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJZWxzZQoJCQkJbi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoJCX07CiAgICAgICAgaWYgKGIuYWRkRXZlbnRMaXN0ZW5lcikKCQkJYi5hZGRFdmVudExpc3RlbmVyKCdkYmxjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7CgkJCQl2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInN0cm9uZyIpOwoJCQkJaWYgKCB0YXJnZXQubGVuZ3RoICkgewoJCQkJCWxvY2F0aW9uLmhyZWYgPSBsb2NhdGlvbi5ocmVmLm1hdGNoKC9eKC4rPykoXD8uKik/JC8pWzFdICsgIj8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHRhcmdldFswXS50ZXh0Q29udGVudCk7CgkJCQl9CgkJCX0sIGZhbHNlKTsKCQllbHNlCgkJCWIuYXR0YWNoRXZlbnQoJ29uZGJsY2xpY2snLCBmdW5jdGlvbihldmVudCkgewoJCQkJdmFyIHRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQucGFyZW50Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgic3Ryb25nIik7CgkJCQlpZiAoIHRhcmdldC5sZW5ndGggKSB7CgkJCQkJbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYubWF0Y2goL14oLis/KShcPy4qKT8kLylbMV0gKyAiPyIgKyBlbmNvZGVVUklDb21wb25lbnQodGFyZ2V0WzBdLmlubmVyVGV4dCk7CgkJCQl9CgkJCX0sIGZhbHNlKTsKCgkJbGkuYXBwZW5kQ2hpbGQoIGIgKTsKCQlsaS5hcHBlbmRDaGlsZCggb2wgKTsKCQoJCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0ZXN0cyIpLmFwcGVuZENoaWxkKCBsaSApOwkJCgl9KTsKfQoKLy8gY2FsbCBvbiBzdGFydCBvZiBtb2R1bGUgdGVzdCB0byBwcmVwZW5kIG5hbWUgdG8gYWxsIHRlc3RzCmZ1bmN0aW9uIG1vZHVsZShtb2R1bGVOYW1lKSB7CglfY29uZmlnLmN1cnJlbnRNb2R1bGUgPSBtb2R1bGVOYW1lOwp9CgovKioKICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLgogKi8KZnVuY3Rpb24gZXhwZWN0KGFzc2VydHMpIHsKCV9jb25maWcuZXhwZWN0ZWQgPSBhc3NlcnRzOwp9CgovKioKICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uCiAqLwpmdW5jdGlvbiByZXNldCgpIHsKCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluJykuaW5uZXJIVE1MID0gX2NvbmZpZy5maXh0dXJlOwovLwlqUXVlcnkuYWpheFNldHRpbmdzID0galF1ZXJ5LmV4dGVuZCh7fSwgX2NvbmZpZy5hamF4U2V0dGluZ3MpOwp9CgovKioKICogQXNzZXJ0cyB0cnVlLgogKiBAZXhhbXBsZSBvayggJCgiYSIpLmxlbmd0aCA+IDUsICJUaGVyZSBtdXN0IGJlIGF0IGxlYXN0IDUgYW5jaG9ycyIgKTsKICovCmZ1bmN0aW9uIG9rKGEsIG1zZykgewoJX2NvbmZpZy5UZXN0LnB1c2goIFsgISFhLCBtc2cgXSApOwp9CgovKioKICogQXNzZXJ0cyB0aGF0IHR3byBhcnJheXMgYXJlIHRoZSBzYW1lCiAqLwpmdW5jdGlvbiBpc1NldChhLCBiLCBtc2cpIHsKCXZhciByZXQgPSB0cnVlOwoJaWYgKCBhICYmIGIgJiYgYS5sZW5ndGggIT0gdW5kZWZpbmVkICYmIGEubGVuZ3RoID09IGIubGVuZ3RoICkgewoJCWZvciAoIHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKysgKQoJCQlpZiAoIGFbaV0gIT0gYltpXSApCgkJCQlyZXQgPSBmYWxzZTsKCX0gZWxzZQoJCXJldCA9IGZhbHNlOwoJaWYgKCAhcmV0ICkKCQlfY29uZmlnLlRlc3QucHVzaCggWyByZXQsIG1zZyArICIgZXhwZWN0ZWQ6ICIgKyBzZXJpYWxBcnJheShiKSArICIgcmVzdWx0OiAiICsgc2VyaWFsQXJyYXkoYSkgXSApOwoJZWxzZSAKCQlfY29uZmlnLlRlc3QucHVzaCggWyByZXQsIG1zZyBdICk7Cn0KCi8qKgogKiBBc3NlcnRzIHRoYXQgdHdvIG9iamVjdHMgYXJlIGVxdWl2YWxlbnQKICovCmZ1bmN0aW9uIGlzT2JqKGEsIGIsIG1zZykgewoJdmFyIHJldCA9IHRydWU7CgkKCWlmICggYSAmJiBiICkgewoJCWZvciAoIHZhciBpIGluIGEgKQoJCQlpZiAoIGFbaV0gIT0gYltpXSApCgkJCQlyZXQgPSBmYWxzZTsKCgkJZm9yICggaSBpbiBiICkKCQkJaWYgKCBhW2ldICE9IGJbaV0gKQoJCQkJcmV0ID0gZmFsc2U7Cgl9IGVsc2UKCQlyZXQgPSBmYWxzZTsKCiAgICBfY29uZmlnLlRlc3QucHVzaCggWyByZXQsIG1zZyBdICk7Cn0KCmZ1bmN0aW9uIHNlcmlhbEFycmF5KCBhICkgewoJdmFyIHIgPSBbXTsKCQoJaWYgKCBhICYmIGEubGVuZ3RoICkKICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICB2YXIgc3RyID0gYVtpXS5ub2RlTmFtZTsKICAgICAgICAgICAgaWYgKCBzdHIgKSB7CiAgICAgICAgICAgICAgICBzdHIgPSBzdHIudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIGlmICggYVtpXS5pZCApCiAgICAgICAgICAgICAgICAgICAgc3RyICs9ICIjIiArIGFbaV0uaWQ7CiAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgc3RyID0gYVtpXTsKICAgICAgICAgICAgci5wdXNoKCBzdHIgKTsKICAgICAgICB9CgoJcmV0dXJuICJbICIgKyByLmpvaW4oIiwgIikgKyAiIF0iOwp9CgpmdW5jdGlvbiBmbGF0TWFwKGEsIGJsb2NrKSB7Cgl2YXIgcmVzdWx0ID0gW107CgkkLmVhY2goYSwgZnVuY3Rpb24oKSB7CgkJdmFyIHggPSBibG9jay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCWlmICh4ICE9PSBmYWxzZSkKCQkJcmVzdWx0LnB1c2goeCk7Cgl9KQoJcmV0dXJuIHJlc3VsdDsKfQoKZnVuY3Rpb24gc2VyaWFsT2JqZWN0KCBhICkgewoJcmV0dXJuICJ7ICIgKyBmbGF0TWFwKGEsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKCQlyZXR1cm4ga2V5ICsgIjogIiArIHZhbHVlOwoJfSkuam9pbigiLCAiKSArICIgfSI7Cn0KCmZ1bmN0aW9uIGNvbXBhcmUoYSwgYiwgbXNnKSB7Cgl2YXIgcmV0ID0gdHJ1ZTsKCWlmICggYSAmJiBiICYmIGEubGVuZ3RoICE9IHVuZGVmaW5lZCAmJiBhLmxlbmd0aCA9PSBiLmxlbmd0aCApIHsKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrICkKCQkJZm9yKHZhciBrZXkgaW4gYVtpXSkgewoJCQkJaWYgKGFbaV1ba2V5XS5jb25zdHJ1Y3RvciA9PSBBcnJheSkgewoJCQkJCWZvciAodmFyIGFycmF5S2V5IGluIGFbaV1ba2V5XSkgewoJCQkJCQlpZiAoYVtpXVtrZXldW2FycmF5S2V5XSAhPSBiW2ldW2tleV1bYXJyYXlLZXldKSB7CgkJCQkJCQlyZXQgPSBmYWxzZTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoYVtpXVtrZXldICE9IGJbaV1ba2V5XSkgewoJCQkJCXJldCA9IGZhbHNlCgkJCQl9CgkJCX0KCX0gZWxzZQoJCXJldCA9IGZhbHNlOwoJb2soIHJldCwgbXNnICsgIiBleHBlY3RlZDogIiArIHNlcmlhbEFycmF5KGIpICsgIiByZXN1bHQ6ICIgKyBzZXJpYWxBcnJheShhKSApOwp9CgpmdW5jdGlvbiBjb21wYXJlMihhLCBiLCBtc2cpIHsKCXZhciByZXQgPSB0cnVlOwoJaWYgKCBhICYmIGIgKSB7CgkJZm9yKHZhciBrZXkgaW4gYSkgewoJCQlpZiAoYVtrZXldLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CgkJCQlmb3IgKHZhciBhcnJheUtleSBpbiBhW2tleV0pIHsKCQkJCQlpZiAoYVtrZXldW2FycmF5S2V5XSAhPSBiW2tleV1bYXJyYXlLZXldKSB7CgkJCQkJCXJldCA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIGlmIChhW2tleV0gIT0gYltrZXldKSB7CgkJCQlyZXQgPSBmYWxzZQoJCQl9CgkJfQoJCWZvcihrZXkgaW4gYikgewoJCQlpZiAoYltrZXldLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CgkJCQlmb3IgKHZhciBhcnJheUtleSBpbiBiW2tleV0pIHsKCQkJCQlpZiAoYVtrZXldW2FycmF5S2V5XSAhPSBiW2tleV1bYXJyYXlLZXldKSB7CgkJCQkJCXJldCA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIGlmIChhW2tleV0gIT0gYltrZXldKSB7CgkJCQlyZXQgPSBmYWxzZQoJCQl9CgkJfQoJfSBlbHNlCgkJcmV0ID0gZmFsc2U7CglvayggcmV0LCBtc2cgKyAiIGV4cGVjdGVkOiAiICsgc2VyaWFsT2JqZWN0KGIpICsgIiByZXN1bHQ6ICIgKyBzZXJpYWxPYmplY3QoYSkgKTsKfQoKLyoqCiAqIFJldHVybnMgYW4gYXJyYXkgb2YgZWxlbWVudHMgd2l0aCB0aGUgZ2l2ZW4gSURzLCBlZy4KICogQGV4YW1wbGUgcSgibWFpbiIsICJmb28iLCAiYmFyIikKICogQHJlc3VsdCBbPGRpdiBpZD0ibWFpbiI+LCA8c3BhbiBpZD0iZm9vIj4sIDxpbnB1dCBpZD0iYmFyIj5dCiAqLwpmdW5jdGlvbiBxKCkgewoJdmFyIHIgPSBbXTsKCWZvciAoIHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKyApCgkJci5wdXNoKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggYXJndW1lbnRzW2ldICkgKTsKCXJldHVybiByOwp9CgovKioKICogQXNzZXJ0cyB0aGF0IGEgc2VsZWN0IG1hdGNoZXMgdGhlIGdpdmVuIElEcwogKiBAZXhhbXBsZSB0KCJDaGVjayBmb3Igc29tZXRoaW5nIiwgIi8vW2FdIiwgWyJmb28iLCAiYmFhciJdKTsKICogQHJlc3VsdCByZXR1cm5zIHRydWUgaWYgIi8vW2FdIiByZXR1cm4gdHdvIGVsZW1lbnRzIHdpdGggdGhlIElEcyAnZm9vJyBhbmQgJ2JhYXInCiAqLwpmdW5jdGlvbiB0KGEsYixjKSB7Cgl2YXIgZiA9IE5XLkRvbS5zZWxlY3QoYik7Cgl2YXIgcyA9ICIiOwoJZm9yICggdmFyIGkgPSAwOyBpIDwgZi5sZW5ndGg7IGkrKyApCgkJcyArPSAocyAmJiAiLCIpICsgJyInICsgZltpXS5pZCArICciJzsKCWlzU2V0KGYsIHEuYXBwbHkocSxjKSwgYSArICIgKCIgKyBiICsgIikiKTsKfQoKLyoqCiAqIEFkZCByYW5kb20gbnVtYmVyIHRvIHVybCB0byBzdG9wIElFIGZyb20gY2FjaGluZwogKgogKiBAZXhhbXBsZSB1cmwoImRhdGEvdGVzdC5odG1sIikKICogQHJlc3VsdCAiZGF0YS90ZXN0Lmh0bWw/MTA1MzgzNTg0Mjg5NDMiCiAqCiAqIEBleGFtcGxlIHVybCgiZGF0YS90ZXN0LnBocD9mb289YmFyIikKICogQHJlc3VsdCAiZGF0YS90ZXN0LnBocD9mb289YmFyJjEwNTM4MzU4MzQ1NTU0IgogKi8KZnVuY3Rpb24gdXJsKHZhbHVlKSB7CglyZXR1cm4gdmFsdWUgKyAoL1w/Ly50ZXN0KHZhbHVlKSA/ICImIiA6ICI/IikgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiICsgcGFyc2VJbnQoTWF0aC5yYW5kb20oKSoxMDAwMDApOwp9CgovKioKICogQ2hlY2tzIHRoYXQgdGhlIGZpcnN0IHR3byBhcmd1bWVudHMgYXJlIGVxdWFsLCB3aXRoIGFuIG9wdGlvbmFsIG1lc3NhZ2UuCiAqIFByaW50cyBvdXQgYm90aCBhY3R1YWwgYW5kIGV4cGVjdGVkIHZhbHVlcy4KICoKICogUHJlZmVyZWQgdG8gb2soIGFjdHVhbCA9PSBleHBlY3RlZCwgbWVzc2FnZSApCiAqCiAqIEBleGFtcGxlIGVxdWFscyggJC5mb3JtYXQoIlJlY2VpdmVkIHswfSBieXRlcy4iLCAyKSwgIlJlY2VpdmVkIDIgYnl0ZXMuIiApOwogKgogKiBAcGFyYW0gT2JqZWN0IGFjdHVhbAogKiBAcGFyYW0gT2JqZWN0IGV4cGVjdGVkCiAqIEBwYXJhbSBTdHJpbmcgbWVzc2FnZSAob3B0aW9uYWwpCiAqLwpmdW5jdGlvbiBlcXVhbHMoYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJdmFyIHJlc3VsdCA9IGV4cGVjdGVkID09IGFjdHVhbDsKCW1lc3NhZ2UgPSBtZXNzYWdlIHx8IChyZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIik7CglfY29uZmlnLlRlc3QucHVzaCggWyByZXN1bHQsIHJlc3VsdCA/IG1lc3NhZ2UgKyAiOiAiICsgZXhwZWN0ZWQgOiBtZXNzYWdlICsgIiBleHBlY3RlZDogIiArIGV4cGVjdGVkICsgIiBhY3R1YWw6ICIgKyBhY3R1YWwgXSApOwp9CgovKioKICogVHJpZ2dlciBhbiBldmVudCBvbiBhbiBlbGVtZW50LgogKgogKiBAZXhhbXBsZSB0cmlnZ2VyRXZlbnQoIGRvY3VtZW50LmJvZHksICJjbGljayIgKTsKICoKICogQHBhcmFtIERPTUVsZW1lbnQgZWxlbQogKiBAcGFyYW0gU3RyaW5nIHR5cGUKICovCmZ1bmN0aW9uIHRyaWdnZXJFdmVudCggZWxlbSwgdHlwZSwgZXZlbnQgKSB7CglpZiAoIGRvY3VtZW50LmNyZWF0ZUV2ZW50ICkgewoJCWV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CgkJZXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LAoJCQkwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CgkJZWxlbS5kaXNwYXRjaEV2ZW50KCBldmVudCApOwoJfSBlbHNlIGlmICggZG9jdW1lbnQuY3JlYXRlRXZlbnRPYmplY3QgKSB7CgkJZWxlbS5maXJlRXZlbnQoIm9uIit0eXBlKTsKCX0KfQo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 19:54:45 GMT",
                    "Content-Length": "11066",
                    "Date": "Fri, 07 Nov 2014 19:54:47 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}