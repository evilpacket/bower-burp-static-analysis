{
    "url": "http://localhost:9999/dysfunc/opentok/opentok-webrtc.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.href</b> and written to <b>document.location.href</b> via the following statement:<ul><li>document.location.href = document.location.href.replace(\"#\", \"\");</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/dysfunc/opentok/opentok-webrtc.js",
                "path": "/dysfunc/opentok/opentok-webrtc.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9keXNmdW5jL29wZW50b2svb3BlbnRvay13ZWJydGMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDk2ODAxDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDIxOjI0OjQ2IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAyMToyNDo0NiBHTVQNCg0KLyoqCiAqIEBsaWNlbnNlICBPcGVuVG9rIEphdmFTY3JpcHQgTGlicmFyeSB2Mi4wLjE2CiAqIGh0dHA6Ly93d3cudG9rYm94LmNvbS8KICoKICogQ29weXJpZ2h0IChjKSAyMDEzIFRva0JveCwgSW5jLgogKgogKiBEYXRlOiBEZWNlbWJlciAxMiAxMDo1MjoxNyAyMDEzCiAqLwoKKGZ1bmN0aW9uKHdpbmRvdykgewppZiAoIXdpbmRvdy5PVCkgd2luZG93Lk9UID0ge307CgpPVC5wcm9wZXJ0aWVzID0gewogIHZlcnNpb246ICJ2Mi4wLjE2IiwgICAgICAgICAvLyBUaGUgY3VycmVudCB2ZXJzaW9uIChlZy4gdjIuMC40KSAoVGhpcyBpcyByZXBsYWNlZCBieSBncmFkbGUpCiAgYnVpbGQ6ICIzMmE4MmJmIiwgICAgLy8gVGhlIGN1cnJlbnQgYnVpbGQgaGFzaCAoVGhpcyBpcyByZXBsYWNlZCBieSBncmFkbGUpCgogIGRlYnVnOiAiZmFsc2UiLCAgICAgIC8vIFdoZXRoZXIgb3Igbm90IHRvIHR1cm4gb24gZGVidWcgbG9nZ2luZyBieSBkZWZhdWx0CiAgd2Vic2l0ZVVSTDogImh0dHA6Ly93d3cudG9rYm94LmNvbSIsICAgICAgLy8gVGhlIFVSTCBvZiB0aGUgdG9rYm94IHdlYnNpdGUKCiAgY2RuVVJMOiAiaHR0cDovL3N0YXRpYy5vcGVudG9rLmNvbSIsICAgICAgICAvLyBUaGUgVVJMIG9mIHRoZSBDRE4KICBsb2dnaW5nVVJMOiAiaHR0cDovL2hsZy50b2tib3guY29tL3Byb2QiLCAgIC8vIFRoZSBVUkwgdG8gdXNlIGZvciBsb2dnaW5nCiAgYXBpVVJMOiAiaHR0cDovL2FudmlsLm9wZW50b2suY29tIiwgICAgICAgICAgLy8gVGhlIGFudmlsIEFQSSBVUkwKCiAgbWVzc2FnaW5nUHJvdG9jb2w6ICJ3c3MiLCAgICAgICAgIC8vIFdoYXQgcHJvdG9jb2wgdG8gdXNlIHdoZW4gY29ubmVjdGluZyB0byB0aGUgcnVtb3Igd2ViIHNvY2tldAogIG1lc3NhZ2luZ1BvcnQ6IDQ0MywgICAgICAgICAgICAgICAvLyBXaGF0IHBvcnQgdG8gdXNlIHdoZW4gY29ubmVjdGlvbiB0byB0aGUgcnVtb3Igd2ViIHNvY2tldAoKICBzdXBwb3J0U1NMOiAidHJ1ZSIsICAgICAgICAgICAvLyBJZiB0aGlzIGVudmlyb25tZW50IHN1cHBvcnRzIFNTTAogIGNkblVSTFNTTDogImh0dHBzOi8vc3d3dy50b2tib3guY29tIiwgICAgICAgICAvLyBUaGUgQ0ROIHRvIHVzZSBpZiB3ZSdyZSB1c2luZyBTU0wKICBsb2dnaW5nVVJMU1NMOiAiaHR0cHM6Ly9obGcudG9rYm94LmNvbS9wcm9kIiwgICAgLy8gVGhlIGxvZ2dnaW5nIFVSTCB0byB1c2UgaWYgd2UncmUgdXNpbmcgU1NMCiAgYXBpVVJMU1NMOiAiaHR0cHM6Ly9hbnZpbC5vcGVudG9rLmNvbSIgICAgICAgICAgICAgLy8gVGhlIGFudmlsIEFQSSBVUkwgdG8gdXNlIGlmIHdlJ3JlIHVzaW5nIFNTTAp9OwoKfSkod2luZG93KTsKLyoqCiAqIEBsaWNlbnNlICBDb21tb24gSlMgSGVscGVycyBvbiBPcGVuVG9rIDAuMS4wIDQ5OTdmZTIgbWFzdGVyCiAqIGh0dHA6Ly93d3cudG9rYm94LmNvbS8KICoKICogQ29weXJpZ2h0IChjKSAyMDEzIFRva0JveCwgSW5jLgogKgogKiBEYXRlOiBPY3RvYmVyIDAzIDEyOjIzOjA5IDIwMTMKICoKICovCgovLyBPVCBIZWxwZXIgTWV0aG9kcwovLwovLyBoZWxwZXJzLmpzICAgICAgICAgICAgICAgICAgICAgICAgICAgPC0gdGhlIHJvb3QgZmlsZQovLyBoZWxwZXJzL2xpYi97aGVscGVyIHRvcGljfS5qcyAgICAgICAgPC0gc3BlY2lhbGlzZWQgaGVscGVycyBmb3Igc3BlY2lmaWMgdGFza3MvdG9waWNzCi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGkuZS4gdmlkZW8sIGRvbSwgZXRjKQovLwovLyBAZXhhbXBsZSBHZXR0aW5nIGEgRE9NIGVsZW1lbnQgYnkgaXQncyBpZAovLyAgdmFyIGVsZW1lbnQgPSBPVEhlbHBlcnMoJ2RvbUlkJyk7Ci8vCi8vIEBleGFtcGxlIFRlc3RpbmcgZm9yIHdlYiBzb2NrZXQgc3VwcG9ydAovLyAgaWYgKE9ULnN1cHBvcnRzV2ViU29ja2V0cygpKSB7Ci8vICAgICAgLy8gZG8gc29tZSBzdHVmZiB3aXRoIHdlYnNvY2tldHMKLy8gIH0KLy8KCi8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwoKIShmdW5jdGlvbih3aW5kb3csIHVuZGVmaW5lZCkgewoKCnZhciBPVEhlbHBlcnMgPSBmdW5jdGlvbihkb21JZCkgewogICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGRvbUlkKTsKfTsKCnZhciBwcmV2aW91c09USGVscGVycyA9IHdpbmRvdy5PVEhlbHBlcnM7Cgp3aW5kb3cuT1RIZWxwZXJzID0gT1RIZWxwZXJzOwoKT1RIZWxwZXJzLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICBPVEhlbHBlcnMubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIE9USGVscGVyczsKICB9OwogIHdpbmRvdy5PVEhlbHBlcnMgPSBwcmV2aW91c09USGVscGVyczsKICByZXR1cm4gT1RIZWxwZXJzOwp9OwoKCk9USGVscGVycy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRydWU7CiAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSB8fCB0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwoKICAvLyBPYmplY3RzIHdpdGhvdXQgZW51bWVyYWJsZSBvd25lZCBwcm9wZXJ0aWVzIGFyZSBlbXB0eS4KICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHJldHVybiBmYWxzZTsKICB9CgogIHJldHVybiB0cnVlOwp9OwoKT1RIZWxwZXJzLmlzTm9uZSA9IGZ1bmN0aW9uKG9iaikgewogIHJldHVybiBvYmogPT09IHVuZGVmaW5lZCB8fCBvYmogPT09IG51bGw7Cn07CgpPVEhlbHBlcnMuaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKTsKfTsKCgpPVEhlbHBlcnMuaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbic7Cn07CgovLyBFeHRlbmQgYSB0YXJnZXQgb2JqZWN0IHdpdGggdGhlIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IKLy8gbW9yZSBzb3VyY2Ugb2JqZWN0cwovLwovLyBAZXhhbXBsZToKLy8gICAgZGVzdCA9IE9USGVscGVycy5leHRlbmQoZGVzdCwgc291cmNlMSwgc291cmNlMiwgc291cmNlMyk7Ci8vCk9USGVscGVycy5leHRlbmQgPSBmdW5jdGlvbigvKiBkZXN0LCBzb3VyY2UxWywgc291cmNlMiwgLi4uLCAsIHNvdXJjZU5dKi8pIHsKICAgIHZhciBzb3VyY2VzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICBkZXN0ID0gc291cmNlcy5zaGlmdCgpOwoKICAgIHNvdXJjZXMuZm9yRWFjaChmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgICAgIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwogICAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBkZXN0Owp9OwoKLy8gRW5zdXJlcyB0aGF0IHRoZSB0YXJnZXQgb2JqZWN0IGNvbnRhaW5zIGNlcnRhaW4gZGVmYXVsdHMuCi8vCi8vIEBleGFtcGxlCi8vICAgdmFyIG9wdGlvbnMgPSBPVEhlbHBlcnMuZGVmYXVsdHMob3B0aW9ucywgewovLyAgICAgbG9hZGluZzogdHJ1ZSAgICAgLy8gbG9hZGluZyBieSBkZWZhdWx0Ci8vICAgfSk7Ci8vCk9USGVscGVycy5kZWZhdWx0cyA9IGZ1bmN0aW9uKC8qIGRlc3QsIGRlZmF1bHRzMVssIGRlZmF1bHRzMiwgLi4uLCAsIGRlZmF1bHRzTl0qLykgewogICAgdmFyIHNvdXJjZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLAogICAgICAgIGRlc3QgPSBzb3VyY2VzLnNoaWZ0KCk7CgogICAgc291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKGRlc3Rba2V5XSA9PT0gdm9pZCAwKSBkZXN0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gZGVzdDsKfTsKCi8vCk9USGVscGVycy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFPVEhlbHBlcnMuaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IE9USGVscGVycy5leHRlbmQoe30sIG9iaik7Cn07CgoKCi8vIEhhbmR5IGRvIG5vdGhpbmcgZnVuY3Rpb24KT1RIZWxwZXJzLm5vb3AgPSBmdW5jdGlvbigpIHt9OwoKLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBjbGllbnQgc3VwcG9ydHMgV2ViU29ja2V0cywgZmFsc2Ugb3RoZXJ3aXNlLgpPVEhlbHBlcnMuc3VwcG9ydHNXZWJTb2NrZXRzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gJ1dlYlNvY2tldCcgaW4gd2luZG93Owp9OwoKLy8gUmV0dXJucyB0aGUgbnVtYmVyIG9mIG1pbGxpc2Nlb25kcyBzaW5jZSB0aGUgdGhlIFVOSVggZXBvY2gsIHRoaXMgaXMgZnVuY3Rpb25hbGx5Ci8vIGVxdWl2YWxlbnQgdG8gZXhlY3V0aW5nIG5ldyBEYXRlKCkuZ2V0VGltZSgpLgovLwovLyBXaGVyZSBhdmFpbGFibGUsIHdlIHVzZSAncGVyZm9ybWFuY2Uubm93JyB3aGljaCBpcyBtb3JlIGFjY3VyYXRlIGFuZCByZWxpYWJsZSwKLy8gb3RoZXJ3aXNlIHdlIGRlZmF1bHQgdG8gbmV3IERhdGUoKS5nZXRUaW1lKCkuCk9USGVscGVycy5ub3cgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgcGVyZm9ybWFuY2UgPSB3aW5kb3cucGVyZm9ybWFuY2UgfHwge30sCiAgICAgICAgbmF2aWdhdGlvblN0YXJ0LAogICAgICAgIG5vdyA9ICBwZXJmb3JtYW5jZS5ub3cgICAgICAgfHwKICAgICAgICAgICAgICAgcGVyZm9ybWFuY2UubW96Tm93ICAgIHx8CiAgICAgICAgICAgICAgIHBlcmZvcm1hbmNlLm1zTm93ICAgICB8fAogICAgICAgICAgICAgICBwZXJmb3JtYW5jZS5vTm93ICAgICAgfHwKICAgICAgICAgICAgICAgcGVyZm9ybWFuY2Uud2Via2l0Tm93OwoKICAgIGlmIChub3cpIHsKICAgICAgICBub3cgPSBub3cuYmluZChwZXJmb3JtYW5jZSk7CiAgICAgICAgbmF2aWdhdGlvblN0YXJ0ID0gcGVyZm9ybWFuY2UudGltaW5nLm5hdmlnYXRpb25TdGFydDsKCiAgICAgICAgcmV0dXJuICBmdW5jdGlvbigpIHsgcmV0dXJuIG5hdmlnYXRpb25TdGFydCArIG5vdygpOyB9OwogICAgfQogICAgZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7IH07CiAgICB9Cn0pKCk7CgpPVEhlbHBlcnMuYnJvd3NlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHVzZXJBZ2VudCA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCksCiAgICAgICAgbmF2aWdhdG9yVmVuZG9yLAogICAgICAgIGJyb3dzZXIgPSAnVW5rbm93bic7CgogICAgaWYgKHVzZXJBZ2VudC5pbmRleE9mKCdmaXJlZm94JykgPiAtMSkgICB7CiAgICAgICAgYnJvd3NlciA9ICdGaXJlZm94JzsKICAgIH0KICAgIGlmICh1c2VyQWdlbnQuaW5kZXhPZignb3BlcmEnKSA+IC0xKSAgIHsKICAgICAgICBicm93c2VyID0gJ09wZXJhJzsKICAgIH0KICAgIGVsc2UgaWYgKHVzZXJBZ2VudC5pbmRleE9mKCJtc2llIikgPiAtMSkgewogICAgICAgIGJyb3dzZXIgPSAiSUUiOwogICAgfQogICAgZWxzZSBpZiAodXNlckFnZW50LmluZGV4T2YoImNocm9tZSIpID4gLTEpIHsKICAgICAgICBicm93c2VyID0gIkNocm9tZSI7CiAgICB9CgogICAgaWYgKChuYXZpZ2F0b3JWZW5kb3IgPSB3aW5kb3cubmF2aWdhdG9yLnZlbmRvcikgJiYgbmF2aWdhdG9yVmVuZG9yLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiYXBwbGUiKSA+IC0xKSB7CiAgICAgICAgYnJvd3NlciA9ICJTYWZhcmkiOwogICAgfQoKICAgIHVzZXJBZ2VudCA9IG51bGw7CiAgICBPVEhlbHBlcnMuYnJvd3NlciA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gYnJvd3NlcjsgfTsKICAgIHJldHVybiBicm93c2VyOwp9OwoKCk9USGVscGVycy5jYW5EZWZpbmVQcm9wZXJ0eSA9IHRydWU7Cgp0cnkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHt9LCAneCcsIHt9KTsKfSBjYXRjaCAoZXJyKSB7CiAgICBPVEhlbHBlcnMuY2FuRGVmaW5lUHJvcGVydHkgPSBmYWxzZTsKfQoKLy8gQSBoZWxwZXIgZm9yIGRlZmluaW5nIGEgbnVtYmVyIG9mIGdldHRlcnMgYXQgb25jZS4KLy8KLy8gQGV4YW1wbGU6IGZyb20gaW5zaWRlIGFuIG9iamVjdAovLyAgIE9USGVscGVycy5kZWZpbmVHZXR0ZXJzKHRoaXMsIHsKLy8gICAgIGFwaUtleTogZnVuY3Rpb24oKSB7IHJldHVybiBfYXBpS2V5OyB9LAovLyAgICAgdG9rZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3Rva2VuOyB9LAovLyAgICAgY29ubmVjdGVkOiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuaXMoJ2Nvbm5lY3RlZCcpOyB9LAovLyAgICAgY29ubmVjdGlvbjogZnVuY3Rpb24oKSB7IHJldHVybiBfc29ja2V0ICYmIF9zb2NrZXQuaWQgPyB0aGlzLmNvbm5lY3Rpb25zLmdldChfc29ja2V0LmlkKSA6IG51bGw7IH0sCi8vICAgICBjYXBhYmlsaXRpZXM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3NvY2tldC5jYXBhYmlsaXRpZXM7IH0sCi8vICAgICBzZXNzaW9uSWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3Nlc3Npb25JZDsgfSwKLy8gICAgIGlkOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uSWQ7IH0KLy8gICB9KTsKLy8KT1RIZWxwZXJzLmRlZmluZUdldHRlcnMgPSBmdW5jdGlvbihzZWxmLCBnZXR0ZXJzLCBlbnVtZXJhYmxlKSB7CiAgdmFyIHByb3BzRGVmaW5pdGlvbiA9IHt9OwoKICBpZiAoZW51bWVyYWJsZSA9PT0gdm9pZCAwKSBlbnVtZXJhYmxlID0gZmFsc2U7CgogIGZvciAodmFyIGtleSBpbiBnZXR0ZXJzKSB7CiAgICBwcm9wc0RlZmluaXRpb25ba2V5XSA9IHsKICAgICAgZ2V0OiBnZXR0ZXJzW2tleV0sCiAgICAgIGVudW1lcmFibGU6IGVudW1lcmFibGUKICAgIH07CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhzZWxmLCBwcm9wc0RlZmluaXRpb24pOwp9OwoKCi8vIFBvbHlmaWxsIE9iamVjdC5jcmVhdGUgZm9yIElFOAovLwovLyBTZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9PYmplY3QvY3JlYXRlCi8vCmlmICghT2JqZWN0LmNyZWF0ZSkgewogICAgT2JqZWN0LmNyZWF0ZSA9IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignT2JqZWN0LmNyZWF0ZSBpbXBsZW1lbnRhdGlvbiBvbmx5IGFjY2VwdHMgdGhlIGZpcnN0IHBhcmFtZXRlci4nKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRigpIHt9CiAgICAgICAgRi5wcm90b3R5cGUgPSBvOwogICAgICAgIHJldHVybiBuZXcgRigpOwogICAgfTsKfQoKT1RIZWxwZXJzLnNldENvb2tpZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCB2YWx1ZSk7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICAvLyBTdG9yZSBpbiBicm93c2VyIGNvb2tpZQogICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpOwogICAgZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpKygzNjUqMjQqNjAqNjAqMTAwMCkpOwogICAgdmFyIGV4cGlyZXMgPSAiOyBleHBpcmVzPSIrZGF0ZS50b0dNVFN0cmluZygpOwogICAgZG9jdW1lbnQuY29va2llID0ga2V5KyI9Iit2YWx1ZStleHBpcmVzKyI7IHBhdGg9LyI7CiAgfQp9OwoKT1RIZWxwZXJzLmdldENvb2tpZSA9IGZ1bmN0aW9uKGtleSkgewogICAgdmFyIHZhbHVlOwoKICAgIHRyeSB7CiAgICAgIHZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oIm9wZW50b2tfY2xpZW50X2lkIik7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICAvLyBDaGVjayBicm93c2VyIGNvb2tpZXMKICAgICAgdmFyIG5hbWVFUSA9IGtleSArICI9IjsKICAgICAgdmFyIGNhID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCc7Jyk7CiAgICAgIGZvcih2YXIgaT0wO2kgPCBjYS5sZW5ndGg7aSsrKSB7CiAgICAgICAgdmFyIGMgPSBjYVtpXTsKICAgICAgICB3aGlsZSAoYy5jaGFyQXQoMCk9PScgJykgYyA9IGMuc3Vic3RyaW5nKDEsYy5sZW5ndGgpOwogICAgICAgIGlmIChjLmluZGV4T2YobmFtZUVRKSA9PT0gMCkgewogICAgICAgICAgdmFsdWUgPSBjLnN1YnN0cmluZyhuYW1lRVEubGVuZ3RoLGMubGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsOwp9OwoKCi8vLyBTdG9sZW4gZnJvbSBVbmRlcnNjb3JlLCB0aGlzIG5lZWRzIHJlcGxhY2luZwoKCiAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgogIE9USGVscGVycy5pbnZlcnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgcmVzdWx0W29ialtrZXldXSA9IGtleTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCgogIC8vIExpc3Qgb2YgSFRNTCBlbnRpdGllcyBmb3IgZXNjYXBpbmcuCiAgdmFyIGVudGl0eU1hcCA9IHsKICAgIGVzY2FwZTogewogICAgICAnJic6ICcmYW1wOycsCiAgICAgICc8JzogJyZsdDsnLAogICAgICAnPic6ICcmZ3Q7JywKICAgICAgJyInOiAnJnF1b3Q7JywKICAgICAgIiciOiAnJiN4Mjc7JywKICAgICAgJy8nOiAnJiN4MkY7JwogICAgfQogIH07CiAgZW50aXR5TWFwLnVuZXNjYXBlID0gT1RIZWxwZXJzLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKCiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiAgIG5ldyBSZWdFeHAoJ1snICsgT2JqZWN0LmtleXMoZW50aXR5TWFwLmVzY2FwZSkuam9pbignJykgKyAnXScsICdnJyksCiAgICB1bmVzY2FwZTogbmV3IFJlZ0V4cCgnKCcgKyBPYmplY3Qua2V5cyhlbnRpdHlNYXAudW5lc2NhcGUpLmpvaW4oJ3wnKSArICcpJywgJ2cnKQogIH07CgogIC8vIEZ1bmN0aW9ucyBmb3IgZXNjYXBpbmcgYW5kIHVuZXNjYXBpbmcgc3RyaW5ncyB0by9mcm9tIEhUTUwgaW50ZXJwb2xhdGlvbi4KICBbJ2VzY2FwZScsICd1bmVzY2FwZSddLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICBPVEhlbHBlcnNbbWV0aG9kXSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHN0cmluZyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiAoJycgKyBzdHJpbmcpLnJlcGxhY2UoZW50aXR5UmVnZXhlc1ttZXRob2RdLCBmdW5jdGlvbihtYXRjaCkgewogICAgICAgIHJldHVybiBlbnRpdHlNYXBbbWV0aG9kXVttYXRjaF07CiAgICAgIH0pOwogICAgfTsKICB9KTsKCi8vIEJ5IGRlZmF1bHQsIFVuZGVyc2NvcmUgdXNlcyBFUkItc3R5bGUgdGVtcGxhdGUgZGVsaW1pdGVycywgY2hhbmdlIHRoZQovLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCk9USGVscGVycy50ZW1wbGF0ZVNldHRpbmdzID0gewogIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgaW50ZXJwb2xhdGUgOiAvPCU9KFtcc1xTXSs/KSU+L2csCiAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKfTsKCi8vIFdoZW4gY3VzdG9taXppbmcgYHRlbXBsYXRlU2V0dGluZ3NgLCBpZiB5b3UgZG9uJ3Qgd2FudCB0byBkZWZpbmUgYW4KLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwovLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KdmFyIG5vTWF0Y2ggPSAvKC4pXi87CgovLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQovLyBzdHJpbmcgbGl0ZXJhbC4KdmFyIGVzY2FwZXMgPSB7CiAgIiciOiAgICAgICInIiwKICAnXFwnOiAgICAgJ1xcJywKICAnXHInOiAgICAgJ3InLAogICdcbic6ICAgICAnbicsCiAgJ1x0JzogICAgICd0JywKICAnXHUyMDI4JzogJ3UyMDI4JywKICAnXHUyMDI5JzogJ3UyMDI5Jwp9OwoKdmFyIGVzY2FwZXIgPSAvXFx8J3xccnxcbnxcdHxcdTIwMjh8XHUyMDI5L2c7CgovLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgovLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCi8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgpPVEhlbHBlcnMudGVtcGxhdGUgPSBmdW5jdGlvbih0ZXh0LCBkYXRhLCBzZXR0aW5ncykgewogIHZhciByZW5kZXI7CiAgc2V0dGluZ3MgPSBPVEhlbHBlcnMuZGVmYXVsdHMoe30sIHNldHRpbmdzLCBPVEhlbHBlcnMudGVtcGxhdGVTZXR0aW5ncyk7CgogIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogIHZhciBtYXRjaGVyID0gbmV3IFJlZ0V4cChbCiAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAoc2V0dGluZ3MuZXZhbHVhdGUgfHwgbm9NYXRjaCkuc291cmNlCiAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogIHZhciBpbmRleCA9IDA7CiAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwogIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkKICAgICAgLnJlcGxhY2UoZXNjYXBlciwgZnVuY3Rpb24obWF0Y2gpIHsgcmV0dXJuICdcXCcgKyBlc2NhcGVzW21hdGNoXTsgfSk7CgogICAgaWYgKGVzY2FwZSkgewogICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGVzY2FwZSArICIpKT09bnVsbD8nJzpPVEhlbHBlcnMuZXNjYXBlKF9fdCkpK1xuJyI7CiAgICB9CiAgICBpZiAoaW50ZXJwb2xhdGUpIHsKICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CiAgICB9CiAgICBpZiAoZXZhbHVhdGUpIHsKICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIjsKICAgIH0KICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwogICAgcmV0dXJuIG1hdGNoOwogIH0pOwogIHNvdXJjZSArPSAiJztcbiI7CgogIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCiAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCiAgICAicHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTtcbiIgKwogICAgc291cmNlICsgInJldHVybiBfX3A7XG4iOwoKCiAgdHJ5IHsKICAgIC8vIGV2aWwgaXMgbmVjZXNzYXJ5IGZvciB0aGUgbmV3IEZ1bmN0aW9uIGxpbmUKICAgIC8qanNoaW50IGV2aWw6dHJ1ZSAqLwogICAgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCBzb3VyY2UpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGUuc291cmNlID0gc291cmNlOwogICAgdGhyb3cgZTsKICB9CgogIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEpOwogIHZhciB0ZW1wbGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhKTsKICB9OwoKICAvLyBQcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbiBzb3VyY2UgYXMgYSBjb252ZW5pZW5jZSBmb3IgcHJlY29tcGlsYXRpb24uCiAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKICByZXR1cm4gdGVtcGxhdGU7Cn07Cgp9KSh3aW5kb3cpOwovKmpzaGludCBicm93c2VyOnRydWUsIHNtYXJ0dGFiczp0cnVlKi8KCi8vIHRiX3JlcXVpcmUoJy4uLy4uL2hlbHBlcnMuanMnKQoKKGZ1bmN0aW9uKHdpbmRvdywgT1RIZWxwZXJzLCB1bmRlZmluZWQpIHsKCk9USGVscGVycy5zdGF0YWJsZSA9IGZ1bmN0aW9uKHNlbGYsIHBvc3NpYmxlU3RhdGVzLCBpbml0aWFsU3RhdGUsIHN0YXRlQ2hhbmdlZCwgc3RhdGVDaGFuZ2VkRmFpbGVkKSB7CiAgdmFyIHByZXZpb3VzU3RhdGUsCiAgICAgIGN1cnJlbnRTdGF0ZSA9IGluaXRpYWxTdGF0ZTsKCiAgdmFyIHNldFN0YXRlID0gZnVuY3Rpb24oc3RhdGUpIHsKICAgIGlmIChjdXJyZW50U3RhdGUgIT09IHN0YXRlKSB7CiAgICAgICAgaWYgKHBvc3NpYmxlU3RhdGVzLmluZGV4T2Yoc3RhdGUpID09PSAtMSkgewogICAgICAgICAgaWYgKHN0YXRlQ2hhbmdlZEZhaWxlZCAmJiBPVEhlbHBlcnMuaXNGdW5jdGlvbihzdGF0ZUNoYW5nZWRGYWlsZWQpKSBzdGF0ZUNoYW5nZWRGYWlsZWQoJ2ludmFsaWRTdGF0ZScsIHN0YXRlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHByZXZpb3VzU3RhdGUgPSBjdXJyZW50U3RhdGU7CiAgICAgICAgY3VycmVudFN0YXRlID0gc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlQ2hhbmdlZCAmJiBPVEhlbHBlcnMuaXNGdW5jdGlvbihzdGF0ZUNoYW5nZWQpKSBzdGF0ZUNoYW5nZWQoc3RhdGUsIHByZXZpb3VzU3RhdGUpOwogICAgfQogIH07CgoKICAvLyBSZXR1cm5zIGEgbnVtYmVyIG9mIHN0YXRlcyBhbmQgcmV0dXJucyB0cnVlIGlmIHRoZSBjdXJyZW50IHN0YXRlCiAgLy8gaXMgYW55IG9mIHRoZW0uCiAgLy8KICAvLyBAZXhhbXBsZQogIC8vIGlmICh0aGlzLmlzKCdjb25uZWN0aW5nJywgJ2Nvbm5lY3RlZCcpKSB7CiAgLy8gICAvLyBkbyBzb21lIHN0dWZmCiAgLy8gfQogIC8vCiAgc2VsZi5pcyA9IGZ1bmN0aW9uICgvKiBzdGF0ZTA6U3RyaW5nLCBzdGF0ZTE6U3RyaW5nLCAuLi4sIHN0YXRlTjpTdHJpbmcgKi8pIHsKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFyZ3VtZW50cywgY3VycmVudFN0YXRlKSAhPT0gLTE7CiAgfTsKCgogIC8vIFJldHVybnMgYSBudW1iZXIgb2Ygc3RhdGVzIGFuZCByZXR1cm5zIHRydWUgaWYgdGhlIGN1cnJlbnQgc3RhdGUKICAvLyBpcyBub25lIG9mIHRoZW0uCiAgLy8KICAvLyBAZXhhbXBsZQogIC8vIGlmICh0aGlzLmlzTm90KCdjb25uZWN0aW5nJywgJ2Nvbm5lY3RlZCcpKSB7CiAgLy8gICAvLyBkbyBzb21lIHN0dWZmCiAgLy8gfQogIC8vCiAgc2VsZi5pc05vdCA9IGZ1bmN0aW9uICgvKiBzdGF0ZTA6U3RyaW5nLCBzdGF0ZTE6U3RyaW5nLCAuLi4sIHN0YXRlTjpTdHJpbmcgKi8pIHsKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFyZ3VtZW50cywgY3VycmVudFN0YXRlKSA9PT0gLTE7CiAgfTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoc2VsZiwgewogICAgc3RhdGU6IHsKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIGN1cnJlbnRTdGF0ZTsgfQogICAgfSwKCiAgICBwcmV2aW91c1N0YXRlOiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBwcmV2aW91c1N0YXRlOyB9CiAgICB9CiAgfSk7CgogIHJldHVybiBzZXRTdGF0ZTsKfTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7Ci8qIQogKiAgVGhpcyBpcyBhIG1vZGlmaWVkIHZlcnNpb24gb2YgUm9iZXJ0IEtpZWZmZXIgYXdlc29tZSB1dWlkLmpzIGxpYnJhcnkuCiAqICBUaGUgb25seSBtb2RpZmljYXRpb25zIHdlJ3ZlIG1hZGUgYXJlIHRvIHJlbW92ZSB0aGUgTm9kZS5qcyBzcGVjaWZpYwogKiAgcGFydHMgb2YgdGhlIGNvZGUgYW5kIHRoZSBVVUlEIHZlcnNpb24gMSBnZW5lcmF0b3IgKHdoaWNoIHdlIGRvbid0CiAqICB1c2UpLiBUaGUgb3JpZ2luYWwgY29weXJpZ2h0IG5vdGljZSBpcyBiZWxvdy4KICoKICogICAgIG5vZGUtdXVpZC91dWlkLmpzCiAqCiAqICAgICBDb3B5cmlnaHQgKGMpIDIwMTAgUm9iZXJ0IEtpZWZmZXIKICogICAgIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgogKiAgICAgRG9jdW1lbnRhdGlvbiBhbmQgZGV0YWlscyBhdCBodHRwczovL2dpdGh1Yi5jb20vYnJvb2ZhL25vZGUtdXVpZAogKi8KLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCgovKmdsb2JhbCBjcnlwdG86dHJ1ZSwgVWludDMyQXJyYXk6dHJ1ZSwgQnVmZmVyOnRydWUgKi8KLypqc2hpbnQgYnJvd3Nlcjp0cnVlLCBzbWFydHRhYnM6dHJ1ZSovCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKICAvLyBVbmlxdWUgSUQgY3JlYXRpb24gcmVxdWlyZXMgYSBoaWdoIHF1YWxpdHkgcmFuZG9tICMgZ2VuZXJhdG9yLCBidXQKICAvLyBNYXRoLnJhbmRvbSgpIGRvZXMgbm90IGd1YXJhbnRlZSAiY3J5cHRvZ3JhcGhpYyBxdWFsaXR5Ii4gIFNvIHdlIGZlYXR1cmUKICAvLyBkZXRlY3QgZm9yIG1vcmUgcm9idXN0IEFQSXMsIG5vcm1hbGl6aW5nIGVhY2ggbWV0aG9kIHRvIHJldHVybiAxMjgtYml0cwogIC8vICgxNiBieXRlcykgb2YgcmFuZG9tIGRhdGEuCiAgdmFyIG1hdGhSTkcsIHdoYXR3Z1JORzsKCiAgLy8gTWF0aC5yYW5kb20oKS1iYXNlZCBSTkcuICBBbGwgcGxhdGZvcm1zLCB2ZXJ5IGZhc3QsIHVua25vd24gcXVhbGl0eQogIHZhciBfcm5kQnl0ZXMgPSBuZXcgQXJyYXkoMTYpOwogIG1hdGhSTkcgPSBmdW5jdGlvbigpIHsKICAgIHZhciByLCBiID0gX3JuZEJ5dGVzLCBpID0gMDsKCiAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkrKykgewogICAgICBpZiAoKGkgJiAweDAzKSA9PT0gMCkgciA9IE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMDsKICAgICAgYltpXSA9IHIgPj4+ICgoaSAmIDB4MDMpIDw8IDMpICYgMHhmZjsKICAgIH0KCiAgICByZXR1cm4gYjsKICB9OwoKICAvLyBXSEFUV0cgY3J5cHRvLWJhc2VkIFJORyAtIGh0dHA6Ly93aWtpLndoYXR3Zy5vcmcvd2lraS9DcnlwdG8KICAvLyBXZWJLaXQgb25seSAoY3VycmVudGx5KSwgbW9kZXJhdGVseSBmYXN0LCBoaWdoIHF1YWxpdHkKICBpZiAod2luZG93LmNyeXB0byAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKSB7CiAgICB2YXIgX3JuZHMgPSBuZXcgVWludDMyQXJyYXkoNCk7CiAgICB3aGF0d2dSTkcgPSBmdW5jdGlvbigpIHsKICAgICAgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhfcm5kcyk7CgogICAgICBmb3IgKHZhciBjID0gMCA7IGMgPCAxNjsgYysrKSB7CiAgICAgICAgX3JuZEJ5dGVzW2NdID0gX3JuZHNbYyA+PiAyXSA+Pj4gKChjICYgMHgwMykgKiA4KSAmIDB4ZmY7CiAgICAgIH0KICAgICAgcmV0dXJuIF9ybmRCeXRlczsKICAgIH07CiAgfQoKICAvLyBTZWxlY3QgUk5HIHdpdGggYmVzdCBxdWFsaXR5CiAgdmFyIF9ybmcgPSB3aGF0d2dSTkcgfHwgbWF0aFJORzsKCiAgLy8gQnVmZmVyIGNsYXNzIHRvIHVzZQogIHZhciBCdWZmZXJDbGFzcyA9IHR5cGVvZihCdWZmZXIpID09ICdmdW5jdGlvbicgPyBCdWZmZXIgOiBBcnJheTsKCiAgLy8gTWFwcyBmb3IgbnVtYmVyIDwtPiBoZXggc3RyaW5nIGNvbnZlcnNpb24KICB2YXIgX2J5dGVUb0hleCA9IFtdOwogIHZhciBfaGV4VG9CeXRlID0ge307CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7IGkrKykgewogICAgX2J5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7CiAgICBfaGV4VG9CeXRlW19ieXRlVG9IZXhbaV1dID0gaTsKICB9CgogIC8vICoqYHBhcnNlKClgIC0gUGFyc2UgYSBVVUlEIGludG8gaXQncyBjb21wb25lbnQgYnl0ZXMqKgogIGZ1bmN0aW9uIHBhcnNlKHMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IChidWYgJiYgb2Zmc2V0KSB8fCAwLCBpaSA9IDA7CgogICAgYnVmID0gYnVmIHx8IFtdOwogICAgcy50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1swLTlhLWZdezJ9L2csIGZ1bmN0aW9uKG9jdCkgewogICAgICBpZiAoaWkgPCAxNikgeyAvLyBEb24ndCBvdmVyZmxvdyEKICAgICAgICBidWZbaSArIGlpKytdID0gX2hleFRvQnl0ZVtvY3RdOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBaZXJvIG91dCByZW1haW5pbmcgYnl0ZXMgaWYgc3RyaW5nIHdhcyBzaG9ydAogICAgd2hpbGUgKGlpIDwgMTYpIHsKICAgICAgYnVmW2kgKyBpaSsrXSA9IDA7CiAgICB9CgogICAgcmV0dXJuIGJ1ZjsKICB9CgogIC8vICoqYHVucGFyc2UoKWAgLSBDb252ZXJ0IFVVSUQgYnl0ZSBhcnJheSAoYWxhIHBhcnNlKCkpIGludG8gYSBzdHJpbmcqKgogIGZ1bmN0aW9uIHVucGFyc2UoYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gb2Zmc2V0IHx8IDAsIGJ0aCA9IF9ieXRlVG9IZXg7CiAgICByZXR1cm4gIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgJy0nICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV07CiAgfQoKICAvLyAqKmB2NCgpYCAtIEdlbmVyYXRlIHJhbmRvbSBVVUlEKioKCiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkIGZvciBBUEkgZGV0YWlscwogIGZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICAvLyBEZXByZWNhdGVkIC0gJ2Zvcm1hdCcgYXJndW1lbnQsIGFzIHN1cHBvcnRlZCBpbiB2MS4yCiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKCiAgICBpZiAodHlwZW9mKG9wdGlvbnMpID09ICdzdHJpbmcnKSB7CiAgICAgIGJ1ZiA9IG9wdGlvbnMgPT0gJ2JpbmFyeScgPyBuZXcgQnVmZmVyQ2xhc3MoMTYpIDogbnVsbDsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICB9CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBfcm5nKSgpOwoKICAgIC8vIFBlciA0LjQsIHNldCBiaXRzIGZvciB2ZXJzaW9uIGFuZCBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAKICAgIHJuZHNbNl0gPSAocm5kc1s2XSAmIDB4MGYpIHwgMHg0MDsKICAgIHJuZHNbOF0gPSAocm5kc1s4XSAmIDB4M2YpIHwgMHg4MDsKCiAgICAvLyBDb3B5IGJ5dGVzIHRvIGJ1ZmZlciwgaWYgcHJvdmlkZWQKICAgIGlmIChidWYpIHsKICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IDE2OyBpaSsrKSB7CiAgICAgICAgYnVmW2kgKyBpaV0gPSBybmRzW2lpXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBidWYgfHwgdW5wYXJzZShybmRzKTsKICB9CgogIC8vIEV4cG9ydCBwdWJsaWMgQVBJCiAgdmFyIHV1aWQgPSB2NDsKICB1dWlkLnY0ID0gdjQ7CiAgdXVpZC5wYXJzZSA9IHBhcnNlOwogIHV1aWQudW5wYXJzZSA9IHVucGFyc2U7CiAgdXVpZC5CdWZmZXJDbGFzcyA9IEJ1ZmZlckNsYXNzOwoKICAvLyBFeHBvcnQgUk5HIG9wdGlvbnMKICB1dWlkLm1hdGhSTkcgPSBtYXRoUk5HOwogIHV1aWQud2hhdHdnUk5HID0gd2hhdHdnUk5HOwoKICBPVEhlbHBlcnMudXVpZCA9IHV1aWQ7Cgp9KHdpbmRvdywgd2luZG93Lk9USGVscGVycykpOwovLyBBSkFYIGhlbHBlcnMKCi8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwovKmdsb2JhbCBBY3RpdmVYT2JqZWN0OnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKLy8gU2hpbSB1cCBYTUwgc3VwcG9ydCBmb3IgSUU4CmZ1bmN0aW9uIHNoaW1YTUxGb3JJRTgoeG1sKSB7CiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9ET00vRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZAogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHhtbC5wcm90b3R5cGUsICJmaXJzdEVsZW1lbnRDaGlsZCIsIHsKICAgICAgICAiZ2V0IiA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXM7CiAgICAgICAgICAgIG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlKG5vZGUgJiYgbm9kZS5ub2RlVHlwZSAhPSAxKSBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvRW4vRE9NL0VsZW1lbnQubGFzdEVsZW1lbnRDaGlsZAogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHhtbC5wcm90b3R5cGUsICJsYXN0RWxlbWVudENoaWxkIiwgewogICAgICAgICJnZXQiIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpczsKICAgICAgICAgICAgbm9kZSA9IG5vZGUubGFzdENoaWxkOwogICAgICAgICAgICB3aGlsZShub2RlICYmIG5vZGUubm9kZVR5cGUgIT0gMSkgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9Fbi9ET00vRWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh4bWwucHJvdG90eXBlLCAibmV4dEVsZW1lbnRTaWJsaW5nIiwgewogICAgICAgICJnZXQiIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpczsKICAgICAgICAgICAgd2hpbGUoIU9USGVscGVycy5pc05vbmUobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICBpZihub2RlLm5vZGVUeXBlID09IDEpIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9Fbi9ET00vRWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoeG1sLnByb3RvdHlwZSwgInByZXZpb3VzRWxlbWVudFNpYmxpbmciLCB7CiAgICAgICAgImdldCIgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzOwogICAgICAgICAgICB3aGlsZSghT1RIZWxwZXJzLmlzTm9uZShub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICBpZihub2RlLm5vZGVUeXBlID09IDEpIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgIH0pOwp9CgpPVEhlbHBlcnMucGFyc2VYTUwgPSBmdW5jdGlvbih4bWxTdHJpbmcpIHsKICAgIHZhciByb290LCB4bWw7CgogICAgaWYgKHdpbmRvdy5ET01QYXJzZXIpIHsgLy8gU3RhbmRhcmQgSUU5ICsgZXZlcnlvbmUgZWxzZQogICAgICAgIHhtbCA9IChuZXcgRE9NUGFyc2VyKCkpLnBhcnNlRnJvbVN0cmluZyh4bWxTdHJpbmcsICJ0ZXh0L3htbCIpOwogICAgfSBlbHNlIHsgLy8gPD0gSUU4CiAgICAgICAgeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKICAgICAgICB4bWwuYXN5bmMgPSAiZmFsc2UiOwogICAgICAgIHhtbC5sb2FkWE1MKHhtbFN0cmluZyk7CgogICAgICAgIHNoaW1YTUxGb3JJRTgoeG1sKTsKICAgIH0KCiAgICByb290ID0geG1sLmRvY3VtZW50RWxlbWVudDsKCiAgICBpZiAoIXJvb3QgfHwgIXJvb3Qubm9kZU5hbWUgfHwgcm9vdC5ub2RlTmFtZSA9PT0gInBhcnNlcmVycm9yIikgewogICAgICAgIC8vIEJhZGx5IGZvcm1lZCBYTUwKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZXR1cm4geG1sOwp9OwoKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKLypqc2hpbnQgYnJvd3Nlcjp0cnVlLCBzbWFydHRhYnM6dHJ1ZSovCgovLyB0Yl9yZXF1aXJlKCcuLi9oZWxwZXJzLmpzJykKCihmdW5jdGlvbih3aW5kb3csIE9USGVscGVycywgdW5kZWZpbmVkKSB7CgpPVEhlbHBlcnMudXNlTG9nSGVscGVycyA9IGZ1bmN0aW9uKG9uKXsKCiAgICAvLyBMb2cgbGV2ZWxzIGZvciBPVExvZy5zZXRMb2dMZXZlbAogICAgb24uREVCVUcgICAgPSA1OwogICAgb24uTE9HICAgICAgPSA0OwogICAgb24uSU5GTyAgICAgPSAzOwogICAgb24uV0FSTiAgICAgPSAyOwogICAgb24uRVJST1IgICAgPSAxOwogICAgb24uTk9ORSAgICAgPSAwOwoKICAgIHZhciBfbG9nTGV2ZWwgPSBvbi5OT05FLAogICAgICAgIF9sb2dzID0gW107CgogICAgLy8gR2VuZXJhdGVzIGEgbG9nZ2luZyBtZXRob2QgZm9yIGEgcGFydGljdWxhciBtZXRob2QgYW5kIGxvZyBsZXZlbC4KICAgIC8vCiAgICAvLyBBdHRlbXB0cyB0byBoYW5kbGUgdGhlIGZvbGxvd2luZyBjYXNlczoKICAgIC8vICogdGhlIGRlc2lyZWQgbG9nIG1ldGhvZCBkb2Vzbid0IGV4aXN0LCBjYWxsIGZhbGxiYWNrIChpZiBhdmFpbGFibGUpIGluc3RlYWQKICAgIC8vICogdGhlIGNvbnNvbGUgZnVuY3Rpb25hbGl0eSBpc24ndCBhdmFpbGFibGUgYmVjYXVzZSB0aGUgZGV2ZWxvcGVyIHRvb2xzIChpbiBJRSkKICAgIC8vIGFyZW4ndCBvcGVuLCBjYWxsIGZhbGxiYWNrIChpZiBhdmFpbGFibGUpCiAgICAvLyAqIGF0dGVtcHQgdG8gZGVhbCB3aXRoIHdlaXJkIElFIGhvc3RlZCBsb2dnaW5nIG1ldGhvZHMgYXMgYmVzdCB3ZSBjYW4uCiAgICAvLwogICAgZnVuY3Rpb24gZ2VuZXJhdGVMb2dnaW5nTWV0aG9kKG1ldGhvZCwgbGV2ZWwsIGZhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAob24uc2hvdWxkTG9nKGxldmVsKSkgewogICAgICAgICAgICAgICAgdmFyIGNvbnMgPSB3aW5kb3cuY29uc29sZTsKCiAgICAgICAgICAgICAgICAvLyBJbiBJRSwgd2luZG93LmNvbnNvbGUgbWF5IG5vdCBleGlzdCBpZiB0aGUgZGV2ZWxvcGVyIHRvb2xzIGFyZW4ndCBvcGVuCiAgICAgICAgICAgICAgICBpZiAoY29ucyAmJiBjb25zW21ldGhvZF0pIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgZGVzaXJlZCBjb25zb2xlIG1ldGhvZCBpc24ndCBhIHJlYWwgb2JqZWN0LCB3aGljaCBtZWFucwogICAgICAgICAgICAgICAgICAgIC8vIHRoYXQgd2UgY2FuJ3QgdXNlIGFwcGx5IG9uIGl0LiBXZSBmb3JjZSBpdCB0byBiZSBhIHJlYWwgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgLy8gdXNpbmcgRnVuY3Rpb24uYmluZCwgYXNzdW1pbmcgdGhhdCdzIGF2YWlsYWJsZS4KICAgICAgICAgICAgICAgICAgICBpZiAoY29uc1ttZXRob2RdLmFwcGx5IHx8IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29uc1ttZXRob2RdLmFwcGx5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zW21ldGhvZF0gPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNbbWV0aG9kXSwgY29ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNbbWV0aG9kXS5hcHBseShjb25zLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpc24ndCB0aGUgc2FtZSByZXN1bHQgYXMgdGhlIGFib3ZlLCBidXQgaXQncyBiZXR0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhhbiBub3RoaW5nLgogICAgICAgICAgICAgICAgICAgICAgICBjb25zW21ldGhvZF0oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKS5qb2luKCcgJykKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChmYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrLmFwcGx5KG9uLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGFwcGVuZFRvTG9ncyhtZXRob2QsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKCiAgICBvbi5sb2cgPSBnZW5lcmF0ZUxvZ2dpbmdNZXRob2QoJ2xvZycsIG9uLkxPRyk7CgogICAgLy8gR2VuZXJhdGUgZGVidWcsIGluZm8sIHdhcm4sIGFuZCBlcnJvciBsb2dnaW5nIG1ldGhvZHMsIHRoZXNlIGFsbCBmYWxsYmFjayB0byBvbi5sb2cKICAgIG9uLmRlYnVnID0gZ2VuZXJhdGVMb2dnaW5nTWV0aG9kKCdkZWJ1ZycsIG9uLkRFQlVHLCBvbi5sb2cpOwogICAgb24uaW5mbyA9IGdlbmVyYXRlTG9nZ2luZ01ldGhvZCgnaW5mbycsIG9uLklORk8sIG9uLmxvZyk7CiAgICBvbi53YXJuID0gZ2VuZXJhdGVMb2dnaW5nTWV0aG9kKCd3YXJuJywgb24uV0FSTiwgb24ubG9nKTsKICAgIG9uLmVycm9yID0gZ2VuZXJhdGVMb2dnaW5nTWV0aG9kKCdlcnJvcicsIG9uLkVSUk9SLCBvbi5sb2cpOwoKCiAgICBvbi5zZXRMb2dMZXZlbCA9IGZ1bmN0aW9uKGxldmVsKSB7CiAgICAgICAgX2xvZ0xldmVsID0gdHlwZW9mKGxldmVsKSA9PT0gJ251bWJlcicgPyBsZXZlbCA6IDA7CiAgICAgICAgb24uZGVidWcoIlRCLnNldExvZ0xldmVsKCIgKyBfbG9nTGV2ZWwgKyAiKSIpOwogICAgICAgIHJldHVybiBfbG9nTGV2ZWw7CiAgICB9OwoKICAgIG9uLmdldExvZ3MgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gX2xvZ3M7CiAgICB9OwoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbGV2ZWwgaXMgdmlzaWJsZSBnaXZlbiB0aGUgY3VycmVudCBsb2dMZXZlbC4KICAgIG9uLnNob3VsZExvZyA9IGZ1bmN0aW9uKGxldmVsKSB7CiAgICAgICAgcmV0dXJuIF9sb2dMZXZlbCA+PSBsZXZlbDsKICAgIH07CgogICAgLy8gRm9ybWF0IHRoZSBjdXJyZW50IHRpbWUgbmljZWx5IGZvciBsb2dnaW5nLiBSZXR1cm5zIHRoZSBjdXJyZW50CiAgICAvLyBsb2NhbCB0aW1lLgogICAgZnVuY3Rpb24gZm9ybWF0RGF0ZVN0YW1wKCkgewogICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogICAgICAgIHJldHVybiBub3cudG9Mb2NhbGVUaW1lU3RyaW5nKCkgKyBub3cuZ2V0TWlsbGlzZWNvbmRzKCk7CiAgICB9CgoKICAgIC8vIEFwcGVuZCArYXJncysgdG8gbG9ncywgYWxvbmcgd2l0aCB0aGUgY3VycmVudCBsb2cgbGV2ZWwgYW5kIHRoZSBhIGRhdGUgc3RhbXAuCiAgICBmdW5jdGlvbiBhcHBlbmRUb0xvZ3MobGV2ZWwsIGFyZ3MpIHsKICAgICAgICBpZiAoIWFyZ3MpIHJldHVybjsKCiAgICAgICAgdmFyIG1lc3NhZ2U7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShhcmdzKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgbWVzc2FnZSA9IGFyZ3MudG9TdHJpbmcoKTsKICAgICAgICB9CgogICAgICAgIGlmIChtZXNzYWdlLmxlbmd0aCA8PSAyKSByZXR1cm47CgogICAgICAgIF9sb2dzLnB1c2goCiAgICAgICAgICAgIFtsZXZlbCwgZm9ybWF0RGF0ZVN0YW1wKCksIG1lc3NhZ2VdCiAgICAgICAgKTsKICAgIH0KCn07CgpPVEhlbHBlcnMudXNlTG9nSGVscGVycyhPVEhlbHBlcnMpOwpPVEhlbHBlcnMuc2V0TG9nTGV2ZWwoT1RIZWxwZXJzLkVSUk9SKTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7Ci8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKT1RIZWxwZXJzLmNhc3RUb0Jvb2xlYW4gPSBmdW5jdGlvbih2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIHJldHVybiB2YWx1ZSA9PT0gJ3RydWUnIHx8IHZhbHVlID09PSB0cnVlOwp9OwoKT1RIZWxwZXJzLnJvdW5kRmxvYXQgPSBmdW5jdGlvbih2YWx1ZSwgcGxhY2VzKSB7CiAgICByZXR1cm4gcGFyc2VJbnQoTWF0aC5yb3VuZCh2YWx1ZSpNYXRoLnBvdygxMCwgcGxhY2VzKSksIDEwKS9NYXRoLnBvdygxMCwgcGxhY2VzKTsKfTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7Ci8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCi8vIHRiX3JlcXVpcmUoJy4uL3ZlbmRvci91dWlkLmpzJykKCihmdW5jdGlvbih3aW5kb3csIE9USGVscGVycywgdW5kZWZpbmVkKSB7Cgp2YXIgdGltZW91dHMgPSBbXSwKICAgIG1lc3NhZ2VOYW1lID0gIk9USGVscGVycy4iICsgT1RIZWxwZXJzLnV1aWQudjQoKSArICIuemVyby10aW1lb3V0IjsKCnZhciBoYW5kbGVNZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIGlmIChldmVudC5zb3VyY2UgPT0gd2luZG93ICYmIGV2ZW50LmRhdGEgPT0gbWVzc2FnZU5hbWUpIHsKICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICBpZiAodGltZW91dHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHRpbWVvdXRzLnNoaWZ0KCksCiAgICAgICAgICAgICAgICBmbiA9IGFyZ3Muc2hpZnQoKTsKCiAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIH0KICAgIH0KfTsKCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgaGFuZGxlTWVzc2FnZSwgdHJ1ZSk7CgovLyBDYWxscyB0aGUgZnVuY3Rpb24gK2ZuKyBhc3luY2hyb25vdXNseSB3aXRoIHRoZSBjdXJyZW50IGV4ZWN1dGlvbi4KLy8gVGhpcyBpcyBtb3N0IGNvbW1vbmx5IHVzZWQgdG8gZXhlY3V0ZSBzb21ldGhpbmcgc3RyYWlnaHQgYWZ0ZXIKLy8gdGhlIGN1cnJlbnQgZnVuY3Rpb24uCi8vCi8vIEFueSBhcmd1bWVudHMgaW4gYWRkaXRpb24gdG8gK2ZuKyB3aWxsIGJlIHBhc3NlZCB0byArZm4rIHdoZW4gaXQncwovLyBjYWxsZWQuCi8vCi8vIFlvdSB3b3VsZCB1c2UgdGhpcyBpbnBsYWNlIG9mIHNldFRpbWVvdXQoZm4sIDApIHR5cGUgY29uc3RydWN0cy4gY2FsbEFzeW5jCi8vIGlzIHByZWZlcmFibGUgYXMgaXQgZXhlY3V0ZXMgaW4gYSBtdWNoIG1vcmUgcHJlZGljdGFibGUgdGltZSB3aW5kb3csCi8vIHVubGlrZSBzZXRUaW1lb3V0IHdoaWNoIGNvdWxkIGV4ZWN1dGUgYW55d2hlcmUgZnJvbSAybXMgdG8gc2V2ZXJhbCB0aG91c2FuZAovLyBkZXBlbmRpbmcgb24gdGhlIGJyb3dzZXIvY29udGV4dC4KLy8KT1RIZWxwZXJzLmNhbGxBc3luYyA9IGZ1bmN0aW9uICgvKiBmbiwgW2FyZzEsIGFyZzIsIC4uLiwgYXJnTl0gKi8pIHsKICAgIHRpbWVvdXRzLnB1c2goQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSk7CiAgICB3aW5kb3cucG9zdE1lc3NhZ2UobWVzc2FnZU5hbWUsICIqIik7Cn07CgoKLy8gV3JhcHMgK2hhbmRsZXIrIGluIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGV4ZWN1dGUgaXQgYXN5bmNocm9ub3VzbHkKLy8gc28gdGhhdCBpdCBkb2Vzbid0IGludGVyZmVyZSB3aXRoIGl0J3MgZXhjZXV0aW9uIGNvbnRleHQgaWYgaXQgcmFpc2VzCi8vIGFuIGV4Y2VwdGlvbi4KT1RIZWxwZXJzLmNyZWF0ZUFzeW5jSGFuZGxlciA9IGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgogICAgICAgIE9USGVscGVycy5jYWxsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICBoYW5kbGVyLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIH0pOwogICAgfTsKfTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7Ci8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwovKmdsb2JhbCBqYXNtaW5lOnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vLi4vaGVscGVycy5qcycpCi8vIHRiX3JlcXVpcmUoJy4uL2NhbGxiYWNrcy5qcycpCgoKKGZ1bmN0aW9uKHdpbmRvdywgT1RIZWxwZXJzLCB1bmRlZmluZWQpIHsKCi8qKgoqIFRoaXMgYmFzZSBjbGFzcyBkZWZpbmVzIHRoZSA8Y29kZT5hZGRFdmVudExpc3RlbmVyKCk8L2NvZGU+IGFuZCA8Y29kZT5yZW1vdmVFdmVudExpc3RuZXIoKTwvY29kZT4gbWV0aG9kcyBvZiBvYmplY3RzCiogdGhhdCBjYW4gZGlzcGF0Y2ggZXZlbnRzLgoqCiogQGNsYXNzIEV2ZW50RGlzcGF0Y2hlcgoqLwpPVEhlbHBlcnMuZXZlbnRpbmcgPSBmdW5jdGlvbihzZWxmLCBzeW5jcm9ub3VzKSB7CiAgdmFyIF9ldmVudHMgPSB7fTsKCgogIC8vIENhbGwgdGhlIGRlZmF1bHRBY3Rpb24sIHBhc3NpbmcgYXJncwogIGZ1bmN0aW9uIGV4ZWN1dGVEZWZhdWx0QWN0aW9uKGRlZmF1bHRBY3Rpb24sIGFyZ3MpIHsKICAgIGlmICghZGVmYXVsdEFjdGlvbikgcmV0dXJuOwoKICAgIGRlZmF1bHRBY3Rpb24uYXBwbHkobnVsbCwgYXJncy5zbGljZSgpKTsKICB9CgogIC8vIEV4ZWN1dGUgZWFjaCBoYW5kbGVyIGluICtsaXN0ZW5lcnMrIHdpdGggK2FyZ3MrLgogIC8vCiAgLy8gRWFjaCBoYW5kbGVyIHdpbGwgYmUgZXhlY3V0ZWQgYXN5bmMuIE9uIGNvbXBsZXRpb24gdGhlIGRlZmF1bHRBY3Rpb24KICAvLyBoYW5kbGVyIHdpbGwgYmUgZXhlY3V0ZWQgd2l0aCB0aGUgYXJncy4KICAvLwogIC8vIEBwYXJhbSBbQXJyYXldIGxpc3RlbmVycwogIC8vICAgIEFuIGFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlLiBFYWNoIHdpbGwgYmUgcGFzc2VkIGFyZ3MuCiAgLy8KICAvLyBAcGFyYW0gW0FycmF5XSBhcmdzCiAgLy8gICAgQW4gYXJyYXkgb2YgYXJndW1lbnRzIHRvIGV4ZWN1dGUgZWFjaCBmdW5jdGlvbiBpbiAgK2xpc3RlbmVycysgd2l0aC4KICAvLwogIC8vIEBwYXJhbSBbU3RyaW5nXSBuYW1lCiAgLy8gICAgVGhlIG5hbWUgb2YgdGhpcyBldmVudC4KICAvLwogIC8vIEBwYXJhbSBbRnVuY3Rpb24sIE51bGwsIFVuZGVmaW5lZF0gZGVmYXVsdEFjdGlvbgogIC8vICAgIEFuIG9wdGlvbmFsIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgYWZ0ZXIgZXZlcnkgb3RoZXIgaGFuZGxlci4gVGhpcyB3aWxsIGV4ZWN1dGUgZXZlbgogIC8vICAgIGlmICtsaXN0ZW5lcnMrIGlzIGVtcHR5LiArZGVmYXVsdEFjdGlvbisgd2lsbCBiZSBwYXNzZWQgYXJncyBhcyBhIG5vcm1hbAogIC8vICAgIGhhbmRsZXIgd291bGQuCiAgLy8KICAvLyBAcmV0dXJuIFVuZGVmaW5lZAogIC8vCiAgZnVuY3Rpb24gZXhlY3V0ZUxpc3RlbmVyc0FzeW5jcm9ub3VzbHkobmFtZSwgYXJncywgZGVmYXVsdEFjdGlvbikgewogICAgdmFyIGxpc3RlbmVycyA9IF9ldmVudHNbbmFtZV07CiAgICBpZiAoIWxpc3RlbmVycyB8fCBsaXN0ZW5lcnMubGVuZ3RoID09PSAwKSByZXR1cm47CgogICAgdmFyIGxpc3RlbmVyQWNrcyA9IGxpc3RlbmVycy5sZW5ndGg7CgogICAgbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24obGlzdGVuZXIpIHsgLy8gLCBpbmRleAogICAgICBmdW5jdGlvbiBmaWx0ZXJIYW5kbGVyQW5kQ29udGV4dChfbGlzdGVuZXIpIHsKICAgICAgICByZXR1cm4gX2xpc3RlbmVyLmNvbnRleHQgPT09IGxpc3RlbmVyLmNvbnRleHQgJiYgX2xpc3RlbmVyLmhhbmRsZXIgPT09IGxpc3RlbmVyLmhhbmRsZXI7CiAgICAgIH0KCiAgICAgIC8vIFdlIHJ1biB0aGlzIGFzeW5jaHJvbm91c2x5IHNvIHRoYXQgaXQgZG9lc24ndCBpbnRlcmZlcmUgd2l0aCBleGVjdXRpb24gaWYgYW4gZXJyb3IgaGFwcGVucwogICAgICBPVEhlbHBlcnMuY2FsbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAvLyBoYXZlIHRvIGNoZWNrIGlmIHRoZSBsaXN0ZW5lciBoYXMgbm90IGJlZW4gcmVtb3ZlZAogICAgICAgICAgaWYgKF9ldmVudHNbbmFtZV0gJiYgX2V2ZW50c1tuYW1lXS5zb21lKGZpbHRlckhhbmRsZXJBbmRDb250ZXh0KSkgewogICAgICAgICAgICAobGlzdGVuZXIuY2xvc3VyZSB8fCBsaXN0ZW5lci5oYW5kbGVyKS5hcHBseShsaXN0ZW5lci5jb250ZXh0IHx8IG51bGwsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgIGxpc3RlbmVyQWNrcy0tOwoKICAgICAgICAgIGlmIChsaXN0ZW5lckFja3MgPT09IDApIHsKICAgICAgICAgICAgZXhlY3V0ZURlZmF1bHRBY3Rpb24oZGVmYXVsdEFjdGlvbiwgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0KCgogIC8vIFRoaXMgaXMgaWRlbnRpY2FsIHRvIGV4ZWN1dGVMaXN0ZW5lcnNBc3luY3Jvbm91c2x5IGV4Y2VwdCB0aGF0IGhhbmRsZXJzIHdpbGwKICAvLyBiZSBleGVjdXRlZCBzeW5jcm9ub3VzbHkuCiAgLy8KICAvLyBPbiBjb21wbGV0aW9uIHRoZSBkZWZhdWx0QWN0aW9uIGhhbmRsZXIgd2lsbCBiZSBleGVjdXRlZCB3aXRoIHRoZSBhcmdzLgogIC8vCiAgLy8gQHBhcmFtIFtBcnJheV0gbGlzdGVuZXJzCiAgLy8gICAgQW4gYXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUuIEVhY2ggd2lsbCBiZSBwYXNzZWQgYXJncy4KICAvLwogIC8vIEBwYXJhbSBbQXJyYXldIGFyZ3MKICAvLyAgICBBbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gZXhlY3V0ZSBlYWNoIGZ1bmN0aW9uIGluICArbGlzdGVuZXJzKyB3aXRoLgogIC8vCiAgLy8gQHBhcmFtIFtTdHJpbmddIG5hbWUKICAvLyAgICBUaGUgbmFtZSBvZiB0aGlzIGV2ZW50LgogIC8vCiAgLy8gQHBhcmFtIFtGdW5jdGlvbiwgTnVsbCwgVW5kZWZpbmVkXSBkZWZhdWx0QWN0aW9uCiAgLy8gICAgQW4gb3B0aW9uYWwgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBldmVyeSBvdGhlciBoYW5kbGVyLiBUaGlzIHdpbGwgZXhlY3V0ZSBldmVuCiAgLy8gICAgaWYgK2xpc3RlbmVycysgaXMgZW1wdHkuICtkZWZhdWx0QWN0aW9uKyB3aWxsIGJlIHBhc3NlZCBhcmdzIGFzIGEgbm9ybWFsCiAgLy8gICAgaGFuZGxlciB3b3VsZC4KICAvLwogIC8vIEByZXR1cm4gVW5kZWZpbmVkCiAgLy8KICBmdW5jdGlvbiBleGVjdXRlTGlzdGVuZXJzU3luY3Jvbm91c2x5KG5hbWUsIGFyZ3MpIHsgLy8gZGVmYXVsdEFjdGlvbiBpcyBub3QgdXNlZAogICAgdmFyIGxpc3RlbmVycyA9IF9ldmVudHNbbmFtZV07CiAgICBpZiAoIWxpc3RlbmVycyB8fCBsaXN0ZW5lcnMubGVuZ3RoID09PSAwKSByZXR1cm47CgogICAgbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24obGlzdGVuZXIpIHsgLy8gaW5kZXgKICAgICAgKGxpc3RlbmVyLmNsb3N1cmUgfHwgbGlzdGVuZXIuaGFuZGxlcikuYXBwbHkobGlzdGVuZXIuY29udGV4dCB8fCBudWxsLCBhcmdzKTsKICAgIH0pOwogIH0KCiAgdmFyIGV4ZWN1dGVMaXN0ZW5lcnMgPSBzeW5jcm9ub3VzID09PSB0cnVlID8gZXhlY3V0ZUxpc3RlbmVyc1N5bmNyb25vdXNseSA6IGV4ZWN1dGVMaXN0ZW5lcnNBc3luY3Jvbm91c2x5OwoKCiAgdmFyIHJlbW92ZUFsbExpc3RlbmVyc05hbWVkID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGV4dCkgewogICAgaWYgKF9ldmVudHNbZXZlbnROYW1lXSkgewogICAgICBpZiAoY29udGV4dCkgewogICAgICAgIC8vIFdlIGFyZSByZW1vdmluZyBieSBjb250ZXh0LCBnZXQgb25seSBldmVudHMgdGhhdCBkb24ndAogICAgICAgIC8vIG1hdGNoIHRoYXQgY29udGV4dAogICAgICAgIF9ldmVudHNbZXZlbnROYW1lXSA9IF9ldmVudHNbZXZlbnROYW1lXS5maWx0ZXIoZnVuY3Rpb24obGlzdGVuZXIpewogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyLmNvbnRleHQgIT09IGNvbnRleHQ7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgZGVsZXRlIF9ldmVudHNbZXZlbnROYW1lXTsKICAgICAgfQogICAgfQogIH07CgogIHZhciBhZGRMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoZXZlbnROYW1lcywgaGFuZGxlciwgY29udGV4dCwgY2xvc3VyZSkgewogICAgdmFyIGxpc3RlbmVyID0ge2hhbmRsZXI6IGhhbmRsZXJ9OwogICAgaWYgKGNvbnRleHQpIGxpc3RlbmVyLmNvbnRleHQgPSBjb250ZXh0OwogICAgaWYgKGNsb3N1cmUpIGxpc3RlbmVyLmNsb3N1cmUgPSBjbG9zdXJlOwoKICAgIGV2ZW50TmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghX2V2ZW50c1tuYW1lXSkgX2V2ZW50c1tuYW1lXSA9IFtdOwogICAgICBfZXZlbnRzW25hbWVdLnB1c2gobGlzdGVuZXIpOwogICAgfSk7CiAgfS5iaW5kKHNlbGYpOwoKCiAgdmFyIHJlbW92ZUxpc3RlbmVycyA9IGZ1bmN0aW9uIChldmVudE5hbWVzLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICBmdW5jdGlvbiBmaWx0ZXJIYW5kbGVyQW5kQ29udGV4dChsaXN0ZW5lcikgewogICAgICByZXR1cm4gIShsaXN0ZW5lci5oYW5kbGVyID09PSBoYW5kbGVyICYmIGxpc3RlbmVyLmNvbnRleHQgPT09IGNvbnRleHQpOwogICAgfQoKICAgIGV2ZW50TmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmIChfZXZlbnRzW25hbWVdKSB7CiAgICAgICAgX2V2ZW50c1tuYW1lXSA9IF9ldmVudHNbbmFtZV0uZmlsdGVyKGZpbHRlckhhbmRsZXJBbmRDb250ZXh0KTsKICAgICAgICBpZiAoX2V2ZW50c1tuYW1lXS5sZW5ndGggPT09IDApIGRlbGV0ZSBfZXZlbnRzW25hbWVdOwogICAgICB9CiAgICB9KTsKICB9LmJpbmQoc2VsZik7CgoKICAvLyBFeGVjdXRlIGFueSBsaXN0ZW5lcnMgYm91bmQgdG8gdGhlICtldmVudCsgRXZlbnQuCiAgLy8KICAvLyBFYWNoIGhhbmRsZXIgd2lsbCBiZSBleGVjdXRlZCBhc3luYy4gT24gY29tcGxldGlvbiB0aGUgZGVmYXVsdEFjdGlvbgogIC8vIGhhbmRsZXIgd2lsbCBiZSBleGVjdXRlZCB3aXRoIHRoZSBhcmdzLgogIC8vCiAgLy8gQHBhcmFtIFtFdmVudF0gZXZlbnQKICAvLyAgICBBbiBFdmVudCBvYmplY3QuCiAgLy8KICAvLyBAcGFyYW0gW0Z1bmN0aW9uLCBOdWxsLCBVbmRlZmluZWRdIGRlZmF1bHRBY3Rpb24KICAvLyAgICBBbiBvcHRpb25hbCBmdW5jdGlvbiB0byBleGVjdXRlIGFmdGVyIGV2ZXJ5IG90aGVyIGhhbmRsZXIuIFRoaXMgd2lsbCBleGVjdXRlIGV2ZW4KICAvLyAgICBpZiB0aGVyZSBhcmUgbGlzdGVuZXJzIGJvdW5kIHRvIHRoaXMgZXZlbnQuICtkZWZhdWx0QWN0aW9uKyB3aWxsIGJlIHBhc3NlZAogIC8vICAgIGFyZ3MgYXMgYSBub3JtYWwgaGFuZGxlciB3b3VsZC4KICAvLwogIC8vIEByZXR1cm4gdGhpcwogIC8vCiAgc2VsZi5kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oZXZlbnQsIGRlZmF1bHRBY3Rpb24pIHsKICAgIGlmICghZXZlbnQudHlwZSkgewogICAgICBPVEhlbHBlcnMuZXJyb3IoIk9USGVscGVycy5FdmVudGluZy5kaXNwYXRjaEV2ZW50OiBFdmVudCBoYXMgbm8gdHlwZSIpOwogICAgICBPVEhlbHBlcnMuZXJyb3IoZXZlbnQpOwoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJPVEhlbHBlcnMuRXZlbnRpbmcuZGlzcGF0Y2hFdmVudDogRXZlbnQgaGFzIG5vIHR5cGUiKTsKICAgIH0KCiAgICBpZiAoIWV2ZW50LnRhcmdldCkgewogICAgICBldmVudC50YXJnZXQgPSB0aGlzOwogICAgfQoKICAgIGlmICghX2V2ZW50c1tldmVudC50eXBlXSB8fCBfZXZlbnRzW2V2ZW50LnR5cGVdLmxlbmd0aCA9PT0gMCkgewogICAgICBleGVjdXRlRGVmYXVsdEFjdGlvbihkZWZhdWx0QWN0aW9uLCBbZXZlbnRdKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGV4ZWN1dGVMaXN0ZW5lcnMoZXZlbnQudHlwZSwgW2V2ZW50XSwgZGVmYXVsdEFjdGlvbik7CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gRXhlY3V0ZSBlYWNoIGhhbmRsZXIgZm9yIHRoZSBldmVudCBjYWxsZWQgK25hbWUrLgogIC8vCiAgLy8gRWFjaCBoYW5kbGVyIHdpbGwgYmUgZXhlY3V0ZWQgYXN5bmMsIGFuZCBhbnkgZXhjZXB0aW9ucyB0aGF0IHRoZXkgdGhyb3cgd2lsbAogIC8vIGJlIGNhdWdodCBhbmQgbG9nZ2VkCiAgLy8KICAvLyBIb3cgdG8gcGFzcyB0aGVzZT8KICAvLyAgKiBkZWZhdWx0QWN0aW9uCiAgLy8KICAvLyBAZXhhbXBsZQogIC8vICBmb28ub24oJ2JhcicsIGZ1bmN0aW9uKG5hbWUsIG1lc3NhZ2UpIHsKICAvLyAgICBhbGVydCgiSGVsbG8gIiArIG5hbWUgKyAiOiAiICsgbWVzc2FnZSk7CiAgLy8gIH0pOwogIC8vCiAgLy8gIGZvby50cmlnZ2VyKCdPcGVuVG9rJywgJ2FzZGYnKTsgICAgIC8vIC0+IEhlbGxvIE9wZW5Ub2s6IGFzZGYKICAvLwogIC8vCiAgLy8gQHBhcmFtIFtTdHJpbmddIGV2ZW50TmFtZQogIC8vICAgIFRoZSBuYW1lIG9mIHRoaXMgZXZlbnQuCiAgLy8KICAvLyBAcGFyYW0gW0FycmF5XSBhcmd1bWVudHMKICAvLyAgICBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgYmV5b25kICtldmVudE5hbWUrIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBoYW5kbGVycy4KICAvLwogIC8vIEByZXR1cm4gdGhpcwogIC8vCiAgc2VsZi50cmlnZ2VyID0gZnVuY3Rpb24oZXZlbnROYW1lKSB7CiAgICBpZiAoIV9ldmVudHNbZXZlbnROYW1lXSB8fCBfZXZlbnRzW2V2ZW50TmFtZV0ubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgogICAgLy8gUmVtb3ZlIHRoZSBldmVudE5hbWUgYXJnCiAgICBhcmdzLnNoaWZ0KCk7CgogICAgZXhlY3V0ZUxpc3RlbmVycyhldmVudE5hbWUsIGFyZ3MpOwoKICAgIHJldHVybiB0aGlzOwogIH07CgogIHNlbGYub24gPSBmdW5jdGlvbihldmVudE5hbWVzLCBoYW5kbGVyX29yX2NvbnRleHQsIGNvbnRleHQpIHsKICAgIGlmICh0eXBlb2YoZXZlbnROYW1lcykgPT09ICJzdHJpbmciICYmIGhhbmRsZXJfb3JfY29udGV4dCkgewogICAgICBhZGRMaXN0ZW5lcnMoZXZlbnROYW1lcy5zcGxpdCgnICcpLCBoYW5kbGVyX29yX2NvbnRleHQsIGNvbnRleHQpOwogICAgfQogICAgZWxzZSB7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnROYW1lcykgewogICAgICAgIGlmIChldmVudE5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICBhZGRMaXN0ZW5lcnMoW25hbWVdLCBldmVudE5hbWVzW25hbWVdLCBoYW5kbGVyX29yX2NvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH07Cgogc2VsZi5vZmYgPSBmdW5jdGlvbihldmVudE5hbWVzLCBoYW5kbGVyX29yX2NvbnRleHQsIGNvbnRleHQpIHsKICAgIGlmICh0eXBlb2YoZXZlbnROYW1lcykgPT09ICJzdHJpbmciKSB7CiAgICAgIGlmIChoYW5kbGVyX29yX2NvbnRleHQgJiYgT1RIZWxwZXJzLmlzRnVuY3Rpb24oaGFuZGxlcl9vcl9jb250ZXh0KSkgewogICAgICAgIHJlbW92ZUxpc3RlbmVycyhldmVudE5hbWVzLnNwbGl0KCcgJyksIGhhbmRsZXJfb3JfY29udGV4dCwgY29udGV4dCk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgZXZlbnROYW1lcy5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmVtb3ZlQWxsTGlzdGVuZXJzTmFtZWQobmFtZSwgaGFuZGxlcl9vcl9jb250ZXh0KTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfQogICAgfQogICAgZWxzZSBpZiAoIWV2ZW50TmFtZXMpIHsKICAgICAgLy8gcmVtb3ZlIGFsbCBib3VuZCBldmVudHMKICAgICAgX2V2ZW50cyA9IHt9OwogICAgfQogICAgZWxzZSB7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnROYW1lcykgewogICAgICAgIGlmIChldmVudE5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICByZW1vdmVMaXN0ZW5lcnMoW25hbWVdLCBldmVudE5hbWVzW25hbWVdLCBoYW5kbGVyX29yX2NvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH07CgoKICBzZWxmLm9uY2UgPSBmdW5jdGlvbihldmVudE5hbWVzLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICB2YXIgbmFtZXMgPSBldmVudE5hbWVzLnNwbGl0KCcgJyksCiAgICAgICAgZnVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gaGFuZGxlci5hcHBseShjb250ZXh0IHx8IG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICByZW1vdmVMaXN0ZW5lcnMobmFtZXMsIGhhbmRsZXIsIGNvbnRleHQpOwoKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfS5iaW5kKHRoaXMpOwoKICAgIGFkZExpc3RlbmVycyhuYW1lcywgaGFuZGxlciwgY29udGV4dCwgZnVuKTsKICAgIHJldHVybiB0aGlzOwogIH07CgoKICAvKioKICAqIFRoaXMgbWV0aG9kIHJlZ2lzdGVycyBhIG1ldGhvZCBhcyBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBzcGVjaWZpYyBldmVudC4KICAqIDxwPgogICoKICAqIDxwPgogICogICBJZiBhIGhhbmRsZXIgaXMgbm90IHJlZ2lzdGVyZWQgZm9yIGFuIGV2ZW50LCB0aGUgZXZlbnQgaXMgaWdub3JlZCBsb2NhbGx5LiBJZiB0aGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gZG9lcyBub3QgZXhpc3QsCiAgKiAgIHRoZSBldmVudCBpcyBpZ25vcmVkIGxvY2FsbHkuCiAgKiA8L3A+CiAgKiA8cD4KICAqICAgVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZiB0aGUgPGNvZGU+bGlzdGVuZXI8L2NvZGU+IG5hbWUgaXMgaW52YWxpZC4KICAqIDwvcD4KICAqCiAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIGlkZW50aWZ5aW5nIHRoZSB0eXBlIG9mIGV2ZW50LgogICoKICAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIFRoZSBmdW5jdGlvbiB0byBiZSBpbnZva2VkIHdoZW4gdGhlIG9iamVjdCBkaXNwYXRjaGVzIHRoZSBldmVudC4KICAqCiAgKiBAbWVtYmVyT2YgRXZlbnREaXNwYXRjaGVyCiAgKiBAbWV0aG9kICNhZGRFdmVudExpc3RlbmVyCiAgKiBAc2VlIDxhIGhyZWY9IiNldmVudHMiPkV2ZW50czwvYT4KICAqLwogIC8vIFNlZSAnb24nIGZvciB1c2FnZS4KICAvLyBAZGVwcmVjaWF0ZWQgd2lsbCBiZWNvbWUgYSBwcml2YXRlIGhlbHBlciBmdW5jdGlvbiBpbiB0aGUgZnV0dXJlLgogIHNlbGYuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgYWRkTGlzdGVuZXJzKFtldmVudE5hbWVdLCBoYW5kbGVyLCBjb250ZXh0KTsKICB9OwoKCiAgLyoqCiAgKiBSZW1vdmVzIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIHNwZWNpZmljIGV2ZW50LgogICogPHA+CiAgKgogICogPHA+CiAgKiAgIFRocm93cyBhbiBleGNlcHRpb24gaWYgdGhlIDxjb2RlPmxpc3RlbmVyPC9jb2RlPiBuYW1lIGlzIGludmFsaWQuCiAgKiA8L3A+CiAgKgogICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHN0cmluZyBpZGVudGlmeWluZyB0aGUgdHlwZSBvZiBldmVudC4KICAqCiAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciBUaGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gdG8gcmVtb3ZlLgogICoKICAqIEBtZW1iZXJPZiBFdmVudERpc3BhdGNoZXIKICAqIEBtZXRob2QgI3JlbW92ZUV2ZW50TGlzdGVuZXIKICAqIEBzZWUgPGEgaHJlZj0iI2V2ZW50cyI+RXZlbnRzPC9hPgogICovCiAgLy8gU2VlICdvZmYnIGZvciB1c2FnZS4KICAvLyBAZGVwcmVjaWF0ZWQgd2lsbCBiZWNvbWUgYSBwcml2YXRlIGhlbHBlciBmdW5jdGlvbiBpbiB0aGUgZnV0dXJlLgogIHNlbGYucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgcmVtb3ZlTGlzdGVuZXJzKFtldmVudE5hbWVdLCBoYW5kbGVyLCBjb250ZXh0KTsKICB9OwoKCgoKCiAgcmV0dXJuIHNlbGY7Cn07CgpPVEhlbHBlcnMuZXZlbnRpbmcuRXZlbnQgPSBmdW5jdGlvbigpIHsKCiAgICByZXR1cm4gZnVuY3Rpb24gKHR5cGUsIGNhbmNlbGFibGUpIHsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMuY2FuY2VsYWJsZSA9IGNhbmNlbGFibGUgIT09IHVuZGVmaW5lZCA/IGNhbmNlbGFibGUgOiB0cnVlOwoKICAgICAgICB2YXIgX2RlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZSwKICAgICAgICAgICAgX3RhcmdldCA9IG51bGw7CgogICAgICAgIHRoaXMucHJldmVudERlZmF1bHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY2FuY2VsYWJsZSkgewogICAgICAgICAgICAgICAgX2RlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgT1RIZWxwZXJzLndhcm4oIkV2ZW50LnByZXZlbnREZWZhdWx0IDo6IFRyeWluZyB0byBwcmV2ZW50RGVmYXVsdCBvbiBhbiBFdmVudCB0aGF0IGlzbid0IGNhbmNlbGFibGUiKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBfZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICB9OwoKICAgICAgICBpZiAoT1RIZWxwZXJzLmNhbkRlZmluZVByb3BlcnR5KSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAndGFyZ2V0JywgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGFyZ2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKfTsKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKLypqc2hpbnQgYnJvd3Nlcjp0cnVlLCBzbWFydHRhYnM6dHJ1ZSovCgovLyB0Yl9yZXF1aXJlKCcuLi9oZWxwZXJzLmpzJykKLy8gdGJfcmVxdWlyZSgnLi9jYWxsYmFja3MuanMnKQoKLy8gRE9NIGhlbHBlcnMKKGZ1bmN0aW9uKHdpbmRvdywgT1RIZWxwZXJzLCB1bmRlZmluZWQpIHsKCi8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgY2xpZW50IHN1cHBvcnRzIGVsZW1lbnQuY2xhc3NMaXN0Ck9USGVscGVycy5zdXBwb3J0c0NsYXNzTGlzdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGhhc1N1cHBvcnQgPSB0eXBlb2YoZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiKSAmJiAoImNsYXNzTGlzdCIgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpKTsKICAgIE9USGVscGVycy5zdXBwb3J0c0NsYXNzTGlzdCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gaGFzU3VwcG9ydDsgfTsKCiAgICByZXR1cm4gaGFzU3VwcG9ydDsKfTsKCk9USGVscGVycy5yZW1vdmVFbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5wYXJlbnROb2RlKSB7CiAgICAgICAgZWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgfQp9OwoKT1RIZWxwZXJzLnJlbW92ZUVsZW1lbnRCeUlkID0gZnVuY3Rpb24oZWxlbWVudElkKSB7CiAgICB0aGlzLnJlbW92ZUVsZW1lbnQoT1RIZWxwZXJzKGVsZW1lbnRJZCkpOwp9OwoKT1RIZWxwZXJzLnJlbW92ZUVsZW1lbnRzQnlUeXBlID0gZnVuY3Rpb24ocGFyZW50RWxlbSwgdHlwZSkgewogICAgaWYgKCFwYXJlbnRFbGVtKSByZXR1cm47CgogICAgdmFyIGVsZW1lbnRzID0gcGFyZW50RWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0eXBlKTsKCiAgICAvLyBlbGVtZW50cyBpcyBhICJsaXZlIiBOb2Rlc0xpc3QgY29sbGVjdGlvbi4gTWVhbmluZyB0aGF0IHRoZSBjb2xsZWN0aW9uCiAgICAvLyBpdHNlbGYgd2lsbCBiZSBtdXRhdGVkIGFzIHdlIHJlbW92ZSBlbGVtZW50cyBmcm9tIHRoZSBET00uIFRoaXMgbWVhbnMKICAgIC8vIHRoYXQgIndoaWxlIHRoZXJlIGFyZSBzdGlsbCBlbGVtZW50cyIgaXMgc2FmZXIgdGhhbiAiaXRlcmF0ZSBvdmVyIGVhY2gKICAgIC8vIGVsZW1lbnQiIGFzIHRoZSBjb2xsZWN0aW9uIGxlbmd0aCBhbmQgdGhlIGVsZW1lbnRzIGluZGljZXMgd2lsbCBiZSBtb2RpZmllZAogICAgLy8gd2l0aCBlYWNoIGl0ZXJhdGlvbi4KICAgIHdoaWxlIChlbGVtZW50cy5sZW5ndGgpIHsKICAgICAgICBwYXJlbnRFbGVtLnJlbW92ZUNoaWxkKGVsZW1lbnRzWzBdKTsKICAgIH0KfTsKCk9USGVscGVycy5lbXB0eUVsZW1lbnQgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB3aGlsZSAoZWxlbWVudC5maXJzdENoaWxkKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVDaGlsZChlbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgfQogICAgcmV0dXJuIGVsZW1lbnQ7Cn07CgpPVEhlbHBlcnMuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uKG5vZGVOYW1lLCBhdHRyaWJ1dGVzLCBpbm5lckhUTUwpIHsKICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChub2RlTmFtZSk7CgogICAgaWYgKGF0dHJpYnV0ZXMpIHsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZihhdHRyaWJ1dGVzW25hbWVdKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIGlmICghZWxlbWVudFtuYW1lXSkgZWxlbWVudFtuYW1lXSA9IHt9OwoKICAgICAgICAgICAgICAgIHZhciBzdWJBdHRycyA9IGF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBuIGluIHN1YkF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtuYW1lXVtuXSA9IHN1YkF0dHJzW25dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKG5hbWUgPT09ICdjbGFzc05hbWUnKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCBhdHRyaWJ1dGVzW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAoaW5uZXJIVE1MKSB7CiAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBpbm5lckhUTUw7CiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnQ7Cn07CgpPVEhlbHBlcnMuY3JlYXRlQnV0dG9uID0gZnVuY3Rpb24oaW5uZXJIVE1MLCBhdHRyaWJ1dGVzLCBldmVudHMpIHsKICAgIHZhciBidXR0b24gPSBPVEhlbHBlcnMuY3JlYXRlRWxlbWVudCgnYnV0dG9uJywgYXR0cmlidXRlcywgaW5uZXJIVE1MKTsKCiAgICBpZiAoZXZlbnRzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBldmVudHMpIHsKICAgICAgICAgICAgaWYgKGV2ZW50cy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgT1RIZWxwZXJzLm9uKGJ1dHRvbiwgbmFtZSwgZXZlbnRzW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYnV0dG9uLl9ib3VuZEV2ZW50cyA9IGV2ZW50czsKICAgIH0KCiAgICByZXR1cm4gYnV0dG9uOwp9OwoKLy8gSGVscGVyIGZ1bmN0aW9uIGZvciBhZGRpbmcgZXZlbnQgbGlzdGVuZXJzIHRvIGRvbSBlbGVtZW50cy4KLy8gV0FSTklORzogVGhpcyBkb2Vzbid0IHByZXNlcnZlIGV2ZW50IHR5cGVzLCB5b3VyIGhhbmRsZXIgY291bGQgYmUgZ2V0dGluZyBhbGwga2luZHMgb2YgZGlmZmVyZW50Ci8vIHBhcmFtZXRlcnMgZGVwZW5kaW5nIG9uIHRoZSBicm93c2VyLiBZb3UgYWxzbyBtYXkgaGF2ZSBkaWZmZXJlbnQgc2NvcGVzIGRlcGVuZGluZyBvbiB0aGUgYnJvd3NlcgovLyBhbmQgYnViYmxpbmcgYW5kIGNhbmNlbGFibGUgYXJlIG5vdCBzdXBwb3J0ZWQuCk9USGVscGVycy5vbiA9IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50TmFtZSwgIGhhbmRsZXIpIHsKICAgIGlmIChlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBoYW5kbGVyLCBmYWxzZSk7CiAgICB9IGVsc2UgaWYgKGVsZW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIgKyBldmVudE5hbWUsIGhhbmRsZXIpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgb2xkSGFuZGxlciA9IGVsZW1lbnRbIm9uIitldmVudE5hbWVdOwogICAgICAgIGVsZW1lbnRbIm9uIitldmVudE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBoYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAob2xkSGFuZGxlcikgb2xkSGFuZGxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICB9Cn07CgovLyBIZWxwZXIgZnVuY3Rpb24gZm9yIHJlbW92aW5nIGV2ZW50IGxpc3RlbmVycyBmcm9tIGRvbSBlbGVtZW50cy4KT1RIZWxwZXJzLm9mZiA9IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgaWYgKGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciAoZXZlbnROYW1lLCBoYW5kbGVyLGZhbHNlKTsKICAgIH0KICAgIGVsc2UgaWYgKGVsZW1lbnQuZGV0YWNoRXZlbnQpIHsKICAgICAgICBlbGVtZW50LmRldGFjaEV2ZW50KCJvbiIgKyBldmVudE5hbWUsIGhhbmRsZXIpOwogICAgfQp9OwoKCi8vIERldGVjdHMgd2hlbiBhbiBlbGVtZW50IGlzIG5vdCBwYXJ0IG9mIHRoZSBkb2N1bWVudCBmbG93IGJlY2F1c2UgaXQgb3Igb25lIG9mIGl0J3MgYW5jZXN0ZXJzIGhhcyBkaXNwbGF5Om5vbmUuCk9USGVscGVycy5pc0Rpc3BsYXlOb25lID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgaWYgKCAoZWxlbWVudC5vZmZzZXRXaWR0aCA9PT0gMCB8fCBlbGVtZW50Lm9mZnNldEhlaWdodCA9PT0gMCkgJiYgT1RIZWxwZXJzLmNzcyhlbGVtZW50LCAnZGlzcGxheScpID09PSAnbm9uZScpIHJldHVybiB0cnVlOwogICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZSAmJiBlbGVtZW50LnBhcmVudE5vZGUuc3R5bGUpIHJldHVybiBPVEhlbHBlcnMuaXNEaXNwbGF5Tm9uZShlbGVtZW50LnBhcmVudE5vZGUpOwogICAgcmV0dXJuIGZhbHNlOwp9OwoKT1RIZWxwZXJzLmZpbmRFbGVtZW50V2l0aERpc3BsYXlOb25lID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgaWYgKCAoZWxlbWVudC5vZmZzZXRXaWR0aCA9PT0gMCB8fCBlbGVtZW50Lm9mZnNldEhlaWdodCA9PT0gMCkgJiYgT1RIZWxwZXJzLmNzcyhlbGVtZW50LCAnZGlzcGxheScpID09PSAnbm9uZScpIHJldHVybiBlbGVtZW50OwogICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZSAmJiBlbGVtZW50LnBhcmVudE5vZGUuc3R5bGUpIHJldHVybiBPVEhlbHBlcnMuZmluZEVsZW1lbnRXaXRoRGlzcGxheU5vbmUoZWxlbWVudC5wYXJlbnROb2RlKTsKICAgIHJldHVybiBudWxsOwp9OwoKZnVuY3Rpb24gb2JqZWN0SGFzUHJvcGVydGllcyhvYmopIHsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwp9CgoKLy8gQWxsb3dzIGFuICtvbkNoYW5nZSsgY2FsbGJhY2sgdG8gYmUgdHJpZ2dlcmVkIHdoZW4gc3BlY2lmaWMgc3R5bGUgcHJvcGVydGllcwovLyBvZiArZWxlbWVudCsgYXJlIG5vdGlmaWVkLiBUaGUgY2FsbGJhY2sgYWNjZXB0cyBhIHNpbmdsZSBwYXJhbWV0ZXIsIHdoaWNoIGlzCi8vIGEgaGFzaCB3aGVyZSB0aGUga2V5cyBhcmUgdGhlIHN0eWxlIHByb3BlcnR5IHRoYXQgY2hhbmdlZCBhbmQgdGhlIHZhbHVlcyBhcmUKLy8gYW4gYXJyYXkgY29udGFpbmluZyB0aGUgb2xkIGFuZCBuZXcgdmFsdWVzIChbb2xkVmFsdWUsIG5ld1ZhbHVlXSkuCi8vCi8vIFRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgTXV0YXRpb25PYnNlcnZlciBpdHNlbGYuIE9uY2UgeW91IG5vIGxvbmdlciB3aXNoCi8vIHRvIG9ic2VydmUgdGhlIGVsZW1lbnQgeW91IHNob3VsZCBjYWxsIGRpc2Nvbm5lY3Qgb24gdGhlIG9ic2VydmVyLgovLwovLyBPYnNlcnZpbmcgY2hhbmdlczoKLy8gIC8vIG9ic2VydmUgY2hhbmdpbmdzIHRvIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIG9iamVjdAovLyAgZGltZW5zaW9uc09ic2VydmVyID0gT1RIZWxwZXJzLm9ic2VydmVTdHlsZUNoYW5nZXMob2JqZWN0LCBbJ3dpZHRoJywgJ2hlaWdodCddLCBmdW5jdGlvbihjaGFuZ2VTZXQpIHsKLy8gICAgICBPVC5kZWJ1ZygiVGhlIG5ldyB3aWR0aCBhbmQgaGVpZ2h0IGFyZSAiICsgY2hhbmdlU2V0LndpZHRoWzFdICsgJywnICsgY2hhbmdlU2V0LmhlaWdodFsxXSk7Ci8vICB9KTsKLy8KLy8gQ2xlYW5pbmcgdXAKLy8gIC8vIHN0b3Agb2JzZXJ2aW5nIGNoYW5nZXMKLy8gIGRpbWVuc2lvbnNPYnNlcnZlci5kaXNjb25uZWN0KCk7Ci8vICBkaW1lbnNpb25zT2JzZXJ2ZXIgPSBudWxsOwovLwpPVEhlbHBlcnMub2JzZXJ2ZVN0eWxlQ2hhbmdlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0eWxlc1RvT2JzZXJ2ZSwgb25DaGFuZ2UpIHsKICAgIHZhciBvbGRTdHlsZXMgPSB7fTsKCiAgICB2YXIgZ2V0U3R5bGUgPSBmdW5jdGlvbiBnZXRTdHlsZShzdHlsZSkgewogICAgICAgICAgICBzd2l0Y2ggKHN0eWxlKSB7CiAgICAgICAgICAgIGNhc2UgJ3dpZHRoJzoKICAgICAgICAgICAgICAgIHJldHVybiBPVEhlbHBlcnMud2lkdGgoZWxlbWVudCk7CgogICAgICAgICAgICBjYXNlICdoZWlnaHQnOgogICAgICAgICAgICAgICAgcmV0dXJuIE9USGVscGVycy5oZWlnaHQoZWxlbWVudCk7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIE9USGVscGVycy5jc3MoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgIC8vIGdldCB0aGUgaW5pdGFsIHZhbHVlcwogICAgc3R5bGVzVG9PYnNlcnZlLmZvckVhY2goZnVuY3Rpb24oc3R5bGUpIHsKICAgICAgICBvbGRTdHlsZXNbc3R5bGVdID0gZ2V0U3R5bGUoc3R5bGUpOwogICAgfSk7CgogICAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24obXV0YXRpb25zKSB7CiAgICAgICAgdmFyIGNoYW5nZVNldCA9IHt9OwoKICAgICAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihtdXRhdGlvbikgewogICAgICAgICAgICBpZiAobXV0YXRpb24uYXR0cmlidXRlTmFtZSAhPT0gJ3N0eWxlJykgcmV0dXJuOwoKICAgICAgICAgICAgc3R5bGVzVG9PYnNlcnZlLmZvckVhY2goZnVuY3Rpb24oc3R5bGUpIHsKICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IGdldFN0eWxlKHN0eWxlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3VmFsdWUgIT09IG9sZFN0eWxlc1tzdHlsZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBPVC5kZWJ1ZygiQ0hBTkdFRCAiICsgc3R5bGUgKyAiOiAiICsgb2xkU3R5bGVzW3N0eWxlXSArICIgLT4gIiArIG5ld1ZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgY2hhbmdlU2V0W3N0eWxlXSA9IFtvbGRTdHlsZXNbc3R5bGVdLCBuZXdWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgb2xkU3R5bGVzW3N0eWxlXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKG9iamVjdEhhc1Byb3BlcnRpZXMoY2hhbmdlU2V0KSkgewogICAgICAgICAgICAvLyBEbyB0aGlzIGFmdGVyIHNvIGFzIHRvIGhlbHAgYXZvaWQgaW5maW5pdGUgbG9vcHMgb2YgbXV0YXRpb25zLgogICAgICAgICAgICBPVEhlbHBlcnMuY2FsbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgb25DaGFuZ2UuY2FsbChudWxsLCBjaGFuZ2VTZXQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICBvYnNlcnZlci5vYnNlcnZlKGVsZW1lbnQsIHsKICAgICAgICBhdHRyaWJ1dGVzOnRydWUsCiAgICAgICAgYXR0cmlidXRlRmlsdGVyOiBbJ3N0eWxlJ10sCiAgICAgICAgY2hpbGRMaXN0OmZhbHNlLAogICAgICAgIGNoYXJhY3RlckRhdGE6ZmFsc2UsCiAgICAgICAgc3VidHJlZTpmYWxzZQogICAgfSk7CgogICAgcmV0dXJuIG9ic2VydmVyOwp9OwoKCi8vIHRyaWdnZXIgdGhlICtvbkNoYW5nZSsgY2FsbGJhY2sgd2hlbmV2ZXIKLy8gMS4gK2VsZW1lbnQrIGlzIHJlbW92ZWQKLy8gMi4gb3IgYW4gaW1tZWRpYXRlIGNoaWxkIG9mICtlbGVtZW50KyBpcyByZW1vdmVkLgovLwovLyBUaGlzIGZ1bmN0aW9uIHJldHVybnMgdGhlIE11dGF0aW9uT2JzZXJ2ZXIgaXRzZWxmLiBPbmNlIHlvdSBubyBsb25nZXIgd2lzaAovLyB0byBvYnNlcnZlIHRoZSBlbGVtZW50IHlvdSBzaG91bGQgY2FsbCBkaXNjb25uZWN0IG9uIHRoZSBvYnNlcnZlci4KLy8KLy8gT2JzZXJ2aW5nIGNoYW5nZXM6Ci8vICAvLyBvYnNlcnZlIGNoYW5naW5ncyB0byB0aGUgd2lkdGggYW5kIGhlaWdodCBvZiBvYmplY3QKLy8gIG5vZGVPYnNlcnZlciA9IE9USGVscGVycy5vYnNlcnZlTm9kZU9yQ2hpbGROb2RlUmVtb3ZhbChvYmplY3QsIGZ1bmN0aW9uKHJlbW92ZWROb2RlcykgewovLyAgICAgIE9ULmRlYnVnKCJTb21lIGNoaWxkIG5vZGVzIHdlcmUgcmVtb3ZlZCIpOwovLyAgICAgIHJlbW92ZWROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKLy8gICAgICAgICAgT1QuZGVidWcobm9kZSk7Ci8vICAgICAgfSk7Ci8vICB9KTsKLy8KLy8gQ2xlYW5pbmcgdXAKLy8gIC8vIHN0b3Agb2JzZXJ2aW5nIGNoYW5nZXMKLy8gIG5vZGVPYnNlcnZlci5kaXNjb25uZWN0KCk7Ci8vICBub2RlT2JzZXJ2ZXIgPSBudWxsOwovLwpPVEhlbHBlcnMub2JzZXJ2ZU5vZGVPckNoaWxkTm9kZVJlbW92YWwgPSBmdW5jdGlvbihlbGVtZW50LCBvbkNoYW5nZSkgewogICAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24obXV0YXRpb25zKSB7CiAgICAgICAgdmFyIHJlbW92ZWROb2RlcyA9IFtdOwoKICAgICAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihtdXRhdGlvbikgewogICAgICAgICAgICBpZiAobXV0YXRpb24ucmVtb3ZlZE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gcmVtb3ZlZE5vZGVzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChtdXRhdGlvbi5yZW1vdmVkTm9kZXMpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBpZiAocmVtb3ZlZE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICAvLyBEbyB0aGlzIGFmdGVyIHNvIGFzIHRvIGhlbHAgYXZvaWQgaW5maW5pdGUgbG9vcHMgb2YgbXV0YXRpb25zLgogICAgICAgICAgICBPVEhlbHBlcnMuY2FsbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgb25DaGFuZ2UocmVtb3ZlZE5vZGVzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgogICAgb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgICAgYXR0cmlidXRlczpmYWxzZSwKICAgICAgICBjaGlsZExpc3Q6dHJ1ZSwKICAgICAgICBjaGFyYWN0ZXJEYXRhOmZhbHNlLAogICAgICAgIHN1YnRyZWU6dHJ1ZQogICAgfSk7CgogICAgcmV0dXJuIG9ic2VydmVyOwp9OwoKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKCi8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCi8vIHRiX3JlcXVpcmUoJy4vZG9tLmpzJykKCihmdW5jdGlvbih3aW5kb3csIE9USGVscGVycywgdW5kZWZpbmVkKSB7CgpPVEhlbHBlcnMuTW9kYWwgPSBmdW5jdGlvbih0aXRsZSwgYm9keSkgewogICAgLypqc2hpbnQgbXVsdGlzdHI6dHJ1ZSovCiAgICB2YXIgdG1wbCA9ICJcCiAgICAgICAgPGhlYWRlcj5cCiAgICAgICAgICAgIDxoMT48JT0gdGl0bGUgJT48L2gxPlwKICAgICAgICA8L2hlYWRlcj5cCiAgICAgICAgPGRpdiBjbGFzcz0nT1RfZGlhbG9nLWJvZHknPlwKICAgICAgICAgICAgPCU9IGJvZHkgJT5cCiAgICAgICAgPC9kaXY+XAogICAgIjsKCiAgICB0aGlzLmVsID0gT1RIZWxwZXJzLmNyZWF0ZUVsZW1lbnQoInNlY3Rpb24iLCB7CiAgICAgICAgICAgIGNsYXNzTmFtZTogIk9UX3Jvb3QgT1RfZGlhbG9nIE9UX21vZGFsIgogICAgICAgIH0sCiAgICAgICAgT1RIZWxwZXJzLnRlbXBsYXRlKHRtcGwsIHsKICAgICAgICAgICAgdGl0bGU6IHRpdGxlLAogICAgICAgICAgICBib2R5OiBib2R5CiAgICAgICAgfSkKICAgICk7CgogICAgLy8gV2UncmUgZ29pbmcgdG8gY2VudGVyIHRoZSBlbGVtZW50IGluIHRoZSB3aW5kb3cuIFdlIG5lZWQgdG8gYWRkIHRoZQogICAgLy8gZWxlbWVudCB0byB0aGUgYm9keSBiZWZvcmUgd2UgZG8sIG90aGVyd2lzZSB3ZSBjYW4ndCBjYWxjdWxhdGUgdGhlIGRpYWxvZydzCiAgICAvLyB3aWR0aHMgYW5kIGhlaWdodHMuIFRoaXMgbWVhbnMgd2UgbmVlZCB0byBoaWRlIHRoZSBlbGVtZW50IGZpcnN0LgogICAgdGhpcy5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmVsKTsKICAgIE9USGVscGVycy5jZW50ZXJFbGVtZW50KHRoaXMuZWwpOwogICAgT1RIZWxwZXJzLnNob3codGhpcy5lbCk7CgogICAgdGhpcy5jbG9zZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIE9USGVscGVycy5yZW1vdmVFbGVtZW50KHRoaXMuZWwpOwogICAgICAgIHRoaXMuZWwgPSBudWxsOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKfTsKCi8vIEN1c3RvbSBhbGVydCBkaWFsb2cKT1RIZWxwZXJzLnRiQWxlcnQgPSBmdW5jdGlvbih0aXRsZSwgbWVzc2FnZSkgewogICAgdmFyIG1vZGFsID0gbmV3IE9USGVscGVycy5Nb2RhbCh0aXRsZSwgIjxkaXY+IiArIG1lc3NhZ2UgKyAiPC9kaXY+Iik7CiAgICBPVEhlbHBlcnMuYWRkQ2xhc3MobW9kYWwuZWwsICJPVF90YmFsZXJ0Iik7CgogICAgdmFyIGNsb3NlQnRuID0gT1RIZWxwZXJzLmNyZWF0ZUVsZW1lbnQoImlucHV0IiwgewogICAgICAgICAgICBjbGFzc05hbWU6ICJPVF9jbG9zZUJ1dHRvbiIsCiAgICAgICAgICAgIHR5cGU6ICJidXR0b24iLAogICAgICAgICAgICB2YWx1ZTogImNsb3NlIgogICAgfSk7CiAgICBtb2RhbC5lbC5hcHBlbmRDaGlsZChjbG9zZUJ0bik7CgogICAgY2xvc2VCdG4ub25jbGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChtb2RhbCkgbW9kYWwuY2xvc2UoKTsKICAgICAgICBtb2RhbCA9IG51bGw7CiAgICB9Owp9OwoKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKCi8vIERPTSBBdHRyaWJ1dGUgaGVscGVycyBoZWxwZXJzCgovKmpzaGludCBicm93c2VyOnRydWUsIHNtYXJ0dGFiczp0cnVlKi8KCi8vIHRiX3JlcXVpcmUoJy4uL2hlbHBlcnMuanMnKQovLyB0Yl9yZXF1aXJlKCcuL2RvbS5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKT1RIZWxwZXJzLmFkZENsYXNzID0gZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgIC8vIE9ubHkgYm90aGVyIHRhcmdldGluZyBFbGVtZW50IG5vZGVzLCBpZ25vcmUgVGV4dCBOb2RlcywgQ0RBVEEsIGV0YwogICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNsYXNzTmFtZXMgPSB2YWx1ZS50cmltKCkuc3BsaXQoL1xzKy8pLAogICAgICAgIGksIGw7CgogICAgaWYgKE9USGVscGVycy5zdXBwb3J0c0NsYXNzTGlzdCgpKSB7CiAgICAgICAgZm9yIChpPTAsIGw9Y2xhc3NOYW1lcy5sZW5ndGg7IGk8bDsgKytpKSB7CiAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbGFzc05hbWVzW2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBIZXJlJ3Mgb3VyIGZhbGxiYWNrIHRvIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBlbGVtZW50LmNsYXNzTGlzdAoKICAgIGlmICghZWxlbWVudC5jbGFzc05hbWUgJiYgY2xhc3NOYW1lcy5sZW5ndGggPT09IDEpIHsKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IHZhbHVlOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdmFyIHNldENsYXNzID0gIiAiICsgZWxlbWVudC5jbGFzc05hbWUgKyAiICI7CgogICAgICAgIGZvciAoaT0wLCBsPWNsYXNzTmFtZXMubGVuZ3RoOyBpPGw7ICsraSkgewogICAgICAgICAgICBpZiAoICF+c2V0Q2xhc3MuaW5kZXhPZiggIiAiICsgY2xhc3NOYW1lc1tpXSArICIgIikpIHsKICAgICAgICAgICAgICAgIHNldENsYXNzICs9IGNsYXNzTmFtZXNbaV0gKyAiICI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gc2V0Q2xhc3MudHJpbSgpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwp9OwoKT1RIZWxwZXJzLnJlbW92ZUNsYXNzID0gZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgIGlmICghdmFsdWUpIHJldHVybjsKCiAgICAvLyBPbmx5IGJvdGhlciB0YXJnZXRpbmcgRWxlbWVudCBub2RlcywgaWdub3JlIFRleHQgTm9kZXMsIENEQVRBLCBldGMKICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBuZXdDbGFzc2VzID0gdmFsdWUudHJpbSgpLnNwbGl0KC9ccysvKSwKICAgICAgICBpLCBsOwoKICAgIGlmIChPVEhlbHBlcnMuc3VwcG9ydHNDbGFzc0xpc3QoKSkgewogICAgICAgIGZvciAoaT0wLCBsPW5ld0NsYXNzZXMubGVuZ3RoOyBpPGw7ICsraSkgewogICAgICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUobmV3Q2xhc3Nlc1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNsYXNzTmFtZSA9ICgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikucmVwbGFjZSgvW1xzK10vLCAnICcpOwoKICAgIGZvciAoaT0wLGw9bmV3Q2xhc3Nlcy5sZW5ndGg7IGk8bDsgKytpKSB7CiAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UoJyAnICsgbmV3Q2xhc3Nlc1tpXSArICcgJywgJyAnKTsKICAgIH0KCiAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsYXNzTmFtZS50cmltKCk7CgogICAgcmV0dXJuIHRoaXM7Cn07CgoKLyoqCiAqIE1ldGhvZHMgdG8gY2FsY3VsYXRlIGVsZW1lbnQgd2lkdGhzIGFuZCBoZWlnaHRzLgogKi8KCnZhciBfd2lkdGggPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgaWYgKGVsZW1lbnQub2Zmc2V0V2lkdGggPiAwKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm9mZnNldFdpZHRoICsgJ3B4JzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBPVEhlbHBlcnMuY3NzKGVsZW1lbnQsICd3aWR0aCcpOwogICAgfSwKCiAgICBfaGVpZ2h0ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIGlmIChlbGVtZW50Lm9mZnNldEhlaWdodCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQub2Zmc2V0SGVpZ2h0ICsgJ3B4JzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBPVEhlbHBlcnMuY3NzKGVsZW1lbnQsICdoZWlnaHQnKTsKICAgIH07CgpPVEhlbHBlcnMud2lkdGggPSBmdW5jdGlvbihlbGVtZW50LCBuZXdXaWR0aCkgewogICAgaWYgKG5ld1dpZHRoKSB7CiAgICAgICAgT1RIZWxwZXJzLmNzcyhlbGVtZW50LCAnd2lkdGgnLCBuZXdXaWR0aCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAoT1RIZWxwZXJzLmlzRGlzcGxheU5vbmUoZWxlbWVudCkpIHsKICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZ2V0IHRoZSB3aWR0aCwgcHJvYmFibHkgc2luY2UgdGhlIGVsZW1lbnQgaXMgaGlkZGVuLgogICAgICAgICAgICByZXR1cm4gT1RIZWxwZXJzLm1ha2VWaXNpYmxlQW5kWWllbGQoZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3dpZHRoKGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBfd2lkdGgoZWxlbWVudCk7CiAgICAgICAgfQogICAgfQp9OwoKT1RIZWxwZXJzLmhlaWdodCA9IGZ1bmN0aW9uKGVsZW1lbnQsIG5ld0hlaWdodCkgewogICAgaWYgKG5ld0hlaWdodCkgewogICAgICAgIE9USGVscGVycy5jc3MoZWxlbWVudCwgJ2hlaWdodCcsIG5ld0hlaWdodCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAoT1RIZWxwZXJzLmlzRGlzcGxheU5vbmUoZWxlbWVudCkpIHsKICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZ2V0IHRoZSBoZWlnaHQsIHByb2JhYmx5IHNpbmNlIHRoZSBlbGVtZW50IGlzIGhpZGRlbi4KICAgICAgICAgICAgcmV0dXJuIE9USGVscGVycy5tYWtlVmlzaWJsZUFuZFlpZWxkKGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF9oZWlnaHQoZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIF9oZWlnaHQoZWxlbWVudCk7CiAgICAgICAgfQogICAgfQp9OwoKLy8gQ2VudGVycyArZWxlbWVudCsgd2l0aGluIHRoZSB3aW5kb3cuIFlvdSBjYW4gcGFzcyB0aHJvdWdoIHRoZSB3aWR0aCBhbmQgaGVpZ2h0Ci8vIGlmIHlvdSBrbm93IGl0LCBpZiB5b3UgZG9uJ3QgdGhleSB3aWxsIGJlIGNhbGN1bGF0ZWQgZm9yIHlvdS4KT1RIZWxwZXJzLmNlbnRlckVsZW1lbnQgPSBmdW5jdGlvbihlbGVtZW50LCB3aWR0aCwgaGVpZ2h0KSB7CiAgICBpZiAoIXdpZHRoKSB3aWR0aCA9IHBhcnNlSW50KE9USGVscGVycy53aWR0aChlbGVtZW50KSwgMTApOwogICAgaWYgKCFoZWlnaHQpIGhlaWdodCA9IHBhcnNlSW50KE9USGVscGVycy5oZWlnaHQoZWxlbWVudCksIDEwKTsKCiAgICB2YXIgbWFyZ2luTGVmdCA9IC0wLjUgKiB3aWR0aCArICJweCI7CiAgICB2YXIgbWFyZ2luVG9wID0gLTAuNSAqIGhlaWdodCArICJweCI7CiAgICBPVEhlbHBlcnMuY3NzKGVsZW1lbnQsICJtYXJnaW4iLCBtYXJnaW5Ub3AgKyAiIDAgMCAiICsgbWFyZ2luTGVmdCk7CiAgICBPVEhlbHBlcnMuYWRkQ2xhc3MoZWxlbWVudCwgIk9UX2NlbnRlcmVkIik7Cn07Cgp9KSh3aW5kb3csIHdpbmRvdy5PVEhlbHBlcnMpOwovLyBDU1MgaGVscGVycyBoZWxwZXJzCgovKmpzaGludCBicm93c2VyOnRydWUsIHNtYXJ0dGFiczp0cnVlKi8KCi8vIHRiX3JlcXVpcmUoJy4uL2hlbHBlcnMuanMnKQovLyB0Yl9yZXF1aXJlKCcuL2RvbS5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKdmFyIGRpc3BsYXlTdGF0ZUNhY2hlID0ge30sCiAgICBkZWZhdWx0RGlzcGxheXMgPSB7fTsKCnZhciBkZWZhdWx0RGlzcGxheVZhbHVlRm9yRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGlmIChkZWZhdWx0RGlzcGxheXNbZWxlbWVudC5vd25lckRvY3VtZW50XSAmJiBkZWZhdWx0RGlzcGxheXNbZWxlbWVudC5vd25lckRvY3VtZW50XVtlbGVtZW50Lm5vZGVOYW1lXSkgewogICAgICAgIHJldHVybiBkZWZhdWx0RGlzcGxheXNbZWxlbWVudC5vd25lckRvY3VtZW50XVtlbGVtZW50Lm5vZGVOYW1lXTsKICAgIH0KCiAgICBpZiAoIWRlZmF1bHREaXNwbGF5c1tlbGVtZW50Lm93bmVyRG9jdW1lbnRdKSBkZWZhdWx0RGlzcGxheXNbZWxlbWVudC5vd25lckRvY3VtZW50XSA9IHt9OwoKICAgIC8vIFdlIG5lZWQgdG8ga25vdyB3aGF0IGRpc3BsYXkgdmFsdWUgdG8gdXNlIGZvciB0aGlzIG5vZGUuIFRoZSBlYXNpZXN0IHdheQogICAgLy8gaXMgdG8gYWN0dWFsbHkgY3JlYXRlIGEgbm9kZSBhbmQgcmVhZCBpdCBvdXQuCiAgICB2YXIgdGVzdE5vZGUgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChlbGVtZW50Lm5vZGVOYW1lKSwKICAgICAgICBkZWZhdWx0RGlzcGxheTsKCiAgICBlbGVtZW50Lm93bmVyRG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZXN0Tm9kZSk7CiAgICBkZWZhdWx0RGlzcGxheSA9IGRlZmF1bHREaXNwbGF5c1tlbGVtZW50Lm93bmVyRG9jdW1lbnRdW2VsZW1lbnQubm9kZU5hbWVdID0gT1RIZWxwZXJzLmNzcyh0ZXN0Tm9kZSwgJ2Rpc3BsYXknKTsKCiAgICBPVEhlbHBlcnMucmVtb3ZlRWxlbWVudCh0ZXN0Tm9kZSk7CiAgICB0ZXN0Tm9kZSA9IG51bGw7CgogICAgcmV0dXJuIGRlZmF1bHREaXNwbGF5Owp9OwoKdmFyIGlzSGlkZGVuID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIGNvbXB1dGVkU3R5bGUgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCBudWxsKTsKICAgIHJldHVybiBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2Rpc3BsYXknKSA9PT0gJ25vbmUnOwp9OwoKT1RIZWxwZXJzLnNob3cgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgZGlzcGxheSA9IGVsZW1lbnQuc3R5bGUuZGlzcGxheTsKICAgICAgICAvLywKICAgICAgICAvLyBjb21wdXRlZFN0eWxlID0gZWxlbWVudC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCksCiAgICAgICAgLy8gY29tcHV0ZWREaXNwbGF5ID0gY29tcHV0ZWRTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCdkaXNwbGF5Jyk7CgogICAgaWYgKGRpc3BsYXkgPT09ICcnIHx8IGRpc3BsYXkgPT09ICdub25lJykgewogICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXlTdGF0ZUNhY2hlW2VsZW1lbnRdIHx8ICcnOwogICAgICAgIGRlbGV0ZSBkaXNwbGF5U3RhdGVDYWNoZVtlbGVtZW50XTsKICAgIH0KCiAgICBpZiAoaXNIaWRkZW4oZWxlbWVudCkpIHsKICAgICAgICAvLyBJdCdzIHN0aWxsIGhpZGRlbiBzbyB0aGVyZSdzIHByb2JhYmx5IGEgc3R5bGVzaGVldCB0aGF0IGRlY2xhcmVzIHRoaXMKICAgICAgICAvLyBlbGVtZW50IGFzIGRpc3BsYXk6bm9uZTsKICAgICAgICBkaXNwbGF5U3RhdGVDYWNoZVtlbGVtZW50XSA9ICdub25lJzsKCiAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gZGVmYXVsdERpc3BsYXlWYWx1ZUZvckVsZW1lbnQoZWxlbWVudCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cn07CgpPVEhlbHBlcnMuaGlkZSA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGlmIChlbGVtZW50LnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgcmV0dXJuOwoKICAgIGRpc3BsYXlTdGF0ZUNhY2hlW2VsZW1lbnRdID0gZWxlbWVudC5zdHlsZS5kaXNwbGF5OwogICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgIHJldHVybiB0aGlzOwp9OwoKT1RIZWxwZXJzLmNzcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWVPckhhc2gsIHZhbHVlKSB7CiAgICBpZiAodHlwZW9mKG5hbWVPckhhc2gpICE9PSAnc3RyaW5nJykgewogICAgICAgIHZhciBzdHlsZSA9IGVsZW1lbnQuc3R5bGU7CgogICAgICAgIGZvciAodmFyIGNzc05hbWUgaW4gbmFtZU9ySGFzaCkgewogICAgICAgICAgICBzdHlsZVtjc3NOYW1lXSA9IG5hbWVPckhhc2hbY3NzTmFtZV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGVsc2UgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBlbGVtZW50LnN0eWxlW25hbWVPckhhc2hdID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICAvLyBOb3JtYWxpc2UgdmVuZG9yIHByZWZpeGVzIGZyb20gdGhlIGZvcm0gTW96VHJhbmZvcm0gdG8gLW1vei10cmFuc2Zvcm0KICAgICAgICAvLyBleGNlcHQgZm9yIG1zIGV4dGVuc2lvbnMsIHdoaWNoIGFyZSB3ZWlyZC4uLgogICAgICAgIHZhciBuYW1lID0gbmFtZU9ySGFzaC5yZXBsYWNlKCAvKFtBLVpdfF5tcykvZywgIi0kMSIgKS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICBjb21wdXRlZFN0eWxlID0gZWxlbWVudC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCksCiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKTsKCiAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PT0gJycpIHsKICAgICAgICAgICAgY3VycmVudFZhbHVlID0gZWxlbWVudC5zdHlsZVtuYW1lXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICB9Cn07CgoKLy8gQXBwbHkgK3N0eWxlcysgdG8gK2VsZW1lbnQrIHdoaWxlIGV4ZWN1dGluZyArY2FsbGJhY2srLCByZXN0b3JpbmcgdGhlIHByZXZpb3VzCi8vIHN0eWxlcyBhZnRlciB0aGUgY2FsbGJhY2sgZXhlY3V0ZXMuCk9USGVscGVycy5hcHBseUNTUyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0eWxlcywgY2FsbGJhY2spIHsKICAgIHZhciBvbGRTdHlsZXMgPSB7fSwKICAgICAgICBuYW1lLAogICAgICAgIHJldDsKCiAgICAvLyBCYWNrdXAgdGhlIG9sZCBzdHlsZXMKICAgIGZvciAobmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICBpZiAoc3R5bGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIC8vIFdlIGludGVudGlvbmFsbHkgcmVhZCBvdXQgb2Ygc3R5bGUgaGVyZSwgaW5zdGVhZCBvZiB1c2luZyB0aGUgY3NzCiAgICAgICAgICAgIC8vIGhlbHBlci4gVGhpcyBpcyBiZWNhdXNlIHRoZSBjc3MgaGVscGVyIHVzZXMgcXVlcnlTZWxlY3RvciBhbmQgd2UKICAgICAgICAgICAgLy8gb25seSB3YW50IHRvIHB1bGwgdmFsdWVzIG91dCBvZiB0aGUgc3R5bGUgKGRvbWVFbGVtZW50LnN0eWxlKSBoYXNoLgogICAgICAgICAgICBvbGRTdHlsZXNbbmFtZV0gPSBlbGVtZW50LnN0eWxlW25hbWVdOwoKICAgICAgICAgICAgT1RIZWxwZXJzLmNzcyhlbGVtZW50LCBuYW1lLCBzdHlsZXNbbmFtZV0pOwogICAgICAgIH0KICAgIH0KCiAgICByZXQgPSBjYWxsYmFjaygpOwoKICAgIC8vIFJlc3RvcmUgdGhlIG9sZCBzdHlsZXMKICAgIGZvciAobmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICBpZiAoc3R5bGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIE9USGVscGVycy5jc3MoZWxlbWVudCwgbmFtZSwgb2xkU3R5bGVzW25hbWVdIHx8ICcnKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJldDsKfTsKCi8vIE1ha2UgK2VsZW1lbnQrIHZpc2libGUgd2hpbGUgZXhlY3V0aW5nICtjYWxsYmFjaysuCk9USGVscGVycy5tYWtlVmlzaWJsZUFuZFlpZWxkID0gZnVuY3Rpb24oZWxlbWVudCwgY2FsbGJhY2spIHsKICAgIC8vIGZpbmQgd2hldGhlciBpdCdzIHRoZSBlbGVtZW50IG9yIGFuIGFuY2VzdGVyIHRoYXQncyBkaXNwbGF5IG5vbmUgYW5kCiAgICAvLyB0aGVuIGFwcGx5IHRvIHdoaWNoZXZlciBpdCBpcwogICAgdmFyIHRhcmdldEVsZW1lbnQgPSBPVEhlbHBlcnMuZmluZEVsZW1lbnRXaXRoRGlzcGxheU5vbmUoZWxlbWVudCk7CiAgICBpZiAoIXRhcmdldEVsZW1lbnQpIHJldHVybjsKCiAgICByZXR1cm4gT1RIZWxwZXJzLmFwcGx5Q1NTKHRhcmdldEVsZW1lbnQsIHsKICAgICAgICAgICAgZGlzcGxheTogImJsb2NrIiwKICAgICAgICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIKICAgICAgICB9LAogICAgICAgIGNhbGxiYWNrCiAgICApOwp9OwoKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKLy8gQUpBWCBoZWxwZXJzCgovKmpzaGludCBicm93c2VyOnRydWUsIHNtYXJ0dGFiczp0cnVlKi8KCi8vIHRiX3JlcXVpcmUoJy4uL2hlbHBlcnMuanMnKQovLyB0Yl9yZXF1aXJlKCcuL3htbC5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKZnVuY3Rpb24gZm9ybWF0UG9zdERhdGEoZGF0YSkgeyAvLywgY29udGVudFR5cGUKICAgIC8vIElmIGl0J3MgYSBzdHJpbmcsIHdlIGFzc3VtZSBpdCdzIHByb3Blcmx5IGVuY29kZWQKICAgIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSByZXR1cm4gZGF0YTsKCiAgICB2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCiAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgIHF1ZXJ5U3RyaW5nLnB1c2goCiAgICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRhdGFba2V5XSkKICAgICAgICApOwogICAgfQoKICAgIHJldHVybiBxdWVyeVN0cmluZy5qb2luKCcmJykucmVwbGFjZSgvXCsvZywgIiUyMCIpOwp9CgpPVEhlbHBlcnMuZ2V0WE1MID0gZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICB2YXIgY2FsbGVyU3VjY2Vzc0NiID0gb3B0aW9ucyAmJiBvcHRpb25zLnN1Y2Nlc3MsCgogICAgICAgIGlzVmFsaWRYTUxEb2N1bWVudCA9IGZ1bmN0aW9uKHhtbERvY3VtZW50KSB7CiAgICAgICAgICAgIHZhciByb290OwoKICAgICAgICAgICAgaWYgKCF4bWxEb2N1bWVudCkgewogICAgICAgICAgICAgICAgLy8gQmFkbHkgZm9ybWVkIFhNTAogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBnb3Qgc29tZSBYTUwgYmFjaywgYXR0ZW1wdCB0byBpbmZlciBpZiB0aGUgWE1MIGlzIGJhZGx5IGZvcm1lZAogICAgICAgICAgICByb290ID0geG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgICAgaWYgKCFyb290IHx8ICFyb290Lm5vZGVOYW1lIHx8IHJvb3Qubm9kZU5hbWUgPT09ICJwYXJzZXJlcnJvciIpIHsKICAgICAgICAgICAgICAgIC8vIEJhZGx5IGZvcm1lZCBYTUwKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgb25TdWNjZXNzID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0gZXZlbnQudGFyZ2V0LnJlc3BvbnNlWE1MOwoKICAgICAgICAgICAgaWYgKGlzVmFsaWRYTUxEb2N1bWVudChyZXNwb25zZSkpIHsKICAgICAgICAgICAgICAgIGlmIChjYWxsZXJTdWNjZXNzQ2IpIGNhbGxlclN1Y2Nlc3NDYihyZXNwb25zZSwgZXZlbnQsIGV2ZW50LnRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmVycm9yKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmVycm9yKGV2ZW50LCBldmVudC50YXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICB2YXIgZXh0ZW5kZWRIZWFkZXJzID0gT1RIZWxwZXJzLmV4dGVuZChvcHRpb25zLmhlYWRlcnMgfHwge30sIHsKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94bWwnCiAgICAgICAgfSk7CgogICAgT1RIZWxwZXJzLmdldCh1cmwsIE9USGVscGVycy5leHRlbmQob3B0aW9ucyB8fCB7fSwgewogICAgICAgIHN1Y2Nlc3M6IG9uU3VjY2VzcywKICAgICAgICBoZWFkZXJzOiBleHRlbmRlZEhlYWRlcnMKICAgIH0pKTsKfTsKCk9USGVscGVycy5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICB2YXIgY2FsbGVyU3VjY2Vzc0NiID0gb3B0aW9ucyAmJiBvcHRpb25zLnN1Y2Nlc3MsCiAgICAgICAgb25TdWNjZXNzID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIHJlc3BvbnNlOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gSlNPTi5wYXJzZShldmVudC50YXJnZXQucmVzcG9uc2VUZXh0KTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAvLyBCYWRseSBmb3JtZWQgSlNPTgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lcnJvcikgb3B0aW9ucy5lcnJvcihldmVudCwgZXZlbnQudGFyZ2V0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNhbGxlclN1Y2Nlc3NDYikgY2FsbGVyU3VjY2Vzc0NiKHJlc3BvbnNlLCBldmVudCwgZXZlbnQudGFyZ2V0KTsKICAgICAgICB9OwoKICAgIE9USGVscGVycy5nZXQodXJsLCBPVEhlbHBlcnMuZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsKICAgICAgICBzdWNjZXNzOiBvblN1Y2Nlc3MsCiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nCiAgICAgICAgfQogICAgfSkpOwp9OwoKT1RIZWxwZXJzLmdldCA9IGZ1bmN0aW9uKHVybCwgb3B0aW9ucykgewogICAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKSwKICAgICAgICBfb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgYmluZFRvU3VjY2Vzc0FuZEVycm9yQ2FsbGJhY2tzKHJlcXVlc3QsIF9vcHRpb25zLnN1Y2Nlc3MsIF9vcHRpb25zLmVycm9yKTsKICAgIGlmIChfb3B0aW9ucy5wcm9jZXNzKSByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoInByb2dyZXNzIiwgX29wdGlvbnMucHJvZ3Jlc3MsIGZhbHNlKTsKICAgIGlmIChfb3B0aW9ucy5jYW5jZWxsZWQpIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBfb3B0aW9ucy5jYW5jZWxsZWQsIGZhbHNlKTsKCgogICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB1cmwsIHRydWUpOwoKICAgIGlmICghX29wdGlvbnMuaGVhZGVycykgX29wdGlvbnMuaGVhZGVycyA9IHt9OwoKICAgIGZvciAodmFyIG5hbWUgaW4gX29wdGlvbnMuaGVhZGVycykgewogICAgICAgIHJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcihuYW1lLCBfb3B0aW9ucy5oZWFkZXJzW25hbWVdKTsKICAgIH0KCiAgICByZXF1ZXN0LnNlbmQoKTsKfTsKCk9USGVscGVycy5wb3N0ID0gZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpLAogICAgICAgIF9vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBiaW5kVG9TdWNjZXNzQW5kRXJyb3JDYWxsYmFja3MocmVxdWVzdCwgX29wdGlvbnMuc3VjY2VzcywgX29wdGlvbnMuZXJyb3IpOwoKICAgIGlmIChfb3B0aW9ucy5wcm9jZXNzKSByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoInByb2dyZXNzIiwgX29wdGlvbnMucHJvZ3Jlc3MsIGZhbHNlKTsKICAgIGlmIChfb3B0aW9ucy5jYW5jZWxsZWQpIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBfb3B0aW9ucy5jYW5jZWxsZWQsIGZhbHNlKTsKCiAgICByZXF1ZXN0Lm9wZW4oJ1BPU1QnLCB1cmwsIHRydWUpOwoKICAgIGlmICghX29wdGlvbnMuaGVhZGVycykgX29wdGlvbnMuaGVhZGVycyA9IHt9OwoKICAgIGZvciAodmFyIG5hbWUgaW4gX29wdGlvbnMuaGVhZGVycykgewogICAgICAgIHJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcihuYW1lLCBfb3B0aW9ucy5oZWFkZXJzW25hbWVdKTsKICAgIH0KCiAgICByZXF1ZXN0LnNlbmQoZm9ybWF0UG9zdERhdGEoX29wdGlvbnMuZGF0YSkpOwp9OwoKT1RIZWxwZXJzLnBvc3RGb3JtRGF0YSA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgb3B0aW9ucykgewogICAgaWYgKCFkYXRhKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPVEhlbHBlcnMucG9zdEZvcm1EYXRhIG11c3QgYmUgcGFzc2VkIGEgZGF0YSBvcHRpb25zLiIpOwogICAgfQoKICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpOwoKICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgZm9ybURhdGEuYXBwZW5kKGtleSwgZGF0YVtrZXldKTsKICAgIH0KCiAgICBPVEhlbHBlcnMucG9zdCh1cmwsIE9USGVscGVycy5leHRlbmQob3B0aW9ucyB8fCB7fSwgewogICAgICAgIGRhdGE6IGZvcm1EYXRhCiAgICB9KSk7Cn07CgoKLy8gTWFrZSBhIEdFVCByZXF1ZXN0IHZpYSBKU09OUC4KLy8KLy8gQGV4YW1wbGUgTWFrZSBhIHJlcXVlc3QgdG8gJ2h0dHA6Ly90b2tib3guY29tOjk5OTkvc2Vzc2lvbi9mb28nIHdpdGggc3VjY2VzcyBhbmQgZXJyb3IgY2FsbGJhY2tzCi8vCi8vICBPVEhlbHBlcnMuZ2V0SlNPTlAoJ2h0dHA6Ly90b2tib3guY29tOjk5OTkvc2Vzc2lvbi9mb28nLCB7Ci8vICAgICAgc3VjY2Vzczogc3VjY2Vzc0NhbGxiYWNrLAovLyAgICAgIGVycm9yOiBlcnJvckNhbGxiYWNrCi8vICB9KTsKLy8KT1RIZWxwZXJzLmdldEpTT05QID0gZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICB2YXIgX2xvYWRUaW1lb3V0ID0gMzAwMDAsCiAgICAgICAgX3NjcmlwdCwKICAgICAgICBfaGVhZCA9IGRvY3VtZW50LmhlYWQgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXSwKICAgICAgICBfd2FpdFVudGlsVGltZW91dCwKICAgICAgICBfdXJsV2l0aENhbGxiYWNrID0gdXJsLAogICAgICAgIF9vcHRpb25zID0gT1RIZWxwZXJzLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7CiAgICAgICAgICAgIGNhbGxiYWNrUGFyYW1ldGVyOiAnY2FsbGJhY2snCiAgICAgICAgfSksCgogICAgICAgIF9jbGVhclRpbWVvdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF93YWl0VW50aWxUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoX3dhaXRVbnRpbFRpbWVvdXQpOwogICAgICAgICAgICAgICAgX3dhaXRVbnRpbFRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NsZWFudXAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2NsZWFyVGltZW91dCgpOwoKICAgICAgICAgICAgaWYgKF9zY3JpcHQpIHsKICAgICAgICAgICAgICAgIF9zY3JpcHQub25sb2FkID0gX3NjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKICAgICAgICAgICAgICAgIE9USGVscGVycy5yZW1vdmVFbGVtZW50KCBfc2NyaXB0ICk7CgogICAgICAgICAgICAgICAgX3NjcmlwdCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9vbkxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF9zY3JpcHQucmVhZHlTdGF0ZSAmJiAhL2xvYWRlZHxjb21wbGV0ZS8udGVzdCggX3NjcmlwdC5yZWFkeVN0YXRlICkpIHsKICAgICAgICAgICAgICAgIC8vIFllYWgsIHdlJ3JlIG5vdCByZWFkeSB5ZXQuLi4KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NsZWFyVGltZW91dCgpOwogICAgICAgIH0sCgogICAgICAgIF9vbkxvYWRUaW1lb3V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIF9jbGVhbnVwKCk7CgogICAgICAgICAgICBPVEhlbHBlcnMuZXJyb3IoIlRoZSBKU09OUCByZXF1ZXN0IHRvICIgKyBfdXJsV2l0aENhbGxiYWNrICsgIiB0aW1lZCBvdXQgYWZ0ZXIgIiArIF9sb2FkVGltZW91dCArICJtcy4iKTsKICAgICAgICAgICAgaWYgKF9vcHRpb25zLmVycm9yKSBfb3B0aW9ucy5lcnJvcigiVGhlIEpTT05QIHJlcXVlc3QgdG8gIiArIHVybCArICIgdGltZWQgb3V0IGFmdGVyICIgKyBfbG9hZFRpbWVvdXQgKyAibXMuIiwgX3VybFdpdGhDYWxsYmFjaywgIF9vcHRpb25zKTsKICAgICAgICB9LAoKICAgICAgICBfZ2VuZXJhdGVDYWxsYmFja05hbWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICdqc29ucF9jYWxsYmFja18nICsgKCtuZXcgRGF0ZSgpKTsKICAgICAgICB9OwoKCiAgICBfb3B0aW9ucy5jYWxsYmFja05hbWUgPSBfZ2VuZXJhdGVDYWxsYmFja05hbWUoKTsKICAgIHRoaXMuanNvbnBfY2FsbGJhY2tzW19vcHRpb25zLmNhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgIF9jbGVhbnVwKCk7CgogICAgICAgIGlmIChfb3B0aW9ucy5zdWNjZXNzKSBfb3B0aW9ucy5zdWNjZXNzKHJlc3BvbnNlKTsKICAgIH07CgogICAgLy8gVGhpcyBkb2Vzbid0IGhhbmRsZSBVUkxzIGxpa2UgImh0dHA6Ly93d3cuZ29vZ2xlLmNvbT9ibGFoPTEjc29tZXRoaW5nIi4gVGhlIGNhbGxiYWNrIG5hbWUKICAgIC8vIHdpbGwgYmUgaW5jb3JyZWN0bHkgYXBwZW5kZWQgYWZ0ZXIgdGhlICMuCiAgICBfdXJsV2l0aENhbGxiYWNrICs9ICgoL1w/LykudGVzdChfdXJsV2l0aENhbGxiYWNrKSA/ICImIiA6ICI/IikgKyBfb3B0aW9ucy5jYWxsYmFja1BhcmFtZXRlciArICc9JyArIF9vcHRpb25zLmNhbGxiYWNrTmFtZTsKCiAgICBfc2NyaXB0ID0gT1RIZWxwZXJzLmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcsIHsKICAgICAgICBhc3luYzogJ2FzeW5jJywKICAgICAgICBzcmM6IF91cmxXaXRoQ2FsbGJhY2ssCiAgICAgICAgb25sb2FkOiBfb25Mb2FkLAogICAgICAgIG9ucmVhZHlzdGF0ZWNoYW5nZTogX29uTG9hZAogICAgfSk7CiAgICBfaGVhZC5hcHBlbmRDaGlsZChfc2NyaXB0KTsKCiAgICBfd2FpdFVudGlsVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IF9vbkxvYWRUaW1lb3V0KCk7IH0sIF9sb2FkVGltZW91dCk7Cn07CgovLyBQcml2YXRlIGhlbHBlciBtZXRob2QgdXNlZCAoYnkgT1RIZWxwZXJzLmdldCBhbmQgT1RIZWxwZXJzLnBvc3QgYW1vbmcgb3RoZXJzKSB0byBzZXR1cAovLyBjYWxsYmFja3MgdG8gY29ycmVjdGx5IHJlc3BvbmQgdG8gc3VjY2VzcyBhbmQgZXJyb3IgY2FsbGJhY2tzLiBUaGlzIGluY2x1ZGVzCi8vIGludGVycHJldGluZyB0aGUgcmVzcG9uc2VzIEhUVFAgc3RhdHVzLCB3aGljaCBYbWxIdHRwUmVxdWVzdCBzZWVtcyB0byBpZ25vcmUKLy8gYnkgZGVmYXVsdC4KdmFyIGJpbmRUb1N1Y2Nlc3NBbmRFcnJvckNhbGxiYWNrcyA9IGZ1bmN0aW9uKHJlcXVlc3QsIHN1Y2Nlc3MsIGVycm9yKSB7CiAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgIHZhciBzdGF0dXMgPSBldmVudC50YXJnZXQuc3RhdHVzOwoKICAgICAgICAvLyBXZSBuZWVkIHRvIGRldGVjdCB0aGluZ3MgdGhhdCBYTUxIdHRwUmVxdWVzdCBjb25zaWRlcnMgYSBzdWNjZXNzLAogICAgICAgIC8vIGJ1dCB3ZSBjb25zaWRlciB0byBiZSBmYWlsdXJlcy4KICAgICAgICBpZiAoIHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0ICkgewogICAgICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcy5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChlcnJvcikgewogICAgICAgICAgICBlcnJvcihldmVudCk7CiAgICAgICAgfQogICAgfSwgZmFsc2UpOwoKCiAgICBpZiAoZXJyb3IpIHsKICAgICAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgZXJyb3IsIGZhbHNlKTsKICAgIH0KfTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7CiEoZnVuY3Rpb24od2luZG93KSB7CgppZiAoIXdpbmRvdy5PVCkgd2luZG93Lk9UID0ge307CgovLyBCcmluZyBPVEhlbHBlcnMgaW4gYXMgT1QuJApPVC4kID0gT1RIZWxwZXJzLm5vQ29uZmxpY3QoKTsKCi8vIEFsbG93IGV2ZW50cyB0byBiZSBib3VuZCBvbiBPVApPVC4kLmV2ZW50aW5nKE9UKTsKCi8vIE9ULiQuTW9kYWwgd2FzIE9ULk1vZGFsIGJlZm9yZSB0aGUgZ3JlYXQgY29tbW9uLWpzLWhlbHBlcnMgbW92ZQpPVC5Nb2RhbCA9IE9ULiQuTW9kYWw7CgovLyBBZGQgbG9nZ2luZyBtZXRob2RzCk9ULiQudXNlTG9nSGVscGVycyhPVCk7CnZhciBfZGVidWdIZWFkZXJMb2dnZWQgPSBmYWxzZTsKdmFyIF9zZXRMb2dMZXZlbCA9IE9ULnNldExvZ0xldmVsOwoKLy8gT24gdGhlIGZpcnN0IHRpbWUgbG9nIGxldmVsIGlzIHNldCB0byBERUJVRyAob3IgaGlnaGVyKSBzaG93IHZlcnNpb24gaW5mby4KT1Quc2V0TG9nTGV2ZWwgPSBmdW5jdGlvbihsZXZlbCkgewogICAgLy8gU2V0IE9ULiQgdG8gdGhlIHNhbWUgbG9nIGxldmVsCiAgICBPVC4kLnNldExvZ0xldmVsKGxldmVsKTsKICAgIHZhciByZXRWYWwgPSBfc2V0TG9nTGV2ZWwuY2FsbChPVCwgbGV2ZWwpOwogICAgaWYgKE9ULnNob3VsZExvZyhPVC5ERUJVRykgJiYgIV9kZWJ1Z0hlYWRlckxvZ2dlZCkgewogICAgICAgIE9ULmRlYnVnKCJPcGVuVG9rIEphdmFTY3JpcHQgbGlicmFyeSAiICsgT1QucHJvcGVydGllcy52ZXJzaW9uKTsKICAgICAgICBPVC5kZWJ1ZygiUmVsZWFzZSBub3RlczogIiArIE9ULnByb3BlcnRpZXMud2Vic2l0ZVVSTCAgKyIvb3BlbnRvay93ZWJydGMvZG9jcy9qcy9yZWxlYXNlLW5vdGVzLmh0bWwiKTsKICAgICAgICBPVC5kZWJ1ZygiS25vd24gaXNzdWVzOiAiICsgT1QucHJvcGVydGllcy53ZWJzaXRlVVJMICsgIi9vcGVudG9rL3dlYnJ0Yy9kb2NzL2pzL3JlbGVhc2Utbm90ZXMuaHRtbCNrbm93bklzc3VlcyIpOwogICAgICAgIF9kZWJ1Z0hlYWRlckxvZ2dlZCA9IHRydWU7CiAgICB9CiAgICBPVC5kZWJ1ZygiVEIuc2V0TG9nTGV2ZWwoIiArIHJldFZhbCArICIpIik7CiAgICByZXR1cm4gcmV0VmFsOwp9OwoKT1Quc2V0TG9nTGV2ZWwoT1QucHJvcGVydGllcy5kZWJ1ZyA/IE9ULkRFQlVHIDogT1QuRVJST1IpOwoKLyoqCiogU2V0cyB0aGUgQVBJIGxvZyBsZXZlbC4KKiA8cD4KKiBDYWxsaW5nIDxjb2RlPlRCLnNldExvZ0xldmVsKCk8L2NvZGU+IHNldHMgdGhlIGxvZyBsZXZlbCBmb3IgcnVudGltZSBsb2cgbWVzc2FnZXMgdGhhdCBhcmUgdGhlIE9wZW5Ub2sgbGlicmFyeSBnZW5lcmF0ZXMuCiogVGhlIGRlZmF1bHQgdmFsdWUgZm9yIHRoZSBsb2cgbGV2ZWwgaXMgPGNvZGU+VEIuRVJST1I8L2NvZGU+LgoqIDwvcD4KKiA8cD4KKiBUaGUgT3BlblRvayBKYXZhU2NyaXB0IGxpYnJhcnkgZGlzcGxheXMgbG9nIG1lc3NhZ2VzIGluIHRoZSBkZWJ1Z2dlciBjb25zb2xlIChzdWNoIGFzIEZpcmVidWcpLCBpZiBvbmUgZXhpc3RzLgoqIDwvcD4KKiA8cD4KKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgbG9ncyB0aGUgc2Vzc2lvbiBJRCB0byB0aGUgY29uc29sZSwgYnkgY2FsbGluZyA8Y29kZT5UQi5sb2coKTwvY29kZT4uIFRoZSBjb2RlIGFsc28gbG9ncwoqIGFuIGVycm9yIG1lc3NhZ2Ugd2hlbiBpdCBhdHRlbXB0cyB0byBwdWJsaXNoIGEgc3RyZWFtIGJlZm9yZSB0aGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhCiogPGNvZGU+c2Vzc2lvbkNvbm5lY3RlZDwvY29kZT4gZXZlbnQuCiogPC9wPgoqIDxwcmU+CiogVEIuc2V0TG9nTGV2ZWwoVEIuTE9HKTsKKiBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklkKTsKKiBUQi5sb2coc2Vzc2lvbklkKTsKKiBwdWJsaXNoZXIgPSBUQi5pbml0UHVibGlzaGVyKEFQSV9LRVksICJwdWJsaXNoQ29udGFpbmVyIik7Ciogc2Vzc2lvbi5wdWJsaXNoKHB1Ymxpc2hlcik7CiogPC9wcmU+CioKKiBAcGFyYW0ge051bWJlcn0gbG9nTGV2ZWwgVGhlIGRlZ3JlZSBvZiBsb2dnaW5nIGRlc2lyZWQgYnkgdGhlIGRldmVsb3BlcjoKKgoqIDxwPgoqIDx1bD4KKiAgIDxsaT4KKiAgICAgPGNvZGU+VEIuTk9ORTwvY29kZT4gJiMxNTE7IEFQSSBsb2dnaW5nIGlzIGRpc2FibGVkLgoqICAgPC9saT4KKiAgIDxsaT4KKiAgICAgPGNvZGU+VEIuRVJST1I8L2NvZGU+ICYjMTUxOyBMb2dnaW5nIG9mIGVycm9ycyBvbmx5LgoqICAgPC9saT4KKiAgIDxsaT4KKiAgICAgPGNvZGU+VEIuV0FSTjwvY29kZT4gJiMxNTE7IExvZ2dpbmcgb2Ygd2FybmluZ3MgYW5kIGVycm9ycy4KKiAgIDwvbGk+CiogICA8bGk+CiogICAgIDxjb2RlPlRCLklORk88L2NvZGU+ICYjMTUxOyBMb2dnaW5nIG9mIG90aGVyIHVzZWZ1bCBpbmZvcm1hdGlvbiwgaW4gYWRkaXRpb24gdG8gd2FybmluZ3MgYW5kIGVycm9ycy4KKiAgIDwvbGk+CiogICA8bGk+CiogICAgIDxjb2RlPlRCLkxPRzwvY29kZT4gJiMxNTE7IExvZ2dpbmcgb2YgPGNvZGU+VEIubG9nKCk8L2NvZGU+IG1lc3NhZ2VzLCBpbiBhZGRpdGlvbiB0byBPcGVuVG9rIGluZm8sIHdhcm5pbmcsCiogICAgIGFuZCBlcnJvciBtZXNzYWdlcy4KKiAgIDwvbGk+CiogICA8bGk+CiogICAgIDxjb2RlPlRCLkRFQlVHPC9jb2RlPiAmIzE1MTsgRmluZS1ncmFpbmVkIGxvZ2dpbmcgb2YgYWxsIEFQSSBhY3Rpb25zLCBhcyB3ZWxsIGFzIDxjb2RlPlRCLmxvZygpPC9jb2RlPiBtZXNzYWdlcy4KKiAgIDwvbGk+CiogPC91bD4KKiA8L3A+CioKKiBAbmFtZSBUQi5zZXRMb2dMZXZlbAoqIEBtZW1iZXJvZiBUQgoqIEBmdW5jdGlvbgoqIEBzZWUgPGEgaHJlZj0iI2xvZyI+VEIubG9nKCk8L2E+CiovCgovKioKKiBTZW5kcyBhIHN0cmluZyB0byB0aGUgdGhlIGRlYnVnZ2VyIGNvbnNvbGUgKHN1Y2ggYXMgRmlyZWJ1ZyksIGlmIG9uZSBleGlzdHMuIEhvd2V2ZXIsIHRoZSBmdW5jdGlvbgoqIG9ubHkgbG9ncyB0byB0aGUgY29uc29sZSBpZiB5b3UgaGF2ZSBzZXQgdGhlIGxvZyBsZXZlbCB0byA8Y29kZT5UQi5MT0c8L2NvZGU+IG9yIDxjb2RlPlRCLkRFQlVHPC9jb2RlPiwKKiBieSBjYWxsaW5nIDxjb2RlPlRCLnNldExvZ0xldmVsKFRCLkxPRyk8L2NvZGU+IG9yIDxjb2RlPlRCLnNldExvZ0xldmVsKFRCLkRFQlVHKTwvY29kZT4uCioKKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgc3RyaW5nIHRvIGxvZy4KKgoqIEBuYW1lIFRCLmxvZwoqIEBtZW1iZXJvZiBUQgoqIEBmdW5jdGlvbgoqIEBzZWUgPGEgaHJlZj0iI3NldExvZ0xldmVsIj5UQi5zZXRMb2dMZXZlbCgpPC9hPgoqLwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gSU1QT1JUQU5UIFRoaXMgZmlsZSBzaG91bGQgYmUgaW5jbHVkZWQgc3RyYWlnaHQgYWZ0ZXIgaGVscGVycy5qcwppZiAoIXdpbmRvdy5PVCkgd2luZG93Lk9UID0ge307CgppZiAoIU9ULnByb3BlcnRpZXMpIHsKICB0aHJvdyBuZXcgRXJyb3IoIk9ULnByb3BlcnRpZXMgZG9lcyBub3QgZXhpc3QsIHBsZWFzZSBlbnN1cmUgdGhhdCB5b3UgaW5jbHVkZSBhIHZhbGlkIHByb3BlcnRpZXMgZmlsZS4iKTsKfQoKLy8gQ29uc3VtZXMgYW5kIG92ZXJ3cml0ZXMgT1QucHJvcGVydGllcy4gTWFrZXMgaXQgYmV0dGVyIGFuZCBzdHJvbmdlciEKT1QucHJvcGVydGllcyA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsKICAgIHZhciBwcm9wcyA9IE9ULiQuY2xvbmUocHJvcGVydGllcyk7CgogICAgcHJvcHMuZGVidWcgPSBwcm9wZXJ0aWVzLmRlYnVnID09PSAndHJ1ZScgfHwgcHJvcGVydGllcy5kZWJ1ZyA9PT0gdHJ1ZTsKICAgIHByb3BzLnN1cHBvcnRTU0wgPSBwcm9wZXJ0aWVzLnN1cHBvcnRTU0wgPT09ICd0cnVlJyB8fCBwcm9wZXJ0aWVzLnN1cHBvcnRTU0wgPT09IHRydWU7CgogICAgaWYgKHByb3BzLnN1cHBvcnRTU0wgJiYgKHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbC5pbmRleE9mKCJodHRwcyIpID49IDAgfHwgd2luZG93LmxvY2F0aW9uLnByb3RvY29sLmluZGV4T2YoImNocm9tZS1leHRlbnNpb24iKSA+PSAwKSkgewogICAgICAgIHByb3BzLmFzc2V0VVJMID0gcHJvcHMuY2RuVVJMU1NMICsgIi93ZWJydGMvIiArIHByb3BzLnZlcnNpb247CiAgICAgICAgcHJvcHMubG9nZ2luZ1VSTCA9IHByb3BzLmxvZ2dpbmdVUkxTU0w7CiAgICAgICAgcHJvcHMuYXBpVVJMID0gcHJvcHMuYXBpVVJMU1NMOwogICAgfSBlbHNlIHsKICAgICAgICBwcm9wcy5hc3NldFVSTCA9IHByb3BzLmNkblVSTCArICIvd2VicnRjLyIgKyBwcm9wcy52ZXJzaW9uOwogICAgfQoKICAgIHByb3BzLmNvbmZpZ1VSTCA9IHByb3BzLmFzc2V0VVJMICsgIi9qcy9keW5hbWljX2NvbmZpZy5taW4uanMiOwogICAgcHJvcHMuY3NzVVJMID0gcHJvcHMuYXNzZXRVUkwgKyAiL2Nzcy9vdC5taW4uY3NzIjsKCiAgICByZXR1cm4gcHJvcHM7Cn0oT1QucHJvcGVydGllcyk7Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7CgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIEpTIER5bmFtaWMgQ29uZmlnCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCgpPVC5Db25maWcgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgX2xvYWRlZCA9IGZhbHNlLAogICAgICAgIF9nbG9iYWwgPSB7fSwKICAgICAgICBfcGFydG5lcnMgPSB7fSwKICAgICAgICBfc2NyaXB0LAogICAgICAgIF9oZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLAogICAgICAgIF9sb2FkVGltZXIsCgogICAgICAgIF9jbGVhclRpbWVvdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF9sb2FkVGltZXIpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChfbG9hZFRpbWVyKTsKICAgICAgICAgICAgICAgIF9sb2FkVGltZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NsZWFudXAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2NsZWFyVGltZW91dCgpOwoKICAgICAgICAgICAgaWYgKF9zY3JpcHQpIHsKICAgICAgICAgICAgICAgIF9zY3JpcHQub25sb2FkID0gX3NjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKICAgICAgICAgICAgICAgIGlmICggX2hlYWQgJiYgX3NjcmlwdC5wYXJlbnROb2RlICkgewogICAgICAgICAgICAgICAgICAgIF9oZWFkLnJlbW92ZUNoaWxkKCBfc2NyaXB0ICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgX3NjcmlwdCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9vbkxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gT25seSBJRSBhbmQgT3BlcmEgYWN0dWFsbHkgc3VwcG9ydCByZWFkeVN0YXRlIG9uIFNjcmlwdCBlbGVtZW50cy4KICAgICAgICAgICAgaWYgKF9zY3JpcHQucmVhZHlTdGF0ZSAmJiAhL2xvYWRlZHxjb21wbGV0ZS8udGVzdCggX3NjcmlwdC5yZWFkeVN0YXRlICkpIHsKICAgICAgICAgICAgICAgIC8vIFllYWgsIHdlJ3JlIG5vdCByZWFkeSB5ZXQuLi4KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NsZWFyVGltZW91dCgpOwoKICAgICAgICAgICAgaWYgKCFfbG9hZGVkKSB7CiAgICAgICAgICAgICAgICAvLyBPdXIgY29uZmlnIHNjcmlwdCBpcyBsb2FkZWQgYnV0IHRoZXJlIGlzIG5vdCBjb25maWcgKGFzCiAgICAgICAgICAgICAgICAvLyByZXBsYWNlV2l0aCB3YXNuJ3QgY2FsbGVkKS4gU29tZXRoaW5nIHdlbnQgd3JvbmcuIFBvc3NpYmx5CiAgICAgICAgICAgICAgICAvLyB0aGUgZmlsZSB3ZSBsb2FkZWQgd2Fzbid0IGFjdHVhbGx5IGEgdmFsaWQgY29uZmlnIGZpbGUuCiAgICAgICAgICAgICAgICBfdGhpcy5fb25Mb2FkVGltZW91dCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2dldE1vZHVsZSA9IGZ1bmN0aW9uKG1vZHVsZU5hbWUsIGFwaUtleSkgewogICAgICAgICAgICBpZiAoYXBpS2V5ICYmIF9wYXJ0bmVyc1thcGlLZXldICYmIF9wYXJ0bmVyc1thcGlLZXldW21vZHVsZU5hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3BhcnRuZXJzW2FwaUtleV1bbW9kdWxlTmFtZV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBfZ2xvYmFsW21vZHVsZU5hbWVdOwogICAgICAgIH0sCgogICAgICAgIF90aGlzID0gewogICAgICAgICAgICAvLyBJbiBtcwogICAgICAgICAgICBsb2FkVGltZW91dDogNDAwMCwKCiAgICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uKGNvbmZpZ1VybCkgewogICAgICAgICAgICAgICAgaWYgKCFjb25maWdVcmwpIHRocm93IG5ldyBFcnJvcigiWW91IG11c3QgcGFzcyBhIHZhbGlkIGNvbmZpZ1VybCB0byBDb25maWcubG9hZCIpOwoKICAgICAgICAgICAgICAgIF9sb2FkZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIF9zY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic2NyaXB0IiApOwogICAgICAgICAgICAgICAgICAgIF9zY3JpcHQuYXN5bmMgPSAiYXN5bmMiOwogICAgICAgICAgICAgICAgICAgIF9zY3JpcHQuc3JjID0gY29uZmlnVXJsOwogICAgICAgICAgICAgICAgICAgIF9zY3JpcHQub25sb2FkID0gX3NjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBfb25Mb2FkLmJpbmQodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgX2hlYWQuYXBwZW5kQ2hpbGQoX3NjcmlwdCk7CiAgICAgICAgICAgICAgICB9LDEpOwoKICAgICAgICAgICAgICAgIF9sb2FkVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLl9vbkxvYWRUaW1lb3V0KCk7CiAgICAgICAgICAgICAgICB9LCB0aGlzLmxvYWRUaW1lb3V0KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9vbkxvYWRUaW1lb3V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIF9jbGVhbnVwKCk7CgogICAgICAgICAgICAgICAgT1Qud2FybigiVEIgRHluYW1pY0NvbmZpZyBmYWlsZWQgdG8gbG9hZCBpbiAiICsgX3RoaXMubG9hZFRpbWVvdXQgKyAiIG1zIik7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2R5bmFtaWNDb25maWdMb2FkRmFpbGVkJyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpc0xvYWRlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX2xvYWRlZDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIF9jbGVhbnVwKCk7CiAgICAgICAgICAgICAgICBfbG9hZGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBfZ2xvYmFsID0ge307CiAgICAgICAgICAgICAgICBfcGFydG5lcnMgPSB7fTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIFRoaXMgaXMgcHVibGljIHNvIHRoYXQgdGhlIGR5bmFtaWMgY29uZmlnIGZpbGUgY2FuIGxvYWQgaXRzZWxmLgogICAgICAgICAgICAvLyBVc2luZyBpdCBmb3Igb3RoZXIgcHVycG9zZXMgaXMgZGlzY291cmFnZWQsIGJ1dCBub3QgZm9yYmlkZGVuLgogICAgICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgICAgICBfY2xlYW51cCgpOwoKICAgICAgICAgICAgICAgIGlmICghY29uZmlnKSBjb25maWcgPSB7fTsKCiAgICAgICAgICAgICAgICBfZ2xvYmFsID0gY29uZmlnLmdsb2JhbCB8fCB7fTsKICAgICAgICAgICAgICAgIF9wYXJ0bmVycyA9IGNvbmZpZy5wYXJ0bmVycyB8fCB7fTsKCiAgICAgICAgICAgICAgICBpZiAoIV9sb2FkZWQpIF9sb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdkeW5hbWljQ29uZmlnQ2hhbmdlZCcpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gQGV4YW1wbGUgR2V0IHRoZSB2YWx1ZSB0aGF0IGluZGljYXRlcyB3aGV0aGVyIGV4Y2VwdGlvbkxvZ2dpbmcgaXMgZW5hYmxlZAogICAgICAgICAgICAvLyAgT1QuQ29uZmlnLmdldCgnZXhjZXB0aW9uTG9nZ2luZycsICdlbmFibGVkJyk7CiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEBleGFtcGxlIEdldCBhIGtleSBmb3IgYSBzcGVjaWZpYyBwYXJ0bmVyLCBmYWxsYmFjayB0byB0aGUgZGVmYXVsdCBpZiB0aGVyZSBpcwogICAgICAgICAgICAvLyBubyBrZXkgZm9yIHRoYXQgcGFydG5lcgogICAgICAgICAgICAvLyAgT1QuQ29uZmlnLmdldCgnZXhjZXB0aW9uTG9nZ2luZycsICdlbmFibGVkJywgJ2FwaUtleScpOwogICAgICAgICAgICAvLwogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKG1vZHVsZU5hbWUsIGtleSwgYXBpS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kdWxlID0gX2dldE1vZHVsZShtb2R1bGVOYW1lLCBhcGlLZXkpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZSA/IG1vZHVsZVtrZXldIDogbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgT1QuJC5ldmVudGluZyhfdGhpcyk7CgogICAgcmV0dXJuIF90aGlzOwp9KSgpOwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKdmFyIGRlZmF1bHRBc3BlY3RSYXRpbyA9IDQuMC8zLjA7CgovLyBUaGlzIGNvZGUgcG9zaXRpb25zIHRoZSB2aWRlbyBlbGVtZW50IHNvIHRoYXQgd2UgZG9uJ3QgZ2V0IGFueSBsZXR0ZXJib3hpbmcuCi8vIEl0IHdpbGwgdGFrZSBpbnRvIGNvbnNpZGVyYXRpb24gYXNwZWN0IHJhdGlvcyBvdGhlciB0aGFuIDQvMyBidXQgb25seSB3aGVuCi8vIHRoZSB2aWRlbyBlbGVtZW50IGlzIGZpcnN0IGNyZWF0ZWQuIElmIHRoZSBhc3BlY3QgcmF0aW8gY2hhbmdlcyBhdCBhIGxhdGVyIHBvaW50Ci8vIHRoaXMgY2FsY3VsYXRpb24gd2lsbCBiZWNvbWUgaW5jb3JyZWN0LgpmdW5jdGlvbiBmaXhBc3BlY3RSYXRpbyhlbGVtZW50LCB3aWR0aCwgaGVpZ2h0LCBkZXNpcmVkQXNwZWN0UmF0aW8sIHJvdGF0ZWQpIHsKICAgIGlmICghd2lkdGgpIHdpZHRoID0gcGFyc2VJbnQoT1QuJC53aWR0aChlbGVtZW50LnBhcmVudE5vZGUpLCAxMCk7CiAgICBlbHNlIHdpZHRoID0gcGFyc2VJbnQod2lkdGgsIDEwKTsKCiAgICBpZiAoIWhlaWdodCkgaGVpZ2h0ID0gcGFyc2VJbnQoT1QuJC5oZWlnaHQoZWxlbWVudC5wYXJlbnROb2RlKSwgMTApOwogICAgZWxzZSBoZWlnaHQgPSBwYXJzZUludChoZWlnaHQsIDEwKTsKCiAgICBpZiAod2lkdGggPT09IDAgfHwgaGVpZ2h0ID09PSAwKSByZXR1cm47CgogICAgaWYgKCFkZXNpcmVkQXNwZWN0UmF0aW8pIGRlc2lyZWRBc3BlY3RSYXRpbyA9IGRlZmF1bHRBc3BlY3RSYXRpbzsKCiAgICB2YXIgYWN0dWFsUmF0aW8gPSAod2lkdGggKyAwLjApL2hlaWdodCwKICAgICAgICBwcm9wcyA9IHsKICAgICAgICAgICAgd2lkdGg6ICcxMDAlJywKICAgICAgICAgICAgaGVpZ2h0OiAnMTAwJScsCiAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgIHRvcDogMAogICAgICAgIH07CgogICAgaWYgKGFjdHVhbFJhdGlvID4gZGVzaXJlZEFzcGVjdFJhdGlvKSB7CiAgICAgICAgLy8gV2lkdGggaXMgbGFyZ2VzdCBzbyB3ZSBibG93IHVwIHRoZSBoZWlnaHQgc28gd2UgZG9uJ3QgaGF2ZSBsZXR0ZXJib3hpbmcKICAgICAgICB2YXIgbmV3SGVpZ2h0ID0gKGFjdHVhbFJhdGlvIC8gZGVzaXJlZEFzcGVjdFJhdGlvKSAqIDEwMDsKCiAgICAgICAgcHJvcHMuaGVpZ2h0ID0gbmV3SGVpZ2h0ICsgJyUnOwogICAgICAgIHByb3BzLnRvcCA9ICctJyArICgobmV3SGVpZ2h0IC0gMTAwKSAvIDIpICsgJyUnOwogICAgfSBlbHNlIGlmIChhY3R1YWxSYXRpbyA8IGRlc2lyZWRBc3BlY3RSYXRpbykgewogICAgICAgIC8vIEhlaWdodCBpcyBsYXJnZXN0LCBibG93IHVwIHRoZSB3aWR0aAogICAgICAgIHZhciBuZXdXaWR0aCA9IChkZXNpcmVkQXNwZWN0UmF0aW8gLyBhY3R1YWxSYXRpbykgKiAxMDA7CgogICAgICAgIHByb3BzLndpZHRoID0gbmV3V2lkdGggKyAnJSc7CiAgICAgICAgcHJvcHMubGVmdCA9ICctJyArICgobmV3V2lkdGggLSAxMDApIC8gMikgKyAnJSc7CiAgICB9CgogICAgT1QuJC5jc3MoZWxlbWVudCwgcHJvcHMpOwoKICAgIHZhciB2aWRlbyA9IGVsZW1lbnQucXVlcnlTZWxlY3RvcigndmlkZW8nKTsKICAgIGlmKHZpZGVvKSB7CiAgICAgICAgaWYocm90YXRlZCkgewogICAgICAgICAgICB2YXIgdyA9IGVsZW1lbnQub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgICBoID0gZWxlbWVudC5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgICAgICBwcm9wcyA9IHsgd2lkdGg6IGggKyAncHgnLCBoZWlnaHQ6IHcgKyAncHgnLCBtYXJnaW5Ub3A6ICcnLCBtYXJnaW5MZWZ0OiAnJyB9LAogICAgICAgICAgICAgICAgZGlmZiA9IHcgLSBoOwogICAgICAgICAgICAgICAgcHJvcHMubWFyZ2luTGVmdCA9IChkaWZmIC8gMikgKyAncHgnOwogICAgICAgICAgICAgICAgcHJvcHMubWFyZ2luVG9wID0gLShkaWZmIC8gMikgKyAncHgnOwogICAgICAgICAgICAgICAgT1QuJC5jc3ModmlkZW8sIHByb3BzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBPVC4kLmNzcyh2aWRlbywgeyB3aWR0aDogJycsIGhlaWdodDogJycsIG1hcmdpblRvcDogJycsIG1hcmdpbkxlZnQ6ICcnfSk7CiAgICAgICAgfQogICAgfQoKfQoKdmFyIGdldE9yQ3JlYXRlQ29udGFpbmVyID0gZnVuY3Rpb24gZ2V0T3JDcmVhdGVDb250YWluZXIoZWxlbWVudE9yRG9tSWQsIGluc2VydE1vZGUpIHsKICAgIHZhciBjb250YWluZXIsCiAgICAgICAgZG9tSWQ7CgogICAgaWYgKGVsZW1lbnRPckRvbUlkICYmIGVsZW1lbnRPckRvbUlkLm5vZGVOYW1lKSB7CiAgICAgICAgLy8gSXQgbG9va3MgbGlrZSB3ZSB3ZXJlIGdpdmVuIGEgRE9NIGVsZW1lbnQuIEdyYWIgdGhlIGlkIG9yIGdlbmVyYXRlCiAgICAgICAgLy8gb25lIGlmIGl0IGRvZXNuJ3QgaGF2ZSBvbmUuCiAgICAgICAgY29udGFpbmVyID0gZWxlbWVudE9yRG9tSWQ7CiAgICAgICAgaWYgKCFjb250YWluZXIuZ2V0QXR0cmlidXRlKCdpZCcpIHx8IGNvbnRhaW5lci5nZXRBdHRyaWJ1dGUoJ2lkJykubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoJ2lkJywgJ09UXycgKyBPVC4kLnV1aWQoKSk7CiAgICAgICAgfQoKICAgICAgICBkb21JZCA9IGNvbnRhaW5lci5nZXRBdHRyaWJ1dGUoJ2lkJyk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICAvLyBXZSBtYXkgaGF2ZSBnb3QgYW4gaWQsIHRyeSBhbmQgZ2V0IGl0J3MgRE9NIGVsZW1lbnQuCiAgICAgICAgY29udGFpbmVyID0gT1QuJChlbGVtZW50T3JEb21JZCk7CiAgICAgICAgZG9tSWQgPSBlbGVtZW50T3JEb21JZCB8fCAoJ09UXycgKyBPVC4kLnV1aWQoKSk7CiAgICB9CgogICAgaWYgKCFjb250YWluZXIpIHsKICAgICAgICBjb250YWluZXIgPSBPVC4kLmNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtpZDogZG9tSWR9KTsKICAgICAgICBjb250YWluZXIuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gIiMwMDAwMDAiOwogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIE9ULiQuZW1wdHlFbGVtZW50KGNvbnRhaW5lcik7CiAgICB9CgogICAgaWYoIShpbnNlcnRNb2RlID09IG51bGwgfHwgaW5zZXJ0TW9kZSA9PSAncmVwbGFjZScpKSB7CiAgICAgIHZhciBwbGFjZWhvbGRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBwbGFjZWhvbGRlci5pZCA9ICgnT1RfJyArIE9ULiQudXVpZCgpKTsKICAgICAgaWYoaW5zZXJ0TW9kZSA9PSAnYXBwZW5kJykgewogICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChwbGFjZWhvbGRlcik7CiAgICAgICAgY29udGFpbmVyID0gcGxhY2Vob2xkZXI7CiAgICAgIH0gZWxzZSBpZihpbnNlcnRNb2RlID09ICdiZWZvcmUnKSB7CiAgICAgICAgY29udGFpbmVyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCBjb250YWluZXIpOwogICAgICAgIGNvbnRhaW5lciA9IHBsYWNlaG9sZGVyOwogICAgICB9IGVsc2UgaWYoaW5zZXJ0TW9kZSA9PSAnYWZ0ZXInKSB7CiAgICAgICAgY29udGFpbmVyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCBjb250YWluZXIubmV4dFNpYmxpbmcpOwogICAgICAgIGNvbnRhaW5lciA9IHBsYWNlaG9sZGVyOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNvbnRhaW5lcjsKfTsKCi8vIENyZWF0ZXMgdGhlIHN0YW5kYXJkIGNvbnRhaW5lciB0aGF0IHRoZSBTdWJzY3JpYmVyIGFuZCBQdWJsaXNoZXIgdXNlIHRvIGhvbGQKLy8gdGhlaXIgdmlkZW8gZWxlbWVudCBhbmQgb3RoZXIgY2hyb21lLgpPVC5XaWRnZXRWaWV3ID0gZnVuY3Rpb24odGFyZ2V0RWxlbWVudCwgcHJvcGVydGllcykgewogICAgdmFyIGNvbnRhaW5lciA9IGdldE9yQ3JlYXRlQ29udGFpbmVyKHRhcmdldEVsZW1lbnQsIHByb3BlcnRpZXMgJiYgcHJvcGVydGllcy5pbnNlcnRNb2RlKSwKICAgICAgICB2aWRlb0NvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgICAgIG9sZENvbnRhaW5lclN0eWxlcyA9IHt9LAogICAgICAgIGRpbWVuc2lvbnNPYnNlcnZlciwKICAgICAgICB2aWRlb0VsZW1lbnQsCiAgICAgICAgdmlkZW9PYnNlcnZlciwKICAgICAgICBwb3N0ZXJDb250YWluZXIsCiAgICAgICAgbG9hZGluZ0NvbnRhaW5lciwKICAgICAgICBsb2FkaW5nID0gdHJ1ZTsKCiAgICBpZiAocHJvcGVydGllcykgewogICAgICAgIHdpZHRoID0gcHJvcGVydGllcy53aWR0aDsKICAgICAgICBoZWlnaHQgPSBwcm9wZXJ0aWVzLmhlaWdodDsKCiAgICAgICAgaWYgKHdpZHRoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Yod2lkdGgpID09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICB3aWR0aCA9IHdpZHRoICsgInB4IjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGhlaWdodCkgewogICAgICAgICAgICBpZiAodHlwZW9mKGhlaWdodCkgPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGhlaWdodCA9IGhlaWdodCArICJweCI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbnRhaW5lci5zdHlsZS53aWR0aCA9IHdpZHRoID8gd2lkdGggOiAiMjY0cHgiOwogICAgICAgIGNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgPyBoZWlnaHQgOiAiMTk4cHgiOwogICAgICAgIGNvbnRhaW5lci5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwoKICAgICAgICBpZiAocHJvcGVydGllcy5taXJyb3IgPT09IHVuZGVmaW5lZCB8fCBwcm9wZXJ0aWVzLm1pcnJvcikgT1QuJC5hZGRDbGFzcyhjb250YWluZXIsICdPVF9taXJyb3JlZCcpOwogICAgfQoKICAgIGlmIChwcm9wZXJ0aWVzLmNsYXNzTmFtZXMpIE9ULiQuYWRkQ2xhc3MoY29udGFpbmVyLCBwcm9wZXJ0aWVzLmNsYXNzTmFtZXMpOwogICAgT1QuJC5hZGRDbGFzcyhjb250YWluZXIsICdPVF9sb2FkaW5nJyk7CgoKICAgIE9ULiQuYWRkQ2xhc3ModmlkZW9Db250YWluZXIsICdPVF92aWRlby1jb250YWluZXInKTsKICAgIHZpZGVvQ29udGFpbmVyLnN0eWxlLndpZHRoID0gY29udGFpbmVyLnN0eWxlLndpZHRoOwogICAgdmlkZW9Db250YWluZXIuc3R5bGUuaGVpZ2h0ID0gY29udGFpbmVyLnN0eWxlLmhlaWdodDsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh2aWRlb0NvbnRhaW5lcik7CiAgICBmaXhBc3BlY3RSYXRpbyh2aWRlb0NvbnRhaW5lciwgY29udGFpbmVyLm9mZnNldFdpZHRoLCBjb250YWluZXIub2Zmc2V0SGVpZ2h0KTsKCiAgICBsb2FkaW5nQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBPVC4kLmFkZENsYXNzKGxvYWRpbmdDb250YWluZXIsICJPVF92aWRlby1sb2FkaW5nIik7CiAgICB2aWRlb0NvbnRhaW5lci5hcHBlbmRDaGlsZChsb2FkaW5nQ29udGFpbmVyKTsKCiAgICBwb3N0ZXJDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIE9ULiQuYWRkQ2xhc3MocG9zdGVyQ29udGFpbmVyLCAiT1RfdmlkZW8tcG9zdGVyIik7CiAgICB2aWRlb0NvbnRhaW5lci5hcHBlbmRDaGlsZChwb3N0ZXJDb250YWluZXIpOwoKICAgIG9sZENvbnRhaW5lclN0eWxlcy53aWR0aCA9IGNvbnRhaW5lci5vZmZzZXRXaWR0aDsKICAgIG9sZENvbnRhaW5lclN0eWxlcy5oZWlnaHQgPSBjb250YWluZXIub2Zmc2V0SGVpZ2h0OwoKICAgIC8vIE9ic2VydmUgY2hhbmdlcyB0byB0aGUgd2lkdGggYW5kIGhlaWdodCBhbmQgdXBkYXRlIHRoZSBhc3BlY3QgcmF0aW8KICAgIGRpbWVuc2lvbnNPYnNlcnZlciA9IE9ULiQub2JzZXJ2ZVN0eWxlQ2hhbmdlcyhjb250YWluZXIsIFsnd2lkdGgnLCAnaGVpZ2h0J10sIGZ1bmN0aW9uKGNoYW5nZVNldCkgewogICAgICAgIHZhciB3aWR0aCA9IGNoYW5nZVNldC53aWR0aCA/IGNoYW5nZVNldC53aWR0aFsxXSA6IGNvbnRhaW5lci5vZmZzZXRXaWR0aCwKICAgICAgICAgICAgaGVpZ2h0ID0gY2hhbmdlU2V0LmhlaWdodCA/IGNoYW5nZVNldC5oZWlnaHRbMV0gOiBjb250YWluZXIub2Zmc2V0SGVpZ2h0OwoKICAgICAgICBmaXhBc3BlY3RSYXRpbyh2aWRlb0NvbnRhaW5lciwgd2lkdGgsIGhlaWdodCwgdmlkZW9FbGVtZW50ID8gdmlkZW9FbGVtZW50LmFzcGVjdFJhdGlvIDogbnVsbCk7CiAgICB9KTsKCgogICAgLy8gQHRvZG8gb2JzZXJ2ZSBpZiB0aGUgdmlkZW8gY29udGFpbmVyIG9yIHRoZSB2aWRlbyBlbGVtZW50IGdldCByZW1vdmVkLCBpZiB0aGV5IGRvIHdlIHNob3VsZCBkbyBzb21lIGNsZWFudXAKICAgIHZpZGVvT2JzZXJ2ZXIgPSBPVC4kLm9ic2VydmVOb2RlT3JDaGlsZE5vZGVSZW1vdmFsKGNvbnRhaW5lciwgZnVuY3Rpb24ocmVtb3ZlZE5vZGVzKSB7CiAgICAgICAgaWYgKCF2aWRlb0VsZW1lbnQpIHJldHVybjsKCiAgICAgICAgLy8gVGhpcyBhc3N1bWVzIGEgdmlkZW8gZWxlbWVudCBiZWluZyByZW1vdmVkIGlzIHRoZSBtYWluIHZpZGVvIGVsZW1lbnQuIFRoaXMgbWF5CiAgICAgICAgLy8gbm90IGJlIHRoZSBjYXNlLgogICAgICAgIHZhciB2aWRlb1JlbW92ZWQgPSByZW1vdmVkTm9kZXMuc29tZShmdW5jdGlvbihub2RlKSB7IHJldHVybiBub2RlID09PSB2aWRlb0NvbnRhaW5lciB8fCBub2RlLm5vZGVOYW1lID09PSAnVklERU8nOyB9KTsKCiAgICAgICAgaWYgKHZpZGVvUmVtb3ZlZCkgewogICAgICAgICAgICB2aWRlb0VsZW1lbnQuZGVzdHJveSgpOwogICAgICAgICAgICB2aWRlb0VsZW1lbnQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZpZGVvQ29udGFpbmVyKSB7CiAgICAgICAgICAgIE9ULiQucmVtb3ZlRWxlbWVudCh2aWRlb0NvbnRhaW5lcik7CiAgICAgICAgICAgIHZpZGVvQ29udGFpbmVyID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChkaW1lbnNpb25zT2JzZXJ2ZXIpIHsKICAgICAgICAgICAgZGltZW5zaW9uc09ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgZGltZW5zaW9uc09ic2VydmVyID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh2aWRlb09ic2VydmVyKSB7CiAgICAgICAgICAgIHZpZGVvT2JzZXJ2ZXIuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB2aWRlb09ic2VydmVyID0gbnVsbDsKICAgICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGltZW5zaW9uc09ic2VydmVyKSB7CiAgICAgICAgICAgIGRpbWVuc2lvbnNPYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgIGRpbWVuc2lvbnNPYnNlcnZlciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodmlkZW9PYnNlcnZlcikgewogICAgICAgICAgICB2aWRlb09ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgdmlkZW9PYnNlcnZlciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodmlkZW9FbGVtZW50KSB7CiAgICAgICAgICAgIHZpZGVvRWxlbWVudC5kZXN0cm95KCk7CiAgICAgICAgICAgIHZpZGVvRWxlbWVudCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29udGFpbmVyKSB7CiAgICAgICAgICAgIE9ULiQucmVtb3ZlRWxlbWVudChjb250YWluZXIpOwogICAgICAgICAgICBjb250YWluZXIgPSBudWxsOwogICAgICAgIH0KICAgIH07CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewoKICAgICAgICBzaG93UG9zdGVyOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIU9ULiQuaXNEaXNwbGF5Tm9uZShwb3N0ZXJDb250YWluZXIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHNob3duKSB7CiAgICAgICAgICAgICAgICBpZihzaG93bikgewogICAgICAgICAgICAgICAgICAgIE9ULiQuc2hvdyhwb3N0ZXJDb250YWluZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgT1QuJC5oaWRlKHBvc3RlckNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwb3N0ZXI6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBPVC4kLmNzcyhwb3N0ZXJDb250YWluZXIsICJiYWNrZ3JvdW5kSW1hZ2UiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihzcmMpIHsKICAgICAgICAgICAgICAgIE9ULiQuY3NzKHBvc3RlckNvbnRhaW5lciwgImJhY2tncm91bmRJbWFnZSIsICJ1cmwoIiArIHNyYyArICIpIik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBsb2FkaW5nOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBsb2FkaW5nOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGwpIHsKICAgICAgICAgICAgICAgIGxvYWRpbmcgPSBsOwoKICAgICAgICAgICAgICAgIGlmIChsb2FkaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgT1QuJC5hZGRDbGFzcyhjb250YWluZXIsICdPVF9sb2FkaW5nJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBPVC4kLnJlbW92ZUNsYXNzKGNvbnRhaW5lciwgJ09UX2xvYWRpbmcnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHZpZGVvOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiB2aWRlb0VsZW1lbnQ7IH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmlkZW8pIHsKICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgb2xkIHZpZGVvIGVsZW1lbnQgaWYgaXQgZXhpc3RzCiAgICAgICAgICAgICAgICAvLyBAdG9kbyB0aGlzIG1pZ2h0IG5vdCBiZSBzYWZlLCBwdWJsaXNoZXJzL3N1YnNjcmliZXJzIHVzZSB0aGlzIGFzIHdlbGwuLi4KICAgICAgICAgICAgICAgIGlmICh2aWRlb0VsZW1lbnQpIHZpZGVvRWxlbWVudC5kZXN0cm95KCk7CgogICAgICAgICAgICAgICAgdmlkZW8uYXBwZW5kVG8odmlkZW9Db250YWluZXIpOwogICAgICAgICAgICAgICAgdmlkZW9FbGVtZW50ID0gdmlkZW87CgogICAgICAgICAgICAgICAgdmlkZW9FbGVtZW50Lm9uKHsKICAgICAgICAgICAgICAgICAgICBvcmllbnRhdGlvbkNoYW5nZWQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpeEFzcGVjdFJhdGlvKHZpZGVvQ29udGFpbmVyLCBjb250YWluZXIub2Zmc2V0V2lkdGgsIGNvbnRhaW5lci5vZmZzZXRIZWlnaHQsIHZpZGVvRWxlbWVudC5hc3BlY3RSYXRpbywgdmlkZW9FbGVtZW50LmlzUm90YXRlZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZml4QXNwZWN0UmF0aW8odmlkZW9Db250YWluZXIsIGNvbnRhaW5lci5vZmZzZXRXaWR0aCwgY29udGFpbmVyLm9mZnNldEhlaWdodCwgdmlkZW9FbGVtZW50ID8gdmlkZW9FbGVtZW50LmFzcGVjdFJhdGlvIDogbnVsbCwgdmlkZW9FbGVtZW50ID8gdmlkZW9FbGVtZW50LmlzUm90YXRlZCA6IG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZG9tRWxlbWVudDogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gY29udGFpbmVyOyB9CiAgICAgICAgfSwKCiAgICAgICAgZG9tSWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBjb250YWluZXIuZ2V0QXR0cmlidXRlKCdpZCcpOyB9CiAgICAgICAgfQogICAgfSk7CgogICAgdGhpcy5hZGRFcnJvciA9IGZ1bmN0aW9uKGVycm9yTXNnKSB7CiAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICI8cD4iICsgZXJyb3JNc2cgKyAiPHA+IjsKICAgICAgICBPVC4kLmFkZENsYXNzKGNvbnRhaW5lciwgIk9UX3N1YnNjcmliZXJfZXJyb3IiKTsKICAgIH07Cn07Cgp9KSh3aW5kb3cpOwovLyBXZWIgT1QgSGVscGVycwooZnVuY3Rpb24od2luZG93KSB7CgovLyBIYW5keSBjcm9zcy1icm93c2VyIGdldFVzZXJNZWRpYSBzaGltLiBJbnNwaXJlZCBieSBzb21lIGNvZGUgZnJvbSBBZGFtIEJhcnRoCnZhciBnZXRVc2VyTWVkaWEgPSAoZnVuY3Rpb24oKSB7CiAgICBpZiAobmF2aWdhdG9yLmdldFVzZXJNZWRpYSkgewogICAgICAgIHJldHVybiBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhLmJpbmQobmF2aWdhdG9yKTsKICAgIH0gZWxzZSBpZiAobmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSkgewogICAgICAgIHJldHVybiBuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhLmJpbmQobmF2aWdhdG9yKTsKICAgIH0gZWxzZSBpZiAobmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSkgewogICAgICAgIHJldHVybiBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhLmJpbmQobmF2aWdhdG9yKTsKICAgIH0KfSkoKTsKCgppZiAobmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSkgewogICAgLy8gU3R1YiBmb3IgZ2V0VmlkZW9UcmFja3MgZm9yIENocm9tZSA8IDI2CiAgICBpZiAoIXdlYmtpdE1lZGlhU3RyZWFtLnByb3RvdHlwZS5nZXRWaWRlb1RyYWNrcykgewogICAgICAgIHdlYmtpdE1lZGlhU3RyZWFtLnByb3RvdHlwZS5nZXRWaWRlb1RyYWNrcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy52aWRlb1RyYWNrczsKICAgICAgICB9OwogICAgfQoKICAgIC8vIFN0dWJzIGZvciBnZXRBdWRpb1RyYWNrcyBmb3IgQ2hyb21lIDwgMjYKICAgIGlmICghd2Via2l0TWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldEF1ZGlvVHJhY2tzKSB7CiAgICAgICAgd2Via2l0TWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldEF1ZGlvVHJhY2tzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmF1ZGlvVHJhY2tzOwogICAgICAgIH07CiAgICB9CgogICAgaWYgKCF3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TG9jYWxTdHJlYW1zKSB7CiAgICAgICAgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLmdldExvY2FsU3RyZWFtcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxTdHJlYW1zOwogICAgICAgIH07CiAgICB9CgogICAgaWYgKCF3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0UmVtb3RlU3RyZWFtcykgewogICAgICAgIHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRSZW1vdGVTdHJlYW1zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5yZW1vdGVTdHJlYW1zOwogICAgICAgIH07CiAgICB9Cn0KZWxzZSBpZiAobmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSkgewogICAgLy8gRmlyZWZveCA8IDIzIGRvZXNuJ3Qgc3VwcG9ydCBnZXQgVmlkZW8vQXVkaW8gdHJhY2tzLCB3ZSdsbCBqdXN0IHN0dWIgdGhlbSBvdXQgZm9yIG5vdy4KICAgIGlmICghTWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldFZpZGVvVHJhY2tzKSB7CiAgICAgICAgTWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldFZpZGVvVHJhY2tzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9OwogICAgfQoKICAgIGlmICghTWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldEF1ZGlvVHJhY2tzKSB7CiAgICAgICAgTWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldEF1ZGlvVHJhY2tzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9OwogICAgfQoKICAgIC8vIFRoaXMgd29uJ3Qgd29yayBhcyBtb3pSVENQZWVyQ29ubmVjdGlvbiBpcyBhIHdlaXJkIGludGVybmFsIEZpcmVmb3gKICAgIC8vIG9iamVjdCAoYSB3cmFwcGVkIG5hdGl2ZSBvYmplY3QgSSB0aGluaykuCiAgICAvLyBpZiAoIXdpbmRvdy5tb3pSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TG9jYWxTdHJlYW1zKSB7CiAgICAvLyAgICAgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRMb2NhbFN0cmVhbXMgPSBmdW5jdGlvbigpIHsKICAgIC8vICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxTdHJlYW1zOwogICAgLy8gICAgIH07CiAgICAvLyB9CgogICAgLy8gVGhpcyB3b24ndCB3b3JrIGFzIG1velJUQ1BlZXJDb25uZWN0aW9uIGlzIGEgd2VpcmQgaW50ZXJuYWwgRmlyZWZveAogICAgLy8gb2JqZWN0IChhIHdyYXBwZWQgbmF0aXZlIG9iamVjdCBJIHRoaW5rKS4KICAgIC8vIGlmICghd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRSZW1vdGVTdHJlYW1zKSB7CiAgICAvLyAgICAgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRSZW1vdGVTdHJlYW1zID0gZnVuY3Rpb24oKSB7CiAgICAvLyAgICAgICAgIHJldHVybiB0aGlzLnJlbW90ZVN0cmVhbXM7CiAgICAvLyAgICAgfTsKICAgIC8vIH0KfQoKCi8vIE1vemlsbGEgZXJyb3Igc3RyaW5ncyBhbmQgdGhlIGVxdWl2YWxlbnQgVzNDIG5hbWVzLiBOT1RfU1VQUE9SVEVEX0VSUk9SIGRvZXMgbm90Ci8vIGV4aXN0IGluIHRoZSBzcGVjIHJpZ2h0IG5vdywgc28gd2UnbGwgaW5jbHVkZSBNb3ppbGxhJ3MgZXJyb3IgZGVzY3JpcHRpb24uCnZhciBtb3pUb1czQ0Vycm9ycyA9IHsKICAgIFBFUk1JU1NJT05fREVOSUVEOiAnUEVSTUlTU0lPTl9ERU5JRUQnLAogICAgTk9UX1NVUFBPUlRFRF9FUlJPUjogIkEgY29uc3RyYWludCBzcGVjaWZpZWQgaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgYnJvd3Nlci4iLAogICAgTUFOREFUT1JZX1VOU0FUSVNGSUVEX0VSUk9SOiAnQ09OU1RSQUlOVF9OT1RfU0FUSVNGSUVEJwp9OwoKLy8gQ2hyb21lIG9ubHkgc2VlbXMgdG8gZXhwb3NlIGEgc2luZ2xlIGVycm9yIHdpdGggYSBjb2RlIG9mIDEgcmlnaHQgbm93Lgp2YXIgY2hyb21lVG9XM0NFcnJvcnMgPSB7CiAgICAxOiAnUEVSTUlTU0lPTl9ERU5JRUQnCn07CgoKdmFyIGd1bU5hbWVzVG9NZXNzYWdlcyA9IHsKICAgIFBFUk1JU1NJT05fREVOSUVEOiAiVXNlciBkZW5pZWQgcGVybWlzc2lvbiBmb3Igc2NyaXB0cyBmcm9tIHRoaXMgb3JpZ2luIHRvIGFjY2VzcyB0aGUgbWVkaWEgZGV2aWNlLiIsCiAgICBDT05TVFJBSU5UX05PVF9TQVRJU0ZJRUQ6ICJPbmUgb2YgdGhlIG1hbmRhdG9yeSBjb25zdHJhaW50cyBjb3VsZCBub3QgYmUgc2F0aXNmaWVkLiIKfTsKCi8vIE1hcCB2ZW5kb3IgZXJyb3Igc3RyaW5ncyB0byBuYW1lcyBhbmQgbWVzc2FnZXMKdmFyIG1hcFZlbmRvckVycm9yTmFtZSA9IGZ1bmN0aW9uIG1hcFZlbmRvckVycm9yTmFtZSAodmVuZG9yRXJyb3JOYW1lLCB2ZW5kb3JFcnJvcnMpIHsKICAgIHZhciBlcnJvck5hbWUgPSB2ZW5kb3JFcnJvcnNbdmVuZG9yRXJyb3JOYW1lXSwKICAgICAgICBlcnJvck1lc3NhZ2UgPSBndW1OYW1lc1RvTWVzc2FnZXNbZXJyb3JOYW1lXTsKCiAgICBpZiAoIWVycm9yTWVzc2FnZSkgewogICAgICAgIC8vIFRoaXMgZG9lc24ndCBtYXAgdG8gYSBrbm93biBlcnJvciBmcm9tIHRoZSBNZWRpYSBDYXB0dXJlIHNwZWMsIGl0J3MKICAgICAgICAvLyBwcm9iYWJseSBhIGN1c3RvbSB2ZW5kb3IgZXJyb3IgbWVzc2FnZS4KICAgICAgICBlcnJvck1lc3NhZ2UgPSBldmVudE5hbWU7CiAgICAgICAgZXJyb3JOYW1lID0gdmVuZG9yRXJyb3JOYW1lOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogZXJyb3JOYW1lLAogICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZQogICAgfTsKfTsKCi8vIFBhcnNlIGFuZCBub3JtYWxpc2UgYSBnZXRVc2VyTWVkaWEgZXJyb3IgZXZlbnQgZnJvbSBDaHJvbWUgb3IgTW96aWxsYQovLwovLyBAcmVmIGh0dHA6Ly9kZXYudzMub3JnLzIwMTEvd2VicnRjL2VkaXRvci9nZXR1c2VybWVkaWEuaHRtbCNpZGwtZGVmLU5hdmlnYXRvclVzZXJNZWRpYUVycm9yCi8vCnZhciBwYXJzZUVycm9yRXZlbnQgPSBmdW5jdGlvbiBwYXJzZUVycm9yT2JqZWN0IChldmVudCkgewogICAgdmFyIGVycm9yOwoKICAgIGlmIChPVC4kLmlzT2JqZWN0KGV2ZW50KSAmJiBldmVudC5uYW1lKSB7CiAgICAgICAgZXJyb3IgPSB7CiAgICAgICAgICAgIG5hbWU6IGV2ZW50Lm5hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IGV2ZW50Lm1lc3NhZ2UsCiAgICAgICAgICAgIGNvbnN0cmFpbnROYW1lOiBldmVudC5jb25zdHJhaW50TmFtZQogICAgICAgIH07CiAgICB9CiAgICBlbHNlIGlmIChPVC4kLmlzT2JqZWN0KGV2ZW50KSkgewogICAgICAgIGVycm9yID0gbWFwVmVuZG9yRXJyb3JOYW1lKGV2ZW50LmNvZGUsIGNocm9tZVRvVzNDRXJyb3JzKTsKCiAgICAgICAgLy8gbWVzc2FnZSBhbmQgY29uc3RyYWludE5hbWUgYXJlIHByb2JhYmx5IG1pc3NpbmcgaWYgdGhlCiAgICAgICAgLy8gcHJvcGVydHkgaXMgYWxzbyBvbWl0dGVkLCBidXQganVzdCBpbiBjYXNlIHRoZXkgYXJlbid0LgogICAgICAgIGlmIChldmVudC5tZXNzYWdlKSBlcnJvci5tZXNzYWdlID0gZXZlbnQubWVzc2FnZTsKICAgICAgICBpZiAoZXZlbnQuY29uc3RyYWludE5hbWUpIGVycm9yLmNvbnN0cmFpbnROYW1lID0gZXZlbnQuY29uc3RyYWludE5hbWU7CiAgICB9CiAgICBlbHNlIGlmIChldmVudCAmJiBtb3pUb1czQ0Vycm9ycy5oYXNPd25Qcm9wZXJ0eShldmVudCkpIHsKICAgICAgICBlcnJvciA9IG1hcFZlbmRvckVycm9yTmFtZShldmVudCwgbW96VG9XM0NFcnJvcnMpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgZXJyb3IgPSB7CiAgICAgICAgICAgIG1lc3NhZ2U6ICJVbmtub3duIEVycm9yIHdoaWxlIGdldHRpbmcgdXNlciBtZWRpYSIKICAgICAgICB9OwogICAgfQoKCiAgICByZXR1cm4gZXJyb3I7Cn07CgoKCi8vIFZhbGlkYXRlcyBhIEhhc2ggb2YgZ2V0VXNlck1lZGlhIGNvbnN0cmFpbnRzLiBDdXJyZW50bHkgd2Ugb25seQovLyBjaGVjayB0byBzZWUgaWYgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIG5vbi1mYWxzZSBjb25zdHJhaW50Lgp2YXIgYXJlSW52YWxpZENvbnN0cmFpbnRzID0gZnVuY3Rpb24oY29uc3RyYWludHMpIHsKICAgIGlmICghY29uc3RyYWludHMgfHwgIU9ULiQuaXNPYmplY3QoY29uc3RyYWludHMpKSByZXR1cm4gdHJ1ZTsKCiAgICBmb3IgKHZhciBrZXkgaW4gY29uc3RyYWludHMpIHsKICAgICAgICBpZiAoY29uc3RyYWludHNba2V5XSkgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwp9OwoKCgoKCi8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgY2xpZW50IHN1cHBvcnRzIFdlYiBSVEMsIGZhbHNlIG90aGVyd2lzZS4KLy8KLy8gQ2hyb21lIElzc3VlczoKLy8gKiBUaGUgZXhwbGljaXQgcHJvdG90eXBlLmFkZFN0cmVhbSBjaGVjayBpcyBiZWNhdXNlIHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uIHdhcwovLyBwYXJ0aWFsbHkgaW1wbGVtZW50ZWQsIGJ1dCBub3QgZnVuY3Rpb25hbCwgaW4gQ2hyb21lIDIyLgovLwovLyBGaXJlZm94IElzc3VlczoKLy8gKiBObyByZWFsIHN1cHBvcnQgYmVmb3JlIEZpcmVmb3ggMTkKLy8gKiBGaXJlZm94IDE5IGhhcyBpc3N1ZXMgd2l0aCBnZW5lcmF0aW5nIE9mZmVycy4KLy8gKiBGaXJlZm94IDIwIGRvZXNuJ3QgaW50ZXJvcGVyYXRlIHdpdGggQ2hyb21lLgovLwpPVC4kLnN1cHBvcnRzV2ViUlRDID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgX3N1cHBvcnRzV2ViUlRDID0gZmFsc2U7CgogICAgaWYgKG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEpIHsKICAgICAgICBfc3VwcG9ydHNXZWJSVEMgPSB0eXBlb2Yod2Via2l0UlRDUGVlckNvbm5lY3Rpb24pID09PSAnZnVuY3Rpb24nICYmICEhd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLmFkZFN0cmVhbTsKICAgIH0KICAgIGVsc2UgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEpIHsKICAgICAgICB2YXIgZmlyZWZveFZlcnNpb24gPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLm1hdGNoKC9GaXJlZm94XC8oWzAtOVwuXSspL2kpOwogICAgICAgIF9zdXBwb3J0c1dlYlJUQyA9IHR5cGVvZihtb3pSVENQZWVyQ29ubmVjdGlvbikgPT09ICdmdW5jdGlvbicgJiYgKGZpcmVmb3hWZXJzaW9uICE9PSBudWxsICYmIHBhcnNlRmxvYXQoZmlyZWZveFZlcnNpb25bMV0sIDEwKSA+IDIwLjApOwogICAgICAgIGlmIChfc3VwcG9ydHNXZWJSVEMpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5ldyBtb3pSVENQZWVyQ29ubmVjdGlvbigpOwogICAgICAgICAgICAgICAgX3N1cHBvcnRzV2ViUlRDID0gdHJ1ZTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBfc3VwcG9ydHNXZWJSVEMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBPVC4kLnN1cHBvcnRzV2ViUlRDID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIF9zdXBwb3J0c1dlYlJUQzsKICAgIH07CgogICAgcmV0dXJuIF9zdXBwb3J0c1dlYlJUQzsKfTsKCi8vIFJldHVybnMgYSBTdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBzdXBwb3J0ZWQgV2ViUlRDIGNyeXB0byBzY2hlbWUuIFRoZSBwb3NzaWJsZQovLyB2YWx1ZXMgYXJlIFNERVNfU1JUUCwgRFRMU19TUlRQLCBhbmQgTk9ORTsKLy8KLy8gQnJvYWRseToKLy8gKiBGaXJlZm94IG9ubHkgc3VwcG9ydHMgRFRMUwovLyAqIE9sZGVyIHZlcnNpb25zIG9mIENocm9tZSAoPD0gMjQpIG9ubHkgc3VwcG9ydCBTREVTCi8vICogTmV3ZXIgdmVyc2lvbnMgb2YgQ2hyb21lICg+PSAyNSkgc3VwcG9ydCBEVExTIGFuZCBTREVTCi8vCk9ULiQuc3VwcG9ydGVkQ3J5cHRvU2NoZW1lID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoIU9ULiQuc3VwcG9ydHNXZWJSVEMoKSkgcmV0dXJuICdOT05FJzsKCiAgICB2YXIgY2hyb21lVmVyc2lvbiA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkubWF0Y2goL2Nocm9tZVwvKFswLTlcLl0rKS9pKTsKICAgIHJldHVybiBjaHJvbWVWZXJzaW9uICYmIHBhcnNlRmxvYXQoY2hyb21lVmVyc2lvblsxXSwgMTApIDwgMjUgPyAnU0RFU19TUlRQJyA6ICdEVExTX1NSVFAnOwp9OwoKLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBicm93c2VyIHN1cHBvcnRzIGJ1bmRsZQovLwovLyBCcm9hZGx5OgovLyAqIEZpcmVmb3ggZG9lc24ndCBzdXBwb3J0IGJ1bmRsZQovLyAqIENocm9tZSBzdXBwb3J0IGJ1bmRsZQovLwpPVC4kLnN1cHBvcnRzQnVuZGxlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gT1QuJC5zdXBwb3J0c1dlYlJUQygpICYmIE9ULiQuYnJvd3NlcigpID09PSAnQ2hyb21lJzsKfTsKCi8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBydGNwIG11eAovLwovLyBCcm9hZGx5OgovLyAqIE9sZGVyIHZlcnNpb25zIG9mIEZpcmVmb3ggKDw9IDI1KSBkb24ndCBzdXBwb3J0IHJ0Y3AgbXV4Ci8vICogT2xkZXIgdmVyc2lvbnMgb2YgRmlyZWZveCAoPj0gMjYpIHN1cHBvcnQgcnRjcCBtdXggKG5vdCB0ZXN0ZWQgeWV0KQovLyAqIENocm9tZSBzdXBwb3J0IGJ1bmRsZQovLwpPVC4kLnN1cHBvcnRzUnRjcE11eCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIE9ULiQuc3VwcG9ydHNXZWJSVEMoKSAmJiBPVC4kLmJyb3dzZXIoKSA9PT0gJ0Nocm9tZSc7Cn07CgovLyBBIHdyYXBwZXIgZm9yIHRoZSBidWlsdGluIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEuIEluIGFkZGl0aW9uIHRvIHRoZSB1c3VhbAovLyBnZXRVc2VyTWVkaWEgYmVoYXZpb3VyLCB0aGlzIGhlbHBlciBtZXRob2QgYWxzbyBhY2NlcHRzIGEgYWNjZXNzRGlhbG9nT3BlbmVkCi8vIGFuZCBhY2Nlc3NEaWFsb2dDbG9zZWQgY2FsbGJhY2suCi8vCi8vIEBtZW1iZXJvZiBUQi4kCi8vIEBwcml2YXRlCi8vCi8vIEBwYXJhbSB7T2JqZWN0fSBjb25zdHJhaW50cwovLyAgICAgIEEgZGljdGlvbmFyeSBvZiBjb25zdHJhaW50cyB0byBwYXNzIHRvIGdldFVzZXJNZWRpYS4gU2VlIDxhIGhyZWY9J2h0dHA6Ly9kZXYudzMub3JnLzIwMTEvd2VicnRjL2VkaXRvci9nZXR1c2VybWVkaWEuaHRtbCNpZGwtZGVmLU1lZGlhU3RyZWFtQ29uc3RyYWludHMnPk1lZGlhU3RyZWFtQ29uc3RyYWludHM8L2E+IGluIHRoZSBNZWRpYSBDYXB0dXJlIGFuZCBTdHJlYW1zIHNwZWMgZm9yIG1vcmUgaW5mby4KLy8KLy8gQHBhcmFtIHtmdW5jdGlvbn0gc3VjY2VzcwovLyAgICAgIENhbGxlZCB3aGVuIGdldFVzZXJNZWRpYSBjb21wbGV0ZXMgc3VjY2Vzc2Z1bGx5LiBUaGUgY2FsbGJhY2sgd2lsbCBiZSBwYXNzZWQgYSBXZWJSVEMgU3RyZWFtIG9iamVjdC4KLy8KLy8gQHBhcmFtIHtmdW5jdGlvbn0gZmFpbHVyZQovLyAgICAgIENhbGxlZCB3aGVuIGdldFVzZXJNZWRpYSBmYWlscyB0byBhY2Nlc3MgYSB1c2VyIHN0cmVhbS4gSXQgd2lsbCBiZSBwYXNzZWQgYW4gb2JqZWN0IHdpdGggYSBjb2RlIHByb3BlcnR5IHJlcHJlc2VudGluZyB0aGUgZXJyb3IgdGhhdCBvY2N1cnJlZC4KLy8KLy8gQHBhcmFtIHtmdW5jdGlvbn0gYWNjZXNzRGlhbG9nT3BlbmVkCi8vICAgICAgQ2FsbGVkIHdoZW4gdGhlIGFjY2VzcyBhbGxvdy9kZW55IGRpYWxvZyBpcyBvcGVuZWQuCi8vCi8vIEBwYXJhbSB7ZnVuY3Rpb259IGFjY2Vzc0RpYWxvZ0Nsb3NlZAovLyAgICAgIENhbGxlZCB3aGVuIHRoZSBhY2Nlc3MgYWxsb3cvZGVueSBkaWFsb2cgaXMgY2xvc2VkLgovLwovLyBAcGFyYW0ge2Z1bmN0aW9ufSBhY2Nlc3NEZW5pZWQKLy8gICAgICBDYWxsZWQgd2hlbiBhY2Nlc3MgaXMgZGVuaWVkIHRvIHRoZSBjYW1lcmEvbWljLiBUaGlzIHdpbGwgYmUgZWl0aGVyIGJlY2F1c2UKLy8gICAgICB0aGUgdXNlciBoYXMgY2xpY2tlZCBkZW55IG9yIGJlY2F1c2UgYSBwYXJ0aWN1bGFyIG9yaWdpbiBpcyBwZXJtYW5lbnRseSBkZW5pZWQuCi8vCk9ULiQuZ2V0VXNlck1lZGlhID0gZnVuY3Rpb24oY29uc3RyYWludHMsIHN1Y2Nlc3MsIGZhaWx1cmUsIGFjY2Vzc0RpYWxvZ09wZW5lZCwgYWNjZXNzRGlhbG9nQ2xvc2VkLCBhY2Nlc3NEZW5pZWQpIHsKICAgIC8vIEFsbCBjb25zdHJhaW50cyBhcmUgZmFsc2UsIHdlIGRvbid0IGFsbG93IHRoaXMuIFRoaXMgbWF5IGJlIHZhbGlkIGxhdGVyCiAgICAvLyBkZXBlbmRpbmcgb24gaG93L2lmIHdlIGludGVncmF0ZSBkYXRhIGNoYW5uZWxzLgogICAgaWYgKGFyZUludmFsaWRDb25zdHJhaW50cyhjb25zdHJhaW50cykpIHsKICAgICAgICBPVC5lcnJvcigiQ291bGRuJ3QgZ2V0IFVzZXJNZWRpYTogQWxsIGNvbnN0cmFpbnRzIHdlcmUgZmFsc2UiKTsKICAgICAgICAvLyBVc2luZyBhIHVnbHkgZHVtbXktY29kZSBmb3Igbm93LgogICAgICAgIGZhaWx1cmUuY2FsbChudWxsLCB7CiAgICAgICAgICAgIG5hbWU6ICdOT19WQUxJRF9DT05TVFJBSU5UUycsCiAgICAgICAgICAgIG1lc3NhZ2U6ICJWaWRlbyBhbmQgQXVkaW8gd2FzIGRpc2FibGVkLCB5b3UgbmVlZCB0byBlbmFibGVkIGF0IGxlYXN0IG9uZSIKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB0cmlnZ2VyT3BlbmVkVGltZXIgPSBudWxsLAogICAgICAgIGRpc3BsYXllZFBlcm1pc3Npb25EaWFsb2cgPSBmYWxzZSwKCiAgICAgICAgZmluYWxpc2VBY2Nlc3NEaWFsb2cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRyaWdnZXJPcGVuZWRUaW1lcikgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRyaWdnZXJPcGVuZWRUaW1lcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXNwbGF5ZWRQZXJtaXNzaW9uRGlhbG9nICYmIGFjY2Vzc0RpYWxvZ0Nsb3NlZCkgYWNjZXNzRGlhbG9nQ2xvc2VkKCk7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlck9wZW5lZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cmlnZ2VyT3BlbmVkVGltZXIgPSBudWxsOwogICAgICAgICAgICBkaXNwbGF5ZWRQZXJtaXNzaW9uRGlhbG9nID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChhY2Nlc3NEaWFsb2dPcGVuZWQpIGFjY2Vzc0RpYWxvZ09wZW5lZCgpOwogICAgICAgIH0sCgogICAgICAgIG9uU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIGZpbmFsaXNlQWNjZXNzRGlhbG9nKCk7CiAgICAgICAgICAgIHN1Y2Nlc3MuY2FsbChudWxsLCBzdHJlYW0pOwogICAgICAgIH0sCgogICAgICAgIG9uRXJyb3IgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBmaW5hbGlzZUFjY2Vzc0RpYWxvZygpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBwYXJzZUVycm9yRXZlbnQoZXZlbnQpOwoKICAgICAgICAgICAgaWYgKGVycm9yLm5hbWUgPT09ICdQRVJNSVNTSU9OX0RFTklFRCcpIHsKICAgICAgICAgICAgICAgIGFjY2Vzc0RlbmllZC5jYWxsKG51bGwsIGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGZhaWx1cmUuY2FsbChudWxsLCBlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgIHRyeSB7CiAgICAgICAgZ2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzLCBvblN0cmVhbSwgb25FcnJvcik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgT1QuZXJyb3IoIkNvdWxkbid0IGdldCBVc2VyTWVkaWE6ICIgKyBlLnRvU3RyaW5nKCkpOwogICAgICAgIG9uRXJyb3IoKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gVGhlICJyZW1lbWJlciBtZSIgZnVuY3Rpb25hbGl0eSBvZiBXZWJSVEMgb25seSBmdW5jdGlvbnMgb3ZlciBIVFRQUywgaWYKICAgIC8vIHdlIGFyZW4ndCBvbiBIVFRQUyB0aGVuIHdlIHNob3VsZCBkZWZpbml0ZWx5IGJlIGRpc3BsYXlpbmcgdGhlIGFjY2VzcwogICAgLy8gZGlhbG9nLgogICAgLy8KICAgIC8vIElmIHdlIGFyZSBvbiBIVFRQUywgd2UnbGwgd2FpdCA1MDBtcyB0byBzZWUgaWYgd2UgZ2V0IGEgc3RyZWFtCiAgICAvLyBpbW1lZGlhdGVseS4gSWYgd2UgZG8gdGhlbiB0aGUgdXNlciBoYWQgY2xpY2tlZCAicmVtZW1iZXIgbWUiLiBPdGhlcndpc2UKICAgIC8vIHdlIGFzc3VtZSB0aGF0IHRoZSBhY2Nlc3NBbGxvd2VkIGRpYWxvZyBpcyB2aXNpYmxlLgogICAgLy8KICAgIC8vIEB0b2RvIGJlbmNobWFyayBhbmQgc2VlIGlmIDUwMG1zIGlzIGEgcmVhc29uYWJsZSBudW1iZXIuIEl0IHNlZW1zIGxpa2UKICAgIC8vIHdlIHNob3VsZCBrbm93IGEgbG90IHF1aWNrZXIuCiAgICAvLwogICAgaWYgKGxvY2F0aW9uLnByb3RvY29sLmluZGV4T2YoJ2h0dHBzJykgPT09IC0xKSB7CiAgICAgICAgLy8gRXhlY3V0ZSBhZnRlciwgdGhpcyBnaXZlcyB0aGUgY2xpZW50IGEgY2hhbmNlIHRvIGJpbmQgdG8gdGhlCiAgICAgICAgLy8gYWNjZXNzRGlhbG9nT3BlbmVkIGV2ZW50LgogICAgICAgIHNldFRpbWVvdXQodHJpZ2dlck9wZW5lZCwgMTAwKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vIHdhaXQgYSBzZWNvbmQgYW5kIHRoZW4gdHJpZ2dlciBhY2Nlc3NEaWFsb2dPcGVuZWQKICAgICAgICB0cmlnZ2VyT3BlbmVkVGltZXIgPSBzZXRUaW1lb3V0KHRyaWdnZXJPcGVuZWQsIDUwMCk7CiAgICB9Cn07CgoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKT1QuVmlkZW9PcmllbnRhdGlvbiA9IHsKICAgIFJPVEFURURfTk9STUFMOiAiT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZE5vcm1hbCIsCiAgICBST1RBVEVEX0xFRlQ6ICJPVFZpZGVvT3JpZW50YXRpb25Sb3RhdGVkTGVmdCIsCiAgICBST1RBVEVEX1JJR0hUOiAiT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZFJpZ2h0IiwKICAgIFJPVEFURURfVVBTSURFX0RPV046ICJPVFZpZGVvT3JpZW50YXRpb25Sb3RhdGVkVXBzaWRlRG93biIKfTsKCi8vCi8vCi8vICAgdmFyIF92aWRlb0VsZW1lbnQgPSBuZXcgT1QuVmlkZW9FbGVtZW50KHsKLy8gICAgIGZhbGxiYWNrVGV4dDogJ2JsYWgnCi8vICAgfSk7Ci8vCi8vICAgX3ZpZGVvRWxlbWVudC5vbih7Ci8vICAgICBzdHJlYW1Cb3VuZDogZnVuY3Rpb24oKSB7Li4ufSwKLy8gICAgIGxvYWRFcnJvcjogZnVuY3Rpb24oKSB7Li4ufSwKLy8gICAgIGVycm9yOiBmdW5jdGlvbigpIHsuLi59Ci8vICAgfSk7Ci8vCi8vICAgX3ZpZGVvRWxlbWVudC5iaW5kVG9TdHJlYW0od2ViUnRjU3RyZWFtKTsgICAgICAvLyA9PiBWaWRlb0VsZW1lbnQKLy8gICBfdmlkZW9FbGVtZW50LmFwcGVuZFRvKERPTUVsZW1lbnQpICAgICAgICAgICAgIC8vID0+IFZpZGVvRWxlbWVudAovLwovLyAgIF92aWRlb0VsZW1lbnQuc3RyZWFtICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gPT4gV2ViIFJUQyBzdHJlYW0KLy8gICBfdmlkZW9FbGVtZW50LmRvbUVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgIC8vID0+IERvbU5vZGUKLy8gICBfdmlkZW9FbGVtZW50LnBhcmVudEVsZW1lbnQgICAgICAgICAgICAgICAgICAgIC8vID0+IERvbU5vZGUKLy8KLy8gICBfdmlkZW9FbGVtZW50LmltZ0RhdGEgICAgICAgICAgICAgICAgICAgICAgICAgIC8vID0+IFBORyBEYXRhIHN0cmluZwovLwovLyAgIF92aWRlb0VsZW1lbnQub3JpZW50YXRpb24gPSBPVC5WaWRlb09yaWVudGF0aW9uLlJPVEFURURfTEVGVDsKLy8KLy8gICBfdmlkZW9FbGVtZW50LnVuYmluZFN0cmVhbSgpOwovLyAgIF92aWRlb0VsZW1lbnQuZGVzdHJveSgpICAgICAgICAgICAgICAgICAgICAgICAgLy8gPT4gQ29tcGxldGVseSBjbGVhbnMgdXAgYW5kIHJlbW92ZXMgdGhlIHZpZGVvIGVsZW1lbnQKLy8KLy8KT1QuVmlkZW9FbGVtZW50ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIF9zdHJlYW0sCiAgICAgICAgX2RvbUVsZW1lbnQsCiAgICAgICAgX3BhcmVudEVsZW1lbnQsCiAgICAgICAgX3N0cmVhbUJvdW5kID0gZmFsc2UsCiAgICAgICAgX3ZpZGVvRWxlbWVudE1vdmVkV2FybmluZyA9IGZhbHNlLAogICAgICAgIF9vcHRpb25zID0gT1QuJC5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgICAgICAgIGZhbGxiYWNrVGV4dDogJ1NvcnJ5LCBXZWIgUlRDIGlzIG5vdCBhdmFpbGFibGUgaW4geW91ciBicm93c2VyJwogICAgICAgIH0pOwoKCiAgICBPVC4kLmV2ZW50aW5nKHRoaXMpOwoKICAgIC8vLyBQcml2YXRlIEFQSQogICAgdmFyIF9vblZpZGVvRXJyb3IgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgcmVhc29uID0gIlRoZXJlIHdhcyBhbiB1bmV4cGVjdGVkIHByb2JsZW0gd2l0aCB0aGUgVmlkZW8gU3RyZWFtOiAiICsgdmlkZW9FbGVtZW50RXJyb3JDb2RlVG9TdHIoZXZlbnQudGFyZ2V0LmVycm9yLmNvZGUpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgbnVsbCwgcmVhc29uLCB0aGlzKTsKICAgICAgICB9LmJpbmQodGhpcyksCgogICAgICAgIF9vblN0cmVhbUJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIF9zdHJlYW1Cb3VuZCA9IHRydWU7CiAgICAgICAgICAgIF9kb21FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgX29uVmlkZW9FcnJvciwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3N0cmVhbUJvdW5kJywgdGhpcyk7CiAgICAgICAgfS5iaW5kKHRoaXMpLAoKICAgICAgICBfb25TdHJlYW1Cb3VuZEVycm9yID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignbG9hZEVycm9yJywgT1QuRXhjZXB0aW9uQ29kZXMuUDJQX0NPTk5FQ1RJT05fRkFJTEVELCByZWFzb24sIHRoaXMpOwogICAgICAgIH0uYmluZCh0aGlzKSwKCiAgICAgICAgLy8gVGhlIHZpZGVvIGVsZW1lbnQgcGF1c2VzIGl0c2VsZiB3aGVuIGl0J3MgcmVwYXJlbnRlZCwgdGhpcyBpcwogICAgICAgIC8vIHVuZm9ydHVuYXRlLiBUaGlzIGZ1bmN0aW9uIHBsYXlzIHRoZSB2aWRlbyBhZ2FpbiBhbmQgaXMgdHJpZ2dlcmVkCiAgICAgICAgLy8gb24gdGhlIHBhdXNlIGV2ZW50LgogICAgICAgIF9wbGF5VmlkZW9PblBhdXNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCFfdmlkZW9FbGVtZW50TW92ZWRXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICBPVC53YXJuKCJWaWRlbyBlbGVtZW50IHBhdXNlZCwgYXV0by1yZXN1bWluZy4gSWYgeW91IGludGVuZGVkIHRvIGRvIHRoaXMsIHVzZSBwdWJsaXNoVmlkZW8oZmFsc2UpIG9yIHN1YnNjcmliZVRvVmlkZW8oZmFsc2UpIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICBfdmlkZW9FbGVtZW50TW92ZWRXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfZG9tRWxlbWVudC5wbGF5KCk7CiAgICAgICAgfTsKCgogICAgX2RvbUVsZW1lbnQgPSBjcmVhdGVWaWRlb0VsZW1lbnQoX29wdGlvbnMuZmFsbGJhY2tUZXh0LCBfb3B0aW9ucy5hdHRyaWJ1dGVzKTsKCiAgICBfZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdwYXVzZScsIF9wbGF5VmlkZW9PblBhdXNlKTsKCiAgICAvLy8gUHVibGljIFByb3BlcnRpZXMKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsKICAgICAgICBzdHJlYW06IHtnZXQ6IGZ1bmN0aW9uKCkge3JldHVybiBfc3RyZWFtOyB9fSwKICAgICAgICBkb21FbGVtZW50OiB7Z2V0OiBmdW5jdGlvbigpIHtyZXR1cm4gX2RvbUVsZW1lbnQ7IH19LAogICAgICAgIHBhcmVudEVsZW1lbnQ6IHtnZXQ6IGZ1bmN0aW9uKCkge3JldHVybiBfcGFyZW50RWxlbWVudDsgfX0sCiAgICAgICAgaXNCb3VuZFRvU3RyZWFtOiB7Z2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zdHJlYW1Cb3VuZDsgfX0sCiAgICAgICAgcG9zdGVyOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfZG9tRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3Bvc3RlcicpOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHNyYykgeyBfZG9tRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3Bvc3RlcicsIHNyYyk7IH0KICAgICAgICB9CiAgICB9KTsKCgogICAgLy8vIFB1YmxpYyBtZXRob2RzCgogICAgLy8gQXBwZW5kIHRoZSBWaWRlbyBET00gZWxlbWVudCB0byBhIHBhcmVudCBub2RlCiAgICB0aGlzLmFwcGVuZFRvID0gZnVuY3Rpb24ocGFyZW50RG9tRWxlbWVudCkgewogICAgICAgIF9wYXJlbnRFbGVtZW50ID0gcGFyZW50RG9tRWxlbWVudDsKICAgICAgICBfcGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZChfZG9tRWxlbWVudCk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvLyBCaW5kIGEgc3RyZWFtIHRvIHRoZSB2aWRlbyBlbGVtZW50LgogICAgdGhpcy5iaW5kVG9TdHJlYW0gPSBmdW5jdGlvbih3ZWJSdGNTdHJlYW0pIHsKICAgICAgICBfc3RyZWFtQm91bmQgPSBmYWxzZTsKICAgICAgICBfc3RyZWFtID0gd2ViUnRjU3RyZWFtOwoKICAgICAgICBiaW5kU3RyZWFtVG9WaWRlb0VsZW1lbnQoX2RvbUVsZW1lbnQsIF9zdHJlYW0sIF9vblN0cmVhbUJvdW5kLCBfb25TdHJlYW1Cb3VuZEVycm9yKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8vIFVuYmluZCB0aGUgY3VycmVudGx5IGJvdW5kIHN0cmVhbSBmcm9tIHRoZSB2aWRlbyBlbGVtZW50LgogICAgdGhpcy51bmJpbmRTdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIV9zdHJlYW0pIHJldHVybiB0aGlzOwoKICAgICAgICBpZiAoX2RvbUVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKCFuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgYnJvd3NlciB3b3VsZCBoYXZlIHJlbGVhc2VkIHRoaXMgb24gdW5sb2FkIGFueXdheSwgYnV0CiAgICAgICAgICAgICAgICAvLyB3ZSdyZSBiZWluZyBhIGdvb2QgY2l0aXplbi4KICAgICAgICAgICAgICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKF9kb21FbGVtZW50LnNyYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBfZG9tRWxlbWVudC5tb3pTcmNPYmplY3QgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RyZWFtID0gbnVsbDsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIHRoaXMuc2V0QXVkaW9Wb2x1bWUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmIChfZG9tRWxlbWVudCkgX2RvbUVsZW1lbnQudm9sdW1lID0gT1QuJC5yb3VuZEZsb2F0KHZhbHVlIC8gMTAwLCAyKTsKICAgIH07CgogICAgdGhpcy5nZXRBdWRpb1ZvbHVtZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFJldHVybiB0aGUgYWN0dWFsIHZvbHVtZSBvZiB0aGUgRE9NIGVsZW1lbnQKICAgICAgICBpZiAoX2RvbUVsZW1lbnQpIHJldHVybiBwYXJzZUludChfZG9tRWxlbWVudC52b2x1bWUgKiAxMDAsIDEwKTsKICAgICAgICByZXR1cm4gNTA7CiAgICB9OwoKICAgIHRoaXMud2hlblRpbWVJbmNyZW1lbnRzID0gZnVuY3Rpb24oY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICBpZihfZG9tRWxlbWVudCkgewogICAgICAgICAgICB2YXIgbGFzdFRpbWUsIGhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCFsYXN0VGltZSB8fCBsYXN0VGltZSA+PSBfZG9tRWxlbWVudC5jdXJyZW50VGltZSkgewogICAgICAgICAgICAgICAgICAgIGxhc3RUaW1lID0gX2RvbUVsZW1lbnQuY3VycmVudFRpbWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RpbWV1cGRhdGUnLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbChjb250ZXh0LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfS5iaW5kKHRoaXMpOwogICAgICAgICAgICBfZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0aW1ldXBkYXRlJywgaGFuZGxlciwgZmFsc2UpOwogICAgICAgIH0KICAgIH07CgogICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gdW5iaW5kIGFsbCBldmVudHMgc28gdGhleSBkb24ndCBmaXJlIGFmdGVyIHRoZSBvYmplY3QgaXMgZGVhZAogICAgICAgIHRoaXMub2ZmKCk7CgogICAgICAgIHRoaXMudW5iaW5kU3RyZWFtKCk7CgogICAgICAgIGlmIChfZG9tRWxlbWVudCkgewogICAgICAgICAgICAvLyBVbmJpbmQgdGhpcyBmaXJzdCwgb3RoZXJ3aXNlIGl0IHdpbGwgdHJpZ2dlciB3aGVuIHRoZQogICAgICAgICAgICAvLyB2aWRlbyBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgICAgICBfZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdwYXVzZScsIF9wbGF5VmlkZW9PblBhdXNlKTsKCiAgICAgICAgICAgIE9ULiQucmVtb3ZlRWxlbWVudChfZG9tRWxlbWVudCk7CiAgICAgICAgICAgIF9kb21FbGVtZW50ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIF9wYXJlbnRFbGVtZW50ID0gbnVsbDsKCiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07Cn07CgoKLy8gQ2hlY2tpbmcgZm9yIHdpbmRvdy5kZWZpbmVQcm9wZXJ0eSBmb3IgSUUgY29tcGF0aWJpbGl0eSwganVzdCBzbyB3ZSBkb24ndCB0aHJvdyBleGNlcHRpb25zIHdoZW4gdGhlIHNjcmlwdCBpcyBpbmNsdWRlZAppZiAoT1QuJC5jYW5EZWZpbmVQcm9wZXJ0eSkgewogICAgLy8gRXh0cmFjdHMgYSBzbmFwc2hvdCBmcm9tIGEgdmlkZW8gZWxlbWVudCBhbmQgcmV0dXJucyBpdCdzIGFzIGEgUE5HIERhdGEgc3RyaW5nLgogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoT1QuVmlkZW9FbGVtZW50LnByb3RvdHlwZSwgewogICAgICAgIGltZ0RhdGE6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBjYW52YXMgPSBPVC4kLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycsIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRoaXMuZG9tRWxlbWVudC52aWRlb1dpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuZG9tRWxlbWVudC52aWRlb0hlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjYW52YXMpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKS5kcmF3SW1hZ2UodGhpcy5kb21FbGVtZW50LCAwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgICAgICAgICAgICAgfSBjYXRjaChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBPVC53YXJuKCJDYW5ub3QgZ2V0IGltYWdlIGRhdGEgeWV0Iik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaW1nRGF0YSA9IGNhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpOwoKICAgICAgICAgICAgICAgIE9ULiQucmVtb3ZlRWxlbWVudChjYW52YXMpOwoKICAgICAgICAgICAgICAgIHJldHVybiBpbWdEYXRhLnJlcGxhY2UoImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCwiLCAiIikudHJpbSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdmlkZW9XaWR0aDogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYodGhpcy5fb3JpZW50YXRpb24gJiYgdGhpcy5fb3JpZW50YXRpb24ud2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fb3JpZW50YXRpb24ud2lkdGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50Wyd2aWRlbycgKyAodGhpcy5pc1JvdGF0ZWQgPyAnSGVpZ2h0JyA6ICdXaWR0aCcpXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHZpZGVvSGVpZ2h0OiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLl9vcmllbnRhdGlvbiAmJiB0aGlzLl9vcmllbnRhdGlvbi5oZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fb3JpZW50YXRpb24uaGVpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tRWxlbWVudFsndmlkZW8nICsgKHRoaXMuaXNSb3RhdGVkID8gJ1dpZHRoJyA6ICdIZWlnaHQnKV07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBhc3BlY3RSYXRpbzogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLnZpZGVvV2lkdGggKyAwLjApIC8gdGhpcy52aWRlb0hlaWdodDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGlzUm90YXRlZDogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29yaWVudGF0aW9uICYmICh0aGlzLl9vcmllbnRhdGlvbi52aWRlb09yaWVudGF0aW9uID09ICdPVFZpZGVvT3JpZW50YXRpb25Sb3RhdGVkTGVmdCcgfHwgdGhpcy5fb3JpZW50YXRpb24udmlkZW9PcmllbnRhdGlvbiA9PSAnT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZFJpZ2h0Jyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfQoKCnZhciBWaWRlb09yaWVudGF0aW9uVHJhbnNmb3JtcyA9IHsKICAgIE9UVmlkZW9PcmllbnRhdGlvblJvdGF0ZWROb3JtYWw6ICJyb3RhdGUoMGRlZykiLAogICAgT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZExlZnQ6ICJyb3RhdGUoOTBkZWcpIiwKICAgIE9UVmlkZW9PcmllbnRhdGlvblJvdGF0ZWRSaWdodDogInJvdGF0ZSgtOTBkZWcpIiwKICAgIE9UVmlkZW9PcmllbnRhdGlvblJvdGF0ZWRVcHNpZGVEb3duOiAicm90YXRlKDE4MGRlZykiCn07CgovLyBDaGVja2luZyBmb3Igd2luZG93LmRlZmluZVByb3BlcnR5IGZvciBJRSBjb21wYXRpYmlsaXR5LCBqdXN0IHNvIHdlIGRvbid0IHRocm93IGV4Y2VwdGlvbnMgd2hlbiB0aGUgc2NyaXB0IGlzIGluY2x1ZGVkCmlmIChPVC4kLmNhbkRlZmluZVByb3BlcnR5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoT1QuVmlkZW9FbGVtZW50LnByb3RvdHlwZSwnb3JpZW50YXRpb24nLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29yaWVudGF0aW9uOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihvcmllbnRhdGlvbikgewogICAgICAgICAgICB0aGlzLl9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoKICAgICAgICAgICAgdmFyIHRyYW5zZm9ybSA9IFZpZGVvT3JpZW50YXRpb25UcmFuc2Zvcm1zW29yaWVudGF0aW9uLnZpZGVvT3JpZW50YXRpb25dIHx8IFZpZGVvT3JpZW50YXRpb25UcmFuc2Zvcm1zLlJPVEFURURfTk9STUFMOwoKICAgICAgICAgICAgc3dpdGNoKE9ULiQuYnJvd3NlcigpKSB7CiAgICAgICAgICAgICAgICBjYXNlICdDaHJvbWUnOgogICAgICAgICAgICAgICAgY2FzZSAnU2FmYXJpJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbUVsZW1lbnQuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ0lFJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbUVsZW1lbnQuc3R5bGUubXNUcmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc3RhbmRhcmQgdmVyc2lvbiwganVzdCBGaXJlZm94LCBPcGVyYSwgYW5kIElFID4gOQogICAgICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignb3JpZW50YXRpb25DaGFuZ2VkJyk7CiAgICAgICAgfQogICAgfSk7Cn0KCgoKLy8vIFByaXZhdGUgSGVscGVyIGZ1bmN0aW9ucwoKZnVuY3Rpb24gY3JlYXRlVmlkZW9FbGVtZW50KGZhbGxiYWNrVGV4dCwgYXR0cmlidXRlcykgewogICAgdmFyIHZpZGVvRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3ZpZGVvJyk7CiAgICB2aWRlb0VsZW1lbnQuc2V0QXR0cmlidXRlKCdhdXRvcGxheScsICcnKTsKICAgIHZpZGVvRWxlbWVudC5pbm5lckhUTUwgPSBmYWxsYmFja1RleHQ7CgogICAgaWYgKGF0dHJpYnV0ZXMpIHsKICAgICAgICBpZiAoYXR0cmlidXRlcy5tdXRlZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICBkZWxldGUgYXR0cmlidXRlcy5tdXRlZDsKICAgICAgICAgICAgdmlkZW9FbGVtZW50Lm11dGVkID0gJ3RydWUnOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgdmlkZW9FbGVtZW50LnNldEF0dHJpYnV0ZShrZXksIGF0dHJpYnV0ZXNba2V5XSk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB2aWRlb0VsZW1lbnQ7Cn0KCgovLyBTZWUgaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMC9XRC1odG1sNS0yMDEwMTAxOS92aWRlby5odG1sI2Vycm9yLWNvZGVzCnZhciBfdmlkZW9FcnJvckNvZGVzID0ge307Ci8vIENoZWNraW5nIGZvciB3aW5kb3cuTWVkaWFFcnJvciBmb3IgSUUgY29tcGF0aWJpbGl0eSwganVzdCBzbyB3ZSBkb24ndCB0aHJvdyBleGNlcHRpb25zIHdoZW4gdGhlIHNjcmlwdCBpcyBpbmNsdWRlZAppZiAod2luZG93Lk1lZGlhRXJyb3IpIHsKICAgIF92aWRlb0Vycm9yQ29kZXNbd2luZG93Lk1lZGlhRXJyb3IuTUVESUFfRVJSX0FCT1JURURdID0gIlRoZSBmZXRjaGluZyBwcm9jZXNzIGZvciB0aGUgbWVkaWEgcmVzb3VyY2Ugd2FzIGFib3J0ZWQgYnkgdGhlIHVzZXIgYWdlbnQgYXQgdGhlIHVzZXIncyByZXF1ZXN0LiI7CiAgICBfdmlkZW9FcnJvckNvZGVzW3dpbmRvdy5NZWRpYUVycm9yLk1FRElBX0VSUl9ORVRXT1JLXSA9ICJBIG5ldHdvcmsgZXJyb3Igb2Ygc29tZSBkZXNjcmlwdGlvbiBjYXVzZWQgdGhlIHVzZXIgYWdlbnQgdG8gc3RvcCBmZXRjaGluZyB0aGUgbWVkaWEgcmVzb3VyY2UsIGFmdGVyIHRoZSByZXNvdXJjZSB3YXMgZXN0YWJsaXNoZWQgdG8gYmUgdXNhYmxlLiI7CiAgICBfdmlkZW9FcnJvckNvZGVzW3dpbmRvdy5NZWRpYUVycm9yLk1FRElBX0VSUl9ERUNPREVdID0gIkFuIGVycm9yIG9mIHNvbWUgZGVzY3JpcHRpb24gb2NjdXJyZWQgd2hpbGUgZGVjb2RpbmcgdGhlIG1lZGlhIHJlc291cmNlLCBhZnRlciB0aGUgcmVzb3VyY2Ugd2FzIGVzdGFibGlzaGVkIHRvIGJlIHVzYWJsZS4iOwogICAgX3ZpZGVvRXJyb3JDb2Rlc1t3aW5kb3cuTWVkaWFFcnJvci5NRURJQV9FUlJfU1JDX05PVF9TVVBQT1JURURdID0gIlRoZSBtZWRpYSByZXNvdXJjZSBpbmRpY2F0ZWQgYnkgdGhlIHNyYyBhdHRyaWJ1dGUgd2FzIG5vdCBzdWl0YWJsZS4gIjsKfQoKZnVuY3Rpb24gdmlkZW9FbGVtZW50RXJyb3JDb2RlVG9TdHIoZXJyb3JDb2RlKSB7CiAgICByZXR1cm4gX3ZpZGVvRXJyb3JDb2Rlc1twYXJzZUludChlcnJvckNvZGUsIDEwKV0gfHwgIkFuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuIjsKfQoKCmZ1bmN0aW9uIGJpbmRTdHJlYW1Ub1ZpZGVvRWxlbWVudCh2aWRlb0VsZW1lbnQsIHdlYlJUQ1N0cmVhbSwgb25TdHJlYW1Cb3VuZCwgb25TdHJlYW1Cb3VuZEVycm9yKSB7CiAgICAvLyBOb3RlOiBvbmxvYWRlZG1ldGFkYXRhIGRvZXNuJ3QgZmlyZSBpbiBDaHJvbWUgZm9yIGF1ZGlvIG9ubHkgY3JidWcuY29tLzExMDkzOAogICAgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEgfHwgKHdlYlJUQ1N0cmVhbS5nZXRWaWRlb1RyYWNrcygpLmxlbmd0aCA+IDAgJiYgd2ViUlRDU3RyZWFtLmdldFZpZGVvVHJhY2tzKClbMF0uZW5hYmxlZCkpIHsKCiAgICAgICAgdmFyIGNsZWFudXAgPSBmdW5jdGlvbiBjbGVhbnVwICgpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgIHZpZGVvRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkZWRtZXRhZGF0YScsIG9uTG9hZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgdmlkZW9FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgb25FcnJvciwgZmFsc2UpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Mb2FkID0gZnVuY3Rpb24gb25Mb2FkIChldmVudCkgewogICAgICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgICAgICAgb25TdHJlYW1Cb3VuZCgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25FcnJvciA9IGZ1bmN0aW9uIG9uRXJyb3IgKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgICAgICBvblN0cmVhbUJvdW5kRXJyb3IoIlRoZXJlIHdhcyBhbiB1bmV4cGVjdGVkIHByb2JsZW0gd2l0aCB0aGUgVmlkZW8gU3RyZWFtOiAiICsgdmlkZW9FbGVtZW50RXJyb3JDb2RlVG9TdHIoZXZlbnQudGFyZ2V0LmVycm9yLmNvZGUpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uU3RvcHBlZExvYWRpbmcgPSBmdW5jdGlvbiBvblN0b3BwZWRMb2FkaW5nICgpIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBzdHJlYW0gZW5kZWQgYmVmb3JlIHdlIGZ1bGx5IGJvdW5kIGl0LiBNYXliZSB0aGUgb3RoZXIgZW5kIGNhbGxlZAogICAgICAgICAgICAgICAgLy8gc3RvcCBvbiBpdCBvciBzb21ldGhpbmcgZWxzZSB3ZW50IHdyb25nLgogICAgICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgICAgICAgb25TdHJlYW1Cb3VuZEVycm9yKCJTdHJlYW0gZW5kZWQgd2hpbGUgdHJ5aW5nIHRvIGJpbmQgaXQgdG8gYSB2aWRlbyBlbGVtZW50LiIpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gVGltZW91dCBpZiBpdCB0YWtlcyB0b28gbG9uZwogICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh2aWRlb0VsZW1lbnQuY3VycmVudFRpbWUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBvblN0cmVhbUJvdW5kRXJyb3IoIlRoZSB2aWRlbyBzdHJlYW0gZmFpbGVkIHRvIGNvbm5lY3QuIFBsZWFzZSBub3RpZnkgdGhlIHNpdGUgb3duZXIgaWYgdGhpcyBjb250aW51ZXMgdG8gaGFwcGVuLiIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHNob3VsZCBuZXZlciBoYXBwZW4KICAgICAgICAgICAgICAgICAgICBPVC53YXJuKCJOZXZlciBnb3QgdGhlIGxvYWRlZG1ldGFkYXRhIGV2ZW50IGJ1dCBjdXJyZW50VGltZSA+IDAiKTsKICAgICAgICAgICAgICAgICAgICBvblN0cmVhbUJvdW5kKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSwgMzAwMDApOwoKCiAgICAgICAgdmlkZW9FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWRlZG1ldGFkYXRhJywgb25Mb2FkLCBmYWxzZSk7CiAgICAgICAgdmlkZW9FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgb25FcnJvciwgZmFsc2UpOwogICAgICAgIHdlYlJUQ1N0cmVhbS5vbmVuZGVkID0gb25TdG9wcGVkTG9hZGluZzsKICAgIH0gZWxzZSB7CiAgICAgICAgb25TdHJlYW1Cb3VuZCgpOwogICAgfQoKICAgIC8vIFRoZSBvZmZpY2lhbCBzcGVjIHdheSBpcyAnc3JjT2JqZWN0Jywgd2UgYXJlIHNsb3dseSBjb252ZXJnaW5nIHRoZXJlLgogICAgaWYgKHZpZGVvRWxlbWVudC5zcmNPYmplY3QgIT09IHZvaWQgMCkgewogICAgICAgIHZpZGVvRWxlbWVudC5zcmNPYmplY3QgPSB3ZWJSVENTdHJlYW07CiAgICB9CiAgICBlbHNlIGlmICh2aWRlb0VsZW1lbnQubW96U3JjT2JqZWN0ICE9PSB2b2lkIDApIHsKICAgICAgICB2aWRlb0VsZW1lbnQubW96U3JjT2JqZWN0ID0gd2ViUlRDU3RyZWFtOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdmlkZW9FbGVtZW50LnNyYyA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKHdlYlJUQ1N0cmVhbSk7CiAgICB9CgogICAgdmlkZW9FbGVtZW50LnBsYXkoKTsKfQoKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8vIFNpbmdsZXRvbiBpbnRlcnZhbAp2YXIgbG9nUXVldWUgPSBbXSwKICAgIHF1ZXVlUnVubmluZyA9IGZhbHNlOwoKCk9ULkFuYWx5dGljcyA9IGZ1bmN0aW9uKCkgewoKICAgIHZhciBlbmRQb2ludCA9IE9ULnByb3BlcnRpZXMubG9nZ2luZ1VSTCArICIvbG9nZ2luZy9DbGllbnRFdmVudCIsCiAgICAgICAgZW5kUG9pbnRRb3MgPSBPVC5wcm9wZXJ0aWVzLmxvZ2dpbmdVUkwgKyAiL2xvZ2dpbmcvQ2xpZW50UW9zIiwKCiAgICAgICAgcmVwb3J0ZWRFcnJvcnMgPSB7fSwKCiAgICAgICAgLy8gTWFwIG9mIGNhbWVsLWNhc2VkIGtleXMgdG8gdW5kZXJzY29yZWQKICAgICAgICBjYW1lbENhc2VkS2V5cyA9IHsKICAgICAgICAgICAgcGF5bG9hZFR5cGU6ICdwYXlsb2FkX3R5cGUnLAogICAgICAgICAgICBwYXJ0bmVySWQ6ICdwYXJ0bmVyX2lkJywKICAgICAgICAgICAgc3RyZWFtSWQ6ICdzdHJlYW1faWQnLAogICAgICAgICAgICBzZXNzaW9uSWQ6ICdzZXNzaW9uX2lkJywKICAgICAgICAgICAgY29ubmVjdGlvbklkOiAnY29ubmVjdGlvbl9pZCcsCiAgICAgICAgICAgIHdpZGdldFR5cGU6ICd3aWRnZXRfdHlwZScsCiAgICAgICAgICAgIHdpZGdldElkOiAnd2lkZ2V0X2lkJywKICAgICAgICAgICAgYXZnQXVkaW9CaXRyYXRlOiAnYXZnX2F1ZGlvX2JpdHJhdGUnLAogICAgICAgICAgICBhdmdWaWRlb0JpdHJhdGU6ICdhdmdfdmlkZW9fYml0cmF0ZScKICAgICAgICB9LAoKICAgICAgICBzZW5kID0gZnVuY3Rpb24oZGF0YSwgaXNRb3MsIG9uU3VjY2Vzcywgb25FcnJvcikgewogICAgICAgICAgICBPVC4kLnBvc3QoaXNRb3MgPyBlbmRQb2ludFFvcyA6IGVuZFBvaW50LCB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiBvblN1Y2Nlc3MsCiAgICAgICAgICAgICAgICBlcnJvcjogb25FcnJvciwKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIHRocm90dGxlZFBvc3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gVGhyb3R0bGUgbG9ncyBzbyB0aGF0IHRoZXkgb25seSBoYXBwZW4gMSBhdCBhIHRpbWUKICAgICAgICAgICAgaWYgKCFxdWV1ZVJ1bm5pbmcgJiYgbG9nUXVldWUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcXVldWVSdW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBjdXJyID0gbG9nUXVldWVbMF07CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBjdXJyZW50IGl0ZW0gYW5kIHNlbmQgdGhlIG5leHQgbG9nCiAgICAgICAgICAgICAgICB2YXIgcHJvY2Vzc05leHRJdGVtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgbG9nUXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICBxdWV1ZVJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aHJvdHRsZWRQb3N0KCk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmIChjdXJyKSB7CiAgICAgICAgICAgICAgICAgICAgc2VuZChjdXJyLmRhdGEsIGN1cnIuaXNRb3MsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyLm9uQ29tcGxldGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChwcm9jZXNzTmV4dEl0ZW0sIDUwKTsKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgT1QuZGVidWcoIkZhaWxlZCB0byBzZW5kIENsaWVudEV2ZW50LCBtb3Zpbmcgb24gdG8gdGhlIG5leHQgaXRlbS4iKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZXJlIHdhcyBhbiBlcnJvciwgbW92ZSBvbnRvIHRoZSBuZXh0IGl0ZW0KICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChwcm9jZXNzTmV4dEl0ZW0sIDUwKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHBvc3QgPSBmdW5jdGlvbihkYXRhLCBvbkNvbXBsZXRlLCBpc1FvcykgewogICAgICAgICAgICBsb2dRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlOiBvbkNvbXBsZXRlLAogICAgICAgICAgICAgICAgaXNRb3M6IGlzUW9zCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhyb3R0bGVkUG9zdCgpOwogICAgICAgIH0sCgogICAgICAgIHNob3VsZFRocm90dGxlRXJyb3IgPSBmdW5jdGlvbihjb2RlLCB0eXBlLCBwYXJ0bmVySWQpIHsKICAgICAgICAgICAgaWYgKCFwYXJ0bmVySWQpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHZhciBlcnJLZXkgPSBbcGFydG5lcklkLCB0eXBlLCBjb2RlXS5qb2luKCdfJyksCiAgICAgICAgICAgICAgICAvL21zZ0xpbWl0ID0gRHluYW1pY0NvbmZpZy5nZXQoJ2V4Y2VwdGlvbkxvZ2dpbmcnLCAnbWVzc2FnZUxpbWl0UGVyUGFydG5lcicsIHBhcnRuZXJJZCk7CiAgICAgICAgICAgICAgICBtc2dMaW1pdCA9IDEwMDsKICAgICAgICAgICAgaWYgKG1zZ0xpbWl0ID09PSBudWxsIHx8IG1zZ0xpbWl0ID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHJldHVybiAocmVwb3J0ZWRFcnJvcnNbZXJyS2V5XSB8fCAwKSA8PSBtc2dMaW1pdDsKICAgICAgICB9OwoKICAgICAgICAvLyBMb2cgYW4gZXJyb3IgdmlhIENsaWVudEV2ZW50cy4KICAgICAgICAvLwogICAgICAgIC8vIEBwYXJhbSBbU3RyaW5nXSBjb2RlCiAgICAgICAgLy8gQHBhcmFtIFtTdHJpbmddIHR5cGUKICAgICAgICAvLyBAcGFyYW0gW1N0cmluZ10gbWVzc2FnZQogICAgICAgIC8vIEBwYXJhbSBbSGFzaF0gZGV0YWlscyBhZGRpdGlvbmFsIGVycm9yIGRldGFpbHMKICAgICAgICAvLwogICAgICAgIC8vIEBwYXJhbSBbSGFzaF0gb3B0aW9ucyB0aGUgb3B0aW9ucyB0byBsb2cgdGhlIGNsaWVudCBldmVudCB3aXRoLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBhY3Rpb24gVGhlIG5hbWUgb2YgdGhlIEV2ZW50IHRoYXQgd2UgYXJlIGxvZ2dpbmcuIEUuZy4gIlRva1Nob3dMb2FkZWQiLiBSZXF1aXJlZC4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gdmFyaWF0aW9uIFVzdWFsbHkgdXNlZCBmb3IgU3BsaXQgQS9CIHRlc3RpbmcsIHdoZW4geW91IGhhdmUgbXVsdGlwbGUgdmFyaWF0aW9ucyBvZiB0aGUgK19hY3Rpb24rLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXlsb2FkVHlwZSBBIHRleHQgZGVzY3JpcHRpb24gb2YgdGhlIHBheWxvYWQuIFJlcXVpcmVkLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXlsb2FkIFRoZSBwYXlsb2FkLiBSZXF1aXJlZC4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gc2Vzc2lvbklkIFRoZSBhY3RpdmUgT3BlblRvayBzZXNzaW9uLCBpZiB0aGVyZSBpcyBvbmUKICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gY29ubmVjdGlvbklkIFRoZSBhY3RpdmUgT3BlblRvayBjb25uZWN0aW9uSWQsIGlmIHRoZXJlIGlzIG9uZQogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXJ0bmVySWQKICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gZ3VpZCAuLi4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gd2lkZ2V0SWQgLi4uCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIHN0cmVhbUlkIC4uLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBzZWN0aW9uIC4uLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBidWlsZCAuLi4KICAgICAgICAvLwogICAgICAgIC8vIFJlcG9ydHMgd2lsbCBiZSB0aHJvdHRsZWQgdG8gWCByZXBvcnRzIChzZWUgZXhjZXB0aW9uTG9nZ2luZy5tZXNzYWdlTGltaXRQZXJQYXJ0bmVyCiAgICAgICAgLy8gZnJvbSB0aGUgZHluYW1pYyBjb25maWcgZm9yIFgpIG9mIGVhY2ggZXJyb3IgdHlwZSBmb3IgZWFjaCBwYXJ0bmVyLiBSZXBvcnRzIGNhbiBiZQogICAgICAgIC8vIGRpc2FibGVkL2VuYWJsZWQgZ2xvYmFsbHkgb3Igb24gYSBwZXIgcGFydG5lciBiYXNpcyAocGVyIHBhcnRuZXIgc2V0dGluZ3MKICAgICAgICAvLyB0YWtlIHByZWNlZGVuY2UpIHVzaW5nIGV4Y2VwdGlvbkxvZ2dpbmcuZW5hYmxlZC4KICAgICAgICAvLwogICAgICAgIHRoaXMubG9nRXJyb3IgPSBmdW5jdGlvbihjb2RlLCB0eXBlLCBtZXNzYWdlLCBkZXRhaWxzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICB2YXIgcGFydG5lcklkID0gb3B0aW9ucy5wYXJ0bmVySWQ7CgogICAgICAgICAgICBpZiAoT1QuQ29uZmlnLmdldCgnZXhjZXB0aW9uTG9nZ2luZycsICdlbmFibGVkJywgcGFydG5lcklkKSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2hvdWxkVGhyb3R0bGVFcnJvcihjb2RlLCB0eXBlLCBwYXJ0bmVySWQpKSB7CiAgICAgICAgICAgICAgICAvL09ULmxvZygiQ2xpZW50RXZlbnRzLmVycm9yIGhhcyB0aHJvdHRsZWQgYW4gZXJyb3Igb2YgdHlwZSAiICsgdHlwZSArICIuIiArIGNvZGUgKyAiIGZvciBwYXJ0bmVyICIgKyAocGFydG5lcklkIHx8ICdObyBQYXJ0bmVyIElkJykpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZXJyS2V5ID0gW3BhcnRuZXJJZCwgdHlwZSwgY29kZV0uam9pbignXycpLAoKICAgICAgICAgICAgICAgIHBheWxvYWQgPSB0aGlzLmVzY2FwZVBheWxvYWQoT1QuJC5leHRlbmQoZGV0YWlscyB8fCB7fSwgewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgdXNlckFnZW50OiBuYXZpZ2F0b3IudXNlckFnZW50CiAgICAgICAgICAgICAgICB9KSk7CgoKICAgICAgICAgICAgcmVwb3J0ZWRFcnJvcnNbZXJyS2V5XSA9IHR5cGVvZihyZXBvcnRlZEVycm9yc1tlcnJLZXldKSAhPT0gJ3VuZGVmaW5lZCcgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcG9ydGVkRXJyb3JzW2VycktleV0gKyAxIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9nRXZlbnQoT1QuJC5leHRlbmQob3B0aW9ucywgewogICAgICAgICAgICAgICAgYWN0aW9uOiB0eXBlICsgJy4nICsgY29kZSwKICAgICAgICAgICAgICAgIHBheWxvYWRUeXBlOiBwYXlsb2FkWzBdLAogICAgICAgICAgICAgICAgcGF5bG9hZDogcGF5bG9hZFsxXQogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gTG9nIGEgY2xpZW50IGV2ZW50IHRvIHRoZSBhbmFseXRpY3MgYmFja2VuZC4KICAgICAgICAvLwogICAgICAgIC8vIEBleGFtcGxlIExvZ3MgYSBjbGllbnQgZXZlbnQgY2FsbGVkICdmb28nCiAgICAgICAgLy8gIE9ULkNsaWVudEV2ZW50cy5sb2coewogICAgICAgIC8vICAgICAgYWN0aW9uOiAnZm9vJywKICAgICAgICAvLyAgICAgIHBheWxvYWRfdHlwZTogImZvbydzIHBheWxvYWQiLAogICAgICAgIC8vICAgICAgcGF5bG9hZDogJ2JhcicsCiAgICAgICAgLy8gICAgICBzZXNzaW9uX2lkOiBzZXNzaW9uSWQsCiAgICAgICAgLy8gICAgICBjb25uZWN0aW9uX2lkOiBjb25uZWN0aW9uSWQKICAgICAgICAvLyAgfSkKICAgICAgICAvLwogICAgICAgIC8vIEBwYXJhbSBbSGFzaF0gb3B0aW9ucyB0aGUgb3B0aW9ucyB0byBsb2cgdGhlIGNsaWVudCBldmVudCB3aXRoLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBhY3Rpb24gVGhlIG5hbWUgb2YgdGhlIEV2ZW50IHRoYXQgd2UgYXJlIGxvZ2dpbmcuIEUuZy4gIlRva1Nob3dMb2FkZWQiLiBSZXF1aXJlZC4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gdmFyaWF0aW9uIFVzdWFsbHkgdXNlZCBmb3IgU3BsaXQgQS9CIHRlc3RpbmcsIHdoZW4geW91IGhhdmUgbXVsdGlwbGUgdmFyaWF0aW9ucyBvZiB0aGUgK19hY3Rpb24rLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXlsb2FkVHlwZSBBIHRleHQgZGVzY3JpcHRpb24gb2YgdGhlIHBheWxvYWQuIFJlcXVpcmVkLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXlsb2FkIFRoZSBwYXlsb2FkLiBSZXF1aXJlZC4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gc2Vzc2lvbl9pZCBUaGUgYWN0aXZlIE9wZW5Ub2sgc2Vzc2lvbiwgaWYgdGhlcmUgaXMgb25lCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIGNvbm5lY3Rpb25faWQgVGhlIGFjdGl2ZSBPcGVuVG9rIGNvbm5lY3Rpb25JZCwgaWYgdGhlcmUgaXMgb25lCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIHBhcnRuZXJfaWQKICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gZ3VpZCAuLi4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gd2lkZ2V0X2lkIC4uLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBzdHJlYW1faWQgLi4uCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIHNlY3Rpb24gLi4uCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIGJ1aWxkIC4uLgogICAgICAgIC8vCiAgICAgICAgdGhpcy5sb2dFdmVudCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHBhcnRuZXJJZCA9IG9wdGlvbnMucGFydG5lcklkOwoKICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CgogICAgICAgICAgICAvLyBTZXQgYSBidW5jaCBvZiBkZWZhdWx0cwogICAgICAgICAgICB2YXIgZGF0YSA9IE9ULiQuZXh0ZW5kKHsKICAgICAgICAgICAgICAgICAgICAidmFyaWF0aW9uIiA6ICIiLAogICAgICAgICAgICAgICAgICAgICdndWlkJyA6IHRoaXMuZ2V0Q2xpZW50R3VpZCgpLAogICAgICAgICAgICAgICAgICAgICd3aWRnZXRfaWQnIDogIiIsCiAgICAgICAgICAgICAgICAgICAgJ3Nlc3Npb25faWQnOiAnJywKICAgICAgICAgICAgICAgICAgICAnY29ubmVjdGlvbl9pZCc6ICcnLAogICAgICAgICAgICAgICAgICAgICdzdHJlYW1faWQnIDogIiIsCiAgICAgICAgICAgICAgICAgICAgJ3BhcnRuZXJfaWQnIDogcGFydG5lcklkLAogICAgICAgICAgICAgICAgICAgICdzb3VyY2UnIDogd2luZG93LmxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgICAgICAgICAgJ3NlY3Rpb24nIDogIiIsCiAgICAgICAgICAgICAgICAgICAgJ2J1aWxkJyA6ICIiCiAgICAgICAgICAgICAgICB9LCBvcHRpb25zKSwKCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIC8vICBPVC5sb2coImxvZ2dlZDogIiArICJ7YWN0aW9uOiAiICsgZGF0YVsiYWN0aW9uIl0gKyAiLCB2YXJpYXRpb246ICIgKyBkYXRhWyJ2YXJpYXRpb24iXSArICIsIHBheWxvYWRfdHlwZTogIiArIGRhdGFbInBheWxvYWRfdHlwZSJdICsgIiwgcGF5bG9hZDogIiArIGRhdGFbInBheWxvYWQiXSArICJ9Iik7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2UgY2FtZWwtY2FzZSBvdXIgbmFtZXMsIGJ1dCB0aGUgQ2xpZW50RXZlbnRzIGJhY2tlbmQgd2FudHMgdGhlbQogICAgICAgICAgICAvLyB1bmRlcnNjb3JlZC4uLgogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY2FtZWxDYXNlZEtleXMpIHsKICAgICAgICAgICAgICAgIGlmIChjYW1lbENhc2VkS2V5cy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGRhdGFba2V5XSkgewogICAgICAgICAgICAgICAgICAgIGRhdGFbY2FtZWxDYXNlZEtleXNba2V5XV0gPSBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcG9zdChkYXRhLCBvbkNvbXBsZXRlLCBmYWxzZSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gTG9nIGEgY2xpZW50IFFPUyB0byB0aGUgYW5hbHl0aWNzIGJhY2tlbmQuCiAgICAgICAgLy8KICAgICAgICB0aGlzLmxvZ1FPUyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHBhcnRuZXJJZCA9IG9wdGlvbnMucGFydG5lcklkOwoKICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CgogICAgICAgICAgICAvLyBTZXQgYSBidW5jaCBvZiBkZWZhdWx0cwogICAgICAgICAgICB2YXIgZGF0YSA9IE9ULiQuZXh0ZW5kKHsKICAgICAgICAgICAgICAgICAgICAnZ3VpZCcgOiB0aGlzLmdldENsaWVudEd1aWQoKSwKICAgICAgICAgICAgICAgICAgICAnd2lkZ2V0X2lkJyA6ICIiLAogICAgICAgICAgICAgICAgICAgICdzZXNzaW9uX2lkJzogJycsCiAgICAgICAgICAgICAgICAgICAgJ2Nvbm5lY3Rpb25faWQnOiAnJywKICAgICAgICAgICAgICAgICAgICAnc3RyZWFtX2lkJyA6ICIiLAogICAgICAgICAgICAgICAgICAgICdwYXJ0bmVyX2lkJyA6IHBhcnRuZXJJZCwKICAgICAgICAgICAgICAgICAgICAnc291cmNlJyA6IHdpbmRvdy5sb2NhdGlvbi5ocmVmLAogICAgICAgICAgICAgICAgICAgICdidWlsZCcgOiAiIiwKICAgICAgICAgICAgICAgICAgICAnZHVyYXRpb24nIDogMCAvL2luIG1pbGxpc2Vjb25kcwogICAgICAgICAgICAgICAgfSwgb3B0aW9ucyksCgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgLy9PVC5sb2coImxvZ2dlZDogIiArICJ7YWN0aW9uOiAiICsgZGF0YVsiYWN0aW9uIl0gKyAiLCB2YXJpYXRpb246ICIgKyBkYXRhWyJ2YXJpYXRpb24iXSArICIsIHBheWxvYWRfdHlwZTogIiArIGRhdGFbInBheWxvYWRfdHlwZSJdICsgIiwgcGF5bG9hZDogIiArIGRhdGFbInBheWxvYWQiXSArICJ9Iik7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2UgY2FtZWwtY2FzZSBvdXIgbmFtZXMsIGJ1dCB0aGUgQ2xpZW50RXZlbnRzIGJhY2tlbmQgd2FudHMgdGhlbQogICAgICAgICAgICAvLyB1bmRlcnNjb3JlZC4uLgogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY2FtZWxDYXNlZEtleXMpIHsKICAgICAgICAgICAgICAgIGlmIChjYW1lbENhc2VkS2V5cy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGRhdGFba2V5XSkgewogICAgICAgICAgICAgICAgICAgIGRhdGFbY2FtZWxDYXNlZEtleXNba2V5XV0gPSBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcG9zdChkYXRhLCBvbkNvbXBsZXRlLCB0cnVlKTsKICAgICAgICB9OwoKICAgICAgICAvLyBDb252ZXJ0cyArcGF5bG9hZCsgdG8gdHdvIHBpcGUgc2VwZXJhdGVkIHN0cmluZ3MuIERvZXNuJ3QgY3VycmVudGx5IGhhbmRsZQogICAgICAgIC8vIGVkZ2VjYXNlcywgZS5nLiBlc2NhcGluZyAiXFx8IiB3aWxsIGJyZWFrIHN0dWZmLgogICAgICAgIC8vCiAgICAgICAgLy8gKk5vdGU6KiBJdCBzdHJpcCBhbnkga2V5cyB0aGF0IGhhdmUgbnVsbCB2YWx1ZXMuCiAgICAgICAgdGhpcy5lc2NhcGVQYXlsb2FkID0gZnVuY3Rpb24ocGF5bG9hZCkgewogICAgICAgICAgICB2YXIgZXNjYXBlZFBheWxvYWQgPSBbXSwKICAgICAgICAgICAgICAgIGVzY2FwZWRQYXlsb2FkRGVzYyA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHBheWxvYWQpIHsKICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLmhhc093blByb3BlcnR5KGtleSkgJiYgcGF5bG9hZFtrZXldICE9PSBudWxsICYmIHBheWxvYWRba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgZXNjYXBlZFBheWxvYWQucHVzaCggcGF5bG9hZFtrZXldID8gcGF5bG9hZFtrZXldLnRvU3RyaW5nKCkucmVwbGFjZSgnfCcsICdcXHwnKSA6ICcnICk7CiAgICAgICAgICAgICAgICAgICAgZXNjYXBlZFBheWxvYWREZXNjLnB1c2goIGtleS50b1N0cmluZygpLnJlcGxhY2UoJ3wnLCAnXFx8JykgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIGVzY2FwZWRQYXlsb2FkRGVzYy5qb2luKCd8JyksCiAgICAgICAgICAgICAgICBlc2NhcGVkUGF5bG9hZC5qb2luKCd8JykKICAgICAgICAgICAgXTsKICAgICAgICB9OwogICAgICAgIC8vIFVzZXMgSFRNTDUgbG9jYWwgc3RvcmFnZSB0byBzYXZlIGEgY2xpZW50IElELgogICAgICAgIHRoaXMuZ2V0Q2xpZW50R3VpZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgIGd1aWQgPSBPVC4kLmdldENvb2tpZSgib3BlbnRva19jbGllbnRfaWQiKTsKICAgICAgICAgICAgaWYgKCFndWlkKSB7CiAgICAgICAgICAgICAgICBndWlkID0gT1QuJC51dWlkKCk7CiAgICAgICAgICAgICAgICBPVC4kLnNldENvb2tpZSgib3BlbnRva19jbGllbnRfaWQiLCBndWlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ3VpZDsKICAgICAgICB9Owp9Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7CgovLyBUaGlzIGlzIG5vdCBvYnZpb3VzLCBzbyB0byBwcmV2ZW50IGVuZC11c2VyIGZydXN0cmF0aW9uIHdlJ2xsIGxldCB0aGVtIGtub3cKLy8gZXhwbGljaXRseSByYXRoZXIgdGhhbiBmYWlsaW5nIHdpdGggYSBidW5jaCBvZiBwZXJtaXNzaW9uIGVycm9ycy4gV2UgZG9uJ3QKLy8gaGFuZGxlIHRoaXMgdXNpbmcgYW4gT1QgRXhjZXB0aW9uIGFzIGl0J3MgcmVhbGx5IG9ubHkgYSBkZXZlbG9wbWVudCB0aGluZy4KaWYgKGxvY2F0aW9uLnByb3RvY29sID09PSAnZmlsZTonKSB7CiAgYWxlcnQoIllvdSBjYW5ub3QgdGVzdCBhIHBhZ2UgdXNpbmcgV2ViUlRDIHRocm91Z2ggdGhlIGZpbGUgc3lzdGVtIGR1ZSB0byBicm93c2VyIHBlcm1pc3Npb25zLiBZb3UgbXVzdCBydW4gaXQgb3ZlciBhIHdlYiBzZXJ2ZXIuIik7Cn0KCmlmICghd2luZG93Lk9UKSB3aW5kb3cuT1QgPSB7fTsKCmlmICghd2luZG93LlVSTCAmJiB3aW5kb3cud2Via2l0VVJMKSB7CiAgICB3aW5kb3cuVVJMID0gd2luZG93LndlYmtpdFVSTDsKfQoKdmFyIF9wdWJsaXNoZXJDb3VudCA9IDAsCgogICAgLy8gR2xvYmFsIHBhcmFtZXRlcnMgdXNlZCBieSB1cGdyYWRlU3lzdGVtUmVxdWlyZW1lbnRzCiAgICBfaW50ZXJ2YWxJZCwKICAgIF9sYXN0SGFzaCA9IGRvY3VtZW50LmxvY2F0aW9uLmhhc2gsCgogICAgLy8gQ2FjaGVkIERldmljZU1hbmFnZXIKICAgIF9kZXZpY2VNYW5hZ2VyOwoKCi8qKgoqIFRoZSBmaXJzdCBzdGVwIGluIHVzaW5nIHRoZSBPcGVuVG9rIEFQSSBpcyB0byBjYWxsIHRoZSA8Y29kZT5UQi5pbml0U2Vzc2lvbigpPC9jb2RlPiBtZXRob2QuIE90aGVyIG1ldGhvZHMgb2YgdGhlIFRCIG9iamVjdAoqIGNoZWNrIGZvciBzeXN0ZW0gcmVxdWlyZW1lbnRzIGFuZCBzZXQgdXAgZXJyb3IgbG9nZ2luZy4KKgoqIEBjbGFzcyBUQgoqLwoKLyoqCiogPHAgY2xhc3M9Im1TdW1tYXJ5Ij4KKiBJbml0aWFsaXplcyBhbmQgcmV0dXJucyB0aGUgbG9jYWwgc2Vzc2lvbiBvYmplY3QgZm9yIGEgc3BlY2lmaWVkIHNlc3Npb24gSUQuCiogPC9wPgoqIDxwPgoqIFlvdSBjb25uZWN0IHRvIGFuIE9wZW5Ub2sgc2Vzc2lvbiB1c2luZyB0aGUgPGNvZGU+Y29ubmVjdCgpPC9jb2RlPiBtZXRob2QKKiBvZiB0aGUgU2Vzc2lvbiBvYmplY3QgcmV0dXJuZWQgYnkgdGhlIDxjb2RlPlRCLmluaXRTZXNzaW9uKCk8L2NvZGU+IG1ldGhvZC4KKiBOb3RlIHRoYXQgY2FsbGluZyA8Y29kZT5UQi5pbml0U2Vzc2lvbigpPC9jb2RlPiBkb2VzIG5vdCBpbml0aWF0ZSBjb21tdW5pY2F0aW9ucwoqIHdpdGggdGhlIGNsb3VkLiBJdCBzaW1wbHkgaW5pdGlhbGl6ZXMgdGhlIFNlc3Npb24gb2JqZWN0IHRoYXQgeW91IGNhbiB1c2UgdG8KKiBjb25uZWN0IChhbmQgdG8gcGVyZm9ybSBvdGhlciBvcGVyYXRpb25zIG9uY2UgY29ubmVjdGVkKS4KKiA8L3A+CioKKiAgPHA+CiogICAgRm9yIGFuIGV4YW1wbGUsIHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjY29ubmVjdCI+U2Vzc2lvbi5jb25uZWN0KCk8L2E+LgoqICA8L3A+CioKKiBAbWV0aG9kIFRCLmluaXRTZXNzaW9uCiogQG1lbWJlcm9mIFRCCiogQHBhcmFtIHtTdHJpbmd9IHNlc3Npb25JZCBUaGUgc2Vzc2lvbiBJRCBpZGVudGlmeWluZyB0aGUgT3BlblRvayBzZXNzaW9uLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlCiogPGEgaHJlZj0iL29wZW50b2svdHV0b3JpYWxzL2NyZWF0ZS1zZXNzaW9uLyI+U2Vzc2lvbiBjcmVhdGlvbjwvYT4uCiogQHJldHVybnMge1Nlc3Npb259IFRoZSBzZXNzaW9uIG9iamVjdCB0aHJvdWdoIHdoaWNoIGFsbCBmdXJ0aGVyIGludGVyYWN0aW9ucyB3aXRoIHRoZSBzZXNzaW9uIHdpbGwgb2NjdXIuCiovCk9ULmluaXRTZXNzaW9uID0gZnVuY3Rpb24oc2Vzc2lvbklkKSB7CiAgICB2YXIgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChzZXNzaW9uSWQpOwoKICAgIGlmICghc2Vzc2lvbikgewogICAgICAgIHNlc3Npb24gPSBuZXcgT1QuU2Vzc2lvbihzZXNzaW9uSWQpOwogICAgICAgIE9ULnNlc3Npb25zLmFkZChzZXNzaW9uKTsKICAgIH0KCiAgICByZXR1cm4gc2Vzc2lvbjsKfTsKCi8qKgoqIDxwIGNsYXNzPSJtU3VtbWFyeSI+CiogICBJbml0aWFsaXplcyBhbmQgcmV0dXJucyBhIFB1Ymxpc2hlciBvYmplY3QuIFlvdSBjYW4gdGhlbiBwYXNzIHRoaXMgUHVibGlzaGVyCiogICBvYmplY3QgdG8gPGNvZGU+U2Vzc2lvbi5wdWJsaXNoKCk8L2NvZGU+IHRvIHB1Ymxpc2ggYSBzdHJlYW0gdG8gYSBzZXNzaW9uLgoqIDwvcD4KKiA8cD4KKiAgIDxpPk5vdGU6PC9pPiBJZiB5b3UgaW50ZW5kIHRvIHJldXNlIGEgUHVibGlzaGVyIG9iamVjdCBjcmVhdGVkIHVzaW5nIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4KKiAgIHRvIHB1Ymxpc2ggdG8gZGlmZmVyZW50IHNlc3Npb25zIHNlcXVlbnRpYWxseSwgY2FsbCBlaXRoZXIgPGNvZGU+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2NvZGU+IG9yCiogICA8Y29kZT5TZXNzaW9uLnVucHVibGlzaCgpPC9jb2RlPi4gRG8gbm90IGNhbGwgYm90aC4gVGhlbiBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2QKKiAgIG9mIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IG9yIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0ZWQ8L2NvZGU+IGV2ZW50IG9iamVjdCB0byBwcmV2ZW50IHRoZQoqICAgUHVibGlzaGVyIG9iamVjdCBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcGFnZS4KKiA8L3A+CiogQHBhcmFtIHtTdHJpbmd9IGFwaUtleSBUaGUgQVBJIGtleSB0aGF0IFRva0JveCBwcm92aWRlZCB5b3Ugd2hlbiB5b3UKKiA8YSBocmVmPSJodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3VzZXJzL3NpZ25faW4iPnNpZ25lZCB1cDwvYT4gZm9yIGFuIE9wZW5Ub2sgYWNjb3VudC4KKiBAcGFyYW0ge1N0cmluZ30gdGFyZ2V0RWxlbWVudCBUaGUKKiA8Y29kZT5pZDwvY29kZT4gYXR0cmlidXRlIG9mIHRoZSBleGlzdGluZyBET00gZWxlbWVudCB0aGF0IHRoZSBQdWJsaXNoZXIgdmlkZW8gcmVwbGFjZXMuCiogSWYgeW91IGRvIG5vdCBzcGVjaWZ5IGEgPGNvZGU+dGFyZ2V0RWxlbWVudDwvY29kZT4sIHRoZSBhcHBsaWNhdGlvbgoqIGFwcGVuZHMgYSBuZXcgRE9NIGVsZW1lbnQgdG8gdGhlIEhUTUwgPGNvZGU+Ym9keTwvY29kZT4uCioKKiA8cD4KKiAgICAgICBUaGUgYXBwbGljYXRpb24gdGhyb3dzIGFuIGVycm9yIGlmIGFuIGVsZW1lbnQgd2l0aCBhbiBJRCBzZXQgdG8gdGhlIDxjb2RlPnRhcmdldEVsZW1lbnQ8L2NvZGU+CiogICAgICAgdmFsdWUgZG9lcyBub3QgZXhpc3QgaW4gdGhlIEhUTUwgRE9NLgoqIDwvcD4KKgoqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0aWVzIFRoaXMgaXMKKiBhbiA8ZW0+b3B0aW9uYWw8L2VtPiBvYmplY3QgdGhhdCBjb250YWlucyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXMgKGVhY2ggb2Ygd2hpY2ggYXJlIG9wdGlvbmFsKToKKiA8L3A+CiogPHVsPgoqIDxsaT4KKiAgIDxzdHJvbmc+aGVpZ2h0PC9zdHJvbmc+IChOdW1iZXIpICYjMTUxOyBUaGUgZGVzaXJlZCBoZWlnaHQsIGluIHBpeGVscywgb2YgdGhlCiogICBkaXNwbGF5ZWQgUHVibGlzaGVyIHZpZGVvIHN0cmVhbSAoZGVmYXVsdDogMTk4KS4gPGk+Tm90ZTo8L2k+IFVzZSB0aGUKKiAgIDxjb2RlPmhlaWdodDwvY29kZT4gYW5kIDxjb2RlPndpZHRoPC9jb2RlPiBwcm9wZXJ0aWVzIHRvIHNldCB0aGUgZGltZW5zaW9ucwoqICAgb2YgdGhlIHB1Ymxpc2hlciB2aWRlbzsgZG8gbm90IHNldCB0aGUgaGVpZ2h0IGFuZCB3aWR0aCBvZiB0aGUgRE9NIGVsZW1lbnQKKiAgICh1c2luZyBDU1MpLgoqIDwvbGk+CiogPGxpPgoqICAgPHN0cm9uZz5taXJyb3I8L3N0cm9uZz4gKEJvb2xlYW4pICYjMTUxOyBXaGV0aGVyIHRoZSBwdWJsaXNoZXIncyB2aWRlbyBpbWFnZQoqICAgaXMgbWlycm9yZWQgaW4gdGhlIHB1Ymxpc2hlcidzIHBhZ2U8LiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyA8Y29kZT50cnVlPC9jb2RlPgoqICAgKHRoZSB2aWRlbyBpbWFnZSBpcyBtaXJyb3JlZCkuIFRoaXMgcHJvcGVydHkgZG9lcyBub3QgYWZmZWN0IHRoZSBkaXNwbGF5CiogICBvbiBvdGhlciBzdWJzY3JpYmVycycgd2ViIHBhZ2VzLgoqIDwvbGk+CiogPGxpPgoqICAgPHN0cm9uZz5uYW1lPC9zdHJvbmc+IChTdHJpbmcpICYjMTUxOyBUaGUgbmFtZSBmb3IgdGhpcyBzdHJlYW0uIFRoZSBuYW1lIGFwcGVhcnMgYXQgdGhlIGJvdHRvbSBvZgoqICAgU3Vic2NyaWJlciB2aWRlb3MuIFRoZSBkZWZhdWx0IHZhbHVlIGlzICIiIChhbiBlbXB0eSBzdHJpbmcpLiBTZXR0aW5nIHRoaXMgdG8gYSBzdHJpbmcgbG9uZ2VyIHRoYW4KKiAgIDEwMDAgY2hhcmFjdGVycyByZXN1bHRzIGluIGFuIHJ1bnRpbWUgZXhjZXB0aW9uLgoqIDwvbGk+CiogPGxpPgoqICAgPHN0cm9uZz5wdWJsaXNoQXVkaW88L3N0cm9uZz4gKEJvb2xlYW4pICYjMTUxOyBXaGV0aGVyIHRvIGluaXRpYWxseSBwdWJsaXNoIGF1ZGlvCiogICBmb3IgdGhlIHN0cmVhbSAoZGVmYXVsdDogPGNvZGU+dHJ1ZTwvY29kZT4pLiBUaGlzIHNldHRpbmcgYXBwbGllcyB3aGVuIHlvdSBwYXNzCiogICB0aGUgUHVibGlzaGVyIG9iamVjdCBpbiBhIGNhbGwgdG8gdGhlIDxjb2RlPlNlc3Npb24ucHVibGlzaCgpPC9jb2RlPiBtZXRob2QuCiogPC9saT4KKiA8bGk+CiogICA8c3Ryb25nPnB1Ymxpc2hWaWRlbzwvc3Ryb25nPiAoQm9vbGVhbikgJiMxNTE7IFdoZXRoZXIgdG8gaW5pdGlhbGx5IHB1Ymxpc2ggdmlkZW8KKiAgIGZvciB0aGUgc3RyZWFtIChkZWZhdWx0OiA8Y29kZT50cnVlPC9jb2RlPikuIFRoaXMgc2V0dGluZyBhcHBsaWVzIHdoZW4geW91IHBhc3MKKiAgIHRoZSBQdWJsaXNoZXIgb2JqZWN0IGluIGEgY2FsbCB0byB0aGUgPGNvZGU+U2Vzc2lvbi5wdWJsaXNoKCk8L2NvZGU+IG1ldGhvZC4KKiA8L2xpPgoqIDxsaT4KKiAgIDxzdHJvbmc+c3R5bGU8L3N0cm9uZz4gKE9iamVjdCkgJiMxNTE7IEFuIG9iamVjdCBjb250YWluaW5nIHByb3BlcnRpZXMgdGhhdCBkZWZpbmUgdGhlIGluaXRpYWwKKiAgIGFwcGVhcmFuY2Ugb2YgdXNlciBpbnRlcmZhY2UgY29udHJvbHMgb2YgdGhlIFB1Ymxpc2hlci4gQ3VycmVudGx5LCB0aGUgPGNvZGU+c3R5bGU8L2NvZGU+IG9iamVjdAoqICAgaW5jbHVkZXMgb25lIHByb3BlcnR5OiA8Y29kZT5uYW1lRGlzcGxheU1vZGU8L2NvZGU+LiBQb3NzaWJsZSB2YWx1ZXMgZm9yIHRoZSA8Y29kZT5zdHlsZS5uYW1lRGlzcGxheU1vZGU8L2NvZGU+CiogICBwcm9wZXJ0eSBhcmU6IDxjb2RlPiJhdXRvIjwvY29kZT4gKHRoZSBuYW1lIGlzIGRpc3BsYXllZCB3aGVuIHRoZSBzdHJlYW0gaXMgZmlyc3QgZGlzcGxheWVkCiogICBhbmQgd2hlbiB0aGUgdXNlciBtb3VzZXMgb3ZlciB0aGUgZGlzcGxheSksIDxjb2RlPiJvZmYiPC9jb2RlPiAodGhlIG5hbWUgaXMgbm90IGRpc3BsYXllZCksCiogICBhbmQgPGNvZGU+Im9uIjwvY29kZT4gKHRoZSBuYW1lIGlzIGRpc3BsYXllZCkuPC9saT4KKiA8L2xpPgoqIDxsaT4KKiAgIDxzdHJvbmc+d2lkdGg8L3N0cm9uZz4gKE51bWJlcikgJiMxNTE7IFRoZSBkZXNpcmVkIHdpZHRoLCBpbiBwaXhlbHMsIG9mIHRoZQoqICAgZGlzcGxheWVkIFB1Ymxpc2hlciB2aWRlbyBzdHJlYW0gKGRlZmF1bHQ6IDI2NCkuIDxpPk5vdGU6PC9pPiBVc2UgdGhlCiogICA8Y29kZT5oZWlnaHQ8L2NvZGU+IGFuZCA8Y29kZT53aWR0aDwvY29kZT4gcHJvcGVydGllcyB0byBzZXQgdGhlIGRpbWVuc2lvbnMKKiAgIG9mIHRoZSBwdWJsaXNoZXIgdmlkZW87IGRvIG5vdCBzZXQgdGhlIGhlaWdodCBhbmQgd2lkdGggb2YgdGhlIERPTSBlbGVtZW50CiogICAodXNpbmcgQ1NTKS4KKiA8L2xpPgoqIDwvdWw+CioKKiBAcmV0dXJucyB7UHVibGlzaGVyfSBUaGUgUHVibGlzaGVyIG9iamVjdC4KKiBAc2VlIFNlc3Npb24jcHVibGlzaAoqIEBtZXRob2QgVEIuaW5pdFB1Ymxpc2hlcgoqIEBtZW1iZXJvZiBUQgoqLwpPVC5pbml0UHVibGlzaGVyID0gZnVuY3Rpb24oYXBpS2V5LCB0YXJnZXRFbGVtZW50LCBwcm9wZXJ0aWVzLCBjb21wbGV0aW9uSGFuZGxlcikgewogICAgT1QuZGVidWcoIlRCLmluaXRQdWJsaXNoZXIoIit0YXJnZXRFbGVtZW50KyIpIik7CgogICAgdmFyIHB1Ymxpc2hlciA9IG5ldyBPVC5QdWJsaXNoZXIoKTs7CiAgICBPVC5wdWJsaXNoZXJzLmFkZChwdWJsaXNoZXIpOwoKICAgIGlmIChjb21wbGV0aW9uSGFuZGxlciAmJiBPVC4kLmlzRnVuY3Rpb24oY29tcGxldGlvbkhhbmRsZXIpKSB7CiAgICAgICAgdmFyIHJlbW92ZUhhbmRsZXJzQW5kQ2FsbENvbXBsZXRlID0gZnVuY3Rpb24gcmVtb3ZlSGFuZGxlcnNBbmRDYWxsQ29tcGxldGUgKGVycm9yKSB7CiAgICAgICAgICAgIHB1Ymxpc2hlci5vZmYoJ2luaXRTdWNjZXNzJywgcmVtb3ZlSGFuZGxlcnNBbmRDYWxsQ29tcGxldGUpOwogICAgICAgICAgICBwdWJsaXNoZXIub2ZmKCdwdWJsaXNoQ29tcGxldGUnLCByZW1vdmVIYW5kbGVyc0FuZENhbGxDb21wbGV0ZSk7CgogICAgICAgICAgICBjb21wbGV0aW9uSGFuZGxlci5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgIH07CgogICAgICAgIHB1Ymxpc2hlci5vbmNlKCdpbml0U3VjY2VzcycsIHJlbW92ZUhhbmRsZXJzQW5kQ2FsbENvbXBsZXRlKTsKICAgICAgICBwdWJsaXNoZXIub25jZSgncHVibGlzaENvbXBsZXRlJywgcmVtb3ZlSGFuZGxlcnNBbmRDYWxsQ29tcGxldGUpOwogICAgfQoKICAgIHB1Ymxpc2hlci5wdWJsaXNoKHRhcmdldEVsZW1lbnQsIHByb3BlcnRpZXMpOwoKICAgIHJldHVybiBwdWJsaXNoZXI7Cn07CgoKCi8qKgoqIENoZWNrcyBpZiB0aGUgc3lzdGVtIHN1cHBvcnRzIE9wZW5Ub2sgZm9yIFdlYlJUQy4KKiBAcmV0dXJuIHtOdW1iZXJ9IFdoZXRoZXIgdGhlIHN5c3RlbSBzdXBwb3J0cyBPcGVuVG9rIGZvciBXZWJSVEMgKDEpIG9yIG5vdCAoMCkuCiogQHNlZSA8YSBocmVmPSIjdXBncmFkZVN5c3RlbVJlcXVpcmVtZW50cyI+VEIudXBncmFkZVN5c3RlbVJlcXVpcmVtZW50cygpPC9hPgoqIEBtZXRob2QgVEIuY2hlY2tTeXN0ZW1SZXF1aXJlbWVudHMKKiBAbWVtYmVyb2YgVEIKKi8KT1QuY2hlY2tTeXN0ZW1SZXF1aXJlbWVudHMgPSBmdW5jdGlvbigpIHsKICAgIE9ULmRlYnVnKCJUQi5jaGVja1N5c3RlbVJlcXVpcmVtZW50cygpIik7CgogICAgdmFyIHN5c3RlbVJlcXVpcmVtZW50c01ldCA9IE9ULiQuc3VwcG9ydHNXZWJTb2NrZXRzKCkgJiYgT1QuJC5zdXBwb3J0c1dlYlJUQygpID8gdGhpcy5IQVNfUkVRVUlSRU1FTlRTIDogdGhpcy5OT1RfSEFTX1JFUVVJUkVNRU5UUzsKCiAgICBPVC5jaGVja1N5c3RlbVJlcXVpcmVtZW50cyA9IGZ1bmN0aW9uKCkgewogICAgICBPVC5kZWJ1ZygiVEIuY2hlY2tTeXN0ZW1SZXF1aXJlbWVudHMoKSIpOwogICAgICByZXR1cm4gc3lzdGVtUmVxdWlyZW1lbnRzTWV0OwogICAgfTsKCiAgICByZXR1cm4gc3lzdGVtUmVxdWlyZW1lbnRzTWV0Owp9OwoKCi8qKgoqIERpc3BsYXlzIGluZm9ybWF0aW9uIGFib3V0IHN5c3RlbSByZXF1aXJtZW50cyBmb3IgT3BlblRvayBmb3IgV2ViUlRDLiBUaGlzIGluZm9ybWF0aW9uIGlzIGRpc3BsYXllZAoqIGluIGFuIGlmcmFtZSBlbGVtZW50IHRoYXQgZmlsbHMgdGhlIGJyb3dzZXIgd2luZG93LgoqIDxwPgoqIDxpPk5vdGU6PC9pPiB0aGlzIGluZm9ybWF0aW9uIGlzIGRpc3BsYXllZCBhdXRvbWF0aWNhbGx5IHdoZW4geW91IGNhbGwgdGhlIDxjb2RlPlRCLmluaXRTZXNzaW9uKCk8L2NvZGU+Ciogb3IgdGhlIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4gbWV0aG9kIGlmIHRoZSBjbGllbnQgZG9lcyBub3Qgc3VwcG9ydCBPcGVuVG9rIGZvciBXZWJSVEMuCiogPC9wPgoqIEBzZWUgPGEgaHJlZj0iI2NoZWNrU3lzdGVtUmVxdWlyZW1lbnRzIj5UQi5jaGVja1N5c3RlbVJlcXVpcmVtZW50cygpPC9hPgoqIEBtZXRob2QgVEIudXBncmFkZVN5c3RlbVJlcXVpcmVtZW50cwoqIEBtZW1iZXJvZiBUQgoqLwpPVC51cGdyYWRlU3lzdGVtUmVxdWlyZW1lbnRzID0gZnVuY3Rpb24oKXsKICAgIC8vIHRyaWdnZXIgYWZ0ZXIgdGhlIFRCIGVudmlyb25tZW50IGhhcyBsb2FkZWQKICAgIE9ULm9uTG9hZCggZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgdGhlcmUgaXMgYSBDaHJvbWUgRnJhbWUgbWV0YSB0YWcgb24gdGhlIHBhZ2UuIElmIHRoZXJlIGlzIHRoZW4gd2UgcHJvbXB0IHRvIGluc3RhbGwgQ2hyb21lIEZyYW1lCiAgICAgICAgdmFyIGNmTWV0YVRhZyA9IGZhbHNlLAogICAgICAgICAgICBtZXRhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJtZXRhIik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZXRhcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgaHR0cEVxdWl2ID0gbWV0YXNbaV0uaHR0cEVxdWl2LAogICAgICAgICAgICAgICAgY29udGVudCA9IG1ldGFzW2ldLmNvbnRlbnQ7CiAgICAgICAgICAgIGlmIChodHRwRXF1aXYgJiYgaHR0cEVxdWl2LnRvTG93ZXJDYXNlKCkgPT09ICJ4LXVhLWNvbXBhdGlibGUiICYmCiAgICAgICAgICAgICAgICBjb250ZW50ICYmIGNvbnRlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCJjaHJvbWU9MSIpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICBjZk1ldGFUYWcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgaWQgPSAnX3VwZ3JhZGVGbGFzaCc7CgogICAgICAgICAvLyBMb2FkIHRoZSBpZnJhbWUgb3ZlciB0aGUgd2hvbGUgcGFnZS4KICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCgoZnVuY3Rpb24oKXsKICAgICAgICAgICAgIHZhciBkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICAgICAgICAgICBkLmlkID0gaWQ7CiAgICAgICAgICAgICBkLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgIGQuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICAgZC5zdHlsZS5oZWlnaHQgPSAnMTAwJSc7CiAgICAgICAgICAgICBkLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICAgZC5zdHlsZS50b3AgPSAnMHB4JzsKICAgICAgICAgICAgIGQuc3R5bGUubGVmdCA9ICcwcHgnOwogICAgICAgICAgICAgZC5zdHlsZS5yaWdodCA9ICcwcHgnOwogICAgICAgICAgICAgZC5zdHlsZS5ib3R0b20gPSAnMHB4JzsKICAgICAgICAgICAgIGQuc3R5bGUuekluZGV4ID0gMTAwMDsKICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgZC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAicmdiYSgwLDAsMCwwLjIpIjsKICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgIC8vIE9sZCBJRSBicm93c2VycyBkb24ndCBzdXBwb3J0IHJnYmEgYW5kIHdlIHN0aWxsIHdhbnQgdG8gc2hvdyB0aGUgdXBncmFkZSBtZXNzYWdlCiAgICAgICAgICAgICAgICAgLy8gYnV0IHdlIGp1c3QgbWFrZSB0aGUgYmFja2dyb3VuZCBvZiB0aGUgaWZyYW1lIGNvbXBsZXRlbHkgdHJhbnNwYXJlbnQuCiAgICAgICAgICAgICAgICAgZC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAidHJhbnNwYXJlbnQiOwogICAgICAgICAgICAgICAgIGQuc2V0QXR0cmlidXRlKCJhbGxvd1RyYW5zcGFyZW5jeSIsICJ0cnVlIik7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgICBkLnNldEF0dHJpYnV0ZSgiZnJhbWVCb3JkZXIiLCAiMCIpOwogICAgICAgICAgICAgZC5mcmFtZUJvcmRlciA9ICIwIjsKICAgICAgICAgICAgIGQuc2Nyb2xsaW5nID0gIm5vIjsKICAgICAgICAgICAgIGQuc2V0QXR0cmlidXRlKCJzY3JvbGxpbmciLCAibm8iKTsKICAgICAgICAgICAgIGQuc3JjID0gT1QucHJvcGVydGllcy5hc3NldFVSTCArICIvaHRtbC91cGdyYWRlRmxhc2guaHRtbCIgKyAoY2ZNZXRhVGFnID8gIj9jZj0xIiA6ICIiKSArICIjIitlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQubG9jYXRpb24uaHJlZik7CiAgICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICAgfSkoKSk7CgogICAgICAgICAvLyBOb3cgd2UgbmVlZCB0byBsaXN0ZW4gdG8gdGhlIGV2ZW50IGhhbmRsZXIgaWYgdGhlIHVzZXIgY2xvc2VzIHRoaXMgZGlhbG9nLgogICAgICAgICAvLyBTaW5jZSB0aGlzIGlzIGZyb20gYW4gSUZSQU1FIHdpdGhpbiBhbm90aGVyIGRvbWFpbiB3ZSBhcmUgZ29pbmcgdG8gbGlzdGVuIHRvIGhhc2ggY2hhbmdlcy4KICAgICAgICAgLy8gVGhlIGJlc3QgY3Jvc3MgYnJvd3NlciBzb2x1dGlvbiBpcyB0byBwb2xsIGZvciBhIGNoYW5nZSBpbiB0aGUgaGFzaHRhZy4KICAgICAgICAgaWYgKF9pbnRlcnZhbElkKSBjbGVhckludGVydmFsKF9pbnRlcnZhbElkKTsKICAgICAgICAgX2ludGVydmFsSWQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpewogICAgICAgICAgICAgdmFyIGhhc2ggPSBkb2N1bWVudC5sb2NhdGlvbi5oYXNoLAogICAgICAgICAgICAgICAgIHJlID0gL14jP1xkKyYvOwogICAgICAgICAgICAgaWYgKGhhc2ggIT09IF9sYXN0SGFzaCAmJiByZS50ZXN0KGhhc2gpKSB7CiAgICAgICAgICAgICAgICAgX2xhc3RIYXNoID0gaGFzaDsKICAgICAgICAgICAgICAgICBpZiggaGFzaC5yZXBsYWNlKHJlLCAnJykgPT09ICdjbG9zZV93aW5kb3cnKXsKICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkpOwogICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gJyc7CiAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNoLnJlcGxhY2UocmUsICcnKSA9PT0gJ2luc3RhbGxlZF9nY2YnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2UgdGhlIHBhZ2UgdG8gcmVsb2FkIG5vdyB0aGF0IGNocm9tZSBmcmFtZSBpcyBpbnN0YWxsZWQKICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYucmVwbGFjZSgiIyIsICIiKTsKICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgIH0KICAgICAgICAgfSwgMTAwKTsKICAgIH0pOwp9OwoKCk9ULnJlcG9ydElzc3VlID0gZnVuY3Rpb24oKXsKICAgIE9ULndhcm4oIlRvRG86IGhhdmVuJ3QgeWV0IGltcGxlbWVudGVkIFRCLnJlcG9ydElzc3VlIik7Cn07CgpPVC5jb21wb25lbnRzID0ge307Ck9ULnNlc3Npb25zID0ge307CgovLyBuYW1lc3BhY2VzCk9ULnJ0YyA9IHt9OwoKLy8gRGVmaW5lIHRoZSBBUElLRVkgdGhpcyBpcyBhIGdsb2JhbCBwYXJhbWV0ZXIgd2hpY2ggc2hvdWxkIG5vdCBjaGFuZ2UKT1QuQVBJS0VZID0gKGZ1bmN0aW9uKCl7CiAgICAvLyBTY3JpcHQgZW1iZWQKICAgIHZhciBzY3JpcHRfc3JjID0gKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0Jyk7CiAgICAgICAgcyA9IHNbcy5sZW5ndGggLSAxXTsKICAgICAgICBzID0gcy5nZXRBdHRyaWJ1dGUoJ3NyYycpIHx8IHMuc3JjOwogICAgICAgIHJldHVybiBzOwogICAgfSkoKTsKCiAgICB2YXIgbSA9IHNjcmlwdF9zcmMubWF0Y2goL1tcP1wmXWFwaWtleT0oW14mXSspL2kpOwogICAgcmV0dXJuIG0gPyBtWzFdIDogJyc7Cn0pKCk7CgpPVC5IQVNfUkVRVUlSRU1FTlRTID0gMTsKT1QuTk9UX0hBU19SRVFVSVJFTUVOVFMgPSAwOwoKLyoqCiogUmVnaXN0ZXJzIGEgbWV0aG9kIGFzIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIHNwZWNpZmljIGV2ZW50LiBOb3RlIHRoYXQgdGhpcyBpcyBhIHN0YXRpYyBtZXRob2Qgb2YgdGhlIFRCIGNsYXNzLgoqCiogPHA+CiogVGhlIFRCIG9iamVjdCBkaXNwYXRjaGVzIG9uZSB0eXBlIG9mIGV2ZW50ICYjMTUxOyBhbiA8Y29kZT5leGNlcHRpb248L2NvZGU+IGV2ZW50LiBUaGUgZm9sbG93aW5nIGNvZGUgYWRkcyBhbiBldmVudAoqIGxpc3RlbmVyIGZvciB0aGUgPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudDoKKiA8L3A+CioKKiA8cHJlPgoqIFRCLmFkZEV2ZW50TGlzdGVuZXIoImV4Y2VwdGlvbiIsIGV4Y2VwdGlvbkhhbmRsZXIpOwoqCiogZnVuY3Rpb24gZXhjZXB0aW9uSGFuZGxlcihldmVudCkgewoqICAgIGFsZXJ0KCJleGNlcHRpb24gZXZlbnQuIFxuICBjb2RlID09ICIgKyBldmVudC5jb2RlICsgIlxuICBtZXNzYWdlID09ICIgKyBldmVudC5tZXNzYWdlKTsKKiB9CiogPC9wcmU+CioKKiA8cD4KKiAgIElmIGEgaGFuZGxlciBpcyBub3QgcmVnaXN0ZXJlZCBmb3IgYW4gZXZlbnQsIHRoZSBldmVudCBpcyBpZ25vcmVkIGxvY2FsbHkuIElmIHRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBkb2VzIG5vdCBleGlzdCwKKiAgIHRoZSBldmVudCBpcyBpZ25vcmVkIGxvY2FsbHkuCiogPC9wPgoqIDxwPgoqICAgVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZiB0aGUgPGNvZGU+bGlzdGVuZXI8L2NvZGU+IG5hbWUgaXMgaW52YWxpZC4KKiA8L3A+CioKKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIGlkZW50aWZ5aW5nIHRoZSB0eXBlIG9mIGV2ZW50LgoqCiogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgVGhlIGZ1bmN0aW9uIHRvIGJlIGludm9rZWQgd2hlbiB0aGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgdGhlIGV2ZW50LgoqIEBtZW1iZXJPZiBUQgoqIEBtZXRob2QgYWRkRXZlbnRMaXN0ZW5lcgoqLwoKLyoqCiogUmVtb3ZlcyBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBzcGVjaWZpYyBldmVudC4gTm90ZSB0aGF0IHRoaXMgaXMgYSBzdGF0aWMgbWV0aG9kIG9mIHRoZSBUQiBjbGFzcy4KKgoqIDxwPgoqICAgVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZiB0aGUgPGNvZGU+bGlzdGVuZXI8L2NvZGU+IG5hbWUgaXMgaW52YWxpZC4KKiA8L3A+CioKKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIGlkZW50aWZ5aW5nIHRoZSB0eXBlIG9mIGV2ZW50LgoqCiogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgVGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uIHRvIHJlbW92ZS4KKgoqIEBtZW1iZXJPZiBUQgoqIEBtZXRob2QgcmVtb3ZlRXZlbnRMaXN0ZW5lcgoqLwoKLyoqCiAqIERpc3BhdGNoZWQgYnkgdGhlIFRCIGNsYXNzIHdoZW4gdGhlIGFwcCBlbmNvdW50ZXJzIGFuIGV4Y2VwdGlvbi4KICogTm90ZSB0aGF0IHlvdSBzZXQgdXAgYW4gZXZlbnQgaGFuZGxlciBmb3IgdGhlIDxjb2RlPmV4Y2VwdGlvbjwvY29kZT4gZXZlbnQgYnkgY2FsbGluZyB0aGUKICogPGNvZGU+VEIuYWRkRXZlbnRMaXN0ZW5lcigpPC9jb2RlPiBtZXRob2QsIHdoaWNoIGlzIGEgPGk+c3RhdGljPC9pPiBtZXRob2QuCiAqCiAqIEBuYW1lIGV4Y2VwdGlvbgogKiBAZXZlbnQKICogQGJvcnJvd3MgRXhjZXB0aW9uRXZlbnQjbWVzc2FnZSBhcyB0aGlzLm1lc3NhZ2UKICogQG1lbWJlcm9mIFRCCiAqIEBzZWUgRXhjZXB0aW9uRXZlbnQKICovCgppZiAoIXdpbmRvdy5PVCkgd2luZG93Lk9UID0gT1Q7CmlmICghd2luZG93LlRCKSB3aW5kb3cuVEIgPSBPVDsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbihnbG9iYWwpIHsKCk9ULkNvbGxlY3Rpb24gPSBmdW5jdGlvbihpZEZpZWxkKSB7CiAgdmFyIF9tb2RlbHMgPSBbXSwKICAgICAgX2J5SWQgPSB7fSwKICAgICAgX2lkRmllbGQgPSBpZEZpZWxkIHx8ICdpZCc7CgogIE9ULiQuZXZlbnRpbmcodGhpcywgdHJ1ZSk7CgogIHZhciBvbk1vZGVsVXBkYXRlID0gZnVuY3Rpb24gb25Nb2RlbFVwZGF0ZSAoZXZlbnQpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ3VwZGF0ZScsIGV2ZW50KTsKICAgICAgICB0aGlzLnRyaWdnZXIoJ3VwZGF0ZTonK2V2ZW50LnRhcmdldC5pZCwgZXZlbnQpOwogICAgICB9LmJpbmQodGhpcyksCgogICAgICBvbk1vZGVsSWRVcGRhdGUgPSBmdW5jdGlvbiBvbk1vZGVsSWRVcGRhdGUgKG9sZElkLCBuZXdJZCkgewogICAgICAgIGlmIChfYnlJZFtvbGRJZF0gPT09IHZvaWQgMCkgcmV0dXJuOwoKICAgICAgICAvLyBNYXRjaCB0aGVpciBvbGQgaW5kZXggdG8gdGhlaXIgbmV3IGlkIGFuZCByZW1vdmUgYW55CiAgICAgICAgLy8gcmVmZXJlbmNlIHRvIHRoZSBvbGQgb25lLgogICAgICAgIHZhciBpbmRleCA9IF9ieUlkW29sZElkXTsKICAgICAgICBkZWxldGUgX2J5SWRbb2xkSWRdOwogICAgICAgIF9ieUlkW25ld0lkXSA9IGluZGV4OwogICAgICB9LmJpbmQodGhpcyksCgogICAgICBvbk1vZGVsRGVzdHJveSA9IGZ1bmN0aW9uIG9uTW9kZWxEZXN0cm95ZWQgKGV2ZW50KSB7CiAgICAgICAgdGhpcy5yZW1vdmUoZXZlbnQudGFyZ2V0LCBldmVudC5yZWFzb24pOwogICAgICB9LmJpbmQodGhpcyk7CgoKICB0aGlzLnJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAvLyBTdG9wIGxpc3RlbmluZyBvbiB0aGUgbW9kZWxzLCB0aGV5IGFyZSBubyBsb25nZXIgb3VyIHByb2JsZW0KICAgIF9tb2RlbHMuZm9yRWFjaChmdW5jdGlvbihtb2RlbCkgewogICAgICBtb2RlbC5vZmYoJ3VwZGF0ZWQnLCBvbk1vZGVsVXBkYXRlLCB0aGlzKTsKICAgICAgbW9kZWwub2ZmKCdkZXN0cm95ZWQnLCBvbk1vZGVsRGVzdHJveSwgdGhpcykKICAgICAgbW9kZWwub2ZmKCdpZFVwZGF0ZWQnLCBvbk1vZGVsSWRVcGRhdGUsIHRoaXMpOwogICAgfSwgdGhpcyk7CgogICAgX21vZGVscyA9IFtdOwogICAgX2J5SWQgPSB7fTsKICB9OwoKICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgIF9tb2RlbHMuZm9yRWFjaChmdW5jdGlvbihtb2RlbCkgewogICAgICBtb2RlbC5kZXN0cm95KHZvaWQgMCwgdHJ1ZSk7CiAgICB9KTsKCiAgICB0aGlzLnJlc2V0KCk7CiAgICB0aGlzLm9mZigpOwogIH07CgogIHRoaXMuZ2V0ID0gZnVuY3Rpb24oaWQpIHsgcmV0dXJuIGlkICYmIF9ieUlkW2lkXSAhPT0gdm9pZCAwID8gX21vZGVsc1tfYnlJZFtpZF1dIDogdm9pZCAwOyB9OwogIHRoaXMuaGFzID0gZnVuY3Rpb24oaWQpIHsgcmV0dXJuIGlkICYmIF9ieUlkW2lkXSAhPT0gdm9pZCAwOyB9OwoKICB0aGlzLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7IHJldHVybiBfbW9kZWxzLnRvU3RyaW5nKCk7IH07CgogIC8vIFJldHVybiBvbmx5IG1vZGVscyBmaWx0ZXJlZCBieSBlaXRoZXIgYSBkaWN0IG9mIHByb3BlcnRpZXMKICAvLyBvciBhIGZpbHRlciBmdW5jdGlvbi4KICAvLwogIC8vIEBleGFtcGxlIFJldHVybiBhbGwgcHVibGlzaGVycyB3aXRoIGEgc3RyZWFtSWQgb2YgMQogIC8vICAgT1QucHVibGlzaGVycy53aGVyZSh7c3RyZWFtSWQ6IDF9KQogIC8vCiAgLy8gQGV4YW1wbGUgVGhlIHNhbWUgdGhpbmcgYnV0IGZpbHRlcmluZyB1c2luZyBhIGZpbHRlciBmdW5jdGlvbgogIC8vICAgT1QucHVibGlzaGVycy53aGVyZShmdW5jdGlvbihwdWJsaXNoZXIpIHsKICAvLyAgICAgcmV0dXJuIHB1Ymxpc2hlci5zdHJlYW0uaWQgPT09IDQ7CiAgLy8gICB9KTsKICAvLwogIC8vIEBleGFtcGxlIFRoZSBzYW1lIHRoaW5nIGJ1dCBmaWx0ZXJpbmcgdXNpbmcgYSBmaWx0ZXIgZnVuY3Rpb24KICAvLyAgICAgICAgICBleGVjdXRlZCB3aXRoIGEgc3BlY2lmaWMgdGhpcwogIC8vICAgT1QucHVibGlzaGVycy53aGVyZShmdW5jdGlvbihwdWJsaXNoZXIpIHsKICAvLyAgICAgcmV0dXJuIHB1Ymxpc2hlci5zdHJlYW0uaWQgPT09IDQ7CiAgLy8gICB9LCBzZWxmKTsKICAvLwogIHRoaXMud2hlcmUgPSBmdW5jdGlvbihhdHRyc09yRmlsdGVyRm4sIGNvbnRleHQpIHsKICAgIGlmIChPVC4kLmlzRnVuY3Rpb24oYXR0cnNPckZpbHRlckZuKSkgcmV0dXJuIF9tb2RlbHMuZmlsdGVyKGF0dHJzT3JGaWx0ZXJGbiwgY29udGV4dCk7CgogICAgcmV0dXJuIF9tb2RlbHMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRyc09yRmlsdGVyRm4pIHsKICAgICAgICBpZiAobW9kZWxba2V5XSAhPT0gYXR0cnNPckZpbHRlckZuW2tleV0pIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKICAvLyBTaW1pbGFyIHRvIHdoZXJlIGluIGJlaGF2aW91ciwgZXhjZXB0IHRoYXQgaXQgb25seSByZXR1cm5zCiAgLy8gdGhlIGZpcnN0IG1hdGNoLgogIHRoaXMuZmluZCA9IGZ1bmN0aW9uKGF0dHJzT3JGaWx0ZXJGbiwgY29udGV4dCkgewogICAgdmFyIGZpbHRlckZuOwoKICAgIGlmIChPVC4kLmlzRnVuY3Rpb24oYXR0cnNPckZpbHRlckZuKSkgewogICAgICBmaWx0ZXJGbiA9IGF0dHJzT3JGaWx0ZXJGbjsKICAgIH0KICAgIGVsc2UgewogICAgICBmaWx0ZXJGbiA9IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzT3JGaWx0ZXJGbikgewogICAgICAgICAgaWYgKG1vZGVsW2tleV0gIT09IGF0dHJzT3JGaWx0ZXJGbltrZXldKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfTsKICAgIH0KCiAgICBmaWx0ZXJGbiA9IGZpbHRlckZuLmJpbmQoY29udGV4dCk7CgogICAgZm9yICh2YXIgaT0wOyBpPF9tb2RlbHMubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKGZpbHRlckZuKF9tb2RlbHNbaV0pID09PSB0cnVlKSByZXR1cm4gX21vZGVsc1tpXTsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9OwoKICB0aGlzLmFkZCA9IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB2YXIgaWQgPSBtb2RlbFtfaWRGaWVsZF07CgogICAgaWYgKHRoaXMuaGFzKGlkKSkgewogICAgICBPVC53YXJuKCJNb2RlbCAiICsgaWQgKyAnIGlzIGFscmVhZHkgaW4gdGhlIGNvbGxlY3Rpb24nLCBfbW9kZWxzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgX2J5SWRbaWRdID0gX21vZGVscy5wdXNoKG1vZGVsKSAtIDE7CgogICAgbW9kZWwub24oJ3VwZGF0ZWQnLCBvbk1vZGVsVXBkYXRlLCB0aGlzKTsKICAgIG1vZGVsLm9uKCdkZXN0cm95ZWQnLCBvbk1vZGVsRGVzdHJveSwgdGhpcykKICAgIG1vZGVsLm9uKCdpZFVwZGF0ZWQnLCBvbk1vZGVsSWRVcGRhdGUsIHRoaXMpOwoKICAgIHRoaXMudHJpZ2dlcignYWRkJywgbW9kZWwpOwogICAgdGhpcy50cmlnZ2VyKCdhZGQ6JytpZCwgbW9kZWwpOwoKICAgIHJldHVybiB0aGlzOwogIH07CgogIHRoaXMucmVtb3ZlID0gZnVuY3Rpb24obW9kZWwsIHJlYXNvbikgewogICAgdmFyIGlkID0gbW9kZWxbX2lkRmllbGRdOwoKICAgIF9tb2RlbHMuc3BsaWNlKF9ieUlkW2lkXSwgMSk7CgogICAgLy8gU2h1ZmZsZSBldmVyeW9uZSBkb3duIG9uZQogICAgZm9yICh2YXIgaT1fYnlJZFtpZF07IGk8X21vZGVscy5sZW5ndGg7ICsraSkgewogICAgICBfYnlJZFtfbW9kZWxzW2ldW19pZEZpZWxkXV0gPSBpCiAgICB9CgogICAgZGVsZXRlIF9ieUlkW2lkXTsKCiAgICBtb2RlbC5vZmYoJ3VwZGF0ZWQnLCBvbk1vZGVsVXBkYXRlLCB0aGlzKTsKICAgIG1vZGVsLm9mZignZGVzdHJveWVkJywgb25Nb2RlbERlc3Ryb3ksIHRoaXMpCiAgICBtb2RlbC5vZmYoJ2lkVXBkYXRlZCcsIG9uTW9kZWxJZFVwZGF0ZSwgdGhpcyk7CgogICAgdGhpcy50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgcmVhc29uKTsKICAgIHRoaXMudHJpZ2dlcigncmVtb3ZlOicraWQsIG1vZGVsLCByZWFzb24pOwoKICAgIHJldHVybiB0aGlzOwogIH07CgogIE9ULiQuZGVmaW5lR2V0dGVycyh0aGlzLCB7CiAgICBsZW5ndGg6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX21vZGVscy5sZW5ndGg7IH0KICB9KTsKfTsKCn0odGhpcykpOwooZnVuY3Rpb24od2luZG93KSB7CgovKioKICogVGhlIEV2ZW50IG9iamVjdCBkZWZpbmVzIHRoZSBiYXNpYyBPcGVuVG9rIGV2ZW50IG9iamVjdCB0aGF0IGlzIHBhc3NlZCB0bwogKiBldmVudCBsaXN0ZW5lcnMuIE90aGVyIE9wZW5Ub2sgZXZlbnQgY2xhc3NlcyBpbXBsZW1lbnQgdGhlIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMgb2YKICogdGhlIEV2ZW50IG9iamVjdC48L3A+CiAqCiAqIDxwPkZvciBleGFtcGxlLCB0aGUgU3RyZWFtIG9iamVjdCBkaXNwYXRjaGVzIGEgPGNvZGU+c3RyZWFtUHJvcGVydHlDaGFuZ2VkPC9jb2RlPiBldmVudCB3aGVuCiAqIHRoZSBzdHJlYW0ncyBwcm9wZXJ0aWVzIGFyZSB1cGRhdGVkLiBZb3UgcmVnaXN0ZXIgYW4gZXZlbnQgbGlzdGVuZXIgdXNpbmcgdGhlIDxjb2RlPmFkZEV2ZW50TGlzdGVuZXIoKTwvY29kZT4KICogbWV0aG9kIG9mIHRoZSBTdHJlYW0gb2JqZWN0OjwvcD4KICoKICogPHByZT4KICogc3RyZWFtLmFkZEV2ZW50TGlzdGVuZXIoInN0cmVhbVByb3BlcnR5Q2hhbmdlZCIsIHN0cmVhbVByb3BlcnR5Q2hhbmdlZEhhbmRsZXIpOwogKgogKiBmdW5jdGlvbiBzdHJlYW1Qcm9wZXJ0eUNoYW5nZWRIYW5kbGVyKGV2ZW50KSB7CiAqICAgICBhbGVydCgiUHJvcGVydGllcyBjaGFuZ2VkIGZvciBzdHJlYW0gIiArIGV2ZW50LnRhcmdldC5zdHJlYW1JZCk7CiAqIH08L3ByZT4KICoKICogQGNsYXNzIEV2ZW50CiAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gY2FuY2VsYWJsZSBXaGV0aGVyIHRoZSBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yIHRoYXQgaXMgY2FuY2VsYWJsZSAoPGNvZGU+dHJ1ZTwvY29kZT4pCiAqIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4gWW91IGNhbiBjYW5jZWwgdGhlIGRlZmF1bHQgYmVoYXZpb3IgYnkgY2FsbGluZyB0aGUgPGNvZGU+cHJldmVudERlZmF1bHQoKTwvY29kZT4gbWV0aG9kCiAqIG9mIHRoZSBFdmVudCBvYmplY3QgaW4gdGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uLiAoU2VlIDxhIGhyZWY9IiNwcmV2ZW50RGVmYXVsdCI+cHJldmVudERlZmF1bHQoKTwvYT4uKQogKgogKiBAcHJvcGVydHkge09iamVjdH0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBkaXNwYXRjaGVkIHRoZSBldmVudC4KICoKICogQHByb3BlcnR5IHtTdHJpbmd9IHR5cGUgIFRoZSB0eXBlIG9mIGV2ZW50LgogKi8KT1QuRXZlbnQgPSBPVC4kLmV2ZW50aW5nLkV2ZW50KCk7Ci8qKgoqIFByZXZlbnRzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXZlbnQgZnJvbSB0YWtpbmcgcGxhY2UuCioKKiA8cD5UbyBzZWUgd2hldGhlciBhbiBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yLCBjaGVjayB0aGUgPGNvZGU+Y2FuY2VsYWJsZTwvY29kZT4gcHJvcGVydHkgb2YgdGhlIGV2ZW50IG9iamVjdC4gPC9wPgoqCiogPHA+Q2FsbCB0aGUgPGNvZGU+cHJldmVudERlZmF1bHQoKTwvY29kZT4gbWV0aG9kIGluIHRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3IgdGhlIGV2ZW50LjwvcD4KKgoqIDxwPlRoZSBmb2xsb3dpbmcgZXZlbnRzIGhhdmUgZGVmYXVsdCBiZWhhdmlvcnM6PC9wPgoqCiogPHVsPgoqCiogICA8bGk+PGNvZGU+c2Vzc2lvbkRpc2Nvbm5lY3Q8L2NvZGU+ICYjMTUxOyBTZWUgPGEgaHJlZj0iU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudC5odG1sI3ByZXZlbnREZWZhdWx0Ij4KKiAgIFNlc3Npb25EaXNjb25uZWN0RXZlbnQucHJldmVudERlZmF1bHQoKTwvYT4uPC9saT4KKgoqICAgPGxpPjxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gJiMxNTE7IFNlZSA8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sI3ByZXZlbnREZWZhdWx0Ij4KKiAgIFN0cmVhbUV2ZW50LnByZXZlbnREZWZhdWx0KCk8L2E+LjwvbGk+CioKKiA8L3VsPgoqCiogQG1ldGhvZCAjcHJldmVudERlZmF1bHQKKiBAbWVtYmVyb2YgRXZlbnQKKi8KLyoqCiogV2hldGhlciB0aGUgZGVmYXVsdCBldmVudCBiZWhhdmlvciBoYXMgYmVlbiBwcmV2ZW50ZWQgdmlhIGEgY2FsbCB0byA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiAoPGNvZGU+dHJ1ZTwvY29kZT4pCiogb3Igbm90ICg8Y29kZT5mYWxzZTwvY29kZT4pLiBTZWUgPGEgaHJlZj0iI3ByZXZlbnREZWZhdWx0Ij5wcmV2ZW50RGVmYXVsdCgpPC9hPi4KKiBAbWV0aG9kICNpc0RlZmF1bHRQcmV2ZW50ZWQKKiBAcmV0dXJuIHtCb29sZWFufQoqIEBtZW1iZXJvZiBFdmVudAoqLwoKLy8gRXZlbnQgbmFtZXMgbG9va3VwCk9ULkV2ZW50Lm5hbWVzID0gewogICAgLy8gQWN0aXZpdHkgU3RhdHVzIGZvciBjYW1zL21pY3MKICAgIEFDVElWRTogImFjdGl2ZSIsCiAgICBJTkFDVElWRTogImluYWN0aXZlIiwKICAgIFVOS05PV046ICJ1bmtub3duIiwKCiAgICAvLyBBcmNoaXZlIHR5cGVzCiAgICBQRVJfU0VTU0lPTjogInBlclNlc3Npb24iLAogICAgUEVSX1NUUkVBTTogInBlclN0cmVhbSIsCgogICAgLy8gVEIgRXZlbnRzCiAgICBFWENFUFRJT046ICJleGNlcHRpb24iLAogICAgSVNTVUVfUkVQT1JURUQ6ICJpc3N1ZVJlcG9ydGVkIiwKCiAgICAvLyBTZXNzaW9uIEV2ZW50cwogICAgU0VTU0lPTl9DT05ORUNURUQ6ICJzZXNzaW9uQ29ubmVjdGVkIiwKICAgIFNFU1NJT05fRElTQ09OTkVDVEVEOiAic2Vzc2lvbkRpc2Nvbm5lY3RlZCIsCiAgICBTVFJFQU1fQ1JFQVRFRDogInN0cmVhbUNyZWF0ZWQiLAogICAgU1RSRUFNX0RFU1RST1lFRDogInN0cmVhbURlc3Ryb3llZCIsCiAgICBDT05ORUNUSU9OX0NSRUFURUQ6ICJjb25uZWN0aW9uQ3JlYXRlZCIsCiAgICBDT05ORUNUSU9OX0RFU1RST1lFRDogImNvbm5lY3Rpb25EZXN0cm95ZWQiLAogICAgU0lHTkFMOiAic2lnbmFsIiwKICAgIFNUUkVBTV9QUk9QRVJUWV9DSEFOR0VEOiAic3RyZWFtUHJvcGVydHlDaGFuZ2VkIiwKICAgIE1JQ1JPUEhPTkVfTEVWRUxfQ0hBTkdFRDogIm1pY3JvcGhvbmVMZXZlbENoYW5nZWQiLAoKCiAgICAvLyBQdWJsaXNoZXIgRXZlbnRzCiAgICBSRVNJWkU6ICJyZXNpemUiLAogICAgU0VUVElOR1NfQlVUVE9OX0NMSUNLOiAic2V0dGluZ3NCdXR0b25DbGljayIsCiAgICBERVZJQ0VfSU5BQ1RJVkU6ICJkZXZpY2VJbmFjdGl2ZSIsCiAgICBJTlZBTElEX0RFVklDRV9OQU1FOiAiaW52YWxpZERldmljZU5hbWUiLAogICAgQUNDRVNTX0FMTE9XRUQ6ICJhY2Nlc3NBbGxvd2VkIiwKICAgIEFDQ0VTU19ERU5JRUQ6ICJhY2Nlc3NEZW5pZWQiLAogICAgQUNDRVNTX0RJQUxPR19PUEVORUQ6ICdhY2Nlc3NEaWFsb2dPcGVuZWQnLAogICAgQUNDRVNTX0RJQUxPR19DTE9TRUQ6ICdhY2Nlc3NEaWFsb2dDbG9zZWQnLAogICAgRUNIT19DQU5DRUxMQVRJT05fTU9ERV9DSEFOR0VEOiAiZWNob0NhbmNlbGxhdGlvbk1vZGVDaGFuZ2VkIiwKICAgIFBVQkxJU0hFUl9ERVNUUk9ZRUQ6ICdkZXN0cm95ZWQnLAoKICAgIC8vIFN1YnNjcmliZXIgRXZlbnRzCiAgICBTVUJTQ1JJQkVSX0RFU1RST1lFRDogJ2Rlc3Ryb3llZCcsCgogICAgLy8gRGV2aWNlTWFuYWdlciBFdmVudHMKICAgIERFVklDRVNfREVURUNURUQ6ICJkZXZpY2VzRGV0ZWN0ZWQiLAoKICAgIC8vIERldmljZVBhbmVsIEV2ZW50cwogICAgREVWSUNFU19TRUxFQ1RFRDogImRldmljZXNTZWxlY3RlZCIsCiAgICBDTE9TRV9CVVRUT05fQ0xJQ0s6ICJjbG9zZUJ1dHRvbkNsaWNrIiwKCiAgICBNSUNMRVZFTCA6ICdtaWNyb3Bob25lQWN0aXZpdHlMZXZlbCcsCiAgICBNSUNHQUlOQ0hBTkdFRCA6ICdtaWNyb3Bob25lR2FpbkNoYW5nZWQnLAoKICAgIC8vIEVudmlyb25tZW50IExvYWRlcgogICAgRU5WX0xPQURFRDogJ2VudkxvYWRlZCcKfTsKCk9ULlZhbHVlRXZlbnQgPSBmdW5jdGlvbiAodHlwZSx2YWx1ZSl7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwoKfTsKCk9ULkV4Y2VwdGlvbkNvZGVzID0gewogIEpTX0VYQ0VQVElPTjogMjAwMCwKICBBVVRIRU5USUNBVElPTl9FUlJPUjogMTAwNCwKICBJTlZBTElEX1NFU1NJT05fSUQ6IDEwMDUsCiAgQ09OTkVDVF9GQUlMRUQ6IDEwMDYsCiAgQ09OTkVDVF9SRUpFQ1RFRDogMTAwNywKICBDT05ORUNUSU9OX1RJTUVPVVQ6IDEwMDgsCiAgTk9UX0NPTk5FQ1RFRDogMTAxMCwKICBQMlBfQ09OTkVDVElPTl9GQUlMRUQ6IDEwMTMsCiAgQVBJX1JFU1BPTlNFX0ZBSUxVUkU6IDEwMTQsCiAgVU5BQkxFX1RPX1BVQkxJU0g6IDE1MDAsCiAgVU5BQkxFX1RPX1NJR05BTDogMTUxMCwKICBVTkFCTEVfVE9fRk9SQ0VfRElTQ09OTkVDVDogMTUyMCwKICBVTkFCTEVfVE9fRk9SQ0VfVU5QVUJMSVNIOiAxNTMwCn07CgovKioKKiBUaGUge0BsaW5rIFRCfSBjbGFzcyBkaXNwYXRjaGVzIDxjb2RlPmV4Y2VwdGlvbjwvY29kZT4gZXZlbnRzIHdoZW4gdGhlIE9wZW5Ub2sgQVBJIGVuY291bnRlcnMKKiBhbiBleGNlcHRpb24gKGVycm9yKS4gVGhlIEV4Y2VwdGlvbkV2ZW50IG9iamVjdCBkZWZpbmVzIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBldmVudAoqIG9iamVjdCB0aGF0IGlzIGRpc3BhdGNoZWQuCioKKiA8cD5Ob3RlIHRoYXQgeW91IHNldCB1cCBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudCBieSBjYWxsaW5nIHRoZQoqIDxjb2RlPlRCLmFkZEV2ZW50TGlzdGVuZXIoKTwvY29kZT4gbWV0aG9kLCB3aGljaCBpcyBhIDxpPnN0YXRpYzwvaT4gbWV0aG9kLjwvcD4KKgoqIEBjbGFzcyBFeGNlcHRpb25FdmVudAoqIEBwcm9wZXJ0eSB7TnVtYmVyfSBjb2RlIFRoZSBlcnJvciBjb2RlLiBUaGUgZm9sbG93aW5nIGlzIGEgbGlzdCBvZiBlcnJvciBjb2Rlczo8L3A+CioKKiA8dGFibGUgY2xhc3M9ImRvY3NfdGFibGUiPgoqICA8dGJvZHk+PHRyPgoqICAgPHRkPgoqICAgPGI+Y29kZTwvYj4KKgoqICAgPC90ZD4KKiAgIDx0ZD4KKiAgIDxiPnRpdGxlPC9iPgoqICAgPC90ZD4KKiAgPC90cj4KKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwMAoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgRmFpbGVkIFRvIExvYWQKKiAgIDwvdGQ+CiogIDwvdHI+CioKKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwNAoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgQXV0aGVudGljYXRpb24gZXJyb3IKKiAgIDwvdGQ+CiogIDwvdHI+CioKKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwNQoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgSW52YWxpZCBTZXNzaW9uIElECiogICA8L3RkPgoqICA8L3RyPgoqICA8dHI+CiogICA8dGQ+CiogICAxMDA2CioKKiAgIDwvdGQ+CiogICA8dGQ+CiogICBDb25uZWN0IEZhaWxlZAoqICAgPC90ZD4KKiAgPC90cj4KKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwNwoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgQ29ubmVjdCBSZWplY3RlZAoqICAgPC90ZD4KKiAgPC90cj4KKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwOAoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgQ29ubmVjdCBUaW1lLW91dAoqICAgPC90ZD4KKiAgPC90cj4KKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwOQoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgU2VjdXJpdHkgRXJyb3IKKiAgIDwvdGQ+CiogIDwvdHI+CiogICA8dHI+CiogICAgPHRkPgoqICAgIDEwMTAKKgoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIE5vdCBDb25uZWN0ZWQKKiAgICA8L3RkPgoqICAgPC90cj4KKiAgIDx0cj4KKiAgICA8dGQ+CiogICAgMTAxMQoqCiogICAgPC90ZD4KKiAgICA8dGQ+CiogICAgSW52YWxpZCBQYXJhbWV0ZXIKKiAgICA8L3RkPgoqICAgPC90cj4KKiAgIDx0cj4KKiAgICA8dGQ+CiogICAgMTAxMwoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIENvbm5lY3Rpb24gRmFpbGVkCiogICAgPC90ZD4KKiAgIDwvdHI+CiogICA8dHI+CiogICAgPHRkPgoqICAgIDEwMTQKKiAgICA8L3RkPgoqICAgIDx0ZD4KKiAgICBBUEkgUmVzcG9uc2UgRmFpbHVyZQoqICAgIDwvdGQ+CiogICA8L3RyPgoqCiogIDx0cj4KKiAgICA8dGQ+CiogICAgMTUwMAoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIFVuYWJsZSB0byBQdWJsaXNoCiogICAgPC90ZD4KKiAgIDwvdHI+CioKKiAgPHRyPgoqICAgIDx0ZD4KKiAgICAxNTEwCiogICAgPC90ZD4KKiAgICA8dGQ+CiogICAgVW5hYmxlIHRvIFNpZ25hbAoqICAgIDwvdGQ+CiogICA8L3RyPgoqCiogIDx0cj4KKiAgICA8dGQ+CiogICAgMTUyMAoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIFVuYWJsZSB0byBGb3JjZSBEaXNjb25uZWN0CiogICAgPC90ZD4KKiAgIDwvdHI+CioKKiAgPHRyPgoqICAgIDx0ZD4KKiAgICAxNTMwCiogICAgPC90ZD4KKiAgICA8dGQ+CiogICAgVW5hYmxlIHRvIEZvcmNlIFVucHVibGlzaAoqICAgIDwvdGQ+CiogICA8L3RyPgoqICA8dHI+CiogICAgPHRkPgoqICAgIDE1MzUKKiAgICA8L3RkPgoqICAgIDx0ZD4KKiAgICBGb3JjZSBVbnB1Ymxpc2ggb24gSW52YWxpZCBTdHJlYW0KKiAgICA8L3RkPgoqICAgPC90cj4KKgoqICA8dHI+CiogICAgPHRkPgoqICAgIDIwMDAKKgoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIEludGVybmFsIEVycm9yCiogICAgPC90ZD4KKiAgPC90cj4KKgoqICA8dHI+CiogICAgPHRkPgoqICAgIDIwMTAKKgoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIFJlcG9ydCBJc3N1ZSBGYWlsdXJlCiogICAgPC90ZD4KKiAgPC90cj4KKgoqCiogIDwvdGJvZHk+PC90YWJsZT4KKgoqICA8cD5DaGVjayB0aGUgPGNvZGU+bWVzc2FnZTwvY29kZT4gcHJvcGVydHkgZm9yIG1vcmUgZGV0YWlscyBhYm91dCB0aGUgZXJyb3IuPC9wPgoqCiogQHByb3BlcnR5IHtTdHJpbmd9IG1lc3NhZ2UgVGhlIGVycm9yIG1lc3NhZ2UuCiogQHByb3BlcnR5IHtTdHJpbmd9IHRpdGxlIFRoZSBlcnJvciB0aXRsZS4KKiBAYXVnbWVudHMgRXZlbnQKKi8KT1QuRXhjZXB0aW9uRXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgbWVzc2FnZSwgdGl0bGUsIGNvZGUsIGNvbXBvbmVudCwgdGFyZ2V0KSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICB0aGlzLnRpdGxlID0gdGl0bGU7CiAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKfTsKCgpPVC5Jc3N1ZVJlcG9ydGVkRXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgaXNzdWVJZCkgewogICAgT1QuRXZlbnQuY2FsbCh0aGlzLCB0eXBlKTsKCiAgICB0aGlzLmlzc3VlSWQgPSBpc3N1ZUlkOwp9OwoKLy8gVHJpZ2dlcmVkIHdoZW4gdGhlIEpTIGR5bmFtaWMgY29uZmlnIGFuZCB0aGUgRE9NIGhhdmUgbG9hZGVkLgpPVC5FbnZMb2FkZWRFdmVudCA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwp9OwoKCi8qKgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIENvbm5lY3Rpb25FdmVudCBvYmplY3Qgd2hlbiBhIGNvbm5lY3Rpb24gaXMgY3JlYXRlZCBvciBkZXN0cm95ZWQuCiAqCiAqIDxoNT48YSBocmVmPSJleGFtcGxlIj48L2E+RXhhbXBsZTwvaDU+CiAqCiAqIDxwPlRoZSBmb2xsb3dpbmcgY29kZSBrZWVwcyBhIHJ1bm5pbmcgdG90YWwgb2YgdGhlIG51bWJlciBvZiBjb25uZWN0aW9ucyB0byBhIHNlc3Npb24KICogYnkgbW9uaXRvcmluZyB0aGUgPGNvZGU+Y29ubmVjdGlvbnM8L2NvZGU+IHByb3BlcnR5IG9mIHRoZSA8Y29kZT5zZXNzaW9uQ29ubmVjdDwvY29kZT4sCiAqIDxjb2RlPmNvbm5lY3Rpb25DcmVhdGVkPC9jb2RlPiBhbmQgPGNvZGU+Y29ubmVjdGlvbkRlc3Ryb3llZDwvY29kZT4gZXZlbnRzOjwvcD4KICoKICogPHByZT52YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAqICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICogdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqIHZhciBjb25uZWN0aW9uQ291bnQgPSAwOwogKgogKiB2YXIgc2Vzc2lvbiA9IFRCLmluaXRTZXNzaW9uKHNlc3Npb25JRCk7CiAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigic2Vzc2lvbkNvbm5lY3RlZCIsIHNlc3Npb25Db25uZWN0ZWRIYW5kbGVyKTsKICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJjb25uZWN0aW9uQ3JlYXRlZCIsIGNvbm5lY3Rpb25DcmVhdGVkSGFuZGxlcik7CiAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigiY29ubmVjdGlvbkRlc3Ryb3llZCIsIGNvbm5lY3Rpb25EZXN0cm95ZWRIYW5kbGVyKTsKICogc2Vzc2lvbi5jb25uZWN0KGFwaUtleSwgdG9rZW4pOwogKgogKiBmdW5jdGlvbiBzZXNzaW9uQ29ubmVjdGVkSGFuZGxlcihldmVudCkgewogKiAgICBjb25uZWN0aW9uQ291bnQgPSBldmVudC5jb25uZWN0aW9ucy5sZW5ndGg7CiAqICAgIGRpc3BsYXlDb25uZWN0aW9uQ291bnQoKTsKICogfQogKgogKiBmdW5jdGlvbiBjb25uZWN0aW9uQ3JlYXRlZEhhbmRsZXIoZXZlbnQpIHsKICogICAgY29ubmVjdGlvbkNvdW50ICs9IGV2ZW50LmNvbm5lY3Rpb25zLmxlbmd0aDsKICogICAgZGlzcGxheUNvbm5lY3Rpb25Db3VudCgpOwogKiB9CiAqCiAqIGZ1bmN0aW9uIGNvbm5lY3Rpb25EZXN0cm95ZWRIYW5kbGVyKGV2ZW50KSB7CiAqICAgIGNvbm5lY3Rpb25Db3VudCAtPSBldmVudC5jb25uZWN0aW9ucy5sZW5ndGg7CiAqICAgIGRpc3BsYXlDb25uZWN0aW9uQ291bnQoKTsKICogfQogKgogKiBmdW5jdGlvbiBkaXNwbGF5Q29ubmVjdGlvbkNvdW50KCkgewogKiAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvbm5lY3Rpb25Db3VudEZpZWxkIikudmFsdWUgPSBjb25uZWN0aW9uQ291bnQudG9TdHJpbmcoKTsKICogfTwvcHJlPgogKgogKiA8cD5UaGlzIGV4YW1wbGUgYXNzdW1lcyB0aGF0IHRoZXJlIGlzIGFuIGlucHV0IHRleHQgZmllbGQgaW4gdGhlIEhUTUwgRE9NCiAqIHdpdGggdGhlIDxjb2RlPmlkPC9jb2RlPiBzZXQgdG8gPGNvZGU+ImNvbm5lY3Rpb25Db3VudEZpZWxkIjwvY29kZT46PC9wPgogKgogKiA8cHJlPiZsdDtpbnB1dCB0eXBlPSJ0ZXh0IiBpZD0iY29ubmVjdGlvbkNvdW50RmllbGQiIHZhbHVlPSIwIiZndDsmbHQ7L2lucHV0Jmd0OzwvcHJlPgogKgogKgogKiBAcHJvcGVydHkge0FycmF5fSBjb25uZWN0aW9ucyBBbiBhcnJheSBvZiBDb25uZWN0aW9uIG9iamVjdHMgZm9yIHRoZSBjb25uZWN0aW9ucyB0aGF0IHdlcmUgY3JlYXRlZCBvciBkZWxldGVkLgogKiBZb3UgY2FuIGNvbXBhcmUgdGhlIDxjb2RlPmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgdG8gdGhhdCBvZiB0aGUgPGNvZGU+Y29ubmVjdGlvbjwvY29kZT4gcHJvcGVydHkgb2YgdGhlCiAqIFNlc3Npb24gb2JqZWN0IHRvIHNlZSBpZiBhIGNvbm5lY3Rpb24gcmVmZXJzIHRvIHRoZSBsb2NhbCB3ZWIgcGFnZS4KICoKICogQHByb3BlcnR5IHtTdHJpbmd9IHJlYXNvbiBGb3IgYSA8Y29kZT5jb25uZWN0aW9uRGVzdHJveWVkPC9jb2RlPiBldmVudCwKICogIGEgZGVzY3JpcHRpb24gb2Ygd2h5IHRoZSBjb25uZWN0aW9uIGVuZGVkLiBUaGlzIHByb3BlcnR5IGNhbiBoYXZlIHR3byB2YWx1ZXM6CiAqIDwvcD4KICogPHVsPgogKiAgPGxpPjxjb2RlPiJjbGllbnREaXNjb25uZWN0ZWQiPC9jb2RlPiAmIzE1MTsgQSBjbGllbnQgZGlzY29ubmVjdGVkIGZyb20gdGhlIHNlc3Npb24gYnkgY2FsbGluZwogKiAgICAgdGhlIDxjb2RlPmRpc2Nvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdCBvciBieSBjbG9zaW5nIHRoZSBicm93c2VyLgogKiAgICAgKFNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjZGlzY29ubmVjdCI+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2E+Lik8L2xpPgogKgogKiAgPGxpPjxjb2RlPiJmb3JjZURpc2Nvbm5lY3RlZCI8L2NvZGU+ICYjMTUxOyBBIG1vZGVyYXRvciBoYXMgZGlzY29ubmVjdGVkIHRoZSBwdWJsaXNoZXIgZnJvbSB0aGUgc2Vzc2lvbiwKICogICAgICBieSBjYWxsaW5nIHRoZSA8Y29kZT5mb3JjZURpc2Nvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4KICogICAgICAoU2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNmb3JjZURpc2Nvbm5lY3QiPlNlc3Npb24uZm9yY2VEaXNjb25uZWN0KCk8L2E+Lik8L2xpPgogKgogKiAgPGxpPjxjb2RlPiJuZXR3b3JrRGlzY29ubmVjdGVkIjwvY29kZT4gJiMxNTE7IFRoZSBuZXR3b3JrIGNvbm5lY3Rpb24gdGVybWluYXRlZCBhYnJ1cHRseSAoZm9yIGV4YW1wbGUsCiAqICAgICAgdGhlIGNsaWVudCBsb3N0IHRoZWlyIGludGVybmV0IGNvbm5lY3Rpb24pLjwvbGk+CiAqIDwvdWw+CiAqCiAqIDxwPkRlcGVuZGluZyBvbiB0aGUgY29udGV4dCwgdGhpcyBkZXNjcmlwdGlvbiBtYXkgYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWZpbmUKICogdGhlIGNvdXJzZSBvZiBhY3Rpb24gdGhleSB0YWtlIGluIHJlc3BvbnNlIHRvIGFuIGV2ZW50LjwvcD4KICoKICogPHA+Rm9yIGEgPGNvZGU+Y29ubmVjdGlvbkNyZWF0ZWQ8L2NvZGU+IGV2ZW50LCB0aGlzIHN0cmluZyBpcyB1bmRlZmluZWQuPC9wPgogKgogKiBAY2xhc3MgQ29ubmVjdGlvbkV2ZW50CiAqIEBhdWdtZW50cyBFdmVudAogKi8KT1QuQ29ubmVjdGlvbkV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIGNvbm5lY3Rpb25zLCByZWFzb24pIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy5jb25uZWN0aW9ucyA9IGNvbm5lY3Rpb25zOwogICAgdGhpcy5yZWFzb24gPSByZWFzb247Cn07CgovKioKICogU3RyZWFtRXZlbnQgaXMgYW4gZXZlbnQgdGhhdCBjYW4gaGF2ZSB0eXBlICJzdHJlYW1DcmVhdGVkIiBvciAic3RyZWFtRGVzdHJveWVkIi4gVGhlc2UgZXZlbnRzIGFyZSBkaXNwYXRjaGVkIHdoZW4gYSBjbGllbnQKICogc3RhcnRzIG9yIHN0b3BzIHB1Ymxpc2hpbmcgdG8gYSB7QGxpbmsgU2Vzc2lvbn0uIFRoaXMgaW5jbHVkZXMgcmVtb3RlIGNsaWVudHMgcHVibGlzaGluZyBvbiB0aGUgc2Vzc2lvbiBhcyB3ZWxsIGFzIHRoZSBsb2NhbAogKiBjbGllbnQgcHVibGlzaGluZyB0byB0aGUgc2Vzc2lvbi4KICoKICogPGg0PjxhIGhyZWY9ImV4YW1wbGVfc3RyZWFtQ3JlYXRlZCI+PC9hPkV4YW1wbGUgJiMxNTE7IHN0cmVhbUNyZWF0ZWQgZXZlbnQ8L2g0PgogKiAgPHA+VGhlIGZvbGxvd2luZyBjb2RlIGluaXRpYWxpemVzIGEgc2Vzc2lvbiBhbmQgc2V0cyB1cCBhbiBldmVudCBsaXN0ZW5lciBmb3Igd2hlbgogKiAgICBhIHN0cmVhbSBpcyBjcmVhdGVkOjwvcD4KICoKICogPHByZT52YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAqICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICogdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqCiAqIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzdHJlYW1DcmVhdGVkIiwgc3RyZWFtQ3JlYXRlZEhhbmRsZXIpOwogKiBzZXNzaW9uLmNvbm5lY3QoYXBpS2V5LCB0b2tlbik7CiAqCiAqIGZ1bmN0aW9uIHN0cmVhbUNyZWF0ZWRIYW5kbGVyKGV2ZW50KSB7CiAqICAgICBmb3IgKHZhciBpID0gMDsgaSAmbHQ7IGV2ZW50LnN0cmVhbXMubGVuZ3RoOyBpKyspIHsKICogICAgICAgICAvLyBPbmx5IGRpc3BsYXkgb3RoZXJzJyBzdHJlYW1zLCBub3QgdGhvc2UgdGhhdCB0aGUgY2xpZW50IHB1Ymxpc2hlcy4KICogICAgICAgICBpZiAoZXZlbnQuc3RyZWFtc1tpXS5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZCAhPSBldmVudC50YXJnZXQuY29ubmVjdGlvbi5jb25uZWN0aW9uSWQpIHsKICogICAgICAgICAgICAgICAgZGlzcGxheVN0cmVhbShzdHJlYW0pOwogKiAgICAgICAgIH0KICogICAgIH0KICogfQogKgogKiBmdW5jdGlvbiBkaXNwbGF5U3RyZWFtKHN0cmVhbSkgewogKiAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogKiAgICAgZGl2LnNldEF0dHJpYnV0ZSgnaWQnLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAqCiAqICAgICB2YXIgc3RyZWFtc0NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdHJlYW1zQ29udGFpbmVyJyk7CiAqICAgICBzdHJlYW1zQ29udGFpbmVyLmFwcGVuZENoaWxkKGRpdik7CiAqCiAqICAgICBzdWJzY3JpYmVyID0gc2Vzc2lvbi5zdWJzY3JpYmUoc3RyZWFtLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAqIH08L3ByZT4KICoKICogIDxwPkZvciB0aGlzIGV4YW1wbGUsIGluIGFkZGl0aW9uIHRvIHRoZSBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+c3RyZWFtQ3JlYXRlZDwvY29kZT4KICogIGV2ZW50LCB5b3Ugd291bGQgcHJvYmFibHkgd2FudCB0byBjcmVhdGUgYW4gZXZlbnQgaGFuZGxlciBmb3IgdGhlIDxjb2RlPnNlc3Npb25Db25uZWN0ZWQ8L2NvZGU+CiAqICBldmVudC4gVGhpcyBldmVudCBoYW5kbGVyIGNhbiBkaXNwbGF5IHRoZSBzdHJlYW1zIHRoYXQgYXJlIHByZXNlbnQgd2hlbiB0aGUgc2Vzc2lvbiBmaXJzdAogKiAgY29ubmVjdHMuIFNlZSB7QGxpbmsgU2Vzc2lvbkNvbm5lY3RFdmVudH0uPC9wPgogKgogKiAgPGg0PjxhIGhyZWY9ImV4YW1wbGVfc3RyZWFtRGVzdHJveWVkIj48L2E+RXhhbXBsZSAmIzE1MTsgc3RyZWFtRGVzdHJveWVkIGV2ZW50PC9oND4KICoKICogICAgPHA+VGhlIGZvbGxvd2luZyBjb2RlIGluaXRpYWxpemVzIGEgc2Vzc2lvbiBhbmQgc2V0cyB1cCBhbiBldmVudCBsaXN0ZW5lciBmb3Igd2hlbiBhCiAqICAgICAgIHN0cmVhbSBlbmRzOjwvcD4KICoKICogPHByZT52YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAqICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICogdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqCiAqIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzdHJlYW1EZXN0cm95ZWQiLCBzdHJlYW1EZXN0cm95ZWRIYW5kbGVyKTsKICogc2Vzc2lvbi5jb25uZWN0KGFwaUtleSwgdG9rZW4pOwogKgogKiBmdW5jdGlvbiBzdHJlYW1EZXN0cm95ZWRIYW5kbGVyKGV2ZW50KSB7CiAqICAgICBmb3IgKHZhciBpID0gMDsgaSAmbHQ7IGV2ZW50LnN0cmVhbXMubGVuZ3RoOyBpKyspIHsKICogICAgICAgICB2YXIgc3RyZWFtID0gZXZlbnQuc3RyZWFtc1tpXTsKICogICAgICAgICBhbGVydCgiU3RyZWFtICIgKyBzdHJlYW0ubmFtZSArICIgZW5kZWQuICIgKyBldmVudC5yZWFzb24pOwogKiAgICAgfQogKiB9PC9wcmU+CiAqCiAqIEBjbGFzcyBTdHJlYW1FdmVudAogKiBAcHJvcGVydHkge0FycmF5fSBzdHJlYW1zIEFuIGFycmF5IG9mIFN0cmVhbSBvYmplY3RzCiAqIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHN0cmVhbXMgdG8gd2hpY2ggdGhpcyBldmVudCByZWZlcnMuIFRoaXMgaXMgdXN1YWxseSBhbiBhcnJheSBjb250YWluaW5nIG9ubHkKICogb25lIFN0cmVhbSBvYmplY3QsIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHN0cmVhbSB0aGF0IHdhcyBhZGRlZCAoaW4gdGhlIGNhc2Ugb2YgYSA8Y29kZT5zdHJlYW1DcmVhdGVkPC9jb2RlPgogKiBldmVudCkgb3IgZGVsZXRlZCAoaW4gdGhlIGNhc2Ugb2YgYSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50KS4gSG93ZXZlciwgdGhlIGFycmF5IG1heSBjb250YWluCiAqIG11bHRpcGxlIFN0cmVhbSBvYmplY3RzIGlmIG11bHRpcGxlIHN0cmVhbXMgd2VyZSBhZGRlZCBvciBkZWxldGVkLiBBIHN0cmVhbSBtYXkgYmUgcHVibGlzaGVkIGJ5IHRoZSBsb2NhbCBjbGllbnQKICogb3IgYW5vdGhlciBjbGllbnQgY29ubmVjdGVkIHRvIHRoZSBzZXNzaW9uLgogKgogKiBAcHJvcGVydHkge1N0cmluZ30gcmVhc29uIEZvciBhIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gZXZlbnQsCiAqICBhIGRlc2NyaXB0aW9uIG9mIHdoeSB0aGUgc2Vzc2lvbiBkaXNjb25uZWN0ZWQuIFRoaXMgcHJvcGVydHkgY2FuIGhhdmUgb25lIG9mIHRoZSBmb2xsb3dpbmcgdmFsdWVzOgogKiA8L3A+CiAqIDx1bD4KICogIDxsaT48Y29kZT4iY2xpZW50RGlzY29ubmVjdGVkIjwvY29kZT4gJiMxNTE7IEEgY2xpZW50IGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBzZXNzaW9uIGJ5IGNhbGxpbmcKICogICAgIHRoZSA8Y29kZT5kaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgU2Vzc2lvbiBvYmplY3Qgb3IgYnkgY2xvc2luZyB0aGUgYnJvd3Nlci4KICogICAgIChTZWUgPGEgaHJlZj0iU2Vzc2lvbi5odG1sI2Rpc2Nvbm5lY3QiPlNlc3Npb24uZGlzY29ubmVjdCgpPC9hPi4pPC9saT4KICoKICogIDxsaT48Y29kZT4iZm9yY2VEaXNjb25uZWN0ZWQiPC9jb2RlPiAmIzE1MTsgQSBtb2RlcmF0b3IgaGFzIGRpc2Nvbm5lY3RlZCB0aGUgcHVibGlzaGVyIG9mIHRoZQogKiAgICBzdHJlYW0gZnJvbSB0aGUgc2Vzc2lvbiwgYnkgY2FsbGluZyB0aGUgPGNvZGU+Zm9yY2VEaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgU2Vzc2lvbiBvYmplY3QuCiAqICAgICAgKFNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjZm9yY2VEaXNjb25uZWN0Ij5TZXNzaW9uLmZvcmNlRGlzY29ubmVjdCgpPC9hPi4pPC9saT4KICoKICogIDxsaT48Y29kZT4iZm9yY2VVbnB1Ymxpc2hlZCI8L2NvZGU+ICYjMTUxOyBBIG1vZGVyYXRvciBoYXMgZm9yY2VkIHRoZSBwdWJsaXNoZXIgb2YgdGhlIHN0cmVhbSB0byBzdG9wCiAqICAgIHB1Ymxpc2hpbmcgdGhlIHN0cmVhbSwgYnkgY2FsbGluZyB0aGUgPGNvZGU+Zm9yY2VVbnB1Ymxpc2goKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4KICogICAgICAoU2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNmb3JjZVVucHVibGlzaCI+U2Vzc2lvbi5mb3JjZVVucHVibGlzaCgpPC9hPi4pPC9saT4KICoKICogIDxsaT48Y29kZT4ibmV0d29ya0Rpc2Nvbm5lY3RlZCI8L2NvZGU+ICYjMTUxOyBUaGUgbmV0d29yayBjb25uZWN0aW9uIHRlcm1pbmF0ZWQgYWJydXB0bHkgKGZvciBleGFtcGxlLAogKiAgICAgIHRoZSBjbGllbnQgbG9zdCB0aGVpciBpbnRlcm5ldCBjb25uZWN0aW9uKS48L2xpPgogKgogKiA8L3VsPgogKgogKiA8cD5EZXBlbmRpbmcgb24gdGhlIGNvbnRleHQsIHRoaXMgZGVzY3JpcHRpb24gbWF5IGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVmaW5lCiAqIHRoZSBjb3Vyc2Ugb2YgYWN0aW9uIHRoZXkgdGFrZSBpbiByZXNwb25zZSB0byBhbiBldmVudC48L3A+CiAqCiAqIDxwPkZvciBhIDxjb2RlPnN0cmVhbUNyZWF0ZWQ8L2NvZGU+IGV2ZW50LCB0aGlzIHN0cmluZyBpcyB1bmRlZmluZWQuPC9wPgogKgogKgogKiBAcHJvcGVydHkge0Jvb2xlYW59IGNhbmNlbGFibGUgICBXaGV0aGVyIHRoZSBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yIHRoYXQgaXMgY2FuY2VsYWJsZSAoPGNvZGU+dHJ1ZTwvY29kZT4pIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4KICogIFlvdSBjYW4gY2FuY2VsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGJ5IGNhbGxpbmcgdGhlIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+IG1ldGhvZCBvZgogKiAgdGhlIFN0cmVhbUV2ZW50IG9iamVjdCBpbiB0aGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24uIFRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+CiAqICBldmVudCBpcyBjYW5jZWxhYmxlLiAoU2VlIDxhIGhyZWY9IiNwcmV2ZW50RGVmYXVsdCI+cHJldmVudERlZmF1bHQoKTwvYT4uKQogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlN0cmVhbUV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIHN0cmVhbXMsIHJlYXNvbiwgY2FuY2VsYWJsZSkgewogICAgT1QuRXZlbnQuY2FsbCh0aGlzLCB0eXBlLCBjYW5jZWxhYmxlKTsKCiAgICB0aGlzLnN0cmVhbXMgPSBzdHJlYW1zOwogICAgdGhpcy5yZWFzb24gPSByZWFzb247Cn07CgovKioKKiBQcmV2ZW50cyB0aGUgZGVmYXVsdCBiZWhhdmlvciBhc3NvY2lhdGVkIHdpdGggdGhlIGV2ZW50IGZyb20gdGFraW5nIHBsYWNlLgoqCiogPHA+Rm9yIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50LCBpZiB0aGUgPGNvZGU+cmVhc29uPC9jb2RlPiBpcyBzZXQgdG8gPGNvZGU+ImZvcmNlRGlzY29ubmVjdGVkIjwvY29kZT4KKiBvciA8Y29kZT5uZXR3b3JrRGlzY29ubmVjdGVkPC9jb2RlPiwgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgdGhhdCBhbGwgU3Vic2NyaWJlciBvYmplY3RzIHRoYXQgYXJlCiogc3Vic2NyaWJlZCB0byB0aGUgc3RyZWFtIGFyZSB1bnN1YnNjcmliZWQgKGFuZCByZW1vdmVkIGZyb20gdGhlIEhUTUwgRE9NKS4gSWYgeW91IGNhbGwgdGhlIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+CiogbWV0aG9kIGluIHRoZSBldmVudCBsaXN0ZW5lciBmb3IgdGhlIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gZXZlbnQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCBhbmQKKiB5b3UgY2FuLCBvcHRpb25hbGx5LCBjbGVhbiB1cCBTdWJzY3JpYmVyIG9iamVjdHMgdXNpbmcgeW91ciBvd24gY29kZS4gU2VlCiogPGEgaHJlZj0iU2Vzc2lvbi5odG1sI2dldFN1YnNjcmliZXJzRm9yU3RyZWFtIj5TZXNzaW9uLmdldFN1YnNjcmliZXJzRm9yU3RyZWFtKCk8L2E+LjwvcD4KKgoqIDxwPklmIHRoZSA8Y29kZT5yZWFzb248L2NvZGU+IHByb3BlcnR5IGlzIHNldCB0byA8Y29kZT4iZm9yY2VVbnB1Ymxpc2hlZCI8L2NvZGU+LCB0aGUgZGVmYXVsdCBiZWhhdmlvcgoqIGlzIHRoYXQgdGhlIGFzc29jaWF0ZWQgU3Vic2NyaWJlciBvciBQdWJsaXNoZXIgb2JqZWN0cyBjb3JyZXNwb25kaW5nIHdpdGggdGhlIHN0cmVhbSBhcmUgdW5zdWJzY3JpYmVkCiogb3IgdW5wdWJsaXNoZWQgKGFuZCByZW1vdmVkIGZyb20gdGhlIEhUTUwgRE9NKS4gSWYgeW91IGNhbGwgdGhlIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+IG1ldGhvZCBpbiB0aGUKKiBldmVudCBsaXN0ZW5lciBmb3IgdGhlIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gZXZlbnQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCBhbmQKKiB5b3UgY2FuLCBvcHRpb25hbGx5LCBjbGVhbiB1cCBTdWJzY3JpYmVyIG9yIFB1Ymxpc2hlciBvYmplY3RzIHVzaW5nIHlvdXIgb3duIGNvZGUuIFNlZQoqIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNnZXRQdWJsaXNoZXJGb3JTdHJlYW0iPlNlc3Npb24uZ2V0UHVibGlzaGVyRm9yU3RyZWFtKCk8L2E+IGFuZAoqIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNnZXRTdWJzY3JpYmVyc0ZvclN0cmVhbSI+U2Vzc2lvbi5nZXRTdWJzY3JpYmVyc0ZvclN0cmVhbSgpPC9hPi48L3A+CioKKiA8cD5UbyBzZWUgd2hldGhlciBhbiBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yLCBjaGVjayB0aGUgPGNvZGU+Y2FuY2VsYWJsZTwvY29kZT4gcHJvcGVydHkgb2YgdGhlIGV2ZW50IG9iamVjdC4gPC9wPgoqCiogPHA+Q2FsbCB0aGUgPGNvZGU+cHJldmVudERlZmF1bHQoKTwvY29kZT4gbWV0aG9kIGluIHRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3IgdGhlIGV2ZW50LjwvcD4KKgoqIEBtZXRob2QgI3ByZXZlbnREZWZhdWx0CiogQG1lbWJlcm9mIFN0cmVhbUV2ZW50CiovCgoKLyoqCiAqIFRoZSBTZXNzaW9uIG9iamVjdCBkaXNwYXRjaGVzIFNlc3Npb25Db25uZWN0RXZlbnQgb2JqZWN0IHdoZW4gYSBzZXNzaW9uIGhhcyBzdWNjZXNzZnVsbHkgY29ubmVjdGVkIGluIHJlc3BvbnNlIHRvIGEgY2FsbCB0bwogKiB0aGUgPGNvZGU+Y29ubmVjdCgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIFNlc3Npb24gb2JqZWN0LgogKgogKiAgPHA+CiAqICBGb3IgYW4gZXhhbXBsZSwgc2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNjb25uZWN0Ij5TZXNzaW9uLmNvbm5lY3QoKTwvYT4uCiAqICA8L3A+CiAqCiAqIEBjbGFzcyBTZXNzaW9uQ29ubmVjdEV2ZW50CiAqIEBwcm9wZXJ0eSB7QXJyYXl9IGNvbm5lY3Rpb25zIEFuIGFycmF5IG9mIENvbm5lY3Rpb24gb2JqZWN0cywgcmVwcmVzZW50aW5nIGNvbm5lY3Rpb25zIHRvIHRoZSBzZXNzaW9uLgogKiAoTm90ZSB0aGF0IGVhY2ggY29ubmVjdGlvbiBjYW4gcHVibGlzaCBtdWx0aXBsZSBzdHJlYW1zLikKICogQHByb3BlcnR5IHtBcnJheX0gc3RyZWFtcyBBbiBhcnJheSBvZiBTdHJlYW0gb2JqZWN0cyBjb3JyZXNwb25kaW5nIHRvIHRoZSBzdHJlYW1zIGN1cnJlbnRseSBhdmFpbGFibGUgaW4gdGhlIHNlc3Npb24gdGhhdCBoYXMgY29ubmVjdGVkLgogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlNlc3Npb25Db25uZWN0RXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgY29ubmVjdGlvbnMsIHN0cmVhbXMsIGFyY2hpdmVzKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMuY29ubmVjdGlvbnMgPSBjb25uZWN0aW9uczsKICAgIHRoaXMuc3RyZWFtcyA9IHN0cmVhbXM7CiAgICB0aGlzLmFyY2hpdmVzID0gYXJjaGl2ZXM7CiAgICB0aGlzLmdyb3VwcyA9IFtdOyAvLyBEZXByZWNhdGVkIGluIE9wZW5Ub2sgdjAuOTEuNDgKfTsKCi8qKgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBTZXNzaW9uRGlzY29ubmVjdEV2ZW50IG9iamVjdCB3aGVuIGEgc2Vzc2lvbiBoYXMgZGlzY29ubmVjdGVkLiBUaGlzIGV2ZW50IG1heSBiZSBkaXNwYXRjaGVkIGFzeW5jaHJvbm91c2x5IGluCiAqIHJlc3BvbnNlIHRvIGEgc3VjY2Vzc2Z1bCBjYWxsIHRvIHRoZSA8Y29kZT5kaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgc2Vzc2lvbiBvYmplY3QuCiAqCiAqICA8aDQ+CiAqICAgIDxhIGhyZWY9ImV4YW1wbGUiPjwvYT5FeGFtcGxlCiAqICA8L2g0PgogKiAgPHA+CiAqICAgIFRoZSBmb2xsb3dpbmcgY29kZSBpbml0aWFsaXplcyBhIHNlc3Npb24gYW5kIHNldHMgdXAgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIHdoZW4gYSBzZXNzaW9uIGlzIGRpc2Nvbm5lY3RlZC4KICogIDwvcD4KICogPHByZT52YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqICB2YXIgc2Vzc2lvbklEID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIG93biBzZXNzaW9uIElELgogKiAgICAgICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKiAgdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKgogKiAgdmFyIHNlc3Npb24gPSBUQi5pbml0U2Vzc2lvbihzZXNzaW9uSUQpOwogKiAgc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzZXNzaW9uRGlzY29ubmVjdGVkIiwgc2Vzc2lvbkRpc2Nvbm5lY3RlZEhhbmRsZXIpOwogKiAgc2Vzc2lvbi5jb25uZWN0KGFwaUtleSwgdG9rZW4pOwogKgogKiAgZnVuY3Rpb24gc2Vzc2lvbkRpc0Nvbm5lY3RlZEhhbmRsZXIoZXZlbnQpIHsKICogICAgICBhbGVydCgiVGhlIHNlc3Npb24gZGlzY29ubmVjdGVkLiAiICsgZXZlbnQucmVhc29uKTsKICogIH0KICogIDwvcHJlPgogKgogKiBAcHJvcGVydHkge1N0cmluZ30gcmVhc29uIEEgZGVzY3JpcHRpb24gb2Ygd2h5IHRoZSBzZXNzaW9uIGRpc2Nvbm5lY3RlZC4KICogICBUaGlzIHByb3BlcnR5IGNhbiBoYXZlIHR3byB2YWx1ZXM6CiAqICA8L3A+CiAqICA8dWw+CiAqICAgIDxsaT48Y29kZT4iY2xpZW50RGlzY29ubmVjdGVkIjwvY29kZT4gJiMxNTE7IEEgY2xpZW50IGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBzZXNzaW9uIGJ5IGNhbGxpbmcKICogICAgIHRoZSA8Y29kZT5kaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgU2Vzc2lvbiBvYmplY3Qgb3IgYnkgY2xvc2luZyB0aGUgYnJvd3Nlci4KICogICAgICAoIFNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjZGlzY29ubmVjdCI+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2E+Lik8L2xpPgogKiAgICA8bGk+PGNvZGU+ImZvcmNlRGlzY29ubmVjdGVkIjwvY29kZT4gJiMxNTE7IEEgbW9kZXJhdG9yIGhhcyBkaXNjb25uZWN0ZWQgeW91IGZyb20gdGhlIHNlc3Npb24KICogICAgIGJ5IGNhbGxpbmcgdGhlIDxjb2RlPmZvcmNlRGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIFNlc3Npb24gb2JqZWN0LiAoU2VlCiAqICAgICAgIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNmb3JjZURpc2Nvbm5lY3QiPlNlc3Npb24uZm9yY2VEaXNjb25uZWN0KCk8L2E+Lik8L2xpPgogKiAgICA8bGk+PGNvZGU+Im5ldHdvcmtEaXNjb25uZWN0ZWQiPC9jb2RlPiAmIzE1MTsgVGhlIG5ldHdvcmsgY29ubmVjdGlvbiB0ZXJtaW5hdGVkIGFicnVwdGx5IChmb3IgZXhhbXBsZSwKICogICAgICAgdGhlIGNsaWVudCBsb3N0IHRoZWlyIGludGVybmV0IGNvbm5lY3Rpb24pLjwvbGk+CiAqICA8L3VsPgogKgogKiBAY2xhc3MgU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudAogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlNlc3Npb25EaXNjb25uZWN0RXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgcmVhc29uLCBjYW5jZWxhYmxlKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUsIGNhbmNlbGFibGUpOwoKICAgIHRoaXMucmVhc29uID0gcmVhc29uOwp9OwoKLyoqCiogUHJldmVudHMgdGhlIGRlZmF1bHQgYmVoYXZpb3IgYXNzb2NpYXRlZCB3aXRoIHRoZSBldmVudCBmcm9tIHRha2luZyBwbGFjZS4KKgoqIDxwPkZvciB0aGUgPGNvZGU+c2Vzc2lvbkRpc2Nvbm5lY3RFdmVudDwvY29kZT4sIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzOiBhbGwgU3Vic2NyaWJlciBvYmplY3RzIGFyZSB1bnN1YnNjcmliZWQsCiogYW5kIFB1Ymxpc2hlciBvYmplY3RzIGFyZSBkZXN0cm95ZWQuIElmIHlvdSBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2QgaW4gdGhlCiogZXZlbnQgbGlzdGVuZXIgZm9yIHRoZSA8Y29kZT5zZXNzaW9uRGlzY29ubmVjdDwvY29kZT4gZXZlbnQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCAoYW5kCiogeW91IGNhbiwgb3B0aW9uYWxseSwgY2xlYW4gdXAgU3Vic2NyaWJlciBhbmQgUHVibGlzaGVyIG9iamVjdHMgdXNpbmcgeW91ciBvd24gY29kZSkuCioKKiA8cD5UbyBzZWUgd2hldGhlciBhbiBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yLCBjaGVjayB0aGUgPGNvZGU+Y2FuY2VsYWJsZTwvY29kZT4gcHJvcGVydHkgb2YgdGhlIGV2ZW50IG9iamVjdC4gPC9wPgoqCiogPHA+Q2FsbCB0aGUgPGNvZGU+cHJldmVudERlZmF1bHQoKTwvY29kZT4gbWV0aG9kIGluIHRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3IgdGhlIGV2ZW50LjwvcD4KKgoqIEBtZXRob2QgI3ByZXZlbnREZWZhdWx0CiogQG1lbWJlcm9mIFNlc3Npb25EaXNjb25uZWN0RXZlbnQKKi8KCk9ULlZvbHVtZUV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIHN0cmVhbUlkLCB2b2x1bWUpIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy5zdHJlYW1JZCA9IHN0cmVhbUlkOwogICAgdGhpcy52b2x1bWUgPSB2b2x1bWU7Cn07CgoKT1QuRGV2aWNlRXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgY2FtZXJhLCBtaWNyb3Bob25lKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgdGhpcy5taWNyb3Bob25lID0gbWljcm9waG9uZTsKfTsKCk9ULkRldmljZVN0YXR1c0V2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIGNhbWVyYXMsIG1pY3JvcGhvbmVzLCBzZWxlY3RlZENhbWVyYSwgc2VsZWN0ZWRNaWNyb3Bob25lKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMuY2FtZXJhcyA9IGNhbWVyYXM7CiAgICB0aGlzLm1pY3JvcGhvbmVzID0gbWljcm9waG9uZXM7CiAgICB0aGlzLnNlbGVjdGVkQ2FtZXJhID0gc2VsZWN0ZWRDYW1lcmE7CiAgICB0aGlzLnNlbGVjdGVkTWljcm9waG9uZSA9IHNlbGVjdGVkTWljcm9waG9uZTsKfTsKCk9ULlJlc2l6ZUV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIHdpZHRoRnJvbSwgd2lkdGhUbywgaGVpZ2h0RnJvbSwgaGVpZ2h0VG8pIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy53aWR0aEZyb20gPSB3aWR0aEZyb207CiAgICB0aGlzLndpZHRoVG8gPSB3aWR0aFRvOwogICAgdGhpcy5oZWlnaHRGcm9tID0gaGVpZ2h0RnJvbTsKICAgIHRoaXMuaGVpZ2h0VG8gPSBoZWlnaHRUbzsKfTsKCi8qKgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnN0cmVhbVByb3BlcnR5Q2hhbmdlZDwvY29kZT4gZXZlbnQgaW4gdGhlIGZvbGxvd2luZyBjaXJjdW1zdGFuY2VzOgogKgogKiA8dWw+CiAqCiAqICA8bGk+V2hlbiBhIHB1Ymxpc2hlciBzdGFydHMgb3Igc3RvcHMgcHVibGlzaGluZyBhdWRpbyBvciB2aWRlby4gVGhpcyBjaGFuZ2UgY2F1c2VzIHRoZSA8Y29kZT5oYXNBdWRpbzwvY29kZT4KICogIG9yIDxjb2RlPmhhc1ZpZGVvPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUgU3RyZWFtIG9iamVjdCB0byBjaGFuZ2UuIFRoaXMgY2hhbmdlIHJlc3VsdHMgZnJvbSBhIGNhbGwgdG8gdGhlCiAqICA8Y29kZT5wdWJsaXNoQXVkaW8oKTwvY29kZT4gb3IgPGNvZGU+cHVibGlzaFZpZGVvKCk8L2NvZGU+IG1ldGhvZHMgb2YgdGhlIFB1Ymxpc2ggb2JqZWN0LjwvbGk+CiAqCiAqICA8bGk+V2hlbiB0aGUgPGNvZGU+dmlkZW9EaW1lbnNpb25zPC9jb2RlPiBwcm9wZXJ0eSBvZiBhIHN0cmVhbSBjaGFuZ2VzLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwKICogIHNlZSA8YSBocmVmPSJTdHJlYW0uaHRtbCNwcm9wZXJ0aWVzIj5TdHJlYW0udmlkZW9EaW1lbnNpb25zPC9hPi48L2xpPgogKgogKiA8L3VsPgogKgogKiBAY2xhc3MgU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQKICogQHByb3BlcnR5IHtTdHJpbmd9IGNoYW5nZWRQcm9wZXJ0eSBUaGUgcHJvcGVydHkgb2YgdGhlIHN0cmVhbSB0aGF0IGNoYW5nZWQuIFRoaXMgdmFsdWUgaXMgZWl0aGVyIDxjb2RlPiJoYXNBdWRpbyI8L2NvZGU+LAogKiA8Y29kZT4iaGFzVmlkZW8iPC9jb2RlPiwgb3IgPGNvZGU+InZpZGVvRGltZW5zaW9ucyI8L2NvZGU+LgogKiBAcHJvcGVydHkge1N0cmVhbX0gc3RyZWFtIFRoZSBTdHJlYW0gb2JqZWN0IGZvciB3aGljaCBhIHByb3BlcnR5IGhhcyBjaGFuZ2VkLgogKiBAcHJvcGVydHkge09iamVjdH0gbmV3VmFsdWUgVGhlIG5ldyB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgKGFmdGVyIHRoZSBjaGFuZ2UpLgogKiBAcHJvcGVydHkge09iamVjdH0gb2xkVmFsdWUgVGhlIG9sZCB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgKGJlZm9yZSB0aGUgY2hhbmdlKS4KICoKICogQHNlZSA8YSBocmVmPSJQdWJsaXNoZXIuaHRtbCNwdWJsaXNoQXVkaW8iPlB1Ymxpc2hlci5wdWJsaXNoQXVkaW8oKTwvYT48L3A+CiAqIEBzZWUgPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaFZpZGVvIj5QdWJsaXNoZXIucHVibGlzaFZpZGVvKCk8L2E+PC9wPgogKiBAc2VlIDxhIGhyZWY9IlN0cmVhbS5odG1sI3Byb3BlcnRpZXMiPlN0cmVhbS52aWRlb0RpbWVuc2lvbnM8L2E+PC9wPgogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlN0cmVhbVByb3BlcnR5Q2hhbmdlZEV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIHN0cmVhbSwgY2hhbmdlZFByb3BlcnR5LCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtOwogICAgdGhpcy5jaGFuZ2VkUHJvcGVydHkgPSBjaGFuZ2VkUHJvcGVydHk7CiAgICB0aGlzLm9sZFZhbHVlID0gb2xkVmFsdWU7CiAgICB0aGlzLm5ld1ZhbHVlID0gbmV3VmFsdWU7Cn07CgpPVC5BcmNoaXZlRXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgYXJjaGl2ZXMpIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy5hcmNoaXZlcyA9IGFyY2hpdmVzOwp9OwoKT1QuQXJjaGl2ZVN0cmVhbUV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIGFyY2hpdmUsIHN0cmVhbXMpIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy5hcmNoaXZlID0gYXJjaGl2ZTsKICAgIHRoaXMuc3RyZWFtcyA9IHN0cmVhbXM7Cn07CgpPVC5TdGF0ZUNoYW5nZWRFdmVudCA9IGZ1bmN0aW9uICh0eXBlLCBjaGFuZ2VkVmFsdWVzKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMuY2hhbmdlZFZhbHVlcyA9IGNoYW5nZWRWYWx1ZXM7Cn07CgpPVC5DaGFuZ2VGYWlsZWRFdmVudCA9IGZ1bmN0aW9uICh0eXBlLCByZWFzb25Db2RlLCByZWFzb24sIGZhaWxlZFZhbHVlcykgewogICAgT1QuRXZlbnQuY2FsbCh0aGlzLCB0eXBlKTsKCiAgICB0aGlzLnJlYXNvbkNvZGUgPSByZWFzb25Db2RlOwogICAgdGhpcy5yZWFzb24gPSByZWFzb247CiAgICB0aGlzLmZhaWxlZFZhbHVlcyA9IGZhaWxlZFZhbHVlczsKfTsKCi8qKgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIHNpZ25hbCBldmVudCB3aGVuIHRoZSBjbGllbnQgcmVjZWl2ZXMgYSBzaWduYWwgZnJvbSB0aGUgc2Vzc2lvbi4KICoKICogQGNsYXNzIFNpZ25hbEV2ZW50CiAqIEBwcm9wZXJ0eSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIGFzc2lnbmVkIHRvIHRoZSBzaWduYWwgKGlmIHRoZXJlIGlzIG9uZSkuIFVzZSB0aGUgdHlwZSB0byBmaWx0ZXIgc2lnbmFscwogKiByZWNlaXZlZCAoYnkgYWRkaW5nIGFuIGV2ZW50IGhhbmRsZXIgZm9yIHNpZ25hbDp0eXBlMSBvciBzaWduYWw6dHlwZTIsIGV0Yy4pCiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHBheWxvYWQgc2VudCB3aXRoIHRoZSBzaWduYWwgKGlmIHRoZXJlIGlzIG9uZSkuCiAqIEBwcm9wZXJ0eSB7Q29ubmVjdGlvbn0gZnJvbSBUaGUgQ29ubmVjdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZSBjbGllbnQgdGhhdCBzZW50IHdpdGggdGhlIHNpZ25hbC4KICoKICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjc2lnbmFsIj5TZXNzaW9uLnNpZ25hbCgpPC9hPjwvcD4KICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjZXZlbnRzIj5TZXNzaW9uIGV2ZW50cyAoc2lnbmFsIGFuZCBzaWduYWw6dHlwZSk8L2E+PC9wPgogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlNpZ25hbEV2ZW50ID0gZnVuY3Rpb24odHlwZSwgZGF0YSwgZnJvbSkgewogICAgT1QuRXZlbnQuY2FsbCh0aGlzLCB0eXBlID8gInNpZ25hbDoiICsgdHlwZSA6IE9ULkV2ZW50Lm5hbWVzLlNJR05BTCwgZmFsc2UpOwoKICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICB0aGlzLmZyb20gPSBmcm9tOwp9OwoKCk9ULlN0cmVhbVVwZGF0ZWRFdmVudCA9IGZ1bmN0aW9uIChzdHJlYW0sIGtleSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsICd1cGRhdGVkJyk7CgogICAgdGhpcy50YXJnZXQgPSBzdHJlYW07CiAgICB0aGlzLmNoYW5nZWRQcm9wZXJ0eSA9IGtleTsKICAgIHRoaXMub2xkVmFsdWUgPSBvbGRWYWx1ZTsKICAgIHRoaXMubmV3VmFsdWUgPSBuZXdWYWx1ZTsKfTsKCk9ULkRlc3Ryb3llZEV2ZW50ID0gZnVuY3Rpb24odHlwZSwgdGFyZ2V0LCByZWFzb24pIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSwgZmFsc2UpOwoKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5yZWFzb24gPSByZWFzb247Cn07CgoKfSkod2luZG93KTsKLy8gaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9zdHJpbmdlbmNvZGluZy8KLy8gQW4gaW1wbGVtZW50YXRpb24gb2YgaHR0cDovL2VuY29kaW5nLnNwZWMud2hhdHdnLm9yZy8jYXBpCi8vCihmdW5jdGlvbihnbG9iYWwpIHsKICAndXNlIHN0cmljdCc7CgogIGlmICggKGdsb2JhbC5UZXh0RW5jb2RlciAhPT0gdm9pZCAwKSAmJiAoZ2xvYmFsLlRleHREZWNvZGVyICE9PSB2b2lkIDApKSAgewogICAgLy8gZGVmZXIgdG8gdGhlIG5hdGl2ZSBvbmVzCiAgICAvLyBAdG9kbyBpcyB0aGlzIGEgZ29vZCBpZGVhPwogICAgcmV0dXJuOwogIH0KCiAgLy8KICAvLyBVdGlsaXRpZXMKICAvLwoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gYSBUaGUgbnVtYmVyIHRvIHRlc3QuCiAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiBUaGUgbWluaW11bSB2YWx1ZSBpbiB0aGUgcmFuZ2UsIGluY2x1c2l2ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IFRoZSBtYXhpbXVtIHZhbHVlIGluIHRoZSByYW5nZSwgaW5jbHVzaXZlLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYSA+PSBtaW4gYW5kIGEgPD0gbWF4LgogICAqLwogIGZ1bmN0aW9uIGluUmFuZ2UoYSwgbWluLCBtYXgpIHsKICAgIHJldHVybiBtaW4gPD0gYSAmJiBhIDw9IG1heDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1lcmF0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGQgVGhlIGRlbm9taW5hdG9yLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJlc3VsdCBvZiB0aGUgaW50ZWdlciBkaXZpc2lvbiBvZiBuIGJ5IGQuCiAgICovCiAgZnVuY3Rpb24gZGl2KG4sIGQpIHsKICAgIHJldHVybiBNYXRoLmZsb29yKG4gLyBkKTsKICB9CgoKICAvLwogIC8vIEltcGxlbWVudGF0aW9uIG9mIEVuY29kaW5nIHNwZWNpZmljYXRpb24KICAvLyBodHRwOi8vZHZjcy53My5vcmcvaGcvZW5jb2RpbmcvcmF3LWZpbGUvdGlwL092ZXJ2aWV3Lmh0bWwKICAvLwoKICAvLwogIC8vIDMuIFRlcm1pbm9sb2d5CiAgLy8KCiAgLy8KICAvLyA0LiBFbmNvZGluZ3MKICAvLwoKICAvKiogQGNvbnN0ICovIHZhciBFT0ZfYnl0ZSA9IC0xOwogIC8qKiBAY29uc3QgKi8gdmFyIEVPRl9jb2RlX3BvaW50ID0gLTE7CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7VWludDhBcnJheX0gYnl0ZXMgQXJyYXkgb2YgYnl0ZXMgdGhhdCBwcm92aWRlIHRoZSBzdHJlYW0uCiAgICovCiAgZnVuY3Rpb24gQnl0ZUlucHV0U3RyZWFtKGJ5dGVzKSB7CiAgICAvKiogQHR5cGUge251bWJlcn0gKi8KICAgIHZhciBwb3MgPSAwOwoKICAgIC8qKiBAcmV0dXJuIHtudW1iZXJ9IEdldCB0aGUgbmV4dCBieXRlIGZyb20gdGhlIHN0cmVhbS4gKi8KICAgIHRoaXMuZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAocG9zID49IGJ5dGVzLmxlbmd0aCkgPyBFT0ZfYnl0ZSA6IE51bWJlcihieXRlc1twb3NdKTsKICAgIH07CgogICAgLyoqIEBwYXJhbSB7bnVtYmVyfSBuIE51bWJlciAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIGJ5IHdoaWNoIHRvCiAgICAgKiAgICAgIG9mZnNldCB0aGUgYnl0ZSBwb2ludGVyLiAqLwogICAgdGhpcy5vZmZzZXQgPSBmdW5jdGlvbihuKSB7CiAgICAgIHBvcyArPSBuOwogICAgICBpZiAocG9zIDwgMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignU2Vla2luZyBwYXN0IHN0YXJ0IG9mIHRoZSBidWZmZXInKTsKICAgICAgfQogICAgICBpZiAocG9zID4gYnl0ZXMubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZWVraW5nIHBhc3QgRU9GJyk7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0FycmF5LjxudW1iZXI+fSB0ZXN0IEFycmF5IG9mIGJ5dGVzIHRvIGNvbXBhcmUgYWdhaW5zdC4KICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIHN0YXJ0IG9mIHRoZSBzdHJlYW0gbWF0Y2hlcyB0aGUgdGVzdAogICAgICogICAgIGJ5dGVzLgogICAgICovCiAgICB0aGlzLm1hdGNoID0gZnVuY3Rpb24odGVzdCkgewogICAgICBpZiAodGVzdC5sZW5ndGggPiBwb3MgKyBieXRlcy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIGk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCB0ZXN0Lmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgaWYgKE51bWJlcihieXRlc1twb3MgKyBpXSkgIT09IHRlc3RbaV0pIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtBcnJheS48bnVtYmVyPn0gYnl0ZXMgVGhlIGFycmF5IHRvIHdyaXRlIGJ5dGVzIGludG8uCiAgICovCiAgZnVuY3Rpb24gQnl0ZU91dHB1dFN0cmVhbShieXRlcykgewogICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovCiAgICB2YXIgcG9zID0gMDsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Li4ubnVtYmVyfSB2YXJfYXJncyBUaGUgYnl0ZSBvciBieXRlcyB0byBlbWl0IGludG8gdGhlIHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVtaXQgPSBmdW5jdGlvbih2YXJfYXJncykgewogICAgICAvKiogQHR5cGUge251bWJlcn0gKi8KICAgICAgdmFyIGxhc3QgPSBFT0ZfYnl0ZTsKICAgICAgdmFyIGk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgICBsYXN0ID0gTnVtYmVyKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgYnl0ZXNbcG9zKytdID0gbGFzdDsKICAgICAgfQogICAgICByZXR1cm4gbGFzdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzb3VyY2Ugb2YgY29kZSB1bml0cyBmb3IgdGhlIHN0cmVhbS4KICAgKi8KICBmdW5jdGlvbiBDb2RlUG9pbnRJbnB1dFN0cmVhbShzdHJpbmcpIHsKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBJbnB1dCBzdHJpbmcgb2YgVVRGLTE2IGNvZGUgdW5pdHMuCiAgICAgKiBAcmV0dXJuIHtBcnJheS48bnVtYmVyPn0gQ29kZSBwb2ludHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0cmluZ1RvQ29kZVBvaW50cyhzdHJpbmcpIHsKICAgICAgLyoqIEB0eXBlIHtBcnJheS48bnVtYmVyPn0gKi8KICAgICAgdmFyIGNwcyA9IFtdOwogICAgICAvLyBCYXNlZCBvbiBodHRwOi8vd3d3LnczLm9yZy9UUi9XZWJJREwvI2lkbC1ET01TdHJpbmcKICAgICAgdmFyIGkgPSAwLCBuID0gc3RyaW5nLmxlbmd0aDsKICAgICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoKSB7CiAgICAgICAgdmFyIGMgPSBzdHJpbmcuY2hhckNvZGVBdChpKTsKICAgICAgICBpZiAoIWluUmFuZ2UoYywgMHhEODAwLCAweERGRkYpKSB7CiAgICAgICAgICBjcHMucHVzaChjKTsKICAgICAgICB9IGVsc2UgaWYgKGluUmFuZ2UoYywgMHhEQzAwLCAweERGRkYpKSB7CiAgICAgICAgICBjcHMucHVzaCgweEZGRkQpOwogICAgICAgIH0gZWxzZSB7IC8vIChpblJhbmdlKGN1LCAweEQ4MDAsIDB4REJGRikpCiAgICAgICAgICBpZiAoaSA9PT0gbiAtIDEpIHsKICAgICAgICAgICAgY3BzLnB1c2goMHhGRkZEKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkID0gc3RyaW5nLmNoYXJDb2RlQXQoaSArIDEpOwogICAgICAgICAgICBpZiAoaW5SYW5nZShkLCAweERDMDAsIDB4REZGRikpIHsKICAgICAgICAgICAgICB2YXIgYSA9IGMgJiAweDNGRjsKICAgICAgICAgICAgICB2YXIgYiA9IGQgJiAweDNGRjsKICAgICAgICAgICAgICBpICs9IDE7CiAgICAgICAgICAgICAgY3BzLnB1c2goMHgxMDAwMCArIChhIDw8IDEwKSArIGIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNwcy5wdXNoKDB4RkZGRCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaSArPSAxOwogICAgICB9CiAgICAgIHJldHVybiBjcHM7CiAgICB9CgogICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovCiAgICB2YXIgcG9zID0gMDsKICAgIC8qKiBAdHlwZSB7QXJyYXkuPG51bWJlcj59ICovCiAgICB2YXIgY3BzID0gc3RyaW5nVG9Db2RlUG9pbnRzKHN0cmluZyk7CgogICAgLyoqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgYnl0ZXMgKHBvc2l0aXZlIG9yIG5lZ2F0aXZlKQogICAgICogICAgICB0byBhZHZhbmNlIHRoZSBjb2RlIHBvaW50IHBvaW50ZXIgYnkuKi8KICAgIHRoaXMub2Zmc2V0ID0gZnVuY3Rpb24obikgewogICAgICBwb3MgKz0gbjsKICAgICAgaWYgKHBvcyA8IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlZWtpbmcgcGFzdCBzdGFydCBvZiB0aGUgYnVmZmVyJyk7CiAgICAgIH0KICAgICAgaWYgKHBvcyA+IGNwcy5sZW5ndGgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlZWtpbmcgcGFzdCBFT0YnKTsKICAgICAgfQogICAgfTsKCgogICAgLyoqIEByZXR1cm4ge251bWJlcn0gR2V0IHRoZSBuZXh0IGNvZGUgcG9pbnQgZnJvbSB0aGUgc3RyZWFtLiAqLwogICAgdGhpcy5nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKHBvcyA+PSBjcHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIEVPRl9jb2RlX3BvaW50OwogICAgICB9CiAgICAgIHJldHVybiBjcHNbcG9zXTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBDb2RlUG9pbnRPdXRwdXRTdHJlYW0oKSB7CiAgICAvKiogQHR5cGUge3N0cmluZ30gKi8KICAgIHZhciBzdHJpbmcgPSAnJzsKCiAgICAvKiogQHJldHVybiB7c3RyaW5nfSBUaGUgYWNjdW11bGF0ZWQgc3RyaW5nLiAqLwogICAgdGhpcy5zdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHN0cmluZzsKICAgIH07CgogICAgLyoqIEBwYXJhbSB7bnVtYmVyfSBjIFRoZSBjb2RlIHBvaW50IHRvIGVuY29kZSBpbnRvIHRoZSBzdHJlYW0uICovCiAgICB0aGlzLmVtaXQgPSBmdW5jdGlvbihjKSB7CiAgICAgIGlmIChjIDw9IDB4RkZGRikgewogICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwogICAgICB9IGVsc2UgewogICAgICAgIGMgLT0gMHgxMDAwMDsKICAgICAgICBzdHJpbmcgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweEQ4MDAgKyAoKGMgPj4gMTApICYgMHgzZmYpKTsKICAgICAgICBzdHJpbmcgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweERDMDAgKyAoYyAmIDB4M2ZmKSk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZSBEZXNjcmlwdGlvbiBvZiB0aGUgZXJyb3IuCiAgICovCiAgZnVuY3Rpb24gRW5jb2RpbmdFcnJvcihtZXNzYWdlKSB7CiAgICB0aGlzLm5hbWUgPSAnRW5jb2RpbmdFcnJvcic7CiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgdGhpcy5jb2RlID0gMDsKICB9CiAgRW5jb2RpbmdFcnJvci5wcm90b3R5cGUgPSBFcnJvci5wcm90b3R5cGU7CgogIC8qKgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmF0YWwgSWYgdHJ1ZSwgZGVjb2RpbmcgZXJyb3JzIHJhaXNlIGFuIGV4Y2VwdGlvbi4KICAgKiBAcGFyYW0ge251bWJlcj19IG9wdF9jb2RlX3BvaW50IE92ZXJyaWRlIHRoZSBzdGFuZGFyZCBmYWxsYmFjayBjb2RlIHBvaW50LgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGNvZGUgcG9pbnQgdG8gaW5zZXJ0IG9uIGEgZGVjb2RpbmcgZXJyb3IuCiAgICovCiAgZnVuY3Rpb24gZGVjb2RlckVycm9yKGZhdGFsLCBvcHRfY29kZV9wb2ludCkgewogICAgaWYgKGZhdGFsKSB7CiAgICAgIHRocm93IG5ldyBFbmNvZGluZ0Vycm9yKCdEZWNvZGVyIGVycm9yJyk7CiAgICB9CiAgICByZXR1cm4gb3B0X2NvZGVfcG9pbnQgfHwgMHhGRkZEOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvZGVfcG9pbnQgVGhlIGNvZGUgcG9pbnQgdGhhdCBjb3VsZCBub3QgYmUgZW5jb2RlZC4KICAgKi8KICBmdW5jdGlvbiBlbmNvZGVyRXJyb3IoY29kZV9wb2ludCkgewogICAgdGhyb3cgbmV3IEVuY29kaW5nRXJyb3IoJ1RoZSBjb2RlIHBvaW50ICcgKyBjb2RlX3BvaW50ICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgY291bGQgbm90IGJlIGVuY29kZWQuJyk7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge3N0cmluZ30gbGFiZWwgVGhlIGVuY29kaW5nIGxhYmVsLgogICAqIEByZXR1cm4gez97bmFtZTpzdHJpbmcsbGFiZWxzOkFycmF5LjxzdHJpbmc+fX0KICAgKi8KICBmdW5jdGlvbiBnZXRFbmNvZGluZyhsYWJlbCkgewogICAgbGFiZWwgPSBTdHJpbmcobGFiZWwpLnRyaW0oKS50b0xvd2VyQ2FzZSgpOwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChsYWJlbF90b19lbmNvZGluZywgbGFiZWwpKSB7CiAgICAgIHJldHVybiBsYWJlbF90b19lbmNvZGluZ1tsYWJlbF07CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8qKiBAdHlwZSB7QXJyYXkuPHtlbmNvZGluZ3M6IEFycmF5Ljx7bmFtZTpzdHJpbmcsbGFiZWxzOkFycmF5LjxzdHJpbmc+fT4sCiAgICogICAgICBoZWFkaW5nOiBzdHJpbmd9Pn0gKi8KICB2YXIgZW5jb2RpbmdzID0gWwogICAgewogICAgICAnZW5jb2RpbmdzJzogWwogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICd1bmljb2RlLTEtMS11dGYtOCcsCiAgICAgICAgICAgICd1dGYtOCcsCiAgICAgICAgICAgICd1dGY4JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3V0Zi04JwogICAgICAgIH0KICAgICAgXSwKICAgICAgJ2hlYWRpbmcnOiAnVGhlIEVuY29kaW5nJwogICAgfSwKICAgIHsKICAgICAgJ2VuY29kaW5ncyc6IFsKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3A4NjQnLAogICAgICAgICAgICAnaWJtODY0JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2libTg2NCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjcDg2NicsCiAgICAgICAgICAgICdpYm04NjYnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaWJtODY2JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2NzaXNvbGF0aW4yJywKICAgICAgICAgICAgJ2lzby04ODU5LTInLAogICAgICAgICAgICAnaXNvLWlyLTEwMScsCiAgICAgICAgICAgICdpc284ODU5LTInLAogICAgICAgICAgICAnaXNvXzg4NTktMicsCiAgICAgICAgICAgICdsMicsCiAgICAgICAgICAgICdsYXRpbjInCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktMicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluMycsCiAgICAgICAgICAgICdpc28tODg1OS0zJywKICAgICAgICAgICAgJ2lzb184ODU5LTMnLAogICAgICAgICAgICAnaXNvLWlyLTEwOScsCiAgICAgICAgICAgICdsMycsCiAgICAgICAgICAgICdsYXRpbjMnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktMycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluNCcsCiAgICAgICAgICAgICdpc28tODg1OS00JywKICAgICAgICAgICAgJ2lzb184ODU5LTQnLAogICAgICAgICAgICAnaXNvLWlyLTExMCcsCiAgICAgICAgICAgICdsNCcsCiAgICAgICAgICAgICdsYXRpbjQnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktNCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluY3lyaWxsaWMnLAogICAgICAgICAgICAnY3lyaWxsaWMnLAogICAgICAgICAgICAnaXNvLTg4NTktNScsCiAgICAgICAgICAgICdpc29fODg1OS01JywKICAgICAgICAgICAgJ2lzby1pci0xNDQnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktNScKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdhcmFiaWMnLAogICAgICAgICAgICAnY3Npc29sYXRpbmFyYWJpYycsCiAgICAgICAgICAgICdlY21hLTExNCcsCiAgICAgICAgICAgICdpc28tODg1OS02JywKICAgICAgICAgICAgJ2lzb184ODU5LTYnLAogICAgICAgICAgICAnaXNvLWlyLTEyNycKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdpc28tODg1OS02JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2NzaXNvbGF0aW5ncmVlaycsCiAgICAgICAgICAgICdlY21hLTExOCcsCiAgICAgICAgICAgICdlbG90XzkyOCcsCiAgICAgICAgICAgICdncmVlaycsCiAgICAgICAgICAgICdncmVlazgnLAogICAgICAgICAgICAnaXNvLTg4NTktNycsCiAgICAgICAgICAgICdpc29fODg1OS03JywKICAgICAgICAgICAgJ2lzby1pci0xMjYnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktNycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluaGVicmV3JywKICAgICAgICAgICAgJ2hlYnJldycsCiAgICAgICAgICAgICdpc28tODg1OS04JywKICAgICAgICAgICAgJ2lzby04ODU5LTgtaScsCiAgICAgICAgICAgICdpc28taXItMTM4JywKICAgICAgICAgICAgJ2lzb184ODU5LTgnLAogICAgICAgICAgICAndmlzdWFsJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby04ODU5LTgnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3Npc29sYXRpbjYnLAogICAgICAgICAgICAnaXNvLTg4NTktMTAnLAogICAgICAgICAgICAnaXNvLWlyLTE1NycsCiAgICAgICAgICAgICdpc284ODU5LTEwJywKICAgICAgICAgICAgJ2w2JywKICAgICAgICAgICAgJ2xhdGluNicKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdpc28tODg1OS0xMCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdpc28tODg1OS0xMycKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdpc28tODg1OS0xMycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdpc28tODg1OS0xNCcsCiAgICAgICAgICAgICdpc284ODU5LTE0JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby04ODU5LTE0JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2lzby04ODU5LTE1JywKICAgICAgICAgICAgJ2lzb184ODU5LTE1JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby04ODU5LTE1JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2lzby04ODU5LTE2JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby04ODU5LTE2JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2tvaTgtcicsCiAgICAgICAgICAgICdrb2k4X3InCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAna29pOC1yJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2tvaTgtdScKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdrb2k4LXUnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3NtYWNpbnRvc2gnLAogICAgICAgICAgICAnbWFjJywKICAgICAgICAgICAgJ21hY2ludG9zaCcsCiAgICAgICAgICAgICd4LW1hYy1yb21hbicKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdtYWNpbnRvc2gnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnaXNvLTg4NTktMTEnLAogICAgICAgICAgICAndGlzLTYyMCcsCiAgICAgICAgICAgICd3aW5kb3dzLTg3NCcKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTg3NCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICd3aW5kb3dzLTEyNTAnLAogICAgICAgICAgICAneC1jcDEyNTAnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnd2luZG93cy0xMjUwJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ3dpbmRvd3MtMTI1MScsCiAgICAgICAgICAgICd4LWNwMTI1MScKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTEyNTEnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnYXNjaWknLAogICAgICAgICAgICAnYW5zaV94My40LTE5NjgnLAogICAgICAgICAgICAnY3Npc29sYXRpbjEnLAogICAgICAgICAgICAnaXNvLTg4NTktMScsCiAgICAgICAgICAgICdpc284ODU5LTEnLAogICAgICAgICAgICAnaXNvXzg4NTktMScsCiAgICAgICAgICAgICdsMScsCiAgICAgICAgICAgICdsYXRpbjEnLAogICAgICAgICAgICAndXMtYXNjaWknLAogICAgICAgICAgICAnd2luZG93cy0xMjUyJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3dpbmRvd3MtMTI1MicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjcDEyNTMnLAogICAgICAgICAgICAnd2luZG93cy0xMjUzJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3dpbmRvd3MtMTI1MycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluNScsCiAgICAgICAgICAgICdpc28tODg1OS05JywKICAgICAgICAgICAgJ2lzby1pci0xNDgnLAogICAgICAgICAgICAnbDUnLAogICAgICAgICAgICAnbGF0aW41JywKICAgICAgICAgICAgJ3dpbmRvd3MtMTI1NCcKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTEyNTQnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3AxMjU1JywKICAgICAgICAgICAgJ3dpbmRvd3MtMTI1NScKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTEyNTUnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3AxMjU2JywKICAgICAgICAgICAgJ3dpbmRvd3MtMTI1NicKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTEyNTYnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnd2luZG93cy0xMjU3JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3dpbmRvd3MtMTI1NycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjcDEyNTgnLAogICAgICAgICAgICAnd2luZG93cy0xMjU4JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3dpbmRvd3MtMTI1OCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICd4LW1hYy1jeXJpbGxpYycsCiAgICAgICAgICAgICd4LW1hYy11a3JhaW5pYW4nCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAneC1tYWMtY3lyaWxsaWMnCiAgICAgICAgfQogICAgICBdLAogICAgICAnaGVhZGluZyc6ICdMZWdhY3kgc2luZ2xlLWJ5dGUgZW5jb2RpbmdzJwogICAgfSwKICAgIHsKICAgICAgJ2VuY29kaW5ncyc6IFsKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY2hpbmVzZScsCiAgICAgICAgICAgICdjc2diMjMxMicsCiAgICAgICAgICAgICdjc2lzbzU4Z2IyMzEyODAnLAogICAgICAgICAgICAnZ2IyMzEyJywKICAgICAgICAgICAgJ2diaycsCiAgICAgICAgICAgICdnYl8yMzEyJywKICAgICAgICAgICAgJ2diXzIzMTItODAnLAogICAgICAgICAgICAnaXNvLWlyLTU4JywKICAgICAgICAgICAgJ3gtZ2JrJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2diaycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdnYjE4MDMwJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2diMTgwMzAnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnaHotZ2ItMjMxMicKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdoei1nYi0yMzEyJwogICAgICAgIH0KICAgICAgXSwKICAgICAgJ2hlYWRpbmcnOiAnTGVnYWN5IG11bHRpLWJ5dGUgQ2hpbmVzZSAoc2ltcGxpZmllZCkgZW5jb2RpbmdzJwogICAgfSwKICAgIHsKICAgICAgJ2VuY29kaW5ncyc6IFsKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnYmlnNScsCiAgICAgICAgICAgICdiaWc1LWhrc2NzJywKICAgICAgICAgICAgJ2NuLWJpZzUnLAogICAgICAgICAgICAnY3NiaWc1JywKICAgICAgICAgICAgJ3gteC1iaWc1JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2JpZzUnCiAgICAgICAgfQogICAgICBdLAogICAgICAnaGVhZGluZyc6ICdMZWdhY3kgbXVsdGktYnl0ZSBDaGluZXNlICh0cmFkaXRpb25hbCkgZW5jb2RpbmdzJwogICAgfSwKICAgIHsKICAgICAgJ2VuY29kaW5ncyc6IFsKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3NldWNwa2RmbXRqYXBhbmVzZScsCiAgICAgICAgICAgICdldWMtanAnLAogICAgICAgICAgICAneC1ldWMtanAnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnZXVjLWpwJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2NzaXNvMjAyMmpwJywKICAgICAgICAgICAgJ2lzby0yMDIyLWpwJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby0yMDIyLWpwJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2Nzc2hpZnRqaXMnLAogICAgICAgICAgICAnbXNfa2FuamknLAogICAgICAgICAgICAnc2hpZnQtamlzJywKICAgICAgICAgICAgJ3NoaWZ0X2ppcycsCiAgICAgICAgICAgICdzamlzJywKICAgICAgICAgICAgJ3dpbmRvd3MtMzFqJywKICAgICAgICAgICAgJ3gtc2ppcycKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdzaGlmdF9qaXMnCiAgICAgICAgfQogICAgICBdLAogICAgICAnaGVhZGluZyc6ICdMZWdhY3kgbXVsdGktYnl0ZSBKYXBhbmVzZSBlbmNvZGluZ3MnCiAgICB9LAogICAgewogICAgICAnZW5jb2RpbmdzJzogWwogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2V1Y2tyJywKICAgICAgICAgICAgJ2Nza3NjNTYwMTE5ODcnLAogICAgICAgICAgICAnZXVjLWtyJywKICAgICAgICAgICAgJ2lzby1pci0xNDknLAogICAgICAgICAgICAna29yZWFuJywKICAgICAgICAgICAgJ2tzX2NfNTYwMS0xOTg3JywKICAgICAgICAgICAgJ2tzX2NfNTYwMS0xOTg5JywKICAgICAgICAgICAgJ2tzYzU2MDEnLAogICAgICAgICAgICAna3NjXzU2MDEnLAogICAgICAgICAgICAnd2luZG93cy05NDknCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnZXVjLWtyJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2NzaXNvMjAyMmtyJywKICAgICAgICAgICAgJ2lzby0yMDIyLWtyJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby0yMDIyLWtyJwogICAgICAgIH0KICAgICAgXSwKICAgICAgJ2hlYWRpbmcnOiAnTGVnYWN5IG11bHRpLWJ5dGUgS29yZWFuIGVuY29kaW5ncycKICAgIH0sCiAgICB7CiAgICAgICdlbmNvZGluZ3MnOiBbCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ3V0Zi0xNicsCiAgICAgICAgICAgICd1dGYtMTZsZScKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd1dGYtMTYnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAndXRmLTE2YmUnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAndXRmLTE2YmUnCiAgICAgICAgfQogICAgICBdLAogICAgICAnaGVhZGluZyc6ICdMZWdhY3kgdXRmLTE2IGVuY29kaW5ncycKICAgIH0KICBdOwoKICB2YXIgbmFtZV90b19lbmNvZGluZyA9IHt9OwogIHZhciBsYWJlbF90b19lbmNvZGluZyA9IHt9OwogIGVuY29kaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7CiAgICBjYXRlZ29yeS5lbmNvZGluZ3MuZm9yRWFjaChmdW5jdGlvbihlbmNvZGluZykgewogICAgICBuYW1lX3RvX2VuY29kaW5nW2VuY29kaW5nLm5hbWVdID0gZW5jb2Rpbmc7CiAgICAgIGVuY29kaW5nLmxhYmVscy5mb3JFYWNoKGZ1bmN0aW9uKGxhYmVsKSB7CiAgICAgICAgbGFiZWxfdG9fZW5jb2RpbmdbbGFiZWxdID0gZW5jb2Rpbmc7CiAgICAgIH0pOwogICAgfSk7CiAgfSk7CgogIC8vCiAgLy8gNS4gSW5kZXhlcwogIC8vCgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBwb2ludGVyIFRoZSB8cG9pbnRlcnwgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge0FycmF5Ljw/bnVtYmVyPn0gaW5kZXggVGhlIHxpbmRleHwgdG8gc2VhcmNoIHdpdGhpbi4KICAgKiBAcmV0dXJuIHs/bnVtYmVyfSBUaGUgY29kZSBwb2ludCBjb3JyZXNwb25kaW5nIHRvIHxwb2ludGVyfCBpbiB8aW5kZXh8LAogICAqICAgICBvciBudWxsIGlmIHxjb2RlIHBvaW50fCBpcyBub3QgaW4gfGluZGV4fC4KICAgKi8KICBmdW5jdGlvbiBpbmRleENvZGVQb2ludEZvcihwb2ludGVyLCBpbmRleCkgewogICAgcmV0dXJuIChpbmRleCB8fCBbXSlbcG9pbnRlcl0gfHwgbnVsbDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb2RlX3BvaW50IFRoZSB8Y29kZSBwb2ludHwgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge0FycmF5Ljw/bnVtYmVyPn0gaW5kZXggVGhlIHxpbmRleHwgdG8gc2VhcmNoIHdpdGhpbi4KICAgKiBAcmV0dXJuIHs/bnVtYmVyfSBUaGUgZmlyc3QgcG9pbnRlciBjb3JyZXNwb25kaW5nIHRvIHxjb2RlIHBvaW50fCBpbgogICAqICAgICB8aW5kZXh8LCBvciBudWxsIGlmIHxjb2RlIHBvaW50fCBpcyBub3QgaW4gfGluZGV4fC4KICAgKi8KICBmdW5jdGlvbiBpbmRleFBvaW50ZXJGb3IoY29kZV9wb2ludCwgaW5kZXgpIHsKICAgIHZhciBwb2ludGVyID0gaW5kZXguaW5kZXhPZihjb2RlX3BvaW50KTsKICAgIHJldHVybiBwb2ludGVyID09PSAtMSA/IG51bGwgOiBwb2ludGVyOwogIH0KCiAgLyoqIEB0eXBlIHtPYmplY3QuPHN0cmluZywgKEFycmF5LjxudW1iZXI+fEFycmF5LjxBcnJheS48bnVtYmVyPj4pPn0gKi8KICB2YXIgaW5kZXhlcyA9IGdsb2JhbFsnZW5jb2RpbmctaW5kZXhlcyddIHx8IHt9OwoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gcG9pbnRlciBUaGUgfHBvaW50ZXJ8IHRvIHNlYXJjaCBmb3IgaW4gdGhlIGdiMTgwMzAgaW5kZXguCiAgICogQHJldHVybiB7P251bWJlcn0gVGhlIGNvZGUgcG9pbnQgY29ycmVzcG9uZGluZyB0byB8cG9pbnRlcnwgaW4gfGluZGV4fCwKICAgKiAgICAgb3IgbnVsbCBpZiB8Y29kZSBwb2ludHwgaXMgbm90IGluIHRoZSBnYjE4MDMwIGluZGV4LgogICAqLwogIGZ1bmN0aW9uIGluZGV4R0IxODAzMENvZGVQb2ludEZvcihwb2ludGVyKSB7CiAgICBpZiAoKHBvaW50ZXIgPiAzOTQxOSAmJiBwb2ludGVyIDwgMTg5MDAwKSB8fCAocG9pbnRlciA+IDEyMzc1NzUpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBvZmZzZXQgPSAwLAogICAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBjb2RlX3BvaW50X29mZnNldCA9IDAsCiAgICAgICAgLyoqIEB0eXBlIHtBcnJheS48QXJyYXkuPG51bWJlcj4+fSAqLyBpbmRleCA9IGluZGV4ZXNbJ2diMTgwMzAnXTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGluZGV4Lmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBlbnRyeSA9IGluZGV4W2ldOwogICAgICBpZiAoZW50cnlbMF0gPD0gcG9pbnRlcikgewogICAgICAgIG9mZnNldCA9IGVudHJ5WzBdOwogICAgICAgIGNvZGVfcG9pbnRfb2Zmc2V0ID0gZW50cnlbMV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb2RlX3BvaW50X29mZnNldCArIHBvaW50ZXIgLSBvZmZzZXQ7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gY29kZV9wb2ludCBUaGUgfGNvZGUgcG9pbnR8IHRvIGxvY2F0ZSBpbiB0aGUgZ2IxODAzMCBpbmRleC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBmaXJzdCBwb2ludGVyIGNvcnJlc3BvbmRpbmcgdG8gfGNvZGUgcG9pbnR8IGluIHRoZQogICAqICAgICBnYjE4MDMwIGluZGV4LgogICAqLwogIGZ1bmN0aW9uIGluZGV4R0IxODAzMFBvaW50ZXJGb3IoY29kZV9wb2ludCkgewogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBvZmZzZXQgPSAwLAogICAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBwb2ludGVyX29mZnNldCA9IDAsCiAgICAgICAgLyoqIEB0eXBlIHtBcnJheS48QXJyYXkuPG51bWJlcj4+fSAqLyBpbmRleCA9IGluZGV4ZXNbJ2diMTgwMzAnXTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGluZGV4Lmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBlbnRyeSA9IGluZGV4W2ldOwogICAgICBpZiAoZW50cnlbMV0gPD0gY29kZV9wb2ludCkgewogICAgICAgIG9mZnNldCA9IGVudHJ5WzFdOwogICAgICAgIHBvaW50ZXJfb2Zmc2V0ID0gZW50cnlbMF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwb2ludGVyX29mZnNldCArIGNvZGVfcG9pbnQgLSBvZmZzZXQ7CiAgfQoKICAvLwogIC8vIDcuIFRoZSBlbmNvZGluZwogIC8vCgogIC8vIDcuMSB1dGYtOAoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBVVEY4RGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyB1dGY4X2NvZGVfcG9pbnQgPSAwLAogICAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyB1dGY4X2J5dGVzX25lZWRlZCA9IDAsCiAgICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIHV0ZjhfYnl0ZXNfc2VlbiA9IDAsCiAgICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAwOwoKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICBpZiAodXRmOF9ieXRlc19uZWVkZWQgIT09IDApIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgxKTsKCiAgICAgIGlmICh1dGY4X2J5dGVzX25lZWRlZCA9PT0gMCkgewogICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgICByZXR1cm4gYml0ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHhDMiwgMHhERikpIHsKICAgICAgICAgIHV0ZjhfYnl0ZXNfbmVlZGVkID0gMTsKICAgICAgICAgIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAweDgwOwogICAgICAgICAgdXRmOF9jb2RlX3BvaW50ID0gYml0ZSAtIDB4QzA7CiAgICAgICAgfSBlbHNlIGlmIChpblJhbmdlKGJpdGUsIDB4RTAsIDB4RUYpKSB7CiAgICAgICAgICB1dGY4X2J5dGVzX25lZWRlZCA9IDI7CiAgICAgICAgICB1dGY4X2xvd2VyX2JvdW5kYXJ5ID0gMHg4MDA7CiAgICAgICAgICB1dGY4X2NvZGVfcG9pbnQgPSBiaXRlIC0gMHhFMDsKICAgICAgICB9IGVsc2UgaWYgKGluUmFuZ2UoYml0ZSwgMHhGMCwgMHhGNCkpIHsKICAgICAgICAgIHV0ZjhfYnl0ZXNfbmVlZGVkID0gMzsKICAgICAgICAgIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAweDEwMDAwOwogICAgICAgICAgdXRmOF9jb2RlX3BvaW50ID0gYml0ZSAtIDB4RjA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIH0KICAgICAgICB1dGY4X2NvZGVfcG9pbnQgPSB1dGY4X2NvZGVfcG9pbnQgKiBNYXRoLnBvdyg2NCwgdXRmOF9ieXRlc19uZWVkZWQpOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmICghaW5SYW5nZShiaXRlLCAweDgwLCAweEJGKSkgewogICAgICAgIHV0ZjhfY29kZV9wb2ludCA9IDA7CiAgICAgICAgdXRmOF9ieXRlc19uZWVkZWQgPSAwOwogICAgICAgIHV0ZjhfYnl0ZXNfc2VlbiA9IDA7CiAgICAgICAgdXRmOF9sb3dlcl9ib3VuZGFyeSA9IDA7CiAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgICAgdXRmOF9ieXRlc19zZWVuICs9IDE7CiAgICAgIHV0ZjhfY29kZV9wb2ludCA9IHV0ZjhfY29kZV9wb2ludCArIChiaXRlIC0gMHg4MCkgKgogICAgICAgICAgTWF0aC5wb3coNjQsIHV0ZjhfYnl0ZXNfbmVlZGVkIC0gdXRmOF9ieXRlc19zZWVuKTsKICAgICAgaWYgKHV0ZjhfYnl0ZXNfc2VlbiAhPT0gdXRmOF9ieXRlc19uZWVkZWQpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICB2YXIgY29kZV9wb2ludCA9IHV0ZjhfY29kZV9wb2ludDsKICAgICAgdmFyIGxvd2VyX2JvdW5kYXJ5ID0gdXRmOF9sb3dlcl9ib3VuZGFyeTsKICAgICAgdXRmOF9jb2RlX3BvaW50ID0gMDsKICAgICAgdXRmOF9ieXRlc19uZWVkZWQgPSAwOwogICAgICB1dGY4X2J5dGVzX3NlZW4gPSAwOwogICAgICB1dGY4X2xvd2VyX2JvdW5kYXJ5ID0gMDsKICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgbG93ZXJfYm91bmRhcnksIDB4MTBGRkZGKSAmJgogICAgICAgICAgIWluUmFuZ2UoY29kZV9wb2ludCwgMHhEODAwLCAweERGRkYpKSB7CiAgICAgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gVVRGOEVuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhEODAwLCAweERGRkYpKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3ZikpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgdmFyIGNvdW50LCBvZmZzZXQ7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDA4MCwgMHgwN0ZGKSkgewogICAgICAgIGNvdW50ID0gMTsKICAgICAgICBvZmZzZXQgPSAweEMwOwogICAgICB9IGVsc2UgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHgwODAwLCAweEZGRkYpKSB7CiAgICAgICAgY291bnQgPSAyOwogICAgICAgIG9mZnNldCA9IDB4RTA7CiAgICAgIH0gZWxzZSBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDEwMDAwLCAweDEwRkZGRikpIHsKICAgICAgICBjb3VudCA9IDM7CiAgICAgICAgb2Zmc2V0ID0gMHhGMDsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoCiAgICAgICAgICBkaXYoY29kZV9wb2ludCwgTWF0aC5wb3coNjQsIGNvdW50KSkgKyBvZmZzZXQpOwogICAgICB3aGlsZSAoY291bnQgPiAwKSB7CiAgICAgICAgdmFyIHRlbXAgPSBkaXYoY29kZV9wb2ludCwgTWF0aC5wb3coNjQsIGNvdW50IC0gMSkpOwogICAgICAgIHJlc3VsdCA9IG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4ODAgKyAodGVtcCAlIDY0KSk7CiAgICAgICAgY291bnQgLT0gMTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ3V0Zi04J10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgVVRGOEVuY29kZXIob3B0aW9ucyk7CiAgfTsKICBuYW1lX3RvX2VuY29kaW5nWyd1dGYtOCddLmdldERlY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFVURjhEZWNvZGVyKG9wdGlvbnMpOwogIH07CgogIC8vCiAgLy8gOC4gTGVnYWN5IHNpbmdsZS1ieXRlIGVuY29kaW5ncwogIC8vCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7QXJyYXkuPG51bWJlcj59IGluZGV4IFRoZSBlbmNvZGluZyBpbmRleC4KICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBTaW5nbGVCeXRlRGVjb2RlcihpbmRleCwgb3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgwMCwgMHg3RikpIHsKICAgICAgICByZXR1cm4gYml0ZTsKICAgICAgfQogICAgICB2YXIgY29kZV9wb2ludCA9IGluZGV4W2JpdGUgLSAweDgwXTsKICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICByZXR1cm4gY29kZV9wb2ludDsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge0FycmF5Ljw/bnVtYmVyPn0gaW5kZXggVGhlIGVuY29kaW5nIGluZGV4LgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIFNpbmdsZUJ5dGVFbmNvZGVyKGluZGV4LCBvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgLyoqCiAgICAgKiBAcGFyYW0ge0J5dGVPdXRwdXRTdHJlYW19IG91dHB1dF9ieXRlX3N0cmVhbSBPdXRwdXQgYnl0ZSBzdHJlYW0uCiAgICAgKiBAcGFyYW0ge0NvZGVQb2ludElucHV0U3RyZWFtfSBjb2RlX3BvaW50X3BvaW50ZXIgSW5wdXQgc3RyZWFtLgogICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFzdCBieXRlIGVtaXR0ZWQuCiAgICAgKi8KICAgIHRoaXMuZW5jb2RlID0gZnVuY3Rpb24ob3V0cHV0X2J5dGVfc3RyZWFtLCBjb2RlX3BvaW50X3BvaW50ZXIpIHsKICAgICAgdmFyIGNvZGVfcG9pbnQgPSBjb2RlX3BvaW50X3BvaW50ZXIuZ2V0KCk7CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSBFT0ZfY29kZV9wb2ludCkgewogICAgICAgIHJldHVybiBFT0ZfYnl0ZTsKICAgICAgfQogICAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3RikpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgdmFyIHBvaW50ZXIgPSBpbmRleFBvaW50ZXJGb3IoY29kZV9wb2ludCwgaW5kZXgpOwogICAgICBpZiAocG9pbnRlciA9PT0gbnVsbCkgewogICAgICAgIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQocG9pbnRlciArIDB4ODApOwogICAgfTsKICB9CgogIChmdW5jdGlvbigpIHsKICAgIFsnaWJtODY0JywgJ2libTg2NicsICdpc28tODg1OS0yJywgJ2lzby04ODU5LTMnLCAnaXNvLTg4NTktNCcsCiAgICAgJ2lzby04ODU5LTUnLCAnaXNvLTg4NTktNicsICdpc28tODg1OS03JywgJ2lzby04ODU5LTgnLCAnaXNvLTg4NTktMTAnLAogICAgICdpc28tODg1OS0xMycsICdpc28tODg1OS0xNCcsICdpc28tODg1OS0xNScsICdpc28tODg1OS0xNicsICdrb2k4LXInLAogICAgICdrb2k4LXUnLCAnbWFjaW50b3NoJywgJ3dpbmRvd3MtODc0JywgJ3dpbmRvd3MtMTI1MCcsICd3aW5kb3dzLTEyNTEnLAogICAgICd3aW5kb3dzLTEyNTInLCAnd2luZG93cy0xMjUzJywgJ3dpbmRvd3MtMTI1NCcsICd3aW5kb3dzLTEyNTUnLAogICAgICd3aW5kb3dzLTEyNTYnLCAnd2luZG93cy0xMjU3JywgJ3dpbmRvd3MtMTI1OCcsICd4LW1hYy1jeXJpbGxpYycKICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciBlbmNvZGluZyA9IG5hbWVfdG9fZW5jb2RpbmdbbmFtZV07CiAgICAgIHZhciBpbmRleCA9IGluZGV4ZXNbbmFtZV07CiAgICAgIGVuY29kaW5nLmdldERlY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaW5nbGVCeXRlRGVjb2RlcihpbmRleCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIGVuY29kaW5nLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaW5nbGVCeXRlRW5jb2RlcihpbmRleCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICB9KTsKICB9KCkpOwoKICAvLwogIC8vIDkuIExlZ2FjeSBtdWx0aS1ieXRlIENoaW5lc2UgKHNpbXBsaWZpZWQpIGVuY29kaW5ncwogIC8vCgogIC8vIDkuMSBnYmsKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtib29sZWFufSBnYjE4MDMwIFRydWUgaWYgZGVjb2RpbmcgZ2IxODAzMCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIEdCS0RlY29kZXIoZ2IxODAzMCwgb3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIHZhciAvKiogQHR5cGUge251bWJlcn0gKi8gZ2JrX2ZpcnN0ID0gMHgwMCwKICAgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gZ2JrX3NlY29uZCA9IDB4MDAsCiAgICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIGdia190aGlyZCA9IDB4MDA7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RyZWFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICB2YXIgYml0ZSA9IGJ5dGVfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIGdia19maXJzdCA9PT0gMHgwMCAmJgogICAgICAgICAgZ2JrX3NlY29uZCA9PT0gMHgwMCAmJiBnYmtfdGhpcmQgPT09IDB4MDApIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmCiAgICAgICAgICAoZ2JrX2ZpcnN0ICE9PSAweDAwIHx8IGdia19zZWNvbmQgIT09IDB4MDAgfHwgZ2JrX3RoaXJkICE9PSAweDAwKSkgewogICAgICAgIGdia19maXJzdCA9IDB4MDA7CiAgICAgICAgZ2JrX3NlY29uZCA9IDB4MDA7CiAgICAgICAgZ2JrX3RoaXJkID0gMHgwMDsKICAgICAgICBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICB9CiAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIHZhciBjb2RlX3BvaW50OwogICAgICBpZiAoZ2JrX3RoaXJkICE9PSAweDAwKSB7CiAgICAgICAgY29kZV9wb2ludCA9IG51bGw7CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgzMCwgMHgzOSkpIHsKICAgICAgICAgIGNvZGVfcG9pbnQgPSBpbmRleEdCMTgwMzBDb2RlUG9pbnRGb3IoCiAgICAgICAgICAgICAgKCgoZ2JrX2ZpcnN0IC0gMHg4MSkgKiAxMCArIChnYmtfc2Vjb25kIC0gMHgzMCkpICogMTI2ICsKICAgICAgICAgICAgICAgKGdia190aGlyZCAtIDB4ODEpKSAqIDEwICsgYml0ZSAtIDB4MzApOwogICAgICAgIH0KICAgICAgICBnYmtfZmlyc3QgPSAweDAwOwogICAgICAgIGdia19zZWNvbmQgPSAweDAwOwogICAgICAgIGdia190aGlyZCA9IDB4MDA7CiAgICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTMpOwogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICB9CiAgICAgIGlmIChnYmtfc2Vjb25kICE9PSAweDAwKSB7CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHg4MSwgMHhGRSkpIHsKICAgICAgICAgIGdia190aGlyZCA9IGJpdGU7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMik7CiAgICAgICAgZ2JrX2ZpcnN0ID0gMHgwMDsKICAgICAgICBnYmtfc2Vjb25kID0gMHgwMDsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBpZiAoZ2JrX2ZpcnN0ICE9PSAweDAwKSB7CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgzMCwgMHgzOSkgJiYgZ2IxODAzMCkgewogICAgICAgICAgZ2JrX3NlY29uZCA9IGJpdGU7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGxlYWQgPSBnYmtfZmlyc3Q7CiAgICAgICAgdmFyIHBvaW50ZXIgPSBudWxsOwogICAgICAgIGdia19maXJzdCA9IDB4MDA7CiAgICAgICAgdmFyIG9mZnNldCA9IGJpdGUgPCAweDdGID8gMHg0MCA6IDB4NDE7CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHg0MCwgMHg3RSkgfHwgaW5SYW5nZShiaXRlLCAweDgwLCAweEZFKSkgewogICAgICAgICAgcG9pbnRlciA9IChsZWFkIC0gMHg4MSkgKiAxOTAgKyAoYml0ZSAtIG9mZnNldCk7CiAgICAgICAgfQogICAgICAgIGNvZGVfcG9pbnQgPSBwb2ludGVyID09PSBudWxsID8gbnVsbCA6CiAgICAgICAgICAgIGluZGV4Q29kZVBvaW50Rm9yKHBvaW50ZXIsIGluZGV4ZXNbJ2diayddKTsKICAgICAgICBpZiAocG9pbnRlciA9PT0gbnVsbCkgewogICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgfQogICAgICAgIGlmIChjb2RlX3BvaW50ID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgwMCwgMHg3RikpIHsKICAgICAgICByZXR1cm4gYml0ZTsKICAgICAgfQogICAgICBpZiAoYml0ZSA9PT0gMHg4MCkgewogICAgICAgIHJldHVybiAweDIwQUM7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHg4MSwgMHhGRSkpIHsKICAgICAgICBnYmtfZmlyc3QgPSBiaXRlOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgfTsKICB9CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gZ2IxODAzMCBUcnVlIGlmIGRlY29kaW5nIGdiMTgwMzAsIGZhbHNlIG90aGVyd2lzZS4KICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBHQktFbmNvZGVyKGdiMTgwMzAsIG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZU91dHB1dFN0cmVhbX0gb3V0cHV0X2J5dGVfc3RyZWFtIE91dHB1dCBieXRlIHN0cmVhbS4KICAgICAqIEBwYXJhbSB7Q29kZVBvaW50SW5wdXRTdHJlYW19IGNvZGVfcG9pbnRfcG9pbnRlciBJbnB1dCBzdHJlYW0uCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsYXN0IGJ5dGUgZW1pdHRlZC4KICAgICAqLwogICAgdGhpcy5lbmNvZGUgPSBmdW5jdGlvbihvdXRwdXRfYnl0ZV9zdHJlYW0sIGNvZGVfcG9pbnRfcG9pbnRlcikgewogICAgICB2YXIgY29kZV9wb2ludCA9IGNvZGVfcG9pbnRfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IEVPRl9jb2RlX3BvaW50KSB7CiAgICAgICAgcmV0dXJuIEVPRl9ieXRlOwogICAgICB9CiAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgcG9pbnRlciA9IGluZGV4UG9pbnRlckZvcihjb2RlX3BvaW50LCBpbmRleGVzWydnYmsnXSk7CiAgICAgIGlmIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgdmFyIGxlYWQgPSBkaXYocG9pbnRlciwgMTkwKSArIDB4ODE7CiAgICAgICAgdmFyIHRyYWlsID0gcG9pbnRlciAlIDE5MDsKICAgICAgICB2YXIgb2Zmc2V0ID0gdHJhaWwgPCAweDNGID8gMHg0MCA6IDB4NDE7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KGxlYWQsIHRyYWlsICsgb2Zmc2V0KTsKICAgICAgfQogICAgICBpZiAocG9pbnRlciA9PT0gbnVsbCAmJiAhZ2IxODAzMCkgewogICAgICAgIHJldHVybiBlbmNvZGVyRXJyb3IoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgcG9pbnRlciA9IGluZGV4R0IxODAzMFBvaW50ZXJGb3IoY29kZV9wb2ludCk7CiAgICAgIHZhciBieXRlMSA9IGRpdihkaXYoZGl2KHBvaW50ZXIsIDEwKSwgMTI2KSwgMTApOwogICAgICBwb2ludGVyID0gcG9pbnRlciAtIGJ5dGUxICogMTAgKiAxMjYgKiAxMDsKICAgICAgdmFyIGJ5dGUyID0gZGl2KGRpdihwb2ludGVyLCAxMCksIDEyNik7CiAgICAgIHBvaW50ZXIgPSBwb2ludGVyIC0gYnl0ZTIgKiAxMCAqIDEyNjsKICAgICAgdmFyIGJ5dGUzID0gZGl2KHBvaW50ZXIsIDEwKTsKICAgICAgdmFyIGJ5dGU0ID0gcG9pbnRlciAtIGJ5dGUzICogMTA7CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChieXRlMSArIDB4ODEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlMiArIDB4MzAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlMyArIDB4ODEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlNCArIDB4MzApOwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ2diayddLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IEdCS0VuY29kZXIoZmFsc2UsIG9wdGlvbnMpOwogIH07CiAgbmFtZV90b19lbmNvZGluZ1snZ2JrJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgR0JLRGVjb2RlcihmYWxzZSwgb3B0aW9ucyk7CiAgfTsKCiAgLy8gOS4yIGdiMTgwMzAKICBuYW1lX3RvX2VuY29kaW5nWydnYjE4MDMwJ10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgR0JLRW5jb2Rlcih0cnVlLCBvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ2diMTgwMzAnXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBHQktEZWNvZGVyKHRydWUsIG9wdGlvbnMpOwogIH07CgogIC8vIDkuMyBoei1nYi0yMzEyCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIEhaR0IyMzEyRGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgdmFyIC8qKiBAdHlwZSB7Ym9vbGVhbn0gKi8gaHpnYjIzMTIgPSBmYWxzZSwKICAgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gaHpnYjIzMTJfbGVhZCA9IDB4MDA7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RyZWFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICB2YXIgYml0ZSA9IGJ5dGVfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIGh6Z2IyMzEyX2xlYWQgPT09IDB4MDApIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIGh6Z2IyMzEyX2xlYWQgIT09IDB4MDApIHsKICAgICAgICBoemdiMjMxMl9sZWFkID0gMHgwMDsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoaHpnYjIzMTJfbGVhZCA9PT0gMHg3RSkgewogICAgICAgIGh6Z2IyMzEyX2xlYWQgPSAweDAwOwogICAgICAgIGlmIChiaXRlID09PSAweDdCKSB7CiAgICAgICAgICBoemdiMjMxMiA9IHRydWU7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKGJpdGUgPT09IDB4N0QpIHsKICAgICAgICAgIGh6Z2IyMzEyID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKGJpdGUgPT09IDB4N0UpIHsKICAgICAgICAgIHJldHVybiAweDAwN0U7CiAgICAgICAgfQogICAgICAgIGlmIChiaXRlID09PSAweDBBKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgICAgaWYgKGh6Z2IyMzEyX2xlYWQgIT09IDB4MDApIHsKICAgICAgICB2YXIgbGVhZCA9IGh6Z2IyMzEyX2xlYWQ7CiAgICAgICAgaHpnYjIzMTJfbGVhZCA9IDB4MDA7CiAgICAgICAgdmFyIGNvZGVfcG9pbnQgPSBudWxsOwogICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MjEsIDB4N0UpKSB7CiAgICAgICAgICBjb2RlX3BvaW50ID0gaW5kZXhDb2RlUG9pbnRGb3IoKGxlYWQgLSAxKSAqIDE5MCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGJpdGUgKyAweDNGKSwgaW5kZXhlc1snZ2JrJ10pOwogICAgICAgIH0KICAgICAgICBpZiAoYml0ZSA9PT0gMHgwQSkgewogICAgICAgICAgaHpnYjIzMTIgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29kZV9wb2ludDsKICAgICAgfQogICAgICBpZiAoYml0ZSA9PT0gMHg3RSkgewogICAgICAgIGh6Z2IyMzEyX2xlYWQgPSAweDdFOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmIChoemdiMjMxMikgewogICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MjAsIDB4N0YpKSB7CiAgICAgICAgICBoemdiMjMxMl9sZWFkID0gYml0ZTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAoYml0ZSA9PT0gMHgwQSkgewogICAgICAgICAgaHpnYjIzMTIgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgwMCwgMHg3RikpIHsKICAgICAgICByZXR1cm4gYml0ZTsKICAgICAgfQogICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBIWkdCMjMxMkVuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIHZhciBoemdiMjMxMiA9IGZhbHNlOwogICAgLyoqCiAgICAgKiBAcGFyYW0ge0J5dGVPdXRwdXRTdHJlYW19IG91dHB1dF9ieXRlX3N0cmVhbSBPdXRwdXQgYnl0ZSBzdHJlYW0uCiAgICAgKiBAcGFyYW0ge0NvZGVQb2ludElucHV0U3RyZWFtfSBjb2RlX3BvaW50X3BvaW50ZXIgSW5wdXQgc3RyZWFtLgogICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFzdCBieXRlIGVtaXR0ZWQuCiAgICAgKi8KICAgIHRoaXMuZW5jb2RlID0gZnVuY3Rpb24ob3V0cHV0X2J5dGVfc3RyZWFtLCBjb2RlX3BvaW50X3BvaW50ZXIpIHsKICAgICAgdmFyIGNvZGVfcG9pbnQgPSBjb2RlX3BvaW50X3BvaW50ZXIuZ2V0KCk7CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSBFT0ZfY29kZV9wb2ludCkgewogICAgICAgIHJldHVybiBFT0ZfYnl0ZTsKICAgICAgfQogICAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3RikgJiYgaHpnYjIzMTIpIHsKICAgICAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KC0xKTsKICAgICAgICBoemdiMjMxMiA9IGZhbHNlOwogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDdFLCAweDdEKTsKICAgICAgfQogICAgICBpZiAoY29kZV9wb2ludCA9PT0gMHgwMDdFKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4N0UsIDB4N0UpOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICBpZiAoIWh6Z2IyMzEyKSB7CiAgICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgaHpnYjIzMTIgPSB0cnVlOwogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDdFLCAweDdCKTsKICAgICAgfQogICAgICB2YXIgcG9pbnRlciA9IGluZGV4UG9pbnRlckZvcihjb2RlX3BvaW50LCBpbmRleGVzWydnYmsnXSk7CiAgICAgIGlmIChwb2ludGVyID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgbGVhZCA9IGRpdihwb2ludGVyLCAxOTApICsgMTsKICAgICAgdmFyIHRyYWlsID0gcG9pbnRlciAlIDE5MCAtIDB4M0Y7CiAgICAgIGlmICghaW5SYW5nZShsZWFkLCAweDIxLCAweDdFKSB8fCAhaW5SYW5nZSh0cmFpbCwgMHgyMSwgMHg3RSkpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkLCB0cmFpbCk7CiAgICB9OwogIH0KCiAgbmFtZV90b19lbmNvZGluZ1snaHotZ2ItMjMxMiddLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IEhaR0IyMzEyRW5jb2RlcihvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ2h6LWdiLTIzMTInXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBIWkdCMjMxMkRlY29kZXIob3B0aW9ucyk7CiAgfTsKCiAgLy8KICAvLyAxMC4gTGVnYWN5IG11bHRpLWJ5dGUgQ2hpbmVzZSAodHJhZGl0aW9uYWwpIGVuY29kaW5ncwogIC8vCgogIC8vIDEwLjEgYmlnNQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBCaWc1RGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBiaWc1X2xlYWQgPSAweDAwLAogICAgICAgIC8qKiBAdHlwZSB7P251bWJlcn0gKi8gYmlnNV9wZW5kaW5nID0gbnVsbDsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RlcmFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICAvLyBOT1RFOiBIYWNrIHRvIHN1cHBvcnQgZW1pdHRpbmcgdHdvIGNvZGUgcG9pbnRzCiAgICAgIGlmIChiaWc1X3BlbmRpbmcgIT09IG51bGwpIHsKICAgICAgICB2YXIgcGVuZGluZyA9IGJpZzVfcGVuZGluZzsKICAgICAgICBiaWc1X3BlbmRpbmcgPSBudWxsOwogICAgICAgIHJldHVybiBwZW5kaW5nOwogICAgICB9CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUgJiYgYmlnNV9sZWFkID09PSAweDAwKSB7CiAgICAgICAgcmV0dXJuIEVPRl9jb2RlX3BvaW50OwogICAgICB9CiAgICAgIGlmIChiaXRlID09PSBFT0ZfYnl0ZSAmJiBiaWc1X2xlYWQgIT09IDB4MDApIHsKICAgICAgICBiaWc1X2xlYWQgPSAweDAwOwogICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICB9CiAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChiaWc1X2xlYWQgIT09IDB4MDApIHsKICAgICAgICB2YXIgbGVhZCA9IGJpZzVfbGVhZDsKICAgICAgICB2YXIgcG9pbnRlciA9IG51bGw7CiAgICAgICAgYmlnNV9sZWFkID0gMHgwMDsKICAgICAgICB2YXIgb2Zmc2V0ID0gYml0ZSA8IDB4N0YgPyAweDQwIDogMHg2MjsKICAgICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDQwLCAweDdFKSB8fCBpblJhbmdlKGJpdGUsIDB4QTEsIDB4RkUpKSB7CiAgICAgICAgICBwb2ludGVyID0gKGxlYWQgLSAweDgxKSAqIDE1NyArIChiaXRlIC0gb2Zmc2V0KTsKICAgICAgICB9CiAgICAgICAgaWYgKHBvaW50ZXIgPT09IDExMzMpIHsKICAgICAgICAgIGJpZzVfcGVuZGluZyA9IDB4MDMwNDsKICAgICAgICAgIHJldHVybiAweDAwQ0E7CiAgICAgICAgfQogICAgICAgIGlmIChwb2ludGVyID09PSAxMTM1KSB7CiAgICAgICAgICBiaWc1X3BlbmRpbmcgPSAweDAzMEM7CiAgICAgICAgICByZXR1cm4gMHgwMENBOwogICAgICAgIH0KICAgICAgICBpZiAocG9pbnRlciA9PT0gMTE2NCkgewogICAgICAgICAgYmlnNV9wZW5kaW5nID0gMHgwMzA0OwogICAgICAgICAgcmV0dXJuIDB4MDBFQTsKICAgICAgICB9CiAgICAgICAgaWYgKHBvaW50ZXIgPT09IDExNjYpIHsKICAgICAgICAgIGJpZzVfcGVuZGluZyA9IDB4MDMwQzsKICAgICAgICAgIHJldHVybiAweDAwRUE7CiAgICAgICAgfQogICAgICAgIHZhciBjb2RlX3BvaW50ID0gKHBvaW50ZXIgPT09IG51bGwpID8gbnVsbCA6CiAgICAgICAgICAgIGluZGV4Q29kZVBvaW50Rm9yKHBvaW50ZXIsIGluZGV4ZXNbJ2JpZzUnXSk7CiAgICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIH0KICAgICAgICBpZiAoY29kZV9wb2ludCA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgcmV0dXJuIGJpdGU7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHg4MSwgMHhGRSkpIHsKICAgICAgICBiaWc1X2xlYWQgPSBiaXRlOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgfTsKICB9CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIEJpZzVFbmNvZGVyKG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZU91dHB1dFN0cmVhbX0gb3V0cHV0X2J5dGVfc3RyZWFtIE91dHB1dCBieXRlIHN0cmVhbS4KICAgICAqIEBwYXJhbSB7Q29kZVBvaW50SW5wdXRTdHJlYW19IGNvZGVfcG9pbnRfcG9pbnRlciBJbnB1dCBzdHJlYW0uCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsYXN0IGJ5dGUgZW1pdHRlZC4KICAgICAqLwogICAgdGhpcy5lbmNvZGUgPSBmdW5jdGlvbihvdXRwdXRfYnl0ZV9zdHJlYW0sIGNvZGVfcG9pbnRfcG9pbnRlcikgewogICAgICB2YXIgY29kZV9wb2ludCA9IGNvZGVfcG9pbnRfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IEVPRl9jb2RlX3BvaW50KSB7CiAgICAgICAgcmV0dXJuIEVPRl9ieXRlOwogICAgICB9CiAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgcG9pbnRlciA9IGluZGV4UG9pbnRlckZvcihjb2RlX3BvaW50LCBpbmRleGVzWydiaWc1J10pOwogICAgICBpZiAocG9pbnRlciA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBlbmNvZGVyRXJyb3IoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgdmFyIGxlYWQgPSBkaXYocG9pbnRlciwgMTU3KSArIDB4ODE7CiAgICAgIC8vaWYgKGxlYWQgPCAweEExKSB7CiAgICAgIC8vICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICAvL30KICAgICAgdmFyIHRyYWlsID0gcG9pbnRlciAlIDE1NzsKICAgICAgdmFyIG9mZnNldCA9IHRyYWlsIDwgMHgzRiA/IDB4NDAgOiAweDYyOwogICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQobGVhZCwgdHJhaWwgKyBvZmZzZXQpOwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ2JpZzUnXS5nZXRFbmNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBCaWc1RW5jb2RlcihvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ2JpZzUnXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBCaWc1RGVjb2RlcihvcHRpb25zKTsKICB9OwoKCiAgLy8KICAvLyAxMS4gTGVnYWN5IG11bHRpLWJ5dGUgSmFwYW5lc2UgZW5jb2RpbmdzCiAgLy8KCiAgLy8gMTEuMSBldWMuanAKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gRVVDSlBEZWNvZGVyKG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICB2YXIgLyoqIEB0eXBlIHtudW1iZXJ9ICovIGV1Y2pwX2ZpcnN0ID0gMHgwMCwKICAgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gZXVjanBfc2Vjb25kID0gMHgwMDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICBpZiAoZXVjanBfZmlyc3QgPT09IDB4MDAgJiYgZXVjanBfc2Vjb25kID09PSAweDAwKSB7CiAgICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgICAgfQogICAgICAgIGV1Y2pwX2ZpcnN0ID0gMHgwMDsKICAgICAgICBldWNqcF9zZWNvbmQgPSAweDAwOwogICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICB9CiAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CgogICAgICB2YXIgbGVhZCwgY29kZV9wb2ludDsKICAgICAgaWYgKGV1Y2pwX3NlY29uZCAhPT0gMHgwMCkgewogICAgICAgIGxlYWQgPSBldWNqcF9zZWNvbmQ7CiAgICAgICAgZXVjanBfc2Vjb25kID0gMHgwMDsKICAgICAgICBjb2RlX3BvaW50ID0gbnVsbDsKICAgICAgICBpZiAoaW5SYW5nZShsZWFkLCAweEExLCAweEZFKSAmJiBpblJhbmdlKGJpdGUsIDB4QTEsIDB4RkUpKSB7CiAgICAgICAgICBjb2RlX3BvaW50ID0gaW5kZXhDb2RlUG9pbnRGb3IoKGxlYWQgLSAweEExKSAqIDk0ICsgYml0ZSAtIDB4QTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhlc1snamlzMDIxMiddKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpblJhbmdlKGJpdGUsIDB4QTEsIDB4RkUpKSB7CiAgICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0xKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29kZV9wb2ludDsKICAgICAgfQogICAgICBpZiAoZXVjanBfZmlyc3QgPT09IDB4OEUgJiYgaW5SYW5nZShiaXRlLCAweEExLCAweERGKSkgewogICAgICAgIGV1Y2pwX2ZpcnN0ID0gMHgwMDsKICAgICAgICByZXR1cm4gMHhGRjYxICsgYml0ZSAtIDB4QTE7CiAgICAgIH0KICAgICAgaWYgKGV1Y2pwX2ZpcnN0ID09PSAweDhGICYmIGluUmFuZ2UoYml0ZSwgMHhBMSwgMHhGRSkpIHsKICAgICAgICBldWNqcF9maXJzdCA9IDB4MDA7CiAgICAgICAgZXVjanBfc2Vjb25kID0gYml0ZTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAoZXVjanBfZmlyc3QgIT09IDB4MDApIHsKICAgICAgICBsZWFkID0gZXVjanBfZmlyc3Q7CiAgICAgICAgZXVjanBfZmlyc3QgPSAweDAwOwogICAgICAgIGNvZGVfcG9pbnQgPSBudWxsOwogICAgICAgIGlmIChpblJhbmdlKGxlYWQsIDB4QTEsIDB4RkUpICYmIGluUmFuZ2UoYml0ZSwgMHhBMSwgMHhGRSkpIHsKICAgICAgICAgIGNvZGVfcG9pbnQgPSBpbmRleENvZGVQb2ludEZvcigobGVhZCAtIDB4QTEpICogOTQgKyBiaXRlIC0gMHhBMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleGVzWydqaXMwMjA4J10pOwogICAgICAgIH0KICAgICAgICBpZiAoIWluUmFuZ2UoYml0ZSwgMHhBMSwgMHhGRSkpIHsKICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIH0KICAgICAgICBpZiAoY29kZV9wb2ludCA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgcmV0dXJuIGJpdGU7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IDB4OEUgfHwgYml0ZSA9PT0gMHg4RiB8fCAoaW5SYW5nZShiaXRlLCAweEExLCAweEZFKSkpIHsKICAgICAgICBldWNqcF9maXJzdCA9IGJpdGU7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gRVVDSlBFbmNvZGVyKG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZU91dHB1dFN0cmVhbX0gb3V0cHV0X2J5dGVfc3RyZWFtIE91dHB1dCBieXRlIHN0cmVhbS4KICAgICAqIEBwYXJhbSB7Q29kZVBvaW50SW5wdXRTdHJlYW19IGNvZGVfcG9pbnRfcG9pbnRlciBJbnB1dCBzdHJlYW0uCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsYXN0IGJ5dGUgZW1pdHRlZC4KICAgICAqLwogICAgdGhpcy5lbmNvZGUgPSBmdW5jdGlvbihvdXRwdXRfYnl0ZV9zdHJlYW0sIGNvZGVfcG9pbnRfcG9pbnRlcikgewogICAgICB2YXIgY29kZV9wb2ludCA9IGNvZGVfcG9pbnRfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IEVPRl9jb2RlX3BvaW50KSB7CiAgICAgICAgcmV0dXJuIEVPRl9ieXRlOwogICAgICB9CiAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICBpZiAoY29kZV9wb2ludCA9PT0gMHgwMEE1KSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4NUMpOwogICAgICB9CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSAweDIwM0UpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoMHg3RSk7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhGRjYxLCAweEZGOUYpKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4OEUsIGNvZGVfcG9pbnQgLSAweEZGNjEgKyAweEExKTsKICAgICAgfQoKICAgICAgdmFyIHBvaW50ZXIgPSBpbmRleFBvaW50ZXJGb3IoY29kZV9wb2ludCwgaW5kZXhlc1snamlzMDIwOCddKTsKICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHZhciBsZWFkID0gZGl2KHBvaW50ZXIsIDk0KSArIDB4QTE7CiAgICAgIHZhciB0cmFpbCA9IHBvaW50ZXIgJSA5NCArIDB4QTE7CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkLCB0cmFpbCk7CiAgICB9OwogIH0KCiAgbmFtZV90b19lbmNvZGluZ1snZXVjLWpwJ10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRVVDSlBFbmNvZGVyKG9wdGlvbnMpOwogIH07CiAgbmFtZV90b19lbmNvZGluZ1snZXVjLWpwJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRVVDSlBEZWNvZGVyKG9wdGlvbnMpOwogIH07CgogIC8vIDExLjIgaXNvLTIwMjItanAKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gSVNPMjAyMkpQRGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgLyoqIEBlbnVtICovCiAgICB2YXIgc3RhdGUgPSB7CiAgICAgIEFTQ0lJOiAwLAogICAgICBlc2NhcGVfc3RhcnQ6IDEsCiAgICAgIGVzY2FwZV9taWRkbGU6IDIsCiAgICAgIGVzY2FwZV9maW5hbDogMywKICAgICAgbGVhZDogNCwKICAgICAgdHJhaWw6IDUsCiAgICAgIEthdGFrYW5hOiA2CiAgICB9OwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5BU0NJSSwKICAgICAgICAvKiogQHR5cGUge2Jvb2xlYW59ICovIGlzbzIwMjJqcF9qaXMwMjEyID0gZmFsc2UsCiAgICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIGlzbzIwMjJqcF9sZWFkID0gMHgwMDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSAhPT0gRU9GX2J5dGUpIHsKICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICB9CiAgICAgIHN3aXRjaCAoaXNvMjAyMmpwX3N0YXRlKSB7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICBjYXNlIHN0YXRlLkFTQ0lJOgogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MUIpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuZXNjYXBlX3N0YXJ0OwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgICAgIHJldHVybiBiaXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIHJldHVybiBFT0ZfY29kZV9wb2ludDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwoKICAgICAgICBjYXNlIHN0YXRlLmVzY2FwZV9zdGFydDoKICAgICAgICAgIGlmIChiaXRlID09PSAweDI0IHx8IGJpdGUgPT09IDB4MjgpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX2xlYWQgPSBiaXRlOwogICAgICAgICAgICBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5lc2NhcGVfbWlkZGxlOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlICE9PSBFT0ZfYnl0ZSkgewogICAgICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0xKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CgogICAgICAgIGNhc2Ugc3RhdGUuZXNjYXBlX21pZGRsZToKICAgICAgICAgIHZhciBsZWFkID0gaXNvMjAyMmpwX2xlYWQ7CiAgICAgICAgICBpc28yMDIyanBfbGVhZCA9IDB4MDA7CiAgICAgICAgICBpZiAobGVhZCA9PT0gMHgyNCAmJiAoYml0ZSA9PT0gMHg0MCB8fCBiaXRlID09PSAweDQyKSkgewogICAgICAgICAgICBpc28yMDIyanBfamlzMDIxMiA9IGZhbHNlOwogICAgICAgICAgICBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5sZWFkOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsZWFkID09PSAweDI0ICYmIGJpdGUgPT09IDB4MjgpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuZXNjYXBlX2ZpbmFsOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsZWFkID09PSAweDI4ICYmIChiaXRlID09PSAweDQyIHx8IGJpdGUgPT09IDB4NEEpKSB7CiAgICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsZWFkID09PSAweDI4ICYmIGJpdGUgPT09IDB4NDkpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuS2F0YWthbmE7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMik7CiAgICAgICAgICB9CiAgICAgICAgICBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwoKICAgICAgICBjYXNlIHN0YXRlLmVzY2FwZV9maW5hbDoKICAgICAgICAgIGlmIChiaXRlID09PSAweDQ0KSB7CiAgICAgICAgICAgIGlzbzIwMjJqcF9qaXMwMjEyID0gdHJ1ZTsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUubGVhZDsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0zKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CgogICAgICAgIGNhc2Ugc3RhdGUubGVhZDoKICAgICAgICAgIGlmIChiaXRlID09PSAweDBBKSB7CiAgICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsLCAweDAwMEEpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MUIpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuZXNjYXBlX3N0YXJ0OwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlID09PSBFT0ZfYnl0ZSkgewogICAgICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpc28yMDIyanBfbGVhZCA9IGJpdGU7CiAgICAgICAgICBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS50cmFpbDsKICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICBjYXNlIHN0YXRlLnRyYWlsOgogICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUubGVhZDsKICAgICAgICAgIGlmIChiaXRlID09PSBFT0ZfYnl0ZSkgewogICAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb2RlX3BvaW50ID0gbnVsbDsKICAgICAgICAgIHZhciBwb2ludGVyID0gKGlzbzIwMjJqcF9sZWFkIC0gMHgyMSkgKiA5NCArIGJpdGUgLSAweDIxOwogICAgICAgICAgaWYgKGluUmFuZ2UoaXNvMjAyMmpwX2xlYWQsIDB4MjEsIDB4N0UpICYmCiAgICAgICAgICAgICAgaW5SYW5nZShiaXRlLCAweDIxLCAweDdFKSkgewogICAgICAgICAgICBjb2RlX3BvaW50ID0gKGlzbzIwMjJqcF9qaXMwMjEyID09PSBmYWxzZSkgPwogICAgICAgICAgICAgICAgaW5kZXhDb2RlUG9pbnRGb3IocG9pbnRlciwgaW5kZXhlc1snamlzMDIwOCddKSA6CiAgICAgICAgICAgICAgICBpbmRleENvZGVQb2ludEZvcihwb2ludGVyLCBpbmRleGVzWydqaXMwMjEyJ10pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29kZV9wb2ludDsKCiAgICAgICAgY2FzZSBzdGF0ZS5LYXRha2FuYToKICAgICAgICAgIGlmIChiaXRlID09PSAweDFCKSB7CiAgICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLmVzY2FwZV9zdGFydDsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDIxLCAweDVGKSkgewogICAgICAgICAgICByZXR1cm4gMHhGRjYxICsgYml0ZSAtIDB4MjE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICAgICAgcmV0dXJuIEVPRl9jb2RlX3BvaW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBJU08yMDIySlBFbmNvZGVyKG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICAvKiogQGVudW0gKi8KICAgIHZhciBzdGF0ZSA9IHsKICAgICAgQVNDSUk6IDAsCiAgICAgIGxlYWQ6IDEsCiAgICAgIEthdGFrYW5hOiAyCiAgICB9OwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSB8fAogICAgICAgICAgIGNvZGVfcG9pbnQgPT09IDB4MDBBNSB8fCBjb2RlX3BvaW50ID09PSAweDIwM0UpICYmCiAgICAgICAgICBpc28yMDIyanBfc3RhdGUgIT09IHN0YXRlLkFTQ0lJKSB7CiAgICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuQVNDSUk7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MUIsIDB4MjgsIDB4NDIpOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICBpZiAoY29kZV9wb2ludCA9PT0gMHgwMEE1KSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4NUMpOwogICAgICB9CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSAweDIwM0UpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoMHg3RSk7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhGRjYxLCAweEZGOUYpICYmCiAgICAgICAgICBpc28yMDIyanBfc3RhdGUgIT09IHN0YXRlLkthdGFrYW5hKSB7CiAgICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuS2F0YWthbmE7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MUIsIDB4MjgsIDB4NDkpOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4RkY2MSwgMHhGRjlGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50IC0gMHhGRjYxIC0gMHgyMSk7CiAgICAgIH0KICAgICAgaWYgKGlzbzIwMjJqcF9zdGF0ZSAhPT0gc3RhdGUubGVhZCkgewogICAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLmxlYWQ7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MUIsIDB4MjQsIDB4NDIpOwogICAgICB9CiAgICAgIHZhciBwb2ludGVyID0gaW5kZXhQb2ludGVyRm9yKGNvZGVfcG9pbnQsIGluZGV4ZXNbJ2ppczAyMDgnXSk7CiAgICAgIGlmIChwb2ludGVyID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgbGVhZCA9IGRpdihwb2ludGVyLCA5NCkgKyAweDIxOwogICAgICB2YXIgdHJhaWwgPSBwb2ludGVyICUgOTQgKyAweDIxOwogICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQobGVhZCwgdHJhaWwpOwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ2lzby0yMDIyLWpwJ10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgSVNPMjAyMkpQRW5jb2RlcihvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ2lzby0yMDIyLWpwJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgSVNPMjAyMkpQRGVjb2RlcihvcHRpb25zKTsKICB9OwoKICAvLyAxMS4zIHNoaWZ0X2ppcwoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBTaGlmdEpJU0RlY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIHZhciAvKiogQHR5cGUge251bWJlcn0gKi8gc2hpZnRqaXNfbGVhZCA9IDB4MDA7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RyZWFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICB2YXIgYml0ZSA9IGJ5dGVfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIHNoaWZ0amlzX2xlYWQgPT09IDB4MDApIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIHNoaWZ0amlzX2xlYWQgIT09IDB4MDApIHsKICAgICAgICBzaGlmdGppc19sZWFkID0gMHgwMDsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoc2hpZnRqaXNfbGVhZCAhPT0gMHgwMCkgewogICAgICAgIHZhciBsZWFkID0gc2hpZnRqaXNfbGVhZDsKICAgICAgICBzaGlmdGppc19sZWFkID0gMHgwMDsKICAgICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDQwLCAweDdFKSB8fCBpblJhbmdlKGJpdGUsIDB4ODAsIDB4RkMpKSB7CiAgICAgICAgICB2YXIgb2Zmc2V0ID0gKGJpdGUgPCAweDdGKSA/IDB4NDAgOiAweDQxOwogICAgICAgICAgdmFyIGxlYWRfb2Zmc2V0ID0gKGxlYWQgPCAweEEwKSA/IDB4ODEgOiAweEMxOwogICAgICAgICAgdmFyIGNvZGVfcG9pbnQgPSBpbmRleENvZGVQb2ludEZvcigobGVhZCAtIGxlYWRfb2Zmc2V0KSAqIDE4OCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdGUgLSBvZmZzZXQsIGluZGV4ZXNbJ2ppczAyMDgnXSk7CiAgICAgICAgICBpZiAoY29kZV9wb2ludCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICAgIH0KICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0xKTsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDAwLCAweDgwKSkgewogICAgICAgIHJldHVybiBiaXRlOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4QTEsIDB4REYpKSB7CiAgICAgICAgcmV0dXJuIDB4RkY2MSArIGJpdGUgLSAweEExOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4ODEsIDB4OUYpIHx8IGluUmFuZ2UoYml0ZSwgMHhFMCwgMHhGQykpIHsKICAgICAgICBzaGlmdGppc19sZWFkID0gYml0ZTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBTaGlmdEpJU0VuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHgwMDAwLCAweDAwODApKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSAweDAwQTUpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoMHg1Qyk7CiAgICAgIH0KICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IDB4MjAzRSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDdFKTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweEZGNjEsIDB4RkY5RikpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoY29kZV9wb2ludCAtIDB4RkY2MSArIDB4QTEpOwogICAgICB9CiAgICAgIHZhciBwb2ludGVyID0gaW5kZXhQb2ludGVyRm9yKGNvZGVfcG9pbnQsIGluZGV4ZXNbJ2ppczAyMDgnXSk7CiAgICAgIGlmIChwb2ludGVyID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgbGVhZCA9IGRpdihwb2ludGVyLCAxODgpOwogICAgICB2YXIgbGVhZF9vZmZzZXQgPSBsZWFkIDwgMHgxRiA/IDB4ODEgOiAweEMxOwogICAgICB2YXIgdHJhaWwgPSBwb2ludGVyICUgMTg4OwogICAgICB2YXIgb2Zmc2V0ID0gdHJhaWwgPCAweDNGID8gMHg0MCA6IDB4NDE7CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkICsgbGVhZF9vZmZzZXQsIHRyYWlsICsgb2Zmc2V0KTsKICAgIH07CiAgfQoKICBuYW1lX3RvX2VuY29kaW5nWydzaGlmdF9qaXMnXS5nZXRFbmNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBTaGlmdEpJU0VuY29kZXIob3B0aW9ucyk7CiAgfTsKICBuYW1lX3RvX2VuY29kaW5nWydzaGlmdF9qaXMnXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBTaGlmdEpJU0RlY29kZXIob3B0aW9ucyk7CiAgfTsKCiAgLy8KICAvLyAxMi4gTGVnYWN5IG11bHRpLWJ5dGUgS29yZWFuIGVuY29kaW5ncwogIC8vCgogIC8vIDEyLjEgZXVjLWtyCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIEVVQ0tSRGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBldWNrcl9sZWFkID0gMHgwMDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUgJiYgZXVja3JfbGVhZCA9PT0gMCkgewogICAgICAgIHJldHVybiBFT0ZfY29kZV9wb2ludDsKICAgICAgfQogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUgJiYgZXVja3JfbGVhZCAhPT0gMCkgewogICAgICAgIGV1Y2tyX2xlYWQgPSAweDAwOwogICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICB9CiAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChldWNrcl9sZWFkICE9PSAweDAwKSB7CiAgICAgICAgdmFyIGxlYWQgPSBldWNrcl9sZWFkOwogICAgICAgIHZhciBwb2ludGVyID0gbnVsbDsKICAgICAgICBldWNrcl9sZWFkID0gMHgwMDsKCiAgICAgICAgaWYgKGluUmFuZ2UobGVhZCwgMHg4MSwgMHhDNikpIHsKICAgICAgICAgIHZhciB0ZW1wID0gKDI2ICsgMjYgKyAxMjYpICogKGxlYWQgLSAweDgxKTsKICAgICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4NDEsIDB4NUEpKSB7CiAgICAgICAgICAgIHBvaW50ZXIgPSB0ZW1wICsgYml0ZSAtIDB4NDE7CiAgICAgICAgICB9IGVsc2UgaWYgKGluUmFuZ2UoYml0ZSwgMHg2MSwgMHg3QSkpIHsKICAgICAgICAgICAgcG9pbnRlciA9IHRlbXAgKyAyNiArIGJpdGUgLSAweDYxOwogICAgICAgICAgfSBlbHNlIGlmIChpblJhbmdlKGJpdGUsIDB4ODEsIDB4RkUpKSB7CiAgICAgICAgICAgIHBvaW50ZXIgPSB0ZW1wICsgMjYgKyAyNiArIGJpdGUgLSAweDgxOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGluUmFuZ2UobGVhZCwgMHhDNywgMHhGRCkgJiYgaW5SYW5nZShiaXRlLCAweEExLCAweEZFKSkgewogICAgICAgICAgcG9pbnRlciA9ICgyNiArIDI2ICsgMTI2KSAqICgweEM3IC0gMHg4MSkgKyAobGVhZCAtIDB4QzcpICogOTQgKwogICAgICAgICAgICAgIChiaXRlIC0gMHhBMSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgY29kZV9wb2ludCA9IChwb2ludGVyID09PSBudWxsKSA/IG51bGwgOgogICAgICAgICAgICBpbmRleENvZGVQb2ludEZvcihwb2ludGVyLCBpbmRleGVzWydldWMta3InXSk7CiAgICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIH0KICAgICAgICBpZiAoY29kZV9wb2ludCA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICB9CgogICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDAwLCAweDdGKSkgewogICAgICAgIHJldHVybiBiaXRlOwogICAgICB9CgogICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDgxLCAweEZEKSkgewogICAgICAgIGV1Y2tyX2xlYWQgPSBiaXRlOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBFVUNLUkVuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHgwMDAwLCAweDAwN0YpKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHZhciBwb2ludGVyID0gaW5kZXhQb2ludGVyRm9yKGNvZGVfcG9pbnQsIGluZGV4ZXNbJ2V1Yy1rciddKTsKICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHZhciBsZWFkLCB0cmFpbDsKICAgICAgaWYgKHBvaW50ZXIgPCAoKDI2ICsgMjYgKyAxMjYpICogKDB4QzcgLSAweDgxKSkpIHsKICAgICAgICBsZWFkID0gZGl2KHBvaW50ZXIsICgyNiArIDI2ICsgMTI2KSkgKyAweDgxOwogICAgICAgIHRyYWlsID0gcG9pbnRlciAlICgyNiArIDI2ICsgMTI2KTsKICAgICAgICB2YXIgb2Zmc2V0ID0gdHJhaWwgPCAyNiA/IDB4NDEgOiB0cmFpbCA8IDI2ICsgMjYgPyAweDQ3IDogMHg0RDsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQobGVhZCwgdHJhaWwgKyBvZmZzZXQpOwogICAgICB9CiAgICAgIHBvaW50ZXIgPSBwb2ludGVyIC0gKDI2ICsgMjYgKyAxMjYpICogKDB4QzcgLSAweDgxKTsKICAgICAgbGVhZCA9IGRpdihwb2ludGVyLCA5NCkgKyAweEM3OwogICAgICB0cmFpbCA9IHBvaW50ZXIgJSA5NCArIDB4QTE7CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkLCB0cmFpbCk7CiAgICB9OwogIH0KCiAgbmFtZV90b19lbmNvZGluZ1snZXVjLWtyJ10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRVVDS1JFbmNvZGVyKG9wdGlvbnMpOwogIH07CiAgbmFtZV90b19lbmNvZGluZ1snZXVjLWtyJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRVVDS1JEZWNvZGVyKG9wdGlvbnMpOwogIH07CgogIC8vIDEyLjIgaXNvLTIwMjIta3IKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gSVNPMjAyMktSRGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgLyoqIEBlbnVtICovCiAgICB2YXIgc3RhdGUgPSB7CiAgICAgIEFTQ0lJOiAwLAogICAgICBlc2NhcGVfc3RhcnQ6IDEsCiAgICAgIGVzY2FwZV9taWRkbGU6IDIsCiAgICAgIGVzY2FwZV9lbmQ6IDMsCiAgICAgIGxlYWQ6IDQsCiAgICAgIHRyYWlsOiA1CiAgICB9OwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSSwKICAgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gaXNvMjAyMmtyX2xlYWQgPSAweDAwOwogICAgLyoqCiAgICAgKiBAcGFyYW0ge0J5dGVJbnB1dFN0cmVhbX0gYnl0ZV9wb2ludGVyIFRoZSBieXRlIHN0cmVhbSB0byBkZWNvZGUuCiAgICAgKiBAcmV0dXJuIHs/bnVtYmVyfSBUaGUgbmV4dCBjb2RlIHBvaW50IGRlY29kZWQsIG9yIG51bGwgaWYgbm90IGVub3VnaAogICAgICogICAgIGRhdGEgZXhpc3RzIGluIHRoZSBpbnB1dCBzdHJlYW0gdG8gZGVjb2RlIGEgY29tcGxldGUgY29kZSBwb2ludC4KICAgICAqLwogICAgdGhpcy5kZWNvZGUgPSBmdW5jdGlvbihieXRlX3BvaW50ZXIpIHsKICAgICAgdmFyIGJpdGUgPSBieXRlX3BvaW50ZXIuZ2V0KCk7CiAgICAgIGlmIChiaXRlICE9PSBFT0ZfYnl0ZSkgewogICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIH0KICAgICAgc3dpdGNoIChpc28yMDIya3Jfc3RhdGUpIHsKICAgICAgICBkZWZhdWx0OgogICAgICAgIGNhc2Ugc3RhdGUuQVNDSUk6CiAgICAgICAgICBpZiAoYml0ZSA9PT0gMHgwRSkgewogICAgICAgICAgICBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5sZWFkOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlID09PSAweDBGKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MUIpIHsKICAgICAgICAgICAgaXNvMjAyMmtyX3N0YXRlID0gc3RhdGUuZXNjYXBlX3N0YXJ0OwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgICAgIHJldHVybiBiaXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIHJldHVybiBFT0ZfY29kZV9wb2ludDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIGNhc2Ugc3RhdGUuZXNjYXBlX3N0YXJ0OgogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MjQpIHsKICAgICAgICAgICAgaXNvMjAyMmtyX3N0YXRlID0gc3RhdGUuZXNjYXBlX21pZGRsZTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYml0ZSAhPT0gRU9GX2J5dGUpIHsKICAgICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgICB9CiAgICAgICAgICBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIGNhc2Ugc3RhdGUuZXNjYXBlX21pZGRsZToKICAgICAgICAgIGlmIChiaXRlID09PSAweDI5KSB7CiAgICAgICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLmVzY2FwZV9lbmQ7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMik7CiAgICAgICAgICB9CiAgICAgICAgICBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIGNhc2Ugc3RhdGUuZXNjYXBlX2VuZDoKICAgICAgICAgIGlmIChiaXRlID09PSAweDQzKSB7CiAgICAgICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlID09PSBFT0ZfYnl0ZSkgewogICAgICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0yKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTMpOwogICAgICAgICAgfQogICAgICAgICAgaXNvMjAyMmtyX3N0YXRlID0gc3RhdGUuQVNDSUk7CiAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgICBjYXNlIHN0YXRlLmxlYWQ6CiAgICAgICAgICBpZiAoYml0ZSA9PT0gMHgwQSkgewogICAgICAgICAgICBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCwgMHgwMDBBKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlID09PSAweDBFKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MEYpIHsKICAgICAgICAgICAgaXNvMjAyMmtyX3N0YXRlID0gc3RhdGUuQVNDSUk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIHJldHVybiBFT0ZfY29kZV9wb2ludDsKICAgICAgICAgIH0KICAgICAgICAgIGlzbzIwMjJrcl9sZWFkID0gYml0ZTsKICAgICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLnRyYWlsOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgY2FzZSBzdGF0ZS50cmFpbDoKICAgICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLmxlYWQ7CiAgICAgICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29kZV9wb2ludCA9IG51bGw7CiAgICAgICAgICBpZiAoaW5SYW5nZShpc28yMDIya3JfbGVhZCwgMHgyMSwgMHg0NikgJiYKICAgICAgICAgICAgICBpblJhbmdlKGJpdGUsIDB4MjEsIDB4N0UpKSB7CiAgICAgICAgICAgIGNvZGVfcG9pbnQgPSBpbmRleENvZGVQb2ludEZvcigoMjYgKyAyNiArIDEyNikgKgogICAgICAgICAgICAgICAgKGlzbzIwMjJrcl9sZWFkIC0gMSkgKwogICAgICAgICAgICAgICAgMjYgKyAyNiArIGJpdGUgLSAxLAogICAgICAgICAgICAgICAgaW5kZXhlc1snZXVjLWtyJ10pOwogICAgICAgICAgfSBlbHNlIGlmIChpblJhbmdlKGlzbzIwMjJrcl9sZWFkLCAweDQ3LCAweDdFKSAmJgogICAgICAgICAgICAgIGluUmFuZ2UoYml0ZSwgMHgyMSwgMHg3RSkpIHsKICAgICAgICAgICAgY29kZV9wb2ludCA9IGluZGV4Q29kZVBvaW50Rm9yKCgyNiArIDI2ICsgMTI2KSAqICgweEM3IC0gMHg4MSkgKwogICAgICAgICAgICAgICAgKGlzbzIwMjJrcl9sZWFkIC0gMHg0NykgKiA5NCArCiAgICAgICAgICAgICAgICAoYml0ZSAtIDB4MjEpLAogICAgICAgICAgICAgICAgaW5kZXhlc1snZXVjLWtyJ10pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVfcG9pbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgfTsKICB9CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIElTTzIwMjJLUkVuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKiBAZW51bSAqLwogICAgdmFyIHN0YXRlID0gewogICAgICBBU0NJSTogMCwKICAgICAgbGVhZDogMQogICAgfTsKICAgIHZhciAvKiogQHR5cGUge2Jvb2xlYW59ICovIGlzbzIwMjJrcl9pbml0aWFsaXphdGlvbiA9IGZhbHNlLAogICAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgaWYgKCFpc28yMDIya3JfaW5pdGlhbGl6YXRpb24pIHsKICAgICAgICBpc28yMDIya3JfaW5pdGlhbGl6YXRpb24gPSB0cnVlOwogICAgICAgIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MUIsIDB4MjQsIDB4MjksIDB4NDMpOwogICAgICB9CiAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSAmJgogICAgICAgICAgaXNvMjAyMmtyX3N0YXRlICE9PSBzdGF0ZS5BU0NJSSkgewogICAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDBGKTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3RikpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgaWYgKGlzbzIwMjJrcl9zdGF0ZSAhPT0gc3RhdGUubGVhZCkgewogICAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLmxlYWQ7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MEUpOwogICAgICB9CiAgICAgIHZhciBwb2ludGVyID0gaW5kZXhQb2ludGVyRm9yKGNvZGVfcG9pbnQsIGluZGV4ZXNbJ2V1Yy1rciddKTsKICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHZhciBsZWFkLCB0cmFpbDsKICAgICAgaWYgKHBvaW50ZXIgPCAoMjYgKyAyNiArIDEyNikgKiAoMHhDNyAtIDB4ODEpKSB7CiAgICAgICAgbGVhZCA9IGRpdihwb2ludGVyLCAoMjYgKyAyNiArIDEyNikpICsgMTsKICAgICAgICB0cmFpbCA9IHBvaW50ZXIgJSAoMjYgKyAyNiArIDEyNikgLSAyNiAtIDI2ICsgMTsKICAgICAgICBpZiAoIWluUmFuZ2UobGVhZCwgMHgyMSwgMHg0NikgfHwgIWluUmFuZ2UodHJhaWwsIDB4MjEsIDB4N0UpKSB7CiAgICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQobGVhZCwgdHJhaWwpOwogICAgICB9CiAgICAgIHBvaW50ZXIgPSBwb2ludGVyIC0gKDI2ICsgMjYgKyAxMjYpICogKDB4QzcgLSAweDgxKTsKICAgICAgbGVhZCA9IGRpdihwb2ludGVyLCA5NCkgKyAweDQ3OwogICAgICB0cmFpbCA9IHBvaW50ZXIgJSA5NCArIDB4MjE7CiAgICAgIGlmICghaW5SYW5nZShsZWFkLCAweDQ3LCAweDdFKSB8fCAhaW5SYW5nZSh0cmFpbCwgMHgyMSwgMHg3RSkpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkLCB0cmFpbCk7CiAgICB9OwogIH0KCiAgbmFtZV90b19lbmNvZGluZ1snaXNvLTIwMjIta3InXS5nZXRFbmNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBJU08yMDIyS1JFbmNvZGVyKG9wdGlvbnMpOwogIH07CiAgbmFtZV90b19lbmNvZGluZ1snaXNvLTIwMjIta3InXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBJU08yMDIyS1JEZWNvZGVyKG9wdGlvbnMpOwogIH07CgoKICAvLwogIC8vIDEzLiBMZWdhY3kgdXRmLTE2IGVuY29kaW5ncwogIC8vCgogIC8vIDEzLjEgdXRmLTE2CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gdXRmMTZfYmUgVHJ1ZSBpZiBiaWctZW5kaWFuLCBmYWxzZSBpZiBsaXR0bGUtZW5kaWFuLgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIFVURjE2RGVjb2Rlcih1dGYxNl9iZSwgb3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIHZhciAvKiogQHR5cGUgez9udW1iZXJ9ICovIHV0ZjE2X2xlYWRfYnl0ZSA9IG51bGwsCiAgICAgICAgLyoqIEB0eXBlIHs/bnVtYmVyfSAqLyB1dGYxNl9sZWFkX3N1cnJvZ2F0ZSA9IG51bGw7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RyZWFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICB2YXIgYml0ZSA9IGJ5dGVfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIHV0ZjE2X2xlYWRfYnl0ZSA9PT0gbnVsbCAmJgogICAgICAgICAgdXRmMTZfbGVhZF9zdXJyb2dhdGUgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmICh1dGYxNl9sZWFkX2J5dGUgIT09IG51bGwgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dGYxNl9sZWFkX3N1cnJvZ2F0ZSAhPT0gbnVsbCkpIHsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAodXRmMTZfbGVhZF9ieXRlID09PSBudWxsKSB7CiAgICAgICAgdXRmMTZfbGVhZF9ieXRlID0gYml0ZTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICB2YXIgY29kZV9wb2ludDsKICAgICAgaWYgKHV0ZjE2X2JlKSB7CiAgICAgICAgY29kZV9wb2ludCA9ICh1dGYxNl9sZWFkX2J5dGUgPDwgOCkgKyBiaXRlOwogICAgICB9IGVsc2UgewogICAgICAgIGNvZGVfcG9pbnQgPSAoYml0ZSA8PCA4KSArIHV0ZjE2X2xlYWRfYnl0ZTsKICAgICAgfQogICAgICB1dGYxNl9sZWFkX2J5dGUgPSBudWxsOwogICAgICBpZiAodXRmMTZfbGVhZF9zdXJyb2dhdGUgIT09IG51bGwpIHsKICAgICAgICB2YXIgbGVhZF9zdXJyb2dhdGUgPSB1dGYxNl9sZWFkX3N1cnJvZ2F0ZTsKICAgICAgICB1dGYxNl9sZWFkX3N1cnJvZ2F0ZSA9IG51bGw7CiAgICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhEQzAwLCAweERGRkYpKSB7CiAgICAgICAgICByZXR1cm4gMHgxMDAwMCArIChsZWFkX3N1cnJvZ2F0ZSAtIDB4RDgwMCkgKiAweDQwMCArCiAgICAgICAgICAgICAgKGNvZGVfcG9pbnQgLSAweERDMDApOwogICAgICAgIH0KICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0yKTsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweEQ4MDAsIDB4REJGRikpIHsKICAgICAgICB1dGYxNl9sZWFkX3N1cnJvZ2F0ZSA9IGNvZGVfcG9pbnQ7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhEQzAwLCAweERGRkYpKSB7CiAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtib29sZWFufSB1dGYxNl9iZSBUcnVlIGlmIGJpZy1lbmRpYW4sIGZhbHNlIGlmIGxpdHRsZS1lbmRpYW4uCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gVVRGMTZFbmNvZGVyKHV0ZjE2X2JlLCBvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgLyoqCiAgICAgKiBAcGFyYW0ge0J5dGVPdXRwdXRTdHJlYW19IG91dHB1dF9ieXRlX3N0cmVhbSBPdXRwdXQgYnl0ZSBzdHJlYW0uCiAgICAgKiBAcGFyYW0ge0NvZGVQb2ludElucHV0U3RyZWFtfSBjb2RlX3BvaW50X3BvaW50ZXIgSW5wdXQgc3RyZWFtLgogICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFzdCBieXRlIGVtaXR0ZWQuCiAgICAgKi8KICAgIHRoaXMuZW5jb2RlID0gZnVuY3Rpb24ob3V0cHV0X2J5dGVfc3RyZWFtLCBjb2RlX3BvaW50X3BvaW50ZXIpIHsKICAgICAgZnVuY3Rpb24gY29udmVydF90b19ieXRlcyhjb2RlX3VuaXQpIHsKICAgICAgICB2YXIgYnl0ZTEgPSBjb2RlX3VuaXQgPj4gODsKICAgICAgICB2YXIgYnl0ZTIgPSBjb2RlX3VuaXQgJiAweDAwRkY7CiAgICAgICAgaWYgKHV0ZjE2X2JlKSB7CiAgICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoYnl0ZTEsIGJ5dGUyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KGJ5dGUyLCBieXRlMSk7CiAgICAgIH0KICAgICAgdmFyIGNvZGVfcG9pbnQgPSBjb2RlX3BvaW50X3BvaW50ZXIuZ2V0KCk7CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSBFT0ZfY29kZV9wb2ludCkgewogICAgICAgIHJldHVybiBFT0ZfYnl0ZTsKICAgICAgfQogICAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweEQ4MDAsIDB4REZGRikpIHsKICAgICAgICBlbmNvZGVyRXJyb3IoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgaWYgKGNvZGVfcG9pbnQgPD0gMHhGRkZGKSB7CiAgICAgICAgcmV0dXJuIGNvbnZlcnRfdG9fYnl0ZXMoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgdmFyIGxlYWQgPSBkaXYoKGNvZGVfcG9pbnQgLSAweDEwMDAwKSwgMHg0MDApICsgMHhEODAwOwogICAgICB2YXIgdHJhaWwgPSAoKGNvZGVfcG9pbnQgLSAweDEwMDAwKSAlIDB4NDAwKSArIDB4REMwMDsKICAgICAgY29udmVydF90b19ieXRlcyhsZWFkKTsKICAgICAgcmV0dXJuIGNvbnZlcnRfdG9fYnl0ZXModHJhaWwpOwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ3V0Zi0xNiddLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFVURjE2RW5jb2RlcihmYWxzZSwgb3B0aW9ucyk7CiAgfTsKICBuYW1lX3RvX2VuY29kaW5nWyd1dGYtMTYnXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBVVEYxNkRlY29kZXIoZmFsc2UsIG9wdGlvbnMpOwogIH07CgogIC8vIDEzLjIgdXRmLTE2YmUKICBuYW1lX3RvX2VuY29kaW5nWyd1dGYtMTZiZSddLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFVURjE2RW5jb2Rlcih0cnVlLCBvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ3V0Zi0xNmJlJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgVVRGMTZEZWNvZGVyKHRydWUsIG9wdGlvbnMpOwogIH07CgoKICAvLyBOT1RFOiBjdXJyZW50bHkgdW51c2VkCiAgLyoqCiAgICogQHBhcmFtIHtzdHJpbmd9IGxhYmVsIFRoZSBlbmNvZGluZyBsYWJlbC4KICAgKiBAcGFyYW0ge0J5dGVJbnB1dFN0cmVhbX0gaW5wdXRfc3RyZWFtIFRoZSBieXRlIHN0cmVhbSB0byB0ZXN0LgogICAqLwogIGZ1bmN0aW9uIGRldGVjdEVuY29kaW5nKGxhYmVsLCBpbnB1dF9zdHJlYW0pIHsKICAgIGlmIChpbnB1dF9zdHJlYW0ubWF0Y2goWzB4RkYsIDB4RkVdKSkgewogICAgICBpbnB1dF9zdHJlYW0ub2Zmc2V0KDIpOwogICAgICByZXR1cm4gJ3V0Zi0xNic7CiAgICB9CiAgICBpZiAoaW5wdXRfc3RyZWFtLm1hdGNoKFsweEZFLCAweEZGXSkpIHsKICAgICAgaW5wdXRfc3RyZWFtLm9mZnNldCgyKTsKICAgICAgcmV0dXJuICd1dGYtMTZiZSc7CiAgICB9CiAgICBpZiAoaW5wdXRfc3RyZWFtLm1hdGNoKFsweEVGLCAweEJCLCAweEJGXSkpIHsKICAgICAgaW5wdXRfc3RyZWFtLm9mZnNldCgzKTsKICAgICAgcmV0dXJuICd1dGYtOCc7CiAgICB9CiAgICByZXR1cm4gbGFiZWw7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge3N0cmluZ30gbGFiZWwgVGhlIGVuY29kaW5nIGxhYmVsLgogICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBpbnB1dF9zdHJlYW0gVGhlIGJ5dGUgc3RyZWFtIHRvIHRlc3QuCiAgICovCiAgZnVuY3Rpb24gY29uc3VtZUJPTShsYWJlbCwgaW5wdXRfc3RyZWFtKSB7CiAgICBpZiAoaW5wdXRfc3RyZWFtLm1hdGNoKFsweEZGLCAweEZFXSkgJiYgbGFiZWwgPT09ICd1dGYtMTYnKSB7CiAgICAgIGlucHV0X3N0cmVhbS5vZmZzZXQoMik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpbnB1dF9zdHJlYW0ubWF0Y2goWzB4RkUsIDB4RkZdKSAmJiBsYWJlbCA9PSAndXRmLTE2YmUnKSB7CiAgICAgIGlucHV0X3N0cmVhbS5vZmZzZXQoMik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpbnB1dF9zdHJlYW0ubWF0Y2goWzB4RUYsIDB4QkIsIDB4QkZdKSAmJiBsYWJlbCA9PSAndXRmLTgnKSB7CiAgICAgIGlucHV0X3N0cmVhbS5vZmZzZXQoMyk7CiAgICAgIHJldHVybjsKICAgIH0KICB9CgogIC8vCiAgLy8gSW1wbGVtZW50YXRpb24gb2YgVGV4dCBFbmNvZGluZyBXZWIgQVBJCiAgLy8KCiAgLyoqIEBjb25zdCAqLyB2YXIgREVGQVVMVF9FTkNPRElORyA9ICd1dGYtOCc7CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7c3RyaW5nPX0gb3B0X2VuY29kaW5nIFRoZSBsYWJlbCBvZiB0aGUgZW5jb2Rpbmc7CiAgICogICAgIGRlZmF1bHRzIHRvICd1dGYtOCcuCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59PX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIFRleHRFbmNvZGVyKG9wdF9lbmNvZGluZywgb3B0aW9ucykgewogICAgaWYgKCF0aGlzIHx8IHRoaXMgPT09IGdsb2JhbCkgewogICAgICByZXR1cm4gbmV3IFRleHRFbmNvZGVyKG9wdF9lbmNvZGluZywgb3B0aW9ucyk7CiAgICB9CiAgICBvcHRfZW5jb2RpbmcgPSBvcHRfZW5jb2RpbmcgPyBTdHJpbmcob3B0X2VuY29kaW5nKSA6IERFRkFVTFRfRU5DT0RJTkc7CiAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpOwogICAgLyoqIEBwcml2YXRlICovCiAgICB0aGlzLl9lbmNvZGluZyA9IGdldEVuY29kaW5nKG9wdF9lbmNvZGluZyk7CiAgICBpZiAodGhpcy5fZW5jb2RpbmcgPT09IG51bGwgfHwgKHRoaXMuX2VuY29kaW5nLm5hbWUgIT09ICd1dGYtOCcgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW5jb2RpbmcubmFtZSAhPT0gJ3V0Zi0xNicgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW5jb2RpbmcubmFtZSAhPT0gJ3V0Zi0xNmJlJykpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBvcHRfZW5jb2RpbmcpOwogICAgLyogQHByaXZhdGUgQHR5cGUge2Jvb2xlYW59ICovCiAgICB0aGlzLl9zdHJlYW1pbmcgPSBmYWxzZTsKICAgIC8qKiBAcHJpdmF0ZSAqLwogICAgdGhpcy5fZW5jb2RlciA9IG51bGw7CiAgICAvKiBAcHJpdmF0ZSBAdHlwZSB7e2ZhdGFsOiBib29sZWFufT19ICovCiAgICB0aGlzLl9vcHRpb25zID0geyBmYXRhbDogQm9vbGVhbihvcHRpb25zLmZhdGFsKSB9OwoKICAgIGlmIChPYmplY3QuZGVmaW5lUHJvcGVydHkpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KAogICAgICAgICAgdGhpcywgJ2VuY29kaW5nJywKICAgICAgICAgIHsgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuX2VuY29kaW5nLm5hbWU7IH0gfSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmVuY29kaW5nID0gdGhpcy5fZW5jb2RpbmcubmFtZTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9CgogIFRleHRFbmNvZGVyLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBvcHRfc3RyaW5nIFRoZSBzdHJpbmcgdG8gZW5jb2RlLgogICAgICogQHBhcmFtIHt7c3RyZWFtOiBib29sZWFufT19IG9wdGlvbnMKICAgICAqLwogICAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGUob3B0X3N0cmluZywgb3B0aW9ucykgewogICAgICBvcHRfc3RyaW5nID0gb3B0X3N0cmluZyA/IFN0cmluZyhvcHRfc3RyaW5nKSA6ICcnOwogICAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpOwogICAgICAvLyBUT0RPOiBhbnkgb3B0aW9ucz8KICAgICAgaWYgKCF0aGlzLl9zdHJlYW1pbmcpIHsKICAgICAgICB0aGlzLl9lbmNvZGVyID0gdGhpcy5fZW5jb2RpbmcuZ2V0RW5jb2Rlcih0aGlzLl9vcHRpb25zKTsKICAgICAgfQogICAgICB0aGlzLl9zdHJlYW1pbmcgPSBCb29sZWFuKG9wdGlvbnMuc3RyZWFtKTsKCiAgICAgIHZhciBieXRlcyA9IFtdOwogICAgICB2YXIgb3V0cHV0X3N0cmVhbSA9IG5ldyBCeXRlT3V0cHV0U3RyZWFtKGJ5dGVzKTsKICAgICAgdmFyIGlucHV0X3N0cmVhbSA9IG5ldyBDb2RlUG9pbnRJbnB1dFN0cmVhbShvcHRfc3RyaW5nKTsKICAgICAgd2hpbGUgKGlucHV0X3N0cmVhbS5nZXQoKSAhPT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICB0aGlzLl9lbmNvZGVyLmVuY29kZShvdXRwdXRfc3RyZWFtLCBpbnB1dF9zdHJlYW0pOwogICAgICB9CiAgICAgIGlmICghdGhpcy5fc3RyZWFtaW5nKSB7CiAgICAgICAgdmFyIGxhc3RfYnl0ZTsKICAgICAgICBkbyB7CiAgICAgICAgICBsYXN0X2J5dGUgPSB0aGlzLl9lbmNvZGVyLmVuY29kZShvdXRwdXRfc3RyZWFtLCBpbnB1dF9zdHJlYW0pOwogICAgICAgIH0gd2hpbGUgKGxhc3RfYnl0ZSAhPT0gRU9GX2J5dGUpOwogICAgICAgIHRoaXMuX2VuY29kZXIgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShieXRlcyk7CiAgICB9CiAgfTsKCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7c3RyaW5nPX0gb3B0X2VuY29kaW5nIFRoZSBsYWJlbCBvZiB0aGUgZW5jb2Rpbmc7CiAgICogICAgIGRlZmF1bHRzIHRvICd1dGYtOCcuCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59PX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIFRleHREZWNvZGVyKG9wdF9lbmNvZGluZywgb3B0aW9ucykgewogICAgaWYgKCF0aGlzIHx8IHRoaXMgPT09IGdsb2JhbCkgewogICAgICByZXR1cm4gbmV3IFRleHREZWNvZGVyKG9wdF9lbmNvZGluZywgb3B0aW9ucyk7CiAgICB9CiAgICBvcHRfZW5jb2RpbmcgPSBvcHRfZW5jb2RpbmcgPyBTdHJpbmcob3B0X2VuY29kaW5nKSA6IERFRkFVTFRfRU5DT0RJTkc7CiAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpOwogICAgLyoqIEBwcml2YXRlICovCiAgICB0aGlzLl9lbmNvZGluZyA9IGdldEVuY29kaW5nKG9wdF9lbmNvZGluZyk7CiAgICBpZiAodGhpcy5fZW5jb2RpbmcgPT09IG51bGwpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBvcHRfZW5jb2RpbmcpOwoKICAgIC8qIEBwcml2YXRlIEB0eXBlIHtib29sZWFufSAqLwogICAgdGhpcy5fc3RyZWFtaW5nID0gZmFsc2U7CiAgICAvKiogQHByaXZhdGUgKi8KICAgIHRoaXMuX2RlY29kZXIgPSBudWxsOwogICAgLyogQHByaXZhdGUgQHR5cGUge3tmYXRhbDogYm9vbGVhbn09fSAqLwogICAgdGhpcy5fb3B0aW9ucyA9IHsgZmF0YWw6IEJvb2xlYW4ob3B0aW9ucy5mYXRhbCkgfTsKCiAgICBpZiAoT2JqZWN0LmRlZmluZVByb3BlcnR5KSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgKICAgICAgICAgIHRoaXMsICdlbmNvZGluZycsCiAgICAgICAgICB7IGdldDogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLl9lbmNvZGluZy5uYW1lOyB9IH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5lbmNvZGluZyA9IHRoaXMuX2VuY29kaW5nLm5hbWU7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBUT0RPOiBJc3N1ZSBpZiBpbnB1dCBieXRlIHN0cmVhbSBpcyBvZmZzZXQgYnkgZGVjb2RlcgogIC8vIFRPRE86IEJPTSBkZXRlY3Rpb24gd2lsbCBub3Qgd29yayBpZiBzdHJlYW0gaGVhZGVyIHNwYW5zIG11bHRpcGxlIGNhbGxzCiAgLy8gKGxhc3QgTiBieXRlcyBvZiBwcmV2aW91cyBzdHJlYW0gbWF5IG5lZWQgdG8gYmUgcmV0YWluZWQ/KQogIFRleHREZWNvZGVyLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogQHBhcmFtIHtBcnJheUJ1ZmZlclZpZXc9fSBvcHRfdmlldyBUaGUgYnVmZmVyIG9mIGJ5dGVzIHRvIGRlY29kZS4KICAgICAqIEBwYXJhbSB7e3N0cmVhbTogYm9vbGVhbn09fSBvcHRpb25zCiAgICAgKi8KICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlKG9wdF92aWV3LCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRfdmlldyAmJiAhKCdidWZmZXInIGluIG9wdF92aWV3ICYmICdieXRlT2Zmc2V0JyBpbiBvcHRfdmlldyAmJgogICAgICAgICAgICAgICAgICAgICAgICAnYnl0ZUxlbmd0aCcgaW4gb3B0X3ZpZXcpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgQXJyYXlCdWZmZXJWaWV3Jyk7CiAgICAgIH0gZWxzZSBpZiAoIW9wdF92aWV3KSB7CiAgICAgICAgb3B0X3ZpZXcgPSBuZXcgVWludDhBcnJheSgwKTsKICAgICAgfQogICAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpOwoKICAgICAgaWYgKCF0aGlzLl9zdHJlYW1pbmcpIHsKICAgICAgICB0aGlzLl9kZWNvZGVyID0gdGhpcy5fZW5jb2RpbmcuZ2V0RGVjb2Rlcih0aGlzLl9vcHRpb25zKTsKICAgICAgfQogICAgICB0aGlzLl9zdHJlYW1pbmcgPSBCb29sZWFuKG9wdGlvbnMuc3RyZWFtKTsKCiAgICAgIHZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KG9wdF92aWV3LmJ1ZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0X3ZpZXcuYnl0ZU9mZnNldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0X3ZpZXcuYnl0ZUxlbmd0aCk7CiAgICAgIHZhciBpbnB1dF9zdHJlYW0gPSBuZXcgQnl0ZUlucHV0U3RyZWFtKGJ5dGVzKTsKCiAgICAgIGlmICghdGhpcy5fQk9Nc2VlbikgewogICAgICAgIC8vIFRPRE86IERvbid0IGRvIHRoaXMgdW50aWwgc3VmZmljaWVudCBieXRlcyBhcmUgcHJlc2VudAogICAgICAgIHRoaXMuX0JPTXNlZW4gPSB0cnVlOwogICAgICAgIGNvbnN1bWVCT00odGhpcy5fZW5jb2RpbmcubmFtZSwgaW5wdXRfc3RyZWFtKTsKICAgICAgfQoKICAgICAgdmFyIG91dHB1dF9zdHJlYW0gPSBuZXcgQ29kZVBvaW50T3V0cHV0U3RyZWFtKCksIGNvZGVfcG9pbnQ7CiAgICAgIHdoaWxlIChpbnB1dF9zdHJlYW0uZ2V0KCkgIT09IEVPRl9ieXRlKSB7CiAgICAgICAgY29kZV9wb2ludCA9IHRoaXMuX2RlY29kZXIuZGVjb2RlKGlucHV0X3N0cmVhbSk7CiAgICAgICAgaWYgKGNvZGVfcG9pbnQgIT09IG51bGwgJiYgY29kZV9wb2ludCAhPT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICAgIG91dHB1dF9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCF0aGlzLl9zdHJlYW1pbmcpIHsKICAgICAgICBkbyB7CiAgICAgICAgICBjb2RlX3BvaW50ID0gdGhpcy5fZGVjb2Rlci5kZWNvZGUoaW5wdXRfc3RyZWFtKTsKICAgICAgICAgIGlmIChjb2RlX3BvaW50ICE9PSBudWxsICYmIGNvZGVfcG9pbnQgIT09IEVPRl9jb2RlX3BvaW50KSB7CiAgICAgICAgICAgIG91dHB1dF9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgICAgIH0KICAgICAgICB9IHdoaWxlIChjb2RlX3BvaW50ICE9PSBFT0ZfY29kZV9wb2ludCAmJgogICAgICAgICAgICAgICAgIGlucHV0X3N0cmVhbS5nZXQoKSAhPSBFT0ZfYnl0ZSk7CiAgICAgICAgdGhpcy5fZGVjb2RlciA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIG91dHB1dF9zdHJlYW0uc3RyaW5nKCk7CiAgICB9CiAgfTsKCiAgZ2xvYmFsWydUZXh0RW5jb2RlciddID0gZ2xvYmFsWydUZXh0RW5jb2RlciddIHx8IFRleHRFbmNvZGVyOwogIGdsb2JhbFsnVGV4dERlY29kZXInXSA9IGdsb2JhbFsnVGV4dERlY29kZXInXSB8fCBUZXh0RGVjb2RlcjsKfSh0aGlzKSk7CihmdW5jdGlvbihnbG9iYWwpIHsKCi8vIFJ1bW9yIE1lc3NhZ2luZyBmb3IgSlMKLy8KLy8gaHR0cHM6Ly90Yndpa2kudG9rYm94LmNvbS9pbmRleC5waHAvUnVtb3JfOl9NZXNzYWdpbmdfRnJhbWVXb3JrCi8vCi8vIEB0b2RvIFJ1bW9yIHsKLy8gICAgIEFkZCBlcnJvciBjb2RlcyBmb3IgYWxsIHRoZSBlcnJvciBjYXNlcwovLyAgICAgQWRkIERlcGVuZGFiaWxpdHkgY29tbWFuZHMKLy8gfQoKT1QuUnVtb3IgPSB7CiAgTWVzc2FnZVR5cGU6IHsKICAgIC8vIFRoaXMgaXMgdXNlZCB0byBzdWJzY3JpYmUgdG8gYWRkcmVzcy9hZGRyZXNzZXMuIFRoZSBhZGRyZXNzL2FkZHJlc3NlcyB0aGUKICAgIC8vIGNsaWVudCBzcGVjaWZpZXMgaGVyZSBpcyByZWdpc3RlcmVkIG9uIHRoZSBzZXJ2ZXIuIE9uY2UgYW55IG1lc3NhZ2UgaXMgc2VudCB0bwogICAgLy8gdGhhdCBhZGRyZXNzL2FkZHJlc3NlcywgdGhlIGNsaWVudCByZWNlaXZlcyB0aGF0IG1lc3NhZ2UuCiAgICBTVUJTQ1JJQkU6IDAsCgogICAgLy8gVGhpcyBpcyB1c2VkIHRvIHVuc3Vic2NyaWJlIHRvIGFkZHJlc3MgLyBhZGRyZXNzZXMuIE9uY2UgdGhlIGNsaWVudCB1bnN1YnNjcmliZQogICAgLy8gdG8gYW4gYWRkcmVzcywgaXQgd2lsbCBzdG9wIGdldHRpbmcgbWVzc2FnZXMgc2VudCB0byB0aGF0IGFkZHJlc3MuCiAgICBVTlNVQlNDUklCRTogMSwKCiAgICAvLyBUaGlzIGlzIHVzZWQgdG8gc2VuZCBtZXNzYWdlcyB0byBhcmJpdHJhcnkgYWRkcmVzcy8gYWRkcmVzc2VzLiBNZXNzYWdlcyBjYW4gYmUKICAgIC8vIGFueXRoaW5nIGFuZCBSdW1vciB3aWxsIG5vdCBjYXJlIGFib3V0IHdoYXQgaXMgaW5jbHVkZWQuCiAgICBNRVNTQUdFOiAyLAoKICAgIC8vIFRoaXMgd2lsbCBiZSB0aGUgZmlyc3QgbWVzc2FnZSB0aGF0IHRoZSBjbGllbnQgc2VuZHMgdG8gdGhlIHNlcnZlci4gSXQgaW5jbHVkZXMKICAgIC8vIHRoZSB1bmlxdWVJZCBmb3IgdGhhdCBjbGllbnQgY29ubmVjdGlvbiBhbmQgYSBkaXNjb25uZWN0X25vdGlmeSBhZGRyZXNzIHRoYXQgd2lsbAogICAgLy8gYmUgbm90aWZpZWQgb25jZSB0aGUgY2xpZW50IGRpc2Nvbm5lY3RzLgogICAgQ09OTkVDVDogMywKCiAgICAvLyBUaGlzIHdpbGwgYmUgdGhlIG1lc3NhZ2UgdXNlZCBieSB0aGUgc2VydmVyIHRvIG5vdGlmeSBhbiBhZGRyZXNzIHRoYXQgYSBjbGllbnQgZGlzY29ubmVjdGVkLgogICAgRElTQ09OTkVDVDogNCwKCiAgICAvL0VuaGFuY2VtZW50cyB0byBzdXBwb3J0IEtlZXBhbGl2ZXMKICAgIFBJTkc6IDcsCiAgICBQT05HOiA4LAogICAgU1RBVFVTOiA5CiAgfQp9OwoKfSh0aGlzKSk7CihmdW5jdGlvbihnbG9iYWwpIHsKCnZhciBCVUZGRVJfRFJBSU5fSU5URVJWQUwgPSAxMDAsICAgICAgICAvLyBUaGUgaW50ZXJ2YWwgYmV0d2VlbiBwb2xsaW5nIHRoZSB3ZWJzb2NrZXQncyBzZW5kIGJ1ZmZlcgogICAgQlVGRkVSX0RSQUlOX01BWF9SRVRSSUVTID0gMTAsICAgICAgLy8gVGhlIHRvdGFsIG51bWJlciBvZiB0aW1lcyB0byByZXRlc3QgdGhlIHdlYnNvY2tldCdzIHNlbmQgYnVmZmVyCiAgICBXRUJfU09DS0VUX0tFRVBfQUxJVkVfSU5URVJWQUwgPSA1MDAwLAoKICAgIC8vIE1hZ2ljIENvbm5lY3Rpdml0eSBUaW1lb3V0IENvbnN0YW50OiBXZSB3YWl0IDMqdGhlIGtlZXAgYWxpdmUgaW50ZXJ2YWwsCiAgICAvLyBvbiB0aGUgdGhpcmQga2VlcCBhbGl2ZSB3ZSB0cmlnZ2VyIHRoZSB0aW1lb3V0IGlmIHdlIGhhdmVuJ3QgcmVjZWl2ZWQgdGhlCiAgICAvLyBzZXJ2ZXIgcG9uZy4KICAgIFdFQl9TT0NLRVRfQ09OTkVDVElWSVRZX1RJTUVPVVQgPSAzKldFQl9TT0NLRVRfS0VFUF9BTElWRV9JTlRFUlZBTCAtIDEwMAoKCgovLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvQ2xvc2VFdmVudCNDbG9zZV9jb2RlcwovLyBodHRwOi8vZG9jcy5vcmFjbGUuY29tL2phdmFlZS83L2FwaS9qYXZheC93ZWJzb2NrZXQvQ2xvc2VSZWFzb24uQ2xvc2VDb2Rlcy5odG1sCnZhciB3c0Nsb3NlRXJyb3JDb2RlcyA9IHsKICAxMDAyOiAgIlRoZSBlbmRwb2ludCBpcyB0ZXJtaW5hdGluZyB0aGUgY29ubmVjdGlvbiBkdWUgdG8gYSBwcm90b2NvbCBlcnJvci4gKENMT1NFX1BST1RPQ09MX0VSUk9SKSIsCiAgMTAwMzogICJUaGUgY29ubmVjdGlvbiBpcyBiZWluZyB0ZXJtaW5hdGVkIGJlY2F1c2UgdGhlIGVuZHBvaW50IHJlY2VpdmVkIGRhdGEgb2YgYSB0eXBlIGl0IGNhbm5vdCBhY2NlcHQgKGZvciBleGFtcGxlLCBhIHRleHQtb25seSBlbmRwb2ludCByZWNlaXZlZCBiaW5hcnkgZGF0YSkuIChDTE9TRV9VTlNVUFBPUlRFRCkiLAogIDEwMDQ6ICAiVGhlIGVuZHBvaW50IGlzIHRlcm1pbmF0aW5nIHRoZSBjb25uZWN0aW9uIGJlY2F1c2UgYSBkYXRhIGZyYW1lIHdhcyByZWNlaXZlZCB0aGF0IGlzIHRvbyBsYXJnZS4gKENMT1NFX1RPT19MQVJHRSkiLAogIDEwMDU6ICAiSW5kaWNhdGVzIHRoYXQgbm8gc3RhdHVzIGNvZGUgd2FzIHByb3ZpZGVkIGV2ZW4gdGhvdWdoIG9uZSB3YXMgZXhwZWN0ZWQuIChDTE9TRV9OT19TVEFUVVMpIiwKICAxMDA2OiAgIlVzZWQgdG8gaW5kaWNhdGUgdGhhdCBhIGNvbm5lY3Rpb24gd2FzIGNsb3NlZCBhYm5vcm1hbGx5ICh0aGF0IGlzLCB3aXRoIG5vIGNsb3NlIGZyYW1lIGJlaW5nIHNlbnQpIHdoZW4gYSBzdGF0dXMgY29kZSBpcyBleHBlY3RlZC4gKENMT1NFX0FCTk9STUFMKSIsCiAgMTAwNzogIkluZGljYXRlcyB0aGF0IGFuIGVuZHBvaW50IGlzIHRlcm1pbmF0aW5nIHRoZSBjb25uZWN0aW9uIGJlY2F1c2UgaXQgaGFzIHJlY2VpdmVkIGRhdGEgd2l0aGluIGEgbWVzc2FnZSB0aGF0IHdhcyBub3QgY29uc2lzdGVudCB3aXRoIHRoZSB0eXBlIG9mIHRoZSBtZXNzYWdlIChlLmcuLCBub24tVVRGLTggW1JGQzM2MjldIGRhdGEgd2l0aGluIGEgdGV4dCBtZXNzYWdlKSIsCiAgMTAwODogIkluZGljYXRlcyB0aGF0IGFuIGVuZHBvaW50IGlzIHRlcm1pbmF0aW5nIHRoZSBjb25uZWN0aW9uIGJlY2F1c2UgaXQgaGFzIHJlY2VpdmVkIGEgbWVzc2FnZSB0aGF0IHZpb2xhdGVzIGl0cyBwb2xpY3kuICBUaGlzIGlzIGEgZ2VuZXJpYyBzdGF0dXMgY29kZSB0aGF0IGNhbiBiZSByZXR1cm5lZCB3aGVuIHRoZXJlIGlzIG5vIG90aGVyIG1vcmUgc3VpdGFibGUgc3RhdHVzIGNvZGUgKGUuZy4sIDEwMDMgb3IgMTAwOSkgb3IgaWYgdGhlcmUgaXMgYSBuZWVkIHRvIGhpZGUgc3BlY2lmaWMgZGV0YWlscyBhYm91dCB0aGUgcG9saWN5IiwKICAxMDA5OiAiSW5kaWNhdGVzIHRoYXQgYW4gZW5kcG9pbnQgaXMgdGVybWluYXRpbmcgdGhlIGNvbm5lY3Rpb24gYmVjYXVzZSBpdCBoYXMgcmVjZWl2ZWQgYSBtZXNzYWdlIHRoYXQgaXMgdG9vIGJpZyBmb3IgaXQgdG8gcHJvY2VzcyIsCiAgMTAxMTogIkluZGljYXRlcyB0aGF0IGEgc2VydmVyIGlzIHRlcm1pbmF0aW5nIHRoZSBjb25uZWN0aW9uIGJlY2F1c2UgaXQgZW5jb3VudGVyZWQgYW4gdW5leHBlY3RlZCBjb25kaXRpb24gdGhhdCBwcmV2ZW50ZWQgaXQgZnJvbSBmdWxmaWxsaW5nIHRoZSByZXF1ZXN0IiwKCiAgLy8gLi4uLiBjb2RlcyBpbiB0aGUgNDAwMC00OTk5IHJhbmdlIGFyZSBhdmFpbGFibGUgZm9yIHVzZSBieSBhcHBsaWNhdGlvbnMuCiAgNDAwMTogICAiQ29ubmVjdGl2aXR5IGxvc3Mgd2FzIGRldGVjdGVkIGFzIGl0IHdhcyB0b28gbG9uZyBzaW5jZSB0aGUgc29ja2V0IHJlY2VpdmVkIHRoZSBsYXN0IFBPTkcgbWVzc2FnZSIKfTsKCk9ULlJ1bW9yLlNvY2tldEVycm9yID0gZnVuY3Rpb24oY29kZSwgbWVzc2FnZSkgewogIHRoaXMuY29kZSA9IGNvZGU7CiAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKfTsKCi8vIFRoZSBOYXRpdmVTb2NrZXQgYml0IGlzIHB1cmVseSB0byBtYWtlIHRlc3Rpbmcgc2ltcGxlciwgaXQgZGVmYXVsdHMgdG8gV2ViU29ja2V0Ci8vIHNvIGluIG5vcm1hbCBvcGVyYXRpb24geW91IHdvdWxkIG9taXQgaXQuCk9ULlJ1bW9yLlNvY2tldCA9IGZ1bmN0aW9uKG1lc3NhZ2luZ1NlcnZlciwgbm90aWZ5RGlzY29ubmVjdEFkZHJlc3MsIE5hdGl2ZVNvY2tldCkgewogIHZhciBzZXJ2ZXIgPSBtZXNzYWdpbmdTZXJ2ZXIsCiAgICAgIHdlYlNvY2tldCwKICAgICAgaWQsCiAgICAgIG9uT3BlbiwKICAgICAgb25FcnJvciwKICAgICAgb25DbG9zZSwKICAgICAgb25NZXNzYWdlLAogICAgICBjb25uZWN0Q2FsbGJhY2ssCiAgICAgIGJ1ZmZlckRyYWluVGltZW91dCwgICAgICAgICAgIC8vIFRpbWVyIHRvIHBvbGwgd2hldGhlciB0aCBzZW5kIGJ1ZmZlciBoYXMgYmVlbiBkcmFpbmVkCiAgICAgIGNvbm5lY3RUaW1lb3V0LAogICAgICBsYXN0TWVzc2FnZVRpbWVzdGFtcCwgICAgICAgICAvLyBUaGUgdGltZXN0YW1wIG9mIHRoZSBsYXN0IG1lc3NhZ2UgcmVjZWl2ZWQKICAgICAga2VlcEFsaXZlVGltZXI7ICAgICAgICAgICAgICAgLy8gVGltZXIgZm9yIHRoZSBjb25uZWN0aXZpdHkgY2hlY2tzCgoKICAvLy8vIFByaXZhdGUgQVBJCiAgdmFyIHN0YXRlQ2hhbmdlZCA9IGZ1bmN0aW9uKG5ld1N0YXRlKSB7CiAgICAgICAgc3dpdGNoIChuZXdTdGF0ZSkgewogICAgICAgICAgY2FzZSAnZGlzY29ubmVjdGVkJzoKICAgICAgICAgIGNhc2UgJ2Vycm9yJzoKICAgICAgICAgICAgd2ViU29ja2V0ID0gbnVsbDsKICAgICAgICAgICAgaWYgKG9uQ2xvc2UpIHsKICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgaWYoaGFzTG9zdENvbm5lY3Rpdml0eSgpKSB7CiAgICAgICAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcih3c0Nsb3NlRXJyb3JDb2Rlc1s0MDAxXSk7CiAgICAgICAgICAgICAgICBlcnJvci5jb2RlID0gNDAwMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb25DbG9zZShlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgc2V0U3RhdGUgPSBPVC4kLnN0YXRhYmxlKHRoaXMsIFsnZGlzY29ubmVjdGVkJywgICdlcnJvcicsICdjb25uZWN0ZWQnLCAnY29ubmVjdGluZycsICdkaXNjb25uZWN0aW5nJ10sICdkaXNjb25uZWN0ZWQnLCBzdGF0ZUNoYW5nZWQpLAoKICAgICAgdmFsaWRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uIHZhbGlkYXRlQ2FsbGJhY2sgKG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrID09PSBudWxsIHx8ICFPVC4kLmlzRnVuY3Rpb24oY2FsbGJhY2spICkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgUnVtb3IuU29ja2V0ICIgKyBuYW1lICsgIiBjYWxsYmFjayBtdXN0IGJlIGEgdmFsaWQgZnVuY3Rpb24gb3IgbnVsbCIpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIGVycm9yID0gZnVuY3Rpb24gZXJyb3IgKGVycm9yTWVzc2FnZSkgewogICAgICAgIE9ULmVycm9yKCJSdW1vci5Tb2NrZXQ6ICIgKyBlcnJvck1lc3NhZ2UpOwoKICAgICAgICB2YXIgZXJyb3IgPSBuZXcgT1QuUnVtb3IuU29ja2V0RXJyb3IobnVsbCwgZXJyb3JNZXNzYWdlIHx8ICJVbmtub3duIFNvY2tldCBFcnJvciIpOwoKICAgICAgICBpZiAoY29ubmVjdFRpbWVvdXQpIGNsZWFyVGltZW91dChjb25uZWN0VGltZW91dCk7CgogICAgICAgIHNldFN0YXRlKCdlcnJvcicpOwoKICAgICAgICBpZiAodGhpcy5wcmV2aW91c1N0YXRlID09PSAnY29ubmVjdGluZycgJiYgY29ubmVjdENhbGxiYWNrKSB7CiAgICAgICAgICBjb25uZWN0Q2FsbGJhY2soZXJyb3IsIG51bGwpOwogICAgICAgICAgY29ubmVjdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChvbkVycm9yKSBvbkVycm9yKGVycm9yKTsKICAgICAgfS5iaW5kKHRoaXMpLAoKICAgICAgLy8gSW1tZWRpYXRlbHkgY2xvc2UgdGhlIHNvY2tldCwgb25seSB1c2VkIGJ5IGRpc2Nvbm5lY3RXaGVuU2VuZEJ1ZmZlcklzRHJhaW5lZAogICAgICBjbG9zZSA9IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICAgIHNldFN0YXRlKCdkaXNjb25uZWN0aW5nJyk7CgogICAgICAgIGlmIChidWZmZXJEcmFpblRpbWVvdXQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dChidWZmZXJEcmFpblRpbWVvdXQpOwogICAgICAgICAgYnVmZmVyRHJhaW5UaW1lb3V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgY29uc29sZS5pbmZvKCJDQUxMRUQgQ0xPU0UgT04gV0VCU09DS0VUIik7CiAgICAgICAgd2ViU29ja2V0LmNsb3NlKCk7CiAgICAgIH0sCgogICAgICAvLyBFbnN1cmUgdGhhdCB0aGUgV2ViU29ja2V0IHNlbmQgYnVmZmVyIGlzIGZ1bGx5IGRyYWluZWQgYmVmb3JlIGRpc2Nvbm5lY3RpbmcKICAgICAgLy8gdGhlIHNvY2tldC4gSWYgdGhlIGJ1ZmZlciBkb2Vzbid0IGRyYWluIGFmdGVyIGEgY2VydGFpbiBsZW5ndGggb2YgdGltZQogICAgICAvLyB3ZSBnaXZlIHVwIGFuZCBjbG9zZSBpdCBhbnl3YXkuCiAgICAgIGRpc2Nvbm5lY3RXaGVuU2VuZEJ1ZmZlcklzRHJhaW5lZCA9IGZ1bmN0aW9uIGRpc2Nvbm5lY3RXaGVuU2VuZEJ1ZmZlcklzRHJhaW5lZCAoYnVmZmVyRHJhaW5SZXRyaWVzKSB7CiAgICAgICAgaWYgKCF3ZWJTb2NrZXQpIHJldHVybjsKCiAgICAgICAgaWYgKGJ1ZmZlckRyYWluUmV0cmllcyA9PT0gdm9pZCAwKSBidWZmZXJEcmFpblJldHJpZXMgPSAwOwogICAgICAgIGlmIChidWZmZXJEcmFpblRpbWVvdXQpIGNsZWFyVGltZW91dChidWZmZXJEcmFpblRpbWVvdXQpOwoKICAgICAgICBpZiAod2ViU29ja2V0LmJ1ZmZlcmVkQW1vdW50ID4gMCAmJiAoYnVmZmVyRHJhaW5SZXRyaWVzICsgMSkgPD0gQlVGRkVSX0RSQUlOX01BWF9SRVRSSUVTKSB7CiAgICAgICAgICBidWZmZXJEcmFpblRpbWVvdXQgPSBzZXRUaW1lb3V0KGRpc2Nvbm5lY3RXaGVuU2VuZEJ1ZmZlcklzRHJhaW5lZCwgQlVGRkVSX0RSQUlOX0lOVEVSVkFMLCBidWZmZXJEcmFpblJldHJpZXMrMSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgY2xvc2UoKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBoYXNMb3N0Q29ubmVjdGl2aXR5ID0gZnVuY3Rpb24gaGFzTG9zdENvbm5lY3Rpdml0eSAoKSB7CiAgICAgICAgaWYgKCFsYXN0TWVzc2FnZVRpbWVzdGFtcCkgcmV0dXJuIGZhbHNlOwoKICAgICAgICByZXR1cm4gKE9ULiQubm93KCkgLSBsYXN0TWVzc2FnZVRpbWVzdGFtcCkgPj0gV0VCX1NPQ0tFVF9DT05ORUNUSVZJVFlfVElNRU9VVDsKICAgICAgfSwKCiAgICAgIHNlbmRLZWVwQWxpdmUgPSBmdW5jdGlvbiBzZW5kS2VlcEFsaXZlICgpIHsKICAgICAgICBpZiAoIXRoaXMuaXMoJ2Nvbm5lY3RlZCcpKSByZXR1cm47CgogICAgICAgIGlmICggaGFzTG9zdENvbm5lY3Rpdml0eSgpICkgewogICAgICAgICAgd2ViU29ja2V0RGlzY29ubmVjdGVkKHtjb2RlOiA0MDAxfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgIHsKICAgICAgICAgIHdlYlNvY2tldC5zZW5kKE9ULlJ1bW9yLk1lc3NhZ2UuUGluZygpLnNlcmlhbGl6ZSgpKTsKICAgICAgICAgIGtlZXBBbGl2ZVRpbWVyID0gc2V0VGltZW91dChzZW5kS2VlcEFsaXZlLmJpbmQodGhpcyksIFdFQl9TT0NLRVRfS0VFUF9BTElWRV9JTlRFUlZBTCk7CiAgICAgICAgfQogICAgICB9LmJpbmQodGhpcyk7CgoKICAvLy8vIFByaXZhdGUgRXZlbnQgSGFuZGxlcnMKICB2YXIgd2ViU29ja2V0Q29ubmVjdGVkID0gZnVuY3Rpb24gd2ViU29ja2V0Q29ubmVjdGVkICgpIHsKICAgICAgICBpZiAoY29ubmVjdFRpbWVvdXQpIGNsZWFyVGltZW91dChjb25uZWN0VGltZW91dCk7CgogICAgICAgIC8vIENvbm5lY3QgdG8gUnVtb3IgYnkgcmVnaXN0ZXJpbmcgb3VyIGNvbm5lY3Rpb24gaWQgYW5kIHRoZQogICAgICAgIC8vIGFwcCBzZXJ2ZXIgYWRkcmVzcyB0byBub3RpZnkgaWYgd2UgZGlzY29ubmVjdC4KICAgICAgICAvLwogICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gd2FpdCBmb3IgYSByZXBseSB0byB0aGlzIG1lc3NhZ2UuCiAgICAgICAgd2ViU29ja2V0LnNlbmQoT1QuUnVtb3IuTWVzc2FnZS5Db25uZWN0KGlkLCBub3RpZnlEaXNjb25uZWN0QWRkcmVzcykuc2VyaWFsaXplKCkpOwoKICAgICAgICBzZXRTdGF0ZSgnY29ubmVjdGVkJyk7CiAgICAgICAgaWYgKGNvbm5lY3RDYWxsYmFjaykgewogICAgICAgICAgY29ubmVjdENhbGxiYWNrKG51bGwsIGlkKTsKICAgICAgICAgIGNvbm5lY3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAob25PcGVuKSBvbk9wZW4oaWQpOwoKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgbGFzdE1lc3NhZ2VUaW1lc3RhbXAgPSBPVC4kLm5vdygpOwogICAgICAgICAgc2VuZEtlZXBBbGl2ZSgpOwogICAgICAgIH0sIFdFQl9TT0NLRVRfS0VFUF9BTElWRV9JTlRFUlZBTCk7CiAgICAgIH0sCgogICAgICB3ZWJTb2NrZXRDb25uZWN0VGltZWRPdXQgPSBmdW5jdGlvbiB3ZWJTb2NrZXRDb25uZWN0VGltZWRPdXQgKCkgewogICAgICAgIGVycm9yKCJUaW1lZCBvdXQgd2hpbGUgd2FpdGluZyBmb3IgdGhlIFJ1bW9yIHNvY2tldCB0byBjb25uZWN0LiIpOwogICAgICB9LAoKICAgICAgd2ViU29ja2V0RXJyb3IgPSBmdW5jdGlvbiB3ZWJTb2NrZXRFcnJvciAoZXJyb3JFdmVudCkgewogICAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSAiVW5rbm93biBTb2NrZXQgRXJyb3IiOyAgICAgIC8vIEBmaXhtZSBXZSBNVVNUIGJlIGFibGUgdG8gZG8gYmV0dGVyIHRoYW4gdGhpcyEKCiAgICAgICAgLy8gQWxsIGVycm9ycyBzZWVtIHRvIHJlc3VsdCBpbiBkaXNjb25uZWN0aW5nIHRoZSBzb2NrZXQsIHRoZSBjbG9zZSBldmVudAogICAgICAgIC8vIGhhcyBhIGNsb3NlIHJlYXNvbiBhbmQgY29kZSB3aGljaCBnaXZlcyBzb21lIGVycm9yIGNvbnRleHQuIFRoaXMsCiAgICAgICAgLy8gY29tYmluZWQgd2l0aCB0aGUgZmFjdCB0aGF0IHRoZSBlcnJvckV2ZW50IGFyZ3VtZW50IGNvbnRhaW5zIG5vCiAgICAgICAgLy8gZXJyb3IgaW5mbyBhdCBhbGwsIG1lYW5zIHdlJ2xsIGRlbGF5IHRyaWdnZXJpbmcgdGhlIGVycm9yIGhhbmRsZXJzCiAgICAgICAgLy8gdW50aWwgdGhlIHNvY2tldCBpcyBjbG9zZWQuCiAgICAgICAgLy8gZXJyb3IoZXJyb3JNZXNzYWdlKTsKICAgICAgfSwKCiAgICAgIHdlYlNvY2tldERpc2Nvbm5lY3RlZCA9IGZ1bmN0aW9uIHdlYlNvY2tldERpc2Nvbm5lY3RlZCAoY2xvc2VFdmVudCkgewogICAgICAgIGlmIChjb25uZWN0VGltZW91dCkgY2xlYXJUaW1lb3V0KGNvbm5lY3RUaW1lb3V0KTsKICAgICAgICBpZiAoa2VlcEFsaXZlVGltZXIpIGNsZWFyVGltZW91dChrZWVwQWxpdmVUaW1lcik7CgogICAgICAgIGlmIChjbG9zZUV2ZW50LmNvZGUgIT09IDEwMDAgJiYgY2xvc2VFdmVudC5jb2RlICE9PSAxMDAxKSB7CiAgICAgICAgICB2YXIgcmVhc29uID0gY2xvc2VFdmVudC5yZWFzb24gfHwgY2xvc2VFdmVudC5tZXNzYWdlOwogICAgICAgICAgaWYgKCFyZWFzb24gJiYgd3NDbG9zZUVycm9yQ29kZXMuaGFzT3duUHJvcGVydHkoY2xvc2VFdmVudC5jb2RlKSkgcmVhc29uID0gd3NDbG9zZUVycm9yQ29kZXNbY2xvc2VFdmVudC5jb2RlXTsKCiAgICAgICAgICBlcnJvcigiUnVtb3IgU29ja2V0IERpc2Nvbm5lY3RlZDogIiArIHJlYXNvbik7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5pc05vdCgnZXJyb3InKSkgc2V0U3RhdGUoJ2Rpc2Nvbm5lY3RlZCcpOwogICAgICB9LmJpbmQodGhpcyksCgogICAgICB3ZWJTb2NrZXRSZWNlaXZlZE1lc3NhZ2UgPSBmdW5jdGlvbiB3ZWJTb2NrZXRSZWNlaXZlZE1lc3NhZ2UgKG1lc3NhZ2UpIHsKICAgICAgICBsYXN0TWVzc2FnZVRpbWVzdGFtcCA9IE9ULiQubm93KCk7CgogICAgICAgIGlmIChvbk1lc3NhZ2UpIHsKICAgICAgICAgIHZhciBtc2cgPSBPVC5SdW1vci5NZXNzYWdlLmRlc2VyaWFsaXplKG1lc3NhZ2UuZGF0YSk7CgogICAgICAgICAgaWYgKG1zZy50eXBlICE9PSBPVC5SdW1vci5NZXNzYWdlVHlwZS5QT05HKSB7CiAgICAgICAgICAgIG9uTWVzc2FnZShtc2cudG9BZGRyZXNzLCBtc2cuZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKCiAgLy8vLyBQdWJsaWMgQVBJCgogIHRoaXMucHVibGlzaCA9IGZ1bmN0aW9uICh0b3BpY3MsIG1lc3NhZ2UpIHsKICAgIHdlYlNvY2tldC5zZW5kKE9ULlJ1bW9yLk1lc3NhZ2UuUHVibGlzaCh0b3BpY3MsIG1lc3NhZ2UpLnNlcmlhbGl6ZSgpKTsKICB9OwoKICB0aGlzLnN1YnNjcmliZSA9IGZ1bmN0aW9uKHRvcGljcykgewogICAgd2ViU29ja2V0LnNlbmQoT1QuUnVtb3IuTWVzc2FnZS5TdWJzY3JpYmUodG9waWNzKS5zZXJpYWxpemUoKSk7CiAgfTsKCiAgdGhpcy51bnN1YnNjcmliZSA9IGZ1bmN0aW9uKHRvcGljcykgewogICAgd2ViU29ja2V0LnNlbmQoT1QuUnVtb3IuTWVzc2FnZS5VbnN1YnNjcmliZSh0b3BpY3MpLnNlcmlhbGl6ZSgpKTsKICB9OwoKICB0aGlzLmNvbm5lY3QgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkLCBjb21wbGV0ZSkgewogICAgaWYgKHRoaXMuaXMoJ2Nvbm5lY3RpbmcnLCAnY29ubmVjdGVkJykpIHsKICAgICAgY29tcGxldGUobnVsbCwgIlJ1bW9yLlNvY2tldCBjYW5ub3QgY29ubmVjdCB3aGVuIGl0IGlzIGFscmVhZHkgY29ubmVjdGluZyBvciBjb25uZWN0ZWQuIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZCA9IGNvbm5lY3Rpb25JZDsKICAgIGNvbm5lY3RDYWxsYmFjayA9IGNvbXBsZXRlOwoKICAgIHRyeSB7CiAgICAgIHNldFN0YXRlKCdjb25uZWN0aW5nJyk7CgogICAgICB3ZWJTb2NrZXQgPSBuZXcgKE5hdGl2ZVNvY2tldCB8fCBXZWJTb2NrZXQpKHNlcnZlcik7CiAgICAgIHdlYlNvY2tldC5iaW5hcnlUeXBlID0gJ2FycmF5YnVmZmVyJzsKCiAgICAgIHdlYlNvY2tldC5vbm9wZW4gPSB3ZWJTb2NrZXRDb25uZWN0ZWQ7CiAgICAgIHdlYlNvY2tldC5vbmNsb3NlID0gd2ViU29ja2V0RGlzY29ubmVjdGVkOwogICAgICB3ZWJTb2NrZXQub25lcnJvciA9IHdlYlNvY2tldEVycm9yOwogICAgICB3ZWJTb2NrZXQub25tZXNzYWdlID0gd2ViU29ja2V0UmVjZWl2ZWRNZXNzYWdlOwoKICAgICAgY29ubmVjdFRpbWVvdXQgPSBzZXRUaW1lb3V0KHdlYlNvY2tldENvbm5lY3RUaW1lZE91dCwgT1QuUnVtb3IuU29ja2V0LkNPTk5FQ1RfVElNRU9VVCk7CiAgICB9CiAgICBjYXRjaChlKSB7CiAgICAgIE9ULmVycm9yKGUpOwoKICAgICAgLy8gQHRvZG8gYWRkIGFuIGFjdHVhbCBlcnJvciBtZXNzYWdlCiAgICAgIGVycm9yKCJDb3VsZCBub3QgY29ubmVjdCB0byB0aGUgUnVtb3Igc29ja2V0LCBwb3NzaWJseSBiZWNhdXNlIG9mIGEgYmxvY2tlZCBwb3J0LiIpCiAgICB9CiAgfTsKCiAgdGhpcy5kaXNjb25uZWN0ID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoY29ubmVjdFRpbWVvdXQpIGNsZWFyVGltZW91dChjb25uZWN0VGltZW91dCk7CiAgICBpZiAoa2VlcEFsaXZlVGltZXIpIGNsZWFyVGltZW91dChrZWVwQWxpdmVUaW1lcik7CgogICAgaWYgKCF3ZWJTb2NrZXQpIHsKICAgICAgaWYgKHRoaXMuaXNOb3QoJ2Vycm9yJykpIHNldFN0YXRlKCdkaXNjb25uZWN0ZWQnKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh3ZWJTb2NrZXQucmVhZHlTdGF0ZSA9PT0gMy8qIENMT1NFRCAqLykgewogICAgICBpZiAodGhpcy5pc05vdCgnZXJyb3InKSkgc2V0U3RhdGUoJ2Rpc2Nvbm5lY3RlZCcpOwogICAgfQogICAgZWxzZSB7CiAgICAgIGlmICh0aGlzLmlzKCdjb25uZWN0ZWQnKSkgewogICAgICAgIC8vIExvb2shIFdlIGFyZSBuaWNlIHRvIHRoZSBydW1vciBzZXJ2ZXIgOy0pCiAgICAgICAgd2ViU29ja2V0LnNlbmQoT1QuUnVtb3IuTWVzc2FnZS5EaXNjb25uZWN0KCkuc2VyaWFsaXplKCkpOwogICAgICB9CgogICAgICAvLyBXYWl0IHVudGlsIHRoZSBzb2NrZXQgaXMgcmVhZHkgdG8gY2xvc2UKICAgICAgZGlzY29ubmVjdFdoZW5TZW5kQnVmZmVySXNEcmFpbmVkKCk7CiAgICB9CiAgfTsKCgoKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICBpZDogewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gaWQ7IH0KICAgIH0sCgogICAgb25PcGVuOiB7CiAgICAgIHNldDogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YWxpZGF0ZUNhbGxiYWNrKCdvbk9wZW4nLCBjYWxsYmFjayk7CiAgICAgICAgb25PcGVuID0gY2FsbGJhY2s7CiAgICAgIH0sCgogICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gb25PcGVuOyB9CiAgICB9LAoKICAgIG9uRXJyb3I6IHsKICAgICAgc2V0OiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIHZhbGlkYXRlQ2FsbGJhY2soJ29uRXJyb3InLCBjYWxsYmFjayk7CiAgICAgICAgb25FcnJvciA9IGNhbGxiYWNrOwogICAgICB9LAoKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG9uRXJyb3I7IH0KICAgIH0sCgogICAgb25DbG9zZTogewogICAgICBzZXQ6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFsaWRhdGVDYWxsYmFjaygnb25DbG9zZScsIGNhbGxiYWNrKTsKICAgICAgICBvbkNsb3NlID0gY2FsbGJhY2s7CiAgICAgIH0sCgogICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gb25DbG9zZTsgfQogICAgfSwKCiAgICBvbk1lc3NhZ2U6IHsKICAgICAgc2V0OiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIHZhbGlkYXRlQ2FsbGJhY2soJ29uTWVzc2FnZScsIGNhbGxiYWNrKTsKICAgICAgICBvbk1lc3NhZ2UgPSBjYWxsYmFjazsKICAgICAgfSwKCiAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBvbk1lc3NhZ2U7IH0KICAgIH0KICB9KTsKfTsKCi8vIFRoZSBudW1iZXIgb2YgbXMgdG8gd2FpdCBmb3IgdGhlIHdlYnNvY2tldCB0byBjb25uZWN0Ck9ULlJ1bW9yLlNvY2tldC5DT05ORUNUX1RJTUVPVVQgPSAxNTAwMDsKCn0odGhpcykpOwooZnVuY3Rpb24oZ2xvYmFsKSB7CgovLwovLwovLyBAcmVmZXJlbmNlcwovLyAqIGh0dHBzOi8vdGJ3aWtpLnRva2JveC5jb20vaW5kZXgucGhwL1J1bW9yX01lc3NhZ2VfUGFja2V0Ci8vICogaHR0cHM6Ly90Yndpa2kudG9rYm94LmNvbS9pbmRleC5waHAvUnVtb3JfUHJvdG9jb2wKLy8KT1QuUnVtb3IuTWVzc2FnZSA9IGZ1bmN0aW9uICh0eXBlLCB0b0FkZHJlc3MsIGhlYWRlcnMsIGRhdGEpIHsKICB0aGlzLnR5cGUgPSB0eXBlOwogIHRoaXMudG9BZGRyZXNzID0gdG9BZGRyZXNzOwogIHRoaXMuaGVhZGVycyA9IGhlYWRlcnM7CiAgdGhpcy5kYXRhID0gZGF0YTsKfTsKCgpPVC5SdW1vci5NZXNzYWdlLnByb3RvdHlwZS5zZXJpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIGJpdFN0cmVhbSA9ICcnLAogICAgICBzdHIgPSAiIiwKICAgICAgb2Zmc2V0ID0gOCwKICAgICAgY0J1ZiA9IDcsCiAgICAgIGFkZHJlc3MgPSBuZXcgQXJyYXkodGhpcy50b0FkZHJlc3MubGVuZ3RoKSwKICAgICAgaGVhZGVyS2V5ID0gbmV3IEFycmF5KHRoaXMuaGVhZGVycy5sZW5ndGgpLAogICAgICBoZWFkZXJWYWwgPSBuZXcgQXJyYXkodGhpcy5oZWFkZXJzLmxlbmd0aCksCiAgICAgIGRhdGFWaWV3OwoKICAvLyBUaGUgbnVtYmVyIG9mIGFkZHJlc3NlcwogIGNCdWYrKzsKCiAgLy8gV3JpdGUgb3V0IHRoZSBhZGRyZXNzLgogIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50b0FkZHJlc3MubGVuZ3RoOyBpKyspIHsKICAgIGFkZHJlc3NbaV0gPSBUZXh0RW5jb2RlcigndXRmLTgnKS5lbmNvZGUodGhpcy50b0FkZHJlc3NbaV0pOwogICAgY0J1ZiArPSAyOwogICAgY0J1ZiArPSBhZGRyZXNzW2ldLmxlbmd0aDsKICB9CgogIC8vIFRoZSBudW1iZXIgb2YgcGFyYW1ldGVycwogIGNCdWYrKzsKCiAgLy8gV3JpdGUgb3V0IHRoZSBwYXJhbXMKICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaGVhZGVycy5sZW5ndGg7IGkrKykgewogICAgaGVhZGVyS2V5W2ldID0gVGV4dEVuY29kZXIoJ3V0Zi04JykuZW5jb2RlKHRoaXMuaGVhZGVyc1tpXS5rZXkpOwogICAgaGVhZGVyVmFsW2ldID0gVGV4dEVuY29kZXIoJ3V0Zi04JykuZW5jb2RlKHRoaXMuaGVhZGVyc1tpXS52YWwpOwogICAgY0J1ZiArPSA0OwogICAgY0J1ZiArPSBoZWFkZXJLZXlbaV0ubGVuZ3RoOwogICAgY0J1ZiArPSBoZWFkZXJWYWxbaV0ubGVuZ3RoOwogIH0KCiAgZGF0YVZpZXcgPSBUZXh0RW5jb2RlcigndXRmLTgnKS5lbmNvZGUodGhpcy5kYXRhKTsKICBjQnVmICs9IGRhdGFWaWV3Lmxlbmd0aDsKCiAgLy8gTGV0J3MgYWxsb2NhdGUgYSBiaW5hcnkgYmxvYiBvZiB0aGlzIHNpemUKICB2YXIgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGNCdWYpOwogIHZhciB1aW50OFZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIsIDAsIGNCdWYpOwoKICAvLyBXZSBkb24ndCBpbmNsdWRlIHRoZSBoZWFkZXIgaW4gdGhlIGxlbmdodC4KICBjQnVmIC09IDQ7CgogIC8vIFdyaXRlIG91dCBzaXplIChpbiBuZXR3b3JrIG9yZGVyKQogIHVpbnQ4Vmlld1swXSA9IChjQnVmICYgMHhGRjAwMDAwMCkgPj4+IDI0OwogIHVpbnQ4Vmlld1sxXSA9IChjQnVmICYgMHgwMEZGMDAwMCkgPj4+IDE2OwogIHVpbnQ4Vmlld1syXSA9IChjQnVmICYgMHgwMDAwRkYwMCkgPj4+ICA4OwogIHVpbnQ4Vmlld1szXSA9IChjQnVmICYgMHgwMDAwMDBGRikgPj4+ICAwOwoKICAvLyBXcml0ZSBvdXQgcmVzZXJ2ZWQgYnl0ZXMKICB1aW50OFZpZXdbNF0gPSAwOwogIHVpbnQ4Vmlld1s1XSA9IDA7CgogIC8vIFdyaXRlIG91dCBtZXNzYWdlIHR5cGUKICB1aW50OFZpZXdbNl0gPSB0aGlzLnR5cGU7CiAgdWludDhWaWV3WzddID0gdGhpcy50b0FkZHJlc3MubGVuZ3RoOwoKICAvLyBOb3cganVzdCBjb3B5IG92ZXIgdGhlIGVuY29kZWQgdmFsdWVzLi4KICBmb3IgKHZhciBpID0gMDsgaSA8IGFkZHJlc3MubGVuZ3RoOyBpKyspIHsKICAgIHN0ckFycmF5ID0gYWRkcmVzc1tpXTsKICAgIHVpbnQ4Vmlld1tvZmZzZXQrK10gPSBzdHJBcnJheS5sZW5ndGggPj4gOCAmIDB4RkY7CiAgICB1aW50OFZpZXdbb2Zmc2V0KytdID0gc3RyQXJyYXkubGVuZ3RoID4+IDAgJiAweEZGOwogICAgZm9yICh2YXIgaiA9IDA7IGogPCBzdHJBcnJheS5sZW5ndGg7IGorKykgewogICAgICB1aW50OFZpZXdbb2Zmc2V0KytdID0gc3RyQXJyYXlbal07CiAgICB9CiAgfQoKICB1aW50OFZpZXdbb2Zmc2V0KytdID0gaGVhZGVyS2V5Lmxlbmd0aDsKCiAgLy8gV3JpdGUgb3V0IHRoZSBwYXJhbXMKICBmb3IgKHZhciBpID0gMDsgaSA8IGhlYWRlcktleS5sZW5ndGg7IGkrKykgewogICAgc3RyQXJyYXkgPSBoZWFkZXJLZXlbaV07CiAgICB1aW50OFZpZXdbb2Zmc2V0KytdID0gc3RyQXJyYXkubGVuZ3RoID4+IDggJiAweEZGOwogICAgdWludDhWaWV3W29mZnNldCsrXSA9IHN0ckFycmF5Lmxlbmd0aCA+PiAwICYgMHhGRjsKICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3RyQXJyYXkubGVuZ3RoOyBqKyspIHsKICAgICAgdWludDhWaWV3W29mZnNldCsrXSA9IHN0ckFycmF5W2pdOwogICAgfQoKICAgIHN0ckFycmF5ID0gaGVhZGVyVmFsW2ldOwogICAgdWludDhWaWV3W29mZnNldCsrXSA9IHN0ckFycmF5Lmxlbmd0aCA+PiA4ICYgMHhGRjsKICAgIHVpbnQ4Vmlld1tvZmZzZXQrK10gPSBzdHJBcnJheS5sZW5ndGggPj4gMCAmIDB4RkY7CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IHN0ckFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgIHVpbnQ4Vmlld1tvZmZzZXQrK10gPSBzdHJBcnJheVtqXTsKICAgIH0KICB9CgogIC8vIEFuZCBmaW5hbGx5IHRoZSBkYXRhCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhVmlldy5sZW5ndGg7IGkrKykgewogICAgdWludDhWaWV3W29mZnNldCsrXSA9IGRhdGFWaWV3W2ldOwogIH0KCiAgcmV0dXJuIGJ1ZmZlcjsKfTsKCk9ULlJ1bW9yLk1lc3NhZ2UuZGVzZXJpYWxpemUgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgdmFyIGNCdWYgPSAwOwogIHZhciB0eXBlOwogIHZhciBvZmZzZXQgPSA4OwogIHZhciB1aW50OFZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIpOwoKICAvLyBXcml0ZSBvdXQgc2l6ZSAoaW4gbmV0d29yayBvcmRlcikKICBjQnVmICs9IHVpbnQ4Vmlld1swXSA8PCAyNDsKICBjQnVmICs9IHVpbnQ4Vmlld1sxXSA8PCAxNjsKICBjQnVmICs9IHVpbnQ4Vmlld1syXSA8PCAgODsKICBjQnVmICs9IHVpbnQ4Vmlld1szXSA8PCAgMDsKCiAgdHlwZSA9IHVpbnQ4Vmlld1s2XTsKICB2YXIgYWRkcmVzcyA9IFtdOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHVpbnQ4Vmlld1s3XTsgaSsrKSB7CiAgICBsZW5ndGggPSB1aW50OFZpZXdbb2Zmc2V0KytdIDw8IDg7CiAgICBsZW5ndGggKz0gdWludDhWaWV3W29mZnNldCsrXTsKICAgIHZhciBzdHJWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCk7CiAgICBhZGRyZXNzW2ldID0gVGV4dERlY29kZXIoJ3V0Zi04JykuZGVjb2RlKHN0clZpZXcpOwogICAgb2Zmc2V0ICs9IGxlbmd0aDsKICB9CgogIHZhciBoZWFkZXJsZW4gPSB1aW50OFZpZXdbb2Zmc2V0KytdOwogIHZhciBoZWFkZXJzID0gW107CgogIGZvciAodmFyIGkgPSAwOyBpIDwgaGVhZGVybGVuOyBpKyspIHsKICAgIGxlbmd0aCA9IHVpbnQ4Vmlld1tvZmZzZXQrK10gPDwgODsKICAgIGxlbmd0aCArPSB1aW50OFZpZXdbb2Zmc2V0KytdOwogICAgdmFyIHN0clZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIsIG9mZnNldCwgbGVuZ3RoKTsKICAgIHZhciBrZXlTdHIgPSBUZXh0RGVjb2RlcigndXRmLTgnKS5kZWNvZGUoc3RyVmlldyk7CiAgICBvZmZzZXQgKz0gbGVuZ3RoOwoKICAgIGxlbmd0aCA9IHVpbnQ4Vmlld1tvZmZzZXQrK10gPDwgODsKICAgIGxlbmd0aCArPSB1aW50OFZpZXdbb2Zmc2V0KytdOwogICAgc3RyVmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgpOwogICAgdmFyIHZhbFN0ciA9IFRleHREZWNvZGVyKCd1dGYtOCcpLmRlY29kZShzdHJWaWV3KTsKICAgIGhlYWRlcnNbaV0gPSAgeyBrZXkgOiBrZXlTdHIsIHZhbCA6IHZhbFN0ciB9OwogICAgb2Zmc2V0ICs9IGxlbmd0aDsKICB9CgogIHZhciBkYXRhVmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgb2Zmc2V0KTsKICB2YXIgZGF0YSA9IFRleHREZWNvZGVyKCd1dGYtOCcpLmRlY29kZShkYXRhVmlldyk7CgogcmV0dXJuIG5ldyBPVC5SdW1vci5NZXNzYWdlKHR5cGUsIGFkZHJlc3MsIGhlYWRlcnMsIGRhdGEpOwp9OwoKCk9ULlJ1bW9yLk1lc3NhZ2UuQ29ubmVjdCA9IGZ1bmN0aW9uICh1bmlxdWVJZCwgbm90aWZ5RGlzY29ubmVjdEFkZHJlc3MpIHsKICB2YXIgaGVhZGVycyA9IFsKICAgIHtrZXk6ICd1bmlxdWVJZCcsIHZhbDogdW5pcXVlSWR9LAogICAge2tleTogJ25vdGlmeURpc2Nvbm5lY3RBZGRyZXNzJywgdmFsOiBub3RpZnlEaXNjb25uZWN0QWRkcmVzc30KICBdOwoKICByZXR1cm4gbmV3IE9ULlJ1bW9yLk1lc3NhZ2UoT1QuUnVtb3IuTWVzc2FnZVR5cGUuQ09OTkVDVCwgW10sIGhlYWRlcnMsICIiKTsKfTsKCk9ULlJ1bW9yLk1lc3NhZ2UuRGlzY29ubmVjdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gbmV3IE9ULlJ1bW9yLk1lc3NhZ2UoT1QuUnVtb3IuTWVzc2FnZVR5cGUuRElTQ09OTkVDVCwgW10sIFtdLCAiIik7Cn07CgpPVC5SdW1vci5NZXNzYWdlLlN1YnNjcmliZSA9IGZ1bmN0aW9uKHRvcGljcykgewogIHJldHVybiBuZXcgT1QuUnVtb3IuTWVzc2FnZShPVC5SdW1vci5NZXNzYWdlVHlwZS5TVUJTQ1JJQkUsIHRvcGljcywgW10sICIiKTsKfTsKCk9ULlJ1bW9yLk1lc3NhZ2UuVW5zdWJzY3JpYmUgPSBmdW5jdGlvbih0b3BpY3MpIHsKICByZXR1cm4gbmV3IE9ULlJ1bW9yLk1lc3NhZ2UoT1QuUnVtb3IuTWVzc2FnZVR5cGUuVU5TVUJTQ1JJQkUsIHRvcGljcywgW10sICIiKTsKfTsKCk9ULlJ1bW9yLk1lc3NhZ2UuUHVibGlzaCA9IGZ1bmN0aW9uKHRvcGljcywgbWVzc2FnZSwgaGVhZGVycykgewogIHJldHVybiBuZXcgT1QuUnVtb3IuTWVzc2FnZShPVC5SdW1vci5NZXNzYWdlVHlwZS5NRVNTQUdFLCB0b3BpY3MsIFtdLCBtZXNzYWdlKTsKfTsKCi8vIFRoaXMgbWVzc2FnZSBpcyB1c2VkIHRvIGltcGxlbWVudCBrZWVwYWxpdmVzIG9uIHRoZSBwZXJzaXN0ZW50Ci8vIHNvY2tldCBjb25uZWN0aW9uIGJldHdlZW4gdGhlIGNsaWVudCBhbmQgc2VydmVyLiBFdmVyeSB0aW1lIHRoZQovLyBjbGllbnQgc2VuZHMgYSBQSU5HIHRvIHRoZSBzZXJ2ZXIsIHRoZSBzZXJ2ZXIgd2lsbCByZXNwb25kIHdpdGgKLy8gYSBQT05HLgpPVC5SdW1vci5NZXNzYWdlLlBpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IE9ULlJ1bW9yLk1lc3NhZ2UoT1QuUnVtb3IuTWVzc2FnZVR5cGUuUElORywgW10sIFtdLCAiIik7Cn07Cgp9KHRoaXMpKTsKKGZ1bmN0aW9uKGdsb2JhbCkgewoKLy8gUnVtb3IgTWVzc2FnaW5nIGZvciBKUwovLwovLyBodHRwczovL3Rid2lraS50b2tib3guY29tL2luZGV4LnBocC9SYXB0b3JfTWVzc2FnZXNfKFNlbnRfYXNfYV9SdW1vck1lc3NhZ2VfcGF5bG9hZF9pbl9KU09OKQovLwovLyBAdG9kbyBSYXB0b3IgewovLyAgICAgTG9vayBhdCBkaXNjb25uZWN0aW9uIGNsZWFudXA6IGkuZS4gc3Vic2NyaWJlciArIHB1Ymxpc2hlciBjbGVhbnVwCi8vICAgICBBZGQgZXJyb3IgY29kZXMgZm9yIGFsbCB0aGUgZXJyb3IgY2FzZXMKLy8gICAgIFdyaXRlIHVuaXQgdGVzdHMgZm9yIFNlc3Npb25JbmZvCi8vICAgICBXcml0ZSB1bml0IHRlc3RzIGZvciBTZXNzaW9uCi8vICAgICBNYWtlIHVzZSBvZiB0aGUgbmV3IERlc3Ryb3llZEV2ZW50Ci8vICAgICBNb3ZlIEFuYWx5dGljcyBvdXQgb2YgUmFwdG9yIGludG8gU2Vzc2lvbgovLyAgICAgUmVtb3ZlIGRlcGVuZGVuY3kgb24gT1QucHJvcGVydGllcwovLyAgICAgT1QuQ2FwYWJpbGl0aWVzIG11c3QgYmUgcGFydCBvZiB0aGUgUmFwdG9yIG5hbWVzcGFjZQovLyAgICAgQWRkIERlcGVuZGFiaWxpdHkgY29tbWFuZHMKLy8gICAgIFRoaW5rIGFib3V0IG5vQ29uZmxpY3QsIG9yIHdoZXRoZXIgd2Ugc2hvdWxkIGp1c3QgdXNlIHRoZSBPVCBuYW1lc3BhY2UKLy8gICAgIFRoaW5rIGFib3V0IGhvdyB0byBleHBvc2UgT1QucHVibGlzaGVycywgT1Quc3Vic2NyaWJlcnMsIGFuZCBPVC5zZXNzaW9ucyBpZiBtZXNzYWdpbmcgd2FzCi8vICAgICAgICBiZWluZyBpbmNsdWRlZCBhcyBhIGNvbXBvbmVudAovLyAgICAgQW5vdGhlciBzb2x1dGlvbiB0byB0aGUgcHJvYmxlbSBvZiBoYXZpbmcgcHVibGlzaGVycy9zdWJzY3JpYmVycy9ldGMgd291bGQgYmUgdG8gbWFrZQovLyAgICAgICAgUmFwdG9yIFNvY2tldCBhIHNlcGFyYXRlIGNvbXBvbmVudCBmcm9tIERpc3BhdGNoIChkaXNwYXRjaCBiZWluZyBtb3JlIGJ1c2luZXNzIGxvZ2ljKQovLyAgICAgTG9vayBhdCB0aGUgY291cGxpbmcgb2YgT1Quc2Vzc2lvbnMgdG8gT1QuUmFwdG9yLlNvY2tldAovLyB9Ci8vCi8vIEB0b2RvIFJhcHRvciBEb2NzIHsKLy8gICBEb2N1bWVudCBwYXlsb2FkIGZvcm1hdHMgZm9yIGluY29taW5nIG1lc3NhZ2VzICh3aGF0IGFyZSB0aGUgcGF5bG9hZHMgZm9yIFNUUkVBTSBDUkVBVEVEL01PRElGSUVEIGZvciBleGFtcGxlKQovLyAgIERvY3VtZW50IGhvdyBrZWVwYWxpdmVzIHdvcmsKLy8gICBEb2N1bWVudCBhbGwgdGhlIFJhcHRvciBhY3Rpb25zIGFuZCB0eXBlcwovLyAgIERvY3VtZW50IHRoZSBzZXNzaW9uIGNvbm5lY3QgZmxvdyAoaW5jbHVkaW5nIGVycm9yIGNhc2VzKQovLyB9CgoKT1QuUmFwdG9yID0gewogIEFjdGlvbnM6IHsKICAgIC8vR2VuZXJhbAogICAgQ09OTkVDVDogMTAwLAogICAgQ1JFQVRFOiAxMDEsCiAgICBVUERBVEU6IDEwMiwKICAgIERFTEVURTogMTAzLAogICAgU1RBVEU6IDEwNCwKCiAgICAvL01vZGVyYXRpb24KICAgIEZPUkNFX0RJU0NPTk5FQ1Q6IDEwNSwKICAgIEZPUkNFX1VOUFVCTElTSDogMTA2LAogICAgU0lHTkFMOiAxMDcsCgogICAgLy9BcmNoaXZlcwogICAgQ1JFQVRFX0FSQ0hJVkU6IDEwOCwKICAgIENMT1NFX0FSQ0hJVkU6IDEwOSwKICAgIFNUQVJUX1JFQ09SRElOR19TRVNTSU9OOiAxMTAsCiAgICBTVE9QX1JFQ09SRElOR19TRVNTSU9OOiAxMTEsCiAgICBTVEFSVF9SRUNPUkRJTkdfU1RSRUFNOiAxMTIsCiAgICBTVE9QX1JFQ09SRElOR19TVFJFQU06IDExMywKICAgIExPQURfQVJDSElWRTogMTE0LAogICAgU1RBUlRfUExBWUJBQ0s6IDExNSwKICAgIFNUT1BfUExBWUJBQ0s6IDExNiwKCiAgICAvL0FwcFN0YXRlCiAgICBBUFBTVEFURV9QVVQ6IDExNywKICAgIEFQUFNUQVRFX0RFTEVURTogMTE4LAoKICAgIC8vIEpTRVAKICAgIE9GRkVSOiAxMTksCiAgICBBTlNXRVI6IDEyMCwKICAgIFBSQU5TV0VSOiAxMjEsCiAgICBDQU5ESURBVEU6IDEyMiwKICAgIFNVQlNDUklCRTogMTIzLAogICAgVU5TVUJTQ1JJQkU6IDEyNCwKICAgIFFVRVJZOiAxMjUsCiAgICBTRFBfQU5TV0VSOiAxMjYsCgogICAgLy9LZWVwQWxpdmUKICAgIFBPTkc6IDEyNywKICAgIFJFR0lTVEVSOiAxMjgsIC8vVXNlZCBmb3IgcmVnaXN0ZXJpbmcgc3RyZWFtcy4KCiAgICBRVUFMSVRZX0NIQU5HRUQ6IDEyOQogIH0sCgogIFR5cGVzOiB7CiAgICAgIC8vUlBDCiAgICAgIFJQQ19SRVFVRVNUOiAxMDAsCiAgICAgIFJQQ19SRVNQT05TRTogMTAxLAoKICAgICAgLy9FVkVOVAogICAgICBTVFJFQU06IDEwMiwKICAgICAgQVJDSElWRTogMTAzLAogICAgICBDT05ORUNUSU9OOiAxMDQsCiAgICAgIEFQUFNUQVRFOiAxMDUsCiAgICAgIENPTk5FQ1RJT05DT1VOVDogMTA2LAogICAgICBNT0RFUkFUSU9OOiAxMDcsCiAgICAgIFNJR05BTDogMTA4LAogICAgICBTVUJTQ1JJQkVSOiAxMTAsCgogICAgICAvL0pTRVAgUHJvdG9jb2wKICAgICAgSlNFUDogMTA5CiAgfQp9OwoKCn0odGhpcykpOwooZnVuY3Rpb24oZ2xvYmFsKSB7CgovLy8vIFNvbWUgaGVscGVyIGZ1bmN0aW9ucyB0aGF0IGFyZSB1c2VkIGZvciBkZWJ1Z2dpbmcgYW5kIGxvZ2dpbmcKCnZhciB0eXBlVG9OYW1lID0ge30sCiAgICBhY3Rpb25Ub05hbWUgPSB7fTsKCi8vIENyZWF0ZSBhIGxvb2t1cCB0YWJsZSBvZiBSYXB0b3IgbWVzc2FnZSB0eXBlcyAoaW50ZWdlcikgdG8gYSBodW1hbiByZWFkYWJsZSBzdHJpbmdzCnZhciBtZXNzYWdlVHlwZXMgPSBPVC5SYXB0b3IuVHlwZXM7CmZvciAodmFyIG5hbWUgaW4gbWVzc2FnZVR5cGVzKSB7CiAgdHlwZVRvTmFtZVttZXNzYWdlVHlwZXNbbmFtZV1dID0gbmFtZTsKfQoKLy8gQ3JlYXRlIGEgbG9va3VwIHRhYmxlIG9mICBSYXB0b3IgbWVzc2FnZSBhY3Rpb25zIChpbnRlZ2VyKSB0byBhIGh1bWFuIHJlYWRhYmxlIHN0cmluZ3MKdmFyIG1lc3NhZ2VBY3Rpb25zID0gT1QuUmFwdG9yLkFjdGlvbnM7CmZvciAodmFyIG5hbWUgaW4gbWVzc2FnZUFjdGlvbnMpIHsKICBhY3Rpb25Ub05hbWVbbWVzc2FnZUFjdGlvbnNbbmFtZV1dID0gbmFtZTsKfQoKCk9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTsKfTsKCgovLyBEZXNlcmlhbGlzaW5nIGEgUmFwdG9yIG1lc3NhZ2UgbWFpbmx5IG1lYW5zIGRvaW5nIGEgSlNPTi5wYXJzZSBvbiBpdC4KLy8gV2UgZG8gZGVjb3JhdGUgdGhlIGZpbmFsIG1lc3NhZ2Ugd2l0aCBhIGZldyBleHRyYSBoZWxwZXIgcHJvcGVyaWVzIHRob3VnaC4KLy8KLy8gVGhlc2UgaW5jbHVkZToKLy8gKiB0eXBlTmFtZTogQSBodW1hbiByZWFkYWJsZSB2ZXJzaW9uIG9mIHRoZSBSYXB0b3IgdHlwZS4gRS5nLiBTVFJFQU0gaW5zdGVhZCBvZiAxMDIKLy8gKiBhY3Rpb25OYW1lOiBBIGh1bWFuIHJlYWRhYmxlIHZlcnNpb24gb2YgdGhlIFJhcHRvciBhY3Rpb24uIEUuZy4gQ1JFQVRFIGluc3RlYWQgb2YgMTAxCi8vICogc2lnbmF0dXJlOiB0eXBlTmFtZSBhbmQgYWN0aW9uTmFtZSBjb21iaW5lZC4gVGhpcyBpcyBtYWlubHkgZm9yIGRlYnVnZ2luZy4gRS5nLiBBIHR5cGUKLy8gICAgb2YgMTAyIGFuZCBhbiBhY3Rpb24gb2YgMTAxIHdvdWxkIHJlc3VsdCBpbiBhIHNpZ25hdHVyZSBvZiAiU1RSRUFNOkNSRUFURSIKLy8KT1QuUmFwdG9yLmRlc2VyaWFsaXplTWVzc2FnZSA9IGZ1bmN0aW9uIChtc2cpIHsKICB2YXIgbWVzc2FnZSA9IEpTT04ucGFyc2UobXNnKTsKCiAgaWYgKG1lc3NhZ2UudHlwZSkgewogICAgbWVzc2FnZS50eXBlID0gcGFyc2VJbnQobWVzc2FnZS50eXBlLCAxMCk7CiAgICBtZXNzYWdlLnR5cGVOYW1lID0gdHlwZVRvTmFtZVttZXNzYWdlLnR5cGVdIHx8IG51bGw7CiAgfQoKICBpZiAobWVzc2FnZS5hY3Rpb24pIHsKICAgIG1lc3NhZ2UuYWN0aW9uID0gcGFyc2VJbnQobWVzc2FnZS5hY3Rpb24sIDEwKTsKICAgIG1lc3NhZ2UuYWN0aW9uTmFtZSA9IGFjdGlvblRvTmFtZVttZXNzYWdlLmFjdGlvbl0gfHwgbnVsbDsKICB9CgogIG1lc3NhZ2Uuc2lnbmF0dXJlID0gbWVzc2FnZS50eXBlTmFtZSArICc6JyArIG1lc3NhZ2UuYWN0aW9uTmFtZTsKCiAgcmV0dXJuIG1lc3NhZ2U7Cn07CgoKT1QuUmFwdG9yLk1lc3NhZ2UgPSB7fTsKT1QuUmFwdG9yLk1lc3NhZ2UuY29ubmVjdCA9IGZ1bmN0aW9uICh3aWRnZXRJZCwgY29ubmVjdGlvbklkLCBzZXNzaW9uSWQsIGFwaUtleSwgdG9rZW4sIHAycEVuYWJsZWQpIHsKICB2YXIgcGF5bG9hZCA9IHsKICAgICAgICBjcmVkZW50aWFsczogewogICAgICAgICAgY29ubmVjdGlvbklkOiBjb25uZWN0aW9uSWQsCiAgICAgICAgICBzb0FjY2Vzc1N0YXRlOiAyLAogICAgICAgICAgc3VwcG9ydHNXZWJSVEM6IHRydWUsCiAgICAgICAgICBwMnBFbmFibGVkOiBwMnBFbmFibGVkLAogICAgICAgICAgR1VJRDogd2lkZ2V0SWQsCiAgICAgICAgICB3aWRnZXRJZDogd2lkZ2V0SWQsCiAgICAgICAgICBwYXJ0bmVySWQ6IGFwaUtleQogICAgICAgIH0sCiAgICAgICAgc2Vzc2lvbklkOiBzZXNzaW9uSWQsCiAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgIHRva2VuUGVybWlzc2lvbnM6IHsKICAgICAgICAgICAgICAgIGFwaUtleTogYXBpS2V5CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRva2VuOiB0b2tlbgogICAgICAgIH0sCiAgICAgICAgdW5pcXVlSWQ6IGNvbm5lY3Rpb25JZAogICAgICB9OwoKICByZXR1cm4gT1QuUmFwdG9yLnNlcmlhbGl6ZU1lc3NhZ2UoewogICAgaWQ6IE9ULiQudXVpZCgpLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlJQQ19SRVFVRVNULAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5DT05ORUNULAogICAgcGF5bG9hZDogcGF5bG9hZCwKICAgIHJlcGx5VG86IGNvbm5lY3Rpb25JZAogIH0pOwp9OwoKCk9ULlJhcHRvci5NZXNzYWdlLmdldFNlc3Npb25TdGF0ZSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQsIHNlc3Npb25JZCwgY29ubmVjdGlvbnNSZXF1aXJlZCkgewogIHJldHVybiBPVC5SYXB0b3Iuc2VyaWFsaXplTWVzc2FnZSh7CiAgICBpZDogT1QuJC51dWlkKCksCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuUlBDX1JFUVVFU1QsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLlNUQVRFLAogICAgcGF5bG9hZDogewogICAgICBzZXNzaW9uSWQ6IHNlc3Npb25JZCwKICAgICAgY29ubmVjdGlvbnNSZXF1aXJlZDogY29ubmVjdGlvbnNSZXF1aXJlZCB8fCB0cnVlCiAgICB9LAogICAgcmVwbHlUbzogY29ubmVjdGlvbklkCiAgfSk7Cn07CgoKT1QuUmFwdG9yLk1lc3NhZ2UuZm9yY2VEaXNjb25uZWN0ID0gZnVuY3Rpb24gKGZyb21Db25uZWN0aW9uSWQsIGNvbm5lY3Rpb25JZFRvRGlzY29ubmVjdCwgc2Vzc2lvbklkKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlJQQ19SRVFVRVNULAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5GT1JDRV9ESVNDT05ORUNULAogICAgcGF5bG9hZDogewogICAgICBjb25uZWN0aW9uSWQ6IGNvbm5lY3Rpb25JZFRvRGlzY29ubmVjdCwKICAgICAgc2Vzc2lvbklkOiBzZXNzaW9uSWQKICAgIH0sCiAgICByZXBseVRvOiBmcm9tQ29ubmVjdGlvbklkCiAgfSk7Cn07CgoKCk9ULlJhcHRvci5NZXNzYWdlLnN0cmVhbUNyZWF0ZSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQsIHNlc3Npb25JZCwgcHVibGlzaGVySWQsIG5hbWUsIHZpZGVvT3JpZW50YXRpb24sIHZpZGVvV2lkdGgsIHZpZGVvSGVpZ2h0LCBoYXNBdWRpbywgaGFzVmlkZW8sIHAycEVuYWJsZWQpIHsKICB2YXIgcGF5bG9hZCA9IHsKICAgIGtleTogc2Vzc2lvbklkLAogICAgdmFsdWU6IHsKICAgICAgcDJwRW5hYmxlZDogcDJwRW5hYmxlZCB8fCBmYWxzZSwKICAgICAgcHVibGlzaGVySWQ6IHB1Ymxpc2hlcklkLAogICAgICBjb25uZWN0aW9uOiB7CiAgICAgICAgICBjb25uZWN0aW9uSWQ6IGNvbm5lY3Rpb25JZAogICAgICB9LAogICAgICB0eXBlOiAiV2ViUlRDIiwKICAgICAgbmFtZTogbmFtZSB8fCAnJywKICAgICAgY3JlYXRpb25UaW1lOiBEYXRlLm5vdygpLCAgIC8vIFVuaXggdGltZXN0YW1wLCB0aW1lIGluIG1pbGxpc2Vjb25kcyBzaW5jZSAxOTcwIFVUQwogICAgICBvcmllbnRhdGlvbjogewogICAgICAgICAgd2lkdGg6IHZpZGVvV2lkdGgsCiAgICAgICAgICBoZWlnaHQ6IHZpZGVvSGVpZ2h0LAogICAgICAgICAgdmlkZW9PcmllbnRhdGlvbjogdmlkZW9PcmllbnRhdGlvbiB8fCAiT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZE5vcm1hbCIKICAgICAgfSwKICAgICAgaGFzQXVkaW86IGhhc0F1ZGlvICE9PSB2b2lkIDAgPyBoYXNBdWRpbyA6IHRydWUsCiAgICAgIGhhc1ZpZGVvOiBoYXNWaWRlbyAhPT0gdm9pZCAwID8gaGFzVmlkZW8gOiB0cnVlCiAgICB9CiAgfTsKCiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBjb25uZWN0aW9uSWQsIC8vIEhBQ0sgdW50aWwgYnVmIGZpeGVkIGluIHN5bXBob255CiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuU1RSRUFNLAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5DUkVBVEUsCiAgICBwYXlsb2FkOiBwYXlsb2FkLAogICAgcmVwbHlUbzogJycKICB9KTsKfTsKCgpPVC5SYXB0b3IuTWVzc2FnZS5zdHJlYW1EZXN0cm95ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCwgc2Vzc2lvbklkLCBzdHJlYW1JZCkgewogIHJldHVybiBPVC5SYXB0b3Iuc2VyaWFsaXplTWVzc2FnZSh7CiAgICBpZDogY29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlNUUkVBTSwKICAgIGFjdGlvbjogT1QuUmFwdG9yLkFjdGlvbnMuREVMRVRFLAogICAgcGF5bG9hZDogewogICAgICBrZXk6IHNlc3Npb25JZCArICIvU1RSRUFNUy8iICsgc3RyZWFtSWQKICAgIH0sCiAgICByZXBseVRvOiBjb25uZWN0aW9uSWQKICB9KTsKfTsKCgpPVC5SYXB0b3IuTWVzc2FnZS5zdHJlYW1Nb2RpZnkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkLCBzZXNzaW9uSWQsIHN0cmVhbUlkLCBrZXksIHZhbHVlKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBjb25uZWN0aW9uSWQsCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuU1RSRUFNLAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5VUERBVEUsCiAgICBwYXlsb2FkOiB7CiAgICAgIGtleTogW3Nlc3Npb25JZCwgJ1NUUkVBTVMnLCBzdHJlYW1JZCwga2V5XS5qb2luKCcvJyksCiAgICAgIHZhbHVlOiB2YWx1ZQogICAgfSwKICAgIHJlcGx5VG86IGNvbm5lY3Rpb25JZAogIH0pOwp9OwoKT1QuUmFwdG9yLk1lc3NhZ2UuZm9yY2VVbnB1Ymxpc2ggPSBmdW5jdGlvbiAoZnJvbUNvbm5lY3Rpb25JZCwgc2Vzc2lvbklkLCBzdHJlYW1JZFRvVW5wdWJsaXNoKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlJQQ19SRVFVRVNULAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5GT1JDRV9VTlBVQkxJU0gsCiAgICBwYXlsb2FkOiB7CiAgICAgIHNlc3Npb25JZDogc2Vzc2lvbklkLAogICAgICBjb25uZWN0aW9uSWQ6IGZyb21Db25uZWN0aW9uSWQsCiAgICAgIHN0cmVhbUlkOiBzdHJlYW1JZFRvVW5wdWJsaXNoLAogICAgICB3ZWJSVENTdHJlYW06IHRydWUKICAgIH0sCiAgICByZXBseVRvOiBmcm9tQ29ubmVjdGlvbklkCiAgfSk7Cn07CgoKT1QuUmFwdG9yLk1lc3NhZ2UuanNlcE9mZmVyID0gZnVuY3Rpb24gKGZyb21Db25uZWN0aW9uSWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgc2RwKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLkpTRVAsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLk9GRkVSLAogICAgcGF5bG9hZDogewogICAgICBmcm9tQWRkcmVzczogZnJvbUNvbm5lY3Rpb25JZCwKICAgICAgdG9BZGRyZXNzZXM6IHRvQ29ubmVjdGlvbklkLAogICAgICBzZHA6IHNkcCwKICAgICAgc3RyZWFtSWQ6IHN0cmVhbUlkCiAgICB9LAogICAgcmVwbHlUbzogZnJvbUNvbm5lY3Rpb25JZAogIH0pOwp9OwoKCk9ULlJhcHRvci5NZXNzYWdlLmpzZXBBbnN3ZXIgPSBmdW5jdGlvbiAoZnJvbUNvbm5lY3Rpb25JZCwgdG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkLCBzZHApIHsKICByZXR1cm4gT1QuUmFwdG9yLnNlcmlhbGl6ZU1lc3NhZ2UoewogICAgaWQ6IGZyb21Db25uZWN0aW9uSWQsCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuSlNFUCwKICAgIGFjdGlvbjogT1QuUmFwdG9yLkFjdGlvbnMuQU5TV0VSLAogICAgcGF5bG9hZDogewogICAgICBmcm9tQWRkcmVzczogZnJvbUNvbm5lY3Rpb25JZCwKICAgICAgdG9BZGRyZXNzZXM6IHRvQ29ubmVjdGlvbklkLAogICAgICBzZHA6IHNkcCwKICAgICAgc3RyZWFtSWQ6IHN0cmVhbUlkCiAgICB9LAogICAgcmVwbHlUbzogZnJvbUNvbm5lY3Rpb25JZAogIH0pOwp9OwoKT1QuUmFwdG9yLk1lc3NhZ2UuanNlcFN1YnNjcmliZSA9IGZ1bmN0aW9uIChmcm9tQ29ubmVjdGlvbklkLCB0b0Nvbm5lY3Rpb25JZCwgc3RyZWFtSWQsIHN1YnNjcmliZVRvVmlkZW8sIHN1YnNjcmliZVRvQXVkaW8pIHsKICByZXR1cm4gT1QuUmFwdG9yLnNlcmlhbGl6ZU1lc3NhZ2UoewogICAgaWQ6IGZyb21Db25uZWN0aW9uSWQsCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuSlNFUCwKICAgIGFjdGlvbjogT1QuUmFwdG9yLkFjdGlvbnMuU1VCU0NSSUJFLAogICAgcGF5bG9hZDogewogICAgICBrZXlNYW5hZ2VtZW5NZXRob2Q6IE9ULiQuc3VwcG9ydGVkQ3J5cHRvU2NoZW1lKCksCiAgICAgIGJ1bmRsZVN1cHBvcnQ6IE9ULiQuc3VwcG9ydHNCdW5kbGUoKSwKICAgICAgcnRjcE11eFN1cHBvcnQ6IE9ULiQuc3VwcG9ydHNSdGNwTXV4KCksCiAgICAgIGZyb21BZGRyZXNzOiBmcm9tQ29ubmVjdGlvbklkLAogICAgICB0b0FkZHJlc3NlczogdG9Db25uZWN0aW9uSWQsCiAgICAgIHN0cmVhbUlkOiBzdHJlYW1JZCwKICAgICAgaGFzVmlkZW86IHN1YnNjcmliZVRvVmlkZW8sCiAgICAgIGhhc0F1ZGlvOiBzdWJzY3JpYmVUb0F1ZGlvCiAgICB9LAogICAgcmVwbHlUbzogZnJvbUNvbm5lY3Rpb25JZAogIH0pOwp9OwoKCgpPVC5SYXB0b3IuTWVzc2FnZS5qc2VwVW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZnJvbUNvbm5lY3Rpb25JZCwgdG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLkpTRVAsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLlVOU1VCU0NSSUJFLAogICAgcGF5bG9hZDogewogICAgICBmcm9tQWRkcmVzczogZnJvbUNvbm5lY3Rpb25JZCwKICAgICAgdG9BZGRyZXNzZXM6IHRvQ29ubmVjdGlvbklkLAogICAgICBzdHJlYW1JZDogc3RyZWFtSWQKICAgIH0sCiAgICByZXBseVRvOiBmcm9tQ29ubmVjdGlvbklkCiAgfSk7Cn07CgpPVC5SYXB0b3IuTWVzc2FnZS5qc2VwQ2FuZGlkYXRlID0gZnVuY3Rpb24gKGZyb21Db25uZWN0aW9uSWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgY2FuZGlkYXRlKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLkpTRVAsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLkNBTkRJREFURSwKICAgIHBheWxvYWQ6IHsKICAgICAgZnJvbUFkZHJlc3M6IGZyb21Db25uZWN0aW9uSWQsCiAgICAgIHRvQWRkcmVzc2VzOiB0b0Nvbm5lY3Rpb25JZCwKICAgICAgY2FuZGlkYXRlOiBjYW5kaWRhdGUsCiAgICAgIHN0cmVhbUlkOiBzdHJlYW1JZAogICAgfSwKICAgIHJlcGx5VG86IGZyb21Db25uZWN0aW9uSWQKICB9KTsKfTsKCk9ULlJhcHRvci5NZXNzYWdlLnN1YnNjcmliZXJNb2RpZnkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkLCBzZXNzaW9uSWQsIHN0cmVhbUlkLCBzdWJzY3JpYmVySWQsIGtleSwgdmFsdWUpIHsKICByZXR1cm4gT1QuUmFwdG9yLnNlcmlhbGl6ZU1lc3NhZ2UoewogICAgaWQ6IE9ULiQudXVpZCgpLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlNVQlNDUklCRVIsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLlVQREFURSwKICAgIHBheWxvYWQ6IHsKICAgICAga2V5OiBbc2Vzc2lvbklkLCAnU1VCU0NSSUJFUicsIHN0cmVhbUlkLCBjb25uZWN0aW9uSWQsIGtleV0uam9pbignLycpLAogICAgICB2YWx1ZTogdmFsdWUKICAgIH0sCiAgICByZXBseVRvOiBjb25uZWN0aW9uSWQKICB9KTsKfTsKCgpPVC5SYXB0b3IuTWVzc2FnZS5zaWduYWwgPSBmdW5jdGlvbihjb25uZWN0aW9uSWQsIHNlc3Npb25JZCwgdHlwZSwgdG8sIGRhdGEpIHsKICB2YXIgcGF5bG9hZCA9IHsKICAgIGlkOiBPVC4kLnV1aWQoKSwKICAgIGZyb21BZGRyZXNzOiBjb25uZWN0aW9uSWQKICB9OwoKICAvLyBNYXNzYWdlIHRoZSB0byBmaWVsZCBpbnRvIGFuIGFycmF5IGFuZCBkZWZhdWx0IGl0IHRvIHRoZSBzZXNzaW9uIGlkCiAgLy8gaWYgd2UncmUgc2VuZGluZyB0byBubyBvbmUKICBpZiAodG8gJiYgIUFycmF5LmlzQXJyYXkodG8pKSB7CiAgICBwYXlsb2FkLnRvQWRkcmVzc2VzID0gW3RvXTsKICB9CiAgZWxzZSBpZiAoIXRvIHx8IHRvLmxlbmd0aCA9PT0gMCkgewogICAgLy8gaWYgaXQgd2FzIG9taXR0ZWQgdGhlbiB3ZSdsbCBzZW5kIHRoZSBzaWduYWwgdG8gdGhlIGVudGlyZSBzZXNzaW9uLgogICAgcGF5bG9hZC50b0FkZHJlc3NlcyA9IFtzZXNzaW9uSWRdOwogIH0KICBlbHNlIHsKICAgIHBheWxvYWQudG9BZGRyZXNzZXMgPSB0bzsKICB9CgogIGlmICh0eXBlICE9PSB2b2lkIDApIHBheWxvYWQudHlwZSA9IHR5cGU7CiAgaWYgKGRhdGEgIT09IHZvaWQgMCkgcGF5bG9hZC5kYXRhID0gZGF0YTsKCiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBjb25uZWN0aW9uSWQsCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuU0lHTkFMLAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5TSUdOQUwsCiAgICBwYXlsb2FkOiBwYXlsb2FkLAogICAgcmVwbHlUbzogY29ubmVjdGlvbklkCiAgfSk7Cn07Cgp9KHRoaXMpKTsKKGZ1bmN0aW9uKGdsb2JhbCkgewoKdmFyIE1BWF9TSUdOQUxfREFUQV9MRU5HVEggPSA4MTkyOwp2YXIgTUFYX1NJR05BTF9UWVBFX0xFTkdUSCA9IDEyODsKCi8vCi8vIEVycm9yIENvZGVzOgovLyA0MTMgLSBUeXBlIHRvbyBsb25nCi8vIDQwMCAtIFR5cGUgaXMgaW52YWxpZAovLyA0MTMgLSBEYXRhIHRvbyBsb25nCi8vIDQwMCAtIERhdGEgaXMgaW52YWxpZCAoY2FuJ3QgYmUgcGFyc2VkIGFzIEpTT04pCi8vIDQyOSAtIFJhdGUgbGltaXQgZXhjZWVkZWQKLy8gNTAwIC0gV2Vic29ja2V0IGNvbm5lY3Rpb24gaXMgZG93bgovLyA0MDQgLSBUbyBjb25uZWN0aW9uIGRvZXMgbm90IGV4aXN0Ci8vIDQwMCAtIFRvIGlzIGludmFsaWQKLy8KT1QuU2lnbmFsID0gZnVuY3Rpb24oc2Vzc2lvbklkLCBmcm9tQ29ubmVjdGlvbklkLCBvcHRpb25zKSB7CiAgdmFyIGlzSW52YWxpZFR5cGUgPSBmdW5jdGlvbih0eXBlKSB7CiAgICAgIC8vIE91ciBmb3JtYXQgbWF0Y2hlcyB0aGUgdW5yZXNlcnZlZCBjaGFyYWN0ZXJzIGZyb20gdGhlIFVSSSBSRkM6IGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYKICAgICAgcmV0dXJuICEvXlthLXpBLVowLTlcLVwuX35dKyQvLmV4ZWModHlwZSk7CiAgICB9LAoKICAgIHZhbGlkYXRlVG8gPSBmdW5jdGlvbih0b0FkZHJlc3MpIHsKICAgICAgaWYgKCF0b0FkZHJlc3MpIHsKICAgICAgICByZXR1cm4ge2NvZGU6IDQwMCwgcmVhc29uOiAiVGhlIHNpZ25hbCB0eXBlIHdhcyBudWxsIG9yIGFuIGVtcHR5IFN0cmluZy4gRWl0aGVyIHNldCBpdCB0byBhIG5vbi1lbXB0eSBTdHJpbmcgdmFsdWUgb3Igb21pdCBpdCJ9OwogICAgICB9CiAgICAgIGVsc2UgaWYgKCAhQXJyYXkuaXNBcnJheSh0b0FkZHJlc3MpICkgewogICAgICAgIHJldHVybiB7Y29kZTogNDAwLCByZWFzb246ICJUaGUgVG8gZmllbGQgd2FzIGludmFsaWQifTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaT0wOyBpPHRvQWRkcmVzcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICggISh0b0FkZHJlc3NbaV0gaW5zdGFuY2VvZiBPVC5Db25uZWN0aW9uIHx8IHRvQWRkcmVzc1tpXSBpbnN0YW5jZW9mIE9ULlNlc3Npb24pICkgewogICAgICAgICAgcmV0dXJuIHtjb2RlOiA0MDAsIHJlYXNvbjogIlRoZSBUbyBmaWVsZCB3YXMgaW52YWxpZCJ9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIHZhbGlkYXRlVHlwZSA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgdmFyIGVycm9yID0gbnVsbDsKCiAgICAgIGlmICh0eXBlID09PSBudWxsIHx8IHR5cGUgPT09IHZvaWQgMCkgewogICAgICAgIGVycm9yID0ge2NvZGU6IDQwMCwgcmVhc29uOiAiVGhlIHNpZ25hbCB0eXBlIHdhcyBudWxsIG9yIHVuZGVmaW5lZC4gRWl0aGVyIHNldCBpdCB0byBhIFN0cmluZyB2YWx1ZSBvciBvbWl0IGl0In07CiAgICAgIH0KICAgICAgZWxzZSBpZiAodHlwZS5sZW5ndGggPiBNQVhfU0lHTkFMX1RZUEVfTEVOR1RIKSB7CiAgICAgICAgZXJyb3IgPSB7Y29kZTogNDEzLCByZWFzb246ICJUaGUgc2lnbmFsIHR5cGUgd2FzIHRvbyBsb25nLCB0aGUgbWF4aW11bSBsZW5ndGggb2YgaXQgaXMgIiArIE1BWF9TSUdOQUxfVFlQRV9MRU5HVEggKyAiIGNoYXJhY3RlcnMifTsKICAgICAgfQogICAgICBlbHNlIGlmICggaXNJbnZhbGlkVHlwZSh0eXBlKSApIHsKICAgICAgICBlcnJvciA9IHtjb2RlOiA0MDAsIHJlYXNvbjogIlRoZSBzaWduYWwgdHlwZSB3YXMgaW52YWxpZCwgaXQgY2FuIG9ubHkgY29udGFpbiBsZXR0ZXJzLCBudW1iZXJzLCAnLScsICdfJywgYW5kICd+Jy4ifTsKICAgICAgfQoKICAgICAgcmV0dXJuIGVycm9yOwogICAgfSwKCiAgICB2YWxpZGF0ZURhdGEgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHZhciBlcnJvciA9IG51bGw7CiAgICAgIGlmIChkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCkgewogICAgICAgIGVycm9yID0ge2NvZGU6IDQwMCwgcmVhc29uOiAiVGhlIHNpZ25hbCBkYXRhIHdhcyBudWxsIG9yIHVuZGVmaW5lZC4gRWl0aGVyIHNldCBpdCB0byBhIFN0cmluZyB2YWx1ZSBvciBvbWl0IGl0In07CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShkYXRhKS5sZW5ndGggPiBNQVhfU0lHTkFMX0RBVEFfTEVOR1RIKSB7CiAgICAgICAgICAgIGVycm9yID0ge2NvZGU6IDQxMywgcmVhc29uOiAiVGhlIGRhdGEgZmllbGQgd2FzIHRvbyBsb25nLCB0aGUgbWF4aW11bSBzaXplIG9mIGl0IGlzICIgKyBNQVhfU0lHTkFMX0RBVEFfTEVOR1RIICsgIiBjaGFyYWN0ZXJzIn07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoKGUpIHsKICAgICAgICAgIGVycm9yID0ge2NvZGU6IDQwMCwgcmVhc29uOiAiVGhlIGRhdGEgZmllbGQgd2FzIG5vdCB2YWxpZCBKU09OIn07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZXJyb3I7CiAgICB9OwoKCiAgdGhpcy50b1JhcHRvck1lc3NhZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0bzsKCiAgICBpZiAodGhpcy50bykgewogICAgICB0byA9IHRoaXMudG8ubWFwKGZ1bmN0aW9uKHRoaW5nKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZih0aGluZykgPT09ICdzdHJpbmcnID8gdGhpbmcgOiB0aGluZy5pZDsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIE9ULlJhcHRvci5NZXNzYWdlLnNpZ25hbChmcm9tQ29ubmVjdGlvbklkLCBzZXNzaW9uSWQsIHRoaXMudHlwZSwgdG8sIHRoaXMuZGF0YSk7CiAgfTsKCiAgdGhpcy50b0hhc2ggPSBmdW5jdGlvbigpIHsKICAgIHZhciBoID0gT1QuJC5jbG9uZShvcHRpb25zKTsKICAgIGlmIChoLnRvID09PSB2b2lkIDApIGgudG8gPSBudWxsOwogICAgaWYgKGguZGF0YSA9PT0gdm9pZCAwKSBoLmRhdGEgPSBudWxsOwoKICAgIHJldHVybiBoOwogIH07CgoKICB0aGlzLmVycm9yID0gbnVsbDsKCiAgaWYgKG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCdkYXRhJykpIHsKICAgICAgdGhpcy5kYXRhID0gT1QuJC5jbG9uZShvcHRpb25zLmRhdGEpOwogICAgICB0aGlzLmVycm9yID0gdmFsaWRhdGVEYXRhKHRoaXMuZGF0YSk7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ3RvJykpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9wdGlvbnMudG8pKSB7CiAgICAgICAgdGhpcy50byA9IFtvcHRpb25zLnRvXTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICB0aGlzLnRvID0gT1QuJC5jbG9uZShvcHRpb25zLnRvKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmVycm9yKSB0aGlzLmVycm9yID0gdmFsaWRhdGVUbyh0aGlzLnRvKQogICAgfQoKICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCd0eXBlJykpIHsKICAgICAgaWYgKCF0aGlzLmVycm9yKSB0aGlzLmVycm9yID0gdmFsaWRhdGVUeXBlKG9wdGlvbnMudHlwZSkKICAgICAgdGhpcy50eXBlID0gb3B0aW9ucy50eXBlOwogICAgfQogIH0KCiAgdGhpcy52YWxpZCA9IHRoaXMuZXJyb3IgPT09IG51bGw7Cn07Cgp9KHRoaXMpKTsKKGZ1bmN0aW9uKGdsb2JhbCkgewoKCmZ1bmN0aW9uIFNpZ25hbEVycm9yKGNvZGUsIHJlYXNvbiwgc2lnbmFsKSB7CiAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgdGhpcy5yZWFzb24gPSByZWFzb247CiAgICB0aGlzLnNpZ25hbCA9IHNpZ25hbDsKfQoKLy8gVGhlIERpc3BhdGNoZXIgYml0IGlzIHB1cmVseSB0byBtYWtlIHRlc3Rpbmcgc2ltcGxlciwgaXQgZGVmYXVsdHMgdG8gT1QuUmFwdG9yLkRpc3BhdGNoZXIKLy8gc28gaW4gbm9ybWFsIG9wZXJhdGlvbiB5b3Ugd291bGQgb21pdCBpdC4gTm90ZTogaXQgdGFrZXMgYSBjb25zdHJ1Y3Rvciwgbm90IGFuIGluc3RhbmNlLgpPVC5SYXB0b3IuU29ja2V0ID0gZnVuY3Rpb24od2lkZ2V0SWQsIG1lc3NhZ2luZ1NlcnZlciwgRGlzcGF0Y2hlcikgewogIHZhciBfc29ja2V0VXJsID0gT1QucHJvcGVydGllcy5tZXNzYWdpbmdQcm90b2NvbCArICI6Ly8iICsgbWVzc2FnaW5nU2VydmVyICsgIjoiICsgT1QucHJvcGVydGllcy5tZXNzYWdpbmdQb3J0ICsgIi9ydW1vcndlYnNvY2tldHN2MiIsCiAgICAgIF9zeW1waG9ueSA9ICJzeW1waG9ueS4iICsgbWVzc2FnaW5nU2VydmVyLAogICAgICBfc2Vzc2lvbklkLAogICAgICBfcnVtb3IsCiAgICAgIF9kaXNwYXRjaGVyLAogICAgICBfY29tcGxldGlvbiwKICAgICAgX2NhcGFiaWxpdGllcyA9IG5ldyBPVC5DYXBhYmlsaXRpZXMoW10pLAogICAgICBfYW5hbHl0aWNzID0gbmV3IE9ULkFuYWx5dGljcygpOwoKCiAgLy8vLyBQcml2YXRlIEFQSQogIHZhciBzZXRTdGF0ZSA9IE9ULiQuc3RhdGFibGUodGhpcywgWydkaXNjb25uZWN0ZWQnLCAnY29ubmVjdGluZycsICdjb25uZWN0ZWQnLCAnZXJyb3InLCAnZGlzY29ubmVjdGluZyddLCAnZGlzY29ubmVjdGVkJyksCgogICAgICBsb2dBbmFseXRpY3NFdmVudCA9IGZ1bmN0aW9uIGxvZ0FuYWx5dGljc0V2ZW50ICh2YXJpYXRpb24sIHBheWxvYWRUeXBlLCBwYXlsb2FkLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgICAgYWN0aW9uOiAnd2ViU29ja2V0Q29ubmVjdGlvbicsCiAgICAgICAgICB2YXJpYXRpb246IHZhcmlhdGlvbiwKICAgICAgICAgIHBheWxvYWRfdHlwZTogcGF5bG9hZFR5cGUsCiAgICAgICAgICBwYXlsb2FkOiBwYXlsb2FkLAogICAgICAgICAgc2Vzc2lvbl9pZDogX3Nlc3Npb25JZCwKICAgICAgICAgIHBhcnRuZXJfaWQ6IE9ULkFQSUtFWSwKICAgICAgICAgIHdpZGdldF9pZDogd2lkZ2V0SWQsCiAgICAgICAgICB3aWRnZXRfdHlwZTogJ0NvbnRyb2xsZXInCiAgICAgICAgfTsKCiAgICAgICAgaWYgKG9wdGlvbnMpIGV2ZW50ID0gT1QuJC5leHRlbmQob3B0aW9ucywgZXZlbnQpOwogICAgICAgIF9hbmFseXRpY3MubG9nRXZlbnQoZXZlbnQpOwogICAgICB9LAoKICAgICAgb25Db25uZWN0Q29tcGxldGUgPSBmdW5jdGlvbiBvbkNvbm5lY3RDb21wbGV0ZSAoZXJyb3IsIHNlc3Npb25TdGF0ZSkgewogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ0ZhaWx1cmUnLCAicmVhc29uIiwgZXJyb3IucmVhc29uKTsKCiAgICAgICAgICBzZXRTdGF0ZSgnZXJyb3InKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgnU3VjY2VzcycsICJ3ZWJTb2NrZXRTZXJ2ZXJVcmwiLCBfc29ja2V0VXJsLCB7Y29ubmVjdGlvbklkOiBfcnVtb3IuaWR9KTsKCiAgICAgICAgICBzZXRTdGF0ZSgnY29ubmVjdGVkJyk7CiAgICAgICAgICBfY2FwYWJpbGl0aWVzID0gbmV3IE9ULkNhcGFiaWxpdGllcyhzZXNzaW9uU3RhdGUucGVybWlzc2lvbnMpOwogICAgICAgIH0KCiAgICAgICAgX2NvbXBsZXRpb24uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgfSwKCiAgICAgIG9uQ2xvc2UgPSBmdW5jdGlvbiBvbkNsb3NlIChlcnIpIHsKICAgICAgICB2YXIgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChfc2Vzc2lvbklkKSwKICAgICAgICAgICAgY29ubmVjdGlvbiA9IHNlc3Npb24uY29ubmVjdGlvbiwKICAgICAgICAgICAgcmVhc29uID0gdGhpcy5pcygnZGlzY29ubmVjdGluZycpID8gImNsaWVudERpc2Nvbm5lY3RlZCIgOiAibmV0d29ya0Rpc2Nvbm5lY3RlZCI7CgogICAgICAgIGlmKGVyciAmJiBlcnIuY29kZSA9PSA0MDAxKSB7CiAgICAgICAgICByZWFzb24gPSAibmV0d29ya1RpbWVkb3V0IjsKICAgICAgICB9CgogICAgICAgIHNldFN0YXRlKCdkaXNjb25uZWN0ZWQnKTsKCiAgICAgICAgaWYgKCFjb25uZWN0aW9uKSByZXR1cm47CgogICAgICAgIGlmIChjb25uZWN0aW9uLmRlc3Ryb3llZFJlYXNvbikgewogICAgICAgICAgY29uc29sZS5kZWJ1ZygiT1QuUmFwdG9yLlNvY2tldDogU29ja2V0IHdhcyBjbG9zZWQgYnV0IHRoZSBjb25uZWN0aW9uIGhhZCBhbHJlYWR5IGJlZW4gZGVzdHJveWVkLiBSZWFzb246ICIgKyBjb25uZWN0aW9uLmRlc3Ryb3llZFJlYXNvbik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25uZWN0aW9uLmRlc3Ryb3koIHJlYXNvbiApOwogICAgICB9LmJpbmQodGhpcyksCgogICAgICBvbkVycm9yID0gZnVuY3Rpb24gb25FcnJvciAoKSB7CiAgICAgICAgLy8gQHRvZG8gd2hhdCBkb2VzIGhhdmluZyBhbiBlcnJvciBtZWFuPyBBcmUgdGhleSBhbHdheXMgZmF0YWw/IEFyZSB3ZSBkaXNjb25uZWN0ZWQgbm93PwogICAgICB9OwoKCiAgLy8vLyBQdWJsaWMgQVBJCgoKICAvLyBDaGVjayB3aGV0aGVyIHRoaXMgc29ja2V0IGNvbm5lY3Rpb24gaGFzIHBlcm1pc3Npb25zIHRvIHBlcmZvcm0gYSBwYXJ0aWN1bGFyCiAgLy8gYWN0aW9uLgogIHRoaXMucGVybWl0dGVkVG8gPSBmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgIHJldHVybiBfY2FwYWJpbGl0aWVzW2FjdGlvbl0gPT09IDE7CiAgfTsKCiAgdGhpcy5jb25uZWN0ID0gZnVuY3Rpb24gKHRva2VuLCBzZXNzaW9uSW5mbywgY29tcGxldGlvbikgewogICAgaWYgKCF0aGlzLmlzKCdkaXNjb25uZWN0ZWQnLCAnZXJyb3InKSkgewogICAgICBPVC53YXJuKCJDYW5ub3QgY29ubmVjdCB0aGUgUmFwdG9yIFNvY2tldCBhcyBpdCBpcyBjdXJyZW50bHkgY29ubmVjdGVkLiBZb3Ugc2hvdWxkIGRpc2Nvbm5lY3QgZmlyc3QuIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBzZXRTdGF0ZSgnY29ubmVjdGluZycpOwogICAgX3Nlc3Npb25JZCA9IHNlc3Npb25JbmZvLnNlc3Npb25JZDsKICAgIF9jb21wbGV0aW9uID0gY29tcGxldGlvbjsKCiAgICB2YXIgY29ubmVjdGlvbklkID0gT1QuJC51dWlkKCksCiAgICAgICAgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChfc2Vzc2lvbklkKTsKCgogICAgdmFyIGFuYWx5dGljc1BheWxvYWQgPSBbX3NvY2tldFVybCwgbmF2aWdhdG9yLnVzZXJBZ2VudCwgT1QucHJvcGVydGllcy52ZXJzaW9uLCB3aW5kb3cuZXh0ZXJuYWxIb3N0ID8gInllcyIgOiAibm8iXTsKICAgIGxvZ0FuYWx5dGljc0V2ZW50KAogICAgICAnQXR0ZW1wdCcsCiAgICAgICJ3ZWJTb2NrZXRTZXJ2ZXJVcmx8dXNlckFnZW50fHNka1ZlcnNpb258Y2hyb21lRnJhbWUiLAogICAgICBhbmFseXRpY3NQYXlsb2FkLm1hcChmdW5jdGlvbihlKSB7IHJldHVybiBlLnJlcGxhY2UoJ3wnLCAnXFx8Jyk7IH0pLmpvaW4oJ3wnKQogICAgKTsKCiAgICBfcnVtb3IgPSBuZXcgT1QuUnVtb3IuU29ja2V0KF9zb2NrZXRVcmwsIF9zeW1waG9ueSk7CiAgICBfcnVtb3Iub25DbG9zZSA9IG9uQ2xvc2U7CiAgICBfcnVtb3Iub25NZXNzYWdlID0gX2Rpc3BhdGNoZXIuZGlzcGF0Y2guYmluZChfZGlzcGF0Y2hlcik7CgogICAgX3J1bW9yLmNvbm5lY3QoY29ubmVjdGlvbklkLCBmdW5jdGlvbihlcnJvcikgewogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICBvbkNvbm5lY3RDb21wbGV0ZShlcnJvcik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB3ZSBkbyB0aGlzIGhlcmUgdG8gYXZvaWQgZ2V0dGluZyBjb25uZWN0IGVycm9ycyB0d2ljZQogICAgICBfcnVtb3Iub25FcnJvciA9IG9uRXJyb3I7CgogICAgICBPVC5kZWJ1ZygiUmFwdG9yIFNvY2tldCBjb25uZWN0ZWQgdG8gIiArIF9zZXNzaW9uSWQgKyAiIG9uICIgKyBtZXNzYWdpbmdTZXJ2ZXIpOwoKICAgICAgX3J1bW9yLnN1YnNjcmliZShbX3Nlc3Npb25JZF0pOwoKICAgICAgLy9jb25uZWN0IHRvIHNlc3Npb24KICAgICAgdmFyIGNvbm5lY3RNZXNzYWdlID0gT1QuUmFwdG9yLk1lc3NhZ2UuY29ubmVjdCh3aWRnZXRJZCwgX3J1bW9yLmlkLCBfc2Vzc2lvbklkLCBPVC5BUElLRVksIHRva2VuLCBzZXNzaW9uSW5mby5wMnBFbmFibGVkKTsKICAgICAgdGhpcy5wdWJsaXNoKGNvbm5lY3RNZXNzYWdlKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgfTsKCgogIHRoaXMuZGlzY29ubmVjdCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmlzKCdkaXNjb25uZWN0ZWQnKSkgcmV0dXJuOwoKICAgIHNldFN0YXRlKCdkaXNjb25uZWN0aW5nJyk7CiAgICBfcnVtb3IuZGlzY29ubmVjdCgpOwogIH07CgogIC8vIFB1Ymxpc2hzICttZXNzYWdlKyB0byB0aGUgU3ltcGhvbnkgYXBwIHNlcnZlci4KICB0aGlzLnB1Ymxpc2ggPSBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgaWYgKF9ydW1vci5pc05vdCgnY29ubmVjdGVkJykpIHsKICAgICAgT1QuZXJyb3IoIk9ULlJhcHRvci5Tb2NrZXQ6IGNhbm5vdCBwdWJsaXNoIHVudGlsIHRoZSBzb2NrZXQgaXMgY29ubmVjdGVkLiIgKyBtZXNzYWdlKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIE9ULmRlYnVnKCJPVC5SYXB0b3IuU29ja2V0IFB1Ymxpc2g6ICIgKyBtZXNzYWdlKTsKICAgIF9ydW1vci5wdWJsaXNoKFtfc3ltcGhvbnldLCBtZXNzYWdlKTsKICB9OwoKICAvLyBSZWdpc3RlciBhIG5ldyBzdHJlYW0gYWdhaW5zdCBfc2Vzc2lvbklkCiAgdGhpcy5jcmVhdGVTdHJlYW0gPSBmdW5jdGlvbihwdWJsaXNoZXJJZCwgbmFtZSwgb3JpZW50YXRpb24sIGVuY29kZWRXaWR0aCwgZW5jb2RlZEhlaWdodCwgaGFzQXVkaW8sIGhhc1ZpZGVvKSB7CiAgICB2YXIgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChfc2Vzc2lvbklkKSwKICAgICAgICBtZXNzYWdlID0gT1QuUmFwdG9yLk1lc3NhZ2Uuc3RyZWFtQ3JlYXRlKCBfcnVtb3IuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3Nlc3Npb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWJsaXNoZXJJZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kZWRXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkSGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0F1ZGlvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc1ZpZGVvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb24uc2Vzc2lvbkluZm8ucDJwRW5hYmxlZCApOwoKICAgIHRoaXMucHVibGlzaChtZXNzYWdlKTsKICB9OwoKICB0aGlzLnVwZGF0ZVN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbUlkLCBrZXksIHZhbHVlKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLnN0cmVhbU1vZGlmeShfcnVtb3IuaWQsIF9zZXNzaW9uSWQsIHN0cmVhbUlkLCBrZXksIHZhbHVlKSApOwogIH07CgogIHRoaXMuZGVzdHJveVN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbUlkKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLnN0cmVhbURlc3Ryb3koX3J1bW9yLmlkLCBfc2Vzc2lvbklkLCBzdHJlYW1JZCkgKTsKICB9OwoKICB0aGlzLm1vZGlmeVN1YnNjcmliZXIgPSBmdW5jdGlvbihzdWJzY3JpYmVyLCBrZXksIHZhbHVlKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLnN1YnNjcmliZXJNb2RpZnkoX3J1bW9yLmlkLCBfc2Vzc2lvbklkLCBzdWJzY3JpYmVyLnN0cmVhbUlkLCBzdWJzY3JpYmVyLndpZGdldElkLCBrZXksIHZhbHVlKSApOwogIH0KCiAgdGhpcy5mb3JjZURpc2Nvbm5lY3QgPSBmdW5jdGlvbihjb25uZWN0aW9uSWRUb0Rpc2Nvbm5lY3QpIHsKICAgIHRoaXMucHVibGlzaCggT1QuUmFwdG9yLk1lc3NhZ2UuZm9yY2VEaXNjb25uZWN0KF9ydW1vci5pZCwgY29ubmVjdGlvbklkVG9EaXNjb25uZWN0LCBfc2Vzc2lvbklkKSApOwogIH07CgogIHRoaXMuZm9yY2VVbnB1Ymxpc2ggPSBmdW5jdGlvbihzdHJlYW1JZCkgewogICAgdGhpcy5wdWJsaXNoKCBPVC5SYXB0b3IuTWVzc2FnZS5mb3JjZVVucHVibGlzaChfcnVtb3IuaWQsIF9zZXNzaW9uSWQsIHN0cmVhbUlkKSApOwogIH07CgogIHRoaXMuanNlcFN1YnNjcmliZSA9IGZ1bmN0aW9uKHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgc3Vic2NyaWJlVG9WaWRlbywgc3Vic2NyaWJlVG9BdWRpbykgewogICAgdGhpcy5wdWJsaXNoKCBPVC5SYXB0b3IuTWVzc2FnZS5qc2VwU3Vic2NyaWJlKF9ydW1vci5pZCwgdG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkLCBzdWJzY3JpYmVUb1ZpZGVvLCBzdWJzY3JpYmVUb0F1ZGlvKSApOwogIH07CgogIHRoaXMuanNlcFVuc3Vic2NyaWJlID0gZnVuY3Rpb24odG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLmpzZXBVbnN1YnNjcmliZShfcnVtb3IuaWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCkgKTsKICB9OwoKICB0aGlzLmpzZXBDYW5kaWRhdGUgPSBmdW5jdGlvbih0b0Nvbm5lY3Rpb25JZCwgc3RyZWFtSWQsIGNhbmRpZGF0ZSkgewogICAgdGhpcy5wdWJsaXNoKCBPVC5SYXB0b3IuTWVzc2FnZS5qc2VwQ2FuZGlkYXRlKF9ydW1vci5pZCwgdG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkLCBjYW5kaWRhdGUpICk7CiAgfTsKCiAgdGhpcy5qc2VwT2ZmZXIgPSBmdW5jdGlvbih0b0Nvbm5lY3Rpb25JZCwgc3RyZWFtSWQsIG9mZmVyU0RQKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLmpzZXBPZmZlcihfcnVtb3IuaWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgb2ZmZXJTRFApICk7CiAgfTsKCiAgdGhpcy5qc2VwQW5zd2VyID0gZnVuY3Rpb24odG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkLCBhbnN3ZXJTRFApIHsKICAgIHRoaXMucHVibGlzaCggT1QuUmFwdG9yLk1lc3NhZ2UuanNlcEFuc3dlcihfcnVtb3IuaWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgYW5zd2VyU0RQKSApOwogIH07CgoKICB0aGlzLnNpZ25hbCA9IGZ1bmN0aW9uKG9wdGlvbnMsIGNvbXBsZXRpb24pIHsKICAgIHZhciBzaWduYWwgPSBuZXcgT1QuU2lnbmFsKF9zZXNzaW9uSWQsIF9ydW1vci5pZCwgb3B0aW9ucyB8fCB7fSk7CgogICAgaWYgKCFzaWduYWwudmFsaWQpIHsKICAgICAgaWYgKGNvbXBsZXRpb24gJiYgT1QuJC5pc0Z1bmN0aW9uKGNvbXBsZXRpb24pKSB7CiAgICAgICAgY29tcGxldGlvbiggbmV3IFNpZ25hbEVycm9yKHNpZ25hbC5lcnJvci5jb2RlLCBzaWduYWwuZXJyb3IucmVhc29uLCBzaWduYWwudG9IYXNoKCkpICk7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLnB1Ymxpc2goIHNpZ25hbC50b1JhcHRvck1lc3NhZ2UoKSApOwogICAgaWYgKGNvbXBsZXRpb24gJiYgT1QuJC5pc0Z1bmN0aW9uKGNvbXBsZXRpb24pKSBjb21wbGV0aW9uKG51bGwsIHNpZ25hbC50b0hhc2goKSk7CiAgfTsKCiAgT1QuJC5kZWZpbmVHZXR0ZXJzKHRoaXMsIHsKICAgIGlkOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9ydW1vci5pZDsgfSwKICAgIGNhcGFiaWxpdGllczogZnVuY3Rpb24oKSB7IHJldHVybiBfY2FwYWJpbGl0aWVzOyB9LAogICAgc2Vzc2lvbklkOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uSWQ7IH0KICB9KTsKCiAgX2Rpc3BhdGNoZXIgPSBuZXcgKERpc3BhdGNoZXIgfHwgT1QuUmFwdG9yLkRpc3BhdGNoZXIpKHRoaXMsIG9uQ29ubmVjdENvbXBsZXRlKTsKfTsKCgp9KHRoaXMpKTsKKGZ1bmN0aW9uKGdsb2JhbCkgewoKLy8gQ29ubmVjdCBlcnJvciBjb2RlcyBhbmQgcmVhc29ucyB0aGF0IFJhcHRvciBjYW4gcmV0dXJuLgp2YXIgY29ubmVjdEVycm9yUmVhc29ucyA9IHsKICA0MDk6ICJUaGlzIFAyUCBzZXNzaW9uIGFscmVhZHkgaGFzIDIgcGFydGljaXBhbnRzLiIsCiAgNDEwOiAiVGhlIHNlc3Npb24gYWxyZWFkeSBoYXMgZm91ciBwYXJ0aWNpcGFudHMuIiwKICAxMDA0OiAiVGhlIHRva2VuIHBhc3NlZCBpcyBpbnZhbGlkLiIKfTsKCgovLyBAdG9kbyBoaWRlIHRoZXNlCk9ULnB1Ymxpc2hlcnMgPSBuZXcgT1QuQ29sbGVjdGlvbignZ3VpZCcpOyAgICAgICAgICAvLyBQdWJsaXNoZXJzIGFyZSBpZCdkIGJ5IHRoZWlyIGd1aWQKT1Quc3Vic2NyaWJlcnMgPSBuZXcgT1QuQ29sbGVjdGlvbignd2lkZ2V0SWQnKTsgICAgIC8vIFN1YnNjcmliZXJzIGFyZSBpZCdkIGJ5IHRoZWlyIHdpZGdldElkCk9ULnNlc3Npb25zID0gbmV3IE9ULkNvbGxlY3Rpb24oKTsKCmZ1bmN0aW9uIHBhcnNlU3RyZWFtKGRpY3QsIHNlc3Npb24pIHsKICB2YXIgc3RyZWFtID0gbmV3IE9ULlN0cmVhbSggZGljdC5zdHJlYW1JZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbi5jb25uZWN0aW9ucy5nZXQoZGljdC5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY3QubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljdC5zdHJlYW1EYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0LnR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY3QuY3JlYXRpb25UaW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0Lmhhc0F1ZGlvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0Lmhhc1ZpZGVvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0Lm9yaWVudGF0aW9uID8gZGljdC5vcmllbnRhdGlvbi52aWRlb09yaWVudGF0aW9uIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljdC5wZWVySWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY3QucXVhbGl0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljdC5vcmllbnRhdGlvbiA/IGRpY3Qub3JpZW50YXRpb24ud2lkdGggOiBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0Lm9yaWVudGF0aW9uID8gZGljdC5vcmllbnRhdGlvbi5oZWlnaHQgOiBudWxsICk7CgogIC8vIFRoaXMgaXMgYSBjb2RlIHNtZWxsLCBidXQgaXQncyBuZWNlc3NhcnkgZm9yIG5vdyBhcyB0aGUgcGFydCBvZiB0aGUgY29kZQogIC8vIHRoYXQgcmUtcGFyZW50cyBzdHJlYW1zIHRvIHB1Ymxpc2hlcnMgaXMgaW4gYSBkaWZmZXJlbnQgb2JqZWN0IHRoYXQgY2Fubm90CiAgLy8gYWNjZXNzIHRoZSByYXcgc3RyZWFtIHBhY2tldAogIGlmIChkaWN0LnB1Ymxpc2hlcklkKSB7CiAgICBzdHJlYW0ucHVibGlzaGVySWQgPSBkaWN0LnB1Ymxpc2hlcklkOwogIH0KCiAgcmV0dXJuIHN0cmVhbTsKfQoKZnVuY3Rpb24gcGFyc2VBbmRBZGRTdHJlYW1Ub1Nlc3Npb24oZGljdCwgc2Vzc2lvbikgewogIGlmIChzZXNzaW9uLnN0cmVhbXMuaGFzKGRpY3Quc3RyZWFtSWQpKSByZXR1cm47CgogIHZhciBzdHJlYW0gPSBwYXJzZVN0cmVhbShkaWN0LCBzZXNzaW9uKTsKICBzZXNzaW9uLnN0cmVhbXMuYWRkKCBzdHJlYW0gKTsKCiAgcmV0dXJuIHN0cmVhbTsKfQoKCk9ULlJhcHRvci5EaXNwYXRjaGVyID0gZnVuY3Rpb24gKHNvY2tldCwgY29ubmVjdGlvbkNvbXBsZXRpb24pIHsKICB0aGlzLnNvY2tldCA9IHNvY2tldDsKICB0aGlzLmNvbm5lY3Rpb25Db21wbGV0aW9uID0gY29ubmVjdGlvbkNvbXBsZXRpb247Cn07CgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2ggPSBmdW5jdGlvbihhZGRyZXNzZXMsIGVuY29kZWRNZXNzYWdlKSB7CiAgdmFyIG1lc3NhZ2UgPSBPVC5SYXB0b3IuZGVzZXJpYWxpemVNZXNzYWdlKGVuY29kZWRNZXNzYWdlKTsKCiAgaWYgKCFtZXNzYWdlLnR5cGVOYW1lKSB7CiAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoOiBJbnZhbGlkIG1lc3NhZ2UgdHlwZSAoIiArIG1lc3NhZ2UudHlwZSArICIpIik7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIW1lc3NhZ2UuYWN0aW9uTmFtZSkgewogICAgT1QuZXJyb3IoIk9ULlJhcHRvci5kaXNwYXRjaDogSW52YWxpZCBhY3Rpb24gKCIgKyBtZXNzYWdlLmFjdGlvbiArICIpIGZvciAiICsgbWVzc2FnZS50eXBlTmFtZSk7CiAgICBPVC5lcnJvcihtZXNzYWdlKTsKICAgIHJldHVybjsKICB9CgogIE9ULmRlYnVnKCJPVC5SYXB0b3IuZGlzcGF0Y2ggIiArIG1lc3NhZ2Uuc2lnbmF0dXJlICsgIjogIiArIGVuY29kZWRNZXNzYWdlKTsKCiAgc3dpdGNoKG1lc3NhZ2UudHlwZSkgewogICAgY2FzZSBPVC5SYXB0b3IuVHlwZXMuUlBDX1JFU1BPTlNFOgogICAgICB0aGlzLmRpc3BhdGNoUlBDUmVzcG9uc2UobWVzc2FnZSk7CiAgICAgIGJyZWFrOwoKICAgIGNhc2UgT1QuUmFwdG9yLlR5cGVzLkNPTk5FQ1RJT046CiAgICAgIHRoaXMuZGlzcGF0Y2hDb25uZWN0aW9uKG1lc3NhZ2UpOwogICAgICBicmVhazsKCiAgICBjYXNlIE9ULlJhcHRvci5UeXBlcy5DT05ORUNUSU9OQ09VTlQ6CiAgICAgIHRoaXMuZGlzcGF0Y2hDb25uZWN0aW9uQ291bnQobWVzc2FnZSk7CiAgICAgIGJyZWFrOwoKICAgIGNhc2UgT1QuUmFwdG9yLlR5cGVzLlNUUkVBTToKICAgICAgdGhpcy5kaXNwYXRjaFN0cmVhbShtZXNzYWdlKTsKICAgICAgYnJlYWs7CgogICAgY2FzZSBPVC5SYXB0b3IuVHlwZXMuU1VCU0NSSUJFUjoKICAgICAgdGhpcy5kaXNwYXRjaFN1YnNjcmliZXIobWVzc2FnZSk7CiAgICAgIGJyZWFrOwoKICAgIGNhc2UgT1QuUmFwdG9yLlR5cGVzLk1PREVSQVRJT046CiAgICAgIHRoaXMuZGlzcGF0Y2hNb2RlcmF0aW9uKG1lc3NhZ2UpOwogICAgICBicmVhazsKCiAgICBjYXNlIE9ULlJhcHRvci5UeXBlcy5KU0VQOgogICAgICB0aGlzLmRpc3BhdGNoSnNlcChtZXNzYWdlKTsKICAgICAgYnJlYWs7CgogICAgY2FzZSBPVC5SYXB0b3IuVHlwZXMuU0lHTkFMOgogICAgICB0aGlzLmRpc3BhdGNoU2lnbmFsKG1lc3NhZ2UpOwogICAgICBicmVhazsKCgoKICAgIGRlZmF1bHQ6CiAgICAgIE9ULndhcm4oIk9ULlJhcHRvci5kaXNwYXRjaDogVHlwZSAiICsgbWVzc2FnZS50eXBlTmFtZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIH0KfTsKCgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hSUENSZXNwb25zZSA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgc3dpdGNoIChtZXNzYWdlLmFjdGlvbikgewogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DT05ORUNUOgogICAgICBpZiAobWVzc2FnZS5wYXlsb2FkLmNvbm5lY3RTdWNjZXNzID09IGZhbHNlKSB7CiAgICAgICAgdmFyIGVycm9yID0gbmV3IE9ULkVycm9yKE9ULkV4Y2VwdGlvbkNvZGVzLkNPTk5FQ1RfUkVKRUNURUQsIGNvbm5lY3RFcnJvclJlYXNvbnNbbWVzc2FnZS5wYXlsb2FkLnJlYXNvbl0gfHwgIkZhaWxlZCB0byBjb25uZWN0Iik7CiAgICAgICAgdGhpcy5jb25uZWN0aW9uQ29tcGxldGlvbi5jYWxsKG51bGwsIGVycm9yKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICB0aGlzLnNvY2tldC5wdWJsaXNoKE9ULlJhcHRvci5NZXNzYWdlLmdldFNlc3Npb25TdGF0ZSh0aGlzLnNvY2tldC5pZCwgbWVzc2FnZS5wYXlsb2FkLnNlc3Npb25JZCwgdHJ1ZSkpOwogICAgICB9CiAgICAgIGJyZWFrOwoKCiAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlNUQVRFOgogICAgICB2YXIgc3RhdGUgPSBtZXNzYWdlLnBheWxvYWQudmFsdWUsCiAgICAgICAgICBzZXNzaW9uID0gT1Quc2Vzc2lvbnMuZ2V0KG1lc3NhZ2UucGF5bG9hZC5rZXkpLAogICAgICAgICAgY29ubmVjdGlvbjsKCiAgICAgIHN0YXRlLnN0cmVhbXMgPSBbXTsKICAgICAgc3RhdGUuY29ubmVjdGlvbnMgPSBbXTsKICAgICAgc3RhdGUuYXJjaGl2ZXMgPSBbXTsKCiAgICAgIGlmIChzdGF0ZS5oYXNPd25Qcm9wZXJ0eSgiQ09OTkVDVElPTlMiKSkgewogICAgICAgIGZvciAodmFyIGlkIGluIHN0YXRlLkNPTk5FQ1RJT05TKSB7CiAgICAgICAgICB2YXIgY29ubmVjdGlvbiA9IE9ULkNvbm5lY3Rpb24uZnJvbUhhc2goc3RhdGUuQ09OTkVDVElPTlNbaWRdKTsKICAgICAgICAgIHN0YXRlLmNvbm5lY3Rpb25zLnB1c2goY29ubmVjdGlvbik7CiAgICAgICAgICBzZXNzaW9uLmNvbm5lY3Rpb25zLmFkZChjb25uZWN0aW9uKQogICAgICAgIH0KCiAgICAgICAgZGVsZXRlIHN0YXRlLkNPTk5FQ1RJT05TOwogICAgICB9CgogICAgICBpZiAoc3RhdGUuaGFzT3duUHJvcGVydHkoIlNUUkVBTVMiKSkgewogICAgICAgIGZvciAodmFyIGlkIGluIHN0YXRlLlNUUkVBTVMpIHsKICAgICAgICAgIHN0YXRlLnN0cmVhbXMucHVzaCggcGFyc2VBbmRBZGRTdHJlYW1Ub1Nlc3Npb24oc3RhdGUuU1RSRUFNU1tpZF0sIHNlc3Npb24pICk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgc3RhdGUuU1RSRUFNUzsKICAgICAgfQoKCiAgICAgIHRoaXMuY29ubmVjdGlvbkNvbXBsZXRpb24uY2FsbChudWxsLCBudWxsLCBzdGF0ZSk7CiAgICAgIGJyZWFrOwoKCiAgICBkZWZhdWx0OgogICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIH0KfTsKCgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hDb25uZWN0aW9uID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICB2YXIgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChtZXNzYWdlLnBheWxvYWQudmFsdWUuc2Vzc2lvbklkKSwKICAgICAgY29ubmVjdGlvbjsKCiAgaWYgKCFzZXNzaW9uKSB7CiAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoOiBVbmFibGUgdG8gZGV0ZXJtaW5lIHNlc3Npb24gZm9yICIgKyBtZXNzYWdlLnBheWxvYWQudmFsdWUuc2Vzc2lvbklkICsgJyBvbiAnICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIG1lc3NhZ2UhIik7CiAgICAvLyBAdG9kbyBlcnJvcgogICAgcmV0dXJuOwogIH0KCiAgc3dpdGNoIChtZXNzYWdlLmFjdGlvbikgewogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DUkVBVEU6CiAgICAgIGNvbm5lY3Rpb24gPSBPVC5Db25uZWN0aW9uLmZyb21IYXNoKG1lc3NhZ2UucGF5bG9hZC52YWx1ZSk7CiAgICAgIGlmIChzZXNzaW9uLmNvbm5lY3Rpb24gJiYgY29ubmVjdGlvbi5pZCAhPT0gc2Vzc2lvbi5jb25uZWN0aW9uLmlkKSBzZXNzaW9uLmNvbm5lY3Rpb25zLmFkZCggY29ubmVjdGlvbiApOwogICAgICBicmVhazsKCgogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5ERUxFVEU6CiAgICAgIGNvbm5lY3Rpb24gPSBzZXNzaW9uLmNvbm5lY3Rpb25zLmdldChtZXNzYWdlLnBheWxvYWQudmFsdWUuY29ubmVjdGlvbklkKTsKICAgICAgY29ubmVjdGlvbi5kZXN0cm95KG1lc3NhZ2UucGF5bG9hZC5yZWFzb24pOwogICAgICBicmVhazsKCgogICAgZGVmYXVsdDoKICAgICAgT1Qud2FybigiT1QuUmFwdG9yLmRpc3BhdGNoOiAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIGlzIG5vdCBjdXJyZW50bHkgaW1wbGVtZW50ZWQiKTsKICB9Cn07CgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hDb25uZWN0aW9uQ291bnQgPSBmdW5jdGlvbiAobWVzc2FnZSkgewogIC8vIE5vdGU6IHdlIGRvbid0IHVzZSBhbnkgb2YgdGhpcyBpbiB0aGUgY2xpZW50IHJpZ2h0IG5vdy4KCiAgLy8gc3dpdGNoIChtZXNzYWdlLmFjdGlvbikgewogIC8vICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5VUERBVEU6CiAgLy8gICAgIGNvbm5lY3Rpb25Db3VudCA9IG1lc3NhZ2UucGF5bG9hZC52YWx1ZTsKICAvLyAgICAgT1QuZGVidWcoIk9ULlJhcHRvci5kaXNwYXRjaDogQ29ubmVjdGlvbiBjb3VudDogIiArIGNvbm5lY3Rpb25Db3VudCk7CiAgLy8gICAgIGJyZWFrOwoKCiAgLy8gICBkZWZhdWx0OgogIC8vICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIC8vIH0KfTsKCgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hTdHJlYW0gPSBmdW5jdGlvbiAobWVzc2FnZSkgewogIHZhciBrZXkgPSBtZXNzYWdlLnBheWxvYWQua2V5LnNwbGl0KCcvJyksCiAgICAgIHNlc3Npb25JZCA9IGtleVswXSwKICAgICAgc2Vzc2lvbiwKICAgICAgc3RyZWFtOwoKCiAgaWYgKHNlc3Npb25JZCkgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChzZXNzaW9uSWQpOwoKICBpZiAoIXNlc3Npb24pIHsKICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6IFVuYWJsZSB0byBkZXRlcm1pbmUgc2Vzc2lvbklkLCBvciB0aGUgc2Vzc2lvbiBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgIC8vIEB0b2RvIGVycm9yCiAgICByZXR1cm47CiAgfQoKICBzd2l0Y2ggKG1lc3NhZ2UuYWN0aW9uKSB7CiAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlJFR0lTVEVSOgogICAgICBzdHJlYW0gPSBwYXJzZVN0cmVhbShtZXNzYWdlLnBheWxvYWQudmFsdWUsIHNlc3Npb24pOwoKICAgICAgLy8gQHRvZG8gcmVmYWN0b3IgdGhpcyBsYXRlcgogICAgICBpZiAoc3RyZWFtLnB1Ymxpc2hlcklkKSB7CiAgICAgICAgdmFyIHB1Ymxpc2hlciA9IE9ULnB1Ymxpc2hlcnMuZ2V0KHN0cmVhbS5wdWJsaXNoZXJJZCk7CgogICAgICAgIGlmIChwdWJsaXNoZXIpIHsKICAgICAgICAgIHB1Ymxpc2hlci5fLnN0cmVhbVJlZ2lzdGVyZWRIYW5kbGVyKHN0cmVhbSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgT1Qud2FybigiT1QuUmFwdG9yLmRpc3BhdGNoOiBDb3VsZCBmaW5kIGEgcHVibGlzaGVyICIgKyBzdHJlYW0ucHVibGlzaGVySWQgKyAiIGZvciAiICsgbWVzc2FnZS5zaWduYXR1cmUpOwogICAgICAgIH0KICAgICAgfQogICAgICBicmVhazsKCgogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DUkVBVEU6CiAgICAgIHBhcnNlQW5kQWRkU3RyZWFtVG9TZXNzaW9uKG1lc3NhZ2UucGF5bG9hZC52YWx1ZSwgc2Vzc2lvbikKICAgICAgYnJlYWs7CgoKICAgIGNhc2UgT1QuUmFwdG9yLkFjdGlvbnMuVVBEQVRFOgogICAgICBpZiAoa2V5WzFdKSBzdHJlYW0gPSBzZXNzaW9uLnN0cmVhbXMuZ2V0KGtleVsxXSk7CgogICAgICBpZiAoIXN0cmVhbSkgewogICAgICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6IFVuYWJsZSB0byBkZXRlcm1pbmUgc3RyZWFtSWQsIG9yIHRoZSBzdHJlYW0gZG9lcyBub3QgZXhpc3QsIGZvciAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIG1lc3NhZ2UhIik7CiAgICAgICAgLy8gQHRvZG8gZXJyb3IKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHN0cmVhbS51cGRhdGUoa2V5WzJdLCBtZXNzYWdlLnBheWxvYWQudmFsdWUpOwogICAgICBicmVhazsKCgogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5ERUxFVEU6CiAgICAgIGlmIChrZXlbMl0pIHN0cmVhbSA9IHNlc3Npb24uc3RyZWFtcy5nZXQoa2V5WzJdKTsKCiAgICAgIGlmICghc3RyZWFtKSB7CiAgICAgICAgT1QuZXJyb3IoIk9ULlJhcHRvci5kaXNwYXRjaDogVW5hYmxlIHRvIGRldGVybWluZSBzdHJlYW1JZCwgb3IgdGhlIHN0cmVhbSBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgICAgICAvLyBAdG9kbyBlcnJvcgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgc3RyZWFtLmRlc3Ryb3kobWVzc2FnZS5wYXlsb2FkLnJlYXNvbik7CiAgICAgIGJyZWFrOwoKCiAgICBkZWZhdWx0OgogICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIH0KfTsKCgoKT1QuUmFwdG9yLkRpc3BhdGNoZXIucHJvdG90eXBlLmRpc3BhdGNoTW9kZXJhdGlvbiA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgLy8gRm9yY2UgZGlzY29ubmVjdCBhbmQgdW5wdWJsaXNoIGFyZSBoYW5kbGVkIGluIENPTk5FQ1RJT046REVMRVRFIGFuZCBTVFJFQU06REVMRVRFIHJlc3BlY3RpdmVseS4KICByZXR1cm47CgogIC8vIHZhciBzZXNzaW9uID0gT1Quc2Vzc2lvbnMuZ2V0KHRoaXMuc29ja2V0LnNlc3Npb25JZCk7CgogIC8vIGlmICghc2Vzc2lvbikgewogIC8vICAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoOiAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIEVSUk9SIC0gc2Vzc2lvbklkIG11c3QgYmUgcHJvdmlkZWQgYW5kIGJlIHZhbGlkIik7CiAgLy8gICAgIHJldHVybjsKICAvLyB9CgogIC8vIHN3aXRjaCAobWVzc2FnZS5hY3Rpb24pIHsKICAvLyAgIGNhc2UgT1QuUmFwdG9yLkFjdGlvbnMuRk9SQ0VfRElTQ09OTkVDVDoKICAvLyAgICAgaWYgKCFtZXNzYWdlLnBheWxvYWQuY29ubmVjdGlvbklkKSB7CiAgLy8gICAgICAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoOiAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIEVSUk9SIC0gY29ubmVjdGlvbklkIG11c3QgYmUgcHJvdmlkZWQiKTsKICAvLyAgICAgICAgIHJldHVybjsKICAvLyAgICAgfQoKICAvLyAgICAgdmFyIGNvbm5lY3Rpb24gPSBzZXNzaW9uLmNvbm5lY3Rpb25zLmdldChtZXNzYWdlLnBheWxvYWQuY29ubmVjdGlvbklkKTsKICAvLyAgICAgY29ubmVjdGlvbi5kZXN0cm95KCJmb3JjZURpc2Nvbm5lY3RlZCIpOwogIC8vICAgICBicmVhazsKCgogIC8vICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5GT1JDRV9VTlBVQkxJU0g6CiAgLy8gICAgIGlmICghbWVzc2FnZS5wYXlsb2FkLnN0cmVhbUlkKSB7CiAgLy8gICAgICAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgRVJST1IgLSBzdHJlYW1JZCBtdXN0IGJlIHByb3ZpZGVkIik7CiAgLy8gICAgICAgICByZXR1cm47CiAgLy8gICAgIH0KCiAgLy8gICAgIHZhciBzdHJlYW0gPSBzZXNzaW9uLnN0cmVhbXMuZ2V0KG1lc3NhZ2UucGF5bG9hZC5zdHJlYW1JZCk7CiAgLy8gICAgIHN0cmVhbS5kZXN0cm95KCJmb3JjZVVucHVibGlzaGVkIik7CiAgLy8gICAgIGJyZWFrOwoKCiAgLy8gICBkZWZhdWx0OgogIC8vICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIC8vIH0KfTsKCgoKT1QuUmFwdG9yLkRpc3BhdGNoZXIucHJvdG90eXBlLmRpc3BhdGNoSnNlcCA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgdmFyIGZyb21Db25uZWN0aW9uLAogICAgICBzdHJlYW1JZCA9IG1lc3NhZ2UucGF5bG9hZC5zdHJlYW1JZCwKICAgICAgYWN0b3JzOwoKICBzd2l0Y2ggKG1lc3NhZ2UuYWN0aW9uKSB7CiAgICAvLyBNZXNzYWdlcyBmb3IgU3Vic2NyaWJlcnMKICAgIGNhc2UgT1QuUmFwdG9yLkFjdGlvbnMuT0ZGRVI6CiAgICAgIGFjdG9ycyA9IFtdOwogICAgICB2YXIgc3Vic2NyaWJlciA9IE9ULnN1YnNjcmliZXJzLmZpbmQoe3N0cmVhbUlkOiBzdHJlYW1JZH0pOwogICAgICBpZiAoc3Vic2NyaWJlcikgYWN0b3JzLnB1c2goc3Vic2NyaWJlcik7CiAgICAgIGJyZWFrOwoKCiAgICAvLyBNZXNzYWdlcyBmb3IgUHVibGlzaGVycwogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5BTlNXRVI6CiAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlBSQU5TV0VSOgogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5TVUJTQ1JJQkU6CiAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlVOU1VCU0NSSUJFOgogICAgICBhY3RvcnMgPSBPVC5wdWJsaXNoZXJzLndoZXJlKHtzdHJlYW1JZDogc3RyZWFtSWR9KTsKICAgICAgYnJlYWs7CgoKICAgIC8vIE1lc3NhZ2VzIGZvciBQdWJsaXNoZXJzIGFuZCBTdWJzY3JpYmVycwogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DQU5ESURBVEU6CiAgICAgIC8vIHNlbmQgdG8gd2hpY2hldmVyIG9mIHlvdXIgcHVibGlzaGVyIG9yIHN1YnNjcmliZXJzIGFyZSBzdWJzY3JpYmluZy9wdWJsaXNoaW5nIHRoYXQgc3RyZWFtCiAgICAgIGFjdG9ycyA9IE9ULnB1Ymxpc2hlcnMud2hlcmUoe3N0cmVhbUlkOiBzdHJlYW1JZH0pLmNvbmNhdChPVC5zdWJzY3JpYmVycy53aGVyZSh7c3RyZWFtSWQ6IHN0cmVhbUlkfSkpOwogICAgICBicmVhazsKCgogICAgZGVmYXVsdDoKICAgICAgT1Qud2FybigiT1QuUmFwdG9yLmRpc3BhdGNoOiAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIGlzIG5vdCBjdXJyZW50bHkgaW1wbGVtZW50ZWQiKTsKICAgICAgcmV0dXJuOwogIH0KCiAgaWYgKGFjdG9ycy5sZW5ndGgpIHsKICAgIC8vIFRoaXMgaXMgYSBiaXQgaGFja3kuIFdlIGRvbid0IGhhdmUgdGhlIHNlc3Npb24gaW4gdGhlIG1lc3NhZ2Ugc28gd2UgaXRlcmF0ZQogICAgLy8gdW50aWwgd2UgZmluZCB0aGUgYWN0b3IgdGhhdCB0aGUgbWVzc2FnZSByZWxhdGVzIHRvIHRoaXMgc3RyZWFtLCBhbmQgdGhlbgogICAgLy8gd2UgZ3JhYiB0aGUgc2Vzc2lvbiBmcm9tIGl0LgogICAgZnJvbUNvbm5lY3Rpb24gPSBhY3RvcnNbMF0uc2Vzc2lvbi5jb25uZWN0aW9ucy5nZXQobWVzc2FnZS5wYXlsb2FkLmZyb21BZGRyZXNzKTsKICAgIGlmKCFmcm9tQ29ubmVjdGlvbiAmJiBtZXNzYWdlLnBheWxvYWQuZnJvbUFkZHJlc3MubWF0Y2goL15zeW1waG9ueVwuLykpIHsKICAgICAgZnJvbUNvbm5lY3Rpb24gPSBuZXcgT1QuQ29ubmVjdGlvbihtZXNzYWdlLnBheWxvYWQuZnJvbUFkZHJlc3MsCiAgICAgICAgICBEYXRlLm5vdygpLCBudWxsLCB7IHN1cHBvcnRzV2ViUlRDOiB0cnVlIH0pOwogICAgICBhY3RvcnNbMF0uc2Vzc2lvbi5jb25uZWN0aW9ucy5hZGQoZnJvbUNvbm5lY3Rpb24pOwogICAgfSBlbHNlIGlmKCFmcm9tQ29ubmVjdGlvbikgewogICAgICBPVC53YXJuKCJNZXNzc2FnZSBjb21lcyBmcm9tIGEgY29ubmVjdGlvbiAoIiArIG1lc3NhZ2UucGF5bG9hZC5mcm9tQWRkcmVzcyArICIpIHRoYXQgd2UgZG8gbm90IGtub3cgYWJvdXQuIik7CiAgICB9CiAgfQoKICBhY3RvcnMuZm9yRWFjaChmdW5jdGlvbihhY3RvcikgewogICAgYWN0b3IucHJvY2Vzc01lc3NhZ2UobWVzc2FnZS5hY3Rpb24sIGZyb21Db25uZWN0aW9uLCBtZXNzYWdlLnBheWxvYWQpOwogIH0pOwp9OwoKCi8vIFRoZSBwYXlsb2FkIGlzOgovLyAgICBrZXk6ICAgICJ7c2Vzc2lvbl9pZH19L1NVQlNDUklCRVIve3N0cmVhbV9pZH0ve3N1YnNjcmliZXJfaWR9IgovLyAgICB2YWx1ZTogIEludGVnZXIgICAgICAgICAgICAgICAgIHsgVmFsdWUgYmV0d2VlbiAwIGFuZCBzb21lIG5vbi16ZXJvIG1heCAoIE1heCBub3QgZGVjaWRlZCB5ZXQgKSAgfSoKLy8KLy8gKiBUaGUgY29tcGxldGUgcmFuZ2UgbmVlZCBub3QgYmUgdXNlZCBidXQgdGhpcyBwcm92aXNpb24gaXMganVzdCBzbyB0aGF0IGZ1dHVyZSBmYWNpbmcgd2UgbWlnaHQgbmVlZCB0byBoYXZlIG1vcmUgZ3JhbnVsYXJpdHkuCi8vCk9ULlJhcHRvci5EaXNwYXRjaGVyLnByb3RvdHlwZS5kaXNwYXRjaFN1YnNjcmliZXIgPSBmdW5jdGlvbiAobWVzc2FnZSkgewogIHZhciBrZXkgPSBtZXNzYWdlLnBheWxvYWQua2V5LnNwbGl0KCcvJyksCiAgICAgIHNlc3Npb24gPSBPVC5zZXNzaW9ucy5nZXQoa2V5WzBdKSwKICAgICAgc3Vic2NyaWJlciwKICAgICAgc3RyZWFtOwoKICBpZiAoIXNlc3Npb24pIHsKICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6IFVuYWJsZSB0byBkZXRlcm1pbmUgc2Vzc2lvbklkLCBvciB0aGUgc2Vzc2lvbiBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgIC8vIEB0b2RvIGVycm9yCiAgICByZXR1cm47CiAgfQoKICBzdHJlYW0gPSBrZXlbMl0gPyBzZXNzaW9uLnN0cmVhbXMuZ2V0KGtleVsyXSkgOiBudWxsOwoKICBpZiAoIXN0cmVhbSkgewogICAgT1QuZXJyb3IoIk9ULlJhcHRvci5kaXNwYXRjaDogVW5hYmxlIHRvIGRldGVybWluZSBzdHJlYW1JZCwgb3IgdGhlIHN0cmVhbSBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgIC8vIEB0b2RvIGVycm9yCiAgICByZXR1cm47CiAgfQoKICAvLyBGaW5kIHRoZSBzdWJzY3JpYmVyIHRoYXQgbWF0Y2hlcyB0aGlzIHN0cmVhbSwgY29ubmVjdGlvbiwgYW5kIHNlc3Npb24KICBzdWJzY3JpYmVyID0gT1Quc3Vic2NyaWJlcnMuZmluZChmdW5jdGlvbihzdWJzY3JpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdWJzY3JpYmVyLnN0cmVhbUlkID09PSBzdHJlYW0uaWQKICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBzdWJzY3JpYmVyLnNlc3Npb24uaWQgPT09IHNlc3Npb24uaWQKICAgICAgICAgICAgICAgIH0pOwoKICBpZiAoIXN1YnNjcmliZXIpIHsKICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6IFVuYWJsZSB0byBkZXRlcm1pbmUgc3Vic2NyaWJlcklkLCBvciB0aGUgc3Vic2NyaWJlciBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgIC8vIEB0b2RvIGVycm9yCiAgICByZXR1cm47CiAgfQoKCiAgc3dpdGNoIChtZXNzYWdlLmFjdGlvbikgewogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5RVUFMSVRZX0NIQU5HRUQ6CiAgICAgIHN1YnNjcmliZXIudXBkYXRlUXVhbGl0eShwYXJzZUludChtZXNzYWdlLnBheWxvYWQudmFsdWUsIDEwKSk7CiAgICAgIGJyZWFrOwoKCiAgICBkZWZhdWx0OgogICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIH0KfTsKCgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hTaWduYWwgPSBmdW5jdGlvbiAobWVzc2FnZSkgewogIGlmIChtZXNzYWdlLmFjdGlvbiAhPT0gT1QuUmFwdG9yLkFjdGlvbnMuU0lHTkFMKSB7CiAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogICAgcmV0dXJuOwogIH0KCiAgdmFyIHNlc3Npb24gPSBPVC5zZXNzaW9ucy5nZXQodGhpcy5zb2NrZXQuc2Vzc2lvbklkKTsKCiAgaWYgKCFzZXNzaW9uKSB7CiAgICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgRVJST1IgLSBzZXNzaW9uSWQgbXVzdCBiZSBwcm92aWRlZCBhbmQgYmUgdmFsaWQiKTsKICAgICAgcmV0dXJuOwogIH0KCiAgc2Vzc2lvbi5fLmRpc3BhdGNoU2lnbmFsKCBzZXNzaW9uLmNvbm5lY3Rpb25zLmdldChtZXNzYWdlLnBheWxvYWQuZnJvbUFkZHJlc3MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5wYXlsb2FkLnR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnBheWxvYWQuZGF0YSk7Cn07Cgp9KHRoaXMpKTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gSGVscGVyIHRvIHN5bmNocm9uaXNlIHNldmVyYWwgc3RhcnR1cCB0YXNrcyBhbmQgdGhlbiBkaXNwYXRjaCBhIHVuaWZpZWQKLy8gJ2VudkxvYWRlZCcgZXZlbnQuCi8vCi8vIFRoaXMgZGVwZW5kcyBvbjoKLy8gKiBPVAovLyAqIE9ULkNvbmZpZwovLwpmdW5jdGlvbiBFbnZpcm9ubWVudExvYWRlcigpIHsKICAgIHZhciBfY29uZmlnUmVhZHkgPSBmYWxzZSwKICAgICAgICBfZG9tUmVhZHkgPSBmYWxzZSwKCiAgICAgICAgaXNSZWFkeSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX2RvbVJlYWR5ICYmIF9jb25maWdSZWFkeTsKICAgICAgICB9LAoKICAgICAgICBvbkxvYWRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoaXNSZWFkeSgpKSB7CiAgICAgICAgICAgICAgICBPVC5kaXNwYXRjaEV2ZW50KG5ldyBPVC5FbnZMb2FkZWRFdmVudChPVC5FdmVudC5uYW1lcy5FTlZfTE9BREVEKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBvbkRvbVJlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIF9kb21SZWFkeSA9IHRydWU7CgogICAgICAgICAgICAvLyBUaGlzIGlzIG1ha2luZyBhbiBhc3N1bXB0aW9uIGFib3V0IHRoZXJlIGJlaW5nIG9ubHkgb25lICJ3aW5kb3ciCiAgICAgICAgICAgIC8vIHRoYXQgd2UgY2FyZSBhYm91dC4KICAgICAgICAgICAgT1QuJC5vbih3aW5kb3csICJiZWZvcmV1bmxvYWQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIE9ULnB1Ymxpc2hlcnMuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgT1Quc3Vic2NyaWJlcnMuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgT1Quc2Vzc2lvbnMuZGVzdHJveSgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFRoZSBEeW5hbWljIENvbmZpZyB3b24ndCBsb2FkIHVudGlsIHRoZSBET00gaXMgcmVhZHkKICAgICAgICAgICAgT1QuQ29uZmlnLmxvYWQoT1QucHJvcGVydGllcy5jb25maWdVUkwpOwoKICAgICAgICAgICAgb25Mb2FkZWQoKTsKICAgICAgICB9LAoKICAgICAgICBjb25maWdMb2FkZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2NvbmZpZ1JlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgT1QuQ29uZmlnLm9mZignZHluYW1pY0NvbmZpZ0NoYW5nZWQnLCBjb25maWdMb2FkZWQpOwogICAgICAgICAgICBPVC5Db25maWcub2ZmKCdkeW5hbWljQ29uZmlnTG9hZEZhaWxlZCcsIGNvbmZpZ0xvYWRGYWlsZWQpOwoKICAgICAgICAgICAgb25Mb2FkZWQoKTsKICAgICAgICB9LAoKICAgICAgICBjb25maWdMb2FkRmFpbGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbmZpZ0xvYWRlZCgpOwogICAgICAgIH07CgogICAgT1QuQ29uZmlnLm9uKCdkeW5hbWljQ29uZmlnQ2hhbmdlZCcsIGNvbmZpZ0xvYWRlZCk7CiAgICBPVC5Db25maWcub24oJ2R5bmFtaWNDb25maWdMb2FkRmFpbGVkJywgY29uZmlnTG9hZEZhaWxlZCk7CiAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiIHx8IChkb2N1bWVudC5yZWFkeVN0YXRlID09ICJpbnRlcmFjdGl2ZSIgJiYgZG9jdW1lbnQuYm9keSkpIHsKICAgICAgICBvbkRvbVJlYWR5KCk7CiAgICB9IGVsc2UgewogICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBvbkRvbVJlYWR5LCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAvLyBUaGlzIGlzIHNvIG9uTG9hZCB3b3JrcyBpbiBJRSwgcHJpbWFyaWx5IHNvIHdlIGNhbiBzaG93IHRoZSB1cGdyYWRlIHRvIENocm9tZSBwb3B1cAogICAgICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiKSBvbkRvbVJlYWR5KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICB0aGlzLm9uTG9hZCA9IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgaWYgKGlzUmVhZHkoKSkgewogICAgICAgICAgICBjYigpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBPVC5vbihPVC5FdmVudC5uYW1lcy5FTlZfTE9BREVELCBjYik7CiAgICB9Owp9Cgp2YXIgRW52TG9hZGVyID0gbmV3IEVudmlyb25tZW50TG9hZGVyKCk7CgpPVC5vbkxvYWQgPSBmdW5jdGlvbihjYiwgY29udGV4dCkgewogICAgaWYgKCFjb250ZXh0KSB7CiAgICAgICAgRW52TG9hZGVyLm9uTG9hZChjYik7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBFbnZMb2FkZXIub25Mb2FkKAogICAgICAgICAgICBjYi5iaW5kKGNvbnRleHQpCiAgICAgICAgKTsKICAgIH0KfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCk9ULkVycm9yID0gZnVuY3Rpb24oY29kZSwgbWVzc2FnZSkgewogICAgdGhpcy5jb2RlID0gY29kZTsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7Cn07Cgp2YXIgZXJyb3JzQ29kZXNUb1RpdGxlID0gewogICAgMTAwMDogIkZhaWxlZCBUbyBMb2FkIiwKICAgIDEwMDQ6ICJBdXRoZW50aWNhdGlvbiBlcnJvciIsCiAgICAxMDA1OiAiSW52YWxpZCBTZXNzaW9uIElEIiwKICAgIDEwMDY6ICJDb25uZWN0IEZhaWxlZCIsCiAgICAxMDA3OiAiQ29ubmVjdCBSZWplY3RlZCIsCiAgICAxMDA4OiAiQ29ubmVjdCBUaW1lLW91dCIsCiAgICAxMDA5OiAiU2VjdXJpdHkgRXJyb3IiLAogICAgMTAxMDogIk5vdCBDb25uZWN0ZWQiLAogICAgMTAxMTogIkludmFsaWQgUGFyYW1ldGVyIiwKICAgIDEwMTI6ICJQZWVyLXRvLXBlZXIgU3RyZWFtIFBsYXkgRmFpbGVkIiwKICAgIDEwMTM6ICJDb25uZWN0aW9uIEZhaWxlZCIsCiAgICAxMDE0OiAiQVBJIFJlc3BvbnNlIEZhaWx1cmUiLAogICAgMTUwMDogIlVuYWJsZSB0byBQdWJsaXNoIiwKICAgIDE1MTA6ICJVbmFibGUgdG8gU2lnbmFsIiwKICAgIDE1MjA6ICJVbmFibGUgdG8gRm9yY2UgRGlzY29ubmVjdCIsCiAgICAxNTMwOiAiVW5hYmxlIHRvIEZvcmNlIFVucHVibGlzaCIsCiAgICAxNTQwOiAiVW5hYmxlIHRvIHJlY29yZCBhcmNoaXZlIiwKICAgIDE1NTA6ICJVbmFibGUgdG8gcGxheSBiYWNrIGFyY2hpdmUiLAogICAgMTU2MDogIlVuYWJsZSB0byBjcmVhdGUgYXJjaGl2ZSIsCiAgICAxNTcwOiAiVW5hYmxlIHRvIGxvYWQgYXJjaGl2ZSIsCiAgICAyMDAwOiAiSW50ZXJuYWwgRXJyb3IiLAogICAgMjAwMTogIkVtYmVkIEZhaWxlZCIsCiAgICAzMDAwOiAiQXJjaGl2ZSBsb2FkIGV4Y2VwdGlvbiIsCiAgICAzMDAxOiAiQXJjaGl2ZSBjcmVhdGUgZXhjZXB0aW9uIiwKICAgIDMwMDI6ICJQbGF5YmFjayBzdG9wIGV4Y2VwdGlvbiIsCiAgICAzMDAzOiAiUGxheWJhY2sgc3RhcnQgZXhjZXB0aW9uIiwKICAgIDMwMDQ6ICJSZWNvcmQgc3RhcnQgZXhjZXB0aW9uIiwKICAgIDMwMDU6ICJSZWNvcmQgc3RvcCBleGNlcHRpb24iLAogICAgMzAwNjogIkFyY2hpdmUgbG9hZCBleGNlcHRpb24iLAogICAgMzAwNzogIlNlc3Npb24gcmVjb3JkaW5nIGluIHByb2dyZXNzIiwKICAgIDMwMDg6ICJBcmNoaXZlIHJlY29yZGluZyBpbnRlcm5hbCBmYWlsdXJlIiwKICAgIDQwMDA6ICJXZWJTb2NrZXQgQ29ubmVjdGlvbiBGYWlsZWQiLAogICAgNDAwMTogIldlYlNvY2tldCBOZXR3b3JrIERpc2Nvbm5lY3RlZCIKfTsKCnZhciBhbmFseXRpY3M7CgpmdW5jdGlvbiBfZXhjZXB0aW9uSGFuZGxlcihjb21wb25lbnQsIG1zZywgZXJyb3JDb2RlLCBjb250ZXh0KSB7CiAgICB2YXIgdGl0bGUgPSBlcnJvcnNDb2Rlc1RvVGl0bGVbZXJyb3JDb2RlXSwKICAgICAgICBjb250ZXh0Q29weSA9IGNvbnRleHQgPyBPVC4kLmNsb25lKGNvbnRleHQpIDoge307CgogICAgT1QuZXJyb3IoIlRCLmV4Y2VwdGlvbiA6OiB0aXRsZTogIiArIHRpdGxlICsgIiAoIiArIGVycm9yQ29kZSArICIpIG1zZzogIiArIG1zZyk7CgogICAgaWYgKCFjb250ZXh0Q29weS5wYXJ0bmVySWQpIGNvbnRleHRDb3B5LnBhcnRuZXJJZCA9IE9ULkFQSUtFWTsKCiAgICB0cnkgewogICAgICAgIGlmICghYW5hbHl0aWNzKSBhbmFseXRpY3MgPSBuZXcgT1QuQW5hbHl0aWNzKCk7CiAgICAgICAgYW5hbHl0aWNzLmxvZ0Vycm9yKGVycm9yQ29kZSwgJ3RiLmV4Y2VwdGlvbicsIHRpdGxlLCB7ZGV0YWlsczptc2d9LCBjb250ZXh0Q29weSk7CgogICAgICAgIE9ULmRpc3BhdGNoRXZlbnQoCiAgICAgICAgICAgIG5ldyBPVC5FeGNlcHRpb25FdmVudChPVC5FdmVudC5uYW1lcy5FWENFUFRJT04sIG1zZywgdGl0bGUsIGVycm9yQ29kZSwgY29tcG9uZW50LCBjb21wb25lbnQpCiAgICAgICAgKTsKICAgIH0gY2F0Y2goZXJyKSB7CiAgICAgICAgT1QuZXJyb3IoIlRCLmV4Y2VwdGlvbiA6OiBGYWlsZWQgdG8gZGlzcGF0Y2ggZXhjZXB0aW9uIC0gIiArIGVyci50b1N0cmluZygpKTsKICAgICAgICAvLyBEb24ndCB0aHJvdyBhbiBlcnJvciBiZWNhdXNlIHRoaXMgaXMgYXN5bmNocm9ub3VzCiAgICAgICAgLy8gZG9uJ3QgZG8gYW4gZXhjZXB0aW9uSGFuZGxlciBiZWNhdXNlIHRoYXQgd291bGQgYmUgcmVjdXJzaXZlCiAgICB9Cn0KCi8vIEB0b2RvIHJlZG8gdGhpcyB3aGVuIHdlIGhhdmUgdGltZSB0byB0aWR5IHVwCi8vCi8vIEBleGFtcGxlCi8vCi8vICBUQi5oYW5kbGVKc0V4Y2VwdGlvbigiRGVzY3JpcHRpdmUgZXJyb3IgbWVzc2FnZSIsIDIwMDAsIHsKLy8gICAgICBzZXNzaW9uOiBzZXNzaW9uLAovLyAgICAgIHRhcmdldDogc3RyZWFtfHB1Ymxpc2hlcnxzdWJzY3JpYmVyfHNlc3Npb258ZXRjCi8vICB9KTsKLy8KT1QuaGFuZGxlSnNFeGNlcHRpb24gPSBmdW5jdGlvbihlcnJvck1zZywgY29kZSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgdmFyIGNvbnRleHQsCiAgICAgICAgc2Vzc2lvbiA9IG9wdGlvbnMuc2Vzc2lvbjsKCiAgICBpZiAoc2Vzc2lvbikgewogICAgICAgIGNvbnRleHQgPSB7CiAgICAgICAgICAgIHNlc3Npb25JZDogc2Vzc2lvbi5zZXNzaW9uSWQKICAgICAgICB9OwoKICAgICAgICBpZiAoc2Vzc2lvbi5jb25uZWN0ZWQpIGNvbnRleHQuY29ubmVjdGlvbklkID0gc2Vzc2lvbi5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDsKICAgICAgICBpZiAoIW9wdGlvbnMudGFyZ2V0KSBvcHRpb25zLnRhcmdldCA9IHNlc3Npb247CiAgICB9CiAgICBlbHNlIGlmIChvcHRpb25zLnNlc3Npb25JZCkgewogICAgICAgIGNvbnRleHQgPSB7CiAgICAgICAgICAgIHNlc3Npb25JZDogb3B0aW9ucy5zZXNzaW9uSWQKICAgICAgICB9OwoKICAgICAgICBpZiAoIW9wdGlvbnMudGFyZ2V0KSBvcHRpb25zLnRhcmdldCA9IG51bGw7CiAgICB9CgogICAgX2V4Y2VwdGlvbkhhbmRsZXIob3B0aW9ucy50YXJnZXQsIGVycm9yTXNnLCBjb2RlLCBjb250ZXh0KTsKfTsKCgovLyBAdG9kbyByZWRvIHRoaXMgd2hlbiB3ZSBoYXZlIHRpbWUgdG8gdGlkeSB1cAovLwovLyBQdWJsaWMgY2FsbGJhY2sgZm9yIGV4Y2VwdGlvbnMgZnJvbSBGbGFzaC4KLy8KLy8gQ2FsbGVkIGZyb20gRmxhc2ggbGlrZToKLy8gIFRCLmV4Y2VwdGlvbkhhbmRsZXIoJ3B1Ymxpc2hlcl8xMjM0LDEyMzQnLCAiRGVzY3JpcHRpdmUgRXJyb3IgTWVzc2FnZSIsICJFcnJvciBUaXRsZSIsIDIwMDAsIGNvbnRleHRPYmopCi8vCk9ULmV4Y2VwdGlvbkhhbmRsZXIgPSBmdW5jdGlvbihjb21wb25lbnRJZCwgbXNnLCBlcnJvclRpdGxlLCBlcnJvckNvZGUsIGNvbnRleHQpIHsKICAgIHZhciB0YXJnZXQ7CgogICAgaWYgKGNvbXBvbmVudElkKSB7CiAgICAgICAgdGFyZ2V0ID0gT1QuY29tcG9uZW50c1tjb21wb25lbnRJZF07CgogICAgICAgIGlmICghdGFyZ2V0KSB7CiAgICAgICAgICAgIE9ULndhcm4oIkNvdWxkIG5vdCBmaW5kIHRoZSBjb21wb25lbnQgd2l0aCBjb21wb25lbnQgSUQgIiArIGNvbXBvbmVudElkKTsKICAgICAgICB9CiAgICB9CgogICAgX2V4Y2VwdGlvbkhhbmRsZXIodGFyZ2V0LCBtc2csIGVycm9yQ29kZSwgY29udGV4dCk7Cn07Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7CgpPVC5Db25uZWN0aW9uQ2FwYWJpbGl0aWVzID0gZnVuY3Rpb24oY2FwYWJpbGl0aWVzSGFzaCkgewogICAgLy8gUHJpdmF0ZSBoZWxwZXIgbWV0aG9kcwogICAgdmFyIGNhc3RDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbihjYXBhYmlsaXRpZXNIYXNoKSB7CiAgICAgICAgICAgIGNhcGFiaWxpdGllc0hhc2guc3VwcG9ydHNXZWJSVEMgPSBPVC4kLmNhc3RUb0Jvb2xlYW4oY2FwYWJpbGl0aWVzSGFzaC5zdXBwb3J0c1dlYlJUQyk7CgogICAgICAgICAgICByZXR1cm4gY2FwYWJpbGl0aWVzSGFzaDsKICAgICAgICB9OwoKCiAgICAvLyBQcml2YXRlIGRhdGEKICAgIHZhciBfY2FwcyA9IGNhc3RDYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzSGFzaCk7CgoKICAgIHRoaXMuc3VwcG9ydHNXZWJSVEMgPSBfY2Fwcy5zdXBwb3J0c1dlYlJUQzsKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8qKgogKiBUaGUgQ29ubmVjdGlvbiBvYmplY3QgcmVwcmVzZW50cyBhIGNvbm5lY3Rpb24gdG8gYW4gT3BlblRvayBzZXNzaW9uLgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgaGFzIGEgPGNvZGU+Y29ubmVjdGlvbjwvY29kZT4gcHJvcGVydHkgdGhhdCBpcyBhIENvbm5lY3Rpb24gb2JqZWN0LgogKiBJdCByZXByZXNlbnRzIHRoZSBsb2NhbCBjbGllbnQncyBjb25uZWN0aW9uLiAoQSBjbGllbnQgb25seSBoYXMgYSBjb25uZWN0aW9uIG9uY2UgdGhlCiAqIGNsaWVudCBoYXMgc3VjY2Vzc2Z1bGx5IGNhbGxlZCB0aGUgPGNvZGU+Y29ubmVjdCgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIHtAbGluayBTZXNzaW9ufSBvYmplY3QuKQogKiBUaGUgU3RyZWFtIG9iamVjdCBoYXMgYSA8Y29kZT5jb25uZWN0aW9uPC9jb2RlPiBwcm9wZXJ0eSB0aGF0IGlzIGEgQ29ubmVjdGlvbiBvYmplY3QuCiAqIEl0IHJlcHJlc2VudHMgdGhlIHN0cmVhbSBwdWJsaXNoZXIncyBjb25uZWN0aW9uLgogKgogKiBAY2xhc3MgQ29ubmVjdGlvbgogKiBAcHJvcGVydHkge1N0cmluZ30gaWQgVGhlIElEIG9mIHRoaXMgY29ubmVjdGlvbi4KICogQHByb3BlcnR5IHtOdW1iZXJ9IGNyZWF0aW9uVGltZSBUaGUgdGltZXN0YW1wIGZvciB0aGUgY3JlYXRpb24gb2YgdGhlIGNvbm5lY3Rpb24uIFRoaXMgdmFsdWUgaXMgY2FsY3VsYXRlZCBpbiBtaWxsaXNlY29uZHMuCiAgWW91IGNhbiBjb252ZXJ0IHRoaXMgdmFsdWUgdG8gYSBEYXRlIG9iamVjdCBieSBjYWxsaW5nIDxjb2RlPm5ldyBEYXRlKGNyZWF0aW9uVGltZSk8L2NvZGU+LCB3aGVyZSA8Y29kZT5jcmVhdGlvblRpbWU8L2NvZGU+CiAgaXMgdGhlIDxjb2RlPmNyZWF0aW9uVGltZTwvY29kZT4gcHJvcGVydHkgb2YgdGhlIENvbm5lY3Rpb24gb2JqZWN0LgogKiBAcHJvcGVydHkge1N0cmluZ30gZGF0YSAgQSBzdHJpbmcgY29udGFpbmluZyBtZXRhZGF0YSBkZXNjcmliaW5nIHRoZQogIGNvbm5lY3Rpb24uIFdoZW4geW91IGdlbmVyYXRlIGEgdXNlciB0b2tlbiBzdHJpbmcgcGFzcyB0aGUgY29ubmVjdGlvbiBkYXRhIHN0cmluZyB0byB0aGUKICA8Y29kZT5nZW5lcmF0ZV90b2tlbigpPC9jb2RlPiBtZXRob2Qgb2Ygb3VyCiAgPGEgaHJlZj0iL29wZW50b2svbGlicmFyaWVzL3NlcnZlci8iPnNlcnZlci1zaWRlIGxpYnJhcmllczwvYT4uIFlvdSBjYW4gYWxzbyBnZW5lcmF0ZSBhIHRva2VuIGFuZCBkZWZpbmUgY29ubmVjdGlvbiBkYXRhIG9uIHRoZQogIDxhIGhyZWY9Imh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMiPkRhc2hib2FyZDwvYT4gcGFnZS4KICovCk9ULkNvbm5lY3Rpb24gPSBmdW5jdGlvbihpZCwgY3JlYXRpb25UaW1lLCBkYXRhLCBjYXBhYmlsaXRpZXNIYXNoKSB7CiAgICB2YXIgZGVzdHJveWVkUmVhc29uOwoKICAgIHRoaXMuaWQgPSB0aGlzLmNvbm5lY3Rpb25JZCA9IGlkOwogICAgdGhpcy5jcmVhdGlvblRpbWUgPSBjcmVhdGlvblRpbWUgPyBOdW1iZXIoY3JlYXRpb25UaW1lKSA6IG51bGw7CiAgICB0aGlzLmRhdGEgPSBkYXRhOwogICAgdGhpcy5jYXBhYmlsaXRpZXMgPSBuZXcgT1QuQ29ubmVjdGlvbkNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNIYXNoKTsKICAgIHRoaXMucXVhbGl0eSA9IG51bGw7CgogICAgT1QuJC5ldmVudGluZyh0aGlzKTsKCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbihyZWFzb24sIHF1aWV0KSB7CiAgICAgICAgZGVzdHJveWVkUmVhc29uID0gcmVhc29uIHx8ICdjbGllbnREaXNjb25uZWN0ZWQnOwoKICAgICAgICBpZiAocXVpZXQgIT09IHRydWUpIHsKICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KAogICAgICAgICAgICAgIG5ldyBPVC5EZXN0cm95ZWRFdmVudCgKICAgICAgICAgICAgICAgICdkZXN0cm95ZWQnLCAgICAgIC8vIFRoaXMgc2hvdWxkIGJlIE9ULkV2ZW50Lm5hbWVzLkNPTk5FQ1RJT05fREVTVFJPWUVELCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB2YWx1ZSBvZiB0aGF0IGlzIGN1cnJlbnRseSBzaGFyZWQgd2l0aCBTZXNzaW9uCiAgICAgICAgICAgICAgICB0aGlzLAogICAgICAgICAgICAgICAgZGVzdHJveWVkUmVhc29uCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgIH0KICAgIH0uYmluZCh0aGlzKTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgICAgZGVzdHJveWVkOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBkZXN0cm95ZWRSZWFzb24gIT09IHZvaWQgMDsgfSwKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgIH0sCgogICAgICAgIGRlc3Ryb3llZFJlYXNvbjogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZGVzdHJveWVkUmVhc29uOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfQogICAgfSk7Cn07CgpPVC5Db25uZWN0aW9uLmZyb21IYXNoID0gZnVuY3Rpb24oaGFzaCkgewogIHJldHVybiBuZXcgT1QuQ29ubmVjdGlvbihoYXNoLmNvbm5lY3Rpb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2guY3JlYXRpb25UaW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaC5kYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBzdXBwb3J0c1dlYlJUQzogaGFzaC5zdXBwb3J0c1dlYlJUQyB9ICk7Cgp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKdmFyIHZhbGlkUHJvcGVydHlOYW1lcyA9IFsnaGFzQXVkaW8nLCAnaGFzVmlkZW8nLCAncXVhbGl0eScsICduYW1lJywgJ3ZpZGVvRGltZW5zaW9ucycsICdvcmllbnRhdGlvbiddOwoKCi8qKgogKiBTcGVjaWZpZXMgYSBzdHJlYW0uIEEgc3RyZWFtIGlzIGEgcmVwcmVzZW50YXRpb24gb2YgYSBwdWJsaXNoZWQgc3RyZWFtIGluIGEgc2Vzc2lvbi4gV2hlbiBhIGNsaWVudCBjYWxscyB0aGUKICogPGEgaHJlZj0iU2Vzc2lvbi5odG1sI3B1Ymxpc2giPlNlc3Npb24ucHVibGlzaCgpIG1ldGhvZDwvYT4sIGEgbmV3IHN0cmVhbSBpcyBjcmVhdGVkLiBQcm9wZXJ0aWVzIG9mIHRoZSBTdHJlYW0KICogb2JqZWN0IHByb3ZpZGUgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHN0cmVhbS4KICoKICogIDxwPldoZW4gYSBzdHJlYW0gaXMgYWRkZWQgdG8gYSBzZXNzaW9uLCB0aGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnN0cmVhbUNyZWF0ZWRFdmVudDwvY29kZT4uCiAqICBXaGVuIGEgc3RyZWFtIGlzIGRlc3Ryb3llZCwgdGhlIFNlc3Npb24gb2JqZWN0IGRpc3BhdGNoZXMgYSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50LiBUaGUKICogIFN0cmVhbUV2ZW50IG9iamVjdCwgd2hpY2ggZGVmaW5lcyB0aGVzZSBldmVudCBvYmplY3RzLCBoYXMgYSA8Y29kZT5zdHJlYW08L2NvZGU+IHByb3BlcnR5LCB3aGljaCBpcyBhbgogKiAgYXJyYXkgb2YgU3RyZWFtIG9iamVjdC4gRm9yIGRldGFpbHMgYW5kIGEgY29kZSBleGFtcGxlLCBzZWUge0BsaW5rIFN0cmVhbUV2ZW50fS48L3A+CiAqCiAqICA8cD5XaGVuIGEgY29ubmVjdGlvbiB0byBhIHNlc3Npb24gaXMgbWFkZSwgdGhlIFNlc3Npb24gb2JqZWN0IGRpc3BhdGNoZXMgYSA8Y29kZT5zZXNzaW9uQ29ubmVjdGVkPC9jb2RlPgogKiAgZXZlbnQsIGRlZmluZWQgYnkgdGhlIFNlc3Npb25Db25uZWN0RXZlbnQgb2JqZWN0LiBUaGUgU2Vzc2lvbkNvbm5lY3RFdmVudCBvYmplY3QgaGFzIGEgPGNvZGU+c3RyZWFtczwvY29kZT4KICogIHByb3BlcnR5LCB3aGljaCBpcyBhbiBhcnJheSBvZiBTdHJlYW0gb2JqZWN0cyBwZXJ0YWluaW5nIHRvIHRoZSBzdHJlYW1zIGluIHRoZSBzZXNzaW9uIGF0IHRoYXQgdGltZS4KICogIEZvciBkZXRhaWxzIGFuZCBhIGNvZGUgZXhhbXBsZSwgc2VlIHtAbGluayBTZXNzaW9uQ29ubmVjdEV2ZW50fS48L3A+CiAqCiAqIEBjbGFzcyBTdHJlYW0KICogQHByb3BlcnR5IHtDb25uZWN0aW9ufSBjb25uZWN0aW9uIFRoZSBDb25uZWN0aW9uIG9iamVjdCBjb3JyZXNwb25kaW5nCiAqIHRvIHRoZSBjb25uZWN0aW9uIHRoYXQgaXMgcHVibGlzaGluZyB0aGUgc3RyZWFtLiBZb3UgY2FuIGNvbXBhcmUgdGhpcyB0byB0byB0aGUgPGNvZGU+Y29ubmVjdGlvbjwvY29kZT4KICogcHJvcGVydHkgb2YgdGhlIFNlc3Npb24gb2JqZWN0IHRvIHNlZSBpZiB0aGUgc3RyZWFtIGlzIGJlaW5nIHB1Ymxpc2hlZCBieSB0aGUgbG9jYWwgd2ViIHBhZ2UuCiAqCiAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBjcmVhdGlvblRpbWUgVGhlIHRpbWVzdGFtcCBmb3IgdGhlIGNyZWF0aW9uCiAqIG9mIHRoZSBzdHJlYW0uIFRoaXMgdmFsdWUgaXMgY2FsY3VsYXRlZCBpbiBtaWxsaXNlY29uZHMuIFlvdSBjYW4gY29udmVydCB0aGlzIHZhbHVlIHRvIGEKICogRGF0ZSBvYmplY3QgYnkgY2FsbGluZyA8Y29kZT5uZXcgRGF0ZShjcmVhdGlvblRpbWUpPC9jb2RlPiwgd2hlcmUgPGNvZGU+Y3JlYXRpb25UaW1lPC9jb2RlPiBpcyB0aGUKICogPGNvZGU+Y3JlYXRpb25UaW1lPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUgU3RyZWFtIG9iamVjdC4KICoKICogQHByb3BlcnR5IHtCb29sZWFufSBoYXNBdWRpbyBXaGV0aGVyIHRoZSBzdHJlYW0gaGFzIGF1ZGlvLiBUaGlzIHByb3BlcnR5IGNhbiBjaGFuZ2UgaWYgdGhlIHB1Ymxpc2hlcgogKiB0dXJucyBvbiBvciBvZmYgYXVkaW8gKGJ5IGNhbGxpbmcgPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaEF1ZGlvIj5QdWJsaXNoZXIucHVibGlzaEF1ZGlvKCk8L2E+KS4KICogV2hlbiB0aGlzIG9jY3VycywgdGhlIHtAbGluayBTZXNzaW9ufSBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnN0cmVhbVByb3BlcnR5Q2hhbmdlZDwvY29kZT4gZXZlbnQKICogKHNlZSB7QGxpbmsgU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnR9LikKICoKICogQHByb3BlcnR5IHtCb29sZWFufSBoYXNWaWRlbyBXaGV0aGVyIHRoZSBzdHJlYW0gaGFzIHZpZGVvLiBUaGlzIHByb3BlcnR5IGNhbiBjaGFuZ2UgaWYgdGhlIHB1Ymxpc2hlcgogKiB0dXJucyBvbiBvciBvZmYgdmlkZW8gKGJ5IGNhbGxpbmcgPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaFZpZGVvIj5QdWJsaXNoZXIucHVibGlzaFZpZGVvKCk8L2E+KS4KICogV2hlbiB0aGlzIG9jY3VycywgdGhlIHtAbGluayBTZXNzaW9ufSBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnN0cmVhbVByb3BlcnR5Q2hhbmdlZDwvY29kZT4gZXZlbnQKICogKHNlZSB7QGxpbmsgU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnR9LikKICoKICogQHByb3BlcnR5IHtPYmplY3R9IHZpZGVvRGltZW5zaW9ucyBUaGlzIG9iamVjdCBoYXMgdHdvIHByb3BlcnRpZXM6IDxjb2RlPndpZHRoPC9jb2RlPiBhbmQgPGNvZGU+aGVpZ2h0PC9jb2RlPi4gQm90aCBhcmUKICogbnVtYmVycy4gVGhlIDxjb2RlPndpZHRoPC9jb2RlPiBwcm9wZXJ0eSBpcyB0aGUgd2lkdGggb2YgdGhlIGVuY29kZWQgc3RyZWFtOyB0aGUgPGNvZGU+aGVpZ2h0PC9jb2RlPiBwcm9wZXJ0eSBpcyB0aGUKICogaGVpZ2h0IG9mIHRoZSBlbmNvZGVkIHN0cmVhbS4gKFRoZXNlIGFyZSBpbmRlcGVuZGVudCBvZiB0aGUgYWN0dWFsIHdpZHRoIG9mIFB1Ymxpc2hlciBhbmQgU3Vic2NyaWJlciBvYmplY3RzIGNvcnJlc3BvbmRpbmcKICogdG8gdGhlIHN0cmVhbS4pIFRoaXMgcHJvcGVydHkgY2FuIGNoYW5nZSBpZiBhIHN0cmVhbSBwdWJsaXNoZWQgZnJvbSBhbiBpT1MgZGV2aWNlIHJlc2l6ZXMsIGJhc2VkIG9uIGEgY2hhbmdlIGluIHRoZSBkZXZpY2UKICogb3JpZW50YXRpb24uIFdoZW4gdGhpcyBvY2N1cnMsIHRoZSB7QGxpbmsgU2Vzc2lvbn0gb2JqZWN0IGRpc3BhdGNoZXMgYSA8Y29kZT5zdHJlYW1Qcm9wZXJ0eUNoYW5nZWQ8L2NvZGU+IGV2ZW50IChzZWUKICoge0BsaW5rIFN0cmVhbVByb3BlcnR5Q2hhbmdlZEV2ZW50fS4pCiAqCiAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBzdHJlYW0uIFB1Ymxpc2hlcnMgY2FuIHNwZWNpZnkgYSBuYW1lIHdoZW4gcHVibGlzaGluZyBhIHN0cmVhbQogKiAodXNpbmcgdGhlIDxjb2RlPnB1Ymxpc2goKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBwdWJsaXNoZXIncyBTZXNzaW9uIG9iamVjdCkuCiAqLwpPVC5TdHJlYW0gPSBmdW5jdGlvbihpZCwgY29ubmVjdGlvbiwgbmFtZSwgZGF0YSwgdHlwZSwgY3JlYXRpb25UaW1lLCBoYXNBdWRpbywgaGFzVmlkZW8sIG9yaWVudGF0aW9uLCBwZWVySWQsIHF1YWxpdHksIHdpZHRoLCBoZWlnaHQpIHsKICB2YXIgZGVzdHJveWVkUmVhc29uOwoKICB0aGlzLmlkID0gdGhpcy5zdHJlYW1JZCA9IGlkOwogIHRoaXMuY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLmRhdGEgPSBkYXRhOwogIHRoaXMudHlwZSA9IHR5cGUgfHwgJ2Jhc2ljJzsKICB0aGlzLmNyZWF0aW9uVGltZSA9IGNyZWF0aW9uVGltZSA/IE51bWJlcihjcmVhdGlvblRpbWUpIDogbnVsbDsKICB0aGlzLmhhc0F1ZGlvID0gT1QuJC5jYXN0VG9Cb29sZWFuKGhhc0F1ZGlvLCB0cnVlKTsKICB0aGlzLmhhc1ZpZGVvID0gT1QuJC5jYXN0VG9Cb29sZWFuKGhhc1ZpZGVvLCB0cnVlKTsKICB0aGlzLnBlZXJJZCA9IHBlZXJJZDsKICB0aGlzLnF1YWxpdHkgPSBxdWFsaXR5OwogIHRoaXMudmlkZW9EaW1lbnNpb25zID0geyB3aWR0aDogKHdpZHRoIHx8IDY0MCksIGhlaWdodDogKGhlaWdodCB8fCA0ODApLCBvcmllbnRhdGlvbjogKG9yaWVudGF0aW9uIHx8IE9ULlZpZGVvT3JpZW50YXRpb24uUk9UQVRFRF9OT1JNQUwpIH07CgogIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogIC8vIENvbmZ1c2luZ2x5LCB0aGlzIHNob3VsZCBub3QgYmUgY2FsbGVkIHdoZW4geW91IHdhbnQgdG8gY2hhbmdlCiAgLy8gdGhlIHN0cmVhbSBwcm9wZXJ0aWVzLiBUaGlzIGlzIHVzZWQgYnkgUmFwdG9yIGRpc3BhdGNoIHRvIG5vdGlmeQogIC8vIHRoZSBzdHJlYW0gdGhhdCBpdCdzIHByb3BlcmllcyBoYXZlIGJlZW4gc3VjY2Vzc2Z1bGx5IHVwZGF0ZWQKICAvLwogIC8vIEB0b2RvIG1ha2UgdGhpcyBzYW5lLiBQZXJoYXBzIHVzZSBzZXR0ZXJzIGZvciB0aGUgcHJvcGVydGllcyB0aGF0IGNhbgogIC8vIHNlbmQgdGhlIGFwcHJvcHJpYXRlIFJhcHRvciBtZXNzYWdlLiBUaGlzIHdvdWxkIHJlcXVpcmUgdGhhdCBTdHJlYW1zCiAgLy8gaGF2ZSBhY2Nlc3MgdG8gdGhlaXIgc2Vzc2lvbi4KICAvLwogIHRoaXMudXBkYXRlID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgaWYgKHZhbGlkUHJvcGVydHlOYW1lcy5pbmRleE9mKGtleSkgPT09IC0xKSB7CiAgICAgIE9ULndhcm4oJ1Vua25vd24gc3RyZWFtIHByb3BlcnR5ICInICsga2V5ICsgJyIgd2FzIG1vZGlmaWVkIHRvICInICsgdmFsdWUgKyAnIi4nKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBvbGRWYWx1ZSA9IHRoaXNba2V5XSwKICAgICAgICBuZXdWYWx1ZSA9IHZhbHVlOwoKICAgIHN3aXRjaChrZXkpIHsKICAgICAgY2FzZSAnaGFzQXVkaW8nOgogICAgICBjYXNlICdoYXNWaWRlbyc6CiAgICAgICAgbmV3VmFsdWUgPSBPVC4kLmNhc3RUb0Jvb2xlYW4obmV3VmFsdWUsIHRydWUpOwogICAgICAgIHRoaXNba2V5XSA9IG5ld1ZhbHVlOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAncXVhbGl0eSc6CiAgICAgIGNhc2UgJ25hbWUnOgogICAgICAgIHRoaXNba2V5XSA9IG5ld1ZhbHVlOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnb3JpZW50YXRpb24nOgogICAgICAgIHRoaXMudmlkZW9EaW1lbnNpb25zID0geyB3aWR0aDogbmV3VmFsdWUud2lkdGgsIGhlaWdodDogbmV3VmFsdWUuaGVpZ2h0LCBvcmllbnRhdGlvbjogbmV3VmFsdWUudmlkZW9PcmllbnRhdGlvbiB9OwogICAgfQoKICAgIC8vIFdlIG1hcCB0aGUgJ29yaWVudGF0aW9uJyBrZXkgKHRoYXQgY29tZXMgZnJvbSBSYXB0b3IpIHRvICd2aWRlb0RpbWVuc2lvbnMnIHdoZW4KICAgIC8vIGRpc3BhdGNoaW5nIHRoZSB1cGRhdGVkIGV2ZW50LCBhcyB0aGlzIGlzIGFjdHVhbCBwcm9wZXJ0eSB0aGF0IGlzIG1vZGlmaWVkIG9uIHRoZSBzdHJlYW0KICAgIHZhciBldmVudCA9IG5ldyBPVC5TdHJlYW1VcGRhdGVkRXZlbnQodGhpcywga2V5LCBvbGRWYWx1ZSwgbmV3VmFsdWUpOwogICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICB9OwoKICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbihyZWFzb24sIHF1aWV0KSB7CiAgICBkZXN0cm95ZWRSZWFzb24gPSByZWFzb24gfHwgJ2NsaWVudERpc2Nvbm5lY3RlZCc7CgogICAgaWYgKHF1aWV0ICE9PSB0cnVlKSB7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KAogICAgICAgICAgbmV3IE9ULkRlc3Ryb3llZEV2ZW50KAogICAgICAgICAgICAnZGVzdHJveWVkJywgICAgICAvLyBUaGlzIHNob3VsZCBiZSBPVC5FdmVudC5uYW1lcy5TVFJFQU1fREVTVFJPWUVELCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHZhbHVlIG9mIHRoYXQgaXMgY3VycmVudGx5IHNoYXJlZCB3aXRoIFNlc3Npb24KICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgZGVzdHJveWVkUmVhc29uCiAgICAgICAgICApCiAgICAgICAgKTsKICAgIH0KICB9OwoKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgIGRlc3Ryb3llZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIGRlc3Ryb3llZFJlYXNvbiAhPT0gdm9pZCAwOyB9LAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICB9LAoKICAgICAgZGVzdHJveWVkUmVhc29uOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZGVzdHJveWVkUmVhc29uOyB9LAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICB9CiAgfSk7Cn07CgoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTm9ybWFsaXNlIHRoZXNlCnZhciBOYXRpdmVSVENQZWVyQ29ubmVjdGlvbiA9ICh3aW5kb3cud2Via2l0UlRDUGVlckNvbm5lY3Rpb24gfHwgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uKTsKdmFyIE5hdGl2ZVJUQ1Nlc3Npb25EZXNjcmlwdGlvbiA9ICh3aW5kb3cubW96UlRDU2Vzc2lvbkRlc2NyaXB0aW9uIHx8IHdpbmRvdy5SVENTZXNzaW9uRGVzY3JpcHRpb24pOyAvLyBvcmRlciBpcyB2ZXJ5IGltcG9ydGFudDogIlJUQ1Nlc3Npb25EZXNjcmlwdGlvbiIgZGVmaW5lZCBpbiBGaXJlZm94IE5pZ2hseSBidXQgdXNlbGVzcwp2YXIgTmF0aXZlUlRDSWNlQ2FuZGlkYXRlID0gKHdpbmRvdy5tb3pSVENJY2VDYW5kaWRhdGUgfHwgd2luZG93LlJUQ0ljZUNhbmRpZGF0ZSk7CgovLyBIZWxwZXIgZnVuY3Rpb24gdG8gZm9yd2FyZCBJY2UgQ2FuZGlkYXRlcyB2aWEgK21lc3NhZ2VEZWxlZ2F0ZSsKdmFyIGljZUNhbmRpZGF0ZUZvcndhcmRlciA9IGZ1bmN0aW9uKG1lc3NhZ2VEZWxlZ2F0ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgT1QuZGVidWcoIkljZUNhbmRpZGF0ZUZvcndhcmRlcjogSWNlIENhbmRpZGF0ZSIpOwoKICAgICAgICBpZiAoZXZlbnQuY2FuZGlkYXRlKSB7CiAgICAgICAgICAgIG1lc3NhZ2VEZWxlZ2F0ZShPVC5SYXB0b3IuQWN0aW9ucy5DQU5ESURBVEUsIGV2ZW50LmNhbmRpZGF0ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBPVC5kZWJ1ZygiSWNlQ2FuZGlkYXRlRm9yd2FyZGVyOiBObyBtb3JlIElDRSBjYW5kaWRhdGVzLiIpOwogICAgICAgIH0KICAgIH07Cn07CgoKLy8gUHJvY2VzcyBpbmNvbWluZyBJY2UgQ2FuZGlkYXRlcyBmcm9tIGEgcmVtb3RlIGNvbm5lY3Rpb24gKHdoaWNoIGhhdmUgYmVlbgovLyBmb3J3YXJkZWQgdmlhIGljZUNhbmRpZGF0ZUZvcndhcmRlcikuIFRoZSBJY2UgQ2FuZGlkYXRlcyBjYW5ub3QgYmUgcHJvY2Vzc2VkCi8vIHVudGlsIGEgUGVlckNvbm5lY3Rpb24gaXMgYXZhaWxhYmxlLiBPbmNlIGEgUGVlckNvbm5lY3Rpb24gYmVjb21lcyBhdmFpbGFibGUKLy8gdGhlIHBlbmRpbmcgUGVlckNvbm5lY3Rpb25zIGNhbiBiZSBwcm9jZXNzZWQgYnkgY2FsbGluZyBwcm9jZXNzUGVuZGluZy4KLy8KLy8gQGV4YW1wbGUKLy8KLy8gIHZhciBpY2VQcm9jZXNzb3IgPSBuZXcgSWNlQ2FuZGlkYXRlUHJvY2Vzc29yKCk7Ci8vICBpY2VQcm9jZXNzb3IucHJvY2VzcyhpY2VNZXNzYWdlMSk7Ci8vICBpY2VQcm9jZXNzb3IucHJvY2VzcyhpY2VNZXNzYWdlMik7Ci8vICBpY2VQcm9jZXNzb3IucHJvY2VzcyhpY2VNZXNzYWdlMyk7Ci8vCi8vICBpY2VQcm9jZXNzb3IucGVlckNvbm5lY3Rpb24gPSBwZWVyQ29ubmVjdGlvbjsKLy8gIGljZVByb2Nlc3Nvci5wcm9jZXNzUGVuZGluZygpOwovLwp2YXIgSWNlQ2FuZGlkYXRlUHJvY2Vzc29yID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgX3BlbmRpbmdJY2VDYW5kaWRhdGVzID0gW10sCiAgICAgICAgX3BlZXJDb25uZWN0aW9uID0gbnVsbDsKCgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdwZWVyQ29ubmVjdGlvbicsIHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHBlZXJDb25uZWN0aW9uKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbiA9IHBlZXJDb25uZWN0aW9uOwogICAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMucHJvY2VzcyA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgaWNlQ2FuZGlkYXRlID0gbmV3IE5hdGl2ZVJUQ0ljZUNhbmRpZGF0ZShtZXNzYWdlLmNhbmRpZGF0ZSk7CgogICAgICAgIGlmIChfcGVlckNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uLmFkZEljZUNhbmRpZGF0ZShpY2VDYW5kaWRhdGUpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgX3BlbmRpbmdJY2VDYW5kaWRhdGVzLnB1c2goaWNlQ2FuZGlkYXRlKTsKICAgICAgICB9CiAgICB9OwoKICAgIHRoaXMucHJvY2Vzc1BlbmRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB3aGlsZShfcGVuZGluZ0ljZUNhbmRpZGF0ZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5hZGRJY2VDYW5kaWRhdGUoX3BlbmRpbmdJY2VDYW5kaWRhdGVzLnNoaWZ0KCkpOwogICAgICAgIH0KICAgIH07Cn07CgovLyBSZW1vdmVzIGFsbCBDb25mb3J0IE5vaXNlIGZyb20gK3NkcCsuCi8vCi8vIFNlZSBodHRwczovL2ppcmEudG9rYm94LmNvbS9icm93c2UvT1BFTlRPSy03MTc2Ci8vCnZhciByZW1vdmVDb21mb3J0Tm9pc2UgPSBmdW5jdGlvbiByZW1vdmVDb21mb3J0Tm9pc2UgKHNkcCkgewogICAgLy8gYT1ydHBtYXA6PHBheWxvYWQgdHlwZT4gPGVuY29kaW5nIG5hbWU+LzxjbG9jayByYXRlPiBbLzxlbmNvZGluZyBwYXJhbWV0ZXJzPl0KICAgIHZhciBtYXRjaGVyID0gL2E9cnRwbWFwOihcZCspIENOXC9cZCsvaSwKICAgICAgICBwYXlsb2FkVHlwZXMgPSBbXSwKICAgICAgICBhdWRpb01lZGlhTGluZUluZGV4LAogICAgICAgIHNkcExpbmVzLAogICAgICAgIG1hdGNoOwoKICAgIC8vIElja3kgY29kZS4gVGhpcyBmaWx0ZXIgb3BlcmF0aW9uIGhhcyB0d28gc2lkZSBlZmZlY3RzIGluIGFkZGl0aW9uCiAgICAvLyB0byBkb2luZyB0aGUgYWN0dWFsIGZpbHRlcmluZzoKICAgIC8vICAgMS4gZXh0cmFjdCBhbGwgdGhlIHBheWxvYWQgdHlwZXMgZnJvbSB0aGUgcnRwbWFwIENOIGxpbmVzCiAgICAvLyAgIDIuIGZpbmQgdGhlIGluZGV4IG9mIHRoZSBhdWRpbyBtZWRpYSBsaW5lCiAgICAvLwogICAgc2RwTGluZXMgPSBzZHAuc3BsaXQoIlxyXG4iKS5maWx0ZXIoZnVuY3Rpb24obGluZSwgaW5kZXgpIHsKICAgICAgICBpZiAobGluZS5pbmRleE9mKCdtPWF1ZGlvJykgIT09IC0xKSBhdWRpb01lZGlhTGluZUluZGV4ID0gaW5kZXg7CgogICAgICAgIG1hdGNoID0gbGluZS5tYXRjaChtYXRjaGVyKTsKICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgcGF5bG9hZFR5cGVzLnB1c2gobWF0Y2hbMV0pOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIHRoaXMgbGluZSBhcyBpdCBjb250YWlucyBDTgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwoKICAgIGlmIChwYXlsb2FkVHlwZXMubGVuZ3RoICYmIGF1ZGlvTWVkaWFMaW5lSW5kZXgpIHsKICAgICAgICAvLyBSZW1vdmUgYWxsIENOIHBheWxvYWQgdHlwZXMgZnJvbSB0aGUgYXVkaW8gbWVkaWEgbGluZS4KICAgICAgICBzZHBMaW5lc1thdWRpb01lZGlhTGluZUluZGV4XSA9IHNkcExpbmVzW2F1ZGlvTWVkaWFMaW5lSW5kZXhdLnJlcGxhY2UoIG5ldyBSZWdFeHAocGF5bG9hZFR5cGVzLmpvaW4oJ3wnKSwgJ2lnJykgLCAnJykucmVwbGFjZSgvXHMrL2csICcgJyk7CiAgICB9CgogICAgcmV0dXJuIHNkcExpbmVzLmpvaW4oIlxyXG4iKTsKfTsKCi8vIEF0dGVtcHQgdG8gY29tcGxldGVseSBwcm9jZXNzICtvZmZlcisuIFRoaXMgd2lsbDoKLy8gKiBzZXQgdGhlIG9mZmVyIGFzIHRoZSByZW1vdGUgZGVzY3JpcHRpb24KLy8gKiBjcmVhdGUgYW4gYW5zd2VyIGFuZAovLyAqIHNldCB0aGUgbmV3IGFuc3dlciBhcyB0aGUgbG9jYXRpb24gZGVzY3JpcHRpb24KLy8KLy8gSWYgdGhlcmUgYXJlIG5vIGlzc3VlcywgdGhlICtzdWNjZXNzKyBjYWxsYmFjayB3aWxsIGJlIGV4ZWN1dGVkIG9uIGNvbXBsZXRpb24uCi8vIEVycm9ycyBkdXJpbmcgYW55IHN0ZXAgd2lsbCByZXN1bHQgaW4gdGhlICtmYWlsdXJlKyBjYWxsYmFjayBiZWluZyBleGVjdXRlZC4KLy8KdmFyIG9mZmVyUHJvY2Vzc29yID0gZnVuY3Rpb24ocGVlckNvbm5lY3Rpb24sIG9mZmVyLCBzdWNjZXNzLCBmYWlsdXJlKSB7CiAgICB2YXIgZ2VuZXJhdGVFcnJvckNhbGxiYWNrID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgICAgIGlmIChmYWlsdXJlKSBmYWlsdXJlKG1lc3NhZ2UsIGVycm9yUmVhc29uKTsKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICBzZXRMb2NhbERlc2NyaXB0aW9uID0gZnVuY3Rpb24oYW5zd2VyKSB7CiAgICAgICAgICAgIGFuc3dlci5zZHAgPSByZW1vdmVDb21mb3J0Tm9pc2UoYW5zd2VyLnNkcCk7CgogICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKAogICAgICAgICAgICAgICAgYW5zd2VyLAoKICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoYW5zd2VyKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gRmFpbHVyZQogICAgICAgICAgICAgICAgZ2VuZXJhdGVFcnJvckNhbGxiYWNrKCdFcnJvciB3aGlsZSBzZXR0aW5nIExvY2FsRGVzY3JpcHRpb24nKQogICAgICAgICAgICApOwogICAgICAgIH0sCgogICAgICAgIGNyZWF0ZUFuc3dlciA9IGZ1bmN0aW9uKG9uU3VjY2VzcykgewogICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5jcmVhdGVBbnN3ZXIoCiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzCiAgICAgICAgICAgICAgICBzZXRMb2NhbERlc2NyaXB0aW9uLAoKICAgICAgICAgICAgICAgIC8vIEZhaWx1cmUKICAgICAgICAgICAgICAgIGdlbmVyYXRlRXJyb3JDYWxsYmFjaygnRXJyb3Igd2hpbGUgc2V0dGluZyBjcmVhdGVBbnN3ZXInKSwKCiAgICAgICAgICAgICAgICBudWxsLCAvLyBNZWRpYUNvbnN0cmFpbnRzCiAgICAgICAgICAgICAgICBmYWxzZSAvLyBjcmVhdGVQcm92aXNpb25hbEFuc3dlcgogICAgICAgICAgICApOwogICAgICAgIH07CgogICAgLy8gV29ya2Fyb3VuZCBmb3IgYSBDaHJvbWUgaXNzdWUuIEFkZCBpbiB0aGUgU0RFUyBjcnlwdG8gbGluZSBpbnRvIG9mZmVycwogICAgLy8gZnJvbSBGaXJlZm94CiAgICBpZiAob2ZmZXIuc2RwLmluZGV4T2YoJ2E9Y3J5cHRvJykgPT09IC0xKSB7CiAgICAgICAgdmFyIGNyeXB0b19saW5lID0gImE9Y3J5cHRvOjEgQUVTX0NNXzEyOF9ITUFDX1NIQTFfODAgaW5saW5lOkZha2VGYWtlRmFrZUZha2VGYWtlRmFrZUZha2VGYWtlRmFrZUZha2VcXHJcXG4iOwoKICAgICAgICAvLyBpbnNlcnQgdGhlIGZha2UgY3J5cHRvIGxpbmUgZm9yIGV2ZXJ5IE0gbGluZQogICAgICAgIG9mZmVyLnNkcCA9IG9mZmVyLnNkcC5yZXBsYWNlKC9eYz1JTiguKikkL2dtaSwgImM9SU4kMVxyXG4iK2NyeXB0b19saW5lKTsKICAgIH0KCiAgICBpZiAob2ZmZXIuc2RwLmluZGV4T2YoJ2E9cnRjcC1mYicpID09PSAtMSkgewogICAgICAgIHZhciBydGNwX2ZiX2xpbmUgPSAiYT1ydGNwLWZiOiogY2NtIGZpclxyXG5hPXJ0Y3AtZmI6KiBuYWNrICI7CgogICAgICAgIC8vIGluc2VydCB0aGUgZmFrZSBjcnlwdG8gbGluZSBmb3IgZXZlcnkgTSBsaW5lCiAgICAgICAgb2ZmZXIuc2RwID0gb2ZmZXIuc2RwLnJlcGxhY2UoL15tPXZpZGVvKC4qKSQvZ21pLCAibT12aWRlbyQxXHJcbiIrcnRjcF9mYl9saW5lKTsKICAgIH0KCiAgICBwZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbigKICAgICAgICBvZmZlciwKCiAgICAgICAgLy8gU3VjY2VzcwogICAgICAgIGNyZWF0ZUFuc3dlciwKCiAgICAgICAgLy8gRmFpbHVyZQogICAgICAgIGdlbmVyYXRlRXJyb3JDYWxsYmFjaygnRXJyb3Igd2hpbGUgc2V0dGluZyBSZW1vdGVEZXNjcmlwdGlvbicpCiAgICApOwoKfTsKCi8vIEF0dGVtcHQgdG8gY29tcGxldGVseSBwcm9jZXNzIGEgc3Vic2NyaWJlIG1lc3NhZ2UuIFRoaXMgd2lsbDoKLy8gKiBjcmVhdGUgYW4gT2ZmZXIKLy8gKiBzZXQgdGhlIG5ldyBvZmZlciBhcyB0aGUgbG9jYXRpb24gZGVzY3JpcHRpb24KLy8KLy8gSWYgdGhlcmUgYXJlIG5vIGlzc3VlcywgdGhlICtzdWNjZXNzKyBjYWxsYmFjayB3aWxsIGJlIGV4ZWN1dGVkIG9uIGNvbXBsZXRpb24uCi8vIEVycm9ycyBkdXJpbmcgYW55IHN0ZXAgd2lsbCByZXN1bHQgaW4gdGhlICtmYWlsdXJlKyBjYWxsYmFjayBiZWluZyBleGVjdXRlZC4KLy8KdmFyIHN1c2NyaWJlUHJvY2Vzc29yID0gZnVuY3Rpb24ocGVlckNvbm5lY3Rpb24sIHN1Y2Nlc3MsIGZhaWx1cmUpIHsKICAgIHZhciBjb25zdHJhaW50cyA9IHsKICAgICAgICAgICAgbWFuZGF0b3J5OiB7fSwKICAgICAgICAgICAgb3B0aW9uYWw6IFtdCiAgICAgICAgfSwKCiAgICAgICAgZ2VuZXJhdGVFcnJvckNhbGxiYWNrID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgICAgIGlmIChmYWlsdXJlKSBmYWlsdXJlKG1lc3NhZ2UsIGVycm9yUmVhc29uKTsKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICBzZXRMb2NhbERlc2NyaXB0aW9uID0gZnVuY3Rpb24ob2ZmZXIpIHsKICAgICAgICAgICAgb2ZmZXIuc2RwID0gcmVtb3ZlQ29tZm9ydE5vaXNlKG9mZmVyLnNkcCk7CgogICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKAogICAgICAgICAgICAgICAgb2ZmZXIsCgogICAgICAgICAgICAgICAgLy8gU3VjY2VzcwogICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyhvZmZlcik7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEZhaWx1cmUKICAgICAgICAgICAgICAgIGdlbmVyYXRlRXJyb3JDYWxsYmFjaygnRXJyb3Igd2hpbGUgc2V0dGluZyBMb2NhbERlc2NyaXB0aW9uJykKICAgICAgICAgICAgKTsKICAgICAgICB9OwoKCiAgICAvLyBGb3IgaW50ZXJvcCB3aXRoIEZpcmVGb3guIERpc2FibGUgRGF0YSBDaGFubmVsIGluIGNyZWF0ZU9mZmVyLgogICAgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEpIHsKICAgICAgICBjb25zdHJhaW50cy5tYW5kYXRvcnkuTW96RG9udE9mZmVyRGF0YUNoYW5uZWwgPSB0cnVlOwogICAgfQoKICAgIHBlZXJDb25uZWN0aW9uLmNyZWF0ZU9mZmVyKAogICAgICAgIC8vIFN1Y2Nlc3MKICAgICAgICBzZXRMb2NhbERlc2NyaXB0aW9uLAoKICAgICAgICAvLyBGYWlsdXJlCiAgICAgICAgZ2VuZXJhdGVFcnJvckNhbGxiYWNrKCdFcnJvciB3aGlsZSBjcmVhdGluZyBPZmZlcicpLAoKICAgICAgICBjb25zdHJhaW50cwogICAgKTsKfTsKCi8qKgogKiBOZWdvdGlhdGVzIGEgV2ViUlRDIFBlZXJDb25uZWN0aW9uLgogKgogKiBSZXNwb25zaWJsZSBmb3I6CiAqICogb2ZmZXItYW5zd2VyIGV4Y2hhbmdlCiAqICogaWNlQ2FuZGlkYXRlcwogKiAqIG5vdGlmaWNhdGlvbiBvZiByZW1vdGUgc3RyZWFtcyBiZWluZyBhZGRlZC9yZW1vdmVkCiAqCiAqLwpPVC5QZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgdmFyIF9wZWVyQ29ubmVjdGlvbiwKICAgICAgICBfaWNlUHJvY2Vzc29yID0gbmV3IEljZUNhbmRpZGF0ZVByb2Nlc3NvcigpLAogICAgICAgIF9vZmZlciwKICAgICAgICBfYW5zd2VyLAogICAgICAgIF9zdGF0ZSA9ICduZXcnLAogICAgICAgIF9pY2VDYW5kaWRhdGVzR2F0aGVyZWQgPSBmYWxzZSwKICAgICAgICBfbWVzc2FnZURlbGVnYXRlcyA9IFtdLAogICAgICAgIF9nZXR0aW5nU3RhdHMsCiAgICAgICAgX2NyZWF0ZVRpbWUgPSBPVC4kLm5vdygpOwoKICAgIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogICAgLy8gaWYgaWNlIHNlcnZlcnMgZG9lc24ndCBleGlzdCBGaXJlZm94IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uLiBDaHJvbWUKICAgIC8vIGludGVycHJldHMgdGhpcyBhcyAiVXNlIG15IGRlZmF1bHQgU1RVTiBzZXJ2ZXJzIiB3aGVyZWFzIEZGIHJlYWRzIGl0CiAgICAvLyBhcyAiRG9uJ3QgdXNlIFNUVU4gYXQgYWxsIi4gKkdydW1ibGUqCiAgICBpZiAoIWNvbmZpZy5pY2VTZXJ2ZXJzKSBjb25maWcuaWNlU2VydmVycyA9IFtdOwoKICAgIC8vIFByaXZhdGUgbWV0aG9kcwogICAgdmFyIGRlbGVnYXRlTWVzc2FnZSA9IGZ1bmN0aW9uKHR5cGUsIG1lc3NhZ2VQYXlsb2FkKSB7CiAgICAgICAgICAgIGlmIChfbWVzc2FnZURlbGVnYXRlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFdlIGFjdHVhbGx5IG9ubHkgZXZlciBzZW5kIHRvIHRoZSBmaXJzdCBkZWxlZ2F0ZS4gVGhpcyBpcyBiZWNhdXNlCiAgICAgICAgICAgICAgICAvLyBlYWNoIGRlbGVnYXRlIGFjdHVhbGx5IHJlcHJlc2VudHMgYSBQdWJsaXNoZXIvU3Vic2NyaWJlciB0aGF0CiAgICAgICAgICAgICAgICAvLyBzaGFyZXMgYSBzaW5nbGUgUGVlckNvbm5lY3Rpb24uIElmIHdlIHNlbnQgdG8gYWxsIGRlbGVnYXRlcyBpdAogICAgICAgICAgICAgICAgLy8gd291bGQgcmVzdWx0IGluIGVhY2ggbWVzc2FnZSBiZWluZyBwcm9jZXNzZWQgbXVsdGlwbGUgdGltZXMgYnkKICAgICAgICAgICAgICAgIC8vIGVhY2ggUGVlckNvbm5lY3Rpb24uCiAgICAgICAgICAgICAgICBfbWVzc2FnZURlbGVnYXRlc1swXSh0eXBlLCBtZXNzYWdlUGF5bG9hZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LmJpbmQodGhpcyksCgoKICAgICAgICBzZXR1cFBlZXJDb25uZWN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghX3BlZXJDb25uZWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIE9ULmRlYnVnKCJDcmVhdGluZyBwZWVyIGNvbm5lY3Rpb24gY29uZmlnIFwiIiArIEpTT04uc3RyaW5naWZ5KGNvbmZpZykgKyAiXCIuIik7CgoKICAgICAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24gPSBuZXcgTmF0aXZlUlRDUGVlckNvbm5lY3Rpb24oY29uZmlnLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbmFsOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7RHRsc1NydHBLZXlBZ3JlZW1lbnQ6IHRydWV9CiAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIE9ULmVycm9yKCJGYWlsZWQgdG8gY3JlYXRlIFBlZXJDb25uZWN0aW9uLCBleGNlcHRpb246ICIgKyBlLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9pY2VQcm9jZXNzb3IucGVlckNvbm5lY3Rpb24gPSBfcGVlckNvbm5lY3Rpb247CgogICAgICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uLm9uaWNlY2FuZGlkYXRlID0gaWNlQ2FuZGlkYXRlRm9yd2FyZGVyKGRlbGVnYXRlTWVzc2FnZSk7CiAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24ub25hZGRzdHJlYW0gPSBvblJlbW90ZVN0cmVhbUFkZGVkLmJpbmQodGhpcyk7CiAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24ub25yZW1vdmVzdHJlYW0gPSBvblJlbW90ZVN0cmVhbVJlbW92ZWQuYmluZCh0aGlzKTsKCiAgICAgICAgICAgICAgICBpZiAoX3BlZXJDb25uZWN0aW9uLm9uc2lnbmFsaW5nc3RhdGVjaGFuZ2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5vbnNpZ25hbGluZ3N0YXRlY2hhbmdlID0gcm91dGVTdGF0ZUNoYW5nZWQuYmluZCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoX3BlZXJDb25uZWN0aW9uLm9uc3RhdGVjaGFuZ2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5vbnN0YXRlY2hhbmdlID0gcm91dGVTdGF0ZUNoYW5nZWQuYmluZCh0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIF9wZWVyQ29ubmVjdGlvbjsKICAgICAgICB9LmJpbmQodGhpcyksCgogICAgICAgIC8vIENsZWFuIHVwIHRoZSBQZWVyIENvbm5lY3Rpb24gYW5kIHRyaWdnZXIgdGhlIGNsb3NlIGV2ZW50LgogICAgICAgIC8vIFRoaXMgZnVuY3Rpb24gY2FuIGJlIGNhbGxlZCBzYWZlbHkgbXVsdGlwbGUgdGltZXMsIGl0IHdpbGwKICAgICAgICAvLyBvbmx5IHRyaWdnZXIgdGhlIGNsb3NlIGV2ZW50IG9uY2UgKHBlciBQZWVyQ29ubmVjdGlvbiBvYmplY3QpCiAgICAgICAgdGVhckRvd25QZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBPdXIgY29ubmVjdGlvbiBpcyBkZWFkLCBzdG9wIHByb2Nlc3NpbmcgSUNFIGNhbmRpZGF0ZXMKICAgICAgICAgICAgaWYgKF9pY2VQcm9jZXNzb3IpIF9pY2VQcm9jZXNzb3IucGVlckNvbm5lY3Rpb24gPSBudWxsOwoKICAgICAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2xvc2UnKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHJvdXRlU3RhdGVDaGFuZ2VkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlOwoKICAgICAgICAgICAgaWYgKHR5cGVvZihldmVudCkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgbmV3ZXN0IHZlcnNpb24gb2YgdGhlIEFQSQogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBldmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChldmVudC50YXJnZXQgJiYgZXZlbnQudGFyZ2V0LnNpZ25hbGluZ1N0YXRlKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgc2xpZ2h0bHkgb2xkZXIgdmVyc2lvbgogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBldmVudC50YXJnZXQuc2lnbmFsaW5nU3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBBdCBsZWFzdCBzaXggbW9udGhzIG9sZCB2ZXJzaW9uLiBQb3NpdGl2ZWx5IGFuY2llbnQsIHllYWg/CiAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IGV2ZW50LnRhcmdldC5yZWFkeVN0YXRlOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgT1QuZGVidWcoJ1BlZXJDb25uZWN0aW9uLnN0YXRlQ2hhbmdlOiAnICsgbmV3U3RhdGUpOwogICAgICAgICAgICBpZiAobmV3U3RhdGUgJiYgbmV3U3RhdGUudG9Mb3dlckNhc2UoKSAhPT0gX3N0YXRlKSB7CiAgICAgICAgICAgICAgICBfc3RhdGUgPSBuZXdTdGF0ZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgT1QuZGVidWcoJ1BlZXJDb25uZWN0aW9uLnN0YXRlQ2hhbmdlOiAnICsgX3N0YXRlKTsKCiAgICAgICAgICAgICAgICBzd2l0Y2goX3N0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2xvc2VkJzoKICAgICAgICAgICAgICAgICAgICAgICAgdGVhckRvd25QZWVyQ29ubmVjdGlvbi5jYWxsKHRoaXMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBnZXRMb2NhbFN0cmVhbXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0cmVhbXM7CgogICAgICAgICAgICBpZiAoX3BlZXJDb25uZWN0aW9uLmdldExvY2FsU3RyZWFtcykgewogICAgICAgICAgICAgICAgc3RyZWFtcyA9IF9wZWVyQ29ubmVjdGlvbi5nZXRMb2NhbFN0cmVhbXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChfcGVlckNvbm5lY3Rpb24ubG9jYWxTdHJlYW1zKSB7CiAgICAgICAgICAgICAgICBzdHJlYW1zID0gX3BlZXJDb25uZWN0aW9uLmxvY2FsU3RyZWFtczsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBQZWVyIENvbm5lY3Rpb24gb2JqZWN0IGltcGxlbWVudHMgbm8gbWV0aG9kIGZvciByZXRyaWV2aW5nIGxvY2FsIHN0cmVhbXMiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRm9yY2Ugc3RyZWFtcyB0byBiZSBhbiBBcnJheSwgcmF0aGVyIHRoYW4gYSAiU2VxdWVuY2UiIG9iamVjdCwKICAgICAgICAgICAgLy8gd2hpY2ggaXMgYnJvd3NlciBkZXBlbmRlbnQgYW5kIGRvZXMgbm90IGJlaGF2aW91ciBsaWtlIGFuIEFycmF5CiAgICAgICAgICAgIC8vIGluIGV2ZXJ5IGNhc2UuCiAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChzdHJlYW1zKTsKICAgICAgICB9LAoKICAgICAgICBnZXRSZW1vdGVTdHJlYW1zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzdHJlYW1zOwoKICAgICAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbi5nZXRSZW1vdGVTdHJlYW1zKSB7CiAgICAgICAgICAgICAgICBzdHJlYW1zID0gX3BlZXJDb25uZWN0aW9uLmdldFJlbW90ZVN0cmVhbXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChfcGVlckNvbm5lY3Rpb24ucmVtb3RlU3RyZWFtcykgewogICAgICAgICAgICAgICAgc3RyZWFtcyA9IF9wZWVyQ29ubmVjdGlvbi5yZW1vdGVTdHJlYW1zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIFBlZXIgQ29ubmVjdGlvbiBvYmplY3QgaW1wbGVtZW50cyBubyBtZXRob2QgZm9yIHJldHJpZXZpbmcgcmVtb3RlIHN0cmVhbXMiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRm9yY2Ugc3RyZWFtcyB0byBiZSBhbiBBcnJheSwgcmF0aGVyIHRoYW4gYSAiU2VxdWVuY2UiIG9iamVjdCwKICAgICAgICAgICAgLy8gd2hpY2ggaXMgYnJvd3NlciBkZXBlbmRlbnQgYW5kIGRvZXMgbm90IGJlaGF2aW91ciBsaWtlIGFuIEFycmF5CiAgICAgICAgICAgIC8vIGluIGV2ZXJ5IGNhc2UuCiAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChzdHJlYW1zKTsKICAgICAgICB9LAoKICAgICAgICBnZW5lcmF0ZUVycm9yQ2FsbGJhY2sgPSBmdW5jdGlvbihmb3JNZXRob2QsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGVycm9yUmVhc29uKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyRXJyb3IuY2FsbCh0aGlzLCAiUGVlckNvbm5lY3Rpb24uIiArIGZvck1ldGhvZCArICI6ICIgKyBtZXNzYWdlICsgIjogIiArIGVycm9yUmVhc29uKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIC8vLyBQZWVyQ29ubmVjdGlvbiBzaWduYWxpbmcKICAgICAgICBvblJlbW90ZVN0cmVhbUFkZGVkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdHJlYW1BZGRlZCcsIGV2ZW50LnN0cmVhbSk7CiAgICAgICAgfSwKCiAgICAgICAgb25SZW1vdGVTdHJlYW1SZW1vdmVkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdHJlYW1SZW1vdmVkJywgZXZlbnQuc3RyZWFtKTsKICAgICAgICB9LAoKICAgICAgICAvLyBJQ0UgTmVnb3RpYXRpb24gbWVzc2FnZXMKCgogICAgICAgIC8vIFJlbGF5cyBhIFNEUCBwYXlsb2FkICgrc2RwKyksIHRoYXQgaXMgcGFydCBvZiBhIG1lc3NhZ2Ugb2YgdHlwZSArbWVzc2FnZVR5cGUrCiAgICAgICAgLy8gdmlhIHRoZSByZWdpc3RlcmVkIG1lc3NhZ2UgZGVsZWdhdG9ycwogICAgICAgIHJlbGF5U0RQID0gZnVuY3Rpb24obWVzc2FnZVR5cGUsIHNkcCkgewogICAgICAgICAgICBkZWxlZ2F0ZU1lc3NhZ2UobWVzc2FnZVR5cGUsIHNkcCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gUHJvY2VzcyBhbiBvZmZlciB0aGF0CiAgICAgICAgcHJvY2Vzc09mZmVyID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICB2YXIgb2ZmZXIgPSBuZXcgTmF0aXZlUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2Uuc2RwKSwKCiAgICAgICAgICAgICAgICAvLyBSZWxheXMgK2Fuc3dlcisgQW5zd2VyCiAgICAgICAgICAgICAgICByZWxheUFuc3dlciA9IGZ1bmN0aW9uKGFuc3dlcikgewogICAgICAgICAgICAgICAgICAgIHJlbGF5U0RQKE9ULlJhcHRvci5BY3Rpb25zLkFOU1dFUiwgYW5zd2VyKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcmVwb3J0RXJyb3IgPSBmdW5jdGlvbihtZXNzYWdlLCBlcnJvclJlYXNvbikgewogICAgICAgICAgICAgICAgICAgIHRyaWdnZXJFcnJvcigiUGVlckNvbm5lY3Rpb24ub2ZmZXJQcm9jZXNzb3IgIiArIG1lc3NhZ2UgKyAiOiAiICsgZXJyb3JSZWFzb24pOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNldHVwUGVlckNvbm5lY3Rpb24oKTsKCiAgICAgICAgICAgIF9yZW1vdGVEZXNjcmlwdGlvblR5cGUgPSBvZmZlci50eXBlOwogICAgICAgICAgICBfcmVtb3RlRGVzY3JpcHRpb24gPSBvZmZlcjsKCiAgICAgICAgICAgIG9mZmVyUHJvY2Vzc29yKAogICAgICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uLAogICAgICAgICAgICAgICAgb2ZmZXIsCiAgICAgICAgICAgICAgICByZWxheUFuc3dlciwKICAgICAgICAgICAgICAgIHJlcG9ydEVycm9yCiAgICAgICAgICAgICk7CiAgICAgICAgfSwKCiAgICAgICAgcHJvY2Vzc0Fuc3dlciA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgICAgaWYgKCFtZXNzYWdlLnNkcCkgewogICAgICAgICAgICAgICAgT1QuZXJyb3IoIlBlZXJDb25uZWN0aW9uLnByb2Nlc3NNZXNzYWdlOiBXZWlyZCBtZXNzYWdlLCBubyBTRFAuIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9hbnN3ZXIgPSBuZXcgTmF0aXZlUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2Uuc2RwKTsKCiAgICAgICAgICAgIF9yZW1vdGVEZXNjcmlwdGlvblR5cGUgPSBfYW5zd2VyLnR5cGU7CiAgICAgICAgICAgIF9yZW1vdGVEZXNjcmlwdGlvbiA9IF9hbnN3ZXI7CgogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24uc2V0UmVtb3RlRGVzY3JpcHRpb24oX2Fuc3dlcik7CiAgICAgICAgICAgIF9pY2VQcm9jZXNzb3IucHJvY2Vzc1BlbmRpbmcoKTsKICAgICAgICB9LAoKICAgICAgICBwcm9jZXNzU3Vic2NyaWJlID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICBPVC5kZWJ1ZygiUGVlckNvbm5lY3Rpb24ucHJvY2Vzc1N1YnNjcmliZTogU2VuZGluZyBvZmZlciB0byBzdWJzY3JpYmVyLiIpOwoKICAgICAgICAgICAgc2V0dXBQZWVyQ29ubmVjdGlvbigpOwoKICAgICAgICAgICAgc3VzY3JpYmVQcm9jZXNzb3IoCiAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24sCgogICAgICAgICAgICAgICAgLy8gU3VjY2VzczogUmVsYXkgT2ZmZXIKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKG9mZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgX29mZmVyID0gb2ZmZXI7CiAgICAgICAgICAgICAgICAgICAgcmVsYXlTRFAoT1QuUmFwdG9yLkFjdGlvbnMuT0ZGRVIsIF9vZmZlcik7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEZhaWx1cmUKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKG1lc3NhZ2UsIGVycm9yUmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlckVycm9yKCJQZWVyQ29ubmVjdGlvbi5zdXNjcmliZVByb2Nlc3NvciAiICsgbWVzc2FnZSArICI6ICIgKyBlcnJvclJlYXNvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlckVycm9yID0gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgT1QuZXJyb3IoZXJyb3JSZWFzb24pOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgZXJyb3JSZWFzb24pOwogICAgICAgIH0uYmluZCh0aGlzKTsKCiAgICB0aGlzLmFkZExvY2FsU3RyZWFtID0gZnVuY3Rpb24od2ViUlRDU3RyZWFtKSB7CiAgICAgICAgc2V0dXBQZWVyQ29ubmVjdGlvbigpOwogICAgICAgIF9wZWVyQ29ubmVjdGlvbi5hZGRTdHJlYW0od2ViUlRDU3RyZWFtKTsKICAgIH07CgogICAgdGhpcy5kaXNjb25uZWN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgX2ljZVByb2Nlc3NvciA9IG51bGw7CgogICAgICAgIGlmIChfcGVlckNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IChfcGVlckNvbm5lY3Rpb24uc2lnbmFsaW5nU3RhdGUgfHwgX3BlZXJDb25uZWN0aW9uLnJlYWR5U3RhdGUpOwogICAgICAgICAgICBpZiAoY3VycmVudFN0YXRlICYmIGN1cnJlbnRTdGF0ZS50b0xvd2VyQ2FzZSgpICE9PSAnY2xvc2VkJykgX3BlZXJDb25uZWN0aW9uLmNsb3NlKCk7CgogICAgICAgICAgICAvLyBJbiB0aGVvcnksIGNhbGxpbmcgY2xvc2Ugb24gdGhlIFBlZXJDb25uZWN0aW9uIHNob3VsZCB0cmlnZ2VyIGEgc3RhdGVjaGFuZ2UKICAgICAgICAgICAgLy8gZXZlbnQgd2l0aCAnY2xvc2UnLiBGb3Igc29tZSByZWFzb24gSSdtIG5vdCBzZWVpbmcgdGhpcyBpbiBGRiwgaGVuY2Ugd2UncmUKICAgICAgICAgICAgLy8gY2FsbGluZyBpdCBtYW51YWxseSBiZWxvdwogICAgICAgICAgICB0ZWFyRG93blBlZXJDb25uZWN0aW9uLmNhbGwodGhpcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLm9mZigpOwogICAgfTsKCiAgICB0aGlzLnByb2Nlc3NNZXNzYWdlID0gZnVuY3Rpb24odHlwZSwgbWVzc2FnZSkgewogICAgICAgIE9ULmRlYnVnKCJQZWVyQ29ubmVjdGlvbi5wcm9jZXNzTWVzc2FnZTogUmVjZWl2ZWQgIiArIHR5cGUgKyAiIGZyb20gIiArIG1lc3NhZ2UuZnJvbUFkZHJlc3MpOwogICAgICAgIE9ULmRlYnVnKG1lc3NhZ2UpOwoKICAgICAgICBzd2l0Y2godHlwZSkgewogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlNVQlNDUklCRToKICAgICAgICAgICAgICAgIHByb2Nlc3NTdWJzY3JpYmUuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5PRkZFUjoKICAgICAgICAgICAgICAgIHByb2Nlc3NPZmZlci5jYWxsKHRoaXMsIG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLkFOU1dFUjoKICAgICAgICAgICAgLy8gY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5QUkFOU1dFUjoKICAgICAgICAgICAgICAgIHByb2Nlc3NBbnN3ZXIuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DQU5ESURBVEU6CiAgICAgICAgICAgICAgICBfaWNlUHJvY2Vzc29yLnByb2Nlc3MobWVzc2FnZSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBPVC5kZWJ1ZygiUGVlckNvbm5lY3Rpb24ucHJvY2Vzc01lc3NhZ2U6IFJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgbWVzc2FnZSBvZiB0eXBlICIgKyB0eXBlICsgIiBmcm9tICIgKyBtZXNzYWdlLmZyb21BZGRyZXNzICsgIjogIiArIEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB0aGlzLnJlZ2lzdGVyTWVzc2FnZURlbGVnYXRlID0gZnVuY3Rpb24oZGVsZWdhdGVGbikgewogICAgICAgIHJldHVybiBfbWVzc2FnZURlbGVnYXRlcy5wdXNoKGRlbGVnYXRlRm4pOwogICAgfTsKCiAgICB0aGlzLnVucmVnaXN0ZXJNZXNzYWdlRGVsZWdhdGUgPSBmdW5jdGlvbihkZWxlZ2F0ZUZuKSB7CiAgICAgICAgdmFyIGluZGV4ID0gX21lc3NhZ2VEZWxlZ2F0ZXMuaW5kZXhPZihkZWxlZ2F0ZUZuKTsKCiAgICAgICAgaWYgKCBpbmRleCAhPT0gLTEgKSB7CiAgICAgICAgICAgIF9tZXNzYWdlRGVsZWdhdGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBfbWVzc2FnZURlbGVnYXRlcy5sZW5ndGg7CiAgICB9OwoKICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSBQZWVyQ29ubmVjdGlvbiBzdGF0cy4KICAgICAqCiAgICAgKiBUT0RPIGRvY3VtZW50IHdoYXQgdGhlIGZvcm1hdCBvZiB0aGUgZmluYWwgcmVwb3J0cyB0aGF0ICtjYWxsYmFjaysgZ2V0cyBpcwogICAgICoKICAgICAqIEBpZ25vcmUKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbWVtYmVyb2YgUGVlckNvbm5lY3Rpb24KICAgICAqIEBwYXJhbSBjYWxsYmFjayB7RnVuY3Rpb259IHRoaXMgd2lsbCBiZSB0cmlnZ2VyZWQgb25jZSB0aGUgc3RhdHMgYSBhcmUgcmVhZHkuCiAgICAgKiBJdCB0YWtlcyBhIHNpbmdsZSBhcmd1bWVudCB3aGljaCBpcyB0aGUgc3RhdHMgcmVwb3J0LCB3aGljaCBtYXkgYmUgdW5kZWZpbmVkCiAgICAgKiBpZiB0aGVyZSBpcyBwcmVzZW50bHkgbm8gc3RhdHMuCiAgICAgKi8KICAgIHRoaXMuZ2V0U3RhdHMgPSBmdW5jdGlvbihwcmV2U3RhdHMsIGNhbGxiYWNrKSB7CiAgICAgICAgLy8gbmVlZCB0byBtYWtlIHN1cmUgdGhhdCB0aGlzIGlzbid0IGNhbGxlZCBhZ2FpbiB3aGVuIGluIHRoZSBtaWRkbGUgb2YgcHJvY2Vzc2luZwogICAgICAgIGlmIChfZ2V0dGluZ1N0YXRzID09IHRydWUpIHsKICAgICAgICAgICAgT1Qud2FybigiUGVlckNvbm5lY3Rpb24uZ2V0U3RhdHM6IEFscmVhZHkgZ2V0dGluZyB0aGUgc3RhdHMhIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIGxvY2tpbmcgdGhpcyBmdW5jdGlvbgogICAgICAgIF9nZXR0aW5nU3RhdHMgPSB0cnVlOwoKICAgICAgICAvLyBnZXQgdGhlIHByZXZpb3VzIHRpbWVzdGFtcCAoc2Vjb25kcykKICAgICAgICB2YXIgbm93ID0gT1QuJC5ub3coKTsKICAgICAgICB2YXIgdGltZV9kaWZmZXJlbmNlID0gKG5vdyAtIHByZXZTdGF0c1sidGltZVN0YW1wIl0pIC8gMTAwMDsgLy8gaG93IG1hbnkgc2Vjb25kcyBoYXMgcGFzc2VkCgogICAgICAgIC8vIG5vdyB1cGRhdGUgdGhlIGRhdGUKICAgICAgICBwcmV2U3RhdHNbInRpbWVTdGFtcCJdID0gbm93OwoKICAgICAgICAvKiB0aGlzIHBhcnNlcyBhIHJlc3VsdCBpZiB0aGVyZSBpdCBjb250YWlucyB0aGUgdmlkZW8gYml0cmF0ZSAqLwogICAgICAgIHZhciBwYXJzZUF2Z1ZpZGVvQml0cmF0ZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgICB2YXIgbGFzdF9ieXRlc1NlbnQgPSBwcmV2U3RhdHNbInZpZGVvQnl0ZXNUcmFuc2ZlcnJlZCJdIHx8IDA7CgogICAgICAgICAgICBpZiAocmVzdWx0LnN0YXQoImdvb2dGcmFtZUhlaWdodFNlbnQiKSkgewogICAgICAgICAgICAgICAgcHJldlN0YXRzWyJ2aWRlb0J5dGVzVHJhbnNmZXJyZWQiXSA9IHJlc3VsdC5zdGF0KCJieXRlc1NlbnQiKTsKICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKChwcmV2U3RhdHNbInZpZGVvQnl0ZXNUcmFuc2ZlcnJlZCJdIC0gbGFzdF9ieXRlc1NlbnQpICogOCAvIHRpbWVfZGlmZmVyZW5jZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzdWx0LnN0YXQoImdvb2dGcmFtZUhlaWdodFJlY2VpdmVkIikpIHsKICAgICAgICAgICAgICAgIHByZXZTdGF0c1sidmlkZW9CeXRlc1RyYW5zZmVycmVkIl0gPSByZXN1bHQuc3RhdCgiYnl0ZXNSZWNlaXZlZCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoKHByZXZTdGF0c1sidmlkZW9CeXRlc1RyYW5zZmVycmVkIl0gLSBsYXN0X2J5dGVzU2VudCkgKiA4IC8gdGltZV9kaWZmZXJlbmNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBOYU47CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKiB0aGlzIHBhcnNlcyBhIHJlc3VsdCBpZiB0aGVyZSBpdCBjb250YWlucyB0aGUgYXVkaW8gYml0cmF0ZSAqLwogICAgICAgIHZhciBwYXJzZUF2Z0F1ZGlvQml0cmF0ZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgICB2YXIgbGFzdF9ieXRlc1NlbnQgPSBwcmV2U3RhdHNbImF1ZGlvQnl0ZXNUcmFuc2ZlcnJlZCJdIHx8IDA7CgogICAgICAgICAgICBpZiAocmVzdWx0LnN0YXQoImF1ZGlvSW5wdXRMZXZlbCIpKSB7CiAgICAgICAgICAgICAgICBwcmV2U3RhdHNbImF1ZGlvQnl0ZXNUcmFuc2ZlcnJlZCJdID0gcmVzdWx0LnN0YXQoImJ5dGVzU2VudCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoKHByZXZTdGF0c1siYXVkaW9CeXRlc1RyYW5zZmVycmVkIl0gLSBsYXN0X2J5dGVzU2VudCkgKiA4IC8gdGltZV9kaWZmZXJlbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQuc3RhdCgiYXVkaW9PdXRwdXRMZXZlbCIpKSB7CiAgICAgICAgICAgICAgICBwcmV2U3RhdHNbImF1ZGlvQnl0ZXNUcmFuc2ZlcnJlZCJdID0gcmVzdWx0LnN0YXQoImJ5dGVzUmVjZWl2ZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKChwcmV2U3RhdHNbImF1ZGlvQnl0ZXNUcmFuc2ZlcnJlZCJdIC0gbGFzdF9ieXRlc1NlbnQpICogOCAvIHRpbWVfZGlmZmVyZW5jZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gTmFOOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHBhcnNlZF9zdGF0cyA9IHt9OwogICAgICAgIHZhciBwYXJzZVN0YXRzUmVwb3J0cyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICAgICAgICAgIGlmIChzdGF0cy5yZXN1bHQpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHRfbGlzdCA9IHN0YXRzLnJlc3VsdCgpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgcmVzdWx0X2luZGV4ID0gMDsgcmVzdWx0X2luZGV4IDwgcmVzdWx0X2xpc3QubGVuZ3RoOyByZXN1bHRfaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgIHZhciByZXBvcnQgPSB7fTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gcmVzdWx0X2xpc3RbcmVzdWx0X2luZGV4XTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnN0YXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF2Z1ZpZGVvQml0cmF0ZSA9IHBhcnNlQXZnVmlkZW9CaXRyYXRlKHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYXZnVmlkZW9CaXRyYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkX3N0YXRzWyJhdmdWaWRlb0JpdHJhdGUiXSA9IGF2Z1ZpZGVvQml0cmF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF2Z0F1ZGlvQml0cmF0ZSA9IHBhcnNlQXZnQXVkaW9CaXRyYXRlKHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYXZnQXVkaW9CaXRyYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkX3N0YXRzWyJhdmdBdWRpb0JpdHJhdGUiXSA9IGF2Z0F1ZGlvQml0cmF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2dldHRpbmdTdGF0cyA9IGZhbHNlOwogICAgICAgICAgICBjYWxsYmFjayhwYXJzZWRfc3RhdHMpOwogICAgICAgIH0KICAgICAgICBwYXJzZWRfc3RhdHNbImR1cmF0aW9uIl0gPSBNYXRoLnJvdW5kKG5vdyAtIF9jcmVhdGVUaW1lKTsKCgogICAgICAgIGlmIChfcGVlckNvbm5lY3Rpb24gJiYgX3BlZXJDb25uZWN0aW9uLmdldFN0YXRzKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5nZXRTdGF0cyhwYXJzZVN0YXRzUmVwb3J0cyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdGhlcmUgd2FzIG5vIHBlZXIgY29ubmVjdGlvbiB5ZXQgb3IgZ2V0U3RhdHMgaXNuJ3QgaW1wbGVtZW50ZWQgaW4gdGhpcyBlbnZpcm9tZW50CiAgICAgICAgICAgIF9nZXR0aW5nU3RhdHMgPSBmYWxzZTsKICAgICAgICAgICAgY2FsbGJhY2socGFyc2VkX3N0YXRzKTsKICAgICAgICB9CiAgICB9OwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAncmVtb3RlU3RyZWFtcycsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX3BlZXJDb25uZWN0aW9uID8gZ2V0UmVtb3RlU3RyZWFtcygpIDogW107CiAgICAgICAgfQogICAgfSk7Cn07Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7Cgp2YXIgX3BlZXJDb25uZWN0aW9ucyA9IHt9OwoKT1QuUGVlckNvbm5lY3Rpb25zID0gewogICAgYWRkOiBmdW5jdGlvbihyZW1vdGVDb25uZWN0aW9uLCBzdHJlYW0sIGNvbmZpZykgewogICAgICAgIHZhciBrZXkgPSByZW1vdGVDb25uZWN0aW9uLmlkICsgIl8iICsgc3RyZWFtLmlkLAogICAgICAgICAgICByZWYgPSBfcGVlckNvbm5lY3Rpb25zW2tleV07CgogICAgICAgIGlmICghcmVmKSB7CiAgICAgICAgICAgIHJlZiA9IF9wZWVyQ29ubmVjdGlvbnNba2V5XSA9IHsKICAgICAgICAgICAgICAgIGNvdW50OiAwLAogICAgICAgICAgICAgICAgcGM6IG5ldyBPVC5QZWVyQ29ubmVjdGlvbihjb25maWcpCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvLyBpbmNyZWFzZSB0aGUgUENzIHJlZiBjb3VudCBieSAxCiAgICAgICAgcmVmLmNvdW50ICs9IDE7CgogICAgICAgIHJldHVybiByZWYucGM7CiAgICB9LAoKICAgIHJlbW92ZTogZnVuY3Rpb24ocmVtb3RlQ29ubmVjdGlvbiwgc3RyZWFtKSB7CiAgICAgICAgdmFyIGtleSA9IHJlbW90ZUNvbm5lY3Rpb24uaWQgKyAiXyIgKyBzdHJlYW0uaWQsCiAgICAgICAgICAgIHJlZiA9IF9wZWVyQ29ubmVjdGlvbnNba2V5XTsKCiAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICByZWYuY291bnQgLT0gMTsKCiAgICAgICAgICAgIGlmIChyZWYuY291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJlZi5wYy5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgICBkZWxldGUgX3BlZXJDb25uZWN0aW9uc1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8qKgogKiBBYnN0cmFjdHMgUGVlckNvbm5lY3Rpb24gcmVsYXRlZCBzdHVmZiBhd2F5IGZyb20gT1QuUHVibGlzaGVyLgogKgogKiBSZXNwb25zaWJsZSBmb3I6CiAqICogc2V0dGluZyB1cCB0aGUgdW5kZXJseWluZyBQZWVyQ29ubmVjdGlvbiAoZGVsZWdhdGVzIHRvIE9ULlBlZXJDb25uZWN0aW9ucykKICogKiB0cmlnZ2VyaW5nIGEgY29ubmVjdGVkIGV2ZW50IHdoZW4gdGhlIFBlZXIgY29ubmVjdGlvbiBpcyBvcGVuZWQKICogKiB0cmlnZ2VyaW5nIGEgZGlzY29ubmVjdGVkIGV2ZW50IHdoZW4gdGhlIFBlZXIgY29ubmVjdGlvbiBpcyBjbG9zZWQKICogKiBwcm92aWRpbmcgYSBkZXN0cm95IG1ldGhvZAogKiAqIHByb3ZpZGluZyBhIHByb2Nlc3NNZXNzYWdlIG1ldGhvZAogKgogKiBPbmNlIHRoZSBQZWVyQ29ubmVjdGlvbiBpcyBjb25uZWN0ZWQgYW5kIHRoZSB2aWRlbyBlbGVtZW50IHBsYXlpbmcgaXQgdHJpZ2dlcnMgdGhlIGNvbm5lY3RlZCBldmVudAogKgogKiBUcmlnZ2VycyB0aGUgZm9sbG93aW5nIGV2ZW50cwogKiAqIGNvbm5lY3RlZAogKiAqIGRpc2Nvbm5lY3RlZAogKi8KT1QuUHVibGlzaGVyUGVlckNvbm5lY3Rpb24gPSBmdW5jdGlvbihyZW1vdGVDb25uZWN0aW9uLCBzZXNzaW9uLCBzdHJlYW0sIHdlYlJUQ1N0cmVhbSkgewogICAgdmFyIF9wZWVyQ29ubmVjdGlvbiwKICAgICAgICBfaGFzUmVsYXlDYW5kaWRhdGVzID0gZmFsc2U7CgogICAgLy8gUHJpdmF0ZQogICAgdmFyIF9vblBlZXJDbG9zZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignZGlzY29ubmVjdGVkJywgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gTm90ZTogQWxsIFBlZXIgZXJyb3JzIGFyZSBmYXRhbCByaWdodCBub3cuCiAgICAgICAgX29uUGVlckVycm9yID0gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG51bGwsIGVycm9yUmVhc29uLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgfSwKCiAgICAgICAgX3JlbGF5TWVzc2FnZVRvUGVlciA9IGZ1bmN0aW9uKHR5cGUsIHBheWxvYWQpIHsKICAgICAgICAgICAgaWYgKCFfaGFzUmVsYXlDYW5kaWRhdGVzKXsKICAgICAgICAgICAgICAgIHZhciBleHRyYWN0Q2FuZGlkYXRlcyA9IHR5cGUgPT09IE9ULlJhcHRvci5BY3Rpb25zLkNBTkRJREFURSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuT0ZGRVIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPT09IE9ULlJhcHRvci5BY3Rpb25zLkFOU1dFUiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuUFJBTlNXRVIgOwoKICAgICAgICAgICAgICAgIGlmIChleHRyYWN0Q2FuZGlkYXRlcykgewogICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gKHR5cGUgPT09IE9ULlJhcHRvci5BY3Rpb25zLkNBTkRJREFURSkgPyBwYXlsb2FkLmNhbmRpZGF0ZSA6IHBheWxvYWQuc2RwOwogICAgICAgICAgICAgICAgICAgIF9oYXNSZWxheUNhbmRpZGF0ZXMgPSBtZXNzYWdlLmluZGV4T2YoJ3R5cCByZWxheScpICE9PSAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5BTlNXRVI6CiAgICAgICAgICAgIGNhc2UgT1QuUmFwdG9yLkFjdGlvbnMuUFJBTlNXRVI6CiAgICAgICAgICAgICAgICBzZXNzaW9uLl8uanNlcEFuc3dlcihyZW1vdGVDb25uZWN0aW9uLmlkLCBzdHJlYW0sIHBheWxvYWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLk9GRkVSOgogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdjb25uZWN0ZWQnKTsKICAgICAgICAgICAgICAgIHNlc3Npb24uXy5qc2VwT2ZmZXIocmVtb3RlQ29ubmVjdGlvbi5pZCwgc3RyZWFtLCBwYXlsb2FkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DQU5ESURBVEU6CiAgICAgICAgICAgICAgICBzZXNzaW9uLl8uanNlcENhbmRpZGF0ZShyZW1vdGVDb25uZWN0aW9uLmlkLCBzdHJlYW0sIHBheWxvYWQpOwogICAgICAgICAgICB9CiAgICAgICAgfS5iaW5kKHRoaXMpOwoKCiAgICBPVC4kLmV2ZW50aW5nKHRoaXMpOwoKICAgIC8vIFB1YmxpYwogICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gQ2xlYW4gdXAgb3VyIFBlZXJDb25uZWN0aW9uCiAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICBPVC5QZWVyQ29ubmVjdGlvbnMucmVtb3ZlKHJlbW90ZUNvbm5lY3Rpb24sIHN0cmVhbSk7CiAgICAgICAgfQoKICAgICAgICBfcGVlckNvbm5lY3Rpb24gPSBudWxsOwoKICAgICAgICB0aGlzLm9mZigpOwogICAgfTsKCiAgICB0aGlzLnByb2Nlc3NNZXNzYWdlID0gZnVuY3Rpb24odHlwZSwgbWVzc2FnZSkgewogICAgICAgIF9wZWVyQ29ubmVjdGlvbi5wcm9jZXNzTWVzc2FnZSh0eXBlLCBtZXNzYWdlKTsKICAgIH07CgogICAgdGhpcy5nZXRTdGF0cyA9IGZ1bmN0aW9uKHByZXZTdGF0cywgY2FsbGJhY2spIHsKICAgICAgICBfcGVlckNvbm5lY3Rpb24uZ2V0U3RhdHMocHJldlN0YXRzLCBjYWxsYmFjayk7CiAgICB9CgogICAgLy8gSW5pdAogICAgdGhpcy5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGljZVNlcnZlcnMgPSBzZXNzaW9uLnNlc3Npb25JbmZvLmljZVNlcnZlcnMubWFwKGZ1bmN0aW9uKGlzKSB7CiAgICAgICAgICAgIHZhciBpY2VTZXJ2ZXIgPSBPVC4kLmNsb25lKGlzKTsKCiAgICAgICAgICAgIGlmIChpY2VTZXJ2ZXIudXJsLnRyaW0oKS5zdWJzdHIoMCwgNSkgPT09ICd0dXJuOicpIHsKICAgICAgICAgICAgICAgIC8vIE1ha2UgdGhlIHVzZXJuYW1lIHNlc3Npb25JZDpjb25uZWN0aW9uSWQ6c3RyZWFtSWQgZm9yIHRyYWNraW5nIHB1cnBvc2VzLgogICAgICAgICAgICAgICAgaWNlU2VydmVyLnVzZXJuYW1lID0gc2Vzc2lvbi5pZCArICcuJyArIHNlc3Npb24uY29ubmVjdGlvbi5pZCArICcuJyArIHN0cmVhbS5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGljZVNlcnZlcjsKICAgICAgICB9KTsKCiAgICAgICAgX3BlZXJDb25uZWN0aW9uID0gT1QuUGVlckNvbm5lY3Rpb25zLmFkZChyZW1vdGVDb25uZWN0aW9uLCBzdHJlYW0sIHsKICAgICAgICAgICAgaWNlU2VydmVyczogaWNlU2VydmVycwogICAgICAgIH0pOwoKICAgICAgICBfcGVlckNvbm5lY3Rpb24ub24oewogICAgICAgICAgICBjbG9zZTogX29uUGVlckNsb3NlZCwKICAgICAgICAgICAgZXJyb3I6IF9vblBlZXJFcnJvcgogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICBfcGVlckNvbm5lY3Rpb24ucmVnaXN0ZXJNZXNzYWdlRGVsZWdhdGUoX3JlbGF5TWVzc2FnZVRvUGVlcik7CiAgICAgICAgX3BlZXJDb25uZWN0aW9uLmFkZExvY2FsU3RyZWFtKHdlYlJUQ1N0cmVhbSk7CgogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAncmVtb3RlQ29ubmVjdGlvbicsIHt2YWx1ZTogcmVtb3RlQ29ubmVjdGlvbn0pOwoKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2hhc1JlbGF5Q2FuZGlkYXRlcycsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9oYXNSZWxheUNhbmRpZGF0ZXM7IH0KICAgICAgICB9KTsKICAgIH0KfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8qKgogKiBBYnN0cmFjdHMgUGVlckNvbm5lY3Rpb24gcmVsYXRlZCBzdHVmZiBhd2F5IGZyb20gT1QuU3Vic2NyaWJlci4KICoKICogUmVzcG9uc2libGUgZm9yOgogKiAqIHNldHRpbmcgdXAgdGhlIHVuZGVybHlpbmcgUGVlckNvbm5lY3Rpb24gKGRlbGVnYXRlcyB0byBPVC5QZWVyQ29ubmVjdGlvbnMpCiAqICogdHJpZ2dlcmluZyBhIGNvbm5lY3RlZCBldmVudCB3aGVuIHRoZSBQZWVyIGNvbm5lY3Rpb24gaXMgb3BlbmVkCiAqICogdHJpZ2dlcmluZyBhIGRpc2Nvbm5lY3RlZCBldmVudCB3aGVuIHRoZSBQZWVyIGNvbm5lY3Rpb24gaXMgY2xvc2VkCiAqICogY3JlYXRpbmcgYSB2aWRlbyBlbGVtZW50IHdoZW4gYSBzdHJlYW0gaXMgYWRkZWQKICogKiByZXNwb25kaW5nIHRvIHN0cmVhbSByZW1vdmVkIGludGVsbGlnZW50bHkKICogKiBwcm92aWRpbmcgYSBkZXN0cm95IG1ldGhvZAogKiAqIHByb3ZpZGluZyBhIHByb2Nlc3NNZXNzYWdlIG1ldGhvZAogKgogKiBPbmNlIHRoZSBQZWVyQ29ubmVjdGlvbiBpcyBjb25uZWN0ZWQgYW5kIHRoZSB2aWRlbyBlbGVtZW50IHBsYXlpbmcgaXQgdHJpZ2dlcnMgdGhlIGNvbm5lY3RlZCBldmVudAogKgogKiBUcmlnZ2VycyB0aGUgZm9sbG93aW5nIGV2ZW50cwogKiAqIGNvbm5lY3RlZAogKiAqIGRpc2Nvbm5lY3RlZAogKiAqIHJlbW90ZVN0cmVhbUFkZGVkCiAqICogcmVtb3RlU3RyZWFtUmVtb3ZlZAogKiAqIGVycm9yCiAqCiAqLwoKT1QuU3Vic2NyaWJlclBlZXJDb25uZWN0aW9uID0gZnVuY3Rpb24ocmVtb3RlQ29ubmVjdGlvbiwgc2Vzc2lvbiwgc3RyZWFtLCBwcm9wZXJ0aWVzKSB7CiAgICB2YXIgX3BlZXJDb25uZWN0aW9uLAogICAgICAgIF9oYXNSZWxheUNhbmRpZGF0ZXMgPSBmYWxzZTsKCiAgICAvLyBQcml2YXRlCiAgICB2YXIgX29uUGVlckNsb3NlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdkaXNjb25uZWN0ZWQnLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBfb25SZW1vdGVTdHJlYW1BZGRlZCA9IGZ1bmN0aW9uKHJlbW90ZVJUQ1N0cmVhbSkgewogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3JlbW90ZVN0cmVhbUFkZGVkJywgcmVtb3RlUlRDU3RyZWFtLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBfb25SZW1vdGVTdHJlYW1SZW1vdmVkID0gZnVuY3Rpb24ocmVtb3RlUlRDU3RyZWFtKSB7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcigncmVtb3RlU3RyZWFtUmVtb3ZlZCcsIHJlbW90ZVJUQ1N0cmVhbSwgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gTm90ZTogQWxsIFBlZXIgZXJyb3JzIGFyZSBmYXRhbCByaWdodCBub3cuCiAgICAgICAgX29uUGVlckVycm9yID0gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG51bGwsIGVycm9yUmVhc29uLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBfcmVsYXlNZXNzYWdlVG9QZWVyID0gZnVuY3Rpb24odHlwZSwgcGF5bG9hZCkgewogICAgICAgICAgICBpZiAoIV9oYXNSZWxheUNhbmRpZGF0ZXMpewogICAgICAgICAgICAgICAgdmFyIGV4dHJhY3RDYW5kaWRhdGVzID0gdHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuQ0FORElEQVRFIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSBPVC5SYXB0b3IuQWN0aW9ucy5PRkZFUiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuQU5TV0VSIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSBPVC5SYXB0b3IuQWN0aW9ucy5QUkFOU1dFUiA7CgogICAgICAgICAgICAgICAgaWYgKGV4dHJhY3RDYW5kaWRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSAodHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuQ0FORElEQVRFKSA/IHBheWxvYWQuY2FuZGlkYXRlIDogcGF5bG9hZC5zZHA7CiAgICAgICAgICAgICAgICAgICAgX2hhc1JlbGF5Q2FuZGlkYXRlcyA9IG1lc3NhZ2UuaW5kZXhPZigndHlwIHJlbGF5JykgIT09IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2godHlwZSkgewogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLkFOU1dFUjoKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5QUkFOU1dFUjoKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY29ubmVjdGVkJyk7CiAgICAgICAgICAgICAgICBzZXNzaW9uLl8uanNlcEFuc3dlcihyZW1vdGVDb25uZWN0aW9uLmlkLCBzdHJlYW0sIHBheWxvYWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLk9GRkVSOgogICAgICAgICAgICAgICAgc2Vzc2lvbi5fLmpzZXBPZmZlcihyZW1vdGVDb25uZWN0aW9uLmlkLCBzdHJlYW0sIHBheWxvYWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLkNBTkRJREFURToKICAgICAgICAgICAgICAgIHNlc3Npb24uXy5qc2VwQ2FuZGlkYXRlKHJlbW90ZUNvbm5lY3Rpb24uaWQsIHN0cmVhbSwgcGF5bG9hZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LmJpbmQodGhpcyksCgogICAgICAgIC8vIEhlbHBlciBtZXRob2QgdXNlZCBieSBzdWJzY3JpYmVUb0F1ZGlvL3N1YnNjcmliZVRvVmlkZW8KICAgICAgICBfc2V0RW5hYmxlZE9uU3RyZWFtVHJhY2tzQ3VycnkgPSBmdW5jdGlvbihpc1ZpZGVvKSB7CiAgICAgICAgICAgIHZhciBtZXRob2QgPSAnZ2V0JyArIChpc1ZpZGVvID8gJ1ZpZGVvJyA6ICdBdWRpbycpICsgJ1RyYWNrcyc7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZW5hYmxlZCkgewogICAgICAgICAgICAgICAgdmFyIHJlbW90ZVN0cmVhbXMgPSBfcGVlckNvbm5lY3Rpb24ucmVtb3RlU3RyZWFtcywKICAgICAgICAgICAgICAgICAgICB0cmFja3MsCiAgICAgICAgICAgICAgICAgICAgc3RyZWFtOwoKICAgICAgICAgICAgICAgIGlmIChyZW1vdGVTdHJlYW1zLmxlbmd0aCA9PT0gMCB8fCAhcmVtb3RlU3RyZWFtc1swXVttZXRob2RdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZWl0aGVyIHRoZXJlIGlzIG5vIHJlbW90ZSBzdHJlYW0gb3Igd2UgYXJlIGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3QKICAgICAgICAgICAgICAgICAgICAvLyBleHBvc2UgdGhlIG1lZGlhIHRyYWNrcyAoRmlyZWZveCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBudW09cmVtb3RlU3RyZWFtcy5sZW5ndGg7IGk8bnVtOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBzdHJlYW0gPSByZW1vdGVTdHJlYW1zW2ldOwogICAgICAgICAgICAgICAgICAgIHRyYWNrcyA9IHN0cmVhbVttZXRob2RdKCk7CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGs9MCwgbnVtVHJhY2tzPXRyYWNrcy5sZW5ndGg7IGsgPCBudW1UcmFja3M7ICsrayl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrc1trXS5lbmFibGVkPWVuYWJsZWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CgoKICAgIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogICAgLy8gUHVibGljCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgIHZhciBudW1EZWxlZ2F0ZXMgPSBfcGVlckNvbm5lY3Rpb24udW5yZWdpc3Rlck1lc3NhZ2VEZWxlZ2F0ZShfcmVsYXlNZXNzYWdlVG9QZWVyKTsKCiAgICAgICAgLy8gT25seSBjbGVhbiB1cCB0aGUgUGVlckNvbm5lY3Rpb24gaWYgdGhlcmUgaXNuJ3QgYW5vdGhlciBTdWJzY3JpYmVyIHVzaW5nIGl0CiAgICAgICAgaWYgKG51bURlbGVnYXRlcyA9PT0gMCkgewogICAgICAgICAgLy8gVW5zdWJzY3JpYmUgdXMgZnJvbSB0aGUgc3RyZWFtLCBpZiBpdCBoYXNuJ3QgYWxyZWFkeSBiZWVuIGRlc3Ryb3llZAogICAgICAgICAgaWYgKHNlc3Npb24gJiYgc2Vzc2lvbi5jb25uZWN0ZWQgJiYgc3RyZWFtICYmICFzdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBzZXJ2ZXIgY29tcG9uZW50cwogICAgICAgICAgICAgIHNlc3Npb24uXy5qc2VwVW5zdWJzY3JpYmUoc3RyZWFtKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZWY6IE9QRU5UT0stMjQ1OCBkaXNhYmxlIGFsbCBhdWRpbyB0cmFja3MgYmVmb3JlIHJlbW92aW5nIGl0LgogICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb0F1ZGlvKGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgT1QuUGVlckNvbm5lY3Rpb25zLnJlbW92ZShyZW1vdGVDb25uZWN0aW9uLCBzdHJlYW0uc3RyZWFtSWQpOwogICAgICB9CiAgICAgIF9wZWVyQ29ubmVjdGlvbiA9IG51bGw7CiAgICAgIHRoaXMub2ZmKCk7CiAgICB9OwoKICAgIHRoaXMucHJvY2Vzc01lc3NhZ2UgPSBmdW5jdGlvbih0eXBlLCBtZXNzYWdlKSB7CiAgICAgICAgX3BlZXJDb25uZWN0aW9uLnByb2Nlc3NNZXNzYWdlKHR5cGUsIG1lc3NhZ2UpOwogICAgfTsKCiAgICB0aGlzLmdldFN0YXRzID0gZnVuY3Rpb24ocHJldlN0YXRzLCBjYWxsYmFjaykgewogICAgICAgIF9wZWVyQ29ubmVjdGlvbi5nZXRTdGF0cyhwcmV2U3RhdHMsIGNhbGxiYWNrKTsKICAgIH07CgogICAgdGhpcy5zdWJzY3JpYmVUb0F1ZGlvID0gX3NldEVuYWJsZWRPblN0cmVhbVRyYWNrc0N1cnJ5KGZhbHNlKTsKICAgIHRoaXMuc3Vic2NyaWJlVG9WaWRlbyA9IF9zZXRFbmFibGVkT25TdHJlYW1UcmFja3NDdXJyeSh0cnVlKTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2hhc1JlbGF5Q2FuZGlkYXRlcycsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2hhc1JlbGF5Q2FuZGlkYXRlczsgfQogICAgfSk7CgoKICAgIC8vIEluaXQKICAgIHRoaXMuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpY2VTZXJ2ZXJzID0gc2Vzc2lvbi5zZXNzaW9uSW5mby5pY2VTZXJ2ZXJzLm1hcChmdW5jdGlvbihpcykgewogICAgICAgICAgICB2YXIgaWNlU2VydmVyID0gT1QuJC5jbG9uZShpcyk7CgogICAgICAgICAgICBpZiAoaWNlU2VydmVyLnVybC50cmltKCkuc3Vic3RyKDAsIDUpID09PSAndHVybjonKSB7CiAgICAgICAgICAgICAgICAvLyBNYWtlIHRoZSB1c2VybmFtZSBzZXNzaW9uSWQ6Y29ubmVjdGlvbklkOnN0cmVhbUlkIGZvciB0cmFja2luZyBwdXJwb3Nlcy4KICAgICAgICAgICAgICAgIGljZVNlcnZlci51c2VybmFtZSA9IHNlc3Npb24uaWQgKyAnLicgKyBzZXNzaW9uLmNvbm5lY3Rpb24uaWQgKyAnLicgKyBzdHJlYW0uaWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBpY2VTZXJ2ZXI7CiAgICAgICAgfSk7CgogICAgICAgIF9wZWVyQ29ubmVjdGlvbiA9IE9ULlBlZXJDb25uZWN0aW9ucy5hZGQocmVtb3RlQ29ubmVjdGlvbiwgc3RyZWFtLnN0cmVhbUlkLCB7CiAgICAgICAgICAgIGljZVNlcnZlcnM6IGljZVNlcnZlcnMKICAgICAgICB9KTsKCiAgICAgICAgX3BlZXJDb25uZWN0aW9uLm9uKHsKICAgICAgICAgICAgY2xvc2U6IF9vblBlZXJDbG9zZWQsCiAgICAgICAgICAgIHN0cmVhbUFkZGVkOiBfb25SZW1vdGVTdHJlYW1BZGRlZCwKICAgICAgICAgICAgc3RyZWFtUmVtb3ZlZDogX29uUmVtb3RlU3RyZWFtUmVtb3ZlZCwKICAgICAgICAgICAgZXJyb3I6IF9vblBlZXJFcnJvcgogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICB2YXIgbnVtRGVsZWdhdGVzID0gX3BlZXJDb25uZWN0aW9uLnJlZ2lzdGVyTWVzc2FnZURlbGVnYXRlKF9yZWxheU1lc3NhZ2VUb1BlZXIpOwoKICAgICAgICAvLyBJZiB0aGVyZSBhcmUgYWxyZWFkeSByZW1vdGVTdHJlYW1zLCBhZGQgdGhlbSBpbW1lZGlhdGVseQogICAgICAgIGlmIChfcGVlckNvbm5lY3Rpb24ucmVtb3RlU3RyZWFtcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5yZW1vdGVTdHJlYW1zLmZvckVhY2goX29uUmVtb3RlU3RyZWFtQWRkZWQsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChudW1EZWxlZ2F0ZXMgPT09IDEpIHsKICAgICAgICAgICAgLy8gV2Ugb25seSBib3RoZXIgd2l0aCB0aGUgUGVlckNvbm5lY3Rpb24gbmVnb3RpYXRpb24gaWYgd2UgYXJlIHRoZSBvbmx5IGRlbGVnYXRlLgogICAgICAgICAgICBzZXNzaW9uLl8uanNlcFN1YnNjcmliZShzdHJlYW0sIHByb3BlcnRpZXMuc3Vic2NyaWJlVG9WaWRlbywgcHJvcGVydGllcy5zdWJzY3JpYmVUb0F1ZGlvKTsKICAgICAgICB9CiAgICB9Owp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTWFuYWdlcyBOIENocm9tZSBlbGVtZW50cwpPVC5DaHJvbWUgPSBmdW5jdGlvbihwcm9wZXJ0aWVzKSB7CiAgICB2YXIgX3Zpc2libGUgPSBmYWxzZSwKICAgICAgICBfd2lkZ2V0cyA9IHt9LAoKICAgICAgICAvLyBQcml2YXRlIGhlbHBlciBmdW5jdGlvbgogICAgICAgIF9zZXQgPSBmdW5jdGlvbihuYW1lLCB3aWRnZXQpIHsKICAgICAgICAgICAgd2lkZ2V0LnBhcmVudCA9IHRoaXM7CiAgICAgICAgICAgIHdpZGdldC5hcHBlbmRUbyhwcm9wZXJ0aWVzLnBhcmVudCk7CgogICAgICAgICAgICBfd2lkZ2V0c1tuYW1lXSA9IHdpZGdldDsKCiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBuYW1lLCB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3dpZGdldHNbbmFtZV07IH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICBpZiAoIXByb3BlcnRpZXMucGFyZW50KSB7CiAgICAgICAgLy8gQHRvZG8gcmFpc2UgYW4gZXhjZXB0aW9uCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5vZmYoKTsKICAgICAgICB0aGlzLmhpZGUoKTsKCiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBfd2lkZ2V0cykgewogICAgICAgICAgICBfd2lkZ2V0c1tuYW1lXS5kZXN0cm95KCk7CiAgICAgICAgfQogICAgfTsKCiAgICB0aGlzLnNob3cgPSBmdW5jdGlvbigpIHsKICAgICAgICBfdmlzaWJsZSA9IHRydWU7CgogICAgICAgIGZvciAodmFyIG5hbWUgaW4gX3dpZGdldHMpIHsKICAgICAgICAgICAgX3dpZGdldHNbbmFtZV0uc2hvdygpOwogICAgICAgIH0KICAgIH07CgogICAgdGhpcy5oaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgX3Zpc2libGUgPSBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBfd2lkZ2V0cykgewogICAgICAgICAgICBfd2lkZ2V0c1tuYW1lXS5oaWRlKCk7CiAgICAgICAgfQogICAgfTsKCgogICAgLy8gQWRkcyB0aGUgd2lkZ2V0IHRvIHRoZSBjaHJvbWUgYW5kIHRvIHRoZSBET00uIEFsc28gY3JlYXRlcyBhIGFjY2Vzc29yCiAgICAvLyBwcm9wZXJ0eSBmb3IgaXQgb24gdGhlIGNocm9tZS4KICAgIC8vCiAgICAvLyBAZXhhbXBsZQogICAgLy8gIGNocm9tZS5zZXQoJ2ZvbycsIG5ldyBGb29XaWRnZXQoKSk7CiAgICAvLyAgY2hyb21lLmZvby5zZXREaXNwbGF5TW9kZSgnb24nKTsKICAgIC8vCiAgICAvLyBAZXhhbXBsZQogICAgLy8gIGNocm9tZS5zZXQoewogICAgLy8gICAgICBmb286IG5ldyBGb29XaWRnZXQoKSwKICAgIC8vICAgICAgYmFyOiBuZXcgQmFyV2lkZ2V0KCkKICAgIC8vICB9KTsKICAgIC8vICBjaHJvbWUuZm9vLnNldERpc3BsYXlNb2RlKCdvbicpOwogICAgLy8KICAgIHRoaXMuc2V0ID0gZnVuY3Rpb24od2lkZ2V0TmFtZSwgd2lkZ2V0KSB7CiAgICAgICAgaWYgKHR5cGVvZih3aWRnZXROYW1lKSA9PT0gInN0cmluZyIgJiYgd2lkZ2V0KSB7CiAgICAgICAgICAgIF9zZXQuY2FsbCh0aGlzLCB3aWRnZXROYW1lLCB3aWRnZXQpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gd2lkZ2V0TmFtZSkgewogICAgICAgICAgICBpZiAod2lkZ2V0TmFtZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgIF9zZXQuY2FsbCh0aGlzLCBuYW1lLCB3aWRnZXROYW1lW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Owp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKaWYgKCFPVC5DaHJvbWUuQmVoYXZpb3VyKSBPVC5DaHJvbWUuQmVoYXZpb3VyID0ge307CgovLyBBIG1peGluIHRvIGVuY2Fwc3VsYXRlIHRoZSBiYXNpYyB3aWRnZXQgYmVoYXZpb3VyLiBUaGlzIG5lZWRzIGEgYmV0dGVyIG5hbWUsCi8vIGl0J3Mgbm90IGFjdHVhbGx5IGEgd2lkZ2V0LiBJdCdzIGFjdHVhbGx5ICJCZWhhdmlvdXIgdGhhdCBjYW4gYmUgYXBwbGllZCB0bwovLyBhbiBvYmplY3QgdG8gbWFrZSBpdCBzdXBwb3J0IHRoZSBiYXNpYyBDaHJvbWUgd2lkZ2V0IHdvcmtmbG93Ii4uLmJ1dCB0aGF0IHdvdWxkCi8vIHByb2JhYmx5IGJlZW4gdG9vIGxvbmcgYSBuYW1lLgpPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCA9IGZ1bmN0aW9uKHdpZGdldCwgb3B0aW9ucykgewogICAgdmFyIF9vcHRpb25zID0gb3B0aW9ucyB8fCB7fSwKICAgICAgICBfbW9kZSwKICAgICAgICBfcHJldmlvdXNNb2RlOwoKICAgIC8vCiAgICAvLyBAcGFyYW0gW1N0cmluZ10gbW9kZQogICAgLy8gICAgICAnb24nLCAnb2ZmJywgb3IgJ2F1dG8nCiAgICAvLwogICAgd2lkZ2V0LnNldERpc3BsYXlNb2RlID0gZnVuY3Rpb24obW9kZSkgewogICAgICAgIHZhciBuZXdNb2RlID0gbW9kZSB8fCAnYXV0byc7CiAgICAgICAgaWYgKF9tb2RlID09PSBuZXdNb2RlKSByZXR1cm47CgogICAgICAgIE9ULiQucmVtb3ZlQ2xhc3ModGhpcy5kb21FbGVtZW50LCAnT1RfbW9kZS0nICsgX21vZGUpOwogICAgICAgIE9ULiQuYWRkQ2xhc3ModGhpcy5kb21FbGVtZW50LCAnT1RfbW9kZS0nICsgbmV3TW9kZSk7CgogICAgICAgIF9wcmV2aW91c01vZGUgPSBfbW9kZTsKICAgICAgICBfbW9kZSA9IG5ld01vZGU7CiAgICB9OwoKICAgIHdpZGdldC5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXREaXNwbGF5TW9kZShfcHJldmlvdXNNb2RlKTsKICAgICAgICBpZiAoX29wdGlvbnMub25TaG93KSBfb3B0aW9ucy5vblNob3coKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIHdpZGdldC5oaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXREaXNwbGF5TW9kZSgnb2ZmJyk7CiAgICAgICAgaWYgKF9vcHRpb25zLm9uSGlkZSkgX29wdGlvbnMub25IaWRlKCk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB3aWRnZXQuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChfb3B0aW9ucy5vbkRlc3Ryb3kpIF9vcHRpb25zLm9uRGVzdHJveSh0aGlzLmRvbUVsZW1lbnQpOwogICAgICAgIGlmICh0aGlzLmRvbUVsZW1lbnQpIE9ULiQucmVtb3ZlRWxlbWVudCh0aGlzLmRvbUVsZW1lbnQpOwoKICAgICAgICByZXR1cm4gd2lkZ2V0OwogICAgfTsKCiAgICB3aWRnZXQuYXBwZW5kVG8gPSBmdW5jdGlvbihwYXJlbnQpIHsKICAgICAgICAvLyBjcmVhdGUgdGhlIGVsZW1lbnQgdW5kZXIgcGFyZW50CiAgICAgICAgdGhpcy5kb21FbGVtZW50ID0gT1QuJC5jcmVhdGVFbGVtZW50KF9vcHRpb25zLm5vZGVOYW1lIHx8ICdkaXYnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vcHRpb25zLmh0bWxBdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vcHRpb25zLmh0bWxDb250ZW50KTsKCiAgICAgICAgaWYgKF9vcHRpb25zLm9uQ3JlYXRlKSBfb3B0aW9ucy5vbkNyZWF0ZSh0aGlzLmRvbUVsZW1lbnQpOwoKICAgICAgICAvLyBpZiB0aGUgbW9kZSBpc24ndCBhdXRvLCB0aGVuIHdlIGNhbiBkaXJlY3RseSBzZXQgaXQKICAgICAgICBpZiAoX29wdGlvbnMubW9kZSAhPSAiYXV0byIpIHsKICAgICAgICAgICAgd2lkZ2V0LnNldERpc3BsYXlNb2RlKF9vcHRpb25zLm1vZGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHdlIHNldCBpdCB0byBvbiBhdCBmaXJzdCwgYW5kIHRoZW4gYXBwbHkgdGhlIGRlc2lyZWQgbW9kZQogICAgICAgICAgICAvLyB0aGlzIHdpbGwgbGV0IHRoZSBwcm9wZXIgd2lkZ2V0cyBuaWNlbHkgZmFkZSBhd2F5CiAgICAgICAgICAgIHdpZGdldC5zZXREaXNwbGF5TW9kZSgnb24nKTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdpZGdldC5zZXREaXNwbGF5TW9kZShfb3B0aW9ucy5tb2RlKTsKICAgICAgICAgICAgfSwgMjAwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyBhZGQgdGhlIHdpZGdldCB0byB0aGUgcGFyZW50CiAgICAgICAgcGFyZW50LmFwcGVuZENoaWxkKHRoaXMuZG9tRWxlbWVudCk7CgogICAgICAgIHJldHVybiB3aWRnZXQ7CiAgICB9Owp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTmFtZVBhbmVsIENocm9tZSBXaWRnZXQKLy8KLy8gbW9kZSAoU3RyaW5nKQovLyBXaGV0aGVyIHRvIGRpc3BsYXkgdGhlIG5hbWUuIFBvc3NpYmxlIHZhbHVlcyBhcmU6ICJhdXRvIiAodGhlIG5hbWUgaXMgZGlzcGxheWVkCi8vIHdoZW4gdGhlIHN0cmVhbSBpcyBmaXJzdCBkaXNwbGF5ZWQgYW5kIHdoZW4gdGhlIHVzZXIgbW91c2VzIG92ZXIgdGhlIGRpc3BsYXkpLAovLyAib2ZmIiAodGhlIG5hbWUgaXMgbm90IGRpc3BsYXllZCksIGFuZCAib24iICh0aGUgbmFtZSBpcyBkaXNwbGF5ZWQpLgovLwovLyBkaXNwbGF5cyBhIG5hbWUKLy8gY2FuIGJlIHNob3duL2hpZGRlbgovLyBjYW4gYmUgZGVzdHJveWVkCk9ULkNocm9tZS5OYW1lUGFuZWwgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgX25hbWUgPSBvcHRpb25zLm5hbWU7CgogICAgaWYgKCFfbmFtZSB8fCBfbmFtZS50cmltKCkubGVuZ3RoID09PSAnJykgewogICAgICAgIF9uYW1lID0gbnVsbDsKCiAgICAgICAgLy8gVEhlcmUncyBubyBuYW1lLCBqdXN0IGZsaXAgdGhlIG1vZGUgb2ZmCiAgICAgICAgb3B0aW9ucy5tb2RlID0gJ29mZic7CiAgICB9CgogICAgLy8gVGhpcyBiZWhhdmlvdXIgbXVzdCBiZSBpbXBsZW1lbnRlZCB0byBtYWtlIHRoZSB3aWRnZXQgYmVoYXZpb3VyIHdvcmsuCiAgICAvLyBAZml4bWUgVGhpcyBpcyBhIG5hc3R5IGNvZGUgc21lbGwKICAgIHZhciBfZG9tRWxlbWVudDsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnZG9tRWxlbWVudCcsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2RvbUVsZW1lbnQ7IH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihkb21FbGVtZW50KSB7IF9kb21FbGVtZW50ID0gZG9tRWxlbWVudDsgfQogICAgfSkKCiAgICAvLyBNaXhpbiBjb21tb24gd2lkZ2V0IGJlaGF2aW91cgogICAgT1QuQ2hyb21lLkJlaGF2aW91ci5XaWRnZXQodGhpcywgewogICAgICAgIG1vZGU6IG9wdGlvbnMubW9kZSwKICAgICAgICBub2RlTmFtZTogJ2gxJywKICAgICAgICBodG1sQ29udGVudDogX25hbWUsCiAgICAgICAgaHRtbEF0dHJpYnV0ZXM6IHtjbGFzc05hbWU6ICdPVF9uYW1lJ30KICAgIH0pOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnbmFtZScsIHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFfbmFtZSkgdGhpcy5zZXREaXNwbGF5TW9kZSgnYXV0bycpOwoKICAgICAgICAgICAgX25hbWUgPSBuYW1lOwogICAgICAgICAgICBfZG9tRWxlbWVudC5pbm5lckhUTUwgPSBfbmFtZTsKICAgICAgICB9LmJpbmQodGhpcykKICAgIH0pOwp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKT1QuQ2hyb21lLk11dGVCdXR0b24gPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgX29uQ2xpY2tDYiwKICAgICAgICBfbXV0ZWQgPSBvcHRpb25zLm11dGVkIHx8IGZhbHNlOwoKICAgIC8vIFRoaXMgYmVoYXZpb3VyIG11c3QgYmUgaW1wbGVtZW50ZWQgdG8gbWFrZSB0aGUgd2lkZ2V0IGJlaGF2aW91ciB3b3JrLgogICAgLy8gQGZpeG1lIFRoaXMgaXMgYSBuYXN0eSBjb2RlIHNtZWxsCiAgICB2YXIgX2RvbUVsZW1lbnQ7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2RvbUVsZW1lbnQnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9kb21FbGVtZW50OyB9LAogICAgICAgIHNldDogZnVuY3Rpb24oZG9tRWxlbWVudCkgeyBfZG9tRWxlbWVudCA9IGRvbUVsZW1lbnQ7IH0KICAgIH0pCgogICAgLy8gUHJpdmF0ZSBFdmVudCBDYWxsYmFja3MKICAgIHZhciBhdHRhY2hFdmVudHMgPSBmdW5jdGlvbihlbGVtKSB7CiAgICAgICAgICAgIF9vbkNsaWNrQ2IgPSBvbkNsaWNrLmJpbmQodGhpcyk7CiAgICAgICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfb25DbGlja0NiLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgZGV0YWNoRXZlbnRzID0gZnVuY3Rpb24oZWxlbSkgewogICAgICAgICAgICBfb25DbGlja0NiID0gbnVsbDsKICAgICAgICAgICAgZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIF9vbkNsaWNrQ2IsIGZhbHNlKTsKICAgICAgICB9LAoKICAgICAgICBvbkNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgX211dGVkID0gIV9tdXRlZDsKCiAgICAgICAgICAgIGlmIChfbXV0ZWQpIHsKICAgICAgICAgICAgICAgIE9ULiQuYWRkQ2xhc3MoX2RvbUVsZW1lbnQsICdPVF9hY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50LnRyaWdnZXIoJ211dGVkJywgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBPVC4kLnJlbW92ZUNsYXNzKF9kb21FbGVtZW50LCAnT1RfYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudC50cmlnZ2VyKCd1bm11dGVkJywgdGhpcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgIC8vIE1peGluIGNvbW1vbiB3aWRnZXQgYmVoYXZpb3VyCiAgICB2YXIgY2xhc3NOYW1lcyA9IF9tdXRlZCA/ICdPVF9tdXRlIE9UX2FjdGl2ZScgOiAnT1RfbXV0ZSc7CiAgICBPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCh0aGlzLCB7CiAgICAgICAgbW9kZTogb3B0aW9ucy5tb2RlLAogICAgICAgIG5vZGVOYW1lOiAnYnV0dG9uJywKICAgICAgICBodG1sQ29udGVudDogJ011dGUnLAogICAgICAgIGh0bWxBdHRyaWJ1dGVzOiB7Y2xhc3NOYW1lOiBjbGFzc05hbWVzfSwKICAgICAgICBvbkNyZWF0ZTogYXR0YWNoRXZlbnRzLmJpbmQodGhpcyksCiAgICAgICAgb25EZXN0cm95OiBkZXRhY2hFdmVudHMuYmluZCh0aGlzKQogICAgfSk7Cn07CgoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKT1QuQ2hyb21lLk1pY1ZvbHVtZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBfb25DbGlja0NiLAogICAgICAgIF9tdXRlZCA9IG9wdGlvbnMubXV0ZWQgfHwgZmFsc2U7CgogICAgLy8gVGhpcyBiZWhhdmlvdXIgbXVzdCBiZSBpbXBsZW1lbnRlZCB0byBtYWtlIHRoZSB3aWRnZXQgYmVoYXZpb3VyIHdvcmsuCiAgICAvLyBAZml4bWUgVGhpcyBpcyBhIG5hc3R5IGNvZGUgc21lbGwKICAgIHZhciBfZG9tRWxlbWVudDsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnZG9tRWxlbWVudCcsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2RvbUVsZW1lbnQ7IH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihkb21FbGVtZW50KSB7IF9kb21FbGVtZW50ID0gZG9tRWxlbWVudDsgfQogICAgfSkKCiAgICAvLyBQcml2YXRlIEV2ZW50IENhbGxiYWNrcwogICAgdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKGVsZW0pIHsKICAgICAgICAgICAgX29uQ2xpY2tDYiA9IG9uQ2xpY2suYmluZCh0aGlzKTsKICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIF9vbkNsaWNrQ2IsIGZhbHNlKTsKICAgICAgICB9LAoKICAgICAgICBkZXRhY2hFdmVudHMgPSBmdW5jdGlvbihlbGVtKSB7CiAgICAgICAgICAgIF9vbkNsaWNrQ2IgPSBudWxsOwogICAgICAgICAgICBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgX29uQ2xpY2tDYiwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIG9uQ2xpY2sgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBfbXV0ZWQgPSAhX211dGVkOwoKICAgICAgICAgICAgaWYgKF9tdXRlZCkgewogICAgICAgICAgICAgICAgT1QuJC5hZGRDbGFzcyhfZG9tRWxlbWVudCwgJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgdGhpcy5wYXJlbnQudHJpZ2dlcignbXV0ZWQnLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIE9ULiQucmVtb3ZlQ2xhc3MoX2RvbUVsZW1lbnQsICdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50LnRyaWdnZXIoJ3VubXV0ZWQnLCB0aGlzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgLy8gTWl4aW4gY29tbW9uIHdpZGdldCBiZWhhdmlvdXIKICAgIE9ULkNocm9tZS5CZWhhdmlvdXIuV2lkZ2V0KHRoaXMsIHsKICAgICAgICBtb2RlOiBvcHRpb25zLm1vZGUsCiAgICAgICAgbm9kZU5hbWU6ICdidXR0b24nLAogICAgICAgIGh0bWxDb250ZW50OiAnTXV0ZScsCiAgICAgICAgaHRtbEF0dHJpYnV0ZXM6IHtjbGFzc05hbWU6ICdPVF9taWMtdm9sdW1lJ30sCiAgICAgICAgb25DcmVhdGU6IGF0dGFjaEV2ZW50cy5iaW5kKHRoaXMpLAogICAgICAgIG9uRGVzdHJveTogZGV0YWNoRXZlbnRzLmJpbmQodGhpcykKICAgIH0pOwp9OwoKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCk9ULkNocm9tZS5TZXR0aW5nc1BhbmVsQnV0dG9uID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIF9vbkNsaWNrQ2I7CgogICAgLy8gUHJpdmF0ZSBFdmVudCBDYWxsYmFja3MKICAgIHZhciBhdHRhY2hFdmVudHMgPSBmdW5jdGlvbihlbGVtKSB7CiAgICAgICAgICAgIF9vbkNsaWNrQ2IgPSBvbkNsaWNrLmJpbmQodGhpcyk7CiAgICAgICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfb25DbGlja0NiLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgZGV0YWNoRXZlbnRzID0gZnVuY3Rpb24oZWxlbSkgewogICAgICAgICAgICBfb25DbGlja0NiID0gbnVsbDsKICAgICAgICAgICAgZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIF9vbkNsaWNrQ2IsIGZhbHNlKTsKICAgICAgICB9LAoKICAgICAgICBvbkNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdGhpcy5wYXJlbnQudHJpZ2dlcignU2V0dGluZ3NQYW5lbDpvcGVuJywgdGhpcyk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKCiAgICAvLyBUaGlzIGJlaGF2aW91ciBtdXN0IGJlIGltcGxlbWVudGVkIHRvIG1ha2UgdGhlIHdpZGdldCBiZWhhdmlvdXIgd29yay4KICAgIC8vIEBmaXhtZSBUaGlzIGlzIGEgbmFzdHkgY29kZSBzbWVsbAogICAgdmFyIF9kb21FbGVtZW50OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdkb21FbGVtZW50JywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfZG9tRWxlbWVudDsgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKGRvbUVsZW1lbnQpIHsgX2RvbUVsZW1lbnQgPSBkb21FbGVtZW50OyB9CiAgICB9KQoKICAgIC8vIE1peGluIGNvbW1vbiB3aWRnZXQgYmVoYXZpb3VyCiAgICBPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCh0aGlzLCB7CiAgICAgICAgbW9kZTogb3B0aW9ucy5tb2RlLAogICAgICAgIG5vZGVOYW1lOiAnYnV0dG9uJywKICAgICAgICBodG1sQ29udGVudDogJ1NldHRpbmdzJywKICAgICAgICBodG1sQXR0cmlidXRlczoge2NsYXNzTmFtZTogJ09UX3NldHRpbmdzLXBhbmVsJ30sCiAgICAgICAgb25DcmVhdGU6IGF0dGFjaEV2ZW50cy5iaW5kKHRoaXMpLAogICAgICAgIG9uRGVzdHJveTogZGV0YWNoRXZlbnRzLmJpbmQodGhpcykKICAgIH0pOwp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKT1QuQ2hyb21lLlNldHRpbmdzUGFuZWwgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBpZiAoIW9wdGlvbnMuc3RyZWFtKSB7CiAgICAgICAgLy8gQHRvZG8gcmFpc2UgZXJyb3IKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHdlYlJUQ1N0cmVhbSA9IG9wdGlvbnMuc3RyZWFtOwoKICAgIC8vIFRoaXMgYmVoYXZpb3VyIG11c3QgYmUgaW1wbGVtZW50ZWQgdG8gbWFrZSB0aGUgd2lkZ2V0IGJlaGF2aW91ciB3b3JrLgogICAgLy8gQGZpeG1lIFRoaXMgaXMgYSBuYXN0eSBjb2RlIHNtZWxsCiAgICB2YXIgX2RvbUVsZW1lbnQ7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2RvbUVsZW1lbnQnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9kb21FbGVtZW50OyB9LAogICAgICAgIHNldDogZnVuY3Rpb24oZG9tRWxlbWVudCkgeyBfZG9tRWxlbWVudCA9IGRvbUVsZW1lbnQ7IH0KICAgIH0pCgogICAgdmFyIHJlbmRlckRpYWxvZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY2FtTGFiZWwgPSB3ZWJSVENTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKS5sZW5ndGggPyB3ZWJSVENTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKVswXS5sYWJlbCA6ICJOb25lIiwKICAgICAgICAgICAgICAgIG1pY0xhYmVsID0gd2ViUlRDU3RyZWFtLmdldEF1ZGlvVHJhY2tzKCkubGVuZ3RoID8gd2ViUlRDU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF0ubGFiZWwgOiAiTm9uZSI7CgogICAgICAgICAgICBfZG9tRWxlbWVudC5pbm5lckhUTUwgPSAiPGRsPlwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkdD5DYW08L2R0PlwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkZD4iICsgY2FtTGFiZWwgKyAiPC9kZD5cCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZHQ+TWljPC9kdD5cCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGQ+IiArIG1pY0xhYmVsICsgIjwvZGQ+XAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2RsPiI7CgoKICAgICAgICAgICAgdmFyIGNsb3NlQnV0dG9uICA9IE9ULiQuY3JlYXRlQnV0dG9uKCdDbG9zZScsIHsKICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogJ09UX2Nsb3NlJwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBjbGljazogb25DbG9zZS5iaW5kKHRoaXMpCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX2RvbUVsZW1lbnQuYXBwZW5kQ2hpbGQoY2xvc2VCdXR0b24pOwogICAgICAgIH0sCgogICAgICAgIG9uU2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZW5kZXJEaWFsb2cuY2FsbCh0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBvbkNsb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucGFyZW50LnRyaWdnZXIoJ1NldHRpbmdzUGFuZWw6Y2xvc2UnLCB0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgoKICAgIC8vIE1peGluIGNvbW1vbiB3aWRnZXQgYmVoYXZpb3VyCiAgICBPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCh0aGlzLCB7CiAgICAgICAgbW9kZTogb3B0aW9ucy5tb2RlLAogICAgICAgIG5vZGVOYW1lOiAnc2VjdGlvbicsCiAgICAgICAgaHRtbENvbnRlbnQ6ICdTZXR0aW5ncycsCiAgICAgICAgaHRtbEF0dHJpYnV0ZXM6IHtjbGFzc05hbWU6ICdPVF9zZXR0aW5ncy1wYW5lbCd9LAogICAgICAgIG9uQ3JlYXRlOiByZW5kZXJEaWFsb2cuYmluZCh0aGlzKSwKICAgICAgICBvblNob3c6IG9uU2hvdy5iaW5kKHRoaXMpCiAgICB9KTsKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCk9ULkNocm9tZS5PcGVuVG9rQnV0dG9uID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgLy8gVGhpcyBiZWhhdmlvdXIgbXVzdCBiZSBpbXBsZW1lbnRlZCB0byBtYWtlIHRoZSB3aWRnZXQgYmVoYXZpb3VyIHdvcmsuCiAgICAvLyBAZml4bWUgVGhpcyBpcyBhIG5hc3R5IGNvZGUgc21lbGwKICAgIHZhciBfZG9tRWxlbWVudDsKICAgIHRoaXMuX19kZWZpbmVHZXR0ZXJfXygiZG9tRWxlbWVudCIsIGZ1bmN0aW9uKCkgeyByZXR1cm4gX2RvbUVsZW1lbnQ7IH0pOwogICAgdGhpcy5fX2RlZmluZVNldHRlcl9fKCJkb21FbGVtZW50IiwgZnVuY3Rpb24oZG9tRWxlbWVudCkgeyBfZG9tRWxlbWVudCA9IGRvbUVsZW1lbnQ7IH0pOwoKICAgIC8vIE1peGluIGNvbW1vbiB3aWRnZXQgYmVoYXZpb3VyCiAgICBPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCh0aGlzLCB7CiAgICAgICAgbW9kZTogb3B0aW9ucyA/IG9wdGlvbnMubW9kZSA6IG51bGwsCiAgICAgICAgbm9kZU5hbWU6ICdzcGFuJywKICAgICAgICBodG1sQ29udGVudDogJ09wZW5Ub2snLAogICAgICAgIGh0bWxBdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIGNsYXNzTmFtZTogJ09UX29wZW50b2snCiAgICAgICAgfQogICAgfSk7Cn07Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7Ci8qIFN0eWxhYmxlIE5vdGVzCgoqIFJUQyBkb2Vzbid0IG5lZWQgdG8gd2FpdCB1bnRpbCBhbnl0aGluZyBpcyBsb2FkZWQgKGZsYXNoIG5lZWRzIHRvIHdhaXQgdW50aWwgdGhlIEZsYXNoIGNvbXBvbmVudCBsb2FkcykKKiBTb21lIGJpdHMgYXJlIGNvbnRyb2xsZWQgYnkgbXVsdGlwbGUgZmxhZ3MsIGkuZS4gYnV0dG9uRGlzcGxheU1vZGUgYW5kIG5hbWVEaXNwbGF5TW9kZS4KKiBXaGVuIHRoZXJlIGFyZSBtdWx0aXBsZSBmbGFncyBob3cgaXMgdGhlIGZpbmFsIHNldHRpbmcgY2hvc2VuPwoqIFdoZW4gc29tZSBzdHlsZSBiaXRzIGFyZSBzZXQgdXBkYXRlcyB3aWxsIG5lZWQgdG8gYmUgcHVzaGVkIHRocm91Z2ggdG8gdGhlIENocm9tZQoqLwoKLy8gTWl4ZXMgdGhlIFN0eWxhYmxlQ29tcG9uZW50IGJlaGF2aW91ciBpbnRvIHRoZSArc2VsZisgb2JqZWN0LiBJdCB3aWxsCi8vIGFsc28gc2V0IHRoZSBkZWZhdWx0IHN0eWxlcyB0byAraW5pdGlhbFN0eWxlcysuCi8vCi8vIEBub3RlIFRoaXMgTWl4aW4gaXMgZGVwZW5kZW50IG9uIE9ULkV2ZW50aW5nLgovLwovLwovLyBAZXhhbXBsZQovLwovLyAgZnVuY3Rpb24gU29tZU9iamVjdCB7Ci8vICAgICAgT1QuU3R5bGFibGVDb21wb25lbnQodGhpcywgewovLyAgICAgICAgICBuYW1lOiAnU29tZU9iamVjdCcsCi8vICAgICAgICAgIGZvbzogJ2JhcicKLy8gICAgICB9KTsKLy8gIH0KLy8KLy8gIHZhciBvYmogPSBuZXcgU29tZU9iamVjdCgpOwovLyAgb2JqLmdldFN0eWxlKCdmb28nKTsgICAgICAgIC8vID0+ICdiYXInCi8vICBvYmouc2V0U3R5bGUoJ2ZvbycsICdiYXonKQovLyAgb2JqLmdldFN0eWxlKCdmb28nKTsgICAgICAgIC8vID0+ICdiYXonCi8vICBvYmouZ2V0U3R5bGUoKTsgICAgICAgICAgICAgLy8gPT4ge25hbWU6ICdTb21lT2JqZWN0JywgZm9vOiAnYmF6J30KLy8KT1QuU3R5bGFibGVDb21wb25lbnQgPSBmdW5jdGlvbihzZWxmLCBpbml0YWxTdHlsZXMpIHsKICAgIGlmICghc2VsZi50cmlnZ2VyKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPVC5TdHlsYWJsZUNvbXBvbmVudCBpcyBkZXBlbmRlbnQgb24gdGhlIG1peGluIE9ULiQuZXZlbnRpbmcuIEVuc3VyZSB0aGF0IHRoaXMgaXMgaW5jbHVkZWQgaW4gdGhlIG9iamVjdCBiZWZvcmUgU3R5bGFibGVDb21wb25lbnQuIik7CiAgICB9CgogICAgLy8gQnJvYWRjYXN0IHN0eWxlIGNoYW5nZXMgYXMgdGhlIHN0eWxlVmFsdWVDaGFuZ2VkIGV2ZW50CiAgICB2YXIgb25TdHlsZUNoYW5nZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgaWYgKG9sZFZhbHVlKSB7CiAgICAgICAgICAgIHNlbGYudHJpZ2dlcignc3R5bGVWYWx1ZUNoYW5nZWQnLCBrZXksIHZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBzZWxmLnRyaWdnZXIoJ3N0eWxlVmFsdWVDaGFuZ2VkJywga2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgfTsKCiAgICB2YXIgX3N0eWxlID0gbmV3IFN0eWxlKGluaXRhbFN0eWxlcywgb25TdHlsZUNoYW5nZSk7CgogICAgLyoqCiAgICAqIFJldHVybnMgYW4gb2JqZWN0IHRoYXQgaGFzIHRoZSBwcm9wZXJ0aWVzIHRoYXQgZGVmaW5lIHRoZSBjdXJyZW50IHVzZXIgaW50ZXJmYWNlIGNvbnRyb2xzIG9mIHRoZSBQdWJsaXNoZXIuCiAgICAqIFlvdSBjYW4gbW9kaWZ5IHRoZSBwcm9wZXJ0aWVzIG9mIHRoaXMgb2JqZWN0IGFuZCBwYXNzIHRoZSBvYmplY3QgdG8gdGhlIDxjb2RlPnNldFN0eWxlKCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUKICAgICogUHVibGlzaGVyIG9iamVjdC4gKFNlZSB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgPGEgaHJlZj0iI3NldFN0eWxlIj5zZXRTdHlsZSgpPC9hPiB0byBzZWUgdGhlIHN0eWxlcyB0aGF0IGRlZmluZQogICAgKiB0aGlzIG9iamVjdC4pCiAgICAqIEByZXR1cm4ge09iamVjdH0gVGhlIG9iamVjdCB0aGF0IGRlZmluZXMgdGhlIHN0eWxlcyBvZiB0aGUgUHVibGlzaGVyLgogICAgKiBAc2VlIDxhIGhyZWY9IiNzZXRTdHlsZSI+c2V0U3R5bGUoKTwvYT4KICAgICogQG1ldGhvZCAjZ2V0U3R5bGUKICAgICogQG1lbWJlck9mIFB1Ymxpc2hlcgogICAgKi8KCiAgLyoqCiAgKiBSZXR1cm5zIGFuIG9iamVjdCB0aGF0IGhhcyB0aGUgcHJvcGVydGllcyB0aGF0IGRlZmluZSB0aGUgY3VycmVudCB1c2VyIGludGVyZmFjZSBjb250cm9scyBvZiB0aGUgU3Vic2NyaWJlci4KICAqIFlvdSBjYW4gbW9kaWZ5IHRoZSBwcm9wZXJ0aWVzIG9mIHRoaXMgb2JqZWN0IGFuZCBwYXNzIHRoZSBvYmplY3QgdG8gdGhlIDxjb2RlPnNldFN0eWxlKCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUKICAqIFN1YnNjcmliZXIgb2JqZWN0LiAoU2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciA8YSBocmVmPSIjc2V0U3R5bGUiPnNldFN0eWxlKCk8L2E+IHRvIHNlZSB0aGUgc3R5bGVzIHRoYXQgZGVmaW5lCiAgKiB0aGlzIG9iamVjdC4pCiAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBvYmplY3QgdGhhdCBkZWZpbmVzIHRoZSBzdHlsZXMgb2YgdGhlIFN1YnNjcmliZXIuCiAgKiBAc2VlIDxhIGhyZWY9IiNzZXRTdHlsZSI+c2V0U3R5bGUoKTwvYT4KICAqIEBtZXRob2QgI2dldFN0eWxlCiAgKiBAbWVtYmVyT2YgU3Vic2NyaWJlcgogICovCiAgICAvLyBJZiAra2V5KyBpcyBmYWxzbHkgdGhlbiBhbGwgc3R5bGVzIHdpbGwgYmUgcmV0dXJuZWQuCiAgICBzZWxmLmdldFN0eWxlID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIF9zdHlsZS5nZXQoa2V5KTsKICAgIH07CgogICAgLyoqCiAgICAqIFNldHMgcHJvcGVydGllcyB0aGF0IGRlZmluZSB0aGUgYXBwZWFyYW5jZSBvZiBzb21lIHVzZXIgaW50ZXJmYWNlIGNvbnRyb2xzIG9mIHRoZSBQdWJsaXNoZXIuCiAgICAqCiAgICAqIDxwPllvdSBjYW4gZWl0aGVyIHBhc3Mgb25lIHBhcmFtZXRlciBvciB0d28gcGFyYW1ldGVycyB0byB0aGlzIG1ldGhvZC48L3A+CiAgICAqCiAgICAqIDxwPklmIHlvdSBwYXNzIG9uZSBwYXJhbWV0ZXIsIDxjb2RlPnN0eWxlPC9jb2RlPiwgaXQgaXMgYW4gb2JqZWN0IHRoYXQgaGFzIG9uZSBwcm9wZXJ0eTogPGNvZGU+bmFtZURpc3BsYXlNb2RlPC9jb2RlPi4KICAgICogUG9zc2libGUgdmFsdWVzIGZvciB0aGUgPGNvZGU+c3R5bGUubmFtZURpc3BsYXlNb2RlPC9jb2RlPiBwcm9wZXJ0eSBhcmU6ICJhdXRvIiAodGhlIG5hbWUgaXMgZGlzcGxheWVkIHdoZW4gdGhlIHN0cmVhbQogICAgKiBpcyBmaXJzdCBkaXNwbGF5ZWQgYW5kIHdoZW4gdGhlIHVzZXIgbW91c2VzIG92ZXIgdGhlIGRpc3BsYXkpLCAib2ZmIiAodGhlIG5hbWUgaXMgbm90IGRpc3BsYXllZCksIGFuZCAib24iCiAgICAqICh0aGUgbmFtZSBpcyBkaXNwbGF5ZWQpLgogICAgKgogICAgKiA8cD5Gb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIHBhc3NlcyBvbmUgcGFyYW1ldGVyIHRvIHRoZSBtZXRob2Q6PC9wPgogICAgKgogICAgKiA8cHJlPm15UHVibGlzaGVyLnNldFN0eWxlKHtuYW1lRGlzcGxheU1vZGU6ICJvZmYifSk7PC9wcmU+CiAgICAqCiAgICAqIDxwPklmIHlvdSBwYXNzIHR3byBwYXJhbWV0ZXJzLCA8Y29kZT5zdHlsZTwvY29kZT4gYW5kIDxjb2RlPnZhbHVlPC9jb2RlPiwgdGhleSBhcmUga2V5LXZhbHVlIHBhaXIgdGhhdAogICAgKiBkZWZpbmUgb25lIHByb3BlcnR5IG9mIHRoZSBkaXNwbGF5IHN0eWxlLiBGb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIHBhc3NlcyB0d28gcGFyYW1ldGVyIHZhbHVlcwogICAgKiB0byB0aGUgbWV0aG9kOjwvcD4KICAgICoKICAgICogPHByZT5teVB1Ymxpc2hlci5zZXRTdHlsZSgibmFtZURpc3BsYXlNb2RlIiwgIm9mZiIpOzwvcHJlPgogICAgKgogICAgKiA8cD5Zb3UgY2FuIHNldCB0aGUgaW5pdGlhbCBzZXR0aW5ncyB3aGVuIHlvdSBjYWxsIHRoZSA8Y29kZT5TZXNzaW9uLnB1Ymxpc2goKTwvY29kZT4KICAgICogb3IgPGNvZGU+VEIuaW5pdFB1Ymxpc2hlcigpPC9jb2RlPiBtZXRob2QuIFBhc3MgYSA8Y29kZT5zdHlsZTwvY29kZT4gcHJvcGVydHkgYXMgcGFydCBvZiB0aGUKICAgICogPGNvZGU+cHJvcGVydGllczwvY29kZT4gcGFyYW1ldGVyIG9mIHRoZSBtZXRob2QuPC9wPgogICAgKgogICAgKiA8cD5UaGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgYW4gPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudCBpZiB5b3UgcGFzcyBpbiBhbiBpbnZhbGlkIHN0eWxlIHRvIHRoZSBtZXRob2QuCiAgICAqIFRoZSA8Y29kZT5jb2RlPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUgRXhjZXB0aW9uRXZlbnQgb2JqZWN0IGlzIHNldCB0byAxMDExLjwvcD4KICAgICoKICAgICogQHBhcmFtIHtPYmplY3R9IHN0eWxlIEVpdGhlciBhbiBvYmplY3QgY29udGFpbmluZyBwcm9wZXJ0aWVzIHRoYXQgZGVmaW5lIHRoZSBzdHlsZSwgb3IgYSBTdHJpbmcgZGVmaW5pbmcgdGhpcwogICAgKiBzaW5nbGUgc3R5bGUgcHJvcGVydHkgdG8gc2V0LgogICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIHNldCBmb3IgdGhlIDxjb2RlPnN0eWxlPC9jb2RlPiBwYXNzZWQgaW4uIFBhc3MgYSB2YWx1ZSBmb3IgdGhpcyBwYXJhbWV0ZXIKICAgICogb25seSBpZiB0aGUgdmFsdWUgb2YgdGhlIDxjb2RlPnN0eWxlPC9jb2RlPiBwYXJhbWV0ZXIgaXMgYSBTdHJpbmcuPC9wPgogICAgKgogICAgKiBAc2VlIDxhIGhyZWY9IiNnZXRTdHlsZSI+Z2V0U3R5bGUoKTwvYT4KICAgICogQHJldHVybiB7UHVibGlzaGVyfSBUaGUgUHVibGlzaGVyIG9iamVjdAogICAgKiBAc2VlIDxhIGhyZWY9IiNzZXRTdHlsZSI+c2V0U3R5bGUoKTwvYT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjc3Vic2NyaWJlIj5TZXNzaW9uLnB1Ymxpc2goKTwvYT4KICAgICogQHNlZSA8YSBocmVmPSJUQi5odG1sI2luaXRQdWJsaXNoZXIiPlRCLmluaXRQdWJsaXNoZXIoKTwvYT4KICAgICogQG1ldGhvZCAjc2V0U3R5bGUKICAgICogQG1lbWJlck9mIFB1Ymxpc2hlcgogICAgKi8KCiAgICAvKioKICAgICogU2V0cyBwcm9wZXJ0aWVzIHRoYXQgZGVmaW5lIHRoZSBhcHBlYXJhbmNlIG9mIHNvbWUgdXNlciBpbnRlcmZhY2UgY29udHJvbHMgb2YgdGhlIFN1YnNjcmliZXIuCiAgICAqCiAgICAqIDxwPllvdSBjYW4gZWl0aGVyIHBhc3Mgb25lIHBhcmFtZXRlciBvciB0d28gcGFyYW1ldGVycyB0byB0aGlzIG1ldGhvZC48L3A+CiAgICAqCiAgICAqIDxwPklmIHlvdSBwYXNzIG9uZSBwYXJhbWV0ZXIsIDxjb2RlPnN0eWxlPC9jb2RlPiwgaXQgaXMgYW4gb2JqZWN0IHRoYXQgaGFzIG9uZSBwcm9wZXJ0eTogPGNvZGU+bmFtZURpc3BsYXlNb2RlPC9jb2RlPi4KICAgICogUG9zc2libGUgdmFsdWVzIGZvciB0aGUgPGNvZGU+c3R5bGUubmFtZURpc3BsYXlNb2RlPC9jb2RlPiBwcm9wZXJ0eSBhcmU6ICJhdXRvIiAodGhlIG5hbWUgaXMgZGlzcGxheWVkIHdoZW4gdGhlIHN0cmVhbQogICAgKiBpcyBmaXJzdCBkaXNwbGF5ZWQgYW5kIHdoZW4gdGhlIHVzZXIgbW91c2VzIG92ZXIgdGhlIGRpc3BsYXkpLCAib2ZmIiAodGhlIG5hbWUgaXMgbm90IGRpc3BsYXllZCksIGFuZCAib24iCiAgICAqICh0aGUgbmFtZSBpcyBkaXNwbGF5ZWQpLgogICAgKgogICAgKiA8cD5Gb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIHBhc3NlcyBvbmUgcGFyYW1ldGVyIHRvIHRoZSBtZXRob2Q6PC9wPgogICAgKgogICAgKiA8cHJlPm15U3Vic2NyaWJlci5zZXRTdHlsZSh7bmFtZURpc3BsYXlNb2RlOiAib2ZmIn0pOzwvcHJlPgogICAgKgogICAgKiA8cD5JZiB5b3UgcGFzcyB0d28gcGFyYW1ldGVycywgPGNvZGU+c3R5bGU8L2NvZGU+IGFuZCA8Y29kZT52YWx1ZTwvY29kZT4sIHRoZXkgYXJlIGtleS12YWx1ZSBwYWlyIHRoYXQKICAgICogZGVmaW5lIG9uZSBwcm9wZXJ0eSBvZiB0aGUgZGlzcGxheSBzdHlsZS4gRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgY29kZSBwYXNzZXMgdHdvIHBhcmFtZXRlciB2YWx1ZXMKICAgICogdG8gdGhlIG1ldGhvZDo8L3A+CiAgICAqCiAgICAqIDxwcmU+bXlTdWJzY3JpYmVyLnNldFN0eWxlKCJuYW1lRGlzcGxheU1vZGUiLCAib2ZmIik7PC9wcmU+CiAgICAqCiAgICAqIDxwPllvdSBjYW4gc2V0IHRoZSBpbml0aWFsIHNldHRpbmdzIHdoZW4geW91IGNhbGwgdGhlIDxjb2RlPlNlc3Npb24uc3Vic2NyaWJlKCk8L2NvZGU+IG1ldGhvZC4KICAgICogUGFzcyBhIDxjb2RlPnN0eWxlPC9jb2RlPiBwcm9wZXJ0eSBhcyBwYXJ0IG9mIHRoZSA8Y29kZT5wcm9wZXJ0aWVzPC9jb2RlPiBwYXJhbWV0ZXIgb2YgdGhlIG1ldGhvZC48L3A+CiAgICAqCiAgICAqIDxwPlRoZSBUQiBvYmplY3QgZGlzcGF0Y2hlcyBhbiA8Y29kZT5leGNlcHRpb248L2NvZGU+IGV2ZW50IGlmIHlvdSBwYXNzIGluIGFuIGludmFsaWQgc3R5bGUgdG8gdGhlIG1ldGhvZC4KICAgICogVGhlIDxjb2RlPmNvZGU8L2NvZGU+IHByb3BlcnR5IG9mIHRoZSBFeGNlcHRpb25FdmVudCBvYmplY3QgaXMgc2V0IHRvIDEwMTEuPC9wPgogICAgKgogICAgKiBAcGFyYW0ge09iamVjdH0gc3R5bGUgRWl0aGVyIGFuIG9iamVjdCBjb250YWluaW5nIHByb3BlcnRpZXMgdGhhdCBkZWZpbmUgdGhlIHN0eWxlLCBvciBhIFN0cmluZyBkZWZpbmluZyB0aGlzCiAgICAqIHNpbmdsZSBzdHlsZSBwcm9wZXJ0eSB0byBzZXQuCiAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0IGZvciB0aGUgPGNvZGU+c3R5bGU8L2NvZGU+IHBhc3NlZCBpbi4gUGFzcyBhIHZhbHVlIGZvciB0aGlzIHBhcmFtZXRlcgogICAgKiBvbmx5IGlmIHRoZSB2YWx1ZSBvZiB0aGUgPGNvZGU+c3R5bGU8L2NvZGU+IHBhcmFtZXRlciBpcyBhIFN0cmluZy48L3A+CiAgICAqCiAgICAqIEByZXR1cm5zIHtTdWJzY3JpYmVyfSBUaGUgU3Vic2NyaWJlciBvYmplY3QuCiAgICAqCiAgICAqIEBzZWUgPGEgaHJlZj0iI2dldFN0eWxlIj5nZXRTdHlsZSgpPC9hPgogICAgKiBAc2VlIDxhIGhyZWY9IiNzZXRTdHlsZSI+c2V0U3R5bGUoKTwvYT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjc3Vic2NyaWJlIj5TZXNzaW9uLnN1YnNjcmliZSgpPC9hPgogICAgKiBAbWV0aG9kICNzZXRTdHlsZQogICAgKiBAbWVtYmVyT2YgU3Vic2NyaWJlcgogICAgKi8KICAgIHNlbGYuc2V0U3R5bGUgPSBmdW5jdGlvbihrZXlPclN0eWxlSGFzaCwgdmFsdWUsIHNpbGVudCkgewogICAgICAgIGlmICh0eXBlb2Yoa2V5T3JTdHlsZUhhc2gpICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICBfc3R5bGUuc2V0QWxsKGtleU9yU3R5bGVIYXNoLCBzaWxlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgX3N0eWxlLnNldChrZXlPclN0eWxlSGFzaCwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Owp9OwoKdmFyIFN0eWxlID0gZnVuY3Rpb24oaW5pdGFsU3R5bGVzLCBvblN0eWxlQ2hhbmdlKSB7CiAgICB2YXIgX0NPTVBPTkVOVF9TVFlMRVMgPSBbCiAgICAgICAgICAgICJzaG93TWljQnV0dG9uIiwKICAgICAgICAgICAgInNob3dTcGVha2VyQnV0dG9uIiwKICAgICAgICAgICAgInNob3dTZXR0aW5nc0J1dHRvbiIsCiAgICAgICAgICAgICJzaG93Q2FtZXJhVG9nZ2xlQnV0dG9uIiwKICAgICAgICAgICAgIm5hbWVEaXNwbGF5TW9kZSIsCiAgICAgICAgICAgICJidXR0b25EaXNwbGF5TW9kZSIsCiAgICAgICAgICAgICJzaG93U2F2ZUJ1dHRvbiIsCiAgICAgICAgICAgICJzaG93UmVjb3JkQnV0dG9uIiwKICAgICAgICAgICAgInNob3dSZWNvcmRTdG9wQnV0dG9uIiwKICAgICAgICAgICAgInNob3dSZVJlY29yZEJ1dHRvbiIsCiAgICAgICAgICAgICJzaG93UGF1c2VCdXR0b24iLAogICAgICAgICAgICAic2hvd1BsYXlCdXR0b24iLAogICAgICAgICAgICAic2hvd1BsYXlTdG9wQnV0dG9uIiwKICAgICAgICAgICAgInNob3dTdG9wQnV0dG9uIiwKICAgICAgICAgICAgImJhY2tncm91bmRJbWFnZVVSSSIsCiAgICAgICAgICAgICJzaG93Q29udHJvbFBhbmVsIiwKICAgICAgICAgICAgInNob3dSZWNvcmRDb3VudGVyIiwKICAgICAgICAgICAgInNob3dQbGF5Q291bnRlciIsCiAgICAgICAgICAgICJzaG93Q29udHJvbEJhciIsCiAgICAgICAgICAgICJzaG93UHJldmlld1RpbWUiCiAgICAgICAgXSwKCiAgICAgICAgX3ZhbGlkU3R5bGVWYWx1ZXMgPSB7CiAgICAgICAgICAgIGJ1dHRvbkRpc3BsYXlNb2RlOiBbImF1dG8iLCAib2ZmIiwgIm9uIl0sCiAgICAgICAgICAgIG5hbWVEaXNwbGF5TW9kZTogWyJhdXRvIiwgIm9mZiIsICJvbiJdLAogICAgICAgICAgICBzaG93U2V0dGluZ3NCdXR0b246IFt0cnVlLCBmYWxzZV0sCiAgICAgICAgICAgIHNob3dNaWNCdXR0b246IFt0cnVlLCBmYWxzZV0sCiAgICAgICAgICAgIHNob3dDYW1lcmFUb2dnbGVCdXR0b246IFt0cnVlLCBmYWxzZV0sCiAgICAgICAgICAgIHNob3dTYXZlQnV0dG9uOiBbdHJ1ZSwgZmFsc2VdLAogICAgICAgICAgICBiYWNrZ3JvdW5kSW1hZ2VVUkk6IG51bGwsCiAgICAgICAgICAgIHNob3dDb250cm9sQmFyOiBbdHJ1ZSwgZmFsc2VdLAogICAgICAgICAgICBzaG93UGxheUNvdW50ZXI6IFt0cnVlLCBmYWxzZV0sCiAgICAgICAgICAgIHNob3dSZWNvcmRDb3VudGVyOiBbdHJ1ZSwgZmFsc2VdLAogICAgICAgICAgICBzaG93UHJldmlld1RpbWU6IFt0cnVlLCBmYWxzZV0KICAgICAgICB9LAoKICAgICAgICBfc3R5bGUgPSB7fSwKCgogICAgICAgIC8vIFZhbGlkYXRlcyB0aGUgc3R5bGUgK2tleSsgYW5kIGFsc28gd2hldGhlciArdmFsdWUrIGlzIHZhbGlkIGZvciAra2V5KwogICAgICAgIGlzVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGtleSA9PT0gJ2JhY2tncm91bmRJbWFnZVVSSScgfHwKICAgICAgICAgICAgICAgICAgICAoICAgX3ZhbGlkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJgogICAgICAgICAgICAgICAgICAgICAgICBfdmFsaWRTdHlsZVZhbHVlc1trZXldLmluZGV4T2YodmFsdWUpICE9PSAtMSApOwogICAgICAgIH0sCgogICAgICAgIGNhc3RWYWx1ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHN3aXRjaCh2YWx1ZSkgewogICAgICAgICAgICAgICAgY2FzZSAndHJ1ZSc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBjYXNlICdmYWxzZSc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAvLyBSZXR1cm5zIGEgc2hhbGxvdyBjb3B5IG9mIHRoZSBzdHlsZXMuCiAgICB0aGlzLmdldEFsbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzdHlsZSA9IE9ULiQuY2xvbmUoX3N0eWxlKTsKCiAgICAgICAgZm9yICh2YXIgaSBpbiBzdHlsZSkgewogICAgICAgICAgICBpZiAoX0NPTVBPTkVOVF9TVFlMRVMuaW5kZXhPZihpKSA8IDApIHsKICAgICAgICAgICAgICAgIC8vIFN0cmlwIHVubmVjZXNzYXJ5IHByb3BlcnRpZXMgb3V0LCBzaG91bGQgdGhpcyBoYXBwZW4gb24gU2V0PwogICAgICAgICAgICAgICAgZGVsZXRlIHN0eWxlW2ldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3R5bGU7CiAgICB9OwoKICAgIHRoaXMuZ2V0ID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICByZXR1cm4gX3N0eWxlW2tleV07CiAgICAgICAgfQoKICAgICAgICAvLyBXZSBoYXZlbid0IGJlZW4gYXNrZWQgZm9yIGFueSBzcGVjaWZpYyBrZXksIGp1c3QgcmV0dXJuIHRoZSBsb3QKICAgICAgICByZXR1cm4gdGhpcy5nZXRBbGwoKTsKICAgIH07CgogICAgLy8gKm5vdGU6KiB0aGlzIHdpbGwgbm90IHRyaWdnZXIgb25TdHlsZUNoYW5nZSBpZiArc2lsZW50KyBpcyB0cnV0aHkKICAgIHRoaXMuc2V0QWxsID0gZnVuY3Rpb24obmV3U3R5bGVzLCBzaWxlbnQpIHsKICAgICAgICB2YXIgb2xkVmFsdWUsIG5ld1ZhbHVlOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmV3U3R5bGVzKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gY2FzdFZhbHVlKG5ld1N0eWxlc1trZXldKTsKCiAgICAgICAgICAgIGlmIChpc1ZhbGlkU3R5bGUoa2V5LCBuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIG9sZFZhbHVlID0gX3N0eWxlW2tleV07CgogICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIF9zdHlsZVtrZXldID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzaWxlbnQpIG9uU3R5bGVDaGFuZ2Uoa2V5LCBuZXdWYWx1ZSwgb2xkVmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgT1Qud2FybigiU3R5bGUuc2V0QWxsOjpJbnZhbGlkIHN0eWxlIHByb3BlcnR5IHBhc3NlZCAiICsga2V5ICsgIiA6ICIgKyBuZXdWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB0aGlzLnNldCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBPVC5kZWJ1ZygiUHVibGlzaGVyLnNldFN0eWxlOiAiICsga2V5LnRvU3RyaW5nKCkpOwoKICAgICAgICB2YXIgbmV3VmFsdWUgPSBjYXN0VmFsdWUodmFsdWUpLAogICAgICAgICAgICBvbGRWYWx1ZTsKCiAgICAgICAgaWYgKCFpc1ZhbGlkU3R5bGUoa2V5LCBuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgT1Qud2FybigiU3R5bGUuc2V0OjpJbnZhbGlkIHN0eWxlIHByb3BlcnR5IHBhc3NlZCAiICsga2V5ICsgIiA6ICIgKyBuZXdWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICAgICAgb2xkVmFsdWUgPSBfc3R5bGVba2V5XTsKICAgICAgICBpZiAobmV3VmFsdWUgIT09IG9sZFZhbHVlKSB7CiAgICAgICAgICAgIF9zdHlsZVtrZXldID0gbmV3VmFsdWU7CgogICAgICAgICAgICBvblN0eWxlQ2hhbmdlKGtleSwgdmFsdWUsIG9sZFZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgaWYgKGluaXRhbFN0eWxlcykgdGhpcy5zZXRBbGwoaW5pdGFsU3R5bGVzLCB0cnVlKTsKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8qKgogKiBBIFB1Ymxpc2hlcnMgTWljcm9waG9uZS4KICoKICogVE9ETwogKiAqIGJpbmQgdG8gY2hhbmdlcyBpbiBtdXRlL3VubXV0ZS92b2x1bWUvZXRjIGFuZCByZXNwb25kIHRvIHRoZW0KICovCk9ULk1pY3JvcGhvbmUgPSBmdW5jdGlvbih3ZWJSVENTdHJlYW0sIG11dGVkKSB7CiAgICB2YXIgX211dGVkLAogICAgICAgIF9nYWluID0gNTA7CgoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnbXV0ZWQnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9tdXRlZDsgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKG11dGVkKSB7CiAgICAgICAgICAgIGlmIChfbXV0ZWQgPT09IG11dGVkKSByZXR1cm47CgogICAgICAgICAgICBfbXV0ZWQgPSBtdXRlZDsKCiAgICAgICAgICAgIHZhciBhdWRpb1RyYWNrcyA9IHdlYlJUQ1N0cmVhbS5nZXRBdWRpb1RyYWNrcygpOwoKICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBudW09YXVkaW9UcmFja3MubGVuZ3RoOyBpPG51bTsgKytpKSB7CiAgICAgICAgICAgICAgICBhdWRpb1RyYWNrc1tpXS5lbmFibGVkID0gIV9tdXRlZDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnZ2FpbicsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2dhaW47IH0sCgogICAgICAgIHNldDogZnVuY3Rpb24oZ2FpbikgewogICAgICAgICAgICBPVC53YXJuKCJPVC5NaWNyb3Bob25lLmdhaW4gSVMgTk9UIFlFVCBJTVBMRU1FTlRFRCIpOwoKICAgICAgICAgICAgX2dhaW4gPSBnYWluOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIFNldCB0aGUgaW5pdGlhbCB2YWx1ZQogICAgaWYgKG11dGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLm11dGVkID0gbXV0ZWQgPT09IHRydWU7CiAgICB9CiAgICBlbHNlIGlmICh3ZWJSVENTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKS5sZW5ndGgpIHsKICAgICAgICB0aGlzLm11dGVkID0gIXdlYlJUQ1N0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdLmVuYWJsZWQ7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICB0aGlzLm11dGVkID0gZmFsc2U7CiAgICB9Cn07Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7CgovLyBBIEZhY3RvcnkgbWV0aG9kIGZvciBnZW5lcmF0aW5nIHNpbXBsZSBzdGF0ZSBtYWNoaW5lIGNsYXNzZXMuCi8vCi8vIEB1c2FnZQovLyAgICB2YXIgU3RhdGVNYWNoaW5lID0gT1QuZ2VuZXJhdGVTaW1wbGVTdGF0ZU1hY2hpbmUoJ3N0YXJ0JywgWydzdGFydCcsICdtaWRkbGUnLCAnZW5kJywgewovLyAgICAgIHN0YXJ0OiBbJ21pZGRsZSddLAovLyAgICAgIG1pZGRsZTogWydlbmQnXSwKLy8gICAgICBlbmQ6IFsnc3RhcnQnXQovLyAgICB9XSk7Ci8vCi8vICAgIHZhciBzdGF0ZXMgPSBuZXcgU3RhdGVNYWNoaW5lKCk7Ci8vICAgIHN0YXRlLmN1cnJlbnQ7ICAgICAgICAgICAgLy8gPC0tIHN0YXJ0Ci8vICAgIHN0YXRlLnNldCgnbWlkZGxlJyk7Ci8vCk9ULmdlbmVyYXRlU2ltcGxlU3RhdGVNYWNoaW5lID0gZnVuY3Rpb24oaW5pdGlhbFN0YXRlLCBzdGF0ZXMsIHRyYW5zaXRpb25zKSB7CiAgdmFyIHZhbGlkU3RhdGVzID0gc3RhdGVzLnNsaWNlKCksCiAgICAgIHZhbGlkVHJhbnNpdGlvbnMgPSBPVC4kLmNsb25lKHRyYW5zaXRpb25zKTsKCiAgdmFyIGlzVmFsaWRTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkgewogICAgcmV0dXJuIHZhbGlkU3RhdGVzLmluZGV4T2Yoc3RhdGUpICE9PSAtMTsKICB9CgogIHZhciBpc1ZhbGlkVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgcmV0dXJuIHZhbGlkVHJhbnNpdGlvbnNbZnJvbVN0YXRlXSAmJiB2YWxpZFRyYW5zaXRpb25zW2Zyb21TdGF0ZV0uaW5kZXhPZih0b1N0YXRlKSAhPT0gLTE7CiAgfTsKCiAgcmV0dXJuIGZ1bmN0aW9uKHN0YXRlQ2hhbmdlRmFpbGVkKSB7CiAgICB2YXIgY3VycmVudFN0YXRlID0gaW5pdGlhbFN0YXRlLAogICAgICAgIHByZXZpb3VzU3RhdGUgPSBudWxsOwoKICAgIGZ1bmN0aW9uIHNpZ25hbENoYW5nZUZhaWxlZChtZXNzYWdlLCBuZXdTdGF0ZSkgewogICAgICAgIHN0YXRlQ2hhbmdlRmFpbGVkKHsKICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgICBuZXdTdGF0ZTogbmV3U3RhdGUsCiAgICAgICAgICBjdXJyZW50U3RhdGU6IGN1cnJlbnRTdGF0ZSwKICAgICAgICAgIHByZXZpb3VzU3RhdGU6IHByZXZpb3VzU3RhdGUKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBWYWxpZGF0ZXMgK25ld1N0YXRlKy4gSWYgaXQncyBpbnZhbGlkIGl0IHRyaWdnZXJzIHN0YXRlQ2hhbmdlRmFpbGVkIGFuZCByZXR1cm5zIGZhbHNlLgogICAgZnVuY3Rpb24gaGFuZGxlSW52YWxpZFN0YXRlQ2hhbmdlcyhuZXdTdGF0ZSkgewogICAgICBpZiAoIWlzVmFsaWRTdGF0ZShuZXdTdGF0ZSkpIHsKICAgICAgICBzaWduYWxDaGFuZ2VGYWlsZWQoIiciICsgbmV3U3RhdGUgKyAiJyBpcyBub3QgYSB2YWxpZCBzdGF0ZSIsIG5ld1N0YXRlKQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghaXNWYWxpZFRyYW5zaXRpb24oY3VycmVudFN0YXRlLCBuZXdTdGF0ZSkpIHsKICAgICAgICBzaWduYWxDaGFuZ2VGYWlsZWQoIiciICsgY3VycmVudFN0YXRlICsgIicgY2Fubm90IHRyYW5zaXRpb24gdG8gJyIgKyBuZXdTdGF0ZSArICInIiwgbmV3U3RhdGUpCgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgoKICAgIHRoaXMuc2V0ID0gZnVuY3Rpb24obmV3U3RhdGUpIHsKICAgICAgaWYgKCFoYW5kbGVJbnZhbGlkU3RhdGVDaGFuZ2VzKG5ld1N0YXRlKSkgcmV0dXJuOwoKICAgICAgcHJldmlvdXNTdGF0ZSA9IGN1cnJlbnRTdGF0ZTsKICAgICAgY3VycmVudFN0YXRlID0gbmV3U3RhdGU7CiAgICB9OwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsKICAgICAgY3VycmVudDogewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBjdXJyZW50U3RhdGU7IH0KICAgICAgfSwKCiAgICAgIHN1YnNjcmliaW5nOiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIGN1cnJlbnRTdGF0ZSA9PT0gJ1N1YnNjcmliaW5nJzsgfQogICAgICB9CiAgICB9KTsKICB9Owp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTW9kZWxzIGEgU3Vic2NyaWJlcidzIHN1YnNjcmliaW5nIFN0YXRlCi8vCi8vIFZhbGlkIFN0YXRlczoKLy8gICAgIE5vdFN1YnNjcmliaW5nICAgICAgICAgICAgKHRoZSBpbml0aWFsIHN0YXRlCi8vICAgICBJbml0ICAgICAgICAgICAgICAgICAgICAgIChiYXNpYyBzZXR1cCBvZiBET00KLy8gICAgIENvbm5lY3RpbmdUb1BlZXIgICAgICAgICAgKEZhaWx1cmUgQ2FzZXMgLT4gTm8gUm91dGUsIEJhZCBPZmZlciwgQmFkIEFuc3dlcgovLyAgICAgQmluZGluZ1JlbW90ZVN0cmVhbSAgICAgICAoRmFpbHVyZSBDYXNlcyAtPiBBbnl0aGluZyB0byBkbyB3aXRoIHRoZSBtZWRpYSBiZWluZyBpbnZhbGlkLCB0aGUgbWVkaWEgbmV2ZXIgcGxheXMKLy8gICAgIFN1YnNjcmliaW5nICAgICAgICAgICAgICAgKHRoaXMgaXMgJ29uTG9hZCcKLy8gICAgIEZhaWxlZCAgICAgICAgICAgICAgICAgICAgKHRlcm1pbmFsIHN0YXRlLCB3aXRoIGEgcmVhc29uIHRoYXQgbWFwcyB0byBvbmUgb2YgdGhlIGZhaWx1cmUgY2FzZXMgYWJvdmUKLy8KLy8KLy8gVmFsaWQgVHJhbnNpdGlvbnM6Ci8vICAgICBOb3RTdWJzY3JpYmluZyAtPgovLyAgICAgICAgIEluaXQKLy8KLy8gICAgIEluaXQgLT4KLy8gICAgICAgICAgICAgQ29ubmVjdGluZ1RvUGVlcgovLyAgICAgICAgICAgfCBCaW5kaW5nUmVtb3RlU3RyZWFtICAgICAgICAgKGlmIHdlIGFyZSBzdWJzY3JpYmluZyB0byBvdXJzZWx2ZXMgYW5kIHdlIGFscmVheSBoYXZlIGEgc3RyZWFtCi8vICAgICAgICAgICB8IE5vdFN1YnNjcmliaW5nICAgICAgICAgICAgICAoZGVzdHJveSgpCi8vCi8vICAgICBDb25uZWN0aW5nVG9QZWVyIC0+Ci8vICAgICAgICAgICAgIEJpbmRpbmdSZW1vdGVTdHJlYW0KLy8gICAgICAgICAgIHwgTm90U3Vic2NyaWJpbmcKLy8gICAgICAgICAgIHwgRmFpbGVkCi8vICAgICAgICAgICB8IE5vdFN1YnNjcmliaW5nICAgICAgICAgICAgICAoZGVzdHJveSgpCi8vCi8vICAgICBCaW5kaW5nUmVtb3RlU3RyZWFtIC0+Ci8vICAgICAgICAgICAgIFN1YnNjcmliaW5nCi8vICAgICAgICAgICB8IEZhaWxlZAovLyAgICAgICAgICAgfCBOb3RTdWJzY3JpYmluZyAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLyAgICAgU3Vic2NyaWJpbmcgLT4KLy8gICAgICAgICAgICAgTm90U3Vic2NyaWJpbmcgICAgICAgICAgICAgICh1bnN1YnNjcmliZQovLyAgICAgICAgICAgfCBGYWlsZWQgICAgICAgICAgICAgICAgICAgICAgKHByb2JhYmx5IGEgcGVlciBjb25uZWN0aW9uIGZhaWx1cmUgYWZ0ZXIgd2UgYmVnYW4gc3Vic2NyaWJpbmcKLy8KLy8gICAgIEZhaWxlZCAtPiAgICAgICAgICAgICAgICAgICAgICAgICAgICh0ZXJtaW5hbCBlcnJvciBzdGF0ZSkKLy8KLy8KLy8gQGV4YW1wbGUKLy8gICAgIHZhciBzdGF0ZSA9IG5ldyBTdWJzY3JpYmluZ1N0YXRlKGZ1bmN0aW9uKGNoYW5nZSkgewovLyAgICAgICBjb25zb2xlLmxvZyhjaGFuZ2UubWVzc2FnZSk7Ci8vICAgICB9KTsKLy8KLy8gICAgIHN0YXRlLnNldCgnSW5pdCcpOwovLyAgICAgc3RhdGUuY3VycmVudDsgICAgICAgICAgICAgICAgIC0+ICdJbml0JwovLwovLyAgICAgc3RhdGUuc2V0KCdTdWJzY3JpYmluZycpOyAgICAgIC0+IHRyaWdnZXJzIHN0YXRlQ2hhbmdlRmFpbGVkIGFuZCBsb2dzIG91dCB0aGUgZXJyb3IgbWVzc2FnZQovLwovLwoKdmFyIHZhbGlkU3RhdGVzID0gWyAnTm90U3Vic2NyaWJpbmcnLCAnSW5pdCcsICdDb25uZWN0aW5nVG9QZWVyJywgJ0JpbmRpbmdSZW1vdGVTdHJlYW0nLCAnU3Vic2NyaWJpbmcnLCAnRmFpbGVkJyBdLAoKICAgIHZhbGlkVHJhbnNpdGlvbnMgPSB7CiAgICAgIE5vdFN1YnNjcmliaW5nOiBbJ05vdFN1YnNjcmliaW5nJywgJ0luaXQnXSwKICAgICAgSW5pdDogWydOb3RTdWJzY3JpYmluZycsICdDb25uZWN0aW5nVG9QZWVyJywgJ0JpbmRpbmdSZW1vdGVTdHJlYW0nXSwKICAgICAgQ29ubmVjdGluZ1RvUGVlcjogWydOb3RTdWJzY3JpYmluZycsICdCaW5kaW5nUmVtb3RlU3RyZWFtJywgJ0ZhaWxlZCddLAogICAgICBCaW5kaW5nUmVtb3RlU3RyZWFtOiBbJ05vdFN1YnNjcmliaW5nJywgJ1N1YnNjcmliaW5nJywgJ0ZhaWxlZCddLAogICAgICBTdWJzY3JpYmluZzogWydOb3RTdWJzY3JpYmluZycsICdGYWlsZWQnXSwKICAgICAgRmFpbGVkOiBbXQogICAgfSwKCiAgICBpbml0aWFsU3RhdGUgPSAnTm90U3Vic2NyaWJpbmcnOwoKT1QuU3Vic2NyaWJpbmdTdGF0ZSA9IE9ULmdlbmVyYXRlU2ltcGxlU3RhdGVNYWNoaW5lKGluaXRpYWxTdGF0ZSwgdmFsaWRTdGF0ZXMsIHZhbGlkVHJhbnNpdGlvbnMpOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KE9ULlN1YnNjcmliaW5nU3RhdGUucHJvdG90eXBlLCAnYXR0ZW1wdGluZ1RvU3Vic2NyaWJlJywgewogIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBbICdJbml0JywgJ0Nvbm5lY3RpbmdUb1BlZXInLCAnQmluZGluZ1JlbW90ZVN0cmVhbScgXS5pbmRleE9mKHRoaXMuY3VycmVudCkgIT09IC0xOyB9Cn0pOwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTW9kZWxzIGEgUHVibGlzaGVyJ3MgcHVibGlzaGluZyBTdGF0ZQovLwovLyBWYWxpZCBTdGF0ZXM6Ci8vICAgIE5vdFB1Ymxpc2hpbmcKLy8gICAgR2V0VXNlck1lZGlhCi8vICAgIEJpbmRpbmdNZWRpYQovLyAgICBNZWRpYUJvdW5kCi8vICAgIFB1Ymxpc2hpbmdUb1Nlc3Npb24KLy8gICAgUHVibGlzaGluZwovLyAgICBGYWlsZWQKLy8KLy8KLy8gVmFsaWQgVHJhbnNpdGlvbnM6Ci8vICAgIE5vdFB1Ymxpc2hpbmcgLT4KLy8gICAgICAgIEdldFVzZXJNZWRpYQovLwovLyAgICBHZXRVc2VyTWVkaWEgLT4KLy8gICAgICAgIEJpbmRpbmdNZWRpYQovLyAgICAgIHwgRmFpbGVkICAgICAgICAgICAgICAgICAgICAgIChGYWlsdXJlIFJlYXNvbnMgLT4gc3RyZWFtIGVycm9yLCBjb25zdHJhaW50cywgcGVybWlzc2lvbiBkZW5pZWQKLy8gICAgICB8IE5vdFB1Ymxpc2hpbmcgICAgICAgICAgICAgICAoZGVzdHJveSgpCi8vCi8vCi8vICAgIEJpbmRpbmdNZWRpYSAtPgovLyAgICAgICAgTWVkaWFCb3VuZAovLyAgICAgIHwgRmFpbGVkICAgICAgICAgICAgICAgICAgICAgIChGYWlsdXJlIFJlYXNvbnMgLT4gQW55dGhpbmcgdG8gZG8gd2l0aCB0aGUgbWVkaWEgYmVpbmcgaW52YWxpZCwgdGhlIG1lZGlhIG5ldmVyIHBsYXlzCi8vICAgICAgfCBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLyAgICBNZWRpYUJvdW5kIC0+Ci8vICAgICAgICBQdWJsaXNoaW5nVG9TZXNzaW9uICAgICAgICAgKE1lZGlhQm91bmQgY291bGQgdHJhbnNpdGlvbiB0byBQdWJsaXNoaW5nVG9TZXNzaW9uIGlmIGEgc3RhbmQtYWxvbmUgcHVibGlzaCBpcyBib3VuZCB0byBhIHNlc3Npb24KLy8gICAgICB8IEZhaWxlZCAgICAgICAgICAgICAgICAgICAgICAoRmFpbHVyZSBSZWFzb25zIC0+IG1lZGlhIGlzc3VlcyB3aXRoIGEgc3RhbmQtYWxvbmUgcHVibGlzaGVyCi8vICAgICAgfCBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLyAgICBQdWJsaXNoaW5nVG9TZXNzaW9uCi8vICAgICAgICBQdWJsaXNoaW5nCi8vICAgICAgfCBGYWlsZWQgICAgICAgICAgICAgICAgICAgICAgKEZhaWx1cmUgUmVhc29ucyAtPiB0aW1lb3V0IHdoaWxlIHdhaXRpbmcgZm9yIGFjayBvZiBzdHJlYW0gcmVnaXN0ZXJlZC4gV2UgZG8gbm90IGRvIHRoaXMgcmlnaHQgbm93Ci8vICAgICAgfCBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLwovLyAgICBQdWJsaXNoaW5nIC0+Ci8vICAgICAgICBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKFVucHVibGlzaAovLyAgICAgIHwgRmFpbGVkICAgICAgICAgICAgICAgICAgICAgIChGYWlsdXJlIFJlYXNvbnMgLT4gbG9zcyBvZiBuZXR3b3JrLCBtZWRpYSBlcnJvciwgYW55dGhpbmcgdGhhdCBjYXVzZXMgKmFsbCogUGVlciBDb25uZWN0aW9ucyB0byBmYWlsIChsZXNzIHRoYW4gYWxsIGZhaWxpbmcgaXMganVzdCBhbiBlcnJvciwgYWxsIGlzIGZhaWx1cmUpCi8vICAgICAgfCBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLyAgICBGYWlsZWQgLT4gICAgICAgICAgICAgICAgICAgICAgIChUZXJtaW5hbCBzdGF0ZQovLwovLwoKCnZhciB2YWxpZFN0YXRlcyA9IFsgJ05vdFB1Ymxpc2hpbmcnLCAnR2V0VXNlck1lZGlhJywgJ0JpbmRpbmdNZWRpYScsICdNZWRpYUJvdW5kJywgJ1B1Ymxpc2hpbmdUb1Nlc3Npb24nLCAnUHVibGlzaGluZycsICdGYWlsZWQnIF0sCgogICAgdmFsaWRUcmFuc2l0aW9ucyA9IHsKICAgICAgTm90UHVibGlzaGluZzogWydOb3RQdWJsaXNoaW5nJywgJ0dldFVzZXJNZWRpYSddLAogICAgICBHZXRVc2VyTWVkaWE6IFsnQmluZGluZ01lZGlhJywgJ0ZhaWxlZCcsICdOb3RQdWJsaXNoaW5nJ10sCiAgICAgIEJpbmRpbmdNZWRpYTogWydNZWRpYUJvdW5kJywgJ0ZhaWxlZCcsICdOb3RQdWJsaXNoaW5nJ10sCiAgICAgIE1lZGlhQm91bmQ6IFsnTm90UHVibGlzaGluZycsICdQdWJsaXNoaW5nVG9TZXNzaW9uJywgJ0ZhaWxlZCddLAogICAgICBQdWJsaXNoaW5nVG9TZXNzaW9uOiBbJ05vdFB1Ymxpc2hpbmcnLCAnUHVibGlzaGluZycsICdGYWlsZWQnXSwKICAgICAgUHVibGlzaGluZzogWydOb3RQdWJsaXNoaW5nJywgJ01lZGlhQm91bmQnLCAnRmFpbGVkJ10sCiAgICAgIEZhaWxlZDogW10KICAgIH0sCgogICAgaW5pdGlhbFN0YXRlID0gJ05vdFB1Ymxpc2hpbmcnOwoKT1QuUHVibGlzaGluZ1N0YXRlID0gT1QuZ2VuZXJhdGVTaW1wbGVTdGF0ZU1hY2hpbmUoaW5pdGlhbFN0YXRlLCB2YWxpZFN0YXRlcywgdmFsaWRUcmFuc2l0aW9ucyk7CgpPYmplY3QuZGVmaW5lUHJvcGVydGllcyhPVC5QdWJsaXNoaW5nU3RhdGUucHJvdG90eXBlLCB7CiAgYXR0ZW1wdGluZ1RvUHVibGlzaDogewogICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIFsgJ0dldFVzZXJNZWRpYScsICdCaW5kaW5nTWVkaWEnLCAnTWVkaWFCb3VuZCcsICdQdWJsaXNoaW5nVG9TZXNzaW9uJyBdLmluZGV4T2YodGhpcy5jdXJyZW50KSAhPT0gLTE7IH0KICB9LAoKICBwdWJsaXNoaW5nOiB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5jdXJyZW50ID09PSAnUHVibGlzaGluZyc7IH0KICB9Cn0pOwoKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8vIFRoZSBkZWZhdWx0IGNvbnN0cmFpbnRzCnZhciBkZWZhdWx0Q29uc3RyYWludHMgPSB7CiAgICBhdWRpbzogdHJ1ZSwKICAgIHZpZGVvOiB0cnVlCn07CgovKioKICogVGhlIFB1Ymxpc2hlciBvYmplY3QgIHByb3ZpZGVzIHRoZSBtZWNoYW5pc20gdGhyb3VnaCB3aGljaCBjb250cm9sIG9mIHRoZQogKiBwdWJsaXNoZWQgc3RyZWFtIGlzIGFjY29tcGxpc2hlZC4gQ2FsbGluZyB0aGUgPGNvZGU+VEIuaW5pdFB1Ymxpc2hlcjwvY29kZT4gbWV0aG9kIG9mIGEKICogIFNlc3Npb24gb2JqZWN0IGNyZWF0ZXMgYSBQdWJsaXNoZXIgb2JqZWN0LiA8L3A+CiAqCiAqICA8cD5UaGUgZm9sbG93aW5nIGNvZGUgaW5zdGFudGlhdGVzIGEgc2Vzc2lvbiwgYW5kIHB1Ymxpc2hlcyBhbiBhdWRpby12aWRlbyBzdHJlYW0KICogIHVwb24gY29ubmVjdGlvbiB0byB0aGUgc2Vzc2lvbjogPC9wPgogKgogKiAgPHByZT4KICogIHZhciBBUElfS0VZID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqICB2YXIgc2Vzc2lvbklEID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIG93biBzZXNzaW9uIElELgogKiAgICAgICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKiAgdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKgogKiAgdmFyIHNlc3Npb24gPSBUQi5pbml0U2Vzc2lvbihzZXNzaW9uSUQpOwogKiAgc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzZXNzaW9uQ29ubmVjdGVkIiwgc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKTsKICogIHNlc3Npb24uY29ubmVjdChBUElfS0VZLCB0b2tlbik7CiAqCiAqICBmdW5jdGlvbiBzZXNzaW9uQ29ubmVjdEhhbmRsZXIoZXZlbnQpIHsKICogICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAqICAgICAgZGl2LnNldEF0dHJpYnV0ZSgnaWQnLCAncHVibGlzaGVyJyk7CiAqCiAqICAgICAgdmFyIHB1Ymxpc2hlckNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwdWJsaXNoZXJDb250YWluZXInKTsKICogICAgICAgICAgLy8gVGhpcyBleGFtcGxlIGFzc3VtZXMgdGhhdCBhIHB1Ymxpc2hlckNvbnRhaW5lciBkaXYgZXhpc3RzCiAqICAgICAgcHVibGlzaGVyQ29udGFpbmVyLmFwcGVuZENoaWxkKGRpdik7CiAqCiAqICAgICAgdmFyIHB1Ymxpc2hlclByb3BlcnRpZXMgPSB7d2lkdGg6IDQwMCwgaGVpZ2h0OjMwMCwgbmFtZToiQm9iJ3Mgc3RyZWFtIn07CiAqICAgICAgcHVibGlzaGVyID0gVEIuaW5pdFB1Ymxpc2hlcihBUElfS0VZLCAncHVibGlzaGVyJywgcHVibGlzaGVyUHJvcGVydGllcyk7CiAqICAgICAgc2Vzc2lvbi5wdWJsaXNoKHB1Ymxpc2hlcik7CiAqICB9CiAqICA8L3ByZT4KICoKICogICAgICA8cD5UaGlzIGV4YW1wbGUgY3JlYXRlcyBhIFB1Ymxpc2hlciBvYmplY3QgYW5kIGFkZHMgaXRzIHZpZGVvIHRvIGEgRE9NIGVsZW1lbnQgbmFtZWQgPGNvZGU+cHVibGlzaGVyPC9jb2RlPgogKiAgICAgIGJ5IGNhbGxpbmcgdGhlIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4gbWV0aG9kLiBJdCB0aGVuIHB1Ymxpc2hlcyBhIHN0cmVhbSB0byB0aGUgc2Vzc2lvbiBieSBjYWxsaW5nCiAqICAgICAgdGhlIDxjb2RlPnB1Ymxpc2goKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC48L3A+CiAqCiAqIEBwcm9wZXJ0eSBpZCBUaGUgRE9NIElEIG9mIHRoZSBQdWJsaXNoZXIuCiAqIEBwcm9wZXJ0eSBzdHJlYW0gVGhlIHtAbGluayBTdHJlYW19IG9iamVjdCBjb3JyZXNwb25kaW5nIHRoZSB0aGUgc3RyZWFtIG9mIHRoZSBQdWJsaWhzZXIuCiAqIEBwcm9wZXJ0eSBzZXNzaW9uIFRoZSB7QGxpbmsgU2Vzc2lvbn0gdG8gd2hpY2ggdGhlIFB1Ymxpc2hlciBiZWxvbmdzLgogKgogKiBAc2VlIDxhIGhyZWY9IlRCLmh0bWwjaW5pdFB1Ymxpc2hlciI+VEIuaW5pdFB1Ymxpc2hlcjwvYT4KICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjcHVibGlzaCI+U2Vzc2lvbi5wdWJsaXNoKCk8L2E+CiAqCiAqIEBjbGFzcyBQdWJsaXNoZXIKICogQGF1Z21lbnRzIEV2ZW50RGlzcGF0Y2hlcgogKi8KT1QuUHVibGlzaGVyID0gZnVuY3Rpb24oKSB7CiAgICAvLyBDaGVjayB0aGF0IHRoZSBjbGllbnQgbWVldHMgdGhlIG1pbmltdW0gcmVxdWlyZW1lbnRzLCBpZiB0aGV5IGRvbid0IHRoZSB1cGdyYWRlCiAgICAvLyBmbG93IHdpbGwgYmUgdHJpZ2dlcmVkLgogICAgaWYgKCFPVC5jaGVja1N5c3RlbVJlcXVpcmVtZW50cygpKSB7CiAgICAgICAgT1QudXBncmFkZVN5c3RlbVJlcXVpcmVtZW50cygpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgX2d1aWQgPSBPVC5QdWJsaXNoZXIubmV4dElkKCksCiAgICAgICAgX2RvbUlkLAogICAgICAgIF9jb250YWluZXIsCiAgICAgICAgX3RhcmdldEVsZW1lbnQsCiAgICAgICAgX3N0cmVhbSwKICAgICAgICBfd2ViUlRDU3RyZWFtLAogICAgICAgIF9zZXNzaW9uLAogICAgICAgIF9wZWVyQ29ubmVjdGlvbnMgPSB7fSwKICAgICAgICBfbG9hZGVkID0gZmFsc2UsCiAgICAgICAgX3B1Ymxpc2hQcm9wZXJ0aWVzLAogICAgICAgIF9wdWJsaXNoU3RhcnRUaW1lLAogICAgICAgIF9taWNyb3Bob25lLAogICAgICAgIF9jaHJvbWUsCiAgICAgICAgX2FuYWx5dGljcyA9IG5ldyBPVC5BbmFseXRpY3MoKSwKICAgICAgICBfdmFsaWRSZXNvbHV0aW9ucyA9IFsKICAgICAgICAgICAge3dpZHRoOiAzMjAsIGhlaWdodDogMjQwfSwKICAgICAgICAgICAge3dpZHRoOiA2NDAsIGhlaWdodDogNDgwfSwKICAgICAgICAgICAge3dpZHRoOiAxMjgwLCBoZWlnaHQ6IDcyMH0KICAgICAgICBdLAogICAgICAgIF9xb3NJbnRlcnZhbHMgPSB7fSwKICAgICAgICBfZ2V0dGluZ1N0YXRzID0gMCwKICAgICAgICBfcHJldlN0YXRzID0gewogICAgICAgICAgICAidGltZVN0YW1wIiA6IE9ULiQubm93KCkKICAgICAgICB9LAogICAgICAgIF9zdGF0ZTsKCiAgICBPVC4kLmV2ZW50aW5nKHRoaXMpOwoKICAgIE9ULlN0eWxhYmxlQ29tcG9uZW50KHRoaXMsIHsKICAgICAgICBzaG93TWljQnV0dG9uOiB0cnVlLAogICAgICAgIHNob3dTZXR0aW5nc0J1dHRvbjogdHJ1ZSwKICAgICAgICBzaG93Q2FtZXJhVG9nZ2xlQnV0dG9uOiB0cnVlLAogICAgICAgIG5hbWVEaXNwbGF5TW9kZTogImF1dG8iLAogICAgICAgIGJ1dHRvbkRpc3BsYXlNb2RlOiAiYXV0byIsCiAgICAgICAgYmFja2dyb3VuZEltYWdlVVJJOiBudWxsCiAgICB9KTsKCiAgICAgICAgLy8vIFByaXZhdGUgTWV0aG9kcwogICAgdmFyIGxvZ0FuYWx5dGljc0V2ZW50ID0gZnVuY3Rpb24oYWN0aW9uLCB2YXJpYXRpb24sIHBheWxvYWRUeXBlLCBwYXlsb2FkKSB7CiAgICAgICAgICAgIF9hbmFseXRpY3MubG9nRXZlbnQoewogICAgICAgICAgICAgICAgYWN0aW9uOiBhY3Rpb24sCiAgICAgICAgICAgICAgICB2YXJpYXRpb246IHZhcmlhdGlvbiwKICAgICAgICAgICAgICAgIHBheWxvYWRfdHlwZTogcGF5bG9hZFR5cGUsCiAgICAgICAgICAgICAgICBwYXlsb2FkOiBwYXlsb2FkLAogICAgICAgICAgICAgICAgc2Vzc2lvbl9pZDogX3Nlc3Npb24gPyBfc2Vzc2lvbi5zZXNzaW9uSWQgOiBudWxsLAogICAgICAgICAgICAgICAgY29ubmVjdGlvbl9pZDogX3Nlc3Npb24gJiYgX3Nlc3Npb24uY29ubmVjdGVkID8gX3Nlc3Npb24uY29ubmVjdGlvbi5jb25uZWN0aW9uSWQgOiBudWxsLAogICAgICAgICAgICAgICAgcGFydG5lcl9pZDogX3Nlc3Npb24gPyBfc2Vzc2lvbi5hcGlLZXkgOiBPVC5BUElLRVksCiAgICAgICAgICAgICAgICBzdHJlYW1JZDogX3N0cmVhbSA/IF9zdHJlYW0uaWQgOiBudWxsLAogICAgICAgICAgICAgICAgd2lkZ2V0X2lkOiBfZ3VpZCwKICAgICAgICAgICAgICAgIHdpZGdldF90eXBlOiAnUHVibGlzaGVyJwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBpc1ZhbGlkUmVzb2x1dGlvbiA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaT0wOyBpPF92YWxpZFJlc29sdXRpb25zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBpZiAoX3ZhbGlkUmVzb2x1dGlvbnNbaV0ud2lkdGggPT0gd2lkdGggJiYgX3ZhbGlkUmVzb2x1dGlvbnNbaV0uaGVpZ2h0ID09IGhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICByZWNvcmRRT1MgPSBmdW5jdGlvbihjb25uZWN0aW9uX2lkKSB7CiAgICAgICAgICAgIHZhciBRb1NfYmxvYiA9IHsKICAgICAgICAgICAgICAgIHdpZGdldF90eXBlOiAnUHVibGlzaGVyJywKICAgICAgICAgICAgICAgIHN0cmVhbV90eXBlIDogJ1dlYlJUQycsCiAgICAgICAgICAgICAgICBzZXNzaW9uSWQ6IF9zZXNzaW9uID8gX3Nlc3Npb24uc2Vzc2lvbklkIDogbnVsbCwKICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25JZDogX3Nlc3Npb24gJiYgX3Nlc3Npb24uY29ubmVjdGVkID8gX3Nlc3Npb24uY29ubmVjdGlvbi5jb25uZWN0aW9uSWQgOiBudWxsLAogICAgICAgICAgICAgICAgcGFydG5lcklkOiBfc2Vzc2lvbiA/IF9zZXNzaW9uLmFwaUtleSA6IE9ULkFQSUtFWSwKICAgICAgICAgICAgICAgIHN0cmVhbUlkOiBfc3RyZWFtID8gX3N0cmVhbS5pZCA6IG51bGwsCiAgICAgICAgICAgICAgICB3aWRnZXRJZDogX2d1aWQsCiAgICAgICAgICAgICAgICB2ZXJzaW9uOiBPVC5wcm9wZXJ0aWVzLnZlcnNpb24sCiAgICAgICAgICAgICAgICBtZWRpYV9zZXJ2ZXJfbmFtZTogX3Nlc3Npb24gPyBfc2Vzc2lvbi5zZXNzaW9uSW5mby5tZXNzYWdpbmdTZXJ2ZXIgOiBudWxsLAogICAgICAgICAgICAgICAgcDJwRmxhZzogX3Nlc3Npb24gPyBfc2Vzc2lvbi5zZXNzaW9uSW5mby5wMnBFbmFibGVkIDogZmFsc2UsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogbmV3IERhdGUoKS5nZXRUaW1lKCkgLV9wdWJsaXNoU3RhcnRUaW1lLmdldFRpbWUoKSwKICAgICAgICAgICAgICAgIHJlbW90ZV9jb25uZWN0aW9uX2lkOiBjb25uZWN0aW9uX2lkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBnZXQgc3RhdHMgZm9yIGVhY2ggY29ubmVjdGlvbiBpZAogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb25zW2Nvbm5lY3Rpb25faWRdLmdldFN0YXRzKF9wcmV2U3RhdHMsIGZ1bmN0aW9uKHN0YXRzKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhdHMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHN0YXRfaW5kZXggaW4gc3RhdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgUW9TX2Jsb2Jbc3RhdF9pbmRleF0gPSBzdGF0c1tzdGF0X2luZGV4XTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfYW5hbHl0aWNzLmxvZ1FPUyhRb1NfYmxvYik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8vLyBQcml2YXRlIEV2ZW50cwoKICAgICAgICBzdGF0ZUNoYW5nZUZhaWxlZCA9IGZ1bmN0aW9uKGNoYW5nZUZhaWxlZCkgewogICAgICAgICAgICBPVC5lcnJvcigiUHVibGlzaGVyIFN0YXRlIENoYW5nZSBGYWlsZWQ6ICIsIGNoYW5nZUZhaWxlZC5tZXNzYWdlKTsKICAgICAgICAgICAgT1QuZGVidWcoY2hhbmdlRmFpbGVkKTsKICAgICAgICB9LAoKICAgICAgICBvbkxvYWRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBPVC5kZWJ1ZygiT1QuUHVibGlzaGVyLm9uTG9hZGVkIik7CiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdwdWJsaXNoJywgJ1N1Y2Nlc3MnLCAnc3RyZWFtVHlwZScsICdXZWJSVEMnKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ01lZGlhQm91bmQnKTsKICAgICAgICAgICAgX2NvbnRhaW5lci5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIF9sb2FkZWQgPSB0cnVlOwoKICAgICAgICAgICAgX2NyZWF0ZUNocm9tZS5jYWxsKHRoaXMpOwoKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdpbml0U3VjY2VzcycsIHRoaXMpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2xvYWRlZCcsIHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIG9uTG9hZEZhaWx1cmUgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3B1Ymxpc2gnLCAnRmFpbHVyZScsICdyZWFzb24nLCAiUHVibGlzaGVyIFBlZXJDb25uZWN0aW9uIEVycm9yOiAiICsgcmVhc29uKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3B1Ymxpc2hFcnJvcicsICJQdWJsaXNoZXIgUGVlckNvbm5lY3Rpb24gRXJyb3I6ICIgKyByZWFzb24pOwoKICAgICAgICAgICAgT1QuaGFuZGxlSnNFeGNlcHRpb24oIlB1Ymxpc2hlciBQZWVyQ29ubmVjdGlvbiBFcnJvcjogIiArIHJlYXNvbiwgT1QuRXhjZXB0aW9uQ29kZXMuUDJQX0NPTk5FQ1RJT05fRkFJTEVELCB7CiAgICAgICAgICAgICAgICBzZXNzaW9uOiBfc2Vzc2lvbiwKICAgICAgICAgICAgICAgIHRhcmdldDogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBvblN0cmVhbUF2YWlsYWJsZSA9IGZ1bmN0aW9uKHdlYk9UU3RyZWFtKSB7CiAgICAgICAgICAgIE9ULmRlYnVnKCJPVC5QdWJsaXNoZXIub25TdHJlYW1BdmFpbGFibGUiKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0JpbmRpbmdNZWRpYScpOwoKICAgICAgICAgICAgY2xlYW51cExvY2FsU3RyZWFtKCk7CiAgICAgICAgICAgIF93ZWJSVENTdHJlYW0gPSB3ZWJPVFN0cmVhbTsKCiAgICAgICAgICAgIF9taWNyb3Bob25lID0gbmV3IE9ULk1pY3JvcGhvbmUoX3dlYlJUQ1N0cmVhbSwgIV9wdWJsaXNoUHJvcGVydGllcy5wdWJsaXNoQXVkaW8pOwogICAgICAgICAgICB0aGlzLnB1Ymxpc2hWaWRlbyhfcHVibGlzaFByb3BlcnRpZXMucHVibGlzaFZpZGVvKTsKCiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCgKICAgICAgICAgICAgICAgIG5ldyBPVC5FdmVudChPVC5FdmVudC5uYW1lcy5BQ0NFU1NfQUxMT1dFRCwgZmFsc2UpCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBfdGFyZ2V0RWxlbWVudCA9IG5ldyBPVC5WaWRlb0VsZW1lbnQoewogICAgICAgICAgICAgICAgYXR0cmlidXRlczoge211dGVkOnRydWV9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3RhcmdldEVsZW1lbnQub24oewogICAgICAgICAgICAgICAgICAgIHN0cmVhbUJvdW5kOiBvbkxvYWRlZCwKICAgICAgICAgICAgICAgICAgICBsb2FkRXJyb3I6IG9uTG9hZEZhaWx1cmUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IG9uVmlkZW9FcnJvcgogICAgICAgICAgICAgICAgfSwgdGhpcykKICAgICAgICAgICAgICAgIC5iaW5kVG9TdHJlYW0oX3dlYlJUQ1N0cmVhbSk7CgogICAgICAgICAgICBfY29udGFpbmVyLnZpZGVvID0gX3RhcmdldEVsZW1lbnQ7CiAgICAgICAgfSwKCiAgICAgICAgb25TdHJlYW1BdmFpbGFibGVFcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgIE9ULmVycm9yKCdPVC5QdWJsaXNoZXIub25TdHJlYW1BdmFpbGFibGVFcnJvciAnICsgZXJyb3IubmFtZSArICc6ICcgKyBlcnJvci5tZXNzYWdlKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3B1Ymxpc2hFcnJvcicsIGVycm9yLm1lc3NhZ2UpOwoKICAgICAgICAgICAgaWYgKF9jb250YWluZXIpIF9jb250YWluZXIuZGVzdHJveSgpOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3B1Ymxpc2gnLCAnRmFpbHVyZScsICdyZWFzb24nLCAiUHVibGlzaGVyIGZhaWxlZCB0byBhY2Nlc3MgY2FtZXJhL21pYzogIiArIGVycm9yLm1lc3NhZ2UpOwoKICAgICAgICAgICAgT1QuaGFuZGxlSnNFeGNlcHRpb24oIlB1Ymxpc2hlciBmYWlsZWQgdG8gYWNjZXNzIGNhbWVyYS9taWM6ICIgKyBlcnJvci5tZXNzYWdlLCAyMDAwLCB7CiAgICAgICAgICAgICAgICBzZXNzaW9uOiBfc2Vzc2lvbiwKICAgICAgICAgICAgICAgIHRhcmdldDogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgdXNlciBoYXMgY2xpY2tlZCB0aGUgJ2RlbnknIGJ1dHRvbiB0aGUgdGhlIGFsbG93IGFjY2VzcyBkaWFsb2cgKG9yIGl0J3Mgc2V0IHRvIGFsd2F5cyBkZW55KQogICAgICAgIG9uQWNjZXNzRGVuaWVkID0gZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgT1QuZXJyb3IoJ09ULlB1Ymxpc2hlci5vblN0cmVhbUF2YWlsYWJsZUVycm9yIFBlcm1pc3Npb24gRGVuaWVkJyk7CgogICAgICAgICAgICBfc3RhdGUuc2V0KCdGYWlsZWQnKTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdwdWJsaXNoRXJyb3InLCBlcnJvci5tZXNzYWdlKTsKCiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdwdWJsaXNoJywgJ0ZhaWx1cmUnLCAncmVhc29uJywgJ1B1Ymxpc2hlciBBY2Nlc3MgRGVuaWVkOiBQZXJtaXNzaW9uIERlbmllZCcpOwoKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IE9ULkV2ZW50KE9ULkV2ZW50Lm5hbWVzLkFDQ0VTU19ERU5JRUQpLAogICAgICAgICAgICAgICAgZGVmYXVsdEFjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgJiYgX2NvbnRhaW5lcikgX2NvbnRhaW5lci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50LCBkZWZhdWx0QWN0aW9uKTsKICAgICAgICB9LAoKICAgICAgICBvbkFjY2Vzc0RpYWxvZ09wZW5lZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgnYWNjZXNzRGlhbG9nJywgJ09wZW5lZCcsICcnLCAnJyk7CgogICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoCiAgICAgICAgICAgICAgICBuZXcgT1QuRXZlbnQoT1QuRXZlbnQubmFtZXMuQUNDRVNTX0RJQUxPR19PUEVORUQsIGZhbHNlKQogICAgICAgICAgICApOwogICAgICAgIH0sCgogICAgICAgIG9uQWNjZXNzRGlhbG9nQ2xvc2VkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdhY2Nlc3NEaWFsb2cnLCAnQ2xvc2VkJywgJycsICcnKTsKCiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCgKICAgICAgICAgICAgICAgIG5ldyBPVC5FdmVudChPVC5FdmVudC5uYW1lcy5BQ0NFU1NfRElBTE9HX0NMT1NFRCwgZmFsc2UpCiAgICAgICAgICAgICk7CiAgICAgICAgfSwKCiAgICAgICAgb25WaWRlb0Vycm9yID0gZnVuY3Rpb24oZXJyb3JDb2RlLCBlcnJvclJlYXNvbikgewogICAgICAgICAgICBPVC5lcnJvcignT1QuUHVibGlzaGVyLm9uVmlkZW9FcnJvcicpOwoKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBlcnJvclJlYXNvbiArIChlcnJvckNvZGUgPyAnICgnICsgZXJyb3JDb2RlICsgJyknIDogJycpOwogICAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgnc3RyZWFtJywgbnVsbCwgJ3JlYXNvbicsICJQdWJsaXNoZXIgd2hpbGUgcGxheWluZyBzdHJlYW06ICIgKyBtZXNzYWdlKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwoKICAgICAgICAgICAgaWYgKF9zdGF0ZS5hdHRlbXB0aW5nVG9QdWJsaXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3B1Ymxpc2hFcnJvcicsIG1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG1lc3NhZ2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBPVC5oYW5kbGVKc0V4Y2VwdGlvbigiUHVibGlzaGVyIGVycm9yIHBsYXlpbmcgc3RyZWFtOiAiICsgbWVzc2FnZSwgMjAwMCwgewogICAgICAgICAgICAgICAgc2Vzc2lvbjogX3Nlc3Npb24sCiAgICAgICAgICAgICAgICB0YXJnZXQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgb25QZWVyRGlzY29ubmVjdGVkID0gZnVuY3Rpb24ocGVlckNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgT1QuZGVidWcoIk9ULlN1YnNjcmliZXIgaGFzIGJlZW4gZGlzY29ubmVjdGVkIGZyb20gdGhlIFB1Ymxpc2hlcidzIFBlZXJDb25uZWN0aW9uIik7CgogICAgICAgICAgICB0aGlzLmNsZWFudXBTdWJzY3JpYmVyKHBlZXJDb25uZWN0aW9uLnJlbW90ZUNvbm5lY3Rpb24uaWQpOwogICAgICAgIH0sCgogICAgICAgIG9uUGVlckNvbm5lY3Rpb25GYWlsdXJlID0gZnVuY3Rpb24oY29kZSwgcmVhc29uLCBwZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgncHVibGlzaCcsICdGYWlsdXJlJywgJ3JlYXNvbnxoYXNSZWxheUNhbmRpZGF0ZXMnLCBbCiAgICAgICAgICAgICAgICAiUHVibGlzaGVyIFBlZXJDb25uZWN0aW9uIHdpdGggY29ubmVjdGlvbiAiICsgcGVlckNvbm5lY3Rpb24ucmVtb3RlQ29ubmVjdGlvbi5pZCAgKyAiIGZhaWxlZDogIiArIHJlYXNvbiwKICAgICAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmhhc1JlbGF5Q2FuZGlkYXRlcwogICAgICAgICAgICAgICAgXS5qb2luKCd8JykpOwoKICAgICAgICAgICAgT1QuaGFuZGxlSnNFeGNlcHRpb24oIlB1Ymxpc2hlciBQZWVyQ29ubmVjdGlvbiBFcnJvcjogIiArIHJlYXNvbiwgMjAwMCwgewogICAgICAgICAgICAgICAgc2Vzc2lvbjogX3Nlc3Npb24sCiAgICAgICAgICAgICAgICB0YXJnZXQ6IHRoaXMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBXZSBkb24ndCBjYWxsIGNsZWFudXBTdWJzY3JpYmVyIGFzIGl0IGFsc28gbG9ncyBhCiAgICAgICAgICAgIC8vIGRpc2Nvbm5lY3RlZCBhbmFseXRpY3MgZXZlbnQsIHdoaWNoIHdlIGRvbid0IHdhbnQgaW4gdGhpcwogICAgICAgICAgICAvLyBpbnN0YW5jZS4gVGhlIGR1cGxpY2F0aW9uIGlzIGNydWZ0eSB0aG91Z2ggYW5kIHNob3VsZAogICAgICAgICAgICAvLyBiZSB0aWRpZWQgdXAuCiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoX3Fvc0ludGVydmFsc1twZWVyQ29ubmVjdGlvbi5yZW1vdGVDb25uZWN0aW9uLmlkXSk7CiAgICAgICAgICAgIGRlbGV0ZSBfcW9zSW50ZXJ2YWxzW3BlZXJDb25uZWN0aW9uLnJlbW90ZUNvbm5lY3Rpb24uaWRdCgogICAgICAgICAgICBkZWxldGUgX3BlZXJDb25uZWN0aW9uc1twZWVyQ29ubmVjdGlvbi5yZW1vdGVDb25uZWN0aW9uLmlkXTsKICAgICAgICB9LAoKICAgICAgICBnZXRTdGF0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChfZ2V0dGluZ1N0YXRzID4gMCkgewogICAgICAgICAgICAgICAgT1QuZGVidWcoIlN0aWxsIGdldHRpbmcgc3RhdHMiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGdldFN0YXRzQmxvYiA9IHt9OwoKICAgICAgICAgICAgLy8gbG9vcHMgdGhyb3VnaCBhbGwgdGhlIHBlZXIgY29ubmVjdGlvbnMgZ2V0IGdldCB0aGUgc3RhdHMgZm9yIHRoZW0KICAgICAgICAgICAgZm9yICh2YXIgY29ubl9pZCBpbiBfcGVlckNvbm5lY3Rpb25zKSB7CgogICAgICAgICAgICAgICAgLy8gdGhpcyBsb2NrcyB0aGUgZ2V0U3RhdHMgZnVuY3Rpb24gc28gaXQgaXNuJ3QgYWNjaWRlbnRhbGx5IGNhbGxlZAogICAgICAgICAgICAgICAgLy8gYWdhaW4gd2hpbGUgYWxyZWFkeSBpbiB0aGUgbWlkZGxlIG9mIGdldHRpbmcgc3RhdHMKICAgICAgICAgICAgICAgIF9nZXR0aW5nU3RhdHMrKzsKCiAgICAgICAgICAgICAgICBnZXRTdGF0c0Jsb2JbY29ubl9pZF0gPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIGp1c3Qgc28gd2UgZG9uJ3QgbG9zZSB0aGUgY29ubmVjdGlvbiBpZAogICAgICAgICAgICAgICAgKGZ1bmN0aW9uKGNvbm5lY3Rpb25faWQpIHsKICAgICAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb25zW2Nvbm5lY3Rpb25faWRdLmdldFN0YXRzKGZ1bmN0aW9uKHBhcnNlZF9zdGF0cykgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb25lIGRvd24KICAgICAgICAgICAgICAgICAgICAgICAgX2dldHRpbmdTdGF0cy0tOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlZF9zdGF0cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0U3RhdHNCbG9iW2Nvbm5lY3Rpb25faWRdID0gcGFyc2VkX3N0YXRzOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGlzIHJlYWNoZXMgemVybywgdGhhdCBtZWFucyBhbGwgb2YgdGhlIHBlZXIgY29ubmVjdGlvbnMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGF2ZSByZXR1cm5lZCB0aGVpciBzdGF0cyByZXBvcnRzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZ2V0dGluZ1N0YXRzID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGdldFN0YXRzQmxvYik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pKGNvbm5faWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8vIFByaXZhdGUgSGVscGVycwoKICAgICAgICAvLyBDbGVhbiB1cCBvdXIgTG9jYWxNZWRpYVN0cmVhbQogICAgICAgIGNsZWFudXBMb2NhbFN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoX3dlYlJUQ1N0cmVhbSkgewogICAgICAgICAgICAgICAgLy8gU3RvcCByZXZva2VzIG91ciBhY2Nlc3MgY2FtIGFuZCBtaWMgYWNjZXNzIGZvciB0aGlzIGluc3RhbmNlCiAgICAgICAgICAgICAgICAvLyBvZiBsb2NhbE1lZGlhU3RyZWFtLgogICAgICAgICAgICAgICAgX3dlYlJUQ1N0cmVhbS5zdG9wKCk7CiAgICAgICAgICAgICAgICBfd2ViUlRDU3RyZWFtID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGNyZWF0ZVBlZXJDb25uZWN0aW9uRm9yUmVtb3RlID0gZnVuY3Rpb24ocmVtb3RlQ29ubmVjdGlvbikgewogICAgICAgICAgICB2YXIgcGVlckNvbm5lY3Rpb24gPSBfcGVlckNvbm5lY3Rpb25zW3JlbW90ZUNvbm5lY3Rpb24uaWRdOwoKICAgICAgICAgICAgaWYgKCFwZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0Q29ubmVjdGluZ1RpbWUgPSBPVC4kLm5vdygpOwoKICAgICAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdjcmVhdGVQZWVyQ29ubmVjdGlvbicsICdBdHRlbXB0JywgJycsICcnKTsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbnVwIG91ciBzdWJzY3JpYmVyIHdoZW4gdGhleSBkaXNjb25uZWN0CiAgICAgICAgICAgICAgICByZW1vdGVDb25uZWN0aW9uLm9uKCdkZXN0cm95ZWQnLCB0aGlzLmNsZWFudXBTdWJzY3JpYmVyLmJpbmQodGhpcywgcmVtb3RlQ29ubmVjdGlvbi5pZCkpOwoKICAgICAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uID0gX3BlZXJDb25uZWN0aW9uc1tyZW1vdGVDb25uZWN0aW9uLmlkXSA9IG5ldyBPVC5QdWJsaXNoZXJQZWVyQ29ubmVjdGlvbigKICAgICAgICAgICAgICAgICAgICByZW1vdGVDb25uZWN0aW9uLAogICAgICAgICAgICAgICAgICAgIF9zZXNzaW9uLAogICAgICAgICAgICAgICAgICAgIF9zdHJlYW0sCiAgICAgICAgICAgICAgICAgICAgX3dlYlJUQ1N0cmVhbQogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5vbih7CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2NyZWF0ZVBlZXJDb25uZWN0aW9uJywgJ1N1Y2Nlc3MnLCAncGNjfGhhc1JlbGF5Q2FuZGlkYXRlcycsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlSW50KE9ULiQubm93KCkgLSBzdGFydENvbm5lY3RpbmdUaW1lLCAxMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5oYXNSZWxheUNhbmRpZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgXS5qb2luKCd8JykpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RhcnQgcmVjb3JkaW5nIHRoZSBRb1MgZm9yIHRoaXMgcGVlciBjb25uZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF9xb3NJbnRlcnZhbHNbcmVtb3RlQ29ubmVjdGlvbi5pZF0gPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZFFPUyhyZW1vdGVDb25uZWN0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgICB9LCAzMDAwMCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBkaXNjb25uZWN0ZWQ6IG9uUGVlckRpc2Nvbm5lY3RlZCwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogb25QZWVyQ29ubmVjdGlvbkZhaWx1cmUKICAgICAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmluaXQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHBlZXJDb25uZWN0aW9uOwogICAgICAgIH0sCgogICAgICAgIC8vLyBDaHJvbWUKCiAgICAgICAgLy8gSWYgbW9kZSBpcyBmYWxzZSwgdGhlbiB0aGF0IGlzIHRoZSBtb2RlLiBJZiBtb2RlIGlzIHRydWUgdGhlbiB3ZSdsbAogICAgICAgIC8vIGRlZmluaXRlbHkgZGlzcGxheSAgdGhlIGJ1dHRvbiwgYnV0IHdlJ2xsIGRlZmVyIHRoZSBtb2RlbCB0byB0aGUKICAgICAgICAvLyBQdWJsaXNoZXJzIGJ1dHRvbkRpc3BsYXlNb2RlIHN0eWxlIHByb3BlcnR5LgogICAgICAgIGNocm9tZUJ1dHRvbk1vZGUgPSBmdW5jdGlvbihtb2RlKSB7CiAgICAgICAgICAgIGlmIChtb2RlID09PSBmYWxzZSkgcmV0dXJuICdvZmYnOwoKICAgICAgICAgICAgdmFyIGRlZmF1bHRNb2RlID0gdGhpcy5nZXRTdHlsZSgnYnV0dG9uRGlzcGxheU1vZGUnKTsKCiAgICAgICAgICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGlzIGZhbHNlLCBidXQgaXQncyBvdmVycmlkZGVuIGJ5ICttb2RlKyBiZWluZyB0cnVlCiAgICAgICAgICAgIGlmIChkZWZhdWx0TW9kZSA9PT0gZmFsc2UpIHJldHVybiAnb24nOwoKICAgICAgICAgICAgLy8gZGVmYXVsdE1vZGUgaXMgZWl0aGVyIHRydWUgb3IgYXV0by4KICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRNb2RlOwogICAgICAgIH0sCgogICAgICAgIHVwZGF0ZUNocm9tZUZvclN0eWxlQ2hhbmdlID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFfY2hyb21lKSByZXR1cm47CgogICAgICAgICAgICBzd2l0Y2goa2V5KSB7CiAgICAgICAgICAgICAgICBjYXNlICduYW1lRGlzcGxheU1vZGUnOgogICAgICAgICAgICAgICAgICAgIF9jaHJvbWUubmFtZS5zZXREaXNwbGF5TW9kZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnYnV0dG9uRGlzcGxheU1vZGUnOgogICAgICAgICAgICAgICAgY2FzZSAnc2hvd01pY0J1dHRvbic6CiAgICAgICAgICAgICAgICBjYXNlICdzaG93U2V0dGluZ3NCdXR0b24nOgogICAgICAgICAgICAgICAgICAgIC8vIF9jaHJvbWUuc2V0dGluZ3NQYW5lbEJ1dHRvbi5zZXREaXNwbGF5TW9kZSgKICAgICAgICAgICAgICAgICAgICAvLyAgICAgY2hyb21lQnV0dG9uTW9kZS5jYWxsKHRoaXMsIHRoaXMuZ2V0U3R5bGUoJ3Nob3dTZXR0aW5nc0J1dHRvbicpKQogICAgICAgICAgICAgICAgICAgIC8vICk7CgogICAgICAgICAgICAgICAgICAgIC8vIF9jaHJvbWUubXV0ZUJ1dHRvbi5zZXREaXNwbGF5TW9kZSgKICAgICAgICAgICAgICAgICAgICAvLyAgICAgY2hyb21lQnV0dG9uTW9kZS5jYWxsKHRoaXMsIHRoaXMuZ2V0U3R5bGUoJ3Nob3dNaWNCdXR0b24nKSkKICAgICAgICAgICAgICAgICAgICAvLyApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NyZWF0ZUNocm9tZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBfY2hyb21lID0gbmV3IE9ULkNocm9tZSh7CiAgICAgICAgICAgICAgICBwYXJlbnQ6IF9jb250YWluZXIuZG9tRWxlbWVudAogICAgICAgICAgICB9KS5zZXQoewogICAgICAgICAgICAgICAgbmFtZTogbmV3IE9ULkNocm9tZS5OYW1lUGFuZWwoewogICAgICAgICAgICAgICAgICAgIG5hbWU6IF9wdWJsaXNoUHJvcGVydGllcy5uYW1lLAogICAgICAgICAgICAgICAgICAgIG1vZGU6IHRoaXMuZ2V0U3R5bGUoJ25hbWVEaXNwbGF5TW9kZScpCiAgICAgICAgICAgICAgICB9KSwKCiAgICAgICAgICAgICAgICAvLyBzZXR0aW5nc1BhbmVsQnV0dG9uOiBuZXcgT1QuQ2hyb21lLlNldHRpbmdzUGFuZWxCdXR0b24oewogICAgICAgICAgICAgICAgLy8gICAgIG1vZGU6IGNocm9tZUJ1dHRvbk1vZGUuY2FsbCh0aGlzLCB0aGlzLmdldFN0eWxlKCdzaG93U2V0dGluZ3NCdXR0b24nKSkKICAgICAgICAgICAgICAgIC8vIH0pLAoKICAgICAgICAgICAgICAgIC8vIERpc2FibGVkIHVudGlsIHdlIGNhbiBjaGFuZ2UgdGhlIG1pYyBWb2x1bWUgdGhyb3VnaCBXZWJSVEMKICAgICAgICAgICAgICAgIG11dGVCdXR0b246IG5ldyBPVC5DaHJvbWUuTXV0ZUJ1dHRvbih7CiAgICAgICAgICAgICAgICAgICAgbXV0ZWQ6IF9wdWJsaXNoUHJvcGVydGllcy5wdWJsaXNoQXVkaW8gPT09IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIG1vZGU6IGNocm9tZUJ1dHRvbk1vZGUuY2FsbCh0aGlzLCB0aGlzLmdldFN0eWxlKCdzaG93TWljQnV0dG9uJykpCiAgICAgICAgICAgICAgICB9KSwKCiAgICAgICAgICAgICAgICBvcGVudG9rQnV0dG9uOiBuZXcgT1QuQ2hyb21lLk9wZW5Ub2tCdXR0b24oKQogICAgICAgICAgICB9KS5vbih7CiAgICAgICAgICAgICAgICAvLyAnU2V0dGluZ3NQYW5lbDpvcGVuJzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyAgICAgaWYgKCFfY2hyb21lLnNldHRpbmdzUGFuZWwpIHsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgLy8gQWRkIHRoZSBzZXR0aW5ncyBwYW5lbCwgaGlkZSBpdCBpbml0aWFsbHkKICAgICAgICAgICAgICAgIC8vICAgICAgICAgX2Nocm9tZS5zZXQoCiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAnc2V0dGluZ3NQYW5lbCcsCiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICBuZXcgT1QuQ2hyb21lLlNldHRpbmdzUGFuZWwoewogICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgIHN0cmVhbTogX3dlYlJUQ1N0cmVhbSwKICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICBtb2RlOiAnb24nCiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLy8gICAgICAgICApOwogICAgICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgICAgIC8vICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgX2Nocm9tZS5zZXR0aW5nc1BhbmVsLnNldERpc3BsYXlNb2RlKCdvbicpOwogICAgICAgICAgICAgICAgLy8gICAgIH0KCiAgICAgICAgICAgICAgICAvLyAgICAgT1QuJC5hZGRDbGFzcyhfY29udGFpbmVyLCAnT1RfcmV2ZXJzZWQnKTsKICAgICAgICAgICAgICAgIC8vIH0sCgogICAgICAgICAgICAgICAgLy8gJ1NldHRpbmdzUGFuZWw6Y2xvc2UnOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vICAgICBPVC4kLnJlbW92ZUNsYXNzKF9jb250YWluZXIsICdPVF9yZXZlcnNlZCcpOwoKICAgICAgICAgICAgICAgIC8vICAgICAvLyBIaWRlIHRoZSBzZXR0aW5ncyBwYW5lbCBhZnRlciBvdXIgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgICAgICAgICAvLyAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgX2Nocm9tZS5zZXR0aW5nc1BhbmVsLnNldERpc3BsYXlNb2RlKCdvZmYnKTsKICAgICAgICAgICAgICAgIC8vICAgICB9LCAzMDAwKTsKICAgICAgICAgICAgICAgIC8vIH0sCgoKICAgICAgICAgICAgICAgIG11dGVkOiB0aGlzLnB1Ymxpc2hBdWRpby5iaW5kKHRoaXMsIGZhbHNlKSwKICAgICAgICAgICAgICAgIHVubXV0ZWQ6IHRoaXMucHVibGlzaEF1ZGlvLmJpbmQodGhpcywgdHJ1ZSkKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcmVzZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF9jaHJvbWUpIHsKICAgICAgICAgICAgICBfY2hyb21lLmRlc3Ryb3koKTsKICAgICAgICAgICAgICBfY2hyb21lID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7CgogICAgICAgICAgICBfbWljcm9waG9uZSA9IG51bGw7CgogICAgICAgICAgICBpZiAoX3RhcmdldEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIF90YXJnZXRFbGVtZW50LmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIF90YXJnZXRFbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2xlYW51cExvY2FsU3RyZWFtKCk7CgogICAgICAgICAgICBpZiAoX2NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgX2NvbnRhaW5lci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICBfY29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc2Vzc2lvbikgdGhpcy5fLnVucHVibGlzaEZyb21TZXNzaW9uKHRoaXMuc2Vzc2lvbik7CgogICAgICAgICAgICAvLyBjbGVhciBhbGwgdGhlIGludGVydmFscwogICAgICAgICAgICBmb3IgKHZhciBjb25uX2lkIGluIF9xb3NJbnRlcnZhbHMpIHsKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoX3Fvc0ludGVydmFsc1tjb25uX2lkXSk7CiAgICAgICAgICAgICAgICBkZWxldGUgX3Fvc0ludGVydmFsc1tjb25uX2lkXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2RvbUlkID0gbnVsbDsKICAgICAgICAgICAgX3N0cmVhbSA9IG51bGw7CiAgICAgICAgICAgIF9sb2FkZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIF9zZXNzaW9uID0gbnVsbDsKICAgICAgICAgICAgX3Byb3BlcnRpZXMgPSBudWxsOwoKICAgICAgICAgICAgX3N0YXRlLnNldCgnTm90UHVibGlzaGluZycpOwogICAgICAgIH0uYmluZCh0aGlzKTsKCgogICAgdGhpcy5wdWJsaXNoID0gZnVuY3Rpb24odGFyZ2V0RWxlbWVudCwgcHJvcGVydGllcykgewogICAgICAgIE9ULmRlYnVnKCJPVC5QdWJsaXNoZXI6IHB1Ymxpc2giKTsKCiAgICAgICAgaWYgKCBfc3RhdGUuYXR0ZW1wdGluZ1RvUHVibGlzaCB8fCBfc3RhdGUucHVibGlzaGluZyApIHJlc2V0KCk7CiAgICAgICAgX3N0YXRlLnNldCgnR2V0VXNlck1lZGlhJyk7CgogICAgICAgIF9wdWJsaXNoUHJvcGVydGllcyA9IE9ULiQuZGVmYXVsdHMocHJvcGVydGllcyB8fCB7fSwgewogICAgICAgICAgICBwdWJsaXNoQXVkaW8gOiB0cnVlLAogICAgICAgICAgICBwdWJsaXNoVmlkZW8gOiB0cnVlLAogICAgICAgICAgICBtaXJyb3I6IHRydWUKICAgICAgICB9KTsKCiAgICAgICAgX3B1Ymxpc2hQcm9wZXJ0aWVzLmNvbnN0cmFpbnRzID0gT1QuJC5kZWZhdWx0cyhfcHVibGlzaFByb3BlcnRpZXMuY29uc3RyYWludHMgfHwge30sIGRlZmF1bHRDb25zdHJhaW50cyk7CgogICAgICAgIGlmIChfcHVibGlzaFByb3BlcnRpZXMuc3R5bGUpIHsKICAgICAgICAgICAgdGhpcy5zZXRTdHlsZShfcHVibGlzaFByb3BlcnRpZXMuc3R5bGUsIG51bGwsIHRydWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wdWJsaXNoUHJvcGVydGllcy5uYW1lKSB7CiAgICAgICAgICAgIF9wdWJsaXNoUHJvcGVydGllcy5uYW1lID0gX3B1Ymxpc2hQcm9wZXJ0aWVzLm5hbWUudG9TdHJpbmcoKTsKICAgICAgICB9CgogICAgICAgIF9wdWJsaXNoUHJvcGVydGllcy5jbGFzc05hbWVzID0gJ09UX3Jvb3QgT1RfcHVibGlzaGVyJzsKCiAgICAgICAgLy8gRGVmZXIgYWN0dWFsbHkgY3JlYXRpbmcgdGhlIHB1Ymxpc2hlciBET00gbm9kZXMgdW50aWwgd2Uga25vdwogICAgICAgIC8vIHRoZSBET00gaXMgYWN0dWFsbHkgbG9hZGVkLgogICAgICAgIE9ULm9uTG9hZChmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2NvbnRhaW5lciA9IG5ldyBPVC5XaWRnZXRWaWV3KHRhcmdldEVsZW1lbnQsIF9wdWJsaXNoUHJvcGVydGllcyk7CiAgICAgICAgICAgIF9kb21JZCA9IF9jb250YWluZXIuZG9tSWQ7CgogICAgICAgICAgICBPVC4kLmdldFVzZXJNZWRpYSgKICAgICAgICAgICAgICAgIF9wdWJsaXNoUHJvcGVydGllcy5jb25zdHJhaW50cywKICAgICAgICAgICAgICAgIG9uU3RyZWFtQXZhaWxhYmxlLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICBvblN0cmVhbUF2YWlsYWJsZUVycm9yLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICBvbkFjY2Vzc0RpYWxvZ09wZW5lZC5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgb25BY2Nlc3NEaWFsb2dDbG9zZWQuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgIG9uQWNjZXNzRGVuaWVkLmJpbmQodGhpcykKICAgICAgICAgICAgKTsKICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKIC8qKgogICogU3RhcnRzIHB1Ymxpc2hpbmcgYXVkaW8gKGlmIGl0IGlzIGN1cnJlbnRseSBub3QgYmVpbmcgcHVibGlzaGVkKQogICogd2hlbiB0aGUgPGNvZGU+dmFsdWU8L2NvZGU+IGlzIDxjb2RlPnRydWU8L2NvZGU+OyBzdG9wcyBwdWJsaXNoaW5nIGF1ZGlvCiAgKiAoaWYgaXQgaXMgY3VycmVudGx5IGJlaW5nIHB1Ymxpc2hlZCkgd2hlbiB0aGUgPGNvZGU+dmFsdWU8L2NvZGU+IGlzIDxjb2RlPmZhbHNlPC9jb2RlPi4KICAqCiAgKiBAcGFyYW0ge0Jvb2xlYW59IHZhbHVlIFdoZXRoZXIgdG8gc3RhcnQgcHVibGlzaGluZyBhdWRpbyAoPGNvZGU+dHJ1ZTwvY29kZT4pCiAgKiBvciBub3QgKDxjb2RlPmZhbHNlPC9jb2RlPikuCiAgKgogICogQHNlZSA8YSBocmVmPSJUQi5odG1sI2luaXRQdWJsaXNoZXIiPlRCLmluaXRQdWJsaXNoZXIoKTwvYT4KICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtLmh0bWwjaGFzQXVkaW8iPlN0cmVhbS5oYXNBdWRpbzwvYT4KICAqIEBzZWUgU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQKICAqIEBtZXRob2QgI3B1Ymxpc2hBdWRpbwogICogQG1lbWJlck9mIFB1Ymxpc2hlcgogICovCiAgICB0aGlzLnB1Ymxpc2hBdWRpbyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgX3B1Ymxpc2hQcm9wZXJ0aWVzLnB1Ymxpc2hBdWRpbyA9IHZhbHVlOwoKICAgICAgICBpZiAoX21pY3JvcGhvbmUpIHsKICAgICAgICAgICAgX21pY3JvcGhvbmUubXV0ZWQgPSAhdmFsdWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoX3Nlc3Npb24gJiYgX3N0cmVhbSkgewogICAgICAgICAgICBfc2Vzc2lvbi5fLm1vZGlmeVN0cmVhbShfc3RyZWFtLnN0cmVhbUlkLCAiaGFzQXVkaW8iLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogLyoqCiAgKiBTdGFydHMgcHVibGlzaGluZyB2aWRlbyAoaWYgaXQgaXMgY3VycmVudGx5IG5vdCBiZWluZyBwdWJsaXNoZWQpCiAgKiB3aGVuIHRoZSA8Y29kZT52YWx1ZTwvY29kZT4gaXMgPGNvZGU+dHJ1ZTwvY29kZT47IHN0b3BzIHB1Ymxpc2hpbmcgdmlkZW8KICAqIChpZiBpdCBpcyBjdXJyZW50bHkgYmVpbmcgcHVibGlzaGVkKSB3aGVuIHRoZSA8Y29kZT52YWx1ZTwvY29kZT4gaXMgPGNvZGU+ZmFsc2U8L2NvZGU+LgogICoKICAqIEBwYXJhbSB7Qm9vbGVhbn0gdmFsdWUgV2hldGhlciB0byBzdGFydCBwdWJsaXNoaW5nIHZpZGVvICg8Y29kZT50cnVlPC9jb2RlPikKICAqIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4KICAqCiAgKiBAc2VlIDxhIGhyZWY9IlRCLmh0bWwjaW5pdFB1Ymxpc2hlciI+VEIuaW5pdFB1Ymxpc2hlcigpPC9hPgogICogQHNlZSA8YSBocmVmPSJTdHJlYW0uaHRtbCNoYXNWaWRlbyI+U3RyZWFtLmhhc1ZpZGVvPC9hPgogICogQHNlZSBTdHJlYW1Qcm9wZXJ0eUNoYW5nZWRFdmVudAogICogQG1ldGhvZCAjcHVibGlzaFZpZGVvCiAgKiBAbWVtYmVyT2YgUHVibGlzaGVyCiAgKi8KICAgIHRoaXMucHVibGlzaFZpZGVvID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgb2xkVmFsdWUgPSBfcHVibGlzaFByb3BlcnRpZXMucHVibGlzaFZpZGVvOwogICAgICAgIF9wdWJsaXNoUHJvcGVydGllcy5wdWJsaXNoVmlkZW8gPSB2YWx1ZTsKCiAgICAgICAgaWYgKF9zZXNzaW9uICYmIF9zdHJlYW0gJiYgX3B1Ymxpc2hQcm9wZXJ0aWVzLnB1Ymxpc2hWaWRlbyAhPT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgX3Nlc3Npb24uXy5tb2RpZnlTdHJlYW0oX3N0cmVhbS5zdHJlYW1JZCwgImhhc1ZpZGVvIiwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2UgY3VycmVudGx5IGRvIHRoaXMgZXZlbnQgaWYgdGhlIHZhbHVlIG9mIHB1Ymxpc2hWaWRlbyBoYXMgbm90IGNoYW5nZWQKICAgICAgICAvLyBUaGlzIGlzIGJlY2F1c2UgdGhlIHN0YXRlIG9mIHRoZSB2aWRlbyB0cmFja3MgZW5hYmxlZCBmbGFnIG1heSBub3QgbWF0Y2gKICAgICAgICAvLyB0aGUgdmFsdWUgb2YgcHVibGlzaFZpZGVvIGF0IHRoaXMgcG9pbnQuIFRoaXMgd2lsbCBiZSB0aWRpZWQgdXAgc2hvcnRseS4KICAgICAgICBpZiAoX3dlYlJUQ1N0cmVhbSkgewogICAgICAgICAgICB2YXIgdmlkZW9UcmFja3MgPSBfd2ViUlRDU3RyZWFtLmdldFZpZGVvVHJhY2tzKCk7CiAgICAgICAgICAgIGZvciAodmFyIGk9MCwgbnVtPXZpZGVvVHJhY2tzLmxlbmd0aDsgaTxudW07ICsraSkgewogICAgICAgICAgICAgICAgdmlkZW9UcmFja3NbaV0uZW5hYmxlZCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihfY29udGFpbmVyKSB7CiAgICAgICAgICAgIF9jb250YWluZXIuc2hvd1Bvc3RlciA9ICF2YWx1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB0aGlzLnJlY29yZFFPUyA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAvLyBoYXZlIHRvIHJlY29yZCBRb1MgZm9yIGV2ZXJ5IHBlZXIgY29ubmVjdGlvbgogICAgICAgIGZvciAodmFyIGNvbm5faWQgaW4gX3BlZXJDb25uZWN0aW9ucykgewogICAgICAgICAgICByZWNvcmRRT1MoY29ubl9pZCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICogRGVsZXRlcyB0aGUgUHVibGlzaGVyIG9iamVjdCBhbmQgcmVtb3ZlcyBpdCBmcm9tIHRoZSBIVE1MIERPTS4KICAgICogQG1ldGhvZCAjZGVzdHJveQogICAgKiBAbWVtYmVyT2YgUHVibGlzaGVyCiAgICAqIEByZXR1cm4ge1B1Ymxpc2hlcn0gVGhlIFB1Ymxpc2hlci4KICAgICovCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigvKiB1bnVzZWQgKi8gcmVhc29uLCBxdWlldCkgewogICAgICAgIHJlc2V0KCk7CgogICAgICAgIGlmIChxdWlldCAhPT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoCiAgICAgICAgICAgICAgbmV3IE9ULkRlc3Ryb3llZEV2ZW50KAogICAgICAgICAgICAgICAgT1QuRXZlbnQubmFtZXMuUFVCTElTSEVSX0RFU1RST1lFRCwKICAgICAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgICAgICByZWFzb24KICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIHRoaXMub2ZmLmJpbmQodGhpcykKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvKioKICAgICogQG1ldGhvZE9mIFB1Ymxpc2hlcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuZGlzY29ubmVjdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIENsb3NlIHRoZSBjb25uZWN0aW9uIHRvIGVhY2ggb2Ygb3VyIHN1YnNjcmliZXJzCiAgICAgICAgZm9yICh2YXIgZnJvbUNvbm5lY3Rpb25JZCBpbiBfcGVlckNvbm5lY3Rpb25zKSB7CiAgICAgICAgICAgIHRoaXMuY2xlYW51cFN1YnNjcmliZXIoZnJvbUNvbm5lY3Rpb25JZCk7CiAgICAgICAgfQogICAgfTsKCiAgICB0aGlzLmNsZWFudXBTdWJzY3JpYmVyID0gZnVuY3Rpb24oZnJvbUNvbm5lY3Rpb25JZCkgewogICAgICAgIHZhciBwYyA9IF9wZWVyQ29ubmVjdGlvbnNbZnJvbUNvbm5lY3Rpb25JZF07CgogICAgICAgIGNsZWFySW50ZXJ2YWwoX3Fvc0ludGVydmFsc1tmcm9tQ29ubmVjdGlvbklkXSk7CiAgICAgICAgZGVsZXRlIF9xb3NJbnRlcnZhbHNbZnJvbUNvbm5lY3Rpb25JZF07CgogICAgICAgIGlmIChwYykgewogICAgICAgICAgICBwYy5kZXN0cm95KCk7CiAgICAgICAgICAgIGRlbGV0ZSBfcGVlckNvbm5lY3Rpb25zW2Zyb21Db25uZWN0aW9uSWRdOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2Rpc2Nvbm5lY3QnLCAnUGVlckNvbm5lY3Rpb24nLCAnc3Vic2NyaWJlckNvbm5lY3Rpb24nLCBmcm9tQ29ubmVjdGlvbklkKTsKICAgICAgICB9CiAgICB9OwoKCiAgICB0aGlzLnByb2Nlc3NNZXNzYWdlID0gZnVuY3Rpb24odHlwZSwgZnJvbUNvbm5lY3Rpb24sIG1lc3NhZ2UpIHsKICAgICAgICBPVC5kZWJ1ZygiT1QuUHVibGlzaGVyLnByb2Nlc3NNZXNzYWdlOiBSZWNlaXZlZCAiICsgdHlwZSArICIgZnJvbSAiICsgZnJvbUNvbm5lY3Rpb24uaWQpOwogICAgICAgIE9ULmRlYnVnKG1lc3NhZ2UpOwoKICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5VTlNVQlNDUklCRToKICAgICAgICAgICAgICAgIHRoaXMuY2xlYW51cFN1YnNjcmliZXIoZnJvbUNvbm5lY3Rpb24uaWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIHBlZXJDb25uZWN0aW9uID0gY3JlYXRlUGVlckNvbm5lY3Rpb25Gb3JSZW1vdGUuY2FsbCh0aGlzLCBmcm9tQ29ubmVjdGlvbik7CiAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5wcm9jZXNzTWVzc2FnZSh0eXBlLCBtZXNzYWdlKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBiYXNlLTY0LWVuY29kZWQgc3RyaW5nIG9mIFBORyBkYXRhIHJlcHJlc2VudGluZyB0aGUgUHVibGlzaGVyIHZpZGVvLgogICAgKgogICAgKiAgIDxwPllvdSBjYW4gdXNlIHRoZSBzdHJpbmcgYXMgdGhlIHZhbHVlIGZvciBhIGRhdGEgVVJMIHNjaGVtZSBwYXNzZWQgdG8gdGhlIHNyYyBwYXJhbWV0ZXIgb2YKICAgICogICBhbiBpbWFnZSBmaWxlLCBhcyBpbiB0aGUgZm9sbG93aW5nOjwvcD4KICAgICoKICAgICogPHByZT4KICAgICogIHZhciBpbWdEYXRhID0gcHVibGlzaGVyLmdldEltZ0RhdGEoKTsKICAgICoKICAgICogIHZhciBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICogIGltZy5zZXRBdHRyaWJ1dGUoInNyYyIsICJkYXRhOmltYWdlL3BuZztiYXNlNjQsIiArIGltZ0RhdGEpOwogICAgKiAgdmFyIGltZ1dpbiA9IHdpbmRvdy5vcGVuKCJhYm91dDpibGFuayIsICJTY3JlZW5zaG90Iik7CiAgICAqICBpbWdXaW4uZG9jdW1lbnQud3JpdGUoIiZsdDtib2R5Jmd0OyZsdDsvYm9keSZndDsiKTsKICAgICogIGltZ1dpbi5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGltZyk7CiAgICAqIDwvcHJlPgogICAgKgogICAgKiBAbWV0aG9kICNnZXRJbWdEYXRhCiAgICAqIEBtZW1iZXJPZiBQdWJsaXNoZXIKICAgICogQHJldHVybiB7U3RyaW5nfSBUaGUgYmFzZS02NCBlbmNvZGVkIHN0cmluZy4gUmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaWYgdGhlcmUgaXMgbm8gdmlkZW8uCiAgICAqLwoKICAgIHRoaXMuZ2V0SW1nRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghX2xvYWRlZCkgewogICAgICAgICAgICBPVC5lcnJvcigiT1QuUHVibGlzaGVyLmdldEltZ0RhdGE6IENhbm5vdCBnZXRJbWdEYXRhIGJlZm9yZSB0aGUgUHVibGlzaGVyIGlzIHB1Ymxpc2hpbmcuIik7CgogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBfdGFyZ2V0RWxlbWVudC5pbWdEYXRhOwogICAgfTsKCgogICAgLy8gQVBJIENvbXBhdGliaWxpdHkgbGF5ZXIgZm9yIEZsYXNoIFB1Ymxpc2hlciwgdGhpcyBjb3VsZCBkbyB3aXRoIHNvbWUgdGlkeXVwLgogICAgdGhpcy5fID0gewogICAgICAgIHB1Ymxpc2hUb1Nlc3Npb246IGZ1bmN0aW9uKHNlc3Npb24pIHsKICAgICAgICAgICAgLy8gQWRkIHNlc3Npb24gcHJvcGVydHkgdG8gUHVibGlzaGVyCiAgICAgICAgICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb247CgogICAgICAgICAgICB2YXIgY3JlYXRlU3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyBCYWlsIGlmIHRoaXMuc2Vzc2lvbiBpcyBnb25lLCBpdCBtZWFucyB3ZSB3ZXJlIHVucHVibGlzaGVkCiAgICAgICAgICAgICAgICAvLyBiZWZvcmUgY3JlYXRlU3RyZWFtIGNvdWxkIGZpbmlzaC4KICAgICAgICAgICAgICAgIGlmICghdGhpcy5zZXNzaW9uKSByZXR1cm47CgogICAgICAgICAgICAgICAgX3N0YXRlLnNldCgnUHVibGlzaGluZ1RvU2Vzc2lvbicpOwoKICAgICAgICAgICAgICAgIHNlc3Npb24uXy5jcmVhdGVTdHJlYW0oIHRoaXMuZ3VpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9wdWJsaXNoUHJvcGVydGllcyAmJiBfcHVibGlzaFByb3BlcnRpZXMubmFtZSA/IF9wdWJsaXNoUHJvcGVydGllcy5uYW1lIDogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPVC5WaWRlb09yaWVudGF0aW9uLlJPVEFURURfTk9STUFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RhcmdldEVsZW1lbnQudmlkZW9XaWR0aCwgICAgICAgICAgICAgICAgICAgICAgLy8gYWN0dWFsIHdpZHRoIGFuZCBoZWlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRFbGVtZW50LnZpZGVvSGVpZ2h0LCAgICAgICAgICAgICAgICAgICAgIC8vIG9mIHRoZSB2aWRlbyBzdHJlYW0uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcHVibGlzaFByb3BlcnRpZXMucHVibGlzaEF1ZGlvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3B1Ymxpc2hQcm9wZXJ0aWVzLnB1Ymxpc2hWaWRlbyApOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKF9sb2FkZWQpIGNyZWF0ZVN0cmVhbS5jYWxsKHRoaXMpOwogICAgICAgICAgICBlbHNlIHRoaXMub24oImluaXRTdWNjZXNzIiwgY3JlYXRlU3RyZWFtLCB0aGlzKTsKCiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdwdWJsaXNoJywgJ0F0dGVtcHQnLCAnc3RyZWFtVHlwZScsICdXZWJSVEMnKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0uYmluZCh0aGlzKSwKCiAgICAgICAgdW5wdWJsaXNoRnJvbVNlc3Npb246IGZ1bmN0aW9uKHNlc3Npb24pIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnNlc3Npb24gfHwgc2Vzc2lvbi5pZCAhPT0gdGhpcy5zZXNzaW9uLmlkKSB7CiAgICAgICAgICAgICAgICBPVC53YXJuKCJUaGUgcHVibGlzaGVyICIgKyB0aGlzLmd1aWQgKyAiIGlzIHRyeWluZyB0byB1bnB1Ymxpc2ggZnJvbSBhIHNlc3Npb24gIiArIHNlc3Npb24uaWQgKyAiIGl0IGlzIG5vdCBhdHRhY2hlZCB0byIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZXNzaW9uLmNvbm5lY3RlZCAmJiB0aGlzLnN0cmVhbSkgewogICAgICAgICAgICAgICAgc2Vzc2lvbi5fLmRlc3Ryb3lTdHJlYW0odGhpcy5zdHJlYW0uaWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEaXNjb25uZWN0IGltbWVkaWF0ZWx5LCByYXRoZXIgdGhhbiB3YWl0IGZvciB0aGUgV2ViU29ja2V0IHRvCiAgICAgICAgICAgIC8vIHJlcGx5IHRvIG91ciBkZXN0cm95U3RyZWFtIG1lc3NhZ2UuCiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB0aGlzLnNlc3Npb24gPSBudWxsOwoKICAgICAgICAgICAgLy8gV2UncmUgYmFjayB0byBiZWluZyBhIHN0YW5kLWFsb25lIHB1Ymxpc2hlciBhZ2Fpbi4KICAgICAgICAgICAgX3N0YXRlLnNldCgnTWVkaWFCb3VuZCcpOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3VucHVibGlzaCcsICdTdWNjZXNzJywgJ3Nlc3Npb25JZCcsIHNlc3Npb24uaWQpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfS5iaW5kKHRoaXMpLAoKICAgICAgICAvLyBDYWxsZWQgb25jZSBvdXIgc3RyZWFtIGhhcyBiZWVuIGFjaydkIGFzIGNyZWF0ZWQgYnkgdGhlIHNlc3Npb24KICAgICAgICBzdHJlYW1SZWdpc3RlcmVkSGFuZGxlcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtOwogICAgICAgICAgICB0aGlzLnN0cmVhbS5vbignZGVzdHJveWVkJywgdGhpcy5kaXNjb25uZWN0LCB0aGlzKTsKCiAgICAgICAgICAgIHZhciBvbGRHdWlkID0gX2d1aWQ7CiAgICAgICAgICAgIF9ndWlkID0gT1QuUHVibGlzaGVyLm5leHRJZCgpOwoKICAgICAgICAgICAgLy8gT3VyIHB1Ymxpc2hlciBoYXMgY2hhbmdlZCBndWlkcywgbGV0IHBlb3BsZSB0aGF0IHJlbHkKICAgICAgICAgICAgLy8gb24gdGhlIEdVSUQgYmUgbm9uLXZvbGF0aWxlIGtub3cuCiAgICAgICAgICAgIGlmIChvbGRHdWlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2lkVXBkYXRlZCcsIG9sZEd1aWQsIF9ndWlkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3N0YXRlLnNldCgnUHVibGlzaGluZycpOwogICAgICAgICAgICBfcHVibGlzaFN0YXJ0VGltZSA9IG5ldyBEYXRlKCk7CgogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3B1Ymxpc2hTdWNjZXNzJyk7CiAgICAgICAgfS5iaW5kKHRoaXMpCiAgICB9OwoKICAgIHRoaXMuZGV0ZWN0RGV2aWNlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIE9ULndhcm4oIkZpeG1lOiBIYXZlbid0IGltcGxlbWVudGVkIGRldGVjdERldmljZXMiKTsKICAgIH07CgogICAgdGhpcy5kZXRlY3RNaWNBY3Rpdml0eSA9IGZ1bmN0aW9uKCkgewogICAgICAgIE9ULndhcm4oIkZpeG1lOiBIYXZlbid0IGltcGxlbWVudGVkIGRldGVjdE1pY0FjdGl2aXR5Iik7CiAgICB9OwoKICAgIHRoaXMuZ2V0RWNob0NhbmNlbGxhdGlvbk1vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICBPVC53YXJuKCJGaXhtZTogSGF2ZW4ndCBpbXBsZW1lbnRlZCBnZXRFY2hvQ2FuY2VsbGF0aW9uTW9kZSIpOwogICAgICAgIHJldHVybiAiZnVsbER1cGxleCI7CiAgICB9OwoKICAgIHRoaXMuc2V0TWljcm9waG9uZUdhaW4gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIE9ULndhcm4oIkZpeG1lOiBIYXZlbid0IGltcGxlbWVudGVkIHNldE1pY3JvcGhvbmVHYWluIik7CiAgICB9OwoKICAgIHRoaXMuZ2V0TWljcm9waG9uZUdhaW4gPSBmdW5jdGlvbigpIHsKICAgICAgICBPVC53YXJuKCJGaXhtZTogSGF2ZW4ndCBpbXBsZW1lbnRlZCBnZXRNaWNyb3Bob25lR2FpbiIpOwogICAgICAgIHJldHVybiAwLjU7CiAgICB9OwoKICAgIHRoaXMuc2V0Q2FtZXJhID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBPVC53YXJuKCJGaXhtZTogSGF2ZW4ndCBpbXBsZW1lbnRlZCBzZXRDYW1lcmEiKTsKICAgIH07CgogICAgdGhpcy5zZXRNaWNyb3Bob25lID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBPVC53YXJuKCJGaXhtZTogSGF2ZW4ndCBpbXBsZW1lbnRlZCBzZXRNaWNyb3Bob25lIik7CiAgICB9OwoKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgICAgaWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9kb21JZDsgfSwKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgIH0sCgogICAgICAgIGd1aWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9ndWlkOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfc3RyZWFtOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHN0cmVhbSkgeyBfc3RyZWFtID0gc3RyZWFtOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtSWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghX3N0cmVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICAgICAgcmV0dXJuIF9zdHJlYW0uaWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9LAoKICAgICAgICB0YXJnZXRFbGVtZW50OiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfdGFyZ2V0RWxlbWVudC5kb21FbGVtZW50OyB9CiAgICAgICAgfSwKCiAgICAgICAgZG9tSWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9kb21JZDsgfQogICAgICAgIH0sCgogICAgICAgIHNlc3Npb246IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHNlc3Npb24pIHsgX3Nlc3Npb24gPSBzZXNzaW9uOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgaXNXZWJSVEM6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH0KICAgICAgICB9LAoKICAgICAgICBsb2FkaW5nOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKXsgcmV0dXJuIF9jb250YWluZXIgJiYgX2NvbnRhaW5lci5sb2FkaW5nIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5fLCAnd2ViUnRjU3RyZWFtJywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfd2ViUlRDU3RyZWFtOyB9CiAgICB9KTsKCiAgICB0aGlzLm9uKCdzdHlsZVZhbHVlQ2hhbmdlZCcsIHVwZGF0ZUNocm9tZUZvclN0eWxlQ2hhbmdlLCB0aGlzKTsKICAgIF9zdGF0ZSA9IG5ldyBPVC5QdWJsaXNoaW5nU3RhdGUoc3RhdGVDaGFuZ2VGYWlsZWQpOwoKCiAgLyoqCiAgKiBEaXNwYXRjaGVkIHdoZW4gdGhlIHVzZXIgaGFzIGNsaWNrZWQgdGhlIEFsbG93IGJ1dHRvbiwgZ3JhbnRpbmcgdGhlCiAgKiBhcHAgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuCiAgKiBAbmFtZSBhY2Nlc3NBbGxvd2VkCiAgKiBAZXZlbnQKICAqIEBtZW1iZXJvZiBQdWJsaXNoZXIKICAqLwoKICAvKioKICAqIERpc3BhdGNoZWQgd2hlbiB0aGUgdXNlciBoYXMgY2xpY2tlZCB0aGUgRGVueSBidXR0b24sIHByZXZlbnRpbmcgdGhlCiAgKiBhcHAgZnJvbSBoYXZpbmcgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuCiAgKiBAbmFtZSBhY2Nlc3NEZW5pZWQKICAqIEBldmVudAogICogQG1lbWJlcm9mIFB1Ymxpc2hlcgogICovCgogIC8qKgogICogRGlzcGF0Y2hlZCB3aGVuIHRoZSBBbGxvdy9EZW55IGRpYWxvZyBib3ggaXMgb3BlbmVkLiAoVGhpcyBpcyB0aGUgZGlhbG9nIGJveCBpbiB3aGljaCB0aGUgdXNlciBjYW4gZ3JhbnQKICAqIHRoZSBhcHAgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuKQogICogQG5hbWUgYWNjZXNzRGlhbG9nT3BlbmVkCiAgKiBAZXZlbnQKICAqIEBtZW1iZXJvZiBQdWJsaXNoZXIKICAqLwoKICAvKioKICAqIERpc3BhdGNoZWQgd2hlbiB0aGUgQWxsb3cvRGVueSBib3ggaXMgY2xvc2VkLiAoVGhpcyBpcyB0aGUgZGlhbG9nIGJveCBpbiB3aGljaCB0aGUgdXNlciBjYW4gZ3JhbnQKICAqIHRoZSBhcHAgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuKQogICogQG5hbWUgYWNjZXNzRGlhbG9nQ2xvc2VkCiAgKiBAZXZlbnQKICAqIEBtZW1iZXJvZiBQdWJsaXNoZXIKICAqLwoKfTsKCi8vIEhlbHBlciBmdW5jdGlvbiB0byBnZW5lcmF0ZSB1bmlxdWUgcHVibGlzaGVyIGlkcwpPVC5QdWJsaXNoZXIubmV4dElkID0gT1QuJC51dWlkOwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKCi8qKgogKiBUaGUgU3Vic2NyaWJlciBvYmplY3QgaXMgYSByZXByZXNlbnRhdGlvbiBvZiB0aGUgbG9jYWwgdmlkZW8gZWxlbWVudCB0aGF0IGlzIHBsYXlpbmcgYmFjayBhIHJlbW90ZSBzdHJlYW0uCiAqIFRoZSBTdWJzY3JpYmVyIG9iamVjdCBpbmNsdWRlcyBtZXRob2RzIHRoYXQgbGV0IHlvdSBkaXNhYmxlIGFuZCBlbmFibGUgbG9jYWwgYXVkaW8gcGxheWJhY2sgZm9yIHRoZSBzdWJzY3JpYmVkIHN0cmVhbS4KICogVGhlIDxjb2RlPnN1YnNjcmliZSgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIHtAbGluayBTZXNzaW9ufSBvYmplY3QgcmV0dXJucyBhIFN1YnNjcmliZXIgb2JqZWN0LgogKgogKiBAcHJvcGVydHkge1N0cmluZ30gaWQgVGhlIERPTSBJRCBvZiB0aGUgU3Vic2NyaWJlci4KICogQHByb3BlcnR5IHtTdHJlYW19IHN0cmVhbSBUaGUgc3RyZWFtIHRvIHdoaWNoIHlvdSBhcmUgc3Vic2NyaWJpbmcuCiAqIEBjbGFzcyBTdWJzY3JpYmVyCiAqIEBhdWdtZW50cyBFdmVudERpc3BhdGNoZXIKICovCk9ULlN1YnNjcmliZXIgPSBmdW5jdGlvbih0YXJnZXRFbGVtZW50LCBvcHRpb25zKSB7CiAgICB2YXIgX3dpZGdldElkID0gT1QuJC51dWlkKCksCiAgICAgICAgX2RvbUlkID0gdGFyZ2V0RWxlbWVudCB8fCBfd2lkZ2V0SWQsCiAgICAgICAgX2NvbnRhaW5lciwKICAgICAgICBfc3RyZWFtQ29udGFpbmVyLAogICAgICAgIF9jaHJvbWUsCiAgICAgICAgX3N0cmVhbSwKICAgICAgICBfZnJvbUNvbm5lY3Rpb25JZCwKICAgICAgICBfcGVlckNvbm5lY3Rpb24sCiAgICAgICAgX3Nlc3Npb24gPSBvcHRpb25zLnNlc3Npb24sCiAgICAgICAgX3N1YnNjcmliZVN0YXJ0VGltZSwKICAgICAgICBfc3RhcnRDb25uZWN0aW5nVGltZSwKICAgICAgICBfcW9zSW50ZXJ2YWwsCiAgICAgICAgX3Byb3BlcnRpZXMgPSBPVC4kLmNsb25lKG9wdGlvbnMpLAogICAgICAgIF9hbmFseXRpY3MgPSBuZXcgT1QuQW5hbHl0aWNzKCksCiAgICAgICAgX2F1ZGlvVm9sdW1lID0gNTAsCiAgICAgICAgX2dldHRpbmdTdGF0cyA9IDAsCiAgICAgICAgX3N0YXRlLAogICAgICAgIF9zdWJzY3JpYmVBdWRpb0ZhbHNlV29ya2Fyb3VuZCwgLy8gT1BFTlRPSy02ODQ0CiAgICAgICAgX3ByZXZTdGF0cyA9IHsKICAgICAgICAgICAgInRpbWVTdGFtcCIgOiBPVC4kLm5vdygpCiAgICAgICAgfTsKCgogICAgaWYgKCFfc2Vzc2lvbikgewogICAgICAgIE9ULmhhbmRsZUpzRXhjZXB0aW9uKCJTdWJzY3JpYmVyIG11c3QgYmUgcGFzc2VkIGEgc2Vzc2lvbiBvcHRpb24iLCAyMDAwLCB7CiAgICAgICAgICAgIHNlc3Npb246IF9zZXNzaW9uLAogICAgICAgICAgICB0YXJnZXQ6IHRoaXMKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogICAgT1QuU3R5bGFibGVDb21wb25lbnQodGhpcywgewogICAgICAgIG5hbWVEaXNwbGF5TW9kZTogImF1dG8iLAogICAgICAgIGJ1dHRvbkRpc3BsYXlNb2RlOiAiYXV0byIsCiAgICAgICAgYmFja2dyb3VuZEltYWdlVVJJOiBudWxsCiAgICB9KTsKCiAgICB2YXIgbG9nQW5hbHl0aWNzRXZlbnQgPSBmdW5jdGlvbihhY3Rpb24sIHZhcmlhdGlvbiwgcGF5bG9hZFR5cGUsIHBheWxvYWQpIHsKICAgICAgICAgICAgX2FuYWx5dGljcy5sb2dFdmVudCh7CiAgICAgICAgICAgICAgICBhY3Rpb246IGFjdGlvbiwKICAgICAgICAgICAgICAgIHZhcmlhdGlvbjogdmFyaWF0aW9uLAogICAgICAgICAgICAgICAgcGF5bG9hZF90eXBlOiBwYXlsb2FkVHlwZSwKICAgICAgICAgICAgICAgIHBheWxvYWQ6IHBheWxvYWQsCiAgICAgICAgICAgICAgICBzdHJlYW1faWQ6IF9zdHJlYW0gPyBfc3RyZWFtLmlkIDogbnVsbCwKICAgICAgICAgICAgICAgIHNlc3Npb25faWQ6IF9zZXNzaW9uID8gX3Nlc3Npb24uc2Vzc2lvbklkIDogbnVsbCwKICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25faWQ6IF9zZXNzaW9uICYmIF9zZXNzaW9uLmNvbm5lY3RlZCA/IF9zZXNzaW9uLmNvbm5lY3Rpb24uY29ubmVjdGlvbklkIDogbnVsbCwKICAgICAgICAgICAgICAgIHBhcnRuZXJfaWQ6IF9zZXNzaW9uICYmIF9zZXNzaW9uLmNvbm5lY3RlZCA/IF9zZXNzaW9uLnNlc3Npb25JbmZvLnBhcnRuZXJJZCA6IG51bGwsCiAgICAgICAgICAgICAgICB3aWRnZXRfaWQ6IF93aWRnZXRJZCwKICAgICAgICAgICAgICAgIHdpZGdldF90eXBlOiAnU3Vic2NyaWJlcicKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcmVjb3JkUU9TID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKF9zdGF0ZS5zdWJzY3JpYmluZyAmJiBfc2Vzc2lvbiAmJiBfc2Vzc2lvbi5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgICAgIHZhciBRb1NfYmxvYiA9IHsKICAgICAgICAgICAgICAgICAgICB3aWRnZXRfdHlwZTogJ1N1YnNjcmliZXInLAogICAgICAgICAgICAgICAgICAgIHN0cmVhbV90eXBlIDogJ1dlYlJUQycsCiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbl9pZDogX3Nlc3Npb24gPyBfc2Vzc2lvbi5zZXNzaW9uSWQgOiBudWxsLAogICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25JZDogX3Nlc3Npb24gPyBfc2Vzc2lvbi5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZCA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgbWVkaWFfc2VydmVyX25hbWU6IF9zZXNzaW9uID8gX3Nlc3Npb24uc2Vzc2lvbkluZm8ubWVzc2FnaW5nU2VydmVyIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBwMnBGbGFnOiBfc2Vzc2lvbiA/IF9zZXNzaW9uLnNlc3Npb25JbmZvLnAycEVuYWJsZWQgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBwYXJ0bmVyX2lkOiBfc2Vzc2lvbiA/IF9zZXNzaW9uLmFwaUtleSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgc3RyZWFtX2lkOiBfc3RyZWFtLmlkLAogICAgICAgICAgICAgICAgICAgIHdpZGdldF9pZDogX3dpZGdldElkLAogICAgICAgICAgICAgICAgICAgIHZlcnNpb246IE9ULnByb3BlcnRpZXMudmVyc2lvbiwKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogcGFyc2VJbnQoT1QuJC5ub3coKSAtIF9zdWJzY3JpYmVTdGFydFRpbWUsIDEwKSwKICAgICAgICAgICAgICAgICAgICByZW1vdGVfY29ubmVjdGlvbl9pZDogX3N0cmVhbS5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZAogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgLy8gZ2V0IHN0YXRzIGZvciBlYWNoIGNvbm5lY3Rpb24gaWQKICAgICAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5nZXRTdGF0cyhfcHJldlN0YXRzLCBmdW5jdGlvbihzdGF0cykgewogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0cykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHN0YXRfaW5kZXggaW4gc3RhdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFFvU19ibG9iW3N0YXRfaW5kZXhdID0gc3RhdHNbc3RhdF9pbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX2FuYWx5dGljcy5sb2dRT1MoUW9TX2Jsb2IpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzdGF0ZUNoYW5nZUZhaWxlZCA9IGZ1bmN0aW9uKGNoYW5nZUZhaWxlZCkgewogICAgICAgICAgICBPVC5lcnJvcigiU3Vic2NyaWJlciBTdGF0ZSBDaGFuZ2UgRmFpbGVkOiAiLCBjaGFuZ2VGYWlsZWQubWVzc2FnZSk7CiAgICAgICAgICAgIE9ULmRlYnVnKGNoYW5nZUZhaWxlZCk7CiAgICAgICAgfSwKCiAgICAgICAgb25Mb2FkZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF9zdGF0ZS5zdWJzY3JpYmluZyB8fCAhX3N0cmVhbUNvbnRhaW5lcikgcmV0dXJuOwoKICAgICAgICAgICAgT1QuZGVidWcoIk9ULlN1YnNjcmliZXIub25Mb2FkZWQiKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ1N1YnNjcmliaW5nJyk7CiAgICAgICAgICAgIF9zdWJzY3JpYmVTdGFydFRpbWUgPSBPVC4kLm5vdygpOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2NyZWF0ZVBlZXJDb25uZWN0aW9uJywgJ1N1Y2Nlc3MnLCAncGNjfGhhc1JlbGF5Q2FuZGlkYXRlcycsIFsKICAgICAgICAgICAgICAgIHBhcnNlSW50KF9zdWJzY3JpYmVTdGFydFRpbWUgLSBfc3RhcnRDb25uZWN0aW5nVGltZSwgMTApLAogICAgICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uICYmIF9wZWVyQ29ubmVjdGlvbi5oYXNSZWxheUNhbmRpZGF0ZXMKICAgICAgICAgICAgXS5qb2luKCd8JykpOwoKICAgICAgICAgICAgX3Fvc0ludGVydmFsID0gc2V0SW50ZXJ2YWwocmVjb3JkUU9TLCAzMDAwMCk7CgogICAgICAgICAgICBpZihfc3Vic2NyaWJlQXVkaW9GYWxzZVdvcmthcm91bmQpIHsKICAgICAgICAgICAgICAgIF9zdWJzY3JpYmVBdWRpb0ZhbHNlV29ya2Fyb3VuZCA9IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLnN1YnNjcmliZVRvVmlkZW8oZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfY29udGFpbmVyLmxvYWRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIF9jcmVhdGVDaHJvbWUuY2FsbCh0aGlzKTsKCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc3Vic2NyaWJlU3VjY2VzcycsIHRoaXMpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2xvYWRlZCcsIHRoaXMpOwoKCiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdzdWJzY3JpYmUnLCAnU3VjY2VzcycsICdzdHJlYW1JZCcsIF9zdHJlYW0uaWQpOwogICAgICAgIH0sCgogICAgICAgIG9uRGlzY29ubmVjdGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIE9ULmRlYnVnKCJPVC5TdWJzY3JpYmVyIGhhcyBiZWVuIGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBQdWJsaXNoZXIncyBQZWVyQ29ubmVjdGlvbiIpOwoKICAgICAgICAgICAgaWYgKF9zdGF0ZS5hdHRlbXB0aW5nVG9TdWJzY3JpYmUpIHsKICAgICAgICAgICAgICAgIC8vIHN1YnNjcmliaW5nIGVycm9yCiAgICAgICAgICAgICAgICBfc3RhdGUuc2V0KCdGYWlsZWQnKTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc3Vic2NyaWJlRXJyb3InLCAiQ2xpZW50RGlzY29ubmVjdGVkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoX3N0YXRlLnN1YnNjcmliaW5nKSB7CiAgICAgICAgICAgICAgICBfc3RhdGUuc2V0KCdGYWlsZWQnKTsKCiAgICAgICAgICAgICAgICAvLyB3ZSB3ZXJlIGRpc2Nvbm5lY3RlZCBhZnRlciB3ZSB3ZXJlIGFscmVhZHkgc3Vic2NyaWJpbmcKICAgICAgICAgICAgICAgIC8vIHByb2JhYmx5IGRvIG5vdGhpbmc/CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpOwogICAgICAgIH0sCgoKICAgICAgICBvblBlZXJDb25uZWN0aW9uRmFpbHVyZSA9IGZ1bmN0aW9uKGNvZGUsIHJlYXNvbikgewogICAgICAgICAgICBpZiAoX3N0YXRlLmF0dGVtcHRpbmdUb1N1YnNjcmliZSkgewogICAgICAgICAgICAgICAgLy8gV2Ugd2VyZW4ndCBzdWJzY3JpYmluZyB5ZXQgc28gdGhpcyB3YXMgYSBmYWlsdXJlIGluIHNldHRpbmcKICAgICAgICAgICAgICAgIC8vIHVwIHRoZSBQZWVyQ29ubmVjdGlvbiBvciByZWNlaXZpbmcgdGhlIGluaXRpYWwgc3RyZWFtLgogICAgICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2NyZWF0ZVBlZXJDb25uZWN0aW9uJywgJ0ZhaWx1cmUnLCAncmVhc29ufGhhc1JlbGF5Q2FuZGlkYXRlcycsIFsKICAgICAgICAgICAgICAgICAgICAiU3Vic2NyaWJlciBQZWVyQ29ubmVjdGlvbiBFcnJvcjogIiArIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24gJiYgX3BlZXJDb25uZWN0aW9uLmhhc1JlbGF5Q2FuZGlkYXRlcwogICAgICAgICAgICAgICAgXS5qb2luKCd8JykpOwoKICAgICAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdWJzY3JpYmVFcnJvcicsIHJlYXNvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoX3N0YXRlLnN1YnNjcmliaW5nKSB7CiAgICAgICAgICAgICAgICAvLyB3ZSB3ZXJlIGRpc2Nvbm5lY3RlZCBhZnRlciB3ZSB3ZXJlIGFscmVhZHkgc3Vic2NyaWJpbmcKICAgICAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIHJlYXNvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3N1YnNjcmliZScsICdGYWlsdXJlJywgJ3JlYXNvbicsICJTdWJzY3JpYmVyIFBlZXJDb25uZWN0aW9uIEVycm9yOiAiICsgcmVhc29uKTsKCiAgICAgICAgICAgIE9ULmhhbmRsZUpzRXhjZXB0aW9uKCJTdWJzY3JpYmVyIFBlZXJDb25uZWN0aW9uIEVycm9yOiAiICsgcmVhc29uLCBPVC5FeGNlcHRpb25Db2Rlcy5QMlBfQ09OTkVDVElPTl9GQUlMRUQsIHsKICAgICAgICAgICAgICAgIHNlc3Npb246IF9zZXNzaW9uLAogICAgICAgICAgICAgICAgdGFyZ2V0OiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBfc2hvd0Vycm9yLmNhbGwodGhpcywgcmVhc29uKTsKICAgICAgICB9LAoKICAgICAgICBvblJlbW90ZVN0cmVhbUFkZGVkID0gZnVuY3Rpb24od2ViT1RTdHJlYW0pIHsKICAgICAgICAgICAgT1QuZGVidWcoIk9ULlN1YnNjcmliZXIub25SZW1vdGVTdHJlYW1BZGRlZCIpOwoKICAgICAgICAgICAgX3N0YXRlLnNldCgnQmluZGluZ1JlbW90ZVN0cmVhbScpOwoKICAgICAgICAgICAgLy8gRGlzYWJsZSB0aGUgYXVkaW8vdmlkZW8sIGlmIG5lZWRlZAogICAgICAgICAgICB0aGlzLnN1YnNjcmliZVRvQXVkaW8oX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9BdWRpbyk7CgogICAgICAgICAgICB2YXIgcHJlc2VydmVyID0gX3N1YnNjcmliZUF1ZGlvRmFsc2VXb3JrYXJvdW5kOwogICAgICAgICAgICB0aGlzLnN1YnNjcmliZVRvVmlkZW8oX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9WaWRlbyk7CiAgICAgICAgICAgIF9zdWJzY3JpYmVBdWRpb0ZhbHNlV29ya2Fyb3VuZCA9IHByZXNlcnZlcjsKCiAgICAgICAgICAgIHZhciBzdHJlYW1FbGVtZW50ID0gbmV3IE9ULlZpZGVvRWxlbWVudCgpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgYXVkaW8gdm9sdW1lCiAgICAgICAgICAgIHN0cmVhbUVsZW1lbnQuc2V0QXVkaW9Wb2x1bWUoX2F1ZGlvVm9sdW1lKTsKICAgICAgICAgICAgc3RyZWFtRWxlbWVudC5vbih7CiAgICAgICAgICAgICAgICAgICAgc3RyZWFtQm91bmQ6IG9uTG9hZGVkLAogICAgICAgICAgICAgICAgICAgIGxvYWRFcnJvcjogb25QZWVyQ29ubmVjdGlvbkZhaWx1cmUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IG9uUGVlckNvbm5lY3Rpb25GYWlsdXJlCiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgICAgIHN0cmVhbUVsZW1lbnQuYmluZFRvU3RyZWFtKHdlYk9UU3RyZWFtKTsKICAgICAgICAgICAgIF9jb250YWluZXIudmlkZW8gPSBzdHJlYW1FbGVtZW50OwoKICAgICAgICAgICAgX3N0cmVhbUNvbnRhaW5lciA9IHN0cmVhbUVsZW1lbnQ7CgogICAgICAgICAgICBfc3RyZWFtQ29udGFpbmVyLm9yaWVudGF0aW9uID0gewogICAgICAgICAgICAgICAgd2lkdGg6IF9zdHJlYW0udmlkZW9EaW1lbnNpb25zLndpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBfc3RyZWFtLnZpZGVvRGltZW5zaW9ucy5oZWlnaHQsCiAgICAgICAgICAgICAgICB2aWRlb09yaWVudGF0aW9uOiBfc3RyZWFtLnZpZGVvRGltZW5zaW9ucy5vcmllbnRhdGlvbgogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2NyZWF0ZVBlZXJDb25uZWN0aW9uJywgJ1N0cmVhbUFkZGVkJywgJycsICcnKTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdHJlYW1BZGRlZCcsIHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIG9uUmVtb3RlU3RyZWFtUmVtb3ZlZCA9IGZ1bmN0aW9uKHdlYk9UU3RyZWFtKSB7CiAgICAgICAgICAgIE9ULmRlYnVnKCJPVC5TdWJzY3JpYmVyLm9uU3RyZWFtUmVtb3ZlZCIpOwoKICAgICAgICAgICAgaWYgKF9zdHJlYW1Db250YWluZXIuc3RyZWFtID09IHdlYk9UU3RyZWFtKSB7CiAgICAgICAgICAgICAgICBfc3RyZWFtQ29udGFpbmVyLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIF9zdHJlYW1Db250YWluZXIgPSBudWxsOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdHJlYW1SZW1vdmVkJywgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtVXBkYXRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHN3aXRjaChldmVudC5jaGFuZ2VkUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ29yaWVudGF0aW9uJzoKICAgICAgICAgICAgICAgICAgICBfc3RyZWFtQ29udGFpbmVyLm9yaWVudGF0aW9uID0gewogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogX3N0cmVhbS52aWRlb0RpbWVuc2lvbnMud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogX3N0cmVhbS52aWRlb0RpbWVuc2lvbnMuaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICB2aWRlb09yaWVudGF0aW9uOiBfc3RyZWFtLnZpZGVvRGltZW5zaW9ucy5vcmllbnRhdGlvbgogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnaGFzVmlkZW8nOgogICAgICAgICAgICAgICAgICAgIGlmKF9jb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRhaW5lci5zaG93UG9zdGVyID0gIShfc3RyZWFtLmhhc1ZpZGVvICYmIF9wcm9wZXJ0aWVzLnN1YnNjcmliZVRvVmlkZW8pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnaGFzQXVkaW8nOgogICAgICAgICAgICAgICAgICAgIC8vIG5vb3AKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vLyBDaHJvbWUKCiAgICAgICAgdXBkYXRlQ2hyb21lRm9yU3R5bGVDaGFuZ2UgPSBmdW5jdGlvbihrZXksIHZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBpZiAoIV9jaHJvbWUpIHJldHVybjsKCiAgICAgICAgICAgIHN3aXRjaChrZXkpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ25hbWVEaXNwbGF5TW9kZSc6CiAgICAgICAgICAgICAgICAgICAgX2Nocm9tZS5uYW1lLnNldERpc3BsYXlNb2RlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICdidXR0b25EaXNwbGF5TW9kZSc6CiAgICAgICAgICAgICAgICAgICAgLy8gX2Nocm9tZS5tdXRlQnV0dG9uLnNldERpc3BsYXlNb2RlKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9jcmVhdGVDaHJvbWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2Nocm9tZSA9IG5ldyBPVC5DaHJvbWUoewogICAgICAgICAgICAgICAgcGFyZW50OiBfY29udGFpbmVyLmRvbUVsZW1lbnQKICAgICAgICAgICAgfSkuc2V0KHsKICAgICAgICAgICAgICAgIG5hbWU6IG5ldyBPVC5DaHJvbWUuTmFtZVBhbmVsKHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiBfcHJvcGVydGllcy5uYW1lLAogICAgICAgICAgICAgICAgICAgIG1vZGU6IHRoaXMuZ2V0U3R5bGUoJ25hbWVEaXNwbGF5TW9kZScpCiAgICAgICAgICAgICAgICB9KSwKCiAgICAgICAgICAgICAgICAvLyAvLyBEaXNhYmxlZCB1bnRpbCB3ZSBjYW4gY2hhbmdlIHRoZSBtaWMgVm9sdW1lIHRocm91Z2ggV2ViUlRDCiAgICAgICAgICAgICAgICAvLyBtdXRlQnV0dG9uOiBuZXcgT1QuQ2hyb21lLk1pY1ZvbHVtZSh7CiAgICAgICAgICAgICAgICAvLyAgICAgbXV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgLy8gICAgIG1vZGU6IHRoaXMuZ2V0U3R5bGUoJ2J1dHRvbkRpc3BsYXlNb2RlJykKICAgICAgICAgICAgICAgIC8vIH0pLAoKICAgICAgICAgICAgICAgIG9wZW50b2tCdXR0b246IG5ldyBPVC5DaHJvbWUuT3BlblRva0J1dHRvbigpCiAgICAgICAgICAgIH0pLm9uKHsKICAgICAgICAgICAgICAgIG11dGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBAdG9kbyB0dXJuIG9mZiBhdWRpbyBvbiB0aGUgd2ViIHJ0YyBzdHJlYW0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgdW5tdXRlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQHRvZG8gdHVybiBvbiBhdWRpbyBvbiB0aGUgd2ViIHJ0YyBzdHJlYW0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgX3Nob3dFcnJvciA9IGZ1bmN0aW9uKGVycm9yTXNnKSB7CiAgICAgICAgICAgIC8vIERpc3BsYXkgdGhlIGVycm9yIG1lc3NhZ2UgaW5zaWRlIHRoZSBjb250YWluZXIsIGFzc3VtaW5nIGl0J3MKICAgICAgICAgICAgLy8gYmVlbiBjcmVhdGVkIGJ5IG5vdy4KICAgICAgICAgICAgaWYgKF9jb250YWluZXIpIF9jb250YWluZXIuYWRkRXJyb3IoZXJyb3JNc2cpOwogICAgICAgIH07CgoKICAgIHRoaXMucmVjb3JkUU9TID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmVjb3JkUU9TKCk7CiAgICB9OwoKICAgIHRoaXMuc3Vic2NyaWJlID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgT1QuZGVidWcoIk9ULlN1YnNjcmliZXI6IHN1YnNjcmliZSB0byAiICsgc3RyZWFtLmlkKTsKCiAgICAgICAgaWYgKF9zdGF0ZS5zdWJzY3JpYmluZykgewogICAgICAgICAgICAvLyBAdG9kbyBlcnJvcgogICAgICAgICAgICBPVC5lcnJvcigiT1QuU3Vic2NyaWJlci5TdWJzY3JpYmU6IENhbm5vdCBzdWJzY3JpYmUsIGFscmVhZHkgc3Vic2NyaWJpbmcuIik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZS5zZXQoJ0luaXQnKTsKCiAgICAgICAgaWYgKCFzdHJlYW0pIHsKICAgICAgICAgICAgLy8gQHRvZG8gZXJyb3IKICAgICAgICAgICAgT1QuZXJyb3IoIk9ULlN1YnNjcmliZXI6IE5vIHN0cmVhbSBwYXJhbWV0ZXIuIik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmIChfc3RyZWFtKSB7CiAgICAgICAgICAgIC8vIEB0b2RvIGVycm9yCiAgICAgICAgICAgIE9ULmVycm9yKCJPVC5TdWJzY3JpYmVyOiBBbHJlYWR5IHN1YnNjcmliZWQiKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX3N0cmVhbSA9IHN0cmVhbTsKICAgICAgICBfc3RyZWFtLm9uKHsKICAgICAgICAgICAgdXBkYXRlZDogc3RyZWFtVXBkYXRlZCwKICAgICAgICAgICAgZGVzdHJveWVkOiB0aGlzLmRpc2Nvbm5lY3QKICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgX2Zyb21Db25uZWN0aW9uSWQgPSBzdHJlYW0uY29ubmVjdGlvbi5jb25uZWN0aW9uSWQ7CiAgICAgICAgX3Byb3BlcnRpZXMubmFtZSA9IF9zdHJlYW0ubmFtZTsKICAgICAgICBfcHJvcGVydGllcy5jbGFzc05hbWVzID0gJ09UX3Jvb3QgT1Rfc3Vic2NyaWJlcic7CgogICAgICAgIGlmIChfcHJvcGVydGllcy5zdHlsZSkgewogICAgICAgICAgICB0aGlzLnNldFN0eWxlKF9wcm9wZXJ0aWVzLnN0eWxlLCBudWxsLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKF9wcm9wZXJ0aWVzLmF1ZGlvVm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXVkaW9Wb2x1bWUoX3Byb3BlcnRpZXMuYXVkaW9Wb2x1bWUpOwogICAgICAgIH0KCiAgICAgICAgX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9BdWRpbyA9IE9ULiQuY2FzdFRvQm9vbGVhbihfcHJvcGVydGllcy5zdWJzY3JpYmVUb0F1ZGlvLCB0cnVlKTsKICAgICAgICBfcHJvcGVydGllcy5zdWJzY3JpYmVUb1ZpZGVvID0gT1QuJC5jYXN0VG9Cb29sZWFuKF9wcm9wZXJ0aWVzLnN1YnNjcmliZVRvVmlkZW8sIHRydWUpOwoKICAgICAgICBfY29udGFpbmVyID0gbmV3IE9ULldpZGdldFZpZXcodGFyZ2V0RWxlbWVudCwgX3Byb3BlcnRpZXMpOwogICAgICAgIF9kb21JZCA9IF9jb250YWluZXIuZG9tSWQ7CgogICAgICAgIGlmKCFfcHJvcGVydGllcy5zdWJzY3JpYmVUb1ZpZGVvICYmIE9ULiQuYnJvd3NlcigpID09ICdDaHJvbWUnKSB7CiAgICAgICAgICAgIF9zdWJzY3JpYmVBdWRpb0ZhbHNlV29ya2Fyb3VuZCA9IHRydWU7CiAgICAgICAgICAgIF9wcm9wZXJ0aWVzLnN1YnNjcmliZVRvVmlkZW8gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgX3N0YXJ0Q29ubmVjdGluZ1RpbWUgPSBPVC4kLm5vdygpOwoKICAgICAgICBpZiAoX3N0cmVhbS5jb25uZWN0aW9uLmlkICE9PSBfc2Vzc2lvbi5jb25uZWN0aW9uLmlkKSB7CiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdjcmVhdGVQZWVyQ29ubmVjdGlvbicsICdBdHRlbXB0JywgJycsICcnKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0Nvbm5lY3RpbmdUb1BlZXInKTsKCiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbiA9IG5ldyBPVC5TdWJzY3JpYmVyUGVlckNvbm5lY3Rpb24oX3N0cmVhbS5jb25uZWN0aW9uLCBfc2Vzc2lvbiwgX3N0cmVhbSwgX3Byb3BlcnRpZXMpOwoKICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uLm9uKHsKICAgICAgICAgICAgICAgIGRpc2Nvbm5lY3RlZDogb25EaXNjb25uZWN0ZWQsCiAgICAgICAgICAgICAgICBlcnJvcjogb25QZWVyQ29ubmVjdGlvbkZhaWx1cmUsCiAgICAgICAgICAgICAgICByZW1vdGVTdHJlYW1BZGRlZDogb25SZW1vdGVTdHJlYW1BZGRlZCwKICAgICAgICAgICAgICAgIHJlbW90ZVN0cmVhbVJlbW92ZWQ6IG9uUmVtb3RlU3RyZWFtUmVtb3ZlZAogICAgICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgICAgIC8vIGluaXRpYWxpemUgdGhlIHBlZXIgY29ubmVjdGlvbiBBRlRFUiB3ZSd2ZSBhZGRlZCB0aGUgZXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5pbml0KCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgnY3JlYXRlUGVlckNvbm5lY3Rpb24nLCAnQXR0ZW1wdCcsICcnLCAnJyk7CgogICAgICAgICAgICAvLyBTdWJzY3JpYmUgdG8geW91cnNlbGYgZWRnZS1jYXNlCiAgICAgICAgICAgIG9uUmVtb3RlU3RyZWFtQWRkZWQuY2FsbCh0aGlzLCBfc2Vzc2lvbi5nZXRQdWJsaXNoZXJGb3JTdHJlYW0oX3N0cmVhbSkuXy53ZWJSdGNTdHJlYW0pOwogICAgICAgIH0KCiAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3N1YnNjcmliZScsICdBdHRlbXB0JywgJ3N0cmVhbUlkJywgX3N0cmVhbS5pZCk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigvKiB1bnVzZWQgKi8gcmVhc29uLCBxdWlldCkgewogICAgICAgIGNsZWFySW50ZXJ2YWwoX3Fvc0ludGVydmFsKTsKICAgICAgICBfcW9zSW50ZXJ2YWwgPSBudWxsOwoKICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoKTsKCiAgICAgICAgaWYgKF9jaHJvbWUpIHsKICAgICAgICAgICAgX2Nocm9tZS5kZXN0cm95KCk7CiAgICAgICAgICAgIF9jaHJvbWUgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9jb250YWluZXIpIHsKICAgICAgICAgICAgX2NvbnRhaW5lci5kZXN0cm95KCk7CiAgICAgICAgICAgIF9jb250YWluZXIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9zdHJlYW0gJiYgIV9zdHJlYW0uZGVzdHJveWVkKSBsb2dBbmFseXRpY3NFdmVudCgndW5zdWJzY3JpYmUnLCBudWxsLCAnc3RyZWFtSWQnLCBfc3RyZWFtLmlkKTsKCiAgICAgICAgX2RvbUlkID0gbnVsbDsKICAgICAgICBfc3RyZWFtID0gbnVsbDsKCiAgICAgICAgX3Nlc3Npb24gPSBudWxsOwogICAgICAgIF9wcm9wZXJ0aWVzID0gbnVsbDsKCiAgICAgICAgaWYgKHF1aWV0ICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCgKICAgICAgICAgICAgICBuZXcgT1QuRGVzdHJveWVkRXZlbnQoCiAgICAgICAgICAgICAgICBPVC5FdmVudC5uYW1lcy5TVUJTQ1JJQkVSX0RFU1RST1lFRCwKICAgICAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgICAgICByZWFzb24KICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIHRoaXMub2ZmLmJpbmQodGhpcykKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgdGhpcy5kaXNjb25uZWN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgX3N0YXRlLnNldCgnTm90U3Vic2NyaWJpbmcnKTsKCiAgICAgICAgaWYgKF9zdHJlYW1Db250YWluZXIpIHsKICAgICAgICAgICAgX3N0cmVhbUNvbnRhaW5lci5kZXN0cm95KCk7CiAgICAgICAgICAgIF9zdHJlYW1Db250YWluZXIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24uZGVzdHJveSgpOwogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24gPSBudWxsOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2Rpc2Nvbm5lY3QnLCAnUGVlckNvbm5lY3Rpb24nLCAnc3RyZWFtSWQnLCBfc3RyZWFtLmlkKTsKICAgICAgICB9CiAgICB9OwoKICAgIHRoaXMucHJvY2Vzc01lc3NhZ2UgPSBmdW5jdGlvbih0eXBlLCBmcm9tQ29ubmVjdGlvbiwgbWVzc2FnZSkgewogICAgICAgIE9ULmRlYnVnKCJPVC5TdWJzY3JpYmVyLnByb2Nlc3NNZXNzYWdlOiBSZWNlaXZlZCAiICsgdHlwZSArICIgbWVzc2FnZSBmcm9tICIgKyBmcm9tQ29ubmVjdGlvbi5pZCk7CiAgICAgICAgT1QuZGVidWcobWVzc2FnZSk7CgogICAgICAgIGlmIChfZnJvbUNvbm5lY3Rpb25JZCAhPSBmcm9tQ29ubmVjdGlvbi5pZCkgewogICAgICAgICAgICBfZnJvbUNvbm5lY3Rpb25JZCA9IGZyb21Db25uZWN0aW9uLmlkOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgX3BlZXJDb25uZWN0aW9uLnByb2Nlc3NNZXNzYWdlKHR5cGUsIG1lc3NhZ2UpOwogICAgICAgIH0KICAgIH07CgogICAgdGhpcy51cGRhdGVRdWFsaXR5ID0gZnVuY3Rpb24ocXVhbGl0eSkgewogICAgICAgIC8vIEN1cnJlbnRseSwgdGhpcyBvbmx5IGRpc2FibGVzIHRoZSB2aWRlbyBhbmQgZGlzcmVnYXJkcwogICAgICAgIC8vIHRoZSBxdWFsaXR5LgogICAgICAgIHRoaXMuc3Vic2NyaWJlVG9WaWRlbyhmYWxzZSk7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBPVC5FdmVudCgidmlkZW9EaXNhYmxlZCIpKTsKICAgIH07CgogICAgLyoqCiAgICAqIFJldHVybiB0aGUgYmFzZS02NC1lbmNvZGVkIHN0cmluZyBvZiBQTkcgZGF0YSByZXByZXNlbnRpbmcgdGhlIFN1YnNjcmliZXIgdmlkZW8uCiAgICAqCiAgICAqICA8cD5Zb3UgY2FuIHVzZSB0aGUgc3RyaW5nIGFzIHRoZSB2YWx1ZSBmb3IgYSBkYXRhIFVSTCBzY2hlbWUgcGFzc2VkIHRvIHRoZSBzcmMgcGFyYW1ldGVyIG9mCiAgICAqICBhbiBpbWFnZSBmaWxlLCBhcyBpbiB0aGUgZm9sbG93aW5nOjwvcD4KICAgICoKICAgICogIDxwcmU+CiAgICAqICB2YXIgaW1nRGF0YSA9IHN1YnNjcmliZXIuZ2V0SW1nRGF0YSgpOwogICAgKgogICAgKiAgdmFyIGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgKiAgaW1nLnNldEF0dHJpYnV0ZSgic3JjIiwgImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCwiICsgaW1nRGF0YSk7CiAgICAqICB2YXIgaW1nV2luID0gd2luZG93Lm9wZW4oImFib3V0OmJsYW5rIiwgIlNjcmVlbnNob3QiKTsKICAgICogIGltZ1dpbi5kb2N1bWVudC53cml0ZSgiJmx0O2JvZHkmZ3Q7Jmx0Oy9ib2R5Jmd0OyIpOwogICAgKiAgaW1nV2luLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICogIDwvcHJlPgogICAgKiBAbWV0aG9kICNnZXRJbWdEYXRhCiAgICAqIEBtZW1iZXJPZiBTdWJzY3JpYmVyCiAgICAqIEByZXR1cm4ge1N0cmluZ30gVGhlIGJhc2UtNjQgZW5jb2RlZCBzdHJpbmcuIFJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGlmIHRoZXJlIGlzIG5vIHZpZGVvLgogICAgKi8KICAgIHRoaXMuZ2V0SW1nRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5zdWJzY3JpYmluZykgewogICAgICAgICAgICBPVC5lcnJvcigiT1QuU3Vic2NyaWJlci5nZXRJbWdEYXRhOiBDYW5ub3QgZ2V0SW1nRGF0YSBiZWZvcmUgdGhlIFN1YnNjcmliZXIgaXMgc3Vic2NyaWJpbmcuIik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIF9zdHJlYW1Db250YWluZXIuaW1nRGF0YTsKICAgIH07CgogICAgLyoqCiAgICAqIFNldHMgdGhlIGF1ZGlvIHZvbHVtZSwgYmV0d2VlbiAwIGFuZCAxMDAsIG9mIHRoZSBTdWJzY3JpYmVyLgogICAgKgogICAgKiA8cD5Zb3UgY2FuIHNldCB0aGUgaW5pdGlhbCB2b2x1bWUgd2hlbiB5b3UgY2FsbCB0aGUgPGNvZGU+U2Vzc2lvbi5zdWJzY3JpYmUoKTwvY29kZT4KICAgICogbWV0aG9kLiBQYXNzIGEgPGNvZGU+YXVkaW9Wb2x1bWU8L2NvZGU+IHByb3BlcnR5IG9mIHRoZSA8Y29kZT5wcm9wZXJ0aWVzPC9jb2RlPiBwYXJhbWV0ZXIKICAgICogb2YgdGhlIG1ldGhvZC48L3A+CiAgICAqCiAgICAqIEBwYXJhbSB7TnVtYmVyfSB2YWx1ZSBUaGUgYXVkaW8gdm9sdW1lLCBiZXR3ZWVuIDAgYW5kIDEwMC4KICAgICoKICAgICogQHJldHVybiB7U3Vic2NyaWJlcn0gVGhlIFN1YnNjcmliZXIgb2JqZWN0LiBUaGlzIGxldHMgeW91IGNoYWluIG1ldGhvZCBjYWxscywgYXMgaW4gdGhlIGZvbGxvd2luZzoKICAgICoKICAgICogPHByZT5teVN1YnNjcmliZXIuc2V0QXVkaW9Wb2x1bWUoNTApLnNldFN0eWxlKG5ld1N0eWxlKTs8L3ByZT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSIjZ2V0QXVkaW9Wb2x1bWUiPmdldEF1ZGlvVm9sdW1lKCk8L2E+CiAgICAqIEBzZWUgPGEgaHJlZj0iU2Vzc2lvbi5odG1sI3N1YnNjcmliZSI+U2Vzc2lvbi5zdWJzY3JpYmUoKTwvYT4KICAgICogQG1ldGhvZCAjc2V0QXVkaW9Wb2x1bWUKICAgICogQG1lbWJlck9mIFN1YnNjcmliZXIKICAgICovCiAgICB0aGlzLnNldEF1ZGlvVm9sdW1lID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YWx1ZSA9IHBhcnNlSW50KHZhbHVlLCAxMCk7CiAgICAgICAgaWYgKGlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICBPVC5lcnJvcigiT1QuU3Vic2NyaWJlci5zZXRBdWRpb1ZvbHVtZTogdmFsdWUgc2hvdWxkIGJlIGFuIGludGVnZXIgYmV0d2VlbiAwIGFuZCAxMDAiKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIF9hdWRpb1ZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgdmFsdWUpKTsKICAgICAgICBpZiAoX2F1ZGlvVm9sdW1lICE9IHZhbHVlKSB7CiAgICAgICAgICAgIE9ULndhcm4oIk9ULlN1YnNjcmliZXIuc2V0QXVkaW9Wb2x1bWU6IHZhbHVlIHNob3VsZCBiZSBhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgMTAwIik7CiAgICAgICAgfQogICAgICAgIGlmIChfc3RyZWFtQ29udGFpbmVyKSB7CiAgICAgICAgICAgIF9zdHJlYW1Db250YWluZXIuc2V0QXVkaW9Wb2x1bWUoX2F1ZGlvVm9sdW1lKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgYXVkaW8gdm9sdW1lLCBiZXR3ZWVuIDAgYW5kIDEwMCwgb2YgdGhlIFN1YnNjcmliZXIuCiAgICAqCiAgICAqIDxwPkdlbmVyYWxseSB5b3UgdXNlIHRoaXMgbWV0aG9kIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIDxjb2RlPnNldEF1ZGlvVm9sdW1lKCk8L2NvZGU+IG1ldGhvZC48L3A+CiAgICAqCiAgICAqIEByZXR1cm4ge051bWJlcn0gVGhlIGF1ZGlvIHZvbHVtZSwgYmV0d2VlbiAwIGFuZCAxMDAsIG9mIHRoZSBTdWJzY3JpYmVyLgogICAgKiBAc2VlIDxhIGhyZWY9IiNzZXRBdWRpb1ZvbHVtZSI+c2V0QXVkaW9Wb2x1bWUoKTwvYT4KICAgICogQG1ldGhvZCAjZ2V0QXVkaW9Wb2x1bWUKICAgICogQG1lbWJlck9mIFN1YnNjcmliZXIKICAgICovCiAgICB0aGlzLmdldEF1ZGlvVm9sdW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKF9zdHJlYW1Db250YWluZXIpIHJldHVybiBfc3RyZWFtQ29udGFpbmVyLmdldEF1ZGlvVm9sdW1lKCk7CiAgICAgICAgZWxzZSByZXR1cm4gX2F1ZGlvVm9sdW1lOwogICAgfTsKCiAgICAvKioKICAgICogVG9nZ2xlcyBhdWRpbyBvbiBhbmQgb2ZmLiBTdGFydHMgc3Vic2NyaWJpbmcgdG8gYXVkaW8gKGlmIGl0IGlzIGF2YWlsYWJsZSBhbmQgY3VycmVudGx5IG5vdCBiZWluZwogICAgKiBzdWJzY3JpYmVkIHRvKSB3aGVuIHRoZSA8Y29kZT52YWx1ZTwvY29kZT4gaXMgPGNvZGU+dHJ1ZTwvY29kZT47IHN0b3BzIHN1YnNjcmliaW5nIHRvIGF1ZGlvCiAgICAqIChpZiBpdCBpcyBjdXJyZW50bHkgYmVpbmcgc3Vic2NyaWJlZCB0bykgd2hlbiB0aGUgPGNvZGU+dmFsdWU8L2NvZGU+IGlzIDxjb2RlPmZhbHNlPC9jb2RlPi4KICAgICogPHA+CiAgICAqIDxpPk5vdGU6PC9pPiBUaGlzIG1ldGhvZCBvbmx5IGFmZmVjdHMgdGhlIGxvY2FsIHBsYXliYWNrIG9mIGF1ZGlvLiBJdCBoYXMgbm8gaW1wYWN0IG9uIHRoZSBhdWRpbwogICAgKiBmb3Igb3RoZXIgY29ubmVjdGlvbnMgc3Vic2NyaWJpbmcgdG8gdGhlIHNhbWUgc3RyZWFtLiBJZiB0aGUgUHVibHNoZXIgaXMgbm90IHB1Ymxpc2hpbmcgYXVkaW8sCiAgICAqIGVuYWJsaW5nIHRoZSBTdWJzY3JpYmVyIGF1ZGlvIHdpbGwgaGF2ZSBubyBwcmFjdGljYWwgZWZmZWN0LgogICAgKiA8L3A+CiAgICAqCiAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gdmFsdWUgV2hldGhlciB0byBzdGFydCBzdWJzY3JpYmluZyB0byBhdWRpbyAoPGNvZGU+dHJ1ZTwvY29kZT4pIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4KICAgICoKICAgICogQHJldHVybiB7U3Vic2NyaWJlcn0gVGhlIFN1YnNjcmliZXIgb2JqZWN0LiBUaGlzIGxldHMgeW91IGNoYWluIG1ldGhvZCBjYWxscywgYXMgaW4gdGhlIGZvbGxvd2luZzoKICAgICoKICAgICogPHByZT5teVN1YnNjcmliZXIuc3Vic2NyaWJlVG9BdWRpbyh0cnVlKS5zdWJzY3JpYmVUb1ZpZGVvKGZhbHNlKTs8L3ByZT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSIjc3Vic2NyaWJlVG9WaWRlbyI+c3Vic2NyaWJlVG9WaWRlbygpPC9hPgogICAgKiBAc2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNzdWJzY3JpYmUiPlNlc3Npb24uc3Vic2NyaWJlKCk8L2E+CiAgICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQuaHRtbCI+U3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQ8L2E+CiAgICAqCiAgICAqIEBtZXRob2QgI3N1YnNjcmliZVRvQXVkaW8KICAgICogQG1lbWJlck9mIFN1YnNjcmliZXIKICAgICovCiAgICB0aGlzLnN1YnNjcmliZVRvQXVkaW8gPSBmdW5jdGlvbihwX3ZhbHVlKSB7CiAgICAgICAgdmFyIHZhbHVlID0gT1QuJC5jYXN0VG9Cb29sZWFuKHBfdmFsdWUsIHRydWUpOwoKICAgICAgICBpZiAoX3BlZXJDb25uZWN0aW9uKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5zdWJzY3JpYmVUb0F1ZGlvKHZhbHVlKTsKCiAgICAgICAgICAgIGlmIChfc2Vzc2lvbiAmJiBfc3RyZWFtICYmIHZhbHVlICE9PSBfcHJvcGVydGllcy5zdWJzY3JpYmVUb0F1ZGlvKSB7CiAgICAgICAgICAgICAgICBfc2Vzc2lvbi5fLm1vZGlmeVN1YnNjcmliZXIodGhpcywgImhhc0F1ZGlvIiwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfcHJvcGVydGllcy5zdWJzY3JpYmVUb0F1ZGlvID0gdmFsdWU7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgLyoqCiAgICAqIFRvZ2dsZXMgdmlkZW8gb24gYW5kIG9mZi4gU3RhcnRzIHN1YnNjcmliaW5nIHRvIHZpZGVvIChpZiBpdCBpcyBhdmFpbGFibGUgYW5kIGN1cnJlbnRseSBub3QgYmVpbmcKICAgICogc3Vic2NyaWJlZCB0bykgd2hlbiB0aGUgPGNvZGU+dmFsdWU8L2NvZGU+IGlzIDxjb2RlPnRydWU8L2NvZGU+OyBzdG9wcyBzdWJzY3JpYmluZyB0byB2aWRlbwogICAgKiAoaWYgaXQgaXMgY3VycmVudGx5IGJlaW5nIHN1YnNjcmliZWQgdG8pIHdoZW4gdGhlIDxjb2RlPnZhbHVlPC9jb2RlPiBpcyA8Y29kZT5mYWxzZTwvY29kZT4uCiAgICAqIDxwPgogICAgKiA8aT5Ob3RlOjwvaT4gVGhpcyBtZXRob2Qgb25seSBhZmZlY3RzIHRoZSBsb2NhbCBwbGF5YmFjayBvZiB2aWRlby4gSXQgaGFzIG5vIGltcGFjdCBvbiB0aGUgdmlkZW8KICAgICogZm9yIG90aGVyIGNvbm5lY3Rpb25zIHN1YnNjcmliaW5nIHRvIHRoZSBzYW1lIHN0cmVhbS4gSWYgdGhlIFB1YmxzaGVyIGlzIG5vdCBwdWJsaXNoaW5nIHZpZGVvLAogICAgKiBlbmFibGluZyB0aGUgU3Vic2NyaWJlciB2aWRlbyB3aWxsIGhhdmUgbm8gcHJhY3RpY2FsIHZpZGVvLgogICAgKiA8L3A+CiAgICAqCiAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gdmFsdWUgV2hldGhlciB0byBzdGFydCBzdWJzY3JpYmluZyB0byB2aWRlbyAoPGNvZGU+dHJ1ZTwvY29kZT4pIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4KICAgICoKICAgICogQHJldHVybiB7U3Vic2NyaWJlcn0gVGhlIFN1YnNjcmliZXIgb2JqZWN0LiBUaGlzIGxldHMgeW91IGNoYWluIG1ldGhvZCBjYWxscywgYXMgaW4gdGhlIGZvbGxvd2luZzoKICAgICoKICAgICogPHByZT5teVN1YnNjcmliZXIuc3Vic2NyaWJlVG9WaWRlbyh0cnVlKS5zdWJzY3JpYmVUb0F1ZGlvKGZhbHNlKTs8L3ByZT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSIjc3Vic2NyaWJlVG9BdWRpbyI+c3Vic2NyaWJlVG9BdWRpbygpPC9hPgogICAgKiBAc2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNzdWJzY3JpYmUiPlNlc3Npb24uc3Vic2NyaWJlKCk8L2E+CiAgICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQuaHRtbCI+U3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQ8L2E+CiAgICAqCiAgICAqIEBtZXRob2QgI3N1YnNjcmliZVRvVmlkZW8KICAgICogQG1lbWJlck9mIFN1YnNjcmliZXIKICAgICovCiAgICB0aGlzLnN1YnNjcmliZVRvVmlkZW8gPSBmdW5jdGlvbihwX3ZhbHVlKSB7CiAgICAgICAgaWYoX3N1YnNjcmliZUF1ZGlvRmFsc2VXb3JrYXJvdW5kICYmIHBfdmFsdWUgPT0gdHJ1ZSkgewogICAgICAgICAgICAvLyBUdXJuIG9mZiB0aGUgd29ya2Fyb3VuZCBpZiB0aGV5IGVuYWJsZSB0aGUgdmlkZW8KICAgICAgICAgICAgX3N1YnNjcmliZUF1ZGlvRmFsc2VXb3JrYXJvdW5kID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB2YWx1ZSA9IE9ULiQuY2FzdFRvQm9vbGVhbihwX3ZhbHVlLCB0cnVlKTsKCiAgICAgICAgaWYoX2NvbnRhaW5lcikgewogICAgICAgICAgICBfY29udGFpbmVyLnNob3dQb3N0ZXIgPSAhKHZhbHVlICYmIF9zdHJlYW0uaGFzVmlkZW8pOwogICAgICAgICAgICBpZih2YWx1ZSAmJiBfY29udGFpbmVyLnZpZGVvKSB7CiAgICAgICAgICAgICAgICBfY29udGFpbmVyLmxvYWRpbmcgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIF9jb250YWluZXIudmlkZW8ud2hlblRpbWVJbmNyZW1lbnRzKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRhaW5lci5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24uc3Vic2NyaWJlVG9WaWRlbyh2YWx1ZSk7CgogICAgICAgICAgICBpZiAoX3Nlc3Npb24gJiYgX3N0cmVhbSAmJiB2YWx1ZSAhPT0gX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9WaWRlbykgewogICAgICAgICAgICAgICAgX3Nlc3Npb24uXy5tb2RpZnlTdWJzY3JpYmVyKHRoaXMsICJoYXNWaWRlbyIsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9WaWRlbyA9IHZhbHVlOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAgIGlkOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfZG9tSWQ7IH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9LAoKICAgICAgICB3aWRnZXRJZDogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3dpZGdldElkOyB9CiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfc3RyZWFtOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtSWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghX3N0cmVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICAgICAgcmV0dXJuIF9zdHJlYW0uaWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9LAoKICAgICAgICB0YXJnZXRFbGVtZW50OiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfc3RyZWFtQ29udGFpbmVyID8gX3N0cmVhbUNvbnRhaW5lci5kb21FbGVtZW50IDogbnVsbDsgfQogICAgICAgIH0sCgogICAgICAgIHN1YnNjcmliaW5nOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfc3RhdGUuc3Vic2NyaWJpbmc7IH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9LAoKICAgICAgICBpc1dlYlJUQzogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgIH0sCgogICAgICAgIGxvYWRpbmc6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpeyByZXR1cm4gX2NvbnRhaW5lciAmJiBfY29udGFpbmVyLmxvYWRpbmcgfQogICAgICAgIH0sCgogICAgICAgIHNlc3Npb246IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uOyB9CiAgICAgICAgfQogICAgfSk7CgogICAgdGhpcy5vbignc3R5bGVWYWx1ZUNoYW5nZWQnLCB1cGRhdGVDaHJvbWVGb3JTdHlsZUNoYW5nZSwgdGhpcyk7CgogICAgX3N0YXRlID0gbmV3IE9ULlN1YnNjcmliaW5nU3RhdGUoc3RhdGVDaGFuZ2VGYWlsZWQpOwoKICAvKioKICAqIERpc3BhdGNoZWQgd2hlbiB0aGUgT3BlblRvayBtZWRpYSBzZXJ2ZXIgc3RvcHMgc2VuZGluZyB2aWRlbyB0byB0aGUgc3Vic2NyaWJlci4KICAqIFRoaXMgZmVhdHVyZSBvZiB0aGUgT3BlblRvayBtZWRpYSBzZXJ2ZXIgaGFzIGEgc3Vic2NyaWJlciBkcm9wIHRoZSB2aWRlbyBzdHJlYW0KICAqIHdoZW4gY29ubmVjdGl2aXR5IGRlZ3JhZGVzLiBUaGUgc3Vic2NyaWJlciBjb250aW51ZXMgdG8gcmVjZWl2ZSB0aGUgYXVkaW8gc3RyZWFtLAogICogaWYgdGhlcmUgaXMgb25lLiBUaGlzIGZlYXR1cmUgaXMgb25seSBhdmFpbGFibGUgaW4gc2Vzc2lvbnMgdGhhdCB1c2UgdGhlIE9wZW5Ub2sKICAqIG1lZGlhIHNlcnZlciwgbm90IGluIHBlZXItdG8tcGVlciBzZXNzaW9ucy4KICAqIEBuYW1lIHZpZGVvRGlzYWJsZWQKICAqIEBldmVudAogICogQG1lbWJlcm9mIFN1YnNjcmliZXIKICAqLwoKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKICAgIE9ULlNlc3Npb25JbmZvID0gZnVuY3Rpb24oeG1sRG9jdW1lbnQpIHsKICAgICAgICB2YXIgc2Vzc2lvblhNTCA9IG51bGw7CgogICAgICAgIHRoaXMuc2Vzc2lvbklkID0gbnVsbDsKICAgICAgICB0aGlzLnBhcnRuZXJJZCA9IG51bGw7CiAgICAgICAgdGhpcy5zZXNzaW9uU3RhdHVzID0gbnVsbDsKICAgICAgICB0aGlzLnAycEVuYWJsZWQgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5tZXNzYWdpbmdTZXJ2ZXIgPSBudWxsOwogICAgICAgIHRoaXMuaWNlU2VydmVycyA9IG51bGw7CgogICAgICAgIE9ULmxvZygiU2Vzc2lvbkluZm8gUmVzcG9uc2U6IikKICAgICAgICBPVC5sb2coeG1sRG9jdW1lbnQpOwoKICAgICAgICBpZiAoeG1sRG9jdW1lbnQgJiYgeG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIHhtbERvY3VtZW50LmRvY3VtZW50RWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBzZXNzaW9uWE1MID0geG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVsZW1lbnQgPSBzZXNzaW9uWE1MLmZpcnN0RWxlbWVudENoaWxkOwogICAgICAgIGRvIHsKICAgICAgICAgICAgc3dpdGNoIChlbGVtZW50LmxvY2FsTmFtZSkgewogICAgICAgICAgICBjYXNlICJzZXNzaW9uX2lkIjoKICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gZWxlbWVudC50ZXh0Q29udGVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAicGFydG5lcl9pZCI6CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRuZXJJZCA9IGVsZW1lbnQudGV4dENvbnRlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgInNlc3Npb25fc3RhdHVzIjoKICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvblN0YXR1cyA9IGVsZW1lbnQudGV4dENvbnRlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgIm1lc3NhZ2luZ19zZXJ2ZXJfdXJsIjoKICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnaW5nU2VydmVyID0gZWxlbWVudC50ZXh0Q29udGVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAiaWNlX3NlcnZlcnMiOgogICAgICAgICAgICAgICAgLy8gPGljZV9zZXJ2ZXJzPgogICAgICAgICAgICAgICAgLy8gICAgIDxpY2Vfc2VydmVyIHVybD0iZm9vLmNvbSIgLz4KICAgICAgICAgICAgICAgIC8vICAgICA8aWNlX3NlcnZlciB1cmw9ImJhci5jb20iIGNyZWRlbnRpYWw9Inh4eCIgLz4KICAgICAgICAgICAgICAgIC8vIDwvaWNlX3NlcnZlcnM+CgogICAgICAgICAgICAgICAgdGhpcy5pY2VTZXJ2ZXJzID0gbm9ybWFsaXNlSWNlU2VydmVycyggcGFyc2VJY2VTZXJ2ZXJzWG1sKGVsZW1lbnQuY2hpbGROb2RlcykgKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pY2VTZXJ2ZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmVuJ3QgZ290IGFueSBJQ0UgU2VydmVycyBmcm9tIEFudmlsLCBkZWZhdWx0IHRvIHNvbWV0aGluZwogICAgICAgICAgICAgICAgICAgIE9ULndhcm4oIlNlc3Npb25JbmZvIGNvbnRhaW5lZCBub3QgSUNFIFNlcnZlcnMsIHVzaW5nIHRoZSBkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pY2VTZXJ2ZXJzID0gWyB7InVybCI6ICJzdHVuOnN0dW4ubC5nb29nbGUuY29tOjE5MzAyIn0gXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgInByb3BlcnRpZXMiOgogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5ID0gZWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZDsKICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5LmxvY2FsTmFtZSA9PT0gInAycCIgJiYgcHJvcGVydHkuZmlyc3RFbGVtZW50Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucDJwRW5hYmxlZCA9IChwcm9wZXJ0eS5maXJzdEVsZW1lbnRDaGlsZC50ZXh0Q29udGVudCA9PT0gImVuYWJsZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocHJvcGVydHkgPSBwcm9wZXJ0eS5uZXh0RWxlbWVudFNpYmxpbmcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIC8vIE9ULmRlYnVnKCJPVC5TZXNzaW9uSW5mbyBlbGVtZW50IHdhcyBub3QgaGFuZGxlZCAoIiArIGVsZW1lbnQubG9jYWxOYW1lICsgIikiKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgIH0gd2hpbGUgKGVsZW1lbnQgPSBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZyk7CgogICAgICAgIC8vd2UndmUgcGFyc2VkIHRoZSBYTUwgaW50byB0aGUgb2JqZWN0CgogICAgICAgIHNlc3Npb25YTUwgPSBudWxsOwogICAgfTsKCgovLyBSZXRyaWV2ZXMgU2Vzc2lvbiBJbmZvIGZvciArc2Vzc2lvbisuIFRoZSBTZXNzaW9uSW5mbyBvYmplY3Qgd2lsbCBiZSBwYXNzZWQKLy8gdG8gdGhlICtvblN1Y2Nlc3MrIGNhbGxiYWNrLiBUaGUgK29uRmFpbHVyZSsgY2FsbGJhY2sgd2lsbCBiZSBwYXNzZWQgYW4gZXJyb3IKLy8gb2JqZWN0IGFuZCB0aGUgRE9NRXZlbnQgdGhhdCByZWxhdGVzIHRvIHRoZSBlcnJvci4KT1QuU2Vzc2lvbkluZm8uZ2V0ID0gZnVuY3Rpb24oc2Vzc2lvbiwgb25TdWNjZXNzLCBvbkZhaWx1cmUpIHsKICAgIHZhciBzZXNzaW9uSW5mb1VSTCA9IE9ULnByb3BlcnRpZXMuYXBpVVJMICsgJy9zZXNzaW9uLycgKyBzZXNzaW9uLmlkICsgIj9leHRlbmRlZD10cnVlIiwKCiAgICAgICAgc3RhcnRUaW1lID0gT1QuJC5ub3coKSwKCiAgICAgICAgdmFsaWRhdGVSYXdTZXNzaW9uSW5mbyA9IGZ1bmN0aW9uKHNlc3Npb25JbmZvKSB7CiAgICAgICAgICAgIHNlc3Npb24ubG9nRXZlbnQoJ0luc3RydW1lbnRhdGlvbicsIG51bGwsICdnc2knLCBPVC4kLm5vdygpIC0gc3RhcnRUaW1lKTsKCiAgICAgICAgICAgIHZhciBlcnJvciA9IHBhcnNlRXJyb3JGcm9tWE1MRG9jdW1lbnQoc2Vzc2lvbkluZm8pOwoKICAgICAgICAgICAgaWYgKGVycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgb25HZXRSZXNwb25zZUNhbGxiYWNrKHNlc3Npb24sIG9uU3VjY2Vzcywgc2Vzc2lvbkluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgb25HZXRFcnJvckNhbGxiYWNrKHNlc3Npb24sIG9uRmFpbHVyZSwgZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICBzZXNzaW9uLmxvZ0V2ZW50KCdnZXRTZXNzaW9uSW5mbycsICdBdHRlbXB0JywgJ2FwaV91cmwnLCBPVC5wcm9wZXJ0aWVzLmFwaVVSTCk7CgogICAgT1QuJC5nZXRYTUwoc2Vzc2lvbkluZm9VUkwsIHsKICAgICAgICBoZWFkZXJzOiB7IlgtVEItVE9LRU4tQVVUSCI6IHNlc3Npb24udG9rZW4sICJYLVRCLVZFUlNJT04iOiAxfSwKCiAgICAgICAgc3VjY2VzczogdmFsaWRhdGVSYXdTZXNzaW9uSW5mbywKCiAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIG9uR2V0RXJyb3JDYWxsYmFjayhzZXNzaW9uLCBvbkZhaWx1cmUsIHBhcnNlRXJyb3JGcm9tWE1MRG9jdW1lbnQoZXZlbnQudGFyZ2V0LnJlc3BvbnNlWE1MKSk7CiAgICAgICAgfQogICAgfSk7Cn07Cgp2YXIgbWVzc2FnZVNlcnZlclRvQ2xpZW50RXJyb3JDb2RlcyA9IHt9OwptZXNzYWdlU2VydmVyVG9DbGllbnRFcnJvckNvZGVzWyc0MDQnXSA9IE9ULkV4Y2VwdGlvbkNvZGVzLklOVkFMSURfU0VTU0lPTl9JRDsKbWVzc2FnZVNlcnZlclRvQ2xpZW50RXJyb3JDb2Rlc1snNDAzJ10gPSBPVC5FeGNlcHRpb25Db2Rlcy5BVVRIRU5USUNBVElPTl9FUlJPUjsKCi8vIFJldHVybiB0aGUgZXJyb3IgaW4gK3htbERvY3VtZW50KywgaWYgdGhlcmUgaXMgb25lLiBPdGhlcndpc2UgaXQgd2lsbCByZXR1cm4KLy8gZmFsc2UuCnBhcnNlRXJyb3JGcm9tWE1MRG9jdW1lbnQgPSBmdW5jdGlvbih4bWxEb2N1bWVudCkgewogICAgaWYgKHhtbERvY3VtZW50ICYmIHhtbERvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiB4bWxEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICB2YXIgZXJyb3JOb2RlcyA9IHhtbERvY3VtZW50LmV2YWx1YXRlKCcvL2Vycm9yJywgeG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBudWxsLCBYUGF0aFJlc3VsdC5PUkRFUkVEX05PREVfU05BUFNIT1RfVFlQRSwgbnVsbCApLAogICAgICAgICAgICBudW1FcnJvck5vZGVzID0gZXJyb3JOb2Rlcy5zbmFwc2hvdExlbmd0aDsKCiAgICAgICAgaWYgKG51bUVycm9yTm9kZXMgPT09IDApIHJldHVybiBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgaT0wOyBpPG51bUVycm9yTm9kZXM7ICsraSkgewogICAgICAgICAgICB2YXIgZXJyb3JOb2RlID0gZXJyb3JOb2Rlcy5zbmFwc2hvdEl0ZW0oaSk7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgY29kZTogZXJyb3JOb2RlLmdldEF0dHJpYnV0ZSgnY29kZScpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3JOb2RlLmZpcnN0RWxlbWVudENoaWxkLmdldEF0dHJpYnV0ZSgnbWVzc2FnZScpCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfQoKICAgIC8vIFRoZXJlIHdhcyBhbiBlcnJvciwgYnV0IHdlIGNvdWxkbid0IGZpbmQgdGhlIGVycm9yIGluZm8uCiAgICByZXR1cm4gewogICAgICAgIGNvZGU6IG51bGwsCiAgICAgICAgbWVzc2FnZTogIlVua25vd24gZXJyb3I6IGdldFNlc3Npb25JbmZvIFhNTCByZXNwb25zZSB3YXMgYmFkbHkgZm9ybWVkIgogICAgfTsKfTsKCm9uR2V0UmVzcG9uc2VDYWxsYmFjayA9IGZ1bmN0aW9uKHNlc3Npb24sIG9uU3VjY2VzcywgcmF3U2Vzc2lvbkluZm8pIHsKICBzZXNzaW9uLmxvZ0V2ZW50KCdnZXRTZXNzaW9uSW5mbycsICdTdWNjZXNzJywgJ2FwaV91cmwnLCBPVC5wcm9wZXJ0aWVzLmFwaVVSTCk7CgogIG9uU3VjY2VzcyggbmV3IE9ULlNlc3Npb25JbmZvKHJhd1Nlc3Npb25JbmZvKSApOwp9OwoKb25HZXRFcnJvckNhbGxiYWNrID0gZnVuY3Rpb24oc2Vzc2lvbiwgb25GYWlsdXJlLCBlcnJvcikgewogICAgVEIuaGFuZGxlSnNFeGNlcHRpb24oIlRCLlNlc3Npb25JbmZvRXJyb3IgOjogVW5hYmxlIHRvIGdldCBzZXNzaW9uIGluZm8gIiArIGVycm9yLm1lc3NhZ2UsIG1lc3NhZ2VTZXJ2ZXJUb0NsaWVudEVycm9yQ29kZXNbZXJyb3IuY29kZV0sIHsKICAgICAgICBzZXNzaW9uOiBzZXNzaW9uCiAgICB9KTsKCiAgICBzZXNzaW9uLmxvZ0V2ZW50KCdnZXRTZXNzaW9uSW5mbycsICdGYWlsdXJlJywgJ2Vycm9yTWVzc2FnZScsICJUQi5TZXNzaW9uSW5mb0Vycm9yIDo6IFVuYWJsZSB0byBnZXQgc2Vzc2lvbiBpbmZvICIgKyBlcnJvci5tZXNzYWdlKTsKICAgIG9uRmFpbHVyZShlcnJvciwgc2Vzc2lvbik7Cn07CgpwYXJzZUljZVNlcnZlcnNYbWwgPSBmdW5jdGlvbiAobm9kZXMpIHsKICAgIHZhciBpY2VTZXJ2ZXJzID0gW10sCiAgICAgICAgaWNlU2VydmVyLAogICAgICAgIGF0dHJpYnV0ZXM7CgogICAgZm9yICh2YXIgaT0wLCBudW1Ob2Rlcz1ub2Rlcy5sZW5ndGg7IGk8bnVtTm9kZXM7ICsraSkgewogICAgICAgIGlmIChub2Rlc1tpXS5sb2NhbE5hbWUgPT09ICdpY2Vfc2VydmVyJykgewogICAgICAgICAgICAvLyBAdG9kbyBwYXJzZSBlaXRoZXIgYSBVUkwgbm9kZSwgb3IgYSBVUkwgYW5kIGNyZWRlbnRpYWxzCiAgICAgICAgICAgIGF0dHJpYnV0ZXMgPSBub2Rlc1tpXS5hdHRyaWJ1dGVzOwogICAgICAgICAgICBpY2VTZXJ2ZXIgPSB7CiAgICAgICAgICAgICAgICB1cmw6IGF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCd1cmwnKS5ub2RlVmFsdWUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgnY3JlZGVudGlhbCcpICYmIGF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCdjcmVkZW50aWFsJykubm9kZVZhbHVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWNlU2VydmVyLmNyZWRlbnRpYWwgPSBhdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgnY3JlZGVudGlhbCcpLm5vZGVWYWx1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWNlU2VydmVycy5wdXNoKGljZVNlcnZlcik7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBpY2VTZXJ2ZXJzOwp9OwoKLy8gVGhpcyBpcyB1Z2x5LiBIZXJlIHdlIGFyZSBoYW5kbGluZyB0aGUgZm9sbG93aW5nOgovLyAxLiBGaXJlZm94IGRvZXNuJ3Qgc3VwcG9ydCBUVVJOIHVudGlsIHZlcnNpb24gMjUuIFdlIGZhbGxiYWNrIHRvIFNUVU4KLy8gaW4gcHJldmlvdXMgdmVyc2lvbnMuCi8vCi8vIDIuIEluIEZGID49IDIzIHRoZSBuZXcgc3ludGF4IGZvciBkZWNsYXJpbmcgSWNlIFNlcnZlcnMgd2l0aCBjcmVkZW50aWFscwovLyBpcyB1c2VkLiBpLmUuIHVybCwgY3JlZGVudGlhbCwgYW5kIHVzZXJuYW1lIGFzIG9wcG9zZWQgdG8ganVzdCB1cmwgYW5kIGNyZWRlbnRpYWwuCi8vCi8vIDMuIEZGID49IDI3IHN1cHBvcnRzIHRoZSBUVVJOIHRyYW5zcG9ydCBwYXJhbWV0ZXIsIGluIG9sZGVyIHZlcnNpb25zIHdlIG5lZWQKLy8gdG8gc3RyaXAgaXQgb3V0LgovLwpub3JtYWxpc2VJY2VTZXJ2ZXJzID0gZnVuY3Rpb24gKGljZVNlcnZlcnMpIHsKICAgIHZhciB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8oRmlyZWZveClcLyhbMC05XStcLlswLTldKykvKSwKICAgICAgICBmaXJlZm94VmVyc2lvbiA9IHVzZXJBZ2VudCA/IHBhcnNlRmxvYXQodXNlckFnZW50WzJdLCAxMCkgOiB2b2lkIDAsCiAgICAgICAgYml0czsKCiAgICByZXR1cm4gaWNlU2VydmVycy5tYXAoZnVuY3Rpb24oaWNlU2VydmVyKSB7CiAgICAgICAgLy8gV2UgZG9uJ3QgbmVlZCB0byBub3JtYWxpc2UgU1RVTiwganVzdCBwYXNzIGl0IG9uIHRocm91Z2gKICAgICAgICBpZiAoaWNlU2VydmVyLnVybC50cmltKCkuc3Vic3RyKDAsIDUpICE9PSAndHVybjonKSB7CiAgICAgICAgICAgIHJldHVybiBpY2VTZXJ2ZXI7CiAgICAgICAgfQoKICAgICAgICBpZiAodXNlckFnZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIC8vIFRVUk4gaXMgYnJva2VuIGluIHRoZXNlIHZlcnNpb25zIG9mIEZGOiBGYWxsYmFjayB0byBTVFVOLgogICAgICAgICAgICBpZiAoZmlyZWZveFZlcnNpb24gPCAyNSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHt1cmw6IGljZVNlcnZlci51cmwucmVwbGFjZSgidHVybjoiLCAic3R1bjoiKX07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZGIDwgMjcgZG9lc24ndCBzdXBwb3J0IHRoZSBUVVJOIHRyYW5zcG9ydCBwYXJhbWV0ZXIsIHNvIHdlIHN0cmlwIGl0IG91dAogICAgICAgICAgICBpZiAoZmlyZWZveFZlcnNpb24gPCAyNyAmJiBpY2VTZXJ2ZXIudXJsLmluZGV4T2YoJz8nKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIGljZVNlcnZlci51cmwgPSBpY2VTZXJ2ZXIudXJsLnRyaW0oKS5zcGxpdCgnPycpWzBdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBiaXRzID0gaWNlU2VydmVyLnVybC50cmltKCkuc3BsaXQoL1s6QF0vKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdXNlcm5hbWU6IGJpdHNbMV0sCiAgICAgICAgICAgIGNyZWRlbnRpYWw6IGljZVNlcnZlci5jcmVkZW50aWFsLAogICAgICAgICAgICB1cmw6IGJpdHNbMF0gKyAnOicgKyBiaXRzWzJdCiAgICAgICAgfTsKICAgIH0pOwp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewogIC8qKgogICAqIEEgY2xhc3MgZGVmaW5pbmcgcHJvcGVydGllcyBvZiB0aGUgPGNvZGU+Y2FwYWJpbGl0aWVzPC9jb2RlPiBwcm9wZXJ0eSBvZiBhCiAgICAgKiBTZXNzaW9uIG9iamVjdC4gU2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNjYXBhYmlsaXRlcyI+U2Vzc2lvbi5jYXBhYmlsaXRpZXM8L2E+LgogICAqIDxwPgogICAqIEFsbCBDYXBhYmlsaXRpZXMgcHJvcGVydGllcyBhcmUgdW5kZWZpbmVkIHVudGlsIHlvdSBoYXZlIGNvbm5lY3RlZCB0byBhIHNlc3Npb24KICAgKiBhbmQgdGhlIFNlc3Npb24gb2JqZWN0IGhhcyBkaXNwYXRjaGVkIHRoZSA8Y29kZT5zZXNzaW9uQ29ubmVjdGVkPC9jb2RlPiBldmVudC4KICAgKiA8cD4KICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiB0b2tlbiByb2xlcywgc2VlIHRoZSA8YSBocmVmPSJzZXJ2ZXJfc2lkZV9saWJyYXJpZXMuaHRtbCNnZW5lcmF0ZV90b2tlbiI+Z2VuZXJhdGVfdG9rZW4oKTwvYT4KICAgICAqIG1ldGhvZCBvZiB0aGUgT3BlblRvayBzZXJ2ZXItc2lkZSBsaWJyYXJpZXMuCiAgICoKICAgKiBAY2xhc3MgQ2FwYWJpbGl0aWVzCiAgICoKICAgKiBAcHJvcGVydHkge051bWJlcn0gZm9yY2VEaXNjb25uZWN0IFNwZWNpZmllcyB3aGV0aGVyIHlvdSBjYW4gY2FsbAogICAgIHRoZSA8Y29kZT5TZXNzaW9uLmZvcmNlRGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2QgKDEpIG9yIG5vdCAoMCkuIFRvIGNhbGwgdGhlIDxjb2RlPlNlc3Npb24uZm9yY2VEaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCwKICAgICB0aGUgdXNlciBtdXN0IGhhdmUgYSB0b2tlbiB0aGF0IGlzIGFzc2lnbmVkIHRoZSByb2xlIG9mIG1vZGVyYXRvci4KICAgKiBAcHJvcGVydHkge051bWJlcn0gZm9yY2VVbnB1Ymxpc2ggU3BlY2lmaWVzIHdoZXRoZXIgeW91IGNhbiBjYWxsCiAgICAgdGhlIDxjb2RlPlNlc3Npb24uZm9yY2VVbnB1Ymxpc2goKTwvY29kZT4gbWV0aG9kICgxKSBvciBub3QgKDApLiBUbyBjYWxsIHRoZSA8Y29kZT5TZXNzaW9uLmZvcmNlVW5wdWJsaXNoKCk8L2NvZGU+IG1ldGhvZCwKICAgICB0aGUgdXNlciBtdXN0IGhhdmUgYSB0b2tlbiB0aGF0IGlzIGFzc2lnbmVkIHRoZSByb2xlIG9mIG1vZGVyYXRvci4KICAgKiBAcHJvcGVydHkge051bWJlcn0gcHVibGlzaCBTcGVjaWZpZXMgd2hldGhlciB5b3UgY2FuIHB1Ymxpc2ggdG8gdGhlIHNlc3Npb24gKDEpIG9yIG5vdCAoMCkuCiAgICAgVGhlIGFiaWxpdHkgdG8gcHVibGlzaCBpcyBiYXNlZCBvbiBhIGZldyBmYWN0b3JzLiBUbyBwdWJsaXNoLCB0aGUgdXNlciBtdXN0IGhhdmUgYSB0b2tlbiB0aGF0CiAgICAgaXMgYXNzaWduZWQgYSByb2xlIHRoYXQgc3VwcG9ydHMgcHVibGlzaGluZy4gVGhlcmUgbXVzdCBiZSBhIGNvbm5lY3RlZCBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuCiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHN1YnNjcmliZSBTcGVjaWZpZXMgd2hldGhlciB5b3UgY2FuIHN1YnNjcmliZSB0byBzdHJlYW1zCiAgICAgaW4gdGhlIHNlc3Npb24gKDEpIG9yIG5vdCAoMCkuIEN1cnJlbnRseSwgdGhpcyBjYXBhYmlsaXR5IGlzIGF2YWlsYWJsZSBmb3IgYWxsIHVzZXJzIG9uIGFsbCBwbGF0Zm9ybXMuCiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHN1cHBvcnRzV2ViUlRDIFdoZXRoZXIgdGhlIGNsaWVudCBzdXBwb3J0cyBXZWJSVEMgKDEpIG9yIG5vdCAoMCkuCiAgICovCiAgT1QuQ2FwYWJpbGl0aWVzID0gZnVuY3Rpb24ocGVybWlzc2lvbnMpIHsKICAgICAgdGhpcy5wdWJsaXNoID0gcGVybWlzc2lvbnMuaW5kZXhPZigncHVibGlzaCcpICE9PSAtMSA/IDEgOiAwOwogICAgICB0aGlzLnN1YnNjcmliZSA9IHBlcm1pc3Npb25zLmluZGV4T2YoJ3N1YnNjcmliZScpICE9PSAtMSA/IDEgOiAwOwogICAgICB0aGlzLmZvcmNlVW5wdWJsaXNoID0gcGVybWlzc2lvbnMuaW5kZXhPZignZm9yY2V1bnB1Ymxpc2gnKSAhPT0gLTEgPyAxIDogMDsKICAgICAgdGhpcy5mb3JjZURpc2Nvbm5lY3QgPSBwZXJtaXNzaW9ucy5pbmRleE9mKCdmb3JjZWRpc2Nvbm5lY3QnKSAhPT0gLTEgPyAxIDogMDsKICAgICAgdGhpcy5zdXBwb3J0c1dlYlJUQyA9IE9ULiQuc3VwcG9ydHNXZWJSVEMoKSA/IDEgOiAwOwogICAgfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8vIFdyYXBzIHVwIHNvbWUgY29tbW9uIGVycm9yIGhhbmRsaW5nIGZvciBpbXBsZW1lbnRpbmcgY2FsbGJhY2tzCi8vIGZvciB3b3JrIHJlcXVlc3RzIG1hZGUgdG8gdGhlIE9UIGJhY2tlbmQgdmlhIHRoZSBNZXNzZW5nZXIuCnZhciBSZW1vdGVXb3JrID0gZnVuY3Rpb24gUmVtb3RlV29yayAocGFyZW50LCBzdWNjZXNzLCBlcnJvciwgb3B0aW9ucykgewogIHZhciBSRVFVRVNUX1RJTUVPVVQgPSAzMDAwMCwKICAgICAgdGltZW91dEludGVydmFsLAogICAgICBleGNlcHRpb25Db2Rlc0luZGljYXRpbmdGYWlsdXJlID0ge307CgogIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJbnRlcnZhbCk7CiAgICAgICAgcGFyZW50Lm9mZignZXhjZXB0aW9uJywgb25FeGNlcHRpb24pOwogICAgICB9LAoKICAgICAgb25FeGNlcHRpb24gPSBmdW5jdGlvbihldmVudCkgewogICAgICAgIGlmICghZXhjZXB0aW9uQ29kZXNJbmRpY2F0aW5nRmFpbHVyZS5oYXNPd25Qcm9wZXJ0eShldmVudC5jb2RlKSkgcmV0dXJuOwoKICAgICAgICAvLyBXZSBkb24ndCBldmVuIGtub3cgaWYgdGhpcyByZWxhdGVzIHRvIHRoaXMgcGFydGljdWxhciBmb3JjZURpc2Nvbm5jdC4uLgogICAgICAgIHRoaXMuZmFpbGVkKGV4Y2VwdGlvbkNvZGVzSW5kaWNhdGluZ0ZhaWx1cmVbZXZlbnQuY29kZV0pOwogICAgICB9LAoKICAgICAgb25UaW1lb3V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlYXNvbiA9IG9wdGlvbnMgJiYgb3B0aW9ucy50aW1lb3V0TWVzc2FnZSA/IG9wdGlvbnMudGltZW91dE1lc3NhZ2UgOiAiVGltZWQgb3V0IHdoaWxlIHdhaXRpbmcgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZC4iOwogICAgICAgIHRoaXMuZmFpbGVkKHJlYXNvbik7CiAgICAgIH07CgoKICB0aGlzLmZhaWxzT25FeGNlcHRpb25Db2RlcyA9IGZ1bmN0aW9uKGNvZGVzKSB7CiAgICBleGNlcHRpb25Db2Rlc0luZGljYXRpbmdGYWlsdXJlID0gY29kZXM7CiAgfTsKCiAgdGhpcy5zdWNjZWVkZWQgPSBmdW5jdGlvbigpIHsKICAgIGRlc3Ryb3koKTsKICAgIGlmIChjb21wbGV0aW9uSGFuZGxlcikgT1QuJC5jYWxsQXN5bmMoY29tcGxldGlvbkhhbmRsZXIsIG51bGwpOwogIH07CgogIHRoaXMuZmFpbGVkID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICBkZXN0cm95KCk7CiAgICBpZiAoY29tcGxldGlvbkhhbmRsZXIpIE9ULiQuY2FsbEFzeW5jKGNvbXBsZXRpb25IYW5kbGVyLCBuZXcgT1QuRXJyb3IobnVsbCwgcmVhc29uKSk7CiAgfTsKCiAgcGFyZW50Lm9uKCdleGNlcHRpb24nLCBvbkV4Y2VwdGlvbiwgdGhpcyk7CiAgdGltZW91dEludGVydmFsID0gc2V0VGltZW91dChvblRpbWVvdXQuYmluZCh0aGlzKSwgUkVRVUVTVF9USU1FT1VUKTsKfTsKCgovKioKICogVGhlIFNlc3Npb24gb2JqZWN0IHJldHVybmVkIGJ5IHRoZSA8Y29kZT5UQi5pbml0U2Vzc2lvbigpPC9jb2RlPiBtZXRob2QgcHJvdmlkZXMgYWNjZXNzIHRvIG11Y2ggb2YgdGhlIE9wZW5Ub2sgZnVuY3Rpb25hbGl0eS4KICoKICogQGNsYXNzIFNlc3Npb24KICogQGF1Z21lbnRzIEV2ZW50RGlzcGF0Y2hlcgogKgogKiBAcHJvcGVydHkge0NhcGFiaWxpdGllc30gY2FwYWJpbGl0aWVzIEEge0BsaW5rIENhcGFiaWxpdGllc30gb2JqZWN0IHRoYXQgaW5jbHVkZXMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNhcGFiaWxpdGllcyBvZiB0aGUgY2xpZW50LgogKiBBbGwgcHJvcGVydGllcyBvZiB0aGUgPGNvZGU+Y2FwYWJpbGl0aWVzPC9jb2RlPiBvYmplY3QgYXJlIHVuZGVmaW5lZCB1bnRpbCB5b3UgaGF2ZSBjb25uZWN0ZWQgdG8gYSBzZXNzaW9uCiAqIGFuZCB0aGUgU2Vzc2lvbiBvYmplY3QgaGFzIGRpc3BhdGNoZWQgdGhlIDxjb2RlPnNlc3Npb25Db25uZWN0ZWQ8L2NvZGU+IGV2ZW50LgogKiBAcHJvcGVydHkge0Nvbm5lY3Rpb259IGNvbm5lY3Rpb24gVGhlIHtAbGluayBDb25uZWN0aW9ufSBvYmplY3QgZm9yIHRoaXMgc2Vzc2lvbi4gVGhlIGNvbm5lY3Rpb24gcHJvcGVydHkgaXMgb25seSBhdmFpbGFibGUgb25jZSB0aGUKICogU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyB0aGUgc2Vzc2lvbkNvbm5lY3RlZCBldmVudC4gVGhlIFNlc3Npb24gb2JqZWN0IGFzeW5jaHJvbm91c2x5IGRpc3BhdGNoZXMgYSBzZXNzaW9uQ29ubmVjdGVkIGV2ZW50IGluIHJlc3BvbnNlCiAqIHRvIGEgc3VjY2Vzc2Z1bCBjYWxsIHRvIHRoZSBjb25uZWN0KCkgbWV0aG9kLiBTZWU6IDxhIGhyZWY9IlNlc3Npb24jY29ubmVjdCI+Y29ubmVjdDwvYT4gYW5kIHtAbGluayBDb25uZWN0aW9ufS4KICogQHByb3BlcnR5IHtTdHJpbmd9IHNlc3Npb25JZCBUaGUgc2Vzc2lvbiBJRCBmb3IgdGhpcyBzZXNzaW9uLiBZb3UgcGFzcyB0aGlzIHZhbHVlIGludG8gdGhlIDxjb2RlPlRCLmluaXRTZXNzaW9uKCk8L2NvZGU+IG1ldGhvZCB3aGVuIHlvdSBjcmVhdGUKICogdGhlIFNlc3Npb24gb2JqZWN0LiAoTm90ZTogYSBTZXNzaW9uIG9iamVjdCBpcyBub3QgY29ubmVjdGVkIHRvIHRoZSBPcGVuVG9rIHNlcnZlciB1bnRpbCB5b3UKICogY2FsbCB0aGUgY29ubmVjdCgpIG1ldGhvZCBvZiB0aGUgb2JqZWN0IGFuZCB0aGUgb2JqZWN0IGRpc3BhdGNoZXMgYSBjb25uZWN0ZWQgZXZlbnQuIFNlZSB7QGxpbmsgVEIuaW5pdFNlc3Npb259IGFuZCB7QGxpbmsgY29ubmVjdH0pLgogKiAgRm9yIG1vcmUgaW5mb3JtYXRpb24gb24gc2Vzc2lvbnMgYW5kIHNlc3Npb24gSURzLCBzZWUKICogPGEgaHJlZj0iL29wZW50b2svdHV0b3JpYWxzL2NyZWF0ZS1zZXNzaW9uLyI+U2Vzc2lvbiBjcmVhdGlvbjwvYT4uCiAqLwpPVC5TZXNzaW9uID0gZnVuY3Rpb24oc2Vzc2lvbklkKSB7CiAgLy8gQ2hlY2sgdGhhdCB0aGUgY2xpZW50IG1lZXRzIHRoZSBtaW5pbXVtIHJlcXVpcmVtZW50cywgaWYgdGhleSBkb24ndCB0aGUgdXBncmFkZQogIC8vIGZsb3cgd2lsbCBiZSB0cmlnZ2VyZWQuCiAgaWYgKCFPVC5jaGVja1N5c3RlbVJlcXVpcmVtZW50cygpKSB7CiAgICAgIE9ULnVwZ3JhZGVTeXN0ZW1SZXF1aXJlbWVudHMoKTsKICAgICAgcmV0dXJuOwogIH0KCiAgdmFyIF9pbml0aWFsQ29ubmVjdGlvbiA9IHRydWUsCiAgICAgIF9hcGlLZXksCiAgICAgIF90b2tlbiwKICAgICAgX3Nlc3Npb25JZCA9IHNlc3Npb25JZCwKICAgICAgX3NvY2tldCwKICAgICAgX3dpZGdldElkID0gT1QuJC51dWlkKCksCiAgICAgIF9hbmFseXRpY3MgPSBuZXcgT1QuQW5hbHl0aWNzKCksCiAgICAgIF9jYWxsYmFja3MgPSB7CiAgICAgICAgZm9yY2VEaXNjb25uZWN0OiB7fSwKICAgICAgICBmb3JjZVVucHVibGlzaDoge30KICAgICAgfTsKCgogIE9ULiQuZXZlbnRpbmcodGhpcyk7CiAgdmFyIHNldFN0YXRlID0gT1QuJC5zdGF0YWJsZSh0aGlzLCBbJ2Rpc2Nvbm5lY3RlZCcsICdjb25uZWN0aW5nJywgJ2Nvbm5lY3RlZCcsICdkaXNjb25uZWN0aW5nJ10sICdkaXNjb25uZWN0ZWQnKTsKCiAgdGhpcy5jb25uZWN0aW9ucyA9IG5ldyBPVC5Db2xsZWN0aW9uKCk7CiAgdGhpcy5zdHJlYW1zID0gbmV3IE9ULkNvbGxlY3Rpb24oKTsKCgogIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyAgTUVTU0FHRSBIQU5ETEVSUwogIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgdmFyCiAgLy8gVGhlIGR1cGxpY2F0aW9uIG9mIHRoaXMgYW5kIHNlc3Npb25Db25uZWN0aW9uRmFpbGVkIHdpbGwgZ28gYXdheSB3aGVuCiAgLy8gc2Vzc2lvbiBhbmQgbWVzc2VuZ2VyIGFyZSByZWZhY3RvcmVkCiAgc2Vzc2lvbkNvbm5lY3RGYWlsZWQgPSBmdW5jdGlvbihyZWFzb24sIGNvZGUpIHsKICAgIHNldFN0YXRlKCdkaXNjb25uZWN0ZWQnKTsKCiAgICBPVC5lcnJvcihyZWFzb24pOwoKICAgIHRoaXMudHJpZ2dlcignc2Vzc2lvbkNvbm5lY3RGYWlsZWQnLCByZWFzb24pOwoKICAgIFRCLmhhbmRsZUpzRXhjZXB0aW9uKHJlYXNvbiwgY29kZSB8fCBPVC5FeGNlcHRpb25Db2Rlcy5DT05ORUNUX0ZBSUxFRCwgewogICAgICBzZXNzaW9uOiB0aGlzCiAgICB9KTsKICB9LAoKICBzZXNzaW9uRGlzY29ubmVjdGVkSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgcmVhc29uID0gZXZlbnQucmVhc29uOwogICAgaWYocmVhc29uID09ICJuZXR3b3JrVGltZWRvdXQiKSB7CiAgICAgIHJlYXNvbiA9ICJuZXR3b3JrRGlzY29ubmVjdGVkIjsKICAgICAgdGhpcy5sb2dFdmVudCgnd2ViU29ja2V0Q29ubmVjdGlvbicsICdUaW1lT3V0RGlzY29ubmVjdCcsICJyZWFzb24iLCBldmVudC5yZWFzb24pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5sb2dFdmVudCgnd2ViU29ja2V0Q29ubmVjdGlvbicsICdEaXNjb25uZWN0ZWQnLCAicmVhc29uIiwgZXZlbnQucmVhc29uKTsKICAgIH0KCiAgICB2YXIgcHVibGljRXZlbnQgPSBuZXcgT1QuU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudCgnc2Vzc2lvbkRpc2Nvbm5lY3RlZCcsIHJlYXNvbik7CgogICAgcmVzZXQuY2FsbCh0aGlzKTsKICAgIGRpc2Nvbm5lY3RDb21wb25lbnRzLmNhbGwodGhpcyk7CgogICAgdmFyIGRlZmF1bHRBY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFwdWJsaWNFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgZGVzdHJveUNvbXBvbmVudHMuY2FsbCh0aGlzLCBwdWJsaWNFdmVudC5yZWFzb24pOwogICAgfS5iaW5kKHRoaXMpOwoKICAgIHRoaXMuZGlzcGF0Y2hFdmVudChwdWJsaWNFdmVudCwgZGVmYXVsdEFjdGlvbik7CiAgfSwKCiAgY29ubmVjdGlvbkNyZWF0ZWRIYW5kbGVyID0gZnVuY3Rpb24oY29ubmVjdGlvbikgewogICAgLy8gV2UgZG9uJ3QgYnJvYWRjYXN0IGV2ZW50cyBmb3IgdGhlIHN5bXBob255IGNvbm5lY3Rpb24KICAgIGlmIChjb25uZWN0aW9uLmlkLm1hdGNoKC9ec3ltcGhvbnlcLi8pKSByZXR1cm47CgogICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBPVC5Db25uZWN0aW9uRXZlbnQoCiAgICAgICAgT1QuRXZlbnQubmFtZXMuQ09OTkVDVElPTl9DUkVBVEVELAogICAgICAgIFtjb25uZWN0aW9uXQogICAgKSk7CiAgfSwKCiAgY29ubmVjdGlvbkRlc3Ryb3llZEhhbmRsZXIgPSBmdW5jdGlvbihjb25uZWN0aW9uLCByZWFzb24pIHsKICAgIC8vIFdlIGRvbid0IGJyb2FkY2FzdCBldmVudHMgZm9yIHRoZSBzeW1waG9ueSBjb25uZWN0aW9uCiAgICBpZiAoY29ubmVjdGlvbi5pZC5tYXRjaCgvXnN5bXBob255XC4vKSkgcmV0dXJuOwoKICAgIC8vIERvbid0IGRlbGV0ZSB0aGUgY29ubmVjdGlvbiBpZiBpdCdzIG91cnMuIFRoaXMgb25seSBoYXBwZW5zIHdoZW4KICAgIC8vIHdlJ3JlIGFib3V0IHRvIHJlY2VpdmUgYSBzZXNzaW9uIGRpc2Nvbm5lY3RlZCBhbmQgc2Vzc2lvbiBkaXNjb25uZWN0ZWQKICAgIC8vIHdpbGwgYWxzbyBjbGVhbiB1cCBvdXIgY29ubmVjdGlvbi4KICAgIGlmIChjb25uZWN0aW9uLmlkID09PSBfc29ja2V0LmlkKSByZXR1cm47CgogICAgLy8gSGFuZGxlIHN1Y2Nlc3MgY2FsbGJhY2tzCiAgICBpZiAoX2NhbGxiYWNrcy5mb3JjZURpc2Nvbm5lY3RbY29ubmVjdGlvbi5pZF0pIHsKICAgICAgdmFyIGNhbGxiYWNrID0gX2NhbGxiYWNrcy5mb3JjZURpc2Nvbm5lY3RbY29ubmVjdGlvbi5pZF07CiAgICAgIGRlbGV0ZSBfY2FsbGJhY2tzLmZvcmNlRGlzY29ubmVjdFtjb25uZWN0aW9uLmlkXTsKCgogICAgICBpZiAocmVhc29uICE9PSAnZm9yY2VEaXNjb25uZWN0ZWQnKSB7CiAgICAgICAgT1Qud2FybigiRXhwZWN0ZWQgYSBmb3JjZURpc2Nvbm5lY3QgZm9yIGNvbm5lY3Rpb24gIiArIGNvbm5lY3Rpb24uaWQgKyAiLCBidXQgYSAiICsgcmVhc29uICsgIiB3YXMgcmVjZWl2ZWQgaW5zdGVhZC4iKTsKICAgICAgfQoKICAgICAgY2FsbGJhY2suc3VjY2VlZGVkKCk7CiAgICB9CgogICAgdGhpcy5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgT1QuQ29ubmVjdGlvbkV2ZW50KAogICAgICAgIE9ULkV2ZW50Lm5hbWVzLkNPTk5FQ1RJT05fREVTVFJPWUVELAogICAgICAgIFtjb25uZWN0aW9uXSwKICAgICAgICByZWFzb24KICAgICAgKQogICAgKTsKICB9LAoKICBzdHJlYW1DcmVhdGVkSGFuZGxlciA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBPVC5TdHJlYW1FdmVudCgKICAgICAgT1QuRXZlbnQubmFtZXMuU1RSRUFNX0NSRUFURUQsCiAgICAgIFtzdHJlYW1dCiAgICApKTsKICB9LAoKICBzdHJlYW1Qcm9wZXJ0eU1vZGlmaWVkSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgc3RyZWFtID0gZXZlbnQudGFyZ2V0LAogICAgICAgIHByb3BlcnR5TmFtZSA9IGV2ZW50LmNoYW5nZWRQcm9wZXJ0eSwKICAgICAgICBuZXdWYWx1ZSA9IGV2ZW50Lm5ld1ZhbHVlOwoKICAgIGlmIChwcm9wZXJ0eU5hbWUgPT09ICdvcmllbnRhdGlvbicpIHsKICAgICAgcHJvcGVydHlOYW1lID0gJ3ZpZGVvRGltZW5zaW9ucyc7CiAgICAgIG5ld1ZhbHVlID0ge3dpZHRoOiBuZXdWYWx1ZS53aWR0aCwgaGVpZ2h0OiBuZXdWYWx1ZS5oZWlnaHR9OwogICAgfQoKICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgT1QuU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQoCiAgICAgIE9ULkV2ZW50Lm5hbWVzLlNUUkVBTV9QUk9QRVJUWV9DSEFOR0VELAogICAgICBzdHJlYW0sCiAgICAgIHByb3BlcnR5TmFtZSwKICAgICAgZXZlbnQub2xkVmFsdWUsCiAgICAgIG5ld1ZhbHVlCiAgICApKTsKICB9LAoKICBzdHJlYW1EZXN0cm95ZWRIYW5kbGVyID0gZnVuY3Rpb24oc3RyZWFtLCByZWFzb24pIHsKICAgIC8vIEhhbmRsZSBzdWNjZXNzIGNhbGxiYWNrcwogICAgaWYgKF9jYWxsYmFja3MuZm9yY2VVbnB1Ymxpc2hbc3RyZWFtLmlkXSkgewogICAgICB2YXIgY2FsbGJhY2sgPSBfY2FsbGJhY2tzLmZvcmNlVW5wdWJsaXNoW3N0cmVhbS5pZF07CiAgICAgIGRlbGV0ZSBfY2FsbGJhY2tzLmZvcmNlVW5wdWJsaXNoW3N0cmVhbS5pZF07CgogICAgICBpZiAocmVhc29uICE9PSAnZm9yY2VVbnB1Ymxpc2hlZCcpIHsKICAgICAgICBPVC53YXJuKCJFeHBlY3RlZCBhIGZvcmNlVW5wdWJsaXNoIGZvciBzdHJlYW0gIiArIHN0cmVhbS5pZCArICIsIGJ1dCBhICIgKyByZWFzb24gKyAiIGRlc3Ryb3llZCB3YXMgcmVjZWl2ZWQgaW5zdGVhZC4iKTsKICAgICAgfQoKICAgICAgY2FsbGJhY2suc3VjY2VlZGVkKCk7CiAgICB9CgogICAgdmFyIGV2ZW50ID0gbmV3IE9ULlN0cmVhbUV2ZW50KCdzdHJlYW1EZXN0cm95ZWQnLCBbc3RyZWFtXSwgcmVhc29uKTsKCiAgICB2YXIgZGVmYXVsdEFjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7CiAgICAgICAgLy8gSWYgdGhlIHN0cmVhbSBpcyBvbmUgb2Ygb3VycyB0aGVuIHdlIG5lZWQgdG8gY2xlYW51cAogICAgICAgIC8vIGEgcHVibGlzaGVyLgogICAgICAgIHZhciBwdWJsaXNoZXIgPSBPVC5wdWJsaXNoZXJzLndoZXJlKHtzdHJlYW1JZDogc3RyZWFtLmlkfSlbMF07CiAgICAgICAgaWYgKHB1Ymxpc2hlcikgewogICAgICAgICAgcHVibGlzaGVyLl8udW5wdWJsaXNoRnJvbVNlc3Npb24odGhpcyk7CiAgICAgICAgICBwdWJsaXNoZXIuZGVzdHJveSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UgYXJlIHN1YnNjcmliZWQgdG8gYW55IG9mIHRoZSBzdHJlYW1zIHdlIHNob3VsZCB1bnN1YnNjcmliZQogICAgICAgIE9ULnN1YnNjcmliZXJzLndoZXJlKHtzdHJlYW1JZDogc3RyZWFtLmlkfSkuZm9yRWFjaChmdW5jdGlvbihzdWJzY3JpYmVyKSB7CiAgICAgICAgICBpZiAoc3Vic2NyaWJlci5zZXNzaW9uLmlkID09PSB0aGlzLmlkKSB7CiAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoc3Vic2NyaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKTsKCiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoZXZlbnQsIGRlZmF1bHRBY3Rpb24pOwogIH0sCgoKICAvLyBQdXQgb3Vyc2VsdmVzIGludG8gYSBwcmlzdGluZSBzdGF0ZQogIHJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgICBfYXBpS2V5ID0gbnVsbDsKICAgIF90b2tlbiA9IG51bGw7CiAgICBzZXRTdGF0ZSgnZGlzY29ubmVjdGVkJyk7CgogICAgdGhpcy5jb25uZWN0aW9ucy5kZXN0cm95KCk7CiAgICB0aGlzLnN0cmVhbXMuZGVzdHJveSgpOwogIH0sCgogIGRpc2Nvbm5lY3RDb21wb25lbnRzID0gZnVuY3Rpb24oKSB7CiAgICBPVC5wdWJsaXNoZXJzLndoZXJlKHtzZXNzaW9uOiB0aGlzfSkuZm9yRWFjaChmdW5jdGlvbihwdWJsaXNoZXIpIHsKICAgICAgcHVibGlzaGVyLmRpc2Nvbm5lY3QoKTsKICAgIH0pOwoKICAgIE9ULnN1YnNjcmliZXJzLndoZXJlKHtzZXNzaW9uOiB0aGlzfSkuZm9yRWFjaChmdW5jdGlvbihzdWJzY3JpYmVyKSB7CiAgICAgIHN1YnNjcmliZXIuZGlzY29ubmVjdCgpOwogICAgfSk7CiAgfSwKCiAgZGVzdHJveUNvbXBvbmVudHMgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgIE9ULnB1Ymxpc2hlcnMud2hlcmUoe3Nlc3Npb246IHRoaXN9KS5mb3JFYWNoKGZ1bmN0aW9uKHB1Ymxpc2hlcikgewogICAgICBwdWJsaXNoZXIuZGVzdHJveShyZWFzb24pOwogICAgfSk7CgogICAgT1Quc3Vic2NyaWJlcnMud2hlcmUoe3Nlc3Npb246IHRoaXN9KS5mb3JFYWNoKGZ1bmN0aW9uKHN1YnNjcmliZXIpIHsKICAgICAgc3Vic2NyaWJlci5kZXN0cm95KHJlYXNvbik7CiAgICB9KTsKICB9LAoKICBjb25uZWN0TWVzc2VuZ2VyID0gZnVuY3Rpb24oKSB7CiAgICBUQi5kZWJ1ZygiT1QuU2Vzc2lvbjogY29ubmVjdGluZyB0byBSYXB0b3IiKTsKCiAgICBfc29ja2V0ID0gbmV3IE9ULlJhcHRvci5Tb2NrZXQoX3dpZGdldElkLCB0aGlzLnNlc3Npb25JbmZvLm1lc3NhZ2luZ1NlcnZlcik7CiAgICBfc29ja2V0LmNvbm5lY3QoX3Rva2VuLCB0aGlzLnNlc3Npb25JbmZvLCBmdW5jdGlvbihlcnJvciwgc2Vzc2lvblN0YXRlKSB7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHNlc3Npb25Db25uZWN0RmFpbGVkLmNhbGwodGhpcywgZXJyb3IucmVhc29uLCBlcnJvci5jb2RlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIE9ULmRlYnVnKCJPVC5TZXNzaW9uOiBSZWNlaXZlZCBzZXNzaW9uIHN0YXRlIGZyb20gUmFwdG9yIiwgc2Vzc2lvblN0YXRlKTsKCiAgICAgIHNldFN0YXRlKCdjb25uZWN0ZWQnKTsKCiAgICAgIC8vIExpc3RlbiBmb3Igb3VyIG93biBjb25uZWN0aW9uJ3MgZGVzdHJveWVkIGV2ZW50IHNvIHdlIGtub3cgd2hlbiB3ZSd2ZSBiZWVuIGRpc2Nvbm5lY3RlZC4KICAgICAgdGhpcy5jb25uZWN0aW9uLm9uKCdkZXN0cm95ZWQnLCBzZXNzaW9uRGlzY29ubmVjdGVkSGFuZGxlciwgdGhpcyk7CgogICAgICAvLyBMaXN0ZW4gZm9yIGNvbm5lY3Rpb24gdXBkYXRlcwogICAgICB0aGlzLmNvbm5lY3Rpb25zLm9uKHsKICAgICAgICBhZGQ6IGNvbm5lY3Rpb25DcmVhdGVkSGFuZGxlciwKICAgICAgICByZW1vdmU6IGNvbm5lY3Rpb25EZXN0cm95ZWRIYW5kbGVyCiAgICAgIH0sIHRoaXMpOwoKICAgICAgLy8gTGlzdGVuIGZvciBzdHJlYW0gdXBkYXRlcwogICAgICB0aGlzLnN0cmVhbXMub24oewogICAgICAgIGFkZDogc3RyZWFtQ3JlYXRlZEhhbmRsZXIsCiAgICAgICAgcmVtb3ZlOiBzdHJlYW1EZXN0cm95ZWRIYW5kbGVyLAogICAgICAgIHVwZGF0ZTogc3RyZWFtUHJvcGVydHlNb2RpZmllZEhhbmRsZXIKICAgICAgfSwgdGhpcyk7CgogICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IE9ULlNlc3Npb25Db25uZWN0RXZlbnQoCiAgICAgICAgT1QuRXZlbnQubmFtZXMuU0VTU0lPTl9DT05ORUNURUQsCiAgICAgICAgc2Vzc2lvblN0YXRlLmNvbm5lY3Rpb25zLAogICAgICAgIHNlc3Npb25TdGF0ZS5zdHJlYW1zLAogICAgICAgIHNlc3Npb25TdGF0ZS5hcmNoaXZlcwogICAgICApKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgfSwKCiAgZ2V0U2Vzc2lvbkluZm8gPSBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmlzKCdjb25uZWN0aW5nJykpIHsKICAgICAgT1QuU2Vzc2lvbkluZm8uZ2V0KAogICAgICAgIHRoaXMsCiAgICAgICAgb25TZXNzaW9uSW5mb1Jlc3BvbnNlLmJpbmQodGhpcyksCiAgICAgICAgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgIHNlc3Npb25Db25uZWN0RmFpbGVkLmNhbGwodGhpcywgZXJyb3IubWVzc2FnZSArIChlcnJvci5jb2RlID8gJyAoJyArIGVycm9yLmNvZGUgKyAnKScgOiAnJykpOwogICAgICAgIH0uYmluZCh0aGlzKQogICAgICApOwogICAgfQogIH0sCgogIG9uU2Vzc2lvbkluZm9SZXNwb25zZSA9IGZ1bmN0aW9uKHNlc3Npb25JbmZvKSB7CiAgICBpZiAodGhpcy5pcygnY29ubmVjdGluZycpKSB7CiAgICAgIHRoaXMuc2Vzc2lvbkluZm8gPSBzZXNzaW9uSW5mbzsKICAgICAgaWYgKHRoaXMuc2Vzc2lvbkluZm8ucGFydG5lcklkICYmIHRoaXMuc2Vzc2lvbkluZm8ucGFydG5lcklkICE9IF9hcGlLZXkpIHsKICAgICAgICAgIF9hcGlLZXkgPSB0aGlzLnNlc3Npb25JbmZvLnBhcnRuZXJJZDsKCiAgICAgICAgICB2YXIgcmVhc29uID0gIkF1dGhlbnRpY2F0aW9uIEVycm9yOiBUaGUgYXBpS2V5IHBhc3NlZCBpbnRvIHRoZSBzZXNzaW9uLmNvbm5lY3QgbWV0aG9kIGRvZXMgbm90IG1hdGNoIHRoZSBhcGlLZXkgaW4gdGhlIHRva2VuIG9yIHNlc3Npb24geW91IGFyZSB0cnlpbmcgdG8gY29ubmVjdCB0by4iOwogICAgICAgICAgc2Vzc2lvbkNvbm5lY3RGYWlsZWQuY2FsbCh0aGlzLCByZWFzb24sIE9ULkV4Y2VwdGlvbkNvZGVzLkFVVEhFTlRJQ0FUSU9OX0VSUk9SKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3RNZXNzZW5nZXIuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfQogIH0sCgogIC8vIENoZWNrIHdoZXRoZXIgd2UgaGF2ZSBwZXJtaXNzaW9ucyB0byBwZXJmb3JtIHRoZSBhY3Rpb24uCiAgcGVybWl0dGVkVG8gPSBmdW5jdGlvbihhY3Rpb24pIHsKICAgICAgcmV0dXJuIF9zb2NrZXQgJiYgX3NvY2tldC5wZXJtaXR0ZWRUbyhhY3Rpb24pOwogIH07CgogIHRoaXMubG9nRXZlbnQgPSBmdW5jdGlvbihhY3Rpb24sIHZhcmlhdGlvbiwgcGF5bG9hZF90eXBlLCBwYXlsb2FkKSB7CiAgICBfYW5hbHl0aWNzLmxvZ0V2ZW50KHsKICAgICAgYWN0aW9uOiBhY3Rpb24sCiAgICAgIHZhcmlhdGlvbjogdmFyaWF0aW9uLAogICAgICBwYXlsb2FkX3R5cGU6IHBheWxvYWRfdHlwZSwKICAgICAgcGF5bG9hZDogcGF5bG9hZCwKICAgICAgc2Vzc2lvbl9pZDogX3Nlc3Npb25JZCwKICAgICAgcGFydG5lcl9pZDogX2FwaUtleSwKICAgICAgd2lkZ2V0X2lkOiBfd2lkZ2V0SWQsCiAgICAgIHdpZGdldF90eXBlOiAnQ29udHJvbGxlcicKICAgIH0pOwogIH07CgogLyoqCiAqIENvbm5lY3RzIHRvIGFuIE9wZW5Ub2sgc2Vzc2lvbi4gUGFzcyB5b3VyIEFQSSBrZXkgYXMgdGhlIDxjb2RlPmFwaUtleTwvY29kZT4gcGFyYW1ldGVyLiBZb3UgZ2V0IGFuIEFQSSBrZXkgd2hlbiB5b3UKICogPGEgaHJlZj0iaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS91c2Vycy9zaWduX2luIj5zaWduIHVwPC9hPiBmb3IgYW4gT3BlblRvayBhY2NvdW50LiBQYXNzIGEgdG9rZW4gc3RyaW5nIGFzCiAqIHRoZSA8Y29kZT50b2tlbjwvY29kZT4gcGFyYW1ldGVyLiBZb3UgZ2VuZXJhdGUgYSB0b2tlbiB1c2luZyB0aGUKICogPGEgaHJlZj0iL29wZW50b2svYXBpL3Rvb2xzL2RvY3VtZW50YXRpb24vYXBpL3NlcnZlcl9zaWRlX2xpYnJhcmllcy5odG1sIj5PcGVuVG9rIHNlcnZlci1zaWRlIGxpYnJhcmllczwvYT4KICogb3IgdGhlIDxhIGhyZWY9Imh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMiPkRhc2hib2FyZDwvYT4gcGFnZS4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZQogKiA8YSBocmVmPSIvb3BlbnRvay90dXRvcmlhbHMvY3JlYXRlLXRva2VuLyI+Q29ubmVjdGlvbiB0b2tlbiBjcmVhdGlvbjwvYT4uCiAqICA8cD4KICogICAgVXBvbiBhIHN1Y2Nlc3NmdWwgY29ubmVjdGlvbiwgdGhlIFNlc3Npb24gb2JqZWN0IGRpc3BhdGNoZXMgYSA8Y29kZT5zZXNzaW9uQ29ubmVjdGVkPC9jb2RlPiBldmVudC4gQ2FsbCB0aGUKICogPGNvZGU+YWRkRXZlbnRMaXN0ZW5lcigpPC9jb2RlPiBtZXRob2QgdG8gc2V0IHVwIGFuIGV2ZW50IGxpc3RlbmVyIHRvIHByb2Nlc3MgdGhpcyBldmVudCBiZWZvcmUgY2FsbGluZyBvdGhlciBtZXRob2RzIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4KICogIDwvcD4KICogIDxwPgogKiAgICBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPmNvbm5lY3Rpb25DcmVhdGVkPC9jb2RlPiBldmVudCB3aGVuIG90aGVyIGNsaWVudHMgY3JlYXRlIGNvbm5lY3Rpb25zIHRvIHRoZSBzZXNzaW9uLgogKiAgPC9wPgogKiAgPHA+CiAqICAgIFRoZSBUQiBvYmplY3QgZGlzcGF0Y2hlcyBhbiA8Y29kZT5leGNlcHRpb248L2NvZGU+IGV2ZW50IGlmIHRoZSBzZXNzaW9uIElELAogKiAgICBBUEkga2V5LCBvciB0b2tlbiBzdHJpbmcgYXJlIGludmFsaWQuIFNlZSA8YSBocmVmPSJFeGNlcHRpb25FdmVudC5odG1sIj5FeGNlcHRpb25FdmVudDwvYT4KICogICAgYW5kIDxhIGhyZWY9IlRCLmh0bWwjYWRkRXZlbnRMaXN0ZW5lciI+VEIuYWRkRXZlbnRMaXN0ZW5lcigpPC9hPi4KICogIDwvcD4KICogIDxwPgogKiAgICBUaGUgYXBwbGljYXRpb24gdGhyb3dzIGFuIGVycm9yIGlmIHRoZSBzeXN0ZW0gcmVxdWlyZW1lbnRzIGFyZSBub3QgbWV0CiAqICAgIChzZWUgPGEgaHJlZj0iVEIuaHRtbCNjaGVja1N5c3RlbVJlcXVpcmVtZW50cyI+VEIuY2hlY2tTeXN0ZW1SZXF1aXJlbWVudHMoKTwvYT4pLgogKiAgICBUaGUgYXBwbGljYXRpb24gYWxzbyB0aHJvd3MgYW4gZXJyb3IgaWYgdGhlIHNlc3Npb24gaGFzIHBlZXItdG8tcGVlciBzdHJlYW1pbmcgZW5hYmxlZAogKiAgICBhbmQgdHdvIGNsaWVudHMgYXJlIGFscmVhZHkgY29ubmVjdGVkIHRvIHRoZSBzZXNzaW9uIChzZWUgb3VyCiAqICAgIDxhIGhyZWY9Ii9vcGVudG9rL2xpYnJhcmllcy9zZXJ2ZXIvIj5zZXJ2ZXItc2lkZSBsaWJyYXJpZXM8L2E+KS4KICogIDwvcD4KICoKICogPHA+CiAqICBXaXRoIHRoZSBwZWVyLXRvLXBlZXIgb3B0aW9uIGVuYWJsZWQgZm9yIGEgc2Vzc2lvbiwgdGhlIHNlc3Npb24gc3VwcG9ydHMgdHdvIGNvbm5lY3Rpb25zLiBXaXRob3V0IHRoZSBwZWVyLXRvLXBlZXIgb3B0aW9uCiAqICBlbmFibGVkLCB0aGUgc2Vzc2lvbiBzdXBwb3J0cyB1cCB0byBmb3VyIGNvbm5lY3Rpb25zLiBPbiBjbGllbnRzIHRoYXQgYXR0ZW1wdCB0byBhIHNlc3Npb24gdGhhdCBhbHJlYWR5IGhhcyB0aGUgbWF4aW11bQogKiAgbnVtYmVyIG9mIGNvbm5lY3Rpb25zLCB0aGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgYW4gYGV4Y2VwdGlvbmAgZXZlbnQgKHdpdGggdGhlIGBjb2RlYCBwcm9wZXJ0eSBzZXQgdG8gMTAwNykuIFNlZQogKiAgPGEgaHJlZj0iL29wZW50b2svdHV0b3JpYWxzL2NyZWF0ZS1zZXNzaW9uLyI+U2Vzc2lvbiBDcmVhdGlvbiBkb2N1bWVudGF0aW9uPC9hPi4KICogPC9wPgogKgogKgogKiAgPGg1PgogKiAgRXhhbXBsZQogKiAgPC9oNT4KICogIDxwPgogKiAgVGhlIGZvbGxvd2luZyBjb2RlIGluaXRpYWxpemVzIGEgc2Vzc2lvbiBhbmQgc2V0cyB1cCBhbiBldmVudCBsaXN0ZW5lciBmb3Igd2hlbiB0aGUgc2Vzc2lvbiBjb25uZWN0czoKICogIDwvcD4KICogIDxwcmU+CiAqICB2YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqICB2YXIgc2Vzc2lvbklEID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIG93biBzZXNzaW9uIElELgogKiAgICAgICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKiAgdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKgogKiAgdmFyIHNlc3Npb24gPSBUQi5pbml0U2Vzc2lvbihzZXNzaW9uSUQpOwogKiAgc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzZXNzaW9uQ29ubmVjdGVkIiwgc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKTsKICogIHNlc3Npb24uY29ubmVjdChhcGlLZXksIHRva2VuKTsKICoKICogIGZ1bmN0aW9uIHNlc3Npb25Db25uZWN0SGFuZGxlcihzZXNzaW9uQ29ubmVjdEV2ZW50KSB7CiAqICAgICAgLy8KICogIH0KICogIDwvcHJlPgogKiAgPHA+CiAqICA8cD4KICogICAgSW4gdGhpcyBleGFtcGxlLCB0aGUgPGNvZGU+c2Vzc2lvbkNvbm5lY3RIYW5kbGVyKCk8L2NvZGU+IGZ1bmN0aW9uIGlzIHBhc3NlZCBhbiBldmVudCBvYmplY3Qgb2YgdHlwZSB7QGxpbmsgU2Vzc2lvbkNvbm5lY3RFdmVudH0uCiAqICA8L3A+CiAqCiAqICA8aDU+CiAqICBFdmVudHMgZGlzcGF0Y2hlZDoKICogIDwvaDU+CiAqCiAqICA8cD4KICogICAgPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiAoPGEgaHJlZj0iRXhjZXB0aW9uRXZlbnQuaHRtbCI+RXhjZXB0aW9uRXZlbnQ8L2E+KSAmIzE1MTsgRGlzcGF0Y2hlZCBieSB0aGUgVEIgY2xhc3MKICogICAgbG9jYWxseSBpbiB0aGUgZXZlbnQgb2YgYW4gZXJyb3IuCiAqICA8L3A+CiAqICA8cD4KICogICAgPGNvZGU+Y29ubmVjdGlvbkNyZWF0ZWQ8L2NvZGU+ICg8YSBocmVmPSJDb25uZWN0aW9uRXZlbnQuaHRtbCI+Q29ubmVjdGlvbkV2ZW50PC9hPikgJiMxNTE7CiAqICAgICAgRGlzcGF0Y2hlZCBieSB0aGUgU2Vzc2lvbiBvYmplY3Qgb24gYWxsIGNsaWVudHMgY29ubmVjdGVkIHRvIHRoZSBzZXNzaW9uLgogKiAgPC9wPgogKiAgPHA+CiAqICAgIDxjb2RlPnNlc3Npb25Db25uZWN0ZWQ8L2NvZGU+ICg8YSBocmVmPSJTZXNzaW9uQ29ubmVjdEV2ZW50Lmh0bWwiPlNlc3Npb25Db25uZWN0RXZlbnQ8L2E+KSAmIzE1MTsKICogICAgICBEaXNwYXRjaGVkIGxvY2FsbHkgYnkgdGhlIFNlc3Npb24gb2JqZWN0IHdoZW4gdGhlIGNvbm5lY3Rpb24gaXMgZXN0YWJsaXNoZWQuCiAqICA8L3A+CiAqCiAgKiBAcGFyYW0ge1N0cmluZ30gYXBpS2V5IFRoZSBBUEkga2V5IHRoYXQgVG9rQm94IHByb3ZpZGVkIHlvdSB3aGVuIHlvdSByZWdpc3RlcmVkIGZvciB0aGUgT3BlblRvayBBUEkuCiAgKgogICogQHBhcmFtIHtTdHJpbmd9IHRva2VuIFRoZSBzZXNzaW9uIHRva2VuLiBZb3UgZ2VuZXJhdGUgYSBzZXNzaW9uIHRva2VuIHVzaW5nIG91cgogICogPGEgaHJlZj0iL29wZW50b2svbGlicmFyaWVzL3NlcnZlci8iPnNlcnZlci1zaWRlIGxpYnJhcmllczwvYT4gb3IgdGhlCiAgKiA8YSBocmVmPSJodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzIj5EYXNoYm9hcmQ8L2E+IHBhZ2UuIEZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWUKICAqIDxhIGhyZWY9Ii9vcGVudG9rL3R1dG9yaWFscy9jcmVhdGUtdG9rZW4vIj5Db25uZWN0aW9uIHRva2VuIGNyZWF0aW9uPC9hPi4KICAqCiAgKiBAbWV0aG9kICNjb25uZWN0CiAgKiBAbWVtYmVyT2YgU2Vzc2lvbgogICovCiAgdGhpcy5jb25uZWN0ID0gZnVuY3Rpb24oYXBpS2V5LCB0b2tlbiwgY29tcGxldGlvbkhhbmRsZXIpIHsKICAgIGlmICh0aGlzLmlzKCdjb25uZWN0aW5nJywgJ2Nvbm5lY3RlZCcpKSB7CiAgICAgIE9ULndhcm4oIk9ULlNlc3Npb246IENhbm5vdCBjb25uZWN0LCB0aGUgc2Vzc2lvbiBpcyBhbHJlYWR5ICIgKyB0aGlzLnN0YXRlKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHJlc2V0LmNhbGwodGhpcyk7CiAgICBzZXRTdGF0ZSgnY29ubmVjdGluZycpOwogICAgX3Rva2VuID0gdG9rZW47CgogICAgLy8gR2V0IGEgbmV3IHdpZGdldCBJRCB3aGVuIHJlY29ubmVjdGluZy4KICAgIGlmIChfaW5pdGlhbENvbm5lY3Rpb24pIHsKICAgICAgX2luaXRpYWxDb25uZWN0aW9uID0gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICBfd2lkZ2V0SWQgPSBPVC4kLnV1aWQoKTsKICAgIH0KCiAgICBfYXBpS2V5ID0gYXBpS2V5LnRvU3RyaW5nKCk7CgogICAgLy8gVWdseSBoYWNrLCBtYWtlIHN1cmUgT1QuQVBJS0VZIGlzIHNldAogICAgaWYgKE9ULkFQSUtFWS5sZW5ndGggPT09IDApIHsKICAgICAgICBPVC5BUElLRVkgPSBfYXBpS2V5OwogICAgfQoKICAgIGlmIChjb21wbGV0aW9uSGFuZGxlciAmJiBPVC4kLmlzRnVuY3Rpb24oY29tcGxldGlvbkhhbmRsZXIpKSB7CiAgICAgIHRoaXMub25jZShPVC5FdmVudC5uYW1lcy5TRVNTSU9OX0NPTk5FQ1RFRCwgY29tcGxldGlvbkhhbmRsZXIuYmluZChudWxsLCBudWxsKSk7CiAgICAgIHRoaXMub25jZSgnc2Vzc2lvbkNvbm5lY3RGYWlsZWQnLCBjb21wbGV0aW9uSGFuZGxlcik7CiAgICB9CgogICAgZ2V0U2Vzc2lvbkluZm8uY2FsbCh0aGlzKTsKICB9OwoKIC8qKgogICogRGlzY29ubmVjdHMgZnJvbSB0aGUgT3BlblRvayBzZXNzaW9uLgogICoKICAqIDxwPgogICogQ2FsbGluZyB0aGUgPGNvZGU+ZGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2QgZW5kcyB5b3VyIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2Vzc2lvbi4gSW4gdGhlIGNvdXJzZSBvZiB0ZXJtaW5hdGluZyB5b3VyIGNvbm5lY3Rpb24sCiAgKiBpdCBhbHNvIGNlYXNlcyBwdWJsaXNoaW5nIGFueSBzdHJlYW0ocykgeW91IHdlcmUgcHVibGlzaGluZy4KICAqIDwvcD4KICAqIDxwPgogICogU2Vzc2lvbiBvYmplY3RzIG9uIHJlbW90ZSBjbGllbnRzIGRpc3BhdGNoIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gZXZlbnRzIGZvciBhbnkgc3RyZWFtIHlvdSB3ZXJlIHB1Ymxpc2hpbmcuCiAgKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0ZWQ8L2NvZGU+IGV2ZW50IGxvY2FsbHkuIFRoZSBTZXNzaW9uIG9iamVjdHMgb24gcmVtb3RlIGNsaWVudHMgZGlzcGF0Y2gKICAqIDxjb2RlPmNvbm5lY3Rpb25EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50cywgbGV0dGluZyBvdGhlciBjb25uZWN0aW9ucyBrbm93IHlvdSBoYXZlIGxlZnQgdGhlIHNlc3Npb24uIFRoZSB7QGxpbmsgU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudH0KICAqIGFuZCB7QGxpbmsgU3RyZWFtRXZlbnR9IG9iamVjdHMgdGhhdCBkZWZpbmUgdGhlIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0PC9jb2RlPiBhbmQgPGNvZGU+Y29ubmVjdGlvbkRlc3Ryb3llZDwvY29kZT4gZXZlbnRzIGVhY2ggaGF2ZQogICogYSA8Y29kZT5yZWFzb248L2NvZGU+IHByb3BlcnR5LiBUaGUgPGNvZGU+cmVhc29uPC9jb2RlPiBwcm9wZXJ0eSBsZXRzIHRoZSBkZXZlbG9wZXIgZGV0ZXJtaW5lIHdoZXRoZXIgdGhlIGNvbm5lY3Rpb24gaXMgYmVpbmcKICAqIHRlcm1pbmF0ZWQgdm9sdW50YXJpbHkgYW5kIHdoZXRoZXIgYW55IHN0cmVhbXMgYXJlIGJlaW5nIGRlc3Ryb3llZCBhcyBhIGJ5cHJvZHVjdCBvZiB0aGUgdW5kZXJseWluZyBjb25uZWN0aW9uJ3Mgdm9sdW50YXJ5IGRlc3RydWN0aW9uLgogICogPC9wPgogICogPHA+CiAgKiBJZiB0aGUgc2Vzc2lvbiBpcyBub3QgY3VycmVudGx5IGNvbm5lY3RlZCwgY2FsbGluZyB0aGlzIG1ldGhvZCBjYXVzZXMgYSB3YXJuaW5nIHRvIGJlIGxvZ2dlZC4KICAqIFNlZSA8YSAiaHJlZj1UQi5odG1sI3NldExvZ0xldmVsIj5UQi5zZXRMb2dMZXZlbCgpPC9hPi4KICAqIDwvcD4KICAqCiAgKiA8cD4KICAqIDxpPk5vdGU6PC9pPiBJZiB5b3UgaW50ZW5kIHRvIHJldXNlIGEgUHVibGlzaGVyIG9iamVjdCBjcmVhdGVkIHVzaW5nIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4KICAqIHRvIHB1Ymxpc2ggdG8gZGlmZmVyZW50IHNlc3Npb25zIHNlcXVlbnRpYWxseSwgY2FsbCBlaXRoZXIgPGNvZGU+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2NvZGU+IG9yCiAgKiA8Y29kZT5TZXNzaW9uLnVucHVibGlzaCgpPC9jb2RlPi4gRG8gbm90IGNhbGwgYm90aC4gVGhlbiBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2QKICAqIG9mIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IG9yIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0ZWQ8L2NvZGU+IGV2ZW50IG9iamVjdCB0byBwcmV2ZW50IHRoZQogICogUHVibGlzaGVyIG9iamVjdCBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcGFnZS4gQmUgc3VyZSB0byBjYWxsIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+IG9ubHkKICAqIGlmIHRoZSA8Y29kZT5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgb2YgdGhlIFN0cmVhbSBvYmplY3QgaW4gdGhlIGV2ZW50IG1hdGNoZXMgdGhlCiAgKiA8Y29kZT5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgb2YgeW91ciBTZXNzaW9uIG9iamVjdCAodG8gZW5zdXJlIHRoYXQgeW91IGFyZSBwcmV2ZW50aW5nCiAgKiB0aGUgZGVmYXVsdCBiZWhhdmlvciBmb3IgeW91ciBwdWJsaXNoZWQgc3RyZWFtcywgbm90IGZvciBvdGhlciBzdHJlYW1zIHRoYXQgeW91IHN1YnNjcmliZSB0bykuCiAgKiA8L3A+CiAgKgogICogPGg1PgogICogRXZlbnRzIGRpc3BhdGNoZWQ6CiAgKiA8L2g1PgogICogPHA+CiAgKiA8Y29kZT5zZXNzaW9uRGlzY29ubmVjdGVkPC9jb2RlPiAoPGEgaHJlZj0iU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudC5odG1sIj5TZXNzaW9uRGlzY29ubmVjdEV2ZW50PC9hPikKICAqICYjMTUxOyBEaXNwYXRjaGVkIGxvY2FsbHkgd2hlbiB0aGUgY29ubmVjdGlvbiBpcyBkaXNjb25uZWN0ZWQuCiAgKiA8L3A+CiAgKiA8cD4KICAqIDxjb2RlPmNvbm5lY3Rpb25EZXN0cm95ZWQ8L2NvZGU+ICg8YSBocmVmPSJDb25uZWN0aW9uRXZlbnQuaHRtbCI+Q29ubmVjdGlvbkV2ZW50PC9hPikgJiMxNTE7CiAgKiBEaXNwYXRjaGVkIG9uIG90aGVyIGNvbm5lY3Rpb25zLCBhbG9uZyB3aXRoIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50IChhcyB3YXJyYW50ZWQpLgogICogPC9wPgogICoKICAqIDxwPgogICogPGNvZGU+c3RyZWFtRGVzdHJveWVkPC9jb2RlPiAoPGEgaHJlZj0iU3RyZWFtRXZlbnQuaHRtbCI+U3RyZWFtRXZlbnQ8L2E+KSAmIzE1MTsKICAqIERpc3BhdGNoZWQgaWYgc3RyZWFtcyBhcmUgbG9zdCBhcyBhIHJlc3VsdCBvZiB0aGUgc2Vzc2lvbiBkaXNjb25uZWN0aW5nLgogICogPC9wPgogICoKICAqIEBtZXRob2QgI2Rpc2Nvbm5lY3QKICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLmRpc2Nvbm5lY3QgPSBmdW5jdGlvbigpIHsKICAgIGlmIChfc29ja2V0ICYmIF9zb2NrZXQuaXNOb3QoJ2Rpc2Nvbm5lY3RlZCcpKSB7CiAgICAgIHNldFN0YXRlKCdkaXNjb25uZWN0aW5nJyk7CiAgICAgIF9zb2NrZXQuZGlzY29ubmVjdCgpOwogICAgfQogICAgZWxzZSB7CiAgICAgIHJlc2V0LmNhbGwodGhpcyk7CiAgICB9CiAgfTsKCiAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24ocmVhc29uLCBxdWlldCkgewogICAgdGhpcy5zdHJlYW1zLmRlc3Ryb3koKTsKICAgIHRoaXMuY29ubmVjdGlvbnMuZGVzdHJveSgpOwogICAgdGhpcy5kaXNjb25uZWN0KCk7CiAgfTsKCiAvKioKICAqIFRoZSA8Y29kZT5wdWJsaXNoKCk8L2NvZGU+IG1ldGhvZCBzdGFydHMgcHVibGlzaGluZyBhbiBhdWRpby12aWRlbyBzdHJlYW0gdG8gdGhlIHNlc3Npb24uCiAgKiBUaGUgYXVkaW8tdmlkZW8gc3RyZWFtIGlzIGNhcHR1cmVkIGZyb20gYSBsb2NhbCBtaWNyb3Bob25lIGFuZCB3ZWJjYW0uIFVwb24gc3VjY2Vzc2Z1bCBwdWJsaXNoaW5nLAogICogdGhlIFNlc3Npb24gb2JqZWN0cyBvbiBhbGwgY29ubmVjdGVkIGNsaWVudHMgZGlzcGF0Y2ggdGhlIDxjb2RlPnN0cmVhbUNyZWF0ZWQ8L2NvZGU+IGV2ZW50LgogICogPC9wPgogICoKICAqIDwhLS1KUy1PTkxZLS0+CiAgKiA8cD5Zb3UgcGFzcyBhIFB1Ymxpc2hlciBvYmplY3QgYXMgdGhlIG9uZSBwYXJhbWV0ZXIgb2YgdGhlIG1ldGhvZC4gWW91IGNhbiBpbml0aWFsaXplIGEgUHVibGlzaGVyIG9iamVjdCBieSBjYWxsaW5nIHRoZQogICogPGEgaHJlZj0iVEIuaHRtbCNpbml0UHVibGlzaGVyIj5UQi5pbml0UHVibGlzaGVyKCk8L2E+IG1ldGhvZC4gQmVmb3JlIGNhbGxpbmcgPGNvZGU+U2Vzc2lvbi5wdWJsaXNoKCk8L2NvZGU+LgogICogPC9wPgogICoKICAqIDxwPlRoaXMgbWV0aG9kIHRha2VzIGFuIGFsdGVybmF0ZSBmb3JtOiA8Y29kZT5wdWJsaXNoKFt0YXJnZXRFbGVtZW50OlN0cmluZywgcHJvcGVydGllczpPYmplY3RdKTpQdWJsaXNoZXI8L2NvZGU+ICYjMTUxOwogICogSW4gdGhpcyBmb3JtLCB5b3UgZG8gPGk+bm90PC9pPiBwYXNzIGEgUHVibGlzaGVyIG9iamVjdCBpbnRvIHRoZSBmdW5jdGlvbi4gSW5zdGVhZCwgeW91IHBhc3MgaW4gYSA8Y29kZT50YXJnZXRFbGVtZW50PC9jb2RlPgogICogKHRoZSBJRCBvZiB0aGUgRE9NIGVsZW1lbnQgdGhhdCB0aGUgUHVibGlzaGVyIHdpbGwgcmVwbGFjZSkgYW5kIGEgPGNvZGU+cHJvcGVydGllczwvY29kZT4gb2JqZWN0IHRoYXQgZGVmaW5lcwogICogb3B0aW9ucyBmb3IgdGhlIFB1Ymxpc2hlciAoc2VlIDxhIGhyZWY9IlRCLmh0bWwjaW5pdFB1Ymxpc2hlciI+VEIuaW5pdFB1Ymxpc2hlcigpPC9hPi4pIFRoZSBtZXRob2QKICAqIHJldHVybnMgYSBuZXcgUHVibGlzaGVyIG9iamVjdCwgd2hpY2ggc3RhcnRzIHNlbmRpbmcgYW4gYXVkaW8tdmlkZW8gc3RyZWFtIHRvIHRoZSBzZXNzaW9uLgogICogVGhlIHJlbWFpbmRlciBvZiB0aGlzIGRvY3VtZW50YXRpb24gZGVzY3JpYmVzIHRoZSBmb3JtIHRoYXQgdGFrZXMgYSBzaW5nbGUgUHVibGlzaGVyIG9iamVjdCBhcyBhIHBhcmFtZXRlci4KICAqCiAgKiA8cD4KICAqICAgQSBsb2NhbCBkaXNwbGF5IG9mIHRoZSBwdWJsaXNoZWQgc3RyZWFtIGlzIGNyZWF0ZWQgb24gdGhlIHdlYiBwYWdlIGJ5IHJlcGxhY2luZwogICogICAgICAgICB0aGUgc3BlY2lmaWVkIGVsZW1lbnQgaW4gdGhlIERPTSB3aXRoIGEgc3RyZWFtaW5nIHZpZGVvIGRpc3BsYXkuIFRoZSB2aWRlbyBzdHJlYW0KICAqICAgICAgICAgaXMgYXV0b21hdGljYWxseSBtaXJyb3JlZCBob3Jpem9udGFsbHkgc28gdGhhdCB1c2VycyBzZWUgdGhlbXNlbHZlcyBhbmQgbW92ZW1lbnQKICAqICAgICAgICAgaW4gdGhlaXIgc3RyZWFtIGluIGEgbmF0dXJhbCB3YXkuIElmIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBkaXNwbGF5IGRvIG5vdCBtYXRjaAogICogICAgICAgICB0aGUgNDozIGFzcGVjdCByYXRpbyBvZiB0aGUgdmlkZW8gc2lnbmFsLCB0aGUgdmlkZW8gc3RyZWFtIGlzIGNyb3BwZWQgdG8gZml0IHRoZSBkaXNwbGF5LgogICogPC9wPgogICoKICAqIDxwPgogICogICBJZiBjYWxsaW5nIHRoaXMgbWV0aG9kIGNyZWF0ZXMgYSBuZXcgUHVibGlzaGVyIG9iamVjdCBhbmQgdGhlIE9wZW5Ub2sgbGlicmFyeSBkb2VzIG5vdCBoYXZlIGFjY2VzcyB0bwogICogICB0aGUgY2FtZXJhIG9yIG1pY3JvcGhvbmUsIHRoZSB3ZWIgcGFnZSBhbGVydHMgdGhlIHVzZXIgdG8gZ3JhbnQgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuCiAgKiA8L3A+CiAgKgogICogPHA+CiAgKiBUaGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgYW4gPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudCBpZiB0aGUgdXNlcidzIHJvbGUgZG9lcyBub3QKICAqIGluY2x1ZGUgcGVybWlzc2lvbnMgcmVxdWlyZWQgdG8gcHVibGlzaC4gRm9yIGV4YW1wbGUsIGlmIHRoZSB1c2VyJ3Mgcm9sZSBpcyBzZXQgdG8gc3Vic2NyaWJlciwKICAqIHRoZW4gdGhleSBjYW5ub3QgcHVibGlzaC4gWW91IGRlZmluZSBhIHVzZXIncyByb2xlIHdoZW4geW91IGNyZWF0ZSB0aGUgdXNlciB0b2tlbiB1c2luZyB0aGUgPGNvZGU+Z2VuZXJhdGVfdG9rZW4oKTwvY29kZT4gbWV0aG9kCiAgKiBvZiBvdXIgPGEgaHJlZj0iL29wZW50b2svbGlicmFyaWVzL3NlcnZlci8iPnNlcnZlci1zaWRlIGxpYnJhcmllczwvYT4gb3IgdGhlIDxhIGhyZWY9Imh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMiPkRhc2hib2FyZDwvYT4gcGFnZS4KICAqIFlvdSBwYXNzIHRoZSB0b2tlbiBzdHJpbmcgYXMgYSBwYXJhbWV0ZXIgb2YgdGhlIDxjb2RlPmNvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4KICAqIFNlZSA8YSBocmVmPSJFeGNlcHRpb25FdmVudC5odG1sIj5FeGNlcHRpb25FdmVudDwvYT4gYW5kIDxhIGhyZWY9IlRCLmh0bWwjYWRkRXZlbnRMaXN0ZW5lciI+VEIuYWRkRXZlbnRMaXN0ZW5lcigpPC9hPi4KICAqIDwvcD4KICAqICAgICA8cD4KICAqICAgICBUaGUgYXBwbGljYXRpb24gdGhyb3dzIGFuIGVycm9yIGlmIHRoZSBzZXNzaW9uIGlzIG5vdCBjb25uZWN0ZWQuCiAgKiAgICAgPC9wPgogICoKICAqIDxoNT5FdmVudHMgZGlzcGF0Y2hlZDo8L2g1PgogICogPHA+CiAgKiA8Y29kZT5leGNlcHRpb248L2NvZGU+ICg8YSBocmVmPSJFeGNlcHRpb25FdmVudC5odG1sIj5FeGNlcHRpb25FdmVudDwvYT4pICYjMTUxOyBEaXNwYXRjaGVkIGJ5IHRoZSBUQiBvYmplY3QuIFRoaXMKICAqIGNhbiBvY2N1ciB3aGVuIHVzZXIncyByb2xlIGRvZXMgbm90IGFsbG93IHB1Ymxpc2hpbmcgKHRoZSA8Y29kZT5jb2RlPC9jb2RlPiBwcm9wZXJ0eSBvZiBldmVudCBvYmplY3QgaXMgc2V0IHRvIDE1MDApOwogICogaXQgY2FuIGFsc28gb2NjdXIgaWYgdGhlIGNvbm5lY3Rpb24gZmFpbHMgdG8gY29ubmVjdCAodGhlIDxjb2RlPmNvZGU8L2NvZGU+IHByb3BlcnR5IG9mIGV2ZW50IG9iamVjdCBpcyBzZXQgdG8gMTAxMykuCiAgKiBXZWJSVEMgaXMgYSBwZWVyLXRvLXBlZXIgcHJvdG9jb2wsIGFuZCBpdCBpcyBwb3NzaWJsZSB0aGF0IGNvbm5lY3Rpb25zIHdpbGwgZmFpbCB0byBjb25uZWN0LiBUaGUgbW9zdCBjb21tb24gY2F1c2UKICAqIGZvciBmYWlsdXJlIGlzIGEgZmlyZXdhbGwgdGhhdCB0aGUgcHJvdG9jb2wgY2Fubm90IHRyYXZlcnNlLjwvbGk+CiAgKiA8L3A+CiAgKiA8cD4KICAqIDxjb2RlPnN0cmVhbUNyZWF0ZWQ8L2NvZGU+ICg8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sIj5TdHJlYW1FdmVudDwvYT4pICYjMTUxOwogICogVGhlIHN0cmVhbSBoYXMgYmVlbiBwdWJsaXNoZWQuIFRoZSBTZXNzaW9uIG9iamVjdCBkaXNwYXRjaGVzIHRoaXMgb24gYWxsIGNsaWVudHMKICAqIHN1YnNjcmliZWQgdG8gdGhlIHN0cmVhbSwgYXMgd2VsbCBhcyBvbiB0aGUgcHVibGlzaGVyJ3MgY2xpZW50LgogICogPC9wPgogICoKICAqIDxoNT5FeGFtcGxlPC9oNT4KICAqCiAgKiA8cD4KICAqICAgVGhlIGZvbGxvd2luZyBleGFtcGxlIHB1Ymxpc2hlcyBhIHZpZGVvIG9uY2UgdGhlIHNlc3Npb24gY29ubmVjdHM6CiAgKiA8L3A+CiAgKiA8cHJlPgogICogdmFyIGFwaUtleSA9ICIiOyAvLyBSZXBsYWNlIHdpdGggeW91ciBBUEkga2V5LiBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogICogdmFyIHNlc3Npb25JZCA9ICIiOyAvLyBSZXBsYWNlIHdpdGggeW91ciBvd24gc2Vzc2lvbiBJRC4KICAqICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICAqIHZhciB0b2tlbiA9ICIiOyAvLyBSZXBsYWNlIHdpdGggYSBnZW5lcmF0ZWQgdG9rZW4gdGhhdCBoYXMgYmVlbiBhc3NpZ25lZCB0aGUgbW9kZXJhdG9yIHJvbGUuCiAgKiAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICAqIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigic2Vzc2lvbkNvbm5lY3RlZCIsIHNlc3Npb25Db25uZWN0SGFuZGxlcik7CiAgKiBzZXNzaW9uLmNvbm5lY3QoYXBpS2V5LCB0b2tlbik7CiAgKgogICogZnVuY3Rpb24gc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKGV2ZW50KSB7CiAgKiAgICAgdmFyIGRpdlByb3BzID0ge3dpZHRoOiA0MDAsIGhlaWdodDozMDAsIG5hbWU6IkJvYidzIHN0cmVhbSJ9OwogICogICAgIHB1Ymxpc2hlciA9IFRCLmluaXRQdWJsaXNoZXIoYXBpS2V5LCAncHVibGlzaGVyJywgZGl2UHJvcHMpOwogICogICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXNzdW1lcyB0aGF0IHRoZXJlIGlzIGEgRE9NIGVsZW1lbnQgd2l0aCB0aGUgSUQgJ3B1Ymxpc2hlcicuCiAgKiAgICAgc2Vzc2lvbi5wdWJsaXNoKHB1Ymxpc2hlcik7CiAgKiB9CiAgKiA8L3ByZT4KICAqCiAgKiBAcGFyYW0gcHVibGlzaGVyIEEgUHVibGlzaGVyIG9iamVjdCwgd2hpY2ggeW91IGluaXRpYWxpemUgYnkgY2FsbGluZyB0aGUgPGEgaHJlZj0iVEIuaHRtbCNpbml0UHVibGlzaGVyIj5UQi5pbml0UHVibGlzaGVyKCk8L2E+CiAgKiBtZXRob2QuCiAgKgogICogQHJldHVybnMgVGhlIFB1Ymxpc2hlciBvYmplY3QgZm9yIHRoaXMgc3RyZWFtLgogICoKICAqIEBtZXRob2QgI3B1Ymxpc2gKICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLnB1Ymxpc2ggPSBmdW5jdGlvbihwdWJsaXNoZXIsIHByb3BlcnRpZXMsIGNvbXBsZXRpb25IYW5kbGVyKSB7CiAgICB2YXIgZXJyb3JNc2c7CgogICAgaWYgKHRoaXMuaXNOb3QoJ2Nvbm5lY3RlZCcpKSB7CiAgICAgIF9hbmFseXRpY3MubG9nRXJyb3IoMTAxMCwgJ3RiLmV4Y2VwdGlvbicsICJXZSBuZWVkIHRvIGJlIGNvbm5lY3RlZCBiZWZvcmUgeW91IGNhbiBwdWJsaXNoIiwgbnVsbCwgewogICAgICAgIGFjdGlvbjogJ3B1Ymxpc2gnLAogICAgICAgIHZhcmlhdGlvbjogJ0ZhaWx1cmUnLAogICAgICAgIHBheWxvYWRfdHlwZTogInJlYXNvbiIsCiAgICAgICAgcGF5bG9hZDogIldlIG5lZWQgdG8gYmUgY29ubmVjdGVkIGJlZm9yZSB5b3UgY2FuIHB1Ymxpc2giLAogICAgICAgIHNlc3Npb25faWQ6IF9zZXNzaW9uSWQsCiAgICAgICAgcGFydG5lcl9pZDogX2FwaUtleSwKICAgICAgICB3aWRnZXRJZDogX3dpZGdldElkLAogICAgICAgIHdpZGdldF90eXBlOiAnQ29udHJvbGxlcicKICAgICAgfSk7CgogICAgICBpZiAoY29tcGxldGlvbkhhbmRsZXIgJiYgT1QuJC5pc0Z1bmN0aW9uKGNvbXBsZXRpb25IYW5kbGVyKSkgewogICAgICAgIGVycm9yTXNnID0gIldlIG5lZWQgdG8gYmUgY29ubmVjdGVkIGJlZm9yZSB5b3UgY2FuIHB1Ymxpc2giOwogICAgICAgIE9ULiQuY2FsbEFzeW5jKGNvbXBsZXRpb25IYW5kbGVyLCBuZXcgT1QuRXJyb3IoT1QuRXhjZXB0aW9uQ29kZXMuTk9UX0NPTk5FQ1RFRCwgZXJyb3JNc2cpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgaWYgKCFwZXJtaXR0ZWRUbygicHVibGlzaCIpKSB7CiAgICAgIHRoaXMubG9nRXZlbnQoJ3B1Ymxpc2gnLCAnRmFpbHVyZScsICdyZWFzb24nLCAnVGhpcyB0b2tlbiBkb2VzIG5vdCBhbGxvdyBwdWJsaXNoaW5nLiBUaGUgcm9sZSBtdXN0IGJlIGF0IGxlYXN0IGBwdWJsaXNoZXJgIHRvIGVuYWJsZSB0aGlzIGZ1bmN0aW9uYWxpdHknKTsKCiAgICAgIFRCLmhhbmRsZUpzRXhjZXB0aW9uKCJUaGlzIHRva2VuIGRvZXMgbm90IGFsbG93IHB1Ymxpc2hpbmcuIFRoZSByb2xlIG11c3QgYmUgYXQgbGVhc3QgYHB1Ymxpc2hlcmAgdG8gZW5hYmxlIHRoaXMgZnVuY3Rpb25hbGl0eSIsIE9ULkV4Y2VwdGlvbkNvZGVzLlVOQUJMRV9UT19QVUJMSVNILCB7CiAgICAgICAgc2Vzc2lvbjogdGhpcwogICAgICB9KTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gSWYgdGhlIHVzZXIgaGFzIHBhc3NlZCBpbiBhbiBJRCBvZiBhIGVsZW1lbnQgdGhlbiB3ZSBjcmVhdGUgYSBuZXcgcHVibGlzaGVyLgogICAgaWYgKCFwdWJsaXNoZXIgfHwgdHlwZW9mKHB1Ymxpc2hlcik9PT0nc3RyaW5nJyB8fCBwdWJsaXNoZXIubm9kZVR5cGUgPT0gTm9kZS5FTEVNRU5UX05PREUpewogICAgICAvLyBJbml0aWF0ZSBhIG5ldyBQdWJsaXNoZXIgd2l0aCB0aGUgbmV3IHNlc3Npb24gY3JlZGVudGlhbHMKICAgICBwdWJsaXNoZXIgPSBPVC5pbml0UHVibGlzaGVyKHRoaXMuYXBpS2V5LCBwdWJsaXNoZXIsIHByb3BlcnRpZXMpOwogICAgfQogICAgZWxzZSBpZiAocHVibGlzaGVyIGluc3RhbmNlb2YgT1QuUHVibGlzaGVyKXsKCiAgICAgIC8vIElmIHRoZSBwdWJsaXNoZXIgYWxyZWFkeSBoYXMgYSBzZXNzaW9uIGF0dGFjaGVkIHRvIGl0IHdlIGNhbgogICAgICBpZiggInNlc3Npb24iIGluIHB1Ymxpc2hlciAmJiBwdWJsaXNoZXIuc2Vzc2lvbiAmJiAic2Vzc2lvbklkIiBpbiBwdWJsaXNoZXIuc2Vzc2lvbiApewogICAgICAgIC8vIHNlbmQgYSB3YXJuaW5nIG1lc3NhZ2UgdGhhdCB3ZSBjYW4ndCBwdWJsaXNoIGFnYWluLgogICAgICAgIGlmKCBwdWJsaXNoZXIuc2Vzc2lvbi5zZXNzaW9uSWQgPT09IHRoaXMuc2Vzc2lvbklkKXsKICAgICAgICAgIE9ULndhcm4oIkNhbm5vdCBwdWJsaXNoICIgKyBwdWJsaXNoZXIuZ3VpZCArICIgYWdhaW4gdG8gIiArIHRoaXMuc2Vzc2lvbklkICsgIi4gUGxlYXNlIGNhbGwgc2Vzc2lvbi51bnB1Ymxpc2gocHVibGlzaGVyKSBmaXJzdC4iKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBPVC53YXJuKCJDYW5ub3QgcHVibGlzaCAiICsgcHVibGlzaGVyLmd1aWQgKyAiIHB1Ymxpc2hlciBhbHJlYWR5IGF0dGFjaGVkIHRvICIgKyBwdWJsaXNoZXIuc2Vzc2lvbi5zZXNzaW9uSWQrICIuIFBsZWFzZSBjYWxsIHNlc3Npb24udW5wdWJsaXNoKHB1Ymxpc2hlcikgZmlyc3QuIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBlbHNlIHsKICAgICAgZXJyb3JNc2cgPSAiU2Vzc2lvbi5wdWJsaXNoIDo6IEZpcnN0IHBhcmFtZXRlciBwYXNzZWQgaW4gaXMgbmVpdGhlciBhIHN0cmluZyBub3IgYW4gaW5zdGFuY2Ugb2YgdGhlIFB1Ymxpc2hlciI7CiAgICAgIE9ULmVycm9yKGVycm9yTXNnKTsKICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTXNnKTsKICAgIH0KCiAgICBpZiAoY29tcGxldGlvbkhhbmRsZXIgJiYgT1QuJC5pc0Z1bmN0aW9uKGNvbXBsZXRpb25IYW5kbGVyKSkgcHVibGlzaGVyLm9uY2UoJ3B1Ymxpc2hDb21wbGV0ZScsIGNvbXBsZXRpb25IYW5kbGVyKTsKCiAgICAvLyBBZGQgcHVibGlzaGVyIHJlZmVyZW5jZSB0byB0aGUgc2Vzc2lvbgogICAgcHVibGlzaGVyLl8ucHVibGlzaFRvU2Vzc2lvbih0aGlzKTsKCiAgICAvLyByZXR1cm4gdGhlIGVtYmVkIHB1Ymxpc2hlcgogICAgcmV0dXJuIHB1Ymxpc2hlcjsKICB9OwoKIC8qKgogICogQ2Vhc2VzIHB1Ymxpc2hpbmcgdGhlIHNwZWNpZmllZCBwdWJsaXNoZXIncyBhdWRpby12aWRlbyBzdHJlYW0KICAqIHRvIHRoZSBzZXNzaW9uLiBCeSBkZWZhdWx0LCB0aGUgbG9jYWwgcmVwcmVzZW50YXRpb24gb2YgdGhlIGF1ZGlvLXZpZGVvIHN0cmVhbSBpcyByZW1vdmVkIGZyb20gdGhlCiAgKiB3ZWIgcGFnZS48IFVwb24gc3VjY2Vzc2Z1bCB0ZXJtaW5hdGlvbiwgdGhlIFNlc3Npb24gb2JqZWN0IG9uIGV2ZXJ5IGNvbm5lY3RlZAogICogd2ViIHBhZ2UgZGlzcGF0Y2hlcwogICogYSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50LgogICogPC9wPgogICoKICAqIDxwPgogICogVG8gcHJldmVudCB0aGUgUHVibGlzaGVyIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sIGFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgdGhlCiAgKiA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50IGFuZCBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIGV2ZW50IG9iamVjdC4KICAqIDwvcD4KICAqCiAgKiA8cD4KICAqIDxpPk5vdGU6PC9pPiBJZiB5b3UgaW50ZW5kIHRvIHJldXNlIGEgUHVibGlzaGVyIG9iamVjdCBjcmVhdGVkIHVzaW5nIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4KICAqIHRvIHB1Ymxpc2ggdG8gZGlmZmVyZW50IHNlc3Npb25zIHNlcXVlbnRpYWxseSwgY2FsbCBlaXRoZXIgPGNvZGU+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2NvZGU+IG9yCiAgKiA8Y29kZT5TZXNzaW9uLnVucHVibGlzaCgpPC9jb2RlPi4gRG8gbm90IGNhbGwgYm90aC4gVGhlbiBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2QKICAqIG9mIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IG9yIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0ZWQ8L2NvZGU+IGV2ZW50IG9iamVjdCB0byBwcmV2ZW50IHRoZQogICogUHVibGlzaGVyIG9iamVjdCBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcGFnZS4gQmUgc3VyZSB0byBjYWxsIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+IG9ubHkKICAqIGlmIHRoZSA8Y29kZT5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgb2YgdGhlIFN0cmVhbSBvYmplY3QgaW4gdGhlIGV2ZW50IG1hdGNoZXMgdGhlCiAgKiA8Y29kZT5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgb2YgeW91ciBTZXNzaW9uIG9iamVjdCAodG8gZW5zdXJlIHRoYXQgeW91IGFyZSBwcmV2ZW50aW5nCiAgKiB0aGUgZGVmYXVsdCBiZWhhdmlvciBmb3IgeW91ciBwdWJsaXNoZWQgc3RyZWFtcywgbm90IGZvciBvdGhlciBzdHJlYW1zIHRoYXQgeW91IHN1YnNjcmliZSB0bykuCiAgKiA8L3A+CiAgKgogICogPGg1PkV2ZW50cyBkaXNwYXRjaGVkOjwvaDU+CiAgKgogICogPHA+CiAgKiA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+ICg8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sIj5TdHJlYW1FdmVudDwvYT4pICYjMTUxOwogICogVGhlIHN0cmVhbSBhc3NvY2lhdGVkIHdpdGggdGhlIFB1Ymxpc2hlciBoYXMgYmVlbiBkZXN0cm95ZWQuIERpc3BhdGNoZWQgb24KICAqIHRoZSBQdWJsaXNoZXIncyBicm93c2VyIGFuZCBvbiB0aGUgYnJvd3NlciBmb3IgYWxsIGNvbm5lY3Rpb25zIHN1YnNjcmliaW5nCiAgKiB0byB0aGUgcHVibGlzaGVyJ3Mgc3RyZWFtLgogICogICAgICAgICAgICAgICAgPC9wPgogICoKICAqIDxoNT5FeGFtcGxlPC9oNT4KICAqCiAgKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgcHVibGlzaGVzIGEgc3RyZWFtIHRvIGEgc2Vzc2lvbiBhbmQgYWRkcyBhIERpc2Nvbm5lY3QgbGluayB0byB0aGUgd2ViIHBhZ2UuIENsaWNraW5nIHRoaXMgbGluayBjYXVzZXMgdGhlIHN0cmVhbSB0byBzdG9wIGJlaW5nIHB1Ymxpc2hlZC4KICAqCiAgKiA8cHJlPgogICogJmx0O3NjcmlwdCZndDsKICAqICAgICB2YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAgKiAgICAgdmFyIHNlc3Npb25JRCA9ICIiOyAvLyBSZXBsYWNlIHdpdGggeW91ciBvd24gc2Vzc2lvbiBJRC4KICAqICAgICAgICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAgKiAgICAgdmFyIHRva2VuID0gIlJlcGxhY2Ugd2l0aCB0aGUgVG9rQm94IHRva2VuIHN0cmluZyBwcm92aWRlZCB0byB5b3UuIgogICogICAgIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICAqICAgICBzZXNzaW9uLmFkZEV2ZW50TGlzdGVuZXIoInNlc3Npb25Db25uZWN0ZWQiLCBzZXNzaW9uQ29ubmVjdEhhbmRsZXIpOwogICogICAgIHNlc3Npb24uY29ubmVjdChhcGlLZXksIHRva2VuKTsKICAqICAgICB2YXIgcHVibGlzaGVyOwogICoKICAqICAgICBmdW5jdGlvbiBzZXNzaW9uQ29ubmVjdEhhbmRsZXIoZXZlbnQpIHsKICAqICAgICAgICAgcHVibGlzaGVyID0gVEIuaW5pdFB1Ymxpc2hlcihhcGlLZXksICdwdWJsaXNoZXInKTsKICAqICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXNzdW1lcyB0aGF0IHRoZXJlIGlzIGEgRE9NIGVsZW1lbnQgd2l0aCB0aGUgSUQgJ3B1Ymxpc2hlcicuCiAgKiAgICAgICAgIHNlc3Npb24ucHVibGlzaChwdWJsaXNoZXIpOwogICogICAgIH0KICAqICAgICBmdW5jdGlvbiB1bnB1YmxzaCgpIHsKICAqICAgICAgICAgc2Vzc2lvbi51bnB1Ymxpc2gocHVibGlzaGVyKTsKICAqICAgICB9CiAgKiAmbHQ7L3NjcmlwdCZndDsKICAqCiAgKiAmbHQ7Ym9keSZndDsKICAqCiAgKiAgICAgJmx0O2RpdiBpZD0icHVibGlzaGVyQ29udGFpbmVyLyZndDsKICAqICAgICAmbHQ7YnIvJmd0OwogICoKICAqICAgICAmbHQ7YSBocmVmPSJqYXZhc2NyaXB0OnVucHVibGlzaCgpIiZndDtTdG9wIFB1Ymxpc2hpbmcmbHQ7L2EmZ3Q7CiAgKgogICogJmx0Oy9ib2R5Jmd0OwogICoKICAqIDwvcHJlPgogICoKICAqIEBzZWUgPGEgaHJlZj0iI3B1Ymxpc2giPnB1Ymxpc2goKTwvYT4KICAqCiAgKiBAc2VlIDxhIGhyZWY9IlN0cmVhbUV2ZW50Lmh0bWwiPnN0cmVhbURlc3Ryb3llZCBldmVudDwvYT4KICAqCiAgKiBAcGFyYW0ge1B1Ymxpc2hlcn0gcHVibGlzaGVyPC9zcGFuPiBUaGUgUHVibGlzaGVyIG9iamVjdCB0byBzdG9wIHN0cmVhbWluZy4KICAqCiAgKiBAbWV0aG9kICN1bnB1Ymxpc2gKICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLnVucHVibGlzaCA9IGZ1bmN0aW9uKHB1Ymxpc2hlcikgewogICAgaWYgKCFwdWJsaXNoZXIpIHsKICAgICAgT1QuZXJyb3IoJ09ULlNlc3Npb24udW5wdWJsaXNoOiBwdWJsaXNoZXIgcGFyYW1ldGVyIG1pc3NpbmcuJyk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBVbnB1Ymxpc2ggdGhlIGxvY2FsTWVkaWEgcHVibGlzaGVyCiAgICBwdWJsaXNoZXIuXy51bnB1Ymxpc2hGcm9tU2Vzc2lvbih0aGlzKTsKICB9OwoKCiAvKioKICAqIFN1YnNjcmliZXMgdG8gYSBzdHJlYW0gdGhhdCBpcyBhdmFpbGFibGUgdG8gdGhlIHNlc3Npb24uIFlvdSBjYW4gZ2V0IGFuIGFycmF5IG9mCiAgKiBhdmFpbGFibGUgc3RyZWFtcyBmcm9tIHRoZSA8Y29kZT5zdHJlYW1zPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUgPGNvZGU+c2Vzc2lvbkNvbm5lY3RlZDwvY29kZT4KICAqIGFuZCA8Y29kZT5zdHJlYW1DcmVhdGVkPC9jb2RlPiBldmVudHMgKHNlZSA8YSBocmVmPSJTZXNzaW9uQ29ubmVjdEV2ZW50Lmh0bWwiPlNlc3Npb25Db25uZWN0RXZlbnQ8L2E+IGFuZAogICogPGEgaHJlZj0iU3RyZWFtRXZlbnQuaHRtbCI+U3RyZWFtRXZlbnQ8L2E+KS4KICAqIDwvcD4KICAqIDxwPgogICogVGhlIHN1YnNjcmliZWQgc3RyZWFtIGlzIGRpc3BsYXllZCBvbiB0aGUgbG9jYWwgd2ViIHBhZ2UgYnkgcmVwbGFjaW5nIHRoZSBzcGVjaWZpZWQgZWxlbWVudCBpbiB0aGUgRE9NIHdpdGggYSBzdHJlYW1pbmcgdmlkZW8gZGlzcGxheS4KICAqIElmIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBkaXNwbGF5IGRvIG5vdCBtYXRjaCB0aGUgNDozIGFzcGVjdCByYXRpbyBvZiB0aGUgdmlkZW8gc2lnbmFsLCB0aGUgdmlkZW8gc3RyZWFtIGlzIGNyb3BwZWQgdG8gZml0CiAgKiB0aGUgZGlzcGxheS4gSWYgdGhlIHN0cmVhbSBsYWNrcyBhIHZpZGVvIGNvbXBvbmVudCwgYSBibGFuayBzY3JlZW4gd2l0aCBhbiBhdWRpbyBpbmRpY2F0b3IgaXMgZGlzcGxheWVkIGluIHBsYWNlIG9mIHRoZSB2aWRlbyBzdHJlYW0uCiAgKiA8L3A+CiAgKgogICogPHA+CiAgKiBUaGUgYXBwbGljYXRpb24gdGhyb3dzIGFuIGVycm9yIGlmIHRoZSBzZXNzaW9uIGlzIG5vdCBjb25uZWN0ZWQ8IS0tSlMtT05MWS0tPiBvciBpZiB0aGUKICAqIDxjb2RlPnRhcmdldEVsZW1lbnQ8L2NvZGU+IGRvZXMgbm90IGV4aXN0IGluIHRoZSBIVE1MIERPTTwhLS0vSlMtT05MWS0tPi4KICAqIDwvcD4KICAqCiAgKiA8aDU+RXhhbXBsZTwvaDU+CiAgKgogICogVGhlIGZvbGxvd2luZyBjb2RlIHN1YnNjcmliZXMgdG8gYXZhaWxhYmxlIHN0cmVhbXMgYXQgdGhlIHRpbWUgdGhhdCBhIHNlc3Npb24gaXMgY29ubmVjdGVkCiAgKgogICogPHByZT4KICAqIHZhciBhcGlLZXkgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgQVBJIGtleS4gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAgKiAgICAgICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAgKgogICogdmFyIHNlc3Npb24gPSBUQi5pbml0U2Vzc2lvbihzZXNzaW9uSUQpOwogICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzZXNzaW9uQ29ubmVjdGVkIiwgc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKTsKICAqIHNlc3Npb24uY29ubmVjdChhcGlLZXksIHRva2VuKTsKICAqCiAgKiBmdW5jdGlvbiBzZXNzaW9uQ29ubmVjdEhhbmRsZXIoZXZlbnQpIHsKICAqICAgICBmb3IgKHZhciBpID0gMDsgaSAmbHQ7IGV2ZW50LnN0cmVhbXMubGVuZ3RoOyBpKyspIHsKICAqICAgICAgICAgdmFyIHN0cmVhbSA9IGV2ZW50LnN0cmVhbXNbaV07CiAgKiAgICAgICAgIGRpc3BsYXlTdHJlYW0oc3RyZWFtKTsKICAqICAgICB9CiAgKiB9CiAgKgogICogZnVuY3Rpb24gZGlzcGxheVN0cmVhbShzdHJlYW0pIHsKICAqICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgKiAgICAgZGl2LnNldEF0dHJpYnV0ZSgnaWQnLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAgKiAgICAgdmFyIHN0cmVhbXNDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RyZWFtc0NvbnRhaW5lcicpOwogICogICAgIHN0cmVhbXNDb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAqICAgICBzdWJzY3JpYmVyID0gc2Vzc2lvbi5zdWJzY3JpYmUoc3RyZWFtLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAgKiB9CiAgKiA8L3ByZT4KICAqIDxwPgogICogWW91IGNhbiBhbHNvIGFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgdGhlIDxjb2RlPnN0cmVhbUNyZWF0ZWQ8L2NvZGU+IGV2ZW50LiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyB0aGlzIGV2ZW50IHdoZW4gYSBuZXcgc3RyZWFtIGlzIGNyZWF0ZWQuCiAgKiA8L3A+CiAgKiA8cHJlPgogICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzdHJlYW1DcmVhdGVkIiwgc3RyZWFtQ3JlYXRlZEhhbmRsZXIpOwogICoKICAqIGZ1bmN0aW9uIHN0cmVhbUNyZWF0ZWRIYW5kbGVyKGV2ZW50KSB7CiAgKiAgICAgZm9yICh2YXIgaSA9IDA7IGkgJmx0OyBldmVudC5zdHJlYW1zLmxlbmd0aDsgaSsrKSB7CiAgKiAgICAgICAgIHZhciBzdHJlYW0gPSBldmVudC5zdHJlYW1zW2ldOwogICogICAgICAgICBkaXNwbGF5U3RyZWFtKHN0cmVhbSk7CiAgKiAgICAgfQogICogfQogICogPC9wcmU+CiAgKgogICogQHBhcmFtIHtTdHJlYW19IHN0cmVhbSBUaGUgU3RyZWFtIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHN0cmVhbSB0byB3aGljaCB3ZSBhcmUgdHJ5aW5nIHRvIHN1YnNjcmliZS4KICAqCiAgKiBAcGFyYW0ge1N0cmluZ30gdGFyZ2V0RWxlbWVudCBUaGUgSUQgb2YgdGhlIGV4aXN0aW5nIERPTSBlbGVtZW50CiAgKiB0aGF0IHRoZSBTdWJzY3JpYmVyIHJlcGxhY2VzLiBJZiB5b3UgZG8gbm90IHNwZWNpZnkgYSA8Y29kZT50YXJnZXRFbGVtZW50PC9jb2RlPiwgdGhlIGFwcGxpY2F0aW9uCiAgKiBhcHBlbmRzIGEgbmV3IERPTSBlbGVtZW50IHRvIHRoZSBIVE1MIDxjb2RlPmJvZHk8L2NvZGU+LgogICoKICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0aWVzIFRoaXMgaXMgYW4gb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICogICAgPHVsPgogICogICAgICAgPGxpPjxjb2RlPmF1ZGlvVm9sdW1lPC9jb2RlPiAoTnVtYmVyKSAmIzE1MTsgVGhlIGRlc2lyZWQgYXVkaW8gdm9sdW1lLCBiZXR3ZWVuIDAgYW5kIDEwMCwgd2hlbiB0aGUgU3Vic2NyaWJlcgogICogICAgICAgaXMgZmlyc3Qgb3BlbmVkIChkZWZhdWx0OiA1MCkuIEFmdGVyIHlvdSBzdWJzY3JpYmUgdG8gdGhlIHN0cmVhbSwgeW91IGNhbiBhZGp1c3QgdGhlIHZvbHVtZSBieSBjYWxsaW5nCiAgKiAgICAgICB0aGUgPGEgaHJlZj0iU3Vic2NyaWJlci5odG1sI3NldEF1ZGlvVm9sdW1lIj48Y29kZT5zZXRBdWRpb1ZvbHVtZSgpPC9jb2RlPiBtZXRob2Q8L2E+IG9mIHRoZSBTdWJzY3JpYmVyCiAgKiAgICAgICBvYmplY3QuIFRoaXMgdm9sdW1lIHNldHRpbmcgYWZmZWN0cyBsb2NhbCBwbGF5YmFjayBvbmx5OyBpdCBkb2VzIG5vdCBhZmZlY3QgdGhlIHN0cmVhbSdzIHZvbHVtZSBvbiBvdGhlcgogICogICAgICAgY2xpZW50cy48L2xpPgogICoKICAqICAgICAgIDxsaT48Y29kZT5oZWlnaHQ8L2NvZGU+IChOdW1iZXIpICYjMTUxOyBUaGUgZGVzaXJlZCBoZWlnaHQsIGluIHBpeGVscywgb2YgdGhlCiAgKiAgICAgICAgZGlzcGxheWVkIFN1YnNjcmliZXIgdmlkZW8gc3RyZWFtIChkZWZhdWx0OiAxOTgpLiA8aT5Ob3RlOjwvaT4gVXNlIHRoZQogICogICAgICAgPGNvZGU+aGVpZ2h0PC9jb2RlPiBhbmQgPGNvZGU+d2lkdGg8L2NvZGU+IHByb3BlcnRpZXMgdG8gc2V0IHRoZSBkaW1lbnNpb25zCiAgKiAgICAgICBvZiB0aGUgU3Vic2NyaWJlciB2aWRlbzsgZG8gbm90IHNldCB0aGUgaGVpZ2h0IGFuZCB3aWR0aCBvZiB0aGUgRE9NIGVsZW1lbnQKICAqICAgICAgICh1c2luZyBDU1MpLjwvbGk+CiAgKgogICogICAgICAgPGxpPjxjb2RlPnN0eWxlLm5hbWVEaXNwbGF5TW9kZTwvY29kZT4gKFN0cmluZykgJiMxNTE7IFRoaXMgcHJvcGVydHkgZGV0ZXJtaW5lcyB3aGV0aGVyIHRvIGRpc3BsYXkgdGhlCiAgKiAgICAgICBzdHJlYW0gbmFtZS4gUG9zc2libGUgdmFsdWVzIGFyZTogPGNvZGU+ImF1dG8iPC9jb2RlPiAodGhlIG5hbWUgaXMgZGlzcGxheWVkIHdoZW4gdGhlIHN0cmVhbSBpcyBmaXJzdAogICogICAgICAgZGlzcGxheWVkIGFuZCB3aGVuIHRoZSB1c2VyIG1vdXNlcyBvdmVyIHRoZSBkaXNwbGF5KSwgPGNvZGU+Im9mZiI8L2NvZGU+ICh0aGUgbmFtZSBpcyBub3QgZGlzcGxheWVkKSwKICAqICAgICAgIGFuZCA8Y29kZT4ib24iPC9jb2RlPiAodGhlIG5hbWUgaXMgZGlzcGxheWVkKS48L2xpPgogICoKICAqICAgICAgIDxsaT48Y29kZT5zdWJzY3JpYmVUb0F1ZGlvPC9jb2RlPiAoQm9vbGVhbikgJiMxNTE7IFdoZXRoZXIgdG8gaW5pdGlhbGx5IHN1YnNjcmliZSB0byBhdWRpbwogICogICAgICAgKGlmIGF2YWlsYWJsZSkgZm9yIHRoZSBzdHJlYW0gKGRlZmF1bHQ6IDxjb2RlPnRydWU8L2NvZGU+KS48L2xpPgogICoKICAqICAgICAgIDxsaT48Y29kZT5zdWJzY3JpYmVUb1ZpZGVvPC9jb2RlPiAoQm9vbGVhbikgJiMxNTE7IFdoZXRoZXIgdG8gaW5pdGlhbGx5IHN1YnNjcmliZSB0byB2aWRlbwogICogICAgICAgKGlmIGF2YWlsYWJsZSkgZm9yIHRoZSBzdHJlYW0gKGRlZmF1bHQ6IDxjb2RlPnRydWU8L2NvZGU+KS48L2xpPgogICoKICAqICAgICAgIDxsaT48Y29kZT53aWR0aDwvY29kZT4gKE51bWJlcikgJiMxNTE7IFRoZSBkZXNpcmVkIHdpZHRoLCBpbiBwaXhlbHMsIG9mIHRoZQogICogICAgICAgZGlzcGxheWVkIFN1YnNjcmliZXIgdmlkZW8gc3RyZWFtIChkZWZhdWx0OiAyNjQpLiA8aT5Ob3RlOjwvaT4gVXNlIHRoZQogICogICAgICAgPGNvZGU+aGVpZ2h0PC9jb2RlPiBhbmQgPGNvZGU+d2lkdGg8L2NvZGU+IHByb3BlcnRpZXMgdG8gc2V0IHRoZSBkaW1lbnNpb25zCiAgKiAgICAgICAgb2YgdGhlIFN1YnNjcmliZXIgdmlkZW87IGRvIG5vdCBzZXQgdGhlIGhlaWdodCBhbmQgd2lkdGggb2YgdGhlIERPTSBlbGVtZW50CiAgKiAgICAgICAodXNpbmcgQ1NTKS48L2xpPgogICoKICAqICAgIDwvdWw+CiAgKgogICogQHNpZ25hdHVyZSBzdWJzY3JpYmUoc3RyZWFtLCB0YXJnZXRFbGVtZW50LCBwcm9wZXJ0aWVzKQogICogQHJldHVybnMge1N1YnNjcmliZXJ9IFRoZSBTdWJzY3JpYmVyIG9iamVjdCBmb3IgdGhpcyBzdHJlYW0uIFN0cmVhbSBjb250cm9sIGZ1bmN0aW9ucyBhcmUgZXhwb3NlZCB0aHJvdWdoIHRoZSBTdWJzY3JpYmVyIG9iamVjdC4KICAqIEBtZXRob2QgI3N1YnNjcmliZQogICogQG1lbWJlck9mIFNlc3Npb24KICAqLwogIHRoaXMuc3Vic2NyaWJlID0gZnVuY3Rpb24oc3RyZWFtLCB0YXJnZXRFbGVtZW50LCBwcm9wZXJ0aWVzLCBjb21wbGV0aW9uSGFuZGxlcikgewogICAgdmFyIGVycm9yTXNnOwoKICAgIGlmICghdGhpcy5jb25uZWN0aW9uIHx8ICF0aGlzLmNvbm5lY3Rpb24uY29ubmVjdGlvbklkKSB7CiAgICAgIGVycm9yTXNnID0gIlNlc3Npb24uc3Vic2NyaWJlIDo6IENvbm5lY3Rpb24gcmVxdWlyZWQgdG8gc3Vic2NyaWJlIjsKICAgICAgT1QuZXJyb3IoZXJyb3JNc2cpOwogICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cpOwogICAgfQoKICAgIGlmICghc3RyZWFtKSB7CiAgICAgIGVycm9yTXNnID0gIlNlc3Npb24uc3Vic2NyaWJlIDo6IHN0cmVhbSBjYW5ub3QgYmUgbnVsbCI7CiAgICAgIE9ULmVycm9yKGVycm9yTXNnKTsKICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTXNnKTsKICAgIH0KCiAgICBpZiAoIXN0cmVhbS5oYXNPd25Qcm9wZXJ0eSgic3RyZWFtSWQiKSkgewogICAgICBlcnJvck1zZyA9ICJTZXNzaW9uLnN1YnNjcmliZSA6OiBpbnZhbGlkIHN0cmVhbSBvYmplY3QiOwogICAgICBPVC5lcnJvcihlcnJvck1zZyk7CiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1zZyk7CiAgICB9CgogICAgdmFyIHN1YnNjcmliZXIgPSBuZXcgT1QuU3Vic2NyaWJlcih0YXJnZXRFbGVtZW50LCBPVC4kLmV4dGVuZChwcm9wZXJ0aWVzIHx8IHt9LCB7CiAgICAgICAgc2Vzc2lvbjogdGhpcwogICAgfSkpOwoKICAgIGlmIChjb21wbGV0aW9uSGFuZGxlciAmJiBPVC4kLmlzRnVuY3Rpb24oY29tcGxldGlvbkhhbmRsZXIpKSBzdWJzY3JpYmVyLm9uY2UoJ3N1YnNjcmliZUNvbXBsZXRlJywgY29tcGxldGlvbkhhbmRsZXIpOwoKICAgIE9ULnN1YnNjcmliZXJzLmFkZChzdWJzY3JpYmVyKTsKICAgIHN1YnNjcmliZXIuc3Vic2NyaWJlKHN0cmVhbSk7CgogICAgcmV0dXJuIHN1YnNjcmliZXI7CiAgfTsKCiAvKioKICAqIFN0b3BzIHN1YnNjcmliaW5nIHRvIGEgc3RyZWFtIGluIHRoZSBzZXNzaW9uLiB0aGUgZGlzcGxheSBvZiB0aGUgYXVkaW8tdmlkZW8gc3RyZWFtIGlzIHJlbW92ZWQgZnJvbSB0aGUgbG9jYWwgd2ViIHBhZ2UuCiAgKgogICogPGg1PkV4YW1wbGU8L2g1PgogICogPHA+CiAgKiBUaGUgZm9sbG93aW5nIGNvZGUgc3Vic2NyaWJlcyB0byBhdmFpbGFibGUgc3RyZWFtcyBhdCB0aGUgdGltZSB0aGF0IGEgc2Vzc2lvbiBpcyBjb25uZWN0ZWQuIEZvciBlYWNoIHN0cmVhbSwgdGhlIGNvZGUgYWxzbwogICogYWRkcyBhbiBVbnN1YnNjcmliZSBsaW5rLgogICogPC9wPgogICogPHByZT4KICAqIHZhciBhcGlLZXkgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgQVBJIGtleS4gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAgKiAgICAgICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAgKiB2YXIgc3RyZWFtcyA9IFtdOwogICoKICAqIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigic2Vzc2lvbkNvbm5lY3RlZCIsIHNlc3Npb25Db25uZWN0SGFuZGxlcik7CiAgKiBzZXNzaW9uLmNvbm5lY3QoYXBpS2V5LCB0b2tlbik7CiAgKgogICogZnVuY3Rpb24gc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKGV2ZW50KSB7CiAgKiAgICAgZm9yICh2YXIgaSA9IDA7IGkgJmx0OyBldmVudC5zdHJlYW1zLmxlbmd0aDsgaSsrKSB7CiAgKiAgICAgICAgIHZhciBzdHJlYW0gPSBldmVudC5zdHJlYW1zW2ldOwogICogICAgICAgICBkaXNwbGF5U3RyZWFtKHN0cmVhbSk7CiAgKiAgICAgfQogICogfQogICoKICAqIGZ1bmN0aW9uIGRpc3BsYXlTdHJlYW0oc3RyZWFtKSB7CiAgKiAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICogICAgIGRpdi5zZXRBdHRyaWJ1dGUoJ2lkJywgJ3N0cmVhbScgKyBzdHJlYW0uc3RyZWFtSWQpOwogICoKICAqCiAgKgogICogICAgIHZhciBzdWJzY3JpYmVyID0gc2Vzc2lvbi5zdWJzY3JpYmUoc3RyZWFtLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAgKiAgICAgc3Vic2NyaWJlcnMucHVzaChzdWJzY3JpYmVyKTsKICAqCiAgKgogICogICAgIHZhciBhTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAqICAgICBhTGluay5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnamF2YXNjcmlwdDogdW5zdWJzY3JpYmUoIicgKyBzdWJzY3JpYmVyLmlkICsgJyIpJyk7CiAgKiAgICAgYUxpbmsuaW5uZXJIVE1MID0gIlVuc3Vic2NyaWJlIjsKICAqCiAgKiAgICAgdmFyIHN0cmVhbXNDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RyZWFtc0NvbnRhaW5lcicpOwogICogICAgIHN0cmVhbXNDb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAqICAgICBzdHJlYW1zQ29udGFpbmVyLmFwcGVuZENoaWxkKGFMaW5rKTsKICAqCiAgKiAgICAgc3RyZWFtcyA9IGV2ZW50LnN0cmVhbXM7CiAgKiB9CiAgKgogICogZnVuY3Rpb24gdW5zdWJzY3JpYmUoc3Vic2NyaWJlcklkKSB7CiAgKiAgICAgY29uc29sZS5sb2coInVuc3Vic2NyaWJlIGNhbGxlZCIpOwogICogICAgIGZvciAodmFyIGkgPSAwOyBpICZsdDsgc3Vic2NyaWJlcnMubGVuZ3RoOyBpKyspIHsKICAqICAgICAgICAgdmFyIHN1YnNjcmliZXIgPSBzdWJzY3JpYmVyc1tpXTsKICAqICAgICAgICAgaWYgKHN1YnNjcmliZXIuaWQgPT0gc3Vic2NyaWJlcklkKSB7CiAgKiAgICAgICAgICAgICBzZXNzaW9uLnVuc3Vic2NyaWJlKHN1YnNjcmliZXIpOwogICogICAgICAgICB9CiAgKiAgICAgfQogICogfQogICogPC9wcmU+CiAgKgogICogQHBhcmFtIHtTdWJzY3JpYmVyfSBzdWJzY3JpYmVyIFRoZSBTdWJzY3JpYmVyIG9iamVjdCB0byB1bnN1YmNyaWJlLgogICoKICAqIEBzZWUgPGEgaHJlZj0iI3N1YnNjcmliZSI+c3Vic2NyaWJlKCk8L2E+CiAgKgogICogQG1ldGhvZCAjdW5zdWJzY3JpYmUKICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24oc3Vic2NyaWJlcikgewogICAgaWYgKCFzdWJzY3JpYmVyKSB7CiAgICAgIHZhciBlcnJvck1zZyA9ICJPVC5TZXNzaW9uLnVuc3Vic2NyaWJlOiBzdWJzY3JpYmVyIGNhbm5vdCBiZSBudWxsIjsKICAgICAgT1QuZXJyb3IoZXJyb3JNc2cpOwogICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cpOwogICAgfQoKICAgIGlmICghc3Vic2NyaWJlci5zdHJlYW0pIHsKICAgICAgICBPVC53YXJuKCJPVC5TZXNzaW9uLnVuc3Vic2NyaWJlOjogdHJpZWQgdG8gdW5zdWJzY3JpYmUgYSBzdWJzY3JpYmVyIHRoYXQgaGFkIG5vIHN0cmVhbSIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBPVC5kZWJ1ZygiT1QuU2Vzc2lvbi51bnN1YnNjcmliZTogc3Vic2NyaWJlciAiICsgc3Vic2NyaWJlci5pZCk7CgogICAgc3Vic2NyaWJlci5kZXN0cm95KCk7CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAvKioKICAqIFJldHVybnMgYW4gYXJyYXkgb2YgbG9jYWwgU3Vic2NyaWJlciBvYmplY3RzIGZvciBhIGdpdmVuIHN0cmVhbS4KICAqCiAgKiBAcGFyYW0ge1N0cmVhbX0gc3RyZWFtIFRoZSBzdHJlYW0gZm9yIHdoaWNoIHlvdSB3YW50IHRvIGZpbmQgc3Vic2NyaWJlcnMuCiAgKgogICogQHJldHVybnMge0FycmF5fSBBbiBhcnJheSBvZiB7QGxpbmsgU3Vic2NyaWJlcn0gb2JqZWN0cyBmb3IgdGhlIHNwZWNpZmllZCBzdHJlYW0uCiAgKgogICogQHNlZSA8YSBocmVmPSIjdW5zdWJzY3JpYmUiPnVuc3Vic2NyaWJlKCk8L2E+CiAgKiBAc2VlIDxhIGhyZWY9IlN1YnNjcmliZXIuaHRtbCI+U3Vic2NyaWJlcjwvYT4KICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtRXZlbnQuaHRtbCI+U3RyZWFtRXZlbnQ8L2E+CiAgKiBAbWV0aG9kICNnZXRTdWJzY3JpYmVyc0ZvclN0cmVhbQogICogQG1lbWJlck9mIFNlc3Npb24KICAqLwogIHRoaXMuZ2V0U3Vic2NyaWJlcnNGb3JTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgIHJldHVybiBPVC5zdWJzY3JpYmVycy53aGVyZSh7c3RyZWFtSWQ6IHN0cmVhbS5pZH0pOwogIH07CgogLyoqCiAgKiBSZXR1cm5zIHRoZSBsb2NhbCBQdWJsaXNoZXIgb2JqZWN0IGZvciBhIGdpdmVuIHN0cmVhbS4KICAqCiAgKiBAcGFyYW0ge1N0cmVhbX0gc3RyZWFtIFRoZSBzdHJlYW0gZm9yIHdoaWNoIHlvdSB3YW50IHRvIGZpbmQgdGhlIFB1Ymxpc2hlci4KICAqCiAgKiBAcmV0dXJucyB7UHVibGlzaGVyfSBBIFB1Ymxpc2hlciBvYmplY3QgZm9yIHRoZSBzcGVjaWZpZWQgc3RyZWFtLiBSZXR1cm5zIDxjb2RlPm51bGw8L2NvZGU+IGlmIHRoZXJlIGlzIG5vIGxvY2FsIFB1Ymxpc2hlciBvYmplY3QKICAqIGZvciB0aGUgc3BlY2lmaWVkIHN0cmVhbS4KICAqCiAgKiBAc2VlIDxhIGhyZWY9IiNmb3JjZVVucHVibGlzaCI+Zm9yY2VVbnB1Ymxpc2goKTwvYT4KICAqIEBzZWUgPGEgaHJlZj0iU3Vic2NyaWJlci5odG1sIj5TdWJzY3JpYmVyPC9hPgogICogQHNlZSA8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sIj5TdHJlYW1FdmVudDwvYT4KICAqCiAgKiBAbWV0aG9kICNnZXRQdWJsaXNoZXJGb3JTdHJlYW0KICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLmdldFB1Ymxpc2hlckZvclN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgdmFyIHN0cmVhbUlkOwoKICAgIGlmICh0eXBlb2Yoc3RyZWFtKSA9PSAic3RyaW5nIikgewogICAgICBzdHJlYW1JZCA9IHN0cmVhbTsKICAgIH0gZWxzZSBpZiAodHlwZW9mKHN0cmVhbSkgPT0gIm9iamVjdCIgJiYgc3RyZWFtICYmIHN0cmVhbS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICBzdHJlYW1JZCA9IHN0cmVhbS5pZDsKICAgIH0gZWxzZSB7CiAgICAgIGVycm9yTXNnID0gIlNlc3Npb24uZ2V0UHVibGlzaGVyRm9yU3RyZWFtIDo6IEludmFsaWQgc3RyZWFtIHR5cGUiOwogICAgICBPVC5lcnJvcihlcnJvck1zZyk7CiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1zZyk7CiAgICB9CgogICAgcmV0dXJuIE9ULnB1Ymxpc2hlcnMud2hlcmUoe3N0cmVhbUlkOiBzdHJlYW1JZH0pWzBdOwogIH07CgoKICAvLyBQcml2YXRlIFNlc3Npb24gQVBJOiBmb3IgaW50ZXJuYWwgT1QgdXNlIG9ubHkKICB0aGlzLl8gPSB7CiAgICBqc2VwU3Vic2NyaWJlOiBmdW5jdGlvbihzdHJlYW0sIHN1YnNjcmliZVRvVmlkZW8sIHN1YnNjcmliZVRvQXVkaW8pIHsKICAgICAgcmV0dXJuIF9zb2NrZXQuanNlcFN1YnNjcmliZShzdHJlYW0uY29ubmVjdGlvbi5pZCwgc3RyZWFtLmlkLCBzdWJzY3JpYmVUb1ZpZGVvLCBzdWJzY3JpYmVUb0F1ZGlvKTsKICAgIH0uYmluZCh0aGlzKSwKCiAgICBqc2VwVW5zdWJzY3JpYmU6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICByZXR1cm4gX3NvY2tldC5qc2VwVW5zdWJzY3JpYmUoc3RyZWFtLmNvbm5lY3Rpb24uaWQsIHN0cmVhbS5pZCk7CiAgICB9LmJpbmQodGhpcyksCgogICAganNlcENhbmRpZGF0ZTogZnVuY3Rpb24odG9Db25uZWN0aW9uSWQsIHN0cmVhbSwgY2FuZGlkYXRlKSB7CiAgICAgIHJldHVybiBfc29ja2V0LmpzZXBDYW5kaWRhdGUodG9Db25uZWN0aW9uSWQsIHN0cmVhbS5pZCwgY2FuZGlkYXRlKTsKICAgIH0uYmluZCh0aGlzKSwKCiAgICBqc2VwT2ZmZXI6IGZ1bmN0aW9uKHRvQ29ubmVjdGlvbklkLCBzdHJlYW0sIG9mZmVyU0RQKSB7CiAgICAgIHJldHVybiBfc29ja2V0LmpzZXBPZmZlcih0b0Nvbm5lY3Rpb25JZCwgc3RyZWFtLmlkLCBvZmZlclNEUCk7CiAgICB9LmJpbmQodGhpcyksCgogICAganNlcEFuc3dlcjogZnVuY3Rpb24odG9Db25uZWN0aW9uSWQsIHN0cmVhbSwgYW5zd2VyU0RQKSB7CiAgICAgIHJldHVybiBfc29ja2V0LmpzZXBBbnN3ZXIodG9Db25uZWN0aW9uSWQsIHN0cmVhbS5pZCwgYW5zd2VyU0RQKTsKICAgIH0uYmluZCh0aGlzKSwKCiAgICAvLyBzZXNzaW9uLm9uKCJzaWduYWwiLCBmdW5jdGlvbihTaWduYWxFdmVudCkpCiAgICAvLyBzZXNzaW9uLm9uKCJzaWduYWw6e3R5cGV9IiwgZnVuY3Rpb24oU2lnbmFsRXZlbnQpKQogICAgZGlzcGF0Y2hTaWduYWw6IGZ1bmN0aW9uKGZyb21Db25uZWN0aW9uLCB0eXBlLCBkYXRhKSB7CiAgICAgIHZhciBldmVudCA9IG5ldyBPVC5TaWduYWxFdmVudCh0eXBlLCBkYXRhLCBmcm9tQ29ubmVjdGlvbik7CiAgICAgIGV2ZW50LnRhcmdldCA9IHRoaXM7CgogICAgICAvLyBzaWduYWwgYSAic2lnbmFsIiBldmVudAogICAgICAvLyBOT1RFOiB0cmlnZ2VyIGRvZXNuJ3Qgc3VwcG9ydCBkZWZhdWx0QWN0aW9uLCBhbmQgdGhlcmVmb3JlIHByZXZlbnREZWZhdWx0LgogICAgICB0aGlzLnRyaWdnZXIoT1QuRXZlbnQubmFtZXMuU0lHTkFMLCBldmVudCk7CgogICAgICAvLyBzaWduYWwgYW4gInNpZ25hbDp7dHlwZX0iIGV2ZW50IiBpZiB0aGVyZSB3YXMgYSBjdXN0b20gdHlwZQogICAgICBpZiAodHlwZSkgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgIH0uYmluZCh0aGlzKSwKCiAgICBtb2RpZnlTdWJzY3JpYmVyOiBmdW5jdGlvbihzdWJzY3JpYmVyLCBrZXksIHZhbHVlKSB7CiAgICAgIHJldHVybiBfc29ja2V0Lm1vZGlmeVN1YnNjcmliZXIoc3Vic2NyaWJlciwga2V5LCB2YWx1ZSk7CiAgICB9LmJpbmQodGhpcyksCgogICAgY3JlYXRlU3RyZWFtOiBmdW5jdGlvbihwdWJsaXNoZXJJZCwgbmFtZSwgb3JpZW50YXRpb24sIGVuY29kZWRXaWR0aCwgZW5jb2RlZEhlaWdodCwgaGFzQXVkaW8sIGhhc1ZpZGVvKSB7CiAgICAgIF9zb2NrZXQuY3JlYXRlU3RyZWFtKHB1Ymxpc2hlcklkLCBuYW1lLCBvcmllbnRhdGlvbiwgZW5jb2RlZFdpZHRoLCBlbmNvZGVkSGVpZ2h0LCBoYXNBdWRpbywgaGFzVmlkZW8pOwogICAgfS5iaW5kKHRoaXMpLAoKICAgIG1vZGlmeVN0cmVhbTogZnVuY3Rpb24oc3RyZWFtSWQsIGtleSwgdmFsdWUpIHsKICAgICAgaWYgKCFzdHJlYW1JZCB8fCAha2V5IHx8IHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICBPVC5lcnJvcignT1QuU2Vzc2lvbi5tb2RpZnlTdHJlYW06IG11c3QgcHJvdmlkZSBzdHJlYW1JZCwga2V5IGFuZCB2YWx1ZSB0byBtb2RpZnkgYSBzdHJlYW0gcHJvcGVydHkuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBfc29ja2V0LnVwZGF0ZVN0cmVhbShzdHJlYW1JZCwga2V5LCB2YWx1ZSk7CiAgICB9LmJpbmQodGhpcyksCgogICAgZGVzdHJveVN0cmVhbTogZnVuY3Rpb24oc3RyZWFtSWQpIHsKICAgICAgX3NvY2tldC5kZXN0cm95U3RyZWFtKHN0cmVhbUlkKTsKICAgIH0uYmluZCh0aGlzKQogIH07CgoKIC8qKgogICogU2VuZHMgYSBzaWduYWwgdG8gZWFjaCBjbGllbnQgb3Igc3BlY2lmaWVkIGNsaWVudHMgaW4gdGhlIHNlc3Npb24uIFNwZWNpZnkgYSA8Y29kZT5jb25uZWN0aW9uczwvY29kZT4gcHJvcGVydHkKICAqIG9mIHRoZSA8Y29kZT5zaWduYWw8L2NvZGU+IHBhcmFtZXRlciB0byBsaW1pdCB0aGUgcmVjaXBpZW50cyBvZiB0aGUgc2lnbmFsOyBvdGhlcndpc2UgdGhlIHNpZ25hbCBpcyBzZW50IHRvCiAgKiBlYWNoIGNsaWVudCBjb25uZWN0ZWQgdG8gdGhlIHNlc3Npb24uCiAgKiA8cD4KICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzZW5kcyBhIHNpZ25hbCBvZiB0eXBlICJmb28iIHdpdGggYSBzcGVjaWZpZWQgZGF0YSBwYXlsb2FkIHRvIGFsbCBjbGllbnRzIGNvbm5lY3RlZCB0bwogICogdGhlIHNlc3Npb246CiAgKiA8cHJlPgogICogc2Vzc2lvbi5zaWduYWwoewogICogICAgIHR5cGU6ICJmb28iLAogICogICAgIGRhdGE6IHttZXNzYWdlU3RyaW5nOiJoZWxsbyIsIHNjb3JlczpbNywgMTQsIDIzXX0sCiAgKiAgIH0sCiAgKiAgIGZ1bmN0aW9uKGVycm9yKSB7CiAgKiAgICAgaWYgKGVycm9yKSB7CiAgKiAgICAgICBjb25zb2xlLmxvZygic2lnbmFsIGVycm9yOiAiICsgZXJyb3IucmVhc29uKTsKICAqICAgICB9IGVsc2UgewogICogICAgICAgY29uc29sZS5sb2coInNpZ25hbCBzZW50Iik7CiAgKiAgICAgfQogICogICB9CiAgKiApOwogICogPC9wcmU+CiAgKiA8cD4KICAqIENhbGxpbmcgdGhpcyBtZXRob2Qgd2l0aG91dCBsaW1pdGluZyB0aGUgc2V0IG9mIHJlY2lwaWVudCBjbGllbnRzIHdpbGwgcmVzdWx0IGluIG11bHRpcGxlIHNpZ25hbHMgc2VudCAob25lIHRvCiAgKiBlYWNoIGNsaWVudCBpbiB0aGUgc2Vzc2lvbikuIEZvciBpbmZvcm1hdGlvbiBvbiBjaGFyZ2VzIGZvciBzaWduYWxpbmcsIHNlZSB0aGUgPGEgaHJlZj0iaHR0cDovL3Rva2JveC5jb20vcHJpY2luZyI+T3BlblRvawogICogcHJpY2luZzwvYT4gcGFnZS4KICAqIDxwPgogICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNlbmRzIGEgc2lnbmFsIG9mIHR5cGUgImZvbyIgd2l0aCBhIHNwZWNpZmllZCBkYXRhIHBheWxvYWQgdG8gdHdvIHNwZWNpZmljIGNsaWVudHMKICAqIGNvbm5lY3RlZCB0byB0aGUgc2Vzc2lvbjoKICAqIDxwcmU+CiAgKiBzZXNzaW9uLnNpZ25hbCh7CiAgKiAgICAgdHlwZTogImZvbyIsCiAgKiAgICAgdG86IFtjb25uZWN0aW9uMSwgY29ubmVjdGlvbjJdOyAvLyBjb25uZWN0aW9uMSBhbmQgMiBhcmUgQ29ubmVjdGlvbiBvYmplY3RzCiAgKiAgICAgZGF0YToge21lc3NhZ2VTdHJpbmc6ImhlbGxvIn0KICAqICAgfSwKICAqICAgZnVuY3Rpb24oZXJyb3IpIHsKICAqICAgICBpZiAoZXJyb3IpIHsKICAqICAgICAgIGNvbnNvbGUubG9nKCJzaWduYWwgZXJyb3I6ICIgKyBlcnJvci5yZWFzb24pOwogICogICAgIH0gZWxzZSB7CiAgKiAgICAgICBjb25zb2xlLmxvZygic2lnbmFsIHNlbnQiKTsKICAqICAgICB9CiAgKiAgIH0KICAqICk7CiAgKiA8L3ByZT4KICAqIDxwPgogICogRWFjaCBvZiB0aGUgcHJvcGVydGllcyBvZiB0aGUgb2JqZWN0IHlvdSBwYXNzIGludG8gdGhlIDxjb2RlPnNpZ25hbCgpPC9jb2RlPiBtZXRob2QgaXMgb3B0aW9uYWwuCiAgKiA8cD4KICAqIEFkZCBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+c2lnbmFsPC9jb2RlPiBldmVudCB0byBsaXN0ZW4gZm9yIGFsbCBzaWduYWxzIHNlbnQgaW4gdGhlIHNlc3Npb24uCiAgKiBBZGQgYW4gZXZlbnQgaGFuZGxlciBmb3IgdGhlIDxjb2RlPnNpZ25hbDp0eXBlPC9jb2RlPiBldmVudCB0byBsaXN0ZW4gZm9yIHNpZ25hbHMgb2YgYSBzcGVjaWZpZWQgdHlwZQogICogb25seSAocmVwbGFjZSA8Y29kZT50eXBlPC9jb2RlPiwgaW4gPGNvZGU+c2lnbmFsOnR5cGU8L2NvZGU+LCB3aXRoIHRoZSB0eXBlIG9mIHNpZ25hbCB0byBsaXN0ZW4gZm9yKS4gVGhlCiAgKiBTZXNzaW9uIG9iamVjdCBkaXNwYXRjaGVzIHRoZXNlIGV2ZW50cy4gKFNlZSA8YSBocmVmPSIjZXZlbnRzIj5ldmVudHM8L2E+LikKICAqIDxwPgogICogRWFjaCBwcm9wZXJ0eSBpcyBvcHRpb25hbC4gSWYgeW91IHNldCBub25lIG9mIHRoZSBwcm9wZXJ0aWVzLCB5b3Ugd2lsbCBzZW5kIGEgc2lnbmFsIHdpdGggbm8gZGF0YSBvciB0eXBlIHRvCiAgKiBlYWNoIGNsaWVudCBjb25uZWN0ZWQgdG8gdGhlIHNlc3Npb24uPC9wPgogICoKICAqIEBwYXJhbSB7T2JqZWN0fSBzaWduYWwgQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzIGRlZmluaW5nIHRoZSBzaWduYWw6CiAgKiA8dWw+CiAgKiAgIDxsaT48Y29kZT50bzwvY29kZT4gJm1kYXNoOyAoQXJyYXkpIEFuIGFycmF5IG9mIDxhIGhyZWY9IkNvbm5lY3Rpb24uaHRtbCI+Q29ubmVjdGlvbjwvYT4gb2JqZWN0cywgY29ycmVzcG9uZGluZwogICogICAgICB0byBjbGllbnRzIHRoYXQgdGhlIG1lc3NhZ2UgaXMgdG8gYmUgc2VudCB0by4gSWYgeW91IGRvIG5vdCBzcGVjaWZ5IHRoaXMgcHJvcGVydHksIHRoZSBzaWduYWwgaXMgc2VudCB0byBhbGwKICAqICAgICAgY2xpZW50cyBjb25uZWN0ZWQgdG8gdGhlIHNlc3Npb24uPC9saT4KICAqICAgPGxpPjxjb2RlPmRhdGE8L2NvZGU+ICZtZGFzaDsgKE9iamVjdCkgVGhlIGRhdGEgdG8gc2VuZC4gVmFsaWQgdHlwZXMgZm9yIGRhdGEgYXJlIGEgSlNPTi1wYXJzYWJsZSBvYmplY3QsCiAgKiAgICAgYSBKU09OLXBhcnNhYmxlIGFycmF5LCBhIHN0cmluZywgYSBudW1iZXIsIGEgQm9vbGVhbiB2YWx1ZSwgb3IgPGNvZGU+bnVsbDwvY29kZT4uIE51bWJlcnMgY2Fubm90IGJlIE5hTiBvciBJbmZpbml0eS4KICAqICAgICBUaGUgbGltaXQgdG8gdGhlIHNpemUgb2YgZGF0YSBpcyA4a0IuPC9saT4KICAqICAgPGxpPjxjb2RlPnR5cGU8L2NvZGU+ICZtZGFzaDsgKFN0cmluZykgVGhlIHR5cGUgb2YgdGhlIHNpZ25hbC4gWW91IGNhbiB1c2UgdGhlIHR5cGUgdG8gZmlsdGVyIHNpZ25hbHMgd2hlbiBzZXR0aW5nIGFuCiAgKiAgICAgZXZlbnQgaGFuZGxlciBmb3IgdGhlIDxjb2RlPnNpZ25hbDp0eXBlPC9jb2RlPiBldmVudCAod2hlcmUgeW91IHJlcGxhY2UgPGNvZGU+dHlwZTwvY29kZT4gd2l0aCB0aGUgdHlwZSBzdHJpbmcpLgogICogICAgIFRoZSBtYXhpbXVtIGxlbmd0aCBvZiB0aGUgPGNvZGU+dHlwZTwvY29kZT4gc3RyaW5nIGlzIDEyOCBjaGFyYWN0ZXJzLCBhbmQgaXQgbXVzdCBjb250YWluIG9ubHkgbGV0dGVycyAoQS1aIGFuZCBhLXopLAogICogICAgIG51bWJlcnMgKDAtOSksICctJywgJ18nLCBhbmQgJ34nLjwvbGk+CiAgKiAgIDwvbGk+CiAgKiA8L3VsPgogICoKICAqIDxwPkVhY2ggcHJvcGVydHkgaXMgb3B0aW9uYWwuIElmIHlvdSBzZXQgbm9uZSBvZiB0aGUgcHJvcGVydGllcywgeW91IHdpbGwgc2VuZCBhIHNpZ25hbCB3aXRoIG5vIGRhdGEgb3IgdHlwZSB0bwogICogZWFjaCBjbGllbnQgY29ubmVjdGVkIHRvIHRoZSBzZXNzaW9uLjwvcD4KICAqCiAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb21wbGV0aW9uSGFuZGxlciBBIGZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIHdoZW4gc2VuZGluZyB0aGUgc2lnbmFsIHN1Y2NlZWRzIG9yIGZhaWxzLiBUaGlzCiAgKiBmdW5jdGlvbiB0YWtlcyBvbmUgcGFyYW1ldGVyLCA8Y29kZT5lcnJvcjwvY29kZT4sIHdoaWNoIGlzIHNldCB0byA8Y29kZT5udWxsPC9jb2RlPiBpZiBzZW5kaW5nIHRoZSBzaWduYWwgc3VjY2VlZHM7CiAgKiBvdGhlcndpc2UgdGhlIDxjb2RlPmVycm9yPC9jb2RlPiBvYmplY3QgaGFzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAqCiAgKiA8dWw+CiAgKiAgIDxsaT48Y29kZT5jb2RlPC9jb2RlPiAmbWRhc2g7IChOdW1iZXIpIEFuIGVycm9yIGNvZGUsIHdoaWNoIGNhbiBiZSBvbmUgb2YgdGhlIGZvbGxvd2luZzoKICAqICAgICA8dGFibGUgc3R5bGU9IndpZHRoOjEwMCUiPgogICogICAgICAgICA8dHI+CiAgKiAgICAgICAgICAgPHRkPjQwMDwvdGQ+IDx0ZD5PbmUgb2YgdGhlIHNpZ25hbCBwcm9wZXJ0aWVzICZtZGFzaDsgZGF0YSwgdHlwZSwgb3IgdG8gJm1kYXNoOyBpcyBpbnZhbGlkLgogICogICAgICAgICAgICAgICAgICAgICAgICAgT3IgdGhlIGRhdGEgY2Fubm90IGJlIHBhcnNlZCBhcyBKU09OLjwvdGQ+CiAgKiAgICAgICAgIDwvdHI+CiAgKiAgICAgICAgIDx0cj4KICAqICAgICAgICAgICA8dGQ+NDA0PC90ZD4gPHRkPlRoZSB0byBjb25uZWN0aW9uIGRvZXMgbm90IGV4aXN0LjwvdGQ+CiAgKiAgICAgICAgIDwvdHI+CiAgKiAgICAgICAgIDx0cj4KICAqICAgICAgICAgICA8dGQ+NDEzPC90ZD4gPHRkPlRoZSB0eXBlIHN0cmluZyBleGNlZWRzIHRoZSBtYXhpbXVtIGxlbmd0aCAoMTI4IGNoYXJhY3RlcnMpLAogICogICAgICAgICAgICAgICAgICAgICAgICBvciB0aGUgZGF0YSBwcm9wZXJ0eSBleGNlZWRzIHRoZSBtYXhpbXVtIHNpemUgKDhrQikuPC90ZD4KICAqICAgICAgICAgPC90cj4KICAqICAgICAgICAgPHRyPgogICogICAgICAgICAgIDx0ZD41MDA8L3RkPiA8dGQ+VGhlIFdlYlNvY2tldCBjb25uZWN0aW9uIGlzIGRvd24uPC90ZD4KICAqICAgICAgICAgPC90cj4KICAqICAgICAgPC90YWJsZT4KICAqICAgPC9saT4KICAqICAgPGxpPjxjb2RlPnJlYXNvbjwvY29kZT4gJm1kYXNoOyAoU3RyaW5nKSBBIGRlc2NyaXB0aW9uIG9mIHRoZSBlcnJvci48L2xpPgogICogICA8bGk+PGNvZGU+c2lnbmFsPC9jb2RlPiAmbWRhc2g7IChPYmplY3QpIEFuIG9iamVjdCB3aXRoIHByb3BlcnRpZXMgY29ycmVzcG9uZGluZyB0byB0aGUgdmFsdWVzIHBhc3NlZAogICogICAgIGludG8gdGhlIDxjb2RlPnNpZ25hbCgpPC9jb2RlPiBtZXRob2QgJm1kYXNoOyA8Y29kZT5kYXRhPC9jb2RlPiwgPGNvZGU+dG88L2NvZGU+LCBhbmQgPGNvZGU+dHlwZTwvY29kZT4uCiAgKiAgIDwvbGk+CiAgKiA8L3VsPgogICoKICAqIDxwPk5vdGUgdGhhdCB0aGUgPGNvZGU+Y29tcGxldGlvbkhhbmRsZXI8L2NvZGU+IHN1Y2Nlc3MgcmVzdWx0ICg8Y29kZT5lcnJvciA9PSBudWxsPC9jb2RlPikgaW5kaWNhdGVzIHRoYXQgdGhlCiAgKiBvcHRpb25zIHBhc3NlZCBpbnRvIHRoZSA8Y29kZT5TZXNzaW9uLnNpZ25hbCgpPC9jb2RlPiBtZXRob2QgYXJlIHZhbGlkIGFuZCB0aGUgc2lnbmFsIHdhcyBzZW50LiBJdCBkb2VzCiAgKiA8aT5ub3Q8L2k+IGluZGljYXRlIHRoYXQgdGhlIHNpZ25hbCB3YXMgc3VjZXNzZnVsbHkgcmVjZWl2ZWQgYnkgYW55IG9mIHRoZSBpbnRlbmRlZCByZWNpcGllbnRzLgogICoKICAqIEBtZXRob2QgI3NpZ25hbAogICogQG1lbWJlck9mIFNlc3Npb24KICAqIEBzZWUgPGEgaHJlZj0iI2V2ZW50OnNpZ25hbCI+c2lnbmFsPC9hPiBhbmQgPGEgaHJlZj0iI2V2ZW50OnNpZ25hbDp0eXBlIj5zaWduYWw6dHlwZTwvYT4gZXZlbnRzCiAgKi8KICB0aGlzLnNpZ25hbCA9IGZ1bmN0aW9uKG9wdGlvbnMsIGNvbXBsZXRpb24pIHsKICAgIF9zb2NrZXQuc2lnbmFsKG9wdGlvbnMsIGNvbXBsZXRpb24pOwogIH07CgogLyoqCiAgKiAgIEZvcmNlcyBhIHJlbW90ZSBjb25uZWN0aW9uIHRvIGxlYXZlIHRoZSBzZXNzaW9uLgogICoKICAqIDxwPgogICogICBUaGUgPGNvZGU+Zm9yY2VEaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBpcyBub3JtYWxseSB1c2VkIGFzIGEgbW9kZXJhdGlvbiB0b29sCiAgKiAgICAgICAgdG8gcmVtb3ZlIHVzZXJzIGZyb20gYW4gb25nb2luZyBzZXNzaW9uLgogICogPC9wPgogICogPHA+CiAgKiAgIFdoZW4gYSBjb25uZWN0aW9uIGlzIHRlcm1pbmF0ZWQgdXNpbmcgdGhlIDxjb2RlPmZvcmNlRGlzY29ubmVjdCgpPC9jb2RlPiwKICAqICAgICAgICA8Y29kZT5zZXNzaW9uRGlzY29ubmVjdGVkPC9jb2RlPiwgPGNvZGU+Y29ubmVjdGlvbkRlc3Ryb3llZDwvY29kZT4gYW5kCiAgKiAgICAgICAgPGNvZGU+c3RyZWFtRGVzdHJveWVkPC9jb2RlPiBldmVudHMgYXJlIGRpc3BhdGNoZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHRoZXkKICAqICAgICAgICB3b3VsZCBiZSBpZiB0aGUgY29ubmVjdGlvbiBoYWQgdGVybWluYXRlZCBpdHNlbGYgdXNpbmcgdGhlIDxjb2RlPmRpc2Nvbm5lY3QoKTwvY29kZT4gbWV0aG9kLiBIb3dldmVyLAogICogICAgICAgIHRoZSA8Y29kZT5yZWFzb248L2NvZGU+IHByb3BlcnR5IG9mIGEge0BsaW5rIENvbm5lY3Rpb25FdmVudH0gb3Ige0BsaW5rIFN0cmVhbUV2ZW50fSBvYmplY3Qgc3BlY2lmaWVzCiAgKiAgICAgICAgPGNvZGU+ImZvcmNlRGlzY29ubmVjdGVkIjwvY29kZT4gYXMgdGhlIHJlYXNvbiBmb3IgdGhlIGRlc3RydWN0aW9uIG9mIHRoZSBjb25uZWN0aW9uIGFuZCBzdHJlYW0ocykuCiAgKiA8L3A+CiAgKiA8cD4KICAqICAgV2hpbGUgeW91IGNhbiB1c2UgdGhlIDxjb2RlPmZvcmNlRGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2QgdG8gdGVybWluYXRlIHlvdXIgb3duIGNvbm5lY3Rpb24sCiAgKiAgICAgICAgY2FsbGluZyB0aGUgPGNvZGU+ZGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2QgaXMgc2ltcGxlci4KICAqIDwvcD4KICAqIDxwPgogICogICBUaGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgYW4gPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudCBpZiB0aGUgdXNlcidzIHJvbGUKICAqICAgZG9lcyBub3QgaW5jbHVkZSBwZXJtaXNzaW9ucyByZXF1aXJlZCB0byBmb3JjZSBvdGhlciB1c2VycyB0byBkaXNjb25uZWN0LgogICogICAgICAgIFlvdSBkZWZpbmUgYSB1c2VyJ3Mgcm9sZSB3aGVuIHlvdSBjcmVhdGUgdGhlIHVzZXIgdG9rZW4gdXNpbmcgdGhlIDxjb2RlPmdlbmVyYXRlX3Rva2VuKCk8L2NvZGU+CiAgKiAgICAgICAgbWV0aG9kIHVzaW5nIG91ciA8YSBocmVmPSIvb3BlbnRvay9saWJyYXJpZXMvc2VydmVyLyI+c2VydmVyLXNpZGUgbGlicmFyaWVzPC9hPiBvciB0aGUgPGEgaHJlZj0iaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cyI+RGFzaGJvYXJkPC9hPiBwYWdlLgogICogICBTZWUgPGEgaHJlZj0iRXhjZXB0aW9uRXZlbnQuaHRtbCI+RXhjZXB0aW9uRXZlbnQ8L2E+IGFuZCA8YSBocmVmPSJUQi5odG1sI2FkZEV2ZW50TGlzdGVuZXIiPlRCLmFkZEV2ZW50TGlzdGVuZXIoKTwvYT4uCiAgKiA8L3A+CiAgKiA8cD4KICAqICAgVGhlIGFwcGxpY2F0aW9uIHRocm93cyBhbiBlcnJvciBpZiB0aGUgc2Vzc2lvbiBpcyBub3QgY29ubmVjdGVkLgogICogPC9wPgogICoKICAqIDxoNT5FdmVudHMgZGlzcGF0Y2hlZDo8L2g1PgogICoKICAqIDxwPgogICogICA8Y29kZT5jb25uZWN0aW9uRGVzdHJveWVkPC9jb2RlPiAoPGEgaHJlZj0iQ29ubmVjdGlvbkV2ZW50Lmh0bWwiPkNvbm5lY3Rpb25FdmVudDwvYT4pICYjMTUxOwogICogICAgIE9uIGNsaWVudHMgb3RoZXIgdGhhbiB3aGljaCBoYWQgdGhlIGNvbm5lY3Rpb24gdGVybWluYXRlZC4KICAqIDwvcD4KICAqIDxwPgogICogICA8Y29kZT5leGNlcHRpb248L2NvZGU+ICg8YSBocmVmPSJFeGNlcHRpb25FdmVudC5odG1sIj5FeGNlcHRpb25FdmVudDwvYT4pICYjMTUxOwogICogICAgIFRoZSB1c2VyJ3Mgcm9sZSBkb2VzIG5vdCBhbGxvdyBmb3JjaW5nIG90aGVyIHVzZXIncyB0byBkaXNjb25uZWN0ICg8Y29kZT5ldmVudC5jb2RlID0gMTUzMDwvY29kZT4pLAogICogICBvciB0aGUgc3BlY2lmaWVkIHN0cmVhbSBpcyBub3QgcHVibGlzaGluZyB0byB0aGUgc2Vzc2lvbiAoPGNvZGU+ZXZlbnQuY29kZSA9IDE1MzU8L2NvZGU+KS4KICAqIDwvcD4KICAqIDxwPgogICogICA8Y29kZT5zZXNzaW9uRGlzY29ubmVjdGVkPC9jb2RlPiAoPGEgaHJlZj0iU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudC5odG1sIj5TZXNzaW9uRGlzY29ubmVjdEV2ZW50PC9hPikgJiMxNTE7CiAgKiAgICAgT24gdGhlIGNsaWVudCB3aGljaCBoYXMgdGhlIGNvbm5lY3Rpb24gdGVybWluYXRlZC4KICAqIDwvcD4KICAqIDxwPgogICogICA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+ICg8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sIj5TdHJlYW1FdmVudDwvYT4pICYjMTUxOwogICogICAgIElmIHN0cmVhbXMgYXJlIHN0b3BwZWQgYXMgYSByZXN1bHQgb2YgdGhlIGNvbm5lY3Rpb24gZW5kaW5nLgogICogPC9wPgogICoKICAqIEBwYXJhbSB7Q29ubmVjdGlvbn0gY29ubmVjdGlvbiBUaGUgY29ubmVjdGlvbiB0byBiZSBkaXNjb25uZWN0ZWQgZnJvbSB0aGUgc2Vzc2lvbi4KICAqIFRoaXMgdmFsdWUgY2FuIGVpdGhlciBiZSBhIDxhIGhyZWY9IkNvbm5lY3Rpb24uaHRtbCI+Q29ubmVjdGlvbjwvYT4gb2JqZWN0IG9yIGEgY29ubmVjdGlvbiBJRCAod2hpY2ggY2FuIGJlCiAgKiBvYnRhaW5lZCBmcm9tIHRoZSA8Y29kZT5jb25uZWN0aW9uSWQ8L2NvZGU+IHByb3BlcnR5IG9mIHRoZSBDb25uZWN0aW9uIG9iamVjdCkuCiAgKgogICogQG1ldGhvZCAjZm9yY2VEaXNjb25uZWN0CiAgKiBAbWVtYmVyT2YgU2Vzc2lvbgogICovCgogIHRoaXMuZm9yY2VEaXNjb25uZWN0ID0gZnVuY3Rpb24oY29ubmVjdGlvbk9yQ29ubmVjdGlvbklkLCBjb21wbGV0aW9uSGFuZGxlcikgewogICAgdmFyIG5vdFBlcm1pdHRlZEVycm9yTXNnID0gIlRoaXMgdG9rZW4gZG9lcyBub3QgYWxsb3cgZm9yY2VEaXNjb25uZWN0LiBUaGUgcm9sZSBtdXN0IGJlIGF0IGxlYXN0IGBtb2RlcmF0b3JgIHRvIGVuYWJsZSB0aGlzIGZ1bmN0aW9uYWxpdHkiOwoKICAgIGlmIChwZXJtaXR0ZWRUbygiZm9yY2VEaXNjb25uZWN0IikpIHsKICAgICAgdmFyIGNvbm5lY3Rpb25JZCA9IHR5cGVvZihjb25uZWN0aW9uT3JDb25uZWN0aW9uSWQpID09PSAnc3RyaW5nJyA/IGNvbm5lY3Rpb25PckNvbm5lY3Rpb25JZCA6IGNvbm5lY3Rpb25PckNvbm5lY3Rpb25JZC5pZDsKCiAgICAgIGlmIChjb21wbGV0aW9uSGFuZGxlcikgewogICAgICAgIHZhciB3b3JrID0gbmV3IFJlbW90ZVdvcmsodGhpcywgY29tcGxldGlvbkhhbmRsZXIsIHsKICAgICAgICAgIHRpbWVvdXRNZXNzYWdlOiAiVGltZWQgb3V0IHdoaWxlIHdhaXRpbmcgZm9yIGNvbm5lY3Rpb24gIiArIGNvbm5lY3Rpb25JZCArICIgdG8gYmUgZm9yY2UgRGlzY29ubmVjdGVkLiIKICAgICAgICB9KTsKCiAgICAgICAgd29yay5mYWlsc09uRXhjZXB0aW9uQ29kZXMoewogICAgICAgICAgMTUyMDogbm90UGVybWl0dGVkRXJyb3JNc2cKICAgICAgICB9KTsKCiAgICAgICAgX2NhbGxiYWNrcy5mb3JjZURpc2Nvbm5lY3RbY29ubmVjdGlvbklkXSA9IHdvcms7CiAgICAgIH0KCiAgICAgIF9zb2NrZXQuZm9yY2VEaXNjb25uZWN0KGNvbm5lY3Rpb25JZCk7CiAgICB9IGVsc2UgewogICAgICAvLyBpZiB0aGlzIHRocm93cyBhbiBlcnJvciB0aGUgaGFuZGxlSnNFeGNlcHRpb24gd29uJ3Qgb2NjdXIKICAgICAgaWYgKGNvbXBsZXRpb25IYW5kbGVyKSBPVC4kLmNhbGxBc3luYyhjb21wbGV0aW9uSGFuZGxlciwgbmV3IE9ULkVycm9yKG51bGwsIG5vdFBlcm1pdHRlZEVycm9yTXNnKSk7CgogICAgICBUQi5oYW5kbGVKc0V4Y2VwdGlvbihub3RQZXJtaXR0ZWRFcnJvck1zZywgT1QuRXhjZXB0aW9uQ29kZXMuVU5BQkxFX1RPX0ZPUkNFX0RJU0NPTk5FQ1QsIHsKICAgICAgICBzZXNzaW9uOiB0aGlzCiAgICAgIH0pOwogICAgfQogIH07CgogLyoqCiAgKiBGb3JjZXMgdGhlIHB1Ymxpc2hlciBvZiB0aGUgc3BlY2lmaWVkIHN0cmVhbSB0byBzdG9wIHB1Ymxpc2hpbmcgdGhlIHN0cmVhbS4KICAqCiAgKiA8cD4KICAqIENhbGxpbmcgdGhpcyBtZXRob2QgY2F1c2VzIHRoZSBTZXNzaW9uIG9iamVjdCB0byBkaXNwYXRjaCBhIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4KICAqIGV2ZW50IG9uIGFsbCBjbGllbnRzIHRoYXQgYXJlIHN1YnNjcmliZWQgdG8gdGhlIHN0cmVhbSAoaW5jbHVkaW5nIHRoZSBjbGllbnQgdGhhdCBpcwogICogcHVibGlzaGluZyB0aGUgc3RyZWFtKS4gVGhlIDxjb2RlPnJlYXNvbjwvY29kZT4gcHJvcGVydHkgb2YgdGhlIFN0cmVhbUV2ZW50IG9iamVjdCBpcwogICogc2V0IHRvIDxjb2RlPiJmb3JjZVVucHVibGlzaGVkIjwvY29kZT4uCiAgKiA8L3A+CiAgKiA8cD4KICAqIFRoZSBUQiBvYmplY3QgZGlzcGF0Y2hlcyBhbiA8Y29kZT5leGNlcHRpb248L2NvZGU+IGV2ZW50IGlmIHRoZSB1c2VyJ3Mgcm9sZQogICogZG9lcyBub3QgaW5jbHVkZSBwZXJtaXNzaW9ucyByZXF1aXJlZCB0byBmb3JjZSBvdGhlciB1c2VycyB0byB1bnB1Ymxpc2guCiAgKiBZb3UgZGVmaW5lIGEgdXNlcidzIHJvbGUgd2hlbiB5b3UgY3JlYXRlIHRoZSB1c2VyIHRva2VuIHVzaW5nIHRoZSA8Y29kZT5nZW5lcmF0ZV90b2tlbigpPC9jb2RlPgogICogbWV0aG9kIHVzaW5nIG91ciA8YSBocmVmPSIvb3BlbnRvay9saWJyYXJpZXMvc2VydmVyLyI+c2VydmVyLXNpZGUgbGlicmFyaWVzPC9hPiBvciB0aGUgPGEgaHJlZj0iaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cyI+RGFzaGJvYXJkPC9hPiBwYWdlIHBhZ2UuCiAgKiBZb3UgcGFzcyB0aGUgdG9rZW4gc3RyaW5nIGFzIGEgcGFyYW1ldGVyIG9mIHRoZSA8Y29kZT5jb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgU2Vzc2lvbiBvYmplY3QuCiAgKiBTZWUgPGEgaHJlZj0iRXhjZXB0aW9uRXZlbnQuaHRtbCI+RXhjZXB0aW9uRXZlbnQ8L2E+IGFuZCA8YSBocmVmPSJUQi5odG1sI2FkZEV2ZW50TGlzdGVuZXIiPlRCLmFkZEV2ZW50TGlzdGVuZXIoKTwvYT4uCiAgKiA8L3A+CiAgKgogICogPGg1PkV2ZW50cyBkaXNwYXRjaGVkOjwvaDU+CiAgKgogICogPHA+CiAgKiAgIDxjb2RlPmV4Y2VwdGlvbjwvY29kZT4gKDxhIGhyZWY9IkV4Y2VwdGlvbkV2ZW50Lmh0bWwiPkV4Y2VwdGlvbkV2ZW50PC9hPikgJiMxNTE7CiAgKiAgICAgVGhlIHVzZXIncyByb2xlIGRvZXMgbm90IGFsbG93IGZvcmNpbmcgb3RoZXIgdXNlcnMgdG8gdW5wdWJsaXNoLgogICogPC9wPgogICogPHA+CiAgKiAgIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gKDxhIGhyZWY9IlN0cmVhbUV2ZW50Lmh0bWwiPlN0cmVhbUV2ZW50PC9hPikgJiMxNTE7CiAgKiAgICAgVGhlIHN0cmVhbSBoYXMgYmVlbiB1bnB1Ymxpc2hlZC4gVGhlIFNlc3Npb24gb2JqZWN0IGRpc3BhdGNoZXMgdGhpcyBvbiBhbGwgY2xpZW50cwogICogICAgIHN1YnNjcmliZWQgdG8gdGhlIHN0cmVhbSwgYXMgd2VsbCBhcyBvbiB0aGUgcHVibGlzaGVyJ3MgY2xpZW50LgogICogPC9wPgogICoKICAqIEBwYXJhbSB7U3RyZWFtfSBzdHJlYW0gVGhlIHN0cmVhbSB0byBiZSB1bnB1Ymxpc2hlZC4KICAqCiAgKiBAbWV0aG9kICNmb3JjZVVucHVibGlzaAogICogQG1lbWJlck9mIFNlc3Npb24KICAqLwogIHRoaXMuZm9yY2VVbnB1Ymxpc2ggPSBmdW5jdGlvbihzdHJlYW1PclN0cmVhbUlkLCBjb21wbGV0aW9uSGFuZGxlcikgewogICAgdmFyIG5vdFBlcm1pdHRlZEVycm9yTXNnID0gIlRoaXMgdG9rZW4gZG9lcyBub3QgYWxsb3cgZm9yY2VVbnB1Ymxpc2guIFRoZSByb2xlIG11c3QgYmUgYXQgbGVhc3QgYG1vZGVyYXRvcmAgdG8gZW5hYmxlIHRoaXMgZnVuY3Rpb25hbGl0eSI7CgogICAgaWYgKHBlcm1pdHRlZFRvKCJmb3JjZVVucHVibGlzaCIpKSB7CiAgICAgIHZhciBzdHJlYW0gPSB0eXBlb2Yoc3RyZWFtT3JTdHJlYW1JZCkgPT09ICdzdHJpbmcnID8gdGhpcy5zdHJlYW1zLmdldChzdHJlYW1PclN0cmVhbUlkKSA6IHN0cmVhbU9yU3RyZWFtSWQ7CgogICAgICBpZiAoY29tcGxldGlvbkhhbmRsZXIpIHsKICAgICAgICB2YXIgd29yayA9IG5ldyBSZW1vdGVXb3JrKHRoaXMsIGNvbXBsZXRpb25IYW5kbGVyLCB7CiAgICAgICAgICB0aW1lb3V0TWVzc2FnZTogIlRpbWVkIG91dCB3aGlsZSB3YWl0aW5nIGZvciBzdHJlYW0gIiArIHN0cmVhbS5pZCArICIgdG8gYmUgZm9yY2UgdW5wdWJsaXNoZWQuIgogICAgICAgIH0pOwoKICAgICAgICB3b3JrLmZhaWxzT25FeGNlcHRpb25Db2Rlcyh7CiAgICAgICAgICAxNTMwOiBub3RQZXJtaXR0ZWRFcnJvck1zZwogICAgICAgIH0pOwoKICAgICAgICBfY2FsbGJhY2tzLmZvcmNlVW5wdWJsaXNoW3N0cmVhbS5pZF0gPSB3b3JrOwogICAgICB9CgogICAgICBfc29ja2V0LmZvcmNlVW5wdWJsaXNoKHN0cmVhbS5pZCk7CiAgICB9IGVsc2UgewogICAgICAvLyBpZiB0aGlzIHRocm93cyBhbiBlcnJvciB0aGUgaGFuZGxlSnNFeGNlcHRpb24gd29uJ3Qgb2NjdXIKICAgICAgaWYgKGNvbXBsZXRpb25IYW5kbGVyKSBPVC4kLmNhbGxBc3luYyhjb21wbGV0aW9uSGFuZGxlciwgbmV3IE9ULkVycm9yKG51bGwsIG5vdFBlcm1pdHRlZEVycm9yTXNnKSk7CgogICAgICBUQi5oYW5kbGVKc0V4Y2VwdGlvbihub3RQZXJtaXR0ZWRFcnJvck1zZywgT1QuRXhjZXB0aW9uQ29kZXMuVU5BQkxFX1RPX0ZPUkNFX1VOUFVCTElTSCwgewogICAgICAgIHNlc3Npb246IHRoaXMKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgdGhpcy5nZXRTdGF0ZU1hbmFnZXIgPSBmdW5jdGlvbigpIHsKICAgICAgT1Qud2FybigiRml4bWU6IEhhdmUgbm90IGltcGxlbWVudGVkIHNlc3Npb24uZ2V0U3RhdGVNYW5hZ2VyIik7CiAgfTsKCiAgT1QuJC5kZWZpbmVHZXR0ZXJzKHRoaXMsIHsKICAgIGFwaUtleTogZnVuY3Rpb24oKSB7IHJldHVybiBfYXBpS2V5OyB9LAogICAgdG9rZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3Rva2VuOyB9LAogICAgY29ubmVjdGVkOiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuaXMoJ2Nvbm5lY3RlZCcpOyB9LAogICAgY29ubmVjdGlvbjogZnVuY3Rpb24oKSB7IHJldHVybiBfc29ja2V0ICYmIF9zb2NrZXQuaWQgPyB0aGlzLmNvbm5lY3Rpb25zLmdldChfc29ja2V0LmlkKSA6IG51bGw7IH0sCiAgICBjYXBhYmlsaXRpZXM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3NvY2tldCA/IF9zb2NrZXQuY2FwYWJpbGl0aWVzIDogbmV3IE9ULkNhcGFiaWxpdGllcyhbXSk7IH0sCiAgICBzZXNzaW9uSWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3Nlc3Npb25JZDsgfSwKICAgIGlkOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uSWQ7IH0KICB9LCB0cnVlKTsKCgogIC8qKgogICAqIEEgbmV3IGNvbm5lY3Rpb24gdG8gdGhpcyBzZXNzaW9uIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICogQG5hbWUgY29ubmVjdGlvbkNyZWF0ZWQKICAgKiBAZXZlbnQKICAgKiBAbWVtYmVyb2YgU2Vzc2lvbgogICAqIEBzZWUgQ29ubmVjdGlvbkV2ZW50CiAgICogQHNlZSA8YSBocmVmPSJUQi5odG1sI2luaXRTZXNzaW9uIj5UQi5pbml0U2Vzc2lvbigpPC9hPgogICAqLwoKICAvKioKICAgKiBBIGNvbm5lY3Rpb24gdG8gdGhpcyBzZXNzaW9uIGhhcyBlbmRlZC4KICAgKiBAbmFtZSBjb25uZWN0aW9uRGVzdHJveWVkCiAgICogQGV2ZW50CiAgICogQG1lbWJlcm9mIFNlc3Npb24KICAgKiBAc2VlIENvbm5lY3Rpb25FdmVudAogICAqLwoKICAvKioKICAgKiBUaGUgcGFnZSBoYXMgY29ubmVjdGVkIHRvIGFuIE9wZW5Ub2sgc2Vzc2lvbi4gVGhpcyBldmVudCBpcyBkaXNwYXRjaGVkIGFzeW5jaHJvbm91c2x5IGluIHJlc3BvbnNlIHRvCiAgICogYSBzdWNjZXNzZnVsIGNhbGwgdG8gdGhlIDxjb2RlPmNvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIGEgU2Vzc2lvbiBvYmplY3QuIEJlZm9yZSBjYWxsaW5nIHRoZSA8Y29kZT5jb25uZWN0KCk8L2NvZGU+CiAgICogbWV0aG9kLCBpbml0aWFsaXplIHRoZSBzZXNzaW9uIGJ5IGNhbGxpbmcgdGhlIDxjb2RlPlRCLmluaXRTZXNzaW9uKCk8L2NvZGU+IG1ldGhvZC4gRm9yIGEgY29kZSBleGFtcGxlIGFuZCBtb3JlIGRldGFpbHMsCiAgICogc2VlIDxhIGhyZWY9IiNjb25uZWN0Ij5TZXNzaW9uLmNvbm5lY3QoKTwvYT4uCiAgICogQG5hbWUgc2Vzc2lvbkNvbm5lY3RlZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSBTZXNzaW9uQ29ubmVjdEV2ZW50CiAgICogQHNlZSA8YSBocmVmPSIjY29ubmVjdCI+U2Vzc2lvbi5jb25uZWN0KCk8L2E+CiAgICogQHNlZSA8YSBocmVmPSJUQi5odG1sI2luaXRTZXNzaW9uIj5UQi5pbml0U2Vzc2lvbigpPC9hPgogICAqLwoKICAvKioKICAgKiBUaGUgc2Vzc2lvbiBoYXMgZGlzY29ubmVjdGVkLiBUaGlzIGV2ZW50IG1heSBiZSBkaXNwYXRjaGVkIGFzeW5jaHJvbm91c2x5IGluIHJlc3BvbnNlIHRvIGEgc3VjY2Vzc2Z1bCBjYWxsIHRvIHRoZQogICAqIDxjb2RlPmRpc2Nvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4gVGhlIGV2ZW50IG1heSBhbHNvIGJlIGRpc3B0YWNoZWQgaWYgYSBzZXNzaW9uIGNvbm5lY3Rpb24gaXMgbG9zdAogICAqIGluYWR2ZXJ0YW50bHksIGFzIGluIHRoZSBjYXNlIG9mIGEgbG9zdCBuZXR3b3JrIGNvbm5lY3Rpb24uCiAgICogQG5hbWUgc2Vzc2lvbkRpc2Nvbm5lY3RlZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSA8YSBocmVmPSIjZGlzY29ubmVjdCI+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2E+CiAgICogQHNlZSA8YSBocmVmPSIjZGlzY29ubmVjdCI+U2Vzc2lvbi5mb3JjZURpc2Nvbm5lY3QoKTwvYT4KICAgKiBAc2VlIFNlc3Npb25EaXNjb25uZWN0RXZlbnQKICAgKi8KCiAgLyoqCiAgICogQSBuZXcgc3RyZWFtIGhhcyBiZWVuIGNyZWF0ZWQgb24gdGhpcyBzZXNzaW9uLiBGb3IgYSBjb2RlIGV4YW1wbGUgYW5kIG1vcmUgZGV0YWlscywgc2VlIHtAbGluayBTdHJlYW1FdmVudH0uCiAgICogQG5hbWUgc3RyZWFtQ3JlYXRlZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSBTdHJlYW1FdmVudAogICAqIEBzZWUgPGEgaHJlZj0iU2Vzc2lvbi5odG1sI3B1Ymxpc2giPlNlc3Npb24ucHVibGlzaCgpPC9hPgogICAqLwoKICAvKioKICAgKiBBIHN0cmVhbSBoYXMgY2xvc2VkIG9uIHRoaXMgY29ubmVjdGlvbi4gRm9yIGEgY29kZSBleGFtcGxlIGFuZCBtb3JlIGRldGFpbHMsIHNlZSB7QGxpbmsgU3RyZWFtRXZlbnR9LgogICAqIEBuYW1lIHN0cmVhbURlc3Ryb3llZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSBTdHJlYW1FdmVudAogICAqLwoKICAvKioKICAgKiBBIHN0cmVhbSBoYXMgc3RhcnRlZCBvciBzdG9wcGVkIHB1Ymxpc2hpbmcgYXVkaW8gb3IgdmlkZW8gKHNlZSA8YSBocmVmPSJQdWJsaXNoZXIuaHRtbCNwdWJsaXNoQXVkaW8iPlB1Ymxpc2hlci5wdWJsaXNoQXVkaW8oKTwvYT4gYW5kCiAgICogPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaFZpZGVvIj5QdWJsaXNoZXIucHVibGlzaFZpZGVvKCk8L2E+KTsgb3IgdGhlIDxjb2RlPnZpZGVvRGltZW5zaW9uczwvY29kZT4gcHJvcGVydHkgb2YgdGhlIFN0cmVhbQogICAqIG9iamVjdCBoYXMgY2hhbmdlZCAoc2VlIDxhIGhyZWY9IlN0cmVhbS5odG1sIyJ2aWRlb0RpbWVuc2lvbnM+U3RyZWFtLnZpZGVvRGltZW5zaW9uczwvYT4pLgogICAqIEBuYW1lIHN0cmVhbVByb3BlcnR5Q2hhbmdlZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSBTdHJlYW1Qcm9wZXJ0eUNoYW5nZWRFdmVudAogICAqIEBzZWUgPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaEF1ZGlvIj5QdWJsaXNoZXIucHVibGlzaEF1ZGlvKCk8L2E+CiAgICogQHNlZSA8YSBocmVmPSJQdWJsaXNoZXIuaHRtbCNwdWJsaXNoVmlkZW8iPlB1Ymxpc2hlci5wdWJsaXNoVmlkZW8oKTwvYT4KICAgKiBAc2VlIDxhIGhyZWY9IlN0cmVhbS5odG1sIyJoYXNBdWRpbz5TdHJlYW0uaGFzQXVkaW88L2E+CiAgICogQHNlZSA8YSBocmVmPSJTdHJlYW0uaHRtbCMiaGFzVmlkZW8+U3RyZWFtLmhhc1ZpZGVvPC9hPgogICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtLmh0bWwjInZpZGVvRGltZW5zaW9ucz5TdHJlYW0udmlkZW9EaW1lbnNpb25zPC9hPgogICAqLwoKICAvKioKICAgKiBBIHNpZ25hbCB3YXMgcmVjZWl2ZWQgZnJvbSB0aGUgc2Vzc2lvbi4gVGhlIDxhIGhyZWY9IlNpZ25hbEV2ZW50Lmh0bWwiPlNpZ25hbEV2ZW50PC9hPiBjbGFzcyBkZWZpbmVzIHRoaXMgZXZlbnQgb2JqZWN0LgogICAqIEl0IGluY2x1ZGVzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgKiA8dWw+CiAgICogICA8bGk+PGNvZGU+ZGF0YTwvY29kZT4gJm1kYXNoOyAoT2JqZWN0KSBUaGUgZGF0YSBwYXlsb2FkIHNlbnQgd2l0aCB0aGUgc2lnbmFsIChpZiB0aGVyZSBpcyBvbmUpLjwvbGk+CiAgICogICA8bGk+PGNvZGU+ZnJvbTwvY29kZT4gJm1kYXNoOyAoPGEgaHJlZj0iQ29ubmVjdGlvbi5odG1sIj5Db25uZWN0aW9uPC9hPikgVGhlIENvbm5lY3Rpb24gY29ycmVzcG9uZGluZyB0byB0aGUKICAgKiAgIGNsaWVudCB0aGF0IHNlbnQgd2l0aCB0aGUgc2lnbmFsLjwvbGk+CiAgICogICA8bGk+PGNvZGU+dHlwZTwvY29kZT4gJm1kYXNoOyAoU3RyaW5nKSBUaGUgdHlwZSBhc3NpZ25lZCB0byB0aGUgc2lnbmFsIChpZiB0aGVyZSBpcyBvbmUpLjwvbGk+CiAgICogPC91bD4KICAgKiA8cD4KICAgKiBZb3UgY2FuIHJlZ2lzdGVyIHRvIHJlY2VpdmUgYWxsIHNpZ25hbHMgc2VudCBpbiB0aGUgc2Vzc2lvbiwgYnkgYWRkaW5nIGFuIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSA8Y29kZT5zaWduYWw8L2NvZGU+CiAgICogZXZlbnQuIEZvciBleGFtcGxlLCB0aGUgZm9sbG93aW5nIGNvZGUgYWRkcyBhbiBldmVudCBoYW5kbGVyIHRvIHByb2Nlc3MgYWxsIHNpZ25hbHMgc2VudCBpbiB0aGUgc2Vzc2lvbjoKICAgKiA8cHJlPgogICAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigic2lnbmFsIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgKiAgIGNvbnNvbGUubG9nKCJTaWduYWwgc2VudCBmcm9tIGNvbm5lY3Rpb24gIiArIGV2ZW50LmZyb20uaWQpOwogICAqIH0pOwogICAqIDwvcHJlPgogICAqIDxwPllvdSBjYW4gcmVnaXN0ZXIgZm9yIHNpZ25hbHMgb2YgYSBzcGVjZmllZCB0eXBlIGJ5IGFkZGluZyBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+c2lnbmFsOnR5cGU8L2NvZGU+CiAgICogZXZlbnQgKHJlcGxhY2luZyA8Y29kZT50eXBlPC9jb2RlPiB3aXRoIHRoZSBhY3R1YWwgdHlwZSBzdHJpbmcgdG8gZmlsdGVyIG9uKS4KICAgKgogICAqIEBuYW1lIHNpZ25hbAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjc2lnbmFsIj5TZXNzaW9uLnNpZ25hbCgpPC9hPgogICAqIEBzZWUgU2lnbmFsRXZlbnQKICAgKiBAc2VlIDxhIGhyZWY9IiNldmVudDpzaWduYWw6dHlwZSI+c2lnbmFsOnR5cGU8L2E+IGV2ZW50CiAgICovCgogIC8qKgogICAqIEEgc2lnbmFsIG9mIHRoZSBzcGVjaWZpZWQgdHlwZSB3YXMgcmVjZWl2ZWQgZnJvbSB0aGUgc2Vzc2lvbi4gVGhlIDxhIGhyZWY9IlNpZ25hbEV2ZW50Lmh0bWwiPlNpZ25hbEV2ZW50PC9hPiBjbGFzcwogICAqIGRlZmluZXMgdGhpcyBldmVudCBvYmplY3QuCiAgICogSXQgaW5jbHVkZXMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAqIDx1bD4KICAgKiAgIDxsaT48Y29kZT5kYXRhPC9jb2RlPiAmbWRhc2g7IChPYmplY3QpIFRoZSBkYXRhIHBheWxvYWQgc2VudCB3aXRoIHRoZSBzaWduYWwuPC9saT4KICAgKiAgIDxsaT48Y29kZT5mcm9tPC9jb2RlPiAmbWRhc2g7ICg8YSBocmVmPSJDb25uZWN0aW9uLmh0bWwiPkNvbm5lY3Rpb248L2E+KSBUaGUgQ29ubmVjdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZQogICAqICAgY2xpZW50IHRoYXQgc2VudCB3aXRoIHRoZSBzaWduYWwuPC9saT4KICAgKiAgIDxsaT48Y29kZT50eXBlPC9jb2RlPiAmbWRhc2g7IChTdHJpbmcpIFRoZSB0eXBlIGFzc2lnbmVkIHRvIHRoZSBzaWduYWwgKGlmIHRoZXJlIGlzIG9uZSkuPC9saT4KICAgKiA8L3VsPgogICAqIDxwPgogICAqIFlvdSBjYW4gcmVnaXN0ZXIgZm9yIHNpZ25hbHMgb2YgYSBzcGVjZmllZCB0eXBlIGJ5IGFkZGluZyBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+c2lnbmFsOnR5cGU8L2NvZGU+CiAgICogZXZlbnQgKHJlcGxhY2luZyA8Y29kZT50eXBlPC9jb2RlPiB3aXRoIHRoZSBhY3R1YWwgdHlwZSBzdHJpbmcgdG8gZmlsdGVyIG9uKS4gRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgY29kZSBhZGRzCiAgICogYW4gZXZlbnQgaGFuZGxlciBmb3Igc2lnbmFscyBvZiB0eXBlICJmb28iOgogICAqIDxwcmU+CiAgICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzaWduYWw6Zm9vIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgKiAgIGNvbnNvbGUubG9nKCJmb28gc2lnbmFsIHNlbnQgZnJvbSBjb25uZWN0aW9uICIgKyBldmVudC5mcm9tLmlkKTsKICAgKiB9KTsKICAgKiA8L3ByZT4KICAgKiA8cD4KICAgKiBZb3UgY2FuIHJlZ2lzdGVyIHRvIHJlY2VpdmUgPGk+YWxsPC9pPiBzaWduYWxzIHNlbnQgaW4gdGhlIHNlc3Npb24sIGJ5IGFkZGluZyBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUKICAgKiA8Y29kZT5zaWduYWw8L2NvZGU+IGV2ZW50LgogICAqCiAgICogQG5hbWUgc2lnbmFsOnR5cGUKICAgKiBAZXZlbnQKICAgKiBAbWVtYmVyb2YgU2Vzc2lvbgogICAqIEBzZWUgPGEgaHJlZj0iU2Vzc2lvbi5odG1sI3NpZ25hbCI+U2Vzc2lvbi5zaWduYWwoKTwvYT4KICAgKiBAc2VlIFNpZ25hbEV2ZW50CiAgICogQHNlZSA8YSBocmVmPSIjZXZlbnQ6c2lnbmFsIj5zaWduYWw8L2E+IGV2ZW50CiAgICovCgoKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKICB2YXIgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CiAgc3R5bGUudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgc3R5bGUubWVkaWEgPSAnc2NyZWVuJzsKICBzdHlsZS5yZWwgPSAnc3R5bGVzaGVldCc7CiAgc3R5bGUuaHJlZiA9IE9ULnByb3BlcnRpZXMuY3NzVVJMOwogIHZhciBoZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwogIGhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KXsKCi8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgQU1EIG1vZHVsZSwgc2luY2UgVG9rQm94IGNvdWxkIGJlIGNvbmNhdGVuYXRlZCB3aXRoIG90aGVyCi8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKLy8gdW5kZXJzdGFuZHMgYW5vbnltb3VzIEFNRCBtb2R1bGVzLiBBIG5hbWVkIEFNRCBpcyBzYWZlc3QgYW5kIG1vc3Qgcm9idXN0Ci8vIHdheSB0byByZWdpc3Rlci4gVXBwZXJjYXNlIFRCIGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQovLyBkZXJpdmVkIGZyb20gZmlsZSBuYW1lcywgYW5kIE9wZW5Ub2sgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGFuIHVwcGVyY2FzZQovLyBmaWxlIG5hbWUuCmlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewogIGRlZmluZSggIlRCIiwgW10sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIFRCOyB9ICk7Cn0KCn0pKHdpbmRvdyk7Cg==",
                "body": "LyoqCiAqIEBsaWNlbnNlICBPcGVuVG9rIEphdmFTY3JpcHQgTGlicmFyeSB2Mi4wLjE2CiAqIGh0dHA6Ly93d3cudG9rYm94LmNvbS8KICoKICogQ29weXJpZ2h0IChjKSAyMDEzIFRva0JveCwgSW5jLgogKgogKiBEYXRlOiBEZWNlbWJlciAxMiAxMDo1MjoxNyAyMDEzCiAqLwoKKGZ1bmN0aW9uKHdpbmRvdykgewppZiAoIXdpbmRvdy5PVCkgd2luZG93Lk9UID0ge307CgpPVC5wcm9wZXJ0aWVzID0gewogIHZlcnNpb246ICJ2Mi4wLjE2IiwgICAgICAgICAvLyBUaGUgY3VycmVudCB2ZXJzaW9uIChlZy4gdjIuMC40KSAoVGhpcyBpcyByZXBsYWNlZCBieSBncmFkbGUpCiAgYnVpbGQ6ICIzMmE4MmJmIiwgICAgLy8gVGhlIGN1cnJlbnQgYnVpbGQgaGFzaCAoVGhpcyBpcyByZXBsYWNlZCBieSBncmFkbGUpCgogIGRlYnVnOiAiZmFsc2UiLCAgICAgIC8vIFdoZXRoZXIgb3Igbm90IHRvIHR1cm4gb24gZGVidWcgbG9nZ2luZyBieSBkZWZhdWx0CiAgd2Vic2l0ZVVSTDogImh0dHA6Ly93d3cudG9rYm94LmNvbSIsICAgICAgLy8gVGhlIFVSTCBvZiB0aGUgdG9rYm94IHdlYnNpdGUKCiAgY2RuVVJMOiAiaHR0cDovL3N0YXRpYy5vcGVudG9rLmNvbSIsICAgICAgICAvLyBUaGUgVVJMIG9mIHRoZSBDRE4KICBsb2dnaW5nVVJMOiAiaHR0cDovL2hsZy50b2tib3guY29tL3Byb2QiLCAgIC8vIFRoZSBVUkwgdG8gdXNlIGZvciBsb2dnaW5nCiAgYXBpVVJMOiAiaHR0cDovL2FudmlsLm9wZW50b2suY29tIiwgICAgICAgICAgLy8gVGhlIGFudmlsIEFQSSBVUkwKCiAgbWVzc2FnaW5nUHJvdG9jb2w6ICJ3c3MiLCAgICAgICAgIC8vIFdoYXQgcHJvdG9jb2wgdG8gdXNlIHdoZW4gY29ubmVjdGluZyB0byB0aGUgcnVtb3Igd2ViIHNvY2tldAogIG1lc3NhZ2luZ1BvcnQ6IDQ0MywgICAgICAgICAgICAgICAvLyBXaGF0IHBvcnQgdG8gdXNlIHdoZW4gY29ubmVjdGlvbiB0byB0aGUgcnVtb3Igd2ViIHNvY2tldAoKICBzdXBwb3J0U1NMOiAidHJ1ZSIsICAgICAgICAgICAvLyBJZiB0aGlzIGVudmlyb25tZW50IHN1cHBvcnRzIFNTTAogIGNkblVSTFNTTDogImh0dHBzOi8vc3d3dy50b2tib3guY29tIiwgICAgICAgICAvLyBUaGUgQ0ROIHRvIHVzZSBpZiB3ZSdyZSB1c2luZyBTU0wKICBsb2dnaW5nVVJMU1NMOiAiaHR0cHM6Ly9obGcudG9rYm94LmNvbS9wcm9kIiwgICAgLy8gVGhlIGxvZ2dnaW5nIFVSTCB0byB1c2UgaWYgd2UncmUgdXNpbmcgU1NMCiAgYXBpVVJMU1NMOiAiaHR0cHM6Ly9hbnZpbC5vcGVudG9rLmNvbSIgICAgICAgICAgICAgLy8gVGhlIGFudmlsIEFQSSBVUkwgdG8gdXNlIGlmIHdlJ3JlIHVzaW5nIFNTTAp9OwoKfSkod2luZG93KTsKLyoqCiAqIEBsaWNlbnNlICBDb21tb24gSlMgSGVscGVycyBvbiBPcGVuVG9rIDAuMS4wIDQ5OTdmZTIgbWFzdGVyCiAqIGh0dHA6Ly93d3cudG9rYm94LmNvbS8KICoKICogQ29weXJpZ2h0IChjKSAyMDEzIFRva0JveCwgSW5jLgogKgogKiBEYXRlOiBPY3RvYmVyIDAzIDEyOjIzOjA5IDIwMTMKICoKICovCgovLyBPVCBIZWxwZXIgTWV0aG9kcwovLwovLyBoZWxwZXJzLmpzICAgICAgICAgICAgICAgICAgICAgICAgICAgPC0gdGhlIHJvb3QgZmlsZQovLyBoZWxwZXJzL2xpYi97aGVscGVyIHRvcGljfS5qcyAgICAgICAgPC0gc3BlY2lhbGlzZWQgaGVscGVycyBmb3Igc3BlY2lmaWMgdGFza3MvdG9waWNzCi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGkuZS4gdmlkZW8sIGRvbSwgZXRjKQovLwovLyBAZXhhbXBsZSBHZXR0aW5nIGEgRE9NIGVsZW1lbnQgYnkgaXQncyBpZAovLyAgdmFyIGVsZW1lbnQgPSBPVEhlbHBlcnMoJ2RvbUlkJyk7Ci8vCi8vIEBleGFtcGxlIFRlc3RpbmcgZm9yIHdlYiBzb2NrZXQgc3VwcG9ydAovLyAgaWYgKE9ULnN1cHBvcnRzV2ViU29ja2V0cygpKSB7Ci8vICAgICAgLy8gZG8gc29tZSBzdHVmZiB3aXRoIHdlYnNvY2tldHMKLy8gIH0KLy8KCi8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwoKIShmdW5jdGlvbih3aW5kb3csIHVuZGVmaW5lZCkgewoKCnZhciBPVEhlbHBlcnMgPSBmdW5jdGlvbihkb21JZCkgewogICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGRvbUlkKTsKfTsKCnZhciBwcmV2aW91c09USGVscGVycyA9IHdpbmRvdy5PVEhlbHBlcnM7Cgp3aW5kb3cuT1RIZWxwZXJzID0gT1RIZWxwZXJzOwoKT1RIZWxwZXJzLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICBPVEhlbHBlcnMubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIE9USGVscGVyczsKICB9OwogIHdpbmRvdy5PVEhlbHBlcnMgPSBwcmV2aW91c09USGVscGVyczsKICByZXR1cm4gT1RIZWxwZXJzOwp9OwoKCk9USGVscGVycy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRydWU7CiAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSB8fCB0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwoKICAvLyBPYmplY3RzIHdpdGhvdXQgZW51bWVyYWJsZSBvd25lZCBwcm9wZXJ0aWVzIGFyZSBlbXB0eS4KICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHJldHVybiBmYWxzZTsKICB9CgogIHJldHVybiB0cnVlOwp9OwoKT1RIZWxwZXJzLmlzTm9uZSA9IGZ1bmN0aW9uKG9iaikgewogIHJldHVybiBvYmogPT09IHVuZGVmaW5lZCB8fCBvYmogPT09IG51bGw7Cn07CgpPVEhlbHBlcnMuaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKTsKfTsKCgpPVEhlbHBlcnMuaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbic7Cn07CgovLyBFeHRlbmQgYSB0YXJnZXQgb2JqZWN0IHdpdGggdGhlIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IKLy8gbW9yZSBzb3VyY2Ugb2JqZWN0cwovLwovLyBAZXhhbXBsZToKLy8gICAgZGVzdCA9IE9USGVscGVycy5leHRlbmQoZGVzdCwgc291cmNlMSwgc291cmNlMiwgc291cmNlMyk7Ci8vCk9USGVscGVycy5leHRlbmQgPSBmdW5jdGlvbigvKiBkZXN0LCBzb3VyY2UxWywgc291cmNlMiwgLi4uLCAsIHNvdXJjZU5dKi8pIHsKICAgIHZhciBzb3VyY2VzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICBkZXN0ID0gc291cmNlcy5zaGlmdCgpOwoKICAgIHNvdXJjZXMuZm9yRWFjaChmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgICAgIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwogICAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBkZXN0Owp9OwoKLy8gRW5zdXJlcyB0aGF0IHRoZSB0YXJnZXQgb2JqZWN0IGNvbnRhaW5zIGNlcnRhaW4gZGVmYXVsdHMuCi8vCi8vIEBleGFtcGxlCi8vICAgdmFyIG9wdGlvbnMgPSBPVEhlbHBlcnMuZGVmYXVsdHMob3B0aW9ucywgewovLyAgICAgbG9hZGluZzogdHJ1ZSAgICAgLy8gbG9hZGluZyBieSBkZWZhdWx0Ci8vICAgfSk7Ci8vCk9USGVscGVycy5kZWZhdWx0cyA9IGZ1bmN0aW9uKC8qIGRlc3QsIGRlZmF1bHRzMVssIGRlZmF1bHRzMiwgLi4uLCAsIGRlZmF1bHRzTl0qLykgewogICAgdmFyIHNvdXJjZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLAogICAgICAgIGRlc3QgPSBzb3VyY2VzLnNoaWZ0KCk7CgogICAgc291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKGRlc3Rba2V5XSA9PT0gdm9pZCAwKSBkZXN0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gZGVzdDsKfTsKCi8vCk9USGVscGVycy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFPVEhlbHBlcnMuaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IE9USGVscGVycy5leHRlbmQoe30sIG9iaik7Cn07CgoKCi8vIEhhbmR5IGRvIG5vdGhpbmcgZnVuY3Rpb24KT1RIZWxwZXJzLm5vb3AgPSBmdW5jdGlvbigpIHt9OwoKLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBjbGllbnQgc3VwcG9ydHMgV2ViU29ja2V0cywgZmFsc2Ugb3RoZXJ3aXNlLgpPVEhlbHBlcnMuc3VwcG9ydHNXZWJTb2NrZXRzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gJ1dlYlNvY2tldCcgaW4gd2luZG93Owp9OwoKLy8gUmV0dXJucyB0aGUgbnVtYmVyIG9mIG1pbGxpc2Nlb25kcyBzaW5jZSB0aGUgdGhlIFVOSVggZXBvY2gsIHRoaXMgaXMgZnVuY3Rpb25hbGx5Ci8vIGVxdWl2YWxlbnQgdG8gZXhlY3V0aW5nIG5ldyBEYXRlKCkuZ2V0VGltZSgpLgovLwovLyBXaGVyZSBhdmFpbGFibGUsIHdlIHVzZSAncGVyZm9ybWFuY2Uubm93JyB3aGljaCBpcyBtb3JlIGFjY3VyYXRlIGFuZCByZWxpYWJsZSwKLy8gb3RoZXJ3aXNlIHdlIGRlZmF1bHQgdG8gbmV3IERhdGUoKS5nZXRUaW1lKCkuCk9USGVscGVycy5ub3cgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgcGVyZm9ybWFuY2UgPSB3aW5kb3cucGVyZm9ybWFuY2UgfHwge30sCiAgICAgICAgbmF2aWdhdGlvblN0YXJ0LAogICAgICAgIG5vdyA9ICBwZXJmb3JtYW5jZS5ub3cgICAgICAgfHwKICAgICAgICAgICAgICAgcGVyZm9ybWFuY2UubW96Tm93ICAgIHx8CiAgICAgICAgICAgICAgIHBlcmZvcm1hbmNlLm1zTm93ICAgICB8fAogICAgICAgICAgICAgICBwZXJmb3JtYW5jZS5vTm93ICAgICAgfHwKICAgICAgICAgICAgICAgcGVyZm9ybWFuY2Uud2Via2l0Tm93OwoKICAgIGlmIChub3cpIHsKICAgICAgICBub3cgPSBub3cuYmluZChwZXJmb3JtYW5jZSk7CiAgICAgICAgbmF2aWdhdGlvblN0YXJ0ID0gcGVyZm9ybWFuY2UudGltaW5nLm5hdmlnYXRpb25TdGFydDsKCiAgICAgICAgcmV0dXJuICBmdW5jdGlvbigpIHsgcmV0dXJuIG5hdmlnYXRpb25TdGFydCArIG5vdygpOyB9OwogICAgfQogICAgZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7IH07CiAgICB9Cn0pKCk7CgpPVEhlbHBlcnMuYnJvd3NlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHVzZXJBZ2VudCA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCksCiAgICAgICAgbmF2aWdhdG9yVmVuZG9yLAogICAgICAgIGJyb3dzZXIgPSAnVW5rbm93bic7CgogICAgaWYgKHVzZXJBZ2VudC5pbmRleE9mKCdmaXJlZm94JykgPiAtMSkgICB7CiAgICAgICAgYnJvd3NlciA9ICdGaXJlZm94JzsKICAgIH0KICAgIGlmICh1c2VyQWdlbnQuaW5kZXhPZignb3BlcmEnKSA+IC0xKSAgIHsKICAgICAgICBicm93c2VyID0gJ09wZXJhJzsKICAgIH0KICAgIGVsc2UgaWYgKHVzZXJBZ2VudC5pbmRleE9mKCJtc2llIikgPiAtMSkgewogICAgICAgIGJyb3dzZXIgPSAiSUUiOwogICAgfQogICAgZWxzZSBpZiAodXNlckFnZW50LmluZGV4T2YoImNocm9tZSIpID4gLTEpIHsKICAgICAgICBicm93c2VyID0gIkNocm9tZSI7CiAgICB9CgogICAgaWYgKChuYXZpZ2F0b3JWZW5kb3IgPSB3aW5kb3cubmF2aWdhdG9yLnZlbmRvcikgJiYgbmF2aWdhdG9yVmVuZG9yLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiYXBwbGUiKSA+IC0xKSB7CiAgICAgICAgYnJvd3NlciA9ICJTYWZhcmkiOwogICAgfQoKICAgIHVzZXJBZ2VudCA9IG51bGw7CiAgICBPVEhlbHBlcnMuYnJvd3NlciA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gYnJvd3NlcjsgfTsKICAgIHJldHVybiBicm93c2VyOwp9OwoKCk9USGVscGVycy5jYW5EZWZpbmVQcm9wZXJ0eSA9IHRydWU7Cgp0cnkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHt9LCAneCcsIHt9KTsKfSBjYXRjaCAoZXJyKSB7CiAgICBPVEhlbHBlcnMuY2FuRGVmaW5lUHJvcGVydHkgPSBmYWxzZTsKfQoKLy8gQSBoZWxwZXIgZm9yIGRlZmluaW5nIGEgbnVtYmVyIG9mIGdldHRlcnMgYXQgb25jZS4KLy8KLy8gQGV4YW1wbGU6IGZyb20gaW5zaWRlIGFuIG9iamVjdAovLyAgIE9USGVscGVycy5kZWZpbmVHZXR0ZXJzKHRoaXMsIHsKLy8gICAgIGFwaUtleTogZnVuY3Rpb24oKSB7IHJldHVybiBfYXBpS2V5OyB9LAovLyAgICAgdG9rZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3Rva2VuOyB9LAovLyAgICAgY29ubmVjdGVkOiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuaXMoJ2Nvbm5lY3RlZCcpOyB9LAovLyAgICAgY29ubmVjdGlvbjogZnVuY3Rpb24oKSB7IHJldHVybiBfc29ja2V0ICYmIF9zb2NrZXQuaWQgPyB0aGlzLmNvbm5lY3Rpb25zLmdldChfc29ja2V0LmlkKSA6IG51bGw7IH0sCi8vICAgICBjYXBhYmlsaXRpZXM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3NvY2tldC5jYXBhYmlsaXRpZXM7IH0sCi8vICAgICBzZXNzaW9uSWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3Nlc3Npb25JZDsgfSwKLy8gICAgIGlkOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uSWQ7IH0KLy8gICB9KTsKLy8KT1RIZWxwZXJzLmRlZmluZUdldHRlcnMgPSBmdW5jdGlvbihzZWxmLCBnZXR0ZXJzLCBlbnVtZXJhYmxlKSB7CiAgdmFyIHByb3BzRGVmaW5pdGlvbiA9IHt9OwoKICBpZiAoZW51bWVyYWJsZSA9PT0gdm9pZCAwKSBlbnVtZXJhYmxlID0gZmFsc2U7CgogIGZvciAodmFyIGtleSBpbiBnZXR0ZXJzKSB7CiAgICBwcm9wc0RlZmluaXRpb25ba2V5XSA9IHsKICAgICAgZ2V0OiBnZXR0ZXJzW2tleV0sCiAgICAgIGVudW1lcmFibGU6IGVudW1lcmFibGUKICAgIH07CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhzZWxmLCBwcm9wc0RlZmluaXRpb24pOwp9OwoKCi8vIFBvbHlmaWxsIE9iamVjdC5jcmVhdGUgZm9yIElFOAovLwovLyBTZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9PYmplY3QvY3JlYXRlCi8vCmlmICghT2JqZWN0LmNyZWF0ZSkgewogICAgT2JqZWN0LmNyZWF0ZSA9IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignT2JqZWN0LmNyZWF0ZSBpbXBsZW1lbnRhdGlvbiBvbmx5IGFjY2VwdHMgdGhlIGZpcnN0IHBhcmFtZXRlci4nKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRigpIHt9CiAgICAgICAgRi5wcm90b3R5cGUgPSBvOwogICAgICAgIHJldHVybiBuZXcgRigpOwogICAgfTsKfQoKT1RIZWxwZXJzLnNldENvb2tpZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCB2YWx1ZSk7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICAvLyBTdG9yZSBpbiBicm93c2VyIGNvb2tpZQogICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpOwogICAgZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpKygzNjUqMjQqNjAqNjAqMTAwMCkpOwogICAgdmFyIGV4cGlyZXMgPSAiOyBleHBpcmVzPSIrZGF0ZS50b0dNVFN0cmluZygpOwogICAgZG9jdW1lbnQuY29va2llID0ga2V5KyI9Iit2YWx1ZStleHBpcmVzKyI7IHBhdGg9LyI7CiAgfQp9OwoKT1RIZWxwZXJzLmdldENvb2tpZSA9IGZ1bmN0aW9uKGtleSkgewogICAgdmFyIHZhbHVlOwoKICAgIHRyeSB7CiAgICAgIHZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oIm9wZW50b2tfY2xpZW50X2lkIik7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICAvLyBDaGVjayBicm93c2VyIGNvb2tpZXMKICAgICAgdmFyIG5hbWVFUSA9IGtleSArICI9IjsKICAgICAgdmFyIGNhID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCc7Jyk7CiAgICAgIGZvcih2YXIgaT0wO2kgPCBjYS5sZW5ndGg7aSsrKSB7CiAgICAgICAgdmFyIGMgPSBjYVtpXTsKICAgICAgICB3aGlsZSAoYy5jaGFyQXQoMCk9PScgJykgYyA9IGMuc3Vic3RyaW5nKDEsYy5sZW5ndGgpOwogICAgICAgIGlmIChjLmluZGV4T2YobmFtZUVRKSA9PT0gMCkgewogICAgICAgICAgdmFsdWUgPSBjLnN1YnN0cmluZyhuYW1lRVEubGVuZ3RoLGMubGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsOwp9OwoKCi8vLyBTdG9sZW4gZnJvbSBVbmRlcnNjb3JlLCB0aGlzIG5lZWRzIHJlcGxhY2luZwoKCiAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgogIE9USGVscGVycy5pbnZlcnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgcmVzdWx0W29ialtrZXldXSA9IGtleTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCgogIC8vIExpc3Qgb2YgSFRNTCBlbnRpdGllcyBmb3IgZXNjYXBpbmcuCiAgdmFyIGVudGl0eU1hcCA9IHsKICAgIGVzY2FwZTogewogICAgICAnJic6ICcmYW1wOycsCiAgICAgICc8JzogJyZsdDsnLAogICAgICAnPic6ICcmZ3Q7JywKICAgICAgJyInOiAnJnF1b3Q7JywKICAgICAgIiciOiAnJiN4Mjc7JywKICAgICAgJy8nOiAnJiN4MkY7JwogICAgfQogIH07CiAgZW50aXR5TWFwLnVuZXNjYXBlID0gT1RIZWxwZXJzLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKCiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiAgIG5ldyBSZWdFeHAoJ1snICsgT2JqZWN0LmtleXMoZW50aXR5TWFwLmVzY2FwZSkuam9pbignJykgKyAnXScsICdnJyksCiAgICB1bmVzY2FwZTogbmV3IFJlZ0V4cCgnKCcgKyBPYmplY3Qua2V5cyhlbnRpdHlNYXAudW5lc2NhcGUpLmpvaW4oJ3wnKSArICcpJywgJ2cnKQogIH07CgogIC8vIEZ1bmN0aW9ucyBmb3IgZXNjYXBpbmcgYW5kIHVuZXNjYXBpbmcgc3RyaW5ncyB0by9mcm9tIEhUTUwgaW50ZXJwb2xhdGlvbi4KICBbJ2VzY2FwZScsICd1bmVzY2FwZSddLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICBPVEhlbHBlcnNbbWV0aG9kXSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHN0cmluZyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiAoJycgKyBzdHJpbmcpLnJlcGxhY2UoZW50aXR5UmVnZXhlc1ttZXRob2RdLCBmdW5jdGlvbihtYXRjaCkgewogICAgICAgIHJldHVybiBlbnRpdHlNYXBbbWV0aG9kXVttYXRjaF07CiAgICAgIH0pOwogICAgfTsKICB9KTsKCi8vIEJ5IGRlZmF1bHQsIFVuZGVyc2NvcmUgdXNlcyBFUkItc3R5bGUgdGVtcGxhdGUgZGVsaW1pdGVycywgY2hhbmdlIHRoZQovLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCk9USGVscGVycy50ZW1wbGF0ZVNldHRpbmdzID0gewogIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgaW50ZXJwb2xhdGUgOiAvPCU9KFtcc1xTXSs/KSU+L2csCiAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKfTsKCi8vIFdoZW4gY3VzdG9taXppbmcgYHRlbXBsYXRlU2V0dGluZ3NgLCBpZiB5b3UgZG9uJ3Qgd2FudCB0byBkZWZpbmUgYW4KLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwovLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KdmFyIG5vTWF0Y2ggPSAvKC4pXi87CgovLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQovLyBzdHJpbmcgbGl0ZXJhbC4KdmFyIGVzY2FwZXMgPSB7CiAgIiciOiAgICAgICInIiwKICAnXFwnOiAgICAgJ1xcJywKICAnXHInOiAgICAgJ3InLAogICdcbic6ICAgICAnbicsCiAgJ1x0JzogICAgICd0JywKICAnXHUyMDI4JzogJ3UyMDI4JywKICAnXHUyMDI5JzogJ3UyMDI5Jwp9OwoKdmFyIGVzY2FwZXIgPSAvXFx8J3xccnxcbnxcdHxcdTIwMjh8XHUyMDI5L2c7CgovLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgovLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCi8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgpPVEhlbHBlcnMudGVtcGxhdGUgPSBmdW5jdGlvbih0ZXh0LCBkYXRhLCBzZXR0aW5ncykgewogIHZhciByZW5kZXI7CiAgc2V0dGluZ3MgPSBPVEhlbHBlcnMuZGVmYXVsdHMoe30sIHNldHRpbmdzLCBPVEhlbHBlcnMudGVtcGxhdGVTZXR0aW5ncyk7CgogIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogIHZhciBtYXRjaGVyID0gbmV3IFJlZ0V4cChbCiAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAoc2V0dGluZ3MuZXZhbHVhdGUgfHwgbm9NYXRjaCkuc291cmNlCiAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogIHZhciBpbmRleCA9IDA7CiAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwogIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkKICAgICAgLnJlcGxhY2UoZXNjYXBlciwgZnVuY3Rpb24obWF0Y2gpIHsgcmV0dXJuICdcXCcgKyBlc2NhcGVzW21hdGNoXTsgfSk7CgogICAgaWYgKGVzY2FwZSkgewogICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGVzY2FwZSArICIpKT09bnVsbD8nJzpPVEhlbHBlcnMuZXNjYXBlKF9fdCkpK1xuJyI7CiAgICB9CiAgICBpZiAoaW50ZXJwb2xhdGUpIHsKICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CiAgICB9CiAgICBpZiAoZXZhbHVhdGUpIHsKICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIjsKICAgIH0KICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwogICAgcmV0dXJuIG1hdGNoOwogIH0pOwogIHNvdXJjZSArPSAiJztcbiI7CgogIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCiAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCiAgICAicHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTtcbiIgKwogICAgc291cmNlICsgInJldHVybiBfX3A7XG4iOwoKCiAgdHJ5IHsKICAgIC8vIGV2aWwgaXMgbmVjZXNzYXJ5IGZvciB0aGUgbmV3IEZ1bmN0aW9uIGxpbmUKICAgIC8qanNoaW50IGV2aWw6dHJ1ZSAqLwogICAgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCBzb3VyY2UpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGUuc291cmNlID0gc291cmNlOwogICAgdGhyb3cgZTsKICB9CgogIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEpOwogIHZhciB0ZW1wbGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhKTsKICB9OwoKICAvLyBQcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbiBzb3VyY2UgYXMgYSBjb252ZW5pZW5jZSBmb3IgcHJlY29tcGlsYXRpb24uCiAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKICByZXR1cm4gdGVtcGxhdGU7Cn07Cgp9KSh3aW5kb3cpOwovKmpzaGludCBicm93c2VyOnRydWUsIHNtYXJ0dGFiczp0cnVlKi8KCi8vIHRiX3JlcXVpcmUoJy4uLy4uL2hlbHBlcnMuanMnKQoKKGZ1bmN0aW9uKHdpbmRvdywgT1RIZWxwZXJzLCB1bmRlZmluZWQpIHsKCk9USGVscGVycy5zdGF0YWJsZSA9IGZ1bmN0aW9uKHNlbGYsIHBvc3NpYmxlU3RhdGVzLCBpbml0aWFsU3RhdGUsIHN0YXRlQ2hhbmdlZCwgc3RhdGVDaGFuZ2VkRmFpbGVkKSB7CiAgdmFyIHByZXZpb3VzU3RhdGUsCiAgICAgIGN1cnJlbnRTdGF0ZSA9IGluaXRpYWxTdGF0ZTsKCiAgdmFyIHNldFN0YXRlID0gZnVuY3Rpb24oc3RhdGUpIHsKICAgIGlmIChjdXJyZW50U3RhdGUgIT09IHN0YXRlKSB7CiAgICAgICAgaWYgKHBvc3NpYmxlU3RhdGVzLmluZGV4T2Yoc3RhdGUpID09PSAtMSkgewogICAgICAgICAgaWYgKHN0YXRlQ2hhbmdlZEZhaWxlZCAmJiBPVEhlbHBlcnMuaXNGdW5jdGlvbihzdGF0ZUNoYW5nZWRGYWlsZWQpKSBzdGF0ZUNoYW5nZWRGYWlsZWQoJ2ludmFsaWRTdGF0ZScsIHN0YXRlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHByZXZpb3VzU3RhdGUgPSBjdXJyZW50U3RhdGU7CiAgICAgICAgY3VycmVudFN0YXRlID0gc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlQ2hhbmdlZCAmJiBPVEhlbHBlcnMuaXNGdW5jdGlvbihzdGF0ZUNoYW5nZWQpKSBzdGF0ZUNoYW5nZWQoc3RhdGUsIHByZXZpb3VzU3RhdGUpOwogICAgfQogIH07CgoKICAvLyBSZXR1cm5zIGEgbnVtYmVyIG9mIHN0YXRlcyBhbmQgcmV0dXJucyB0cnVlIGlmIHRoZSBjdXJyZW50IHN0YXRlCiAgLy8gaXMgYW55IG9mIHRoZW0uCiAgLy8KICAvLyBAZXhhbXBsZQogIC8vIGlmICh0aGlzLmlzKCdjb25uZWN0aW5nJywgJ2Nvbm5lY3RlZCcpKSB7CiAgLy8gICAvLyBkbyBzb21lIHN0dWZmCiAgLy8gfQogIC8vCiAgc2VsZi5pcyA9IGZ1bmN0aW9uICgvKiBzdGF0ZTA6U3RyaW5nLCBzdGF0ZTE6U3RyaW5nLCAuLi4sIHN0YXRlTjpTdHJpbmcgKi8pIHsKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFyZ3VtZW50cywgY3VycmVudFN0YXRlKSAhPT0gLTE7CiAgfTsKCgogIC8vIFJldHVybnMgYSBudW1iZXIgb2Ygc3RhdGVzIGFuZCByZXR1cm5zIHRydWUgaWYgdGhlIGN1cnJlbnQgc3RhdGUKICAvLyBpcyBub25lIG9mIHRoZW0uCiAgLy8KICAvLyBAZXhhbXBsZQogIC8vIGlmICh0aGlzLmlzTm90KCdjb25uZWN0aW5nJywgJ2Nvbm5lY3RlZCcpKSB7CiAgLy8gICAvLyBkbyBzb21lIHN0dWZmCiAgLy8gfQogIC8vCiAgc2VsZi5pc05vdCA9IGZ1bmN0aW9uICgvKiBzdGF0ZTA6U3RyaW5nLCBzdGF0ZTE6U3RyaW5nLCAuLi4sIHN0YXRlTjpTdHJpbmcgKi8pIHsKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFyZ3VtZW50cywgY3VycmVudFN0YXRlKSA9PT0gLTE7CiAgfTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoc2VsZiwgewogICAgc3RhdGU6IHsKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIGN1cnJlbnRTdGF0ZTsgfQogICAgfSwKCiAgICBwcmV2aW91c1N0YXRlOiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBwcmV2aW91c1N0YXRlOyB9CiAgICB9CiAgfSk7CgogIHJldHVybiBzZXRTdGF0ZTsKfTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7Ci8qIQogKiAgVGhpcyBpcyBhIG1vZGlmaWVkIHZlcnNpb24gb2YgUm9iZXJ0IEtpZWZmZXIgYXdlc29tZSB1dWlkLmpzIGxpYnJhcnkuCiAqICBUaGUgb25seSBtb2RpZmljYXRpb25zIHdlJ3ZlIG1hZGUgYXJlIHRvIHJlbW92ZSB0aGUgTm9kZS5qcyBzcGVjaWZpYwogKiAgcGFydHMgb2YgdGhlIGNvZGUgYW5kIHRoZSBVVUlEIHZlcnNpb24gMSBnZW5lcmF0b3IgKHdoaWNoIHdlIGRvbid0CiAqICB1c2UpLiBUaGUgb3JpZ2luYWwgY29weXJpZ2h0IG5vdGljZSBpcyBiZWxvdy4KICoKICogICAgIG5vZGUtdXVpZC91dWlkLmpzCiAqCiAqICAgICBDb3B5cmlnaHQgKGMpIDIwMTAgUm9iZXJ0IEtpZWZmZXIKICogICAgIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgogKiAgICAgRG9jdW1lbnRhdGlvbiBhbmQgZGV0YWlscyBhdCBodHRwczovL2dpdGh1Yi5jb20vYnJvb2ZhL25vZGUtdXVpZAogKi8KLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCgovKmdsb2JhbCBjcnlwdG86dHJ1ZSwgVWludDMyQXJyYXk6dHJ1ZSwgQnVmZmVyOnRydWUgKi8KLypqc2hpbnQgYnJvd3Nlcjp0cnVlLCBzbWFydHRhYnM6dHJ1ZSovCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKICAvLyBVbmlxdWUgSUQgY3JlYXRpb24gcmVxdWlyZXMgYSBoaWdoIHF1YWxpdHkgcmFuZG9tICMgZ2VuZXJhdG9yLCBidXQKICAvLyBNYXRoLnJhbmRvbSgpIGRvZXMgbm90IGd1YXJhbnRlZSAiY3J5cHRvZ3JhcGhpYyBxdWFsaXR5Ii4gIFNvIHdlIGZlYXR1cmUKICAvLyBkZXRlY3QgZm9yIG1vcmUgcm9idXN0IEFQSXMsIG5vcm1hbGl6aW5nIGVhY2ggbWV0aG9kIHRvIHJldHVybiAxMjgtYml0cwogIC8vICgxNiBieXRlcykgb2YgcmFuZG9tIGRhdGEuCiAgdmFyIG1hdGhSTkcsIHdoYXR3Z1JORzsKCiAgLy8gTWF0aC5yYW5kb20oKS1iYXNlZCBSTkcuICBBbGwgcGxhdGZvcm1zLCB2ZXJ5IGZhc3QsIHVua25vd24gcXVhbGl0eQogIHZhciBfcm5kQnl0ZXMgPSBuZXcgQXJyYXkoMTYpOwogIG1hdGhSTkcgPSBmdW5jdGlvbigpIHsKICAgIHZhciByLCBiID0gX3JuZEJ5dGVzLCBpID0gMDsKCiAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkrKykgewogICAgICBpZiAoKGkgJiAweDAzKSA9PT0gMCkgciA9IE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMDsKICAgICAgYltpXSA9IHIgPj4+ICgoaSAmIDB4MDMpIDw8IDMpICYgMHhmZjsKICAgIH0KCiAgICByZXR1cm4gYjsKICB9OwoKICAvLyBXSEFUV0cgY3J5cHRvLWJhc2VkIFJORyAtIGh0dHA6Ly93aWtpLndoYXR3Zy5vcmcvd2lraS9DcnlwdG8KICAvLyBXZWJLaXQgb25seSAoY3VycmVudGx5KSwgbW9kZXJhdGVseSBmYXN0LCBoaWdoIHF1YWxpdHkKICBpZiAod2luZG93LmNyeXB0byAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKSB7CiAgICB2YXIgX3JuZHMgPSBuZXcgVWludDMyQXJyYXkoNCk7CiAgICB3aGF0d2dSTkcgPSBmdW5jdGlvbigpIHsKICAgICAgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhfcm5kcyk7CgogICAgICBmb3IgKHZhciBjID0gMCA7IGMgPCAxNjsgYysrKSB7CiAgICAgICAgX3JuZEJ5dGVzW2NdID0gX3JuZHNbYyA+PiAyXSA+Pj4gKChjICYgMHgwMykgKiA4KSAmIDB4ZmY7CiAgICAgIH0KICAgICAgcmV0dXJuIF9ybmRCeXRlczsKICAgIH07CiAgfQoKICAvLyBTZWxlY3QgUk5HIHdpdGggYmVzdCBxdWFsaXR5CiAgdmFyIF9ybmcgPSB3aGF0d2dSTkcgfHwgbWF0aFJORzsKCiAgLy8gQnVmZmVyIGNsYXNzIHRvIHVzZQogIHZhciBCdWZmZXJDbGFzcyA9IHR5cGVvZihCdWZmZXIpID09ICdmdW5jdGlvbicgPyBCdWZmZXIgOiBBcnJheTsKCiAgLy8gTWFwcyBmb3IgbnVtYmVyIDwtPiBoZXggc3RyaW5nIGNvbnZlcnNpb24KICB2YXIgX2J5dGVUb0hleCA9IFtdOwogIHZhciBfaGV4VG9CeXRlID0ge307CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7IGkrKykgewogICAgX2J5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7CiAgICBfaGV4VG9CeXRlW19ieXRlVG9IZXhbaV1dID0gaTsKICB9CgogIC8vICoqYHBhcnNlKClgIC0gUGFyc2UgYSBVVUlEIGludG8gaXQncyBjb21wb25lbnQgYnl0ZXMqKgogIGZ1bmN0aW9uIHBhcnNlKHMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IChidWYgJiYgb2Zmc2V0KSB8fCAwLCBpaSA9IDA7CgogICAgYnVmID0gYnVmIHx8IFtdOwogICAgcy50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1swLTlhLWZdezJ9L2csIGZ1bmN0aW9uKG9jdCkgewogICAgICBpZiAoaWkgPCAxNikgeyAvLyBEb24ndCBvdmVyZmxvdyEKICAgICAgICBidWZbaSArIGlpKytdID0gX2hleFRvQnl0ZVtvY3RdOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBaZXJvIG91dCByZW1haW5pbmcgYnl0ZXMgaWYgc3RyaW5nIHdhcyBzaG9ydAogICAgd2hpbGUgKGlpIDwgMTYpIHsKICAgICAgYnVmW2kgKyBpaSsrXSA9IDA7CiAgICB9CgogICAgcmV0dXJuIGJ1ZjsKICB9CgogIC8vICoqYHVucGFyc2UoKWAgLSBDb252ZXJ0IFVVSUQgYnl0ZSBhcnJheSAoYWxhIHBhcnNlKCkpIGludG8gYSBzdHJpbmcqKgogIGZ1bmN0aW9uIHVucGFyc2UoYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gb2Zmc2V0IHx8IDAsIGJ0aCA9IF9ieXRlVG9IZXg7CiAgICByZXR1cm4gIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgJy0nICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV07CiAgfQoKICAvLyAqKmB2NCgpYCAtIEdlbmVyYXRlIHJhbmRvbSBVVUlEKioKCiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkIGZvciBBUEkgZGV0YWlscwogIGZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICAvLyBEZXByZWNhdGVkIC0gJ2Zvcm1hdCcgYXJndW1lbnQsIGFzIHN1cHBvcnRlZCBpbiB2MS4yCiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKCiAgICBpZiAodHlwZW9mKG9wdGlvbnMpID09ICdzdHJpbmcnKSB7CiAgICAgIGJ1ZiA9IG9wdGlvbnMgPT0gJ2JpbmFyeScgPyBuZXcgQnVmZmVyQ2xhc3MoMTYpIDogbnVsbDsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICB9CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBfcm5nKSgpOwoKICAgIC8vIFBlciA0LjQsIHNldCBiaXRzIGZvciB2ZXJzaW9uIGFuZCBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAKICAgIHJuZHNbNl0gPSAocm5kc1s2XSAmIDB4MGYpIHwgMHg0MDsKICAgIHJuZHNbOF0gPSAocm5kc1s4XSAmIDB4M2YpIHwgMHg4MDsKCiAgICAvLyBDb3B5IGJ5dGVzIHRvIGJ1ZmZlciwgaWYgcHJvdmlkZWQKICAgIGlmIChidWYpIHsKICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IDE2OyBpaSsrKSB7CiAgICAgICAgYnVmW2kgKyBpaV0gPSBybmRzW2lpXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBidWYgfHwgdW5wYXJzZShybmRzKTsKICB9CgogIC8vIEV4cG9ydCBwdWJsaWMgQVBJCiAgdmFyIHV1aWQgPSB2NDsKICB1dWlkLnY0ID0gdjQ7CiAgdXVpZC5wYXJzZSA9IHBhcnNlOwogIHV1aWQudW5wYXJzZSA9IHVucGFyc2U7CiAgdXVpZC5CdWZmZXJDbGFzcyA9IEJ1ZmZlckNsYXNzOwoKICAvLyBFeHBvcnQgUk5HIG9wdGlvbnMKICB1dWlkLm1hdGhSTkcgPSBtYXRoUk5HOwogIHV1aWQud2hhdHdnUk5HID0gd2hhdHdnUk5HOwoKICBPVEhlbHBlcnMudXVpZCA9IHV1aWQ7Cgp9KHdpbmRvdywgd2luZG93Lk9USGVscGVycykpOwovLyBBSkFYIGhlbHBlcnMKCi8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwovKmdsb2JhbCBBY3RpdmVYT2JqZWN0OnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKLy8gU2hpbSB1cCBYTUwgc3VwcG9ydCBmb3IgSUU4CmZ1bmN0aW9uIHNoaW1YTUxGb3JJRTgoeG1sKSB7CiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9ET00vRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZAogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHhtbC5wcm90b3R5cGUsICJmaXJzdEVsZW1lbnRDaGlsZCIsIHsKICAgICAgICAiZ2V0IiA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXM7CiAgICAgICAgICAgIG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlKG5vZGUgJiYgbm9kZS5ub2RlVHlwZSAhPSAxKSBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvRW4vRE9NL0VsZW1lbnQubGFzdEVsZW1lbnRDaGlsZAogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHhtbC5wcm90b3R5cGUsICJsYXN0RWxlbWVudENoaWxkIiwgewogICAgICAgICJnZXQiIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpczsKICAgICAgICAgICAgbm9kZSA9IG5vZGUubGFzdENoaWxkOwogICAgICAgICAgICB3aGlsZShub2RlICYmIG5vZGUubm9kZVR5cGUgIT0gMSkgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9Fbi9ET00vRWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh4bWwucHJvdG90eXBlLCAibmV4dEVsZW1lbnRTaWJsaW5nIiwgewogICAgICAgICJnZXQiIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpczsKICAgICAgICAgICAgd2hpbGUoIU9USGVscGVycy5pc05vbmUobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICBpZihub2RlLm5vZGVUeXBlID09IDEpIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9Fbi9ET00vRWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoeG1sLnByb3RvdHlwZSwgInByZXZpb3VzRWxlbWVudFNpYmxpbmciLCB7CiAgICAgICAgImdldCIgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzOwogICAgICAgICAgICB3aGlsZSghT1RIZWxwZXJzLmlzTm9uZShub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICBpZihub2RlLm5vZGVUeXBlID09IDEpIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgIH0pOwp9CgpPVEhlbHBlcnMucGFyc2VYTUwgPSBmdW5jdGlvbih4bWxTdHJpbmcpIHsKICAgIHZhciByb290LCB4bWw7CgogICAgaWYgKHdpbmRvdy5ET01QYXJzZXIpIHsgLy8gU3RhbmRhcmQgSUU5ICsgZXZlcnlvbmUgZWxzZQogICAgICAgIHhtbCA9IChuZXcgRE9NUGFyc2VyKCkpLnBhcnNlRnJvbVN0cmluZyh4bWxTdHJpbmcsICJ0ZXh0L3htbCIpOwogICAgfSBlbHNlIHsgLy8gPD0gSUU4CiAgICAgICAgeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKICAgICAgICB4bWwuYXN5bmMgPSAiZmFsc2UiOwogICAgICAgIHhtbC5sb2FkWE1MKHhtbFN0cmluZyk7CgogICAgICAgIHNoaW1YTUxGb3JJRTgoeG1sKTsKICAgIH0KCiAgICByb290ID0geG1sLmRvY3VtZW50RWxlbWVudDsKCiAgICBpZiAoIXJvb3QgfHwgIXJvb3Qubm9kZU5hbWUgfHwgcm9vdC5ub2RlTmFtZSA9PT0gInBhcnNlcmVycm9yIikgewogICAgICAgIC8vIEJhZGx5IGZvcm1lZCBYTUwKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZXR1cm4geG1sOwp9OwoKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKLypqc2hpbnQgYnJvd3Nlcjp0cnVlLCBzbWFydHRhYnM6dHJ1ZSovCgovLyB0Yl9yZXF1aXJlKCcuLi9oZWxwZXJzLmpzJykKCihmdW5jdGlvbih3aW5kb3csIE9USGVscGVycywgdW5kZWZpbmVkKSB7CgpPVEhlbHBlcnMudXNlTG9nSGVscGVycyA9IGZ1bmN0aW9uKG9uKXsKCiAgICAvLyBMb2cgbGV2ZWxzIGZvciBPVExvZy5zZXRMb2dMZXZlbAogICAgb24uREVCVUcgICAgPSA1OwogICAgb24uTE9HICAgICAgPSA0OwogICAgb24uSU5GTyAgICAgPSAzOwogICAgb24uV0FSTiAgICAgPSAyOwogICAgb24uRVJST1IgICAgPSAxOwogICAgb24uTk9ORSAgICAgPSAwOwoKICAgIHZhciBfbG9nTGV2ZWwgPSBvbi5OT05FLAogICAgICAgIF9sb2dzID0gW107CgogICAgLy8gR2VuZXJhdGVzIGEgbG9nZ2luZyBtZXRob2QgZm9yIGEgcGFydGljdWxhciBtZXRob2QgYW5kIGxvZyBsZXZlbC4KICAgIC8vCiAgICAvLyBBdHRlbXB0cyB0byBoYW5kbGUgdGhlIGZvbGxvd2luZyBjYXNlczoKICAgIC8vICogdGhlIGRlc2lyZWQgbG9nIG1ldGhvZCBkb2Vzbid0IGV4aXN0LCBjYWxsIGZhbGxiYWNrIChpZiBhdmFpbGFibGUpIGluc3RlYWQKICAgIC8vICogdGhlIGNvbnNvbGUgZnVuY3Rpb25hbGl0eSBpc24ndCBhdmFpbGFibGUgYmVjYXVzZSB0aGUgZGV2ZWxvcGVyIHRvb2xzIChpbiBJRSkKICAgIC8vIGFyZW4ndCBvcGVuLCBjYWxsIGZhbGxiYWNrIChpZiBhdmFpbGFibGUpCiAgICAvLyAqIGF0dGVtcHQgdG8gZGVhbCB3aXRoIHdlaXJkIElFIGhvc3RlZCBsb2dnaW5nIG1ldGhvZHMgYXMgYmVzdCB3ZSBjYW4uCiAgICAvLwogICAgZnVuY3Rpb24gZ2VuZXJhdGVMb2dnaW5nTWV0aG9kKG1ldGhvZCwgbGV2ZWwsIGZhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAob24uc2hvdWxkTG9nKGxldmVsKSkgewogICAgICAgICAgICAgICAgdmFyIGNvbnMgPSB3aW5kb3cuY29uc29sZTsKCiAgICAgICAgICAgICAgICAvLyBJbiBJRSwgd2luZG93LmNvbnNvbGUgbWF5IG5vdCBleGlzdCBpZiB0aGUgZGV2ZWxvcGVyIHRvb2xzIGFyZW4ndCBvcGVuCiAgICAgICAgICAgICAgICBpZiAoY29ucyAmJiBjb25zW21ldGhvZF0pIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgZGVzaXJlZCBjb25zb2xlIG1ldGhvZCBpc24ndCBhIHJlYWwgb2JqZWN0LCB3aGljaCBtZWFucwogICAgICAgICAgICAgICAgICAgIC8vIHRoYXQgd2UgY2FuJ3QgdXNlIGFwcGx5IG9uIGl0LiBXZSBmb3JjZSBpdCB0byBiZSBhIHJlYWwgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgLy8gdXNpbmcgRnVuY3Rpb24uYmluZCwgYXNzdW1pbmcgdGhhdCdzIGF2YWlsYWJsZS4KICAgICAgICAgICAgICAgICAgICBpZiAoY29uc1ttZXRob2RdLmFwcGx5IHx8IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29uc1ttZXRob2RdLmFwcGx5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zW21ldGhvZF0gPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNbbWV0aG9kXSwgY29ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNbbWV0aG9kXS5hcHBseShjb25zLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpc24ndCB0aGUgc2FtZSByZXN1bHQgYXMgdGhlIGFib3ZlLCBidXQgaXQncyBiZXR0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhhbiBub3RoaW5nLgogICAgICAgICAgICAgICAgICAgICAgICBjb25zW21ldGhvZF0oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKS5qb2luKCcgJykKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChmYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrLmFwcGx5KG9uLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGFwcGVuZFRvTG9ncyhtZXRob2QsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKCiAgICBvbi5sb2cgPSBnZW5lcmF0ZUxvZ2dpbmdNZXRob2QoJ2xvZycsIG9uLkxPRyk7CgogICAgLy8gR2VuZXJhdGUgZGVidWcsIGluZm8sIHdhcm4sIGFuZCBlcnJvciBsb2dnaW5nIG1ldGhvZHMsIHRoZXNlIGFsbCBmYWxsYmFjayB0byBvbi5sb2cKICAgIG9uLmRlYnVnID0gZ2VuZXJhdGVMb2dnaW5nTWV0aG9kKCdkZWJ1ZycsIG9uLkRFQlVHLCBvbi5sb2cpOwogICAgb24uaW5mbyA9IGdlbmVyYXRlTG9nZ2luZ01ldGhvZCgnaW5mbycsIG9uLklORk8sIG9uLmxvZyk7CiAgICBvbi53YXJuID0gZ2VuZXJhdGVMb2dnaW5nTWV0aG9kKCd3YXJuJywgb24uV0FSTiwgb24ubG9nKTsKICAgIG9uLmVycm9yID0gZ2VuZXJhdGVMb2dnaW5nTWV0aG9kKCdlcnJvcicsIG9uLkVSUk9SLCBvbi5sb2cpOwoKCiAgICBvbi5zZXRMb2dMZXZlbCA9IGZ1bmN0aW9uKGxldmVsKSB7CiAgICAgICAgX2xvZ0xldmVsID0gdHlwZW9mKGxldmVsKSA9PT0gJ251bWJlcicgPyBsZXZlbCA6IDA7CiAgICAgICAgb24uZGVidWcoIlRCLnNldExvZ0xldmVsKCIgKyBfbG9nTGV2ZWwgKyAiKSIpOwogICAgICAgIHJldHVybiBfbG9nTGV2ZWw7CiAgICB9OwoKICAgIG9uLmdldExvZ3MgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gX2xvZ3M7CiAgICB9OwoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbGV2ZWwgaXMgdmlzaWJsZSBnaXZlbiB0aGUgY3VycmVudCBsb2dMZXZlbC4KICAgIG9uLnNob3VsZExvZyA9IGZ1bmN0aW9uKGxldmVsKSB7CiAgICAgICAgcmV0dXJuIF9sb2dMZXZlbCA+PSBsZXZlbDsKICAgIH07CgogICAgLy8gRm9ybWF0IHRoZSBjdXJyZW50IHRpbWUgbmljZWx5IGZvciBsb2dnaW5nLiBSZXR1cm5zIHRoZSBjdXJyZW50CiAgICAvLyBsb2NhbCB0aW1lLgogICAgZnVuY3Rpb24gZm9ybWF0RGF0ZVN0YW1wKCkgewogICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogICAgICAgIHJldHVybiBub3cudG9Mb2NhbGVUaW1lU3RyaW5nKCkgKyBub3cuZ2V0TWlsbGlzZWNvbmRzKCk7CiAgICB9CgoKICAgIC8vIEFwcGVuZCArYXJncysgdG8gbG9ncywgYWxvbmcgd2l0aCB0aGUgY3VycmVudCBsb2cgbGV2ZWwgYW5kIHRoZSBhIGRhdGUgc3RhbXAuCiAgICBmdW5jdGlvbiBhcHBlbmRUb0xvZ3MobGV2ZWwsIGFyZ3MpIHsKICAgICAgICBpZiAoIWFyZ3MpIHJldHVybjsKCiAgICAgICAgdmFyIG1lc3NhZ2U7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShhcmdzKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgbWVzc2FnZSA9IGFyZ3MudG9TdHJpbmcoKTsKICAgICAgICB9CgogICAgICAgIGlmIChtZXNzYWdlLmxlbmd0aCA8PSAyKSByZXR1cm47CgogICAgICAgIF9sb2dzLnB1c2goCiAgICAgICAgICAgIFtsZXZlbCwgZm9ybWF0RGF0ZVN0YW1wKCksIG1lc3NhZ2VdCiAgICAgICAgKTsKICAgIH0KCn07CgpPVEhlbHBlcnMudXNlTG9nSGVscGVycyhPVEhlbHBlcnMpOwpPVEhlbHBlcnMuc2V0TG9nTGV2ZWwoT1RIZWxwZXJzLkVSUk9SKTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7Ci8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKT1RIZWxwZXJzLmNhc3RUb0Jvb2xlYW4gPSBmdW5jdGlvbih2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIHJldHVybiB2YWx1ZSA9PT0gJ3RydWUnIHx8IHZhbHVlID09PSB0cnVlOwp9OwoKT1RIZWxwZXJzLnJvdW5kRmxvYXQgPSBmdW5jdGlvbih2YWx1ZSwgcGxhY2VzKSB7CiAgICByZXR1cm4gcGFyc2VJbnQoTWF0aC5yb3VuZCh2YWx1ZSpNYXRoLnBvdygxMCwgcGxhY2VzKSksIDEwKS9NYXRoLnBvdygxMCwgcGxhY2VzKTsKfTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7Ci8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCi8vIHRiX3JlcXVpcmUoJy4uL3ZlbmRvci91dWlkLmpzJykKCihmdW5jdGlvbih3aW5kb3csIE9USGVscGVycywgdW5kZWZpbmVkKSB7Cgp2YXIgdGltZW91dHMgPSBbXSwKICAgIG1lc3NhZ2VOYW1lID0gIk9USGVscGVycy4iICsgT1RIZWxwZXJzLnV1aWQudjQoKSArICIuemVyby10aW1lb3V0IjsKCnZhciBoYW5kbGVNZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIGlmIChldmVudC5zb3VyY2UgPT0gd2luZG93ICYmIGV2ZW50LmRhdGEgPT0gbWVzc2FnZU5hbWUpIHsKICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICBpZiAodGltZW91dHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHRpbWVvdXRzLnNoaWZ0KCksCiAgICAgICAgICAgICAgICBmbiA9IGFyZ3Muc2hpZnQoKTsKCiAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIH0KICAgIH0KfTsKCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgaGFuZGxlTWVzc2FnZSwgdHJ1ZSk7CgovLyBDYWxscyB0aGUgZnVuY3Rpb24gK2ZuKyBhc3luY2hyb25vdXNseSB3aXRoIHRoZSBjdXJyZW50IGV4ZWN1dGlvbi4KLy8gVGhpcyBpcyBtb3N0IGNvbW1vbmx5IHVzZWQgdG8gZXhlY3V0ZSBzb21ldGhpbmcgc3RyYWlnaHQgYWZ0ZXIKLy8gdGhlIGN1cnJlbnQgZnVuY3Rpb24uCi8vCi8vIEFueSBhcmd1bWVudHMgaW4gYWRkaXRpb24gdG8gK2ZuKyB3aWxsIGJlIHBhc3NlZCB0byArZm4rIHdoZW4gaXQncwovLyBjYWxsZWQuCi8vCi8vIFlvdSB3b3VsZCB1c2UgdGhpcyBpbnBsYWNlIG9mIHNldFRpbWVvdXQoZm4sIDApIHR5cGUgY29uc3RydWN0cy4gY2FsbEFzeW5jCi8vIGlzIHByZWZlcmFibGUgYXMgaXQgZXhlY3V0ZXMgaW4gYSBtdWNoIG1vcmUgcHJlZGljdGFibGUgdGltZSB3aW5kb3csCi8vIHVubGlrZSBzZXRUaW1lb3V0IHdoaWNoIGNvdWxkIGV4ZWN1dGUgYW55d2hlcmUgZnJvbSAybXMgdG8gc2V2ZXJhbCB0aG91c2FuZAovLyBkZXBlbmRpbmcgb24gdGhlIGJyb3dzZXIvY29udGV4dC4KLy8KT1RIZWxwZXJzLmNhbGxBc3luYyA9IGZ1bmN0aW9uICgvKiBmbiwgW2FyZzEsIGFyZzIsIC4uLiwgYXJnTl0gKi8pIHsKICAgIHRpbWVvdXRzLnB1c2goQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSk7CiAgICB3aW5kb3cucG9zdE1lc3NhZ2UobWVzc2FnZU5hbWUsICIqIik7Cn07CgoKLy8gV3JhcHMgK2hhbmRsZXIrIGluIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGV4ZWN1dGUgaXQgYXN5bmNocm9ub3VzbHkKLy8gc28gdGhhdCBpdCBkb2Vzbid0IGludGVyZmVyZSB3aXRoIGl0J3MgZXhjZXV0aW9uIGNvbnRleHQgaWYgaXQgcmFpc2VzCi8vIGFuIGV4Y2VwdGlvbi4KT1RIZWxwZXJzLmNyZWF0ZUFzeW5jSGFuZGxlciA9IGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgogICAgICAgIE9USGVscGVycy5jYWxsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICBoYW5kbGVyLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIH0pOwogICAgfTsKfTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7Ci8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwovKmdsb2JhbCBqYXNtaW5lOnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vLi4vaGVscGVycy5qcycpCi8vIHRiX3JlcXVpcmUoJy4uL2NhbGxiYWNrcy5qcycpCgoKKGZ1bmN0aW9uKHdpbmRvdywgT1RIZWxwZXJzLCB1bmRlZmluZWQpIHsKCi8qKgoqIFRoaXMgYmFzZSBjbGFzcyBkZWZpbmVzIHRoZSA8Y29kZT5hZGRFdmVudExpc3RlbmVyKCk8L2NvZGU+IGFuZCA8Y29kZT5yZW1vdmVFdmVudExpc3RuZXIoKTwvY29kZT4gbWV0aG9kcyBvZiBvYmplY3RzCiogdGhhdCBjYW4gZGlzcGF0Y2ggZXZlbnRzLgoqCiogQGNsYXNzIEV2ZW50RGlzcGF0Y2hlcgoqLwpPVEhlbHBlcnMuZXZlbnRpbmcgPSBmdW5jdGlvbihzZWxmLCBzeW5jcm9ub3VzKSB7CiAgdmFyIF9ldmVudHMgPSB7fTsKCgogIC8vIENhbGwgdGhlIGRlZmF1bHRBY3Rpb24sIHBhc3NpbmcgYXJncwogIGZ1bmN0aW9uIGV4ZWN1dGVEZWZhdWx0QWN0aW9uKGRlZmF1bHRBY3Rpb24sIGFyZ3MpIHsKICAgIGlmICghZGVmYXVsdEFjdGlvbikgcmV0dXJuOwoKICAgIGRlZmF1bHRBY3Rpb24uYXBwbHkobnVsbCwgYXJncy5zbGljZSgpKTsKICB9CgogIC8vIEV4ZWN1dGUgZWFjaCBoYW5kbGVyIGluICtsaXN0ZW5lcnMrIHdpdGggK2FyZ3MrLgogIC8vCiAgLy8gRWFjaCBoYW5kbGVyIHdpbGwgYmUgZXhlY3V0ZWQgYXN5bmMuIE9uIGNvbXBsZXRpb24gdGhlIGRlZmF1bHRBY3Rpb24KICAvLyBoYW5kbGVyIHdpbGwgYmUgZXhlY3V0ZWQgd2l0aCB0aGUgYXJncy4KICAvLwogIC8vIEBwYXJhbSBbQXJyYXldIGxpc3RlbmVycwogIC8vICAgIEFuIGFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlLiBFYWNoIHdpbGwgYmUgcGFzc2VkIGFyZ3MuCiAgLy8KICAvLyBAcGFyYW0gW0FycmF5XSBhcmdzCiAgLy8gICAgQW4gYXJyYXkgb2YgYXJndW1lbnRzIHRvIGV4ZWN1dGUgZWFjaCBmdW5jdGlvbiBpbiAgK2xpc3RlbmVycysgd2l0aC4KICAvLwogIC8vIEBwYXJhbSBbU3RyaW5nXSBuYW1lCiAgLy8gICAgVGhlIG5hbWUgb2YgdGhpcyBldmVudC4KICAvLwogIC8vIEBwYXJhbSBbRnVuY3Rpb24sIE51bGwsIFVuZGVmaW5lZF0gZGVmYXVsdEFjdGlvbgogIC8vICAgIEFuIG9wdGlvbmFsIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgYWZ0ZXIgZXZlcnkgb3RoZXIgaGFuZGxlci4gVGhpcyB3aWxsIGV4ZWN1dGUgZXZlbgogIC8vICAgIGlmICtsaXN0ZW5lcnMrIGlzIGVtcHR5LiArZGVmYXVsdEFjdGlvbisgd2lsbCBiZSBwYXNzZWQgYXJncyBhcyBhIG5vcm1hbAogIC8vICAgIGhhbmRsZXIgd291bGQuCiAgLy8KICAvLyBAcmV0dXJuIFVuZGVmaW5lZAogIC8vCiAgZnVuY3Rpb24gZXhlY3V0ZUxpc3RlbmVyc0FzeW5jcm9ub3VzbHkobmFtZSwgYXJncywgZGVmYXVsdEFjdGlvbikgewogICAgdmFyIGxpc3RlbmVycyA9IF9ldmVudHNbbmFtZV07CiAgICBpZiAoIWxpc3RlbmVycyB8fCBsaXN0ZW5lcnMubGVuZ3RoID09PSAwKSByZXR1cm47CgogICAgdmFyIGxpc3RlbmVyQWNrcyA9IGxpc3RlbmVycy5sZW5ndGg7CgogICAgbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24obGlzdGVuZXIpIHsgLy8gLCBpbmRleAogICAgICBmdW5jdGlvbiBmaWx0ZXJIYW5kbGVyQW5kQ29udGV4dChfbGlzdGVuZXIpIHsKICAgICAgICByZXR1cm4gX2xpc3RlbmVyLmNvbnRleHQgPT09IGxpc3RlbmVyLmNvbnRleHQgJiYgX2xpc3RlbmVyLmhhbmRsZXIgPT09IGxpc3RlbmVyLmhhbmRsZXI7CiAgICAgIH0KCiAgICAgIC8vIFdlIHJ1biB0aGlzIGFzeW5jaHJvbm91c2x5IHNvIHRoYXQgaXQgZG9lc24ndCBpbnRlcmZlcmUgd2l0aCBleGVjdXRpb24gaWYgYW4gZXJyb3IgaGFwcGVucwogICAgICBPVEhlbHBlcnMuY2FsbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAvLyBoYXZlIHRvIGNoZWNrIGlmIHRoZSBsaXN0ZW5lciBoYXMgbm90IGJlZW4gcmVtb3ZlZAogICAgICAgICAgaWYgKF9ldmVudHNbbmFtZV0gJiYgX2V2ZW50c1tuYW1lXS5zb21lKGZpbHRlckhhbmRsZXJBbmRDb250ZXh0KSkgewogICAgICAgICAgICAobGlzdGVuZXIuY2xvc3VyZSB8fCBsaXN0ZW5lci5oYW5kbGVyKS5hcHBseShsaXN0ZW5lci5jb250ZXh0IHx8IG51bGwsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgIGxpc3RlbmVyQWNrcy0tOwoKICAgICAgICAgIGlmIChsaXN0ZW5lckFja3MgPT09IDApIHsKICAgICAgICAgICAgZXhlY3V0ZURlZmF1bHRBY3Rpb24oZGVmYXVsdEFjdGlvbiwgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0KCgogIC8vIFRoaXMgaXMgaWRlbnRpY2FsIHRvIGV4ZWN1dGVMaXN0ZW5lcnNBc3luY3Jvbm91c2x5IGV4Y2VwdCB0aGF0IGhhbmRsZXJzIHdpbGwKICAvLyBiZSBleGVjdXRlZCBzeW5jcm9ub3VzbHkuCiAgLy8KICAvLyBPbiBjb21wbGV0aW9uIHRoZSBkZWZhdWx0QWN0aW9uIGhhbmRsZXIgd2lsbCBiZSBleGVjdXRlZCB3aXRoIHRoZSBhcmdzLgogIC8vCiAgLy8gQHBhcmFtIFtBcnJheV0gbGlzdGVuZXJzCiAgLy8gICAgQW4gYXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUuIEVhY2ggd2lsbCBiZSBwYXNzZWQgYXJncy4KICAvLwogIC8vIEBwYXJhbSBbQXJyYXldIGFyZ3MKICAvLyAgICBBbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gZXhlY3V0ZSBlYWNoIGZ1bmN0aW9uIGluICArbGlzdGVuZXJzKyB3aXRoLgogIC8vCiAgLy8gQHBhcmFtIFtTdHJpbmddIG5hbWUKICAvLyAgICBUaGUgbmFtZSBvZiB0aGlzIGV2ZW50LgogIC8vCiAgLy8gQHBhcmFtIFtGdW5jdGlvbiwgTnVsbCwgVW5kZWZpbmVkXSBkZWZhdWx0QWN0aW9uCiAgLy8gICAgQW4gb3B0aW9uYWwgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBldmVyeSBvdGhlciBoYW5kbGVyLiBUaGlzIHdpbGwgZXhlY3V0ZSBldmVuCiAgLy8gICAgaWYgK2xpc3RlbmVycysgaXMgZW1wdHkuICtkZWZhdWx0QWN0aW9uKyB3aWxsIGJlIHBhc3NlZCBhcmdzIGFzIGEgbm9ybWFsCiAgLy8gICAgaGFuZGxlciB3b3VsZC4KICAvLwogIC8vIEByZXR1cm4gVW5kZWZpbmVkCiAgLy8KICBmdW5jdGlvbiBleGVjdXRlTGlzdGVuZXJzU3luY3Jvbm91c2x5KG5hbWUsIGFyZ3MpIHsgLy8gZGVmYXVsdEFjdGlvbiBpcyBub3QgdXNlZAogICAgdmFyIGxpc3RlbmVycyA9IF9ldmVudHNbbmFtZV07CiAgICBpZiAoIWxpc3RlbmVycyB8fCBsaXN0ZW5lcnMubGVuZ3RoID09PSAwKSByZXR1cm47CgogICAgbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24obGlzdGVuZXIpIHsgLy8gaW5kZXgKICAgICAgKGxpc3RlbmVyLmNsb3N1cmUgfHwgbGlzdGVuZXIuaGFuZGxlcikuYXBwbHkobGlzdGVuZXIuY29udGV4dCB8fCBudWxsLCBhcmdzKTsKICAgIH0pOwogIH0KCiAgdmFyIGV4ZWN1dGVMaXN0ZW5lcnMgPSBzeW5jcm9ub3VzID09PSB0cnVlID8gZXhlY3V0ZUxpc3RlbmVyc1N5bmNyb25vdXNseSA6IGV4ZWN1dGVMaXN0ZW5lcnNBc3luY3Jvbm91c2x5OwoKCiAgdmFyIHJlbW92ZUFsbExpc3RlbmVyc05hbWVkID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGV4dCkgewogICAgaWYgKF9ldmVudHNbZXZlbnROYW1lXSkgewogICAgICBpZiAoY29udGV4dCkgewogICAgICAgIC8vIFdlIGFyZSByZW1vdmluZyBieSBjb250ZXh0LCBnZXQgb25seSBldmVudHMgdGhhdCBkb24ndAogICAgICAgIC8vIG1hdGNoIHRoYXQgY29udGV4dAogICAgICAgIF9ldmVudHNbZXZlbnROYW1lXSA9IF9ldmVudHNbZXZlbnROYW1lXS5maWx0ZXIoZnVuY3Rpb24obGlzdGVuZXIpewogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyLmNvbnRleHQgIT09IGNvbnRleHQ7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgZGVsZXRlIF9ldmVudHNbZXZlbnROYW1lXTsKICAgICAgfQogICAgfQogIH07CgogIHZhciBhZGRMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoZXZlbnROYW1lcywgaGFuZGxlciwgY29udGV4dCwgY2xvc3VyZSkgewogICAgdmFyIGxpc3RlbmVyID0ge2hhbmRsZXI6IGhhbmRsZXJ9OwogICAgaWYgKGNvbnRleHQpIGxpc3RlbmVyLmNvbnRleHQgPSBjb250ZXh0OwogICAgaWYgKGNsb3N1cmUpIGxpc3RlbmVyLmNsb3N1cmUgPSBjbG9zdXJlOwoKICAgIGV2ZW50TmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghX2V2ZW50c1tuYW1lXSkgX2V2ZW50c1tuYW1lXSA9IFtdOwogICAgICBfZXZlbnRzW25hbWVdLnB1c2gobGlzdGVuZXIpOwogICAgfSk7CiAgfS5iaW5kKHNlbGYpOwoKCiAgdmFyIHJlbW92ZUxpc3RlbmVycyA9IGZ1bmN0aW9uIChldmVudE5hbWVzLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICBmdW5jdGlvbiBmaWx0ZXJIYW5kbGVyQW5kQ29udGV4dChsaXN0ZW5lcikgewogICAgICByZXR1cm4gIShsaXN0ZW5lci5oYW5kbGVyID09PSBoYW5kbGVyICYmIGxpc3RlbmVyLmNvbnRleHQgPT09IGNvbnRleHQpOwogICAgfQoKICAgIGV2ZW50TmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmIChfZXZlbnRzW25hbWVdKSB7CiAgICAgICAgX2V2ZW50c1tuYW1lXSA9IF9ldmVudHNbbmFtZV0uZmlsdGVyKGZpbHRlckhhbmRsZXJBbmRDb250ZXh0KTsKICAgICAgICBpZiAoX2V2ZW50c1tuYW1lXS5sZW5ndGggPT09IDApIGRlbGV0ZSBfZXZlbnRzW25hbWVdOwogICAgICB9CiAgICB9KTsKICB9LmJpbmQoc2VsZik7CgoKICAvLyBFeGVjdXRlIGFueSBsaXN0ZW5lcnMgYm91bmQgdG8gdGhlICtldmVudCsgRXZlbnQuCiAgLy8KICAvLyBFYWNoIGhhbmRsZXIgd2lsbCBiZSBleGVjdXRlZCBhc3luYy4gT24gY29tcGxldGlvbiB0aGUgZGVmYXVsdEFjdGlvbgogIC8vIGhhbmRsZXIgd2lsbCBiZSBleGVjdXRlZCB3aXRoIHRoZSBhcmdzLgogIC8vCiAgLy8gQHBhcmFtIFtFdmVudF0gZXZlbnQKICAvLyAgICBBbiBFdmVudCBvYmplY3QuCiAgLy8KICAvLyBAcGFyYW0gW0Z1bmN0aW9uLCBOdWxsLCBVbmRlZmluZWRdIGRlZmF1bHRBY3Rpb24KICAvLyAgICBBbiBvcHRpb25hbCBmdW5jdGlvbiB0byBleGVjdXRlIGFmdGVyIGV2ZXJ5IG90aGVyIGhhbmRsZXIuIFRoaXMgd2lsbCBleGVjdXRlIGV2ZW4KICAvLyAgICBpZiB0aGVyZSBhcmUgbGlzdGVuZXJzIGJvdW5kIHRvIHRoaXMgZXZlbnQuICtkZWZhdWx0QWN0aW9uKyB3aWxsIGJlIHBhc3NlZAogIC8vICAgIGFyZ3MgYXMgYSBub3JtYWwgaGFuZGxlciB3b3VsZC4KICAvLwogIC8vIEByZXR1cm4gdGhpcwogIC8vCiAgc2VsZi5kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oZXZlbnQsIGRlZmF1bHRBY3Rpb24pIHsKICAgIGlmICghZXZlbnQudHlwZSkgewogICAgICBPVEhlbHBlcnMuZXJyb3IoIk9USGVscGVycy5FdmVudGluZy5kaXNwYXRjaEV2ZW50OiBFdmVudCBoYXMgbm8gdHlwZSIpOwogICAgICBPVEhlbHBlcnMuZXJyb3IoZXZlbnQpOwoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJPVEhlbHBlcnMuRXZlbnRpbmcuZGlzcGF0Y2hFdmVudDogRXZlbnQgaGFzIG5vIHR5cGUiKTsKICAgIH0KCiAgICBpZiAoIWV2ZW50LnRhcmdldCkgewogICAgICBldmVudC50YXJnZXQgPSB0aGlzOwogICAgfQoKICAgIGlmICghX2V2ZW50c1tldmVudC50eXBlXSB8fCBfZXZlbnRzW2V2ZW50LnR5cGVdLmxlbmd0aCA9PT0gMCkgewogICAgICBleGVjdXRlRGVmYXVsdEFjdGlvbihkZWZhdWx0QWN0aW9uLCBbZXZlbnRdKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGV4ZWN1dGVMaXN0ZW5lcnMoZXZlbnQudHlwZSwgW2V2ZW50XSwgZGVmYXVsdEFjdGlvbik7CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gRXhlY3V0ZSBlYWNoIGhhbmRsZXIgZm9yIHRoZSBldmVudCBjYWxsZWQgK25hbWUrLgogIC8vCiAgLy8gRWFjaCBoYW5kbGVyIHdpbGwgYmUgZXhlY3V0ZWQgYXN5bmMsIGFuZCBhbnkgZXhjZXB0aW9ucyB0aGF0IHRoZXkgdGhyb3cgd2lsbAogIC8vIGJlIGNhdWdodCBhbmQgbG9nZ2VkCiAgLy8KICAvLyBIb3cgdG8gcGFzcyB0aGVzZT8KICAvLyAgKiBkZWZhdWx0QWN0aW9uCiAgLy8KICAvLyBAZXhhbXBsZQogIC8vICBmb28ub24oJ2JhcicsIGZ1bmN0aW9uKG5hbWUsIG1lc3NhZ2UpIHsKICAvLyAgICBhbGVydCgiSGVsbG8gIiArIG5hbWUgKyAiOiAiICsgbWVzc2FnZSk7CiAgLy8gIH0pOwogIC8vCiAgLy8gIGZvby50cmlnZ2VyKCdPcGVuVG9rJywgJ2FzZGYnKTsgICAgIC8vIC0+IEhlbGxvIE9wZW5Ub2s6IGFzZGYKICAvLwogIC8vCiAgLy8gQHBhcmFtIFtTdHJpbmddIGV2ZW50TmFtZQogIC8vICAgIFRoZSBuYW1lIG9mIHRoaXMgZXZlbnQuCiAgLy8KICAvLyBAcGFyYW0gW0FycmF5XSBhcmd1bWVudHMKICAvLyAgICBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgYmV5b25kICtldmVudE5hbWUrIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBoYW5kbGVycy4KICAvLwogIC8vIEByZXR1cm4gdGhpcwogIC8vCiAgc2VsZi50cmlnZ2VyID0gZnVuY3Rpb24oZXZlbnROYW1lKSB7CiAgICBpZiAoIV9ldmVudHNbZXZlbnROYW1lXSB8fCBfZXZlbnRzW2V2ZW50TmFtZV0ubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgogICAgLy8gUmVtb3ZlIHRoZSBldmVudE5hbWUgYXJnCiAgICBhcmdzLnNoaWZ0KCk7CgogICAgZXhlY3V0ZUxpc3RlbmVycyhldmVudE5hbWUsIGFyZ3MpOwoKICAgIHJldHVybiB0aGlzOwogIH07CgogIHNlbGYub24gPSBmdW5jdGlvbihldmVudE5hbWVzLCBoYW5kbGVyX29yX2NvbnRleHQsIGNvbnRleHQpIHsKICAgIGlmICh0eXBlb2YoZXZlbnROYW1lcykgPT09ICJzdHJpbmciICYmIGhhbmRsZXJfb3JfY29udGV4dCkgewogICAgICBhZGRMaXN0ZW5lcnMoZXZlbnROYW1lcy5zcGxpdCgnICcpLCBoYW5kbGVyX29yX2NvbnRleHQsIGNvbnRleHQpOwogICAgfQogICAgZWxzZSB7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnROYW1lcykgewogICAgICAgIGlmIChldmVudE5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICBhZGRMaXN0ZW5lcnMoW25hbWVdLCBldmVudE5hbWVzW25hbWVdLCBoYW5kbGVyX29yX2NvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH07Cgogc2VsZi5vZmYgPSBmdW5jdGlvbihldmVudE5hbWVzLCBoYW5kbGVyX29yX2NvbnRleHQsIGNvbnRleHQpIHsKICAgIGlmICh0eXBlb2YoZXZlbnROYW1lcykgPT09ICJzdHJpbmciKSB7CiAgICAgIGlmIChoYW5kbGVyX29yX2NvbnRleHQgJiYgT1RIZWxwZXJzLmlzRnVuY3Rpb24oaGFuZGxlcl9vcl9jb250ZXh0KSkgewogICAgICAgIHJlbW92ZUxpc3RlbmVycyhldmVudE5hbWVzLnNwbGl0KCcgJyksIGhhbmRsZXJfb3JfY29udGV4dCwgY29udGV4dCk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgZXZlbnROYW1lcy5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmVtb3ZlQWxsTGlzdGVuZXJzTmFtZWQobmFtZSwgaGFuZGxlcl9vcl9jb250ZXh0KTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfQogICAgfQogICAgZWxzZSBpZiAoIWV2ZW50TmFtZXMpIHsKICAgICAgLy8gcmVtb3ZlIGFsbCBib3VuZCBldmVudHMKICAgICAgX2V2ZW50cyA9IHt9OwogICAgfQogICAgZWxzZSB7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnROYW1lcykgewogICAgICAgIGlmIChldmVudE5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICByZW1vdmVMaXN0ZW5lcnMoW25hbWVdLCBldmVudE5hbWVzW25hbWVdLCBoYW5kbGVyX29yX2NvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH07CgoKICBzZWxmLm9uY2UgPSBmdW5jdGlvbihldmVudE5hbWVzLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICB2YXIgbmFtZXMgPSBldmVudE5hbWVzLnNwbGl0KCcgJyksCiAgICAgICAgZnVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gaGFuZGxlci5hcHBseShjb250ZXh0IHx8IG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICByZW1vdmVMaXN0ZW5lcnMobmFtZXMsIGhhbmRsZXIsIGNvbnRleHQpOwoKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfS5iaW5kKHRoaXMpOwoKICAgIGFkZExpc3RlbmVycyhuYW1lcywgaGFuZGxlciwgY29udGV4dCwgZnVuKTsKICAgIHJldHVybiB0aGlzOwogIH07CgoKICAvKioKICAqIFRoaXMgbWV0aG9kIHJlZ2lzdGVycyBhIG1ldGhvZCBhcyBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBzcGVjaWZpYyBldmVudC4KICAqIDxwPgogICoKICAqIDxwPgogICogICBJZiBhIGhhbmRsZXIgaXMgbm90IHJlZ2lzdGVyZWQgZm9yIGFuIGV2ZW50LCB0aGUgZXZlbnQgaXMgaWdub3JlZCBsb2NhbGx5LiBJZiB0aGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gZG9lcyBub3QgZXhpc3QsCiAgKiAgIHRoZSBldmVudCBpcyBpZ25vcmVkIGxvY2FsbHkuCiAgKiA8L3A+CiAgKiA8cD4KICAqICAgVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZiB0aGUgPGNvZGU+bGlzdGVuZXI8L2NvZGU+IG5hbWUgaXMgaW52YWxpZC4KICAqIDwvcD4KICAqCiAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIGlkZW50aWZ5aW5nIHRoZSB0eXBlIG9mIGV2ZW50LgogICoKICAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIFRoZSBmdW5jdGlvbiB0byBiZSBpbnZva2VkIHdoZW4gdGhlIG9iamVjdCBkaXNwYXRjaGVzIHRoZSBldmVudC4KICAqCiAgKiBAbWVtYmVyT2YgRXZlbnREaXNwYXRjaGVyCiAgKiBAbWV0aG9kICNhZGRFdmVudExpc3RlbmVyCiAgKiBAc2VlIDxhIGhyZWY9IiNldmVudHMiPkV2ZW50czwvYT4KICAqLwogIC8vIFNlZSAnb24nIGZvciB1c2FnZS4KICAvLyBAZGVwcmVjaWF0ZWQgd2lsbCBiZWNvbWUgYSBwcml2YXRlIGhlbHBlciBmdW5jdGlvbiBpbiB0aGUgZnV0dXJlLgogIHNlbGYuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgYWRkTGlzdGVuZXJzKFtldmVudE5hbWVdLCBoYW5kbGVyLCBjb250ZXh0KTsKICB9OwoKCiAgLyoqCiAgKiBSZW1vdmVzIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIHNwZWNpZmljIGV2ZW50LgogICogPHA+CiAgKgogICogPHA+CiAgKiAgIFRocm93cyBhbiBleGNlcHRpb24gaWYgdGhlIDxjb2RlPmxpc3RlbmVyPC9jb2RlPiBuYW1lIGlzIGludmFsaWQuCiAgKiA8L3A+CiAgKgogICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHN0cmluZyBpZGVudGlmeWluZyB0aGUgdHlwZSBvZiBldmVudC4KICAqCiAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciBUaGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gdG8gcmVtb3ZlLgogICoKICAqIEBtZW1iZXJPZiBFdmVudERpc3BhdGNoZXIKICAqIEBtZXRob2QgI3JlbW92ZUV2ZW50TGlzdGVuZXIKICAqIEBzZWUgPGEgaHJlZj0iI2V2ZW50cyI+RXZlbnRzPC9hPgogICovCiAgLy8gU2VlICdvZmYnIGZvciB1c2FnZS4KICAvLyBAZGVwcmVjaWF0ZWQgd2lsbCBiZWNvbWUgYSBwcml2YXRlIGhlbHBlciBmdW5jdGlvbiBpbiB0aGUgZnV0dXJlLgogIHNlbGYucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgcmVtb3ZlTGlzdGVuZXJzKFtldmVudE5hbWVdLCBoYW5kbGVyLCBjb250ZXh0KTsKICB9OwoKCgoKCiAgcmV0dXJuIHNlbGY7Cn07CgpPVEhlbHBlcnMuZXZlbnRpbmcuRXZlbnQgPSBmdW5jdGlvbigpIHsKCiAgICByZXR1cm4gZnVuY3Rpb24gKHR5cGUsIGNhbmNlbGFibGUpIHsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMuY2FuY2VsYWJsZSA9IGNhbmNlbGFibGUgIT09IHVuZGVmaW5lZCA/IGNhbmNlbGFibGUgOiB0cnVlOwoKICAgICAgICB2YXIgX2RlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZSwKICAgICAgICAgICAgX3RhcmdldCA9IG51bGw7CgogICAgICAgIHRoaXMucHJldmVudERlZmF1bHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY2FuY2VsYWJsZSkgewogICAgICAgICAgICAgICAgX2RlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgT1RIZWxwZXJzLndhcm4oIkV2ZW50LnByZXZlbnREZWZhdWx0IDo6IFRyeWluZyB0byBwcmV2ZW50RGVmYXVsdCBvbiBhbiBFdmVudCB0aGF0IGlzbid0IGNhbmNlbGFibGUiKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBfZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICB9OwoKICAgICAgICBpZiAoT1RIZWxwZXJzLmNhbkRlZmluZVByb3BlcnR5KSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAndGFyZ2V0JywgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGFyZ2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKfTsKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKLypqc2hpbnQgYnJvd3Nlcjp0cnVlLCBzbWFydHRhYnM6dHJ1ZSovCgovLyB0Yl9yZXF1aXJlKCcuLi9oZWxwZXJzLmpzJykKLy8gdGJfcmVxdWlyZSgnLi9jYWxsYmFja3MuanMnKQoKLy8gRE9NIGhlbHBlcnMKKGZ1bmN0aW9uKHdpbmRvdywgT1RIZWxwZXJzLCB1bmRlZmluZWQpIHsKCi8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgY2xpZW50IHN1cHBvcnRzIGVsZW1lbnQuY2xhc3NMaXN0Ck9USGVscGVycy5zdXBwb3J0c0NsYXNzTGlzdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGhhc1N1cHBvcnQgPSB0eXBlb2YoZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiKSAmJiAoImNsYXNzTGlzdCIgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpKTsKICAgIE9USGVscGVycy5zdXBwb3J0c0NsYXNzTGlzdCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gaGFzU3VwcG9ydDsgfTsKCiAgICByZXR1cm4gaGFzU3VwcG9ydDsKfTsKCk9USGVscGVycy5yZW1vdmVFbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5wYXJlbnROb2RlKSB7CiAgICAgICAgZWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgfQp9OwoKT1RIZWxwZXJzLnJlbW92ZUVsZW1lbnRCeUlkID0gZnVuY3Rpb24oZWxlbWVudElkKSB7CiAgICB0aGlzLnJlbW92ZUVsZW1lbnQoT1RIZWxwZXJzKGVsZW1lbnRJZCkpOwp9OwoKT1RIZWxwZXJzLnJlbW92ZUVsZW1lbnRzQnlUeXBlID0gZnVuY3Rpb24ocGFyZW50RWxlbSwgdHlwZSkgewogICAgaWYgKCFwYXJlbnRFbGVtKSByZXR1cm47CgogICAgdmFyIGVsZW1lbnRzID0gcGFyZW50RWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0eXBlKTsKCiAgICAvLyBlbGVtZW50cyBpcyBhICJsaXZlIiBOb2Rlc0xpc3QgY29sbGVjdGlvbi4gTWVhbmluZyB0aGF0IHRoZSBjb2xsZWN0aW9uCiAgICAvLyBpdHNlbGYgd2lsbCBiZSBtdXRhdGVkIGFzIHdlIHJlbW92ZSBlbGVtZW50cyBmcm9tIHRoZSBET00uIFRoaXMgbWVhbnMKICAgIC8vIHRoYXQgIndoaWxlIHRoZXJlIGFyZSBzdGlsbCBlbGVtZW50cyIgaXMgc2FmZXIgdGhhbiAiaXRlcmF0ZSBvdmVyIGVhY2gKICAgIC8vIGVsZW1lbnQiIGFzIHRoZSBjb2xsZWN0aW9uIGxlbmd0aCBhbmQgdGhlIGVsZW1lbnRzIGluZGljZXMgd2lsbCBiZSBtb2RpZmllZAogICAgLy8gd2l0aCBlYWNoIGl0ZXJhdGlvbi4KICAgIHdoaWxlIChlbGVtZW50cy5sZW5ndGgpIHsKICAgICAgICBwYXJlbnRFbGVtLnJlbW92ZUNoaWxkKGVsZW1lbnRzWzBdKTsKICAgIH0KfTsKCk9USGVscGVycy5lbXB0eUVsZW1lbnQgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB3aGlsZSAoZWxlbWVudC5maXJzdENoaWxkKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVDaGlsZChlbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgfQogICAgcmV0dXJuIGVsZW1lbnQ7Cn07CgpPVEhlbHBlcnMuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uKG5vZGVOYW1lLCBhdHRyaWJ1dGVzLCBpbm5lckhUTUwpIHsKICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChub2RlTmFtZSk7CgogICAgaWYgKGF0dHJpYnV0ZXMpIHsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZihhdHRyaWJ1dGVzW25hbWVdKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIGlmICghZWxlbWVudFtuYW1lXSkgZWxlbWVudFtuYW1lXSA9IHt9OwoKICAgICAgICAgICAgICAgIHZhciBzdWJBdHRycyA9IGF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBuIGluIHN1YkF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtuYW1lXVtuXSA9IHN1YkF0dHJzW25dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKG5hbWUgPT09ICdjbGFzc05hbWUnKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCBhdHRyaWJ1dGVzW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAoaW5uZXJIVE1MKSB7CiAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBpbm5lckhUTUw7CiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnQ7Cn07CgpPVEhlbHBlcnMuY3JlYXRlQnV0dG9uID0gZnVuY3Rpb24oaW5uZXJIVE1MLCBhdHRyaWJ1dGVzLCBldmVudHMpIHsKICAgIHZhciBidXR0b24gPSBPVEhlbHBlcnMuY3JlYXRlRWxlbWVudCgnYnV0dG9uJywgYXR0cmlidXRlcywgaW5uZXJIVE1MKTsKCiAgICBpZiAoZXZlbnRzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBldmVudHMpIHsKICAgICAgICAgICAgaWYgKGV2ZW50cy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgT1RIZWxwZXJzLm9uKGJ1dHRvbiwgbmFtZSwgZXZlbnRzW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYnV0dG9uLl9ib3VuZEV2ZW50cyA9IGV2ZW50czsKICAgIH0KCiAgICByZXR1cm4gYnV0dG9uOwp9OwoKLy8gSGVscGVyIGZ1bmN0aW9uIGZvciBhZGRpbmcgZXZlbnQgbGlzdGVuZXJzIHRvIGRvbSBlbGVtZW50cy4KLy8gV0FSTklORzogVGhpcyBkb2Vzbid0IHByZXNlcnZlIGV2ZW50IHR5cGVzLCB5b3VyIGhhbmRsZXIgY291bGQgYmUgZ2V0dGluZyBhbGwga2luZHMgb2YgZGlmZmVyZW50Ci8vIHBhcmFtZXRlcnMgZGVwZW5kaW5nIG9uIHRoZSBicm93c2VyLiBZb3UgYWxzbyBtYXkgaGF2ZSBkaWZmZXJlbnQgc2NvcGVzIGRlcGVuZGluZyBvbiB0aGUgYnJvd3NlcgovLyBhbmQgYnViYmxpbmcgYW5kIGNhbmNlbGFibGUgYXJlIG5vdCBzdXBwb3J0ZWQuCk9USGVscGVycy5vbiA9IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50TmFtZSwgIGhhbmRsZXIpIHsKICAgIGlmIChlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBoYW5kbGVyLCBmYWxzZSk7CiAgICB9IGVsc2UgaWYgKGVsZW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIgKyBldmVudE5hbWUsIGhhbmRsZXIpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgb2xkSGFuZGxlciA9IGVsZW1lbnRbIm9uIitldmVudE5hbWVdOwogICAgICAgIGVsZW1lbnRbIm9uIitldmVudE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBoYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAob2xkSGFuZGxlcikgb2xkSGFuZGxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICB9Cn07CgovLyBIZWxwZXIgZnVuY3Rpb24gZm9yIHJlbW92aW5nIGV2ZW50IGxpc3RlbmVycyBmcm9tIGRvbSBlbGVtZW50cy4KT1RIZWxwZXJzLm9mZiA9IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgaWYgKGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciAoZXZlbnROYW1lLCBoYW5kbGVyLGZhbHNlKTsKICAgIH0KICAgIGVsc2UgaWYgKGVsZW1lbnQuZGV0YWNoRXZlbnQpIHsKICAgICAgICBlbGVtZW50LmRldGFjaEV2ZW50KCJvbiIgKyBldmVudE5hbWUsIGhhbmRsZXIpOwogICAgfQp9OwoKCi8vIERldGVjdHMgd2hlbiBhbiBlbGVtZW50IGlzIG5vdCBwYXJ0IG9mIHRoZSBkb2N1bWVudCBmbG93IGJlY2F1c2UgaXQgb3Igb25lIG9mIGl0J3MgYW5jZXN0ZXJzIGhhcyBkaXNwbGF5Om5vbmUuCk9USGVscGVycy5pc0Rpc3BsYXlOb25lID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgaWYgKCAoZWxlbWVudC5vZmZzZXRXaWR0aCA9PT0gMCB8fCBlbGVtZW50Lm9mZnNldEhlaWdodCA9PT0gMCkgJiYgT1RIZWxwZXJzLmNzcyhlbGVtZW50LCAnZGlzcGxheScpID09PSAnbm9uZScpIHJldHVybiB0cnVlOwogICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZSAmJiBlbGVtZW50LnBhcmVudE5vZGUuc3R5bGUpIHJldHVybiBPVEhlbHBlcnMuaXNEaXNwbGF5Tm9uZShlbGVtZW50LnBhcmVudE5vZGUpOwogICAgcmV0dXJuIGZhbHNlOwp9OwoKT1RIZWxwZXJzLmZpbmRFbGVtZW50V2l0aERpc3BsYXlOb25lID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgaWYgKCAoZWxlbWVudC5vZmZzZXRXaWR0aCA9PT0gMCB8fCBlbGVtZW50Lm9mZnNldEhlaWdodCA9PT0gMCkgJiYgT1RIZWxwZXJzLmNzcyhlbGVtZW50LCAnZGlzcGxheScpID09PSAnbm9uZScpIHJldHVybiBlbGVtZW50OwogICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZSAmJiBlbGVtZW50LnBhcmVudE5vZGUuc3R5bGUpIHJldHVybiBPVEhlbHBlcnMuZmluZEVsZW1lbnRXaXRoRGlzcGxheU5vbmUoZWxlbWVudC5wYXJlbnROb2RlKTsKICAgIHJldHVybiBudWxsOwp9OwoKZnVuY3Rpb24gb2JqZWN0SGFzUHJvcGVydGllcyhvYmopIHsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwp9CgoKLy8gQWxsb3dzIGFuICtvbkNoYW5nZSsgY2FsbGJhY2sgdG8gYmUgdHJpZ2dlcmVkIHdoZW4gc3BlY2lmaWMgc3R5bGUgcHJvcGVydGllcwovLyBvZiArZWxlbWVudCsgYXJlIG5vdGlmaWVkLiBUaGUgY2FsbGJhY2sgYWNjZXB0cyBhIHNpbmdsZSBwYXJhbWV0ZXIsIHdoaWNoIGlzCi8vIGEgaGFzaCB3aGVyZSB0aGUga2V5cyBhcmUgdGhlIHN0eWxlIHByb3BlcnR5IHRoYXQgY2hhbmdlZCBhbmQgdGhlIHZhbHVlcyBhcmUKLy8gYW4gYXJyYXkgY29udGFpbmluZyB0aGUgb2xkIGFuZCBuZXcgdmFsdWVzIChbb2xkVmFsdWUsIG5ld1ZhbHVlXSkuCi8vCi8vIFRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgTXV0YXRpb25PYnNlcnZlciBpdHNlbGYuIE9uY2UgeW91IG5vIGxvbmdlciB3aXNoCi8vIHRvIG9ic2VydmUgdGhlIGVsZW1lbnQgeW91IHNob3VsZCBjYWxsIGRpc2Nvbm5lY3Qgb24gdGhlIG9ic2VydmVyLgovLwovLyBPYnNlcnZpbmcgY2hhbmdlczoKLy8gIC8vIG9ic2VydmUgY2hhbmdpbmdzIHRvIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIG9iamVjdAovLyAgZGltZW5zaW9uc09ic2VydmVyID0gT1RIZWxwZXJzLm9ic2VydmVTdHlsZUNoYW5nZXMob2JqZWN0LCBbJ3dpZHRoJywgJ2hlaWdodCddLCBmdW5jdGlvbihjaGFuZ2VTZXQpIHsKLy8gICAgICBPVC5kZWJ1ZygiVGhlIG5ldyB3aWR0aCBhbmQgaGVpZ2h0IGFyZSAiICsgY2hhbmdlU2V0LndpZHRoWzFdICsgJywnICsgY2hhbmdlU2V0LmhlaWdodFsxXSk7Ci8vICB9KTsKLy8KLy8gQ2xlYW5pbmcgdXAKLy8gIC8vIHN0b3Agb2JzZXJ2aW5nIGNoYW5nZXMKLy8gIGRpbWVuc2lvbnNPYnNlcnZlci5kaXNjb25uZWN0KCk7Ci8vICBkaW1lbnNpb25zT2JzZXJ2ZXIgPSBudWxsOwovLwpPVEhlbHBlcnMub2JzZXJ2ZVN0eWxlQ2hhbmdlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0eWxlc1RvT2JzZXJ2ZSwgb25DaGFuZ2UpIHsKICAgIHZhciBvbGRTdHlsZXMgPSB7fTsKCiAgICB2YXIgZ2V0U3R5bGUgPSBmdW5jdGlvbiBnZXRTdHlsZShzdHlsZSkgewogICAgICAgICAgICBzd2l0Y2ggKHN0eWxlKSB7CiAgICAgICAgICAgIGNhc2UgJ3dpZHRoJzoKICAgICAgICAgICAgICAgIHJldHVybiBPVEhlbHBlcnMud2lkdGgoZWxlbWVudCk7CgogICAgICAgICAgICBjYXNlICdoZWlnaHQnOgogICAgICAgICAgICAgICAgcmV0dXJuIE9USGVscGVycy5oZWlnaHQoZWxlbWVudCk7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIE9USGVscGVycy5jc3MoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgIC8vIGdldCB0aGUgaW5pdGFsIHZhbHVlcwogICAgc3R5bGVzVG9PYnNlcnZlLmZvckVhY2goZnVuY3Rpb24oc3R5bGUpIHsKICAgICAgICBvbGRTdHlsZXNbc3R5bGVdID0gZ2V0U3R5bGUoc3R5bGUpOwogICAgfSk7CgogICAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24obXV0YXRpb25zKSB7CiAgICAgICAgdmFyIGNoYW5nZVNldCA9IHt9OwoKICAgICAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihtdXRhdGlvbikgewogICAgICAgICAgICBpZiAobXV0YXRpb24uYXR0cmlidXRlTmFtZSAhPT0gJ3N0eWxlJykgcmV0dXJuOwoKICAgICAgICAgICAgc3R5bGVzVG9PYnNlcnZlLmZvckVhY2goZnVuY3Rpb24oc3R5bGUpIHsKICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IGdldFN0eWxlKHN0eWxlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3VmFsdWUgIT09IG9sZFN0eWxlc1tzdHlsZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBPVC5kZWJ1ZygiQ0hBTkdFRCAiICsgc3R5bGUgKyAiOiAiICsgb2xkU3R5bGVzW3N0eWxlXSArICIgLT4gIiArIG5ld1ZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgY2hhbmdlU2V0W3N0eWxlXSA9IFtvbGRTdHlsZXNbc3R5bGVdLCBuZXdWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgb2xkU3R5bGVzW3N0eWxlXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKG9iamVjdEhhc1Byb3BlcnRpZXMoY2hhbmdlU2V0KSkgewogICAgICAgICAgICAvLyBEbyB0aGlzIGFmdGVyIHNvIGFzIHRvIGhlbHAgYXZvaWQgaW5maW5pdGUgbG9vcHMgb2YgbXV0YXRpb25zLgogICAgICAgICAgICBPVEhlbHBlcnMuY2FsbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgb25DaGFuZ2UuY2FsbChudWxsLCBjaGFuZ2VTZXQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICBvYnNlcnZlci5vYnNlcnZlKGVsZW1lbnQsIHsKICAgICAgICBhdHRyaWJ1dGVzOnRydWUsCiAgICAgICAgYXR0cmlidXRlRmlsdGVyOiBbJ3N0eWxlJ10sCiAgICAgICAgY2hpbGRMaXN0OmZhbHNlLAogICAgICAgIGNoYXJhY3RlckRhdGE6ZmFsc2UsCiAgICAgICAgc3VidHJlZTpmYWxzZQogICAgfSk7CgogICAgcmV0dXJuIG9ic2VydmVyOwp9OwoKCi8vIHRyaWdnZXIgdGhlICtvbkNoYW5nZSsgY2FsbGJhY2sgd2hlbmV2ZXIKLy8gMS4gK2VsZW1lbnQrIGlzIHJlbW92ZWQKLy8gMi4gb3IgYW4gaW1tZWRpYXRlIGNoaWxkIG9mICtlbGVtZW50KyBpcyByZW1vdmVkLgovLwovLyBUaGlzIGZ1bmN0aW9uIHJldHVybnMgdGhlIE11dGF0aW9uT2JzZXJ2ZXIgaXRzZWxmLiBPbmNlIHlvdSBubyBsb25nZXIgd2lzaAovLyB0byBvYnNlcnZlIHRoZSBlbGVtZW50IHlvdSBzaG91bGQgY2FsbCBkaXNjb25uZWN0IG9uIHRoZSBvYnNlcnZlci4KLy8KLy8gT2JzZXJ2aW5nIGNoYW5nZXM6Ci8vICAvLyBvYnNlcnZlIGNoYW5naW5ncyB0byB0aGUgd2lkdGggYW5kIGhlaWdodCBvZiBvYmplY3QKLy8gIG5vZGVPYnNlcnZlciA9IE9USGVscGVycy5vYnNlcnZlTm9kZU9yQ2hpbGROb2RlUmVtb3ZhbChvYmplY3QsIGZ1bmN0aW9uKHJlbW92ZWROb2RlcykgewovLyAgICAgIE9ULmRlYnVnKCJTb21lIGNoaWxkIG5vZGVzIHdlcmUgcmVtb3ZlZCIpOwovLyAgICAgIHJlbW92ZWROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKLy8gICAgICAgICAgT1QuZGVidWcobm9kZSk7Ci8vICAgICAgfSk7Ci8vICB9KTsKLy8KLy8gQ2xlYW5pbmcgdXAKLy8gIC8vIHN0b3Agb2JzZXJ2aW5nIGNoYW5nZXMKLy8gIG5vZGVPYnNlcnZlci5kaXNjb25uZWN0KCk7Ci8vICBub2RlT2JzZXJ2ZXIgPSBudWxsOwovLwpPVEhlbHBlcnMub2JzZXJ2ZU5vZGVPckNoaWxkTm9kZVJlbW92YWwgPSBmdW5jdGlvbihlbGVtZW50LCBvbkNoYW5nZSkgewogICAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24obXV0YXRpb25zKSB7CiAgICAgICAgdmFyIHJlbW92ZWROb2RlcyA9IFtdOwoKICAgICAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihtdXRhdGlvbikgewogICAgICAgICAgICBpZiAobXV0YXRpb24ucmVtb3ZlZE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gcmVtb3ZlZE5vZGVzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChtdXRhdGlvbi5yZW1vdmVkTm9kZXMpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBpZiAocmVtb3ZlZE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICAvLyBEbyB0aGlzIGFmdGVyIHNvIGFzIHRvIGhlbHAgYXZvaWQgaW5maW5pdGUgbG9vcHMgb2YgbXV0YXRpb25zLgogICAgICAgICAgICBPVEhlbHBlcnMuY2FsbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgb25DaGFuZ2UocmVtb3ZlZE5vZGVzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgogICAgb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgICAgYXR0cmlidXRlczpmYWxzZSwKICAgICAgICBjaGlsZExpc3Q6dHJ1ZSwKICAgICAgICBjaGFyYWN0ZXJEYXRhOmZhbHNlLAogICAgICAgIHN1YnRyZWU6dHJ1ZQogICAgfSk7CgogICAgcmV0dXJuIG9ic2VydmVyOwp9OwoKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKCi8qanNoaW50IGJyb3dzZXI6dHJ1ZSwgc21hcnR0YWJzOnRydWUqLwoKLy8gdGJfcmVxdWlyZSgnLi4vaGVscGVycy5qcycpCi8vIHRiX3JlcXVpcmUoJy4vZG9tLmpzJykKCihmdW5jdGlvbih3aW5kb3csIE9USGVscGVycywgdW5kZWZpbmVkKSB7CgpPVEhlbHBlcnMuTW9kYWwgPSBmdW5jdGlvbih0aXRsZSwgYm9keSkgewogICAgLypqc2hpbnQgbXVsdGlzdHI6dHJ1ZSovCiAgICB2YXIgdG1wbCA9ICJcCiAgICAgICAgPGhlYWRlcj5cCiAgICAgICAgICAgIDxoMT48JT0gdGl0bGUgJT48L2gxPlwKICAgICAgICA8L2hlYWRlcj5cCiAgICAgICAgPGRpdiBjbGFzcz0nT1RfZGlhbG9nLWJvZHknPlwKICAgICAgICAgICAgPCU9IGJvZHkgJT5cCiAgICAgICAgPC9kaXY+XAogICAgIjsKCiAgICB0aGlzLmVsID0gT1RIZWxwZXJzLmNyZWF0ZUVsZW1lbnQoInNlY3Rpb24iLCB7CiAgICAgICAgICAgIGNsYXNzTmFtZTogIk9UX3Jvb3QgT1RfZGlhbG9nIE9UX21vZGFsIgogICAgICAgIH0sCiAgICAgICAgT1RIZWxwZXJzLnRlbXBsYXRlKHRtcGwsIHsKICAgICAgICAgICAgdGl0bGU6IHRpdGxlLAogICAgICAgICAgICBib2R5OiBib2R5CiAgICAgICAgfSkKICAgICk7CgogICAgLy8gV2UncmUgZ29pbmcgdG8gY2VudGVyIHRoZSBlbGVtZW50IGluIHRoZSB3aW5kb3cuIFdlIG5lZWQgdG8gYWRkIHRoZQogICAgLy8gZWxlbWVudCB0byB0aGUgYm9keSBiZWZvcmUgd2UgZG8sIG90aGVyd2lzZSB3ZSBjYW4ndCBjYWxjdWxhdGUgdGhlIGRpYWxvZydzCiAgICAvLyB3aWR0aHMgYW5kIGhlaWdodHMuIFRoaXMgbWVhbnMgd2UgbmVlZCB0byBoaWRlIHRoZSBlbGVtZW50IGZpcnN0LgogICAgdGhpcy5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmVsKTsKICAgIE9USGVscGVycy5jZW50ZXJFbGVtZW50KHRoaXMuZWwpOwogICAgT1RIZWxwZXJzLnNob3codGhpcy5lbCk7CgogICAgdGhpcy5jbG9zZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIE9USGVscGVycy5yZW1vdmVFbGVtZW50KHRoaXMuZWwpOwogICAgICAgIHRoaXMuZWwgPSBudWxsOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKfTsKCi8vIEN1c3RvbSBhbGVydCBkaWFsb2cKT1RIZWxwZXJzLnRiQWxlcnQgPSBmdW5jdGlvbih0aXRsZSwgbWVzc2FnZSkgewogICAgdmFyIG1vZGFsID0gbmV3IE9USGVscGVycy5Nb2RhbCh0aXRsZSwgIjxkaXY+IiArIG1lc3NhZ2UgKyAiPC9kaXY+Iik7CiAgICBPVEhlbHBlcnMuYWRkQ2xhc3MobW9kYWwuZWwsICJPVF90YmFsZXJ0Iik7CgogICAgdmFyIGNsb3NlQnRuID0gT1RIZWxwZXJzLmNyZWF0ZUVsZW1lbnQoImlucHV0IiwgewogICAgICAgICAgICBjbGFzc05hbWU6ICJPVF9jbG9zZUJ1dHRvbiIsCiAgICAgICAgICAgIHR5cGU6ICJidXR0b24iLAogICAgICAgICAgICB2YWx1ZTogImNsb3NlIgogICAgfSk7CiAgICBtb2RhbC5lbC5hcHBlbmRDaGlsZChjbG9zZUJ0bik7CgogICAgY2xvc2VCdG4ub25jbGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChtb2RhbCkgbW9kYWwuY2xvc2UoKTsKICAgICAgICBtb2RhbCA9IG51bGw7CiAgICB9Owp9OwoKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKCi8vIERPTSBBdHRyaWJ1dGUgaGVscGVycyBoZWxwZXJzCgovKmpzaGludCBicm93c2VyOnRydWUsIHNtYXJ0dGFiczp0cnVlKi8KCi8vIHRiX3JlcXVpcmUoJy4uL2hlbHBlcnMuanMnKQovLyB0Yl9yZXF1aXJlKCcuL2RvbS5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKT1RIZWxwZXJzLmFkZENsYXNzID0gZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgIC8vIE9ubHkgYm90aGVyIHRhcmdldGluZyBFbGVtZW50IG5vZGVzLCBpZ25vcmUgVGV4dCBOb2RlcywgQ0RBVEEsIGV0YwogICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNsYXNzTmFtZXMgPSB2YWx1ZS50cmltKCkuc3BsaXQoL1xzKy8pLAogICAgICAgIGksIGw7CgogICAgaWYgKE9USGVscGVycy5zdXBwb3J0c0NsYXNzTGlzdCgpKSB7CiAgICAgICAgZm9yIChpPTAsIGw9Y2xhc3NOYW1lcy5sZW5ndGg7IGk8bDsgKytpKSB7CiAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbGFzc05hbWVzW2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBIZXJlJ3Mgb3VyIGZhbGxiYWNrIHRvIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBlbGVtZW50LmNsYXNzTGlzdAoKICAgIGlmICghZWxlbWVudC5jbGFzc05hbWUgJiYgY2xhc3NOYW1lcy5sZW5ndGggPT09IDEpIHsKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IHZhbHVlOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdmFyIHNldENsYXNzID0gIiAiICsgZWxlbWVudC5jbGFzc05hbWUgKyAiICI7CgogICAgICAgIGZvciAoaT0wLCBsPWNsYXNzTmFtZXMubGVuZ3RoOyBpPGw7ICsraSkgewogICAgICAgICAgICBpZiAoICF+c2V0Q2xhc3MuaW5kZXhPZiggIiAiICsgY2xhc3NOYW1lc1tpXSArICIgIikpIHsKICAgICAgICAgICAgICAgIHNldENsYXNzICs9IGNsYXNzTmFtZXNbaV0gKyAiICI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gc2V0Q2xhc3MudHJpbSgpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwp9OwoKT1RIZWxwZXJzLnJlbW92ZUNsYXNzID0gZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgIGlmICghdmFsdWUpIHJldHVybjsKCiAgICAvLyBPbmx5IGJvdGhlciB0YXJnZXRpbmcgRWxlbWVudCBub2RlcywgaWdub3JlIFRleHQgTm9kZXMsIENEQVRBLCBldGMKICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBuZXdDbGFzc2VzID0gdmFsdWUudHJpbSgpLnNwbGl0KC9ccysvKSwKICAgICAgICBpLCBsOwoKICAgIGlmIChPVEhlbHBlcnMuc3VwcG9ydHNDbGFzc0xpc3QoKSkgewogICAgICAgIGZvciAoaT0wLCBsPW5ld0NsYXNzZXMubGVuZ3RoOyBpPGw7ICsraSkgewogICAgICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUobmV3Q2xhc3Nlc1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNsYXNzTmFtZSA9ICgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikucmVwbGFjZSgvW1xzK10vLCAnICcpOwoKICAgIGZvciAoaT0wLGw9bmV3Q2xhc3Nlcy5sZW5ndGg7IGk8bDsgKytpKSB7CiAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UoJyAnICsgbmV3Q2xhc3Nlc1tpXSArICcgJywgJyAnKTsKICAgIH0KCiAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsYXNzTmFtZS50cmltKCk7CgogICAgcmV0dXJuIHRoaXM7Cn07CgoKLyoqCiAqIE1ldGhvZHMgdG8gY2FsY3VsYXRlIGVsZW1lbnQgd2lkdGhzIGFuZCBoZWlnaHRzLgogKi8KCnZhciBfd2lkdGggPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgaWYgKGVsZW1lbnQub2Zmc2V0V2lkdGggPiAwKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm9mZnNldFdpZHRoICsgJ3B4JzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBPVEhlbHBlcnMuY3NzKGVsZW1lbnQsICd3aWR0aCcpOwogICAgfSwKCiAgICBfaGVpZ2h0ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIGlmIChlbGVtZW50Lm9mZnNldEhlaWdodCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQub2Zmc2V0SGVpZ2h0ICsgJ3B4JzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBPVEhlbHBlcnMuY3NzKGVsZW1lbnQsICdoZWlnaHQnKTsKICAgIH07CgpPVEhlbHBlcnMud2lkdGggPSBmdW5jdGlvbihlbGVtZW50LCBuZXdXaWR0aCkgewogICAgaWYgKG5ld1dpZHRoKSB7CiAgICAgICAgT1RIZWxwZXJzLmNzcyhlbGVtZW50LCAnd2lkdGgnLCBuZXdXaWR0aCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAoT1RIZWxwZXJzLmlzRGlzcGxheU5vbmUoZWxlbWVudCkpIHsKICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZ2V0IHRoZSB3aWR0aCwgcHJvYmFibHkgc2luY2UgdGhlIGVsZW1lbnQgaXMgaGlkZGVuLgogICAgICAgICAgICByZXR1cm4gT1RIZWxwZXJzLm1ha2VWaXNpYmxlQW5kWWllbGQoZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3dpZHRoKGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBfd2lkdGgoZWxlbWVudCk7CiAgICAgICAgfQogICAgfQp9OwoKT1RIZWxwZXJzLmhlaWdodCA9IGZ1bmN0aW9uKGVsZW1lbnQsIG5ld0hlaWdodCkgewogICAgaWYgKG5ld0hlaWdodCkgewogICAgICAgIE9USGVscGVycy5jc3MoZWxlbWVudCwgJ2hlaWdodCcsIG5ld0hlaWdodCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAoT1RIZWxwZXJzLmlzRGlzcGxheU5vbmUoZWxlbWVudCkpIHsKICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZ2V0IHRoZSBoZWlnaHQsIHByb2JhYmx5IHNpbmNlIHRoZSBlbGVtZW50IGlzIGhpZGRlbi4KICAgICAgICAgICAgcmV0dXJuIE9USGVscGVycy5tYWtlVmlzaWJsZUFuZFlpZWxkKGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF9oZWlnaHQoZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIF9oZWlnaHQoZWxlbWVudCk7CiAgICAgICAgfQogICAgfQp9OwoKLy8gQ2VudGVycyArZWxlbWVudCsgd2l0aGluIHRoZSB3aW5kb3cuIFlvdSBjYW4gcGFzcyB0aHJvdWdoIHRoZSB3aWR0aCBhbmQgaGVpZ2h0Ci8vIGlmIHlvdSBrbm93IGl0LCBpZiB5b3UgZG9uJ3QgdGhleSB3aWxsIGJlIGNhbGN1bGF0ZWQgZm9yIHlvdS4KT1RIZWxwZXJzLmNlbnRlckVsZW1lbnQgPSBmdW5jdGlvbihlbGVtZW50LCB3aWR0aCwgaGVpZ2h0KSB7CiAgICBpZiAoIXdpZHRoKSB3aWR0aCA9IHBhcnNlSW50KE9USGVscGVycy53aWR0aChlbGVtZW50KSwgMTApOwogICAgaWYgKCFoZWlnaHQpIGhlaWdodCA9IHBhcnNlSW50KE9USGVscGVycy5oZWlnaHQoZWxlbWVudCksIDEwKTsKCiAgICB2YXIgbWFyZ2luTGVmdCA9IC0wLjUgKiB3aWR0aCArICJweCI7CiAgICB2YXIgbWFyZ2luVG9wID0gLTAuNSAqIGhlaWdodCArICJweCI7CiAgICBPVEhlbHBlcnMuY3NzKGVsZW1lbnQsICJtYXJnaW4iLCBtYXJnaW5Ub3AgKyAiIDAgMCAiICsgbWFyZ2luTGVmdCk7CiAgICBPVEhlbHBlcnMuYWRkQ2xhc3MoZWxlbWVudCwgIk9UX2NlbnRlcmVkIik7Cn07Cgp9KSh3aW5kb3csIHdpbmRvdy5PVEhlbHBlcnMpOwovLyBDU1MgaGVscGVycyBoZWxwZXJzCgovKmpzaGludCBicm93c2VyOnRydWUsIHNtYXJ0dGFiczp0cnVlKi8KCi8vIHRiX3JlcXVpcmUoJy4uL2hlbHBlcnMuanMnKQovLyB0Yl9yZXF1aXJlKCcuL2RvbS5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKdmFyIGRpc3BsYXlTdGF0ZUNhY2hlID0ge30sCiAgICBkZWZhdWx0RGlzcGxheXMgPSB7fTsKCnZhciBkZWZhdWx0RGlzcGxheVZhbHVlRm9yRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGlmIChkZWZhdWx0RGlzcGxheXNbZWxlbWVudC5vd25lckRvY3VtZW50XSAmJiBkZWZhdWx0RGlzcGxheXNbZWxlbWVudC5vd25lckRvY3VtZW50XVtlbGVtZW50Lm5vZGVOYW1lXSkgewogICAgICAgIHJldHVybiBkZWZhdWx0RGlzcGxheXNbZWxlbWVudC5vd25lckRvY3VtZW50XVtlbGVtZW50Lm5vZGVOYW1lXTsKICAgIH0KCiAgICBpZiAoIWRlZmF1bHREaXNwbGF5c1tlbGVtZW50Lm93bmVyRG9jdW1lbnRdKSBkZWZhdWx0RGlzcGxheXNbZWxlbWVudC5vd25lckRvY3VtZW50XSA9IHt9OwoKICAgIC8vIFdlIG5lZWQgdG8ga25vdyB3aGF0IGRpc3BsYXkgdmFsdWUgdG8gdXNlIGZvciB0aGlzIG5vZGUuIFRoZSBlYXNpZXN0IHdheQogICAgLy8gaXMgdG8gYWN0dWFsbHkgY3JlYXRlIGEgbm9kZSBhbmQgcmVhZCBpdCBvdXQuCiAgICB2YXIgdGVzdE5vZGUgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChlbGVtZW50Lm5vZGVOYW1lKSwKICAgICAgICBkZWZhdWx0RGlzcGxheTsKCiAgICBlbGVtZW50Lm93bmVyRG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZXN0Tm9kZSk7CiAgICBkZWZhdWx0RGlzcGxheSA9IGRlZmF1bHREaXNwbGF5c1tlbGVtZW50Lm93bmVyRG9jdW1lbnRdW2VsZW1lbnQubm9kZU5hbWVdID0gT1RIZWxwZXJzLmNzcyh0ZXN0Tm9kZSwgJ2Rpc3BsYXknKTsKCiAgICBPVEhlbHBlcnMucmVtb3ZlRWxlbWVudCh0ZXN0Tm9kZSk7CiAgICB0ZXN0Tm9kZSA9IG51bGw7CgogICAgcmV0dXJuIGRlZmF1bHREaXNwbGF5Owp9OwoKdmFyIGlzSGlkZGVuID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIGNvbXB1dGVkU3R5bGUgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCBudWxsKTsKICAgIHJldHVybiBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2Rpc3BsYXknKSA9PT0gJ25vbmUnOwp9OwoKT1RIZWxwZXJzLnNob3cgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgZGlzcGxheSA9IGVsZW1lbnQuc3R5bGUuZGlzcGxheTsKICAgICAgICAvLywKICAgICAgICAvLyBjb21wdXRlZFN0eWxlID0gZWxlbWVudC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCksCiAgICAgICAgLy8gY29tcHV0ZWREaXNwbGF5ID0gY29tcHV0ZWRTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCdkaXNwbGF5Jyk7CgogICAgaWYgKGRpc3BsYXkgPT09ICcnIHx8IGRpc3BsYXkgPT09ICdub25lJykgewogICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXlTdGF0ZUNhY2hlW2VsZW1lbnRdIHx8ICcnOwogICAgICAgIGRlbGV0ZSBkaXNwbGF5U3RhdGVDYWNoZVtlbGVtZW50XTsKICAgIH0KCiAgICBpZiAoaXNIaWRkZW4oZWxlbWVudCkpIHsKICAgICAgICAvLyBJdCdzIHN0aWxsIGhpZGRlbiBzbyB0aGVyZSdzIHByb2JhYmx5IGEgc3R5bGVzaGVldCB0aGF0IGRlY2xhcmVzIHRoaXMKICAgICAgICAvLyBlbGVtZW50IGFzIGRpc3BsYXk6bm9uZTsKICAgICAgICBkaXNwbGF5U3RhdGVDYWNoZVtlbGVtZW50XSA9ICdub25lJzsKCiAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gZGVmYXVsdERpc3BsYXlWYWx1ZUZvckVsZW1lbnQoZWxlbWVudCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cn07CgpPVEhlbHBlcnMuaGlkZSA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGlmIChlbGVtZW50LnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgcmV0dXJuOwoKICAgIGRpc3BsYXlTdGF0ZUNhY2hlW2VsZW1lbnRdID0gZWxlbWVudC5zdHlsZS5kaXNwbGF5OwogICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgIHJldHVybiB0aGlzOwp9OwoKT1RIZWxwZXJzLmNzcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWVPckhhc2gsIHZhbHVlKSB7CiAgICBpZiAodHlwZW9mKG5hbWVPckhhc2gpICE9PSAnc3RyaW5nJykgewogICAgICAgIHZhciBzdHlsZSA9IGVsZW1lbnQuc3R5bGU7CgogICAgICAgIGZvciAodmFyIGNzc05hbWUgaW4gbmFtZU9ySGFzaCkgewogICAgICAgICAgICBzdHlsZVtjc3NOYW1lXSA9IG5hbWVPckhhc2hbY3NzTmFtZV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGVsc2UgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBlbGVtZW50LnN0eWxlW25hbWVPckhhc2hdID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICAvLyBOb3JtYWxpc2UgdmVuZG9yIHByZWZpeGVzIGZyb20gdGhlIGZvcm0gTW96VHJhbmZvcm0gdG8gLW1vei10cmFuc2Zvcm0KICAgICAgICAvLyBleGNlcHQgZm9yIG1zIGV4dGVuc2lvbnMsIHdoaWNoIGFyZSB3ZWlyZC4uLgogICAgICAgIHZhciBuYW1lID0gbmFtZU9ySGFzaC5yZXBsYWNlKCAvKFtBLVpdfF5tcykvZywgIi0kMSIgKS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICBjb21wdXRlZFN0eWxlID0gZWxlbWVudC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCksCiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKTsKCiAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PT0gJycpIHsKICAgICAgICAgICAgY3VycmVudFZhbHVlID0gZWxlbWVudC5zdHlsZVtuYW1lXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICB9Cn07CgoKLy8gQXBwbHkgK3N0eWxlcysgdG8gK2VsZW1lbnQrIHdoaWxlIGV4ZWN1dGluZyArY2FsbGJhY2srLCByZXN0b3JpbmcgdGhlIHByZXZpb3VzCi8vIHN0eWxlcyBhZnRlciB0aGUgY2FsbGJhY2sgZXhlY3V0ZXMuCk9USGVscGVycy5hcHBseUNTUyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0eWxlcywgY2FsbGJhY2spIHsKICAgIHZhciBvbGRTdHlsZXMgPSB7fSwKICAgICAgICBuYW1lLAogICAgICAgIHJldDsKCiAgICAvLyBCYWNrdXAgdGhlIG9sZCBzdHlsZXMKICAgIGZvciAobmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICBpZiAoc3R5bGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIC8vIFdlIGludGVudGlvbmFsbHkgcmVhZCBvdXQgb2Ygc3R5bGUgaGVyZSwgaW5zdGVhZCBvZiB1c2luZyB0aGUgY3NzCiAgICAgICAgICAgIC8vIGhlbHBlci4gVGhpcyBpcyBiZWNhdXNlIHRoZSBjc3MgaGVscGVyIHVzZXMgcXVlcnlTZWxlY3RvciBhbmQgd2UKICAgICAgICAgICAgLy8gb25seSB3YW50IHRvIHB1bGwgdmFsdWVzIG91dCBvZiB0aGUgc3R5bGUgKGRvbWVFbGVtZW50LnN0eWxlKSBoYXNoLgogICAgICAgICAgICBvbGRTdHlsZXNbbmFtZV0gPSBlbGVtZW50LnN0eWxlW25hbWVdOwoKICAgICAgICAgICAgT1RIZWxwZXJzLmNzcyhlbGVtZW50LCBuYW1lLCBzdHlsZXNbbmFtZV0pOwogICAgICAgIH0KICAgIH0KCiAgICByZXQgPSBjYWxsYmFjaygpOwoKICAgIC8vIFJlc3RvcmUgdGhlIG9sZCBzdHlsZXMKICAgIGZvciAobmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICBpZiAoc3R5bGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIE9USGVscGVycy5jc3MoZWxlbWVudCwgbmFtZSwgb2xkU3R5bGVzW25hbWVdIHx8ICcnKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJldDsKfTsKCi8vIE1ha2UgK2VsZW1lbnQrIHZpc2libGUgd2hpbGUgZXhlY3V0aW5nICtjYWxsYmFjaysuCk9USGVscGVycy5tYWtlVmlzaWJsZUFuZFlpZWxkID0gZnVuY3Rpb24oZWxlbWVudCwgY2FsbGJhY2spIHsKICAgIC8vIGZpbmQgd2hldGhlciBpdCdzIHRoZSBlbGVtZW50IG9yIGFuIGFuY2VzdGVyIHRoYXQncyBkaXNwbGF5IG5vbmUgYW5kCiAgICAvLyB0aGVuIGFwcGx5IHRvIHdoaWNoZXZlciBpdCBpcwogICAgdmFyIHRhcmdldEVsZW1lbnQgPSBPVEhlbHBlcnMuZmluZEVsZW1lbnRXaXRoRGlzcGxheU5vbmUoZWxlbWVudCk7CiAgICBpZiAoIXRhcmdldEVsZW1lbnQpIHJldHVybjsKCiAgICByZXR1cm4gT1RIZWxwZXJzLmFwcGx5Q1NTKHRhcmdldEVsZW1lbnQsIHsKICAgICAgICAgICAgZGlzcGxheTogImJsb2NrIiwKICAgICAgICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIKICAgICAgICB9LAogICAgICAgIGNhbGxiYWNrCiAgICApOwp9OwoKfSkod2luZG93LCB3aW5kb3cuT1RIZWxwZXJzKTsKLy8gQUpBWCBoZWxwZXJzCgovKmpzaGludCBicm93c2VyOnRydWUsIHNtYXJ0dGFiczp0cnVlKi8KCi8vIHRiX3JlcXVpcmUoJy4uL2hlbHBlcnMuanMnKQovLyB0Yl9yZXF1aXJlKCcuL3htbC5qcycpCgooZnVuY3Rpb24od2luZG93LCBPVEhlbHBlcnMsIHVuZGVmaW5lZCkgewoKZnVuY3Rpb24gZm9ybWF0UG9zdERhdGEoZGF0YSkgeyAvLywgY29udGVudFR5cGUKICAgIC8vIElmIGl0J3MgYSBzdHJpbmcsIHdlIGFzc3VtZSBpdCdzIHByb3Blcmx5IGVuY29kZWQKICAgIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSByZXR1cm4gZGF0YTsKCiAgICB2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCiAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgIHF1ZXJ5U3RyaW5nLnB1c2goCiAgICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRhdGFba2V5XSkKICAgICAgICApOwogICAgfQoKICAgIHJldHVybiBxdWVyeVN0cmluZy5qb2luKCcmJykucmVwbGFjZSgvXCsvZywgIiUyMCIpOwp9CgpPVEhlbHBlcnMuZ2V0WE1MID0gZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICB2YXIgY2FsbGVyU3VjY2Vzc0NiID0gb3B0aW9ucyAmJiBvcHRpb25zLnN1Y2Nlc3MsCgogICAgICAgIGlzVmFsaWRYTUxEb2N1bWVudCA9IGZ1bmN0aW9uKHhtbERvY3VtZW50KSB7CiAgICAgICAgICAgIHZhciByb290OwoKICAgICAgICAgICAgaWYgKCF4bWxEb2N1bWVudCkgewogICAgICAgICAgICAgICAgLy8gQmFkbHkgZm9ybWVkIFhNTAogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBnb3Qgc29tZSBYTUwgYmFjaywgYXR0ZW1wdCB0byBpbmZlciBpZiB0aGUgWE1MIGlzIGJhZGx5IGZvcm1lZAogICAgICAgICAgICByb290ID0geG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgICAgaWYgKCFyb290IHx8ICFyb290Lm5vZGVOYW1lIHx8IHJvb3Qubm9kZU5hbWUgPT09ICJwYXJzZXJlcnJvciIpIHsKICAgICAgICAgICAgICAgIC8vIEJhZGx5IGZvcm1lZCBYTUwKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgb25TdWNjZXNzID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0gZXZlbnQudGFyZ2V0LnJlc3BvbnNlWE1MOwoKICAgICAgICAgICAgaWYgKGlzVmFsaWRYTUxEb2N1bWVudChyZXNwb25zZSkpIHsKICAgICAgICAgICAgICAgIGlmIChjYWxsZXJTdWNjZXNzQ2IpIGNhbGxlclN1Y2Nlc3NDYihyZXNwb25zZSwgZXZlbnQsIGV2ZW50LnRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmVycm9yKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmVycm9yKGV2ZW50LCBldmVudC50YXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICB2YXIgZXh0ZW5kZWRIZWFkZXJzID0gT1RIZWxwZXJzLmV4dGVuZChvcHRpb25zLmhlYWRlcnMgfHwge30sIHsKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94bWwnCiAgICAgICAgfSk7CgogICAgT1RIZWxwZXJzLmdldCh1cmwsIE9USGVscGVycy5leHRlbmQob3B0aW9ucyB8fCB7fSwgewogICAgICAgIHN1Y2Nlc3M6IG9uU3VjY2VzcywKICAgICAgICBoZWFkZXJzOiBleHRlbmRlZEhlYWRlcnMKICAgIH0pKTsKfTsKCk9USGVscGVycy5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICB2YXIgY2FsbGVyU3VjY2Vzc0NiID0gb3B0aW9ucyAmJiBvcHRpb25zLnN1Y2Nlc3MsCiAgICAgICAgb25TdWNjZXNzID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIHJlc3BvbnNlOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gSlNPTi5wYXJzZShldmVudC50YXJnZXQucmVzcG9uc2VUZXh0KTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAvLyBCYWRseSBmb3JtZWQgSlNPTgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lcnJvcikgb3B0aW9ucy5lcnJvcihldmVudCwgZXZlbnQudGFyZ2V0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNhbGxlclN1Y2Nlc3NDYikgY2FsbGVyU3VjY2Vzc0NiKHJlc3BvbnNlLCBldmVudCwgZXZlbnQudGFyZ2V0KTsKICAgICAgICB9OwoKICAgIE9USGVscGVycy5nZXQodXJsLCBPVEhlbHBlcnMuZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsKICAgICAgICBzdWNjZXNzOiBvblN1Y2Nlc3MsCiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nCiAgICAgICAgfQogICAgfSkpOwp9OwoKT1RIZWxwZXJzLmdldCA9IGZ1bmN0aW9uKHVybCwgb3B0aW9ucykgewogICAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKSwKICAgICAgICBfb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgYmluZFRvU3VjY2Vzc0FuZEVycm9yQ2FsbGJhY2tzKHJlcXVlc3QsIF9vcHRpb25zLnN1Y2Nlc3MsIF9vcHRpb25zLmVycm9yKTsKICAgIGlmIChfb3B0aW9ucy5wcm9jZXNzKSByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoInByb2dyZXNzIiwgX29wdGlvbnMucHJvZ3Jlc3MsIGZhbHNlKTsKICAgIGlmIChfb3B0aW9ucy5jYW5jZWxsZWQpIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBfb3B0aW9ucy5jYW5jZWxsZWQsIGZhbHNlKTsKCgogICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB1cmwsIHRydWUpOwoKICAgIGlmICghX29wdGlvbnMuaGVhZGVycykgX29wdGlvbnMuaGVhZGVycyA9IHt9OwoKICAgIGZvciAodmFyIG5hbWUgaW4gX29wdGlvbnMuaGVhZGVycykgewogICAgICAgIHJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcihuYW1lLCBfb3B0aW9ucy5oZWFkZXJzW25hbWVdKTsKICAgIH0KCiAgICByZXF1ZXN0LnNlbmQoKTsKfTsKCk9USGVscGVycy5wb3N0ID0gZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpLAogICAgICAgIF9vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBiaW5kVG9TdWNjZXNzQW5kRXJyb3JDYWxsYmFja3MocmVxdWVzdCwgX29wdGlvbnMuc3VjY2VzcywgX29wdGlvbnMuZXJyb3IpOwoKICAgIGlmIChfb3B0aW9ucy5wcm9jZXNzKSByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoInByb2dyZXNzIiwgX29wdGlvbnMucHJvZ3Jlc3MsIGZhbHNlKTsKICAgIGlmIChfb3B0aW9ucy5jYW5jZWxsZWQpIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBfb3B0aW9ucy5jYW5jZWxsZWQsIGZhbHNlKTsKCiAgICByZXF1ZXN0Lm9wZW4oJ1BPU1QnLCB1cmwsIHRydWUpOwoKICAgIGlmICghX29wdGlvbnMuaGVhZGVycykgX29wdGlvbnMuaGVhZGVycyA9IHt9OwoKICAgIGZvciAodmFyIG5hbWUgaW4gX29wdGlvbnMuaGVhZGVycykgewogICAgICAgIHJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcihuYW1lLCBfb3B0aW9ucy5oZWFkZXJzW25hbWVdKTsKICAgIH0KCiAgICByZXF1ZXN0LnNlbmQoZm9ybWF0UG9zdERhdGEoX29wdGlvbnMuZGF0YSkpOwp9OwoKT1RIZWxwZXJzLnBvc3RGb3JtRGF0YSA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgb3B0aW9ucykgewogICAgaWYgKCFkYXRhKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPVEhlbHBlcnMucG9zdEZvcm1EYXRhIG11c3QgYmUgcGFzc2VkIGEgZGF0YSBvcHRpb25zLiIpOwogICAgfQoKICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpOwoKICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgZm9ybURhdGEuYXBwZW5kKGtleSwgZGF0YVtrZXldKTsKICAgIH0KCiAgICBPVEhlbHBlcnMucG9zdCh1cmwsIE9USGVscGVycy5leHRlbmQob3B0aW9ucyB8fCB7fSwgewogICAgICAgIGRhdGE6IGZvcm1EYXRhCiAgICB9KSk7Cn07CgoKLy8gTWFrZSBhIEdFVCByZXF1ZXN0IHZpYSBKU09OUC4KLy8KLy8gQGV4YW1wbGUgTWFrZSBhIHJlcXVlc3QgdG8gJ2h0dHA6Ly90b2tib3guY29tOjk5OTkvc2Vzc2lvbi9mb28nIHdpdGggc3VjY2VzcyBhbmQgZXJyb3IgY2FsbGJhY2tzCi8vCi8vICBPVEhlbHBlcnMuZ2V0SlNPTlAoJ2h0dHA6Ly90b2tib3guY29tOjk5OTkvc2Vzc2lvbi9mb28nLCB7Ci8vICAgICAgc3VjY2Vzczogc3VjY2Vzc0NhbGxiYWNrLAovLyAgICAgIGVycm9yOiBlcnJvckNhbGxiYWNrCi8vICB9KTsKLy8KT1RIZWxwZXJzLmdldEpTT05QID0gZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICB2YXIgX2xvYWRUaW1lb3V0ID0gMzAwMDAsCiAgICAgICAgX3NjcmlwdCwKICAgICAgICBfaGVhZCA9IGRvY3VtZW50LmhlYWQgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXSwKICAgICAgICBfd2FpdFVudGlsVGltZW91dCwKICAgICAgICBfdXJsV2l0aENhbGxiYWNrID0gdXJsLAogICAgICAgIF9vcHRpb25zID0gT1RIZWxwZXJzLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7CiAgICAgICAgICAgIGNhbGxiYWNrUGFyYW1ldGVyOiAnY2FsbGJhY2snCiAgICAgICAgfSksCgogICAgICAgIF9jbGVhclRpbWVvdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF93YWl0VW50aWxUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoX3dhaXRVbnRpbFRpbWVvdXQpOwogICAgICAgICAgICAgICAgX3dhaXRVbnRpbFRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NsZWFudXAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2NsZWFyVGltZW91dCgpOwoKICAgICAgICAgICAgaWYgKF9zY3JpcHQpIHsKICAgICAgICAgICAgICAgIF9zY3JpcHQub25sb2FkID0gX3NjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKICAgICAgICAgICAgICAgIE9USGVscGVycy5yZW1vdmVFbGVtZW50KCBfc2NyaXB0ICk7CgogICAgICAgICAgICAgICAgX3NjcmlwdCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9vbkxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF9zY3JpcHQucmVhZHlTdGF0ZSAmJiAhL2xvYWRlZHxjb21wbGV0ZS8udGVzdCggX3NjcmlwdC5yZWFkeVN0YXRlICkpIHsKICAgICAgICAgICAgICAgIC8vIFllYWgsIHdlJ3JlIG5vdCByZWFkeSB5ZXQuLi4KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NsZWFyVGltZW91dCgpOwogICAgICAgIH0sCgogICAgICAgIF9vbkxvYWRUaW1lb3V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIF9jbGVhbnVwKCk7CgogICAgICAgICAgICBPVEhlbHBlcnMuZXJyb3IoIlRoZSBKU09OUCByZXF1ZXN0IHRvICIgKyBfdXJsV2l0aENhbGxiYWNrICsgIiB0aW1lZCBvdXQgYWZ0ZXIgIiArIF9sb2FkVGltZW91dCArICJtcy4iKTsKICAgICAgICAgICAgaWYgKF9vcHRpb25zLmVycm9yKSBfb3B0aW9ucy5lcnJvcigiVGhlIEpTT05QIHJlcXVlc3QgdG8gIiArIHVybCArICIgdGltZWQgb3V0IGFmdGVyICIgKyBfbG9hZFRpbWVvdXQgKyAibXMuIiwgX3VybFdpdGhDYWxsYmFjaywgIF9vcHRpb25zKTsKICAgICAgICB9LAoKICAgICAgICBfZ2VuZXJhdGVDYWxsYmFja05hbWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICdqc29ucF9jYWxsYmFja18nICsgKCtuZXcgRGF0ZSgpKTsKICAgICAgICB9OwoKCiAgICBfb3B0aW9ucy5jYWxsYmFja05hbWUgPSBfZ2VuZXJhdGVDYWxsYmFja05hbWUoKTsKICAgIHRoaXMuanNvbnBfY2FsbGJhY2tzW19vcHRpb25zLmNhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgIF9jbGVhbnVwKCk7CgogICAgICAgIGlmIChfb3B0aW9ucy5zdWNjZXNzKSBfb3B0aW9ucy5zdWNjZXNzKHJlc3BvbnNlKTsKICAgIH07CgogICAgLy8gVGhpcyBkb2Vzbid0IGhhbmRsZSBVUkxzIGxpa2UgImh0dHA6Ly93d3cuZ29vZ2xlLmNvbT9ibGFoPTEjc29tZXRoaW5nIi4gVGhlIGNhbGxiYWNrIG5hbWUKICAgIC8vIHdpbGwgYmUgaW5jb3JyZWN0bHkgYXBwZW5kZWQgYWZ0ZXIgdGhlICMuCiAgICBfdXJsV2l0aENhbGxiYWNrICs9ICgoL1w/LykudGVzdChfdXJsV2l0aENhbGxiYWNrKSA/ICImIiA6ICI/IikgKyBfb3B0aW9ucy5jYWxsYmFja1BhcmFtZXRlciArICc9JyArIF9vcHRpb25zLmNhbGxiYWNrTmFtZTsKCiAgICBfc2NyaXB0ID0gT1RIZWxwZXJzLmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcsIHsKICAgICAgICBhc3luYzogJ2FzeW5jJywKICAgICAgICBzcmM6IF91cmxXaXRoQ2FsbGJhY2ssCiAgICAgICAgb25sb2FkOiBfb25Mb2FkLAogICAgICAgIG9ucmVhZHlzdGF0ZWNoYW5nZTogX29uTG9hZAogICAgfSk7CiAgICBfaGVhZC5hcHBlbmRDaGlsZChfc2NyaXB0KTsKCiAgICBfd2FpdFVudGlsVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IF9vbkxvYWRUaW1lb3V0KCk7IH0sIF9sb2FkVGltZW91dCk7Cn07CgovLyBQcml2YXRlIGhlbHBlciBtZXRob2QgdXNlZCAoYnkgT1RIZWxwZXJzLmdldCBhbmQgT1RIZWxwZXJzLnBvc3QgYW1vbmcgb3RoZXJzKSB0byBzZXR1cAovLyBjYWxsYmFja3MgdG8gY29ycmVjdGx5IHJlc3BvbmQgdG8gc3VjY2VzcyBhbmQgZXJyb3IgY2FsbGJhY2tzLiBUaGlzIGluY2x1ZGVzCi8vIGludGVycHJldGluZyB0aGUgcmVzcG9uc2VzIEhUVFAgc3RhdHVzLCB3aGljaCBYbWxIdHRwUmVxdWVzdCBzZWVtcyB0byBpZ25vcmUKLy8gYnkgZGVmYXVsdC4KdmFyIGJpbmRUb1N1Y2Nlc3NBbmRFcnJvckNhbGxiYWNrcyA9IGZ1bmN0aW9uKHJlcXVlc3QsIHN1Y2Nlc3MsIGVycm9yKSB7CiAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgIHZhciBzdGF0dXMgPSBldmVudC50YXJnZXQuc3RhdHVzOwoKICAgICAgICAvLyBXZSBuZWVkIHRvIGRldGVjdCB0aGluZ3MgdGhhdCBYTUxIdHRwUmVxdWVzdCBjb25zaWRlcnMgYSBzdWNjZXNzLAogICAgICAgIC8vIGJ1dCB3ZSBjb25zaWRlciB0byBiZSBmYWlsdXJlcy4KICAgICAgICBpZiAoIHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0ICkgewogICAgICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcy5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChlcnJvcikgewogICAgICAgICAgICBlcnJvcihldmVudCk7CiAgICAgICAgfQogICAgfSwgZmFsc2UpOwoKCiAgICBpZiAoZXJyb3IpIHsKICAgICAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgZXJyb3IsIGZhbHNlKTsKICAgIH0KfTsKCn0pKHdpbmRvdywgd2luZG93Lk9USGVscGVycyk7CiEoZnVuY3Rpb24od2luZG93KSB7CgppZiAoIXdpbmRvdy5PVCkgd2luZG93Lk9UID0ge307CgovLyBCcmluZyBPVEhlbHBlcnMgaW4gYXMgT1QuJApPVC4kID0gT1RIZWxwZXJzLm5vQ29uZmxpY3QoKTsKCi8vIEFsbG93IGV2ZW50cyB0byBiZSBib3VuZCBvbiBPVApPVC4kLmV2ZW50aW5nKE9UKTsKCi8vIE9ULiQuTW9kYWwgd2FzIE9ULk1vZGFsIGJlZm9yZSB0aGUgZ3JlYXQgY29tbW9uLWpzLWhlbHBlcnMgbW92ZQpPVC5Nb2RhbCA9IE9ULiQuTW9kYWw7CgovLyBBZGQgbG9nZ2luZyBtZXRob2RzCk9ULiQudXNlTG9nSGVscGVycyhPVCk7CnZhciBfZGVidWdIZWFkZXJMb2dnZWQgPSBmYWxzZTsKdmFyIF9zZXRMb2dMZXZlbCA9IE9ULnNldExvZ0xldmVsOwoKLy8gT24gdGhlIGZpcnN0IHRpbWUgbG9nIGxldmVsIGlzIHNldCB0byBERUJVRyAob3IgaGlnaGVyKSBzaG93IHZlcnNpb24gaW5mby4KT1Quc2V0TG9nTGV2ZWwgPSBmdW5jdGlvbihsZXZlbCkgewogICAgLy8gU2V0IE9ULiQgdG8gdGhlIHNhbWUgbG9nIGxldmVsCiAgICBPVC4kLnNldExvZ0xldmVsKGxldmVsKTsKICAgIHZhciByZXRWYWwgPSBfc2V0TG9nTGV2ZWwuY2FsbChPVCwgbGV2ZWwpOwogICAgaWYgKE9ULnNob3VsZExvZyhPVC5ERUJVRykgJiYgIV9kZWJ1Z0hlYWRlckxvZ2dlZCkgewogICAgICAgIE9ULmRlYnVnKCJPcGVuVG9rIEphdmFTY3JpcHQgbGlicmFyeSAiICsgT1QucHJvcGVydGllcy52ZXJzaW9uKTsKICAgICAgICBPVC5kZWJ1ZygiUmVsZWFzZSBub3RlczogIiArIE9ULnByb3BlcnRpZXMud2Vic2l0ZVVSTCAgKyIvb3BlbnRvay93ZWJydGMvZG9jcy9qcy9yZWxlYXNlLW5vdGVzLmh0bWwiKTsKICAgICAgICBPVC5kZWJ1ZygiS25vd24gaXNzdWVzOiAiICsgT1QucHJvcGVydGllcy53ZWJzaXRlVVJMICsgIi9vcGVudG9rL3dlYnJ0Yy9kb2NzL2pzL3JlbGVhc2Utbm90ZXMuaHRtbCNrbm93bklzc3VlcyIpOwogICAgICAgIF9kZWJ1Z0hlYWRlckxvZ2dlZCA9IHRydWU7CiAgICB9CiAgICBPVC5kZWJ1ZygiVEIuc2V0TG9nTGV2ZWwoIiArIHJldFZhbCArICIpIik7CiAgICByZXR1cm4gcmV0VmFsOwp9OwoKT1Quc2V0TG9nTGV2ZWwoT1QucHJvcGVydGllcy5kZWJ1ZyA/IE9ULkRFQlVHIDogT1QuRVJST1IpOwoKLyoqCiogU2V0cyB0aGUgQVBJIGxvZyBsZXZlbC4KKiA8cD4KKiBDYWxsaW5nIDxjb2RlPlRCLnNldExvZ0xldmVsKCk8L2NvZGU+IHNldHMgdGhlIGxvZyBsZXZlbCBmb3IgcnVudGltZSBsb2cgbWVzc2FnZXMgdGhhdCBhcmUgdGhlIE9wZW5Ub2sgbGlicmFyeSBnZW5lcmF0ZXMuCiogVGhlIGRlZmF1bHQgdmFsdWUgZm9yIHRoZSBsb2cgbGV2ZWwgaXMgPGNvZGU+VEIuRVJST1I8L2NvZGU+LgoqIDwvcD4KKiA8cD4KKiBUaGUgT3BlblRvayBKYXZhU2NyaXB0IGxpYnJhcnkgZGlzcGxheXMgbG9nIG1lc3NhZ2VzIGluIHRoZSBkZWJ1Z2dlciBjb25zb2xlIChzdWNoIGFzIEZpcmVidWcpLCBpZiBvbmUgZXhpc3RzLgoqIDwvcD4KKiA8cD4KKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgbG9ncyB0aGUgc2Vzc2lvbiBJRCB0byB0aGUgY29uc29sZSwgYnkgY2FsbGluZyA8Y29kZT5UQi5sb2coKTwvY29kZT4uIFRoZSBjb2RlIGFsc28gbG9ncwoqIGFuIGVycm9yIG1lc3NhZ2Ugd2hlbiBpdCBhdHRlbXB0cyB0byBwdWJsaXNoIGEgc3RyZWFtIGJlZm9yZSB0aGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhCiogPGNvZGU+c2Vzc2lvbkNvbm5lY3RlZDwvY29kZT4gZXZlbnQuCiogPC9wPgoqIDxwcmU+CiogVEIuc2V0TG9nTGV2ZWwoVEIuTE9HKTsKKiBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklkKTsKKiBUQi5sb2coc2Vzc2lvbklkKTsKKiBwdWJsaXNoZXIgPSBUQi5pbml0UHVibGlzaGVyKEFQSV9LRVksICJwdWJsaXNoQ29udGFpbmVyIik7Ciogc2Vzc2lvbi5wdWJsaXNoKHB1Ymxpc2hlcik7CiogPC9wcmU+CioKKiBAcGFyYW0ge051bWJlcn0gbG9nTGV2ZWwgVGhlIGRlZ3JlZSBvZiBsb2dnaW5nIGRlc2lyZWQgYnkgdGhlIGRldmVsb3BlcjoKKgoqIDxwPgoqIDx1bD4KKiAgIDxsaT4KKiAgICAgPGNvZGU+VEIuTk9ORTwvY29kZT4gJiMxNTE7IEFQSSBsb2dnaW5nIGlzIGRpc2FibGVkLgoqICAgPC9saT4KKiAgIDxsaT4KKiAgICAgPGNvZGU+VEIuRVJST1I8L2NvZGU+ICYjMTUxOyBMb2dnaW5nIG9mIGVycm9ycyBvbmx5LgoqICAgPC9saT4KKiAgIDxsaT4KKiAgICAgPGNvZGU+VEIuV0FSTjwvY29kZT4gJiMxNTE7IExvZ2dpbmcgb2Ygd2FybmluZ3MgYW5kIGVycm9ycy4KKiAgIDwvbGk+CiogICA8bGk+CiogICAgIDxjb2RlPlRCLklORk88L2NvZGU+ICYjMTUxOyBMb2dnaW5nIG9mIG90aGVyIHVzZWZ1bCBpbmZvcm1hdGlvbiwgaW4gYWRkaXRpb24gdG8gd2FybmluZ3MgYW5kIGVycm9ycy4KKiAgIDwvbGk+CiogICA8bGk+CiogICAgIDxjb2RlPlRCLkxPRzwvY29kZT4gJiMxNTE7IExvZ2dpbmcgb2YgPGNvZGU+VEIubG9nKCk8L2NvZGU+IG1lc3NhZ2VzLCBpbiBhZGRpdGlvbiB0byBPcGVuVG9rIGluZm8sIHdhcm5pbmcsCiogICAgIGFuZCBlcnJvciBtZXNzYWdlcy4KKiAgIDwvbGk+CiogICA8bGk+CiogICAgIDxjb2RlPlRCLkRFQlVHPC9jb2RlPiAmIzE1MTsgRmluZS1ncmFpbmVkIGxvZ2dpbmcgb2YgYWxsIEFQSSBhY3Rpb25zLCBhcyB3ZWxsIGFzIDxjb2RlPlRCLmxvZygpPC9jb2RlPiBtZXNzYWdlcy4KKiAgIDwvbGk+CiogPC91bD4KKiA8L3A+CioKKiBAbmFtZSBUQi5zZXRMb2dMZXZlbAoqIEBtZW1iZXJvZiBUQgoqIEBmdW5jdGlvbgoqIEBzZWUgPGEgaHJlZj0iI2xvZyI+VEIubG9nKCk8L2E+CiovCgovKioKKiBTZW5kcyBhIHN0cmluZyB0byB0aGUgdGhlIGRlYnVnZ2VyIGNvbnNvbGUgKHN1Y2ggYXMgRmlyZWJ1ZyksIGlmIG9uZSBleGlzdHMuIEhvd2V2ZXIsIHRoZSBmdW5jdGlvbgoqIG9ubHkgbG9ncyB0byB0aGUgY29uc29sZSBpZiB5b3UgaGF2ZSBzZXQgdGhlIGxvZyBsZXZlbCB0byA8Y29kZT5UQi5MT0c8L2NvZGU+IG9yIDxjb2RlPlRCLkRFQlVHPC9jb2RlPiwKKiBieSBjYWxsaW5nIDxjb2RlPlRCLnNldExvZ0xldmVsKFRCLkxPRyk8L2NvZGU+IG9yIDxjb2RlPlRCLnNldExvZ0xldmVsKFRCLkRFQlVHKTwvY29kZT4uCioKKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgc3RyaW5nIHRvIGxvZy4KKgoqIEBuYW1lIFRCLmxvZwoqIEBtZW1iZXJvZiBUQgoqIEBmdW5jdGlvbgoqIEBzZWUgPGEgaHJlZj0iI3NldExvZ0xldmVsIj5UQi5zZXRMb2dMZXZlbCgpPC9hPgoqLwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gSU1QT1JUQU5UIFRoaXMgZmlsZSBzaG91bGQgYmUgaW5jbHVkZWQgc3RyYWlnaHQgYWZ0ZXIgaGVscGVycy5qcwppZiAoIXdpbmRvdy5PVCkgd2luZG93Lk9UID0ge307CgppZiAoIU9ULnByb3BlcnRpZXMpIHsKICB0aHJvdyBuZXcgRXJyb3IoIk9ULnByb3BlcnRpZXMgZG9lcyBub3QgZXhpc3QsIHBsZWFzZSBlbnN1cmUgdGhhdCB5b3UgaW5jbHVkZSBhIHZhbGlkIHByb3BlcnRpZXMgZmlsZS4iKTsKfQoKLy8gQ29uc3VtZXMgYW5kIG92ZXJ3cml0ZXMgT1QucHJvcGVydGllcy4gTWFrZXMgaXQgYmV0dGVyIGFuZCBzdHJvbmdlciEKT1QucHJvcGVydGllcyA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsKICAgIHZhciBwcm9wcyA9IE9ULiQuY2xvbmUocHJvcGVydGllcyk7CgogICAgcHJvcHMuZGVidWcgPSBwcm9wZXJ0aWVzLmRlYnVnID09PSAndHJ1ZScgfHwgcHJvcGVydGllcy5kZWJ1ZyA9PT0gdHJ1ZTsKICAgIHByb3BzLnN1cHBvcnRTU0wgPSBwcm9wZXJ0aWVzLnN1cHBvcnRTU0wgPT09ICd0cnVlJyB8fCBwcm9wZXJ0aWVzLnN1cHBvcnRTU0wgPT09IHRydWU7CgogICAgaWYgKHByb3BzLnN1cHBvcnRTU0wgJiYgKHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbC5pbmRleE9mKCJodHRwcyIpID49IDAgfHwgd2luZG93LmxvY2F0aW9uLnByb3RvY29sLmluZGV4T2YoImNocm9tZS1leHRlbnNpb24iKSA+PSAwKSkgewogICAgICAgIHByb3BzLmFzc2V0VVJMID0gcHJvcHMuY2RuVVJMU1NMICsgIi93ZWJydGMvIiArIHByb3BzLnZlcnNpb247CiAgICAgICAgcHJvcHMubG9nZ2luZ1VSTCA9IHByb3BzLmxvZ2dpbmdVUkxTU0w7CiAgICAgICAgcHJvcHMuYXBpVVJMID0gcHJvcHMuYXBpVVJMU1NMOwogICAgfSBlbHNlIHsKICAgICAgICBwcm9wcy5hc3NldFVSTCA9IHByb3BzLmNkblVSTCArICIvd2VicnRjLyIgKyBwcm9wcy52ZXJzaW9uOwogICAgfQoKICAgIHByb3BzLmNvbmZpZ1VSTCA9IHByb3BzLmFzc2V0VVJMICsgIi9qcy9keW5hbWljX2NvbmZpZy5taW4uanMiOwogICAgcHJvcHMuY3NzVVJMID0gcHJvcHMuYXNzZXRVUkwgKyAiL2Nzcy9vdC5taW4uY3NzIjsKCiAgICByZXR1cm4gcHJvcHM7Cn0oT1QucHJvcGVydGllcyk7Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7CgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIEpTIER5bmFtaWMgQ29uZmlnCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCgpPVC5Db25maWcgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgX2xvYWRlZCA9IGZhbHNlLAogICAgICAgIF9nbG9iYWwgPSB7fSwKICAgICAgICBfcGFydG5lcnMgPSB7fSwKICAgICAgICBfc2NyaXB0LAogICAgICAgIF9oZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLAogICAgICAgIF9sb2FkVGltZXIsCgogICAgICAgIF9jbGVhclRpbWVvdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF9sb2FkVGltZXIpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChfbG9hZFRpbWVyKTsKICAgICAgICAgICAgICAgIF9sb2FkVGltZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NsZWFudXAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2NsZWFyVGltZW91dCgpOwoKICAgICAgICAgICAgaWYgKF9zY3JpcHQpIHsKICAgICAgICAgICAgICAgIF9zY3JpcHQub25sb2FkID0gX3NjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKICAgICAgICAgICAgICAgIGlmICggX2hlYWQgJiYgX3NjcmlwdC5wYXJlbnROb2RlICkgewogICAgICAgICAgICAgICAgICAgIF9oZWFkLnJlbW92ZUNoaWxkKCBfc2NyaXB0ICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgX3NjcmlwdCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9vbkxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gT25seSBJRSBhbmQgT3BlcmEgYWN0dWFsbHkgc3VwcG9ydCByZWFkeVN0YXRlIG9uIFNjcmlwdCBlbGVtZW50cy4KICAgICAgICAgICAgaWYgKF9zY3JpcHQucmVhZHlTdGF0ZSAmJiAhL2xvYWRlZHxjb21wbGV0ZS8udGVzdCggX3NjcmlwdC5yZWFkeVN0YXRlICkpIHsKICAgICAgICAgICAgICAgIC8vIFllYWgsIHdlJ3JlIG5vdCByZWFkeSB5ZXQuLi4KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NsZWFyVGltZW91dCgpOwoKICAgICAgICAgICAgaWYgKCFfbG9hZGVkKSB7CiAgICAgICAgICAgICAgICAvLyBPdXIgY29uZmlnIHNjcmlwdCBpcyBsb2FkZWQgYnV0IHRoZXJlIGlzIG5vdCBjb25maWcgKGFzCiAgICAgICAgICAgICAgICAvLyByZXBsYWNlV2l0aCB3YXNuJ3QgY2FsbGVkKS4gU29tZXRoaW5nIHdlbnQgd3JvbmcuIFBvc3NpYmx5CiAgICAgICAgICAgICAgICAvLyB0aGUgZmlsZSB3ZSBsb2FkZWQgd2Fzbid0IGFjdHVhbGx5IGEgdmFsaWQgY29uZmlnIGZpbGUuCiAgICAgICAgICAgICAgICBfdGhpcy5fb25Mb2FkVGltZW91dCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2dldE1vZHVsZSA9IGZ1bmN0aW9uKG1vZHVsZU5hbWUsIGFwaUtleSkgewogICAgICAgICAgICBpZiAoYXBpS2V5ICYmIF9wYXJ0bmVyc1thcGlLZXldICYmIF9wYXJ0bmVyc1thcGlLZXldW21vZHVsZU5hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3BhcnRuZXJzW2FwaUtleV1bbW9kdWxlTmFtZV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBfZ2xvYmFsW21vZHVsZU5hbWVdOwogICAgICAgIH0sCgogICAgICAgIF90aGlzID0gewogICAgICAgICAgICAvLyBJbiBtcwogICAgICAgICAgICBsb2FkVGltZW91dDogNDAwMCwKCiAgICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uKGNvbmZpZ1VybCkgewogICAgICAgICAgICAgICAgaWYgKCFjb25maWdVcmwpIHRocm93IG5ldyBFcnJvcigiWW91IG11c3QgcGFzcyBhIHZhbGlkIGNvbmZpZ1VybCB0byBDb25maWcubG9hZCIpOwoKICAgICAgICAgICAgICAgIF9sb2FkZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIF9zY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic2NyaXB0IiApOwogICAgICAgICAgICAgICAgICAgIF9zY3JpcHQuYXN5bmMgPSAiYXN5bmMiOwogICAgICAgICAgICAgICAgICAgIF9zY3JpcHQuc3JjID0gY29uZmlnVXJsOwogICAgICAgICAgICAgICAgICAgIF9zY3JpcHQub25sb2FkID0gX3NjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBfb25Mb2FkLmJpbmQodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgX2hlYWQuYXBwZW5kQ2hpbGQoX3NjcmlwdCk7CiAgICAgICAgICAgICAgICB9LDEpOwoKICAgICAgICAgICAgICAgIF9sb2FkVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLl9vbkxvYWRUaW1lb3V0KCk7CiAgICAgICAgICAgICAgICB9LCB0aGlzLmxvYWRUaW1lb3V0KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9vbkxvYWRUaW1lb3V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIF9jbGVhbnVwKCk7CgogICAgICAgICAgICAgICAgT1Qud2FybigiVEIgRHluYW1pY0NvbmZpZyBmYWlsZWQgdG8gbG9hZCBpbiAiICsgX3RoaXMubG9hZFRpbWVvdXQgKyAiIG1zIik7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2R5bmFtaWNDb25maWdMb2FkRmFpbGVkJyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpc0xvYWRlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX2xvYWRlZDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIF9jbGVhbnVwKCk7CiAgICAgICAgICAgICAgICBfbG9hZGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBfZ2xvYmFsID0ge307CiAgICAgICAgICAgICAgICBfcGFydG5lcnMgPSB7fTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIFRoaXMgaXMgcHVibGljIHNvIHRoYXQgdGhlIGR5bmFtaWMgY29uZmlnIGZpbGUgY2FuIGxvYWQgaXRzZWxmLgogICAgICAgICAgICAvLyBVc2luZyBpdCBmb3Igb3RoZXIgcHVycG9zZXMgaXMgZGlzY291cmFnZWQsIGJ1dCBub3QgZm9yYmlkZGVuLgogICAgICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgICAgICBfY2xlYW51cCgpOwoKICAgICAgICAgICAgICAgIGlmICghY29uZmlnKSBjb25maWcgPSB7fTsKCiAgICAgICAgICAgICAgICBfZ2xvYmFsID0gY29uZmlnLmdsb2JhbCB8fCB7fTsKICAgICAgICAgICAgICAgIF9wYXJ0bmVycyA9IGNvbmZpZy5wYXJ0bmVycyB8fCB7fTsKCiAgICAgICAgICAgICAgICBpZiAoIV9sb2FkZWQpIF9sb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdkeW5hbWljQ29uZmlnQ2hhbmdlZCcpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gQGV4YW1wbGUgR2V0IHRoZSB2YWx1ZSB0aGF0IGluZGljYXRlcyB3aGV0aGVyIGV4Y2VwdGlvbkxvZ2dpbmcgaXMgZW5hYmxlZAogICAgICAgICAgICAvLyAgT1QuQ29uZmlnLmdldCgnZXhjZXB0aW9uTG9nZ2luZycsICdlbmFibGVkJyk7CiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEBleGFtcGxlIEdldCBhIGtleSBmb3IgYSBzcGVjaWZpYyBwYXJ0bmVyLCBmYWxsYmFjayB0byB0aGUgZGVmYXVsdCBpZiB0aGVyZSBpcwogICAgICAgICAgICAvLyBubyBrZXkgZm9yIHRoYXQgcGFydG5lcgogICAgICAgICAgICAvLyAgT1QuQ29uZmlnLmdldCgnZXhjZXB0aW9uTG9nZ2luZycsICdlbmFibGVkJywgJ2FwaUtleScpOwogICAgICAgICAgICAvLwogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKG1vZHVsZU5hbWUsIGtleSwgYXBpS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kdWxlID0gX2dldE1vZHVsZShtb2R1bGVOYW1lLCBhcGlLZXkpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZSA/IG1vZHVsZVtrZXldIDogbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgT1QuJC5ldmVudGluZyhfdGhpcyk7CgogICAgcmV0dXJuIF90aGlzOwp9KSgpOwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKdmFyIGRlZmF1bHRBc3BlY3RSYXRpbyA9IDQuMC8zLjA7CgovLyBUaGlzIGNvZGUgcG9zaXRpb25zIHRoZSB2aWRlbyBlbGVtZW50IHNvIHRoYXQgd2UgZG9uJ3QgZ2V0IGFueSBsZXR0ZXJib3hpbmcuCi8vIEl0IHdpbGwgdGFrZSBpbnRvIGNvbnNpZGVyYXRpb24gYXNwZWN0IHJhdGlvcyBvdGhlciB0aGFuIDQvMyBidXQgb25seSB3aGVuCi8vIHRoZSB2aWRlbyBlbGVtZW50IGlzIGZpcnN0IGNyZWF0ZWQuIElmIHRoZSBhc3BlY3QgcmF0aW8gY2hhbmdlcyBhdCBhIGxhdGVyIHBvaW50Ci8vIHRoaXMgY2FsY3VsYXRpb24gd2lsbCBiZWNvbWUgaW5jb3JyZWN0LgpmdW5jdGlvbiBmaXhBc3BlY3RSYXRpbyhlbGVtZW50LCB3aWR0aCwgaGVpZ2h0LCBkZXNpcmVkQXNwZWN0UmF0aW8sIHJvdGF0ZWQpIHsKICAgIGlmICghd2lkdGgpIHdpZHRoID0gcGFyc2VJbnQoT1QuJC53aWR0aChlbGVtZW50LnBhcmVudE5vZGUpLCAxMCk7CiAgICBlbHNlIHdpZHRoID0gcGFyc2VJbnQod2lkdGgsIDEwKTsKCiAgICBpZiAoIWhlaWdodCkgaGVpZ2h0ID0gcGFyc2VJbnQoT1QuJC5oZWlnaHQoZWxlbWVudC5wYXJlbnROb2RlKSwgMTApOwogICAgZWxzZSBoZWlnaHQgPSBwYXJzZUludChoZWlnaHQsIDEwKTsKCiAgICBpZiAod2lkdGggPT09IDAgfHwgaGVpZ2h0ID09PSAwKSByZXR1cm47CgogICAgaWYgKCFkZXNpcmVkQXNwZWN0UmF0aW8pIGRlc2lyZWRBc3BlY3RSYXRpbyA9IGRlZmF1bHRBc3BlY3RSYXRpbzsKCiAgICB2YXIgYWN0dWFsUmF0aW8gPSAod2lkdGggKyAwLjApL2hlaWdodCwKICAgICAgICBwcm9wcyA9IHsKICAgICAgICAgICAgd2lkdGg6ICcxMDAlJywKICAgICAgICAgICAgaGVpZ2h0OiAnMTAwJScsCiAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgIHRvcDogMAogICAgICAgIH07CgogICAgaWYgKGFjdHVhbFJhdGlvID4gZGVzaXJlZEFzcGVjdFJhdGlvKSB7CiAgICAgICAgLy8gV2lkdGggaXMgbGFyZ2VzdCBzbyB3ZSBibG93IHVwIHRoZSBoZWlnaHQgc28gd2UgZG9uJ3QgaGF2ZSBsZXR0ZXJib3hpbmcKICAgICAgICB2YXIgbmV3SGVpZ2h0ID0gKGFjdHVhbFJhdGlvIC8gZGVzaXJlZEFzcGVjdFJhdGlvKSAqIDEwMDsKCiAgICAgICAgcHJvcHMuaGVpZ2h0ID0gbmV3SGVpZ2h0ICsgJyUnOwogICAgICAgIHByb3BzLnRvcCA9ICctJyArICgobmV3SGVpZ2h0IC0gMTAwKSAvIDIpICsgJyUnOwogICAgfSBlbHNlIGlmIChhY3R1YWxSYXRpbyA8IGRlc2lyZWRBc3BlY3RSYXRpbykgewogICAgICAgIC8vIEhlaWdodCBpcyBsYXJnZXN0LCBibG93IHVwIHRoZSB3aWR0aAogICAgICAgIHZhciBuZXdXaWR0aCA9IChkZXNpcmVkQXNwZWN0UmF0aW8gLyBhY3R1YWxSYXRpbykgKiAxMDA7CgogICAgICAgIHByb3BzLndpZHRoID0gbmV3V2lkdGggKyAnJSc7CiAgICAgICAgcHJvcHMubGVmdCA9ICctJyArICgobmV3V2lkdGggLSAxMDApIC8gMikgKyAnJSc7CiAgICB9CgogICAgT1QuJC5jc3MoZWxlbWVudCwgcHJvcHMpOwoKICAgIHZhciB2aWRlbyA9IGVsZW1lbnQucXVlcnlTZWxlY3RvcigndmlkZW8nKTsKICAgIGlmKHZpZGVvKSB7CiAgICAgICAgaWYocm90YXRlZCkgewogICAgICAgICAgICB2YXIgdyA9IGVsZW1lbnQub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgICBoID0gZWxlbWVudC5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgICAgICBwcm9wcyA9IHsgd2lkdGg6IGggKyAncHgnLCBoZWlnaHQ6IHcgKyAncHgnLCBtYXJnaW5Ub3A6ICcnLCBtYXJnaW5MZWZ0OiAnJyB9LAogICAgICAgICAgICAgICAgZGlmZiA9IHcgLSBoOwogICAgICAgICAgICAgICAgcHJvcHMubWFyZ2luTGVmdCA9IChkaWZmIC8gMikgKyAncHgnOwogICAgICAgICAgICAgICAgcHJvcHMubWFyZ2luVG9wID0gLShkaWZmIC8gMikgKyAncHgnOwogICAgICAgICAgICAgICAgT1QuJC5jc3ModmlkZW8sIHByb3BzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBPVC4kLmNzcyh2aWRlbywgeyB3aWR0aDogJycsIGhlaWdodDogJycsIG1hcmdpblRvcDogJycsIG1hcmdpbkxlZnQ6ICcnfSk7CiAgICAgICAgfQogICAgfQoKfQoKdmFyIGdldE9yQ3JlYXRlQ29udGFpbmVyID0gZnVuY3Rpb24gZ2V0T3JDcmVhdGVDb250YWluZXIoZWxlbWVudE9yRG9tSWQsIGluc2VydE1vZGUpIHsKICAgIHZhciBjb250YWluZXIsCiAgICAgICAgZG9tSWQ7CgogICAgaWYgKGVsZW1lbnRPckRvbUlkICYmIGVsZW1lbnRPckRvbUlkLm5vZGVOYW1lKSB7CiAgICAgICAgLy8gSXQgbG9va3MgbGlrZSB3ZSB3ZXJlIGdpdmVuIGEgRE9NIGVsZW1lbnQuIEdyYWIgdGhlIGlkIG9yIGdlbmVyYXRlCiAgICAgICAgLy8gb25lIGlmIGl0IGRvZXNuJ3QgaGF2ZSBvbmUuCiAgICAgICAgY29udGFpbmVyID0gZWxlbWVudE9yRG9tSWQ7CiAgICAgICAgaWYgKCFjb250YWluZXIuZ2V0QXR0cmlidXRlKCdpZCcpIHx8IGNvbnRhaW5lci5nZXRBdHRyaWJ1dGUoJ2lkJykubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoJ2lkJywgJ09UXycgKyBPVC4kLnV1aWQoKSk7CiAgICAgICAgfQoKICAgICAgICBkb21JZCA9IGNvbnRhaW5lci5nZXRBdHRyaWJ1dGUoJ2lkJyk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICAvLyBXZSBtYXkgaGF2ZSBnb3QgYW4gaWQsIHRyeSBhbmQgZ2V0IGl0J3MgRE9NIGVsZW1lbnQuCiAgICAgICAgY29udGFpbmVyID0gT1QuJChlbGVtZW50T3JEb21JZCk7CiAgICAgICAgZG9tSWQgPSBlbGVtZW50T3JEb21JZCB8fCAoJ09UXycgKyBPVC4kLnV1aWQoKSk7CiAgICB9CgogICAgaWYgKCFjb250YWluZXIpIHsKICAgICAgICBjb250YWluZXIgPSBPVC4kLmNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtpZDogZG9tSWR9KTsKICAgICAgICBjb250YWluZXIuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gIiMwMDAwMDAiOwogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIE9ULiQuZW1wdHlFbGVtZW50KGNvbnRhaW5lcik7CiAgICB9CgogICAgaWYoIShpbnNlcnRNb2RlID09IG51bGwgfHwgaW5zZXJ0TW9kZSA9PSAncmVwbGFjZScpKSB7CiAgICAgIHZhciBwbGFjZWhvbGRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBwbGFjZWhvbGRlci5pZCA9ICgnT1RfJyArIE9ULiQudXVpZCgpKTsKICAgICAgaWYoaW5zZXJ0TW9kZSA9PSAnYXBwZW5kJykgewogICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChwbGFjZWhvbGRlcik7CiAgICAgICAgY29udGFpbmVyID0gcGxhY2Vob2xkZXI7CiAgICAgIH0gZWxzZSBpZihpbnNlcnRNb2RlID09ICdiZWZvcmUnKSB7CiAgICAgICAgY29udGFpbmVyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCBjb250YWluZXIpOwogICAgICAgIGNvbnRhaW5lciA9IHBsYWNlaG9sZGVyOwogICAgICB9IGVsc2UgaWYoaW5zZXJ0TW9kZSA9PSAnYWZ0ZXInKSB7CiAgICAgICAgY29udGFpbmVyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCBjb250YWluZXIubmV4dFNpYmxpbmcpOwogICAgICAgIGNvbnRhaW5lciA9IHBsYWNlaG9sZGVyOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNvbnRhaW5lcjsKfTsKCi8vIENyZWF0ZXMgdGhlIHN0YW5kYXJkIGNvbnRhaW5lciB0aGF0IHRoZSBTdWJzY3JpYmVyIGFuZCBQdWJsaXNoZXIgdXNlIHRvIGhvbGQKLy8gdGhlaXIgdmlkZW8gZWxlbWVudCBhbmQgb3RoZXIgY2hyb21lLgpPVC5XaWRnZXRWaWV3ID0gZnVuY3Rpb24odGFyZ2V0RWxlbWVudCwgcHJvcGVydGllcykgewogICAgdmFyIGNvbnRhaW5lciA9IGdldE9yQ3JlYXRlQ29udGFpbmVyKHRhcmdldEVsZW1lbnQsIHByb3BlcnRpZXMgJiYgcHJvcGVydGllcy5pbnNlcnRNb2RlKSwKICAgICAgICB2aWRlb0NvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgICAgIG9sZENvbnRhaW5lclN0eWxlcyA9IHt9LAogICAgICAgIGRpbWVuc2lvbnNPYnNlcnZlciwKICAgICAgICB2aWRlb0VsZW1lbnQsCiAgICAgICAgdmlkZW9PYnNlcnZlciwKICAgICAgICBwb3N0ZXJDb250YWluZXIsCiAgICAgICAgbG9hZGluZ0NvbnRhaW5lciwKICAgICAgICBsb2FkaW5nID0gdHJ1ZTsKCiAgICBpZiAocHJvcGVydGllcykgewogICAgICAgIHdpZHRoID0gcHJvcGVydGllcy53aWR0aDsKICAgICAgICBoZWlnaHQgPSBwcm9wZXJ0aWVzLmhlaWdodDsKCiAgICAgICAgaWYgKHdpZHRoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Yod2lkdGgpID09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICB3aWR0aCA9IHdpZHRoICsgInB4IjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGhlaWdodCkgewogICAgICAgICAgICBpZiAodHlwZW9mKGhlaWdodCkgPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGhlaWdodCA9IGhlaWdodCArICJweCI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbnRhaW5lci5zdHlsZS53aWR0aCA9IHdpZHRoID8gd2lkdGggOiAiMjY0cHgiOwogICAgICAgIGNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgPyBoZWlnaHQgOiAiMTk4cHgiOwogICAgICAgIGNvbnRhaW5lci5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwoKICAgICAgICBpZiAocHJvcGVydGllcy5taXJyb3IgPT09IHVuZGVmaW5lZCB8fCBwcm9wZXJ0aWVzLm1pcnJvcikgT1QuJC5hZGRDbGFzcyhjb250YWluZXIsICdPVF9taXJyb3JlZCcpOwogICAgfQoKICAgIGlmIChwcm9wZXJ0aWVzLmNsYXNzTmFtZXMpIE9ULiQuYWRkQ2xhc3MoY29udGFpbmVyLCBwcm9wZXJ0aWVzLmNsYXNzTmFtZXMpOwogICAgT1QuJC5hZGRDbGFzcyhjb250YWluZXIsICdPVF9sb2FkaW5nJyk7CgoKICAgIE9ULiQuYWRkQ2xhc3ModmlkZW9Db250YWluZXIsICdPVF92aWRlby1jb250YWluZXInKTsKICAgIHZpZGVvQ29udGFpbmVyLnN0eWxlLndpZHRoID0gY29udGFpbmVyLnN0eWxlLndpZHRoOwogICAgdmlkZW9Db250YWluZXIuc3R5bGUuaGVpZ2h0ID0gY29udGFpbmVyLnN0eWxlLmhlaWdodDsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh2aWRlb0NvbnRhaW5lcik7CiAgICBmaXhBc3BlY3RSYXRpbyh2aWRlb0NvbnRhaW5lciwgY29udGFpbmVyLm9mZnNldFdpZHRoLCBjb250YWluZXIub2Zmc2V0SGVpZ2h0KTsKCiAgICBsb2FkaW5nQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBPVC4kLmFkZENsYXNzKGxvYWRpbmdDb250YWluZXIsICJPVF92aWRlby1sb2FkaW5nIik7CiAgICB2aWRlb0NvbnRhaW5lci5hcHBlbmRDaGlsZChsb2FkaW5nQ29udGFpbmVyKTsKCiAgICBwb3N0ZXJDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIE9ULiQuYWRkQ2xhc3MocG9zdGVyQ29udGFpbmVyLCAiT1RfdmlkZW8tcG9zdGVyIik7CiAgICB2aWRlb0NvbnRhaW5lci5hcHBlbmRDaGlsZChwb3N0ZXJDb250YWluZXIpOwoKICAgIG9sZENvbnRhaW5lclN0eWxlcy53aWR0aCA9IGNvbnRhaW5lci5vZmZzZXRXaWR0aDsKICAgIG9sZENvbnRhaW5lclN0eWxlcy5oZWlnaHQgPSBjb250YWluZXIub2Zmc2V0SGVpZ2h0OwoKICAgIC8vIE9ic2VydmUgY2hhbmdlcyB0byB0aGUgd2lkdGggYW5kIGhlaWdodCBhbmQgdXBkYXRlIHRoZSBhc3BlY3QgcmF0aW8KICAgIGRpbWVuc2lvbnNPYnNlcnZlciA9IE9ULiQub2JzZXJ2ZVN0eWxlQ2hhbmdlcyhjb250YWluZXIsIFsnd2lkdGgnLCAnaGVpZ2h0J10sIGZ1bmN0aW9uKGNoYW5nZVNldCkgewogICAgICAgIHZhciB3aWR0aCA9IGNoYW5nZVNldC53aWR0aCA/IGNoYW5nZVNldC53aWR0aFsxXSA6IGNvbnRhaW5lci5vZmZzZXRXaWR0aCwKICAgICAgICAgICAgaGVpZ2h0ID0gY2hhbmdlU2V0LmhlaWdodCA/IGNoYW5nZVNldC5oZWlnaHRbMV0gOiBjb250YWluZXIub2Zmc2V0SGVpZ2h0OwoKICAgICAgICBmaXhBc3BlY3RSYXRpbyh2aWRlb0NvbnRhaW5lciwgd2lkdGgsIGhlaWdodCwgdmlkZW9FbGVtZW50ID8gdmlkZW9FbGVtZW50LmFzcGVjdFJhdGlvIDogbnVsbCk7CiAgICB9KTsKCgogICAgLy8gQHRvZG8gb2JzZXJ2ZSBpZiB0aGUgdmlkZW8gY29udGFpbmVyIG9yIHRoZSB2aWRlbyBlbGVtZW50IGdldCByZW1vdmVkLCBpZiB0aGV5IGRvIHdlIHNob3VsZCBkbyBzb21lIGNsZWFudXAKICAgIHZpZGVvT2JzZXJ2ZXIgPSBPVC4kLm9ic2VydmVOb2RlT3JDaGlsZE5vZGVSZW1vdmFsKGNvbnRhaW5lciwgZnVuY3Rpb24ocmVtb3ZlZE5vZGVzKSB7CiAgICAgICAgaWYgKCF2aWRlb0VsZW1lbnQpIHJldHVybjsKCiAgICAgICAgLy8gVGhpcyBhc3N1bWVzIGEgdmlkZW8gZWxlbWVudCBiZWluZyByZW1vdmVkIGlzIHRoZSBtYWluIHZpZGVvIGVsZW1lbnQuIFRoaXMgbWF5CiAgICAgICAgLy8gbm90IGJlIHRoZSBjYXNlLgogICAgICAgIHZhciB2aWRlb1JlbW92ZWQgPSByZW1vdmVkTm9kZXMuc29tZShmdW5jdGlvbihub2RlKSB7IHJldHVybiBub2RlID09PSB2aWRlb0NvbnRhaW5lciB8fCBub2RlLm5vZGVOYW1lID09PSAnVklERU8nOyB9KTsKCiAgICAgICAgaWYgKHZpZGVvUmVtb3ZlZCkgewogICAgICAgICAgICB2aWRlb0VsZW1lbnQuZGVzdHJveSgpOwogICAgICAgICAgICB2aWRlb0VsZW1lbnQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZpZGVvQ29udGFpbmVyKSB7CiAgICAgICAgICAgIE9ULiQucmVtb3ZlRWxlbWVudCh2aWRlb0NvbnRhaW5lcik7CiAgICAgICAgICAgIHZpZGVvQ29udGFpbmVyID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChkaW1lbnNpb25zT2JzZXJ2ZXIpIHsKICAgICAgICAgICAgZGltZW5zaW9uc09ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgZGltZW5zaW9uc09ic2VydmVyID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh2aWRlb09ic2VydmVyKSB7CiAgICAgICAgICAgIHZpZGVvT2JzZXJ2ZXIuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB2aWRlb09ic2VydmVyID0gbnVsbDsKICAgICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGltZW5zaW9uc09ic2VydmVyKSB7CiAgICAgICAgICAgIGRpbWVuc2lvbnNPYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgIGRpbWVuc2lvbnNPYnNlcnZlciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodmlkZW9PYnNlcnZlcikgewogICAgICAgICAgICB2aWRlb09ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgdmlkZW9PYnNlcnZlciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodmlkZW9FbGVtZW50KSB7CiAgICAgICAgICAgIHZpZGVvRWxlbWVudC5kZXN0cm95KCk7CiAgICAgICAgICAgIHZpZGVvRWxlbWVudCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29udGFpbmVyKSB7CiAgICAgICAgICAgIE9ULiQucmVtb3ZlRWxlbWVudChjb250YWluZXIpOwogICAgICAgICAgICBjb250YWluZXIgPSBudWxsOwogICAgICAgIH0KICAgIH07CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewoKICAgICAgICBzaG93UG9zdGVyOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIU9ULiQuaXNEaXNwbGF5Tm9uZShwb3N0ZXJDb250YWluZXIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHNob3duKSB7CiAgICAgICAgICAgICAgICBpZihzaG93bikgewogICAgICAgICAgICAgICAgICAgIE9ULiQuc2hvdyhwb3N0ZXJDb250YWluZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgT1QuJC5oaWRlKHBvc3RlckNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwb3N0ZXI6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBPVC4kLmNzcyhwb3N0ZXJDb250YWluZXIsICJiYWNrZ3JvdW5kSW1hZ2UiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihzcmMpIHsKICAgICAgICAgICAgICAgIE9ULiQuY3NzKHBvc3RlckNvbnRhaW5lciwgImJhY2tncm91bmRJbWFnZSIsICJ1cmwoIiArIHNyYyArICIpIik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBsb2FkaW5nOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBsb2FkaW5nOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGwpIHsKICAgICAgICAgICAgICAgIGxvYWRpbmcgPSBsOwoKICAgICAgICAgICAgICAgIGlmIChsb2FkaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgT1QuJC5hZGRDbGFzcyhjb250YWluZXIsICdPVF9sb2FkaW5nJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBPVC4kLnJlbW92ZUNsYXNzKGNvbnRhaW5lciwgJ09UX2xvYWRpbmcnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHZpZGVvOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiB2aWRlb0VsZW1lbnQ7IH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmlkZW8pIHsKICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgb2xkIHZpZGVvIGVsZW1lbnQgaWYgaXQgZXhpc3RzCiAgICAgICAgICAgICAgICAvLyBAdG9kbyB0aGlzIG1pZ2h0IG5vdCBiZSBzYWZlLCBwdWJsaXNoZXJzL3N1YnNjcmliZXJzIHVzZSB0aGlzIGFzIHdlbGwuLi4KICAgICAgICAgICAgICAgIGlmICh2aWRlb0VsZW1lbnQpIHZpZGVvRWxlbWVudC5kZXN0cm95KCk7CgogICAgICAgICAgICAgICAgdmlkZW8uYXBwZW5kVG8odmlkZW9Db250YWluZXIpOwogICAgICAgICAgICAgICAgdmlkZW9FbGVtZW50ID0gdmlkZW87CgogICAgICAgICAgICAgICAgdmlkZW9FbGVtZW50Lm9uKHsKICAgICAgICAgICAgICAgICAgICBvcmllbnRhdGlvbkNoYW5nZWQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpeEFzcGVjdFJhdGlvKHZpZGVvQ29udGFpbmVyLCBjb250YWluZXIub2Zmc2V0V2lkdGgsIGNvbnRhaW5lci5vZmZzZXRIZWlnaHQsIHZpZGVvRWxlbWVudC5hc3BlY3RSYXRpbywgdmlkZW9FbGVtZW50LmlzUm90YXRlZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZml4QXNwZWN0UmF0aW8odmlkZW9Db250YWluZXIsIGNvbnRhaW5lci5vZmZzZXRXaWR0aCwgY29udGFpbmVyLm9mZnNldEhlaWdodCwgdmlkZW9FbGVtZW50ID8gdmlkZW9FbGVtZW50LmFzcGVjdFJhdGlvIDogbnVsbCwgdmlkZW9FbGVtZW50ID8gdmlkZW9FbGVtZW50LmlzUm90YXRlZCA6IG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZG9tRWxlbWVudDogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gY29udGFpbmVyOyB9CiAgICAgICAgfSwKCiAgICAgICAgZG9tSWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBjb250YWluZXIuZ2V0QXR0cmlidXRlKCdpZCcpOyB9CiAgICAgICAgfQogICAgfSk7CgogICAgdGhpcy5hZGRFcnJvciA9IGZ1bmN0aW9uKGVycm9yTXNnKSB7CiAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICI8cD4iICsgZXJyb3JNc2cgKyAiPHA+IjsKICAgICAgICBPVC4kLmFkZENsYXNzKGNvbnRhaW5lciwgIk9UX3N1YnNjcmliZXJfZXJyb3IiKTsKICAgIH07Cn07Cgp9KSh3aW5kb3cpOwovLyBXZWIgT1QgSGVscGVycwooZnVuY3Rpb24od2luZG93KSB7CgovLyBIYW5keSBjcm9zcy1icm93c2VyIGdldFVzZXJNZWRpYSBzaGltLiBJbnNwaXJlZCBieSBzb21lIGNvZGUgZnJvbSBBZGFtIEJhcnRoCnZhciBnZXRVc2VyTWVkaWEgPSAoZnVuY3Rpb24oKSB7CiAgICBpZiAobmF2aWdhdG9yLmdldFVzZXJNZWRpYSkgewogICAgICAgIHJldHVybiBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhLmJpbmQobmF2aWdhdG9yKTsKICAgIH0gZWxzZSBpZiAobmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSkgewogICAgICAgIHJldHVybiBuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhLmJpbmQobmF2aWdhdG9yKTsKICAgIH0gZWxzZSBpZiAobmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSkgewogICAgICAgIHJldHVybiBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhLmJpbmQobmF2aWdhdG9yKTsKICAgIH0KfSkoKTsKCgppZiAobmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSkgewogICAgLy8gU3R1YiBmb3IgZ2V0VmlkZW9UcmFja3MgZm9yIENocm9tZSA8IDI2CiAgICBpZiAoIXdlYmtpdE1lZGlhU3RyZWFtLnByb3RvdHlwZS5nZXRWaWRlb1RyYWNrcykgewogICAgICAgIHdlYmtpdE1lZGlhU3RyZWFtLnByb3RvdHlwZS5nZXRWaWRlb1RyYWNrcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy52aWRlb1RyYWNrczsKICAgICAgICB9OwogICAgfQoKICAgIC8vIFN0dWJzIGZvciBnZXRBdWRpb1RyYWNrcyBmb3IgQ2hyb21lIDwgMjYKICAgIGlmICghd2Via2l0TWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldEF1ZGlvVHJhY2tzKSB7CiAgICAgICAgd2Via2l0TWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldEF1ZGlvVHJhY2tzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmF1ZGlvVHJhY2tzOwogICAgICAgIH07CiAgICB9CgogICAgaWYgKCF3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TG9jYWxTdHJlYW1zKSB7CiAgICAgICAgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLmdldExvY2FsU3RyZWFtcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxTdHJlYW1zOwogICAgICAgIH07CiAgICB9CgogICAgaWYgKCF3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0UmVtb3RlU3RyZWFtcykgewogICAgICAgIHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRSZW1vdGVTdHJlYW1zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5yZW1vdGVTdHJlYW1zOwogICAgICAgIH07CiAgICB9Cn0KZWxzZSBpZiAobmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSkgewogICAgLy8gRmlyZWZveCA8IDIzIGRvZXNuJ3Qgc3VwcG9ydCBnZXQgVmlkZW8vQXVkaW8gdHJhY2tzLCB3ZSdsbCBqdXN0IHN0dWIgdGhlbSBvdXQgZm9yIG5vdy4KICAgIGlmICghTWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldFZpZGVvVHJhY2tzKSB7CiAgICAgICAgTWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldFZpZGVvVHJhY2tzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9OwogICAgfQoKICAgIGlmICghTWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldEF1ZGlvVHJhY2tzKSB7CiAgICAgICAgTWVkaWFTdHJlYW0ucHJvdG90eXBlLmdldEF1ZGlvVHJhY2tzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9OwogICAgfQoKICAgIC8vIFRoaXMgd29uJ3Qgd29yayBhcyBtb3pSVENQZWVyQ29ubmVjdGlvbiBpcyBhIHdlaXJkIGludGVybmFsIEZpcmVmb3gKICAgIC8vIG9iamVjdCAoYSB3cmFwcGVkIG5hdGl2ZSBvYmplY3QgSSB0aGluaykuCiAgICAvLyBpZiAoIXdpbmRvdy5tb3pSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TG9jYWxTdHJlYW1zKSB7CiAgICAvLyAgICAgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRMb2NhbFN0cmVhbXMgPSBmdW5jdGlvbigpIHsKICAgIC8vICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxTdHJlYW1zOwogICAgLy8gICAgIH07CiAgICAvLyB9CgogICAgLy8gVGhpcyB3b24ndCB3b3JrIGFzIG1velJUQ1BlZXJDb25uZWN0aW9uIGlzIGEgd2VpcmQgaW50ZXJuYWwgRmlyZWZveAogICAgLy8gb2JqZWN0IChhIHdyYXBwZWQgbmF0aXZlIG9iamVjdCBJIHRoaW5rKS4KICAgIC8vIGlmICghd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRSZW1vdGVTdHJlYW1zKSB7CiAgICAvLyAgICAgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRSZW1vdGVTdHJlYW1zID0gZnVuY3Rpb24oKSB7CiAgICAvLyAgICAgICAgIHJldHVybiB0aGlzLnJlbW90ZVN0cmVhbXM7CiAgICAvLyAgICAgfTsKICAgIC8vIH0KfQoKCi8vIE1vemlsbGEgZXJyb3Igc3RyaW5ncyBhbmQgdGhlIGVxdWl2YWxlbnQgVzNDIG5hbWVzLiBOT1RfU1VQUE9SVEVEX0VSUk9SIGRvZXMgbm90Ci8vIGV4aXN0IGluIHRoZSBzcGVjIHJpZ2h0IG5vdywgc28gd2UnbGwgaW5jbHVkZSBNb3ppbGxhJ3MgZXJyb3IgZGVzY3JpcHRpb24uCnZhciBtb3pUb1czQ0Vycm9ycyA9IHsKICAgIFBFUk1JU1NJT05fREVOSUVEOiAnUEVSTUlTU0lPTl9ERU5JRUQnLAogICAgTk9UX1NVUFBPUlRFRF9FUlJPUjogIkEgY29uc3RyYWludCBzcGVjaWZpZWQgaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgYnJvd3Nlci4iLAogICAgTUFOREFUT1JZX1VOU0FUSVNGSUVEX0VSUk9SOiAnQ09OU1RSQUlOVF9OT1RfU0FUSVNGSUVEJwp9OwoKLy8gQ2hyb21lIG9ubHkgc2VlbXMgdG8gZXhwb3NlIGEgc2luZ2xlIGVycm9yIHdpdGggYSBjb2RlIG9mIDEgcmlnaHQgbm93Lgp2YXIgY2hyb21lVG9XM0NFcnJvcnMgPSB7CiAgICAxOiAnUEVSTUlTU0lPTl9ERU5JRUQnCn07CgoKdmFyIGd1bU5hbWVzVG9NZXNzYWdlcyA9IHsKICAgIFBFUk1JU1NJT05fREVOSUVEOiAiVXNlciBkZW5pZWQgcGVybWlzc2lvbiBmb3Igc2NyaXB0cyBmcm9tIHRoaXMgb3JpZ2luIHRvIGFjY2VzcyB0aGUgbWVkaWEgZGV2aWNlLiIsCiAgICBDT05TVFJBSU5UX05PVF9TQVRJU0ZJRUQ6ICJPbmUgb2YgdGhlIG1hbmRhdG9yeSBjb25zdHJhaW50cyBjb3VsZCBub3QgYmUgc2F0aXNmaWVkLiIKfTsKCi8vIE1hcCB2ZW5kb3IgZXJyb3Igc3RyaW5ncyB0byBuYW1lcyBhbmQgbWVzc2FnZXMKdmFyIG1hcFZlbmRvckVycm9yTmFtZSA9IGZ1bmN0aW9uIG1hcFZlbmRvckVycm9yTmFtZSAodmVuZG9yRXJyb3JOYW1lLCB2ZW5kb3JFcnJvcnMpIHsKICAgIHZhciBlcnJvck5hbWUgPSB2ZW5kb3JFcnJvcnNbdmVuZG9yRXJyb3JOYW1lXSwKICAgICAgICBlcnJvck1lc3NhZ2UgPSBndW1OYW1lc1RvTWVzc2FnZXNbZXJyb3JOYW1lXTsKCiAgICBpZiAoIWVycm9yTWVzc2FnZSkgewogICAgICAgIC8vIFRoaXMgZG9lc24ndCBtYXAgdG8gYSBrbm93biBlcnJvciBmcm9tIHRoZSBNZWRpYSBDYXB0dXJlIHNwZWMsIGl0J3MKICAgICAgICAvLyBwcm9iYWJseSBhIGN1c3RvbSB2ZW5kb3IgZXJyb3IgbWVzc2FnZS4KICAgICAgICBlcnJvck1lc3NhZ2UgPSBldmVudE5hbWU7CiAgICAgICAgZXJyb3JOYW1lID0gdmVuZG9yRXJyb3JOYW1lOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogZXJyb3JOYW1lLAogICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZQogICAgfTsKfTsKCi8vIFBhcnNlIGFuZCBub3JtYWxpc2UgYSBnZXRVc2VyTWVkaWEgZXJyb3IgZXZlbnQgZnJvbSBDaHJvbWUgb3IgTW96aWxsYQovLwovLyBAcmVmIGh0dHA6Ly9kZXYudzMub3JnLzIwMTEvd2VicnRjL2VkaXRvci9nZXR1c2VybWVkaWEuaHRtbCNpZGwtZGVmLU5hdmlnYXRvclVzZXJNZWRpYUVycm9yCi8vCnZhciBwYXJzZUVycm9yRXZlbnQgPSBmdW5jdGlvbiBwYXJzZUVycm9yT2JqZWN0IChldmVudCkgewogICAgdmFyIGVycm9yOwoKICAgIGlmIChPVC4kLmlzT2JqZWN0KGV2ZW50KSAmJiBldmVudC5uYW1lKSB7CiAgICAgICAgZXJyb3IgPSB7CiAgICAgICAgICAgIG5hbWU6IGV2ZW50Lm5hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IGV2ZW50Lm1lc3NhZ2UsCiAgICAgICAgICAgIGNvbnN0cmFpbnROYW1lOiBldmVudC5jb25zdHJhaW50TmFtZQogICAgICAgIH07CiAgICB9CiAgICBlbHNlIGlmIChPVC4kLmlzT2JqZWN0KGV2ZW50KSkgewogICAgICAgIGVycm9yID0gbWFwVmVuZG9yRXJyb3JOYW1lKGV2ZW50LmNvZGUsIGNocm9tZVRvVzNDRXJyb3JzKTsKCiAgICAgICAgLy8gbWVzc2FnZSBhbmQgY29uc3RyYWludE5hbWUgYXJlIHByb2JhYmx5IG1pc3NpbmcgaWYgdGhlCiAgICAgICAgLy8gcHJvcGVydHkgaXMgYWxzbyBvbWl0dGVkLCBidXQganVzdCBpbiBjYXNlIHRoZXkgYXJlbid0LgogICAgICAgIGlmIChldmVudC5tZXNzYWdlKSBlcnJvci5tZXNzYWdlID0gZXZlbnQubWVzc2FnZTsKICAgICAgICBpZiAoZXZlbnQuY29uc3RyYWludE5hbWUpIGVycm9yLmNvbnN0cmFpbnROYW1lID0gZXZlbnQuY29uc3RyYWludE5hbWU7CiAgICB9CiAgICBlbHNlIGlmIChldmVudCAmJiBtb3pUb1czQ0Vycm9ycy5oYXNPd25Qcm9wZXJ0eShldmVudCkpIHsKICAgICAgICBlcnJvciA9IG1hcFZlbmRvckVycm9yTmFtZShldmVudCwgbW96VG9XM0NFcnJvcnMpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgZXJyb3IgPSB7CiAgICAgICAgICAgIG1lc3NhZ2U6ICJVbmtub3duIEVycm9yIHdoaWxlIGdldHRpbmcgdXNlciBtZWRpYSIKICAgICAgICB9OwogICAgfQoKCiAgICByZXR1cm4gZXJyb3I7Cn07CgoKCi8vIFZhbGlkYXRlcyBhIEhhc2ggb2YgZ2V0VXNlck1lZGlhIGNvbnN0cmFpbnRzLiBDdXJyZW50bHkgd2Ugb25seQovLyBjaGVjayB0byBzZWUgaWYgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIG5vbi1mYWxzZSBjb25zdHJhaW50Lgp2YXIgYXJlSW52YWxpZENvbnN0cmFpbnRzID0gZnVuY3Rpb24oY29uc3RyYWludHMpIHsKICAgIGlmICghY29uc3RyYWludHMgfHwgIU9ULiQuaXNPYmplY3QoY29uc3RyYWludHMpKSByZXR1cm4gdHJ1ZTsKCiAgICBmb3IgKHZhciBrZXkgaW4gY29uc3RyYWludHMpIHsKICAgICAgICBpZiAoY29uc3RyYWludHNba2V5XSkgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwp9OwoKCgoKCi8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgY2xpZW50IHN1cHBvcnRzIFdlYiBSVEMsIGZhbHNlIG90aGVyd2lzZS4KLy8KLy8gQ2hyb21lIElzc3VlczoKLy8gKiBUaGUgZXhwbGljaXQgcHJvdG90eXBlLmFkZFN0cmVhbSBjaGVjayBpcyBiZWNhdXNlIHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uIHdhcwovLyBwYXJ0aWFsbHkgaW1wbGVtZW50ZWQsIGJ1dCBub3QgZnVuY3Rpb25hbCwgaW4gQ2hyb21lIDIyLgovLwovLyBGaXJlZm94IElzc3VlczoKLy8gKiBObyByZWFsIHN1cHBvcnQgYmVmb3JlIEZpcmVmb3ggMTkKLy8gKiBGaXJlZm94IDE5IGhhcyBpc3N1ZXMgd2l0aCBnZW5lcmF0aW5nIE9mZmVycy4KLy8gKiBGaXJlZm94IDIwIGRvZXNuJ3QgaW50ZXJvcGVyYXRlIHdpdGggQ2hyb21lLgovLwpPVC4kLnN1cHBvcnRzV2ViUlRDID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgX3N1cHBvcnRzV2ViUlRDID0gZmFsc2U7CgogICAgaWYgKG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEpIHsKICAgICAgICBfc3VwcG9ydHNXZWJSVEMgPSB0eXBlb2Yod2Via2l0UlRDUGVlckNvbm5lY3Rpb24pID09PSAnZnVuY3Rpb24nICYmICEhd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLmFkZFN0cmVhbTsKICAgIH0KICAgIGVsc2UgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEpIHsKICAgICAgICB2YXIgZmlyZWZveFZlcnNpb24gPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLm1hdGNoKC9GaXJlZm94XC8oWzAtOVwuXSspL2kpOwogICAgICAgIF9zdXBwb3J0c1dlYlJUQyA9IHR5cGVvZihtb3pSVENQZWVyQ29ubmVjdGlvbikgPT09ICdmdW5jdGlvbicgJiYgKGZpcmVmb3hWZXJzaW9uICE9PSBudWxsICYmIHBhcnNlRmxvYXQoZmlyZWZveFZlcnNpb25bMV0sIDEwKSA+IDIwLjApOwogICAgICAgIGlmIChfc3VwcG9ydHNXZWJSVEMpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5ldyBtb3pSVENQZWVyQ29ubmVjdGlvbigpOwogICAgICAgICAgICAgICAgX3N1cHBvcnRzV2ViUlRDID0gdHJ1ZTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBfc3VwcG9ydHNXZWJSVEMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBPVC4kLnN1cHBvcnRzV2ViUlRDID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIF9zdXBwb3J0c1dlYlJUQzsKICAgIH07CgogICAgcmV0dXJuIF9zdXBwb3J0c1dlYlJUQzsKfTsKCi8vIFJldHVybnMgYSBTdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBzdXBwb3J0ZWQgV2ViUlRDIGNyeXB0byBzY2hlbWUuIFRoZSBwb3NzaWJsZQovLyB2YWx1ZXMgYXJlIFNERVNfU1JUUCwgRFRMU19TUlRQLCBhbmQgTk9ORTsKLy8KLy8gQnJvYWRseToKLy8gKiBGaXJlZm94IG9ubHkgc3VwcG9ydHMgRFRMUwovLyAqIE9sZGVyIHZlcnNpb25zIG9mIENocm9tZSAoPD0gMjQpIG9ubHkgc3VwcG9ydCBTREVTCi8vICogTmV3ZXIgdmVyc2lvbnMgb2YgQ2hyb21lICg+PSAyNSkgc3VwcG9ydCBEVExTIGFuZCBTREVTCi8vCk9ULiQuc3VwcG9ydGVkQ3J5cHRvU2NoZW1lID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoIU9ULiQuc3VwcG9ydHNXZWJSVEMoKSkgcmV0dXJuICdOT05FJzsKCiAgICB2YXIgY2hyb21lVmVyc2lvbiA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkubWF0Y2goL2Nocm9tZVwvKFswLTlcLl0rKS9pKTsKICAgIHJldHVybiBjaHJvbWVWZXJzaW9uICYmIHBhcnNlRmxvYXQoY2hyb21lVmVyc2lvblsxXSwgMTApIDwgMjUgPyAnU0RFU19TUlRQJyA6ICdEVExTX1NSVFAnOwp9OwoKLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBicm93c2VyIHN1cHBvcnRzIGJ1bmRsZQovLwovLyBCcm9hZGx5OgovLyAqIEZpcmVmb3ggZG9lc24ndCBzdXBwb3J0IGJ1bmRsZQovLyAqIENocm9tZSBzdXBwb3J0IGJ1bmRsZQovLwpPVC4kLnN1cHBvcnRzQnVuZGxlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gT1QuJC5zdXBwb3J0c1dlYlJUQygpICYmIE9ULiQuYnJvd3NlcigpID09PSAnQ2hyb21lJzsKfTsKCi8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBydGNwIG11eAovLwovLyBCcm9hZGx5OgovLyAqIE9sZGVyIHZlcnNpb25zIG9mIEZpcmVmb3ggKDw9IDI1KSBkb24ndCBzdXBwb3J0IHJ0Y3AgbXV4Ci8vICogT2xkZXIgdmVyc2lvbnMgb2YgRmlyZWZveCAoPj0gMjYpIHN1cHBvcnQgcnRjcCBtdXggKG5vdCB0ZXN0ZWQgeWV0KQovLyAqIENocm9tZSBzdXBwb3J0IGJ1bmRsZQovLwpPVC4kLnN1cHBvcnRzUnRjcE11eCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIE9ULiQuc3VwcG9ydHNXZWJSVEMoKSAmJiBPVC4kLmJyb3dzZXIoKSA9PT0gJ0Nocm9tZSc7Cn07CgovLyBBIHdyYXBwZXIgZm9yIHRoZSBidWlsdGluIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEuIEluIGFkZGl0aW9uIHRvIHRoZSB1c3VhbAovLyBnZXRVc2VyTWVkaWEgYmVoYXZpb3VyLCB0aGlzIGhlbHBlciBtZXRob2QgYWxzbyBhY2NlcHRzIGEgYWNjZXNzRGlhbG9nT3BlbmVkCi8vIGFuZCBhY2Nlc3NEaWFsb2dDbG9zZWQgY2FsbGJhY2suCi8vCi8vIEBtZW1iZXJvZiBUQi4kCi8vIEBwcml2YXRlCi8vCi8vIEBwYXJhbSB7T2JqZWN0fSBjb25zdHJhaW50cwovLyAgICAgIEEgZGljdGlvbmFyeSBvZiBjb25zdHJhaW50cyB0byBwYXNzIHRvIGdldFVzZXJNZWRpYS4gU2VlIDxhIGhyZWY9J2h0dHA6Ly9kZXYudzMub3JnLzIwMTEvd2VicnRjL2VkaXRvci9nZXR1c2VybWVkaWEuaHRtbCNpZGwtZGVmLU1lZGlhU3RyZWFtQ29uc3RyYWludHMnPk1lZGlhU3RyZWFtQ29uc3RyYWludHM8L2E+IGluIHRoZSBNZWRpYSBDYXB0dXJlIGFuZCBTdHJlYW1zIHNwZWMgZm9yIG1vcmUgaW5mby4KLy8KLy8gQHBhcmFtIHtmdW5jdGlvbn0gc3VjY2VzcwovLyAgICAgIENhbGxlZCB3aGVuIGdldFVzZXJNZWRpYSBjb21wbGV0ZXMgc3VjY2Vzc2Z1bGx5LiBUaGUgY2FsbGJhY2sgd2lsbCBiZSBwYXNzZWQgYSBXZWJSVEMgU3RyZWFtIG9iamVjdC4KLy8KLy8gQHBhcmFtIHtmdW5jdGlvbn0gZmFpbHVyZQovLyAgICAgIENhbGxlZCB3aGVuIGdldFVzZXJNZWRpYSBmYWlscyB0byBhY2Nlc3MgYSB1c2VyIHN0cmVhbS4gSXQgd2lsbCBiZSBwYXNzZWQgYW4gb2JqZWN0IHdpdGggYSBjb2RlIHByb3BlcnR5IHJlcHJlc2VudGluZyB0aGUgZXJyb3IgdGhhdCBvY2N1cnJlZC4KLy8KLy8gQHBhcmFtIHtmdW5jdGlvbn0gYWNjZXNzRGlhbG9nT3BlbmVkCi8vICAgICAgQ2FsbGVkIHdoZW4gdGhlIGFjY2VzcyBhbGxvdy9kZW55IGRpYWxvZyBpcyBvcGVuZWQuCi8vCi8vIEBwYXJhbSB7ZnVuY3Rpb259IGFjY2Vzc0RpYWxvZ0Nsb3NlZAovLyAgICAgIENhbGxlZCB3aGVuIHRoZSBhY2Nlc3MgYWxsb3cvZGVueSBkaWFsb2cgaXMgY2xvc2VkLgovLwovLyBAcGFyYW0ge2Z1bmN0aW9ufSBhY2Nlc3NEZW5pZWQKLy8gICAgICBDYWxsZWQgd2hlbiBhY2Nlc3MgaXMgZGVuaWVkIHRvIHRoZSBjYW1lcmEvbWljLiBUaGlzIHdpbGwgYmUgZWl0aGVyIGJlY2F1c2UKLy8gICAgICB0aGUgdXNlciBoYXMgY2xpY2tlZCBkZW55IG9yIGJlY2F1c2UgYSBwYXJ0aWN1bGFyIG9yaWdpbiBpcyBwZXJtYW5lbnRseSBkZW5pZWQuCi8vCk9ULiQuZ2V0VXNlck1lZGlhID0gZnVuY3Rpb24oY29uc3RyYWludHMsIHN1Y2Nlc3MsIGZhaWx1cmUsIGFjY2Vzc0RpYWxvZ09wZW5lZCwgYWNjZXNzRGlhbG9nQ2xvc2VkLCBhY2Nlc3NEZW5pZWQpIHsKICAgIC8vIEFsbCBjb25zdHJhaW50cyBhcmUgZmFsc2UsIHdlIGRvbid0IGFsbG93IHRoaXMuIFRoaXMgbWF5IGJlIHZhbGlkIGxhdGVyCiAgICAvLyBkZXBlbmRpbmcgb24gaG93L2lmIHdlIGludGVncmF0ZSBkYXRhIGNoYW5uZWxzLgogICAgaWYgKGFyZUludmFsaWRDb25zdHJhaW50cyhjb25zdHJhaW50cykpIHsKICAgICAgICBPVC5lcnJvcigiQ291bGRuJ3QgZ2V0IFVzZXJNZWRpYTogQWxsIGNvbnN0cmFpbnRzIHdlcmUgZmFsc2UiKTsKICAgICAgICAvLyBVc2luZyBhIHVnbHkgZHVtbXktY29kZSBmb3Igbm93LgogICAgICAgIGZhaWx1cmUuY2FsbChudWxsLCB7CiAgICAgICAgICAgIG5hbWU6ICdOT19WQUxJRF9DT05TVFJBSU5UUycsCiAgICAgICAgICAgIG1lc3NhZ2U6ICJWaWRlbyBhbmQgQXVkaW8gd2FzIGRpc2FibGVkLCB5b3UgbmVlZCB0byBlbmFibGVkIGF0IGxlYXN0IG9uZSIKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB0cmlnZ2VyT3BlbmVkVGltZXIgPSBudWxsLAogICAgICAgIGRpc3BsYXllZFBlcm1pc3Npb25EaWFsb2cgPSBmYWxzZSwKCiAgICAgICAgZmluYWxpc2VBY2Nlc3NEaWFsb2cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRyaWdnZXJPcGVuZWRUaW1lcikgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRyaWdnZXJPcGVuZWRUaW1lcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXNwbGF5ZWRQZXJtaXNzaW9uRGlhbG9nICYmIGFjY2Vzc0RpYWxvZ0Nsb3NlZCkgYWNjZXNzRGlhbG9nQ2xvc2VkKCk7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlck9wZW5lZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cmlnZ2VyT3BlbmVkVGltZXIgPSBudWxsOwogICAgICAgICAgICBkaXNwbGF5ZWRQZXJtaXNzaW9uRGlhbG9nID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChhY2Nlc3NEaWFsb2dPcGVuZWQpIGFjY2Vzc0RpYWxvZ09wZW5lZCgpOwogICAgICAgIH0sCgogICAgICAgIG9uU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIGZpbmFsaXNlQWNjZXNzRGlhbG9nKCk7CiAgICAgICAgICAgIHN1Y2Nlc3MuY2FsbChudWxsLCBzdHJlYW0pOwogICAgICAgIH0sCgogICAgICAgIG9uRXJyb3IgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBmaW5hbGlzZUFjY2Vzc0RpYWxvZygpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBwYXJzZUVycm9yRXZlbnQoZXZlbnQpOwoKICAgICAgICAgICAgaWYgKGVycm9yLm5hbWUgPT09ICdQRVJNSVNTSU9OX0RFTklFRCcpIHsKICAgICAgICAgICAgICAgIGFjY2Vzc0RlbmllZC5jYWxsKG51bGwsIGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGZhaWx1cmUuY2FsbChudWxsLCBlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgIHRyeSB7CiAgICAgICAgZ2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzLCBvblN0cmVhbSwgb25FcnJvcik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgT1QuZXJyb3IoIkNvdWxkbid0IGdldCBVc2VyTWVkaWE6ICIgKyBlLnRvU3RyaW5nKCkpOwogICAgICAgIG9uRXJyb3IoKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gVGhlICJyZW1lbWJlciBtZSIgZnVuY3Rpb25hbGl0eSBvZiBXZWJSVEMgb25seSBmdW5jdGlvbnMgb3ZlciBIVFRQUywgaWYKICAgIC8vIHdlIGFyZW4ndCBvbiBIVFRQUyB0aGVuIHdlIHNob3VsZCBkZWZpbml0ZWx5IGJlIGRpc3BsYXlpbmcgdGhlIGFjY2VzcwogICAgLy8gZGlhbG9nLgogICAgLy8KICAgIC8vIElmIHdlIGFyZSBvbiBIVFRQUywgd2UnbGwgd2FpdCA1MDBtcyB0byBzZWUgaWYgd2UgZ2V0IGEgc3RyZWFtCiAgICAvLyBpbW1lZGlhdGVseS4gSWYgd2UgZG8gdGhlbiB0aGUgdXNlciBoYWQgY2xpY2tlZCAicmVtZW1iZXIgbWUiLiBPdGhlcndpc2UKICAgIC8vIHdlIGFzc3VtZSB0aGF0IHRoZSBhY2Nlc3NBbGxvd2VkIGRpYWxvZyBpcyB2aXNpYmxlLgogICAgLy8KICAgIC8vIEB0b2RvIGJlbmNobWFyayBhbmQgc2VlIGlmIDUwMG1zIGlzIGEgcmVhc29uYWJsZSBudW1iZXIuIEl0IHNlZW1zIGxpa2UKICAgIC8vIHdlIHNob3VsZCBrbm93IGEgbG90IHF1aWNrZXIuCiAgICAvLwogICAgaWYgKGxvY2F0aW9uLnByb3RvY29sLmluZGV4T2YoJ2h0dHBzJykgPT09IC0xKSB7CiAgICAgICAgLy8gRXhlY3V0ZSBhZnRlciwgdGhpcyBnaXZlcyB0aGUgY2xpZW50IGEgY2hhbmNlIHRvIGJpbmQgdG8gdGhlCiAgICAgICAgLy8gYWNjZXNzRGlhbG9nT3BlbmVkIGV2ZW50LgogICAgICAgIHNldFRpbWVvdXQodHJpZ2dlck9wZW5lZCwgMTAwKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vIHdhaXQgYSBzZWNvbmQgYW5kIHRoZW4gdHJpZ2dlciBhY2Nlc3NEaWFsb2dPcGVuZWQKICAgICAgICB0cmlnZ2VyT3BlbmVkVGltZXIgPSBzZXRUaW1lb3V0KHRyaWdnZXJPcGVuZWQsIDUwMCk7CiAgICB9Cn07CgoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKT1QuVmlkZW9PcmllbnRhdGlvbiA9IHsKICAgIFJPVEFURURfTk9STUFMOiAiT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZE5vcm1hbCIsCiAgICBST1RBVEVEX0xFRlQ6ICJPVFZpZGVvT3JpZW50YXRpb25Sb3RhdGVkTGVmdCIsCiAgICBST1RBVEVEX1JJR0hUOiAiT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZFJpZ2h0IiwKICAgIFJPVEFURURfVVBTSURFX0RPV046ICJPVFZpZGVvT3JpZW50YXRpb25Sb3RhdGVkVXBzaWRlRG93biIKfTsKCi8vCi8vCi8vICAgdmFyIF92aWRlb0VsZW1lbnQgPSBuZXcgT1QuVmlkZW9FbGVtZW50KHsKLy8gICAgIGZhbGxiYWNrVGV4dDogJ2JsYWgnCi8vICAgfSk7Ci8vCi8vICAgX3ZpZGVvRWxlbWVudC5vbih7Ci8vICAgICBzdHJlYW1Cb3VuZDogZnVuY3Rpb24oKSB7Li4ufSwKLy8gICAgIGxvYWRFcnJvcjogZnVuY3Rpb24oKSB7Li4ufSwKLy8gICAgIGVycm9yOiBmdW5jdGlvbigpIHsuLi59Ci8vICAgfSk7Ci8vCi8vICAgX3ZpZGVvRWxlbWVudC5iaW5kVG9TdHJlYW0od2ViUnRjU3RyZWFtKTsgICAgICAvLyA9PiBWaWRlb0VsZW1lbnQKLy8gICBfdmlkZW9FbGVtZW50LmFwcGVuZFRvKERPTUVsZW1lbnQpICAgICAgICAgICAgIC8vID0+IFZpZGVvRWxlbWVudAovLwovLyAgIF92aWRlb0VsZW1lbnQuc3RyZWFtICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gPT4gV2ViIFJUQyBzdHJlYW0KLy8gICBfdmlkZW9FbGVtZW50LmRvbUVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgIC8vID0+IERvbU5vZGUKLy8gICBfdmlkZW9FbGVtZW50LnBhcmVudEVsZW1lbnQgICAgICAgICAgICAgICAgICAgIC8vID0+IERvbU5vZGUKLy8KLy8gICBfdmlkZW9FbGVtZW50LmltZ0RhdGEgICAgICAgICAgICAgICAgICAgICAgICAgIC8vID0+IFBORyBEYXRhIHN0cmluZwovLwovLyAgIF92aWRlb0VsZW1lbnQub3JpZW50YXRpb24gPSBPVC5WaWRlb09yaWVudGF0aW9uLlJPVEFURURfTEVGVDsKLy8KLy8gICBfdmlkZW9FbGVtZW50LnVuYmluZFN0cmVhbSgpOwovLyAgIF92aWRlb0VsZW1lbnQuZGVzdHJveSgpICAgICAgICAgICAgICAgICAgICAgICAgLy8gPT4gQ29tcGxldGVseSBjbGVhbnMgdXAgYW5kIHJlbW92ZXMgdGhlIHZpZGVvIGVsZW1lbnQKLy8KLy8KT1QuVmlkZW9FbGVtZW50ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIF9zdHJlYW0sCiAgICAgICAgX2RvbUVsZW1lbnQsCiAgICAgICAgX3BhcmVudEVsZW1lbnQsCiAgICAgICAgX3N0cmVhbUJvdW5kID0gZmFsc2UsCiAgICAgICAgX3ZpZGVvRWxlbWVudE1vdmVkV2FybmluZyA9IGZhbHNlLAogICAgICAgIF9vcHRpb25zID0gT1QuJC5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgICAgICAgIGZhbGxiYWNrVGV4dDogJ1NvcnJ5LCBXZWIgUlRDIGlzIG5vdCBhdmFpbGFibGUgaW4geW91ciBicm93c2VyJwogICAgICAgIH0pOwoKCiAgICBPVC4kLmV2ZW50aW5nKHRoaXMpOwoKICAgIC8vLyBQcml2YXRlIEFQSQogICAgdmFyIF9vblZpZGVvRXJyb3IgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgcmVhc29uID0gIlRoZXJlIHdhcyBhbiB1bmV4cGVjdGVkIHByb2JsZW0gd2l0aCB0aGUgVmlkZW8gU3RyZWFtOiAiICsgdmlkZW9FbGVtZW50RXJyb3JDb2RlVG9TdHIoZXZlbnQudGFyZ2V0LmVycm9yLmNvZGUpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgbnVsbCwgcmVhc29uLCB0aGlzKTsKICAgICAgICB9LmJpbmQodGhpcyksCgogICAgICAgIF9vblN0cmVhbUJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIF9zdHJlYW1Cb3VuZCA9IHRydWU7CiAgICAgICAgICAgIF9kb21FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgX29uVmlkZW9FcnJvciwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3N0cmVhbUJvdW5kJywgdGhpcyk7CiAgICAgICAgfS5iaW5kKHRoaXMpLAoKICAgICAgICBfb25TdHJlYW1Cb3VuZEVycm9yID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignbG9hZEVycm9yJywgT1QuRXhjZXB0aW9uQ29kZXMuUDJQX0NPTk5FQ1RJT05fRkFJTEVELCByZWFzb24sIHRoaXMpOwogICAgICAgIH0uYmluZCh0aGlzKSwKCiAgICAgICAgLy8gVGhlIHZpZGVvIGVsZW1lbnQgcGF1c2VzIGl0c2VsZiB3aGVuIGl0J3MgcmVwYXJlbnRlZCwgdGhpcyBpcwogICAgICAgIC8vIHVuZm9ydHVuYXRlLiBUaGlzIGZ1bmN0aW9uIHBsYXlzIHRoZSB2aWRlbyBhZ2FpbiBhbmQgaXMgdHJpZ2dlcmVkCiAgICAgICAgLy8gb24gdGhlIHBhdXNlIGV2ZW50LgogICAgICAgIF9wbGF5VmlkZW9PblBhdXNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCFfdmlkZW9FbGVtZW50TW92ZWRXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICBPVC53YXJuKCJWaWRlbyBlbGVtZW50IHBhdXNlZCwgYXV0by1yZXN1bWluZy4gSWYgeW91IGludGVuZGVkIHRvIGRvIHRoaXMsIHVzZSBwdWJsaXNoVmlkZW8oZmFsc2UpIG9yIHN1YnNjcmliZVRvVmlkZW8oZmFsc2UpIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICBfdmlkZW9FbGVtZW50TW92ZWRXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfZG9tRWxlbWVudC5wbGF5KCk7CiAgICAgICAgfTsKCgogICAgX2RvbUVsZW1lbnQgPSBjcmVhdGVWaWRlb0VsZW1lbnQoX29wdGlvbnMuZmFsbGJhY2tUZXh0LCBfb3B0aW9ucy5hdHRyaWJ1dGVzKTsKCiAgICBfZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdwYXVzZScsIF9wbGF5VmlkZW9PblBhdXNlKTsKCiAgICAvLy8gUHVibGljIFByb3BlcnRpZXMKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsKICAgICAgICBzdHJlYW06IHtnZXQ6IGZ1bmN0aW9uKCkge3JldHVybiBfc3RyZWFtOyB9fSwKICAgICAgICBkb21FbGVtZW50OiB7Z2V0OiBmdW5jdGlvbigpIHtyZXR1cm4gX2RvbUVsZW1lbnQ7IH19LAogICAgICAgIHBhcmVudEVsZW1lbnQ6IHtnZXQ6IGZ1bmN0aW9uKCkge3JldHVybiBfcGFyZW50RWxlbWVudDsgfX0sCiAgICAgICAgaXNCb3VuZFRvU3RyZWFtOiB7Z2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zdHJlYW1Cb3VuZDsgfX0sCiAgICAgICAgcG9zdGVyOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfZG9tRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3Bvc3RlcicpOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHNyYykgeyBfZG9tRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3Bvc3RlcicsIHNyYyk7IH0KICAgICAgICB9CiAgICB9KTsKCgogICAgLy8vIFB1YmxpYyBtZXRob2RzCgogICAgLy8gQXBwZW5kIHRoZSBWaWRlbyBET00gZWxlbWVudCB0byBhIHBhcmVudCBub2RlCiAgICB0aGlzLmFwcGVuZFRvID0gZnVuY3Rpb24ocGFyZW50RG9tRWxlbWVudCkgewogICAgICAgIF9wYXJlbnRFbGVtZW50ID0gcGFyZW50RG9tRWxlbWVudDsKICAgICAgICBfcGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZChfZG9tRWxlbWVudCk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvLyBCaW5kIGEgc3RyZWFtIHRvIHRoZSB2aWRlbyBlbGVtZW50LgogICAgdGhpcy5iaW5kVG9TdHJlYW0gPSBmdW5jdGlvbih3ZWJSdGNTdHJlYW0pIHsKICAgICAgICBfc3RyZWFtQm91bmQgPSBmYWxzZTsKICAgICAgICBfc3RyZWFtID0gd2ViUnRjU3RyZWFtOwoKICAgICAgICBiaW5kU3RyZWFtVG9WaWRlb0VsZW1lbnQoX2RvbUVsZW1lbnQsIF9zdHJlYW0sIF9vblN0cmVhbUJvdW5kLCBfb25TdHJlYW1Cb3VuZEVycm9yKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8vIFVuYmluZCB0aGUgY3VycmVudGx5IGJvdW5kIHN0cmVhbSBmcm9tIHRoZSB2aWRlbyBlbGVtZW50LgogICAgdGhpcy51bmJpbmRTdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIV9zdHJlYW0pIHJldHVybiB0aGlzOwoKICAgICAgICBpZiAoX2RvbUVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKCFuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgYnJvd3NlciB3b3VsZCBoYXZlIHJlbGVhc2VkIHRoaXMgb24gdW5sb2FkIGFueXdheSwgYnV0CiAgICAgICAgICAgICAgICAvLyB3ZSdyZSBiZWluZyBhIGdvb2QgY2l0aXplbi4KICAgICAgICAgICAgICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKF9kb21FbGVtZW50LnNyYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBfZG9tRWxlbWVudC5tb3pTcmNPYmplY3QgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RyZWFtID0gbnVsbDsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIHRoaXMuc2V0QXVkaW9Wb2x1bWUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmIChfZG9tRWxlbWVudCkgX2RvbUVsZW1lbnQudm9sdW1lID0gT1QuJC5yb3VuZEZsb2F0KHZhbHVlIC8gMTAwLCAyKTsKICAgIH07CgogICAgdGhpcy5nZXRBdWRpb1ZvbHVtZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFJldHVybiB0aGUgYWN0dWFsIHZvbHVtZSBvZiB0aGUgRE9NIGVsZW1lbnQKICAgICAgICBpZiAoX2RvbUVsZW1lbnQpIHJldHVybiBwYXJzZUludChfZG9tRWxlbWVudC52b2x1bWUgKiAxMDAsIDEwKTsKICAgICAgICByZXR1cm4gNTA7CiAgICB9OwoKICAgIHRoaXMud2hlblRpbWVJbmNyZW1lbnRzID0gZnVuY3Rpb24oY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICBpZihfZG9tRWxlbWVudCkgewogICAgICAgICAgICB2YXIgbGFzdFRpbWUsIGhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCFsYXN0VGltZSB8fCBsYXN0VGltZSA+PSBfZG9tRWxlbWVudC5jdXJyZW50VGltZSkgewogICAgICAgICAgICAgICAgICAgIGxhc3RUaW1lID0gX2RvbUVsZW1lbnQuY3VycmVudFRpbWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RpbWV1cGRhdGUnLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbChjb250ZXh0LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfS5iaW5kKHRoaXMpOwogICAgICAgICAgICBfZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0aW1ldXBkYXRlJywgaGFuZGxlciwgZmFsc2UpOwogICAgICAgIH0KICAgIH07CgogICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gdW5iaW5kIGFsbCBldmVudHMgc28gdGhleSBkb24ndCBmaXJlIGFmdGVyIHRoZSBvYmplY3QgaXMgZGVhZAogICAgICAgIHRoaXMub2ZmKCk7CgogICAgICAgIHRoaXMudW5iaW5kU3RyZWFtKCk7CgogICAgICAgIGlmIChfZG9tRWxlbWVudCkgewogICAgICAgICAgICAvLyBVbmJpbmQgdGhpcyBmaXJzdCwgb3RoZXJ3aXNlIGl0IHdpbGwgdHJpZ2dlciB3aGVuIHRoZQogICAgICAgICAgICAvLyB2aWRlbyBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgICAgICBfZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdwYXVzZScsIF9wbGF5VmlkZW9PblBhdXNlKTsKCiAgICAgICAgICAgIE9ULiQucmVtb3ZlRWxlbWVudChfZG9tRWxlbWVudCk7CiAgICAgICAgICAgIF9kb21FbGVtZW50ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIF9wYXJlbnRFbGVtZW50ID0gbnVsbDsKCiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07Cn07CgoKLy8gQ2hlY2tpbmcgZm9yIHdpbmRvdy5kZWZpbmVQcm9wZXJ0eSBmb3IgSUUgY29tcGF0aWJpbGl0eSwganVzdCBzbyB3ZSBkb24ndCB0aHJvdyBleGNlcHRpb25zIHdoZW4gdGhlIHNjcmlwdCBpcyBpbmNsdWRlZAppZiAoT1QuJC5jYW5EZWZpbmVQcm9wZXJ0eSkgewogICAgLy8gRXh0cmFjdHMgYSBzbmFwc2hvdCBmcm9tIGEgdmlkZW8gZWxlbWVudCBhbmQgcmV0dXJucyBpdCdzIGFzIGEgUE5HIERhdGEgc3RyaW5nLgogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoT1QuVmlkZW9FbGVtZW50LnByb3RvdHlwZSwgewogICAgICAgIGltZ0RhdGE6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBjYW52YXMgPSBPVC4kLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycsIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRoaXMuZG9tRWxlbWVudC52aWRlb1dpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuZG9tRWxlbWVudC52aWRlb0hlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjYW52YXMpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKS5kcmF3SW1hZ2UodGhpcy5kb21FbGVtZW50LCAwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgICAgICAgICAgICAgfSBjYXRjaChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBPVC53YXJuKCJDYW5ub3QgZ2V0IGltYWdlIGRhdGEgeWV0Iik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaW1nRGF0YSA9IGNhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpOwoKICAgICAgICAgICAgICAgIE9ULiQucmVtb3ZlRWxlbWVudChjYW52YXMpOwoKICAgICAgICAgICAgICAgIHJldHVybiBpbWdEYXRhLnJlcGxhY2UoImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCwiLCAiIikudHJpbSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdmlkZW9XaWR0aDogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYodGhpcy5fb3JpZW50YXRpb24gJiYgdGhpcy5fb3JpZW50YXRpb24ud2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fb3JpZW50YXRpb24ud2lkdGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50Wyd2aWRlbycgKyAodGhpcy5pc1JvdGF0ZWQgPyAnSGVpZ2h0JyA6ICdXaWR0aCcpXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHZpZGVvSGVpZ2h0OiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLl9vcmllbnRhdGlvbiAmJiB0aGlzLl9vcmllbnRhdGlvbi5oZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fb3JpZW50YXRpb24uaGVpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tRWxlbWVudFsndmlkZW8nICsgKHRoaXMuaXNSb3RhdGVkID8gJ1dpZHRoJyA6ICdIZWlnaHQnKV07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBhc3BlY3RSYXRpbzogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLnZpZGVvV2lkdGggKyAwLjApIC8gdGhpcy52aWRlb0hlaWdodDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGlzUm90YXRlZDogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29yaWVudGF0aW9uICYmICh0aGlzLl9vcmllbnRhdGlvbi52aWRlb09yaWVudGF0aW9uID09ICdPVFZpZGVvT3JpZW50YXRpb25Sb3RhdGVkTGVmdCcgfHwgdGhpcy5fb3JpZW50YXRpb24udmlkZW9PcmllbnRhdGlvbiA9PSAnT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZFJpZ2h0Jyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfQoKCnZhciBWaWRlb09yaWVudGF0aW9uVHJhbnNmb3JtcyA9IHsKICAgIE9UVmlkZW9PcmllbnRhdGlvblJvdGF0ZWROb3JtYWw6ICJyb3RhdGUoMGRlZykiLAogICAgT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZExlZnQ6ICJyb3RhdGUoOTBkZWcpIiwKICAgIE9UVmlkZW9PcmllbnRhdGlvblJvdGF0ZWRSaWdodDogInJvdGF0ZSgtOTBkZWcpIiwKICAgIE9UVmlkZW9PcmllbnRhdGlvblJvdGF0ZWRVcHNpZGVEb3duOiAicm90YXRlKDE4MGRlZykiCn07CgovLyBDaGVja2luZyBmb3Igd2luZG93LmRlZmluZVByb3BlcnR5IGZvciBJRSBjb21wYXRpYmlsaXR5LCBqdXN0IHNvIHdlIGRvbid0IHRocm93IGV4Y2VwdGlvbnMgd2hlbiB0aGUgc2NyaXB0IGlzIGluY2x1ZGVkCmlmIChPVC4kLmNhbkRlZmluZVByb3BlcnR5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoT1QuVmlkZW9FbGVtZW50LnByb3RvdHlwZSwnb3JpZW50YXRpb24nLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29yaWVudGF0aW9uOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihvcmllbnRhdGlvbikgewogICAgICAgICAgICB0aGlzLl9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoKICAgICAgICAgICAgdmFyIHRyYW5zZm9ybSA9IFZpZGVvT3JpZW50YXRpb25UcmFuc2Zvcm1zW29yaWVudGF0aW9uLnZpZGVvT3JpZW50YXRpb25dIHx8IFZpZGVvT3JpZW50YXRpb25UcmFuc2Zvcm1zLlJPVEFURURfTk9STUFMOwoKICAgICAgICAgICAgc3dpdGNoKE9ULiQuYnJvd3NlcigpKSB7CiAgICAgICAgICAgICAgICBjYXNlICdDaHJvbWUnOgogICAgICAgICAgICAgICAgY2FzZSAnU2FmYXJpJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbUVsZW1lbnQuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ0lFJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbUVsZW1lbnQuc3R5bGUubXNUcmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc3RhbmRhcmQgdmVyc2lvbiwganVzdCBGaXJlZm94LCBPcGVyYSwgYW5kIElFID4gOQogICAgICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignb3JpZW50YXRpb25DaGFuZ2VkJyk7CiAgICAgICAgfQogICAgfSk7Cn0KCgoKLy8vIFByaXZhdGUgSGVscGVyIGZ1bmN0aW9ucwoKZnVuY3Rpb24gY3JlYXRlVmlkZW9FbGVtZW50KGZhbGxiYWNrVGV4dCwgYXR0cmlidXRlcykgewogICAgdmFyIHZpZGVvRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3ZpZGVvJyk7CiAgICB2aWRlb0VsZW1lbnQuc2V0QXR0cmlidXRlKCdhdXRvcGxheScsICcnKTsKICAgIHZpZGVvRWxlbWVudC5pbm5lckhUTUwgPSBmYWxsYmFja1RleHQ7CgogICAgaWYgKGF0dHJpYnV0ZXMpIHsKICAgICAgICBpZiAoYXR0cmlidXRlcy5tdXRlZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICBkZWxldGUgYXR0cmlidXRlcy5tdXRlZDsKICAgICAgICAgICAgdmlkZW9FbGVtZW50Lm11dGVkID0gJ3RydWUnOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgdmlkZW9FbGVtZW50LnNldEF0dHJpYnV0ZShrZXksIGF0dHJpYnV0ZXNba2V5XSk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB2aWRlb0VsZW1lbnQ7Cn0KCgovLyBTZWUgaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMC9XRC1odG1sNS0yMDEwMTAxOS92aWRlby5odG1sI2Vycm9yLWNvZGVzCnZhciBfdmlkZW9FcnJvckNvZGVzID0ge307Ci8vIENoZWNraW5nIGZvciB3aW5kb3cuTWVkaWFFcnJvciBmb3IgSUUgY29tcGF0aWJpbGl0eSwganVzdCBzbyB3ZSBkb24ndCB0aHJvdyBleGNlcHRpb25zIHdoZW4gdGhlIHNjcmlwdCBpcyBpbmNsdWRlZAppZiAod2luZG93Lk1lZGlhRXJyb3IpIHsKICAgIF92aWRlb0Vycm9yQ29kZXNbd2luZG93Lk1lZGlhRXJyb3IuTUVESUFfRVJSX0FCT1JURURdID0gIlRoZSBmZXRjaGluZyBwcm9jZXNzIGZvciB0aGUgbWVkaWEgcmVzb3VyY2Ugd2FzIGFib3J0ZWQgYnkgdGhlIHVzZXIgYWdlbnQgYXQgdGhlIHVzZXIncyByZXF1ZXN0LiI7CiAgICBfdmlkZW9FcnJvckNvZGVzW3dpbmRvdy5NZWRpYUVycm9yLk1FRElBX0VSUl9ORVRXT1JLXSA9ICJBIG5ldHdvcmsgZXJyb3Igb2Ygc29tZSBkZXNjcmlwdGlvbiBjYXVzZWQgdGhlIHVzZXIgYWdlbnQgdG8gc3RvcCBmZXRjaGluZyB0aGUgbWVkaWEgcmVzb3VyY2UsIGFmdGVyIHRoZSByZXNvdXJjZSB3YXMgZXN0YWJsaXNoZWQgdG8gYmUgdXNhYmxlLiI7CiAgICBfdmlkZW9FcnJvckNvZGVzW3dpbmRvdy5NZWRpYUVycm9yLk1FRElBX0VSUl9ERUNPREVdID0gIkFuIGVycm9yIG9mIHNvbWUgZGVzY3JpcHRpb24gb2NjdXJyZWQgd2hpbGUgZGVjb2RpbmcgdGhlIG1lZGlhIHJlc291cmNlLCBhZnRlciB0aGUgcmVzb3VyY2Ugd2FzIGVzdGFibGlzaGVkIHRvIGJlIHVzYWJsZS4iOwogICAgX3ZpZGVvRXJyb3JDb2Rlc1t3aW5kb3cuTWVkaWFFcnJvci5NRURJQV9FUlJfU1JDX05PVF9TVVBQT1JURURdID0gIlRoZSBtZWRpYSByZXNvdXJjZSBpbmRpY2F0ZWQgYnkgdGhlIHNyYyBhdHRyaWJ1dGUgd2FzIG5vdCBzdWl0YWJsZS4gIjsKfQoKZnVuY3Rpb24gdmlkZW9FbGVtZW50RXJyb3JDb2RlVG9TdHIoZXJyb3JDb2RlKSB7CiAgICByZXR1cm4gX3ZpZGVvRXJyb3JDb2Rlc1twYXJzZUludChlcnJvckNvZGUsIDEwKV0gfHwgIkFuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuIjsKfQoKCmZ1bmN0aW9uIGJpbmRTdHJlYW1Ub1ZpZGVvRWxlbWVudCh2aWRlb0VsZW1lbnQsIHdlYlJUQ1N0cmVhbSwgb25TdHJlYW1Cb3VuZCwgb25TdHJlYW1Cb3VuZEVycm9yKSB7CiAgICAvLyBOb3RlOiBvbmxvYWRlZG1ldGFkYXRhIGRvZXNuJ3QgZmlyZSBpbiBDaHJvbWUgZm9yIGF1ZGlvIG9ubHkgY3JidWcuY29tLzExMDkzOAogICAgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEgfHwgKHdlYlJUQ1N0cmVhbS5nZXRWaWRlb1RyYWNrcygpLmxlbmd0aCA+IDAgJiYgd2ViUlRDU3RyZWFtLmdldFZpZGVvVHJhY2tzKClbMF0uZW5hYmxlZCkpIHsKCiAgICAgICAgdmFyIGNsZWFudXAgPSBmdW5jdGlvbiBjbGVhbnVwICgpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgIHZpZGVvRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkZWRtZXRhZGF0YScsIG9uTG9hZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgdmlkZW9FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgb25FcnJvciwgZmFsc2UpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Mb2FkID0gZnVuY3Rpb24gb25Mb2FkIChldmVudCkgewogICAgICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgICAgICAgb25TdHJlYW1Cb3VuZCgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25FcnJvciA9IGZ1bmN0aW9uIG9uRXJyb3IgKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgICAgICBvblN0cmVhbUJvdW5kRXJyb3IoIlRoZXJlIHdhcyBhbiB1bmV4cGVjdGVkIHByb2JsZW0gd2l0aCB0aGUgVmlkZW8gU3RyZWFtOiAiICsgdmlkZW9FbGVtZW50RXJyb3JDb2RlVG9TdHIoZXZlbnQudGFyZ2V0LmVycm9yLmNvZGUpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uU3RvcHBlZExvYWRpbmcgPSBmdW5jdGlvbiBvblN0b3BwZWRMb2FkaW5nICgpIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBzdHJlYW0gZW5kZWQgYmVmb3JlIHdlIGZ1bGx5IGJvdW5kIGl0LiBNYXliZSB0aGUgb3RoZXIgZW5kIGNhbGxlZAogICAgICAgICAgICAgICAgLy8gc3RvcCBvbiBpdCBvciBzb21ldGhpbmcgZWxzZSB3ZW50IHdyb25nLgogICAgICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgICAgICAgb25TdHJlYW1Cb3VuZEVycm9yKCJTdHJlYW0gZW5kZWQgd2hpbGUgdHJ5aW5nIHRvIGJpbmQgaXQgdG8gYSB2aWRlbyBlbGVtZW50LiIpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gVGltZW91dCBpZiBpdCB0YWtlcyB0b28gbG9uZwogICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh2aWRlb0VsZW1lbnQuY3VycmVudFRpbWUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBvblN0cmVhbUJvdW5kRXJyb3IoIlRoZSB2aWRlbyBzdHJlYW0gZmFpbGVkIHRvIGNvbm5lY3QuIFBsZWFzZSBub3RpZnkgdGhlIHNpdGUgb3duZXIgaWYgdGhpcyBjb250aW51ZXMgdG8gaGFwcGVuLiIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHNob3VsZCBuZXZlciBoYXBwZW4KICAgICAgICAgICAgICAgICAgICBPVC53YXJuKCJOZXZlciBnb3QgdGhlIGxvYWRlZG1ldGFkYXRhIGV2ZW50IGJ1dCBjdXJyZW50VGltZSA+IDAiKTsKICAgICAgICAgICAgICAgICAgICBvblN0cmVhbUJvdW5kKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSwgMzAwMDApOwoKCiAgICAgICAgdmlkZW9FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWRlZG1ldGFkYXRhJywgb25Mb2FkLCBmYWxzZSk7CiAgICAgICAgdmlkZW9FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgb25FcnJvciwgZmFsc2UpOwogICAgICAgIHdlYlJUQ1N0cmVhbS5vbmVuZGVkID0gb25TdG9wcGVkTG9hZGluZzsKICAgIH0gZWxzZSB7CiAgICAgICAgb25TdHJlYW1Cb3VuZCgpOwogICAgfQoKICAgIC8vIFRoZSBvZmZpY2lhbCBzcGVjIHdheSBpcyAnc3JjT2JqZWN0Jywgd2UgYXJlIHNsb3dseSBjb252ZXJnaW5nIHRoZXJlLgogICAgaWYgKHZpZGVvRWxlbWVudC5zcmNPYmplY3QgIT09IHZvaWQgMCkgewogICAgICAgIHZpZGVvRWxlbWVudC5zcmNPYmplY3QgPSB3ZWJSVENTdHJlYW07CiAgICB9CiAgICBlbHNlIGlmICh2aWRlb0VsZW1lbnQubW96U3JjT2JqZWN0ICE9PSB2b2lkIDApIHsKICAgICAgICB2aWRlb0VsZW1lbnQubW96U3JjT2JqZWN0ID0gd2ViUlRDU3RyZWFtOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdmlkZW9FbGVtZW50LnNyYyA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKHdlYlJUQ1N0cmVhbSk7CiAgICB9CgogICAgdmlkZW9FbGVtZW50LnBsYXkoKTsKfQoKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8vIFNpbmdsZXRvbiBpbnRlcnZhbAp2YXIgbG9nUXVldWUgPSBbXSwKICAgIHF1ZXVlUnVubmluZyA9IGZhbHNlOwoKCk9ULkFuYWx5dGljcyA9IGZ1bmN0aW9uKCkgewoKICAgIHZhciBlbmRQb2ludCA9IE9ULnByb3BlcnRpZXMubG9nZ2luZ1VSTCArICIvbG9nZ2luZy9DbGllbnRFdmVudCIsCiAgICAgICAgZW5kUG9pbnRRb3MgPSBPVC5wcm9wZXJ0aWVzLmxvZ2dpbmdVUkwgKyAiL2xvZ2dpbmcvQ2xpZW50UW9zIiwKCiAgICAgICAgcmVwb3J0ZWRFcnJvcnMgPSB7fSwKCiAgICAgICAgLy8gTWFwIG9mIGNhbWVsLWNhc2VkIGtleXMgdG8gdW5kZXJzY29yZWQKICAgICAgICBjYW1lbENhc2VkS2V5cyA9IHsKICAgICAgICAgICAgcGF5bG9hZFR5cGU6ICdwYXlsb2FkX3R5cGUnLAogICAgICAgICAgICBwYXJ0bmVySWQ6ICdwYXJ0bmVyX2lkJywKICAgICAgICAgICAgc3RyZWFtSWQ6ICdzdHJlYW1faWQnLAogICAgICAgICAgICBzZXNzaW9uSWQ6ICdzZXNzaW9uX2lkJywKICAgICAgICAgICAgY29ubmVjdGlvbklkOiAnY29ubmVjdGlvbl9pZCcsCiAgICAgICAgICAgIHdpZGdldFR5cGU6ICd3aWRnZXRfdHlwZScsCiAgICAgICAgICAgIHdpZGdldElkOiAnd2lkZ2V0X2lkJywKICAgICAgICAgICAgYXZnQXVkaW9CaXRyYXRlOiAnYXZnX2F1ZGlvX2JpdHJhdGUnLAogICAgICAgICAgICBhdmdWaWRlb0JpdHJhdGU6ICdhdmdfdmlkZW9fYml0cmF0ZScKICAgICAgICB9LAoKICAgICAgICBzZW5kID0gZnVuY3Rpb24oZGF0YSwgaXNRb3MsIG9uU3VjY2Vzcywgb25FcnJvcikgewogICAgICAgICAgICBPVC4kLnBvc3QoaXNRb3MgPyBlbmRQb2ludFFvcyA6IGVuZFBvaW50LCB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiBvblN1Y2Nlc3MsCiAgICAgICAgICAgICAgICBlcnJvcjogb25FcnJvciwKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIHRocm90dGxlZFBvc3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gVGhyb3R0bGUgbG9ncyBzbyB0aGF0IHRoZXkgb25seSBoYXBwZW4gMSBhdCBhIHRpbWUKICAgICAgICAgICAgaWYgKCFxdWV1ZVJ1bm5pbmcgJiYgbG9nUXVldWUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcXVldWVSdW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBjdXJyID0gbG9nUXVldWVbMF07CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBjdXJyZW50IGl0ZW0gYW5kIHNlbmQgdGhlIG5leHQgbG9nCiAgICAgICAgICAgICAgICB2YXIgcHJvY2Vzc05leHRJdGVtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgbG9nUXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICBxdWV1ZVJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aHJvdHRsZWRQb3N0KCk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmIChjdXJyKSB7CiAgICAgICAgICAgICAgICAgICAgc2VuZChjdXJyLmRhdGEsIGN1cnIuaXNRb3MsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyLm9uQ29tcGxldGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChwcm9jZXNzTmV4dEl0ZW0sIDUwKTsKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgT1QuZGVidWcoIkZhaWxlZCB0byBzZW5kIENsaWVudEV2ZW50LCBtb3Zpbmcgb24gdG8gdGhlIG5leHQgaXRlbS4iKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZXJlIHdhcyBhbiBlcnJvciwgbW92ZSBvbnRvIHRoZSBuZXh0IGl0ZW0KICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChwcm9jZXNzTmV4dEl0ZW0sIDUwKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHBvc3QgPSBmdW5jdGlvbihkYXRhLCBvbkNvbXBsZXRlLCBpc1FvcykgewogICAgICAgICAgICBsb2dRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlOiBvbkNvbXBsZXRlLAogICAgICAgICAgICAgICAgaXNRb3M6IGlzUW9zCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhyb3R0bGVkUG9zdCgpOwogICAgICAgIH0sCgogICAgICAgIHNob3VsZFRocm90dGxlRXJyb3IgPSBmdW5jdGlvbihjb2RlLCB0eXBlLCBwYXJ0bmVySWQpIHsKICAgICAgICAgICAgaWYgKCFwYXJ0bmVySWQpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHZhciBlcnJLZXkgPSBbcGFydG5lcklkLCB0eXBlLCBjb2RlXS5qb2luKCdfJyksCiAgICAgICAgICAgICAgICAvL21zZ0xpbWl0ID0gRHluYW1pY0NvbmZpZy5nZXQoJ2V4Y2VwdGlvbkxvZ2dpbmcnLCAnbWVzc2FnZUxpbWl0UGVyUGFydG5lcicsIHBhcnRuZXJJZCk7CiAgICAgICAgICAgICAgICBtc2dMaW1pdCA9IDEwMDsKICAgICAgICAgICAgaWYgKG1zZ0xpbWl0ID09PSBudWxsIHx8IG1zZ0xpbWl0ID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHJldHVybiAocmVwb3J0ZWRFcnJvcnNbZXJyS2V5XSB8fCAwKSA8PSBtc2dMaW1pdDsKICAgICAgICB9OwoKICAgICAgICAvLyBMb2cgYW4gZXJyb3IgdmlhIENsaWVudEV2ZW50cy4KICAgICAgICAvLwogICAgICAgIC8vIEBwYXJhbSBbU3RyaW5nXSBjb2RlCiAgICAgICAgLy8gQHBhcmFtIFtTdHJpbmddIHR5cGUKICAgICAgICAvLyBAcGFyYW0gW1N0cmluZ10gbWVzc2FnZQogICAgICAgIC8vIEBwYXJhbSBbSGFzaF0gZGV0YWlscyBhZGRpdGlvbmFsIGVycm9yIGRldGFpbHMKICAgICAgICAvLwogICAgICAgIC8vIEBwYXJhbSBbSGFzaF0gb3B0aW9ucyB0aGUgb3B0aW9ucyB0byBsb2cgdGhlIGNsaWVudCBldmVudCB3aXRoLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBhY3Rpb24gVGhlIG5hbWUgb2YgdGhlIEV2ZW50IHRoYXQgd2UgYXJlIGxvZ2dpbmcuIEUuZy4gIlRva1Nob3dMb2FkZWQiLiBSZXF1aXJlZC4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gdmFyaWF0aW9uIFVzdWFsbHkgdXNlZCBmb3IgU3BsaXQgQS9CIHRlc3RpbmcsIHdoZW4geW91IGhhdmUgbXVsdGlwbGUgdmFyaWF0aW9ucyBvZiB0aGUgK19hY3Rpb24rLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXlsb2FkVHlwZSBBIHRleHQgZGVzY3JpcHRpb24gb2YgdGhlIHBheWxvYWQuIFJlcXVpcmVkLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXlsb2FkIFRoZSBwYXlsb2FkLiBSZXF1aXJlZC4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gc2Vzc2lvbklkIFRoZSBhY3RpdmUgT3BlblRvayBzZXNzaW9uLCBpZiB0aGVyZSBpcyBvbmUKICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gY29ubmVjdGlvbklkIFRoZSBhY3RpdmUgT3BlblRvayBjb25uZWN0aW9uSWQsIGlmIHRoZXJlIGlzIG9uZQogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXJ0bmVySWQKICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gZ3VpZCAuLi4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gd2lkZ2V0SWQgLi4uCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIHN0cmVhbUlkIC4uLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBzZWN0aW9uIC4uLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBidWlsZCAuLi4KICAgICAgICAvLwogICAgICAgIC8vIFJlcG9ydHMgd2lsbCBiZSB0aHJvdHRsZWQgdG8gWCByZXBvcnRzIChzZWUgZXhjZXB0aW9uTG9nZ2luZy5tZXNzYWdlTGltaXRQZXJQYXJ0bmVyCiAgICAgICAgLy8gZnJvbSB0aGUgZHluYW1pYyBjb25maWcgZm9yIFgpIG9mIGVhY2ggZXJyb3IgdHlwZSBmb3IgZWFjaCBwYXJ0bmVyLiBSZXBvcnRzIGNhbiBiZQogICAgICAgIC8vIGRpc2FibGVkL2VuYWJsZWQgZ2xvYmFsbHkgb3Igb24gYSBwZXIgcGFydG5lciBiYXNpcyAocGVyIHBhcnRuZXIgc2V0dGluZ3MKICAgICAgICAvLyB0YWtlIHByZWNlZGVuY2UpIHVzaW5nIGV4Y2VwdGlvbkxvZ2dpbmcuZW5hYmxlZC4KICAgICAgICAvLwogICAgICAgIHRoaXMubG9nRXJyb3IgPSBmdW5jdGlvbihjb2RlLCB0eXBlLCBtZXNzYWdlLCBkZXRhaWxzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICB2YXIgcGFydG5lcklkID0gb3B0aW9ucy5wYXJ0bmVySWQ7CgogICAgICAgICAgICBpZiAoT1QuQ29uZmlnLmdldCgnZXhjZXB0aW9uTG9nZ2luZycsICdlbmFibGVkJywgcGFydG5lcklkKSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2hvdWxkVGhyb3R0bGVFcnJvcihjb2RlLCB0eXBlLCBwYXJ0bmVySWQpKSB7CiAgICAgICAgICAgICAgICAvL09ULmxvZygiQ2xpZW50RXZlbnRzLmVycm9yIGhhcyB0aHJvdHRsZWQgYW4gZXJyb3Igb2YgdHlwZSAiICsgdHlwZSArICIuIiArIGNvZGUgKyAiIGZvciBwYXJ0bmVyICIgKyAocGFydG5lcklkIHx8ICdObyBQYXJ0bmVyIElkJykpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZXJyS2V5ID0gW3BhcnRuZXJJZCwgdHlwZSwgY29kZV0uam9pbignXycpLAoKICAgICAgICAgICAgICAgIHBheWxvYWQgPSB0aGlzLmVzY2FwZVBheWxvYWQoT1QuJC5leHRlbmQoZGV0YWlscyB8fCB7fSwgewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgdXNlckFnZW50OiBuYXZpZ2F0b3IudXNlckFnZW50CiAgICAgICAgICAgICAgICB9KSk7CgoKICAgICAgICAgICAgcmVwb3J0ZWRFcnJvcnNbZXJyS2V5XSA9IHR5cGVvZihyZXBvcnRlZEVycm9yc1tlcnJLZXldKSAhPT0gJ3VuZGVmaW5lZCcgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcG9ydGVkRXJyb3JzW2VycktleV0gKyAxIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9nRXZlbnQoT1QuJC5leHRlbmQob3B0aW9ucywgewogICAgICAgICAgICAgICAgYWN0aW9uOiB0eXBlICsgJy4nICsgY29kZSwKICAgICAgICAgICAgICAgIHBheWxvYWRUeXBlOiBwYXlsb2FkWzBdLAogICAgICAgICAgICAgICAgcGF5bG9hZDogcGF5bG9hZFsxXQogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gTG9nIGEgY2xpZW50IGV2ZW50IHRvIHRoZSBhbmFseXRpY3MgYmFja2VuZC4KICAgICAgICAvLwogICAgICAgIC8vIEBleGFtcGxlIExvZ3MgYSBjbGllbnQgZXZlbnQgY2FsbGVkICdmb28nCiAgICAgICAgLy8gIE9ULkNsaWVudEV2ZW50cy5sb2coewogICAgICAgIC8vICAgICAgYWN0aW9uOiAnZm9vJywKICAgICAgICAvLyAgICAgIHBheWxvYWRfdHlwZTogImZvbydzIHBheWxvYWQiLAogICAgICAgIC8vICAgICAgcGF5bG9hZDogJ2JhcicsCiAgICAgICAgLy8gICAgICBzZXNzaW9uX2lkOiBzZXNzaW9uSWQsCiAgICAgICAgLy8gICAgICBjb25uZWN0aW9uX2lkOiBjb25uZWN0aW9uSWQKICAgICAgICAvLyAgfSkKICAgICAgICAvLwogICAgICAgIC8vIEBwYXJhbSBbSGFzaF0gb3B0aW9ucyB0aGUgb3B0aW9ucyB0byBsb2cgdGhlIGNsaWVudCBldmVudCB3aXRoLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBhY3Rpb24gVGhlIG5hbWUgb2YgdGhlIEV2ZW50IHRoYXQgd2UgYXJlIGxvZ2dpbmcuIEUuZy4gIlRva1Nob3dMb2FkZWQiLiBSZXF1aXJlZC4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gdmFyaWF0aW9uIFVzdWFsbHkgdXNlZCBmb3IgU3BsaXQgQS9CIHRlc3RpbmcsIHdoZW4geW91IGhhdmUgbXVsdGlwbGUgdmFyaWF0aW9ucyBvZiB0aGUgK19hY3Rpb24rLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXlsb2FkVHlwZSBBIHRleHQgZGVzY3JpcHRpb24gb2YgdGhlIHBheWxvYWQuIFJlcXVpcmVkLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBwYXlsb2FkIFRoZSBwYXlsb2FkLiBSZXF1aXJlZC4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gc2Vzc2lvbl9pZCBUaGUgYWN0aXZlIE9wZW5Ub2sgc2Vzc2lvbiwgaWYgdGhlcmUgaXMgb25lCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIGNvbm5lY3Rpb25faWQgVGhlIGFjdGl2ZSBPcGVuVG9rIGNvbm5lY3Rpb25JZCwgaWYgdGhlcmUgaXMgb25lCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIHBhcnRuZXJfaWQKICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gZ3VpZCAuLi4KICAgICAgICAvLyBAb3B0aW9uIG9wdGlvbnMgW1N0cmluZ10gd2lkZ2V0X2lkIC4uLgogICAgICAgIC8vIEBvcHRpb24gb3B0aW9ucyBbU3RyaW5nXSBzdHJlYW1faWQgLi4uCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIHNlY3Rpb24gLi4uCiAgICAgICAgLy8gQG9wdGlvbiBvcHRpb25zIFtTdHJpbmddIGJ1aWxkIC4uLgogICAgICAgIC8vCiAgICAgICAgdGhpcy5sb2dFdmVudCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHBhcnRuZXJJZCA9IG9wdGlvbnMucGFydG5lcklkOwoKICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CgogICAgICAgICAgICAvLyBTZXQgYSBidW5jaCBvZiBkZWZhdWx0cwogICAgICAgICAgICB2YXIgZGF0YSA9IE9ULiQuZXh0ZW5kKHsKICAgICAgICAgICAgICAgICAgICAidmFyaWF0aW9uIiA6ICIiLAogICAgICAgICAgICAgICAgICAgICdndWlkJyA6IHRoaXMuZ2V0Q2xpZW50R3VpZCgpLAogICAgICAgICAgICAgICAgICAgICd3aWRnZXRfaWQnIDogIiIsCiAgICAgICAgICAgICAgICAgICAgJ3Nlc3Npb25faWQnOiAnJywKICAgICAgICAgICAgICAgICAgICAnY29ubmVjdGlvbl9pZCc6ICcnLAogICAgICAgICAgICAgICAgICAgICdzdHJlYW1faWQnIDogIiIsCiAgICAgICAgICAgICAgICAgICAgJ3BhcnRuZXJfaWQnIDogcGFydG5lcklkLAogICAgICAgICAgICAgICAgICAgICdzb3VyY2UnIDogd2luZG93LmxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgICAgICAgICAgJ3NlY3Rpb24nIDogIiIsCiAgICAgICAgICAgICAgICAgICAgJ2J1aWxkJyA6ICIiCiAgICAgICAgICAgICAgICB9LCBvcHRpb25zKSwKCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIC8vICBPVC5sb2coImxvZ2dlZDogIiArICJ7YWN0aW9uOiAiICsgZGF0YVsiYWN0aW9uIl0gKyAiLCB2YXJpYXRpb246ICIgKyBkYXRhWyJ2YXJpYXRpb24iXSArICIsIHBheWxvYWRfdHlwZTogIiArIGRhdGFbInBheWxvYWRfdHlwZSJdICsgIiwgcGF5bG9hZDogIiArIGRhdGFbInBheWxvYWQiXSArICJ9Iik7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2UgY2FtZWwtY2FzZSBvdXIgbmFtZXMsIGJ1dCB0aGUgQ2xpZW50RXZlbnRzIGJhY2tlbmQgd2FudHMgdGhlbQogICAgICAgICAgICAvLyB1bmRlcnNjb3JlZC4uLgogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY2FtZWxDYXNlZEtleXMpIHsKICAgICAgICAgICAgICAgIGlmIChjYW1lbENhc2VkS2V5cy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGRhdGFba2V5XSkgewogICAgICAgICAgICAgICAgICAgIGRhdGFbY2FtZWxDYXNlZEtleXNba2V5XV0gPSBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcG9zdChkYXRhLCBvbkNvbXBsZXRlLCBmYWxzZSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gTG9nIGEgY2xpZW50IFFPUyB0byB0aGUgYW5hbHl0aWNzIGJhY2tlbmQuCiAgICAgICAgLy8KICAgICAgICB0aGlzLmxvZ1FPUyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHBhcnRuZXJJZCA9IG9wdGlvbnMucGFydG5lcklkOwoKICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CgogICAgICAgICAgICAvLyBTZXQgYSBidW5jaCBvZiBkZWZhdWx0cwogICAgICAgICAgICB2YXIgZGF0YSA9IE9ULiQuZXh0ZW5kKHsKICAgICAgICAgICAgICAgICAgICAnZ3VpZCcgOiB0aGlzLmdldENsaWVudEd1aWQoKSwKICAgICAgICAgICAgICAgICAgICAnd2lkZ2V0X2lkJyA6ICIiLAogICAgICAgICAgICAgICAgICAgICdzZXNzaW9uX2lkJzogJycsCiAgICAgICAgICAgICAgICAgICAgJ2Nvbm5lY3Rpb25faWQnOiAnJywKICAgICAgICAgICAgICAgICAgICAnc3RyZWFtX2lkJyA6ICIiLAogICAgICAgICAgICAgICAgICAgICdwYXJ0bmVyX2lkJyA6IHBhcnRuZXJJZCwKICAgICAgICAgICAgICAgICAgICAnc291cmNlJyA6IHdpbmRvdy5sb2NhdGlvbi5ocmVmLAogICAgICAgICAgICAgICAgICAgICdidWlsZCcgOiAiIiwKICAgICAgICAgICAgICAgICAgICAnZHVyYXRpb24nIDogMCAvL2luIG1pbGxpc2Vjb25kcwogICAgICAgICAgICAgICAgfSwgb3B0aW9ucyksCgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgLy9PVC5sb2coImxvZ2dlZDogIiArICJ7YWN0aW9uOiAiICsgZGF0YVsiYWN0aW9uIl0gKyAiLCB2YXJpYXRpb246ICIgKyBkYXRhWyJ2YXJpYXRpb24iXSArICIsIHBheWxvYWRfdHlwZTogIiArIGRhdGFbInBheWxvYWRfdHlwZSJdICsgIiwgcGF5bG9hZDogIiArIGRhdGFbInBheWxvYWQiXSArICJ9Iik7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2UgY2FtZWwtY2FzZSBvdXIgbmFtZXMsIGJ1dCB0aGUgQ2xpZW50RXZlbnRzIGJhY2tlbmQgd2FudHMgdGhlbQogICAgICAgICAgICAvLyB1bmRlcnNjb3JlZC4uLgogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY2FtZWxDYXNlZEtleXMpIHsKICAgICAgICAgICAgICAgIGlmIChjYW1lbENhc2VkS2V5cy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGRhdGFba2V5XSkgewogICAgICAgICAgICAgICAgICAgIGRhdGFbY2FtZWxDYXNlZEtleXNba2V5XV0gPSBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcG9zdChkYXRhLCBvbkNvbXBsZXRlLCB0cnVlKTsKICAgICAgICB9OwoKICAgICAgICAvLyBDb252ZXJ0cyArcGF5bG9hZCsgdG8gdHdvIHBpcGUgc2VwZXJhdGVkIHN0cmluZ3MuIERvZXNuJ3QgY3VycmVudGx5IGhhbmRsZQogICAgICAgIC8vIGVkZ2VjYXNlcywgZS5nLiBlc2NhcGluZyAiXFx8IiB3aWxsIGJyZWFrIHN0dWZmLgogICAgICAgIC8vCiAgICAgICAgLy8gKk5vdGU6KiBJdCBzdHJpcCBhbnkga2V5cyB0aGF0IGhhdmUgbnVsbCB2YWx1ZXMuCiAgICAgICAgdGhpcy5lc2NhcGVQYXlsb2FkID0gZnVuY3Rpb24ocGF5bG9hZCkgewogICAgICAgICAgICB2YXIgZXNjYXBlZFBheWxvYWQgPSBbXSwKICAgICAgICAgICAgICAgIGVzY2FwZWRQYXlsb2FkRGVzYyA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHBheWxvYWQpIHsKICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLmhhc093blByb3BlcnR5KGtleSkgJiYgcGF5bG9hZFtrZXldICE9PSBudWxsICYmIHBheWxvYWRba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgZXNjYXBlZFBheWxvYWQucHVzaCggcGF5bG9hZFtrZXldID8gcGF5bG9hZFtrZXldLnRvU3RyaW5nKCkucmVwbGFjZSgnfCcsICdcXHwnKSA6ICcnICk7CiAgICAgICAgICAgICAgICAgICAgZXNjYXBlZFBheWxvYWREZXNjLnB1c2goIGtleS50b1N0cmluZygpLnJlcGxhY2UoJ3wnLCAnXFx8JykgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIGVzY2FwZWRQYXlsb2FkRGVzYy5qb2luKCd8JyksCiAgICAgICAgICAgICAgICBlc2NhcGVkUGF5bG9hZC5qb2luKCd8JykKICAgICAgICAgICAgXTsKICAgICAgICB9OwogICAgICAgIC8vIFVzZXMgSFRNTDUgbG9jYWwgc3RvcmFnZSB0byBzYXZlIGEgY2xpZW50IElELgogICAgICAgIHRoaXMuZ2V0Q2xpZW50R3VpZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgIGd1aWQgPSBPVC4kLmdldENvb2tpZSgib3BlbnRva19jbGllbnRfaWQiKTsKICAgICAgICAgICAgaWYgKCFndWlkKSB7CiAgICAgICAgICAgICAgICBndWlkID0gT1QuJC51dWlkKCk7CiAgICAgICAgICAgICAgICBPVC4kLnNldENvb2tpZSgib3BlbnRva19jbGllbnRfaWQiLCBndWlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ3VpZDsKICAgICAgICB9Owp9Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7CgovLyBUaGlzIGlzIG5vdCBvYnZpb3VzLCBzbyB0byBwcmV2ZW50IGVuZC11c2VyIGZydXN0cmF0aW9uIHdlJ2xsIGxldCB0aGVtIGtub3cKLy8gZXhwbGljaXRseSByYXRoZXIgdGhhbiBmYWlsaW5nIHdpdGggYSBidW5jaCBvZiBwZXJtaXNzaW9uIGVycm9ycy4gV2UgZG9uJ3QKLy8gaGFuZGxlIHRoaXMgdXNpbmcgYW4gT1QgRXhjZXB0aW9uIGFzIGl0J3MgcmVhbGx5IG9ubHkgYSBkZXZlbG9wbWVudCB0aGluZy4KaWYgKGxvY2F0aW9uLnByb3RvY29sID09PSAnZmlsZTonKSB7CiAgYWxlcnQoIllvdSBjYW5ub3QgdGVzdCBhIHBhZ2UgdXNpbmcgV2ViUlRDIHRocm91Z2ggdGhlIGZpbGUgc3lzdGVtIGR1ZSB0byBicm93c2VyIHBlcm1pc3Npb25zLiBZb3UgbXVzdCBydW4gaXQgb3ZlciBhIHdlYiBzZXJ2ZXIuIik7Cn0KCmlmICghd2luZG93Lk9UKSB3aW5kb3cuT1QgPSB7fTsKCmlmICghd2luZG93LlVSTCAmJiB3aW5kb3cud2Via2l0VVJMKSB7CiAgICB3aW5kb3cuVVJMID0gd2luZG93LndlYmtpdFVSTDsKfQoKdmFyIF9wdWJsaXNoZXJDb3VudCA9IDAsCgogICAgLy8gR2xvYmFsIHBhcmFtZXRlcnMgdXNlZCBieSB1cGdyYWRlU3lzdGVtUmVxdWlyZW1lbnRzCiAgICBfaW50ZXJ2YWxJZCwKICAgIF9sYXN0SGFzaCA9IGRvY3VtZW50LmxvY2F0aW9uLmhhc2gsCgogICAgLy8gQ2FjaGVkIERldmljZU1hbmFnZXIKICAgIF9kZXZpY2VNYW5hZ2VyOwoKCi8qKgoqIFRoZSBmaXJzdCBzdGVwIGluIHVzaW5nIHRoZSBPcGVuVG9rIEFQSSBpcyB0byBjYWxsIHRoZSA8Y29kZT5UQi5pbml0U2Vzc2lvbigpPC9jb2RlPiBtZXRob2QuIE90aGVyIG1ldGhvZHMgb2YgdGhlIFRCIG9iamVjdAoqIGNoZWNrIGZvciBzeXN0ZW0gcmVxdWlyZW1lbnRzIGFuZCBzZXQgdXAgZXJyb3IgbG9nZ2luZy4KKgoqIEBjbGFzcyBUQgoqLwoKLyoqCiogPHAgY2xhc3M9Im1TdW1tYXJ5Ij4KKiBJbml0aWFsaXplcyBhbmQgcmV0dXJucyB0aGUgbG9jYWwgc2Vzc2lvbiBvYmplY3QgZm9yIGEgc3BlY2lmaWVkIHNlc3Npb24gSUQuCiogPC9wPgoqIDxwPgoqIFlvdSBjb25uZWN0IHRvIGFuIE9wZW5Ub2sgc2Vzc2lvbiB1c2luZyB0aGUgPGNvZGU+Y29ubmVjdCgpPC9jb2RlPiBtZXRob2QKKiBvZiB0aGUgU2Vzc2lvbiBvYmplY3QgcmV0dXJuZWQgYnkgdGhlIDxjb2RlPlRCLmluaXRTZXNzaW9uKCk8L2NvZGU+IG1ldGhvZC4KKiBOb3RlIHRoYXQgY2FsbGluZyA8Y29kZT5UQi5pbml0U2Vzc2lvbigpPC9jb2RlPiBkb2VzIG5vdCBpbml0aWF0ZSBjb21tdW5pY2F0aW9ucwoqIHdpdGggdGhlIGNsb3VkLiBJdCBzaW1wbHkgaW5pdGlhbGl6ZXMgdGhlIFNlc3Npb24gb2JqZWN0IHRoYXQgeW91IGNhbiB1c2UgdG8KKiBjb25uZWN0IChhbmQgdG8gcGVyZm9ybSBvdGhlciBvcGVyYXRpb25zIG9uY2UgY29ubmVjdGVkKS4KKiA8L3A+CioKKiAgPHA+CiogICAgRm9yIGFuIGV4YW1wbGUsIHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjY29ubmVjdCI+U2Vzc2lvbi5jb25uZWN0KCk8L2E+LgoqICA8L3A+CioKKiBAbWV0aG9kIFRCLmluaXRTZXNzaW9uCiogQG1lbWJlcm9mIFRCCiogQHBhcmFtIHtTdHJpbmd9IHNlc3Npb25JZCBUaGUgc2Vzc2lvbiBJRCBpZGVudGlmeWluZyB0aGUgT3BlblRvayBzZXNzaW9uLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlCiogPGEgaHJlZj0iL29wZW50b2svdHV0b3JpYWxzL2NyZWF0ZS1zZXNzaW9uLyI+U2Vzc2lvbiBjcmVhdGlvbjwvYT4uCiogQHJldHVybnMge1Nlc3Npb259IFRoZSBzZXNzaW9uIG9iamVjdCB0aHJvdWdoIHdoaWNoIGFsbCBmdXJ0aGVyIGludGVyYWN0aW9ucyB3aXRoIHRoZSBzZXNzaW9uIHdpbGwgb2NjdXIuCiovCk9ULmluaXRTZXNzaW9uID0gZnVuY3Rpb24oc2Vzc2lvbklkKSB7CiAgICB2YXIgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChzZXNzaW9uSWQpOwoKICAgIGlmICghc2Vzc2lvbikgewogICAgICAgIHNlc3Npb24gPSBuZXcgT1QuU2Vzc2lvbihzZXNzaW9uSWQpOwogICAgICAgIE9ULnNlc3Npb25zLmFkZChzZXNzaW9uKTsKICAgIH0KCiAgICByZXR1cm4gc2Vzc2lvbjsKfTsKCi8qKgoqIDxwIGNsYXNzPSJtU3VtbWFyeSI+CiogICBJbml0aWFsaXplcyBhbmQgcmV0dXJucyBhIFB1Ymxpc2hlciBvYmplY3QuIFlvdSBjYW4gdGhlbiBwYXNzIHRoaXMgUHVibGlzaGVyCiogICBvYmplY3QgdG8gPGNvZGU+U2Vzc2lvbi5wdWJsaXNoKCk8L2NvZGU+IHRvIHB1Ymxpc2ggYSBzdHJlYW0gdG8gYSBzZXNzaW9uLgoqIDwvcD4KKiA8cD4KKiAgIDxpPk5vdGU6PC9pPiBJZiB5b3UgaW50ZW5kIHRvIHJldXNlIGEgUHVibGlzaGVyIG9iamVjdCBjcmVhdGVkIHVzaW5nIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4KKiAgIHRvIHB1Ymxpc2ggdG8gZGlmZmVyZW50IHNlc3Npb25zIHNlcXVlbnRpYWxseSwgY2FsbCBlaXRoZXIgPGNvZGU+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2NvZGU+IG9yCiogICA8Y29kZT5TZXNzaW9uLnVucHVibGlzaCgpPC9jb2RlPi4gRG8gbm90IGNhbGwgYm90aC4gVGhlbiBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2QKKiAgIG9mIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IG9yIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0ZWQ8L2NvZGU+IGV2ZW50IG9iamVjdCB0byBwcmV2ZW50IHRoZQoqICAgUHVibGlzaGVyIG9iamVjdCBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcGFnZS4KKiA8L3A+CiogQHBhcmFtIHtTdHJpbmd9IGFwaUtleSBUaGUgQVBJIGtleSB0aGF0IFRva0JveCBwcm92aWRlZCB5b3Ugd2hlbiB5b3UKKiA8YSBocmVmPSJodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3VzZXJzL3NpZ25faW4iPnNpZ25lZCB1cDwvYT4gZm9yIGFuIE9wZW5Ub2sgYWNjb3VudC4KKiBAcGFyYW0ge1N0cmluZ30gdGFyZ2V0RWxlbWVudCBUaGUKKiA8Y29kZT5pZDwvY29kZT4gYXR0cmlidXRlIG9mIHRoZSBleGlzdGluZyBET00gZWxlbWVudCB0aGF0IHRoZSBQdWJsaXNoZXIgdmlkZW8gcmVwbGFjZXMuCiogSWYgeW91IGRvIG5vdCBzcGVjaWZ5IGEgPGNvZGU+dGFyZ2V0RWxlbWVudDwvY29kZT4sIHRoZSBhcHBsaWNhdGlvbgoqIGFwcGVuZHMgYSBuZXcgRE9NIGVsZW1lbnQgdG8gdGhlIEhUTUwgPGNvZGU+Ym9keTwvY29kZT4uCioKKiA8cD4KKiAgICAgICBUaGUgYXBwbGljYXRpb24gdGhyb3dzIGFuIGVycm9yIGlmIGFuIGVsZW1lbnQgd2l0aCBhbiBJRCBzZXQgdG8gdGhlIDxjb2RlPnRhcmdldEVsZW1lbnQ8L2NvZGU+CiogICAgICAgdmFsdWUgZG9lcyBub3QgZXhpc3QgaW4gdGhlIEhUTUwgRE9NLgoqIDwvcD4KKgoqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0aWVzIFRoaXMgaXMKKiBhbiA8ZW0+b3B0aW9uYWw8L2VtPiBvYmplY3QgdGhhdCBjb250YWlucyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXMgKGVhY2ggb2Ygd2hpY2ggYXJlIG9wdGlvbmFsKToKKiA8L3A+CiogPHVsPgoqIDxsaT4KKiAgIDxzdHJvbmc+aGVpZ2h0PC9zdHJvbmc+IChOdW1iZXIpICYjMTUxOyBUaGUgZGVzaXJlZCBoZWlnaHQsIGluIHBpeGVscywgb2YgdGhlCiogICBkaXNwbGF5ZWQgUHVibGlzaGVyIHZpZGVvIHN0cmVhbSAoZGVmYXVsdDogMTk4KS4gPGk+Tm90ZTo8L2k+IFVzZSB0aGUKKiAgIDxjb2RlPmhlaWdodDwvY29kZT4gYW5kIDxjb2RlPndpZHRoPC9jb2RlPiBwcm9wZXJ0aWVzIHRvIHNldCB0aGUgZGltZW5zaW9ucwoqICAgb2YgdGhlIHB1Ymxpc2hlciB2aWRlbzsgZG8gbm90IHNldCB0aGUgaGVpZ2h0IGFuZCB3aWR0aCBvZiB0aGUgRE9NIGVsZW1lbnQKKiAgICh1c2luZyBDU1MpLgoqIDwvbGk+CiogPGxpPgoqICAgPHN0cm9uZz5taXJyb3I8L3N0cm9uZz4gKEJvb2xlYW4pICYjMTUxOyBXaGV0aGVyIHRoZSBwdWJsaXNoZXIncyB2aWRlbyBpbWFnZQoqICAgaXMgbWlycm9yZWQgaW4gdGhlIHB1Ymxpc2hlcidzIHBhZ2U8LiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyA8Y29kZT50cnVlPC9jb2RlPgoqICAgKHRoZSB2aWRlbyBpbWFnZSBpcyBtaXJyb3JlZCkuIFRoaXMgcHJvcGVydHkgZG9lcyBub3QgYWZmZWN0IHRoZSBkaXNwbGF5CiogICBvbiBvdGhlciBzdWJzY3JpYmVycycgd2ViIHBhZ2VzLgoqIDwvbGk+CiogPGxpPgoqICAgPHN0cm9uZz5uYW1lPC9zdHJvbmc+IChTdHJpbmcpICYjMTUxOyBUaGUgbmFtZSBmb3IgdGhpcyBzdHJlYW0uIFRoZSBuYW1lIGFwcGVhcnMgYXQgdGhlIGJvdHRvbSBvZgoqICAgU3Vic2NyaWJlciB2aWRlb3MuIFRoZSBkZWZhdWx0IHZhbHVlIGlzICIiIChhbiBlbXB0eSBzdHJpbmcpLiBTZXR0aW5nIHRoaXMgdG8gYSBzdHJpbmcgbG9uZ2VyIHRoYW4KKiAgIDEwMDAgY2hhcmFjdGVycyByZXN1bHRzIGluIGFuIHJ1bnRpbWUgZXhjZXB0aW9uLgoqIDwvbGk+CiogPGxpPgoqICAgPHN0cm9uZz5wdWJsaXNoQXVkaW88L3N0cm9uZz4gKEJvb2xlYW4pICYjMTUxOyBXaGV0aGVyIHRvIGluaXRpYWxseSBwdWJsaXNoIGF1ZGlvCiogICBmb3IgdGhlIHN0cmVhbSAoZGVmYXVsdDogPGNvZGU+dHJ1ZTwvY29kZT4pLiBUaGlzIHNldHRpbmcgYXBwbGllcyB3aGVuIHlvdSBwYXNzCiogICB0aGUgUHVibGlzaGVyIG9iamVjdCBpbiBhIGNhbGwgdG8gdGhlIDxjb2RlPlNlc3Npb24ucHVibGlzaCgpPC9jb2RlPiBtZXRob2QuCiogPC9saT4KKiA8bGk+CiogICA8c3Ryb25nPnB1Ymxpc2hWaWRlbzwvc3Ryb25nPiAoQm9vbGVhbikgJiMxNTE7IFdoZXRoZXIgdG8gaW5pdGlhbGx5IHB1Ymxpc2ggdmlkZW8KKiAgIGZvciB0aGUgc3RyZWFtIChkZWZhdWx0OiA8Y29kZT50cnVlPC9jb2RlPikuIFRoaXMgc2V0dGluZyBhcHBsaWVzIHdoZW4geW91IHBhc3MKKiAgIHRoZSBQdWJsaXNoZXIgb2JqZWN0IGluIGEgY2FsbCB0byB0aGUgPGNvZGU+U2Vzc2lvbi5wdWJsaXNoKCk8L2NvZGU+IG1ldGhvZC4KKiA8L2xpPgoqIDxsaT4KKiAgIDxzdHJvbmc+c3R5bGU8L3N0cm9uZz4gKE9iamVjdCkgJiMxNTE7IEFuIG9iamVjdCBjb250YWluaW5nIHByb3BlcnRpZXMgdGhhdCBkZWZpbmUgdGhlIGluaXRpYWwKKiAgIGFwcGVhcmFuY2Ugb2YgdXNlciBpbnRlcmZhY2UgY29udHJvbHMgb2YgdGhlIFB1Ymxpc2hlci4gQ3VycmVudGx5LCB0aGUgPGNvZGU+c3R5bGU8L2NvZGU+IG9iamVjdAoqICAgaW5jbHVkZXMgb25lIHByb3BlcnR5OiA8Y29kZT5uYW1lRGlzcGxheU1vZGU8L2NvZGU+LiBQb3NzaWJsZSB2YWx1ZXMgZm9yIHRoZSA8Y29kZT5zdHlsZS5uYW1lRGlzcGxheU1vZGU8L2NvZGU+CiogICBwcm9wZXJ0eSBhcmU6IDxjb2RlPiJhdXRvIjwvY29kZT4gKHRoZSBuYW1lIGlzIGRpc3BsYXllZCB3aGVuIHRoZSBzdHJlYW0gaXMgZmlyc3QgZGlzcGxheWVkCiogICBhbmQgd2hlbiB0aGUgdXNlciBtb3VzZXMgb3ZlciB0aGUgZGlzcGxheSksIDxjb2RlPiJvZmYiPC9jb2RlPiAodGhlIG5hbWUgaXMgbm90IGRpc3BsYXllZCksCiogICBhbmQgPGNvZGU+Im9uIjwvY29kZT4gKHRoZSBuYW1lIGlzIGRpc3BsYXllZCkuPC9saT4KKiA8L2xpPgoqIDxsaT4KKiAgIDxzdHJvbmc+d2lkdGg8L3N0cm9uZz4gKE51bWJlcikgJiMxNTE7IFRoZSBkZXNpcmVkIHdpZHRoLCBpbiBwaXhlbHMsIG9mIHRoZQoqICAgZGlzcGxheWVkIFB1Ymxpc2hlciB2aWRlbyBzdHJlYW0gKGRlZmF1bHQ6IDI2NCkuIDxpPk5vdGU6PC9pPiBVc2UgdGhlCiogICA8Y29kZT5oZWlnaHQ8L2NvZGU+IGFuZCA8Y29kZT53aWR0aDwvY29kZT4gcHJvcGVydGllcyB0byBzZXQgdGhlIGRpbWVuc2lvbnMKKiAgIG9mIHRoZSBwdWJsaXNoZXIgdmlkZW87IGRvIG5vdCBzZXQgdGhlIGhlaWdodCBhbmQgd2lkdGggb2YgdGhlIERPTSBlbGVtZW50CiogICAodXNpbmcgQ1NTKS4KKiA8L2xpPgoqIDwvdWw+CioKKiBAcmV0dXJucyB7UHVibGlzaGVyfSBUaGUgUHVibGlzaGVyIG9iamVjdC4KKiBAc2VlIFNlc3Npb24jcHVibGlzaAoqIEBtZXRob2QgVEIuaW5pdFB1Ymxpc2hlcgoqIEBtZW1iZXJvZiBUQgoqLwpPVC5pbml0UHVibGlzaGVyID0gZnVuY3Rpb24oYXBpS2V5LCB0YXJnZXRFbGVtZW50LCBwcm9wZXJ0aWVzLCBjb21wbGV0aW9uSGFuZGxlcikgewogICAgT1QuZGVidWcoIlRCLmluaXRQdWJsaXNoZXIoIit0YXJnZXRFbGVtZW50KyIpIik7CgogICAgdmFyIHB1Ymxpc2hlciA9IG5ldyBPVC5QdWJsaXNoZXIoKTs7CiAgICBPVC5wdWJsaXNoZXJzLmFkZChwdWJsaXNoZXIpOwoKICAgIGlmIChjb21wbGV0aW9uSGFuZGxlciAmJiBPVC4kLmlzRnVuY3Rpb24oY29tcGxldGlvbkhhbmRsZXIpKSB7CiAgICAgICAgdmFyIHJlbW92ZUhhbmRsZXJzQW5kQ2FsbENvbXBsZXRlID0gZnVuY3Rpb24gcmVtb3ZlSGFuZGxlcnNBbmRDYWxsQ29tcGxldGUgKGVycm9yKSB7CiAgICAgICAgICAgIHB1Ymxpc2hlci5vZmYoJ2luaXRTdWNjZXNzJywgcmVtb3ZlSGFuZGxlcnNBbmRDYWxsQ29tcGxldGUpOwogICAgICAgICAgICBwdWJsaXNoZXIub2ZmKCdwdWJsaXNoQ29tcGxldGUnLCByZW1vdmVIYW5kbGVyc0FuZENhbGxDb21wbGV0ZSk7CgogICAgICAgICAgICBjb21wbGV0aW9uSGFuZGxlci5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgIH07CgogICAgICAgIHB1Ymxpc2hlci5vbmNlKCdpbml0U3VjY2VzcycsIHJlbW92ZUhhbmRsZXJzQW5kQ2FsbENvbXBsZXRlKTsKICAgICAgICBwdWJsaXNoZXIub25jZSgncHVibGlzaENvbXBsZXRlJywgcmVtb3ZlSGFuZGxlcnNBbmRDYWxsQ29tcGxldGUpOwogICAgfQoKICAgIHB1Ymxpc2hlci5wdWJsaXNoKHRhcmdldEVsZW1lbnQsIHByb3BlcnRpZXMpOwoKICAgIHJldHVybiBwdWJsaXNoZXI7Cn07CgoKCi8qKgoqIENoZWNrcyBpZiB0aGUgc3lzdGVtIHN1cHBvcnRzIE9wZW5Ub2sgZm9yIFdlYlJUQy4KKiBAcmV0dXJuIHtOdW1iZXJ9IFdoZXRoZXIgdGhlIHN5c3RlbSBzdXBwb3J0cyBPcGVuVG9rIGZvciBXZWJSVEMgKDEpIG9yIG5vdCAoMCkuCiogQHNlZSA8YSBocmVmPSIjdXBncmFkZVN5c3RlbVJlcXVpcmVtZW50cyI+VEIudXBncmFkZVN5c3RlbVJlcXVpcmVtZW50cygpPC9hPgoqIEBtZXRob2QgVEIuY2hlY2tTeXN0ZW1SZXF1aXJlbWVudHMKKiBAbWVtYmVyb2YgVEIKKi8KT1QuY2hlY2tTeXN0ZW1SZXF1aXJlbWVudHMgPSBmdW5jdGlvbigpIHsKICAgIE9ULmRlYnVnKCJUQi5jaGVja1N5c3RlbVJlcXVpcmVtZW50cygpIik7CgogICAgdmFyIHN5c3RlbVJlcXVpcmVtZW50c01ldCA9IE9ULiQuc3VwcG9ydHNXZWJTb2NrZXRzKCkgJiYgT1QuJC5zdXBwb3J0c1dlYlJUQygpID8gdGhpcy5IQVNfUkVRVUlSRU1FTlRTIDogdGhpcy5OT1RfSEFTX1JFUVVJUkVNRU5UUzsKCiAgICBPVC5jaGVja1N5c3RlbVJlcXVpcmVtZW50cyA9IGZ1bmN0aW9uKCkgewogICAgICBPVC5kZWJ1ZygiVEIuY2hlY2tTeXN0ZW1SZXF1aXJlbWVudHMoKSIpOwogICAgICByZXR1cm4gc3lzdGVtUmVxdWlyZW1lbnRzTWV0OwogICAgfTsKCiAgICByZXR1cm4gc3lzdGVtUmVxdWlyZW1lbnRzTWV0Owp9OwoKCi8qKgoqIERpc3BsYXlzIGluZm9ybWF0aW9uIGFib3V0IHN5c3RlbSByZXF1aXJtZW50cyBmb3IgT3BlblRvayBmb3IgV2ViUlRDLiBUaGlzIGluZm9ybWF0aW9uIGlzIGRpc3BsYXllZAoqIGluIGFuIGlmcmFtZSBlbGVtZW50IHRoYXQgZmlsbHMgdGhlIGJyb3dzZXIgd2luZG93LgoqIDxwPgoqIDxpPk5vdGU6PC9pPiB0aGlzIGluZm9ybWF0aW9uIGlzIGRpc3BsYXllZCBhdXRvbWF0aWNhbGx5IHdoZW4geW91IGNhbGwgdGhlIDxjb2RlPlRCLmluaXRTZXNzaW9uKCk8L2NvZGU+Ciogb3IgdGhlIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4gbWV0aG9kIGlmIHRoZSBjbGllbnQgZG9lcyBub3Qgc3VwcG9ydCBPcGVuVG9rIGZvciBXZWJSVEMuCiogPC9wPgoqIEBzZWUgPGEgaHJlZj0iI2NoZWNrU3lzdGVtUmVxdWlyZW1lbnRzIj5UQi5jaGVja1N5c3RlbVJlcXVpcmVtZW50cygpPC9hPgoqIEBtZXRob2QgVEIudXBncmFkZVN5c3RlbVJlcXVpcmVtZW50cwoqIEBtZW1iZXJvZiBUQgoqLwpPVC51cGdyYWRlU3lzdGVtUmVxdWlyZW1lbnRzID0gZnVuY3Rpb24oKXsKICAgIC8vIHRyaWdnZXIgYWZ0ZXIgdGhlIFRCIGVudmlyb25tZW50IGhhcyBsb2FkZWQKICAgIE9ULm9uTG9hZCggZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgdGhlcmUgaXMgYSBDaHJvbWUgRnJhbWUgbWV0YSB0YWcgb24gdGhlIHBhZ2UuIElmIHRoZXJlIGlzIHRoZW4gd2UgcHJvbXB0IHRvIGluc3RhbGwgQ2hyb21lIEZyYW1lCiAgICAgICAgdmFyIGNmTWV0YVRhZyA9IGZhbHNlLAogICAgICAgICAgICBtZXRhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJtZXRhIik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZXRhcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgaHR0cEVxdWl2ID0gbWV0YXNbaV0uaHR0cEVxdWl2LAogICAgICAgICAgICAgICAgY29udGVudCA9IG1ldGFzW2ldLmNvbnRlbnQ7CiAgICAgICAgICAgIGlmIChodHRwRXF1aXYgJiYgaHR0cEVxdWl2LnRvTG93ZXJDYXNlKCkgPT09ICJ4LXVhLWNvbXBhdGlibGUiICYmCiAgICAgICAgICAgICAgICBjb250ZW50ICYmIGNvbnRlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCJjaHJvbWU9MSIpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICBjZk1ldGFUYWcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgaWQgPSAnX3VwZ3JhZGVGbGFzaCc7CgogICAgICAgICAvLyBMb2FkIHRoZSBpZnJhbWUgb3ZlciB0aGUgd2hvbGUgcGFnZS4KICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCgoZnVuY3Rpb24oKXsKICAgICAgICAgICAgIHZhciBkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICAgICAgICAgICBkLmlkID0gaWQ7CiAgICAgICAgICAgICBkLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgIGQuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICAgZC5zdHlsZS5oZWlnaHQgPSAnMTAwJSc7CiAgICAgICAgICAgICBkLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICAgZC5zdHlsZS50b3AgPSAnMHB4JzsKICAgICAgICAgICAgIGQuc3R5bGUubGVmdCA9ICcwcHgnOwogICAgICAgICAgICAgZC5zdHlsZS5yaWdodCA9ICcwcHgnOwogICAgICAgICAgICAgZC5zdHlsZS5ib3R0b20gPSAnMHB4JzsKICAgICAgICAgICAgIGQuc3R5bGUuekluZGV4ID0gMTAwMDsKICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgZC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAicmdiYSgwLDAsMCwwLjIpIjsKICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgIC8vIE9sZCBJRSBicm93c2VycyBkb24ndCBzdXBwb3J0IHJnYmEgYW5kIHdlIHN0aWxsIHdhbnQgdG8gc2hvdyB0aGUgdXBncmFkZSBtZXNzYWdlCiAgICAgICAgICAgICAgICAgLy8gYnV0IHdlIGp1c3QgbWFrZSB0aGUgYmFja2dyb3VuZCBvZiB0aGUgaWZyYW1lIGNvbXBsZXRlbHkgdHJhbnNwYXJlbnQuCiAgICAgICAgICAgICAgICAgZC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAidHJhbnNwYXJlbnQiOwogICAgICAgICAgICAgICAgIGQuc2V0QXR0cmlidXRlKCJhbGxvd1RyYW5zcGFyZW5jeSIsICJ0cnVlIik7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgICBkLnNldEF0dHJpYnV0ZSgiZnJhbWVCb3JkZXIiLCAiMCIpOwogICAgICAgICAgICAgZC5mcmFtZUJvcmRlciA9ICIwIjsKICAgICAgICAgICAgIGQuc2Nyb2xsaW5nID0gIm5vIjsKICAgICAgICAgICAgIGQuc2V0QXR0cmlidXRlKCJzY3JvbGxpbmciLCAibm8iKTsKICAgICAgICAgICAgIGQuc3JjID0gT1QucHJvcGVydGllcy5hc3NldFVSTCArICIvaHRtbC91cGdyYWRlRmxhc2guaHRtbCIgKyAoY2ZNZXRhVGFnID8gIj9jZj0xIiA6ICIiKSArICIjIitlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQubG9jYXRpb24uaHJlZik7CiAgICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICAgfSkoKSk7CgogICAgICAgICAvLyBOb3cgd2UgbmVlZCB0byBsaXN0ZW4gdG8gdGhlIGV2ZW50IGhhbmRsZXIgaWYgdGhlIHVzZXIgY2xvc2VzIHRoaXMgZGlhbG9nLgogICAgICAgICAvLyBTaW5jZSB0aGlzIGlzIGZyb20gYW4gSUZSQU1FIHdpdGhpbiBhbm90aGVyIGRvbWFpbiB3ZSBhcmUgZ29pbmcgdG8gbGlzdGVuIHRvIGhhc2ggY2hhbmdlcy4KICAgICAgICAgLy8gVGhlIGJlc3QgY3Jvc3MgYnJvd3NlciBzb2x1dGlvbiBpcyB0byBwb2xsIGZvciBhIGNoYW5nZSBpbiB0aGUgaGFzaHRhZy4KICAgICAgICAgaWYgKF9pbnRlcnZhbElkKSBjbGVhckludGVydmFsKF9pbnRlcnZhbElkKTsKICAgICAgICAgX2ludGVydmFsSWQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpewogICAgICAgICAgICAgdmFyIGhhc2ggPSBkb2N1bWVudC5sb2NhdGlvbi5oYXNoLAogICAgICAgICAgICAgICAgIHJlID0gL14jP1xkKyYvOwogICAgICAgICAgICAgaWYgKGhhc2ggIT09IF9sYXN0SGFzaCAmJiByZS50ZXN0KGhhc2gpKSB7CiAgICAgICAgICAgICAgICAgX2xhc3RIYXNoID0gaGFzaDsKICAgICAgICAgICAgICAgICBpZiggaGFzaC5yZXBsYWNlKHJlLCAnJykgPT09ICdjbG9zZV93aW5kb3cnKXsKICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkpOwogICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gJyc7CiAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNoLnJlcGxhY2UocmUsICcnKSA9PT0gJ2luc3RhbGxlZF9nY2YnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2UgdGhlIHBhZ2UgdG8gcmVsb2FkIG5vdyB0aGF0IGNocm9tZSBmcmFtZSBpcyBpbnN0YWxsZWQKICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYucmVwbGFjZSgiIyIsICIiKTsKICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgIH0KICAgICAgICAgfSwgMTAwKTsKICAgIH0pOwp9OwoKCk9ULnJlcG9ydElzc3VlID0gZnVuY3Rpb24oKXsKICAgIE9ULndhcm4oIlRvRG86IGhhdmVuJ3QgeWV0IGltcGxlbWVudGVkIFRCLnJlcG9ydElzc3VlIik7Cn07CgpPVC5jb21wb25lbnRzID0ge307Ck9ULnNlc3Npb25zID0ge307CgovLyBuYW1lc3BhY2VzCk9ULnJ0YyA9IHt9OwoKLy8gRGVmaW5lIHRoZSBBUElLRVkgdGhpcyBpcyBhIGdsb2JhbCBwYXJhbWV0ZXIgd2hpY2ggc2hvdWxkIG5vdCBjaGFuZ2UKT1QuQVBJS0VZID0gKGZ1bmN0aW9uKCl7CiAgICAvLyBTY3JpcHQgZW1iZWQKICAgIHZhciBzY3JpcHRfc3JjID0gKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0Jyk7CiAgICAgICAgcyA9IHNbcy5sZW5ndGggLSAxXTsKICAgICAgICBzID0gcy5nZXRBdHRyaWJ1dGUoJ3NyYycpIHx8IHMuc3JjOwogICAgICAgIHJldHVybiBzOwogICAgfSkoKTsKCiAgICB2YXIgbSA9IHNjcmlwdF9zcmMubWF0Y2goL1tcP1wmXWFwaWtleT0oW14mXSspL2kpOwogICAgcmV0dXJuIG0gPyBtWzFdIDogJyc7Cn0pKCk7CgpPVC5IQVNfUkVRVUlSRU1FTlRTID0gMTsKT1QuTk9UX0hBU19SRVFVSVJFTUVOVFMgPSAwOwoKLyoqCiogUmVnaXN0ZXJzIGEgbWV0aG9kIGFzIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIHNwZWNpZmljIGV2ZW50LiBOb3RlIHRoYXQgdGhpcyBpcyBhIHN0YXRpYyBtZXRob2Qgb2YgdGhlIFRCIGNsYXNzLgoqCiogPHA+CiogVGhlIFRCIG9iamVjdCBkaXNwYXRjaGVzIG9uZSB0eXBlIG9mIGV2ZW50ICYjMTUxOyBhbiA8Y29kZT5leGNlcHRpb248L2NvZGU+IGV2ZW50LiBUaGUgZm9sbG93aW5nIGNvZGUgYWRkcyBhbiBldmVudAoqIGxpc3RlbmVyIGZvciB0aGUgPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudDoKKiA8L3A+CioKKiA8cHJlPgoqIFRCLmFkZEV2ZW50TGlzdGVuZXIoImV4Y2VwdGlvbiIsIGV4Y2VwdGlvbkhhbmRsZXIpOwoqCiogZnVuY3Rpb24gZXhjZXB0aW9uSGFuZGxlcihldmVudCkgewoqICAgIGFsZXJ0KCJleGNlcHRpb24gZXZlbnQuIFxuICBjb2RlID09ICIgKyBldmVudC5jb2RlICsgIlxuICBtZXNzYWdlID09ICIgKyBldmVudC5tZXNzYWdlKTsKKiB9CiogPC9wcmU+CioKKiA8cD4KKiAgIElmIGEgaGFuZGxlciBpcyBub3QgcmVnaXN0ZXJlZCBmb3IgYW4gZXZlbnQsIHRoZSBldmVudCBpcyBpZ25vcmVkIGxvY2FsbHkuIElmIHRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBkb2VzIG5vdCBleGlzdCwKKiAgIHRoZSBldmVudCBpcyBpZ25vcmVkIGxvY2FsbHkuCiogPC9wPgoqIDxwPgoqICAgVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZiB0aGUgPGNvZGU+bGlzdGVuZXI8L2NvZGU+IG5hbWUgaXMgaW52YWxpZC4KKiA8L3A+CioKKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIGlkZW50aWZ5aW5nIHRoZSB0eXBlIG9mIGV2ZW50LgoqCiogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgVGhlIGZ1bmN0aW9uIHRvIGJlIGludm9rZWQgd2hlbiB0aGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgdGhlIGV2ZW50LgoqIEBtZW1iZXJPZiBUQgoqIEBtZXRob2QgYWRkRXZlbnRMaXN0ZW5lcgoqLwoKLyoqCiogUmVtb3ZlcyBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBzcGVjaWZpYyBldmVudC4gTm90ZSB0aGF0IHRoaXMgaXMgYSBzdGF0aWMgbWV0aG9kIG9mIHRoZSBUQiBjbGFzcy4KKgoqIDxwPgoqICAgVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZiB0aGUgPGNvZGU+bGlzdGVuZXI8L2NvZGU+IG5hbWUgaXMgaW52YWxpZC4KKiA8L3A+CioKKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIGlkZW50aWZ5aW5nIHRoZSB0eXBlIG9mIGV2ZW50LgoqCiogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgVGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uIHRvIHJlbW92ZS4KKgoqIEBtZW1iZXJPZiBUQgoqIEBtZXRob2QgcmVtb3ZlRXZlbnRMaXN0ZW5lcgoqLwoKLyoqCiAqIERpc3BhdGNoZWQgYnkgdGhlIFRCIGNsYXNzIHdoZW4gdGhlIGFwcCBlbmNvdW50ZXJzIGFuIGV4Y2VwdGlvbi4KICogTm90ZSB0aGF0IHlvdSBzZXQgdXAgYW4gZXZlbnQgaGFuZGxlciBmb3IgdGhlIDxjb2RlPmV4Y2VwdGlvbjwvY29kZT4gZXZlbnQgYnkgY2FsbGluZyB0aGUKICogPGNvZGU+VEIuYWRkRXZlbnRMaXN0ZW5lcigpPC9jb2RlPiBtZXRob2QsIHdoaWNoIGlzIGEgPGk+c3RhdGljPC9pPiBtZXRob2QuCiAqCiAqIEBuYW1lIGV4Y2VwdGlvbgogKiBAZXZlbnQKICogQGJvcnJvd3MgRXhjZXB0aW9uRXZlbnQjbWVzc2FnZSBhcyB0aGlzLm1lc3NhZ2UKICogQG1lbWJlcm9mIFRCCiAqIEBzZWUgRXhjZXB0aW9uRXZlbnQKICovCgppZiAoIXdpbmRvdy5PVCkgd2luZG93Lk9UID0gT1Q7CmlmICghd2luZG93LlRCKSB3aW5kb3cuVEIgPSBPVDsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbihnbG9iYWwpIHsKCk9ULkNvbGxlY3Rpb24gPSBmdW5jdGlvbihpZEZpZWxkKSB7CiAgdmFyIF9tb2RlbHMgPSBbXSwKICAgICAgX2J5SWQgPSB7fSwKICAgICAgX2lkRmllbGQgPSBpZEZpZWxkIHx8ICdpZCc7CgogIE9ULiQuZXZlbnRpbmcodGhpcywgdHJ1ZSk7CgogIHZhciBvbk1vZGVsVXBkYXRlID0gZnVuY3Rpb24gb25Nb2RlbFVwZGF0ZSAoZXZlbnQpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ3VwZGF0ZScsIGV2ZW50KTsKICAgICAgICB0aGlzLnRyaWdnZXIoJ3VwZGF0ZTonK2V2ZW50LnRhcmdldC5pZCwgZXZlbnQpOwogICAgICB9LmJpbmQodGhpcyksCgogICAgICBvbk1vZGVsSWRVcGRhdGUgPSBmdW5jdGlvbiBvbk1vZGVsSWRVcGRhdGUgKG9sZElkLCBuZXdJZCkgewogICAgICAgIGlmIChfYnlJZFtvbGRJZF0gPT09IHZvaWQgMCkgcmV0dXJuOwoKICAgICAgICAvLyBNYXRjaCB0aGVpciBvbGQgaW5kZXggdG8gdGhlaXIgbmV3IGlkIGFuZCByZW1vdmUgYW55CiAgICAgICAgLy8gcmVmZXJlbmNlIHRvIHRoZSBvbGQgb25lLgogICAgICAgIHZhciBpbmRleCA9IF9ieUlkW29sZElkXTsKICAgICAgICBkZWxldGUgX2J5SWRbb2xkSWRdOwogICAgICAgIF9ieUlkW25ld0lkXSA9IGluZGV4OwogICAgICB9LmJpbmQodGhpcyksCgogICAgICBvbk1vZGVsRGVzdHJveSA9IGZ1bmN0aW9uIG9uTW9kZWxEZXN0cm95ZWQgKGV2ZW50KSB7CiAgICAgICAgdGhpcy5yZW1vdmUoZXZlbnQudGFyZ2V0LCBldmVudC5yZWFzb24pOwogICAgICB9LmJpbmQodGhpcyk7CgoKICB0aGlzLnJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAvLyBTdG9wIGxpc3RlbmluZyBvbiB0aGUgbW9kZWxzLCB0aGV5IGFyZSBubyBsb25nZXIgb3VyIHByb2JsZW0KICAgIF9tb2RlbHMuZm9yRWFjaChmdW5jdGlvbihtb2RlbCkgewogICAgICBtb2RlbC5vZmYoJ3VwZGF0ZWQnLCBvbk1vZGVsVXBkYXRlLCB0aGlzKTsKICAgICAgbW9kZWwub2ZmKCdkZXN0cm95ZWQnLCBvbk1vZGVsRGVzdHJveSwgdGhpcykKICAgICAgbW9kZWwub2ZmKCdpZFVwZGF0ZWQnLCBvbk1vZGVsSWRVcGRhdGUsIHRoaXMpOwogICAgfSwgdGhpcyk7CgogICAgX21vZGVscyA9IFtdOwogICAgX2J5SWQgPSB7fTsKICB9OwoKICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgIF9tb2RlbHMuZm9yRWFjaChmdW5jdGlvbihtb2RlbCkgewogICAgICBtb2RlbC5kZXN0cm95KHZvaWQgMCwgdHJ1ZSk7CiAgICB9KTsKCiAgICB0aGlzLnJlc2V0KCk7CiAgICB0aGlzLm9mZigpOwogIH07CgogIHRoaXMuZ2V0ID0gZnVuY3Rpb24oaWQpIHsgcmV0dXJuIGlkICYmIF9ieUlkW2lkXSAhPT0gdm9pZCAwID8gX21vZGVsc1tfYnlJZFtpZF1dIDogdm9pZCAwOyB9OwogIHRoaXMuaGFzID0gZnVuY3Rpb24oaWQpIHsgcmV0dXJuIGlkICYmIF9ieUlkW2lkXSAhPT0gdm9pZCAwOyB9OwoKICB0aGlzLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7IHJldHVybiBfbW9kZWxzLnRvU3RyaW5nKCk7IH07CgogIC8vIFJldHVybiBvbmx5IG1vZGVscyBmaWx0ZXJlZCBieSBlaXRoZXIgYSBkaWN0IG9mIHByb3BlcnRpZXMKICAvLyBvciBhIGZpbHRlciBmdW5jdGlvbi4KICAvLwogIC8vIEBleGFtcGxlIFJldHVybiBhbGwgcHVibGlzaGVycyB3aXRoIGEgc3RyZWFtSWQgb2YgMQogIC8vICAgT1QucHVibGlzaGVycy53aGVyZSh7c3RyZWFtSWQ6IDF9KQogIC8vCiAgLy8gQGV4YW1wbGUgVGhlIHNhbWUgdGhpbmcgYnV0IGZpbHRlcmluZyB1c2luZyBhIGZpbHRlciBmdW5jdGlvbgogIC8vICAgT1QucHVibGlzaGVycy53aGVyZShmdW5jdGlvbihwdWJsaXNoZXIpIHsKICAvLyAgICAgcmV0dXJuIHB1Ymxpc2hlci5zdHJlYW0uaWQgPT09IDQ7CiAgLy8gICB9KTsKICAvLwogIC8vIEBleGFtcGxlIFRoZSBzYW1lIHRoaW5nIGJ1dCBmaWx0ZXJpbmcgdXNpbmcgYSBmaWx0ZXIgZnVuY3Rpb24KICAvLyAgICAgICAgICBleGVjdXRlZCB3aXRoIGEgc3BlY2lmaWMgdGhpcwogIC8vICAgT1QucHVibGlzaGVycy53aGVyZShmdW5jdGlvbihwdWJsaXNoZXIpIHsKICAvLyAgICAgcmV0dXJuIHB1Ymxpc2hlci5zdHJlYW0uaWQgPT09IDQ7CiAgLy8gICB9LCBzZWxmKTsKICAvLwogIHRoaXMud2hlcmUgPSBmdW5jdGlvbihhdHRyc09yRmlsdGVyRm4sIGNvbnRleHQpIHsKICAgIGlmIChPVC4kLmlzRnVuY3Rpb24oYXR0cnNPckZpbHRlckZuKSkgcmV0dXJuIF9tb2RlbHMuZmlsdGVyKGF0dHJzT3JGaWx0ZXJGbiwgY29udGV4dCk7CgogICAgcmV0dXJuIF9tb2RlbHMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRyc09yRmlsdGVyRm4pIHsKICAgICAgICBpZiAobW9kZWxba2V5XSAhPT0gYXR0cnNPckZpbHRlckZuW2tleV0pIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKICAvLyBTaW1pbGFyIHRvIHdoZXJlIGluIGJlaGF2aW91ciwgZXhjZXB0IHRoYXQgaXQgb25seSByZXR1cm5zCiAgLy8gdGhlIGZpcnN0IG1hdGNoLgogIHRoaXMuZmluZCA9IGZ1bmN0aW9uKGF0dHJzT3JGaWx0ZXJGbiwgY29udGV4dCkgewogICAgdmFyIGZpbHRlckZuOwoKICAgIGlmIChPVC4kLmlzRnVuY3Rpb24oYXR0cnNPckZpbHRlckZuKSkgewogICAgICBmaWx0ZXJGbiA9IGF0dHJzT3JGaWx0ZXJGbjsKICAgIH0KICAgIGVsc2UgewogICAgICBmaWx0ZXJGbiA9IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzT3JGaWx0ZXJGbikgewogICAgICAgICAgaWYgKG1vZGVsW2tleV0gIT09IGF0dHJzT3JGaWx0ZXJGbltrZXldKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfTsKICAgIH0KCiAgICBmaWx0ZXJGbiA9IGZpbHRlckZuLmJpbmQoY29udGV4dCk7CgogICAgZm9yICh2YXIgaT0wOyBpPF9tb2RlbHMubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKGZpbHRlckZuKF9tb2RlbHNbaV0pID09PSB0cnVlKSByZXR1cm4gX21vZGVsc1tpXTsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9OwoKICB0aGlzLmFkZCA9IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB2YXIgaWQgPSBtb2RlbFtfaWRGaWVsZF07CgogICAgaWYgKHRoaXMuaGFzKGlkKSkgewogICAgICBPVC53YXJuKCJNb2RlbCAiICsgaWQgKyAnIGlzIGFscmVhZHkgaW4gdGhlIGNvbGxlY3Rpb24nLCBfbW9kZWxzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgX2J5SWRbaWRdID0gX21vZGVscy5wdXNoKG1vZGVsKSAtIDE7CgogICAgbW9kZWwub24oJ3VwZGF0ZWQnLCBvbk1vZGVsVXBkYXRlLCB0aGlzKTsKICAgIG1vZGVsLm9uKCdkZXN0cm95ZWQnLCBvbk1vZGVsRGVzdHJveSwgdGhpcykKICAgIG1vZGVsLm9uKCdpZFVwZGF0ZWQnLCBvbk1vZGVsSWRVcGRhdGUsIHRoaXMpOwoKICAgIHRoaXMudHJpZ2dlcignYWRkJywgbW9kZWwpOwogICAgdGhpcy50cmlnZ2VyKCdhZGQ6JytpZCwgbW9kZWwpOwoKICAgIHJldHVybiB0aGlzOwogIH07CgogIHRoaXMucmVtb3ZlID0gZnVuY3Rpb24obW9kZWwsIHJlYXNvbikgewogICAgdmFyIGlkID0gbW9kZWxbX2lkRmllbGRdOwoKICAgIF9tb2RlbHMuc3BsaWNlKF9ieUlkW2lkXSwgMSk7CgogICAgLy8gU2h1ZmZsZSBldmVyeW9uZSBkb3duIG9uZQogICAgZm9yICh2YXIgaT1fYnlJZFtpZF07IGk8X21vZGVscy5sZW5ndGg7ICsraSkgewogICAgICBfYnlJZFtfbW9kZWxzW2ldW19pZEZpZWxkXV0gPSBpCiAgICB9CgogICAgZGVsZXRlIF9ieUlkW2lkXTsKCiAgICBtb2RlbC5vZmYoJ3VwZGF0ZWQnLCBvbk1vZGVsVXBkYXRlLCB0aGlzKTsKICAgIG1vZGVsLm9mZignZGVzdHJveWVkJywgb25Nb2RlbERlc3Ryb3ksIHRoaXMpCiAgICBtb2RlbC5vZmYoJ2lkVXBkYXRlZCcsIG9uTW9kZWxJZFVwZGF0ZSwgdGhpcyk7CgogICAgdGhpcy50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgcmVhc29uKTsKICAgIHRoaXMudHJpZ2dlcigncmVtb3ZlOicraWQsIG1vZGVsLCByZWFzb24pOwoKICAgIHJldHVybiB0aGlzOwogIH07CgogIE9ULiQuZGVmaW5lR2V0dGVycyh0aGlzLCB7CiAgICBsZW5ndGg6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX21vZGVscy5sZW5ndGg7IH0KICB9KTsKfTsKCn0odGhpcykpOwooZnVuY3Rpb24od2luZG93KSB7CgovKioKICogVGhlIEV2ZW50IG9iamVjdCBkZWZpbmVzIHRoZSBiYXNpYyBPcGVuVG9rIGV2ZW50IG9iamVjdCB0aGF0IGlzIHBhc3NlZCB0bwogKiBldmVudCBsaXN0ZW5lcnMuIE90aGVyIE9wZW5Ub2sgZXZlbnQgY2xhc3NlcyBpbXBsZW1lbnQgdGhlIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMgb2YKICogdGhlIEV2ZW50IG9iamVjdC48L3A+CiAqCiAqIDxwPkZvciBleGFtcGxlLCB0aGUgU3RyZWFtIG9iamVjdCBkaXNwYXRjaGVzIGEgPGNvZGU+c3RyZWFtUHJvcGVydHlDaGFuZ2VkPC9jb2RlPiBldmVudCB3aGVuCiAqIHRoZSBzdHJlYW0ncyBwcm9wZXJ0aWVzIGFyZSB1cGRhdGVkLiBZb3UgcmVnaXN0ZXIgYW4gZXZlbnQgbGlzdGVuZXIgdXNpbmcgdGhlIDxjb2RlPmFkZEV2ZW50TGlzdGVuZXIoKTwvY29kZT4KICogbWV0aG9kIG9mIHRoZSBTdHJlYW0gb2JqZWN0OjwvcD4KICoKICogPHByZT4KICogc3RyZWFtLmFkZEV2ZW50TGlzdGVuZXIoInN0cmVhbVByb3BlcnR5Q2hhbmdlZCIsIHN0cmVhbVByb3BlcnR5Q2hhbmdlZEhhbmRsZXIpOwogKgogKiBmdW5jdGlvbiBzdHJlYW1Qcm9wZXJ0eUNoYW5nZWRIYW5kbGVyKGV2ZW50KSB7CiAqICAgICBhbGVydCgiUHJvcGVydGllcyBjaGFuZ2VkIGZvciBzdHJlYW0gIiArIGV2ZW50LnRhcmdldC5zdHJlYW1JZCk7CiAqIH08L3ByZT4KICoKICogQGNsYXNzIEV2ZW50CiAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gY2FuY2VsYWJsZSBXaGV0aGVyIHRoZSBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yIHRoYXQgaXMgY2FuY2VsYWJsZSAoPGNvZGU+dHJ1ZTwvY29kZT4pCiAqIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4gWW91IGNhbiBjYW5jZWwgdGhlIGRlZmF1bHQgYmVoYXZpb3IgYnkgY2FsbGluZyB0aGUgPGNvZGU+cHJldmVudERlZmF1bHQoKTwvY29kZT4gbWV0aG9kCiAqIG9mIHRoZSBFdmVudCBvYmplY3QgaW4gdGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uLiAoU2VlIDxhIGhyZWY9IiNwcmV2ZW50RGVmYXVsdCI+cHJldmVudERlZmF1bHQoKTwvYT4uKQogKgogKiBAcHJvcGVydHkge09iamVjdH0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBkaXNwYXRjaGVkIHRoZSBldmVudC4KICoKICogQHByb3BlcnR5IHtTdHJpbmd9IHR5cGUgIFRoZSB0eXBlIG9mIGV2ZW50LgogKi8KT1QuRXZlbnQgPSBPVC4kLmV2ZW50aW5nLkV2ZW50KCk7Ci8qKgoqIFByZXZlbnRzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXZlbnQgZnJvbSB0YWtpbmcgcGxhY2UuCioKKiA8cD5UbyBzZWUgd2hldGhlciBhbiBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yLCBjaGVjayB0aGUgPGNvZGU+Y2FuY2VsYWJsZTwvY29kZT4gcHJvcGVydHkgb2YgdGhlIGV2ZW50IG9iamVjdC4gPC9wPgoqCiogPHA+Q2FsbCB0aGUgPGNvZGU+cHJldmVudERlZmF1bHQoKTwvY29kZT4gbWV0aG9kIGluIHRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3IgdGhlIGV2ZW50LjwvcD4KKgoqIDxwPlRoZSBmb2xsb3dpbmcgZXZlbnRzIGhhdmUgZGVmYXVsdCBiZWhhdmlvcnM6PC9wPgoqCiogPHVsPgoqCiogICA8bGk+PGNvZGU+c2Vzc2lvbkRpc2Nvbm5lY3Q8L2NvZGU+ICYjMTUxOyBTZWUgPGEgaHJlZj0iU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudC5odG1sI3ByZXZlbnREZWZhdWx0Ij4KKiAgIFNlc3Npb25EaXNjb25uZWN0RXZlbnQucHJldmVudERlZmF1bHQoKTwvYT4uPC9saT4KKgoqICAgPGxpPjxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gJiMxNTE7IFNlZSA8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sI3ByZXZlbnREZWZhdWx0Ij4KKiAgIFN0cmVhbUV2ZW50LnByZXZlbnREZWZhdWx0KCk8L2E+LjwvbGk+CioKKiA8L3VsPgoqCiogQG1ldGhvZCAjcHJldmVudERlZmF1bHQKKiBAbWVtYmVyb2YgRXZlbnQKKi8KLyoqCiogV2hldGhlciB0aGUgZGVmYXVsdCBldmVudCBiZWhhdmlvciBoYXMgYmVlbiBwcmV2ZW50ZWQgdmlhIGEgY2FsbCB0byA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiAoPGNvZGU+dHJ1ZTwvY29kZT4pCiogb3Igbm90ICg8Y29kZT5mYWxzZTwvY29kZT4pLiBTZWUgPGEgaHJlZj0iI3ByZXZlbnREZWZhdWx0Ij5wcmV2ZW50RGVmYXVsdCgpPC9hPi4KKiBAbWV0aG9kICNpc0RlZmF1bHRQcmV2ZW50ZWQKKiBAcmV0dXJuIHtCb29sZWFufQoqIEBtZW1iZXJvZiBFdmVudAoqLwoKLy8gRXZlbnQgbmFtZXMgbG9va3VwCk9ULkV2ZW50Lm5hbWVzID0gewogICAgLy8gQWN0aXZpdHkgU3RhdHVzIGZvciBjYW1zL21pY3MKICAgIEFDVElWRTogImFjdGl2ZSIsCiAgICBJTkFDVElWRTogImluYWN0aXZlIiwKICAgIFVOS05PV046ICJ1bmtub3duIiwKCiAgICAvLyBBcmNoaXZlIHR5cGVzCiAgICBQRVJfU0VTU0lPTjogInBlclNlc3Npb24iLAogICAgUEVSX1NUUkVBTTogInBlclN0cmVhbSIsCgogICAgLy8gVEIgRXZlbnRzCiAgICBFWENFUFRJT046ICJleGNlcHRpb24iLAogICAgSVNTVUVfUkVQT1JURUQ6ICJpc3N1ZVJlcG9ydGVkIiwKCiAgICAvLyBTZXNzaW9uIEV2ZW50cwogICAgU0VTU0lPTl9DT05ORUNURUQ6ICJzZXNzaW9uQ29ubmVjdGVkIiwKICAgIFNFU1NJT05fRElTQ09OTkVDVEVEOiAic2Vzc2lvbkRpc2Nvbm5lY3RlZCIsCiAgICBTVFJFQU1fQ1JFQVRFRDogInN0cmVhbUNyZWF0ZWQiLAogICAgU1RSRUFNX0RFU1RST1lFRDogInN0cmVhbURlc3Ryb3llZCIsCiAgICBDT05ORUNUSU9OX0NSRUFURUQ6ICJjb25uZWN0aW9uQ3JlYXRlZCIsCiAgICBDT05ORUNUSU9OX0RFU1RST1lFRDogImNvbm5lY3Rpb25EZXN0cm95ZWQiLAogICAgU0lHTkFMOiAic2lnbmFsIiwKICAgIFNUUkVBTV9QUk9QRVJUWV9DSEFOR0VEOiAic3RyZWFtUHJvcGVydHlDaGFuZ2VkIiwKICAgIE1JQ1JPUEhPTkVfTEVWRUxfQ0hBTkdFRDogIm1pY3JvcGhvbmVMZXZlbENoYW5nZWQiLAoKCiAgICAvLyBQdWJsaXNoZXIgRXZlbnRzCiAgICBSRVNJWkU6ICJyZXNpemUiLAogICAgU0VUVElOR1NfQlVUVE9OX0NMSUNLOiAic2V0dGluZ3NCdXR0b25DbGljayIsCiAgICBERVZJQ0VfSU5BQ1RJVkU6ICJkZXZpY2VJbmFjdGl2ZSIsCiAgICBJTlZBTElEX0RFVklDRV9OQU1FOiAiaW52YWxpZERldmljZU5hbWUiLAogICAgQUNDRVNTX0FMTE9XRUQ6ICJhY2Nlc3NBbGxvd2VkIiwKICAgIEFDQ0VTU19ERU5JRUQ6ICJhY2Nlc3NEZW5pZWQiLAogICAgQUNDRVNTX0RJQUxPR19PUEVORUQ6ICdhY2Nlc3NEaWFsb2dPcGVuZWQnLAogICAgQUNDRVNTX0RJQUxPR19DTE9TRUQ6ICdhY2Nlc3NEaWFsb2dDbG9zZWQnLAogICAgRUNIT19DQU5DRUxMQVRJT05fTU9ERV9DSEFOR0VEOiAiZWNob0NhbmNlbGxhdGlvbk1vZGVDaGFuZ2VkIiwKICAgIFBVQkxJU0hFUl9ERVNUUk9ZRUQ6ICdkZXN0cm95ZWQnLAoKICAgIC8vIFN1YnNjcmliZXIgRXZlbnRzCiAgICBTVUJTQ1JJQkVSX0RFU1RST1lFRDogJ2Rlc3Ryb3llZCcsCgogICAgLy8gRGV2aWNlTWFuYWdlciBFdmVudHMKICAgIERFVklDRVNfREVURUNURUQ6ICJkZXZpY2VzRGV0ZWN0ZWQiLAoKICAgIC8vIERldmljZVBhbmVsIEV2ZW50cwogICAgREVWSUNFU19TRUxFQ1RFRDogImRldmljZXNTZWxlY3RlZCIsCiAgICBDTE9TRV9CVVRUT05fQ0xJQ0s6ICJjbG9zZUJ1dHRvbkNsaWNrIiwKCiAgICBNSUNMRVZFTCA6ICdtaWNyb3Bob25lQWN0aXZpdHlMZXZlbCcsCiAgICBNSUNHQUlOQ0hBTkdFRCA6ICdtaWNyb3Bob25lR2FpbkNoYW5nZWQnLAoKICAgIC8vIEVudmlyb25tZW50IExvYWRlcgogICAgRU5WX0xPQURFRDogJ2VudkxvYWRlZCcKfTsKCk9ULlZhbHVlRXZlbnQgPSBmdW5jdGlvbiAodHlwZSx2YWx1ZSl7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwoKfTsKCk9ULkV4Y2VwdGlvbkNvZGVzID0gewogIEpTX0VYQ0VQVElPTjogMjAwMCwKICBBVVRIRU5USUNBVElPTl9FUlJPUjogMTAwNCwKICBJTlZBTElEX1NFU1NJT05fSUQ6IDEwMDUsCiAgQ09OTkVDVF9GQUlMRUQ6IDEwMDYsCiAgQ09OTkVDVF9SRUpFQ1RFRDogMTAwNywKICBDT05ORUNUSU9OX1RJTUVPVVQ6IDEwMDgsCiAgTk9UX0NPTk5FQ1RFRDogMTAxMCwKICBQMlBfQ09OTkVDVElPTl9GQUlMRUQ6IDEwMTMsCiAgQVBJX1JFU1BPTlNFX0ZBSUxVUkU6IDEwMTQsCiAgVU5BQkxFX1RPX1BVQkxJU0g6IDE1MDAsCiAgVU5BQkxFX1RPX1NJR05BTDogMTUxMCwKICBVTkFCTEVfVE9fRk9SQ0VfRElTQ09OTkVDVDogMTUyMCwKICBVTkFCTEVfVE9fRk9SQ0VfVU5QVUJMSVNIOiAxNTMwCn07CgovKioKKiBUaGUge0BsaW5rIFRCfSBjbGFzcyBkaXNwYXRjaGVzIDxjb2RlPmV4Y2VwdGlvbjwvY29kZT4gZXZlbnRzIHdoZW4gdGhlIE9wZW5Ub2sgQVBJIGVuY291bnRlcnMKKiBhbiBleGNlcHRpb24gKGVycm9yKS4gVGhlIEV4Y2VwdGlvbkV2ZW50IG9iamVjdCBkZWZpbmVzIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBldmVudAoqIG9iamVjdCB0aGF0IGlzIGRpc3BhdGNoZWQuCioKKiA8cD5Ob3RlIHRoYXQgeW91IHNldCB1cCBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudCBieSBjYWxsaW5nIHRoZQoqIDxjb2RlPlRCLmFkZEV2ZW50TGlzdGVuZXIoKTwvY29kZT4gbWV0aG9kLCB3aGljaCBpcyBhIDxpPnN0YXRpYzwvaT4gbWV0aG9kLjwvcD4KKgoqIEBjbGFzcyBFeGNlcHRpb25FdmVudAoqIEBwcm9wZXJ0eSB7TnVtYmVyfSBjb2RlIFRoZSBlcnJvciBjb2RlLiBUaGUgZm9sbG93aW5nIGlzIGEgbGlzdCBvZiBlcnJvciBjb2Rlczo8L3A+CioKKiA8dGFibGUgY2xhc3M9ImRvY3NfdGFibGUiPgoqICA8dGJvZHk+PHRyPgoqICAgPHRkPgoqICAgPGI+Y29kZTwvYj4KKgoqICAgPC90ZD4KKiAgIDx0ZD4KKiAgIDxiPnRpdGxlPC9iPgoqICAgPC90ZD4KKiAgPC90cj4KKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwMAoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgRmFpbGVkIFRvIExvYWQKKiAgIDwvdGQ+CiogIDwvdHI+CioKKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwNAoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgQXV0aGVudGljYXRpb24gZXJyb3IKKiAgIDwvdGQ+CiogIDwvdHI+CioKKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwNQoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgSW52YWxpZCBTZXNzaW9uIElECiogICA8L3RkPgoqICA8L3RyPgoqICA8dHI+CiogICA8dGQ+CiogICAxMDA2CioKKiAgIDwvdGQ+CiogICA8dGQ+CiogICBDb25uZWN0IEZhaWxlZAoqICAgPC90ZD4KKiAgPC90cj4KKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwNwoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgQ29ubmVjdCBSZWplY3RlZAoqICAgPC90ZD4KKiAgPC90cj4KKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwOAoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgQ29ubmVjdCBUaW1lLW91dAoqICAgPC90ZD4KKiAgPC90cj4KKiAgPHRyPgoqICAgPHRkPgoqICAgMTAwOQoqCiogICA8L3RkPgoqICAgPHRkPgoqICAgU2VjdXJpdHkgRXJyb3IKKiAgIDwvdGQ+CiogIDwvdHI+CiogICA8dHI+CiogICAgPHRkPgoqICAgIDEwMTAKKgoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIE5vdCBDb25uZWN0ZWQKKiAgICA8L3RkPgoqICAgPC90cj4KKiAgIDx0cj4KKiAgICA8dGQ+CiogICAgMTAxMQoqCiogICAgPC90ZD4KKiAgICA8dGQ+CiogICAgSW52YWxpZCBQYXJhbWV0ZXIKKiAgICA8L3RkPgoqICAgPC90cj4KKiAgIDx0cj4KKiAgICA8dGQ+CiogICAgMTAxMwoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIENvbm5lY3Rpb24gRmFpbGVkCiogICAgPC90ZD4KKiAgIDwvdHI+CiogICA8dHI+CiogICAgPHRkPgoqICAgIDEwMTQKKiAgICA8L3RkPgoqICAgIDx0ZD4KKiAgICBBUEkgUmVzcG9uc2UgRmFpbHVyZQoqICAgIDwvdGQ+CiogICA8L3RyPgoqCiogIDx0cj4KKiAgICA8dGQ+CiogICAgMTUwMAoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIFVuYWJsZSB0byBQdWJsaXNoCiogICAgPC90ZD4KKiAgIDwvdHI+CioKKiAgPHRyPgoqICAgIDx0ZD4KKiAgICAxNTEwCiogICAgPC90ZD4KKiAgICA8dGQ+CiogICAgVW5hYmxlIHRvIFNpZ25hbAoqICAgIDwvdGQ+CiogICA8L3RyPgoqCiogIDx0cj4KKiAgICA8dGQ+CiogICAgMTUyMAoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIFVuYWJsZSB0byBGb3JjZSBEaXNjb25uZWN0CiogICAgPC90ZD4KKiAgIDwvdHI+CioKKiAgPHRyPgoqICAgIDx0ZD4KKiAgICAxNTMwCiogICAgPC90ZD4KKiAgICA8dGQ+CiogICAgVW5hYmxlIHRvIEZvcmNlIFVucHVibGlzaAoqICAgIDwvdGQ+CiogICA8L3RyPgoqICA8dHI+CiogICAgPHRkPgoqICAgIDE1MzUKKiAgICA8L3RkPgoqICAgIDx0ZD4KKiAgICBGb3JjZSBVbnB1Ymxpc2ggb24gSW52YWxpZCBTdHJlYW0KKiAgICA8L3RkPgoqICAgPC90cj4KKgoqICA8dHI+CiogICAgPHRkPgoqICAgIDIwMDAKKgoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIEludGVybmFsIEVycm9yCiogICAgPC90ZD4KKiAgPC90cj4KKgoqICA8dHI+CiogICAgPHRkPgoqICAgIDIwMTAKKgoqICAgIDwvdGQ+CiogICAgPHRkPgoqICAgIFJlcG9ydCBJc3N1ZSBGYWlsdXJlCiogICAgPC90ZD4KKiAgPC90cj4KKgoqCiogIDwvdGJvZHk+PC90YWJsZT4KKgoqICA8cD5DaGVjayB0aGUgPGNvZGU+bWVzc2FnZTwvY29kZT4gcHJvcGVydHkgZm9yIG1vcmUgZGV0YWlscyBhYm91dCB0aGUgZXJyb3IuPC9wPgoqCiogQHByb3BlcnR5IHtTdHJpbmd9IG1lc3NhZ2UgVGhlIGVycm9yIG1lc3NhZ2UuCiogQHByb3BlcnR5IHtTdHJpbmd9IHRpdGxlIFRoZSBlcnJvciB0aXRsZS4KKiBAYXVnbWVudHMgRXZlbnQKKi8KT1QuRXhjZXB0aW9uRXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgbWVzc2FnZSwgdGl0bGUsIGNvZGUsIGNvbXBvbmVudCwgdGFyZ2V0KSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICB0aGlzLnRpdGxlID0gdGl0bGU7CiAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKfTsKCgpPVC5Jc3N1ZVJlcG9ydGVkRXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgaXNzdWVJZCkgewogICAgT1QuRXZlbnQuY2FsbCh0aGlzLCB0eXBlKTsKCiAgICB0aGlzLmlzc3VlSWQgPSBpc3N1ZUlkOwp9OwoKLy8gVHJpZ2dlcmVkIHdoZW4gdGhlIEpTIGR5bmFtaWMgY29uZmlnIGFuZCB0aGUgRE9NIGhhdmUgbG9hZGVkLgpPVC5FbnZMb2FkZWRFdmVudCA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwp9OwoKCi8qKgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIENvbm5lY3Rpb25FdmVudCBvYmplY3Qgd2hlbiBhIGNvbm5lY3Rpb24gaXMgY3JlYXRlZCBvciBkZXN0cm95ZWQuCiAqCiAqIDxoNT48YSBocmVmPSJleGFtcGxlIj48L2E+RXhhbXBsZTwvaDU+CiAqCiAqIDxwPlRoZSBmb2xsb3dpbmcgY29kZSBrZWVwcyBhIHJ1bm5pbmcgdG90YWwgb2YgdGhlIG51bWJlciBvZiBjb25uZWN0aW9ucyB0byBhIHNlc3Npb24KICogYnkgbW9uaXRvcmluZyB0aGUgPGNvZGU+Y29ubmVjdGlvbnM8L2NvZGU+IHByb3BlcnR5IG9mIHRoZSA8Y29kZT5zZXNzaW9uQ29ubmVjdDwvY29kZT4sCiAqIDxjb2RlPmNvbm5lY3Rpb25DcmVhdGVkPC9jb2RlPiBhbmQgPGNvZGU+Y29ubmVjdGlvbkRlc3Ryb3llZDwvY29kZT4gZXZlbnRzOjwvcD4KICoKICogPHByZT52YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAqICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICogdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqIHZhciBjb25uZWN0aW9uQ291bnQgPSAwOwogKgogKiB2YXIgc2Vzc2lvbiA9IFRCLmluaXRTZXNzaW9uKHNlc3Npb25JRCk7CiAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigic2Vzc2lvbkNvbm5lY3RlZCIsIHNlc3Npb25Db25uZWN0ZWRIYW5kbGVyKTsKICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJjb25uZWN0aW9uQ3JlYXRlZCIsIGNvbm5lY3Rpb25DcmVhdGVkSGFuZGxlcik7CiAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigiY29ubmVjdGlvbkRlc3Ryb3llZCIsIGNvbm5lY3Rpb25EZXN0cm95ZWRIYW5kbGVyKTsKICogc2Vzc2lvbi5jb25uZWN0KGFwaUtleSwgdG9rZW4pOwogKgogKiBmdW5jdGlvbiBzZXNzaW9uQ29ubmVjdGVkSGFuZGxlcihldmVudCkgewogKiAgICBjb25uZWN0aW9uQ291bnQgPSBldmVudC5jb25uZWN0aW9ucy5sZW5ndGg7CiAqICAgIGRpc3BsYXlDb25uZWN0aW9uQ291bnQoKTsKICogfQogKgogKiBmdW5jdGlvbiBjb25uZWN0aW9uQ3JlYXRlZEhhbmRsZXIoZXZlbnQpIHsKICogICAgY29ubmVjdGlvbkNvdW50ICs9IGV2ZW50LmNvbm5lY3Rpb25zLmxlbmd0aDsKICogICAgZGlzcGxheUNvbm5lY3Rpb25Db3VudCgpOwogKiB9CiAqCiAqIGZ1bmN0aW9uIGNvbm5lY3Rpb25EZXN0cm95ZWRIYW5kbGVyKGV2ZW50KSB7CiAqICAgIGNvbm5lY3Rpb25Db3VudCAtPSBldmVudC5jb25uZWN0aW9ucy5sZW5ndGg7CiAqICAgIGRpc3BsYXlDb25uZWN0aW9uQ291bnQoKTsKICogfQogKgogKiBmdW5jdGlvbiBkaXNwbGF5Q29ubmVjdGlvbkNvdW50KCkgewogKiAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvbm5lY3Rpb25Db3VudEZpZWxkIikudmFsdWUgPSBjb25uZWN0aW9uQ291bnQudG9TdHJpbmcoKTsKICogfTwvcHJlPgogKgogKiA8cD5UaGlzIGV4YW1wbGUgYXNzdW1lcyB0aGF0IHRoZXJlIGlzIGFuIGlucHV0IHRleHQgZmllbGQgaW4gdGhlIEhUTUwgRE9NCiAqIHdpdGggdGhlIDxjb2RlPmlkPC9jb2RlPiBzZXQgdG8gPGNvZGU+ImNvbm5lY3Rpb25Db3VudEZpZWxkIjwvY29kZT46PC9wPgogKgogKiA8cHJlPiZsdDtpbnB1dCB0eXBlPSJ0ZXh0IiBpZD0iY29ubmVjdGlvbkNvdW50RmllbGQiIHZhbHVlPSIwIiZndDsmbHQ7L2lucHV0Jmd0OzwvcHJlPgogKgogKgogKiBAcHJvcGVydHkge0FycmF5fSBjb25uZWN0aW9ucyBBbiBhcnJheSBvZiBDb25uZWN0aW9uIG9iamVjdHMgZm9yIHRoZSBjb25uZWN0aW9ucyB0aGF0IHdlcmUgY3JlYXRlZCBvciBkZWxldGVkLgogKiBZb3UgY2FuIGNvbXBhcmUgdGhlIDxjb2RlPmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgdG8gdGhhdCBvZiB0aGUgPGNvZGU+Y29ubmVjdGlvbjwvY29kZT4gcHJvcGVydHkgb2YgdGhlCiAqIFNlc3Npb24gb2JqZWN0IHRvIHNlZSBpZiBhIGNvbm5lY3Rpb24gcmVmZXJzIHRvIHRoZSBsb2NhbCB3ZWIgcGFnZS4KICoKICogQHByb3BlcnR5IHtTdHJpbmd9IHJlYXNvbiBGb3IgYSA8Y29kZT5jb25uZWN0aW9uRGVzdHJveWVkPC9jb2RlPiBldmVudCwKICogIGEgZGVzY3JpcHRpb24gb2Ygd2h5IHRoZSBjb25uZWN0aW9uIGVuZGVkLiBUaGlzIHByb3BlcnR5IGNhbiBoYXZlIHR3byB2YWx1ZXM6CiAqIDwvcD4KICogPHVsPgogKiAgPGxpPjxjb2RlPiJjbGllbnREaXNjb25uZWN0ZWQiPC9jb2RlPiAmIzE1MTsgQSBjbGllbnQgZGlzY29ubmVjdGVkIGZyb20gdGhlIHNlc3Npb24gYnkgY2FsbGluZwogKiAgICAgdGhlIDxjb2RlPmRpc2Nvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdCBvciBieSBjbG9zaW5nIHRoZSBicm93c2VyLgogKiAgICAgKFNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjZGlzY29ubmVjdCI+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2E+Lik8L2xpPgogKgogKiAgPGxpPjxjb2RlPiJmb3JjZURpc2Nvbm5lY3RlZCI8L2NvZGU+ICYjMTUxOyBBIG1vZGVyYXRvciBoYXMgZGlzY29ubmVjdGVkIHRoZSBwdWJsaXNoZXIgZnJvbSB0aGUgc2Vzc2lvbiwKICogICAgICBieSBjYWxsaW5nIHRoZSA8Y29kZT5mb3JjZURpc2Nvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4KICogICAgICAoU2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNmb3JjZURpc2Nvbm5lY3QiPlNlc3Npb24uZm9yY2VEaXNjb25uZWN0KCk8L2E+Lik8L2xpPgogKgogKiAgPGxpPjxjb2RlPiJuZXR3b3JrRGlzY29ubmVjdGVkIjwvY29kZT4gJiMxNTE7IFRoZSBuZXR3b3JrIGNvbm5lY3Rpb24gdGVybWluYXRlZCBhYnJ1cHRseSAoZm9yIGV4YW1wbGUsCiAqICAgICAgdGhlIGNsaWVudCBsb3N0IHRoZWlyIGludGVybmV0IGNvbm5lY3Rpb24pLjwvbGk+CiAqIDwvdWw+CiAqCiAqIDxwPkRlcGVuZGluZyBvbiB0aGUgY29udGV4dCwgdGhpcyBkZXNjcmlwdGlvbiBtYXkgYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWZpbmUKICogdGhlIGNvdXJzZSBvZiBhY3Rpb24gdGhleSB0YWtlIGluIHJlc3BvbnNlIHRvIGFuIGV2ZW50LjwvcD4KICoKICogPHA+Rm9yIGEgPGNvZGU+Y29ubmVjdGlvbkNyZWF0ZWQ8L2NvZGU+IGV2ZW50LCB0aGlzIHN0cmluZyBpcyB1bmRlZmluZWQuPC9wPgogKgogKiBAY2xhc3MgQ29ubmVjdGlvbkV2ZW50CiAqIEBhdWdtZW50cyBFdmVudAogKi8KT1QuQ29ubmVjdGlvbkV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIGNvbm5lY3Rpb25zLCByZWFzb24pIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy5jb25uZWN0aW9ucyA9IGNvbm5lY3Rpb25zOwogICAgdGhpcy5yZWFzb24gPSByZWFzb247Cn07CgovKioKICogU3RyZWFtRXZlbnQgaXMgYW4gZXZlbnQgdGhhdCBjYW4gaGF2ZSB0eXBlICJzdHJlYW1DcmVhdGVkIiBvciAic3RyZWFtRGVzdHJveWVkIi4gVGhlc2UgZXZlbnRzIGFyZSBkaXNwYXRjaGVkIHdoZW4gYSBjbGllbnQKICogc3RhcnRzIG9yIHN0b3BzIHB1Ymxpc2hpbmcgdG8gYSB7QGxpbmsgU2Vzc2lvbn0uIFRoaXMgaW5jbHVkZXMgcmVtb3RlIGNsaWVudHMgcHVibGlzaGluZyBvbiB0aGUgc2Vzc2lvbiBhcyB3ZWxsIGFzIHRoZSBsb2NhbAogKiBjbGllbnQgcHVibGlzaGluZyB0byB0aGUgc2Vzc2lvbi4KICoKICogPGg0PjxhIGhyZWY9ImV4YW1wbGVfc3RyZWFtQ3JlYXRlZCI+PC9hPkV4YW1wbGUgJiMxNTE7IHN0cmVhbUNyZWF0ZWQgZXZlbnQ8L2g0PgogKiAgPHA+VGhlIGZvbGxvd2luZyBjb2RlIGluaXRpYWxpemVzIGEgc2Vzc2lvbiBhbmQgc2V0cyB1cCBhbiBldmVudCBsaXN0ZW5lciBmb3Igd2hlbgogKiAgICBhIHN0cmVhbSBpcyBjcmVhdGVkOjwvcD4KICoKICogPHByZT52YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAqICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICogdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqCiAqIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzdHJlYW1DcmVhdGVkIiwgc3RyZWFtQ3JlYXRlZEhhbmRsZXIpOwogKiBzZXNzaW9uLmNvbm5lY3QoYXBpS2V5LCB0b2tlbik7CiAqCiAqIGZ1bmN0aW9uIHN0cmVhbUNyZWF0ZWRIYW5kbGVyKGV2ZW50KSB7CiAqICAgICBmb3IgKHZhciBpID0gMDsgaSAmbHQ7IGV2ZW50LnN0cmVhbXMubGVuZ3RoOyBpKyspIHsKICogICAgICAgICAvLyBPbmx5IGRpc3BsYXkgb3RoZXJzJyBzdHJlYW1zLCBub3QgdGhvc2UgdGhhdCB0aGUgY2xpZW50IHB1Ymxpc2hlcy4KICogICAgICAgICBpZiAoZXZlbnQuc3RyZWFtc1tpXS5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZCAhPSBldmVudC50YXJnZXQuY29ubmVjdGlvbi5jb25uZWN0aW9uSWQpIHsKICogICAgICAgICAgICAgICAgZGlzcGxheVN0cmVhbShzdHJlYW0pOwogKiAgICAgICAgIH0KICogICAgIH0KICogfQogKgogKiBmdW5jdGlvbiBkaXNwbGF5U3RyZWFtKHN0cmVhbSkgewogKiAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogKiAgICAgZGl2LnNldEF0dHJpYnV0ZSgnaWQnLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAqCiAqICAgICB2YXIgc3RyZWFtc0NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdHJlYW1zQ29udGFpbmVyJyk7CiAqICAgICBzdHJlYW1zQ29udGFpbmVyLmFwcGVuZENoaWxkKGRpdik7CiAqCiAqICAgICBzdWJzY3JpYmVyID0gc2Vzc2lvbi5zdWJzY3JpYmUoc3RyZWFtLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAqIH08L3ByZT4KICoKICogIDxwPkZvciB0aGlzIGV4YW1wbGUsIGluIGFkZGl0aW9uIHRvIHRoZSBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+c3RyZWFtQ3JlYXRlZDwvY29kZT4KICogIGV2ZW50LCB5b3Ugd291bGQgcHJvYmFibHkgd2FudCB0byBjcmVhdGUgYW4gZXZlbnQgaGFuZGxlciBmb3IgdGhlIDxjb2RlPnNlc3Npb25Db25uZWN0ZWQ8L2NvZGU+CiAqICBldmVudC4gVGhpcyBldmVudCBoYW5kbGVyIGNhbiBkaXNwbGF5IHRoZSBzdHJlYW1zIHRoYXQgYXJlIHByZXNlbnQgd2hlbiB0aGUgc2Vzc2lvbiBmaXJzdAogKiAgY29ubmVjdHMuIFNlZSB7QGxpbmsgU2Vzc2lvbkNvbm5lY3RFdmVudH0uPC9wPgogKgogKiAgPGg0PjxhIGhyZWY9ImV4YW1wbGVfc3RyZWFtRGVzdHJveWVkIj48L2E+RXhhbXBsZSAmIzE1MTsgc3RyZWFtRGVzdHJveWVkIGV2ZW50PC9oND4KICoKICogICAgPHA+VGhlIGZvbGxvd2luZyBjb2RlIGluaXRpYWxpemVzIGEgc2Vzc2lvbiBhbmQgc2V0cyB1cCBhbiBldmVudCBsaXN0ZW5lciBmb3Igd2hlbiBhCiAqICAgICAgIHN0cmVhbSBlbmRzOjwvcD4KICoKICogPHByZT52YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAqICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICogdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqCiAqIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzdHJlYW1EZXN0cm95ZWQiLCBzdHJlYW1EZXN0cm95ZWRIYW5kbGVyKTsKICogc2Vzc2lvbi5jb25uZWN0KGFwaUtleSwgdG9rZW4pOwogKgogKiBmdW5jdGlvbiBzdHJlYW1EZXN0cm95ZWRIYW5kbGVyKGV2ZW50KSB7CiAqICAgICBmb3IgKHZhciBpID0gMDsgaSAmbHQ7IGV2ZW50LnN0cmVhbXMubGVuZ3RoOyBpKyspIHsKICogICAgICAgICB2YXIgc3RyZWFtID0gZXZlbnQuc3RyZWFtc1tpXTsKICogICAgICAgICBhbGVydCgiU3RyZWFtICIgKyBzdHJlYW0ubmFtZSArICIgZW5kZWQuICIgKyBldmVudC5yZWFzb24pOwogKiAgICAgfQogKiB9PC9wcmU+CiAqCiAqIEBjbGFzcyBTdHJlYW1FdmVudAogKiBAcHJvcGVydHkge0FycmF5fSBzdHJlYW1zIEFuIGFycmF5IG9mIFN0cmVhbSBvYmplY3RzCiAqIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHN0cmVhbXMgdG8gd2hpY2ggdGhpcyBldmVudCByZWZlcnMuIFRoaXMgaXMgdXN1YWxseSBhbiBhcnJheSBjb250YWluaW5nIG9ubHkKICogb25lIFN0cmVhbSBvYmplY3QsIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHN0cmVhbSB0aGF0IHdhcyBhZGRlZCAoaW4gdGhlIGNhc2Ugb2YgYSA8Y29kZT5zdHJlYW1DcmVhdGVkPC9jb2RlPgogKiBldmVudCkgb3IgZGVsZXRlZCAoaW4gdGhlIGNhc2Ugb2YgYSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50KS4gSG93ZXZlciwgdGhlIGFycmF5IG1heSBjb250YWluCiAqIG11bHRpcGxlIFN0cmVhbSBvYmplY3RzIGlmIG11bHRpcGxlIHN0cmVhbXMgd2VyZSBhZGRlZCBvciBkZWxldGVkLiBBIHN0cmVhbSBtYXkgYmUgcHVibGlzaGVkIGJ5IHRoZSBsb2NhbCBjbGllbnQKICogb3IgYW5vdGhlciBjbGllbnQgY29ubmVjdGVkIHRvIHRoZSBzZXNzaW9uLgogKgogKiBAcHJvcGVydHkge1N0cmluZ30gcmVhc29uIEZvciBhIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gZXZlbnQsCiAqICBhIGRlc2NyaXB0aW9uIG9mIHdoeSB0aGUgc2Vzc2lvbiBkaXNjb25uZWN0ZWQuIFRoaXMgcHJvcGVydHkgY2FuIGhhdmUgb25lIG9mIHRoZSBmb2xsb3dpbmcgdmFsdWVzOgogKiA8L3A+CiAqIDx1bD4KICogIDxsaT48Y29kZT4iY2xpZW50RGlzY29ubmVjdGVkIjwvY29kZT4gJiMxNTE7IEEgY2xpZW50IGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBzZXNzaW9uIGJ5IGNhbGxpbmcKICogICAgIHRoZSA8Y29kZT5kaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgU2Vzc2lvbiBvYmplY3Qgb3IgYnkgY2xvc2luZyB0aGUgYnJvd3Nlci4KICogICAgIChTZWUgPGEgaHJlZj0iU2Vzc2lvbi5odG1sI2Rpc2Nvbm5lY3QiPlNlc3Npb24uZGlzY29ubmVjdCgpPC9hPi4pPC9saT4KICoKICogIDxsaT48Y29kZT4iZm9yY2VEaXNjb25uZWN0ZWQiPC9jb2RlPiAmIzE1MTsgQSBtb2RlcmF0b3IgaGFzIGRpc2Nvbm5lY3RlZCB0aGUgcHVibGlzaGVyIG9mIHRoZQogKiAgICBzdHJlYW0gZnJvbSB0aGUgc2Vzc2lvbiwgYnkgY2FsbGluZyB0aGUgPGNvZGU+Zm9yY2VEaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgU2Vzc2lvbiBvYmplY3QuCiAqICAgICAgKFNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjZm9yY2VEaXNjb25uZWN0Ij5TZXNzaW9uLmZvcmNlRGlzY29ubmVjdCgpPC9hPi4pPC9saT4KICoKICogIDxsaT48Y29kZT4iZm9yY2VVbnB1Ymxpc2hlZCI8L2NvZGU+ICYjMTUxOyBBIG1vZGVyYXRvciBoYXMgZm9yY2VkIHRoZSBwdWJsaXNoZXIgb2YgdGhlIHN0cmVhbSB0byBzdG9wCiAqICAgIHB1Ymxpc2hpbmcgdGhlIHN0cmVhbSwgYnkgY2FsbGluZyB0aGUgPGNvZGU+Zm9yY2VVbnB1Ymxpc2goKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4KICogICAgICAoU2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNmb3JjZVVucHVibGlzaCI+U2Vzc2lvbi5mb3JjZVVucHVibGlzaCgpPC9hPi4pPC9saT4KICoKICogIDxsaT48Y29kZT4ibmV0d29ya0Rpc2Nvbm5lY3RlZCI8L2NvZGU+ICYjMTUxOyBUaGUgbmV0d29yayBjb25uZWN0aW9uIHRlcm1pbmF0ZWQgYWJydXB0bHkgKGZvciBleGFtcGxlLAogKiAgICAgIHRoZSBjbGllbnQgbG9zdCB0aGVpciBpbnRlcm5ldCBjb25uZWN0aW9uKS48L2xpPgogKgogKiA8L3VsPgogKgogKiA8cD5EZXBlbmRpbmcgb24gdGhlIGNvbnRleHQsIHRoaXMgZGVzY3JpcHRpb24gbWF5IGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVmaW5lCiAqIHRoZSBjb3Vyc2Ugb2YgYWN0aW9uIHRoZXkgdGFrZSBpbiByZXNwb25zZSB0byBhbiBldmVudC48L3A+CiAqCiAqIDxwPkZvciBhIDxjb2RlPnN0cmVhbUNyZWF0ZWQ8L2NvZGU+IGV2ZW50LCB0aGlzIHN0cmluZyBpcyB1bmRlZmluZWQuPC9wPgogKgogKgogKiBAcHJvcGVydHkge0Jvb2xlYW59IGNhbmNlbGFibGUgICBXaGV0aGVyIHRoZSBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yIHRoYXQgaXMgY2FuY2VsYWJsZSAoPGNvZGU+dHJ1ZTwvY29kZT4pIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4KICogIFlvdSBjYW4gY2FuY2VsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGJ5IGNhbGxpbmcgdGhlIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+IG1ldGhvZCBvZgogKiAgdGhlIFN0cmVhbUV2ZW50IG9iamVjdCBpbiB0aGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24uIFRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+CiAqICBldmVudCBpcyBjYW5jZWxhYmxlLiAoU2VlIDxhIGhyZWY9IiNwcmV2ZW50RGVmYXVsdCI+cHJldmVudERlZmF1bHQoKTwvYT4uKQogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlN0cmVhbUV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIHN0cmVhbXMsIHJlYXNvbiwgY2FuY2VsYWJsZSkgewogICAgT1QuRXZlbnQuY2FsbCh0aGlzLCB0eXBlLCBjYW5jZWxhYmxlKTsKCiAgICB0aGlzLnN0cmVhbXMgPSBzdHJlYW1zOwogICAgdGhpcy5yZWFzb24gPSByZWFzb247Cn07CgovKioKKiBQcmV2ZW50cyB0aGUgZGVmYXVsdCBiZWhhdmlvciBhc3NvY2lhdGVkIHdpdGggdGhlIGV2ZW50IGZyb20gdGFraW5nIHBsYWNlLgoqCiogPHA+Rm9yIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50LCBpZiB0aGUgPGNvZGU+cmVhc29uPC9jb2RlPiBpcyBzZXQgdG8gPGNvZGU+ImZvcmNlRGlzY29ubmVjdGVkIjwvY29kZT4KKiBvciA8Y29kZT5uZXR3b3JrRGlzY29ubmVjdGVkPC9jb2RlPiwgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgdGhhdCBhbGwgU3Vic2NyaWJlciBvYmplY3RzIHRoYXQgYXJlCiogc3Vic2NyaWJlZCB0byB0aGUgc3RyZWFtIGFyZSB1bnN1YnNjcmliZWQgKGFuZCByZW1vdmVkIGZyb20gdGhlIEhUTUwgRE9NKS4gSWYgeW91IGNhbGwgdGhlIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+CiogbWV0aG9kIGluIHRoZSBldmVudCBsaXN0ZW5lciBmb3IgdGhlIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gZXZlbnQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCBhbmQKKiB5b3UgY2FuLCBvcHRpb25hbGx5LCBjbGVhbiB1cCBTdWJzY3JpYmVyIG9iamVjdHMgdXNpbmcgeW91ciBvd24gY29kZS4gU2VlCiogPGEgaHJlZj0iU2Vzc2lvbi5odG1sI2dldFN1YnNjcmliZXJzRm9yU3RyZWFtIj5TZXNzaW9uLmdldFN1YnNjcmliZXJzRm9yU3RyZWFtKCk8L2E+LjwvcD4KKgoqIDxwPklmIHRoZSA8Y29kZT5yZWFzb248L2NvZGU+IHByb3BlcnR5IGlzIHNldCB0byA8Y29kZT4iZm9yY2VVbnB1Ymxpc2hlZCI8L2NvZGU+LCB0aGUgZGVmYXVsdCBiZWhhdmlvcgoqIGlzIHRoYXQgdGhlIGFzc29jaWF0ZWQgU3Vic2NyaWJlciBvciBQdWJsaXNoZXIgb2JqZWN0cyBjb3JyZXNwb25kaW5nIHdpdGggdGhlIHN0cmVhbSBhcmUgdW5zdWJzY3JpYmVkCiogb3IgdW5wdWJsaXNoZWQgKGFuZCByZW1vdmVkIGZyb20gdGhlIEhUTUwgRE9NKS4gSWYgeW91IGNhbGwgdGhlIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+IG1ldGhvZCBpbiB0aGUKKiBldmVudCBsaXN0ZW5lciBmb3IgdGhlIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gZXZlbnQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCBhbmQKKiB5b3UgY2FuLCBvcHRpb25hbGx5LCBjbGVhbiB1cCBTdWJzY3JpYmVyIG9yIFB1Ymxpc2hlciBvYmplY3RzIHVzaW5nIHlvdXIgb3duIGNvZGUuIFNlZQoqIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNnZXRQdWJsaXNoZXJGb3JTdHJlYW0iPlNlc3Npb24uZ2V0UHVibGlzaGVyRm9yU3RyZWFtKCk8L2E+IGFuZAoqIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNnZXRTdWJzY3JpYmVyc0ZvclN0cmVhbSI+U2Vzc2lvbi5nZXRTdWJzY3JpYmVyc0ZvclN0cmVhbSgpPC9hPi48L3A+CioKKiA8cD5UbyBzZWUgd2hldGhlciBhbiBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yLCBjaGVjayB0aGUgPGNvZGU+Y2FuY2VsYWJsZTwvY29kZT4gcHJvcGVydHkgb2YgdGhlIGV2ZW50IG9iamVjdC4gPC9wPgoqCiogPHA+Q2FsbCB0aGUgPGNvZGU+cHJldmVudERlZmF1bHQoKTwvY29kZT4gbWV0aG9kIGluIHRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3IgdGhlIGV2ZW50LjwvcD4KKgoqIEBtZXRob2QgI3ByZXZlbnREZWZhdWx0CiogQG1lbWJlcm9mIFN0cmVhbUV2ZW50CiovCgoKLyoqCiAqIFRoZSBTZXNzaW9uIG9iamVjdCBkaXNwYXRjaGVzIFNlc3Npb25Db25uZWN0RXZlbnQgb2JqZWN0IHdoZW4gYSBzZXNzaW9uIGhhcyBzdWNjZXNzZnVsbHkgY29ubmVjdGVkIGluIHJlc3BvbnNlIHRvIGEgY2FsbCB0bwogKiB0aGUgPGNvZGU+Y29ubmVjdCgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIFNlc3Npb24gb2JqZWN0LgogKgogKiAgPHA+CiAqICBGb3IgYW4gZXhhbXBsZSwgc2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNjb25uZWN0Ij5TZXNzaW9uLmNvbm5lY3QoKTwvYT4uCiAqICA8L3A+CiAqCiAqIEBjbGFzcyBTZXNzaW9uQ29ubmVjdEV2ZW50CiAqIEBwcm9wZXJ0eSB7QXJyYXl9IGNvbm5lY3Rpb25zIEFuIGFycmF5IG9mIENvbm5lY3Rpb24gb2JqZWN0cywgcmVwcmVzZW50aW5nIGNvbm5lY3Rpb25zIHRvIHRoZSBzZXNzaW9uLgogKiAoTm90ZSB0aGF0IGVhY2ggY29ubmVjdGlvbiBjYW4gcHVibGlzaCBtdWx0aXBsZSBzdHJlYW1zLikKICogQHByb3BlcnR5IHtBcnJheX0gc3RyZWFtcyBBbiBhcnJheSBvZiBTdHJlYW0gb2JqZWN0cyBjb3JyZXNwb25kaW5nIHRvIHRoZSBzdHJlYW1zIGN1cnJlbnRseSBhdmFpbGFibGUgaW4gdGhlIHNlc3Npb24gdGhhdCBoYXMgY29ubmVjdGVkLgogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlNlc3Npb25Db25uZWN0RXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgY29ubmVjdGlvbnMsIHN0cmVhbXMsIGFyY2hpdmVzKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMuY29ubmVjdGlvbnMgPSBjb25uZWN0aW9uczsKICAgIHRoaXMuc3RyZWFtcyA9IHN0cmVhbXM7CiAgICB0aGlzLmFyY2hpdmVzID0gYXJjaGl2ZXM7CiAgICB0aGlzLmdyb3VwcyA9IFtdOyAvLyBEZXByZWNhdGVkIGluIE9wZW5Ub2sgdjAuOTEuNDgKfTsKCi8qKgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBTZXNzaW9uRGlzY29ubmVjdEV2ZW50IG9iamVjdCB3aGVuIGEgc2Vzc2lvbiBoYXMgZGlzY29ubmVjdGVkLiBUaGlzIGV2ZW50IG1heSBiZSBkaXNwYXRjaGVkIGFzeW5jaHJvbm91c2x5IGluCiAqIHJlc3BvbnNlIHRvIGEgc3VjY2Vzc2Z1bCBjYWxsIHRvIHRoZSA8Y29kZT5kaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgc2Vzc2lvbiBvYmplY3QuCiAqCiAqICA8aDQ+CiAqICAgIDxhIGhyZWY9ImV4YW1wbGUiPjwvYT5FeGFtcGxlCiAqICA8L2g0PgogKiAgPHA+CiAqICAgIFRoZSBmb2xsb3dpbmcgY29kZSBpbml0aWFsaXplcyBhIHNlc3Npb24gYW5kIHNldHMgdXAgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIHdoZW4gYSBzZXNzaW9uIGlzIGRpc2Nvbm5lY3RlZC4KICogIDwvcD4KICogPHByZT52YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqICB2YXIgc2Vzc2lvbklEID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIG93biBzZXNzaW9uIElELgogKiAgICAgICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKiAgdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKgogKiAgdmFyIHNlc3Npb24gPSBUQi5pbml0U2Vzc2lvbihzZXNzaW9uSUQpOwogKiAgc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzZXNzaW9uRGlzY29ubmVjdGVkIiwgc2Vzc2lvbkRpc2Nvbm5lY3RlZEhhbmRsZXIpOwogKiAgc2Vzc2lvbi5jb25uZWN0KGFwaUtleSwgdG9rZW4pOwogKgogKiAgZnVuY3Rpb24gc2Vzc2lvbkRpc0Nvbm5lY3RlZEhhbmRsZXIoZXZlbnQpIHsKICogICAgICBhbGVydCgiVGhlIHNlc3Npb24gZGlzY29ubmVjdGVkLiAiICsgZXZlbnQucmVhc29uKTsKICogIH0KICogIDwvcHJlPgogKgogKiBAcHJvcGVydHkge1N0cmluZ30gcmVhc29uIEEgZGVzY3JpcHRpb24gb2Ygd2h5IHRoZSBzZXNzaW9uIGRpc2Nvbm5lY3RlZC4KICogICBUaGlzIHByb3BlcnR5IGNhbiBoYXZlIHR3byB2YWx1ZXM6CiAqICA8L3A+CiAqICA8dWw+CiAqICAgIDxsaT48Y29kZT4iY2xpZW50RGlzY29ubmVjdGVkIjwvY29kZT4gJiMxNTE7IEEgY2xpZW50IGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBzZXNzaW9uIGJ5IGNhbGxpbmcKICogICAgIHRoZSA8Y29kZT5kaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgU2Vzc2lvbiBvYmplY3Qgb3IgYnkgY2xvc2luZyB0aGUgYnJvd3Nlci4KICogICAgICAoIFNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjZGlzY29ubmVjdCI+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2E+Lik8L2xpPgogKiAgICA8bGk+PGNvZGU+ImZvcmNlRGlzY29ubmVjdGVkIjwvY29kZT4gJiMxNTE7IEEgbW9kZXJhdG9yIGhhcyBkaXNjb25uZWN0ZWQgeW91IGZyb20gdGhlIHNlc3Npb24KICogICAgIGJ5IGNhbGxpbmcgdGhlIDxjb2RlPmZvcmNlRGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIFNlc3Npb24gb2JqZWN0LiAoU2VlCiAqICAgICAgIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNmb3JjZURpc2Nvbm5lY3QiPlNlc3Npb24uZm9yY2VEaXNjb25uZWN0KCk8L2E+Lik8L2xpPgogKiAgICA8bGk+PGNvZGU+Im5ldHdvcmtEaXNjb25uZWN0ZWQiPC9jb2RlPiAmIzE1MTsgVGhlIG5ldHdvcmsgY29ubmVjdGlvbiB0ZXJtaW5hdGVkIGFicnVwdGx5IChmb3IgZXhhbXBsZSwKICogICAgICAgdGhlIGNsaWVudCBsb3N0IHRoZWlyIGludGVybmV0IGNvbm5lY3Rpb24pLjwvbGk+CiAqICA8L3VsPgogKgogKiBAY2xhc3MgU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudAogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlNlc3Npb25EaXNjb25uZWN0RXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgcmVhc29uLCBjYW5jZWxhYmxlKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUsIGNhbmNlbGFibGUpOwoKICAgIHRoaXMucmVhc29uID0gcmVhc29uOwp9OwoKLyoqCiogUHJldmVudHMgdGhlIGRlZmF1bHQgYmVoYXZpb3IgYXNzb2NpYXRlZCB3aXRoIHRoZSBldmVudCBmcm9tIHRha2luZyBwbGFjZS4KKgoqIDxwPkZvciB0aGUgPGNvZGU+c2Vzc2lvbkRpc2Nvbm5lY3RFdmVudDwvY29kZT4sIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzOiBhbGwgU3Vic2NyaWJlciBvYmplY3RzIGFyZSB1bnN1YnNjcmliZWQsCiogYW5kIFB1Ymxpc2hlciBvYmplY3RzIGFyZSBkZXN0cm95ZWQuIElmIHlvdSBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2QgaW4gdGhlCiogZXZlbnQgbGlzdGVuZXIgZm9yIHRoZSA8Y29kZT5zZXNzaW9uRGlzY29ubmVjdDwvY29kZT4gZXZlbnQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCAoYW5kCiogeW91IGNhbiwgb3B0aW9uYWxseSwgY2xlYW4gdXAgU3Vic2NyaWJlciBhbmQgUHVibGlzaGVyIG9iamVjdHMgdXNpbmcgeW91ciBvd24gY29kZSkuCioKKiA8cD5UbyBzZWUgd2hldGhlciBhbiBldmVudCBoYXMgYSBkZWZhdWx0IGJlaGF2aW9yLCBjaGVjayB0aGUgPGNvZGU+Y2FuY2VsYWJsZTwvY29kZT4gcHJvcGVydHkgb2YgdGhlIGV2ZW50IG9iamVjdC4gPC9wPgoqCiogPHA+Q2FsbCB0aGUgPGNvZGU+cHJldmVudERlZmF1bHQoKTwvY29kZT4gbWV0aG9kIGluIHRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3IgdGhlIGV2ZW50LjwvcD4KKgoqIEBtZXRob2QgI3ByZXZlbnREZWZhdWx0CiogQG1lbWJlcm9mIFNlc3Npb25EaXNjb25uZWN0RXZlbnQKKi8KCk9ULlZvbHVtZUV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIHN0cmVhbUlkLCB2b2x1bWUpIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy5zdHJlYW1JZCA9IHN0cmVhbUlkOwogICAgdGhpcy52b2x1bWUgPSB2b2x1bWU7Cn07CgoKT1QuRGV2aWNlRXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgY2FtZXJhLCBtaWNyb3Bob25lKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgdGhpcy5taWNyb3Bob25lID0gbWljcm9waG9uZTsKfTsKCk9ULkRldmljZVN0YXR1c0V2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIGNhbWVyYXMsIG1pY3JvcGhvbmVzLCBzZWxlY3RlZENhbWVyYSwgc2VsZWN0ZWRNaWNyb3Bob25lKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMuY2FtZXJhcyA9IGNhbWVyYXM7CiAgICB0aGlzLm1pY3JvcGhvbmVzID0gbWljcm9waG9uZXM7CiAgICB0aGlzLnNlbGVjdGVkQ2FtZXJhID0gc2VsZWN0ZWRDYW1lcmE7CiAgICB0aGlzLnNlbGVjdGVkTWljcm9waG9uZSA9IHNlbGVjdGVkTWljcm9waG9uZTsKfTsKCk9ULlJlc2l6ZUV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIHdpZHRoRnJvbSwgd2lkdGhUbywgaGVpZ2h0RnJvbSwgaGVpZ2h0VG8pIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy53aWR0aEZyb20gPSB3aWR0aEZyb207CiAgICB0aGlzLndpZHRoVG8gPSB3aWR0aFRvOwogICAgdGhpcy5oZWlnaHRGcm9tID0gaGVpZ2h0RnJvbTsKICAgIHRoaXMuaGVpZ2h0VG8gPSBoZWlnaHRUbzsKfTsKCi8qKgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnN0cmVhbVByb3BlcnR5Q2hhbmdlZDwvY29kZT4gZXZlbnQgaW4gdGhlIGZvbGxvd2luZyBjaXJjdW1zdGFuY2VzOgogKgogKiA8dWw+CiAqCiAqICA8bGk+V2hlbiBhIHB1Ymxpc2hlciBzdGFydHMgb3Igc3RvcHMgcHVibGlzaGluZyBhdWRpbyBvciB2aWRlby4gVGhpcyBjaGFuZ2UgY2F1c2VzIHRoZSA8Y29kZT5oYXNBdWRpbzwvY29kZT4KICogIG9yIDxjb2RlPmhhc1ZpZGVvPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUgU3RyZWFtIG9iamVjdCB0byBjaGFuZ2UuIFRoaXMgY2hhbmdlIHJlc3VsdHMgZnJvbSBhIGNhbGwgdG8gdGhlCiAqICA8Y29kZT5wdWJsaXNoQXVkaW8oKTwvY29kZT4gb3IgPGNvZGU+cHVibGlzaFZpZGVvKCk8L2NvZGU+IG1ldGhvZHMgb2YgdGhlIFB1Ymxpc2ggb2JqZWN0LjwvbGk+CiAqCiAqICA8bGk+V2hlbiB0aGUgPGNvZGU+dmlkZW9EaW1lbnNpb25zPC9jb2RlPiBwcm9wZXJ0eSBvZiBhIHN0cmVhbSBjaGFuZ2VzLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwKICogIHNlZSA8YSBocmVmPSJTdHJlYW0uaHRtbCNwcm9wZXJ0aWVzIj5TdHJlYW0udmlkZW9EaW1lbnNpb25zPC9hPi48L2xpPgogKgogKiA8L3VsPgogKgogKiBAY2xhc3MgU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQKICogQHByb3BlcnR5IHtTdHJpbmd9IGNoYW5nZWRQcm9wZXJ0eSBUaGUgcHJvcGVydHkgb2YgdGhlIHN0cmVhbSB0aGF0IGNoYW5nZWQuIFRoaXMgdmFsdWUgaXMgZWl0aGVyIDxjb2RlPiJoYXNBdWRpbyI8L2NvZGU+LAogKiA8Y29kZT4iaGFzVmlkZW8iPC9jb2RlPiwgb3IgPGNvZGU+InZpZGVvRGltZW5zaW9ucyI8L2NvZGU+LgogKiBAcHJvcGVydHkge1N0cmVhbX0gc3RyZWFtIFRoZSBTdHJlYW0gb2JqZWN0IGZvciB3aGljaCBhIHByb3BlcnR5IGhhcyBjaGFuZ2VkLgogKiBAcHJvcGVydHkge09iamVjdH0gbmV3VmFsdWUgVGhlIG5ldyB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgKGFmdGVyIHRoZSBjaGFuZ2UpLgogKiBAcHJvcGVydHkge09iamVjdH0gb2xkVmFsdWUgVGhlIG9sZCB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgKGJlZm9yZSB0aGUgY2hhbmdlKS4KICoKICogQHNlZSA8YSBocmVmPSJQdWJsaXNoZXIuaHRtbCNwdWJsaXNoQXVkaW8iPlB1Ymxpc2hlci5wdWJsaXNoQXVkaW8oKTwvYT48L3A+CiAqIEBzZWUgPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaFZpZGVvIj5QdWJsaXNoZXIucHVibGlzaFZpZGVvKCk8L2E+PC9wPgogKiBAc2VlIDxhIGhyZWY9IlN0cmVhbS5odG1sI3Byb3BlcnRpZXMiPlN0cmVhbS52aWRlb0RpbWVuc2lvbnM8L2E+PC9wPgogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlN0cmVhbVByb3BlcnR5Q2hhbmdlZEV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIHN0cmVhbSwgY2hhbmdlZFByb3BlcnR5LCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtOwogICAgdGhpcy5jaGFuZ2VkUHJvcGVydHkgPSBjaGFuZ2VkUHJvcGVydHk7CiAgICB0aGlzLm9sZFZhbHVlID0gb2xkVmFsdWU7CiAgICB0aGlzLm5ld1ZhbHVlID0gbmV3VmFsdWU7Cn07CgpPVC5BcmNoaXZlRXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgYXJjaGl2ZXMpIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy5hcmNoaXZlcyA9IGFyY2hpdmVzOwp9OwoKT1QuQXJjaGl2ZVN0cmVhbUV2ZW50ID0gZnVuY3Rpb24gKHR5cGUsIGFyY2hpdmUsIHN0cmVhbXMpIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSk7CgogICAgdGhpcy5hcmNoaXZlID0gYXJjaGl2ZTsKICAgIHRoaXMuc3RyZWFtcyA9IHN0cmVhbXM7Cn07CgpPVC5TdGF0ZUNoYW5nZWRFdmVudCA9IGZ1bmN0aW9uICh0eXBlLCBjaGFuZ2VkVmFsdWVzKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsIHR5cGUpOwoKICAgIHRoaXMuY2hhbmdlZFZhbHVlcyA9IGNoYW5nZWRWYWx1ZXM7Cn07CgpPVC5DaGFuZ2VGYWlsZWRFdmVudCA9IGZ1bmN0aW9uICh0eXBlLCByZWFzb25Db2RlLCByZWFzb24sIGZhaWxlZFZhbHVlcykgewogICAgT1QuRXZlbnQuY2FsbCh0aGlzLCB0eXBlKTsKCiAgICB0aGlzLnJlYXNvbkNvZGUgPSByZWFzb25Db2RlOwogICAgdGhpcy5yZWFzb24gPSByZWFzb247CiAgICB0aGlzLmZhaWxlZFZhbHVlcyA9IGZhaWxlZFZhbHVlczsKfTsKCi8qKgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIHNpZ25hbCBldmVudCB3aGVuIHRoZSBjbGllbnQgcmVjZWl2ZXMgYSBzaWduYWwgZnJvbSB0aGUgc2Vzc2lvbi4KICoKICogQGNsYXNzIFNpZ25hbEV2ZW50CiAqIEBwcm9wZXJ0eSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIGFzc2lnbmVkIHRvIHRoZSBzaWduYWwgKGlmIHRoZXJlIGlzIG9uZSkuIFVzZSB0aGUgdHlwZSB0byBmaWx0ZXIgc2lnbmFscwogKiByZWNlaXZlZCAoYnkgYWRkaW5nIGFuIGV2ZW50IGhhbmRsZXIgZm9yIHNpZ25hbDp0eXBlMSBvciBzaWduYWw6dHlwZTIsIGV0Yy4pCiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHBheWxvYWQgc2VudCB3aXRoIHRoZSBzaWduYWwgKGlmIHRoZXJlIGlzIG9uZSkuCiAqIEBwcm9wZXJ0eSB7Q29ubmVjdGlvbn0gZnJvbSBUaGUgQ29ubmVjdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZSBjbGllbnQgdGhhdCBzZW50IHdpdGggdGhlIHNpZ25hbC4KICoKICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjc2lnbmFsIj5TZXNzaW9uLnNpZ25hbCgpPC9hPjwvcD4KICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjZXZlbnRzIj5TZXNzaW9uIGV2ZW50cyAoc2lnbmFsIGFuZCBzaWduYWw6dHlwZSk8L2E+PC9wPgogKiBAYXVnbWVudHMgRXZlbnQKICovCk9ULlNpZ25hbEV2ZW50ID0gZnVuY3Rpb24odHlwZSwgZGF0YSwgZnJvbSkgewogICAgT1QuRXZlbnQuY2FsbCh0aGlzLCB0eXBlID8gInNpZ25hbDoiICsgdHlwZSA6IE9ULkV2ZW50Lm5hbWVzLlNJR05BTCwgZmFsc2UpOwoKICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICB0aGlzLmZyb20gPSBmcm9tOwp9OwoKCk9ULlN0cmVhbVVwZGF0ZWRFdmVudCA9IGZ1bmN0aW9uIChzdHJlYW0sIGtleSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7CiAgICBPVC5FdmVudC5jYWxsKHRoaXMsICd1cGRhdGVkJyk7CgogICAgdGhpcy50YXJnZXQgPSBzdHJlYW07CiAgICB0aGlzLmNoYW5nZWRQcm9wZXJ0eSA9IGtleTsKICAgIHRoaXMub2xkVmFsdWUgPSBvbGRWYWx1ZTsKICAgIHRoaXMubmV3VmFsdWUgPSBuZXdWYWx1ZTsKfTsKCk9ULkRlc3Ryb3llZEV2ZW50ID0gZnVuY3Rpb24odHlwZSwgdGFyZ2V0LCByZWFzb24pIHsKICAgIE9ULkV2ZW50LmNhbGwodGhpcywgdHlwZSwgZmFsc2UpOwoKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5yZWFzb24gPSByZWFzb247Cn07CgoKfSkod2luZG93KTsKLy8gaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9zdHJpbmdlbmNvZGluZy8KLy8gQW4gaW1wbGVtZW50YXRpb24gb2YgaHR0cDovL2VuY29kaW5nLnNwZWMud2hhdHdnLm9yZy8jYXBpCi8vCihmdW5jdGlvbihnbG9iYWwpIHsKICAndXNlIHN0cmljdCc7CgogIGlmICggKGdsb2JhbC5UZXh0RW5jb2RlciAhPT0gdm9pZCAwKSAmJiAoZ2xvYmFsLlRleHREZWNvZGVyICE9PSB2b2lkIDApKSAgewogICAgLy8gZGVmZXIgdG8gdGhlIG5hdGl2ZSBvbmVzCiAgICAvLyBAdG9kbyBpcyB0aGlzIGEgZ29vZCBpZGVhPwogICAgcmV0dXJuOwogIH0KCiAgLy8KICAvLyBVdGlsaXRpZXMKICAvLwoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gYSBUaGUgbnVtYmVyIHRvIHRlc3QuCiAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiBUaGUgbWluaW11bSB2YWx1ZSBpbiB0aGUgcmFuZ2UsIGluY2x1c2l2ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IFRoZSBtYXhpbXVtIHZhbHVlIGluIHRoZSByYW5nZSwgaW5jbHVzaXZlLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYSA+PSBtaW4gYW5kIGEgPD0gbWF4LgogICAqLwogIGZ1bmN0aW9uIGluUmFuZ2UoYSwgbWluLCBtYXgpIHsKICAgIHJldHVybiBtaW4gPD0gYSAmJiBhIDw9IG1heDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1lcmF0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGQgVGhlIGRlbm9taW5hdG9yLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJlc3VsdCBvZiB0aGUgaW50ZWdlciBkaXZpc2lvbiBvZiBuIGJ5IGQuCiAgICovCiAgZnVuY3Rpb24gZGl2KG4sIGQpIHsKICAgIHJldHVybiBNYXRoLmZsb29yKG4gLyBkKTsKICB9CgoKICAvLwogIC8vIEltcGxlbWVudGF0aW9uIG9mIEVuY29kaW5nIHNwZWNpZmljYXRpb24KICAvLyBodHRwOi8vZHZjcy53My5vcmcvaGcvZW5jb2RpbmcvcmF3LWZpbGUvdGlwL092ZXJ2aWV3Lmh0bWwKICAvLwoKICAvLwogIC8vIDMuIFRlcm1pbm9sb2d5CiAgLy8KCiAgLy8KICAvLyA0LiBFbmNvZGluZ3MKICAvLwoKICAvKiogQGNvbnN0ICovIHZhciBFT0ZfYnl0ZSA9IC0xOwogIC8qKiBAY29uc3QgKi8gdmFyIEVPRl9jb2RlX3BvaW50ID0gLTE7CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7VWludDhBcnJheX0gYnl0ZXMgQXJyYXkgb2YgYnl0ZXMgdGhhdCBwcm92aWRlIHRoZSBzdHJlYW0uCiAgICovCiAgZnVuY3Rpb24gQnl0ZUlucHV0U3RyZWFtKGJ5dGVzKSB7CiAgICAvKiogQHR5cGUge251bWJlcn0gKi8KICAgIHZhciBwb3MgPSAwOwoKICAgIC8qKiBAcmV0dXJuIHtudW1iZXJ9IEdldCB0aGUgbmV4dCBieXRlIGZyb20gdGhlIHN0cmVhbS4gKi8KICAgIHRoaXMuZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAocG9zID49IGJ5dGVzLmxlbmd0aCkgPyBFT0ZfYnl0ZSA6IE51bWJlcihieXRlc1twb3NdKTsKICAgIH07CgogICAgLyoqIEBwYXJhbSB7bnVtYmVyfSBuIE51bWJlciAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIGJ5IHdoaWNoIHRvCiAgICAgKiAgICAgIG9mZnNldCB0aGUgYnl0ZSBwb2ludGVyLiAqLwogICAgdGhpcy5vZmZzZXQgPSBmdW5jdGlvbihuKSB7CiAgICAgIHBvcyArPSBuOwogICAgICBpZiAocG9zIDwgMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignU2Vla2luZyBwYXN0IHN0YXJ0IG9mIHRoZSBidWZmZXInKTsKICAgICAgfQogICAgICBpZiAocG9zID4gYnl0ZXMubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZWVraW5nIHBhc3QgRU9GJyk7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0FycmF5LjxudW1iZXI+fSB0ZXN0IEFycmF5IG9mIGJ5dGVzIHRvIGNvbXBhcmUgYWdhaW5zdC4KICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIHN0YXJ0IG9mIHRoZSBzdHJlYW0gbWF0Y2hlcyB0aGUgdGVzdAogICAgICogICAgIGJ5dGVzLgogICAgICovCiAgICB0aGlzLm1hdGNoID0gZnVuY3Rpb24odGVzdCkgewogICAgICBpZiAodGVzdC5sZW5ndGggPiBwb3MgKyBieXRlcy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIGk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCB0ZXN0Lmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgaWYgKE51bWJlcihieXRlc1twb3MgKyBpXSkgIT09IHRlc3RbaV0pIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtBcnJheS48bnVtYmVyPn0gYnl0ZXMgVGhlIGFycmF5IHRvIHdyaXRlIGJ5dGVzIGludG8uCiAgICovCiAgZnVuY3Rpb24gQnl0ZU91dHB1dFN0cmVhbShieXRlcykgewogICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovCiAgICB2YXIgcG9zID0gMDsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Li4ubnVtYmVyfSB2YXJfYXJncyBUaGUgYnl0ZSBvciBieXRlcyB0byBlbWl0IGludG8gdGhlIHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVtaXQgPSBmdW5jdGlvbih2YXJfYXJncykgewogICAgICAvKiogQHR5cGUge251bWJlcn0gKi8KICAgICAgdmFyIGxhc3QgPSBFT0ZfYnl0ZTsKICAgICAgdmFyIGk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgICBsYXN0ID0gTnVtYmVyKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgYnl0ZXNbcG9zKytdID0gbGFzdDsKICAgICAgfQogICAgICByZXR1cm4gbGFzdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzb3VyY2Ugb2YgY29kZSB1bml0cyBmb3IgdGhlIHN0cmVhbS4KICAgKi8KICBmdW5jdGlvbiBDb2RlUG9pbnRJbnB1dFN0cmVhbShzdHJpbmcpIHsKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBJbnB1dCBzdHJpbmcgb2YgVVRGLTE2IGNvZGUgdW5pdHMuCiAgICAgKiBAcmV0dXJuIHtBcnJheS48bnVtYmVyPn0gQ29kZSBwb2ludHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0cmluZ1RvQ29kZVBvaW50cyhzdHJpbmcpIHsKICAgICAgLyoqIEB0eXBlIHtBcnJheS48bnVtYmVyPn0gKi8KICAgICAgdmFyIGNwcyA9IFtdOwogICAgICAvLyBCYXNlZCBvbiBodHRwOi8vd3d3LnczLm9yZy9UUi9XZWJJREwvI2lkbC1ET01TdHJpbmcKICAgICAgdmFyIGkgPSAwLCBuID0gc3RyaW5nLmxlbmd0aDsKICAgICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoKSB7CiAgICAgICAgdmFyIGMgPSBzdHJpbmcuY2hhckNvZGVBdChpKTsKICAgICAgICBpZiAoIWluUmFuZ2UoYywgMHhEODAwLCAweERGRkYpKSB7CiAgICAgICAgICBjcHMucHVzaChjKTsKICAgICAgICB9IGVsc2UgaWYgKGluUmFuZ2UoYywgMHhEQzAwLCAweERGRkYpKSB7CiAgICAgICAgICBjcHMucHVzaCgweEZGRkQpOwogICAgICAgIH0gZWxzZSB7IC8vIChpblJhbmdlKGN1LCAweEQ4MDAsIDB4REJGRikpCiAgICAgICAgICBpZiAoaSA9PT0gbiAtIDEpIHsKICAgICAgICAgICAgY3BzLnB1c2goMHhGRkZEKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkID0gc3RyaW5nLmNoYXJDb2RlQXQoaSArIDEpOwogICAgICAgICAgICBpZiAoaW5SYW5nZShkLCAweERDMDAsIDB4REZGRikpIHsKICAgICAgICAgICAgICB2YXIgYSA9IGMgJiAweDNGRjsKICAgICAgICAgICAgICB2YXIgYiA9IGQgJiAweDNGRjsKICAgICAgICAgICAgICBpICs9IDE7CiAgICAgICAgICAgICAgY3BzLnB1c2goMHgxMDAwMCArIChhIDw8IDEwKSArIGIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNwcy5wdXNoKDB4RkZGRCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaSArPSAxOwogICAgICB9CiAgICAgIHJldHVybiBjcHM7CiAgICB9CgogICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovCiAgICB2YXIgcG9zID0gMDsKICAgIC8qKiBAdHlwZSB7QXJyYXkuPG51bWJlcj59ICovCiAgICB2YXIgY3BzID0gc3RyaW5nVG9Db2RlUG9pbnRzKHN0cmluZyk7CgogICAgLyoqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgYnl0ZXMgKHBvc2l0aXZlIG9yIG5lZ2F0aXZlKQogICAgICogICAgICB0byBhZHZhbmNlIHRoZSBjb2RlIHBvaW50IHBvaW50ZXIgYnkuKi8KICAgIHRoaXMub2Zmc2V0ID0gZnVuY3Rpb24obikgewogICAgICBwb3MgKz0gbjsKICAgICAgaWYgKHBvcyA8IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlZWtpbmcgcGFzdCBzdGFydCBvZiB0aGUgYnVmZmVyJyk7CiAgICAgIH0KICAgICAgaWYgKHBvcyA+IGNwcy5sZW5ndGgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlZWtpbmcgcGFzdCBFT0YnKTsKICAgICAgfQogICAgfTsKCgogICAgLyoqIEByZXR1cm4ge251bWJlcn0gR2V0IHRoZSBuZXh0IGNvZGUgcG9pbnQgZnJvbSB0aGUgc3RyZWFtLiAqLwogICAgdGhpcy5nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKHBvcyA+PSBjcHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIEVPRl9jb2RlX3BvaW50OwogICAgICB9CiAgICAgIHJldHVybiBjcHNbcG9zXTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBDb2RlUG9pbnRPdXRwdXRTdHJlYW0oKSB7CiAgICAvKiogQHR5cGUge3N0cmluZ30gKi8KICAgIHZhciBzdHJpbmcgPSAnJzsKCiAgICAvKiogQHJldHVybiB7c3RyaW5nfSBUaGUgYWNjdW11bGF0ZWQgc3RyaW5nLiAqLwogICAgdGhpcy5zdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHN0cmluZzsKICAgIH07CgogICAgLyoqIEBwYXJhbSB7bnVtYmVyfSBjIFRoZSBjb2RlIHBvaW50IHRvIGVuY29kZSBpbnRvIHRoZSBzdHJlYW0uICovCiAgICB0aGlzLmVtaXQgPSBmdW5jdGlvbihjKSB7CiAgICAgIGlmIChjIDw9IDB4RkZGRikgewogICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwogICAgICB9IGVsc2UgewogICAgICAgIGMgLT0gMHgxMDAwMDsKICAgICAgICBzdHJpbmcgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweEQ4MDAgKyAoKGMgPj4gMTApICYgMHgzZmYpKTsKICAgICAgICBzdHJpbmcgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweERDMDAgKyAoYyAmIDB4M2ZmKSk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZSBEZXNjcmlwdGlvbiBvZiB0aGUgZXJyb3IuCiAgICovCiAgZnVuY3Rpb24gRW5jb2RpbmdFcnJvcihtZXNzYWdlKSB7CiAgICB0aGlzLm5hbWUgPSAnRW5jb2RpbmdFcnJvcic7CiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgdGhpcy5jb2RlID0gMDsKICB9CiAgRW5jb2RpbmdFcnJvci5wcm90b3R5cGUgPSBFcnJvci5wcm90b3R5cGU7CgogIC8qKgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmF0YWwgSWYgdHJ1ZSwgZGVjb2RpbmcgZXJyb3JzIHJhaXNlIGFuIGV4Y2VwdGlvbi4KICAgKiBAcGFyYW0ge251bWJlcj19IG9wdF9jb2RlX3BvaW50IE92ZXJyaWRlIHRoZSBzdGFuZGFyZCBmYWxsYmFjayBjb2RlIHBvaW50LgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGNvZGUgcG9pbnQgdG8gaW5zZXJ0IG9uIGEgZGVjb2RpbmcgZXJyb3IuCiAgICovCiAgZnVuY3Rpb24gZGVjb2RlckVycm9yKGZhdGFsLCBvcHRfY29kZV9wb2ludCkgewogICAgaWYgKGZhdGFsKSB7CiAgICAgIHRocm93IG5ldyBFbmNvZGluZ0Vycm9yKCdEZWNvZGVyIGVycm9yJyk7CiAgICB9CiAgICByZXR1cm4gb3B0X2NvZGVfcG9pbnQgfHwgMHhGRkZEOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvZGVfcG9pbnQgVGhlIGNvZGUgcG9pbnQgdGhhdCBjb3VsZCBub3QgYmUgZW5jb2RlZC4KICAgKi8KICBmdW5jdGlvbiBlbmNvZGVyRXJyb3IoY29kZV9wb2ludCkgewogICAgdGhyb3cgbmV3IEVuY29kaW5nRXJyb3IoJ1RoZSBjb2RlIHBvaW50ICcgKyBjb2RlX3BvaW50ICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgY291bGQgbm90IGJlIGVuY29kZWQuJyk7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge3N0cmluZ30gbGFiZWwgVGhlIGVuY29kaW5nIGxhYmVsLgogICAqIEByZXR1cm4gez97bmFtZTpzdHJpbmcsbGFiZWxzOkFycmF5LjxzdHJpbmc+fX0KICAgKi8KICBmdW5jdGlvbiBnZXRFbmNvZGluZyhsYWJlbCkgewogICAgbGFiZWwgPSBTdHJpbmcobGFiZWwpLnRyaW0oKS50b0xvd2VyQ2FzZSgpOwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChsYWJlbF90b19lbmNvZGluZywgbGFiZWwpKSB7CiAgICAgIHJldHVybiBsYWJlbF90b19lbmNvZGluZ1tsYWJlbF07CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8qKiBAdHlwZSB7QXJyYXkuPHtlbmNvZGluZ3M6IEFycmF5Ljx7bmFtZTpzdHJpbmcsbGFiZWxzOkFycmF5LjxzdHJpbmc+fT4sCiAgICogICAgICBoZWFkaW5nOiBzdHJpbmd9Pn0gKi8KICB2YXIgZW5jb2RpbmdzID0gWwogICAgewogICAgICAnZW5jb2RpbmdzJzogWwogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICd1bmljb2RlLTEtMS11dGYtOCcsCiAgICAgICAgICAgICd1dGYtOCcsCiAgICAgICAgICAgICd1dGY4JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3V0Zi04JwogICAgICAgIH0KICAgICAgXSwKICAgICAgJ2hlYWRpbmcnOiAnVGhlIEVuY29kaW5nJwogICAgfSwKICAgIHsKICAgICAgJ2VuY29kaW5ncyc6IFsKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3A4NjQnLAogICAgICAgICAgICAnaWJtODY0JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2libTg2NCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjcDg2NicsCiAgICAgICAgICAgICdpYm04NjYnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaWJtODY2JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2NzaXNvbGF0aW4yJywKICAgICAgICAgICAgJ2lzby04ODU5LTInLAogICAgICAgICAgICAnaXNvLWlyLTEwMScsCiAgICAgICAgICAgICdpc284ODU5LTInLAogICAgICAgICAgICAnaXNvXzg4NTktMicsCiAgICAgICAgICAgICdsMicsCiAgICAgICAgICAgICdsYXRpbjInCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktMicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluMycsCiAgICAgICAgICAgICdpc28tODg1OS0zJywKICAgICAgICAgICAgJ2lzb184ODU5LTMnLAogICAgICAgICAgICAnaXNvLWlyLTEwOScsCiAgICAgICAgICAgICdsMycsCiAgICAgICAgICAgICdsYXRpbjMnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktMycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluNCcsCiAgICAgICAgICAgICdpc28tODg1OS00JywKICAgICAgICAgICAgJ2lzb184ODU5LTQnLAogICAgICAgICAgICAnaXNvLWlyLTExMCcsCiAgICAgICAgICAgICdsNCcsCiAgICAgICAgICAgICdsYXRpbjQnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktNCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluY3lyaWxsaWMnLAogICAgICAgICAgICAnY3lyaWxsaWMnLAogICAgICAgICAgICAnaXNvLTg4NTktNScsCiAgICAgICAgICAgICdpc29fODg1OS01JywKICAgICAgICAgICAgJ2lzby1pci0xNDQnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktNScKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdhcmFiaWMnLAogICAgICAgICAgICAnY3Npc29sYXRpbmFyYWJpYycsCiAgICAgICAgICAgICdlY21hLTExNCcsCiAgICAgICAgICAgICdpc28tODg1OS02JywKICAgICAgICAgICAgJ2lzb184ODU5LTYnLAogICAgICAgICAgICAnaXNvLWlyLTEyNycKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdpc28tODg1OS02JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2NzaXNvbGF0aW5ncmVlaycsCiAgICAgICAgICAgICdlY21hLTExOCcsCiAgICAgICAgICAgICdlbG90XzkyOCcsCiAgICAgICAgICAgICdncmVlaycsCiAgICAgICAgICAgICdncmVlazgnLAogICAgICAgICAgICAnaXNvLTg4NTktNycsCiAgICAgICAgICAgICdpc29fODg1OS03JywKICAgICAgICAgICAgJ2lzby1pci0xMjYnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnaXNvLTg4NTktNycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluaGVicmV3JywKICAgICAgICAgICAgJ2hlYnJldycsCiAgICAgICAgICAgICdpc28tODg1OS04JywKICAgICAgICAgICAgJ2lzby04ODU5LTgtaScsCiAgICAgICAgICAgICdpc28taXItMTM4JywKICAgICAgICAgICAgJ2lzb184ODU5LTgnLAogICAgICAgICAgICAndmlzdWFsJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby04ODU5LTgnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3Npc29sYXRpbjYnLAogICAgICAgICAgICAnaXNvLTg4NTktMTAnLAogICAgICAgICAgICAnaXNvLWlyLTE1NycsCiAgICAgICAgICAgICdpc284ODU5LTEwJywKICAgICAgICAgICAgJ2w2JywKICAgICAgICAgICAgJ2xhdGluNicKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdpc28tODg1OS0xMCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdpc28tODg1OS0xMycKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdpc28tODg1OS0xMycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdpc28tODg1OS0xNCcsCiAgICAgICAgICAgICdpc284ODU5LTE0JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby04ODU5LTE0JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2lzby04ODU5LTE1JywKICAgICAgICAgICAgJ2lzb184ODU5LTE1JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby04ODU5LTE1JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2lzby04ODU5LTE2JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby04ODU5LTE2JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2tvaTgtcicsCiAgICAgICAgICAgICdrb2k4X3InCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAna29pOC1yJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2tvaTgtdScKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdrb2k4LXUnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3NtYWNpbnRvc2gnLAogICAgICAgICAgICAnbWFjJywKICAgICAgICAgICAgJ21hY2ludG9zaCcsCiAgICAgICAgICAgICd4LW1hYy1yb21hbicKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdtYWNpbnRvc2gnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnaXNvLTg4NTktMTEnLAogICAgICAgICAgICAndGlzLTYyMCcsCiAgICAgICAgICAgICd3aW5kb3dzLTg3NCcKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTg3NCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICd3aW5kb3dzLTEyNTAnLAogICAgICAgICAgICAneC1jcDEyNTAnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnd2luZG93cy0xMjUwJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ3dpbmRvd3MtMTI1MScsCiAgICAgICAgICAgICd4LWNwMTI1MScKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTEyNTEnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnYXNjaWknLAogICAgICAgICAgICAnYW5zaV94My40LTE5NjgnLAogICAgICAgICAgICAnY3Npc29sYXRpbjEnLAogICAgICAgICAgICAnaXNvLTg4NTktMScsCiAgICAgICAgICAgICdpc284ODU5LTEnLAogICAgICAgICAgICAnaXNvXzg4NTktMScsCiAgICAgICAgICAgICdsMScsCiAgICAgICAgICAgICdsYXRpbjEnLAogICAgICAgICAgICAndXMtYXNjaWknLAogICAgICAgICAgICAnd2luZG93cy0xMjUyJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3dpbmRvd3MtMTI1MicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjcDEyNTMnLAogICAgICAgICAgICAnd2luZG93cy0xMjUzJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3dpbmRvd3MtMTI1MycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2lzb2xhdGluNScsCiAgICAgICAgICAgICdpc28tODg1OS05JywKICAgICAgICAgICAgJ2lzby1pci0xNDgnLAogICAgICAgICAgICAnbDUnLAogICAgICAgICAgICAnbGF0aW41JywKICAgICAgICAgICAgJ3dpbmRvd3MtMTI1NCcKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTEyNTQnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3AxMjU1JywKICAgICAgICAgICAgJ3dpbmRvd3MtMTI1NScKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTEyNTUnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3AxMjU2JywKICAgICAgICAgICAgJ3dpbmRvd3MtMTI1NicKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd3aW5kb3dzLTEyNTYnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnd2luZG93cy0xMjU3JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3dpbmRvd3MtMTI1NycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjcDEyNTgnLAogICAgICAgICAgICAnd2luZG93cy0xMjU4JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ3dpbmRvd3MtMTI1OCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICd4LW1hYy1jeXJpbGxpYycsCiAgICAgICAgICAgICd4LW1hYy11a3JhaW5pYW4nCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAneC1tYWMtY3lyaWxsaWMnCiAgICAgICAgfQogICAgICBdLAogICAgICAnaGVhZGluZyc6ICdMZWdhY3kgc2luZ2xlLWJ5dGUgZW5jb2RpbmdzJwogICAgfSwKICAgIHsKICAgICAgJ2VuY29kaW5ncyc6IFsKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY2hpbmVzZScsCiAgICAgICAgICAgICdjc2diMjMxMicsCiAgICAgICAgICAgICdjc2lzbzU4Z2IyMzEyODAnLAogICAgICAgICAgICAnZ2IyMzEyJywKICAgICAgICAgICAgJ2diaycsCiAgICAgICAgICAgICdnYl8yMzEyJywKICAgICAgICAgICAgJ2diXzIzMTItODAnLAogICAgICAgICAgICAnaXNvLWlyLTU4JywKICAgICAgICAgICAgJ3gtZ2JrJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2diaycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdnYjE4MDMwJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2diMTgwMzAnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnaHotZ2ItMjMxMicKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdoei1nYi0yMzEyJwogICAgICAgIH0KICAgICAgXSwKICAgICAgJ2hlYWRpbmcnOiAnTGVnYWN5IG11bHRpLWJ5dGUgQ2hpbmVzZSAoc2ltcGxpZmllZCkgZW5jb2RpbmdzJwogICAgfSwKICAgIHsKICAgICAgJ2VuY29kaW5ncyc6IFsKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnYmlnNScsCiAgICAgICAgICAgICdiaWc1LWhrc2NzJywKICAgICAgICAgICAgJ2NuLWJpZzUnLAogICAgICAgICAgICAnY3NiaWc1JywKICAgICAgICAgICAgJ3gteC1iaWc1JwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2JpZzUnCiAgICAgICAgfQogICAgICBdLAogICAgICAnaGVhZGluZyc6ICdMZWdhY3kgbXVsdGktYnl0ZSBDaGluZXNlICh0cmFkaXRpb25hbCkgZW5jb2RpbmdzJwogICAgfSwKICAgIHsKICAgICAgJ2VuY29kaW5ncyc6IFsKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAnY3NldWNwa2RmbXRqYXBhbmVzZScsCiAgICAgICAgICAgICdldWMtanAnLAogICAgICAgICAgICAneC1ldWMtanAnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnZXVjLWpwJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2NzaXNvMjAyMmpwJywKICAgICAgICAgICAgJ2lzby0yMDIyLWpwJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby0yMDIyLWpwJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2Nzc2hpZnRqaXMnLAogICAgICAgICAgICAnbXNfa2FuamknLAogICAgICAgICAgICAnc2hpZnQtamlzJywKICAgICAgICAgICAgJ3NoaWZ0X2ppcycsCiAgICAgICAgICAgICdzamlzJywKICAgICAgICAgICAgJ3dpbmRvd3MtMzFqJywKICAgICAgICAgICAgJ3gtc2ppcycKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICdzaGlmdF9qaXMnCiAgICAgICAgfQogICAgICBdLAogICAgICAnaGVhZGluZyc6ICdMZWdhY3kgbXVsdGktYnl0ZSBKYXBhbmVzZSBlbmNvZGluZ3MnCiAgICB9LAogICAgewogICAgICAnZW5jb2RpbmdzJzogWwogICAgICAgIHsKICAgICAgICAgICdsYWJlbHMnOiBbCiAgICAgICAgICAgICdjc2V1Y2tyJywKICAgICAgICAgICAgJ2Nza3NjNTYwMTE5ODcnLAogICAgICAgICAgICAnZXVjLWtyJywKICAgICAgICAgICAgJ2lzby1pci0xNDknLAogICAgICAgICAgICAna29yZWFuJywKICAgICAgICAgICAgJ2tzX2NfNTYwMS0xOTg3JywKICAgICAgICAgICAgJ2tzX2NfNTYwMS0xOTg5JywKICAgICAgICAgICAgJ2tzYzU2MDEnLAogICAgICAgICAgICAna3NjXzU2MDEnLAogICAgICAgICAgICAnd2luZG93cy05NDknCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAnZXVjLWtyJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ2NzaXNvMjAyMmtyJywKICAgICAgICAgICAgJ2lzby0yMDIyLWtyJwogICAgICAgICAgXSwKICAgICAgICAgICduYW1lJzogJ2lzby0yMDIyLWtyJwogICAgICAgIH0KICAgICAgXSwKICAgICAgJ2hlYWRpbmcnOiAnTGVnYWN5IG11bHRpLWJ5dGUgS29yZWFuIGVuY29kaW5ncycKICAgIH0sCiAgICB7CiAgICAgICdlbmNvZGluZ3MnOiBbCiAgICAgICAgewogICAgICAgICAgJ2xhYmVscyc6IFsKICAgICAgICAgICAgJ3V0Zi0xNicsCiAgICAgICAgICAgICd1dGYtMTZsZScKICAgICAgICAgIF0sCiAgICAgICAgICAnbmFtZSc6ICd1dGYtMTYnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnbGFiZWxzJzogWwogICAgICAgICAgICAndXRmLTE2YmUnCiAgICAgICAgICBdLAogICAgICAgICAgJ25hbWUnOiAndXRmLTE2YmUnCiAgICAgICAgfQogICAgICBdLAogICAgICAnaGVhZGluZyc6ICdMZWdhY3kgdXRmLTE2IGVuY29kaW5ncycKICAgIH0KICBdOwoKICB2YXIgbmFtZV90b19lbmNvZGluZyA9IHt9OwogIHZhciBsYWJlbF90b19lbmNvZGluZyA9IHt9OwogIGVuY29kaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7CiAgICBjYXRlZ29yeS5lbmNvZGluZ3MuZm9yRWFjaChmdW5jdGlvbihlbmNvZGluZykgewogICAgICBuYW1lX3RvX2VuY29kaW5nW2VuY29kaW5nLm5hbWVdID0gZW5jb2Rpbmc7CiAgICAgIGVuY29kaW5nLmxhYmVscy5mb3JFYWNoKGZ1bmN0aW9uKGxhYmVsKSB7CiAgICAgICAgbGFiZWxfdG9fZW5jb2RpbmdbbGFiZWxdID0gZW5jb2Rpbmc7CiAgICAgIH0pOwogICAgfSk7CiAgfSk7CgogIC8vCiAgLy8gNS4gSW5kZXhlcwogIC8vCgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBwb2ludGVyIFRoZSB8cG9pbnRlcnwgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge0FycmF5Ljw/bnVtYmVyPn0gaW5kZXggVGhlIHxpbmRleHwgdG8gc2VhcmNoIHdpdGhpbi4KICAgKiBAcmV0dXJuIHs/bnVtYmVyfSBUaGUgY29kZSBwb2ludCBjb3JyZXNwb25kaW5nIHRvIHxwb2ludGVyfCBpbiB8aW5kZXh8LAogICAqICAgICBvciBudWxsIGlmIHxjb2RlIHBvaW50fCBpcyBub3QgaW4gfGluZGV4fC4KICAgKi8KICBmdW5jdGlvbiBpbmRleENvZGVQb2ludEZvcihwb2ludGVyLCBpbmRleCkgewogICAgcmV0dXJuIChpbmRleCB8fCBbXSlbcG9pbnRlcl0gfHwgbnVsbDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb2RlX3BvaW50IFRoZSB8Y29kZSBwb2ludHwgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge0FycmF5Ljw/bnVtYmVyPn0gaW5kZXggVGhlIHxpbmRleHwgdG8gc2VhcmNoIHdpdGhpbi4KICAgKiBAcmV0dXJuIHs/bnVtYmVyfSBUaGUgZmlyc3QgcG9pbnRlciBjb3JyZXNwb25kaW5nIHRvIHxjb2RlIHBvaW50fCBpbgogICAqICAgICB8aW5kZXh8LCBvciBudWxsIGlmIHxjb2RlIHBvaW50fCBpcyBub3QgaW4gfGluZGV4fC4KICAgKi8KICBmdW5jdGlvbiBpbmRleFBvaW50ZXJGb3IoY29kZV9wb2ludCwgaW5kZXgpIHsKICAgIHZhciBwb2ludGVyID0gaW5kZXguaW5kZXhPZihjb2RlX3BvaW50KTsKICAgIHJldHVybiBwb2ludGVyID09PSAtMSA/IG51bGwgOiBwb2ludGVyOwogIH0KCiAgLyoqIEB0eXBlIHtPYmplY3QuPHN0cmluZywgKEFycmF5LjxudW1iZXI+fEFycmF5LjxBcnJheS48bnVtYmVyPj4pPn0gKi8KICB2YXIgaW5kZXhlcyA9IGdsb2JhbFsnZW5jb2RpbmctaW5kZXhlcyddIHx8IHt9OwoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gcG9pbnRlciBUaGUgfHBvaW50ZXJ8IHRvIHNlYXJjaCBmb3IgaW4gdGhlIGdiMTgwMzAgaW5kZXguCiAgICogQHJldHVybiB7P251bWJlcn0gVGhlIGNvZGUgcG9pbnQgY29ycmVzcG9uZGluZyB0byB8cG9pbnRlcnwgaW4gfGluZGV4fCwKICAgKiAgICAgb3IgbnVsbCBpZiB8Y29kZSBwb2ludHwgaXMgbm90IGluIHRoZSBnYjE4MDMwIGluZGV4LgogICAqLwogIGZ1bmN0aW9uIGluZGV4R0IxODAzMENvZGVQb2ludEZvcihwb2ludGVyKSB7CiAgICBpZiAoKHBvaW50ZXIgPiAzOTQxOSAmJiBwb2ludGVyIDwgMTg5MDAwKSB8fCAocG9pbnRlciA+IDEyMzc1NzUpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBvZmZzZXQgPSAwLAogICAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBjb2RlX3BvaW50X29mZnNldCA9IDAsCiAgICAgICAgLyoqIEB0eXBlIHtBcnJheS48QXJyYXkuPG51bWJlcj4+fSAqLyBpbmRleCA9IGluZGV4ZXNbJ2diMTgwMzAnXTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGluZGV4Lmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBlbnRyeSA9IGluZGV4W2ldOwogICAgICBpZiAoZW50cnlbMF0gPD0gcG9pbnRlcikgewogICAgICAgIG9mZnNldCA9IGVudHJ5WzBdOwogICAgICAgIGNvZGVfcG9pbnRfb2Zmc2V0ID0gZW50cnlbMV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb2RlX3BvaW50X29mZnNldCArIHBvaW50ZXIgLSBvZmZzZXQ7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gY29kZV9wb2ludCBUaGUgfGNvZGUgcG9pbnR8IHRvIGxvY2F0ZSBpbiB0aGUgZ2IxODAzMCBpbmRleC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBmaXJzdCBwb2ludGVyIGNvcnJlc3BvbmRpbmcgdG8gfGNvZGUgcG9pbnR8IGluIHRoZQogICAqICAgICBnYjE4MDMwIGluZGV4LgogICAqLwogIGZ1bmN0aW9uIGluZGV4R0IxODAzMFBvaW50ZXJGb3IoY29kZV9wb2ludCkgewogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBvZmZzZXQgPSAwLAogICAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBwb2ludGVyX29mZnNldCA9IDAsCiAgICAgICAgLyoqIEB0eXBlIHtBcnJheS48QXJyYXkuPG51bWJlcj4+fSAqLyBpbmRleCA9IGluZGV4ZXNbJ2diMTgwMzAnXTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGluZGV4Lmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBlbnRyeSA9IGluZGV4W2ldOwogICAgICBpZiAoZW50cnlbMV0gPD0gY29kZV9wb2ludCkgewogICAgICAgIG9mZnNldCA9IGVudHJ5WzFdOwogICAgICAgIHBvaW50ZXJfb2Zmc2V0ID0gZW50cnlbMF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwb2ludGVyX29mZnNldCArIGNvZGVfcG9pbnQgLSBvZmZzZXQ7CiAgfQoKICAvLwogIC8vIDcuIFRoZSBlbmNvZGluZwogIC8vCgogIC8vIDcuMSB1dGYtOAoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBVVEY4RGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyB1dGY4X2NvZGVfcG9pbnQgPSAwLAogICAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyB1dGY4X2J5dGVzX25lZWRlZCA9IDAsCiAgICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIHV0ZjhfYnl0ZXNfc2VlbiA9IDAsCiAgICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAwOwoKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICBpZiAodXRmOF9ieXRlc19uZWVkZWQgIT09IDApIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgxKTsKCiAgICAgIGlmICh1dGY4X2J5dGVzX25lZWRlZCA9PT0gMCkgewogICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgICByZXR1cm4gYml0ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHhDMiwgMHhERikpIHsKICAgICAgICAgIHV0ZjhfYnl0ZXNfbmVlZGVkID0gMTsKICAgICAgICAgIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAweDgwOwogICAgICAgICAgdXRmOF9jb2RlX3BvaW50ID0gYml0ZSAtIDB4QzA7CiAgICAgICAgfSBlbHNlIGlmIChpblJhbmdlKGJpdGUsIDB4RTAsIDB4RUYpKSB7CiAgICAgICAgICB1dGY4X2J5dGVzX25lZWRlZCA9IDI7CiAgICAgICAgICB1dGY4X2xvd2VyX2JvdW5kYXJ5ID0gMHg4MDA7CiAgICAgICAgICB1dGY4X2NvZGVfcG9pbnQgPSBiaXRlIC0gMHhFMDsKICAgICAgICB9IGVsc2UgaWYgKGluUmFuZ2UoYml0ZSwgMHhGMCwgMHhGNCkpIHsKICAgICAgICAgIHV0ZjhfYnl0ZXNfbmVlZGVkID0gMzsKICAgICAgICAgIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAweDEwMDAwOwogICAgICAgICAgdXRmOF9jb2RlX3BvaW50ID0gYml0ZSAtIDB4RjA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIH0KICAgICAgICB1dGY4X2NvZGVfcG9pbnQgPSB1dGY4X2NvZGVfcG9pbnQgKiBNYXRoLnBvdyg2NCwgdXRmOF9ieXRlc19uZWVkZWQpOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmICghaW5SYW5nZShiaXRlLCAweDgwLCAweEJGKSkgewogICAgICAgIHV0ZjhfY29kZV9wb2ludCA9IDA7CiAgICAgICAgdXRmOF9ieXRlc19uZWVkZWQgPSAwOwogICAgICAgIHV0ZjhfYnl0ZXNfc2VlbiA9IDA7CiAgICAgICAgdXRmOF9sb3dlcl9ib3VuZGFyeSA9IDA7CiAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgICAgdXRmOF9ieXRlc19zZWVuICs9IDE7CiAgICAgIHV0ZjhfY29kZV9wb2ludCA9IHV0ZjhfY29kZV9wb2ludCArIChiaXRlIC0gMHg4MCkgKgogICAgICAgICAgTWF0aC5wb3coNjQsIHV0ZjhfYnl0ZXNfbmVlZGVkIC0gdXRmOF9ieXRlc19zZWVuKTsKICAgICAgaWYgKHV0ZjhfYnl0ZXNfc2VlbiAhPT0gdXRmOF9ieXRlc19uZWVkZWQpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICB2YXIgY29kZV9wb2ludCA9IHV0ZjhfY29kZV9wb2ludDsKICAgICAgdmFyIGxvd2VyX2JvdW5kYXJ5ID0gdXRmOF9sb3dlcl9ib3VuZGFyeTsKICAgICAgdXRmOF9jb2RlX3BvaW50ID0gMDsKICAgICAgdXRmOF9ieXRlc19uZWVkZWQgPSAwOwogICAgICB1dGY4X2J5dGVzX3NlZW4gPSAwOwogICAgICB1dGY4X2xvd2VyX2JvdW5kYXJ5ID0gMDsKICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgbG93ZXJfYm91bmRhcnksIDB4MTBGRkZGKSAmJgogICAgICAgICAgIWluUmFuZ2UoY29kZV9wb2ludCwgMHhEODAwLCAweERGRkYpKSB7CiAgICAgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gVVRGOEVuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhEODAwLCAweERGRkYpKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3ZikpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgdmFyIGNvdW50LCBvZmZzZXQ7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDA4MCwgMHgwN0ZGKSkgewogICAgICAgIGNvdW50ID0gMTsKICAgICAgICBvZmZzZXQgPSAweEMwOwogICAgICB9IGVsc2UgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHgwODAwLCAweEZGRkYpKSB7CiAgICAgICAgY291bnQgPSAyOwogICAgICAgIG9mZnNldCA9IDB4RTA7CiAgICAgIH0gZWxzZSBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDEwMDAwLCAweDEwRkZGRikpIHsKICAgICAgICBjb3VudCA9IDM7CiAgICAgICAgb2Zmc2V0ID0gMHhGMDsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoCiAgICAgICAgICBkaXYoY29kZV9wb2ludCwgTWF0aC5wb3coNjQsIGNvdW50KSkgKyBvZmZzZXQpOwogICAgICB3aGlsZSAoY291bnQgPiAwKSB7CiAgICAgICAgdmFyIHRlbXAgPSBkaXYoY29kZV9wb2ludCwgTWF0aC5wb3coNjQsIGNvdW50IC0gMSkpOwogICAgICAgIHJlc3VsdCA9IG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4ODAgKyAodGVtcCAlIDY0KSk7CiAgICAgICAgY291bnQgLT0gMTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ3V0Zi04J10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgVVRGOEVuY29kZXIob3B0aW9ucyk7CiAgfTsKICBuYW1lX3RvX2VuY29kaW5nWyd1dGYtOCddLmdldERlY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFVURjhEZWNvZGVyKG9wdGlvbnMpOwogIH07CgogIC8vCiAgLy8gOC4gTGVnYWN5IHNpbmdsZS1ieXRlIGVuY29kaW5ncwogIC8vCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7QXJyYXkuPG51bWJlcj59IGluZGV4IFRoZSBlbmNvZGluZyBpbmRleC4KICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBTaW5nbGVCeXRlRGVjb2RlcihpbmRleCwgb3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgwMCwgMHg3RikpIHsKICAgICAgICByZXR1cm4gYml0ZTsKICAgICAgfQogICAgICB2YXIgY29kZV9wb2ludCA9IGluZGV4W2JpdGUgLSAweDgwXTsKICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICByZXR1cm4gY29kZV9wb2ludDsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge0FycmF5Ljw/bnVtYmVyPn0gaW5kZXggVGhlIGVuY29kaW5nIGluZGV4LgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIFNpbmdsZUJ5dGVFbmNvZGVyKGluZGV4LCBvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgLyoqCiAgICAgKiBAcGFyYW0ge0J5dGVPdXRwdXRTdHJlYW19IG91dHB1dF9ieXRlX3N0cmVhbSBPdXRwdXQgYnl0ZSBzdHJlYW0uCiAgICAgKiBAcGFyYW0ge0NvZGVQb2ludElucHV0U3RyZWFtfSBjb2RlX3BvaW50X3BvaW50ZXIgSW5wdXQgc3RyZWFtLgogICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFzdCBieXRlIGVtaXR0ZWQuCiAgICAgKi8KICAgIHRoaXMuZW5jb2RlID0gZnVuY3Rpb24ob3V0cHV0X2J5dGVfc3RyZWFtLCBjb2RlX3BvaW50X3BvaW50ZXIpIHsKICAgICAgdmFyIGNvZGVfcG9pbnQgPSBjb2RlX3BvaW50X3BvaW50ZXIuZ2V0KCk7CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSBFT0ZfY29kZV9wb2ludCkgewogICAgICAgIHJldHVybiBFT0ZfYnl0ZTsKICAgICAgfQogICAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3RikpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgdmFyIHBvaW50ZXIgPSBpbmRleFBvaW50ZXJGb3IoY29kZV9wb2ludCwgaW5kZXgpOwogICAgICBpZiAocG9pbnRlciA9PT0gbnVsbCkgewogICAgICAgIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQocG9pbnRlciArIDB4ODApOwogICAgfTsKICB9CgogIChmdW5jdGlvbigpIHsKICAgIFsnaWJtODY0JywgJ2libTg2NicsICdpc28tODg1OS0yJywgJ2lzby04ODU5LTMnLCAnaXNvLTg4NTktNCcsCiAgICAgJ2lzby04ODU5LTUnLCAnaXNvLTg4NTktNicsICdpc28tODg1OS03JywgJ2lzby04ODU5LTgnLCAnaXNvLTg4NTktMTAnLAogICAgICdpc28tODg1OS0xMycsICdpc28tODg1OS0xNCcsICdpc28tODg1OS0xNScsICdpc28tODg1OS0xNicsICdrb2k4LXInLAogICAgICdrb2k4LXUnLCAnbWFjaW50b3NoJywgJ3dpbmRvd3MtODc0JywgJ3dpbmRvd3MtMTI1MCcsICd3aW5kb3dzLTEyNTEnLAogICAgICd3aW5kb3dzLTEyNTInLCAnd2luZG93cy0xMjUzJywgJ3dpbmRvd3MtMTI1NCcsICd3aW5kb3dzLTEyNTUnLAogICAgICd3aW5kb3dzLTEyNTYnLCAnd2luZG93cy0xMjU3JywgJ3dpbmRvd3MtMTI1OCcsICd4LW1hYy1jeXJpbGxpYycKICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciBlbmNvZGluZyA9IG5hbWVfdG9fZW5jb2RpbmdbbmFtZV07CiAgICAgIHZhciBpbmRleCA9IGluZGV4ZXNbbmFtZV07CiAgICAgIGVuY29kaW5nLmdldERlY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaW5nbGVCeXRlRGVjb2RlcihpbmRleCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIGVuY29kaW5nLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaW5nbGVCeXRlRW5jb2RlcihpbmRleCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICB9KTsKICB9KCkpOwoKICAvLwogIC8vIDkuIExlZ2FjeSBtdWx0aS1ieXRlIENoaW5lc2UgKHNpbXBsaWZpZWQpIGVuY29kaW5ncwogIC8vCgogIC8vIDkuMSBnYmsKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtib29sZWFufSBnYjE4MDMwIFRydWUgaWYgZGVjb2RpbmcgZ2IxODAzMCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIEdCS0RlY29kZXIoZ2IxODAzMCwgb3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIHZhciAvKiogQHR5cGUge251bWJlcn0gKi8gZ2JrX2ZpcnN0ID0gMHgwMCwKICAgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gZ2JrX3NlY29uZCA9IDB4MDAsCiAgICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIGdia190aGlyZCA9IDB4MDA7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RyZWFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICB2YXIgYml0ZSA9IGJ5dGVfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIGdia19maXJzdCA9PT0gMHgwMCAmJgogICAgICAgICAgZ2JrX3NlY29uZCA9PT0gMHgwMCAmJiBnYmtfdGhpcmQgPT09IDB4MDApIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmCiAgICAgICAgICAoZ2JrX2ZpcnN0ICE9PSAweDAwIHx8IGdia19zZWNvbmQgIT09IDB4MDAgfHwgZ2JrX3RoaXJkICE9PSAweDAwKSkgewogICAgICAgIGdia19maXJzdCA9IDB4MDA7CiAgICAgICAgZ2JrX3NlY29uZCA9IDB4MDA7CiAgICAgICAgZ2JrX3RoaXJkID0gMHgwMDsKICAgICAgICBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICB9CiAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIHZhciBjb2RlX3BvaW50OwogICAgICBpZiAoZ2JrX3RoaXJkICE9PSAweDAwKSB7CiAgICAgICAgY29kZV9wb2ludCA9IG51bGw7CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgzMCwgMHgzOSkpIHsKICAgICAgICAgIGNvZGVfcG9pbnQgPSBpbmRleEdCMTgwMzBDb2RlUG9pbnRGb3IoCiAgICAgICAgICAgICAgKCgoZ2JrX2ZpcnN0IC0gMHg4MSkgKiAxMCArIChnYmtfc2Vjb25kIC0gMHgzMCkpICogMTI2ICsKICAgICAgICAgICAgICAgKGdia190aGlyZCAtIDB4ODEpKSAqIDEwICsgYml0ZSAtIDB4MzApOwogICAgICAgIH0KICAgICAgICBnYmtfZmlyc3QgPSAweDAwOwogICAgICAgIGdia19zZWNvbmQgPSAweDAwOwogICAgICAgIGdia190aGlyZCA9IDB4MDA7CiAgICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTMpOwogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICB9CiAgICAgIGlmIChnYmtfc2Vjb25kICE9PSAweDAwKSB7CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHg4MSwgMHhGRSkpIHsKICAgICAgICAgIGdia190aGlyZCA9IGJpdGU7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMik7CiAgICAgICAgZ2JrX2ZpcnN0ID0gMHgwMDsKICAgICAgICBnYmtfc2Vjb25kID0gMHgwMDsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBpZiAoZ2JrX2ZpcnN0ICE9PSAweDAwKSB7CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgzMCwgMHgzOSkgJiYgZ2IxODAzMCkgewogICAgICAgICAgZ2JrX3NlY29uZCA9IGJpdGU7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGxlYWQgPSBnYmtfZmlyc3Q7CiAgICAgICAgdmFyIHBvaW50ZXIgPSBudWxsOwogICAgICAgIGdia19maXJzdCA9IDB4MDA7CiAgICAgICAgdmFyIG9mZnNldCA9IGJpdGUgPCAweDdGID8gMHg0MCA6IDB4NDE7CiAgICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHg0MCwgMHg3RSkgfHwgaW5SYW5nZShiaXRlLCAweDgwLCAweEZFKSkgewogICAgICAgICAgcG9pbnRlciA9IChsZWFkIC0gMHg4MSkgKiAxOTAgKyAoYml0ZSAtIG9mZnNldCk7CiAgICAgICAgfQogICAgICAgIGNvZGVfcG9pbnQgPSBwb2ludGVyID09PSBudWxsID8gbnVsbCA6CiAgICAgICAgICAgIGluZGV4Q29kZVBvaW50Rm9yKHBvaW50ZXIsIGluZGV4ZXNbJ2diayddKTsKICAgICAgICBpZiAocG9pbnRlciA9PT0gbnVsbCkgewogICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgfQogICAgICAgIGlmIChjb2RlX3BvaW50ID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgwMCwgMHg3RikpIHsKICAgICAgICByZXR1cm4gYml0ZTsKICAgICAgfQogICAgICBpZiAoYml0ZSA9PT0gMHg4MCkgewogICAgICAgIHJldHVybiAweDIwQUM7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHg4MSwgMHhGRSkpIHsKICAgICAgICBnYmtfZmlyc3QgPSBiaXRlOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgfTsKICB9CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gZ2IxODAzMCBUcnVlIGlmIGRlY29kaW5nIGdiMTgwMzAsIGZhbHNlIG90aGVyd2lzZS4KICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBHQktFbmNvZGVyKGdiMTgwMzAsIG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZU91dHB1dFN0cmVhbX0gb3V0cHV0X2J5dGVfc3RyZWFtIE91dHB1dCBieXRlIHN0cmVhbS4KICAgICAqIEBwYXJhbSB7Q29kZVBvaW50SW5wdXRTdHJlYW19IGNvZGVfcG9pbnRfcG9pbnRlciBJbnB1dCBzdHJlYW0uCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsYXN0IGJ5dGUgZW1pdHRlZC4KICAgICAqLwogICAgdGhpcy5lbmNvZGUgPSBmdW5jdGlvbihvdXRwdXRfYnl0ZV9zdHJlYW0sIGNvZGVfcG9pbnRfcG9pbnRlcikgewogICAgICB2YXIgY29kZV9wb2ludCA9IGNvZGVfcG9pbnRfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IEVPRl9jb2RlX3BvaW50KSB7CiAgICAgICAgcmV0dXJuIEVPRl9ieXRlOwogICAgICB9CiAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgcG9pbnRlciA9IGluZGV4UG9pbnRlckZvcihjb2RlX3BvaW50LCBpbmRleGVzWydnYmsnXSk7CiAgICAgIGlmIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgdmFyIGxlYWQgPSBkaXYocG9pbnRlciwgMTkwKSArIDB4ODE7CiAgICAgICAgdmFyIHRyYWlsID0gcG9pbnRlciAlIDE5MDsKICAgICAgICB2YXIgb2Zmc2V0ID0gdHJhaWwgPCAweDNGID8gMHg0MCA6IDB4NDE7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KGxlYWQsIHRyYWlsICsgb2Zmc2V0KTsKICAgICAgfQogICAgICBpZiAocG9pbnRlciA9PT0gbnVsbCAmJiAhZ2IxODAzMCkgewogICAgICAgIHJldHVybiBlbmNvZGVyRXJyb3IoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgcG9pbnRlciA9IGluZGV4R0IxODAzMFBvaW50ZXJGb3IoY29kZV9wb2ludCk7CiAgICAgIHZhciBieXRlMSA9IGRpdihkaXYoZGl2KHBvaW50ZXIsIDEwKSwgMTI2KSwgMTApOwogICAgICBwb2ludGVyID0gcG9pbnRlciAtIGJ5dGUxICogMTAgKiAxMjYgKiAxMDsKICAgICAgdmFyIGJ5dGUyID0gZGl2KGRpdihwb2ludGVyLCAxMCksIDEyNik7CiAgICAgIHBvaW50ZXIgPSBwb2ludGVyIC0gYnl0ZTIgKiAxMCAqIDEyNjsKICAgICAgdmFyIGJ5dGUzID0gZGl2KHBvaW50ZXIsIDEwKTsKICAgICAgdmFyIGJ5dGU0ID0gcG9pbnRlciAtIGJ5dGUzICogMTA7CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChieXRlMSArIDB4ODEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlMiArIDB4MzAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlMyArIDB4ODEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlNCArIDB4MzApOwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ2diayddLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IEdCS0VuY29kZXIoZmFsc2UsIG9wdGlvbnMpOwogIH07CiAgbmFtZV90b19lbmNvZGluZ1snZ2JrJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgR0JLRGVjb2RlcihmYWxzZSwgb3B0aW9ucyk7CiAgfTsKCiAgLy8gOS4yIGdiMTgwMzAKICBuYW1lX3RvX2VuY29kaW5nWydnYjE4MDMwJ10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgR0JLRW5jb2Rlcih0cnVlLCBvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ2diMTgwMzAnXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBHQktEZWNvZGVyKHRydWUsIG9wdGlvbnMpOwogIH07CgogIC8vIDkuMyBoei1nYi0yMzEyCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIEhaR0IyMzEyRGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgdmFyIC8qKiBAdHlwZSB7Ym9vbGVhbn0gKi8gaHpnYjIzMTIgPSBmYWxzZSwKICAgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gaHpnYjIzMTJfbGVhZCA9IDB4MDA7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RyZWFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICB2YXIgYml0ZSA9IGJ5dGVfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIGh6Z2IyMzEyX2xlYWQgPT09IDB4MDApIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIGh6Z2IyMzEyX2xlYWQgIT09IDB4MDApIHsKICAgICAgICBoemdiMjMxMl9sZWFkID0gMHgwMDsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoaHpnYjIzMTJfbGVhZCA9PT0gMHg3RSkgewogICAgICAgIGh6Z2IyMzEyX2xlYWQgPSAweDAwOwogICAgICAgIGlmIChiaXRlID09PSAweDdCKSB7CiAgICAgICAgICBoemdiMjMxMiA9IHRydWU7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKGJpdGUgPT09IDB4N0QpIHsKICAgICAgICAgIGh6Z2IyMzEyID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKGJpdGUgPT09IDB4N0UpIHsKICAgICAgICAgIHJldHVybiAweDAwN0U7CiAgICAgICAgfQogICAgICAgIGlmIChiaXRlID09PSAweDBBKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgICAgaWYgKGh6Z2IyMzEyX2xlYWQgIT09IDB4MDApIHsKICAgICAgICB2YXIgbGVhZCA9IGh6Z2IyMzEyX2xlYWQ7CiAgICAgICAgaHpnYjIzMTJfbGVhZCA9IDB4MDA7CiAgICAgICAgdmFyIGNvZGVfcG9pbnQgPSBudWxsOwogICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MjEsIDB4N0UpKSB7CiAgICAgICAgICBjb2RlX3BvaW50ID0gaW5kZXhDb2RlUG9pbnRGb3IoKGxlYWQgLSAxKSAqIDE5MCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGJpdGUgKyAweDNGKSwgaW5kZXhlc1snZ2JrJ10pOwogICAgICAgIH0KICAgICAgICBpZiAoYml0ZSA9PT0gMHgwQSkgewogICAgICAgICAgaHpnYjIzMTIgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29kZV9wb2ludDsKICAgICAgfQogICAgICBpZiAoYml0ZSA9PT0gMHg3RSkgewogICAgICAgIGh6Z2IyMzEyX2xlYWQgPSAweDdFOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmIChoemdiMjMxMikgewogICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MjAsIDB4N0YpKSB7CiAgICAgICAgICBoemdiMjMxMl9sZWFkID0gYml0ZTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAoYml0ZSA9PT0gMHgwQSkgewogICAgICAgICAgaHpnYjIzMTIgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgwMCwgMHg3RikpIHsKICAgICAgICByZXR1cm4gYml0ZTsKICAgICAgfQogICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBIWkdCMjMxMkVuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIHZhciBoemdiMjMxMiA9IGZhbHNlOwogICAgLyoqCiAgICAgKiBAcGFyYW0ge0J5dGVPdXRwdXRTdHJlYW19IG91dHB1dF9ieXRlX3N0cmVhbSBPdXRwdXQgYnl0ZSBzdHJlYW0uCiAgICAgKiBAcGFyYW0ge0NvZGVQb2ludElucHV0U3RyZWFtfSBjb2RlX3BvaW50X3BvaW50ZXIgSW5wdXQgc3RyZWFtLgogICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFzdCBieXRlIGVtaXR0ZWQuCiAgICAgKi8KICAgIHRoaXMuZW5jb2RlID0gZnVuY3Rpb24ob3V0cHV0X2J5dGVfc3RyZWFtLCBjb2RlX3BvaW50X3BvaW50ZXIpIHsKICAgICAgdmFyIGNvZGVfcG9pbnQgPSBjb2RlX3BvaW50X3BvaW50ZXIuZ2V0KCk7CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSBFT0ZfY29kZV9wb2ludCkgewogICAgICAgIHJldHVybiBFT0ZfYnl0ZTsKICAgICAgfQogICAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3RikgJiYgaHpnYjIzMTIpIHsKICAgICAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KC0xKTsKICAgICAgICBoemdiMjMxMiA9IGZhbHNlOwogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDdFLCAweDdEKTsKICAgICAgfQogICAgICBpZiAoY29kZV9wb2ludCA9PT0gMHgwMDdFKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4N0UsIDB4N0UpOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICBpZiAoIWh6Z2IyMzEyKSB7CiAgICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgaHpnYjIzMTIgPSB0cnVlOwogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDdFLCAweDdCKTsKICAgICAgfQogICAgICB2YXIgcG9pbnRlciA9IGluZGV4UG9pbnRlckZvcihjb2RlX3BvaW50LCBpbmRleGVzWydnYmsnXSk7CiAgICAgIGlmIChwb2ludGVyID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgbGVhZCA9IGRpdihwb2ludGVyLCAxOTApICsgMTsKICAgICAgdmFyIHRyYWlsID0gcG9pbnRlciAlIDE5MCAtIDB4M0Y7CiAgICAgIGlmICghaW5SYW5nZShsZWFkLCAweDIxLCAweDdFKSB8fCAhaW5SYW5nZSh0cmFpbCwgMHgyMSwgMHg3RSkpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkLCB0cmFpbCk7CiAgICB9OwogIH0KCiAgbmFtZV90b19lbmNvZGluZ1snaHotZ2ItMjMxMiddLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IEhaR0IyMzEyRW5jb2RlcihvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ2h6LWdiLTIzMTInXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBIWkdCMjMxMkRlY29kZXIob3B0aW9ucyk7CiAgfTsKCiAgLy8KICAvLyAxMC4gTGVnYWN5IG11bHRpLWJ5dGUgQ2hpbmVzZSAodHJhZGl0aW9uYWwpIGVuY29kaW5ncwogIC8vCgogIC8vIDEwLjEgYmlnNQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBCaWc1RGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBiaWc1X2xlYWQgPSAweDAwLAogICAgICAgIC8qKiBAdHlwZSB7P251bWJlcn0gKi8gYmlnNV9wZW5kaW5nID0gbnVsbDsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RlcmFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICAvLyBOT1RFOiBIYWNrIHRvIHN1cHBvcnQgZW1pdHRpbmcgdHdvIGNvZGUgcG9pbnRzCiAgICAgIGlmIChiaWc1X3BlbmRpbmcgIT09IG51bGwpIHsKICAgICAgICB2YXIgcGVuZGluZyA9IGJpZzVfcGVuZGluZzsKICAgICAgICBiaWc1X3BlbmRpbmcgPSBudWxsOwogICAgICAgIHJldHVybiBwZW5kaW5nOwogICAgICB9CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUgJiYgYmlnNV9sZWFkID09PSAweDAwKSB7CiAgICAgICAgcmV0dXJuIEVPRl9jb2RlX3BvaW50OwogICAgICB9CiAgICAgIGlmIChiaXRlID09PSBFT0ZfYnl0ZSAmJiBiaWc1X2xlYWQgIT09IDB4MDApIHsKICAgICAgICBiaWc1X2xlYWQgPSAweDAwOwogICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICB9CiAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChiaWc1X2xlYWQgIT09IDB4MDApIHsKICAgICAgICB2YXIgbGVhZCA9IGJpZzVfbGVhZDsKICAgICAgICB2YXIgcG9pbnRlciA9IG51bGw7CiAgICAgICAgYmlnNV9sZWFkID0gMHgwMDsKICAgICAgICB2YXIgb2Zmc2V0ID0gYml0ZSA8IDB4N0YgPyAweDQwIDogMHg2MjsKICAgICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDQwLCAweDdFKSB8fCBpblJhbmdlKGJpdGUsIDB4QTEsIDB4RkUpKSB7CiAgICAgICAgICBwb2ludGVyID0gKGxlYWQgLSAweDgxKSAqIDE1NyArIChiaXRlIC0gb2Zmc2V0KTsKICAgICAgICB9CiAgICAgICAgaWYgKHBvaW50ZXIgPT09IDExMzMpIHsKICAgICAgICAgIGJpZzVfcGVuZGluZyA9IDB4MDMwNDsKICAgICAgICAgIHJldHVybiAweDAwQ0E7CiAgICAgICAgfQogICAgICAgIGlmIChwb2ludGVyID09PSAxMTM1KSB7CiAgICAgICAgICBiaWc1X3BlbmRpbmcgPSAweDAzMEM7CiAgICAgICAgICByZXR1cm4gMHgwMENBOwogICAgICAgIH0KICAgICAgICBpZiAocG9pbnRlciA9PT0gMTE2NCkgewogICAgICAgICAgYmlnNV9wZW5kaW5nID0gMHgwMzA0OwogICAgICAgICAgcmV0dXJuIDB4MDBFQTsKICAgICAgICB9CiAgICAgICAgaWYgKHBvaW50ZXIgPT09IDExNjYpIHsKICAgICAgICAgIGJpZzVfcGVuZGluZyA9IDB4MDMwQzsKICAgICAgICAgIHJldHVybiAweDAwRUE7CiAgICAgICAgfQogICAgICAgIHZhciBjb2RlX3BvaW50ID0gKHBvaW50ZXIgPT09IG51bGwpID8gbnVsbCA6CiAgICAgICAgICAgIGluZGV4Q29kZVBvaW50Rm9yKHBvaW50ZXIsIGluZGV4ZXNbJ2JpZzUnXSk7CiAgICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIH0KICAgICAgICBpZiAoY29kZV9wb2ludCA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgcmV0dXJuIGJpdGU7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHg4MSwgMHhGRSkpIHsKICAgICAgICBiaWc1X2xlYWQgPSBiaXRlOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgfTsKICB9CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIEJpZzVFbmNvZGVyKG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZU91dHB1dFN0cmVhbX0gb3V0cHV0X2J5dGVfc3RyZWFtIE91dHB1dCBieXRlIHN0cmVhbS4KICAgICAqIEBwYXJhbSB7Q29kZVBvaW50SW5wdXRTdHJlYW19IGNvZGVfcG9pbnRfcG9pbnRlciBJbnB1dCBzdHJlYW0uCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsYXN0IGJ5dGUgZW1pdHRlZC4KICAgICAqLwogICAgdGhpcy5lbmNvZGUgPSBmdW5jdGlvbihvdXRwdXRfYnl0ZV9zdHJlYW0sIGNvZGVfcG9pbnRfcG9pbnRlcikgewogICAgICB2YXIgY29kZV9wb2ludCA9IGNvZGVfcG9pbnRfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IEVPRl9jb2RlX3BvaW50KSB7CiAgICAgICAgcmV0dXJuIEVPRl9ieXRlOwogICAgICB9CiAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgcG9pbnRlciA9IGluZGV4UG9pbnRlckZvcihjb2RlX3BvaW50LCBpbmRleGVzWydiaWc1J10pOwogICAgICBpZiAocG9pbnRlciA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBlbmNvZGVyRXJyb3IoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgdmFyIGxlYWQgPSBkaXYocG9pbnRlciwgMTU3KSArIDB4ODE7CiAgICAgIC8vaWYgKGxlYWQgPCAweEExKSB7CiAgICAgIC8vICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICAvL30KICAgICAgdmFyIHRyYWlsID0gcG9pbnRlciAlIDE1NzsKICAgICAgdmFyIG9mZnNldCA9IHRyYWlsIDwgMHgzRiA/IDB4NDAgOiAweDYyOwogICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQobGVhZCwgdHJhaWwgKyBvZmZzZXQpOwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ2JpZzUnXS5nZXRFbmNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBCaWc1RW5jb2RlcihvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ2JpZzUnXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBCaWc1RGVjb2RlcihvcHRpb25zKTsKICB9OwoKCiAgLy8KICAvLyAxMS4gTGVnYWN5IG11bHRpLWJ5dGUgSmFwYW5lc2UgZW5jb2RpbmdzCiAgLy8KCiAgLy8gMTEuMSBldWMuanAKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gRVVDSlBEZWNvZGVyKG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICB2YXIgLyoqIEB0eXBlIHtudW1iZXJ9ICovIGV1Y2pwX2ZpcnN0ID0gMHgwMCwKICAgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gZXVjanBfc2Vjb25kID0gMHgwMDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICBpZiAoZXVjanBfZmlyc3QgPT09IDB4MDAgJiYgZXVjanBfc2Vjb25kID09PSAweDAwKSB7CiAgICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgICAgfQogICAgICAgIGV1Y2pwX2ZpcnN0ID0gMHgwMDsKICAgICAgICBldWNqcF9zZWNvbmQgPSAweDAwOwogICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICB9CiAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CgogICAgICB2YXIgbGVhZCwgY29kZV9wb2ludDsKICAgICAgaWYgKGV1Y2pwX3NlY29uZCAhPT0gMHgwMCkgewogICAgICAgIGxlYWQgPSBldWNqcF9zZWNvbmQ7CiAgICAgICAgZXVjanBfc2Vjb25kID0gMHgwMDsKICAgICAgICBjb2RlX3BvaW50ID0gbnVsbDsKICAgICAgICBpZiAoaW5SYW5nZShsZWFkLCAweEExLCAweEZFKSAmJiBpblJhbmdlKGJpdGUsIDB4QTEsIDB4RkUpKSB7CiAgICAgICAgICBjb2RlX3BvaW50ID0gaW5kZXhDb2RlUG9pbnRGb3IoKGxlYWQgLSAweEExKSAqIDk0ICsgYml0ZSAtIDB4QTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhlc1snamlzMDIxMiddKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpblJhbmdlKGJpdGUsIDB4QTEsIDB4RkUpKSB7CiAgICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0xKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29kZV9wb2ludDsKICAgICAgfQogICAgICBpZiAoZXVjanBfZmlyc3QgPT09IDB4OEUgJiYgaW5SYW5nZShiaXRlLCAweEExLCAweERGKSkgewogICAgICAgIGV1Y2pwX2ZpcnN0ID0gMHgwMDsKICAgICAgICByZXR1cm4gMHhGRjYxICsgYml0ZSAtIDB4QTE7CiAgICAgIH0KICAgICAgaWYgKGV1Y2pwX2ZpcnN0ID09PSAweDhGICYmIGluUmFuZ2UoYml0ZSwgMHhBMSwgMHhGRSkpIHsKICAgICAgICBldWNqcF9maXJzdCA9IDB4MDA7CiAgICAgICAgZXVjanBfc2Vjb25kID0gYml0ZTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAoZXVjanBfZmlyc3QgIT09IDB4MDApIHsKICAgICAgICBsZWFkID0gZXVjanBfZmlyc3Q7CiAgICAgICAgZXVjanBfZmlyc3QgPSAweDAwOwogICAgICAgIGNvZGVfcG9pbnQgPSBudWxsOwogICAgICAgIGlmIChpblJhbmdlKGxlYWQsIDB4QTEsIDB4RkUpICYmIGluUmFuZ2UoYml0ZSwgMHhBMSwgMHhGRSkpIHsKICAgICAgICAgIGNvZGVfcG9pbnQgPSBpbmRleENvZGVQb2ludEZvcigobGVhZCAtIDB4QTEpICogOTQgKyBiaXRlIC0gMHhBMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleGVzWydqaXMwMjA4J10pOwogICAgICAgIH0KICAgICAgICBpZiAoIWluUmFuZ2UoYml0ZSwgMHhBMSwgMHhGRSkpIHsKICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIH0KICAgICAgICBpZiAoY29kZV9wb2ludCA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgcmV0dXJuIGJpdGU7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IDB4OEUgfHwgYml0ZSA9PT0gMHg4RiB8fCAoaW5SYW5nZShiaXRlLCAweEExLCAweEZFKSkpIHsKICAgICAgICBldWNqcF9maXJzdCA9IGJpdGU7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gRVVDSlBFbmNvZGVyKG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZU91dHB1dFN0cmVhbX0gb3V0cHV0X2J5dGVfc3RyZWFtIE91dHB1dCBieXRlIHN0cmVhbS4KICAgICAqIEBwYXJhbSB7Q29kZVBvaW50SW5wdXRTdHJlYW19IGNvZGVfcG9pbnRfcG9pbnRlciBJbnB1dCBzdHJlYW0uCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsYXN0IGJ5dGUgZW1pdHRlZC4KICAgICAqLwogICAgdGhpcy5lbmNvZGUgPSBmdW5jdGlvbihvdXRwdXRfYnl0ZV9zdHJlYW0sIGNvZGVfcG9pbnRfcG9pbnRlcikgewogICAgICB2YXIgY29kZV9wb2ludCA9IGNvZGVfcG9pbnRfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IEVPRl9jb2RlX3BvaW50KSB7CiAgICAgICAgcmV0dXJuIEVPRl9ieXRlOwogICAgICB9CiAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICBpZiAoY29kZV9wb2ludCA9PT0gMHgwMEE1KSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4NUMpOwogICAgICB9CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSAweDIwM0UpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoMHg3RSk7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhGRjYxLCAweEZGOUYpKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4OEUsIGNvZGVfcG9pbnQgLSAweEZGNjEgKyAweEExKTsKICAgICAgfQoKICAgICAgdmFyIHBvaW50ZXIgPSBpbmRleFBvaW50ZXJGb3IoY29kZV9wb2ludCwgaW5kZXhlc1snamlzMDIwOCddKTsKICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHZhciBsZWFkID0gZGl2KHBvaW50ZXIsIDk0KSArIDB4QTE7CiAgICAgIHZhciB0cmFpbCA9IHBvaW50ZXIgJSA5NCArIDB4QTE7CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkLCB0cmFpbCk7CiAgICB9OwogIH0KCiAgbmFtZV90b19lbmNvZGluZ1snZXVjLWpwJ10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRVVDSlBFbmNvZGVyKG9wdGlvbnMpOwogIH07CiAgbmFtZV90b19lbmNvZGluZ1snZXVjLWpwJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRVVDSlBEZWNvZGVyKG9wdGlvbnMpOwogIH07CgogIC8vIDExLjIgaXNvLTIwMjItanAKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gSVNPMjAyMkpQRGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgLyoqIEBlbnVtICovCiAgICB2YXIgc3RhdGUgPSB7CiAgICAgIEFTQ0lJOiAwLAogICAgICBlc2NhcGVfc3RhcnQ6IDEsCiAgICAgIGVzY2FwZV9taWRkbGU6IDIsCiAgICAgIGVzY2FwZV9maW5hbDogMywKICAgICAgbGVhZDogNCwKICAgICAgdHJhaWw6IDUsCiAgICAgIEthdGFrYW5hOiA2CiAgICB9OwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5BU0NJSSwKICAgICAgICAvKiogQHR5cGUge2Jvb2xlYW59ICovIGlzbzIwMjJqcF9qaXMwMjEyID0gZmFsc2UsCiAgICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIGlzbzIwMjJqcF9sZWFkID0gMHgwMDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSAhPT0gRU9GX2J5dGUpIHsKICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICB9CiAgICAgIHN3aXRjaCAoaXNvMjAyMmpwX3N0YXRlKSB7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICBjYXNlIHN0YXRlLkFTQ0lJOgogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MUIpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuZXNjYXBlX3N0YXJ0OwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgICAgIHJldHVybiBiaXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIHJldHVybiBFT0ZfY29kZV9wb2ludDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwoKICAgICAgICBjYXNlIHN0YXRlLmVzY2FwZV9zdGFydDoKICAgICAgICAgIGlmIChiaXRlID09PSAweDI0IHx8IGJpdGUgPT09IDB4MjgpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX2xlYWQgPSBiaXRlOwogICAgICAgICAgICBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5lc2NhcGVfbWlkZGxlOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlICE9PSBFT0ZfYnl0ZSkgewogICAgICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0xKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CgogICAgICAgIGNhc2Ugc3RhdGUuZXNjYXBlX21pZGRsZToKICAgICAgICAgIHZhciBsZWFkID0gaXNvMjAyMmpwX2xlYWQ7CiAgICAgICAgICBpc28yMDIyanBfbGVhZCA9IDB4MDA7CiAgICAgICAgICBpZiAobGVhZCA9PT0gMHgyNCAmJiAoYml0ZSA9PT0gMHg0MCB8fCBiaXRlID09PSAweDQyKSkgewogICAgICAgICAgICBpc28yMDIyanBfamlzMDIxMiA9IGZhbHNlOwogICAgICAgICAgICBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5sZWFkOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsZWFkID09PSAweDI0ICYmIGJpdGUgPT09IDB4MjgpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuZXNjYXBlX2ZpbmFsOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsZWFkID09PSAweDI4ICYmIChiaXRlID09PSAweDQyIHx8IGJpdGUgPT09IDB4NEEpKSB7CiAgICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsZWFkID09PSAweDI4ICYmIGJpdGUgPT09IDB4NDkpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuS2F0YWthbmE7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMik7CiAgICAgICAgICB9CiAgICAgICAgICBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwoKICAgICAgICBjYXNlIHN0YXRlLmVzY2FwZV9maW5hbDoKICAgICAgICAgIGlmIChiaXRlID09PSAweDQ0KSB7CiAgICAgICAgICAgIGlzbzIwMjJqcF9qaXMwMjEyID0gdHJ1ZTsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUubGVhZDsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0zKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CgogICAgICAgIGNhc2Ugc3RhdGUubGVhZDoKICAgICAgICAgIGlmIChiaXRlID09PSAweDBBKSB7CiAgICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsLCAweDAwMEEpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MUIpIHsKICAgICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuZXNjYXBlX3N0YXJ0OwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlID09PSBFT0ZfYnl0ZSkgewogICAgICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpc28yMDIyanBfbGVhZCA9IGJpdGU7CiAgICAgICAgICBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS50cmFpbDsKICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICBjYXNlIHN0YXRlLnRyYWlsOgogICAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUubGVhZDsKICAgICAgICAgIGlmIChiaXRlID09PSBFT0ZfYnl0ZSkgewogICAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb2RlX3BvaW50ID0gbnVsbDsKICAgICAgICAgIHZhciBwb2ludGVyID0gKGlzbzIwMjJqcF9sZWFkIC0gMHgyMSkgKiA5NCArIGJpdGUgLSAweDIxOwogICAgICAgICAgaWYgKGluUmFuZ2UoaXNvMjAyMmpwX2xlYWQsIDB4MjEsIDB4N0UpICYmCiAgICAgICAgICAgICAgaW5SYW5nZShiaXRlLCAweDIxLCAweDdFKSkgewogICAgICAgICAgICBjb2RlX3BvaW50ID0gKGlzbzIwMjJqcF9qaXMwMjEyID09PSBmYWxzZSkgPwogICAgICAgICAgICAgICAgaW5kZXhDb2RlUG9pbnRGb3IocG9pbnRlciwgaW5kZXhlc1snamlzMDIwOCddKSA6CiAgICAgICAgICAgICAgICBpbmRleENvZGVQb2ludEZvcihwb2ludGVyLCBpbmRleGVzWydqaXMwMjEyJ10pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29kZV9wb2ludDsKCiAgICAgICAgY2FzZSBzdGF0ZS5LYXRha2FuYToKICAgICAgICAgIGlmIChiaXRlID09PSAweDFCKSB7CiAgICAgICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLmVzY2FwZV9zdGFydDsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDIxLCAweDVGKSkgewogICAgICAgICAgICByZXR1cm4gMHhGRjYxICsgYml0ZSAtIDB4MjE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICAgICAgcmV0dXJuIEVPRl9jb2RlX3BvaW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBJU08yMDIySlBFbmNvZGVyKG9wdGlvbnMpIHsKICAgIHZhciBmYXRhbCA9IG9wdGlvbnMuZmF0YWw7CiAgICAvKiogQGVudW0gKi8KICAgIHZhciBzdGF0ZSA9IHsKICAgICAgQVNDSUk6IDAsCiAgICAgIGxlYWQ6IDEsCiAgICAgIEthdGFrYW5hOiAyCiAgICB9OwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBpc28yMDIyanBfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSB8fAogICAgICAgICAgIGNvZGVfcG9pbnQgPT09IDB4MDBBNSB8fCBjb2RlX3BvaW50ID09PSAweDIwM0UpICYmCiAgICAgICAgICBpc28yMDIyanBfc3RhdGUgIT09IHN0YXRlLkFTQ0lJKSB7CiAgICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuQVNDSUk7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MUIsIDB4MjgsIDB4NDIpOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgfQogICAgICBpZiAoY29kZV9wb2ludCA9PT0gMHgwMEE1KSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4NUMpOwogICAgICB9CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSAweDIwM0UpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoMHg3RSk7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhGRjYxLCAweEZGOUYpICYmCiAgICAgICAgICBpc28yMDIyanBfc3RhdGUgIT09IHN0YXRlLkthdGFrYW5hKSB7CiAgICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgaXNvMjAyMmpwX3N0YXRlID0gc3RhdGUuS2F0YWthbmE7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MUIsIDB4MjgsIDB4NDkpOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4RkY2MSwgMHhGRjlGKSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50IC0gMHhGRjYxIC0gMHgyMSk7CiAgICAgIH0KICAgICAgaWYgKGlzbzIwMjJqcF9zdGF0ZSAhPT0gc3RhdGUubGVhZCkgewogICAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIGlzbzIwMjJqcF9zdGF0ZSA9IHN0YXRlLmxlYWQ7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MUIsIDB4MjQsIDB4NDIpOwogICAgICB9CiAgICAgIHZhciBwb2ludGVyID0gaW5kZXhQb2ludGVyRm9yKGNvZGVfcG9pbnQsIGluZGV4ZXNbJ2ppczAyMDgnXSk7CiAgICAgIGlmIChwb2ludGVyID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgbGVhZCA9IGRpdihwb2ludGVyLCA5NCkgKyAweDIxOwogICAgICB2YXIgdHJhaWwgPSBwb2ludGVyICUgOTQgKyAweDIxOwogICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQobGVhZCwgdHJhaWwpOwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ2lzby0yMDIyLWpwJ10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgSVNPMjAyMkpQRW5jb2RlcihvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ2lzby0yMDIyLWpwJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgSVNPMjAyMkpQRGVjb2RlcihvcHRpb25zKTsKICB9OwoKICAvLyAxMS4zIHNoaWZ0X2ppcwoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBTaGlmdEpJU0RlY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIHZhciAvKiogQHR5cGUge251bWJlcn0gKi8gc2hpZnRqaXNfbGVhZCA9IDB4MDA7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RyZWFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICB2YXIgYml0ZSA9IGJ5dGVfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIHNoaWZ0amlzX2xlYWQgPT09IDB4MDApIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIHNoaWZ0amlzX2xlYWQgIT09IDB4MDApIHsKICAgICAgICBzaGlmdGppc19sZWFkID0gMHgwMDsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoc2hpZnRqaXNfbGVhZCAhPT0gMHgwMCkgewogICAgICAgIHZhciBsZWFkID0gc2hpZnRqaXNfbGVhZDsKICAgICAgICBzaGlmdGppc19sZWFkID0gMHgwMDsKICAgICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDQwLCAweDdFKSB8fCBpblJhbmdlKGJpdGUsIDB4ODAsIDB4RkMpKSB7CiAgICAgICAgICB2YXIgb2Zmc2V0ID0gKGJpdGUgPCAweDdGKSA/IDB4NDAgOiAweDQxOwogICAgICAgICAgdmFyIGxlYWRfb2Zmc2V0ID0gKGxlYWQgPCAweEEwKSA/IDB4ODEgOiAweEMxOwogICAgICAgICAgdmFyIGNvZGVfcG9pbnQgPSBpbmRleENvZGVQb2ludEZvcigobGVhZCAtIGxlYWRfb2Zmc2V0KSAqIDE4OCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdGUgLSBvZmZzZXQsIGluZGV4ZXNbJ2ppczAyMDgnXSk7CiAgICAgICAgICBpZiAoY29kZV9wb2ludCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICAgIH0KICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0xKTsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDAwLCAweDgwKSkgewogICAgICAgIHJldHVybiBiaXRlOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4QTEsIDB4REYpKSB7CiAgICAgICAgcmV0dXJuIDB4RkY2MSArIGJpdGUgLSAweEExOwogICAgICB9CiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4ODEsIDB4OUYpIHx8IGluUmFuZ2UoYml0ZSwgMHhFMCwgMHhGQykpIHsKICAgICAgICBzaGlmdGppc19sZWFkID0gYml0ZTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBTaGlmdEpJU0VuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHgwMDAwLCAweDAwODApKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSAweDAwQTUpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoMHg1Qyk7CiAgICAgIH0KICAgICAgaWYgKGNvZGVfcG9pbnQgPT09IDB4MjAzRSkgewogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDdFKTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweEZGNjEsIDB4RkY5RikpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoY29kZV9wb2ludCAtIDB4RkY2MSArIDB4QTEpOwogICAgICB9CiAgICAgIHZhciBwb2ludGVyID0gaW5kZXhQb2ludGVyRm9yKGNvZGVfcG9pbnQsIGluZGV4ZXNbJ2ppczAyMDgnXSk7CiAgICAgIGlmIChwb2ludGVyID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZXJFcnJvcihjb2RlX3BvaW50KTsKICAgICAgfQogICAgICB2YXIgbGVhZCA9IGRpdihwb2ludGVyLCAxODgpOwogICAgICB2YXIgbGVhZF9vZmZzZXQgPSBsZWFkIDwgMHgxRiA/IDB4ODEgOiAweEMxOwogICAgICB2YXIgdHJhaWwgPSBwb2ludGVyICUgMTg4OwogICAgICB2YXIgb2Zmc2V0ID0gdHJhaWwgPCAweDNGID8gMHg0MCA6IDB4NDE7CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkICsgbGVhZF9vZmZzZXQsIHRyYWlsICsgb2Zmc2V0KTsKICAgIH07CiAgfQoKICBuYW1lX3RvX2VuY29kaW5nWydzaGlmdF9qaXMnXS5nZXRFbmNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBTaGlmdEpJU0VuY29kZXIob3B0aW9ucyk7CiAgfTsKICBuYW1lX3RvX2VuY29kaW5nWydzaGlmdF9qaXMnXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBTaGlmdEpJU0RlY29kZXIob3B0aW9ucyk7CiAgfTsKCiAgLy8KICAvLyAxMi4gTGVnYWN5IG11bHRpLWJ5dGUgS29yZWFuIGVuY29kaW5ncwogIC8vCgogIC8vIDEyLjEgZXVjLWtyCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIEVVQ0tSRGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBldWNrcl9sZWFkID0gMHgwMDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlSW5wdXRTdHJlYW19IGJ5dGVfcG9pbnRlciBUaGUgYnl0ZSBzdHJlYW0gdG8gZGVjb2RlLgogICAgICogQHJldHVybiB7P251bWJlcn0gVGhlIG5leHQgY29kZSBwb2ludCBkZWNvZGVkLCBvciBudWxsIGlmIG5vdCBlbm91Z2gKICAgICAqICAgICBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQgc3RyZWFtIHRvIGRlY29kZSBhIGNvbXBsZXRlIGNvZGUgcG9pbnQuCiAgICAgKi8KICAgIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24oYnl0ZV9wb2ludGVyKSB7CiAgICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpOwogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUgJiYgZXVja3JfbGVhZCA9PT0gMCkgewogICAgICAgIHJldHVybiBFT0ZfY29kZV9wb2ludDsKICAgICAgfQogICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUgJiYgZXVja3JfbGVhZCAhPT0gMCkgewogICAgICAgIGV1Y2tyX2xlYWQgPSAweDAwOwogICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICB9CiAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChldWNrcl9sZWFkICE9PSAweDAwKSB7CiAgICAgICAgdmFyIGxlYWQgPSBldWNrcl9sZWFkOwogICAgICAgIHZhciBwb2ludGVyID0gbnVsbDsKICAgICAgICBldWNrcl9sZWFkID0gMHgwMDsKCiAgICAgICAgaWYgKGluUmFuZ2UobGVhZCwgMHg4MSwgMHhDNikpIHsKICAgICAgICAgIHZhciB0ZW1wID0gKDI2ICsgMjYgKyAxMjYpICogKGxlYWQgLSAweDgxKTsKICAgICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4NDEsIDB4NUEpKSB7CiAgICAgICAgICAgIHBvaW50ZXIgPSB0ZW1wICsgYml0ZSAtIDB4NDE7CiAgICAgICAgICB9IGVsc2UgaWYgKGluUmFuZ2UoYml0ZSwgMHg2MSwgMHg3QSkpIHsKICAgICAgICAgICAgcG9pbnRlciA9IHRlbXAgKyAyNiArIGJpdGUgLSAweDYxOwogICAgICAgICAgfSBlbHNlIGlmIChpblJhbmdlKGJpdGUsIDB4ODEsIDB4RkUpKSB7CiAgICAgICAgICAgIHBvaW50ZXIgPSB0ZW1wICsgMjYgKyAyNiArIGJpdGUgLSAweDgxOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGluUmFuZ2UobGVhZCwgMHhDNywgMHhGRCkgJiYgaW5SYW5nZShiaXRlLCAweEExLCAweEZFKSkgewogICAgICAgICAgcG9pbnRlciA9ICgyNiArIDI2ICsgMTI2KSAqICgweEM3IC0gMHg4MSkgKyAobGVhZCAtIDB4QzcpICogOTQgKwogICAgICAgICAgICAgIChiaXRlIC0gMHhBMSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgY29kZV9wb2ludCA9IChwb2ludGVyID09PSBudWxsKSA/IG51bGwgOgogICAgICAgICAgICBpbmRleENvZGVQb2ludEZvcihwb2ludGVyLCBpbmRleGVzWydldWMta3InXSk7CiAgICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIH0KICAgICAgICBpZiAoY29kZV9wb2ludCA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlX3BvaW50OwogICAgICB9CgogICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDAwLCAweDdGKSkgewogICAgICAgIHJldHVybiBiaXRlOwogICAgICB9CgogICAgICBpZiAoaW5SYW5nZShiaXRlLCAweDgxLCAweEZEKSkgewogICAgICAgIGV1Y2tyX2xlYWQgPSBiaXRlOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3tmYXRhbDogYm9vbGVhbn19IG9wdGlvbnMKICAgKi8KICBmdW5jdGlvbiBFVUNLUkVuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgY29kZV9wb2ludF9wb2ludGVyLm9mZnNldCgxKTsKICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHgwMDAwLCAweDAwN0YpKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHZhciBwb2ludGVyID0gaW5kZXhQb2ludGVyRm9yKGNvZGVfcG9pbnQsIGluZGV4ZXNbJ2V1Yy1rciddKTsKICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHZhciBsZWFkLCB0cmFpbDsKICAgICAgaWYgKHBvaW50ZXIgPCAoKDI2ICsgMjYgKyAxMjYpICogKDB4QzcgLSAweDgxKSkpIHsKICAgICAgICBsZWFkID0gZGl2KHBvaW50ZXIsICgyNiArIDI2ICsgMTI2KSkgKyAweDgxOwogICAgICAgIHRyYWlsID0gcG9pbnRlciAlICgyNiArIDI2ICsgMTI2KTsKICAgICAgICB2YXIgb2Zmc2V0ID0gdHJhaWwgPCAyNiA/IDB4NDEgOiB0cmFpbCA8IDI2ICsgMjYgPyAweDQ3IDogMHg0RDsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQobGVhZCwgdHJhaWwgKyBvZmZzZXQpOwogICAgICB9CiAgICAgIHBvaW50ZXIgPSBwb2ludGVyIC0gKDI2ICsgMjYgKyAxMjYpICogKDB4QzcgLSAweDgxKTsKICAgICAgbGVhZCA9IGRpdihwb2ludGVyLCA5NCkgKyAweEM3OwogICAgICB0cmFpbCA9IHBvaW50ZXIgJSA5NCArIDB4QTE7CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkLCB0cmFpbCk7CiAgICB9OwogIH0KCiAgbmFtZV90b19lbmNvZGluZ1snZXVjLWtyJ10uZ2V0RW5jb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRVVDS1JFbmNvZGVyKG9wdGlvbnMpOwogIH07CiAgbmFtZV90b19lbmNvZGluZ1snZXVjLWtyJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRVVDS1JEZWNvZGVyKG9wdGlvbnMpOwogIH07CgogIC8vIDEyLjIgaXNvLTIwMjIta3IKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gSVNPMjAyMktSRGVjb2RlcihvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgLyoqIEBlbnVtICovCiAgICB2YXIgc3RhdGUgPSB7CiAgICAgIEFTQ0lJOiAwLAogICAgICBlc2NhcGVfc3RhcnQ6IDEsCiAgICAgIGVzY2FwZV9taWRkbGU6IDIsCiAgICAgIGVzY2FwZV9lbmQ6IDMsCiAgICAgIGxlYWQ6IDQsCiAgICAgIHRyYWlsOiA1CiAgICB9OwogICAgdmFyIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSSwKICAgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gaXNvMjAyMmtyX2xlYWQgPSAweDAwOwogICAgLyoqCiAgICAgKiBAcGFyYW0ge0J5dGVJbnB1dFN0cmVhbX0gYnl0ZV9wb2ludGVyIFRoZSBieXRlIHN0cmVhbSB0byBkZWNvZGUuCiAgICAgKiBAcmV0dXJuIHs/bnVtYmVyfSBUaGUgbmV4dCBjb2RlIHBvaW50IGRlY29kZWQsIG9yIG51bGwgaWYgbm90IGVub3VnaAogICAgICogICAgIGRhdGEgZXhpc3RzIGluIHRoZSBpbnB1dCBzdHJlYW0gdG8gZGVjb2RlIGEgY29tcGxldGUgY29kZSBwb2ludC4KICAgICAqLwogICAgdGhpcy5kZWNvZGUgPSBmdW5jdGlvbihieXRlX3BvaW50ZXIpIHsKICAgICAgdmFyIGJpdGUgPSBieXRlX3BvaW50ZXIuZ2V0KCk7CiAgICAgIGlmIChiaXRlICE9PSBFT0ZfYnl0ZSkgewogICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIH0KICAgICAgc3dpdGNoIChpc28yMDIya3Jfc3RhdGUpIHsKICAgICAgICBkZWZhdWx0OgogICAgICAgIGNhc2Ugc3RhdGUuQVNDSUk6CiAgICAgICAgICBpZiAoYml0ZSA9PT0gMHgwRSkgewogICAgICAgICAgICBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5sZWFkOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlID09PSAweDBGKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MUIpIHsKICAgICAgICAgICAgaXNvMjAyMmtyX3N0YXRlID0gc3RhdGUuZXNjYXBlX3N0YXJ0OwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CiAgICAgICAgICAgIHJldHVybiBiaXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIHJldHVybiBFT0ZfY29kZV9wb2ludDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIGNhc2Ugc3RhdGUuZXNjYXBlX3N0YXJ0OgogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MjQpIHsKICAgICAgICAgICAgaXNvMjAyMmtyX3N0YXRlID0gc3RhdGUuZXNjYXBlX21pZGRsZTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYml0ZSAhPT0gRU9GX2J5dGUpIHsKICAgICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSk7CiAgICAgICAgICB9CiAgICAgICAgICBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIGNhc2Ugc3RhdGUuZXNjYXBlX21pZGRsZToKICAgICAgICAgIGlmIChiaXRlID09PSAweDI5KSB7CiAgICAgICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLmVzY2FwZV9lbmQ7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMik7CiAgICAgICAgICB9CiAgICAgICAgICBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgICAgICAgIHJldHVybiBkZWNvZGVyRXJyb3IoZmF0YWwpOwogICAgICAgIGNhc2Ugc3RhdGUuZXNjYXBlX2VuZDoKICAgICAgICAgIGlmIChiaXRlID09PSAweDQzKSB7CiAgICAgICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlID09PSBFT0ZfYnl0ZSkgewogICAgICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0yKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoLTMpOwogICAgICAgICAgfQogICAgICAgICAgaXNvMjAyMmtyX3N0YXRlID0gc3RhdGUuQVNDSUk7CiAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgICBjYXNlIHN0YXRlLmxlYWQ6CiAgICAgICAgICBpZiAoYml0ZSA9PT0gMHgwQSkgewogICAgICAgICAgICBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCwgMHgwMDBBKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiaXRlID09PSAweDBFKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IDB4MEYpIHsKICAgICAgICAgICAgaXNvMjAyMmtyX3N0YXRlID0gc3RhdGUuQVNDSUk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7CiAgICAgICAgICAgIHJldHVybiBFT0ZfY29kZV9wb2ludDsKICAgICAgICAgIH0KICAgICAgICAgIGlzbzIwMjJrcl9sZWFkID0gYml0ZTsKICAgICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLnRyYWlsOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgY2FzZSBzdGF0ZS50cmFpbDoKICAgICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLmxlYWQ7CiAgICAgICAgICBpZiAoYml0ZSA9PT0gRU9GX2J5dGUpIHsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29kZV9wb2ludCA9IG51bGw7CiAgICAgICAgICBpZiAoaW5SYW5nZShpc28yMDIya3JfbGVhZCwgMHgyMSwgMHg0NikgJiYKICAgICAgICAgICAgICBpblJhbmdlKGJpdGUsIDB4MjEsIDB4N0UpKSB7CiAgICAgICAgICAgIGNvZGVfcG9pbnQgPSBpbmRleENvZGVQb2ludEZvcigoMjYgKyAyNiArIDEyNikgKgogICAgICAgICAgICAgICAgKGlzbzIwMjJrcl9sZWFkIC0gMSkgKwogICAgICAgICAgICAgICAgMjYgKyAyNiArIGJpdGUgLSAxLAogICAgICAgICAgICAgICAgaW5kZXhlc1snZXVjLWtyJ10pOwogICAgICAgICAgfSBlbHNlIGlmIChpblJhbmdlKGlzbzIwMjJrcl9sZWFkLCAweDQ3LCAweDdFKSAmJgogICAgICAgICAgICAgIGluUmFuZ2UoYml0ZSwgMHgyMSwgMHg3RSkpIHsKICAgICAgICAgICAgY29kZV9wb2ludCA9IGluZGV4Q29kZVBvaW50Rm9yKCgyNiArIDI2ICsgMTI2KSAqICgweEM3IC0gMHg4MSkgKwogICAgICAgICAgICAgICAgKGlzbzIwMjJrcl9sZWFkIC0gMHg0NykgKiA5NCArCiAgICAgICAgICAgICAgICAoYml0ZSAtIDB4MjEpLAogICAgICAgICAgICAgICAgaW5kZXhlc1snZXVjLWtyJ10pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVfcG9pbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgfTsKICB9CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIElTTzIwMjJLUkVuY29kZXIob3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIC8qKiBAZW51bSAqLwogICAgdmFyIHN0YXRlID0gewogICAgICBBU0NJSTogMCwKICAgICAgbGVhZDogMQogICAgfTsKICAgIHZhciAvKiogQHR5cGUge2Jvb2xlYW59ICovIGlzbzIwMjJrcl9pbml0aWFsaXphdGlvbiA9IGZhbHNlLAogICAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBpc28yMDIya3Jfc3RhdGUgPSBzdGF0ZS5BU0NJSTsKICAgIC8qKgogICAgICogQHBhcmFtIHtCeXRlT3V0cHV0U3RyZWFtfSBvdXRwdXRfYnl0ZV9zdHJlYW0gT3V0cHV0IGJ5dGUgc3RyZWFtLgogICAgICogQHBhcmFtIHtDb2RlUG9pbnRJbnB1dFN0cmVhbX0gY29kZV9wb2ludF9wb2ludGVyIElucHV0IHN0cmVhbS4KICAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxhc3QgYnl0ZSBlbWl0dGVkLgogICAgICovCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7CiAgICAgIHZhciBjb2RlX3BvaW50ID0gY29kZV9wb2ludF9wb2ludGVyLmdldCgpOwogICAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICByZXR1cm4gRU9GX2J5dGU7CiAgICAgIH0KICAgICAgaWYgKCFpc28yMDIya3JfaW5pdGlhbGl6YXRpb24pIHsKICAgICAgICBpc28yMDIya3JfaW5pdGlhbGl6YXRpb24gPSB0cnVlOwogICAgICAgIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MUIsIDB4MjQsIDB4MjksIDB4NDMpOwogICAgICB9CiAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoMSk7CiAgICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdGKSAmJgogICAgICAgICAgaXNvMjAyMmtyX3N0YXRlICE9PSBzdGF0ZS5BU0NJSSkgewogICAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLkFTQ0lJOwogICAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDBGKTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3RikpIHsKICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgaWYgKGlzbzIwMjJrcl9zdGF0ZSAhPT0gc3RhdGUubGVhZCkgewogICAgICAgIGNvZGVfcG9pbnRfcG9pbnRlci5vZmZzZXQoLTEpOwogICAgICAgIGlzbzIwMjJrcl9zdGF0ZSA9IHN0YXRlLmxlYWQ7CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KDB4MEUpOwogICAgICB9CiAgICAgIHZhciBwb2ludGVyID0gaW5kZXhQb2ludGVyRm9yKGNvZGVfcG9pbnQsIGluZGV4ZXNbJ2V1Yy1rciddKTsKICAgICAgaWYgKHBvaW50ZXIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHZhciBsZWFkLCB0cmFpbDsKICAgICAgaWYgKHBvaW50ZXIgPCAoMjYgKyAyNiArIDEyNikgKiAoMHhDNyAtIDB4ODEpKSB7CiAgICAgICAgbGVhZCA9IGRpdihwb2ludGVyLCAoMjYgKyAyNiArIDEyNikpICsgMTsKICAgICAgICB0cmFpbCA9IHBvaW50ZXIgJSAoMjYgKyAyNiArIDEyNikgLSAyNiAtIDI2ICsgMTsKICAgICAgICBpZiAoIWluUmFuZ2UobGVhZCwgMHgyMSwgMHg0NikgfHwgIWluUmFuZ2UodHJhaWwsIDB4MjEsIDB4N0UpKSB7CiAgICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQobGVhZCwgdHJhaWwpOwogICAgICB9CiAgICAgIHBvaW50ZXIgPSBwb2ludGVyIC0gKDI2ICsgMjYgKyAxMjYpICogKDB4QzcgLSAweDgxKTsKICAgICAgbGVhZCA9IGRpdihwb2ludGVyLCA5NCkgKyAweDQ3OwogICAgICB0cmFpbCA9IHBvaW50ZXIgJSA5NCArIDB4MjE7CiAgICAgIGlmICghaW5SYW5nZShsZWFkLCAweDQ3LCAweDdFKSB8fCAhaW5SYW5nZSh0cmFpbCwgMHgyMSwgMHg3RSkpIHsKICAgICAgICByZXR1cm4gZW5jb2RlckVycm9yKGNvZGVfcG9pbnQpOwogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChsZWFkLCB0cmFpbCk7CiAgICB9OwogIH0KCiAgbmFtZV90b19lbmNvZGluZ1snaXNvLTIwMjIta3InXS5nZXRFbmNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBJU08yMDIyS1JFbmNvZGVyKG9wdGlvbnMpOwogIH07CiAgbmFtZV90b19lbmNvZGluZ1snaXNvLTIwMjIta3InXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBJU08yMDIyS1JEZWNvZGVyKG9wdGlvbnMpOwogIH07CgoKICAvLwogIC8vIDEzLiBMZWdhY3kgdXRmLTE2IGVuY29kaW5ncwogIC8vCgogIC8vIDEzLjEgdXRmLTE2CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gdXRmMTZfYmUgVHJ1ZSBpZiBiaWctZW5kaWFuLCBmYWxzZSBpZiBsaXR0bGUtZW5kaWFuLgogICAqIEBwYXJhbSB7e2ZhdGFsOiBib29sZWFufX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIFVURjE2RGVjb2Rlcih1dGYxNl9iZSwgb3B0aW9ucykgewogICAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKICAgIHZhciAvKiogQHR5cGUgez9udW1iZXJ9ICovIHV0ZjE2X2xlYWRfYnl0ZSA9IG51bGwsCiAgICAgICAgLyoqIEB0eXBlIHs/bnVtYmVyfSAqLyB1dGYxNl9sZWFkX3N1cnJvZ2F0ZSA9IG51bGw7CiAgICAvKioKICAgICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBieXRlX3BvaW50ZXIgVGhlIGJ5dGUgc3RyZWFtIHRvIGRlY29kZS4KICAgICAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBuZXh0IGNvZGUgcG9pbnQgZGVjb2RlZCwgb3IgbnVsbCBpZiBub3QgZW5vdWdoCiAgICAgKiAgICAgZGF0YSBleGlzdHMgaW4gdGhlIGlucHV0IHN0cmVhbSB0byBkZWNvZGUgYSBjb21wbGV0ZSBjb2RlIHBvaW50LgogICAgICovCiAgICB0aGlzLmRlY29kZSA9IGZ1bmN0aW9uKGJ5dGVfcG9pbnRlcikgewogICAgICB2YXIgYml0ZSA9IGJ5dGVfcG9pbnRlci5nZXQoKTsKICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmIHV0ZjE2X2xlYWRfYnl0ZSA9PT0gbnVsbCAmJgogICAgICAgICAgdXRmMTZfbGVhZF9zdXJyb2dhdGUgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gRU9GX2NvZGVfcG9pbnQ7CiAgICAgIH0KICAgICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlICYmICh1dGYxNl9sZWFkX2J5dGUgIT09IG51bGwgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dGYxNl9sZWFkX3N1cnJvZ2F0ZSAhPT0gbnVsbCkpIHsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAodXRmMTZfbGVhZF9ieXRlID09PSBudWxsKSB7CiAgICAgICAgdXRmMTZfbGVhZF9ieXRlID0gYml0ZTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICB2YXIgY29kZV9wb2ludDsKICAgICAgaWYgKHV0ZjE2X2JlKSB7CiAgICAgICAgY29kZV9wb2ludCA9ICh1dGYxNl9sZWFkX2J5dGUgPDwgOCkgKyBiaXRlOwogICAgICB9IGVsc2UgewogICAgICAgIGNvZGVfcG9pbnQgPSAoYml0ZSA8PCA4KSArIHV0ZjE2X2xlYWRfYnl0ZTsKICAgICAgfQogICAgICB1dGYxNl9sZWFkX2J5dGUgPSBudWxsOwogICAgICBpZiAodXRmMTZfbGVhZF9zdXJyb2dhdGUgIT09IG51bGwpIHsKICAgICAgICB2YXIgbGVhZF9zdXJyb2dhdGUgPSB1dGYxNl9sZWFkX3N1cnJvZ2F0ZTsKICAgICAgICB1dGYxNl9sZWFkX3N1cnJvZ2F0ZSA9IG51bGw7CiAgICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhEQzAwLCAweERGRkYpKSB7CiAgICAgICAgICByZXR1cm4gMHgxMDAwMCArIChsZWFkX3N1cnJvZ2F0ZSAtIDB4RDgwMCkgKiAweDQwMCArCiAgICAgICAgICAgICAgKGNvZGVfcG9pbnQgLSAweERDMDApOwogICAgICAgIH0KICAgICAgICBieXRlX3BvaW50ZXIub2Zmc2V0KC0yKTsKICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKICAgICAgfQogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweEQ4MDAsIDB4REJGRikpIHsKICAgICAgICB1dGYxNl9sZWFkX3N1cnJvZ2F0ZSA9IGNvZGVfcG9pbnQ7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhEQzAwLCAweERGRkYpKSB7CiAgICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtib29sZWFufSB1dGYxNl9iZSBUcnVlIGlmIGJpZy1lbmRpYW4sIGZhbHNlIGlmIGxpdHRsZS1lbmRpYW4uCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCiAgICovCiAgZnVuY3Rpb24gVVRGMTZFbmNvZGVyKHV0ZjE2X2JlLCBvcHRpb25zKSB7CiAgICB2YXIgZmF0YWwgPSBvcHRpb25zLmZhdGFsOwogICAgLyoqCiAgICAgKiBAcGFyYW0ge0J5dGVPdXRwdXRTdHJlYW19IG91dHB1dF9ieXRlX3N0cmVhbSBPdXRwdXQgYnl0ZSBzdHJlYW0uCiAgICAgKiBAcGFyYW0ge0NvZGVQb2ludElucHV0U3RyZWFtfSBjb2RlX3BvaW50X3BvaW50ZXIgSW5wdXQgc3RyZWFtLgogICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFzdCBieXRlIGVtaXR0ZWQuCiAgICAgKi8KICAgIHRoaXMuZW5jb2RlID0gZnVuY3Rpb24ob3V0cHV0X2J5dGVfc3RyZWFtLCBjb2RlX3BvaW50X3BvaW50ZXIpIHsKICAgICAgZnVuY3Rpb24gY29udmVydF90b19ieXRlcyhjb2RlX3VuaXQpIHsKICAgICAgICB2YXIgYnl0ZTEgPSBjb2RlX3VuaXQgPj4gODsKICAgICAgICB2YXIgYnl0ZTIgPSBjb2RlX3VuaXQgJiAweDAwRkY7CiAgICAgICAgaWYgKHV0ZjE2X2JlKSB7CiAgICAgICAgICByZXR1cm4gb3V0cHV0X2J5dGVfc3RyZWFtLmVtaXQoYnl0ZTEsIGJ5dGUyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dF9ieXRlX3N0cmVhbS5lbWl0KGJ5dGUyLCBieXRlMSk7CiAgICAgIH0KICAgICAgdmFyIGNvZGVfcG9pbnQgPSBjb2RlX3BvaW50X3BvaW50ZXIuZ2V0KCk7CiAgICAgIGlmIChjb2RlX3BvaW50ID09PSBFT0ZfY29kZV9wb2ludCkgewogICAgICAgIHJldHVybiBFT0ZfYnl0ZTsKICAgICAgfQogICAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KDEpOwogICAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweEQ4MDAsIDB4REZGRikpIHsKICAgICAgICBlbmNvZGVyRXJyb3IoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgaWYgKGNvZGVfcG9pbnQgPD0gMHhGRkZGKSB7CiAgICAgICAgcmV0dXJuIGNvbnZlcnRfdG9fYnl0ZXMoY29kZV9wb2ludCk7CiAgICAgIH0KICAgICAgdmFyIGxlYWQgPSBkaXYoKGNvZGVfcG9pbnQgLSAweDEwMDAwKSwgMHg0MDApICsgMHhEODAwOwogICAgICB2YXIgdHJhaWwgPSAoKGNvZGVfcG9pbnQgLSAweDEwMDAwKSAlIDB4NDAwKSArIDB4REMwMDsKICAgICAgY29udmVydF90b19ieXRlcyhsZWFkKTsKICAgICAgcmV0dXJuIGNvbnZlcnRfdG9fYnl0ZXModHJhaWwpOwogICAgfTsKICB9CgogIG5hbWVfdG9fZW5jb2RpbmdbJ3V0Zi0xNiddLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFVURjE2RW5jb2RlcihmYWxzZSwgb3B0aW9ucyk7CiAgfTsKICBuYW1lX3RvX2VuY29kaW5nWyd1dGYtMTYnXS5nZXREZWNvZGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBVVEYxNkRlY29kZXIoZmFsc2UsIG9wdGlvbnMpOwogIH07CgogIC8vIDEzLjIgdXRmLTE2YmUKICBuYW1lX3RvX2VuY29kaW5nWyd1dGYtMTZiZSddLmdldEVuY29kZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFVURjE2RW5jb2Rlcih0cnVlLCBvcHRpb25zKTsKICB9OwogIG5hbWVfdG9fZW5jb2RpbmdbJ3V0Zi0xNmJlJ10uZ2V0RGVjb2RlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgVVRGMTZEZWNvZGVyKHRydWUsIG9wdGlvbnMpOwogIH07CgoKICAvLyBOT1RFOiBjdXJyZW50bHkgdW51c2VkCiAgLyoqCiAgICogQHBhcmFtIHtzdHJpbmd9IGxhYmVsIFRoZSBlbmNvZGluZyBsYWJlbC4KICAgKiBAcGFyYW0ge0J5dGVJbnB1dFN0cmVhbX0gaW5wdXRfc3RyZWFtIFRoZSBieXRlIHN0cmVhbSB0byB0ZXN0LgogICAqLwogIGZ1bmN0aW9uIGRldGVjdEVuY29kaW5nKGxhYmVsLCBpbnB1dF9zdHJlYW0pIHsKICAgIGlmIChpbnB1dF9zdHJlYW0ubWF0Y2goWzB4RkYsIDB4RkVdKSkgewogICAgICBpbnB1dF9zdHJlYW0ub2Zmc2V0KDIpOwogICAgICByZXR1cm4gJ3V0Zi0xNic7CiAgICB9CiAgICBpZiAoaW5wdXRfc3RyZWFtLm1hdGNoKFsweEZFLCAweEZGXSkpIHsKICAgICAgaW5wdXRfc3RyZWFtLm9mZnNldCgyKTsKICAgICAgcmV0dXJuICd1dGYtMTZiZSc7CiAgICB9CiAgICBpZiAoaW5wdXRfc3RyZWFtLm1hdGNoKFsweEVGLCAweEJCLCAweEJGXSkpIHsKICAgICAgaW5wdXRfc3RyZWFtLm9mZnNldCgzKTsKICAgICAgcmV0dXJuICd1dGYtOCc7CiAgICB9CiAgICByZXR1cm4gbGFiZWw7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge3N0cmluZ30gbGFiZWwgVGhlIGVuY29kaW5nIGxhYmVsLgogICAqIEBwYXJhbSB7Qnl0ZUlucHV0U3RyZWFtfSBpbnB1dF9zdHJlYW0gVGhlIGJ5dGUgc3RyZWFtIHRvIHRlc3QuCiAgICovCiAgZnVuY3Rpb24gY29uc3VtZUJPTShsYWJlbCwgaW5wdXRfc3RyZWFtKSB7CiAgICBpZiAoaW5wdXRfc3RyZWFtLm1hdGNoKFsweEZGLCAweEZFXSkgJiYgbGFiZWwgPT09ICd1dGYtMTYnKSB7CiAgICAgIGlucHV0X3N0cmVhbS5vZmZzZXQoMik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpbnB1dF9zdHJlYW0ubWF0Y2goWzB4RkUsIDB4RkZdKSAmJiBsYWJlbCA9PSAndXRmLTE2YmUnKSB7CiAgICAgIGlucHV0X3N0cmVhbS5vZmZzZXQoMik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpbnB1dF9zdHJlYW0ubWF0Y2goWzB4RUYsIDB4QkIsIDB4QkZdKSAmJiBsYWJlbCA9PSAndXRmLTgnKSB7CiAgICAgIGlucHV0X3N0cmVhbS5vZmZzZXQoMyk7CiAgICAgIHJldHVybjsKICAgIH0KICB9CgogIC8vCiAgLy8gSW1wbGVtZW50YXRpb24gb2YgVGV4dCBFbmNvZGluZyBXZWIgQVBJCiAgLy8KCiAgLyoqIEBjb25zdCAqLyB2YXIgREVGQVVMVF9FTkNPRElORyA9ICd1dGYtOCc7CgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7c3RyaW5nPX0gb3B0X2VuY29kaW5nIFRoZSBsYWJlbCBvZiB0aGUgZW5jb2Rpbmc7CiAgICogICAgIGRlZmF1bHRzIHRvICd1dGYtOCcuCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59PX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIFRleHRFbmNvZGVyKG9wdF9lbmNvZGluZywgb3B0aW9ucykgewogICAgaWYgKCF0aGlzIHx8IHRoaXMgPT09IGdsb2JhbCkgewogICAgICByZXR1cm4gbmV3IFRleHRFbmNvZGVyKG9wdF9lbmNvZGluZywgb3B0aW9ucyk7CiAgICB9CiAgICBvcHRfZW5jb2RpbmcgPSBvcHRfZW5jb2RpbmcgPyBTdHJpbmcob3B0X2VuY29kaW5nKSA6IERFRkFVTFRfRU5DT0RJTkc7CiAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpOwogICAgLyoqIEBwcml2YXRlICovCiAgICB0aGlzLl9lbmNvZGluZyA9IGdldEVuY29kaW5nKG9wdF9lbmNvZGluZyk7CiAgICBpZiAodGhpcy5fZW5jb2RpbmcgPT09IG51bGwgfHwgKHRoaXMuX2VuY29kaW5nLm5hbWUgIT09ICd1dGYtOCcgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW5jb2RpbmcubmFtZSAhPT0gJ3V0Zi0xNicgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW5jb2RpbmcubmFtZSAhPT0gJ3V0Zi0xNmJlJykpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBvcHRfZW5jb2RpbmcpOwogICAgLyogQHByaXZhdGUgQHR5cGUge2Jvb2xlYW59ICovCiAgICB0aGlzLl9zdHJlYW1pbmcgPSBmYWxzZTsKICAgIC8qKiBAcHJpdmF0ZSAqLwogICAgdGhpcy5fZW5jb2RlciA9IG51bGw7CiAgICAvKiBAcHJpdmF0ZSBAdHlwZSB7e2ZhdGFsOiBib29sZWFufT19ICovCiAgICB0aGlzLl9vcHRpb25zID0geyBmYXRhbDogQm9vbGVhbihvcHRpb25zLmZhdGFsKSB9OwoKICAgIGlmIChPYmplY3QuZGVmaW5lUHJvcGVydHkpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KAogICAgICAgICAgdGhpcywgJ2VuY29kaW5nJywKICAgICAgICAgIHsgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuX2VuY29kaW5nLm5hbWU7IH0gfSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmVuY29kaW5nID0gdGhpcy5fZW5jb2RpbmcubmFtZTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9CgogIFRleHRFbmNvZGVyLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBvcHRfc3RyaW5nIFRoZSBzdHJpbmcgdG8gZW5jb2RlLgogICAgICogQHBhcmFtIHt7c3RyZWFtOiBib29sZWFufT19IG9wdGlvbnMKICAgICAqLwogICAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGUob3B0X3N0cmluZywgb3B0aW9ucykgewogICAgICBvcHRfc3RyaW5nID0gb3B0X3N0cmluZyA/IFN0cmluZyhvcHRfc3RyaW5nKSA6ICcnOwogICAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpOwogICAgICAvLyBUT0RPOiBhbnkgb3B0aW9ucz8KICAgICAgaWYgKCF0aGlzLl9zdHJlYW1pbmcpIHsKICAgICAgICB0aGlzLl9lbmNvZGVyID0gdGhpcy5fZW5jb2RpbmcuZ2V0RW5jb2Rlcih0aGlzLl9vcHRpb25zKTsKICAgICAgfQogICAgICB0aGlzLl9zdHJlYW1pbmcgPSBCb29sZWFuKG9wdGlvbnMuc3RyZWFtKTsKCiAgICAgIHZhciBieXRlcyA9IFtdOwogICAgICB2YXIgb3V0cHV0X3N0cmVhbSA9IG5ldyBCeXRlT3V0cHV0U3RyZWFtKGJ5dGVzKTsKICAgICAgdmFyIGlucHV0X3N0cmVhbSA9IG5ldyBDb2RlUG9pbnRJbnB1dFN0cmVhbShvcHRfc3RyaW5nKTsKICAgICAgd2hpbGUgKGlucHV0X3N0cmVhbS5nZXQoKSAhPT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICB0aGlzLl9lbmNvZGVyLmVuY29kZShvdXRwdXRfc3RyZWFtLCBpbnB1dF9zdHJlYW0pOwogICAgICB9CiAgICAgIGlmICghdGhpcy5fc3RyZWFtaW5nKSB7CiAgICAgICAgdmFyIGxhc3RfYnl0ZTsKICAgICAgICBkbyB7CiAgICAgICAgICBsYXN0X2J5dGUgPSB0aGlzLl9lbmNvZGVyLmVuY29kZShvdXRwdXRfc3RyZWFtLCBpbnB1dF9zdHJlYW0pOwogICAgICAgIH0gd2hpbGUgKGxhc3RfYnl0ZSAhPT0gRU9GX2J5dGUpOwogICAgICAgIHRoaXMuX2VuY29kZXIgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShieXRlcyk7CiAgICB9CiAgfTsKCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7c3RyaW5nPX0gb3B0X2VuY29kaW5nIFRoZSBsYWJlbCBvZiB0aGUgZW5jb2Rpbmc7CiAgICogICAgIGRlZmF1bHRzIHRvICd1dGYtOCcuCiAgICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59PX0gb3B0aW9ucwogICAqLwogIGZ1bmN0aW9uIFRleHREZWNvZGVyKG9wdF9lbmNvZGluZywgb3B0aW9ucykgewogICAgaWYgKCF0aGlzIHx8IHRoaXMgPT09IGdsb2JhbCkgewogICAgICByZXR1cm4gbmV3IFRleHREZWNvZGVyKG9wdF9lbmNvZGluZywgb3B0aW9ucyk7CiAgICB9CiAgICBvcHRfZW5jb2RpbmcgPSBvcHRfZW5jb2RpbmcgPyBTdHJpbmcob3B0X2VuY29kaW5nKSA6IERFRkFVTFRfRU5DT0RJTkc7CiAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpOwogICAgLyoqIEBwcml2YXRlICovCiAgICB0aGlzLl9lbmNvZGluZyA9IGdldEVuY29kaW5nKG9wdF9lbmNvZGluZyk7CiAgICBpZiAodGhpcy5fZW5jb2RpbmcgPT09IG51bGwpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBvcHRfZW5jb2RpbmcpOwoKICAgIC8qIEBwcml2YXRlIEB0eXBlIHtib29sZWFufSAqLwogICAgdGhpcy5fc3RyZWFtaW5nID0gZmFsc2U7CiAgICAvKiogQHByaXZhdGUgKi8KICAgIHRoaXMuX2RlY29kZXIgPSBudWxsOwogICAgLyogQHByaXZhdGUgQHR5cGUge3tmYXRhbDogYm9vbGVhbn09fSAqLwogICAgdGhpcy5fb3B0aW9ucyA9IHsgZmF0YWw6IEJvb2xlYW4ob3B0aW9ucy5mYXRhbCkgfTsKCiAgICBpZiAoT2JqZWN0LmRlZmluZVByb3BlcnR5KSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgKICAgICAgICAgIHRoaXMsICdlbmNvZGluZycsCiAgICAgICAgICB7IGdldDogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLl9lbmNvZGluZy5uYW1lOyB9IH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5lbmNvZGluZyA9IHRoaXMuX2VuY29kaW5nLm5hbWU7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBUT0RPOiBJc3N1ZSBpZiBpbnB1dCBieXRlIHN0cmVhbSBpcyBvZmZzZXQgYnkgZGVjb2RlcgogIC8vIFRPRE86IEJPTSBkZXRlY3Rpb24gd2lsbCBub3Qgd29yayBpZiBzdHJlYW0gaGVhZGVyIHNwYW5zIG11bHRpcGxlIGNhbGxzCiAgLy8gKGxhc3QgTiBieXRlcyBvZiBwcmV2aW91cyBzdHJlYW0gbWF5IG5lZWQgdG8gYmUgcmV0YWluZWQ/KQogIFRleHREZWNvZGVyLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogQHBhcmFtIHtBcnJheUJ1ZmZlclZpZXc9fSBvcHRfdmlldyBUaGUgYnVmZmVyIG9mIGJ5dGVzIHRvIGRlY29kZS4KICAgICAqIEBwYXJhbSB7e3N0cmVhbTogYm9vbGVhbn09fSBvcHRpb25zCiAgICAgKi8KICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlKG9wdF92aWV3LCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRfdmlldyAmJiAhKCdidWZmZXInIGluIG9wdF92aWV3ICYmICdieXRlT2Zmc2V0JyBpbiBvcHRfdmlldyAmJgogICAgICAgICAgICAgICAgICAgICAgICAnYnl0ZUxlbmd0aCcgaW4gb3B0X3ZpZXcpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgQXJyYXlCdWZmZXJWaWV3Jyk7CiAgICAgIH0gZWxzZSBpZiAoIW9wdF92aWV3KSB7CiAgICAgICAgb3B0X3ZpZXcgPSBuZXcgVWludDhBcnJheSgwKTsKICAgICAgfQogICAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpOwoKICAgICAgaWYgKCF0aGlzLl9zdHJlYW1pbmcpIHsKICAgICAgICB0aGlzLl9kZWNvZGVyID0gdGhpcy5fZW5jb2RpbmcuZ2V0RGVjb2Rlcih0aGlzLl9vcHRpb25zKTsKICAgICAgfQogICAgICB0aGlzLl9zdHJlYW1pbmcgPSBCb29sZWFuKG9wdGlvbnMuc3RyZWFtKTsKCiAgICAgIHZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KG9wdF92aWV3LmJ1ZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0X3ZpZXcuYnl0ZU9mZnNldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0X3ZpZXcuYnl0ZUxlbmd0aCk7CiAgICAgIHZhciBpbnB1dF9zdHJlYW0gPSBuZXcgQnl0ZUlucHV0U3RyZWFtKGJ5dGVzKTsKCiAgICAgIGlmICghdGhpcy5fQk9Nc2VlbikgewogICAgICAgIC8vIFRPRE86IERvbid0IGRvIHRoaXMgdW50aWwgc3VmZmljaWVudCBieXRlcyBhcmUgcHJlc2VudAogICAgICAgIHRoaXMuX0JPTXNlZW4gPSB0cnVlOwogICAgICAgIGNvbnN1bWVCT00odGhpcy5fZW5jb2RpbmcubmFtZSwgaW5wdXRfc3RyZWFtKTsKICAgICAgfQoKICAgICAgdmFyIG91dHB1dF9zdHJlYW0gPSBuZXcgQ29kZVBvaW50T3V0cHV0U3RyZWFtKCksIGNvZGVfcG9pbnQ7CiAgICAgIHdoaWxlIChpbnB1dF9zdHJlYW0uZ2V0KCkgIT09IEVPRl9ieXRlKSB7CiAgICAgICAgY29kZV9wb2ludCA9IHRoaXMuX2RlY29kZXIuZGVjb2RlKGlucHV0X3N0cmVhbSk7CiAgICAgICAgaWYgKGNvZGVfcG9pbnQgIT09IG51bGwgJiYgY29kZV9wb2ludCAhPT0gRU9GX2NvZGVfcG9pbnQpIHsKICAgICAgICAgIG91dHB1dF9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCF0aGlzLl9zdHJlYW1pbmcpIHsKICAgICAgICBkbyB7CiAgICAgICAgICBjb2RlX3BvaW50ID0gdGhpcy5fZGVjb2Rlci5kZWNvZGUoaW5wdXRfc3RyZWFtKTsKICAgICAgICAgIGlmIChjb2RlX3BvaW50ICE9PSBudWxsICYmIGNvZGVfcG9pbnQgIT09IEVPRl9jb2RlX3BvaW50KSB7CiAgICAgICAgICAgIG91dHB1dF9zdHJlYW0uZW1pdChjb2RlX3BvaW50KTsKICAgICAgICAgIH0KICAgICAgICB9IHdoaWxlIChjb2RlX3BvaW50ICE9PSBFT0ZfY29kZV9wb2ludCAmJgogICAgICAgICAgICAgICAgIGlucHV0X3N0cmVhbS5nZXQoKSAhPSBFT0ZfYnl0ZSk7CiAgICAgICAgdGhpcy5fZGVjb2RlciA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIG91dHB1dF9zdHJlYW0uc3RyaW5nKCk7CiAgICB9CiAgfTsKCiAgZ2xvYmFsWydUZXh0RW5jb2RlciddID0gZ2xvYmFsWydUZXh0RW5jb2RlciddIHx8IFRleHRFbmNvZGVyOwogIGdsb2JhbFsnVGV4dERlY29kZXInXSA9IGdsb2JhbFsnVGV4dERlY29kZXInXSB8fCBUZXh0RGVjb2RlcjsKfSh0aGlzKSk7CihmdW5jdGlvbihnbG9iYWwpIHsKCi8vIFJ1bW9yIE1lc3NhZ2luZyBmb3IgSlMKLy8KLy8gaHR0cHM6Ly90Yndpa2kudG9rYm94LmNvbS9pbmRleC5waHAvUnVtb3JfOl9NZXNzYWdpbmdfRnJhbWVXb3JrCi8vCi8vIEB0b2RvIFJ1bW9yIHsKLy8gICAgIEFkZCBlcnJvciBjb2RlcyBmb3IgYWxsIHRoZSBlcnJvciBjYXNlcwovLyAgICAgQWRkIERlcGVuZGFiaWxpdHkgY29tbWFuZHMKLy8gfQoKT1QuUnVtb3IgPSB7CiAgTWVzc2FnZVR5cGU6IHsKICAgIC8vIFRoaXMgaXMgdXNlZCB0byBzdWJzY3JpYmUgdG8gYWRkcmVzcy9hZGRyZXNzZXMuIFRoZSBhZGRyZXNzL2FkZHJlc3NlcyB0aGUKICAgIC8vIGNsaWVudCBzcGVjaWZpZXMgaGVyZSBpcyByZWdpc3RlcmVkIG9uIHRoZSBzZXJ2ZXIuIE9uY2UgYW55IG1lc3NhZ2UgaXMgc2VudCB0bwogICAgLy8gdGhhdCBhZGRyZXNzL2FkZHJlc3NlcywgdGhlIGNsaWVudCByZWNlaXZlcyB0aGF0IG1lc3NhZ2UuCiAgICBTVUJTQ1JJQkU6IDAsCgogICAgLy8gVGhpcyBpcyB1c2VkIHRvIHVuc3Vic2NyaWJlIHRvIGFkZHJlc3MgLyBhZGRyZXNzZXMuIE9uY2UgdGhlIGNsaWVudCB1bnN1YnNjcmliZQogICAgLy8gdG8gYW4gYWRkcmVzcywgaXQgd2lsbCBzdG9wIGdldHRpbmcgbWVzc2FnZXMgc2VudCB0byB0aGF0IGFkZHJlc3MuCiAgICBVTlNVQlNDUklCRTogMSwKCiAgICAvLyBUaGlzIGlzIHVzZWQgdG8gc2VuZCBtZXNzYWdlcyB0byBhcmJpdHJhcnkgYWRkcmVzcy8gYWRkcmVzc2VzLiBNZXNzYWdlcyBjYW4gYmUKICAgIC8vIGFueXRoaW5nIGFuZCBSdW1vciB3aWxsIG5vdCBjYXJlIGFib3V0IHdoYXQgaXMgaW5jbHVkZWQuCiAgICBNRVNTQUdFOiAyLAoKICAgIC8vIFRoaXMgd2lsbCBiZSB0aGUgZmlyc3QgbWVzc2FnZSB0aGF0IHRoZSBjbGllbnQgc2VuZHMgdG8gdGhlIHNlcnZlci4gSXQgaW5jbHVkZXMKICAgIC8vIHRoZSB1bmlxdWVJZCBmb3IgdGhhdCBjbGllbnQgY29ubmVjdGlvbiBhbmQgYSBkaXNjb25uZWN0X25vdGlmeSBhZGRyZXNzIHRoYXQgd2lsbAogICAgLy8gYmUgbm90aWZpZWQgb25jZSB0aGUgY2xpZW50IGRpc2Nvbm5lY3RzLgogICAgQ09OTkVDVDogMywKCiAgICAvLyBUaGlzIHdpbGwgYmUgdGhlIG1lc3NhZ2UgdXNlZCBieSB0aGUgc2VydmVyIHRvIG5vdGlmeSBhbiBhZGRyZXNzIHRoYXQgYSBjbGllbnQgZGlzY29ubmVjdGVkLgogICAgRElTQ09OTkVDVDogNCwKCiAgICAvL0VuaGFuY2VtZW50cyB0byBzdXBwb3J0IEtlZXBhbGl2ZXMKICAgIFBJTkc6IDcsCiAgICBQT05HOiA4LAogICAgU1RBVFVTOiA5CiAgfQp9OwoKfSh0aGlzKSk7CihmdW5jdGlvbihnbG9iYWwpIHsKCnZhciBCVUZGRVJfRFJBSU5fSU5URVJWQUwgPSAxMDAsICAgICAgICAvLyBUaGUgaW50ZXJ2YWwgYmV0d2VlbiBwb2xsaW5nIHRoZSB3ZWJzb2NrZXQncyBzZW5kIGJ1ZmZlcgogICAgQlVGRkVSX0RSQUlOX01BWF9SRVRSSUVTID0gMTAsICAgICAgLy8gVGhlIHRvdGFsIG51bWJlciBvZiB0aW1lcyB0byByZXRlc3QgdGhlIHdlYnNvY2tldCdzIHNlbmQgYnVmZmVyCiAgICBXRUJfU09DS0VUX0tFRVBfQUxJVkVfSU5URVJWQUwgPSA1MDAwLAoKICAgIC8vIE1hZ2ljIENvbm5lY3Rpdml0eSBUaW1lb3V0IENvbnN0YW50OiBXZSB3YWl0IDMqdGhlIGtlZXAgYWxpdmUgaW50ZXJ2YWwsCiAgICAvLyBvbiB0aGUgdGhpcmQga2VlcCBhbGl2ZSB3ZSB0cmlnZ2VyIHRoZSB0aW1lb3V0IGlmIHdlIGhhdmVuJ3QgcmVjZWl2ZWQgdGhlCiAgICAvLyBzZXJ2ZXIgcG9uZy4KICAgIFdFQl9TT0NLRVRfQ09OTkVDVElWSVRZX1RJTUVPVVQgPSAzKldFQl9TT0NLRVRfS0VFUF9BTElWRV9JTlRFUlZBTCAtIDEwMAoKCgovLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvQ2xvc2VFdmVudCNDbG9zZV9jb2RlcwovLyBodHRwOi8vZG9jcy5vcmFjbGUuY29tL2phdmFlZS83L2FwaS9qYXZheC93ZWJzb2NrZXQvQ2xvc2VSZWFzb24uQ2xvc2VDb2Rlcy5odG1sCnZhciB3c0Nsb3NlRXJyb3JDb2RlcyA9IHsKICAxMDAyOiAgIlRoZSBlbmRwb2ludCBpcyB0ZXJtaW5hdGluZyB0aGUgY29ubmVjdGlvbiBkdWUgdG8gYSBwcm90b2NvbCBlcnJvci4gKENMT1NFX1BST1RPQ09MX0VSUk9SKSIsCiAgMTAwMzogICJUaGUgY29ubmVjdGlvbiBpcyBiZWluZyB0ZXJtaW5hdGVkIGJlY2F1c2UgdGhlIGVuZHBvaW50IHJlY2VpdmVkIGRhdGEgb2YgYSB0eXBlIGl0IGNhbm5vdCBhY2NlcHQgKGZvciBleGFtcGxlLCBhIHRleHQtb25seSBlbmRwb2ludCByZWNlaXZlZCBiaW5hcnkgZGF0YSkuIChDTE9TRV9VTlNVUFBPUlRFRCkiLAogIDEwMDQ6ICAiVGhlIGVuZHBvaW50IGlzIHRlcm1pbmF0aW5nIHRoZSBjb25uZWN0aW9uIGJlY2F1c2UgYSBkYXRhIGZyYW1lIHdhcyByZWNlaXZlZCB0aGF0IGlzIHRvbyBsYXJnZS4gKENMT1NFX1RPT19MQVJHRSkiLAogIDEwMDU6ICAiSW5kaWNhdGVzIHRoYXQgbm8gc3RhdHVzIGNvZGUgd2FzIHByb3ZpZGVkIGV2ZW4gdGhvdWdoIG9uZSB3YXMgZXhwZWN0ZWQuIChDTE9TRV9OT19TVEFUVVMpIiwKICAxMDA2OiAgIlVzZWQgdG8gaW5kaWNhdGUgdGhhdCBhIGNvbm5lY3Rpb24gd2FzIGNsb3NlZCBhYm5vcm1hbGx5ICh0aGF0IGlzLCB3aXRoIG5vIGNsb3NlIGZyYW1lIGJlaW5nIHNlbnQpIHdoZW4gYSBzdGF0dXMgY29kZSBpcyBleHBlY3RlZC4gKENMT1NFX0FCTk9STUFMKSIsCiAgMTAwNzogIkluZGljYXRlcyB0aGF0IGFuIGVuZHBvaW50IGlzIHRlcm1pbmF0aW5nIHRoZSBjb25uZWN0aW9uIGJlY2F1c2UgaXQgaGFzIHJlY2VpdmVkIGRhdGEgd2l0aGluIGEgbWVzc2FnZSB0aGF0IHdhcyBub3QgY29uc2lzdGVudCB3aXRoIHRoZSB0eXBlIG9mIHRoZSBtZXNzYWdlIChlLmcuLCBub24tVVRGLTggW1JGQzM2MjldIGRhdGEgd2l0aGluIGEgdGV4dCBtZXNzYWdlKSIsCiAgMTAwODogIkluZGljYXRlcyB0aGF0IGFuIGVuZHBvaW50IGlzIHRlcm1pbmF0aW5nIHRoZSBjb25uZWN0aW9uIGJlY2F1c2UgaXQgaGFzIHJlY2VpdmVkIGEgbWVzc2FnZSB0aGF0IHZpb2xhdGVzIGl0cyBwb2xpY3kuICBUaGlzIGlzIGEgZ2VuZXJpYyBzdGF0dXMgY29kZSB0aGF0IGNhbiBiZSByZXR1cm5lZCB3aGVuIHRoZXJlIGlzIG5vIG90aGVyIG1vcmUgc3VpdGFibGUgc3RhdHVzIGNvZGUgKGUuZy4sIDEwMDMgb3IgMTAwOSkgb3IgaWYgdGhlcmUgaXMgYSBuZWVkIHRvIGhpZGUgc3BlY2lmaWMgZGV0YWlscyBhYm91dCB0aGUgcG9saWN5IiwKICAxMDA5OiAiSW5kaWNhdGVzIHRoYXQgYW4gZW5kcG9pbnQgaXMgdGVybWluYXRpbmcgdGhlIGNvbm5lY3Rpb24gYmVjYXVzZSBpdCBoYXMgcmVjZWl2ZWQgYSBtZXNzYWdlIHRoYXQgaXMgdG9vIGJpZyBmb3IgaXQgdG8gcHJvY2VzcyIsCiAgMTAxMTogIkluZGljYXRlcyB0aGF0IGEgc2VydmVyIGlzIHRlcm1pbmF0aW5nIHRoZSBjb25uZWN0aW9uIGJlY2F1c2UgaXQgZW5jb3VudGVyZWQgYW4gdW5leHBlY3RlZCBjb25kaXRpb24gdGhhdCBwcmV2ZW50ZWQgaXQgZnJvbSBmdWxmaWxsaW5nIHRoZSByZXF1ZXN0IiwKCiAgLy8gLi4uLiBjb2RlcyBpbiB0aGUgNDAwMC00OTk5IHJhbmdlIGFyZSBhdmFpbGFibGUgZm9yIHVzZSBieSBhcHBsaWNhdGlvbnMuCiAgNDAwMTogICAiQ29ubmVjdGl2aXR5IGxvc3Mgd2FzIGRldGVjdGVkIGFzIGl0IHdhcyB0b28gbG9uZyBzaW5jZSB0aGUgc29ja2V0IHJlY2VpdmVkIHRoZSBsYXN0IFBPTkcgbWVzc2FnZSIKfTsKCk9ULlJ1bW9yLlNvY2tldEVycm9yID0gZnVuY3Rpb24oY29kZSwgbWVzc2FnZSkgewogIHRoaXMuY29kZSA9IGNvZGU7CiAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKfTsKCi8vIFRoZSBOYXRpdmVTb2NrZXQgYml0IGlzIHB1cmVseSB0byBtYWtlIHRlc3Rpbmcgc2ltcGxlciwgaXQgZGVmYXVsdHMgdG8gV2ViU29ja2V0Ci8vIHNvIGluIG5vcm1hbCBvcGVyYXRpb24geW91IHdvdWxkIG9taXQgaXQuCk9ULlJ1bW9yLlNvY2tldCA9IGZ1bmN0aW9uKG1lc3NhZ2luZ1NlcnZlciwgbm90aWZ5RGlzY29ubmVjdEFkZHJlc3MsIE5hdGl2ZVNvY2tldCkgewogIHZhciBzZXJ2ZXIgPSBtZXNzYWdpbmdTZXJ2ZXIsCiAgICAgIHdlYlNvY2tldCwKICAgICAgaWQsCiAgICAgIG9uT3BlbiwKICAgICAgb25FcnJvciwKICAgICAgb25DbG9zZSwKICAgICAgb25NZXNzYWdlLAogICAgICBjb25uZWN0Q2FsbGJhY2ssCiAgICAgIGJ1ZmZlckRyYWluVGltZW91dCwgICAgICAgICAgIC8vIFRpbWVyIHRvIHBvbGwgd2hldGhlciB0aCBzZW5kIGJ1ZmZlciBoYXMgYmVlbiBkcmFpbmVkCiAgICAgIGNvbm5lY3RUaW1lb3V0LAogICAgICBsYXN0TWVzc2FnZVRpbWVzdGFtcCwgICAgICAgICAvLyBUaGUgdGltZXN0YW1wIG9mIHRoZSBsYXN0IG1lc3NhZ2UgcmVjZWl2ZWQKICAgICAga2VlcEFsaXZlVGltZXI7ICAgICAgICAgICAgICAgLy8gVGltZXIgZm9yIHRoZSBjb25uZWN0aXZpdHkgY2hlY2tzCgoKICAvLy8vIFByaXZhdGUgQVBJCiAgdmFyIHN0YXRlQ2hhbmdlZCA9IGZ1bmN0aW9uKG5ld1N0YXRlKSB7CiAgICAgICAgc3dpdGNoIChuZXdTdGF0ZSkgewogICAgICAgICAgY2FzZSAnZGlzY29ubmVjdGVkJzoKICAgICAgICAgIGNhc2UgJ2Vycm9yJzoKICAgICAgICAgICAgd2ViU29ja2V0ID0gbnVsbDsKICAgICAgICAgICAgaWYgKG9uQ2xvc2UpIHsKICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgaWYoaGFzTG9zdENvbm5lY3Rpdml0eSgpKSB7CiAgICAgICAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcih3c0Nsb3NlRXJyb3JDb2Rlc1s0MDAxXSk7CiAgICAgICAgICAgICAgICBlcnJvci5jb2RlID0gNDAwMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb25DbG9zZShlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgc2V0U3RhdGUgPSBPVC4kLnN0YXRhYmxlKHRoaXMsIFsnZGlzY29ubmVjdGVkJywgICdlcnJvcicsICdjb25uZWN0ZWQnLCAnY29ubmVjdGluZycsICdkaXNjb25uZWN0aW5nJ10sICdkaXNjb25uZWN0ZWQnLCBzdGF0ZUNoYW5nZWQpLAoKICAgICAgdmFsaWRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uIHZhbGlkYXRlQ2FsbGJhY2sgKG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrID09PSBudWxsIHx8ICFPVC4kLmlzRnVuY3Rpb24oY2FsbGJhY2spICkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgUnVtb3IuU29ja2V0ICIgKyBuYW1lICsgIiBjYWxsYmFjayBtdXN0IGJlIGEgdmFsaWQgZnVuY3Rpb24gb3IgbnVsbCIpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIGVycm9yID0gZnVuY3Rpb24gZXJyb3IgKGVycm9yTWVzc2FnZSkgewogICAgICAgIE9ULmVycm9yKCJSdW1vci5Tb2NrZXQ6ICIgKyBlcnJvck1lc3NhZ2UpOwoKICAgICAgICB2YXIgZXJyb3IgPSBuZXcgT1QuUnVtb3IuU29ja2V0RXJyb3IobnVsbCwgZXJyb3JNZXNzYWdlIHx8ICJVbmtub3duIFNvY2tldCBFcnJvciIpOwoKICAgICAgICBpZiAoY29ubmVjdFRpbWVvdXQpIGNsZWFyVGltZW91dChjb25uZWN0VGltZW91dCk7CgogICAgICAgIHNldFN0YXRlKCdlcnJvcicpOwoKICAgICAgICBpZiAodGhpcy5wcmV2aW91c1N0YXRlID09PSAnY29ubmVjdGluZycgJiYgY29ubmVjdENhbGxiYWNrKSB7CiAgICAgICAgICBjb25uZWN0Q2FsbGJhY2soZXJyb3IsIG51bGwpOwogICAgICAgICAgY29ubmVjdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChvbkVycm9yKSBvbkVycm9yKGVycm9yKTsKICAgICAgfS5iaW5kKHRoaXMpLAoKICAgICAgLy8gSW1tZWRpYXRlbHkgY2xvc2UgdGhlIHNvY2tldCwgb25seSB1c2VkIGJ5IGRpc2Nvbm5lY3RXaGVuU2VuZEJ1ZmZlcklzRHJhaW5lZAogICAgICBjbG9zZSA9IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICAgIHNldFN0YXRlKCdkaXNjb25uZWN0aW5nJyk7CgogICAgICAgIGlmIChidWZmZXJEcmFpblRpbWVvdXQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dChidWZmZXJEcmFpblRpbWVvdXQpOwogICAgICAgICAgYnVmZmVyRHJhaW5UaW1lb3V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgY29uc29sZS5pbmZvKCJDQUxMRUQgQ0xPU0UgT04gV0VCU09DS0VUIik7CiAgICAgICAgd2ViU29ja2V0LmNsb3NlKCk7CiAgICAgIH0sCgogICAgICAvLyBFbnN1cmUgdGhhdCB0aGUgV2ViU29ja2V0IHNlbmQgYnVmZmVyIGlzIGZ1bGx5IGRyYWluZWQgYmVmb3JlIGRpc2Nvbm5lY3RpbmcKICAgICAgLy8gdGhlIHNvY2tldC4gSWYgdGhlIGJ1ZmZlciBkb2Vzbid0IGRyYWluIGFmdGVyIGEgY2VydGFpbiBsZW5ndGggb2YgdGltZQogICAgICAvLyB3ZSBnaXZlIHVwIGFuZCBjbG9zZSBpdCBhbnl3YXkuCiAgICAgIGRpc2Nvbm5lY3RXaGVuU2VuZEJ1ZmZlcklzRHJhaW5lZCA9IGZ1bmN0aW9uIGRpc2Nvbm5lY3RXaGVuU2VuZEJ1ZmZlcklzRHJhaW5lZCAoYnVmZmVyRHJhaW5SZXRyaWVzKSB7CiAgICAgICAgaWYgKCF3ZWJTb2NrZXQpIHJldHVybjsKCiAgICAgICAgaWYgKGJ1ZmZlckRyYWluUmV0cmllcyA9PT0gdm9pZCAwKSBidWZmZXJEcmFpblJldHJpZXMgPSAwOwogICAgICAgIGlmIChidWZmZXJEcmFpblRpbWVvdXQpIGNsZWFyVGltZW91dChidWZmZXJEcmFpblRpbWVvdXQpOwoKICAgICAgICBpZiAod2ViU29ja2V0LmJ1ZmZlcmVkQW1vdW50ID4gMCAmJiAoYnVmZmVyRHJhaW5SZXRyaWVzICsgMSkgPD0gQlVGRkVSX0RSQUlOX01BWF9SRVRSSUVTKSB7CiAgICAgICAgICBidWZmZXJEcmFpblRpbWVvdXQgPSBzZXRUaW1lb3V0KGRpc2Nvbm5lY3RXaGVuU2VuZEJ1ZmZlcklzRHJhaW5lZCwgQlVGRkVSX0RSQUlOX0lOVEVSVkFMLCBidWZmZXJEcmFpblJldHJpZXMrMSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgY2xvc2UoKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBoYXNMb3N0Q29ubmVjdGl2aXR5ID0gZnVuY3Rpb24gaGFzTG9zdENvbm5lY3Rpdml0eSAoKSB7CiAgICAgICAgaWYgKCFsYXN0TWVzc2FnZVRpbWVzdGFtcCkgcmV0dXJuIGZhbHNlOwoKICAgICAgICByZXR1cm4gKE9ULiQubm93KCkgLSBsYXN0TWVzc2FnZVRpbWVzdGFtcCkgPj0gV0VCX1NPQ0tFVF9DT05ORUNUSVZJVFlfVElNRU9VVDsKICAgICAgfSwKCiAgICAgIHNlbmRLZWVwQWxpdmUgPSBmdW5jdGlvbiBzZW5kS2VlcEFsaXZlICgpIHsKICAgICAgICBpZiAoIXRoaXMuaXMoJ2Nvbm5lY3RlZCcpKSByZXR1cm47CgogICAgICAgIGlmICggaGFzTG9zdENvbm5lY3Rpdml0eSgpICkgewogICAgICAgICAgd2ViU29ja2V0RGlzY29ubmVjdGVkKHtjb2RlOiA0MDAxfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgIHsKICAgICAgICAgIHdlYlNvY2tldC5zZW5kKE9ULlJ1bW9yLk1lc3NhZ2UuUGluZygpLnNlcmlhbGl6ZSgpKTsKICAgICAgICAgIGtlZXBBbGl2ZVRpbWVyID0gc2V0VGltZW91dChzZW5kS2VlcEFsaXZlLmJpbmQodGhpcyksIFdFQl9TT0NLRVRfS0VFUF9BTElWRV9JTlRFUlZBTCk7CiAgICAgICAgfQogICAgICB9LmJpbmQodGhpcyk7CgoKICAvLy8vIFByaXZhdGUgRXZlbnQgSGFuZGxlcnMKICB2YXIgd2ViU29ja2V0Q29ubmVjdGVkID0gZnVuY3Rpb24gd2ViU29ja2V0Q29ubmVjdGVkICgpIHsKICAgICAgICBpZiAoY29ubmVjdFRpbWVvdXQpIGNsZWFyVGltZW91dChjb25uZWN0VGltZW91dCk7CgogICAgICAgIC8vIENvbm5lY3QgdG8gUnVtb3IgYnkgcmVnaXN0ZXJpbmcgb3VyIGNvbm5lY3Rpb24gaWQgYW5kIHRoZQogICAgICAgIC8vIGFwcCBzZXJ2ZXIgYWRkcmVzcyB0byBub3RpZnkgaWYgd2UgZGlzY29ubmVjdC4KICAgICAgICAvLwogICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gd2FpdCBmb3IgYSByZXBseSB0byB0aGlzIG1lc3NhZ2UuCiAgICAgICAgd2ViU29ja2V0LnNlbmQoT1QuUnVtb3IuTWVzc2FnZS5Db25uZWN0KGlkLCBub3RpZnlEaXNjb25uZWN0QWRkcmVzcykuc2VyaWFsaXplKCkpOwoKICAgICAgICBzZXRTdGF0ZSgnY29ubmVjdGVkJyk7CiAgICAgICAgaWYgKGNvbm5lY3RDYWxsYmFjaykgewogICAgICAgICAgY29ubmVjdENhbGxiYWNrKG51bGwsIGlkKTsKICAgICAgICAgIGNvbm5lY3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAob25PcGVuKSBvbk9wZW4oaWQpOwoKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgbGFzdE1lc3NhZ2VUaW1lc3RhbXAgPSBPVC4kLm5vdygpOwogICAgICAgICAgc2VuZEtlZXBBbGl2ZSgpOwogICAgICAgIH0sIFdFQl9TT0NLRVRfS0VFUF9BTElWRV9JTlRFUlZBTCk7CiAgICAgIH0sCgogICAgICB3ZWJTb2NrZXRDb25uZWN0VGltZWRPdXQgPSBmdW5jdGlvbiB3ZWJTb2NrZXRDb25uZWN0VGltZWRPdXQgKCkgewogICAgICAgIGVycm9yKCJUaW1lZCBvdXQgd2hpbGUgd2FpdGluZyBmb3IgdGhlIFJ1bW9yIHNvY2tldCB0byBjb25uZWN0LiIpOwogICAgICB9LAoKICAgICAgd2ViU29ja2V0RXJyb3IgPSBmdW5jdGlvbiB3ZWJTb2NrZXRFcnJvciAoZXJyb3JFdmVudCkgewogICAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSAiVW5rbm93biBTb2NrZXQgRXJyb3IiOyAgICAgIC8vIEBmaXhtZSBXZSBNVVNUIGJlIGFibGUgdG8gZG8gYmV0dGVyIHRoYW4gdGhpcyEKCiAgICAgICAgLy8gQWxsIGVycm9ycyBzZWVtIHRvIHJlc3VsdCBpbiBkaXNjb25uZWN0aW5nIHRoZSBzb2NrZXQsIHRoZSBjbG9zZSBldmVudAogICAgICAgIC8vIGhhcyBhIGNsb3NlIHJlYXNvbiBhbmQgY29kZSB3aGljaCBnaXZlcyBzb21lIGVycm9yIGNvbnRleHQuIFRoaXMsCiAgICAgICAgLy8gY29tYmluZWQgd2l0aCB0aGUgZmFjdCB0aGF0IHRoZSBlcnJvckV2ZW50IGFyZ3VtZW50IGNvbnRhaW5zIG5vCiAgICAgICAgLy8gZXJyb3IgaW5mbyBhdCBhbGwsIG1lYW5zIHdlJ2xsIGRlbGF5IHRyaWdnZXJpbmcgdGhlIGVycm9yIGhhbmRsZXJzCiAgICAgICAgLy8gdW50aWwgdGhlIHNvY2tldCBpcyBjbG9zZWQuCiAgICAgICAgLy8gZXJyb3IoZXJyb3JNZXNzYWdlKTsKICAgICAgfSwKCiAgICAgIHdlYlNvY2tldERpc2Nvbm5lY3RlZCA9IGZ1bmN0aW9uIHdlYlNvY2tldERpc2Nvbm5lY3RlZCAoY2xvc2VFdmVudCkgewogICAgICAgIGlmIChjb25uZWN0VGltZW91dCkgY2xlYXJUaW1lb3V0KGNvbm5lY3RUaW1lb3V0KTsKICAgICAgICBpZiAoa2VlcEFsaXZlVGltZXIpIGNsZWFyVGltZW91dChrZWVwQWxpdmVUaW1lcik7CgogICAgICAgIGlmIChjbG9zZUV2ZW50LmNvZGUgIT09IDEwMDAgJiYgY2xvc2VFdmVudC5jb2RlICE9PSAxMDAxKSB7CiAgICAgICAgICB2YXIgcmVhc29uID0gY2xvc2VFdmVudC5yZWFzb24gfHwgY2xvc2VFdmVudC5tZXNzYWdlOwogICAgICAgICAgaWYgKCFyZWFzb24gJiYgd3NDbG9zZUVycm9yQ29kZXMuaGFzT3duUHJvcGVydHkoY2xvc2VFdmVudC5jb2RlKSkgcmVhc29uID0gd3NDbG9zZUVycm9yQ29kZXNbY2xvc2VFdmVudC5jb2RlXTsKCiAgICAgICAgICBlcnJvcigiUnVtb3IgU29ja2V0IERpc2Nvbm5lY3RlZDogIiArIHJlYXNvbik7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5pc05vdCgnZXJyb3InKSkgc2V0U3RhdGUoJ2Rpc2Nvbm5lY3RlZCcpOwogICAgICB9LmJpbmQodGhpcyksCgogICAgICB3ZWJTb2NrZXRSZWNlaXZlZE1lc3NhZ2UgPSBmdW5jdGlvbiB3ZWJTb2NrZXRSZWNlaXZlZE1lc3NhZ2UgKG1lc3NhZ2UpIHsKICAgICAgICBsYXN0TWVzc2FnZVRpbWVzdGFtcCA9IE9ULiQubm93KCk7CgogICAgICAgIGlmIChvbk1lc3NhZ2UpIHsKICAgICAgICAgIHZhciBtc2cgPSBPVC5SdW1vci5NZXNzYWdlLmRlc2VyaWFsaXplKG1lc3NhZ2UuZGF0YSk7CgogICAgICAgICAgaWYgKG1zZy50eXBlICE9PSBPVC5SdW1vci5NZXNzYWdlVHlwZS5QT05HKSB7CiAgICAgICAgICAgIG9uTWVzc2FnZShtc2cudG9BZGRyZXNzLCBtc2cuZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKCiAgLy8vLyBQdWJsaWMgQVBJCgogIHRoaXMucHVibGlzaCA9IGZ1bmN0aW9uICh0b3BpY3MsIG1lc3NhZ2UpIHsKICAgIHdlYlNvY2tldC5zZW5kKE9ULlJ1bW9yLk1lc3NhZ2UuUHVibGlzaCh0b3BpY3MsIG1lc3NhZ2UpLnNlcmlhbGl6ZSgpKTsKICB9OwoKICB0aGlzLnN1YnNjcmliZSA9IGZ1bmN0aW9uKHRvcGljcykgewogICAgd2ViU29ja2V0LnNlbmQoT1QuUnVtb3IuTWVzc2FnZS5TdWJzY3JpYmUodG9waWNzKS5zZXJpYWxpemUoKSk7CiAgfTsKCiAgdGhpcy51bnN1YnNjcmliZSA9IGZ1bmN0aW9uKHRvcGljcykgewogICAgd2ViU29ja2V0LnNlbmQoT1QuUnVtb3IuTWVzc2FnZS5VbnN1YnNjcmliZSh0b3BpY3MpLnNlcmlhbGl6ZSgpKTsKICB9OwoKICB0aGlzLmNvbm5lY3QgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkLCBjb21wbGV0ZSkgewogICAgaWYgKHRoaXMuaXMoJ2Nvbm5lY3RpbmcnLCAnY29ubmVjdGVkJykpIHsKICAgICAgY29tcGxldGUobnVsbCwgIlJ1bW9yLlNvY2tldCBjYW5ub3QgY29ubmVjdCB3aGVuIGl0IGlzIGFscmVhZHkgY29ubmVjdGluZyBvciBjb25uZWN0ZWQuIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZCA9IGNvbm5lY3Rpb25JZDsKICAgIGNvbm5lY3RDYWxsYmFjayA9IGNvbXBsZXRlOwoKICAgIHRyeSB7CiAgICAgIHNldFN0YXRlKCdjb25uZWN0aW5nJyk7CgogICAgICB3ZWJTb2NrZXQgPSBuZXcgKE5hdGl2ZVNvY2tldCB8fCBXZWJTb2NrZXQpKHNlcnZlcik7CiAgICAgIHdlYlNvY2tldC5iaW5hcnlUeXBlID0gJ2FycmF5YnVmZmVyJzsKCiAgICAgIHdlYlNvY2tldC5vbm9wZW4gPSB3ZWJTb2NrZXRDb25uZWN0ZWQ7CiAgICAgIHdlYlNvY2tldC5vbmNsb3NlID0gd2ViU29ja2V0RGlzY29ubmVjdGVkOwogICAgICB3ZWJTb2NrZXQub25lcnJvciA9IHdlYlNvY2tldEVycm9yOwogICAgICB3ZWJTb2NrZXQub25tZXNzYWdlID0gd2ViU29ja2V0UmVjZWl2ZWRNZXNzYWdlOwoKICAgICAgY29ubmVjdFRpbWVvdXQgPSBzZXRUaW1lb3V0KHdlYlNvY2tldENvbm5lY3RUaW1lZE91dCwgT1QuUnVtb3IuU29ja2V0LkNPTk5FQ1RfVElNRU9VVCk7CiAgICB9CiAgICBjYXRjaChlKSB7CiAgICAgIE9ULmVycm9yKGUpOwoKICAgICAgLy8gQHRvZG8gYWRkIGFuIGFjdHVhbCBlcnJvciBtZXNzYWdlCiAgICAgIGVycm9yKCJDb3VsZCBub3QgY29ubmVjdCB0byB0aGUgUnVtb3Igc29ja2V0LCBwb3NzaWJseSBiZWNhdXNlIG9mIGEgYmxvY2tlZCBwb3J0LiIpCiAgICB9CiAgfTsKCiAgdGhpcy5kaXNjb25uZWN0ID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoY29ubmVjdFRpbWVvdXQpIGNsZWFyVGltZW91dChjb25uZWN0VGltZW91dCk7CiAgICBpZiAoa2VlcEFsaXZlVGltZXIpIGNsZWFyVGltZW91dChrZWVwQWxpdmVUaW1lcik7CgogICAgaWYgKCF3ZWJTb2NrZXQpIHsKICAgICAgaWYgKHRoaXMuaXNOb3QoJ2Vycm9yJykpIHNldFN0YXRlKCdkaXNjb25uZWN0ZWQnKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh3ZWJTb2NrZXQucmVhZHlTdGF0ZSA9PT0gMy8qIENMT1NFRCAqLykgewogICAgICBpZiAodGhpcy5pc05vdCgnZXJyb3InKSkgc2V0U3RhdGUoJ2Rpc2Nvbm5lY3RlZCcpOwogICAgfQogICAgZWxzZSB7CiAgICAgIGlmICh0aGlzLmlzKCdjb25uZWN0ZWQnKSkgewogICAgICAgIC8vIExvb2shIFdlIGFyZSBuaWNlIHRvIHRoZSBydW1vciBzZXJ2ZXIgOy0pCiAgICAgICAgd2ViU29ja2V0LnNlbmQoT1QuUnVtb3IuTWVzc2FnZS5EaXNjb25uZWN0KCkuc2VyaWFsaXplKCkpOwogICAgICB9CgogICAgICAvLyBXYWl0IHVudGlsIHRoZSBzb2NrZXQgaXMgcmVhZHkgdG8gY2xvc2UKICAgICAgZGlzY29ubmVjdFdoZW5TZW5kQnVmZmVySXNEcmFpbmVkKCk7CiAgICB9CiAgfTsKCgoKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICBpZDogewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gaWQ7IH0KICAgIH0sCgogICAgb25PcGVuOiB7CiAgICAgIHNldDogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YWxpZGF0ZUNhbGxiYWNrKCdvbk9wZW4nLCBjYWxsYmFjayk7CiAgICAgICAgb25PcGVuID0gY2FsbGJhY2s7CiAgICAgIH0sCgogICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gb25PcGVuOyB9CiAgICB9LAoKICAgIG9uRXJyb3I6IHsKICAgICAgc2V0OiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIHZhbGlkYXRlQ2FsbGJhY2soJ29uRXJyb3InLCBjYWxsYmFjayk7CiAgICAgICAgb25FcnJvciA9IGNhbGxiYWNrOwogICAgICB9LAoKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG9uRXJyb3I7IH0KICAgIH0sCgogICAgb25DbG9zZTogewogICAgICBzZXQ6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFsaWRhdGVDYWxsYmFjaygnb25DbG9zZScsIGNhbGxiYWNrKTsKICAgICAgICBvbkNsb3NlID0gY2FsbGJhY2s7CiAgICAgIH0sCgogICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gb25DbG9zZTsgfQogICAgfSwKCiAgICBvbk1lc3NhZ2U6IHsKICAgICAgc2V0OiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIHZhbGlkYXRlQ2FsbGJhY2soJ29uTWVzc2FnZScsIGNhbGxiYWNrKTsKICAgICAgICBvbk1lc3NhZ2UgPSBjYWxsYmFjazsKICAgICAgfSwKCiAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBvbk1lc3NhZ2U7IH0KICAgIH0KICB9KTsKfTsKCi8vIFRoZSBudW1iZXIgb2YgbXMgdG8gd2FpdCBmb3IgdGhlIHdlYnNvY2tldCB0byBjb25uZWN0Ck9ULlJ1bW9yLlNvY2tldC5DT05ORUNUX1RJTUVPVVQgPSAxNTAwMDsKCn0odGhpcykpOwooZnVuY3Rpb24oZ2xvYmFsKSB7CgovLwovLwovLyBAcmVmZXJlbmNlcwovLyAqIGh0dHBzOi8vdGJ3aWtpLnRva2JveC5jb20vaW5kZXgucGhwL1J1bW9yX01lc3NhZ2VfUGFja2V0Ci8vICogaHR0cHM6Ly90Yndpa2kudG9rYm94LmNvbS9pbmRleC5waHAvUnVtb3JfUHJvdG9jb2wKLy8KT1QuUnVtb3IuTWVzc2FnZSA9IGZ1bmN0aW9uICh0eXBlLCB0b0FkZHJlc3MsIGhlYWRlcnMsIGRhdGEpIHsKICB0aGlzLnR5cGUgPSB0eXBlOwogIHRoaXMudG9BZGRyZXNzID0gdG9BZGRyZXNzOwogIHRoaXMuaGVhZGVycyA9IGhlYWRlcnM7CiAgdGhpcy5kYXRhID0gZGF0YTsKfTsKCgpPVC5SdW1vci5NZXNzYWdlLnByb3RvdHlwZS5zZXJpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIGJpdFN0cmVhbSA9ICcnLAogICAgICBzdHIgPSAiIiwKICAgICAgb2Zmc2V0ID0gOCwKICAgICAgY0J1ZiA9IDcsCiAgICAgIGFkZHJlc3MgPSBuZXcgQXJyYXkodGhpcy50b0FkZHJlc3MubGVuZ3RoKSwKICAgICAgaGVhZGVyS2V5ID0gbmV3IEFycmF5KHRoaXMuaGVhZGVycy5sZW5ndGgpLAogICAgICBoZWFkZXJWYWwgPSBuZXcgQXJyYXkodGhpcy5oZWFkZXJzLmxlbmd0aCksCiAgICAgIGRhdGFWaWV3OwoKICAvLyBUaGUgbnVtYmVyIG9mIGFkZHJlc3NlcwogIGNCdWYrKzsKCiAgLy8gV3JpdGUgb3V0IHRoZSBhZGRyZXNzLgogIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50b0FkZHJlc3MubGVuZ3RoOyBpKyspIHsKICAgIGFkZHJlc3NbaV0gPSBUZXh0RW5jb2RlcigndXRmLTgnKS5lbmNvZGUodGhpcy50b0FkZHJlc3NbaV0pOwogICAgY0J1ZiArPSAyOwogICAgY0J1ZiArPSBhZGRyZXNzW2ldLmxlbmd0aDsKICB9CgogIC8vIFRoZSBudW1iZXIgb2YgcGFyYW1ldGVycwogIGNCdWYrKzsKCiAgLy8gV3JpdGUgb3V0IHRoZSBwYXJhbXMKICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaGVhZGVycy5sZW5ndGg7IGkrKykgewogICAgaGVhZGVyS2V5W2ldID0gVGV4dEVuY29kZXIoJ3V0Zi04JykuZW5jb2RlKHRoaXMuaGVhZGVyc1tpXS5rZXkpOwogICAgaGVhZGVyVmFsW2ldID0gVGV4dEVuY29kZXIoJ3V0Zi04JykuZW5jb2RlKHRoaXMuaGVhZGVyc1tpXS52YWwpOwogICAgY0J1ZiArPSA0OwogICAgY0J1ZiArPSBoZWFkZXJLZXlbaV0ubGVuZ3RoOwogICAgY0J1ZiArPSBoZWFkZXJWYWxbaV0ubGVuZ3RoOwogIH0KCiAgZGF0YVZpZXcgPSBUZXh0RW5jb2RlcigndXRmLTgnKS5lbmNvZGUodGhpcy5kYXRhKTsKICBjQnVmICs9IGRhdGFWaWV3Lmxlbmd0aDsKCiAgLy8gTGV0J3MgYWxsb2NhdGUgYSBiaW5hcnkgYmxvYiBvZiB0aGlzIHNpemUKICB2YXIgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGNCdWYpOwogIHZhciB1aW50OFZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIsIDAsIGNCdWYpOwoKICAvLyBXZSBkb24ndCBpbmNsdWRlIHRoZSBoZWFkZXIgaW4gdGhlIGxlbmdodC4KICBjQnVmIC09IDQ7CgogIC8vIFdyaXRlIG91dCBzaXplIChpbiBuZXR3b3JrIG9yZGVyKQogIHVpbnQ4Vmlld1swXSA9IChjQnVmICYgMHhGRjAwMDAwMCkgPj4+IDI0OwogIHVpbnQ4Vmlld1sxXSA9IChjQnVmICYgMHgwMEZGMDAwMCkgPj4+IDE2OwogIHVpbnQ4Vmlld1syXSA9IChjQnVmICYgMHgwMDAwRkYwMCkgPj4+ICA4OwogIHVpbnQ4Vmlld1szXSA9IChjQnVmICYgMHgwMDAwMDBGRikgPj4+ICAwOwoKICAvLyBXcml0ZSBvdXQgcmVzZXJ2ZWQgYnl0ZXMKICB1aW50OFZpZXdbNF0gPSAwOwogIHVpbnQ4Vmlld1s1XSA9IDA7CgogIC8vIFdyaXRlIG91dCBtZXNzYWdlIHR5cGUKICB1aW50OFZpZXdbNl0gPSB0aGlzLnR5cGU7CiAgdWludDhWaWV3WzddID0gdGhpcy50b0FkZHJlc3MubGVuZ3RoOwoKICAvLyBOb3cganVzdCBjb3B5IG92ZXIgdGhlIGVuY29kZWQgdmFsdWVzLi4KICBmb3IgKHZhciBpID0gMDsgaSA8IGFkZHJlc3MubGVuZ3RoOyBpKyspIHsKICAgIHN0ckFycmF5ID0gYWRkcmVzc1tpXTsKICAgIHVpbnQ4Vmlld1tvZmZzZXQrK10gPSBzdHJBcnJheS5sZW5ndGggPj4gOCAmIDB4RkY7CiAgICB1aW50OFZpZXdbb2Zmc2V0KytdID0gc3RyQXJyYXkubGVuZ3RoID4+IDAgJiAweEZGOwogICAgZm9yICh2YXIgaiA9IDA7IGogPCBzdHJBcnJheS5sZW5ndGg7IGorKykgewogICAgICB1aW50OFZpZXdbb2Zmc2V0KytdID0gc3RyQXJyYXlbal07CiAgICB9CiAgfQoKICB1aW50OFZpZXdbb2Zmc2V0KytdID0gaGVhZGVyS2V5Lmxlbmd0aDsKCiAgLy8gV3JpdGUgb3V0IHRoZSBwYXJhbXMKICBmb3IgKHZhciBpID0gMDsgaSA8IGhlYWRlcktleS5sZW5ndGg7IGkrKykgewogICAgc3RyQXJyYXkgPSBoZWFkZXJLZXlbaV07CiAgICB1aW50OFZpZXdbb2Zmc2V0KytdID0gc3RyQXJyYXkubGVuZ3RoID4+IDggJiAweEZGOwogICAgdWludDhWaWV3W29mZnNldCsrXSA9IHN0ckFycmF5Lmxlbmd0aCA+PiAwICYgMHhGRjsKICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3RyQXJyYXkubGVuZ3RoOyBqKyspIHsKICAgICAgdWludDhWaWV3W29mZnNldCsrXSA9IHN0ckFycmF5W2pdOwogICAgfQoKICAgIHN0ckFycmF5ID0gaGVhZGVyVmFsW2ldOwogICAgdWludDhWaWV3W29mZnNldCsrXSA9IHN0ckFycmF5Lmxlbmd0aCA+PiA4ICYgMHhGRjsKICAgIHVpbnQ4Vmlld1tvZmZzZXQrK10gPSBzdHJBcnJheS5sZW5ndGggPj4gMCAmIDB4RkY7CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IHN0ckFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgIHVpbnQ4Vmlld1tvZmZzZXQrK10gPSBzdHJBcnJheVtqXTsKICAgIH0KICB9CgogIC8vIEFuZCBmaW5hbGx5IHRoZSBkYXRhCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhVmlldy5sZW5ndGg7IGkrKykgewogICAgdWludDhWaWV3W29mZnNldCsrXSA9IGRhdGFWaWV3W2ldOwogIH0KCiAgcmV0dXJuIGJ1ZmZlcjsKfTsKCk9ULlJ1bW9yLk1lc3NhZ2UuZGVzZXJpYWxpemUgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgdmFyIGNCdWYgPSAwOwogIHZhciB0eXBlOwogIHZhciBvZmZzZXQgPSA4OwogIHZhciB1aW50OFZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIpOwoKICAvLyBXcml0ZSBvdXQgc2l6ZSAoaW4gbmV0d29yayBvcmRlcikKICBjQnVmICs9IHVpbnQ4Vmlld1swXSA8PCAyNDsKICBjQnVmICs9IHVpbnQ4Vmlld1sxXSA8PCAxNjsKICBjQnVmICs9IHVpbnQ4Vmlld1syXSA8PCAgODsKICBjQnVmICs9IHVpbnQ4Vmlld1szXSA8PCAgMDsKCiAgdHlwZSA9IHVpbnQ4Vmlld1s2XTsKICB2YXIgYWRkcmVzcyA9IFtdOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHVpbnQ4Vmlld1s3XTsgaSsrKSB7CiAgICBsZW5ndGggPSB1aW50OFZpZXdbb2Zmc2V0KytdIDw8IDg7CiAgICBsZW5ndGggKz0gdWludDhWaWV3W29mZnNldCsrXTsKICAgIHZhciBzdHJWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCk7CiAgICBhZGRyZXNzW2ldID0gVGV4dERlY29kZXIoJ3V0Zi04JykuZGVjb2RlKHN0clZpZXcpOwogICAgb2Zmc2V0ICs9IGxlbmd0aDsKICB9CgogIHZhciBoZWFkZXJsZW4gPSB1aW50OFZpZXdbb2Zmc2V0KytdOwogIHZhciBoZWFkZXJzID0gW107CgogIGZvciAodmFyIGkgPSAwOyBpIDwgaGVhZGVybGVuOyBpKyspIHsKICAgIGxlbmd0aCA9IHVpbnQ4Vmlld1tvZmZzZXQrK10gPDwgODsKICAgIGxlbmd0aCArPSB1aW50OFZpZXdbb2Zmc2V0KytdOwogICAgdmFyIHN0clZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIsIG9mZnNldCwgbGVuZ3RoKTsKICAgIHZhciBrZXlTdHIgPSBUZXh0RGVjb2RlcigndXRmLTgnKS5kZWNvZGUoc3RyVmlldyk7CiAgICBvZmZzZXQgKz0gbGVuZ3RoOwoKICAgIGxlbmd0aCA9IHVpbnQ4Vmlld1tvZmZzZXQrK10gPDwgODsKICAgIGxlbmd0aCArPSB1aW50OFZpZXdbb2Zmc2V0KytdOwogICAgc3RyVmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgpOwogICAgdmFyIHZhbFN0ciA9IFRleHREZWNvZGVyKCd1dGYtOCcpLmRlY29kZShzdHJWaWV3KTsKICAgIGhlYWRlcnNbaV0gPSAgeyBrZXkgOiBrZXlTdHIsIHZhbCA6IHZhbFN0ciB9OwogICAgb2Zmc2V0ICs9IGxlbmd0aDsKICB9CgogIHZhciBkYXRhVmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgb2Zmc2V0KTsKICB2YXIgZGF0YSA9IFRleHREZWNvZGVyKCd1dGYtOCcpLmRlY29kZShkYXRhVmlldyk7CgogcmV0dXJuIG5ldyBPVC5SdW1vci5NZXNzYWdlKHR5cGUsIGFkZHJlc3MsIGhlYWRlcnMsIGRhdGEpOwp9OwoKCk9ULlJ1bW9yLk1lc3NhZ2UuQ29ubmVjdCA9IGZ1bmN0aW9uICh1bmlxdWVJZCwgbm90aWZ5RGlzY29ubmVjdEFkZHJlc3MpIHsKICB2YXIgaGVhZGVycyA9IFsKICAgIHtrZXk6ICd1bmlxdWVJZCcsIHZhbDogdW5pcXVlSWR9LAogICAge2tleTogJ25vdGlmeURpc2Nvbm5lY3RBZGRyZXNzJywgdmFsOiBub3RpZnlEaXNjb25uZWN0QWRkcmVzc30KICBdOwoKICByZXR1cm4gbmV3IE9ULlJ1bW9yLk1lc3NhZ2UoT1QuUnVtb3IuTWVzc2FnZVR5cGUuQ09OTkVDVCwgW10sIGhlYWRlcnMsICIiKTsKfTsKCk9ULlJ1bW9yLk1lc3NhZ2UuRGlzY29ubmVjdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gbmV3IE9ULlJ1bW9yLk1lc3NhZ2UoT1QuUnVtb3IuTWVzc2FnZVR5cGUuRElTQ09OTkVDVCwgW10sIFtdLCAiIik7Cn07CgpPVC5SdW1vci5NZXNzYWdlLlN1YnNjcmliZSA9IGZ1bmN0aW9uKHRvcGljcykgewogIHJldHVybiBuZXcgT1QuUnVtb3IuTWVzc2FnZShPVC5SdW1vci5NZXNzYWdlVHlwZS5TVUJTQ1JJQkUsIHRvcGljcywgW10sICIiKTsKfTsKCk9ULlJ1bW9yLk1lc3NhZ2UuVW5zdWJzY3JpYmUgPSBmdW5jdGlvbih0b3BpY3MpIHsKICByZXR1cm4gbmV3IE9ULlJ1bW9yLk1lc3NhZ2UoT1QuUnVtb3IuTWVzc2FnZVR5cGUuVU5TVUJTQ1JJQkUsIHRvcGljcywgW10sICIiKTsKfTsKCk9ULlJ1bW9yLk1lc3NhZ2UuUHVibGlzaCA9IGZ1bmN0aW9uKHRvcGljcywgbWVzc2FnZSwgaGVhZGVycykgewogIHJldHVybiBuZXcgT1QuUnVtb3IuTWVzc2FnZShPVC5SdW1vci5NZXNzYWdlVHlwZS5NRVNTQUdFLCB0b3BpY3MsIFtdLCBtZXNzYWdlKTsKfTsKCi8vIFRoaXMgbWVzc2FnZSBpcyB1c2VkIHRvIGltcGxlbWVudCBrZWVwYWxpdmVzIG9uIHRoZSBwZXJzaXN0ZW50Ci8vIHNvY2tldCBjb25uZWN0aW9uIGJldHdlZW4gdGhlIGNsaWVudCBhbmQgc2VydmVyLiBFdmVyeSB0aW1lIHRoZQovLyBjbGllbnQgc2VuZHMgYSBQSU5HIHRvIHRoZSBzZXJ2ZXIsIHRoZSBzZXJ2ZXIgd2lsbCByZXNwb25kIHdpdGgKLy8gYSBQT05HLgpPVC5SdW1vci5NZXNzYWdlLlBpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IE9ULlJ1bW9yLk1lc3NhZ2UoT1QuUnVtb3IuTWVzc2FnZVR5cGUuUElORywgW10sIFtdLCAiIik7Cn07Cgp9KHRoaXMpKTsKKGZ1bmN0aW9uKGdsb2JhbCkgewoKLy8gUnVtb3IgTWVzc2FnaW5nIGZvciBKUwovLwovLyBodHRwczovL3Rid2lraS50b2tib3guY29tL2luZGV4LnBocC9SYXB0b3JfTWVzc2FnZXNfKFNlbnRfYXNfYV9SdW1vck1lc3NhZ2VfcGF5bG9hZF9pbl9KU09OKQovLwovLyBAdG9kbyBSYXB0b3IgewovLyAgICAgTG9vayBhdCBkaXNjb25uZWN0aW9uIGNsZWFudXA6IGkuZS4gc3Vic2NyaWJlciArIHB1Ymxpc2hlciBjbGVhbnVwCi8vICAgICBBZGQgZXJyb3IgY29kZXMgZm9yIGFsbCB0aGUgZXJyb3IgY2FzZXMKLy8gICAgIFdyaXRlIHVuaXQgdGVzdHMgZm9yIFNlc3Npb25JbmZvCi8vICAgICBXcml0ZSB1bml0IHRlc3RzIGZvciBTZXNzaW9uCi8vICAgICBNYWtlIHVzZSBvZiB0aGUgbmV3IERlc3Ryb3llZEV2ZW50Ci8vICAgICBNb3ZlIEFuYWx5dGljcyBvdXQgb2YgUmFwdG9yIGludG8gU2Vzc2lvbgovLyAgICAgUmVtb3ZlIGRlcGVuZGVuY3kgb24gT1QucHJvcGVydGllcwovLyAgICAgT1QuQ2FwYWJpbGl0aWVzIG11c3QgYmUgcGFydCBvZiB0aGUgUmFwdG9yIG5hbWVzcGFjZQovLyAgICAgQWRkIERlcGVuZGFiaWxpdHkgY29tbWFuZHMKLy8gICAgIFRoaW5rIGFib3V0IG5vQ29uZmxpY3QsIG9yIHdoZXRoZXIgd2Ugc2hvdWxkIGp1c3QgdXNlIHRoZSBPVCBuYW1lc3BhY2UKLy8gICAgIFRoaW5rIGFib3V0IGhvdyB0byBleHBvc2UgT1QucHVibGlzaGVycywgT1Quc3Vic2NyaWJlcnMsIGFuZCBPVC5zZXNzaW9ucyBpZiBtZXNzYWdpbmcgd2FzCi8vICAgICAgICBiZWluZyBpbmNsdWRlZCBhcyBhIGNvbXBvbmVudAovLyAgICAgQW5vdGhlciBzb2x1dGlvbiB0byB0aGUgcHJvYmxlbSBvZiBoYXZpbmcgcHVibGlzaGVycy9zdWJzY3JpYmVycy9ldGMgd291bGQgYmUgdG8gbWFrZQovLyAgICAgICAgUmFwdG9yIFNvY2tldCBhIHNlcGFyYXRlIGNvbXBvbmVudCBmcm9tIERpc3BhdGNoIChkaXNwYXRjaCBiZWluZyBtb3JlIGJ1c2luZXNzIGxvZ2ljKQovLyAgICAgTG9vayBhdCB0aGUgY291cGxpbmcgb2YgT1Quc2Vzc2lvbnMgdG8gT1QuUmFwdG9yLlNvY2tldAovLyB9Ci8vCi8vIEB0b2RvIFJhcHRvciBEb2NzIHsKLy8gICBEb2N1bWVudCBwYXlsb2FkIGZvcm1hdHMgZm9yIGluY29taW5nIG1lc3NhZ2VzICh3aGF0IGFyZSB0aGUgcGF5bG9hZHMgZm9yIFNUUkVBTSBDUkVBVEVEL01PRElGSUVEIGZvciBleGFtcGxlKQovLyAgIERvY3VtZW50IGhvdyBrZWVwYWxpdmVzIHdvcmsKLy8gICBEb2N1bWVudCBhbGwgdGhlIFJhcHRvciBhY3Rpb25zIGFuZCB0eXBlcwovLyAgIERvY3VtZW50IHRoZSBzZXNzaW9uIGNvbm5lY3QgZmxvdyAoaW5jbHVkaW5nIGVycm9yIGNhc2VzKQovLyB9CgoKT1QuUmFwdG9yID0gewogIEFjdGlvbnM6IHsKICAgIC8vR2VuZXJhbAogICAgQ09OTkVDVDogMTAwLAogICAgQ1JFQVRFOiAxMDEsCiAgICBVUERBVEU6IDEwMiwKICAgIERFTEVURTogMTAzLAogICAgU1RBVEU6IDEwNCwKCiAgICAvL01vZGVyYXRpb24KICAgIEZPUkNFX0RJU0NPTk5FQ1Q6IDEwNSwKICAgIEZPUkNFX1VOUFVCTElTSDogMTA2LAogICAgU0lHTkFMOiAxMDcsCgogICAgLy9BcmNoaXZlcwogICAgQ1JFQVRFX0FSQ0hJVkU6IDEwOCwKICAgIENMT1NFX0FSQ0hJVkU6IDEwOSwKICAgIFNUQVJUX1JFQ09SRElOR19TRVNTSU9OOiAxMTAsCiAgICBTVE9QX1JFQ09SRElOR19TRVNTSU9OOiAxMTEsCiAgICBTVEFSVF9SRUNPUkRJTkdfU1RSRUFNOiAxMTIsCiAgICBTVE9QX1JFQ09SRElOR19TVFJFQU06IDExMywKICAgIExPQURfQVJDSElWRTogMTE0LAogICAgU1RBUlRfUExBWUJBQ0s6IDExNSwKICAgIFNUT1BfUExBWUJBQ0s6IDExNiwKCiAgICAvL0FwcFN0YXRlCiAgICBBUFBTVEFURV9QVVQ6IDExNywKICAgIEFQUFNUQVRFX0RFTEVURTogMTE4LAoKICAgIC8vIEpTRVAKICAgIE9GRkVSOiAxMTksCiAgICBBTlNXRVI6IDEyMCwKICAgIFBSQU5TV0VSOiAxMjEsCiAgICBDQU5ESURBVEU6IDEyMiwKICAgIFNVQlNDUklCRTogMTIzLAogICAgVU5TVUJTQ1JJQkU6IDEyNCwKICAgIFFVRVJZOiAxMjUsCiAgICBTRFBfQU5TV0VSOiAxMjYsCgogICAgLy9LZWVwQWxpdmUKICAgIFBPTkc6IDEyNywKICAgIFJFR0lTVEVSOiAxMjgsIC8vVXNlZCBmb3IgcmVnaXN0ZXJpbmcgc3RyZWFtcy4KCiAgICBRVUFMSVRZX0NIQU5HRUQ6IDEyOQogIH0sCgogIFR5cGVzOiB7CiAgICAgIC8vUlBDCiAgICAgIFJQQ19SRVFVRVNUOiAxMDAsCiAgICAgIFJQQ19SRVNQT05TRTogMTAxLAoKICAgICAgLy9FVkVOVAogICAgICBTVFJFQU06IDEwMiwKICAgICAgQVJDSElWRTogMTAzLAogICAgICBDT05ORUNUSU9OOiAxMDQsCiAgICAgIEFQUFNUQVRFOiAxMDUsCiAgICAgIENPTk5FQ1RJT05DT1VOVDogMTA2LAogICAgICBNT0RFUkFUSU9OOiAxMDcsCiAgICAgIFNJR05BTDogMTA4LAogICAgICBTVUJTQ1JJQkVSOiAxMTAsCgogICAgICAvL0pTRVAgUHJvdG9jb2wKICAgICAgSlNFUDogMTA5CiAgfQp9OwoKCn0odGhpcykpOwooZnVuY3Rpb24oZ2xvYmFsKSB7CgovLy8vIFNvbWUgaGVscGVyIGZ1bmN0aW9ucyB0aGF0IGFyZSB1c2VkIGZvciBkZWJ1Z2dpbmcgYW5kIGxvZ2dpbmcKCnZhciB0eXBlVG9OYW1lID0ge30sCiAgICBhY3Rpb25Ub05hbWUgPSB7fTsKCi8vIENyZWF0ZSBhIGxvb2t1cCB0YWJsZSBvZiBSYXB0b3IgbWVzc2FnZSB0eXBlcyAoaW50ZWdlcikgdG8gYSBodW1hbiByZWFkYWJsZSBzdHJpbmdzCnZhciBtZXNzYWdlVHlwZXMgPSBPVC5SYXB0b3IuVHlwZXM7CmZvciAodmFyIG5hbWUgaW4gbWVzc2FnZVR5cGVzKSB7CiAgdHlwZVRvTmFtZVttZXNzYWdlVHlwZXNbbmFtZV1dID0gbmFtZTsKfQoKLy8gQ3JlYXRlIGEgbG9va3VwIHRhYmxlIG9mICBSYXB0b3IgbWVzc2FnZSBhY3Rpb25zIChpbnRlZ2VyKSB0byBhIGh1bWFuIHJlYWRhYmxlIHN0cmluZ3MKdmFyIG1lc3NhZ2VBY3Rpb25zID0gT1QuUmFwdG9yLkFjdGlvbnM7CmZvciAodmFyIG5hbWUgaW4gbWVzc2FnZUFjdGlvbnMpIHsKICBhY3Rpb25Ub05hbWVbbWVzc2FnZUFjdGlvbnNbbmFtZV1dID0gbmFtZTsKfQoKCk9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTsKfTsKCgovLyBEZXNlcmlhbGlzaW5nIGEgUmFwdG9yIG1lc3NhZ2UgbWFpbmx5IG1lYW5zIGRvaW5nIGEgSlNPTi5wYXJzZSBvbiBpdC4KLy8gV2UgZG8gZGVjb3JhdGUgdGhlIGZpbmFsIG1lc3NhZ2Ugd2l0aCBhIGZldyBleHRyYSBoZWxwZXIgcHJvcGVyaWVzIHRob3VnaC4KLy8KLy8gVGhlc2UgaW5jbHVkZToKLy8gKiB0eXBlTmFtZTogQSBodW1hbiByZWFkYWJsZSB2ZXJzaW9uIG9mIHRoZSBSYXB0b3IgdHlwZS4gRS5nLiBTVFJFQU0gaW5zdGVhZCBvZiAxMDIKLy8gKiBhY3Rpb25OYW1lOiBBIGh1bWFuIHJlYWRhYmxlIHZlcnNpb24gb2YgdGhlIFJhcHRvciBhY3Rpb24uIEUuZy4gQ1JFQVRFIGluc3RlYWQgb2YgMTAxCi8vICogc2lnbmF0dXJlOiB0eXBlTmFtZSBhbmQgYWN0aW9uTmFtZSBjb21iaW5lZC4gVGhpcyBpcyBtYWlubHkgZm9yIGRlYnVnZ2luZy4gRS5nLiBBIHR5cGUKLy8gICAgb2YgMTAyIGFuZCBhbiBhY3Rpb24gb2YgMTAxIHdvdWxkIHJlc3VsdCBpbiBhIHNpZ25hdHVyZSBvZiAiU1RSRUFNOkNSRUFURSIKLy8KT1QuUmFwdG9yLmRlc2VyaWFsaXplTWVzc2FnZSA9IGZ1bmN0aW9uIChtc2cpIHsKICB2YXIgbWVzc2FnZSA9IEpTT04ucGFyc2UobXNnKTsKCiAgaWYgKG1lc3NhZ2UudHlwZSkgewogICAgbWVzc2FnZS50eXBlID0gcGFyc2VJbnQobWVzc2FnZS50eXBlLCAxMCk7CiAgICBtZXNzYWdlLnR5cGVOYW1lID0gdHlwZVRvTmFtZVttZXNzYWdlLnR5cGVdIHx8IG51bGw7CiAgfQoKICBpZiAobWVzc2FnZS5hY3Rpb24pIHsKICAgIG1lc3NhZ2UuYWN0aW9uID0gcGFyc2VJbnQobWVzc2FnZS5hY3Rpb24sIDEwKTsKICAgIG1lc3NhZ2UuYWN0aW9uTmFtZSA9IGFjdGlvblRvTmFtZVttZXNzYWdlLmFjdGlvbl0gfHwgbnVsbDsKICB9CgogIG1lc3NhZ2Uuc2lnbmF0dXJlID0gbWVzc2FnZS50eXBlTmFtZSArICc6JyArIG1lc3NhZ2UuYWN0aW9uTmFtZTsKCiAgcmV0dXJuIG1lc3NhZ2U7Cn07CgoKT1QuUmFwdG9yLk1lc3NhZ2UgPSB7fTsKT1QuUmFwdG9yLk1lc3NhZ2UuY29ubmVjdCA9IGZ1bmN0aW9uICh3aWRnZXRJZCwgY29ubmVjdGlvbklkLCBzZXNzaW9uSWQsIGFwaUtleSwgdG9rZW4sIHAycEVuYWJsZWQpIHsKICB2YXIgcGF5bG9hZCA9IHsKICAgICAgICBjcmVkZW50aWFsczogewogICAgICAgICAgY29ubmVjdGlvbklkOiBjb25uZWN0aW9uSWQsCiAgICAgICAgICBzb0FjY2Vzc1N0YXRlOiAyLAogICAgICAgICAgc3VwcG9ydHNXZWJSVEM6IHRydWUsCiAgICAgICAgICBwMnBFbmFibGVkOiBwMnBFbmFibGVkLAogICAgICAgICAgR1VJRDogd2lkZ2V0SWQsCiAgICAgICAgICB3aWRnZXRJZDogd2lkZ2V0SWQsCiAgICAgICAgICBwYXJ0bmVySWQ6IGFwaUtleQogICAgICAgIH0sCiAgICAgICAgc2Vzc2lvbklkOiBzZXNzaW9uSWQsCiAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgIHRva2VuUGVybWlzc2lvbnM6IHsKICAgICAgICAgICAgICAgIGFwaUtleTogYXBpS2V5CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRva2VuOiB0b2tlbgogICAgICAgIH0sCiAgICAgICAgdW5pcXVlSWQ6IGNvbm5lY3Rpb25JZAogICAgICB9OwoKICByZXR1cm4gT1QuUmFwdG9yLnNlcmlhbGl6ZU1lc3NhZ2UoewogICAgaWQ6IE9ULiQudXVpZCgpLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlJQQ19SRVFVRVNULAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5DT05ORUNULAogICAgcGF5bG9hZDogcGF5bG9hZCwKICAgIHJlcGx5VG86IGNvbm5lY3Rpb25JZAogIH0pOwp9OwoKCk9ULlJhcHRvci5NZXNzYWdlLmdldFNlc3Npb25TdGF0ZSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQsIHNlc3Npb25JZCwgY29ubmVjdGlvbnNSZXF1aXJlZCkgewogIHJldHVybiBPVC5SYXB0b3Iuc2VyaWFsaXplTWVzc2FnZSh7CiAgICBpZDogT1QuJC51dWlkKCksCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuUlBDX1JFUVVFU1QsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLlNUQVRFLAogICAgcGF5bG9hZDogewogICAgICBzZXNzaW9uSWQ6IHNlc3Npb25JZCwKICAgICAgY29ubmVjdGlvbnNSZXF1aXJlZDogY29ubmVjdGlvbnNSZXF1aXJlZCB8fCB0cnVlCiAgICB9LAogICAgcmVwbHlUbzogY29ubmVjdGlvbklkCiAgfSk7Cn07CgoKT1QuUmFwdG9yLk1lc3NhZ2UuZm9yY2VEaXNjb25uZWN0ID0gZnVuY3Rpb24gKGZyb21Db25uZWN0aW9uSWQsIGNvbm5lY3Rpb25JZFRvRGlzY29ubmVjdCwgc2Vzc2lvbklkKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlJQQ19SRVFVRVNULAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5GT1JDRV9ESVNDT05ORUNULAogICAgcGF5bG9hZDogewogICAgICBjb25uZWN0aW9uSWQ6IGNvbm5lY3Rpb25JZFRvRGlzY29ubmVjdCwKICAgICAgc2Vzc2lvbklkOiBzZXNzaW9uSWQKICAgIH0sCiAgICByZXBseVRvOiBmcm9tQ29ubmVjdGlvbklkCiAgfSk7Cn07CgoKCk9ULlJhcHRvci5NZXNzYWdlLnN0cmVhbUNyZWF0ZSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQsIHNlc3Npb25JZCwgcHVibGlzaGVySWQsIG5hbWUsIHZpZGVvT3JpZW50YXRpb24sIHZpZGVvV2lkdGgsIHZpZGVvSGVpZ2h0LCBoYXNBdWRpbywgaGFzVmlkZW8sIHAycEVuYWJsZWQpIHsKICB2YXIgcGF5bG9hZCA9IHsKICAgIGtleTogc2Vzc2lvbklkLAogICAgdmFsdWU6IHsKICAgICAgcDJwRW5hYmxlZDogcDJwRW5hYmxlZCB8fCBmYWxzZSwKICAgICAgcHVibGlzaGVySWQ6IHB1Ymxpc2hlcklkLAogICAgICBjb25uZWN0aW9uOiB7CiAgICAgICAgICBjb25uZWN0aW9uSWQ6IGNvbm5lY3Rpb25JZAogICAgICB9LAogICAgICB0eXBlOiAiV2ViUlRDIiwKICAgICAgbmFtZTogbmFtZSB8fCAnJywKICAgICAgY3JlYXRpb25UaW1lOiBEYXRlLm5vdygpLCAgIC8vIFVuaXggdGltZXN0YW1wLCB0aW1lIGluIG1pbGxpc2Vjb25kcyBzaW5jZSAxOTcwIFVUQwogICAgICBvcmllbnRhdGlvbjogewogICAgICAgICAgd2lkdGg6IHZpZGVvV2lkdGgsCiAgICAgICAgICBoZWlnaHQ6IHZpZGVvSGVpZ2h0LAogICAgICAgICAgdmlkZW9PcmllbnRhdGlvbjogdmlkZW9PcmllbnRhdGlvbiB8fCAiT1RWaWRlb09yaWVudGF0aW9uUm90YXRlZE5vcm1hbCIKICAgICAgfSwKICAgICAgaGFzQXVkaW86IGhhc0F1ZGlvICE9PSB2b2lkIDAgPyBoYXNBdWRpbyA6IHRydWUsCiAgICAgIGhhc1ZpZGVvOiBoYXNWaWRlbyAhPT0gdm9pZCAwID8gaGFzVmlkZW8gOiB0cnVlCiAgICB9CiAgfTsKCiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBjb25uZWN0aW9uSWQsIC8vIEhBQ0sgdW50aWwgYnVmIGZpeGVkIGluIHN5bXBob255CiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuU1RSRUFNLAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5DUkVBVEUsCiAgICBwYXlsb2FkOiBwYXlsb2FkLAogICAgcmVwbHlUbzogJycKICB9KTsKfTsKCgpPVC5SYXB0b3IuTWVzc2FnZS5zdHJlYW1EZXN0cm95ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCwgc2Vzc2lvbklkLCBzdHJlYW1JZCkgewogIHJldHVybiBPVC5SYXB0b3Iuc2VyaWFsaXplTWVzc2FnZSh7CiAgICBpZDogY29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlNUUkVBTSwKICAgIGFjdGlvbjogT1QuUmFwdG9yLkFjdGlvbnMuREVMRVRFLAogICAgcGF5bG9hZDogewogICAgICBrZXk6IHNlc3Npb25JZCArICIvU1RSRUFNUy8iICsgc3RyZWFtSWQKICAgIH0sCiAgICByZXBseVRvOiBjb25uZWN0aW9uSWQKICB9KTsKfTsKCgpPVC5SYXB0b3IuTWVzc2FnZS5zdHJlYW1Nb2RpZnkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkLCBzZXNzaW9uSWQsIHN0cmVhbUlkLCBrZXksIHZhbHVlKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBjb25uZWN0aW9uSWQsCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuU1RSRUFNLAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5VUERBVEUsCiAgICBwYXlsb2FkOiB7CiAgICAgIGtleTogW3Nlc3Npb25JZCwgJ1NUUkVBTVMnLCBzdHJlYW1JZCwga2V5XS5qb2luKCcvJyksCiAgICAgIHZhbHVlOiB2YWx1ZQogICAgfSwKICAgIHJlcGx5VG86IGNvbm5lY3Rpb25JZAogIH0pOwp9OwoKT1QuUmFwdG9yLk1lc3NhZ2UuZm9yY2VVbnB1Ymxpc2ggPSBmdW5jdGlvbiAoZnJvbUNvbm5lY3Rpb25JZCwgc2Vzc2lvbklkLCBzdHJlYW1JZFRvVW5wdWJsaXNoKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlJQQ19SRVFVRVNULAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5GT1JDRV9VTlBVQkxJU0gsCiAgICBwYXlsb2FkOiB7CiAgICAgIHNlc3Npb25JZDogc2Vzc2lvbklkLAogICAgICBjb25uZWN0aW9uSWQ6IGZyb21Db25uZWN0aW9uSWQsCiAgICAgIHN0cmVhbUlkOiBzdHJlYW1JZFRvVW5wdWJsaXNoLAogICAgICB3ZWJSVENTdHJlYW06IHRydWUKICAgIH0sCiAgICByZXBseVRvOiBmcm9tQ29ubmVjdGlvbklkCiAgfSk7Cn07CgoKT1QuUmFwdG9yLk1lc3NhZ2UuanNlcE9mZmVyID0gZnVuY3Rpb24gKGZyb21Db25uZWN0aW9uSWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgc2RwKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLkpTRVAsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLk9GRkVSLAogICAgcGF5bG9hZDogewogICAgICBmcm9tQWRkcmVzczogZnJvbUNvbm5lY3Rpb25JZCwKICAgICAgdG9BZGRyZXNzZXM6IHRvQ29ubmVjdGlvbklkLAogICAgICBzZHA6IHNkcCwKICAgICAgc3RyZWFtSWQ6IHN0cmVhbUlkCiAgICB9LAogICAgcmVwbHlUbzogZnJvbUNvbm5lY3Rpb25JZAogIH0pOwp9OwoKCk9ULlJhcHRvci5NZXNzYWdlLmpzZXBBbnN3ZXIgPSBmdW5jdGlvbiAoZnJvbUNvbm5lY3Rpb25JZCwgdG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkLCBzZHApIHsKICByZXR1cm4gT1QuUmFwdG9yLnNlcmlhbGl6ZU1lc3NhZ2UoewogICAgaWQ6IGZyb21Db25uZWN0aW9uSWQsCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuSlNFUCwKICAgIGFjdGlvbjogT1QuUmFwdG9yLkFjdGlvbnMuQU5TV0VSLAogICAgcGF5bG9hZDogewogICAgICBmcm9tQWRkcmVzczogZnJvbUNvbm5lY3Rpb25JZCwKICAgICAgdG9BZGRyZXNzZXM6IHRvQ29ubmVjdGlvbklkLAogICAgICBzZHA6IHNkcCwKICAgICAgc3RyZWFtSWQ6IHN0cmVhbUlkCiAgICB9LAogICAgcmVwbHlUbzogZnJvbUNvbm5lY3Rpb25JZAogIH0pOwp9OwoKT1QuUmFwdG9yLk1lc3NhZ2UuanNlcFN1YnNjcmliZSA9IGZ1bmN0aW9uIChmcm9tQ29ubmVjdGlvbklkLCB0b0Nvbm5lY3Rpb25JZCwgc3RyZWFtSWQsIHN1YnNjcmliZVRvVmlkZW8sIHN1YnNjcmliZVRvQXVkaW8pIHsKICByZXR1cm4gT1QuUmFwdG9yLnNlcmlhbGl6ZU1lc3NhZ2UoewogICAgaWQ6IGZyb21Db25uZWN0aW9uSWQsCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuSlNFUCwKICAgIGFjdGlvbjogT1QuUmFwdG9yLkFjdGlvbnMuU1VCU0NSSUJFLAogICAgcGF5bG9hZDogewogICAgICBrZXlNYW5hZ2VtZW5NZXRob2Q6IE9ULiQuc3VwcG9ydGVkQ3J5cHRvU2NoZW1lKCksCiAgICAgIGJ1bmRsZVN1cHBvcnQ6IE9ULiQuc3VwcG9ydHNCdW5kbGUoKSwKICAgICAgcnRjcE11eFN1cHBvcnQ6IE9ULiQuc3VwcG9ydHNSdGNwTXV4KCksCiAgICAgIGZyb21BZGRyZXNzOiBmcm9tQ29ubmVjdGlvbklkLAogICAgICB0b0FkZHJlc3NlczogdG9Db25uZWN0aW9uSWQsCiAgICAgIHN0cmVhbUlkOiBzdHJlYW1JZCwKICAgICAgaGFzVmlkZW86IHN1YnNjcmliZVRvVmlkZW8sCiAgICAgIGhhc0F1ZGlvOiBzdWJzY3JpYmVUb0F1ZGlvCiAgICB9LAogICAgcmVwbHlUbzogZnJvbUNvbm5lY3Rpb25JZAogIH0pOwp9OwoKCgpPVC5SYXB0b3IuTWVzc2FnZS5qc2VwVW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZnJvbUNvbm5lY3Rpb25JZCwgdG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLkpTRVAsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLlVOU1VCU0NSSUJFLAogICAgcGF5bG9hZDogewogICAgICBmcm9tQWRkcmVzczogZnJvbUNvbm5lY3Rpb25JZCwKICAgICAgdG9BZGRyZXNzZXM6IHRvQ29ubmVjdGlvbklkLAogICAgICBzdHJlYW1JZDogc3RyZWFtSWQKICAgIH0sCiAgICByZXBseVRvOiBmcm9tQ29ubmVjdGlvbklkCiAgfSk7Cn07CgpPVC5SYXB0b3IuTWVzc2FnZS5qc2VwQ2FuZGlkYXRlID0gZnVuY3Rpb24gKGZyb21Db25uZWN0aW9uSWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgY2FuZGlkYXRlKSB7CiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBmcm9tQ29ubmVjdGlvbklkLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLkpTRVAsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLkNBTkRJREFURSwKICAgIHBheWxvYWQ6IHsKICAgICAgZnJvbUFkZHJlc3M6IGZyb21Db25uZWN0aW9uSWQsCiAgICAgIHRvQWRkcmVzc2VzOiB0b0Nvbm5lY3Rpb25JZCwKICAgICAgY2FuZGlkYXRlOiBjYW5kaWRhdGUsCiAgICAgIHN0cmVhbUlkOiBzdHJlYW1JZAogICAgfSwKICAgIHJlcGx5VG86IGZyb21Db25uZWN0aW9uSWQKICB9KTsKfTsKCk9ULlJhcHRvci5NZXNzYWdlLnN1YnNjcmliZXJNb2RpZnkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkLCBzZXNzaW9uSWQsIHN0cmVhbUlkLCBzdWJzY3JpYmVySWQsIGtleSwgdmFsdWUpIHsKICByZXR1cm4gT1QuUmFwdG9yLnNlcmlhbGl6ZU1lc3NhZ2UoewogICAgaWQ6IE9ULiQudXVpZCgpLAogICAgdHlwZTogT1QuUmFwdG9yLlR5cGVzLlNVQlNDUklCRVIsCiAgICBhY3Rpb246IE9ULlJhcHRvci5BY3Rpb25zLlVQREFURSwKICAgIHBheWxvYWQ6IHsKICAgICAga2V5OiBbc2Vzc2lvbklkLCAnU1VCU0NSSUJFUicsIHN0cmVhbUlkLCBjb25uZWN0aW9uSWQsIGtleV0uam9pbignLycpLAogICAgICB2YWx1ZTogdmFsdWUKICAgIH0sCiAgICByZXBseVRvOiBjb25uZWN0aW9uSWQKICB9KTsKfTsKCgpPVC5SYXB0b3IuTWVzc2FnZS5zaWduYWwgPSBmdW5jdGlvbihjb25uZWN0aW9uSWQsIHNlc3Npb25JZCwgdHlwZSwgdG8sIGRhdGEpIHsKICB2YXIgcGF5bG9hZCA9IHsKICAgIGlkOiBPVC4kLnV1aWQoKSwKICAgIGZyb21BZGRyZXNzOiBjb25uZWN0aW9uSWQKICB9OwoKICAvLyBNYXNzYWdlIHRoZSB0byBmaWVsZCBpbnRvIGFuIGFycmF5IGFuZCBkZWZhdWx0IGl0IHRvIHRoZSBzZXNzaW9uIGlkCiAgLy8gaWYgd2UncmUgc2VuZGluZyB0byBubyBvbmUKICBpZiAodG8gJiYgIUFycmF5LmlzQXJyYXkodG8pKSB7CiAgICBwYXlsb2FkLnRvQWRkcmVzc2VzID0gW3RvXTsKICB9CiAgZWxzZSBpZiAoIXRvIHx8IHRvLmxlbmd0aCA9PT0gMCkgewogICAgLy8gaWYgaXQgd2FzIG9taXR0ZWQgdGhlbiB3ZSdsbCBzZW5kIHRoZSBzaWduYWwgdG8gdGhlIGVudGlyZSBzZXNzaW9uLgogICAgcGF5bG9hZC50b0FkZHJlc3NlcyA9IFtzZXNzaW9uSWRdOwogIH0KICBlbHNlIHsKICAgIHBheWxvYWQudG9BZGRyZXNzZXMgPSB0bzsKICB9CgogIGlmICh0eXBlICE9PSB2b2lkIDApIHBheWxvYWQudHlwZSA9IHR5cGU7CiAgaWYgKGRhdGEgIT09IHZvaWQgMCkgcGF5bG9hZC5kYXRhID0gZGF0YTsKCiAgcmV0dXJuIE9ULlJhcHRvci5zZXJpYWxpemVNZXNzYWdlKHsKICAgIGlkOiBjb25uZWN0aW9uSWQsCiAgICB0eXBlOiBPVC5SYXB0b3IuVHlwZXMuU0lHTkFMLAogICAgYWN0aW9uOiBPVC5SYXB0b3IuQWN0aW9ucy5TSUdOQUwsCiAgICBwYXlsb2FkOiBwYXlsb2FkLAogICAgcmVwbHlUbzogY29ubmVjdGlvbklkCiAgfSk7Cn07Cgp9KHRoaXMpKTsKKGZ1bmN0aW9uKGdsb2JhbCkgewoKdmFyIE1BWF9TSUdOQUxfREFUQV9MRU5HVEggPSA4MTkyOwp2YXIgTUFYX1NJR05BTF9UWVBFX0xFTkdUSCA9IDEyODsKCi8vCi8vIEVycm9yIENvZGVzOgovLyA0MTMgLSBUeXBlIHRvbyBsb25nCi8vIDQwMCAtIFR5cGUgaXMgaW52YWxpZAovLyA0MTMgLSBEYXRhIHRvbyBsb25nCi8vIDQwMCAtIERhdGEgaXMgaW52YWxpZCAoY2FuJ3QgYmUgcGFyc2VkIGFzIEpTT04pCi8vIDQyOSAtIFJhdGUgbGltaXQgZXhjZWVkZWQKLy8gNTAwIC0gV2Vic29ja2V0IGNvbm5lY3Rpb24gaXMgZG93bgovLyA0MDQgLSBUbyBjb25uZWN0aW9uIGRvZXMgbm90IGV4aXN0Ci8vIDQwMCAtIFRvIGlzIGludmFsaWQKLy8KT1QuU2lnbmFsID0gZnVuY3Rpb24oc2Vzc2lvbklkLCBmcm9tQ29ubmVjdGlvbklkLCBvcHRpb25zKSB7CiAgdmFyIGlzSW52YWxpZFR5cGUgPSBmdW5jdGlvbih0eXBlKSB7CiAgICAgIC8vIE91ciBmb3JtYXQgbWF0Y2hlcyB0aGUgdW5yZXNlcnZlZCBjaGFyYWN0ZXJzIGZyb20gdGhlIFVSSSBSRkM6IGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYKICAgICAgcmV0dXJuICEvXlthLXpBLVowLTlcLVwuX35dKyQvLmV4ZWModHlwZSk7CiAgICB9LAoKICAgIHZhbGlkYXRlVG8gPSBmdW5jdGlvbih0b0FkZHJlc3MpIHsKICAgICAgaWYgKCF0b0FkZHJlc3MpIHsKICAgICAgICByZXR1cm4ge2NvZGU6IDQwMCwgcmVhc29uOiAiVGhlIHNpZ25hbCB0eXBlIHdhcyBudWxsIG9yIGFuIGVtcHR5IFN0cmluZy4gRWl0aGVyIHNldCBpdCB0byBhIG5vbi1lbXB0eSBTdHJpbmcgdmFsdWUgb3Igb21pdCBpdCJ9OwogICAgICB9CiAgICAgIGVsc2UgaWYgKCAhQXJyYXkuaXNBcnJheSh0b0FkZHJlc3MpICkgewogICAgICAgIHJldHVybiB7Y29kZTogNDAwLCByZWFzb246ICJUaGUgVG8gZmllbGQgd2FzIGludmFsaWQifTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaT0wOyBpPHRvQWRkcmVzcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICggISh0b0FkZHJlc3NbaV0gaW5zdGFuY2VvZiBPVC5Db25uZWN0aW9uIHx8IHRvQWRkcmVzc1tpXSBpbnN0YW5jZW9mIE9ULlNlc3Npb24pICkgewogICAgICAgICAgcmV0dXJuIHtjb2RlOiA0MDAsIHJlYXNvbjogIlRoZSBUbyBmaWVsZCB3YXMgaW52YWxpZCJ9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIHZhbGlkYXRlVHlwZSA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgdmFyIGVycm9yID0gbnVsbDsKCiAgICAgIGlmICh0eXBlID09PSBudWxsIHx8IHR5cGUgPT09IHZvaWQgMCkgewogICAgICAgIGVycm9yID0ge2NvZGU6IDQwMCwgcmVhc29uOiAiVGhlIHNpZ25hbCB0eXBlIHdhcyBudWxsIG9yIHVuZGVmaW5lZC4gRWl0aGVyIHNldCBpdCB0byBhIFN0cmluZyB2YWx1ZSBvciBvbWl0IGl0In07CiAgICAgIH0KICAgICAgZWxzZSBpZiAodHlwZS5sZW5ndGggPiBNQVhfU0lHTkFMX1RZUEVfTEVOR1RIKSB7CiAgICAgICAgZXJyb3IgPSB7Y29kZTogNDEzLCByZWFzb246ICJUaGUgc2lnbmFsIHR5cGUgd2FzIHRvbyBsb25nLCB0aGUgbWF4aW11bSBsZW5ndGggb2YgaXQgaXMgIiArIE1BWF9TSUdOQUxfVFlQRV9MRU5HVEggKyAiIGNoYXJhY3RlcnMifTsKICAgICAgfQogICAgICBlbHNlIGlmICggaXNJbnZhbGlkVHlwZSh0eXBlKSApIHsKICAgICAgICBlcnJvciA9IHtjb2RlOiA0MDAsIHJlYXNvbjogIlRoZSBzaWduYWwgdHlwZSB3YXMgaW52YWxpZCwgaXQgY2FuIG9ubHkgY29udGFpbiBsZXR0ZXJzLCBudW1iZXJzLCAnLScsICdfJywgYW5kICd+Jy4ifTsKICAgICAgfQoKICAgICAgcmV0dXJuIGVycm9yOwogICAgfSwKCiAgICB2YWxpZGF0ZURhdGEgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHZhciBlcnJvciA9IG51bGw7CiAgICAgIGlmIChkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCkgewogICAgICAgIGVycm9yID0ge2NvZGU6IDQwMCwgcmVhc29uOiAiVGhlIHNpZ25hbCBkYXRhIHdhcyBudWxsIG9yIHVuZGVmaW5lZC4gRWl0aGVyIHNldCBpdCB0byBhIFN0cmluZyB2YWx1ZSBvciBvbWl0IGl0In07CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShkYXRhKS5sZW5ndGggPiBNQVhfU0lHTkFMX0RBVEFfTEVOR1RIKSB7CiAgICAgICAgICAgIGVycm9yID0ge2NvZGU6IDQxMywgcmVhc29uOiAiVGhlIGRhdGEgZmllbGQgd2FzIHRvbyBsb25nLCB0aGUgbWF4aW11bSBzaXplIG9mIGl0IGlzICIgKyBNQVhfU0lHTkFMX0RBVEFfTEVOR1RIICsgIiBjaGFyYWN0ZXJzIn07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoKGUpIHsKICAgICAgICAgIGVycm9yID0ge2NvZGU6IDQwMCwgcmVhc29uOiAiVGhlIGRhdGEgZmllbGQgd2FzIG5vdCB2YWxpZCBKU09OIn07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZXJyb3I7CiAgICB9OwoKCiAgdGhpcy50b1JhcHRvck1lc3NhZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0bzsKCiAgICBpZiAodGhpcy50bykgewogICAgICB0byA9IHRoaXMudG8ubWFwKGZ1bmN0aW9uKHRoaW5nKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZih0aGluZykgPT09ICdzdHJpbmcnID8gdGhpbmcgOiB0aGluZy5pZDsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIE9ULlJhcHRvci5NZXNzYWdlLnNpZ25hbChmcm9tQ29ubmVjdGlvbklkLCBzZXNzaW9uSWQsIHRoaXMudHlwZSwgdG8sIHRoaXMuZGF0YSk7CiAgfTsKCiAgdGhpcy50b0hhc2ggPSBmdW5jdGlvbigpIHsKICAgIHZhciBoID0gT1QuJC5jbG9uZShvcHRpb25zKTsKICAgIGlmIChoLnRvID09PSB2b2lkIDApIGgudG8gPSBudWxsOwogICAgaWYgKGguZGF0YSA9PT0gdm9pZCAwKSBoLmRhdGEgPSBudWxsOwoKICAgIHJldHVybiBoOwogIH07CgoKICB0aGlzLmVycm9yID0gbnVsbDsKCiAgaWYgKG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCdkYXRhJykpIHsKICAgICAgdGhpcy5kYXRhID0gT1QuJC5jbG9uZShvcHRpb25zLmRhdGEpOwogICAgICB0aGlzLmVycm9yID0gdmFsaWRhdGVEYXRhKHRoaXMuZGF0YSk7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ3RvJykpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9wdGlvbnMudG8pKSB7CiAgICAgICAgdGhpcy50byA9IFtvcHRpb25zLnRvXTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICB0aGlzLnRvID0gT1QuJC5jbG9uZShvcHRpb25zLnRvKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmVycm9yKSB0aGlzLmVycm9yID0gdmFsaWRhdGVUbyh0aGlzLnRvKQogICAgfQoKICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCd0eXBlJykpIHsKICAgICAgaWYgKCF0aGlzLmVycm9yKSB0aGlzLmVycm9yID0gdmFsaWRhdGVUeXBlKG9wdGlvbnMudHlwZSkKICAgICAgdGhpcy50eXBlID0gb3B0aW9ucy50eXBlOwogICAgfQogIH0KCiAgdGhpcy52YWxpZCA9IHRoaXMuZXJyb3IgPT09IG51bGw7Cn07Cgp9KHRoaXMpKTsKKGZ1bmN0aW9uKGdsb2JhbCkgewoKCmZ1bmN0aW9uIFNpZ25hbEVycm9yKGNvZGUsIHJlYXNvbiwgc2lnbmFsKSB7CiAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgdGhpcy5yZWFzb24gPSByZWFzb247CiAgICB0aGlzLnNpZ25hbCA9IHNpZ25hbDsKfQoKLy8gVGhlIERpc3BhdGNoZXIgYml0IGlzIHB1cmVseSB0byBtYWtlIHRlc3Rpbmcgc2ltcGxlciwgaXQgZGVmYXVsdHMgdG8gT1QuUmFwdG9yLkRpc3BhdGNoZXIKLy8gc28gaW4gbm9ybWFsIG9wZXJhdGlvbiB5b3Ugd291bGQgb21pdCBpdC4gTm90ZTogaXQgdGFrZXMgYSBjb25zdHJ1Y3Rvciwgbm90IGFuIGluc3RhbmNlLgpPVC5SYXB0b3IuU29ja2V0ID0gZnVuY3Rpb24od2lkZ2V0SWQsIG1lc3NhZ2luZ1NlcnZlciwgRGlzcGF0Y2hlcikgewogIHZhciBfc29ja2V0VXJsID0gT1QucHJvcGVydGllcy5tZXNzYWdpbmdQcm90b2NvbCArICI6Ly8iICsgbWVzc2FnaW5nU2VydmVyICsgIjoiICsgT1QucHJvcGVydGllcy5tZXNzYWdpbmdQb3J0ICsgIi9ydW1vcndlYnNvY2tldHN2MiIsCiAgICAgIF9zeW1waG9ueSA9ICJzeW1waG9ueS4iICsgbWVzc2FnaW5nU2VydmVyLAogICAgICBfc2Vzc2lvbklkLAogICAgICBfcnVtb3IsCiAgICAgIF9kaXNwYXRjaGVyLAogICAgICBfY29tcGxldGlvbiwKICAgICAgX2NhcGFiaWxpdGllcyA9IG5ldyBPVC5DYXBhYmlsaXRpZXMoW10pLAogICAgICBfYW5hbHl0aWNzID0gbmV3IE9ULkFuYWx5dGljcygpOwoKCiAgLy8vLyBQcml2YXRlIEFQSQogIHZhciBzZXRTdGF0ZSA9IE9ULiQuc3RhdGFibGUodGhpcywgWydkaXNjb25uZWN0ZWQnLCAnY29ubmVjdGluZycsICdjb25uZWN0ZWQnLCAnZXJyb3InLCAnZGlzY29ubmVjdGluZyddLCAnZGlzY29ubmVjdGVkJyksCgogICAgICBsb2dBbmFseXRpY3NFdmVudCA9IGZ1bmN0aW9uIGxvZ0FuYWx5dGljc0V2ZW50ICh2YXJpYXRpb24sIHBheWxvYWRUeXBlLCBwYXlsb2FkLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgICAgYWN0aW9uOiAnd2ViU29ja2V0Q29ubmVjdGlvbicsCiAgICAgICAgICB2YXJpYXRpb246IHZhcmlhdGlvbiwKICAgICAgICAgIHBheWxvYWRfdHlwZTogcGF5bG9hZFR5cGUsCiAgICAgICAgICBwYXlsb2FkOiBwYXlsb2FkLAogICAgICAgICAgc2Vzc2lvbl9pZDogX3Nlc3Npb25JZCwKICAgICAgICAgIHBhcnRuZXJfaWQ6IE9ULkFQSUtFWSwKICAgICAgICAgIHdpZGdldF9pZDogd2lkZ2V0SWQsCiAgICAgICAgICB3aWRnZXRfdHlwZTogJ0NvbnRyb2xsZXInCiAgICAgICAgfTsKCiAgICAgICAgaWYgKG9wdGlvbnMpIGV2ZW50ID0gT1QuJC5leHRlbmQob3B0aW9ucywgZXZlbnQpOwogICAgICAgIF9hbmFseXRpY3MubG9nRXZlbnQoZXZlbnQpOwogICAgICB9LAoKICAgICAgb25Db25uZWN0Q29tcGxldGUgPSBmdW5jdGlvbiBvbkNvbm5lY3RDb21wbGV0ZSAoZXJyb3IsIHNlc3Npb25TdGF0ZSkgewogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ0ZhaWx1cmUnLCAicmVhc29uIiwgZXJyb3IucmVhc29uKTsKCiAgICAgICAgICBzZXRTdGF0ZSgnZXJyb3InKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgnU3VjY2VzcycsICJ3ZWJTb2NrZXRTZXJ2ZXJVcmwiLCBfc29ja2V0VXJsLCB7Y29ubmVjdGlvbklkOiBfcnVtb3IuaWR9KTsKCiAgICAgICAgICBzZXRTdGF0ZSgnY29ubmVjdGVkJyk7CiAgICAgICAgICBfY2FwYWJpbGl0aWVzID0gbmV3IE9ULkNhcGFiaWxpdGllcyhzZXNzaW9uU3RhdGUucGVybWlzc2lvbnMpOwogICAgICAgIH0KCiAgICAgICAgX2NvbXBsZXRpb24uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgfSwKCiAgICAgIG9uQ2xvc2UgPSBmdW5jdGlvbiBvbkNsb3NlIChlcnIpIHsKICAgICAgICB2YXIgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChfc2Vzc2lvbklkKSwKICAgICAgICAgICAgY29ubmVjdGlvbiA9IHNlc3Npb24uY29ubmVjdGlvbiwKICAgICAgICAgICAgcmVhc29uID0gdGhpcy5pcygnZGlzY29ubmVjdGluZycpID8gImNsaWVudERpc2Nvbm5lY3RlZCIgOiAibmV0d29ya0Rpc2Nvbm5lY3RlZCI7CgogICAgICAgIGlmKGVyciAmJiBlcnIuY29kZSA9PSA0MDAxKSB7CiAgICAgICAgICByZWFzb24gPSAibmV0d29ya1RpbWVkb3V0IjsKICAgICAgICB9CgogICAgICAgIHNldFN0YXRlKCdkaXNjb25uZWN0ZWQnKTsKCiAgICAgICAgaWYgKCFjb25uZWN0aW9uKSByZXR1cm47CgogICAgICAgIGlmIChjb25uZWN0aW9uLmRlc3Ryb3llZFJlYXNvbikgewogICAgICAgICAgY29uc29sZS5kZWJ1ZygiT1QuUmFwdG9yLlNvY2tldDogU29ja2V0IHdhcyBjbG9zZWQgYnV0IHRoZSBjb25uZWN0aW9uIGhhZCBhbHJlYWR5IGJlZW4gZGVzdHJveWVkLiBSZWFzb246ICIgKyBjb25uZWN0aW9uLmRlc3Ryb3llZFJlYXNvbik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25uZWN0aW9uLmRlc3Ryb3koIHJlYXNvbiApOwogICAgICB9LmJpbmQodGhpcyksCgogICAgICBvbkVycm9yID0gZnVuY3Rpb24gb25FcnJvciAoKSB7CiAgICAgICAgLy8gQHRvZG8gd2hhdCBkb2VzIGhhdmluZyBhbiBlcnJvciBtZWFuPyBBcmUgdGhleSBhbHdheXMgZmF0YWw/IEFyZSB3ZSBkaXNjb25uZWN0ZWQgbm93PwogICAgICB9OwoKCiAgLy8vLyBQdWJsaWMgQVBJCgoKICAvLyBDaGVjayB3aGV0aGVyIHRoaXMgc29ja2V0IGNvbm5lY3Rpb24gaGFzIHBlcm1pc3Npb25zIHRvIHBlcmZvcm0gYSBwYXJ0aWN1bGFyCiAgLy8gYWN0aW9uLgogIHRoaXMucGVybWl0dGVkVG8gPSBmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgIHJldHVybiBfY2FwYWJpbGl0aWVzW2FjdGlvbl0gPT09IDE7CiAgfTsKCiAgdGhpcy5jb25uZWN0ID0gZnVuY3Rpb24gKHRva2VuLCBzZXNzaW9uSW5mbywgY29tcGxldGlvbikgewogICAgaWYgKCF0aGlzLmlzKCdkaXNjb25uZWN0ZWQnLCAnZXJyb3InKSkgewogICAgICBPVC53YXJuKCJDYW5ub3QgY29ubmVjdCB0aGUgUmFwdG9yIFNvY2tldCBhcyBpdCBpcyBjdXJyZW50bHkgY29ubmVjdGVkLiBZb3Ugc2hvdWxkIGRpc2Nvbm5lY3QgZmlyc3QuIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBzZXRTdGF0ZSgnY29ubmVjdGluZycpOwogICAgX3Nlc3Npb25JZCA9IHNlc3Npb25JbmZvLnNlc3Npb25JZDsKICAgIF9jb21wbGV0aW9uID0gY29tcGxldGlvbjsKCiAgICB2YXIgY29ubmVjdGlvbklkID0gT1QuJC51dWlkKCksCiAgICAgICAgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChfc2Vzc2lvbklkKTsKCgogICAgdmFyIGFuYWx5dGljc1BheWxvYWQgPSBbX3NvY2tldFVybCwgbmF2aWdhdG9yLnVzZXJBZ2VudCwgT1QucHJvcGVydGllcy52ZXJzaW9uLCB3aW5kb3cuZXh0ZXJuYWxIb3N0ID8gInllcyIgOiAibm8iXTsKICAgIGxvZ0FuYWx5dGljc0V2ZW50KAogICAgICAnQXR0ZW1wdCcsCiAgICAgICJ3ZWJTb2NrZXRTZXJ2ZXJVcmx8dXNlckFnZW50fHNka1ZlcnNpb258Y2hyb21lRnJhbWUiLAogICAgICBhbmFseXRpY3NQYXlsb2FkLm1hcChmdW5jdGlvbihlKSB7IHJldHVybiBlLnJlcGxhY2UoJ3wnLCAnXFx8Jyk7IH0pLmpvaW4oJ3wnKQogICAgKTsKCiAgICBfcnVtb3IgPSBuZXcgT1QuUnVtb3IuU29ja2V0KF9zb2NrZXRVcmwsIF9zeW1waG9ueSk7CiAgICBfcnVtb3Iub25DbG9zZSA9IG9uQ2xvc2U7CiAgICBfcnVtb3Iub25NZXNzYWdlID0gX2Rpc3BhdGNoZXIuZGlzcGF0Y2guYmluZChfZGlzcGF0Y2hlcik7CgogICAgX3J1bW9yLmNvbm5lY3QoY29ubmVjdGlvbklkLCBmdW5jdGlvbihlcnJvcikgewogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICBvbkNvbm5lY3RDb21wbGV0ZShlcnJvcik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB3ZSBkbyB0aGlzIGhlcmUgdG8gYXZvaWQgZ2V0dGluZyBjb25uZWN0IGVycm9ycyB0d2ljZQogICAgICBfcnVtb3Iub25FcnJvciA9IG9uRXJyb3I7CgogICAgICBPVC5kZWJ1ZygiUmFwdG9yIFNvY2tldCBjb25uZWN0ZWQgdG8gIiArIF9zZXNzaW9uSWQgKyAiIG9uICIgKyBtZXNzYWdpbmdTZXJ2ZXIpOwoKICAgICAgX3J1bW9yLnN1YnNjcmliZShbX3Nlc3Npb25JZF0pOwoKICAgICAgLy9jb25uZWN0IHRvIHNlc3Npb24KICAgICAgdmFyIGNvbm5lY3RNZXNzYWdlID0gT1QuUmFwdG9yLk1lc3NhZ2UuY29ubmVjdCh3aWRnZXRJZCwgX3J1bW9yLmlkLCBfc2Vzc2lvbklkLCBPVC5BUElLRVksIHRva2VuLCBzZXNzaW9uSW5mby5wMnBFbmFibGVkKTsKICAgICAgdGhpcy5wdWJsaXNoKGNvbm5lY3RNZXNzYWdlKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgfTsKCgogIHRoaXMuZGlzY29ubmVjdCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmlzKCdkaXNjb25uZWN0ZWQnKSkgcmV0dXJuOwoKICAgIHNldFN0YXRlKCdkaXNjb25uZWN0aW5nJyk7CiAgICBfcnVtb3IuZGlzY29ubmVjdCgpOwogIH07CgogIC8vIFB1Ymxpc2hzICttZXNzYWdlKyB0byB0aGUgU3ltcGhvbnkgYXBwIHNlcnZlci4KICB0aGlzLnB1Ymxpc2ggPSBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgaWYgKF9ydW1vci5pc05vdCgnY29ubmVjdGVkJykpIHsKICAgICAgT1QuZXJyb3IoIk9ULlJhcHRvci5Tb2NrZXQ6IGNhbm5vdCBwdWJsaXNoIHVudGlsIHRoZSBzb2NrZXQgaXMgY29ubmVjdGVkLiIgKyBtZXNzYWdlKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIE9ULmRlYnVnKCJPVC5SYXB0b3IuU29ja2V0IFB1Ymxpc2g6ICIgKyBtZXNzYWdlKTsKICAgIF9ydW1vci5wdWJsaXNoKFtfc3ltcGhvbnldLCBtZXNzYWdlKTsKICB9OwoKICAvLyBSZWdpc3RlciBhIG5ldyBzdHJlYW0gYWdhaW5zdCBfc2Vzc2lvbklkCiAgdGhpcy5jcmVhdGVTdHJlYW0gPSBmdW5jdGlvbihwdWJsaXNoZXJJZCwgbmFtZSwgb3JpZW50YXRpb24sIGVuY29kZWRXaWR0aCwgZW5jb2RlZEhlaWdodCwgaGFzQXVkaW8sIGhhc1ZpZGVvKSB7CiAgICB2YXIgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChfc2Vzc2lvbklkKSwKICAgICAgICBtZXNzYWdlID0gT1QuUmFwdG9yLk1lc3NhZ2Uuc3RyZWFtQ3JlYXRlKCBfcnVtb3IuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3Nlc3Npb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWJsaXNoZXJJZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kZWRXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkSGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0F1ZGlvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc1ZpZGVvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb24uc2Vzc2lvbkluZm8ucDJwRW5hYmxlZCApOwoKICAgIHRoaXMucHVibGlzaChtZXNzYWdlKTsKICB9OwoKICB0aGlzLnVwZGF0ZVN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbUlkLCBrZXksIHZhbHVlKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLnN0cmVhbU1vZGlmeShfcnVtb3IuaWQsIF9zZXNzaW9uSWQsIHN0cmVhbUlkLCBrZXksIHZhbHVlKSApOwogIH07CgogIHRoaXMuZGVzdHJveVN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbUlkKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLnN0cmVhbURlc3Ryb3koX3J1bW9yLmlkLCBfc2Vzc2lvbklkLCBzdHJlYW1JZCkgKTsKICB9OwoKICB0aGlzLm1vZGlmeVN1YnNjcmliZXIgPSBmdW5jdGlvbihzdWJzY3JpYmVyLCBrZXksIHZhbHVlKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLnN1YnNjcmliZXJNb2RpZnkoX3J1bW9yLmlkLCBfc2Vzc2lvbklkLCBzdWJzY3JpYmVyLnN0cmVhbUlkLCBzdWJzY3JpYmVyLndpZGdldElkLCBrZXksIHZhbHVlKSApOwogIH0KCiAgdGhpcy5mb3JjZURpc2Nvbm5lY3QgPSBmdW5jdGlvbihjb25uZWN0aW9uSWRUb0Rpc2Nvbm5lY3QpIHsKICAgIHRoaXMucHVibGlzaCggT1QuUmFwdG9yLk1lc3NhZ2UuZm9yY2VEaXNjb25uZWN0KF9ydW1vci5pZCwgY29ubmVjdGlvbklkVG9EaXNjb25uZWN0LCBfc2Vzc2lvbklkKSApOwogIH07CgogIHRoaXMuZm9yY2VVbnB1Ymxpc2ggPSBmdW5jdGlvbihzdHJlYW1JZCkgewogICAgdGhpcy5wdWJsaXNoKCBPVC5SYXB0b3IuTWVzc2FnZS5mb3JjZVVucHVibGlzaChfcnVtb3IuaWQsIF9zZXNzaW9uSWQsIHN0cmVhbUlkKSApOwogIH07CgogIHRoaXMuanNlcFN1YnNjcmliZSA9IGZ1bmN0aW9uKHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgc3Vic2NyaWJlVG9WaWRlbywgc3Vic2NyaWJlVG9BdWRpbykgewogICAgdGhpcy5wdWJsaXNoKCBPVC5SYXB0b3IuTWVzc2FnZS5qc2VwU3Vic2NyaWJlKF9ydW1vci5pZCwgdG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkLCBzdWJzY3JpYmVUb1ZpZGVvLCBzdWJzY3JpYmVUb0F1ZGlvKSApOwogIH07CgogIHRoaXMuanNlcFVuc3Vic2NyaWJlID0gZnVuY3Rpb24odG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLmpzZXBVbnN1YnNjcmliZShfcnVtb3IuaWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCkgKTsKICB9OwoKICB0aGlzLmpzZXBDYW5kaWRhdGUgPSBmdW5jdGlvbih0b0Nvbm5lY3Rpb25JZCwgc3RyZWFtSWQsIGNhbmRpZGF0ZSkgewogICAgdGhpcy5wdWJsaXNoKCBPVC5SYXB0b3IuTWVzc2FnZS5qc2VwQ2FuZGlkYXRlKF9ydW1vci5pZCwgdG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkLCBjYW5kaWRhdGUpICk7CiAgfTsKCiAgdGhpcy5qc2VwT2ZmZXIgPSBmdW5jdGlvbih0b0Nvbm5lY3Rpb25JZCwgc3RyZWFtSWQsIG9mZmVyU0RQKSB7CiAgICB0aGlzLnB1Ymxpc2goIE9ULlJhcHRvci5NZXNzYWdlLmpzZXBPZmZlcihfcnVtb3IuaWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgb2ZmZXJTRFApICk7CiAgfTsKCiAgdGhpcy5qc2VwQW5zd2VyID0gZnVuY3Rpb24odG9Db25uZWN0aW9uSWQsIHN0cmVhbUlkLCBhbnN3ZXJTRFApIHsKICAgIHRoaXMucHVibGlzaCggT1QuUmFwdG9yLk1lc3NhZ2UuanNlcEFuc3dlcihfcnVtb3IuaWQsIHRvQ29ubmVjdGlvbklkLCBzdHJlYW1JZCwgYW5zd2VyU0RQKSApOwogIH07CgoKICB0aGlzLnNpZ25hbCA9IGZ1bmN0aW9uKG9wdGlvbnMsIGNvbXBsZXRpb24pIHsKICAgIHZhciBzaWduYWwgPSBuZXcgT1QuU2lnbmFsKF9zZXNzaW9uSWQsIF9ydW1vci5pZCwgb3B0aW9ucyB8fCB7fSk7CgogICAgaWYgKCFzaWduYWwudmFsaWQpIHsKICAgICAgaWYgKGNvbXBsZXRpb24gJiYgT1QuJC5pc0Z1bmN0aW9uKGNvbXBsZXRpb24pKSB7CiAgICAgICAgY29tcGxldGlvbiggbmV3IFNpZ25hbEVycm9yKHNpZ25hbC5lcnJvci5jb2RlLCBzaWduYWwuZXJyb3IucmVhc29uLCBzaWduYWwudG9IYXNoKCkpICk7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLnB1Ymxpc2goIHNpZ25hbC50b1JhcHRvck1lc3NhZ2UoKSApOwogICAgaWYgKGNvbXBsZXRpb24gJiYgT1QuJC5pc0Z1bmN0aW9uKGNvbXBsZXRpb24pKSBjb21wbGV0aW9uKG51bGwsIHNpZ25hbC50b0hhc2goKSk7CiAgfTsKCiAgT1QuJC5kZWZpbmVHZXR0ZXJzKHRoaXMsIHsKICAgIGlkOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9ydW1vci5pZDsgfSwKICAgIGNhcGFiaWxpdGllczogZnVuY3Rpb24oKSB7IHJldHVybiBfY2FwYWJpbGl0aWVzOyB9LAogICAgc2Vzc2lvbklkOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uSWQ7IH0KICB9KTsKCiAgX2Rpc3BhdGNoZXIgPSBuZXcgKERpc3BhdGNoZXIgfHwgT1QuUmFwdG9yLkRpc3BhdGNoZXIpKHRoaXMsIG9uQ29ubmVjdENvbXBsZXRlKTsKfTsKCgp9KHRoaXMpKTsKKGZ1bmN0aW9uKGdsb2JhbCkgewoKLy8gQ29ubmVjdCBlcnJvciBjb2RlcyBhbmQgcmVhc29ucyB0aGF0IFJhcHRvciBjYW4gcmV0dXJuLgp2YXIgY29ubmVjdEVycm9yUmVhc29ucyA9IHsKICA0MDk6ICJUaGlzIFAyUCBzZXNzaW9uIGFscmVhZHkgaGFzIDIgcGFydGljaXBhbnRzLiIsCiAgNDEwOiAiVGhlIHNlc3Npb24gYWxyZWFkeSBoYXMgZm91ciBwYXJ0aWNpcGFudHMuIiwKICAxMDA0OiAiVGhlIHRva2VuIHBhc3NlZCBpcyBpbnZhbGlkLiIKfTsKCgovLyBAdG9kbyBoaWRlIHRoZXNlCk9ULnB1Ymxpc2hlcnMgPSBuZXcgT1QuQ29sbGVjdGlvbignZ3VpZCcpOyAgICAgICAgICAvLyBQdWJsaXNoZXJzIGFyZSBpZCdkIGJ5IHRoZWlyIGd1aWQKT1Quc3Vic2NyaWJlcnMgPSBuZXcgT1QuQ29sbGVjdGlvbignd2lkZ2V0SWQnKTsgICAgIC8vIFN1YnNjcmliZXJzIGFyZSBpZCdkIGJ5IHRoZWlyIHdpZGdldElkCk9ULnNlc3Npb25zID0gbmV3IE9ULkNvbGxlY3Rpb24oKTsKCmZ1bmN0aW9uIHBhcnNlU3RyZWFtKGRpY3QsIHNlc3Npb24pIHsKICB2YXIgc3RyZWFtID0gbmV3IE9ULlN0cmVhbSggZGljdC5zdHJlYW1JZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbi5jb25uZWN0aW9ucy5nZXQoZGljdC5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY3QubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljdC5zdHJlYW1EYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0LnR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY3QuY3JlYXRpb25UaW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0Lmhhc0F1ZGlvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0Lmhhc1ZpZGVvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0Lm9yaWVudGF0aW9uID8gZGljdC5vcmllbnRhdGlvbi52aWRlb09yaWVudGF0aW9uIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljdC5wZWVySWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY3QucXVhbGl0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljdC5vcmllbnRhdGlvbiA/IGRpY3Qub3JpZW50YXRpb24ud2lkdGggOiBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWN0Lm9yaWVudGF0aW9uID8gZGljdC5vcmllbnRhdGlvbi5oZWlnaHQgOiBudWxsICk7CgogIC8vIFRoaXMgaXMgYSBjb2RlIHNtZWxsLCBidXQgaXQncyBuZWNlc3NhcnkgZm9yIG5vdyBhcyB0aGUgcGFydCBvZiB0aGUgY29kZQogIC8vIHRoYXQgcmUtcGFyZW50cyBzdHJlYW1zIHRvIHB1Ymxpc2hlcnMgaXMgaW4gYSBkaWZmZXJlbnQgb2JqZWN0IHRoYXQgY2Fubm90CiAgLy8gYWNjZXNzIHRoZSByYXcgc3RyZWFtIHBhY2tldAogIGlmIChkaWN0LnB1Ymxpc2hlcklkKSB7CiAgICBzdHJlYW0ucHVibGlzaGVySWQgPSBkaWN0LnB1Ymxpc2hlcklkOwogIH0KCiAgcmV0dXJuIHN0cmVhbTsKfQoKZnVuY3Rpb24gcGFyc2VBbmRBZGRTdHJlYW1Ub1Nlc3Npb24oZGljdCwgc2Vzc2lvbikgewogIGlmIChzZXNzaW9uLnN0cmVhbXMuaGFzKGRpY3Quc3RyZWFtSWQpKSByZXR1cm47CgogIHZhciBzdHJlYW0gPSBwYXJzZVN0cmVhbShkaWN0LCBzZXNzaW9uKTsKICBzZXNzaW9uLnN0cmVhbXMuYWRkKCBzdHJlYW0gKTsKCiAgcmV0dXJuIHN0cmVhbTsKfQoKCk9ULlJhcHRvci5EaXNwYXRjaGVyID0gZnVuY3Rpb24gKHNvY2tldCwgY29ubmVjdGlvbkNvbXBsZXRpb24pIHsKICB0aGlzLnNvY2tldCA9IHNvY2tldDsKICB0aGlzLmNvbm5lY3Rpb25Db21wbGV0aW9uID0gY29ubmVjdGlvbkNvbXBsZXRpb247Cn07CgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2ggPSBmdW5jdGlvbihhZGRyZXNzZXMsIGVuY29kZWRNZXNzYWdlKSB7CiAgdmFyIG1lc3NhZ2UgPSBPVC5SYXB0b3IuZGVzZXJpYWxpemVNZXNzYWdlKGVuY29kZWRNZXNzYWdlKTsKCiAgaWYgKCFtZXNzYWdlLnR5cGVOYW1lKSB7CiAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoOiBJbnZhbGlkIG1lc3NhZ2UgdHlwZSAoIiArIG1lc3NhZ2UudHlwZSArICIpIik7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIW1lc3NhZ2UuYWN0aW9uTmFtZSkgewogICAgT1QuZXJyb3IoIk9ULlJhcHRvci5kaXNwYXRjaDogSW52YWxpZCBhY3Rpb24gKCIgKyBtZXNzYWdlLmFjdGlvbiArICIpIGZvciAiICsgbWVzc2FnZS50eXBlTmFtZSk7CiAgICBPVC5lcnJvcihtZXNzYWdlKTsKICAgIHJldHVybjsKICB9CgogIE9ULmRlYnVnKCJPVC5SYXB0b3IuZGlzcGF0Y2ggIiArIG1lc3NhZ2Uuc2lnbmF0dXJlICsgIjogIiArIGVuY29kZWRNZXNzYWdlKTsKCiAgc3dpdGNoKG1lc3NhZ2UudHlwZSkgewogICAgY2FzZSBPVC5SYXB0b3IuVHlwZXMuUlBDX1JFU1BPTlNFOgogICAgICB0aGlzLmRpc3BhdGNoUlBDUmVzcG9uc2UobWVzc2FnZSk7CiAgICAgIGJyZWFrOwoKICAgIGNhc2UgT1QuUmFwdG9yLlR5cGVzLkNPTk5FQ1RJT046CiAgICAgIHRoaXMuZGlzcGF0Y2hDb25uZWN0aW9uKG1lc3NhZ2UpOwogICAgICBicmVhazsKCiAgICBjYXNlIE9ULlJhcHRvci5UeXBlcy5DT05ORUNUSU9OQ09VTlQ6CiAgICAgIHRoaXMuZGlzcGF0Y2hDb25uZWN0aW9uQ291bnQobWVzc2FnZSk7CiAgICAgIGJyZWFrOwoKICAgIGNhc2UgT1QuUmFwdG9yLlR5cGVzLlNUUkVBTToKICAgICAgdGhpcy5kaXNwYXRjaFN0cmVhbShtZXNzYWdlKTsKICAgICAgYnJlYWs7CgogICAgY2FzZSBPVC5SYXB0b3IuVHlwZXMuU1VCU0NSSUJFUjoKICAgICAgdGhpcy5kaXNwYXRjaFN1YnNjcmliZXIobWVzc2FnZSk7CiAgICAgIGJyZWFrOwoKICAgIGNhc2UgT1QuUmFwdG9yLlR5cGVzLk1PREVSQVRJT046CiAgICAgIHRoaXMuZGlzcGF0Y2hNb2RlcmF0aW9uKG1lc3NhZ2UpOwogICAgICBicmVhazsKCiAgICBjYXNlIE9ULlJhcHRvci5UeXBlcy5KU0VQOgogICAgICB0aGlzLmRpc3BhdGNoSnNlcChtZXNzYWdlKTsKICAgICAgYnJlYWs7CgogICAgY2FzZSBPVC5SYXB0b3IuVHlwZXMuU0lHTkFMOgogICAgICB0aGlzLmRpc3BhdGNoU2lnbmFsKG1lc3NhZ2UpOwogICAgICBicmVhazsKCgoKICAgIGRlZmF1bHQ6CiAgICAgIE9ULndhcm4oIk9ULlJhcHRvci5kaXNwYXRjaDogVHlwZSAiICsgbWVzc2FnZS50eXBlTmFtZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIH0KfTsKCgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hSUENSZXNwb25zZSA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgc3dpdGNoIChtZXNzYWdlLmFjdGlvbikgewogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DT05ORUNUOgogICAgICBpZiAobWVzc2FnZS5wYXlsb2FkLmNvbm5lY3RTdWNjZXNzID09IGZhbHNlKSB7CiAgICAgICAgdmFyIGVycm9yID0gbmV3IE9ULkVycm9yKE9ULkV4Y2VwdGlvbkNvZGVzLkNPTk5FQ1RfUkVKRUNURUQsIGNvbm5lY3RFcnJvclJlYXNvbnNbbWVzc2FnZS5wYXlsb2FkLnJlYXNvbl0gfHwgIkZhaWxlZCB0byBjb25uZWN0Iik7CiAgICAgICAgdGhpcy5jb25uZWN0aW9uQ29tcGxldGlvbi5jYWxsKG51bGwsIGVycm9yKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICB0aGlzLnNvY2tldC5wdWJsaXNoKE9ULlJhcHRvci5NZXNzYWdlLmdldFNlc3Npb25TdGF0ZSh0aGlzLnNvY2tldC5pZCwgbWVzc2FnZS5wYXlsb2FkLnNlc3Npb25JZCwgdHJ1ZSkpOwogICAgICB9CiAgICAgIGJyZWFrOwoKCiAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlNUQVRFOgogICAgICB2YXIgc3RhdGUgPSBtZXNzYWdlLnBheWxvYWQudmFsdWUsCiAgICAgICAgICBzZXNzaW9uID0gT1Quc2Vzc2lvbnMuZ2V0KG1lc3NhZ2UucGF5bG9hZC5rZXkpLAogICAgICAgICAgY29ubmVjdGlvbjsKCiAgICAgIHN0YXRlLnN0cmVhbXMgPSBbXTsKICAgICAgc3RhdGUuY29ubmVjdGlvbnMgPSBbXTsKICAgICAgc3RhdGUuYXJjaGl2ZXMgPSBbXTsKCiAgICAgIGlmIChzdGF0ZS5oYXNPd25Qcm9wZXJ0eSgiQ09OTkVDVElPTlMiKSkgewogICAgICAgIGZvciAodmFyIGlkIGluIHN0YXRlLkNPTk5FQ1RJT05TKSB7CiAgICAgICAgICB2YXIgY29ubmVjdGlvbiA9IE9ULkNvbm5lY3Rpb24uZnJvbUhhc2goc3RhdGUuQ09OTkVDVElPTlNbaWRdKTsKICAgICAgICAgIHN0YXRlLmNvbm5lY3Rpb25zLnB1c2goY29ubmVjdGlvbik7CiAgICAgICAgICBzZXNzaW9uLmNvbm5lY3Rpb25zLmFkZChjb25uZWN0aW9uKQogICAgICAgIH0KCiAgICAgICAgZGVsZXRlIHN0YXRlLkNPTk5FQ1RJT05TOwogICAgICB9CgogICAgICBpZiAoc3RhdGUuaGFzT3duUHJvcGVydHkoIlNUUkVBTVMiKSkgewogICAgICAgIGZvciAodmFyIGlkIGluIHN0YXRlLlNUUkVBTVMpIHsKICAgICAgICAgIHN0YXRlLnN0cmVhbXMucHVzaCggcGFyc2VBbmRBZGRTdHJlYW1Ub1Nlc3Npb24oc3RhdGUuU1RSRUFNU1tpZF0sIHNlc3Npb24pICk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgc3RhdGUuU1RSRUFNUzsKICAgICAgfQoKCiAgICAgIHRoaXMuY29ubmVjdGlvbkNvbXBsZXRpb24uY2FsbChudWxsLCBudWxsLCBzdGF0ZSk7CiAgICAgIGJyZWFrOwoKCiAgICBkZWZhdWx0OgogICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIH0KfTsKCgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hDb25uZWN0aW9uID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICB2YXIgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChtZXNzYWdlLnBheWxvYWQudmFsdWUuc2Vzc2lvbklkKSwKICAgICAgY29ubmVjdGlvbjsKCiAgaWYgKCFzZXNzaW9uKSB7CiAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoOiBVbmFibGUgdG8gZGV0ZXJtaW5lIHNlc3Npb24gZm9yICIgKyBtZXNzYWdlLnBheWxvYWQudmFsdWUuc2Vzc2lvbklkICsgJyBvbiAnICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIG1lc3NhZ2UhIik7CiAgICAvLyBAdG9kbyBlcnJvcgogICAgcmV0dXJuOwogIH0KCiAgc3dpdGNoIChtZXNzYWdlLmFjdGlvbikgewogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DUkVBVEU6CiAgICAgIGNvbm5lY3Rpb24gPSBPVC5Db25uZWN0aW9uLmZyb21IYXNoKG1lc3NhZ2UucGF5bG9hZC52YWx1ZSk7CiAgICAgIGlmIChzZXNzaW9uLmNvbm5lY3Rpb24gJiYgY29ubmVjdGlvbi5pZCAhPT0gc2Vzc2lvbi5jb25uZWN0aW9uLmlkKSBzZXNzaW9uLmNvbm5lY3Rpb25zLmFkZCggY29ubmVjdGlvbiApOwogICAgICBicmVhazsKCgogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5ERUxFVEU6CiAgICAgIGNvbm5lY3Rpb24gPSBzZXNzaW9uLmNvbm5lY3Rpb25zLmdldChtZXNzYWdlLnBheWxvYWQudmFsdWUuY29ubmVjdGlvbklkKTsKICAgICAgY29ubmVjdGlvbi5kZXN0cm95KG1lc3NhZ2UucGF5bG9hZC5yZWFzb24pOwogICAgICBicmVhazsKCgogICAgZGVmYXVsdDoKICAgICAgT1Qud2FybigiT1QuUmFwdG9yLmRpc3BhdGNoOiAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIGlzIG5vdCBjdXJyZW50bHkgaW1wbGVtZW50ZWQiKTsKICB9Cn07CgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hDb25uZWN0aW9uQ291bnQgPSBmdW5jdGlvbiAobWVzc2FnZSkgewogIC8vIE5vdGU6IHdlIGRvbid0IHVzZSBhbnkgb2YgdGhpcyBpbiB0aGUgY2xpZW50IHJpZ2h0IG5vdy4KCiAgLy8gc3dpdGNoIChtZXNzYWdlLmFjdGlvbikgewogIC8vICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5VUERBVEU6CiAgLy8gICAgIGNvbm5lY3Rpb25Db3VudCA9IG1lc3NhZ2UucGF5bG9hZC52YWx1ZTsKICAvLyAgICAgT1QuZGVidWcoIk9ULlJhcHRvci5kaXNwYXRjaDogQ29ubmVjdGlvbiBjb3VudDogIiArIGNvbm5lY3Rpb25Db3VudCk7CiAgLy8gICAgIGJyZWFrOwoKCiAgLy8gICBkZWZhdWx0OgogIC8vICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIC8vIH0KfTsKCgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hTdHJlYW0gPSBmdW5jdGlvbiAobWVzc2FnZSkgewogIHZhciBrZXkgPSBtZXNzYWdlLnBheWxvYWQua2V5LnNwbGl0KCcvJyksCiAgICAgIHNlc3Npb25JZCA9IGtleVswXSwKICAgICAgc2Vzc2lvbiwKICAgICAgc3RyZWFtOwoKCiAgaWYgKHNlc3Npb25JZCkgc2Vzc2lvbiA9IE9ULnNlc3Npb25zLmdldChzZXNzaW9uSWQpOwoKICBpZiAoIXNlc3Npb24pIHsKICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6IFVuYWJsZSB0byBkZXRlcm1pbmUgc2Vzc2lvbklkLCBvciB0aGUgc2Vzc2lvbiBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgIC8vIEB0b2RvIGVycm9yCiAgICByZXR1cm47CiAgfQoKICBzd2l0Y2ggKG1lc3NhZ2UuYWN0aW9uKSB7CiAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlJFR0lTVEVSOgogICAgICBzdHJlYW0gPSBwYXJzZVN0cmVhbShtZXNzYWdlLnBheWxvYWQudmFsdWUsIHNlc3Npb24pOwoKICAgICAgLy8gQHRvZG8gcmVmYWN0b3IgdGhpcyBsYXRlcgogICAgICBpZiAoc3RyZWFtLnB1Ymxpc2hlcklkKSB7CiAgICAgICAgdmFyIHB1Ymxpc2hlciA9IE9ULnB1Ymxpc2hlcnMuZ2V0KHN0cmVhbS5wdWJsaXNoZXJJZCk7CgogICAgICAgIGlmIChwdWJsaXNoZXIpIHsKICAgICAgICAgIHB1Ymxpc2hlci5fLnN0cmVhbVJlZ2lzdGVyZWRIYW5kbGVyKHN0cmVhbSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgT1Qud2FybigiT1QuUmFwdG9yLmRpc3BhdGNoOiBDb3VsZCBmaW5kIGEgcHVibGlzaGVyICIgKyBzdHJlYW0ucHVibGlzaGVySWQgKyAiIGZvciAiICsgbWVzc2FnZS5zaWduYXR1cmUpOwogICAgICAgIH0KICAgICAgfQogICAgICBicmVhazsKCgogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DUkVBVEU6CiAgICAgIHBhcnNlQW5kQWRkU3RyZWFtVG9TZXNzaW9uKG1lc3NhZ2UucGF5bG9hZC52YWx1ZSwgc2Vzc2lvbikKICAgICAgYnJlYWs7CgoKICAgIGNhc2UgT1QuUmFwdG9yLkFjdGlvbnMuVVBEQVRFOgogICAgICBpZiAoa2V5WzFdKSBzdHJlYW0gPSBzZXNzaW9uLnN0cmVhbXMuZ2V0KGtleVsxXSk7CgogICAgICBpZiAoIXN0cmVhbSkgewogICAgICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6IFVuYWJsZSB0byBkZXRlcm1pbmUgc3RyZWFtSWQsIG9yIHRoZSBzdHJlYW0gZG9lcyBub3QgZXhpc3QsIGZvciAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIG1lc3NhZ2UhIik7CiAgICAgICAgLy8gQHRvZG8gZXJyb3IKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHN0cmVhbS51cGRhdGUoa2V5WzJdLCBtZXNzYWdlLnBheWxvYWQudmFsdWUpOwogICAgICBicmVhazsKCgogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5ERUxFVEU6CiAgICAgIGlmIChrZXlbMl0pIHN0cmVhbSA9IHNlc3Npb24uc3RyZWFtcy5nZXQoa2V5WzJdKTsKCiAgICAgIGlmICghc3RyZWFtKSB7CiAgICAgICAgT1QuZXJyb3IoIk9ULlJhcHRvci5kaXNwYXRjaDogVW5hYmxlIHRvIGRldGVybWluZSBzdHJlYW1JZCwgb3IgdGhlIHN0cmVhbSBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgICAgICAvLyBAdG9kbyBlcnJvcgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgc3RyZWFtLmRlc3Ryb3kobWVzc2FnZS5wYXlsb2FkLnJlYXNvbik7CiAgICAgIGJyZWFrOwoKCiAgICBkZWZhdWx0OgogICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIH0KfTsKCgoKT1QuUmFwdG9yLkRpc3BhdGNoZXIucHJvdG90eXBlLmRpc3BhdGNoTW9kZXJhdGlvbiA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgLy8gRm9yY2UgZGlzY29ubmVjdCBhbmQgdW5wdWJsaXNoIGFyZSBoYW5kbGVkIGluIENPTk5FQ1RJT046REVMRVRFIGFuZCBTVFJFQU06REVMRVRFIHJlc3BlY3RpdmVseS4KICByZXR1cm47CgogIC8vIHZhciBzZXNzaW9uID0gT1Quc2Vzc2lvbnMuZ2V0KHRoaXMuc29ja2V0LnNlc3Npb25JZCk7CgogIC8vIGlmICghc2Vzc2lvbikgewogIC8vICAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoOiAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIEVSUk9SIC0gc2Vzc2lvbklkIG11c3QgYmUgcHJvdmlkZWQgYW5kIGJlIHZhbGlkIik7CiAgLy8gICAgIHJldHVybjsKICAvLyB9CgogIC8vIHN3aXRjaCAobWVzc2FnZS5hY3Rpb24pIHsKICAvLyAgIGNhc2UgT1QuUmFwdG9yLkFjdGlvbnMuRk9SQ0VfRElTQ09OTkVDVDoKICAvLyAgICAgaWYgKCFtZXNzYWdlLnBheWxvYWQuY29ubmVjdGlvbklkKSB7CiAgLy8gICAgICAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoOiAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIEVSUk9SIC0gY29ubmVjdGlvbklkIG11c3QgYmUgcHJvdmlkZWQiKTsKICAvLyAgICAgICAgIHJldHVybjsKICAvLyAgICAgfQoKICAvLyAgICAgdmFyIGNvbm5lY3Rpb24gPSBzZXNzaW9uLmNvbm5lY3Rpb25zLmdldChtZXNzYWdlLnBheWxvYWQuY29ubmVjdGlvbklkKTsKICAvLyAgICAgY29ubmVjdGlvbi5kZXN0cm95KCJmb3JjZURpc2Nvbm5lY3RlZCIpOwogIC8vICAgICBicmVhazsKCgogIC8vICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5GT1JDRV9VTlBVQkxJU0g6CiAgLy8gICAgIGlmICghbWVzc2FnZS5wYXlsb2FkLnN0cmVhbUlkKSB7CiAgLy8gICAgICAgICBPVC5lcnJvcigiT1QuUmFwdG9yLmRpc3BhdGNoICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgRVJST1IgLSBzdHJlYW1JZCBtdXN0IGJlIHByb3ZpZGVkIik7CiAgLy8gICAgICAgICByZXR1cm47CiAgLy8gICAgIH0KCiAgLy8gICAgIHZhciBzdHJlYW0gPSBzZXNzaW9uLnN0cmVhbXMuZ2V0KG1lc3NhZ2UucGF5bG9hZC5zdHJlYW1JZCk7CiAgLy8gICAgIHN0cmVhbS5kZXN0cm95KCJmb3JjZVVucHVibGlzaGVkIik7CiAgLy8gICAgIGJyZWFrOwoKCiAgLy8gICBkZWZhdWx0OgogIC8vICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIC8vIH0KfTsKCgoKT1QuUmFwdG9yLkRpc3BhdGNoZXIucHJvdG90eXBlLmRpc3BhdGNoSnNlcCA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgdmFyIGZyb21Db25uZWN0aW9uLAogICAgICBzdHJlYW1JZCA9IG1lc3NhZ2UucGF5bG9hZC5zdHJlYW1JZCwKICAgICAgYWN0b3JzOwoKICBzd2l0Y2ggKG1lc3NhZ2UuYWN0aW9uKSB7CiAgICAvLyBNZXNzYWdlcyBmb3IgU3Vic2NyaWJlcnMKICAgIGNhc2UgT1QuUmFwdG9yLkFjdGlvbnMuT0ZGRVI6CiAgICAgIGFjdG9ycyA9IFtdOwogICAgICB2YXIgc3Vic2NyaWJlciA9IE9ULnN1YnNjcmliZXJzLmZpbmQoe3N0cmVhbUlkOiBzdHJlYW1JZH0pOwogICAgICBpZiAoc3Vic2NyaWJlcikgYWN0b3JzLnB1c2goc3Vic2NyaWJlcik7CiAgICAgIGJyZWFrOwoKCiAgICAvLyBNZXNzYWdlcyBmb3IgUHVibGlzaGVycwogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5BTlNXRVI6CiAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlBSQU5TV0VSOgogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5TVUJTQ1JJQkU6CiAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlVOU1VCU0NSSUJFOgogICAgICBhY3RvcnMgPSBPVC5wdWJsaXNoZXJzLndoZXJlKHtzdHJlYW1JZDogc3RyZWFtSWR9KTsKICAgICAgYnJlYWs7CgoKICAgIC8vIE1lc3NhZ2VzIGZvciBQdWJsaXNoZXJzIGFuZCBTdWJzY3JpYmVycwogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DQU5ESURBVEU6CiAgICAgIC8vIHNlbmQgdG8gd2hpY2hldmVyIG9mIHlvdXIgcHVibGlzaGVyIG9yIHN1YnNjcmliZXJzIGFyZSBzdWJzY3JpYmluZy9wdWJsaXNoaW5nIHRoYXQgc3RyZWFtCiAgICAgIGFjdG9ycyA9IE9ULnB1Ymxpc2hlcnMud2hlcmUoe3N0cmVhbUlkOiBzdHJlYW1JZH0pLmNvbmNhdChPVC5zdWJzY3JpYmVycy53aGVyZSh7c3RyZWFtSWQ6IHN0cmVhbUlkfSkpOwogICAgICBicmVhazsKCgogICAgZGVmYXVsdDoKICAgICAgT1Qud2FybigiT1QuUmFwdG9yLmRpc3BhdGNoOiAiICsgbWVzc2FnZS5zaWduYXR1cmUgKyAiIGlzIG5vdCBjdXJyZW50bHkgaW1wbGVtZW50ZWQiKTsKICAgICAgcmV0dXJuOwogIH0KCiAgaWYgKGFjdG9ycy5sZW5ndGgpIHsKICAgIC8vIFRoaXMgaXMgYSBiaXQgaGFja3kuIFdlIGRvbid0IGhhdmUgdGhlIHNlc3Npb24gaW4gdGhlIG1lc3NhZ2Ugc28gd2UgaXRlcmF0ZQogICAgLy8gdW50aWwgd2UgZmluZCB0aGUgYWN0b3IgdGhhdCB0aGUgbWVzc2FnZSByZWxhdGVzIHRvIHRoaXMgc3RyZWFtLCBhbmQgdGhlbgogICAgLy8gd2UgZ3JhYiB0aGUgc2Vzc2lvbiBmcm9tIGl0LgogICAgZnJvbUNvbm5lY3Rpb24gPSBhY3RvcnNbMF0uc2Vzc2lvbi5jb25uZWN0aW9ucy5nZXQobWVzc2FnZS5wYXlsb2FkLmZyb21BZGRyZXNzKTsKICAgIGlmKCFmcm9tQ29ubmVjdGlvbiAmJiBtZXNzYWdlLnBheWxvYWQuZnJvbUFkZHJlc3MubWF0Y2goL15zeW1waG9ueVwuLykpIHsKICAgICAgZnJvbUNvbm5lY3Rpb24gPSBuZXcgT1QuQ29ubmVjdGlvbihtZXNzYWdlLnBheWxvYWQuZnJvbUFkZHJlc3MsCiAgICAgICAgICBEYXRlLm5vdygpLCBudWxsLCB7IHN1cHBvcnRzV2ViUlRDOiB0cnVlIH0pOwogICAgICBhY3RvcnNbMF0uc2Vzc2lvbi5jb25uZWN0aW9ucy5hZGQoZnJvbUNvbm5lY3Rpb24pOwogICAgfSBlbHNlIGlmKCFmcm9tQ29ubmVjdGlvbikgewogICAgICBPVC53YXJuKCJNZXNzc2FnZSBjb21lcyBmcm9tIGEgY29ubmVjdGlvbiAoIiArIG1lc3NhZ2UucGF5bG9hZC5mcm9tQWRkcmVzcyArICIpIHRoYXQgd2UgZG8gbm90IGtub3cgYWJvdXQuIik7CiAgICB9CiAgfQoKICBhY3RvcnMuZm9yRWFjaChmdW5jdGlvbihhY3RvcikgewogICAgYWN0b3IucHJvY2Vzc01lc3NhZ2UobWVzc2FnZS5hY3Rpb24sIGZyb21Db25uZWN0aW9uLCBtZXNzYWdlLnBheWxvYWQpOwogIH0pOwp9OwoKCi8vIFRoZSBwYXlsb2FkIGlzOgovLyAgICBrZXk6ICAgICJ7c2Vzc2lvbl9pZH19L1NVQlNDUklCRVIve3N0cmVhbV9pZH0ve3N1YnNjcmliZXJfaWR9IgovLyAgICB2YWx1ZTogIEludGVnZXIgICAgICAgICAgICAgICAgIHsgVmFsdWUgYmV0d2VlbiAwIGFuZCBzb21lIG5vbi16ZXJvIG1heCAoIE1heCBub3QgZGVjaWRlZCB5ZXQgKSAgfSoKLy8KLy8gKiBUaGUgY29tcGxldGUgcmFuZ2UgbmVlZCBub3QgYmUgdXNlZCBidXQgdGhpcyBwcm92aXNpb24gaXMganVzdCBzbyB0aGF0IGZ1dHVyZSBmYWNpbmcgd2UgbWlnaHQgbmVlZCB0byBoYXZlIG1vcmUgZ3JhbnVsYXJpdHkuCi8vCk9ULlJhcHRvci5EaXNwYXRjaGVyLnByb3RvdHlwZS5kaXNwYXRjaFN1YnNjcmliZXIgPSBmdW5jdGlvbiAobWVzc2FnZSkgewogIHZhciBrZXkgPSBtZXNzYWdlLnBheWxvYWQua2V5LnNwbGl0KCcvJyksCiAgICAgIHNlc3Npb24gPSBPVC5zZXNzaW9ucy5nZXQoa2V5WzBdKSwKICAgICAgc3Vic2NyaWJlciwKICAgICAgc3RyZWFtOwoKICBpZiAoIXNlc3Npb24pIHsKICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6IFVuYWJsZSB0byBkZXRlcm1pbmUgc2Vzc2lvbklkLCBvciB0aGUgc2Vzc2lvbiBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgIC8vIEB0b2RvIGVycm9yCiAgICByZXR1cm47CiAgfQoKICBzdHJlYW0gPSBrZXlbMl0gPyBzZXNzaW9uLnN0cmVhbXMuZ2V0KGtleVsyXSkgOiBudWxsOwoKICBpZiAoIXN0cmVhbSkgewogICAgT1QuZXJyb3IoIk9ULlJhcHRvci5kaXNwYXRjaDogVW5hYmxlIHRvIGRldGVybWluZSBzdHJlYW1JZCwgb3IgdGhlIHN0cmVhbSBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgIC8vIEB0b2RvIGVycm9yCiAgICByZXR1cm47CiAgfQoKICAvLyBGaW5kIHRoZSBzdWJzY3JpYmVyIHRoYXQgbWF0Y2hlcyB0aGlzIHN0cmVhbSwgY29ubmVjdGlvbiwgYW5kIHNlc3Npb24KICBzdWJzY3JpYmVyID0gT1Quc3Vic2NyaWJlcnMuZmluZChmdW5jdGlvbihzdWJzY3JpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdWJzY3JpYmVyLnN0cmVhbUlkID09PSBzdHJlYW0uaWQKICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBzdWJzY3JpYmVyLnNlc3Npb24uaWQgPT09IHNlc3Npb24uaWQKICAgICAgICAgICAgICAgIH0pOwoKICBpZiAoIXN1YnNjcmliZXIpIHsKICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6IFVuYWJsZSB0byBkZXRlcm1pbmUgc3Vic2NyaWJlcklkLCBvciB0aGUgc3Vic2NyaWJlciBkb2VzIG5vdCBleGlzdCwgZm9yICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgbWVzc2FnZSEiKTsKICAgIC8vIEB0b2RvIGVycm9yCiAgICByZXR1cm47CiAgfQoKCiAgc3dpdGNoIChtZXNzYWdlLmFjdGlvbikgewogICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5RVUFMSVRZX0NIQU5HRUQ6CiAgICAgIHN1YnNjcmliZXIudXBkYXRlUXVhbGl0eShwYXJzZUludChtZXNzYWdlLnBheWxvYWQudmFsdWUsIDEwKSk7CiAgICAgIGJyZWFrOwoKCiAgICBkZWZhdWx0OgogICAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogIH0KfTsKCgpPVC5SYXB0b3IuRGlzcGF0Y2hlci5wcm90b3R5cGUuZGlzcGF0Y2hTaWduYWwgPSBmdW5jdGlvbiAobWVzc2FnZSkgewogIGlmIChtZXNzYWdlLmFjdGlvbiAhPT0gT1QuUmFwdG9yLkFjdGlvbnMuU0lHTkFMKSB7CiAgICBPVC53YXJuKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgaXMgbm90IGN1cnJlbnRseSBpbXBsZW1lbnRlZCIpOwogICAgcmV0dXJuOwogIH0KCiAgdmFyIHNlc3Npb24gPSBPVC5zZXNzaW9ucy5nZXQodGhpcy5zb2NrZXQuc2Vzc2lvbklkKTsKCiAgaWYgKCFzZXNzaW9uKSB7CiAgICAgIE9ULmVycm9yKCJPVC5SYXB0b3IuZGlzcGF0Y2g6ICIgKyBtZXNzYWdlLnNpZ25hdHVyZSArICIgRVJST1IgLSBzZXNzaW9uSWQgbXVzdCBiZSBwcm92aWRlZCBhbmQgYmUgdmFsaWQiKTsKICAgICAgcmV0dXJuOwogIH0KCiAgc2Vzc2lvbi5fLmRpc3BhdGNoU2lnbmFsKCBzZXNzaW9uLmNvbm5lY3Rpb25zLmdldChtZXNzYWdlLnBheWxvYWQuZnJvbUFkZHJlc3MpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5wYXlsb2FkLnR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnBheWxvYWQuZGF0YSk7Cn07Cgp9KHRoaXMpKTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gSGVscGVyIHRvIHN5bmNocm9uaXNlIHNldmVyYWwgc3RhcnR1cCB0YXNrcyBhbmQgdGhlbiBkaXNwYXRjaCBhIHVuaWZpZWQKLy8gJ2VudkxvYWRlZCcgZXZlbnQuCi8vCi8vIFRoaXMgZGVwZW5kcyBvbjoKLy8gKiBPVAovLyAqIE9ULkNvbmZpZwovLwpmdW5jdGlvbiBFbnZpcm9ubWVudExvYWRlcigpIHsKICAgIHZhciBfY29uZmlnUmVhZHkgPSBmYWxzZSwKICAgICAgICBfZG9tUmVhZHkgPSBmYWxzZSwKCiAgICAgICAgaXNSZWFkeSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX2RvbVJlYWR5ICYmIF9jb25maWdSZWFkeTsKICAgICAgICB9LAoKICAgICAgICBvbkxvYWRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoaXNSZWFkeSgpKSB7CiAgICAgICAgICAgICAgICBPVC5kaXNwYXRjaEV2ZW50KG5ldyBPVC5FbnZMb2FkZWRFdmVudChPVC5FdmVudC5uYW1lcy5FTlZfTE9BREVEKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBvbkRvbVJlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIF9kb21SZWFkeSA9IHRydWU7CgogICAgICAgICAgICAvLyBUaGlzIGlzIG1ha2luZyBhbiBhc3N1bXB0aW9uIGFib3V0IHRoZXJlIGJlaW5nIG9ubHkgb25lICJ3aW5kb3ciCiAgICAgICAgICAgIC8vIHRoYXQgd2UgY2FyZSBhYm91dC4KICAgICAgICAgICAgT1QuJC5vbih3aW5kb3csICJiZWZvcmV1bmxvYWQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIE9ULnB1Ymxpc2hlcnMuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgT1Quc3Vic2NyaWJlcnMuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgT1Quc2Vzc2lvbnMuZGVzdHJveSgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFRoZSBEeW5hbWljIENvbmZpZyB3b24ndCBsb2FkIHVudGlsIHRoZSBET00gaXMgcmVhZHkKICAgICAgICAgICAgT1QuQ29uZmlnLmxvYWQoT1QucHJvcGVydGllcy5jb25maWdVUkwpOwoKICAgICAgICAgICAgb25Mb2FkZWQoKTsKICAgICAgICB9LAoKICAgICAgICBjb25maWdMb2FkZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2NvbmZpZ1JlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgT1QuQ29uZmlnLm9mZignZHluYW1pY0NvbmZpZ0NoYW5nZWQnLCBjb25maWdMb2FkZWQpOwogICAgICAgICAgICBPVC5Db25maWcub2ZmKCdkeW5hbWljQ29uZmlnTG9hZEZhaWxlZCcsIGNvbmZpZ0xvYWRGYWlsZWQpOwoKICAgICAgICAgICAgb25Mb2FkZWQoKTsKICAgICAgICB9LAoKICAgICAgICBjb25maWdMb2FkRmFpbGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbmZpZ0xvYWRlZCgpOwogICAgICAgIH07CgogICAgT1QuQ29uZmlnLm9uKCdkeW5hbWljQ29uZmlnQ2hhbmdlZCcsIGNvbmZpZ0xvYWRlZCk7CiAgICBPVC5Db25maWcub24oJ2R5bmFtaWNDb25maWdMb2FkRmFpbGVkJywgY29uZmlnTG9hZEZhaWxlZCk7CiAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiIHx8IChkb2N1bWVudC5yZWFkeVN0YXRlID09ICJpbnRlcmFjdGl2ZSIgJiYgZG9jdW1lbnQuYm9keSkpIHsKICAgICAgICBvbkRvbVJlYWR5KCk7CiAgICB9IGVsc2UgewogICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBvbkRvbVJlYWR5LCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAvLyBUaGlzIGlzIHNvIG9uTG9hZCB3b3JrcyBpbiBJRSwgcHJpbWFyaWx5IHNvIHdlIGNhbiBzaG93IHRoZSB1cGdyYWRlIHRvIENocm9tZSBwb3B1cAogICAgICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiKSBvbkRvbVJlYWR5KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICB0aGlzLm9uTG9hZCA9IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgaWYgKGlzUmVhZHkoKSkgewogICAgICAgICAgICBjYigpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBPVC5vbihPVC5FdmVudC5uYW1lcy5FTlZfTE9BREVELCBjYik7CiAgICB9Owp9Cgp2YXIgRW52TG9hZGVyID0gbmV3IEVudmlyb25tZW50TG9hZGVyKCk7CgpPVC5vbkxvYWQgPSBmdW5jdGlvbihjYiwgY29udGV4dCkgewogICAgaWYgKCFjb250ZXh0KSB7CiAgICAgICAgRW52TG9hZGVyLm9uTG9hZChjYik7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBFbnZMb2FkZXIub25Mb2FkKAogICAgICAgICAgICBjYi5iaW5kKGNvbnRleHQpCiAgICAgICAgKTsKICAgIH0KfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCk9ULkVycm9yID0gZnVuY3Rpb24oY29kZSwgbWVzc2FnZSkgewogICAgdGhpcy5jb2RlID0gY29kZTsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7Cn07Cgp2YXIgZXJyb3JzQ29kZXNUb1RpdGxlID0gewogICAgMTAwMDogIkZhaWxlZCBUbyBMb2FkIiwKICAgIDEwMDQ6ICJBdXRoZW50aWNhdGlvbiBlcnJvciIsCiAgICAxMDA1OiAiSW52YWxpZCBTZXNzaW9uIElEIiwKICAgIDEwMDY6ICJDb25uZWN0IEZhaWxlZCIsCiAgICAxMDA3OiAiQ29ubmVjdCBSZWplY3RlZCIsCiAgICAxMDA4OiAiQ29ubmVjdCBUaW1lLW91dCIsCiAgICAxMDA5OiAiU2VjdXJpdHkgRXJyb3IiLAogICAgMTAxMDogIk5vdCBDb25uZWN0ZWQiLAogICAgMTAxMTogIkludmFsaWQgUGFyYW1ldGVyIiwKICAgIDEwMTI6ICJQZWVyLXRvLXBlZXIgU3RyZWFtIFBsYXkgRmFpbGVkIiwKICAgIDEwMTM6ICJDb25uZWN0aW9uIEZhaWxlZCIsCiAgICAxMDE0OiAiQVBJIFJlc3BvbnNlIEZhaWx1cmUiLAogICAgMTUwMDogIlVuYWJsZSB0byBQdWJsaXNoIiwKICAgIDE1MTA6ICJVbmFibGUgdG8gU2lnbmFsIiwKICAgIDE1MjA6ICJVbmFibGUgdG8gRm9yY2UgRGlzY29ubmVjdCIsCiAgICAxNTMwOiAiVW5hYmxlIHRvIEZvcmNlIFVucHVibGlzaCIsCiAgICAxNTQwOiAiVW5hYmxlIHRvIHJlY29yZCBhcmNoaXZlIiwKICAgIDE1NTA6ICJVbmFibGUgdG8gcGxheSBiYWNrIGFyY2hpdmUiLAogICAgMTU2MDogIlVuYWJsZSB0byBjcmVhdGUgYXJjaGl2ZSIsCiAgICAxNTcwOiAiVW5hYmxlIHRvIGxvYWQgYXJjaGl2ZSIsCiAgICAyMDAwOiAiSW50ZXJuYWwgRXJyb3IiLAogICAgMjAwMTogIkVtYmVkIEZhaWxlZCIsCiAgICAzMDAwOiAiQXJjaGl2ZSBsb2FkIGV4Y2VwdGlvbiIsCiAgICAzMDAxOiAiQXJjaGl2ZSBjcmVhdGUgZXhjZXB0aW9uIiwKICAgIDMwMDI6ICJQbGF5YmFjayBzdG9wIGV4Y2VwdGlvbiIsCiAgICAzMDAzOiAiUGxheWJhY2sgc3RhcnQgZXhjZXB0aW9uIiwKICAgIDMwMDQ6ICJSZWNvcmQgc3RhcnQgZXhjZXB0aW9uIiwKICAgIDMwMDU6ICJSZWNvcmQgc3RvcCBleGNlcHRpb24iLAogICAgMzAwNjogIkFyY2hpdmUgbG9hZCBleGNlcHRpb24iLAogICAgMzAwNzogIlNlc3Npb24gcmVjb3JkaW5nIGluIHByb2dyZXNzIiwKICAgIDMwMDg6ICJBcmNoaXZlIHJlY29yZGluZyBpbnRlcm5hbCBmYWlsdXJlIiwKICAgIDQwMDA6ICJXZWJTb2NrZXQgQ29ubmVjdGlvbiBGYWlsZWQiLAogICAgNDAwMTogIldlYlNvY2tldCBOZXR3b3JrIERpc2Nvbm5lY3RlZCIKfTsKCnZhciBhbmFseXRpY3M7CgpmdW5jdGlvbiBfZXhjZXB0aW9uSGFuZGxlcihjb21wb25lbnQsIG1zZywgZXJyb3JDb2RlLCBjb250ZXh0KSB7CiAgICB2YXIgdGl0bGUgPSBlcnJvcnNDb2Rlc1RvVGl0bGVbZXJyb3JDb2RlXSwKICAgICAgICBjb250ZXh0Q29weSA9IGNvbnRleHQgPyBPVC4kLmNsb25lKGNvbnRleHQpIDoge307CgogICAgT1QuZXJyb3IoIlRCLmV4Y2VwdGlvbiA6OiB0aXRsZTogIiArIHRpdGxlICsgIiAoIiArIGVycm9yQ29kZSArICIpIG1zZzogIiArIG1zZyk7CgogICAgaWYgKCFjb250ZXh0Q29weS5wYXJ0bmVySWQpIGNvbnRleHRDb3B5LnBhcnRuZXJJZCA9IE9ULkFQSUtFWTsKCiAgICB0cnkgewogICAgICAgIGlmICghYW5hbHl0aWNzKSBhbmFseXRpY3MgPSBuZXcgT1QuQW5hbHl0aWNzKCk7CiAgICAgICAgYW5hbHl0aWNzLmxvZ0Vycm9yKGVycm9yQ29kZSwgJ3RiLmV4Y2VwdGlvbicsIHRpdGxlLCB7ZGV0YWlsczptc2d9LCBjb250ZXh0Q29weSk7CgogICAgICAgIE9ULmRpc3BhdGNoRXZlbnQoCiAgICAgICAgICAgIG5ldyBPVC5FeGNlcHRpb25FdmVudChPVC5FdmVudC5uYW1lcy5FWENFUFRJT04sIG1zZywgdGl0bGUsIGVycm9yQ29kZSwgY29tcG9uZW50LCBjb21wb25lbnQpCiAgICAgICAgKTsKICAgIH0gY2F0Y2goZXJyKSB7CiAgICAgICAgT1QuZXJyb3IoIlRCLmV4Y2VwdGlvbiA6OiBGYWlsZWQgdG8gZGlzcGF0Y2ggZXhjZXB0aW9uIC0gIiArIGVyci50b1N0cmluZygpKTsKICAgICAgICAvLyBEb24ndCB0aHJvdyBhbiBlcnJvciBiZWNhdXNlIHRoaXMgaXMgYXN5bmNocm9ub3VzCiAgICAgICAgLy8gZG9uJ3QgZG8gYW4gZXhjZXB0aW9uSGFuZGxlciBiZWNhdXNlIHRoYXQgd291bGQgYmUgcmVjdXJzaXZlCiAgICB9Cn0KCi8vIEB0b2RvIHJlZG8gdGhpcyB3aGVuIHdlIGhhdmUgdGltZSB0byB0aWR5IHVwCi8vCi8vIEBleGFtcGxlCi8vCi8vICBUQi5oYW5kbGVKc0V4Y2VwdGlvbigiRGVzY3JpcHRpdmUgZXJyb3IgbWVzc2FnZSIsIDIwMDAsIHsKLy8gICAgICBzZXNzaW9uOiBzZXNzaW9uLAovLyAgICAgIHRhcmdldDogc3RyZWFtfHB1Ymxpc2hlcnxzdWJzY3JpYmVyfHNlc3Npb258ZXRjCi8vICB9KTsKLy8KT1QuaGFuZGxlSnNFeGNlcHRpb24gPSBmdW5jdGlvbihlcnJvck1zZywgY29kZSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgdmFyIGNvbnRleHQsCiAgICAgICAgc2Vzc2lvbiA9IG9wdGlvbnMuc2Vzc2lvbjsKCiAgICBpZiAoc2Vzc2lvbikgewogICAgICAgIGNvbnRleHQgPSB7CiAgICAgICAgICAgIHNlc3Npb25JZDogc2Vzc2lvbi5zZXNzaW9uSWQKICAgICAgICB9OwoKICAgICAgICBpZiAoc2Vzc2lvbi5jb25uZWN0ZWQpIGNvbnRleHQuY29ubmVjdGlvbklkID0gc2Vzc2lvbi5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDsKICAgICAgICBpZiAoIW9wdGlvbnMudGFyZ2V0KSBvcHRpb25zLnRhcmdldCA9IHNlc3Npb247CiAgICB9CiAgICBlbHNlIGlmIChvcHRpb25zLnNlc3Npb25JZCkgewogICAgICAgIGNvbnRleHQgPSB7CiAgICAgICAgICAgIHNlc3Npb25JZDogb3B0aW9ucy5zZXNzaW9uSWQKICAgICAgICB9OwoKICAgICAgICBpZiAoIW9wdGlvbnMudGFyZ2V0KSBvcHRpb25zLnRhcmdldCA9IG51bGw7CiAgICB9CgogICAgX2V4Y2VwdGlvbkhhbmRsZXIob3B0aW9ucy50YXJnZXQsIGVycm9yTXNnLCBjb2RlLCBjb250ZXh0KTsKfTsKCgovLyBAdG9kbyByZWRvIHRoaXMgd2hlbiB3ZSBoYXZlIHRpbWUgdG8gdGlkeSB1cAovLwovLyBQdWJsaWMgY2FsbGJhY2sgZm9yIGV4Y2VwdGlvbnMgZnJvbSBGbGFzaC4KLy8KLy8gQ2FsbGVkIGZyb20gRmxhc2ggbGlrZToKLy8gIFRCLmV4Y2VwdGlvbkhhbmRsZXIoJ3B1Ymxpc2hlcl8xMjM0LDEyMzQnLCAiRGVzY3JpcHRpdmUgRXJyb3IgTWVzc2FnZSIsICJFcnJvciBUaXRsZSIsIDIwMDAsIGNvbnRleHRPYmopCi8vCk9ULmV4Y2VwdGlvbkhhbmRsZXIgPSBmdW5jdGlvbihjb21wb25lbnRJZCwgbXNnLCBlcnJvclRpdGxlLCBlcnJvckNvZGUsIGNvbnRleHQpIHsKICAgIHZhciB0YXJnZXQ7CgogICAgaWYgKGNvbXBvbmVudElkKSB7CiAgICAgICAgdGFyZ2V0ID0gT1QuY29tcG9uZW50c1tjb21wb25lbnRJZF07CgogICAgICAgIGlmICghdGFyZ2V0KSB7CiAgICAgICAgICAgIE9ULndhcm4oIkNvdWxkIG5vdCBmaW5kIHRoZSBjb21wb25lbnQgd2l0aCBjb21wb25lbnQgSUQgIiArIGNvbXBvbmVudElkKTsKICAgICAgICB9CiAgICB9CgogICAgX2V4Y2VwdGlvbkhhbmRsZXIodGFyZ2V0LCBtc2csIGVycm9yQ29kZSwgY29udGV4dCk7Cn07Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7CgpPVC5Db25uZWN0aW9uQ2FwYWJpbGl0aWVzID0gZnVuY3Rpb24oY2FwYWJpbGl0aWVzSGFzaCkgewogICAgLy8gUHJpdmF0ZSBoZWxwZXIgbWV0aG9kcwogICAgdmFyIGNhc3RDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbihjYXBhYmlsaXRpZXNIYXNoKSB7CiAgICAgICAgICAgIGNhcGFiaWxpdGllc0hhc2guc3VwcG9ydHNXZWJSVEMgPSBPVC4kLmNhc3RUb0Jvb2xlYW4oY2FwYWJpbGl0aWVzSGFzaC5zdXBwb3J0c1dlYlJUQyk7CgogICAgICAgICAgICByZXR1cm4gY2FwYWJpbGl0aWVzSGFzaDsKICAgICAgICB9OwoKCiAgICAvLyBQcml2YXRlIGRhdGEKICAgIHZhciBfY2FwcyA9IGNhc3RDYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzSGFzaCk7CgoKICAgIHRoaXMuc3VwcG9ydHNXZWJSVEMgPSBfY2Fwcy5zdXBwb3J0c1dlYlJUQzsKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8qKgogKiBUaGUgQ29ubmVjdGlvbiBvYmplY3QgcmVwcmVzZW50cyBhIGNvbm5lY3Rpb24gdG8gYW4gT3BlblRvayBzZXNzaW9uLgogKiBUaGUgU2Vzc2lvbiBvYmplY3QgaGFzIGEgPGNvZGU+Y29ubmVjdGlvbjwvY29kZT4gcHJvcGVydHkgdGhhdCBpcyBhIENvbm5lY3Rpb24gb2JqZWN0LgogKiBJdCByZXByZXNlbnRzIHRoZSBsb2NhbCBjbGllbnQncyBjb25uZWN0aW9uLiAoQSBjbGllbnQgb25seSBoYXMgYSBjb25uZWN0aW9uIG9uY2UgdGhlCiAqIGNsaWVudCBoYXMgc3VjY2Vzc2Z1bGx5IGNhbGxlZCB0aGUgPGNvZGU+Y29ubmVjdCgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIHtAbGluayBTZXNzaW9ufSBvYmplY3QuKQogKiBUaGUgU3RyZWFtIG9iamVjdCBoYXMgYSA8Y29kZT5jb25uZWN0aW9uPC9jb2RlPiBwcm9wZXJ0eSB0aGF0IGlzIGEgQ29ubmVjdGlvbiBvYmplY3QuCiAqIEl0IHJlcHJlc2VudHMgdGhlIHN0cmVhbSBwdWJsaXNoZXIncyBjb25uZWN0aW9uLgogKgogKiBAY2xhc3MgQ29ubmVjdGlvbgogKiBAcHJvcGVydHkge1N0cmluZ30gaWQgVGhlIElEIG9mIHRoaXMgY29ubmVjdGlvbi4KICogQHByb3BlcnR5IHtOdW1iZXJ9IGNyZWF0aW9uVGltZSBUaGUgdGltZXN0YW1wIGZvciB0aGUgY3JlYXRpb24gb2YgdGhlIGNvbm5lY3Rpb24uIFRoaXMgdmFsdWUgaXMgY2FsY3VsYXRlZCBpbiBtaWxsaXNlY29uZHMuCiAgWW91IGNhbiBjb252ZXJ0IHRoaXMgdmFsdWUgdG8gYSBEYXRlIG9iamVjdCBieSBjYWxsaW5nIDxjb2RlPm5ldyBEYXRlKGNyZWF0aW9uVGltZSk8L2NvZGU+LCB3aGVyZSA8Y29kZT5jcmVhdGlvblRpbWU8L2NvZGU+CiAgaXMgdGhlIDxjb2RlPmNyZWF0aW9uVGltZTwvY29kZT4gcHJvcGVydHkgb2YgdGhlIENvbm5lY3Rpb24gb2JqZWN0LgogKiBAcHJvcGVydHkge1N0cmluZ30gZGF0YSAgQSBzdHJpbmcgY29udGFpbmluZyBtZXRhZGF0YSBkZXNjcmliaW5nIHRoZQogIGNvbm5lY3Rpb24uIFdoZW4geW91IGdlbmVyYXRlIGEgdXNlciB0b2tlbiBzdHJpbmcgcGFzcyB0aGUgY29ubmVjdGlvbiBkYXRhIHN0cmluZyB0byB0aGUKICA8Y29kZT5nZW5lcmF0ZV90b2tlbigpPC9jb2RlPiBtZXRob2Qgb2Ygb3VyCiAgPGEgaHJlZj0iL29wZW50b2svbGlicmFyaWVzL3NlcnZlci8iPnNlcnZlci1zaWRlIGxpYnJhcmllczwvYT4uIFlvdSBjYW4gYWxzbyBnZW5lcmF0ZSBhIHRva2VuIGFuZCBkZWZpbmUgY29ubmVjdGlvbiBkYXRhIG9uIHRoZQogIDxhIGhyZWY9Imh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMiPkRhc2hib2FyZDwvYT4gcGFnZS4KICovCk9ULkNvbm5lY3Rpb24gPSBmdW5jdGlvbihpZCwgY3JlYXRpb25UaW1lLCBkYXRhLCBjYXBhYmlsaXRpZXNIYXNoKSB7CiAgICB2YXIgZGVzdHJveWVkUmVhc29uOwoKICAgIHRoaXMuaWQgPSB0aGlzLmNvbm5lY3Rpb25JZCA9IGlkOwogICAgdGhpcy5jcmVhdGlvblRpbWUgPSBjcmVhdGlvblRpbWUgPyBOdW1iZXIoY3JlYXRpb25UaW1lKSA6IG51bGw7CiAgICB0aGlzLmRhdGEgPSBkYXRhOwogICAgdGhpcy5jYXBhYmlsaXRpZXMgPSBuZXcgT1QuQ29ubmVjdGlvbkNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNIYXNoKTsKICAgIHRoaXMucXVhbGl0eSA9IG51bGw7CgogICAgT1QuJC5ldmVudGluZyh0aGlzKTsKCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbihyZWFzb24sIHF1aWV0KSB7CiAgICAgICAgZGVzdHJveWVkUmVhc29uID0gcmVhc29uIHx8ICdjbGllbnREaXNjb25uZWN0ZWQnOwoKICAgICAgICBpZiAocXVpZXQgIT09IHRydWUpIHsKICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KAogICAgICAgICAgICAgIG5ldyBPVC5EZXN0cm95ZWRFdmVudCgKICAgICAgICAgICAgICAgICdkZXN0cm95ZWQnLCAgICAgIC8vIFRoaXMgc2hvdWxkIGJlIE9ULkV2ZW50Lm5hbWVzLkNPTk5FQ1RJT05fREVTVFJPWUVELCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB2YWx1ZSBvZiB0aGF0IGlzIGN1cnJlbnRseSBzaGFyZWQgd2l0aCBTZXNzaW9uCiAgICAgICAgICAgICAgICB0aGlzLAogICAgICAgICAgICAgICAgZGVzdHJveWVkUmVhc29uCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgIH0KICAgIH0uYmluZCh0aGlzKTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgICAgZGVzdHJveWVkOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBkZXN0cm95ZWRSZWFzb24gIT09IHZvaWQgMDsgfSwKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgIH0sCgogICAgICAgIGRlc3Ryb3llZFJlYXNvbjogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZGVzdHJveWVkUmVhc29uOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfQogICAgfSk7Cn07CgpPVC5Db25uZWN0aW9uLmZyb21IYXNoID0gZnVuY3Rpb24oaGFzaCkgewogIHJldHVybiBuZXcgT1QuQ29ubmVjdGlvbihoYXNoLmNvbm5lY3Rpb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2guY3JlYXRpb25UaW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaC5kYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBzdXBwb3J0c1dlYlJUQzogaGFzaC5zdXBwb3J0c1dlYlJUQyB9ICk7Cgp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKdmFyIHZhbGlkUHJvcGVydHlOYW1lcyA9IFsnaGFzQXVkaW8nLCAnaGFzVmlkZW8nLCAncXVhbGl0eScsICduYW1lJywgJ3ZpZGVvRGltZW5zaW9ucycsICdvcmllbnRhdGlvbiddOwoKCi8qKgogKiBTcGVjaWZpZXMgYSBzdHJlYW0uIEEgc3RyZWFtIGlzIGEgcmVwcmVzZW50YXRpb24gb2YgYSBwdWJsaXNoZWQgc3RyZWFtIGluIGEgc2Vzc2lvbi4gV2hlbiBhIGNsaWVudCBjYWxscyB0aGUKICogPGEgaHJlZj0iU2Vzc2lvbi5odG1sI3B1Ymxpc2giPlNlc3Npb24ucHVibGlzaCgpIG1ldGhvZDwvYT4sIGEgbmV3IHN0cmVhbSBpcyBjcmVhdGVkLiBQcm9wZXJ0aWVzIG9mIHRoZSBTdHJlYW0KICogb2JqZWN0IHByb3ZpZGUgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHN0cmVhbS4KICoKICogIDxwPldoZW4gYSBzdHJlYW0gaXMgYWRkZWQgdG8gYSBzZXNzaW9uLCB0aGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnN0cmVhbUNyZWF0ZWRFdmVudDwvY29kZT4uCiAqICBXaGVuIGEgc3RyZWFtIGlzIGRlc3Ryb3llZCwgdGhlIFNlc3Npb24gb2JqZWN0IGRpc3BhdGNoZXMgYSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50LiBUaGUKICogIFN0cmVhbUV2ZW50IG9iamVjdCwgd2hpY2ggZGVmaW5lcyB0aGVzZSBldmVudCBvYmplY3RzLCBoYXMgYSA8Y29kZT5zdHJlYW08L2NvZGU+IHByb3BlcnR5LCB3aGljaCBpcyBhbgogKiAgYXJyYXkgb2YgU3RyZWFtIG9iamVjdC4gRm9yIGRldGFpbHMgYW5kIGEgY29kZSBleGFtcGxlLCBzZWUge0BsaW5rIFN0cmVhbUV2ZW50fS48L3A+CiAqCiAqICA8cD5XaGVuIGEgY29ubmVjdGlvbiB0byBhIHNlc3Npb24gaXMgbWFkZSwgdGhlIFNlc3Npb24gb2JqZWN0IGRpc3BhdGNoZXMgYSA8Y29kZT5zZXNzaW9uQ29ubmVjdGVkPC9jb2RlPgogKiAgZXZlbnQsIGRlZmluZWQgYnkgdGhlIFNlc3Npb25Db25uZWN0RXZlbnQgb2JqZWN0LiBUaGUgU2Vzc2lvbkNvbm5lY3RFdmVudCBvYmplY3QgaGFzIGEgPGNvZGU+c3RyZWFtczwvY29kZT4KICogIHByb3BlcnR5LCB3aGljaCBpcyBhbiBhcnJheSBvZiBTdHJlYW0gb2JqZWN0cyBwZXJ0YWluaW5nIHRvIHRoZSBzdHJlYW1zIGluIHRoZSBzZXNzaW9uIGF0IHRoYXQgdGltZS4KICogIEZvciBkZXRhaWxzIGFuZCBhIGNvZGUgZXhhbXBsZSwgc2VlIHtAbGluayBTZXNzaW9uQ29ubmVjdEV2ZW50fS48L3A+CiAqCiAqIEBjbGFzcyBTdHJlYW0KICogQHByb3BlcnR5IHtDb25uZWN0aW9ufSBjb25uZWN0aW9uIFRoZSBDb25uZWN0aW9uIG9iamVjdCBjb3JyZXNwb25kaW5nCiAqIHRvIHRoZSBjb25uZWN0aW9uIHRoYXQgaXMgcHVibGlzaGluZyB0aGUgc3RyZWFtLiBZb3UgY2FuIGNvbXBhcmUgdGhpcyB0byB0byB0aGUgPGNvZGU+Y29ubmVjdGlvbjwvY29kZT4KICogcHJvcGVydHkgb2YgdGhlIFNlc3Npb24gb2JqZWN0IHRvIHNlZSBpZiB0aGUgc3RyZWFtIGlzIGJlaW5nIHB1Ymxpc2hlZCBieSB0aGUgbG9jYWwgd2ViIHBhZ2UuCiAqCiAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBjcmVhdGlvblRpbWUgVGhlIHRpbWVzdGFtcCBmb3IgdGhlIGNyZWF0aW9uCiAqIG9mIHRoZSBzdHJlYW0uIFRoaXMgdmFsdWUgaXMgY2FsY3VsYXRlZCBpbiBtaWxsaXNlY29uZHMuIFlvdSBjYW4gY29udmVydCB0aGlzIHZhbHVlIHRvIGEKICogRGF0ZSBvYmplY3QgYnkgY2FsbGluZyA8Y29kZT5uZXcgRGF0ZShjcmVhdGlvblRpbWUpPC9jb2RlPiwgd2hlcmUgPGNvZGU+Y3JlYXRpb25UaW1lPC9jb2RlPiBpcyB0aGUKICogPGNvZGU+Y3JlYXRpb25UaW1lPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUgU3RyZWFtIG9iamVjdC4KICoKICogQHByb3BlcnR5IHtCb29sZWFufSBoYXNBdWRpbyBXaGV0aGVyIHRoZSBzdHJlYW0gaGFzIGF1ZGlvLiBUaGlzIHByb3BlcnR5IGNhbiBjaGFuZ2UgaWYgdGhlIHB1Ymxpc2hlcgogKiB0dXJucyBvbiBvciBvZmYgYXVkaW8gKGJ5IGNhbGxpbmcgPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaEF1ZGlvIj5QdWJsaXNoZXIucHVibGlzaEF1ZGlvKCk8L2E+KS4KICogV2hlbiB0aGlzIG9jY3VycywgdGhlIHtAbGluayBTZXNzaW9ufSBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnN0cmVhbVByb3BlcnR5Q2hhbmdlZDwvY29kZT4gZXZlbnQKICogKHNlZSB7QGxpbmsgU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnR9LikKICoKICogQHByb3BlcnR5IHtCb29sZWFufSBoYXNWaWRlbyBXaGV0aGVyIHRoZSBzdHJlYW0gaGFzIHZpZGVvLiBUaGlzIHByb3BlcnR5IGNhbiBjaGFuZ2UgaWYgdGhlIHB1Ymxpc2hlcgogKiB0dXJucyBvbiBvciBvZmYgdmlkZW8gKGJ5IGNhbGxpbmcgPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaFZpZGVvIj5QdWJsaXNoZXIucHVibGlzaFZpZGVvKCk8L2E+KS4KICogV2hlbiB0aGlzIG9jY3VycywgdGhlIHtAbGluayBTZXNzaW9ufSBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnN0cmVhbVByb3BlcnR5Q2hhbmdlZDwvY29kZT4gZXZlbnQKICogKHNlZSB7QGxpbmsgU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnR9LikKICoKICogQHByb3BlcnR5IHtPYmplY3R9IHZpZGVvRGltZW5zaW9ucyBUaGlzIG9iamVjdCBoYXMgdHdvIHByb3BlcnRpZXM6IDxjb2RlPndpZHRoPC9jb2RlPiBhbmQgPGNvZGU+aGVpZ2h0PC9jb2RlPi4gQm90aCBhcmUKICogbnVtYmVycy4gVGhlIDxjb2RlPndpZHRoPC9jb2RlPiBwcm9wZXJ0eSBpcyB0aGUgd2lkdGggb2YgdGhlIGVuY29kZWQgc3RyZWFtOyB0aGUgPGNvZGU+aGVpZ2h0PC9jb2RlPiBwcm9wZXJ0eSBpcyB0aGUKICogaGVpZ2h0IG9mIHRoZSBlbmNvZGVkIHN0cmVhbS4gKFRoZXNlIGFyZSBpbmRlcGVuZGVudCBvZiB0aGUgYWN0dWFsIHdpZHRoIG9mIFB1Ymxpc2hlciBhbmQgU3Vic2NyaWJlciBvYmplY3RzIGNvcnJlc3BvbmRpbmcKICogdG8gdGhlIHN0cmVhbS4pIFRoaXMgcHJvcGVydHkgY2FuIGNoYW5nZSBpZiBhIHN0cmVhbSBwdWJsaXNoZWQgZnJvbSBhbiBpT1MgZGV2aWNlIHJlc2l6ZXMsIGJhc2VkIG9uIGEgY2hhbmdlIGluIHRoZSBkZXZpY2UKICogb3JpZW50YXRpb24uIFdoZW4gdGhpcyBvY2N1cnMsIHRoZSB7QGxpbmsgU2Vzc2lvbn0gb2JqZWN0IGRpc3BhdGNoZXMgYSA8Y29kZT5zdHJlYW1Qcm9wZXJ0eUNoYW5nZWQ8L2NvZGU+IGV2ZW50IChzZWUKICoge0BsaW5rIFN0cmVhbVByb3BlcnR5Q2hhbmdlZEV2ZW50fS4pCiAqCiAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBzdHJlYW0uIFB1Ymxpc2hlcnMgY2FuIHNwZWNpZnkgYSBuYW1lIHdoZW4gcHVibGlzaGluZyBhIHN0cmVhbQogKiAodXNpbmcgdGhlIDxjb2RlPnB1Ymxpc2goKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBwdWJsaXNoZXIncyBTZXNzaW9uIG9iamVjdCkuCiAqLwpPVC5TdHJlYW0gPSBmdW5jdGlvbihpZCwgY29ubmVjdGlvbiwgbmFtZSwgZGF0YSwgdHlwZSwgY3JlYXRpb25UaW1lLCBoYXNBdWRpbywgaGFzVmlkZW8sIG9yaWVudGF0aW9uLCBwZWVySWQsIHF1YWxpdHksIHdpZHRoLCBoZWlnaHQpIHsKICB2YXIgZGVzdHJveWVkUmVhc29uOwoKICB0aGlzLmlkID0gdGhpcy5zdHJlYW1JZCA9IGlkOwogIHRoaXMuY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLmRhdGEgPSBkYXRhOwogIHRoaXMudHlwZSA9IHR5cGUgfHwgJ2Jhc2ljJzsKICB0aGlzLmNyZWF0aW9uVGltZSA9IGNyZWF0aW9uVGltZSA/IE51bWJlcihjcmVhdGlvblRpbWUpIDogbnVsbDsKICB0aGlzLmhhc0F1ZGlvID0gT1QuJC5jYXN0VG9Cb29sZWFuKGhhc0F1ZGlvLCB0cnVlKTsKICB0aGlzLmhhc1ZpZGVvID0gT1QuJC5jYXN0VG9Cb29sZWFuKGhhc1ZpZGVvLCB0cnVlKTsKICB0aGlzLnBlZXJJZCA9IHBlZXJJZDsKICB0aGlzLnF1YWxpdHkgPSBxdWFsaXR5OwogIHRoaXMudmlkZW9EaW1lbnNpb25zID0geyB3aWR0aDogKHdpZHRoIHx8IDY0MCksIGhlaWdodDogKGhlaWdodCB8fCA0ODApLCBvcmllbnRhdGlvbjogKG9yaWVudGF0aW9uIHx8IE9ULlZpZGVvT3JpZW50YXRpb24uUk9UQVRFRF9OT1JNQUwpIH07CgogIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogIC8vIENvbmZ1c2luZ2x5LCB0aGlzIHNob3VsZCBub3QgYmUgY2FsbGVkIHdoZW4geW91IHdhbnQgdG8gY2hhbmdlCiAgLy8gdGhlIHN0cmVhbSBwcm9wZXJ0aWVzLiBUaGlzIGlzIHVzZWQgYnkgUmFwdG9yIGRpc3BhdGNoIHRvIG5vdGlmeQogIC8vIHRoZSBzdHJlYW0gdGhhdCBpdCdzIHByb3BlcmllcyBoYXZlIGJlZW4gc3VjY2Vzc2Z1bGx5IHVwZGF0ZWQKICAvLwogIC8vIEB0b2RvIG1ha2UgdGhpcyBzYW5lLiBQZXJoYXBzIHVzZSBzZXR0ZXJzIGZvciB0aGUgcHJvcGVydGllcyB0aGF0IGNhbgogIC8vIHNlbmQgdGhlIGFwcHJvcHJpYXRlIFJhcHRvciBtZXNzYWdlLiBUaGlzIHdvdWxkIHJlcXVpcmUgdGhhdCBTdHJlYW1zCiAgLy8gaGF2ZSBhY2Nlc3MgdG8gdGhlaXIgc2Vzc2lvbi4KICAvLwogIHRoaXMudXBkYXRlID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgaWYgKHZhbGlkUHJvcGVydHlOYW1lcy5pbmRleE9mKGtleSkgPT09IC0xKSB7CiAgICAgIE9ULndhcm4oJ1Vua25vd24gc3RyZWFtIHByb3BlcnR5ICInICsga2V5ICsgJyIgd2FzIG1vZGlmaWVkIHRvICInICsgdmFsdWUgKyAnIi4nKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBvbGRWYWx1ZSA9IHRoaXNba2V5XSwKICAgICAgICBuZXdWYWx1ZSA9IHZhbHVlOwoKICAgIHN3aXRjaChrZXkpIHsKICAgICAgY2FzZSAnaGFzQXVkaW8nOgogICAgICBjYXNlICdoYXNWaWRlbyc6CiAgICAgICAgbmV3VmFsdWUgPSBPVC4kLmNhc3RUb0Jvb2xlYW4obmV3VmFsdWUsIHRydWUpOwogICAgICAgIHRoaXNba2V5XSA9IG5ld1ZhbHVlOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAncXVhbGl0eSc6CiAgICAgIGNhc2UgJ25hbWUnOgogICAgICAgIHRoaXNba2V5XSA9IG5ld1ZhbHVlOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnb3JpZW50YXRpb24nOgogICAgICAgIHRoaXMudmlkZW9EaW1lbnNpb25zID0geyB3aWR0aDogbmV3VmFsdWUud2lkdGgsIGhlaWdodDogbmV3VmFsdWUuaGVpZ2h0LCBvcmllbnRhdGlvbjogbmV3VmFsdWUudmlkZW9PcmllbnRhdGlvbiB9OwogICAgfQoKICAgIC8vIFdlIG1hcCB0aGUgJ29yaWVudGF0aW9uJyBrZXkgKHRoYXQgY29tZXMgZnJvbSBSYXB0b3IpIHRvICd2aWRlb0RpbWVuc2lvbnMnIHdoZW4KICAgIC8vIGRpc3BhdGNoaW5nIHRoZSB1cGRhdGVkIGV2ZW50LCBhcyB0aGlzIGlzIGFjdHVhbCBwcm9wZXJ0eSB0aGF0IGlzIG1vZGlmaWVkIG9uIHRoZSBzdHJlYW0KICAgIHZhciBldmVudCA9IG5ldyBPVC5TdHJlYW1VcGRhdGVkRXZlbnQodGhpcywga2V5LCBvbGRWYWx1ZSwgbmV3VmFsdWUpOwogICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICB9OwoKICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbihyZWFzb24sIHF1aWV0KSB7CiAgICBkZXN0cm95ZWRSZWFzb24gPSByZWFzb24gfHwgJ2NsaWVudERpc2Nvbm5lY3RlZCc7CgogICAgaWYgKHF1aWV0ICE9PSB0cnVlKSB7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KAogICAgICAgICAgbmV3IE9ULkRlc3Ryb3llZEV2ZW50KAogICAgICAgICAgICAnZGVzdHJveWVkJywgICAgICAvLyBUaGlzIHNob3VsZCBiZSBPVC5FdmVudC5uYW1lcy5TVFJFQU1fREVTVFJPWUVELCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHZhbHVlIG9mIHRoYXQgaXMgY3VycmVudGx5IHNoYXJlZCB3aXRoIFNlc3Npb24KICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgZGVzdHJveWVkUmVhc29uCiAgICAgICAgICApCiAgICAgICAgKTsKICAgIH0KICB9OwoKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgIGRlc3Ryb3llZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIGRlc3Ryb3llZFJlYXNvbiAhPT0gdm9pZCAwOyB9LAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICB9LAoKICAgICAgZGVzdHJveWVkUmVhc29uOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZGVzdHJveWVkUmVhc29uOyB9LAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICB9CiAgfSk7Cn07CgoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTm9ybWFsaXNlIHRoZXNlCnZhciBOYXRpdmVSVENQZWVyQ29ubmVjdGlvbiA9ICh3aW5kb3cud2Via2l0UlRDUGVlckNvbm5lY3Rpb24gfHwgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uKTsKdmFyIE5hdGl2ZVJUQ1Nlc3Npb25EZXNjcmlwdGlvbiA9ICh3aW5kb3cubW96UlRDU2Vzc2lvbkRlc2NyaXB0aW9uIHx8IHdpbmRvdy5SVENTZXNzaW9uRGVzY3JpcHRpb24pOyAvLyBvcmRlciBpcyB2ZXJ5IGltcG9ydGFudDogIlJUQ1Nlc3Npb25EZXNjcmlwdGlvbiIgZGVmaW5lZCBpbiBGaXJlZm94IE5pZ2hseSBidXQgdXNlbGVzcwp2YXIgTmF0aXZlUlRDSWNlQ2FuZGlkYXRlID0gKHdpbmRvdy5tb3pSVENJY2VDYW5kaWRhdGUgfHwgd2luZG93LlJUQ0ljZUNhbmRpZGF0ZSk7CgovLyBIZWxwZXIgZnVuY3Rpb24gdG8gZm9yd2FyZCBJY2UgQ2FuZGlkYXRlcyB2aWEgK21lc3NhZ2VEZWxlZ2F0ZSsKdmFyIGljZUNhbmRpZGF0ZUZvcndhcmRlciA9IGZ1bmN0aW9uKG1lc3NhZ2VEZWxlZ2F0ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgT1QuZGVidWcoIkljZUNhbmRpZGF0ZUZvcndhcmRlcjogSWNlIENhbmRpZGF0ZSIpOwoKICAgICAgICBpZiAoZXZlbnQuY2FuZGlkYXRlKSB7CiAgICAgICAgICAgIG1lc3NhZ2VEZWxlZ2F0ZShPVC5SYXB0b3IuQWN0aW9ucy5DQU5ESURBVEUsIGV2ZW50LmNhbmRpZGF0ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBPVC5kZWJ1ZygiSWNlQ2FuZGlkYXRlRm9yd2FyZGVyOiBObyBtb3JlIElDRSBjYW5kaWRhdGVzLiIpOwogICAgICAgIH0KICAgIH07Cn07CgoKLy8gUHJvY2VzcyBpbmNvbWluZyBJY2UgQ2FuZGlkYXRlcyBmcm9tIGEgcmVtb3RlIGNvbm5lY3Rpb24gKHdoaWNoIGhhdmUgYmVlbgovLyBmb3J3YXJkZWQgdmlhIGljZUNhbmRpZGF0ZUZvcndhcmRlcikuIFRoZSBJY2UgQ2FuZGlkYXRlcyBjYW5ub3QgYmUgcHJvY2Vzc2VkCi8vIHVudGlsIGEgUGVlckNvbm5lY3Rpb24gaXMgYXZhaWxhYmxlLiBPbmNlIGEgUGVlckNvbm5lY3Rpb24gYmVjb21lcyBhdmFpbGFibGUKLy8gdGhlIHBlbmRpbmcgUGVlckNvbm5lY3Rpb25zIGNhbiBiZSBwcm9jZXNzZWQgYnkgY2FsbGluZyBwcm9jZXNzUGVuZGluZy4KLy8KLy8gQGV4YW1wbGUKLy8KLy8gIHZhciBpY2VQcm9jZXNzb3IgPSBuZXcgSWNlQ2FuZGlkYXRlUHJvY2Vzc29yKCk7Ci8vICBpY2VQcm9jZXNzb3IucHJvY2VzcyhpY2VNZXNzYWdlMSk7Ci8vICBpY2VQcm9jZXNzb3IucHJvY2VzcyhpY2VNZXNzYWdlMik7Ci8vICBpY2VQcm9jZXNzb3IucHJvY2VzcyhpY2VNZXNzYWdlMyk7Ci8vCi8vICBpY2VQcm9jZXNzb3IucGVlckNvbm5lY3Rpb24gPSBwZWVyQ29ubmVjdGlvbjsKLy8gIGljZVByb2Nlc3Nvci5wcm9jZXNzUGVuZGluZygpOwovLwp2YXIgSWNlQ2FuZGlkYXRlUHJvY2Vzc29yID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgX3BlbmRpbmdJY2VDYW5kaWRhdGVzID0gW10sCiAgICAgICAgX3BlZXJDb25uZWN0aW9uID0gbnVsbDsKCgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdwZWVyQ29ubmVjdGlvbicsIHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHBlZXJDb25uZWN0aW9uKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbiA9IHBlZXJDb25uZWN0aW9uOwogICAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMucHJvY2VzcyA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgaWNlQ2FuZGlkYXRlID0gbmV3IE5hdGl2ZVJUQ0ljZUNhbmRpZGF0ZShtZXNzYWdlLmNhbmRpZGF0ZSk7CgogICAgICAgIGlmIChfcGVlckNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uLmFkZEljZUNhbmRpZGF0ZShpY2VDYW5kaWRhdGUpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgX3BlbmRpbmdJY2VDYW5kaWRhdGVzLnB1c2goaWNlQ2FuZGlkYXRlKTsKICAgICAgICB9CiAgICB9OwoKICAgIHRoaXMucHJvY2Vzc1BlbmRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB3aGlsZShfcGVuZGluZ0ljZUNhbmRpZGF0ZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5hZGRJY2VDYW5kaWRhdGUoX3BlbmRpbmdJY2VDYW5kaWRhdGVzLnNoaWZ0KCkpOwogICAgICAgIH0KICAgIH07Cn07CgovLyBSZW1vdmVzIGFsbCBDb25mb3J0IE5vaXNlIGZyb20gK3NkcCsuCi8vCi8vIFNlZSBodHRwczovL2ppcmEudG9rYm94LmNvbS9icm93c2UvT1BFTlRPSy03MTc2Ci8vCnZhciByZW1vdmVDb21mb3J0Tm9pc2UgPSBmdW5jdGlvbiByZW1vdmVDb21mb3J0Tm9pc2UgKHNkcCkgewogICAgLy8gYT1ydHBtYXA6PHBheWxvYWQgdHlwZT4gPGVuY29kaW5nIG5hbWU+LzxjbG9jayByYXRlPiBbLzxlbmNvZGluZyBwYXJhbWV0ZXJzPl0KICAgIHZhciBtYXRjaGVyID0gL2E9cnRwbWFwOihcZCspIENOXC9cZCsvaSwKICAgICAgICBwYXlsb2FkVHlwZXMgPSBbXSwKICAgICAgICBhdWRpb01lZGlhTGluZUluZGV4LAogICAgICAgIHNkcExpbmVzLAogICAgICAgIG1hdGNoOwoKICAgIC8vIElja3kgY29kZS4gVGhpcyBmaWx0ZXIgb3BlcmF0aW9uIGhhcyB0d28gc2lkZSBlZmZlY3RzIGluIGFkZGl0aW9uCiAgICAvLyB0byBkb2luZyB0aGUgYWN0dWFsIGZpbHRlcmluZzoKICAgIC8vICAgMS4gZXh0cmFjdCBhbGwgdGhlIHBheWxvYWQgdHlwZXMgZnJvbSB0aGUgcnRwbWFwIENOIGxpbmVzCiAgICAvLyAgIDIuIGZpbmQgdGhlIGluZGV4IG9mIHRoZSBhdWRpbyBtZWRpYSBsaW5lCiAgICAvLwogICAgc2RwTGluZXMgPSBzZHAuc3BsaXQoIlxyXG4iKS5maWx0ZXIoZnVuY3Rpb24obGluZSwgaW5kZXgpIHsKICAgICAgICBpZiAobGluZS5pbmRleE9mKCdtPWF1ZGlvJykgIT09IC0xKSBhdWRpb01lZGlhTGluZUluZGV4ID0gaW5kZXg7CgogICAgICAgIG1hdGNoID0gbGluZS5tYXRjaChtYXRjaGVyKTsKICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgcGF5bG9hZFR5cGVzLnB1c2gobWF0Y2hbMV0pOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIHRoaXMgbGluZSBhcyBpdCBjb250YWlucyBDTgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwoKICAgIGlmIChwYXlsb2FkVHlwZXMubGVuZ3RoICYmIGF1ZGlvTWVkaWFMaW5lSW5kZXgpIHsKICAgICAgICAvLyBSZW1vdmUgYWxsIENOIHBheWxvYWQgdHlwZXMgZnJvbSB0aGUgYXVkaW8gbWVkaWEgbGluZS4KICAgICAgICBzZHBMaW5lc1thdWRpb01lZGlhTGluZUluZGV4XSA9IHNkcExpbmVzW2F1ZGlvTWVkaWFMaW5lSW5kZXhdLnJlcGxhY2UoIG5ldyBSZWdFeHAocGF5bG9hZFR5cGVzLmpvaW4oJ3wnKSwgJ2lnJykgLCAnJykucmVwbGFjZSgvXHMrL2csICcgJyk7CiAgICB9CgogICAgcmV0dXJuIHNkcExpbmVzLmpvaW4oIlxyXG4iKTsKfTsKCi8vIEF0dGVtcHQgdG8gY29tcGxldGVseSBwcm9jZXNzICtvZmZlcisuIFRoaXMgd2lsbDoKLy8gKiBzZXQgdGhlIG9mZmVyIGFzIHRoZSByZW1vdGUgZGVzY3JpcHRpb24KLy8gKiBjcmVhdGUgYW4gYW5zd2VyIGFuZAovLyAqIHNldCB0aGUgbmV3IGFuc3dlciBhcyB0aGUgbG9jYXRpb24gZGVzY3JpcHRpb24KLy8KLy8gSWYgdGhlcmUgYXJlIG5vIGlzc3VlcywgdGhlICtzdWNjZXNzKyBjYWxsYmFjayB3aWxsIGJlIGV4ZWN1dGVkIG9uIGNvbXBsZXRpb24uCi8vIEVycm9ycyBkdXJpbmcgYW55IHN0ZXAgd2lsbCByZXN1bHQgaW4gdGhlICtmYWlsdXJlKyBjYWxsYmFjayBiZWluZyBleGVjdXRlZC4KLy8KdmFyIG9mZmVyUHJvY2Vzc29yID0gZnVuY3Rpb24ocGVlckNvbm5lY3Rpb24sIG9mZmVyLCBzdWNjZXNzLCBmYWlsdXJlKSB7CiAgICB2YXIgZ2VuZXJhdGVFcnJvckNhbGxiYWNrID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgICAgIGlmIChmYWlsdXJlKSBmYWlsdXJlKG1lc3NhZ2UsIGVycm9yUmVhc29uKTsKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICBzZXRMb2NhbERlc2NyaXB0aW9uID0gZnVuY3Rpb24oYW5zd2VyKSB7CiAgICAgICAgICAgIGFuc3dlci5zZHAgPSByZW1vdmVDb21mb3J0Tm9pc2UoYW5zd2VyLnNkcCk7CgogICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKAogICAgICAgICAgICAgICAgYW5zd2VyLAoKICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoYW5zd2VyKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gRmFpbHVyZQogICAgICAgICAgICAgICAgZ2VuZXJhdGVFcnJvckNhbGxiYWNrKCdFcnJvciB3aGlsZSBzZXR0aW5nIExvY2FsRGVzY3JpcHRpb24nKQogICAgICAgICAgICApOwogICAgICAgIH0sCgogICAgICAgIGNyZWF0ZUFuc3dlciA9IGZ1bmN0aW9uKG9uU3VjY2VzcykgewogICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5jcmVhdGVBbnN3ZXIoCiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzCiAgICAgICAgICAgICAgICBzZXRMb2NhbERlc2NyaXB0aW9uLAoKICAgICAgICAgICAgICAgIC8vIEZhaWx1cmUKICAgICAgICAgICAgICAgIGdlbmVyYXRlRXJyb3JDYWxsYmFjaygnRXJyb3Igd2hpbGUgc2V0dGluZyBjcmVhdGVBbnN3ZXInKSwKCiAgICAgICAgICAgICAgICBudWxsLCAvLyBNZWRpYUNvbnN0cmFpbnRzCiAgICAgICAgICAgICAgICBmYWxzZSAvLyBjcmVhdGVQcm92aXNpb25hbEFuc3dlcgogICAgICAgICAgICApOwogICAgICAgIH07CgogICAgLy8gV29ya2Fyb3VuZCBmb3IgYSBDaHJvbWUgaXNzdWUuIEFkZCBpbiB0aGUgU0RFUyBjcnlwdG8gbGluZSBpbnRvIG9mZmVycwogICAgLy8gZnJvbSBGaXJlZm94CiAgICBpZiAob2ZmZXIuc2RwLmluZGV4T2YoJ2E9Y3J5cHRvJykgPT09IC0xKSB7CiAgICAgICAgdmFyIGNyeXB0b19saW5lID0gImE9Y3J5cHRvOjEgQUVTX0NNXzEyOF9ITUFDX1NIQTFfODAgaW5saW5lOkZha2VGYWtlRmFrZUZha2VGYWtlRmFrZUZha2VGYWtlRmFrZUZha2VcXHJcXG4iOwoKICAgICAgICAvLyBpbnNlcnQgdGhlIGZha2UgY3J5cHRvIGxpbmUgZm9yIGV2ZXJ5IE0gbGluZQogICAgICAgIG9mZmVyLnNkcCA9IG9mZmVyLnNkcC5yZXBsYWNlKC9eYz1JTiguKikkL2dtaSwgImM9SU4kMVxyXG4iK2NyeXB0b19saW5lKTsKICAgIH0KCiAgICBpZiAob2ZmZXIuc2RwLmluZGV4T2YoJ2E9cnRjcC1mYicpID09PSAtMSkgewogICAgICAgIHZhciBydGNwX2ZiX2xpbmUgPSAiYT1ydGNwLWZiOiogY2NtIGZpclxyXG5hPXJ0Y3AtZmI6KiBuYWNrICI7CgogICAgICAgIC8vIGluc2VydCB0aGUgZmFrZSBjcnlwdG8gbGluZSBmb3IgZXZlcnkgTSBsaW5lCiAgICAgICAgb2ZmZXIuc2RwID0gb2ZmZXIuc2RwLnJlcGxhY2UoL15tPXZpZGVvKC4qKSQvZ21pLCAibT12aWRlbyQxXHJcbiIrcnRjcF9mYl9saW5lKTsKICAgIH0KCiAgICBwZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbigKICAgICAgICBvZmZlciwKCiAgICAgICAgLy8gU3VjY2VzcwogICAgICAgIGNyZWF0ZUFuc3dlciwKCiAgICAgICAgLy8gRmFpbHVyZQogICAgICAgIGdlbmVyYXRlRXJyb3JDYWxsYmFjaygnRXJyb3Igd2hpbGUgc2V0dGluZyBSZW1vdGVEZXNjcmlwdGlvbicpCiAgICApOwoKfTsKCi8vIEF0dGVtcHQgdG8gY29tcGxldGVseSBwcm9jZXNzIGEgc3Vic2NyaWJlIG1lc3NhZ2UuIFRoaXMgd2lsbDoKLy8gKiBjcmVhdGUgYW4gT2ZmZXIKLy8gKiBzZXQgdGhlIG5ldyBvZmZlciBhcyB0aGUgbG9jYXRpb24gZGVzY3JpcHRpb24KLy8KLy8gSWYgdGhlcmUgYXJlIG5vIGlzc3VlcywgdGhlICtzdWNjZXNzKyBjYWxsYmFjayB3aWxsIGJlIGV4ZWN1dGVkIG9uIGNvbXBsZXRpb24uCi8vIEVycm9ycyBkdXJpbmcgYW55IHN0ZXAgd2lsbCByZXN1bHQgaW4gdGhlICtmYWlsdXJlKyBjYWxsYmFjayBiZWluZyBleGVjdXRlZC4KLy8KdmFyIHN1c2NyaWJlUHJvY2Vzc29yID0gZnVuY3Rpb24ocGVlckNvbm5lY3Rpb24sIHN1Y2Nlc3MsIGZhaWx1cmUpIHsKICAgIHZhciBjb25zdHJhaW50cyA9IHsKICAgICAgICAgICAgbWFuZGF0b3J5OiB7fSwKICAgICAgICAgICAgb3B0aW9uYWw6IFtdCiAgICAgICAgfSwKCiAgICAgICAgZ2VuZXJhdGVFcnJvckNhbGxiYWNrID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgICAgIGlmIChmYWlsdXJlKSBmYWlsdXJlKG1lc3NhZ2UsIGVycm9yUmVhc29uKTsKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICBzZXRMb2NhbERlc2NyaXB0aW9uID0gZnVuY3Rpb24ob2ZmZXIpIHsKICAgICAgICAgICAgb2ZmZXIuc2RwID0gcmVtb3ZlQ29tZm9ydE5vaXNlKG9mZmVyLnNkcCk7CgogICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKAogICAgICAgICAgICAgICAgb2ZmZXIsCgogICAgICAgICAgICAgICAgLy8gU3VjY2VzcwogICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyhvZmZlcik7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEZhaWx1cmUKICAgICAgICAgICAgICAgIGdlbmVyYXRlRXJyb3JDYWxsYmFjaygnRXJyb3Igd2hpbGUgc2V0dGluZyBMb2NhbERlc2NyaXB0aW9uJykKICAgICAgICAgICAgKTsKICAgICAgICB9OwoKCiAgICAvLyBGb3IgaW50ZXJvcCB3aXRoIEZpcmVGb3guIERpc2FibGUgRGF0YSBDaGFubmVsIGluIGNyZWF0ZU9mZmVyLgogICAgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEpIHsKICAgICAgICBjb25zdHJhaW50cy5tYW5kYXRvcnkuTW96RG9udE9mZmVyRGF0YUNoYW5uZWwgPSB0cnVlOwogICAgfQoKICAgIHBlZXJDb25uZWN0aW9uLmNyZWF0ZU9mZmVyKAogICAgICAgIC8vIFN1Y2Nlc3MKICAgICAgICBzZXRMb2NhbERlc2NyaXB0aW9uLAoKICAgICAgICAvLyBGYWlsdXJlCiAgICAgICAgZ2VuZXJhdGVFcnJvckNhbGxiYWNrKCdFcnJvciB3aGlsZSBjcmVhdGluZyBPZmZlcicpLAoKICAgICAgICBjb25zdHJhaW50cwogICAgKTsKfTsKCi8qKgogKiBOZWdvdGlhdGVzIGEgV2ViUlRDIFBlZXJDb25uZWN0aW9uLgogKgogKiBSZXNwb25zaWJsZSBmb3I6CiAqICogb2ZmZXItYW5zd2VyIGV4Y2hhbmdlCiAqICogaWNlQ2FuZGlkYXRlcwogKiAqIG5vdGlmaWNhdGlvbiBvZiByZW1vdGUgc3RyZWFtcyBiZWluZyBhZGRlZC9yZW1vdmVkCiAqCiAqLwpPVC5QZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgdmFyIF9wZWVyQ29ubmVjdGlvbiwKICAgICAgICBfaWNlUHJvY2Vzc29yID0gbmV3IEljZUNhbmRpZGF0ZVByb2Nlc3NvcigpLAogICAgICAgIF9vZmZlciwKICAgICAgICBfYW5zd2VyLAogICAgICAgIF9zdGF0ZSA9ICduZXcnLAogICAgICAgIF9pY2VDYW5kaWRhdGVzR2F0aGVyZWQgPSBmYWxzZSwKICAgICAgICBfbWVzc2FnZURlbGVnYXRlcyA9IFtdLAogICAgICAgIF9nZXR0aW5nU3RhdHMsCiAgICAgICAgX2NyZWF0ZVRpbWUgPSBPVC4kLm5vdygpOwoKICAgIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogICAgLy8gaWYgaWNlIHNlcnZlcnMgZG9lc24ndCBleGlzdCBGaXJlZm94IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uLiBDaHJvbWUKICAgIC8vIGludGVycHJldHMgdGhpcyBhcyAiVXNlIG15IGRlZmF1bHQgU1RVTiBzZXJ2ZXJzIiB3aGVyZWFzIEZGIHJlYWRzIGl0CiAgICAvLyBhcyAiRG9uJ3QgdXNlIFNUVU4gYXQgYWxsIi4gKkdydW1ibGUqCiAgICBpZiAoIWNvbmZpZy5pY2VTZXJ2ZXJzKSBjb25maWcuaWNlU2VydmVycyA9IFtdOwoKICAgIC8vIFByaXZhdGUgbWV0aG9kcwogICAgdmFyIGRlbGVnYXRlTWVzc2FnZSA9IGZ1bmN0aW9uKHR5cGUsIG1lc3NhZ2VQYXlsb2FkKSB7CiAgICAgICAgICAgIGlmIChfbWVzc2FnZURlbGVnYXRlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFdlIGFjdHVhbGx5IG9ubHkgZXZlciBzZW5kIHRvIHRoZSBmaXJzdCBkZWxlZ2F0ZS4gVGhpcyBpcyBiZWNhdXNlCiAgICAgICAgICAgICAgICAvLyBlYWNoIGRlbGVnYXRlIGFjdHVhbGx5IHJlcHJlc2VudHMgYSBQdWJsaXNoZXIvU3Vic2NyaWJlciB0aGF0CiAgICAgICAgICAgICAgICAvLyBzaGFyZXMgYSBzaW5nbGUgUGVlckNvbm5lY3Rpb24uIElmIHdlIHNlbnQgdG8gYWxsIGRlbGVnYXRlcyBpdAogICAgICAgICAgICAgICAgLy8gd291bGQgcmVzdWx0IGluIGVhY2ggbWVzc2FnZSBiZWluZyBwcm9jZXNzZWQgbXVsdGlwbGUgdGltZXMgYnkKICAgICAgICAgICAgICAgIC8vIGVhY2ggUGVlckNvbm5lY3Rpb24uCiAgICAgICAgICAgICAgICBfbWVzc2FnZURlbGVnYXRlc1swXSh0eXBlLCBtZXNzYWdlUGF5bG9hZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LmJpbmQodGhpcyksCgoKICAgICAgICBzZXR1cFBlZXJDb25uZWN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghX3BlZXJDb25uZWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIE9ULmRlYnVnKCJDcmVhdGluZyBwZWVyIGNvbm5lY3Rpb24gY29uZmlnIFwiIiArIEpTT04uc3RyaW5naWZ5KGNvbmZpZykgKyAiXCIuIik7CgoKICAgICAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24gPSBuZXcgTmF0aXZlUlRDUGVlckNvbm5lY3Rpb24oY29uZmlnLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbmFsOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7RHRsc1NydHBLZXlBZ3JlZW1lbnQ6IHRydWV9CiAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIE9ULmVycm9yKCJGYWlsZWQgdG8gY3JlYXRlIFBlZXJDb25uZWN0aW9uLCBleGNlcHRpb246ICIgKyBlLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9pY2VQcm9jZXNzb3IucGVlckNvbm5lY3Rpb24gPSBfcGVlckNvbm5lY3Rpb247CgogICAgICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uLm9uaWNlY2FuZGlkYXRlID0gaWNlQ2FuZGlkYXRlRm9yd2FyZGVyKGRlbGVnYXRlTWVzc2FnZSk7CiAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24ub25hZGRzdHJlYW0gPSBvblJlbW90ZVN0cmVhbUFkZGVkLmJpbmQodGhpcyk7CiAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24ub25yZW1vdmVzdHJlYW0gPSBvblJlbW90ZVN0cmVhbVJlbW92ZWQuYmluZCh0aGlzKTsKCiAgICAgICAgICAgICAgICBpZiAoX3BlZXJDb25uZWN0aW9uLm9uc2lnbmFsaW5nc3RhdGVjaGFuZ2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5vbnNpZ25hbGluZ3N0YXRlY2hhbmdlID0gcm91dGVTdGF0ZUNoYW5nZWQuYmluZCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoX3BlZXJDb25uZWN0aW9uLm9uc3RhdGVjaGFuZ2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5vbnN0YXRlY2hhbmdlID0gcm91dGVTdGF0ZUNoYW5nZWQuYmluZCh0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIF9wZWVyQ29ubmVjdGlvbjsKICAgICAgICB9LmJpbmQodGhpcyksCgogICAgICAgIC8vIENsZWFuIHVwIHRoZSBQZWVyIENvbm5lY3Rpb24gYW5kIHRyaWdnZXIgdGhlIGNsb3NlIGV2ZW50LgogICAgICAgIC8vIFRoaXMgZnVuY3Rpb24gY2FuIGJlIGNhbGxlZCBzYWZlbHkgbXVsdGlwbGUgdGltZXMsIGl0IHdpbGwKICAgICAgICAvLyBvbmx5IHRyaWdnZXIgdGhlIGNsb3NlIGV2ZW50IG9uY2UgKHBlciBQZWVyQ29ubmVjdGlvbiBvYmplY3QpCiAgICAgICAgdGVhckRvd25QZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBPdXIgY29ubmVjdGlvbiBpcyBkZWFkLCBzdG9wIHByb2Nlc3NpbmcgSUNFIGNhbmRpZGF0ZXMKICAgICAgICAgICAgaWYgKF9pY2VQcm9jZXNzb3IpIF9pY2VQcm9jZXNzb3IucGVlckNvbm5lY3Rpb24gPSBudWxsOwoKICAgICAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2xvc2UnKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHJvdXRlU3RhdGVDaGFuZ2VkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlOwoKICAgICAgICAgICAgaWYgKHR5cGVvZihldmVudCkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgbmV3ZXN0IHZlcnNpb24gb2YgdGhlIEFQSQogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBldmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChldmVudC50YXJnZXQgJiYgZXZlbnQudGFyZ2V0LnNpZ25hbGluZ1N0YXRlKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgc2xpZ2h0bHkgb2xkZXIgdmVyc2lvbgogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBldmVudC50YXJnZXQuc2lnbmFsaW5nU3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBBdCBsZWFzdCBzaXggbW9udGhzIG9sZCB2ZXJzaW9uLiBQb3NpdGl2ZWx5IGFuY2llbnQsIHllYWg/CiAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IGV2ZW50LnRhcmdldC5yZWFkeVN0YXRlOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgT1QuZGVidWcoJ1BlZXJDb25uZWN0aW9uLnN0YXRlQ2hhbmdlOiAnICsgbmV3U3RhdGUpOwogICAgICAgICAgICBpZiAobmV3U3RhdGUgJiYgbmV3U3RhdGUudG9Mb3dlckNhc2UoKSAhPT0gX3N0YXRlKSB7CiAgICAgICAgICAgICAgICBfc3RhdGUgPSBuZXdTdGF0ZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgT1QuZGVidWcoJ1BlZXJDb25uZWN0aW9uLnN0YXRlQ2hhbmdlOiAnICsgX3N0YXRlKTsKCiAgICAgICAgICAgICAgICBzd2l0Y2goX3N0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2xvc2VkJzoKICAgICAgICAgICAgICAgICAgICAgICAgdGVhckRvd25QZWVyQ29ubmVjdGlvbi5jYWxsKHRoaXMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBnZXRMb2NhbFN0cmVhbXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0cmVhbXM7CgogICAgICAgICAgICBpZiAoX3BlZXJDb25uZWN0aW9uLmdldExvY2FsU3RyZWFtcykgewogICAgICAgICAgICAgICAgc3RyZWFtcyA9IF9wZWVyQ29ubmVjdGlvbi5nZXRMb2NhbFN0cmVhbXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChfcGVlckNvbm5lY3Rpb24ubG9jYWxTdHJlYW1zKSB7CiAgICAgICAgICAgICAgICBzdHJlYW1zID0gX3BlZXJDb25uZWN0aW9uLmxvY2FsU3RyZWFtczsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBQZWVyIENvbm5lY3Rpb24gb2JqZWN0IGltcGxlbWVudHMgbm8gbWV0aG9kIGZvciByZXRyaWV2aW5nIGxvY2FsIHN0cmVhbXMiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRm9yY2Ugc3RyZWFtcyB0byBiZSBhbiBBcnJheSwgcmF0aGVyIHRoYW4gYSAiU2VxdWVuY2UiIG9iamVjdCwKICAgICAgICAgICAgLy8gd2hpY2ggaXMgYnJvd3NlciBkZXBlbmRlbnQgYW5kIGRvZXMgbm90IGJlaGF2aW91ciBsaWtlIGFuIEFycmF5CiAgICAgICAgICAgIC8vIGluIGV2ZXJ5IGNhc2UuCiAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChzdHJlYW1zKTsKICAgICAgICB9LAoKICAgICAgICBnZXRSZW1vdGVTdHJlYW1zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzdHJlYW1zOwoKICAgICAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbi5nZXRSZW1vdGVTdHJlYW1zKSB7CiAgICAgICAgICAgICAgICBzdHJlYW1zID0gX3BlZXJDb25uZWN0aW9uLmdldFJlbW90ZVN0cmVhbXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChfcGVlckNvbm5lY3Rpb24ucmVtb3RlU3RyZWFtcykgewogICAgICAgICAgICAgICAgc3RyZWFtcyA9IF9wZWVyQ29ubmVjdGlvbi5yZW1vdGVTdHJlYW1zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIFBlZXIgQ29ubmVjdGlvbiBvYmplY3QgaW1wbGVtZW50cyBubyBtZXRob2QgZm9yIHJldHJpZXZpbmcgcmVtb3RlIHN0cmVhbXMiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRm9yY2Ugc3RyZWFtcyB0byBiZSBhbiBBcnJheSwgcmF0aGVyIHRoYW4gYSAiU2VxdWVuY2UiIG9iamVjdCwKICAgICAgICAgICAgLy8gd2hpY2ggaXMgYnJvd3NlciBkZXBlbmRlbnQgYW5kIGRvZXMgbm90IGJlaGF2aW91ciBsaWtlIGFuIEFycmF5CiAgICAgICAgICAgIC8vIGluIGV2ZXJ5IGNhc2UuCiAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChzdHJlYW1zKTsKICAgICAgICB9LAoKICAgICAgICBnZW5lcmF0ZUVycm9yQ2FsbGJhY2sgPSBmdW5jdGlvbihmb3JNZXRob2QsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGVycm9yUmVhc29uKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyRXJyb3IuY2FsbCh0aGlzLCAiUGVlckNvbm5lY3Rpb24uIiArIGZvck1ldGhvZCArICI6ICIgKyBtZXNzYWdlICsgIjogIiArIGVycm9yUmVhc29uKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIC8vLyBQZWVyQ29ubmVjdGlvbiBzaWduYWxpbmcKICAgICAgICBvblJlbW90ZVN0cmVhbUFkZGVkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdHJlYW1BZGRlZCcsIGV2ZW50LnN0cmVhbSk7CiAgICAgICAgfSwKCiAgICAgICAgb25SZW1vdGVTdHJlYW1SZW1vdmVkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdHJlYW1SZW1vdmVkJywgZXZlbnQuc3RyZWFtKTsKICAgICAgICB9LAoKICAgICAgICAvLyBJQ0UgTmVnb3RpYXRpb24gbWVzc2FnZXMKCgogICAgICAgIC8vIFJlbGF5cyBhIFNEUCBwYXlsb2FkICgrc2RwKyksIHRoYXQgaXMgcGFydCBvZiBhIG1lc3NhZ2Ugb2YgdHlwZSArbWVzc2FnZVR5cGUrCiAgICAgICAgLy8gdmlhIHRoZSByZWdpc3RlcmVkIG1lc3NhZ2UgZGVsZWdhdG9ycwogICAgICAgIHJlbGF5U0RQID0gZnVuY3Rpb24obWVzc2FnZVR5cGUsIHNkcCkgewogICAgICAgICAgICBkZWxlZ2F0ZU1lc3NhZ2UobWVzc2FnZVR5cGUsIHNkcCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gUHJvY2VzcyBhbiBvZmZlciB0aGF0CiAgICAgICAgcHJvY2Vzc09mZmVyID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICB2YXIgb2ZmZXIgPSBuZXcgTmF0aXZlUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2Uuc2RwKSwKCiAgICAgICAgICAgICAgICAvLyBSZWxheXMgK2Fuc3dlcisgQW5zd2VyCiAgICAgICAgICAgICAgICByZWxheUFuc3dlciA9IGZ1bmN0aW9uKGFuc3dlcikgewogICAgICAgICAgICAgICAgICAgIHJlbGF5U0RQKE9ULlJhcHRvci5BY3Rpb25zLkFOU1dFUiwgYW5zd2VyKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcmVwb3J0RXJyb3IgPSBmdW5jdGlvbihtZXNzYWdlLCBlcnJvclJlYXNvbikgewogICAgICAgICAgICAgICAgICAgIHRyaWdnZXJFcnJvcigiUGVlckNvbm5lY3Rpb24ub2ZmZXJQcm9jZXNzb3IgIiArIG1lc3NhZ2UgKyAiOiAiICsgZXJyb3JSZWFzb24pOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNldHVwUGVlckNvbm5lY3Rpb24oKTsKCiAgICAgICAgICAgIF9yZW1vdGVEZXNjcmlwdGlvblR5cGUgPSBvZmZlci50eXBlOwogICAgICAgICAgICBfcmVtb3RlRGVzY3JpcHRpb24gPSBvZmZlcjsKCiAgICAgICAgICAgIG9mZmVyUHJvY2Vzc29yKAogICAgICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uLAogICAgICAgICAgICAgICAgb2ZmZXIsCiAgICAgICAgICAgICAgICByZWxheUFuc3dlciwKICAgICAgICAgICAgICAgIHJlcG9ydEVycm9yCiAgICAgICAgICAgICk7CiAgICAgICAgfSwKCiAgICAgICAgcHJvY2Vzc0Fuc3dlciA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgICAgaWYgKCFtZXNzYWdlLnNkcCkgewogICAgICAgICAgICAgICAgT1QuZXJyb3IoIlBlZXJDb25uZWN0aW9uLnByb2Nlc3NNZXNzYWdlOiBXZWlyZCBtZXNzYWdlLCBubyBTRFAuIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9hbnN3ZXIgPSBuZXcgTmF0aXZlUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2Uuc2RwKTsKCiAgICAgICAgICAgIF9yZW1vdGVEZXNjcmlwdGlvblR5cGUgPSBfYW5zd2VyLnR5cGU7CiAgICAgICAgICAgIF9yZW1vdGVEZXNjcmlwdGlvbiA9IF9hbnN3ZXI7CgogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24uc2V0UmVtb3RlRGVzY3JpcHRpb24oX2Fuc3dlcik7CiAgICAgICAgICAgIF9pY2VQcm9jZXNzb3IucHJvY2Vzc1BlbmRpbmcoKTsKICAgICAgICB9LAoKICAgICAgICBwcm9jZXNzU3Vic2NyaWJlID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICBPVC5kZWJ1ZygiUGVlckNvbm5lY3Rpb24ucHJvY2Vzc1N1YnNjcmliZTogU2VuZGluZyBvZmZlciB0byBzdWJzY3JpYmVyLiIpOwoKICAgICAgICAgICAgc2V0dXBQZWVyQ29ubmVjdGlvbigpOwoKICAgICAgICAgICAgc3VzY3JpYmVQcm9jZXNzb3IoCiAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24sCgogICAgICAgICAgICAgICAgLy8gU3VjY2VzczogUmVsYXkgT2ZmZXIKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKG9mZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgX29mZmVyID0gb2ZmZXI7CiAgICAgICAgICAgICAgICAgICAgcmVsYXlTRFAoT1QuUmFwdG9yLkFjdGlvbnMuT0ZGRVIsIF9vZmZlcik7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEZhaWx1cmUKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKG1lc3NhZ2UsIGVycm9yUmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlckVycm9yKCJQZWVyQ29ubmVjdGlvbi5zdXNjcmliZVByb2Nlc3NvciAiICsgbWVzc2FnZSArICI6ICIgKyBlcnJvclJlYXNvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlckVycm9yID0gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgT1QuZXJyb3IoZXJyb3JSZWFzb24pOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgZXJyb3JSZWFzb24pOwogICAgICAgIH0uYmluZCh0aGlzKTsKCiAgICB0aGlzLmFkZExvY2FsU3RyZWFtID0gZnVuY3Rpb24od2ViUlRDU3RyZWFtKSB7CiAgICAgICAgc2V0dXBQZWVyQ29ubmVjdGlvbigpOwogICAgICAgIF9wZWVyQ29ubmVjdGlvbi5hZGRTdHJlYW0od2ViUlRDU3RyZWFtKTsKICAgIH07CgogICAgdGhpcy5kaXNjb25uZWN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgX2ljZVByb2Nlc3NvciA9IG51bGw7CgogICAgICAgIGlmIChfcGVlckNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IChfcGVlckNvbm5lY3Rpb24uc2lnbmFsaW5nU3RhdGUgfHwgX3BlZXJDb25uZWN0aW9uLnJlYWR5U3RhdGUpOwogICAgICAgICAgICBpZiAoY3VycmVudFN0YXRlICYmIGN1cnJlbnRTdGF0ZS50b0xvd2VyQ2FzZSgpICE9PSAnY2xvc2VkJykgX3BlZXJDb25uZWN0aW9uLmNsb3NlKCk7CgogICAgICAgICAgICAvLyBJbiB0aGVvcnksIGNhbGxpbmcgY2xvc2Ugb24gdGhlIFBlZXJDb25uZWN0aW9uIHNob3VsZCB0cmlnZ2VyIGEgc3RhdGVjaGFuZ2UKICAgICAgICAgICAgLy8gZXZlbnQgd2l0aCAnY2xvc2UnLiBGb3Igc29tZSByZWFzb24gSSdtIG5vdCBzZWVpbmcgdGhpcyBpbiBGRiwgaGVuY2Ugd2UncmUKICAgICAgICAgICAgLy8gY2FsbGluZyBpdCBtYW51YWxseSBiZWxvdwogICAgICAgICAgICB0ZWFyRG93blBlZXJDb25uZWN0aW9uLmNhbGwodGhpcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLm9mZigpOwogICAgfTsKCiAgICB0aGlzLnByb2Nlc3NNZXNzYWdlID0gZnVuY3Rpb24odHlwZSwgbWVzc2FnZSkgewogICAgICAgIE9ULmRlYnVnKCJQZWVyQ29ubmVjdGlvbi5wcm9jZXNzTWVzc2FnZTogUmVjZWl2ZWQgIiArIHR5cGUgKyAiIGZyb20gIiArIG1lc3NhZ2UuZnJvbUFkZHJlc3MpOwogICAgICAgIE9ULmRlYnVnKG1lc3NhZ2UpOwoKICAgICAgICBzd2l0Y2godHlwZSkgewogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLlNVQlNDUklCRToKICAgICAgICAgICAgICAgIHByb2Nlc3NTdWJzY3JpYmUuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5PRkZFUjoKICAgICAgICAgICAgICAgIHByb2Nlc3NPZmZlci5jYWxsKHRoaXMsIG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLkFOU1dFUjoKICAgICAgICAgICAgLy8gY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5QUkFOU1dFUjoKICAgICAgICAgICAgICAgIHByb2Nlc3NBbnN3ZXIuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DQU5ESURBVEU6CiAgICAgICAgICAgICAgICBfaWNlUHJvY2Vzc29yLnByb2Nlc3MobWVzc2FnZSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBPVC5kZWJ1ZygiUGVlckNvbm5lY3Rpb24ucHJvY2Vzc01lc3NhZ2U6IFJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgbWVzc2FnZSBvZiB0eXBlICIgKyB0eXBlICsgIiBmcm9tICIgKyBtZXNzYWdlLmZyb21BZGRyZXNzICsgIjogIiArIEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB0aGlzLnJlZ2lzdGVyTWVzc2FnZURlbGVnYXRlID0gZnVuY3Rpb24oZGVsZWdhdGVGbikgewogICAgICAgIHJldHVybiBfbWVzc2FnZURlbGVnYXRlcy5wdXNoKGRlbGVnYXRlRm4pOwogICAgfTsKCiAgICB0aGlzLnVucmVnaXN0ZXJNZXNzYWdlRGVsZWdhdGUgPSBmdW5jdGlvbihkZWxlZ2F0ZUZuKSB7CiAgICAgICAgdmFyIGluZGV4ID0gX21lc3NhZ2VEZWxlZ2F0ZXMuaW5kZXhPZihkZWxlZ2F0ZUZuKTsKCiAgICAgICAgaWYgKCBpbmRleCAhPT0gLTEgKSB7CiAgICAgICAgICAgIF9tZXNzYWdlRGVsZWdhdGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBfbWVzc2FnZURlbGVnYXRlcy5sZW5ndGg7CiAgICB9OwoKICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSBQZWVyQ29ubmVjdGlvbiBzdGF0cy4KICAgICAqCiAgICAgKiBUT0RPIGRvY3VtZW50IHdoYXQgdGhlIGZvcm1hdCBvZiB0aGUgZmluYWwgcmVwb3J0cyB0aGF0ICtjYWxsYmFjaysgZ2V0cyBpcwogICAgICoKICAgICAqIEBpZ25vcmUKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbWVtYmVyb2YgUGVlckNvbm5lY3Rpb24KICAgICAqIEBwYXJhbSBjYWxsYmFjayB7RnVuY3Rpb259IHRoaXMgd2lsbCBiZSB0cmlnZ2VyZWQgb25jZSB0aGUgc3RhdHMgYSBhcmUgcmVhZHkuCiAgICAgKiBJdCB0YWtlcyBhIHNpbmdsZSBhcmd1bWVudCB3aGljaCBpcyB0aGUgc3RhdHMgcmVwb3J0LCB3aGljaCBtYXkgYmUgdW5kZWZpbmVkCiAgICAgKiBpZiB0aGVyZSBpcyBwcmVzZW50bHkgbm8gc3RhdHMuCiAgICAgKi8KICAgIHRoaXMuZ2V0U3RhdHMgPSBmdW5jdGlvbihwcmV2U3RhdHMsIGNhbGxiYWNrKSB7CiAgICAgICAgLy8gbmVlZCB0byBtYWtlIHN1cmUgdGhhdCB0aGlzIGlzbid0IGNhbGxlZCBhZ2FpbiB3aGVuIGluIHRoZSBtaWRkbGUgb2YgcHJvY2Vzc2luZwogICAgICAgIGlmIChfZ2V0dGluZ1N0YXRzID09IHRydWUpIHsKICAgICAgICAgICAgT1Qud2FybigiUGVlckNvbm5lY3Rpb24uZ2V0U3RhdHM6IEFscmVhZHkgZ2V0dGluZyB0aGUgc3RhdHMhIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIGxvY2tpbmcgdGhpcyBmdW5jdGlvbgogICAgICAgIF9nZXR0aW5nU3RhdHMgPSB0cnVlOwoKICAgICAgICAvLyBnZXQgdGhlIHByZXZpb3VzIHRpbWVzdGFtcCAoc2Vjb25kcykKICAgICAgICB2YXIgbm93ID0gT1QuJC5ub3coKTsKICAgICAgICB2YXIgdGltZV9kaWZmZXJlbmNlID0gKG5vdyAtIHByZXZTdGF0c1sidGltZVN0YW1wIl0pIC8gMTAwMDsgLy8gaG93IG1hbnkgc2Vjb25kcyBoYXMgcGFzc2VkCgogICAgICAgIC8vIG5vdyB1cGRhdGUgdGhlIGRhdGUKICAgICAgICBwcmV2U3RhdHNbInRpbWVTdGFtcCJdID0gbm93OwoKICAgICAgICAvKiB0aGlzIHBhcnNlcyBhIHJlc3VsdCBpZiB0aGVyZSBpdCBjb250YWlucyB0aGUgdmlkZW8gYml0cmF0ZSAqLwogICAgICAgIHZhciBwYXJzZUF2Z1ZpZGVvQml0cmF0ZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgICB2YXIgbGFzdF9ieXRlc1NlbnQgPSBwcmV2U3RhdHNbInZpZGVvQnl0ZXNUcmFuc2ZlcnJlZCJdIHx8IDA7CgogICAgICAgICAgICBpZiAocmVzdWx0LnN0YXQoImdvb2dGcmFtZUhlaWdodFNlbnQiKSkgewogICAgICAgICAgICAgICAgcHJldlN0YXRzWyJ2aWRlb0J5dGVzVHJhbnNmZXJyZWQiXSA9IHJlc3VsdC5zdGF0KCJieXRlc1NlbnQiKTsKICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKChwcmV2U3RhdHNbInZpZGVvQnl0ZXNUcmFuc2ZlcnJlZCJdIC0gbGFzdF9ieXRlc1NlbnQpICogOCAvIHRpbWVfZGlmZmVyZW5jZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzdWx0LnN0YXQoImdvb2dGcmFtZUhlaWdodFJlY2VpdmVkIikpIHsKICAgICAgICAgICAgICAgIHByZXZTdGF0c1sidmlkZW9CeXRlc1RyYW5zZmVycmVkIl0gPSByZXN1bHQuc3RhdCgiYnl0ZXNSZWNlaXZlZCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoKHByZXZTdGF0c1sidmlkZW9CeXRlc1RyYW5zZmVycmVkIl0gLSBsYXN0X2J5dGVzU2VudCkgKiA4IC8gdGltZV9kaWZmZXJlbmNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBOYU47CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKiB0aGlzIHBhcnNlcyBhIHJlc3VsdCBpZiB0aGVyZSBpdCBjb250YWlucyB0aGUgYXVkaW8gYml0cmF0ZSAqLwogICAgICAgIHZhciBwYXJzZUF2Z0F1ZGlvQml0cmF0ZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgICB2YXIgbGFzdF9ieXRlc1NlbnQgPSBwcmV2U3RhdHNbImF1ZGlvQnl0ZXNUcmFuc2ZlcnJlZCJdIHx8IDA7CgogICAgICAgICAgICBpZiAocmVzdWx0LnN0YXQoImF1ZGlvSW5wdXRMZXZlbCIpKSB7CiAgICAgICAgICAgICAgICBwcmV2U3RhdHNbImF1ZGlvQnl0ZXNUcmFuc2ZlcnJlZCJdID0gcmVzdWx0LnN0YXQoImJ5dGVzU2VudCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoKHByZXZTdGF0c1siYXVkaW9CeXRlc1RyYW5zZmVycmVkIl0gLSBsYXN0X2J5dGVzU2VudCkgKiA4IC8gdGltZV9kaWZmZXJlbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQuc3RhdCgiYXVkaW9PdXRwdXRMZXZlbCIpKSB7CiAgICAgICAgICAgICAgICBwcmV2U3RhdHNbImF1ZGlvQnl0ZXNUcmFuc2ZlcnJlZCJdID0gcmVzdWx0LnN0YXQoImJ5dGVzUmVjZWl2ZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKChwcmV2U3RhdHNbImF1ZGlvQnl0ZXNUcmFuc2ZlcnJlZCJdIC0gbGFzdF9ieXRlc1NlbnQpICogOCAvIHRpbWVfZGlmZmVyZW5jZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gTmFOOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHBhcnNlZF9zdGF0cyA9IHt9OwogICAgICAgIHZhciBwYXJzZVN0YXRzUmVwb3J0cyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICAgICAgICAgIGlmIChzdGF0cy5yZXN1bHQpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHRfbGlzdCA9IHN0YXRzLnJlc3VsdCgpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgcmVzdWx0X2luZGV4ID0gMDsgcmVzdWx0X2luZGV4IDwgcmVzdWx0X2xpc3QubGVuZ3RoOyByZXN1bHRfaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgIHZhciByZXBvcnQgPSB7fTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gcmVzdWx0X2xpc3RbcmVzdWx0X2luZGV4XTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnN0YXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF2Z1ZpZGVvQml0cmF0ZSA9IHBhcnNlQXZnVmlkZW9CaXRyYXRlKHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYXZnVmlkZW9CaXRyYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkX3N0YXRzWyJhdmdWaWRlb0JpdHJhdGUiXSA9IGF2Z1ZpZGVvQml0cmF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF2Z0F1ZGlvQml0cmF0ZSA9IHBhcnNlQXZnQXVkaW9CaXRyYXRlKHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYXZnQXVkaW9CaXRyYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkX3N0YXRzWyJhdmdBdWRpb0JpdHJhdGUiXSA9IGF2Z0F1ZGlvQml0cmF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2dldHRpbmdTdGF0cyA9IGZhbHNlOwogICAgICAgICAgICBjYWxsYmFjayhwYXJzZWRfc3RhdHMpOwogICAgICAgIH0KICAgICAgICBwYXJzZWRfc3RhdHNbImR1cmF0aW9uIl0gPSBNYXRoLnJvdW5kKG5vdyAtIF9jcmVhdGVUaW1lKTsKCgogICAgICAgIGlmIChfcGVlckNvbm5lY3Rpb24gJiYgX3BlZXJDb25uZWN0aW9uLmdldFN0YXRzKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5nZXRTdGF0cyhwYXJzZVN0YXRzUmVwb3J0cyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdGhlcmUgd2FzIG5vIHBlZXIgY29ubmVjdGlvbiB5ZXQgb3IgZ2V0U3RhdHMgaXNuJ3QgaW1wbGVtZW50ZWQgaW4gdGhpcyBlbnZpcm9tZW50CiAgICAgICAgICAgIF9nZXR0aW5nU3RhdHMgPSBmYWxzZTsKICAgICAgICAgICAgY2FsbGJhY2socGFyc2VkX3N0YXRzKTsKICAgICAgICB9CiAgICB9OwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAncmVtb3RlU3RyZWFtcycsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX3BlZXJDb25uZWN0aW9uID8gZ2V0UmVtb3RlU3RyZWFtcygpIDogW107CiAgICAgICAgfQogICAgfSk7Cn07Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7Cgp2YXIgX3BlZXJDb25uZWN0aW9ucyA9IHt9OwoKT1QuUGVlckNvbm5lY3Rpb25zID0gewogICAgYWRkOiBmdW5jdGlvbihyZW1vdGVDb25uZWN0aW9uLCBzdHJlYW0sIGNvbmZpZykgewogICAgICAgIHZhciBrZXkgPSByZW1vdGVDb25uZWN0aW9uLmlkICsgIl8iICsgc3RyZWFtLmlkLAogICAgICAgICAgICByZWYgPSBfcGVlckNvbm5lY3Rpb25zW2tleV07CgogICAgICAgIGlmICghcmVmKSB7CiAgICAgICAgICAgIHJlZiA9IF9wZWVyQ29ubmVjdGlvbnNba2V5XSA9IHsKICAgICAgICAgICAgICAgIGNvdW50OiAwLAogICAgICAgICAgICAgICAgcGM6IG5ldyBPVC5QZWVyQ29ubmVjdGlvbihjb25maWcpCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvLyBpbmNyZWFzZSB0aGUgUENzIHJlZiBjb3VudCBieSAxCiAgICAgICAgcmVmLmNvdW50ICs9IDE7CgogICAgICAgIHJldHVybiByZWYucGM7CiAgICB9LAoKICAgIHJlbW92ZTogZnVuY3Rpb24ocmVtb3RlQ29ubmVjdGlvbiwgc3RyZWFtKSB7CiAgICAgICAgdmFyIGtleSA9IHJlbW90ZUNvbm5lY3Rpb24uaWQgKyAiXyIgKyBzdHJlYW0uaWQsCiAgICAgICAgICAgIHJlZiA9IF9wZWVyQ29ubmVjdGlvbnNba2V5XTsKCiAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICByZWYuY291bnQgLT0gMTsKCiAgICAgICAgICAgIGlmIChyZWYuY291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJlZi5wYy5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgICBkZWxldGUgX3BlZXJDb25uZWN0aW9uc1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8qKgogKiBBYnN0cmFjdHMgUGVlckNvbm5lY3Rpb24gcmVsYXRlZCBzdHVmZiBhd2F5IGZyb20gT1QuUHVibGlzaGVyLgogKgogKiBSZXNwb25zaWJsZSBmb3I6CiAqICogc2V0dGluZyB1cCB0aGUgdW5kZXJseWluZyBQZWVyQ29ubmVjdGlvbiAoZGVsZWdhdGVzIHRvIE9ULlBlZXJDb25uZWN0aW9ucykKICogKiB0cmlnZ2VyaW5nIGEgY29ubmVjdGVkIGV2ZW50IHdoZW4gdGhlIFBlZXIgY29ubmVjdGlvbiBpcyBvcGVuZWQKICogKiB0cmlnZ2VyaW5nIGEgZGlzY29ubmVjdGVkIGV2ZW50IHdoZW4gdGhlIFBlZXIgY29ubmVjdGlvbiBpcyBjbG9zZWQKICogKiBwcm92aWRpbmcgYSBkZXN0cm95IG1ldGhvZAogKiAqIHByb3ZpZGluZyBhIHByb2Nlc3NNZXNzYWdlIG1ldGhvZAogKgogKiBPbmNlIHRoZSBQZWVyQ29ubmVjdGlvbiBpcyBjb25uZWN0ZWQgYW5kIHRoZSB2aWRlbyBlbGVtZW50IHBsYXlpbmcgaXQgdHJpZ2dlcnMgdGhlIGNvbm5lY3RlZCBldmVudAogKgogKiBUcmlnZ2VycyB0aGUgZm9sbG93aW5nIGV2ZW50cwogKiAqIGNvbm5lY3RlZAogKiAqIGRpc2Nvbm5lY3RlZAogKi8KT1QuUHVibGlzaGVyUGVlckNvbm5lY3Rpb24gPSBmdW5jdGlvbihyZW1vdGVDb25uZWN0aW9uLCBzZXNzaW9uLCBzdHJlYW0sIHdlYlJUQ1N0cmVhbSkgewogICAgdmFyIF9wZWVyQ29ubmVjdGlvbiwKICAgICAgICBfaGFzUmVsYXlDYW5kaWRhdGVzID0gZmFsc2U7CgogICAgLy8gUHJpdmF0ZQogICAgdmFyIF9vblBlZXJDbG9zZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignZGlzY29ubmVjdGVkJywgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gTm90ZTogQWxsIFBlZXIgZXJyb3JzIGFyZSBmYXRhbCByaWdodCBub3cuCiAgICAgICAgX29uUGVlckVycm9yID0gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG51bGwsIGVycm9yUmVhc29uLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgfSwKCiAgICAgICAgX3JlbGF5TWVzc2FnZVRvUGVlciA9IGZ1bmN0aW9uKHR5cGUsIHBheWxvYWQpIHsKICAgICAgICAgICAgaWYgKCFfaGFzUmVsYXlDYW5kaWRhdGVzKXsKICAgICAgICAgICAgICAgIHZhciBleHRyYWN0Q2FuZGlkYXRlcyA9IHR5cGUgPT09IE9ULlJhcHRvci5BY3Rpb25zLkNBTkRJREFURSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuT0ZGRVIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPT09IE9ULlJhcHRvci5BY3Rpb25zLkFOU1dFUiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuUFJBTlNXRVIgOwoKICAgICAgICAgICAgICAgIGlmIChleHRyYWN0Q2FuZGlkYXRlcykgewogICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gKHR5cGUgPT09IE9ULlJhcHRvci5BY3Rpb25zLkNBTkRJREFURSkgPyBwYXlsb2FkLmNhbmRpZGF0ZSA6IHBheWxvYWQuc2RwOwogICAgICAgICAgICAgICAgICAgIF9oYXNSZWxheUNhbmRpZGF0ZXMgPSBtZXNzYWdlLmluZGV4T2YoJ3R5cCByZWxheScpICE9PSAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5BTlNXRVI6CiAgICAgICAgICAgIGNhc2UgT1QuUmFwdG9yLkFjdGlvbnMuUFJBTlNXRVI6CiAgICAgICAgICAgICAgICBzZXNzaW9uLl8uanNlcEFuc3dlcihyZW1vdGVDb25uZWN0aW9uLmlkLCBzdHJlYW0sIHBheWxvYWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLk9GRkVSOgogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdjb25uZWN0ZWQnKTsKICAgICAgICAgICAgICAgIHNlc3Npb24uXy5qc2VwT2ZmZXIocmVtb3RlQ29ubmVjdGlvbi5pZCwgc3RyZWFtLCBwYXlsb2FkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5DQU5ESURBVEU6CiAgICAgICAgICAgICAgICBzZXNzaW9uLl8uanNlcENhbmRpZGF0ZShyZW1vdGVDb25uZWN0aW9uLmlkLCBzdHJlYW0sIHBheWxvYWQpOwogICAgICAgICAgICB9CiAgICAgICAgfS5iaW5kKHRoaXMpOwoKCiAgICBPVC4kLmV2ZW50aW5nKHRoaXMpOwoKICAgIC8vIFB1YmxpYwogICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gQ2xlYW4gdXAgb3VyIFBlZXJDb25uZWN0aW9uCiAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICBPVC5QZWVyQ29ubmVjdGlvbnMucmVtb3ZlKHJlbW90ZUNvbm5lY3Rpb24sIHN0cmVhbSk7CiAgICAgICAgfQoKICAgICAgICBfcGVlckNvbm5lY3Rpb24gPSBudWxsOwoKICAgICAgICB0aGlzLm9mZigpOwogICAgfTsKCiAgICB0aGlzLnByb2Nlc3NNZXNzYWdlID0gZnVuY3Rpb24odHlwZSwgbWVzc2FnZSkgewogICAgICAgIF9wZWVyQ29ubmVjdGlvbi5wcm9jZXNzTWVzc2FnZSh0eXBlLCBtZXNzYWdlKTsKICAgIH07CgogICAgdGhpcy5nZXRTdGF0cyA9IGZ1bmN0aW9uKHByZXZTdGF0cywgY2FsbGJhY2spIHsKICAgICAgICBfcGVlckNvbm5lY3Rpb24uZ2V0U3RhdHMocHJldlN0YXRzLCBjYWxsYmFjayk7CiAgICB9CgogICAgLy8gSW5pdAogICAgdGhpcy5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGljZVNlcnZlcnMgPSBzZXNzaW9uLnNlc3Npb25JbmZvLmljZVNlcnZlcnMubWFwKGZ1bmN0aW9uKGlzKSB7CiAgICAgICAgICAgIHZhciBpY2VTZXJ2ZXIgPSBPVC4kLmNsb25lKGlzKTsKCiAgICAgICAgICAgIGlmIChpY2VTZXJ2ZXIudXJsLnRyaW0oKS5zdWJzdHIoMCwgNSkgPT09ICd0dXJuOicpIHsKICAgICAgICAgICAgICAgIC8vIE1ha2UgdGhlIHVzZXJuYW1lIHNlc3Npb25JZDpjb25uZWN0aW9uSWQ6c3RyZWFtSWQgZm9yIHRyYWNraW5nIHB1cnBvc2VzLgogICAgICAgICAgICAgICAgaWNlU2VydmVyLnVzZXJuYW1lID0gc2Vzc2lvbi5pZCArICcuJyArIHNlc3Npb24uY29ubmVjdGlvbi5pZCArICcuJyArIHN0cmVhbS5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGljZVNlcnZlcjsKICAgICAgICB9KTsKCiAgICAgICAgX3BlZXJDb25uZWN0aW9uID0gT1QuUGVlckNvbm5lY3Rpb25zLmFkZChyZW1vdGVDb25uZWN0aW9uLCBzdHJlYW0sIHsKICAgICAgICAgICAgaWNlU2VydmVyczogaWNlU2VydmVycwogICAgICAgIH0pOwoKICAgICAgICBfcGVlckNvbm5lY3Rpb24ub24oewogICAgICAgICAgICBjbG9zZTogX29uUGVlckNsb3NlZCwKICAgICAgICAgICAgZXJyb3I6IF9vblBlZXJFcnJvcgogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICBfcGVlckNvbm5lY3Rpb24ucmVnaXN0ZXJNZXNzYWdlRGVsZWdhdGUoX3JlbGF5TWVzc2FnZVRvUGVlcik7CiAgICAgICAgX3BlZXJDb25uZWN0aW9uLmFkZExvY2FsU3RyZWFtKHdlYlJUQ1N0cmVhbSk7CgogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAncmVtb3RlQ29ubmVjdGlvbicsIHt2YWx1ZTogcmVtb3RlQ29ubmVjdGlvbn0pOwoKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2hhc1JlbGF5Q2FuZGlkYXRlcycsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9oYXNSZWxheUNhbmRpZGF0ZXM7IH0KICAgICAgICB9KTsKICAgIH0KfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8qKgogKiBBYnN0cmFjdHMgUGVlckNvbm5lY3Rpb24gcmVsYXRlZCBzdHVmZiBhd2F5IGZyb20gT1QuU3Vic2NyaWJlci4KICoKICogUmVzcG9uc2libGUgZm9yOgogKiAqIHNldHRpbmcgdXAgdGhlIHVuZGVybHlpbmcgUGVlckNvbm5lY3Rpb24gKGRlbGVnYXRlcyB0byBPVC5QZWVyQ29ubmVjdGlvbnMpCiAqICogdHJpZ2dlcmluZyBhIGNvbm5lY3RlZCBldmVudCB3aGVuIHRoZSBQZWVyIGNvbm5lY3Rpb24gaXMgb3BlbmVkCiAqICogdHJpZ2dlcmluZyBhIGRpc2Nvbm5lY3RlZCBldmVudCB3aGVuIHRoZSBQZWVyIGNvbm5lY3Rpb24gaXMgY2xvc2VkCiAqICogY3JlYXRpbmcgYSB2aWRlbyBlbGVtZW50IHdoZW4gYSBzdHJlYW0gaXMgYWRkZWQKICogKiByZXNwb25kaW5nIHRvIHN0cmVhbSByZW1vdmVkIGludGVsbGlnZW50bHkKICogKiBwcm92aWRpbmcgYSBkZXN0cm95IG1ldGhvZAogKiAqIHByb3ZpZGluZyBhIHByb2Nlc3NNZXNzYWdlIG1ldGhvZAogKgogKiBPbmNlIHRoZSBQZWVyQ29ubmVjdGlvbiBpcyBjb25uZWN0ZWQgYW5kIHRoZSB2aWRlbyBlbGVtZW50IHBsYXlpbmcgaXQgdHJpZ2dlcnMgdGhlIGNvbm5lY3RlZCBldmVudAogKgogKiBUcmlnZ2VycyB0aGUgZm9sbG93aW5nIGV2ZW50cwogKiAqIGNvbm5lY3RlZAogKiAqIGRpc2Nvbm5lY3RlZAogKiAqIHJlbW90ZVN0cmVhbUFkZGVkCiAqICogcmVtb3RlU3RyZWFtUmVtb3ZlZAogKiAqIGVycm9yCiAqCiAqLwoKT1QuU3Vic2NyaWJlclBlZXJDb25uZWN0aW9uID0gZnVuY3Rpb24ocmVtb3RlQ29ubmVjdGlvbiwgc2Vzc2lvbiwgc3RyZWFtLCBwcm9wZXJ0aWVzKSB7CiAgICB2YXIgX3BlZXJDb25uZWN0aW9uLAogICAgICAgIF9oYXNSZWxheUNhbmRpZGF0ZXMgPSBmYWxzZTsKCiAgICAvLyBQcml2YXRlCiAgICB2YXIgX29uUGVlckNsb3NlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdkaXNjb25uZWN0ZWQnLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBfb25SZW1vdGVTdHJlYW1BZGRlZCA9IGZ1bmN0aW9uKHJlbW90ZVJUQ1N0cmVhbSkgewogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3JlbW90ZVN0cmVhbUFkZGVkJywgcmVtb3RlUlRDU3RyZWFtLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBfb25SZW1vdGVTdHJlYW1SZW1vdmVkID0gZnVuY3Rpb24ocmVtb3RlUlRDU3RyZWFtKSB7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcigncmVtb3RlU3RyZWFtUmVtb3ZlZCcsIHJlbW90ZVJUQ1N0cmVhbSwgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gTm90ZTogQWxsIFBlZXIgZXJyb3JzIGFyZSBmYXRhbCByaWdodCBub3cuCiAgICAgICAgX29uUGVlckVycm9yID0gZnVuY3Rpb24oZXJyb3JSZWFzb24pIHsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG51bGwsIGVycm9yUmVhc29uLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBfcmVsYXlNZXNzYWdlVG9QZWVyID0gZnVuY3Rpb24odHlwZSwgcGF5bG9hZCkgewogICAgICAgICAgICBpZiAoIV9oYXNSZWxheUNhbmRpZGF0ZXMpewogICAgICAgICAgICAgICAgdmFyIGV4dHJhY3RDYW5kaWRhdGVzID0gdHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuQ0FORElEQVRFIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSBPVC5SYXB0b3IuQWN0aW9ucy5PRkZFUiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuQU5TV0VSIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSBPVC5SYXB0b3IuQWN0aW9ucy5QUkFOU1dFUiA7CgogICAgICAgICAgICAgICAgaWYgKGV4dHJhY3RDYW5kaWRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSAodHlwZSA9PT0gT1QuUmFwdG9yLkFjdGlvbnMuQ0FORElEQVRFKSA/IHBheWxvYWQuY2FuZGlkYXRlIDogcGF5bG9hZC5zZHA7CiAgICAgICAgICAgICAgICAgICAgX2hhc1JlbGF5Q2FuZGlkYXRlcyA9IG1lc3NhZ2UuaW5kZXhPZigndHlwIHJlbGF5JykgIT09IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2godHlwZSkgewogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLkFOU1dFUjoKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5QUkFOU1dFUjoKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY29ubmVjdGVkJyk7CiAgICAgICAgICAgICAgICBzZXNzaW9uLl8uanNlcEFuc3dlcihyZW1vdGVDb25uZWN0aW9uLmlkLCBzdHJlYW0sIHBheWxvYWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLk9GRkVSOgogICAgICAgICAgICAgICAgc2Vzc2lvbi5fLmpzZXBPZmZlcihyZW1vdGVDb25uZWN0aW9uLmlkLCBzdHJlYW0sIHBheWxvYWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIE9ULlJhcHRvci5BY3Rpb25zLkNBTkRJREFURToKICAgICAgICAgICAgICAgIHNlc3Npb24uXy5qc2VwQ2FuZGlkYXRlKHJlbW90ZUNvbm5lY3Rpb24uaWQsIHN0cmVhbSwgcGF5bG9hZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LmJpbmQodGhpcyksCgogICAgICAgIC8vIEhlbHBlciBtZXRob2QgdXNlZCBieSBzdWJzY3JpYmVUb0F1ZGlvL3N1YnNjcmliZVRvVmlkZW8KICAgICAgICBfc2V0RW5hYmxlZE9uU3RyZWFtVHJhY2tzQ3VycnkgPSBmdW5jdGlvbihpc1ZpZGVvKSB7CiAgICAgICAgICAgIHZhciBtZXRob2QgPSAnZ2V0JyArIChpc1ZpZGVvID8gJ1ZpZGVvJyA6ICdBdWRpbycpICsgJ1RyYWNrcyc7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZW5hYmxlZCkgewogICAgICAgICAgICAgICAgdmFyIHJlbW90ZVN0cmVhbXMgPSBfcGVlckNvbm5lY3Rpb24ucmVtb3RlU3RyZWFtcywKICAgICAgICAgICAgICAgICAgICB0cmFja3MsCiAgICAgICAgICAgICAgICAgICAgc3RyZWFtOwoKICAgICAgICAgICAgICAgIGlmIChyZW1vdGVTdHJlYW1zLmxlbmd0aCA9PT0gMCB8fCAhcmVtb3RlU3RyZWFtc1swXVttZXRob2RdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZWl0aGVyIHRoZXJlIGlzIG5vIHJlbW90ZSBzdHJlYW0gb3Igd2UgYXJlIGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3QKICAgICAgICAgICAgICAgICAgICAvLyBleHBvc2UgdGhlIG1lZGlhIHRyYWNrcyAoRmlyZWZveCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBudW09cmVtb3RlU3RyZWFtcy5sZW5ndGg7IGk8bnVtOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBzdHJlYW0gPSByZW1vdGVTdHJlYW1zW2ldOwogICAgICAgICAgICAgICAgICAgIHRyYWNrcyA9IHN0cmVhbVttZXRob2RdKCk7CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGs9MCwgbnVtVHJhY2tzPXRyYWNrcy5sZW5ndGg7IGsgPCBudW1UcmFja3M7ICsrayl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrc1trXS5lbmFibGVkPWVuYWJsZWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CgoKICAgIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogICAgLy8gUHVibGljCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgIHZhciBudW1EZWxlZ2F0ZXMgPSBfcGVlckNvbm5lY3Rpb24udW5yZWdpc3Rlck1lc3NhZ2VEZWxlZ2F0ZShfcmVsYXlNZXNzYWdlVG9QZWVyKTsKCiAgICAgICAgLy8gT25seSBjbGVhbiB1cCB0aGUgUGVlckNvbm5lY3Rpb24gaWYgdGhlcmUgaXNuJ3QgYW5vdGhlciBTdWJzY3JpYmVyIHVzaW5nIGl0CiAgICAgICAgaWYgKG51bURlbGVnYXRlcyA9PT0gMCkgewogICAgICAgICAgLy8gVW5zdWJzY3JpYmUgdXMgZnJvbSB0aGUgc3RyZWFtLCBpZiBpdCBoYXNuJ3QgYWxyZWFkeSBiZWVuIGRlc3Ryb3llZAogICAgICAgICAgaWYgKHNlc3Npb24gJiYgc2Vzc2lvbi5jb25uZWN0ZWQgJiYgc3RyZWFtICYmICFzdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBzZXJ2ZXIgY29tcG9uZW50cwogICAgICAgICAgICAgIHNlc3Npb24uXy5qc2VwVW5zdWJzY3JpYmUoc3RyZWFtKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZWY6IE9QRU5UT0stMjQ1OCBkaXNhYmxlIGFsbCBhdWRpbyB0cmFja3MgYmVmb3JlIHJlbW92aW5nIGl0LgogICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb0F1ZGlvKGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgT1QuUGVlckNvbm5lY3Rpb25zLnJlbW92ZShyZW1vdGVDb25uZWN0aW9uLCBzdHJlYW0uc3RyZWFtSWQpOwogICAgICB9CiAgICAgIF9wZWVyQ29ubmVjdGlvbiA9IG51bGw7CiAgICAgIHRoaXMub2ZmKCk7CiAgICB9OwoKICAgIHRoaXMucHJvY2Vzc01lc3NhZ2UgPSBmdW5jdGlvbih0eXBlLCBtZXNzYWdlKSB7CiAgICAgICAgX3BlZXJDb25uZWN0aW9uLnByb2Nlc3NNZXNzYWdlKHR5cGUsIG1lc3NhZ2UpOwogICAgfTsKCiAgICB0aGlzLmdldFN0YXRzID0gZnVuY3Rpb24ocHJldlN0YXRzLCBjYWxsYmFjaykgewogICAgICAgIF9wZWVyQ29ubmVjdGlvbi5nZXRTdGF0cyhwcmV2U3RhdHMsIGNhbGxiYWNrKTsKICAgIH07CgogICAgdGhpcy5zdWJzY3JpYmVUb0F1ZGlvID0gX3NldEVuYWJsZWRPblN0cmVhbVRyYWNrc0N1cnJ5KGZhbHNlKTsKICAgIHRoaXMuc3Vic2NyaWJlVG9WaWRlbyA9IF9zZXRFbmFibGVkT25TdHJlYW1UcmFja3NDdXJyeSh0cnVlKTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2hhc1JlbGF5Q2FuZGlkYXRlcycsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2hhc1JlbGF5Q2FuZGlkYXRlczsgfQogICAgfSk7CgoKICAgIC8vIEluaXQKICAgIHRoaXMuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpY2VTZXJ2ZXJzID0gc2Vzc2lvbi5zZXNzaW9uSW5mby5pY2VTZXJ2ZXJzLm1hcChmdW5jdGlvbihpcykgewogICAgICAgICAgICB2YXIgaWNlU2VydmVyID0gT1QuJC5jbG9uZShpcyk7CgogICAgICAgICAgICBpZiAoaWNlU2VydmVyLnVybC50cmltKCkuc3Vic3RyKDAsIDUpID09PSAndHVybjonKSB7CiAgICAgICAgICAgICAgICAvLyBNYWtlIHRoZSB1c2VybmFtZSBzZXNzaW9uSWQ6Y29ubmVjdGlvbklkOnN0cmVhbUlkIGZvciB0cmFja2luZyBwdXJwb3Nlcy4KICAgICAgICAgICAgICAgIGljZVNlcnZlci51c2VybmFtZSA9IHNlc3Npb24uaWQgKyAnLicgKyBzZXNzaW9uLmNvbm5lY3Rpb24uaWQgKyAnLicgKyBzdHJlYW0uaWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBpY2VTZXJ2ZXI7CiAgICAgICAgfSk7CgogICAgICAgIF9wZWVyQ29ubmVjdGlvbiA9IE9ULlBlZXJDb25uZWN0aW9ucy5hZGQocmVtb3RlQ29ubmVjdGlvbiwgc3RyZWFtLnN0cmVhbUlkLCB7CiAgICAgICAgICAgIGljZVNlcnZlcnM6IGljZVNlcnZlcnMKICAgICAgICB9KTsKCiAgICAgICAgX3BlZXJDb25uZWN0aW9uLm9uKHsKICAgICAgICAgICAgY2xvc2U6IF9vblBlZXJDbG9zZWQsCiAgICAgICAgICAgIHN0cmVhbUFkZGVkOiBfb25SZW1vdGVTdHJlYW1BZGRlZCwKICAgICAgICAgICAgc3RyZWFtUmVtb3ZlZDogX29uUmVtb3RlU3RyZWFtUmVtb3ZlZCwKICAgICAgICAgICAgZXJyb3I6IF9vblBlZXJFcnJvcgogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICB2YXIgbnVtRGVsZWdhdGVzID0gX3BlZXJDb25uZWN0aW9uLnJlZ2lzdGVyTWVzc2FnZURlbGVnYXRlKF9yZWxheU1lc3NhZ2VUb1BlZXIpOwoKICAgICAgICAvLyBJZiB0aGVyZSBhcmUgYWxyZWFkeSByZW1vdGVTdHJlYW1zLCBhZGQgdGhlbSBpbW1lZGlhdGVseQogICAgICAgIGlmIChfcGVlckNvbm5lY3Rpb24ucmVtb3RlU3RyZWFtcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5yZW1vdGVTdHJlYW1zLmZvckVhY2goX29uUmVtb3RlU3RyZWFtQWRkZWQsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChudW1EZWxlZ2F0ZXMgPT09IDEpIHsKICAgICAgICAgICAgLy8gV2Ugb25seSBib3RoZXIgd2l0aCB0aGUgUGVlckNvbm5lY3Rpb24gbmVnb3RpYXRpb24gaWYgd2UgYXJlIHRoZSBvbmx5IGRlbGVnYXRlLgogICAgICAgICAgICBzZXNzaW9uLl8uanNlcFN1YnNjcmliZShzdHJlYW0sIHByb3BlcnRpZXMuc3Vic2NyaWJlVG9WaWRlbywgcHJvcGVydGllcy5zdWJzY3JpYmVUb0F1ZGlvKTsKICAgICAgICB9CiAgICB9Owp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTWFuYWdlcyBOIENocm9tZSBlbGVtZW50cwpPVC5DaHJvbWUgPSBmdW5jdGlvbihwcm9wZXJ0aWVzKSB7CiAgICB2YXIgX3Zpc2libGUgPSBmYWxzZSwKICAgICAgICBfd2lkZ2V0cyA9IHt9LAoKICAgICAgICAvLyBQcml2YXRlIGhlbHBlciBmdW5jdGlvbgogICAgICAgIF9zZXQgPSBmdW5jdGlvbihuYW1lLCB3aWRnZXQpIHsKICAgICAgICAgICAgd2lkZ2V0LnBhcmVudCA9IHRoaXM7CiAgICAgICAgICAgIHdpZGdldC5hcHBlbmRUbyhwcm9wZXJ0aWVzLnBhcmVudCk7CgogICAgICAgICAgICBfd2lkZ2V0c1tuYW1lXSA9IHdpZGdldDsKCiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBuYW1lLCB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3dpZGdldHNbbmFtZV07IH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICBpZiAoIXByb3BlcnRpZXMucGFyZW50KSB7CiAgICAgICAgLy8gQHRvZG8gcmFpc2UgYW4gZXhjZXB0aW9uCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5vZmYoKTsKICAgICAgICB0aGlzLmhpZGUoKTsKCiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBfd2lkZ2V0cykgewogICAgICAgICAgICBfd2lkZ2V0c1tuYW1lXS5kZXN0cm95KCk7CiAgICAgICAgfQogICAgfTsKCiAgICB0aGlzLnNob3cgPSBmdW5jdGlvbigpIHsKICAgICAgICBfdmlzaWJsZSA9IHRydWU7CgogICAgICAgIGZvciAodmFyIG5hbWUgaW4gX3dpZGdldHMpIHsKICAgICAgICAgICAgX3dpZGdldHNbbmFtZV0uc2hvdygpOwogICAgICAgIH0KICAgIH07CgogICAgdGhpcy5oaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgX3Zpc2libGUgPSBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBfd2lkZ2V0cykgewogICAgICAgICAgICBfd2lkZ2V0c1tuYW1lXS5oaWRlKCk7CiAgICAgICAgfQogICAgfTsKCgogICAgLy8gQWRkcyB0aGUgd2lkZ2V0IHRvIHRoZSBjaHJvbWUgYW5kIHRvIHRoZSBET00uIEFsc28gY3JlYXRlcyBhIGFjY2Vzc29yCiAgICAvLyBwcm9wZXJ0eSBmb3IgaXQgb24gdGhlIGNocm9tZS4KICAgIC8vCiAgICAvLyBAZXhhbXBsZQogICAgLy8gIGNocm9tZS5zZXQoJ2ZvbycsIG5ldyBGb29XaWRnZXQoKSk7CiAgICAvLyAgY2hyb21lLmZvby5zZXREaXNwbGF5TW9kZSgnb24nKTsKICAgIC8vCiAgICAvLyBAZXhhbXBsZQogICAgLy8gIGNocm9tZS5zZXQoewogICAgLy8gICAgICBmb286IG5ldyBGb29XaWRnZXQoKSwKICAgIC8vICAgICAgYmFyOiBuZXcgQmFyV2lkZ2V0KCkKICAgIC8vICB9KTsKICAgIC8vICBjaHJvbWUuZm9vLnNldERpc3BsYXlNb2RlKCdvbicpOwogICAgLy8KICAgIHRoaXMuc2V0ID0gZnVuY3Rpb24od2lkZ2V0TmFtZSwgd2lkZ2V0KSB7CiAgICAgICAgaWYgKHR5cGVvZih3aWRnZXROYW1lKSA9PT0gInN0cmluZyIgJiYgd2lkZ2V0KSB7CiAgICAgICAgICAgIF9zZXQuY2FsbCh0aGlzLCB3aWRnZXROYW1lLCB3aWRnZXQpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gd2lkZ2V0TmFtZSkgewogICAgICAgICAgICBpZiAod2lkZ2V0TmFtZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgIF9zZXQuY2FsbCh0aGlzLCBuYW1lLCB3aWRnZXROYW1lW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Owp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKaWYgKCFPVC5DaHJvbWUuQmVoYXZpb3VyKSBPVC5DaHJvbWUuQmVoYXZpb3VyID0ge307CgovLyBBIG1peGluIHRvIGVuY2Fwc3VsYXRlIHRoZSBiYXNpYyB3aWRnZXQgYmVoYXZpb3VyLiBUaGlzIG5lZWRzIGEgYmV0dGVyIG5hbWUsCi8vIGl0J3Mgbm90IGFjdHVhbGx5IGEgd2lkZ2V0LiBJdCdzIGFjdHVhbGx5ICJCZWhhdmlvdXIgdGhhdCBjYW4gYmUgYXBwbGllZCB0bwovLyBhbiBvYmplY3QgdG8gbWFrZSBpdCBzdXBwb3J0IHRoZSBiYXNpYyBDaHJvbWUgd2lkZ2V0IHdvcmtmbG93Ii4uLmJ1dCB0aGF0IHdvdWxkCi8vIHByb2JhYmx5IGJlZW4gdG9vIGxvbmcgYSBuYW1lLgpPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCA9IGZ1bmN0aW9uKHdpZGdldCwgb3B0aW9ucykgewogICAgdmFyIF9vcHRpb25zID0gb3B0aW9ucyB8fCB7fSwKICAgICAgICBfbW9kZSwKICAgICAgICBfcHJldmlvdXNNb2RlOwoKICAgIC8vCiAgICAvLyBAcGFyYW0gW1N0cmluZ10gbW9kZQogICAgLy8gICAgICAnb24nLCAnb2ZmJywgb3IgJ2F1dG8nCiAgICAvLwogICAgd2lkZ2V0LnNldERpc3BsYXlNb2RlID0gZnVuY3Rpb24obW9kZSkgewogICAgICAgIHZhciBuZXdNb2RlID0gbW9kZSB8fCAnYXV0byc7CiAgICAgICAgaWYgKF9tb2RlID09PSBuZXdNb2RlKSByZXR1cm47CgogICAgICAgIE9ULiQucmVtb3ZlQ2xhc3ModGhpcy5kb21FbGVtZW50LCAnT1RfbW9kZS0nICsgX21vZGUpOwogICAgICAgIE9ULiQuYWRkQ2xhc3ModGhpcy5kb21FbGVtZW50LCAnT1RfbW9kZS0nICsgbmV3TW9kZSk7CgogICAgICAgIF9wcmV2aW91c01vZGUgPSBfbW9kZTsKICAgICAgICBfbW9kZSA9IG5ld01vZGU7CiAgICB9OwoKICAgIHdpZGdldC5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXREaXNwbGF5TW9kZShfcHJldmlvdXNNb2RlKTsKICAgICAgICBpZiAoX29wdGlvbnMub25TaG93KSBfb3B0aW9ucy5vblNob3coKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIHdpZGdldC5oaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXREaXNwbGF5TW9kZSgnb2ZmJyk7CiAgICAgICAgaWYgKF9vcHRpb25zLm9uSGlkZSkgX29wdGlvbnMub25IaWRlKCk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB3aWRnZXQuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChfb3B0aW9ucy5vbkRlc3Ryb3kpIF9vcHRpb25zLm9uRGVzdHJveSh0aGlzLmRvbUVsZW1lbnQpOwogICAgICAgIGlmICh0aGlzLmRvbUVsZW1lbnQpIE9ULiQucmVtb3ZlRWxlbWVudCh0aGlzLmRvbUVsZW1lbnQpOwoKICAgICAgICByZXR1cm4gd2lkZ2V0OwogICAgfTsKCiAgICB3aWRnZXQuYXBwZW5kVG8gPSBmdW5jdGlvbihwYXJlbnQpIHsKICAgICAgICAvLyBjcmVhdGUgdGhlIGVsZW1lbnQgdW5kZXIgcGFyZW50CiAgICAgICAgdGhpcy5kb21FbGVtZW50ID0gT1QuJC5jcmVhdGVFbGVtZW50KF9vcHRpb25zLm5vZGVOYW1lIHx8ICdkaXYnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vcHRpb25zLmh0bWxBdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vcHRpb25zLmh0bWxDb250ZW50KTsKCiAgICAgICAgaWYgKF9vcHRpb25zLm9uQ3JlYXRlKSBfb3B0aW9ucy5vbkNyZWF0ZSh0aGlzLmRvbUVsZW1lbnQpOwoKICAgICAgICAvLyBpZiB0aGUgbW9kZSBpc24ndCBhdXRvLCB0aGVuIHdlIGNhbiBkaXJlY3RseSBzZXQgaXQKICAgICAgICBpZiAoX29wdGlvbnMubW9kZSAhPSAiYXV0byIpIHsKICAgICAgICAgICAgd2lkZ2V0LnNldERpc3BsYXlNb2RlKF9vcHRpb25zLm1vZGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHdlIHNldCBpdCB0byBvbiBhdCBmaXJzdCwgYW5kIHRoZW4gYXBwbHkgdGhlIGRlc2lyZWQgbW9kZQogICAgICAgICAgICAvLyB0aGlzIHdpbGwgbGV0IHRoZSBwcm9wZXIgd2lkZ2V0cyBuaWNlbHkgZmFkZSBhd2F5CiAgICAgICAgICAgIHdpZGdldC5zZXREaXNwbGF5TW9kZSgnb24nKTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdpZGdldC5zZXREaXNwbGF5TW9kZShfb3B0aW9ucy5tb2RlKTsKICAgICAgICAgICAgfSwgMjAwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyBhZGQgdGhlIHdpZGdldCB0byB0aGUgcGFyZW50CiAgICAgICAgcGFyZW50LmFwcGVuZENoaWxkKHRoaXMuZG9tRWxlbWVudCk7CgogICAgICAgIHJldHVybiB3aWRnZXQ7CiAgICB9Owp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTmFtZVBhbmVsIENocm9tZSBXaWRnZXQKLy8KLy8gbW9kZSAoU3RyaW5nKQovLyBXaGV0aGVyIHRvIGRpc3BsYXkgdGhlIG5hbWUuIFBvc3NpYmxlIHZhbHVlcyBhcmU6ICJhdXRvIiAodGhlIG5hbWUgaXMgZGlzcGxheWVkCi8vIHdoZW4gdGhlIHN0cmVhbSBpcyBmaXJzdCBkaXNwbGF5ZWQgYW5kIHdoZW4gdGhlIHVzZXIgbW91c2VzIG92ZXIgdGhlIGRpc3BsYXkpLAovLyAib2ZmIiAodGhlIG5hbWUgaXMgbm90IGRpc3BsYXllZCksIGFuZCAib24iICh0aGUgbmFtZSBpcyBkaXNwbGF5ZWQpLgovLwovLyBkaXNwbGF5cyBhIG5hbWUKLy8gY2FuIGJlIHNob3duL2hpZGRlbgovLyBjYW4gYmUgZGVzdHJveWVkCk9ULkNocm9tZS5OYW1lUGFuZWwgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgX25hbWUgPSBvcHRpb25zLm5hbWU7CgogICAgaWYgKCFfbmFtZSB8fCBfbmFtZS50cmltKCkubGVuZ3RoID09PSAnJykgewogICAgICAgIF9uYW1lID0gbnVsbDsKCiAgICAgICAgLy8gVEhlcmUncyBubyBuYW1lLCBqdXN0IGZsaXAgdGhlIG1vZGUgb2ZmCiAgICAgICAgb3B0aW9ucy5tb2RlID0gJ29mZic7CiAgICB9CgogICAgLy8gVGhpcyBiZWhhdmlvdXIgbXVzdCBiZSBpbXBsZW1lbnRlZCB0byBtYWtlIHRoZSB3aWRnZXQgYmVoYXZpb3VyIHdvcmsuCiAgICAvLyBAZml4bWUgVGhpcyBpcyBhIG5hc3R5IGNvZGUgc21lbGwKICAgIHZhciBfZG9tRWxlbWVudDsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnZG9tRWxlbWVudCcsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2RvbUVsZW1lbnQ7IH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihkb21FbGVtZW50KSB7IF9kb21FbGVtZW50ID0gZG9tRWxlbWVudDsgfQogICAgfSkKCiAgICAvLyBNaXhpbiBjb21tb24gd2lkZ2V0IGJlaGF2aW91cgogICAgT1QuQ2hyb21lLkJlaGF2aW91ci5XaWRnZXQodGhpcywgewogICAgICAgIG1vZGU6IG9wdGlvbnMubW9kZSwKICAgICAgICBub2RlTmFtZTogJ2gxJywKICAgICAgICBodG1sQ29udGVudDogX25hbWUsCiAgICAgICAgaHRtbEF0dHJpYnV0ZXM6IHtjbGFzc05hbWU6ICdPVF9uYW1lJ30KICAgIH0pOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnbmFtZScsIHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFfbmFtZSkgdGhpcy5zZXREaXNwbGF5TW9kZSgnYXV0bycpOwoKICAgICAgICAgICAgX25hbWUgPSBuYW1lOwogICAgICAgICAgICBfZG9tRWxlbWVudC5pbm5lckhUTUwgPSBfbmFtZTsKICAgICAgICB9LmJpbmQodGhpcykKICAgIH0pOwp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKT1QuQ2hyb21lLk11dGVCdXR0b24gPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgX29uQ2xpY2tDYiwKICAgICAgICBfbXV0ZWQgPSBvcHRpb25zLm11dGVkIHx8IGZhbHNlOwoKICAgIC8vIFRoaXMgYmVoYXZpb3VyIG11c3QgYmUgaW1wbGVtZW50ZWQgdG8gbWFrZSB0aGUgd2lkZ2V0IGJlaGF2aW91ciB3b3JrLgogICAgLy8gQGZpeG1lIFRoaXMgaXMgYSBuYXN0eSBjb2RlIHNtZWxsCiAgICB2YXIgX2RvbUVsZW1lbnQ7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2RvbUVsZW1lbnQnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9kb21FbGVtZW50OyB9LAogICAgICAgIHNldDogZnVuY3Rpb24oZG9tRWxlbWVudCkgeyBfZG9tRWxlbWVudCA9IGRvbUVsZW1lbnQ7IH0KICAgIH0pCgogICAgLy8gUHJpdmF0ZSBFdmVudCBDYWxsYmFja3MKICAgIHZhciBhdHRhY2hFdmVudHMgPSBmdW5jdGlvbihlbGVtKSB7CiAgICAgICAgICAgIF9vbkNsaWNrQ2IgPSBvbkNsaWNrLmJpbmQodGhpcyk7CiAgICAgICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfb25DbGlja0NiLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgZGV0YWNoRXZlbnRzID0gZnVuY3Rpb24oZWxlbSkgewogICAgICAgICAgICBfb25DbGlja0NiID0gbnVsbDsKICAgICAgICAgICAgZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIF9vbkNsaWNrQ2IsIGZhbHNlKTsKICAgICAgICB9LAoKICAgICAgICBvbkNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgX211dGVkID0gIV9tdXRlZDsKCiAgICAgICAgICAgIGlmIChfbXV0ZWQpIHsKICAgICAgICAgICAgICAgIE9ULiQuYWRkQ2xhc3MoX2RvbUVsZW1lbnQsICdPVF9hY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50LnRyaWdnZXIoJ211dGVkJywgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBPVC4kLnJlbW92ZUNsYXNzKF9kb21FbGVtZW50LCAnT1RfYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudC50cmlnZ2VyKCd1bm11dGVkJywgdGhpcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgIC8vIE1peGluIGNvbW1vbiB3aWRnZXQgYmVoYXZpb3VyCiAgICB2YXIgY2xhc3NOYW1lcyA9IF9tdXRlZCA/ICdPVF9tdXRlIE9UX2FjdGl2ZScgOiAnT1RfbXV0ZSc7CiAgICBPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCh0aGlzLCB7CiAgICAgICAgbW9kZTogb3B0aW9ucy5tb2RlLAogICAgICAgIG5vZGVOYW1lOiAnYnV0dG9uJywKICAgICAgICBodG1sQ29udGVudDogJ011dGUnLAogICAgICAgIGh0bWxBdHRyaWJ1dGVzOiB7Y2xhc3NOYW1lOiBjbGFzc05hbWVzfSwKICAgICAgICBvbkNyZWF0ZTogYXR0YWNoRXZlbnRzLmJpbmQodGhpcyksCiAgICAgICAgb25EZXN0cm95OiBkZXRhY2hFdmVudHMuYmluZCh0aGlzKQogICAgfSk7Cn07CgoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKT1QuQ2hyb21lLk1pY1ZvbHVtZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBfb25DbGlja0NiLAogICAgICAgIF9tdXRlZCA9IG9wdGlvbnMubXV0ZWQgfHwgZmFsc2U7CgogICAgLy8gVGhpcyBiZWhhdmlvdXIgbXVzdCBiZSBpbXBsZW1lbnRlZCB0byBtYWtlIHRoZSB3aWRnZXQgYmVoYXZpb3VyIHdvcmsuCiAgICAvLyBAZml4bWUgVGhpcyBpcyBhIG5hc3R5IGNvZGUgc21lbGwKICAgIHZhciBfZG9tRWxlbWVudDsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnZG9tRWxlbWVudCcsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2RvbUVsZW1lbnQ7IH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihkb21FbGVtZW50KSB7IF9kb21FbGVtZW50ID0gZG9tRWxlbWVudDsgfQogICAgfSkKCiAgICAvLyBQcml2YXRlIEV2ZW50IENhbGxiYWNrcwogICAgdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKGVsZW0pIHsKICAgICAgICAgICAgX29uQ2xpY2tDYiA9IG9uQ2xpY2suYmluZCh0aGlzKTsKICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIF9vbkNsaWNrQ2IsIGZhbHNlKTsKICAgICAgICB9LAoKICAgICAgICBkZXRhY2hFdmVudHMgPSBmdW5jdGlvbihlbGVtKSB7CiAgICAgICAgICAgIF9vbkNsaWNrQ2IgPSBudWxsOwogICAgICAgICAgICBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgX29uQ2xpY2tDYiwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIG9uQ2xpY2sgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBfbXV0ZWQgPSAhX211dGVkOwoKICAgICAgICAgICAgaWYgKF9tdXRlZCkgewogICAgICAgICAgICAgICAgT1QuJC5hZGRDbGFzcyhfZG9tRWxlbWVudCwgJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgdGhpcy5wYXJlbnQudHJpZ2dlcignbXV0ZWQnLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIE9ULiQucmVtb3ZlQ2xhc3MoX2RvbUVsZW1lbnQsICdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50LnRyaWdnZXIoJ3VubXV0ZWQnLCB0aGlzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgLy8gTWl4aW4gY29tbW9uIHdpZGdldCBiZWhhdmlvdXIKICAgIE9ULkNocm9tZS5CZWhhdmlvdXIuV2lkZ2V0KHRoaXMsIHsKICAgICAgICBtb2RlOiBvcHRpb25zLm1vZGUsCiAgICAgICAgbm9kZU5hbWU6ICdidXR0b24nLAogICAgICAgIGh0bWxDb250ZW50OiAnTXV0ZScsCiAgICAgICAgaHRtbEF0dHJpYnV0ZXM6IHtjbGFzc05hbWU6ICdPVF9taWMtdm9sdW1lJ30sCiAgICAgICAgb25DcmVhdGU6IGF0dGFjaEV2ZW50cy5iaW5kKHRoaXMpLAogICAgICAgIG9uRGVzdHJveTogZGV0YWNoRXZlbnRzLmJpbmQodGhpcykKICAgIH0pOwp9OwoKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCk9ULkNocm9tZS5TZXR0aW5nc1BhbmVsQnV0dG9uID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIF9vbkNsaWNrQ2I7CgogICAgLy8gUHJpdmF0ZSBFdmVudCBDYWxsYmFja3MKICAgIHZhciBhdHRhY2hFdmVudHMgPSBmdW5jdGlvbihlbGVtKSB7CiAgICAgICAgICAgIF9vbkNsaWNrQ2IgPSBvbkNsaWNrLmJpbmQodGhpcyk7CiAgICAgICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfb25DbGlja0NiLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgZGV0YWNoRXZlbnRzID0gZnVuY3Rpb24oZWxlbSkgewogICAgICAgICAgICBfb25DbGlja0NiID0gbnVsbDsKICAgICAgICAgICAgZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIF9vbkNsaWNrQ2IsIGZhbHNlKTsKICAgICAgICB9LAoKICAgICAgICBvbkNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdGhpcy5wYXJlbnQudHJpZ2dlcignU2V0dGluZ3NQYW5lbDpvcGVuJywgdGhpcyk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKCiAgICAvLyBUaGlzIGJlaGF2aW91ciBtdXN0IGJlIGltcGxlbWVudGVkIHRvIG1ha2UgdGhlIHdpZGdldCBiZWhhdmlvdXIgd29yay4KICAgIC8vIEBmaXhtZSBUaGlzIGlzIGEgbmFzdHkgY29kZSBzbWVsbAogICAgdmFyIF9kb21FbGVtZW50OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdkb21FbGVtZW50JywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfZG9tRWxlbWVudDsgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKGRvbUVsZW1lbnQpIHsgX2RvbUVsZW1lbnQgPSBkb21FbGVtZW50OyB9CiAgICB9KQoKICAgIC8vIE1peGluIGNvbW1vbiB3aWRnZXQgYmVoYXZpb3VyCiAgICBPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCh0aGlzLCB7CiAgICAgICAgbW9kZTogb3B0aW9ucy5tb2RlLAogICAgICAgIG5vZGVOYW1lOiAnYnV0dG9uJywKICAgICAgICBodG1sQ29udGVudDogJ1NldHRpbmdzJywKICAgICAgICBodG1sQXR0cmlidXRlczoge2NsYXNzTmFtZTogJ09UX3NldHRpbmdzLXBhbmVsJ30sCiAgICAgICAgb25DcmVhdGU6IGF0dGFjaEV2ZW50cy5iaW5kKHRoaXMpLAogICAgICAgIG9uRGVzdHJveTogZGV0YWNoRXZlbnRzLmJpbmQodGhpcykKICAgIH0pOwp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKT1QuQ2hyb21lLlNldHRpbmdzUGFuZWwgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBpZiAoIW9wdGlvbnMuc3RyZWFtKSB7CiAgICAgICAgLy8gQHRvZG8gcmFpc2UgZXJyb3IKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHdlYlJUQ1N0cmVhbSA9IG9wdGlvbnMuc3RyZWFtOwoKICAgIC8vIFRoaXMgYmVoYXZpb3VyIG11c3QgYmUgaW1wbGVtZW50ZWQgdG8gbWFrZSB0aGUgd2lkZ2V0IGJlaGF2aW91ciB3b3JrLgogICAgLy8gQGZpeG1lIFRoaXMgaXMgYSBuYXN0eSBjb2RlIHNtZWxsCiAgICB2YXIgX2RvbUVsZW1lbnQ7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2RvbUVsZW1lbnQnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9kb21FbGVtZW50OyB9LAogICAgICAgIHNldDogZnVuY3Rpb24oZG9tRWxlbWVudCkgeyBfZG9tRWxlbWVudCA9IGRvbUVsZW1lbnQ7IH0KICAgIH0pCgogICAgdmFyIHJlbmRlckRpYWxvZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY2FtTGFiZWwgPSB3ZWJSVENTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKS5sZW5ndGggPyB3ZWJSVENTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKVswXS5sYWJlbCA6ICJOb25lIiwKICAgICAgICAgICAgICAgIG1pY0xhYmVsID0gd2ViUlRDU3RyZWFtLmdldEF1ZGlvVHJhY2tzKCkubGVuZ3RoID8gd2ViUlRDU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF0ubGFiZWwgOiAiTm9uZSI7CgogICAgICAgICAgICBfZG9tRWxlbWVudC5pbm5lckhUTUwgPSAiPGRsPlwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkdD5DYW08L2R0PlwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkZD4iICsgY2FtTGFiZWwgKyAiPC9kZD5cCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZHQ+TWljPC9kdD5cCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGQ+IiArIG1pY0xhYmVsICsgIjwvZGQ+XAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2RsPiI7CgoKICAgICAgICAgICAgdmFyIGNsb3NlQnV0dG9uICA9IE9ULiQuY3JlYXRlQnV0dG9uKCdDbG9zZScsIHsKICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogJ09UX2Nsb3NlJwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBjbGljazogb25DbG9zZS5iaW5kKHRoaXMpCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX2RvbUVsZW1lbnQuYXBwZW5kQ2hpbGQoY2xvc2VCdXR0b24pOwogICAgICAgIH0sCgogICAgICAgIG9uU2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZW5kZXJEaWFsb2cuY2FsbCh0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBvbkNsb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucGFyZW50LnRyaWdnZXIoJ1NldHRpbmdzUGFuZWw6Y2xvc2UnLCB0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgoKICAgIC8vIE1peGluIGNvbW1vbiB3aWRnZXQgYmVoYXZpb3VyCiAgICBPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCh0aGlzLCB7CiAgICAgICAgbW9kZTogb3B0aW9ucy5tb2RlLAogICAgICAgIG5vZGVOYW1lOiAnc2VjdGlvbicsCiAgICAgICAgaHRtbENvbnRlbnQ6ICdTZXR0aW5ncycsCiAgICAgICAgaHRtbEF0dHJpYnV0ZXM6IHtjbGFzc05hbWU6ICdPVF9zZXR0aW5ncy1wYW5lbCd9LAogICAgICAgIG9uQ3JlYXRlOiByZW5kZXJEaWFsb2cuYmluZCh0aGlzKSwKICAgICAgICBvblNob3c6IG9uU2hvdy5iaW5kKHRoaXMpCiAgICB9KTsKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCk9ULkNocm9tZS5PcGVuVG9rQnV0dG9uID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgLy8gVGhpcyBiZWhhdmlvdXIgbXVzdCBiZSBpbXBsZW1lbnRlZCB0byBtYWtlIHRoZSB3aWRnZXQgYmVoYXZpb3VyIHdvcmsuCiAgICAvLyBAZml4bWUgVGhpcyBpcyBhIG5hc3R5IGNvZGUgc21lbGwKICAgIHZhciBfZG9tRWxlbWVudDsKICAgIHRoaXMuX19kZWZpbmVHZXR0ZXJfXygiZG9tRWxlbWVudCIsIGZ1bmN0aW9uKCkgeyByZXR1cm4gX2RvbUVsZW1lbnQ7IH0pOwogICAgdGhpcy5fX2RlZmluZVNldHRlcl9fKCJkb21FbGVtZW50IiwgZnVuY3Rpb24oZG9tRWxlbWVudCkgeyBfZG9tRWxlbWVudCA9IGRvbUVsZW1lbnQ7IH0pOwoKICAgIC8vIE1peGluIGNvbW1vbiB3aWRnZXQgYmVoYXZpb3VyCiAgICBPVC5DaHJvbWUuQmVoYXZpb3VyLldpZGdldCh0aGlzLCB7CiAgICAgICAgbW9kZTogb3B0aW9ucyA/IG9wdGlvbnMubW9kZSA6IG51bGwsCiAgICAgICAgbm9kZU5hbWU6ICdzcGFuJywKICAgICAgICBodG1sQ29udGVudDogJ09wZW5Ub2snLAogICAgICAgIGh0bWxBdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIGNsYXNzTmFtZTogJ09UX29wZW50b2snCiAgICAgICAgfQogICAgfSk7Cn07Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7Ci8qIFN0eWxhYmxlIE5vdGVzCgoqIFJUQyBkb2Vzbid0IG5lZWQgdG8gd2FpdCB1bnRpbCBhbnl0aGluZyBpcyBsb2FkZWQgKGZsYXNoIG5lZWRzIHRvIHdhaXQgdW50aWwgdGhlIEZsYXNoIGNvbXBvbmVudCBsb2FkcykKKiBTb21lIGJpdHMgYXJlIGNvbnRyb2xsZWQgYnkgbXVsdGlwbGUgZmxhZ3MsIGkuZS4gYnV0dG9uRGlzcGxheU1vZGUgYW5kIG5hbWVEaXNwbGF5TW9kZS4KKiBXaGVuIHRoZXJlIGFyZSBtdWx0aXBsZSBmbGFncyBob3cgaXMgdGhlIGZpbmFsIHNldHRpbmcgY2hvc2VuPwoqIFdoZW4gc29tZSBzdHlsZSBiaXRzIGFyZSBzZXQgdXBkYXRlcyB3aWxsIG5lZWQgdG8gYmUgcHVzaGVkIHRocm91Z2ggdG8gdGhlIENocm9tZQoqLwoKLy8gTWl4ZXMgdGhlIFN0eWxhYmxlQ29tcG9uZW50IGJlaGF2aW91ciBpbnRvIHRoZSArc2VsZisgb2JqZWN0LiBJdCB3aWxsCi8vIGFsc28gc2V0IHRoZSBkZWZhdWx0IHN0eWxlcyB0byAraW5pdGlhbFN0eWxlcysuCi8vCi8vIEBub3RlIFRoaXMgTWl4aW4gaXMgZGVwZW5kZW50IG9uIE9ULkV2ZW50aW5nLgovLwovLwovLyBAZXhhbXBsZQovLwovLyAgZnVuY3Rpb24gU29tZU9iamVjdCB7Ci8vICAgICAgT1QuU3R5bGFibGVDb21wb25lbnQodGhpcywgewovLyAgICAgICAgICBuYW1lOiAnU29tZU9iamVjdCcsCi8vICAgICAgICAgIGZvbzogJ2JhcicKLy8gICAgICB9KTsKLy8gIH0KLy8KLy8gIHZhciBvYmogPSBuZXcgU29tZU9iamVjdCgpOwovLyAgb2JqLmdldFN0eWxlKCdmb28nKTsgICAgICAgIC8vID0+ICdiYXInCi8vICBvYmouc2V0U3R5bGUoJ2ZvbycsICdiYXonKQovLyAgb2JqLmdldFN0eWxlKCdmb28nKTsgICAgICAgIC8vID0+ICdiYXonCi8vICBvYmouZ2V0U3R5bGUoKTsgICAgICAgICAgICAgLy8gPT4ge25hbWU6ICdTb21lT2JqZWN0JywgZm9vOiAnYmF6J30KLy8KT1QuU3R5bGFibGVDb21wb25lbnQgPSBmdW5jdGlvbihzZWxmLCBpbml0YWxTdHlsZXMpIHsKICAgIGlmICghc2VsZi50cmlnZ2VyKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPVC5TdHlsYWJsZUNvbXBvbmVudCBpcyBkZXBlbmRlbnQgb24gdGhlIG1peGluIE9ULiQuZXZlbnRpbmcuIEVuc3VyZSB0aGF0IHRoaXMgaXMgaW5jbHVkZWQgaW4gdGhlIG9iamVjdCBiZWZvcmUgU3R5bGFibGVDb21wb25lbnQuIik7CiAgICB9CgogICAgLy8gQnJvYWRjYXN0IHN0eWxlIGNoYW5nZXMgYXMgdGhlIHN0eWxlVmFsdWVDaGFuZ2VkIGV2ZW50CiAgICB2YXIgb25TdHlsZUNoYW5nZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgaWYgKG9sZFZhbHVlKSB7CiAgICAgICAgICAgIHNlbGYudHJpZ2dlcignc3R5bGVWYWx1ZUNoYW5nZWQnLCBrZXksIHZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBzZWxmLnRyaWdnZXIoJ3N0eWxlVmFsdWVDaGFuZ2VkJywga2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgfTsKCiAgICB2YXIgX3N0eWxlID0gbmV3IFN0eWxlKGluaXRhbFN0eWxlcywgb25TdHlsZUNoYW5nZSk7CgogICAgLyoqCiAgICAqIFJldHVybnMgYW4gb2JqZWN0IHRoYXQgaGFzIHRoZSBwcm9wZXJ0aWVzIHRoYXQgZGVmaW5lIHRoZSBjdXJyZW50IHVzZXIgaW50ZXJmYWNlIGNvbnRyb2xzIG9mIHRoZSBQdWJsaXNoZXIuCiAgICAqIFlvdSBjYW4gbW9kaWZ5IHRoZSBwcm9wZXJ0aWVzIG9mIHRoaXMgb2JqZWN0IGFuZCBwYXNzIHRoZSBvYmplY3QgdG8gdGhlIDxjb2RlPnNldFN0eWxlKCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUKICAgICogUHVibGlzaGVyIG9iamVjdC4gKFNlZSB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgPGEgaHJlZj0iI3NldFN0eWxlIj5zZXRTdHlsZSgpPC9hPiB0byBzZWUgdGhlIHN0eWxlcyB0aGF0IGRlZmluZQogICAgKiB0aGlzIG9iamVjdC4pCiAgICAqIEByZXR1cm4ge09iamVjdH0gVGhlIG9iamVjdCB0aGF0IGRlZmluZXMgdGhlIHN0eWxlcyBvZiB0aGUgUHVibGlzaGVyLgogICAgKiBAc2VlIDxhIGhyZWY9IiNzZXRTdHlsZSI+c2V0U3R5bGUoKTwvYT4KICAgICogQG1ldGhvZCAjZ2V0U3R5bGUKICAgICogQG1lbWJlck9mIFB1Ymxpc2hlcgogICAgKi8KCiAgLyoqCiAgKiBSZXR1cm5zIGFuIG9iamVjdCB0aGF0IGhhcyB0aGUgcHJvcGVydGllcyB0aGF0IGRlZmluZSB0aGUgY3VycmVudCB1c2VyIGludGVyZmFjZSBjb250cm9scyBvZiB0aGUgU3Vic2NyaWJlci4KICAqIFlvdSBjYW4gbW9kaWZ5IHRoZSBwcm9wZXJ0aWVzIG9mIHRoaXMgb2JqZWN0IGFuZCBwYXNzIHRoZSBvYmplY3QgdG8gdGhlIDxjb2RlPnNldFN0eWxlKCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUKICAqIFN1YnNjcmliZXIgb2JqZWN0LiAoU2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciA8YSBocmVmPSIjc2V0U3R5bGUiPnNldFN0eWxlKCk8L2E+IHRvIHNlZSB0aGUgc3R5bGVzIHRoYXQgZGVmaW5lCiAgKiB0aGlzIG9iamVjdC4pCiAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBvYmplY3QgdGhhdCBkZWZpbmVzIHRoZSBzdHlsZXMgb2YgdGhlIFN1YnNjcmliZXIuCiAgKiBAc2VlIDxhIGhyZWY9IiNzZXRTdHlsZSI+c2V0U3R5bGUoKTwvYT4KICAqIEBtZXRob2QgI2dldFN0eWxlCiAgKiBAbWVtYmVyT2YgU3Vic2NyaWJlcgogICovCiAgICAvLyBJZiAra2V5KyBpcyBmYWxzbHkgdGhlbiBhbGwgc3R5bGVzIHdpbGwgYmUgcmV0dXJuZWQuCiAgICBzZWxmLmdldFN0eWxlID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIF9zdHlsZS5nZXQoa2V5KTsKICAgIH07CgogICAgLyoqCiAgICAqIFNldHMgcHJvcGVydGllcyB0aGF0IGRlZmluZSB0aGUgYXBwZWFyYW5jZSBvZiBzb21lIHVzZXIgaW50ZXJmYWNlIGNvbnRyb2xzIG9mIHRoZSBQdWJsaXNoZXIuCiAgICAqCiAgICAqIDxwPllvdSBjYW4gZWl0aGVyIHBhc3Mgb25lIHBhcmFtZXRlciBvciB0d28gcGFyYW1ldGVycyB0byB0aGlzIG1ldGhvZC48L3A+CiAgICAqCiAgICAqIDxwPklmIHlvdSBwYXNzIG9uZSBwYXJhbWV0ZXIsIDxjb2RlPnN0eWxlPC9jb2RlPiwgaXQgaXMgYW4gb2JqZWN0IHRoYXQgaGFzIG9uZSBwcm9wZXJ0eTogPGNvZGU+bmFtZURpc3BsYXlNb2RlPC9jb2RlPi4KICAgICogUG9zc2libGUgdmFsdWVzIGZvciB0aGUgPGNvZGU+c3R5bGUubmFtZURpc3BsYXlNb2RlPC9jb2RlPiBwcm9wZXJ0eSBhcmU6ICJhdXRvIiAodGhlIG5hbWUgaXMgZGlzcGxheWVkIHdoZW4gdGhlIHN0cmVhbQogICAgKiBpcyBmaXJzdCBkaXNwbGF5ZWQgYW5kIHdoZW4gdGhlIHVzZXIgbW91c2VzIG92ZXIgdGhlIGRpc3BsYXkpLCAib2ZmIiAodGhlIG5hbWUgaXMgbm90IGRpc3BsYXllZCksIGFuZCAib24iCiAgICAqICh0aGUgbmFtZSBpcyBkaXNwbGF5ZWQpLgogICAgKgogICAgKiA8cD5Gb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIHBhc3NlcyBvbmUgcGFyYW1ldGVyIHRvIHRoZSBtZXRob2Q6PC9wPgogICAgKgogICAgKiA8cHJlPm15UHVibGlzaGVyLnNldFN0eWxlKHtuYW1lRGlzcGxheU1vZGU6ICJvZmYifSk7PC9wcmU+CiAgICAqCiAgICAqIDxwPklmIHlvdSBwYXNzIHR3byBwYXJhbWV0ZXJzLCA8Y29kZT5zdHlsZTwvY29kZT4gYW5kIDxjb2RlPnZhbHVlPC9jb2RlPiwgdGhleSBhcmUga2V5LXZhbHVlIHBhaXIgdGhhdAogICAgKiBkZWZpbmUgb25lIHByb3BlcnR5IG9mIHRoZSBkaXNwbGF5IHN0eWxlLiBGb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIHBhc3NlcyB0d28gcGFyYW1ldGVyIHZhbHVlcwogICAgKiB0byB0aGUgbWV0aG9kOjwvcD4KICAgICoKICAgICogPHByZT5teVB1Ymxpc2hlci5zZXRTdHlsZSgibmFtZURpc3BsYXlNb2RlIiwgIm9mZiIpOzwvcHJlPgogICAgKgogICAgKiA8cD5Zb3UgY2FuIHNldCB0aGUgaW5pdGlhbCBzZXR0aW5ncyB3aGVuIHlvdSBjYWxsIHRoZSA8Y29kZT5TZXNzaW9uLnB1Ymxpc2goKTwvY29kZT4KICAgICogb3IgPGNvZGU+VEIuaW5pdFB1Ymxpc2hlcigpPC9jb2RlPiBtZXRob2QuIFBhc3MgYSA8Y29kZT5zdHlsZTwvY29kZT4gcHJvcGVydHkgYXMgcGFydCBvZiB0aGUKICAgICogPGNvZGU+cHJvcGVydGllczwvY29kZT4gcGFyYW1ldGVyIG9mIHRoZSBtZXRob2QuPC9wPgogICAgKgogICAgKiA8cD5UaGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgYW4gPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudCBpZiB5b3UgcGFzcyBpbiBhbiBpbnZhbGlkIHN0eWxlIHRvIHRoZSBtZXRob2QuCiAgICAqIFRoZSA8Y29kZT5jb2RlPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUgRXhjZXB0aW9uRXZlbnQgb2JqZWN0IGlzIHNldCB0byAxMDExLjwvcD4KICAgICoKICAgICogQHBhcmFtIHtPYmplY3R9IHN0eWxlIEVpdGhlciBhbiBvYmplY3QgY29udGFpbmluZyBwcm9wZXJ0aWVzIHRoYXQgZGVmaW5lIHRoZSBzdHlsZSwgb3IgYSBTdHJpbmcgZGVmaW5pbmcgdGhpcwogICAgKiBzaW5nbGUgc3R5bGUgcHJvcGVydHkgdG8gc2V0LgogICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIHNldCBmb3IgdGhlIDxjb2RlPnN0eWxlPC9jb2RlPiBwYXNzZWQgaW4uIFBhc3MgYSB2YWx1ZSBmb3IgdGhpcyBwYXJhbWV0ZXIKICAgICogb25seSBpZiB0aGUgdmFsdWUgb2YgdGhlIDxjb2RlPnN0eWxlPC9jb2RlPiBwYXJhbWV0ZXIgaXMgYSBTdHJpbmcuPC9wPgogICAgKgogICAgKiBAc2VlIDxhIGhyZWY9IiNnZXRTdHlsZSI+Z2V0U3R5bGUoKTwvYT4KICAgICogQHJldHVybiB7UHVibGlzaGVyfSBUaGUgUHVibGlzaGVyIG9iamVjdAogICAgKiBAc2VlIDxhIGhyZWY9IiNzZXRTdHlsZSI+c2V0U3R5bGUoKTwvYT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjc3Vic2NyaWJlIj5TZXNzaW9uLnB1Ymxpc2goKTwvYT4KICAgICogQHNlZSA8YSBocmVmPSJUQi5odG1sI2luaXRQdWJsaXNoZXIiPlRCLmluaXRQdWJsaXNoZXIoKTwvYT4KICAgICogQG1ldGhvZCAjc2V0U3R5bGUKICAgICogQG1lbWJlck9mIFB1Ymxpc2hlcgogICAgKi8KCiAgICAvKioKICAgICogU2V0cyBwcm9wZXJ0aWVzIHRoYXQgZGVmaW5lIHRoZSBhcHBlYXJhbmNlIG9mIHNvbWUgdXNlciBpbnRlcmZhY2UgY29udHJvbHMgb2YgdGhlIFN1YnNjcmliZXIuCiAgICAqCiAgICAqIDxwPllvdSBjYW4gZWl0aGVyIHBhc3Mgb25lIHBhcmFtZXRlciBvciB0d28gcGFyYW1ldGVycyB0byB0aGlzIG1ldGhvZC48L3A+CiAgICAqCiAgICAqIDxwPklmIHlvdSBwYXNzIG9uZSBwYXJhbWV0ZXIsIDxjb2RlPnN0eWxlPC9jb2RlPiwgaXQgaXMgYW4gb2JqZWN0IHRoYXQgaGFzIG9uZSBwcm9wZXJ0eTogPGNvZGU+bmFtZURpc3BsYXlNb2RlPC9jb2RlPi4KICAgICogUG9zc2libGUgdmFsdWVzIGZvciB0aGUgPGNvZGU+c3R5bGUubmFtZURpc3BsYXlNb2RlPC9jb2RlPiBwcm9wZXJ0eSBhcmU6ICJhdXRvIiAodGhlIG5hbWUgaXMgZGlzcGxheWVkIHdoZW4gdGhlIHN0cmVhbQogICAgKiBpcyBmaXJzdCBkaXNwbGF5ZWQgYW5kIHdoZW4gdGhlIHVzZXIgbW91c2VzIG92ZXIgdGhlIGRpc3BsYXkpLCAib2ZmIiAodGhlIG5hbWUgaXMgbm90IGRpc3BsYXllZCksIGFuZCAib24iCiAgICAqICh0aGUgbmFtZSBpcyBkaXNwbGF5ZWQpLgogICAgKgogICAgKiA8cD5Gb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIHBhc3NlcyBvbmUgcGFyYW1ldGVyIHRvIHRoZSBtZXRob2Q6PC9wPgogICAgKgogICAgKiA8cHJlPm15U3Vic2NyaWJlci5zZXRTdHlsZSh7bmFtZURpc3BsYXlNb2RlOiAib2ZmIn0pOzwvcHJlPgogICAgKgogICAgKiA8cD5JZiB5b3UgcGFzcyB0d28gcGFyYW1ldGVycywgPGNvZGU+c3R5bGU8L2NvZGU+IGFuZCA8Y29kZT52YWx1ZTwvY29kZT4sIHRoZXkgYXJlIGtleS12YWx1ZSBwYWlyIHRoYXQKICAgICogZGVmaW5lIG9uZSBwcm9wZXJ0eSBvZiB0aGUgZGlzcGxheSBzdHlsZS4gRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgY29kZSBwYXNzZXMgdHdvIHBhcmFtZXRlciB2YWx1ZXMKICAgICogdG8gdGhlIG1ldGhvZDo8L3A+CiAgICAqCiAgICAqIDxwcmU+bXlTdWJzY3JpYmVyLnNldFN0eWxlKCJuYW1lRGlzcGxheU1vZGUiLCAib2ZmIik7PC9wcmU+CiAgICAqCiAgICAqIDxwPllvdSBjYW4gc2V0IHRoZSBpbml0aWFsIHNldHRpbmdzIHdoZW4geW91IGNhbGwgdGhlIDxjb2RlPlNlc3Npb24uc3Vic2NyaWJlKCk8L2NvZGU+IG1ldGhvZC4KICAgICogUGFzcyBhIDxjb2RlPnN0eWxlPC9jb2RlPiBwcm9wZXJ0eSBhcyBwYXJ0IG9mIHRoZSA8Y29kZT5wcm9wZXJ0aWVzPC9jb2RlPiBwYXJhbWV0ZXIgb2YgdGhlIG1ldGhvZC48L3A+CiAgICAqCiAgICAqIDxwPlRoZSBUQiBvYmplY3QgZGlzcGF0Y2hlcyBhbiA8Y29kZT5leGNlcHRpb248L2NvZGU+IGV2ZW50IGlmIHlvdSBwYXNzIGluIGFuIGludmFsaWQgc3R5bGUgdG8gdGhlIG1ldGhvZC4KICAgICogVGhlIDxjb2RlPmNvZGU8L2NvZGU+IHByb3BlcnR5IG9mIHRoZSBFeGNlcHRpb25FdmVudCBvYmplY3QgaXMgc2V0IHRvIDEwMTEuPC9wPgogICAgKgogICAgKiBAcGFyYW0ge09iamVjdH0gc3R5bGUgRWl0aGVyIGFuIG9iamVjdCBjb250YWluaW5nIHByb3BlcnRpZXMgdGhhdCBkZWZpbmUgdGhlIHN0eWxlLCBvciBhIFN0cmluZyBkZWZpbmluZyB0aGlzCiAgICAqIHNpbmdsZSBzdHlsZSBwcm9wZXJ0eSB0byBzZXQuCiAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0IGZvciB0aGUgPGNvZGU+c3R5bGU8L2NvZGU+IHBhc3NlZCBpbi4gUGFzcyBhIHZhbHVlIGZvciB0aGlzIHBhcmFtZXRlcgogICAgKiBvbmx5IGlmIHRoZSB2YWx1ZSBvZiB0aGUgPGNvZGU+c3R5bGU8L2NvZGU+IHBhcmFtZXRlciBpcyBhIFN0cmluZy48L3A+CiAgICAqCiAgICAqIEByZXR1cm5zIHtTdWJzY3JpYmVyfSBUaGUgU3Vic2NyaWJlciBvYmplY3QuCiAgICAqCiAgICAqIEBzZWUgPGEgaHJlZj0iI2dldFN0eWxlIj5nZXRTdHlsZSgpPC9hPgogICAgKiBAc2VlIDxhIGhyZWY9IiNzZXRTdHlsZSI+c2V0U3R5bGUoKTwvYT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjc3Vic2NyaWJlIj5TZXNzaW9uLnN1YnNjcmliZSgpPC9hPgogICAgKiBAbWV0aG9kICNzZXRTdHlsZQogICAgKiBAbWVtYmVyT2YgU3Vic2NyaWJlcgogICAgKi8KICAgIHNlbGYuc2V0U3R5bGUgPSBmdW5jdGlvbihrZXlPclN0eWxlSGFzaCwgdmFsdWUsIHNpbGVudCkgewogICAgICAgIGlmICh0eXBlb2Yoa2V5T3JTdHlsZUhhc2gpICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICBfc3R5bGUuc2V0QWxsKGtleU9yU3R5bGVIYXNoLCBzaWxlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgX3N0eWxlLnNldChrZXlPclN0eWxlSGFzaCwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Owp9OwoKdmFyIFN0eWxlID0gZnVuY3Rpb24oaW5pdGFsU3R5bGVzLCBvblN0eWxlQ2hhbmdlKSB7CiAgICB2YXIgX0NPTVBPTkVOVF9TVFlMRVMgPSBbCiAgICAgICAgICAgICJzaG93TWljQnV0dG9uIiwKICAgICAgICAgICAgInNob3dTcGVha2VyQnV0dG9uIiwKICAgICAgICAgICAgInNob3dTZXR0aW5nc0J1dHRvbiIsCiAgICAgICAgICAgICJzaG93Q2FtZXJhVG9nZ2xlQnV0dG9uIiwKICAgICAgICAgICAgIm5hbWVEaXNwbGF5TW9kZSIsCiAgICAgICAgICAgICJidXR0b25EaXNwbGF5TW9kZSIsCiAgICAgICAgICAgICJzaG93U2F2ZUJ1dHRvbiIsCiAgICAgICAgICAgICJzaG93UmVjb3JkQnV0dG9uIiwKICAgICAgICAgICAgInNob3dSZWNvcmRTdG9wQnV0dG9uIiwKICAgICAgICAgICAgInNob3dSZVJlY29yZEJ1dHRvbiIsCiAgICAgICAgICAgICJzaG93UGF1c2VCdXR0b24iLAogICAgICAgICAgICAic2hvd1BsYXlCdXR0b24iLAogICAgICAgICAgICAic2hvd1BsYXlTdG9wQnV0dG9uIiwKICAgICAgICAgICAgInNob3dTdG9wQnV0dG9uIiwKICAgICAgICAgICAgImJhY2tncm91bmRJbWFnZVVSSSIsCiAgICAgICAgICAgICJzaG93Q29udHJvbFBhbmVsIiwKICAgICAgICAgICAgInNob3dSZWNvcmRDb3VudGVyIiwKICAgICAgICAgICAgInNob3dQbGF5Q291bnRlciIsCiAgICAgICAgICAgICJzaG93Q29udHJvbEJhciIsCiAgICAgICAgICAgICJzaG93UHJldmlld1RpbWUiCiAgICAgICAgXSwKCiAgICAgICAgX3ZhbGlkU3R5bGVWYWx1ZXMgPSB7CiAgICAgICAgICAgIGJ1dHRvbkRpc3BsYXlNb2RlOiBbImF1dG8iLCAib2ZmIiwgIm9uIl0sCiAgICAgICAgICAgIG5hbWVEaXNwbGF5TW9kZTogWyJhdXRvIiwgIm9mZiIsICJvbiJdLAogICAgICAgICAgICBzaG93U2V0dGluZ3NCdXR0b246IFt0cnVlLCBmYWxzZV0sCiAgICAgICAgICAgIHNob3dNaWNCdXR0b246IFt0cnVlLCBmYWxzZV0sCiAgICAgICAgICAgIHNob3dDYW1lcmFUb2dnbGVCdXR0b246IFt0cnVlLCBmYWxzZV0sCiAgICAgICAgICAgIHNob3dTYXZlQnV0dG9uOiBbdHJ1ZSwgZmFsc2VdLAogICAgICAgICAgICBiYWNrZ3JvdW5kSW1hZ2VVUkk6IG51bGwsCiAgICAgICAgICAgIHNob3dDb250cm9sQmFyOiBbdHJ1ZSwgZmFsc2VdLAogICAgICAgICAgICBzaG93UGxheUNvdW50ZXI6IFt0cnVlLCBmYWxzZV0sCiAgICAgICAgICAgIHNob3dSZWNvcmRDb3VudGVyOiBbdHJ1ZSwgZmFsc2VdLAogICAgICAgICAgICBzaG93UHJldmlld1RpbWU6IFt0cnVlLCBmYWxzZV0KICAgICAgICB9LAoKICAgICAgICBfc3R5bGUgPSB7fSwKCgogICAgICAgIC8vIFZhbGlkYXRlcyB0aGUgc3R5bGUgK2tleSsgYW5kIGFsc28gd2hldGhlciArdmFsdWUrIGlzIHZhbGlkIGZvciAra2V5KwogICAgICAgIGlzVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGtleSA9PT0gJ2JhY2tncm91bmRJbWFnZVVSSScgfHwKICAgICAgICAgICAgICAgICAgICAoICAgX3ZhbGlkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJgogICAgICAgICAgICAgICAgICAgICAgICBfdmFsaWRTdHlsZVZhbHVlc1trZXldLmluZGV4T2YodmFsdWUpICE9PSAtMSApOwogICAgICAgIH0sCgogICAgICAgIGNhc3RWYWx1ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHN3aXRjaCh2YWx1ZSkgewogICAgICAgICAgICAgICAgY2FzZSAndHJ1ZSc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBjYXNlICdmYWxzZSc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAvLyBSZXR1cm5zIGEgc2hhbGxvdyBjb3B5IG9mIHRoZSBzdHlsZXMuCiAgICB0aGlzLmdldEFsbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzdHlsZSA9IE9ULiQuY2xvbmUoX3N0eWxlKTsKCiAgICAgICAgZm9yICh2YXIgaSBpbiBzdHlsZSkgewogICAgICAgICAgICBpZiAoX0NPTVBPTkVOVF9TVFlMRVMuaW5kZXhPZihpKSA8IDApIHsKICAgICAgICAgICAgICAgIC8vIFN0cmlwIHVubmVjZXNzYXJ5IHByb3BlcnRpZXMgb3V0LCBzaG91bGQgdGhpcyBoYXBwZW4gb24gU2V0PwogICAgICAgICAgICAgICAgZGVsZXRlIHN0eWxlW2ldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3R5bGU7CiAgICB9OwoKICAgIHRoaXMuZ2V0ID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICByZXR1cm4gX3N0eWxlW2tleV07CiAgICAgICAgfQoKICAgICAgICAvLyBXZSBoYXZlbid0IGJlZW4gYXNrZWQgZm9yIGFueSBzcGVjaWZpYyBrZXksIGp1c3QgcmV0dXJuIHRoZSBsb3QKICAgICAgICByZXR1cm4gdGhpcy5nZXRBbGwoKTsKICAgIH07CgogICAgLy8gKm5vdGU6KiB0aGlzIHdpbGwgbm90IHRyaWdnZXIgb25TdHlsZUNoYW5nZSBpZiArc2lsZW50KyBpcyB0cnV0aHkKICAgIHRoaXMuc2V0QWxsID0gZnVuY3Rpb24obmV3U3R5bGVzLCBzaWxlbnQpIHsKICAgICAgICB2YXIgb2xkVmFsdWUsIG5ld1ZhbHVlOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmV3U3R5bGVzKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gY2FzdFZhbHVlKG5ld1N0eWxlc1trZXldKTsKCiAgICAgICAgICAgIGlmIChpc1ZhbGlkU3R5bGUoa2V5LCBuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIG9sZFZhbHVlID0gX3N0eWxlW2tleV07CgogICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIF9zdHlsZVtrZXldID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzaWxlbnQpIG9uU3R5bGVDaGFuZ2Uoa2V5LCBuZXdWYWx1ZSwgb2xkVmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgT1Qud2FybigiU3R5bGUuc2V0QWxsOjpJbnZhbGlkIHN0eWxlIHByb3BlcnR5IHBhc3NlZCAiICsga2V5ICsgIiA6ICIgKyBuZXdWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB0aGlzLnNldCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBPVC5kZWJ1ZygiUHVibGlzaGVyLnNldFN0eWxlOiAiICsga2V5LnRvU3RyaW5nKCkpOwoKICAgICAgICB2YXIgbmV3VmFsdWUgPSBjYXN0VmFsdWUodmFsdWUpLAogICAgICAgICAgICBvbGRWYWx1ZTsKCiAgICAgICAgaWYgKCFpc1ZhbGlkU3R5bGUoa2V5LCBuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgT1Qud2FybigiU3R5bGUuc2V0OjpJbnZhbGlkIHN0eWxlIHByb3BlcnR5IHBhc3NlZCAiICsga2V5ICsgIiA6ICIgKyBuZXdWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICAgICAgb2xkVmFsdWUgPSBfc3R5bGVba2V5XTsKICAgICAgICBpZiAobmV3VmFsdWUgIT09IG9sZFZhbHVlKSB7CiAgICAgICAgICAgIF9zdHlsZVtrZXldID0gbmV3VmFsdWU7CgogICAgICAgICAgICBvblN0eWxlQ2hhbmdlKGtleSwgdmFsdWUsIG9sZFZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgaWYgKGluaXRhbFN0eWxlcykgdGhpcy5zZXRBbGwoaW5pdGFsU3R5bGVzLCB0cnVlKTsKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8qKgogKiBBIFB1Ymxpc2hlcnMgTWljcm9waG9uZS4KICoKICogVE9ETwogKiAqIGJpbmQgdG8gY2hhbmdlcyBpbiBtdXRlL3VubXV0ZS92b2x1bWUvZXRjIGFuZCByZXNwb25kIHRvIHRoZW0KICovCk9ULk1pY3JvcGhvbmUgPSBmdW5jdGlvbih3ZWJSVENTdHJlYW0sIG11dGVkKSB7CiAgICB2YXIgX211dGVkLAogICAgICAgIF9nYWluID0gNTA7CgoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnbXV0ZWQnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9tdXRlZDsgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKG11dGVkKSB7CiAgICAgICAgICAgIGlmIChfbXV0ZWQgPT09IG11dGVkKSByZXR1cm47CgogICAgICAgICAgICBfbXV0ZWQgPSBtdXRlZDsKCiAgICAgICAgICAgIHZhciBhdWRpb1RyYWNrcyA9IHdlYlJUQ1N0cmVhbS5nZXRBdWRpb1RyYWNrcygpOwoKICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBudW09YXVkaW9UcmFja3MubGVuZ3RoOyBpPG51bTsgKytpKSB7CiAgICAgICAgICAgICAgICBhdWRpb1RyYWNrc1tpXS5lbmFibGVkID0gIV9tdXRlZDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnZ2FpbicsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2dhaW47IH0sCgogICAgICAgIHNldDogZnVuY3Rpb24oZ2FpbikgewogICAgICAgICAgICBPVC53YXJuKCJPVC5NaWNyb3Bob25lLmdhaW4gSVMgTk9UIFlFVCBJTVBMRU1FTlRFRCIpOwoKICAgICAgICAgICAgX2dhaW4gPSBnYWluOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIFNldCB0aGUgaW5pdGlhbCB2YWx1ZQogICAgaWYgKG11dGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLm11dGVkID0gbXV0ZWQgPT09IHRydWU7CiAgICB9CiAgICBlbHNlIGlmICh3ZWJSVENTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKS5sZW5ndGgpIHsKICAgICAgICB0aGlzLm11dGVkID0gIXdlYlJUQ1N0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdLmVuYWJsZWQ7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICB0aGlzLm11dGVkID0gZmFsc2U7CiAgICB9Cn07Cgp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KSB7CgovLyBBIEZhY3RvcnkgbWV0aG9kIGZvciBnZW5lcmF0aW5nIHNpbXBsZSBzdGF0ZSBtYWNoaW5lIGNsYXNzZXMuCi8vCi8vIEB1c2FnZQovLyAgICB2YXIgU3RhdGVNYWNoaW5lID0gT1QuZ2VuZXJhdGVTaW1wbGVTdGF0ZU1hY2hpbmUoJ3N0YXJ0JywgWydzdGFydCcsICdtaWRkbGUnLCAnZW5kJywgewovLyAgICAgIHN0YXJ0OiBbJ21pZGRsZSddLAovLyAgICAgIG1pZGRsZTogWydlbmQnXSwKLy8gICAgICBlbmQ6IFsnc3RhcnQnXQovLyAgICB9XSk7Ci8vCi8vICAgIHZhciBzdGF0ZXMgPSBuZXcgU3RhdGVNYWNoaW5lKCk7Ci8vICAgIHN0YXRlLmN1cnJlbnQ7ICAgICAgICAgICAgLy8gPC0tIHN0YXJ0Ci8vICAgIHN0YXRlLnNldCgnbWlkZGxlJyk7Ci8vCk9ULmdlbmVyYXRlU2ltcGxlU3RhdGVNYWNoaW5lID0gZnVuY3Rpb24oaW5pdGlhbFN0YXRlLCBzdGF0ZXMsIHRyYW5zaXRpb25zKSB7CiAgdmFyIHZhbGlkU3RhdGVzID0gc3RhdGVzLnNsaWNlKCksCiAgICAgIHZhbGlkVHJhbnNpdGlvbnMgPSBPVC4kLmNsb25lKHRyYW5zaXRpb25zKTsKCiAgdmFyIGlzVmFsaWRTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkgewogICAgcmV0dXJuIHZhbGlkU3RhdGVzLmluZGV4T2Yoc3RhdGUpICE9PSAtMTsKICB9CgogIHZhciBpc1ZhbGlkVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgcmV0dXJuIHZhbGlkVHJhbnNpdGlvbnNbZnJvbVN0YXRlXSAmJiB2YWxpZFRyYW5zaXRpb25zW2Zyb21TdGF0ZV0uaW5kZXhPZih0b1N0YXRlKSAhPT0gLTE7CiAgfTsKCiAgcmV0dXJuIGZ1bmN0aW9uKHN0YXRlQ2hhbmdlRmFpbGVkKSB7CiAgICB2YXIgY3VycmVudFN0YXRlID0gaW5pdGlhbFN0YXRlLAogICAgICAgIHByZXZpb3VzU3RhdGUgPSBudWxsOwoKICAgIGZ1bmN0aW9uIHNpZ25hbENoYW5nZUZhaWxlZChtZXNzYWdlLCBuZXdTdGF0ZSkgewogICAgICAgIHN0YXRlQ2hhbmdlRmFpbGVkKHsKICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgICBuZXdTdGF0ZTogbmV3U3RhdGUsCiAgICAgICAgICBjdXJyZW50U3RhdGU6IGN1cnJlbnRTdGF0ZSwKICAgICAgICAgIHByZXZpb3VzU3RhdGU6IHByZXZpb3VzU3RhdGUKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBWYWxpZGF0ZXMgK25ld1N0YXRlKy4gSWYgaXQncyBpbnZhbGlkIGl0IHRyaWdnZXJzIHN0YXRlQ2hhbmdlRmFpbGVkIGFuZCByZXR1cm5zIGZhbHNlLgogICAgZnVuY3Rpb24gaGFuZGxlSW52YWxpZFN0YXRlQ2hhbmdlcyhuZXdTdGF0ZSkgewogICAgICBpZiAoIWlzVmFsaWRTdGF0ZShuZXdTdGF0ZSkpIHsKICAgICAgICBzaWduYWxDaGFuZ2VGYWlsZWQoIiciICsgbmV3U3RhdGUgKyAiJyBpcyBub3QgYSB2YWxpZCBzdGF0ZSIsIG5ld1N0YXRlKQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghaXNWYWxpZFRyYW5zaXRpb24oY3VycmVudFN0YXRlLCBuZXdTdGF0ZSkpIHsKICAgICAgICBzaWduYWxDaGFuZ2VGYWlsZWQoIiciICsgY3VycmVudFN0YXRlICsgIicgY2Fubm90IHRyYW5zaXRpb24gdG8gJyIgKyBuZXdTdGF0ZSArICInIiwgbmV3U3RhdGUpCgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgoKICAgIHRoaXMuc2V0ID0gZnVuY3Rpb24obmV3U3RhdGUpIHsKICAgICAgaWYgKCFoYW5kbGVJbnZhbGlkU3RhdGVDaGFuZ2VzKG5ld1N0YXRlKSkgcmV0dXJuOwoKICAgICAgcHJldmlvdXNTdGF0ZSA9IGN1cnJlbnRTdGF0ZTsKICAgICAgY3VycmVudFN0YXRlID0gbmV3U3RhdGU7CiAgICB9OwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsKICAgICAgY3VycmVudDogewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBjdXJyZW50U3RhdGU7IH0KICAgICAgfSwKCiAgICAgIHN1YnNjcmliaW5nOiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIGN1cnJlbnRTdGF0ZSA9PT0gJ1N1YnNjcmliaW5nJzsgfQogICAgICB9CiAgICB9KTsKICB9Owp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTW9kZWxzIGEgU3Vic2NyaWJlcidzIHN1YnNjcmliaW5nIFN0YXRlCi8vCi8vIFZhbGlkIFN0YXRlczoKLy8gICAgIE5vdFN1YnNjcmliaW5nICAgICAgICAgICAgKHRoZSBpbml0aWFsIHN0YXRlCi8vICAgICBJbml0ICAgICAgICAgICAgICAgICAgICAgIChiYXNpYyBzZXR1cCBvZiBET00KLy8gICAgIENvbm5lY3RpbmdUb1BlZXIgICAgICAgICAgKEZhaWx1cmUgQ2FzZXMgLT4gTm8gUm91dGUsIEJhZCBPZmZlciwgQmFkIEFuc3dlcgovLyAgICAgQmluZGluZ1JlbW90ZVN0cmVhbSAgICAgICAoRmFpbHVyZSBDYXNlcyAtPiBBbnl0aGluZyB0byBkbyB3aXRoIHRoZSBtZWRpYSBiZWluZyBpbnZhbGlkLCB0aGUgbWVkaWEgbmV2ZXIgcGxheXMKLy8gICAgIFN1YnNjcmliaW5nICAgICAgICAgICAgICAgKHRoaXMgaXMgJ29uTG9hZCcKLy8gICAgIEZhaWxlZCAgICAgICAgICAgICAgICAgICAgKHRlcm1pbmFsIHN0YXRlLCB3aXRoIGEgcmVhc29uIHRoYXQgbWFwcyB0byBvbmUgb2YgdGhlIGZhaWx1cmUgY2FzZXMgYWJvdmUKLy8KLy8KLy8gVmFsaWQgVHJhbnNpdGlvbnM6Ci8vICAgICBOb3RTdWJzY3JpYmluZyAtPgovLyAgICAgICAgIEluaXQKLy8KLy8gICAgIEluaXQgLT4KLy8gICAgICAgICAgICAgQ29ubmVjdGluZ1RvUGVlcgovLyAgICAgICAgICAgfCBCaW5kaW5nUmVtb3RlU3RyZWFtICAgICAgICAgKGlmIHdlIGFyZSBzdWJzY3JpYmluZyB0byBvdXJzZWx2ZXMgYW5kIHdlIGFscmVheSBoYXZlIGEgc3RyZWFtCi8vICAgICAgICAgICB8IE5vdFN1YnNjcmliaW5nICAgICAgICAgICAgICAoZGVzdHJveSgpCi8vCi8vICAgICBDb25uZWN0aW5nVG9QZWVyIC0+Ci8vICAgICAgICAgICAgIEJpbmRpbmdSZW1vdGVTdHJlYW0KLy8gICAgICAgICAgIHwgTm90U3Vic2NyaWJpbmcKLy8gICAgICAgICAgIHwgRmFpbGVkCi8vICAgICAgICAgICB8IE5vdFN1YnNjcmliaW5nICAgICAgICAgICAgICAoZGVzdHJveSgpCi8vCi8vICAgICBCaW5kaW5nUmVtb3RlU3RyZWFtIC0+Ci8vICAgICAgICAgICAgIFN1YnNjcmliaW5nCi8vICAgICAgICAgICB8IEZhaWxlZAovLyAgICAgICAgICAgfCBOb3RTdWJzY3JpYmluZyAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLyAgICAgU3Vic2NyaWJpbmcgLT4KLy8gICAgICAgICAgICAgTm90U3Vic2NyaWJpbmcgICAgICAgICAgICAgICh1bnN1YnNjcmliZQovLyAgICAgICAgICAgfCBGYWlsZWQgICAgICAgICAgICAgICAgICAgICAgKHByb2JhYmx5IGEgcGVlciBjb25uZWN0aW9uIGZhaWx1cmUgYWZ0ZXIgd2UgYmVnYW4gc3Vic2NyaWJpbmcKLy8KLy8gICAgIEZhaWxlZCAtPiAgICAgICAgICAgICAgICAgICAgICAgICAgICh0ZXJtaW5hbCBlcnJvciBzdGF0ZSkKLy8KLy8KLy8gQGV4YW1wbGUKLy8gICAgIHZhciBzdGF0ZSA9IG5ldyBTdWJzY3JpYmluZ1N0YXRlKGZ1bmN0aW9uKGNoYW5nZSkgewovLyAgICAgICBjb25zb2xlLmxvZyhjaGFuZ2UubWVzc2FnZSk7Ci8vICAgICB9KTsKLy8KLy8gICAgIHN0YXRlLnNldCgnSW5pdCcpOwovLyAgICAgc3RhdGUuY3VycmVudDsgICAgICAgICAgICAgICAgIC0+ICdJbml0JwovLwovLyAgICAgc3RhdGUuc2V0KCdTdWJzY3JpYmluZycpOyAgICAgIC0+IHRyaWdnZXJzIHN0YXRlQ2hhbmdlRmFpbGVkIGFuZCBsb2dzIG91dCB0aGUgZXJyb3IgbWVzc2FnZQovLwovLwoKdmFyIHZhbGlkU3RhdGVzID0gWyAnTm90U3Vic2NyaWJpbmcnLCAnSW5pdCcsICdDb25uZWN0aW5nVG9QZWVyJywgJ0JpbmRpbmdSZW1vdGVTdHJlYW0nLCAnU3Vic2NyaWJpbmcnLCAnRmFpbGVkJyBdLAoKICAgIHZhbGlkVHJhbnNpdGlvbnMgPSB7CiAgICAgIE5vdFN1YnNjcmliaW5nOiBbJ05vdFN1YnNjcmliaW5nJywgJ0luaXQnXSwKICAgICAgSW5pdDogWydOb3RTdWJzY3JpYmluZycsICdDb25uZWN0aW5nVG9QZWVyJywgJ0JpbmRpbmdSZW1vdGVTdHJlYW0nXSwKICAgICAgQ29ubmVjdGluZ1RvUGVlcjogWydOb3RTdWJzY3JpYmluZycsICdCaW5kaW5nUmVtb3RlU3RyZWFtJywgJ0ZhaWxlZCddLAogICAgICBCaW5kaW5nUmVtb3RlU3RyZWFtOiBbJ05vdFN1YnNjcmliaW5nJywgJ1N1YnNjcmliaW5nJywgJ0ZhaWxlZCddLAogICAgICBTdWJzY3JpYmluZzogWydOb3RTdWJzY3JpYmluZycsICdGYWlsZWQnXSwKICAgICAgRmFpbGVkOiBbXQogICAgfSwKCiAgICBpbml0aWFsU3RhdGUgPSAnTm90U3Vic2NyaWJpbmcnOwoKT1QuU3Vic2NyaWJpbmdTdGF0ZSA9IE9ULmdlbmVyYXRlU2ltcGxlU3RhdGVNYWNoaW5lKGluaXRpYWxTdGF0ZSwgdmFsaWRTdGF0ZXMsIHZhbGlkVHJhbnNpdGlvbnMpOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KE9ULlN1YnNjcmliaW5nU3RhdGUucHJvdG90eXBlLCAnYXR0ZW1wdGluZ1RvU3Vic2NyaWJlJywgewogIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBbICdJbml0JywgJ0Nvbm5lY3RpbmdUb1BlZXInLCAnQmluZGluZ1JlbW90ZVN0cmVhbScgXS5pbmRleE9mKHRoaXMuY3VycmVudCkgIT09IC0xOyB9Cn0pOwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKLy8gTW9kZWxzIGEgUHVibGlzaGVyJ3MgcHVibGlzaGluZyBTdGF0ZQovLwovLyBWYWxpZCBTdGF0ZXM6Ci8vICAgIE5vdFB1Ymxpc2hpbmcKLy8gICAgR2V0VXNlck1lZGlhCi8vICAgIEJpbmRpbmdNZWRpYQovLyAgICBNZWRpYUJvdW5kCi8vICAgIFB1Ymxpc2hpbmdUb1Nlc3Npb24KLy8gICAgUHVibGlzaGluZwovLyAgICBGYWlsZWQKLy8KLy8KLy8gVmFsaWQgVHJhbnNpdGlvbnM6Ci8vICAgIE5vdFB1Ymxpc2hpbmcgLT4KLy8gICAgICAgIEdldFVzZXJNZWRpYQovLwovLyAgICBHZXRVc2VyTWVkaWEgLT4KLy8gICAgICAgIEJpbmRpbmdNZWRpYQovLyAgICAgIHwgRmFpbGVkICAgICAgICAgICAgICAgICAgICAgIChGYWlsdXJlIFJlYXNvbnMgLT4gc3RyZWFtIGVycm9yLCBjb25zdHJhaW50cywgcGVybWlzc2lvbiBkZW5pZWQKLy8gICAgICB8IE5vdFB1Ymxpc2hpbmcgICAgICAgICAgICAgICAoZGVzdHJveSgpCi8vCi8vCi8vICAgIEJpbmRpbmdNZWRpYSAtPgovLyAgICAgICAgTWVkaWFCb3VuZAovLyAgICAgIHwgRmFpbGVkICAgICAgICAgICAgICAgICAgICAgIChGYWlsdXJlIFJlYXNvbnMgLT4gQW55dGhpbmcgdG8gZG8gd2l0aCB0aGUgbWVkaWEgYmVpbmcgaW52YWxpZCwgdGhlIG1lZGlhIG5ldmVyIHBsYXlzCi8vICAgICAgfCBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLyAgICBNZWRpYUJvdW5kIC0+Ci8vICAgICAgICBQdWJsaXNoaW5nVG9TZXNzaW9uICAgICAgICAgKE1lZGlhQm91bmQgY291bGQgdHJhbnNpdGlvbiB0byBQdWJsaXNoaW5nVG9TZXNzaW9uIGlmIGEgc3RhbmQtYWxvbmUgcHVibGlzaCBpcyBib3VuZCB0byBhIHNlc3Npb24KLy8gICAgICB8IEZhaWxlZCAgICAgICAgICAgICAgICAgICAgICAoRmFpbHVyZSBSZWFzb25zIC0+IG1lZGlhIGlzc3VlcyB3aXRoIGEgc3RhbmQtYWxvbmUgcHVibGlzaGVyCi8vICAgICAgfCBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLyAgICBQdWJsaXNoaW5nVG9TZXNzaW9uCi8vICAgICAgICBQdWJsaXNoaW5nCi8vICAgICAgfCBGYWlsZWQgICAgICAgICAgICAgICAgICAgICAgKEZhaWx1cmUgUmVhc29ucyAtPiB0aW1lb3V0IHdoaWxlIHdhaXRpbmcgZm9yIGFjayBvZiBzdHJlYW0gcmVnaXN0ZXJlZC4gV2UgZG8gbm90IGRvIHRoaXMgcmlnaHQgbm93Ci8vICAgICAgfCBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLwovLyAgICBQdWJsaXNoaW5nIC0+Ci8vICAgICAgICBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKFVucHVibGlzaAovLyAgICAgIHwgRmFpbGVkICAgICAgICAgICAgICAgICAgICAgIChGYWlsdXJlIFJlYXNvbnMgLT4gbG9zcyBvZiBuZXR3b3JrLCBtZWRpYSBlcnJvciwgYW55dGhpbmcgdGhhdCBjYXVzZXMgKmFsbCogUGVlciBDb25uZWN0aW9ucyB0byBmYWlsIChsZXNzIHRoYW4gYWxsIGZhaWxpbmcgaXMganVzdCBhbiBlcnJvciwgYWxsIGlzIGZhaWx1cmUpCi8vICAgICAgfCBOb3RQdWJsaXNoaW5nICAgICAgICAgICAgICAgKGRlc3Ryb3koKQovLwovLyAgICBGYWlsZWQgLT4gICAgICAgICAgICAgICAgICAgICAgIChUZXJtaW5hbCBzdGF0ZQovLwovLwoKCnZhciB2YWxpZFN0YXRlcyA9IFsgJ05vdFB1Ymxpc2hpbmcnLCAnR2V0VXNlck1lZGlhJywgJ0JpbmRpbmdNZWRpYScsICdNZWRpYUJvdW5kJywgJ1B1Ymxpc2hpbmdUb1Nlc3Npb24nLCAnUHVibGlzaGluZycsICdGYWlsZWQnIF0sCgogICAgdmFsaWRUcmFuc2l0aW9ucyA9IHsKICAgICAgTm90UHVibGlzaGluZzogWydOb3RQdWJsaXNoaW5nJywgJ0dldFVzZXJNZWRpYSddLAogICAgICBHZXRVc2VyTWVkaWE6IFsnQmluZGluZ01lZGlhJywgJ0ZhaWxlZCcsICdOb3RQdWJsaXNoaW5nJ10sCiAgICAgIEJpbmRpbmdNZWRpYTogWydNZWRpYUJvdW5kJywgJ0ZhaWxlZCcsICdOb3RQdWJsaXNoaW5nJ10sCiAgICAgIE1lZGlhQm91bmQ6IFsnTm90UHVibGlzaGluZycsICdQdWJsaXNoaW5nVG9TZXNzaW9uJywgJ0ZhaWxlZCddLAogICAgICBQdWJsaXNoaW5nVG9TZXNzaW9uOiBbJ05vdFB1Ymxpc2hpbmcnLCAnUHVibGlzaGluZycsICdGYWlsZWQnXSwKICAgICAgUHVibGlzaGluZzogWydOb3RQdWJsaXNoaW5nJywgJ01lZGlhQm91bmQnLCAnRmFpbGVkJ10sCiAgICAgIEZhaWxlZDogW10KICAgIH0sCgogICAgaW5pdGlhbFN0YXRlID0gJ05vdFB1Ymxpc2hpbmcnOwoKT1QuUHVibGlzaGluZ1N0YXRlID0gT1QuZ2VuZXJhdGVTaW1wbGVTdGF0ZU1hY2hpbmUoaW5pdGlhbFN0YXRlLCB2YWxpZFN0YXRlcywgdmFsaWRUcmFuc2l0aW9ucyk7CgpPYmplY3QuZGVmaW5lUHJvcGVydGllcyhPVC5QdWJsaXNoaW5nU3RhdGUucHJvdG90eXBlLCB7CiAgYXR0ZW1wdGluZ1RvUHVibGlzaDogewogICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIFsgJ0dldFVzZXJNZWRpYScsICdCaW5kaW5nTWVkaWEnLCAnTWVkaWFCb3VuZCcsICdQdWJsaXNoaW5nVG9TZXNzaW9uJyBdLmluZGV4T2YodGhpcy5jdXJyZW50KSAhPT0gLTE7IH0KICB9LAoKICBwdWJsaXNoaW5nOiB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5jdXJyZW50ID09PSAnUHVibGlzaGluZyc7IH0KICB9Cn0pOwoKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8vIFRoZSBkZWZhdWx0IGNvbnN0cmFpbnRzCnZhciBkZWZhdWx0Q29uc3RyYWludHMgPSB7CiAgICBhdWRpbzogdHJ1ZSwKICAgIHZpZGVvOiB0cnVlCn07CgovKioKICogVGhlIFB1Ymxpc2hlciBvYmplY3QgIHByb3ZpZGVzIHRoZSBtZWNoYW5pc20gdGhyb3VnaCB3aGljaCBjb250cm9sIG9mIHRoZQogKiBwdWJsaXNoZWQgc3RyZWFtIGlzIGFjY29tcGxpc2hlZC4gQ2FsbGluZyB0aGUgPGNvZGU+VEIuaW5pdFB1Ymxpc2hlcjwvY29kZT4gbWV0aG9kIG9mIGEKICogIFNlc3Npb24gb2JqZWN0IGNyZWF0ZXMgYSBQdWJsaXNoZXIgb2JqZWN0LiA8L3A+CiAqCiAqICA8cD5UaGUgZm9sbG93aW5nIGNvZGUgaW5zdGFudGlhdGVzIGEgc2Vzc2lvbiwgYW5kIHB1Ymxpc2hlcyBhbiBhdWRpby12aWRlbyBzdHJlYW0KICogIHVwb24gY29ubmVjdGlvbiB0byB0aGUgc2Vzc2lvbjogPC9wPgogKgogKiAgPHByZT4KICogIHZhciBBUElfS0VZID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqICB2YXIgc2Vzc2lvbklEID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIG93biBzZXNzaW9uIElELgogKiAgICAgICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKiAgdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKgogKiAgdmFyIHNlc3Npb24gPSBUQi5pbml0U2Vzc2lvbihzZXNzaW9uSUQpOwogKiAgc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzZXNzaW9uQ29ubmVjdGVkIiwgc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKTsKICogIHNlc3Npb24uY29ubmVjdChBUElfS0VZLCB0b2tlbik7CiAqCiAqICBmdW5jdGlvbiBzZXNzaW9uQ29ubmVjdEhhbmRsZXIoZXZlbnQpIHsKICogICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAqICAgICAgZGl2LnNldEF0dHJpYnV0ZSgnaWQnLCAncHVibGlzaGVyJyk7CiAqCiAqICAgICAgdmFyIHB1Ymxpc2hlckNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwdWJsaXNoZXJDb250YWluZXInKTsKICogICAgICAgICAgLy8gVGhpcyBleGFtcGxlIGFzc3VtZXMgdGhhdCBhIHB1Ymxpc2hlckNvbnRhaW5lciBkaXYgZXhpc3RzCiAqICAgICAgcHVibGlzaGVyQ29udGFpbmVyLmFwcGVuZENoaWxkKGRpdik7CiAqCiAqICAgICAgdmFyIHB1Ymxpc2hlclByb3BlcnRpZXMgPSB7d2lkdGg6IDQwMCwgaGVpZ2h0OjMwMCwgbmFtZToiQm9iJ3Mgc3RyZWFtIn07CiAqICAgICAgcHVibGlzaGVyID0gVEIuaW5pdFB1Ymxpc2hlcihBUElfS0VZLCAncHVibGlzaGVyJywgcHVibGlzaGVyUHJvcGVydGllcyk7CiAqICAgICAgc2Vzc2lvbi5wdWJsaXNoKHB1Ymxpc2hlcik7CiAqICB9CiAqICA8L3ByZT4KICoKICogICAgICA8cD5UaGlzIGV4YW1wbGUgY3JlYXRlcyBhIFB1Ymxpc2hlciBvYmplY3QgYW5kIGFkZHMgaXRzIHZpZGVvIHRvIGEgRE9NIGVsZW1lbnQgbmFtZWQgPGNvZGU+cHVibGlzaGVyPC9jb2RlPgogKiAgICAgIGJ5IGNhbGxpbmcgdGhlIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4gbWV0aG9kLiBJdCB0aGVuIHB1Ymxpc2hlcyBhIHN0cmVhbSB0byB0aGUgc2Vzc2lvbiBieSBjYWxsaW5nCiAqICAgICAgdGhlIDxjb2RlPnB1Ymxpc2goKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC48L3A+CiAqCiAqIEBwcm9wZXJ0eSBpZCBUaGUgRE9NIElEIG9mIHRoZSBQdWJsaXNoZXIuCiAqIEBwcm9wZXJ0eSBzdHJlYW0gVGhlIHtAbGluayBTdHJlYW19IG9iamVjdCBjb3JyZXNwb25kaW5nIHRoZSB0aGUgc3RyZWFtIG9mIHRoZSBQdWJsaWhzZXIuCiAqIEBwcm9wZXJ0eSBzZXNzaW9uIFRoZSB7QGxpbmsgU2Vzc2lvbn0gdG8gd2hpY2ggdGhlIFB1Ymxpc2hlciBiZWxvbmdzLgogKgogKiBAc2VlIDxhIGhyZWY9IlRCLmh0bWwjaW5pdFB1Ymxpc2hlciI+VEIuaW5pdFB1Ymxpc2hlcjwvYT4KICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjcHVibGlzaCI+U2Vzc2lvbi5wdWJsaXNoKCk8L2E+CiAqCiAqIEBjbGFzcyBQdWJsaXNoZXIKICogQGF1Z21lbnRzIEV2ZW50RGlzcGF0Y2hlcgogKi8KT1QuUHVibGlzaGVyID0gZnVuY3Rpb24oKSB7CiAgICAvLyBDaGVjayB0aGF0IHRoZSBjbGllbnQgbWVldHMgdGhlIG1pbmltdW0gcmVxdWlyZW1lbnRzLCBpZiB0aGV5IGRvbid0IHRoZSB1cGdyYWRlCiAgICAvLyBmbG93IHdpbGwgYmUgdHJpZ2dlcmVkLgogICAgaWYgKCFPVC5jaGVja1N5c3RlbVJlcXVpcmVtZW50cygpKSB7CiAgICAgICAgT1QudXBncmFkZVN5c3RlbVJlcXVpcmVtZW50cygpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgX2d1aWQgPSBPVC5QdWJsaXNoZXIubmV4dElkKCksCiAgICAgICAgX2RvbUlkLAogICAgICAgIF9jb250YWluZXIsCiAgICAgICAgX3RhcmdldEVsZW1lbnQsCiAgICAgICAgX3N0cmVhbSwKICAgICAgICBfd2ViUlRDU3RyZWFtLAogICAgICAgIF9zZXNzaW9uLAogICAgICAgIF9wZWVyQ29ubmVjdGlvbnMgPSB7fSwKICAgICAgICBfbG9hZGVkID0gZmFsc2UsCiAgICAgICAgX3B1Ymxpc2hQcm9wZXJ0aWVzLAogICAgICAgIF9wdWJsaXNoU3RhcnRUaW1lLAogICAgICAgIF9taWNyb3Bob25lLAogICAgICAgIF9jaHJvbWUsCiAgICAgICAgX2FuYWx5dGljcyA9IG5ldyBPVC5BbmFseXRpY3MoKSwKICAgICAgICBfdmFsaWRSZXNvbHV0aW9ucyA9IFsKICAgICAgICAgICAge3dpZHRoOiAzMjAsIGhlaWdodDogMjQwfSwKICAgICAgICAgICAge3dpZHRoOiA2NDAsIGhlaWdodDogNDgwfSwKICAgICAgICAgICAge3dpZHRoOiAxMjgwLCBoZWlnaHQ6IDcyMH0KICAgICAgICBdLAogICAgICAgIF9xb3NJbnRlcnZhbHMgPSB7fSwKICAgICAgICBfZ2V0dGluZ1N0YXRzID0gMCwKICAgICAgICBfcHJldlN0YXRzID0gewogICAgICAgICAgICAidGltZVN0YW1wIiA6IE9ULiQubm93KCkKICAgICAgICB9LAogICAgICAgIF9zdGF0ZTsKCiAgICBPVC4kLmV2ZW50aW5nKHRoaXMpOwoKICAgIE9ULlN0eWxhYmxlQ29tcG9uZW50KHRoaXMsIHsKICAgICAgICBzaG93TWljQnV0dG9uOiB0cnVlLAogICAgICAgIHNob3dTZXR0aW5nc0J1dHRvbjogdHJ1ZSwKICAgICAgICBzaG93Q2FtZXJhVG9nZ2xlQnV0dG9uOiB0cnVlLAogICAgICAgIG5hbWVEaXNwbGF5TW9kZTogImF1dG8iLAogICAgICAgIGJ1dHRvbkRpc3BsYXlNb2RlOiAiYXV0byIsCiAgICAgICAgYmFja2dyb3VuZEltYWdlVVJJOiBudWxsCiAgICB9KTsKCiAgICAgICAgLy8vIFByaXZhdGUgTWV0aG9kcwogICAgdmFyIGxvZ0FuYWx5dGljc0V2ZW50ID0gZnVuY3Rpb24oYWN0aW9uLCB2YXJpYXRpb24sIHBheWxvYWRUeXBlLCBwYXlsb2FkKSB7CiAgICAgICAgICAgIF9hbmFseXRpY3MubG9nRXZlbnQoewogICAgICAgICAgICAgICAgYWN0aW9uOiBhY3Rpb24sCiAgICAgICAgICAgICAgICB2YXJpYXRpb246IHZhcmlhdGlvbiwKICAgICAgICAgICAgICAgIHBheWxvYWRfdHlwZTogcGF5bG9hZFR5cGUsCiAgICAgICAgICAgICAgICBwYXlsb2FkOiBwYXlsb2FkLAogICAgICAgICAgICAgICAgc2Vzc2lvbl9pZDogX3Nlc3Npb24gPyBfc2Vzc2lvbi5zZXNzaW9uSWQgOiBudWxsLAogICAgICAgICAgICAgICAgY29ubmVjdGlvbl9pZDogX3Nlc3Npb24gJiYgX3Nlc3Npb24uY29ubmVjdGVkID8gX3Nlc3Npb24uY29ubmVjdGlvbi5jb25uZWN0aW9uSWQgOiBudWxsLAogICAgICAgICAgICAgICAgcGFydG5lcl9pZDogX3Nlc3Npb24gPyBfc2Vzc2lvbi5hcGlLZXkgOiBPVC5BUElLRVksCiAgICAgICAgICAgICAgICBzdHJlYW1JZDogX3N0cmVhbSA/IF9zdHJlYW0uaWQgOiBudWxsLAogICAgICAgICAgICAgICAgd2lkZ2V0X2lkOiBfZ3VpZCwKICAgICAgICAgICAgICAgIHdpZGdldF90eXBlOiAnUHVibGlzaGVyJwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBpc1ZhbGlkUmVzb2x1dGlvbiA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaT0wOyBpPF92YWxpZFJlc29sdXRpb25zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBpZiAoX3ZhbGlkUmVzb2x1dGlvbnNbaV0ud2lkdGggPT0gd2lkdGggJiYgX3ZhbGlkUmVzb2x1dGlvbnNbaV0uaGVpZ2h0ID09IGhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICByZWNvcmRRT1MgPSBmdW5jdGlvbihjb25uZWN0aW9uX2lkKSB7CiAgICAgICAgICAgIHZhciBRb1NfYmxvYiA9IHsKICAgICAgICAgICAgICAgIHdpZGdldF90eXBlOiAnUHVibGlzaGVyJywKICAgICAgICAgICAgICAgIHN0cmVhbV90eXBlIDogJ1dlYlJUQycsCiAgICAgICAgICAgICAgICBzZXNzaW9uSWQ6IF9zZXNzaW9uID8gX3Nlc3Npb24uc2Vzc2lvbklkIDogbnVsbCwKICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25JZDogX3Nlc3Npb24gJiYgX3Nlc3Npb24uY29ubmVjdGVkID8gX3Nlc3Npb24uY29ubmVjdGlvbi5jb25uZWN0aW9uSWQgOiBudWxsLAogICAgICAgICAgICAgICAgcGFydG5lcklkOiBfc2Vzc2lvbiA/IF9zZXNzaW9uLmFwaUtleSA6IE9ULkFQSUtFWSwKICAgICAgICAgICAgICAgIHN0cmVhbUlkOiBfc3RyZWFtID8gX3N0cmVhbS5pZCA6IG51bGwsCiAgICAgICAgICAgICAgICB3aWRnZXRJZDogX2d1aWQsCiAgICAgICAgICAgICAgICB2ZXJzaW9uOiBPVC5wcm9wZXJ0aWVzLnZlcnNpb24sCiAgICAgICAgICAgICAgICBtZWRpYV9zZXJ2ZXJfbmFtZTogX3Nlc3Npb24gPyBfc2Vzc2lvbi5zZXNzaW9uSW5mby5tZXNzYWdpbmdTZXJ2ZXIgOiBudWxsLAogICAgICAgICAgICAgICAgcDJwRmxhZzogX3Nlc3Npb24gPyBfc2Vzc2lvbi5zZXNzaW9uSW5mby5wMnBFbmFibGVkIDogZmFsc2UsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogbmV3IERhdGUoKS5nZXRUaW1lKCkgLV9wdWJsaXNoU3RhcnRUaW1lLmdldFRpbWUoKSwKICAgICAgICAgICAgICAgIHJlbW90ZV9jb25uZWN0aW9uX2lkOiBjb25uZWN0aW9uX2lkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBnZXQgc3RhdHMgZm9yIGVhY2ggY29ubmVjdGlvbiBpZAogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb25zW2Nvbm5lY3Rpb25faWRdLmdldFN0YXRzKF9wcmV2U3RhdHMsIGZ1bmN0aW9uKHN0YXRzKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhdHMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHN0YXRfaW5kZXggaW4gc3RhdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgUW9TX2Jsb2Jbc3RhdF9pbmRleF0gPSBzdGF0c1tzdGF0X2luZGV4XTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfYW5hbHl0aWNzLmxvZ1FPUyhRb1NfYmxvYik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8vLyBQcml2YXRlIEV2ZW50cwoKICAgICAgICBzdGF0ZUNoYW5nZUZhaWxlZCA9IGZ1bmN0aW9uKGNoYW5nZUZhaWxlZCkgewogICAgICAgICAgICBPVC5lcnJvcigiUHVibGlzaGVyIFN0YXRlIENoYW5nZSBGYWlsZWQ6ICIsIGNoYW5nZUZhaWxlZC5tZXNzYWdlKTsKICAgICAgICAgICAgT1QuZGVidWcoY2hhbmdlRmFpbGVkKTsKICAgICAgICB9LAoKICAgICAgICBvbkxvYWRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBPVC5kZWJ1ZygiT1QuUHVibGlzaGVyLm9uTG9hZGVkIik7CiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdwdWJsaXNoJywgJ1N1Y2Nlc3MnLCAnc3RyZWFtVHlwZScsICdXZWJSVEMnKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ01lZGlhQm91bmQnKTsKICAgICAgICAgICAgX2NvbnRhaW5lci5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIF9sb2FkZWQgPSB0cnVlOwoKICAgICAgICAgICAgX2NyZWF0ZUNocm9tZS5jYWxsKHRoaXMpOwoKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdpbml0U3VjY2VzcycsIHRoaXMpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2xvYWRlZCcsIHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIG9uTG9hZEZhaWx1cmUgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3B1Ymxpc2gnLCAnRmFpbHVyZScsICdyZWFzb24nLCAiUHVibGlzaGVyIFBlZXJDb25uZWN0aW9uIEVycm9yOiAiICsgcmVhc29uKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3B1Ymxpc2hFcnJvcicsICJQdWJsaXNoZXIgUGVlckNvbm5lY3Rpb24gRXJyb3I6ICIgKyByZWFzb24pOwoKICAgICAgICAgICAgT1QuaGFuZGxlSnNFeGNlcHRpb24oIlB1Ymxpc2hlciBQZWVyQ29ubmVjdGlvbiBFcnJvcjogIiArIHJlYXNvbiwgT1QuRXhjZXB0aW9uQ29kZXMuUDJQX0NPTk5FQ1RJT05fRkFJTEVELCB7CiAgICAgICAgICAgICAgICBzZXNzaW9uOiBfc2Vzc2lvbiwKICAgICAgICAgICAgICAgIHRhcmdldDogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBvblN0cmVhbUF2YWlsYWJsZSA9IGZ1bmN0aW9uKHdlYk9UU3RyZWFtKSB7CiAgICAgICAgICAgIE9ULmRlYnVnKCJPVC5QdWJsaXNoZXIub25TdHJlYW1BdmFpbGFibGUiKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0JpbmRpbmdNZWRpYScpOwoKICAgICAgICAgICAgY2xlYW51cExvY2FsU3RyZWFtKCk7CiAgICAgICAgICAgIF93ZWJSVENTdHJlYW0gPSB3ZWJPVFN0cmVhbTsKCiAgICAgICAgICAgIF9taWNyb3Bob25lID0gbmV3IE9ULk1pY3JvcGhvbmUoX3dlYlJUQ1N0cmVhbSwgIV9wdWJsaXNoUHJvcGVydGllcy5wdWJsaXNoQXVkaW8pOwogICAgICAgICAgICB0aGlzLnB1Ymxpc2hWaWRlbyhfcHVibGlzaFByb3BlcnRpZXMucHVibGlzaFZpZGVvKTsKCiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCgKICAgICAgICAgICAgICAgIG5ldyBPVC5FdmVudChPVC5FdmVudC5uYW1lcy5BQ0NFU1NfQUxMT1dFRCwgZmFsc2UpCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBfdGFyZ2V0RWxlbWVudCA9IG5ldyBPVC5WaWRlb0VsZW1lbnQoewogICAgICAgICAgICAgICAgYXR0cmlidXRlczoge211dGVkOnRydWV9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3RhcmdldEVsZW1lbnQub24oewogICAgICAgICAgICAgICAgICAgIHN0cmVhbUJvdW5kOiBvbkxvYWRlZCwKICAgICAgICAgICAgICAgICAgICBsb2FkRXJyb3I6IG9uTG9hZEZhaWx1cmUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IG9uVmlkZW9FcnJvcgogICAgICAgICAgICAgICAgfSwgdGhpcykKICAgICAgICAgICAgICAgIC5iaW5kVG9TdHJlYW0oX3dlYlJUQ1N0cmVhbSk7CgogICAgICAgICAgICBfY29udGFpbmVyLnZpZGVvID0gX3RhcmdldEVsZW1lbnQ7CiAgICAgICAgfSwKCiAgICAgICAgb25TdHJlYW1BdmFpbGFibGVFcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgIE9ULmVycm9yKCdPVC5QdWJsaXNoZXIub25TdHJlYW1BdmFpbGFibGVFcnJvciAnICsgZXJyb3IubmFtZSArICc6ICcgKyBlcnJvci5tZXNzYWdlKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3B1Ymxpc2hFcnJvcicsIGVycm9yLm1lc3NhZ2UpOwoKICAgICAgICAgICAgaWYgKF9jb250YWluZXIpIF9jb250YWluZXIuZGVzdHJveSgpOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3B1Ymxpc2gnLCAnRmFpbHVyZScsICdyZWFzb24nLCAiUHVibGlzaGVyIGZhaWxlZCB0byBhY2Nlc3MgY2FtZXJhL21pYzogIiArIGVycm9yLm1lc3NhZ2UpOwoKICAgICAgICAgICAgT1QuaGFuZGxlSnNFeGNlcHRpb24oIlB1Ymxpc2hlciBmYWlsZWQgdG8gYWNjZXNzIGNhbWVyYS9taWM6ICIgKyBlcnJvci5tZXNzYWdlLCAyMDAwLCB7CiAgICAgICAgICAgICAgICBzZXNzaW9uOiBfc2Vzc2lvbiwKICAgICAgICAgICAgICAgIHRhcmdldDogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgdXNlciBoYXMgY2xpY2tlZCB0aGUgJ2RlbnknIGJ1dHRvbiB0aGUgdGhlIGFsbG93IGFjY2VzcyBkaWFsb2cgKG9yIGl0J3Mgc2V0IHRvIGFsd2F5cyBkZW55KQogICAgICAgIG9uQWNjZXNzRGVuaWVkID0gZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgT1QuZXJyb3IoJ09ULlB1Ymxpc2hlci5vblN0cmVhbUF2YWlsYWJsZUVycm9yIFBlcm1pc3Npb24gRGVuaWVkJyk7CgogICAgICAgICAgICBfc3RhdGUuc2V0KCdGYWlsZWQnKTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdwdWJsaXNoRXJyb3InLCBlcnJvci5tZXNzYWdlKTsKCiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdwdWJsaXNoJywgJ0ZhaWx1cmUnLCAncmVhc29uJywgJ1B1Ymxpc2hlciBBY2Nlc3MgRGVuaWVkOiBQZXJtaXNzaW9uIERlbmllZCcpOwoKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IE9ULkV2ZW50KE9ULkV2ZW50Lm5hbWVzLkFDQ0VTU19ERU5JRUQpLAogICAgICAgICAgICAgICAgZGVmYXVsdEFjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgJiYgX2NvbnRhaW5lcikgX2NvbnRhaW5lci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50LCBkZWZhdWx0QWN0aW9uKTsKICAgICAgICB9LAoKICAgICAgICBvbkFjY2Vzc0RpYWxvZ09wZW5lZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgnYWNjZXNzRGlhbG9nJywgJ09wZW5lZCcsICcnLCAnJyk7CgogICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoCiAgICAgICAgICAgICAgICBuZXcgT1QuRXZlbnQoT1QuRXZlbnQubmFtZXMuQUNDRVNTX0RJQUxPR19PUEVORUQsIGZhbHNlKQogICAgICAgICAgICApOwogICAgICAgIH0sCgogICAgICAgIG9uQWNjZXNzRGlhbG9nQ2xvc2VkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdhY2Nlc3NEaWFsb2cnLCAnQ2xvc2VkJywgJycsICcnKTsKCiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCgKICAgICAgICAgICAgICAgIG5ldyBPVC5FdmVudChPVC5FdmVudC5uYW1lcy5BQ0NFU1NfRElBTE9HX0NMT1NFRCwgZmFsc2UpCiAgICAgICAgICAgICk7CiAgICAgICAgfSwKCiAgICAgICAgb25WaWRlb0Vycm9yID0gZnVuY3Rpb24oZXJyb3JDb2RlLCBlcnJvclJlYXNvbikgewogICAgICAgICAgICBPVC5lcnJvcignT1QuUHVibGlzaGVyLm9uVmlkZW9FcnJvcicpOwoKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBlcnJvclJlYXNvbiArIChlcnJvckNvZGUgPyAnICgnICsgZXJyb3JDb2RlICsgJyknIDogJycpOwogICAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgnc3RyZWFtJywgbnVsbCwgJ3JlYXNvbicsICJQdWJsaXNoZXIgd2hpbGUgcGxheWluZyBzdHJlYW06ICIgKyBtZXNzYWdlKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwoKICAgICAgICAgICAgaWYgKF9zdGF0ZS5hdHRlbXB0aW5nVG9QdWJsaXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3B1Ymxpc2hFcnJvcicsIG1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG1lc3NhZ2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBPVC5oYW5kbGVKc0V4Y2VwdGlvbigiUHVibGlzaGVyIGVycm9yIHBsYXlpbmcgc3RyZWFtOiAiICsgbWVzc2FnZSwgMjAwMCwgewogICAgICAgICAgICAgICAgc2Vzc2lvbjogX3Nlc3Npb24sCiAgICAgICAgICAgICAgICB0YXJnZXQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgb25QZWVyRGlzY29ubmVjdGVkID0gZnVuY3Rpb24ocGVlckNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgT1QuZGVidWcoIk9ULlN1YnNjcmliZXIgaGFzIGJlZW4gZGlzY29ubmVjdGVkIGZyb20gdGhlIFB1Ymxpc2hlcidzIFBlZXJDb25uZWN0aW9uIik7CgogICAgICAgICAgICB0aGlzLmNsZWFudXBTdWJzY3JpYmVyKHBlZXJDb25uZWN0aW9uLnJlbW90ZUNvbm5lY3Rpb24uaWQpOwogICAgICAgIH0sCgogICAgICAgIG9uUGVlckNvbm5lY3Rpb25GYWlsdXJlID0gZnVuY3Rpb24oY29kZSwgcmVhc29uLCBwZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgncHVibGlzaCcsICdGYWlsdXJlJywgJ3JlYXNvbnxoYXNSZWxheUNhbmRpZGF0ZXMnLCBbCiAgICAgICAgICAgICAgICAiUHVibGlzaGVyIFBlZXJDb25uZWN0aW9uIHdpdGggY29ubmVjdGlvbiAiICsgcGVlckNvbm5lY3Rpb24ucmVtb3RlQ29ubmVjdGlvbi5pZCAgKyAiIGZhaWxlZDogIiArIHJlYXNvbiwKICAgICAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmhhc1JlbGF5Q2FuZGlkYXRlcwogICAgICAgICAgICAgICAgXS5qb2luKCd8JykpOwoKICAgICAgICAgICAgT1QuaGFuZGxlSnNFeGNlcHRpb24oIlB1Ymxpc2hlciBQZWVyQ29ubmVjdGlvbiBFcnJvcjogIiArIHJlYXNvbiwgMjAwMCwgewogICAgICAgICAgICAgICAgc2Vzc2lvbjogX3Nlc3Npb24sCiAgICAgICAgICAgICAgICB0YXJnZXQ6IHRoaXMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBXZSBkb24ndCBjYWxsIGNsZWFudXBTdWJzY3JpYmVyIGFzIGl0IGFsc28gbG9ncyBhCiAgICAgICAgICAgIC8vIGRpc2Nvbm5lY3RlZCBhbmFseXRpY3MgZXZlbnQsIHdoaWNoIHdlIGRvbid0IHdhbnQgaW4gdGhpcwogICAgICAgICAgICAvLyBpbnN0YW5jZS4gVGhlIGR1cGxpY2F0aW9uIGlzIGNydWZ0eSB0aG91Z2ggYW5kIHNob3VsZAogICAgICAgICAgICAvLyBiZSB0aWRpZWQgdXAuCiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoX3Fvc0ludGVydmFsc1twZWVyQ29ubmVjdGlvbi5yZW1vdGVDb25uZWN0aW9uLmlkXSk7CiAgICAgICAgICAgIGRlbGV0ZSBfcW9zSW50ZXJ2YWxzW3BlZXJDb25uZWN0aW9uLnJlbW90ZUNvbm5lY3Rpb24uaWRdCgogICAgICAgICAgICBkZWxldGUgX3BlZXJDb25uZWN0aW9uc1twZWVyQ29ubmVjdGlvbi5yZW1vdGVDb25uZWN0aW9uLmlkXTsKICAgICAgICB9LAoKICAgICAgICBnZXRTdGF0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChfZ2V0dGluZ1N0YXRzID4gMCkgewogICAgICAgICAgICAgICAgT1QuZGVidWcoIlN0aWxsIGdldHRpbmcgc3RhdHMiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGdldFN0YXRzQmxvYiA9IHt9OwoKICAgICAgICAgICAgLy8gbG9vcHMgdGhyb3VnaCBhbGwgdGhlIHBlZXIgY29ubmVjdGlvbnMgZ2V0IGdldCB0aGUgc3RhdHMgZm9yIHRoZW0KICAgICAgICAgICAgZm9yICh2YXIgY29ubl9pZCBpbiBfcGVlckNvbm5lY3Rpb25zKSB7CgogICAgICAgICAgICAgICAgLy8gdGhpcyBsb2NrcyB0aGUgZ2V0U3RhdHMgZnVuY3Rpb24gc28gaXQgaXNuJ3QgYWNjaWRlbnRhbGx5IGNhbGxlZAogICAgICAgICAgICAgICAgLy8gYWdhaW4gd2hpbGUgYWxyZWFkeSBpbiB0aGUgbWlkZGxlIG9mIGdldHRpbmcgc3RhdHMKICAgICAgICAgICAgICAgIF9nZXR0aW5nU3RhdHMrKzsKCiAgICAgICAgICAgICAgICBnZXRTdGF0c0Jsb2JbY29ubl9pZF0gPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIGp1c3Qgc28gd2UgZG9uJ3QgbG9zZSB0aGUgY29ubmVjdGlvbiBpZAogICAgICAgICAgICAgICAgKGZ1bmN0aW9uKGNvbm5lY3Rpb25faWQpIHsKICAgICAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb25zW2Nvbm5lY3Rpb25faWRdLmdldFN0YXRzKGZ1bmN0aW9uKHBhcnNlZF9zdGF0cykgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb25lIGRvd24KICAgICAgICAgICAgICAgICAgICAgICAgX2dldHRpbmdTdGF0cy0tOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlZF9zdGF0cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0U3RhdHNCbG9iW2Nvbm5lY3Rpb25faWRdID0gcGFyc2VkX3N0YXRzOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGlzIHJlYWNoZXMgemVybywgdGhhdCBtZWFucyBhbGwgb2YgdGhlIHBlZXIgY29ubmVjdGlvbnMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGF2ZSByZXR1cm5lZCB0aGVpciBzdGF0cyByZXBvcnRzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZ2V0dGluZ1N0YXRzID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGdldFN0YXRzQmxvYik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pKGNvbm5faWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8vIFByaXZhdGUgSGVscGVycwoKICAgICAgICAvLyBDbGVhbiB1cCBvdXIgTG9jYWxNZWRpYVN0cmVhbQogICAgICAgIGNsZWFudXBMb2NhbFN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoX3dlYlJUQ1N0cmVhbSkgewogICAgICAgICAgICAgICAgLy8gU3RvcCByZXZva2VzIG91ciBhY2Nlc3MgY2FtIGFuZCBtaWMgYWNjZXNzIGZvciB0aGlzIGluc3RhbmNlCiAgICAgICAgICAgICAgICAvLyBvZiBsb2NhbE1lZGlhU3RyZWFtLgogICAgICAgICAgICAgICAgX3dlYlJUQ1N0cmVhbS5zdG9wKCk7CiAgICAgICAgICAgICAgICBfd2ViUlRDU3RyZWFtID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGNyZWF0ZVBlZXJDb25uZWN0aW9uRm9yUmVtb3RlID0gZnVuY3Rpb24ocmVtb3RlQ29ubmVjdGlvbikgewogICAgICAgICAgICB2YXIgcGVlckNvbm5lY3Rpb24gPSBfcGVlckNvbm5lY3Rpb25zW3JlbW90ZUNvbm5lY3Rpb24uaWRdOwoKICAgICAgICAgICAgaWYgKCFwZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0Q29ubmVjdGluZ1RpbWUgPSBPVC4kLm5vdygpOwoKICAgICAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdjcmVhdGVQZWVyQ29ubmVjdGlvbicsICdBdHRlbXB0JywgJycsICcnKTsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbnVwIG91ciBzdWJzY3JpYmVyIHdoZW4gdGhleSBkaXNjb25uZWN0CiAgICAgICAgICAgICAgICByZW1vdGVDb25uZWN0aW9uLm9uKCdkZXN0cm95ZWQnLCB0aGlzLmNsZWFudXBTdWJzY3JpYmVyLmJpbmQodGhpcywgcmVtb3RlQ29ubmVjdGlvbi5pZCkpOwoKICAgICAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uID0gX3BlZXJDb25uZWN0aW9uc1tyZW1vdGVDb25uZWN0aW9uLmlkXSA9IG5ldyBPVC5QdWJsaXNoZXJQZWVyQ29ubmVjdGlvbigKICAgICAgICAgICAgICAgICAgICByZW1vdGVDb25uZWN0aW9uLAogICAgICAgICAgICAgICAgICAgIF9zZXNzaW9uLAogICAgICAgICAgICAgICAgICAgIF9zdHJlYW0sCiAgICAgICAgICAgICAgICAgICAgX3dlYlJUQ1N0cmVhbQogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5vbih7CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2NyZWF0ZVBlZXJDb25uZWN0aW9uJywgJ1N1Y2Nlc3MnLCAncGNjfGhhc1JlbGF5Q2FuZGlkYXRlcycsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlSW50KE9ULiQubm93KCkgLSBzdGFydENvbm5lY3RpbmdUaW1lLCAxMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5oYXNSZWxheUNhbmRpZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgXS5qb2luKCd8JykpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RhcnQgcmVjb3JkaW5nIHRoZSBRb1MgZm9yIHRoaXMgcGVlciBjb25uZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF9xb3NJbnRlcnZhbHNbcmVtb3RlQ29ubmVjdGlvbi5pZF0gPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZFFPUyhyZW1vdGVDb25uZWN0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgICB9LCAzMDAwMCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBkaXNjb25uZWN0ZWQ6IG9uUGVlckRpc2Nvbm5lY3RlZCwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogb25QZWVyQ29ubmVjdGlvbkZhaWx1cmUKICAgICAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmluaXQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHBlZXJDb25uZWN0aW9uOwogICAgICAgIH0sCgogICAgICAgIC8vLyBDaHJvbWUKCiAgICAgICAgLy8gSWYgbW9kZSBpcyBmYWxzZSwgdGhlbiB0aGF0IGlzIHRoZSBtb2RlLiBJZiBtb2RlIGlzIHRydWUgdGhlbiB3ZSdsbAogICAgICAgIC8vIGRlZmluaXRlbHkgZGlzcGxheSAgdGhlIGJ1dHRvbiwgYnV0IHdlJ2xsIGRlZmVyIHRoZSBtb2RlbCB0byB0aGUKICAgICAgICAvLyBQdWJsaXNoZXJzIGJ1dHRvbkRpc3BsYXlNb2RlIHN0eWxlIHByb3BlcnR5LgogICAgICAgIGNocm9tZUJ1dHRvbk1vZGUgPSBmdW5jdGlvbihtb2RlKSB7CiAgICAgICAgICAgIGlmIChtb2RlID09PSBmYWxzZSkgcmV0dXJuICdvZmYnOwoKICAgICAgICAgICAgdmFyIGRlZmF1bHRNb2RlID0gdGhpcy5nZXRTdHlsZSgnYnV0dG9uRGlzcGxheU1vZGUnKTsKCiAgICAgICAgICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGlzIGZhbHNlLCBidXQgaXQncyBvdmVycmlkZGVuIGJ5ICttb2RlKyBiZWluZyB0cnVlCiAgICAgICAgICAgIGlmIChkZWZhdWx0TW9kZSA9PT0gZmFsc2UpIHJldHVybiAnb24nOwoKICAgICAgICAgICAgLy8gZGVmYXVsdE1vZGUgaXMgZWl0aGVyIHRydWUgb3IgYXV0by4KICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRNb2RlOwogICAgICAgIH0sCgogICAgICAgIHVwZGF0ZUNocm9tZUZvclN0eWxlQ2hhbmdlID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFfY2hyb21lKSByZXR1cm47CgogICAgICAgICAgICBzd2l0Y2goa2V5KSB7CiAgICAgICAgICAgICAgICBjYXNlICduYW1lRGlzcGxheU1vZGUnOgogICAgICAgICAgICAgICAgICAgIF9jaHJvbWUubmFtZS5zZXREaXNwbGF5TW9kZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnYnV0dG9uRGlzcGxheU1vZGUnOgogICAgICAgICAgICAgICAgY2FzZSAnc2hvd01pY0J1dHRvbic6CiAgICAgICAgICAgICAgICBjYXNlICdzaG93U2V0dGluZ3NCdXR0b24nOgogICAgICAgICAgICAgICAgICAgIC8vIF9jaHJvbWUuc2V0dGluZ3NQYW5lbEJ1dHRvbi5zZXREaXNwbGF5TW9kZSgKICAgICAgICAgICAgICAgICAgICAvLyAgICAgY2hyb21lQnV0dG9uTW9kZS5jYWxsKHRoaXMsIHRoaXMuZ2V0U3R5bGUoJ3Nob3dTZXR0aW5nc0J1dHRvbicpKQogICAgICAgICAgICAgICAgICAgIC8vICk7CgogICAgICAgICAgICAgICAgICAgIC8vIF9jaHJvbWUubXV0ZUJ1dHRvbi5zZXREaXNwbGF5TW9kZSgKICAgICAgICAgICAgICAgICAgICAvLyAgICAgY2hyb21lQnV0dG9uTW9kZS5jYWxsKHRoaXMsIHRoaXMuZ2V0U3R5bGUoJ3Nob3dNaWNCdXR0b24nKSkKICAgICAgICAgICAgICAgICAgICAvLyApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NyZWF0ZUNocm9tZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBfY2hyb21lID0gbmV3IE9ULkNocm9tZSh7CiAgICAgICAgICAgICAgICBwYXJlbnQ6IF9jb250YWluZXIuZG9tRWxlbWVudAogICAgICAgICAgICB9KS5zZXQoewogICAgICAgICAgICAgICAgbmFtZTogbmV3IE9ULkNocm9tZS5OYW1lUGFuZWwoewogICAgICAgICAgICAgICAgICAgIG5hbWU6IF9wdWJsaXNoUHJvcGVydGllcy5uYW1lLAogICAgICAgICAgICAgICAgICAgIG1vZGU6IHRoaXMuZ2V0U3R5bGUoJ25hbWVEaXNwbGF5TW9kZScpCiAgICAgICAgICAgICAgICB9KSwKCiAgICAgICAgICAgICAgICAvLyBzZXR0aW5nc1BhbmVsQnV0dG9uOiBuZXcgT1QuQ2hyb21lLlNldHRpbmdzUGFuZWxCdXR0b24oewogICAgICAgICAgICAgICAgLy8gICAgIG1vZGU6IGNocm9tZUJ1dHRvbk1vZGUuY2FsbCh0aGlzLCB0aGlzLmdldFN0eWxlKCdzaG93U2V0dGluZ3NCdXR0b24nKSkKICAgICAgICAgICAgICAgIC8vIH0pLAoKICAgICAgICAgICAgICAgIC8vIERpc2FibGVkIHVudGlsIHdlIGNhbiBjaGFuZ2UgdGhlIG1pYyBWb2x1bWUgdGhyb3VnaCBXZWJSVEMKICAgICAgICAgICAgICAgIG11dGVCdXR0b246IG5ldyBPVC5DaHJvbWUuTXV0ZUJ1dHRvbih7CiAgICAgICAgICAgICAgICAgICAgbXV0ZWQ6IF9wdWJsaXNoUHJvcGVydGllcy5wdWJsaXNoQXVkaW8gPT09IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIG1vZGU6IGNocm9tZUJ1dHRvbk1vZGUuY2FsbCh0aGlzLCB0aGlzLmdldFN0eWxlKCdzaG93TWljQnV0dG9uJykpCiAgICAgICAgICAgICAgICB9KSwKCiAgICAgICAgICAgICAgICBvcGVudG9rQnV0dG9uOiBuZXcgT1QuQ2hyb21lLk9wZW5Ub2tCdXR0b24oKQogICAgICAgICAgICB9KS5vbih7CiAgICAgICAgICAgICAgICAvLyAnU2V0dGluZ3NQYW5lbDpvcGVuJzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyAgICAgaWYgKCFfY2hyb21lLnNldHRpbmdzUGFuZWwpIHsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgLy8gQWRkIHRoZSBzZXR0aW5ncyBwYW5lbCwgaGlkZSBpdCBpbml0aWFsbHkKICAgICAgICAgICAgICAgIC8vICAgICAgICAgX2Nocm9tZS5zZXQoCiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAnc2V0dGluZ3NQYW5lbCcsCiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICBuZXcgT1QuQ2hyb21lLlNldHRpbmdzUGFuZWwoewogICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgIHN0cmVhbTogX3dlYlJUQ1N0cmVhbSwKICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICBtb2RlOiAnb24nCiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLy8gICAgICAgICApOwogICAgICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgICAgIC8vICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgX2Nocm9tZS5zZXR0aW5nc1BhbmVsLnNldERpc3BsYXlNb2RlKCdvbicpOwogICAgICAgICAgICAgICAgLy8gICAgIH0KCiAgICAgICAgICAgICAgICAvLyAgICAgT1QuJC5hZGRDbGFzcyhfY29udGFpbmVyLCAnT1RfcmV2ZXJzZWQnKTsKICAgICAgICAgICAgICAgIC8vIH0sCgogICAgICAgICAgICAgICAgLy8gJ1NldHRpbmdzUGFuZWw6Y2xvc2UnOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vICAgICBPVC4kLnJlbW92ZUNsYXNzKF9jb250YWluZXIsICdPVF9yZXZlcnNlZCcpOwoKICAgICAgICAgICAgICAgIC8vICAgICAvLyBIaWRlIHRoZSBzZXR0aW5ncyBwYW5lbCBhZnRlciBvdXIgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgICAgICAgICAvLyAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgX2Nocm9tZS5zZXR0aW5nc1BhbmVsLnNldERpc3BsYXlNb2RlKCdvZmYnKTsKICAgICAgICAgICAgICAgIC8vICAgICB9LCAzMDAwKTsKICAgICAgICAgICAgICAgIC8vIH0sCgoKICAgICAgICAgICAgICAgIG11dGVkOiB0aGlzLnB1Ymxpc2hBdWRpby5iaW5kKHRoaXMsIGZhbHNlKSwKICAgICAgICAgICAgICAgIHVubXV0ZWQ6IHRoaXMucHVibGlzaEF1ZGlvLmJpbmQodGhpcywgdHJ1ZSkKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcmVzZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF9jaHJvbWUpIHsKICAgICAgICAgICAgICBfY2hyb21lLmRlc3Ryb3koKTsKICAgICAgICAgICAgICBfY2hyb21lID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7CgogICAgICAgICAgICBfbWljcm9waG9uZSA9IG51bGw7CgogICAgICAgICAgICBpZiAoX3RhcmdldEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIF90YXJnZXRFbGVtZW50LmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIF90YXJnZXRFbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2xlYW51cExvY2FsU3RyZWFtKCk7CgogICAgICAgICAgICBpZiAoX2NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgX2NvbnRhaW5lci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICBfY29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc2Vzc2lvbikgdGhpcy5fLnVucHVibGlzaEZyb21TZXNzaW9uKHRoaXMuc2Vzc2lvbik7CgogICAgICAgICAgICAvLyBjbGVhciBhbGwgdGhlIGludGVydmFscwogICAgICAgICAgICBmb3IgKHZhciBjb25uX2lkIGluIF9xb3NJbnRlcnZhbHMpIHsKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoX3Fvc0ludGVydmFsc1tjb25uX2lkXSk7CiAgICAgICAgICAgICAgICBkZWxldGUgX3Fvc0ludGVydmFsc1tjb25uX2lkXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2RvbUlkID0gbnVsbDsKICAgICAgICAgICAgX3N0cmVhbSA9IG51bGw7CiAgICAgICAgICAgIF9sb2FkZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIF9zZXNzaW9uID0gbnVsbDsKICAgICAgICAgICAgX3Byb3BlcnRpZXMgPSBudWxsOwoKICAgICAgICAgICAgX3N0YXRlLnNldCgnTm90UHVibGlzaGluZycpOwogICAgICAgIH0uYmluZCh0aGlzKTsKCgogICAgdGhpcy5wdWJsaXNoID0gZnVuY3Rpb24odGFyZ2V0RWxlbWVudCwgcHJvcGVydGllcykgewogICAgICAgIE9ULmRlYnVnKCJPVC5QdWJsaXNoZXI6IHB1Ymxpc2giKTsKCiAgICAgICAgaWYgKCBfc3RhdGUuYXR0ZW1wdGluZ1RvUHVibGlzaCB8fCBfc3RhdGUucHVibGlzaGluZyApIHJlc2V0KCk7CiAgICAgICAgX3N0YXRlLnNldCgnR2V0VXNlck1lZGlhJyk7CgogICAgICAgIF9wdWJsaXNoUHJvcGVydGllcyA9IE9ULiQuZGVmYXVsdHMocHJvcGVydGllcyB8fCB7fSwgewogICAgICAgICAgICBwdWJsaXNoQXVkaW8gOiB0cnVlLAogICAgICAgICAgICBwdWJsaXNoVmlkZW8gOiB0cnVlLAogICAgICAgICAgICBtaXJyb3I6IHRydWUKICAgICAgICB9KTsKCiAgICAgICAgX3B1Ymxpc2hQcm9wZXJ0aWVzLmNvbnN0cmFpbnRzID0gT1QuJC5kZWZhdWx0cyhfcHVibGlzaFByb3BlcnRpZXMuY29uc3RyYWludHMgfHwge30sIGRlZmF1bHRDb25zdHJhaW50cyk7CgogICAgICAgIGlmIChfcHVibGlzaFByb3BlcnRpZXMuc3R5bGUpIHsKICAgICAgICAgICAgdGhpcy5zZXRTdHlsZShfcHVibGlzaFByb3BlcnRpZXMuc3R5bGUsIG51bGwsIHRydWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wdWJsaXNoUHJvcGVydGllcy5uYW1lKSB7CiAgICAgICAgICAgIF9wdWJsaXNoUHJvcGVydGllcy5uYW1lID0gX3B1Ymxpc2hQcm9wZXJ0aWVzLm5hbWUudG9TdHJpbmcoKTsKICAgICAgICB9CgogICAgICAgIF9wdWJsaXNoUHJvcGVydGllcy5jbGFzc05hbWVzID0gJ09UX3Jvb3QgT1RfcHVibGlzaGVyJzsKCiAgICAgICAgLy8gRGVmZXIgYWN0dWFsbHkgY3JlYXRpbmcgdGhlIHB1Ymxpc2hlciBET00gbm9kZXMgdW50aWwgd2Uga25vdwogICAgICAgIC8vIHRoZSBET00gaXMgYWN0dWFsbHkgbG9hZGVkLgogICAgICAgIE9ULm9uTG9hZChmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2NvbnRhaW5lciA9IG5ldyBPVC5XaWRnZXRWaWV3KHRhcmdldEVsZW1lbnQsIF9wdWJsaXNoUHJvcGVydGllcyk7CiAgICAgICAgICAgIF9kb21JZCA9IF9jb250YWluZXIuZG9tSWQ7CgogICAgICAgICAgICBPVC4kLmdldFVzZXJNZWRpYSgKICAgICAgICAgICAgICAgIF9wdWJsaXNoUHJvcGVydGllcy5jb25zdHJhaW50cywKICAgICAgICAgICAgICAgIG9uU3RyZWFtQXZhaWxhYmxlLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICBvblN0cmVhbUF2YWlsYWJsZUVycm9yLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICBvbkFjY2Vzc0RpYWxvZ09wZW5lZC5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgb25BY2Nlc3NEaWFsb2dDbG9zZWQuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgIG9uQWNjZXNzRGVuaWVkLmJpbmQodGhpcykKICAgICAgICAgICAgKTsKICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKIC8qKgogICogU3RhcnRzIHB1Ymxpc2hpbmcgYXVkaW8gKGlmIGl0IGlzIGN1cnJlbnRseSBub3QgYmVpbmcgcHVibGlzaGVkKQogICogd2hlbiB0aGUgPGNvZGU+dmFsdWU8L2NvZGU+IGlzIDxjb2RlPnRydWU8L2NvZGU+OyBzdG9wcyBwdWJsaXNoaW5nIGF1ZGlvCiAgKiAoaWYgaXQgaXMgY3VycmVudGx5IGJlaW5nIHB1Ymxpc2hlZCkgd2hlbiB0aGUgPGNvZGU+dmFsdWU8L2NvZGU+IGlzIDxjb2RlPmZhbHNlPC9jb2RlPi4KICAqCiAgKiBAcGFyYW0ge0Jvb2xlYW59IHZhbHVlIFdoZXRoZXIgdG8gc3RhcnQgcHVibGlzaGluZyBhdWRpbyAoPGNvZGU+dHJ1ZTwvY29kZT4pCiAgKiBvciBub3QgKDxjb2RlPmZhbHNlPC9jb2RlPikuCiAgKgogICogQHNlZSA8YSBocmVmPSJUQi5odG1sI2luaXRQdWJsaXNoZXIiPlRCLmluaXRQdWJsaXNoZXIoKTwvYT4KICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtLmh0bWwjaGFzQXVkaW8iPlN0cmVhbS5oYXNBdWRpbzwvYT4KICAqIEBzZWUgU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQKICAqIEBtZXRob2QgI3B1Ymxpc2hBdWRpbwogICogQG1lbWJlck9mIFB1Ymxpc2hlcgogICovCiAgICB0aGlzLnB1Ymxpc2hBdWRpbyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgX3B1Ymxpc2hQcm9wZXJ0aWVzLnB1Ymxpc2hBdWRpbyA9IHZhbHVlOwoKICAgICAgICBpZiAoX21pY3JvcGhvbmUpIHsKICAgICAgICAgICAgX21pY3JvcGhvbmUubXV0ZWQgPSAhdmFsdWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoX3Nlc3Npb24gJiYgX3N0cmVhbSkgewogICAgICAgICAgICBfc2Vzc2lvbi5fLm1vZGlmeVN0cmVhbShfc3RyZWFtLnN0cmVhbUlkLCAiaGFzQXVkaW8iLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogLyoqCiAgKiBTdGFydHMgcHVibGlzaGluZyB2aWRlbyAoaWYgaXQgaXMgY3VycmVudGx5IG5vdCBiZWluZyBwdWJsaXNoZWQpCiAgKiB3aGVuIHRoZSA8Y29kZT52YWx1ZTwvY29kZT4gaXMgPGNvZGU+dHJ1ZTwvY29kZT47IHN0b3BzIHB1Ymxpc2hpbmcgdmlkZW8KICAqIChpZiBpdCBpcyBjdXJyZW50bHkgYmVpbmcgcHVibGlzaGVkKSB3aGVuIHRoZSA8Y29kZT52YWx1ZTwvY29kZT4gaXMgPGNvZGU+ZmFsc2U8L2NvZGU+LgogICoKICAqIEBwYXJhbSB7Qm9vbGVhbn0gdmFsdWUgV2hldGhlciB0byBzdGFydCBwdWJsaXNoaW5nIHZpZGVvICg8Y29kZT50cnVlPC9jb2RlPikKICAqIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4KICAqCiAgKiBAc2VlIDxhIGhyZWY9IlRCLmh0bWwjaW5pdFB1Ymxpc2hlciI+VEIuaW5pdFB1Ymxpc2hlcigpPC9hPgogICogQHNlZSA8YSBocmVmPSJTdHJlYW0uaHRtbCNoYXNWaWRlbyI+U3RyZWFtLmhhc1ZpZGVvPC9hPgogICogQHNlZSBTdHJlYW1Qcm9wZXJ0eUNoYW5nZWRFdmVudAogICogQG1ldGhvZCAjcHVibGlzaFZpZGVvCiAgKiBAbWVtYmVyT2YgUHVibGlzaGVyCiAgKi8KICAgIHRoaXMucHVibGlzaFZpZGVvID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgb2xkVmFsdWUgPSBfcHVibGlzaFByb3BlcnRpZXMucHVibGlzaFZpZGVvOwogICAgICAgIF9wdWJsaXNoUHJvcGVydGllcy5wdWJsaXNoVmlkZW8gPSB2YWx1ZTsKCiAgICAgICAgaWYgKF9zZXNzaW9uICYmIF9zdHJlYW0gJiYgX3B1Ymxpc2hQcm9wZXJ0aWVzLnB1Ymxpc2hWaWRlbyAhPT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgX3Nlc3Npb24uXy5tb2RpZnlTdHJlYW0oX3N0cmVhbS5zdHJlYW1JZCwgImhhc1ZpZGVvIiwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2UgY3VycmVudGx5IGRvIHRoaXMgZXZlbnQgaWYgdGhlIHZhbHVlIG9mIHB1Ymxpc2hWaWRlbyBoYXMgbm90IGNoYW5nZWQKICAgICAgICAvLyBUaGlzIGlzIGJlY2F1c2UgdGhlIHN0YXRlIG9mIHRoZSB2aWRlbyB0cmFja3MgZW5hYmxlZCBmbGFnIG1heSBub3QgbWF0Y2gKICAgICAgICAvLyB0aGUgdmFsdWUgb2YgcHVibGlzaFZpZGVvIGF0IHRoaXMgcG9pbnQuIFRoaXMgd2lsbCBiZSB0aWRpZWQgdXAgc2hvcnRseS4KICAgICAgICBpZiAoX3dlYlJUQ1N0cmVhbSkgewogICAgICAgICAgICB2YXIgdmlkZW9UcmFja3MgPSBfd2ViUlRDU3RyZWFtLmdldFZpZGVvVHJhY2tzKCk7CiAgICAgICAgICAgIGZvciAodmFyIGk9MCwgbnVtPXZpZGVvVHJhY2tzLmxlbmd0aDsgaTxudW07ICsraSkgewogICAgICAgICAgICAgICAgdmlkZW9UcmFja3NbaV0uZW5hYmxlZCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihfY29udGFpbmVyKSB7CiAgICAgICAgICAgIF9jb250YWluZXIuc2hvd1Bvc3RlciA9ICF2YWx1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB0aGlzLnJlY29yZFFPUyA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAvLyBoYXZlIHRvIHJlY29yZCBRb1MgZm9yIGV2ZXJ5IHBlZXIgY29ubmVjdGlvbgogICAgICAgIGZvciAodmFyIGNvbm5faWQgaW4gX3BlZXJDb25uZWN0aW9ucykgewogICAgICAgICAgICByZWNvcmRRT1MoY29ubl9pZCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICogRGVsZXRlcyB0aGUgUHVibGlzaGVyIG9iamVjdCBhbmQgcmVtb3ZlcyBpdCBmcm9tIHRoZSBIVE1MIERPTS4KICAgICogQG1ldGhvZCAjZGVzdHJveQogICAgKiBAbWVtYmVyT2YgUHVibGlzaGVyCiAgICAqIEByZXR1cm4ge1B1Ymxpc2hlcn0gVGhlIFB1Ymxpc2hlci4KICAgICovCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigvKiB1bnVzZWQgKi8gcmVhc29uLCBxdWlldCkgewogICAgICAgIHJlc2V0KCk7CgogICAgICAgIGlmIChxdWlldCAhPT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoCiAgICAgICAgICAgICAgbmV3IE9ULkRlc3Ryb3llZEV2ZW50KAogICAgICAgICAgICAgICAgT1QuRXZlbnQubmFtZXMuUFVCTElTSEVSX0RFU1RST1lFRCwKICAgICAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgICAgICByZWFzb24KICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIHRoaXMub2ZmLmJpbmQodGhpcykKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvKioKICAgICogQG1ldGhvZE9mIFB1Ymxpc2hlcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuZGlzY29ubmVjdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIENsb3NlIHRoZSBjb25uZWN0aW9uIHRvIGVhY2ggb2Ygb3VyIHN1YnNjcmliZXJzCiAgICAgICAgZm9yICh2YXIgZnJvbUNvbm5lY3Rpb25JZCBpbiBfcGVlckNvbm5lY3Rpb25zKSB7CiAgICAgICAgICAgIHRoaXMuY2xlYW51cFN1YnNjcmliZXIoZnJvbUNvbm5lY3Rpb25JZCk7CiAgICAgICAgfQogICAgfTsKCiAgICB0aGlzLmNsZWFudXBTdWJzY3JpYmVyID0gZnVuY3Rpb24oZnJvbUNvbm5lY3Rpb25JZCkgewogICAgICAgIHZhciBwYyA9IF9wZWVyQ29ubmVjdGlvbnNbZnJvbUNvbm5lY3Rpb25JZF07CgogICAgICAgIGNsZWFySW50ZXJ2YWwoX3Fvc0ludGVydmFsc1tmcm9tQ29ubmVjdGlvbklkXSk7CiAgICAgICAgZGVsZXRlIF9xb3NJbnRlcnZhbHNbZnJvbUNvbm5lY3Rpb25JZF07CgogICAgICAgIGlmIChwYykgewogICAgICAgICAgICBwYy5kZXN0cm95KCk7CiAgICAgICAgICAgIGRlbGV0ZSBfcGVlckNvbm5lY3Rpb25zW2Zyb21Db25uZWN0aW9uSWRdOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2Rpc2Nvbm5lY3QnLCAnUGVlckNvbm5lY3Rpb24nLCAnc3Vic2NyaWJlckNvbm5lY3Rpb24nLCBmcm9tQ29ubmVjdGlvbklkKTsKICAgICAgICB9CiAgICB9OwoKCiAgICB0aGlzLnByb2Nlc3NNZXNzYWdlID0gZnVuY3Rpb24odHlwZSwgZnJvbUNvbm5lY3Rpb24sIG1lc3NhZ2UpIHsKICAgICAgICBPVC5kZWJ1ZygiT1QuUHVibGlzaGVyLnByb2Nlc3NNZXNzYWdlOiBSZWNlaXZlZCAiICsgdHlwZSArICIgZnJvbSAiICsgZnJvbUNvbm5lY3Rpb24uaWQpOwogICAgICAgIE9ULmRlYnVnKG1lc3NhZ2UpOwoKICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBPVC5SYXB0b3IuQWN0aW9ucy5VTlNVQlNDUklCRToKICAgICAgICAgICAgICAgIHRoaXMuY2xlYW51cFN1YnNjcmliZXIoZnJvbUNvbm5lY3Rpb24uaWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIHBlZXJDb25uZWN0aW9uID0gY3JlYXRlUGVlckNvbm5lY3Rpb25Gb3JSZW1vdGUuY2FsbCh0aGlzLCBmcm9tQ29ubmVjdGlvbik7CiAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5wcm9jZXNzTWVzc2FnZSh0eXBlLCBtZXNzYWdlKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBiYXNlLTY0LWVuY29kZWQgc3RyaW5nIG9mIFBORyBkYXRhIHJlcHJlc2VudGluZyB0aGUgUHVibGlzaGVyIHZpZGVvLgogICAgKgogICAgKiAgIDxwPllvdSBjYW4gdXNlIHRoZSBzdHJpbmcgYXMgdGhlIHZhbHVlIGZvciBhIGRhdGEgVVJMIHNjaGVtZSBwYXNzZWQgdG8gdGhlIHNyYyBwYXJhbWV0ZXIgb2YKICAgICogICBhbiBpbWFnZSBmaWxlLCBhcyBpbiB0aGUgZm9sbG93aW5nOjwvcD4KICAgICoKICAgICogPHByZT4KICAgICogIHZhciBpbWdEYXRhID0gcHVibGlzaGVyLmdldEltZ0RhdGEoKTsKICAgICoKICAgICogIHZhciBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICogIGltZy5zZXRBdHRyaWJ1dGUoInNyYyIsICJkYXRhOmltYWdlL3BuZztiYXNlNjQsIiArIGltZ0RhdGEpOwogICAgKiAgdmFyIGltZ1dpbiA9IHdpbmRvdy5vcGVuKCJhYm91dDpibGFuayIsICJTY3JlZW5zaG90Iik7CiAgICAqICBpbWdXaW4uZG9jdW1lbnQud3JpdGUoIiZsdDtib2R5Jmd0OyZsdDsvYm9keSZndDsiKTsKICAgICogIGltZ1dpbi5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGltZyk7CiAgICAqIDwvcHJlPgogICAgKgogICAgKiBAbWV0aG9kICNnZXRJbWdEYXRhCiAgICAqIEBtZW1iZXJPZiBQdWJsaXNoZXIKICAgICogQHJldHVybiB7U3RyaW5nfSBUaGUgYmFzZS02NCBlbmNvZGVkIHN0cmluZy4gUmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaWYgdGhlcmUgaXMgbm8gdmlkZW8uCiAgICAqLwoKICAgIHRoaXMuZ2V0SW1nRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghX2xvYWRlZCkgewogICAgICAgICAgICBPVC5lcnJvcigiT1QuUHVibGlzaGVyLmdldEltZ0RhdGE6IENhbm5vdCBnZXRJbWdEYXRhIGJlZm9yZSB0aGUgUHVibGlzaGVyIGlzIHB1Ymxpc2hpbmcuIik7CgogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBfdGFyZ2V0RWxlbWVudC5pbWdEYXRhOwogICAgfTsKCgogICAgLy8gQVBJIENvbXBhdGliaWxpdHkgbGF5ZXIgZm9yIEZsYXNoIFB1Ymxpc2hlciwgdGhpcyBjb3VsZCBkbyB3aXRoIHNvbWUgdGlkeXVwLgogICAgdGhpcy5fID0gewogICAgICAgIHB1Ymxpc2hUb1Nlc3Npb246IGZ1bmN0aW9uKHNlc3Npb24pIHsKICAgICAgICAgICAgLy8gQWRkIHNlc3Npb24gcHJvcGVydHkgdG8gUHVibGlzaGVyCiAgICAgICAgICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb247CgogICAgICAgICAgICB2YXIgY3JlYXRlU3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyBCYWlsIGlmIHRoaXMuc2Vzc2lvbiBpcyBnb25lLCBpdCBtZWFucyB3ZSB3ZXJlIHVucHVibGlzaGVkCiAgICAgICAgICAgICAgICAvLyBiZWZvcmUgY3JlYXRlU3RyZWFtIGNvdWxkIGZpbmlzaC4KICAgICAgICAgICAgICAgIGlmICghdGhpcy5zZXNzaW9uKSByZXR1cm47CgogICAgICAgICAgICAgICAgX3N0YXRlLnNldCgnUHVibGlzaGluZ1RvU2Vzc2lvbicpOwoKICAgICAgICAgICAgICAgIHNlc3Npb24uXy5jcmVhdGVTdHJlYW0oIHRoaXMuZ3VpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9wdWJsaXNoUHJvcGVydGllcyAmJiBfcHVibGlzaFByb3BlcnRpZXMubmFtZSA/IF9wdWJsaXNoUHJvcGVydGllcy5uYW1lIDogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPVC5WaWRlb09yaWVudGF0aW9uLlJPVEFURURfTk9STUFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RhcmdldEVsZW1lbnQudmlkZW9XaWR0aCwgICAgICAgICAgICAgICAgICAgICAgLy8gYWN0dWFsIHdpZHRoIGFuZCBoZWlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRFbGVtZW50LnZpZGVvSGVpZ2h0LCAgICAgICAgICAgICAgICAgICAgIC8vIG9mIHRoZSB2aWRlbyBzdHJlYW0uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcHVibGlzaFByb3BlcnRpZXMucHVibGlzaEF1ZGlvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3B1Ymxpc2hQcm9wZXJ0aWVzLnB1Ymxpc2hWaWRlbyApOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKF9sb2FkZWQpIGNyZWF0ZVN0cmVhbS5jYWxsKHRoaXMpOwogICAgICAgICAgICBlbHNlIHRoaXMub24oImluaXRTdWNjZXNzIiwgY3JlYXRlU3RyZWFtLCB0aGlzKTsKCiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdwdWJsaXNoJywgJ0F0dGVtcHQnLCAnc3RyZWFtVHlwZScsICdXZWJSVEMnKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0uYmluZCh0aGlzKSwKCiAgICAgICAgdW5wdWJsaXNoRnJvbVNlc3Npb246IGZ1bmN0aW9uKHNlc3Npb24pIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnNlc3Npb24gfHwgc2Vzc2lvbi5pZCAhPT0gdGhpcy5zZXNzaW9uLmlkKSB7CiAgICAgICAgICAgICAgICBPVC53YXJuKCJUaGUgcHVibGlzaGVyICIgKyB0aGlzLmd1aWQgKyAiIGlzIHRyeWluZyB0byB1bnB1Ymxpc2ggZnJvbSBhIHNlc3Npb24gIiArIHNlc3Npb24uaWQgKyAiIGl0IGlzIG5vdCBhdHRhY2hlZCB0byIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZXNzaW9uLmNvbm5lY3RlZCAmJiB0aGlzLnN0cmVhbSkgewogICAgICAgICAgICAgICAgc2Vzc2lvbi5fLmRlc3Ryb3lTdHJlYW0odGhpcy5zdHJlYW0uaWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEaXNjb25uZWN0IGltbWVkaWF0ZWx5LCByYXRoZXIgdGhhbiB3YWl0IGZvciB0aGUgV2ViU29ja2V0IHRvCiAgICAgICAgICAgIC8vIHJlcGx5IHRvIG91ciBkZXN0cm95U3RyZWFtIG1lc3NhZ2UuCiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB0aGlzLnNlc3Npb24gPSBudWxsOwoKICAgICAgICAgICAgLy8gV2UncmUgYmFjayB0byBiZWluZyBhIHN0YW5kLWFsb25lIHB1Ymxpc2hlciBhZ2Fpbi4KICAgICAgICAgICAgX3N0YXRlLnNldCgnTWVkaWFCb3VuZCcpOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3VucHVibGlzaCcsICdTdWNjZXNzJywgJ3Nlc3Npb25JZCcsIHNlc3Npb24uaWQpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfS5iaW5kKHRoaXMpLAoKICAgICAgICAvLyBDYWxsZWQgb25jZSBvdXIgc3RyZWFtIGhhcyBiZWVuIGFjaydkIGFzIGNyZWF0ZWQgYnkgdGhlIHNlc3Npb24KICAgICAgICBzdHJlYW1SZWdpc3RlcmVkSGFuZGxlcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtOwogICAgICAgICAgICB0aGlzLnN0cmVhbS5vbignZGVzdHJveWVkJywgdGhpcy5kaXNjb25uZWN0LCB0aGlzKTsKCiAgICAgICAgICAgIHZhciBvbGRHdWlkID0gX2d1aWQ7CiAgICAgICAgICAgIF9ndWlkID0gT1QuUHVibGlzaGVyLm5leHRJZCgpOwoKICAgICAgICAgICAgLy8gT3VyIHB1Ymxpc2hlciBoYXMgY2hhbmdlZCBndWlkcywgbGV0IHBlb3BsZSB0aGF0IHJlbHkKICAgICAgICAgICAgLy8gb24gdGhlIEdVSUQgYmUgbm9uLXZvbGF0aWxlIGtub3cuCiAgICAgICAgICAgIGlmIChvbGRHdWlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2lkVXBkYXRlZCcsIG9sZEd1aWQsIF9ndWlkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3N0YXRlLnNldCgnUHVibGlzaGluZycpOwogICAgICAgICAgICBfcHVibGlzaFN0YXJ0VGltZSA9IG5ldyBEYXRlKCk7CgogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3B1Ymxpc2hTdWNjZXNzJyk7CiAgICAgICAgfS5iaW5kKHRoaXMpCiAgICB9OwoKICAgIHRoaXMuZGV0ZWN0RGV2aWNlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIE9ULndhcm4oIkZpeG1lOiBIYXZlbid0IGltcGxlbWVudGVkIGRldGVjdERldmljZXMiKTsKICAgIH07CgogICAgdGhpcy5kZXRlY3RNaWNBY3Rpdml0eSA9IGZ1bmN0aW9uKCkgewogICAgICAgIE9ULndhcm4oIkZpeG1lOiBIYXZlbid0IGltcGxlbWVudGVkIGRldGVjdE1pY0FjdGl2aXR5Iik7CiAgICB9OwoKICAgIHRoaXMuZ2V0RWNob0NhbmNlbGxhdGlvbk1vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICBPVC53YXJuKCJGaXhtZTogSGF2ZW4ndCBpbXBsZW1lbnRlZCBnZXRFY2hvQ2FuY2VsbGF0aW9uTW9kZSIpOwogICAgICAgIHJldHVybiAiZnVsbER1cGxleCI7CiAgICB9OwoKICAgIHRoaXMuc2V0TWljcm9waG9uZUdhaW4gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIE9ULndhcm4oIkZpeG1lOiBIYXZlbid0IGltcGxlbWVudGVkIHNldE1pY3JvcGhvbmVHYWluIik7CiAgICB9OwoKICAgIHRoaXMuZ2V0TWljcm9waG9uZUdhaW4gPSBmdW5jdGlvbigpIHsKICAgICAgICBPVC53YXJuKCJGaXhtZTogSGF2ZW4ndCBpbXBsZW1lbnRlZCBnZXRNaWNyb3Bob25lR2FpbiIpOwogICAgICAgIHJldHVybiAwLjU7CiAgICB9OwoKICAgIHRoaXMuc2V0Q2FtZXJhID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBPVC53YXJuKCJGaXhtZTogSGF2ZW4ndCBpbXBsZW1lbnRlZCBzZXRDYW1lcmEiKTsKICAgIH07CgogICAgdGhpcy5zZXRNaWNyb3Bob25lID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBPVC53YXJuKCJGaXhtZTogSGF2ZW4ndCBpbXBsZW1lbnRlZCBzZXRNaWNyb3Bob25lIik7CiAgICB9OwoKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgICAgaWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9kb21JZDsgfSwKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgIH0sCgogICAgICAgIGd1aWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9ndWlkOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfc3RyZWFtOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHN0cmVhbSkgeyBfc3RyZWFtID0gc3RyZWFtOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtSWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghX3N0cmVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICAgICAgcmV0dXJuIF9zdHJlYW0uaWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9LAoKICAgICAgICB0YXJnZXRFbGVtZW50OiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfdGFyZ2V0RWxlbWVudC5kb21FbGVtZW50OyB9CiAgICAgICAgfSwKCiAgICAgICAgZG9tSWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9kb21JZDsgfQogICAgICAgIH0sCgogICAgICAgIHNlc3Npb246IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHNlc3Npb24pIHsgX3Nlc3Npb24gPSBzZXNzaW9uOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgaXNXZWJSVEM6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH0KICAgICAgICB9LAoKICAgICAgICBsb2FkaW5nOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKXsgcmV0dXJuIF9jb250YWluZXIgJiYgX2NvbnRhaW5lci5sb2FkaW5nIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5fLCAnd2ViUnRjU3RyZWFtJywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfd2ViUlRDU3RyZWFtOyB9CiAgICB9KTsKCiAgICB0aGlzLm9uKCdzdHlsZVZhbHVlQ2hhbmdlZCcsIHVwZGF0ZUNocm9tZUZvclN0eWxlQ2hhbmdlLCB0aGlzKTsKICAgIF9zdGF0ZSA9IG5ldyBPVC5QdWJsaXNoaW5nU3RhdGUoc3RhdGVDaGFuZ2VGYWlsZWQpOwoKCiAgLyoqCiAgKiBEaXNwYXRjaGVkIHdoZW4gdGhlIHVzZXIgaGFzIGNsaWNrZWQgdGhlIEFsbG93IGJ1dHRvbiwgZ3JhbnRpbmcgdGhlCiAgKiBhcHAgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuCiAgKiBAbmFtZSBhY2Nlc3NBbGxvd2VkCiAgKiBAZXZlbnQKICAqIEBtZW1iZXJvZiBQdWJsaXNoZXIKICAqLwoKICAvKioKICAqIERpc3BhdGNoZWQgd2hlbiB0aGUgdXNlciBoYXMgY2xpY2tlZCB0aGUgRGVueSBidXR0b24sIHByZXZlbnRpbmcgdGhlCiAgKiBhcHAgZnJvbSBoYXZpbmcgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuCiAgKiBAbmFtZSBhY2Nlc3NEZW5pZWQKICAqIEBldmVudAogICogQG1lbWJlcm9mIFB1Ymxpc2hlcgogICovCgogIC8qKgogICogRGlzcGF0Y2hlZCB3aGVuIHRoZSBBbGxvdy9EZW55IGRpYWxvZyBib3ggaXMgb3BlbmVkLiAoVGhpcyBpcyB0aGUgZGlhbG9nIGJveCBpbiB3aGljaCB0aGUgdXNlciBjYW4gZ3JhbnQKICAqIHRoZSBhcHAgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuKQogICogQG5hbWUgYWNjZXNzRGlhbG9nT3BlbmVkCiAgKiBAZXZlbnQKICAqIEBtZW1iZXJvZiBQdWJsaXNoZXIKICAqLwoKICAvKioKICAqIERpc3BhdGNoZWQgd2hlbiB0aGUgQWxsb3cvRGVueSBib3ggaXMgY2xvc2VkLiAoVGhpcyBpcyB0aGUgZGlhbG9nIGJveCBpbiB3aGljaCB0aGUgdXNlciBjYW4gZ3JhbnQKICAqIHRoZSBhcHAgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuKQogICogQG5hbWUgYWNjZXNzRGlhbG9nQ2xvc2VkCiAgKiBAZXZlbnQKICAqIEBtZW1iZXJvZiBQdWJsaXNoZXIKICAqLwoKfTsKCi8vIEhlbHBlciBmdW5jdGlvbiB0byBnZW5lcmF0ZSB1bmlxdWUgcHVibGlzaGVyIGlkcwpPVC5QdWJsaXNoZXIubmV4dElkID0gT1QuJC51dWlkOwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewoKCi8qKgogKiBUaGUgU3Vic2NyaWJlciBvYmplY3QgaXMgYSByZXByZXNlbnRhdGlvbiBvZiB0aGUgbG9jYWwgdmlkZW8gZWxlbWVudCB0aGF0IGlzIHBsYXlpbmcgYmFjayBhIHJlbW90ZSBzdHJlYW0uCiAqIFRoZSBTdWJzY3JpYmVyIG9iamVjdCBpbmNsdWRlcyBtZXRob2RzIHRoYXQgbGV0IHlvdSBkaXNhYmxlIGFuZCBlbmFibGUgbG9jYWwgYXVkaW8gcGxheWJhY2sgZm9yIHRoZSBzdWJzY3JpYmVkIHN0cmVhbS4KICogVGhlIDxjb2RlPnN1YnNjcmliZSgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIHtAbGluayBTZXNzaW9ufSBvYmplY3QgcmV0dXJucyBhIFN1YnNjcmliZXIgb2JqZWN0LgogKgogKiBAcHJvcGVydHkge1N0cmluZ30gaWQgVGhlIERPTSBJRCBvZiB0aGUgU3Vic2NyaWJlci4KICogQHByb3BlcnR5IHtTdHJlYW19IHN0cmVhbSBUaGUgc3RyZWFtIHRvIHdoaWNoIHlvdSBhcmUgc3Vic2NyaWJpbmcuCiAqIEBjbGFzcyBTdWJzY3JpYmVyCiAqIEBhdWdtZW50cyBFdmVudERpc3BhdGNoZXIKICovCk9ULlN1YnNjcmliZXIgPSBmdW5jdGlvbih0YXJnZXRFbGVtZW50LCBvcHRpb25zKSB7CiAgICB2YXIgX3dpZGdldElkID0gT1QuJC51dWlkKCksCiAgICAgICAgX2RvbUlkID0gdGFyZ2V0RWxlbWVudCB8fCBfd2lkZ2V0SWQsCiAgICAgICAgX2NvbnRhaW5lciwKICAgICAgICBfc3RyZWFtQ29udGFpbmVyLAogICAgICAgIF9jaHJvbWUsCiAgICAgICAgX3N0cmVhbSwKICAgICAgICBfZnJvbUNvbm5lY3Rpb25JZCwKICAgICAgICBfcGVlckNvbm5lY3Rpb24sCiAgICAgICAgX3Nlc3Npb24gPSBvcHRpb25zLnNlc3Npb24sCiAgICAgICAgX3N1YnNjcmliZVN0YXJ0VGltZSwKICAgICAgICBfc3RhcnRDb25uZWN0aW5nVGltZSwKICAgICAgICBfcW9zSW50ZXJ2YWwsCiAgICAgICAgX3Byb3BlcnRpZXMgPSBPVC4kLmNsb25lKG9wdGlvbnMpLAogICAgICAgIF9hbmFseXRpY3MgPSBuZXcgT1QuQW5hbHl0aWNzKCksCiAgICAgICAgX2F1ZGlvVm9sdW1lID0gNTAsCiAgICAgICAgX2dldHRpbmdTdGF0cyA9IDAsCiAgICAgICAgX3N0YXRlLAogICAgICAgIF9zdWJzY3JpYmVBdWRpb0ZhbHNlV29ya2Fyb3VuZCwgLy8gT1BFTlRPSy02ODQ0CiAgICAgICAgX3ByZXZTdGF0cyA9IHsKICAgICAgICAgICAgInRpbWVTdGFtcCIgOiBPVC4kLm5vdygpCiAgICAgICAgfTsKCgogICAgaWYgKCFfc2Vzc2lvbikgewogICAgICAgIE9ULmhhbmRsZUpzRXhjZXB0aW9uKCJTdWJzY3JpYmVyIG11c3QgYmUgcGFzc2VkIGEgc2Vzc2lvbiBvcHRpb24iLCAyMDAwLCB7CiAgICAgICAgICAgIHNlc3Npb246IF9zZXNzaW9uLAogICAgICAgICAgICB0YXJnZXQ6IHRoaXMKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIE9ULiQuZXZlbnRpbmcodGhpcyk7CgogICAgT1QuU3R5bGFibGVDb21wb25lbnQodGhpcywgewogICAgICAgIG5hbWVEaXNwbGF5TW9kZTogImF1dG8iLAogICAgICAgIGJ1dHRvbkRpc3BsYXlNb2RlOiAiYXV0byIsCiAgICAgICAgYmFja2dyb3VuZEltYWdlVVJJOiBudWxsCiAgICB9KTsKCiAgICB2YXIgbG9nQW5hbHl0aWNzRXZlbnQgPSBmdW5jdGlvbihhY3Rpb24sIHZhcmlhdGlvbiwgcGF5bG9hZFR5cGUsIHBheWxvYWQpIHsKICAgICAgICAgICAgX2FuYWx5dGljcy5sb2dFdmVudCh7CiAgICAgICAgICAgICAgICBhY3Rpb246IGFjdGlvbiwKICAgICAgICAgICAgICAgIHZhcmlhdGlvbjogdmFyaWF0aW9uLAogICAgICAgICAgICAgICAgcGF5bG9hZF90eXBlOiBwYXlsb2FkVHlwZSwKICAgICAgICAgICAgICAgIHBheWxvYWQ6IHBheWxvYWQsCiAgICAgICAgICAgICAgICBzdHJlYW1faWQ6IF9zdHJlYW0gPyBfc3RyZWFtLmlkIDogbnVsbCwKICAgICAgICAgICAgICAgIHNlc3Npb25faWQ6IF9zZXNzaW9uID8gX3Nlc3Npb24uc2Vzc2lvbklkIDogbnVsbCwKICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25faWQ6IF9zZXNzaW9uICYmIF9zZXNzaW9uLmNvbm5lY3RlZCA/IF9zZXNzaW9uLmNvbm5lY3Rpb24uY29ubmVjdGlvbklkIDogbnVsbCwKICAgICAgICAgICAgICAgIHBhcnRuZXJfaWQ6IF9zZXNzaW9uICYmIF9zZXNzaW9uLmNvbm5lY3RlZCA/IF9zZXNzaW9uLnNlc3Npb25JbmZvLnBhcnRuZXJJZCA6IG51bGwsCiAgICAgICAgICAgICAgICB3aWRnZXRfaWQ6IF93aWRnZXRJZCwKICAgICAgICAgICAgICAgIHdpZGdldF90eXBlOiAnU3Vic2NyaWJlcicKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcmVjb3JkUU9TID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKF9zdGF0ZS5zdWJzY3JpYmluZyAmJiBfc2Vzc2lvbiAmJiBfc2Vzc2lvbi5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgICAgIHZhciBRb1NfYmxvYiA9IHsKICAgICAgICAgICAgICAgICAgICB3aWRnZXRfdHlwZTogJ1N1YnNjcmliZXInLAogICAgICAgICAgICAgICAgICAgIHN0cmVhbV90eXBlIDogJ1dlYlJUQycsCiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbl9pZDogX3Nlc3Npb24gPyBfc2Vzc2lvbi5zZXNzaW9uSWQgOiBudWxsLAogICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25JZDogX3Nlc3Npb24gPyBfc2Vzc2lvbi5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZCA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgbWVkaWFfc2VydmVyX25hbWU6IF9zZXNzaW9uID8gX3Nlc3Npb24uc2Vzc2lvbkluZm8ubWVzc2FnaW5nU2VydmVyIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBwMnBGbGFnOiBfc2Vzc2lvbiA/IF9zZXNzaW9uLnNlc3Npb25JbmZvLnAycEVuYWJsZWQgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBwYXJ0bmVyX2lkOiBfc2Vzc2lvbiA/IF9zZXNzaW9uLmFwaUtleSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgc3RyZWFtX2lkOiBfc3RyZWFtLmlkLAogICAgICAgICAgICAgICAgICAgIHdpZGdldF9pZDogX3dpZGdldElkLAogICAgICAgICAgICAgICAgICAgIHZlcnNpb246IE9ULnByb3BlcnRpZXMudmVyc2lvbiwKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogcGFyc2VJbnQoT1QuJC5ub3coKSAtIF9zdWJzY3JpYmVTdGFydFRpbWUsIDEwKSwKICAgICAgICAgICAgICAgICAgICByZW1vdGVfY29ubmVjdGlvbl9pZDogX3N0cmVhbS5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZAogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgLy8gZ2V0IHN0YXRzIGZvciBlYWNoIGNvbm5lY3Rpb24gaWQKICAgICAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5nZXRTdGF0cyhfcHJldlN0YXRzLCBmdW5jdGlvbihzdGF0cykgewogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0cykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHN0YXRfaW5kZXggaW4gc3RhdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFFvU19ibG9iW3N0YXRfaW5kZXhdID0gc3RhdHNbc3RhdF9pbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX2FuYWx5dGljcy5sb2dRT1MoUW9TX2Jsb2IpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzdGF0ZUNoYW5nZUZhaWxlZCA9IGZ1bmN0aW9uKGNoYW5nZUZhaWxlZCkgewogICAgICAgICAgICBPVC5lcnJvcigiU3Vic2NyaWJlciBTdGF0ZSBDaGFuZ2UgRmFpbGVkOiAiLCBjaGFuZ2VGYWlsZWQubWVzc2FnZSk7CiAgICAgICAgICAgIE9ULmRlYnVnKGNoYW5nZUZhaWxlZCk7CiAgICAgICAgfSwKCiAgICAgICAgb25Mb2FkZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKF9zdGF0ZS5zdWJzY3JpYmluZyB8fCAhX3N0cmVhbUNvbnRhaW5lcikgcmV0dXJuOwoKICAgICAgICAgICAgT1QuZGVidWcoIk9ULlN1YnNjcmliZXIub25Mb2FkZWQiKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ1N1YnNjcmliaW5nJyk7CiAgICAgICAgICAgIF9zdWJzY3JpYmVTdGFydFRpbWUgPSBPVC4kLm5vdygpOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2NyZWF0ZVBlZXJDb25uZWN0aW9uJywgJ1N1Y2Nlc3MnLCAncGNjfGhhc1JlbGF5Q2FuZGlkYXRlcycsIFsKICAgICAgICAgICAgICAgIHBhcnNlSW50KF9zdWJzY3JpYmVTdGFydFRpbWUgLSBfc3RhcnRDb25uZWN0aW5nVGltZSwgMTApLAogICAgICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uICYmIF9wZWVyQ29ubmVjdGlvbi5oYXNSZWxheUNhbmRpZGF0ZXMKICAgICAgICAgICAgXS5qb2luKCd8JykpOwoKICAgICAgICAgICAgX3Fvc0ludGVydmFsID0gc2V0SW50ZXJ2YWwocmVjb3JkUU9TLCAzMDAwMCk7CgogICAgICAgICAgICBpZihfc3Vic2NyaWJlQXVkaW9GYWxzZVdvcmthcm91bmQpIHsKICAgICAgICAgICAgICAgIF9zdWJzY3JpYmVBdWRpb0ZhbHNlV29ya2Fyb3VuZCA9IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLnN1YnNjcmliZVRvVmlkZW8oZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfY29udGFpbmVyLmxvYWRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIF9jcmVhdGVDaHJvbWUuY2FsbCh0aGlzKTsKCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc3Vic2NyaWJlU3VjY2VzcycsIHRoaXMpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2xvYWRlZCcsIHRoaXMpOwoKCiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdzdWJzY3JpYmUnLCAnU3VjY2VzcycsICdzdHJlYW1JZCcsIF9zdHJlYW0uaWQpOwogICAgICAgIH0sCgogICAgICAgIG9uRGlzY29ubmVjdGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIE9ULmRlYnVnKCJPVC5TdWJzY3JpYmVyIGhhcyBiZWVuIGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBQdWJsaXNoZXIncyBQZWVyQ29ubmVjdGlvbiIpOwoKICAgICAgICAgICAgaWYgKF9zdGF0ZS5hdHRlbXB0aW5nVG9TdWJzY3JpYmUpIHsKICAgICAgICAgICAgICAgIC8vIHN1YnNjcmliaW5nIGVycm9yCiAgICAgICAgICAgICAgICBfc3RhdGUuc2V0KCdGYWlsZWQnKTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc3Vic2NyaWJlRXJyb3InLCAiQ2xpZW50RGlzY29ubmVjdGVkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoX3N0YXRlLnN1YnNjcmliaW5nKSB7CiAgICAgICAgICAgICAgICBfc3RhdGUuc2V0KCdGYWlsZWQnKTsKCiAgICAgICAgICAgICAgICAvLyB3ZSB3ZXJlIGRpc2Nvbm5lY3RlZCBhZnRlciB3ZSB3ZXJlIGFscmVhZHkgc3Vic2NyaWJpbmcKICAgICAgICAgICAgICAgIC8vIHByb2JhYmx5IGRvIG5vdGhpbmc/CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpOwogICAgICAgIH0sCgoKICAgICAgICBvblBlZXJDb25uZWN0aW9uRmFpbHVyZSA9IGZ1bmN0aW9uKGNvZGUsIHJlYXNvbikgewogICAgICAgICAgICBpZiAoX3N0YXRlLmF0dGVtcHRpbmdUb1N1YnNjcmliZSkgewogICAgICAgICAgICAgICAgLy8gV2Ugd2VyZW4ndCBzdWJzY3JpYmluZyB5ZXQgc28gdGhpcyB3YXMgYSBmYWlsdXJlIGluIHNldHRpbmcKICAgICAgICAgICAgICAgIC8vIHVwIHRoZSBQZWVyQ29ubmVjdGlvbiBvciByZWNlaXZpbmcgdGhlIGluaXRpYWwgc3RyZWFtLgogICAgICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2NyZWF0ZVBlZXJDb25uZWN0aW9uJywgJ0ZhaWx1cmUnLCAncmVhc29ufGhhc1JlbGF5Q2FuZGlkYXRlcycsIFsKICAgICAgICAgICAgICAgICAgICAiU3Vic2NyaWJlciBQZWVyQ29ubmVjdGlvbiBFcnJvcjogIiArIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24gJiYgX3BlZXJDb25uZWN0aW9uLmhhc1JlbGF5Q2FuZGlkYXRlcwogICAgICAgICAgICAgICAgXS5qb2luKCd8JykpOwoKICAgICAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdWJzY3JpYmVFcnJvcicsIHJlYXNvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoX3N0YXRlLnN1YnNjcmliaW5nKSB7CiAgICAgICAgICAgICAgICAvLyB3ZSB3ZXJlIGRpc2Nvbm5lY3RlZCBhZnRlciB3ZSB3ZXJlIGFscmVhZHkgc3Vic2NyaWJpbmcKICAgICAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0ZhaWxlZCcpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIHJlYXNvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3N1YnNjcmliZScsICdGYWlsdXJlJywgJ3JlYXNvbicsICJTdWJzY3JpYmVyIFBlZXJDb25uZWN0aW9uIEVycm9yOiAiICsgcmVhc29uKTsKCiAgICAgICAgICAgIE9ULmhhbmRsZUpzRXhjZXB0aW9uKCJTdWJzY3JpYmVyIFBlZXJDb25uZWN0aW9uIEVycm9yOiAiICsgcmVhc29uLCBPVC5FeGNlcHRpb25Db2Rlcy5QMlBfQ09OTkVDVElPTl9GQUlMRUQsIHsKICAgICAgICAgICAgICAgIHNlc3Npb246IF9zZXNzaW9uLAogICAgICAgICAgICAgICAgdGFyZ2V0OiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBfc2hvd0Vycm9yLmNhbGwodGhpcywgcmVhc29uKTsKICAgICAgICB9LAoKICAgICAgICBvblJlbW90ZVN0cmVhbUFkZGVkID0gZnVuY3Rpb24od2ViT1RTdHJlYW0pIHsKICAgICAgICAgICAgT1QuZGVidWcoIk9ULlN1YnNjcmliZXIub25SZW1vdGVTdHJlYW1BZGRlZCIpOwoKICAgICAgICAgICAgX3N0YXRlLnNldCgnQmluZGluZ1JlbW90ZVN0cmVhbScpOwoKICAgICAgICAgICAgLy8gRGlzYWJsZSB0aGUgYXVkaW8vdmlkZW8sIGlmIG5lZWRlZAogICAgICAgICAgICB0aGlzLnN1YnNjcmliZVRvQXVkaW8oX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9BdWRpbyk7CgogICAgICAgICAgICB2YXIgcHJlc2VydmVyID0gX3N1YnNjcmliZUF1ZGlvRmFsc2VXb3JrYXJvdW5kOwogICAgICAgICAgICB0aGlzLnN1YnNjcmliZVRvVmlkZW8oX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9WaWRlbyk7CiAgICAgICAgICAgIF9zdWJzY3JpYmVBdWRpb0ZhbHNlV29ya2Fyb3VuZCA9IHByZXNlcnZlcjsKCiAgICAgICAgICAgIHZhciBzdHJlYW1FbGVtZW50ID0gbmV3IE9ULlZpZGVvRWxlbWVudCgpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgYXVkaW8gdm9sdW1lCiAgICAgICAgICAgIHN0cmVhbUVsZW1lbnQuc2V0QXVkaW9Wb2x1bWUoX2F1ZGlvVm9sdW1lKTsKICAgICAgICAgICAgc3RyZWFtRWxlbWVudC5vbih7CiAgICAgICAgICAgICAgICAgICAgc3RyZWFtQm91bmQ6IG9uTG9hZGVkLAogICAgICAgICAgICAgICAgICAgIGxvYWRFcnJvcjogb25QZWVyQ29ubmVjdGlvbkZhaWx1cmUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IG9uUGVlckNvbm5lY3Rpb25GYWlsdXJlCiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgICAgIHN0cmVhbUVsZW1lbnQuYmluZFRvU3RyZWFtKHdlYk9UU3RyZWFtKTsKICAgICAgICAgICAgIF9jb250YWluZXIudmlkZW8gPSBzdHJlYW1FbGVtZW50OwoKICAgICAgICAgICAgX3N0cmVhbUNvbnRhaW5lciA9IHN0cmVhbUVsZW1lbnQ7CgogICAgICAgICAgICBfc3RyZWFtQ29udGFpbmVyLm9yaWVudGF0aW9uID0gewogICAgICAgICAgICAgICAgd2lkdGg6IF9zdHJlYW0udmlkZW9EaW1lbnNpb25zLndpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBfc3RyZWFtLnZpZGVvRGltZW5zaW9ucy5oZWlnaHQsCiAgICAgICAgICAgICAgICB2aWRlb09yaWVudGF0aW9uOiBfc3RyZWFtLnZpZGVvRGltZW5zaW9ucy5vcmllbnRhdGlvbgogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2NyZWF0ZVBlZXJDb25uZWN0aW9uJywgJ1N0cmVhbUFkZGVkJywgJycsICcnKTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdHJlYW1BZGRlZCcsIHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIG9uUmVtb3RlU3RyZWFtUmVtb3ZlZCA9IGZ1bmN0aW9uKHdlYk9UU3RyZWFtKSB7CiAgICAgICAgICAgIE9ULmRlYnVnKCJPVC5TdWJzY3JpYmVyLm9uU3RyZWFtUmVtb3ZlZCIpOwoKICAgICAgICAgICAgaWYgKF9zdHJlYW1Db250YWluZXIuc3RyZWFtID09IHdlYk9UU3RyZWFtKSB7CiAgICAgICAgICAgICAgICBfc3RyZWFtQ29udGFpbmVyLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIF9zdHJlYW1Db250YWluZXIgPSBudWxsOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdHJlYW1SZW1vdmVkJywgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtVXBkYXRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHN3aXRjaChldmVudC5jaGFuZ2VkUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ29yaWVudGF0aW9uJzoKICAgICAgICAgICAgICAgICAgICBfc3RyZWFtQ29udGFpbmVyLm9yaWVudGF0aW9uID0gewogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogX3N0cmVhbS52aWRlb0RpbWVuc2lvbnMud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogX3N0cmVhbS52aWRlb0RpbWVuc2lvbnMuaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICB2aWRlb09yaWVudGF0aW9uOiBfc3RyZWFtLnZpZGVvRGltZW5zaW9ucy5vcmllbnRhdGlvbgogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnaGFzVmlkZW8nOgogICAgICAgICAgICAgICAgICAgIGlmKF9jb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRhaW5lci5zaG93UG9zdGVyID0gIShfc3RyZWFtLmhhc1ZpZGVvICYmIF9wcm9wZXJ0aWVzLnN1YnNjcmliZVRvVmlkZW8pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnaGFzQXVkaW8nOgogICAgICAgICAgICAgICAgICAgIC8vIG5vb3AKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vLyBDaHJvbWUKCiAgICAgICAgdXBkYXRlQ2hyb21lRm9yU3R5bGVDaGFuZ2UgPSBmdW5jdGlvbihrZXksIHZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBpZiAoIV9jaHJvbWUpIHJldHVybjsKCiAgICAgICAgICAgIHN3aXRjaChrZXkpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ25hbWVEaXNwbGF5TW9kZSc6CiAgICAgICAgICAgICAgICAgICAgX2Nocm9tZS5uYW1lLnNldERpc3BsYXlNb2RlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICdidXR0b25EaXNwbGF5TW9kZSc6CiAgICAgICAgICAgICAgICAgICAgLy8gX2Nocm9tZS5tdXRlQnV0dG9uLnNldERpc3BsYXlNb2RlKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9jcmVhdGVDaHJvbWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX2Nocm9tZSA9IG5ldyBPVC5DaHJvbWUoewogICAgICAgICAgICAgICAgcGFyZW50OiBfY29udGFpbmVyLmRvbUVsZW1lbnQKICAgICAgICAgICAgfSkuc2V0KHsKICAgICAgICAgICAgICAgIG5hbWU6IG5ldyBPVC5DaHJvbWUuTmFtZVBhbmVsKHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiBfcHJvcGVydGllcy5uYW1lLAogICAgICAgICAgICAgICAgICAgIG1vZGU6IHRoaXMuZ2V0U3R5bGUoJ25hbWVEaXNwbGF5TW9kZScpCiAgICAgICAgICAgICAgICB9KSwKCiAgICAgICAgICAgICAgICAvLyAvLyBEaXNhYmxlZCB1bnRpbCB3ZSBjYW4gY2hhbmdlIHRoZSBtaWMgVm9sdW1lIHRocm91Z2ggV2ViUlRDCiAgICAgICAgICAgICAgICAvLyBtdXRlQnV0dG9uOiBuZXcgT1QuQ2hyb21lLk1pY1ZvbHVtZSh7CiAgICAgICAgICAgICAgICAvLyAgICAgbXV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgLy8gICAgIG1vZGU6IHRoaXMuZ2V0U3R5bGUoJ2J1dHRvbkRpc3BsYXlNb2RlJykKICAgICAgICAgICAgICAgIC8vIH0pLAoKICAgICAgICAgICAgICAgIG9wZW50b2tCdXR0b246IG5ldyBPVC5DaHJvbWUuT3BlblRva0J1dHRvbigpCiAgICAgICAgICAgIH0pLm9uKHsKICAgICAgICAgICAgICAgIG11dGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBAdG9kbyB0dXJuIG9mZiBhdWRpbyBvbiB0aGUgd2ViIHJ0YyBzdHJlYW0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgdW5tdXRlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQHRvZG8gdHVybiBvbiBhdWRpbyBvbiB0aGUgd2ViIHJ0YyBzdHJlYW0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgX3Nob3dFcnJvciA9IGZ1bmN0aW9uKGVycm9yTXNnKSB7CiAgICAgICAgICAgIC8vIERpc3BsYXkgdGhlIGVycm9yIG1lc3NhZ2UgaW5zaWRlIHRoZSBjb250YWluZXIsIGFzc3VtaW5nIGl0J3MKICAgICAgICAgICAgLy8gYmVlbiBjcmVhdGVkIGJ5IG5vdy4KICAgICAgICAgICAgaWYgKF9jb250YWluZXIpIF9jb250YWluZXIuYWRkRXJyb3IoZXJyb3JNc2cpOwogICAgICAgIH07CgoKICAgIHRoaXMucmVjb3JkUU9TID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmVjb3JkUU9TKCk7CiAgICB9OwoKICAgIHRoaXMuc3Vic2NyaWJlID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgT1QuZGVidWcoIk9ULlN1YnNjcmliZXI6IHN1YnNjcmliZSB0byAiICsgc3RyZWFtLmlkKTsKCiAgICAgICAgaWYgKF9zdGF0ZS5zdWJzY3JpYmluZykgewogICAgICAgICAgICAvLyBAdG9kbyBlcnJvcgogICAgICAgICAgICBPVC5lcnJvcigiT1QuU3Vic2NyaWJlci5TdWJzY3JpYmU6IENhbm5vdCBzdWJzY3JpYmUsIGFscmVhZHkgc3Vic2NyaWJpbmcuIik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZS5zZXQoJ0luaXQnKTsKCiAgICAgICAgaWYgKCFzdHJlYW0pIHsKICAgICAgICAgICAgLy8gQHRvZG8gZXJyb3IKICAgICAgICAgICAgT1QuZXJyb3IoIk9ULlN1YnNjcmliZXI6IE5vIHN0cmVhbSBwYXJhbWV0ZXIuIik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmIChfc3RyZWFtKSB7CiAgICAgICAgICAgIC8vIEB0b2RvIGVycm9yCiAgICAgICAgICAgIE9ULmVycm9yKCJPVC5TdWJzY3JpYmVyOiBBbHJlYWR5IHN1YnNjcmliZWQiKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX3N0cmVhbSA9IHN0cmVhbTsKICAgICAgICBfc3RyZWFtLm9uKHsKICAgICAgICAgICAgdXBkYXRlZDogc3RyZWFtVXBkYXRlZCwKICAgICAgICAgICAgZGVzdHJveWVkOiB0aGlzLmRpc2Nvbm5lY3QKICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgX2Zyb21Db25uZWN0aW9uSWQgPSBzdHJlYW0uY29ubmVjdGlvbi5jb25uZWN0aW9uSWQ7CiAgICAgICAgX3Byb3BlcnRpZXMubmFtZSA9IF9zdHJlYW0ubmFtZTsKICAgICAgICBfcHJvcGVydGllcy5jbGFzc05hbWVzID0gJ09UX3Jvb3QgT1Rfc3Vic2NyaWJlcic7CgogICAgICAgIGlmIChfcHJvcGVydGllcy5zdHlsZSkgewogICAgICAgICAgICB0aGlzLnNldFN0eWxlKF9wcm9wZXJ0aWVzLnN0eWxlLCBudWxsLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKF9wcm9wZXJ0aWVzLmF1ZGlvVm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXVkaW9Wb2x1bWUoX3Byb3BlcnRpZXMuYXVkaW9Wb2x1bWUpOwogICAgICAgIH0KCiAgICAgICAgX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9BdWRpbyA9IE9ULiQuY2FzdFRvQm9vbGVhbihfcHJvcGVydGllcy5zdWJzY3JpYmVUb0F1ZGlvLCB0cnVlKTsKICAgICAgICBfcHJvcGVydGllcy5zdWJzY3JpYmVUb1ZpZGVvID0gT1QuJC5jYXN0VG9Cb29sZWFuKF9wcm9wZXJ0aWVzLnN1YnNjcmliZVRvVmlkZW8sIHRydWUpOwoKICAgICAgICBfY29udGFpbmVyID0gbmV3IE9ULldpZGdldFZpZXcodGFyZ2V0RWxlbWVudCwgX3Byb3BlcnRpZXMpOwogICAgICAgIF9kb21JZCA9IF9jb250YWluZXIuZG9tSWQ7CgogICAgICAgIGlmKCFfcHJvcGVydGllcy5zdWJzY3JpYmVUb1ZpZGVvICYmIE9ULiQuYnJvd3NlcigpID09ICdDaHJvbWUnKSB7CiAgICAgICAgICAgIF9zdWJzY3JpYmVBdWRpb0ZhbHNlV29ya2Fyb3VuZCA9IHRydWU7CiAgICAgICAgICAgIF9wcm9wZXJ0aWVzLnN1YnNjcmliZVRvVmlkZW8gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgX3N0YXJ0Q29ubmVjdGluZ1RpbWUgPSBPVC4kLm5vdygpOwoKICAgICAgICBpZiAoX3N0cmVhbS5jb25uZWN0aW9uLmlkICE9PSBfc2Vzc2lvbi5jb25uZWN0aW9uLmlkKSB7CiAgICAgICAgICAgIGxvZ0FuYWx5dGljc0V2ZW50KCdjcmVhdGVQZWVyQ29ubmVjdGlvbicsICdBdHRlbXB0JywgJycsICcnKTsKCiAgICAgICAgICAgIF9zdGF0ZS5zZXQoJ0Nvbm5lY3RpbmdUb1BlZXInKTsKCiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbiA9IG5ldyBPVC5TdWJzY3JpYmVyUGVlckNvbm5lY3Rpb24oX3N0cmVhbS5jb25uZWN0aW9uLCBfc2Vzc2lvbiwgX3N0cmVhbSwgX3Byb3BlcnRpZXMpOwoKICAgICAgICAgICAgX3BlZXJDb25uZWN0aW9uLm9uKHsKICAgICAgICAgICAgICAgIGRpc2Nvbm5lY3RlZDogb25EaXNjb25uZWN0ZWQsCiAgICAgICAgICAgICAgICBlcnJvcjogb25QZWVyQ29ubmVjdGlvbkZhaWx1cmUsCiAgICAgICAgICAgICAgICByZW1vdGVTdHJlYW1BZGRlZDogb25SZW1vdGVTdHJlYW1BZGRlZCwKICAgICAgICAgICAgICAgIHJlbW90ZVN0cmVhbVJlbW92ZWQ6IG9uUmVtb3RlU3RyZWFtUmVtb3ZlZAogICAgICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgICAgIC8vIGluaXRpYWxpemUgdGhlIHBlZXIgY29ubmVjdGlvbiBBRlRFUiB3ZSd2ZSBhZGRlZCB0aGUgZXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5pbml0KCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBsb2dBbmFseXRpY3NFdmVudCgnY3JlYXRlUGVlckNvbm5lY3Rpb24nLCAnQXR0ZW1wdCcsICcnLCAnJyk7CgogICAgICAgICAgICAvLyBTdWJzY3JpYmUgdG8geW91cnNlbGYgZWRnZS1jYXNlCiAgICAgICAgICAgIG9uUmVtb3RlU3RyZWFtQWRkZWQuY2FsbCh0aGlzLCBfc2Vzc2lvbi5nZXRQdWJsaXNoZXJGb3JTdHJlYW0oX3N0cmVhbSkuXy53ZWJSdGNTdHJlYW0pOwogICAgICAgIH0KCiAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ3N1YnNjcmliZScsICdBdHRlbXB0JywgJ3N0cmVhbUlkJywgX3N0cmVhbS5pZCk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbigvKiB1bnVzZWQgKi8gcmVhc29uLCBxdWlldCkgewogICAgICAgIGNsZWFySW50ZXJ2YWwoX3Fvc0ludGVydmFsKTsKICAgICAgICBfcW9zSW50ZXJ2YWwgPSBudWxsOwoKICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoKTsKCiAgICAgICAgaWYgKF9jaHJvbWUpIHsKICAgICAgICAgICAgX2Nocm9tZS5kZXN0cm95KCk7CiAgICAgICAgICAgIF9jaHJvbWUgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9jb250YWluZXIpIHsKICAgICAgICAgICAgX2NvbnRhaW5lci5kZXN0cm95KCk7CiAgICAgICAgICAgIF9jb250YWluZXIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9zdHJlYW0gJiYgIV9zdHJlYW0uZGVzdHJveWVkKSBsb2dBbmFseXRpY3NFdmVudCgndW5zdWJzY3JpYmUnLCBudWxsLCAnc3RyZWFtSWQnLCBfc3RyZWFtLmlkKTsKCiAgICAgICAgX2RvbUlkID0gbnVsbDsKICAgICAgICBfc3RyZWFtID0gbnVsbDsKCiAgICAgICAgX3Nlc3Npb24gPSBudWxsOwogICAgICAgIF9wcm9wZXJ0aWVzID0gbnVsbDsKCiAgICAgICAgaWYgKHF1aWV0ICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCgKICAgICAgICAgICAgICBuZXcgT1QuRGVzdHJveWVkRXZlbnQoCiAgICAgICAgICAgICAgICBPVC5FdmVudC5uYW1lcy5TVUJTQ1JJQkVSX0RFU1RST1lFRCwKICAgICAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgICAgICByZWFzb24KICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIHRoaXMub2ZmLmJpbmQodGhpcykKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgdGhpcy5kaXNjb25uZWN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgX3N0YXRlLnNldCgnTm90U3Vic2NyaWJpbmcnKTsKCiAgICAgICAgaWYgKF9zdHJlYW1Db250YWluZXIpIHsKICAgICAgICAgICAgX3N0cmVhbUNvbnRhaW5lci5kZXN0cm95KCk7CiAgICAgICAgICAgIF9zdHJlYW1Db250YWluZXIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24uZGVzdHJveSgpOwogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24gPSBudWxsOwoKICAgICAgICAgICAgbG9nQW5hbHl0aWNzRXZlbnQoJ2Rpc2Nvbm5lY3QnLCAnUGVlckNvbm5lY3Rpb24nLCAnc3RyZWFtSWQnLCBfc3RyZWFtLmlkKTsKICAgICAgICB9CiAgICB9OwoKICAgIHRoaXMucHJvY2Vzc01lc3NhZ2UgPSBmdW5jdGlvbih0eXBlLCBmcm9tQ29ubmVjdGlvbiwgbWVzc2FnZSkgewogICAgICAgIE9ULmRlYnVnKCJPVC5TdWJzY3JpYmVyLnByb2Nlc3NNZXNzYWdlOiBSZWNlaXZlZCAiICsgdHlwZSArICIgbWVzc2FnZSBmcm9tICIgKyBmcm9tQ29ubmVjdGlvbi5pZCk7CiAgICAgICAgT1QuZGVidWcobWVzc2FnZSk7CgogICAgICAgIGlmIChfZnJvbUNvbm5lY3Rpb25JZCAhPSBmcm9tQ29ubmVjdGlvbi5pZCkgewogICAgICAgICAgICBfZnJvbUNvbm5lY3Rpb25JZCA9IGZyb21Db25uZWN0aW9uLmlkOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgX3BlZXJDb25uZWN0aW9uLnByb2Nlc3NNZXNzYWdlKHR5cGUsIG1lc3NhZ2UpOwogICAgICAgIH0KICAgIH07CgogICAgdGhpcy51cGRhdGVRdWFsaXR5ID0gZnVuY3Rpb24ocXVhbGl0eSkgewogICAgICAgIC8vIEN1cnJlbnRseSwgdGhpcyBvbmx5IGRpc2FibGVzIHRoZSB2aWRlbyBhbmQgZGlzcmVnYXJkcwogICAgICAgIC8vIHRoZSBxdWFsaXR5LgogICAgICAgIHRoaXMuc3Vic2NyaWJlVG9WaWRlbyhmYWxzZSk7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBPVC5FdmVudCgidmlkZW9EaXNhYmxlZCIpKTsKICAgIH07CgogICAgLyoqCiAgICAqIFJldHVybiB0aGUgYmFzZS02NC1lbmNvZGVkIHN0cmluZyBvZiBQTkcgZGF0YSByZXByZXNlbnRpbmcgdGhlIFN1YnNjcmliZXIgdmlkZW8uCiAgICAqCiAgICAqICA8cD5Zb3UgY2FuIHVzZSB0aGUgc3RyaW5nIGFzIHRoZSB2YWx1ZSBmb3IgYSBkYXRhIFVSTCBzY2hlbWUgcGFzc2VkIHRvIHRoZSBzcmMgcGFyYW1ldGVyIG9mCiAgICAqICBhbiBpbWFnZSBmaWxlLCBhcyBpbiB0aGUgZm9sbG93aW5nOjwvcD4KICAgICoKICAgICogIDxwcmU+CiAgICAqICB2YXIgaW1nRGF0YSA9IHN1YnNjcmliZXIuZ2V0SW1nRGF0YSgpOwogICAgKgogICAgKiAgdmFyIGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgKiAgaW1nLnNldEF0dHJpYnV0ZSgic3JjIiwgImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCwiICsgaW1nRGF0YSk7CiAgICAqICB2YXIgaW1nV2luID0gd2luZG93Lm9wZW4oImFib3V0OmJsYW5rIiwgIlNjcmVlbnNob3QiKTsKICAgICogIGltZ1dpbi5kb2N1bWVudC53cml0ZSgiJmx0O2JvZHkmZ3Q7Jmx0Oy9ib2R5Jmd0OyIpOwogICAgKiAgaW1nV2luLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICogIDwvcHJlPgogICAgKiBAbWV0aG9kICNnZXRJbWdEYXRhCiAgICAqIEBtZW1iZXJPZiBTdWJzY3JpYmVyCiAgICAqIEByZXR1cm4ge1N0cmluZ30gVGhlIGJhc2UtNjQgZW5jb2RlZCBzdHJpbmcuIFJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGlmIHRoZXJlIGlzIG5vIHZpZGVvLgogICAgKi8KICAgIHRoaXMuZ2V0SW1nRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5zdWJzY3JpYmluZykgewogICAgICAgICAgICBPVC5lcnJvcigiT1QuU3Vic2NyaWJlci5nZXRJbWdEYXRhOiBDYW5ub3QgZ2V0SW1nRGF0YSBiZWZvcmUgdGhlIFN1YnNjcmliZXIgaXMgc3Vic2NyaWJpbmcuIik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIF9zdHJlYW1Db250YWluZXIuaW1nRGF0YTsKICAgIH07CgogICAgLyoqCiAgICAqIFNldHMgdGhlIGF1ZGlvIHZvbHVtZSwgYmV0d2VlbiAwIGFuZCAxMDAsIG9mIHRoZSBTdWJzY3JpYmVyLgogICAgKgogICAgKiA8cD5Zb3UgY2FuIHNldCB0aGUgaW5pdGlhbCB2b2x1bWUgd2hlbiB5b3UgY2FsbCB0aGUgPGNvZGU+U2Vzc2lvbi5zdWJzY3JpYmUoKTwvY29kZT4KICAgICogbWV0aG9kLiBQYXNzIGEgPGNvZGU+YXVkaW9Wb2x1bWU8L2NvZGU+IHByb3BlcnR5IG9mIHRoZSA8Y29kZT5wcm9wZXJ0aWVzPC9jb2RlPiBwYXJhbWV0ZXIKICAgICogb2YgdGhlIG1ldGhvZC48L3A+CiAgICAqCiAgICAqIEBwYXJhbSB7TnVtYmVyfSB2YWx1ZSBUaGUgYXVkaW8gdm9sdW1lLCBiZXR3ZWVuIDAgYW5kIDEwMC4KICAgICoKICAgICogQHJldHVybiB7U3Vic2NyaWJlcn0gVGhlIFN1YnNjcmliZXIgb2JqZWN0LiBUaGlzIGxldHMgeW91IGNoYWluIG1ldGhvZCBjYWxscywgYXMgaW4gdGhlIGZvbGxvd2luZzoKICAgICoKICAgICogPHByZT5teVN1YnNjcmliZXIuc2V0QXVkaW9Wb2x1bWUoNTApLnNldFN0eWxlKG5ld1N0eWxlKTs8L3ByZT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSIjZ2V0QXVkaW9Wb2x1bWUiPmdldEF1ZGlvVm9sdW1lKCk8L2E+CiAgICAqIEBzZWUgPGEgaHJlZj0iU2Vzc2lvbi5odG1sI3N1YnNjcmliZSI+U2Vzc2lvbi5zdWJzY3JpYmUoKTwvYT4KICAgICogQG1ldGhvZCAjc2V0QXVkaW9Wb2x1bWUKICAgICogQG1lbWJlck9mIFN1YnNjcmliZXIKICAgICovCiAgICB0aGlzLnNldEF1ZGlvVm9sdW1lID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YWx1ZSA9IHBhcnNlSW50KHZhbHVlLCAxMCk7CiAgICAgICAgaWYgKGlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICBPVC5lcnJvcigiT1QuU3Vic2NyaWJlci5zZXRBdWRpb1ZvbHVtZTogdmFsdWUgc2hvdWxkIGJlIGFuIGludGVnZXIgYmV0d2VlbiAwIGFuZCAxMDAiKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIF9hdWRpb1ZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgdmFsdWUpKTsKICAgICAgICBpZiAoX2F1ZGlvVm9sdW1lICE9IHZhbHVlKSB7CiAgICAgICAgICAgIE9ULndhcm4oIk9ULlN1YnNjcmliZXIuc2V0QXVkaW9Wb2x1bWU6IHZhbHVlIHNob3VsZCBiZSBhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgMTAwIik7CiAgICAgICAgfQogICAgICAgIGlmIChfc3RyZWFtQ29udGFpbmVyKSB7CiAgICAgICAgICAgIF9zdHJlYW1Db250YWluZXIuc2V0QXVkaW9Wb2x1bWUoX2F1ZGlvVm9sdW1lKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgYXVkaW8gdm9sdW1lLCBiZXR3ZWVuIDAgYW5kIDEwMCwgb2YgdGhlIFN1YnNjcmliZXIuCiAgICAqCiAgICAqIDxwPkdlbmVyYWxseSB5b3UgdXNlIHRoaXMgbWV0aG9kIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIDxjb2RlPnNldEF1ZGlvVm9sdW1lKCk8L2NvZGU+IG1ldGhvZC48L3A+CiAgICAqCiAgICAqIEByZXR1cm4ge051bWJlcn0gVGhlIGF1ZGlvIHZvbHVtZSwgYmV0d2VlbiAwIGFuZCAxMDAsIG9mIHRoZSBTdWJzY3JpYmVyLgogICAgKiBAc2VlIDxhIGhyZWY9IiNzZXRBdWRpb1ZvbHVtZSI+c2V0QXVkaW9Wb2x1bWUoKTwvYT4KICAgICogQG1ldGhvZCAjZ2V0QXVkaW9Wb2x1bWUKICAgICogQG1lbWJlck9mIFN1YnNjcmliZXIKICAgICovCiAgICB0aGlzLmdldEF1ZGlvVm9sdW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKF9zdHJlYW1Db250YWluZXIpIHJldHVybiBfc3RyZWFtQ29udGFpbmVyLmdldEF1ZGlvVm9sdW1lKCk7CiAgICAgICAgZWxzZSByZXR1cm4gX2F1ZGlvVm9sdW1lOwogICAgfTsKCiAgICAvKioKICAgICogVG9nZ2xlcyBhdWRpbyBvbiBhbmQgb2ZmLiBTdGFydHMgc3Vic2NyaWJpbmcgdG8gYXVkaW8gKGlmIGl0IGlzIGF2YWlsYWJsZSBhbmQgY3VycmVudGx5IG5vdCBiZWluZwogICAgKiBzdWJzY3JpYmVkIHRvKSB3aGVuIHRoZSA8Y29kZT52YWx1ZTwvY29kZT4gaXMgPGNvZGU+dHJ1ZTwvY29kZT47IHN0b3BzIHN1YnNjcmliaW5nIHRvIGF1ZGlvCiAgICAqIChpZiBpdCBpcyBjdXJyZW50bHkgYmVpbmcgc3Vic2NyaWJlZCB0bykgd2hlbiB0aGUgPGNvZGU+dmFsdWU8L2NvZGU+IGlzIDxjb2RlPmZhbHNlPC9jb2RlPi4KICAgICogPHA+CiAgICAqIDxpPk5vdGU6PC9pPiBUaGlzIG1ldGhvZCBvbmx5IGFmZmVjdHMgdGhlIGxvY2FsIHBsYXliYWNrIG9mIGF1ZGlvLiBJdCBoYXMgbm8gaW1wYWN0IG9uIHRoZSBhdWRpbwogICAgKiBmb3Igb3RoZXIgY29ubmVjdGlvbnMgc3Vic2NyaWJpbmcgdG8gdGhlIHNhbWUgc3RyZWFtLiBJZiB0aGUgUHVibHNoZXIgaXMgbm90IHB1Ymxpc2hpbmcgYXVkaW8sCiAgICAqIGVuYWJsaW5nIHRoZSBTdWJzY3JpYmVyIGF1ZGlvIHdpbGwgaGF2ZSBubyBwcmFjdGljYWwgZWZmZWN0LgogICAgKiA8L3A+CiAgICAqCiAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gdmFsdWUgV2hldGhlciB0byBzdGFydCBzdWJzY3JpYmluZyB0byBhdWRpbyAoPGNvZGU+dHJ1ZTwvY29kZT4pIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4KICAgICoKICAgICogQHJldHVybiB7U3Vic2NyaWJlcn0gVGhlIFN1YnNjcmliZXIgb2JqZWN0LiBUaGlzIGxldHMgeW91IGNoYWluIG1ldGhvZCBjYWxscywgYXMgaW4gdGhlIGZvbGxvd2luZzoKICAgICoKICAgICogPHByZT5teVN1YnNjcmliZXIuc3Vic2NyaWJlVG9BdWRpbyh0cnVlKS5zdWJzY3JpYmVUb1ZpZGVvKGZhbHNlKTs8L3ByZT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSIjc3Vic2NyaWJlVG9WaWRlbyI+c3Vic2NyaWJlVG9WaWRlbygpPC9hPgogICAgKiBAc2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNzdWJzY3JpYmUiPlNlc3Npb24uc3Vic2NyaWJlKCk8L2E+CiAgICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQuaHRtbCI+U3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQ8L2E+CiAgICAqCiAgICAqIEBtZXRob2QgI3N1YnNjcmliZVRvQXVkaW8KICAgICogQG1lbWJlck9mIFN1YnNjcmliZXIKICAgICovCiAgICB0aGlzLnN1YnNjcmliZVRvQXVkaW8gPSBmdW5jdGlvbihwX3ZhbHVlKSB7CiAgICAgICAgdmFyIHZhbHVlID0gT1QuJC5jYXN0VG9Cb29sZWFuKHBfdmFsdWUsIHRydWUpOwoKICAgICAgICBpZiAoX3BlZXJDb25uZWN0aW9uKSB7CiAgICAgICAgICAgIF9wZWVyQ29ubmVjdGlvbi5zdWJzY3JpYmVUb0F1ZGlvKHZhbHVlKTsKCiAgICAgICAgICAgIGlmIChfc2Vzc2lvbiAmJiBfc3RyZWFtICYmIHZhbHVlICE9PSBfcHJvcGVydGllcy5zdWJzY3JpYmVUb0F1ZGlvKSB7CiAgICAgICAgICAgICAgICBfc2Vzc2lvbi5fLm1vZGlmeVN1YnNjcmliZXIodGhpcywgImhhc0F1ZGlvIiwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfcHJvcGVydGllcy5zdWJzY3JpYmVUb0F1ZGlvID0gdmFsdWU7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgLyoqCiAgICAqIFRvZ2dsZXMgdmlkZW8gb24gYW5kIG9mZi4gU3RhcnRzIHN1YnNjcmliaW5nIHRvIHZpZGVvIChpZiBpdCBpcyBhdmFpbGFibGUgYW5kIGN1cnJlbnRseSBub3QgYmVpbmcKICAgICogc3Vic2NyaWJlZCB0bykgd2hlbiB0aGUgPGNvZGU+dmFsdWU8L2NvZGU+IGlzIDxjb2RlPnRydWU8L2NvZGU+OyBzdG9wcyBzdWJzY3JpYmluZyB0byB2aWRlbwogICAgKiAoaWYgaXQgaXMgY3VycmVudGx5IGJlaW5nIHN1YnNjcmliZWQgdG8pIHdoZW4gdGhlIDxjb2RlPnZhbHVlPC9jb2RlPiBpcyA8Y29kZT5mYWxzZTwvY29kZT4uCiAgICAqIDxwPgogICAgKiA8aT5Ob3RlOjwvaT4gVGhpcyBtZXRob2Qgb25seSBhZmZlY3RzIHRoZSBsb2NhbCBwbGF5YmFjayBvZiB2aWRlby4gSXQgaGFzIG5vIGltcGFjdCBvbiB0aGUgdmlkZW8KICAgICogZm9yIG90aGVyIGNvbm5lY3Rpb25zIHN1YnNjcmliaW5nIHRvIHRoZSBzYW1lIHN0cmVhbS4gSWYgdGhlIFB1YmxzaGVyIGlzIG5vdCBwdWJsaXNoaW5nIHZpZGVvLAogICAgKiBlbmFibGluZyB0aGUgU3Vic2NyaWJlciB2aWRlbyB3aWxsIGhhdmUgbm8gcHJhY3RpY2FsIHZpZGVvLgogICAgKiA8L3A+CiAgICAqCiAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gdmFsdWUgV2hldGhlciB0byBzdGFydCBzdWJzY3JpYmluZyB0byB2aWRlbyAoPGNvZGU+dHJ1ZTwvY29kZT4pIG9yIG5vdCAoPGNvZGU+ZmFsc2U8L2NvZGU+KS4KICAgICoKICAgICogQHJldHVybiB7U3Vic2NyaWJlcn0gVGhlIFN1YnNjcmliZXIgb2JqZWN0LiBUaGlzIGxldHMgeW91IGNoYWluIG1ldGhvZCBjYWxscywgYXMgaW4gdGhlIGZvbGxvd2luZzoKICAgICoKICAgICogPHByZT5teVN1YnNjcmliZXIuc3Vic2NyaWJlVG9WaWRlbyh0cnVlKS5zdWJzY3JpYmVUb0F1ZGlvKGZhbHNlKTs8L3ByZT4KICAgICoKICAgICogQHNlZSA8YSBocmVmPSIjc3Vic2NyaWJlVG9BdWRpbyI+c3Vic2NyaWJlVG9BdWRpbygpPC9hPgogICAgKiBAc2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNzdWJzY3JpYmUiPlNlc3Npb24uc3Vic2NyaWJlKCk8L2E+CiAgICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQuaHRtbCI+U3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQ8L2E+CiAgICAqCiAgICAqIEBtZXRob2QgI3N1YnNjcmliZVRvVmlkZW8KICAgICogQG1lbWJlck9mIFN1YnNjcmliZXIKICAgICovCiAgICB0aGlzLnN1YnNjcmliZVRvVmlkZW8gPSBmdW5jdGlvbihwX3ZhbHVlKSB7CiAgICAgICAgaWYoX3N1YnNjcmliZUF1ZGlvRmFsc2VXb3JrYXJvdW5kICYmIHBfdmFsdWUgPT0gdHJ1ZSkgewogICAgICAgICAgICAvLyBUdXJuIG9mZiB0aGUgd29ya2Fyb3VuZCBpZiB0aGV5IGVuYWJsZSB0aGUgdmlkZW8KICAgICAgICAgICAgX3N1YnNjcmliZUF1ZGlvRmFsc2VXb3JrYXJvdW5kID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB2YWx1ZSA9IE9ULiQuY2FzdFRvQm9vbGVhbihwX3ZhbHVlLCB0cnVlKTsKCiAgICAgICAgaWYoX2NvbnRhaW5lcikgewogICAgICAgICAgICBfY29udGFpbmVyLnNob3dQb3N0ZXIgPSAhKHZhbHVlICYmIF9zdHJlYW0uaGFzVmlkZW8pOwogICAgICAgICAgICBpZih2YWx1ZSAmJiBfY29udGFpbmVyLnZpZGVvKSB7CiAgICAgICAgICAgICAgICBfY29udGFpbmVyLmxvYWRpbmcgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIF9jb250YWluZXIudmlkZW8ud2hlblRpbWVJbmNyZW1lbnRzKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRhaW5lci5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKF9wZWVyQ29ubmVjdGlvbikgewogICAgICAgICAgICBfcGVlckNvbm5lY3Rpb24uc3Vic2NyaWJlVG9WaWRlbyh2YWx1ZSk7CgogICAgICAgICAgICBpZiAoX3Nlc3Npb24gJiYgX3N0cmVhbSAmJiB2YWx1ZSAhPT0gX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9WaWRlbykgewogICAgICAgICAgICAgICAgX3Nlc3Npb24uXy5tb2RpZnlTdWJzY3JpYmVyKHRoaXMsICJoYXNWaWRlbyIsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Byb3BlcnRpZXMuc3Vic2NyaWJlVG9WaWRlbyA9IHZhbHVlOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAgIGlkOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfZG9tSWQ7IH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9LAoKICAgICAgICB3aWRnZXRJZDogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3dpZGdldElkOyB9CiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfc3RyZWFtOyB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgc3RyZWFtSWQ6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghX3N0cmVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICAgICAgcmV0dXJuIF9zdHJlYW0uaWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9LAoKICAgICAgICB0YXJnZXRFbGVtZW50OiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfc3RyZWFtQ29udGFpbmVyID8gX3N0cmVhbUNvbnRhaW5lci5kb21FbGVtZW50IDogbnVsbDsgfQogICAgICAgIH0sCgogICAgICAgIHN1YnNjcmliaW5nOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBfc3RhdGUuc3Vic2NyaWJpbmc7IH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9LAoKICAgICAgICBpc1dlYlJUQzogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgIH0sCgogICAgICAgIGxvYWRpbmc6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpeyByZXR1cm4gX2NvbnRhaW5lciAmJiBfY29udGFpbmVyLmxvYWRpbmcgfQogICAgICAgIH0sCgogICAgICAgIHNlc3Npb246IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uOyB9CiAgICAgICAgfQogICAgfSk7CgogICAgdGhpcy5vbignc3R5bGVWYWx1ZUNoYW5nZWQnLCB1cGRhdGVDaHJvbWVGb3JTdHlsZUNoYW5nZSwgdGhpcyk7CgogICAgX3N0YXRlID0gbmV3IE9ULlN1YnNjcmliaW5nU3RhdGUoc3RhdGVDaGFuZ2VGYWlsZWQpOwoKICAvKioKICAqIERpc3BhdGNoZWQgd2hlbiB0aGUgT3BlblRvayBtZWRpYSBzZXJ2ZXIgc3RvcHMgc2VuZGluZyB2aWRlbyB0byB0aGUgc3Vic2NyaWJlci4KICAqIFRoaXMgZmVhdHVyZSBvZiB0aGUgT3BlblRvayBtZWRpYSBzZXJ2ZXIgaGFzIGEgc3Vic2NyaWJlciBkcm9wIHRoZSB2aWRlbyBzdHJlYW0KICAqIHdoZW4gY29ubmVjdGl2aXR5IGRlZ3JhZGVzLiBUaGUgc3Vic2NyaWJlciBjb250aW51ZXMgdG8gcmVjZWl2ZSB0aGUgYXVkaW8gc3RyZWFtLAogICogaWYgdGhlcmUgaXMgb25lLiBUaGlzIGZlYXR1cmUgaXMgb25seSBhdmFpbGFibGUgaW4gc2Vzc2lvbnMgdGhhdCB1c2UgdGhlIE9wZW5Ub2sKICAqIG1lZGlhIHNlcnZlciwgbm90IGluIHBlZXItdG8tcGVlciBzZXNzaW9ucy4KICAqIEBuYW1lIHZpZGVvRGlzYWJsZWQKICAqIEBldmVudAogICogQG1lbWJlcm9mIFN1YnNjcmliZXIKICAqLwoKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKICAgIE9ULlNlc3Npb25JbmZvID0gZnVuY3Rpb24oeG1sRG9jdW1lbnQpIHsKICAgICAgICB2YXIgc2Vzc2lvblhNTCA9IG51bGw7CgogICAgICAgIHRoaXMuc2Vzc2lvbklkID0gbnVsbDsKICAgICAgICB0aGlzLnBhcnRuZXJJZCA9IG51bGw7CiAgICAgICAgdGhpcy5zZXNzaW9uU3RhdHVzID0gbnVsbDsKICAgICAgICB0aGlzLnAycEVuYWJsZWQgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5tZXNzYWdpbmdTZXJ2ZXIgPSBudWxsOwogICAgICAgIHRoaXMuaWNlU2VydmVycyA9IG51bGw7CgogICAgICAgIE9ULmxvZygiU2Vzc2lvbkluZm8gUmVzcG9uc2U6IikKICAgICAgICBPVC5sb2coeG1sRG9jdW1lbnQpOwoKICAgICAgICBpZiAoeG1sRG9jdW1lbnQgJiYgeG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIHhtbERvY3VtZW50LmRvY3VtZW50RWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBzZXNzaW9uWE1MID0geG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVsZW1lbnQgPSBzZXNzaW9uWE1MLmZpcnN0RWxlbWVudENoaWxkOwogICAgICAgIGRvIHsKICAgICAgICAgICAgc3dpdGNoIChlbGVtZW50LmxvY2FsTmFtZSkgewogICAgICAgICAgICBjYXNlICJzZXNzaW9uX2lkIjoKICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gZWxlbWVudC50ZXh0Q29udGVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAicGFydG5lcl9pZCI6CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRuZXJJZCA9IGVsZW1lbnQudGV4dENvbnRlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgInNlc3Npb25fc3RhdHVzIjoKICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvblN0YXR1cyA9IGVsZW1lbnQudGV4dENvbnRlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgIm1lc3NhZ2luZ19zZXJ2ZXJfdXJsIjoKICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnaW5nU2VydmVyID0gZWxlbWVudC50ZXh0Q29udGVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAiaWNlX3NlcnZlcnMiOgogICAgICAgICAgICAgICAgLy8gPGljZV9zZXJ2ZXJzPgogICAgICAgICAgICAgICAgLy8gICAgIDxpY2Vfc2VydmVyIHVybD0iZm9vLmNvbSIgLz4KICAgICAgICAgICAgICAgIC8vICAgICA8aWNlX3NlcnZlciB1cmw9ImJhci5jb20iIGNyZWRlbnRpYWw9Inh4eCIgLz4KICAgICAgICAgICAgICAgIC8vIDwvaWNlX3NlcnZlcnM+CgogICAgICAgICAgICAgICAgdGhpcy5pY2VTZXJ2ZXJzID0gbm9ybWFsaXNlSWNlU2VydmVycyggcGFyc2VJY2VTZXJ2ZXJzWG1sKGVsZW1lbnQuY2hpbGROb2RlcykgKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pY2VTZXJ2ZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmVuJ3QgZ290IGFueSBJQ0UgU2VydmVycyBmcm9tIEFudmlsLCBkZWZhdWx0IHRvIHNvbWV0aGluZwogICAgICAgICAgICAgICAgICAgIE9ULndhcm4oIlNlc3Npb25JbmZvIGNvbnRhaW5lZCBub3QgSUNFIFNlcnZlcnMsIHVzaW5nIHRoZSBkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pY2VTZXJ2ZXJzID0gWyB7InVybCI6ICJzdHVuOnN0dW4ubC5nb29nbGUuY29tOjE5MzAyIn0gXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgInByb3BlcnRpZXMiOgogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5ID0gZWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZDsKICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5LmxvY2FsTmFtZSA9PT0gInAycCIgJiYgcHJvcGVydHkuZmlyc3RFbGVtZW50Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucDJwRW5hYmxlZCA9IChwcm9wZXJ0eS5maXJzdEVsZW1lbnRDaGlsZC50ZXh0Q29udGVudCA9PT0gImVuYWJsZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocHJvcGVydHkgPSBwcm9wZXJ0eS5uZXh0RWxlbWVudFNpYmxpbmcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIC8vIE9ULmRlYnVnKCJPVC5TZXNzaW9uSW5mbyBlbGVtZW50IHdhcyBub3QgaGFuZGxlZCAoIiArIGVsZW1lbnQubG9jYWxOYW1lICsgIikiKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgIH0gd2hpbGUgKGVsZW1lbnQgPSBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZyk7CgogICAgICAgIC8vd2UndmUgcGFyc2VkIHRoZSBYTUwgaW50byB0aGUgb2JqZWN0CgogICAgICAgIHNlc3Npb25YTUwgPSBudWxsOwogICAgfTsKCgovLyBSZXRyaWV2ZXMgU2Vzc2lvbiBJbmZvIGZvciArc2Vzc2lvbisuIFRoZSBTZXNzaW9uSW5mbyBvYmplY3Qgd2lsbCBiZSBwYXNzZWQKLy8gdG8gdGhlICtvblN1Y2Nlc3MrIGNhbGxiYWNrLiBUaGUgK29uRmFpbHVyZSsgY2FsbGJhY2sgd2lsbCBiZSBwYXNzZWQgYW4gZXJyb3IKLy8gb2JqZWN0IGFuZCB0aGUgRE9NRXZlbnQgdGhhdCByZWxhdGVzIHRvIHRoZSBlcnJvci4KT1QuU2Vzc2lvbkluZm8uZ2V0ID0gZnVuY3Rpb24oc2Vzc2lvbiwgb25TdWNjZXNzLCBvbkZhaWx1cmUpIHsKICAgIHZhciBzZXNzaW9uSW5mb1VSTCA9IE9ULnByb3BlcnRpZXMuYXBpVVJMICsgJy9zZXNzaW9uLycgKyBzZXNzaW9uLmlkICsgIj9leHRlbmRlZD10cnVlIiwKCiAgICAgICAgc3RhcnRUaW1lID0gT1QuJC5ub3coKSwKCiAgICAgICAgdmFsaWRhdGVSYXdTZXNzaW9uSW5mbyA9IGZ1bmN0aW9uKHNlc3Npb25JbmZvKSB7CiAgICAgICAgICAgIHNlc3Npb24ubG9nRXZlbnQoJ0luc3RydW1lbnRhdGlvbicsIG51bGwsICdnc2knLCBPVC4kLm5vdygpIC0gc3RhcnRUaW1lKTsKCiAgICAgICAgICAgIHZhciBlcnJvciA9IHBhcnNlRXJyb3JGcm9tWE1MRG9jdW1lbnQoc2Vzc2lvbkluZm8pOwoKICAgICAgICAgICAgaWYgKGVycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgb25HZXRSZXNwb25zZUNhbGxiYWNrKHNlc3Npb24sIG9uU3VjY2Vzcywgc2Vzc2lvbkluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgb25HZXRFcnJvckNhbGxiYWNrKHNlc3Npb24sIG9uRmFpbHVyZSwgZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICBzZXNzaW9uLmxvZ0V2ZW50KCdnZXRTZXNzaW9uSW5mbycsICdBdHRlbXB0JywgJ2FwaV91cmwnLCBPVC5wcm9wZXJ0aWVzLmFwaVVSTCk7CgogICAgT1QuJC5nZXRYTUwoc2Vzc2lvbkluZm9VUkwsIHsKICAgICAgICBoZWFkZXJzOiB7IlgtVEItVE9LRU4tQVVUSCI6IHNlc3Npb24udG9rZW4sICJYLVRCLVZFUlNJT04iOiAxfSwKCiAgICAgICAgc3VjY2VzczogdmFsaWRhdGVSYXdTZXNzaW9uSW5mbywKCiAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIG9uR2V0RXJyb3JDYWxsYmFjayhzZXNzaW9uLCBvbkZhaWx1cmUsIHBhcnNlRXJyb3JGcm9tWE1MRG9jdW1lbnQoZXZlbnQudGFyZ2V0LnJlc3BvbnNlWE1MKSk7CiAgICAgICAgfQogICAgfSk7Cn07Cgp2YXIgbWVzc2FnZVNlcnZlclRvQ2xpZW50RXJyb3JDb2RlcyA9IHt9OwptZXNzYWdlU2VydmVyVG9DbGllbnRFcnJvckNvZGVzWyc0MDQnXSA9IE9ULkV4Y2VwdGlvbkNvZGVzLklOVkFMSURfU0VTU0lPTl9JRDsKbWVzc2FnZVNlcnZlclRvQ2xpZW50RXJyb3JDb2Rlc1snNDAzJ10gPSBPVC5FeGNlcHRpb25Db2Rlcy5BVVRIRU5USUNBVElPTl9FUlJPUjsKCi8vIFJldHVybiB0aGUgZXJyb3IgaW4gK3htbERvY3VtZW50KywgaWYgdGhlcmUgaXMgb25lLiBPdGhlcndpc2UgaXQgd2lsbCByZXR1cm4KLy8gZmFsc2UuCnBhcnNlRXJyb3JGcm9tWE1MRG9jdW1lbnQgPSBmdW5jdGlvbih4bWxEb2N1bWVudCkgewogICAgaWYgKHhtbERvY3VtZW50ICYmIHhtbERvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiB4bWxEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICB2YXIgZXJyb3JOb2RlcyA9IHhtbERvY3VtZW50LmV2YWx1YXRlKCcvL2Vycm9yJywgeG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBudWxsLCBYUGF0aFJlc3VsdC5PUkRFUkVEX05PREVfU05BUFNIT1RfVFlQRSwgbnVsbCApLAogICAgICAgICAgICBudW1FcnJvck5vZGVzID0gZXJyb3JOb2Rlcy5zbmFwc2hvdExlbmd0aDsKCiAgICAgICAgaWYgKG51bUVycm9yTm9kZXMgPT09IDApIHJldHVybiBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgaT0wOyBpPG51bUVycm9yTm9kZXM7ICsraSkgewogICAgICAgICAgICB2YXIgZXJyb3JOb2RlID0gZXJyb3JOb2Rlcy5zbmFwc2hvdEl0ZW0oaSk7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgY29kZTogZXJyb3JOb2RlLmdldEF0dHJpYnV0ZSgnY29kZScpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3JOb2RlLmZpcnN0RWxlbWVudENoaWxkLmdldEF0dHJpYnV0ZSgnbWVzc2FnZScpCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfQoKICAgIC8vIFRoZXJlIHdhcyBhbiBlcnJvciwgYnV0IHdlIGNvdWxkbid0IGZpbmQgdGhlIGVycm9yIGluZm8uCiAgICByZXR1cm4gewogICAgICAgIGNvZGU6IG51bGwsCiAgICAgICAgbWVzc2FnZTogIlVua25vd24gZXJyb3I6IGdldFNlc3Npb25JbmZvIFhNTCByZXNwb25zZSB3YXMgYmFkbHkgZm9ybWVkIgogICAgfTsKfTsKCm9uR2V0UmVzcG9uc2VDYWxsYmFjayA9IGZ1bmN0aW9uKHNlc3Npb24sIG9uU3VjY2VzcywgcmF3U2Vzc2lvbkluZm8pIHsKICBzZXNzaW9uLmxvZ0V2ZW50KCdnZXRTZXNzaW9uSW5mbycsICdTdWNjZXNzJywgJ2FwaV91cmwnLCBPVC5wcm9wZXJ0aWVzLmFwaVVSTCk7CgogIG9uU3VjY2VzcyggbmV3IE9ULlNlc3Npb25JbmZvKHJhd1Nlc3Npb25JbmZvKSApOwp9OwoKb25HZXRFcnJvckNhbGxiYWNrID0gZnVuY3Rpb24oc2Vzc2lvbiwgb25GYWlsdXJlLCBlcnJvcikgewogICAgVEIuaGFuZGxlSnNFeGNlcHRpb24oIlRCLlNlc3Npb25JbmZvRXJyb3IgOjogVW5hYmxlIHRvIGdldCBzZXNzaW9uIGluZm8gIiArIGVycm9yLm1lc3NhZ2UsIG1lc3NhZ2VTZXJ2ZXJUb0NsaWVudEVycm9yQ29kZXNbZXJyb3IuY29kZV0sIHsKICAgICAgICBzZXNzaW9uOiBzZXNzaW9uCiAgICB9KTsKCiAgICBzZXNzaW9uLmxvZ0V2ZW50KCdnZXRTZXNzaW9uSW5mbycsICdGYWlsdXJlJywgJ2Vycm9yTWVzc2FnZScsICJUQi5TZXNzaW9uSW5mb0Vycm9yIDo6IFVuYWJsZSB0byBnZXQgc2Vzc2lvbiBpbmZvICIgKyBlcnJvci5tZXNzYWdlKTsKICAgIG9uRmFpbHVyZShlcnJvciwgc2Vzc2lvbik7Cn07CgpwYXJzZUljZVNlcnZlcnNYbWwgPSBmdW5jdGlvbiAobm9kZXMpIHsKICAgIHZhciBpY2VTZXJ2ZXJzID0gW10sCiAgICAgICAgaWNlU2VydmVyLAogICAgICAgIGF0dHJpYnV0ZXM7CgogICAgZm9yICh2YXIgaT0wLCBudW1Ob2Rlcz1ub2Rlcy5sZW5ndGg7IGk8bnVtTm9kZXM7ICsraSkgewogICAgICAgIGlmIChub2Rlc1tpXS5sb2NhbE5hbWUgPT09ICdpY2Vfc2VydmVyJykgewogICAgICAgICAgICAvLyBAdG9kbyBwYXJzZSBlaXRoZXIgYSBVUkwgbm9kZSwgb3IgYSBVUkwgYW5kIGNyZWRlbnRpYWxzCiAgICAgICAgICAgIGF0dHJpYnV0ZXMgPSBub2Rlc1tpXS5hdHRyaWJ1dGVzOwogICAgICAgICAgICBpY2VTZXJ2ZXIgPSB7CiAgICAgICAgICAgICAgICB1cmw6IGF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCd1cmwnKS5ub2RlVmFsdWUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgnY3JlZGVudGlhbCcpICYmIGF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCdjcmVkZW50aWFsJykubm9kZVZhbHVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWNlU2VydmVyLmNyZWRlbnRpYWwgPSBhdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgnY3JlZGVudGlhbCcpLm5vZGVWYWx1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWNlU2VydmVycy5wdXNoKGljZVNlcnZlcik7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBpY2VTZXJ2ZXJzOwp9OwoKLy8gVGhpcyBpcyB1Z2x5LiBIZXJlIHdlIGFyZSBoYW5kbGluZyB0aGUgZm9sbG93aW5nOgovLyAxLiBGaXJlZm94IGRvZXNuJ3Qgc3VwcG9ydCBUVVJOIHVudGlsIHZlcnNpb24gMjUuIFdlIGZhbGxiYWNrIHRvIFNUVU4KLy8gaW4gcHJldmlvdXMgdmVyc2lvbnMuCi8vCi8vIDIuIEluIEZGID49IDIzIHRoZSBuZXcgc3ludGF4IGZvciBkZWNsYXJpbmcgSWNlIFNlcnZlcnMgd2l0aCBjcmVkZW50aWFscwovLyBpcyB1c2VkLiBpLmUuIHVybCwgY3JlZGVudGlhbCwgYW5kIHVzZXJuYW1lIGFzIG9wcG9zZWQgdG8ganVzdCB1cmwgYW5kIGNyZWRlbnRpYWwuCi8vCi8vIDMuIEZGID49IDI3IHN1cHBvcnRzIHRoZSBUVVJOIHRyYW5zcG9ydCBwYXJhbWV0ZXIsIGluIG9sZGVyIHZlcnNpb25zIHdlIG5lZWQKLy8gdG8gc3RyaXAgaXQgb3V0LgovLwpub3JtYWxpc2VJY2VTZXJ2ZXJzID0gZnVuY3Rpb24gKGljZVNlcnZlcnMpIHsKICAgIHZhciB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8oRmlyZWZveClcLyhbMC05XStcLlswLTldKykvKSwKICAgICAgICBmaXJlZm94VmVyc2lvbiA9IHVzZXJBZ2VudCA/IHBhcnNlRmxvYXQodXNlckFnZW50WzJdLCAxMCkgOiB2b2lkIDAsCiAgICAgICAgYml0czsKCiAgICByZXR1cm4gaWNlU2VydmVycy5tYXAoZnVuY3Rpb24oaWNlU2VydmVyKSB7CiAgICAgICAgLy8gV2UgZG9uJ3QgbmVlZCB0byBub3JtYWxpc2UgU1RVTiwganVzdCBwYXNzIGl0IG9uIHRocm91Z2gKICAgICAgICBpZiAoaWNlU2VydmVyLnVybC50cmltKCkuc3Vic3RyKDAsIDUpICE9PSAndHVybjonKSB7CiAgICAgICAgICAgIHJldHVybiBpY2VTZXJ2ZXI7CiAgICAgICAgfQoKICAgICAgICBpZiAodXNlckFnZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIC8vIFRVUk4gaXMgYnJva2VuIGluIHRoZXNlIHZlcnNpb25zIG9mIEZGOiBGYWxsYmFjayB0byBTVFVOLgogICAgICAgICAgICBpZiAoZmlyZWZveFZlcnNpb24gPCAyNSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHt1cmw6IGljZVNlcnZlci51cmwucmVwbGFjZSgidHVybjoiLCAic3R1bjoiKX07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZGIDwgMjcgZG9lc24ndCBzdXBwb3J0IHRoZSBUVVJOIHRyYW5zcG9ydCBwYXJhbWV0ZXIsIHNvIHdlIHN0cmlwIGl0IG91dAogICAgICAgICAgICBpZiAoZmlyZWZveFZlcnNpb24gPCAyNyAmJiBpY2VTZXJ2ZXIudXJsLmluZGV4T2YoJz8nKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIGljZVNlcnZlci51cmwgPSBpY2VTZXJ2ZXIudXJsLnRyaW0oKS5zcGxpdCgnPycpWzBdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBiaXRzID0gaWNlU2VydmVyLnVybC50cmltKCkuc3BsaXQoL1s6QF0vKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdXNlcm5hbWU6IGJpdHNbMV0sCiAgICAgICAgICAgIGNyZWRlbnRpYWw6IGljZVNlcnZlci5jcmVkZW50aWFsLAogICAgICAgICAgICB1cmw6IGJpdHNbMF0gKyAnOicgKyBiaXRzWzJdCiAgICAgICAgfTsKICAgIH0pOwp9OwoKfSkod2luZG93KTsKKGZ1bmN0aW9uKHdpbmRvdykgewogIC8qKgogICAqIEEgY2xhc3MgZGVmaW5pbmcgcHJvcGVydGllcyBvZiB0aGUgPGNvZGU+Y2FwYWJpbGl0aWVzPC9jb2RlPiBwcm9wZXJ0eSBvZiBhCiAgICAgKiBTZXNzaW9uIG9iamVjdC4gU2VlIDxhIGhyZWY9IlNlc3Npb24uaHRtbCNjYXBhYmlsaXRlcyI+U2Vzc2lvbi5jYXBhYmlsaXRpZXM8L2E+LgogICAqIDxwPgogICAqIEFsbCBDYXBhYmlsaXRpZXMgcHJvcGVydGllcyBhcmUgdW5kZWZpbmVkIHVudGlsIHlvdSBoYXZlIGNvbm5lY3RlZCB0byBhIHNlc3Npb24KICAgKiBhbmQgdGhlIFNlc3Npb24gb2JqZWN0IGhhcyBkaXNwYXRjaGVkIHRoZSA8Y29kZT5zZXNzaW9uQ29ubmVjdGVkPC9jb2RlPiBldmVudC4KICAgKiA8cD4KICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiB0b2tlbiByb2xlcywgc2VlIHRoZSA8YSBocmVmPSJzZXJ2ZXJfc2lkZV9saWJyYXJpZXMuaHRtbCNnZW5lcmF0ZV90b2tlbiI+Z2VuZXJhdGVfdG9rZW4oKTwvYT4KICAgICAqIG1ldGhvZCBvZiB0aGUgT3BlblRvayBzZXJ2ZXItc2lkZSBsaWJyYXJpZXMuCiAgICoKICAgKiBAY2xhc3MgQ2FwYWJpbGl0aWVzCiAgICoKICAgKiBAcHJvcGVydHkge051bWJlcn0gZm9yY2VEaXNjb25uZWN0IFNwZWNpZmllcyB3aGV0aGVyIHlvdSBjYW4gY2FsbAogICAgIHRoZSA8Y29kZT5TZXNzaW9uLmZvcmNlRGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2QgKDEpIG9yIG5vdCAoMCkuIFRvIGNhbGwgdGhlIDxjb2RlPlNlc3Npb24uZm9yY2VEaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCwKICAgICB0aGUgdXNlciBtdXN0IGhhdmUgYSB0b2tlbiB0aGF0IGlzIGFzc2lnbmVkIHRoZSByb2xlIG9mIG1vZGVyYXRvci4KICAgKiBAcHJvcGVydHkge051bWJlcn0gZm9yY2VVbnB1Ymxpc2ggU3BlY2lmaWVzIHdoZXRoZXIgeW91IGNhbiBjYWxsCiAgICAgdGhlIDxjb2RlPlNlc3Npb24uZm9yY2VVbnB1Ymxpc2goKTwvY29kZT4gbWV0aG9kICgxKSBvciBub3QgKDApLiBUbyBjYWxsIHRoZSA8Y29kZT5TZXNzaW9uLmZvcmNlVW5wdWJsaXNoKCk8L2NvZGU+IG1ldGhvZCwKICAgICB0aGUgdXNlciBtdXN0IGhhdmUgYSB0b2tlbiB0aGF0IGlzIGFzc2lnbmVkIHRoZSByb2xlIG9mIG1vZGVyYXRvci4KICAgKiBAcHJvcGVydHkge051bWJlcn0gcHVibGlzaCBTcGVjaWZpZXMgd2hldGhlciB5b3UgY2FuIHB1Ymxpc2ggdG8gdGhlIHNlc3Npb24gKDEpIG9yIG5vdCAoMCkuCiAgICAgVGhlIGFiaWxpdHkgdG8gcHVibGlzaCBpcyBiYXNlZCBvbiBhIGZldyBmYWN0b3JzLiBUbyBwdWJsaXNoLCB0aGUgdXNlciBtdXN0IGhhdmUgYSB0b2tlbiB0aGF0CiAgICAgaXMgYXNzaWduZWQgYSByb2xlIHRoYXQgc3VwcG9ydHMgcHVibGlzaGluZy4gVGhlcmUgbXVzdCBiZSBhIGNvbm5lY3RlZCBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuCiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHN1YnNjcmliZSBTcGVjaWZpZXMgd2hldGhlciB5b3UgY2FuIHN1YnNjcmliZSB0byBzdHJlYW1zCiAgICAgaW4gdGhlIHNlc3Npb24gKDEpIG9yIG5vdCAoMCkuIEN1cnJlbnRseSwgdGhpcyBjYXBhYmlsaXR5IGlzIGF2YWlsYWJsZSBmb3IgYWxsIHVzZXJzIG9uIGFsbCBwbGF0Zm9ybXMuCiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHN1cHBvcnRzV2ViUlRDIFdoZXRoZXIgdGhlIGNsaWVudCBzdXBwb3J0cyBXZWJSVEMgKDEpIG9yIG5vdCAoMCkuCiAgICovCiAgT1QuQ2FwYWJpbGl0aWVzID0gZnVuY3Rpb24ocGVybWlzc2lvbnMpIHsKICAgICAgdGhpcy5wdWJsaXNoID0gcGVybWlzc2lvbnMuaW5kZXhPZigncHVibGlzaCcpICE9PSAtMSA/IDEgOiAwOwogICAgICB0aGlzLnN1YnNjcmliZSA9IHBlcm1pc3Npb25zLmluZGV4T2YoJ3N1YnNjcmliZScpICE9PSAtMSA/IDEgOiAwOwogICAgICB0aGlzLmZvcmNlVW5wdWJsaXNoID0gcGVybWlzc2lvbnMuaW5kZXhPZignZm9yY2V1bnB1Ymxpc2gnKSAhPT0gLTEgPyAxIDogMDsKICAgICAgdGhpcy5mb3JjZURpc2Nvbm5lY3QgPSBwZXJtaXNzaW9ucy5pbmRleE9mKCdmb3JjZWRpc2Nvbm5lY3QnKSAhPT0gLTEgPyAxIDogMDsKICAgICAgdGhpcy5zdXBwb3J0c1dlYlJUQyA9IE9ULiQuc3VwcG9ydHNXZWJSVEMoKSA/IDEgOiAwOwogICAgfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKCi8vIFdyYXBzIHVwIHNvbWUgY29tbW9uIGVycm9yIGhhbmRsaW5nIGZvciBpbXBsZW1lbnRpbmcgY2FsbGJhY2tzCi8vIGZvciB3b3JrIHJlcXVlc3RzIG1hZGUgdG8gdGhlIE9UIGJhY2tlbmQgdmlhIHRoZSBNZXNzZW5nZXIuCnZhciBSZW1vdGVXb3JrID0gZnVuY3Rpb24gUmVtb3RlV29yayAocGFyZW50LCBzdWNjZXNzLCBlcnJvciwgb3B0aW9ucykgewogIHZhciBSRVFVRVNUX1RJTUVPVVQgPSAzMDAwMCwKICAgICAgdGltZW91dEludGVydmFsLAogICAgICBleGNlcHRpb25Db2Rlc0luZGljYXRpbmdGYWlsdXJlID0ge307CgogIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJbnRlcnZhbCk7CiAgICAgICAgcGFyZW50Lm9mZignZXhjZXB0aW9uJywgb25FeGNlcHRpb24pOwogICAgICB9LAoKICAgICAgb25FeGNlcHRpb24gPSBmdW5jdGlvbihldmVudCkgewogICAgICAgIGlmICghZXhjZXB0aW9uQ29kZXNJbmRpY2F0aW5nRmFpbHVyZS5oYXNPd25Qcm9wZXJ0eShldmVudC5jb2RlKSkgcmV0dXJuOwoKICAgICAgICAvLyBXZSBkb24ndCBldmVuIGtub3cgaWYgdGhpcyByZWxhdGVzIHRvIHRoaXMgcGFydGljdWxhciBmb3JjZURpc2Nvbm5jdC4uLgogICAgICAgIHRoaXMuZmFpbGVkKGV4Y2VwdGlvbkNvZGVzSW5kaWNhdGluZ0ZhaWx1cmVbZXZlbnQuY29kZV0pOwogICAgICB9LAoKICAgICAgb25UaW1lb3V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlYXNvbiA9IG9wdGlvbnMgJiYgb3B0aW9ucy50aW1lb3V0TWVzc2FnZSA/IG9wdGlvbnMudGltZW91dE1lc3NhZ2UgOiAiVGltZWQgb3V0IHdoaWxlIHdhaXRpbmcgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZC4iOwogICAgICAgIHRoaXMuZmFpbGVkKHJlYXNvbik7CiAgICAgIH07CgoKICB0aGlzLmZhaWxzT25FeGNlcHRpb25Db2RlcyA9IGZ1bmN0aW9uKGNvZGVzKSB7CiAgICBleGNlcHRpb25Db2Rlc0luZGljYXRpbmdGYWlsdXJlID0gY29kZXM7CiAgfTsKCiAgdGhpcy5zdWNjZWVkZWQgPSBmdW5jdGlvbigpIHsKICAgIGRlc3Ryb3koKTsKICAgIGlmIChjb21wbGV0aW9uSGFuZGxlcikgT1QuJC5jYWxsQXN5bmMoY29tcGxldGlvbkhhbmRsZXIsIG51bGwpOwogIH07CgogIHRoaXMuZmFpbGVkID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICBkZXN0cm95KCk7CiAgICBpZiAoY29tcGxldGlvbkhhbmRsZXIpIE9ULiQuY2FsbEFzeW5jKGNvbXBsZXRpb25IYW5kbGVyLCBuZXcgT1QuRXJyb3IobnVsbCwgcmVhc29uKSk7CiAgfTsKCiAgcGFyZW50Lm9uKCdleGNlcHRpb24nLCBvbkV4Y2VwdGlvbiwgdGhpcyk7CiAgdGltZW91dEludGVydmFsID0gc2V0VGltZW91dChvblRpbWVvdXQuYmluZCh0aGlzKSwgUkVRVUVTVF9USU1FT1VUKTsKfTsKCgovKioKICogVGhlIFNlc3Npb24gb2JqZWN0IHJldHVybmVkIGJ5IHRoZSA8Y29kZT5UQi5pbml0U2Vzc2lvbigpPC9jb2RlPiBtZXRob2QgcHJvdmlkZXMgYWNjZXNzIHRvIG11Y2ggb2YgdGhlIE9wZW5Ub2sgZnVuY3Rpb25hbGl0eS4KICoKICogQGNsYXNzIFNlc3Npb24KICogQGF1Z21lbnRzIEV2ZW50RGlzcGF0Y2hlcgogKgogKiBAcHJvcGVydHkge0NhcGFiaWxpdGllc30gY2FwYWJpbGl0aWVzIEEge0BsaW5rIENhcGFiaWxpdGllc30gb2JqZWN0IHRoYXQgaW5jbHVkZXMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNhcGFiaWxpdGllcyBvZiB0aGUgY2xpZW50LgogKiBBbGwgcHJvcGVydGllcyBvZiB0aGUgPGNvZGU+Y2FwYWJpbGl0aWVzPC9jb2RlPiBvYmplY3QgYXJlIHVuZGVmaW5lZCB1bnRpbCB5b3UgaGF2ZSBjb25uZWN0ZWQgdG8gYSBzZXNzaW9uCiAqIGFuZCB0aGUgU2Vzc2lvbiBvYmplY3QgaGFzIGRpc3BhdGNoZWQgdGhlIDxjb2RlPnNlc3Npb25Db25uZWN0ZWQ8L2NvZGU+IGV2ZW50LgogKiBAcHJvcGVydHkge0Nvbm5lY3Rpb259IGNvbm5lY3Rpb24gVGhlIHtAbGluayBDb25uZWN0aW9ufSBvYmplY3QgZm9yIHRoaXMgc2Vzc2lvbi4gVGhlIGNvbm5lY3Rpb24gcHJvcGVydHkgaXMgb25seSBhdmFpbGFibGUgb25jZSB0aGUKICogU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyB0aGUgc2Vzc2lvbkNvbm5lY3RlZCBldmVudC4gVGhlIFNlc3Npb24gb2JqZWN0IGFzeW5jaHJvbm91c2x5IGRpc3BhdGNoZXMgYSBzZXNzaW9uQ29ubmVjdGVkIGV2ZW50IGluIHJlc3BvbnNlCiAqIHRvIGEgc3VjY2Vzc2Z1bCBjYWxsIHRvIHRoZSBjb25uZWN0KCkgbWV0aG9kLiBTZWU6IDxhIGhyZWY9IlNlc3Npb24jY29ubmVjdCI+Y29ubmVjdDwvYT4gYW5kIHtAbGluayBDb25uZWN0aW9ufS4KICogQHByb3BlcnR5IHtTdHJpbmd9IHNlc3Npb25JZCBUaGUgc2Vzc2lvbiBJRCBmb3IgdGhpcyBzZXNzaW9uLiBZb3UgcGFzcyB0aGlzIHZhbHVlIGludG8gdGhlIDxjb2RlPlRCLmluaXRTZXNzaW9uKCk8L2NvZGU+IG1ldGhvZCB3aGVuIHlvdSBjcmVhdGUKICogdGhlIFNlc3Npb24gb2JqZWN0LiAoTm90ZTogYSBTZXNzaW9uIG9iamVjdCBpcyBub3QgY29ubmVjdGVkIHRvIHRoZSBPcGVuVG9rIHNlcnZlciB1bnRpbCB5b3UKICogY2FsbCB0aGUgY29ubmVjdCgpIG1ldGhvZCBvZiB0aGUgb2JqZWN0IGFuZCB0aGUgb2JqZWN0IGRpc3BhdGNoZXMgYSBjb25uZWN0ZWQgZXZlbnQuIFNlZSB7QGxpbmsgVEIuaW5pdFNlc3Npb259IGFuZCB7QGxpbmsgY29ubmVjdH0pLgogKiAgRm9yIG1vcmUgaW5mb3JtYXRpb24gb24gc2Vzc2lvbnMgYW5kIHNlc3Npb24gSURzLCBzZWUKICogPGEgaHJlZj0iL29wZW50b2svdHV0b3JpYWxzL2NyZWF0ZS1zZXNzaW9uLyI+U2Vzc2lvbiBjcmVhdGlvbjwvYT4uCiAqLwpPVC5TZXNzaW9uID0gZnVuY3Rpb24oc2Vzc2lvbklkKSB7CiAgLy8gQ2hlY2sgdGhhdCB0aGUgY2xpZW50IG1lZXRzIHRoZSBtaW5pbXVtIHJlcXVpcmVtZW50cywgaWYgdGhleSBkb24ndCB0aGUgdXBncmFkZQogIC8vIGZsb3cgd2lsbCBiZSB0cmlnZ2VyZWQuCiAgaWYgKCFPVC5jaGVja1N5c3RlbVJlcXVpcmVtZW50cygpKSB7CiAgICAgIE9ULnVwZ3JhZGVTeXN0ZW1SZXF1aXJlbWVudHMoKTsKICAgICAgcmV0dXJuOwogIH0KCiAgdmFyIF9pbml0aWFsQ29ubmVjdGlvbiA9IHRydWUsCiAgICAgIF9hcGlLZXksCiAgICAgIF90b2tlbiwKICAgICAgX3Nlc3Npb25JZCA9IHNlc3Npb25JZCwKICAgICAgX3NvY2tldCwKICAgICAgX3dpZGdldElkID0gT1QuJC51dWlkKCksCiAgICAgIF9hbmFseXRpY3MgPSBuZXcgT1QuQW5hbHl0aWNzKCksCiAgICAgIF9jYWxsYmFja3MgPSB7CiAgICAgICAgZm9yY2VEaXNjb25uZWN0OiB7fSwKICAgICAgICBmb3JjZVVucHVibGlzaDoge30KICAgICAgfTsKCgogIE9ULiQuZXZlbnRpbmcodGhpcyk7CiAgdmFyIHNldFN0YXRlID0gT1QuJC5zdGF0YWJsZSh0aGlzLCBbJ2Rpc2Nvbm5lY3RlZCcsICdjb25uZWN0aW5nJywgJ2Nvbm5lY3RlZCcsICdkaXNjb25uZWN0aW5nJ10sICdkaXNjb25uZWN0ZWQnKTsKCiAgdGhpcy5jb25uZWN0aW9ucyA9IG5ldyBPVC5Db2xsZWN0aW9uKCk7CiAgdGhpcy5zdHJlYW1zID0gbmV3IE9ULkNvbGxlY3Rpb24oKTsKCgogIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyAgTUVTU0FHRSBIQU5ETEVSUwogIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgdmFyCiAgLy8gVGhlIGR1cGxpY2F0aW9uIG9mIHRoaXMgYW5kIHNlc3Npb25Db25uZWN0aW9uRmFpbGVkIHdpbGwgZ28gYXdheSB3aGVuCiAgLy8gc2Vzc2lvbiBhbmQgbWVzc2VuZ2VyIGFyZSByZWZhY3RvcmVkCiAgc2Vzc2lvbkNvbm5lY3RGYWlsZWQgPSBmdW5jdGlvbihyZWFzb24sIGNvZGUpIHsKICAgIHNldFN0YXRlKCdkaXNjb25uZWN0ZWQnKTsKCiAgICBPVC5lcnJvcihyZWFzb24pOwoKICAgIHRoaXMudHJpZ2dlcignc2Vzc2lvbkNvbm5lY3RGYWlsZWQnLCByZWFzb24pOwoKICAgIFRCLmhhbmRsZUpzRXhjZXB0aW9uKHJlYXNvbiwgY29kZSB8fCBPVC5FeGNlcHRpb25Db2Rlcy5DT05ORUNUX0ZBSUxFRCwgewogICAgICBzZXNzaW9uOiB0aGlzCiAgICB9KTsKICB9LAoKICBzZXNzaW9uRGlzY29ubmVjdGVkSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgcmVhc29uID0gZXZlbnQucmVhc29uOwogICAgaWYocmVhc29uID09ICJuZXR3b3JrVGltZWRvdXQiKSB7CiAgICAgIHJlYXNvbiA9ICJuZXR3b3JrRGlzY29ubmVjdGVkIjsKICAgICAgdGhpcy5sb2dFdmVudCgnd2ViU29ja2V0Q29ubmVjdGlvbicsICdUaW1lT3V0RGlzY29ubmVjdCcsICJyZWFzb24iLCBldmVudC5yZWFzb24pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5sb2dFdmVudCgnd2ViU29ja2V0Q29ubmVjdGlvbicsICdEaXNjb25uZWN0ZWQnLCAicmVhc29uIiwgZXZlbnQucmVhc29uKTsKICAgIH0KCiAgICB2YXIgcHVibGljRXZlbnQgPSBuZXcgT1QuU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudCgnc2Vzc2lvbkRpc2Nvbm5lY3RlZCcsIHJlYXNvbik7CgogICAgcmVzZXQuY2FsbCh0aGlzKTsKICAgIGRpc2Nvbm5lY3RDb21wb25lbnRzLmNhbGwodGhpcyk7CgogICAgdmFyIGRlZmF1bHRBY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFwdWJsaWNFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgZGVzdHJveUNvbXBvbmVudHMuY2FsbCh0aGlzLCBwdWJsaWNFdmVudC5yZWFzb24pOwogICAgfS5iaW5kKHRoaXMpOwoKICAgIHRoaXMuZGlzcGF0Y2hFdmVudChwdWJsaWNFdmVudCwgZGVmYXVsdEFjdGlvbik7CiAgfSwKCiAgY29ubmVjdGlvbkNyZWF0ZWRIYW5kbGVyID0gZnVuY3Rpb24oY29ubmVjdGlvbikgewogICAgLy8gV2UgZG9uJ3QgYnJvYWRjYXN0IGV2ZW50cyBmb3IgdGhlIHN5bXBob255IGNvbm5lY3Rpb24KICAgIGlmIChjb25uZWN0aW9uLmlkLm1hdGNoKC9ec3ltcGhvbnlcLi8pKSByZXR1cm47CgogICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBPVC5Db25uZWN0aW9uRXZlbnQoCiAgICAgICAgT1QuRXZlbnQubmFtZXMuQ09OTkVDVElPTl9DUkVBVEVELAogICAgICAgIFtjb25uZWN0aW9uXQogICAgKSk7CiAgfSwKCiAgY29ubmVjdGlvbkRlc3Ryb3llZEhhbmRsZXIgPSBmdW5jdGlvbihjb25uZWN0aW9uLCByZWFzb24pIHsKICAgIC8vIFdlIGRvbid0IGJyb2FkY2FzdCBldmVudHMgZm9yIHRoZSBzeW1waG9ueSBjb25uZWN0aW9uCiAgICBpZiAoY29ubmVjdGlvbi5pZC5tYXRjaCgvXnN5bXBob255XC4vKSkgcmV0dXJuOwoKICAgIC8vIERvbid0IGRlbGV0ZSB0aGUgY29ubmVjdGlvbiBpZiBpdCdzIG91cnMuIFRoaXMgb25seSBoYXBwZW5zIHdoZW4KICAgIC8vIHdlJ3JlIGFib3V0IHRvIHJlY2VpdmUgYSBzZXNzaW9uIGRpc2Nvbm5lY3RlZCBhbmQgc2Vzc2lvbiBkaXNjb25uZWN0ZWQKICAgIC8vIHdpbGwgYWxzbyBjbGVhbiB1cCBvdXIgY29ubmVjdGlvbi4KICAgIGlmIChjb25uZWN0aW9uLmlkID09PSBfc29ja2V0LmlkKSByZXR1cm47CgogICAgLy8gSGFuZGxlIHN1Y2Nlc3MgY2FsbGJhY2tzCiAgICBpZiAoX2NhbGxiYWNrcy5mb3JjZURpc2Nvbm5lY3RbY29ubmVjdGlvbi5pZF0pIHsKICAgICAgdmFyIGNhbGxiYWNrID0gX2NhbGxiYWNrcy5mb3JjZURpc2Nvbm5lY3RbY29ubmVjdGlvbi5pZF07CiAgICAgIGRlbGV0ZSBfY2FsbGJhY2tzLmZvcmNlRGlzY29ubmVjdFtjb25uZWN0aW9uLmlkXTsKCgogICAgICBpZiAocmVhc29uICE9PSAnZm9yY2VEaXNjb25uZWN0ZWQnKSB7CiAgICAgICAgT1Qud2FybigiRXhwZWN0ZWQgYSBmb3JjZURpc2Nvbm5lY3QgZm9yIGNvbm5lY3Rpb24gIiArIGNvbm5lY3Rpb24uaWQgKyAiLCBidXQgYSAiICsgcmVhc29uICsgIiB3YXMgcmVjZWl2ZWQgaW5zdGVhZC4iKTsKICAgICAgfQoKICAgICAgY2FsbGJhY2suc3VjY2VlZGVkKCk7CiAgICB9CgogICAgdGhpcy5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgT1QuQ29ubmVjdGlvbkV2ZW50KAogICAgICAgIE9ULkV2ZW50Lm5hbWVzLkNPTk5FQ1RJT05fREVTVFJPWUVELAogICAgICAgIFtjb25uZWN0aW9uXSwKICAgICAgICByZWFzb24KICAgICAgKQogICAgKTsKICB9LAoKICBzdHJlYW1DcmVhdGVkSGFuZGxlciA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBPVC5TdHJlYW1FdmVudCgKICAgICAgT1QuRXZlbnQubmFtZXMuU1RSRUFNX0NSRUFURUQsCiAgICAgIFtzdHJlYW1dCiAgICApKTsKICB9LAoKICBzdHJlYW1Qcm9wZXJ0eU1vZGlmaWVkSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgc3RyZWFtID0gZXZlbnQudGFyZ2V0LAogICAgICAgIHByb3BlcnR5TmFtZSA9IGV2ZW50LmNoYW5nZWRQcm9wZXJ0eSwKICAgICAgICBuZXdWYWx1ZSA9IGV2ZW50Lm5ld1ZhbHVlOwoKICAgIGlmIChwcm9wZXJ0eU5hbWUgPT09ICdvcmllbnRhdGlvbicpIHsKICAgICAgcHJvcGVydHlOYW1lID0gJ3ZpZGVvRGltZW5zaW9ucyc7CiAgICAgIG5ld1ZhbHVlID0ge3dpZHRoOiBuZXdWYWx1ZS53aWR0aCwgaGVpZ2h0OiBuZXdWYWx1ZS5oZWlnaHR9OwogICAgfQoKICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgT1QuU3RyZWFtUHJvcGVydHlDaGFuZ2VkRXZlbnQoCiAgICAgIE9ULkV2ZW50Lm5hbWVzLlNUUkVBTV9QUk9QRVJUWV9DSEFOR0VELAogICAgICBzdHJlYW0sCiAgICAgIHByb3BlcnR5TmFtZSwKICAgICAgZXZlbnQub2xkVmFsdWUsCiAgICAgIG5ld1ZhbHVlCiAgICApKTsKICB9LAoKICBzdHJlYW1EZXN0cm95ZWRIYW5kbGVyID0gZnVuY3Rpb24oc3RyZWFtLCByZWFzb24pIHsKICAgIC8vIEhhbmRsZSBzdWNjZXNzIGNhbGxiYWNrcwogICAgaWYgKF9jYWxsYmFja3MuZm9yY2VVbnB1Ymxpc2hbc3RyZWFtLmlkXSkgewogICAgICB2YXIgY2FsbGJhY2sgPSBfY2FsbGJhY2tzLmZvcmNlVW5wdWJsaXNoW3N0cmVhbS5pZF07CiAgICAgIGRlbGV0ZSBfY2FsbGJhY2tzLmZvcmNlVW5wdWJsaXNoW3N0cmVhbS5pZF07CgogICAgICBpZiAocmVhc29uICE9PSAnZm9yY2VVbnB1Ymxpc2hlZCcpIHsKICAgICAgICBPVC53YXJuKCJFeHBlY3RlZCBhIGZvcmNlVW5wdWJsaXNoIGZvciBzdHJlYW0gIiArIHN0cmVhbS5pZCArICIsIGJ1dCBhICIgKyByZWFzb24gKyAiIGRlc3Ryb3llZCB3YXMgcmVjZWl2ZWQgaW5zdGVhZC4iKTsKICAgICAgfQoKICAgICAgY2FsbGJhY2suc3VjY2VlZGVkKCk7CiAgICB9CgogICAgdmFyIGV2ZW50ID0gbmV3IE9ULlN0cmVhbUV2ZW50KCdzdHJlYW1EZXN0cm95ZWQnLCBbc3RyZWFtXSwgcmVhc29uKTsKCiAgICB2YXIgZGVmYXVsdEFjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7CiAgICAgICAgLy8gSWYgdGhlIHN0cmVhbSBpcyBvbmUgb2Ygb3VycyB0aGVuIHdlIG5lZWQgdG8gY2xlYW51cAogICAgICAgIC8vIGEgcHVibGlzaGVyLgogICAgICAgIHZhciBwdWJsaXNoZXIgPSBPVC5wdWJsaXNoZXJzLndoZXJlKHtzdHJlYW1JZDogc3RyZWFtLmlkfSlbMF07CiAgICAgICAgaWYgKHB1Ymxpc2hlcikgewogICAgICAgICAgcHVibGlzaGVyLl8udW5wdWJsaXNoRnJvbVNlc3Npb24odGhpcyk7CiAgICAgICAgICBwdWJsaXNoZXIuZGVzdHJveSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UgYXJlIHN1YnNjcmliZWQgdG8gYW55IG9mIHRoZSBzdHJlYW1zIHdlIHNob3VsZCB1bnN1YnNjcmliZQogICAgICAgIE9ULnN1YnNjcmliZXJzLndoZXJlKHtzdHJlYW1JZDogc3RyZWFtLmlkfSkuZm9yRWFjaChmdW5jdGlvbihzdWJzY3JpYmVyKSB7CiAgICAgICAgICBpZiAoc3Vic2NyaWJlci5zZXNzaW9uLmlkID09PSB0aGlzLmlkKSB7CiAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoc3Vic2NyaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKTsKCiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoZXZlbnQsIGRlZmF1bHRBY3Rpb24pOwogIH0sCgoKICAvLyBQdXQgb3Vyc2VsdmVzIGludG8gYSBwcmlzdGluZSBzdGF0ZQogIHJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgICBfYXBpS2V5ID0gbnVsbDsKICAgIF90b2tlbiA9IG51bGw7CiAgICBzZXRTdGF0ZSgnZGlzY29ubmVjdGVkJyk7CgogICAgdGhpcy5jb25uZWN0aW9ucy5kZXN0cm95KCk7CiAgICB0aGlzLnN0cmVhbXMuZGVzdHJveSgpOwogIH0sCgogIGRpc2Nvbm5lY3RDb21wb25lbnRzID0gZnVuY3Rpb24oKSB7CiAgICBPVC5wdWJsaXNoZXJzLndoZXJlKHtzZXNzaW9uOiB0aGlzfSkuZm9yRWFjaChmdW5jdGlvbihwdWJsaXNoZXIpIHsKICAgICAgcHVibGlzaGVyLmRpc2Nvbm5lY3QoKTsKICAgIH0pOwoKICAgIE9ULnN1YnNjcmliZXJzLndoZXJlKHtzZXNzaW9uOiB0aGlzfSkuZm9yRWFjaChmdW5jdGlvbihzdWJzY3JpYmVyKSB7CiAgICAgIHN1YnNjcmliZXIuZGlzY29ubmVjdCgpOwogICAgfSk7CiAgfSwKCiAgZGVzdHJveUNvbXBvbmVudHMgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgIE9ULnB1Ymxpc2hlcnMud2hlcmUoe3Nlc3Npb246IHRoaXN9KS5mb3JFYWNoKGZ1bmN0aW9uKHB1Ymxpc2hlcikgewogICAgICBwdWJsaXNoZXIuZGVzdHJveShyZWFzb24pOwogICAgfSk7CgogICAgT1Quc3Vic2NyaWJlcnMud2hlcmUoe3Nlc3Npb246IHRoaXN9KS5mb3JFYWNoKGZ1bmN0aW9uKHN1YnNjcmliZXIpIHsKICAgICAgc3Vic2NyaWJlci5kZXN0cm95KHJlYXNvbik7CiAgICB9KTsKICB9LAoKICBjb25uZWN0TWVzc2VuZ2VyID0gZnVuY3Rpb24oKSB7CiAgICBUQi5kZWJ1ZygiT1QuU2Vzc2lvbjogY29ubmVjdGluZyB0byBSYXB0b3IiKTsKCiAgICBfc29ja2V0ID0gbmV3IE9ULlJhcHRvci5Tb2NrZXQoX3dpZGdldElkLCB0aGlzLnNlc3Npb25JbmZvLm1lc3NhZ2luZ1NlcnZlcik7CiAgICBfc29ja2V0LmNvbm5lY3QoX3Rva2VuLCB0aGlzLnNlc3Npb25JbmZvLCBmdW5jdGlvbihlcnJvciwgc2Vzc2lvblN0YXRlKSB7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHNlc3Npb25Db25uZWN0RmFpbGVkLmNhbGwodGhpcywgZXJyb3IucmVhc29uLCBlcnJvci5jb2RlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIE9ULmRlYnVnKCJPVC5TZXNzaW9uOiBSZWNlaXZlZCBzZXNzaW9uIHN0YXRlIGZyb20gUmFwdG9yIiwgc2Vzc2lvblN0YXRlKTsKCiAgICAgIHNldFN0YXRlKCdjb25uZWN0ZWQnKTsKCiAgICAgIC8vIExpc3RlbiBmb3Igb3VyIG93biBjb25uZWN0aW9uJ3MgZGVzdHJveWVkIGV2ZW50IHNvIHdlIGtub3cgd2hlbiB3ZSd2ZSBiZWVuIGRpc2Nvbm5lY3RlZC4KICAgICAgdGhpcy5jb25uZWN0aW9uLm9uKCdkZXN0cm95ZWQnLCBzZXNzaW9uRGlzY29ubmVjdGVkSGFuZGxlciwgdGhpcyk7CgogICAgICAvLyBMaXN0ZW4gZm9yIGNvbm5lY3Rpb24gdXBkYXRlcwogICAgICB0aGlzLmNvbm5lY3Rpb25zLm9uKHsKICAgICAgICBhZGQ6IGNvbm5lY3Rpb25DcmVhdGVkSGFuZGxlciwKICAgICAgICByZW1vdmU6IGNvbm5lY3Rpb25EZXN0cm95ZWRIYW5kbGVyCiAgICAgIH0sIHRoaXMpOwoKICAgICAgLy8gTGlzdGVuIGZvciBzdHJlYW0gdXBkYXRlcwogICAgICB0aGlzLnN0cmVhbXMub24oewogICAgICAgIGFkZDogc3RyZWFtQ3JlYXRlZEhhbmRsZXIsCiAgICAgICAgcmVtb3ZlOiBzdHJlYW1EZXN0cm95ZWRIYW5kbGVyLAogICAgICAgIHVwZGF0ZTogc3RyZWFtUHJvcGVydHlNb2RpZmllZEhhbmRsZXIKICAgICAgfSwgdGhpcyk7CgogICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IE9ULlNlc3Npb25Db25uZWN0RXZlbnQoCiAgICAgICAgT1QuRXZlbnQubmFtZXMuU0VTU0lPTl9DT05ORUNURUQsCiAgICAgICAgc2Vzc2lvblN0YXRlLmNvbm5lY3Rpb25zLAogICAgICAgIHNlc3Npb25TdGF0ZS5zdHJlYW1zLAogICAgICAgIHNlc3Npb25TdGF0ZS5hcmNoaXZlcwogICAgICApKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgfSwKCiAgZ2V0U2Vzc2lvbkluZm8gPSBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmlzKCdjb25uZWN0aW5nJykpIHsKICAgICAgT1QuU2Vzc2lvbkluZm8uZ2V0KAogICAgICAgIHRoaXMsCiAgICAgICAgb25TZXNzaW9uSW5mb1Jlc3BvbnNlLmJpbmQodGhpcyksCiAgICAgICAgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgIHNlc3Npb25Db25uZWN0RmFpbGVkLmNhbGwodGhpcywgZXJyb3IubWVzc2FnZSArIChlcnJvci5jb2RlID8gJyAoJyArIGVycm9yLmNvZGUgKyAnKScgOiAnJykpOwogICAgICAgIH0uYmluZCh0aGlzKQogICAgICApOwogICAgfQogIH0sCgogIG9uU2Vzc2lvbkluZm9SZXNwb25zZSA9IGZ1bmN0aW9uKHNlc3Npb25JbmZvKSB7CiAgICBpZiAodGhpcy5pcygnY29ubmVjdGluZycpKSB7CiAgICAgIHRoaXMuc2Vzc2lvbkluZm8gPSBzZXNzaW9uSW5mbzsKICAgICAgaWYgKHRoaXMuc2Vzc2lvbkluZm8ucGFydG5lcklkICYmIHRoaXMuc2Vzc2lvbkluZm8ucGFydG5lcklkICE9IF9hcGlLZXkpIHsKICAgICAgICAgIF9hcGlLZXkgPSB0aGlzLnNlc3Npb25JbmZvLnBhcnRuZXJJZDsKCiAgICAgICAgICB2YXIgcmVhc29uID0gIkF1dGhlbnRpY2F0aW9uIEVycm9yOiBUaGUgYXBpS2V5IHBhc3NlZCBpbnRvIHRoZSBzZXNzaW9uLmNvbm5lY3QgbWV0aG9kIGRvZXMgbm90IG1hdGNoIHRoZSBhcGlLZXkgaW4gdGhlIHRva2VuIG9yIHNlc3Npb24geW91IGFyZSB0cnlpbmcgdG8gY29ubmVjdCB0by4iOwogICAgICAgICAgc2Vzc2lvbkNvbm5lY3RGYWlsZWQuY2FsbCh0aGlzLCByZWFzb24sIE9ULkV4Y2VwdGlvbkNvZGVzLkFVVEhFTlRJQ0FUSU9OX0VSUk9SKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3RNZXNzZW5nZXIuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfQogIH0sCgogIC8vIENoZWNrIHdoZXRoZXIgd2UgaGF2ZSBwZXJtaXNzaW9ucyB0byBwZXJmb3JtIHRoZSBhY3Rpb24uCiAgcGVybWl0dGVkVG8gPSBmdW5jdGlvbihhY3Rpb24pIHsKICAgICAgcmV0dXJuIF9zb2NrZXQgJiYgX3NvY2tldC5wZXJtaXR0ZWRUbyhhY3Rpb24pOwogIH07CgogIHRoaXMubG9nRXZlbnQgPSBmdW5jdGlvbihhY3Rpb24sIHZhcmlhdGlvbiwgcGF5bG9hZF90eXBlLCBwYXlsb2FkKSB7CiAgICBfYW5hbHl0aWNzLmxvZ0V2ZW50KHsKICAgICAgYWN0aW9uOiBhY3Rpb24sCiAgICAgIHZhcmlhdGlvbjogdmFyaWF0aW9uLAogICAgICBwYXlsb2FkX3R5cGU6IHBheWxvYWRfdHlwZSwKICAgICAgcGF5bG9hZDogcGF5bG9hZCwKICAgICAgc2Vzc2lvbl9pZDogX3Nlc3Npb25JZCwKICAgICAgcGFydG5lcl9pZDogX2FwaUtleSwKICAgICAgd2lkZ2V0X2lkOiBfd2lkZ2V0SWQsCiAgICAgIHdpZGdldF90eXBlOiAnQ29udHJvbGxlcicKICAgIH0pOwogIH07CgogLyoqCiAqIENvbm5lY3RzIHRvIGFuIE9wZW5Ub2sgc2Vzc2lvbi4gUGFzcyB5b3VyIEFQSSBrZXkgYXMgdGhlIDxjb2RlPmFwaUtleTwvY29kZT4gcGFyYW1ldGVyLiBZb3UgZ2V0IGFuIEFQSSBrZXkgd2hlbiB5b3UKICogPGEgaHJlZj0iaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS91c2Vycy9zaWduX2luIj5zaWduIHVwPC9hPiBmb3IgYW4gT3BlblRvayBhY2NvdW50LiBQYXNzIGEgdG9rZW4gc3RyaW5nIGFzCiAqIHRoZSA8Y29kZT50b2tlbjwvY29kZT4gcGFyYW1ldGVyLiBZb3UgZ2VuZXJhdGUgYSB0b2tlbiB1c2luZyB0aGUKICogPGEgaHJlZj0iL29wZW50b2svYXBpL3Rvb2xzL2RvY3VtZW50YXRpb24vYXBpL3NlcnZlcl9zaWRlX2xpYnJhcmllcy5odG1sIj5PcGVuVG9rIHNlcnZlci1zaWRlIGxpYnJhcmllczwvYT4KICogb3IgdGhlIDxhIGhyZWY9Imh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMiPkRhc2hib2FyZDwvYT4gcGFnZS4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZQogKiA8YSBocmVmPSIvb3BlbnRvay90dXRvcmlhbHMvY3JlYXRlLXRva2VuLyI+Q29ubmVjdGlvbiB0b2tlbiBjcmVhdGlvbjwvYT4uCiAqICA8cD4KICogICAgVXBvbiBhIHN1Y2Nlc3NmdWwgY29ubmVjdGlvbiwgdGhlIFNlc3Npb24gb2JqZWN0IGRpc3BhdGNoZXMgYSA8Y29kZT5zZXNzaW9uQ29ubmVjdGVkPC9jb2RlPiBldmVudC4gQ2FsbCB0aGUKICogPGNvZGU+YWRkRXZlbnRMaXN0ZW5lcigpPC9jb2RlPiBtZXRob2QgdG8gc2V0IHVwIGFuIGV2ZW50IGxpc3RlbmVyIHRvIHByb2Nlc3MgdGhpcyBldmVudCBiZWZvcmUgY2FsbGluZyBvdGhlciBtZXRob2RzIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4KICogIDwvcD4KICogIDxwPgogKiAgICBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPmNvbm5lY3Rpb25DcmVhdGVkPC9jb2RlPiBldmVudCB3aGVuIG90aGVyIGNsaWVudHMgY3JlYXRlIGNvbm5lY3Rpb25zIHRvIHRoZSBzZXNzaW9uLgogKiAgPC9wPgogKiAgPHA+CiAqICAgIFRoZSBUQiBvYmplY3QgZGlzcGF0Y2hlcyBhbiA8Y29kZT5leGNlcHRpb248L2NvZGU+IGV2ZW50IGlmIHRoZSBzZXNzaW9uIElELAogKiAgICBBUEkga2V5LCBvciB0b2tlbiBzdHJpbmcgYXJlIGludmFsaWQuIFNlZSA8YSBocmVmPSJFeGNlcHRpb25FdmVudC5odG1sIj5FeGNlcHRpb25FdmVudDwvYT4KICogICAgYW5kIDxhIGhyZWY9IlRCLmh0bWwjYWRkRXZlbnRMaXN0ZW5lciI+VEIuYWRkRXZlbnRMaXN0ZW5lcigpPC9hPi4KICogIDwvcD4KICogIDxwPgogKiAgICBUaGUgYXBwbGljYXRpb24gdGhyb3dzIGFuIGVycm9yIGlmIHRoZSBzeXN0ZW0gcmVxdWlyZW1lbnRzIGFyZSBub3QgbWV0CiAqICAgIChzZWUgPGEgaHJlZj0iVEIuaHRtbCNjaGVja1N5c3RlbVJlcXVpcmVtZW50cyI+VEIuY2hlY2tTeXN0ZW1SZXF1aXJlbWVudHMoKTwvYT4pLgogKiAgICBUaGUgYXBwbGljYXRpb24gYWxzbyB0aHJvd3MgYW4gZXJyb3IgaWYgdGhlIHNlc3Npb24gaGFzIHBlZXItdG8tcGVlciBzdHJlYW1pbmcgZW5hYmxlZAogKiAgICBhbmQgdHdvIGNsaWVudHMgYXJlIGFscmVhZHkgY29ubmVjdGVkIHRvIHRoZSBzZXNzaW9uIChzZWUgb3VyCiAqICAgIDxhIGhyZWY9Ii9vcGVudG9rL2xpYnJhcmllcy9zZXJ2ZXIvIj5zZXJ2ZXItc2lkZSBsaWJyYXJpZXM8L2E+KS4KICogIDwvcD4KICoKICogPHA+CiAqICBXaXRoIHRoZSBwZWVyLXRvLXBlZXIgb3B0aW9uIGVuYWJsZWQgZm9yIGEgc2Vzc2lvbiwgdGhlIHNlc3Npb24gc3VwcG9ydHMgdHdvIGNvbm5lY3Rpb25zLiBXaXRob3V0IHRoZSBwZWVyLXRvLXBlZXIgb3B0aW9uCiAqICBlbmFibGVkLCB0aGUgc2Vzc2lvbiBzdXBwb3J0cyB1cCB0byBmb3VyIGNvbm5lY3Rpb25zLiBPbiBjbGllbnRzIHRoYXQgYXR0ZW1wdCB0byBhIHNlc3Npb24gdGhhdCBhbHJlYWR5IGhhcyB0aGUgbWF4aW11bQogKiAgbnVtYmVyIG9mIGNvbm5lY3Rpb25zLCB0aGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgYW4gYGV4Y2VwdGlvbmAgZXZlbnQgKHdpdGggdGhlIGBjb2RlYCBwcm9wZXJ0eSBzZXQgdG8gMTAwNykuIFNlZQogKiAgPGEgaHJlZj0iL29wZW50b2svdHV0b3JpYWxzL2NyZWF0ZS1zZXNzaW9uLyI+U2Vzc2lvbiBDcmVhdGlvbiBkb2N1bWVudGF0aW9uPC9hPi4KICogPC9wPgogKgogKgogKiAgPGg1PgogKiAgRXhhbXBsZQogKiAgPC9oNT4KICogIDxwPgogKiAgVGhlIGZvbGxvd2luZyBjb2RlIGluaXRpYWxpemVzIGEgc2Vzc2lvbiBhbmQgc2V0cyB1cCBhbiBldmVudCBsaXN0ZW5lciBmb3Igd2hlbiB0aGUgc2Vzc2lvbiBjb25uZWN0czoKICogIDwvcD4KICogIDxwcmU+CiAqICB2YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAqICB2YXIgc2Vzc2lvbklEID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIG93biBzZXNzaW9uIElELgogKiAgICAgICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKiAgdmFyIHRva2VuID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCBhIGdlbmVyYXRlZCB0b2tlbiB0aGF0IGhhcyBiZWVuIGFzc2lnbmVkIHRoZSBtb2RlcmF0b3Igcm9sZS4KICogICAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogKgogKiAgdmFyIHNlc3Npb24gPSBUQi5pbml0U2Vzc2lvbihzZXNzaW9uSUQpOwogKiAgc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzZXNzaW9uQ29ubmVjdGVkIiwgc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKTsKICogIHNlc3Npb24uY29ubmVjdChhcGlLZXksIHRva2VuKTsKICoKICogIGZ1bmN0aW9uIHNlc3Npb25Db25uZWN0SGFuZGxlcihzZXNzaW9uQ29ubmVjdEV2ZW50KSB7CiAqICAgICAgLy8KICogIH0KICogIDwvcHJlPgogKiAgPHA+CiAqICA8cD4KICogICAgSW4gdGhpcyBleGFtcGxlLCB0aGUgPGNvZGU+c2Vzc2lvbkNvbm5lY3RIYW5kbGVyKCk8L2NvZGU+IGZ1bmN0aW9uIGlzIHBhc3NlZCBhbiBldmVudCBvYmplY3Qgb2YgdHlwZSB7QGxpbmsgU2Vzc2lvbkNvbm5lY3RFdmVudH0uCiAqICA8L3A+CiAqCiAqICA8aDU+CiAqICBFdmVudHMgZGlzcGF0Y2hlZDoKICogIDwvaDU+CiAqCiAqICA8cD4KICogICAgPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiAoPGEgaHJlZj0iRXhjZXB0aW9uRXZlbnQuaHRtbCI+RXhjZXB0aW9uRXZlbnQ8L2E+KSAmIzE1MTsgRGlzcGF0Y2hlZCBieSB0aGUgVEIgY2xhc3MKICogICAgbG9jYWxseSBpbiB0aGUgZXZlbnQgb2YgYW4gZXJyb3IuCiAqICA8L3A+CiAqICA8cD4KICogICAgPGNvZGU+Y29ubmVjdGlvbkNyZWF0ZWQ8L2NvZGU+ICg8YSBocmVmPSJDb25uZWN0aW9uRXZlbnQuaHRtbCI+Q29ubmVjdGlvbkV2ZW50PC9hPikgJiMxNTE7CiAqICAgICAgRGlzcGF0Y2hlZCBieSB0aGUgU2Vzc2lvbiBvYmplY3Qgb24gYWxsIGNsaWVudHMgY29ubmVjdGVkIHRvIHRoZSBzZXNzaW9uLgogKiAgPC9wPgogKiAgPHA+CiAqICAgIDxjb2RlPnNlc3Npb25Db25uZWN0ZWQ8L2NvZGU+ICg8YSBocmVmPSJTZXNzaW9uQ29ubmVjdEV2ZW50Lmh0bWwiPlNlc3Npb25Db25uZWN0RXZlbnQ8L2E+KSAmIzE1MTsKICogICAgICBEaXNwYXRjaGVkIGxvY2FsbHkgYnkgdGhlIFNlc3Npb24gb2JqZWN0IHdoZW4gdGhlIGNvbm5lY3Rpb24gaXMgZXN0YWJsaXNoZWQuCiAqICA8L3A+CiAqCiAgKiBAcGFyYW0ge1N0cmluZ30gYXBpS2V5IFRoZSBBUEkga2V5IHRoYXQgVG9rQm94IHByb3ZpZGVkIHlvdSB3aGVuIHlvdSByZWdpc3RlcmVkIGZvciB0aGUgT3BlblRvayBBUEkuCiAgKgogICogQHBhcmFtIHtTdHJpbmd9IHRva2VuIFRoZSBzZXNzaW9uIHRva2VuLiBZb3UgZ2VuZXJhdGUgYSBzZXNzaW9uIHRva2VuIHVzaW5nIG91cgogICogPGEgaHJlZj0iL29wZW50b2svbGlicmFyaWVzL3NlcnZlci8iPnNlcnZlci1zaWRlIGxpYnJhcmllczwvYT4gb3IgdGhlCiAgKiA8YSBocmVmPSJodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzIj5EYXNoYm9hcmQ8L2E+IHBhZ2UuIEZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWUKICAqIDxhIGhyZWY9Ii9vcGVudG9rL3R1dG9yaWFscy9jcmVhdGUtdG9rZW4vIj5Db25uZWN0aW9uIHRva2VuIGNyZWF0aW9uPC9hPi4KICAqCiAgKiBAbWV0aG9kICNjb25uZWN0CiAgKiBAbWVtYmVyT2YgU2Vzc2lvbgogICovCiAgdGhpcy5jb25uZWN0ID0gZnVuY3Rpb24oYXBpS2V5LCB0b2tlbiwgY29tcGxldGlvbkhhbmRsZXIpIHsKICAgIGlmICh0aGlzLmlzKCdjb25uZWN0aW5nJywgJ2Nvbm5lY3RlZCcpKSB7CiAgICAgIE9ULndhcm4oIk9ULlNlc3Npb246IENhbm5vdCBjb25uZWN0LCB0aGUgc2Vzc2lvbiBpcyBhbHJlYWR5ICIgKyB0aGlzLnN0YXRlKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHJlc2V0LmNhbGwodGhpcyk7CiAgICBzZXRTdGF0ZSgnY29ubmVjdGluZycpOwogICAgX3Rva2VuID0gdG9rZW47CgogICAgLy8gR2V0IGEgbmV3IHdpZGdldCBJRCB3aGVuIHJlY29ubmVjdGluZy4KICAgIGlmIChfaW5pdGlhbENvbm5lY3Rpb24pIHsKICAgICAgX2luaXRpYWxDb25uZWN0aW9uID0gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICBfd2lkZ2V0SWQgPSBPVC4kLnV1aWQoKTsKICAgIH0KCiAgICBfYXBpS2V5ID0gYXBpS2V5LnRvU3RyaW5nKCk7CgogICAgLy8gVWdseSBoYWNrLCBtYWtlIHN1cmUgT1QuQVBJS0VZIGlzIHNldAogICAgaWYgKE9ULkFQSUtFWS5sZW5ndGggPT09IDApIHsKICAgICAgICBPVC5BUElLRVkgPSBfYXBpS2V5OwogICAgfQoKICAgIGlmIChjb21wbGV0aW9uSGFuZGxlciAmJiBPVC4kLmlzRnVuY3Rpb24oY29tcGxldGlvbkhhbmRsZXIpKSB7CiAgICAgIHRoaXMub25jZShPVC5FdmVudC5uYW1lcy5TRVNTSU9OX0NPTk5FQ1RFRCwgY29tcGxldGlvbkhhbmRsZXIuYmluZChudWxsLCBudWxsKSk7CiAgICAgIHRoaXMub25jZSgnc2Vzc2lvbkNvbm5lY3RGYWlsZWQnLCBjb21wbGV0aW9uSGFuZGxlcik7CiAgICB9CgogICAgZ2V0U2Vzc2lvbkluZm8uY2FsbCh0aGlzKTsKICB9OwoKIC8qKgogICogRGlzY29ubmVjdHMgZnJvbSB0aGUgT3BlblRvayBzZXNzaW9uLgogICoKICAqIDxwPgogICogQ2FsbGluZyB0aGUgPGNvZGU+ZGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2QgZW5kcyB5b3VyIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2Vzc2lvbi4gSW4gdGhlIGNvdXJzZSBvZiB0ZXJtaW5hdGluZyB5b3VyIGNvbm5lY3Rpb24sCiAgKiBpdCBhbHNvIGNlYXNlcyBwdWJsaXNoaW5nIGFueSBzdHJlYW0ocykgeW91IHdlcmUgcHVibGlzaGluZy4KICAqIDwvcD4KICAqIDxwPgogICogU2Vzc2lvbiBvYmplY3RzIG9uIHJlbW90ZSBjbGllbnRzIGRpc3BhdGNoIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gZXZlbnRzIGZvciBhbnkgc3RyZWFtIHlvdSB3ZXJlIHB1Ymxpc2hpbmcuCiAgKiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyBhIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0ZWQ8L2NvZGU+IGV2ZW50IGxvY2FsbHkuIFRoZSBTZXNzaW9uIG9iamVjdHMgb24gcmVtb3RlIGNsaWVudHMgZGlzcGF0Y2gKICAqIDxjb2RlPmNvbm5lY3Rpb25EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50cywgbGV0dGluZyBvdGhlciBjb25uZWN0aW9ucyBrbm93IHlvdSBoYXZlIGxlZnQgdGhlIHNlc3Npb24uIFRoZSB7QGxpbmsgU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudH0KICAqIGFuZCB7QGxpbmsgU3RyZWFtRXZlbnR9IG9iamVjdHMgdGhhdCBkZWZpbmUgdGhlIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0PC9jb2RlPiBhbmQgPGNvZGU+Y29ubmVjdGlvbkRlc3Ryb3llZDwvY29kZT4gZXZlbnRzIGVhY2ggaGF2ZQogICogYSA8Y29kZT5yZWFzb248L2NvZGU+IHByb3BlcnR5LiBUaGUgPGNvZGU+cmVhc29uPC9jb2RlPiBwcm9wZXJ0eSBsZXRzIHRoZSBkZXZlbG9wZXIgZGV0ZXJtaW5lIHdoZXRoZXIgdGhlIGNvbm5lY3Rpb24gaXMgYmVpbmcKICAqIHRlcm1pbmF0ZWQgdm9sdW50YXJpbHkgYW5kIHdoZXRoZXIgYW55IHN0cmVhbXMgYXJlIGJlaW5nIGRlc3Ryb3llZCBhcyBhIGJ5cHJvZHVjdCBvZiB0aGUgdW5kZXJseWluZyBjb25uZWN0aW9uJ3Mgdm9sdW50YXJ5IGRlc3RydWN0aW9uLgogICogPC9wPgogICogPHA+CiAgKiBJZiB0aGUgc2Vzc2lvbiBpcyBub3QgY3VycmVudGx5IGNvbm5lY3RlZCwgY2FsbGluZyB0aGlzIG1ldGhvZCBjYXVzZXMgYSB3YXJuaW5nIHRvIGJlIGxvZ2dlZC4KICAqIFNlZSA8YSAiaHJlZj1UQi5odG1sI3NldExvZ0xldmVsIj5UQi5zZXRMb2dMZXZlbCgpPC9hPi4KICAqIDwvcD4KICAqCiAgKiA8cD4KICAqIDxpPk5vdGU6PC9pPiBJZiB5b3UgaW50ZW5kIHRvIHJldXNlIGEgUHVibGlzaGVyIG9iamVjdCBjcmVhdGVkIHVzaW5nIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4KICAqIHRvIHB1Ymxpc2ggdG8gZGlmZmVyZW50IHNlc3Npb25zIHNlcXVlbnRpYWxseSwgY2FsbCBlaXRoZXIgPGNvZGU+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2NvZGU+IG9yCiAgKiA8Y29kZT5TZXNzaW9uLnVucHVibGlzaCgpPC9jb2RlPi4gRG8gbm90IGNhbGwgYm90aC4gVGhlbiBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2QKICAqIG9mIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IG9yIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0ZWQ8L2NvZGU+IGV2ZW50IG9iamVjdCB0byBwcmV2ZW50IHRoZQogICogUHVibGlzaGVyIG9iamVjdCBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcGFnZS4gQmUgc3VyZSB0byBjYWxsIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+IG9ubHkKICAqIGlmIHRoZSA8Y29kZT5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgb2YgdGhlIFN0cmVhbSBvYmplY3QgaW4gdGhlIGV2ZW50IG1hdGNoZXMgdGhlCiAgKiA8Y29kZT5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgb2YgeW91ciBTZXNzaW9uIG9iamVjdCAodG8gZW5zdXJlIHRoYXQgeW91IGFyZSBwcmV2ZW50aW5nCiAgKiB0aGUgZGVmYXVsdCBiZWhhdmlvciBmb3IgeW91ciBwdWJsaXNoZWQgc3RyZWFtcywgbm90IGZvciBvdGhlciBzdHJlYW1zIHRoYXQgeW91IHN1YnNjcmliZSB0bykuCiAgKiA8L3A+CiAgKgogICogPGg1PgogICogRXZlbnRzIGRpc3BhdGNoZWQ6CiAgKiA8L2g1PgogICogPHA+CiAgKiA8Y29kZT5zZXNzaW9uRGlzY29ubmVjdGVkPC9jb2RlPiAoPGEgaHJlZj0iU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudC5odG1sIj5TZXNzaW9uRGlzY29ubmVjdEV2ZW50PC9hPikKICAqICYjMTUxOyBEaXNwYXRjaGVkIGxvY2FsbHkgd2hlbiB0aGUgY29ubmVjdGlvbiBpcyBkaXNjb25uZWN0ZWQuCiAgKiA8L3A+CiAgKiA8cD4KICAqIDxjb2RlPmNvbm5lY3Rpb25EZXN0cm95ZWQ8L2NvZGU+ICg8YSBocmVmPSJDb25uZWN0aW9uRXZlbnQuaHRtbCI+Q29ubmVjdGlvbkV2ZW50PC9hPikgJiMxNTE7CiAgKiBEaXNwYXRjaGVkIG9uIG90aGVyIGNvbm5lY3Rpb25zLCBhbG9uZyB3aXRoIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50IChhcyB3YXJyYW50ZWQpLgogICogPC9wPgogICoKICAqIDxwPgogICogPGNvZGU+c3RyZWFtRGVzdHJveWVkPC9jb2RlPiAoPGEgaHJlZj0iU3RyZWFtRXZlbnQuaHRtbCI+U3RyZWFtRXZlbnQ8L2E+KSAmIzE1MTsKICAqIERpc3BhdGNoZWQgaWYgc3RyZWFtcyBhcmUgbG9zdCBhcyBhIHJlc3VsdCBvZiB0aGUgc2Vzc2lvbiBkaXNjb25uZWN0aW5nLgogICogPC9wPgogICoKICAqIEBtZXRob2QgI2Rpc2Nvbm5lY3QKICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLmRpc2Nvbm5lY3QgPSBmdW5jdGlvbigpIHsKICAgIGlmIChfc29ja2V0ICYmIF9zb2NrZXQuaXNOb3QoJ2Rpc2Nvbm5lY3RlZCcpKSB7CiAgICAgIHNldFN0YXRlKCdkaXNjb25uZWN0aW5nJyk7CiAgICAgIF9zb2NrZXQuZGlzY29ubmVjdCgpOwogICAgfQogICAgZWxzZSB7CiAgICAgIHJlc2V0LmNhbGwodGhpcyk7CiAgICB9CiAgfTsKCiAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24ocmVhc29uLCBxdWlldCkgewogICAgdGhpcy5zdHJlYW1zLmRlc3Ryb3koKTsKICAgIHRoaXMuY29ubmVjdGlvbnMuZGVzdHJveSgpOwogICAgdGhpcy5kaXNjb25uZWN0KCk7CiAgfTsKCiAvKioKICAqIFRoZSA8Y29kZT5wdWJsaXNoKCk8L2NvZGU+IG1ldGhvZCBzdGFydHMgcHVibGlzaGluZyBhbiBhdWRpby12aWRlbyBzdHJlYW0gdG8gdGhlIHNlc3Npb24uCiAgKiBUaGUgYXVkaW8tdmlkZW8gc3RyZWFtIGlzIGNhcHR1cmVkIGZyb20gYSBsb2NhbCBtaWNyb3Bob25lIGFuZCB3ZWJjYW0uIFVwb24gc3VjY2Vzc2Z1bCBwdWJsaXNoaW5nLAogICogdGhlIFNlc3Npb24gb2JqZWN0cyBvbiBhbGwgY29ubmVjdGVkIGNsaWVudHMgZGlzcGF0Y2ggdGhlIDxjb2RlPnN0cmVhbUNyZWF0ZWQ8L2NvZGU+IGV2ZW50LgogICogPC9wPgogICoKICAqIDwhLS1KUy1PTkxZLS0+CiAgKiA8cD5Zb3UgcGFzcyBhIFB1Ymxpc2hlciBvYmplY3QgYXMgdGhlIG9uZSBwYXJhbWV0ZXIgb2YgdGhlIG1ldGhvZC4gWW91IGNhbiBpbml0aWFsaXplIGEgUHVibGlzaGVyIG9iamVjdCBieSBjYWxsaW5nIHRoZQogICogPGEgaHJlZj0iVEIuaHRtbCNpbml0UHVibGlzaGVyIj5UQi5pbml0UHVibGlzaGVyKCk8L2E+IG1ldGhvZC4gQmVmb3JlIGNhbGxpbmcgPGNvZGU+U2Vzc2lvbi5wdWJsaXNoKCk8L2NvZGU+LgogICogPC9wPgogICoKICAqIDxwPlRoaXMgbWV0aG9kIHRha2VzIGFuIGFsdGVybmF0ZSBmb3JtOiA8Y29kZT5wdWJsaXNoKFt0YXJnZXRFbGVtZW50OlN0cmluZywgcHJvcGVydGllczpPYmplY3RdKTpQdWJsaXNoZXI8L2NvZGU+ICYjMTUxOwogICogSW4gdGhpcyBmb3JtLCB5b3UgZG8gPGk+bm90PC9pPiBwYXNzIGEgUHVibGlzaGVyIG9iamVjdCBpbnRvIHRoZSBmdW5jdGlvbi4gSW5zdGVhZCwgeW91IHBhc3MgaW4gYSA8Y29kZT50YXJnZXRFbGVtZW50PC9jb2RlPgogICogKHRoZSBJRCBvZiB0aGUgRE9NIGVsZW1lbnQgdGhhdCB0aGUgUHVibGlzaGVyIHdpbGwgcmVwbGFjZSkgYW5kIGEgPGNvZGU+cHJvcGVydGllczwvY29kZT4gb2JqZWN0IHRoYXQgZGVmaW5lcwogICogb3B0aW9ucyBmb3IgdGhlIFB1Ymxpc2hlciAoc2VlIDxhIGhyZWY9IlRCLmh0bWwjaW5pdFB1Ymxpc2hlciI+VEIuaW5pdFB1Ymxpc2hlcigpPC9hPi4pIFRoZSBtZXRob2QKICAqIHJldHVybnMgYSBuZXcgUHVibGlzaGVyIG9iamVjdCwgd2hpY2ggc3RhcnRzIHNlbmRpbmcgYW4gYXVkaW8tdmlkZW8gc3RyZWFtIHRvIHRoZSBzZXNzaW9uLgogICogVGhlIHJlbWFpbmRlciBvZiB0aGlzIGRvY3VtZW50YXRpb24gZGVzY3JpYmVzIHRoZSBmb3JtIHRoYXQgdGFrZXMgYSBzaW5nbGUgUHVibGlzaGVyIG9iamVjdCBhcyBhIHBhcmFtZXRlci4KICAqCiAgKiA8cD4KICAqICAgQSBsb2NhbCBkaXNwbGF5IG9mIHRoZSBwdWJsaXNoZWQgc3RyZWFtIGlzIGNyZWF0ZWQgb24gdGhlIHdlYiBwYWdlIGJ5IHJlcGxhY2luZwogICogICAgICAgICB0aGUgc3BlY2lmaWVkIGVsZW1lbnQgaW4gdGhlIERPTSB3aXRoIGEgc3RyZWFtaW5nIHZpZGVvIGRpc3BsYXkuIFRoZSB2aWRlbyBzdHJlYW0KICAqICAgICAgICAgaXMgYXV0b21hdGljYWxseSBtaXJyb3JlZCBob3Jpem9udGFsbHkgc28gdGhhdCB1c2VycyBzZWUgdGhlbXNlbHZlcyBhbmQgbW92ZW1lbnQKICAqICAgICAgICAgaW4gdGhlaXIgc3RyZWFtIGluIGEgbmF0dXJhbCB3YXkuIElmIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBkaXNwbGF5IGRvIG5vdCBtYXRjaAogICogICAgICAgICB0aGUgNDozIGFzcGVjdCByYXRpbyBvZiB0aGUgdmlkZW8gc2lnbmFsLCB0aGUgdmlkZW8gc3RyZWFtIGlzIGNyb3BwZWQgdG8gZml0IHRoZSBkaXNwbGF5LgogICogPC9wPgogICoKICAqIDxwPgogICogICBJZiBjYWxsaW5nIHRoaXMgbWV0aG9kIGNyZWF0ZXMgYSBuZXcgUHVibGlzaGVyIG9iamVjdCBhbmQgdGhlIE9wZW5Ub2sgbGlicmFyeSBkb2VzIG5vdCBoYXZlIGFjY2VzcyB0bwogICogICB0aGUgY2FtZXJhIG9yIG1pY3JvcGhvbmUsIHRoZSB3ZWIgcGFnZSBhbGVydHMgdGhlIHVzZXIgdG8gZ3JhbnQgYWNjZXNzIHRvIHRoZSBjYW1lcmEgYW5kIG1pY3JvcGhvbmUuCiAgKiA8L3A+CiAgKgogICogPHA+CiAgKiBUaGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgYW4gPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudCBpZiB0aGUgdXNlcidzIHJvbGUgZG9lcyBub3QKICAqIGluY2x1ZGUgcGVybWlzc2lvbnMgcmVxdWlyZWQgdG8gcHVibGlzaC4gRm9yIGV4YW1wbGUsIGlmIHRoZSB1c2VyJ3Mgcm9sZSBpcyBzZXQgdG8gc3Vic2NyaWJlciwKICAqIHRoZW4gdGhleSBjYW5ub3QgcHVibGlzaC4gWW91IGRlZmluZSBhIHVzZXIncyByb2xlIHdoZW4geW91IGNyZWF0ZSB0aGUgdXNlciB0b2tlbiB1c2luZyB0aGUgPGNvZGU+Z2VuZXJhdGVfdG9rZW4oKTwvY29kZT4gbWV0aG9kCiAgKiBvZiBvdXIgPGEgaHJlZj0iL29wZW50b2svbGlicmFyaWVzL3NlcnZlci8iPnNlcnZlci1zaWRlIGxpYnJhcmllczwvYT4gb3IgdGhlIDxhIGhyZWY9Imh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMiPkRhc2hib2FyZDwvYT4gcGFnZS4KICAqIFlvdSBwYXNzIHRoZSB0b2tlbiBzdHJpbmcgYXMgYSBwYXJhbWV0ZXIgb2YgdGhlIDxjb2RlPmNvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4KICAqIFNlZSA8YSBocmVmPSJFeGNlcHRpb25FdmVudC5odG1sIj5FeGNlcHRpb25FdmVudDwvYT4gYW5kIDxhIGhyZWY9IlRCLmh0bWwjYWRkRXZlbnRMaXN0ZW5lciI+VEIuYWRkRXZlbnRMaXN0ZW5lcigpPC9hPi4KICAqIDwvcD4KICAqICAgICA8cD4KICAqICAgICBUaGUgYXBwbGljYXRpb24gdGhyb3dzIGFuIGVycm9yIGlmIHRoZSBzZXNzaW9uIGlzIG5vdCBjb25uZWN0ZWQuCiAgKiAgICAgPC9wPgogICoKICAqIDxoNT5FdmVudHMgZGlzcGF0Y2hlZDo8L2g1PgogICogPHA+CiAgKiA8Y29kZT5leGNlcHRpb248L2NvZGU+ICg8YSBocmVmPSJFeGNlcHRpb25FdmVudC5odG1sIj5FeGNlcHRpb25FdmVudDwvYT4pICYjMTUxOyBEaXNwYXRjaGVkIGJ5IHRoZSBUQiBvYmplY3QuIFRoaXMKICAqIGNhbiBvY2N1ciB3aGVuIHVzZXIncyByb2xlIGRvZXMgbm90IGFsbG93IHB1Ymxpc2hpbmcgKHRoZSA8Y29kZT5jb2RlPC9jb2RlPiBwcm9wZXJ0eSBvZiBldmVudCBvYmplY3QgaXMgc2V0IHRvIDE1MDApOwogICogaXQgY2FuIGFsc28gb2NjdXIgaWYgdGhlIGNvbm5lY3Rpb24gZmFpbHMgdG8gY29ubmVjdCAodGhlIDxjb2RlPmNvZGU8L2NvZGU+IHByb3BlcnR5IG9mIGV2ZW50IG9iamVjdCBpcyBzZXQgdG8gMTAxMykuCiAgKiBXZWJSVEMgaXMgYSBwZWVyLXRvLXBlZXIgcHJvdG9jb2wsIGFuZCBpdCBpcyBwb3NzaWJsZSB0aGF0IGNvbm5lY3Rpb25zIHdpbGwgZmFpbCB0byBjb25uZWN0LiBUaGUgbW9zdCBjb21tb24gY2F1c2UKICAqIGZvciBmYWlsdXJlIGlzIGEgZmlyZXdhbGwgdGhhdCB0aGUgcHJvdG9jb2wgY2Fubm90IHRyYXZlcnNlLjwvbGk+CiAgKiA8L3A+CiAgKiA8cD4KICAqIDxjb2RlPnN0cmVhbUNyZWF0ZWQ8L2NvZGU+ICg8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sIj5TdHJlYW1FdmVudDwvYT4pICYjMTUxOwogICogVGhlIHN0cmVhbSBoYXMgYmVlbiBwdWJsaXNoZWQuIFRoZSBTZXNzaW9uIG9iamVjdCBkaXNwYXRjaGVzIHRoaXMgb24gYWxsIGNsaWVudHMKICAqIHN1YnNjcmliZWQgdG8gdGhlIHN0cmVhbSwgYXMgd2VsbCBhcyBvbiB0aGUgcHVibGlzaGVyJ3MgY2xpZW50LgogICogPC9wPgogICoKICAqIDxoNT5FeGFtcGxlPC9oNT4KICAqCiAgKiA8cD4KICAqICAgVGhlIGZvbGxvd2luZyBleGFtcGxlIHB1Ymxpc2hlcyBhIHZpZGVvIG9uY2UgdGhlIHNlc3Npb24gY29ubmVjdHM6CiAgKiA8L3A+CiAgKiA8cHJlPgogICogdmFyIGFwaUtleSA9ICIiOyAvLyBSZXBsYWNlIHdpdGggeW91ciBBUEkga2V5LiBTZWUgaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cwogICogdmFyIHNlc3Npb25JZCA9ICIiOyAvLyBSZXBsYWNlIHdpdGggeW91ciBvd24gc2Vzc2lvbiBJRC4KICAqICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICAqIHZhciB0b2tlbiA9ICIiOyAvLyBSZXBsYWNlIHdpdGggYSBnZW5lcmF0ZWQgdG9rZW4gdGhhdCBoYXMgYmVlbiBhc3NpZ25lZCB0aGUgbW9kZXJhdG9yIHJvbGUuCiAgKiAgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICAqIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigic2Vzc2lvbkNvbm5lY3RlZCIsIHNlc3Npb25Db25uZWN0SGFuZGxlcik7CiAgKiBzZXNzaW9uLmNvbm5lY3QoYXBpS2V5LCB0b2tlbik7CiAgKgogICogZnVuY3Rpb24gc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKGV2ZW50KSB7CiAgKiAgICAgdmFyIGRpdlByb3BzID0ge3dpZHRoOiA0MDAsIGhlaWdodDozMDAsIG5hbWU6IkJvYidzIHN0cmVhbSJ9OwogICogICAgIHB1Ymxpc2hlciA9IFRCLmluaXRQdWJsaXNoZXIoYXBpS2V5LCAncHVibGlzaGVyJywgZGl2UHJvcHMpOwogICogICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXNzdW1lcyB0aGF0IHRoZXJlIGlzIGEgRE9NIGVsZW1lbnQgd2l0aCB0aGUgSUQgJ3B1Ymxpc2hlcicuCiAgKiAgICAgc2Vzc2lvbi5wdWJsaXNoKHB1Ymxpc2hlcik7CiAgKiB9CiAgKiA8L3ByZT4KICAqCiAgKiBAcGFyYW0gcHVibGlzaGVyIEEgUHVibGlzaGVyIG9iamVjdCwgd2hpY2ggeW91IGluaXRpYWxpemUgYnkgY2FsbGluZyB0aGUgPGEgaHJlZj0iVEIuaHRtbCNpbml0UHVibGlzaGVyIj5UQi5pbml0UHVibGlzaGVyKCk8L2E+CiAgKiBtZXRob2QuCiAgKgogICogQHJldHVybnMgVGhlIFB1Ymxpc2hlciBvYmplY3QgZm9yIHRoaXMgc3RyZWFtLgogICoKICAqIEBtZXRob2QgI3B1Ymxpc2gKICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLnB1Ymxpc2ggPSBmdW5jdGlvbihwdWJsaXNoZXIsIHByb3BlcnRpZXMsIGNvbXBsZXRpb25IYW5kbGVyKSB7CiAgICB2YXIgZXJyb3JNc2c7CgogICAgaWYgKHRoaXMuaXNOb3QoJ2Nvbm5lY3RlZCcpKSB7CiAgICAgIF9hbmFseXRpY3MubG9nRXJyb3IoMTAxMCwgJ3RiLmV4Y2VwdGlvbicsICJXZSBuZWVkIHRvIGJlIGNvbm5lY3RlZCBiZWZvcmUgeW91IGNhbiBwdWJsaXNoIiwgbnVsbCwgewogICAgICAgIGFjdGlvbjogJ3B1Ymxpc2gnLAogICAgICAgIHZhcmlhdGlvbjogJ0ZhaWx1cmUnLAogICAgICAgIHBheWxvYWRfdHlwZTogInJlYXNvbiIsCiAgICAgICAgcGF5bG9hZDogIldlIG5lZWQgdG8gYmUgY29ubmVjdGVkIGJlZm9yZSB5b3UgY2FuIHB1Ymxpc2giLAogICAgICAgIHNlc3Npb25faWQ6IF9zZXNzaW9uSWQsCiAgICAgICAgcGFydG5lcl9pZDogX2FwaUtleSwKICAgICAgICB3aWRnZXRJZDogX3dpZGdldElkLAogICAgICAgIHdpZGdldF90eXBlOiAnQ29udHJvbGxlcicKICAgICAgfSk7CgogICAgICBpZiAoY29tcGxldGlvbkhhbmRsZXIgJiYgT1QuJC5pc0Z1bmN0aW9uKGNvbXBsZXRpb25IYW5kbGVyKSkgewogICAgICAgIGVycm9yTXNnID0gIldlIG5lZWQgdG8gYmUgY29ubmVjdGVkIGJlZm9yZSB5b3UgY2FuIHB1Ymxpc2giOwogICAgICAgIE9ULiQuY2FsbEFzeW5jKGNvbXBsZXRpb25IYW5kbGVyLCBuZXcgT1QuRXJyb3IoT1QuRXhjZXB0aW9uQ29kZXMuTk9UX0NPTk5FQ1RFRCwgZXJyb3JNc2cpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgaWYgKCFwZXJtaXR0ZWRUbygicHVibGlzaCIpKSB7CiAgICAgIHRoaXMubG9nRXZlbnQoJ3B1Ymxpc2gnLCAnRmFpbHVyZScsICdyZWFzb24nLCAnVGhpcyB0b2tlbiBkb2VzIG5vdCBhbGxvdyBwdWJsaXNoaW5nLiBUaGUgcm9sZSBtdXN0IGJlIGF0IGxlYXN0IGBwdWJsaXNoZXJgIHRvIGVuYWJsZSB0aGlzIGZ1bmN0aW9uYWxpdHknKTsKCiAgICAgIFRCLmhhbmRsZUpzRXhjZXB0aW9uKCJUaGlzIHRva2VuIGRvZXMgbm90IGFsbG93IHB1Ymxpc2hpbmcuIFRoZSByb2xlIG11c3QgYmUgYXQgbGVhc3QgYHB1Ymxpc2hlcmAgdG8gZW5hYmxlIHRoaXMgZnVuY3Rpb25hbGl0eSIsIE9ULkV4Y2VwdGlvbkNvZGVzLlVOQUJMRV9UT19QVUJMSVNILCB7CiAgICAgICAgc2Vzc2lvbjogdGhpcwogICAgICB9KTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gSWYgdGhlIHVzZXIgaGFzIHBhc3NlZCBpbiBhbiBJRCBvZiBhIGVsZW1lbnQgdGhlbiB3ZSBjcmVhdGUgYSBuZXcgcHVibGlzaGVyLgogICAgaWYgKCFwdWJsaXNoZXIgfHwgdHlwZW9mKHB1Ymxpc2hlcik9PT0nc3RyaW5nJyB8fCBwdWJsaXNoZXIubm9kZVR5cGUgPT0gTm9kZS5FTEVNRU5UX05PREUpewogICAgICAvLyBJbml0aWF0ZSBhIG5ldyBQdWJsaXNoZXIgd2l0aCB0aGUgbmV3IHNlc3Npb24gY3JlZGVudGlhbHMKICAgICBwdWJsaXNoZXIgPSBPVC5pbml0UHVibGlzaGVyKHRoaXMuYXBpS2V5LCBwdWJsaXNoZXIsIHByb3BlcnRpZXMpOwogICAgfQogICAgZWxzZSBpZiAocHVibGlzaGVyIGluc3RhbmNlb2YgT1QuUHVibGlzaGVyKXsKCiAgICAgIC8vIElmIHRoZSBwdWJsaXNoZXIgYWxyZWFkeSBoYXMgYSBzZXNzaW9uIGF0dGFjaGVkIHRvIGl0IHdlIGNhbgogICAgICBpZiggInNlc3Npb24iIGluIHB1Ymxpc2hlciAmJiBwdWJsaXNoZXIuc2Vzc2lvbiAmJiAic2Vzc2lvbklkIiBpbiBwdWJsaXNoZXIuc2Vzc2lvbiApewogICAgICAgIC8vIHNlbmQgYSB3YXJuaW5nIG1lc3NhZ2UgdGhhdCB3ZSBjYW4ndCBwdWJsaXNoIGFnYWluLgogICAgICAgIGlmKCBwdWJsaXNoZXIuc2Vzc2lvbi5zZXNzaW9uSWQgPT09IHRoaXMuc2Vzc2lvbklkKXsKICAgICAgICAgIE9ULndhcm4oIkNhbm5vdCBwdWJsaXNoICIgKyBwdWJsaXNoZXIuZ3VpZCArICIgYWdhaW4gdG8gIiArIHRoaXMuc2Vzc2lvbklkICsgIi4gUGxlYXNlIGNhbGwgc2Vzc2lvbi51bnB1Ymxpc2gocHVibGlzaGVyKSBmaXJzdC4iKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBPVC53YXJuKCJDYW5ub3QgcHVibGlzaCAiICsgcHVibGlzaGVyLmd1aWQgKyAiIHB1Ymxpc2hlciBhbHJlYWR5IGF0dGFjaGVkIHRvICIgKyBwdWJsaXNoZXIuc2Vzc2lvbi5zZXNzaW9uSWQrICIuIFBsZWFzZSBjYWxsIHNlc3Npb24udW5wdWJsaXNoKHB1Ymxpc2hlcikgZmlyc3QuIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBlbHNlIHsKICAgICAgZXJyb3JNc2cgPSAiU2Vzc2lvbi5wdWJsaXNoIDo6IEZpcnN0IHBhcmFtZXRlciBwYXNzZWQgaW4gaXMgbmVpdGhlciBhIHN0cmluZyBub3IgYW4gaW5zdGFuY2Ugb2YgdGhlIFB1Ymxpc2hlciI7CiAgICAgIE9ULmVycm9yKGVycm9yTXNnKTsKICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTXNnKTsKICAgIH0KCiAgICBpZiAoY29tcGxldGlvbkhhbmRsZXIgJiYgT1QuJC5pc0Z1bmN0aW9uKGNvbXBsZXRpb25IYW5kbGVyKSkgcHVibGlzaGVyLm9uY2UoJ3B1Ymxpc2hDb21wbGV0ZScsIGNvbXBsZXRpb25IYW5kbGVyKTsKCiAgICAvLyBBZGQgcHVibGlzaGVyIHJlZmVyZW5jZSB0byB0aGUgc2Vzc2lvbgogICAgcHVibGlzaGVyLl8ucHVibGlzaFRvU2Vzc2lvbih0aGlzKTsKCiAgICAvLyByZXR1cm4gdGhlIGVtYmVkIHB1Ymxpc2hlcgogICAgcmV0dXJuIHB1Ymxpc2hlcjsKICB9OwoKIC8qKgogICogQ2Vhc2VzIHB1Ymxpc2hpbmcgdGhlIHNwZWNpZmllZCBwdWJsaXNoZXIncyBhdWRpby12aWRlbyBzdHJlYW0KICAqIHRvIHRoZSBzZXNzaW9uLiBCeSBkZWZhdWx0LCB0aGUgbG9jYWwgcmVwcmVzZW50YXRpb24gb2YgdGhlIGF1ZGlvLXZpZGVvIHN0cmVhbSBpcyByZW1vdmVkIGZyb20gdGhlCiAgKiB3ZWIgcGFnZS48IFVwb24gc3VjY2Vzc2Z1bCB0ZXJtaW5hdGlvbiwgdGhlIFNlc3Npb24gb2JqZWN0IG9uIGV2ZXJ5IGNvbm5lY3RlZAogICogd2ViIHBhZ2UgZGlzcGF0Y2hlcwogICogYSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50LgogICogPC9wPgogICoKICAqIDxwPgogICogVG8gcHJldmVudCB0aGUgUHVibGlzaGVyIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sIGFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgdGhlCiAgKiA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IGV2ZW50IGFuZCBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2Qgb2YgdGhlIGV2ZW50IG9iamVjdC4KICAqIDwvcD4KICAqCiAgKiA8cD4KICAqIDxpPk5vdGU6PC9pPiBJZiB5b3UgaW50ZW5kIHRvIHJldXNlIGEgUHVibGlzaGVyIG9iamVjdCBjcmVhdGVkIHVzaW5nIDxjb2RlPlRCLmluaXRQdWJsaXNoZXIoKTwvY29kZT4KICAqIHRvIHB1Ymxpc2ggdG8gZGlmZmVyZW50IHNlc3Npb25zIHNlcXVlbnRpYWxseSwgY2FsbCBlaXRoZXIgPGNvZGU+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2NvZGU+IG9yCiAgKiA8Y29kZT5TZXNzaW9uLnVucHVibGlzaCgpPC9jb2RlPi4gRG8gbm90IGNhbGwgYm90aC4gVGhlbiBjYWxsIHRoZSA8Y29kZT5wcmV2ZW50RGVmYXVsdCgpPC9jb2RlPiBtZXRob2QKICAqIG9mIHRoZSA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+IG9yIDxjb2RlPnNlc3Npb25EaXNjb25uZWN0ZWQ8L2NvZGU+IGV2ZW50IG9iamVjdCB0byBwcmV2ZW50IHRoZQogICogUHVibGlzaGVyIG9iamVjdCBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcGFnZS4gQmUgc3VyZSB0byBjYWxsIDxjb2RlPnByZXZlbnREZWZhdWx0KCk8L2NvZGU+IG9ubHkKICAqIGlmIHRoZSA8Y29kZT5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgb2YgdGhlIFN0cmVhbSBvYmplY3QgaW4gdGhlIGV2ZW50IG1hdGNoZXMgdGhlCiAgKiA8Y29kZT5jb25uZWN0aW9uLmNvbm5lY3Rpb25JZDwvY29kZT4gcHJvcGVydHkgb2YgeW91ciBTZXNzaW9uIG9iamVjdCAodG8gZW5zdXJlIHRoYXQgeW91IGFyZSBwcmV2ZW50aW5nCiAgKiB0aGUgZGVmYXVsdCBiZWhhdmlvciBmb3IgeW91ciBwdWJsaXNoZWQgc3RyZWFtcywgbm90IGZvciBvdGhlciBzdHJlYW1zIHRoYXQgeW91IHN1YnNjcmliZSB0bykuCiAgKiA8L3A+CiAgKgogICogPGg1PkV2ZW50cyBkaXNwYXRjaGVkOjwvaDU+CiAgKgogICogPHA+CiAgKiA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+ICg8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sIj5TdHJlYW1FdmVudDwvYT4pICYjMTUxOwogICogVGhlIHN0cmVhbSBhc3NvY2lhdGVkIHdpdGggdGhlIFB1Ymxpc2hlciBoYXMgYmVlbiBkZXN0cm95ZWQuIERpc3BhdGNoZWQgb24KICAqIHRoZSBQdWJsaXNoZXIncyBicm93c2VyIGFuZCBvbiB0aGUgYnJvd3NlciBmb3IgYWxsIGNvbm5lY3Rpb25zIHN1YnNjcmliaW5nCiAgKiB0byB0aGUgcHVibGlzaGVyJ3Mgc3RyZWFtLgogICogICAgICAgICAgICAgICAgPC9wPgogICoKICAqIDxoNT5FeGFtcGxlPC9oNT4KICAqCiAgKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgcHVibGlzaGVzIGEgc3RyZWFtIHRvIGEgc2Vzc2lvbiBhbmQgYWRkcyBhIERpc2Nvbm5lY3QgbGluayB0byB0aGUgd2ViIHBhZ2UuIENsaWNraW5nIHRoaXMgbGluayBjYXVzZXMgdGhlIHN0cmVhbSB0byBzdG9wIGJlaW5nIHB1Ymxpc2hlZC4KICAqCiAgKiA8cHJlPgogICogJmx0O3NjcmlwdCZndDsKICAqICAgICB2YXIgYXBpS2V5ID0gIiI7IC8vIFJlcGxhY2Ugd2l0aCB5b3VyIEFQSSBrZXkuIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAgKiAgICAgdmFyIHNlc3Npb25JRCA9ICIiOyAvLyBSZXBsYWNlIHdpdGggeW91ciBvd24gc2Vzc2lvbiBJRC4KICAqICAgICAgICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAgKiAgICAgdmFyIHRva2VuID0gIlJlcGxhY2Ugd2l0aCB0aGUgVG9rQm94IHRva2VuIHN0cmluZyBwcm92aWRlZCB0byB5b3UuIgogICogICAgIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICAqICAgICBzZXNzaW9uLmFkZEV2ZW50TGlzdGVuZXIoInNlc3Npb25Db25uZWN0ZWQiLCBzZXNzaW9uQ29ubmVjdEhhbmRsZXIpOwogICogICAgIHNlc3Npb24uY29ubmVjdChhcGlLZXksIHRva2VuKTsKICAqICAgICB2YXIgcHVibGlzaGVyOwogICoKICAqICAgICBmdW5jdGlvbiBzZXNzaW9uQ29ubmVjdEhhbmRsZXIoZXZlbnQpIHsKICAqICAgICAgICAgcHVibGlzaGVyID0gVEIuaW5pdFB1Ymxpc2hlcihhcGlLZXksICdwdWJsaXNoZXInKTsKICAqICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXNzdW1lcyB0aGF0IHRoZXJlIGlzIGEgRE9NIGVsZW1lbnQgd2l0aCB0aGUgSUQgJ3B1Ymxpc2hlcicuCiAgKiAgICAgICAgIHNlc3Npb24ucHVibGlzaChwdWJsaXNoZXIpOwogICogICAgIH0KICAqICAgICBmdW5jdGlvbiB1bnB1YmxzaCgpIHsKICAqICAgICAgICAgc2Vzc2lvbi51bnB1Ymxpc2gocHVibGlzaGVyKTsKICAqICAgICB9CiAgKiAmbHQ7L3NjcmlwdCZndDsKICAqCiAgKiAmbHQ7Ym9keSZndDsKICAqCiAgKiAgICAgJmx0O2RpdiBpZD0icHVibGlzaGVyQ29udGFpbmVyLyZndDsKICAqICAgICAmbHQ7YnIvJmd0OwogICoKICAqICAgICAmbHQ7YSBocmVmPSJqYXZhc2NyaXB0OnVucHVibGlzaCgpIiZndDtTdG9wIFB1Ymxpc2hpbmcmbHQ7L2EmZ3Q7CiAgKgogICogJmx0Oy9ib2R5Jmd0OwogICoKICAqIDwvcHJlPgogICoKICAqIEBzZWUgPGEgaHJlZj0iI3B1Ymxpc2giPnB1Ymxpc2goKTwvYT4KICAqCiAgKiBAc2VlIDxhIGhyZWY9IlN0cmVhbUV2ZW50Lmh0bWwiPnN0cmVhbURlc3Ryb3llZCBldmVudDwvYT4KICAqCiAgKiBAcGFyYW0ge1B1Ymxpc2hlcn0gcHVibGlzaGVyPC9zcGFuPiBUaGUgUHVibGlzaGVyIG9iamVjdCB0byBzdG9wIHN0cmVhbWluZy4KICAqCiAgKiBAbWV0aG9kICN1bnB1Ymxpc2gKICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLnVucHVibGlzaCA9IGZ1bmN0aW9uKHB1Ymxpc2hlcikgewogICAgaWYgKCFwdWJsaXNoZXIpIHsKICAgICAgT1QuZXJyb3IoJ09ULlNlc3Npb24udW5wdWJsaXNoOiBwdWJsaXNoZXIgcGFyYW1ldGVyIG1pc3NpbmcuJyk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBVbnB1Ymxpc2ggdGhlIGxvY2FsTWVkaWEgcHVibGlzaGVyCiAgICBwdWJsaXNoZXIuXy51bnB1Ymxpc2hGcm9tU2Vzc2lvbih0aGlzKTsKICB9OwoKCiAvKioKICAqIFN1YnNjcmliZXMgdG8gYSBzdHJlYW0gdGhhdCBpcyBhdmFpbGFibGUgdG8gdGhlIHNlc3Npb24uIFlvdSBjYW4gZ2V0IGFuIGFycmF5IG9mCiAgKiBhdmFpbGFibGUgc3RyZWFtcyBmcm9tIHRoZSA8Y29kZT5zdHJlYW1zPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUgPGNvZGU+c2Vzc2lvbkNvbm5lY3RlZDwvY29kZT4KICAqIGFuZCA8Y29kZT5zdHJlYW1DcmVhdGVkPC9jb2RlPiBldmVudHMgKHNlZSA8YSBocmVmPSJTZXNzaW9uQ29ubmVjdEV2ZW50Lmh0bWwiPlNlc3Npb25Db25uZWN0RXZlbnQ8L2E+IGFuZAogICogPGEgaHJlZj0iU3RyZWFtRXZlbnQuaHRtbCI+U3RyZWFtRXZlbnQ8L2E+KS4KICAqIDwvcD4KICAqIDxwPgogICogVGhlIHN1YnNjcmliZWQgc3RyZWFtIGlzIGRpc3BsYXllZCBvbiB0aGUgbG9jYWwgd2ViIHBhZ2UgYnkgcmVwbGFjaW5nIHRoZSBzcGVjaWZpZWQgZWxlbWVudCBpbiB0aGUgRE9NIHdpdGggYSBzdHJlYW1pbmcgdmlkZW8gZGlzcGxheS4KICAqIElmIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBkaXNwbGF5IGRvIG5vdCBtYXRjaCB0aGUgNDozIGFzcGVjdCByYXRpbyBvZiB0aGUgdmlkZW8gc2lnbmFsLCB0aGUgdmlkZW8gc3RyZWFtIGlzIGNyb3BwZWQgdG8gZml0CiAgKiB0aGUgZGlzcGxheS4gSWYgdGhlIHN0cmVhbSBsYWNrcyBhIHZpZGVvIGNvbXBvbmVudCwgYSBibGFuayBzY3JlZW4gd2l0aCBhbiBhdWRpbyBpbmRpY2F0b3IgaXMgZGlzcGxheWVkIGluIHBsYWNlIG9mIHRoZSB2aWRlbyBzdHJlYW0uCiAgKiA8L3A+CiAgKgogICogPHA+CiAgKiBUaGUgYXBwbGljYXRpb24gdGhyb3dzIGFuIGVycm9yIGlmIHRoZSBzZXNzaW9uIGlzIG5vdCBjb25uZWN0ZWQ8IS0tSlMtT05MWS0tPiBvciBpZiB0aGUKICAqIDxjb2RlPnRhcmdldEVsZW1lbnQ8L2NvZGU+IGRvZXMgbm90IGV4aXN0IGluIHRoZSBIVE1MIERPTTwhLS0vSlMtT05MWS0tPi4KICAqIDwvcD4KICAqCiAgKiA8aDU+RXhhbXBsZTwvaDU+CiAgKgogICogVGhlIGZvbGxvd2luZyBjb2RlIHN1YnNjcmliZXMgdG8gYXZhaWxhYmxlIHN0cmVhbXMgYXQgdGhlIHRpbWUgdGhhdCBhIHNlc3Npb24gaXMgY29ubmVjdGVkCiAgKgogICogPHByZT4KICAqIHZhciBhcGlLZXkgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgQVBJIGtleS4gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAgKiAgICAgICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAgKgogICogdmFyIHNlc3Npb24gPSBUQi5pbml0U2Vzc2lvbihzZXNzaW9uSUQpOwogICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzZXNzaW9uQ29ubmVjdGVkIiwgc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKTsKICAqIHNlc3Npb24uY29ubmVjdChhcGlLZXksIHRva2VuKTsKICAqCiAgKiBmdW5jdGlvbiBzZXNzaW9uQ29ubmVjdEhhbmRsZXIoZXZlbnQpIHsKICAqICAgICBmb3IgKHZhciBpID0gMDsgaSAmbHQ7IGV2ZW50LnN0cmVhbXMubGVuZ3RoOyBpKyspIHsKICAqICAgICAgICAgdmFyIHN0cmVhbSA9IGV2ZW50LnN0cmVhbXNbaV07CiAgKiAgICAgICAgIGRpc3BsYXlTdHJlYW0oc3RyZWFtKTsKICAqICAgICB9CiAgKiB9CiAgKgogICogZnVuY3Rpb24gZGlzcGxheVN0cmVhbShzdHJlYW0pIHsKICAqICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgKiAgICAgZGl2LnNldEF0dHJpYnV0ZSgnaWQnLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAgKiAgICAgdmFyIHN0cmVhbXNDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RyZWFtc0NvbnRhaW5lcicpOwogICogICAgIHN0cmVhbXNDb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAqICAgICBzdWJzY3JpYmVyID0gc2Vzc2lvbi5zdWJzY3JpYmUoc3RyZWFtLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAgKiB9CiAgKiA8L3ByZT4KICAqIDxwPgogICogWW91IGNhbiBhbHNvIGFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgdGhlIDxjb2RlPnN0cmVhbUNyZWF0ZWQ8L2NvZGU+IGV2ZW50LiBUaGUgU2Vzc2lvbiBvYmplY3QgZGlzcGF0Y2hlcyB0aGlzIGV2ZW50IHdoZW4gYSBuZXcgc3RyZWFtIGlzIGNyZWF0ZWQuCiAgKiA8L3A+CiAgKiA8cHJlPgogICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzdHJlYW1DcmVhdGVkIiwgc3RyZWFtQ3JlYXRlZEhhbmRsZXIpOwogICoKICAqIGZ1bmN0aW9uIHN0cmVhbUNyZWF0ZWRIYW5kbGVyKGV2ZW50KSB7CiAgKiAgICAgZm9yICh2YXIgaSA9IDA7IGkgJmx0OyBldmVudC5zdHJlYW1zLmxlbmd0aDsgaSsrKSB7CiAgKiAgICAgICAgIHZhciBzdHJlYW0gPSBldmVudC5zdHJlYW1zW2ldOwogICogICAgICAgICBkaXNwbGF5U3RyZWFtKHN0cmVhbSk7CiAgKiAgICAgfQogICogfQogICogPC9wcmU+CiAgKgogICogQHBhcmFtIHtTdHJlYW19IHN0cmVhbSBUaGUgU3RyZWFtIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHN0cmVhbSB0byB3aGljaCB3ZSBhcmUgdHJ5aW5nIHRvIHN1YnNjcmliZS4KICAqCiAgKiBAcGFyYW0ge1N0cmluZ30gdGFyZ2V0RWxlbWVudCBUaGUgSUQgb2YgdGhlIGV4aXN0aW5nIERPTSBlbGVtZW50CiAgKiB0aGF0IHRoZSBTdWJzY3JpYmVyIHJlcGxhY2VzLiBJZiB5b3UgZG8gbm90IHNwZWNpZnkgYSA8Y29kZT50YXJnZXRFbGVtZW50PC9jb2RlPiwgdGhlIGFwcGxpY2F0aW9uCiAgKiBhcHBlbmRzIGEgbmV3IERPTSBlbGVtZW50IHRvIHRoZSBIVE1MIDxjb2RlPmJvZHk8L2NvZGU+LgogICoKICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0aWVzIFRoaXMgaXMgYW4gb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICogICAgPHVsPgogICogICAgICAgPGxpPjxjb2RlPmF1ZGlvVm9sdW1lPC9jb2RlPiAoTnVtYmVyKSAmIzE1MTsgVGhlIGRlc2lyZWQgYXVkaW8gdm9sdW1lLCBiZXR3ZWVuIDAgYW5kIDEwMCwgd2hlbiB0aGUgU3Vic2NyaWJlcgogICogICAgICAgaXMgZmlyc3Qgb3BlbmVkIChkZWZhdWx0OiA1MCkuIEFmdGVyIHlvdSBzdWJzY3JpYmUgdG8gdGhlIHN0cmVhbSwgeW91IGNhbiBhZGp1c3QgdGhlIHZvbHVtZSBieSBjYWxsaW5nCiAgKiAgICAgICB0aGUgPGEgaHJlZj0iU3Vic2NyaWJlci5odG1sI3NldEF1ZGlvVm9sdW1lIj48Y29kZT5zZXRBdWRpb1ZvbHVtZSgpPC9jb2RlPiBtZXRob2Q8L2E+IG9mIHRoZSBTdWJzY3JpYmVyCiAgKiAgICAgICBvYmplY3QuIFRoaXMgdm9sdW1lIHNldHRpbmcgYWZmZWN0cyBsb2NhbCBwbGF5YmFjayBvbmx5OyBpdCBkb2VzIG5vdCBhZmZlY3QgdGhlIHN0cmVhbSdzIHZvbHVtZSBvbiBvdGhlcgogICogICAgICAgY2xpZW50cy48L2xpPgogICoKICAqICAgICAgIDxsaT48Y29kZT5oZWlnaHQ8L2NvZGU+IChOdW1iZXIpICYjMTUxOyBUaGUgZGVzaXJlZCBoZWlnaHQsIGluIHBpeGVscywgb2YgdGhlCiAgKiAgICAgICAgZGlzcGxheWVkIFN1YnNjcmliZXIgdmlkZW8gc3RyZWFtIChkZWZhdWx0OiAxOTgpLiA8aT5Ob3RlOjwvaT4gVXNlIHRoZQogICogICAgICAgPGNvZGU+aGVpZ2h0PC9jb2RlPiBhbmQgPGNvZGU+d2lkdGg8L2NvZGU+IHByb3BlcnRpZXMgdG8gc2V0IHRoZSBkaW1lbnNpb25zCiAgKiAgICAgICBvZiB0aGUgU3Vic2NyaWJlciB2aWRlbzsgZG8gbm90IHNldCB0aGUgaGVpZ2h0IGFuZCB3aWR0aCBvZiB0aGUgRE9NIGVsZW1lbnQKICAqICAgICAgICh1c2luZyBDU1MpLjwvbGk+CiAgKgogICogICAgICAgPGxpPjxjb2RlPnN0eWxlLm5hbWVEaXNwbGF5TW9kZTwvY29kZT4gKFN0cmluZykgJiMxNTE7IFRoaXMgcHJvcGVydHkgZGV0ZXJtaW5lcyB3aGV0aGVyIHRvIGRpc3BsYXkgdGhlCiAgKiAgICAgICBzdHJlYW0gbmFtZS4gUG9zc2libGUgdmFsdWVzIGFyZTogPGNvZGU+ImF1dG8iPC9jb2RlPiAodGhlIG5hbWUgaXMgZGlzcGxheWVkIHdoZW4gdGhlIHN0cmVhbSBpcyBmaXJzdAogICogICAgICAgZGlzcGxheWVkIGFuZCB3aGVuIHRoZSB1c2VyIG1vdXNlcyBvdmVyIHRoZSBkaXNwbGF5KSwgPGNvZGU+Im9mZiI8L2NvZGU+ICh0aGUgbmFtZSBpcyBub3QgZGlzcGxheWVkKSwKICAqICAgICAgIGFuZCA8Y29kZT4ib24iPC9jb2RlPiAodGhlIG5hbWUgaXMgZGlzcGxheWVkKS48L2xpPgogICoKICAqICAgICAgIDxsaT48Y29kZT5zdWJzY3JpYmVUb0F1ZGlvPC9jb2RlPiAoQm9vbGVhbikgJiMxNTE7IFdoZXRoZXIgdG8gaW5pdGlhbGx5IHN1YnNjcmliZSB0byBhdWRpbwogICogICAgICAgKGlmIGF2YWlsYWJsZSkgZm9yIHRoZSBzdHJlYW0gKGRlZmF1bHQ6IDxjb2RlPnRydWU8L2NvZGU+KS48L2xpPgogICoKICAqICAgICAgIDxsaT48Y29kZT5zdWJzY3JpYmVUb1ZpZGVvPC9jb2RlPiAoQm9vbGVhbikgJiMxNTE7IFdoZXRoZXIgdG8gaW5pdGlhbGx5IHN1YnNjcmliZSB0byB2aWRlbwogICogICAgICAgKGlmIGF2YWlsYWJsZSkgZm9yIHRoZSBzdHJlYW0gKGRlZmF1bHQ6IDxjb2RlPnRydWU8L2NvZGU+KS48L2xpPgogICoKICAqICAgICAgIDxsaT48Y29kZT53aWR0aDwvY29kZT4gKE51bWJlcikgJiMxNTE7IFRoZSBkZXNpcmVkIHdpZHRoLCBpbiBwaXhlbHMsIG9mIHRoZQogICogICAgICAgZGlzcGxheWVkIFN1YnNjcmliZXIgdmlkZW8gc3RyZWFtIChkZWZhdWx0OiAyNjQpLiA8aT5Ob3RlOjwvaT4gVXNlIHRoZQogICogICAgICAgPGNvZGU+aGVpZ2h0PC9jb2RlPiBhbmQgPGNvZGU+d2lkdGg8L2NvZGU+IHByb3BlcnRpZXMgdG8gc2V0IHRoZSBkaW1lbnNpb25zCiAgKiAgICAgICAgb2YgdGhlIFN1YnNjcmliZXIgdmlkZW87IGRvIG5vdCBzZXQgdGhlIGhlaWdodCBhbmQgd2lkdGggb2YgdGhlIERPTSBlbGVtZW50CiAgKiAgICAgICAodXNpbmcgQ1NTKS48L2xpPgogICoKICAqICAgIDwvdWw+CiAgKgogICogQHNpZ25hdHVyZSBzdWJzY3JpYmUoc3RyZWFtLCB0YXJnZXRFbGVtZW50LCBwcm9wZXJ0aWVzKQogICogQHJldHVybnMge1N1YnNjcmliZXJ9IFRoZSBTdWJzY3JpYmVyIG9iamVjdCBmb3IgdGhpcyBzdHJlYW0uIFN0cmVhbSBjb250cm9sIGZ1bmN0aW9ucyBhcmUgZXhwb3NlZCB0aHJvdWdoIHRoZSBTdWJzY3JpYmVyIG9iamVjdC4KICAqIEBtZXRob2QgI3N1YnNjcmliZQogICogQG1lbWJlck9mIFNlc3Npb24KICAqLwogIHRoaXMuc3Vic2NyaWJlID0gZnVuY3Rpb24oc3RyZWFtLCB0YXJnZXRFbGVtZW50LCBwcm9wZXJ0aWVzLCBjb21wbGV0aW9uSGFuZGxlcikgewogICAgdmFyIGVycm9yTXNnOwoKICAgIGlmICghdGhpcy5jb25uZWN0aW9uIHx8ICF0aGlzLmNvbm5lY3Rpb24uY29ubmVjdGlvbklkKSB7CiAgICAgIGVycm9yTXNnID0gIlNlc3Npb24uc3Vic2NyaWJlIDo6IENvbm5lY3Rpb24gcmVxdWlyZWQgdG8gc3Vic2NyaWJlIjsKICAgICAgT1QuZXJyb3IoZXJyb3JNc2cpOwogICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cpOwogICAgfQoKICAgIGlmICghc3RyZWFtKSB7CiAgICAgIGVycm9yTXNnID0gIlNlc3Npb24uc3Vic2NyaWJlIDo6IHN0cmVhbSBjYW5ub3QgYmUgbnVsbCI7CiAgICAgIE9ULmVycm9yKGVycm9yTXNnKTsKICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTXNnKTsKICAgIH0KCiAgICBpZiAoIXN0cmVhbS5oYXNPd25Qcm9wZXJ0eSgic3RyZWFtSWQiKSkgewogICAgICBlcnJvck1zZyA9ICJTZXNzaW9uLnN1YnNjcmliZSA6OiBpbnZhbGlkIHN0cmVhbSBvYmplY3QiOwogICAgICBPVC5lcnJvcihlcnJvck1zZyk7CiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1zZyk7CiAgICB9CgogICAgdmFyIHN1YnNjcmliZXIgPSBuZXcgT1QuU3Vic2NyaWJlcih0YXJnZXRFbGVtZW50LCBPVC4kLmV4dGVuZChwcm9wZXJ0aWVzIHx8IHt9LCB7CiAgICAgICAgc2Vzc2lvbjogdGhpcwogICAgfSkpOwoKICAgIGlmIChjb21wbGV0aW9uSGFuZGxlciAmJiBPVC4kLmlzRnVuY3Rpb24oY29tcGxldGlvbkhhbmRsZXIpKSBzdWJzY3JpYmVyLm9uY2UoJ3N1YnNjcmliZUNvbXBsZXRlJywgY29tcGxldGlvbkhhbmRsZXIpOwoKICAgIE9ULnN1YnNjcmliZXJzLmFkZChzdWJzY3JpYmVyKTsKICAgIHN1YnNjcmliZXIuc3Vic2NyaWJlKHN0cmVhbSk7CgogICAgcmV0dXJuIHN1YnNjcmliZXI7CiAgfTsKCiAvKioKICAqIFN0b3BzIHN1YnNjcmliaW5nIHRvIGEgc3RyZWFtIGluIHRoZSBzZXNzaW9uLiB0aGUgZGlzcGxheSBvZiB0aGUgYXVkaW8tdmlkZW8gc3RyZWFtIGlzIHJlbW92ZWQgZnJvbSB0aGUgbG9jYWwgd2ViIHBhZ2UuCiAgKgogICogPGg1PkV4YW1wbGU8L2g1PgogICogPHA+CiAgKiBUaGUgZm9sbG93aW5nIGNvZGUgc3Vic2NyaWJlcyB0byBhdmFpbGFibGUgc3RyZWFtcyBhdCB0aGUgdGltZSB0aGF0IGEgc2Vzc2lvbiBpcyBjb25uZWN0ZWQuIEZvciBlYWNoIHN0cmVhbSwgdGhlIGNvZGUgYWxzbwogICogYWRkcyBhbiBVbnN1YnNjcmliZSBsaW5rLgogICogPC9wPgogICogPHByZT4KICAqIHZhciBhcGlLZXkgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgQVBJIGtleS4gU2VlIGh0dHBzOi8vZGFzaGJvYXJkLnRva2JveC5jb20vcHJvamVjdHMKICAqIHZhciBzZXNzaW9uSUQgPSAiIjsgLy8gUmVwbGFjZSB3aXRoIHlvdXIgb3duIHNlc3Npb24gSUQuCiAgKiAgICAgICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2Rhc2hib2FyZC50b2tib3guY29tL3Byb2plY3RzCiAgKiB2YXIgc3RyZWFtcyA9IFtdOwogICoKICAqIHZhciBzZXNzaW9uID0gVEIuaW5pdFNlc3Npb24oc2Vzc2lvbklEKTsKICAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigic2Vzc2lvbkNvbm5lY3RlZCIsIHNlc3Npb25Db25uZWN0SGFuZGxlcik7CiAgKiBzZXNzaW9uLmNvbm5lY3QoYXBpS2V5LCB0b2tlbik7CiAgKgogICogZnVuY3Rpb24gc2Vzc2lvbkNvbm5lY3RIYW5kbGVyKGV2ZW50KSB7CiAgKiAgICAgZm9yICh2YXIgaSA9IDA7IGkgJmx0OyBldmVudC5zdHJlYW1zLmxlbmd0aDsgaSsrKSB7CiAgKiAgICAgICAgIHZhciBzdHJlYW0gPSBldmVudC5zdHJlYW1zW2ldOwogICogICAgICAgICBkaXNwbGF5U3RyZWFtKHN0cmVhbSk7CiAgKiAgICAgfQogICogfQogICoKICAqIGZ1bmN0aW9uIGRpc3BsYXlTdHJlYW0oc3RyZWFtKSB7CiAgKiAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICogICAgIGRpdi5zZXRBdHRyaWJ1dGUoJ2lkJywgJ3N0cmVhbScgKyBzdHJlYW0uc3RyZWFtSWQpOwogICoKICAqCiAgKgogICogICAgIHZhciBzdWJzY3JpYmVyID0gc2Vzc2lvbi5zdWJzY3JpYmUoc3RyZWFtLCAnc3RyZWFtJyArIHN0cmVhbS5zdHJlYW1JZCk7CiAgKiAgICAgc3Vic2NyaWJlcnMucHVzaChzdWJzY3JpYmVyKTsKICAqCiAgKgogICogICAgIHZhciBhTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAqICAgICBhTGluay5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnamF2YXNjcmlwdDogdW5zdWJzY3JpYmUoIicgKyBzdWJzY3JpYmVyLmlkICsgJyIpJyk7CiAgKiAgICAgYUxpbmsuaW5uZXJIVE1MID0gIlVuc3Vic2NyaWJlIjsKICAqCiAgKiAgICAgdmFyIHN0cmVhbXNDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RyZWFtc0NvbnRhaW5lcicpOwogICogICAgIHN0cmVhbXNDb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAqICAgICBzdHJlYW1zQ29udGFpbmVyLmFwcGVuZENoaWxkKGFMaW5rKTsKICAqCiAgKiAgICAgc3RyZWFtcyA9IGV2ZW50LnN0cmVhbXM7CiAgKiB9CiAgKgogICogZnVuY3Rpb24gdW5zdWJzY3JpYmUoc3Vic2NyaWJlcklkKSB7CiAgKiAgICAgY29uc29sZS5sb2coInVuc3Vic2NyaWJlIGNhbGxlZCIpOwogICogICAgIGZvciAodmFyIGkgPSAwOyBpICZsdDsgc3Vic2NyaWJlcnMubGVuZ3RoOyBpKyspIHsKICAqICAgICAgICAgdmFyIHN1YnNjcmliZXIgPSBzdWJzY3JpYmVyc1tpXTsKICAqICAgICAgICAgaWYgKHN1YnNjcmliZXIuaWQgPT0gc3Vic2NyaWJlcklkKSB7CiAgKiAgICAgICAgICAgICBzZXNzaW9uLnVuc3Vic2NyaWJlKHN1YnNjcmliZXIpOwogICogICAgICAgICB9CiAgKiAgICAgfQogICogfQogICogPC9wcmU+CiAgKgogICogQHBhcmFtIHtTdWJzY3JpYmVyfSBzdWJzY3JpYmVyIFRoZSBTdWJzY3JpYmVyIG9iamVjdCB0byB1bnN1YmNyaWJlLgogICoKICAqIEBzZWUgPGEgaHJlZj0iI3N1YnNjcmliZSI+c3Vic2NyaWJlKCk8L2E+CiAgKgogICogQG1ldGhvZCAjdW5zdWJzY3JpYmUKICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24oc3Vic2NyaWJlcikgewogICAgaWYgKCFzdWJzY3JpYmVyKSB7CiAgICAgIHZhciBlcnJvck1zZyA9ICJPVC5TZXNzaW9uLnVuc3Vic2NyaWJlOiBzdWJzY3JpYmVyIGNhbm5vdCBiZSBudWxsIjsKICAgICAgT1QuZXJyb3IoZXJyb3JNc2cpOwogICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cpOwogICAgfQoKICAgIGlmICghc3Vic2NyaWJlci5zdHJlYW0pIHsKICAgICAgICBPVC53YXJuKCJPVC5TZXNzaW9uLnVuc3Vic2NyaWJlOjogdHJpZWQgdG8gdW5zdWJzY3JpYmUgYSBzdWJzY3JpYmVyIHRoYXQgaGFkIG5vIHN0cmVhbSIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBPVC5kZWJ1ZygiT1QuU2Vzc2lvbi51bnN1YnNjcmliZTogc3Vic2NyaWJlciAiICsgc3Vic2NyaWJlci5pZCk7CgogICAgc3Vic2NyaWJlci5kZXN0cm95KCk7CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAvKioKICAqIFJldHVybnMgYW4gYXJyYXkgb2YgbG9jYWwgU3Vic2NyaWJlciBvYmplY3RzIGZvciBhIGdpdmVuIHN0cmVhbS4KICAqCiAgKiBAcGFyYW0ge1N0cmVhbX0gc3RyZWFtIFRoZSBzdHJlYW0gZm9yIHdoaWNoIHlvdSB3YW50IHRvIGZpbmQgc3Vic2NyaWJlcnMuCiAgKgogICogQHJldHVybnMge0FycmF5fSBBbiBhcnJheSBvZiB7QGxpbmsgU3Vic2NyaWJlcn0gb2JqZWN0cyBmb3IgdGhlIHNwZWNpZmllZCBzdHJlYW0uCiAgKgogICogQHNlZSA8YSBocmVmPSIjdW5zdWJzY3JpYmUiPnVuc3Vic2NyaWJlKCk8L2E+CiAgKiBAc2VlIDxhIGhyZWY9IlN1YnNjcmliZXIuaHRtbCI+U3Vic2NyaWJlcjwvYT4KICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtRXZlbnQuaHRtbCI+U3RyZWFtRXZlbnQ8L2E+CiAgKiBAbWV0aG9kICNnZXRTdWJzY3JpYmVyc0ZvclN0cmVhbQogICogQG1lbWJlck9mIFNlc3Npb24KICAqLwogIHRoaXMuZ2V0U3Vic2NyaWJlcnNGb3JTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgIHJldHVybiBPVC5zdWJzY3JpYmVycy53aGVyZSh7c3RyZWFtSWQ6IHN0cmVhbS5pZH0pOwogIH07CgogLyoqCiAgKiBSZXR1cm5zIHRoZSBsb2NhbCBQdWJsaXNoZXIgb2JqZWN0IGZvciBhIGdpdmVuIHN0cmVhbS4KICAqCiAgKiBAcGFyYW0ge1N0cmVhbX0gc3RyZWFtIFRoZSBzdHJlYW0gZm9yIHdoaWNoIHlvdSB3YW50IHRvIGZpbmQgdGhlIFB1Ymxpc2hlci4KICAqCiAgKiBAcmV0dXJucyB7UHVibGlzaGVyfSBBIFB1Ymxpc2hlciBvYmplY3QgZm9yIHRoZSBzcGVjaWZpZWQgc3RyZWFtLiBSZXR1cm5zIDxjb2RlPm51bGw8L2NvZGU+IGlmIHRoZXJlIGlzIG5vIGxvY2FsIFB1Ymxpc2hlciBvYmplY3QKICAqIGZvciB0aGUgc3BlY2lmaWVkIHN0cmVhbS4KICAqCiAgKiBAc2VlIDxhIGhyZWY9IiNmb3JjZVVucHVibGlzaCI+Zm9yY2VVbnB1Ymxpc2goKTwvYT4KICAqIEBzZWUgPGEgaHJlZj0iU3Vic2NyaWJlci5odG1sIj5TdWJzY3JpYmVyPC9hPgogICogQHNlZSA8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sIj5TdHJlYW1FdmVudDwvYT4KICAqCiAgKiBAbWV0aG9kICNnZXRQdWJsaXNoZXJGb3JTdHJlYW0KICAqIEBtZW1iZXJPZiBTZXNzaW9uCiAgKi8KICB0aGlzLmdldFB1Ymxpc2hlckZvclN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgdmFyIHN0cmVhbUlkOwoKICAgIGlmICh0eXBlb2Yoc3RyZWFtKSA9PSAic3RyaW5nIikgewogICAgICBzdHJlYW1JZCA9IHN0cmVhbTsKICAgIH0gZWxzZSBpZiAodHlwZW9mKHN0cmVhbSkgPT0gIm9iamVjdCIgJiYgc3RyZWFtICYmIHN0cmVhbS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICBzdHJlYW1JZCA9IHN0cmVhbS5pZDsKICAgIH0gZWxzZSB7CiAgICAgIGVycm9yTXNnID0gIlNlc3Npb24uZ2V0UHVibGlzaGVyRm9yU3RyZWFtIDo6IEludmFsaWQgc3RyZWFtIHR5cGUiOwogICAgICBPVC5lcnJvcihlcnJvck1zZyk7CiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1zZyk7CiAgICB9CgogICAgcmV0dXJuIE9ULnB1Ymxpc2hlcnMud2hlcmUoe3N0cmVhbUlkOiBzdHJlYW1JZH0pWzBdOwogIH07CgoKICAvLyBQcml2YXRlIFNlc3Npb24gQVBJOiBmb3IgaW50ZXJuYWwgT1QgdXNlIG9ubHkKICB0aGlzLl8gPSB7CiAgICBqc2VwU3Vic2NyaWJlOiBmdW5jdGlvbihzdHJlYW0sIHN1YnNjcmliZVRvVmlkZW8sIHN1YnNjcmliZVRvQXVkaW8pIHsKICAgICAgcmV0dXJuIF9zb2NrZXQuanNlcFN1YnNjcmliZShzdHJlYW0uY29ubmVjdGlvbi5pZCwgc3RyZWFtLmlkLCBzdWJzY3JpYmVUb1ZpZGVvLCBzdWJzY3JpYmVUb0F1ZGlvKTsKICAgIH0uYmluZCh0aGlzKSwKCiAgICBqc2VwVW5zdWJzY3JpYmU6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICByZXR1cm4gX3NvY2tldC5qc2VwVW5zdWJzY3JpYmUoc3RyZWFtLmNvbm5lY3Rpb24uaWQsIHN0cmVhbS5pZCk7CiAgICB9LmJpbmQodGhpcyksCgogICAganNlcENhbmRpZGF0ZTogZnVuY3Rpb24odG9Db25uZWN0aW9uSWQsIHN0cmVhbSwgY2FuZGlkYXRlKSB7CiAgICAgIHJldHVybiBfc29ja2V0LmpzZXBDYW5kaWRhdGUodG9Db25uZWN0aW9uSWQsIHN0cmVhbS5pZCwgY2FuZGlkYXRlKTsKICAgIH0uYmluZCh0aGlzKSwKCiAgICBqc2VwT2ZmZXI6IGZ1bmN0aW9uKHRvQ29ubmVjdGlvbklkLCBzdHJlYW0sIG9mZmVyU0RQKSB7CiAgICAgIHJldHVybiBfc29ja2V0LmpzZXBPZmZlcih0b0Nvbm5lY3Rpb25JZCwgc3RyZWFtLmlkLCBvZmZlclNEUCk7CiAgICB9LmJpbmQodGhpcyksCgogICAganNlcEFuc3dlcjogZnVuY3Rpb24odG9Db25uZWN0aW9uSWQsIHN0cmVhbSwgYW5zd2VyU0RQKSB7CiAgICAgIHJldHVybiBfc29ja2V0LmpzZXBBbnN3ZXIodG9Db25uZWN0aW9uSWQsIHN0cmVhbS5pZCwgYW5zd2VyU0RQKTsKICAgIH0uYmluZCh0aGlzKSwKCiAgICAvLyBzZXNzaW9uLm9uKCJzaWduYWwiLCBmdW5jdGlvbihTaWduYWxFdmVudCkpCiAgICAvLyBzZXNzaW9uLm9uKCJzaWduYWw6e3R5cGV9IiwgZnVuY3Rpb24oU2lnbmFsRXZlbnQpKQogICAgZGlzcGF0Y2hTaWduYWw6IGZ1bmN0aW9uKGZyb21Db25uZWN0aW9uLCB0eXBlLCBkYXRhKSB7CiAgICAgIHZhciBldmVudCA9IG5ldyBPVC5TaWduYWxFdmVudCh0eXBlLCBkYXRhLCBmcm9tQ29ubmVjdGlvbik7CiAgICAgIGV2ZW50LnRhcmdldCA9IHRoaXM7CgogICAgICAvLyBzaWduYWwgYSAic2lnbmFsIiBldmVudAogICAgICAvLyBOT1RFOiB0cmlnZ2VyIGRvZXNuJ3Qgc3VwcG9ydCBkZWZhdWx0QWN0aW9uLCBhbmQgdGhlcmVmb3JlIHByZXZlbnREZWZhdWx0LgogICAgICB0aGlzLnRyaWdnZXIoT1QuRXZlbnQubmFtZXMuU0lHTkFMLCBldmVudCk7CgogICAgICAvLyBzaWduYWwgYW4gInNpZ25hbDp7dHlwZX0iIGV2ZW50IiBpZiB0aGVyZSB3YXMgYSBjdXN0b20gdHlwZQogICAgICBpZiAodHlwZSkgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgIH0uYmluZCh0aGlzKSwKCiAgICBtb2RpZnlTdWJzY3JpYmVyOiBmdW5jdGlvbihzdWJzY3JpYmVyLCBrZXksIHZhbHVlKSB7CiAgICAgIHJldHVybiBfc29ja2V0Lm1vZGlmeVN1YnNjcmliZXIoc3Vic2NyaWJlciwga2V5LCB2YWx1ZSk7CiAgICB9LmJpbmQodGhpcyksCgogICAgY3JlYXRlU3RyZWFtOiBmdW5jdGlvbihwdWJsaXNoZXJJZCwgbmFtZSwgb3JpZW50YXRpb24sIGVuY29kZWRXaWR0aCwgZW5jb2RlZEhlaWdodCwgaGFzQXVkaW8sIGhhc1ZpZGVvKSB7CiAgICAgIF9zb2NrZXQuY3JlYXRlU3RyZWFtKHB1Ymxpc2hlcklkLCBuYW1lLCBvcmllbnRhdGlvbiwgZW5jb2RlZFdpZHRoLCBlbmNvZGVkSGVpZ2h0LCBoYXNBdWRpbywgaGFzVmlkZW8pOwogICAgfS5iaW5kKHRoaXMpLAoKICAgIG1vZGlmeVN0cmVhbTogZnVuY3Rpb24oc3RyZWFtSWQsIGtleSwgdmFsdWUpIHsKICAgICAgaWYgKCFzdHJlYW1JZCB8fCAha2V5IHx8IHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICBPVC5lcnJvcignT1QuU2Vzc2lvbi5tb2RpZnlTdHJlYW06IG11c3QgcHJvdmlkZSBzdHJlYW1JZCwga2V5IGFuZCB2YWx1ZSB0byBtb2RpZnkgYSBzdHJlYW0gcHJvcGVydHkuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBfc29ja2V0LnVwZGF0ZVN0cmVhbShzdHJlYW1JZCwga2V5LCB2YWx1ZSk7CiAgICB9LmJpbmQodGhpcyksCgogICAgZGVzdHJveVN0cmVhbTogZnVuY3Rpb24oc3RyZWFtSWQpIHsKICAgICAgX3NvY2tldC5kZXN0cm95U3RyZWFtKHN0cmVhbUlkKTsKICAgIH0uYmluZCh0aGlzKQogIH07CgoKIC8qKgogICogU2VuZHMgYSBzaWduYWwgdG8gZWFjaCBjbGllbnQgb3Igc3BlY2lmaWVkIGNsaWVudHMgaW4gdGhlIHNlc3Npb24uIFNwZWNpZnkgYSA8Y29kZT5jb25uZWN0aW9uczwvY29kZT4gcHJvcGVydHkKICAqIG9mIHRoZSA8Y29kZT5zaWduYWw8L2NvZGU+IHBhcmFtZXRlciB0byBsaW1pdCB0aGUgcmVjaXBpZW50cyBvZiB0aGUgc2lnbmFsOyBvdGhlcndpc2UgdGhlIHNpZ25hbCBpcyBzZW50IHRvCiAgKiBlYWNoIGNsaWVudCBjb25uZWN0ZWQgdG8gdGhlIHNlc3Npb24uCiAgKiA8cD4KICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzZW5kcyBhIHNpZ25hbCBvZiB0eXBlICJmb28iIHdpdGggYSBzcGVjaWZpZWQgZGF0YSBwYXlsb2FkIHRvIGFsbCBjbGllbnRzIGNvbm5lY3RlZCB0bwogICogdGhlIHNlc3Npb246CiAgKiA8cHJlPgogICogc2Vzc2lvbi5zaWduYWwoewogICogICAgIHR5cGU6ICJmb28iLAogICogICAgIGRhdGE6IHttZXNzYWdlU3RyaW5nOiJoZWxsbyIsIHNjb3JlczpbNywgMTQsIDIzXX0sCiAgKiAgIH0sCiAgKiAgIGZ1bmN0aW9uKGVycm9yKSB7CiAgKiAgICAgaWYgKGVycm9yKSB7CiAgKiAgICAgICBjb25zb2xlLmxvZygic2lnbmFsIGVycm9yOiAiICsgZXJyb3IucmVhc29uKTsKICAqICAgICB9IGVsc2UgewogICogICAgICAgY29uc29sZS5sb2coInNpZ25hbCBzZW50Iik7CiAgKiAgICAgfQogICogICB9CiAgKiApOwogICogPC9wcmU+CiAgKiA8cD4KICAqIENhbGxpbmcgdGhpcyBtZXRob2Qgd2l0aG91dCBsaW1pdGluZyB0aGUgc2V0IG9mIHJlY2lwaWVudCBjbGllbnRzIHdpbGwgcmVzdWx0IGluIG11bHRpcGxlIHNpZ25hbHMgc2VudCAob25lIHRvCiAgKiBlYWNoIGNsaWVudCBpbiB0aGUgc2Vzc2lvbikuIEZvciBpbmZvcm1hdGlvbiBvbiBjaGFyZ2VzIGZvciBzaWduYWxpbmcsIHNlZSB0aGUgPGEgaHJlZj0iaHR0cDovL3Rva2JveC5jb20vcHJpY2luZyI+T3BlblRvawogICogcHJpY2luZzwvYT4gcGFnZS4KICAqIDxwPgogICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNlbmRzIGEgc2lnbmFsIG9mIHR5cGUgImZvbyIgd2l0aCBhIHNwZWNpZmllZCBkYXRhIHBheWxvYWQgdG8gdHdvIHNwZWNpZmljIGNsaWVudHMKICAqIGNvbm5lY3RlZCB0byB0aGUgc2Vzc2lvbjoKICAqIDxwcmU+CiAgKiBzZXNzaW9uLnNpZ25hbCh7CiAgKiAgICAgdHlwZTogImZvbyIsCiAgKiAgICAgdG86IFtjb25uZWN0aW9uMSwgY29ubmVjdGlvbjJdOyAvLyBjb25uZWN0aW9uMSBhbmQgMiBhcmUgQ29ubmVjdGlvbiBvYmplY3RzCiAgKiAgICAgZGF0YToge21lc3NhZ2VTdHJpbmc6ImhlbGxvIn0KICAqICAgfSwKICAqICAgZnVuY3Rpb24oZXJyb3IpIHsKICAqICAgICBpZiAoZXJyb3IpIHsKICAqICAgICAgIGNvbnNvbGUubG9nKCJzaWduYWwgZXJyb3I6ICIgKyBlcnJvci5yZWFzb24pOwogICogICAgIH0gZWxzZSB7CiAgKiAgICAgICBjb25zb2xlLmxvZygic2lnbmFsIHNlbnQiKTsKICAqICAgICB9CiAgKiAgIH0KICAqICk7CiAgKiA8L3ByZT4KICAqIDxwPgogICogRWFjaCBvZiB0aGUgcHJvcGVydGllcyBvZiB0aGUgb2JqZWN0IHlvdSBwYXNzIGludG8gdGhlIDxjb2RlPnNpZ25hbCgpPC9jb2RlPiBtZXRob2QgaXMgb3B0aW9uYWwuCiAgKiA8cD4KICAqIEFkZCBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+c2lnbmFsPC9jb2RlPiBldmVudCB0byBsaXN0ZW4gZm9yIGFsbCBzaWduYWxzIHNlbnQgaW4gdGhlIHNlc3Npb24uCiAgKiBBZGQgYW4gZXZlbnQgaGFuZGxlciBmb3IgdGhlIDxjb2RlPnNpZ25hbDp0eXBlPC9jb2RlPiBldmVudCB0byBsaXN0ZW4gZm9yIHNpZ25hbHMgb2YgYSBzcGVjaWZpZWQgdHlwZQogICogb25seSAocmVwbGFjZSA8Y29kZT50eXBlPC9jb2RlPiwgaW4gPGNvZGU+c2lnbmFsOnR5cGU8L2NvZGU+LCB3aXRoIHRoZSB0eXBlIG9mIHNpZ25hbCB0byBsaXN0ZW4gZm9yKS4gVGhlCiAgKiBTZXNzaW9uIG9iamVjdCBkaXNwYXRjaGVzIHRoZXNlIGV2ZW50cy4gKFNlZSA8YSBocmVmPSIjZXZlbnRzIj5ldmVudHM8L2E+LikKICAqIDxwPgogICogRWFjaCBwcm9wZXJ0eSBpcyBvcHRpb25hbC4gSWYgeW91IHNldCBub25lIG9mIHRoZSBwcm9wZXJ0aWVzLCB5b3Ugd2lsbCBzZW5kIGEgc2lnbmFsIHdpdGggbm8gZGF0YSBvciB0eXBlIHRvCiAgKiBlYWNoIGNsaWVudCBjb25uZWN0ZWQgdG8gdGhlIHNlc3Npb24uPC9wPgogICoKICAqIEBwYXJhbSB7T2JqZWN0fSBzaWduYWwgQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzIGRlZmluaW5nIHRoZSBzaWduYWw6CiAgKiA8dWw+CiAgKiAgIDxsaT48Y29kZT50bzwvY29kZT4gJm1kYXNoOyAoQXJyYXkpIEFuIGFycmF5IG9mIDxhIGhyZWY9IkNvbm5lY3Rpb24uaHRtbCI+Q29ubmVjdGlvbjwvYT4gb2JqZWN0cywgY29ycmVzcG9uZGluZwogICogICAgICB0byBjbGllbnRzIHRoYXQgdGhlIG1lc3NhZ2UgaXMgdG8gYmUgc2VudCB0by4gSWYgeW91IGRvIG5vdCBzcGVjaWZ5IHRoaXMgcHJvcGVydHksIHRoZSBzaWduYWwgaXMgc2VudCB0byBhbGwKICAqICAgICAgY2xpZW50cyBjb25uZWN0ZWQgdG8gdGhlIHNlc3Npb24uPC9saT4KICAqICAgPGxpPjxjb2RlPmRhdGE8L2NvZGU+ICZtZGFzaDsgKE9iamVjdCkgVGhlIGRhdGEgdG8gc2VuZC4gVmFsaWQgdHlwZXMgZm9yIGRhdGEgYXJlIGEgSlNPTi1wYXJzYWJsZSBvYmplY3QsCiAgKiAgICAgYSBKU09OLXBhcnNhYmxlIGFycmF5LCBhIHN0cmluZywgYSBudW1iZXIsIGEgQm9vbGVhbiB2YWx1ZSwgb3IgPGNvZGU+bnVsbDwvY29kZT4uIE51bWJlcnMgY2Fubm90IGJlIE5hTiBvciBJbmZpbml0eS4KICAqICAgICBUaGUgbGltaXQgdG8gdGhlIHNpemUgb2YgZGF0YSBpcyA4a0IuPC9saT4KICAqICAgPGxpPjxjb2RlPnR5cGU8L2NvZGU+ICZtZGFzaDsgKFN0cmluZykgVGhlIHR5cGUgb2YgdGhlIHNpZ25hbC4gWW91IGNhbiB1c2UgdGhlIHR5cGUgdG8gZmlsdGVyIHNpZ25hbHMgd2hlbiBzZXR0aW5nIGFuCiAgKiAgICAgZXZlbnQgaGFuZGxlciBmb3IgdGhlIDxjb2RlPnNpZ25hbDp0eXBlPC9jb2RlPiBldmVudCAod2hlcmUgeW91IHJlcGxhY2UgPGNvZGU+dHlwZTwvY29kZT4gd2l0aCB0aGUgdHlwZSBzdHJpbmcpLgogICogICAgIFRoZSBtYXhpbXVtIGxlbmd0aCBvZiB0aGUgPGNvZGU+dHlwZTwvY29kZT4gc3RyaW5nIGlzIDEyOCBjaGFyYWN0ZXJzLCBhbmQgaXQgbXVzdCBjb250YWluIG9ubHkgbGV0dGVycyAoQS1aIGFuZCBhLXopLAogICogICAgIG51bWJlcnMgKDAtOSksICctJywgJ18nLCBhbmQgJ34nLjwvbGk+CiAgKiAgIDwvbGk+CiAgKiA8L3VsPgogICoKICAqIDxwPkVhY2ggcHJvcGVydHkgaXMgb3B0aW9uYWwuIElmIHlvdSBzZXQgbm9uZSBvZiB0aGUgcHJvcGVydGllcywgeW91IHdpbGwgc2VuZCBhIHNpZ25hbCB3aXRoIG5vIGRhdGEgb3IgdHlwZSB0bwogICogZWFjaCBjbGllbnQgY29ubmVjdGVkIHRvIHRoZSBzZXNzaW9uLjwvcD4KICAqCiAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb21wbGV0aW9uSGFuZGxlciBBIGZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIHdoZW4gc2VuZGluZyB0aGUgc2lnbmFsIHN1Y2NlZWRzIG9yIGZhaWxzLiBUaGlzCiAgKiBmdW5jdGlvbiB0YWtlcyBvbmUgcGFyYW1ldGVyLCA8Y29kZT5lcnJvcjwvY29kZT4sIHdoaWNoIGlzIHNldCB0byA8Y29kZT5udWxsPC9jb2RlPiBpZiBzZW5kaW5nIHRoZSBzaWduYWwgc3VjY2VlZHM7CiAgKiBvdGhlcndpc2UgdGhlIDxjb2RlPmVycm9yPC9jb2RlPiBvYmplY3QgaGFzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAqCiAgKiA8dWw+CiAgKiAgIDxsaT48Y29kZT5jb2RlPC9jb2RlPiAmbWRhc2g7IChOdW1iZXIpIEFuIGVycm9yIGNvZGUsIHdoaWNoIGNhbiBiZSBvbmUgb2YgdGhlIGZvbGxvd2luZzoKICAqICAgICA8dGFibGUgc3R5bGU9IndpZHRoOjEwMCUiPgogICogICAgICAgICA8dHI+CiAgKiAgICAgICAgICAgPHRkPjQwMDwvdGQ+IDx0ZD5PbmUgb2YgdGhlIHNpZ25hbCBwcm9wZXJ0aWVzICZtZGFzaDsgZGF0YSwgdHlwZSwgb3IgdG8gJm1kYXNoOyBpcyBpbnZhbGlkLgogICogICAgICAgICAgICAgICAgICAgICAgICAgT3IgdGhlIGRhdGEgY2Fubm90IGJlIHBhcnNlZCBhcyBKU09OLjwvdGQ+CiAgKiAgICAgICAgIDwvdHI+CiAgKiAgICAgICAgIDx0cj4KICAqICAgICAgICAgICA8dGQ+NDA0PC90ZD4gPHRkPlRoZSB0byBjb25uZWN0aW9uIGRvZXMgbm90IGV4aXN0LjwvdGQ+CiAgKiAgICAgICAgIDwvdHI+CiAgKiAgICAgICAgIDx0cj4KICAqICAgICAgICAgICA8dGQ+NDEzPC90ZD4gPHRkPlRoZSB0eXBlIHN0cmluZyBleGNlZWRzIHRoZSBtYXhpbXVtIGxlbmd0aCAoMTI4IGNoYXJhY3RlcnMpLAogICogICAgICAgICAgICAgICAgICAgICAgICBvciB0aGUgZGF0YSBwcm9wZXJ0eSBleGNlZWRzIHRoZSBtYXhpbXVtIHNpemUgKDhrQikuPC90ZD4KICAqICAgICAgICAgPC90cj4KICAqICAgICAgICAgPHRyPgogICogICAgICAgICAgIDx0ZD41MDA8L3RkPiA8dGQ+VGhlIFdlYlNvY2tldCBjb25uZWN0aW9uIGlzIGRvd24uPC90ZD4KICAqICAgICAgICAgPC90cj4KICAqICAgICAgPC90YWJsZT4KICAqICAgPC9saT4KICAqICAgPGxpPjxjb2RlPnJlYXNvbjwvY29kZT4gJm1kYXNoOyAoU3RyaW5nKSBBIGRlc2NyaXB0aW9uIG9mIHRoZSBlcnJvci48L2xpPgogICogICA8bGk+PGNvZGU+c2lnbmFsPC9jb2RlPiAmbWRhc2g7IChPYmplY3QpIEFuIG9iamVjdCB3aXRoIHByb3BlcnRpZXMgY29ycmVzcG9uZGluZyB0byB0aGUgdmFsdWVzIHBhc3NlZAogICogICAgIGludG8gdGhlIDxjb2RlPnNpZ25hbCgpPC9jb2RlPiBtZXRob2QgJm1kYXNoOyA8Y29kZT5kYXRhPC9jb2RlPiwgPGNvZGU+dG88L2NvZGU+LCBhbmQgPGNvZGU+dHlwZTwvY29kZT4uCiAgKiAgIDwvbGk+CiAgKiA8L3VsPgogICoKICAqIDxwPk5vdGUgdGhhdCB0aGUgPGNvZGU+Y29tcGxldGlvbkhhbmRsZXI8L2NvZGU+IHN1Y2Nlc3MgcmVzdWx0ICg8Y29kZT5lcnJvciA9PSBudWxsPC9jb2RlPikgaW5kaWNhdGVzIHRoYXQgdGhlCiAgKiBvcHRpb25zIHBhc3NlZCBpbnRvIHRoZSA8Y29kZT5TZXNzaW9uLnNpZ25hbCgpPC9jb2RlPiBtZXRob2QgYXJlIHZhbGlkIGFuZCB0aGUgc2lnbmFsIHdhcyBzZW50LiBJdCBkb2VzCiAgKiA8aT5ub3Q8L2k+IGluZGljYXRlIHRoYXQgdGhlIHNpZ25hbCB3YXMgc3VjZXNzZnVsbHkgcmVjZWl2ZWQgYnkgYW55IG9mIHRoZSBpbnRlbmRlZCByZWNpcGllbnRzLgogICoKICAqIEBtZXRob2QgI3NpZ25hbAogICogQG1lbWJlck9mIFNlc3Npb24KICAqIEBzZWUgPGEgaHJlZj0iI2V2ZW50OnNpZ25hbCI+c2lnbmFsPC9hPiBhbmQgPGEgaHJlZj0iI2V2ZW50OnNpZ25hbDp0eXBlIj5zaWduYWw6dHlwZTwvYT4gZXZlbnRzCiAgKi8KICB0aGlzLnNpZ25hbCA9IGZ1bmN0aW9uKG9wdGlvbnMsIGNvbXBsZXRpb24pIHsKICAgIF9zb2NrZXQuc2lnbmFsKG9wdGlvbnMsIGNvbXBsZXRpb24pOwogIH07CgogLyoqCiAgKiAgIEZvcmNlcyBhIHJlbW90ZSBjb25uZWN0aW9uIHRvIGxlYXZlIHRoZSBzZXNzaW9uLgogICoKICAqIDxwPgogICogICBUaGUgPGNvZGU+Zm9yY2VEaXNjb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBpcyBub3JtYWxseSB1c2VkIGFzIGEgbW9kZXJhdGlvbiB0b29sCiAgKiAgICAgICAgdG8gcmVtb3ZlIHVzZXJzIGZyb20gYW4gb25nb2luZyBzZXNzaW9uLgogICogPC9wPgogICogPHA+CiAgKiAgIFdoZW4gYSBjb25uZWN0aW9uIGlzIHRlcm1pbmF0ZWQgdXNpbmcgdGhlIDxjb2RlPmZvcmNlRGlzY29ubmVjdCgpPC9jb2RlPiwKICAqICAgICAgICA8Y29kZT5zZXNzaW9uRGlzY29ubmVjdGVkPC9jb2RlPiwgPGNvZGU+Y29ubmVjdGlvbkRlc3Ryb3llZDwvY29kZT4gYW5kCiAgKiAgICAgICAgPGNvZGU+c3RyZWFtRGVzdHJveWVkPC9jb2RlPiBldmVudHMgYXJlIGRpc3BhdGNoZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHRoZXkKICAqICAgICAgICB3b3VsZCBiZSBpZiB0aGUgY29ubmVjdGlvbiBoYWQgdGVybWluYXRlZCBpdHNlbGYgdXNpbmcgdGhlIDxjb2RlPmRpc2Nvbm5lY3QoKTwvY29kZT4gbWV0aG9kLiBIb3dldmVyLAogICogICAgICAgIHRoZSA8Y29kZT5yZWFzb248L2NvZGU+IHByb3BlcnR5IG9mIGEge0BsaW5rIENvbm5lY3Rpb25FdmVudH0gb3Ige0BsaW5rIFN0cmVhbUV2ZW50fSBvYmplY3Qgc3BlY2lmaWVzCiAgKiAgICAgICAgPGNvZGU+ImZvcmNlRGlzY29ubmVjdGVkIjwvY29kZT4gYXMgdGhlIHJlYXNvbiBmb3IgdGhlIGRlc3RydWN0aW9uIG9mIHRoZSBjb25uZWN0aW9uIGFuZCBzdHJlYW0ocykuCiAgKiA8L3A+CiAgKiA8cD4KICAqICAgV2hpbGUgeW91IGNhbiB1c2UgdGhlIDxjb2RlPmZvcmNlRGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2QgdG8gdGVybWluYXRlIHlvdXIgb3duIGNvbm5lY3Rpb24sCiAgKiAgICAgICAgY2FsbGluZyB0aGUgPGNvZGU+ZGlzY29ubmVjdCgpPC9jb2RlPiBtZXRob2QgaXMgc2ltcGxlci4KICAqIDwvcD4KICAqIDxwPgogICogICBUaGUgVEIgb2JqZWN0IGRpc3BhdGNoZXMgYW4gPGNvZGU+ZXhjZXB0aW9uPC9jb2RlPiBldmVudCBpZiB0aGUgdXNlcidzIHJvbGUKICAqICAgZG9lcyBub3QgaW5jbHVkZSBwZXJtaXNzaW9ucyByZXF1aXJlZCB0byBmb3JjZSBvdGhlciB1c2VycyB0byBkaXNjb25uZWN0LgogICogICAgICAgIFlvdSBkZWZpbmUgYSB1c2VyJ3Mgcm9sZSB3aGVuIHlvdSBjcmVhdGUgdGhlIHVzZXIgdG9rZW4gdXNpbmcgdGhlIDxjb2RlPmdlbmVyYXRlX3Rva2VuKCk8L2NvZGU+CiAgKiAgICAgICAgbWV0aG9kIHVzaW5nIG91ciA8YSBocmVmPSIvb3BlbnRvay9saWJyYXJpZXMvc2VydmVyLyI+c2VydmVyLXNpZGUgbGlicmFyaWVzPC9hPiBvciB0aGUgPGEgaHJlZj0iaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cyI+RGFzaGJvYXJkPC9hPiBwYWdlLgogICogICBTZWUgPGEgaHJlZj0iRXhjZXB0aW9uRXZlbnQuaHRtbCI+RXhjZXB0aW9uRXZlbnQ8L2E+IGFuZCA8YSBocmVmPSJUQi5odG1sI2FkZEV2ZW50TGlzdGVuZXIiPlRCLmFkZEV2ZW50TGlzdGVuZXIoKTwvYT4uCiAgKiA8L3A+CiAgKiA8cD4KICAqICAgVGhlIGFwcGxpY2F0aW9uIHRocm93cyBhbiBlcnJvciBpZiB0aGUgc2Vzc2lvbiBpcyBub3QgY29ubmVjdGVkLgogICogPC9wPgogICoKICAqIDxoNT5FdmVudHMgZGlzcGF0Y2hlZDo8L2g1PgogICoKICAqIDxwPgogICogICA8Y29kZT5jb25uZWN0aW9uRGVzdHJveWVkPC9jb2RlPiAoPGEgaHJlZj0iQ29ubmVjdGlvbkV2ZW50Lmh0bWwiPkNvbm5lY3Rpb25FdmVudDwvYT4pICYjMTUxOwogICogICAgIE9uIGNsaWVudHMgb3RoZXIgdGhhbiB3aGljaCBoYWQgdGhlIGNvbm5lY3Rpb24gdGVybWluYXRlZC4KICAqIDwvcD4KICAqIDxwPgogICogICA8Y29kZT5leGNlcHRpb248L2NvZGU+ICg8YSBocmVmPSJFeGNlcHRpb25FdmVudC5odG1sIj5FeGNlcHRpb25FdmVudDwvYT4pICYjMTUxOwogICogICAgIFRoZSB1c2VyJ3Mgcm9sZSBkb2VzIG5vdCBhbGxvdyBmb3JjaW5nIG90aGVyIHVzZXIncyB0byBkaXNjb25uZWN0ICg8Y29kZT5ldmVudC5jb2RlID0gMTUzMDwvY29kZT4pLAogICogICBvciB0aGUgc3BlY2lmaWVkIHN0cmVhbSBpcyBub3QgcHVibGlzaGluZyB0byB0aGUgc2Vzc2lvbiAoPGNvZGU+ZXZlbnQuY29kZSA9IDE1MzU8L2NvZGU+KS4KICAqIDwvcD4KICAqIDxwPgogICogICA8Y29kZT5zZXNzaW9uRGlzY29ubmVjdGVkPC9jb2RlPiAoPGEgaHJlZj0iU2Vzc2lvbkRpc2Nvbm5lY3RFdmVudC5odG1sIj5TZXNzaW9uRGlzY29ubmVjdEV2ZW50PC9hPikgJiMxNTE7CiAgKiAgICAgT24gdGhlIGNsaWVudCB3aGljaCBoYXMgdGhlIGNvbm5lY3Rpb24gdGVybWluYXRlZC4KICAqIDwvcD4KICAqIDxwPgogICogICA8Y29kZT5zdHJlYW1EZXN0cm95ZWQ8L2NvZGU+ICg8YSBocmVmPSJTdHJlYW1FdmVudC5odG1sIj5TdHJlYW1FdmVudDwvYT4pICYjMTUxOwogICogICAgIElmIHN0cmVhbXMgYXJlIHN0b3BwZWQgYXMgYSByZXN1bHQgb2YgdGhlIGNvbm5lY3Rpb24gZW5kaW5nLgogICogPC9wPgogICoKICAqIEBwYXJhbSB7Q29ubmVjdGlvbn0gY29ubmVjdGlvbiBUaGUgY29ubmVjdGlvbiB0byBiZSBkaXNjb25uZWN0ZWQgZnJvbSB0aGUgc2Vzc2lvbi4KICAqIFRoaXMgdmFsdWUgY2FuIGVpdGhlciBiZSBhIDxhIGhyZWY9IkNvbm5lY3Rpb24uaHRtbCI+Q29ubmVjdGlvbjwvYT4gb2JqZWN0IG9yIGEgY29ubmVjdGlvbiBJRCAod2hpY2ggY2FuIGJlCiAgKiBvYnRhaW5lZCBmcm9tIHRoZSA8Y29kZT5jb25uZWN0aW9uSWQ8L2NvZGU+IHByb3BlcnR5IG9mIHRoZSBDb25uZWN0aW9uIG9iamVjdCkuCiAgKgogICogQG1ldGhvZCAjZm9yY2VEaXNjb25uZWN0CiAgKiBAbWVtYmVyT2YgU2Vzc2lvbgogICovCgogIHRoaXMuZm9yY2VEaXNjb25uZWN0ID0gZnVuY3Rpb24oY29ubmVjdGlvbk9yQ29ubmVjdGlvbklkLCBjb21wbGV0aW9uSGFuZGxlcikgewogICAgdmFyIG5vdFBlcm1pdHRlZEVycm9yTXNnID0gIlRoaXMgdG9rZW4gZG9lcyBub3QgYWxsb3cgZm9yY2VEaXNjb25uZWN0LiBUaGUgcm9sZSBtdXN0IGJlIGF0IGxlYXN0IGBtb2RlcmF0b3JgIHRvIGVuYWJsZSB0aGlzIGZ1bmN0aW9uYWxpdHkiOwoKICAgIGlmIChwZXJtaXR0ZWRUbygiZm9yY2VEaXNjb25uZWN0IikpIHsKICAgICAgdmFyIGNvbm5lY3Rpb25JZCA9IHR5cGVvZihjb25uZWN0aW9uT3JDb25uZWN0aW9uSWQpID09PSAnc3RyaW5nJyA/IGNvbm5lY3Rpb25PckNvbm5lY3Rpb25JZCA6IGNvbm5lY3Rpb25PckNvbm5lY3Rpb25JZC5pZDsKCiAgICAgIGlmIChjb21wbGV0aW9uSGFuZGxlcikgewogICAgICAgIHZhciB3b3JrID0gbmV3IFJlbW90ZVdvcmsodGhpcywgY29tcGxldGlvbkhhbmRsZXIsIHsKICAgICAgICAgIHRpbWVvdXRNZXNzYWdlOiAiVGltZWQgb3V0IHdoaWxlIHdhaXRpbmcgZm9yIGNvbm5lY3Rpb24gIiArIGNvbm5lY3Rpb25JZCArICIgdG8gYmUgZm9yY2UgRGlzY29ubmVjdGVkLiIKICAgICAgICB9KTsKCiAgICAgICAgd29yay5mYWlsc09uRXhjZXB0aW9uQ29kZXMoewogICAgICAgICAgMTUyMDogbm90UGVybWl0dGVkRXJyb3JNc2cKICAgICAgICB9KTsKCiAgICAgICAgX2NhbGxiYWNrcy5mb3JjZURpc2Nvbm5lY3RbY29ubmVjdGlvbklkXSA9IHdvcms7CiAgICAgIH0KCiAgICAgIF9zb2NrZXQuZm9yY2VEaXNjb25uZWN0KGNvbm5lY3Rpb25JZCk7CiAgICB9IGVsc2UgewogICAgICAvLyBpZiB0aGlzIHRocm93cyBhbiBlcnJvciB0aGUgaGFuZGxlSnNFeGNlcHRpb24gd29uJ3Qgb2NjdXIKICAgICAgaWYgKGNvbXBsZXRpb25IYW5kbGVyKSBPVC4kLmNhbGxBc3luYyhjb21wbGV0aW9uSGFuZGxlciwgbmV3IE9ULkVycm9yKG51bGwsIG5vdFBlcm1pdHRlZEVycm9yTXNnKSk7CgogICAgICBUQi5oYW5kbGVKc0V4Y2VwdGlvbihub3RQZXJtaXR0ZWRFcnJvck1zZywgT1QuRXhjZXB0aW9uQ29kZXMuVU5BQkxFX1RPX0ZPUkNFX0RJU0NPTk5FQ1QsIHsKICAgICAgICBzZXNzaW9uOiB0aGlzCiAgICAgIH0pOwogICAgfQogIH07CgogLyoqCiAgKiBGb3JjZXMgdGhlIHB1Ymxpc2hlciBvZiB0aGUgc3BlY2lmaWVkIHN0cmVhbSB0byBzdG9wIHB1Ymxpc2hpbmcgdGhlIHN0cmVhbS4KICAqCiAgKiA8cD4KICAqIENhbGxpbmcgdGhpcyBtZXRob2QgY2F1c2VzIHRoZSBTZXNzaW9uIG9iamVjdCB0byBkaXNwYXRjaCBhIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4KICAqIGV2ZW50IG9uIGFsbCBjbGllbnRzIHRoYXQgYXJlIHN1YnNjcmliZWQgdG8gdGhlIHN0cmVhbSAoaW5jbHVkaW5nIHRoZSBjbGllbnQgdGhhdCBpcwogICogcHVibGlzaGluZyB0aGUgc3RyZWFtKS4gVGhlIDxjb2RlPnJlYXNvbjwvY29kZT4gcHJvcGVydHkgb2YgdGhlIFN0cmVhbUV2ZW50IG9iamVjdCBpcwogICogc2V0IHRvIDxjb2RlPiJmb3JjZVVucHVibGlzaGVkIjwvY29kZT4uCiAgKiA8L3A+CiAgKiA8cD4KICAqIFRoZSBUQiBvYmplY3QgZGlzcGF0Y2hlcyBhbiA8Y29kZT5leGNlcHRpb248L2NvZGU+IGV2ZW50IGlmIHRoZSB1c2VyJ3Mgcm9sZQogICogZG9lcyBub3QgaW5jbHVkZSBwZXJtaXNzaW9ucyByZXF1aXJlZCB0byBmb3JjZSBvdGhlciB1c2VycyB0byB1bnB1Ymxpc2guCiAgKiBZb3UgZGVmaW5lIGEgdXNlcidzIHJvbGUgd2hlbiB5b3UgY3JlYXRlIHRoZSB1c2VyIHRva2VuIHVzaW5nIHRoZSA8Y29kZT5nZW5lcmF0ZV90b2tlbigpPC9jb2RlPgogICogbWV0aG9kIHVzaW5nIG91ciA8YSBocmVmPSIvb3BlbnRvay9saWJyYXJpZXMvc2VydmVyLyI+c2VydmVyLXNpZGUgbGlicmFyaWVzPC9hPiBvciB0aGUgPGEgaHJlZj0iaHR0cHM6Ly9kYXNoYm9hcmQudG9rYm94LmNvbS9wcm9qZWN0cyI+RGFzaGJvYXJkPC9hPiBwYWdlIHBhZ2UuCiAgKiBZb3UgcGFzcyB0aGUgdG9rZW4gc3RyaW5nIGFzIGEgcGFyYW1ldGVyIG9mIHRoZSA8Y29kZT5jb25uZWN0KCk8L2NvZGU+IG1ldGhvZCBvZiB0aGUgU2Vzc2lvbiBvYmplY3QuCiAgKiBTZWUgPGEgaHJlZj0iRXhjZXB0aW9uRXZlbnQuaHRtbCI+RXhjZXB0aW9uRXZlbnQ8L2E+IGFuZCA8YSBocmVmPSJUQi5odG1sI2FkZEV2ZW50TGlzdGVuZXIiPlRCLmFkZEV2ZW50TGlzdGVuZXIoKTwvYT4uCiAgKiA8L3A+CiAgKgogICogPGg1PkV2ZW50cyBkaXNwYXRjaGVkOjwvaDU+CiAgKgogICogPHA+CiAgKiAgIDxjb2RlPmV4Y2VwdGlvbjwvY29kZT4gKDxhIGhyZWY9IkV4Y2VwdGlvbkV2ZW50Lmh0bWwiPkV4Y2VwdGlvbkV2ZW50PC9hPikgJiMxNTE7CiAgKiAgICAgVGhlIHVzZXIncyByb2xlIGRvZXMgbm90IGFsbG93IGZvcmNpbmcgb3RoZXIgdXNlcnMgdG8gdW5wdWJsaXNoLgogICogPC9wPgogICogPHA+CiAgKiAgIDxjb2RlPnN0cmVhbURlc3Ryb3llZDwvY29kZT4gKDxhIGhyZWY9IlN0cmVhbUV2ZW50Lmh0bWwiPlN0cmVhbUV2ZW50PC9hPikgJiMxNTE7CiAgKiAgICAgVGhlIHN0cmVhbSBoYXMgYmVlbiB1bnB1Ymxpc2hlZC4gVGhlIFNlc3Npb24gb2JqZWN0IGRpc3BhdGNoZXMgdGhpcyBvbiBhbGwgY2xpZW50cwogICogICAgIHN1YnNjcmliZWQgdG8gdGhlIHN0cmVhbSwgYXMgd2VsbCBhcyBvbiB0aGUgcHVibGlzaGVyJ3MgY2xpZW50LgogICogPC9wPgogICoKICAqIEBwYXJhbSB7U3RyZWFtfSBzdHJlYW0gVGhlIHN0cmVhbSB0byBiZSB1bnB1Ymxpc2hlZC4KICAqCiAgKiBAbWV0aG9kICNmb3JjZVVucHVibGlzaAogICogQG1lbWJlck9mIFNlc3Npb24KICAqLwogIHRoaXMuZm9yY2VVbnB1Ymxpc2ggPSBmdW5jdGlvbihzdHJlYW1PclN0cmVhbUlkLCBjb21wbGV0aW9uSGFuZGxlcikgewogICAgdmFyIG5vdFBlcm1pdHRlZEVycm9yTXNnID0gIlRoaXMgdG9rZW4gZG9lcyBub3QgYWxsb3cgZm9yY2VVbnB1Ymxpc2guIFRoZSByb2xlIG11c3QgYmUgYXQgbGVhc3QgYG1vZGVyYXRvcmAgdG8gZW5hYmxlIHRoaXMgZnVuY3Rpb25hbGl0eSI7CgogICAgaWYgKHBlcm1pdHRlZFRvKCJmb3JjZVVucHVibGlzaCIpKSB7CiAgICAgIHZhciBzdHJlYW0gPSB0eXBlb2Yoc3RyZWFtT3JTdHJlYW1JZCkgPT09ICdzdHJpbmcnID8gdGhpcy5zdHJlYW1zLmdldChzdHJlYW1PclN0cmVhbUlkKSA6IHN0cmVhbU9yU3RyZWFtSWQ7CgogICAgICBpZiAoY29tcGxldGlvbkhhbmRsZXIpIHsKICAgICAgICB2YXIgd29yayA9IG5ldyBSZW1vdGVXb3JrKHRoaXMsIGNvbXBsZXRpb25IYW5kbGVyLCB7CiAgICAgICAgICB0aW1lb3V0TWVzc2FnZTogIlRpbWVkIG91dCB3aGlsZSB3YWl0aW5nIGZvciBzdHJlYW0gIiArIHN0cmVhbS5pZCArICIgdG8gYmUgZm9yY2UgdW5wdWJsaXNoZWQuIgogICAgICAgIH0pOwoKICAgICAgICB3b3JrLmZhaWxzT25FeGNlcHRpb25Db2Rlcyh7CiAgICAgICAgICAxNTMwOiBub3RQZXJtaXR0ZWRFcnJvck1zZwogICAgICAgIH0pOwoKICAgICAgICBfY2FsbGJhY2tzLmZvcmNlVW5wdWJsaXNoW3N0cmVhbS5pZF0gPSB3b3JrOwogICAgICB9CgogICAgICBfc29ja2V0LmZvcmNlVW5wdWJsaXNoKHN0cmVhbS5pZCk7CiAgICB9IGVsc2UgewogICAgICAvLyBpZiB0aGlzIHRocm93cyBhbiBlcnJvciB0aGUgaGFuZGxlSnNFeGNlcHRpb24gd29uJ3Qgb2NjdXIKICAgICAgaWYgKGNvbXBsZXRpb25IYW5kbGVyKSBPVC4kLmNhbGxBc3luYyhjb21wbGV0aW9uSGFuZGxlciwgbmV3IE9ULkVycm9yKG51bGwsIG5vdFBlcm1pdHRlZEVycm9yTXNnKSk7CgogICAgICBUQi5oYW5kbGVKc0V4Y2VwdGlvbihub3RQZXJtaXR0ZWRFcnJvck1zZywgT1QuRXhjZXB0aW9uQ29kZXMuVU5BQkxFX1RPX0ZPUkNFX1VOUFVCTElTSCwgewogICAgICAgIHNlc3Npb246IHRoaXMKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgdGhpcy5nZXRTdGF0ZU1hbmFnZXIgPSBmdW5jdGlvbigpIHsKICAgICAgT1Qud2FybigiRml4bWU6IEhhdmUgbm90IGltcGxlbWVudGVkIHNlc3Npb24uZ2V0U3RhdGVNYW5hZ2VyIik7CiAgfTsKCiAgT1QuJC5kZWZpbmVHZXR0ZXJzKHRoaXMsIHsKICAgIGFwaUtleTogZnVuY3Rpb24oKSB7IHJldHVybiBfYXBpS2V5OyB9LAogICAgdG9rZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3Rva2VuOyB9LAogICAgY29ubmVjdGVkOiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuaXMoJ2Nvbm5lY3RlZCcpOyB9LAogICAgY29ubmVjdGlvbjogZnVuY3Rpb24oKSB7IHJldHVybiBfc29ja2V0ICYmIF9zb2NrZXQuaWQgPyB0aGlzLmNvbm5lY3Rpb25zLmdldChfc29ja2V0LmlkKSA6IG51bGw7IH0sCiAgICBjYXBhYmlsaXRpZXM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3NvY2tldCA/IF9zb2NrZXQuY2FwYWJpbGl0aWVzIDogbmV3IE9ULkNhcGFiaWxpdGllcyhbXSk7IH0sCiAgICBzZXNzaW9uSWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gX3Nlc3Npb25JZDsgfSwKICAgIGlkOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZXNzaW9uSWQ7IH0KICB9LCB0cnVlKTsKCgogIC8qKgogICAqIEEgbmV3IGNvbm5lY3Rpb24gdG8gdGhpcyBzZXNzaW9uIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICogQG5hbWUgY29ubmVjdGlvbkNyZWF0ZWQKICAgKiBAZXZlbnQKICAgKiBAbWVtYmVyb2YgU2Vzc2lvbgogICAqIEBzZWUgQ29ubmVjdGlvbkV2ZW50CiAgICogQHNlZSA8YSBocmVmPSJUQi5odG1sI2luaXRTZXNzaW9uIj5UQi5pbml0U2Vzc2lvbigpPC9hPgogICAqLwoKICAvKioKICAgKiBBIGNvbm5lY3Rpb24gdG8gdGhpcyBzZXNzaW9uIGhhcyBlbmRlZC4KICAgKiBAbmFtZSBjb25uZWN0aW9uRGVzdHJveWVkCiAgICogQGV2ZW50CiAgICogQG1lbWJlcm9mIFNlc3Npb24KICAgKiBAc2VlIENvbm5lY3Rpb25FdmVudAogICAqLwoKICAvKioKICAgKiBUaGUgcGFnZSBoYXMgY29ubmVjdGVkIHRvIGFuIE9wZW5Ub2sgc2Vzc2lvbi4gVGhpcyBldmVudCBpcyBkaXNwYXRjaGVkIGFzeW5jaHJvbm91c2x5IGluIHJlc3BvbnNlIHRvCiAgICogYSBzdWNjZXNzZnVsIGNhbGwgdG8gdGhlIDxjb2RlPmNvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIGEgU2Vzc2lvbiBvYmplY3QuIEJlZm9yZSBjYWxsaW5nIHRoZSA8Y29kZT5jb25uZWN0KCk8L2NvZGU+CiAgICogbWV0aG9kLCBpbml0aWFsaXplIHRoZSBzZXNzaW9uIGJ5IGNhbGxpbmcgdGhlIDxjb2RlPlRCLmluaXRTZXNzaW9uKCk8L2NvZGU+IG1ldGhvZC4gRm9yIGEgY29kZSBleGFtcGxlIGFuZCBtb3JlIGRldGFpbHMsCiAgICogc2VlIDxhIGhyZWY9IiNjb25uZWN0Ij5TZXNzaW9uLmNvbm5lY3QoKTwvYT4uCiAgICogQG5hbWUgc2Vzc2lvbkNvbm5lY3RlZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSBTZXNzaW9uQ29ubmVjdEV2ZW50CiAgICogQHNlZSA8YSBocmVmPSIjY29ubmVjdCI+U2Vzc2lvbi5jb25uZWN0KCk8L2E+CiAgICogQHNlZSA8YSBocmVmPSJUQi5odG1sI2luaXRTZXNzaW9uIj5UQi5pbml0U2Vzc2lvbigpPC9hPgogICAqLwoKICAvKioKICAgKiBUaGUgc2Vzc2lvbiBoYXMgZGlzY29ubmVjdGVkLiBUaGlzIGV2ZW50IG1heSBiZSBkaXNwYXRjaGVkIGFzeW5jaHJvbm91c2x5IGluIHJlc3BvbnNlIHRvIGEgc3VjY2Vzc2Z1bCBjYWxsIHRvIHRoZQogICAqIDxjb2RlPmRpc2Nvbm5lY3QoKTwvY29kZT4gbWV0aG9kIG9mIHRoZSBTZXNzaW9uIG9iamVjdC4gVGhlIGV2ZW50IG1heSBhbHNvIGJlIGRpc3B0YWNoZWQgaWYgYSBzZXNzaW9uIGNvbm5lY3Rpb24gaXMgbG9zdAogICAqIGluYWR2ZXJ0YW50bHksIGFzIGluIHRoZSBjYXNlIG9mIGEgbG9zdCBuZXR3b3JrIGNvbm5lY3Rpb24uCiAgICogQG5hbWUgc2Vzc2lvbkRpc2Nvbm5lY3RlZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSA8YSBocmVmPSIjZGlzY29ubmVjdCI+U2Vzc2lvbi5kaXNjb25uZWN0KCk8L2E+CiAgICogQHNlZSA8YSBocmVmPSIjZGlzY29ubmVjdCI+U2Vzc2lvbi5mb3JjZURpc2Nvbm5lY3QoKTwvYT4KICAgKiBAc2VlIFNlc3Npb25EaXNjb25uZWN0RXZlbnQKICAgKi8KCiAgLyoqCiAgICogQSBuZXcgc3RyZWFtIGhhcyBiZWVuIGNyZWF0ZWQgb24gdGhpcyBzZXNzaW9uLiBGb3IgYSBjb2RlIGV4YW1wbGUgYW5kIG1vcmUgZGV0YWlscywgc2VlIHtAbGluayBTdHJlYW1FdmVudH0uCiAgICogQG5hbWUgc3RyZWFtQ3JlYXRlZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSBTdHJlYW1FdmVudAogICAqIEBzZWUgPGEgaHJlZj0iU2Vzc2lvbi5odG1sI3B1Ymxpc2giPlNlc3Npb24ucHVibGlzaCgpPC9hPgogICAqLwoKICAvKioKICAgKiBBIHN0cmVhbSBoYXMgY2xvc2VkIG9uIHRoaXMgY29ubmVjdGlvbi4gRm9yIGEgY29kZSBleGFtcGxlIGFuZCBtb3JlIGRldGFpbHMsIHNlZSB7QGxpbmsgU3RyZWFtRXZlbnR9LgogICAqIEBuYW1lIHN0cmVhbURlc3Ryb3llZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSBTdHJlYW1FdmVudAogICAqLwoKICAvKioKICAgKiBBIHN0cmVhbSBoYXMgc3RhcnRlZCBvciBzdG9wcGVkIHB1Ymxpc2hpbmcgYXVkaW8gb3IgdmlkZW8gKHNlZSA8YSBocmVmPSJQdWJsaXNoZXIuaHRtbCNwdWJsaXNoQXVkaW8iPlB1Ymxpc2hlci5wdWJsaXNoQXVkaW8oKTwvYT4gYW5kCiAgICogPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaFZpZGVvIj5QdWJsaXNoZXIucHVibGlzaFZpZGVvKCk8L2E+KTsgb3IgdGhlIDxjb2RlPnZpZGVvRGltZW5zaW9uczwvY29kZT4gcHJvcGVydHkgb2YgdGhlIFN0cmVhbQogICAqIG9iamVjdCBoYXMgY2hhbmdlZCAoc2VlIDxhIGhyZWY9IlN0cmVhbS5odG1sIyJ2aWRlb0RpbWVuc2lvbnM+U3RyZWFtLnZpZGVvRGltZW5zaW9uczwvYT4pLgogICAqIEBuYW1lIHN0cmVhbVByb3BlcnR5Q2hhbmdlZAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSBTdHJlYW1Qcm9wZXJ0eUNoYW5nZWRFdmVudAogICAqIEBzZWUgPGEgaHJlZj0iUHVibGlzaGVyLmh0bWwjcHVibGlzaEF1ZGlvIj5QdWJsaXNoZXIucHVibGlzaEF1ZGlvKCk8L2E+CiAgICogQHNlZSA8YSBocmVmPSJQdWJsaXNoZXIuaHRtbCNwdWJsaXNoVmlkZW8iPlB1Ymxpc2hlci5wdWJsaXNoVmlkZW8oKTwvYT4KICAgKiBAc2VlIDxhIGhyZWY9IlN0cmVhbS5odG1sIyJoYXNBdWRpbz5TdHJlYW0uaGFzQXVkaW88L2E+CiAgICogQHNlZSA8YSBocmVmPSJTdHJlYW0uaHRtbCMiaGFzVmlkZW8+U3RyZWFtLmhhc1ZpZGVvPC9hPgogICAqIEBzZWUgPGEgaHJlZj0iU3RyZWFtLmh0bWwjInZpZGVvRGltZW5zaW9ucz5TdHJlYW0udmlkZW9EaW1lbnNpb25zPC9hPgogICAqLwoKICAvKioKICAgKiBBIHNpZ25hbCB3YXMgcmVjZWl2ZWQgZnJvbSB0aGUgc2Vzc2lvbi4gVGhlIDxhIGhyZWY9IlNpZ25hbEV2ZW50Lmh0bWwiPlNpZ25hbEV2ZW50PC9hPiBjbGFzcyBkZWZpbmVzIHRoaXMgZXZlbnQgb2JqZWN0LgogICAqIEl0IGluY2x1ZGVzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgKiA8dWw+CiAgICogICA8bGk+PGNvZGU+ZGF0YTwvY29kZT4gJm1kYXNoOyAoT2JqZWN0KSBUaGUgZGF0YSBwYXlsb2FkIHNlbnQgd2l0aCB0aGUgc2lnbmFsIChpZiB0aGVyZSBpcyBvbmUpLjwvbGk+CiAgICogICA8bGk+PGNvZGU+ZnJvbTwvY29kZT4gJm1kYXNoOyAoPGEgaHJlZj0iQ29ubmVjdGlvbi5odG1sIj5Db25uZWN0aW9uPC9hPikgVGhlIENvbm5lY3Rpb24gY29ycmVzcG9uZGluZyB0byB0aGUKICAgKiAgIGNsaWVudCB0aGF0IHNlbnQgd2l0aCB0aGUgc2lnbmFsLjwvbGk+CiAgICogICA8bGk+PGNvZGU+dHlwZTwvY29kZT4gJm1kYXNoOyAoU3RyaW5nKSBUaGUgdHlwZSBhc3NpZ25lZCB0byB0aGUgc2lnbmFsIChpZiB0aGVyZSBpcyBvbmUpLjwvbGk+CiAgICogPC91bD4KICAgKiA8cD4KICAgKiBZb3UgY2FuIHJlZ2lzdGVyIHRvIHJlY2VpdmUgYWxsIHNpZ25hbHMgc2VudCBpbiB0aGUgc2Vzc2lvbiwgYnkgYWRkaW5nIGFuIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSA8Y29kZT5zaWduYWw8L2NvZGU+CiAgICogZXZlbnQuIEZvciBleGFtcGxlLCB0aGUgZm9sbG93aW5nIGNvZGUgYWRkcyBhbiBldmVudCBoYW5kbGVyIHRvIHByb2Nlc3MgYWxsIHNpZ25hbHMgc2VudCBpbiB0aGUgc2Vzc2lvbjoKICAgKiA8cHJlPgogICAqIHNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lcigic2lnbmFsIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgKiAgIGNvbnNvbGUubG9nKCJTaWduYWwgc2VudCBmcm9tIGNvbm5lY3Rpb24gIiArIGV2ZW50LmZyb20uaWQpOwogICAqIH0pOwogICAqIDwvcHJlPgogICAqIDxwPllvdSBjYW4gcmVnaXN0ZXIgZm9yIHNpZ25hbHMgb2YgYSBzcGVjZmllZCB0eXBlIGJ5IGFkZGluZyBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+c2lnbmFsOnR5cGU8L2NvZGU+CiAgICogZXZlbnQgKHJlcGxhY2luZyA8Y29kZT50eXBlPC9jb2RlPiB3aXRoIHRoZSBhY3R1YWwgdHlwZSBzdHJpbmcgdG8gZmlsdGVyIG9uKS4KICAgKgogICAqIEBuYW1lIHNpZ25hbAogICAqIEBldmVudAogICAqIEBtZW1iZXJvZiBTZXNzaW9uCiAgICogQHNlZSA8YSBocmVmPSJTZXNzaW9uLmh0bWwjc2lnbmFsIj5TZXNzaW9uLnNpZ25hbCgpPC9hPgogICAqIEBzZWUgU2lnbmFsRXZlbnQKICAgKiBAc2VlIDxhIGhyZWY9IiNldmVudDpzaWduYWw6dHlwZSI+c2lnbmFsOnR5cGU8L2E+IGV2ZW50CiAgICovCgogIC8qKgogICAqIEEgc2lnbmFsIG9mIHRoZSBzcGVjaWZpZWQgdHlwZSB3YXMgcmVjZWl2ZWQgZnJvbSB0aGUgc2Vzc2lvbi4gVGhlIDxhIGhyZWY9IlNpZ25hbEV2ZW50Lmh0bWwiPlNpZ25hbEV2ZW50PC9hPiBjbGFzcwogICAqIGRlZmluZXMgdGhpcyBldmVudCBvYmplY3QuCiAgICogSXQgaW5jbHVkZXMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAqIDx1bD4KICAgKiAgIDxsaT48Y29kZT5kYXRhPC9jb2RlPiAmbWRhc2g7IChPYmplY3QpIFRoZSBkYXRhIHBheWxvYWQgc2VudCB3aXRoIHRoZSBzaWduYWwuPC9saT4KICAgKiAgIDxsaT48Y29kZT5mcm9tPC9jb2RlPiAmbWRhc2g7ICg8YSBocmVmPSJDb25uZWN0aW9uLmh0bWwiPkNvbm5lY3Rpb248L2E+KSBUaGUgQ29ubmVjdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZQogICAqICAgY2xpZW50IHRoYXQgc2VudCB3aXRoIHRoZSBzaWduYWwuPC9saT4KICAgKiAgIDxsaT48Y29kZT50eXBlPC9jb2RlPiAmbWRhc2g7IChTdHJpbmcpIFRoZSB0eXBlIGFzc2lnbmVkIHRvIHRoZSBzaWduYWwgKGlmIHRoZXJlIGlzIG9uZSkuPC9saT4KICAgKiA8L3VsPgogICAqIDxwPgogICAqIFlvdSBjYW4gcmVnaXN0ZXIgZm9yIHNpZ25hbHMgb2YgYSBzcGVjZmllZCB0eXBlIGJ5IGFkZGluZyBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgPGNvZGU+c2lnbmFsOnR5cGU8L2NvZGU+CiAgICogZXZlbnQgKHJlcGxhY2luZyA8Y29kZT50eXBlPC9jb2RlPiB3aXRoIHRoZSBhY3R1YWwgdHlwZSBzdHJpbmcgdG8gZmlsdGVyIG9uKS4gRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgY29kZSBhZGRzCiAgICogYW4gZXZlbnQgaGFuZGxlciBmb3Igc2lnbmFscyBvZiB0eXBlICJmb28iOgogICAqIDxwcmU+CiAgICogc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCJzaWduYWw6Zm9vIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgKiAgIGNvbnNvbGUubG9nKCJmb28gc2lnbmFsIHNlbnQgZnJvbSBjb25uZWN0aW9uICIgKyBldmVudC5mcm9tLmlkKTsKICAgKiB9KTsKICAgKiA8L3ByZT4KICAgKiA8cD4KICAgKiBZb3UgY2FuIHJlZ2lzdGVyIHRvIHJlY2VpdmUgPGk+YWxsPC9pPiBzaWduYWxzIHNlbnQgaW4gdGhlIHNlc3Npb24sIGJ5IGFkZGluZyBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUKICAgKiA8Y29kZT5zaWduYWw8L2NvZGU+IGV2ZW50LgogICAqCiAgICogQG5hbWUgc2lnbmFsOnR5cGUKICAgKiBAZXZlbnQKICAgKiBAbWVtYmVyb2YgU2Vzc2lvbgogICAqIEBzZWUgPGEgaHJlZj0iU2Vzc2lvbi5odG1sI3NpZ25hbCI+U2Vzc2lvbi5zaWduYWwoKTwvYT4KICAgKiBAc2VlIFNpZ25hbEV2ZW50CiAgICogQHNlZSA8YSBocmVmPSIjZXZlbnQ6c2lnbmFsIj5zaWduYWw8L2E+IGV2ZW50CiAgICovCgoKfTsKCn0pKHdpbmRvdyk7CihmdW5jdGlvbih3aW5kb3cpIHsKICB2YXIgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CiAgc3R5bGUudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgc3R5bGUubWVkaWEgPSAnc2NyZWVuJzsKICBzdHlsZS5yZWwgPSAnc3R5bGVzaGVldCc7CiAgc3R5bGUuaHJlZiA9IE9ULnByb3BlcnRpZXMuY3NzVVJMOwogIHZhciBoZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwogIGhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwp9KSh3aW5kb3cpOwooZnVuY3Rpb24od2luZG93KXsKCi8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgQU1EIG1vZHVsZSwgc2luY2UgVG9rQm94IGNvdWxkIGJlIGNvbmNhdGVuYXRlZCB3aXRoIG90aGVyCi8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKLy8gdW5kZXJzdGFuZHMgYW5vbnltb3VzIEFNRCBtb2R1bGVzLiBBIG5hbWVkIEFNRCBpcyBzYWZlc3QgYW5kIG1vc3Qgcm9idXN0Ci8vIHdheSB0byByZWdpc3Rlci4gVXBwZXJjYXNlIFRCIGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQovLyBkZXJpdmVkIGZyb20gZmlsZSBuYW1lcywgYW5kIE9wZW5Ub2sgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGFuIHVwcGVyY2FzZQovLyBmaWxlIG5hbWUuCmlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewogIGRlZmluZSggIlRCIiwgW10sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIFRCOyB9ICk7Cn0KCn0pKHdpbmRvdyk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:24:46 GMT",
                    "Content-Length": "496801",
                    "Date": "Fri, 07 Nov 2014 21:24:46 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}