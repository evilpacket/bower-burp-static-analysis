{
    "url": "http://localhost:9999/x-tag/transitions/demo/x-tag-components.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>the 'baseURI' property of a DOM element</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>base.setAttribute('href', document.baseURI);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/x-tag/transitions/demo/x-tag-components.js",
                "path": "/x-tag/transitions/demo/x-tag-components.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94LXRhZy90cmFuc2l0aW9ucy9kZW1vL3gtdGFnLWNvbXBvbmVudHMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogODIyODkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDM6NDc6MTkgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAzOjQ3OjE5IEdNVA0KDQovLyBXZSBkb24ndCB1c2UgdGhlIHBsYXRmb3JtIGJvb3RzdHJhcHBlciwgc28gZmFrZSB0aGlzIHN0dWZmLgoKd2luZG93LlBsYXRmb3JtID0ge307CnZhciBsb2dGbGFncyA9IHt9OwovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIFNpZGVUYWJsZSBpcyBhIHdlYWsgbWFwIHdoZXJlIHBvc3NpYmxlLiBJZiBXZWFrTWFwIGlzIG5vdCBhdmFpbGFibGUgdGhlCi8vIGFzc29jaWF0aW9uIGlzIHN0b3JlZCBhcyBhbiBleHBhbmRvIHByb3BlcnR5Lgp2YXIgU2lkZVRhYmxlOwovLyBUT0RPKGFydik6IFdlYWtNYXAgZG9lcyBub3QgYWxsb3cgZm9yIE5vZGUgZXRjIHRvIGJlIGtleXMgaW4gRmlyZWZveAppZiAodHlwZW9mIFdlYWtNYXAgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignRmlyZWZveC8nKSA8IDApIHsKICBTaWRlVGFibGUgPSBXZWFrTWFwOwp9IGVsc2UgewogIChmdW5jdGlvbigpIHsKICAgIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBjb3VudGVyID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgJSAxZTk7CgogICAgU2lkZVRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubmFtZSA9ICdfX3N0JyArIChNYXRoLnJhbmRvbSgpICogMWU5ID4+PiAwKSArIChjb3VudGVyKysgKyAnX18nKTsKICAgIH07CgogICAgU2lkZVRhYmxlLnByb3RvdHlwZSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgZGVmaW5lUHJvcGVydHkoa2V5LCB0aGlzLm5hbWUsIHt2YWx1ZTogdmFsdWUsIHdyaXRhYmxlOiB0cnVlfSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoa2V5LCB0aGlzLm5hbWUpID8ga2V5W3RoaXMubmFtZV0gOiB1bmRlZmluZWQ7CiAgICAgIH0sCiAgICAgIGRlbGV0ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CiAgfSkoKTsKfQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCkgewogIAogIC8vIHBvb3IgbWFuJ3MgYWRhcHRlciBmb3IgdGVtcGxhdGUuY29udGVudCBvbiB2YXJpb3VzIHBsYXRmb3JtIHNjZW5hcmlvcwogIHdpbmRvdy50ZW1wbGF0ZUNvbnRlbnQgPSB3aW5kb3cudGVtcGxhdGVDb250ZW50IHx8IGZ1bmN0aW9uKGluVGVtcGxhdGUpIHsKICAgIHJldHVybiBpblRlbXBsYXRlLmNvbnRlbnQ7CiAgfTsKCiAgLy8gc28gd2UgY2FuIGNhbGwgd3JhcC91bndyYXAgd2l0aG91dCB0ZXN0aW5nIGZvciBTaGFkb3dET01Qb2x5ZmlsbAoKICB3aW5kb3cud3JhcCA9IHdpbmRvdy51bndyYXAgPSBmdW5jdGlvbihuKXsKICAgIHJldHVybiBuOwogIH0KCiAgd2luZG93LmNyZWF0ZVNoYWRvd1Jvb3QgPSBmdW5jdGlvbihpbkVsZW1lbnQpIHsKICAgIHJldHVybiBpbkVsZW1lbnQud2Via2l0Q3JlYXRlU2hhZG93Um9vdCgpOwogIH07CgogIHdpbmRvdy50ZW1wbGF0ZUNvbnRlbnQgPSBmdW5jdGlvbihpblRlbXBsYXRlKSB7CiAgICAvLyBpZiBNRFYgZXhpc3RzLCBpdCBtYXkgbmVlZCB0byBib29zdHJhcCB0aGlzIHRlbXBsYXRlIHRvIHJldmVhbCBjb250ZW50CiAgICBpZiAod2luZG93LkhUTUxUZW1wbGF0ZUVsZW1lbnQgJiYgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXApIHsKICAgICAgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXAoaW5UZW1wbGF0ZSk7CiAgICB9CiAgICAvLyBmYWxsYmFjayB3aGVuIHRoZXJlIGlzIG5vIFNoYWRvdyBET00gcG9seWZpbGwsIG5vIE1EViBwb2x5ZmlsbCwgYW5kIG5vCiAgICAvLyBuYXRpdmUgdGVtcGxhdGUgc3VwcG9ydAogICAgaWYgKCFpblRlbXBsYXRlLmNvbnRlbnQgJiYgIWluVGVtcGxhdGUuX2NvbnRlbnQpIHsKICAgICAgdmFyIGZyYWcgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIHdoaWxlIChpblRlbXBsYXRlLmZpcnN0Q2hpbGQpIHsKICAgICAgICBmcmFnLmFwcGVuZENoaWxkKGluVGVtcGxhdGUuZmlyc3RDaGlsZCk7CiAgICAgIH0KICAgICAgaW5UZW1wbGF0ZS5fY29udGVudCA9IGZyYWc7CiAgICB9CiAgICByZXR1cm4gaW5UZW1wbGF0ZS5jb250ZW50IHx8IGluVGVtcGxhdGUuX2NvbnRlbnQ7CiAgfTsKCn0pKCk7Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCi8vIE9sZCB2ZXJzaW9ucyBvZiBpT1MgZG8gbm90IGhhdmUgYmluZC4KCmlmICghRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQpIHsKICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uKHNjb3BlKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzMiA9IGFyZ3Muc2xpY2UoKTsKICAgICAgYXJnczIucHVzaC5hcHBseShhcmdzMiwgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHNlbGYuYXBwbHkoc2NvcGUsIGFyZ3MyKTsKICAgIH07CiAgfTsKfQoKLy8gbmFtZXNwYWNlIGFuIGltcG9ydCBmcm9tIEN1c3RvbUVsZW1lbnRzCi8vIFRPRE8oc2ptaWxlcyk6IGNsZWFuIHVwIHRoaXMgZ2xvYmFsCnNjb3BlLm1peGluID0gd2luZG93Lm1peGluOwoKfSkod2luZG93LlBsYXRmb3JtKTsKLy8gQ29weXJpZ2h0IDIwMTEgR29vZ2xlIEluYy4KLy8KLy8gTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7Ci8vIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KLy8gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0Ci8vCi8vICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKLy8KLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQovLyBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAovLyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KLy8gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAovLyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KCihmdW5jdGlvbihzY29wZSkgewoKICAndXNlIHN0cmljdCc7CgogIC8vIHBvbHlmaWxsIERPTVRva2VuTGlzdAogIC8vICogYWRkL3JlbW92ZTogYWxsb3cgdGhlc2UgbWV0aG9kcyB0byB0YWtlIG11bHRpcGxlIGNsYXNzTmFtZXMKICAvLyAqIHRvZ2dsZTogYWRkIGEgMm5kIGFyZ3VtZW50IHdoaWNoIGZvcmNlcyB0aGUgZ2l2ZW4gc3RhdGUgcmF0aGVyCiAgLy8gIHRoYW4gdG9nZ2xpbmcuCgogIHZhciBhZGQgPSBET01Ub2tlbkxpc3QucHJvdG90eXBlLmFkZDsKICB2YXIgcmVtb3ZlID0gRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5yZW1vdmU7CiAgRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFkZC5jYWxsKHRoaXMsIGFyZ3VtZW50c1tpXSk7CiAgICB9CiAgfTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uKCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVtb3ZlLmNhbGwodGhpcywgYXJndW1lbnRzW2ldKTsKICAgIH0KICB9OwogIERPTVRva2VuTGlzdC5wcm90b3R5cGUudG9nZ2xlID0gZnVuY3Rpb24obmFtZSwgYm9vbCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICBib29sID0gIXRoaXMuY29udGFpbnMobmFtZSk7CiAgICB9CiAgICBib29sID8gdGhpcy5hZGQobmFtZSkgOiB0aGlzLnJlbW92ZShuYW1lKTsKICB9OwogIERPTVRva2VuTGlzdC5wcm90b3R5cGUuc3dpdGNoID0gZnVuY3Rpb24ob2xkTmFtZSwgbmV3TmFtZSkgewogICAgb2xkTmFtZSAmJiB0aGlzLnJlbW92ZShvbGROYW1lKTsKICAgIG5ld05hbWUgJiYgdGhpcy5hZGQobmV3TmFtZSk7CiAgfTsKICAKICAvLyBtYWtlIGZvckVhY2ggd29yayBvbiBOb2RlTGlzdAoKICBOb2RlTGlzdC5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uKGNiLCBjb250ZXh0KSB7CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzKS5mb3JFYWNoKGNiLCBjb250ZXh0KTsKICB9OwoKICBIVE1MQ29sbGVjdGlvbi5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uKGNiLCBjb250ZXh0KSB7CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzKS5mb3JFYWNoKGNiLCBjb250ZXh0KTsKICB9OwoKICAvLyBwb2x5ZmlsbCBwZXJmb3JtYW5jZS5ub3cKCiAgaWYgKCF3aW5kb3cucGVyZm9ybWFuY2UpIHsKICAgIHZhciBzdGFydCA9IERhdGUubm93KCk7CiAgICAvLyBvbmx5IGF0IG1pbGxpc2Vjb25kIHByZWNpc2lvbgogICAgd2luZG93LnBlcmZvcm1hbmNlID0ge25vdzogZnVuY3Rpb24oKXsgcmV0dXJuIERhdGUubm93KCkgLSBzdGFydCB9fTsKICB9CgogIC8vIHBvbHlmaWxsIGZvciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUKCiAgaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7CiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gKGZ1bmN0aW9uKCkgewogICAgICB2YXIgbmF0aXZlUmFmID0gd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgogICAgICByZXR1cm4gbmF0aXZlUmFmID8KICAgICAgICBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIG5hdGl2ZVJhZihmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2socGVyZm9ybWFuY2Uubm93KCkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSA6CiAgICAgICAgZnVuY3Rpb24oIGNhbGxiYWNrICl7CiAgICAgICAgICByZXR1cm4gd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAgLyA2MCk7CiAgICAgICAgfTsKICAgIH0pKCk7CiAgfQoKICBpZiAoIXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSkgewogICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbmRvdy5tb3pDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgIGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoaWQpOwogICAgICAgIH07CiAgICB9KSgpOwogIH0KCiAgLy8gdXRpbGl0eQoKICBmdW5jdGlvbiBjcmVhdGVET00oaW5UYWdPck5vZGUsIGluSFRNTCwgaW5BdHRycykgewogICAgdmFyIGRvbSA9IHR5cGVvZiBpblRhZ09yTm9kZSA9PSAnc3RyaW5nJyA/IAogICAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoaW5UYWdPck5vZGUpIDogaW5UYWdPck5vZGUuY2xvbmVOb2RlKHRydWUpOwogICAgZG9tLmlubmVySFRNTCA9IGluSFRNTDsKICAgIGlmIChpbkF0dHJzKSB7CiAgICAgIGZvciAodmFyIG4gaW4gaW5BdHRycykgewogICAgICAgIGRvbS5zZXRBdHRyaWJ1dGUobiwgaW5BdHRyc1tuXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkb207CiAgfQoKICAvLyBleHBvcnRzCgogIHNjb3BlLmNyZWF0ZURPTSA9IGNyZWF0ZURPTTsKCn0pKHdpbmRvdy5QbGF0Zm9ybSk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLy8gcG9vciBtYW4ncyBhZGFwdGVyIGZvciB0ZW1wbGF0ZS5jb250ZW50IG9uIHZhcmlvdXMgcGxhdGZvcm0gc2NlbmFyaW9zCndpbmRvdy50ZW1wbGF0ZUNvbnRlbnQgPSB3aW5kb3cudGVtcGxhdGVDb250ZW50IHx8IGZ1bmN0aW9uKGluVGVtcGxhdGUpIHsKICByZXR1cm4gaW5UZW1wbGF0ZS5jb250ZW50Owp9OwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgppZiAoIXNjb3BlKSB7CiAgc2NvcGUgPSB3aW5kb3cuSFRNTEltcG9ydHMgPSB7ZmxhZ3M6e319Owp9Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgcmVwcmVzZW50cyBhIHByaW1hcnkgZG9jdW1lbnQgKHRoZSBhcmd1bWVudCB0byAncGFyc2UnKQovLyBhdCB0aGUgcm9vdCBvZiBhIHRyZWUgb2YgZG9jdW1lbnRzCgp2YXIgaW1wb3J0ZXIgPSB7CiAgZG9jdW1lbnRzOiB7fSwKICBjYWNoZToge30sCiAgcHJlbG9hZFNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ3NjcmlwdFtzcmNdJywKICAgICdsaW5rW3JlbD1zdHlsZXNoZWV0XScKICBdLmpvaW4oJywnKSwKICBsb2FkOiBmdW5jdGlvbihpbkRvY3VtZW50LCBpbk5leHQpIHsKICAgIC8vIGNvbnN0cnVjdCBhIGxvYWRlciBpbnN0YW5jZQogICAgbG9hZGVyID0gbmV3IExvYWRlcihpbXBvcnRlci5sb2FkZWQsIGluTmV4dCk7CiAgICAvLyBhbGlhcyB0aGUgbG9hZGVyIGNhY2hlIChmb3IgZGVidWdnaW5nKQogICAgbG9hZGVyLmNhY2hlID0gaW1wb3J0ZXIuY2FjaGU7CiAgICAvLyBhZGQgbm9kZXMgZnJvbSBkb2N1bWVudCBpbnRvIGxvYWRlciBxdWV1ZQogICAgaW1wb3J0ZXIucHJlbG9hZChpbkRvY3VtZW50KTsKICB9LAogIHByZWxvYWQ6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIC8vIGFsbCBwcmVsb2FkYWJsZSBub2RlcyBpbiBpbkRvY3VtZW50CiAgICB2YXIgbm9kZXMgPSBpbkRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoaW1wb3J0ZXIucHJlbG9hZFNlbGVjdG9ycyk7CiAgICAvLyBvbmx5IGxvYWQgaW1wb3J0cyBmcm9tIHRoZSBtYWluIGRvY3VtZW50CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBkbyB0aGlzIGJ5IGFsdGVyaW5nIHRoZSBzZWxlY3RvciBsaXN0IGluc3RlYWQKICAgIGlmIChpbkRvY3VtZW50ID09PSBkb2N1bWVudCkgewogICAgICBub2RlcyA9IEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHJldHVybiBpc0RvY3VtZW50TGluayhuKTsKICAgICAgfSk7CiAgICB9CiAgICAvLyBhZGQgdGhlc2Ugbm9kZXMgdG8gbG9hZGVyJ3MgcXVldWUKICAgIGxvYWRlci5hZGROb2Rlcyhub2Rlcyk7CiAgfSwKICBsb2FkZWQ6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCwgaW5SZXNvdXJjZSkgewogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGluRWx0KSkgewogICAgICB2YXIgZG9jdW1lbnQgPSBpbXBvcnRlci5kb2N1bWVudHNbaW5VcmxdOwogICAgICAvLyBpZiB3ZSd2ZSBuZXZlciBzZWVuIGEgZG9jdW1lbnQgYXQgdGhpcyB1cmwKICAgICAgaWYgKCFkb2N1bWVudCkgewogICAgICAgIC8vIGdlbmVyYXRlIGFuIEhUTUxEb2N1bWVudCBmcm9tIGRhdGEKICAgICAgICBkb2N1bWVudCA9IG1ha2VEb2N1bWVudChpblJlc291cmNlLCBpblVybCk7CiAgICAgICAgLy8gcmVzb2x2ZSByZXNvdXJjZSBwYXRocyByZWxhdGl2ZSB0byBob3N0IGRvY3VtZW50CiAgICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJbkhUTUwoZG9jdW1lbnQpOwogICAgICAgIC8vIGNhY2hlIGRvY3VtZW50CiAgICAgICAgaW1wb3J0ZXIuZG9jdW1lbnRzW2luVXJsXSA9IGRvY3VtZW50OwogICAgICAgIC8vIGFkZCBub2RlcyBmcm9tIHRoaXMgZG9jdW1lbnQgdG8gdGhlIGxvYWRlciBxdWV1ZQogICAgICAgIGltcG9ydGVyLnByZWxvYWQoZG9jdW1lbnQpOwogICAgICB9CiAgICAgIC8vIHN0b3JlIGRvY3VtZW50IHJlc291cmNlCiAgICAgIGluRWx0LmNvbnRlbnQgPSBpbkVsdC5fX3Jlc291cmNlID0gZG9jdW1lbnQ7CiAgICB9IGVsc2UgewogICAgICBpbkVsdC5fX3Jlc291cmNlID0gaW5SZXNvdXJjZTsKICAgICAgLy8gcmVzb2x2ZSBzdHlsZXNoZWV0IHJlc291cmNlIHBhdGhzIHJlbGF0aXZlIHRvIGhvc3QgZG9jdW1lbnQKICAgICAgaWYgKGlzU3R5bGVzaGVldExpbmsoaW5FbHQpKSB7CiAgICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQoaW5FbHQpOwogICAgICB9CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoaW5FbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGluRWx0LCBJTVBPUlRfTElOS19UWVBFKTsKfQoKZnVuY3Rpb24gaXNTdHlsZXNoZWV0TGluayhpbkVsdCkgewogIHJldHVybiBpc0xpbmtSZWwoaW5FbHQsICdzdHlsZXNoZWV0Jyk7Cn0KCmZ1bmN0aW9uIGlzTGlua1JlbChpbkVsdCwgaW5SZWwpIHsKICByZXR1cm4gKGluRWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnICYmIGluRWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IGluUmVsKTsKfQoKZnVuY3Rpb24gaW5NYWluRG9jdW1lbnQoaW5FbHQpIHsKICByZXR1cm4gaW5FbHQub3duZXJEb2N1bWVudCA9PT0gZG9jdW1lbnQgfHwKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgaW5FbHQub3duZXJEb2N1bWVudC5pbXBsID09PSBkb2N1bWVudDsKfQoKZnVuY3Rpb24gbWFrZURvY3VtZW50KGluSFRNTCwgaW5VcmwpIHsKICAvLyBjcmVhdGUgYSBuZXcgSFRNTCBkb2N1bWVudAogIHZhciBkb2MgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoSU1QT1JUX0xJTktfVFlQRSk7CiAgLy8gY2FjaGUgdGhlIG5ldyBkb2N1bWVudCdzIHNvdXJjZSB1cmwKICBkb2MuX1VSTCA9IGluVXJsOwogIC8vIGVzdGFibGlzaCBhIHJlbGF0aXZlIHBhdGggdmlhIDxiYXNlPgogIHZhciBiYXNlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICBiYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsIGRvY3VtZW50LmJhc2VVUkkpOwogIGRvYy5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwogIC8vIGluc3RhbGwgaHRtbAogIGRvYy5ib2R5LmlubmVySFRNTCA9IGluSFRNTDsKICByZXR1cm4gZG9jOwp9Cgp2YXIgbG9hZGVyOwoKdmFyIExvYWRlciA9IGZ1bmN0aW9uKGluT25Mb2FkLCBpbk9uQ29tcGxldGUpIHsKICB0aGlzLm9ubG9hZCA9IGluT25Mb2FkOwogIHRoaXMub25jb21wbGV0ZSA9IGluT25Db21wbGV0ZTsKICB0aGlzLmluZmxpZ2h0ID0gMDsKICB0aGlzLnBlbmRpbmcgPSB7fTsKICB0aGlzLmNhY2hlID0ge307Cn07CgpMb2FkZXIucHJvdG90eXBlID0gewogIGFkZE5vZGVzOiBmdW5jdGlvbihpbk5vZGVzKSB7CiAgICAvLyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHRvIGNvbXBsZXRlCiAgICB0aGlzLmluZmxpZ2h0ICs9IGluTm9kZXMubGVuZ3RoOwogICAgLy8gY29tbWVuY2UgdHJhbnNhY3Rpb25zCiAgICBmb3JFYWNoKGluTm9kZXMsIHRoaXMucmVxdWlyZSwgdGhpcyk7CiAgICAvLyBhbnl0aGluZyB0byBkbz8KICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICByZXF1aXJlOiBmdW5jdGlvbihpbkVsdCkgewogICAgdmFyIHVybCA9IHBhdGgubm9kZVVybChpbkVsdCk7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBhZC1ob2MKICAgIGluRWx0Ll9fbm9kZVVybCA9IHVybDsKICAgIC8vIGRlZHVwbGljYXRpb24KICAgIGlmICghdGhpcy5kZWR1cGUodXJsLCBpbkVsdCkpIHsKICAgICAgLy8gZmV0Y2ggdGhpcyByZXNvdXJjZQogICAgICB0aGlzLmZldGNoKHVybCwgaW5FbHQpOwogICAgfQogIH0sCiAgZGVkdXBlOiBmdW5jdGlvbihpblVybCwgaW5FbHQpIHsKICAgIGlmICh0aGlzLnBlbmRpbmdbaW5VcmxdKSB7CiAgICAgIC8vIGFkZCB0byBsaXN0IG9mIG5vZGVzIHdhaXRpbmcgZm9yIGluVXJsCiAgICAgIHRoaXMucGVuZGluZ1tpblVybF0ucHVzaChpbkVsdCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAodGhpcy5jYWNoZVtpblVybF0pIHsKICAgICAgLy8gY29tcGxldGUgbG9hZCB1c2luZyBjYWNoZSBkYXRhCiAgICAgIHRoaXMub25sb2FkKGluVXJsLCBpbkVsdCwgbG9hZGVyLmNhY2hlW2luVXJsXSk7CiAgICAgIC8vIGZpbmlzaGVkIHRoaXMgdHJhbnNhY3Rpb24KICAgICAgdGhpcy50YWlsKCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBmaXJzdCBub2RlIHdhaXRpbmcgZm9yIGluVXJsCiAgICB0aGlzLnBlbmRpbmdbaW5VcmxdID0gW2luRWx0XTsKICAgIC8vIG5lZWQgZmV0Y2ggKG5vdCBhIGR1cGUpCiAgICByZXR1cm4gZmFsc2U7CiAgfSwKICBmZXRjaDogZnVuY3Rpb24oaW5VcmwsIGluRWx0KSB7CiAgICB4aHIubG9hZChpblVybCwgZnVuY3Rpb24oZXJyLCByZXNvdXJjZSkgewogICAgICB0aGlzLnJlY2VpdmUoaW5VcmwsIGluRWx0LCBlcnIsIHJlc291cmNlKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgfSwKICByZWNlaXZlOiBmdW5jdGlvbihpblVybCwgaW5FbHQsIGluRXJyLCBpblJlc291cmNlKSB7CiAgICBpZiAoIWluRXJyKSB7CiAgICAgIGxvYWRlci5jYWNoZVtpblVybF0gPSBpblJlc291cmNlOwogICAgfQogICAgbG9hZGVyLnBlbmRpbmdbaW5VcmxdLmZvckVhY2goZnVuY3Rpb24oZSkgewogICAgICBpZiAoIWluRXJyKSB7CiAgICAgICAgdGhpcy5vbmxvYWQoaW5VcmwsIGUsIGluUmVzb3VyY2UpOwogICAgICB9CiAgICAgIHRoaXMudGFpbCgpOwogICAgfSwgdGhpcyk7CiAgICBsb2FkZXIucGVuZGluZ1tpblVybF0gPSBudWxsOwogIH0sCiAgdGFpbDogZnVuY3Rpb24oKSB7CiAgICAtLXRoaXMuaW5mbGlnaHQ7CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgY2hlY2tEb25lOiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5pbmZsaWdodCkgewogICAgICB0aGlzLm9uY29tcGxldGUoKTsKICAgIH0KICB9Cn07Cgp2YXIgcGF0aCA9IHsKICBub2RlVXJsOiBmdW5jdGlvbihpbk5vZGUpIHsKICAgIHJldHVybiBwYXRoLnJlc29sdmVVcmwocGF0aC5nZXREb2N1bWVudFVybChkb2N1bWVudCksIHBhdGguaHJlZk9yU3JjKGluTm9kZSkpOwogIH0sCiAgaHJlZk9yU3JjOiBmdW5jdGlvbihpbk5vZGUpIHsKICAgIHJldHVybiBpbk5vZGUuZ2V0QXR0cmlidXRlKCJocmVmIikgfHwgaW5Ob2RlLmdldEF0dHJpYnV0ZSgic3JjIik7CiAgfSwKICBkb2N1bWVudFVybEZyb21Ob2RlOiBmdW5jdGlvbihpbk5vZGUpIHsKICAgIHZhciB1cmwgPSBwYXRoLmdldERvY3VtZW50VXJsKGluTm9kZS5vd25lckRvY3VtZW50KTsKICAgIC8vIHRha2Ugb25seSB0aGUgbGVmdCBzaWRlIGlmIHRoZXJlIGlzIGEgIwogICAgdXJsID0gdXJsLnNwbGl0KCcjJylbMF07CiAgICByZXR1cm4gdXJsOwogIH0sCiAgZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIHJldHVybiBpbkRvY3VtZW50ICYmCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICAgICAgKGluRG9jdW1lbnQuX1VSTCB8fCAoaW5Eb2N1bWVudC5pbXBsICYmIGluRG9jdW1lbnQuaW1wbC5fVVJMKQogICAgICAgICAgICB8fCBpbkRvY3VtZW50LmJhc2VVUkkgfHwgaW5Eb2N1bWVudC5VUkwpCiAgICAgICAgICAgICAgICB8fCAnJzsKICB9LAogIHJlc29sdmVVcmw6IGZ1bmN0aW9uKGluQmFzZVVybCwgaW5VcmwsIGluUmVsYXRpdmVUb0RvY3VtZW50KSB7CiAgICBpZiAodGhpcy5pc0Fic1VybChpblVybCkpIHsKICAgICAgcmV0dXJuIGluVXJsOwogICAgfQogICAgdmFyIHVybCA9IHRoaXMuY29tcHJlc3NVcmwodGhpcy51cmxUb1BhdGgoaW5CYXNlVXJsKSArIGluVXJsKTsKICAgIGlmIChpblJlbGF0aXZlVG9Eb2N1bWVudCkgewogICAgICB1cmwgPSBwYXRoLm1ha2VSZWxQYXRoKHBhdGguZ2V0RG9jdW1lbnRVcmwoZG9jdW1lbnQpLCB1cmwpOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9LAogIGlzQWJzVXJsOiBmdW5jdGlvbihpblVybCkgewogICAgcmV0dXJuIC8oXmRhdGE6KXwoXmh0dHBbc10/Oil8KF5cLykvLnRlc3QoaW5VcmwpOwogIH0sCiAgdXJsVG9QYXRoOiBmdW5jdGlvbihpbkJhc2VVcmwpIHsKICAgIHZhciBwYXJ0cyA9IGluQmFzZVVybC5zcGxpdCgiLyIpOwogICAgcGFydHMucG9wKCk7CiAgICBwYXJ0cy5wdXNoKCcnKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICBjb21wcmVzc1VybDogZnVuY3Rpb24oaW5VcmwpIHsKICAgIHZhciBwYXJ0cyA9IGluVXJsLnNwbGl0KCIvIik7CiAgICBmb3IgKHZhciBpPTAsIHA7IGk8cGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgcCA9IHBhcnRzW2ldOwogICAgICBpZiAocCA9PT0gIi4uIikgewogICAgICAgIHBhcnRzLnNwbGljZShpLTEsIDIpOwogICAgICAgIGkgLT0gMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBhcnRzLmpvaW4oIi8iKTsKICB9LAogIC8vIG1ha2UgYSByZWxhdGl2ZSBwYXRoIGZyb20gc291cmNlIHRvIHRhcmdldAogIG1ha2VSZWxQYXRoOiBmdW5jdGlvbihpblNvdXJjZSwgaW5UYXJnZXQpIHsKICAgIHZhciBzLCB0OwogICAgcyA9IHRoaXMuY29tcHJlc3NVcmwoaW5Tb3VyY2UpLnNwbGl0KCIvIik7CiAgICB0ID0gdGhpcy5jb21wcmVzc1VybChpblRhcmdldCkuc3BsaXQoIi8iKTsKICAgIHdoaWxlIChzLmxlbmd0aCAmJiBzWzBdID09PSB0WzBdKXsKICAgICAgcy5zaGlmdCgpOwogICAgICB0LnNoaWZ0KCk7CiAgICB9CiAgICBmb3IodmFyIGkgPSAwLCBsID0gcy5sZW5ndGgtMTsgaSA8IGw7IGkrKykgewogICAgICB0LnVuc2hpZnQoIi4uIik7CiAgICB9CiAgICB2YXIgciA9IHQuam9pbigiLyIpOwogICAgcmV0dXJuIHI7CiAgfSwKICByZXNvbHZlUGF0aHNJbkhUTUw6IGZ1bmN0aW9uKGluUm9vdCkgewogICAgdmFyIGRvY1VybCA9IHBhdGguZG9jdW1lbnRVcmxGcm9tTm9kZShpblJvb3QuYm9keSk7CiAgICAvLyBUT0RPKHNvcnZlbGwpOiBNRFYgUG9seWZpbGwgSW50cnVzaW9uCiAgICBpZiAod2luZG93LkhUTUxUZW1wbGF0ZUVsZW1lbnQgJiYgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXApIHsKICAgICAgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXAoaW5Sb290KTsKICAgIH0KICAgIHZhciBub2RlID0gaW5Sb290LmJvZHk7CiAgICBwYXRoLl9yZXNvbHZlUGF0aHNJbkhUTUwobm9kZSwgZG9jVXJsKTsKICB9LAogIF9yZXNvbHZlUGF0aHNJbkhUTUw6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIHBhdGgucmVzb2x2ZUF0dHJpYnV0ZXMoaW5Sb290LCBpblVybCk7CiAgICBwYXRoLnJlc29sdmVTdHlsZUVsdHMoaW5Sb290LCBpblVybCk7CiAgICAvLyBoYW5kbGUgdGVtcGxhdGVzLCBpZiBzdXBwb3J0ZWQKICAgIGlmICh3aW5kb3cudGVtcGxhdGVDb250ZW50KSB7CiAgICAgIHZhciB0ZW1wbGF0ZXMgPSBpblJvb3QucXVlcnlTZWxlY3RvckFsbCgndGVtcGxhdGUnKTsKICAgICAgaWYgKHRlbXBsYXRlcykgewogICAgICAgIGZvckVhY2godGVtcGxhdGVzLCBmdW5jdGlvbih0KSB7CiAgICAgICAgICBwYXRoLl9yZXNvbHZlUGF0aHNJbkhUTUwodGVtcGxhdGVDb250ZW50KHQpLCBpblVybCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9LAogIHJlc29sdmVQYXRoc0luU3R5bGVzaGVldDogZnVuY3Rpb24oaW5TaGVldCkgewogICAgdmFyIGRvY1VybCA9IHBhdGgubm9kZVVybChpblNoZWV0KTsKICAgIGluU2hlZXQuX19yZXNvdXJjZSA9IHBhdGgucmVzb2x2ZUNzc1RleHQoaW5TaGVldC5fX3Jlc291cmNlLCBkb2NVcmwpOwogIH0sCiAgcmVzb2x2ZVN0eWxlRWx0czogZnVuY3Rpb24oaW5Sb290LCBpblVybCkgewogICAgdmFyIHN0eWxlcyA9IGluUm9vdC5xdWVyeVNlbGVjdG9yQWxsKCdzdHlsZScpOwogICAgaWYgKHN0eWxlcykgewogICAgICBmb3JFYWNoKHN0eWxlcywgZnVuY3Rpb24oc3R5bGUpIHsKICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IHBhdGgucmVzb2x2ZUNzc1RleHQoc3R5bGUudGV4dENvbnRlbnQsIGluVXJsKTsKICAgICAgfSk7CiAgICB9CiAgfSwKICByZXNvbHZlQ3NzVGV4dDogZnVuY3Rpb24oaW5Dc3NUZXh0LCBpbkJhc2VVcmwpIHsKICAgIHJldHVybiBpbkNzc1RleHQucmVwbGFjZSgvdXJsXChbXildKlwpL2csIGZ1bmN0aW9uKGluTWF0Y2gpIHsKICAgICAgLy8gZmluZCB0aGUgdXJsIHBhdGgsIGlnbm9yZSBxdW90ZXMgaW4gdXJsIHN0cmluZwogICAgICB2YXIgdXJsUGF0aCA9IGluTWF0Y2gucmVwbGFjZSgvWyInXS9nLCAiIikuc2xpY2UoNCwgLTEpOwogICAgICB1cmxQYXRoID0gcGF0aC5yZXNvbHZlVXJsKGluQmFzZVVybCwgdXJsUGF0aCwgdHJ1ZSk7CiAgICAgIHJldHVybiAidXJsKCIgKyB1cmxQYXRoICsgIikiOwogICAgfSk7CiAgfSwKICByZXNvbHZlQXR0cmlidXRlczogZnVuY3Rpb24oaW5Sb290LCBpblVybCkgewogICAgLy8gc2VhcmNoIGZvciBhdHRyaWJ1dGVzIHRoYXQgaG9zdCB1cmxzCiAgICB2YXIgbm9kZXMgPSBpblJvb3QgJiYgaW5Sb290LnF1ZXJ5U2VsZWN0b3JBbGwoVVJMX0FUVFJTX1NFTEVDVE9SKTsKICAgIGlmIChub2RlcykgewogICAgICBmb3JFYWNoKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgdGhpcy5yZXNvbHZlTm9kZUF0dHJpYnV0ZXMobiwgaW5VcmwpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9LAogIHJlc29sdmVOb2RlQXR0cmlidXRlczogZnVuY3Rpb24oaW5Ob2RlLCBpblVybCkgewogICAgVVJMX0FUVFJTLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICB2YXIgYXR0ciA9IGluTm9kZS5hdHRyaWJ1dGVzW3ZdOwogICAgICBpZiAoYXR0ciAmJiBhdHRyLnZhbHVlICYmCiAgICAgICAgIChhdHRyLnZhbHVlLnNlYXJjaChVUkxfVEVNUExBVEVfU0VBUkNIKSA8IDApKSB7CiAgICAgICAgdmFyIHVybFBhdGggPSBwYXRoLnJlc29sdmVVcmwoaW5VcmwsIGF0dHIudmFsdWUsIHRydWUpOwogICAgICAgIGF0dHIudmFsdWUgPSB1cmxQYXRoOwogICAgICB9CiAgICB9KTsKICB9Cn07Cgp2YXIgVVJMX0FUVFJTID0gWydocmVmJywgJ3NyYycsICdhY3Rpb24nXTsKdmFyIFVSTF9BVFRSU19TRUxFQ1RPUiA9ICdbJyArIFVSTF9BVFRSUy5qb2luKCddLFsnKSArICddJzsKdmFyIFVSTF9URU1QTEFURV9TRUFSQ0ggPSAne3suKn19JzsKCnZhciB4aHIgPSB7CiAgYXN5bmM6IHRydWUsCiAgb2s6IGZ1bmN0aW9uKGluUmVxdWVzdCkgewogICAgcmV0dXJuIChpblJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiBpblJlcXVlc3Quc3RhdHVzIDwgMzAwKQogICAgICAgIHx8IChpblJlcXVlc3Quc3RhdHVzID09PSAzMDQpOwogIH0sCiAgbG9hZDogZnVuY3Rpb24odXJsLCBuZXh0LCBuZXh0Q29udGV4dCkgewogICAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIGlmIChzY29wZS5mbGFncy5kZWJ1ZyB8fCBzY29wZS5mbGFncy5idXN0KSB7CiAgICAgIHVybCArPSAnPycgKyBNYXRoLnJhbmRvbSgpOwogICAgfQogICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB1cmwsIHhoci5hc3luYyk7CiAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICBuZXh0LmNhbGwobmV4dENvbnRleHQsICF4aHIub2socmVxdWVzdCkgJiYgcmVxdWVzdCwKICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2UsIHVybCk7CiAgICAgIH0KICAgIH0pOwogICAgcmVxdWVzdC5zZW5kKCk7CiAgfQp9OwoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKc2NvcGUuaW1wb3J0ZXIgPSBpbXBvcnRlcjsKc2NvcGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwoKLy8gYm9vdHN0cmFwCgovLyBJRSBzaGltIGZvciBDdXN0b21FdmVudAppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZnVuY3Rpb24oKSB7CiAgLy8gcHJlbG9hZCBkb2N1bWVudCByZXNvdXJjZSB0cmVlcwogIGltcG9ydGVyLmxvYWQoZG9jdW1lbnQsIGZ1bmN0aW9uKCkgewogICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NIHBvbHlmaWxsIHBvbGx1dGlvbgogICAgdmFyIGRvYyA9IHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCA/IFNoYWRvd0RPTVBvbHlmaWxsLndyYXAoZG9jdW1lbnQpCiAgICAgICAgOiBkb2N1bWVudDsKICAgIEhUTUxJbXBvcnRzLnJlYWR5VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgLy8gc2VuZCBIVE1MSW1wb3J0c0xvYWRlZCB3aGVuIGZpbmlzaGVkCiAgICBkb2MuYm9keS5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ0hUTUxJbXBvcnRzTG9hZGVkJywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9KTsKfSk7Cgp9KSh3aW5kb3cuSFRNTEltcG9ydHMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTIgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJlbmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oZ2xvYmFsKSB7CgogIHZhciByZWdpc3RyYXRpb25zVGFibGUgPSBuZXcgU2lkZVRhYmxlKCk7CgogIC8vIFdlIHVzZSBzZXRJbW1lZGlhdGUgb3IgcG9zdE1lc3NhZ2UgZm9yIG91ciBmdXR1cmUgY2FsbGJhY2suCiAgdmFyIHNldEltbWVkaWF0ZSA9IHdpbmRvdy5tc1NldEltbWVkaWF0ZTsKCiAgLy8gVXNlIHBvc3QgbWVzc2FnZSB0byBlbXVsYXRlIHNldEltbWVkaWF0ZS4KICBpZiAoIXNldEltbWVkaWF0ZSkgewogICAgdmFyIHNldEltbWVkaWF0ZVF1ZXVlID0gW107CiAgICB2YXIgc2VudGluZWwgPSBTdHJpbmcoTWF0aC5yYW5kb20oKSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKGUuZGF0YSA9PT0gc2VudGluZWwpIHsKICAgICAgICB2YXIgcXVldWUgPSBzZXRJbW1lZGlhdGVRdWV1ZTsKICAgICAgICBzZXRJbW1lZGlhdGVRdWV1ZSA9IFtdOwogICAgICAgIHF1ZXVlLmZvckVhY2goZnVuY3Rpb24oZnVuYykgewogICAgICAgICAgZnVuYygpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIHNldEltbWVkaWF0ZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgc2V0SW1tZWRpYXRlUXVldWUucHVzaChmdW5jKTsKICAgICAgd2luZG93LnBvc3RNZXNzYWdlKHNlbnRpbmVsLCAnKicpOwogICAgfTsKICB9CgogIC8vIFRoaXMgaXMgdXNlZCB0byBlbnN1cmUgdGhhdCB3ZSBuZXZlciBzY2hlZHVsZSAyIGNhbGxhcyB0byBzZXRJbW1lZGlhdGUKICB2YXIgaXNTY2hlZHVsZWQgPSBmYWxzZTsKCiAgLy8gS2VlcCB0cmFjayBvZiBvYnNlcnZlcnMgdGhhdCBuZWVkcyB0byBiZSBub3RpZmllZCBuZXh0IHRpbWUuCiAgdmFyIHNjaGVkdWxlZE9ic2VydmVycyA9IFtdOwoKICAvKioKICAgKiBTY2hlZHVsZXMgfGRpc3BhdGNoQ2FsbGJhY2t8IHRvIGJlIGNhbGxlZCBpbiB0aGUgZnV0dXJlLgogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlcn0gb2JzZXJ2ZXIKICAgKi8KICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrKG9ic2VydmVyKSB7CiAgICBzY2hlZHVsZWRPYnNlcnZlcnMucHVzaChvYnNlcnZlcik7CiAgICBpZiAoIWlzU2NoZWR1bGVkKSB7CiAgICAgIGlzU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgc2V0SW1tZWRpYXRlKGRpc3BhdGNoQ2FsbGJhY2tzKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHdyYXBJZk5lZWRlZChub2RlKSB7CiAgICByZXR1cm4gd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsICYmCiAgICAgICAgd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsLndyYXBJZk5lZWRlZChub2RlKSB8fAogICAgICAgIG5vZGU7CiAgfQoKICBmdW5jdGlvbiBkaXNwYXRjaENhbGxiYWNrcygpIHsKICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNtdXRhdGlvbi1vYnNlcnZlcnMKCiAgICBpc1NjaGVkdWxlZCA9IGZhbHNlOyAvLyBVc2VkIHRvIGFsbG93IGEgbmV3IHNldEltbWVkaWF0ZSBjYWxsIGFib3ZlLgoKICAgIHZhciBvYnNlcnZlcnMgPSBzY2hlZHVsZWRPYnNlcnZlcnM7CiAgICBzY2hlZHVsZWRPYnNlcnZlcnMgPSBbXTsKICAgIC8vIFNvcnQgb2JzZXJ2ZXJzIGJhc2VkIG9uIHRoZWlyIGNyZWF0aW9uIFVJRCAoaW5jcmVtZW50YWwpLgogICAgb2JzZXJ2ZXJzLnNvcnQoZnVuY3Rpb24obzEsIG8yKSB7CiAgICAgIHJldHVybiBvMS51aWRfIC0gbzIudWlkXzsKICAgIH0pOwoKICAgIHZhciBhbnlOb25FbXB0eSA9IGZhbHNlOwogICAgb2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24ob2JzZXJ2ZXIpIHsKCiAgICAgIC8vIDIuMSwgMi4yCiAgICAgIHZhciBxdWV1ZSA9IG9ic2VydmVyLnRha2VSZWNvcmRzKCk7CiAgICAgIC8vIDIuMy4gUmVtb3ZlIGFsbCB0cmFuc2llbnQgcmVnaXN0ZXJlZCBvYnNlcnZlcnMgd2hvc2Ugb2JzZXJ2ZXIgaXMgbW8uCiAgICAgIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyc0ZvcihvYnNlcnZlcik7CgogICAgICAvLyAyLjQKICAgICAgaWYgKHF1ZXVlLmxlbmd0aCkgewogICAgICAgIG9ic2VydmVyLmNhbGxiYWNrXyhxdWV1ZSwgb2JzZXJ2ZXIpOwogICAgICAgIGFueU5vbkVtcHR5ID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CgogICAgLy8gMy4KICAgIGlmIChhbnlOb25FbXB0eSkKICAgICAgZGlzcGF0Y2hDYWxsYmFja3MoKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyc0ZvcihvYnNlcnZlcikgewogICAgb2JzZXJ2ZXIubm9kZXNfLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZXR1cm47CiAgICAgIHJlZ2lzdHJhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihyZWdpc3RyYXRpb24pIHsKICAgICAgICBpZiAocmVnaXN0cmF0aW9uLm9ic2VydmVyID09PSBvYnNlcnZlcikKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVUcmFuc2llbnRPYnNlcnZlcnMoKTsKICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgdGhlICJGb3IgZWFjaCByZWdpc3RlcmVkIG9ic2VydmVyIG9ic2VydmVyICh3aXRoCiAgICogb2JzZXJ2ZXIncyBvcHRpb25zIGFzIG9wdGlvbnMpIGluIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMsCiAgICogcnVuIHRoZXNlIHN1YnN0ZXBzOiIgYW5kIHRoZSAiRm9yIGVhY2ggYW5jZXN0b3IgYW5jZXN0b3Igb2YgdGFyZ2V0LCBhbmQgZm9yCiAgICogZWFjaCByZWdpc3RlcmVkIG9ic2VydmVyIG9ic2VydmVyICh3aXRoIG9wdGlvbnMgb3B0aW9ucykgaW4gYW5jZXN0b3IncyBsaXN0CiAgICogb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMsIHJ1biB0aGVzZSBzdWJzdGVwczoiIHBhcnQgb2YgdGhlIGFsZ29yaXRobXMuIFRoZQogICAqIHxvcHRpb25zLnN1YnRyZWV8IGlzIGNoZWNrZWQgdG8gZW5zdXJlIHRoYXQgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZAogICAqIGNvcnJlY3RseS4KICAgKgogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQHBhcmFtIHtmdW5jdGlvbihNdXRhdGlvbk9ic2VydmVySW5pdCk6TXV0YXRpb25SZWNvcmR9IGNhbGxiYWNrCiAgICovCiAgZnVuY3Rpb24gZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgY2FsbGJhY2spIHsKICAgIGZvciAodmFyIG5vZGUgPSB0YXJnZXQ7IG5vZGU7IG5vZGUgPSBub2RlLnBhcmVudE5vZGUpIHsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwoKICAgICAgaWYgKHJlZ2lzdHJhdGlvbnMpIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2pdOwogICAgICAgICAgdmFyIG9wdGlvbnMgPSByZWdpc3RyYXRpb24ub3B0aW9uczsKCiAgICAgICAgICAvLyBPbmx5IHRhcmdldCBpZ25vcmVzIHN1YnRyZWUuCiAgICAgICAgICBpZiAobm9kZSAhPT0gdGFyZ2V0ICYmICFvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIHZhciByZWNvcmQgPSBjYWxsYmFjayhvcHRpb25zKTsKICAgICAgICAgIGlmIChyZWNvcmQpCiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbi5lbnF1ZXVlKHJlY29yZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICB2YXIgdWlkQ291bnRlciA9IDA7CgogIC8qKgogICAqIFRoZSBjbGFzcyB0aGF0IG1hcHMgdG8gdGhlIERPTSBNdXRhdGlvbk9ic2VydmVyIGludGVyZmFjZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjay4KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBKc011dGF0aW9uT2JzZXJ2ZXIoY2FsbGJhY2spIHsKICAgIHRoaXMuY2FsbGJhY2tfID0gY2FsbGJhY2s7CiAgICB0aGlzLm5vZGVzXyA9IFtdOwogICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgdGhpcy51aWRfID0gKyt1aWRDb3VudGVyOwogIH0KCiAgSnNNdXRhdGlvbk9ic2VydmVyLnByb3RvdHlwZSA9IHsKICAgIG9ic2VydmU6IGZ1bmN0aW9uKHRhcmdldCwgb3B0aW9ucykgewogICAgICB0YXJnZXQgPSB3cmFwSWZOZWVkZWQodGFyZ2V0KTsKCiAgICAgIC8vIDEuMQogICAgICBpZiAoIW9wdGlvbnMuY2hpbGRMaXN0ICYmICFvcHRpb25zLmF0dHJpYnV0ZXMgJiYgIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSB8fAoKICAgICAgICAgIC8vIDEuMgogICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVPbGRWYWx1ZSAmJiAhb3B0aW9ucy5hdHRyaWJ1dGVzIHx8CgogICAgICAgICAgLy8gMS4zCiAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlciAmJiBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5sZW5ndGggJiYKICAgICAgICAgICAgICAhb3B0aW9ucy5hdHRyaWJ1dGVzIHx8CgogICAgICAgICAgLy8gMS40CiAgICAgICAgICBvcHRpb25zLmNoYXJhY3RlckRhdGFPbGRWYWx1ZSAmJiAhb3B0aW9ucy5jaGFyYWN0ZXJEYXRhKSB7CgogICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcigpOwogICAgICB9CgogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQodGFyZ2V0KTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJlZ2lzdHJhdGlvbnNUYWJsZS5zZXQodGFyZ2V0LCByZWdpc3RyYXRpb25zID0gW10pOwoKICAgICAgLy8gMgogICAgICAvLyBJZiB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzIGFscmVhZHkgaW5jbHVkZXMgYSByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgY29udGV4dCBvYmplY3QsIHJlcGxhY2UgdGhhdCByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVyJ3Mgb3B0aW9ucyB3aXRoIG9wdGlvbnMuCiAgICAgIHZhciByZWdpc3RyYXRpb247CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChyZWdpc3RyYXRpb25zW2ldLm9ic2VydmVyID09PSB0aGlzKSB7CiAgICAgICAgICByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2ldOwogICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZUxpc3RlbmVycygpOwogICAgICAgICAgcmVnaXN0cmF0aW9uLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyAzLgogICAgICAvLyBPdGhlcndpc2UsIGFkZCBhIG5ldyByZWdpc3RlcmVkIG9ic2VydmVyIHRvIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlcnMgd2l0aCB0aGUgY29udGV4dCBvYmplY3QgYXMgdGhlIG9ic2VydmVyIGFuZCBvcHRpb25zIGFzIHRoZQogICAgICAvLyBvcHRpb25zLCBhbmQgYWRkIHRhcmdldCB0byBjb250ZXh0IG9iamVjdCdzIGxpc3Qgb2Ygbm9kZXMgb24gd2hpY2ggaXQKICAgICAgLy8gaXMgcmVnaXN0ZXJlZC4KICAgICAgaWYgKCFyZWdpc3RyYXRpb24pIHsKICAgICAgICByZWdpc3RyYXRpb24gPSBuZXcgUmVnaXN0cmF0aW9uKHRoaXMsIHRhcmdldCwgb3B0aW9ucyk7CiAgICAgICAgcmVnaXN0cmF0aW9ucy5wdXNoKHJlZ2lzdHJhdGlvbik7CiAgICAgICAgdGhpcy5ub2Rlc18ucHVzaCh0YXJnZXQpOwogICAgICB9CgogICAgICByZWdpc3RyYXRpb24uYWRkTGlzdGVuZXJzKCk7CiAgICB9LAoKICAgIGRpc2Nvbm5lY3Q6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5vZGVzXy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tpXTsKICAgICAgICAgIGlmIChyZWdpc3RyYXRpb24ub2JzZXJ2ZXIgPT09IHRoaXMpIHsKICAgICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZUxpc3RlbmVycygpOwogICAgICAgICAgICByZWdpc3RyYXRpb25zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgLy8gRWFjaCBub2RlIGNhbiBvbmx5IGhhdmUgb25lIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoCiAgICAgICAgICAgIC8vIHRoaXMgb2JzZXJ2ZXIuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgdGhpcyk7CiAgICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgIH0sCgogICAgdGFrZVJlY29yZHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY29weU9mUmVjb3JkcyA9IHRoaXMucmVjb3Jkc187CiAgICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgICAgcmV0dXJuIGNvcHlPZlJlY29yZHM7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIE11dGF0aW9uUmVjb3JkKHR5cGUsIHRhcmdldCkgewogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5hZGRlZE5vZGVzID0gW107CiAgICB0aGlzLnJlbW92ZWROb2RlcyA9IFtdOwogICAgdGhpcy5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgdGhpcy5uZXh0U2libGluZyA9IG51bGw7CiAgICB0aGlzLmF0dHJpYnV0ZU5hbWUgPSBudWxsOwogICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBudWxsOwogICAgdGhpcy5vbGRWYWx1ZSA9IG51bGw7CiAgfQoKICBmdW5jdGlvbiBjb3B5TXV0YXRpb25SZWNvcmQob3JpZ2luYWwpIHsKICAgIHZhciByZWNvcmQgPSBuZXcgTXV0YXRpb25SZWNvcmQob3JpZ2luYWwudHlwZSwgb3JpZ2luYWwudGFyZ2V0KTsKICAgIHJlY29yZC5hZGRlZE5vZGVzID0gb3JpZ2luYWwuYWRkZWROb2Rlcy5zbGljZSgpOwogICAgcmVjb3JkLnJlbW92ZWROb2RlcyA9IG9yaWdpbmFsLnJlbW92ZWROb2Rlcy5zbGljZSgpOwogICAgcmVjb3JkLnByZXZpb3VzU2libGluZyA9IG9yaWdpbmFsLnByZXZpb3VzU2libGluZzsKICAgIHJlY29yZC5uZXh0U2libGluZyA9IG9yaWdpbmFsLm5leHRTaWJsaW5nOwogICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWUgPSBvcmlnaW5hbC5hdHRyaWJ1dGVOYW1lOwogICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG9yaWdpbmFsLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgIHJlY29yZC5vbGRWYWx1ZSA9IG9yaWdpbmFsLm9sZFZhbHVlOwogICAgcmV0dXJuIHJlY29yZDsKICB9OwoKICAvLyBXZSBrZWVwIHRyYWNrIG9mIHRoZSB0d28gKHBvc3NpYmx5IG9uZSkgcmVjb3JkcyB1c2VkIGluIGEgc2luZ2xlIG11dGF0aW9uLgogIHZhciBjdXJyZW50UmVjb3JkLCByZWNvcmRXaXRoT2xkVmFsdWU7CgogIC8qKgogICAqIENyZWF0ZXMgYSByZWNvcmQgd2l0aG91dCB8b2xkVmFsdWV8IGFuZCBjYWNoZXMgaXQgYXMgfGN1cnJlbnRSZWNvcmR8IGZvcgogICAqIGxhdGVyIHVzZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkVmFsdWUKICAgKiBAcmV0dXJuIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBnZXRSZWNvcmQodHlwZSwgdGFyZ2V0KSB7CiAgICByZXR1cm4gY3VycmVudFJlY29yZCA9IG5ldyBNdXRhdGlvblJlY29yZCh0eXBlLCB0YXJnZXQpOwogIH0KCiAgLyoqCiAgICogR2V0cyBvciBjcmVhdGVzIGEgcmVjb3JkIHdpdGggfG9sZFZhbHVlfCBiYXNlZCBpbiB0aGUgfGN1cnJlbnRSZWNvcmR8CiAgICogQHBhcmFtIHtzdHJpbmd9IG9sZFZhbHVlCiAgICogQHJldHVybiB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKSB7CiAgICBpZiAocmVjb3JkV2l0aE9sZFZhbHVlKQogICAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwogICAgcmVjb3JkV2l0aE9sZFZhbHVlID0gY29weU11dGF0aW9uUmVjb3JkKGN1cnJlbnRSZWNvcmQpOwogICAgcmVjb3JkV2l0aE9sZFZhbHVlLm9sZFZhbHVlID0gb2xkVmFsdWU7CiAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwogIH0KCiAgZnVuY3Rpb24gY2xlYXJSZWNvcmRzKCkgewogICAgY3VycmVudFJlY29yZCA9IHJlY29yZFdpdGhPbGRWYWx1ZSA9IHVuZGVmaW5lZDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IHJlY29yZAogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJlY29yZCByZXByZXNlbnRzIGEgcmVjb3JkIGZyb20gdGhlIGN1cnJlbnQKICAgKiBtdXRhdGlvbiBldmVudC4KICAgKi8KICBmdW5jdGlvbiByZWNvcmRSZXByZXNlbnRzQ3VycmVudE11dGF0aW9uKHJlY29yZCkgewogICAgcmV0dXJuIHJlY29yZCA9PT0gcmVjb3JkV2l0aE9sZFZhbHVlIHx8IHJlY29yZCA9PT0gY3VycmVudFJlY29yZDsKICB9CgogIC8qKgogICAqIFNlbGVjdHMgd2hpY2ggcmVjb3JkLCBpZiBhbnksIHRvIHJlcGxhY2UgdGhlIGxhc3QgcmVjb3JkIGluIHRoZSBxdWV1ZS4KICAgKiBUaGlzIHJldHVybnMgfG51bGx8IGlmIG5vIHJlY29yZCBzaG91bGQgYmUgcmVwbGFjZWQuCiAgICoKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSBsYXN0UmVjb3JkCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gbmV3UmVjb3JkCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBzZWxlY3RSZWNvcmQobGFzdFJlY29yZCwgbmV3UmVjb3JkKSB7CiAgICBpZiAobGFzdFJlY29yZCA9PT0gbmV3UmVjb3JkKQogICAgICByZXR1cm4gbGFzdFJlY29yZDsKCiAgICAvLyBDaGVjayBpZiB0aGUgdGhlIHJlY29yZCB3ZSBhcmUgYWRkaW5nIHJlcHJlc2VudHMgdGhlIHNhbWUgcmVjb3JkLiBJZgogICAgLy8gc28sIHdlIGtlZXAgdGhlIG9uZSB3aXRoIHRoZSBvbGRWYWx1ZSBpbiBpdC4KICAgIGlmIChyZWNvcmRXaXRoT2xkVmFsdWUgJiYgcmVjb3JkUmVwcmVzZW50c0N1cnJlbnRNdXRhdGlvbihsYXN0UmVjb3JkKSkKICAgICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKCiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8qKgogICAqIENsYXNzIHVzZWQgdG8gcmVwcmVzZW50IGEgcmVnaXN0ZXJlZCBvYnNlcnZlci4KICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJ9IG9ic2VydmVyCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJJbml0fSBvcHRpb25zCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gUmVnaXN0cmF0aW9uKG9ic2VydmVyLCB0YXJnZXQsIG9wdGlvbnMpIHsKICAgIHRoaXMub2JzZXJ2ZXIgPSBvYnNlcnZlcjsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IFtdOwogIH0KCiAgUmVnaXN0cmF0aW9uLnByb3RvdHlwZSA9IHsKICAgIGVucXVldWU6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICB2YXIgcmVjb3JkcyA9IHRoaXMub2JzZXJ2ZXIucmVjb3Jkc187CiAgICAgIHZhciBsZW5ndGggPSByZWNvcmRzLmxlbmd0aDsKCiAgICAgIC8vIFRoZXJlIGFyZSBjYXNlcyB3aGVyZSB3ZSByZXBsYWNlIHRoZSBsYXN0IHJlY29yZCB3aXRoIHRoZSBuZXcgcmVjb3JkLgogICAgICAvLyBGb3IgZXhhbXBsZSBpZiB0aGUgcmVjb3JkIHJlcHJlc2VudHMgdGhlIHNhbWUgbXV0YXRpb24gd2UgbmVlZCB0byB1c2UKICAgICAgLy8gdGhlIG9uZSB3aXRoIHRoZSBvbGRWYWx1ZS4gSWYgd2UgZ2V0IHNhbWUgcmVjb3JkICh0aGlzIGNhbiBoYXBwZW4gYXMgd2UKICAgICAgLy8gd2FsayB1cCB0aGUgdHJlZSkgd2UgaWdub3JlIHRoZSBuZXcgcmVjb3JkLgogICAgICBpZiAocmVjb3Jkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIGxhc3RSZWNvcmQgPSByZWNvcmRzW2xlbmd0aCAtIDFdOwogICAgICAgIHZhciByZWNvcmRUb1JlcGxhY2VMYXN0ID0gc2VsZWN0UmVjb3JkKGxhc3RSZWNvcmQsIHJlY29yZCk7CiAgICAgICAgaWYgKHJlY29yZFRvUmVwbGFjZUxhc3QpIHsKICAgICAgICAgIHJlY29yZHNbbGVuZ3RoIC0gMV0gPSByZWNvcmRUb1JlcGxhY2VMYXN0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzY2hlZHVsZUNhbGxiYWNrKHRoaXMub2JzZXJ2ZXIpOwogICAgICB9CgogICAgICByZWNvcmRzW2xlbmd0aF0gPSByZWNvcmQ7CiAgICB9LAoKICAgIGFkZExpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXJzXyh0aGlzLnRhcmdldCk7CiAgICB9LAoKICAgIGFkZExpc3RlbmVyc186IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01BdHRyTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVJbnNlcnRlZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0IHx8IG9wdGlvbnMuc3VidHJlZSkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVSZW1vdmVkJywgdGhpcywgdHJ1ZSk7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzXyh0aGlzLnRhcmdldCk7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyc186IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01BdHRyTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVJbnNlcnRlZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0IHx8IG9wdGlvbnMuc3VidHJlZSkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVSZW1vdmVkJywgdGhpcywgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQWRkcyBhIHRyYW5zaWVudCBvYnNlcnZlciBvbiBub2RlLiBUaGUgdHJhbnNpZW50IG9ic2VydmVyIGdldHMgcmVtb3ZlZAogICAgICogbmV4dCB0aW1lIHdlIGRlbGl2ZXIgdGhlIGNoYW5nZSByZWNvcmRzLgogICAgICogQHBhcmFtIHtOb2RlfSBub2RlCiAgICAgKi8KICAgIGFkZFRyYW5zaWVudE9ic2VydmVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIC8vIERvbid0IGFkZCB0cmFuc2llbnQgb2JzZXJ2ZXJzIG9uIHRoZSB0YXJnZXQgaXRzZWxmLiBXZSBhbHJlYWR5IGhhdmUgYWxsCiAgICAgIC8vIHRoZSByZXF1aXJlZCBsaXN0ZW5lcnMgc2V0IHVwIG9uIHRoZSB0YXJnZXQuCiAgICAgIGlmIChub2RlID09PSB0aGlzLnRhcmdldCkKICAgICAgICByZXR1cm47CgogICAgICB0aGlzLmFkZExpc3RlbmVyc18obm9kZSk7CiAgICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2Rlcy5wdXNoKG5vZGUpOwogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZWdpc3RyYXRpb25zVGFibGUuc2V0KG5vZGUsIHJlZ2lzdHJhdGlvbnMgPSBbXSk7CgogICAgICAvLyBXZSBrbm93IHRoYXQgcmVnaXN0cmF0aW9ucyBkb2VzIG5vdCBjb250YWluIHRoaXMgYmVjYXVzZSB3ZSBhbHJlYWR5CiAgICAgIC8vIGNoZWNrZWQgaWYgbm9kZSA9PT0gdGhpcy50YXJnZXQuCiAgICAgIHJlZ2lzdHJhdGlvbnMucHVzaCh0aGlzKTsKICAgIH0sCgogICAgcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXM7CiAgICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IFtdOwoKICAgICAgdHJhbnNpZW50T2JzZXJ2ZWROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvLyBUcmFuc2llbnQgb2JzZXJ2ZXJzIGFyZSBuZXZlciBhZGRlZCB0byB0aGUgdGFyZ2V0LgogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzXyhub2RlKTsKCiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbnNbaV0gPT09IHRoaXMpIHsKICAgICAgICAgICAgcmVnaXN0cmF0aW9ucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIC8vIEVhY2ggbm9kZSBjYW4gb25seSBoYXZlIG9uZSByZWdpc3RlcmVkIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICAvLyB0aGlzIG9ic2VydmVyLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfSwKCiAgICBoYW5kbGVFdmVudDogZnVuY3Rpb24oZSkgewogICAgICAvLyBTdG9wIHByb3BhZ2F0aW9uIHNpbmNlIHdlIGFyZSBtYW5hZ2luZyB0aGUgcHJvcGFnYXRpb24gbWFudWFsbHkuCiAgICAgIC8vIFRoaXMgbWVhbnMgdGhhdCBvdGhlciBtdXRhdGlvbiBldmVudHMgb24gdGhlIHBhZ2Ugd2lsbCBub3Qgd29yawogICAgICAvLyBjb3JyZWN0bHkgYnV0IHRoYXQgaXMgYnkgZGVzaWduLgogICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoKICAgICAgc3dpdGNoIChlLnR5cGUpIHsKICAgICAgICBjYXNlICdET01BdHRyTW9kaWZpZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtYXR0cmlidXRlcwoKICAgICAgICAgIHZhciBuYW1lID0gZS5hdHRyTmFtZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBlLnJlbGF0ZWROb2RlLm5hbWVzcGFjZVVSSTsKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IG5ldyBnZXRSZWNvcmQoJ2F0dHJpYnV0ZXMnLCB0YXJnZXQpOwogICAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKCiAgICAgICAgICAvLyAyLgogICAgICAgICAgdmFyIG9sZFZhbHVlID0KICAgICAgICAgICAgICBlLmF0dHJDaGFuZ2UgPT09IE11dGF0aW9uRXZlbnQuQURESVRJT04gPyBudWxsIDogZS5wcmV2VmFsdWU7CgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAzLjEsIDQuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAzLjIsIDQuMwogICAgICAgICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIgJiYgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIubGVuZ3RoICYmCiAgICAgICAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5pbmRleE9mKG5hbWUpID09PSAtMSAmJgogICAgICAgICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIuaW5kZXhPZihuYW1lc3BhY2UpID09PSAtMSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAzLjMsIDQuNAogICAgICAgICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVPbGRWYWx1ZSkKICAgICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKTsKCiAgICAgICAgICAgIC8vIDMuNCwgNC41CiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWNoYXJhY3RlcmRhdGEKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IGdldFJlY29yZCgnY2hhcmFjdGVyRGF0YScsIHRhcmdldCk7CgogICAgICAgICAgLy8gMi4KICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IGUucHJldlZhbHVlOwoKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDMuMSwgNC4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDMuMiwgNC4zCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGFPbGRWYWx1ZSkKICAgICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKTsKCiAgICAgICAgICAgIC8vIDMuMywgNC40CiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRE9NTm9kZVJlbW92ZWQnOgogICAgICAgICAgdGhpcy5hZGRUcmFuc2llbnRPYnNlcnZlcihlLnRhcmdldCk7CiAgICAgICAgICAvLyBGYWxsIHRocm91Z2guCiAgICAgICAgY2FzZSAnRE9NTm9kZUluc2VydGVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWNoaWxkbGlzdAogICAgICAgICAgdmFyIHRhcmdldCA9IGUucmVsYXRlZE5vZGU7CiAgICAgICAgICB2YXIgY2hhbmdlZE5vZGUgPSBlLnRhcmdldDsKICAgICAgICAgIHZhciBhZGRlZE5vZGVzLCByZW1vdmVkTm9kZXM7CiAgICAgICAgICBpZiAoZS50eXBlID09PSAnRE9NTm9kZUluc2VydGVkJykgewogICAgICAgICAgICBhZGRlZE5vZGVzID0gW2NoYW5nZWROb2RlXTsKICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gW107CiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgYWRkZWROb2RlcyA9IFtdOwogICAgICAgICAgICByZW1vdmVkTm9kZXMgPSBbY2hhbmdlZE5vZGVdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZpb3VzU2libGluZyA9IGNoYW5nZWROb2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IGNoYW5nZWROb2RlLm5leHRTaWJsaW5nOwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gZ2V0UmVjb3JkKCdjaGlsZExpc3QnLCB0YXJnZXQpOwogICAgICAgICAgcmVjb3JkLmFkZGVkTm9kZXMgPSBhZGRlZE5vZGVzOwogICAgICAgICAgcmVjb3JkLnJlbW92ZWROb2RlcyA9IHJlbW92ZWROb2RlczsKICAgICAgICAgIHJlY29yZC5wcmV2aW91c1NpYmxpbmcgPSBwcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICByZWNvcmQubmV4dFNpYmxpbmcgPSBuZXh0U2libGluZzsKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDIuMSwgMy4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMi4yLCAzLjMKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgfQoKICAgICAgY2xlYXJSZWNvcmRzKCk7CiAgICB9CiAgfTsKCiAgZ2xvYmFsLkpzTXV0YXRpb25PYnNlcnZlciA9IEpzTXV0YXRpb25PYnNlcnZlcjsKCn0pKHRoaXMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCmlmICghd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIpIHsKICB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciA9IAogICAgICB3aW5kb3cuV2ViS2l0TXV0YXRpb25PYnNlcnZlciB8fCAKICAgICAgd2luZG93LkpzTXV0YXRpb25PYnNlcnZlcjsKICBpZiAoIU11dGF0aW9uT2JzZXJ2ZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigibm8gbXV0YXRpb24gb2JzZXJ2ZXIgc3VwcG9ydCIpOwogIH0KfQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8qKgogKiBJbXBsZW1lbnRzIGBkb2N1bWVudC5yZWdpc3RlcmAKICogQG1vZHVsZSBDdXN0b21FbGVtZW50cwoqLwoKLyoqCiAqIFBvbHlmaWxsZWQgZXh0ZW5zaW9ucyB0byB0aGUgYGRvY3VtZW50YCBvYmplY3QuCiAqIEBjbGFzcyBEb2N1bWVudAoqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgppZiAoIXNjb3BlKSB7CiAgc2NvcGUgPSB3aW5kb3cuQ3VzdG9tRWxlbWVudHMgPSB7ZmxhZ3M6e319Owp9CgovLyBuYXRpdmUgZG9jdW1lbnQucmVnaXN0ZXI/CgpzY29wZS5oYXNOYXRpdmUgPSAoZG9jdW1lbnQud2Via2l0UmVnaXN0ZXIgfHwgZG9jdW1lbnQucmVnaXN0ZXIpICYmIHNjb3BlLmZsYWdzLnJlZ2lzdGVyID09PSAnbmF0aXZlJzsKaWYgKHNjb3BlLmhhc05hdGl2ZSkgewoKICAvLyBub3JtYWxpemUKICBkb2N1bWVudC5yZWdpc3RlciA9IGRvY3VtZW50LnJlZ2lzdGVyIHx8IGRvY3VtZW50LndlYmtpdFJlZ2lzdGVyOwoKICB2YXIgbm9wID0gZnVuY3Rpb24oKSB7fTsKCiAgLy8gZXhwb3J0cwogIHNjb3BlLnJlZ2lzdHJ5ID0ge307CiAgc2NvcGUudXBncmFkZUVsZW1lbnQgPSBub3A7Cgp9IGVsc2UgewoKLyoqCiAqIFJlZ2lzdGVycyBhIGN1c3RvbSB0YWcgbmFtZSB3aXRoIHRoZSBkb2N1bWVudC4KICoKICogV2hlbiBhIHJlZ2lzdGVyZWQgZWxlbWVudCBpcyBjcmVhdGVkLCBhIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgaXMgY2FsbGVkCiAqIGluIHRoZSBzY29wZSBvZiB0aGUgZWxlbWVudC4gVGhlIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgY2FuIGJlIHNwZWNpZmllZCBvbgogKiBlaXRoZXIgYGluT3B0aW9ucy5wcm90b3R5cGVgIG9yIGBpbk9wdGlvbnMubGlmZWN5Y2xlYCB3aXRoIHRoZSBsYXR0ZXIgdGFraW5nCiAqIHByZWNlZGVuY2UuCiAqCiAqIEBtZXRob2QgcmVnaXN0ZXIKICogQHBhcmFtIHtTdHJpbmd9IGluTmFtZSBUaGUgdGFnIG5hbWUgdG8gcmVnaXN0ZXIuIE11c3QgaW5jbHVkZSBhIGRhc2ggKCctJyksCiAqICAgIGZvciBleGFtcGxlICd4LWNvbXBvbmVudCcuCiAqIEBwYXJhbSB7T2JqZWN0fSBpbk9wdGlvbnMKICogICAgQHBhcmFtIHtTdHJpbmd9IFtpbk9wdGlvbnMuZXh0ZW5kc10KICogICAgICAoX29mZiBzcGVjXykgVGFnIG5hbWUgb2YgYW4gZWxlbWVudCB0byBleHRlbmQgKG9yIGJsYW5rIGZvciBhIG5ldwogKiAgICAgIGVsZW1lbnQpLiBUaGlzIHBhcmFtZXRlciBpcyBub3QgcGFydCBvZiB0aGUgc3BlY2lmaWNhdGlvbiwgYnV0IGluc3RlYWQKICogICAgICBpcyBhIGhpbnQgZm9yIHRoZSBwb2x5ZmlsbCBiZWNhdXNlIHRoZSBleHRlbmRlZSBpcyBkaWZmaWN1bHQgdG8gaW5mZXIuCiAqICAgICAgUmVtZW1iZXIgdGhhdCB0aGUgaW5wdXQgcHJvdG90eXBlIG11c3QgY2hhaW4gdG8gdGhlIGV4dGVuZGVkIGVsZW1lbnQncwogKiAgICAgIHByb3RvdHlwZSAob3IgSFRNTEVsZW1lbnQucHJvdG90eXBlKSByZWdhcmRsZXNzIG9mIHRoZSB2YWx1ZSBvZgogKiAgICAgIGBleHRlbmRzYC4KICogICAgQHBhcmFtIHtPYmplY3R9IGluT3B0aW9ucy5wcm90b3R5cGUgVGhlIHByb3RvdHlwZSB0byB1c2UgZm9yIHRoZSBuZXcKICogICAgICBlbGVtZW50LiBUaGUgcHJvdG90eXBlIG11c3QgaW5oZXJpdCBmcm9tIEhUTUxFbGVtZW50LgogKiAgICBAcGFyYW0ge09iamVjdH0gW2luT3B0aW9ucy5saWZlY3ljbGVdCiAqICAgICAgQ2FsbGJhY2tzIHRoYXQgZmlyZSBhdCBpbXBvcnRhbnQgcGhhc2VzIGluIHRoZSBsaWZlIG9mIHRoZSBjdXN0b20KICogICAgICBlbGVtZW50LgogKgogKiBAZXhhbXBsZQogKiAgICAgIEZhbmN5QnV0dG9uID0gZG9jdW1lbnQucmVnaXN0ZXIoImZhbmN5LWJ1dHRvbiIsIHsKICogICAgICAgIGV4dGVuZHM6ICdidXR0b24nLAogKiAgICAgICAgcHJvdG90eXBlOiBPYmplY3QuY3JlYXRlKEhUTUxCdXR0b25FbGVtZW50LnByb3RvdHlwZSwgewogKiAgICAgICAgICByZWFkeUNhbGxiYWNrOiB7CiAqICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgICAgY29uc29sZS5sb2coImEgZmFuY3ktYnV0dG9uIHdhcyBjcmVhdGVkIiwKICogICAgICAgICAgICB9CiAqICAgICAgICAgIH0KICogICAgICAgIH0pCiAqICAgICAgfSk7CiAqIEByZXR1cm4ge0Z1bmN0aW9ufSBDb25zdHJ1Y3RvciBmb3IgdGhlIG5ld2x5IHJlZ2lzdGVyZWQgdHlwZS4KICovCmZ1bmN0aW9uIHJlZ2lzdGVyKGluTmFtZSwgaW5PcHRpb25zKSB7CiAgLy9jb25zb2xlLndhcm4oJ2RvY3VtZW50LnJlZ2lzdGVyKCInICsgaW5OYW1lICsgJyIsICcsIGluT3B0aW9ucywgJyknKTsKICAvLyBjb25zdHJ1Y3QgYSBkZWZpbnRpb24gb3V0IG9mIG9wdGlvbnMKICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgY2xvbmUgaW5PcHRpb25zIGluc3RlYWQgb2YgbXV0YXRpbmcgaXQKICB2YXIgZGVmaW5pdGlvbiA9IGluT3B0aW9ucyB8fCB7fTsKICBpZiAoIWluTmFtZSkgewogICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWsgY2FuIHByb2JhYmx5CiAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgIHRocm93IG5ldyBFcnJvcignTmFtZSBhcmd1bWVudCBtdXN0IG5vdCBiZSBlbXB0eScpOwogIH0KICAvLyByZWNvcmQgbmFtZQogIGRlZmluaXRpb24ubmFtZSA9IGluTmFtZTsKICAvLyBtdXN0IGhhdmUgYSBwcm90b3R5cGUsIGRlZmF1bHQgdG8gYW4gZXh0ZW5zaW9uIG9mIEhUTUxFbGVtZW50CiAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIHRocm93IGlmIG5vIHByb3RvdHlwZSwgY2hlY2sgc3BlYwogIGlmICghZGVmaW5pdGlvbi5wcm90b3R5cGUpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmlrIGNhbiBwcm9iYWJseQogICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ09wdGlvbnMgbWlzc2luZyByZXF1aXJlZCBwcm90b3R5cGUgcHJvcGVydHknKTsKICB9CiAgLy8gZW5zdXJlIGEgbGlmZWN5Y2xlIG9iamVjdCBzbyB3ZSBkb24ndCBoYXZlIHRvIG51bGwgdGVzdCBpdAogIGRlZmluaXRpb24ubGlmZWN5Y2xlID0gZGVmaW5pdGlvbi5saWZlY3ljbGUgfHwge307CiAgLy8gYnVpbGQgYSBsaXN0IG9mIGFuY2VzdHJhbCBjdXN0b20gZWxlbWVudHMgKGZvciBuYXRpdmUgYmFzZSBkZXRlY3Rpb24pCiAgLy8gVE9ETyhzam1pbGVzKTogd2UgdXNlZCB0byBuZWVkIHRvIHN0b3JlIHRoaXMsIGJ1dCBjdXJyZW50IGNvZGUgb25seQogIC8vIHVzZXMgaXQgaW4gJ3Jlc29sdmVUYWdOYW1lJzogaXQgc2hvdWxkIHByb2JhYmx5IGJlIGlubGluZWQKICBkZWZpbml0aW9uLmFuY2VzdHJ5ID0gYW5jZXN0cnkoZGVmaW5pdGlvbi5leHRlbmRzKTsKICAvLyBleHRlbnNpb25zIG9mIG5hdGl2ZSBzcGVjaWFsaXphdGlvbnMgb2YgSFRNTEVsZW1lbnQgcmVxdWlyZSBsb2NhbE5hbWUKICAvLyB0byByZW1haW4gbmF0aXZlLCBhbmQgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllciBmb3IgZXh0ZW5zaW9uIHR5cGUKICByZXNvbHZlVGFnTmFtZShkZWZpbml0aW9uKTsKICAvLyBzb21lIHBsYXRmb3JtcyByZXF1aXJlIG1vZGlmaWNhdGlvbnMgdG8gdGhlIHVzZXItc3VwcGxpZWQgcHJvdG90eXBlCiAgLy8gY2hhaW4KICByZXNvbHZlUHJvdG90eXBlQ2hhaW4oZGVmaW5pdGlvbik7CiAgLy8gb3ZlcnJpZGVzIHRvIGltcGxlbWVudCBjYWxsYmFja3MKICAvLyBUT0RPKHNqbWlsZXMpOiBzaG91bGQgc3VwcG9ydCBhY2Nlc3MgdmlhIC5hdHRyaWJ1dGVzIE5hbWVkTm9kZU1hcAogIGRlZmluaXRpb24ucHJvdG90eXBlLnNldEF0dHJpYnV0ZSA9IHNldEF0dHJpYnV0ZTsKICBkZWZpbml0aW9uLnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSByZW1vdmVBdHRyaWJ1dGU7CiAgLy8gNy4xLjU6IFJlZ2lzdGVyIHRoZSBERUZJTklUSU9OIHdpdGggRE9DVU1FTlQKICByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBkZWZpbml0aW9uKTsKICAvLyA3LjEuNy4gUnVuIGN1c3RvbSBlbGVtZW50IGNvbnN0cnVjdG9yIGdlbmVyYXRpb24gYWxnb3JpdGhtIHdpdGggUFJPVE9UWVBFCiAgLy8gNy4xLjguIFJldHVybiB0aGUgb3V0cHV0IG9mIHRoZSBwcmV2aW91cyBzdGVwLgogIGRlZmluaXRpb24uY3RvciA9IGdlbmVyYXRlQ29uc3RydWN0b3IoZGVmaW5pdGlvbik7CiAgZGVmaW5pdGlvbi5jdG9yLnByb3RvdHlwZSA9IGRlZmluaXRpb24ucHJvdG90eXBlOwogIC8vIGlmIGluaXRpYWwgcGFyc2luZyBpcyBjb21wbGV0ZQogIGlmIChzY29wZS5yZWFkeSkgewogICAgLy8gdXBncmFkZSBhbnkgcHJlLWV4aXN0aW5nIG5vZGVzIG9mIHRoaXMgdHlwZQogICAgc2NvcGUudXBncmFkZUFsbChkb2N1bWVudCk7CiAgfQogIHJldHVybiBkZWZpbml0aW9uLmN0b3I7Cn0KCmZ1bmN0aW9uIGFuY2VzdHJ5KGluRXh0ZW5kcykgewogIHZhciBleHRlbmRlZSA9IHJlZ2lzdHJ5W2luRXh0ZW5kc107CiAgaWYgKGV4dGVuZGVlKSB7CiAgICByZXR1cm4gYW5jZXN0cnkoZXh0ZW5kZWUuZXh0ZW5kcykuY29uY2F0KFtleHRlbmRlZV0pOwogIH0KICByZXR1cm4gW107Cn0KCmZ1bmN0aW9uIHJlc29sdmVUYWdOYW1lKGluRGVmaW5pdGlvbikgewogIC8vIGlmIHdlIGFyZSBleHBsaWNpdGx5IGV4dGVuZGluZyBzb21ldGhpbmcsIHRoYXQgdGhpbmcgaXMgb3VyCiAgLy8gYmFzZVRhZywgdW5sZXNzIGl0IHJlcHJlc2VudHMgYSBjdXN0b20gY29tcG9uZW50CiAgdmFyIGJhc2VUYWcgPSBpbkRlZmluaXRpb24uZXh0ZW5kczsKICAvLyBpZiBvdXIgYW5jZXN0cnkgaW5jbHVkZXMgY3VzdG9tIGNvbXBvbmVudHMsIHdlIG9ubHkgaGF2ZSBhCiAgLy8gYmFzZVRhZyBpZiBvbmUgb2YgdGhlbSBkb2VzCiAgZm9yICh2YXIgaT0wLCBhOyAoYT1pbkRlZmluaXRpb24uYW5jZXN0cnlbaV0pOyBpKyspIHsKICAgIGJhc2VUYWcgPSBhLmlzICYmIGEudGFnOwogIH0KICAvLyBvdXIgdGFnIGlzIG91ciBiYXNlVGFnLCBpZiBpdCBleGlzdHMsIGFuZCBvdGhlcndpc2UganVzdCBvdXIgbmFtZQogIGluRGVmaW5pdGlvbi50YWcgPSBiYXNlVGFnIHx8IGluRGVmaW5pdGlvbi5uYW1lOwogIGlmIChiYXNlVGFnKSB7CiAgICAvLyBpZiB0aGVyZSBpcyBhIGJhc2UgdGFnLCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyCiAgICBpbkRlZmluaXRpb24uaXMgPSBpbkRlZmluaXRpb24ubmFtZTsKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVQcm90b3R5cGVDaGFpbihpbkRlZmluaXRpb24pIHsKICAvLyBpZiB3ZSBkb24ndCBzdXBwb3J0IF9fcHJvdG9fXyB3ZSBuZWVkIHRvIGxvY2F0ZSB0aGUgbmF0aXZlIGxldmVsCiAgLy8gcHJvdG90eXBlIGZvciBwcmVjaXNlIG1peGluZyBpbgogIGlmICghT2JqZWN0Ll9fcHJvdG9fXykgewogICAgaWYgKGluRGVmaW5pdGlvbi5pcykgewogICAgICAvLyBmb3Igbm9uLXRyaXZpYWwgZXh0ZW5zaW9ucywgd29yayBvdXQgYm90aCBwcm90b3R5cGVzCiAgICAgIHZhciBpbnN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChpbkRlZmluaXRpb24udGFnKTsKICAgICAgdmFyIG5hdGl2ZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihpbnN0KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIG90aGVyd2lzZSwgdXNlIHRoZSBkZWZhdWx0CiAgICAgIG5hdGl2ZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTsKICAgIH0KICB9CiAgLy8gY2FjaGUgdGhpcyBpbiBjYXNlIG9mIG1peGluCiAgaW5EZWZpbml0aW9uLm5hdGl2ZSA9IG5hdGl2ZTsKfQoKLy8gU0VDVElPTiA0CgpmdW5jdGlvbiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pIHsKICAvLyA0LmEuMS4gQ3JlYXRlIGEgbmV3IG9iamVjdCB0aGF0IGltcGxlbWVudHMgUFJPVE9UWVBFCiAgLy8gNC5hLjIuIExldCBFTEVNRU5UIGJ5IHRoaXMgbmV3IG9iamVjdAogIC8vCiAgLy8gdGhlIGN1c3RvbSBlbGVtZW50IGluc3RhbnRpYXRpb24gYWxnb3JpdGhtIG11c3QgYWxzbyBlbnN1cmUgdGhhdCB0aGUKICAvLyBvdXRwdXQgaXMgYSB2YWxpZCBET00gZWxlbWVudCB3aXRoIHRoZSBwcm9wZXIgd3JhcHBlciBpbiBwbGFjZS4KICAvLwogIHJldHVybiB1cGdyYWRlKGRvbUNyZWF0ZUVsZW1lbnQoaW5EZWZpbml0aW9uLnRhZyksIGluRGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIHVwZ3JhZGUoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pIHsKICAvLyBzb21lIGRlZmluaXRpb25zIHNwZWNpZnkgYW4gJ2lzJyBhdHRyaWJ1dGUKICBpZiAoaW5EZWZpbml0aW9uLmlzKSB7CiAgICBpbkVsZW1lbnQuc2V0QXR0cmlidXRlKCdpcycsIGluRGVmaW5pdGlvbi5pcyk7CiAgfQogIC8vIG1ha2UgJ2VsZW1lbnQnIGltcGxlbWVudCBpbkRlZmluaXRpb24ucHJvdG90eXBlCiAgaW1wbGVtZW50KGluRWxlbWVudCwgaW5EZWZpbml0aW9uKTsKICAvLyBmbGFnIGFzIHVwZ3JhZGVkCiAgaW5FbGVtZW50Ll9fdXBncmFkZWRfXyA9IHRydWU7CiAgLy8gdGhlcmUgc2hvdWxkIG5ldmVyIGJlIGEgc2hhZG93IHJvb3Qgb24gaW5FbGVtZW50IGF0IHRoaXMgcG9pbnQKICAvLyB3ZSByZXF1aXJlIGNoaWxkIG5vZGVzIGJlIHVwZ3JhZGVkIGJlZm9yZSByZWFkeQogIHNjb3BlLnVwZ3JhZGVTdWJ0cmVlKGluRWxlbWVudCk7CiAgLy8gbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICByZWFkeShpbkVsZW1lbnQpOwogIC8vIE9VVFBVVAogIHJldHVybiBpbkVsZW1lbnQ7Cn0KCmZ1bmN0aW9uIGltcGxlbWVudChpbkVsZW1lbnQsIGluRGVmaW5pdGlvbikgewogIC8vIHByb3RvdHlwZSBzd2l6emxpbmcgaXMgYmVzdAogIGlmIChPYmplY3QuX19wcm90b19fKSB7CiAgICBpbkVsZW1lbnQuX19wcm90b19fID0gaW5EZWZpbml0aW9uLnByb3RvdHlwZTsKICB9IGVsc2UgewogICAgLy8gd2hlcmUgYWJvdmUgd2UgY2FuIHJlLWFjcXVpcmUgaW5Qcm90b3R5cGUgdmlhCiAgICAvLyBnZXRQcm90b3R5cGVPZihFbGVtZW50KSwgd2UgY2Fubm90IGRvIHNvIHdoZW4KICAgIC8vIHdlIHVzZSBtaXhpbiwgc28gd2UgaW5zdGFsbCBhIG1hZ2ljIHJlZmVyZW5jZQogICAgY3VzdG9tTWl4aW4oaW5FbGVtZW50LCBpbkRlZmluaXRpb24ucHJvdG90eXBlLCBpbkRlZmluaXRpb24ubmF0aXZlKTsKICAgIGluRWxlbWVudC5fX3Byb3RvX18gPSBpbkRlZmluaXRpb24ucHJvdG90eXBlOwogIH0KfQoKZnVuY3Rpb24gY3VzdG9tTWl4aW4oaW5UYXJnZXQsIGluU3JjLCBpbk5hdGl2ZSkgewogIC8vIFRPRE8oc2ptaWxlcyk6ICd1c2VkJyBhbGxvd3MgdXMgdG8gb25seSBjb3B5IHRoZSAneW91bmdlc3QnIHZlcnNpb24gb2YKICAvLyBhbnkgcHJvcGVydHkuIFRoaXMgc2V0IHNob3VsZCBiZSBwcmVjYWxjdWxhdGVkLiBXZSBhbHNvIG5lZWQgdG8KICAvLyBjb25zaWRlciB0aGlzIGZvciBzdXBwb3J0aW5nICdzdXBlcicuCiAgdmFyIHVzZWQgPSB7fTsKICAvLyBzdGFydCB3aXRoIGluU3JjCiAgdmFyIHAgPSBpblNyYzsKICAvLyBzb21ldGltZXMgdGhlIGRlZmF1bHQgaXMgSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSBpbnN0ZWFkIG9mCiAgLy8gSFRNTEVsZW1lbnQucHJvdG90eXBlLCBzbyB3ZSBhZGQgYSB0ZXN0CiAgLy8gdGhlIGlkZWEgaXMgdG8gYXZvaWQgbWl4aW5nIGluIG5hdGl2ZSBwcm90b3R5cGVzLCBzbyBhZGRpbmcKICAvLyB0aGUgc2Vjb25kIHRlc3QgaXMgV0xPRwogIHdoaWxlIChwICE9PSBpbk5hdGl2ZSAmJiBwICE9PSBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlKSB7CiAgICB2YXIga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHApOwogICAgZm9yICh2YXIgaT0wLCBrOyBrPWtleXNbaV07IGkrKykgewogICAgICBpZiAoIXVzZWRba10pIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW5UYXJnZXQsIGssCiAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocCwgaykpOwogICAgICAgIHVzZWRba10gPSAxOwogICAgICB9CiAgICB9CiAgICBwID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHApOwogIH0KfQoKZnVuY3Rpb24gcmVhZHkoaW5FbGVtZW50KSB7CiAgLy8gaW52b2tlIHJlYWR5Q2FsbGJhY2sKICBpZiAoaW5FbGVtZW50LnJlYWR5Q2FsbGJhY2spIHsKICAgIGluRWxlbWVudC5yZWFkeUNhbGxiYWNrKCk7CiAgfQp9CgovLyBhdHRyaWJ1dGUgd2F0Y2hpbmcKCnZhciBvcmlnaW5hbFNldEF0dHJpYnV0ZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZS5zZXRBdHRyaWJ1dGU7CnZhciBvcmlnaW5hbFJlbW92ZUF0dHJpYnV0ZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGU7CgpmdW5jdGlvbiBzZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpIHsKICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgb3JpZ2luYWxTZXRBdHRyaWJ1dGUpOwp9CgpmdW5jdGlvbiByZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUpIHsKICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgb3JpZ2luYWxSZW1vdmVBdHRyaWJ1dGUpOwp9CgpmdW5jdGlvbiBjaGFuZ2VBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wZXJhdGlvbikgewogIHZhciBvbGRWYWx1ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpOwogIG9wZXJhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmICh0aGlzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayAKICAgICAgJiYgKHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpICE9PSBvbGRWYWx1ZSkpIHsKICAgIHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZFZhbHVlKTsKICB9Cn0KCi8vIGVsZW1lbnQgcmVnaXN0cnkgKG1hcHMgdGFnIG5hbWVzIHRvIGRlZmluaXRpb25zKQoKdmFyIHJlZ2lzdHJ5ID0ge307CgpmdW5jdGlvbiByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBpbkRlZmluaXRpb24pIHsKICByZWdpc3RyeVtpbk5hbWVdID0gaW5EZWZpbml0aW9uOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZUNvbnN0cnVjdG9yKGluRGVmaW5pdGlvbikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pOwogIH07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQoaW5UYWcpIHsKICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W2luVGFnXTsKICBpZiAoZGVmaW5pdGlvbikgewogICAgcmV0dXJuIG5ldyBkZWZpbml0aW9uLmN0b3IoKTsKICB9CiAgcmV0dXJuIGRvbUNyZWF0ZUVsZW1lbnQoaW5UYWcpOwp9CgpmdW5jdGlvbiB1cGdyYWRlRWxlbWVudChpbkVsZW1lbnQpIHsKICBpZiAoIWluRWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgKGluRWxlbWVudC5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpKSB7CiAgICB2YXIgdHlwZSA9IGluRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgaW5FbGVtZW50LmxvY2FsTmFtZTsKICAgIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbdHlwZV07CiAgICByZXR1cm4gZGVmaW5pdGlvbiAmJiB1cGdyYWRlKGluRWxlbWVudCwgZGVmaW5pdGlvbik7CiAgfQp9Ci8vIGNhcHR1cmUgbmF0aXZlIGNyZWF0ZUVsZW1lbnQgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ3JlYXRlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQuYmluZChkb2N1bWVudCk7CgovLyBleHBvcnRzCgpkb2N1bWVudC5yZWdpc3RlciA9IHJlZ2lzdGVyOwpkb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudDsgLy8gb3ZlcnJpZGUKCnNjb3BlLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CgovKioKICogVXBncmFkZSBhbiBlbGVtZW50IHRvIGEgY3VzdG9tIGVsZW1lbnQuIFVwZ3JhZGluZyBhbiBlbGVtZW50CiAqIGNhdXNlcyB0aGUgY3VzdG9tIHByb3RvdHlwZSB0byBiZSBhcHBsaWVkLCBhbiBgaXNgIGF0dHJpYnV0ZSAKICogdG8gYmUgYXR0YWNoZWQgKGFzIG5lZWRlZCksIGFuZCBpbnZvY2F0aW9uIG9mIHRoZSBgcmVhZHlDYWxsYmFja2AuCiAqIGB1cGdyYWRlYCBkb2VzIG5vdGhpbmcgaWYgdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSB1cGdyYWRlZCwgb3IKICogaWYgaXQgbWF0Y2hlcyBubyByZWdpc3RlcmVkIGN1c3RvbSB0YWcgbmFtZS4KICoKICogQG1ldGhvZCB1Z3ByYWRlCiAqIEBwYXJhbSB7RWxlbWVudH0gaW5FbGVtZW50IFRoZSBlbGVtZW50IHRvIHVwZ3JhZGUuCiAqIEByZXR1cm4ge0VsZW1lbnR9IFRoZSB1cGdyYWRlZCBlbGVtZW50LgogKi8Kc2NvcGUudXBncmFkZSA9IHVwZ3JhZGVFbGVtZW50OwoKfQoKfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsKCiAvKg0KQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NClVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlDQpsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuDQoqLw0KDQooZnVuY3Rpb24oc2NvcGUpew0KDQovKg0KaWYgKEhUTUxFbGVtZW50LnByb3RvdHlwZS53ZWJraXRTaGFkb3dSb290KSB7DQogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShIVE1MRWxlbWVudC5wcm90b3R5cGUsICdzaGFkb3dSb290Jywgew0KICAgIGdldDogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gdGhpcy53ZWJraXRTaGFkb3dSb290Ow0KICAgIH0NCiAgfTsNCn0NCiovDQoNCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGFwcGx5aW5nICdmaW5kKGVsZW1lbnQsIGRhdGEpJyBmdW5jdGlvbiANCi8vIHRvIGVhY2ggZWxlbWVudA0KLy8gaWYgJ2ZpbmQnIHJldHVybnMgdHJ1ZSBmb3IgJ2VsZW1lbnQnLCBkbyBub3Qgc2VhcmNoIGVsZW1lbnQncyBzdWJ0cmVlICANCmZ1bmN0aW9uIGZpbmRBbGwobm9kZSwgZmluZCwgZGF0YSkgew0KICB2YXIgZSA9IG5vZGUuZmlyc3RFbGVtZW50Q2hpbGQ7DQogIGlmICghZSkgew0KICAgIGUgPSBub2RlLmZpcnN0Q2hpbGQ7DQogICAgd2hpbGUgKGUgJiYgZS5ub2RlVHlwZSAhPT0gTm9kZS5FTEVNRU5UX05PREUpIHsNCiAgICAgIGUgPSBlLm5leHRTaWJsaW5nOw0KICAgIH0NCiAgfQ0KICB3aGlsZSAoZSkgew0KICAgIGlmIChmaW5kKGUsIGRhdGEpICE9PSB0cnVlKSB7DQogICAgICBmaW5kQWxsKGUsIGZpbmQsIGRhdGEpOw0KICAgIH0NCiAgICBlID0gZS5uZXh0RWxlbWVudFNpYmxpbmc7CiAgfQ0KICByZXR1cm4gbnVsbDsNCn0NCg0KLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgaW5jbHVkaW5nIGRlc2NlbnQgaW50byBzaGFkb3ctcm9vdHMsIA0KLy8gYXBwbHlpbmcgJ2NiJyB0byBlYWNoIGVsZW1lbnQNCmZ1bmN0aW9uIGZvclN1YnRyZWUobm9kZSwgY2IpIHsNCiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cCgnc3ViVHJlZTogJywgbm9kZSk7DQogIGZpbmRBbGwobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIGlmIChjYihlKSkgew0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIGlmIChlLndlYmtpdFNoYWRvd1Jvb3QpIHsNCiAgICAgIGZvclN1YnRyZWUoZS53ZWJraXRTaGFkb3dSb290LCBjYik7DQogICAgfQ0KICB9KTsNCiAgaWYgKG5vZGUud2Via2l0U2hhZG93Um9vdCkgew0KICAgIGZvclN1YnRyZWUobm9kZS53ZWJraXRTaGFkb3dSb290LCBjYik7DQogIH0NCiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cEVuZCgpOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUNCmZ1bmN0aW9uIGFkZGVkKG5vZGUpIHsNCiAgaWYgKHVwZ3JhZGUobm9kZSkpIHsNCiAgICBpbnNlcnRlZE5vZGUobm9kZSk7DQogICAgcmV0dXJuIHRydWU7IA0KICB9DQogIGluc2VydGVkKG5vZGUpOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUncyBzdWJ0cmVlIG9ubHkNCmZ1bmN0aW9uIGFkZGVkU3VidHJlZShub2RlKSB7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIGlmIChhZGRlZChlKSkgew0KICAgICAgcmV0dXJuIHRydWU7IA0KICAgIH0NCiAgfSk7DQp9DQoNCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSBhbmQgaXQncyBzdWJ0cmVlDQpmdW5jdGlvbiBhZGRlZE5vZGUobm9kZSkgew0KICByZXR1cm4gYWRkZWQobm9kZSkgfHwgYWRkZWRTdWJ0cmVlKG5vZGUpOw0KfQ0KDQovLyB1cGdyYWRlIGN1c3RvbSBlbGVtZW50cyBhdCBub2RlLCBpZiBhcHBsaWNhYmxlDQpmdW5jdGlvbiB1cGdyYWRlKG5vZGUpIHsNCiAgaWYgKCFub2RlLl9fdXBncmFkZWRfXyAmJiBub2RlLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkgew0KICAgIHZhciB0eXBlID0gbm9kZS5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgbm9kZS5sb2NhbE5hbWU7DQogICAgdmFyIGRlZmluaXRpb24gPSBzY29wZS5yZWdpc3RyeVt0eXBlXTsNCiAgICBpZiAoZGVmaW5pdGlvbikgew0KICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGU6Jywgbm9kZS5sb2NhbE5hbWUpOw0KICAgICAgc2NvcGUudXBncmFkZShub2RlKTsNCiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogIH0NCn0NCg0KZnVuY3Rpb24gaW5zZXJ0ZWROb2RlKG5vZGUpIHsNCiAgaW5zZXJ0ZWQobm9kZSk7DQogIGlmIChpbkRvY3VtZW50KG5vZGUpKSB7DQogICAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7DQogICAgICBpbnNlcnRlZChlKTsNCiAgICB9KTsNCiAgfQ0KfQ0KDQovLyBUT0RPKHNqbWlsZXMpOiBpZiB0aGVyZSBhcmUgZGVzY2VudHMgaW50byB0cmVlcyB0aGF0IGNhbiBuZXZlciBoYXZlIGluRG9jdW1lbnQoKikgdHJ1ZSwgZml4IHRoaXMNCg0KZnVuY3Rpb24gaW5zZXJ0ZWQoZWxlbWVudCkgew0KICAvLyBUT0RPKHNqbWlsZXMpOiBpdCdzIHBvc3NpYmxlIHdlIHdlcmUgaW5zZXJ0ZWQgYW5kIHJlbW92ZWQgaW4gdGhlIHNwYWNlDQogIC8vIG9mIG9uZSBtaWNyb3Rhc2ssIGluIHdoaWNoIGNhc2Ugd2Ugd29uJ3QgYmUgJ2luRG9jdW1lbnQnIGhlcmUNCiAgLy8gQnV0IHRoZXJlIGFyZSBvdGhlciBjYXNlcyB3aGVyZSB3ZSBhcmUgdGVzdGluZyBmb3IgaW5zZXJ0ZWQgd2l0aG91dA0KICAvLyBzcGVjaWZpYyBrbm93bGVkZ2Ugb2YgbXV0YXRpb25zLCBhbmQgbXVzdCB0ZXN0ICdpbkRvY3VtZW50JyB0byBkZXRlcm1pbmUNCiAgLy8gd2hldGhlciB0byBjYWxsIGluc2VydGVkDQogIC8vIElmIHdlIGNhbiBmYWN0b3IgdGhlc2UgY2FzZXMgaW50byBzZXBhcmF0ZSBjb2RlIHBhdGhzIHdlIGNhbiBoYXZlDQogIC8vIGJldHRlciBkaWFnbm9zdGljcy4NCiAgLy8gVE9ETyhzam1pbGVzKTogd2hlbiBsb2dnaW5nLCBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuDQogIC8vIHRyYWNrIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQNCiAgLy9jb25zb2xlLmxvZygnaW5zZXJ0ZWQ6ICcsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgaWYgKGVsZW1lbnQuaW5zZXJ0ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogICAgaWYgKGluRG9jdW1lbnQoZWxlbWVudCkpIHsNCiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgKyAxOw0KICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ3JlbW92ZWQnIHN0YXRlLCBibHVudGx5IGFkanVzdCB0byBhbiAnaW5zZXJ0ZWQnIHN0YXRlDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMSkgew0KICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAxOw0KICAgICAgfQ0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIGluc2VydGVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAxKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lLA0KICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkNCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgICAgICBlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2soKTsNCiAgICAgIH0NCiAgICB9DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiByZW1vdmVkTm9kZShub2RlKSB7DQogIHJlbW92ZWQobm9kZSk7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIHJlbW92ZWQoZSk7DQogIH0pOw0KfQ0KDQpmdW5jdGlvbiByZW1vdmVkKGVsZW1lbnQpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogdGVtcG9yYXJ5OiBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuIHRyYWNrDQogIC8vIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQNCiAgaWYgKGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrIHx8IChlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiBsb2dGbGFncy5kb20pKSB7DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgICBpZiAoIWluRG9jdW1lbnQoZWxlbWVudCkpIHsNCiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgLSAxOw0KICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ2luc2VydGVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ3JlbW92ZWQnIHN0YXRlDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMCkgew0KICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAwOw0KICAgICAgfQ0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIHJlbW92ZWQnLCBzcXVlbGNoIHRoZSBjYWxsYmFjaw0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDApIHsNCiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybigncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwNCiAgICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkNCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2spIHsNCiAgICAgICAgZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2soKTsNCiAgICAgIH0NCiAgICB9DQogIH0NCn0NCg0KZnVuY3Rpb24gaW5Eb2N1bWVudChlbGVtZW50KSB7DQogIHZhciBwID0gZWxlbWVudDsNCiAgd2hpbGUgKHApIHsNCiAgICBpZiAocCA9PSBlbGVtZW50Lm93bmVyRG9jdW1lbnQpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBwID0gcC5wYXJlbnROb2RlIHx8IHAuaG9zdDsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiB3YXRjaFNoYWRvdyhub2RlKSB7DQogIGlmIChub2RlLndlYmtpdFNoYWRvd1Jvb3QgJiYgIW5vZGUud2Via2l0U2hhZG93Um9vdC5fX3dhdGNoZWQpIHsNCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3dhdGNoaW5nIHNoYWRvdy1yb290IGZvcjogJywgbm9kZS5sb2NhbE5hbWUpOw0KICAgIG9ic2VydmUobm9kZS53ZWJraXRTaGFkb3dSb290KTsNCiAgICBub2RlLndlYmtpdFNoYWRvd1Jvb3QuX193YXRjaGVkID0gdHJ1ZTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiB3YXRjaEFsbFNoYWRvd3Mobm9kZSkgew0KICB3YXRjaFNoYWRvdyhub2RlKTsNCiAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7DQogICAgd2F0Y2hTaGFkb3cobm9kZSk7DQogIH0pOw0KfQ0KDQpmdW5jdGlvbiBmaWx0ZXIoaW5Ob2RlKSB7DQogIHN3aXRjaCAoaW5Ob2RlLmxvY2FsTmFtZSkgew0KICAgIGNhc2UgJ3N0eWxlJzoNCiAgICBjYXNlICdzY3JpcHQnOg0KICAgIGNhc2UgJ3RlbXBsYXRlJzoNCiAgICBjYXNlIHVuZGVmaW5lZDoNCiAgICAgIHJldHVybiB0cnVlOw0KICB9DQp9DQoNCmZ1bmN0aW9uIGhhbmRsZXIobXV0YXRpb25zKSB7DQogIC8vDQogIGlmIChsb2dGbGFncy5kb20pIHsNCiAgICB2YXIgbXggPSBtdXRhdGlvbnNbMF07DQogICAgaWYgKG14ICYmIG14LnR5cGUgPT09ICdjaGlsZExpc3QnICYmIG14LmFkZGVkTm9kZXMpIHsNCiAgICAgICAgaWYgKG14LmFkZGVkTm9kZXMpIHsNCiAgICAgICAgICB2YXIgZCA9IG14LmFkZGVkTm9kZXNbMF07DQogICAgICAgICAgd2hpbGUgKGQgJiYgZCAhPT0gZG9jdW1lbnQgJiYgIWQuaG9zdCkgew0KICAgICAgICAgICAgZCA9IGQucGFyZW50Tm9kZTsNCiAgICAgICAgICB9DQogICAgICAgICAgdmFyIHUgPSBkICYmIChkLlVSTCB8fCBkLl9VUkwgfHwgKGQuaG9zdCAmJiBkLmhvc3QubG9jYWxOYW1lKSkgfHwgJyc7DQogICAgICAgICAgdSA9IHUuc3BsaXQoJy8/Jykuc2hpZnQoKS5zcGxpdCgnLycpLnBvcCgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9ucyAoJWQpIFslc10nLCBtdXRhdGlvbnMubGVuZ3RoLCB1IHx8ICcnKTsNCiAgfQ0KICAvLw0KICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihteCkgew0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9uJyk7DQogICAgaWYgKG14LnR5cGUgPT09ICdjaGlsZExpc3QnKSB7DQogICAgICBmb3JFYWNoKG14LmFkZGVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOw0KICAgICAgICBpZiAoZmlsdGVyKG4pKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIC8vIHdhdGNoIHNoYWRvdy1yb290cyBvbiBub2RlcyB0aGF0IGhhdmUgaGFkIHRoZW0gYXR0YWNoZWQgbWFudWFsbHkNCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlIGlmIGNyZWF0ZVNoYWRvd1Jvb3QgaXMgb3ZlcnJpZGRlbg0KICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZW1vdmVkIGFzIGFuIG9wdGltaXphdGlvbiwgbWFudWFsIHNoYWRvdyByb290cw0KICAgICAgICAvLyBtdXN0IGJlIHdhdGNoZWQgZXhwbGljaXRseQ0KICAgICAgICAvL3dhdGNoQWxsU2hhZG93cyhuKTsNCiAgICAgICAgLy8gbm9kZXMgYWRkZWQgbWF5IG5lZWQgbGlmZWN5Y2xlIG1hbmFnZW1lbnQNCiAgICAgICAgYWRkZWROb2RlKG4pOw0KICAgICAgfSk7DQogICAgICAvLyByZW1vdmVkIG5vZGVzIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50DQogICAgICBmb3JFYWNoKG14LnJlbW92ZWROb2RlcywgZnVuY3Rpb24obikgew0KICAgICAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZyhuLmxvY2FsTmFtZSk7DQogICAgICAgIGlmIChmaWx0ZXIobikpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgcmVtb3ZlZE5vZGUobik7DQogICAgICB9KTsNCiAgICB9DQogICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KICB9KTsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn07DQoNCnZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGhhbmRsZXIpOw0KDQpmdW5jdGlvbiB0YWtlUmVjb3JkcygpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogYXNrIFJhZiB3aHkgd2UgaGF2ZSB0byBjYWxsIGhhbmRsZXIgb3Vyc2VsdmVzDQogIGhhbmRsZXIob2JzZXJ2ZXIudGFrZVJlY29yZHMoKSk7DQp9DQoNCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsNCg0KZnVuY3Rpb24gb2JzZXJ2ZShpblJvb3QpIHsNCiAgb2JzZXJ2ZXIub2JzZXJ2ZShpblJvb3QsIHtjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWV9KTsNCn0NCg0KZnVuY3Rpb24gb2JzZXJ2ZURvY3VtZW50KGRvY3VtZW50KSB7DQogIG9ic2VydmUoZG9jdW1lbnQpOw0KfQ0KDQpmdW5jdGlvbiB1cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpIHsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGVEb2N1bWVudDogJywgKGRvY3VtZW50LlVSTCB8fCBkb2N1bWVudC5fVVJMIHx8ICcnKS5zcGxpdCgnLycpLnBvcCgpKTsNCiAgYWRkZWROb2RlKGRvY3VtZW50KTsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn0NCg0KLy8gZXhwb3J0cw0KDQpzY29wZS53YXRjaFNoYWRvdyA9IHdhdGNoU2hhZG93Ow0Kc2NvcGUud2F0Y2hBbGxTaGFkb3dzID0gd2F0Y2hBbGxTaGFkb3dzOw0KDQpzY29wZS51cGdyYWRlQWxsID0gYWRkZWROb2RlOw0Kc2NvcGUudXBncmFkZVN1YnRyZWUgPSBhZGRlZFN1YnRyZWU7DQoNCnNjb3BlLm9ic2VydmVEb2N1bWVudCA9IG9ic2VydmVEb2N1bWVudDsNCnNjb3BlLnVwZ3JhZGVEb2N1bWVudCA9IHVwZ3JhZGVEb2N1bWVudDsNCg0Kc2NvcGUudGFrZVJlY29yZHMgPSB0YWtlUmVjb3JkczsNCg0KfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsNCgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKCl7CiAgCnZhciBIVE1MRWxlbWVudEVsZW1lbnQgPSBmdW5jdGlvbihpbkVsZW1lbnQpIHsKICBpbkVsZW1lbnQucmVnaXN0ZXIgPSBIVE1MRWxlbWVudEVsZW1lbnQucHJvdG90eXBlLnJlZ2lzdGVyOwogIHBhcnNlRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50KTsKICByZXR1cm4gaW5FbGVtZW50Owp9OwoKSFRNTEVsZW1lbnRFbGVtZW50LnByb3RvdHlwZSA9IHsKICByZWdpc3RlcjogZnVuY3Rpb24oaW5Nb3JlKSB7CiAgICBpZiAoaW5Nb3JlKSB7CiAgICAgIHRoaXMub3B0aW9ucy5saWZlY3ljbGUgPSBpbk1vcmUubGlmZWN5Y2xlOwogICAgICBpZiAoaW5Nb3JlLnByb3RvdHlwZSkgewogICAgICAgIG1peGluKHRoaXMub3B0aW9ucy5wcm90b3R5cGUsIGluTW9yZS5wcm90b3R5cGUpOwogICAgICB9CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gcGFyc2VFbGVtZW50RWxlbWVudChpbkVsZW1lbnQpIHsKICAvLyBvcHRpb25zIHRvIGdsZWFuIGZyb20gaW5FbGVtZW50IGF0dHJpYnV0ZXMKICB2YXIgb3B0aW9ucyA9IHsKICAgIG5hbWU6ICcnLAogICAgZXh0ZW5kczogbnVsbAogIH07CiAgLy8gZ2xlYW4gdGhlbQogIHRha2VBdHRyaWJ1dGVzKGluRWxlbWVudCwgb3B0aW9ucyk7CiAgLy8gZGVmYXVsdCBiYXNlCiAgdmFyIGJhc2UgPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7CiAgLy8gb3B0aW9uYWwgc3BlY2lmaWVkIGJhc2UKICBpZiAob3B0aW9ucy5leHRlbmRzKSB7CiAgICAvLyBidWlsZCBhbiBpbnN0YW5jZSBvZiBvcHRpb25zLmV4dGVuZHMKICAgIHZhciBhcmNoZXR5cGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG9wdGlvbnMuZXh0ZW5kcyk7CiAgICAvLyBhY3F1aXJlIHRoZSBwcm90b3R5cGUKICAgIC8vIFRPRE8oc2ptaWxlcyk6IF9fcHJvdG9fXyBtYXkgYmUgaGludGVkIGJ5IHRoZSBjdXN0b20gZWxlbWVudAogICAgLy8gc3lzdGVtIG9uIHBsYXRmb3JtcyB0aGF0IGRvbid0IHN1cHBvcnQgbmF0aXZlIF9fcHJvdG9fXwogICAgLy8gb24gdGhvc2UgcGxhdGZvcm1zIHRoZSBBUEkgaXMgbWl4ZWQgaW50byBhcmNoZXR5cGUgYW5kIHRoZQogICAgLy8gZWZmZWN0aXZlIGJhc2UgaXMgbm90IGFyY2hldHlwZSdzIHJlYWwgcHJvdG90eXBlCiAgICBiYXNlID0gYXJjaGV0eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXJjaGV0eXBlKTsKICB9CiAgLy8gZXh0ZW5kIGJhc2UKICBvcHRpb25zLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoYmFzZSk7CiAgLy8gaW5zdGFsbCBvcHRpb25zCiAgaW5FbGVtZW50Lm9wdGlvbnMgPSBvcHRpb25zOwogIC8vIGxvY2F0ZSB1c2VyIHNjcmlwdAogIHZhciBzY3JpcHQgPSBpbkVsZW1lbnQucXVlcnlTZWxlY3Rvcignc2NyaXB0LHNjcmlwdHMnKTsKICBpZiAoc2NyaXB0KSB7CiAgICAvLyBleGVjdXRlIHVzZXIgc2NyaXB0IGluICdpbkVsZW1lbnQnIGNvbnRleHQKICAgIGV4ZWN1dGVDb21wb25lbnRTY3JpcHQoc2NyaXB0LnRleHRDb250ZW50LCBpbkVsZW1lbnQsIG9wdGlvbnMubmFtZSk7CiAgfTsKICAvLyByZWdpc3RlciBvdXIgbmV3IGVsZW1lbnQKICB2YXIgY3RvciA9IGRvY3VtZW50LnJlZ2lzdGVyKG9wdGlvbnMubmFtZSwgb3B0aW9ucyk7CiAgaW5FbGVtZW50LmN0b3IgPSBjdG9yOwogIC8vIHN0b3JlIG9wdGlvbmFsIGNvbnN0cnVjdG9yIHJlZmVyZW5jZQogIHZhciByZWZOYW1lID0gaW5FbGVtZW50LmdldEF0dHJpYnV0ZSgnY29uc3RydWN0b3InKTsKICBpZiAocmVmTmFtZSkgewogICAgd2luZG93W3JlZk5hbWVdID0gY3RvcjsKICB9Cn0KICAKLy8gZWFjaCBwcm9wZXJ0eSBpbiBpbkRpY3Rpb25hcnkgdGFrZXMgYSB2YWx1ZQovLyBmcm9tIHRoZSBtYXRjaGluZyBhdHRyaWJ1dGUgaW4gaW5FbGVtZW50LCBpZiBhbnkKZnVuY3Rpb24gdGFrZUF0dHJpYnV0ZXMoaW5FbGVtZW50LCBpbkRpY3Rpb25hcnkpIHsKICBmb3IgKHZhciBuIGluIGluRGljdGlvbmFyeSkgewogICAgdmFyIGEgPSBpbkVsZW1lbnQuYXR0cmlidXRlc1tuXTsKICAgIGlmIChhKSB7CiAgICAgIGluRGljdGlvbmFyeVtuXSA9IGEudmFsdWU7CiAgICB9CiAgfQp9CgovLyBpbnZva2UgaW5TY3JpcHQgaW4gaW5Db250ZXh0IHNjb3BlCmZ1bmN0aW9uIGV4ZWN1dGVDb21wb25lbnRTY3JpcHQoaW5TY3JpcHQsIGluQ29udGV4dCwgaW5OYW1lKSB7CiAgLy8gc2V0IChoaWdobGFuZGVyKSBjb250ZXh0CiAgY29udGV4dCA9IGluQ29udGV4dDsKICAvLyBzb3VyY2UgbG9jYXRpb24KICB2YXIgb3duZXIgPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQ7CiAgdmFyIHVybCA9IChvd25lci5fVVJMIHx8IG93bmVyLlVSTCB8fCBvd25lci5pbXBsIAogICAgICAmJiAob3duZXIuaW1wbC5fVVJMIHx8IG93bmVyLmltcGwuVVJMKSk7CiAgLy8gZW5zdXJlIHRoZSBjb21wb25lbnQgaGFzIGEgdW5pcXVlIHNvdXJjZSBtYXAgc28gaXQgY2FuIGJlIGRlYnVnZ2VkCiAgLy8gaWYgdGhlIG5hbWUgbWF0Y2hlcyB0aGUgZmlsZW5hbWUgcGFydCBvZiB0aGUgb3duaW5nIGRvY3VtZW50J3MgdXJsLAogIC8vIHVzZSB0aGlzLCBvdGhlcndpc2UsIGFkZCAiOjxuYW1lPiIgdG8gdGhlIGRvY3VtZW50IHVybC4KICB2YXIgbWF0Y2ggPSB1cmwubWF0Y2goLy4qXC8oW14uXSopWy5dPy4qJC8pOwogIGlmIChtYXRjaCkgewogICAgdmFyIG5hbWUgPSBtYXRjaFsxXTsKICAgIHVybCArPSBuYW1lICE9IGluTmFtZSA/ICc6JyArIGluTmFtZSA6ICcnOwogIH0KICAvLyBjb21wb3NlIHNjcmlwdAogIHZhciBjb2RlID0gIl9fY29tcG9uZW50U2NyaXB0KCciCiAgICArIGluTmFtZQogICAgKyAiJywgZnVuY3Rpb24oKXsiCiAgICArIGluU2NyaXB0CiAgICArICJ9KTsiCiAgICArICJcbi8vQCBzb3VyY2VVUkw9IiArIHVybCArICJcbiIKICA7CiAgLy8gaW5qZWN0IHNjcmlwdAogIGV2YWwoY29kZSk7Cn0KCnZhciBjb250ZXh0OwoKLy8gZ2xvYmFsIG5lY2Vzc2FyeSBmb3Igc2NyaXB0IGluamVjdGlvbgp3aW5kb3cuX19jb21wb25lbnRTY3JpcHQgPSBmdW5jdGlvbihpbk5hbWUsIGluRnVuYykgewogIGluRnVuYy5jYWxsKGNvbnRleHQpOwp9OwoKLy8gdXRpbGl0eQoKLy8gY29weSBhbGwgcHJvcGVydGllcyBmcm9tIGluUHJvcHMgKGV0IGFsKSB0byBpbk9iagpmdW5jdGlvbiBtaXhpbihpbk9iai8qLCBpblByb3BzLCBpbk1vcmVQcm9wcywgLi4uKi8pIHsKICB2YXIgb2JqID0gaW5PYmogfHwge307CiAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBwID0gYXJndW1lbnRzW2ldOwogICAgdHJ5IHsKICAgICAgZm9yICh2YXIgbiBpbiBwKSB7CiAgICAgICAgY29weVByb3BlcnR5KG4sIHAsIG9iaik7CiAgICAgIH0KICAgIH0gY2F0Y2goeCkgewogICAgfQogIH0KICByZXR1cm4gb2JqOwp9CgovLyBjb3B5IHByb3BlcnR5IGluTmFtZSBmcm9tIGluU291cmNlIG9iamVjdCB0byBpblRhcmdldCBvYmplY3QKZnVuY3Rpb24gY29weVByb3BlcnR5KGluTmFtZSwgaW5Tb3VyY2UsIGluVGFyZ2V0KSB7CiAgdmFyIHBkID0gZ2V0UHJvcGVydHlEZXNjcmlwdG9yKGluU291cmNlLCBpbk5hbWUpOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpblRhcmdldCwgaW5OYW1lLCBwZCk7Cn0KCi8vIGdldCBwcm9wZXJ0eSBkZXNjcmlwdG9yIGZvciBpbk5hbWUgb24gaW5PYmplY3QsIGV2ZW4gaWYKLy8gaW5OYW1lIGV4aXN0cyBvbiBzb21lIGxpbmsgaW4gaW5PYmplY3QncyBwcm90b3R5cGUgY2hhaW4KZnVuY3Rpb24gZ2V0UHJvcGVydHlEZXNjcmlwdG9yKGluT2JqZWN0LCBpbk5hbWUpIHsKICBpZiAoaW5PYmplY3QpIHsKICAgIHZhciBwZCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoaW5PYmplY3QsIGluTmFtZSk7CiAgICByZXR1cm4gcGQgfHwgZ2V0UHJvcGVydHlEZXNjcmlwdG9yKE9iamVjdC5nZXRQcm90b3R5cGVPZihpbk9iamVjdCksIGluTmFtZSk7CiAgfQp9CgovLyBleHBvcnRzCgp3aW5kb3cuSFRNTEVsZW1lbnRFbGVtZW50ID0gSFRNTEVsZW1lbnRFbGVtZW50OwovLyBUT0RPKHNqbWlsZXMpOiBjb21wbGV0ZWx5IGFkLWhvYywgdXNlZCBieSBQb2x5bWVyLnJlZ2lzdGVyCndpbmRvdy5taXhpbiA9IG1peGluOwoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oKSB7Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgZm9yIHBhcnNpbmcgYSBkb2N1bWVudCB0cmVlCgp2YXIgY29tcG9uZW50UGFyc2VyID0gewogIHNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2xpbmtbcmVsPXN0eWxlc2hlZXRdJywKICAgICdzY3JpcHRbc3JjXScsCiAgICAnc2NyaXB0JywKICAgICdzdHlsZScsCiAgICAnZWxlbWVudCcKICBdLAogIG1hcDogewogICAgbGluazogJ3BhcnNlTGluaycsCiAgICBzY3JpcHQ6ICdwYXJzZVNjcmlwdCcsCiAgICBlbGVtZW50OiAncGFyc2VFbGVtZW50JywKICAgIHN0eWxlOiAncGFyc2VTdHlsZScKICB9LAogIHBhcnNlOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICBpZiAoIWluRG9jdW1lbnQuX19wYXJzZWQpIHsKICAgICAgLy8gb25seSBwYXJzZSBvbmNlCiAgICAgIGluRG9jdW1lbnQuX19wYXJzZWQgPSB0cnVlOwogICAgICAvLyBhbGwgcGFyc2FibGUgZWxlbWVudHMgaW4gaW5Eb2N1bWVudCAoZGVwdGgtZmlyc3QgcHJlLW9yZGVyIHRyYXZlcnNhbCkKICAgICAgdmFyIGVsdHMgPSBpbkRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoY3Auc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgLy9jb25zb2xlLmxvZyhtYXBbZS5sb2NhbE5hbWVdICsgIjoiLCBwYXRoLm5vZGVVcmwoZSkpOwogICAgICAgIGNwW2NwLm1hcFtlLmxvY2FsTmFtZV1dKGUpOwogICAgICB9KTsKICAgICAgLy8gdXBncmFkZSBhbGwgdXBncmFkZWFibGUgc3RhdGljIGVsZW1lbnRzLCBhbnl0aGluZyBkeW5hbWljYWxseQogICAgICAvLyBjcmVhdGVkIHNob3VsZCBiZSBjYXVnaHQgYnkgb2JzZXJ2ZXIKICAgICAgQ3VzdG9tRWxlbWVudHMudXBncmFkZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgICAvLyBvYnNlcnZlIGRvY3VtZW50IGZvciBkb20gY2hhbmdlcwogICAgICBDdXN0b21FbGVtZW50cy5vYnNlcnZlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGluTGlua0VsdCkgewogICAgLy8gaW1wb3J0cwogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGluTGlua0VsdCkpIHsKICAgICAgaWYgKGluTGlua0VsdC5jb250ZW50KSB7CiAgICAgICAgY3AucGFyc2UoaW5MaW5rRWx0LmNvbnRlbnQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCFpbk1haW5Eb2N1bWVudChpbkxpbmtFbHQpCiAgICAgICAgJiYgaW5MaW5rRWx0LnBhcmVudE5vZGUKICAgICAgICAmJiAhaXNFbGVtZW50RWxlbWVudENoaWxkKGluTGlua0VsdCkpIHsKICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChpbkxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VTY3JpcHQ6IGZ1bmN0aW9uKGluU2NyaXB0RWx0KSB7CiAgICAvLyBpZ25vcmUgc2NyaXB0cyBpbiBwcmltYXJ5IGRvY3VtZW50LCB0aGV5IGFyZSBhbHJlYWR5IGxvYWRlZAogICAgaWYgKGluTWFpbkRvY3VtZW50KGluU2NyaXB0RWx0KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyBpZ25vcmUgc2NyaXB0cyBpbnNpZGUgPGVsZW1lbnQ+CiAgICBpZiAoaXNFbGVtZW50RWxlbWVudENoaWxkKGluU2NyaXB0RWx0KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyBvdGhlcndpc2UsIGV2YWx1YXRlIG5vdwogICAgdmFyIGNvZGUgPSBpblNjcmlwdEVsdC5fX3Jlc291cmNlIHx8IGluU2NyaXB0RWx0LnRleHRDb250ZW50OwogICAgaWYgKGNvZGUpIHsKICAgICAgY29kZSArPSAiXG4vL0Agc291cmNlVVJMPSIgKyBpblNjcmlwdEVsdC5fX25vZGVVcmwgKyAiXG4iOwogICAgICBldmFsLmNhbGwod2luZG93LCBjb2RlKTsKICAgIH0KICB9LAogIHBhcnNlU3R5bGU6IGZ1bmN0aW9uKGluU3R5bGVFbHQpIHsKICAgIGlmICghaW5NYWluRG9jdW1lbnQoaW5TdHlsZUVsdCkgJiYgIWlzRWxlbWVudEVsZW1lbnRDaGlsZChpblN0eWxlRWx0KSkgewogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkJykuYXBwZW5kQ2hpbGQoaW5TdHlsZUVsdCk7CiAgICB9CiAgfSwKICBwYXJzZUVsZW1lbnQ6IGZ1bmN0aW9uKGluRWxlbWVudEVsdCkgewogICAgbmV3IEhUTUxFbGVtZW50RWxlbWVudChpbkVsZW1lbnRFbHQpOwogIH0KfTsKCnZhciBjcCA9IGNvbXBvbmVudFBhcnNlcjsKCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGluRWx0KSB7CiAgcmV0dXJuIGluRWx0Lm93bmVyRG9jdW1lbnQgPT09IGRvY3VtZW50IHx8CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgIGluRWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBJTVBPUlRfTElOS19UWVBFKTsKfQoKZnVuY3Rpb24gaXNFbGVtZW50RWxlbWVudENoaWxkKGluRWx0KSB7CiAgaWYgKGluRWx0LnBhcmVudE5vZGUgJiYgaW5FbHQucGFyZW50Tm9kZS5sb2NhbE5hbWUgPT09ICdlbGVtZW50JykgewogICAgcmV0dXJuIHRydWU7CiAgfQp9Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpDdXN0b21FbGVtZW50cy5wYXJzZXIgPSBjb21wb25lbnRQYXJzZXI7Cgp9KSgpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwooZnVuY3Rpb24oKXsKCi8vIGJvb3RzdHJhcCBwYXJzaW5nCgovLyBJRSBzaGltIGZvciBDdXN0b21FdmVudAppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCmZ1bmN0aW9uIGJvb3RzdHJhcCgpIHsKICAvLyBnbyBhc3luYyBzbyBjYWxsIHN0YWNrIGNhbiB1bndpbmQKICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgLy8gcGFyc2UgZG9jdW1lbnQKICAgIEN1c3RvbUVsZW1lbnRzLnBhcnNlci5wYXJzZShkb2N1bWVudCk7CiAgICAvLyBzZXQgaW50ZXJuYWwgZmxhZwogICAgQ3VzdG9tRWxlbWVudHMucmVhZHkgPSB0cnVlOwogICAgQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICBpZiAod2luZG93LkhUTUxJbXBvcnRzKSB7CiAgICAgIEN1c3RvbUVsZW1lbnRzLmVsYXBzZWQgPSBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgLSBIVE1MSW1wb3J0cy5yZWFkeVRpbWU7CiAgICB9CiAgICAvLyBub3RpZnkgc3lzdGVtCiAgICBkb2N1bWVudC5ib2R5LmRpc3BhdGNoRXZlbnQoCiAgICAgIG5ldyBDdXN0b21FdmVudCgnV2ViQ29tcG9uZW50c1JlYWR5Jywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9LCAwKTsKfQoKLy8gVE9ETyhzam1pbGVzKTogJ3dpbmRvdycgaGFzIG5vIHdyYXBwYWJpbGl0eSB1bmRlciBTaGFkb3dET00gcG9seWZpbGwsIHNvCi8vIHdlIGFyZSBmb3JjZWQgdG8gc3BsaXQgaW50byB0d28gdmVyc2lvbnMKCmlmICh3aW5kb3cuSFRNTEltcG9ydHMpIHsKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdIVE1MSW1wb3J0c0xvYWRlZCcsIGJvb3RzdHJhcCk7Cn0gZWxzZSB7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBib290c3RyYXApOwp9Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCkgewoKLy8gaW5qZWN0IHN0eWxlIHNoZWV0CmRvY3VtZW50LndyaXRlKCc8c3R5bGU+ZWxlbWVudCB7ZGlzcGxheTogbm9uZTt9IC8qIGluamVjdGVkIGJ5IHBsYXRmb3JtLmpzICovPC9zdHlsZT4nKTsKCmlmICh3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwpIHsKCiAgZnVuY3Rpb24gbm9wKCkge307CgogIC8vIGRpc2FibGUgc2hhZG93IGRvbSB3YXRjaGluZwogIEN1c3RvbUVsZW1lbnRzLndhdGNoU2hhZG93ID0gbm9wOwogIEN1c3RvbUVsZW1lbnRzLndhdGNoQWxsU2hhZG93cyA9IG5vcDsKCiAgLy8gZW5zdXJlIHdyYXBwZWQgaW5wdXRzIGZvciB0aGVzZSBmdW5jdGlvbnMKICB2YXIgZm5zID0gWyd1cGdyYWRlQWxsJywgJ3VwZ3JhZGVTdWJ0cmVlJywgJ29ic2VydmVEb2N1bWVudCcsCiAgICAgICd1cGdyYWRlRG9jdW1lbnQnXTsKCiAgLy8gY2FjaGUgb3JpZ2luYWxzCiAgdmFyIG9yaWdpbmFsID0ge307CiAgZm5zLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKICAgIG9yaWdpbmFsW2ZuXSA9IEN1c3RvbUVsZW1lbnRzW2ZuXTsKICB9KTsKCiAgLy8gb3ZlcnJpZGUKICBmbnMuZm9yRWFjaChmdW5jdGlvbihmbikgewogICAgQ3VzdG9tRWxlbWVudHNbZm5dID0gZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICAgIHJldHVybiBvcmlnaW5hbFtmbl0od3JhcChpbk5vZGUpKTsKICAgIH07CiAgfSk7Cgp9Cgp9KSgpOwoKKGZ1bmN0aW9uICgpIHsKCi8qKiogVmFyaWFibGVzICoqKi8KCiAgdmFyIHdpbiA9IHdpbmRvdywKICAgIGRvYyA9IGRvY3VtZW50LAogICAgbm9vcCA9IGZ1bmN0aW9uKCl7fSwKICAgIHJlZ2V4UHNldWRvU3BsaXQgPSAvKFx3Kyg/OlwoW15cKV0rXCkpPykvZywKICAgIHJlZ2V4UHNldWRvUmVwbGFjZSA9IC8oXHcqKSg/OlwoKFteXCldKilcKSk/LywKICAgIHJlZ2V4RGlnaXRzID0gLyhcZCspL2csCiAgICBrZXlwc2V1ZG8gPSB7CiAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICByZXR1cm4gcHNldWRvLnZhbHVlLm1hdGNoKHJlZ2V4RGlnaXRzKS5pbmRleE9mKFN0cmluZyhldmVudC5rZXlDb2RlKSkgPiAtMSA9PSAocHNldWRvLm5hbWUgPT0gJ2tleXBhc3MnKTsKICAgICAgfQogICAgfSwKICAgIHByZWZpeCA9IChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzdHlsZXMgPSB3aW4uZ2V0Q29tcHV0ZWRTdHlsZShkb2MuZG9jdW1lbnRFbGVtZW50LCAnJyksCiAgICAgICAgICBwcmUgPSAoQXJyYXkucHJvdG90eXBlLnNsaWNlCiAgICAgICAgICAgIC5jYWxsKHN0eWxlcykKICAgICAgICAgICAgLmpvaW4oJycpCiAgICAgICAgICAgIC5tYXRjaCgvLShtb3p8d2Via2l0fG1zKS0vKSB8fCAoc3R5bGVzLk9MaW5rID09PSAnJyAmJiBbJycsICdvJ10pCiAgICAgICAgICApWzFdOwogICAgICByZXR1cm4gewogICAgICAgIGRvbTogcHJlID09ICdtcycgPyBwcmUudG9VcHBlckNhc2UoKSA6IHByZSwKICAgICAgICBsb3dlcmNhc2U6IHByZSwKICAgICAgICBjc3M6ICctJyArIHByZSArICctJywKICAgICAgICBqczogcHJlWzBdLnRvVXBwZXJDYXNlKCkgKyBwcmUuc3Vic3RyKDEpCiAgICAgIH07CgogICAgfSkoKSwKICAgIG1hdGNoU2VsZWN0b3IgPSBFbGVtZW50LnByb3RvdHlwZS5tYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGVbcHJlZml4Lmxvd2VyY2FzZSArICdNYXRjaGVzU2VsZWN0b3InXTsKCi8qKiogRnVuY3Rpb25zICoqKi8KCi8vIFV0aWxpdGllcwoKICB2YXIgdHlwZU9iaiA9IHt9OwogIGZ1bmN0aW9uIHR5cGVPZihvYmopIHsKICAgIHJldHVybiB0eXBlT2JqLnRvU3RyaW5nLmNhbGwob2JqKS5tYXRjaCgvXHMoW2EtekEtWl0rKS8pWzFdLnRvTG93ZXJDYXNlKCk7CiAgfQoKICBmdW5jdGlvbiBjbG9uZShpdGVtLCB0eXBlKXsKICAgIHZhciBmbiA9IGNsb25lW3R5cGUgfHwgdHlwZU9mKGl0ZW0pXTsKICAgIHJldHVybiBmbiA/IGZuKGl0ZW0pIDogaXRlbTsKICB9CiAgICBjbG9uZS5vYmplY3QgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgb2JqID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIG9ialtrZXldID0gY2xvbmUoc3JjW2tleV0pOwogICAgICByZXR1cm4gb2JqOwogICAgfTsKICAgIGNsb25lLmFycmF5ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIGkgPSBzcmMubGVuZ3RoLCBhcnJheSA9IG5ldyBBcnJheShpKTsKICAgICAgd2hpbGUgKGktLSkgYXJyYXlbaV0gPSBjbG9uZShzcmNbaV0pOwogICAgICByZXR1cm4gYXJyYXk7CiAgICB9OwoKICB2YXIgdW5zbGljZWFibGUgPSBbJ251bWJlcicsICdib29sZWFuJywgJ3N0cmluZycsICdmdW5jdGlvbiddOwogIGZ1bmN0aW9uIHRvQXJyYXkob2JqKXsKICAgIHJldHVybiB1bnNsaWNlYWJsZS5pbmRleE9mKHR5cGVPZihvYmopKSA9PSAtMSA/CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChvYmosIDApIDoKICAgIFtvYmpdOwogIH0KCi8vIERPTQogIHZhciBzdHIgPSAnJzsKICBmdW5jdGlvbiBxdWVyeShlbGVtZW50LCBzZWxlY3Rvcil7CiAgICByZXR1cm4gKHNlbGVjdG9yIHx8IHN0cikubGVuZ3RoID8gdG9BcnJheShlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpKSA6IFtdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKSB7CiAgICB2YXIgZGlmZiA9IHsgYWRkZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVjb3JkKXsKICAgICAgcmVjb3JkLl9tdXRhdGlvbiA9IHRydWU7CiAgICAgIGZvciAodmFyIHogaW4gZGlmZikgewogICAgICAgIHZhciB0eXBlID0gZWxlbWVudC5fcmVjb3Jkc1soeiA9PSAnYWRkZWQnKSA/ICdpbnNlcnRlZCcgOiAncmVtb3ZlZCddLAogICAgICAgICAgbm9kZXMgPSByZWNvcmRbeiArICdOb2RlcyddLCBsZW5ndGggPSBub2Rlcy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGggJiYgZGlmZlt6XS5pbmRleE9mKG5vZGVzW2ldKSA9PSAtMTsgaSsrKXsKICAgICAgICAgIGRpZmZbel0ucHVzaChub2Rlc1tpXSk7CiAgICAgICAgICB0eXBlLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICBmbihub2Rlc1tpXSwgcmVjb3JkKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKLy8gTWl4aW5zCgogIGZ1bmN0aW9uIG1lcmdlT25lKHNvdXJjZSwga2V5LCBjdXJyZW50KXsKICAgIHZhciB0eXBlID0gdHlwZU9mKGN1cnJlbnQpOwogICAgaWYgKHR5cGUgPT0gJ29iamVjdCcgJiYgdHlwZU9mKHNvdXJjZVtrZXldKSA9PSAnb2JqZWN0JykgeHRhZy5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CiAgICBlbHNlIHNvdXJjZVtrZXldID0gY2xvbmUoY3VycmVudCwgdHlwZSk7CiAgICByZXR1cm4gc291cmNlOwogIH0KCiAgZnVuY3Rpb24gbWVyZ2VNaXhpbih0eXBlLCBtaXhpbiwgb3B0aW9uKSB7CiAgICB2YXIgb3JpZ2luYWwgPSB7fTsKICAgIGZvciAodmFyIG8gaW4gb3B0aW9uKSBvcmlnaW5hbFtvLnNwbGl0KCc6JylbMF1dID0gdHJ1ZTsKICAgIGZvciAodmFyIHggaW4gbWl4aW4pIGlmICghb3JpZ2luYWxbeC5zcGxpdCgnOicpWzBdXSkgb3B0aW9uW3hdID0gbWl4aW5beF07CiAgfQoKICBmdW5jdGlvbiBhcHBseU1peGlucyh0YWcpIHsKICAgIHRhZy5taXhpbnMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgbWl4aW4gPSB4dGFnLm1peGluc1tuYW1lXTsKICAgICAgZm9yICh2YXIgdHlwZSBpbiBtaXhpbikgewogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgY2FzZSAnbGlmZWN5Y2xlJzogY2FzZSAnbWV0aG9kcyc6CiAgICAgICAgICAgIG1lcmdlTWl4aW4odHlwZSwgbWl4aW5bdHlwZV0sIHRhZ1t0eXBlXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnYWNjZXNzb3JzJzogY2FzZSAncHJvdG90eXBlJzoKICAgICAgICAgICAgZm9yICh2YXIgeiBpbiBtaXhpblt0eXBlXSkgbWVyZ2VNaXhpbih6LCBtaXhpblt0eXBlXSwgdGFnLmFjY2Vzc29ycyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnZXZlbnRzJzoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiB0YWc7CiAgfQoKLy8gQWNjZXNzb3JzCgogIGZ1bmN0aW9uIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgc3luYyl7CiAgICB2YXIga2V5ID0gei5zcGxpdCgnOicpLCB0eXBlID0ga2V5WzBdOwogICAgaWYgKHR5cGUgPT0gJ2dldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhY2Nlc3Nvclt6XSwgdGFnLnBzZXVkb3MpOwogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PSAnc2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGF0dHIgPyBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgc3luYy5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICBhY2Nlc3Nvclt6XS5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgfSA6IGFjY2Vzc29yW3pdLCB0YWcucHNldWRvcyk7CiAgICB9CiAgICBlbHNlIHRhZy5wcm90b3R5cGVbcHJvcF1bel0gPSBhY2Nlc3Nvclt6XTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQWNjZXNzb3IodGFnLCBwcm9wKXsKICAgIHRhZy5wcm90b3R5cGVbcHJvcF0gPSB7fTsKICAgIHZhciBhY2Nlc3NvciA9IHRhZy5hY2Nlc3NvcnNbcHJvcF0sCiAgICAgICAgYXR0ciA9IGFjY2Vzc29yLmF0dHJpYnV0ZSwKICAgICAgICBuYW1lID0gYXR0ciAmJiBhdHRyLm5hbWUgPyBhdHRyLm5hbWUudG9Mb3dlckNhc2UoKSA6IHByb3AsCiAgICAgICAgc3luYyA9IG51bGw7CgogICAgaWYgKGF0dHIpIHsKICAgICAgdGFnLmF0dHJpYnV0ZXNbbmFtZV0gPSBhdHRyOwogICAgICB0YWcuYXR0cmlidXRlc1tuYW1lXS5zZXR0ZXIgPSBwcm9wOwogICAgICBzeW5jID0gZnVuY3Rpb24odmFsdWUpewogICAgICAgIHZhciBub2RlID0gdGhpcy54dGFnLmF0dHJpYnV0ZU5vZGVzW25hbWVdOwogICAgICAgIGlmICghbm9kZSB8fCAobm9kZSAhPSB0aGlzICYmICFub2RlLnBhcmVudE5vZGUpKSB7CiAgICAgICAgICBub2RlID0gdGhpcy54dGFnLmF0dHJpYnV0ZU5vZGVzW25hbWVdID0gYXR0ci5wcm9wZXJ0eSA/IHRoaXMueHRhZ1thdHRyLnByb3BlcnR5XSA6IGF0dHIuc2VsZWN0b3IgPyB0aGlzLnF1ZXJ5U2VsZWN0b3IoYXR0ci5zZWxlY3RvcikgOiB0aGlzOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsID0gYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSwKICAgICAgICAgICAgbWV0aG9kID0gKGF0dHIuYm9vbGVhbiAmJiAodmFsdWUgPT09IGZhbHNlIHx8IHZhbHVlID09PSBudWxsKSkgPyAncmVtb3ZlQXR0cmlidXRlJyA6IHZhbHVlID09PSBudWxsID8gJ3JlbW92ZUF0dHJpYnV0ZScgOiAnc2V0QXR0cmlidXRlJzsKICAgICAgICBpZiAodmFsdWUgIT0gKGF0dHIuYm9vbGVhbiA/IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpKSB0aGlzW21ldGhvZF0obmFtZSwgdmFsLCB0cnVlKTsKICAgICAgICBpZiAobm9kZSAmJiBub2RlICE9IHRoaXMgJiYgKHZhbHVlICE9IChhdHRyLmJvb2xlYW4gPyBub2RlLmhhc0F0dHJpYnV0ZShuYW1lKSA6IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpKSkpIG5vZGVbbWV0aG9kXShuYW1lLCB2YWwsIHRydWUpOwogICAgICB9OwogICAgfQoKICAgIGZvciAodmFyIHogaW4gYWNjZXNzb3IpIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgc3luYyk7CgogICAgaWYgKGF0dHIpIHsKICAgICAgaWYgKCF0YWcucHJvdG90eXBlW3Byb3BdLmdldCkgewogICAgICAgIHZhciBtZXRob2QgPSAoYXR0ci5ib29sZWFuID8gJ2hhcycgOiAnZ2V0JykgKyAnQXR0cmlidXRlJzsKICAgICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICByZXR1cm4gdGhpc1ttZXRob2RdKG5hbWUpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKCF0YWcucHJvdG90eXBlW3Byb3BdLnNldCkgdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSBzeW5jOwogICAgfQoKICB9CgovLyBFdmVudHMKCiAgZnVuY3Rpb24gdG91Y2hGaWx0ZXIoY3VzdG9tLCBldmVudCkgewogICAgaWYgKGN1c3RvbS5saXN0ZW5lci50b3VjaGVkKSByZXR1cm4gY3VzdG9tLmxpc3RlbmVyLnRvdWNoZWQgPSBmYWxzZTsKICAgIGVsc2UgewogICAgICBpZiAoZXZlbnQudHlwZS5tYXRjaCgndG91Y2gnKSkgY3VzdG9tLmxpc3RlbmVyLnRvdWNoZWQgPSB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmxvd0V2ZW50KHR5cGUpIHsKICAgIHZhciBmbG93ID0gdHlwZSA9PSAnb3Zlcic7CiAgICByZXR1cm4gewogICAgICBiYXNlOiAnT3ZlcmZsb3dFdmVudCcgaW4gd2luID8gJ292ZXJmbG93Y2hhbmdlZCcgOiB0eXBlICsgJ2Zsb3cnLAogICAgICBjb25kaXRpb246IGZ1bmN0aW9uIChjdXN0b20sIGV2ZW50KSB7CiAgICAgICAgZXZlbnQuZmxvdyA9IHR5cGU7CiAgICAgICAgcmV0dXJuIGV2ZW50LnR5cGUgPT0gKHR5cGUgKyAnZmxvdycpIHx8CiAgICAgICAgKChldmVudC5vcmllbnQgPT09IDAgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAxICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDIgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSk7CiAgICAgIH0KICAgIH07CiAgfQoKLyoqKiBYLVRhZyBPYmplY3QgRGVmaW5pdGlvbiAqKiovCgogIHZhciB4dGFnID0gewogICAgdGFnczoge30sCiAgICBkZWZhdWx0T3B0aW9uczogewogICAgICBwc2V1ZG9zOiBbXSwKICAgICAgbWl4aW5zOiBbXSwKICAgICAgZXZlbnRzOiB7fSwKICAgICAgbWV0aG9kczoge30sCiAgICAgIGFjY2Vzc29yczoge30sCiAgICAgIGxpZmVjeWNsZToge30sCiAgICAgIGF0dHJpYnV0ZXM6IHt9LAogICAgICAncHJvdG90eXBlJzogewogICAgICAgIHh0YWc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX194dGFnX18gPyB0aGlzLl9feHRhZ19fIDogKHRoaXMuX194dGFnX18gPSB7IGRhdGE6IHt9LCBhdHRyaWJ1dGVOb2Rlczoge30gfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIChuYW1lLCBvcHRpb25zKSB7CiAgICAgIHZhciBfbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgdmFyIHRhZyA9IHh0YWcudGFnc1tfbmFtZV0gPSBhcHBseU1peGlucyh4dGFnLm1lcmdlKHt9LCB4dGFnLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CgogICAgICBmb3IgKHZhciB6IGluIHRhZy5ldmVudHMpIHRhZy5ldmVudHNbel0gPSB4dGFnLnBhcnNlRXZlbnQoeiwgdGFnLmV2ZW50c1t6XSk7CiAgICAgIGZvciAoeiBpbiB0YWcubGlmZWN5Y2xlKSB0YWcubGlmZWN5Y2xlW3ouc3BsaXQoJzonKVswXV0gPSB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubGlmZWN5Y2xlW3pdLCB0YWcucHNldWRvcyk7CiAgICAgIGZvciAoeiBpbiB0YWcubWV0aG9kcykgdGFnLnByb3RvdHlwZVt6LnNwbGl0KCc6JylbMF1dID0geyB2YWx1ZTogeHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLm1ldGhvZHNbel0sIHRhZy5wc2V1ZG9zKSB9OwogICAgICBmb3IgKHZhciBwcm9wIGluIHRhZy5hY2Nlc3NvcnMpIHBhcnNlQWNjZXNzb3IodGFnLCBwcm9wKTsKCiAgICAgIHZhciByZWFkeSA9IHRhZy5saWZlY3ljbGUuY3JlYXRlZCB8fCB0YWcubGlmZWN5Y2xlLnJlYWR5OwogICAgICB0YWcucHJvdG90eXBlLnJlYWR5Q2FsbGJhY2sgPSB7CiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCl7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMsCiAgICAgICAgICAgICAgc2V0QXR0ciA9IHRoaXMuc2V0QXR0cmlidXRlLAogICAgICAgICAgICAgIHJlbW92ZUF0dHIgPSB0aGlzLnJlbW92ZUF0dHJpYnV0ZTsKCiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgICAgICAgIHNldEF0dHJpYnV0ZTogewogICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUsIHNraXApewogICAgICAgICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lLnRvTG93ZXJDYXNlKCldLAogICAgICAgICAgICAgICAgICAgIHZhbCA9IGF0dHIgJiYgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZTsKICAgICAgICAgICAgICAgIHNldEF0dHIuY2FsbCh0aGlzLCBuYW1lLCB2YWwpOwogICAgICAgICAgICAgICAgaWYgKGF0dHIgJiYgIXNraXApIHRoaXNbYXR0ci5zZXR0ZXJdID0gYXR0ci5ib29sZWFuID8gdGhpcy5oYXNBdHRyaWJ1dGUobmFtZSkgOiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbW92ZUF0dHJpYnV0ZTogewogICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUsIHNraXApewogICAgICAgICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgICAgICAgcmVtb3ZlQXR0ci5jYWxsKHRoaXMsIG5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGF0dHIgJiYgIXNraXApIHRoaXNbYXR0ci5zZXR0ZXJdID0gYXR0ci5ib29sZWFuID8gZmFsc2UgOiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgeHRhZy5hZGRFdmVudHModGhpcywgdGFnLmV2ZW50cyk7CiAgICAgICAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24obWl4aW4pewogICAgICAgICAgICBpZiAoeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cykgeHRhZy5hZGRFdmVudHMoZWxlbWVudCwgeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB2YXIgb3V0cHV0ID0gcmVhZHkgPyByZWFkeS5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpIDogbnVsbDsKCiAgICAgICAgICB0YWcucHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgICAgIG9iai5vbkFkZC5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgICAgICB9KTsKCiAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmluc2VydGVkKSB0YWcucHJvdG90eXBlLmluc2VydGVkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLmluc2VydGVkIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLnJlbW92ZWQpIHRhZy5wcm90b3R5cGUucmVtb3ZlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5yZW1vdmVkIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQpIHRhZy5wcm90b3R5cGUuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkIH07CgogICAgICB2YXIgY29uc3RydWN0b3IgPSBkb2MucmVnaXN0ZXIoX25hbWUsIHsKICAgICAgICAnZXh0ZW5kcyc6IG9wdGlvbnNbJ2V4dGVuZHMnXSwKICAgICAgICAncHJvdG90eXBlJzogT2JqZWN0LmNyZWF0ZSgob3B0aW9uc1snZXh0ZW5kcyddID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChvcHRpb25zWydleHRlbmRzJ10pLmNvbnN0cnVjdG9yIDogd2luLkhUTUxFbGVtZW50KS5wcm90b3R5cGUsIHRhZy5wcm90b3R5cGUpCiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGNvbnN0cnVjdG9yOwogICAgfSwKCiAgICAvKiBFeHBvc2VkIFZhcmlhYmxlcyAqLwoKICAgIG1peGluczoge30sCiAgICBwcmVmaXg6IHByZWZpeCwKICAgIGNhcHR1cmVFdmVudHM6IFsnZm9jdXMnLCAnYmx1ciddLAogICAgY3VzdG9tRXZlbnRzOiB7CiAgICAgIG92ZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ292ZXInKSwKICAgICAgdW5kZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ3VuZGVyJyksCiAgICAgIGFuaW1hdGlvbnN0YXJ0OiB7CiAgICAgICAgYmFzZTogWwogICAgICAgICAgJ2FuaW1hdGlvbnN0YXJ0JywKICAgICAgICAgICdvQW5pbWF0aW9uU3RhcnQnLAogICAgICAgICAgJ01TQW5pbWF0aW9uU3RhcnQnLAogICAgICAgICAgJ3dlYmtpdEFuaW1hdGlvblN0YXJ0JwogICAgICAgIF0KICAgICAgfSwKICAgICAgdHJhbnNpdGlvbmVuZDogewogICAgICAgIGJhc2U6IFsKICAgICAgICAgICd0cmFuc2l0aW9uZW5kJywKICAgICAgICAgICdvVHJhbnNpdGlvbkVuZCcsCiAgICAgICAgICAnTVNUcmFuc2l0aW9uRW5kJywKICAgICAgICAgICd3ZWJraXRUcmFuc2l0aW9uRW5kJwogICAgICAgIF0KICAgICAgfSwKICAgICAgdGFwOiB7CiAgICAgICAgYmFzZTogWydjbGljaycsICd0b3VjaGVuZCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwc3RhcnQ6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlZG93bicsICd0b3VjaHN0YXJ0J10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBlbmQ6IHsKICAgICAgICBiYXNlOiBbJ21vdXNldXAnLCAndG91Y2hlbmQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVudGVyOiB7CiAgICAgICAgYmFzZTogWydtb3VzZW92ZXInLCAndG91Y2hlbnRlciddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbGVhdmU6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlb3V0JywgJ3RvdWNobGVhdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcG1vdmU6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlbW92ZScsICd0b3VjaG1vdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0KICAgIH0sCiAgICBwc2V1ZG9zOiB7CiAgICAgIGtleXBhc3M6IGtleXBzZXVkbywKICAgICAga2V5ZmFpbDoga2V5cHNldWRvLAogICAgICBkZWxlZ2F0ZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBxdWVyeSh0aGlzLCBwc2V1ZG8udmFsdWUpLmZpbHRlcihmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZSA9PSBldmVudC50YXJnZXQgfHwgbm9kZS5jb250YWlucyA/IG5vZGUuY29udGFpbnMoZXZlbnQudGFyZ2V0KSA6IGZhbHNlOwogICAgICAgICAgfSlbMF07CiAgICAgICAgICByZXR1cm4gdGFyZ2V0ID8gcHNldWRvLmxpc3RlbmVyID0gcHNldWRvLmxpc3RlbmVyLmJpbmQodGFyZ2V0KSA6IGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJldmVudGFibGU6IHsKICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qIFVUSUxJVElFUyAqLwoKICAgIGNsb25lOiBjbG9uZSwKICAgIHR5cGVPZjogdHlwZU9mLAogICAgdG9BcnJheTogdG9BcnJheSwKCiAgICB3cmFwOiBmdW5jdGlvbiAob3JpZ2luYWwsIGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICByZXR1cm5lZCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHJldHVybiByZXR1cm5lZCA9PT0gZmFsc2UgPyBmYWxzZSA6IGZuLmFwcGx5KHRoaXMsIHR5cGVvZiByZXR1cm5lZCAhPSAndW5kZWZpbmVkJyA/IHRvQXJyYXkocmV0dXJuZWQpIDogYXJncyk7CiAgICAgIH07CiAgICB9LAoKICAgIG1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewogICAgICBpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKICAgICAgICB2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0sCgogICAgLyogRE9NICovCgogICAgcXVlcnk6IHF1ZXJ5LAoKICAgIHNraXBUcmFuc2l0aW9uOiBmdW5jdGlvbihlbGVtZW50LCBmbiwgYmluZCl7CiAgICAgIHZhciBkdXJhdGlvbiA9IHByZWZpeC5qcyArICdUcmFuc2l0aW9uRHVyYXRpb24nOwogICAgICBlbGVtZW50LnN0eWxlW2R1cmF0aW9uXSA9ICcwLjAwMXMnOwogICAgICBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcwLjAwMXMnOwogICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICBpZiAoZm4pIGNhbGxiYWNrID0gZm4uY2FsbChiaW5kKTsKICAgICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgICAgZWxlbWVudC5zdHlsZVtkdXJhdGlvbl0gPSAnJzsKICAgICAgICAgIGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvbkR1cmF0aW9uID0gJyc7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHh0YWcucmVxdWVzdEZyYW1lKGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlcXVlc3RGcmFtZTogKGZ1bmN0aW9uKCl7CiAgICAgIHZhciByYWYgPSB3aW4ucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgd2luW3ByZWZpeC5sb3dlcmNhc2UgKyAnUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ10gfHwKICAgICAgICBmdW5jdGlvbihmbil7IHJldHVybiB3aW4uc2V0VGltZW91dChmbiwgMjApOyB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oZm4pewogICAgICAgIHJldHVybiByYWYuY2FsbCh3aW4sIGZuKTsKICAgICAgfTsKICAgIH0pKCksCgogICAgbWF0Y2hTZWxlY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiBtYXRjaFNlbGVjdG9yLmNhbGwoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtZW50LCBtZXRob2QsIHZhbHVlKSB7CiAgICAgIGVsZW1lbnRbbWV0aG9kXSA9IHZhbHVlOwogICAgICBpZiAod2luZG93LkN1c3RvbUVsZW1lbnRzKSBDdXN0b21FbGVtZW50cy51cGdyYWRlQWxsKGVsZW1lbnQpOwogICAgfSwKCiAgICBpbm5lckhUTUw6IGZ1bmN0aW9uKGVsLCBodG1sKXsKICAgICAgeHRhZy5zZXQoZWwsICdpbm5lckhUTUwnLCBodG1sKTsKICAgIH0sCgogICAgaGFzQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICByZXR1cm4gZWxlbWVudC5jbGFzc05hbWUuc3BsaXQoJyAnKS5pbmRleE9mKGtsYXNzLnRyaW0oKSk+LTE7CiAgICB9LAoKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgdmFyIGxpc3QgPSBlbGVtZW50LmNsYXNzTmFtZS50cmltKCkuc3BsaXQoJyAnKTsKICAgICAga2xhc3MudHJpbSgpLnNwbGl0KCcgJykuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGlmICghfmxpc3QuaW5kZXhPZihuYW1lKSkgbGlzdC5wdXNoKG5hbWUpOwogICAgICB9KTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBsaXN0LmpvaW4oJyAnKS50cmltKCk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBjbGFzc2VzID0ga2xhc3MudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJykuZmlsdGVyKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5hbWUgJiYgIX5jbGFzc2VzLmluZGV4T2YobmFtZSk7CiAgICAgIH0pLmpvaW4oJyAnKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9LAoKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIHh0YWdbeHRhZy5oYXNDbGFzcyhlbGVtZW50LCBrbGFzcykgPyAncmVtb3ZlQ2xhc3MnIDogJ2FkZENsYXNzJ10uY2FsbChudWxsLCBlbGVtZW50LCBrbGFzcyk7CgogICAgfSwKCiAgICBxdWVyeUNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGlkID0gZWxlbWVudC5pZCwKICAgICAgICBndWlkID0gZWxlbWVudC5pZCA9IGlkIHx8ICd4XycgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKICAgICAgICBhdHRyID0gJyMnICsgZ3VpZCArICcgPiAnOwogICAgICBzZWxlY3RvciA9IGF0dHIgKyAoc2VsZWN0b3IgKyAnJykucmVwbGFjZSgnLCcsICcsJyArIGF0dHIsICdnJyk7CiAgICAgIHZhciByZXN1bHQgPSBlbGVtZW50LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICAgIGlmICghaWQpIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwogICAgICByZXR1cm4gdG9BcnJheShyZXN1bHQpOwogICAgfSwKCiAgICBjcmVhdGVGcmFnbWVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB2YXIgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGlmIChjb250ZW50KSB7CiAgICAgICAgdmFyIGRpdiA9IGZyYWcuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpKSwKICAgICAgICAgIG5vZGVzID0gdG9BcnJheShjb250ZW50Lm5vZGVOYW1lID8gYXJndW1lbnRzIDogIShkaXYuaW5uZXJIVE1MID0gY29udGVudCkgfHwgZGl2LmNoaWxkcmVuKSwKICAgICAgICAgIGxlbmd0aCA9IG5vZGVzLmxlbmd0aCwKICAgICAgICAgIGluZGV4ID0gMDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIGZyYWcuaW5zZXJ0QmVmb3JlKG5vZGVzW2luZGV4KytdLCBkaXYpOwogICAgICAgIGZyYWcucmVtb3ZlQ2hpbGQoZGl2KTsKICAgICAgfQogICAgICByZXR1cm4gZnJhZzsKICAgIH0sCgogICAgbWFuaXB1bGF0ZTogZnVuY3Rpb24oZWxlbWVudCwgZm4pewogICAgICB2YXIgbmV4dCA9IGVsZW1lbnQubmV4dFNpYmxpbmcsCiAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlLAogICAgICAgIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgIHJldHVybmVkID0gZm4uY2FsbChmcmFnLmFwcGVuZENoaWxkKGVsZW1lbnQpLCBmcmFnKSB8fCBlbGVtZW50OwogICAgICBpZiAobmV4dCkgcGFyZW50Lmluc2VydEJlZm9yZShyZXR1cm5lZCwgbmV4dCk7CiAgICAgIGVsc2UgcGFyZW50LmFwcGVuZENoaWxkKHJldHVybmVkKTsKICAgIH0sCgogICAgLyogUFNFVURPUyAqLwoKICAgIGFwcGx5UHNldWRvczogZnVuY3Rpb24oa2V5LCBmbiwgZWxlbWVudCkgewogICAgICB2YXIgbGlzdGVuZXIgPSBmbiwKICAgICAgICAgIHBzZXVkb3MgPSB7fTsKICAgICAgaWYgKGtleS5tYXRjaCgnOicpKSB7CiAgICAgICAgdmFyIHNwbGl0ID0ga2V5Lm1hdGNoKHJlZ2V4UHNldWRvU3BsaXQpLAogICAgICAgICAgICBpID0gc3BsaXQubGVuZ3RoOwogICAgICAgIHdoaWxlICgtLWkpIHsKICAgICAgICAgIHNwbGl0W2ldLnJlcGxhY2UocmVnZXhQc2V1ZG9SZXBsYWNlLCBmdW5jdGlvbiAobWF0Y2gsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBwc2V1ZG8gPSBwc2V1ZG9zW2ldID0gT2JqZWN0LmNyZWF0ZSh4dGFnLnBzZXVkb3NbbmFtZV0pOwogICAgICAgICAgICAgICAgcHNldWRvLmtleSA9IGtleTsKICAgICAgICAgICAgICAgIHBzZXVkby5uYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIHBzZXVkby52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBpZiAoIXBzZXVkbykgdGhyb3cgInBzZXVkbyBub3QgZm91bmQ6ICIgKyBuYW1lOwogICAgICAgICAgICB2YXIgbGFzdCA9IGxpc3RlbmVyOwogICAgICAgICAgICBsaXN0ZW5lciA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgICAgIG9iaiA9IHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcjogbGFzdAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChwc2V1ZG8uYWN0aW9uICYmIHBzZXVkby5hY3Rpb24uYXBwbHkodGhpcywgW29ial0uY29uY2F0KGFyZ3MpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gb2JqLmxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoZWxlbWVudCAmJiBwc2V1ZG8ub25BZGQpIHsKICAgICAgICAgICAgICBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgIHBzZXVkby5vbkFkZC5jYWxsKGVsZW1lbnQsIHBzZXVkbyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQucHVzaChwc2V1ZG8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAodmFyIHogaW4gcHNldWRvcykgewogICAgICAgIGlmIChwc2V1ZG9zW3pdLm9uQ29tcGlsZWQpIGxpc3RlbmVyID0gcHNldWRvc1t6XS5vbkNvbXBpbGVkKGxpc3RlbmVyLCBwc2V1ZG9zW3pdKTsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICB9LAoKICAgIHJlbW92ZVBzZXVkb3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50KXsKICAgICAgZXZlbnQuX3BzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgIG9iai5vblJlbW92ZS5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgIH0pOwogICAgfSwKCiAgLyoqKiBFdmVudHMgKioqLwoKICAgIHBhcnNlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKSB7CiAgICAgIHZhciBwc2V1ZG9zID0gdHlwZS5zcGxpdCgnOicpLAogICAgICAgIGtleSA9IHBzZXVkb3Muc2hpZnQoKSwKICAgICAgICBldmVudCA9IHh0YWcubWVyZ2UoewogICAgICAgICAgYmFzZToga2V5LAogICAgICAgICAgcHNldWRvczogJycsCiAgICAgICAgICBfcHNldWRvczogW10sCiAgICAgICAgICBvbkFkZDogbm9vcCwKICAgICAgICAgIG9uUmVtb3ZlOiBub29wLAogICAgICAgICAgY29uZGl0aW9uOiBub29wCiAgICAgICAgfSwgeHRhZy5jdXN0b21FdmVudHNba2V5XSB8fCB7fSk7CiAgICAgIGV2ZW50LnR5cGUgPSBrZXkgKyAoZXZlbnQucHNldWRvcy5sZW5ndGggPyAnOicgKyBldmVudC5wc2V1ZG9zIDogJycpICsgKHBzZXVkb3MubGVuZ3RoID8gJzonICsgcHNldWRvcy5qb2luKCc6JykgOiAnJyk7CiAgICAgIGlmIChmbikgewogICAgICAgIHZhciBjaGFpbmVkID0geHRhZy5hcHBseVBzZXVkb3MoZXZlbnQudHlwZSwgZm4sIGV2ZW50Ll9wc2V1ZG9zKTsKICAgICAgICBldmVudC5saXN0ZW5lciA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChldmVudC5jb25kaXRpb24uYXBwbHkodGhpcywgW2V2ZW50XS5jb25jYXQoYXJncykpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgcmV0dXJuIGNoYWluZWQuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZXZlbnQ7CiAgICB9LAoKICAgIGFkZEV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgdmFyIGV2ZW50ID0gKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSA/IHh0YWcucGFyc2VFdmVudCh0eXBlLCBmbikgOiBmbjsKICAgICAgZXZlbnQubGlzdGVuZXIuZXZlbnQgPSBldmVudDsKICAgICAgZXZlbnQuX3BzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgIG9iai5vbkFkZC5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgIH0pOwogICAgICBldmVudC5vbkFkZC5jYWxsKGVsZW1lbnQsIGV2ZW50LCBldmVudC5saXN0ZW5lcik7CiAgICAgIHRvQXJyYXkoZXZlbnQuYmFzZSkuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihuYW1lLCBldmVudC5saXN0ZW5lciwgeHRhZy5jYXB0dXJlRXZlbnRzLmluZGV4T2YobmFtZSkgPiAtMSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gZXZlbnQubGlzdGVuZXI7CiAgICB9LAoKICAgIGFkZEV2ZW50czogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50cykgewogICAgICB2YXIgbGlzdGVuZXJzID0ge307CiAgICAgIGZvciAodmFyIHogaW4gZXZlbnRzKSB7CiAgICAgICAgbGlzdGVuZXJzW3pdID0geHRhZy5hZGRFdmVudChlbGVtZW50LCB6LCBldmVudHNbel0pOwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgdmFyIGV2ZW50ID0gZm4uZXZlbnQ7CiAgICAgIGV2ZW50Lm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgZXZlbnQsIGZuKTsKICAgICAgeHRhZy5yZW1vdmVQc2V1ZG9zKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgdG9BcnJheShldmVudC5iYXNlKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIGZuKTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50czogZnVuY3Rpb24oZWxlbWVudCwgbGlzdGVuZXJzKXsKICAgICAgZm9yICh2YXIgeiBpbiBsaXN0ZW5lcnMpIHh0YWcucmVtb3ZlRXZlbnQoZWxlbWVudCwgeiwgbGlzdGVuZXJzW3pdKTsKICAgIH0sCgogICAgZmlyZUV2ZW50OiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBkYXRhLCBvcHRpb25zKXsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBldmVudCA9IGRvYy5jcmVhdGVFdmVudCgnRXZlbnQnKTsKICAgICAgZXZlbnQuaW5pdEV2ZW50KHR5cGUsICdidWJibGVzJyBpbiBvcHRpb25zID8gb3B0aW9ucy5idWJibGVzIDogdHJ1ZSwgJ2NhbmNlbGFibGUnIGluIG9wdGlvbnMgPyBvcHRpb25zLmNhbmNlbGFibGUgOiB0cnVlKTsKICAgICAgZm9yICh2YXIgeiBpbiBkYXRhKSBldmVudFt6XSA9IGRhdGFbel07CiAgICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICB9LAoKICAgIGFkZE9ic2VydmVyOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbil7CiAgICAgIGlmICghZWxlbWVudC5fcmVjb3JkcykgewogICAgICAgIGVsZW1lbnQuX3JlY29yZHMgPSB7IGluc2VydGVkOiBbXSwgcmVtb3ZlZDogW10gfTsKICAgICAgICBpZiAobXV0YXRpb24pewogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIgPSBuZXcgbXV0YXRpb24oZnVuY3Rpb24obXV0YXRpb25zKSB7CiAgICAgICAgICAgIHBhcnNlTXV0YXRpb25zKGVsZW1lbnQsIG11dGF0aW9ucyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGVsZW1lbnQuX29ic2VydmVyLm9ic2VydmUoZWxlbWVudCwgewogICAgICAgICAgICBzdWJ0cmVlOiB0cnVlLAogICAgICAgICAgICBjaGlsZExpc3Q6IHRydWUsCiAgICAgICAgICAgIGF0dHJpYnV0ZXM6ICF0cnVlLAogICAgICAgICAgICBjaGFyYWN0ZXJEYXRhOiBmYWxzZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgWydJbnNlcnRlZCcsICdSZW1vdmVkJ10uZm9yRWFjaChmdW5jdGlvbih0eXBlKXsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZScgKyB0eXBlLCBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICAgIGV2ZW50Ll9tdXRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVsZW1lbnQuX3JlY29yZHNbdHlwZS50b0xvd2VyQ2FzZSgpXS5mb3JFYWNoKGZ1bmN0aW9uKGZuKXsKICAgICAgICAgICAgICBmbihldmVudC50YXJnZXQsIGV2ZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGVsZW1lbnQuX3JlY29yZHNbdHlwZV0uaW5kZXhPZihmbikgPT0gLTEpIGVsZW1lbnQuX3JlY29yZHNbdHlwZV0ucHVzaChmbik7CiAgICB9LAoKICAgIHJlbW92ZU9ic2VydmVyOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbil7CiAgICAgIHZhciBvYmogPSBlbGVtZW50Ll9yZWNvcmRzOwogICAgICBpZiAob2JqICYmIGZuKXsKICAgICAgICBvYmpbdHlwZV0uc3BsaWNlKG9ialt0eXBlXS5pbmRleE9mKGZuKSwgMSk7CiAgICAgIH0KICAgICAgZWxzZXsKICAgICAgICBvYmpbdHlwZV0gPSBbXTsKICAgICAgfQogICAgfQoKICB9OwoKICBpZiAodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIGRlZmluZSh4dGFnKTsKICBlbHNlIHdpbi54dGFnID0geHRhZzsKCiAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ1dlYkNvbXBvbmVudHNSZWFkeScsIGZ1bmN0aW9uKCl7CiAgICB4dGFnLmZpcmVFdmVudChkb2MuYm9keSwgJ0RPTUNvbXBvbmVudHNMb2FkZWQnKTsKICB9KTsKCn0pKCk7Cg==",
                "body": "Ly8gV2UgZG9uJ3QgdXNlIHRoZSBwbGF0Zm9ybSBib290c3RyYXBwZXIsIHNvIGZha2UgdGhpcyBzdHVmZi4KCndpbmRvdy5QbGF0Zm9ybSA9IHt9Owp2YXIgbG9nRmxhZ3MgPSB7fTsKLyoKICogQ29weXJpZ2h0IDIwMTIgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJlbmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovLyBTaWRlVGFibGUgaXMgYSB3ZWFrIG1hcCB3aGVyZSBwb3NzaWJsZS4gSWYgV2Vha01hcCBpcyBub3QgYXZhaWxhYmxlIHRoZQovLyBhc3NvY2lhdGlvbiBpcyBzdG9yZWQgYXMgYW4gZXhwYW5kbyBwcm9wZXJ0eS4KdmFyIFNpZGVUYWJsZTsKLy8gVE9ETyhhcnYpOiBXZWFrTWFwIGRvZXMgbm90IGFsbG93IGZvciBOb2RlIGV0YyB0byBiZSBrZXlzIGluIEZpcmVmb3gKaWYgKHR5cGVvZiBXZWFrTWFwICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0ZpcmVmb3gvJykgPCAwKSB7CiAgU2lkZVRhYmxlID0gV2Vha01hcDsKfSBlbHNlIHsKICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSBPYmplY3QuZGVmaW5lUHJvcGVydHk7CiAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgY291bnRlciA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICUgMWU5OwoKICAgIFNpZGVUYWJsZSA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5hbWUgPSAnX19zdCcgKyAoTWF0aC5yYW5kb20oKSAqIDFlOSA+Pj4gMCkgKyAoY291bnRlcisrICsgJ19fJyk7CiAgICB9OwoKICAgIFNpZGVUYWJsZS5wcm90b3R5cGUgPSB7CiAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGRlZmluZVByb3BlcnR5KGtleSwgdGhpcy5uYW1lLCB7dmFsdWU6IHZhbHVlLCB3cml0YWJsZTogdHJ1ZX0pOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGtleSwgdGhpcy5uYW1lKSA/IGtleVt0aGlzLm5hbWVdIDogdW5kZWZpbmVkOwogICAgICB9LAogICAgICBkZWxldGU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgdW5kZWZpbmVkKTsKICAgICAgfQogICAgfQogIH0pKCk7Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpIHsKICAKICAvLyBwb29yIG1hbidzIGFkYXB0ZXIgZm9yIHRlbXBsYXRlLmNvbnRlbnQgb24gdmFyaW91cyBwbGF0Zm9ybSBzY2VuYXJpb3MKICB3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gd2luZG93LnRlbXBsYXRlQ29udGVudCB8fCBmdW5jdGlvbihpblRlbXBsYXRlKSB7CiAgICByZXR1cm4gaW5UZW1wbGF0ZS5jb250ZW50OwogIH07CgogIC8vIHNvIHdlIGNhbiBjYWxsIHdyYXAvdW53cmFwIHdpdGhvdXQgdGVzdGluZyBmb3IgU2hhZG93RE9NUG9seWZpbGwKCiAgd2luZG93LndyYXAgPSB3aW5kb3cudW53cmFwID0gZnVuY3Rpb24obil7CiAgICByZXR1cm4gbjsKICB9CgogIHdpbmRvdy5jcmVhdGVTaGFkb3dSb290ID0gZnVuY3Rpb24oaW5FbGVtZW50KSB7CiAgICByZXR1cm4gaW5FbGVtZW50LndlYmtpdENyZWF0ZVNoYWRvd1Jvb3QoKTsKICB9OwoKICB3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gZnVuY3Rpb24oaW5UZW1wbGF0ZSkgewogICAgLy8gaWYgTURWIGV4aXN0cywgaXQgbWF5IG5lZWQgdG8gYm9vc3RyYXAgdGhpcyB0ZW1wbGF0ZSB0byByZXZlYWwgY29udGVudAogICAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICAgIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKGluVGVtcGxhdGUpOwogICAgfQogICAgLy8gZmFsbGJhY2sgd2hlbiB0aGVyZSBpcyBubyBTaGFkb3cgRE9NIHBvbHlmaWxsLCBubyBNRFYgcG9seWZpbGwsIGFuZCBubwogICAgLy8gbmF0aXZlIHRlbXBsYXRlIHN1cHBvcnQKICAgIGlmICghaW5UZW1wbGF0ZS5jb250ZW50ICYmICFpblRlbXBsYXRlLl9jb250ZW50KSB7CiAgICAgIHZhciBmcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICB3aGlsZSAoaW5UZW1wbGF0ZS5maXJzdENoaWxkKSB7CiAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChpblRlbXBsYXRlLmZpcnN0Q2hpbGQpOwogICAgICB9CiAgICAgIGluVGVtcGxhdGUuX2NvbnRlbnQgPSBmcmFnOwogICAgfQogICAgcmV0dXJuIGluVGVtcGxhdGUuY29udGVudCB8fCBpblRlbXBsYXRlLl9jb250ZW50OwogIH07Cgp9KSgpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgovLyBPbGQgdmVyc2lvbnMgb2YgaU9TIGRvIG5vdCBoYXZlIGJpbmQuCgppZiAoIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKSB7CiAgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPSBmdW5jdGlvbihzY29wZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJnczIgPSBhcmdzLnNsaWNlKCk7CiAgICAgIGFyZ3MyLnB1c2guYXBwbHkoYXJnczIsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBzZWxmLmFwcGx5KHNjb3BlLCBhcmdzMik7CiAgICB9OwogIH07Cn0KCi8vIG5hbWVzcGFjZSBhbiBpbXBvcnQgZnJvbSBDdXN0b21FbGVtZW50cwovLyBUT0RPKHNqbWlsZXMpOiBjbGVhbiB1cCB0aGlzIGdsb2JhbApzY29wZS5taXhpbiA9IHdpbmRvdy5taXhpbjsKCn0pKHdpbmRvdy5QbGF0Zm9ybSk7Ci8vIENvcHlyaWdodCAyMDExIEdvb2dsZSBJbmMuCi8vCi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwovLyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCi8vIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAovLwovLyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCi8vCi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKLy8gZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKLy8gV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCi8vIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKLy8gbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCgooZnVuY3Rpb24oc2NvcGUpIHsKCiAgJ3VzZSBzdHJpY3QnOwoKICAvLyBwb2x5ZmlsbCBET01Ub2tlbkxpc3QKICAvLyAqIGFkZC9yZW1vdmU6IGFsbG93IHRoZXNlIG1ldGhvZHMgdG8gdGFrZSBtdWx0aXBsZSBjbGFzc05hbWVzCiAgLy8gKiB0b2dnbGU6IGFkZCBhIDJuZCBhcmd1bWVudCB3aGljaCBmb3JjZXMgdGhlIGdpdmVuIHN0YXRlIHJhdGhlcgogIC8vICB0aGFuIHRvZ2dsaW5nLgoKICB2YXIgYWRkID0gRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5hZGQ7CiAgdmFyIHJlbW92ZSA9IERPTVRva2VuTGlzdC5wcm90b3R5cGUucmVtb3ZlOwogIERPTVRva2VuTGlzdC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBhZGQuY2FsbCh0aGlzLCBhcmd1bWVudHNbaV0pOwogICAgfQogIH07CiAgRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlbW92ZS5jYWxsKHRoaXMsIGFyZ3VtZW50c1tpXSk7CiAgICB9CiAgfTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLnRvZ2dsZSA9IGZ1bmN0aW9uKG5hbWUsIGJvb2wpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgYm9vbCA9ICF0aGlzLmNvbnRhaW5zKG5hbWUpOwogICAgfQogICAgYm9vbCA/IHRoaXMuYWRkKG5hbWUpIDogdGhpcy5yZW1vdmUobmFtZSk7CiAgfTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLnN3aXRjaCA9IGZ1bmN0aW9uKG9sZE5hbWUsIG5ld05hbWUpIHsKICAgIG9sZE5hbWUgJiYgdGhpcy5yZW1vdmUob2xkTmFtZSk7CiAgICBuZXdOYW1lICYmIHRoaXMuYWRkKG5ld05hbWUpOwogIH07CiAgCiAgLy8gbWFrZSBmb3JFYWNoIHdvcmsgb24gTm9kZUxpc3QKCiAgTm9kZUxpc3QucHJvdG90eXBlLmZvckVhY2ggPSBmdW5jdGlvbihjYiwgY29udGV4dCkgewogICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcykuZm9yRWFjaChjYiwgY29udGV4dCk7CiAgfTsKCiAgSFRNTENvbGxlY3Rpb24ucHJvdG90eXBlLmZvckVhY2ggPSBmdW5jdGlvbihjYiwgY29udGV4dCkgewogICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcykuZm9yRWFjaChjYiwgY29udGV4dCk7CiAgfTsKCiAgLy8gcG9seWZpbGwgcGVyZm9ybWFuY2Uubm93CgogIGlmICghd2luZG93LnBlcmZvcm1hbmNlKSB7CiAgICB2YXIgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgLy8gb25seSBhdCBtaWxsaXNlY29uZCBwcmVjaXNpb24KICAgIHdpbmRvdy5wZXJmb3JtYW5jZSA9IHtub3c6IGZ1bmN0aW9uKCl7IHJldHVybiBEYXRlLm5vdygpIC0gc3RhcnQgfX07CiAgfQoKICAvLyBwb2x5ZmlsbCBmb3IgcmVxdWVzdEFuaW1hdGlvbkZyYW1lCgogIGlmICghd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSkgewogICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IChmdW5jdGlvbigpIHsKICAgICAgdmFyIG5hdGl2ZVJhZiA9IHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICB3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICAgICAgcmV0dXJuIG5hdGl2ZVJhZiA/CiAgICAgICAgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVSYWYoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKHBlcmZvcm1hbmNlLm5vdygpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gOgogICAgICAgIGZ1bmN0aW9uKCBjYWxsYmFjayApewogICAgICAgICAgcmV0dXJuIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxMDAwIC8gNjApOwogICAgICAgIH07CiAgICB9KSgpOwogIH0KCiAgaWYgKCF3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpIHsKICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IChmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICB3aW5kb3cud2Via2l0Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICB3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICBmdW5jdGlvbihpZCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KGlkKTsKICAgICAgICB9OwogICAgfSkoKTsKICB9CgogIC8vIHV0aWxpdHkKCiAgZnVuY3Rpb24gY3JlYXRlRE9NKGluVGFnT3JOb2RlLCBpbkhUTUwsIGluQXR0cnMpIHsKICAgIHZhciBkb20gPSB0eXBlb2YgaW5UYWdPck5vZGUgPT0gJ3N0cmluZycgPyAKICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGluVGFnT3JOb2RlKSA6IGluVGFnT3JOb2RlLmNsb25lTm9kZSh0cnVlKTsKICAgIGRvbS5pbm5lckhUTUwgPSBpbkhUTUw7CiAgICBpZiAoaW5BdHRycykgewogICAgICBmb3IgKHZhciBuIGluIGluQXR0cnMpIHsKICAgICAgICBkb20uc2V0QXR0cmlidXRlKG4sIGluQXR0cnNbbl0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZG9tOwogIH0KCiAgLy8gZXhwb3J0cwoKICBzY29wZS5jcmVhdGVET00gPSBjcmVhdGVET007Cgp9KSh3aW5kb3cuUGxhdGZvcm0pOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIHBvb3IgbWFuJ3MgYWRhcHRlciBmb3IgdGVtcGxhdGUuY29udGVudCBvbiB2YXJpb3VzIHBsYXRmb3JtIHNjZW5hcmlvcwp3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gd2luZG93LnRlbXBsYXRlQ29udGVudCB8fCBmdW5jdGlvbihpblRlbXBsYXRlKSB7CiAgcmV0dXJuIGluVGVtcGxhdGUuY29udGVudDsKfTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkhUTUxJbXBvcnRzID0ge2ZsYWdzOnt9fTsKfQoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IHJlcHJlc2VudHMgYSBwcmltYXJ5IGRvY3VtZW50ICh0aGUgYXJndW1lbnQgdG8gJ3BhcnNlJykKLy8gYXQgdGhlIHJvb3Qgb2YgYSB0cmVlIG9mIGRvY3VtZW50cwoKdmFyIGltcG9ydGVyID0gewogIGRvY3VtZW50czoge30sCiAgY2FjaGU6IHt9LAogIHByZWxvYWRTZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdzY3JpcHRbc3JjXScsCiAgICAnbGlua1tyZWw9c3R5bGVzaGVldF0nCiAgXS5qb2luKCcsJyksCiAgbG9hZDogZnVuY3Rpb24oaW5Eb2N1bWVudCwgaW5OZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IG5ldyBMb2FkZXIoaW1wb3J0ZXIubG9hZGVkLCBpbk5leHQpOwogICAgLy8gYWxpYXMgdGhlIGxvYWRlciBjYWNoZSAoZm9yIGRlYnVnZ2luZykKICAgIGxvYWRlci5jYWNoZSA9IGltcG9ydGVyLmNhY2hlOwogICAgLy8gYWRkIG5vZGVzIGZyb20gZG9jdW1lbnQgaW50byBsb2FkZXIgcXVldWUKICAgIGltcG9ydGVyLnByZWxvYWQoaW5Eb2N1bWVudCk7CiAgfSwKICBwcmVsb2FkOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICAvLyBhbGwgcHJlbG9hZGFibGUgbm9kZXMgaW4gaW5Eb2N1bWVudAogICAgdmFyIG5vZGVzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydGVyLnByZWxvYWRTZWxlY3RvcnMpOwogICAgLy8gb25seSBsb2FkIGltcG9ydHMgZnJvbSB0aGUgbWFpbiBkb2N1bWVudAogICAgLy8gVE9ETyhzam1pbGVzKTogZG8gdGhpcyBieSBhbHRlcmluZyB0aGUgc2VsZWN0b3IgbGlzdCBpbnN0ZWFkCiAgICBpZiAoaW5Eb2N1bWVudCA9PT0gZG9jdW1lbnQpIHsKICAgICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICByZXR1cm4gaXNEb2N1bWVudExpbmsobik7CiAgICAgIH0pOwogICAgfQogICAgLy8gYWRkIHRoZXNlIG5vZGVzIHRvIGxvYWRlcidzIHF1ZXVlCiAgICBsb2FkZXIuYWRkTm9kZXMobm9kZXMpOwogIH0sCiAgbG9hZGVkOiBmdW5jdGlvbihpblVybCwgaW5FbHQsIGluUmVzb3VyY2UpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhpbkVsdCkpIHsKICAgICAgdmFyIGRvY3VtZW50ID0gaW1wb3J0ZXIuZG9jdW1lbnRzW2luVXJsXTsKICAgICAgLy8gaWYgd2UndmUgbmV2ZXIgc2VlbiBhIGRvY3VtZW50IGF0IHRoaXMgdXJsCiAgICAgIGlmICghZG9jdW1lbnQpIHsKICAgICAgICAvLyBnZW5lcmF0ZSBhbiBIVE1MRG9jdW1lbnQgZnJvbSBkYXRhCiAgICAgICAgZG9jdW1lbnQgPSBtYWtlRG9jdW1lbnQoaW5SZXNvdXJjZSwgaW5VcmwpOwogICAgICAgIC8vIHJlc29sdmUgcmVzb3VyY2UgcGF0aHMgcmVsYXRpdmUgdG8gaG9zdCBkb2N1bWVudAogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKGRvY3VtZW50KTsKICAgICAgICAvLyBjYWNoZSBkb2N1bWVudAogICAgICAgIGltcG9ydGVyLmRvY3VtZW50c1tpblVybF0gPSBkb2N1bWVudDsKICAgICAgICAvLyBhZGQgbm9kZXMgZnJvbSB0aGlzIGRvY3VtZW50IHRvIHRoZSBsb2FkZXIgcXVldWUKICAgICAgICBpbXBvcnRlci5wcmVsb2FkKGRvY3VtZW50KTsKICAgICAgfQogICAgICAvLyBzdG9yZSBkb2N1bWVudCByZXNvdXJjZQogICAgICBpbkVsdC5jb250ZW50ID0gaW5FbHQuX19yZXNvdXJjZSA9IGRvY3VtZW50OwogICAgfSBlbHNlIHsKICAgICAgaW5FbHQuX19yZXNvdXJjZSA9IGluUmVzb3VyY2U7CiAgICAgIC8vIHJlc29sdmUgc3R5bGVzaGVldCByZXNvdXJjZSBwYXRocyByZWxhdGl2ZSB0byBob3N0IGRvY3VtZW50CiAgICAgIGlmIChpc1N0eWxlc2hlZXRMaW5rKGluRWx0KSkgewogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0KGluRWx0KTsKICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChpbkVsdCwgSU1QT1JUX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzU3R5bGVzaGVldExpbmsoaW5FbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGluRWx0LCAnc3R5bGVzaGVldCcpOwp9CgpmdW5jdGlvbiBpc0xpbmtSZWwoaW5FbHQsIGluUmVsKSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJyAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBpblJlbCk7Cn0KCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGluRWx0KSB7CiAgcmV0dXJuIGluRWx0Lm93bmVyRG9jdW1lbnQgPT09IGRvY3VtZW50IHx8CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgIGluRWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIG1ha2VEb2N1bWVudChpbkhUTUwsIGluVXJsKSB7CiAgLy8gY3JlYXRlIGEgbmV3IEhUTUwgZG9jdW1lbnQKICB2YXIgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KElNUE9SVF9MSU5LX1RZUEUpOwogIC8vIGNhY2hlIHRoZSBuZXcgZG9jdW1lbnQncyBzb3VyY2UgdXJsCiAgZG9jLl9VUkwgPSBpblVybDsKICAvLyBlc3RhYmxpc2ggYSByZWxhdGl2ZSBwYXRoIHZpYSA8YmFzZT4KICB2YXIgYmFzZSA9IGRvYy5jcmVhdGVFbGVtZW50KCdiYXNlJyk7CiAgYmFzZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBkb2N1bWVudC5iYXNlVVJJKTsKICBkb2MuaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKICAvLyBpbnN0YWxsIGh0bWwKICBkb2MuYm9keS5pbm5lckhUTUwgPSBpbkhUTUw7CiAgcmV0dXJuIGRvYzsKfQoKdmFyIGxvYWRlcjsKCnZhciBMb2FkZXIgPSBmdW5jdGlvbihpbk9uTG9hZCwgaW5PbkNvbXBsZXRlKSB7CiAgdGhpcy5vbmxvYWQgPSBpbk9uTG9hZDsKICB0aGlzLm9uY29tcGxldGUgPSBpbk9uQ29tcGxldGU7CiAgdGhpcy5pbmZsaWdodCA9IDA7CiAgdGhpcy5wZW5kaW5nID0ge307CiAgdGhpcy5jYWNoZSA9IHt9Owp9OwoKTG9hZGVyLnByb3RvdHlwZSA9IHsKICBhZGROb2RlczogZnVuY3Rpb24oaW5Ob2RlcykgewogICAgLy8gbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyB0byBjb21wbGV0ZQogICAgdGhpcy5pbmZsaWdodCArPSBpbk5vZGVzLmxlbmd0aDsKICAgIC8vIGNvbW1lbmNlIHRyYW5zYWN0aW9ucwogICAgZm9yRWFjaChpbk5vZGVzLCB0aGlzLnJlcXVpcmUsIHRoaXMpOwogICAgLy8gYW55dGhpbmcgdG8gZG8/CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgcmVxdWlyZTogZnVuY3Rpb24oaW5FbHQpIHsKICAgIHZhciB1cmwgPSBwYXRoLm5vZGVVcmwoaW5FbHQpOwogICAgLy8gVE9ETyhzam1pbGVzKTogYWQtaG9jCiAgICBpbkVsdC5fX25vZGVVcmwgPSB1cmw7CiAgICAvLyBkZWR1cGxpY2F0aW9uCiAgICBpZiAoIXRoaXMuZGVkdXBlKHVybCwgaW5FbHQpKSB7CiAgICAgIC8vIGZldGNoIHRoaXMgcmVzb3VyY2UKICAgICAgdGhpcy5mZXRjaCh1cmwsIGluRWx0KTsKICAgIH0KICB9LAogIGRlZHVwZTogZnVuY3Rpb24oaW5VcmwsIGluRWx0KSB7CiAgICBpZiAodGhpcy5wZW5kaW5nW2luVXJsXSkgewogICAgICAvLyBhZGQgdG8gbGlzdCBvZiBub2RlcyB3YWl0aW5nIGZvciBpblVybAogICAgICB0aGlzLnBlbmRpbmdbaW5VcmxdLnB1c2goaW5FbHQpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKHRoaXMuY2FjaGVbaW5VcmxdKSB7CiAgICAgIC8vIGNvbXBsZXRlIGxvYWQgdXNpbmcgY2FjaGUgZGF0YQogICAgICB0aGlzLm9ubG9hZChpblVybCwgaW5FbHQsIGxvYWRlci5jYWNoZVtpblVybF0pOwogICAgICAvLyBmaW5pc2hlZCB0aGlzIHRyYW5zYWN0aW9uCiAgICAgIHRoaXMudGFpbCgpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gZmlyc3Qgbm9kZSB3YWl0aW5nIGZvciBpblVybAogICAgdGhpcy5wZW5kaW5nW2luVXJsXSA9IFtpbkVsdF07CiAgICAvLyBuZWVkIGZldGNoIChub3QgYSBkdXBlKQogICAgcmV0dXJuIGZhbHNlOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCkgewogICAgeGhyLmxvYWQoaW5VcmwsIGZ1bmN0aW9uKGVyciwgcmVzb3VyY2UpIHsKICAgICAgdGhpcy5yZWNlaXZlKGluVXJsLCBpbkVsdCwgZXJyLCByZXNvdXJjZSk7CiAgICB9LmJpbmQodGhpcykpOwogIH0sCiAgcmVjZWl2ZTogZnVuY3Rpb24oaW5VcmwsIGluRWx0LCBpbkVyciwgaW5SZXNvdXJjZSkgewogICAgaWYgKCFpbkVycikgewogICAgICBsb2FkZXIuY2FjaGVbaW5VcmxdID0gaW5SZXNvdXJjZTsKICAgIH0KICAgIGxvYWRlci5wZW5kaW5nW2luVXJsXS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKCFpbkVycikgewogICAgICAgIHRoaXMub25sb2FkKGluVXJsLCBlLCBpblJlc291cmNlKTsKICAgICAgfQogICAgICB0aGlzLnRhaWwoKTsKICAgIH0sIHRoaXMpOwogICAgbG9hZGVyLnBlbmRpbmdbaW5VcmxdID0gbnVsbDsKICB9LAogIHRhaWw6IGZ1bmN0aW9uKCkgewogICAgLS10aGlzLmluZmxpZ2h0OwogICAgdGhpcy5jaGVja0RvbmUoKTsKICB9LAogIGNoZWNrRG9uZTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuaW5mbGlnaHQpIHsKICAgICAgdGhpcy5vbmNvbXBsZXRlKCk7CiAgICB9CiAgfQp9OwoKdmFyIHBhdGggPSB7CiAgbm9kZVVybDogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5yZXNvbHZlVXJsKHBhdGguZ2V0RG9jdW1lbnRVcmwoZG9jdW1lbnQpLCBwYXRoLmhyZWZPclNyYyhpbk5vZGUpKTsKICB9LAogIGhyZWZPclNyYzogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gaW5Ob2RlLmdldEF0dHJpYnV0ZSgiaHJlZiIpIHx8IGluTm9kZS5nZXRBdHRyaWJ1dGUoInNyYyIpOwogIH0sCiAgZG9jdW1lbnRVcmxGcm9tTm9kZTogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICB2YXIgdXJsID0gcGF0aC5nZXREb2N1bWVudFVybChpbk5vZGUub3duZXJEb2N1bWVudCk7CiAgICAvLyB0YWtlIG9ubHkgdGhlIGxlZnQgc2lkZSBpZiB0aGVyZSBpcyBhICMKICAgIHVybCA9IHVybC5zcGxpdCgnIycpWzBdOwogICAgcmV0dXJuIHVybDsKICB9LAogIGdldERvY3VtZW50VXJsOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICByZXR1cm4gaW5Eb2N1bWVudCAmJgogICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgICAgIChpbkRvY3VtZW50Ll9VUkwgfHwgKGluRG9jdW1lbnQuaW1wbCAmJiBpbkRvY3VtZW50LmltcGwuX1VSTCkKICAgICAgICAgICAgfHwgaW5Eb2N1bWVudC5iYXNlVVJJIHx8IGluRG9jdW1lbnQuVVJMKQogICAgICAgICAgICAgICAgfHwgJyc7CiAgfSwKICByZXNvbHZlVXJsOiBmdW5jdGlvbihpbkJhc2VVcmwsIGluVXJsLCBpblJlbGF0aXZlVG9Eb2N1bWVudCkgewogICAgaWYgKHRoaXMuaXNBYnNVcmwoaW5VcmwpKSB7CiAgICAgIHJldHVybiBpblVybDsKICAgIH0KICAgIHZhciB1cmwgPSB0aGlzLmNvbXByZXNzVXJsKHRoaXMudXJsVG9QYXRoKGluQmFzZVVybCkgKyBpblVybCk7CiAgICBpZiAoaW5SZWxhdGl2ZVRvRG9jdW1lbnQpIHsKICAgICAgdXJsID0gcGF0aC5tYWtlUmVsUGF0aChwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KSwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfSwKICBpc0Fic1VybDogZnVuY3Rpb24oaW5VcmwpIHsKICAgIHJldHVybiAvKF5kYXRhOil8KF5odHRwW3NdPzopfCheXC8pLy50ZXN0KGluVXJsKTsKICB9LAogIHVybFRvUGF0aDogZnVuY3Rpb24oaW5CYXNlVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpbkJhc2VVcmwuc3BsaXQoIi8iKTsKICAgIHBhcnRzLnBvcCgpOwogICAgcGFydHMucHVzaCgnJyk7CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgY29tcHJlc3NVcmw6IGZ1bmN0aW9uKGluVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpblVybC5zcGxpdCgiLyIpOwogICAgZm9yICh2YXIgaT0wLCBwOyBpPHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHAgPSBwYXJ0c1tpXTsKICAgICAgaWYgKHAgPT09ICIuLiIpIHsKICAgICAgICBwYXJ0cy5zcGxpY2UoaS0xLCAyKTsKICAgICAgICBpIC09IDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICAvLyBtYWtlIGEgcmVsYXRpdmUgcGF0aCBmcm9tIHNvdXJjZSB0byB0YXJnZXQKICBtYWtlUmVsUGF0aDogZnVuY3Rpb24oaW5Tb3VyY2UsIGluVGFyZ2V0KSB7CiAgICB2YXIgcywgdDsKICAgIHMgPSB0aGlzLmNvbXByZXNzVXJsKGluU291cmNlKS5zcGxpdCgiLyIpOwogICAgdCA9IHRoaXMuY29tcHJlc3NVcmwoaW5UYXJnZXQpLnNwbGl0KCIvIik7CiAgICB3aGlsZSAocy5sZW5ndGggJiYgc1swXSA9PT0gdFswXSl7CiAgICAgIHMuc2hpZnQoKTsKICAgICAgdC5zaGlmdCgpOwogICAgfQogICAgZm9yKHZhciBpID0gMCwgbCA9IHMubGVuZ3RoLTE7IGkgPCBsOyBpKyspIHsKICAgICAgdC51bnNoaWZ0KCIuLiIpOwogICAgfQogICAgdmFyIHIgPSB0LmpvaW4oIi8iKTsKICAgIHJldHVybiByOwogIH0sCiAgcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihpblJvb3QpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUoaW5Sb290LmJvZHkpOwogICAgLy8gVE9ETyhzb3J2ZWxsKTogTURWIFBvbHlmaWxsIEludHJ1c2lvbgogICAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICAgIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKGluUm9vdCk7CiAgICB9CiAgICB2YXIgbm9kZSA9IGluUm9vdC5ib2R5OwogICAgcGF0aC5fcmVzb2x2ZVBhdGhzSW5IVE1MKG5vZGUsIGRvY1VybCk7CiAgfSwKICBfcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICBwYXRoLnJlc29sdmVBdHRyaWJ1dGVzKGluUm9vdCwgaW5VcmwpOwogICAgcGF0aC5yZXNvbHZlU3R5bGVFbHRzKGluUm9vdCwgaW5VcmwpOwogICAgLy8gaGFuZGxlIHRlbXBsYXRlcywgaWYgc3VwcG9ydGVkCiAgICBpZiAod2luZG93LnRlbXBsYXRlQ29udGVudCkgewogICAgICB2YXIgdGVtcGxhdGVzID0gaW5Sb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RlbXBsYXRlJyk7CiAgICAgIGlmICh0ZW1wbGF0ZXMpIHsKICAgICAgICBmb3JFYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24odCkgewogICAgICAgICAgcGF0aC5fcmVzb2x2ZVBhdGhzSW5IVE1MKHRlbXBsYXRlQ29udGVudCh0KSwgaW5VcmwpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSwKICByZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQ6IGZ1bmN0aW9uKGluU2hlZXQpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLm5vZGVVcmwoaW5TaGVldCk7CiAgICBpblNoZWV0Ll9fcmVzb3VyY2UgPSBwYXRoLnJlc29sdmVDc3NUZXh0KGluU2hlZXQuX19yZXNvdXJjZSwgZG9jVXJsKTsKICB9LAogIHJlc29sdmVTdHlsZUVsdHM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIHZhciBzdHlsZXMgPSBpblJvb3QucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTsKICAgIGlmIChzdHlsZXMpIHsKICAgICAgZm9yRWFjaChzdHlsZXMsIGZ1bmN0aW9uKHN0eWxlKSB7CiAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBwYXRoLnJlc29sdmVDc3NUZXh0KHN0eWxlLnRleHRDb250ZW50LCBpblVybCk7CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZUNzc1RleHQ6IGZ1bmN0aW9uKGluQ3NzVGV4dCwgaW5CYXNlVXJsKSB7CiAgICByZXR1cm4gaW5Dc3NUZXh0LnJlcGxhY2UoL3VybFwoW14pXSpcKS9nLCBmdW5jdGlvbihpbk1hdGNoKSB7CiAgICAgIC8vIGZpbmQgdGhlIHVybCBwYXRoLCBpZ25vcmUgcXVvdGVzIGluIHVybCBzdHJpbmcKICAgICAgdmFyIHVybFBhdGggPSBpbk1hdGNoLnJlcGxhY2UoL1siJ10vZywgIiIpLnNsaWNlKDQsIC0xKTsKICAgICAgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVVybChpbkJhc2VVcmwsIHVybFBhdGgsIHRydWUpOwogICAgICByZXR1cm4gInVybCgiICsgdXJsUGF0aCArICIpIjsKICAgIH0pOwogIH0sCiAgcmVzb2x2ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIC8vIHNlYXJjaCBmb3IgYXR0cmlidXRlcyB0aGF0IGhvc3QgdXJscwogICAgdmFyIG5vZGVzID0gaW5Sb290ICYmIGluUm9vdC5xdWVyeVNlbGVjdG9yQWxsKFVSTF9BVFRSU19TRUxFQ1RPUik7CiAgICBpZiAobm9kZXMpIHsKICAgICAgZm9yRWFjaChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHRoaXMucmVzb2x2ZU5vZGVBdHRyaWJ1dGVzKG4sIGluVXJsKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKICByZXNvbHZlTm9kZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluTm9kZSwgaW5VcmwpIHsKICAgIFVSTF9BVFRSUy5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgdmFyIGF0dHIgPSBpbk5vZGUuYXR0cmlidXRlc1t2XTsKICAgICAgaWYgKGF0dHIgJiYgYXR0ci52YWx1ZSAmJgogICAgICAgICAoYXR0ci52YWx1ZS5zZWFyY2goVVJMX1RFTVBMQVRFX1NFQVJDSCkgPCAwKSkgewogICAgICAgIHZhciB1cmxQYXRoID0gcGF0aC5yZXNvbHZlVXJsKGluVXJsLCBhdHRyLnZhbHVlLCB0cnVlKTsKICAgICAgICBhdHRyLnZhbHVlID0gdXJsUGF0aDsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKdmFyIFVSTF9BVFRSUyA9IFsnaHJlZicsICdzcmMnLCAnYWN0aW9uJ107CnZhciBVUkxfQVRUUlNfU0VMRUNUT1IgPSAnWycgKyBVUkxfQVRUUlMuam9pbignXSxbJykgKyAnXSc7CnZhciBVUkxfVEVNUExBVEVfU0VBUkNIID0gJ3t7Lip9fSc7Cgp2YXIgeGhyID0gewogIGFzeW5jOiB0cnVlLAogIG9rOiBmdW5jdGlvbihpblJlcXVlc3QpIHsKICAgIHJldHVybiAoaW5SZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgaW5SZXF1ZXN0LnN0YXR1cyA8IDMwMCkKICAgICAgICB8fCAoaW5SZXF1ZXN0LnN0YXR1cyA9PT0gMzA0KTsKICB9LAogIGxvYWQ6IGZ1bmN0aW9uKHVybCwgbmV4dCwgbmV4dENvbnRleHQpIHsKICAgIHZhciByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICBpZiAoc2NvcGUuZmxhZ3MuZGVidWcgfHwgc2NvcGUuZmxhZ3MuYnVzdCkgewogICAgICB1cmwgKz0gJz8nICsgTWF0aC5yYW5kb20oKTsKICAgIH0KICAgIHJlcXVlc3Qub3BlbignR0VUJywgdXJsLCB4aHIuYXN5bmMpOwogICAgcmVxdWVzdC5hZGRFdmVudExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgZnVuY3Rpb24oZSkgewogICAgICBpZiAocmVxdWVzdC5yZWFkeVN0YXRlID09PSA0KSB7CiAgICAgICAgbmV4dC5jYWxsKG5leHRDb250ZXh0LCAheGhyLm9rKHJlcXVlc3QpICYmIHJlcXVlc3QsCiAgICAgICAgICByZXF1ZXN0LnJlc3BvbnNlLCB1cmwpOwogICAgICB9CiAgICB9KTsKICAgIHJlcXVlc3Quc2VuZCgpOwogIH0KfTsKCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCi8vIGV4cG9ydHMKCnNjb3BlLmltcG9ydGVyID0gaW1wb3J0ZXI7CnNjb3BlLmdldERvY3VtZW50VXJsID0gcGF0aC5nZXREb2N1bWVudFVybDsKCi8vIGJvb3RzdHJhcAoKLy8gSUUgc2hpbSBmb3IgQ3VzdG9tRXZlbnQKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGZ1bmN0aW9uKCkgewogIC8vIHByZWxvYWQgZG9jdW1lbnQgcmVzb3VyY2UgdHJlZXMKICBpbXBvcnRlci5sb2FkKGRvY3VtZW50LCBmdW5jdGlvbigpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTSBwb2x5ZmlsbCBwb2xsdXRpb24KICAgIHZhciBkb2MgPSB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwgPyBTaGFkb3dET01Qb2x5ZmlsbC53cmFwKGRvY3VtZW50KQogICAgICAgIDogZG9jdW1lbnQ7CiAgICBIVE1MSW1wb3J0cy5yZWFkeVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIC8vIHNlbmQgSFRNTEltcG9ydHNMb2FkZWQgd2hlbiBmaW5pc2hlZAogICAgZG9jLmJvZHkuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdIVE1MSW1wb3J0c0xvYWRlZCcsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSk7Cn0pOwoKfSkod2luZG93LkhUTUxJbXBvcnRzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEyIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVyZW5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKGdsb2JhbCkgewoKICB2YXIgcmVnaXN0cmF0aW9uc1RhYmxlID0gbmV3IFNpZGVUYWJsZSgpOwoKICAvLyBXZSB1c2Ugc2V0SW1tZWRpYXRlIG9yIHBvc3RNZXNzYWdlIGZvciBvdXIgZnV0dXJlIGNhbGxiYWNrLgogIHZhciBzZXRJbW1lZGlhdGUgPSB3aW5kb3cubXNTZXRJbW1lZGlhdGU7CgogIC8vIFVzZSBwb3N0IG1lc3NhZ2UgdG8gZW11bGF0ZSBzZXRJbW1lZGlhdGUuCiAgaWYgKCFzZXRJbW1lZGlhdGUpIHsKICAgIHZhciBzZXRJbW1lZGlhdGVRdWV1ZSA9IFtdOwogICAgdmFyIHNlbnRpbmVsID0gU3RyaW5nKE1hdGgucmFuZG9tKCkpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChlLmRhdGEgPT09IHNlbnRpbmVsKSB7CiAgICAgICAgdmFyIHF1ZXVlID0gc2V0SW1tZWRpYXRlUXVldWU7CiAgICAgICAgc2V0SW1tZWRpYXRlUXVldWUgPSBbXTsKICAgICAgICBxdWV1ZS5mb3JFYWNoKGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICAgIGZ1bmMoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICBzZXRJbW1lZGlhdGUgPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgIHNldEltbWVkaWF0ZVF1ZXVlLnB1c2goZnVuYyk7CiAgICAgIHdpbmRvdy5wb3N0TWVzc2FnZShzZW50aW5lbCwgJyonKTsKICAgIH07CiAgfQoKICAvLyBUaGlzIGlzIHVzZWQgdG8gZW5zdXJlIHRoYXQgd2UgbmV2ZXIgc2NoZWR1bGUgMiBjYWxsYXMgdG8gc2V0SW1tZWRpYXRlCiAgdmFyIGlzU2NoZWR1bGVkID0gZmFsc2U7CgogIC8vIEtlZXAgdHJhY2sgb2Ygb2JzZXJ2ZXJzIHRoYXQgbmVlZHMgdG8gYmUgbm90aWZpZWQgbmV4dCB0aW1lLgogIHZhciBzY2hlZHVsZWRPYnNlcnZlcnMgPSBbXTsKCiAgLyoqCiAgICogU2NoZWR1bGVzIHxkaXNwYXRjaENhbGxiYWNrfCB0byBiZSBjYWxsZWQgaW4gdGhlIGZ1dHVyZS4KICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJ9IG9ic2VydmVyCiAgICovCiAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFjayhvYnNlcnZlcikgewogICAgc2NoZWR1bGVkT2JzZXJ2ZXJzLnB1c2gob2JzZXJ2ZXIpOwogICAgaWYgKCFpc1NjaGVkdWxlZCkgewogICAgICBpc1NjaGVkdWxlZCA9IHRydWU7CiAgICAgIHNldEltbWVkaWF0ZShkaXNwYXRjaENhbGxiYWNrcyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB3cmFwSWZOZWVkZWQobm9kZSkgewogICAgcmV0dXJuIHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCAmJgogICAgICAgIHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbC53cmFwSWZOZWVkZWQobm9kZSkgfHwKICAgICAgICBub2RlOwogIH0KCiAgZnVuY3Rpb24gZGlzcGF0Y2hDYWxsYmFja3MoKSB7CiAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jbXV0YXRpb24tb2JzZXJ2ZXJzCgogICAgaXNTY2hlZHVsZWQgPSBmYWxzZTsgLy8gVXNlZCB0byBhbGxvdyBhIG5ldyBzZXRJbW1lZGlhdGUgY2FsbCBhYm92ZS4KCiAgICB2YXIgb2JzZXJ2ZXJzID0gc2NoZWR1bGVkT2JzZXJ2ZXJzOwogICAgc2NoZWR1bGVkT2JzZXJ2ZXJzID0gW107CiAgICAvLyBTb3J0IG9ic2VydmVycyBiYXNlZCBvbiB0aGVpciBjcmVhdGlvbiBVSUQgKGluY3JlbWVudGFsKS4KICAgIG9ic2VydmVycy5zb3J0KGZ1bmN0aW9uKG8xLCBvMikgewogICAgICByZXR1cm4gbzEudWlkXyAtIG8yLnVpZF87CiAgICB9KTsKCiAgICB2YXIgYW55Tm9uRW1wdHkgPSBmYWxzZTsKICAgIG9ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uKG9ic2VydmVyKSB7CgogICAgICAvLyAyLjEsIDIuMgogICAgICB2YXIgcXVldWUgPSBvYnNlcnZlci50YWtlUmVjb3JkcygpOwogICAgICAvLyAyLjMuIFJlbW92ZSBhbGwgdHJhbnNpZW50IHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzIHdob3NlIG9ic2VydmVyIGlzIG1vLgogICAgICByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnNGb3Iob2JzZXJ2ZXIpOwoKICAgICAgLy8gMi40CiAgICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICBvYnNlcnZlci5jYWxsYmFja18ocXVldWUsIG9ic2VydmVyKTsKICAgICAgICBhbnlOb25FbXB0eSA9IHRydWU7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIDMuCiAgICBpZiAoYW55Tm9uRW1wdHkpCiAgICAgIGRpc3BhdGNoQ2FsbGJhY2tzKCk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnNGb3Iob2JzZXJ2ZXIpIHsKICAgIG9ic2VydmVyLm5vZGVzXy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmV0dXJuOwogICAgICByZWdpc3RyYXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVnaXN0cmF0aW9uKSB7CiAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbi5vYnNlcnZlciA9PT0gb2JzZXJ2ZXIpCiAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzKCk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgZm9yIHRoZSAiRm9yIGVhY2ggcmVnaXN0ZXJlZCBvYnNlcnZlciBvYnNlcnZlciAod2l0aAogICAqIG9ic2VydmVyJ3Mgb3B0aW9ucyBhcyBvcHRpb25zKSBpbiB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzLAogICAqIHJ1biB0aGVzZSBzdWJzdGVwczoiIGFuZCB0aGUgIkZvciBlYWNoIGFuY2VzdG9yIGFuY2VzdG9yIG9mIHRhcmdldCwgYW5kIGZvcgogICAqIGVhY2ggcmVnaXN0ZXJlZCBvYnNlcnZlciBvYnNlcnZlciAod2l0aCBvcHRpb25zIG9wdGlvbnMpIGluIGFuY2VzdG9yJ3MgbGlzdAogICAqIG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzLCBydW4gdGhlc2Ugc3Vic3RlcHM6IiBwYXJ0IG9mIHRoZSBhbGdvcml0aG1zLiBUaGUKICAgKiB8b3B0aW9ucy5zdWJ0cmVlfCBpcyBjaGVja2VkIHRvIGVuc3VyZSB0aGF0IHRoZSBjYWxsYmFjayBpcyBjYWxsZWQKICAgKiBjb3JyZWN0bHkuCiAgICoKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBwYXJhbSB7ZnVuY3Rpb24oTXV0YXRpb25PYnNlcnZlckluaXQpOk11dGF0aW9uUmVjb3JkfSBjYWxsYmFjawogICAqLwogIGZ1bmN0aW9uIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGNhbGxiYWNrKSB7CiAgICBmb3IgKHZhciBub2RlID0gdGFyZ2V0OyBub2RlOyBub2RlID0gbm9kZS5wYXJlbnROb2RlKSB7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKCiAgICAgIGlmIChyZWdpc3RyYXRpb25zKSB7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tqXTsKICAgICAgICAgIHZhciBvcHRpb25zID0gcmVnaXN0cmF0aW9uLm9wdGlvbnM7CgogICAgICAgICAgLy8gT25seSB0YXJnZXQgaWdub3JlcyBzdWJ0cmVlLgogICAgICAgICAgaWYgKG5vZGUgIT09IHRhcmdldCAmJiAhb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICB2YXIgcmVjb3JkID0gY2FsbGJhY2sob3B0aW9ucyk7CiAgICAgICAgICBpZiAocmVjb3JkKQogICAgICAgICAgICByZWdpc3RyYXRpb24uZW5xdWV1ZShyZWNvcmQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgdmFyIHVpZENvdW50ZXIgPSAwOwoKICAvKioKICAgKiBUaGUgY2xhc3MgdGhhdCBtYXBzIHRvIHRoZSBET00gTXV0YXRpb25PYnNlcnZlciBpbnRlcmZhY2UuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2suCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gSnNNdXRhdGlvbk9ic2VydmVyKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNhbGxiYWNrXyA9IGNhbGxiYWNrOwogICAgdGhpcy5ub2Rlc18gPSBbXTsKICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgIHRoaXMudWlkXyA9ICsrdWlkQ291bnRlcjsKICB9CgogIEpzTXV0YXRpb25PYnNlcnZlci5wcm90b3R5cGUgPSB7CiAgICBvYnNlcnZlOiBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbnMpIHsKICAgICAgdGFyZ2V0ID0gd3JhcElmTmVlZGVkKHRhcmdldCk7CgogICAgICAvLyAxLjEKICAgICAgaWYgKCFvcHRpb25zLmNoaWxkTGlzdCAmJiAhb3B0aW9ucy5hdHRyaWJ1dGVzICYmICFvcHRpb25zLmNoYXJhY3RlckRhdGEgfHwKCiAgICAgICAgICAvLyAxLjIKICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlT2xkVmFsdWUgJiYgIW9wdGlvbnMuYXR0cmlidXRlcyB8fAoKICAgICAgICAgIC8vIDEuMwogICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIgJiYgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIubGVuZ3RoICYmCiAgICAgICAgICAgICAgIW9wdGlvbnMuYXR0cmlidXRlcyB8fAoKICAgICAgICAgIC8vIDEuNAogICAgICAgICAgb3B0aW9ucy5jaGFyYWN0ZXJEYXRhT2xkVmFsdWUgJiYgIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSkgewoKICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoKTsKICAgICAgfQoKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KHRhcmdldCk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZWdpc3RyYXRpb25zVGFibGUuc2V0KHRhcmdldCwgcmVnaXN0cmF0aW9ucyA9IFtdKTsKCiAgICAgIC8vIDIKICAgICAgLy8gSWYgdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkIG9ic2VydmVycyBhbHJlYWR5IGluY2x1ZGVzIGEgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGggdGhlIGNvbnRleHQgb2JqZWN0LCByZXBsYWNlIHRoYXQgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlcidzIG9wdGlvbnMgd2l0aCBvcHRpb25zLgogICAgICB2YXIgcmVnaXN0cmF0aW9uOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAocmVnaXN0cmF0aW9uc1tpXS5vYnNlcnZlciA9PT0gdGhpcykgewogICAgICAgICAgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tpXTsKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVMaXN0ZW5lcnMoKTsKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5vcHRpb25zID0gb3B0aW9uczsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gMy4KICAgICAgLy8gT3RoZXJ3aXNlLCBhZGQgYSBuZXcgcmVnaXN0ZXJlZCBvYnNlcnZlciB0byB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXJzIHdpdGggdGhlIGNvbnRleHQgb2JqZWN0IGFzIHRoZSBvYnNlcnZlciBhbmQgb3B0aW9ucyBhcyB0aGUKICAgICAgLy8gb3B0aW9ucywgYW5kIGFkZCB0YXJnZXQgdG8gY29udGV4dCBvYmplY3QncyBsaXN0IG9mIG5vZGVzIG9uIHdoaWNoIGl0CiAgICAgIC8vIGlzIHJlZ2lzdGVyZWQuCiAgICAgIGlmICghcmVnaXN0cmF0aW9uKSB7CiAgICAgICAgcmVnaXN0cmF0aW9uID0gbmV3IFJlZ2lzdHJhdGlvbih0aGlzLCB0YXJnZXQsIG9wdGlvbnMpOwogICAgICAgIHJlZ2lzdHJhdGlvbnMucHVzaChyZWdpc3RyYXRpb24pOwogICAgICAgIHRoaXMubm9kZXNfLnB1c2godGFyZ2V0KTsKICAgICAgfQoKICAgICAgcmVnaXN0cmF0aW9uLmFkZExpc3RlbmVycygpOwogICAgfSwKCiAgICBkaXNjb25uZWN0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5ub2Rlc18uZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbaV07CiAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uLm9ic2VydmVyID09PSB0aGlzKSB7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgcmVnaXN0cmF0aW9ucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIC8vIEVhY2ggbm9kZSBjYW4gb25seSBoYXZlIG9uZSByZWdpc3RlcmVkIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICAvLyB0aGlzIG9ic2VydmVyLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICB9LAoKICAgIHRha2VSZWNvcmRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvcHlPZlJlY29yZHMgPSB0aGlzLnJlY29yZHNfOwogICAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICAgIHJldHVybiBjb3B5T2ZSZWNvcmRzOwogICAgfQogIH07CgogIC8qKgogICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBNdXRhdGlvblJlY29yZCh0eXBlLCB0YXJnZXQpIHsKICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMuYWRkZWROb2RlcyA9IFtdOwogICAgdGhpcy5yZW1vdmVkTm9kZXMgPSBbXTsKICAgIHRoaXMucHJldmlvdXNTaWJsaW5nID0gbnVsbDsKICAgIHRoaXMubmV4dFNpYmxpbmcgPSBudWxsOwogICAgdGhpcy5hdHRyaWJ1dGVOYW1lID0gbnVsbDsKICAgIHRoaXMuYXR0cmlidXRlTmFtZXNwYWNlID0gbnVsbDsKICAgIHRoaXMub2xkVmFsdWUgPSBudWxsOwogIH0KCiAgZnVuY3Rpb24gY29weU11dGF0aW9uUmVjb3JkKG9yaWdpbmFsKSB7CiAgICB2YXIgcmVjb3JkID0gbmV3IE11dGF0aW9uUmVjb3JkKG9yaWdpbmFsLnR5cGUsIG9yaWdpbmFsLnRhcmdldCk7CiAgICByZWNvcmQuYWRkZWROb2RlcyA9IG9yaWdpbmFsLmFkZGVkTm9kZXMuc2xpY2UoKTsKICAgIHJlY29yZC5yZW1vdmVkTm9kZXMgPSBvcmlnaW5hbC5yZW1vdmVkTm9kZXMuc2xpY2UoKTsKICAgIHJlY29yZC5wcmV2aW91c1NpYmxpbmcgPSBvcmlnaW5hbC5wcmV2aW91c1NpYmxpbmc7CiAgICByZWNvcmQubmV4dFNpYmxpbmcgPSBvcmlnaW5hbC5uZXh0U2libGluZzsKICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lID0gb3JpZ2luYWwuYXR0cmlidXRlTmFtZTsKICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBvcmlnaW5hbC5hdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICByZWNvcmQub2xkVmFsdWUgPSBvcmlnaW5hbC5vbGRWYWx1ZTsKICAgIHJldHVybiByZWNvcmQ7CiAgfTsKCiAgLy8gV2Uga2VlcCB0cmFjayBvZiB0aGUgdHdvIChwb3NzaWJseSBvbmUpIHJlY29yZHMgdXNlZCBpbiBhIHNpbmdsZSBtdXRhdGlvbi4KICB2YXIgY3VycmVudFJlY29yZCwgcmVjb3JkV2l0aE9sZFZhbHVlOwoKICAvKioKICAgKiBDcmVhdGVzIGEgcmVjb3JkIHdpdGhvdXQgfG9sZFZhbHVlfCBhbmQgY2FjaGVzIGl0IGFzIHxjdXJyZW50UmVjb3JkfCBmb3IKICAgKiBsYXRlciB1c2UuCiAgICogQHBhcmFtIHtzdHJpbmd9IG9sZFZhbHVlCiAgICogQHJldHVybiB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gZ2V0UmVjb3JkKHR5cGUsIHRhcmdldCkgewogICAgcmV0dXJuIGN1cnJlbnRSZWNvcmQgPSBuZXcgTXV0YXRpb25SZWNvcmQodHlwZSwgdGFyZ2V0KTsKICB9CgogIC8qKgogICAqIEdldHMgb3IgY3JlYXRlcyBhIHJlY29yZCB3aXRoIHxvbGRWYWx1ZXwgYmFzZWQgaW4gdGhlIHxjdXJyZW50UmVjb3JkfAogICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRWYWx1ZQogICAqIEByZXR1cm4ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSkgewogICAgaWYgKHJlY29yZFdpdGhPbGRWYWx1ZSkKICAgICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKICAgIHJlY29yZFdpdGhPbGRWYWx1ZSA9IGNvcHlNdXRhdGlvblJlY29yZChjdXJyZW50UmVjb3JkKTsKICAgIHJlY29yZFdpdGhPbGRWYWx1ZS5vbGRWYWx1ZSA9IG9sZFZhbHVlOwogICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKICB9CgogIGZ1bmN0aW9uIGNsZWFyUmVjb3JkcygpIHsKICAgIGN1cnJlbnRSZWNvcmQgPSByZWNvcmRXaXRoT2xkVmFsdWUgPSB1bmRlZmluZWQ7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSByZWNvcmQKICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSByZWNvcmQgcmVwcmVzZW50cyBhIHJlY29yZCBmcm9tIHRoZSBjdXJyZW50CiAgICogbXV0YXRpb24gZXZlbnQuCiAgICovCiAgZnVuY3Rpb24gcmVjb3JkUmVwcmVzZW50c0N1cnJlbnRNdXRhdGlvbihyZWNvcmQpIHsKICAgIHJldHVybiByZWNvcmQgPT09IHJlY29yZFdpdGhPbGRWYWx1ZSB8fCByZWNvcmQgPT09IGN1cnJlbnRSZWNvcmQ7CiAgfQoKICAvKioKICAgKiBTZWxlY3RzIHdoaWNoIHJlY29yZCwgaWYgYW55LCB0byByZXBsYWNlIHRoZSBsYXN0IHJlY29yZCBpbiB0aGUgcXVldWUuCiAgICogVGhpcyByZXR1cm5zIHxudWxsfCBpZiBubyByZWNvcmQgc2hvdWxkIGJlIHJlcGxhY2VkLgogICAqCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gbGFzdFJlY29yZAogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IG5ld1JlY29yZAogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gc2VsZWN0UmVjb3JkKGxhc3RSZWNvcmQsIG5ld1JlY29yZCkgewogICAgaWYgKGxhc3RSZWNvcmQgPT09IG5ld1JlY29yZCkKICAgICAgcmV0dXJuIGxhc3RSZWNvcmQ7CgogICAgLy8gQ2hlY2sgaWYgdGhlIHRoZSByZWNvcmQgd2UgYXJlIGFkZGluZyByZXByZXNlbnRzIHRoZSBzYW1lIHJlY29yZC4gSWYKICAgIC8vIHNvLCB3ZSBrZWVwIHRoZSBvbmUgd2l0aCB0aGUgb2xkVmFsdWUgaW4gaXQuCiAgICBpZiAocmVjb3JkV2l0aE9sZFZhbHVlICYmIHJlY29yZFJlcHJlc2VudHNDdXJyZW50TXV0YXRpb24obGFzdFJlY29yZCkpCiAgICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CgogICAgcmV0dXJuIG51bGw7CiAgfQoKICAvKioKICAgKiBDbGFzcyB1c2VkIHRvIHJlcHJlc2VudCBhIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIuCiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVyfSBvYnNlcnZlcgogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVySW5pdH0gb3B0aW9ucwogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIFJlZ2lzdHJhdGlvbihvYnNlcnZlciwgdGFyZ2V0LCBvcHRpb25zKSB7CiAgICB0aGlzLm9ic2VydmVyID0gb2JzZXJ2ZXI7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSBbXTsKICB9CgogIFJlZ2lzdHJhdGlvbi5wcm90b3R5cGUgPSB7CiAgICBlbnF1ZXVlOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLm9ic2VydmVyLnJlY29yZHNfOwogICAgICB2YXIgbGVuZ3RoID0gcmVjb3Jkcy5sZW5ndGg7CgogICAgICAvLyBUaGVyZSBhcmUgY2FzZXMgd2hlcmUgd2UgcmVwbGFjZSB0aGUgbGFzdCByZWNvcmQgd2l0aCB0aGUgbmV3IHJlY29yZC4KICAgICAgLy8gRm9yIGV4YW1wbGUgaWYgdGhlIHJlY29yZCByZXByZXNlbnRzIHRoZSBzYW1lIG11dGF0aW9uIHdlIG5lZWQgdG8gdXNlCiAgICAgIC8vIHRoZSBvbmUgd2l0aCB0aGUgb2xkVmFsdWUuIElmIHdlIGdldCBzYW1lIHJlY29yZCAodGhpcyBjYW4gaGFwcGVuIGFzIHdlCiAgICAgIC8vIHdhbGsgdXAgdGhlIHRyZWUpIHdlIGlnbm9yZSB0aGUgbmV3IHJlY29yZC4KICAgICAgaWYgKHJlY29yZHMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBsYXN0UmVjb3JkID0gcmVjb3Jkc1tsZW5ndGggLSAxXTsKICAgICAgICB2YXIgcmVjb3JkVG9SZXBsYWNlTGFzdCA9IHNlbGVjdFJlY29yZChsYXN0UmVjb3JkLCByZWNvcmQpOwogICAgICAgIGlmIChyZWNvcmRUb1JlcGxhY2VMYXN0KSB7CiAgICAgICAgICByZWNvcmRzW2xlbmd0aCAtIDFdID0gcmVjb3JkVG9SZXBsYWNlTGFzdDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2NoZWR1bGVDYWxsYmFjayh0aGlzLm9ic2VydmVyKTsKICAgICAgfQoKICAgICAgcmVjb3Jkc1tsZW5ndGhdID0gcmVjb3JkOwogICAgfSwKCiAgICBhZGRMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmFkZExpc3RlbmVyc18odGhpcy50YXJnZXQpOwogICAgfSwKCiAgICBhZGRMaXN0ZW5lcnNfOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NQXR0ck1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlSW5zZXJ0ZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCB8fCBvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlUmVtb3ZlZCcsIHRoaXMsIHRydWUpOwogICAgfSwKCiAgICByZW1vdmVMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyc18odGhpcy50YXJnZXQpOwogICAgfSwKCiAgICByZW1vdmVMaXN0ZW5lcnNfOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQXR0ck1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01Ob2RlSW5zZXJ0ZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCB8fCBvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01Ob2RlUmVtb3ZlZCcsIHRoaXMsIHRydWUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEFkZHMgYSB0cmFuc2llbnQgb2JzZXJ2ZXIgb24gbm9kZS4gVGhlIHRyYW5zaWVudCBvYnNlcnZlciBnZXRzIHJlbW92ZWQKICAgICAqIG5leHQgdGltZSB3ZSBkZWxpdmVyIHRoZSBjaGFuZ2UgcmVjb3Jkcy4KICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICovCiAgICBhZGRUcmFuc2llbnRPYnNlcnZlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAvLyBEb24ndCBhZGQgdHJhbnNpZW50IG9ic2VydmVycyBvbiB0aGUgdGFyZ2V0IGl0c2VsZi4gV2UgYWxyZWFkeSBoYXZlIGFsbAogICAgICAvLyB0aGUgcmVxdWlyZWQgbGlzdGVuZXJzIHNldCB1cCBvbiB0aGUgdGFyZ2V0LgogICAgICBpZiAobm9kZSA9PT0gdGhpcy50YXJnZXQpCiAgICAgICAgcmV0dXJuOwoKICAgICAgdGhpcy5hZGRMaXN0ZW5lcnNfKG5vZGUpOwogICAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMucHVzaChub2RlKTsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmVnaXN0cmF0aW9uc1RhYmxlLnNldChub2RlLCByZWdpc3RyYXRpb25zID0gW10pOwoKICAgICAgLy8gV2Uga25vdyB0aGF0IHJlZ2lzdHJhdGlvbnMgZG9lcyBub3QgY29udGFpbiB0aGlzIGJlY2F1c2Ugd2UgYWxyZWFkeQogICAgICAvLyBjaGVja2VkIGlmIG5vZGUgPT09IHRoaXMudGFyZ2V0LgogICAgICByZWdpc3RyYXRpb25zLnB1c2godGhpcyk7CiAgICB9LAoKICAgIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzOwogICAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSBbXTsKCiAgICAgIHRyYW5zaWVudE9ic2VydmVkTm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gVHJhbnNpZW50IG9ic2VydmVycyBhcmUgbmV2ZXIgYWRkZWQgdG8gdGhlIHRhcmdldC4KICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyc18obm9kZSk7CgogICAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25zW2ldID09PSB0aGlzKSB7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAvLyBFYWNoIG5vZGUgY2FuIG9ubHkgaGF2ZSBvbmUgcmVnaXN0ZXJlZCBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGgKICAgICAgICAgICAgLy8gdGhpcyBvYnNlcnZlci4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgLy8gU3RvcCBwcm9wYWdhdGlvbiBzaW5jZSB3ZSBhcmUgbWFuYWdpbmcgdGhlIHByb3BhZ2F0aW9uIG1hbnVhbGx5LgogICAgICAvLyBUaGlzIG1lYW5zIHRoYXQgb3RoZXIgbXV0YXRpb24gZXZlbnRzIG9uIHRoZSBwYWdlIHdpbGwgbm90IHdvcmsKICAgICAgLy8gY29ycmVjdGx5IGJ1dCB0aGF0IGlzIGJ5IGRlc2lnbi4KICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCiAgICAgIHN3aXRjaCAoZS50eXBlKSB7CiAgICAgICAgY2FzZSAnRE9NQXR0ck1vZGlmaWVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWF0dHJpYnV0ZXMKCiAgICAgICAgICB2YXIgbmFtZSA9IGUuYXR0ck5hbWU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZS5yZWxhdGVkTm9kZS5uYW1lc3BhY2VVUkk7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQ7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBuZXcgZ2V0UmVjb3JkKCdhdHRyaWJ1dGVzJywgdGFyZ2V0KTsKICAgICAgICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lID0gbmFtZTsKICAgICAgICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBuYW1lc3BhY2U7CgogICAgICAgICAgLy8gMi4KICAgICAgICAgIHZhciBvbGRWYWx1ZSA9CiAgICAgICAgICAgICAgZS5hdHRyQ2hhbmdlID09PSBNdXRhdGlvbkV2ZW50LkFERElUSU9OID8gbnVsbCA6IGUucHJldlZhbHVlOwoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMy4xLCA0LjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4yLCA0LjMKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyICYmIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmxlbmd0aCAmJgogICAgICAgICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIuaW5kZXhPZihuYW1lKSA9PT0gLTEgJiYKICAgICAgICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmluZGV4T2YobmFtZXNwYWNlKSA9PT0gLTEpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMy4zLCA0LjQKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlT2xkVmFsdWUpCiAgICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSk7CgogICAgICAgICAgICAvLyAzLjQsIDQuNQogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1jaGFyYWN0ZXJkYXRhCiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQ7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBnZXRSZWNvcmQoJ2NoYXJhY3RlckRhdGEnLCB0YXJnZXQpOwoKICAgICAgICAgIC8vIDIuCiAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBlLnByZXZWYWx1ZTsKCgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAzLjEsIDQuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAzLjIsIDQuMwogICAgICAgICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhT2xkVmFsdWUpCiAgICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSk7CgogICAgICAgICAgICAvLyAzLjMsIDQuNAogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0RPTU5vZGVSZW1vdmVkJzoKICAgICAgICAgIHRoaXMuYWRkVHJhbnNpZW50T2JzZXJ2ZXIoZS50YXJnZXQpOwogICAgICAgICAgLy8gRmFsbCB0aHJvdWdoLgogICAgICAgIGNhc2UgJ0RPTU5vZGVJbnNlcnRlZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1jaGlsZGxpc3QKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnJlbGF0ZWROb2RlOwogICAgICAgICAgdmFyIGNoYW5nZWROb2RlID0gZS50YXJnZXQ7CiAgICAgICAgICB2YXIgYWRkZWROb2RlcywgcmVtb3ZlZE5vZGVzOwogICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ0RPTU5vZGVJbnNlcnRlZCcpIHsKICAgICAgICAgICAgYWRkZWROb2RlcyA9IFtjaGFuZ2VkTm9kZV07CiAgICAgICAgICAgIHJlbW92ZWROb2RlcyA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGFkZGVkTm9kZXMgPSBbXTsKICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gW2NoYW5nZWROb2RlXTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSBjaGFuZ2VkTm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSBjaGFuZ2VkTm9kZS5uZXh0U2libGluZzsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IGdldFJlY29yZCgnY2hpbGRMaXN0JywgdGFyZ2V0KTsKICAgICAgICAgIHJlY29yZC5hZGRlZE5vZGVzID0gYWRkZWROb2RlczsKICAgICAgICAgIHJlY29yZC5yZW1vdmVkTm9kZXMgPSByZW1vdmVkTm9kZXM7CiAgICAgICAgICByZWNvcmQucHJldmlvdXNTaWJsaW5nID0gcHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgcmVjb3JkLm5leHRTaWJsaW5nID0gbmV4dFNpYmxpbmc7CgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAyLjEsIDMuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDIuMiwgMy4zCiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgIH0KCiAgICAgIGNsZWFyUmVjb3JkcygpOwogICAgfQogIH07CgogIGdsb2JhbC5Kc011dGF0aW9uT2JzZXJ2ZXIgPSBKc011dGF0aW9uT2JzZXJ2ZXI7Cgp9KSh0aGlzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgppZiAoIXdpbmRvdy5NdXRhdGlvbk9ic2VydmVyKSB7CiAgd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgPSAKICAgICAgd2luZG93LldlYktpdE11dGF0aW9uT2JzZXJ2ZXIgfHwgCiAgICAgIHdpbmRvdy5Kc011dGF0aW9uT2JzZXJ2ZXI7CiAgaWYgKCFNdXRhdGlvbk9ic2VydmVyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIm5vIG11dGF0aW9uIG9ic2VydmVyIHN1cHBvcnQiKTsKICB9Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovKioKICogSW1wbGVtZW50cyBgZG9jdW1lbnQucmVnaXN0ZXJgCiAqIEBtb2R1bGUgQ3VzdG9tRWxlbWVudHMKKi8KCi8qKgogKiBQb2x5ZmlsbGVkIGV4dGVuc2lvbnMgdG8gdGhlIGBkb2N1bWVudGAgb2JqZWN0LgogKiBAY2xhc3MgRG9jdW1lbnQKKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkN1c3RvbUVsZW1lbnRzID0ge2ZsYWdzOnt9fTsKfQoKLy8gbmF0aXZlIGRvY3VtZW50LnJlZ2lzdGVyPwoKc2NvcGUuaGFzTmF0aXZlID0gKGRvY3VtZW50LndlYmtpdFJlZ2lzdGVyIHx8IGRvY3VtZW50LnJlZ2lzdGVyKSAmJiBzY29wZS5mbGFncy5yZWdpc3RlciA9PT0gJ25hdGl2ZSc7CmlmIChzY29wZS5oYXNOYXRpdmUpIHsKCiAgLy8gbm9ybWFsaXplCiAgZG9jdW1lbnQucmVnaXN0ZXIgPSBkb2N1bWVudC5yZWdpc3RlciB8fCBkb2N1bWVudC53ZWJraXRSZWdpc3RlcjsKCiAgdmFyIG5vcCA9IGZ1bmN0aW9uKCkge307CgogIC8vIGV4cG9ydHMKICBzY29wZS5yZWdpc3RyeSA9IHt9OwogIHNjb3BlLnVwZ3JhZGVFbGVtZW50ID0gbm9wOwoKfSBlbHNlIHsKCi8qKgogKiBSZWdpc3RlcnMgYSBjdXN0b20gdGFnIG5hbWUgd2l0aCB0aGUgZG9jdW1lbnQuCiAqCiAqIFdoZW4gYSByZWdpc3RlcmVkIGVsZW1lbnQgaXMgY3JlYXRlZCwgYSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGlzIGNhbGxlZAogKiBpbiB0aGUgc2NvcGUgb2YgdGhlIGVsZW1lbnQuIFRoZSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGNhbiBiZSBzcGVjaWZpZWQgb24KICogZWl0aGVyIGBpbk9wdGlvbnMucHJvdG90eXBlYCBvciBgaW5PcHRpb25zLmxpZmVjeWNsZWAgd2l0aCB0aGUgbGF0dGVyIHRha2luZwogKiBwcmVjZWRlbmNlLgogKgogKiBAbWV0aG9kIHJlZ2lzdGVyCiAqIEBwYXJhbSB7U3RyaW5nfSBpbk5hbWUgVGhlIHRhZyBuYW1lIHRvIHJlZ2lzdGVyLiBNdXN0IGluY2x1ZGUgYSBkYXNoICgnLScpLAogKiAgICBmb3IgZXhhbXBsZSAneC1jb21wb25lbnQnLgogKiBAcGFyYW0ge09iamVjdH0gaW5PcHRpb25zCiAqICAgIEBwYXJhbSB7U3RyaW5nfSBbaW5PcHRpb25zLmV4dGVuZHNdCiAqICAgICAgKF9vZmYgc3BlY18pIFRhZyBuYW1lIG9mIGFuIGVsZW1lbnQgdG8gZXh0ZW5kIChvciBibGFuayBmb3IgYSBuZXcKICogICAgICBlbGVtZW50KS4gVGhpcyBwYXJhbWV0ZXIgaXMgbm90IHBhcnQgb2YgdGhlIHNwZWNpZmljYXRpb24sIGJ1dCBpbnN0ZWFkCiAqICAgICAgaXMgYSBoaW50IGZvciB0aGUgcG9seWZpbGwgYmVjYXVzZSB0aGUgZXh0ZW5kZWUgaXMgZGlmZmljdWx0IHRvIGluZmVyLgogKiAgICAgIFJlbWVtYmVyIHRoYXQgdGhlIGlucHV0IHByb3RvdHlwZSBtdXN0IGNoYWluIHRvIHRoZSBleHRlbmRlZCBlbGVtZW50J3MKICogICAgICBwcm90b3R5cGUgKG9yIEhUTUxFbGVtZW50LnByb3RvdHlwZSkgcmVnYXJkbGVzcyBvZiB0aGUgdmFsdWUgb2YKICogICAgICBgZXh0ZW5kc2AuCiAqICAgIEBwYXJhbSB7T2JqZWN0fSBpbk9wdGlvbnMucHJvdG90eXBlIFRoZSBwcm90b3R5cGUgdG8gdXNlIGZvciB0aGUgbmV3CiAqICAgICAgZWxlbWVudC4gVGhlIHByb3RvdHlwZSBtdXN0IGluaGVyaXQgZnJvbSBIVE1MRWxlbWVudC4KICogICAgQHBhcmFtIHtPYmplY3R9IFtpbk9wdGlvbnMubGlmZWN5Y2xlXQogKiAgICAgIENhbGxiYWNrcyB0aGF0IGZpcmUgYXQgaW1wb3J0YW50IHBoYXNlcyBpbiB0aGUgbGlmZSBvZiB0aGUgY3VzdG9tCiAqICAgICAgZWxlbWVudC4KICoKICogQGV4YW1wbGUKICogICAgICBGYW5jeUJ1dHRvbiA9IGRvY3VtZW50LnJlZ2lzdGVyKCJmYW5jeS1idXR0b24iLCB7CiAqICAgICAgICBleHRlbmRzOiAnYnV0dG9uJywKICogICAgICAgIHByb3RvdHlwZTogT2JqZWN0LmNyZWF0ZShIVE1MQnV0dG9uRWxlbWVudC5wcm90b3R5cGUsIHsKICogICAgICAgICAgcmVhZHlDYWxsYmFjazogewogKiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJhIGZhbmN5LWJ1dHRvbiB3YXMgY3JlYXRlZCIsCiAqICAgICAgICAgICAgfQogKiAgICAgICAgICB9CiAqICAgICAgICB9KQogKiAgICAgIH0pOwogKiBAcmV0dXJuIHtGdW5jdGlvbn0gQ29uc3RydWN0b3IgZm9yIHRoZSBuZXdseSByZWdpc3RlcmVkIHR5cGUuCiAqLwpmdW5jdGlvbiByZWdpc3Rlcihpbk5hbWUsIGluT3B0aW9ucykgewogIC8vY29uc29sZS53YXJuKCdkb2N1bWVudC5yZWdpc3RlcigiJyArIGluTmFtZSArICciLCAnLCBpbk9wdGlvbnMsICcpJyk7CiAgLy8gY29uc3RydWN0IGEgZGVmaW50aW9uIG91dCBvZiBvcHRpb25zCiAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIGNsb25lIGluT3B0aW9ucyBpbnN0ZWFkIG9mIG11dGF0aW5nIGl0CiAgdmFyIGRlZmluaXRpb24gPSBpbk9wdGlvbnMgfHwge307CiAgaWYgKCFpbk5hbWUpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmlrIGNhbiBwcm9iYWJseQogICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ05hbWUgYXJndW1lbnQgbXVzdCBub3QgYmUgZW1wdHknKTsKICB9CiAgLy8gcmVjb3JkIG5hbWUKICBkZWZpbml0aW9uLm5hbWUgPSBpbk5hbWU7CiAgLy8gbXVzdCBoYXZlIGEgcHJvdG90eXBlLCBkZWZhdWx0IHRvIGFuIGV4dGVuc2lvbiBvZiBIVE1MRWxlbWVudAogIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCB0aHJvdyBpZiBubyBwcm90b3R5cGUsIGNoZWNrIHNwZWMKICBpZiAoIWRlZmluaXRpb24ucHJvdG90eXBlKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpayBjYW4gcHJvYmFibHkKICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgdGhyb3cgbmV3IEVycm9yKCdPcHRpb25zIG1pc3NpbmcgcmVxdWlyZWQgcHJvdG90eXBlIHByb3BlcnR5Jyk7CiAgfQogIC8vIGVuc3VyZSBhIGxpZmVjeWNsZSBvYmplY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBudWxsIHRlc3QgaXQKICBkZWZpbml0aW9uLmxpZmVjeWNsZSA9IGRlZmluaXRpb24ubGlmZWN5Y2xlIHx8IHt9OwogIC8vIGJ1aWxkIGEgbGlzdCBvZiBhbmNlc3RyYWwgY3VzdG9tIGVsZW1lbnRzIChmb3IgbmF0aXZlIGJhc2UgZGV0ZWN0aW9uKQogIC8vIFRPRE8oc2ptaWxlcyk6IHdlIHVzZWQgdG8gbmVlZCB0byBzdG9yZSB0aGlzLCBidXQgY3VycmVudCBjb2RlIG9ubHkKICAvLyB1c2VzIGl0IGluICdyZXNvbHZlVGFnTmFtZSc6IGl0IHNob3VsZCBwcm9iYWJseSBiZSBpbmxpbmVkCiAgZGVmaW5pdGlvbi5hbmNlc3RyeSA9IGFuY2VzdHJ5KGRlZmluaXRpb24uZXh0ZW5kcyk7CiAgLy8gZXh0ZW5zaW9ucyBvZiBuYXRpdmUgc3BlY2lhbGl6YXRpb25zIG9mIEhUTUxFbGVtZW50IHJlcXVpcmUgbG9jYWxOYW1lCiAgLy8gdG8gcmVtYWluIG5hdGl2ZSwgYW5kIHVzZSBzZWNvbmRhcnkgJ2lzJyBzcGVjaWZpZXIgZm9yIGV4dGVuc2lvbiB0eXBlCiAgcmVzb2x2ZVRhZ05hbWUoZGVmaW5pdGlvbik7CiAgLy8gc29tZSBwbGF0Zm9ybXMgcmVxdWlyZSBtb2RpZmljYXRpb25zIHRvIHRoZSB1c2VyLXN1cHBsaWVkIHByb3RvdHlwZQogIC8vIGNoYWluCiAgcmVzb2x2ZVByb3RvdHlwZUNoYWluKGRlZmluaXRpb24pOwogIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgY2FsbGJhY2tzCiAgLy8gVE9ETyhzam1pbGVzKTogc2hvdWxkIHN1cHBvcnQgYWNjZXNzIHZpYSAuYXR0cmlidXRlcyBOYW1lZE5vZGVNYXAKICBkZWZpbml0aW9uLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBzZXRBdHRyaWJ1dGU7CiAgZGVmaW5pdGlvbi5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gcmVtb3ZlQXR0cmlidXRlOwogIC8vIDcuMS41OiBSZWdpc3RlciB0aGUgREVGSU5JVElPTiB3aXRoIERPQ1VNRU5UCiAgcmVnaXN0ZXJEZWZpbml0aW9uKGluTmFtZSwgZGVmaW5pdGlvbik7CiAgLy8gNy4xLjcuIFJ1biBjdXN0b20gZWxlbWVudCBjb25zdHJ1Y3RvciBnZW5lcmF0aW9uIGFsZ29yaXRobSB3aXRoIFBST1RPVFlQRQogIC8vIDcuMS44LiBSZXR1cm4gdGhlIG91dHB1dCBvZiB0aGUgcHJldmlvdXMgc3RlcC4KICBkZWZpbml0aW9uLmN0b3IgPSBnZW5lcmF0ZUNvbnN0cnVjdG9yKGRlZmluaXRpb24pOwogIGRlZmluaXRpb24uY3Rvci5wcm90b3R5cGUgPSBkZWZpbml0aW9uLnByb3RvdHlwZTsKICAvLyBpZiBpbml0aWFsIHBhcnNpbmcgaXMgY29tcGxldGUKICBpZiAoc2NvcGUucmVhZHkpIHsKICAgIC8vIHVwZ3JhZGUgYW55IHByZS1leGlzdGluZyBub2RlcyBvZiB0aGlzIHR5cGUKICAgIHNjb3BlLnVwZ3JhZGVBbGwoZG9jdW1lbnQpOwogIH0KICByZXR1cm4gZGVmaW5pdGlvbi5jdG9yOwp9CgpmdW5jdGlvbiBhbmNlc3RyeShpbkV4dGVuZHMpIHsKICB2YXIgZXh0ZW5kZWUgPSByZWdpc3RyeVtpbkV4dGVuZHNdOwogIGlmIChleHRlbmRlZSkgewogICAgcmV0dXJuIGFuY2VzdHJ5KGV4dGVuZGVlLmV4dGVuZHMpLmNvbmNhdChbZXh0ZW5kZWVdKTsKICB9CiAgcmV0dXJuIFtdOwp9CgpmdW5jdGlvbiByZXNvbHZlVGFnTmFtZShpbkRlZmluaXRpb24pIHsKICAvLyBpZiB3ZSBhcmUgZXhwbGljaXRseSBleHRlbmRpbmcgc29tZXRoaW5nLCB0aGF0IHRoaW5nIGlzIG91cgogIC8vIGJhc2VUYWcsIHVubGVzcyBpdCByZXByZXNlbnRzIGEgY3VzdG9tIGNvbXBvbmVudAogIHZhciBiYXNlVGFnID0gaW5EZWZpbml0aW9uLmV4dGVuZHM7CiAgLy8gaWYgb3VyIGFuY2VzdHJ5IGluY2x1ZGVzIGN1c3RvbSBjb21wb25lbnRzLCB3ZSBvbmx5IGhhdmUgYQogIC8vIGJhc2VUYWcgaWYgb25lIG9mIHRoZW0gZG9lcwogIGZvciAodmFyIGk9MCwgYTsgKGE9aW5EZWZpbml0aW9uLmFuY2VzdHJ5W2ldKTsgaSsrKSB7CiAgICBiYXNlVGFnID0gYS5pcyAmJiBhLnRhZzsKICB9CiAgLy8gb3VyIHRhZyBpcyBvdXIgYmFzZVRhZywgaWYgaXQgZXhpc3RzLCBhbmQgb3RoZXJ3aXNlIGp1c3Qgb3VyIG5hbWUKICBpbkRlZmluaXRpb24udGFnID0gYmFzZVRhZyB8fCBpbkRlZmluaXRpb24ubmFtZTsKICBpZiAoYmFzZVRhZykgewogICAgLy8gaWYgdGhlcmUgaXMgYSBiYXNlIHRhZywgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllcgogICAgaW5EZWZpbml0aW9uLmlzID0gaW5EZWZpbml0aW9uLm5hbWU7CiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlUHJvdG90eXBlQ2hhaW4oaW5EZWZpbml0aW9uKSB7CiAgLy8gaWYgd2UgZG9uJ3Qgc3VwcG9ydCBfX3Byb3RvX18gd2UgbmVlZCB0byBsb2NhdGUgdGhlIG5hdGl2ZSBsZXZlbAogIC8vIHByb3RvdHlwZSBmb3IgcHJlY2lzZSBtaXhpbmcgaW4KICBpZiAoIU9iamVjdC5fX3Byb3RvX18pIHsKICAgIGlmIChpbkRlZmluaXRpb24uaXMpIHsKICAgICAgLy8gZm9yIG5vbi10cml2aWFsIGV4dGVuc2lvbnMsIHdvcmsgb3V0IGJvdGggcHJvdG90eXBlcwogICAgICB2YXIgaW5zdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoaW5EZWZpbml0aW9uLnRhZyk7CiAgICAgIHZhciBuYXRpdmUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5zdCk7CiAgICB9IGVsc2UgewogICAgICAvLyBvdGhlcndpc2UsIHVzZSB0aGUgZGVmYXVsdAogICAgICBuYXRpdmUgPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7CiAgICB9CiAgfQogIC8vIGNhY2hlIHRoaXMgaW4gY2FzZSBvZiBtaXhpbgogIGluRGVmaW5pdGlvbi5uYXRpdmUgPSBuYXRpdmU7Cn0KCi8vIFNFQ1RJT04gNAoKZnVuY3Rpb24gaW5zdGFudGlhdGUoaW5EZWZpbml0aW9uKSB7CiAgLy8gNC5hLjEuIENyZWF0ZSBhIG5ldyBvYmplY3QgdGhhdCBpbXBsZW1lbnRzIFBST1RPVFlQRQogIC8vIDQuYS4yLiBMZXQgRUxFTUVOVCBieSB0aGlzIG5ldyBvYmplY3QKICAvLwogIC8vIHRoZSBjdXN0b20gZWxlbWVudCBpbnN0YW50aWF0aW9uIGFsZ29yaXRobSBtdXN0IGFsc28gZW5zdXJlIHRoYXQgdGhlCiAgLy8gb3V0cHV0IGlzIGEgdmFsaWQgRE9NIGVsZW1lbnQgd2l0aCB0aGUgcHJvcGVyIHdyYXBwZXIgaW4gcGxhY2UuCiAgLy8KICByZXR1cm4gdXBncmFkZShkb21DcmVhdGVFbGVtZW50KGluRGVmaW5pdGlvbi50YWcpLCBpbkRlZmluaXRpb24pOwp9CgpmdW5jdGlvbiB1cGdyYWRlKGluRWxlbWVudCwgaW5EZWZpbml0aW9uKSB7CiAgLy8gc29tZSBkZWZpbml0aW9ucyBzcGVjaWZ5IGFuICdpcycgYXR0cmlidXRlCiAgaWYgKGluRGVmaW5pdGlvbi5pcykgewogICAgaW5FbGVtZW50LnNldEF0dHJpYnV0ZSgnaXMnLCBpbkRlZmluaXRpb24uaXMpOwogIH0KICAvLyBtYWtlICdlbGVtZW50JyBpbXBsZW1lbnQgaW5EZWZpbml0aW9uLnByb3RvdHlwZQogIGltcGxlbWVudChpbkVsZW1lbnQsIGluRGVmaW5pdGlvbik7CiAgLy8gZmxhZyBhcyB1cGdyYWRlZAogIGluRWxlbWVudC5fX3VwZ3JhZGVkX18gPSB0cnVlOwogIC8vIHRoZXJlIHNob3VsZCBuZXZlciBiZSBhIHNoYWRvdyByb290IG9uIGluRWxlbWVudCBhdCB0aGlzIHBvaW50CiAgLy8gd2UgcmVxdWlyZSBjaGlsZCBub2RlcyBiZSB1cGdyYWRlZCBiZWZvcmUgcmVhZHkKICBzY29wZS51cGdyYWRlU3VidHJlZShpbkVsZW1lbnQpOwogIC8vIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgcmVhZHkoaW5FbGVtZW50KTsKICAvLyBPVVRQVVQKICByZXR1cm4gaW5FbGVtZW50Owp9CgpmdW5jdGlvbiBpbXBsZW1lbnQoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pIHsKICAvLyBwcm90b3R5cGUgc3dpenpsaW5nIGlzIGJlc3QKICBpZiAoT2JqZWN0Ll9fcHJvdG9fXykgewogICAgaW5FbGVtZW50Ll9fcHJvdG9fXyA9IGluRGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgfSBlbHNlIHsKICAgIC8vIHdoZXJlIGFib3ZlIHdlIGNhbiByZS1hY3F1aXJlIGluUHJvdG90eXBlIHZpYQogICAgLy8gZ2V0UHJvdG90eXBlT2YoRWxlbWVudCksIHdlIGNhbm5vdCBkbyBzbyB3aGVuCiAgICAvLyB3ZSB1c2UgbWl4aW4sIHNvIHdlIGluc3RhbGwgYSBtYWdpYyByZWZlcmVuY2UKICAgIGN1c3RvbU1peGluKGluRWxlbWVudCwgaW5EZWZpbml0aW9uLnByb3RvdHlwZSwgaW5EZWZpbml0aW9uLm5hdGl2ZSk7CiAgICBpbkVsZW1lbnQuX19wcm90b19fID0gaW5EZWZpbml0aW9uLnByb3RvdHlwZTsKICB9Cn0KCmZ1bmN0aW9uIGN1c3RvbU1peGluKGluVGFyZ2V0LCBpblNyYywgaW5OYXRpdmUpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiAndXNlZCcgYWxsb3dzIHVzIHRvIG9ubHkgY29weSB0aGUgJ3lvdW5nZXN0JyB2ZXJzaW9uIG9mCiAgLy8gYW55IHByb3BlcnR5LiBUaGlzIHNldCBzaG91bGQgYmUgcHJlY2FsY3VsYXRlZC4gV2UgYWxzbyBuZWVkIHRvCiAgLy8gY29uc2lkZXIgdGhpcyBmb3Igc3VwcG9ydGluZyAnc3VwZXInLgogIHZhciB1c2VkID0ge307CiAgLy8gc3RhcnQgd2l0aCBpblNyYwogIHZhciBwID0gaW5TcmM7CiAgLy8gc29tZXRpbWVzIHRoZSBkZWZhdWx0IGlzIEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUgaW5zdGVhZCBvZgogIC8vIEhUTUxFbGVtZW50LnByb3RvdHlwZSwgc28gd2UgYWRkIGEgdGVzdAogIC8vIHRoZSBpZGVhIGlzIHRvIGF2b2lkIG1peGluZyBpbiBuYXRpdmUgcHJvdG90eXBlcywgc28gYWRkaW5nCiAgLy8gdGhlIHNlY29uZCB0ZXN0IGlzIFdMT0cKICB3aGlsZSAocCAhPT0gaW5OYXRpdmUgJiYgcCAhPT0gSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSkgewogICAgdmFyIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwKTsKICAgIGZvciAodmFyIGk9MCwgazsgaz1rZXlzW2ldOyBpKyspIHsKICAgICAgaWYgKCF1c2VkW2tdKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGluVGFyZ2V0LCBrLAogICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHAsIGspKTsKICAgICAgICB1c2VkW2tdID0gMTsKICAgICAgfQogICAgfQogICAgcCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwKTsKICB9Cn0KCmZ1bmN0aW9uIHJlYWR5KGluRWxlbWVudCkgewogIC8vIGludm9rZSByZWFkeUNhbGxiYWNrCiAgaWYgKGluRWxlbWVudC5yZWFkeUNhbGxiYWNrKSB7CiAgICBpbkVsZW1lbnQucmVhZHlDYWxsYmFjaygpOwogIH0KfQoKLy8gYXR0cmlidXRlIHdhdGNoaW5nCgp2YXIgb3JpZ2luYWxTZXRBdHRyaWJ1dGUgPSBIVE1MRWxlbWVudC5wcm90b3R5cGUuc2V0QXR0cmlidXRlOwp2YXIgb3JpZ2luYWxSZW1vdmVBdHRyaWJ1dGUgPSBIVE1MRWxlbWVudC5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlOwoKZnVuY3Rpb24gc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKSB7CiAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIG9yaWdpbmFsU2V0QXR0cmlidXRlKTsKfQoKZnVuY3Rpb24gcmVtb3ZlQXR0cmlidXRlKG5hbWUsIHZhbHVlKSB7CiAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIG9yaWdpbmFsUmVtb3ZlQXR0cmlidXRlKTsKfQoKZnVuY3Rpb24gY2hhbmdlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcGVyYXRpb24pIHsKICB2YXIgb2xkVmFsdWUgPSB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICBvcGVyYXRpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAodGhpcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sgCiAgICAgICYmICh0aGlzLmdldEF0dHJpYnV0ZShuYW1lKSAhPT0gb2xkVmFsdWUpKSB7CiAgICB0aGlzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGRWYWx1ZSk7CiAgfQp9CgovLyBlbGVtZW50IHJlZ2lzdHJ5IChtYXBzIHRhZyBuYW1lcyB0byBkZWZpbml0aW9ucykKCnZhciByZWdpc3RyeSA9IHt9OwoKZnVuY3Rpb24gcmVnaXN0ZXJEZWZpbml0aW9uKGluTmFtZSwgaW5EZWZpbml0aW9uKSB7CiAgcmVnaXN0cnlbaW5OYW1lXSA9IGluRGVmaW5pdGlvbjsKfQoKZnVuY3Rpb24gZ2VuZXJhdGVDb25zdHJ1Y3RvcihpbkRlZmluaXRpb24pIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gaW5zdGFudGlhdGUoaW5EZWZpbml0aW9uKTsKICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50KGluVGFnKSB7CiAgdmFyIGRlZmluaXRpb24gPSByZWdpc3RyeVtpblRhZ107CiAgaWYgKGRlZmluaXRpb24pIHsKICAgIHJldHVybiBuZXcgZGVmaW5pdGlvbi5jdG9yKCk7CiAgfQogIHJldHVybiBkb21DcmVhdGVFbGVtZW50KGluVGFnKTsKfQoKZnVuY3Rpb24gdXBncmFkZUVsZW1lbnQoaW5FbGVtZW50KSB7CiAgaWYgKCFpbkVsZW1lbnQuX191cGdyYWRlZF9fICYmIChpbkVsZW1lbnQubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSkgewogICAgdmFyIHR5cGUgPSBpbkVsZW1lbnQuZ2V0QXR0cmlidXRlKCdpcycpIHx8IGluRWxlbWVudC5sb2NhbE5hbWU7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W3R5cGVdOwogICAgcmV0dXJuIGRlZmluaXRpb24gJiYgdXBncmFkZShpbkVsZW1lbnQsIGRlZmluaXRpb24pOwogIH0KfQovLyBjYXB0dXJlIG5hdGl2ZSBjcmVhdGVFbGVtZW50IGJlZm9yZSB3ZSBvdmVycmlkZSBpdAoKdmFyIGRvbUNyZWF0ZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50LmJpbmQoZG9jdW1lbnQpOwoKLy8gZXhwb3J0cwoKZG9jdW1lbnQucmVnaXN0ZXIgPSByZWdpc3RlcjsKZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQ7IC8vIG92ZXJyaWRlCgpzY29wZS5yZWdpc3RyeSA9IHJlZ2lzdHJ5OwoKLyoqCiAqIFVwZ3JhZGUgYW4gZWxlbWVudCB0byBhIGN1c3RvbSBlbGVtZW50LiBVcGdyYWRpbmcgYW4gZWxlbWVudAogKiBjYXVzZXMgdGhlIGN1c3RvbSBwcm90b3R5cGUgdG8gYmUgYXBwbGllZCwgYW4gYGlzYCBhdHRyaWJ1dGUgCiAqIHRvIGJlIGF0dGFjaGVkIChhcyBuZWVkZWQpLCBhbmQgaW52b2NhdGlvbiBvZiB0aGUgYHJlYWR5Q2FsbGJhY2tgLgogKiBgdXBncmFkZWAgZG9lcyBub3RoaW5nIGlmIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgdXBncmFkZWQsIG9yCiAqIGlmIGl0IG1hdGNoZXMgbm8gcmVnaXN0ZXJlZCBjdXN0b20gdGFnIG5hbWUuCiAqCiAqIEBtZXRob2QgdWdwcmFkZQogKiBAcGFyYW0ge0VsZW1lbnR9IGluRWxlbWVudCBUaGUgZWxlbWVudCB0byB1cGdyYWRlLgogKiBAcmV0dXJuIHtFbGVtZW50fSBUaGUgdXBncmFkZWQgZWxlbWVudC4KICovCnNjb3BlLnVwZ3JhZGUgPSB1cGdyYWRlRWxlbWVudDsKCn0KCn0pKHdpbmRvdy5DdXN0b21FbGVtZW50cyk7CgogLyoNCkNvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuDQpVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQ0KbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLg0KKi8NCg0KKGZ1bmN0aW9uKHNjb3BlKXsNCg0KLyoNCmlmIChIVE1MRWxlbWVudC5wcm90b3R5cGUud2Via2l0U2hhZG93Um9vdCkgew0KICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSFRNTEVsZW1lbnQucHJvdG90eXBlLCAnc2hhZG93Um9vdCcsIHsNCiAgICBnZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgcmV0dXJuIHRoaXMud2Via2l0U2hhZG93Um9vdDsNCiAgICB9DQogIH07DQp9DQoqLw0KDQovLyB3YWxrIHRoZSBzdWJ0cmVlIHJvb3RlZCBhdCBub2RlLCBhcHBseWluZyAnZmluZChlbGVtZW50LCBkYXRhKScgZnVuY3Rpb24gDQovLyB0byBlYWNoIGVsZW1lbnQNCi8vIGlmICdmaW5kJyByZXR1cm5zIHRydWUgZm9yICdlbGVtZW50JywgZG8gbm90IHNlYXJjaCBlbGVtZW50J3Mgc3VidHJlZSAgDQpmdW5jdGlvbiBmaW5kQWxsKG5vZGUsIGZpbmQsIGRhdGEpIHsNCiAgdmFyIGUgPSBub2RlLmZpcnN0RWxlbWVudENoaWxkOw0KICBpZiAoIWUpIHsNCiAgICBlID0gbm9kZS5maXJzdENoaWxkOw0KICAgIHdoaWxlIChlICYmIGUubm9kZVR5cGUgIT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7DQogICAgICBlID0gZS5uZXh0U2libGluZzsNCiAgICB9DQogIH0NCiAgd2hpbGUgKGUpIHsNCiAgICBpZiAoZmluZChlLCBkYXRhKSAhPT0gdHJ1ZSkgew0KICAgICAgZmluZEFsbChlLCBmaW5kLCBkYXRhKTsNCiAgICB9DQogICAgZSA9IGUubmV4dEVsZW1lbnRTaWJsaW5nOwogIH0NCiAgcmV0dXJuIG51bGw7DQp9DQoNCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGluY2x1ZGluZyBkZXNjZW50IGludG8gc2hhZG93LXJvb3RzLCANCi8vIGFwcGx5aW5nICdjYicgdG8gZWFjaCBlbGVtZW50DQpmdW5jdGlvbiBmb3JTdWJ0cmVlKG5vZGUsIGNiKSB7DQogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXAoJ3N1YlRyZWU6ICcsIG5vZGUpOw0KICBmaW5kQWxsKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICBpZiAoY2IoZSkpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBpZiAoZS53ZWJraXRTaGFkb3dSb290KSB7DQogICAgICBmb3JTdWJ0cmVlKGUud2Via2l0U2hhZG93Um9vdCwgY2IpOw0KICAgIH0NCiAgfSk7DQogIGlmIChub2RlLndlYmtpdFNoYWRvd1Jvb3QpIHsNCiAgICBmb3JTdWJ0cmVlKG5vZGUud2Via2l0U2hhZG93Um9vdCwgY2IpOw0KICB9DQogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn0NCg0KLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlDQpmdW5jdGlvbiBhZGRlZChub2RlKSB7DQogIGlmICh1cGdyYWRlKG5vZGUpKSB7DQogICAgaW5zZXJ0ZWROb2RlKG5vZGUpOw0KICAgIHJldHVybiB0cnVlOyANCiAgfQ0KICBpbnNlcnRlZChub2RlKTsNCn0NCg0KLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlJ3Mgc3VidHJlZSBvbmx5DQpmdW5jdGlvbiBhZGRlZFN1YnRyZWUobm9kZSkgew0KICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICBpZiAoYWRkZWQoZSkpIHsNCiAgICAgIHJldHVybiB0cnVlOyANCiAgICB9DQogIH0pOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUgYW5kIGl0J3Mgc3VidHJlZQ0KZnVuY3Rpb24gYWRkZWROb2RlKG5vZGUpIHsNCiAgcmV0dXJuIGFkZGVkKG5vZGUpIHx8IGFkZGVkU3VidHJlZShub2RlKTsNCn0NCg0KLy8gdXBncmFkZSBjdXN0b20gZWxlbWVudHMgYXQgbm9kZSwgaWYgYXBwbGljYWJsZQ0KZnVuY3Rpb24gdXBncmFkZShub2RlKSB7DQogIGlmICghbm9kZS5fX3VwZ3JhZGVkX18gJiYgbm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHsNCiAgICB2YXIgdHlwZSA9IG5vZGUuZ2V0QXR0cmlidXRlKCdpcycpIHx8IG5vZGUubG9jYWxOYW1lOw0KICAgIHZhciBkZWZpbml0aW9uID0gc2NvcGUucmVnaXN0cnlbdHlwZV07DQogICAgaWYgKGRlZmluaXRpb24pIHsNCiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCd1cGdyYWRlOicsIG5vZGUubG9jYWxOYW1lKTsNCiAgICAgIHNjb3BlLnVwZ3JhZGUobm9kZSk7DQogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIGluc2VydGVkTm9kZShub2RlKSB7DQogIGluc2VydGVkKG5vZGUpOw0KICBpZiAoaW5Eb2N1bWVudChub2RlKSkgew0KICAgIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgICAgaW5zZXJ0ZWQoZSk7DQogICAgfSk7DQogIH0NCn0NCg0KLy8gVE9ETyhzam1pbGVzKTogaWYgdGhlcmUgYXJlIGRlc2NlbnRzIGludG8gdHJlZXMgdGhhdCBjYW4gbmV2ZXIgaGF2ZSBpbkRvY3VtZW50KCopIHRydWUsIGZpeCB0aGlzDQoNCmZ1bmN0aW9uIGluc2VydGVkKGVsZW1lbnQpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogaXQncyBwb3NzaWJsZSB3ZSB3ZXJlIGluc2VydGVkIGFuZCByZW1vdmVkIGluIHRoZSBzcGFjZQ0KICAvLyBvZiBvbmUgbWljcm90YXNrLCBpbiB3aGljaCBjYXNlIHdlIHdvbid0IGJlICdpbkRvY3VtZW50JyBoZXJlDQogIC8vIEJ1dCB0aGVyZSBhcmUgb3RoZXIgY2FzZXMgd2hlcmUgd2UgYXJlIHRlc3RpbmcgZm9yIGluc2VydGVkIHdpdGhvdXQNCiAgLy8gc3BlY2lmaWMga25vd2xlZGdlIG9mIG11dGF0aW9ucywgYW5kIG11c3QgdGVzdCAnaW5Eb2N1bWVudCcgdG8gZGV0ZXJtaW5lDQogIC8vIHdoZXRoZXIgdG8gY2FsbCBpbnNlcnRlZA0KICAvLyBJZiB3ZSBjYW4gZmFjdG9yIHRoZXNlIGNhc2VzIGludG8gc2VwYXJhdGUgY29kZSBwYXRocyB3ZSBjYW4gaGF2ZQ0KICAvLyBiZXR0ZXIgZGlhZ25vc3RpY3MuDQogIC8vIFRPRE8oc2ptaWxlcyk6IHdoZW4gbG9nZ2luZywgZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbg0KICAvLyB0cmFjayBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkDQogIC8vY29uc29sZS5sb2coJ2luc2VydGVkOiAnLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogIGlmIChlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2sgfHwgKGVsZW1lbnQuX191cGdyYWRlZF9fICYmIGxvZ0ZsYWdzLmRvbSkpIHsNCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgIGlmIChpbkRvY3VtZW50KGVsZW1lbnQpKSB7DQogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApICsgMTsNCiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdyZW1vdmVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ2luc2VydGVkJyBzdGF0ZQ0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDEpIHsNCiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMTsNCiAgICAgIH0NCiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciBpbnNlcnRlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMSkgew0KICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwNCiAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpDQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaW5zZXJ0ZWRDYWxsYmFjaykgew0KICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgICAgICAgZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrKCk7DQogICAgICB9DQogICAgfQ0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQogIH0NCn0NCg0KZnVuY3Rpb24gcmVtb3ZlZE5vZGUobm9kZSkgew0KICByZW1vdmVkKG5vZGUpOw0KICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICByZW1vdmVkKGUpOw0KICB9KTsNCn0NCg0KZnVuY3Rpb24gcmVtb3ZlZChlbGVtZW50KSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IHRlbXBvcmFyeTogZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbiB0cmFjaw0KICAvLyBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkDQogIGlmIChlbGVtZW50LnJlbW92ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogICAgaWYgKCFpbkRvY3VtZW50KGVsZW1lbnQpKSB7DQogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApIC0gMTsNCiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdpbnNlcnRlZCcgc3RhdGUsIGJsdW50bHkgYWRqdXN0IHRvIGFuICdyZW1vdmVkJyBzdGF0ZQ0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA+IDApIHsNCiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMDsNCiAgICAgIH0NCiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciByZW1vdmVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPCAwKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ3JlbW92ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUsDQogICAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpDQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKSB7DQogICAgICAgIGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKCk7DQogICAgICB9DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIGluRG9jdW1lbnQoZWxlbWVudCkgew0KICB2YXIgcCA9IGVsZW1lbnQ7DQogIHdoaWxlIChwKSB7DQogICAgaWYgKHAgPT0gZWxlbWVudC5vd25lckRvY3VtZW50KSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgcCA9IHAucGFyZW50Tm9kZSB8fCBwLmhvc3Q7DQogIH0NCn0NCg0KZnVuY3Rpb24gd2F0Y2hTaGFkb3cobm9kZSkgew0KICBpZiAobm9kZS53ZWJraXRTaGFkb3dSb290ICYmICFub2RlLndlYmtpdFNoYWRvd1Jvb3QuX193YXRjaGVkKSB7DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCd3YXRjaGluZyBzaGFkb3ctcm9vdCBmb3I6ICcsIG5vZGUubG9jYWxOYW1lKTsNCiAgICBvYnNlcnZlKG5vZGUud2Via2l0U2hhZG93Um9vdCk7DQogICAgbm9kZS53ZWJraXRTaGFkb3dSb290Ll9fd2F0Y2hlZCA9IHRydWU7DQogIH0NCn0NCg0KZnVuY3Rpb24gd2F0Y2hBbGxTaGFkb3dzKG5vZGUpIHsNCiAgd2F0Y2hTaGFkb3cobm9kZSk7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIHdhdGNoU2hhZG93KG5vZGUpOw0KICB9KTsNCn0NCg0KZnVuY3Rpb24gZmlsdGVyKGluTm9kZSkgew0KICBzd2l0Y2ggKGluTm9kZS5sb2NhbE5hbWUpIHsNCiAgICBjYXNlICdzdHlsZSc6DQogICAgY2FzZSAnc2NyaXB0JzoNCiAgICBjYXNlICd0ZW1wbGF0ZSc6DQogICAgY2FzZSB1bmRlZmluZWQ6DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiBoYW5kbGVyKG11dGF0aW9ucykgew0KICAvLw0KICBpZiAobG9nRmxhZ3MuZG9tKSB7DQogICAgdmFyIG14ID0gbXV0YXRpb25zWzBdOw0KICAgIGlmIChteCAmJiBteC50eXBlID09PSAnY2hpbGRMaXN0JyAmJiBteC5hZGRlZE5vZGVzKSB7DQogICAgICAgIGlmIChteC5hZGRlZE5vZGVzKSB7DQogICAgICAgICAgdmFyIGQgPSBteC5hZGRlZE5vZGVzWzBdOw0KICAgICAgICAgIHdoaWxlIChkICYmIGQgIT09IGRvY3VtZW50ICYmICFkLmhvc3QpIHsNCiAgICAgICAgICAgIGQgPSBkLnBhcmVudE5vZGU7DQogICAgICAgICAgfQ0KICAgICAgICAgIHZhciB1ID0gZCAmJiAoZC5VUkwgfHwgZC5fVVJMIHx8IChkLmhvc3QgJiYgZC5ob3N0LmxvY2FsTmFtZSkpIHx8ICcnOw0KICAgICAgICAgIHUgPSB1LnNwbGl0KCcvPycpLnNoaWZ0KCkuc3BsaXQoJy8nKS5wb3AoKTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbnMgKCVkKSBbJXNdJywgbXV0YXRpb25zLmxlbmd0aCwgdSB8fCAnJyk7DQogIH0NCiAgLy8NCiAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24obXgpIHsNCiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbicpOw0KICAgIGlmIChteC50eXBlID09PSAnY2hpbGRMaXN0Jykgew0KICAgICAgZm9yRWFjaChteC5hZGRlZE5vZGVzLCBmdW5jdGlvbihuKSB7DQogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsNCiAgICAgICAgaWYgKGZpbHRlcihuKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICAvLyB3YXRjaCBzaGFkb3ctcm9vdHMgb24gbm9kZXMgdGhhdCBoYXZlIGhhZCB0aGVtIGF0dGFjaGVkIG1hbnVhbGx5DQogICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlbW92ZSBpZiBjcmVhdGVTaGFkb3dSb290IGlzIG92ZXJyaWRkZW4NCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlZCBhcyBhbiBvcHRpbWl6YXRpb24sIG1hbnVhbCBzaGFkb3cgcm9vdHMNCiAgICAgICAgLy8gbXVzdCBiZSB3YXRjaGVkIGV4cGxpY2l0bHkNCiAgICAgICAgLy93YXRjaEFsbFNoYWRvd3Mobik7DQogICAgICAgIC8vIG5vZGVzIGFkZGVkIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50DQogICAgICAgIGFkZGVkTm9kZShuKTsNCiAgICAgIH0pOw0KICAgICAgLy8gcmVtb3ZlZCBub2RlcyBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudA0KICAgICAgZm9yRWFjaChteC5yZW1vdmVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOw0KICAgICAgICBpZiAoZmlsdGVyKG4pKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIHJlbW92ZWROb2RlKG4pOw0KICAgICAgfSk7DQogICAgfQ0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgfSk7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9Ow0KDQp2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihoYW5kbGVyKTsNCg0KZnVuY3Rpb24gdGFrZVJlY29yZHMoKSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IGFzayBSYWYgd2h5IHdlIGhhdmUgdG8gY2FsbCBoYW5kbGVyIG91cnNlbHZlcw0KICBoYW5kbGVyKG9ic2VydmVyLnRha2VSZWNvcmRzKCkpOw0KfQ0KDQp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7DQoNCmZ1bmN0aW9uIG9ic2VydmUoaW5Sb290KSB7DQogIG9ic2VydmVyLm9ic2VydmUoaW5Sb290LCB7Y2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlfSk7DQp9DQoNCmZ1bmN0aW9uIG9ic2VydmVEb2N1bWVudChkb2N1bWVudCkgew0KICBvYnNlcnZlKGRvY3VtZW50KTsNCn0NCg0KZnVuY3Rpb24gdXBncmFkZURvY3VtZW50KGRvY3VtZW50KSB7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCd1cGdyYWRlRG9jdW1lbnQ6ICcsIChkb2N1bWVudC5VUkwgfHwgZG9jdW1lbnQuX1VSTCB8fCAnJykuc3BsaXQoJy8nKS5wb3AoKSk7DQogIGFkZGVkTm9kZShkb2N1bWVudCk7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9DQoNCi8vIGV4cG9ydHMNCg0Kc2NvcGUud2F0Y2hTaGFkb3cgPSB3YXRjaFNoYWRvdzsNCnNjb3BlLndhdGNoQWxsU2hhZG93cyA9IHdhdGNoQWxsU2hhZG93czsNCg0Kc2NvcGUudXBncmFkZUFsbCA9IGFkZGVkTm9kZTsNCnNjb3BlLnVwZ3JhZGVTdWJ0cmVlID0gYWRkZWRTdWJ0cmVlOw0KDQpzY29wZS5vYnNlcnZlRG9jdW1lbnQgPSBvYnNlcnZlRG9jdW1lbnQ7DQpzY29wZS51cGdyYWRlRG9jdW1lbnQgPSB1cGdyYWRlRG9jdW1lbnQ7DQoNCnNjb3BlLnRha2VSZWNvcmRzID0gdGFrZVJlY29yZHM7DQoNCn0pKHdpbmRvdy5DdXN0b21FbGVtZW50cyk7DQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbigpewogIAp2YXIgSFRNTEVsZW1lbnRFbGVtZW50ID0gZnVuY3Rpb24oaW5FbGVtZW50KSB7CiAgaW5FbGVtZW50LnJlZ2lzdGVyID0gSFRNTEVsZW1lbnRFbGVtZW50LnByb3RvdHlwZS5yZWdpc3RlcjsKICBwYXJzZUVsZW1lbnRFbGVtZW50KGluRWxlbWVudCk7CiAgcmV0dXJuIGluRWxlbWVudDsKfTsKCkhUTUxFbGVtZW50RWxlbWVudC5wcm90b3R5cGUgPSB7CiAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGluTW9yZSkgewogICAgaWYgKGluTW9yZSkgewogICAgICB0aGlzLm9wdGlvbnMubGlmZWN5Y2xlID0gaW5Nb3JlLmxpZmVjeWNsZTsKICAgICAgaWYgKGluTW9yZS5wcm90b3R5cGUpIHsKICAgICAgICBtaXhpbih0aGlzLm9wdGlvbnMucHJvdG90eXBlLCBpbk1vcmUucHJvdG90eXBlKTsKICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIHBhcnNlRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50KSB7CiAgLy8gb3B0aW9ucyB0byBnbGVhbiBmcm9tIGluRWxlbWVudCBhdHRyaWJ1dGVzCiAgdmFyIG9wdGlvbnMgPSB7CiAgICBuYW1lOiAnJywKICAgIGV4dGVuZHM6IG51bGwKICB9OwogIC8vIGdsZWFuIHRoZW0KICB0YWtlQXR0cmlidXRlcyhpbkVsZW1lbnQsIG9wdGlvbnMpOwogIC8vIGRlZmF1bHQgYmFzZQogIHZhciBiYXNlID0gSFRNTEVsZW1lbnQucHJvdG90eXBlOwogIC8vIG9wdGlvbmFsIHNwZWNpZmllZCBiYXNlCiAgaWYgKG9wdGlvbnMuZXh0ZW5kcykgewogICAgLy8gYnVpbGQgYW4gaW5zdGFuY2Ugb2Ygb3B0aW9ucy5leHRlbmRzCiAgICB2YXIgYXJjaGV0eXBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChvcHRpb25zLmV4dGVuZHMpOwogICAgLy8gYWNxdWlyZSB0aGUgcHJvdG90eXBlCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBfX3Byb3RvX18gbWF5IGJlIGhpbnRlZCBieSB0aGUgY3VzdG9tIGVsZW1lbnQKICAgIC8vIHN5c3RlbSBvbiBwbGF0Zm9ybXMgdGhhdCBkb24ndCBzdXBwb3J0IG5hdGl2ZSBfX3Byb3RvX18KICAgIC8vIG9uIHRob3NlIHBsYXRmb3JtcyB0aGUgQVBJIGlzIG1peGVkIGludG8gYXJjaGV0eXBlIGFuZCB0aGUKICAgIC8vIGVmZmVjdGl2ZSBiYXNlIGlzIG5vdCBhcmNoZXR5cGUncyByZWFsIHByb3RvdHlwZQogICAgYmFzZSA9IGFyY2hldHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKGFyY2hldHlwZSk7CiAgfQogIC8vIGV4dGVuZCBiYXNlCiAgb3B0aW9ucy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGJhc2UpOwogIC8vIGluc3RhbGwgb3B0aW9ucwogIGluRWxlbWVudC5vcHRpb25zID0gb3B0aW9uczsKICAvLyBsb2NhdGUgdXNlciBzY3JpcHQKICB2YXIgc2NyaXB0ID0gaW5FbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdCxzY3JpcHRzJyk7CiAgaWYgKHNjcmlwdCkgewogICAgLy8gZXhlY3V0ZSB1c2VyIHNjcmlwdCBpbiAnaW5FbGVtZW50JyBjb250ZXh0CiAgICBleGVjdXRlQ29tcG9uZW50U2NyaXB0KHNjcmlwdC50ZXh0Q29udGVudCwgaW5FbGVtZW50LCBvcHRpb25zLm5hbWUpOwogIH07CiAgLy8gcmVnaXN0ZXIgb3VyIG5ldyBlbGVtZW50CiAgdmFyIGN0b3IgPSBkb2N1bWVudC5yZWdpc3RlcihvcHRpb25zLm5hbWUsIG9wdGlvbnMpOwogIGluRWxlbWVudC5jdG9yID0gY3RvcjsKICAvLyBzdG9yZSBvcHRpb25hbCBjb25zdHJ1Y3RvciByZWZlcmVuY2UKICB2YXIgcmVmTmFtZSA9IGluRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NvbnN0cnVjdG9yJyk7CiAgaWYgKHJlZk5hbWUpIHsKICAgIHdpbmRvd1tyZWZOYW1lXSA9IGN0b3I7CiAgfQp9CiAgCi8vIGVhY2ggcHJvcGVydHkgaW4gaW5EaWN0aW9uYXJ5IHRha2VzIGEgdmFsdWUKLy8gZnJvbSB0aGUgbWF0Y2hpbmcgYXR0cmlidXRlIGluIGluRWxlbWVudCwgaWYgYW55CmZ1bmN0aW9uIHRha2VBdHRyaWJ1dGVzKGluRWxlbWVudCwgaW5EaWN0aW9uYXJ5KSB7CiAgZm9yICh2YXIgbiBpbiBpbkRpY3Rpb25hcnkpIHsKICAgIHZhciBhID0gaW5FbGVtZW50LmF0dHJpYnV0ZXNbbl07CiAgICBpZiAoYSkgewogICAgICBpbkRpY3Rpb25hcnlbbl0gPSBhLnZhbHVlOwogICAgfQogIH0KfQoKLy8gaW52b2tlIGluU2NyaXB0IGluIGluQ29udGV4dCBzY29wZQpmdW5jdGlvbiBleGVjdXRlQ29tcG9uZW50U2NyaXB0KGluU2NyaXB0LCBpbkNvbnRleHQsIGluTmFtZSkgewogIC8vIHNldCAoaGlnaGxhbmRlcikgY29udGV4dAogIGNvbnRleHQgPSBpbkNvbnRleHQ7CiAgLy8gc291cmNlIGxvY2F0aW9uCiAgdmFyIG93bmVyID0gY29udGV4dC5vd25lckRvY3VtZW50OwogIHZhciB1cmwgPSAob3duZXIuX1VSTCB8fCBvd25lci5VUkwgfHwgb3duZXIuaW1wbCAKICAgICAgJiYgKG93bmVyLmltcGwuX1VSTCB8fCBvd25lci5pbXBsLlVSTCkpOwogIC8vIGVuc3VyZSB0aGUgY29tcG9uZW50IGhhcyBhIHVuaXF1ZSBzb3VyY2UgbWFwIHNvIGl0IGNhbiBiZSBkZWJ1Z2dlZAogIC8vIGlmIHRoZSBuYW1lIG1hdGNoZXMgdGhlIGZpbGVuYW1lIHBhcnQgb2YgdGhlIG93bmluZyBkb2N1bWVudCdzIHVybCwKICAvLyB1c2UgdGhpcywgb3RoZXJ3aXNlLCBhZGQgIjo8bmFtZT4iIHRvIHRoZSBkb2N1bWVudCB1cmwuCiAgdmFyIG1hdGNoID0gdXJsLm1hdGNoKC8uKlwvKFteLl0qKVsuXT8uKiQvKTsKICBpZiAobWF0Y2gpIHsKICAgIHZhciBuYW1lID0gbWF0Y2hbMV07CiAgICB1cmwgKz0gbmFtZSAhPSBpbk5hbWUgPyAnOicgKyBpbk5hbWUgOiAnJzsKICB9CiAgLy8gY29tcG9zZSBzY3JpcHQKICB2YXIgY29kZSA9ICJfX2NvbXBvbmVudFNjcmlwdCgnIgogICAgKyBpbk5hbWUKICAgICsgIicsIGZ1bmN0aW9uKCl7IgogICAgKyBpblNjcmlwdAogICAgKyAifSk7IgogICAgKyAiXG4vL0Agc291cmNlVVJMPSIgKyB1cmwgKyAiXG4iCiAgOwogIC8vIGluamVjdCBzY3JpcHQKICBldmFsKGNvZGUpOwp9Cgp2YXIgY29udGV4dDsKCi8vIGdsb2JhbCBuZWNlc3NhcnkgZm9yIHNjcmlwdCBpbmplY3Rpb24Kd2luZG93Ll9fY29tcG9uZW50U2NyaXB0ID0gZnVuY3Rpb24oaW5OYW1lLCBpbkZ1bmMpIHsKICBpbkZ1bmMuY2FsbChjb250ZXh0KTsKfTsKCi8vIHV0aWxpdHkKCi8vIGNvcHkgYWxsIHByb3BlcnRpZXMgZnJvbSBpblByb3BzIChldCBhbCkgdG8gaW5PYmoKZnVuY3Rpb24gbWl4aW4oaW5PYmovKiwgaW5Qcm9wcywgaW5Nb3JlUHJvcHMsIC4uLiovKSB7CiAgdmFyIG9iaiA9IGluT2JqIHx8IHt9OwogIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgcCA9IGFyZ3VtZW50c1tpXTsKICAgIHRyeSB7CiAgICAgIGZvciAodmFyIG4gaW4gcCkgewogICAgICAgIGNvcHlQcm9wZXJ0eShuLCBwLCBvYmopOwogICAgICB9CiAgICB9IGNhdGNoKHgpIHsKICAgIH0KICB9CiAgcmV0dXJuIG9iajsKfQoKLy8gY29weSBwcm9wZXJ0eSBpbk5hbWUgZnJvbSBpblNvdXJjZSBvYmplY3QgdG8gaW5UYXJnZXQgb2JqZWN0CmZ1bmN0aW9uIGNvcHlQcm9wZXJ0eShpbk5hbWUsIGluU291cmNlLCBpblRhcmdldCkgewogIHZhciBwZCA9IGdldFByb3BlcnR5RGVzY3JpcHRvcihpblNvdXJjZSwgaW5OYW1lKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW5UYXJnZXQsIGluTmFtZSwgcGQpOwp9CgovLyBnZXQgcHJvcGVydHkgZGVzY3JpcHRvciBmb3IgaW5OYW1lIG9uIGluT2JqZWN0LCBldmVuIGlmCi8vIGluTmFtZSBleGlzdHMgb24gc29tZSBsaW5rIGluIGluT2JqZWN0J3MgcHJvdG90eXBlIGNoYWluCmZ1bmN0aW9uIGdldFByb3BlcnR5RGVzY3JpcHRvcihpbk9iamVjdCwgaW5OYW1lKSB7CiAgaWYgKGluT2JqZWN0KSB7CiAgICB2YXIgcGQgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGluT2JqZWN0LCBpbk5hbWUpOwogICAgcmV0dXJuIHBkIHx8IGdldFByb3BlcnR5RGVzY3JpcHRvcihPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5PYmplY3QpLCBpbk5hbWUpOwogIH0KfQoKLy8gZXhwb3J0cwoKd2luZG93LkhUTUxFbGVtZW50RWxlbWVudCA9IEhUTUxFbGVtZW50RWxlbWVudDsKLy8gVE9ETyhzam1pbGVzKTogY29tcGxldGVseSBhZC1ob2MsIHVzZWQgYnkgUG9seW1lci5yZWdpc3Rlcgp3aW5kb3cubWl4aW4gPSBtaXhpbjsKCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKCkgewoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIGNvbXBvbmVudFBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdsaW5rW3JlbD1zdHlsZXNoZWV0XScsCiAgICAnc2NyaXB0W3NyY10nLAogICAgJ3NjcmlwdCcsCiAgICAnc3R5bGUnLAogICAgJ2VsZW1lbnQnCiAgXSwKICBtYXA6IHsKICAgIGxpbms6ICdwYXJzZUxpbmsnLAogICAgc2NyaXB0OiAncGFyc2VTY3JpcHQnLAogICAgZWxlbWVudDogJ3BhcnNlRWxlbWVudCcsCiAgICBzdHlsZTogJ3BhcnNlU3R5bGUnCiAgfSwKICBwYXJzZTogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgaWYgKCFpbkRvY3VtZW50Ll9fcGFyc2VkKSB7CiAgICAgIC8vIG9ubHkgcGFyc2Ugb25jZQogICAgICBpbkRvY3VtZW50Ll9fcGFyc2VkID0gdHJ1ZTsKICAgICAgLy8gYWxsIHBhcnNhYmxlIGVsZW1lbnRzIGluIGluRG9jdW1lbnQgKGRlcHRoLWZpcnN0IHByZS1vcmRlciB0cmF2ZXJzYWwpCiAgICAgIHZhciBlbHRzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGNwLnNlbGVjdG9ycyk7CiAgICAgIC8vIGZvciBlYWNoIHBhcnNhYmxlIG5vZGUgdHlwZSwgY2FsbCB0aGUgbWFwcGVkIHBhcnNpbmcgbWV0aG9kCiAgICAgIGZvckVhY2goZWx0cywgZnVuY3Rpb24oZSkgewogICAgICAgIC8vY29uc29sZS5sb2cobWFwW2UubG9jYWxOYW1lXSArICI6IiwgcGF0aC5ub2RlVXJsKGUpKTsKICAgICAgICBjcFtjcC5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICAgIC8vIHVwZ3JhZGUgYWxsIHVwZ3JhZGVhYmxlIHN0YXRpYyBlbGVtZW50cywgYW55dGhpbmcgZHluYW1pY2FsbHkKICAgICAgLy8gY3JlYXRlZCBzaG91bGQgYmUgY2F1Z2h0IGJ5IG9ic2VydmVyCiAgICAgIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgICAgLy8gb2JzZXJ2ZSBkb2N1bWVudCBmb3IgZG9tIGNoYW5nZXMKICAgICAgQ3VzdG9tRWxlbWVudHMub2JzZXJ2ZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgfQogIH0sCiAgcGFyc2VMaW5rOiBmdW5jdGlvbihpbkxpbmtFbHQpIHsKICAgIC8vIGltcG9ydHMKICAgIGlmIChpc0RvY3VtZW50TGluayhpbkxpbmtFbHQpKSB7CiAgICAgIGlmIChpbkxpbmtFbHQuY29udGVudCkgewogICAgICAgIGNwLnBhcnNlKGluTGlua0VsdC5jb250ZW50KTsKICAgICAgfQogICAgfSBlbHNlIGlmICghaW5NYWluRG9jdW1lbnQoaW5MaW5rRWx0KQogICAgICAgICYmIGluTGlua0VsdC5wYXJlbnROb2RlCiAgICAgICAgJiYgIWlzRWxlbWVudEVsZW1lbnRDaGlsZChpbkxpbmtFbHQpKSB7CiAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoaW5MaW5rRWx0KTsKICAgIH0KICB9LAogIHBhcnNlU2NyaXB0OiBmdW5jdGlvbihpblNjcmlwdEVsdCkgewogICAgLy8gaWdub3JlIHNjcmlwdHMgaW4gcHJpbWFyeSBkb2N1bWVudCwgdGhleSBhcmUgYWxyZWFkeSBsb2FkZWQKICAgIGlmIChpbk1haW5Eb2N1bWVudChpblNjcmlwdEVsdCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gaWdub3JlIHNjcmlwdHMgaW5zaWRlIDxlbGVtZW50PgogICAgaWYgKGlzRWxlbWVudEVsZW1lbnRDaGlsZChpblNjcmlwdEVsdCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gb3RoZXJ3aXNlLCBldmFsdWF0ZSBub3cKICAgIHZhciBjb2RlID0gaW5TY3JpcHRFbHQuX19yZXNvdXJjZSB8fCBpblNjcmlwdEVsdC50ZXh0Q29udGVudDsKICAgIGlmIChjb2RlKSB7CiAgICAgIGNvZGUgKz0gIlxuLy9AIHNvdXJjZVVSTD0iICsgaW5TY3JpcHRFbHQuX19ub2RlVXJsICsgIlxuIjsKICAgICAgZXZhbC5jYWxsKHdpbmRvdywgY29kZSk7CiAgICB9CiAgfSwKICBwYXJzZVN0eWxlOiBmdW5jdGlvbihpblN0eWxlRWx0KSB7CiAgICBpZiAoIWluTWFpbkRvY3VtZW50KGluU3R5bGVFbHQpICYmICFpc0VsZW1lbnRFbGVtZW50Q2hpbGQoaW5TdHlsZUVsdCkpIHsKICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZCcpLmFwcGVuZENoaWxkKGluU3R5bGVFbHQpOwogICAgfQogIH0sCiAgcGFyc2VFbGVtZW50OiBmdW5jdGlvbihpbkVsZW1lbnRFbHQpIHsKICAgIG5ldyBIVE1MRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50RWx0KTsKICB9Cn07Cgp2YXIgY3AgPSBjb21wb25lbnRQYXJzZXI7CgpmdW5jdGlvbiBpbk1haW5Eb2N1bWVudChpbkVsdCkgewogIHJldHVybiBpbkVsdC5vd25lckRvY3VtZW50ID09PSBkb2N1bWVudCB8fAogICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICBpbkVsdC5vd25lckRvY3VtZW50LmltcGwgPT09IGRvY3VtZW50Owp9CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhpbkVsdCkgewogIHJldHVybiAoaW5FbHQubG9jYWxOYW1lID09PSAnbGluaycKICAgICAgJiYgaW5FbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gSU1QT1JUX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzRWxlbWVudEVsZW1lbnRDaGlsZChpbkVsdCkgewogIGlmIChpbkVsdC5wYXJlbnROb2RlICYmIGluRWx0LnBhcmVudE5vZGUubG9jYWxOYW1lID09PSAnZWxlbWVudCcpIHsKICAgIHJldHVybiB0cnVlOwogIH0KfQoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKQ3VzdG9tRWxlbWVudHMucGFyc2VyID0gY29tcG9uZW50UGFyc2VyOwoKfSkoKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAgcGFyc2luZwoKLy8gSUUgc2hpbSBmb3IgQ3VzdG9tRXZlbnQKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9CgpmdW5jdGlvbiBib290c3RyYXAoKSB7CiAgLy8gZ28gYXN5bmMgc28gY2FsbCBzdGFjayBjYW4gdW53aW5kCiAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgIC8vIHBhcnNlIGRvY3VtZW50CiAgICBDdXN0b21FbGVtZW50cy5wYXJzZXIucGFyc2UoZG9jdW1lbnQpOwogICAgLy8gc2V0IGludGVybmFsIGZsYWcKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5ID0gdHJ1ZTsKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgaWYgKHdpbmRvdy5IVE1MSW1wb3J0cykgewogICAgICBDdXN0b21FbGVtZW50cy5lbGFwc2VkID0gQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lIC0gSFRNTEltcG9ydHMucmVhZHlUaW1lOwogICAgfQogICAgLy8gbm90aWZ5IHN5c3RlbQogICAgZG9jdW1lbnQuYm9keS5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ1dlYkNvbXBvbmVudHNSZWFkeScsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSwgMCk7Cn0KCi8vIFRPRE8oc2ptaWxlcyk6ICd3aW5kb3cnIGhhcyBubyB3cmFwcGFiaWxpdHkgdW5kZXIgU2hhZG93RE9NIHBvbHlmaWxsLCBzbwovLyB3ZSBhcmUgZm9yY2VkIHRvIHNwbGl0IGludG8gdHdvIHZlcnNpb25zCgppZiAod2luZG93LkhUTUxJbXBvcnRzKSB7CiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignSFRNTEltcG9ydHNMb2FkZWQnLCBib290c3RyYXApOwp9IGVsc2UgewogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgYm9vdHN0cmFwKTsKfQoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpIHsKCi8vIGluamVjdCBzdHlsZSBzaGVldApkb2N1bWVudC53cml0ZSgnPHN0eWxlPmVsZW1lbnQge2Rpc3BsYXk6IG5vbmU7fSAvKiBpbmplY3RlZCBieSBwbGF0Zm9ybS5qcyAqLzwvc3R5bGU+Jyk7CgppZiAod2luZG93LlNoYWRvd0RPTVBvbHlmaWxsKSB7CgogIGZ1bmN0aW9uIG5vcCgpIHt9OwoKICAvLyBkaXNhYmxlIHNoYWRvdyBkb20gd2F0Y2hpbmcKICBDdXN0b21FbGVtZW50cy53YXRjaFNoYWRvdyA9IG5vcDsKICBDdXN0b21FbGVtZW50cy53YXRjaEFsbFNoYWRvd3MgPSBub3A7CgogIC8vIGVuc3VyZSB3cmFwcGVkIGlucHV0cyBmb3IgdGhlc2UgZnVuY3Rpb25zCiAgdmFyIGZucyA9IFsndXBncmFkZUFsbCcsICd1cGdyYWRlU3VidHJlZScsICdvYnNlcnZlRG9jdW1lbnQnLAogICAgICAndXBncmFkZURvY3VtZW50J107CgogIC8vIGNhY2hlIG9yaWdpbmFscwogIHZhciBvcmlnaW5hbCA9IHt9OwogIGZucy5mb3JFYWNoKGZ1bmN0aW9uKGZuKSB7CiAgICBvcmlnaW5hbFtmbl0gPSBDdXN0b21FbGVtZW50c1tmbl07CiAgfSk7CgogIC8vIG92ZXJyaWRlCiAgZm5zLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKICAgIEN1c3RvbUVsZW1lbnRzW2ZuXSA9IGZ1bmN0aW9uKGluTm9kZSkgewogICAgICByZXR1cm4gb3JpZ2luYWxbZm5dKHdyYXAoaW5Ob2RlKSk7CiAgICB9OwogIH0pOwoKfQoKfSkoKTsKCihmdW5jdGlvbiAoKSB7CgovKioqIFZhcmlhYmxlcyAqKiovCgogIHZhciB3aW4gPSB3aW5kb3csCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIG5vb3AgPSBmdW5jdGlvbigpe30sCiAgICByZWdleFBzZXVkb1NwbGl0ID0gLyhcdysoPzpcKFteXCldK1wpKT8pL2csCiAgICByZWdleFBzZXVkb1JlcGxhY2UgPSAvKFx3KikoPzpcKChbXlwpXSopXCkpPy8sCiAgICByZWdleERpZ2l0cyA9IC8oXGQrKS9nLAogICAga2V5cHNldWRvID0gewogICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIHBzZXVkby52YWx1ZS5tYXRjaChyZWdleERpZ2l0cykuaW5kZXhPZihTdHJpbmcoZXZlbnQua2V5Q29kZSkpID4gLTEgPT0gKHBzZXVkby5uYW1lID09ICdrZXlwYXNzJyk7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaXggPSAoZnVuY3Rpb24gKCkgewogICAgICB2YXIgc3R5bGVzID0gd2luLmdldENvbXB1dGVkU3R5bGUoZG9jLmRvY3VtZW50RWxlbWVudCwgJycpLAogICAgICAgICAgcHJlID0gKEFycmF5LnByb3RvdHlwZS5zbGljZQogICAgICAgICAgICAuY2FsbChzdHlsZXMpCiAgICAgICAgICAgIC5qb2luKCcnKQogICAgICAgICAgICAubWF0Y2goLy0obW96fHdlYmtpdHxtcyktLykgfHwgKHN0eWxlcy5PTGluayA9PT0gJycgJiYgWycnLCAnbyddKQogICAgICAgICAgKVsxXTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkb206IHByZSA9PSAnbXMnID8gcHJlLnRvVXBwZXJDYXNlKCkgOiBwcmUsCiAgICAgICAgbG93ZXJjYXNlOiBwcmUsCiAgICAgICAgY3NzOiAnLScgKyBwcmUgKyAnLScsCiAgICAgICAganM6IHByZVswXS50b1VwcGVyQ2FzZSgpICsgcHJlLnN1YnN0cigxKQogICAgICB9OwoKICAgIH0pKCksCiAgICBtYXRjaFNlbGVjdG9yID0gRWxlbWVudC5wcm90b3R5cGUubWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlW3ByZWZpeC5sb3dlcmNhc2UgKyAnTWF0Y2hlc1NlbGVjdG9yJ107CgovKioqIEZ1bmN0aW9ucyAqKiovCgovLyBVdGlsaXRpZXMKCiAgdmFyIHR5cGVPYmogPSB7fTsKICBmdW5jdGlvbiB0eXBlT2Yob2JqKSB7CiAgICByZXR1cm4gdHlwZU9iai50b1N0cmluZy5jYWxsKG9iaikubWF0Y2goL1xzKFthLXpBLVpdKykvKVsxXS50b0xvd2VyQ2FzZSgpOwogIH0KCiAgZnVuY3Rpb24gY2xvbmUoaXRlbSwgdHlwZSl7CiAgICB2YXIgZm4gPSBjbG9uZVt0eXBlIHx8IHR5cGVPZihpdGVtKV07CiAgICByZXR1cm4gZm4gPyBmbihpdGVtKSA6IGl0ZW07CiAgfQogICAgY2xvbmUub2JqZWN0ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIG9iaiA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gc3JjKSBvYmpba2V5XSA9IGNsb25lKHNyY1trZXldKTsKICAgICAgcmV0dXJuIG9iajsKICAgIH07CiAgICBjbG9uZS5hcnJheSA9IGZ1bmN0aW9uKHNyYyl7CiAgICAgIHZhciBpID0gc3JjLmxlbmd0aCwgYXJyYXkgPSBuZXcgQXJyYXkoaSk7CiAgICAgIHdoaWxlIChpLS0pIGFycmF5W2ldID0gY2xvbmUoc3JjW2ldKTsKICAgICAgcmV0dXJuIGFycmF5OwogICAgfTsKCiAgdmFyIHVuc2xpY2VhYmxlID0gWydudW1iZXInLCAnYm9vbGVhbicsICdzdHJpbmcnLCAnZnVuY3Rpb24nXTsKICBmdW5jdGlvbiB0b0FycmF5KG9iail7CiAgICByZXR1cm4gdW5zbGljZWFibGUuaW5kZXhPZih0eXBlT2Yob2JqKSkgPT0gLTEgPwogICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwob2JqLCAwKSA6CiAgICBbb2JqXTsKICB9CgovLyBET00KICB2YXIgc3RyID0gJyc7CiAgZnVuY3Rpb24gcXVlcnkoZWxlbWVudCwgc2VsZWN0b3IpewogICAgcmV0dXJuIChzZWxlY3RvciB8fCBzdHIpLmxlbmd0aCA/IHRvQXJyYXkoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSkgOiBbXTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlTXV0YXRpb25zKGVsZW1lbnQsIG11dGF0aW9ucykgewogICAgdmFyIGRpZmYgPSB7IGFkZGVkOiBbXSwgcmVtb3ZlZDogW10gfTsKICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgIHJlY29yZC5fbXV0YXRpb24gPSB0cnVlOwogICAgICBmb3IgKHZhciB6IGluIGRpZmYpIHsKICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQuX3JlY29yZHNbKHogPT0gJ2FkZGVkJykgPyAnaW5zZXJ0ZWQnIDogJ3JlbW92ZWQnXSwKICAgICAgICAgIG5vZGVzID0gcmVjb3JkW3ogKyAnTm9kZXMnXSwgbGVuZ3RoID0gbm9kZXMubGVuZ3RoOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoICYmIGRpZmZbel0uaW5kZXhPZihub2Rlc1tpXSkgPT0gLTE7IGkrKyl7CiAgICAgICAgICBkaWZmW3pdLnB1c2gobm9kZXNbaV0pOwogICAgICAgICAgdHlwZS5mb3JFYWNoKGZ1bmN0aW9uKGZuKXsKICAgICAgICAgICAgZm4obm9kZXNbaV0sIHJlY29yZCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KCi8vIE1peGlucwoKICBmdW5jdGlvbiBtZXJnZU9uZShzb3VyY2UsIGtleSwgY3VycmVudCl7CiAgICB2YXIgdHlwZSA9IHR5cGVPZihjdXJyZW50KTsKICAgIGlmICh0eXBlID09ICdvYmplY3QnICYmIHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIHh0YWcubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwogICAgZWxzZSBzb3VyY2Vba2V5XSA9IGNsb25lKGN1cnJlbnQsIHR5cGUpOwogICAgcmV0dXJuIHNvdXJjZTsKICB9CgogIGZ1bmN0aW9uIG1lcmdlTWl4aW4odHlwZSwgbWl4aW4sIG9wdGlvbikgewogICAgdmFyIG9yaWdpbmFsID0ge307CiAgICBmb3IgKHZhciBvIGluIG9wdGlvbikgb3JpZ2luYWxbby5zcGxpdCgnOicpWzBdXSA9IHRydWU7CiAgICBmb3IgKHZhciB4IGluIG1peGluKSBpZiAoIW9yaWdpbmFsW3guc3BsaXQoJzonKVswXV0pIG9wdGlvblt4XSA9IG1peGluW3hdOwogIH0KCiAgZnVuY3Rpb24gYXBwbHlNaXhpbnModGFnKSB7CiAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdmFyIG1peGluID0geHRhZy5taXhpbnNbbmFtZV07CiAgICAgIGZvciAodmFyIHR5cGUgaW4gbWl4aW4pIHsKICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgIGNhc2UgJ2xpZmVjeWNsZSc6IGNhc2UgJ21ldGhvZHMnOgogICAgICAgICAgICBtZXJnZU1peGluKHR5cGUsIG1peGluW3R5cGVdLCB0YWdbdHlwZV0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2FjY2Vzc29ycyc6IGNhc2UgJ3Byb3RvdHlwZSc6CiAgICAgICAgICAgIGZvciAodmFyIHogaW4gbWl4aW5bdHlwZV0pIG1lcmdlTWl4aW4oeiwgbWl4aW5bdHlwZV0sIHRhZy5hY2Nlc3NvcnMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2V2ZW50cyc6CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gdGFnOwogIH0KCi8vIEFjY2Vzc29ycwoKICBmdW5jdGlvbiBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIHN5bmMpewogICAgdmFyIGtleSA9IHouc3BsaXQoJzonKSwgdHlwZSA9IGtleVswXTsKICAgIGlmICh0eXBlID09ICdnZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0geHRhZy5hcHBseVBzZXVkb3Moa2V5LmpvaW4oJzonKSwgYWNjZXNzb3Jbel0sIHRhZy5wc2V1ZG9zKTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT0gJ3NldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhdHRyID8gZnVuY3Rpb24odmFsdWUpewogICAgICAgIHN5bmMuY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgIH0gOiBhY2Nlc3Nvclt6XSwgdGFnLnBzZXVkb3MpOwogICAgfQogICAgZWxzZSB0YWcucHJvdG90eXBlW3Byb3BdW3pdID0gYWNjZXNzb3Jbel07CiAgfQoKICBmdW5jdGlvbiBwYXJzZUFjY2Vzc29yKHRhZywgcHJvcCl7CiAgICB0YWcucHJvdG90eXBlW3Byb3BdID0ge307CiAgICB2YXIgYWNjZXNzb3IgPSB0YWcuYWNjZXNzb3JzW3Byb3BdLAogICAgICAgIGF0dHIgPSBhY2Nlc3Nvci5hdHRyaWJ1dGUsCiAgICAgICAgbmFtZSA9IGF0dHIgJiYgYXR0ci5uYW1lID8gYXR0ci5uYW1lLnRvTG93ZXJDYXNlKCkgOiBwcm9wLAogICAgICAgIHN5bmMgPSBudWxsOwoKICAgIGlmIChhdHRyKSB7CiAgICAgIHRhZy5hdHRyaWJ1dGVzW25hbWVdID0gYXR0cjsKICAgICAgdGFnLmF0dHJpYnV0ZXNbbmFtZV0uc2V0dGVyID0gcHJvcDsKICAgICAgc3luYyA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICB2YXIgbm9kZSA9IHRoaXMueHRhZy5hdHRyaWJ1dGVOb2Rlc1tuYW1lXTsKICAgICAgICBpZiAoIW5vZGUgfHwgKG5vZGUgIT0gdGhpcyAmJiAhbm9kZS5wYXJlbnROb2RlKSkgewogICAgICAgICAgbm9kZSA9IHRoaXMueHRhZy5hdHRyaWJ1dGVOb2Rlc1tuYW1lXSA9IGF0dHIucHJvcGVydHkgPyB0aGlzLnh0YWdbYXR0ci5wcm9wZXJ0eV0gOiBhdHRyLnNlbGVjdG9yID8gdGhpcy5xdWVyeVNlbGVjdG9yKGF0dHIuc2VsZWN0b3IpIDogdGhpczsKICAgICAgICB9CiAgICAgICAgdmFyIHZhbCA9IGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUsCiAgICAgICAgICAgIG1ldGhvZCA9IChhdHRyLmJvb2xlYW4gJiYgKHZhbHVlID09PSBmYWxzZSB8fCB2YWx1ZSA9PT0gbnVsbCkpID8gJ3JlbW92ZUF0dHJpYnV0ZScgOiB2YWx1ZSA9PT0gbnVsbCA/ICdyZW1vdmVBdHRyaWJ1dGUnIDogJ3NldEF0dHJpYnV0ZSc7CiAgICAgICAgaWYgKHZhbHVlICE9IChhdHRyLmJvb2xlYW4gPyB0aGlzLmhhc0F0dHJpYnV0ZShuYW1lKSA6IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpKSkgdGhpc1ttZXRob2RdKG5hbWUsIHZhbCwgdHJ1ZSk7CiAgICAgICAgaWYgKG5vZGUgJiYgbm9kZSAhPSB0aGlzICYmICh2YWx1ZSAhPSAoYXR0ci5ib29sZWFuID8gbm9kZS5oYXNBdHRyaWJ1dGUobmFtZSkgOiBub2RlLmdldEF0dHJpYnV0ZShuYW1lKSkpKSBub2RlW21ldGhvZF0obmFtZSwgdmFsLCB0cnVlKTsKICAgICAgfTsKICAgIH0KCiAgICBmb3IgKHZhciB6IGluIGFjY2Vzc29yKSBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIHN5bmMpOwoKICAgIGlmIChhdHRyKSB7CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQpIHsKICAgICAgICB2YXIgbWV0aG9kID0gKGF0dHIuYm9vbGVhbiA/ICdoYXMnIDogJ2dldCcpICsgJ0F0dHJpYnV0ZSc7CiAgICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIHRoaXNbbWV0aG9kXShuYW1lKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQpIHRhZy5wcm90b3R5cGVbcHJvcF0uc2V0ID0gc3luYzsKICAgIH0KCiAgfQoKLy8gRXZlbnRzCgogIGZ1bmN0aW9uIHRvdWNoRmlsdGVyKGN1c3RvbSwgZXZlbnQpIHsKICAgIGlmIChjdXN0b20ubGlzdGVuZXIudG91Y2hlZCkgcmV0dXJuIGN1c3RvbS5saXN0ZW5lci50b3VjaGVkID0gZmFsc2U7CiAgICBlbHNlIHsKICAgICAgaWYgKGV2ZW50LnR5cGUubWF0Y2goJ3RvdWNoJykpIGN1c3RvbS5saXN0ZW5lci50b3VjaGVkID0gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUZsb3dFdmVudCh0eXBlKSB7CiAgICB2YXIgZmxvdyA9IHR5cGUgPT0gJ292ZXInOwogICAgcmV0dXJuIHsKICAgICAgYmFzZTogJ092ZXJmbG93RXZlbnQnIGluIHdpbiA/ICdvdmVyZmxvd2NoYW5nZWQnIDogdHlwZSArICdmbG93JywKICAgICAgY29uZGl0aW9uOiBmdW5jdGlvbiAoY3VzdG9tLCBldmVudCkgewogICAgICAgIGV2ZW50LmZsb3cgPSB0eXBlOwogICAgICAgIHJldHVybiBldmVudC50eXBlID09ICh0eXBlICsgJ2Zsb3cnKSB8fAogICAgICAgICgoZXZlbnQub3JpZW50ID09PSAwICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMSAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAyICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93ICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykpOwogICAgICB9CiAgICB9OwogIH0KCi8qKiogWC1UYWcgT2JqZWN0IERlZmluaXRpb24gKioqLwoKICB2YXIgeHRhZyA9IHsKICAgIHRhZ3M6IHt9LAogICAgZGVmYXVsdE9wdGlvbnM6IHsKICAgICAgcHNldWRvczogW10sCiAgICAgIG1peGluczogW10sCiAgICAgIGV2ZW50czoge30sCiAgICAgIG1ldGhvZHM6IHt9LAogICAgICBhY2Nlc3NvcnM6IHt9LAogICAgICBsaWZlY3ljbGU6IHt9LAogICAgICBhdHRyaWJ1dGVzOiB7fSwKICAgICAgJ3Byb3RvdHlwZSc6IHsKICAgICAgICB4dGFnOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9feHRhZ19fID8gdGhpcy5fX3h0YWdfXyA6ICh0aGlzLl9feHRhZ19fID0geyBkYXRhOiB7fSwgYXR0cmlidXRlTm9kZXM6IHt9IH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAobmFtZSwgb3B0aW9ucykgewogICAgICB2YXIgX25hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIHZhciB0YWcgPSB4dGFnLnRhZ3NbX25hbWVdID0gYXBwbHlNaXhpbnMoeHRhZy5tZXJnZSh7fSwgeHRhZy5kZWZhdWx0T3B0aW9ucywgb3B0aW9ucykpOwoKICAgICAgZm9yICh2YXIgeiBpbiB0YWcuZXZlbnRzKSB0YWcuZXZlbnRzW3pdID0geHRhZy5wYXJzZUV2ZW50KHosIHRhZy5ldmVudHNbel0pOwogICAgICBmb3IgKHogaW4gdGFnLmxpZmVjeWNsZSkgdGFnLmxpZmVjeWNsZVt6LnNwbGl0KCc6JylbMF1dID0geHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLmxpZmVjeWNsZVt6XSwgdGFnLnBzZXVkb3MpOwogICAgICBmb3IgKHogaW4gdGFnLm1ldGhvZHMpIHRhZy5wcm90b3R5cGVbei5zcGxpdCgnOicpWzBdXSA9IHsgdmFsdWU6IHh0YWcuYXBwbHlQc2V1ZG9zKHosIHRhZy5tZXRob2RzW3pdLCB0YWcucHNldWRvcykgfTsKICAgICAgZm9yICh2YXIgcHJvcCBpbiB0YWcuYWNjZXNzb3JzKSBwYXJzZUFjY2Vzc29yKHRhZywgcHJvcCk7CgogICAgICB2YXIgcmVhZHkgPSB0YWcubGlmZWN5Y2xlLmNyZWF0ZWQgfHwgdGFnLmxpZmVjeWNsZS5yZWFkeTsKICAgICAgdGFnLnByb3RvdHlwZS5yZWFkeUNhbGxiYWNrID0gewogICAgICAgIHZhbHVlOiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLAogICAgICAgICAgICAgIHNldEF0dHIgPSB0aGlzLnNldEF0dHJpYnV0ZSwKICAgICAgICAgICAgICByZW1vdmVBdHRyID0gdGhpcy5yZW1vdmVBdHRyaWJ1dGU7CgogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAgICAgICBzZXRBdHRyaWJ1dGU6IHsKICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKG5hbWUsIHZhbHVlLCBza2lwKXsKICAgICAgICAgICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZS50b0xvd2VyQ2FzZSgpXSwKICAgICAgICAgICAgICAgICAgICB2YWwgPSBhdHRyICYmIGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWU7CiAgICAgICAgICAgICAgICBzZXRBdHRyLmNhbGwodGhpcywgbmFtZSwgdmFsKTsKICAgICAgICAgICAgICAgIGlmIChhdHRyICYmICFza2lwKSB0aGlzW2F0dHIuc2V0dGVyXSA9IGF0dHIuYm9vbGVhbiA/IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICByZW1vdmVBdHRyaWJ1dGU6IHsKICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKG5hbWUsIHZhbHVlLCBza2lwKXsKICAgICAgICAgICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICAgICAgICAgIHJlbW92ZUF0dHIuY2FsbCh0aGlzLCBuYW1lKTsKICAgICAgICAgICAgICAgIGlmIChhdHRyICYmICFza2lwKSB0aGlzW2F0dHIuc2V0dGVyXSA9IGF0dHIuYm9vbGVhbiA/IGZhbHNlIDogbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHh0YWcuYWRkRXZlbnRzKHRoaXMsIHRhZy5ldmVudHMpOwogICAgICAgICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uKG1peGluKXsKICAgICAgICAgICAgaWYgKHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpIHh0YWcuYWRkRXZlbnRzKGVsZW1lbnQsIHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpOwogICAgICAgICAgfSk7CgogICAgICAgICAgdmFyIG91dHB1dCA9IHJlYWR5ID8gcmVhZHkuYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpKSA6IG51bGw7CgogICAgICAgICAgdGFnLnBzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAodGFnLmxpZmVjeWNsZS5pbnNlcnRlZCkgdGFnLnByb3RvdHlwZS5pbnNlcnRlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5pbnNlcnRlZCB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5yZW1vdmVkKSB0YWcucHJvdG90eXBlLnJlbW92ZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUucmVtb3ZlZCB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkKSB0YWcucHJvdG90eXBlLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUuYXR0cmlidXRlQ2hhbmdlZCB9OwoKICAgICAgdmFyIGNvbnN0cnVjdG9yID0gZG9jLnJlZ2lzdGVyKF9uYW1lLCB7CiAgICAgICAgJ2V4dGVuZHMnOiBvcHRpb25zWydleHRlbmRzJ10sCiAgICAgICAgJ3Byb3RvdHlwZSc6IE9iamVjdC5jcmVhdGUoKG9wdGlvbnNbJ2V4dGVuZHMnXSA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQob3B0aW9uc1snZXh0ZW5kcyddKS5jb25zdHJ1Y3RvciA6IHdpbi5IVE1MRWxlbWVudCkucHJvdG90eXBlLCB0YWcucHJvdG90eXBlKQogICAgICB9KTsKCiAgICAgIHJldHVybiBjb25zdHJ1Y3RvcjsKICAgIH0sCgogICAgLyogRXhwb3NlZCBWYXJpYWJsZXMgKi8KCiAgICBtaXhpbnM6IHt9LAogICAgcHJlZml4OiBwcmVmaXgsCiAgICBjYXB0dXJlRXZlbnRzOiBbJ2ZvY3VzJywgJ2JsdXInXSwKICAgIGN1c3RvbUV2ZW50czogewogICAgICBvdmVyZmxvdzogY3JlYXRlRmxvd0V2ZW50KCdvdmVyJyksCiAgICAgIHVuZGVyZmxvdzogY3JlYXRlRmxvd0V2ZW50KCd1bmRlcicpLAogICAgICBhbmltYXRpb25zdGFydDogewogICAgICAgIGJhc2U6IFsKICAgICAgICAgICdhbmltYXRpb25zdGFydCcsCiAgICAgICAgICAnb0FuaW1hdGlvblN0YXJ0JywKICAgICAgICAgICdNU0FuaW1hdGlvblN0YXJ0JywKICAgICAgICAgICd3ZWJraXRBbmltYXRpb25TdGFydCcKICAgICAgICBdCiAgICAgIH0sCiAgICAgIHRyYW5zaXRpb25lbmQ6IHsKICAgICAgICBiYXNlOiBbCiAgICAgICAgICAndHJhbnNpdGlvbmVuZCcsCiAgICAgICAgICAnb1RyYW5zaXRpb25FbmQnLAogICAgICAgICAgJ01TVHJhbnNpdGlvbkVuZCcsCiAgICAgICAgICAnd2Via2l0VHJhbnNpdGlvbkVuZCcKICAgICAgICBdCiAgICAgIH0sCiAgICAgIHRhcDogewogICAgICAgIGJhc2U6IFsnY2xpY2snLCAndG91Y2hlbmQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcHN0YXJ0OiB7CiAgICAgICAgYmFzZTogWydtb3VzZWRvd24nLCAndG91Y2hzdGFydCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwZW5kOiB7CiAgICAgICAgYmFzZTogWydtb3VzZXVwJywgJ3RvdWNoZW5kJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBlbnRlcjogewogICAgICAgIGJhc2U6IFsnbW91c2VvdmVyJywgJ3RvdWNoZW50ZXInXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGxlYXZlOiB7CiAgICAgICAgYmFzZTogWydtb3VzZW91dCcsICd0b3VjaGxlYXZlJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBtb3ZlOiB7CiAgICAgICAgYmFzZTogWydtb3VzZW1vdmUnLCAndG91Y2htb3ZlJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9CiAgICB9LAogICAgcHNldWRvczogewogICAgICBrZXlwYXNzOiBrZXlwc2V1ZG8sCiAgICAgIGtleWZhaWw6IGtleXBzZXVkbywKICAgICAgZGVsZWdhdGU6IHsKICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gcXVlcnkodGhpcywgcHNldWRvLnZhbHVlKS5maWx0ZXIoZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG5vZGUgPT0gZXZlbnQudGFyZ2V0IHx8IG5vZGUuY29udGFpbnMgPyBub2RlLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkgOiBmYWxzZTsKICAgICAgICAgIH0pWzBdOwogICAgICAgICAgcmV0dXJuIHRhcmdldCA/IHBzZXVkby5saXN0ZW5lciA9IHBzZXVkby5saXN0ZW5lci5iaW5kKHRhcmdldCkgOiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXZlbnRhYmxlOiB7CiAgICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgICAgcmV0dXJuICFldmVudC5kZWZhdWx0UHJldmVudGVkOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvKiBVVElMSVRJRVMgKi8KCiAgICBjbG9uZTogY2xvbmUsCiAgICB0eXBlT2Y6IHR5cGVPZiwKICAgIHRvQXJyYXk6IHRvQXJyYXksCgogICAgd3JhcDogZnVuY3Rpb24gKG9yaWdpbmFsLCBmbikgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgcmV0dXJuZWQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmV0dXJuZWQgPT09IGZhbHNlID8gZmFsc2UgOiBmbi5hcHBseSh0aGlzLCB0eXBlb2YgcmV0dXJuZWQgIT0gJ3VuZGVmaW5lZCcgPyB0b0FycmF5KHJldHVybmVkKSA6IGFyZ3MpOwogICAgICB9OwogICAgfSwKCiAgICBtZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKICAgICAgaWYgKHR5cGVPZihrKSA9PSAnc3RyaW5nJykgcmV0dXJuIG1lcmdlT25lKHNvdXJjZSwgaywgdik7CiAgICAgIGZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CiAgICAgICAgdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9LAoKICAgIC8qIERPTSAqLwoKICAgIHF1ZXJ5OiBxdWVyeSwKCiAgICBza2lwVHJhbnNpdGlvbjogZnVuY3Rpb24oZWxlbWVudCwgZm4sIGJpbmQpewogICAgICB2YXIgZHVyYXRpb24gPSBwcmVmaXguanMgKyAnVHJhbnNpdGlvbkR1cmF0aW9uJzsKICAgICAgZWxlbWVudC5zdHlsZVtkdXJhdGlvbl0gPSAnMC4wMDFzJzsKICAgICAgZWxlbWVudC5zdHlsZS50cmFuc2l0aW9uRHVyYXRpb24gPSAnMC4wMDFzJzsKICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZuKSBjYWxsYmFjayA9IGZuLmNhbGwoYmluZCk7CiAgICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQuc3R5bGVbZHVyYXRpb25dID0gJyc7CiAgICAgICAgICBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcnOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSB4dGFnLnJlcXVlc3RGcmFtZShjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICByZXF1ZXN0RnJhbWU6IChmdW5jdGlvbigpewogICAgICB2YXIgcmFmID0gd2luLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbltwcmVmaXgubG93ZXJjYXNlICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddIHx8CiAgICAgICAgZnVuY3Rpb24oZm4peyByZXR1cm4gd2luLnNldFRpbWVvdXQoZm4sIDIwKTsgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gcmFmLmNhbGwod2luLCBmbik7CiAgICAgIH07CiAgICB9KSgpLAoKICAgIG1hdGNoU2VsZWN0b3I6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICByZXR1cm4gbWF0Y2hTZWxlY3Rvci5jYWxsKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgbWV0aG9kLCB2YWx1ZSkgewogICAgICBlbGVtZW50W21ldGhvZF0gPSB2YWx1ZTsKICAgICAgaWYgKHdpbmRvdy5DdXN0b21FbGVtZW50cykgQ3VzdG9tRWxlbWVudHMudXBncmFkZUFsbChlbGVtZW50KTsKICAgIH0sCgogICAgaW5uZXJIVE1MOiBmdW5jdGlvbihlbCwgaHRtbCl7CiAgICAgIHh0YWcuc2V0KGVsLCAnaW5uZXJIVE1MJywgaHRtbCk7CiAgICB9LAoKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJykuaW5kZXhPZihrbGFzcy50cmltKCkpPi0xOwogICAgfSwKCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBsaXN0ID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAoIX5saXN0LmluZGV4T2YobmFtZSkpIGxpc3QucHVzaChuYW1lKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gbGlzdC5qb2luKCcgJykudHJpbSgpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgY2xhc3NlcyA9IGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpLmZpbHRlcihmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBuYW1lICYmICF+Y2xhc3Nlcy5pbmRleE9mKG5hbWUpOwogICAgICB9KS5qb2luKCcgJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiB4dGFnW3h0YWcuaGFzQ2xhc3MoZWxlbWVudCwga2xhc3MpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddLmNhbGwobnVsbCwgZWxlbWVudCwga2xhc3MpOwoKICAgIH0sCgogICAgcXVlcnlDaGlsZHJlbjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBpZCA9IGVsZW1lbnQuaWQsCiAgICAgICAgZ3VpZCA9IGVsZW1lbnQuaWQgPSBpZCB8fCAneF8nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgYXR0ciA9ICcjJyArIGd1aWQgKyAnID4gJzsKICAgICAgc2VsZWN0b3IgPSBhdHRyICsgKHNlbGVjdG9yICsgJycpLnJlcGxhY2UoJywnLCAnLCcgKyBhdHRyLCAnZycpOwogICAgICB2YXIgcmVzdWx0ID0gZWxlbWVudC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogICAgICBpZiAoIWlkKSBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKICAgICAgcmV0dXJuIHRvQXJyYXkocmVzdWx0KTsKICAgIH0sCgogICAgY3JlYXRlRnJhZ21lbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdmFyIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICBpZiAoY29udGVudCkgewogICAgICAgIHZhciBkaXYgPSBmcmFnLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKSksCiAgICAgICAgICBub2RlcyA9IHRvQXJyYXkoY29udGVudC5ub2RlTmFtZSA/IGFyZ3VtZW50cyA6ICEoZGl2LmlubmVySFRNTCA9IGNvbnRlbnQpIHx8IGRpdi5jaGlsZHJlbiksCiAgICAgICAgICBsZW5ndGggPSBub2Rlcy5sZW5ndGgsCiAgICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSBmcmFnLmluc2VydEJlZm9yZShub2Rlc1tpbmRleCsrXSwgZGl2KTsKICAgICAgICBmcmFnLnJlbW92ZUNoaWxkKGRpdik7CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWc7CiAgICB9LAoKICAgIG1hbmlwdWxhdGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGZuKXsKICAgICAgdmFyIG5leHQgPSBlbGVtZW50Lm5leHRTaWJsaW5nLAogICAgICAgIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwKICAgICAgICBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKICAgICAgICByZXR1cm5lZCA9IGZuLmNhbGwoZnJhZy5hcHBlbmRDaGlsZChlbGVtZW50KSwgZnJhZykgfHwgZWxlbWVudDsKICAgICAgaWYgKG5leHQpIHBhcmVudC5pbnNlcnRCZWZvcmUocmV0dXJuZWQsIG5leHQpOwogICAgICBlbHNlIHBhcmVudC5hcHBlbmRDaGlsZChyZXR1cm5lZCk7CiAgICB9LAoKICAgIC8qIFBTRVVET1MgKi8KCiAgICBhcHBseVBzZXVkb3M6IGZ1bmN0aW9uKGtleSwgZm4sIGVsZW1lbnQpIHsKICAgICAgdmFyIGxpc3RlbmVyID0gZm4sCiAgICAgICAgICBwc2V1ZG9zID0ge307CiAgICAgIGlmIChrZXkubWF0Y2goJzonKSkgewogICAgICAgIHZhciBzcGxpdCA9IGtleS5tYXRjaChyZWdleFBzZXVkb1NwbGl0KSwKICAgICAgICAgICAgaSA9IHNwbGl0Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoLS1pKSB7CiAgICAgICAgICBzcGxpdFtpXS5yZXBsYWNlKHJlZ2V4UHNldWRvUmVwbGFjZSwgZnVuY3Rpb24gKG1hdGNoLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcHNldWRvID0gcHNldWRvc1tpXSA9IE9iamVjdC5jcmVhdGUoeHRhZy5wc2V1ZG9zW25hbWVdKTsKICAgICAgICAgICAgICAgIHBzZXVkby5rZXkgPSBrZXk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ubmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBwc2V1ZG8udmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgaWYgKCFwc2V1ZG8pIHRocm93ICJwc2V1ZG8gbm90IGZvdW5kOiAiICsgbmFtZTsKICAgICAgICAgICAgdmFyIGxhc3QgPSBsaXN0ZW5lcjsKICAgICAgICAgICAgbGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgICBvYmogPSB7CiAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXI6IGxhc3QKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAocHNldWRvLmFjdGlvbiAmJiBwc2V1ZG8uYWN0aW9uLmFwcGx5KHRoaXMsIFtvYmpdLmNvbmNhdChhcmdzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgcmV0dXJuIG9iai5saXN0ZW5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgcHNldWRvLm9uQWRkKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICBwc2V1ZG8ub25BZGQuY2FsbChlbGVtZW50LCBwc2V1ZG8pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnB1c2gocHNldWRvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciB6IGluIHBzZXVkb3MpIHsKICAgICAgICBpZiAocHNldWRvc1t6XS5vbkNvbXBpbGVkKSBsaXN0ZW5lciA9IHBzZXVkb3Nbel0ub25Db21waWxlZChsaXN0ZW5lciwgcHNldWRvc1t6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgfSwKCiAgICByZW1vdmVQc2V1ZG9zOiBmdW5jdGlvbihlbGVtZW50LCBldmVudCl7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25SZW1vdmUuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgIH0sCgogIC8qKiogRXZlbnRzICoqKi8KCiAgICBwYXJzZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbikgewogICAgICB2YXIgcHNldWRvcyA9IHR5cGUuc3BsaXQoJzonKSwKICAgICAgICBrZXkgPSBwc2V1ZG9zLnNoaWZ0KCksCiAgICAgICAgZXZlbnQgPSB4dGFnLm1lcmdlKHsKICAgICAgICAgIGJhc2U6IGtleSwKICAgICAgICAgIHBzZXVkb3M6ICcnLAogICAgICAgICAgX3BzZXVkb3M6IFtdLAogICAgICAgICAgb25BZGQ6IG5vb3AsCiAgICAgICAgICBvblJlbW92ZTogbm9vcCwKICAgICAgICAgIGNvbmRpdGlvbjogbm9vcAogICAgICAgIH0sIHh0YWcuY3VzdG9tRXZlbnRzW2tleV0gfHwge30pOwogICAgICBldmVudC50eXBlID0ga2V5ICsgKGV2ZW50LnBzZXVkb3MubGVuZ3RoID8gJzonICsgZXZlbnQucHNldWRvcyA6ICcnKSArIChwc2V1ZG9zLmxlbmd0aCA/ICc6JyArIHBzZXVkb3Muam9pbignOicpIDogJycpOwogICAgICBpZiAoZm4pIHsKICAgICAgICB2YXIgY2hhaW5lZCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGV2ZW50LnR5cGUsIGZuLCBldmVudC5fcHNldWRvcyk7CiAgICAgICAgZXZlbnQubGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoZXZlbnQuY29uZGl0aW9uLmFwcGx5KHRoaXMsIFtldmVudF0uY29uY2F0KGFyZ3MpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKICAgICAgICAgIHJldHVybiBjaGFpbmVkLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50OwogICAgfSwKCiAgICBhZGRFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIHZhciBldmVudCA9ICh0eXBlb2YgZm4gPT0gJ2Z1bmN0aW9uJykgPyB4dGFnLnBhcnNlRXZlbnQodHlwZSwgZm4pIDogZm47CiAgICAgIGV2ZW50Lmxpc3RlbmVyLmV2ZW50ID0gZXZlbnQ7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgICAgZXZlbnQub25BZGQuY2FsbChlbGVtZW50LCBldmVudCwgZXZlbnQubGlzdGVuZXIpOwogICAgICB0b0FycmF5KGV2ZW50LmJhc2UpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgZXZlbnQubGlzdGVuZXIsIHh0YWcuY2FwdHVyZUV2ZW50cy5pbmRleE9mKG5hbWUpID4gLTEpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGV2ZW50Lmxpc3RlbmVyOwogICAgfSwKCiAgICBhZGRFdmVudHM6IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudHMpIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHt9OwogICAgICBmb3IgKHZhciB6IGluIGV2ZW50cykgewogICAgICAgIGxpc3RlbmVyc1t6XSA9IHh0YWcuYWRkRXZlbnQoZWxlbWVudCwgeiwgZXZlbnRzW3pdKTsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfSwKCiAgICByZW1vdmVFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIHZhciBldmVudCA9IGZuLmV2ZW50OwogICAgICBldmVudC5vblJlbW92ZS5jYWxsKGVsZW1lbnQsIGV2ZW50LCBmbik7CiAgICAgIHh0YWcucmVtb3ZlUHNldWRvcyhlbGVtZW50LCBldmVudCk7CiAgICAgIHRvQXJyYXkoZXZlbnQuYmFzZSkuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLCBmbik7CiAgICAgIH0pOwogICAgfSwKCiAgICByZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGVsZW1lbnQsIGxpc3RlbmVycyl7CiAgICAgIGZvciAodmFyIHogaW4gbGlzdGVuZXJzKSB4dGFnLnJlbW92ZUV2ZW50KGVsZW1lbnQsIHosIGxpc3RlbmVyc1t6XSk7CiAgICB9LAoKICAgIGZpcmVFdmVudDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZGF0YSwgb3B0aW9ucyl7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB2YXIgZXZlbnQgPSBkb2MuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7CiAgICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCAnYnViYmxlcycgaW4gb3B0aW9ucyA/IG9wdGlvbnMuYnViYmxlcyA6IHRydWUsICdjYW5jZWxhYmxlJyBpbiBvcHRpb25zID8gb3B0aW9ucy5jYW5jZWxhYmxlIDogdHJ1ZSk7CiAgICAgIGZvciAodmFyIHogaW4gZGF0YSkgZXZlbnRbel0gPSBkYXRhW3pdOwogICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgfSwKCiAgICBhZGRPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICBpZiAoIWVsZW1lbnQuX3JlY29yZHMpIHsKICAgICAgICBlbGVtZW50Ll9yZWNvcmRzID0geyBpbnNlcnRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICAgICAgaWYgKG11dGF0aW9uKXsKICAgICAgICAgIGVsZW1lbnQuX29ic2VydmVyID0gbmV3IG11dGF0aW9uKGZ1bmN0aW9uKG11dGF0aW9ucykgewogICAgICAgICAgICBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpOwogICAgICAgICAgfSk7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlci5vYnNlcnZlKGVsZW1lbnQsIHsKICAgICAgICAgICAgc3VidHJlZTogdHJ1ZSwKICAgICAgICAgICAgY2hpbGRMaXN0OiB0cnVlLAogICAgICAgICAgICBhdHRyaWJ1dGVzOiAhdHJ1ZSwKICAgICAgICAgICAgY2hhcmFjdGVyRGF0YTogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIFsnSW5zZXJ0ZWQnLCAnUmVtb3ZlZCddLmZvckVhY2goZnVuY3Rpb24odHlwZSl7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGUnICsgdHlwZSwgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICBldmVudC5fbXV0YXRpb24gPSB0cnVlOwogICAgICAgICAgICBlbGVtZW50Ll9yZWNvcmRzW3R5cGUudG9Mb3dlckNhc2UoKV0uZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgICAgZm4oZXZlbnQudGFyZ2V0LCBldmVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLmluZGV4T2YoZm4pID09IC0xKSBlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLnB1c2goZm4pOwogICAgfSwKCiAgICByZW1vdmVPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICB2YXIgb2JqID0gZWxlbWVudC5fcmVjb3JkczsKICAgICAgaWYgKG9iaiAmJiBmbil7CiAgICAgICAgb2JqW3R5cGVdLnNwbGljZShvYmpbdHlwZV0uaW5kZXhPZihmbiksIDEpOwogICAgICB9CiAgICAgIGVsc2V7CiAgICAgICAgb2JqW3R5cGVdID0gW107CiAgICAgIH0KICAgIH0KCiAgfTsKCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSBkZWZpbmUoeHRhZyk7CiAgZWxzZSB3aW4ueHRhZyA9IHh0YWc7CgogIGRvYy5hZGRFdmVudExpc3RlbmVyKCdXZWJDb21wb25lbnRzUmVhZHknLCBmdW5jdGlvbigpewogICAgeHRhZy5maXJlRXZlbnQoZG9jLmJvZHksICdET01Db21wb25lbnRzTG9hZGVkJyk7CiAgfSk7Cgp9KSgpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 03:47:19 GMT",
                    "Content-Length": "82289",
                    "Date": "Sun, 09 Nov 2014 03:47:19 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}