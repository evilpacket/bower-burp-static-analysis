{
    "url": "http://localhost:9999/node-inspector/node-inspector/front-end/test-runner.html",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.location.search</b> and written to <b>the 'value' property of a DOM element</b> via the following statements:<ul><li>var queryParams = window.location.search;</li><li>var params = queryParams.substring(1).split(\"&amp;\");</li><li>var pair = params[i].split(\"=\");</li><li>queryParamsObject[pair[0]] = pair[1];</li><li>document.getElementById(\"filter\").value = queryParamsObject[\"filter\"];</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/node-inspector/node-inspector/front-end/test-runner.html",
                "path": "/node-inspector/node-inspector/front-end/test-runner.html",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9ub2RlLWluc3BlY3Rvci9ub2RlLWluc3BlY3Rvci9mcm9udC1lbmQvdGVzdC1ydW5uZXIuaHRtbCBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTE2ODENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IHRleHQvaHRtbDsgY2hhcnNldD11dGYtOA0KRGF0ZTogRnJpLCAwNyBOb3YgMjAxNCAxOTozNToyMSBHTVQNCkxhc3QtTW9kaWZpZWQ6IEZyaSwgMDcgTm92IDIwMTQgMTk6MzU6MTYgR01UDQoNCjxodG1sPgo8c2NyaXB0IHNyYz0ianNkaWZmbGliLmpzIj48L3NjcmlwdD4KPHNjcmlwdCBzcmM9InV0aWxpdGllcy5qcyI+PC9zY3JpcHQ+CjxzY3JpcHQgc3JjPSJET01FeHRlbnNpb24uanMiPjwvc2NyaXB0Pgo8c2NyaXB0IHNyYz0idHJlZW91dGxpbmUuanMiPjwvc2NyaXB0PgoKPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiB0eXBlPSJ0ZXh0L2NzcyIgaHJlZj0iaW5zcGVjdG9yLmNzcyI+CjxzdHlsZT4KOmZvY3VzIHsKICAgIG91dGxpbmU6IG5vbmU7Cn0KCi5mYWlsZWQgewogICAgY29sb3I6IHJlZDsKfQoKLnRpbWVvdXQgewogICAgY29sb3I6IGJyb3duOwp9CgppZnJhbWUgewogICAgd2lkdGg6IDA7CiAgICBoZWlnaHQ6IDA7CiAgICBvcGFjaXR5OiAwOwp9Cgo8L3N0eWxlPgoKPHNjcmlwdD4KCnZhciBsYXlvdXRUZXN0c1NlcnZlciA9ICJodHRwOi8vbG9jYWxob3N0OjgwMDIvIjsKdmFyIHNjYW5uZXJTZXJ2ZXIgPSAiaHR0cDovL2xvY2FsaG9zdDo4MDAyLyI7CnZhciByZW1vdGVEZWJ1Z2dpbmdTZXJ2ZXIgPSAiaHR0cDovL2xvY2FsaG9zdDo5MjIyLyI7Cgp2YXIgdGVzdHMgPSBbXTsKdmFyIHNraXBMaXN0ID0gWwogICAgLy8gSEFMVAogICAgImluc3BlY3Rvci9jb25zb2xlL2NvbnNvbGUtYXBpLW9uLWNhbGwtZnJhbWUuaHRtbCIsCgogICAgLy8gRkFJTEVECiAgICAiaW5zcGVjdG9yL2NvbnNvbGUvY29uc29sZS1kaXItZ2xvYmFsLmh0bWwiLAogICAgImluc3BlY3Rvci9jb25zb2xlL2NvbnNvbGUtbG9nLXRvU3RyaW5nLW9iamVjdC5odG1sIiwKICAgICJpbnNwZWN0b3IvY29uc29sZS9jb25zb2xlLXVuY2F1Z2h0LWV4Y2VwdGlvbi1pbi1ldmFsLmh0bWwiLAogICAgImluc3BlY3Rvci9lbGVtZW50cy9lZGl0LWRvbS1hY3Rpb25zLmh0bWwiLAogICAgImluc3BlY3Rvci9lbGVtZW50cy9oaWdobGlnaHQtbm9kZS1zY2FsZWQuaHRtbCIsCiAgICAiaW5zcGVjdG9yL2VsZW1lbnRzL2hpZ2hsaWdodC1ub2RlLXNjcm9sbC5odG1sIiwKICAgICJpbnNwZWN0b3IvZWxlbWVudHMvaGlnaGxpZ2h0LW5vZGUuaHRtbCIsCiAgICAiaW5zcGVjdG9yL2VsZW1lbnRzL2hpZ2hsaWdodC1zdmctcm9vdC5odG1sIiwKICAgICJpbnNwZWN0b3IvbmV0d29yay1zdGF0dXMtbm9uLWh0dHAuaHRtbCIsCiAgICAiaW5zcGVjdG9yL3N0b3JhZ2UtcGFuZWwtZG9tLXN0b3JhZ2UtdXBkYXRlLmh0bWwiLAogICAgImluc3BlY3Rvci9zdHlsZXMvaW5qZWN0LXN0eWxlc2hlZXQuaHRtbCIsCiAgICAiaW5zcGVjdG9yL3N0eWxlcy9wcm90b2NvbC1jc3MtcmVnaW9ucy1jb21tYW5kcy5odG1sIiwKICAgICJpbnNwZWN0b3Ivc3R5bGVzL3JlZ2lvbi1zdHlsZS1jcmFzaC5odG1sIiwKICAgICJpbnNwZWN0b3Ivc3R5bGVzL3N0eWxlcy1kaXNhYmxlLXRoZW4tZW5hYmxlLW92ZXJyaWRlbi11YS5odG1sIiwKICAgICJpbnNwZWN0b3Ivc3R5bGVzL3N0eWxlcy11cmwtbGlua2lmeS5odG1sIiwKICAgICJpbnNwZWN0b3Ivc3R5bGVzL3ZlbmRvci1wcmVmaXhlcy5odG1sIiwKICAgICJpbnNwZWN0b3IvdGltZWxpbmUvdGltZWxpbmUtZXZlbnQtZGlzcGF0Y2guaHRtbCIsCiAgICAiaW5zcGVjdG9yL3RpbWVsaW5lL3RpbWVsaW5lLWZyYW1lcy5odG1sIiwKICAgICJpbnNwZWN0b3IvdGltZWxpbmUvdGltZWxpbmUtbmV0d29yay1yZXNvdXJjZS5odG1sIiwKICAgICJpbnNwZWN0b3IvdGltZWxpbmUvdGltZWxpbmUtcGFpbnQuaHRtbCIsCiAgICAiaW5zcGVjdG9yL3RpbWVsaW5lL3RpbWVsaW5lLXJlY2VpdmUtcmVzcG9uc2UtZXZlbnQuaHRtbCIsCgogICAgLy8gVElNRU9VVAogICAgImluc3BlY3Rvci9wcm9maWxlci9jcHUtcHJvZmlsZXItcHJvZmlsaW5nLXdpdGhvdXQtaW5zcGVjdG9yLmh0bWwiLAogICAgImluc3BlY3Rvci9wcm9maWxlci9oZWFwLXNuYXBzaG90LWluc3BlY3QtZG9tLXdyYXBwZXIuaHRtbCIsCiAgICAiaW5zcGVjdG9yL3RpbWVsaW5lL3RpbWVsaW5lLW5ldHdvcmstcmVjZWl2ZWQtZGF0YS5odG1sIiwKXTsKdmFyIHRyZWVPdXRsaW5lID0gbnVsbDsKCmZ1bmN0aW9uIHJ1bihkZWJ1ZykKewogICAgaWYgKHdpbmRvdy5ydW5uZXIgJiYgZGVidWcpIHsKICAgICAgICB3aW5kb3cucnVubmVyLmNvbnRpbnVlRGVidWdnaW5nKCk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh3aW5kb3cudGVzdFNjYW5uZXJJZnJhbWUpIAogICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQod2luZG93LnRlc3RTY2FubmVySWZyYW1lKTsKCiAgICBpZiAod2luZG93LnJ1bm5lcikKICAgICAgICB3aW5kb3cucnVubmVyLmNsZWFudXAoKTsKCiAgICB3aW5kb3cudGVzdFNjYW5uZXJJZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpZnJhbWUiKTsKICAgIHdpbmRvdy50ZXN0U2Nhbm5lcklmcmFtZS5zcmMgPSBzY2FubmVyU2VydmVyICsgIkxheW91dFRlc3RzL2h0dHAvdGVzdHMvaW5zcGVjdG9yL3Jlc291cmNlcy90ZXN0LXNjYW5uZXIuaHRtbCI7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHdpbmRvdy50ZXN0U2Nhbm5lcklmcmFtZSk7CiAgICB3aW5kb3cuZGVidWcgPSBkZWJ1ZzsKfQoKZnVuY3Rpb24gcnVuVGVzdHMoKQp7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgib3V0bGluZSIpLnJlbW92ZUNoaWxkcmVuKCk7CiAgICB0cmVlT3V0bGluZSA9IG5ldyBUcmVlT3V0bGluZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgib3V0bGluZSIpKTsKCiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGFzcyIpLnRleHRDb250ZW50ID0gMDsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJza2lwIikudGV4dENvbnRlbnQgPSAwOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZhaWwiKS50ZXh0Q29udGVudCA9IDA7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidGltZW91dCIpLnRleHRDb250ZW50ID0gMDsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZW1haW5pbmciKS50ZXh0Q29udGVudCA9IHRlc3RzLmxlbmd0aDsKCiAgICBydW5OZXh0VGVzdCgpOwp9CgpmdW5jdGlvbiBpbnRlcnJ1cHQoKQp7CiAgICB0ZXN0cyA9IFtdOwp9CgpmdW5jdGlvbiBydW5OZXh0VGVzdChsYXN0UmVzdWx0KQp7CiAgICBpZiAobGFzdFJlc3VsdCkgewogICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobGFzdFJlc3VsdCk7CiAgICAgICAgZWxlbWVudC50ZXh0Q29udGVudCA9IHBhcnNlSW50KGVsZW1lbnQudGV4dENvbnRlbnQpICsgMTsKCiAgICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZW1haW5pbmciKTsKICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gcGFyc2VJbnQoZWxlbWVudC50ZXh0Q29udGVudCkgLSAxOwogICAgICAgIGlmICh3aW5kb3cuZGVidWcpIHsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRlYnVnIikudGV4dENvbnRlbnQgPSAiRGVidWciOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIHZhciB0ZXN0OwogICAgdmFyIGZpbHRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmaWx0ZXIiKS52YWx1ZTsKICAgIHdoaWxlICh0ZXN0ID0gdGVzdHMuc2hpZnQoKSkgewogICAgICAgIGlmICghZmlsdGVyIHx8IHRlc3RbMF0ubWF0Y2goZmlsdGVyKSkgewogICAgICAgICAgICBuZXcgU3RhbmRhbG9uZVRlc3RSdW5uZXIobGF5b3V0VGVzdHNTZXJ2ZXIgKyB0ZXN0WzBdLCB0ZXN0WzFdLCBydW5OZXh0VGVzdC5iaW5kKG51bGwpKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gU3RhbmRhbG9uZVRlc3RSdW5uZXIodGVzdFBhdGgsIGV4cGVjdGVkLCBuZXh0KQp7CiAgICB0aGlzLl90ZXN0UGF0aCA9IHRlc3RQYXRoOwogICAgdGhpcy5fbmV4dCA9IG5leHQ7CiAgICB0aGlzLl9leHBlY3RlZCA9IGV4cGVjdGVkOwogICAgdGhpcy5fcGVuZGluZ01lc3NhZ2VzID0gW107CgogICAgdGhpcy5fdHJlZUVsZW1lbnQgPSBuZXcgVHJlZUVsZW1lbnQodGVzdFBhdGgpOwogICAgdHJlZU91dGxpbmUuYXBwZW5kQ2hpbGQodGhpcy5fdHJlZUVsZW1lbnQpOwoKICAgIGZvciAodmFyIGkgPSAwOyAhd2luZG93LmRlYnVnICYmIGkgPCBza2lwTGlzdC5sZW5ndGg7ICsraSkgewogICAgICAgIGlmICh0ZXN0UGF0aC5pbmRleE9mKHNraXBMaXN0W2ldKSAhPT0gLTEpIHsKICAgICAgICAgICAgdGhpcy5fdHJlZUVsZW1lbnQudGl0bGUgPSB0ZXN0UGF0aCArICI6IFNLSVBQRUQiOwogICAgICAgICAgICB0aGlzLl9uZXh0KCJza2lwIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cucnVubmVyID0gdGhpczsKICAgIHRoaXMuX3Rlc3RQYWdlID0gd2luZG93Lm9wZW4oImFib3V0OmJsYW5rIiwgImluc3BlY3RlZCIsICJ3aWR0aD04MDAsaGVpZ2h0PTYwMCIpOwoKICAgIHdpbmRvdy5yZW1vdGVEZWJ1Z2dpbmdIYW5kc2hha2UgPSB0aGlzLl9yZW1vdGVEZWJ1Z2dpbmdIYW5kc2hha2UuYmluZCh0aGlzKTsKICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgIHNjcmlwdC5zcmMgPSByZW1vdGVEZWJ1Z2dpbmdTZXJ2ZXIgKyAianNvbj9qc29ucD1yZW1vdGVEZWJ1Z2dpbmdIYW5kc2hha2UiOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwp9CgpTdGFuZGFsb25lVGVzdFJ1bm5lci5Gcm9udGVuZExvY2F0aW9uID0gImluc3BlY3Rvci5odG1sIjsKClN0YW5kYWxvbmVUZXN0UnVubmVyLnByb3RvdHlwZSA9IHsKICAgIF9yZW1vdGVEZWJ1Z2dpbmdIYW5kc2hha2U6IGZ1bmN0aW9uKGRhdGEpCiAgICB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChkYXRhW2ldLnVybCAhPT0gImFib3V0OmJsYW5rIikKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB0aGlzLl9kZWJ1Z2dlclVSTCA9IGRhdGFbaV0ud2ViU29ja2V0RGVidWdnZXJVcmwucmVwbGFjZSgiOi8vIiwgIj0iKTsKICAgICAgICAgICAgdGhpcy5fbmF2aWdhdGVUZXN0UGFnZSgpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9LAoKICAgIF9uYXZpZ2F0ZVRlc3RQYWdlOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fdGVzdFBhZ2UubG9jYXRpb24uaHJlZiA9IHRoaXMuX3Rlc3RQYXRoOwogICAgICAgIHZhciB3aWR0aCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdpbnNwZWN0b3JXaWR0aCcpIHx8IDYwMDsKICAgICAgICB2YXIgaGVpZ2h0ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2luc3BlY3RvckhlaWdodCcpIHx8IDQwMDsKICAgICAgICB2YXIgZmVhdHVyZXMgPSAid2lkdGg9IiArIE1hdGgubWF4KHdpZHRoICwgNjAwKSArICIsaGVpZ2h0PSIgKyBNYXRoLm1heChoZWlnaHQsIDQwMCk7CiAgICAgICAgdGhpcy5faW5zcGVjdG9yV2luZG93TG9hZGluZyA9IHdpbmRvdy5vcGVuKFN0YW5kYWxvbmVUZXN0UnVubmVyLkZyb250ZW5kTG9jYXRpb24gKyAiPyIgKyB0aGlzLl9kZWJ1Z2dlclVSTCwgImluc3BlY3RvciIsIGZlYXR1cmVzKTsKICAgICAgICB0aGlzLl9pbnNwZWN0b3JXaW5kb3dMb2FkaW5nLmRpc3BhdGNoU3RhbmRhbG9uZVRlc3RSdW5uZXJNZXNzYWdlcyA9IHRydWU7CiAgICAgICAgCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3VubG9hZCcsIHRoaXMuY2xlYW51cC5iaW5kKHRoaXMpKTsKCiAgICAgICAgaWYgKCF3aW5kb3cuZGVidWcpCiAgICAgICAgICAgIHRoaXMuX3dhdGNoRG9nID0gc2V0VGltZW91dCh0aGlzLl90aW1lb3V0LmJpbmQodGhpcyksIDEwMDAwKTsKICAgIH0sCgogICAgbG9hZENvbXBsZXRlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghd2luZG93LmRlYnVnKSB7CiAgICAgICAgICAgIHRoaXMuX2xvYWRDb21wbGV0ZWQodGhpcyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRlYnVnIikudGV4dENvbnRlbnQgPSAiQ29udGludWUiOwogICAgfSwKCiAgICBjb250aW51ZURlYnVnZ2luZzogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX2xvYWRDb21wbGV0ZWQoKTsKICAgIH0sCgogICAgX2xvYWRDb21wbGV0ZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl9pbnNwZWN0b3JXaW5kb3cgPSB0aGlzLl9pbnNwZWN0b3JXaW5kb3dMb2FkaW5nOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fcGVuZGluZ01lc3NhZ2VzLmxlbmd0aDsgKytpKQogICAgICAgICAgICB0aGlzLl9pbnNwZWN0b3JXaW5kb3cucG9zdE1lc3NhZ2UodGhpcy5fcGVuZGluZ01lc3NhZ2VzW2ldLCAiKiIpOwogICAgICAgIHRoaXMuX3BlbmRpbmdNZXNzYWdlcyA9IFtdOwogICAgfSwKCiAgICBjbG9zZVdlYkluc3BlY3RvcjogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghd2luZG93LmRlYnVnKQogICAgICAgICAgICB0aGlzLl9pbnNwZWN0b3JXaW5kb3cuY2xvc2UoKTsKICAgIH0sCgogICAgbm90aWZ5RG9uZTogZnVuY3Rpb24oYWN0dWFsKQogICAgewogICAgICAgIGlmICh0aGlzLl9kb25lKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgdGhpcy5fZG9uZSA9IHRydWU7CgogICAgICAgIGlmICghd2luZG93LmRlYnVnKSAKICAgICAgICAgICAgdGhpcy5jbGVhbnVwKCkKCiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3dhdGNoRG9nKTsKCiAgICAgICAgdGhpcy5fdHJlZUVsZW1lbnQub25zZWxlY3QgPSB0aGlzLm9uVHJlZUVsZW1lbnRTZWxlY3QuYmluZCh0aGlzKTsKCiAgICAgICAgLy8gVE9ETyBwYXZlbCAgaXMgdGhlICBSSFMgfHwgY29uZGl0aW9uIHdhbnRlZD8KICAgICAgICBpZiAoYWN0dWFsID09PSB0aGlzLl9leHBlY3RlZCB8fCBhY3R1YWwgPT09IHRoaXMuX2V4cGVjdGVkICsgIlxuIikgewogICAgICAgICAgICB0aGlzLl90cmVlRWxlbWVudC50aXRsZSA9IHRoaXMuX3Rlc3RQYXRoICsgIjogU1VDQ0VTUyI7CiAgICAgICAgICAgIHRoaXMuX25leHQoInBhc3MiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fdHJlZUVsZW1lbnQudGl0bGUgPSB0aGlzLl90ZXN0UGF0aCArICI6IEZBSUxFRCI7CiAgICAgICAgdGhpcy5fdHJlZUVsZW1lbnQubGlzdEl0ZW1FbGVtZW50LmFkZFN0eWxlQ2xhc3MoImZhaWxlZCIpOwoKICAgICAgICB2YXIgYmFzZUxpbmVzID0gZGlmZmxpYi5zdHJpbmdBc0xpbmVzKHRoaXMuX2V4cGVjdGVkKTsKICAgICAgICB2YXIgbmV3TGluZXMgPSBkaWZmbGliLnN0cmluZ0FzTGluZXMoYWN0dWFsKTsKICAgICAgICB2YXIgc20gPSBuZXcgZGlmZmxpYi5TZXF1ZW5jZU1hdGNoZXIoYmFzZUxpbmVzLCBuZXdMaW5lcyk7CiAgICAgICAgdmFyIG9wY29kZXMgPSBzbS5nZXRfb3Bjb2RlcygpOwogICAgICAgIHZhciBsYXN0V2FzU2VwYXJhdG9yID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IG9wY29kZXMubGVuZ3RoOyBpZHgrKykgewogICAgICAgICAgICB2YXIgY29kZSA9IG9wY29kZXNbaWR4XTsKICAgICAgICAgICAgdmFyIGNoYW5nZSA9IGNvZGVbMF07CiAgICAgICAgICAgIHZhciBiID0gY29kZVsxXTsKICAgICAgICAgICAgdmFyIGJlID0gY29kZVsyXTsKICAgICAgICAgICAgdmFyIG4gPSBjb2RlWzNdOwogICAgICAgICAgICB2YXIgbmUgPSBjb2RlWzRdOwogICAgICAgICAgICB2YXIgcm93Q291bnQgPSBNYXRoLm1heChiZSAtIGIsIG5lIC0gbik7CiAgICAgICAgICAgIHZhciB0b3BSb3dzID0gW107CiAgICAgICAgICAgIHZhciBib3R0b21Sb3dzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm93Q291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGNoYW5nZSA9PT0gImRlbGV0ZSIgfHwgKGNoYW5nZSA9PT0gInJlcGxhY2UiICYmIGIgPCBiZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IGIrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl90cmVlRWxlbWVudC5hcHBlbmRDaGlsZChuZXcgVHJlZUVsZW1lbnQoIi0gWyIgKyBsaW5lTnVtYmVyICsgIl0gIiArIGJhc2VMaW5lc1tsaW5lTnVtYmVyXSkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChjaGFuZ2UgPT09ICJpbnNlcnQiIHx8IChjaGFuZ2UgPT09ICJyZXBsYWNlIiAmJiBuIDwgbmUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmVOdW1iZXIgPSBuKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdHJlZUVsZW1lbnQuYXBwZW5kQ2hpbGQobmV3IFRyZWVFbGVtZW50KCIrIFsiICsgbGluZU51bWJlciArICJdICIgKyBuZXdMaW5lc1tsaW5lTnVtYmVyXSkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChjaGFuZ2UgPT09ICJlcXVhbCIpIHsKICAgICAgICAgICAgICAgICAgICBiKys7CiAgICAgICAgICAgICAgICAgICAgbisrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9uZXh0KCJmYWlsIik7CiAgICB9LAoKICAgIGV2YWx1YXRlSW5XZWJJbnNwZWN0b3I6IGZ1bmN0aW9uKGNhbGxJZCwgc2NyaXB0KQogICAgewogICAgICAgIGlmICh0aGlzLl9pbnNwZWN0b3JXaW5kb3cpCiAgICAgICAgICAgIHRoaXMuX2luc3BlY3RvcldpbmRvdy5wb3N0TWVzc2FnZShbImV2YWx1YXRlRm9yVGVzdCIsIGNhbGxJZCwgc2NyaXB0XSwgIioiKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdNZXNzYWdlcy5wdXNoKFsiZXZhbHVhdGVGb3JUZXN0IiwgY2FsbElkLCBzY3JpcHRdKTsKICAgIH0sCgogICAgX3RpbWVvdXQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl90cmVlRWxlbWVudC50aXRsZSA9IHRoaXMuX3Rlc3RQYXRoICsgIjogVElNRU9VVCI7CiAgICAgICAgdGhpcy5fdHJlZUVsZW1lbnQubGlzdEl0ZW1FbGVtZW50LmFkZFN0eWxlQ2xhc3MoInRpbWVvdXQiKTsKICAgICAgICB0aGlzLl9kb25lID0gdHJ1ZTsKICAgICAgICB0aGlzLmNsZWFudXAoKTsKICAgICAgICB0aGlzLl9uZXh0KCJ0aW1lb3V0Iik7CiAgICB9LAoKICAgIGNsZWFudXA6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2luc3BlY3RvcldpZHRoJywgdGhpcy5faW5zcGVjdG9yV2luZG93TG9hZGluZy5vdXRlcldpZHRoKTsKICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnaW5zcGVjdG9ySGVpZ2h0JywgdGhpcy5faW5zcGVjdG9yV2luZG93TG9hZGluZy5vdXRlckhlaWdodCk7CiAgICAgICAgdGhpcy5faW5zcGVjdG9yV2luZG93TG9hZGluZy5jbG9zZSgpOwogICAgICAgIHRoaXMuX3Rlc3RQYWdlLmNsb3NlKCk7CiAgICAgICAgZGVsZXRlIHdpbmRvdy5ydW5uZXI7CiAgICB9LAoKICAgIG9uVHJlZUVsZW1lbnRTZWxlY3Q6IGZ1bmN0aW9uICgpIAogICAgewogICAgICAgIHZhciBiYXNlRW5kU2VudGluZWwgPSAnL2luc3BlY3Rvci8nOwogICAgICAgIHZhciBiYXNlQ2hhcnMgPSB0aGlzLl90ZXN0UGF0aC5pbmRleE9mKGJhc2VFbmRTZW50aW5lbCkgKyBiYXNlRW5kU2VudGluZWwubGVuZ3RoOwogICAgICAgIGlmIChiYXNlQ2hhcnMgPiAwKSAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbHRlciIpLnZhbHVlID0gdGhpcy5fdGVzdFBhdGguc3Vic3RyKGJhc2VDaGFycyk7CiAgICB9LAoKICAgIGRpc3BsYXk6IGZ1bmN0aW9uKCkgeyB9Cn0KCmZ1bmN0aW9uIG9uTWVzc2FnZUZyb21UZXN0UGFnZShldmVudCkKewogICAgdmFyIHNpZ25hdHVyZSA9IGV2ZW50LmRhdGE7CiAgICB2YXIgbWV0aG9kID0gc2lnbmF0dXJlLnNoaWZ0KCk7CiAgICBpZiAobWV0aG9kID09PSAidGVzdHMiKSB7CiAgICAgICAgdGVzdHMgPSBzaWduYXR1cmVbMF07CiAgICAgICAgcnVuVGVzdHMoKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHdpbmRvdy5ydW5uZXIpCiAgICAgICAgd2luZG93LnJ1bm5lclttZXRob2RdLmFwcGx5KHdpbmRvdy5ydW5uZXIsIHNpZ25hdHVyZSk7Cn0KCmZ1bmN0aW9uIG9ubG9hZCgpCnsKICAgIHZhciBxdWVyeVBhcmFtc09iamVjdCA9IHt9OwogICAgdmFyIHF1ZXJ5UGFyYW1zID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaDsKICAgIGlmICghcXVlcnlQYXJhbXMpCiAgICAgICAgcmV0dXJuOwogICAgdmFyIHBhcmFtcyA9IHF1ZXJ5UGFyYW1zLnN1YnN0cmluZygxKS5zcGxpdCgiJiIpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgcGFpciA9IHBhcmFtc1tpXS5zcGxpdCgiPSIpOwogICAgICAgIHF1ZXJ5UGFyYW1zT2JqZWN0W3BhaXJbMF1dID0gcGFpclsxXTsKICAgIH0KICAgIGlmICgiZmlsdGVyIiBpbiBxdWVyeVBhcmFtc09iamVjdCkKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZmlsdGVyIikudmFsdWUgPSBxdWVyeVBhcmFtc09iamVjdFsiZmlsdGVyIl07Cn0KCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgb25NZXNzYWdlRnJvbVRlc3RQYWdlLCB0cnVlKTsKCjwvc2NyaXB0Pgo8Ym9keSBvbmxvYWQ9Im9ubG9hZCgpIj4KVGhpcyBpcyBhIHN0YW5kYWxvbmUgdGVzdCBzdWl0ZSBmb3IgaW5zcGVjdG9yIGZyb250LWVuZC4gSGVyZSBpcyBob3cgeW91IHJ1biBpdDoKPHVsPgo8bGk+Q2hlY2sgb3V0IFdlYktpdCBzb3VyY2UgdHJlZTogZ2l0IGNsb25lIGh0dHA6Ly9naXQuY2hyb21pdW0ub3JnL2V4dGVybmFsL1dlYmtpdC5naXQ8L2xpPgo8bGk+UnVuICJUb29scy9TY3JpcHRzL25ldy1ydW4td2Via2l0LWh0dHBkIC0tcm9vdD0uIC0tcG9ydD04MDAyIC0tc2VydmVyPXN0YXJ0IjwvbGk+CjxsaT5SdW4gQ2hyb21lIENhbmFyeSAoVG9UIENocm9taXVtKSB3aXRoIGZvbGxvd2luZyBmbGFnczogIi0tcmVtb3RlLWRlYnVnZ2luZy1wb3J0PTkyMjIgLS11c2VyLWRhdGEtZGlyPXRlc3RQcm9maWxlIGh0dHA6Ly9sb2NhbGhvc3Q6ODAwMi9Tb3VyY2UvZGV2dG9vbHMvZnJvbnRfZW5kL3Rlc3QtcnVubmVyLmh0bWwiPC9saT4KPC91bD4KCjxidXR0b24gb25jbGljaz0icnVuKCkiPlJ1bjwvYnV0dG9uPgo8YnV0dG9uIGlkPSJkZWJ1ZyIgb25jbGljaz0icnVuKHRydWUpIj5EZWJ1ZzwvYnV0dG9uPgo8YnV0dG9uIG9uY2xpY2s9ImludGVycnVwdCgpIj5JbnRlcnJ1cHQ8L2J1dHRvbj4KRmlsdGVyOiA8aW5wdXQgaWQ9ImZpbHRlciIgdHlwZT0idGV4dCIgc2l6ZT0iNDAiPjwvaW5wdXQ+PHNtYWxsPjxpPkNsaWNrIG9uIHJlc3VsdHMgdG8gbG9hZCBmaWx0ZXI8L2k+PC9zbWFsbD48YnI+Cgo8c3Bhbj5QYXNzZWQ6IDxzcGFuIGlkPSJwYXNzIj4wPC9zcGFuPjwvc3Bhbj4KPHNwYW4+RmFpbGVkOiA8c3BhbiBpZD0iZmFpbCI+MDwvc3Bhbj48L3NwYW4+CjxzcGFuPlRpbWVvdXQ6IDxzcGFuIGlkPSJ0aW1lb3V0Ij4wPC9zcGFuPjwvc3Bhbj4KPHNwYW4+U2tpcHBlZDogPHNwYW4gaWQ9InNraXAiPjA8L3NwYW4+PC9zcGFuPgo8c3Bhbj5SZW1haW5pbmc6IDxzcGFuIGlkPSJyZW1haW5pbmciPjA8L3NwYW4+PGJyPgoKPG9sIGlkPSJvdXRsaW5lIiBzdHlsZT0iZm9udC1zaXplOiAxMnB4ICFpbXBvcnRhbnQiIGNsYXNzPSJzb3VyY2UtY29kZSBvdXRsaW5lLWRpc2Nsb3N1cmUiPjwvb2w+Cgo8L2JvZHk+CjwvaHRtbD4K",
                "body": "PGh0bWw+CjxzY3JpcHQgc3JjPSJqc2RpZmZsaWIuanMiPjwvc2NyaXB0Pgo8c2NyaXB0IHNyYz0idXRpbGl0aWVzLmpzIj48L3NjcmlwdD4KPHNjcmlwdCBzcmM9IkRPTUV4dGVuc2lvbi5qcyI+PC9zY3JpcHQ+CjxzY3JpcHQgc3JjPSJ0cmVlb3V0bGluZS5qcyI+PC9zY3JpcHQ+Cgo8bGluayByZWw9InN0eWxlc2hlZXQiIHR5cGU9InRleHQvY3NzIiBocmVmPSJpbnNwZWN0b3IuY3NzIj4KPHN0eWxlPgo6Zm9jdXMgewogICAgb3V0bGluZTogbm9uZTsKfQoKLmZhaWxlZCB7CiAgICBjb2xvcjogcmVkOwp9CgoudGltZW91dCB7CiAgICBjb2xvcjogYnJvd247Cn0KCmlmcmFtZSB7CiAgICB3aWR0aDogMDsKICAgIGhlaWdodDogMDsKICAgIG9wYWNpdHk6IDA7Cn0KCjwvc3R5bGU+Cgo8c2NyaXB0PgoKdmFyIGxheW91dFRlc3RzU2VydmVyID0gImh0dHA6Ly9sb2NhbGhvc3Q6ODAwMi8iOwp2YXIgc2Nhbm5lclNlcnZlciA9ICJodHRwOi8vbG9jYWxob3N0OjgwMDIvIjsKdmFyIHJlbW90ZURlYnVnZ2luZ1NlcnZlciA9ICJodHRwOi8vbG9jYWxob3N0OjkyMjIvIjsKCnZhciB0ZXN0cyA9IFtdOwp2YXIgc2tpcExpc3QgPSBbCiAgICAvLyBIQUxUCiAgICAiaW5zcGVjdG9yL2NvbnNvbGUvY29uc29sZS1hcGktb24tY2FsbC1mcmFtZS5odG1sIiwKCiAgICAvLyBGQUlMRUQKICAgICJpbnNwZWN0b3IvY29uc29sZS9jb25zb2xlLWRpci1nbG9iYWwuaHRtbCIsCiAgICAiaW5zcGVjdG9yL2NvbnNvbGUvY29uc29sZS1sb2ctdG9TdHJpbmctb2JqZWN0Lmh0bWwiLAogICAgImluc3BlY3Rvci9jb25zb2xlL2NvbnNvbGUtdW5jYXVnaHQtZXhjZXB0aW9uLWluLWV2YWwuaHRtbCIsCiAgICAiaW5zcGVjdG9yL2VsZW1lbnRzL2VkaXQtZG9tLWFjdGlvbnMuaHRtbCIsCiAgICAiaW5zcGVjdG9yL2VsZW1lbnRzL2hpZ2hsaWdodC1ub2RlLXNjYWxlZC5odG1sIiwKICAgICJpbnNwZWN0b3IvZWxlbWVudHMvaGlnaGxpZ2h0LW5vZGUtc2Nyb2xsLmh0bWwiLAogICAgImluc3BlY3Rvci9lbGVtZW50cy9oaWdobGlnaHQtbm9kZS5odG1sIiwKICAgICJpbnNwZWN0b3IvZWxlbWVudHMvaGlnaGxpZ2h0LXN2Zy1yb290Lmh0bWwiLAogICAgImluc3BlY3Rvci9uZXR3b3JrLXN0YXR1cy1ub24taHR0cC5odG1sIiwKICAgICJpbnNwZWN0b3Ivc3RvcmFnZS1wYW5lbC1kb20tc3RvcmFnZS11cGRhdGUuaHRtbCIsCiAgICAiaW5zcGVjdG9yL3N0eWxlcy9pbmplY3Qtc3R5bGVzaGVldC5odG1sIiwKICAgICJpbnNwZWN0b3Ivc3R5bGVzL3Byb3RvY29sLWNzcy1yZWdpb25zLWNvbW1hbmRzLmh0bWwiLAogICAgImluc3BlY3Rvci9zdHlsZXMvcmVnaW9uLXN0eWxlLWNyYXNoLmh0bWwiLAogICAgImluc3BlY3Rvci9zdHlsZXMvc3R5bGVzLWRpc2FibGUtdGhlbi1lbmFibGUtb3ZlcnJpZGVuLXVhLmh0bWwiLAogICAgImluc3BlY3Rvci9zdHlsZXMvc3R5bGVzLXVybC1saW5raWZ5Lmh0bWwiLAogICAgImluc3BlY3Rvci9zdHlsZXMvdmVuZG9yLXByZWZpeGVzLmh0bWwiLAogICAgImluc3BlY3Rvci90aW1lbGluZS90aW1lbGluZS1ldmVudC1kaXNwYXRjaC5odG1sIiwKICAgICJpbnNwZWN0b3IvdGltZWxpbmUvdGltZWxpbmUtZnJhbWVzLmh0bWwiLAogICAgImluc3BlY3Rvci90aW1lbGluZS90aW1lbGluZS1uZXR3b3JrLXJlc291cmNlLmh0bWwiLAogICAgImluc3BlY3Rvci90aW1lbGluZS90aW1lbGluZS1wYWludC5odG1sIiwKICAgICJpbnNwZWN0b3IvdGltZWxpbmUvdGltZWxpbmUtcmVjZWl2ZS1yZXNwb25zZS1ldmVudC5odG1sIiwKCiAgICAvLyBUSU1FT1VUCiAgICAiaW5zcGVjdG9yL3Byb2ZpbGVyL2NwdS1wcm9maWxlci1wcm9maWxpbmctd2l0aG91dC1pbnNwZWN0b3IuaHRtbCIsCiAgICAiaW5zcGVjdG9yL3Byb2ZpbGVyL2hlYXAtc25hcHNob3QtaW5zcGVjdC1kb20td3JhcHBlci5odG1sIiwKICAgICJpbnNwZWN0b3IvdGltZWxpbmUvdGltZWxpbmUtbmV0d29yay1yZWNlaXZlZC1kYXRhLmh0bWwiLApdOwp2YXIgdHJlZU91dGxpbmUgPSBudWxsOwoKZnVuY3Rpb24gcnVuKGRlYnVnKQp7CiAgICBpZiAod2luZG93LnJ1bm5lciAmJiBkZWJ1ZykgewogICAgICAgIHdpbmRvdy5ydW5uZXIuY29udGludWVEZWJ1Z2dpbmcoKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHdpbmRvdy50ZXN0U2Nhbm5lcklmcmFtZSkgCiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh3aW5kb3cudGVzdFNjYW5uZXJJZnJhbWUpOwoKICAgIGlmICh3aW5kb3cucnVubmVyKQogICAgICAgIHdpbmRvdy5ydW5uZXIuY2xlYW51cCgpOwoKICAgIHdpbmRvdy50ZXN0U2Nhbm5lcklmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlmcmFtZSIpOwogICAgd2luZG93LnRlc3RTY2FubmVySWZyYW1lLnNyYyA9IHNjYW5uZXJTZXJ2ZXIgKyAiTGF5b3V0VGVzdHMvaHR0cC90ZXN0cy9pbnNwZWN0b3IvcmVzb3VyY2VzL3Rlc3Qtc2Nhbm5lci5odG1sIjsKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQod2luZG93LnRlc3RTY2FubmVySWZyYW1lKTsKICAgIHdpbmRvdy5kZWJ1ZyA9IGRlYnVnOwp9CgpmdW5jdGlvbiBydW5UZXN0cygpCnsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJvdXRsaW5lIikucmVtb3ZlQ2hpbGRyZW4oKTsKICAgIHRyZWVPdXRsaW5lID0gbmV3IFRyZWVPdXRsaW5lKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJvdXRsaW5lIikpOwoKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwYXNzIikudGV4dENvbnRlbnQgPSAwOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNraXAiKS50ZXh0Q29udGVudCA9IDA7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZmFpbCIpLnRleHRDb250ZW50ID0gMDsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0aW1lb3V0IikudGV4dENvbnRlbnQgPSAwOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlbWFpbmluZyIpLnRleHRDb250ZW50ID0gdGVzdHMubGVuZ3RoOwoKICAgIHJ1bk5leHRUZXN0KCk7Cn0KCmZ1bmN0aW9uIGludGVycnVwdCgpCnsKICAgIHRlc3RzID0gW107Cn0KCmZ1bmN0aW9uIHJ1bk5leHRUZXN0KGxhc3RSZXN1bHQpCnsKICAgIGlmIChsYXN0UmVzdWx0KSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChsYXN0UmVzdWx0KTsKICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gcGFyc2VJbnQoZWxlbWVudC50ZXh0Q29udGVudCkgKyAxOwoKICAgICAgICBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlbWFpbmluZyIpOwogICAgICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSBwYXJzZUludChlbGVtZW50LnRleHRDb250ZW50KSAtIDE7CiAgICAgICAgaWYgKHdpbmRvdy5kZWJ1ZykgewogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZGVidWciKS50ZXh0Q29udGVudCA9ICJEZWJ1ZyI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgdmFyIHRlc3Q7CiAgICB2YXIgZmlsdGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbHRlciIpLnZhbHVlOwogICAgd2hpbGUgKHRlc3QgPSB0ZXN0cy5zaGlmdCgpKSB7CiAgICAgICAgaWYgKCFmaWx0ZXIgfHwgdGVzdFswXS5tYXRjaChmaWx0ZXIpKSB7CiAgICAgICAgICAgIG5ldyBTdGFuZGFsb25lVGVzdFJ1bm5lcihsYXlvdXRUZXN0c1NlcnZlciArIHRlc3RbMF0sIHRlc3RbMV0sIHJ1bk5leHRUZXN0LmJpbmQobnVsbCkpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQp9CgpmdW5jdGlvbiBTdGFuZGFsb25lVGVzdFJ1bm5lcih0ZXN0UGF0aCwgZXhwZWN0ZWQsIG5leHQpCnsKICAgIHRoaXMuX3Rlc3RQYXRoID0gdGVzdFBhdGg7CiAgICB0aGlzLl9uZXh0ID0gbmV4dDsKICAgIHRoaXMuX2V4cGVjdGVkID0gZXhwZWN0ZWQ7CiAgICB0aGlzLl9wZW5kaW5nTWVzc2FnZXMgPSBbXTsKCiAgICB0aGlzLl90cmVlRWxlbWVudCA9IG5ldyBUcmVlRWxlbWVudCh0ZXN0UGF0aCk7CiAgICB0cmVlT3V0bGluZS5hcHBlbmRDaGlsZCh0aGlzLl90cmVlRWxlbWVudCk7CgogICAgZm9yICh2YXIgaSA9IDA7ICF3aW5kb3cuZGVidWcgJiYgaSA8IHNraXBMaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKHRlc3RQYXRoLmluZGV4T2Yoc2tpcExpc3RbaV0pICE9PSAtMSkgewogICAgICAgICAgICB0aGlzLl90cmVlRWxlbWVudC50aXRsZSA9IHRlc3RQYXRoICsgIjogU0tJUFBFRCI7CiAgICAgICAgICAgIHRoaXMuX25leHQoInNraXAiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KICAgIHdpbmRvdy5ydW5uZXIgPSB0aGlzOwogICAgdGhpcy5fdGVzdFBhZ2UgPSB3aW5kb3cub3BlbigiYWJvdXQ6YmxhbmsiLCAiaW5zcGVjdGVkIiwgIndpZHRoPTgwMCxoZWlnaHQ9NjAwIik7CgogICAgd2luZG93LnJlbW90ZURlYnVnZ2luZ0hhbmRzaGFrZSA9IHRoaXMuX3JlbW90ZURlYnVnZ2luZ0hhbmRzaGFrZS5iaW5kKHRoaXMpOwogICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgc2NyaXB0LnNyYyA9IHJlbW90ZURlYnVnZ2luZ1NlcnZlciArICJqc29uP2pzb25wPXJlbW90ZURlYnVnZ2luZ0hhbmRzaGFrZSI7CiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7Cn0KClN0YW5kYWxvbmVUZXN0UnVubmVyLkZyb250ZW5kTG9jYXRpb24gPSAiaW5zcGVjdG9yLmh0bWwiOwoKU3RhbmRhbG9uZVRlc3RSdW5uZXIucHJvdG90eXBlID0gewogICAgX3JlbW90ZURlYnVnZ2luZ0hhbmRzaGFrZTogZnVuY3Rpb24oZGF0YSkKICAgIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKGRhdGFbaV0udXJsICE9PSAiYWJvdXQ6YmxhbmsiKQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnZ2VyVVJMID0gZGF0YVtpXS53ZWJTb2NrZXREZWJ1Z2dlclVybC5yZXBsYWNlKCI6Ly8iLCAiPSIpOwogICAgICAgICAgICB0aGlzLl9uYXZpZ2F0ZVRlc3RQYWdlKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0sCgogICAgX25hdmlnYXRlVGVzdFBhZ2U6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl90ZXN0UGFnZS5sb2NhdGlvbi5ocmVmID0gdGhpcy5fdGVzdFBhdGg7CiAgICAgICAgdmFyIHdpZHRoID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2luc3BlY3RvcldpZHRoJykgfHwgNjAwOwogICAgICAgIHZhciBoZWlnaHQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnaW5zcGVjdG9ySGVpZ2h0JykgfHwgNDAwOwogICAgICAgIHZhciBmZWF0dXJlcyA9ICJ3aWR0aD0iICsgTWF0aC5tYXgod2lkdGggLCA2MDApICsgIixoZWlnaHQ9IiArIE1hdGgubWF4KGhlaWdodCwgNDAwKTsKICAgICAgICB0aGlzLl9pbnNwZWN0b3JXaW5kb3dMb2FkaW5nID0gd2luZG93Lm9wZW4oU3RhbmRhbG9uZVRlc3RSdW5uZXIuRnJvbnRlbmRMb2NhdGlvbiArICI/IiArIHRoaXMuX2RlYnVnZ2VyVVJMLCAiaW5zcGVjdG9yIiwgZmVhdHVyZXMpOwogICAgICAgIHRoaXMuX2luc3BlY3RvcldpbmRvd0xvYWRpbmcuZGlzcGF0Y2hTdGFuZGFsb25lVGVzdFJ1bm5lck1lc3NhZ2VzID0gdHJ1ZTsKICAgICAgICAKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndW5sb2FkJywgdGhpcy5jbGVhbnVwLmJpbmQodGhpcykpOwoKICAgICAgICBpZiAoIXdpbmRvdy5kZWJ1ZykKICAgICAgICAgICAgdGhpcy5fd2F0Y2hEb2cgPSBzZXRUaW1lb3V0KHRoaXMuX3RpbWVvdXQuYmluZCh0aGlzKSwgMTAwMDApOwogICAgfSwKCiAgICBsb2FkQ29tcGxldGVkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgaWYgKCF3aW5kb3cuZGVidWcpIHsKICAgICAgICAgICAgdGhpcy5fbG9hZENvbXBsZXRlZCh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZGVidWciKS50ZXh0Q29udGVudCA9ICJDb250aW51ZSI7CiAgICB9LAoKICAgIGNvbnRpbnVlRGVidWdnaW5nOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fbG9hZENvbXBsZXRlZCgpOwogICAgfSwKCiAgICBfbG9hZENvbXBsZXRlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX2luc3BlY3RvcldpbmRvdyA9IHRoaXMuX2luc3BlY3RvcldpbmRvd0xvYWRpbmc7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9wZW5kaW5nTWVzc2FnZXMubGVuZ3RoOyArK2kpCiAgICAgICAgICAgIHRoaXMuX2luc3BlY3RvcldpbmRvdy5wb3N0TWVzc2FnZSh0aGlzLl9wZW5kaW5nTWVzc2FnZXNbaV0sICIqIik7CiAgICAgICAgdGhpcy5fcGVuZGluZ01lc3NhZ2VzID0gW107CiAgICB9LAoKICAgIGNsb3NlV2ViSW5zcGVjdG9yOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgaWYgKCF3aW5kb3cuZGVidWcpCiAgICAgICAgICAgIHRoaXMuX2luc3BlY3RvcldpbmRvdy5jbG9zZSgpOwogICAgfSwKCiAgICBub3RpZnlEb25lOiBmdW5jdGlvbihhY3R1YWwpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX2RvbmUpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB0aGlzLl9kb25lID0gdHJ1ZTsKCiAgICAgICAgaWYgKCF3aW5kb3cuZGVidWcpIAogICAgICAgICAgICB0aGlzLmNsZWFudXAoKQoKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fd2F0Y2hEb2cpOwoKICAgICAgICB0aGlzLl90cmVlRWxlbWVudC5vbnNlbGVjdCA9IHRoaXMub25UcmVlRWxlbWVudFNlbGVjdC5iaW5kKHRoaXMpOwoKICAgICAgICAvLyBUT0RPIHBhdmVsICBpcyB0aGUgIFJIUyB8fCBjb25kaXRpb24gd2FudGVkPwogICAgICAgIGlmIChhY3R1YWwgPT09IHRoaXMuX2V4cGVjdGVkIHx8IGFjdHVhbCA9PT0gdGhpcy5fZXhwZWN0ZWQgKyAiXG4iKSB7CiAgICAgICAgICAgIHRoaXMuX3RyZWVFbGVtZW50LnRpdGxlID0gdGhpcy5fdGVzdFBhdGggKyAiOiBTVUNDRVNTIjsKICAgICAgICAgICAgdGhpcy5fbmV4dCgicGFzcyIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl90cmVlRWxlbWVudC50aXRsZSA9IHRoaXMuX3Rlc3RQYXRoICsgIjogRkFJTEVEIjsKICAgICAgICB0aGlzLl90cmVlRWxlbWVudC5saXN0SXRlbUVsZW1lbnQuYWRkU3R5bGVDbGFzcygiZmFpbGVkIik7CgogICAgICAgIHZhciBiYXNlTGluZXMgPSBkaWZmbGliLnN0cmluZ0FzTGluZXModGhpcy5fZXhwZWN0ZWQpOwogICAgICAgIHZhciBuZXdMaW5lcyA9IGRpZmZsaWIuc3RyaW5nQXNMaW5lcyhhY3R1YWwpOwogICAgICAgIHZhciBzbSA9IG5ldyBkaWZmbGliLlNlcXVlbmNlTWF0Y2hlcihiYXNlTGluZXMsIG5ld0xpbmVzKTsKICAgICAgICB2YXIgb3Bjb2RlcyA9IHNtLmdldF9vcGNvZGVzKCk7CiAgICAgICAgdmFyIGxhc3RXYXNTZXBhcmF0b3IgPSBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgb3Bjb2Rlcy5sZW5ndGg7IGlkeCsrKSB7CiAgICAgICAgICAgIHZhciBjb2RlID0gb3Bjb2Rlc1tpZHhdOwogICAgICAgICAgICB2YXIgY2hhbmdlID0gY29kZVswXTsKICAgICAgICAgICAgdmFyIGIgPSBjb2RlWzFdOwogICAgICAgICAgICB2YXIgYmUgPSBjb2RlWzJdOwogICAgICAgICAgICB2YXIgbiA9IGNvZGVbM107CiAgICAgICAgICAgIHZhciBuZSA9IGNvZGVbNF07CiAgICAgICAgICAgIHZhciByb3dDb3VudCA9IE1hdGgubWF4KGJlIC0gYiwgbmUgLSBuKTsKICAgICAgICAgICAgdmFyIHRvcFJvd3MgPSBbXTsKICAgICAgICAgICAgdmFyIGJvdHRvbVJvd3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3dDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmdlID09PSAiZGVsZXRlIiB8fCAoY2hhbmdlID09PSAicmVwbGFjZSIgJiYgYiA8IGJlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBsaW5lTnVtYmVyID0gYisrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3RyZWVFbGVtZW50LmFwcGVuZENoaWxkKG5ldyBUcmVlRWxlbWVudCgiLSBbIiArIGxpbmVOdW1iZXIgKyAiXSAiICsgYmFzZUxpbmVzW2xpbmVOdW1iZXJdKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGNoYW5nZSA9PT0gImluc2VydCIgfHwgKGNoYW5nZSA9PT0gInJlcGxhY2UiICYmIG4gPCBuZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IG4rKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl90cmVlRWxlbWVudC5hcHBlbmRDaGlsZChuZXcgVHJlZUVsZW1lbnQoIisgWyIgKyBsaW5lTnVtYmVyICsgIl0gIiArIG5ld0xpbmVzW2xpbmVOdW1iZXJdKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGNoYW5nZSA9PT0gImVxdWFsIikgewogICAgICAgICAgICAgICAgICAgIGIrKzsKICAgICAgICAgICAgICAgICAgICBuKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuX25leHQoImZhaWwiKTsKICAgIH0sCgogICAgZXZhbHVhdGVJbldlYkluc3BlY3RvcjogZnVuY3Rpb24oY2FsbElkLCBzY3JpcHQpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX2luc3BlY3RvcldpbmRvdykKICAgICAgICAgICAgdGhpcy5faW5zcGVjdG9yV2luZG93LnBvc3RNZXNzYWdlKFsiZXZhbHVhdGVGb3JUZXN0IiwgY2FsbElkLCBzY3JpcHRdLCAiKiIpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgdGhpcy5fcGVuZGluZ01lc3NhZ2VzLnB1c2goWyJldmFsdWF0ZUZvclRlc3QiLCBjYWxsSWQsIHNjcmlwdF0pOwogICAgfSwKCiAgICBfdGltZW91dDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3RyZWVFbGVtZW50LnRpdGxlID0gdGhpcy5fdGVzdFBhdGggKyAiOiBUSU1FT1VUIjsKICAgICAgICB0aGlzLl90cmVlRWxlbWVudC5saXN0SXRlbUVsZW1lbnQuYWRkU3R5bGVDbGFzcygidGltZW91dCIpOwogICAgICAgIHRoaXMuX2RvbmUgPSB0cnVlOwogICAgICAgIHRoaXMuY2xlYW51cCgpOwogICAgICAgIHRoaXMuX25leHQoInRpbWVvdXQiKTsKICAgIH0sCgogICAgY2xlYW51cDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnaW5zcGVjdG9yV2lkdGgnLCB0aGlzLl9pbnNwZWN0b3JXaW5kb3dMb2FkaW5nLm91dGVyV2lkdGgpOwogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdpbnNwZWN0b3JIZWlnaHQnLCB0aGlzLl9pbnNwZWN0b3JXaW5kb3dMb2FkaW5nLm91dGVySGVpZ2h0KTsKICAgICAgICB0aGlzLl9pbnNwZWN0b3JXaW5kb3dMb2FkaW5nLmNsb3NlKCk7CiAgICAgICAgdGhpcy5fdGVzdFBhZ2UuY2xvc2UoKTsKICAgICAgICBkZWxldGUgd2luZG93LnJ1bm5lcjsKICAgIH0sCgogICAgb25UcmVlRWxlbWVudFNlbGVjdDogZnVuY3Rpb24gKCkgCiAgICB7CiAgICAgICAgdmFyIGJhc2VFbmRTZW50aW5lbCA9ICcvaW5zcGVjdG9yLyc7CiAgICAgICAgdmFyIGJhc2VDaGFycyA9IHRoaXMuX3Rlc3RQYXRoLmluZGV4T2YoYmFzZUVuZFNlbnRpbmVsKSArIGJhc2VFbmRTZW50aW5lbC5sZW5ndGg7CiAgICAgICAgaWYgKGJhc2VDaGFycyA+IDApIAogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZmlsdGVyIikudmFsdWUgPSB0aGlzLl90ZXN0UGF0aC5zdWJzdHIoYmFzZUNoYXJzKTsKICAgIH0sCgogICAgZGlzcGxheTogZnVuY3Rpb24oKSB7IH0KfQoKZnVuY3Rpb24gb25NZXNzYWdlRnJvbVRlc3RQYWdlKGV2ZW50KQp7CiAgICB2YXIgc2lnbmF0dXJlID0gZXZlbnQuZGF0YTsKICAgIHZhciBtZXRob2QgPSBzaWduYXR1cmUuc2hpZnQoKTsKICAgIGlmIChtZXRob2QgPT09ICJ0ZXN0cyIpIHsKICAgICAgICB0ZXN0cyA9IHNpZ25hdHVyZVswXTsKICAgICAgICBydW5UZXN0cygpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAod2luZG93LnJ1bm5lcikKICAgICAgICB3aW5kb3cucnVubmVyW21ldGhvZF0uYXBwbHkod2luZG93LnJ1bm5lciwgc2lnbmF0dXJlKTsKfQoKZnVuY3Rpb24gb25sb2FkKCkKewogICAgdmFyIHF1ZXJ5UGFyYW1zT2JqZWN0ID0ge307CiAgICB2YXIgcXVlcnlQYXJhbXMgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoOwogICAgaWYgKCFxdWVyeVBhcmFtcykKICAgICAgICByZXR1cm47CiAgICB2YXIgcGFyYW1zID0gcXVlcnlQYXJhbXMuc3Vic3RyaW5nKDEpLnNwbGl0KCImIik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBwYWlyID0gcGFyYW1zW2ldLnNwbGl0KCI9Iik7CiAgICAgICAgcXVlcnlQYXJhbXNPYmplY3RbcGFpclswXV0gPSBwYWlyWzFdOwogICAgfQogICAgaWYgKCJmaWx0ZXIiIGluIHF1ZXJ5UGFyYW1zT2JqZWN0KQogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmaWx0ZXIiKS52YWx1ZSA9IHF1ZXJ5UGFyYW1zT2JqZWN0WyJmaWx0ZXIiXTsKfQoKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBvbk1lc3NhZ2VGcm9tVGVzdFBhZ2UsIHRydWUpOwoKPC9zY3JpcHQ+Cjxib2R5IG9ubG9hZD0ib25sb2FkKCkiPgpUaGlzIGlzIGEgc3RhbmRhbG9uZSB0ZXN0IHN1aXRlIGZvciBpbnNwZWN0b3IgZnJvbnQtZW5kLiBIZXJlIGlzIGhvdyB5b3UgcnVuIGl0Ogo8dWw+CjxsaT5DaGVjayBvdXQgV2ViS2l0IHNvdXJjZSB0cmVlOiBnaXQgY2xvbmUgaHR0cDovL2dpdC5jaHJvbWl1bS5vcmcvZXh0ZXJuYWwvV2Via2l0LmdpdDwvbGk+CjxsaT5SdW4gIlRvb2xzL1NjcmlwdHMvbmV3LXJ1bi13ZWJraXQtaHR0cGQgLS1yb290PS4gLS1wb3J0PTgwMDIgLS1zZXJ2ZXI9c3RhcnQiPC9saT4KPGxpPlJ1biBDaHJvbWUgQ2FuYXJ5IChUb1QgQ2hyb21pdW0pIHdpdGggZm9sbG93aW5nIGZsYWdzOiAiLS1yZW1vdGUtZGVidWdnaW5nLXBvcnQ9OTIyMiAtLXVzZXItZGF0YS1kaXI9dGVzdFByb2ZpbGUgaHR0cDovL2xvY2FsaG9zdDo4MDAyL1NvdXJjZS9kZXZ0b29scy9mcm9udF9lbmQvdGVzdC1ydW5uZXIuaHRtbCI8L2xpPgo8L3VsPgoKPGJ1dHRvbiBvbmNsaWNrPSJydW4oKSI+UnVuPC9idXR0b24+CjxidXR0b24gaWQ9ImRlYnVnIiBvbmNsaWNrPSJydW4odHJ1ZSkiPkRlYnVnPC9idXR0b24+CjxidXR0b24gb25jbGljaz0iaW50ZXJydXB0KCkiPkludGVycnVwdDwvYnV0dG9uPgpGaWx0ZXI6IDxpbnB1dCBpZD0iZmlsdGVyIiB0eXBlPSJ0ZXh0IiBzaXplPSI0MCI+PC9pbnB1dD48c21hbGw+PGk+Q2xpY2sgb24gcmVzdWx0cyB0byBsb2FkIGZpbHRlcjwvaT48L3NtYWxsPjxicj4KCjxzcGFuPlBhc3NlZDogPHNwYW4gaWQ9InBhc3MiPjA8L3NwYW4+PC9zcGFuPgo8c3Bhbj5GYWlsZWQ6IDxzcGFuIGlkPSJmYWlsIj4wPC9zcGFuPjwvc3Bhbj4KPHNwYW4+VGltZW91dDogPHNwYW4gaWQ9InRpbWVvdXQiPjA8L3NwYW4+PC9zcGFuPgo8c3Bhbj5Ta2lwcGVkOiA8c3BhbiBpZD0ic2tpcCI+MDwvc3Bhbj48L3NwYW4+CjxzcGFuPlJlbWFpbmluZzogPHNwYW4gaWQ9InJlbWFpbmluZyI+MDwvc3Bhbj48YnI+Cgo8b2wgaWQ9Im91dGxpbmUiIHN0eWxlPSJmb250LXNpemU6IDEycHggIWltcG9ydGFudCIgY2xhc3M9InNvdXJjZS1jb2RlIG91dGxpbmUtZGlzY2xvc3VyZSI+PC9vbD4KCjwvYm9keT4KPC9odG1sPgo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 19:35:16 GMT",
                    "Content-Length": "11681",
                    "Date": "Fri, 07 Nov 2014 19:35:21 GMT",
                    "Content-Type": "text/html; charset=utf-8"
                },
                "cookies": [],
                "mimeType": "HTML",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}