{
    "url": "http://localhost:9999/kirkas/Ascensor.js/src/jquery.ascensor.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location</b> and written to <b>window.location.replace()</b> via the following statement:<ul><li>window.location.replace(('' + window.location).split('#')[0] + '#' + this.options.ascensorFloorName[floorIndex]);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/kirkas/Ascensor.js/src/jquery.ascensor.js",
                "path": "/kirkas/Ascensor.js/src/jquery.ascensor.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9raXJrYXMvQXNjZW5zb3IuanMvc3JjL2pxdWVyeS5hc2NlbnNvci5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzMwMjENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTA6NDQ6MDggR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDEwOjQ0OjA3IEdNVA0KDQooZnVuY3Rpb24oJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7CiAgdmFyIHBsdWdpbk5hbWUgPSAnYXNjZW5zb3InOwoKCiAgLyogRGVmYXVsdCBzZXR0aW5ncyAqLwogIHZhciBkZWZhdWx0cyA9IHsKICAgIGFzY2Vuc29yRmxvb3JOYW1lOiBmYWxzZSwKICAgIGNoaWxkVHlwZTogJ2RpdicsCiAgICB3aW5kb3dzT246IDAsCiAgICBkaXJlY3Rpb246ICd5JywKICAgIGxvb3A6IGZhbHNlLAogICAgd2lkdGg6ICcxMDAlJywKICAgIGhlaWdodDogJzEwMCUnLAogICAgdGltZTogMjUwLAogICAgZWFzaW5nOiAnbGluZWFyJywKICAgIGtleU5hdmlnYXRpb246IHRydWUsCiAgICBxdWV1ZWQ6IGZhbHNlLAogICAganVtcDogZmFsc2UsCiAgICByZWFkeTogZmFsc2UsCiAgICBzd2lwZU5hdmlnYXRpb246ICdtb2JpbGUtb25seScsCiAgICBzd2lwZVZlbG9jaXR5OiAwLjcsCiAgICB3aGVlbE5hdmlnYXRpb246IGZhbHNlLAogICAgd2hlZWxOYXZpZ2F0aW9uRGVsYXk6IDQwLAogIH07CgogIC8qIFBsdWdpbiBpbnN0YW5jZSAqLwogIGZ1bmN0aW9uIFBsdWdpbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgdGhpcy5vcHRpb25zID0gJC5leHRlbmQoe30sIGRlZmF1bHRzLCBvcHRpb25zKTsKICAgIHRoaXMuX2RlZmF1bHRzID0gZGVmYXVsdHM7CiAgICB0aGlzLl9uYW1lID0gcGx1Z2luTmFtZTsKICAgIHRoaXMuaW5pdCgpOwogIH0KCiAgLy8gRnJvbSBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9sb3JlbnpvcG9saWRvcmkvMzc5NDIyNgogIGZ1bmN0aW9uIGhhczNkKCkgewogICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpLAogICAgICBzdXBwb3J0M0QsCiAgICAgIHRyYW5zZm9ybXMgPSB7CiAgICAgICAgJ3dlYmtpdFRyYW5zZm9ybSc6ICctd2Via2l0LXRyYW5zZm9ybScsCiAgICAgICAgJ09UcmFuc2Zvcm0nOiAnLW8tdHJhbnNmb3JtJywKICAgICAgICAnbXNUcmFuc2Zvcm0nOiAnLW1zLXRyYW5zZm9ybScsCiAgICAgICAgJ01velRyYW5zZm9ybSc6ICctbW96LXRyYW5zZm9ybScsCiAgICAgICAgJ3RyYW5zZm9ybSc6ICd0cmFuc2Zvcm0nCiAgICAgIH07CiAgICBkb2N1bWVudC5ib2R5Lmluc2VydEJlZm9yZShlbCwgbnVsbCk7CiAgICBmb3IgKHZhciB0IGluIHRyYW5zZm9ybXMpIHsKICAgICAgaWYgKGVsLnN0eWxlW3RdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBlbC5zdHlsZVt0XSA9ICd0cmFuc2xhdGUzZCgxcHgsMXB4LDFweCknOwogICAgICAgIHN1cHBvcnQzRCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKS5nZXRQcm9wZXJ0eVZhbHVlKHRyYW5zZm9ybXNbdF0pOwogICAgICB9CiAgICB9CiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGVsKTsKICAgIHJldHVybiAoc3VwcG9ydDNEICE9PSB1bmRlZmluZWQgJiYgc3VwcG9ydDNELmxlbmd0aCA+IDAgJiYgc3VwcG9ydDNEICE9PSAnbm9uZScpOwogIH0KCgogIC8qIEFkZCAnaW5kZXhPZicgaGVscGVyIGluIGNhc2UgbWlzc2luZyAoSUU4KSAqLwogIGlmICghQXJyYXkucHJvdG90eXBlLmluZGV4T2YpIHsKICAgIEFycmF5LnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24oZWx0IC8qLCBmcm9tKi8gKSB7CiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aCA+Pj4gMDsKICAgICAgdmFyIGZyb20gPSBOdW1iZXIoYXJndW1lbnRzWzFdKSB8fCAwOwogICAgICBmcm9tID0gKGZyb20gPCAwKSA/IE1hdGguY2VpbChmcm9tKSA6IE1hdGguZmxvb3IoZnJvbSk7CiAgICAgIGlmIChmcm9tIDwgMCkgZnJvbSArPSBsZW47CiAgICAgIGZvciAoOyBmcm9tIDwgbGVuOyBmcm9tKyspIHsKICAgICAgICBpZiAoZnJvbSBpbiB0aGlzICYmIHRoaXNbZnJvbV0gPT09IGVsdCkgcmV0dXJuIGZyb207CiAgICAgIH0KICAgICAgcmV0dXJuIC0xOwogICAgfTsKICB9CgogIC8qIEFycmF5IGhlbHBlciAqLwogIGZ1bmN0aW9uIGV4aXN0SW5BcnJheShhcnJheSwgaXRlbSkgewogICAgdmFyIGluZGV4ID0gYXJyYXkuaW5kZXhPZihpdGVtKTsKICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiB0cnVlOwogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLyogVmFsdWUgaGVscGVyICovCiAgZnVuY3Rpb24gaXNGYWxzZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGlzVHJ1ZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSB0cnVlOwogIH0KCiAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YodmFsdWUpID09PSAnbnVtYmVyJzsKICB9CgogIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mKHZhbHVlKSA9PT0gJ3N0cmluZyc7CiAgfQoKICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mKHZhbHVlKSA9PT0gJ2Z1bmN0aW9uJzsKICB9CgogIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mKHZhbHVlKSA9PT0gJ29iamVjdCc7CiAgfQoKCiAgLyogUGx1Z2luIHN0YXJ0ICovCiAgUGx1Z2luLnByb3RvdHlwZSA9IHsKCiAgICAvKiBJbml0aWFsaXphdGlvbiBvZiBwbHVnaW4gKi8KICAgIGluaXQ6IGZ1bmN0aW9uKCkgewoKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgLy8gQ29uc3RhbnQgaGVscGVyCiAgICAgIHRoaXMuQVhJU19YID0gMTsKICAgICAgdGhpcy5BWElTX1kgPSAwOwoKICAgICAgdGhpcy5kYXRhQXR0cmlidXRlTWFwID0gewogICAgICAgICJuZXh0IjogImFzY2Vuc29yLW5leHQiLAogICAgICAgICJwcmV2IjogImFzY2Vuc29yLXByZXYiLAogICAgICAgICJkb3duIjogImFzY2Vuc29yLWRvd24iLAogICAgICAgICJ1cCI6ICJhc2NlbnNvci11cCIsCiAgICAgICAgImxlZnQiOiAiYXNjZW5zb3ItbGVmdCIsCiAgICAgICAgInJpZ2h0IjogImFzY2Vuc29yLXJpZ2h0IgogICAgICB9OwoKICAgICAgLy8gU2V0dXAgZ2xvYmFsIHZhcmlhYmxlIC0gc2VsZWN0b3IgCiAgICAgIHRoaXMubm9kZSA9ICQodGhpcy5lbGVtZW50KTsKICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4gPSB0aGlzLm5vZGUuY2hpbGRyZW4odGhpcy5vcHRpb25zLmNoaWxkVHlwZSk7CiAgICAgIHRoaXMuZmxvb3JBY3RpdmUgPSAoaXNOdW1iZXIodGhpcy5fZ2V0Rmxvb3JGcm9tSGFzaCgpKSkgPyB0aGlzLl9nZXRGbG9vckZyb21IYXNoKCkgOiB0aGlzLm9wdGlvbnMud2luZG93c09uOwoKICAgICAgdGhpcy5OSCA9IHRoaXMubm9kZS5oZWlnaHQoKTsKICAgICAgdGhpcy5OVyA9IHRoaXMubm9kZS53aWR0aCgpOwoKICAgICAgLy8gU2V0dXAgZ2xvYmFsIHZhcmlhYmxlIC0gaGVscGVyCiAgICAgIHZhciBhbmRyb2lkQ29tcGF0aWJsZSA9IHRydWU7CiAgICAgIHZhciB2ZXJzaW9uID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvQW5kcm9pZFxzKyhbXGRcLl0rKS8pOwogICAgICBpZiAodmVyc2lvbikgYW5kcm9pZENvbXBhdGlibGUgPSBwYXJzZUZsb2F0KHZlcnNpb25bMV0pID4gMzsKCgogICAgICB0aGlzLmRpcmVjdGlvbklzQXJyYXkgPSBpc09iamVjdCh0aGlzLm9wdGlvbnMuZGlyZWN0aW9uKTsKICAgICAgdGhpcy5zdXBwb3J0VHJhbnNmb3JtID0gaGFzM2QoKSAmJiBhbmRyb2lkQ29tcGF0aWJsZTsKCgoKICAgICAgLy8gQ2hlY2sgaWYgZmxvb3IgbmFtZSBhcnJheSAmIG5vZGUgY2hpbGRyZW4gbGVuZ3RoIG1hdGNoCiAgICAgIGlmIChpc09iamVjdCh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUpICYmIHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZS5sZW5ndGggPCB0aGlzLm5vZGVDaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZW1pdENvbnNvbGVNZXNzYWdlKCJlcnJvciIsICJmbG9vcnMgdG90YWwgKCIgKyB0aGlzLm5vZGVDaGlsZHJlbi5sZW5ndGggKyAiKSAmIGZsb29yIG5hbWUgYXJyYXkgbGVuZ3RoICgiICsgdGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lLmxlbmd0aCArICIpIGRvbid0IG1hdGNoIik7CiAgICAgIH0KCiAgICAgIC8vIENoZWNrIGlmIGRpcmVjdGlvbiBhcnJheSAmIG5vZGUgY2hpbGRyZW4gbGVuZ3RoIG1hdGNoCiAgICAgIGlmICh0aGlzLmRpcmVjdGlvbklzQXJyYXkgJiYgdGhpcy5vcHRpb25zLmRpcmVjdGlvbi5sZW5ndGggPCB0aGlzLm5vZGVDaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZW1pdENvbnNvbGVNZXNzYWdlKCJlcnJvciIsICJmbG9vcnMgdG90YWwgKCIgKyB0aGlzLm5vZGVDaGlsZHJlbi5sZW5ndGggKyAiKSAmIGRpcmVjdGlvbiBhcnJheSBsZW5naHQgKCIgKyB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uLmxlbmd0aCArICIpIGRvbid0IG1hdGNoIik7CiAgICAgIH0KCiAgICAgIC8vIFN0YXJ0IHRoZSBtYWdpYwogICAgICB0aGlzLnNldHVwKCk7CgogICAgfSwKCgogICAgLyogTWFnaWMgKi8KICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fcG9zaXRpb25FbGVtZW50KCk7CiAgICAgIHRoaXMuX2JpbmRFdmVudHMoKTsKICAgICAgdGhpcy5zY3JvbGxUb0Zsb29yKHRoaXMuZmxvb3JBY3RpdmUpOwoKICAgICAgaWYgKGlzT2JqZWN0KHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSkpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuZmxvb3JBY3RpdmUpOwogICAgICB9CiAgICAgIGlmIChpc0Z1bmN0aW9uKHRoaXMub3B0aW9ucy5yZWFkeSkpIHRoaXMub3B0aW9ucy5yZWFkeSgpOwogICAgfSwKCgogICAgLyogU2V0dXAgVXNlciBsaXN0ZW5lciAqLwogICAgX2JpbmRFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICB0aGlzLm5vZGUub24oJ3Njcm9sbFRvRGlyZWN0aW9uJywgZnVuY3Rpb24oZXZlbnQsIGRpcmVjdGlvbikgewogICAgICAgIHNlbGYuc2Nyb2xsVG9EaXJlY3Rpb24oZGlyZWN0aW9uKTsKICAgICAgfSk7CgogICAgICB0aGlzLm5vZGUub24oJ3Njcm9sbFRvU3RhZ2UnLCBmdW5jdGlvbihldmVudCwgZmxvb3IpIHsKICAgICAgICBpZiAodHlwZW9mIGZsb29yID09ICdzdHJpbmcnKSB7CiAgICAgICAgICB2YXIgZmxvb3JJZCA9ICQuaW5BcnJheShmbG9vciwgc2VsZi5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lKTsKICAgICAgICAgIGlmIChmbG9vcklkICE9PSAtMSkgc2VsZi5zY3JvbGxUb0Zsb29yKGZsb29ySWQpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZsb29yID09ICdudW1iZXInKSB7CiAgICAgICAgICBpZiAoZmxvb3IgPiBzZWxmLm5vZGVDaGlsZHJlbi5sZW5ndGgpIHJldHVybjsKICAgICAgICAgIHNlbGYuc2Nyb2xsVG9GbG9vcihmbG9vcik7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHRoaXMubm9kZS5vbignbmV4dCcsIGZ1bmN0aW9uKGV2ZW50LCBmbG9vcikgewogICAgICAgIHZhciBkYXRhQXR0cmlidXRlRGlyZWN0aW9uID0gc2VsZi5ub2RlQ2hpbGRyZW4uZXEoc2VsZi5mbG9vckFjdGl2ZSkuZGF0YShzZWxmLmRhdGFBdHRyaWJ1dGVNYXAubmV4dCk7CiAgICAgICAgaWYgKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoZGF0YUF0dHJpYnV0ZURpcmVjdGlvbik7CiAgICAgICAgc2VsZi5uZXh0KCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlLm9uKCdwcmV2JywgZnVuY3Rpb24oZXZlbnQsIGZsb29yKSB7CiAgICAgICAgdmFyIGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24gPSBzZWxmLm5vZGVDaGlsZHJlbi5lcShzZWxmLmZsb29yQWN0aXZlKS5kYXRhKHNlbGYuZGF0YUF0dHJpYnV0ZU1hcC5wcmV2KTsKICAgICAgICBpZiAoZGF0YUF0dHJpYnV0ZURpcmVjdGlvbikgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihkYXRhQXR0cmlidXRlRGlyZWN0aW9uKTsKICAgICAgICBzZWxmLnByZXYoKTsKICAgICAgfSk7CgogICAgICB0aGlzLm5vZGUub24oJ3JlZnJlc2gnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLnJlZnJlc2goKTsKICAgICAgfSk7CgogICAgICB0aGlzLm5vZGUub24oJ3JlbW92ZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYuZGVzdHJveSgpOwogICAgICB9KTsKCiAgICAgIC8vIHNldHVwIHJlc2l6ZSAmIGtleSBsaXN0ZW5lcgogICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZS5hc2NlbnNvcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgc2VsZi5zY3JvbGxUb0Zsb29yKHNlbGYuZmxvb3JBY3RpdmUsIGZhbHNlKTsKICAgICAgfSk7CgogICAgICAvLyBJZiBmbG9vck5hbWUsIGFkZCBoYXNoY2hhbmdlIGxpc3RlbmVyCiAgICAgIGlmIChpc09iamVjdCh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUpKSB7CiAgICAgICAgJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlLmFzY2Vuc29yJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIHNlbGYuX2hhc2hjaGFuZ2VIYW5kbGVyKGV2ZW50KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgLy8gRGV0ZWN0IG9yaWVudGF0aW9uIGNoYW5nZSwgZm9yIGRldmljZQogICAgICBpZiAod2luZG93LkRldmljZU9yaWVudGF0aW9uRXZlbnQpIHsKICAgICAgICAkKHdpbmRvdykub24oJ29yaWVudGF0aW9uY2hhbmdlLmFzY2Vuc29yJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIHNlbGYuc2Nyb2xsVG9GbG9vcihzZWxmLmZsb29yQWN0aXZlKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMub3B0aW9ucy5rZXlOYXZpZ2F0aW9uKSB7CiAgICAgICAgJChkb2N1bWVudCkub24oJ2tleWRvd24uYXNjZW5zb3InLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgc2VsZi5fa2V5cHJlc3NIYW5kbGVyKGV2ZW50KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMub3B0aW9ucy53aGVlbE5hdmlnYXRpb24pIHsKICAgICAgICB0aGlzLm5vZGUub24oJ21vdXNld2hlZWwuYXNjZW5zb3InLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIXNlbGYuc2Nyb2xsSW5DaGlsZHJlbikgc2VsZi5faGFuZGxlTW91c2VXaGVlbEV2ZW50KGUpOwogICAgICAgICAgfSwgMTApOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLm5vZGVDaGlsZHJlbi5vbignc2Nyb2xsLmFzY2Vuc29yJywgZnVuY3Rpb24oZSkgewogICAgICAgICAgc2VsZi5zY3JvbGxJbkNoaWxkcmVuID0gdHJ1ZTsKICAgICAgICAgIGlmIChzZWxmLnNjcm9sbFRpbWVPdXQpIGNsZWFyVGltZW91dChzZWxmLnNjcm9sbFRpbWVPdXQpOwogICAgICAgICAgc2VsZi5zY3JvbGxUaW1lT3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5zY3JvbGxJbkNoaWxkcmVuID0gZmFsc2U7CiAgICAgICAgICB9LCAzMDApOwogICAgICAgIH0pOwogICAgICB9CgogICAgICAvLyBJZiBzd2lwZSBldmVudCBvcHRpb24gaXMgdHJ1ZSB8fCBzdHJpbmcKICAgICAgaWYgKHRoaXMub3B0aW9ucy5zd2lwZU5hdmlnYXRpb24pIHsKCiAgICAgICAgdmFyIHRvdWNoRXZlbnQgPSAndG91Y2hzdGFydC5hc2NlbnNvciB0b3VjaGVuZC5hc2NlbnNvciB0b3VjaGNhbmNlbC5hc2NlbnNvcic7CgogICAgICAgIC8vIElmIG1vYmlsZS1vbmx5LCBvbmx5IHVzZSB0b3VjaHN0YXJ0L2VuZCBldmVudAkJCQkKICAgICAgICBpZiAodGhpcy5vcHRpb25zLnN3aXBlTmF2aWdhdGlvbiAhPT0gJ21vYmlsZS1vbmx5JykgdG91Y2hFdmVudCArPSAnIG1vdXNlZG93bi5hc2NlbnNvciBtb3VzZXVwLmFzY2Vuc29yJzsKCiAgICAgICAgLy8gTGlzdGVuIHRvIHRvdWNoIGV2ZW50CiAgICAgICAgdGhpcy5ub2RlLm9uKHRvdWNoRXZlbnQsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBzZWxmLl9oYW5kbGVUb3VjaEV2ZW50KGV2ZW50KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKCiAgICByZWZyZXNoOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4gPSB0aGlzLm5vZGUuY2hpbGRyZW4odGhpcy5vcHRpb25zLmNoaWxkVHlwZSk7CiAgICAgIHRoaXMuX3Bvc2l0aW9uRWxlbWVudCgpOwogICAgfSwKCiAgICAvKiBSZW1vdmUgbWV0aG9kKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoKICAgICAgLy8gVW5iaW5kIGFsbCBiaW5kZWQgZXZlbnQKICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4ub2ZmKCdzY3JvbGwuYXNjZW5zb3InKTsKICAgICAgdGhpcy5ub2RlLm9mZignbW91c2V3aGVlbC5hc2NlbnNvciBzY3JvbGxUb0RpcmVjdGlvbiBzY3JvbGxUb1N0YWdlIG5leHQgcHJldiByZWZyZXNoIHJlbW92ZSB0b3VjaHN0YXJ0LmFzY2Vuc29yIHRvdWNoZW5kLmFzY2Vuc29yIG1vdXNlZG93bi5hc2NlbnNvciBtb3VzZXVwLmFzY2Vuc29yIHRvdWNoY2FuY2VsLmFzY2Vuc29yJyk7CiAgICAgICQod2luZG93KS5vZmYoJ3Jlc2l6ZS5hc2NlbnNvciBoYXNoY2hhbmdlLmFzY2Vuc29yIG9yaWVudGF0aW9uY2hhbmdlLmFzY2Vuc29yJyk7CiAgICAgICQoZG9jdW1lbnQpLm9mZigna2V5ZG93bi5hc2NlbnNvcicpOwoKICAgICAgLy8gUmVtb3ZlIGNzcwogICAgICB0aGlzLm5vZGUuY3NzKHsKICAgICAgICAncG9zaXRpb24nOiAnJywKICAgICAgICAnb3ZlcmZsb3cnOiAnJywKICAgICAgICAndG9wJzogJycsCiAgICAgICAgJ2xlZnQnOiAnJywKICAgICAgICAnd2lkdGgnOiAnJywKICAgICAgICAnaGVpZ2h0JzogJycKICAgICAgfSk7CgogICAgICB0aGlzLm5vZGVDaGlsZHJlbi5jc3MoewogICAgICAgICdwb3NpdGlvbic6ICcnLAogICAgICAgICdvdmVyZmxvdyc6ICcnLAogICAgICAgICd0b3AnOiAnJywKICAgICAgICAnbGVmdCc6ICcnLAogICAgICAgICd3aWR0aCc6ICcnLAogICAgICAgICdoZWlnaHQnOiAnJywKICAgICAgICAndHJhbnNmb3JtJzogJycKICAgICAgfSk7CgogICAgICAvLyBSZW1vdmUgcGx1Z2luIGluc3RhbmNlCiAgICAgIHRoaXMubm9kZS5yZW1vdmVEYXRhKCk7CiAgICB9LAoKICAgIF9oYW5kbGVNb3VzZVdoZWVsRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIGlmICh0aGlzLm5vZGUuaXMoJzphbmltYXRlZCcpKSByZXR1cm47CgogICAgICB0aGlzLnNjcm9sbFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICAgIGlmICghdGhpcy5sYXN0U2Nyb2xsVGltZSB8fCB0aGlzLnNjcm9sbFRpbWUgLSB0aGlzLmxhc3RTY3JvbGxUaW1lID4gdGhpcy5vcHRpb25zLndoZWVsTmF2aWdhdGlvbkRlbGF5KSB7CiAgICAgICAgdGhpcy5sYXN0U2Nyb2xsVGltZSA9IHRoaXMuc2Nyb2xsVGltZTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMubGFzdFNjcm9sbFRpbWUgPSB0aGlzLnNjcm9sbFRpbWU7CgogICAgICB2YXIgbW91c2VYID0gZXZlbnQub3JpZ2luYWxFdmVudC53aGVlbERlbHRhWDsKICAgICAgdmFyIG1vdXNlWSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQud2hlZWxEZWx0YVk7CgogICAgICBpZiAoTWF0aC5hYnMobW91c2VYKSA+IE1hdGguYWJzKG1vdXNlWSkgJiYgbW91c2VYID4gMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbignbGVmdCcpOwogICAgICBpZiAoTWF0aC5hYnMobW91c2VYKSA+IE1hdGguYWJzKG1vdXNlWSkgJiYgbW91c2VYIDwgMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbigncmlnaHQnKTsKICAgICAgaWYgKE1hdGguYWJzKG1vdXNlWSkgPiBNYXRoLmFicyhtb3VzZVgpICYmIG1vdXNlWSA+IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ3VwJyk7CiAgICAgIGlmIChNYXRoLmFicyhtb3VzZVkpID4gTWF0aC5hYnMobW91c2VYKSAmJiBtb3VzZVkgPCAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCdkb3duJyk7CgogICAgfSwKCgogICAgLyogVG91Y2ggZXZlbnQgaGFuZGxlciAqLwogICAgX2hhbmRsZVRvdWNoRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc3dpdGNoIChldmVudC50eXBlKSB7CgogICAgICAgIC8vIE9uIHRvdWNoL21vdXNlIGRvd24KICAgICAgICBjYXNlICd0b3VjaHN0YXJ0JzoKICAgICAgICBjYXNlICdtb3VzZWRvd24nOgoKICAgICAgICAgIC8vIHNhdmUgdGltZSAmIG9yaWdpbmFsIHBvc2l0aW9uIGZvciBYL1kKICAgICAgICAgIHRoaXMudG91Y2hTdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICAgIHRoaXMudG91Y2hTdGFydFggPSAoZXZlbnQudHlwZSA9PSAndG91Y2hzdGFydCcpID8gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWzBdLnBhZ2VYIDogZXZlbnQucGFnZVg7CiAgICAgICAgICB0aGlzLnRvdWNoU3RhcnRZID0gKGV2ZW50LnR5cGUgPT0gJ3RvdWNoc3RhcnQnKSA/IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1swXS5wYWdlWSA6IGV2ZW50LnBhZ2VZOwogICAgICAgICAgYnJlYWs7CgogICAgICAgICAgLy8gT24gdG91Y2gvbW91c2Vkb3duCiAgICAgICAgY2FzZSAndG91Y2hlbmQnOgogICAgICAgIGNhc2UgJ3RvdWNoY2FuY2VsJzoKICAgICAgICBjYXNlICdtb3VzZXVwJzoKCiAgICAgICAgICAvLyBTYXZlIHRpbWUgJiBmaW5hbCBwb3NpdGlvbiBmb3IgWC9ZCiAgICAgICAgICB0aGlzLnRvdWNoRW5kVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgdGhpcy50b3VjaEVuZFggPSAoZXZlbnQudHlwZSA9PSAndG91Y2hlbmQnIHx8IGV2ZW50LnR5cGUgPT0gJ3RvdWNoY2FuY2VsJykgPyBldmVudC5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYIDogZXZlbnQucGFnZVg7CiAgICAgICAgICB0aGlzLnRvdWNoRW5kWSA9IChldmVudC50eXBlID09ICd0b3VjaGVuZCcgfHwgZXZlbnQudHlwZSA9PSAndG91Y2hjYW5jZWwnKSA/IGV2ZW50Lm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVkgOiBldmVudC5wYWdlWTsKCiAgICAgICAgICAvLyBjYWxjdWxhdGUgZGlzdGFuY2UsIGR1cmF0aW9uICYgdmVsb2NpdHkuCiAgICAgICAgICB2YXIgZGlzdGFuY2VYID0gdGhpcy50b3VjaFN0YXJ0WCAtIHRoaXMudG91Y2hFbmRYOwogICAgICAgICAgdmFyIGRpc3RhbmNlWSA9IHRoaXMudG91Y2hTdGFydFkgLSB0aGlzLnRvdWNoRW5kWTsKICAgICAgICAgIHZhciBkdXJhdGlvbiA9IHRoaXMudG91Y2hFbmRUaW1lIC0gdGhpcy50b3VjaFN0YXJ0VGltZTsKICAgICAgICAgIHZhciB2ZWxvY2l0eVggPSBNYXRoLmFicyhkaXN0YW5jZVgpIC8gZHVyYXRpb247CiAgICAgICAgICB2YXIgdmVsb2NpdHlZID0gTWF0aC5hYnMoZGlzdGFuY2VZKSAvIGR1cmF0aW9uOwoKICAgICAgICAgIC8vIElmIHZlbG9jaXR5LCB1c2UgYWJzb2x1dGUgZGlzdGFuY2UgdG8gZGV0ZXJtaW5lIGF4aXMKICAgICAgICAgIC8vIGFuZCBjb21wYXJlIGRpc3RhbmNlIHRvIDAgZGV0ZXJtaW5lIGRpcmVjdGlvbgogICAgICAgICAgaWYgKHZlbG9jaXR5WCA+IHRoaXMub3B0aW9ucy5zd2lwZVZlbG9jaXR5ICYmIE1hdGguYWJzKGRpc3RhbmNlWCkgPiBNYXRoLmFicyhkaXN0YW5jZVkpICYmIGRpc3RhbmNlWCA8IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ2xlZnQnKTsKICAgICAgICAgIGlmICh2ZWxvY2l0eVggPiB0aGlzLm9wdGlvbnMuc3dpcGVWZWxvY2l0eSAmJiBNYXRoLmFicyhkaXN0YW5jZVgpID4gTWF0aC5hYnMoZGlzdGFuY2VZKSAmJiBkaXN0YW5jZVggPiAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCdyaWdodCcpOwogICAgICAgICAgaWYgKHZlbG9jaXR5WSA+IHRoaXMub3B0aW9ucy5zd2lwZVZlbG9jaXR5ICYmIE1hdGguYWJzKGRpc3RhbmNlWCkgPCBNYXRoLmFicyhkaXN0YW5jZVkpICYmIGRpc3RhbmNlWSA8IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ3VwJyk7CiAgICAgICAgICBpZiAodmVsb2NpdHlZID4gdGhpcy5vcHRpb25zLnN3aXBlVmVsb2NpdHkgJiYgTWF0aC5hYnMoZGlzdGFuY2VYKSA8IE1hdGguYWJzKGRpc3RhbmNlWSkgJiYgZGlzdGFuY2VZID4gMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbignZG93bicpOwoKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9LAoKCgogICAgLyogUG9zaXRpb24gZmxvb3Igb24gZG9tICovCiAgICBfcG9zaXRpb25FbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodGhpcy5kaXJlY3Rpb25Jc0FycmF5KSB0aGlzLl9nZW5lcmF0ZUZsb29yTWFwKCk7CgogICAgICAvLyBTZXR1cCBmbG9vciBzaXplICYgcG9zaXRpb24KICAgICAgdGhpcy5ub2RlLmNzcyh7CiAgICAgICAgJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJywKICAgICAgICAnb3ZlcmZsb3cnOiAnaGlkZGVuJywKICAgICAgICAndG9wJzogJzAnLAogICAgICAgICdsZWZ0JzogJzAnLAogICAgICAgICd3aWR0aCc6IHRoaXMub3B0aW9ucy53aWR0aCwKICAgICAgICAnaGVpZ2h0JzogdGhpcy5vcHRpb25zLmhlaWdodAogICAgICB9KTsKCiAgICAgIHRoaXMubm9kZUNoaWxkcmVuLmNzcyh7CiAgICAgICAgJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJywKICAgICAgICAnb3ZlcmZsb3cnOiAnYXV0bycsCiAgICAgICAgJ3RvcCc6ICcwJywKICAgICAgICAnbGVmdCc6ICcwJywKICAgICAgICAnd2lkdGgnOiAnMTAwJScsCiAgICAgICAgJ2hlaWdodCc6ICcxMDAlJwogICAgICB9KTsKCiAgICAgIC8vIHBsYWNlIGVsZW1lbnQgY29ycmVjdGx5CiAgICAgIHRoaXMubm9kZUNoaWxkcmVuLmVhY2goZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICBpZiAoc2VsZi5zdXBwb3J0VHJhbnNmb3JtKSB7CiAgICAgICAgICAkKHRoaXMpLmNzcyh7CiAgICAgICAgICAgICd0cmFuc2Zvcm0nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PT0gJ3knKSByZXR1cm4gJ3RyYW5zbGF0ZVkoJyArIGluZGV4ICogMTAwICsgJyUpJzsKICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PT0gJ3gnKSByZXR1cm4gJ3RyYW5zbGF0ZVgoJyArIGluZGV4ICogMTAwICsgJyUpJzsKICAgICAgICAgICAgICBpZiAoc2VsZi5kaXJlY3Rpb25Jc0FycmF5KSByZXR1cm4gJ3RyYW5zbGF0ZVkoJyArIHNlbGYub3B0aW9ucy5kaXJlY3Rpb25baW5kZXhdW3NlbGYuQVhJU19ZXSAqIDEwMCArICclKSB0cmFuc2xhdGVYKCcgKyBzZWxmLm9wdGlvbnMuZGlyZWN0aW9uW2luZGV4XVtzZWxmLkFYSVNfWF0gKiAxMDAgKyAnJSknOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgJCh0aGlzKS5jc3MoewogICAgICAgICAgICAndG9wJzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT09ICd5JykgcmV0dXJuIGluZGV4ICogMTAwICsgJyUnOwogICAgICAgICAgICAgIGlmIChzZWxmLmRpcmVjdGlvbklzQXJyYXkpIHJldHVybiBzZWxmLm9wdGlvbnMuZGlyZWN0aW9uW2luZGV4XVtzZWxmLkFYSVNfWV0gKiAxMDAgKyAnJSc7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdsZWZ0JzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT09ICd4JykgcmV0dXJuIGluZGV4ICogMTAwICsgJyUnOwogICAgICAgICAgICAgIGlmIChzZWxmLmRpcmVjdGlvbklzQXJyYXkpIHJldHVybiBzZWxmLm9wdGlvbnMuZGlyZWN0aW9uW2luZGV4XVtzZWxmLkFYSVNfWF0gKiAxMDAgKyAnJSc7CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCgogICAgLyogSGVscGVyIDogUmV0dXJuIGZsb29yIGluZGV4IGZyb20gaGFzaC4gKi8KICAgIF9nZXRGbG9vckZyb21IYXNoOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuX2dldEhhc2goKSkgewogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUgJiYgZXhpc3RJbkFycmF5KHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSwgdGhpcy5fZ2V0SGFzaCgpKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZS5pbmRleE9mKHRoaXMuX2dldEhhc2goKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgoKICAgIC8qIEhlbHBlciA6IFJldHVybiBmbG9vciBpbmRleCBmcm9tIGhhc2guICovCiAgICBfZ2V0SGFzaDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh3aW5kb3cubG9jYXRpb24uaGFzaCkgewogICAgICAgIHZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2guc3BsaXQoJyMnKS5wb3AoKTsKICAgICAgICByZXR1cm4gaGFzaDsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKCiAgICAvKiBIYW5sZGVyOiBIYW5kbGUgd2luZG93IGhhc2hjYW5nZSBldmVudCAqLwogICAgX2hhc2hjaGFuZ2VIYW5kbGVyOiBmdW5jdGlvbihldmVudCkgewogICAgICBpZiAoaXNOdW1iZXIodGhpcy5fZ2V0Rmxvb3JGcm9tSGFzaCgpKSAmJiB0aGlzLl9nZXRGbG9vckZyb21IYXNoKCkgIT09IHRoaXMuZmxvb3JBY3RpdmUgJiYgIXRoaXMubm9kZS5pcygnOmFuaW1hdGVkJykpIHsKICAgICAgICB0aGlzLnNjcm9sbFRvRmxvb3IodGhpcy5fZ2V0Rmxvb3JGcm9tSGFzaCgpKTsKICAgICAgfQogICAgfSwKCgogICAgLyogV2lsbCB1cGRhdGUgaGFzaCBsb2NhdGlvbiBpZiBmbG9vciBuYW1lIGFyZSBzZXR1cC4gKi8KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihmbG9vckluZGV4KSB7CiAgICAgIGlmIChpc09iamVjdCh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUpICYmIHRoaXMuX2dldEhhc2goKSAhPT0gdGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lW2Zsb29ySW5kZXhdKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UoKCcnICsgd2luZG93LmxvY2F0aW9uKS5zcGxpdCgnIycpWzBdICsgJyMnICsgdGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lW2Zsb29ySW5kZXhdKTsKICAgICAgfQogICAgfSwKCgogICAgLyogRXZlbnQgaGVscGVyLCBsZXQgYXNjZW5zb3IgY3JlYXRlIG93biBldmVudCwgd2l0aCBmbG9vciBpbmZvcm1hdGlvbiAqLwogICAgX2VtaXRFdmVudDogZnVuY3Rpb24oZXZlbnROYW1lLCBmcm9tLCB0bykgewogICAgICB0aGlzLm5vZGUudHJpZ2dlcihldmVudE5hbWUsIGZsb29yID0gewogICAgICAgIGZyb206IGZyb20sCiAgICAgICAgdG86IHRvCiAgICAgIH0pOwogICAgfSwKCgogICAgLyogV2FybiBoYW5kbGVyICovCiAgICBfZW1pdENvbnNvbGVNZXNzYWdlOiBmdW5jdGlvbih0eXBlLCB3YXJuKSB7CiAgICAgIGlmICh0eXBlID09ICJlcnJvciIpIGNvbnNvbGUuZXJyb3IoIkFzY2Vuc29yLmpzOiAiICsgd2Fybik7CiAgICAgIGlmICh0eXBlID09ICJ3YXJuIikgY29uc29sZS53YXJuKCJBc2NlbnNvci5qczogIiArIHdhcm4pOwogICAgfSwKCgogICAgLyogS2V5cHJlc3MgSGFuZGxlciAqLwogICAgX2tleXByZXNzSGFuZGxlcjogZnVuY3Rpb24oZSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBrZXkgPSBlLmtleUNvZGUgfHwgZS53aGljaDsKICAgICAgaWYgKCEkKCdpbnB1dCwgdGV4dGFyZWEsIGJ1dHRvbicpLmlzKCc6Zm9jdXMnKSkgewogICAgICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICBjYXNlIDQwOgogICAgICAgICAgY2FzZSA4MzoKICAgICAgICAgICAgc2VsZi5zY3JvbGxUb0RpcmVjdGlvbignZG93bicpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzg6CiAgICAgICAgICBjYXNlIDg3OgogICAgICAgICAgICBzZWxmLnNjcm9sbFRvRGlyZWN0aW9uKCd1cCcpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDM3OgogICAgICAgICAgY2FzZSA2NToKICAgICAgICAgICAgc2VsZi5zY3JvbGxUb0RpcmVjdGlvbignbGVmdCcpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDM5OgogICAgICAgICAgY2FzZSA2ODoKICAgICAgICAgICAgc2VsZi5zY3JvbGxUb0RpcmVjdGlvbigncmlnaHQnKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKCiAgICAvKiBSZXNpemUgaGFuZGxlci4gVXBkYXRlIHNjcm9sbFRvcCAmIHNjcm9sbExlZnQgcG9zaXRpb24gKi8KICAgIHNjcm9sbFRvRmxvb3I6IGZ1bmN0aW9uKGZsb29yKSB7CgogICAgICAvLyBJZiBmbG9vciBzZW5kIGlzIGEgdHJpbmcsIGNoZWNrIGlmIGl0IG1hdGNoIGFueSBvZiBhc2NlbnNvckZsb29yTmFtZSwgdGhlbiB1c2UgcG9pc3Rpb24gaW4gYXJyYXkKICAgICAgaWYgKGlzU3RyaW5nKGZsb29yKSAmJiBleGlzdEluQXJyYXkodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lLCBmbG9vcikpIGZsb29yID0gdGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lLmluZGV4T2YoZmxvb3IpOwoKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYW5pbWF0ZSA9IChmbG9vciA9PT0gdGhpcy5mbG9vckFjdGl2ZSkgPyBmYWxzZSA6IHRydWU7CgogICAgICBpZiAodGhpcy5OVyAhPT0gdGhpcy5ub2RlLndpZHRoKCkpIHRoaXMuTlcgPSB0aGlzLm5vZGUud2lkdGgoKTsKICAgICAgaWYgKHRoaXMuTkggIT09IHRoaXMubm9kZS5oZWlnaHQoKSkgdGhpcy5OSCA9IHRoaXMubm9kZS5oZWlnaHQoKTsKCiAgICAgIC8vIE1ha2Ugc3VyZSBwb3NpdGlvbiBpcyBjb3JyZWN0CiAgICAgIHZhciBhbmltYXRpb25PYmplY3QgPSB0aGlzLl9nZXRBbmltYXRpb25TZXR0aW5ncyhmbG9vcik7CgogICAgICBpZiAoYW5pbWF0ZSkgewogICAgICAgIHRoaXMuX2VtaXRFdmVudCgnc2Nyb2xsU3RhcnQnLCBzZWxmLmZsb29yQWN0aXZlLCBmbG9vcik7CiAgICAgICAgdGhpcy5ub2RlLnN0b3AoKS5hbmltYXRlKGFuaW1hdGlvbk9iamVjdC5wcm9wZXJ0eSwgc2VsZi5vcHRpb25zLnRpbWUsIHNlbGYub3B0aW9ucy5lYXNpbmcsIGFuaW1hdGlvbk9iamVjdC5jYWxsYmFjayk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5ub2RlLnN0b3AoKS5zY3JvbGxUb3AoYW5pbWF0aW9uT2JqZWN0LmRlZmF1bHRzLnNjcm9sbFRvcCkuc2Nyb2xsTGVmdChhbmltYXRpb25PYmplY3QuZGVmYXVsdHMuc2Nyb2xsTGVmdCk7CiAgICAgIH0KCiAgICAgIHRoaXMuZmxvb3JBY3RpdmUgPSBmbG9vcjsKICAgICAgdGhpcy5ub2RlLmRhdGEoJ2N1cnJlbnQtZmxvb3InLCB0aGlzLmZsb29yQWN0aXZlKTsKCiAgICB9LAoKCiAgICAvKiBQcmV2IGZ1bmN0aW9uICovCiAgICBwcmV2OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRhcmdldEZsb29yID0gdGhpcy5mbG9vckFjdGl2ZSAtIDE7CiAgICAgIGlmICh0YXJnZXRGbG9vciA8IDApIHsKICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5sb29wKSByZXR1cm47CiAgICAgICAgdGFyZ2V0Rmxvb3IgPSB0aGlzLm5vZGVDaGlsZHJlbi5sZW5ndGggLSAxOwogICAgICB9CiAgICAgIHRoaXMuc2Nyb2xsVG9GbG9vcih0YXJnZXRGbG9vcik7CiAgICB9LAoKCiAgICAvKiBQcmV2IGZ1bmN0aW9uICovCiAgICBuZXh0OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRhcmdldEZsb29yID0gdGhpcy5mbG9vckFjdGl2ZSArIDE7CiAgICAgIGlmICh0YXJnZXRGbG9vciA+IHRoaXMubm9kZUNoaWxkcmVuLmxlbmd0aCAtIDEpIHsKICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5sb29wKSByZXR1cm47CiAgICAgICAgdGFyZ2V0Rmxvb3IgPSAwOwogICAgICB9CgogICAgICB0aGlzLnNjcm9sbFRvRmxvb3IodGFyZ2V0Rmxvb3IpOwogICAgfSwKCgogICAgLyogSGVscGVyIHRvIGdlbmVyYXRlIGFuaW1hdGlvbiBzZXR0aW5ncyAqLwogICAgX2dldEFuaW1hdGlvblNldHRpbmdzOiBmdW5jdGlvbihmbG9vcikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBzYXZlRmxvb3JBY3RpdmUgPSBzZWxmLmZsb29yQWN0aXZlOwogICAgICAvLyBDcmVhdGUgYW5pbWF0aW9uIHNldHRpbmcgb2JqZWN0CiAgICAgIHZhciBhbmltYXRpb25TZXR0aW5ncyA9IHsKICAgICAgICBwcm9wZXJ0eToge30sCiAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5fZW1pdEV2ZW50KCdzY3JvbGxFbmQnLCBzYXZlRmxvb3JBY3RpdmUsIGZsb29yKTsKICAgICAgICAgIHNlbGYuX3VwZGF0ZUhhc2goZmxvb3IpOwogICAgICAgIH0sCiAgICAgICAgZGVmYXVsdHM6IHt9CiAgICAgIH07CgoKICAgICAgLy8gQ3JlYXRlIGEgc2Vjb25kIHNldHRpbmcgb2JqZWN0CiAgICAgIC8vIGluIGNhc2UgdGhlIHF1ZXVlZCBvcHRpb24gaXMgc2V0CiAgICAgIHZhciBzZWNvbmRBbmltYXRpb25TZXR0aW5ncyA9IHsKICAgICAgICBwcm9wZXJ0eToge30sCiAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5fZW1pdEV2ZW50KCdzY3JvbGxFbmQnLCBzYXZlRmxvb3JBY3RpdmUsIGZsb29yKTsKICAgICAgICAgIHNlbGYuX3VwZGF0ZUhhc2goZmxvb3IpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGFuaW1hdGlvblNldHRpbmdzLmRlZmF1bHRzLnNjcm9sbFRvcCA9IGZsb29yICogc2VsZi5OSDsKICAgICAgYW5pbWF0aW9uU2V0dGluZ3MuZGVmYXVsdHMuc2Nyb2xsTGVmdCA9IGZsb29yICogc2VsZi5OVzsKCiAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyB2ZXJ0aWNhbAogICAgICAvLyA9PiBzZXQgc2Nyb2xsVG9wIHByb3BlcnR5ICYgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzCiAgICAgIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneScpIHsKICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxUb3AgPSBmbG9vciAqIHNlbGYuTkg7CiAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICB9CgoKICAgICAgLy8gSWYgZGlyZWN0aW9uIGlzIGhvcml6b250YWwJCiAgICAgIC8vID0+IHNldCBzY3JvbGxsZWZ0IHByb3BlcnR5ICYgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzCiAgICAgIGVsc2UgaWYgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT09ICd4JykgewogICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbExlZnQgPSBmbG9vciAqIHNlbGYuTlc7CiAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICB9CgogICAgICAvLyBJZiBkaXJlY3Rpb24gaXMgYSBtYXAKICAgICAgZWxzZSBpZiAoc2VsZi5kaXJlY3Rpb25Jc0FycmF5KSB7CgogICAgICAgIC8vID0+IFNhdmUgdmFsdWUKICAgICAgICB2YXIgc2Nyb2xsVG9wVmFsdWUgPSBzZWxmLm9wdGlvbnMuZGlyZWN0aW9uW2Zsb29yXVtzZWxmLkFYSVNfWV0gKiBzZWxmLk5IOwogICAgICAgIHZhciBzY3JvbGxMZWZ0VmFsdWUgPSBzZWxmLm9wdGlvbnMuZGlyZWN0aW9uW2Zsb29yXVtzZWxmLkFYSVNfWF0gKiBzZWxmLk5XOwoKICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5kZWZhdWx0cy5zY3JvbGxUb3AgPSBzY3JvbGxUb3BWYWx1ZTsKICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5kZWZhdWx0cy5zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdFZhbHVlOwoKCiAgICAgICAgLy8gSWYgdGhlIHF1ZXVlZCBvcHRpb24gaXMgc2V0CiAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5xdWV1ZWQpIHsKCiAgICAgICAgICAvLyA9PiBDaGVjayBmbG9vciBwb3NpdGlvbiwgdG8gYXZvaWQgYW5pbWF0aW9uIGlmIGFscmVhZHkgb24gc2FtZSBmbG9vcgogICAgICAgICAgdmFyIHNhbWVYcG9zaXRpb24gPSB0aGlzLm5vZGUuc2Nyb2xsTGVmdCgpID09PSBzY3JvbGxMZWZ0VmFsdWU7CiAgICAgICAgICB2YXIgc2FtZVlwb3NpdGlvbiA9IHRoaXMubm9kZS5zY3JvbGxUb3AoKSA9PT0gc2Nyb2xsVG9wVmFsdWU7CgoKICAgICAgICAgIC8vIElmIHF1ZXVlZCBkaXJlY3Rpb24gaXMgaG9yaXpvbnRhbCAmIG9uIHRoZSBzYW1lIGZsb29yCiAgICAgICAgICAvLyA9PiBTZXQgc2Nyb2xsVG9wIHByb3BlcnR5ICYgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzCiAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnF1ZXVlZCA9PT0gJ3gnICYmIHNhbWVYcG9zaXRpb24pIHsKICAgICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wVmFsdWU7CiAgICAgICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgICAgIH0KCgogICAgICAgICAgLy8gSWYgcXVldWVkIGRpcmVjdGlvbiBpcyBob3Jpem9udGFsICYgTk9UIG9uIHRoZSBzYW1lIGZsb29yCiAgICAgICAgICAvLyA9PiBTZXQgc2Nyb2xsTGVmdCBwcm9wZXJ0eQogICAgICAgICAgLy8gPT4gU2V0IGNhbGxiYWNrIHRvIGEgc2Vjb25kIGFuaW1hdGlvbiAoc2Nyb2xsVG9wKQogICAgICAgICAgLy8gPT4gcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzCiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRWYWx1ZTsKICAgICAgICAgICAgc2Vjb25kQW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wVmFsdWU7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2VsZi5ub2RlLnN0b3AoKS5hbmltYXRlKHNlY29uZEFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LCBzZWxmLm9wdGlvbnMudGltZSwgc2VsZi5vcHRpb25zLmVhc2luZywgc2Vjb25kQW5pbWF0aW9uU2V0dGluZ3MuY2FsbGJhY2spOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICAgICAgICB9CgoKICAgICAgICAgIC8vIElmIHF1ZXVlZCBkaXJlY3Rpb24gaXMgdmVydGljYWwgJiBvbiB0aGUgc2FtZSBmbG9vcgogICAgICAgICAgLy8gPT4gU2V0IHNjcm9sbFRvcCBzY3JvbGxMZWZ0ICYgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzCiAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnF1ZXVlZCA9PT0gJ3knICYmIHNhbWVZcG9zaXRpb24pIHsKICAgICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRWYWx1ZTsKICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICAgICAgfQoKCiAgICAgICAgICAvLyBJZiBxdWV1ZWQgZGlyZWN0aW9uIGlzIHZlcnRpY2FsICYgTk9UIG9uIHRoZSBzYW1lIGZsb29yCiAgICAgICAgICAvLyA9PiBTZXQgc2Nyb2xsVG9wIHByb3BlcnR5CiAgICAgICAgICAvLyA9PiBTZXQgY2FsbGJhY2sgdG8gYSBzZWNvbmQgYW5pbWF0aW9uIChzY3JvbGxMZWZ0KQogICAgICAgICAgLy8gPT4gcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzCiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wVmFsdWU7CiAgICAgICAgICAgIHNlY29uZEFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbExlZnQgPSBzY3JvbGxMZWZ0VmFsdWU7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2VsZi5ub2RlLnN0b3AoKS5hbmltYXRlKHNlY29uZEFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LCBzZWxmLm9wdGlvbnMudGltZSwgc2VsZi5vcHRpb25zLmVhc2luZywgc2Vjb25kQW5pbWF0aW9uU2V0dGluZ3MuY2FsbGJhY2spOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgLy8gSWYgcXVldWQgb3B0aW9uIGlzIG5vdCBzZXQsIAogICAgICAgIC8vID0+IHNldCBzY3JvbGxUb3AgJiBTY3JvbGxMZWZ0IHByb3BlcnR5IAogICAgICAgIC8vID0+IHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgIGVsc2UgewogICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wVmFsdWU7CiAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdFZhbHVlOwogICAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgfSwKCgogICAgLyogSGVscGVyIHRvIGhhbmRsZSBkaXJlY3Rpb24gY29ycmVjdGx5LiAqLwogICAgc2Nyb2xsVG9EaXJlY3Rpb246IGZ1bmN0aW9uKGRpcmVjdGlvbikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyBJZiBhIGRhdGEgYXR0cmlidXRlIHdpdGggY3VycmVudCBkaXJlY3Rpb24KICAgICAgLy8gaXMgZm91bmQsIHVzZSBpdC4KICAgICAgdmFyIGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24gPSB0aGlzLm5vZGVDaGlsZHJlbi5lcSh0aGlzLmZsb29yQWN0aXZlKS5kYXRhKHRoaXMuZGF0YUF0dHJpYnV0ZU1hcFtkaXJlY3Rpb25dKTsKICAgICAgaWYgKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoZGF0YUF0dHJpYnV0ZURpcmVjdGlvbik7CgoKICAgICAgdmFyIGRpcmVjdGlvbklzSG9yaXpvbnRhbCA9IChkaXJlY3Rpb24gPT0gJ3JpZ2h0JyB8fCBkaXJlY3Rpb24gPT0gJ2xlZnQnKTsKICAgICAgdmFyIGRpcmVjdGlvbklzVmVydGljYWwgPSAoZGlyZWN0aW9uID09ICdkb3duJyB8fCBkaXJlY3Rpb24gPT0gJ3VwJyk7CgogICAgICAvLyBJZiBkaXJlY3Rpb24gaXMgeCBvciB5IGFuZCB0aGVyZSBpcyAKICAgICAgLy8gZGlyZWN0aW9uIGFyZSBvcHBwc2l0ZSwgcmV0dXJuIGhlcmUKICAgICAgaWYgKChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09ICd5JyAmJiBkaXJlY3Rpb25Jc0hvcml6b250YWwpIHx8IChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09ICd4JyAmJiBkaXJlY3Rpb25Jc1ZlcnRpY2FsKSkgcmV0dXJuOwoKICAgICAgLy8gSWYgZGlyZWN0aW9uIGlzIHggb3IgeCwgYW5kIAogICAgICAvLyBkaXJlY3Rpb24gbWF0Y2gsIHVzZSBwcmV2L25leHQKICAgICAgaWYgKChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09ICd5JyAmJiBkaXJlY3Rpb24gPT0gJ2Rvd24nKSB8fCAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneCcgJiYgZGlyZWN0aW9uID09ICdyaWdodCcpKSByZXR1cm4gc2VsZi5uZXh0KCk7CiAgICAgIGlmICgoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneScgJiYgZGlyZWN0aW9uID09ICd1cCcpIHx8IChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09ICd4JyAmJiBkaXJlY3Rpb24gPT0gJ2xlZnQnKSkgcmV0dXJuIHNlbGYucHJldigpOwoKCiAgICAgIGlmIChzZWxmLmRpcmVjdGlvbklzQXJyYXkpIHsKCiAgICAgICAgdmFyIGZsb29yT2JqZWN0ID0gc2VsZi5mbG9vck1hcFtzZWxmLmZsb29yQWN0aXZlXTsKCiAgICAgICAgLy8gSWYgZXhpc3RpbmcsIHJldHVybiBhcHBlbmRpbmcgZmxvb3IKICAgICAgICB2YXIgZGlyZWN0Rmxvb3IgPSBmbG9vck9iamVjdFtkaXJlY3Rpb25dOwogICAgICAgIGlmIChpc051bWJlcihkaXJlY3RGbG9vcikpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoZGlyZWN0Rmxvb3IpOwoKICAgICAgICAvLyBKdW1wIGlzIHNldCB0byB0cnVlLCB1c2UgdGhlIAogICAgICAgIC8vIGNsb3Nlc3QgZmxvb3IgaW4gdGhhdCBzYW1lIGRpcmVjdGlvbgogICAgICAgIHZhciBjbG9zZXN0Rmxvb3IgPSBmbG9vck9iamVjdC5jbG9zZXN0W2RpcmVjdGlvbl07CiAgICAgICAgaWYgKGlzVHJ1ZShzZWxmLm9wdGlvbnMuanVtcCkgJiYgaXNOdW1iZXIoY2xvc2VzdEZsb29yKSkgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihjbG9zZXN0Rmxvb3IpOwoKICAgICAgICAvLyBJZiBsb29wIGlzIHNldCB0byB0cnVlLCB1c2UKICAgICAgICAvLwl0aGUgZnVydGhlc3QgZmxvb3IKICAgICAgICB2YXIgZnVydGhlc3RGbG9vciA9IGZsb29yT2JqZWN0LmZ1cnRoZXN0W2RpcmVjdGlvbl07CiAgICAgICAgaWYgKGlzTnVtYmVyKGZ1cnRoZXN0Rmxvb3IpICYmIChpc1RydWUoc2VsZi5vcHRpb25zLmxvb3ApIHx8IChkaXJlY3Rpb25Jc0hvcml6b250YWwgJiYgc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2xvb3AteCcpIHx8IChkaXJlY3Rpb25Jc1ZlcnRpY2FsICYmIHNlbGYub3B0aW9ucy5sb29wID09ICdsb29wLXknKSkpIHsKICAgICAgICAgIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoZnVydGhlc3RGbG9vcik7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBJbmNyZW1lbnQgZXhpc3QgJiBvcHRpb24gaXMgc2V0CiAgICAgICAgdmFyIGluY3JlbWVudEZsb29yID0gZmxvb3JPYmplY3QuaW5jcmVtZW50W2RpcmVjdGlvbl07CiAgICAgICAgaWYgKGlzTnVtYmVyKGluY3JlbWVudEZsb29yKSkgewoKICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50JyB8fCBkaXJlY3Rpb25Jc1ZlcnRpY2FsICYmIHNlbGYub3B0aW9ucy5sb29wID09ICdpbmNyZW1lbnQteScgfHwgZGlyZWN0aW9uSXNIb3Jpem9udGFsICYmIHNlbGYub3B0aW9ucy5sb29wID09ICdpbmNyZW1lbnQteCcpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihpbmNyZW1lbnRGbG9vcik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBKdW1wIGZyb20gbGFzdCB0byBmaXJzdCBvciBmaXJzdCB0byBsYXN0CiAgICAgICAgaWYgKChzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50LXgnICYmIGRpcmVjdGlvbklzSG9yaXpvbnRhbCkgfHwgc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudCcpIHsKICAgICAgICAgIGlmIChzZWxmLmZsb29yQWN0aXZlID09IHNlbGYuZmxvb3JNYXAuZnVydGhlc3RfeCkgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihzZWxmLmZsb29yTWFwLmNsb3Nlc3RfeCk7CiAgICAgICAgICBpZiAoc2VsZi5mbG9vckFjdGl2ZSA9PSBzZWxmLmZsb29yTWFwLmNsb3Nlc3RfeCkgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihzZWxmLmZsb29yTWFwLmZ1cnRoZXN0X3gpOwogICAgICAgIH0KCiAgICAgICAgaWYgKChzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50LXknICYmIGRpcmVjdGlvbklzVmVydGljYWwpIHx8IHNlbGYub3B0aW9ucy5sb29wID09ICdpbmNyZW1lbnQnKSB7CiAgICAgICAgICBpZiAoc2VsZi5mbG9vckFjdGl2ZSA9PSBzZWxmLmZsb29yTWFwLmZ1cnRoZXN0X3kpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vck1hcC5jbG9zZXN0X3kpOwogICAgICAgICAgaWYgKHNlbGYuZmxvb3JBY3RpdmUgPT0gc2VsZi5mbG9vck1hcC5jbG9zZXN0X3kpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vck1hcC5mdXJ0aGVzdF95KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgoKCiAgICAvKiBIZWxwZXIgdG8gZ2V0IHRoZSBkaXJlY3QgYXBwZW5kaW5nIGZsb29yIGluIG9uZSBwcmVjaXNlIGRpcmVjdGlvbiBkaXJlY3Rpb24gKi8KICAgIF9nZXREaXJlY3RGbG9vckluZGV4OiBmdW5jdGlvbihEQSwgZmxvb3JJbmRleCwgZGlyZWN0aW9uKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIENyZWF0ZSBmbG9vciB0YXJnZXQgYXJyYXkgYmFzZSBvbiBmbG9vcm9iamVjdAogICAgICB2YXIgZmxvb3JUYXJnZXQgPSBbdGhpcy5vcHRpb25zLmRpcmVjdGlvbltmbG9vckluZGV4XVt0aGlzLkFYSVNfWV0sIHRoaXMub3B0aW9ucy5kaXJlY3Rpb25bZmxvb3JJbmRleF1bdGhpcy5BWElTX1hdXTsKCiAgICAgIC8vIEFkanVzdCBtYXAgZGVwZW5kaW5nIG9uIGRpcmVjdGlvbgogICAgICBpZiAoZGlyZWN0aW9uID09ICdyaWdodCcpIGZsb29yVGFyZ2V0W3RoaXMuQVhJU19YXSArPSAxOwogICAgICBpZiAoZGlyZWN0aW9uID09ICdsZWZ0JykgZmxvb3JUYXJnZXRbdGhpcy5BWElTX1hdIC09IDE7CiAgICAgIGlmIChkaXJlY3Rpb24gPT0gJ3VwJykgZmxvb3JUYXJnZXRbdGhpcy5BWElTX1ldIC09IDE7CiAgICAgIGlmIChkaXJlY3Rpb24gPT0gJ2Rvd24nKSBmbG9vclRhcmdldFt0aGlzLkFYSVNfWV0gKz0gMTsKCiAgICAgIC8vIGxvb3BhbmQgY29tcGFyZSBkaXJlY3Rpb24gbWFwCiAgICAgIHZhciBmbG9vclRhcmdldEluZGV4ID0gZmFsc2U7CiAgICAgICQuZWFjaChEQSwgZnVuY3Rpb24oaW5kZXgsIG1hcCkgewoKICAgICAgICAvLyBJZiBjdXJyZW50IG9iamVjdCBtYXAgdmFsdWUgYXJlIGVxdWFsIHRvIHRhcmdldCBvbmUKICAgICAgICBpZiAobWFwW3NlbGYuQVhJU19ZXSA9PSBmbG9vclRhcmdldFtzZWxmLkFYSVNfWV0gJiYgbWFwW3NlbGYuQVhJU19YXSA9PSBmbG9vclRhcmdldFtzZWxmLkFYSVNfWF0pIHsKCiAgICAgICAgICAvLyBHZXQgaW5kZXggJiBicmVhayBsb29wCiAgICAgICAgICBmbG9vclRhcmdldEluZGV4ID0gaW5kZXg7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBmbG9vclRhcmdldEluZGV4OwogICAgfSwKCiAgICAvKiBSZXR1cm4gY29ycmVjdCBheGlzIGRlcGVuZGluZyBvbiBwb3NpdGlvbiAqLwogICAgX2dldEF4aXNGcm9tRGlyZWN0aW9uOiBmdW5jdGlvbihkaXJlY3Rpb24pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYXhpczsKICAgICAgc3dpdGNoIChkaXJlY3Rpb24pIHsKICAgICAgICBjYXNlICd1cCc6CiAgICAgICAgY2FzZSAnZG93bic6CiAgICAgICAgICBheGlzID0gc2VsZi5BWElTX1k7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdsZWZ0JzoKICAgICAgICBjYXNlICdyaWdodCc6CiAgICAgICAgICBheGlzID0gc2VsZi5BWElTX1g7CiAgICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgcmV0dXJuIGF4aXM7CiAgICB9LAoKICAgIC8qIEhlbHBlciB0byBnZXQgdGhlIGNsb3Nlc3QgZmxvb3IgaW4gb25lIHByZWNpc2UgZGlyZWN0aW9uIGRpcmVjdGlvbiAqLwogICAgX2dldENsb3Nlc3RGbG9vckluZGV4OiBmdW5jdGlvbihEQSwgZmxvb3JJbmRleCwgZGlyZWN0aW9uLCBsZXZlbCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICBsZXZlbCA9IGxldmVsIHx8IDA7CgogICAgICAvLyBHZXQgYXhpcyAmIGNvbXBhcmUtdG8gZmxvb3JJbmRleAogICAgICB2YXIgYXhpcyA9IHRoaXMuX2dldEF4aXNGcm9tRGlyZWN0aW9uKGRpcmVjdGlvbik7CiAgICAgIHZhciBnb2FsID0gREFbZmxvb3JJbmRleF1bYXhpc107CiAgICAgIHZhciBvcHBvc2l0ZUF4aXMgPSAoYXhpcyA9PSB0aGlzLkFYSVNfWSkgPyB0aGlzLkFYSVNfWCA6IHRoaXMuQVhJU19ZOwoKICAgICAgLy8gU2V0dXAgbG9vcCB2YXJpYWJsZQogICAgICB2YXIgY2xvc2VzdEluZGV4ID0gZmFsc2U7CiAgICAgIHZhciBjbG9zZXN0TWFwID0gZmFsc2U7CgogICAgICAvLyBMb29wIHRyb3VnaCBmbG9vciBwb3NpdGlvbiBhcnJheQogICAgICAkLmVhY2goREEsIGZ1bmN0aW9uKGluZGV4LCBtYXApIHsKCiAgICAgICAgLy8gSWYgb24gc2FtZSBheGlzCiAgICAgICAgaWYgKG1hcFtvcHBvc2l0ZUF4aXNdID09IChEQVtmbG9vckluZGV4XVtvcHBvc2l0ZUF4aXNdICsgbGV2ZWwpKSB7CgogICAgICAgICAgLy8gSWYgZGlyZWN0aW9uIGlzIGZvd2FyZCAocmlnaHQgb3IgZG93bikgYW5kIHRoZSB2YWx1ZSBpcyBiaWdnZXIgdGhhbiBnb2FsIAogICAgICAgICAgLy8gb2YgaWYgZGlyZWN0aW9uIGlzIGJhY2t3YXJkIChsZWZ0IG9yIHVwKSBhbmQgdGhlIHZhbHVlIGlzIHNtYWxsZXIgdGhhbiB0aGUgZ29hbAogICAgICAgICAgaWYgKCgoZGlyZWN0aW9uID09ICdyaWdodCcgfHwgZGlyZWN0aW9uID09ICdkb3duJykgJiYgbWFwW2F4aXNdID4gZ29hbCkgfHwgKChkaXJlY3Rpb24gPT0gJ2xlZnQnIHx8IGRpcmVjdGlvbiA9PSAndXAnKSAmJiBtYXBbYXhpc10gPCBnb2FsKSkgewoKCiAgICAgICAgICAgIC8vIE5vIHByZXZpb3VzIHZhbHVlIHNldCBvciBpZiB0aGUgY3VycmVudAogICAgICAgICAgICAvLyB2YWx1ZSBpcyBzbWFsbGVyIHRoYW4gdGhlIHByZXZpb3VzIG9uZQkJCQkJIAogICAgICAgICAgICBpZiAoIWNsb3Nlc3RNYXAgfHwgTWF0aC5hYnMobWFwW2F4aXNdIC0gZ29hbCkgPCBNYXRoLmFicyhjbG9zZXN0TWFwW2F4aXNdKSkgewogICAgICAgICAgICAgIGNsb3Nlc3RJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgIGNsb3Nlc3RNYXAgPSBtYXA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gcmV0dXJuIGluZGV4CiAgICAgIHJldHVybiBjbG9zZXN0SW5kZXg7CiAgICB9LAoKCiAgICAvKiBIZWxwZXIgdG8gZ2V0IHRoZSBmdXJ0aGVzdCBmbG9vciBpbiBvbmUgcHJlY2lzZSBkaXJlY3Rpb24gZGlyZWN0aW9uICovCiAgICBfZ2V0RnVydGhlc3RGbG9vckluZGV4OiBmdW5jdGlvbihEQSwgZmxvb3JJbmRleCwgZGlyZWN0aW9uLCBsZXZlbCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICBsZXZlbCA9IGxldmVsIHx8IDA7CgogICAgICAvLyBHZXQgYXhpcyAmIGNvbXBhcmUtdG8gZmxvb3JJbmRleAogICAgICB2YXIgYXhpcyA9IHRoaXMuX2dldEF4aXNGcm9tRGlyZWN0aW9uKGRpcmVjdGlvbik7CiAgICAgIHZhciBnb2FsID0gREFbZmxvb3JJbmRleF1bYXhpc107CiAgICAgIHZhciBvcHBvc2l0ZUF4aXMgPSAoYXhpcyA9PSB0aGlzLkFYSVNfWSkgPyB0aGlzLkFYSVNfWCA6IHRoaXMuQVhJU19ZOwoKICAgICAgLy8gU2V0dXAgbG9vcCB2YXJpYWJsZQogICAgICB2YXIgZnVydGhlc3RNYXAgPSBmYWxzZTsKICAgICAgdmFyIGZ1cnRoZXN0SW5kZXggPSBmYWxzZTsKCiAgICAgIC8vIExvb3AgdHJvdWdoIGZsb29yIHBvc2l0aW9uIGFycmF5CiAgICAgICQuZWFjaChEQSwgZnVuY3Rpb24oaW5kZXgsIG1hcCkgewoKICAgICAgICAvLyBJZiBvbiBzYW1lIGF4aXMKICAgICAgICBpZiAobWFwW29wcG9zaXRlQXhpc10gPT0gKERBW2Zsb29ySW5kZXhdW29wcG9zaXRlQXhpc10gKyBsZXZlbCkpIHsKCiAgICAgICAgICAvLyBJZiBvbiBzYW1lIGF4aXMKICAgICAgICAgIGlmICghZnVydGhlc3RNYXAgfHwgKE1hdGguYWJzKG1hcFtheGlzXSAtIGdvYWwpID4gTWF0aC5hYnMoZnVydGhlc3RNYXBbYXhpc10gLSBnb2FsKSkpIHsKICAgICAgICAgICAgZnVydGhlc3RNYXAgPSBtYXA7CiAgICAgICAgICAgIGZ1cnRoZXN0SW5kZXggPSBpbmRleDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gcmV0dXJuIGluZGV4CiAgICAgIHJldHVybiBmdXJ0aGVzdEluZGV4OwoKICAgIH0sCgogICAgLyogVXNlIHRvIGFjY2VzcyBxdWlja2x5IGxhdGVyLCBhdm9pZGluZyBsb29waW5nIHRocm91Z2ggZXZlcnkgZGlyZWN0aW9uIGV2ZXJ5IHRpbWUgKi8KICAgIF9nZW5lcmF0ZUZsb29yTWFwOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgdGhpcy5mbG9vck1hcCA9IFtdOwoKICAgICAgLy8gQ3JlYXRlIG1hcCBvbmx5IGZvciBmbG9vciBwcmVzZW50IGluIHRoZSBkb20KICAgICAgdmFyIERBID0galF1ZXJ5LmdyZXAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiwgZnVuY3Rpb24oZGlyZWN0aW9uQXJyYXksIGluZGV4KSB7CiAgICAgICAgcmV0dXJuIHNlbGYubm9kZUNoaWxkcmVuLmxlbmd0aCA+IGluZGV4OwogICAgICB9KTsKCiAgICAgIC8vIExvb3Agb24gdGhlIGRpcmF0aW9uIGFycmF5IGFuZCBnZXQgCiAgICAgIC8vIHRoZSBmbG9vciBJRCBmb3IgZWFjaCBkaXJlY3Rpb24KICAgICAgJC5lYWNoKERBLCBmdW5jdGlvbihpbmRleCwgZmxvb3JJdGVtKSB7CiAgICAgICAgc2VsZi5mbG9vck1hcFtpbmRleF0gPSB7CiAgICAgICAgICAnZG93bic6IHNlbGYuX2dldERpcmVjdEZsb29ySW5kZXgoREEsIGluZGV4LCAnZG93bicpLAogICAgICAgICAgJ3VwJzogc2VsZi5fZ2V0RGlyZWN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICd1cCcpLAogICAgICAgICAgJ3JpZ2h0Jzogc2VsZi5fZ2V0RGlyZWN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdyaWdodCcpLAogICAgICAgICAgJ2xlZnQnOiBzZWxmLl9nZXREaXJlY3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2xlZnQnKSwKICAgICAgICAgICdpbmNyZW1lbnQnOiB7CiAgICAgICAgICAgICdkb3duJzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2Rvd24nLCAxKSwKICAgICAgICAgICAgJ3VwJzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3VwJywgLTEpLAogICAgICAgICAgICAncmlnaHQnOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAncmlnaHQnLCAxKSwKICAgICAgICAgICAgJ2xlZnQnOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAnbGVmdCcsIC0xKQogICAgICAgICAgfSwKICAgICAgICAgICdjbG9zZXN0JzogewogICAgICAgICAgICAnZG93bic6IHNlbGYuX2dldENsb3Nlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2Rvd24nKSwKICAgICAgICAgICAgJ3VwJzogc2VsZi5fZ2V0Q2xvc2VzdEZsb29ySW5kZXgoREEsIGluZGV4LCAndXAnKSwKICAgICAgICAgICAgJ3JpZ2h0Jzogc2VsZi5fZ2V0Q2xvc2VzdEZsb29ySW5kZXgoREEsIGluZGV4LCAncmlnaHQnKSwKICAgICAgICAgICAgJ2xlZnQnOiBzZWxmLl9nZXRDbG9zZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdsZWZ0JykKICAgICAgICAgIH0sCiAgICAgICAgICAnZnVydGhlc3QnOiB7CiAgICAgICAgICAgICdkb3duJzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2Rvd24nKSwKICAgICAgICAgICAgJ3VwJzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3VwJyksCiAgICAgICAgICAgICdyaWdodCc6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdyaWdodCcpLAogICAgICAgICAgICAnbGVmdCc6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdsZWZ0JykKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9KTsKCiAgICAgIGZ1bmN0aW9uIGdldEZ1cnRoZXJGbG9vckFycmF5KGZsb29yQXJyYXksIGF4aXMpIHsKICAgICAgICB2YXIgZnVydGhlckZsb29yID0gZmFsc2U7CiAgICAgICAgalF1ZXJ5LmVhY2goZmxvb3JBcnJheSwgZnVuY3Rpb24oaW5kZXgsIERBKSB7CiAgICAgICAgICBpZiAoZnVydGhlckZsb29yID09PSBmYWxzZSB8fCBmdXJ0aGVyRmxvb3JbYXhpc10gPCBEQVtheGlzXSkgewogICAgICAgICAgICBmdXJ0aGVyRmxvb3IgPSBEQTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZnVydGhlckZsb29yOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRDbG9zZXN0Rmxvb3JPbkF4aXMoZmxvb3JBcnJheSwgYXhpcykgewogICAgICAgIHZhciBmdXJ0aGVyRmxvb3IgPSBmYWxzZTsKICAgICAgICBqUXVlcnkuZWFjaChmbG9vckFycmF5LCBmdW5jdGlvbihpbmRleCwgREEpIHsKICAgICAgICAgIGlmIChmdXJ0aGVyRmxvb3IgPT09IGZhbHNlIHx8IGZ1cnRoZXJGbG9vcltheGlzXSA+IERBW2F4aXNdKSB7CiAgICAgICAgICAgIGZ1cnRoZXJGbG9vciA9IERBOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmdXJ0aGVyRmxvb3I7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldFNhbWVBeGlzRmxvb3IoZmxvb3JJdGVtLCBheGlzKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKERBLCBmdW5jdGlvbihEQSkgewogICAgICAgICAgdmFyIGlzT25TYW1lQXhpcyA9IERBW2F4aXNdID09IGZsb29ySXRlbVtheGlzXTsKICAgICAgICAgIHJldHVybiBpc09uU2FtZUF4aXM7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHZhciBhcHByb3hpbWF0ZUZ1cnRoZXJYID0gZ2V0RnVydGhlckZsb29yQXJyYXkoREEsIHNlbGYuQVhJU19YKTsKICAgICAgdmFyIHNhbWVBeGlzWEZ1cnRoZXN0ID0gZ2V0U2FtZUF4aXNGbG9vcihhcHByb3hpbWF0ZUZ1cnRoZXJYLCBzZWxmLkFYSVNfWCk7CiAgICAgIHZhciBmdXJ0aGVyWSA9IGdldEZ1cnRoZXJGbG9vckFycmF5KHNhbWVBeGlzWEZ1cnRoZXN0LCBzZWxmLkFYSVNfWSk7CgogICAgICB2YXIgYXBwcm94aW1hdGVGdXJ0aGVyWSA9IGdldEZ1cnRoZXJGbG9vckFycmF5KERBLCBzZWxmLkFYSVNfWSk7CiAgICAgIHZhciBzYW1lQXhpc1lGdXJ0aGVzdCA9IGdldFNhbWVBeGlzRmxvb3IoYXBwcm94aW1hdGVGdXJ0aGVyWSwgc2VsZi5BWElTX1kpOwogICAgICB2YXIgZnVydGhlclggPSBnZXRGdXJ0aGVyRmxvb3JBcnJheShzYW1lQXhpc1lGdXJ0aGVzdCwgc2VsZi5BWElTX1gpOwoKICAgICAgc2VsZi5mbG9vck1hcC5mdXJ0aGVzdF94ID0gREEuaW5kZXhPZihmdXJ0aGVyWCk7CiAgICAgIHNlbGYuZmxvb3JNYXAuZnVydGhlc3RfeSA9IERBLmluZGV4T2YoZnVydGhlclkpOwoKICAgICAgdmFyIGFwcHJveGltYXRlQ2xvc2VzdFggPSBnZXRDbG9zZXN0Rmxvb3JPbkF4aXMoREEsIHNlbGYuQVhJU19YKTsKICAgICAgdmFyIHNhbWVBeGlzWENsb3Nlc3QgPSBnZXRTYW1lQXhpc0Zsb29yKGFwcHJveGltYXRlQ2xvc2VzdFgsIHNlbGYuQVhJU19YKTsKICAgICAgdmFyIGNsb3Nlc3RZID0gZ2V0Q2xvc2VzdEZsb29yT25BeGlzKHNhbWVBeGlzWENsb3Nlc3QsIHNlbGYuQVhJU19ZKTsKCiAgICAgIHZhciBhcHByb3hpbWF0ZUNsb3Nlc3RZID0gZ2V0Q2xvc2VzdEZsb29yT25BeGlzKERBLCBzZWxmLkFYSVNfWSk7CiAgICAgIHZhciBzYW1lQXhpc1lDbG9zZXN0ID0gZ2V0U2FtZUF4aXNGbG9vcihhcHByb3hpbWF0ZUNsb3Nlc3RZLCBzZWxmLkFYSVNfWSk7CiAgICAgIHZhciBjbG9zZXN0WCA9IGdldENsb3Nlc3RGbG9vck9uQXhpcyhzYW1lQXhpc1lDbG9zZXN0LCBzZWxmLkFYSVNfWCk7CgogICAgICBzZWxmLmZsb29yTWFwLmNsb3Nlc3RfeCA9IERBLmluZGV4T2YoY2xvc2VzdFgpOwogICAgICBzZWxmLmZsb29yTWFwLmNsb3Nlc3RfeSA9IERBLmluZGV4T2YoY2xvc2VzdFkpOwoKCiAgICB9LAoKICB9OwoKICAkLmZuW3BsdWdpbk5hbWVdID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICBpZiAoISQuZGF0YSh0aGlzLCBwbHVnaW5OYW1lKSkgewogICAgICAgICQuZGF0YSh0aGlzLCBwbHVnaW5OYW1lLCBuZXcgUGx1Z2luKHRoaXMsIG9wdGlvbnMpKTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKfSkoalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50KTs=",
                "body": "KGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewogIHZhciBwbHVnaW5OYW1lID0gJ2FzY2Vuc29yJzsKCgogIC8qIERlZmF1bHQgc2V0dGluZ3MgKi8KICB2YXIgZGVmYXVsdHMgPSB7CiAgICBhc2NlbnNvckZsb29yTmFtZTogZmFsc2UsCiAgICBjaGlsZFR5cGU6ICdkaXYnLAogICAgd2luZG93c09uOiAwLAogICAgZGlyZWN0aW9uOiAneScsCiAgICBsb29wOiBmYWxzZSwKICAgIHdpZHRoOiAnMTAwJScsCiAgICBoZWlnaHQ6ICcxMDAlJywKICAgIHRpbWU6IDI1MCwKICAgIGVhc2luZzogJ2xpbmVhcicsCiAgICBrZXlOYXZpZ2F0aW9uOiB0cnVlLAogICAgcXVldWVkOiBmYWxzZSwKICAgIGp1bXA6IGZhbHNlLAogICAgcmVhZHk6IGZhbHNlLAogICAgc3dpcGVOYXZpZ2F0aW9uOiAnbW9iaWxlLW9ubHknLAogICAgc3dpcGVWZWxvY2l0eTogMC43LAogICAgd2hlZWxOYXZpZ2F0aW9uOiBmYWxzZSwKICAgIHdoZWVsTmF2aWdhdGlvbkRlbGF5OiA0MCwKICB9OwoKICAvKiBQbHVnaW4gaW5zdGFuY2UgKi8KICBmdW5jdGlvbiBQbHVnaW4oZWxlbWVudCwgb3B0aW9ucykgewogICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgIHRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCBkZWZhdWx0cywgb3B0aW9ucyk7CiAgICB0aGlzLl9kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgdGhpcy5fbmFtZSA9IHBsdWdpbk5hbWU7CiAgICB0aGlzLmluaXQoKTsKICB9CgogIC8vIEZyb20gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vbG9yZW56b3BvbGlkb3JpLzM3OTQyMjYKICBmdW5jdGlvbiBoYXMzZCgpIHsKICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKSwKICAgICAgc3VwcG9ydDNELAogICAgICB0cmFuc2Zvcm1zID0gewogICAgICAgICd3ZWJraXRUcmFuc2Zvcm0nOiAnLXdlYmtpdC10cmFuc2Zvcm0nLAogICAgICAgICdPVHJhbnNmb3JtJzogJy1vLXRyYW5zZm9ybScsCiAgICAgICAgJ21zVHJhbnNmb3JtJzogJy1tcy10cmFuc2Zvcm0nLAogICAgICAgICdNb3pUcmFuc2Zvcm0nOiAnLW1vei10cmFuc2Zvcm0nLAogICAgICAgICd0cmFuc2Zvcm0nOiAndHJhbnNmb3JtJwogICAgICB9OwogICAgZG9jdW1lbnQuYm9keS5pbnNlcnRCZWZvcmUoZWwsIG51bGwpOwogICAgZm9yICh2YXIgdCBpbiB0cmFuc2Zvcm1zKSB7CiAgICAgIGlmIChlbC5zdHlsZVt0XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZWwuc3R5bGVbdF0gPSAndHJhbnNsYXRlM2QoMXB4LDFweCwxcHgpJzsKICAgICAgICBzdXBwb3J0M0QgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCkuZ2V0UHJvcGVydHlWYWx1ZSh0cmFuc2Zvcm1zW3RdKTsKICAgICAgfQogICAgfQogICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChlbCk7CiAgICByZXR1cm4gKHN1cHBvcnQzRCAhPT0gdW5kZWZpbmVkICYmIHN1cHBvcnQzRC5sZW5ndGggPiAwICYmIHN1cHBvcnQzRCAhPT0gJ25vbmUnKTsKICB9CgoKICAvKiBBZGQgJ2luZGV4T2YnIGhlbHBlciBpbiBjYXNlIG1pc3NpbmcgKElFOCkgKi8KICBpZiAoIUFycmF5LnByb3RvdHlwZS5pbmRleE9mKSB7CiAgICBBcnJheS5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uKGVsdCAvKiwgZnJvbSovICkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGggPj4+IDA7CiAgICAgIHZhciBmcm9tID0gTnVtYmVyKGFyZ3VtZW50c1sxXSkgfHwgMDsKICAgICAgZnJvbSA9IChmcm9tIDwgMCkgPyBNYXRoLmNlaWwoZnJvbSkgOiBNYXRoLmZsb29yKGZyb20pOwogICAgICBpZiAoZnJvbSA8IDApIGZyb20gKz0gbGVuOwogICAgICBmb3IgKDsgZnJvbSA8IGxlbjsgZnJvbSsrKSB7CiAgICAgICAgaWYgKGZyb20gaW4gdGhpcyAmJiB0aGlzW2Zyb21dID09PSBlbHQpIHJldHVybiBmcm9tOwogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH07CiAgfQoKICAvKiBBcnJheSBoZWxwZXIgKi8KICBmdW5jdGlvbiBleGlzdEluQXJyYXkoYXJyYXksIGl0ZW0pIHsKICAgIHZhciBpbmRleCA9IGFycmF5LmluZGV4T2YoaXRlbSk7CiAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8qIFZhbHVlIGhlbHBlciAqLwogIGZ1bmN0aW9uIGlzRmFsc2UodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBpc1RydWUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGlzTnVtYmVyKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mKHZhbHVlKSA9PT0gJ251bWJlcic7CiAgfQoKICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZih2YWx1ZSkgPT09ICdzdHJpbmcnOwogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbic7CiAgfQoKICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZih2YWx1ZSkgPT09ICdvYmplY3QnOwogIH0KCgogIC8qIFBsdWdpbiBzdGFydCAqLwogIFBsdWdpbi5wcm90b3R5cGUgPSB7CgogICAgLyogSW5pdGlhbGl6YXRpb24gb2YgcGx1Z2luICovCiAgICBpbml0OiBmdW5jdGlvbigpIHsKCiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIENvbnN0YW50IGhlbHBlcgogICAgICB0aGlzLkFYSVNfWCA9IDE7CiAgICAgIHRoaXMuQVhJU19ZID0gMDsKCiAgICAgIHRoaXMuZGF0YUF0dHJpYnV0ZU1hcCA9IHsKICAgICAgICAibmV4dCI6ICJhc2NlbnNvci1uZXh0IiwKICAgICAgICAicHJldiI6ICJhc2NlbnNvci1wcmV2IiwKICAgICAgICAiZG93biI6ICJhc2NlbnNvci1kb3duIiwKICAgICAgICAidXAiOiAiYXNjZW5zb3ItdXAiLAogICAgICAgICJsZWZ0IjogImFzY2Vuc29yLWxlZnQiLAogICAgICAgICJyaWdodCI6ICJhc2NlbnNvci1yaWdodCIKICAgICAgfTsKCiAgICAgIC8vIFNldHVwIGdsb2JhbCB2YXJpYWJsZSAtIHNlbGVjdG9yIAogICAgICB0aGlzLm5vZGUgPSAkKHRoaXMuZWxlbWVudCk7CiAgICAgIHRoaXMubm9kZUNoaWxkcmVuID0gdGhpcy5ub2RlLmNoaWxkcmVuKHRoaXMub3B0aW9ucy5jaGlsZFR5cGUpOwogICAgICB0aGlzLmZsb29yQWN0aXZlID0gKGlzTnVtYmVyKHRoaXMuX2dldEZsb29yRnJvbUhhc2goKSkpID8gdGhpcy5fZ2V0Rmxvb3JGcm9tSGFzaCgpIDogdGhpcy5vcHRpb25zLndpbmRvd3NPbjsKCiAgICAgIHRoaXMuTkggPSB0aGlzLm5vZGUuaGVpZ2h0KCk7CiAgICAgIHRoaXMuTlcgPSB0aGlzLm5vZGUud2lkdGgoKTsKCiAgICAgIC8vIFNldHVwIGdsb2JhbCB2YXJpYWJsZSAtIGhlbHBlcgogICAgICB2YXIgYW5kcm9pZENvbXBhdGlibGUgPSB0cnVlOwogICAgICB2YXIgdmVyc2lvbiA9IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0FuZHJvaWRccysoW1xkXC5dKykvKTsKICAgICAgaWYgKHZlcnNpb24pIGFuZHJvaWRDb21wYXRpYmxlID0gcGFyc2VGbG9hdCh2ZXJzaW9uWzFdKSA+IDM7CgoKICAgICAgdGhpcy5kaXJlY3Rpb25Jc0FycmF5ID0gaXNPYmplY3QodGhpcy5vcHRpb25zLmRpcmVjdGlvbik7CiAgICAgIHRoaXMuc3VwcG9ydFRyYW5zZm9ybSA9IGhhczNkKCkgJiYgYW5kcm9pZENvbXBhdGlibGU7CgoKCiAgICAgIC8vIENoZWNrIGlmIGZsb29yIG5hbWUgYXJyYXkgJiBub2RlIGNoaWxkcmVuIGxlbmd0aCBtYXRjaAogICAgICBpZiAoaXNPYmplY3QodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lKSAmJiB0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUubGVuZ3RoIDwgdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2VtaXRDb25zb2xlTWVzc2FnZSgiZXJyb3IiLCAiZmxvb3JzIHRvdGFsICgiICsgdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoICsgIikgJiBmbG9vciBuYW1lIGFycmF5IGxlbmd0aCAoIiArIHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZS5sZW5ndGggKyAiKSBkb24ndCBtYXRjaCIpOwogICAgICB9CgogICAgICAvLyBDaGVjayBpZiBkaXJlY3Rpb24gYXJyYXkgJiBub2RlIGNoaWxkcmVuIGxlbmd0aCBtYXRjaAogICAgICBpZiAodGhpcy5kaXJlY3Rpb25Jc0FycmF5ICYmIHRoaXMub3B0aW9ucy5kaXJlY3Rpb24ubGVuZ3RoIDwgdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2VtaXRDb25zb2xlTWVzc2FnZSgiZXJyb3IiLCAiZmxvb3JzIHRvdGFsICgiICsgdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoICsgIikgJiBkaXJlY3Rpb24gYXJyYXkgbGVuZ2h0ICgiICsgdGhpcy5vcHRpb25zLmRpcmVjdGlvbi5sZW5ndGggKyAiKSBkb24ndCBtYXRjaCIpOwogICAgICB9CgogICAgICAvLyBTdGFydCB0aGUgbWFnaWMKICAgICAgdGhpcy5zZXR1cCgpOwoKICAgIH0sCgoKICAgIC8qIE1hZ2ljICovCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX3Bvc2l0aW9uRWxlbWVudCgpOwogICAgICB0aGlzLl9iaW5kRXZlbnRzKCk7CiAgICAgIHRoaXMuc2Nyb2xsVG9GbG9vcih0aGlzLmZsb29yQWN0aXZlKTsKCiAgICAgIGlmIChpc09iamVjdCh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUpKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmZsb29yQWN0aXZlKTsKICAgICAgfQogICAgICBpZiAoaXNGdW5jdGlvbih0aGlzLm9wdGlvbnMucmVhZHkpKSB0aGlzLm9wdGlvbnMucmVhZHkoKTsKICAgIH0sCgoKICAgIC8qIFNldHVwIFVzZXIgbGlzdGVuZXIgKi8KICAgIF9iaW5kRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgdGhpcy5ub2RlLm9uKCdzY3JvbGxUb0RpcmVjdGlvbicsIGZ1bmN0aW9uKGV2ZW50LCBkaXJlY3Rpb24pIHsKICAgICAgICBzZWxmLnNjcm9sbFRvRGlyZWN0aW9uKGRpcmVjdGlvbik7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlLm9uKCdzY3JvbGxUb1N0YWdlJywgZnVuY3Rpb24oZXZlbnQsIGZsb29yKSB7CiAgICAgICAgaWYgKHR5cGVvZiBmbG9vciA9PSAnc3RyaW5nJykgewogICAgICAgICAgdmFyIGZsb29ySWQgPSAkLmluQXJyYXkoZmxvb3IsIHNlbGYub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSk7CiAgICAgICAgICBpZiAoZmxvb3JJZCAhPT0gLTEpIHNlbGYuc2Nyb2xsVG9GbG9vcihmbG9vcklkKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBmbG9vciA9PSAnbnVtYmVyJykgewogICAgICAgICAgaWYgKGZsb29yID4gc2VsZi5ub2RlQ2hpbGRyZW4ubGVuZ3RoKSByZXR1cm47CiAgICAgICAgICBzZWxmLnNjcm9sbFRvRmxvb3IoZmxvb3IpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICB0aGlzLm5vZGUub24oJ25leHQnLCBmdW5jdGlvbihldmVudCwgZmxvb3IpIHsKICAgICAgICB2YXIgZGF0YUF0dHJpYnV0ZURpcmVjdGlvbiA9IHNlbGYubm9kZUNoaWxkcmVuLmVxKHNlbGYuZmxvb3JBY3RpdmUpLmRhdGEoc2VsZi5kYXRhQXR0cmlidXRlTWFwLm5leHQpOwogICAgICAgIGlmIChkYXRhQXR0cmlidXRlRGlyZWN0aW9uKSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pOwogICAgICAgIHNlbGYubmV4dCgpOwogICAgICB9KTsKCiAgICAgIHRoaXMubm9kZS5vbigncHJldicsIGZ1bmN0aW9uKGV2ZW50LCBmbG9vcikgewogICAgICAgIHZhciBkYXRhQXR0cmlidXRlRGlyZWN0aW9uID0gc2VsZi5ub2RlQ2hpbGRyZW4uZXEoc2VsZi5mbG9vckFjdGl2ZSkuZGF0YShzZWxmLmRhdGFBdHRyaWJ1dGVNYXAucHJldik7CiAgICAgICAgaWYgKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoZGF0YUF0dHJpYnV0ZURpcmVjdGlvbik7CiAgICAgICAgc2VsZi5wcmV2KCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlLm9uKCdyZWZyZXNoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5yZWZyZXNoKCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlLm9uKCdyZW1vdmUnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLmRlc3Ryb3koKTsKICAgICAgfSk7CgogICAgICAvLyBzZXR1cCByZXNpemUgJiBrZXkgbGlzdGVuZXIKICAgICAgJCh3aW5kb3cpLm9uKCdyZXNpemUuYXNjZW5zb3InLCBmdW5jdGlvbihldmVudCkgewogICAgICAgIHNlbGYuc2Nyb2xsVG9GbG9vcihzZWxmLmZsb29yQWN0aXZlLCBmYWxzZSk7CiAgICAgIH0pOwoKICAgICAgLy8gSWYgZmxvb3JOYW1lLCBhZGQgaGFzaGNoYW5nZSBsaXN0ZW5lcgogICAgICBpZiAoaXNPYmplY3QodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lKSkgewogICAgICAgICQod2luZG93KS5vbignaGFzaGNoYW5nZS5hc2NlbnNvcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBzZWxmLl9oYXNoY2hhbmdlSGFuZGxlcihldmVudCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIC8vIERldGVjdCBvcmllbnRhdGlvbiBjaGFuZ2UsIGZvciBkZXZpY2UKICAgICAgaWYgKHdpbmRvdy5EZXZpY2VPcmllbnRhdGlvbkV2ZW50KSB7CiAgICAgICAgJCh3aW5kb3cpLm9uKCdvcmllbnRhdGlvbmNoYW5nZS5hc2NlbnNvcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vckFjdGl2ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm9wdGlvbnMua2V5TmF2aWdhdGlvbikgewogICAgICAgICQoZG9jdW1lbnQpLm9uKCdrZXlkb3duLmFzY2Vuc29yJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIHNlbGYuX2tleXByZXNzSGFuZGxlcihldmVudCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm9wdGlvbnMud2hlZWxOYXZpZ2F0aW9uKSB7CiAgICAgICAgdGhpcy5ub2RlLm9uKCdtb3VzZXdoZWVsLmFzY2Vuc29yJywgZnVuY3Rpb24oZSkgewogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFzZWxmLnNjcm9sbEluQ2hpbGRyZW4pIHNlbGYuX2hhbmRsZU1vdXNlV2hlZWxFdmVudChlKTsKICAgICAgICAgIH0sIDEwKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4ub24oJ3Njcm9sbC5hc2NlbnNvcicsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNlbGYuc2Nyb2xsSW5DaGlsZHJlbiA9IHRydWU7CiAgICAgICAgICBpZiAoc2VsZi5zY3JvbGxUaW1lT3V0KSBjbGVhclRpbWVvdXQoc2VsZi5zY3JvbGxUaW1lT3V0KTsKICAgICAgICAgIHNlbGYuc2Nyb2xsVGltZU91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsSW5DaGlsZHJlbiA9IGZhbHNlOwogICAgICAgICAgfSwgMzAwKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgLy8gSWYgc3dpcGUgZXZlbnQgb3B0aW9uIGlzIHRydWUgfHwgc3RyaW5nCiAgICAgIGlmICh0aGlzLm9wdGlvbnMuc3dpcGVOYXZpZ2F0aW9uKSB7CgogICAgICAgIHZhciB0b3VjaEV2ZW50ID0gJ3RvdWNoc3RhcnQuYXNjZW5zb3IgdG91Y2hlbmQuYXNjZW5zb3IgdG91Y2hjYW5jZWwuYXNjZW5zb3InOwoKICAgICAgICAvLyBJZiBtb2JpbGUtb25seSwgb25seSB1c2UgdG91Y2hzdGFydC9lbmQgZXZlbnQJCQkJCiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zd2lwZU5hdmlnYXRpb24gIT09ICdtb2JpbGUtb25seScpIHRvdWNoRXZlbnQgKz0gJyBtb3VzZWRvd24uYXNjZW5zb3IgbW91c2V1cC5hc2NlbnNvcic7CgogICAgICAgIC8vIExpc3RlbiB0byB0b3VjaCBldmVudAogICAgICAgIHRoaXMubm9kZS5vbih0b3VjaEV2ZW50LCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgc2VsZi5faGFuZGxlVG91Y2hFdmVudChldmVudCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgcmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubm9kZUNoaWxkcmVuID0gdGhpcy5ub2RlLmNoaWxkcmVuKHRoaXMub3B0aW9ucy5jaGlsZFR5cGUpOwogICAgICB0aGlzLl9wb3NpdGlvbkVsZW1lbnQoKTsKICAgIH0sCgogICAgLyogUmVtb3ZlIG1ldGhvZCovCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKCiAgICAgIC8vIFVuYmluZCBhbGwgYmluZGVkIGV2ZW50CiAgICAgIHRoaXMubm9kZUNoaWxkcmVuLm9mZignc2Nyb2xsLmFzY2Vuc29yJyk7CiAgICAgIHRoaXMubm9kZS5vZmYoJ21vdXNld2hlZWwuYXNjZW5zb3Igc2Nyb2xsVG9EaXJlY3Rpb24gc2Nyb2xsVG9TdGFnZSBuZXh0IHByZXYgcmVmcmVzaCByZW1vdmUgdG91Y2hzdGFydC5hc2NlbnNvciB0b3VjaGVuZC5hc2NlbnNvciBtb3VzZWRvd24uYXNjZW5zb3IgbW91c2V1cC5hc2NlbnNvciB0b3VjaGNhbmNlbC5hc2NlbnNvcicpOwogICAgICAkKHdpbmRvdykub2ZmKCdyZXNpemUuYXNjZW5zb3IgaGFzaGNoYW5nZS5hc2NlbnNvciBvcmllbnRhdGlvbmNoYW5nZS5hc2NlbnNvcicpOwogICAgICAkKGRvY3VtZW50KS5vZmYoJ2tleWRvd24uYXNjZW5zb3InKTsKCiAgICAgIC8vIFJlbW92ZSBjc3MKICAgICAgdGhpcy5ub2RlLmNzcyh7CiAgICAgICAgJ3Bvc2l0aW9uJzogJycsCiAgICAgICAgJ292ZXJmbG93JzogJycsCiAgICAgICAgJ3RvcCc6ICcnLAogICAgICAgICdsZWZ0JzogJycsCiAgICAgICAgJ3dpZHRoJzogJycsCiAgICAgICAgJ2hlaWdodCc6ICcnCiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4uY3NzKHsKICAgICAgICAncG9zaXRpb24nOiAnJywKICAgICAgICAnb3ZlcmZsb3cnOiAnJywKICAgICAgICAndG9wJzogJycsCiAgICAgICAgJ2xlZnQnOiAnJywKICAgICAgICAnd2lkdGgnOiAnJywKICAgICAgICAnaGVpZ2h0JzogJycsCiAgICAgICAgJ3RyYW5zZm9ybSc6ICcnCiAgICAgIH0pOwoKICAgICAgLy8gUmVtb3ZlIHBsdWdpbiBpbnN0YW5jZQogICAgICB0aGlzLm5vZGUucmVtb3ZlRGF0YSgpOwogICAgfSwKCiAgICBfaGFuZGxlTW91c2VXaGVlbEV2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICBpZiAodGhpcy5ub2RlLmlzKCc6YW5pbWF0ZWQnKSkgcmV0dXJuOwoKICAgICAgdGhpcy5zY3JvbGxUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CgogICAgICBpZiAoIXRoaXMubGFzdFNjcm9sbFRpbWUgfHwgdGhpcy5zY3JvbGxUaW1lIC0gdGhpcy5sYXN0U2Nyb2xsVGltZSA+IHRoaXMub3B0aW9ucy53aGVlbE5hdmlnYXRpb25EZWxheSkgewogICAgICAgIHRoaXMubGFzdFNjcm9sbFRpbWUgPSB0aGlzLnNjcm9sbFRpbWU7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmxhc3RTY3JvbGxUaW1lID0gdGhpcy5zY3JvbGxUaW1lOwoKICAgICAgdmFyIG1vdXNlWCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQud2hlZWxEZWx0YVg7CiAgICAgIHZhciBtb3VzZVkgPSBldmVudC5vcmlnaW5hbEV2ZW50LndoZWVsRGVsdGFZOwoKICAgICAgaWYgKE1hdGguYWJzKG1vdXNlWCkgPiBNYXRoLmFicyhtb3VzZVkpICYmIG1vdXNlWCA+IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ2xlZnQnKTsKICAgICAgaWYgKE1hdGguYWJzKG1vdXNlWCkgPiBNYXRoLmFicyhtb3VzZVkpICYmIG1vdXNlWCA8IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ3JpZ2h0Jyk7CiAgICAgIGlmIChNYXRoLmFicyhtb3VzZVkpID4gTWF0aC5hYnMobW91c2VYKSAmJiBtb3VzZVkgPiAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCd1cCcpOwogICAgICBpZiAoTWF0aC5hYnMobW91c2VZKSA+IE1hdGguYWJzKG1vdXNlWCkgJiYgbW91c2VZIDwgMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbignZG93bicpOwoKICAgIH0sCgoKICAgIC8qIFRvdWNoIGV2ZW50IGhhbmRsZXIgKi8KICAgIF9oYW5kbGVUb3VjaEV2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkgewoKICAgICAgICAvLyBPbiB0b3VjaC9tb3VzZSBkb3duCiAgICAgICAgY2FzZSAndG91Y2hzdGFydCc6CiAgICAgICAgY2FzZSAnbW91c2Vkb3duJzoKCiAgICAgICAgICAvLyBzYXZlIHRpbWUgJiBvcmlnaW5hbCBwb3NpdGlvbiBmb3IgWC9ZCiAgICAgICAgICB0aGlzLnRvdWNoU3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICB0aGlzLnRvdWNoU3RhcnRYID0gKGV2ZW50LnR5cGUgPT0gJ3RvdWNoc3RhcnQnKSA/IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LnBhZ2VYOwogICAgICAgICAgdGhpcy50b3VjaFN0YXJ0WSA9IChldmVudC50eXBlID09ICd0b3VjaHN0YXJ0JykgPyBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbMF0ucGFnZVkgOiBldmVudC5wYWdlWTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIC8vIE9uIHRvdWNoL21vdXNlZG93bgogICAgICAgIGNhc2UgJ3RvdWNoZW5kJzoKICAgICAgICBjYXNlICd0b3VjaGNhbmNlbCc6CiAgICAgICAgY2FzZSAnbW91c2V1cCc6CgogICAgICAgICAgLy8gU2F2ZSB0aW1lICYgZmluYWwgcG9zaXRpb24gZm9yIFgvWQogICAgICAgICAgdGhpcy50b3VjaEVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICAgIHRoaXMudG91Y2hFbmRYID0gKGV2ZW50LnR5cGUgPT0gJ3RvdWNoZW5kJyB8fCBldmVudC50eXBlID09ICd0b3VjaGNhbmNlbCcpID8gZXZlbnQub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LnBhZ2VYOwogICAgICAgICAgdGhpcy50b3VjaEVuZFkgPSAoZXZlbnQudHlwZSA9PSAndG91Y2hlbmQnIHx8IGV2ZW50LnR5cGUgPT0gJ3RvdWNoY2FuY2VsJykgPyBldmVudC5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZIDogZXZlbnQucGFnZVk7CgogICAgICAgICAgLy8gY2FsY3VsYXRlIGRpc3RhbmNlLCBkdXJhdGlvbiAmIHZlbG9jaXR5LgogICAgICAgICAgdmFyIGRpc3RhbmNlWCA9IHRoaXMudG91Y2hTdGFydFggLSB0aGlzLnRvdWNoRW5kWDsKICAgICAgICAgIHZhciBkaXN0YW5jZVkgPSB0aGlzLnRvdWNoU3RhcnRZIC0gdGhpcy50b3VjaEVuZFk7CiAgICAgICAgICB2YXIgZHVyYXRpb24gPSB0aGlzLnRvdWNoRW5kVGltZSAtIHRoaXMudG91Y2hTdGFydFRpbWU7CiAgICAgICAgICB2YXIgdmVsb2NpdHlYID0gTWF0aC5hYnMoZGlzdGFuY2VYKSAvIGR1cmF0aW9uOwogICAgICAgICAgdmFyIHZlbG9jaXR5WSA9IE1hdGguYWJzKGRpc3RhbmNlWSkgLyBkdXJhdGlvbjsKCiAgICAgICAgICAvLyBJZiB2ZWxvY2l0eSwgdXNlIGFic29sdXRlIGRpc3RhbmNlIHRvIGRldGVybWluZSBheGlzCiAgICAgICAgICAvLyBhbmQgY29tcGFyZSBkaXN0YW5jZSB0byAwIGRldGVybWluZSBkaXJlY3Rpb24KICAgICAgICAgIGlmICh2ZWxvY2l0eVggPiB0aGlzLm9wdGlvbnMuc3dpcGVWZWxvY2l0eSAmJiBNYXRoLmFicyhkaXN0YW5jZVgpID4gTWF0aC5hYnMoZGlzdGFuY2VZKSAmJiBkaXN0YW5jZVggPCAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCdsZWZ0Jyk7CiAgICAgICAgICBpZiAodmVsb2NpdHlYID4gdGhpcy5vcHRpb25zLnN3aXBlVmVsb2NpdHkgJiYgTWF0aC5hYnMoZGlzdGFuY2VYKSA+IE1hdGguYWJzKGRpc3RhbmNlWSkgJiYgZGlzdGFuY2VYID4gMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbigncmlnaHQnKTsKICAgICAgICAgIGlmICh2ZWxvY2l0eVkgPiB0aGlzLm9wdGlvbnMuc3dpcGVWZWxvY2l0eSAmJiBNYXRoLmFicyhkaXN0YW5jZVgpIDwgTWF0aC5hYnMoZGlzdGFuY2VZKSAmJiBkaXN0YW5jZVkgPCAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCd1cCcpOwogICAgICAgICAgaWYgKHZlbG9jaXR5WSA+IHRoaXMub3B0aW9ucy5zd2lwZVZlbG9jaXR5ICYmIE1hdGguYWJzKGRpc3RhbmNlWCkgPCBNYXRoLmFicyhkaXN0YW5jZVkpICYmIGRpc3RhbmNlWSA+IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ2Rvd24nKTsKCiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfSwKCgoKICAgIC8qIFBvc2l0aW9uIGZsb29yIG9uIGRvbSAqLwogICAgX3Bvc2l0aW9uRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHRoaXMuZGlyZWN0aW9uSXNBcnJheSkgdGhpcy5fZ2VuZXJhdGVGbG9vck1hcCgpOwoKICAgICAgLy8gU2V0dXAgZmxvb3Igc2l6ZSAmIHBvc2l0aW9uCiAgICAgIHRoaXMubm9kZS5jc3MoewogICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsCiAgICAgICAgJ292ZXJmbG93JzogJ2hpZGRlbicsCiAgICAgICAgJ3RvcCc6ICcwJywKICAgICAgICAnbGVmdCc6ICcwJywKICAgICAgICAnd2lkdGgnOiB0aGlzLm9wdGlvbnMud2lkdGgsCiAgICAgICAgJ2hlaWdodCc6IHRoaXMub3B0aW9ucy5oZWlnaHQKICAgICAgfSk7CgogICAgICB0aGlzLm5vZGVDaGlsZHJlbi5jc3MoewogICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsCiAgICAgICAgJ292ZXJmbG93JzogJ2F1dG8nLAogICAgICAgICd0b3AnOiAnMCcsCiAgICAgICAgJ2xlZnQnOiAnMCcsCiAgICAgICAgJ3dpZHRoJzogJzEwMCUnLAogICAgICAgICdoZWlnaHQnOiAnMTAwJScKICAgICAgfSk7CgogICAgICAvLyBwbGFjZSBlbGVtZW50IGNvcnJlY3RseQogICAgICB0aGlzLm5vZGVDaGlsZHJlbi5lYWNoKGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgaWYgKHNlbGYuc3VwcG9ydFRyYW5zZm9ybSkgewogICAgICAgICAgJCh0aGlzKS5jc3MoewogICAgICAgICAgICAndHJhbnNmb3JtJzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT09ICd5JykgcmV0dXJuICd0cmFuc2xhdGVZKCcgKyBpbmRleCAqIDEwMCArICclKSc7CiAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT09ICd4JykgcmV0dXJuICd0cmFuc2xhdGVYKCcgKyBpbmRleCAqIDEwMCArICclKSc7CiAgICAgICAgICAgICAgaWYgKHNlbGYuZGlyZWN0aW9uSXNBcnJheSkgcmV0dXJuICd0cmFuc2xhdGVZKCcgKyBzZWxmLm9wdGlvbnMuZGlyZWN0aW9uW2luZGV4XVtzZWxmLkFYSVNfWV0gKiAxMDAgKyAnJSkgdHJhbnNsYXRlWCgnICsgc2VsZi5vcHRpb25zLmRpcmVjdGlvbltpbmRleF1bc2VsZi5BWElTX1hdICogMTAwICsgJyUpJzsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICQodGhpcykuY3NzKHsKICAgICAgICAgICAgJ3RvcCc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneScpIHJldHVybiBpbmRleCAqIDEwMCArICclJzsKICAgICAgICAgICAgICBpZiAoc2VsZi5kaXJlY3Rpb25Jc0FycmF5KSByZXR1cm4gc2VsZi5vcHRpb25zLmRpcmVjdGlvbltpbmRleF1bc2VsZi5BWElTX1ldICogMTAwICsgJyUnOwogICAgICAgICAgICB9LAogICAgICAgICAgICAnbGVmdCc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneCcpIHJldHVybiBpbmRleCAqIDEwMCArICclJzsKICAgICAgICAgICAgICBpZiAoc2VsZi5kaXJlY3Rpb25Jc0FycmF5KSByZXR1cm4gc2VsZi5vcHRpb25zLmRpcmVjdGlvbltpbmRleF1bc2VsZi5BWElTX1hdICogMTAwICsgJyUnOwogICAgICAgICAgICB9LAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgoKICAgIC8qIEhlbHBlciA6IFJldHVybiBmbG9vciBpbmRleCBmcm9tIGhhc2guICovCiAgICBfZ2V0Rmxvb3JGcm9tSGFzaDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLl9nZXRIYXNoKCkpIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lICYmIGV4aXN0SW5BcnJheSh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUsIHRoaXMuX2dldEhhc2goKSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUuaW5kZXhPZih0aGlzLl9nZXRIYXNoKCkpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKCiAgICAvKiBIZWxwZXIgOiBSZXR1cm4gZmxvb3IgaW5kZXggZnJvbSBoYXNoLiAqLwogICAgX2dldEhhc2g6IGZ1bmN0aW9uKCkgewogICAgICBpZiAod2luZG93LmxvY2F0aW9uLmhhc2gpIHsKICAgICAgICB2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KCcjJykucG9wKCk7CiAgICAgICAgcmV0dXJuIGhhc2g7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCgogICAgLyogSGFubGRlcjogSGFuZGxlIHdpbmRvdyBoYXNoY2FuZ2UgZXZlbnQgKi8KICAgIF9oYXNoY2hhbmdlSGFuZGxlcjogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgaWYgKGlzTnVtYmVyKHRoaXMuX2dldEZsb29yRnJvbUhhc2goKSkgJiYgdGhpcy5fZ2V0Rmxvb3JGcm9tSGFzaCgpICE9PSB0aGlzLmZsb29yQWN0aXZlICYmICF0aGlzLm5vZGUuaXMoJzphbmltYXRlZCcpKSB7CiAgICAgICAgdGhpcy5zY3JvbGxUb0Zsb29yKHRoaXMuX2dldEZsb29yRnJvbUhhc2goKSk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qIFdpbGwgdXBkYXRlIGhhc2ggbG9jYXRpb24gaWYgZmxvb3IgbmFtZSBhcmUgc2V0dXAuICovCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24oZmxvb3JJbmRleCkgewogICAgICBpZiAoaXNPYmplY3QodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lKSAmJiB0aGlzLl9nZXRIYXNoKCkgIT09IHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZVtmbG9vckluZGV4XSkgewogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKCgnJyArIHdpbmRvdy5sb2NhdGlvbikuc3BsaXQoJyMnKVswXSArICcjJyArIHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZVtmbG9vckluZGV4XSk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qIEV2ZW50IGhlbHBlciwgbGV0IGFzY2Vuc29yIGNyZWF0ZSBvd24gZXZlbnQsIHdpdGggZmxvb3IgaW5mb3JtYXRpb24gKi8KICAgIF9lbWl0RXZlbnQ6IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZnJvbSwgdG8pIHsKICAgICAgdGhpcy5ub2RlLnRyaWdnZXIoZXZlbnROYW1lLCBmbG9vciA9IHsKICAgICAgICBmcm9tOiBmcm9tLAogICAgICAgIHRvOiB0bwogICAgICB9KTsKICAgIH0sCgoKICAgIC8qIFdhcm4gaGFuZGxlciAqLwogICAgX2VtaXRDb25zb2xlTWVzc2FnZTogZnVuY3Rpb24odHlwZSwgd2FybikgewogICAgICBpZiAodHlwZSA9PSAiZXJyb3IiKSBjb25zb2xlLmVycm9yKCJBc2NlbnNvci5qczogIiArIHdhcm4pOwogICAgICBpZiAodHlwZSA9PSAid2FybiIpIGNvbnNvbGUud2FybigiQXNjZW5zb3IuanM6ICIgKyB3YXJuKTsKICAgIH0sCgoKICAgIC8qIEtleXByZXNzIEhhbmRsZXIgKi8KICAgIF9rZXlwcmVzc0hhbmRsZXI6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIga2V5ID0gZS5rZXlDb2RlIHx8IGUud2hpY2g7CiAgICAgIGlmICghJCgnaW5wdXQsIHRleHRhcmVhLCBidXR0b24nKS5pcygnOmZvY3VzJykpIHsKICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgY2FzZSA0MDoKICAgICAgICAgIGNhc2UgODM6CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG9EaXJlY3Rpb24oJ2Rvd24nKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM4OgogICAgICAgICAgY2FzZSA4NzoKICAgICAgICAgICAgc2VsZi5zY3JvbGxUb0RpcmVjdGlvbigndXAnKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzNzoKICAgICAgICAgIGNhc2UgNjU6CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG9EaXJlY3Rpb24oJ2xlZnQnKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzOToKICAgICAgICAgIGNhc2UgNjg6CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG9EaXJlY3Rpb24oJ3JpZ2h0Jyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCgogICAgLyogUmVzaXplIGhhbmRsZXIuIFVwZGF0ZSBzY3JvbGxUb3AgJiBzY3JvbGxMZWZ0IHBvc2l0aW9uICovCiAgICBzY3JvbGxUb0Zsb29yOiBmdW5jdGlvbihmbG9vcikgewoKICAgICAgLy8gSWYgZmxvb3Igc2VuZCBpcyBhIHRyaW5nLCBjaGVjayBpZiBpdCBtYXRjaCBhbnkgb2YgYXNjZW5zb3JGbG9vck5hbWUsIHRoZW4gdXNlIHBvaXN0aW9uIGluIGFycmF5CiAgICAgIGlmIChpc1N0cmluZyhmbG9vcikgJiYgZXhpc3RJbkFycmF5KHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSwgZmxvb3IpKSBmbG9vciA9IHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZS5pbmRleE9mKGZsb29yKTsKCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGFuaW1hdGUgPSAoZmxvb3IgPT09IHRoaXMuZmxvb3JBY3RpdmUpID8gZmFsc2UgOiB0cnVlOwoKICAgICAgaWYgKHRoaXMuTlcgIT09IHRoaXMubm9kZS53aWR0aCgpKSB0aGlzLk5XID0gdGhpcy5ub2RlLndpZHRoKCk7CiAgICAgIGlmICh0aGlzLk5IICE9PSB0aGlzLm5vZGUuaGVpZ2h0KCkpIHRoaXMuTkggPSB0aGlzLm5vZGUuaGVpZ2h0KCk7CgogICAgICAvLyBNYWtlIHN1cmUgcG9zaXRpb24gaXMgY29ycmVjdAogICAgICB2YXIgYW5pbWF0aW9uT2JqZWN0ID0gdGhpcy5fZ2V0QW5pbWF0aW9uU2V0dGluZ3MoZmxvb3IpOwoKICAgICAgaWYgKGFuaW1hdGUpIHsKICAgICAgICB0aGlzLl9lbWl0RXZlbnQoJ3Njcm9sbFN0YXJ0Jywgc2VsZi5mbG9vckFjdGl2ZSwgZmxvb3IpOwogICAgICAgIHRoaXMubm9kZS5zdG9wKCkuYW5pbWF0ZShhbmltYXRpb25PYmplY3QucHJvcGVydHksIHNlbGYub3B0aW9ucy50aW1lLCBzZWxmLm9wdGlvbnMuZWFzaW5nLCBhbmltYXRpb25PYmplY3QuY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubm9kZS5zdG9wKCkuc2Nyb2xsVG9wKGFuaW1hdGlvbk9iamVjdC5kZWZhdWx0cy5zY3JvbGxUb3ApLnNjcm9sbExlZnQoYW5pbWF0aW9uT2JqZWN0LmRlZmF1bHRzLnNjcm9sbExlZnQpOwogICAgICB9CgogICAgICB0aGlzLmZsb29yQWN0aXZlID0gZmxvb3I7CiAgICAgIHRoaXMubm9kZS5kYXRhKCdjdXJyZW50LWZsb29yJywgdGhpcy5mbG9vckFjdGl2ZSk7CgogICAgfSwKCgogICAgLyogUHJldiBmdW5jdGlvbiAqLwogICAgcHJldjogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0YXJnZXRGbG9vciA9IHRoaXMuZmxvb3JBY3RpdmUgLSAxOwogICAgICBpZiAodGFyZ2V0Rmxvb3IgPCAwKSB7CiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMubG9vcCkgcmV0dXJuOwogICAgICAgIHRhcmdldEZsb29yID0gdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoIC0gMTsKICAgICAgfQogICAgICB0aGlzLnNjcm9sbFRvRmxvb3IodGFyZ2V0Rmxvb3IpOwogICAgfSwKCgogICAgLyogUHJldiBmdW5jdGlvbiAqLwogICAgbmV4dDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0YXJnZXRGbG9vciA9IHRoaXMuZmxvb3JBY3RpdmUgKyAxOwogICAgICBpZiAodGFyZ2V0Rmxvb3IgPiB0aGlzLm5vZGVDaGlsZHJlbi5sZW5ndGggLSAxKSB7CiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMubG9vcCkgcmV0dXJuOwogICAgICAgIHRhcmdldEZsb29yID0gMDsKICAgICAgfQoKICAgICAgdGhpcy5zY3JvbGxUb0Zsb29yKHRhcmdldEZsb29yKTsKICAgIH0sCgoKICAgIC8qIEhlbHBlciB0byBnZW5lcmF0ZSBhbmltYXRpb24gc2V0dGluZ3MgKi8KICAgIF9nZXRBbmltYXRpb25TZXR0aW5nczogZnVuY3Rpb24oZmxvb3IpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgc2F2ZUZsb29yQWN0aXZlID0gc2VsZi5mbG9vckFjdGl2ZTsKICAgICAgLy8gQ3JlYXRlIGFuaW1hdGlvbiBzZXR0aW5nIG9iamVjdAogICAgICB2YXIgYW5pbWF0aW9uU2V0dGluZ3MgPSB7CiAgICAgICAgcHJvcGVydHk6IHt9LAogICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuX2VtaXRFdmVudCgnc2Nyb2xsRW5kJywgc2F2ZUZsb29yQWN0aXZlLCBmbG9vcik7CiAgICAgICAgICBzZWxmLl91cGRhdGVIYXNoKGZsb29yKTsKICAgICAgICB9LAogICAgICAgIGRlZmF1bHRzOiB7fQogICAgICB9OwoKCiAgICAgIC8vIENyZWF0ZSBhIHNlY29uZCBzZXR0aW5nIG9iamVjdAogICAgICAvLyBpbiBjYXNlIHRoZSBxdWV1ZWQgb3B0aW9uIGlzIHNldAogICAgICB2YXIgc2Vjb25kQW5pbWF0aW9uU2V0dGluZ3MgPSB7CiAgICAgICAgcHJvcGVydHk6IHt9LAogICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuX2VtaXRFdmVudCgnc2Nyb2xsRW5kJywgc2F2ZUZsb29yQWN0aXZlLCBmbG9vcik7CiAgICAgICAgICBzZWxmLl91cGRhdGVIYXNoKGZsb29yKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBhbmltYXRpb25TZXR0aW5ncy5kZWZhdWx0cy5zY3JvbGxUb3AgPSBmbG9vciAqIHNlbGYuTkg7CiAgICAgIGFuaW1hdGlvblNldHRpbmdzLmRlZmF1bHRzLnNjcm9sbExlZnQgPSBmbG9vciAqIHNlbGYuTlc7CgogICAgICAvLyBJZiBkaXJlY3Rpb24gaXMgdmVydGljYWwKICAgICAgLy8gPT4gc2V0IHNjcm9sbFRvcCBwcm9wZXJ0eSAmIHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICBpZiAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PT0gJ3knKSB7CiAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsVG9wID0gZmxvb3IgKiBzZWxmLk5IOwogICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgfQoKCiAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyBob3Jpem9udGFsCQogICAgICAvLyA9PiBzZXQgc2Nyb2xsbGVmdCBwcm9wZXJ0eSAmIHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICBlbHNlIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneCcpIHsKICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxMZWZ0ID0gZmxvb3IgKiBzZWxmLk5XOwogICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgfQoKICAgICAgLy8gSWYgZGlyZWN0aW9uIGlzIGEgbWFwCiAgICAgIGVsc2UgaWYgKHNlbGYuZGlyZWN0aW9uSXNBcnJheSkgewoKICAgICAgICAvLyA9PiBTYXZlIHZhbHVlCiAgICAgICAgdmFyIHNjcm9sbFRvcFZhbHVlID0gc2VsZi5vcHRpb25zLmRpcmVjdGlvbltmbG9vcl1bc2VsZi5BWElTX1ldICogc2VsZi5OSDsKICAgICAgICB2YXIgc2Nyb2xsTGVmdFZhbHVlID0gc2VsZi5vcHRpb25zLmRpcmVjdGlvbltmbG9vcl1bc2VsZi5BWElTX1hdICogc2VsZi5OVzsKCiAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MuZGVmYXVsdHMuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wVmFsdWU7CiAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MuZGVmYXVsdHMuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRWYWx1ZTsKCgogICAgICAgIC8vIElmIHRoZSBxdWV1ZWQgb3B0aW9uIGlzIHNldAogICAgICAgIGlmIChzZWxmLm9wdGlvbnMucXVldWVkKSB7CgogICAgICAgICAgLy8gPT4gQ2hlY2sgZmxvb3IgcG9zaXRpb24sIHRvIGF2b2lkIGFuaW1hdGlvbiBpZiBhbHJlYWR5IG9uIHNhbWUgZmxvb3IKICAgICAgICAgIHZhciBzYW1lWHBvc2l0aW9uID0gdGhpcy5ub2RlLnNjcm9sbExlZnQoKSA9PT0gc2Nyb2xsTGVmdFZhbHVlOwogICAgICAgICAgdmFyIHNhbWVZcG9zaXRpb24gPSB0aGlzLm5vZGUuc2Nyb2xsVG9wKCkgPT09IHNjcm9sbFRvcFZhbHVlOwoKCiAgICAgICAgICAvLyBJZiBxdWV1ZWQgZGlyZWN0aW9uIGlzIGhvcml6b250YWwgJiBvbiB0aGUgc2FtZSBmbG9vcgogICAgICAgICAgLy8gPT4gU2V0IHNjcm9sbFRvcCBwcm9wZXJ0eSAmIHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5xdWV1ZWQgPT09ICd4JyAmJiBzYW1lWHBvc2l0aW9uKSB7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICAgICAgICB9CgoKICAgICAgICAgIC8vIElmIHF1ZXVlZCBkaXJlY3Rpb24gaXMgaG9yaXpvbnRhbCAmIE5PVCBvbiB0aGUgc2FtZSBmbG9vcgogICAgICAgICAgLy8gPT4gU2V0IHNjcm9sbExlZnQgcHJvcGVydHkKICAgICAgICAgIC8vID0+IFNldCBjYWxsYmFjayB0byBhIHNlY29uZCBhbmltYXRpb24gKHNjcm9sbFRvcCkKICAgICAgICAgIC8vID0+IHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbExlZnQgPSBzY3JvbGxMZWZ0VmFsdWU7CiAgICAgICAgICAgIHNlY29uZEFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYubm9kZS5zdG9wKCkuYW5pbWF0ZShzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eSwgc2VsZi5vcHRpb25zLnRpbWUsIHNlbGYub3B0aW9ucy5lYXNpbmcsIHNlY29uZEFuaW1hdGlvblNldHRpbmdzLmNhbGxiYWNrKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICAgICAgfQoKCiAgICAgICAgICAvLyBJZiBxdWV1ZWQgZGlyZWN0aW9uIGlzIHZlcnRpY2FsICYgb24gdGhlIHNhbWUgZmxvb3IKICAgICAgICAgIC8vID0+IFNldCBzY3JvbGxUb3Agc2Nyb2xsTGVmdCAmIHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5xdWV1ZWQgPT09ICd5JyAmJiBzYW1lWXBvc2l0aW9uKSB7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbExlZnQgPSBzY3JvbGxMZWZ0VmFsdWU7CiAgICAgICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgICAgIH0KCgogICAgICAgICAgLy8gSWYgcXVldWVkIGRpcmVjdGlvbiBpcyB2ZXJ0aWNhbCAmIE5PVCBvbiB0aGUgc2FtZSBmbG9vcgogICAgICAgICAgLy8gPT4gU2V0IHNjcm9sbFRvcCBwcm9wZXJ0eQogICAgICAgICAgLy8gPT4gU2V0IGNhbGxiYWNrIHRvIGEgc2Vjb25kIGFuaW1hdGlvbiAoc2Nyb2xsTGVmdCkKICAgICAgICAgIC8vID0+IHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgICAgICBzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdFZhbHVlOwogICAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYubm9kZS5zdG9wKCkuYW5pbWF0ZShzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eSwgc2VsZi5vcHRpb25zLnRpbWUsIHNlbGYub3B0aW9ucy5lYXNpbmcsIHNlY29uZEFuaW1hdGlvblNldHRpbmdzLmNhbGxiYWNrKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIC8vIElmIHF1ZXVkIG9wdGlvbiBpcyBub3Qgc2V0LCAKICAgICAgICAvLyA9PiBzZXQgc2Nyb2xsVG9wICYgU2Nyb2xsTGVmdCBwcm9wZXJ0eSAKICAgICAgICAvLyA9PiByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3MKICAgICAgICBlbHNlIHsKICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRWYWx1ZTsKICAgICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgIH0sCgoKICAgIC8qIEhlbHBlciB0byBoYW5kbGUgZGlyZWN0aW9uIGNvcnJlY3RseS4gKi8KICAgIHNjcm9sbFRvRGlyZWN0aW9uOiBmdW5jdGlvbihkaXJlY3Rpb24pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgLy8gSWYgYSBkYXRhIGF0dHJpYnV0ZSB3aXRoIGN1cnJlbnQgZGlyZWN0aW9uCiAgICAgIC8vIGlzIGZvdW5kLCB1c2UgaXQuCiAgICAgIHZhciBkYXRhQXR0cmlidXRlRGlyZWN0aW9uID0gdGhpcy5ub2RlQ2hpbGRyZW4uZXEodGhpcy5mbG9vckFjdGl2ZSkuZGF0YSh0aGlzLmRhdGFBdHRyaWJ1dGVNYXBbZGlyZWN0aW9uXSk7CiAgICAgIGlmIChkYXRhQXR0cmlidXRlRGlyZWN0aW9uKSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pOwoKCiAgICAgIHZhciBkaXJlY3Rpb25Jc0hvcml6b250YWwgPSAoZGlyZWN0aW9uID09ICdyaWdodCcgfHwgZGlyZWN0aW9uID09ICdsZWZ0Jyk7CiAgICAgIHZhciBkaXJlY3Rpb25Jc1ZlcnRpY2FsID0gKGRpcmVjdGlvbiA9PSAnZG93bicgfHwgZGlyZWN0aW9uID09ICd1cCcpOwoKICAgICAgLy8gSWYgZGlyZWN0aW9uIGlzIHggb3IgeSBhbmQgdGhlcmUgaXMgCiAgICAgIC8vIGRpcmVjdGlvbiBhcmUgb3BwcHNpdGUsIHJldHVybiBoZXJlCiAgICAgIGlmICgoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneScgJiYgZGlyZWN0aW9uSXNIb3Jpem9udGFsKSB8fCAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneCcgJiYgZGlyZWN0aW9uSXNWZXJ0aWNhbCkpIHJldHVybjsKCiAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyB4IG9yIHgsIGFuZCAKICAgICAgLy8gZGlyZWN0aW9uIG1hdGNoLCB1c2UgcHJldi9uZXh0CiAgICAgIGlmICgoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneScgJiYgZGlyZWN0aW9uID09ICdkb3duJykgfHwgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT0gJ3gnICYmIGRpcmVjdGlvbiA9PSAncmlnaHQnKSkgcmV0dXJuIHNlbGYubmV4dCgpOwogICAgICBpZiAoKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT0gJ3knICYmIGRpcmVjdGlvbiA9PSAndXAnKSB8fCAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneCcgJiYgZGlyZWN0aW9uID09ICdsZWZ0JykpIHJldHVybiBzZWxmLnByZXYoKTsKCgogICAgICBpZiAoc2VsZi5kaXJlY3Rpb25Jc0FycmF5KSB7CgogICAgICAgIHZhciBmbG9vck9iamVjdCA9IHNlbGYuZmxvb3JNYXBbc2VsZi5mbG9vckFjdGl2ZV07CgogICAgICAgIC8vIElmIGV4aXN0aW5nLCByZXR1cm4gYXBwZW5kaW5nIGZsb29yCiAgICAgICAgdmFyIGRpcmVjdEZsb29yID0gZmxvb3JPYmplY3RbZGlyZWN0aW9uXTsKICAgICAgICBpZiAoaXNOdW1iZXIoZGlyZWN0Rmxvb3IpKSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGRpcmVjdEZsb29yKTsKCiAgICAgICAgLy8gSnVtcCBpcyBzZXQgdG8gdHJ1ZSwgdXNlIHRoZSAKICAgICAgICAvLyBjbG9zZXN0IGZsb29yIGluIHRoYXQgc2FtZSBkaXJlY3Rpb24KICAgICAgICB2YXIgY2xvc2VzdEZsb29yID0gZmxvb3JPYmplY3QuY2xvc2VzdFtkaXJlY3Rpb25dOwogICAgICAgIGlmIChpc1RydWUoc2VsZi5vcHRpb25zLmp1bXApICYmIGlzTnVtYmVyKGNsb3Nlc3RGbG9vcikpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoY2xvc2VzdEZsb29yKTsKCiAgICAgICAgLy8gSWYgbG9vcCBpcyBzZXQgdG8gdHJ1ZSwgdXNlCiAgICAgICAgLy8JdGhlIGZ1cnRoZXN0IGZsb29yCiAgICAgICAgdmFyIGZ1cnRoZXN0Rmxvb3IgPSBmbG9vck9iamVjdC5mdXJ0aGVzdFtkaXJlY3Rpb25dOwogICAgICAgIGlmIChpc051bWJlcihmdXJ0aGVzdEZsb29yKSAmJiAoaXNUcnVlKHNlbGYub3B0aW9ucy5sb29wKSB8fCAoZGlyZWN0aW9uSXNIb3Jpem9udGFsICYmIHNlbGYub3B0aW9ucy5sb29wID09ICdsb29wLXgnKSB8fCAoZGlyZWN0aW9uSXNWZXJ0aWNhbCAmJiBzZWxmLm9wdGlvbnMubG9vcCA9PSAnbG9vcC15JykpKSB7CiAgICAgICAgICByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGZ1cnRoZXN0Rmxvb3IpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgSW5jcmVtZW50IGV4aXN0ICYgb3B0aW9uIGlzIHNldAogICAgICAgIHZhciBpbmNyZW1lbnRGbG9vciA9IGZsb29yT2JqZWN0LmluY3JlbWVudFtkaXJlY3Rpb25dOwogICAgICAgIGlmIChpc051bWJlcihpbmNyZW1lbnRGbG9vcikpIHsKCiAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudCcgfHwgZGlyZWN0aW9uSXNWZXJ0aWNhbCAmJiBzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50LXknIHx8IGRpcmVjdGlvbklzSG9yaXpvbnRhbCAmJiBzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50LXgnKSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoaW5jcmVtZW50Rmxvb3IpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSnVtcCBmcm9tIGxhc3QgdG8gZmlyc3Qgb3IgZmlyc3QgdG8gbGFzdAogICAgICAgIGlmICgoc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudC14JyAmJiBkaXJlY3Rpb25Jc0hvcml6b250YWwpIHx8IHNlbGYub3B0aW9ucy5sb29wID09ICdpbmNyZW1lbnQnKSB7CiAgICAgICAgICBpZiAoc2VsZi5mbG9vckFjdGl2ZSA9PSBzZWxmLmZsb29yTWFwLmZ1cnRoZXN0X3gpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vck1hcC5jbG9zZXN0X3gpOwogICAgICAgICAgaWYgKHNlbGYuZmxvb3JBY3RpdmUgPT0gc2VsZi5mbG9vck1hcC5jbG9zZXN0X3gpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vck1hcC5mdXJ0aGVzdF94KTsKICAgICAgICB9CgogICAgICAgIGlmICgoc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudC15JyAmJiBkaXJlY3Rpb25Jc1ZlcnRpY2FsKSB8fCBzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50JykgewogICAgICAgICAgaWYgKHNlbGYuZmxvb3JBY3RpdmUgPT0gc2VsZi5mbG9vck1hcC5mdXJ0aGVzdF95KSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKHNlbGYuZmxvb3JNYXAuY2xvc2VzdF95KTsKICAgICAgICAgIGlmIChzZWxmLmZsb29yQWN0aXZlID09IHNlbGYuZmxvb3JNYXAuY2xvc2VzdF95KSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKHNlbGYuZmxvb3JNYXAuZnVydGhlc3RfeSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKCgogICAgLyogSGVscGVyIHRvIGdldCB0aGUgZGlyZWN0IGFwcGVuZGluZyBmbG9vciBpbiBvbmUgcHJlY2lzZSBkaXJlY3Rpb24gZGlyZWN0aW9uICovCiAgICBfZ2V0RGlyZWN0Rmxvb3JJbmRleDogZnVuY3Rpb24oREEsIGZsb29ySW5kZXgsIGRpcmVjdGlvbikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyBDcmVhdGUgZmxvb3IgdGFyZ2V0IGFycmF5IGJhc2Ugb24gZmxvb3JvYmplY3QKICAgICAgdmFyIGZsb29yVGFyZ2V0ID0gW3RoaXMub3B0aW9ucy5kaXJlY3Rpb25bZmxvb3JJbmRleF1bdGhpcy5BWElTX1ldLCB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uW2Zsb29ySW5kZXhdW3RoaXMuQVhJU19YXV07CgogICAgICAvLyBBZGp1c3QgbWFwIGRlcGVuZGluZyBvbiBkaXJlY3Rpb24KICAgICAgaWYgKGRpcmVjdGlvbiA9PSAncmlnaHQnKSBmbG9vclRhcmdldFt0aGlzLkFYSVNfWF0gKz0gMTsKICAgICAgaWYgKGRpcmVjdGlvbiA9PSAnbGVmdCcpIGZsb29yVGFyZ2V0W3RoaXMuQVhJU19YXSAtPSAxOwogICAgICBpZiAoZGlyZWN0aW9uID09ICd1cCcpIGZsb29yVGFyZ2V0W3RoaXMuQVhJU19ZXSAtPSAxOwogICAgICBpZiAoZGlyZWN0aW9uID09ICdkb3duJykgZmxvb3JUYXJnZXRbdGhpcy5BWElTX1ldICs9IDE7CgogICAgICAvLyBsb29wYW5kIGNvbXBhcmUgZGlyZWN0aW9uIG1hcAogICAgICB2YXIgZmxvb3JUYXJnZXRJbmRleCA9IGZhbHNlOwogICAgICAkLmVhY2goREEsIGZ1bmN0aW9uKGluZGV4LCBtYXApIHsKCiAgICAgICAgLy8gSWYgY3VycmVudCBvYmplY3QgbWFwIHZhbHVlIGFyZSBlcXVhbCB0byB0YXJnZXQgb25lCiAgICAgICAgaWYgKG1hcFtzZWxmLkFYSVNfWV0gPT0gZmxvb3JUYXJnZXRbc2VsZi5BWElTX1ldICYmIG1hcFtzZWxmLkFYSVNfWF0gPT0gZmxvb3JUYXJnZXRbc2VsZi5BWElTX1hdKSB7CgogICAgICAgICAgLy8gR2V0IGluZGV4ICYgYnJlYWsgbG9vcAogICAgICAgICAgZmxvb3JUYXJnZXRJbmRleCA9IGluZGV4OwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gZmxvb3JUYXJnZXRJbmRleDsKICAgIH0sCgogICAgLyogUmV0dXJuIGNvcnJlY3QgYXhpcyBkZXBlbmRpbmcgb24gcG9zaXRpb24gKi8KICAgIF9nZXRBeGlzRnJvbURpcmVjdGlvbjogZnVuY3Rpb24oZGlyZWN0aW9uKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGF4aXM7CiAgICAgIHN3aXRjaCAoZGlyZWN0aW9uKSB7CiAgICAgICAgY2FzZSAndXAnOgogICAgICAgIGNhc2UgJ2Rvd24nOgogICAgICAgICAgYXhpcyA9IHNlbGYuQVhJU19ZOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnbGVmdCc6CiAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgYXhpcyA9IHNlbGYuQVhJU19YOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIHJldHVybiBheGlzOwogICAgfSwKCiAgICAvKiBIZWxwZXIgdG8gZ2V0IHRoZSBjbG9zZXN0IGZsb29yIGluIG9uZSBwcmVjaXNlIGRpcmVjdGlvbiBkaXJlY3Rpb24gKi8KICAgIF9nZXRDbG9zZXN0Rmxvb3JJbmRleDogZnVuY3Rpb24oREEsIGZsb29ySW5kZXgsIGRpcmVjdGlvbiwgbGV2ZWwpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgbGV2ZWwgPSBsZXZlbCB8fCAwOwoKICAgICAgLy8gR2V0IGF4aXMgJiBjb21wYXJlLXRvIGZsb29ySW5kZXgKICAgICAgdmFyIGF4aXMgPSB0aGlzLl9nZXRBeGlzRnJvbURpcmVjdGlvbihkaXJlY3Rpb24pOwogICAgICB2YXIgZ29hbCA9IERBW2Zsb29ySW5kZXhdW2F4aXNdOwogICAgICB2YXIgb3Bwb3NpdGVBeGlzID0gKGF4aXMgPT0gdGhpcy5BWElTX1kpID8gdGhpcy5BWElTX1ggOiB0aGlzLkFYSVNfWTsKCiAgICAgIC8vIFNldHVwIGxvb3AgdmFyaWFibGUKICAgICAgdmFyIGNsb3Nlc3RJbmRleCA9IGZhbHNlOwogICAgICB2YXIgY2xvc2VzdE1hcCA9IGZhbHNlOwoKICAgICAgLy8gTG9vcCB0cm91Z2ggZmxvb3IgcG9zaXRpb24gYXJyYXkKICAgICAgJC5lYWNoKERBLCBmdW5jdGlvbihpbmRleCwgbWFwKSB7CgogICAgICAgIC8vIElmIG9uIHNhbWUgYXhpcwogICAgICAgIGlmIChtYXBbb3Bwb3NpdGVBeGlzXSA9PSAoREFbZmxvb3JJbmRleF1bb3Bwb3NpdGVBeGlzXSArIGxldmVsKSkgewoKICAgICAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyBmb3dhcmQgKHJpZ2h0IG9yIGRvd24pIGFuZCB0aGUgdmFsdWUgaXMgYmlnZ2VyIHRoYW4gZ29hbCAKICAgICAgICAgIC8vIG9mIGlmIGRpcmVjdGlvbiBpcyBiYWNrd2FyZCAobGVmdCBvciB1cCkgYW5kIHRoZSB2YWx1ZSBpcyBzbWFsbGVyIHRoYW4gdGhlIGdvYWwKICAgICAgICAgIGlmICgoKGRpcmVjdGlvbiA9PSAncmlnaHQnIHx8IGRpcmVjdGlvbiA9PSAnZG93bicpICYmIG1hcFtheGlzXSA+IGdvYWwpIHx8ICgoZGlyZWN0aW9uID09ICdsZWZ0JyB8fCBkaXJlY3Rpb24gPT0gJ3VwJykgJiYgbWFwW2F4aXNdIDwgZ29hbCkpIHsKCgogICAgICAgICAgICAvLyBObyBwcmV2aW91cyB2YWx1ZSBzZXQgb3IgaWYgdGhlIGN1cnJlbnQKICAgICAgICAgICAgLy8gdmFsdWUgaXMgc21hbGxlciB0aGFuIHRoZSBwcmV2aW91cyBvbmUJCQkJCSAKICAgICAgICAgICAgaWYgKCFjbG9zZXN0TWFwIHx8IE1hdGguYWJzKG1hcFtheGlzXSAtIGdvYWwpIDwgTWF0aC5hYnMoY2xvc2VzdE1hcFtheGlzXSkpIHsKICAgICAgICAgICAgICBjbG9zZXN0SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICBjbG9zZXN0TWFwID0gbWFwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIHJldHVybiBpbmRleAogICAgICByZXR1cm4gY2xvc2VzdEluZGV4OwogICAgfSwKCgogICAgLyogSGVscGVyIHRvIGdldCB0aGUgZnVydGhlc3QgZmxvb3IgaW4gb25lIHByZWNpc2UgZGlyZWN0aW9uIGRpcmVjdGlvbiAqLwogICAgX2dldEZ1cnRoZXN0Rmxvb3JJbmRleDogZnVuY3Rpb24oREEsIGZsb29ySW5kZXgsIGRpcmVjdGlvbiwgbGV2ZWwpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgbGV2ZWwgPSBsZXZlbCB8fCAwOwoKICAgICAgLy8gR2V0IGF4aXMgJiBjb21wYXJlLXRvIGZsb29ySW5kZXgKICAgICAgdmFyIGF4aXMgPSB0aGlzLl9nZXRBeGlzRnJvbURpcmVjdGlvbihkaXJlY3Rpb24pOwogICAgICB2YXIgZ29hbCA9IERBW2Zsb29ySW5kZXhdW2F4aXNdOwogICAgICB2YXIgb3Bwb3NpdGVBeGlzID0gKGF4aXMgPT0gdGhpcy5BWElTX1kpID8gdGhpcy5BWElTX1ggOiB0aGlzLkFYSVNfWTsKCiAgICAgIC8vIFNldHVwIGxvb3AgdmFyaWFibGUKICAgICAgdmFyIGZ1cnRoZXN0TWFwID0gZmFsc2U7CiAgICAgIHZhciBmdXJ0aGVzdEluZGV4ID0gZmFsc2U7CgogICAgICAvLyBMb29wIHRyb3VnaCBmbG9vciBwb3NpdGlvbiBhcnJheQogICAgICAkLmVhY2goREEsIGZ1bmN0aW9uKGluZGV4LCBtYXApIHsKCiAgICAgICAgLy8gSWYgb24gc2FtZSBheGlzCiAgICAgICAgaWYgKG1hcFtvcHBvc2l0ZUF4aXNdID09IChEQVtmbG9vckluZGV4XVtvcHBvc2l0ZUF4aXNdICsgbGV2ZWwpKSB7CgogICAgICAgICAgLy8gSWYgb24gc2FtZSBheGlzCiAgICAgICAgICBpZiAoIWZ1cnRoZXN0TWFwIHx8IChNYXRoLmFicyhtYXBbYXhpc10gLSBnb2FsKSA+IE1hdGguYWJzKGZ1cnRoZXN0TWFwW2F4aXNdIC0gZ29hbCkpKSB7CiAgICAgICAgICAgIGZ1cnRoZXN0TWFwID0gbWFwOwogICAgICAgICAgICBmdXJ0aGVzdEluZGV4ID0gaW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIHJldHVybiBpbmRleAogICAgICByZXR1cm4gZnVydGhlc3RJbmRleDsKCiAgICB9LAoKICAgIC8qIFVzZSB0byBhY2Nlc3MgcXVpY2tseSBsYXRlciwgYXZvaWRpbmcgbG9vcGluZyB0aHJvdWdoIGV2ZXJ5IGRpcmVjdGlvbiBldmVyeSB0aW1lICovCiAgICBfZ2VuZXJhdGVGbG9vck1hcDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIHRoaXMuZmxvb3JNYXAgPSBbXTsKCiAgICAgIC8vIENyZWF0ZSBtYXAgb25seSBmb3IgZmxvb3IgcHJlc2VudCBpbiB0aGUgZG9tCiAgICAgIHZhciBEQSA9IGpRdWVyeS5ncmVwKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24sIGZ1bmN0aW9uKGRpcmVjdGlvbkFycmF5LCBpbmRleCkgewogICAgICAgIHJldHVybiBzZWxmLm5vZGVDaGlsZHJlbi5sZW5ndGggPiBpbmRleDsKICAgICAgfSk7CgogICAgICAvLyBMb29wIG9uIHRoZSBkaXJhdGlvbiBhcnJheSBhbmQgZ2V0IAogICAgICAvLyB0aGUgZmxvb3IgSUQgZm9yIGVhY2ggZGlyZWN0aW9uCiAgICAgICQuZWFjaChEQSwgZnVuY3Rpb24oaW5kZXgsIGZsb29ySXRlbSkgewogICAgICAgIHNlbGYuZmxvb3JNYXBbaW5kZXhdID0gewogICAgICAgICAgJ2Rvd24nOiBzZWxmLl9nZXREaXJlY3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2Rvd24nKSwKICAgICAgICAgICd1cCc6IHNlbGYuX2dldERpcmVjdEZsb29ySW5kZXgoREEsIGluZGV4LCAndXAnKSwKICAgICAgICAgICdyaWdodCc6IHNlbGYuX2dldERpcmVjdEZsb29ySW5kZXgoREEsIGluZGV4LCAncmlnaHQnKSwKICAgICAgICAgICdsZWZ0Jzogc2VsZi5fZ2V0RGlyZWN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdsZWZ0JyksCiAgICAgICAgICAnaW5jcmVtZW50JzogewogICAgICAgICAgICAnZG93bic6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdkb3duJywgMSksCiAgICAgICAgICAgICd1cCc6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICd1cCcsIC0xKSwKICAgICAgICAgICAgJ3JpZ2h0Jzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3JpZ2h0JywgMSksCiAgICAgICAgICAgICdsZWZ0Jzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2xlZnQnLCAtMSkKICAgICAgICAgIH0sCiAgICAgICAgICAnY2xvc2VzdCc6IHsKICAgICAgICAgICAgJ2Rvd24nOiBzZWxmLl9nZXRDbG9zZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdkb3duJyksCiAgICAgICAgICAgICd1cCc6IHNlbGYuX2dldENsb3Nlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3VwJyksCiAgICAgICAgICAgICdyaWdodCc6IHNlbGYuX2dldENsb3Nlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3JpZ2h0JyksCiAgICAgICAgICAgICdsZWZ0Jzogc2VsZi5fZ2V0Q2xvc2VzdEZsb29ySW5kZXgoREEsIGluZGV4LCAnbGVmdCcpCiAgICAgICAgICB9LAogICAgICAgICAgJ2Z1cnRoZXN0JzogewogICAgICAgICAgICAnZG93bic6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdkb3duJyksCiAgICAgICAgICAgICd1cCc6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICd1cCcpLAogICAgICAgICAgICAncmlnaHQnOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAncmlnaHQnKSwKICAgICAgICAgICAgJ2xlZnQnOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAnbGVmdCcpCiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfSk7CgogICAgICBmdW5jdGlvbiBnZXRGdXJ0aGVyRmxvb3JBcnJheShmbG9vckFycmF5LCBheGlzKSB7CiAgICAgICAgdmFyIGZ1cnRoZXJGbG9vciA9IGZhbHNlOwogICAgICAgIGpRdWVyeS5lYWNoKGZsb29yQXJyYXksIGZ1bmN0aW9uKGluZGV4LCBEQSkgewogICAgICAgICAgaWYgKGZ1cnRoZXJGbG9vciA9PT0gZmFsc2UgfHwgZnVydGhlckZsb29yW2F4aXNdIDwgREFbYXhpc10pIHsKICAgICAgICAgICAgZnVydGhlckZsb29yID0gREE7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGZ1cnRoZXJGbG9vcjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEZsb29yT25BeGlzKGZsb29yQXJyYXksIGF4aXMpIHsKICAgICAgICB2YXIgZnVydGhlckZsb29yID0gZmFsc2U7CiAgICAgICAgalF1ZXJ5LmVhY2goZmxvb3JBcnJheSwgZnVuY3Rpb24oaW5kZXgsIERBKSB7CiAgICAgICAgICBpZiAoZnVydGhlckZsb29yID09PSBmYWxzZSB8fCBmdXJ0aGVyRmxvb3JbYXhpc10gPiBEQVtheGlzXSkgewogICAgICAgICAgICBmdXJ0aGVyRmxvb3IgPSBEQTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZnVydGhlckZsb29yOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRTYW1lQXhpc0Zsb29yKGZsb29ySXRlbSwgYXhpcykgewogICAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChEQSwgZnVuY3Rpb24oREEpIHsKICAgICAgICAgIHZhciBpc09uU2FtZUF4aXMgPSBEQVtheGlzXSA9PSBmbG9vckl0ZW1bYXhpc107CiAgICAgICAgICByZXR1cm4gaXNPblNhbWVBeGlzOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgYXBwcm94aW1hdGVGdXJ0aGVyWCA9IGdldEZ1cnRoZXJGbG9vckFycmF5KERBLCBzZWxmLkFYSVNfWCk7CiAgICAgIHZhciBzYW1lQXhpc1hGdXJ0aGVzdCA9IGdldFNhbWVBeGlzRmxvb3IoYXBwcm94aW1hdGVGdXJ0aGVyWCwgc2VsZi5BWElTX1gpOwogICAgICB2YXIgZnVydGhlclkgPSBnZXRGdXJ0aGVyRmxvb3JBcnJheShzYW1lQXhpc1hGdXJ0aGVzdCwgc2VsZi5BWElTX1kpOwoKICAgICAgdmFyIGFwcHJveGltYXRlRnVydGhlclkgPSBnZXRGdXJ0aGVyRmxvb3JBcnJheShEQSwgc2VsZi5BWElTX1kpOwogICAgICB2YXIgc2FtZUF4aXNZRnVydGhlc3QgPSBnZXRTYW1lQXhpc0Zsb29yKGFwcHJveGltYXRlRnVydGhlclksIHNlbGYuQVhJU19ZKTsKICAgICAgdmFyIGZ1cnRoZXJYID0gZ2V0RnVydGhlckZsb29yQXJyYXkoc2FtZUF4aXNZRnVydGhlc3QsIHNlbGYuQVhJU19YKTsKCiAgICAgIHNlbGYuZmxvb3JNYXAuZnVydGhlc3RfeCA9IERBLmluZGV4T2YoZnVydGhlclgpOwogICAgICBzZWxmLmZsb29yTWFwLmZ1cnRoZXN0X3kgPSBEQS5pbmRleE9mKGZ1cnRoZXJZKTsKCiAgICAgIHZhciBhcHByb3hpbWF0ZUNsb3Nlc3RYID0gZ2V0Q2xvc2VzdEZsb29yT25BeGlzKERBLCBzZWxmLkFYSVNfWCk7CiAgICAgIHZhciBzYW1lQXhpc1hDbG9zZXN0ID0gZ2V0U2FtZUF4aXNGbG9vcihhcHByb3hpbWF0ZUNsb3Nlc3RYLCBzZWxmLkFYSVNfWCk7CiAgICAgIHZhciBjbG9zZXN0WSA9IGdldENsb3Nlc3RGbG9vck9uQXhpcyhzYW1lQXhpc1hDbG9zZXN0LCBzZWxmLkFYSVNfWSk7CgogICAgICB2YXIgYXBwcm94aW1hdGVDbG9zZXN0WSA9IGdldENsb3Nlc3RGbG9vck9uQXhpcyhEQSwgc2VsZi5BWElTX1kpOwogICAgICB2YXIgc2FtZUF4aXNZQ2xvc2VzdCA9IGdldFNhbWVBeGlzRmxvb3IoYXBwcm94aW1hdGVDbG9zZXN0WSwgc2VsZi5BWElTX1kpOwogICAgICB2YXIgY2xvc2VzdFggPSBnZXRDbG9zZXN0Rmxvb3JPbkF4aXMoc2FtZUF4aXNZQ2xvc2VzdCwgc2VsZi5BWElTX1gpOwoKICAgICAgc2VsZi5mbG9vck1hcC5jbG9zZXN0X3ggPSBEQS5pbmRleE9mKGNsb3Nlc3RYKTsKICAgICAgc2VsZi5mbG9vck1hcC5jbG9zZXN0X3kgPSBEQS5pbmRleE9mKGNsb3Nlc3RZKTsKCgogICAgfSwKCiAgfTsKCiAgJC5mbltwbHVnaW5OYW1lXSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgaWYgKCEkLmRhdGEodGhpcywgcGx1Z2luTmFtZSkpIHsKICAgICAgICAkLmRhdGEodGhpcywgcGx1Z2luTmFtZSwgbmV3IFBsdWdpbih0aGlzLCBvcHRpb25zKSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiB0aGlzOwogIH07Cn0pKGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 10:44:07 GMT",
                    "Content-Length": "33021",
                    "Date": "Thu, 06 Nov 2014 10:44:08 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}