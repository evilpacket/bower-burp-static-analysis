{
    "url": "http://localhost:9999/node-inspector/node-inspector/front-end/inspector.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>document.location</b> via the following statements:<ul><li>var url = window.location.href;</li><li>url = url.substring(0, url.length - queryParams.length);</li><li>document.location = url;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/node-inspector/node-inspector/front-end/inspector.js",
                "path": "/node-inspector/node-inspector/front-end/inspector.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9ub2RlLWluc3BlY3Rvci9ub2RlLWluc3BlY3Rvci9mcm9udC1lbmQvaW5zcGVjdG9yLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDQxMTANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMTk6MzU6MjEgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDE5OjM1OjE2IEdNVA0KDQovKgogKiBDb3B5cmlnaHQgKEMpIDIwMDYsIDIwMDcsIDIwMDggQXBwbGUgSW5jLiAgQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogQ29weXJpZ2h0IChDKSAyMDA3IE1hdHQgTGlsZWsgKHBld3Rlcm1vb3NlQGdtYWlsLmNvbSkuCiAqIENvcHlyaWdodCAoQykgMjAwOSBKb3NlcGggUGVjb3Jhcm8KICoKICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0CiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucwogKiBhcmUgbWV0OgogKgogKiAxLiAgUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKICogICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KICogMi4gIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0CiAqICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlCiAqICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgogKiAzLiAgTmVpdGhlciB0aGUgbmFtZSBvZiBBcHBsZSBDb21wdXRlciwgSW5jLiAoIkFwcGxlIikgbm9yIHRoZSBuYW1lcyBvZgogKiAgICAgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZAogKiAgICAgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLgogKgogKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIEFQUExFIEFORCBJVFMgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5EIEFOWQogKiBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUKICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQVBQTEUgT1IgSVRTIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWQogKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUwogKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7CiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORAogKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVAogKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YKICogVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KICovCgp2YXIgV2ViSW5zcGVjdG9yID0gewogICAgX3BhbmVsRGVzY3JpcHRvcnM6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLnBhbmVscyA9IHt9OwogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3ID0gbmV3IFdlYkluc3BlY3Rvci5JbnNwZWN0b3JWaWV3KCk7CiAgICAgICAgdmFyIHBhcmVudEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWFpbiIpOwogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LnNob3cocGFyZW50RWxlbWVudCk7CiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuSW5zcGVjdG9yVmlldy5FdmVudHMuUGFuZWxTZWxlY3RlZCwgdGhpcy5fcGFuZWxTZWxlY3RlZCwgdGhpcyk7CgogICAgICAgIHZhciBlbGVtZW50cyA9IG5ldyBXZWJJbnNwZWN0b3IuRWxlbWVudHNQYW5lbERlc2NyaXB0b3IoKTsKICAgICAgICB2YXIgcmVzb3VyY2VzID0gbmV3IFdlYkluc3BlY3Rvci5QYW5lbERlc2NyaXB0b3IoInJlc291cmNlcyIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiUmVzb3VyY2VzIiksICJSZXNvdXJjZXNQYW5lbCIsICJSZXNvdXJjZXNQYW5lbC5qcyIpOwogICAgICAgIHZhciBuZXR3b3JrID0gbmV3IFdlYkluc3BlY3Rvci5OZXR3b3JrUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgdmFyIHNjcmlwdHMgPSBuZXcgV2ViSW5zcGVjdG9yLlNjcmlwdHNQYW5lbERlc2NyaXB0b3IoKTsKICAgICAgICB2YXIgdGltZWxpbmUgPSBuZXcgV2ViSW5zcGVjdG9yLlRpbWVsaW5lUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgdmFyIHByb2ZpbGVzID0gbmV3IFdlYkluc3BlY3Rvci5Qcm9maWxlc1BhbmVsRGVzY3JpcHRvcigpOwogICAgICAgIHZhciBhdWRpdHMgPSBuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiYXVkaXRzIiwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJBdWRpdHMiKSwgIkF1ZGl0c1BhbmVsIiwgIkF1ZGl0c1BhbmVsLmpzIik7CiAgICAgICAgdmFyIGNvbnNvbGUgPSBuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiY29uc29sZSIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiQ29uc29sZSIpLCAiQ29uc29sZVBhbmVsIik7CiAgICAgICAgdmFyIGFsbERlc2NyaXB0b3JzID0gW2VsZW1lbnRzLCByZXNvdXJjZXMsIG5ldHdvcmssIHNjcmlwdHMsIHRpbWVsaW5lLCBwcm9maWxlcywgYXVkaXRzLCBjb25zb2xlXTsKICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLmV4cGVyaW1lbnRzU2V0dGluZ3MubGF5ZXJzUGFuZWwuaXNFbmFibGVkKCkpIHsKICAgICAgICAgICAgdmFyIGxheWVycyA9IG5ldyBXZWJJbnNwZWN0b3IuTGF5ZXJzUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgICAgIGFsbERlc2NyaXB0b3JzLnB1c2gobGF5ZXJzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGFsbFByb2ZpbGVycyA9IFtwcm9maWxlc107CiAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5leHBlcmltZW50c1NldHRpbmdzLmN1c3RvbWl6YWJsZVRvb2xiYXIuaXNFbmFibGVkKCkpIHsKICAgICAgICAgICAgYWxsUHJvZmlsZXJzID0gW107CiAgICAgICAgICAgIGFsbFByb2ZpbGVycy5wdXNoKG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJjcHUtcHJvZmlsZXIiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNQVSBQcm9maWxlciIpLCAiQ1BVUHJvZmlsZXJQYW5lbCIsICJQcm9maWxlc1BhbmVsLmpzIikpOwogICAgICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmlzV29ya2VyRnJvbnRlbmQoKSkKICAgICAgICAgICAgICAgIGFsbFByb2ZpbGVycy5wdXNoKG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJjc3MtcHJvZmlsZXIiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNTUyBQcm9maWxlciIpLCAiQ1NTU2VsZWN0b3JQcm9maWxlclBhbmVsIiwgIlByb2ZpbGVzUGFuZWwuanMiKSk7CiAgICAgICAgICAgIGFsbFByb2ZpbGVycy5wdXNoKG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJoZWFwLXByb2ZpbGVyIiwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJIZWFwIFByb2ZpbGVyIiksICJIZWFwUHJvZmlsZXJQYW5lbCIsICJQcm9maWxlc1BhbmVsLmpzIikpOwogICAgICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmlzV29ya2VyRnJvbnRlbmQoKSAmJiBXZWJJbnNwZWN0b3IuZXhwZXJpbWVudHNTZXR0aW5ncy5jYW52YXNJbnNwZWN0aW9uLmlzRW5hYmxlZCgpKQogICAgICAgICAgICAgICAgYWxsUHJvZmlsZXJzLnB1c2gobmV3IFdlYkluc3BlY3Rvci5QYW5lbERlc2NyaXB0b3IoImNhbnZhcy1wcm9maWxlciIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiQ2FudmFzIFByb2ZpbGVyIiksICJDYW52YXNQcm9maWxlclBhbmVsIiwgIlByb2ZpbGVzUGFuZWwuanMiKSk7CiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYmluZChhbGxEZXNjcmlwdG9ycywgYWxsRGVzY3JpcHRvcnMuaW5kZXhPZihwcm9maWxlcyksIDEpLmFwcGx5KG51bGwsIGFsbFByb2ZpbGVycyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFuZWxEZXNjcmlwdG9ycyA9IFtdOwogICAgICAgIGlmIChXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkpIHsKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycy5wdXNoKHNjcmlwdHMpOwogICAgICAgICAgICBwYW5lbERlc2NyaXB0b3JzLnB1c2godGltZWxpbmUpOwogICAgICAgICAgICBwYW5lbERlc2NyaXB0b3JzID0gcGFuZWxEZXNjcmlwdG9ycy5jb25jYXQoYWxsUHJvZmlsZXJzKTsKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycy5wdXNoKGNvbnNvbGUpOwogICAgICAgICAgICByZXR1cm4gcGFuZWxEZXNjcmlwdG9yczsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbGxEZXNjcmlwdG9ycy5sZW5ndGg7ICsraSkKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycy5wdXNoKGFsbERlc2NyaXB0b3JzW2ldKTsKICAgICAgICByZXR1cm4gcGFuZWxEZXNjcmlwdG9yczsKICAgIH0sCgogICAgX3BhbmVsU2VsZWN0ZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnNldEVuYWJsZWQoV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkubmFtZSAhPT0gImNvbnNvbGUiKTsKICAgIH0sCgogICAgX2NyZWF0ZUdsb2JhbFN0YXR1c0Jhckl0ZW1zOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGJvdHRvbVN0YXR1c0JhckNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJib3R0b20tc3RhdHVzLWJhci1jb250YWluZXIiKTsKCiAgICAgICAgLy8gQ3JlYXRlIG1haW4gZG9jayBidXR0b24gYW5kIG9wdGlvbnMuCiAgICAgICAgdmFyIG1haW5TdGF0dXNCYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWFpbi1zdGF0dXMtYmFyIik7CiAgICAgICAgbWFpblN0YXR1c0Jhci5pbnNlcnRCZWZvcmUodGhpcy5kb2NrQ29udHJvbGxlci5lbGVtZW50LCBib3R0b21TdGF0dXNCYXJDb250YWluZXIpOwoKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uID0gbmV3IFdlYkluc3BlY3Rvci5TdGF0dXNCYXJCdXR0b24oV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTaG93IGNvbnNvbGUuIiksICJjb25zb2xlLXN0YXR1cy1iYXItaXRlbSIpOwogICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uQ2xpY2tlZC5iaW5kKHRoaXMpLCBmYWxzZSk7CiAgICAgICAgbWFpblN0YXR1c0Jhci5pbnNlcnRCZWZvcmUodGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi5lbGVtZW50LCBib3R0b21TdGF0dXNCYXJDb250YWluZXIpOwoKICAgICAgICBpZiAodGhpcy5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyKQogICAgICAgICAgICBtYWluU3RhdHVzQmFyLmluc2VydEJlZm9yZSh0aGlzLmluc3BlY3RFbGVtZW50TW9kZUNvbnRyb2xsZXIudG9nZ2xlU2VhcmNoQnV0dG9uLmVsZW1lbnQsIGJvdHRvbVN0YXR1c0JhckNvbnRhaW5lcik7CgogICAgICAgIGlmIChXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3RbInJlbW90ZUZyb250ZW5kIl0gJiYgV2ViSW5zcGVjdG9yLmV4cGVyaW1lbnRzU2V0dGluZ3Muc2NyZWVuY2FzdC5pc0VuYWJsZWQoKSkgewogICAgICAgICAgICB0aGlzLl90b2dnbGVTY3JlZW5jYXN0QnV0dG9uID0gbmV3IFdlYkluc3BlY3Rvci5TdGF0dXNCYXJCdXR0b24oV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJUb2dnbGUgc2NyZWVuY2FzdC4iKSwgInNjcmVlbmNhc3Qtc3RhdHVzLWJhci1pdGVtIik7CiAgICAgICAgICAgIHRoaXMuX3RvZ2dsZVNjcmVlbmNhc3RCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLl90b2dnbGVTY3JlZW5jYXN0QnV0dG9uQ2xpY2tlZC5iaW5kKHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG1haW5TdGF0dXNCYXIuaW5zZXJ0QmVmb3JlKHRoaXMuX3RvZ2dsZVNjcmVlbmNhc3RCdXR0b24uZWxlbWVudCwgYm90dG9tU3RhdHVzQmFyQ29udGFpbmVyKTsKICAgICAgICB9CgogICAgICAgIG1haW5TdGF0dXNCYXIuYXBwZW5kQ2hpbGQodGhpcy5zZXR0aW5nc0NvbnRyb2xsZXIuc3RhdHVzQmFySXRlbSk7CiAgICB9LAoKICAgIF90b2dnbGVDb25zb2xlQnV0dG9uQ2xpY2tlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi5lbmFibGVkKCkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgdmFyIGFuaW1hdGlvblR5cGUgPSB3aW5kb3cuZXZlbnQgJiYgd2luZG93LmV2ZW50LnNoaWZ0S2V5ID8gV2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlLlNsb3cgOiBXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGUuTm9ybWFsOwoKICAgICAgICBpZiAodGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50b2dnbGVkKQogICAgICAgICAgICB0aGlzLmNsb3NlQ29uc29sZShhbmltYXRpb25UeXBlKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRoaXMuc2hvd0NvbnNvbGUoYW5pbWF0aW9uVHlwZSk7CiAgICB9LAoKICAgIF90b2dnbGVTY3JlZW5jYXN0QnV0dG9uQ2xpY2tlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3RvZ2dsZVNjcmVlbmNhc3RCdXR0b24udG9nZ2xlZCA9ICF0aGlzLl90b2dnbGVTY3JlZW5jYXN0QnV0dG9uLnRvZ2dsZWQ7CgogICAgICAgIGlmICghdGhpcy5fc2NyZWVuY2FzdFZpZXcpIHsKICAgICAgICAgICAgLy8gUmVidWlsZCB0aGUgVUkgdXBvbiBmaXJzdCBpbnZvY2F0aW9uLgogICAgICAgICAgICB0aGlzLl9zY3JlZW5jYXN0VmlldyA9IG5ldyBXZWJJbnNwZWN0b3IuU2NyZWVuY2FzdFZpZXcoKTsKICAgICAgICAgICAgdGhpcy5fc2NyZWVuY2FzdFNwbGl0VmlldyA9IG5ldyBXZWJJbnNwZWN0b3IuU3BsaXRWaWV3KHRydWUsICJzY3JlZW5jYXN0U3BsaXRWaWV3Iik7CiAgICAgICAgICAgIHRoaXMuX3NjcmVlbmNhc3RTcGxpdFZpZXcubWFya0FzUm9vdCgpOwogICAgICAgICAgICB0aGlzLl9zY3JlZW5jYXN0U3BsaXRWaWV3LnNob3coZG9jdW1lbnQuYm9keSk7CgogICAgICAgICAgICB0aGlzLl9zY3JlZW5jYXN0Vmlldy5zaG93KHRoaXMuX3NjcmVlbmNhc3RTcGxpdFZpZXcuZmlyc3RFbGVtZW50KCkpOwogICAgICAgICAgICB0aGlzLl9zY3JlZW5jYXN0U3BsaXRWaWV3LnNlY29uZEVsZW1lbnQoKS5hcHBlbmRDaGlsZChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicm9vdCIpKTsKICAgICAgICAgICAgdGhpcy5pbnNwZWN0b3JWaWV3LmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgIHRoaXMuaW5zcGVjdG9yVmlldy5zaG93KGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtYWluIikpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3RvZ2dsZVNjcmVlbmNhc3RCdXR0b24udG9nZ2xlZCkKICAgICAgICAgICAgdGhpcy5fc2NyZWVuY2FzdFNwbGl0Vmlldy5zaG93Qm90aCgpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgdGhpcy5fc2NyZWVuY2FzdFNwbGl0Vmlldy5zaG93T25seVNlY29uZCgpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gc3RhdHVzQmFyRWxlbWVudAogICAgICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuVmlld30gdmlldwogICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gb25jbG9zZQogICAgICovCiAgICBzaG93Vmlld0luRHJhd2VyOiBmdW5jdGlvbihzdGF0dXNCYXJFbGVtZW50LCB2aWV3LCBvbmNsb3NlKQogICAgewogICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlNob3cgY29uc29sZS4iKTsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRvZ2dsZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLl9yZW1vdmVEcmF3ZXJWaWV3KCk7CgogICAgICAgIHZhciBkcmF3ZXJTdGF0dXNCYXJIZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBkcmF3ZXJTdGF0dXNCYXJIZWFkZXIuY2xhc3NOYW1lID0gImRyYXdlci1oZWFkZXIgc3RhdHVzLWJhci1pdGVtIjsKICAgICAgICBkcmF3ZXJTdGF0dXNCYXJIZWFkZXIuYXBwZW5kQ2hpbGQoc3RhdHVzQmFyRWxlbWVudCk7CiAgICAgICAgZHJhd2VyU3RhdHVzQmFySGVhZGVyLm9uY2xvc2UgPSBvbmNsb3NlOwoKICAgICAgICB2YXIgY2xvc2VCdXR0b24gPSBkcmF3ZXJTdGF0dXNCYXJIZWFkZXIuY3JlYXRlQ2hpbGQoImRpdiIsICJjbG9zZS1idXR0b24iKTsKICAgICAgICBjbG9zZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuY2xvc2VWaWV3SW5EcmF3ZXIuYmluZCh0aGlzKSwgZmFsc2UpOwoKICAgICAgICB2YXIgcGFuZWxTdGF0dXNCYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGFuZWwtc3RhdHVzLWJhciIpOwogICAgICAgIHZhciBkcmF3ZXJWaWV3QW5jaG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRyYXdlci12aWV3LWFuY2hvciIpOwogICAgICAgIHBhbmVsU3RhdHVzQmFyLmluc2VydEJlZm9yZShkcmF3ZXJTdGF0dXNCYXJIZWFkZXIsIGRyYXdlclZpZXdBbmNob3IpOwogICAgICAgIHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlciA9IGRyYXdlclN0YXR1c0JhckhlYWRlcjsKICAgICAgICB0aGlzLmRyYXdlci5zaG93KHZpZXcsIFdlYkluc3BlY3Rvci5EcmF3ZXIuQW5pbWF0aW9uVHlwZS5JbW1lZGlhdGVseSk7CiAgICB9LAoKICAgIGNsb3NlVmlld0luRHJhd2VyOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlcikgewogICAgICAgICAgICB0aGlzLl9yZW1vdmVEcmF3ZXJWaWV3KCk7CgogICAgICAgICAgICAvLyBPbmNlIGRyYXdlciBpcyBjbG9zZWQgY29uc29sZSBzaG91bGQgYmUgc2hvd24gaWYgaXQgd2FzIHNob3duIGJlZm9yZSBjdXJyZW50IHZpZXcgcmVwbGFjZWQgaXQgaW4gZHJhd2VyLiAKICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnNvbGVXYXNTaG93bikKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0NvbnNvbGUoKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhpcy5kcmF3ZXIuaGlkZShXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGUuSW1tZWRpYXRlbHkpOwogICAgICAgIH0KICAgIH0sCgogICAgX3JlbW92ZURyYXdlclZpZXc6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBpZiAodGhpcy5fZHJhd2VyU3RhdHVzQmFySGVhZGVyKSB7CiAgICAgICAgICAgIHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlci5yZW1vdmUoKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlci5vbmNsb3NlKQogICAgICAgICAgICAgICAgdGhpcy5fZHJhd2VyU3RhdHVzQmFySGVhZGVyLm9uY2xvc2UoKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlcjsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGU9fSBhbmltYXRpb25UeXBlCiAgICAgKi8KICAgIHNob3dDb25zb2xlOiBmdW5jdGlvbihhbmltYXRpb25UeXBlKQogICAgewogICAgICAgIGFuaW1hdGlvblR5cGUgPSBhbmltYXRpb25UeXBlIHx8IFdlYkluc3BlY3Rvci5EcmF3ZXIuQW5pbWF0aW9uVHlwZS5Ob3JtYWw7CgogICAgICAgIGlmICh0aGlzLmNvbnNvbGVWaWV3LmlzU2hvd2luZygpICYmICFXZWJJbnNwZWN0b3IuZHJhd2VyLmlzSGlkaW5nKCkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5kcmF3ZXIudmlzaWJsZSkKICAgICAgICAgICAgdGhpcy5fcmVtb3ZlRHJhd2VyVmlldygpOwoKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRvZ2dsZWQgPSB0cnVlOwogICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkhpZGUgY29uc29sZS4iKTsKICAgICAgICB0aGlzLmRyYXdlci5zaG93KHRoaXMuY29uc29sZVZpZXcsIGFuaW1hdGlvblR5cGUpOwogICAgICAgIHRoaXMuX2NvbnNvbGVXYXNTaG93biA9IHRydWU7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGU9fSBhbmltYXRpb25UeXBlCiAgICAgKi8KICAgIGNsb3NlQ29uc29sZTogZnVuY3Rpb24oYW5pbWF0aW9uVHlwZSkKICAgIHsKICAgICAgICBhbmltYXRpb25UeXBlID0gYW5pbWF0aW9uVHlwZSB8fCBXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGUuTm9ybWFsOwoKICAgICAgICBpZiAoIXRoaXMuY29uc29sZVZpZXcuaXNTaG93aW5nKCkgfHwgIVdlYkluc3BlY3Rvci5kcmF3ZXIudmlzaWJsZSkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRvZ2dsZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTaG93IGNvbnNvbGUuIik7CiAgICAgICAgdGhpcy5kcmF3ZXIuaGlkZShhbmltYXRpb25UeXBlKTsKICAgICAgICB0aGlzLl9jb25zb2xlV2FzU2hvd24gPSBmYWxzZTsKICAgIH0sCgogICAgX3Jlc2V0RXJyb3JBbmRXYXJuaW5nQ291bnRzOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGVycm9yV2FybmluZ0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZXJyb3Itd2FybmluZy1jb3VudCIpOwogICAgICAgIGlmICghZXJyb3JXYXJuaW5nRWxlbWVudCkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LmFkZFN0eWxlQ2xhc3MoImhpZGRlbiIpOwogICAgfSwKCiAgICBfdXBkYXRlRXJyb3JBbmRXYXJuaW5nQ291bnRzOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGVycm9ycyA9IFdlYkluc3BlY3Rvci5jb25zb2xlLmVycm9yczsKICAgICAgICB2YXIgd2FybmluZ3MgPSBXZWJJbnNwZWN0b3IuY29uc29sZS53YXJuaW5nczsKCiAgICAgICAgaWYgKCFlcnJvcnMgJiYgIXdhcm5pbmdzKSB7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0RXJyb3JBbmRXYXJuaW5nQ291bnRzKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBlcnJvcldhcm5pbmdFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVycm9yLXdhcm5pbmctY291bnQiKTsKICAgICAgICBpZiAoIWVycm9yV2FybmluZ0VsZW1lbnQpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5yZW1vdmVTdHlsZUNsYXNzKCJoaWRkZW4iKTsKCiAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5yZW1vdmVDaGlsZHJlbigpOwoKICAgICAgICBpZiAoZXJyb3JzKSB7CiAgICAgICAgICAgIHZhciBlcnJvckltYWdlRWxlbWVudCA9IGVycm9yV2FybmluZ0VsZW1lbnQuY3JlYXRlQ2hpbGQoImRpdiIsICJlcnJvci1pY29uLXNtYWxsIik7CiAgICAgICAgICAgIHZhciBlcnJvckVsZW1lbnQgPSBlcnJvcldhcm5pbmdFbGVtZW50LmNyZWF0ZUNoaWxkKCJzcGFuIik7CiAgICAgICAgICAgIGVycm9yRWxlbWVudC5pZCA9ICJlcnJvci1jb3VudCI7CiAgICAgICAgICAgIGVycm9yRWxlbWVudC50ZXh0Q29udGVudCA9IGVycm9yczsKICAgICAgICB9CgogICAgICAgIGlmICh3YXJuaW5ncykgewogICAgICAgICAgICB2YXIgd2FybmluZ3NJbWFnZUVsZW1lbnQgPSBlcnJvcldhcm5pbmdFbGVtZW50LmNyZWF0ZUNoaWxkKCJkaXYiLCAid2FybmluZy1pY29uLXNtYWxsIik7CiAgICAgICAgICAgIHZhciB3YXJuaW5nc0VsZW1lbnQgPSBlcnJvcldhcm5pbmdFbGVtZW50LmNyZWF0ZUNoaWxkKCJzcGFuIik7CiAgICAgICAgICAgIHdhcm5pbmdzRWxlbWVudC5pZCA9ICJ3YXJuaW5nLWNvdW50IjsKICAgICAgICAgICAgd2FybmluZ3NFbGVtZW50LnRleHRDb250ZW50ID0gd2FybmluZ3M7CiAgICAgICAgfQoKICAgICAgICBpZiAoZXJyb3JzKSB7CiAgICAgICAgICAgIGlmICh3YXJuaW5ncykgewogICAgICAgICAgICAgICAgaWYgKGVycm9ycyA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzID09IDEpCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIGVycm9yLCAlZCB3YXJuaW5nIiwgZXJyb3JzLCB3YXJuaW5ncyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvciwgJWQgd2FybmluZ3MiLCBlcnJvcnMsIHdhcm5pbmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAod2FybmluZ3MgPT0gMSkKICAgICAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvcnMsICVkIHdhcm5pbmciLCBlcnJvcnMsIHdhcm5pbmdzKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvcnMsICVkIHdhcm5pbmdzIiwgZXJyb3JzLCB3YXJuaW5ncyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JzID09IDEpCiAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvciIsIGVycm9ycyk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIGVycm9ycyIsIGVycm9ycyk7CiAgICAgICAgfSBlbHNlIGlmICh3YXJuaW5ncyA9PSAxKQogICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCB3YXJuaW5nIiwgd2FybmluZ3MpOwogICAgICAgIGVsc2UgaWYgKHdhcm5pbmdzKQogICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCB3YXJuaW5ncyIsIHdhcm5pbmdzKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBudWxsOwogICAgfSwKCiAgICBnZXQgaW5zcGVjdGVkUGFnZURvbWFpbigpCiAgICB7CiAgICAgICAgdmFyIHBhcnNlZFVSTCA9IFdlYkluc3BlY3Rvci5pbnNwZWN0ZWRQYWdlVVJMICYmIFdlYkluc3BlY3Rvci5pbnNwZWN0ZWRQYWdlVVJMLmFzUGFyc2VkVVJMKCk7CiAgICAgICAgcmV0dXJuIHBhcnNlZFVSTCA/IHBhcnNlZFVSTC5ob3N0IDogIiI7CiAgICB9LAoKICAgIF9pbml0aWFsaXplQ2FwYWJpbGl0eTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGVycm9yLCByZXN1bHQpCiAgICB7CiAgICAgICAgQ2FwYWJpbGl0aWVzW25hbWVdID0gcmVzdWx0OwogICAgICAgIGlmIChjYWxsYmFjaykKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgIH0sCgogICAgX3pvb21JbjogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3pvb21MZXZlbCA9IE1hdGgubWluKHRoaXMuX3pvb21MZXZlbCArIDEsIFdlYkluc3BlY3Rvci5ab29tLlRhYmxlLmxlbmd0aCAtIFdlYkluc3BlY3Rvci5ab29tLkRlZmF1bHRPZmZzZXQgLSAxKTsKICAgICAgICB0aGlzLl9yZXF1ZXN0Wm9vbSgpOwogICAgfSwKCiAgICBfem9vbU91dDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3pvb21MZXZlbCA9IE1hdGgubWF4KHRoaXMuX3pvb21MZXZlbCAtIDEsIC1XZWJJbnNwZWN0b3IuWm9vbS5EZWZhdWx0T2Zmc2V0KTsKICAgICAgICB0aGlzLl9yZXF1ZXN0Wm9vbSgpOwogICAgfSwKCiAgICBfcmVzZXRab29tOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fem9vbUxldmVsID0gMDsKICAgICAgICB0aGlzLl9yZXF1ZXN0Wm9vbSgpOwogICAgfSwKCiAgICBfcmVxdWVzdFpvb206IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBXZWJJbnNwZWN0b3Iuc2V0dGluZ3Muem9vbUxldmVsLnNldCh0aGlzLl96b29tTGV2ZWwpOwogICAgICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgem9vbUxldmVsIHRha2VzIGludGVnZXJzICh3aXRoIDAgYmVpbmcgZGVmYXVsdCB6b29tKS4KICAgICAgICB2YXIgaW5kZXggPSB0aGlzLl96b29tTGV2ZWwgKyBXZWJJbnNwZWN0b3IuWm9vbS5EZWZhdWx0T2Zmc2V0OwogICAgICAgIGluZGV4ID0gTWF0aC5taW4oV2ViSW5zcGVjdG9yLlpvb20uVGFibGUubGVuZ3RoIC0gMSwgaW5kZXgpOwogICAgICAgIGluZGV4ID0gTWF0aC5tYXgoMCwgaW5kZXgpOwogICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5zZXRab29tRmFjdG9yKFdlYkluc3BlY3Rvci5ab29tLlRhYmxlW2luZGV4XSk7CiAgICB9LAoKICAgIF9kZWJ1Z2dlclBhdXNlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIC8vIENyZWF0ZSBzY3JpcHRzIHBhbmVsIHVwb24gZGVtYW5kLgogICAgICAgIFdlYkluc3BlY3Rvci5wYW5lbCgic2NyaXB0cyIpOwogICAgfQp9CgpXZWJJbnNwZWN0b3IuRXZlbnRzID0gewogICAgSW5zcGVjdG9yTG9hZGVkOiAiSW5zcGVjdG9yTG9hZGVkIiwKICAgIEluc3BlY3RvckNsb3Npbmc6ICJJbnNwZWN0b3JDbG9zaW5nIgp9Cgp7KGZ1bmN0aW9uIHBhcnNlUXVlcnlQYXJhbWV0ZXJzKCkKewogICAgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0ID0ge307CiAgICB2YXIgcXVlcnlQYXJhbXMgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoOwogICAgaWYgKCFxdWVyeVBhcmFtcykKICAgICAgICByZXR1cm47CiAgICB2YXIgcGFyYW1zID0gcXVlcnlQYXJhbXMuc3Vic3RyaW5nKDEpLnNwbGl0KCImIik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBwYWlyID0gcGFyYW1zW2ldLnNwbGl0KCI9Iik7CiAgICAgICAgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0W3BhaXJbMF1dID0gcGFpclsxXTsKICAgIH0KfSkoKTt9CgpXZWJJbnNwZWN0b3Iuc3VnZ2VzdFJlbG9hZCA9IGZ1bmN0aW9uKCkKewogICAgaWYgKHdpbmRvdy5jb25maXJtKFdlYkluc3BlY3Rvci5VSVN0cmluZygiSXQgaXMgcmVjb21tZW5kZWQgdG8gcmVzdGFydCBpbnNwZWN0b3IgYWZ0ZXIgbWFraW5nIHRoZXNlIGNoYW5nZXMuIFdvdWxkIHlvdSBsaWtlIHRvIHJlc3RhcnQgaXQ/IikpKQogICAgICAgIHRoaXMucmVsb2FkKCk7Cn0KCldlYkluc3BlY3Rvci5yZWxvYWQgPSBmdW5jdGlvbigpCnsKICAgIEluc3BlY3RvckFnZW50LnJlc2V0KCk7CgogICAgdmFyIHF1ZXJ5UGFyYW1zID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaDsKICAgIHZhciB1cmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgIHVybCA9IHVybC5zdWJzdHJpbmcoMCwgdXJsLmxlbmd0aCAtIHF1ZXJ5UGFyYW1zLmxlbmd0aCk7CiAgICB2YXIgcXVlcnlQYXJhbXNPYmplY3QgPSB7fTsKICAgIGZvciAodmFyIG5hbWUgaW4gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0KQogICAgICAgIHF1ZXJ5UGFyYW1zT2JqZWN0W25hbWVdID0gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0W25hbWVdOwogICAgaWYgKHRoaXMuZG9ja0NvbnRyb2xsZXIpCiAgICAgICAgcXVlcnlQYXJhbXNPYmplY3RbImRvY2tTaWRlIl0gPSB0aGlzLmRvY2tDb250cm9sbGVyLmRvY2tTaWRlKCk7CiAgICB2YXIgbmFtZXMgPSBPYmplY3Qua2V5cyhxdWVyeVBhcmFtc09iamVjdCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgKytpKQogICAgICAgIHVybCArPSAoaSA/ICImIiA6ICI/IikgKyBuYW1lc1tpXSArICI9IiArIHF1ZXJ5UGFyYW1zT2JqZWN0W25hbWVzW2ldXTsKICAgIGRvY3VtZW50LmxvY2F0aW9uID0gdXJsOwp9CgpXZWJJbnNwZWN0b3IubG9hZGVkID0gZnVuY3Rpb24oKQp7CiAgICBJbnNwZWN0b3JCYWNrZW5kLmxvYWRGcm9tSlNPTklmTmVlZGVkKCIuLi9wcm90b2NvbC5qc29uIik7CiAgICBXZWJJbnNwZWN0b3IuZG9ja0NvbnRyb2xsZXIgPSBuZXcgV2ViSW5zcGVjdG9yLkRvY2tDb250cm9sbGVyKCk7CgogICAgaWYgKFdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmlzRGVkaWNhdGVkV29ya2VyRnJvbnRlbmQoKSkgewogICAgICAgIC8vIERvIG5vdCBjcmVhdGUgc29ja2V0IGZvciB0aGUgd29ya2VyIGZyb250LWVuZC4KICAgICAgICBXZWJJbnNwZWN0b3IuZG9Mb2FkZWREb25lKCk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB3czsKICAgIGlmICgid3MiIGluIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdCkKICAgICAgICB3cyA9ICJ3czovLyIgKyBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3Qud3M7CiAgICBlbHNlIGlmICgicGFnZSIgaW4gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0KSB7CiAgICAgICAgdmFyIHBhZ2UgPSBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QucGFnZTsKICAgICAgICB2YXIgaG9zdCA9ICJob3N0IiBpbiBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QgPyBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QuaG9zdCA6IHdpbmRvdy5sb2NhdGlvbi5ob3N0OwogICAgICAgIHdzID0gIndzOi8vIiArIGhvc3QgKyAiL2RldnRvb2xzL3BhZ2UvIiArIHBhZ2U7CiAgICB9CgogICAgaWYgKHdzKSB7CiAgICAgICAgV2ViSW5zcGVjdG9yLnNvY2tldCA9IG5ldyBXZWJTb2NrZXQod3MpOwogICAgICAgIFdlYkluc3BlY3Rvci5zb2NrZXQub25tZXNzYWdlID0gZnVuY3Rpb24obWVzc2FnZSkgeyBJbnNwZWN0b3JCYWNrZW5kLmRpc3BhdGNoKG1lc3NhZ2UuZGF0YSk7IH0KICAgICAgICBXZWJJbnNwZWN0b3Iuc29ja2V0Lm9uZXJyb3IgPSBmdW5jdGlvbihlcnJvcikgeyBjb25zb2xlLmVycm9yKGVycm9yKTsgfQogICAgICAgIFdlYkluc3BlY3Rvci5zb2NrZXQub25vcGVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5zZW5kTWVzc2FnZVRvQmFja2VuZCA9IFdlYkluc3BlY3Rvci5zb2NrZXQuc2VuZC5iaW5kKFdlYkluc3BlY3Rvci5zb2NrZXQpOwogICAgICAgICAgICBXZWJJbnNwZWN0b3IuZG9Mb2FkZWREb25lKCk7CiAgICAgICAgfQogICAgICAgIFdlYkluc3BlY3Rvci5zb2NrZXQub25jbG9zZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5zb2NrZXQuX2RldGFjaFJlYXNvbikKICAgICAgICAgICAgICAgIChuZXcgV2ViSW5zcGVjdG9yLlJlbW90ZURlYnVnZ2luZ1Rlcm1pbmF0ZWRTY3JlZW4oIndlYnNvY2tldF9jbG9zZWQiKSkuc2hvd01vZGFsKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBXZWJJbnNwZWN0b3IuZG9Mb2FkZWREb25lKCk7CgogICAgLy8gSW4gY2FzZSBvZiBsb2FkaW5nIGFzIGEgd2ViIHBhZ2Ugd2l0aCBubyBiaW5kaW5ncyAvIGhhcm5lc3MsIGtpY2sgb2ZmIGluaXRpYWxpemF0aW9uIG1hbnVhbGx5LgogICAgaWYgKEluc3BlY3RvckZyb250ZW5kSG9zdC5pc1N0dWIpIHsKICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEFQSS5kaXNwYXRjaFF1ZXJ5UGFyYW1ldGVycygpOwogICAgICAgIFdlYkluc3BlY3Rvci5fZG9Mb2FkZWREb25lV2l0aENhcGFiaWxpdGllcygpOwogICAgfQp9CgpXZWJJbnNwZWN0b3IuZG9Mb2FkZWREb25lID0gZnVuY3Rpb24oKQp7CiAgICAvLyBJbnN0YWxsIHN0eWxlcyBhbmQgdGhlbWVzCiAgICBXZWJJbnNwZWN0b3IuaW5zdGFsbFBvcnRTdHlsZXMoKTsKICAgIGlmIChXZWJJbnNwZWN0b3Iuc29ja2V0KQogICAgICAgIGRvY3VtZW50LmJvZHkuYWRkU3R5bGVDbGFzcygicmVtb3RlIik7CgogICAgaWYgKFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdC50b29sYmFyQ29sb3IgJiYgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LnRleHRDb2xvcikKICAgICAgICBXZWJJbnNwZWN0b3Iuc2V0VG9vbGJhckNvbG9ycyhXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QudG9vbGJhckNvbG9yLCBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QudGV4dENvbG9yKTsKCiAgICBXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5sb2FkZWQoKTsKCiAgICBXb3JrZXJBZ2VudC5jYW5JbnNwZWN0V29ya2VycyhXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiY2FuSW5zcGVjdFdvcmtlcnMiLCBXZWJJbnNwZWN0b3IuX2RvTG9hZGVkRG9uZVdpdGhDYXBhYmlsaXRpZXMuYmluZChXZWJJbnNwZWN0b3IpKSk7Cn0KCldlYkluc3BlY3Rvci5fZG9Mb2FkZWREb25lV2l0aENhcGFiaWxpdGllcyA9IGZ1bmN0aW9uKCkKewogICAgbmV3IFdlYkluc3BlY3Rvci5WZXJzaW9uQ29udHJvbGxlcigpLnVwZGF0ZVZlcnNpb24oKTsKCiAgICBXZWJJbnNwZWN0b3Iuc2hvcnRjdXRzU2NyZWVuID0gbmV3IFdlYkluc3BlY3Rvci5TaG9ydGN1dHNTY3JlZW4oKTsKICAgIHRoaXMuX3JlZ2lzdGVyU2hvcnRjdXRzKCk7CgogICAgLy8gc2V0IG9yZGVyIG9mIHNvbWUgc2VjdGlvbnMgZXhwbGljaXRseQogICAgV2ViSW5zcGVjdG9yLnNob3J0Y3V0c1NjcmVlbi5zZWN0aW9uKFdlYkluc3BlY3Rvci5VSVN0cmluZygiQ29uc29sZSIpKTsKICAgIFdlYkluc3BlY3Rvci5zaG9ydGN1dHNTY3JlZW4uc2VjdGlvbihXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkVsZW1lbnRzIFBhbmVsIikpOwoKICAgIHZhciBwYW5lbERlc2NyaXB0b3JzID0gdGhpcy5fcGFuZWxEZXNjcmlwdG9ycygpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYW5lbERlc2NyaXB0b3JzLmxlbmd0aDsgKytpKQogICAgICAgIHBhbmVsRGVzY3JpcHRvcnNbaV0ucmVnaXN0ZXJTaG9ydGN1dHMoKTsKCiAgICB0aGlzLmNvbnNvbGUgPSBuZXcgV2ViSW5zcGVjdG9yLkNvbnNvbGVNb2RlbCgpOwogICAgdGhpcy5jb25zb2xlLmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkNvbnNvbGVNb2RlbC5FdmVudHMuQ29uc29sZUNsZWFyZWQsIHRoaXMuX3Jlc2V0RXJyb3JBbmRXYXJuaW5nQ291bnRzLCB0aGlzKTsKICAgIHRoaXMuY29uc29sZS5hZGRFdmVudExpc3RlbmVyKFdlYkluc3BlY3Rvci5Db25zb2xlTW9kZWwuRXZlbnRzLk1lc3NhZ2VBZGRlZCwgdGhpcy5fdXBkYXRlRXJyb3JBbmRXYXJuaW5nQ291bnRzLCB0aGlzKTsKICAgIHRoaXMuY29uc29sZS5hZGRFdmVudExpc3RlbmVyKFdlYkluc3BlY3Rvci5Db25zb2xlTW9kZWwuRXZlbnRzLlJlcGVhdENvdW50VXBkYXRlZCwgdGhpcy5fdXBkYXRlRXJyb3JBbmRXYXJuaW5nQ291bnRzLCB0aGlzKTsKCiAgICBXZWJJbnNwZWN0b3IuQ1NTTWV0YWRhdGEucmVxdWVzdENTU1Nob3J0aGFuZERhdGEoKTsKCiAgICB0aGlzLmRyYXdlciA9IG5ldyBXZWJJbnNwZWN0b3IuRHJhd2VyKCk7CgogICAgdGhpcy5uZXR3b3JrTWFuYWdlciA9IG5ldyBXZWJJbnNwZWN0b3IuTmV0d29ya01hbmFnZXIoKTsKICAgIHRoaXMucmVzb3VyY2VUcmVlTW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLlJlc291cmNlVHJlZU1vZGVsKHRoaXMubmV0d29ya01hbmFnZXIpOwogICAgdGhpcy5kZWJ1Z2dlck1vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5EZWJ1Z2dlck1vZGVsKCk7CiAgICB0aGlzLmRlYnVnZ2VyTW9kZWwuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuRGVidWdnZXJNb2RlbC5FdmVudHMuRGVidWdnZXJQYXVzZWQsIHRoaXMuX2RlYnVnZ2VyUGF1c2VkLCB0aGlzKTsKICAgIHRoaXMubmV0d29ya0xvZyA9IG5ldyBXZWJJbnNwZWN0b3IuTmV0d29ya0xvZygpOwogICAgdGhpcy5kb21BZ2VudCA9IG5ldyBXZWJJbnNwZWN0b3IuRE9NQWdlbnQoKTsKICAgIHRoaXMuZG9tQWdlbnQuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuRE9NQWdlbnQuRXZlbnRzLkluc3BlY3ROb2RlUmVxdWVzdGVkLCB0aGlzLl9pbnNwZWN0Tm9kZVJlcXVlc3RlZCwgdGhpcyk7CiAgICB0aGlzLnJ1bnRpbWVNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuUnVudGltZU1vZGVsKHRoaXMucmVzb3VyY2VUcmVlTW9kZWwpOwoKICAgIHRoaXMuY29uc29sZVZpZXcgPSBuZXcgV2ViSW5zcGVjdG9yLkNvbnNvbGVWaWV3KFdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmlzV29ya2VyRnJvbnRlbmQoKSk7CgogICAgSW5zcGVjdG9yQmFja2VuZC5yZWdpc3Rlckluc3BlY3RvckRpc3BhdGNoZXIodGhpcyk7CgogICAgdGhpcy5pc29sYXRlZEZpbGVTeXN0ZW1NYW5hZ2VyID0gbmV3IFdlYkluc3BlY3Rvci5Jc29sYXRlZEZpbGVTeXN0ZW1NYW5hZ2VyKCk7CiAgICB0aGlzLmlzb2xhdGVkRmlsZVN5c3RlbURpc3BhdGNoZXIgPSBuZXcgV2ViSW5zcGVjdG9yLklzb2xhdGVkRmlsZVN5c3RlbURpc3BhdGNoZXIodGhpcy5pc29sYXRlZEZpbGVTeXN0ZW1NYW5hZ2VyKTsKICAgIHRoaXMud29ya3NwYWNlID0gbmV3IFdlYkluc3BlY3Rvci5Xb3Jrc3BhY2UodGhpcy5pc29sYXRlZEZpbGVTeXN0ZW1NYW5hZ2VyLm1hcHBpbmcoKSk7CgogICAgdGhpcy5jc3NNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbCh0aGlzLndvcmtzcGFjZSk7CiAgICB0aGlzLnRpbWVsaW5lTWFuYWdlciA9IG5ldyBXZWJJbnNwZWN0b3IuVGltZWxpbmVNYW5hZ2VyKCk7CiAgICB0aGlzLnRyYWNpbmdBZ2VudCA9IG5ldyBXZWJJbnNwZWN0b3IuVHJhY2luZ0FnZW50KCk7CiAgICB0aGlzLm92ZXJyaWRlc1N1cHBvcnQgPSBuZXcgV2ViSW5zcGVjdG9yLk92ZXJyaWRlc1N1cHBvcnQoKTsKCiAgICB0aGlzLnNlYXJjaENvbnRyb2xsZXIgPSBuZXcgV2ViSW5zcGVjdG9yLlNlYXJjaENvbnRyb2xsZXIoKTsKICAgIHRoaXMuYWR2YW5jZWRTZWFyY2hDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5BZHZhbmNlZFNlYXJjaENvbnRyb2xsZXIoKTsKICAgIGlmICghV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIuaXNXb3JrZXJGcm9udGVuZCgpKQogICAgICAgIHRoaXMuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlciA9IG5ldyBXZWJJbnNwZWN0b3IuSW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlcigpOwoKICAgIHRoaXMuc2V0dGluZ3NDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5TZXR0aW5nc0NvbnRyb2xsZXIoKTsKCiAgICB0aGlzLmRvbUJyZWFrcG9pbnRzU2lkZWJhclBhbmUgPSBuZXcgV2ViSW5zcGVjdG9yLkRPTUJyZWFrcG9pbnRzU2lkZWJhclBhbmUoKTsKCiAgICB0aGlzLl96b29tTGV2ZWwgPSBXZWJJbnNwZWN0b3Iuc2V0dGluZ3Muem9vbUxldmVsLmdldCgpOwogICAgaWYgKHRoaXMuX3pvb21MZXZlbCkKICAgICAgICB0aGlzLl9yZXF1ZXN0Wm9vbSgpOwoKICAgIHZhciBhdXRvc2VsZWN0UGFuZWwgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoImEgcGFuZWwgY2hvc2VuIGF1dG9tYXRpY2FsbHkiKTsKICAgIHZhciBvcGVuQW5jaG9yTG9jYXRpb25TZXR0aW5nID0gV2ViSW5zcGVjdG9yLnNldHRpbmdzLmNyZWF0ZVNldHRpbmcoIm9wZW5MaW5rSGFuZGxlciIsIGF1dG9zZWxlY3RQYW5lbCk7CiAgICB0aGlzLm9wZW5BbmNob3JMb2NhdGlvblJlZ2lzdHJ5ID0gbmV3IFdlYkluc3BlY3Rvci5IYW5kbGVyUmVnaXN0cnkob3BlbkFuY2hvckxvY2F0aW9uU2V0dGluZyk7CiAgICB0aGlzLm9wZW5BbmNob3JMb2NhdGlvblJlZ2lzdHJ5LnJlZ2lzdGVySGFuZGxlcihhdXRvc2VsZWN0UGFuZWwsIGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0pOwoKICAgIHRoaXMud29ya3NwYWNlQ29udHJvbGxlciA9IG5ldyBXZWJJbnNwZWN0b3IuV29ya3NwYWNlQ29udHJvbGxlcih0aGlzLndvcmtzcGFjZSk7CgogICAgdGhpcy5maWxlU3lzdGVtV29ya3NwYWNlUHJvdmlkZXIgPSBuZXcgV2ViSW5zcGVjdG9yLkZpbGVTeXN0ZW1Xb3Jrc3BhY2VQcm92aWRlcih0aGlzLmlzb2xhdGVkRmlsZVN5c3RlbU1hbmFnZXIsIHRoaXMud29ya3NwYWNlKTsKCiAgICB0aGlzLm5ldHdvcmtXb3Jrc3BhY2VQcm92aWRlciA9IG5ldyBXZWJJbnNwZWN0b3IuU2ltcGxlV29ya3NwYWNlUHJvdmlkZXIodGhpcy53b3Jrc3BhY2UsIFdlYkluc3BlY3Rvci5wcm9qZWN0VHlwZXMuTmV0d29yayk7CiAgICBuZXcgV2ViSW5zcGVjdG9yLk5ldHdvcmtVSVNvdXJjZUNvZGVQcm92aWRlcih0aGlzLm5ldHdvcmtXb3Jrc3BhY2VQcm92aWRlciwgdGhpcy53b3Jrc3BhY2UpOwoKICAgIHRoaXMuYnJlYWtwb2ludE1hbmFnZXIgPSBuZXcgV2ViSW5zcGVjdG9yLkJyZWFrcG9pbnRNYW5hZ2VyKFdlYkluc3BlY3Rvci5zZXR0aW5ncy5icmVha3BvaW50cywgdGhpcy5kZWJ1Z2dlck1vZGVsLCB0aGlzLndvcmtzcGFjZSk7CgogICAgdGhpcy5zY3JpcHRTbmlwcGV0TW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLlNjcmlwdFNuaXBwZXRNb2RlbCh0aGlzLndvcmtzcGFjZSk7CgogICAgbmV3IFdlYkluc3BlY3Rvci5EZWJ1Z2dlclNjcmlwdE1hcHBpbmcodGhpcy53b3Jrc3BhY2UsIHRoaXMubmV0d29ya1dvcmtzcGFjZVByb3ZpZGVyKTsKICAgIHRoaXMubGl2ZUVkaXRTdXBwb3J0ID0gbmV3IFdlYkluc3BlY3Rvci5MaXZlRWRpdFN1cHBvcnQodGhpcy53b3Jrc3BhY2UpOwogICAgdGhpcy5zdHlsZUNvbnRlbnRCaW5kaW5nID0gbmV3IFdlYkluc3BlY3Rvci5TdHlsZUNvbnRlbnRCaW5kaW5nKHRoaXMuY3NzTW9kZWwsIHRoaXMud29ya3NwYWNlKTsKICAgIG5ldyBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldE1hcHBpbmcodGhpcy5jc3NNb2RlbCwgdGhpcy53b3Jrc3BhY2UsIHRoaXMubmV0d29ya1dvcmtzcGFjZVByb3ZpZGVyKTsKICAgIG5ldyBXZWJJbnNwZWN0b3IuUHJlc2VudGF0aW9uQ29uc29sZU1lc3NhZ2VIZWxwZXIodGhpcy53b3Jrc3BhY2UpOwoKICAgIHRoaXMuX2NyZWF0ZUdsb2JhbFN0YXR1c0Jhckl0ZW1zKCk7CgogICAgdGhpcy50b29sYmFyID0gbmV3IFdlYkluc3BlY3Rvci5Ub29sYmFyKCk7CiAgICBXZWJJbnNwZWN0b3Iuc3RhcnRCYXRjaFVwZGF0ZSgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYW5lbERlc2NyaXB0b3JzLmxlbmd0aDsgKytpKQogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmFkZFBhbmVsKHBhbmVsRGVzY3JpcHRvcnNbaV0pOwogICAgV2ViSW5zcGVjdG9yLmVuZEJhdGNoVXBkYXRlKCk7CgogICAgdGhpcy5hZGRNYWluRXZlbnRMaXN0ZW5lcnMoZG9jdW1lbnQpOwoKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCB0aGlzLndpbmRvd1Jlc2l6ZS5iaW5kKHRoaXMpLCB0cnVlKTsKCiAgICB2YXIgZXJyb3JXYXJuaW5nQ291bnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZXJyb3Itd2FybmluZy1jb3VudCIpOwogICAgZXJyb3JXYXJuaW5nQ291bnQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLnNob3dDb25zb2xlLmJpbmQodGhpcyksIGZhbHNlKTsKICAgIHRoaXMuX3VwZGF0ZUVycm9yQW5kV2FybmluZ0NvdW50cygpOwoKICAgIHRoaXMuZXh0ZW5zaW9uU2VydmVyLmluaXRFeHRlbnNpb25zKCk7CgogICAgdGhpcy5jb25zb2xlLmVuYWJsZUFnZW50KCk7CgogICAgZnVuY3Rpb24gc2hvd0luaXRpYWxQYW5lbCgpCiAgICB7CiAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKSkKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLnNob3dQYW5lbChXZWJJbnNwZWN0b3Iuc2V0dGluZ3MubGFzdEFjdGl2ZVBhbmVsLmdldCgpKTsKICAgIH0KCiAgICBJbnNwZWN0b3JBZ2VudC5lbmFibGUoc2hvd0luaXRpYWxQYW5lbCk7CiAgICB0aGlzLmRhdGFiYXNlTW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLkRhdGFiYXNlTW9kZWwoKTsKICAgIHRoaXMuZG9tU3RvcmFnZU1vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5ET01TdG9yYWdlTW9kZWwoKTsKCiAgICBQcm9maWxlckFnZW50LmVuYWJsZSgpOwoKICAgIFdlYkluc3BlY3Rvci5zZXR0aW5ncy5mb3JjZUNvbXBvc2l0aW5nTW9kZSA9IFdlYkluc3BlY3Rvci5zZXR0aW5ncy5jcmVhdGVCYWNrZW5kU2V0dGluZygiZm9yY2VDb21wb3NpdGluZ01vZGUiLCBmYWxzZSwgUGFnZUFnZW50LnNldEZvcmNlQ29tcG9zaXRpbmdNb2RlLmJpbmQoUGFnZUFnZW50KSk7CiAgICBXZWJJbnNwZWN0b3Iuc2V0dGluZ3Muc2hvd1BhaW50UmVjdHMgPSBXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuY3JlYXRlQmFja2VuZFNldHRpbmcoInNob3dQYWludFJlY3RzIiwgZmFsc2UsIFBhZ2VBZ2VudC5zZXRTaG93UGFpbnRSZWN0cy5iaW5kKFBhZ2VBZ2VudCkpOwogICAgV2ViSW5zcGVjdG9yLnNldHRpbmdzLnNob3dEZWJ1Z0JvcmRlcnMgPSBXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuY3JlYXRlQmFja2VuZFNldHRpbmcoInNob3dEZWJ1Z0JvcmRlcnMiLCBmYWxzZSwgUGFnZUFnZW50LnNldFNob3dEZWJ1Z0JvcmRlcnMuYmluZChQYWdlQWdlbnQpKTsKICAgIFdlYkluc3BlY3Rvci5zZXR0aW5ncy5jb250aW51b3VzUGFpbnRpbmcgPSBXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuY3JlYXRlQmFja2VuZFNldHRpbmcoImNvbnRpbnVvdXNQYWludGluZyIsIGZhbHNlLCBQYWdlQWdlbnQuc2V0Q29udGludW91c1BhaW50aW5nRW5hYmxlZC5iaW5kKFBhZ2VBZ2VudCkpOwogICAgV2ViSW5zcGVjdG9yLnNldHRpbmdzLnNob3dGUFNDb3VudGVyID0gV2ViSW5zcGVjdG9yLnNldHRpbmdzLmNyZWF0ZUJhY2tlbmRTZXR0aW5nKCJzaG93RlBTQ291bnRlciIsIGZhbHNlLCBQYWdlQWdlbnQuc2V0U2hvd0ZQU0NvdW50ZXIuYmluZChQYWdlQWdlbnQpKTsKICAgIFdlYkluc3BlY3Rvci5zZXR0aW5ncy5zaG93U2Nyb2xsQm90dGxlbmVja1JlY3RzID0gV2ViSW5zcGVjdG9yLnNldHRpbmdzLmNyZWF0ZUJhY2tlbmRTZXR0aW5nKCJzaG93U2Nyb2xsQm90dGxlbmVja1JlY3RzIiwgZmFsc2UsIFBhZ2VBZ2VudC5zZXRTaG93U2Nyb2xsQm90dGxlbmVja1JlY3RzLmJpbmQoUGFnZUFnZW50KSk7CgogICAgV2ViSW5zcGVjdG9yLnNldHRpbmdzLnNob3dNZXRyaWNzUnVsZXJzLmFkZENoYW5nZUxpc3RlbmVyKHNob3dSdWxlcnNDaGFuZ2VkKTsKICAgIGZ1bmN0aW9uIHNob3dSdWxlcnNDaGFuZ2VkKCkKICAgIHsKICAgICAgICBQYWdlQWdlbnQuc2V0U2hvd1ZpZXdwb3J0U2l6ZU9uUmVzaXplKHRydWUsIFdlYkluc3BlY3Rvci5zZXR0aW5ncy5zaG93TWV0cmljc1J1bGVycy5nZXQoKSk7CiAgICB9CiAgICBzaG93UnVsZXJzQ2hhbmdlZCgpOwoKICAgIFdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmxvYWRDb21wbGV0ZWQoKTsKICAgIEluc3BlY3RvckZyb250ZW5kQVBJLmxvYWRDb21wbGV0ZWQoKTsKCiAgICBXZWJJbnNwZWN0b3Iubm90aWZpY2F0aW9ucy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkV2ZW50cy5JbnNwZWN0b3JMb2FkZWQpOwp9Cgp2YXIgd2luZG93TG9hZGVkID0gZnVuY3Rpb24oKQp7CiAgICBXZWJJbnNwZWN0b3IubG9hZGVkKCk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIHdpbmRvd0xvYWRlZCwgZmFsc2UpOwogICAgZGVsZXRlIHdpbmRvd0xvYWRlZDsKfTsKCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgd2luZG93TG9hZGVkLCBmYWxzZSk7CgovLyBXZSdkIGxpa2UgdG8gZW5mb3JjZSBhc3luY2hyb25vdXMgaW50ZXJhY3Rpb24gYmV0d2VlbiB0aGUgaW5zcGVjdG9yIGNvbnRyb2xsZXIgYW5kIHRoZSBmcm9udGVuZC4KLy8gSXQgaXMgbmVlZGVkIHRvIHByZXZlbnQgcmUtZW50ZXJpbmcgdGhlIGJhY2tlbmQgY29kZS4KLy8gQWxzbywgbmF0aXZlIGRpc3BhdGNoZXMgZG8gbm90IGd1YXJhbnRlZSBzZXRUaW1lb3V0cyB0byBiZSBzZXJpYWxpemVkLCBzbyB3ZQovLyBlbmZvcmNlIHNlcmlhbGl6YXRpb24gdXNpbmcgJ21lc3NhZ2VzVG9EaXNwYXRjaCcgcXVldWUuIEl0IGlzIGFsc28gaW1wb3J0YW50IHRoYXQgSlNDIGRlYnVnZ2VyCi8vIHRlc3RzIHJlcXVpcmUgdGhhdCBlYWNoIGNvbW1hbmQgd2FzIGRpc3BhdGNoIHdpdGhpbiBpbmRpdmlkdWFsIHRpbWVvdXQgY2FsbGJhY2ssIHNvIHdlIGRvbid0IGJhdGNoIHRoZW0uCgp2YXIgbWVzc2FnZXNUb0Rpc3BhdGNoID0gW107CgpXZWJJbnNwZWN0b3IuZGlzcGF0Y2hRdWV1ZUlzRW1wdHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBtZXNzYWdlc1RvRGlzcGF0Y2gubGVuZ3RoID09IDA7Cn0KCldlYkluc3BlY3Rvci5kaXNwYXRjaCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgIG1lc3NhZ2VzVG9EaXNwYXRjaC5wdXNoKG1lc3NhZ2UpOwogICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBJbnNwZWN0b3JCYWNrZW5kLmRpc3BhdGNoKG1lc3NhZ2VzVG9EaXNwYXRjaC5zaGlmdCgpKTsKICAgIH0sIDApOwp9CgpXZWJJbnNwZWN0b3Iud2luZG93UmVzaXplID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldykKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5kb1Jlc2l6ZSgpOwogICAgaWYgKFdlYkluc3BlY3Rvci5kcmF3ZXIpCiAgICAgICAgV2ViSW5zcGVjdG9yLmRyYXdlci5yZXNpemUoKTsKICAgIGlmIChXZWJJbnNwZWN0b3IudG9vbGJhcikKICAgICAgICBXZWJJbnNwZWN0b3IudG9vbGJhci5yZXNpemUoKTsKICAgIGlmIChXZWJJbnNwZWN0b3Iuc2V0dGluZ3NDb250cm9sbGVyKQogICAgICAgIFdlYkluc3BlY3Rvci5zZXR0aW5nc0NvbnRyb2xsZXIucmVzaXplKCk7CiAgICBpZiAoV2ViSW5zcGVjdG9yLl9zY3JlZW5jYXN0U3BsaXRWaWV3KQogICAgICAgIFdlYkluc3BlY3Rvci5fc2NyZWVuY2FzdFNwbGl0Vmlldy5kb1Jlc2l6ZSgpOwp9CgpXZWJJbnNwZWN0b3Iuc2V0RG9ja2luZ1VuYXZhaWxhYmxlID0gZnVuY3Rpb24odW5hdmFpbGFibGUpCnsKICAgIGlmICh0aGlzLmRvY2tDb250cm9sbGVyKQogICAgICAgIHRoaXMuZG9ja0NvbnRyb2xsZXIuc2V0RG9ja2luZ1VuYXZhaWxhYmxlKHVuYXZhaWxhYmxlKTsKfQoKV2ViSW5zcGVjdG9yLmNsb3NlID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmICh0aGlzLl9pc0Nsb3NpbmcpCiAgICAgICAgcmV0dXJuOwogICAgdGhpcy5faXNDbG9zaW5nID0gdHJ1ZTsKICAgIHRoaXMubm90aWZpY2F0aW9ucy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkV2ZW50cy5JbnNwZWN0b3JDbG9zaW5nKTsKICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5jbG9zZVdpbmRvdygpOwp9CgpXZWJJbnNwZWN0b3IuZG9jdW1lbnRDbGljayA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICB2YXIgYW5jaG9yID0gZXZlbnQudGFyZ2V0LmVuY2xvc2luZ05vZGVPclNlbGZXaXRoTm9kZU5hbWUoImEiKTsKICAgIGlmICghYW5jaG9yIHx8IChhbmNob3IudGFyZ2V0ID09PSAiX2JsYW5rIikpCiAgICAgICAgcmV0dXJuOwoKICAgIC8vIFByZXZlbnQgdGhlIGxpbmsgZnJvbSBuYXZpZ2F0aW5nLCBzaW5jZSB3ZSBkb24ndCBkbyBhbnkgbmF2aWdhdGlvbiBieSBmb2xsb3dpbmcgbGlua3Mgbm9ybWFsbHkuCiAgICBldmVudC5jb25zdW1lKHRydWUpOwoKICAgIGZ1bmN0aW9uIGZvbGxvd0xpbmsoKQogICAgewogICAgICAgIGlmIChXZWJJbnNwZWN0b3IuaXNCZWluZ0VkaXRlZChldmVudC50YXJnZXQpKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5vcGVuQW5jaG9yTG9jYXRpb25SZWdpc3RyeS5kaXNwYXRjaCh7IHVybDogYW5jaG9yLmhyZWYsIGxpbmVOdW1iZXI6IGFuY2hvci5saW5lTnVtYmVyfSkpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLnNob3dBbmNob3JMb2NhdGlvbihhbmNob3IpKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGNvbnN0IHByb2ZpbGVNYXRjaCA9IFdlYkluc3BlY3Rvci5Qcm9maWxlc1BhbmVsRGVzY3JpcHRvci5Qcm9maWxlVVJMUmVnRXhwLmV4ZWMoYW5jaG9yLmhyZWYpOwogICAgICAgIGlmIChwcm9maWxlTWF0Y2gpIHsKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLnNob3dQYW5lbCgicHJvZmlsZXMiKS5zaG93UHJvZmlsZShwcm9maWxlTWF0Y2hbMV0sIHByb2ZpbGVNYXRjaFsyXSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBwYXJzZWRVUkwgPSBhbmNob3IuaHJlZi5hc1BhcnNlZFVSTCgpOwogICAgICAgIGlmIChwYXJzZWRVUkwgJiYgcGFyc2VkVVJMLnNjaGVtZSA9PT0gIndlYmtpdC1saW5rLWFjdGlvbiIpIHsKICAgICAgICAgICAgaWYgKHBhcnNlZFVSTC5ob3N0ID09PSAic2hvdy1wYW5lbCIpIHsKICAgICAgICAgICAgICAgIHZhciBwYW5lbCA9IHBhcnNlZFVSTC5wYXRoLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgIGlmIChXZWJJbnNwZWN0b3IucGFuZWwocGFuZWwpKQogICAgICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwocGFuZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5vcGVuSW5OZXdUYWIoYW5jaG9yLmhyZWYpOwogICAgfQoKICAgIGlmIChXZWJJbnNwZWN0b3IuZm9sbG93TGlua1RpbWVvdXQpCiAgICAgICAgY2xlYXJUaW1lb3V0KFdlYkluc3BlY3Rvci5mb2xsb3dMaW5rVGltZW91dCk7CgogICAgaWYgKGFuY2hvci5wcmV2ZW50Rm9sbG93T25Eb3VibGVDbGljaykgewogICAgICAgIC8vIFN0YXJ0IGEgdGltZW91dCBpZiB0aGlzIGlzIHRoZSBmaXJzdCBjbGljaywgaWYgdGhlIHRpbWVvdXQgaXMgY2FuY2VsZWQKICAgICAgICAvLyBiZWZvcmUgaXQgZmlyZXMsIHRoZW4gYSBkb3VibGUgY2xpY2tlZCBoYXBwZW5lZCBvciBhbm90aGVyIGxpbmsgd2FzIGNsaWNrZWQuCiAgICAgICAgaWYgKGV2ZW50LmRldGFpbCA9PT0gMSkKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmZvbGxvd0xpbmtUaW1lb3V0ID0gc2V0VGltZW91dChmb2xsb3dMaW5rLCAzMzMpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBmb2xsb3dMaW5rKCk7Cn0KCldlYkluc3BlY3Rvci5vcGVuUmVzb3VyY2UgPSBmdW5jdGlvbihyZXNvdXJjZVVSTCwgaW5SZXNvdXJjZXNQYW5lbCkKewogICAgdmFyIHJlc291cmNlID0gV2ViSW5zcGVjdG9yLnJlc291cmNlRm9yVVJMKHJlc291cmNlVVJMKTsKICAgIGlmIChpblJlc291cmNlc1BhbmVsICYmIHJlc291cmNlKQogICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoInJlc291cmNlcyIpLnNob3dSZXNvdXJjZShyZXNvdXJjZSk7CiAgICBlbHNlCiAgICAgICAgSW5zcGVjdG9yRnJvbnRlbmRIb3N0Lm9wZW5Jbk5ld1RhYihyZXNvdXJjZVVSTCk7Cn0KCldlYkluc3BlY3Rvci5fcmVnaXN0ZXJTaG9ydGN1dHMgPSBmdW5jdGlvbigpCnsKICAgIHZhciBzaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0OwogICAgdmFyIHNlY3Rpb24gPSBXZWJJbnNwZWN0b3Iuc2hvcnRjdXRzU2NyZWVuLnNlY3Rpb24oV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJBbGwgUGFuZWxzIikpOwogICAgdmFyIGtleXMgPSBbCiAgICAgICAgc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoIlsiLCBzaG9ydGN1dC5Nb2RpZmllcnMuQ3RybE9yTWV0YSksCiAgICAgICAgc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoIl0iLCBzaG9ydGN1dC5Nb2RpZmllcnMuQ3RybE9yTWV0YSkKICAgIF07CiAgICBzZWN0aW9uLmFkZFJlbGF0ZWRLZXlzKGtleXMsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiR28gdG8gdGhlIHBhbmVsIHRvIHRoZSBsZWZ0L3JpZ2h0IikpOwoKICAgIGtleXMgPSBbCiAgICAgICAgc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoIlsiLCBzaG9ydGN1dC5Nb2RpZmllcnMuQ3RybE9yTWV0YSB8IHNob3J0Y3V0Lk1vZGlmaWVycy5BbHQpLAogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJdIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEgfCBzaG9ydGN1dC5Nb2RpZmllcnMuQWx0KQogICAgXTsKICAgIHNlY3Rpb24uYWRkUmVsYXRlZEtleXMoa2V5cywgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJHbyBiYWNrL2ZvcndhcmQgaW4gcGFuZWwgaGlzdG9yeSIpKTsKCiAgICB2YXIgdG9nZ2xlQ29uc29sZUxhYmVsID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJUb2dnbGUgY29uc29sZSIpOwogICAgaWYgKFdlYkluc3BlY3Rvci5leHBlcmltZW50c1NldHRpbmdzLm9wZW5Db25zb2xlV2l0aEN0cmxUaWxkZS5pc0VuYWJsZWQoKSkKICAgICAgICBzZWN0aW9uLmFkZEtleShzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcihzaG9ydGN1dC5LZXlzLkVzYyksIHRvZ2dsZUNvbnNvbGVMYWJlbCk7CiAgICBlbHNlCiAgICAgICAgc2VjdGlvbi5hZGRLZXkoc2hvcnRjdXQubWFrZURlc2NyaXB0b3Ioc2hvcnRjdXQuS2V5cy5UaWxkZSwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpLCB0b2dnbGVDb25zb2xlTGFiZWwpOwogICAgc2VjdGlvbi5hZGRLZXkoc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoImYiLCBzaG9ydGN1dC5Nb2RpZmllcnMuQ3RybE9yTWV0YSksIFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2VhcmNoIikpOwoKICAgIHZhciBhZHZhbmNlZFNlYXJjaFNob3J0Y3V0ID0gV2ViSW5zcGVjdG9yLkFkdmFuY2VkU2VhcmNoQ29udHJvbGxlci5jcmVhdGVTaG9ydGN1dCgpOwogICAgc2VjdGlvbi5hZGRLZXkoYWR2YW5jZWRTZWFyY2hTaG9ydGN1dCwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTZWFyY2ggYWNyb3NzIGFsbCBzb3VyY2VzIikpOwoKICAgIHZhciBpbnNwZWN0RWxlbWVudE1vZGVTaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5JbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLmNyZWF0ZVNob3J0Y3V0KCk7CiAgICBzZWN0aW9uLmFkZEtleShpbnNwZWN0RWxlbWVudE1vZGVTaG9ydGN1dCwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTZWxlY3Qgbm9kZSB0byBpbnNwZWN0IikpOwoKICAgIHZhciBvcGVuUmVzb3VyY2VTaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJvIiwgV2ViSW5zcGVjdG9yLktleWJvYXJkU2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpOwogICAgc2VjdGlvbi5hZGRLZXkob3BlblJlc291cmNlU2hvcnRjdXQsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiR28gdG8gc291cmNlIikpOwoKICAgIGlmIChXZWJJbnNwZWN0b3IuaXNNYWMoKSkgewogICAgICAgIGtleXMgPSBbCiAgICAgICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJnIiwgc2hvcnRjdXQuTW9kaWZpZXJzLk1ldGEpLAogICAgICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiZyIsIHNob3J0Y3V0Lk1vZGlmaWVycy5NZXRhIHwgc2hvcnRjdXQuTW9kaWZpZXJzLlNoaWZ0KQogICAgICAgIF07CiAgICAgICAgc2VjdGlvbi5hZGRSZWxhdGVkS2V5cyhrZXlzLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkZpbmQgbmV4dC9wcmV2aW91cyIpKTsKICAgIH0KCiAgICB2YXIgZ29Ub1Nob3J0Y3V0ID0gV2ViSW5zcGVjdG9yLkdvVG9MaW5lRGlhbG9nLmNyZWF0ZVNob3J0Y3V0KCk7CiAgICBzZWN0aW9uLmFkZEtleShnb1RvU2hvcnRjdXQsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiR28gdG8gbGluZSIpKTsKCiAgICBrZXlzID0gWwogICAgICAgIHNob3J0Y3V0LktleXMuRjEsCiAgICAgICAgc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoIj8iKQogICAgXTsKICAgIHNlY3Rpb24uYWRkQWx0ZXJuYXRlS2V5cyhrZXlzLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlNob3cgZ2VuZXJhbCBzZXR0aW5ncyIpKTsKfQoKLyoqCiAqIEBwYXJhbSB7S2V5Ym9hcmRFdmVudH0gZXZlbnQKICovCldlYkluc3BlY3Rvci5kb2N1bWVudEtleURvd24gPSBmdW5jdGlvbihldmVudCkKewogICAgaWYgKFdlYkluc3BlY3Rvci5jdXJyZW50Rm9jdXNFbGVtZW50KCkgJiYgV2ViSW5zcGVjdG9yLmN1cnJlbnRGb2N1c0VsZW1lbnQoKS5oYW5kbGVLZXlFdmVudCkgewogICAgICAgIFdlYkluc3BlY3Rvci5jdXJyZW50Rm9jdXNFbGVtZW50KCkuaGFuZGxlS2V5RXZlbnQoZXZlbnQpOwogICAgICAgIGlmIChldmVudC5oYW5kbGVkKSB7CiAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgaWYgKFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpKSB7CiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkuaGFuZGxlU2hvcnRjdXQoZXZlbnQpOwogICAgICAgIGlmIChldmVudC5oYW5kbGVkKSB7CiAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgaWYgKFdlYkluc3BlY3Rvci5zZWFyY2hDb250cm9sbGVyLmhhbmRsZVNob3J0Y3V0KGV2ZW50KSkKICAgICAgICByZXR1cm47CiAgICBpZiAoV2ViSW5zcGVjdG9yLmFkdmFuY2VkU2VhcmNoQ29udHJvbGxlci5oYW5kbGVTaG9ydGN1dChldmVudCkpCiAgICAgICAgcmV0dXJuOwogICAgaWYgKFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyICYmIFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLmhhbmRsZVNob3J0Y3V0KGV2ZW50KSkKICAgICAgICByZXR1cm47CgogICAgc3dpdGNoIChldmVudC5rZXlJZGVudGlmaWVyKSB7CiAgICAgICAgY2FzZSAiVSswMDRGIjogLy8gTyBrZXkKICAgICAgICBjYXNlICJVKzAwNTAiOiAvLyBQIGtleQogICAgICAgICAgICBpZiAoIWV2ZW50LnNoaWZ0S2V5ICYmICFldmVudC5hbHRLZXkgJiYgV2ViSW5zcGVjdG9yLktleWJvYXJkU2hvcnRjdXQuZXZlbnRIYXNDdHJsT3JNZXRhKGV2ZW50KSkgewogICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLnNob3dQYW5lbCgic2NyaXB0cyIpLnNob3dHb1RvU291cmNlRGlhbG9nKCk7CiAgICAgICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIlUrMDA1MiI6IC8vIFIga2V5CiAgICAgICAgICAgIGlmIChXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dC5ldmVudEhhc0N0cmxPck1ldGEoZXZlbnQpKSB7CiAgICAgICAgICAgICAgICBEZWJ1Z2dlckFnZW50LnNldFNraXBBbGxQYXVzZXModHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBQYWdlQWdlbnQucmVsb2FkKGV2ZW50LnNoaWZ0S2V5KTsKICAgICAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5ERUJVRyAmJiBldmVudC5hbHRLZXkpIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5yZWxvYWQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJGNSI6CiAgICAgICAgICAgIGlmICghV2ViSW5zcGVjdG9yLmlzTWFjKCkpIHsKICAgICAgICAgICAgICAgIFBhZ2VBZ2VudC5yZWxvYWQoZXZlbnQuY3RybEtleSB8fCBldmVudC5zaGlmdEtleSk7CiAgICAgICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBpc1ZhbGlkWm9vbVNob3J0Y3V0ID0gV2ViSW5zcGVjdG9yLktleWJvYXJkU2hvcnRjdXQuZXZlbnRIYXNDdHJsT3JNZXRhKGV2ZW50KSAmJgogICAgICAgICFldmVudC5hbHRLZXkgJiYKICAgICAgICAhSW5zcGVjdG9yRnJvbnRlbmRIb3N0LmlzU3R1YjsKICAgIHN3aXRjaCAoZXZlbnQua2V5Q29kZSkgewogICAgICAgIGNhc2UgMTA3OiAvLyArCiAgICAgICAgY2FzZSAxODc6IC8vICsKICAgICAgICAgICAgaWYgKGlzVmFsaWRab29tU2hvcnRjdXQpIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5fem9vbUluKCk7CiAgICAgICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMTA5OiAvLyAtCiAgICAgICAgY2FzZSAxODk6IC8vIC0KICAgICAgICAgICAgaWYgKGlzVmFsaWRab29tU2hvcnRjdXQpIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5fem9vbU91dCgpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDQ4OiAvLyAwCiAgICAgICAgICAgIC8vIFpvb20gcmVzZXQgc2hvcnRjdXQgZG9lcyBub3QgYWxsb3cgIlNoaWZ0IiB3aGVuIGhhbmRsZWQgYnkgdGhlIGJyb3dzZXIuCiAgICAgICAgICAgIGlmIChpc1ZhbGlkWm9vbVNob3J0Y3V0ICYmICFldmVudC5zaGlmdEtleSkgewogICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLl9yZXNldFpvb20oKTsKICAgICAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICB9Cn0KCldlYkluc3BlY3Rvci5wb3N0RG9jdW1lbnRLZXlEb3duID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGNvbnN0IGhlbHBLZXkgPSBXZWJJbnNwZWN0b3IuaXNNYWMoKSA/ICJVKzAwM0YiIDogIlUrMDBCRiI7IC8vICI/IiBmb3IgYm90aCBwbGF0Zm9ybXMKCiAgICBpZiAoZXZlbnQua2V5SWRlbnRpZmllciA9PT0gIkYxIiB8fAogICAgICAgIChldmVudC5rZXlJZGVudGlmaWVyID09PSBoZWxwS2V5ICYmIGV2ZW50LnNoaWZ0S2V5ICYmICghV2ViSW5zcGVjdG9yLmlzQmVpbmdFZGl0ZWQoZXZlbnQudGFyZ2V0KSB8fCBldmVudC5tZXRhS2V5KSkpIHsKICAgICAgICB0aGlzLnNldHRpbmdzQ29udHJvbGxlci5zaG93U2V0dGluZ3NTY3JlZW4oV2ViSW5zcGVjdG9yLlNldHRpbmdzU2NyZWVuLlRhYnMuR2VuZXJhbCk7CiAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgRXNjID0gIlUrMDAxQiI7CgogICAgaWYgKGV2ZW50LmhhbmRsZWQpCiAgICAgICAgcmV0dXJuOwoKICAgIHZhciBvcGVuQ29uc29sZVdpdGhDdHJsVGlsZGVFbmFibGVkID0gV2ViSW5zcGVjdG9yLmV4cGVyaW1lbnRzU2V0dGluZ3Mub3BlbkNvbnNvbGVXaXRoQ3RybFRpbGRlLmlzRW5hYmxlZCgpOwogICAgaWYgKGV2ZW50LmtleUlkZW50aWZpZXIgPT09IEVzYykgewogICAgICAgIGlmIChXZWJJbnNwZWN0b3Iuc2VhcmNoQ29udHJvbGxlci5pc1NlYXJjaFZpc2libGUoKSkgewogICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2VhcmNoQ29udHJvbGxlci5jbG9zZVNlYXJjaCgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIElmIGRyYXdlciBpcyBvcGVuIHdpdGggc29tZSB2aWV3IG90aGVyIHRoYW4gY29uc29sZSB0aGVuIGNsb3NlIGl0LgogICAgICAgIGlmICghdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50b2dnbGVkICYmIFdlYkluc3BlY3Rvci5kcmF3ZXIudmlzaWJsZSkKICAgICAgICAgICAgdGhpcy5jbG9zZVZpZXdJbkRyYXdlcigpOwogICAgICAgIGVsc2UgaWYgKHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udG9nZ2xlZCB8fCAhb3BlbkNvbnNvbGVXaXRoQ3RybFRpbGRlRW5hYmxlZCkKICAgICAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbkNsaWNrZWQoKTsKICAgIH0KCiAgICBpZiAoV2ViSW5zcGVjdG9yLmV4cGVyaW1lbnRzU2V0dGluZ3Mub3BlbkNvbnNvbGVXaXRoQ3RybFRpbGRlLmlzRW5hYmxlZCgpKSB7CiAgICAgICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0LktleXMuVGlsZGUuY29kZSAmJiBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dC5ldmVudEhhc0N0cmxPck1ldGEoZXZlbnQpKQogICAgICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uQ2xpY2tlZCgpOwogICAgfQp9CgpXZWJJbnNwZWN0b3IuZG9jdW1lbnRDYW5Db3B5ID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKSAmJiBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKS5oYW5kbGVDb3B5RXZlbnQpCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKfQoKV2ViSW5zcGVjdG9yLmRvY3VtZW50Q29weSA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAoV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkgJiYgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkuaGFuZGxlQ29weUV2ZW50KQogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpLmhhbmRsZUNvcHlFdmVudChldmVudCk7CiAgICBXZWJJbnNwZWN0b3IuZG9jdW1lbnRDb3B5RXZlbnRGaXJlZChldmVudCk7Cn0KCldlYkluc3BlY3Rvci5kb2N1bWVudENvcHlFdmVudEZpcmVkID0gZnVuY3Rpb24oZXZlbnQpCnsKfQoKV2ViSW5zcGVjdG9yLmNvbnRleHRNZW51RXZlbnRGaXJlZCA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAoZXZlbnQuaGFuZGxlZCB8fCBldmVudC50YXJnZXQuaGFzU3R5bGVDbGFzcygicG9wdXAtZ2xhc3NwYW5lIikpCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKfQoKV2ViSW5zcGVjdG9yLnNob3dQYW5lbCA9IGZ1bmN0aW9uKHBhbmVsKQp7CiAgICByZXR1cm4gV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuc2hvd1BhbmVsKHBhbmVsKTsKfQoKV2ViSW5zcGVjdG9yLnBhbmVsID0gZnVuY3Rpb24ocGFuZWwpCnsKICAgIHJldHVybiBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5wYW5lbChwYW5lbCk7Cn0KCldlYkluc3BlY3Rvci5icmluZ1RvRnJvbnQgPSBmdW5jdGlvbigpCnsKICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5icmluZ1RvRnJvbnQoKTsKfQoKLyoqCiAqIEBwYXJhbSB7c3RyaW5nPX0gbWVzc2FnZUxldmVsCiAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3dDb25zb2xlCiAqLwpXZWJJbnNwZWN0b3IubG9nID0gZnVuY3Rpb24obWVzc2FnZSwgbWVzc2FnZUxldmVsLCBzaG93Q29uc29sZSkKewogICAgLy8gcmVtZW1iZXIgJ3RoaXMnIGZvciBzZXRJbnRlcnZhbCgpIGNhbGxiYWNrCiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgLy8gcmV0dXJuIGluZGljYXRpb24gaWYgd2UgY2FuIGFjdHVhbGx5IGxvZyBhIG1lc3NhZ2UKICAgIGZ1bmN0aW9uIGlzTG9nQXZhaWxhYmxlKCkKICAgIHsKICAgICAgICByZXR1cm4gV2ViSW5zcGVjdG9yLkNvbnNvbGVNZXNzYWdlICYmIFdlYkluc3BlY3Rvci5SZW1vdGVPYmplY3QgJiYgc2VsZi5jb25zb2xlOwogICAgfQoKICAgIC8vIGZsdXNoIHRoZSBxdWV1ZSBvZiBwZW5kaW5nIG1lc3NhZ2VzCiAgICBmdW5jdGlvbiBmbHVzaFF1ZXVlKCkKICAgIHsKICAgICAgICB2YXIgcXVldWVkID0gV2ViSW5zcGVjdG9yLmxvZy5xdWV1ZWQ7CiAgICAgICAgaWYgKCFxdWV1ZWQpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZWQubGVuZ3RoOyArK2kpCiAgICAgICAgICAgIGxvZ01lc3NhZ2UocXVldWVkW2ldKTsKCiAgICAgICAgZGVsZXRlIFdlYkluc3BlY3Rvci5sb2cucXVldWVkOwogICAgfQoKICAgIC8vIGZsdXNoIHRoZSBxdWV1ZSBpZiBpdCBjb25zb2xlIGlzIGF2YWlsYWJsZQogICAgLy8gLSB0aGlzIGZ1bmN0aW9uIGlzIHJ1biBvbiBhbiBpbnRlcnZhbAogICAgZnVuY3Rpb24gZmx1c2hRdWV1ZUlmQXZhaWxhYmxlKCkKICAgIHsKICAgICAgICBpZiAoIWlzTG9nQXZhaWxhYmxlKCkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgY2xlYXJJbnRlcnZhbChXZWJJbnNwZWN0b3IubG9nLmludGVydmFsKTsKICAgICAgICBkZWxldGUgV2ViSW5zcGVjdG9yLmxvZy5pbnRlcnZhbDsKCiAgICAgICAgZmx1c2hRdWV1ZSgpOwogICAgfQoKICAgIC8vIGFjdHVhbGx5IGxvZyB0aGUgbWVzc2FnZQogICAgZnVuY3Rpb24gbG9nTWVzc2FnZShtZXNzYWdlKQogICAgewogICAgICAgIC8vIHBvc3QgdGhlIG1lc3NhZ2UKICAgICAgICB2YXIgbXNnID0gV2ViSW5zcGVjdG9yLkNvbnNvbGVNZXNzYWdlLmNyZWF0ZSgKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLkNvbnNvbGVNZXNzYWdlLk1lc3NhZ2VTb3VyY2UuT3RoZXIsCiAgICAgICAgICAgIG1lc3NhZ2VMZXZlbCB8fCBXZWJJbnNwZWN0b3IuQ29uc29sZU1lc3NhZ2UuTWVzc2FnZUxldmVsLkRlYnVnLAogICAgICAgICAgICBtZXNzYWdlKTsKCiAgICAgICAgc2VsZi5jb25zb2xlLmFkZE1lc3NhZ2UobXNnKTsKICAgICAgICBpZiAoc2hvd0NvbnNvbGUpCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93Q29uc29sZSgpOwogICAgfQoKICAgIC8vIGlmIHdlIGNhbid0IGxvZyB0aGUgbWVzc2FnZSwgcXVldWUgaXQKICAgIGlmICghaXNMb2dBdmFpbGFibGUoKSkgewogICAgICAgIGlmICghV2ViSW5zcGVjdG9yLmxvZy5xdWV1ZWQpCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5sb2cucXVldWVkID0gW107CgogICAgICAgIFdlYkluc3BlY3Rvci5sb2cucXVldWVkLnB1c2gobWVzc2FnZSk7CgogICAgICAgIGlmICghV2ViSW5zcGVjdG9yLmxvZy5pbnRlcnZhbCkKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmxvZy5pbnRlcnZhbCA9IHNldEludGVydmFsKGZsdXNoUXVldWVJZkF2YWlsYWJsZSwgMTAwMCk7CgogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBmbHVzaCB0aGUgcGVuZGluZyBxdWV1ZSBpZiBhbnkKICAgIGZsdXNoUXVldWUoKTsKCiAgICAvLyBsb2cgdGhlIG1lc3NhZ2UKICAgIGxvZ01lc3NhZ2UobWVzc2FnZSk7Cn0KCldlYkluc3BlY3Rvci5zaG93RXJyb3JNZXNzYWdlID0gZnVuY3Rpb24oZXJyb3IpCnsKICAgIFdlYkluc3BlY3Rvci5sb2coZXJyb3IsIFdlYkluc3BlY3Rvci5Db25zb2xlTWVzc2FnZS5NZXNzYWdlTGV2ZWwuRXJyb3IsIHRydWUpOwp9CgovLyBJbnNwZWN0b3IuaW5zcGVjdCBwcm90b2NvbCBldmVudApXZWJJbnNwZWN0b3IuaW5zcGVjdCA9IGZ1bmN0aW9uKHBheWxvYWQsIGhpbnRzKQp7CiAgICB2YXIgb2JqZWN0ID0gV2ViSW5zcGVjdG9yLlJlbW90ZU9iamVjdC5mcm9tUGF5bG9hZChwYXlsb2FkKTsKICAgIGlmIChvYmplY3Quc3VidHlwZSA9PT0gIm5vZGUiKSB7CiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2sobm9kZUlkKQogICAgICAgIHsKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLl91cGRhdGVGb2N1c2VkTm9kZShub2RlSWQpOwogICAgICAgICAgICBvYmplY3QucmVsZWFzZSgpOwogICAgICAgIH0KICAgICAgICBvYmplY3QucHVzaE5vZGVUb0Zyb250ZW5kKGNhbGxiYWNrKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKG9iamVjdC50eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgZnVuY3Rpb24gZGlkR2V0RGV0YWlscyhlcnJvciwgcmVzcG9uc2UpCiAgICAgICAgewogICAgICAgICAgICBvYmplY3QucmVsZWFzZSgpOwoKICAgICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHVpTG9jYXRpb24gPSBXZWJJbnNwZWN0b3IuZGVidWdnZXJNb2RlbC5yYXdMb2NhdGlvblRvVUlMb2NhdGlvbihyZXNwb25zZS5sb2NhdGlvbik7CiAgICAgICAgICAgIGlmICghdWlMb2NhdGlvbikKICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoInNjcmlwdHMiKS5zaG93VUlMb2NhdGlvbih1aUxvY2F0aW9uKTsKICAgICAgICB9CiAgICAgICAgRGVidWdnZXJBZ2VudC5nZXRGdW5jdGlvbkRldGFpbHMob2JqZWN0Lm9iamVjdElkLCBkaWRHZXREZXRhaWxzLmJpbmQodGhpcykpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoaGludHMuZGF0YWJhc2VJZCkKICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJyZXNvdXJjZXMiKS5zZWxlY3REYXRhYmFzZShXZWJJbnNwZWN0b3IuZGF0YWJhc2VNb2RlbC5kYXRhYmFzZUZvcklkKGhpbnRzLmRhdGFiYXNlSWQpKTsKICAgIGVsc2UgaWYgKGhpbnRzLmRvbVN0b3JhZ2VJZCkKICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJyZXNvdXJjZXMiKS5zZWxlY3RET01TdG9yYWdlKFdlYkluc3BlY3Rvci5kb21TdG9yYWdlTW9kZWwuc3RvcmFnZUZvcklkKGhpbnRzLmRvbVN0b3JhZ2VJZCkpOwogICAgZWxzZSBpZiAoaGludHMuY29weVRvQ2xpcGJvYXJkKQogICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5jb3B5VGV4dChvYmplY3QudmFsdWUpOwogICAgb2JqZWN0LnJlbGVhc2UoKTsKfQoKLy8gSW5zcGVjdG9yLmRldGFjaGVkIHByb3RvY29sIGV2ZW50CldlYkluc3BlY3Rvci5kZXRhY2hlZCA9IGZ1bmN0aW9uKHJlYXNvbikKewogICAgV2ViSW5zcGVjdG9yLnNvY2tldC5fZGV0YWNoUmVhc29uID0gcmVhc29uOwogICAgKG5ldyBXZWJJbnNwZWN0b3IuUmVtb3RlRGVidWdnaW5nVGVybWluYXRlZFNjcmVlbihyZWFzb24pKS5zaG93TW9kYWwoKTsKfQoKV2ViSW5zcGVjdG9yLnRhcmdldENyYXNoZWQgPSBmdW5jdGlvbigpCnsKICAgIChuZXcgV2ViSW5zcGVjdG9yLkhlbHBTY3JlZW5VbnRpbFJlbG9hZCgKICAgICAgICBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkluc3BlY3RlZCB0YXJnZXQgY3Jhc2hlZCIpLAogICAgICAgIFdlYkluc3BlY3Rvci5VSVN0cmluZygiSW5zcGVjdGVkIHRhcmdldCBoYXMgY3Jhc2hlZC4gT25jZSBpdCByZWxvYWRzIHdlIHdpbGwgYXR0YWNoIHRvIGl0IGF1dG9tYXRpY2FsbHkuIikpKS5zaG93TW9kYWwoKTsKfQoKV2ViSW5zcGVjdG9yLl9pbnNwZWN0Tm9kZVJlcXVlc3RlZCA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBXZWJJbnNwZWN0b3IuX3VwZGF0ZUZvY3VzZWROb2RlKGV2ZW50LmRhdGEpOwp9CgpXZWJJbnNwZWN0b3IuX3VwZGF0ZUZvY3VzZWROb2RlID0gZnVuY3Rpb24obm9kZUlkKQp7CiAgICBpZiAoV2ViSW5zcGVjdG9yLmluc3BlY3RFbGVtZW50TW9kZUNvbnRyb2xsZXIgJiYgV2ViSW5zcGVjdG9yLmluc3BlY3RFbGVtZW50TW9kZUNvbnRyb2xsZXIuZW5hYmxlZCgpKSB7CiAgICAgICAgSW5zcGVjdG9yRnJvbnRlbmRIb3N0LmJyaW5nVG9Gcm9udCgpOwogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLmRpc2FibGUoKTsKICAgIH0KICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoImVsZW1lbnRzIikucmV2ZWFsQW5kU2VsZWN0Tm9kZShub2RlSWQpOwp9CgpXZWJJbnNwZWN0b3Iuc2hvd0FuY2hvckxvY2F0aW9uID0gZnVuY3Rpb24oYW5jaG9yKQp7CiAgICB2YXIgcHJlZmVycmVkUGFuZWwgPSB0aGlzLnBhbmVsc1thbmNob3IucHJlZmVycmVkUGFuZWxdOwogICAgaWYgKHByZWZlcnJlZFBhbmVsICYmIFdlYkluc3BlY3Rvci5fc2hvd0FuY2hvckxvY2F0aW9uSW5QYW5lbChhbmNob3IsIHByZWZlcnJlZFBhbmVsKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIGlmIChXZWJJbnNwZWN0b3IuX3Nob3dBbmNob3JMb2NhdGlvbkluUGFuZWwoYW5jaG9yLCB0aGlzLnBhbmVsKCJzY3JpcHRzIikpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgaWYgKFdlYkluc3BlY3Rvci5fc2hvd0FuY2hvckxvY2F0aW9uSW5QYW5lbChhbmNob3IsIHRoaXMucGFuZWwoInJlc291cmNlcyIpKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIGlmIChXZWJJbnNwZWN0b3IuX3Nob3dBbmNob3JMb2NhdGlvbkluUGFuZWwoYW5jaG9yLCB0aGlzLnBhbmVsKCJuZXR3b3JrIikpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgcmV0dXJuIGZhbHNlOwp9CgpXZWJJbnNwZWN0b3IuX3Nob3dBbmNob3JMb2NhdGlvbkluUGFuZWwgPSBmdW5jdGlvbihhbmNob3IsIHBhbmVsKQp7CiAgICBpZiAoIXBhbmVsIHx8ICFwYW5lbC5jYW5TaG93QW5jaG9yTG9jYXRpb24oYW5jaG9yKSkKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgLy8gRklYTUU6IHN1cHBvcnQgd2Via2l0LWh0bWwtZXh0ZXJuYWwtbGluayBsaW5rcyBoZXJlLgogICAgaWYgKGFuY2hvci5oYXNTdHlsZUNsYXNzKCJ3ZWJraXQtaHRtbC1leHRlcm5hbC1saW5rIikpIHsKICAgICAgICBhbmNob3IucmVtb3ZlU3R5bGVDbGFzcygid2Via2l0LWh0bWwtZXh0ZXJuYWwtbGluayIpOwogICAgICAgIGFuY2hvci5hZGRTdHlsZUNsYXNzKCJ3ZWJraXQtaHRtbC1yZXNvdXJjZS1saW5rIik7CiAgICB9CgogICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuc2V0Q3VycmVudFBhbmVsKHBhbmVsKTsKICAgIHBhbmVsLnNob3dBbmNob3JMb2NhdGlvbihhbmNob3IpOwogICAgcmV0dXJuIHRydWU7Cn0KCldlYkluc3BlY3Rvci5ldmFsdWF0ZUluQ29uc29sZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIHNob3dSZXN1bHRPbmx5KQp7CiAgICB0aGlzLnNob3dDb25zb2xlKCk7CiAgICB0aGlzLmNvbnNvbGVWaWV3LmV2YWx1YXRlVXNpbmdUZXh0UHJvbXB0KGV4cHJlc3Npb24sIHNob3dSZXN1bHRPbmx5KTsKfQoKV2ViSW5zcGVjdG9yLmFkZE1haW5FdmVudExpc3RlbmVycyA9IGZ1bmN0aW9uKGRvYykKewogICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmRvY3VtZW50S2V5RG93bi5iaW5kKHRoaXMpLCB0cnVlKTsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5wb3N0RG9jdW1lbnRLZXlEb3duLmJpbmQodGhpcyksIGZhbHNlKTsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJiZWZvcmVjb3B5IiwgdGhpcy5kb2N1bWVudENhbkNvcHkuYmluZCh0aGlzKSwgdHJ1ZSk7CiAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcigiY29weSIsIHRoaXMuZG9jdW1lbnRDb3B5LmJpbmQodGhpcyksIGZhbHNlKTsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIHRoaXMuY29udGV4dE1lbnVFdmVudEZpcmVkLmJpbmQodGhpcyksIHRydWUpOwogICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5kb2N1bWVudENsaWNrLmJpbmQodGhpcyksIHRydWUpOwp9CgpXZWJJbnNwZWN0b3IuWm9vbSA9IHsKICAgIFRhYmxlOiBbMC4yNSwgMC4zMywgMC41LCAwLjY2LCAwLjc1LCAwLjksIDEsIDEuMSwgMS4yNSwgMS41LCAxLjc1LCAyLCAyLjUsIDMsIDQsIDVdLAogICAgRGVmYXVsdE9mZnNldDogNgp9CgoKLy8gRXgtRGV2VG9vbHMuanMgY29udGVudAoKLyoqCiAqIEBwYXJhbSB7RXh0ZW5zaW9uRGVzY3JpcHRvcn0gZXh0ZW5zaW9uSW5mbwogKiBAcmV0dXJuIHtzdHJpbmd9CiAqLwpmdW5jdGlvbiBidWlsZFBsYXRmb3JtRXh0ZW5zaW9uQVBJKGV4dGVuc2lvbkluZm8pCnsKICAgIHJldHVybiAidmFyIGV4dGVuc2lvbkluZm8gPSAiICsgSlNPTi5zdHJpbmdpZnkoZXh0ZW5zaW9uSW5mbykgKyAiOyIgKwogICAgICAgInZhciB0YWJJZCA9ICIgKyBXZWJJbnNwZWN0b3IuX2luc3BlY3RlZFRhYklkICsgIjsiICsKICAgICAgIHBsYXRmb3JtRXh0ZW5zaW9uQVBJLnRvU3RyaW5nKCk7Cn0KCldlYkluc3BlY3Rvci5zZXRJbnNwZWN0ZWRUYWJJZCA9IGZ1bmN0aW9uKHRhYklkKQp7CiAgICBXZWJJbnNwZWN0b3IuX2luc3BlY3RlZFRhYklkID0gdGFiSWQ7Cn0KCi8qKgogKiBAcmV0dXJuIHtzdHJpbmd9CiAqLwpXZWJJbnNwZWN0b3IuZ2V0U2VsZWN0aW9uQmFja2dyb3VuZENvbG9yID0gZnVuY3Rpb24oKQp7CiAgICByZXR1cm4gSW5zcGVjdG9yRnJvbnRlbmRIb3N0LmdldFNlbGVjdGlvbkJhY2tncm91bmRDb2xvcigpOwp9CgovKioKICogQHJldHVybiB7c3RyaW5nfQogKi8KV2ViSW5zcGVjdG9yLmdldFNlbGVjdGlvbkZvcmVncm91bmRDb2xvciA9IGZ1bmN0aW9uKCkKewogICAgcmV0dXJuIEluc3BlY3RvckZyb250ZW5kSG9zdC5nZXRTZWxlY3Rpb25Gb3JlZ3JvdW5kQ29sb3IoKTsKfQoKd2luZG93LkRFQlVHID0gdHJ1ZTsK",
                "body": "LyoKICogQ29weXJpZ2h0IChDKSAyMDA2LCAyMDA3LCAyMDA4IEFwcGxlIEluYy4gIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIENvcHlyaWdodCAoQykgMjAwNyBNYXR0IExpbGVrIChwZXd0ZXJtb29zZUBnbWFpbC5jb20pLgogKiBDb3B5cmlnaHQgKEMpIDIwMDkgSm9zZXBoIFBlY29yYXJvCiAqCiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dAogKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMKICogYXJlIG1ldDoKICoKICogMS4gIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiAqICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiAqIDIuICBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodAogKiAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZQogKiAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KICogMy4gIE5laXRoZXIgdGhlIG5hbWUgb2YgQXBwbGUgQ29tcHV0ZXIsIEluYy4gKCJBcHBsZSIpIG5vciB0aGUgbmFtZXMgb2YKICogICAgIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzIGRlcml2ZWQKICogICAgIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi4KICoKICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBBUFBMRSBBTkQgSVRTIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORCBBTlkKICogRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAogKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFCiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFQUExFIE9SIElUUyBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkKICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMKICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOwogKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQKICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlQKICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GCiAqIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiAqLwoKdmFyIFdlYkluc3BlY3RvciA9IHsKICAgIF9wYW5lbERlc2NyaXB0b3JzOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5wYW5lbHMgPSB7fTsKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldyA9IG5ldyBXZWJJbnNwZWN0b3IuSW5zcGVjdG9yVmlldygpOwogICAgICAgIHZhciBwYXJlbnRFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1haW4iKTsKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5zaG93KHBhcmVudEVsZW1lbnQpOwogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkluc3BlY3RvclZpZXcuRXZlbnRzLlBhbmVsU2VsZWN0ZWQsIHRoaXMuX3BhbmVsU2VsZWN0ZWQsIHRoaXMpOwoKICAgICAgICB2YXIgZWxlbWVudHMgPSBuZXcgV2ViSW5zcGVjdG9yLkVsZW1lbnRzUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgdmFyIHJlc291cmNlcyA9IG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJyZXNvdXJjZXMiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlJlc291cmNlcyIpLCAiUmVzb3VyY2VzUGFuZWwiLCAiUmVzb3VyY2VzUGFuZWwuanMiKTsKICAgICAgICB2YXIgbmV0d29yayA9IG5ldyBXZWJJbnNwZWN0b3IuTmV0d29ya1BhbmVsRGVzY3JpcHRvcigpOwogICAgICAgIHZhciBzY3JpcHRzID0gbmV3IFdlYkluc3BlY3Rvci5TY3JpcHRzUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgdmFyIHRpbWVsaW5lID0gbmV3IFdlYkluc3BlY3Rvci5UaW1lbGluZVBhbmVsRGVzY3JpcHRvcigpOwogICAgICAgIHZhciBwcm9maWxlcyA9IG5ldyBXZWJJbnNwZWN0b3IuUHJvZmlsZXNQYW5lbERlc2NyaXB0b3IoKTsKICAgICAgICB2YXIgYXVkaXRzID0gbmV3IFdlYkluc3BlY3Rvci5QYW5lbERlc2NyaXB0b3IoImF1ZGl0cyIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiQXVkaXRzIiksICJBdWRpdHNQYW5lbCIsICJBdWRpdHNQYW5lbC5qcyIpOwogICAgICAgIHZhciBjb25zb2xlID0gbmV3IFdlYkluc3BlY3Rvci5QYW5lbERlc2NyaXB0b3IoImNvbnNvbGUiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNvbnNvbGUiKSwgIkNvbnNvbGVQYW5lbCIpOwogICAgICAgIHZhciBhbGxEZXNjcmlwdG9ycyA9IFtlbGVtZW50cywgcmVzb3VyY2VzLCBuZXR3b3JrLCBzY3JpcHRzLCB0aW1lbGluZSwgcHJvZmlsZXMsIGF1ZGl0cywgY29uc29sZV07CiAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5leHBlcmltZW50c1NldHRpbmdzLmxheWVyc1BhbmVsLmlzRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIHZhciBsYXllcnMgPSBuZXcgV2ViSW5zcGVjdG9yLkxheWVyc1BhbmVsRGVzY3JpcHRvcigpOwogICAgICAgICAgICBhbGxEZXNjcmlwdG9ycy5wdXNoKGxheWVycyk7CiAgICAgICAgfQogICAgICAgIHZhciBhbGxQcm9maWxlcnMgPSBbcHJvZmlsZXNdOwogICAgICAgIGlmIChXZWJJbnNwZWN0b3IuZXhwZXJpbWVudHNTZXR0aW5ncy5jdXN0b21pemFibGVUb29sYmFyLmlzRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGFsbFByb2ZpbGVycyA9IFtdOwogICAgICAgICAgICBhbGxQcm9maWxlcnMucHVzaChuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiY3B1LXByb2ZpbGVyIiwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJDUFUgUHJvZmlsZXIiKSwgIkNQVVByb2ZpbGVyUGFuZWwiLCAiUHJvZmlsZXNQYW5lbC5qcyIpKTsKICAgICAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkpCiAgICAgICAgICAgICAgICBhbGxQcm9maWxlcnMucHVzaChuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiY3NzLXByb2ZpbGVyIiwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJDU1MgUHJvZmlsZXIiKSwgIkNTU1NlbGVjdG9yUHJvZmlsZXJQYW5lbCIsICJQcm9maWxlc1BhbmVsLmpzIikpOwogICAgICAgICAgICBhbGxQcm9maWxlcnMucHVzaChuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiaGVhcC1wcm9maWxlciIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiSGVhcCBQcm9maWxlciIpLCAiSGVhcFByb2ZpbGVyUGFuZWwiLCAiUHJvZmlsZXNQYW5lbC5qcyIpKTsKICAgICAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkgJiYgV2ViSW5zcGVjdG9yLmV4cGVyaW1lbnRzU2V0dGluZ3MuY2FudmFzSW5zcGVjdGlvbi5pc0VuYWJsZWQoKSkKICAgICAgICAgICAgICAgIGFsbFByb2ZpbGVycy5wdXNoKG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJjYW52YXMtcHJvZmlsZXIiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNhbnZhcyBQcm9maWxlciIpLCAiQ2FudmFzUHJvZmlsZXJQYW5lbCIsICJQcm9maWxlc1BhbmVsLmpzIikpOwogICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmJpbmQoYWxsRGVzY3JpcHRvcnMsIGFsbERlc2NyaXB0b3JzLmluZGV4T2YocHJvZmlsZXMpLCAxKS5hcHBseShudWxsLCBhbGxQcm9maWxlcnMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHBhbmVsRGVzY3JpcHRvcnMgPSBbXTsKICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIuaXNXb3JrZXJGcm9udGVuZCgpKSB7CiAgICAgICAgICAgIHBhbmVsRGVzY3JpcHRvcnMucHVzaChzY3JpcHRzKTsKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycy5wdXNoKHRpbWVsaW5lKTsKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycyA9IHBhbmVsRGVzY3JpcHRvcnMuY29uY2F0KGFsbFByb2ZpbGVycyk7CiAgICAgICAgICAgIHBhbmVsRGVzY3JpcHRvcnMucHVzaChjb25zb2xlKTsKICAgICAgICAgICAgcmV0dXJuIHBhbmVsRGVzY3JpcHRvcnM7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWxsRGVzY3JpcHRvcnMubGVuZ3RoOyArK2kpCiAgICAgICAgICAgIHBhbmVsRGVzY3JpcHRvcnMucHVzaChhbGxEZXNjcmlwdG9yc1tpXSk7CiAgICAgICAgcmV0dXJuIHBhbmVsRGVzY3JpcHRvcnM7CiAgICB9LAoKICAgIF9wYW5lbFNlbGVjdGVkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi5zZXRFbmFibGVkKFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpLm5hbWUgIT09ICJjb25zb2xlIik7CiAgICB9LAoKICAgIF9jcmVhdGVHbG9iYWxTdGF0dXNCYXJJdGVtczogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBib3R0b21TdGF0dXNCYXJDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYm90dG9tLXN0YXR1cy1iYXItY29udGFpbmVyIik7CgogICAgICAgIC8vIENyZWF0ZSBtYWluIGRvY2sgYnV0dG9uIGFuZCBvcHRpb25zLgogICAgICAgIHZhciBtYWluU3RhdHVzQmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1haW4tc3RhdHVzLWJhciIpOwogICAgICAgIG1haW5TdGF0dXNCYXIuaW5zZXJ0QmVmb3JlKHRoaXMuZG9ja0NvbnRyb2xsZXIuZWxlbWVudCwgYm90dG9tU3RhdHVzQmFyQ29udGFpbmVyKTsKCiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbiA9IG5ldyBXZWJJbnNwZWN0b3IuU3RhdHVzQmFyQnV0dG9uKFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2hvdyBjb25zb2xlLiIpLCAiY29uc29sZS1zdGF0dXMtYmFyLWl0ZW0iKTsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbkNsaWNrZWQuYmluZCh0aGlzKSwgZmFsc2UpOwogICAgICAgIG1haW5TdGF0dXNCYXIuaW5zZXJ0QmVmb3JlKHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24uZWxlbWVudCwgYm90dG9tU3RhdHVzQmFyQ29udGFpbmVyKTsKCiAgICAgICAgaWYgKHRoaXMuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlcikKICAgICAgICAgICAgbWFpblN0YXR1c0Jhci5pbnNlcnRCZWZvcmUodGhpcy5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLnRvZ2dsZVNlYXJjaEJ1dHRvbi5lbGVtZW50LCBib3R0b21TdGF0dXNCYXJDb250YWluZXIpOwoKICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0WyJyZW1vdGVGcm9udGVuZCJdICYmIFdlYkluc3BlY3Rvci5leHBlcmltZW50c1NldHRpbmdzLnNjcmVlbmNhc3QuaXNFbmFibGVkKCkpIHsKICAgICAgICAgICAgdGhpcy5fdG9nZ2xlU2NyZWVuY2FzdEJ1dHRvbiA9IG5ldyBXZWJJbnNwZWN0b3IuU3RhdHVzQmFyQnV0dG9uKFdlYkluc3BlY3Rvci5VSVN0cmluZygiVG9nZ2xlIHNjcmVlbmNhc3QuIiksICJzY3JlZW5jYXN0LXN0YXR1cy1iYXItaXRlbSIpOwogICAgICAgICAgICB0aGlzLl90b2dnbGVTY3JlZW5jYXN0QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fdG9nZ2xlU2NyZWVuY2FzdEJ1dHRvbkNsaWNrZWQuYmluZCh0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBtYWluU3RhdHVzQmFyLmluc2VydEJlZm9yZSh0aGlzLl90b2dnbGVTY3JlZW5jYXN0QnV0dG9uLmVsZW1lbnQsIGJvdHRvbVN0YXR1c0JhckNvbnRhaW5lcik7CiAgICAgICAgfQoKICAgICAgICBtYWluU3RhdHVzQmFyLmFwcGVuZENoaWxkKHRoaXMuc2V0dGluZ3NDb250cm9sbGVyLnN0YXR1c0Jhckl0ZW0pOwogICAgfSwKCiAgICBfdG9nZ2xlQ29uc29sZUJ1dHRvbkNsaWNrZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24uZW5hYmxlZCgpKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIHZhciBhbmltYXRpb25UeXBlID0gd2luZG93LmV2ZW50ICYmIHdpbmRvdy5ldmVudC5zaGlmdEtleSA/IFdlYkluc3BlY3Rvci5EcmF3ZXIuQW5pbWF0aW9uVHlwZS5TbG93IDogV2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlLk5vcm1hbDsKCiAgICAgICAgaWYgKHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udG9nZ2xlZCkKICAgICAgICAgICAgdGhpcy5jbG9zZUNvbnNvbGUoYW5pbWF0aW9uVHlwZSk7CiAgICAgICAgZWxzZQogICAgICAgICAgICB0aGlzLnNob3dDb25zb2xlKGFuaW1hdGlvblR5cGUpOwogICAgfSwKCiAgICBfdG9nZ2xlU2NyZWVuY2FzdEJ1dHRvbkNsaWNrZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl90b2dnbGVTY3JlZW5jYXN0QnV0dG9uLnRvZ2dsZWQgPSAhdGhpcy5fdG9nZ2xlU2NyZWVuY2FzdEJ1dHRvbi50b2dnbGVkOwoKICAgICAgICBpZiAoIXRoaXMuX3NjcmVlbmNhc3RWaWV3KSB7CiAgICAgICAgICAgIC8vIFJlYnVpbGQgdGhlIFVJIHVwb24gZmlyc3QgaW52b2NhdGlvbi4KICAgICAgICAgICAgdGhpcy5fc2NyZWVuY2FzdFZpZXcgPSBuZXcgV2ViSW5zcGVjdG9yLlNjcmVlbmNhc3RWaWV3KCk7CiAgICAgICAgICAgIHRoaXMuX3NjcmVlbmNhc3RTcGxpdFZpZXcgPSBuZXcgV2ViSW5zcGVjdG9yLlNwbGl0Vmlldyh0cnVlLCAic2NyZWVuY2FzdFNwbGl0VmlldyIpOwogICAgICAgICAgICB0aGlzLl9zY3JlZW5jYXN0U3BsaXRWaWV3Lm1hcmtBc1Jvb3QoKTsKICAgICAgICAgICAgdGhpcy5fc2NyZWVuY2FzdFNwbGl0Vmlldy5zaG93KGRvY3VtZW50LmJvZHkpOwoKICAgICAgICAgICAgdGhpcy5fc2NyZWVuY2FzdFZpZXcuc2hvdyh0aGlzLl9zY3JlZW5jYXN0U3BsaXRWaWV3LmZpcnN0RWxlbWVudCgpKTsKICAgICAgICAgICAgdGhpcy5fc2NyZWVuY2FzdFNwbGl0Vmlldy5zZWNvbmRFbGVtZW50KCkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJvb3QiKSk7CiAgICAgICAgICAgIHRoaXMuaW5zcGVjdG9yVmlldy5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICB0aGlzLmluc3BlY3RvclZpZXcuc2hvdyhkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWFpbiIpKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl90b2dnbGVTY3JlZW5jYXN0QnV0dG9uLnRvZ2dsZWQpCiAgICAgICAgICAgIHRoaXMuX3NjcmVlbmNhc3RTcGxpdFZpZXcuc2hvd0JvdGgoKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRoaXMuX3NjcmVlbmNhc3RTcGxpdFZpZXcuc2hvd09ubHlTZWNvbmQoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IHN0YXR1c0JhckVsZW1lbnQKICAgICAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yLlZpZXd9IHZpZXcKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKT19IG9uY2xvc2UKICAgICAqLwogICAgc2hvd1ZpZXdJbkRyYXdlcjogZnVuY3Rpb24oc3RhdHVzQmFyRWxlbWVudCwgdmlldywgb25jbG9zZSkKICAgIHsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTaG93IGNvbnNvbGUuIik7CiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50b2dnbGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5fcmVtb3ZlRHJhd2VyVmlldygpOwoKICAgICAgICB2YXIgZHJhd2VyU3RhdHVzQmFySGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgZHJhd2VyU3RhdHVzQmFySGVhZGVyLmNsYXNzTmFtZSA9ICJkcmF3ZXItaGVhZGVyIHN0YXR1cy1iYXItaXRlbSI7CiAgICAgICAgZHJhd2VyU3RhdHVzQmFySGVhZGVyLmFwcGVuZENoaWxkKHN0YXR1c0JhckVsZW1lbnQpOwogICAgICAgIGRyYXdlclN0YXR1c0JhckhlYWRlci5vbmNsb3NlID0gb25jbG9zZTsKCiAgICAgICAgdmFyIGNsb3NlQnV0dG9uID0gZHJhd2VyU3RhdHVzQmFySGVhZGVyLmNyZWF0ZUNoaWxkKCJkaXYiLCAiY2xvc2UtYnV0dG9uIik7CiAgICAgICAgY2xvc2VCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLmNsb3NlVmlld0luRHJhd2VyLmJpbmQodGhpcyksIGZhbHNlKTsKCiAgICAgICAgdmFyIHBhbmVsU3RhdHVzQmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBhbmVsLXN0YXR1cy1iYXIiKTsKICAgICAgICB2YXIgZHJhd2VyVmlld0FuY2hvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkcmF3ZXItdmlldy1hbmNob3IiKTsKICAgICAgICBwYW5lbFN0YXR1c0Jhci5pbnNlcnRCZWZvcmUoZHJhd2VyU3RhdHVzQmFySGVhZGVyLCBkcmF3ZXJWaWV3QW5jaG9yKTsKICAgICAgICB0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIgPSBkcmF3ZXJTdGF0dXNCYXJIZWFkZXI7CiAgICAgICAgdGhpcy5kcmF3ZXIuc2hvdyh2aWV3LCBXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGUuSW1tZWRpYXRlbHkpOwogICAgfSwKCiAgICBjbG9zZVZpZXdJbkRyYXdlcjogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICh0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIpIHsKICAgICAgICAgICAgdGhpcy5fcmVtb3ZlRHJhd2VyVmlldygpOwoKICAgICAgICAgICAgLy8gT25jZSBkcmF3ZXIgaXMgY2xvc2VkIGNvbnNvbGUgc2hvdWxkIGJlIHNob3duIGlmIGl0IHdhcyBzaG93biBiZWZvcmUgY3VycmVudCB2aWV3IHJlcGxhY2VkIGl0IGluIGRyYXdlci4gCiAgICAgICAgICAgIGlmICh0aGlzLl9jb25zb2xlV2FzU2hvd24pCiAgICAgICAgICAgICAgICB0aGlzLnNob3dDb25zb2xlKCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRoaXMuZHJhd2VyLmhpZGUoV2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlLkltbWVkaWF0ZWx5KTsKICAgICAgICB9CiAgICB9LAoKICAgIF9yZW1vdmVEcmF3ZXJWaWV3OiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlcikgewogICAgICAgICAgICB0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIucmVtb3ZlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIub25jbG9zZSkKICAgICAgICAgICAgICAgIHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlci5vbmNsb3NlKCk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXI7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlPX0gYW5pbWF0aW9uVHlwZQogICAgICovCiAgICBzaG93Q29uc29sZTogZnVuY3Rpb24oYW5pbWF0aW9uVHlwZSkKICAgIHsKICAgICAgICBhbmltYXRpb25UeXBlID0gYW5pbWF0aW9uVHlwZSB8fCBXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGUuTm9ybWFsOwoKICAgICAgICBpZiAodGhpcy5jb25zb2xlVmlldy5pc1Nob3dpbmcoKSAmJiAhV2ViSW5zcGVjdG9yLmRyYXdlci5pc0hpZGluZygpKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGlmIChXZWJJbnNwZWN0b3IuZHJhd2VyLnZpc2libGUpCiAgICAgICAgICAgIHRoaXMuX3JlbW92ZURyYXdlclZpZXcoKTsKCiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50b2dnbGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJIaWRlIGNvbnNvbGUuIik7CiAgICAgICAgdGhpcy5kcmF3ZXIuc2hvdyh0aGlzLmNvbnNvbGVWaWV3LCBhbmltYXRpb25UeXBlKTsKICAgICAgICB0aGlzLl9jb25zb2xlV2FzU2hvd24gPSB0cnVlOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlPX0gYW5pbWF0aW9uVHlwZQogICAgICovCiAgICBjbG9zZUNvbnNvbGU6IGZ1bmN0aW9uKGFuaW1hdGlvblR5cGUpCiAgICB7CiAgICAgICAgYW5pbWF0aW9uVHlwZSA9IGFuaW1hdGlvblR5cGUgfHwgV2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlLk5vcm1hbDsKCiAgICAgICAgaWYgKCF0aGlzLmNvbnNvbGVWaWV3LmlzU2hvd2luZygpIHx8ICFXZWJJbnNwZWN0b3IuZHJhd2VyLnZpc2libGUpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50b2dnbGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2hvdyBjb25zb2xlLiIpOwogICAgICAgIHRoaXMuZHJhd2VyLmhpZGUoYW5pbWF0aW9uVHlwZSk7CiAgICAgICAgdGhpcy5fY29uc29sZVdhc1Nob3duID0gZmFsc2U7CiAgICB9LAoKICAgIF9yZXNldEVycm9yQW5kV2FybmluZ0NvdW50czogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBlcnJvcldhcm5pbmdFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVycm9yLXdhcm5pbmctY291bnQiKTsKICAgICAgICBpZiAoIWVycm9yV2FybmluZ0VsZW1lbnQpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5hZGRTdHlsZUNsYXNzKCJoaWRkZW4iKTsKICAgIH0sCgogICAgX3VwZGF0ZUVycm9yQW5kV2FybmluZ0NvdW50czogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBlcnJvcnMgPSBXZWJJbnNwZWN0b3IuY29uc29sZS5lcnJvcnM7CiAgICAgICAgdmFyIHdhcm5pbmdzID0gV2ViSW5zcGVjdG9yLmNvbnNvbGUud2FybmluZ3M7CgogICAgICAgIGlmICghZXJyb3JzICYmICF3YXJuaW5ncykgewogICAgICAgICAgICB0aGlzLl9yZXNldEVycm9yQW5kV2FybmluZ0NvdW50cygpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgZXJyb3JXYXJuaW5nRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJlcnJvci13YXJuaW5nLWNvdW50Iik7CiAgICAgICAgaWYgKCFlcnJvcldhcm5pbmdFbGVtZW50KQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQucmVtb3ZlU3R5bGVDbGFzcygiaGlkZGVuIik7CgogICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQucmVtb3ZlQ2hpbGRyZW4oKTsKCiAgICAgICAgaWYgKGVycm9ycykgewogICAgICAgICAgICB2YXIgZXJyb3JJbWFnZUVsZW1lbnQgPSBlcnJvcldhcm5pbmdFbGVtZW50LmNyZWF0ZUNoaWxkKCJkaXYiLCAiZXJyb3ItaWNvbi1zbWFsbCIpOwogICAgICAgICAgICB2YXIgZXJyb3JFbGVtZW50ID0gZXJyb3JXYXJuaW5nRWxlbWVudC5jcmVhdGVDaGlsZCgic3BhbiIpOwogICAgICAgICAgICBlcnJvckVsZW1lbnQuaWQgPSAiZXJyb3ItY291bnQiOwogICAgICAgICAgICBlcnJvckVsZW1lbnQudGV4dENvbnRlbnQgPSBlcnJvcnM7CiAgICAgICAgfQoKICAgICAgICBpZiAod2FybmluZ3MpIHsKICAgICAgICAgICAgdmFyIHdhcm5pbmdzSW1hZ2VFbGVtZW50ID0gZXJyb3JXYXJuaW5nRWxlbWVudC5jcmVhdGVDaGlsZCgiZGl2IiwgIndhcm5pbmctaWNvbi1zbWFsbCIpOwogICAgICAgICAgICB2YXIgd2FybmluZ3NFbGVtZW50ID0gZXJyb3JXYXJuaW5nRWxlbWVudC5jcmVhdGVDaGlsZCgic3BhbiIpOwogICAgICAgICAgICB3YXJuaW5nc0VsZW1lbnQuaWQgPSAid2FybmluZy1jb3VudCI7CiAgICAgICAgICAgIHdhcm5pbmdzRWxlbWVudC50ZXh0Q29udGVudCA9IHdhcm5pbmdzOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVycm9ycykgewogICAgICAgICAgICBpZiAod2FybmluZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChlcnJvcnMgPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGlmICh3YXJuaW5ncyA9PSAxKQogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvciwgJWQgd2FybmluZyIsIGVycm9ycywgd2FybmluZ3MpOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiJWQgZXJyb3IsICVkIHdhcm5pbmdzIiwgZXJyb3JzLCB3YXJuaW5ncyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHdhcm5pbmdzID09IDEpCiAgICAgICAgICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiJWQgZXJyb3JzLCAlZCB3YXJuaW5nIiwgZXJyb3JzLCB3YXJuaW5ncyk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiJWQgZXJyb3JzLCAlZCB3YXJuaW5ncyIsIGVycm9ycywgd2FybmluZ3MpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9ycyA9PSAxKQogICAgICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiJWQgZXJyb3IiLCBlcnJvcnMpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvcnMiLCBlcnJvcnMpOwogICAgICAgIH0gZWxzZSBpZiAod2FybmluZ3MgPT0gMSkKICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiJWQgd2FybmluZyIsIHdhcm5pbmdzKTsKICAgICAgICBlbHNlIGlmICh3YXJuaW5ncykKICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiJWQgd2FybmluZ3MiLCB3YXJuaW5ncyk7CiAgICAgICAgZWxzZQogICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gbnVsbDsKICAgIH0sCgogICAgZ2V0IGluc3BlY3RlZFBhZ2VEb21haW4oKQogICAgewogICAgICAgIHZhciBwYXJzZWRVUkwgPSBXZWJJbnNwZWN0b3IuaW5zcGVjdGVkUGFnZVVSTCAmJiBXZWJJbnNwZWN0b3IuaW5zcGVjdGVkUGFnZVVSTC5hc1BhcnNlZFVSTCgpOwogICAgICAgIHJldHVybiBwYXJzZWRVUkwgPyBwYXJzZWRVUkwuaG9zdCA6ICIiOwogICAgfSwKCiAgICBfaW5pdGlhbGl6ZUNhcGFiaWxpdHk6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBlcnJvciwgcmVzdWx0KQogICAgewogICAgICAgIENhcGFiaWxpdGllc1tuYW1lXSA9IHJlc3VsdDsKICAgICAgICBpZiAoY2FsbGJhY2spCiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICB9LAoKICAgIF96b29tSW46IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl96b29tTGV2ZWwgPSBNYXRoLm1pbih0aGlzLl96b29tTGV2ZWwgKyAxLCBXZWJJbnNwZWN0b3IuWm9vbS5UYWJsZS5sZW5ndGggLSBXZWJJbnNwZWN0b3IuWm9vbS5EZWZhdWx0T2Zmc2V0IC0gMSk7CiAgICAgICAgdGhpcy5fcmVxdWVzdFpvb20oKTsKICAgIH0sCgogICAgX3pvb21PdXQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl96b29tTGV2ZWwgPSBNYXRoLm1heCh0aGlzLl96b29tTGV2ZWwgLSAxLCAtV2ViSW5zcGVjdG9yLlpvb20uRGVmYXVsdE9mZnNldCk7CiAgICAgICAgdGhpcy5fcmVxdWVzdFpvb20oKTsKICAgIH0sCgogICAgX3Jlc2V0Wm9vbTogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3pvb21MZXZlbCA9IDA7CiAgICAgICAgdGhpcy5fcmVxdWVzdFpvb20oKTsKICAgIH0sCgogICAgX3JlcXVlc3Rab29tOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgV2ViSW5zcGVjdG9yLnNldHRpbmdzLnpvb21MZXZlbC5zZXQodGhpcy5fem9vbUxldmVsKTsKICAgICAgICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHpvb21MZXZlbCB0YWtlcyBpbnRlZ2VycyAod2l0aCAwIGJlaW5nIGRlZmF1bHQgem9vbSkuCiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5fem9vbUxldmVsICsgV2ViSW5zcGVjdG9yLlpvb20uRGVmYXVsdE9mZnNldDsKICAgICAgICBpbmRleCA9IE1hdGgubWluKFdlYkluc3BlY3Rvci5ab29tLlRhYmxlLmxlbmd0aCAtIDEsIGluZGV4KTsKICAgICAgICBpbmRleCA9IE1hdGgubWF4KDAsIGluZGV4KTsKICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3Quc2V0Wm9vbUZhY3RvcihXZWJJbnNwZWN0b3IuWm9vbS5UYWJsZVtpbmRleF0pOwogICAgfSwKCiAgICBfZGVidWdnZXJQYXVzZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICAvLyBDcmVhdGUgc2NyaXB0cyBwYW5lbCB1cG9uIGRlbWFuZC4KICAgICAgICBXZWJJbnNwZWN0b3IucGFuZWwoInNjcmlwdHMiKTsKICAgIH0KfQoKV2ViSW5zcGVjdG9yLkV2ZW50cyA9IHsKICAgIEluc3BlY3RvckxvYWRlZDogIkluc3BlY3RvckxvYWRlZCIsCiAgICBJbnNwZWN0b3JDbG9zaW5nOiAiSW5zcGVjdG9yQ2xvc2luZyIKfQoKeyhmdW5jdGlvbiBwYXJzZVF1ZXJ5UGFyYW1ldGVycygpCnsKICAgIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdCA9IHt9OwogICAgdmFyIHF1ZXJ5UGFyYW1zID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaDsKICAgIGlmICghcXVlcnlQYXJhbXMpCiAgICAgICAgcmV0dXJuOwogICAgdmFyIHBhcmFtcyA9IHF1ZXJ5UGFyYW1zLnN1YnN0cmluZygxKS5zcGxpdCgiJiIpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgcGFpciA9IHBhcmFtc1tpXS5zcGxpdCgiPSIpOwogICAgICAgIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdFtwYWlyWzBdXSA9IHBhaXJbMV07CiAgICB9Cn0pKCk7fQoKV2ViSW5zcGVjdG9yLnN1Z2dlc3RSZWxvYWQgPSBmdW5jdGlvbigpCnsKICAgIGlmICh3aW5kb3cuY29uZmlybShXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkl0IGlzIHJlY29tbWVuZGVkIHRvIHJlc3RhcnQgaW5zcGVjdG9yIGFmdGVyIG1ha2luZyB0aGVzZSBjaGFuZ2VzLiBXb3VsZCB5b3UgbGlrZSB0byByZXN0YXJ0IGl0PyIpKSkKICAgICAgICB0aGlzLnJlbG9hZCgpOwp9CgpXZWJJbnNwZWN0b3IucmVsb2FkID0gZnVuY3Rpb24oKQp7CiAgICBJbnNwZWN0b3JBZ2VudC5yZXNldCgpOwoKICAgIHZhciBxdWVyeVBhcmFtcyA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2g7CiAgICB2YXIgdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICB1cmwgPSB1cmwuc3Vic3RyaW5nKDAsIHVybC5sZW5ndGggLSBxdWVyeVBhcmFtcy5sZW5ndGgpOwogICAgdmFyIHF1ZXJ5UGFyYW1zT2JqZWN0ID0ge307CiAgICBmb3IgKHZhciBuYW1lIGluIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdCkKICAgICAgICBxdWVyeVBhcmFtc09iamVjdFtuYW1lXSA9IFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdFtuYW1lXTsKICAgIGlmICh0aGlzLmRvY2tDb250cm9sbGVyKQogICAgICAgIHF1ZXJ5UGFyYW1zT2JqZWN0WyJkb2NrU2lkZSJdID0gdGhpcy5kb2NrQ29udHJvbGxlci5kb2NrU2lkZSgpOwogICAgdmFyIG5hbWVzID0gT2JqZWN0LmtleXMocXVlcnlQYXJhbXNPYmplY3QpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7ICsraSkKICAgICAgICB1cmwgKz0gKGkgPyAiJiIgOiAiPyIpICsgbmFtZXNbaV0gKyAiPSIgKyBxdWVyeVBhcmFtc09iamVjdFtuYW1lc1tpXV07CiAgICBkb2N1bWVudC5sb2NhdGlvbiA9IHVybDsKfQoKV2ViSW5zcGVjdG9yLmxvYWRlZCA9IGZ1bmN0aW9uKCkKewogICAgSW5zcGVjdG9yQmFja2VuZC5sb2FkRnJvbUpTT05JZk5lZWRlZCgiLi4vcHJvdG9jb2wuanNvbiIpOwogICAgV2ViSW5zcGVjdG9yLmRvY2tDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5Eb2NrQ29udHJvbGxlcigpOwoKICAgIGlmIChXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc0RlZGljYXRlZFdvcmtlckZyb250ZW5kKCkpIHsKICAgICAgICAvLyBEbyBub3QgY3JlYXRlIHNvY2tldCBmb3IgdGhlIHdvcmtlciBmcm9udC1lbmQuCiAgICAgICAgV2ViSW5zcGVjdG9yLmRvTG9hZGVkRG9uZSgpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgd3M7CiAgICBpZiAoIndzIiBpbiBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QpCiAgICAgICAgd3MgPSAid3M6Ly8iICsgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LndzOwogICAgZWxzZSBpZiAoInBhZ2UiIGluIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdCkgewogICAgICAgIHZhciBwYWdlID0gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LnBhZ2U7CiAgICAgICAgdmFyIGhvc3QgPSAiaG9zdCIgaW4gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0ID8gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0Lmhvc3QgOiB3aW5kb3cubG9jYXRpb24uaG9zdDsKICAgICAgICB3cyA9ICJ3czovLyIgKyBob3N0ICsgIi9kZXZ0b29scy9wYWdlLyIgKyBwYWdlOwogICAgfQoKICAgIGlmICh3cykgewogICAgICAgIFdlYkluc3BlY3Rvci5zb2NrZXQgPSBuZXcgV2ViU29ja2V0KHdzKTsKICAgICAgICBXZWJJbnNwZWN0b3Iuc29ja2V0Lm9ubWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsgSW5zcGVjdG9yQmFja2VuZC5kaXNwYXRjaChtZXNzYWdlLmRhdGEpOyB9CiAgICAgICAgV2ViSW5zcGVjdG9yLnNvY2tldC5vbmVycm9yID0gZnVuY3Rpb24oZXJyb3IpIHsgY29uc29sZS5lcnJvcihlcnJvcik7IH0KICAgICAgICBXZWJJbnNwZWN0b3Iuc29ja2V0Lm9ub3BlbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3Quc2VuZE1lc3NhZ2VUb0JhY2tlbmQgPSBXZWJJbnNwZWN0b3Iuc29ja2V0LnNlbmQuYmluZChXZWJJbnNwZWN0b3Iuc29ja2V0KTsKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvTG9hZGVkRG9uZSgpOwogICAgICAgIH0KICAgICAgICBXZWJJbnNwZWN0b3Iuc29ja2V0Lm9uY2xvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3Iuc29ja2V0Ll9kZXRhY2hSZWFzb24pCiAgICAgICAgICAgICAgICAobmV3IFdlYkluc3BlY3Rvci5SZW1vdGVEZWJ1Z2dpbmdUZXJtaW5hdGVkU2NyZWVuKCJ3ZWJzb2NrZXRfY2xvc2VkIikpLnNob3dNb2RhbCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICB9CgogICAgV2ViSW5zcGVjdG9yLmRvTG9hZGVkRG9uZSgpOwoKICAgIC8vIEluIGNhc2Ugb2YgbG9hZGluZyBhcyBhIHdlYiBwYWdlIHdpdGggbm8gYmluZGluZ3MgLyBoYXJuZXNzLCBraWNrIG9mZiBpbml0aWFsaXphdGlvbiBtYW51YWxseS4KICAgIGlmIChJbnNwZWN0b3JGcm9udGVuZEhvc3QuaXNTdHViKSB7CiAgICAgICAgSW5zcGVjdG9yRnJvbnRlbmRBUEkuZGlzcGF0Y2hRdWVyeVBhcmFtZXRlcnMoKTsKICAgICAgICBXZWJJbnNwZWN0b3IuX2RvTG9hZGVkRG9uZVdpdGhDYXBhYmlsaXRpZXMoKTsKICAgIH0KfQoKV2ViSW5zcGVjdG9yLmRvTG9hZGVkRG9uZSA9IGZ1bmN0aW9uKCkKewogICAgLy8gSW5zdGFsbCBzdHlsZXMgYW5kIHRoZW1lcwogICAgV2ViSW5zcGVjdG9yLmluc3RhbGxQb3J0U3R5bGVzKCk7CiAgICBpZiAoV2ViSW5zcGVjdG9yLnNvY2tldCkKICAgICAgICBkb2N1bWVudC5ib2R5LmFkZFN0eWxlQ2xhc3MoInJlbW90ZSIpOwoKICAgIGlmIChXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QudG9vbGJhckNvbG9yICYmIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdC50ZXh0Q29sb3IpCiAgICAgICAgV2ViSW5zcGVjdG9yLnNldFRvb2xiYXJDb2xvcnMoV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LnRvb2xiYXJDb2xvciwgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LnRleHRDb2xvcik7CgogICAgV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIubG9hZGVkKCk7CgogICAgV29ya2VyQWdlbnQuY2FuSW5zcGVjdFdvcmtlcnMoV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgImNhbkluc3BlY3RXb3JrZXJzIiwgV2ViSW5zcGVjdG9yLl9kb0xvYWRlZERvbmVXaXRoQ2FwYWJpbGl0aWVzLmJpbmQoV2ViSW5zcGVjdG9yKSkpOwp9CgpXZWJJbnNwZWN0b3IuX2RvTG9hZGVkRG9uZVdpdGhDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbigpCnsKICAgIG5ldyBXZWJJbnNwZWN0b3IuVmVyc2lvbkNvbnRyb2xsZXIoKS51cGRhdGVWZXJzaW9uKCk7CgogICAgV2ViSW5zcGVjdG9yLnNob3J0Y3V0c1NjcmVlbiA9IG5ldyBXZWJJbnNwZWN0b3IuU2hvcnRjdXRzU2NyZWVuKCk7CiAgICB0aGlzLl9yZWdpc3RlclNob3J0Y3V0cygpOwoKICAgIC8vIHNldCBvcmRlciBvZiBzb21lIHNlY3Rpb25zIGV4cGxpY2l0bHkKICAgIFdlYkluc3BlY3Rvci5zaG9ydGN1dHNTY3JlZW4uc2VjdGlvbihXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNvbnNvbGUiKSk7CiAgICBXZWJJbnNwZWN0b3Iuc2hvcnRjdXRzU2NyZWVuLnNlY3Rpb24oV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJFbGVtZW50cyBQYW5lbCIpKTsKCiAgICB2YXIgcGFuZWxEZXNjcmlwdG9ycyA9IHRoaXMuX3BhbmVsRGVzY3JpcHRvcnMoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFuZWxEZXNjcmlwdG9ycy5sZW5ndGg7ICsraSkKICAgICAgICBwYW5lbERlc2NyaXB0b3JzW2ldLnJlZ2lzdGVyU2hvcnRjdXRzKCk7CgogICAgdGhpcy5jb25zb2xlID0gbmV3IFdlYkluc3BlY3Rvci5Db25zb2xlTW9kZWwoKTsKICAgIHRoaXMuY29uc29sZS5hZGRFdmVudExpc3RlbmVyKFdlYkluc3BlY3Rvci5Db25zb2xlTW9kZWwuRXZlbnRzLkNvbnNvbGVDbGVhcmVkLCB0aGlzLl9yZXNldEVycm9yQW5kV2FybmluZ0NvdW50cywgdGhpcyk7CiAgICB0aGlzLmNvbnNvbGUuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuQ29uc29sZU1vZGVsLkV2ZW50cy5NZXNzYWdlQWRkZWQsIHRoaXMuX3VwZGF0ZUVycm9yQW5kV2FybmluZ0NvdW50cywgdGhpcyk7CiAgICB0aGlzLmNvbnNvbGUuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuQ29uc29sZU1vZGVsLkV2ZW50cy5SZXBlYXRDb3VudFVwZGF0ZWQsIHRoaXMuX3VwZGF0ZUVycm9yQW5kV2FybmluZ0NvdW50cywgdGhpcyk7CgogICAgV2ViSW5zcGVjdG9yLkNTU01ldGFkYXRhLnJlcXVlc3RDU1NTaG9ydGhhbmREYXRhKCk7CgogICAgdGhpcy5kcmF3ZXIgPSBuZXcgV2ViSW5zcGVjdG9yLkRyYXdlcigpOwoKICAgIHRoaXMubmV0d29ya01hbmFnZXIgPSBuZXcgV2ViSW5zcGVjdG9yLk5ldHdvcmtNYW5hZ2VyKCk7CiAgICB0aGlzLnJlc291cmNlVHJlZU1vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5SZXNvdXJjZVRyZWVNb2RlbCh0aGlzLm5ldHdvcmtNYW5hZ2VyKTsKICAgIHRoaXMuZGVidWdnZXJNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuRGVidWdnZXJNb2RlbCgpOwogICAgdGhpcy5kZWJ1Z2dlck1vZGVsLmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkRlYnVnZ2VyTW9kZWwuRXZlbnRzLkRlYnVnZ2VyUGF1c2VkLCB0aGlzLl9kZWJ1Z2dlclBhdXNlZCwgdGhpcyk7CiAgICB0aGlzLm5ldHdvcmtMb2cgPSBuZXcgV2ViSW5zcGVjdG9yLk5ldHdvcmtMb2coKTsKICAgIHRoaXMuZG9tQWdlbnQgPSBuZXcgV2ViSW5zcGVjdG9yLkRPTUFnZW50KCk7CiAgICB0aGlzLmRvbUFnZW50LmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkRPTUFnZW50LkV2ZW50cy5JbnNwZWN0Tm9kZVJlcXVlc3RlZCwgdGhpcy5faW5zcGVjdE5vZGVSZXF1ZXN0ZWQsIHRoaXMpOwogICAgdGhpcy5ydW50aW1lTW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLlJ1bnRpbWVNb2RlbCh0aGlzLnJlc291cmNlVHJlZU1vZGVsKTsKCiAgICB0aGlzLmNvbnNvbGVWaWV3ID0gbmV3IFdlYkluc3BlY3Rvci5Db25zb2xlVmlldyhXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkpOwoKICAgIEluc3BlY3RvckJhY2tlbmQucmVnaXN0ZXJJbnNwZWN0b3JEaXNwYXRjaGVyKHRoaXMpOwoKICAgIHRoaXMuaXNvbGF0ZWRGaWxlU3lzdGVtTWFuYWdlciA9IG5ldyBXZWJJbnNwZWN0b3IuSXNvbGF0ZWRGaWxlU3lzdGVtTWFuYWdlcigpOwogICAgdGhpcy5pc29sYXRlZEZpbGVTeXN0ZW1EaXNwYXRjaGVyID0gbmV3IFdlYkluc3BlY3Rvci5Jc29sYXRlZEZpbGVTeXN0ZW1EaXNwYXRjaGVyKHRoaXMuaXNvbGF0ZWRGaWxlU3lzdGVtTWFuYWdlcik7CiAgICB0aGlzLndvcmtzcGFjZSA9IG5ldyBXZWJJbnNwZWN0b3IuV29ya3NwYWNlKHRoaXMuaXNvbGF0ZWRGaWxlU3lzdGVtTWFuYWdlci5tYXBwaW5nKCkpOwoKICAgIHRoaXMuY3NzTW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwodGhpcy53b3Jrc3BhY2UpOwogICAgdGhpcy50aW1lbGluZU1hbmFnZXIgPSBuZXcgV2ViSW5zcGVjdG9yLlRpbWVsaW5lTWFuYWdlcigpOwogICAgdGhpcy50cmFjaW5nQWdlbnQgPSBuZXcgV2ViSW5zcGVjdG9yLlRyYWNpbmdBZ2VudCgpOwogICAgdGhpcy5vdmVycmlkZXNTdXBwb3J0ID0gbmV3IFdlYkluc3BlY3Rvci5PdmVycmlkZXNTdXBwb3J0KCk7CgogICAgdGhpcy5zZWFyY2hDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5TZWFyY2hDb250cm9sbGVyKCk7CiAgICB0aGlzLmFkdmFuY2VkU2VhcmNoQ29udHJvbGxlciA9IG5ldyBXZWJJbnNwZWN0b3IuQWR2YW5jZWRTZWFyY2hDb250cm9sbGVyKCk7CiAgICBpZiAoIVdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmlzV29ya2VyRnJvbnRlbmQoKSkKICAgICAgICB0aGlzLmluc3BlY3RFbGVtZW50TW9kZUNvbnRyb2xsZXIgPSBuZXcgV2ViSW5zcGVjdG9yLkluc3BlY3RFbGVtZW50TW9kZUNvbnRyb2xsZXIoKTsKCiAgICB0aGlzLnNldHRpbmdzQ29udHJvbGxlciA9IG5ldyBXZWJJbnNwZWN0b3IuU2V0dGluZ3NDb250cm9sbGVyKCk7CgogICAgdGhpcy5kb21CcmVha3BvaW50c1NpZGViYXJQYW5lID0gbmV3IFdlYkluc3BlY3Rvci5ET01CcmVha3BvaW50c1NpZGViYXJQYW5lKCk7CgogICAgdGhpcy5fem9vbUxldmVsID0gV2ViSW5zcGVjdG9yLnNldHRpbmdzLnpvb21MZXZlbC5nZXQoKTsKICAgIGlmICh0aGlzLl96b29tTGV2ZWwpCiAgICAgICAgdGhpcy5fcmVxdWVzdFpvb20oKTsKCiAgICB2YXIgYXV0b3NlbGVjdFBhbmVsID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJhIHBhbmVsIGNob3NlbiBhdXRvbWF0aWNhbGx5Iik7CiAgICB2YXIgb3BlbkFuY2hvckxvY2F0aW9uU2V0dGluZyA9IFdlYkluc3BlY3Rvci5zZXR0aW5ncy5jcmVhdGVTZXR0aW5nKCJvcGVuTGlua0hhbmRsZXIiLCBhdXRvc2VsZWN0UGFuZWwpOwogICAgdGhpcy5vcGVuQW5jaG9yTG9jYXRpb25SZWdpc3RyeSA9IG5ldyBXZWJJbnNwZWN0b3IuSGFuZGxlclJlZ2lzdHJ5KG9wZW5BbmNob3JMb2NhdGlvblNldHRpbmcpOwogICAgdGhpcy5vcGVuQW5jaG9yTG9jYXRpb25SZWdpc3RyeS5yZWdpc3RlckhhbmRsZXIoYXV0b3NlbGVjdFBhbmVsLCBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9KTsKCiAgICB0aGlzLndvcmtzcGFjZUNvbnRyb2xsZXIgPSBuZXcgV2ViSW5zcGVjdG9yLldvcmtzcGFjZUNvbnRyb2xsZXIodGhpcy53b3Jrc3BhY2UpOwoKICAgIHRoaXMuZmlsZVN5c3RlbVdvcmtzcGFjZVByb3ZpZGVyID0gbmV3IFdlYkluc3BlY3Rvci5GaWxlU3lzdGVtV29ya3NwYWNlUHJvdmlkZXIodGhpcy5pc29sYXRlZEZpbGVTeXN0ZW1NYW5hZ2VyLCB0aGlzLndvcmtzcGFjZSk7CgogICAgdGhpcy5uZXR3b3JrV29ya3NwYWNlUHJvdmlkZXIgPSBuZXcgV2ViSW5zcGVjdG9yLlNpbXBsZVdvcmtzcGFjZVByb3ZpZGVyKHRoaXMud29ya3NwYWNlLCBXZWJJbnNwZWN0b3IucHJvamVjdFR5cGVzLk5ldHdvcmspOwogICAgbmV3IFdlYkluc3BlY3Rvci5OZXR3b3JrVUlTb3VyY2VDb2RlUHJvdmlkZXIodGhpcy5uZXR3b3JrV29ya3NwYWNlUHJvdmlkZXIsIHRoaXMud29ya3NwYWNlKTsKCiAgICB0aGlzLmJyZWFrcG9pbnRNYW5hZ2VyID0gbmV3IFdlYkluc3BlY3Rvci5CcmVha3BvaW50TWFuYWdlcihXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuYnJlYWtwb2ludHMsIHRoaXMuZGVidWdnZXJNb2RlbCwgdGhpcy53b3Jrc3BhY2UpOwoKICAgIHRoaXMuc2NyaXB0U25pcHBldE1vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5TY3JpcHRTbmlwcGV0TW9kZWwodGhpcy53b3Jrc3BhY2UpOwoKICAgIG5ldyBXZWJJbnNwZWN0b3IuRGVidWdnZXJTY3JpcHRNYXBwaW5nKHRoaXMud29ya3NwYWNlLCB0aGlzLm5ldHdvcmtXb3Jrc3BhY2VQcm92aWRlcik7CiAgICB0aGlzLmxpdmVFZGl0U3VwcG9ydCA9IG5ldyBXZWJJbnNwZWN0b3IuTGl2ZUVkaXRTdXBwb3J0KHRoaXMud29ya3NwYWNlKTsKICAgIHRoaXMuc3R5bGVDb250ZW50QmluZGluZyA9IG5ldyBXZWJJbnNwZWN0b3IuU3R5bGVDb250ZW50QmluZGluZyh0aGlzLmNzc01vZGVsLCB0aGlzLndvcmtzcGFjZSk7CiAgICBuZXcgV2ViSW5zcGVjdG9yLkNTU1N0eWxlU2hlZXRNYXBwaW5nKHRoaXMuY3NzTW9kZWwsIHRoaXMud29ya3NwYWNlLCB0aGlzLm5ldHdvcmtXb3Jrc3BhY2VQcm92aWRlcik7CiAgICBuZXcgV2ViSW5zcGVjdG9yLlByZXNlbnRhdGlvbkNvbnNvbGVNZXNzYWdlSGVscGVyKHRoaXMud29ya3NwYWNlKTsKCiAgICB0aGlzLl9jcmVhdGVHbG9iYWxTdGF0dXNCYXJJdGVtcygpOwoKICAgIHRoaXMudG9vbGJhciA9IG5ldyBXZWJJbnNwZWN0b3IuVG9vbGJhcigpOwogICAgV2ViSW5zcGVjdG9yLnN0YXJ0QmF0Y2hVcGRhdGUoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFuZWxEZXNjcmlwdG9ycy5sZW5ndGg7ICsraSkKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5hZGRQYW5lbChwYW5lbERlc2NyaXB0b3JzW2ldKTsKICAgIFdlYkluc3BlY3Rvci5lbmRCYXRjaFVwZGF0ZSgpOwoKICAgIHRoaXMuYWRkTWFpbkV2ZW50TGlzdGVuZXJzKGRvY3VtZW50KTsKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgdGhpcy53aW5kb3dSZXNpemUuYmluZCh0aGlzKSwgdHJ1ZSk7CgogICAgdmFyIGVycm9yV2FybmluZ0NvdW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVycm9yLXdhcm5pbmctY291bnQiKTsKICAgIGVycm9yV2FybmluZ0NvdW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5zaG93Q29uc29sZS5iaW5kKHRoaXMpLCBmYWxzZSk7CiAgICB0aGlzLl91cGRhdGVFcnJvckFuZFdhcm5pbmdDb3VudHMoKTsKCiAgICB0aGlzLmV4dGVuc2lvblNlcnZlci5pbml0RXh0ZW5zaW9ucygpOwoKICAgIHRoaXMuY29uc29sZS5lbmFibGVBZ2VudCgpOwoKICAgIGZ1bmN0aW9uIHNob3dJbml0aWFsUGFuZWwoKQogICAgewogICAgICAgIGlmICghV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkpCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoV2ViSW5zcGVjdG9yLnNldHRpbmdzLmxhc3RBY3RpdmVQYW5lbC5nZXQoKSk7CiAgICB9CgogICAgSW5zcGVjdG9yQWdlbnQuZW5hYmxlKHNob3dJbml0aWFsUGFuZWwpOwogICAgdGhpcy5kYXRhYmFzZU1vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5EYXRhYmFzZU1vZGVsKCk7CiAgICB0aGlzLmRvbVN0b3JhZ2VNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuRE9NU3RvcmFnZU1vZGVsKCk7CgogICAgUHJvZmlsZXJBZ2VudC5lbmFibGUoKTsKCiAgICBXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuZm9yY2VDb21wb3NpdGluZ01vZGUgPSBXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuY3JlYXRlQmFja2VuZFNldHRpbmcoImZvcmNlQ29tcG9zaXRpbmdNb2RlIiwgZmFsc2UsIFBhZ2VBZ2VudC5zZXRGb3JjZUNvbXBvc2l0aW5nTW9kZS5iaW5kKFBhZ2VBZ2VudCkpOwogICAgV2ViSW5zcGVjdG9yLnNldHRpbmdzLnNob3dQYWludFJlY3RzID0gV2ViSW5zcGVjdG9yLnNldHRpbmdzLmNyZWF0ZUJhY2tlbmRTZXR0aW5nKCJzaG93UGFpbnRSZWN0cyIsIGZhbHNlLCBQYWdlQWdlbnQuc2V0U2hvd1BhaW50UmVjdHMuYmluZChQYWdlQWdlbnQpKTsKICAgIFdlYkluc3BlY3Rvci5zZXR0aW5ncy5zaG93RGVidWdCb3JkZXJzID0gV2ViSW5zcGVjdG9yLnNldHRpbmdzLmNyZWF0ZUJhY2tlbmRTZXR0aW5nKCJzaG93RGVidWdCb3JkZXJzIiwgZmFsc2UsIFBhZ2VBZ2VudC5zZXRTaG93RGVidWdCb3JkZXJzLmJpbmQoUGFnZUFnZW50KSk7CiAgICBXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuY29udGludW91c1BhaW50aW5nID0gV2ViSW5zcGVjdG9yLnNldHRpbmdzLmNyZWF0ZUJhY2tlbmRTZXR0aW5nKCJjb250aW51b3VzUGFpbnRpbmciLCBmYWxzZSwgUGFnZUFnZW50LnNldENvbnRpbnVvdXNQYWludGluZ0VuYWJsZWQuYmluZChQYWdlQWdlbnQpKTsKICAgIFdlYkluc3BlY3Rvci5zZXR0aW5ncy5zaG93RlBTQ291bnRlciA9IFdlYkluc3BlY3Rvci5zZXR0aW5ncy5jcmVhdGVCYWNrZW5kU2V0dGluZygic2hvd0ZQU0NvdW50ZXIiLCBmYWxzZSwgUGFnZUFnZW50LnNldFNob3dGUFNDb3VudGVyLmJpbmQoUGFnZUFnZW50KSk7CiAgICBXZWJJbnNwZWN0b3Iuc2V0dGluZ3Muc2hvd1Njcm9sbEJvdHRsZW5lY2tSZWN0cyA9IFdlYkluc3BlY3Rvci5zZXR0aW5ncy5jcmVhdGVCYWNrZW5kU2V0dGluZygic2hvd1Njcm9sbEJvdHRsZW5lY2tSZWN0cyIsIGZhbHNlLCBQYWdlQWdlbnQuc2V0U2hvd1Njcm9sbEJvdHRsZW5lY2tSZWN0cy5iaW5kKFBhZ2VBZ2VudCkpOwoKICAgIFdlYkluc3BlY3Rvci5zZXR0aW5ncy5zaG93TWV0cmljc1J1bGVycy5hZGRDaGFuZ2VMaXN0ZW5lcihzaG93UnVsZXJzQ2hhbmdlZCk7CiAgICBmdW5jdGlvbiBzaG93UnVsZXJzQ2hhbmdlZCgpCiAgICB7CiAgICAgICAgUGFnZUFnZW50LnNldFNob3dWaWV3cG9ydFNpemVPblJlc2l6ZSh0cnVlLCBXZWJJbnNwZWN0b3Iuc2V0dGluZ3Muc2hvd01ldHJpY3NSdWxlcnMuZ2V0KCkpOwogICAgfQogICAgc2hvd1J1bGVyc0NoYW5nZWQoKTsKCiAgICBXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5sb2FkQ29tcGxldGVkKCk7CiAgICBJbnNwZWN0b3JGcm9udGVuZEFQSS5sb2FkQ29tcGxldGVkKCk7CgogICAgV2ViSW5zcGVjdG9yLm5vdGlmaWNhdGlvbnMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5FdmVudHMuSW5zcGVjdG9yTG9hZGVkKTsKfQoKdmFyIHdpbmRvd0xvYWRlZCA9IGZ1bmN0aW9uKCkKewogICAgV2ViSW5zcGVjdG9yLmxvYWRlZCgpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCB3aW5kb3dMb2FkZWQsIGZhbHNlKTsKICAgIGRlbGV0ZSB3aW5kb3dMb2FkZWQ7Cn07Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIHdpbmRvd0xvYWRlZCwgZmFsc2UpOwoKLy8gV2UnZCBsaWtlIHRvIGVuZm9yY2UgYXN5bmNocm9ub3VzIGludGVyYWN0aW9uIGJldHdlZW4gdGhlIGluc3BlY3RvciBjb250cm9sbGVyIGFuZCB0aGUgZnJvbnRlbmQuCi8vIEl0IGlzIG5lZWRlZCB0byBwcmV2ZW50IHJlLWVudGVyaW5nIHRoZSBiYWNrZW5kIGNvZGUuCi8vIEFsc28sIG5hdGl2ZSBkaXNwYXRjaGVzIGRvIG5vdCBndWFyYW50ZWUgc2V0VGltZW91dHMgdG8gYmUgc2VyaWFsaXplZCwgc28gd2UKLy8gZW5mb3JjZSBzZXJpYWxpemF0aW9uIHVzaW5nICdtZXNzYWdlc1RvRGlzcGF0Y2gnIHF1ZXVlLiBJdCBpcyBhbHNvIGltcG9ydGFudCB0aGF0IEpTQyBkZWJ1Z2dlcgovLyB0ZXN0cyByZXF1aXJlIHRoYXQgZWFjaCBjb21tYW5kIHdhcyBkaXNwYXRjaCB3aXRoaW4gaW5kaXZpZHVhbCB0aW1lb3V0IGNhbGxiYWNrLCBzbyB3ZSBkb24ndCBiYXRjaCB0aGVtLgoKdmFyIG1lc3NhZ2VzVG9EaXNwYXRjaCA9IFtdOwoKV2ViSW5zcGVjdG9yLmRpc3BhdGNoUXVldWVJc0VtcHR5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbWVzc2FnZXNUb0Rpc3BhdGNoLmxlbmd0aCA9PSAwOwp9CgpXZWJJbnNwZWN0b3IuZGlzcGF0Y2ggPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICBtZXNzYWdlc1RvRGlzcGF0Y2gucHVzaChtZXNzYWdlKTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgSW5zcGVjdG9yQmFja2VuZC5kaXNwYXRjaChtZXNzYWdlc1RvRGlzcGF0Y2guc2hpZnQoKSk7CiAgICB9LCAwKTsKfQoKV2ViSW5zcGVjdG9yLndpbmRvd1Jlc2l6ZSA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAoV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcpCiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuZG9SZXNpemUoKTsKICAgIGlmIChXZWJJbnNwZWN0b3IuZHJhd2VyKQogICAgICAgIFdlYkluc3BlY3Rvci5kcmF3ZXIucmVzaXplKCk7CiAgICBpZiAoV2ViSW5zcGVjdG9yLnRvb2xiYXIpCiAgICAgICAgV2ViSW5zcGVjdG9yLnRvb2xiYXIucmVzaXplKCk7CiAgICBpZiAoV2ViSW5zcGVjdG9yLnNldHRpbmdzQ29udHJvbGxlcikKICAgICAgICBXZWJJbnNwZWN0b3Iuc2V0dGluZ3NDb250cm9sbGVyLnJlc2l6ZSgpOwogICAgaWYgKFdlYkluc3BlY3Rvci5fc2NyZWVuY2FzdFNwbGl0VmlldykKICAgICAgICBXZWJJbnNwZWN0b3IuX3NjcmVlbmNhc3RTcGxpdFZpZXcuZG9SZXNpemUoKTsKfQoKV2ViSW5zcGVjdG9yLnNldERvY2tpbmdVbmF2YWlsYWJsZSA9IGZ1bmN0aW9uKHVuYXZhaWxhYmxlKQp7CiAgICBpZiAodGhpcy5kb2NrQ29udHJvbGxlcikKICAgICAgICB0aGlzLmRvY2tDb250cm9sbGVyLnNldERvY2tpbmdVbmF2YWlsYWJsZSh1bmF2YWlsYWJsZSk7Cn0KCldlYkluc3BlY3Rvci5jbG9zZSA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAodGhpcy5faXNDbG9zaW5nKQogICAgICAgIHJldHVybjsKICAgIHRoaXMuX2lzQ2xvc2luZyA9IHRydWU7CiAgICB0aGlzLm5vdGlmaWNhdGlvbnMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5FdmVudHMuSW5zcGVjdG9yQ2xvc2luZyk7CiAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3QuY2xvc2VXaW5kb3coKTsKfQoKV2ViSW5zcGVjdG9yLmRvY3VtZW50Q2xpY2sgPSBmdW5jdGlvbihldmVudCkKewogICAgdmFyIGFuY2hvciA9IGV2ZW50LnRhcmdldC5lbmNsb3NpbmdOb2RlT3JTZWxmV2l0aE5vZGVOYW1lKCJhIik7CiAgICBpZiAoIWFuY2hvciB8fCAoYW5jaG9yLnRhcmdldCA9PT0gIl9ibGFuayIpKQogICAgICAgIHJldHVybjsKCiAgICAvLyBQcmV2ZW50IHRoZSBsaW5rIGZyb20gbmF2aWdhdGluZywgc2luY2Ugd2UgZG9uJ3QgZG8gYW55IG5hdmlnYXRpb24gYnkgZm9sbG93aW5nIGxpbmtzIG5vcm1hbGx5LgogICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKCiAgICBmdW5jdGlvbiBmb2xsb3dMaW5rKCkKICAgIHsKICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLmlzQmVpbmdFZGl0ZWQoZXZlbnQudGFyZ2V0KSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGlmIChXZWJJbnNwZWN0b3Iub3BlbkFuY2hvckxvY2F0aW9uUmVnaXN0cnkuZGlzcGF0Y2goeyB1cmw6IGFuY2hvci5ocmVmLCBsaW5lTnVtYmVyOiBhbmNob3IubGluZU51bWJlcn0pKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5zaG93QW5jaG9yTG9jYXRpb24oYW5jaG9yKSkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBjb25zdCBwcm9maWxlTWF0Y2ggPSBXZWJJbnNwZWN0b3IuUHJvZmlsZXNQYW5lbERlc2NyaXB0b3IuUHJvZmlsZVVSTFJlZ0V4cC5leGVjKGFuY2hvci5ocmVmKTsKICAgICAgICBpZiAocHJvZmlsZU1hdGNoKSB7CiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoInByb2ZpbGVzIikuc2hvd1Byb2ZpbGUocHJvZmlsZU1hdGNoWzFdLCBwcm9maWxlTWF0Y2hbMl0pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFyc2VkVVJMID0gYW5jaG9yLmhyZWYuYXNQYXJzZWRVUkwoKTsKICAgICAgICBpZiAocGFyc2VkVVJMICYmIHBhcnNlZFVSTC5zY2hlbWUgPT09ICJ3ZWJraXQtbGluay1hY3Rpb24iKSB7CiAgICAgICAgICAgIGlmIChwYXJzZWRVUkwuaG9zdCA9PT0gInNob3ctcGFuZWwiKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFuZWwgPSBwYXJzZWRVUkwucGF0aC5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLnBhbmVsKHBhbmVsKSkKICAgICAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKHBhbmVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3Qub3BlbkluTmV3VGFiKGFuY2hvci5ocmVmKTsKICAgIH0KCiAgICBpZiAoV2ViSW5zcGVjdG9yLmZvbGxvd0xpbmtUaW1lb3V0KQogICAgICAgIGNsZWFyVGltZW91dChXZWJJbnNwZWN0b3IuZm9sbG93TGlua1RpbWVvdXQpOwoKICAgIGlmIChhbmNob3IucHJldmVudEZvbGxvd09uRG91YmxlQ2xpY2spIHsKICAgICAgICAvLyBTdGFydCBhIHRpbWVvdXQgaWYgdGhpcyBpcyB0aGUgZmlyc3QgY2xpY2ssIGlmIHRoZSB0aW1lb3V0IGlzIGNhbmNlbGVkCiAgICAgICAgLy8gYmVmb3JlIGl0IGZpcmVzLCB0aGVuIGEgZG91YmxlIGNsaWNrZWQgaGFwcGVuZWQgb3IgYW5vdGhlciBsaW5rIHdhcyBjbGlja2VkLgogICAgICAgIGlmIChldmVudC5kZXRhaWwgPT09IDEpCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5mb2xsb3dMaW5rVGltZW91dCA9IHNldFRpbWVvdXQoZm9sbG93TGluaywgMzMzKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgZm9sbG93TGluaygpOwp9CgpXZWJJbnNwZWN0b3Iub3BlblJlc291cmNlID0gZnVuY3Rpb24ocmVzb3VyY2VVUkwsIGluUmVzb3VyY2VzUGFuZWwpCnsKICAgIHZhciByZXNvdXJjZSA9IFdlYkluc3BlY3Rvci5yZXNvdXJjZUZvclVSTChyZXNvdXJjZVVSTCk7CiAgICBpZiAoaW5SZXNvdXJjZXNQYW5lbCAmJiByZXNvdXJjZSkKICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJyZXNvdXJjZXMiKS5zaG93UmVzb3VyY2UocmVzb3VyY2UpOwogICAgZWxzZQogICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5vcGVuSW5OZXdUYWIocmVzb3VyY2VVUkwpOwp9CgpXZWJJbnNwZWN0b3IuX3JlZ2lzdGVyU2hvcnRjdXRzID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgc2hvcnRjdXQgPSBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dDsKICAgIHZhciBzZWN0aW9uID0gV2ViSW5zcGVjdG9yLnNob3J0Y3V0c1NjcmVlbi5zZWN0aW9uKFdlYkluc3BlY3Rvci5VSVN0cmluZygiQWxsIFBhbmVscyIpKTsKICAgIHZhciBrZXlzID0gWwogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJbIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpLAogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJdIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpCiAgICBdOwogICAgc2VjdGlvbi5hZGRSZWxhdGVkS2V5cyhrZXlzLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkdvIHRvIHRoZSBwYW5lbCB0byB0aGUgbGVmdC9yaWdodCIpKTsKCiAgICBrZXlzID0gWwogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJbIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEgfCBzaG9ydGN1dC5Nb2RpZmllcnMuQWx0KSwKICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiXSIsIHNob3J0Y3V0Lk1vZGlmaWVycy5DdHJsT3JNZXRhIHwgc2hvcnRjdXQuTW9kaWZpZXJzLkFsdCkKICAgIF07CiAgICBzZWN0aW9uLmFkZFJlbGF0ZWRLZXlzKGtleXMsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiR28gYmFjay9mb3J3YXJkIGluIHBhbmVsIGhpc3RvcnkiKSk7CgogICAgdmFyIHRvZ2dsZUNvbnNvbGVMYWJlbCA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiVG9nZ2xlIGNvbnNvbGUiKTsKICAgIGlmIChXZWJJbnNwZWN0b3IuZXhwZXJpbWVudHNTZXR0aW5ncy5vcGVuQ29uc29sZVdpdGhDdHJsVGlsZGUuaXNFbmFibGVkKCkpCiAgICAgICAgc2VjdGlvbi5hZGRLZXkoc2hvcnRjdXQubWFrZURlc2NyaXB0b3Ioc2hvcnRjdXQuS2V5cy5Fc2MpLCB0b2dnbGVDb25zb2xlTGFiZWwpOwogICAgZWxzZQogICAgICAgIHNlY3Rpb24uYWRkS2V5KHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKHNob3J0Y3V0LktleXMuVGlsZGUsIHNob3J0Y3V0Lk1vZGlmaWVycy5DdHJsT3JNZXRhKSwgdG9nZ2xlQ29uc29sZUxhYmVsKTsKICAgIHNlY3Rpb24uYWRkS2V5KHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJmIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlNlYXJjaCIpKTsKCiAgICB2YXIgYWR2YW5jZWRTZWFyY2hTaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5BZHZhbmNlZFNlYXJjaENvbnRyb2xsZXIuY3JlYXRlU2hvcnRjdXQoKTsKICAgIHNlY3Rpb24uYWRkS2V5KGFkdmFuY2VkU2VhcmNoU2hvcnRjdXQsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2VhcmNoIGFjcm9zcyBhbGwgc291cmNlcyIpKTsKCiAgICB2YXIgaW5zcGVjdEVsZW1lbnRNb2RlU2hvcnRjdXQgPSBXZWJJbnNwZWN0b3IuSW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlci5jcmVhdGVTaG9ydGN1dCgpOwogICAgc2VjdGlvbi5hZGRLZXkoaW5zcGVjdEVsZW1lbnRNb2RlU2hvcnRjdXQsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2VsZWN0IG5vZGUgdG8gaW5zcGVjdCIpKTsKCiAgICB2YXIgb3BlblJlc291cmNlU2hvcnRjdXQgPSBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigibyIsIFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0Lk1vZGlmaWVycy5DdHJsT3JNZXRhKTsKICAgIHNlY3Rpb24uYWRkS2V5KG9wZW5SZXNvdXJjZVNob3J0Y3V0LCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkdvIHRvIHNvdXJjZSIpKTsKCiAgICBpZiAoV2ViSW5zcGVjdG9yLmlzTWFjKCkpIHsKICAgICAgICBrZXlzID0gWwogICAgICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiZyIsIHNob3J0Y3V0Lk1vZGlmaWVycy5NZXRhKSwKICAgICAgICAgICAgc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoImciLCBzaG9ydGN1dC5Nb2RpZmllcnMuTWV0YSB8IHNob3J0Y3V0Lk1vZGlmaWVycy5TaGlmdCkKICAgICAgICBdOwogICAgICAgIHNlY3Rpb24uYWRkUmVsYXRlZEtleXMoa2V5cywgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJGaW5kIG5leHQvcHJldmlvdXMiKSk7CiAgICB9CgogICAgdmFyIGdvVG9TaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5Hb1RvTGluZURpYWxvZy5jcmVhdGVTaG9ydGN1dCgpOwogICAgc2VjdGlvbi5hZGRLZXkoZ29Ub1Nob3J0Y3V0LCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkdvIHRvIGxpbmUiKSk7CgogICAga2V5cyA9IFsKICAgICAgICBzaG9ydGN1dC5LZXlzLkYxLAogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCI/IikKICAgIF07CiAgICBzZWN0aW9uLmFkZEFsdGVybmF0ZUtleXMoa2V5cywgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTaG93IGdlbmVyYWwgc2V0dGluZ3MiKSk7Cn0KCi8qKgogKiBAcGFyYW0ge0tleWJvYXJkRXZlbnR9IGV2ZW50CiAqLwpXZWJJbnNwZWN0b3IuZG9jdW1lbnRLZXlEb3duID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmIChXZWJJbnNwZWN0b3IuY3VycmVudEZvY3VzRWxlbWVudCgpICYmIFdlYkluc3BlY3Rvci5jdXJyZW50Rm9jdXNFbGVtZW50KCkuaGFuZGxlS2V5RXZlbnQpIHsKICAgICAgICBXZWJJbnNwZWN0b3IuY3VycmVudEZvY3VzRWxlbWVudCgpLmhhbmRsZUtleUV2ZW50KGV2ZW50KTsKICAgICAgICBpZiAoZXZlbnQuaGFuZGxlZCkgewogICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKSkgewogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpLmhhbmRsZVNob3J0Y3V0KGV2ZW50KTsKICAgICAgICBpZiAoZXZlbnQuaGFuZGxlZCkgewogICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIGlmIChXZWJJbnNwZWN0b3Iuc2VhcmNoQ29udHJvbGxlci5oYW5kbGVTaG9ydGN1dChldmVudCkpCiAgICAgICAgcmV0dXJuOwogICAgaWYgKFdlYkluc3BlY3Rvci5hZHZhbmNlZFNlYXJjaENvbnRyb2xsZXIuaGFuZGxlU2hvcnRjdXQoZXZlbnQpKQogICAgICAgIHJldHVybjsKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlciAmJiBXZWJJbnNwZWN0b3IuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlci5oYW5kbGVTaG9ydGN1dChldmVudCkpCiAgICAgICAgcmV0dXJuOwoKICAgIHN3aXRjaCAoZXZlbnQua2V5SWRlbnRpZmllcikgewogICAgICAgIGNhc2UgIlUrMDA0RiI6IC8vIE8ga2V5CiAgICAgICAgY2FzZSAiVSswMDUwIjogLy8gUCBrZXkKICAgICAgICAgICAgaWYgKCFldmVudC5zaGlmdEtleSAmJiAhZXZlbnQuYWx0S2V5ICYmIFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0LmV2ZW50SGFzQ3RybE9yTWV0YShldmVudCkpIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoInNjcmlwdHMiKS5zaG93R29Ub1NvdXJjZURpYWxvZygpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJVKzAwNTIiOiAvLyBSIGtleQogICAgICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLktleWJvYXJkU2hvcnRjdXQuZXZlbnRIYXNDdHJsT3JNZXRhKGV2ZW50KSkgewogICAgICAgICAgICAgICAgRGVidWdnZXJBZ2VudC5zZXRTa2lwQWxsUGF1c2VzKHRydWUsIHRydWUpOwogICAgICAgICAgICAgICAgUGFnZUFnZW50LnJlbG9hZChldmVudC5zaGlmdEtleSk7CiAgICAgICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuREVCVUcgJiYgZXZlbnQuYWx0S2V5KSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IucmVsb2FkKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiRjUiOgogICAgICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5pc01hYygpKSB7CiAgICAgICAgICAgICAgICBQYWdlQWdlbnQucmVsb2FkKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQuc2hpZnRLZXkpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgaXNWYWxpZFpvb21TaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0LmV2ZW50SGFzQ3RybE9yTWV0YShldmVudCkgJiYKICAgICAgICAhZXZlbnQuYWx0S2V5ICYmCiAgICAgICAgIUluc3BlY3RvckZyb250ZW5kSG9zdC5pc1N0dWI7CiAgICBzd2l0Y2ggKGV2ZW50LmtleUNvZGUpIHsKICAgICAgICBjYXNlIDEwNzogLy8gKwogICAgICAgIGNhc2UgMTg3OiAvLyArCiAgICAgICAgICAgIGlmIChpc1ZhbGlkWm9vbVNob3J0Y3V0KSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuX3pvb21JbigpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDEwOTogLy8gLQogICAgICAgIGNhc2UgMTg5OiAvLyAtCiAgICAgICAgICAgIGlmIChpc1ZhbGlkWm9vbVNob3J0Y3V0KSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuX3pvb21PdXQoKTsKICAgICAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSA0ODogLy8gMAogICAgICAgICAgICAvLyBab29tIHJlc2V0IHNob3J0Y3V0IGRvZXMgbm90IGFsbG93ICJTaGlmdCIgd2hlbiBoYW5kbGVkIGJ5IHRoZSBicm93c2VyLgogICAgICAgICAgICBpZiAoaXNWYWxpZFpvb21TaG9ydGN1dCAmJiAhZXZlbnQuc2hpZnRLZXkpIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5fcmVzZXRab29tKCk7CiAgICAgICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgfQp9CgpXZWJJbnNwZWN0b3IucG9zdERvY3VtZW50S2V5RG93biA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBjb25zdCBoZWxwS2V5ID0gV2ViSW5zcGVjdG9yLmlzTWFjKCkgPyAiVSswMDNGIiA6ICJVKzAwQkYiOyAvLyAiPyIgZm9yIGJvdGggcGxhdGZvcm1zCgogICAgaWYgKGV2ZW50LmtleUlkZW50aWZpZXIgPT09ICJGMSIgfHwKICAgICAgICAoZXZlbnQua2V5SWRlbnRpZmllciA9PT0gaGVscEtleSAmJiBldmVudC5zaGlmdEtleSAmJiAoIVdlYkluc3BlY3Rvci5pc0JlaW5nRWRpdGVkKGV2ZW50LnRhcmdldCkgfHwgZXZlbnQubWV0YUtleSkpKSB7CiAgICAgICAgdGhpcy5zZXR0aW5nc0NvbnRyb2xsZXIuc2hvd1NldHRpbmdzU2NyZWVuKFdlYkluc3BlY3Rvci5TZXR0aW5nc1NjcmVlbi5UYWJzLkdlbmVyYWwpOwogICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IEVzYyA9ICJVKzAwMUIiOwoKICAgIGlmIChldmVudC5oYW5kbGVkKQogICAgICAgIHJldHVybjsKCiAgICB2YXIgb3BlbkNvbnNvbGVXaXRoQ3RybFRpbGRlRW5hYmxlZCA9IFdlYkluc3BlY3Rvci5leHBlcmltZW50c1NldHRpbmdzLm9wZW5Db25zb2xlV2l0aEN0cmxUaWxkZS5pc0VuYWJsZWQoKTsKICAgIGlmIChldmVudC5rZXlJZGVudGlmaWVyID09PSBFc2MpIHsKICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLnNlYXJjaENvbnRyb2xsZXIuaXNTZWFyY2hWaXNpYmxlKCkpIHsKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLnNlYXJjaENvbnRyb2xsZXIuY2xvc2VTZWFyY2goKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBJZiBkcmF3ZXIgaXMgb3BlbiB3aXRoIHNvbWUgdmlldyBvdGhlciB0aGFuIGNvbnNvbGUgdGhlbiBjbG9zZSBpdC4KICAgICAgICBpZiAoIXRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udG9nZ2xlZCAmJiBXZWJJbnNwZWN0b3IuZHJhd2VyLnZpc2libGUpCiAgICAgICAgICAgIHRoaXMuY2xvc2VWaWV3SW5EcmF3ZXIoKTsKICAgICAgICBlbHNlIGlmICh0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRvZ2dsZWQgfHwgIW9wZW5Db25zb2xlV2l0aEN0cmxUaWxkZUVuYWJsZWQpCiAgICAgICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b25DbGlja2VkKCk7CiAgICB9CgogICAgaWYgKFdlYkluc3BlY3Rvci5leHBlcmltZW50c1NldHRpbmdzLm9wZW5Db25zb2xlV2l0aEN0cmxUaWxkZS5pc0VuYWJsZWQoKSkgewogICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dC5LZXlzLlRpbGRlLmNvZGUgJiYgV2ViSW5zcGVjdG9yLktleWJvYXJkU2hvcnRjdXQuZXZlbnRIYXNDdHJsT3JNZXRhKGV2ZW50KSkKICAgICAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbkNsaWNrZWQoKTsKICAgIH0KfQoKV2ViSW5zcGVjdG9yLmRvY3VtZW50Q2FuQ29weSA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAoV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkgJiYgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkuaGFuZGxlQ29weUV2ZW50KQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cn0KCldlYkluc3BlY3Rvci5kb2N1bWVudENvcHkgPSBmdW5jdGlvbihldmVudCkKewogICAgaWYgKFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpICYmIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpLmhhbmRsZUNvcHlFdmVudCkKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKS5oYW5kbGVDb3B5RXZlbnQoZXZlbnQpOwogICAgV2ViSW5zcGVjdG9yLmRvY3VtZW50Q29weUV2ZW50RmlyZWQoZXZlbnQpOwp9CgpXZWJJbnNwZWN0b3IuZG9jdW1lbnRDb3B5RXZlbnRGaXJlZCA9IGZ1bmN0aW9uKGV2ZW50KQp7Cn0KCldlYkluc3BlY3Rvci5jb250ZXh0TWVudUV2ZW50RmlyZWQgPSBmdW5jdGlvbihldmVudCkKewogICAgaWYgKGV2ZW50LmhhbmRsZWQgfHwgZXZlbnQudGFyZ2V0Lmhhc1N0eWxlQ2xhc3MoInBvcHVwLWdsYXNzcGFuZSIpKQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cn0KCldlYkluc3BlY3Rvci5zaG93UGFuZWwgPSBmdW5jdGlvbihwYW5lbCkKewogICAgcmV0dXJuIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LnNob3dQYW5lbChwYW5lbCk7Cn0KCldlYkluc3BlY3Rvci5wYW5lbCA9IGZ1bmN0aW9uKHBhbmVsKQp7CiAgICByZXR1cm4gV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcucGFuZWwocGFuZWwpOwp9CgpXZWJJbnNwZWN0b3IuYnJpbmdUb0Zyb250ID0gZnVuY3Rpb24oKQp7CiAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3QuYnJpbmdUb0Zyb250KCk7Cn0KCi8qKgogKiBAcGFyYW0ge3N0cmluZz19IG1lc3NhZ2VMZXZlbAogKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93Q29uc29sZQogKi8KV2ViSW5zcGVjdG9yLmxvZyA9IGZ1bmN0aW9uKG1lc3NhZ2UsIG1lc3NhZ2VMZXZlbCwgc2hvd0NvbnNvbGUpCnsKICAgIC8vIHJlbWVtYmVyICd0aGlzJyBmb3Igc2V0SW50ZXJ2YWwoKSBjYWxsYmFjawogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIHJldHVybiBpbmRpY2F0aW9uIGlmIHdlIGNhbiBhY3R1YWxseSBsb2cgYSBtZXNzYWdlCiAgICBmdW5jdGlvbiBpc0xvZ0F2YWlsYWJsZSgpCiAgICB7CiAgICAgICAgcmV0dXJuIFdlYkluc3BlY3Rvci5Db25zb2xlTWVzc2FnZSAmJiBXZWJJbnNwZWN0b3IuUmVtb3RlT2JqZWN0ICYmIHNlbGYuY29uc29sZTsKICAgIH0KCiAgICAvLyBmbHVzaCB0aGUgcXVldWUgb2YgcGVuZGluZyBtZXNzYWdlcwogICAgZnVuY3Rpb24gZmx1c2hRdWV1ZSgpCiAgICB7CiAgICAgICAgdmFyIHF1ZXVlZCA9IFdlYkluc3BlY3Rvci5sb2cucXVldWVkOwogICAgICAgIGlmICghcXVldWVkKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVkLmxlbmd0aDsgKytpKQogICAgICAgICAgICBsb2dNZXNzYWdlKHF1ZXVlZFtpXSk7CgogICAgICAgIGRlbGV0ZSBXZWJJbnNwZWN0b3IubG9nLnF1ZXVlZDsKICAgIH0KCiAgICAvLyBmbHVzaCB0aGUgcXVldWUgaWYgaXQgY29uc29sZSBpcyBhdmFpbGFibGUKICAgIC8vIC0gdGhpcyBmdW5jdGlvbiBpcyBydW4gb24gYW4gaW50ZXJ2YWwKICAgIGZ1bmN0aW9uIGZsdXNoUXVldWVJZkF2YWlsYWJsZSgpCiAgICB7CiAgICAgICAgaWYgKCFpc0xvZ0F2YWlsYWJsZSgpKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGNsZWFySW50ZXJ2YWwoV2ViSW5zcGVjdG9yLmxvZy5pbnRlcnZhbCk7CiAgICAgICAgZGVsZXRlIFdlYkluc3BlY3Rvci5sb2cuaW50ZXJ2YWw7CgogICAgICAgIGZsdXNoUXVldWUoKTsKICAgIH0KCiAgICAvLyBhY3R1YWxseSBsb2cgdGhlIG1lc3NhZ2UKICAgIGZ1bmN0aW9uIGxvZ01lc3NhZ2UobWVzc2FnZSkKICAgIHsKICAgICAgICAvLyBwb3N0IHRoZSBtZXNzYWdlCiAgICAgICAgdmFyIG1zZyA9IFdlYkluc3BlY3Rvci5Db25zb2xlTWVzc2FnZS5jcmVhdGUoCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5Db25zb2xlTWVzc2FnZS5NZXNzYWdlU291cmNlLk90aGVyLAogICAgICAgICAgICBtZXNzYWdlTGV2ZWwgfHwgV2ViSW5zcGVjdG9yLkNvbnNvbGVNZXNzYWdlLk1lc3NhZ2VMZXZlbC5EZWJ1ZywKICAgICAgICAgICAgbWVzc2FnZSk7CgogICAgICAgIHNlbGYuY29uc29sZS5hZGRNZXNzYWdlKG1zZyk7CiAgICAgICAgaWYgKHNob3dDb25zb2xlKQogICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd0NvbnNvbGUoKTsKICAgIH0KCiAgICAvLyBpZiB3ZSBjYW4ndCBsb2cgdGhlIG1lc3NhZ2UsIHF1ZXVlIGl0CiAgICBpZiAoIWlzTG9nQXZhaWxhYmxlKCkpIHsKICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5sb2cucXVldWVkKQogICAgICAgICAgICBXZWJJbnNwZWN0b3IubG9nLnF1ZXVlZCA9IFtdOwoKICAgICAgICBXZWJJbnNwZWN0b3IubG9nLnF1ZXVlZC5wdXNoKG1lc3NhZ2UpOwoKICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5sb2cuaW50ZXJ2YWwpCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5sb2cuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmbHVzaFF1ZXVlSWZBdmFpbGFibGUsIDEwMDApOwoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gZmx1c2ggdGhlIHBlbmRpbmcgcXVldWUgaWYgYW55CiAgICBmbHVzaFF1ZXVlKCk7CgogICAgLy8gbG9nIHRoZSBtZXNzYWdlCiAgICBsb2dNZXNzYWdlKG1lc3NhZ2UpOwp9CgpXZWJJbnNwZWN0b3Iuc2hvd0Vycm9yTWVzc2FnZSA9IGZ1bmN0aW9uKGVycm9yKQp7CiAgICBXZWJJbnNwZWN0b3IubG9nKGVycm9yLCBXZWJJbnNwZWN0b3IuQ29uc29sZU1lc3NhZ2UuTWVzc2FnZUxldmVsLkVycm9yLCB0cnVlKTsKfQoKLy8gSW5zcGVjdG9yLmluc3BlY3QgcHJvdG9jb2wgZXZlbnQKV2ViSW5zcGVjdG9yLmluc3BlY3QgPSBmdW5jdGlvbihwYXlsb2FkLCBoaW50cykKewogICAgdmFyIG9iamVjdCA9IFdlYkluc3BlY3Rvci5SZW1vdGVPYmplY3QuZnJvbVBheWxvYWQocGF5bG9hZCk7CiAgICBpZiAob2JqZWN0LnN1YnR5cGUgPT09ICJub2RlIikgewogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKG5vZGVJZCkKICAgICAgICB7CiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5fdXBkYXRlRm9jdXNlZE5vZGUobm9kZUlkKTsKICAgICAgICAgICAgb2JqZWN0LnJlbGVhc2UoKTsKICAgICAgICB9CiAgICAgICAgb2JqZWN0LnB1c2hOb2RlVG9Gcm9udGVuZChjYWxsYmFjayk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChvYmplY3QudHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGZ1bmN0aW9uIGRpZEdldERldGFpbHMoZXJyb3IsIHJlc3BvbnNlKQogICAgICAgIHsKICAgICAgICAgICAgb2JqZWN0LnJlbGVhc2UoKTsKCiAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB1aUxvY2F0aW9uID0gV2ViSW5zcGVjdG9yLmRlYnVnZ2VyTW9kZWwucmF3TG9jYXRpb25Ub1VJTG9jYXRpb24ocmVzcG9uc2UubG9jYXRpb24pOwogICAgICAgICAgICBpZiAoIXVpTG9jYXRpb24pCiAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJzY3JpcHRzIikuc2hvd1VJTG9jYXRpb24odWlMb2NhdGlvbik7CiAgICAgICAgfQogICAgICAgIERlYnVnZ2VyQWdlbnQuZ2V0RnVuY3Rpb25EZXRhaWxzKG9iamVjdC5vYmplY3RJZCwgZGlkR2V0RGV0YWlscy5iaW5kKHRoaXMpKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGhpbnRzLmRhdGFiYXNlSWQpCiAgICAgICAgV2ViSW5zcGVjdG9yLnNob3dQYW5lbCgicmVzb3VyY2VzIikuc2VsZWN0RGF0YWJhc2UoV2ViSW5zcGVjdG9yLmRhdGFiYXNlTW9kZWwuZGF0YWJhc2VGb3JJZChoaW50cy5kYXRhYmFzZUlkKSk7CiAgICBlbHNlIGlmIChoaW50cy5kb21TdG9yYWdlSWQpCiAgICAgICAgV2ViSW5zcGVjdG9yLnNob3dQYW5lbCgicmVzb3VyY2VzIikuc2VsZWN0RE9NU3RvcmFnZShXZWJJbnNwZWN0b3IuZG9tU3RvcmFnZU1vZGVsLnN0b3JhZ2VGb3JJZChoaW50cy5kb21TdG9yYWdlSWQpKTsKICAgIGVsc2UgaWYgKGhpbnRzLmNvcHlUb0NsaXBib2FyZCkKICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3QuY29weVRleHQob2JqZWN0LnZhbHVlKTsKICAgIG9iamVjdC5yZWxlYXNlKCk7Cn0KCi8vIEluc3BlY3Rvci5kZXRhY2hlZCBwcm90b2NvbCBldmVudApXZWJJbnNwZWN0b3IuZGV0YWNoZWQgPSBmdW5jdGlvbihyZWFzb24pCnsKICAgIFdlYkluc3BlY3Rvci5zb2NrZXQuX2RldGFjaFJlYXNvbiA9IHJlYXNvbjsKICAgIChuZXcgV2ViSW5zcGVjdG9yLlJlbW90ZURlYnVnZ2luZ1Rlcm1pbmF0ZWRTY3JlZW4ocmVhc29uKSkuc2hvd01vZGFsKCk7Cn0KCldlYkluc3BlY3Rvci50YXJnZXRDcmFzaGVkID0gZnVuY3Rpb24oKQp7CiAgICAobmV3IFdlYkluc3BlY3Rvci5IZWxwU2NyZWVuVW50aWxSZWxvYWQoCiAgICAgICAgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJJbnNwZWN0ZWQgdGFyZ2V0IGNyYXNoZWQiKSwKICAgICAgICBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkluc3BlY3RlZCB0YXJnZXQgaGFzIGNyYXNoZWQuIE9uY2UgaXQgcmVsb2FkcyB3ZSB3aWxsIGF0dGFjaCB0byBpdCBhdXRvbWF0aWNhbGx5LiIpKSkuc2hvd01vZGFsKCk7Cn0KCldlYkluc3BlY3Rvci5faW5zcGVjdE5vZGVSZXF1ZXN0ZWQgPSBmdW5jdGlvbihldmVudCkKewogICAgV2ViSW5zcGVjdG9yLl91cGRhdGVGb2N1c2VkTm9kZShldmVudC5kYXRhKTsKfQoKV2ViSW5zcGVjdG9yLl91cGRhdGVGb2N1c2VkTm9kZSA9IGZ1bmN0aW9uKG5vZGVJZCkKewogICAgaWYgKFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyICYmIFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLmVuYWJsZWQoKSkgewogICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5icmluZ1RvRnJvbnQoKTsKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlci5kaXNhYmxlKCk7CiAgICB9CiAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJlbGVtZW50cyIpLnJldmVhbEFuZFNlbGVjdE5vZGUobm9kZUlkKTsKfQoKV2ViSW5zcGVjdG9yLnNob3dBbmNob3JMb2NhdGlvbiA9IGZ1bmN0aW9uKGFuY2hvcikKewogICAgdmFyIHByZWZlcnJlZFBhbmVsID0gdGhpcy5wYW5lbHNbYW5jaG9yLnByZWZlcnJlZFBhbmVsXTsKICAgIGlmIChwcmVmZXJyZWRQYW5lbCAmJiBXZWJJbnNwZWN0b3IuX3Nob3dBbmNob3JMb2NhdGlvbkluUGFuZWwoYW5jaG9yLCBwcmVmZXJyZWRQYW5lbCkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb25JblBhbmVsKGFuY2hvciwgdGhpcy5wYW5lbCgic2NyaXB0cyIpKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIGlmIChXZWJJbnNwZWN0b3IuX3Nob3dBbmNob3JMb2NhdGlvbkluUGFuZWwoYW5jaG9yLCB0aGlzLnBhbmVsKCJyZXNvdXJjZXMiKSkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb25JblBhbmVsKGFuY2hvciwgdGhpcy5wYW5lbCgibmV0d29yayIpKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiBmYWxzZTsKfQoKV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb25JblBhbmVsID0gZnVuY3Rpb24oYW5jaG9yLCBwYW5lbCkKewogICAgaWYgKCFwYW5lbCB8fCAhcGFuZWwuY2FuU2hvd0FuY2hvckxvY2F0aW9uKGFuY2hvcikpCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIC8vIEZJWE1FOiBzdXBwb3J0IHdlYmtpdC1odG1sLWV4dGVybmFsLWxpbmsgbGlua3MgaGVyZS4KICAgIGlmIChhbmNob3IuaGFzU3R5bGVDbGFzcygid2Via2l0LWh0bWwtZXh0ZXJuYWwtbGluayIpKSB7CiAgICAgICAgYW5jaG9yLnJlbW92ZVN0eWxlQ2xhc3MoIndlYmtpdC1odG1sLWV4dGVybmFsLWxpbmsiKTsKICAgICAgICBhbmNob3IuYWRkU3R5bGVDbGFzcygid2Via2l0LWh0bWwtcmVzb3VyY2UtbGluayIpOwogICAgfQoKICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LnNldEN1cnJlbnRQYW5lbChwYW5lbCk7CiAgICBwYW5lbC5zaG93QW5jaG9yTG9jYXRpb24oYW5jaG9yKTsKICAgIHJldHVybiB0cnVlOwp9CgpXZWJJbnNwZWN0b3IuZXZhbHVhdGVJbkNvbnNvbGUgPSBmdW5jdGlvbihleHByZXNzaW9uLCBzaG93UmVzdWx0T25seSkKewogICAgdGhpcy5zaG93Q29uc29sZSgpOwogICAgdGhpcy5jb25zb2xlVmlldy5ldmFsdWF0ZVVzaW5nVGV4dFByb21wdChleHByZXNzaW9uLCBzaG93UmVzdWx0T25seSk7Cn0KCldlYkluc3BlY3Rvci5hZGRNYWluRXZlbnRMaXN0ZW5lcnMgPSBmdW5jdGlvbihkb2MpCnsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5kb2N1bWVudEtleURvd24uYmluZCh0aGlzKSwgdHJ1ZSk7CiAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMucG9zdERvY3VtZW50S2V5RG93bi5iaW5kKHRoaXMpLCBmYWxzZSk7CiAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcigiYmVmb3JlY29weSIsIHRoaXMuZG9jdW1lbnRDYW5Db3B5LmJpbmQodGhpcyksIHRydWUpOwogICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImNvcHkiLCB0aGlzLmRvY3VtZW50Q29weS5iaW5kKHRoaXMpLCBmYWxzZSk7CiAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCB0aGlzLmNvbnRleHRNZW51RXZlbnRGaXJlZC5iaW5kKHRoaXMpLCB0cnVlKTsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuZG9jdW1lbnRDbGljay5iaW5kKHRoaXMpLCB0cnVlKTsKfQoKV2ViSW5zcGVjdG9yLlpvb20gPSB7CiAgICBUYWJsZTogWzAuMjUsIDAuMzMsIDAuNSwgMC42NiwgMC43NSwgMC45LCAxLCAxLjEsIDEuMjUsIDEuNSwgMS43NSwgMiwgMi41LCAzLCA0LCA1XSwKICAgIERlZmF1bHRPZmZzZXQ6IDYKfQoKCi8vIEV4LURldlRvb2xzLmpzIGNvbnRlbnQKCi8qKgogKiBAcGFyYW0ge0V4dGVuc2lvbkRlc2NyaXB0b3J9IGV4dGVuc2lvbkluZm8KICogQHJldHVybiB7c3RyaW5nfQogKi8KZnVuY3Rpb24gYnVpbGRQbGF0Zm9ybUV4dGVuc2lvbkFQSShleHRlbnNpb25JbmZvKQp7CiAgICByZXR1cm4gInZhciBleHRlbnNpb25JbmZvID0gIiArIEpTT04uc3RyaW5naWZ5KGV4dGVuc2lvbkluZm8pICsgIjsiICsKICAgICAgICJ2YXIgdGFiSWQgPSAiICsgV2ViSW5zcGVjdG9yLl9pbnNwZWN0ZWRUYWJJZCArICI7IiArCiAgICAgICBwbGF0Zm9ybUV4dGVuc2lvbkFQSS50b1N0cmluZygpOwp9CgpXZWJJbnNwZWN0b3Iuc2V0SW5zcGVjdGVkVGFiSWQgPSBmdW5jdGlvbih0YWJJZCkKewogICAgV2ViSW5zcGVjdG9yLl9pbnNwZWN0ZWRUYWJJZCA9IHRhYklkOwp9CgovKioKICogQHJldHVybiB7c3RyaW5nfQogKi8KV2ViSW5zcGVjdG9yLmdldFNlbGVjdGlvbkJhY2tncm91bmRDb2xvciA9IGZ1bmN0aW9uKCkKewogICAgcmV0dXJuIEluc3BlY3RvckZyb250ZW5kSG9zdC5nZXRTZWxlY3Rpb25CYWNrZ3JvdW5kQ29sb3IoKTsKfQoKLyoqCiAqIEByZXR1cm4ge3N0cmluZ30KICovCldlYkluc3BlY3Rvci5nZXRTZWxlY3Rpb25Gb3JlZ3JvdW5kQ29sb3IgPSBmdW5jdGlvbigpCnsKICAgIHJldHVybiBJbnNwZWN0b3JGcm9udGVuZEhvc3QuZ2V0U2VsZWN0aW9uRm9yZWdyb3VuZENvbG9yKCk7Cn0KCndpbmRvdy5ERUJVRyA9IHRydWU7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 19:35:16 GMT",
                    "Content-Length": "44110",
                    "Date": "Fri, 07 Nov 2014 19:35:21 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}