{
    "url": "http://localhost:9999/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc2/thorax-mobile.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc2/thorax-mobile.js",
                "path": "/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc2/thorax-mobile.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9vaWVkdWFyZG9yYWJlbG8vc2F3cGYvc3JjL2pzL3Rob3JheC8yLjAuMHJjMi90aG9yYXgtbW9iaWxlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjkyOTcyDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDAzOjU1OjM1IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAwMzo1NDo1OSBHTVQNCg0KLyogWmVwdG8gdjEuMHJjMSAtIHBvbHlmaWxsIHplcHRvIGV2ZW50IGRldGVjdCBmeCBhamF4IGZvcm0gdG91Y2ggLSB6ZXB0b2pzLmNvbS9saWNlbnNlICovCjsoZnVuY3Rpb24odW5kZWZpbmVkKXsKICBpZiAoU3RyaW5nLnByb3RvdHlwZS50cmltID09PSB1bmRlZmluZWQpIC8vIGZpeCBmb3IgaU9TIDMuMgogICAgU3RyaW5nLnByb3RvdHlwZS50cmltID0gZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sICcnKS5yZXBsYWNlKC9ccyskLywgJycpIH0KCiAgLy8gRm9yIGlPUyAzLngKICAvLyBmcm9tIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L3JlZHVjZQogIGlmIChBcnJheS5wcm90b3R5cGUucmVkdWNlID09PSB1bmRlZmluZWQpCiAgICBBcnJheS5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24oZnVuKXsKICAgICAgaWYodGhpcyA9PT0gdm9pZCAwIHx8IHRoaXMgPT09IG51bGwpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICB2YXIgdCA9IE9iamVjdCh0aGlzKSwgbGVuID0gdC5sZW5ndGggPj4+IDAsIGsgPSAwLCBhY2N1bXVsYXRvcgogICAgICBpZih0eXBlb2YgZnVuICE9ICdmdW5jdGlvbicpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICBpZihsZW4gPT0gMCAmJiBhcmd1bWVudHMubGVuZ3RoID09IDEpIHRocm93IG5ldyBUeXBlRXJyb3IoKQoKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+PSAyKQogICAgICAgYWNjdW11bGF0b3IgPSBhcmd1bWVudHNbMV0KICAgICAgZWxzZQogICAgICAgIGRvewogICAgICAgICAgaWYoayBpbiB0KXsKICAgICAgICAgICAgYWNjdW11bGF0b3IgPSB0W2srK10KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCsrayA+PSBsZW4pIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICAgIH0gd2hpbGUgKHRydWUpCgogICAgICB3aGlsZSAoayA8IGxlbil7CiAgICAgICAgaWYoayBpbiB0KSBhY2N1bXVsYXRvciA9IGZ1bi5jYWxsKHVuZGVmaW5lZCwgYWNjdW11bGF0b3IsIHRba10sIGssIHQpCiAgICAgICAgaysrCiAgICAgIH0KICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yCiAgICB9Cgp9KSgpCnZhciBaZXB0byA9IChmdW5jdGlvbigpIHsKICB2YXIgdW5kZWZpbmVkLCBrZXksICQsIGNsYXNzTGlzdCwgZW1wdHlBcnJheSA9IFtdLCBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsCiAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKICAgIGVsZW1lbnREaXNwbGF5ID0ge30sIGNsYXNzQ2FjaGUgPSB7fSwKICAgIGdldENvbXB1dGVkU3R5bGUgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlLAogICAgY3NzTnVtYmVyID0geyAnY29sdW1uLWNvdW50JzogMSwgJ2NvbHVtbnMnOiAxLCAnZm9udC13ZWlnaHQnOiAxLCAnbGluZS1oZWlnaHQnOiAxLCdvcGFjaXR5JzogMSwgJ3otaW5kZXgnOiAxLCAnem9vbSc6IDEgfSwKICAgIGZyYWdtZW50UkUgPSAvXlxzKjwoXHcrfCEpW14+XSo+LywKCiAgICAvLyBVc2VkIGJ5IGAkLnplcHRvLmluaXRgIHRvIHdyYXAgZWxlbWVudHMsIHRleHQvY29tbWVudCBub2RlcywgZG9jdW1lbnQsCiAgICAvLyBhbmQgZG9jdW1lbnQgZnJhZ21lbnQgbm9kZSB0eXBlcy4KICAgIGVsZW1lbnRUeXBlcyA9IFsxLCAzLCA4LCA5LCAxMV0sCgogICAgYWRqYWNlbmN5T3BlcmF0b3JzID0gWyAnYWZ0ZXInLCAncHJlcGVuZCcsICdiZWZvcmUnLCAnYXBwZW5kJyBdLAogICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0YWJsZScpLAogICAgdGFibGVSb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpLAogICAgY29udGFpbmVycyA9IHsKICAgICAgJ3RyJzogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGJvZHknKSwKICAgICAgJ3Rib2R5JzogdGFibGUsICd0aGVhZCc6IHRhYmxlLCAndGZvb3QnOiB0YWJsZSwKICAgICAgJ3RkJzogdGFibGVSb3csICd0aCc6IHRhYmxlUm93LAogICAgICAnKic6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICB9LAogICAgcmVhZHlSRSA9IC9jb21wbGV0ZXxsb2FkZWR8aW50ZXJhY3RpdmUvLAogICAgY2xhc3NTZWxlY3RvclJFID0gL15cLihbXHctXSspJC8sCiAgICBpZFNlbGVjdG9yUkUgPSAvXiMoW1x3LV0rKSQvLAogICAgdGFnU2VsZWN0b3JSRSA9IC9eW1x3LV0rJC8sCiAgICB0b1N0cmluZyA9ICh7fSkudG9TdHJpbmcsCiAgICB6ZXB0byA9IHt9LAogICAgY2FtZWxpemUsIHVuaXEsCiAgICB0ZW1wUGFyZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKCiAgemVwdG8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIWVsZW1lbnQgfHwgZWxlbWVudC5ub2RlVHlwZSAhPT0gMSkgcmV0dXJuIGZhbHNlCiAgICB2YXIgbWF0Y2hlc1NlbGVjdG9yID0gZWxlbWVudC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9NYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tYXRjaGVzU2VsZWN0b3IKICAgIGlmIChtYXRjaGVzU2VsZWN0b3IpIHJldHVybiBtYXRjaGVzU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3RvcikKICAgIC8vIGZhbGwgYmFjayB0byBwZXJmb3JtaW5nIGEgc2VsZWN0b3I6CiAgICB2YXIgbWF0Y2gsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwgdGVtcCA9ICFwYXJlbnQKICAgIGlmICh0ZW1wKSAocGFyZW50ID0gdGVtcFBhcmVudCkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgIG1hdGNoID0gfnplcHRvLnFzYShwYXJlbnQsIHNlbGVjdG9yKS5pbmRleE9mKGVsZW1lbnQpCiAgICB0ZW1wICYmIHRlbXBQYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgIHJldHVybiBtYXRjaAogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gIltvYmplY3QgRnVuY3Rpb25dIiB9CiAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0IH0KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICB2YXIga2V5LCBjdG9yCiAgICBpZiAodG9TdHJpbmcuY2FsbCh2YWx1ZSkgIT09ICJbb2JqZWN0IE9iamVjdF0iKSByZXR1cm4gZmFsc2UKICAgIGN0b3IgPSAoaXNGdW5jdGlvbih2YWx1ZS5jb25zdHJ1Y3RvcikgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlKQogICAgaWYgKCFjdG9yIHx8ICFoYXNPd25Qcm9wZXJ0eS5jYWxsKGN0b3IsICdpc1Byb3RvdHlwZU9mJykpIHJldHVybiBmYWxzZQogICAgZm9yIChrZXkgaW4gdmFsdWUpOwogICAgcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkKICB9CiAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBBcnJheSB9CiAgZnVuY3Rpb24gbGlrZUFycmF5KG9iaikgeyByZXR1cm4gdHlwZW9mIG9iai5sZW5ndGggPT0gJ251bWJlcicgfQoKICBmdW5jdGlvbiBjb21wYWN0KGFycmF5KSB7IHJldHVybiBhcnJheS5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7IHJldHVybiBpdGVtICE9PSB1bmRlZmluZWQgJiYgaXRlbSAhPT0gbnVsbCB9KSB9CiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSkgeyByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/IFtdLmNvbmNhdC5hcHBseShbXSwgYXJyYXkpIDogYXJyYXkgfQogIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyKXsgcmV0dXJuIHN0ci5yZXBsYWNlKC8tKyguKT8vZywgZnVuY3Rpb24obWF0Y2gsIGNocil7IHJldHVybiBjaHIgPyBjaHIudG9VcHBlckNhc2UoKSA6ICcnIH0pIH0KICBmdW5jdGlvbiBkYXNoZXJpemUoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLzo6L2csICcvJykKICAgICAgICAgICAucmVwbGFjZSgvKFtBLVpdKykoW0EtWl1bYS16XSkvZywgJyQxXyQyJykKICAgICAgICAgICAucmVwbGFjZSgvKFthLXpcZF0pKFtBLVpdKS9nLCAnJDFfJDInKQogICAgICAgICAgIC5yZXBsYWNlKC9fL2csICctJykKICAgICAgICAgICAudG9Mb3dlckNhc2UoKQogIH0KICB1bmlxID0gZnVuY3Rpb24oYXJyYXkpeyByZXR1cm4gYXJyYXkuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0sIGlkeCl7IHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0pID09IGlkeCB9KSB9CgogIGZ1bmN0aW9uIGNsYXNzUkUobmFtZSkgewogICAgcmV0dXJuIG5hbWUgaW4gY2xhc3NDYWNoZSA/CiAgICAgIGNsYXNzQ2FjaGVbbmFtZV0gOiAoY2xhc3NDYWNoZVtuYW1lXSA9IG5ldyBSZWdFeHAoJyhefFxccyknICsgbmFtZSArICcoXFxzfCQpJykpCiAgfQoKICBmdW5jdGlvbiBtYXliZUFkZFB4KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gKHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiAhY3NzTnVtYmVyW2Rhc2hlcml6ZShuYW1lKV0pID8gdmFsdWUgKyAicHgiIDogdmFsdWUKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHREaXNwbGF5KG5vZGVOYW1lKSB7CiAgICB2YXIgZWxlbWVudCwgZGlzcGxheQogICAgaWYgKCFlbGVtZW50RGlzcGxheVtub2RlTmFtZV0pIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpCiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgJycpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKQogICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9PSAibm9uZSIgJiYgKGRpc3BsYXkgPSAiYmxvY2siKQogICAgICBlbGVtZW50RGlzcGxheVtub2RlTmFtZV0gPSBkaXNwbGF5CiAgICB9CiAgICByZXR1cm4gZWxlbWVudERpc3BsYXlbbm9kZU5hbWVdCiAgfQoKICAvLyBgJC56ZXB0by5mcmFnbWVudGAgdGFrZXMgYSBodG1sIHN0cmluZyBhbmQgYW4gb3B0aW9uYWwgdGFnIG5hbWUKICAvLyB0byBnZW5lcmF0ZSBET00gbm9kZXMgbm9kZXMgZnJvbSB0aGUgZ2l2ZW4gaHRtbCBzdHJpbmcuCiAgLy8gVGhlIGdlbmVyYXRlZCBET00gbm9kZXMgYXJlIHJldHVybmVkIGFzIGFuIGFycmF5LgogIC8vIFRoaXMgZnVuY3Rpb24gY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zIGZvciBleGFtcGxlIHRvIG1ha2UKICAvLyBpdCBjb21wYXRpYmxlIHdpdGggYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHRoZSBET00gZnVsbHkuCiAgemVwdG8uZnJhZ21lbnQgPSBmdW5jdGlvbihodG1sLCBuYW1lKSB7CiAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSBuYW1lID0gZnJhZ21lbnRSRS50ZXN0KGh0bWwpICYmIFJlZ0V4cC4kMQogICAgaWYgKCEobmFtZSBpbiBjb250YWluZXJzKSkgbmFtZSA9ICcqJwogICAgdmFyIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV0KICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnJyArIGh0bWwKICAgIHJldHVybiAkLmVhY2goc2xpY2UuY2FsbChjb250YWluZXIuY2hpbGROb2RlcyksIGZ1bmN0aW9uKCl7CiAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzKQogICAgfSkKICB9CgogIC8vIGAkLnplcHRvLlpgIHN3YXBzIG91dCB0aGUgcHJvdG90eXBlIG9mIHRoZSBnaXZlbiBgZG9tYCBhcnJheQogIC8vIG9mIG5vZGVzIHdpdGggYCQuZm5gIGFuZCB0aHVzIHN1cHBseWluZyBhbGwgdGhlIFplcHRvIGZ1bmN0aW9ucwogIC8vIHRvIHRoZSBhcnJheS4gTm90ZSB0aGF0IGBfX3Byb3RvX19gIGlzIG5vdCBzdXBwb3J0ZWQgb24gSW50ZXJuZXQKICAvLyBFeHBsb3Jlci4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLlogPSBmdW5jdGlvbihkb20sIHNlbGVjdG9yKSB7CiAgICBkb20gPSBkb20gfHwgW10KICAgIGRvbS5fX3Byb3RvX18gPSBhcmd1bWVudHMuY2FsbGVlLnByb3RvdHlwZQogICAgZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJycKICAgIHJldHVybiBkb20KICB9CgogIC8vIGAkLnplcHRvLmlzWmAgc2hvdWxkIHJldHVybiBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhIFplcHRvCiAgLy8gY29sbGVjdGlvbi4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLmlzWiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIHplcHRvLloKICB9CgogIC8vIGAkLnplcHRvLmluaXRgIGlzIFplcHRvJ3MgY291bnRlcnBhcnQgdG8galF1ZXJ5J3MgYCQuZm4uaW5pdGAgYW5kCiAgLy8gdGFrZXMgYSBDU1Mgc2VsZWN0b3IgYW5kIGFuIG9wdGlvbmFsIGNvbnRleHQgKGFuZCBoYW5kbGVzIHZhcmlvdXMKICAvLyBzcGVjaWFsIGNhc2VzKS4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8uaW5pdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAvLyBJZiBub3RoaW5nIGdpdmVuLCByZXR1cm4gYW4gZW1wdHkgWmVwdG8gY29sbGVjdGlvbgogICAgaWYgKCFzZWxlY3RvcikgcmV0dXJuIHplcHRvLlooKQogICAgLy8gSWYgYSBmdW5jdGlvbiBpcyBnaXZlbiwgY2FsbCBpdCB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gJChkb2N1bWVudCkucmVhZHkoc2VsZWN0b3IpCiAgICAvLyBJZiBhIFplcHRvIGNvbGxlY3Rpb24gaXMgZ2l2ZW4sIGp1dHMgcmV0dXJuIGl0CiAgICBlbHNlIGlmICh6ZXB0by5pc1ooc2VsZWN0b3IpKSByZXR1cm4gc2VsZWN0b3IKICAgIGVsc2UgewogICAgICB2YXIgZG9tCiAgICAgIC8vIG5vcm1hbGl6ZSBhcnJheSBpZiBhbiBhcnJheSBvZiBub2RlcyBpcyBnaXZlbgogICAgICBpZiAoaXNBcnJheShzZWxlY3RvcikpIGRvbSA9IGNvbXBhY3Qoc2VsZWN0b3IpCiAgICAgIC8vIGlmIGEgSmF2YVNjcmlwdCBvYmplY3QgaXMgZ2l2ZW4sIHJldHVybiBhIGNvcHkgb2YgaXQKICAgICAgLy8gdGhpcyBpcyBhIHNvbWV3aGF0IHBlY3VsaWFyIG9wdGlvbiwgYnV0IHN1cHBvcnRlZCBieQogICAgICAvLyBqUXVlcnkgc28gd2UnbGwgZG8gaXQsIHRvbwogICAgICBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSBbJC5leHRlbmQoe30sIHNlbGVjdG9yKV0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyB3cmFwIHN0dWZmIGxpa2UgYGRvY3VtZW50YCBvciBgd2luZG93YAogICAgICBlbHNlIGlmIChlbGVtZW50VHlwZXMuaW5kZXhPZihzZWxlY3Rvci5ub2RlVHlwZSkgPj0gMCB8fCBzZWxlY3RvciA9PT0gd2luZG93KQogICAgICAgIGRvbSA9IFtzZWxlY3Rvcl0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgZWxzZSBpZiAoZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3Rvci50cmltKCksIFJlZ0V4cC4kMSksIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiB0aGVyZSdzIGEgY29udGV4dCwgY3JlYXRlIGEgY29sbGVjdGlvbiBvbiB0aGF0IGNvbnRleHQgZmlyc3QsIGFuZCBzZWxlY3QKICAgICAgLy8gbm9kZXMgZnJvbSB0aGVyZQogICAgICBlbHNlIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHJldHVybiAkKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpCiAgICAgIC8vIEFuZCBsYXN0IGJ1dCBubyBsZWFzdCwgaWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgICAvLyBjcmVhdGUgYSBuZXcgWmVwdG8gY29sbGVjdGlvbiBmcm9tIHRoZSBub2RlcyBmb3VuZAogICAgICByZXR1cm4gemVwdG8uWihkb20sIHNlbGVjdG9yKQogICAgfQogIH0KCiAgLy8gYCRgIHdpbGwgYmUgdGhlIGJhc2UgYFplcHRvYCBvYmplY3QuIFdoZW4gY2FsbGluZyB0aGlzCiAgLy8gZnVuY3Rpb24ganVzdCBjYWxsIGAkLnplcHRvLmluaXQsIHdoaWNocyBtYWtlcyB0aGUgaW1wbGVtZW50YXRpb24KICAvLyBkZXRhaWxzIG9mIHNlbGVjdGluZyBub2RlcyBhbmQgY3JlYXRpbmcgWmVwdG8gY29sbGVjdGlvbnMKICAvLyBwYXRjaGFibGUgaW4gcGx1Z2lucy4KICAkID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQpewogICAgcmV0dXJuIHplcHRvLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpCiAgfQoKICAvLyBDb3B5IGFsbCBidXQgdW5kZWZpbmVkIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbW9yZQogIC8vIG9iamVjdHMgdG8gdGhlIGB0YXJnZXRgIG9iamVjdC4KICAkLmV4dGVuZCA9IGZ1bmN0aW9uKHRhcmdldCl7CiAgICBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yIChrZXkgaW4gc291cmNlKQogICAgICAgIGlmIChzb3VyY2Vba2V5XSAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XQogICAgfSkKICAgIHJldHVybiB0YXJnZXQKICB9CgogIC8vIGAkLnplcHRvLnFzYWAgaXMgWmVwdG8ncyBDU1Mgc2VsZWN0b3IgaW1wbGVtZW50YXRpb24gd2hpY2gKICAvLyB1c2VzIGBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsYCBhbmQgb3B0aW1pemVzIGZvciBzb21lIHNwZWNpYWwgY2FzZXMsIGxpa2UgYCNpZGAuCiAgLy8gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLnFzYSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHZhciBmb3VuZAogICAgcmV0dXJuIChlbGVtZW50ID09PSBkb2N1bWVudCAmJiBpZFNlbGVjdG9yUkUudGVzdChzZWxlY3RvcikpID8KICAgICAgKCAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKFJlZ0V4cC4kMSkpID8gW2ZvdW5kXSA6IGVtcHR5QXJyYXkgKSA6CiAgICAgIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkpID8gZW1wdHlBcnJheSA6CiAgICAgIHNsaWNlLmNhbGwoCiAgICAgICAgY2xhc3NTZWxlY3RvclJFLnRlc3Qoc2VsZWN0b3IpID8gZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFJlZ0V4cC4kMSkgOgogICAgICAgIHRhZ1NlbGVjdG9yUkUudGVzdChzZWxlY3RvcikgPyBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSA6CiAgICAgICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKQogICAgICApCiAgfQoKICBmdW5jdGlvbiBmaWx0ZXJlZChub2Rlcywgc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3RvciA9PT0gdW5kZWZpbmVkID8gJChub2RlcykgOiAkKG5vZGVzKS5maWx0ZXIoc2VsZWN0b3IpCiAgfQoKICBmdW5jdGlvbiBmdW5jQXJnKGNvbnRleHQsIGFyZywgaWR4LCBwYXlsb2FkKSB7CiAgIHJldHVybiBpc0Z1bmN0aW9uKGFyZykgPyBhcmcuY2FsbChjb250ZXh0LCBpZHgsIHBheWxvYWQpIDogYXJnCiAgfQoKICAkLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uCiAgJC5pc09iamVjdCA9IGlzT2JqZWN0CiAgJC5pc0FycmF5ID0gaXNBcnJheQogICQuaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3QKCiAgJC5pbkFycmF5ID0gZnVuY3Rpb24oZWxlbSwgYXJyYXksIGkpewogICAgcmV0dXJuIGVtcHR5QXJyYXkuaW5kZXhPZi5jYWxsKGFycmF5LCBlbGVtLCBpKQogIH0KCiAgJC50cmltID0gZnVuY3Rpb24oc3RyKSB7IHJldHVybiBzdHIudHJpbSgpIH0KCiAgLy8gcGx1Z2luIGNvbXBhdGliaWxpdHkKICAkLnV1aWQgPSAwCgogICQubWFwID0gZnVuY3Rpb24oZWxlbWVudHMsIGNhbGxiYWNrKXsKICAgIHZhciB2YWx1ZSwgdmFsdWVzID0gW10sIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpCiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbWVudHNbaV0sIGkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICBlbHNlCiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtZW50c1trZXldLCBrZXkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICByZXR1cm4gZmxhdHRlbih2YWx1ZXMpCiAgfQoKICAkLmVhY2ggPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2spewogICAgdmFyIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2ldLCBpLCBlbGVtZW50c1tpXSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2tleV0sIGtleSwgZWxlbWVudHNba2V5XSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudHMKICB9CgogIC8vIERlZmluZSBtZXRob2RzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgb24gYWxsCiAgLy8gWmVwdG8gY29sbGVjdGlvbnMKICAkLmZuID0gewogICAgLy8gQmVjYXVzZSBhIGNvbGxlY3Rpb24gYWN0cyBsaWtlIGFuIGFycmF5CiAgICAvLyBjb3B5IG92ZXIgdGhlc2UgdXNlZnVsIGFycmF5IGZ1bmN0aW9ucy4KICAgIGZvckVhY2g6IGVtcHR5QXJyYXkuZm9yRWFjaCwKICAgIHJlZHVjZTogZW1wdHlBcnJheS5yZWR1Y2UsCiAgICBwdXNoOiBlbXB0eUFycmF5LnB1c2gsCiAgICBpbmRleE9mOiBlbXB0eUFycmF5LmluZGV4T2YsCiAgICBjb25jYXQ6IGVtcHR5QXJyYXkuY29uY2F0LAoKICAgIC8vIGBtYXBgIGFuZCBgc2xpY2VgIGluIHRoZSBqUXVlcnkgQVBJIHdvcmsgZGlmZmVyZW50bHkKICAgIC8vIGZyb20gdGhlaXIgYXJyYXkgY291bnRlcnBhcnRzCiAgICBtYXA6IGZ1bmN0aW9uKGZuKXsKICAgICAgcmV0dXJuICQubWFwKHRoaXMsIGZ1bmN0aW9uKGVsLCBpKXsgcmV0dXJuIGZuLmNhbGwoZWwsIGksIGVsKSB9KQogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gJChzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKQogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBpZiAocmVhZHlSRS50ZXN0KGRvY3VtZW50LnJlYWR5U3RhdGUpKSBjYWxsYmFjaygkKQogICAgICBlbHNlIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpeyBjYWxsYmFjaygkKSB9LCBmYWxzZSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKGlkeCl7CiAgICAgIHJldHVybiBpZHggPT09IHVuZGVmaW5lZCA/IHNsaWNlLmNhbGwodGhpcykgOiB0aGlzW2lkeF0KICAgIH0sCiAgICB0b0FycmF5OiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5nZXQoKSB9LAogICAgc2l6ZTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoCiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAhPSBudWxsKQogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpCiAgICAgIH0pCiAgICB9LAogICAgZWFjaDogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwsIGlkeCl7IGNhbGxiYWNrLmNhbGwoZWwsIGlkeCwgZWwpIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiAkKFtdLmZpbHRlci5jYWxsKHRoaXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIHJldHVybiB6ZXB0by5tYXRjaGVzKGVsZW1lbnQsIHNlbGVjdG9yKQogICAgICB9KSkKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKHNlbGVjdG9yLGNvbnRleHQpewogICAgICByZXR1cm4gJCh1bmlxKHRoaXMuY29uY2F0KCQoc2VsZWN0b3IsY29udGV4dCkpKSkKICAgIH0sCiAgICBpczogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICByZXR1cm4gdGhpcy5sZW5ndGggPiAwICYmIHplcHRvLm1hdGNoZXModGhpc1swXSwgc2VsZWN0b3IpCiAgICB9LAogICAgbm90OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBub2Rlcz1bXQogICAgICBpZiAoaXNGdW5jdGlvbihzZWxlY3RvcikgJiYgc2VsZWN0b3IuY2FsbCAhPT0gdW5kZWZpbmVkKQogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgaWYgKCFzZWxlY3Rvci5jYWxsKHRoaXMsaWR4KSkgbm9kZXMucHVzaCh0aGlzKQogICAgICAgIH0pCiAgICAgIGVsc2UgewogICAgICAgIHZhciBleGNsdWRlcyA9IHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJyA/IHRoaXMuZmlsdGVyKHNlbGVjdG9yKSA6CiAgICAgICAgICAobGlrZUFycmF5KHNlbGVjdG9yKSAmJiBpc0Z1bmN0aW9uKHNlbGVjdG9yLml0ZW0pKSA/IHNsaWNlLmNhbGwoc2VsZWN0b3IpIDogJChzZWxlY3RvcikKICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwpewogICAgICAgICAgaWYgKGV4Y2x1ZGVzLmluZGV4T2YoZWwpIDwgMCkgbm9kZXMucHVzaChlbCkKICAgICAgICB9KQogICAgICB9CiAgICAgIHJldHVybiAkKG5vZGVzKQogICAgfSwKICAgIGVxOiBmdW5jdGlvbihpZHgpewogICAgICByZXR1cm4gaWR4ID09PSAtMSA/IHRoaXMuc2xpY2UoaWR4KSA6IHRoaXMuc2xpY2UoaWR4LCArIGlkeCArIDEpCiAgICB9LAogICAgZmlyc3Q6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBlbCA9IHRoaXNbMF0KICAgICAgcmV0dXJuIGVsICYmICFpc09iamVjdChlbCkgPyBlbCA6ICQoZWwpCiAgICB9LAogICAgbGFzdDogZnVuY3Rpb24oKXsKICAgICAgdmFyIGVsID0gdGhpc1t0aGlzLmxlbmd0aCAtIDFdCiAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKQogICAgfSwKICAgIGZpbmQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgdmFyIHJlc3VsdAogICAgICBpZiAodGhpcy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gemVwdG8ucXNhKHRoaXNbMF0sIHNlbGVjdG9yKQogICAgICBlbHNlIHJlc3VsdCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpIH0pCiAgICAgIHJldHVybiAkKHJlc3VsdCkKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7CiAgICAgIHZhciBub2RlID0gdGhpc1swXQogICAgICB3aGlsZSAobm9kZSAmJiAhemVwdG8ubWF0Y2hlcyhub2RlLCBzZWxlY3RvcikpCiAgICAgICAgbm9kZSA9IG5vZGUgIT09IGNvbnRleHQgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgbm9kZS5wYXJlbnROb2RlCiAgICAgIHJldHVybiAkKG5vZGUpCiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICB2YXIgYW5jZXN0b3JzID0gW10sIG5vZGVzID0gdGhpcwogICAgICB3aGlsZSAobm9kZXMubGVuZ3RoID4gMCkKICAgICAgICBub2RlcyA9ICQubWFwKG5vZGVzLCBmdW5jdGlvbihub2RlKXsKICAgICAgICAgIGlmICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgYW5jZXN0b3JzLmluZGV4T2Yobm9kZSkgPCAwKSB7CiAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKG5vZGUpCiAgICAgICAgICAgIHJldHVybiBub2RlCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgcmV0dXJuIGZpbHRlcmVkKGFuY2VzdG9ycywgc2VsZWN0b3IpCiAgICB9LAogICAgcGFyZW50OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh1bmlxKHRoaXMucGx1Y2soJ3BhcmVudE5vZGUnKSksIHNlbGVjdG9yKQogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gc2xpY2UuY2FsbCh0aGlzLmNoaWxkcmVuKSB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHRoaXMubWFwKGZ1bmN0aW9uKGksIGVsKXsKICAgICAgICByZXR1cm4gc2xpY2UuY2FsbChlbC5wYXJlbnROb2RlLmNoaWxkcmVuKS5maWx0ZXIoZnVuY3Rpb24oY2hpbGQpeyByZXR1cm4gY2hpbGQhPT1lbCB9KQogICAgICB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5pbm5lckhUTUwgPSAnJyB9KQogICAgfSwKICAgIC8vIGBwbHVja2AgaXMgYm9ycm93ZWQgZnJvbSBQcm90b3R5cGUuanMKICAgIHBsdWNrOiBmdW5jdGlvbihwcm9wZXJ0eSl7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gdGhpc1twcm9wZXJ0eV0gfSkKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIiAmJiAodGhpcy5zdHlsZS5kaXNwbGF5ID0gbnVsbCkKICAgICAgICBpZiAoZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCAnJykuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpID09ICJub25lIikKICAgICAgICAgIHRoaXMuc3R5bGUuZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5KHRoaXMubm9kZU5hbWUpCiAgICAgIH0pCiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpewogICAgICByZXR1cm4gdGhpcy5iZWZvcmUobmV3Q29udGVudCkucmVtb3ZlKCkKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbihuZXdDb250ZW50KXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAgICQodGhpcykud3JhcEFsbCgkKG5ld0NvbnRlbnQpWzBdLmNsb25lTm9kZShmYWxzZSkpCiAgICAgIH0pCiAgICB9LAogICAgd3JhcEFsbDogZnVuY3Rpb24obmV3Q29udGVudCl7CiAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgJCh0aGlzWzBdKS5iZWZvcmUobmV3Q29udGVudCA9ICQobmV3Q29udGVudCkpCiAgICAgICAgbmV3Q29udGVudC5hcHBlbmQodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdGhpcwogICAgfSwKICAgIHVud3JhcDogZnVuY3Rpb24oKXsKICAgICAgdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgJCh0aGlzKS5yZXBsYWNlV2l0aCgkKHRoaXMpLmNoaWxkcmVuKCkpCiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiAkKHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmNsb25lTm9kZSh0cnVlKSB9KSkKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5jc3MoImRpc3BsYXkiLCAibm9uZSIpCiAgICB9LAogICAgdG9nZ2xlOiBmdW5jdGlvbihzZXR0aW5nKXsKICAgICAgcmV0dXJuIChzZXR0aW5nID09PSB1bmRlZmluZWQgPyB0aGlzLmNzcygiZGlzcGxheSIpID09ICJub25lIiA6IHNldHRpbmcpID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKQogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ3ByZXZpb3VzRWxlbWVudFNpYmxpbmcnKSkgfSwKICAgIG5leHQ6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ25leHRFbGVtZW50U2libGluZycpKSB9LAogICAgaHRtbDogZnVuY3Rpb24oaHRtbCl7CiAgICAgIHJldHVybiBodG1sID09PSB1bmRlZmluZWQgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLmlubmVySFRNTCA6IG51bGwpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHZhciBvcmlnaW5IdG1sID0gdGhpcy5pbm5lckhUTUwKICAgICAgICAgICQodGhpcykuZW1wdHkoKS5hcHBlbmQoIGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSApCiAgICAgICAgfSkKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbih0ZXh0KXsKICAgICAgcmV0dXJuIHRleHQgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udGV4dENvbnRlbnQgOiBudWxsKSA6CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMudGV4dENvbnRlbnQgPSB0ZXh0IH0pCiAgICB9LAogICAgYXR0cjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB2YXIgcmVzdWx0CiAgICAgIHJldHVybiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgPwogICAgICAgICh0aGlzLmxlbmd0aCA9PSAwIHx8IHRoaXNbMF0ubm9kZVR5cGUgIT09IDEgPyB1bmRlZmluZWQgOgogICAgICAgICAgKG5hbWUgPT0gJ3ZhbHVlJyAmJiB0aGlzWzBdLm5vZGVOYW1lID09ICdJTlBVVCcpID8gdGhpcy52YWwoKSA6CiAgICAgICAgICAoIShyZXN1bHQgPSB0aGlzWzBdLmdldEF0dHJpYnV0ZShuYW1lKSkgJiYgbmFtZSBpbiB0aGlzWzBdKSA/IHRoaXNbMF1bbmFtZV0gOiByZXN1bHQKICAgICAgICApIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSByZXR1cm4KICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgZm9yIChrZXkgaW4gbmFtZSkgdGhpcy5zZXRBdHRyaWJ1dGUoa2V5LCBuYW1lW2tleV0pCiAgICAgICAgICBlbHNlIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpKQogICAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEpIHRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpIH0pCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICByZXR1cm4gKHZhbHVlID09PSB1bmRlZmluZWQpID8KICAgICAgICAodGhpc1swXSA/IHRoaXNbMF1bbmFtZV0gOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXNbbmFtZV0gPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXNbbmFtZV0pCiAgICAgICAgfSkKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBkYXRhID0gdGhpcy5hdHRyKCdkYXRhLScgKyBkYXNoZXJpemUobmFtZSksIHZhbHVlKQogICAgICByZXR1cm4gZGF0YSAhPT0gbnVsbCA/IGRhdGEgOiB1bmRlZmluZWQKICAgIH0sCiAgICB2YWw6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udmFsdWUgOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXMudmFsdWUgPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMudmFsdWUpCiAgICAgICAgfSkKICAgIH0sCiAgICBvZmZzZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh0aGlzLmxlbmd0aD09MCkgcmV0dXJuIG51bGwKICAgICAgdmFyIG9iaiA9IHRoaXNbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkKICAgICAgcmV0dXJuIHsKICAgICAgICBsZWZ0OiBvYmoubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCwKICAgICAgICB0b3A6IG9iai50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQsCiAgICAgICAgd2lkdGg6IG9iai53aWR0aCwKICAgICAgICBoZWlnaHQ6IG9iai5oZWlnaHQKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHByb3BlcnR5ID09ICdzdHJpbmcnKQogICAgICAgIHJldHVybiAoCiAgICAgICAgICB0aGlzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgID8gdW5kZWZpbmVkCiAgICAgICAgICAgIDogdGhpc1swXS5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eSldIHx8IGdldENvbXB1dGVkU3R5bGUodGhpc1swXSwgJycpLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpKQoKICAgICAgdmFyIGNzcyA9ICcnCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnR5KQogICAgICAgIGlmKHR5cGVvZiBwcm9wZXJ0eVtrZXldID09ICdzdHJpbmcnICYmIHByb3BlcnR5W2tleV0gPT0gJycpCiAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShkYXNoZXJpemUoa2V5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgKz0gZGFzaGVyaXplKGtleSkgKyAnOicgKyBtYXliZUFkZFB4KGtleSwgcHJvcGVydHlba2V5XSkgKyAnOycKCiAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT0gJ3N0cmluZycpCiAgICAgICAgaWYgKHZhbHVlID09ICcnKQogICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKHByb3BlcnR5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgPSBkYXNoZXJpemUocHJvcGVydHkpICsgIjoiICsgbWF5YmVBZGRQeChwcm9wZXJ0eSwgdmFsdWUpCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUuY3NzVGV4dCArPSAnOycgKyBjc3MgfSkKICAgIH0sCiAgICBpbmRleDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHJldHVybiBlbGVtZW50ID8gdGhpcy5pbmRleE9mKCQoZWxlbWVudClbMF0pIDogdGhpcy5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4T2YodGhpc1swXSkKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24obmFtZSl7CiAgICAgIGlmICh0aGlzLmxlbmd0aCA8IDEpIHJldHVybiBmYWxzZQogICAgICBlbHNlIHJldHVybiBjbGFzc1JFKG5hbWUpLnRlc3QodGhpc1swXS5jbGFzc05hbWUpCiAgICB9LAogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgY2xhc3NMaXN0ID0gW10KICAgICAgICB2YXIgY2xzID0gdGhpcy5jbGFzc05hbWUsIG5ld05hbWUgPSBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xzKQogICAgICAgIG5ld05hbWUuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtsYXNzKXsKICAgICAgICAgIGlmICghJCh0aGlzKS5oYXNDbGFzcyhrbGFzcykpIGNsYXNzTGlzdC5wdXNoKGtsYXNzKQogICAgICAgIH0sIHRoaXMpCiAgICAgICAgY2xhc3NMaXN0Lmxlbmd0aCAmJiAodGhpcy5jbGFzc05hbWUgKz0gKGNscyA/ICIgIiA6ICIiKSArIGNsYXNzTGlzdC5qb2luKCIgIikpCiAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkKICAgICAgICAgIHJldHVybiB0aGlzLmNsYXNzTmFtZSA9ICcnCiAgICAgICAgY2xhc3NMaXN0ID0gdGhpcy5jbGFzc05hbWUKICAgICAgICBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xhc3NMaXN0KS5zcGxpdCgvXHMrL2cpLmZvckVhY2goZnVuY3Rpb24oa2xhc3MpewogICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NMaXN0LnJlcGxhY2UoY2xhc3NSRShrbGFzcyksICIgIikKICAgICAgICB9KQogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gY2xhc3NMaXN0LnRyaW0oKQogICAgICB9KQogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihuYW1lLCB3aGVuKXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBuZXdOYW1lID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIHRoaXMuY2xhc3NOYW1lKQogICAgICAgIDsod2hlbiA9PT0gdW5kZWZpbmVkID8gISQodGhpcykuaGFzQ2xhc3MobmV3TmFtZSkgOiB3aGVuKSA/CiAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKG5ld05hbWUpIDogJCh0aGlzKS5yZW1vdmVDbGFzcyhuZXdOYW1lKQogICAgICB9KQogICAgfQogIH0KCiAgLy8gR2VuZXJhdGUgdGhlIGB3aWR0aGAgYW5kIGBoZWlnaHRgIGZ1bmN0aW9ucwogIDtbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24oZGltZW5zaW9uKXsKICAgICQuZm5bZGltZW5zaW9uXSA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgdmFyIG9mZnNldCwgRGltZW5zaW9uID0gZGltZW5zaW9uLnJlcGxhY2UoLy4vLCBmdW5jdGlvbihtKXsgcmV0dXJuIG1bMF0udG9VcHBlckNhc2UoKSB9KQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRoaXNbMF0gPT0gd2luZG93ID8gd2luZG93Wydpbm5lcicgKyBEaW1lbnNpb25dIDoKICAgICAgICB0aGlzWzBdID09IGRvY3VtZW50ID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WydvZmZzZXQnICsgRGltZW5zaW9uXSA6CiAgICAgICAgKG9mZnNldCA9IHRoaXMub2Zmc2V0KCkpICYmIG9mZnNldFtkaW1lbnNpb25dCiAgICAgIGVsc2UgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBlbCA9ICQodGhpcykKICAgICAgICBlbC5jc3MoZGltZW5zaW9uLCBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIGVsW2RpbWVuc2lvbl0oKSkpCiAgICAgIH0pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpIHsKICAgIHZhciBwYXJlbnQgPSAob3BlcmF0b3IgJSAyKSA/IHRhcmdldCA6IHRhcmdldC5wYXJlbnROb2RlCiAgICBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsCiAgICAgICFvcGVyYXRvciA/IHRhcmdldC5uZXh0U2libGluZyA6ICAgICAgLy8gYWZ0ZXIKICAgICAgb3BlcmF0b3IgPT0gMSA/IHBhcmVudC5maXJzdENoaWxkIDogICAvLyBwcmVwZW5kCiAgICAgIG9wZXJhdG9yID09IDIgPyB0YXJnZXQgOiAgICAgICAgICAgICAgLy8gYmVmb3JlCiAgICAgIG51bGwpIDogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXBwZW5kCiAgICAgICQobm9kZSkucmVtb3ZlKCkKICB9CgogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBmdW4pIHsKICAgIGZ1bihub2RlKQogICAgZm9yICh2YXIga2V5IGluIG5vZGUuY2hpbGROb2RlcykgdHJhdmVyc2VOb2RlKG5vZGUuY2hpbGROb2Rlc1trZXldLCBmdW4pCiAgfQoKICAvLyBHZW5lcmF0ZSB0aGUgYGFmdGVyYCwgYHByZXBlbmRgLCBgYmVmb3JlYCwgYGFwcGVuZGAsCiAgLy8gYGluc2VydEFmdGVyYCwgYGluc2VydEJlZm9yZWAsIGBhcHBlbmRUb2AsIGFuZCBgcHJlcGVuZFRvYCBtZXRob2RzLgogIGFkamFjZW5jeU9wZXJhdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgb3BlcmF0b3IpIHsKICAgICQuZm5ba2V5XSA9IGZ1bmN0aW9uKCl7CiAgICAgIC8vIGFyZ3VtZW50cyBjYW4gYmUgbm9kZXMsIGFycmF5cyBvZiBub2RlcywgWmVwdG8gb2JqZWN0cyBhbmQgSFRNTCBzdHJpbmdzCiAgICAgIHZhciBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24obil7IHJldHVybiBpc09iamVjdChuKSA/IG4gOiB6ZXB0by5mcmFnbWVudChuKSB9KQogICAgICBpZiAobm9kZXMubGVuZ3RoIDwgMSkgcmV0dXJuIHRoaXMKICAgICAgdmFyIHNpemUgPSB0aGlzLmxlbmd0aCwgY29weUJ5Q2xvbmUgPSBzaXplID4gMSwgaW5SZXZlcnNlID0gb3BlcmF0b3IgPCAyCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGluZGV4LCB0YXJnZXQpewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBub2RlID0gbm9kZXNbaW5SZXZlcnNlID8gbm9kZXMubGVuZ3RoLWktMSA6IGldCiAgICAgICAgICB0cmF2ZXJzZU5vZGUobm9kZSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVOYW1lICE9IG51bGwgJiYgbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnU0NSSVBUJyAmJiAoIW5vZGUudHlwZSB8fCBub2RlLnR5cGUgPT09ICd0ZXh0L2phdmFzY3JpcHQnKSkKICAgICAgICAgICAgICB3aW5kb3dbJ2V2YWwnXS5jYWxsKHdpbmRvdywgbm9kZS5pbm5lckhUTUwpCiAgICAgICAgICB9KQogICAgICAgICAgaWYgKGNvcHlCeUNsb25lICYmIGluZGV4IDwgc2l6ZSAtIDEpIG5vZGUgPSBub2RlLmNsb25lTm9kZSh0cnVlKQogICAgICAgICAgaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpCiAgICAgICAgfQogICAgICB9KQogICAgfQoKICAgICQuZm5bKG9wZXJhdG9yICUgMikgPyBrZXkrJ1RvJyA6ICdpbnNlcnQnKyhvcGVyYXRvciA/ICdCZWZvcmUnIDogJ0FmdGVyJyldID0gZnVuY3Rpb24oaHRtbCl7CiAgICAgICQoaHRtbClba2V5XSh0aGlzKQogICAgICByZXR1cm4gdGhpcwogICAgfQogIH0pCgogIHplcHRvLloucHJvdG90eXBlID0gJC5mbgoKICAvLyBFeHBvcnQgaW50ZXJuYWwgQVBJIGZ1bmN0aW9ucyBpbiB0aGUgYCQuemVwdG9gIG5hbWVzcGFjZQogIHplcHRvLmNhbWVsaXplID0gY2FtZWxpemUKICB6ZXB0by51bmlxID0gdW5pcQogICQuemVwdG8gPSB6ZXB0bwoKICByZXR1cm4gJAp9KSgpCgovLyBJZiBgJGAgaXMgbm90IHlldCBkZWZpbmVkLCBwb2ludCBpdCB0byBgWmVwdG9gCndpbmRvdy5aZXB0byA9IFplcHRvCickJyBpbiB3aW5kb3cgfHwgKHdpbmRvdy4kID0gWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyICQkID0gJC56ZXB0by5xc2EsIGhhbmRsZXJzID0ge30sIF96aWQgPSAxLCBzcGVjaWFsRXZlbnRzPXt9CgogIHNwZWNpYWxFdmVudHMuY2xpY2sgPSBzcGVjaWFsRXZlbnRzLm1vdXNlZG93biA9IHNwZWNpYWxFdmVudHMubW91c2V1cCA9IHNwZWNpYWxFdmVudHMubW91c2Vtb3ZlID0gJ01vdXNlRXZlbnRzJwoKICBmdW5jdGlvbiB6aWQoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuX3ppZCB8fCAoZWxlbWVudC5femlkID0gX3ppZCsrKQogIH0KICBmdW5jdGlvbiBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikgewogICAgZXZlbnQgPSBwYXJzZShldmVudCkKICAgIGlmIChldmVudC5ucykgdmFyIG1hdGNoZXIgPSBtYXRjaGVyRm9yKGV2ZW50Lm5zKQogICAgcmV0dXJuIChoYW5kbGVyc1t6aWQoZWxlbWVudCldIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24oaGFuZGxlcikgewogICAgICByZXR1cm4gaGFuZGxlcgogICAgICAgICYmICghZXZlbnQuZSAgfHwgaGFuZGxlci5lID09IGV2ZW50LmUpCiAgICAgICAgJiYgKCFldmVudC5ucyB8fCBtYXRjaGVyLnRlc3QoaGFuZGxlci5ucykpCiAgICAgICAgJiYgKCFmbiAgICAgICB8fCB6aWQoaGFuZGxlci5mbikgPT09IHppZChmbikpCiAgICAgICAgJiYgKCFzZWxlY3RvciB8fCBoYW5kbGVyLnNlbCA9PSBzZWxlY3RvcikKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHBhcnNlKGV2ZW50KSB7CiAgICB2YXIgcGFydHMgPSAoJycgKyBldmVudCkuc3BsaXQoJy4nKQogICAgcmV0dXJuIHtlOiBwYXJ0c1swXSwgbnM6IHBhcnRzLnNsaWNlKDEpLnNvcnQoKS5qb2luKCcgJyl9CiAgfQogIGZ1bmN0aW9uIG1hdGNoZXJGb3IobnMpIHsKICAgIHJldHVybiBuZXcgUmVnRXhwKCcoPzpefCApJyArIG5zLnJlcGxhY2UoJyAnLCAnIC4qID8nKSArICcoPzogfCQpJykKICB9CgogIGZ1bmN0aW9uIGVhY2hFdmVudChldmVudHMsIGZuLCBpdGVyYXRvcil7CiAgICBpZiAoJC5pc09iamVjdChldmVudHMpKSAkLmVhY2goZXZlbnRzLCBpdGVyYXRvcikKICAgIGVsc2UgZXZlbnRzLnNwbGl0KC9ccy8pLmZvckVhY2goZnVuY3Rpb24odHlwZSl7IGl0ZXJhdG9yKHR5cGUsIGZuKSB9KQogIH0KCiAgLy8gV0FSTiBmaXggbmFtZXNwYWNlZCBmb2N1cyAmIGJsdXIgZXZlbnRzIGRlbGVnYXRpb24uIElzc3VlcyAjNTUyICYgIzU5NyBwYXRjaGVkIGZyb20gdGhlIHVwc3RyZWFtIGNoYW5nZXM6CiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC9iYmI1Y2ExN2Q3YzE4NzRjZmYyYTlhN2MzZWE5NGE4YzhkNzlhNzkxCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC83NGJkNmY1MzFjNWJhMTU0YmU0OGU0OGZmMjIzOTI5YTBmNTdjMmZhCiAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYKICAgICAgKGhhbmRsZXIuZSA9PSAnZm9jdXMnIHx8IGhhbmRsZXIuZSA9PSAnYmx1cicpIHx8CiAgICAgICEhY2FwdHVyZVNldHRpbmcKICB9CgogIGZ1bmN0aW9uIGFkZChlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgZ2V0RGVsZWdhdGUsIGNhcHR1cmUpewogICAgdmFyIGlkID0gemlkKGVsZW1lbnQpLCBzZXQgPSAoaGFuZGxlcnNbaWRdIHx8IChoYW5kbGVyc1tpZF0gPSBbXSkpCiAgICBlYWNoRXZlbnQoZXZlbnRzLCBmbiwgZnVuY3Rpb24oZXZlbnQsIGZuKXsKICAgICAgdmFyIGRlbGVnYXRlID0gZ2V0RGVsZWdhdGUgJiYgZ2V0RGVsZWdhdGUoZm4sIGV2ZW50KSwKICAgICAgICBjYWxsYmFjayA9IGRlbGVnYXRlIHx8IGZuCiAgICAgIHZhciBwcm94eWZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmFwcGx5KGVsZW1lbnQsIFtldmVudF0uY29uY2F0KGV2ZW50LmRhdGEpKQogICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICB9CiAgICAgIHZhciBoYW5kbGVyID0gJC5leHRlbmQocGFyc2UoZXZlbnQpLCB7Zm46IGZuLCBwcm94eTogcHJveHlmbiwgc2VsOiBzZWxlY3RvciwgZGVsOiBkZWxlZ2F0ZSwgaTogc2V0Lmxlbmd0aH0pCiAgICAgIHNldC5wdXNoKGhhbmRsZXIpCiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihoYW5kbGVyLmUsIHByb3h5Zm4sIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHJlbW92ZShlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCkKICAgIGVhY2hFdmVudChldmVudHMgfHwgJycsIGZuLCBmdW5jdGlvbihldmVudCwgZm4pewogICAgICBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikuZm9yRWFjaChmdW5jdGlvbihoYW5kbGVyKXsKICAgICAgICBkZWxldGUgaGFuZGxlcnNbaWRdW2hhbmRsZXIuaV0KICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoaGFuZGxlci5lLCBoYW5kbGVyLnByb3h5LCBldmVudENhcHR1cmUoaGFuZGxlciwgY2FwdHVyZSkpCiAgICAgIH0pCiAgICB9KQogIH0KCiAgJC5ldmVudCA9IHsgYWRkOiBhZGQsIHJlbW92ZTogcmVtb3ZlIH0KCiAgJC5wcm94eSA9IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGZuKSkgewogICAgICB2YXIgcHJveHlGbiA9IGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpIH0KICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKQogICAgICByZXR1cm4gcHJveHlGbgogICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gJC5wcm94eShmbltjb250ZXh0XSwgZm4pCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJleHBlY3RlZCBmdW5jdGlvbiIpCiAgICB9CiAgfQoKICAkLmZuLmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICBhZGQodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi51bmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi5vbmUgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKHRoaXMsIGV2ZW50LCBjYWxsYmFjaywgbnVsbCwgZnVuY3Rpb24oZm4sIHR5cGUpewogICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KGVsZW1lbnQsIGFyZ3VtZW50cykKICAgICAgICAgIHJlbW92ZShlbGVtZW50LCB0eXBlLCBmbikKICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH0KCiAgdmFyIHJldHVyblRydWUgPSBmdW5jdGlvbigpe3JldHVybiB0cnVlfSwKICAgICAgcmV0dXJuRmFsc2UgPSBmdW5jdGlvbigpe3JldHVybiBmYWxzZX0sCiAgICAgIGV2ZW50TWV0aG9kcyA9IHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogJ2lzRGVmYXVsdFByZXZlbnRlZCcsCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiAnaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQnLAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogJ2lzUHJvcGFnYXRpb25TdG9wcGVkJwogICAgICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJveHkoZXZlbnQpIHsKICAgIHZhciBwcm94eSA9ICQuZXh0ZW5kKHtvcmlnaW5hbEV2ZW50OiBldmVudH0sIGV2ZW50KQogICAgJC5lYWNoKGV2ZW50TWV0aG9kcywgZnVuY3Rpb24obmFtZSwgcHJlZGljYXRlKSB7CiAgICAgIHByb3h5W25hbWVdID0gZnVuY3Rpb24oKXsKICAgICAgICB0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlCiAgICAgICAgcmV0dXJuIGV2ZW50W25hbWVdLmFwcGx5KGV2ZW50LCBhcmd1bWVudHMpCiAgICAgIH0KICAgICAgcHJveHlbcHJlZGljYXRlXSA9IHJldHVybkZhbHNlCiAgICB9KQogICAgcmV0dXJuIHByb3h5CiAgfQoKICAvLyBlbXVsYXRlcyB0aGUgJ2RlZmF1bHRQcmV2ZW50ZWQnIHByb3BlcnR5IGZvciBicm93c2VycyB0aGF0IGhhdmUgbm9uZQogIGZ1bmN0aW9uIGZpeChldmVudCkgewogICAgaWYgKCEoJ2RlZmF1bHRQcmV2ZW50ZWQnIGluIGV2ZW50KSkgewogICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2UKICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWUKICAgICAgICBwcmV2ZW50LmNhbGwodGhpcykKICAgICAgfQogICAgfQogIH0KCiAgJC5mbi5kZWxlZ2F0ZSA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKGVsZW1lbnQsIGV2ZW50LCBjYWxsYmFjaywgc2VsZWN0b3IsIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgZXZ0LCBtYXRjaCA9ICQoZS50YXJnZXQpLmNsb3Nlc3Qoc2VsZWN0b3IsIGVsZW1lbnQpLmdldCgwKQogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGV2dCA9ICQuZXh0ZW5kKGNyZWF0ZVByb3h5KGUpLCB7Y3VycmVudFRhcmdldDogbWF0Y2gsIGxpdmVGaXJlZDogZWxlbWVudH0pCiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShtYXRjaCwgW2V2dF0uY29uY2F0KFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9CiAgJC5mbi51bmRlbGVnYXRlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIHJlbW92ZSh0aGlzLCBldmVudCwgY2FsbGJhY2ssIHNlbGVjdG9yKQogICAgfSkKICB9CgogICQuZm4ubGl2ZSA9IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjayl7CiAgICAkKGRvY3VtZW50LmJvZHkpLmRlbGVnYXRlKHRoaXMuc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjaykKICAgIHJldHVybiB0aGlzCiAgfQogICQuZm4uZGllID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXsKICAgICQoZG9jdW1lbnQuYm9keSkudW5kZWxlZ2F0ZSh0aGlzLnNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgICByZXR1cm4gdGhpcwogIH0KCiAgJC5mbi5vbiA9IGZ1bmN0aW9uKGV2ZW50LCBzZWxlY3RvciwgY2FsbGJhY2spewogICAgcmV0dXJuIHNlbGVjdG9yID09IHVuZGVmaW5lZCB8fCAkLmlzRnVuY3Rpb24oc2VsZWN0b3IpID8KICAgICAgdGhpcy5iaW5kKGV2ZW50LCBzZWxlY3RvcikgOiB0aGlzLmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQogICQuZm4ub2ZmID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayl7CiAgICByZXR1cm4gc2VsZWN0b3IgPT0gdW5kZWZpbmVkIHx8ICQuaXNGdW5jdGlvbihzZWxlY3RvcikgPwogICAgICB0aGlzLnVuYmluZChldmVudCwgc2VsZWN0b3IpIDogdGhpcy51bmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQoKICAkLmZuLnRyaWdnZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICBpZiAodHlwZW9mIGV2ZW50ID09ICdzdHJpbmcnKSBldmVudCA9ICQuRXZlbnQoZXZlbnQpCiAgICBmaXgoZXZlbnQpCiAgICBldmVudC5kYXRhID0gZGF0YQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAvLyBpdGVtcyBpbiB0aGUgY29sbGVjdGlvbiBtaWdodCBub3QgYmUgRE9NIGVsZW1lbnRzCiAgICAgIC8vICh0b2RvOiBwb3NzaWJseSBzdXBwb3J0IGV2ZW50cyBvbiBwbGFpbiBvbGQgb2JqZWN0cykKICAgICAgaWYoJ2Rpc3BhdGNoRXZlbnQnIGluIHRoaXMpIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCkKICAgIH0pCiAgfQoKICAvLyB0cmlnZ2VycyBldmVudCBoYW5kbGVycyBvbiBjdXJyZW50IGVsZW1lbnQganVzdCBhcyBpZiBhbiBldmVudCBvY2N1cnJlZCwKICAvLyBkb2Vzbid0IHRyaWdnZXIgYW4gYWN0dWFsIGV2ZW50LCBkb2Vzbid0IGJ1YmJsZQogICQuZm4udHJpZ2dlckhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICB2YXIgZSwgcmVzdWx0CiAgICB0aGlzLmVhY2goZnVuY3Rpb24oaSwgZWxlbWVudCl7CiAgICAgIGUgPSBjcmVhdGVQcm94eSh0eXBlb2YgZXZlbnQgPT0gJ3N0cmluZycgPyAkLkV2ZW50KGV2ZW50KSA6IGV2ZW50KQogICAgICBlLmRhdGEgPSBkYXRhCiAgICAgIGUudGFyZ2V0ID0gZWxlbWVudAogICAgICAkLmVhY2goZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LnR5cGUgfHwgZXZlbnQpLCBmdW5jdGlvbihpLCBoYW5kbGVyKXsKICAgICAgICByZXN1bHQgPSBoYW5kbGVyLnByb3h5KGUpCiAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuIGZhbHNlCiAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gc2hvcnRjdXQgbWV0aG9kcyBmb3IgYC5iaW5kKGV2ZW50LCBmbilgIGZvciBlYWNoIGV2ZW50IHR5cGUKICA7KCdmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgJysKICAnbW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCAnKwogICdjaGFuZ2Ugc2VsZWN0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3InKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKGV2ZW50LCBjYWxsYmFjaykgfQogIH0pCgogIDtbJ2ZvY3VzJywgJ2JsdXInXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICQuZm5bbmFtZV0gPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZChuYW1lLCBjYWxsYmFjaykKICAgICAgZWxzZSBpZiAodGhpcy5sZW5ndGgpIHRyeSB7IHRoaXMuZ2V0KDApW25hbWVdKCkgfSBjYXRjaChlKXt9CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgJC5FdmVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChzcGVjaWFsRXZlbnRzW3R5cGVdIHx8ICdFdmVudHMnKSwgYnViYmxlcyA9IHRydWUKICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgKG5hbWUgPT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwcm9wc1tuYW1lXSkgOiAoZXZlbnRbbmFtZV0gPSBwcm9wc1tuYW1lXSkKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCB0cnVlLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsKQogICAgcmV0dXJuIGV2ZW50CiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgZnVuY3Rpb24gZGV0ZWN0KHVhKXsKICAgIHZhciBvcyA9IHRoaXMub3MgPSB7fSwgYnJvd3NlciA9IHRoaXMuYnJvd3NlciA9IHt9LAogICAgICB3ZWJraXQgPSB1YS5tYXRjaCgvV2ViS2l0XC8oW1xkLl0rKS8pLAogICAgICBhbmRyb2lkID0gdWEubWF0Y2goLyhBbmRyb2lkKVxzKyhbXGQuXSspLyksCiAgICAgIGlwYWQgPSB1YS5tYXRjaCgvKGlQYWQpLipPU1xzKFtcZF9dKykvKSwKICAgICAgaXBob25lID0gIWlwYWQgJiYgdWEubWF0Y2goLyhpUGhvbmVcc09TKVxzKFtcZF9dKykvKSwKICAgICAgd2Vib3MgPSB1YS5tYXRjaCgvKHdlYk9TfGhwd09TKVtcc1wvXShbXGQuXSspLyksCiAgICAgIHRvdWNocGFkID0gd2Vib3MgJiYgdWEubWF0Y2goL1RvdWNoUGFkLyksCiAgICAgIGtpbmRsZSA9IHVhLm1hdGNoKC9LaW5kbGVcLyhbXGQuXSspLyksCiAgICAgIHNpbGsgPSB1YS5tYXRjaCgvU2lsa1wvKFtcZC5fXSspLyksCiAgICAgIGJsYWNrYmVycnkgPSB1YS5tYXRjaCgvKEJsYWNrQmVycnkpLipWZXJzaW9uXC8oW1xkLl0rKS8pCgogICAgLy8gdG9kbyBjbGVhbiB0aGlzIHVwIHdpdGggYSBiZXR0ZXIgT1MvYnJvd3NlcgogICAgLy8gc2VwYXJhdGlvbi4gd2UgbmVlZCB0byBkaXNjZXJuIGJldHdlZW4gbXVsdGlwbGUKICAgIC8vIGJyb3dzZXJzIG9uIGFuZHJvaWQsIGFuZCBkZWNpZGUgaWYga2luZGxlIGZpcmUgaW4KICAgIC8vIHNpbGsgbW9kZSBpcyBhbmRyb2lkIG9yIG5vdAoKICAgIGlmIChicm93c2VyLndlYmtpdCA9ICEhd2Via2l0KSBicm93c2VyLnZlcnNpb24gPSB3ZWJraXRbMV0KCiAgICBpZiAoYW5kcm9pZCkgb3MuYW5kcm9pZCA9IHRydWUsIG9zLnZlcnNpb24gPSBhbmRyb2lkWzJdCiAgICBpZiAoaXBob25lKSBvcy5pb3MgPSBvcy5pcGhvbmUgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBob25lWzJdLnJlcGxhY2UoL18vZywgJy4nKQogICAgaWYgKGlwYWQpIG9zLmlvcyA9IG9zLmlwYWQgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBhZFsyXS5yZXBsYWNlKC9fL2csICcuJykKICAgIGlmICh3ZWJvcykgb3Mud2Vib3MgPSB0cnVlLCBvcy52ZXJzaW9uID0gd2Vib3NbMl0KICAgIGlmICh0b3VjaHBhZCkgb3MudG91Y2hwYWQgPSB0cnVlCiAgICBpZiAoYmxhY2tiZXJyeSkgb3MuYmxhY2tiZXJyeSA9IHRydWUsIG9zLnZlcnNpb24gPSBibGFja2JlcnJ5WzJdCiAgICBpZiAoa2luZGxlKSBvcy5raW5kbGUgPSB0cnVlLCBvcy52ZXJzaW9uID0ga2luZGxlWzFdCiAgICBpZiAoc2lsaykgYnJvd3Nlci5zaWxrID0gdHJ1ZSwgYnJvd3Nlci52ZXJzaW9uID0gc2lsa1sxXQogICAgaWYgKCFzaWxrICYmIG9zLmFuZHJvaWQgJiYgdWEubWF0Y2goL0tpbmRsZSBGaXJlLykpIGJyb3dzZXIuc2lsayA9IHRydWUKICB9CgogIGRldGVjdC5jYWxsKCQsIG5hdmlnYXRvci51c2VyQWdlbnQpCiAgLy8gbWFrZSBhdmFpbGFibGUgdG8gdW5pdCB0ZXN0cwogICQuX19kZXRlY3QgPSBkZXRlY3QKCn0pKFplcHRvKQo7KGZ1bmN0aW9uKCQsIHVuZGVmaW5lZCl7CiAgdmFyIHByZWZpeCA9ICcnLCBldmVudFByZWZpeCwgZW5kRXZlbnROYW1lLCBlbmRBbmltYXRpb25OYW1lLAogICAgdmVuZG9ycyA9IHsgV2Via2l0OiAnd2Via2l0JywgTW96OiAnJywgTzogJ28nLCBtczogJ01TJyB9LAogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsIHRlc3RFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgc3VwcG9ydGVkVHJhbnNmb3JtcyA9IC9eKCh0cmFuc2xhdGV8cm90YXRlfHNjYWxlKShYfFl8WnwzZCk/fG1hdHJpeCgzZCk/fHBlcnNwZWN0aXZlfHNrZXcoWHxZKT8pJC9pLAogICAgY2xlYXJQcm9wZXJ0aWVzID0ge30KCiAgZnVuY3Rpb24gZG93bmNhc2Uoc3RyKSB7IHJldHVybiBzdHIudG9Mb3dlckNhc2UoKSB9CiAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnQobmFtZSkgeyByZXR1cm4gZXZlbnRQcmVmaXggPyBldmVudFByZWZpeCArIG5hbWUgOiBkb3duY2FzZShuYW1lKSB9CgogICQuZWFjaCh2ZW5kb3JzLCBmdW5jdGlvbih2ZW5kb3IsIGV2ZW50KXsKICAgIGlmICh0ZXN0RWwuc3R5bGVbdmVuZG9yICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgcHJlZml4ID0gJy0nICsgZG93bmNhc2UodmVuZG9yKSArICctJwogICAgICBldmVudFByZWZpeCA9IGV2ZW50CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0pCgogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eSddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zaXRpb24tZHVyYXRpb24nXSA9CiAgY2xlYXJQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPQogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAnYW5pbWF0aW9uLWR1cmF0aW9uJ10gPSAnJwoKICAkLmZ4ID0gewogICAgb2ZmOiAoZXZlbnRQcmVmaXggPT09IHVuZGVmaW5lZCAmJiB0ZXN0RWwuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID09PSB1bmRlZmluZWQpLAogICAgY3NzUHJlZml4OiBwcmVmaXgsCiAgICB0cmFuc2l0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnVHJhbnNpdGlvbkVuZCcpLAogICAgYW5pbWF0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnQW5pbWF0aW9uRW5kJykKICB9CgogICQuZm4uYW5pbWF0ZSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMsIGR1cmF0aW9uLCBlYXNlLCBjYWxsYmFjayl7CiAgICBpZiAoJC5pc09iamVjdChkdXJhdGlvbikpCiAgICAgIGVhc2UgPSBkdXJhdGlvbi5lYXNpbmcsIGNhbGxiYWNrID0gZHVyYXRpb24uY29tcGxldGUsIGR1cmF0aW9uID0gZHVyYXRpb24uZHVyYXRpb24KICAgIGlmIChkdXJhdGlvbikgZHVyYXRpb24gPSBkdXJhdGlvbiAvIDEwMDAKICAgIHJldHVybiB0aGlzLmFuaW0ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKQogIH0KCiAgJC5mbi5hbmltID0gZnVuY3Rpb24ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKXsKICAgIHZhciB0cmFuc2Zvcm1zLCBjc3NQcm9wZXJ0aWVzID0ge30sIGtleSwgdGhhdCA9IHRoaXMsIHdyYXBwZWRDYWxsYmFjaywgZW5kRXZlbnQgPSAkLmZ4LnRyYW5zaXRpb25FbmQKICAgIGlmIChkdXJhdGlvbiA9PT0gdW5kZWZpbmVkKSBkdXJhdGlvbiA9IDAuNAogICAgaWYgKCQuZngub2ZmKSBkdXJhdGlvbiA9IDAKCiAgICBpZiAodHlwZW9mIHByb3BlcnRpZXMgPT0gJ3N0cmluZycpIHsKICAgICAgLy8ga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPSBwcm9wZXJ0aWVzCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgZW5kRXZlbnQgPSAkLmZ4LmFuaW1hdGlvbkVuZAogICAgfSBlbHNlIHsKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnRpZXMpCiAgICAgICAgaWYgKHN1cHBvcnRlZFRyYW5zZm9ybXMudGVzdChrZXkpKSB7CiAgICAgICAgICB0cmFuc2Zvcm1zIHx8ICh0cmFuc2Zvcm1zID0gW10pCiAgICAgICAgICB0cmFuc2Zvcm1zLnB1c2goa2V5ICsgJygnICsgcHJvcGVydGllc1trZXldICsgJyknKQogICAgICAgIH0KICAgICAgICBlbHNlIGNzc1Byb3BlcnRpZXNba2V5XSA9IHByb3BlcnRpZXNba2V5XQoKICAgICAgaWYgKHRyYW5zZm9ybXMpIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zZm9ybSddID0gdHJhbnNmb3Jtcy5qb2luKCcgJykKICAgICAgaWYgKCEkLmZ4Lm9mZiAmJiB0eXBlb2YgcHJvcGVydGllcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXByb3BlcnR5J10gPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKS5qb2luKCcsICcpCiAgICAgICAgY3NzUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0gKGVhc2UgfHwgJ2xpbmVhcicpCiAgICAgIH0KICAgIH0KCiAgICB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbihldmVudCl7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gZXZlbnQuY3VycmVudFRhcmdldCkgcmV0dXJuIC8vIG1ha2VzIHN1cmUgdGhlIGV2ZW50IGRpZG4ndCBidWJibGUgZnJvbSAiYmVsb3ciCiAgICAgICAgJChldmVudC50YXJnZXQpLnVuYmluZChlbmRFdmVudCwgYXJndW1lbnRzLmNhbGxlZSkKICAgICAgfQogICAgICAkKHRoaXMpLmNzcyhjbGVhclByb3BlcnRpZXMpCiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcykKICAgIH0KICAgIGlmIChkdXJhdGlvbiA+IDApIHRoaXMuYmluZChlbmRFdmVudCwgd3JhcHBlZENhbGxiYWNrKQoKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHRoYXQuY3NzKGNzc1Byb3BlcnRpZXMpCiAgICAgIGlmIChkdXJhdGlvbiA8PSAwKSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRoYXQuZWFjaChmdW5jdGlvbigpeyB3cmFwcGVkQ2FsbGJhY2suY2FsbCh0aGlzKSB9KQogICAgICB9LCAwKQogICAgfSwgMCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdGVzdEVsID0gbnVsbAp9KShaZXB0bykKOyhmdW5jdGlvbigkKXsKICB2YXIganNvbnBJRCA9IDAsCiAgICAgIGlzT2JqZWN0ID0gJC5pc09iamVjdCwKICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGtleSwKICAgICAgbmFtZSwKICAgICAgcnNjcmlwdCA9IC88c2NyaXB0XGJbXjxdKig/Oig/ITxcL3NjcmlwdD4pPFtePF0qKSo8XC9zY3JpcHQ+L2dpLAogICAgICBzY3JpcHRUeXBlUkUgPSAvXig/OnRleHR8YXBwbGljYXRpb24pXC9qYXZhc2NyaXB0L2ksCiAgICAgIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pLAogICAgICBqc29uVHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgaHRtbFR5cGUgPSAndGV4dC9odG1sJywKICAgICAgYmxhbmtSRSA9IC9eXHMqJC8KCiAgLy8gdHJpZ2dlciBhIGN1c3RvbSBldmVudCBhbmQgcmV0dXJuIGZhbHNlIGlmIGl0IHdhcyBjYW5jZWxsZWQKICBmdW5jdGlvbiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50ID0gJC5FdmVudChldmVudE5hbWUpCiAgICAkKGNvbnRleHQpLnRyaWdnZXIoZXZlbnQsIGRhdGEpCiAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQKICB9CgogIC8vIHRyaWdnZXIgYW4gQWpheCAiZ2xvYmFsIiBldmVudAogIGZ1bmN0aW9uIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCkgcmV0dXJuIHRyaWdnZXJBbmRSZXR1cm4oY29udGV4dCB8fCBkb2N1bWVudCwgZXZlbnROYW1lLCBkYXRhKQogIH0KCiAgLy8gTnVtYmVyIG9mIGFjdGl2ZSBBamF4IHJlcXVlc3RzCiAgJC5hY3RpdmUgPSAwCgogIGZ1bmN0aW9uIGFqYXhTdGFydChzZXR0aW5ncykgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCAmJiAkLmFjdGl2ZSsrID09PSAwKSB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBudWxsLCAnYWpheFN0YXJ0JykKICB9CiAgZnVuY3Rpb24gYWpheFN0b3Aoc2V0dGluZ3MpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwgJiYgISgtLSQuYWN0aXZlKSkgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgbnVsbCwgJ2FqYXhTdG9wJykKICB9CgogIC8vIHRyaWdnZXJzIGFuIGV4dHJhIGdsb2JhbCBldmVudCAiYWpheEJlZm9yZVNlbmQiIHRoYXQncyBsaWtlICJhamF4U2VuZCIgYnV0IGNhbmNlbGFibGUKICBmdW5jdGlvbiBhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSB7CiAgICB2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQKICAgIGlmIChzZXR0aW5ncy5iZWZvcmVTZW5kLmNhbGwoY29udGV4dCwgeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlIHx8CiAgICAgICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhCZWZvcmVTZW5kJywgW3hociwgc2V0dGluZ3NdKSA9PT0gZmFsc2UpCiAgICAgIHJldHVybiBmYWxzZQoKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U2VuZCcsIFt4aHIsIHNldHRpbmdzXSkKICB9CiAgZnVuY3Rpb24gYWpheFN1Y2Nlc3MoZGF0YSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0LCBzdGF0dXMgPSAnc3VjY2VzcycKICAgIHNldHRpbmdzLnN1Y2Nlc3MuY2FsbChjb250ZXh0LCBkYXRhLCBzdGF0dXMsIHhocikKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U3VjY2VzcycsIFt4aHIsIHNldHRpbmdzLCBkYXRhXSkKICAgIGFqYXhDb21wbGV0ZShzdGF0dXMsIHhociwgc2V0dGluZ3MpCiAgfQogIC8vIHR5cGU6ICJ0aW1lb3V0IiwgImVycm9yIiwgImFib3J0IiwgInBhcnNlcmVycm9yIgogIGZ1bmN0aW9uIGFqYXhFcnJvcihlcnJvciwgdHlwZSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5lcnJvci5jYWxsKGNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpCiAgICB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCAnYWpheEVycm9yJywgW3hociwgc2V0dGluZ3MsIGVycm9yXSkKICAgIGFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKQogIH0KICAvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5jb21wbGV0ZS5jYWxsKGNvbnRleHQsIHhociwgc3RhdHVzKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhDb21wbGV0ZScsIFt4aHIsIHNldHRpbmdzXSkKICAgIGFqYXhTdG9wKHNldHRpbmdzKQogIH0KCiAgLy8gRW1wdHkgZnVuY3Rpb24sIHVzZWQgYXMgZGVmYXVsdCBjYWxsYmFjawogIGZ1bmN0aW9uIGVtcHR5KCkge30KCiAgJC5hamF4SlNPTlAgPSBmdW5jdGlvbihvcHRpb25zKXsKICAgIHZhciBjYWxsYmFja05hbWUgPSAnanNvbnAnICsgKCsranNvbnBJRCksCiAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICBhYm9ydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgICAgaWYgKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZW1wdHkKICAgICAgICBhamF4Q29tcGxldGUoJ2Fib3J0JywgeGhyLCBvcHRpb25zKQogICAgICB9LAogICAgICB4aHIgPSB7IGFib3J0OiBhYm9ydCB9LCBhYm9ydFRpbWVvdXQKCiAgICBpZiAob3B0aW9ucy5lcnJvcikgc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgeGhyLmFib3J0KCkKICAgICAgb3B0aW9ucy5lcnJvcigpCiAgICB9CgogICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbihkYXRhKXsKICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgIGRlbGV0ZSB3aW5kb3dbY2FsbGJhY2tOYW1lXQogICAgICBhamF4U3VjY2VzcyhkYXRhLCB4aHIsIG9wdGlvbnMpCiAgICB9CgogICAgc2VyaWFsaXplRGF0YShvcHRpb25zKQogICAgc2NyaXB0LnNyYyA9IG9wdGlvbnMudXJsLnJlcGxhY2UoLz1cPy8sICc9JyArIGNhbGxiYWNrTmFtZSkKICAgICQoJ2hlYWQnKS5hcHBlbmQoc2NyaXB0KQoKICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSBhYm9ydFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICBhamF4Q29tcGxldGUoJ3RpbWVvdXQnLCB4aHIsIG9wdGlvbnMpCiAgICAgIH0sIG9wdGlvbnMudGltZW91dCkKCiAgICByZXR1cm4geGhyCiAgfQoKICAkLmFqYXhTZXR0aW5ncyA9IHsKICAgIC8vIERlZmF1bHQgdHlwZSBvZiByZXF1ZXN0CiAgICB0eXBlOiAnR0VUJywKICAgIC8vIENhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgYmVmb3JlIHJlcXVlc3QKICAgIGJlZm9yZVNlbmQ6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBpZiB0aGUgcmVxdWVzdCBzdWNjZWVkcwogICAgc3VjY2VzczogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIHRoZSB0aGUgc2VydmVyIGRyb3BzIGVycm9yCiAgICBlcnJvcjogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIG9uIHJlcXVlc3QgY29tcGxldGUgKGJvdGg6IGVycm9yIGFuZCBzdWNjZXNzKQogICAgY29tcGxldGU6IGVtcHR5LAogICAgLy8gVGhlIGNvbnRleHQgZm9yIHRoZSBjYWxsYmFja3MKICAgIGNvbnRleHQ6IG51bGwsCiAgICAvLyBXaGV0aGVyIHRvIHRyaWdnZXIgImdsb2JhbCIgQWpheCBldmVudHMKICAgIGdsb2JhbDogdHJ1ZSwKICAgIC8vIFRyYW5zcG9ydAogICAgeGhyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCkKICAgIH0sCiAgICAvLyBNSU1FIHR5cGVzIG1hcHBpbmcKICAgIGFjY2VwdHM6IHsKICAgICAgc2NyaXB0OiAndGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JywKICAgICAganNvbjogICBqc29uVHlwZSwKICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgIGh0bWw6ICAgaHRtbFR5cGUsCiAgICAgIHRleHQ6ICAgJ3RleHQvcGxhaW4nCiAgICB9LAogICAgLy8gV2hldGhlciB0aGUgcmVxdWVzdCBpcyB0byBhbm90aGVyIGRvbWFpbgogICAgY3Jvc3NEb21haW46IGZhbHNlLAogICAgLy8gRGVmYXVsdCB0aW1lb3V0CiAgICB0aW1lb3V0OiAwCiAgfQoKICBmdW5jdGlvbiBtaW1lVG9EYXRhVHlwZShtaW1lKSB7CiAgICByZXR1cm4gbWltZSAmJiAoIG1pbWUgPT0gaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICBtaW1lID09IGpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgc2NyaXB0VHlwZVJFLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgIHhtbFR5cGVSRS50ZXN0KG1pbWUpICYmICd4bWwnICkgfHwgJ3RleHQnCiAgfQoKICBmdW5jdGlvbiBhcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KSB7CiAgICByZXR1cm4gKHVybCArICcmJyArIHF1ZXJ5KS5yZXBsYWNlKC9bJj9dezEsMn0vLCAnPycpCiAgfQoKICAvLyBzZXJpYWxpemUgcGF5bG9hZCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBVUkwgZm9yIEdFVCByZXF1ZXN0cwogIGZ1bmN0aW9uIHNlcmlhbGl6ZURhdGEob3B0aW9ucykgewogICAgaWYgKGlzT2JqZWN0KG9wdGlvbnMuZGF0YSkpIG9wdGlvbnMuZGF0YSA9ICQucGFyYW0ob3B0aW9ucy5kYXRhKQogICAgaWYgKG9wdGlvbnMuZGF0YSAmJiAoIW9wdGlvbnMudHlwZSB8fCBvcHRpb25zLnR5cGUudG9VcHBlckNhc2UoKSA9PSAnR0VUJykpCiAgICAgIG9wdGlvbnMudXJsID0gYXBwZW5kUXVlcnkob3B0aW9ucy51cmwsIG9wdGlvbnMuZGF0YSkKICB9CgogICQuYWpheCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIG9wdGlvbnMgfHwge30pCiAgICBmb3IgKGtleSBpbiAkLmFqYXhTZXR0aW5ncykgaWYgKHNldHRpbmdzW2tleV0gPT09IHVuZGVmaW5lZCkgc2V0dGluZ3Nba2V5XSA9ICQuYWpheFNldHRpbmdzW2tleV0KCiAgICBhamF4U3RhcnQoc2V0dGluZ3MpCgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgc2V0dGluZ3MuY3Jvc3NEb21haW4gPSAvXihbXHctXSs6KT9cL1wvKFteXC9dKykvLnRlc3Qoc2V0dGluZ3MudXJsKSAmJgogICAgICBSZWdFeHAuJDIgIT0gd2luZG93LmxvY2F0aW9uLmhvc3QKCiAgICB2YXIgZGF0YVR5cGUgPSBzZXR0aW5ncy5kYXRhVHlwZSwgaGFzUGxhY2Vob2xkZXIgPSAvPVw/Ly50ZXN0KHNldHRpbmdzLnVybCkKICAgIGlmIChkYXRhVHlwZSA9PSAnanNvbnAnIHx8IGhhc1BsYWNlaG9sZGVyKSB7CiAgICAgIGlmICghaGFzUGxhY2Vob2xkZXIpIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwgJ2NhbGxiYWNrPT8nKQogICAgICByZXR1cm4gJC5hamF4SlNPTlAoc2V0dGluZ3MpCiAgICB9CgogICAgaWYgKCFzZXR0aW5ncy51cmwpIHNldHRpbmdzLnVybCA9IHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpCiAgICBzZXJpYWxpemVEYXRhKHNldHRpbmdzKQoKICAgIHZhciBtaW1lID0gc2V0dGluZ3MuYWNjZXB0c1tkYXRhVHlwZV0sCiAgICAgICAgYmFzZUhlYWRlcnMgPSB7IH0sCiAgICAgICAgcHJvdG9jb2wgPSAvXihbXHctXSs6KVwvXC8vLnRlc3Qoc2V0dGluZ3MudXJsKSA/IFJlZ0V4cC4kMSA6IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCwKICAgICAgICB4aHIgPSAkLmFqYXhTZXR0aW5ncy54aHIoKSwgYWJvcnRUaW1lb3V0CgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgYmFzZUhlYWRlcnNbJ1gtUmVxdWVzdGVkLVdpdGgnXSA9ICdYTUxIdHRwUmVxdWVzdCcKICAgIGlmIChtaW1lKSB7CiAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWUKICAgICAgaWYgKG1pbWUuaW5kZXhPZignLCcpID4gLTEpIG1pbWUgPSBtaW1lLnNwbGl0KCcsJywgMilbMF0KICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUobWltZSkKICAgIH0KICAgIGlmIChzZXR0aW5ncy5jb250ZW50VHlwZSB8fCAoc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlLnRvVXBwZXJDYXNlKCkgIT0gJ0dFVCcpKQogICAgICBiYXNlSGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpCiAgICBzZXR0aW5ncy5oZWFkZXJzID0gJC5leHRlbmQoYmFzZUhlYWRlcnMsIHNldHRpbmdzLmhlYWRlcnMgfHwge30pCgogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlCiAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09IDMwNCB8fCAoeGhyLnN0YXR1cyA9PSAwICYmIHByb3RvY29sID09ICdmaWxlOicpKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpCiAgICAgICAgICByZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGRhdGFUeXBlID09ICdzY3JpcHQnKSAgICAoMSxldmFsKShyZXN1bHQpCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICd4bWwnKSAgcmVzdWx0ID0geGhyLnJlc3BvbnNlWE1MCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICdqc29uJykgcmVzdWx0ID0gYmxhbmtSRS50ZXN0KHJlc3VsdCkgPyBudWxsIDogSlNPTi5wYXJzZShyZXN1bHQpCiAgICAgICAgICB9IGNhdGNoIChlKSB7IGVycm9yID0gZSB9CgogICAgICAgICAgaWYgKGVycm9yKSBhamF4RXJyb3IoZXJyb3IsICdwYXJzZXJlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgICBlbHNlIGFqYXhTdWNjZXNzKHJlc3VsdCwgeGhyLCBzZXR0aW5ncykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWpheEVycm9yKG51bGwsICdlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGFzeW5jID0gJ2FzeW5jJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLmFzeW5jIDogdHJ1ZQogICAgeGhyLm9wZW4oc2V0dGluZ3MudHlwZSwgc2V0dGluZ3MudXJsLCBhc3luYykKCiAgICBmb3IgKG5hbWUgaW4gc2V0dGluZ3MuaGVhZGVycykgeGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSkKCiAgICBpZiAoYWpheEJlZm9yZVNlbmQoeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlKSB7CiAgICAgIHhoci5hYm9ydCgpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmIChzZXR0aW5ncy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQogICAgICAgIHhoci5hYm9ydCgpCiAgICAgICAgYWpheEVycm9yKG51bGwsICd0aW1lb3V0JywgeGhyLCBzZXR0aW5ncykKICAgICAgfSwgc2V0dGluZ3MudGltZW91dCkKCiAgICAvLyBhdm9pZCBzZW5kaW5nIGVtcHR5IHN0cmluZyAoIzMxOSkKICAgIHhoci5zZW5kKHNldHRpbmdzLmRhdGEgPyBzZXR0aW5ncy5kYXRhIDogbnVsbCkKICAgIHJldHVybiB4aHIKICB9CgogICQuZ2V0ID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsgcmV0dXJuICQuYWpheCh7IHVybDogdXJsLCBzdWNjZXNzOiBzdWNjZXNzIH0pIH0KCiAgJC5wb3N0ID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzLCBkYXRhVHlwZSl7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGRhdGEpKSBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IHN1Y2Nlc3MsIHN1Y2Nlc3MgPSBkYXRhLCBkYXRhID0gbnVsbAogICAgcmV0dXJuICQuYWpheCh7IHR5cGU6ICdQT1NUJywgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHN1Y2Nlc3M6IHN1Y2Nlc3MsIGRhdGFUeXBlOiBkYXRhVHlwZSB9KQogIH0KCiAgJC5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIHJldHVybiAkLmFqYXgoeyB1cmw6IHVybCwgc3VjY2Vzczogc3VjY2VzcywgZGF0YVR5cGU6ICdqc29uJyB9KQogIH0KCiAgJC5mbi5sb2FkID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCiAgICB2YXIgc2VsZiA9IHRoaXMsIHBhcnRzID0gdXJsLnNwbGl0KC9ccy8pLCBzZWxlY3RvcgogICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHVybCA9IHBhcnRzWzBdLCBzZWxlY3RvciA9IHBhcnRzWzFdCiAgICAkLmdldCh1cmwsIGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKS5odG1sKHJlc3BvbnNlLnJlcGxhY2UocnNjcmlwdCwgIiIpKS5maW5kKHNlbGVjdG9yKS5odG1sKCkKICAgICAgICA6IHJlc3BvbnNlKQogICAgICBzdWNjZXNzICYmIHN1Y2Nlc3MuY2FsbChzZWxmKQogICAgfSkKICAgIHJldHVybiB0aGlzCiAgfQoKICB2YXIgZXNjYXBlID0gZW5jb2RlVVJJQ29tcG9uZW50CgogIGZ1bmN0aW9uIHNlcmlhbGl6ZShwYXJhbXMsIG9iaiwgdHJhZGl0aW9uYWwsIHNjb3BlKXsKICAgIHZhciBhcnJheSA9ICQuaXNBcnJheShvYmopCiAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChzY29wZSkga2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6IHNjb3BlICsgJ1snICsgKGFycmF5ID8gJycgOiBrZXkpICsgJ10nCiAgICAgIC8vIGhhbmRsZSBkYXRhIGluIHNlcmlhbGl6ZUFycmF5KCkgZm9ybWF0CiAgICAgIGlmICghc2NvcGUgJiYgYXJyYXkpIHBhcmFtcy5hZGQodmFsdWUubmFtZSwgdmFsdWUudmFsdWUpCiAgICAgIC8vIHJlY3Vyc2UgaW50byBuZXN0ZWQgb2JqZWN0cwogICAgICBlbHNlIGlmICh0cmFkaXRpb25hbCA/ICQuaXNBcnJheSh2YWx1ZSkgOiBpc09iamVjdCh2YWx1ZSkpCiAgICAgICAgc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpCiAgICAgIGVsc2UgcGFyYW1zLmFkZChrZXksIHZhbHVlKQogICAgfSkKICB9CgogICQucGFyYW0gPSBmdW5jdGlvbihvYmosIHRyYWRpdGlvbmFsKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgcGFyYW1zLmFkZCA9IGZ1bmN0aW9uKGssIHYpeyB0aGlzLnB1c2goZXNjYXBlKGspICsgJz0nICsgZXNjYXBlKHYpKSB9CiAgICBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsKQogICAgcmV0dXJuIHBhcmFtcy5qb2luKCcmJykucmVwbGFjZSgnJTIwJywgJysnKQogIH0KfSkoWmVwdG8pCjsoZnVuY3Rpb24gKCQpIHsKICAkLmZuLnNlcmlhbGl6ZUFycmF5ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHJlc3VsdCA9IFtdLCBlbAogICAgJCggQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5nZXQoMCkuZWxlbWVudHMpICkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIGVsID0gJCh0aGlzKQogICAgICB2YXIgdHlwZSA9IGVsLmF0dHIoJ3R5cGUnKQogICAgICBpZiAodGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdmaWVsZHNldCcgJiYKICAgICAgICAhdGhpcy5kaXNhYmxlZCAmJiB0eXBlICE9ICdzdWJtaXQnICYmIHR5cGUgIT0gJ3Jlc2V0JyAmJiB0eXBlICE9ICdidXR0b24nICYmCiAgICAgICAgKCh0eXBlICE9ICdyYWRpbycgJiYgdHlwZSAhPSAnY2hlY2tib3gnKSB8fCB0aGlzLmNoZWNrZWQpKQogICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgIG5hbWU6IGVsLmF0dHIoJ25hbWUnKSwKICAgICAgICAgIHZhbHVlOiBlbC52YWwoKQogICAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgJC5mbi5zZXJpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcmVzdWx0ID0gW10KICAgIHRoaXMuc2VyaWFsaXplQXJyYXkoKS5mb3JFYWNoKGZ1bmN0aW9uIChlbG0pIHsKICAgICAgcmVzdWx0LnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChlbG0ubmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZWxtLnZhbHVlKSApCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdC5qb2luKCcmJykKICB9CgogICQuZm4uc3VibWl0ID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZCgnc3VibWl0JywgY2FsbGJhY2spCiAgICBlbHNlIGlmICh0aGlzLmxlbmd0aCkgewogICAgICB2YXIgZXZlbnQgPSAkLkV2ZW50KCdzdWJtaXQnKQogICAgICB0aGlzLmVxKDApLnRyaWdnZXIoZXZlbnQpCiAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgdGhpcy5nZXQoMCkuc3VibWl0KCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyIHRvdWNoID0ge30sIHRvdWNoVGltZW91dAoKICBmdW5jdGlvbiBwYXJlbnRJZlRleHQobm9kZSl7CiAgICByZXR1cm4gJ3RhZ05hbWUnIGluIG5vZGUgPyBub2RlIDogbm9kZS5wYXJlbnROb2RlCiAgfQoKICBmdW5jdGlvbiBzd2lwZURpcmVjdGlvbih4MSwgeDIsIHkxLCB5Mil7CiAgICB2YXIgeERlbHRhID0gTWF0aC5hYnMoeDEgLSB4MiksIHlEZWx0YSA9IE1hdGguYWJzKHkxIC0geTIpCiAgICByZXR1cm4geERlbHRhID49IHlEZWx0YSA/ICh4MSAtIHgyID4gMCA/ICdMZWZ0JyA6ICdSaWdodCcpIDogKHkxIC0geTIgPiAwID8gJ1VwJyA6ICdEb3duJykKICB9CgogIHZhciBsb25nVGFwRGVsYXkgPSA3NTAsIGxvbmdUYXBUaW1lb3V0CgogIGZ1bmN0aW9uIGxvbmdUYXAoKXsKICAgIGxvbmdUYXBUaW1lb3V0ID0gbnVsbAogICAgaWYgKHRvdWNoLmxhc3QpIHsKICAgICAgdG91Y2guZWwudHJpZ2dlcignbG9uZ1RhcCcpCiAgICAgIHRvdWNoID0ge30KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbmNlbExvbmdUYXAoKXsKICAgIGlmIChsb25nVGFwVGltZW91dCkgY2xlYXJUaW1lb3V0KGxvbmdUYXBUaW1lb3V0KQogICAgbG9uZ1RhcFRpbWVvdXQgPSBudWxsCiAgfQoKICAkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpewogICAgdmFyIG5vdywgZGVsdGEKCiAgICAkKGRvY3VtZW50LmJvZHkpLmJpbmQoJ3RvdWNoc3RhcnQnLCBmdW5jdGlvbihlKXsKICAgICAgbm93ID0gRGF0ZS5ub3coKQogICAgICBkZWx0YSA9IG5vdyAtICh0b3VjaC5sYXN0IHx8IG5vdykKICAgICAgdG91Y2guZWwgPSAkKHBhcmVudElmVGV4dChlLnRvdWNoZXNbMF0udGFyZ2V0KSkKICAgICAgdG91Y2hUaW1lb3V0ICYmIGNsZWFyVGltZW91dCh0b3VjaFRpbWVvdXQpCiAgICAgIHRvdWNoLngxID0gZS50b3VjaGVzWzBdLnBhZ2VYCiAgICAgIHRvdWNoLnkxID0gZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgIGlmIChkZWx0YSA+IDAgJiYgZGVsdGEgPD0gMjUwKSB0b3VjaC5pc0RvdWJsZVRhcCA9IHRydWUKICAgICAgdG91Y2gubGFzdCA9IG5vdwogICAgICBsb25nVGFwVGltZW91dCA9IHNldFRpbWVvdXQobG9uZ1RhcCwgbG9uZ1RhcERlbGF5KQogICAgfSkuYmluZCgndG91Y2htb3ZlJywgZnVuY3Rpb24oZSl7CiAgICAgIGNhbmNlbExvbmdUYXAoKQogICAgICB0b3VjaC54MiA9IGUudG91Y2hlc1swXS5wYWdlWAogICAgICB0b3VjaC55MiA9IGUudG91Y2hlc1swXS5wYWdlWQogICAgfSkuYmluZCgndG91Y2hlbmQnLCBmdW5jdGlvbihlKXsKICAgICAgIGNhbmNlbExvbmdUYXAoKQoKICAgICAgLy8gZG91YmxlIHRhcCAodGFwcGVkIHR3aWNlIHdpdGhpbiAyNTBtcykKICAgICAgaWYgKHRvdWNoLmlzRG91YmxlVGFwKSB7CiAgICAgICAgdG91Y2guZWwudHJpZ2dlcignZG91YmxlVGFwJykKICAgICAgICB0b3VjaCA9IHt9CgogICAgICAvLyBzd2lwZQogICAgICB9IGVsc2UgaWYgKCh0b3VjaC54MiAmJiBNYXRoLmFicyh0b3VjaC54MSAtIHRvdWNoLngyKSA+IDMwKSB8fAogICAgICAgICAgICAgICAgICh0b3VjaC55MiAmJiBNYXRoLmFicyh0b3VjaC55MSAtIHRvdWNoLnkyKSA+IDMwKSkgewogICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJykgJiYKICAgICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJyArIChzd2lwZURpcmVjdGlvbih0b3VjaC54MSwgdG91Y2gueDIsIHRvdWNoLnkxLCB0b3VjaC55MikpKQogICAgICAgIHRvdWNoID0ge30KCiAgICAgIC8vIG5vcm1hbCB0YXAKICAgICAgfSBlbHNlIGlmICgnbGFzdCcgaW4gdG91Y2gpIHsKICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCd0YXAnKQoKICAgICAgICB0b3VjaFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCdzaW5nbGVUYXAnKQogICAgICAgICAgdG91Y2ggPSB7fQogICAgICAgIH0sIDI1MCkKICAgICAgfQogICAgfSkuYmluZCgndG91Y2hjYW5jZWwnLCBmdW5jdGlvbigpewogICAgICBpZiAodG91Y2hUaW1lb3V0KSBjbGVhclRpbWVvdXQodG91Y2hUaW1lb3V0KQogICAgICBpZiAobG9uZ1RhcFRpbWVvdXQpIGNsZWFyVGltZW91dChsb25nVGFwVGltZW91dCkKICAgICAgbG9uZ1RhcFRpbWVvdXQgPSB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgIHRvdWNoID0ge30KICAgIH0pCiAgfSkKCiAgO1snc3dpcGUnLCAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnLCAnc3dpcGVVcCcsICdzd2lwZURvd24nLCAnZG91YmxlVGFwJywgJ3RhcCcsICdzaW5nbGVUYXAnLCAnbG9uZ1RhcCddLmZvckVhY2goZnVuY3Rpb24obSl7CiAgICAkLmZuW21dID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKG0sIGNhbGxiYWNrKSB9CiAgfSkKfSkoWmVwdG8pCgovLyBsaWIvaGFuZGxlYmFycy9iYXNlLmpzCgovKmpzaGludCBlcW51bGw6dHJ1ZSovCnRoaXMuSGFuZGxlYmFycyA9IHt9OwoKKGZ1bmN0aW9uKEhhbmRsZWJhcnMpIHsKCkhhbmRsZWJhcnMuVkVSU0lPTiA9ICIxLjAucmMuMSI7CgpIYW5kbGViYXJzLmhlbHBlcnMgID0ge307CkhhbmRsZWJhcnMucGFydGlhbHMgPSB7fTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogIGlmKGludmVyc2UpIHsgZm4ubm90ID0gaW52ZXJzZTsgfQogIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZuOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwgPSBmdW5jdGlvbihuYW1lLCBzdHIpIHsKICB0aGlzLnBhcnRpYWxzW25hbWVdID0gc3RyOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGFyZykgewogIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGZpbmQgcHJvcGVydHkgJyIgKyBhcmcgKyAiJyIpOwogIH0KfSk7Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLCBmdW5jdGlvblR5cGUgPSAiW29iamVjdCBGdW5jdGlvbl0iOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCgogIHZhciByZXQgPSAiIjsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CgogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmKGNvbnRleHQgPT09IHRydWUpIHsKICAgIHJldHVybiBmbih0aGlzKTsKICB9IGVsc2UgaWYoY29udGV4dCA9PT0gZmFsc2UgfHwgY29udGV4dCA9PSBudWxsKSB7CiAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgaWYodHlwZSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgaWYoY29udGV4dC5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnMuZWFjaChjb250ZXh0LCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpbnZlcnNlKHRoaXMpOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gZm4oY29udGV4dCk7CiAgfQp9KTsKCkhhbmRsZWJhcnMuSyA9IGZ1bmN0aW9uKCkge307CgpIYW5kbGViYXJzLmNyZWF0ZUZyYW1lID0gT2JqZWN0LmNyZWF0ZSB8fCBmdW5jdGlvbihvYmplY3QpIHsKICBIYW5kbGViYXJzLksucHJvdG90eXBlID0gb2JqZWN0OwogIHZhciBvYmogPSBuZXcgSGFuZGxlYmFycy5LKCk7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG51bGw7CiAgcmV0dXJuIG9iajsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VhY2gnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGZuID0gb3B0aW9ucy5mbiwgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZTsKICB2YXIgcmV0ID0gIiIsIGRhdGE7CgogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIGRhdGEgPSBIYW5kbGViYXJzLmNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgfQoKICBpZihjb250ZXh0ICYmIGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgZm9yKHZhciBpPTAsIGo9Y29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CiAgICAgIGlmIChkYXRhKSB7IGRhdGEuaW5kZXggPSBpOyB9CiAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRbaV0sIHsgZGF0YTogZGF0YSB9KTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0ID0gaW52ZXJzZSh0aGlzKTsKICB9CiAgcmV0dXJuIHJldDsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZicsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CiAgaWYodHlwZSA9PT0gZnVuY3Rpb25UeXBlKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH0KCiAgaWYoIWNvbnRleHQgfHwgSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbnRleHQpKSB7CiAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzKTsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndW5sZXNzJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgb3B0aW9ucy5mbiA9IGludmVyc2U7CiAgb3B0aW9ucy5pbnZlcnNlID0gZm47CgogIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnNbJ2lmJ10uY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd3aXRoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHJldHVybiBvcHRpb25zLmZuKGNvbnRleHQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGZ1bmN0aW9uKGNvbnRleHQpIHsKICBIYW5kbGViYXJzLmxvZyhjb250ZXh0KTsKfSk7Cgp9KHRoaXMuSGFuZGxlYmFycykpOwo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL3BhcnNlci5qcwovKiBKaXNvbiBnZW5lcmF0ZWQgcGFyc2VyICovCnZhciBoYW5kbGViYXJzID0gKGZ1bmN0aW9uKCl7CnZhciBwYXJzZXIgPSB7dHJhY2U6IGZ1bmN0aW9uIHRyYWNlKCkgeyB9LAp5eToge30sCnN5bWJvbHNfOiB7ImVycm9yIjoyLCJyb290IjozLCJwcm9ncmFtIjo0LCJFT0YiOjUsInN0YXRlbWVudHMiOjYsInNpbXBsZUludmVyc2UiOjcsInN0YXRlbWVudCI6OCwib3BlbkludmVyc2UiOjksImNsb3NlQmxvY2siOjEwLCJvcGVuQmxvY2siOjExLCJtdXN0YWNoZSI6MTIsInBhcnRpYWwiOjEzLCJDT05URU5UIjoxNCwiQ09NTUVOVCI6MTUsIk9QRU5fQkxPQ0siOjE2LCJpbk11c3RhY2hlIjoxNywiQ0xPU0UiOjE4LCJPUEVOX0lOVkVSU0UiOjE5LCJPUEVOX0VOREJMT0NLIjoyMCwicGF0aCI6MjEsIk9QRU4iOjIyLCJPUEVOX1VORVNDQVBFRCI6MjMsIk9QRU5fUEFSVElBTCI6MjQsInBhcmFtcyI6MjUsImhhc2giOjI2LCJEQVRBIjoyNywicGFyYW0iOjI4LCJTVFJJTkciOjI5LCJJTlRFR0VSIjozMCwiQk9PTEVBTiI6MzEsImhhc2hTZWdtZW50cyI6MzIsImhhc2hTZWdtZW50IjozMywiSUQiOjM0LCJFUVVBTFMiOjM1LCJwYXRoU2VnbWVudHMiOjM2LCJTRVAiOjM3LCIkYWNjZXB0IjowLCIkZW5kIjoxfSwKdGVybWluYWxzXzogezI6ImVycm9yIiw1OiJFT0YiLDE0OiJDT05URU5UIiwxNToiQ09NTUVOVCIsMTY6Ik9QRU5fQkxPQ0siLDE4OiJDTE9TRSIsMTk6Ik9QRU5fSU5WRVJTRSIsMjA6Ik9QRU5fRU5EQkxPQ0siLDIyOiJPUEVOIiwyMzoiT1BFTl9VTkVTQ0FQRUQiLDI0OiJPUEVOX1BBUlRJQUwiLDI3OiJEQVRBIiwyOToiU1RSSU5HIiwzMDoiSU5URUdFUiIsMzE6IkJPT0xFQU4iLDM0OiJJRCIsMzU6IkVRVUFMUyIsMzc6IlNFUCJ9LApwcm9kdWN0aW9uc186IFswLFszLDJdLFs0LDNdLFs0LDFdLFs0LDBdLFs2LDFdLFs2LDJdLFs4LDNdLFs4LDNdLFs4LDFdLFs4LDFdLFs4LDFdLFs4LDFdLFsxMSwzXSxbOSwzXSxbMTAsM10sWzEyLDNdLFsxMiwzXSxbMTMsM10sWzEzLDRdLFs3LDJdLFsxNywzXSxbMTcsMl0sWzE3LDJdLFsxNywxXSxbMTcsMV0sWzI1LDJdLFsyNSwxXSxbMjgsMV0sWzI4LDFdLFsyOCwxXSxbMjgsMV0sWzI4LDFdLFsyNiwxXSxbMzIsMl0sWzMyLDFdLFszMywzXSxbMzMsM10sWzMzLDNdLFszMywzXSxbMzMsM10sWzIxLDFdLFszNiwzXSxbMzYsMV1dLApwZXJmb3JtQWN0aW9uOiBmdW5jdGlvbiBhbm9ueW1vdXMoeXl0ZXh0LHl5bGVuZyx5eWxpbmVubyx5eSx5eXN0YXRlLCQkLF8kKSB7Cgp2YXIgJDAgPSAkJC5sZW5ndGggLSAxOwpzd2l0Y2ggKHl5c3RhdGUpIHsKY2FzZSAxOiByZXR1cm4gJCRbJDAtMV07IApicmVhazsKY2FzZSAyOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDAtMl0sICQkWyQwXSk7IApicmVhazsKY2FzZSAzOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDQ6IHRoaXMuJCA9IG5ldyB5eS5Qcm9ncmFtTm9kZShbXSk7IApicmVhazsKY2FzZSA1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSA3OiB0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMC0xXSwgJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDg6IHRoaXMuJCA9IG5ldyB5eS5CbG9ja05vZGUoJCRbJDAtMl0sICQkWyQwLTFdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMF0pOyAKYnJlYWs7CmNhc2UgOTogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMTA6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDExOiB0aGlzLiQgPSBuZXcgeXkuQ29udGVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEyOiB0aGlzLiQgPSBuZXcgeXkuQ29tbWVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEzOiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSk7IApicmVhazsKY2FzZSAxNDogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0pOyAKYnJlYWs7CmNhc2UgMTU6IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMTY6IHRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdKTsgCmJyZWFrOwpjYXNlIDE3OiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSwgdHJ1ZSk7IApicmVhazsKY2FzZSAxODogdGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOb2RlKCQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDE5OiB0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5vZGUoJCRbJDAtMl0sICQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDIwOiAKYnJlYWs7CmNhc2UgMjE6IHRoaXMuJCA9IFtbJCRbJDAtMl1dLmNvbmNhdCgkJFskMC0xXSksICQkWyQwXV07IApicmVhazsKY2FzZSAyMjogdGhpcy4kID0gW1skJFskMC0xXV0uY29uY2F0KCQkWyQwXSksIG51bGxdOyAKYnJlYWs7CmNhc2UgMjM6IHRoaXMuJCA9IFtbJCRbJDAtMV1dLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMjQ6IHRoaXMuJCA9IFtbJCRbJDBdXSwgbnVsbF07IApicmVhazsKY2FzZSAyNTogdGhpcy4kID0gW1tuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKV0sIG51bGxdOyAKYnJlYWs7CmNhc2UgMjY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSAyNzogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSAyODogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMjk6IHRoaXMuJCA9IG5ldyB5eS5TdHJpbmdOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMDogdGhpcy4kID0gbmV3IHl5LkludGVnZXJOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMTogdGhpcy4kID0gbmV3IHl5LkJvb2xlYW5Ob2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMjogdGhpcy4kID0gbmV3IHl5LkRhdGFOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMzogdGhpcy4kID0gbmV3IHl5Lkhhc2hOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzNDogJCRbJDAtMV0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0xXTsgCmJyZWFrOwpjYXNlIDM1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDM2OiB0aGlzLiQgPSBbJCRbJDAtMl0sICQkWyQwXV07IApicmVhazsKY2FzZSAzNzogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuU3RyaW5nTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM4OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5JbnRlZ2VyTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM5OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQwOiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5EYXRhTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQxOiB0aGlzLiQgPSBuZXcgeXkuSWROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSA0MjogJCRbJDAtMl0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0yXTsgCmJyZWFrOwpjYXNlIDQzOiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwp9Cn0sCnRhYmxlOiBbezM6MSw0OjIsNTpbMiw0XSw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezE6WzNdfSx7NTpbMSwxNl19LHs1OlsyLDNdLDc6MTcsODoxOCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxOV0sMjA6WzIsM10sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDVdLDE0OlsyLDVdLDE1OlsyLDVdLDE2OlsyLDVdLDE5OlsyLDVdLDIwOlsyLDVdLDIyOlsyLDVdLDIzOlsyLDVdLDI0OlsyLDVdfSx7NDoyMCw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiw0XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezQ6MjEsNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNF0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDldLDE0OlsyLDldLDE1OlsyLDldLDE2OlsyLDldLDE5OlsyLDldLDIwOlsyLDldLDIyOlsyLDldLDIzOlsyLDldLDI0OlsyLDldfSx7NTpbMiwxMF0sMTQ6WzIsMTBdLDE1OlsyLDEwXSwxNjpbMiwxMF0sMTk6WzIsMTBdLDIwOlsyLDEwXSwyMjpbMiwxMF0sMjM6WzIsMTBdLDI0OlsyLDEwXX0sezU6WzIsMTFdLDE0OlsyLDExXSwxNTpbMiwxMV0sMTY6WzIsMTFdLDE5OlsyLDExXSwyMDpbMiwxMV0sMjI6WzIsMTFdLDIzOlsyLDExXSwyNDpbMiwxMV19LHs1OlsyLDEyXSwxNDpbMiwxMl0sMTU6WzIsMTJdLDE2OlsyLDEyXSwxOTpbMiwxMl0sMjA6WzIsMTJdLDIyOlsyLDEyXSwyMzpbMiwxMl0sMjQ6WzIsMTJdfSx7MTc6MjIsMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezE3OjI3LDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxNzoyOCwyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTc6MjksMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezIxOjMwLDM0OlsxLDI2XSwzNjoyNX0sezE6WzIsMV19LHs2OjMxLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDZdLDE0OlsyLDZdLDE1OlsyLDZdLDE2OlsyLDZdLDE5OlsyLDZdLDIwOlsyLDZdLDIyOlsyLDZdLDIzOlsyLDZdLDI0OlsyLDZdfSx7MTc6MjIsMTg6WzEsMzJdLDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxMDozMywyMDpbMSwzNF19LHsxMDozNSwyMDpbMSwzNF19LHsxODpbMSwzNl19LHsxODpbMiwyNF0sMjE6NDEsMjU6MzcsMjY6MzgsMjc6WzEsNDVdLDI4OjM5LDI5OlsxLDQyXSwzMDpbMSw0M10sMzE6WzEsNDRdLDMyOjQwLDMzOjQ2LDM0OlsxLDQ3XSwzNjoyNX0sezE4OlsyLDI1XX0sezE4OlsyLDQxXSwyNzpbMiw0MV0sMjk6WzIsNDFdLDMwOlsyLDQxXSwzMTpbMiw0MV0sMzQ6WzIsNDFdLDM3OlsxLDQ4XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM3OlsyLDQzXX0sezE4OlsxLDQ5XX0sezE4OlsxLDUwXX0sezE4OlsxLDUxXX0sezE4OlsxLDUyXSwyMTo1MywzNDpbMSwyNl0sMzY6MjV9LHs1OlsyLDJdLDg6MTgsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIwOlsyLDJdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7MTQ6WzIsMjBdLDE1OlsyLDIwXSwxNjpbMiwyMF0sMTk6WzIsMjBdLDIyOlsyLDIwXSwyMzpbMiwyMF0sMjQ6WzIsMjBdfSx7NTpbMiw3XSwxNDpbMiw3XSwxNTpbMiw3XSwxNjpbMiw3XSwxOTpbMiw3XSwyMDpbMiw3XSwyMjpbMiw3XSwyMzpbMiw3XSwyNDpbMiw3XX0sezIxOjU0LDM0OlsxLDI2XSwzNjoyNX0sezU6WzIsOF0sMTQ6WzIsOF0sMTU6WzIsOF0sMTY6WzIsOF0sMTk6WzIsOF0sMjA6WzIsOF0sMjI6WzIsOF0sMjM6WzIsOF0sMjQ6WzIsOF19LHsxNDpbMiwxNF0sMTU6WzIsMTRdLDE2OlsyLDE0XSwxOTpbMiwxNF0sMjA6WzIsMTRdLDIyOlsyLDE0XSwyMzpbMiwxNF0sMjQ6WzIsMTRdfSx7MTg6WzIsMjJdLDIxOjQxLDI2OjU1LDI3OlsxLDQ1XSwyODo1NiwyOTpbMSw0Ml0sMzA6WzEsNDNdLDMxOlsxLDQ0XSwzMjo0MCwzMzo0NiwzNDpbMSw0N10sMzY6MjV9LHsxODpbMiwyM119LHsxODpbMiwyN10sMjc6WzIsMjddLDI5OlsyLDI3XSwzMDpbMiwyN10sMzE6WzIsMjddLDM0OlsyLDI3XX0sezE4OlsyLDMzXSwzMzo1NywzNDpbMSw1OF19LHsxODpbMiwyOF0sMjc6WzIsMjhdLDI5OlsyLDI4XSwzMDpbMiwyOF0sMzE6WzIsMjhdLDM0OlsyLDI4XX0sezE4OlsyLDI5XSwyNzpbMiwyOV0sMjk6WzIsMjldLDMwOlsyLDI5XSwzMTpbMiwyOV0sMzQ6WzIsMjldfSx7MTg6WzIsMzBdLDI3OlsyLDMwXSwyOTpbMiwzMF0sMzA6WzIsMzBdLDMxOlsyLDMwXSwzNDpbMiwzMF19LHsxODpbMiwzMV0sMjc6WzIsMzFdLDI5OlsyLDMxXSwzMDpbMiwzMV0sMzE6WzIsMzFdLDM0OlsyLDMxXX0sezE4OlsyLDMyXSwyNzpbMiwzMl0sMjk6WzIsMzJdLDMwOlsyLDMyXSwzMTpbMiwzMl0sMzQ6WzIsMzJdfSx7MTg6WzIsMzVdLDM0OlsyLDM1XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM1OlsxLDU5XSwzNzpbMiw0M119LHszNDpbMSw2MF19LHsxNDpbMiwxM10sMTU6WzIsMTNdLDE2OlsyLDEzXSwxOTpbMiwxM10sMjA6WzIsMTNdLDIyOlsyLDEzXSwyMzpbMiwxM10sMjQ6WzIsMTNdfSx7NTpbMiwxNl0sMTQ6WzIsMTZdLDE1OlsyLDE2XSwxNjpbMiwxNl0sMTk6WzIsMTZdLDIwOlsyLDE2XSwyMjpbMiwxNl0sMjM6WzIsMTZdLDI0OlsyLDE2XX0sezU6WzIsMTddLDE0OlsyLDE3XSwxNTpbMiwxN10sMTY6WzIsMTddLDE5OlsyLDE3XSwyMDpbMiwxN10sMjI6WzIsMTddLDIzOlsyLDE3XSwyNDpbMiwxN119LHs1OlsyLDE4XSwxNDpbMiwxOF0sMTU6WzIsMThdLDE2OlsyLDE4XSwxOTpbMiwxOF0sMjA6WzIsMThdLDIyOlsyLDE4XSwyMzpbMiwxOF0sMjQ6WzIsMThdfSx7MTg6WzEsNjFdfSx7MTg6WzEsNjJdfSx7MTg6WzIsMjFdfSx7MTg6WzIsMjZdLDI3OlsyLDI2XSwyOTpbMiwyNl0sMzA6WzIsMjZdLDMxOlsyLDI2XSwzNDpbMiwyNl19LHsxODpbMiwzNF0sMzQ6WzIsMzRdfSx7MzU6WzEsNTldfSx7MjE6NjMsMjc6WzEsNjddLDI5OlsxLDY0XSwzMDpbMSw2NV0sMzE6WzEsNjZdLDM0OlsxLDI2XSwzNjoyNX0sezE4OlsyLDQyXSwyNzpbMiw0Ml0sMjk6WzIsNDJdLDMwOlsyLDQyXSwzMTpbMiw0Ml0sMzQ6WzIsNDJdLDM3OlsyLDQyXX0sezU6WzIsMTldLDE0OlsyLDE5XSwxNTpbMiwxOV0sMTY6WzIsMTldLDE5OlsyLDE5XSwyMDpbMiwxOV0sMjI6WzIsMTldLDIzOlsyLDE5XSwyNDpbMiwxOV19LHs1OlsyLDE1XSwxNDpbMiwxNV0sMTU6WzIsMTVdLDE2OlsyLDE1XSwxOTpbMiwxNV0sMjA6WzIsMTVdLDIyOlsyLDE1XSwyMzpbMiwxNV0sMjQ6WzIsMTVdfSx7MTg6WzIsMzZdLDM0OlsyLDM2XX0sezE4OlsyLDM3XSwzNDpbMiwzN119LHsxODpbMiwzOF0sMzQ6WzIsMzhdfSx7MTg6WzIsMzldLDM0OlsyLDM5XX0sezE4OlsyLDQwXSwzNDpbMiw0MF19XSwKZGVmYXVsdEFjdGlvbnM6IHsxNjpbMiwxXSwyNDpbMiwyNV0sMzg6WzIsMjNdLDU1OlsyLDIxXX0sCnBhcnNlRXJyb3I6IGZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKfSwKcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKGlucHV0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIHN0YWNrID0gWzBdLCB2c3RhY2sgPSBbbnVsbF0sIGxzdGFjayA9IFtdLCB0YWJsZSA9IHRoaXMudGFibGUsIHl5dGV4dCA9ICIiLCB5eWxpbmVubyA9IDAsIHl5bGVuZyA9IDAsIHJlY292ZXJpbmcgPSAwLCBURVJST1IgPSAyLCBFT0YgPSAxOwogICAgdGhpcy5sZXhlci5zZXRJbnB1dChpbnB1dCk7CiAgICB0aGlzLmxleGVyLnl5ID0gdGhpcy55eTsKICAgIHRoaXMueXkubGV4ZXIgPSB0aGlzLmxleGVyOwogICAgdGhpcy55eS5wYXJzZXIgPSB0aGlzOwogICAgaWYgKHR5cGVvZiB0aGlzLmxleGVyLnl5bGxvYyA9PSAidW5kZWZpbmVkIikKICAgICAgICB0aGlzLmxleGVyLnl5bGxvYyA9IHt9OwogICAgdmFyIHl5bG9jID0gdGhpcy5sZXhlci55eWxsb2M7CiAgICBsc3RhY2sucHVzaCh5eWxvYyk7CiAgICB2YXIgcmFuZ2VzID0gdGhpcy5sZXhlci5vcHRpb25zICYmIHRoaXMubGV4ZXIub3B0aW9ucy5yYW5nZXM7CiAgICBpZiAodHlwZW9mIHRoaXMueXkucGFyc2VFcnJvciA9PT0gImZ1bmN0aW9uIikKICAgICAgICB0aGlzLnBhcnNlRXJyb3IgPSB0aGlzLnl5LnBhcnNlRXJyb3I7CiAgICBmdW5jdGlvbiBwb3BTdGFjayhuKSB7CiAgICAgICAgc3RhY2subGVuZ3RoID0gc3RhY2subGVuZ3RoIC0gMiAqIG47CiAgICAgICAgdnN0YWNrLmxlbmd0aCA9IHZzdGFjay5sZW5ndGggLSBuOwogICAgICAgIGxzdGFjay5sZW5ndGggPSBsc3RhY2subGVuZ3RoIC0gbjsKICAgIH0KICAgIGZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgdG9rZW4gPSBzZWxmLmxleGVyLmxleCgpIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdG9rZW4gPSBzZWxmLnN5bWJvbHNfW3Rva2VuXSB8fCB0b2tlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQogICAgdmFyIHN5bWJvbCwgcHJlRXJyb3JTeW1ib2wsIHN0YXRlLCBhY3Rpb24sIGEsIHIsIHl5dmFsID0ge30sIHAsIGxlbiwgbmV3U3RhdGUsIGV4cGVjdGVkOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmICh0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXSkgewogICAgICAgICAgICBhY3Rpb24gPSB0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc3ltYm9sID09PSBudWxsIHx8IHR5cGVvZiBzeW1ib2wgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IGxleCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdGlvbiA9IHRhYmxlW3N0YXRlXSAmJiB0YWJsZVtzdGF0ZV1bc3ltYm9sXTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJ1bmRlZmluZWQiIHx8ICFhY3Rpb24ubGVuZ3RoIHx8ICFhY3Rpb25bMF0pIHsKICAgICAgICAgICAgdmFyIGVyclN0ciA9ICIiOwogICAgICAgICAgICBpZiAoIXJlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gdGFibGVbc3RhdGVdKQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlcm1pbmFsc19bcF0gJiYgcCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQucHVzaCgiJyIgKyB0aGlzLnRlcm1pbmFsc19bcF0gKyAiJyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmxleGVyLnNob3dQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICJQYXJzZSBlcnJvciBvbiBsaW5lICIgKyAoeXlsaW5lbm8gKyAxKSArICI6XG4iICsgdGhpcy5sZXhlci5zaG93UG9zaXRpb24oKSArICJcbkV4cGVjdGluZyAiICsgZXhwZWN0ZWQuam9pbigiLCAiKSArICIsIGdvdCAnIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJTdHIgPSAiUGFyc2UgZXJyb3Igb24gbGluZSAiICsgKHl5bGluZW5vICsgMSkgKyAiOiBVbmV4cGVjdGVkICIgKyAoc3ltYm9sID09IDE/ImVuZCBvZiBpbnB1dCI6IiciICsgKHRoaXMudGVybWluYWxzX1tzeW1ib2xdIHx8IHN5bWJvbCkgKyAiJyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wYXJzZUVycm9yKGVyclN0ciwge3RleHQ6IHRoaXMubGV4ZXIubWF0Y2gsIHRva2VuOiB0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wsIGxpbmU6IHRoaXMubGV4ZXIueXlsaW5lbm8sIGxvYzogeXlsb2MsIGV4cGVjdGVkOiBleHBlY3RlZH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhY3Rpb25bMF0gaW5zdGFuY2VvZiBBcnJheSAmJiBhY3Rpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhcnNlIEVycm9yOiBtdWx0aXBsZSBhY3Rpb25zIHBvc3NpYmxlIGF0IHN0YXRlOiAiICsgc3RhdGUgKyAiLCB0b2tlbjogIiArIHN5bWJvbCk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoYWN0aW9uWzBdKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBzdGFjay5wdXNoKHN5bWJvbCk7CiAgICAgICAgICAgIHZzdGFjay5wdXNoKHRoaXMubGV4ZXIueXl0ZXh0KTsKICAgICAgICAgICAgbHN0YWNrLnB1c2godGhpcy5sZXhlci55eWxsb2MpOwogICAgICAgICAgICBzdGFjay5wdXNoKGFjdGlvblsxXSk7CiAgICAgICAgICAgIHN5bWJvbCA9IG51bGw7CiAgICAgICAgICAgIGlmICghcHJlRXJyb3JTeW1ib2wpIHsKICAgICAgICAgICAgICAgIHl5bGVuZyA9IHRoaXMubGV4ZXIueXlsZW5nOwogICAgICAgICAgICAgICAgeXl0ZXh0ID0gdGhpcy5sZXhlci55eXRleHQ7CiAgICAgICAgICAgICAgICB5eWxpbmVubyA9IHRoaXMubGV4ZXIueXlsaW5lbm87CiAgICAgICAgICAgICAgICB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgICAgICAgICAgICAgaWYgKHJlY292ZXJpbmcgPiAwKQogICAgICAgICAgICAgICAgICAgIHJlY292ZXJpbmctLTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IHByZUVycm9yU3ltYm9sOwogICAgICAgICAgICAgICAgcHJlRXJyb3JTeW1ib2wgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVsxXTsKICAgICAgICAgICAgeXl2YWwuJCA9IHZzdGFja1t2c3RhY2subGVuZ3RoIC0gbGVuXTsKICAgICAgICAgICAgeXl2YWwuXyQgPSB7Zmlyc3RfbGluZTogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAobGVuIHx8IDEpXS5maXJzdF9saW5lLCBsYXN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9saW5lLCBmaXJzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfY29sdW1uLCBsYXN0X2NvbHVtbjogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAxXS5sYXN0X2NvbHVtbn07CiAgICAgICAgICAgIGlmIChyYW5nZXMpIHsKICAgICAgICAgICAgICAgIHl5dmFsLl8kLnJhbmdlID0gW2xzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0ucmFuZ2VbMF0sIGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ucmFuZ2VbMV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIgPSB0aGlzLnBlcmZvcm1BY3Rpb24uY2FsbCh5eXZhbCwgeXl0ZXh0LCB5eWxlbmcsIHl5bGluZW5vLCB0aGlzLnl5LCBhY3Rpb25bMV0sIHZzdGFjaywgbHN0YWNrKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZSgwLCAtMSAqIGxlbiAqIDIpOwogICAgICAgICAgICAgICAgdnN0YWNrID0gdnN0YWNrLnNsaWNlKDAsIC0xICogbGVuKTsKICAgICAgICAgICAgICAgIGxzdGFjayA9IGxzdGFjay5zbGljZSgwLCAtMSAqIGxlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnByb2R1Y3Rpb25zX1thY3Rpb25bMV1dWzBdKTsKICAgICAgICAgICAgdnN0YWNrLnB1c2goeXl2YWwuJCk7CiAgICAgICAgICAgIGxzdGFjay5wdXNoKHl5dmFsLl8kKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB0YWJsZVtzdGFja1tzdGFjay5sZW5ndGggLSAyXV1bc3RhY2tbc3RhY2subGVuZ3RoIC0gMV1dOwogICAgICAgICAgICBzdGFjay5wdXNoKG5ld1N0YXRlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQp9OwovKiBKaXNvbiBnZW5lcmF0ZWQgbGV4ZXIgKi8KdmFyIGxleGVyID0gKGZ1bmN0aW9uKCl7CnZhciBsZXhlciA9ICh7RU9GOjEsCnBhcnNlRXJyb3I6ZnVuY3Rpb24gcGFyc2VFcnJvcihzdHIsIGhhc2gpIHsKICAgICAgICBpZiAodGhpcy55eS5wYXJzZXIpIHsKICAgICAgICAgICAgdGhpcy55eS5wYXJzZXIucGFyc2VFcnJvcihzdHIsIGhhc2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdHIpOwogICAgICAgIH0KICAgIH0sCnNldElucHV0OmZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHRoaXMuX2lucHV0ID0gaW5wdXQ7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRoaXMuX2xlc3MgPSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnl5bGluZW5vID0gdGhpcy55eWxlbmcgPSAwOwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaCA9ICcnOwogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sgPSBbJ0lOSVRJQUwnXTsKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOjEsZmlyc3RfY29sdW1uOjAsbGFzdF9saW5lOjEsbGFzdF9jb2x1bW46MH07CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlID0gWzAsMF07CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKaW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaCA9IHRoaXMuX2lucHV0WzBdOwogICAgICAgIHRoaXMueXl0ZXh0ICs9IGNoOwogICAgICAgIHRoaXMueXlsZW5nKys7CiAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICB0aGlzLm1hdGNoICs9IGNoOwogICAgICAgIHRoaXMubWF0Y2hlZCArPSBjaDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgaWYgKGxpbmVzKSB7CiAgICAgICAgICAgIHRoaXMueXlsaW5lbm8rKzsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9saW5lKys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9jb2x1bW4rKzsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlWzFdKys7CgogICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UoMSk7CiAgICAgICAgcmV0dXJuIGNoOwogICAgfSwKdW5wdXQ6ZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdmFyIGxlbiA9IGNoLmxlbmd0aDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwoKICAgICAgICB0aGlzLl9pbnB1dCA9IGNoICsgdGhpcy5faW5wdXQ7CiAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLnl5dGV4dC5zdWJzdHIoMCwgdGhpcy55eXRleHQubGVuZ3RoLWxlbi0xKTsKICAgICAgICAvL3RoaXMueXlsZW5nIC09IGxlbjsKICAgICAgICB0aGlzLm9mZnNldCAtPSBsZW47CiAgICAgICAgdmFyIG9sZExpbmVzID0gdGhpcy5tYXRjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwogICAgICAgIHRoaXMubWF0Y2ggPSB0aGlzLm1hdGNoLnN1YnN0cigwLCB0aGlzLm1hdGNoLmxlbmd0aC0xKTsKICAgICAgICB0aGlzLm1hdGNoZWQgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGgtMSk7CgogICAgICAgIGlmIChsaW5lcy5sZW5ndGgtMSkgdGhpcy55eWxpbmVubyAtPSBsaW5lcy5sZW5ndGgtMTsKICAgICAgICB2YXIgciA9IHRoaXMueXlsbG9jLnJhbmdlOwoKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5maXJzdF9saW5lLAogICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiwKICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/CiAgICAgICAgICAgICAgKGxpbmVzLmxlbmd0aCA9PT0gb2xkTGluZXMubGVuZ3RoID8gdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIDogMCkgKyBvbGRMaW5lc1tvbGRMaW5lcy5sZW5ndGggLSBsaW5lcy5sZW5ndGhdLmxlbmd0aCAtIGxpbmVzWzBdLmxlbmd0aDoKICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5maXJzdF9jb2x1bW4gLSBsZW4KICAgICAgICAgIH07CgogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLnJhbmdlID0gW3JbMF0sIHJbMF0gKyB0aGlzLnl5bGVuZyAtIGxlbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbW9yZTpmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LApsZXNzOmZ1bmN0aW9uIChuKSB7CiAgICAgICAgdGhpcy51bnB1dCh0aGlzLm1hdGNoLnNsaWNlKG4pKTsKICAgIH0sCnBhc3RJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBhc3QgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGggLSB0aGlzLm1hdGNoLmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIChwYXN0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpICsgcGFzdC5zdWJzdHIoLTIwKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LAp1cGNvbWluZ0lucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmV4dCA9IHRoaXMubWF0Y2g7CiAgICAgICAgaWYgKG5leHQubGVuZ3RoIDwgMjApIHsKICAgICAgICAgICAgbmV4dCArPSB0aGlzLl9pbnB1dC5zdWJzdHIoMCwgMjAtbmV4dC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKG5leHQuc3Vic3RyKDAsMjApKyhuZXh0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LApzaG93UG9zaXRpb246ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcmUgPSB0aGlzLnBhc3RJbnB1dCgpOwogICAgICAgIHZhciBjID0gbmV3IEFycmF5KHByZS5sZW5ndGggKyAxKS5qb2luKCItIik7CiAgICAgICAgcmV0dXJuIHByZSArIHRoaXMudXBjb21pbmdJbnB1dCgpICsgIlxuIiArIGMrIl4iOwogICAgfSwKbmV4dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMuZG9uZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faW5wdXQpIHRoaXMuZG9uZSA9IHRydWU7CgogICAgICAgIHZhciB0b2tlbiwKICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgIHRlbXBNYXRjaCwKICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgIGNvbCwKICAgICAgICAgICAgbGluZXM7CiAgICAgICAgaWYgKCF0aGlzLl9tb3JlKSB7CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ID0gJyc7CiAgICAgICAgICAgIHRoaXMubWF0Y2ggPSAnJzsKICAgICAgICB9CiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5fY3VycmVudFJ1bGVzKCk7CiAgICAgICAgZm9yICh2YXIgaT0wO2kgPCBydWxlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0ZW1wTWF0Y2ggPSB0aGlzLl9pbnB1dC5tYXRjaCh0aGlzLnJ1bGVzW3J1bGVzW2ldXSk7CiAgICAgICAgICAgIGlmICh0ZW1wTWF0Y2ggJiYgKCFtYXRjaCB8fCB0ZW1wTWF0Y2hbMF0ubGVuZ3RoID4gbWF0Y2hbMF0ubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgbWF0Y2ggPSB0ZW1wTWF0Y2g7CiAgICAgICAgICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5mbGV4KSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgbGluZXMgPSBtYXRjaFswXS5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMueXlsbG9jID0ge2ZpcnN0X2xpbmU6IHRoaXMueXlsbG9jLmxhc3RfbGluZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/IGxpbmVzW2xpbmVzLmxlbmd0aC0xXS5sZW5ndGgtbGluZXNbbGluZXMubGVuZ3RoLTFdLm1hdGNoKC9ccj9cbj8vKVswXS5sZW5ndGggOiB0aGlzLnl5bGxvYy5sYXN0X2NvbHVtbiArIG1hdGNoWzBdLmxlbmd0aH07CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaDsKICAgICAgICAgICAgdGhpcy55eWxlbmcgPSB0aGlzLnl5dGV4dC5sZW5ndGg7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5yYW5nZSA9IFt0aGlzLm9mZnNldCwgdGhpcy5vZmZzZXQgKz0gdGhpcy55eWxlbmddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21vcmUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faW5wdXQgPSB0aGlzLl9pbnB1dC5zbGljZShtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICB0aGlzLm1hdGNoZWQgKz0gbWF0Y2hbMF07CiAgICAgICAgICAgIHRva2VuID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwodGhpcywgdGhpcy55eSwgdGhpcywgcnVsZXNbaW5kZXhdLHRoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV0pOwogICAgICAgICAgICBpZiAodGhpcy5kb25lICYmIHRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRva2VuKSByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIGVsc2UgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5wdXQgPT09ICIiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUVycm9yKCdMZXhpY2FsIGVycm9yIG9uIGxpbmUgJysodGhpcy55eWxpbmVubysxKSsnLiBVbnJlY29nbml6ZWQgdGV4dC5cbicrdGhpcy5zaG93UG9zaXRpb24oKSwKICAgICAgICAgICAgICAgICAgICB7dGV4dDogIiIsIHRva2VuOiBudWxsLCBsaW5lOiB0aGlzLnl5bGluZW5vfSk7CiAgICAgICAgfQogICAgfSwKbGV4OmZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgciA9IHRoaXMubmV4dCgpOwogICAgICAgIGlmICh0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGV4KCk7CiAgICAgICAgfQogICAgfSwKYmVnaW46ZnVuY3Rpb24gYmVnaW4oY29uZGl0aW9uKSB7CiAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjay5wdXNoKGNvbmRpdGlvbik7CiAgICB9LApwb3BTdGF0ZTpmdW5jdGlvbiBwb3BTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFjay5wb3AoKTsKICAgIH0sCl9jdXJyZW50UnVsZXM6ZnVuY3Rpb24gX2N1cnJlbnRSdWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25zW3RoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV1dLnJ1bGVzOwogICAgfSwKdG9wU3RhdGU6ZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTJdOwogICAgfSwKcHVzaFN0YXRlOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuYmVnaW4oY29uZGl0aW9uKTsKICAgIH19KTsKbGV4ZXIub3B0aW9ucyA9IHt9OwpsZXhlci5wZXJmb3JtQWN0aW9uID0gZnVuY3Rpb24gYW5vbnltb3VzKHl5LHl5XywkYXZvaWRpbmdfbmFtZV9jb2xsaXNpb25zLFlZX1NUQVJUKSB7Cgp2YXIgWVlTVEFURT1ZWV9TVEFSVApzd2l0Y2goJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucykgewpjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMuYmVnaW4oIm11Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgPT09ICJcXCIpIHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigwLHl5Xy55eWxlbmctMSksIHRoaXMuYmVnaW4oImVtdSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQpIHJldHVybiAxNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCmJyZWFrOwpjYXNlIDE6IHJldHVybiAxNDsgCmJyZWFrOwpjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMucG9wU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0LnNsaWNlKC0xKSA9PT0gIlxcIikgeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDAseXlfLnl5bGVuZy0xKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIApicmVhazsKY2FzZSAzOiByZXR1cm4gMjQ7IApicmVhazsKY2FzZSA0OiByZXR1cm4gMTY7IApicmVhazsKY2FzZSA1OiByZXR1cm4gMjA7IApicmVhazsKY2FzZSA2OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA3OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA4OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSA5OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSAxMDogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDMseXlfLnl5bGVuZy01KTsgdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTU7IApicmVhazsKY2FzZSAxMTogcmV0dXJuIDIyOyAKYnJlYWs7CmNhc2UgMTI6IHJldHVybiAzNTsgCmJyZWFrOwpjYXNlIDEzOiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAxNDogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMTU6IHJldHVybiAzNzsgCmJyZWFrOwpjYXNlIDE2OiAvKmlnbm9yZSB3aGl0ZXNwYWNlKi8gCmJyZWFrOwpjYXNlIDE3OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE4OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE5OiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIwOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIxOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSk7IHJldHVybiAyNzsgCmJyZWFrOwpjYXNlIDIyOiByZXR1cm4gMzE7IApicmVhazsKY2FzZSAyMzogcmV0dXJuIDMxOyAKYnJlYWs7CmNhc2UgMjQ6IHJldHVybiAzMDsgCmJyZWFrOwpjYXNlIDI1OiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAyNjogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEsIHl5Xy55eWxlbmctMik7IHJldHVybiAzNDsgCmJyZWFrOwpjYXNlIDI3OiByZXR1cm4gJ0lOVkFMSUQnOyAKYnJlYWs7CmNhc2UgMjg6IHJldHVybiA1OyAKYnJlYWs7Cn0KfTsKbGV4ZXIucnVsZXMgPSBbL14oPzpbXlx4MDBdKj8oPz0oXHtceykpKS8sL14oPzpbXlx4MDBdKykvLC9eKD86W15ceDAwXXsyLH0/KD89KFx7XHt8JCkpKS8sL14oPzpce1x7PikvLC9eKD86XHtceyMpLywvXig/Olx7XHtcLykvLC9eKD86XHtce1xeKS8sL14oPzpce1x7XHMqZWxzZVxiKS8sL14oPzpce1x7XHspLywvXig/Olx7XHsmKS8sL14oPzpce1x7IVtcc1xTXSo/XH1cfSkvLC9eKD86XHtceykvLC9eKD86PSkvLC9eKD86XC4oPz1bfSBdKSkvLC9eKD86XC5cLikvLC9eKD86W1wvLl0pLywvXig/OlxzKykvLC9eKD86XH1cfVx9KS8sL14oPzpcfVx9KS8sL14oPzoiKFxcWyJdfFteIl0pKiIpLywvXig/OicoXFxbJ118W14nXSkqJykvLC9eKD86QFthLXpBLVpdKykvLC9eKD86dHJ1ZSg/PVt9XHNdKSkvLC9eKD86ZmFsc2UoPz1bfVxzXSkpLywvXig/OlswLTldKyg/PVt9XHNdKSkvLC9eKD86W2EtekEtWjAtOV8kLV0rKD89Wz19XHNcLy5dKSkvLC9eKD86XFtbXlxdXSpcXSkvLC9eKD86LikvLC9eKD86JCkvXTsKbGV4ZXIuY29uZGl0aW9ucyA9IHsibXUiOnsicnVsZXMiOlszLDQsNSw2LDcsOCw5LDEwLDExLDEyLDEzLDE0LDE1LDE2LDE3LDE4LDE5LDIwLDIxLDIyLDIzLDI0LDI1LDI2LDI3LDI4XSwiaW5jbHVzaXZlIjpmYWxzZX0sImVtdSI6eyJydWxlcyI6WzJdLCJpbmNsdXNpdmUiOmZhbHNlfSwiSU5JVElBTCI6eyJydWxlcyI6WzAsMSwyOF0sImluY2x1c2l2ZSI6dHJ1ZX19OwpyZXR1cm4gbGV4ZXI7fSkoKQpwYXJzZXIubGV4ZXIgPSBsZXhlcjsKZnVuY3Rpb24gUGFyc2VyICgpIHsgdGhpcy55eSA9IHt9OyB9UGFyc2VyLnByb3RvdHlwZSA9IHBhcnNlcjtwYXJzZXIuUGFyc2VyID0gUGFyc2VyOwpyZXR1cm4gbmV3IFBhcnNlcjsKfSkoKTsKaWYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKZXhwb3J0cy5wYXJzZXIgPSBoYW5kbGViYXJzOwpleHBvcnRzLlBhcnNlciA9IGhhbmRsZWJhcnMuUGFyc2VyOwpleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gaGFuZGxlYmFycy5wYXJzZS5hcHBseShoYW5kbGViYXJzLCBhcmd1bWVudHMpOyB9CmV4cG9ydHMubWFpbiA9IGZ1bmN0aW9uIGNvbW1vbmpzTWFpbihhcmdzKSB7CiAgICBpZiAoIWFyZ3NbMV0pCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2FnZTogJythcmdzWzBdKycgRklMRScpOwogICAgdmFyIHNvdXJjZSwgY3dkOwogICAgaWYgKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHNvdXJjZSA9IHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHJlcXVpcmUoJ3BhdGgnKS5yZXNvbHZlKGFyZ3NbMV0pLCAidXRmOCIpOwogICAgfSBlbHNlIHsKICAgICAgICBzb3VyY2UgPSByZXF1aXJlKCJmaWxlIikucGF0aChyZXF1aXJlKCJmaWxlIikuY3dkKCkpLmpvaW4oYXJnc1sxXSkucmVhZCh7Y2hhcnNldDogInV0Zi04In0pOwogICAgfQogICAgcmV0dXJuIGV4cG9ydHMucGFyc2VyLnBhcnNlKHNvdXJjZSk7Cn0KaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7CiAgZXhwb3J0cy5tYWluKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyA/IHByb2Nlc3MuYXJndi5zbGljZSgxKSA6IHJlcXVpcmUoInN5c3RlbSIpLmFyZ3MpOwp9Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYmFzZS5qcwpIYW5kbGViYXJzLlBhcnNlciA9IGhhbmRsZWJhcnM7CgpIYW5kbGViYXJzLnBhcnNlID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgSGFuZGxlYmFycy5QYXJzZXIueXkgPSBIYW5kbGViYXJzLkFTVDsKICByZXR1cm4gSGFuZGxlYmFycy5QYXJzZXIucGFyc2Uoc3RyaW5nKTsKfTsKCkhhbmRsZWJhcnMucHJpbnQgPSBmdW5jdGlvbihhc3QpIHsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuUHJpbnRWaXNpdG9yKCkuYWNjZXB0KGFzdCk7Cn07CgpIYW5kbGViYXJzLmxvZ2dlciA9IHsKICBERUJVRzogMCwgSU5GTzogMSwgV0FSTjogMiwgRVJST1I6IDMsIGxldmVsOiAzLAoKICAvLyBvdmVycmlkZSBpbiB0aGUgaG9zdCBlbnZpcm9ubWVudAogIGxvZzogZnVuY3Rpb24obGV2ZWwsIHN0cikge30KfTsKCkhhbmRsZWJhcnMubG9nID0gZnVuY3Rpb24obGV2ZWwsIHN0cikgeyBIYW5kbGViYXJzLmxvZ2dlci5sb2cobGV2ZWwsIHN0cik7IH07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYXN0LmpzCihmdW5jdGlvbigpIHsKCiAgSGFuZGxlYmFycy5BU1QgPSB7fTsKCiAgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUgPSBmdW5jdGlvbihzdGF0ZW1lbnRzLCBpbnZlcnNlKSB7CiAgICB0aGlzLnR5cGUgPSAicHJvZ3JhbSI7CiAgICB0aGlzLnN0YXRlbWVudHMgPSBzdGF0ZW1lbnRzOwogICAgaWYoaW52ZXJzZSkgeyB0aGlzLmludmVyc2UgPSBuZXcgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUoaW52ZXJzZSk7IH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5NdXN0YWNoZU5vZGUgPSBmdW5jdGlvbihyYXdQYXJhbXMsIGhhc2gsIHVuZXNjYXBlZCkgewogICAgdGhpcy50eXBlID0gIm11c3RhY2hlIjsKICAgIHRoaXMuZXNjYXBlZCA9ICF1bmVzY2FwZWQ7CiAgICB0aGlzLmhhc2ggPSBoYXNoOwoKICAgIHZhciBpZCA9IHRoaXMuaWQgPSByYXdQYXJhbXNbMF07CiAgICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXMgPSByYXdQYXJhbXMuc2xpY2UoMSk7CgogICAgLy8gYSBtdXN0YWNoZSBpcyBhbiBlbGlnaWJsZSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0cyBpZCBpcyBzaW1wbGUgKGEgc2luZ2xlIHBhcnQsIG5vdCBgdGhpc2Agb3IgYC4uYCkKICAgIHZhciBlbGlnaWJsZUhlbHBlciA9IHRoaXMuZWxpZ2libGVIZWxwZXIgPSBpZC5pc1NpbXBsZTsKCiAgICAvLyBhIG11c3RhY2hlIGlzIGRlZmluaXRlbHkgYSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0IGlzIGFuIGVsaWdpYmxlIGhlbHBlciwgYW5kCiAgICAvLyAqIGl0IGhhcyBhdCBsZWFzdCBvbmUgcGFyYW1ldGVyIG9yIGhhc2ggc2VnbWVudAogICAgdGhpcy5pc0hlbHBlciA9IGVsaWdpYmxlSGVscGVyICYmIChwYXJhbXMubGVuZ3RoIHx8IGhhc2gpOwoKICAgIC8vIGlmIGEgbXVzdGFjaGUgaXMgYW4gZWxpZ2libGUgaGVscGVyIGJ1dCBub3QgYSBkZWZpbml0ZQogICAgLy8gaGVscGVyLCBpdCBpcyBhbWJpZ3VvdXMsIGFuZCB3aWxsIGJlIHJlc29sdmVkIGluIGEgbGF0ZXIKICAgIC8vIHBhc3Mgb3IgYXQgcnVudGltZS4KICB9OwoKICBIYW5kbGViYXJzLkFTVC5QYXJ0aWFsTm9kZSA9IGZ1bmN0aW9uKGlkLCBjb250ZXh0KSB7CiAgICB0aGlzLnR5cGUgICAgPSAicGFydGlhbCI7CgogICAgLy8gVE9ETzogZGlzYWxsb3cgY29tcGxleCBJRHMKCiAgICB0aGlzLmlkICAgICAgPSBpZDsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgfTsKCiAgdmFyIHZlcmlmeU1hdGNoID0gZnVuY3Rpb24ob3BlbiwgY2xvc2UpIHsKICAgIGlmKG9wZW4ub3JpZ2luYWwgIT09IGNsb3NlLm9yaWdpbmFsKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbihvcGVuLm9yaWdpbmFsICsgIiBkb2Vzbid0IG1hdGNoICIgKyBjbG9zZS5vcmlnaW5hbCk7CiAgICB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQmxvY2tOb2RlID0gZnVuY3Rpb24obXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UsIGNsb3NlKSB7CiAgICB2ZXJpZnlNYXRjaChtdXN0YWNoZS5pZCwgY2xvc2UpOwogICAgdGhpcy50eXBlID0gImJsb2NrIjsKICAgIHRoaXMubXVzdGFjaGUgPSBtdXN0YWNoZTsKICAgIHRoaXMucHJvZ3JhbSAgPSBwcm9ncmFtOwogICAgdGhpcy5pbnZlcnNlICA9IGludmVyc2U7CgogICAgaWYgKHRoaXMuaW52ZXJzZSAmJiAhdGhpcy5wcm9ncmFtKSB7CiAgICAgIHRoaXMuaXNJbnZlcnNlID0gdHJ1ZTsKICAgIH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5Db250ZW50Tm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gImNvbnRlbnQiOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuSGFzaE5vZGUgPSBmdW5jdGlvbihwYWlycykgewogICAgdGhpcy50eXBlID0gImhhc2giOwogICAgdGhpcy5wYWlycyA9IHBhaXJzOwogIH07CgogIEhhbmRsZWJhcnMuQVNULklkTm9kZSA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICB0aGlzLnR5cGUgPSAiSUQiOwogICAgdGhpcy5vcmlnaW5hbCA9IHBhcnRzLmpvaW4oIi4iKTsKCiAgICB2YXIgZGlnID0gW10sIGRlcHRoID0gMDsKCiAgICBmb3IodmFyIGk9MCxsPXBhcnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKCiAgICAgIGlmKHBhcnQgPT09ICIuLiIpIHsgZGVwdGgrKzsgfQogICAgICBlbHNlIGlmKHBhcnQgPT09ICIuIiB8fCBwYXJ0ID09PSAidGhpcyIpIHsgdGhpcy5pc1Njb3BlZCA9IHRydWU7IH0KICAgICAgZWxzZSB7IGRpZy5wdXNoKHBhcnQpOyB9CiAgICB9CgogICAgdGhpcy5wYXJ0cyAgICA9IGRpZzsKICAgIHRoaXMuc3RyaW5nICAgPSBkaWcuam9pbignLicpOwogICAgdGhpcy5kZXB0aCAgICA9IGRlcHRoOwoKICAgIC8vIGFuIElEIGlzIHNpbXBsZSBpZiBpdCBvbmx5IGhhcyBvbmUgcGFydCwgYW5kIHRoYXQgcGFydCBpcyBub3QKICAgIC8vIGAuLmAgb3IgYHRoaXNgLgogICAgdGhpcy5pc1NpbXBsZSA9IHBhcnRzLmxlbmd0aCA9PT0gMSAmJiAhdGhpcy5pc1Njb3BlZCAmJiBkZXB0aCA9PT0gMDsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5EYXRhTm9kZSA9IGZ1bmN0aW9uKGlkKSB7CiAgICB0aGlzLnR5cGUgPSAiREFUQSI7CiAgICB0aGlzLmlkID0gaWQ7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuU3RyaW5nTm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gIlNUUklORyI7CiAgICB0aGlzLnN0cmluZyA9IHN0cmluZzsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5JbnRlZ2VyTm9kZSA9IGZ1bmN0aW9uKGludGVnZXIpIHsKICAgIHRoaXMudHlwZSA9ICJJTlRFR0VSIjsKICAgIHRoaXMuaW50ZWdlciA9IGludGVnZXI7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQm9vbGVhbk5vZGUgPSBmdW5jdGlvbihib29sKSB7CiAgICB0aGlzLnR5cGUgPSAiQk9PTEVBTiI7CiAgICB0aGlzLmJvb2wgPSBib29sOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkNvbW1lbnROb2RlID0gZnVuY3Rpb24oY29tbWVudCkgewogICAgdGhpcy50eXBlID0gImNvbW1lbnQiOwogICAgdGhpcy5jb21tZW50ID0gY29tbWVudDsKICB9OwoKfSkoKTs7Ci8vIGxpYi9oYW5kbGViYXJzL3V0aWxzLmpzCkhhbmRsZWJhcnMuRXhjZXB0aW9uID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciB0bXAgPSBFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgZm9yICh2YXIgcCBpbiB0bXApIHsKICAgIGlmICh0bXAuaGFzT3duUHJvcGVydHkocCkpIHsgdGhpc1twXSA9IHRtcFtwXTsgfQogIH0KCiAgdGhpcy5tZXNzYWdlID0gdG1wLm1lc3NhZ2U7Cn07CkhhbmRsZWJhcnMuRXhjZXB0aW9uLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwoKLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKSGFuZGxlYmFycy5TYWZlU3RyaW5nID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7Cn07CkhhbmRsZWJhcnMuU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdHJpbmcudG9TdHJpbmcoKTsKfTsKCihmdW5jdGlvbigpIHsKICB2YXIgZXNjYXBlID0gewogICAgIiYiOiAiJmFtcDsiLAogICAgIjwiOiAiJmx0OyIsCiAgICAiPiI6ICImZ3Q7IiwKICAgICciJzogIiZxdW90OyIsCiAgICAiJyI6ICImI3gyNzsiLAogICAgImAiOiAiJiN4NjA7IgogIH07CgogIHZhciBiYWRDaGFycyA9IC9bJjw+IidgXS9nOwogIHZhciBwb3NzaWJsZSA9IC9bJjw+IidgXS87CgogIHZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24oY2hyKSB7CiAgICByZXR1cm4gZXNjYXBlW2Nocl0gfHwgIiZhbXA7IjsKICB9OwoKICBIYW5kbGViYXJzLlV0aWxzID0gewogICAgZXNjYXBlRXhwcmVzc2lvbjogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIC8vIGRvbid0IGVzY2FwZSBTYWZlU3RyaW5ncywgc2luY2UgdGhleSdyZSBhbHJlYWR5IHNhZmUKICAgICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcudG9TdHJpbmcoKTsKICAgICAgfSBlbHNlIGlmIChzdHJpbmcgPT0gbnVsbCB8fCBzdHJpbmcgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CgogICAgICBpZighcG9zc2libGUudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICAgIH0sCgogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9Owp9KSgpOzsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvY29tcGlsZXIuanMKCi8qanNoaW50IGVxbnVsbDp0cnVlKi8KSGFuZGxlYmFycy5Db21waWxlciA9IGZ1bmN0aW9uKCkge307CkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyID0gZnVuY3Rpb24oKSB7fTsKCihmdW5jdGlvbihDb21waWxlciwgSmF2YVNjcmlwdENvbXBpbGVyKSB7CiAgLy8gdGhlIGZvdW5kSGVscGVyIHJlZ2lzdGVyIHdpbGwgZGlzYW1iaWd1YXRlIGhlbHBlciBsb29rdXAgZnJvbSBmaW5kaW5nIGEKICAvLyBmdW5jdGlvbiBpbiBhIGNvbnRleHQuIFRoaXMgaXMgbmVjZXNzYXJ5IGZvciBtdXN0YWNoZSBjb21wYXRpYmlsaXR5LCB3aGljaAogIC8vIHJlcXVpcmVzIHRoYXQgY29udGV4dCBmdW5jdGlvbnMgaW4gYmxvY2tzIGFyZSBldmFsdWF0ZWQgYnkgYmxvY2tIZWxwZXJNaXNzaW5nLAogIC8vIGFuZCB0aGVuIHByb2NlZWQgYXMgaWYgdGhlIHJlc3VsdGluZyB2YWx1ZSB3YXMgcHJvdmlkZWQgdG8gYmxvY2tIZWxwZXJNaXNzaW5nLgoKICBDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICBjb21waWxlcjogQ29tcGlsZXIsCgogICAgZGlzYXNzZW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMub3Bjb2Rlcywgb3Bjb2RlLCBvdXQgPSBbXSwgcGFyYW1zLCBwYXJhbTsKCiAgICAgIGZvciAodmFyIGk9MCwgbD1vcGNvZGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW2ldOwoKICAgICAgICBpZiAob3Bjb2RlLm9wY29kZSA9PT0gJ0RFQ0xBUkUnKSB7CiAgICAgICAgICBvdXQucHVzaCgiREVDTEFSRSAiICsgb3Bjb2RlLm5hbWUgKyAiPSIgKyBvcGNvZGUudmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXJhbXMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGo9MDsgajxvcGNvZGUuYXJncy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBwYXJhbSA9IG9wY29kZS5hcmdzW2pdOwogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHBhcmFtID0gIlwiIiArIHBhcmFtLnJlcGxhY2UoIlxuIiwgIlxcbiIpICsgIlwiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICB9CiAgICAgICAgICBvdXQucHVzaChvcGNvZGUub3Bjb2RlICsgIiAiICsgcGFyYW1zLmpvaW4oIiAiKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gb3V0LmpvaW4oIlxuIik7CiAgICB9LAoKICAgIGd1aWQ6IDAsCgogICAgY29tcGlsZTogZnVuY3Rpb24ocHJvZ3JhbSwgb3B0aW9ucykgewogICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgIHRoaXMuZGVwdGhzID0ge2xpc3Q6IFtdfTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCiAgICAgIC8vIFRoZXNlIGNoYW5nZXMgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIG90aGVyIGNvbXBpbGVyIGNvbXBvbmVudHMKICAgICAgdmFyIGtub3duSGVscGVycyA9IHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnM7CiAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnMgPSB7CiAgICAgICAgJ2hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdibG9ja0hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdlYWNoJzogdHJ1ZSwKICAgICAgICAnaWYnOiB0cnVlLAogICAgICAgICd1bmxlc3MnOiB0cnVlLAogICAgICAgICd3aXRoJzogdHJ1ZSwKICAgICAgICAnbG9nJzogdHJ1ZQogICAgICB9OwogICAgICBpZiAoa25vd25IZWxwZXJzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBrbm93bkhlbHBlcnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0gPSBrbm93bkhlbHBlcnNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5wcm9ncmFtKHByb2dyYW0pOwogICAgfSwKCiAgICBhY2NlcHQ6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgcmV0dXJuIHRoaXNbbm9kZS50eXBlXShub2RlKTsKICAgIH0sCgogICAgcHJvZ3JhbTogZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICB2YXIgc3RhdGVtZW50cyA9IHByb2dyYW0uc3RhdGVtZW50cywgc3RhdGVtZW50OwogICAgICB0aGlzLm9wY29kZXMgPSBbXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXN0YXRlbWVudHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgdGhpc1tzdGF0ZW1lbnQudHlwZV0oc3RhdGVtZW50KTsKICAgICAgfQogICAgICB0aGlzLmlzU2ltcGxlID0gbCA9PT0gMTsKCiAgICAgIHRoaXMuZGVwdGhzLmxpc3QgPSB0aGlzLmRlcHRocy5saXN0LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBhIC0gYjsKICAgICAgfSk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgY29tcGlsZVByb2dyYW06IGZ1bmN0aW9uKHByb2dyYW0pIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyB0aGlzLmNvbXBpbGVyKCkuY29tcGlsZShwcm9ncmFtLCB0aGlzLm9wdGlvbnMpOwogICAgICB2YXIgZ3VpZCA9IHRoaXMuZ3VpZCsrLCBkZXB0aDsKCiAgICAgIHRoaXMudXNlUGFydGlhbCA9IHRoaXMudXNlUGFydGlhbCB8fCByZXN1bHQudXNlUGFydGlhbDsKCiAgICAgIHRoaXMuY2hpbGRyZW5bZ3VpZF0gPSByZXN1bHQ7CgogICAgICBmb3IodmFyIGk9MCwgbD1yZXN1bHQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gcmVzdWx0LmRlcHRocy5saXN0W2ldOwoKICAgICAgICBpZihkZXB0aCA8IDIpIHsgY29udGludWU7IH0KICAgICAgICBlbHNlIHsgdGhpcy5hZGREZXB0aChkZXB0aCAtIDEpOyB9CiAgICAgIH0KCiAgICAgIHJldHVybiBndWlkOwogICAgfSwKCiAgICBibG9jazogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgdmFyIG11c3RhY2hlID0gYmxvY2subXVzdGFjaGUsCiAgICAgICAgICBwcm9ncmFtID0gYmxvY2sucHJvZ3JhbSwKICAgICAgICAgIGludmVyc2UgPSBibG9jay5pbnZlcnNlOwoKICAgICAgaWYgKHByb2dyYW0pIHsKICAgICAgICBwcm9ncmFtID0gdGhpcy5jb21waWxlUHJvZ3JhbShwcm9ncmFtKTsKICAgICAgfQoKICAgICAgaWYgKGludmVyc2UpIHsKICAgICAgICBpbnZlcnNlID0gdGhpcy5jb21waWxlUHJvZ3JhbShpbnZlcnNlKTsKICAgICAgfQoKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJoZWxwZXIiKSB7CiAgICAgICAgdGhpcy5oZWxwZXJNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKCiAgICAgICAgLy8gbm93IHRoYXQgdGhlIHNpbXBsZSBtdXN0YWNoZSBpcyByZXNvbHZlZCwgd2UgbmVlZCB0bwogICAgICAgIC8vIGV2YWx1YXRlIGl0IGJ5IGV4ZWN1dGluZyBgYmxvY2tIZWxwZXJNaXNzaW5nYAogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICAgIHRoaXMub3Bjb2RlKCdibG9ja1ZhbHVlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hbWJpZ3VvdXNNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgICB0aGlzLm9wY29kZSgnYW1iaWd1b3VzQmxvY2tWYWx1ZScpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGhhc2g6IGZ1bmN0aW9uKGhhc2gpIHsKICAgICAgdmFyIHBhaXJzID0gaGFzaC5wYWlycywgcGFpciwgdmFsOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2gnLCAne30nKTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXBhaXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBwYWlyID0gcGFpcnNbaV07CiAgICAgICAgdmFsICA9IHBhaXJbMV07CgogICAgICAgIHRoaXMuYWNjZXB0KHZhbCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2Fzc2lnblRvSGFzaCcsIHBhaXJbMF0pOwogICAgICB9CiAgICB9LAoKICAgIHBhcnRpYWw6IGZ1bmN0aW9uKHBhcnRpYWwpIHsKICAgICAgdmFyIGlkID0gcGFydGlhbC5pZDsKICAgICAgdGhpcy51c2VQYXJ0aWFsID0gdHJ1ZTsKCiAgICAgIGlmKHBhcnRpYWwuY29udGV4dCkgewogICAgICAgIHRoaXMuSUQocGFydGlhbC5jb250ZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaCcsICdkZXB0aDAnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZVBhcnRpYWwnLCBpZC5vcmlnaW5hbCk7CiAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmQnKTsKICAgIH0sCgogICAgY29udGVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kQ29udGVudCcsIGNvbnRlbnQuc3RyaW5nKTsKICAgIH0sCgogICAgbXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICB2YXIgdHlwZSA9IHRoaXMuY2xhc3NpZnlNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiaGVscGVyIikgewogICAgICAgIHRoaXMuaGVscGVyTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYW1iaWd1b3VzTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9CgogICAgICBpZihtdXN0YWNoZS5lc2NhcGVkICYmICFvcHRpb25zLm5vRXNjYXBlKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZEVzY2FwZWQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICAgIH0KICAgIH0sCgogICAgYW1iaWd1b3VzTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkLCBuYW1lID0gaWQucGFydHNbMF07CgogICAgICB0aGlzLm9wY29kZSgnZ2V0Q29udGV4dCcsIGlkLmRlcHRoKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VBbWJpZ3VvdXMnLCBuYW1lKTsKICAgIH0sCgogICAgc2ltcGxlTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkOwoKICAgICAgaWYgKGlkLnR5cGUgPT09ICdEQVRBJykgewogICAgICAgIHRoaXMuREFUQShpZCk7CiAgICAgIH0gZWxzZSBpZiAoaWQucGFydHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5JRChpZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2ltcGxpZmllZCBJRCBmb3IgYHRoaXNgCiAgICAgICAgdGhpcy5hZGREZXB0aChpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hDb250ZXh0Jyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3Bjb2RlKCdyZXNvbHZlUG9zc2libGVMYW1iZGEnKTsKICAgIH0sCgogICAgaGVscGVyTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLnNldHVwRnVsbE11c3RhY2hlUGFyYW1zKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSwKICAgICAgICAgIG5hbWUgPSBtdXN0YWNoZS5pZC5wYXJ0c1swXTsKCiAgICAgIGlmICh0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzW25hbWVdKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUtub3duSGVscGVyJywgcGFyYW1zLmxlbmd0aCwgbmFtZSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc3BlY2lmaWVkIGtub3duSGVscGVyc09ubHksIGJ1dCB1c2VkIHRoZSB1bmtub3duIGhlbHBlciAiICsgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIElEOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLmFkZERlcHRoKGlkLmRlcHRoKTsKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB2YXIgbmFtZSA9IGlkLnBhcnRzWzBdOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaENvbnRleHQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnbG9va3VwT25Db250ZXh0JywgaWQucGFydHNbMF0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MSwgbD1pZC5wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cCcsIGlkLnBhcnRzW2ldKTsKICAgICAgfQogICAgfSwKCiAgICBEQVRBOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHRoaXMub3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cERhdGEnLCBkYXRhLmlkKTsKICAgIH0sCgogICAgU1RSSU5HOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hTdHJpbmcnLCBzdHJpbmcuc3RyaW5nKTsKICAgIH0sCgogICAgSU5URUdFUjogZnVuY3Rpb24oaW50ZWdlcikgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBpbnRlZ2VyLmludGVnZXIpOwogICAgfSwKCiAgICBCT09MRUFOOiBmdW5jdGlvbihib29sKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsIGJvb2wuYm9vbCk7CiAgICB9LAoKICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKCkge30sCgogICAgLy8gSEVMUEVSUwogICAgb3Bjb2RlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiBuYW1lLCBhcmdzOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkgfSk7CiAgICB9LAoKICAgIGRlY2xhcmU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiAnREVDTEFSRScsIG5hbWU6IG5hbWUsIHZhbHVlOiB2YWx1ZSB9KTsKICAgIH0sCgogICAgYWRkRGVwdGg6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKGlzTmFOKGRlcHRoKSkgeyB0aHJvdyBuZXcgRXJyb3IoIkVXT1QiKTsgfQogICAgICBpZihkZXB0aCA9PT0gMCkgeyByZXR1cm47IH0KCiAgICAgIGlmKCF0aGlzLmRlcHRoc1tkZXB0aF0pIHsKICAgICAgICB0aGlzLmRlcHRoc1tkZXB0aF0gPSB0cnVlOwogICAgICAgIHRoaXMuZGVwdGhzLmxpc3QucHVzaChkZXB0aCk7CiAgICAgIH0KICAgIH0sCgogICAgY2xhc3NpZnlNdXN0YWNoZTogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIGlzSGVscGVyICAgPSBtdXN0YWNoZS5pc0hlbHBlcjsKICAgICAgdmFyIGlzRWxpZ2libGUgPSBtdXN0YWNoZS5lbGlnaWJsZUhlbHBlcjsKICAgICAgdmFyIG9wdGlvbnMgICAgPSB0aGlzLm9wdGlvbnM7CgogICAgICAvLyBpZiBhbWJpZ3VvdXMsIHdlIGNhbiBwb3NzaWJseSByZXNvbHZlIHRoZSBhbWJpZ3VpdHkgbm93CiAgICAgIGlmIChpc0VsaWdpYmxlICYmICFpc0hlbHBlcikgewogICAgICAgIHZhciBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICAgIGlmIChvcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgICAgaXNIZWxwZXIgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgICBpc0VsaWdpYmxlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNIZWxwZXIpIHsgcmV0dXJuICJoZWxwZXIiOyB9CiAgICAgIGVsc2UgaWYgKGlzRWxpZ2libGUpIHsgcmV0dXJuICJhbWJpZ3VvdXMiOyB9CiAgICAgIGVsc2UgeyByZXR1cm4gInNpbXBsZSI7IH0KICAgIH0sCgogICAgcHVzaFBhcmFtczogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgIHZhciBpID0gcGFyYW1zLmxlbmd0aCwgcGFyYW07CgogICAgICB3aGlsZShpLS0pIHsKICAgICAgICBwYXJhbSA9IHBhcmFtc1tpXTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgaWYocGFyYW0uZGVwdGgpIHsKICAgICAgICAgICAgdGhpcy5hZGREZXB0aChwYXJhbS5kZXB0aCk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBwYXJhbS5kZXB0aCB8fCAwKTsKICAgICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nUGFyYW0nLCBwYXJhbS5zdHJpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3BhcmFtLnR5cGVdKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0dXBNdXN0YWNoZVBhcmFtczogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIHBhcmFtcyA9IG11c3RhY2hlLnBhcmFtczsKICAgICAgdGhpcy5wdXNoUGFyYW1zKHBhcmFtcyk7CgogICAgICBpZihtdXN0YWNoZS5oYXNoKSB7CiAgICAgICAgdGhpcy5oYXNoKG11c3RhY2hlLmhhc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICAgfSwKCiAgICAvLyB0aGlzIHdpbGwgcmVwbGFjZSBzZXR1cE11c3RhY2hlUGFyYW1zIHdoZW4gd2UncmUgZG9uZQogICAgc2V0dXBGdWxsTXVzdGFjaGVQYXJhbXM6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSBtdXN0YWNoZS5wYXJhbXM7CiAgICAgIHRoaXMucHVzaFBhcmFtcyhwYXJhbXMpOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwoKICAgICAgaWYobXVzdGFjaGUuaGFzaCkgewogICAgICAgIHRoaXMuaGFzaChtdXN0YWNoZS5oYXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0KICB9OwoKICB2YXIgTGl0ZXJhbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfTsKCiAgSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZSA9IHsKICAgIC8vIFBVQkxJQyBBUEk6IFlvdSBjYW4gb3ZlcnJpZGUgdGhlc2UgbWV0aG9kcyBpbiBhIHN1YmNsYXNzIHRvIHByb3ZpZGUKICAgIC8vIGFsdGVybmF0aXZlIGNvbXBpbGVkIGZvcm1zIGZvciBuYW1lIGxvb2t1cCBhbmQgYnVmZmVyaW5nIHNlbWFudGljcwogICAgbmFtZUxvb2t1cDogZnVuY3Rpb24ocGFyZW50LCBuYW1lLCB0eXBlKSB7CiAgICAgIGlmICgvXlswLTldKyQvLnRlc3QobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsiICsgbmFtZSArICJdIjsKICAgICAgfSBlbHNlIGlmIChKYXZhU2NyaXB0Q29tcGlsZXIuaXNWYWxpZEphdmFTY3JpcHRWYXJpYWJsZU5hbWUobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIi4iICsgbmFtZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsnIiArIG5hbWUgKyAiJ10iOwogICAgICB9CiAgICB9LAoKICAgIGFwcGVuZFRvQnVmZmVyOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICByZXR1cm4gInJldHVybiAiICsgc3RyaW5nICsgIjsiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiYnVmZmVyICs9ICIgKyBzdHJpbmcgKyAiOyI7CiAgICAgIH0KICAgIH0sCgogICAgaW5pdGlhbGl6ZUJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1b3RlZFN0cmluZygiIik7CiAgICB9LAoKICAgIG5hbWVzcGFjZTogIkhhbmRsZWJhcnMiLAogICAgLy8gRU5EIFBVQkxJQyBBUEkKCiAgICBjb21waWxlOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucywgY29udGV4dCwgYXNPYmplY3QpIHsKICAgICAgdGhpcy5lbnZpcm9ubWVudCA9IGVudmlyb25tZW50OwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIHRoaXMuZW52aXJvbm1lbnQuZGlzYXNzZW1ibGUoKSArICJcblxuIik7CgogICAgICB0aGlzLm5hbWUgPSB0aGlzLmVudmlyb25tZW50Lm5hbWU7CiAgICAgIHRoaXMuaXNDaGlsZCA9ICEhY29udGV4dDsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dCB8fCB7CiAgICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICAgIGFsaWFzZXM6IHsgfQogICAgICB9OwoKICAgICAgdGhpcy5wcmVhbWJsZSgpOwoKICAgICAgdGhpcy5zdGFja1Nsb3QgPSAwOwogICAgICB0aGlzLnN0YWNrVmFycyA9IFtdOwogICAgICB0aGlzLnJlZ2lzdGVycyA9IHsgbGlzdDogW10gfTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sgPSBbXTsKCiAgICAgIHRoaXMuY29tcGlsZUNoaWxkcmVuKGVudmlyb25tZW50LCBvcHRpb25zKTsKCiAgICAgIHZhciBvcGNvZGVzID0gZW52aXJvbm1lbnQub3Bjb2Rlcywgb3Bjb2RlOwoKICAgICAgdGhpcy5pID0gMDsKCiAgICAgIGZvcihsPW9wY29kZXMubGVuZ3RoOyB0aGlzLmk8bDsgdGhpcy5pKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaV07CgogICAgICAgIGlmKG9wY29kZS5vcGNvZGUgPT09ICdERUNMQVJFJykgewogICAgICAgICAgdGhpc1tvcGNvZGUubmFtZV0gPSBvcGNvZGUudmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbb3Bjb2RlLm9wY29kZV0uYXBwbHkodGhpcywgb3Bjb2RlLmFyZ3MpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRnVuY3Rpb25Db250ZXh0KGFzT2JqZWN0KTsKICAgIH0sCgogICAgbmV4dE9wY29kZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGVzID0gdGhpcy5lbnZpcm9ubWVudC5vcGNvZGVzLCBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaSArIDFdOwogICAgICByZXR1cm4gb3Bjb2Rlc1t0aGlzLmkgKyAxXTsKICAgIH0sCgogICAgZWF0OiBmdW5jdGlvbihvcGNvZGUpIHsKICAgICAgdGhpcy5pID0gdGhpcy5pICsgMTsKICAgIH0sCgogICAgcHJlYW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0ID0gW107CgogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZTsKICAgICAgICB2YXIgY29waWVzID0gImhlbHBlcnMgPSBoZWxwZXJzIHx8ICIgKyBuYW1lc3BhY2UgKyAiLmhlbHBlcnM7IjsKICAgICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC51c2VQYXJ0aWFsKSB7IGNvcGllcyA9IGNvcGllcyArICIgcGFydGlhbHMgPSBwYXJ0aWFscyB8fCAiICsgbmFtZXNwYWNlICsgIi5wYXJ0aWFsczsiOyB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7IGNvcGllcyA9IGNvcGllcyArICIgZGF0YSA9IGRhdGEgfHwge307IjsgfQogICAgICAgIG91dC5wdXNoKGNvcGllcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0LnB1c2goJycpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICBvdXQucHVzaCgiLCBidWZmZXIgPSAiICsgdGhpcy5pbml0aWFsaXplQnVmZmVyKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCIiKTsKICAgICAgfQoKICAgICAgLy8gdHJhY2sgdGhlIGxhc3QgY29udGV4dCBwdXNoZWQgaW50byBwbGFjZSB0byBhbGxvdyBza2lwcGluZyB0aGUKICAgICAgLy8gZ2V0Q29udGV4dCBvcGNvZGUgd2hlbiBpdCB3b3VsZCBiZSBhIG5vb3AKICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IDA7CiAgICAgIHRoaXMuc291cmNlID0gb3V0OwogICAgfSwKCiAgICBjcmVhdGVGdW5jdGlvbkNvbnRleHQ6IGZ1bmN0aW9uKGFzT2JqZWN0KSB7CiAgICAgIHZhciBsb2NhbHMgPSB0aGlzLnN0YWNrVmFycy5jb25jYXQodGhpcy5yZWdpc3RlcnMubGlzdCk7CgogICAgICBpZihsb2NhbHMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAiLCAiICsgbG9jYWxzLmpvaW4oIiwgIik7CiAgICAgIH0KCiAgICAgIC8vIEdlbmVyYXRlIG1pbmltaXplciBhbGlhcyBtYXBwaW5ncwogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBhbGlhc2VzID0gW107CiAgICAgICAgZm9yICh2YXIgYWxpYXMgaW4gdGhpcy5jb250ZXh0LmFsaWFzZXMpIHsKICAgICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAnLCAnICsgYWxpYXMgKyAnPScgKyB0aGlzLmNvbnRleHQuYWxpYXNlc1thbGlhc107CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5zb3VyY2VbMV0pIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9ICJ2YXIgIiArIHRoaXMuc291cmNlWzFdLnN1YnN0cmluZygyKSArICI7IjsKICAgICAgfQoKICAgICAgLy8gTWVyZ2UgY2hpbGRyZW4KICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSArPSAnXG4nICsgdGhpcy5jb250ZXh0LnByb2dyYW1zLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnNvdXJjZS5wdXNoKCJyZXR1cm4gYnVmZmVyOyIpOwogICAgICB9CgogICAgICB2YXIgcGFyYW1zID0gdGhpcy5pc0NoaWxkID8gWyJkZXB0aDAiLCAiZGF0YSJdIDogWyJIYW5kbGViYXJzIiwgImRlcHRoMCIsICJoZWxwZXJzIiwgInBhcnRpYWxzIiwgImRhdGEiXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXRoaXMuZW52aXJvbm1lbnQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHBhcmFtcy5wdXNoKCJkZXB0aCIgKyB0aGlzLmVudmlyb25tZW50LmRlcHRocy5saXN0W2ldKTsKICAgICAgfQoKICAgICAgaWYgKGFzT2JqZWN0KSB7CiAgICAgICAgcGFyYW1zLnB1c2godGhpcy5zb3VyY2Uuam9pbigiXG4gICIpKTsKCiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uLmFwcGx5KHRoaXMsIHBhcmFtcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uU291cmNlID0gJ2Z1bmN0aW9uICcgKyAodGhpcy5uYW1lIHx8ICcnKSArICcoJyArIHBhcmFtcy5qb2luKCcsJykgKyAnKSB7XG4gICcgKyB0aGlzLnNvdXJjZS5qb2luKCJcbiAgIikgKyAnfSc7CiAgICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIGZ1bmN0aW9uU291cmNlICsgIlxuXG4iKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25Tb3VyY2U7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2Jsb2NrVmFsdWVdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgdmFsdWUKICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmV0dXJuIHZhbHVlIG9mIGJsb2NrSGVscGVyTWlzc2luZwogICAgLy8KICAgIC8vIFRoZSBwdXJwb3NlIG9mIHRoaXMgb3Bjb2RlIGlzIHRvIHRha2UgYSBibG9jayBvZiB0aGUgZm9ybQogICAgLy8gYHt7I2Zvb319Li4ue3svZm9vfX1gLCByZXNvbHZlIHRoZSB2YWx1ZSBvZiBgZm9vYCwgYW5kCiAgICAvLyByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgcHJvcGVybHkKICAgIC8vIGludm9raW5nIGJsb2NrSGVscGVyTWlzc2luZy4KICAgIGJsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9IGJsb2NrSGVscGVyTWlzc2luZy5jYWxsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFthbWJpZ3VvdXNCbG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYmVmb3JlOiBsYXN0SGVscGVyPXZhbHVlIG9mIGxhc3QgZm91bmQgaGVscGVyLCBpZiBhbnkKICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbm8gbGFzdEhlbHBlcjogc2FtZSBhcyBbYmxvY2tWYWx1ZV0KICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbGFzdEhlbHBlcjogdmFsdWUKICAgIGFtYmlndW91c0Jsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy50b3BTdGFjaygpOwogICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYgKCEiICsgdGhpcy5sYXN0SGVscGVyICsgIikgeyAiICsgY3VycmVudCArICIgPSBibG9ja0hlbHBlck1pc3NpbmcuY2FsbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKTsgfSIpOwogICAgfSwKCiAgICAvLyBbYXBwZW5kQ29udGVudF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQXBwZW5kcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGBjb250ZW50YCB0byB0aGUgY3VycmVudCBidWZmZXIKICAgIGFwcGVuZENvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKHRoaXMucXVvdGVkU3RyaW5nKGNvbnRlbnQpKSk7CiAgICB9LAoKICAgIC8vIFthcHBlbmRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBDb2VyY2VzIGB2YWx1ZWAgdG8gYSBTdHJpbmcgYW5kIGFwcGVuZHMgaXQgdG8gdGhlIGN1cnJlbnQgYnVmZmVyLgogICAgLy8KICAgIC8vIElmIGB2YWx1ZWAgaXMgdHJ1dGh5LCBvciAwLCBpdCBpcyBjb2VyY2VkIGludG8gYSBzdHJpbmcgYW5kIGFwcGVuZGVkCiAgICAvLyBPdGhlcndpc2UsIHRoZSBlbXB0eSBzdHJpbmcgaXMgYXBwZW5kZWQKICAgIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsb2NhbCA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYoIiArIGxvY2FsICsgIiB8fCAiICsgbG9jYWwgKyAiID09PSAwKSB7ICIgKyB0aGlzLmFwcGVuZFRvQnVmZmVyKGxvY2FsKSArICIgfSIpOwogICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC5pc1NpbXBsZSkgewogICAgICAgIHRoaXMuc291cmNlLnB1c2goImVsc2UgeyAiICsgdGhpcy5hcHBlbmRUb0J1ZmZlcigiJyciKSArICIgfSIpOwogICAgICB9CiAgICB9LAoKICAgIC8vIFthcHBlbmRFc2NhcGVkXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gRXNjYXBlIGB2YWx1ZWAgYW5kIGFwcGVuZCBpdCB0byB0aGUgYnVmZmVyCiAgICBhcHBlbmRFc2NhcGVkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9wY29kZSA9IHRoaXMubmV4dE9wY29kZSgpLCBleHRyYSA9ICIiOwogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5lc2NhcGVFeHByZXNzaW9uID0gJ3RoaXMuZXNjYXBlRXhwcmVzc2lvbic7CgogICAgICBpZihvcGNvZGUgJiYgb3Bjb2RlLm9wY29kZSA9PT0gJ2FwcGVuZENvbnRlbnQnKSB7CiAgICAgICAgZXh0cmEgPSAiICsgIiArIHRoaXMucXVvdGVkU3RyaW5nKG9wY29kZS5hcmdzWzBdKTsKICAgICAgICB0aGlzLmVhdChvcGNvZGUpOwogICAgICB9CgogICAgICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuYXBwZW5kVG9CdWZmZXIoImVzY2FwZUV4cHJlc3Npb24oIiArIHRoaXMucG9wU3RhY2soKSArICIpIiArIGV4dHJhKSk7CiAgICB9LAoKICAgIC8vIFtnZXRDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vIENvbXBpbGVyIHZhbHVlLCBhZnRlcjogbGFzdENvbnRleHQ9ZGVwdGgKICAgIC8vCiAgICAvLyBTZXQgdGhlIHZhbHVlIG9mIHRoZSBgbGFzdENvbnRleHRgIGNvbXBpbGVyIHZhbHVlIHRvIHRoZSBkZXB0aAogICAgZ2V0Q29udGV4dDogZnVuY3Rpb24oZGVwdGgpIHsKICAgICAgaWYodGhpcy5sYXN0Q29udGV4dCAhPT0gZGVwdGgpIHsKICAgICAgICB0aGlzLmxhc3RDb250ZXh0ID0gZGVwdGg7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2xvb2t1cE9uQ29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogY3VycmVudENvbnRleHRbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIExvb2tzIHVwIHRoZSB2YWx1ZSBvZiBgbmFtZWAgb24gdGhlIGN1cnJlbnQgY29udGV4dCBhbmQgcHVzaGVzCiAgICAvLyBpdCBvbnRvIHRoZSBzdGFjay4KICAgIGxvb2t1cE9uQ29udGV4dDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0JykpOwogICAgfSwKCiAgICAvLyBbcHVzaENvbnRleHRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGN1cnJlbnRDb250ZXh0LCAuLi4KICAgIC8vCiAgICAvLyBQdXNoZXMgdGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGNvbnRleHQgb250byB0aGUgc3RhY2suCiAgICBwdXNoQ29udGV4dDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgnZGVwdGgnICsgdGhpcy5sYXN0Q29udGV4dCk7CiAgICB9LAoKICAgIC8vIFtyZXNvbHZlUG9zc2libGVMYW1iZGFdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXNvbHZlZCB2YWx1ZSwgLi4uCiAgICAvLwogICAgLy8gSWYgdGhlIGB2YWx1ZWAgaXMgYSBsYW1iZGEsIHJlcGxhY2UgaXQgb24gdGhlIHN0YWNrIGJ5CiAgICAvLyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBsYW1iZGEKICAgIHJlc29sdmVQb3NzaWJsZUxhbWJkYTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICByZXR1cm4gInR5cGVvZiAiICsgY3VycmVudCArICIgPT09IGZ1bmN0aW9uVHlwZSA/ICIgKyBjdXJyZW50ICsgIigpIDogIiArIGN1cnJlbnQ7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWVbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIFJlcGxhY2UgdGhlIHZhbHVlIG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgbG9va2luZwogICAgLy8gdXAgYG5hbWVgIG9uIGB2YWx1ZWAKICAgIGxvb2t1cDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnQgKyAiID09IG51bGwgfHwgIiArIGN1cnJlbnQgKyAiID09PSBmYWxzZSA/ICIgKyBjdXJyZW50ICsgIiA6ICIgKyB0aGlzLm5hbWVMb29rdXAoY3VycmVudCwgbmFtZSwgJ2NvbnRleHQnKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFtsb29rdXBEYXRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBkYXRhW2lkXSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcgdXAgYGlkYCBvbiB0aGUgY3VycmVudCBkYXRhCiAgICBsb29rdXBEYXRhOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RhdGEnLCBpZCwgJ2RhdGEnKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoU3RyaW5nUGFyYW1dCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHN0cmluZywgY3VycmVudENvbnRleHQsIC4uLgogICAgLy8KICAgIC8vIFRoaXMgb3Bjb2RlIGlzIGRlc2lnbmVkIGZvciB1c2UgaW4gc3RyaW5nIG1vZGUsIHdoaWNoCiAgICAvLyBwcm92aWRlcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGEgcGFyYW1ldGVyIGFsb25nIHdpdGggaXRzCiAgICAvLyBkZXB0aCByYXRoZXIgdGhhbiByZXNvbHZpbmcgaXQgaW1tZWRpYXRlbHkuCiAgICBwdXNoU3RyaW5nUGFyYW06IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgICB0aGlzLnB1c2hTdHJpbmcoc3RyaW5nKTsKICAgIH0sCgogICAgLy8gW3B1c2hTdHJpbmddCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHF1b3RlZFN0cmluZyhzdHJpbmcpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcXVvdGVkIHZlcnNpb24gb2YgYHN0cmluZ2Agb250byB0aGUgc3RhY2sKICAgIHB1c2hTdHJpbmc6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5xdW90ZWRTdHJpbmcoc3RyaW5nKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBleHByLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGFuIGV4cHJlc3Npb24gb250byB0aGUgc3RhY2sKICAgIHB1c2g6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgdGhpcy5wdXNoU3RhY2soZXhwcik7CiAgICB9LAoKICAgIC8vIFtwdXNoTGl0ZXJhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIFB1c2hlcyBhIHZhbHVlIG9udG8gdGhlIHN0YWNrLiBUaGlzIG9wZXJhdGlvbiBwcmV2ZW50cwogICAgLy8gdGhlIGNvbXBpbGVyIGZyb20gY3JlYXRpbmcgYSB0ZW1wb3JhcnkgdmFyaWFibGUgdG8gaG9sZAogICAgLy8gaXQuCiAgICBwdXNoTGl0ZXJhbDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHZhbHVlKTsKICAgIH0sCgogICAgLy8gW3B1c2hQcm9ncmFtXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBwcm9ncmFtKGd1aWQpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcHJvZ3JhbSBleHByZXNzaW9uIG9udG8gdGhlIHN0YWNrLiBUaGlzIHRha2VzCiAgICAvLyBhIGNvbXBpbGUtdGltZSBndWlkIGFuZCBjb252ZXJ0cyBpdCBpbnRvIGEgcnVudGltZS1hY2Nlc3NpYmxlCiAgICAvLyBleHByZXNzaW9uLgogICAgcHVzaFByb2dyYW06IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgaWYgKGd1aWQgIT0gbnVsbCkgewogICAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCh0aGlzLnByb2dyYW1FeHByZXNzaW9uKGd1aWQpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwobnVsbCk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2ludm9rZUhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBQb3BzIG9mZiB0aGUgaGVscGVyJ3MgcGFyYW1ldGVycywgaW52b2tlcyB0aGUgaGVscGVyLAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGVscGVyJ3MgcmV0dXJuIHZhbHVlIG9udG8gdGhlIHN0YWNrLgogICAgLy8KICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGZvdW5kLCBgaGVscGVyTWlzc2luZ2AgaXMgY2FsbGVkLgogICAgaW52b2tlSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuaGVscGVyTWlzc2luZyA9ICdoZWxwZXJzLmhlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIGhlbHBlciA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXIubmFtZSk7CgogICAgICB0aGlzLnB1c2hTdGFjaygiZm91bmRIZWxwZXIgPyBmb3VuZEhlbHBlci5jYWxsKCIgKwogICAgICAgIGhlbHBlci5jYWxsUGFyYW1zICsgIikgIiArICI6IGhlbHBlck1pc3NpbmcuY2FsbCgiICsKICAgICAgICBoZWxwZXIuaGVscGVyTWlzc2luZ1BhcmFtcyArICIpIik7CiAgICB9LAoKICAgIC8vIFtpbnZva2VLbm93bkhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gdGhlIGhlbHBlciBpcyBrbm93biB0byBleGlzdCwKICAgIC8vIHNvIGEgYGhlbHBlck1pc3NpbmdgIGZhbGxiYWNrIGlzIG5vdCByZXF1aXJlZC4KICAgIGludm9rZUtub3duSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5wdXNoU3RhY2soaGVscGVyLm5hbWUgKyAiLmNhbGwoIiArIGhlbHBlci5jYWxsUGFyYW1zICsgIikiKTsKICAgIH0sCgogICAgLy8gW2ludm9rZUFtYmlndW91c10KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgZGlzYW1iaWd1YXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gYW4gZXhwcmVzc2lvbiBsaWtlIGB7e2Zvb319YAogICAgLy8gaXMgcHJvdmlkZWQsIGJ1dCB3ZSBkb24ndCBrbm93IGF0IGNvbXBpbGUtdGltZSB3aGV0aGVyIGl0CiAgICAvLyBpcyBhIGhlbHBlciBvciBhIHBhdGguCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gZW1pdHMgbW9yZSBjb2RlIHRoYW4gdGhlIG90aGVyIG9wdGlvbnMsCiAgICAvLyBhbmQgY2FuIGJlIGF2b2lkZWQgYnkgcGFzc2luZyB0aGUgYGtub3duSGVscGVyc2AgYW5kCiAgICAvLyBga25vd25IZWxwZXJzT25seWAgZmxhZ3MgYXQgY29tcGlsZS10aW1lLgogICAgaW52b2tlQW1iaWd1b3VzOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgne30nKTsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIoMCwgbmFtZSk7CgogICAgICB2YXIgaGVscGVyTmFtZSA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMubmFtZUxvb2t1cCgnaGVscGVycycsIG5hbWUsICdoZWxwZXInKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXJOYW1lKTsKCiAgICAgIHZhciBub25IZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIHZhciBuZXh0U3RhY2sgPSB0aGlzLm5leHRTdGFjaygpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgnaWYgKGZvdW5kSGVscGVyKSB7ICcgKyBuZXh0U3RhY2sgKyAnID0gZm91bmRIZWxwZXIuY2FsbCgnICsgaGVscGVyLmNhbGxQYXJhbXMgKyAnKTsgfScpOwogICAgICB0aGlzLnNvdXJjZS5wdXNoKCdlbHNlIHsgJyArIG5leHRTdGFjayArICcgPSAnICsgbm9uSGVscGVyICsgJzsgJyArIG5leHRTdGFjayArICcgPSB0eXBlb2YgJyArIG5leHRTdGFjayArICcgPT09IGZ1bmN0aW9uVHlwZSA/ICcgKyBuZXh0U3RhY2sgKyAnKCkgOiAnICsgbmV4dFN0YWNrICsgJzsgfScpOwogICAgfSwKCiAgICAvLyBbaW52b2tlUGFydGlhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBjb250ZXh0LCAuLi4KICAgIC8vIE9uIHN0YWNrIGFmdGVyOiByZXN1bHQgb2YgcGFydGlhbCBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gcG9wcyBvZmYgYSBjb250ZXh0LCBpbnZva2VzIGEgcGFydGlhbCB3aXRoIHRoYXQgY29udGV4dCwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIHJlc3VsdCBvZiB0aGUgaW52b2NhdGlvbiBiYWNrLgogICAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW3RoaXMubmFtZUxvb2t1cCgncGFydGlhbHMnLCBuYW1lLCAncGFydGlhbCcpLCAiJyIgKyBuYW1lICsgIiciLCB0aGlzLnBvcFN0YWNrKCksICJoZWxwZXJzIiwgInBhcnRpYWxzIl07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGF0YSIpOwogICAgICB9CgogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICB0aGlzLnB1c2hTdGFjaygic2VsZi5pbnZva2VQYXJ0aWFsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpOyIpOwogICAgfSwKCiAgICAvLyBbYXNzaWduVG9IYXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCBoYXNoLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogaGFzaCwgLi4uCiAgICAvLwogICAgLy8gUG9wcyBhIHZhbHVlIGFuZCBoYXNoIG9mZiB0aGUgc3RhY2ssIGFzc2lnbnMgYGhhc2hba2V5XSA9IHZhbHVlYAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGFzaCBiYWNrIG9udG8gdGhlIHN0YWNrLgogICAgYXNzaWduVG9IYXNoOiBmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5wb3BTdGFjaygpOwogICAgICB2YXIgaGFzaCA9IHRoaXMudG9wU3RhY2soKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goaGFzaCArICJbJyIgKyBrZXkgKyAiJ10gPSAiICsgdmFsdWUgKyAiOyIpOwogICAgfSwKCiAgICAvLyBIRUxQRVJTCgogICAgY29tcGlsZXI6IEphdmFTY3JpcHRDb21waWxlciwKCiAgICBjb21waWxlQ2hpbGRyZW46IGZ1bmN0aW9uKGVudmlyb25tZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IGVudmlyb25tZW50LmNoaWxkcmVuLCBjaGlsZCwgY29tcGlsZXI7CgogICAgICBmb3IodmFyIGk9MCwgbD1jaGlsZHJlbi5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICBjb21waWxlciA9IG5ldyB0aGlzLmNvbXBpbGVyKCk7CgogICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtcy5wdXNoKCcnKTsgICAgIC8vIFBsYWNlaG9sZGVyIHRvIHByZXZlbnQgbmFtZSBjb25mbGljdHMgZm9yIG5lc3RlZCBjaGlsZHJlbgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGV4dC5wcm9ncmFtcy5sZW5ndGg7CiAgICAgICAgY2hpbGQuaW5kZXggPSBpbmRleDsKICAgICAgICBjaGlsZC5uYW1lID0gJ3Byb2dyYW0nICsgaW5kZXg7CiAgICAgICAgdGhpcy5jb250ZXh0LnByb2dyYW1zW2luZGV4XSA9IGNvbXBpbGVyLmNvbXBpbGUoY2hpbGQsIG9wdGlvbnMsIHRoaXMuY29udGV4dCk7CiAgICAgIH0KICAgIH0sCgogICAgcHJvZ3JhbUV4cHJlc3Npb246IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKCiAgICAgIGlmKGd1aWQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAic2VsZi5ub29wIjsKICAgICAgfQoKICAgICAgdmFyIGNoaWxkID0gdGhpcy5lbnZpcm9ubWVudC5jaGlsZHJlbltndWlkXSwKICAgICAgICAgIGRlcHRocyA9IGNoaWxkLmRlcHRocy5saXN0LCBkZXB0aDsKCiAgICAgIHZhciBwcm9ncmFtUGFyYW1zID0gW2NoaWxkLmluZGV4LCBjaGlsZC5uYW1lLCAiZGF0YSJdOwoKICAgICAgZm9yKHZhciBpPTAsIGwgPSBkZXB0aHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gZGVwdGhzW2ldOwoKICAgICAgICBpZihkZXB0aCA9PT0gMSkgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoMCIpOyB9CiAgICAgICAgZWxzZSB7IHByb2dyYW1QYXJhbXMucHVzaCgiZGVwdGgiICsgKGRlcHRoIC0gMSkpOyB9CiAgICAgIH0KCiAgICAgIGlmKGRlcHRocy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbSgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9IGVsc2UgewogICAgICAgIHByb2dyYW1QYXJhbXMuc2hpZnQoKTsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbVdpdGhEZXB0aCgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9CiAgICB9LAoKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lLCB2YWwpIHsKICAgICAgdGhpcy51c2VSZWdpc3RlcihuYW1lKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaChuYW1lICsgIiA9ICIgKyB2YWwgKyAiOyIpOwogICAgfSwKCiAgICB1c2VSZWdpc3RlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZighdGhpcy5yZWdpc3RlcnNbbmFtZV0pIHsKICAgICAgICB0aGlzLnJlZ2lzdGVyc1tuYW1lXSA9IHRydWU7CiAgICAgICAgdGhpcy5yZWdpc3RlcnMubGlzdC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIHB1c2hTdGFja0xpdGVyYWw6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaChuZXcgTGl0ZXJhbChpdGVtKSk7CiAgICAgIHJldHVybiBpdGVtOwogICAgfSwKCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmluY3JTdGFjaygpICsgIiA9ICIgKyBpdGVtICsgIjsiKTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICByZXBsYWNlU3RhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHZhciBpdGVtID0gY2FsbGJhY2suY2FsbCh0aGlzLCB0aGlzLnRvcFN0YWNrKCkpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLnRvcFN0YWNrKCkgKyAiID0gIiArIGl0ZW0gKyAiOyIpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICBuZXh0U3RhY2s6IGZ1bmN0aW9uKHNraXBDb21waWxlU3RhY2spIHsKICAgICAgdmFyIG5hbWUgPSB0aGlzLmluY3JTdGFjaygpOwogICAgICB0aGlzLmNvbXBpbGVTdGFjay5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSwKCiAgICBpbmNyU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnN0YWNrU2xvdCsrOwogICAgICBpZih0aGlzLnN0YWNrU2xvdCA+IHRoaXMuc3RhY2tWYXJzLmxlbmd0aCkgeyB0aGlzLnN0YWNrVmFycy5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7IH0KICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgcG9wU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbSA9IHRoaXMuY29tcGlsZVN0YWNrLnBvcCgpOwoKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBMaXRlcmFsKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGFja1Nsb3QtLTsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICB0b3BTdGFjazogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtID0gdGhpcy5jb21waWxlU3RhY2tbdGhpcy5jb21waWxlU3RhY2subGVuZ3RoIC0gMV07CgogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIExpdGVyYWwpIHsKICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICBxdW90ZWRTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gJyInICsgc3RyCiAgICAgICAgLnJlcGxhY2UoL1xcL2csICdcXFxcJykKICAgICAgICAucmVwbGFjZSgvIi9nLCAnXFwiJykKICAgICAgICAucmVwbGFjZSgvXG4vZywgJ1xcbicpCiAgICAgICAgLnJlcGxhY2UoL1xyL2csICdcXHInKSArICciJzsKICAgIH0sCgogICAgc2V0dXBIZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW107CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1TaXplLCBwYXJhbXMpOwogICAgICB2YXIgZm91bmRIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CgogICAgICByZXR1cm4gewogICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgIG5hbWU6IGZvdW5kSGVscGVyLAogICAgICAgIGNhbGxQYXJhbXM6IFsiZGVwdGgwIl0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKSwKICAgICAgICBoZWxwZXJNaXNzaW5nUGFyYW1zOiBbImRlcHRoMCIsIHRoaXMucXVvdGVkU3RyaW5nKG5hbWUpXS5jb25jYXQocGFyYW1zKS5qb2luKCIsICIpCiAgICAgIH07CiAgICB9LAoKICAgIC8vIHRoZSBwYXJhbXMgYW5kIGNvbnRleHRzIGFyZ3VtZW50cyBhcmUgcGFzc2VkIGluIGFycmF5cwogICAgLy8gdG8gZmlsbCBpbgogICAgc2V0dXBQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgcGFyYW1zKSB7CiAgICAgIHZhciBvcHRpb25zID0gW10sIGNvbnRleHRzID0gW10sIHBhcmFtLCBpbnZlcnNlLCBwcm9ncmFtOwoKICAgICAgb3B0aW9ucy5wdXNoKCJoYXNoOiIgKyB0aGlzLnBvcFN0YWNrKCkpOwoKICAgICAgaW52ZXJzZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgcHJvZ3JhbSA9IHRoaXMucG9wU3RhY2soKTsKCiAgICAgIC8vIEF2b2lkIHNldHRpbmcgZm4gYW5kIGludmVyc2UgaWYgbmVpdGhlciBhcmUgc2V0LiBUaGlzIGFsbG93cwogICAgICAvLyBoZWxwZXJzIHRvIGRvIGEgY2hlY2sgZm9yIGBpZiAob3B0aW9ucy5mbilgCiAgICAgIGlmIChwcm9ncmFtIHx8IGludmVyc2UpIHsKICAgICAgICBpZiAoIXByb2dyYW0pIHsKICAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBwcm9ncmFtID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgICAgIGludmVyc2UgPSAic2VsZi5ub29wIjsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnMucHVzaCgiaW52ZXJzZToiICsgaW52ZXJzZSk7CiAgICAgICAgb3B0aW9ucy5wdXNoKCJmbjoiICsgcHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGZvcih2YXIgaT0wOyBpPHBhcmFtU2l6ZTsgaSsrKSB7CiAgICAgICAgcGFyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc3RyaW5nUGFyYW1zKSB7CiAgICAgICAgICBjb250ZXh0cy5wdXNoKHRoaXMucG9wU3RhY2soKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIG9wdGlvbnMucHVzaCgiY29udGV4dHM6WyIgKyBjb250ZXh0cy5qb2luKCIsIikgKyAiXSIpOwogICAgICB9CgogICAgICBpZih0aGlzLm9wdGlvbnMuZGF0YSkgewogICAgICAgIG9wdGlvbnMucHVzaCgiZGF0YTpkYXRhIik7CiAgICAgIH0KCiAgICAgIHBhcmFtcy5wdXNoKCJ7IiArIG9wdGlvbnMuam9pbigiLCIpICsgIn0iKTsKICAgICAgcmV0dXJuIHBhcmFtcy5qb2luKCIsICIpOwogICAgfQogIH07CgogIHZhciByZXNlcnZlZFdvcmRzID0gKAogICAgImJyZWFrIGVsc2UgbmV3IHZhciIgKwogICAgIiBjYXNlIGZpbmFsbHkgcmV0dXJuIHZvaWQiICsKICAgICIgY2F0Y2ggZm9yIHN3aXRjaCB3aGlsZSIgKwogICAgIiBjb250aW51ZSBmdW5jdGlvbiB0aGlzIHdpdGgiICsKICAgICIgZGVmYXVsdCBpZiB0aHJvdyIgKwogICAgIiBkZWxldGUgaW4gdHJ5IiArCiAgICAiIGRvIGluc3RhbmNlb2YgdHlwZW9mIiArCiAgICAiIGFic3RyYWN0IGVudW0gaW50IHNob3J0IiArCiAgICAiIGJvb2xlYW4gZXhwb3J0IGludGVyZmFjZSBzdGF0aWMiICsKICAgICIgYnl0ZSBleHRlbmRzIGxvbmcgc3VwZXIiICsKICAgICIgY2hhciBmaW5hbCBuYXRpdmUgc3luY2hyb25pemVkIiArCiAgICAiIGNsYXNzIGZsb2F0IHBhY2thZ2UgdGhyb3dzIiArCiAgICAiIGNvbnN0IGdvdG8gcHJpdmF0ZSB0cmFuc2llbnQiICsKICAgICIgZGVidWdnZXIgaW1wbGVtZW50cyBwcm90ZWN0ZWQgdm9sYXRpbGUiICsKICAgICIgZG91YmxlIGltcG9ydCBwdWJsaWMgbGV0IHlpZWxkIgogICkuc3BsaXQoIiAiKTsKCiAgdmFyIGNvbXBpbGVyV29yZHMgPSBKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFMgPSB7fTsKCiAgZm9yKHZhciBpPTAsIGw9cmVzZXJ2ZWRXb3Jkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBjb21waWxlcldvcmRzW3Jlc2VydmVkV29yZHNbaV1dID0gdHJ1ZTsKICB9CgogIEphdmFTY3JpcHRDb21waWxlci5pc1ZhbGlkSmF2YVNjcmlwdFZhcmlhYmxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmKCFKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFNbbmFtZV0gJiYgL15bYS16QS1aXyRdWzAtOWEtekEtWl8kXSskLy50ZXN0KG5hbWUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cgp9KShIYW5kbGViYXJzLkNvbXBpbGVyLCBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcik7CgpIYW5kbGViYXJzLnByZWNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBpZiAoISgnZGF0YScgaW4gb3B0aW9ucykpIHsKICAgIG9wdGlvbnMuZGF0YSA9IHRydWU7CiAgfQogIHZhciBhc3QgPSBIYW5kbGViYXJzLnBhcnNlKHN0cmluZyk7CiAgdmFyIGVudmlyb25tZW50ID0gbmV3IEhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcigpLmNvbXBpbGUoZW52aXJvbm1lbnQsIG9wdGlvbnMpOwp9OwoKSGFuZGxlYmFycy5jb21waWxlID0gZnVuY3Rpb24oc3RyaW5nLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgaWYgKCEoJ2RhdGEnIGluIG9wdGlvbnMpKSB7CiAgICBvcHRpb25zLmRhdGEgPSB0cnVlOwogIH0KICB2YXIgY29tcGlsZWQ7CiAgZnVuY3Rpb24gY29tcGlsZSgpIHsKICAgIHZhciBhc3QgPSBIYW5kbGViYXJzLnBhcnNlKHN0cmluZyk7CiAgICB2YXIgZW52aXJvbm1lbnQgPSBuZXcgSGFuZGxlYmFycy5Db21waWxlcigpLmNvbXBpbGUoYXN0LCBvcHRpb25zKTsKICAgIHZhciB0ZW1wbGF0ZVNwZWMgPSBuZXcgSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIoKS5jb21waWxlKGVudmlyb25tZW50LCBvcHRpb25zLCB1bmRlZmluZWQsIHRydWUpOwogICAgcmV0dXJuIEhhbmRsZWJhcnMudGVtcGxhdGUodGVtcGxhdGVTcGVjKTsKICB9CgogIC8vIFRlbXBsYXRlIGlzIG9ubHkgY29tcGlsZWQgb24gZmlyc3QgdXNlIGFuZCBjYWNoZWQgYWZ0ZXIgdGhhdCBwb2ludC4KICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgaWYgKCFjb21waWxlZCkgewogICAgICBjb21waWxlZCA9IGNvbXBpbGUoKTsKICAgIH0KICAgIHJldHVybiBjb21waWxlZC5jYWxsKHRoaXMsIGNvbnRleHQsIG9wdGlvbnMpOwogIH07Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvcnVudGltZS5qcwpIYW5kbGViYXJzLlZNID0gewogIHRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZVNwZWMpIHsKICAgIC8vIEp1c3QgYWRkIHdhdGVyCiAgICB2YXIgY29udGFpbmVyID0gewogICAgICBlc2NhcGVFeHByZXNzaW9uOiBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24sCiAgICAgIGludm9rZVBhcnRpYWw6IEhhbmRsZWJhcnMuVk0uaW52b2tlUGFydGlhbCwKICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICBwcm9ncmFtOiBmdW5jdGlvbihpLCBmbiwgZGF0YSkgewogICAgICAgIHZhciBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV07CiAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIgPSBIYW5kbGViYXJzLlZNLnByb2dyYW0oZm4sIGRhdGEpOwogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIucHJvZ3JhbSA9IGk7CiAgICAgICAgfSBlbHNlIGlmICghcHJvZ3JhbVdyYXBwZXIpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXSA9IEhhbmRsZWJhcnMuVk0ucHJvZ3JhbShmbik7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlci5wcm9ncmFtID0gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb2dyYW1XcmFwcGVyOwogICAgICB9LAogICAgICBwcm9ncmFtV2l0aERlcHRoOiBIYW5kbGViYXJzLlZNLnByb2dyYW1XaXRoRGVwdGgsCiAgICAgIG5vb3A6IEhhbmRsZWJhcnMuVk0ubm9vcAogICAgfTsKCiAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgcmV0dXJuIHRlbXBsYXRlU3BlYy5jYWxsKGNvbnRhaW5lciwgSGFuZGxlYmFycywgY29udGV4dCwgb3B0aW9ucy5oZWxwZXJzLCBvcHRpb25zLnBhcnRpYWxzLCBvcHRpb25zLmRhdGEpOwogICAgfTsKICB9LAoKICBwcm9ncmFtV2l0aERlcHRoOiBmdW5jdGlvbihmbiwgZGF0YSwgJGRlcHRoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgW2NvbnRleHQsIG9wdGlvbnMuZGF0YSB8fCBkYXRhXS5jb25jYXQoYXJncykpOwogICAgfTsKICB9LAogIHByb2dyYW06IGZ1bmN0aW9uKGZuLCBkYXRhKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIHJldHVybiBmbihjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YSk7CiAgICB9OwogIH0sCiAgbm9vcDogZnVuY3Rpb24oKSB7IHJldHVybiAiIjsgfSwKICBpbnZva2VQYXJ0aWFsOiBmdW5jdGlvbihwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewogICAgdmFyIG9wdGlvbnMgPSB7IGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoKICAgIGlmKHBhcnRpYWwgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgZm91bmQiKTsKICAgIH0gZWxzZSBpZihwYXJ0aWFsIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKICAgICAgcmV0dXJuIHBhcnRpYWwoY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKCFIYW5kbGViYXJzLmNvbXBpbGUpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGNvbXBpbGVkIHdoZW4gcnVubmluZyBpbiBydW50aW1lLW9ubHkgbW9kZSIpOwogICAgfSBlbHNlIHsKICAgICAgcGFydGlhbHNbbmFtZV0gPSBIYW5kbGViYXJzLmNvbXBpbGUocGFydGlhbCwge2RhdGE6IGRhdGEgIT09IHVuZGVmaW5lZH0pOwogICAgICByZXR1cm4gcGFydGlhbHNbbmFtZV0oY29udGV4dCwgb3B0aW9ucyk7CiAgICB9CiAgfQp9OwoKSGFuZGxlYmFycy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0udGVtcGxhdGU7CjsKCi8vICAgICBVbmRlcnNjb3JlLmpzIDEuNC4yCi8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGdsb2JhbGAgb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKCiAgLy8gRXN0YWJsaXNoIHRoZSBvYmplY3QgdGhhdCBnZXRzIHJldHVybmVkIHRvIGJyZWFrIG91dCBvZiBhIGxvb3AgaXRlcmF0aW9uLgogIHZhciBicmVha2VyID0ge307CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIgcHVzaCAgICAgICAgICAgICA9IEFycmF5UHJvdG8ucHVzaCwKICAgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgICAgdW5zaGlmdCAgICAgICAgICA9IEFycmF5UHJvdG8udW5zaGlmdCwKICAgICAgdG9TdHJpbmcgICAgICAgICA9IE9ialByb3RvLnRvU3RyaW5nLAogICAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhcgogICAgbmF0aXZlRm9yRWFjaCAgICAgID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgbmF0aXZlTWFwICAgICAgICAgID0gQXJyYXlQcm90by5tYXAsCiAgICBuYXRpdmVSZWR1Y2UgICAgICAgPSBBcnJheVByb3RvLnJlZHVjZSwKICAgIG5hdGl2ZVJlZHVjZVJpZ2h0ICA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsCiAgICBuYXRpdmVGaWx0ZXIgICAgICAgPSBBcnJheVByb3RvLmZpbHRlciwKICAgIG5hdGl2ZUV2ZXJ5ICAgICAgICA9IEFycmF5UHJvdG8uZXZlcnksCiAgICBuYXRpdmVTb21lICAgICAgICAgPSBBcnJheVByb3RvLnNvbWUsCiAgICBuYXRpdmVJbmRleE9mICAgICAgPSBBcnJheVByb3RvLmluZGV4T2YsCiAgICBuYXRpdmVMYXN0SW5kZXhPZiAgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLAogICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKICAgIG5hdGl2ZUtleXMgICAgICAgICA9IE9iamVjdC5rZXlzLAogICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CgogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290WydfJ10gPSBfOwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uLgogIF8uVkVSU0lPTiA9ICcxLjQuMic7CgogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9iai5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpIHsKICAgICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVNYXAgJiYgb2JqLm1hcCA9PT0gbmF0aXZlTWFwKSByZXR1cm4gb2JqLm1hcChpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gVGhlIHJpZ2h0LWFzc29jaWF0aXZlIHZlcnNpb24gb2YgcmVkdWNlLCBhbHNvIGtub3duIGFzIGBmb2xkcmAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZVJpZ2h0YCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2VSaWdodCA9IF8uZm9sZHIgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2VSaWdodCAmJiBvYmoucmVkdWNlUmlnaHQgPT09IG5hdGl2ZVJlZHVjZVJpZ2h0KSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMiA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpbmRleCA9IGtleXMgPyBrZXlzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gb2JqW2luZGV4XTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCBvYmpbaW5kZXhdLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJyk7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0OwogICAgYW55KG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZUZpbHRlciAmJiBvYmouZmlsdGVyID09PSBuYXRpdmVGaWx0ZXIpIHJldHVybiBvYmouZmlsdGVyKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciB8fCAoaXRlcmF0b3IgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZUV2ZXJ5ICYmIG9iai5ldmVyeSA9PT0gbmF0aXZlRXZlcnkpIHJldHVybiBvYmouZXZlcnkoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkgcmV0dXJuIG9iai5zb21lKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgdGhlIGFycmF5IG9yIG9iamVjdCBjb250YWlucyBhIGdpdmVuIHZhbHVlICh1c2luZyBgPT09YCkuCiAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCiAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CiAgICB2YXIgZm91bmQgPSBmYWxzZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZvdW5kOwogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgb2JqLmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBvYmouaW5kZXhPZih0YXJnZXQpICE9IC0xOwogICAgZm91bmQgPSBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogICAgcmV0dXJuIGZvdW5kOwogIH07CgogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIChfLmlzRnVuY3Rpb24obWV0aG9kKSA/IG1ldGhvZCA6IHZhbHVlW21ldGhvZF0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYG1hcGA6IGZldGNoaW5nIGEgcHJvcGVydHkuCiAgXy5wbHVjayA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CiAgICByZXR1cm4gXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiB2YWx1ZVtrZXldOyB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaWx0ZXJgOiBzZWxlY3Rpbmcgb25seSBvYmplY3RzCiAgLy8gd2l0aCBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLndoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChhdHRyc1trZXldICE9PSB2YWx1ZVtrZXldKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG1heGltdW0gZWxlbWVudCBvciAoZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgLy8gQ2FuJ3Qgb3B0aW1pemUgYXJyYXlzIG9mIGludGVnZXJzIGxvbmdlciB0aGFuIDY1LDUzNSBlbGVtZW50cy4KICAvLyBTZWU6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD04MDc5NwogIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIC1JbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiAtSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA+PSByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIEluZmluaXR5OwogICAgdmFyIHJlc3VsdCA9IHtjb21wdXRlZCA6IEluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPCByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhbiBhcnJheS4KICBfLnNodWZmbGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgbG9va3VwIGl0ZXJhdG9ycy4KICB2YXIgbG9va3VwSXRlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG9iail7IHJldHVybiBvYmpbdmFsdWVdOyB9OwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWUgOiB2YWx1ZSwKICAgICAgICBpbmRleCA6IGluZGV4LAogICAgICAgIGNyaXRlcmlhIDogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKICAgICAgdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggPCByaWdodC5pbmRleCA/IC0xIDogMTsKICAgIH0pLCAndmFsdWUnKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQsIGJlaGF2aW9yKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIHZhciBrZXkgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgb2JqKTsKICAgICAgYmVoYXZpb3IocmVzdWx0LCBrZXksIHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBHcm91cHMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbi4gUGFzcyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlCiAgLy8gdG8gZ3JvdXAgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcml0ZXJpb24uCiAgXy5ncm91cEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgcmV0dXJuIGdyb3VwKG9iaiwgdmFsdWUsIGNvbnRleHQsIGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgICAoXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0gOiAocmVzdWx0W2tleV0gPSBbXSkpLnB1c2godmFsdWUpOwogICAgfSk7CiAgfTsKCiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgaWYgKCFfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldID0gMDsKICAgICAgcmVzdWx0W2tleV0rKzsKICAgIH0pOwogIH07CgogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uKGFycmF5LCBvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGl0ZXJhdG9yID09IG51bGwgPyBfLmlkZW50aXR5IDogbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKCiAgLy8gU2FmZWx5IGNvbnZlcnQgYW55dGhpbmcgaXRlcmFibGUgaW50byBhIHJlYWwsIGxpdmUgYXJyYXkuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gb2JqZWN0LgogIF8uc2l6ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIEFycmF5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiAobiAhPSBudWxsKSAmJiAhZ3VhcmQgPyBzbGljZS5jYWxsKGFycmF5LCAwLCBuKSA6IGFycmF5WzBdOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBhcnJheS5sZW5ndGggLSAoKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbikpOwogIH07CgogIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmxhc3QgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmICgobiAhPSBudWxsKSAmJiAhZ3VhcmQpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIE1hdGgubWF4KGFycmF5Lmxlbmd0aCAtIG4sIDApKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIH0KICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsgcmV0dXJuICEhdmFsdWU7IH0pOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CgogIC8vIFJldHVybiBhIGNvbXBsZXRlbHkgZmxhdHRlbmVkIHZlcnNpb24gb2YgYW4gYXJyYXkuCiAgXy5mbGF0dGVuID0gZnVuY3Rpb24oYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCiAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKCiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGlmIChpc1NvcnRlZCA/ICghaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSkgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgogIC8vIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogIF8udW5pb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLnVuaXEoY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIGFyZ3VtZW50cykpOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyBldmVyeSBpdGVtIHNoYXJlZCBiZXR3ZWVuIGFsbCB0aGUKICAvLyBwYXNzZWQtaW4gYXJyYXlzLgogIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gXy5pbmRleE9mKG90aGVyLCBpdGVtKSA+PSAwOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7IH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgbGVuZ3RoID0gXy5tYXgoXy5wbHVjayhhcmdzLCAnbGVuZ3RoJykpOwogICAgdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJncywgIiIgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbbGlzdFtpXVswXV0gPSBsaXN0W2ldWzFdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGlzU29ydGVkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gKGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGwgKyBpc1NvcnRlZCkgOiBpc1NvcnRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsOyBpKyspIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBmcm9tKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGhhc0luZGV4ID0gZnJvbSAhPSBudWxsOwogICAgaWYgKG5hdGl2ZUxhc3RJbmRleE9mICYmIGFycmF5Lmxhc3RJbmRleE9mID09PSBuYXRpdmVMYXN0SW5kZXhPZikgewogICAgICByZXR1cm4gaGFzSW5kZXggPyBhcnJheS5sYXN0SW5kZXhPZihpdGVtLCBmcm9tKSA6IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0pOwogICAgfQogICAgdmFyIGkgPSAoaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoKTsKICAgIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24oc3RhcnQsIHN0b3AsIHN0ZXApIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIHN0ZXAgPSBhcmd1bWVudHNbMl0gfHwgMTsKCiAgICB2YXIgbGVuID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuKTsKCiAgICB3aGlsZShpZHggPCBsZW4pIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CgogICAgcmV0dXJuIHJhbmdlOwogIH07CgogIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV1c2FibGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHByb3RvdHlwZSBzZXR0aW5nLgogIHZhciBjdG9yID0gZnVuY3Rpb24oKXt9OwoKICAvLyBDcmVhdGUgYSBmdW5jdGlvbiBib3VuZCB0byBhIGdpdmVuIG9iamVjdCAoYXNzaWduaW5nIGB0aGlzYCwgYW5kIGFyZ3VtZW50cywKICAvLyBvcHRpb25hbGx5KS4gQmluZGluZyB3aXRoIGFyZ3VtZW50cyBpcyBhbHNvIGtub3duIGFzIGBjdXJyeWAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYEZ1bmN0aW9uLmJpbmRgIGlmIGF2YWlsYWJsZS4KICAvLyBXZSBjaGVjayBmb3IgYGZ1bmMuYmluZGAgZmlyc3QsIHRvIGZhaWwgZmFzdCB3aGVuIGBmdW5jYCBpcyB1bmRlZmluZWQuCiAgXy5iaW5kID0gZnVuY3Rpb24gYmluZChmdW5jLCBjb250ZXh0KSB7CiAgICB2YXIgYm91bmQsIGFyZ3M7CiAgICBpZiAoZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kICYmIG5hdGl2ZUJpbmQpIHJldHVybiBuYXRpdmVCaW5kLmFwcGx5KGZ1bmMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBpZiAoIV8uaXNGdW5jdGlvbihmdW5jKSkgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gYm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSkgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CiAgICAgIHZhciBzZWxmID0gbmV3IGN0b3I7CiAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBpZiAoT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCkgcmV0dXJuIHJlc3VsdDsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYWxsIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdAogIC8vIGFsbCBjYWxsYmFja3MgZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PSAwKSBmdW5jcyA9IF8uZnVuY3Rpb25zKG9iaik7CiAgICBlYWNoKGZ1bmNzLCBmdW5jdGlvbihmKSB7IG9ialtmXSA9IF8uYmluZChvYmpbZl0sIG9iaik7IH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBNZW1vaXplIGFuIGV4cGVuc2l2ZSBmdW5jdGlvbiBieSBzdG9yaW5nIGl0cyByZXN1bHRzLgogIF8ubWVtb2l6ZSA9IGZ1bmN0aW9uKGZ1bmMsIGhhc2hlcikgewogICAgdmFyIG1lbW8gPSB7fTsKICAgIGhhc2hlciB8fCAoaGFzaGVyID0gXy5pZGVudGl0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBrZXkgPSBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIF8uaGFzKG1lbW8sIGtleSkgPyBtZW1vW2tleV0gOiAobWVtb1trZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfTsKCiAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwogIC8vIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBzdXBwbGllZC4KICBfLmRlbGF5ID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpeyByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsgfSwgd2FpdCk7CiAgfTsKCiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewogICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4KICBfLnRocm90dGxlID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGNvbnRleHQsIGFyZ3MsIHRpbWVvdXQsIHRocm90dGxpbmcsIG1vcmUsIHJlc3VsdDsKICAgIHZhciB3aGVuRG9uZSA9IF8uZGVib3VuY2UoZnVuY3Rpb24oKXsgbW9yZSA9IHRocm90dGxpbmcgPSBmYWxzZTsgfSwgd2FpdCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGNvbnRleHQgPSB0aGlzOyBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAobW9yZSkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgd2hlbkRvbmUoKTsKICAgICAgfTsKICAgICAgaWYgKCF0aW1lb3V0KSB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgIGlmICh0aHJvdHRsaW5nKSB7CiAgICAgICAgbW9yZSA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3R0bGluZyA9IHRydWU7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfQogICAgICB3aGVuRG9uZSgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbZnVuY107CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CiAgICBpZiAodGltZXMgPD0gMCkgcmV0dXJuIGZ1bmMoKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBPYmplY3QgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXRyaWV2ZSB0aGUgbmFtZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCiAgXy5rZXlzID0gbmF0aXZlS2V5cyB8fCBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogIT09IE9iamVjdChvYmopKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG9iamVjdCcpOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXNba2V5cy5sZW5ndGhdID0ga2V5OwogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIF8udmFsdWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgdmFsdWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSB2YWx1ZXMucHVzaChvYmpba2V5XSk7CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBwYWlycyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcGFpcnMucHVzaChba2V5LCBvYmpba2V5XV0pOwogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmVzdWx0W29ialtrZXldXSA9IGtleTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGVhY2goa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIC8vIEZpbGwgaW4gYSBnaXZlbiBvYmplY3Qgd2l0aCBkZWZhdWx0IHByb3BlcnRpZXMuCiAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIGlmIChvYmpbcHJvcF0gPT0gbnVsbCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgogIF8uY2xvbmUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwogICAgcmV0dXJuIF8uaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBfLmV4dGVuZCh7fSwgb2JqKTsKICB9OwoKICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCiAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgogIC8vIG9yZGVyIHRvIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiBpbnRlcm1lZGlhdGUgcmVzdWx0cyB3aXRoaW4gdGhlIGNoYWluLgogIF8udGFwID0gZnVuY3Rpb24ob2JqLCBpbnRlcmNlcHRvcikgewogICAgaW50ZXJjZXB0b3Iob2JqKTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KICB2YXIgZXEgPSBmdW5jdGlvbihhLCBiLCBhU3RhY2ssIGJTdGFjaykgewogICAgLy8gSWRlbnRpY2FsIG9iamVjdHMgYXJlIGVxdWFsLiBgMCA9PT0gLTBgLCBidXQgdGhleSBhcmVuJ3QgaWRlbnRpY2FsLgogICAgLy8gU2VlIHRoZSBIYXJtb255IGBlZ2FsYCBwcm9wb3NhbDogaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsLgogICAgaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwogICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwogICAgLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCiAgICBpZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwogICAgaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKICAgIC8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKICAgIGlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCiAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KICAgICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvcgogICAgICAgIC8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgogICAgICAgIHJldHVybiBhICE9ICthID8gYiAhPSArYiA6IChhID09IDAgPyAxIC8gYSA9PSAxIC8gYiA6IGEgPT0gK2IpOwogICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgogICAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgICAgcmV0dXJuICthID09ICtiOwogICAgICAvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgogICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgogICAgICAgIHJldHVybiBhLnNvdXJjZSA9PSBiLnNvdXJjZSAmJgogICAgICAgICAgICAgICBhLmdsb2JhbCA9PSBiLmdsb2JhbCAmJgogICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PSBiLm11bHRpbGluZSAmJgogICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT0gYi5pZ25vcmVDYXNlOwogICAgfQogICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CiAgICAvLyBBc3N1bWUgZXF1YWxpdHkgZm9yIGN5Y2xpYyBzdHJ1Y3R1cmVzLiBUaGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljCiAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KICAgIHZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIC8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgogICAgICAvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCiAgICAgIGlmIChhU3RhY2tbbGVuZ3RoXSA9PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKICAgIH0KICAgIC8vIEFkZCB0aGUgZmlyc3Qgb2JqZWN0IHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wdXNoKGEpOwogICAgYlN0YWNrLnB1c2goYik7CiAgICB2YXIgc2l6ZSA9IDAsIHJlc3VsdCA9IHRydWU7CiAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KICAgIGlmIChjbGFzc05hbWUgPT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBlcShhW3NpemVdLCBiW3NpemVdLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgICAvLyBmcm9tIGRpZmZlcmVudCBmcmFtZXMgYXJlLgogICAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CiAgICAgIGlmIChhQ3RvciAhPT0gYkN0b3IgJiYgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIChhQ3RvciBpbnN0YW5jZW9mIGFDdG9yKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiAoYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIERlZXAgY29tcGFyZSBvYmplY3RzLgogICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgIGlmIChfLmhhcyhhLCBrZXkpKSB7CiAgICAgICAgICAvLyBDb3VudCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgICAgICBzaXplKys7CiAgICAgICAgICAvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIuCiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBfLmhhcyhiLCBrZXkpICYmIGVxKGFba2V5XSwgYltrZXldLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICBmb3IgKGtleSBpbiBiKSB7CiAgICAgICAgICBpZiAoXy5oYXMoYiwga2V5KSAmJiAhKHNpemUtLSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSAhc2l6ZTsKICAgICAgfQogICAgfQogICAgLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucG9wKCk7CiAgICBiU3RhY2sucG9wKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgogIF8uaXNFcXVhbCA9IGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBlcShhLCBiLCBbXSwgW10pOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gYXJyYXksIHN0cmluZywgb3Igb2JqZWN0IGVtcHR5PwogIC8vIEFuICJlbXB0eSIgb2JqZWN0IGhhcyBubyBlbnVtZXJhYmxlIG93bi1wcm9wZXJ0aWVzLgogIF8uaXNFbXB0eSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSB8fCBfLmlzU3RyaW5nKG9iaikpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIERPTSBlbGVtZW50PwogIF8uaXNFbGVtZW50ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhbiBhcnJheT8KICAvLyBEZWxlZ2F0ZXMgdG8gRUNNQTUncyBuYXRpdmUgQXJyYXkuaXNBcnJheQogIF8uaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSBhbiBvYmplY3Q/CiAgXy5pc09iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gT2JqZWN0KG9iaik7CiAgfTsKCiAgLy8gQWRkIHNvbWUgaXNUeXBlIG1ldGhvZHM6IGlzQXJndW1lbnRzLCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgaXNOdW1iZXIsIGlzRGF0ZSwgaXNSZWdFeHAuCiAgZWFjaChbJ0FyZ3VtZW50cycsICdGdW5jdGlvbicsICdTdHJpbmcnLCAnTnVtYmVyJywgJ0RhdGUnLCAnUmVnRXhwJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIF9bJ2lzJyArIG5hbWVdID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgJyArIG5hbWUgKyAnXSc7CiAgICB9OwogIH0pOwoKICAvLyBEZWZpbmUgYSBmYWxsYmFjayB2ZXJzaW9uIG9mIHRoZSBtZXRob2QgaW4gYnJvd3NlcnMgKGFoZW0sIElFKSwgd2hlcmUKICAvLyB0aGVyZSBpc24ndCBhbnkgaW5zcGVjdGFibGUgIkFyZ3VtZW50cyIgdHlwZS4KICBpZiAoIV8uaXNBcmd1bWVudHMoYXJndW1lbnRzKSkgewogICAgXy5pc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gISEob2JqICYmIF8uaGFzKG9iaiwgJ2NhbGxlZScpKTsKICAgIH07CiAgfQoKICAvLyBPcHRpbWl6ZSBgaXNGdW5jdGlvbmAgaWYgYXBwcm9wcmlhdGUuCiAgaWYgKHR5cGVvZiAoLy4vKSAhPT0gJ2Z1bmN0aW9uJykgewogICAgXy5pc0Z1bmN0aW9uID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nOwogICAgfTsKICB9CgogIC8vIElzIGEgZ2l2ZW4gb2JqZWN0IGEgZmluaXRlIG51bWJlcj8KICBfLmlzRmluaXRlID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIGlzRmluaXRlKG9iaik7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9ICtvYmo7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQm9vbGVhbl0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbDsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CiAgfTsKCiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogIH07CgogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBpKTsKICB9OwoKICAvLyBSZXR1cm4gYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIG1pbiBhbmQgbWF4IChpbmNsdXNpdmUpLgogIF8ucmFuZG9tID0gZnVuY3Rpb24obWluLCBtYXgpIHsKICAgIGlmIChtYXggPT0gbnVsbCkgewogICAgICBtYXggPSBtaW47CiAgICAgIG1pbiA9IDA7CiAgICB9CiAgICByZXR1cm4gbWluICsgKDAgfCBNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKTsKICB9OwoKICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlbnRpdHlNYXAgPSB7CiAgICBlc2NhcGU6IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICInIjogJyYjeDI3OycsCiAgICAgICcvJzogJyYjeDJGOycKICAgIH0KICB9OwogIGVudGl0eU1hcC51bmVzY2FwZSA9IF8uaW52ZXJ0KGVudGl0eU1hcC5lc2NhcGUpOwoKICAvLyBSZWdleGVzIGNvbnRhaW5pbmcgdGhlIGtleXMgYW5kIHZhbHVlcyBsaXN0ZWQgaW1tZWRpYXRlbHkgYWJvdmUuCiAgdmFyIGVudGl0eVJlZ2V4ZXMgPSB7CiAgICBlc2NhcGU6ICAgbmV3IFJlZ0V4cCgnWycgKyBfLmtleXMoZW50aXR5TWFwLmVzY2FwZSkuam9pbignJykgKyAnXScsICdnJyksCiAgICB1bmVzY2FwZTogbmV3IFJlZ0V4cCgnKCcgKyBfLmtleXMoZW50aXR5TWFwLnVuZXNjYXBlKS5qb2luKCd8JykgKyAnKScsICdnJykKICB9OwoKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgXy5lYWNoKFsnZXNjYXBlJywgJ3VuZXNjYXBlJ10sIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgX1ttZXRob2RdID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gKCcnICsgc3RyaW5nKS5yZXBsYWNlKGVudGl0eVJlZ2V4ZXNbbWV0aG9kXSwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICByZXR1cm4gZW50aXR5TWFwW21ldGhvZF1bbWF0Y2hdOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQgcHJvcGVydHkgaXMgYSBmdW5jdGlvbiB0aGVuIGludm9rZSBpdDsKICAvLyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICB2YXIgdmFsdWUgPSBvYmplY3RbcHJvcGVydHldOwogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZS5jYWxsKG9iamVjdCkgOiB2YWx1ZTsKICB9OwoKICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbihuYW1lKXsKICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwogICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhIHVuaXF1ZSBpbnRlZ2VyIGlkICh1bmlxdWUgd2l0aGluIHRoZSBlbnRpcmUgY2xpZW50IHNlc3Npb24pLgogIC8vIFVzZWZ1bCBmb3IgdGVtcG9yYXJ5IERPTSBpZHMuCiAgdmFyIGlkQ291bnRlciA9IDA7CiAgXy51bmlxdWVJZCA9IGZ1bmN0aW9uKHByZWZpeCkgewogICAgdmFyIGlkID0gaWRDb3VudGVyKys7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9OwoKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGUgICAgOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAogICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKICB9OwoKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwoKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgIiciOiAgICAgICInIiwKICAgICdcXCc6ICAgICAnXFwnLAogICAgJ1xyJzogICAgICdyJywKICAgICdcbic6ICAgICAnbicsCiAgICAnXHQnOiAgICAgJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwoKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHNldHRpbmdzID0gXy5kZWZhdWx0cyh7fSwgc2V0dGluZ3MsIF8udGVtcGxhdGVTZXR0aW5ncyk7CgogICAgLy8gQ29tYmluZSBkZWxpbWl0ZXJzIGludG8gb25lIHJlZ3VsYXIgZXhwcmVzc2lvbiB2aWEgYWx0ZXJuYXRpb24uCiAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoWwogICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmV2YWx1YXRlIHx8IG5vTWF0Y2gpLnNvdXJjZQogICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwogICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGUsIGludGVycG9sYXRlLCBldmFsdWF0ZSwgb2Zmc2V0KSB7CiAgICAgIHNvdXJjZSArPSB0ZXh0LnNsaWNlKGluZGV4LCBvZmZzZXQpCiAgICAgICAgLnJlcGxhY2UoZXNjYXBlciwgZnVuY3Rpb24obWF0Y2gpIHsgcmV0dXJuICdcXCcgKyBlc2NhcGVzW21hdGNoXTsgfSk7CiAgICAgIHNvdXJjZSArPQogICAgICAgIGVzY2FwZSA/ICInK1xuKChfX3Q9KCIgKyBlc2NhcGUgKyAiKSk9PW51bGw/Jyc6Xy5lc2NhcGUoX190KSkrXG4nIiA6CiAgICAgICAgaW50ZXJwb2xhdGUgPyAiJytcbigoX190PSgiICsgaW50ZXJwb2xhdGUgKyAiKSk9PW51bGw/Jyc6X190KStcbiciIDoKICAgICAgICBldmFsdWF0ZSA/ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIiA6ICcnOwogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgIH0pOwogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKICAgICAgInByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307XG4iICsKICAgICAgc291cmNlICsgInJldHVybiBfX3A7XG4iOwoKICAgIHRyeSB7CiAgICAgIHZhciByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CgogICAgaWYgKGRhdGEpIHJldHVybiByZW5kZXIoZGF0YSwgXyk7CiAgICB2YXIgdGVtcGxhdGUgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKICAgIH07CgogICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24gc291cmNlIGFzIGEgY29udmVuaWVuY2UgZm9yIHByZWNvbXBpbGF0aW9uLgogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9OwoKICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLCB3aGljaCB3aWxsIGRlbGVnYXRlIHRvIHRoZSB3cmFwcGVyLgogIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfKG9iaikuY2hhaW4oKTsKICB9OwoKICAvLyBPT1AKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAogIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCiAgLy8gdW5kZXJzY29yZSBmdW5jdGlvbnMuIFdyYXBwZWQgb2JqZWN0cyBtYXkgYmUgY2hhaW5lZC4KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgogIHZhciByZXN1bHQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0aGlzLl9jaGFpbiA/IF8ob2JqKS5jaGFpbigpIDogb2JqOwogIH07CgogIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KICBfLm1peGluKF8pOwoKICAvLyBBZGQgYWxsIG11dGF0b3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09ICdzaGlmdCcgfHwgbmFtZSA9PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkgZGVsZXRlIG9ialswXTsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG9iaik7CiAgICB9OwogIH0pOwoKICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwogICAgfTsKICB9KTsKCiAgXy5leHRlbmQoXy5wcm90b3R5cGUsIHsKCiAgICAvLyBTdGFydCBjaGFpbmluZyBhIHdyYXBwZWQgVW5kZXJzY29yZSBvYmplY3QuCiAgICBjaGFpbjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgogICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICAgIH0KCiAgfSk7Cgp9KS5jYWxsKHRoaXMpOwoKLy8gICAgIEJhY2tib25lLmpzIDAuOS4xMAoKLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24oKXsKCiAgLy8gSW5pdGlhbCBTZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAoYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIGBleHBvcnRzYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIGFycmF5IG1ldGhvZHMuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIFRoZSB0b3AtbGV2ZWwgbmFtZXNwYWNlLiBBbGwgcHVibGljIEJhY2tib25lIGNsYXNzZXMgYW5kIG1vZHVsZXMgd2lsbAogIC8vIGJlIGF0dGFjaGVkIHRvIHRoaXMuIEV4cG9ydGVkIGZvciBib3RoIENvbW1vbkpTIGFuZCB0aGUgYnJvd3Nlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcwLjkuMTAnOwoKICAvLyBSZXF1aXJlIFVuZGVyc2NvcmUsIGlmIHdlJ3JlIG9uIHRoZSBzZXJ2ZXIsIGFuZCBpdCdzIG5vdCBhbHJlYWR5IHByZXNlbnQuCiAgdmFyIF8gPSByb290Ll87CiAgaWYgKCFfICYmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcpKSBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgb3IgRW5kZXIgb3ducyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSByb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXI7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgogIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CiAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgogIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgLy8gT3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvciB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8KICAvLyBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgogIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGg7CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsKICAgIHJldHVybjsKICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0pOwogICAgcmV0dXJuOwogICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSk7CiAgICByZXR1cm47CiAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgIHJldHVybjsKICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICB9CiAgfTsKCiAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAogIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKICAvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgogIC8vIHN1Y2Nlc3Npb24uCiAgLy8KICAvLyAgICAgdmFyIG9iamVjdCA9IHt9OwogIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7CiAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwogIC8vICAgICBvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CiAgLy8KICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoKICAgIC8vIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgb3IgYW4gZXZlbnRzIG1hcCwKICAgIC8vIHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8KICAgIC8vIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgbGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSB8fCAodGhpcy5fZXZlbnRzW25hbWVdID0gW10pOwogICAgICBsaXN0LnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgZXZlbnRzIHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgJiYgY2FsbGJhY2spKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9KTsKICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgbGlzdCwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAobGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgZXZlbnRzID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gbGlzdC5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGxpc3Rbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICBldmVudHMucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSBldmVudHM7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBbiBpbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9uIG9mIGBvbmAuIFRlbGwgKnRoaXMqIG9iamVjdCB0byBsaXN0ZW4gdG8KICAgIC8vIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncyBsaXN0ZW5pbmcgdG8uCiAgICBsaXN0ZW5UbzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzIHx8ICh0aGlzLl9saXN0ZW5lcnMgPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuZXJJZCB8fCAob2JqLl9saXN0ZW5lcklkID0gXy51bmlxdWVJZCgnbCcpKTsKICAgICAgbGlzdGVuZXJzW2lkXSA9IG9iajsKICAgICAgb2JqLm9uKG5hbWUsIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JyA/IHRoaXMgOiBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuOwogICAgICBpZiAob2JqKSB7CiAgICAgICAgb2JqLm9mZihuYW1lLCB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcgPyB0aGlzIDogY2FsbGJhY2ssIHRoaXMpOwogICAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2spIGRlbGV0ZSBsaXN0ZW5lcnNbb2JqLl9saXN0ZW5lcklkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuZXJzKSB7CiAgICAgICAgICBsaXN0ZW5lcnNbaWRdLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHt9OwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH07CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsLCB3aXRoIGRlZmluZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGRlZmF1bHRzOwogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwogICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgewogICAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBkZWZhdWx0cyk7CiAgICB9CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcyBvbiB0aGUgb2JqZWN0LCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MKICAgIC8vIHlvdSBjaG9vc2UgdG8gc2lsZW5jZSBpdC4KICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHIsIGF0dHJzLCB1bnNldCwgY2hhbmdlcywgc2lsZW50LCBjaGFuZ2luZywgcHJldiwgY3VycmVudDsKICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoKICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBFeHRyYWN0IGF0dHJpYnV0ZXMgYW5kIG9wdGlvbnMuCiAgICAgIHVuc2V0ICAgICAgICAgICA9IG9wdGlvbnMudW5zZXQ7CiAgICAgIHNpbGVudCAgICAgICAgICA9IG9wdGlvbnMuc2lsZW50OwogICAgICBjaGFuZ2VzICAgICAgICAgPSBbXTsKICAgICAgY2hhbmdpbmcgICAgICAgID0gdGhpcy5fY2hhbmdpbmc7CiAgICAgIHRoaXMuX2NoYW5naW5nICA9IHRydWU7CgogICAgICBpZiAoIWNoYW5naW5nKSB7CiAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgICB9CiAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgogICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwoKICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKSBjaGFuZ2VzLnB1c2goYXR0cik7CiAgICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2F0dHJdID0gdmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwogICAgICAgIH0KICAgICAgICB1bnNldCA/IGRlbGV0ZSBjdXJyZW50W2F0dHJdIDogY3VycmVudFthdHRyXSA9IHZhbDsKICAgICAgfQoKICAgICAgLy8gVHJpZ2dlciBhbGwgcmVsZXZhbnQgYXR0cmlidXRlIGNoYW5nZXMuCiAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKSB0aGlzLl9wZW5kaW5nID0gdHJ1ZTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoYW5nZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgY2hhbmdlc1tpXSwgdGhpcywgY3VycmVudFtjaGFuZ2VzW2ldXSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4gYHVuc2V0YCBpcyBhIG5vb3AgaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4KICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2U7CiAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4KICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgLy8gYCJjaGFuZ2UiYCBldmVudC4KICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBzdWNjZXNzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAuCiAgICAgIGlmIChhdHRycyAmJiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMud2FpdCkgJiYgIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKICAgICAgLy8gRG8gbm90IHBlcnNpc3QgaW52YWxpZCBtb2RlbHMuCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB9CgogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIC8vIEZpbmlzaCBjb25maWd1cmluZyBhbmQgc2VuZGluZyB0aGUgQWpheCByZXF1ZXN0LgogICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykgb3B0aW9ucy5hdHRycyA9IGF0dHJzOwogICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3ModGhpcywgbnVsbCwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiAhdGhpcy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSh0aGlzLmF0dHJpYnV0ZXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGEgZ2VuZXJhbAogICAgLy8gYCJlcnJvciJgIGV2ZW50IGFuZCBjYWxsIHRoZSBlcnJvciBjYWxsYmFjaywgaWYgc3BlY2lmaWVkLgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwogICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIG9wdGlvbnMgfHwge30pOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBQcm92aWRlcyBhIHN0YW5kYXJkIGNvbGxlY3Rpb24gY2xhc3MgZm9yIG91ciBzZXRzIG9mIG1vZGVscywgb3JkZXJlZAogIC8vIG9yIHVub3JkZXJlZC4gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCiAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsKICAgIH0sCgogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBkb1NvcnQsIGFkZCwgYXQsIHNvcnQsIHNvcnRBdHRyOwogICAgICBhZGQgPSBbXTsKICAgICAgYXQgPSBvcHRpb25zLmF0OwogICAgICBzb3J0ID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT0gZmFsc2U7CiAgICAgIHNvcnRBdHRyID0gXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpID8gdGhpcy5jb21wYXJhdG9yIDogbnVsbDsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChhdHRycyA9IG1vZGVsc1tpXSwgb3B0aW9ucykpKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChtb2RlbCkpIHsKICAgICAgICAgIGlmIChvcHRpb25zLm1lcmdlKSB7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycyA9PT0gbW9kZWwgPyBtb2RlbC5hdHRyaWJ1dGVzIDogYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydCAmJiAhZG9Tb3J0ICYmIGV4aXN0aW5nLmhhc0NoYW5nZWQoc29ydEF0dHIpKSBkb1NvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIGlzIGEgbmV3IG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgYWRkYCBsaXN0LgogICAgICAgIGFkZC5wdXNoKG1vZGVsKTsKCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQoKICAgICAgLy8gU2VlIGlmIHNvcnRpbmcgaXMgbmVlZGVkLCB1cGRhdGUgYGxlbmd0aGAgYW5kIHNwbGljZSBpbiBuZXcgbW9kZWxzLgogICAgICBpZiAoYWRkLmxlbmd0aCkgewogICAgICAgIGlmIChzb3J0KSBkb1NvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IGFkZC5sZW5ndGg7CiAgICAgICAgaWYgKGF0ICE9IG51bGwpIHsKICAgICAgICAgIHNwbGljZS5hcHBseSh0aGlzLm1vZGVscywgW2F0LCAwXS5jb25jYXQoYWRkKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHB1c2guYXBwbHkodGhpcy5tb2RlbHMsIGFkZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBTaWxlbnRseSBzb3J0IHRoZSBjb2xsZWN0aW9uIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAoZG9Tb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgaWYgKG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgICBmb3IgKGkgPSAwLCBsID0gYWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIChtb2RlbCA9IGFkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGBzb3J0YCBpZiB0aGUgY29sbGVjdGlvbiB3YXMgc29ydGVkLgogICAgICBpZiAoZG9Tb3J0KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwogICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwogICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiB0aGlzLmxlbmd0aH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKGJlZ2luLCBlbmQpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzLnNsaWNlKGJlZ2luLCBlbmQpOwogICAgfSwKCiAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCiAgICBnZXQ6IGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICAgIHRoaXMuX2lkQXR0ciB8fCAodGhpcy5faWRBdHRyID0gdGhpcy5tb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGUpOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWQgfHwgb2JqLmNpZCB8fCBvYmpbdGhpcy5faWRBdHRyXSB8fCBvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YgYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIH0KICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBTbWFydGx5IHVwZGF0ZSBhIGNvbGxlY3Rpb24gd2l0aCBhIGNoYW5nZSBzZXQgb2YgbW9kZWxzLCBhZGRpbmcsCiAgICAvLyByZW1vdmluZywgYW5kIG1lcmdpbmcgYXMgbmVjZXNzYXJ5LgogICAgdXBkYXRlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHthZGQ6IHRydWUsIG1lcmdlOiB0cnVlLCByZW1vdmU6IHRydWV9LCBvcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIG1vZGVsLCBpLCBsLCBleGlzdGluZzsKICAgICAgdmFyIGFkZCA9IFtdLCByZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKCiAgICAgIC8vIEFsbG93IGEgc2luZ2xlIG1vZGVsIChvciBubyBhcmd1bWVudCkgdG8gYmUgcGFzc2VkLgogICAgICBpZiAoIV8uaXNBcnJheShtb2RlbHMpKSBtb2RlbHMgPSBtb2RlbHMgPyBbbW9kZWxzXSA6IFtdOwoKICAgICAgLy8gUHJveHkgdG8gYGFkZGAgZm9yIHRoaXMgY2FzZSwgbm8gbmVlZCB0byBpdGVyYXRlLi4uCiAgICAgIGlmIChvcHRpb25zLmFkZCAmJiAhb3B0aW9ucy5yZW1vdmUpIHJldHVybiB0aGlzLmFkZChtb2RlbHMsIG9wdGlvbnMpOwoKICAgICAgLy8gRGV0ZXJtaW5lIHdoaWNoIG1vZGVscyB0byBhZGQgYW5kIG1lcmdlLCBhbmQgd2hpY2ggdG8gcmVtb3ZlLgogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG1vZGVsID0gbW9kZWxzW2ldOwogICAgICAgIGV4aXN0aW5nID0gdGhpcy5nZXQobW9kZWwpOwogICAgICAgIGlmIChvcHRpb25zLnJlbW92ZSAmJiBleGlzdGluZykgbW9kZWxNYXBbZXhpc3RpbmcuY2lkXSA9IHRydWU7CiAgICAgICAgaWYgKChvcHRpb25zLmFkZCAmJiAhZXhpc3RpbmcpIHx8IChvcHRpb25zLm1lcmdlICYmIGV4aXN0aW5nKSkgewogICAgICAgICAgYWRkLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAob3B0aW9ucy5yZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBtb2RlbCA9IHRoaXMubW9kZWxzW2ldOwogICAgICAgICAgaWYgKCFtb2RlbE1hcFttb2RlbC5jaWRdKSByZW1vdmUucHVzaChtb2RlbCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBSZW1vdmUgbW9kZWxzIChpZiBhcHBsaWNhYmxlKSBiZWZvcmUgd2UgYWRkIGFuZCBtZXJnZSB0aGUgcmVzdC4KICAgICAgaWYgKHJlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHJlbW92ZSwgb3B0aW9ucyk7CiAgICAgIGlmIChhZGQubGVuZ3RoKSB0aGlzLmFkZChhZGQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHMuc2xpY2UoKTsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgaWYgKG1vZGVscykgdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHVwZGF0ZTogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHVwZGF0ZWAgbWV0aG9kIGluc3RlYWQgb2YgYHJlc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gb3B0aW9ucy51cGRhdGUgPyAndXBkYXRlJyA6ICdyZXNldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24gaXMgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBtb2RlbCBvciBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYWRkZWQgdG8gdGhpcyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgIHJldHVybiBhdHRyczsKICAgICAgfQogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byByZW1vdmUgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgc29ydGVkSW5kZXg6IGZ1bmN0aW9uIChtb2RlbCwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFsdWUgfHwgKHZhbHVlID0gdGhpcy5jb21wYXJhdG9yKTsKICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF8uc29ydGVkSW5kZXgodGhpcy5tb2RlbHMsIG1vZGVsLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICB9CgogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgQ29sbGVjdGlvbi4KICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnaW5kZXhPZicsICdzaHVmZmxlJywgJ2xhc3RJbmRleE9mJywKICAgICdpc0VtcHR5JywgJ2NoYWluJ107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknXTsKCiAgLy8gVXNlIGF0dHJpYnV0ZXMgaW5zdGVhZCBvZiBwcm9wZXJ0aWVzLgogIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSwgY29udGV4dCkgewogICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICB9OwogICAgICByZXR1cm4gX1ttZXRob2RdKHRoaXMubW9kZWxzLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICB9OwogIH0pOwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgXy5iaW5kKGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSB0aGlzLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgIHRoaXMudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgdGhpcywgbmFtZSwgYXJncyk7CiAgICAgIH0sIHRoaXMpKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCl7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXlwvXSspJzsKICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgcGFyYW1ldGVycy4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHJldHVybiByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIFVSTCBmcmFnbWVudHMuIElmIHRoZQogIC8vIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBgb25oYXNoY2hhbmdlYCwgZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgogICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQgYnJvd3NlciwKICAgICAgLy8gYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiAhdGhpcy5faGFzUHVzaFN0YXRlICYmICFhdFJvb3QpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgdGhpcy5sb2NhdGlvbi5zZWFyY2ggKyAnIycgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgIC8vIE9yIGlmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CiAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgdGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgewogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCArIGxvYy5zZWFyY2gpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKSB8fCB0aGlzLmxvYWRVcmwodGhpcy5nZXRIYXNoKCkpOwogICAgfSwKCiAgICAvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQogICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKICAgIC8vIHJldHVybnMgYGZhbHNlYC4KICAgIGxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50T3ZlcnJpZGUpIHsKICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnRPdmVycmlkZSk7CiAgICAgIHZhciBtYXRjaGVkID0gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBtYXRjaGVkOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiBvcHRpb25zfTsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKTsKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSByZXR1cm47CiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIGZyYWdtZW50OwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICB0aGlzLl9jb25maWd1cmUob3B0aW9ucyB8fCB7fSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJwogICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQogICAgLy8gICAgIH0KICAgIC8vCiAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgogICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCiAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkgdGhyb3cgbmV3IEVycm9yKCdNZXRob2QgIicgKyBldmVudHNba2V5XSArICciIGRvZXMgbm90IGV4aXN0Jyk7CiAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7CiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwogICAgICAgIG1ldGhvZCA9IF8uYmluZChtZXRob2QsIHRoaXMpOwogICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBzZWxlY3RvciwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgIH0sCgogICAgLy8gUGVyZm9ybXMgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbiBvZiBhIFZpZXcgd2l0aCBhIHNldCBvZiBvcHRpb25zLgogICAgLy8gS2V5cyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSosIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMpIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7CiAgICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfSwKCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsKICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHZhciAkZWwgPSBCYWNrYm9uZS4kKCc8JyArIF8ucmVzdWx0KHRoaXMsICd0YWdOYW1lJykgKyAnPicpLmF0dHIoYXR0cnMpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCgkZWwsIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuc3luYwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CgogICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQoKICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CgogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CgogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIH07CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgQmFja2JvbmUuYWpheCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07Cgp9KS5jYWxsKHRoaXMpOwovKgpDb3B5cmlnaHQgKGMpIDIwMTEtMjAxMyBAV2FsbWFydExhYnMKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvCmRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlCnJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vcgpzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUgpERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgo7OwooZnVuY3Rpb24oKSB7CgovKmdsb2JhbCBjbG9uZUluaGVyaXRWYXJzLCBjcmVhdGVJbmhlcml0VmFycywgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMgKi8KCi8vc3VwcG9ydCB6ZXB0by5mb3JFYWNoIG9uIGpRdWVyeQppZiAoISQuZm4uZm9yRWFjaCkgewogICQuZm4uZm9yRWFjaCA9IGZ1bmN0aW9uKGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAkLmZuLmVhY2guY2FsbCh0aGlzLCBmdW5jdGlvbihpbmRleCkgewogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQgfHwgdGhpcywgdGhpcywgaW5kZXgpOwogICAgfSk7CiAgfTsKfQoKdmFyIHZpZXdOYW1lQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctbmFtZScsCiAgICB2aWV3Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctY2lkJywKICAgIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdmlldy1oZWxwZXInOwoKLy92aWV3IGluc3RhbmNlcwp2YXIgdmlld3NJbmRleGVkQnlDaWQgPSB7fTsKCnZhciBUaG9yYXggPSB0aGlzLlRob3JheCA9IHsKICBWRVJTSU9OOiAnMi4wLjByYzEnLAogIHRlbXBsYXRlUGF0aFByZWZpeDogJycsCiAgdGVtcGxhdGVzOiB7fSwKICAvL3ZpZXcgY2xhc3NlcwogIFZpZXdzOiB7fSwKICAvL2NlcnRhaW4gZXJyb3IgcHJvbmUgcGllY2VzIG9mIGNvZGUgKG9uIEFuZHJvaWQgb25seSBpdCBzZWVtcykKICAvL2FyZSB3cmFwcGVkIGluIGEgdHJ5IGNhdGNoIGJsb2NrLCB0aGVuIHRyaWdnZXIgdGhpcyBoYW5kbGVyIGluCiAgLy90aGUgY2F0Y2gsIHdpdGggdGhlIG5hbWUgb2YgdGhlIGZ1bmN0aW9uIG9yIGV2ZW50IHRoYXQgd2FzCiAgLy90cnlpbmcgdG8gYmUgZXhlY3V0ZWQuIE92ZXJyaWRlIHRoaXMgd2l0aCBhIGN1c3RvbSBoYW5kbGVyCiAgLy90byBkZWJ1ZyAvIGxvZyAvIGV0YwogIG9uRXhjZXB0aW9uOiBmdW5jdGlvbihuYW1lLCBlcnIpIHsKICAgIHRocm93IGVycjsKICB9Cn07CgpUaG9yYXguVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqLmN0b3IpIHsKICAgICAgICBvYmouY3Rvci5jYWxsKHRoaXMsIHJlc3BvbnNlKTsKICAgICAgfQogICAgfSwgdGhpcyk7CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkID0ge307CiAgICB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWQgPSB7fTsKCiAgICAvLyBTZXR1cCBvYmplY3QgZXZlbnQgdHJhY2tpbmcKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgICB9KTsKCiAgICB2aWV3c0luZGV4ZWRCeUNpZFt0aGlzLmNpZF0gPSB0aGlzOwogICAgdGhpcy5jaGlsZHJlbiA9IHt9OwogICAgdGhpcy5fcmVuZGVyQ291bnQgPSAwOwoKICAgIC8vdGhpcy5vcHRpb25zIGlzIHJlbW92ZWQgaW4gVGhvcmF4LlZpZXcsIHdlIG1lcmdlIHBhc3NlZAogICAgLy9wcm9wZXJ0aWVzIGRpcmVjdGx5IHdpdGggdGhlIHZpZXcgYW5kIHRlbXBsYXRlIGNvbnRleHQKICAgIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMgfHwge30pOwoKICAgIC8vIFNldHVwIGhlbHBlcnMKICAgIGJpbmRIZWxwZXJzLmNhbGwodGhpcyk7CgogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iai5jb25maWd1cmUpIHsKICAgICAgICBvYmouY29uZmlndXJlLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH0sCgogIHNldEVsZW1lbnQgOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMubmFtZSAmJiB0aGlzLiRlbC5hdHRyKHZpZXdOYW1lQXR0cmlidXRlTmFtZSwgdGhpcy5uYW1lKTsKICAgIHRoaXMuJGVsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAoKICBfYWRkQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdID0gdmlldzsKICAgIGlmICghdmlldy5wYXJlbnQpIHsKICAgICAgdmlldy5wYXJlbnQgPSB0aGlzOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGlsZCcsIHZpZXcpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgX3JlbW92ZUNoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICBkZWxldGUgdGhpcy5jaGlsZHJlblt2aWV3LmNpZF07CiAgICB2aWV3LnBhcmVudCA9IG51bGw7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9KTsKICAgIF8uZWFjaCh0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWQsIHRoaXMudW5iaW5kRGF0YU9iamVjdCwgdGhpcyk7CiAgICB0aGlzLnRyaWdnZXIoJ2Rlc3Ryb3llZCcpOwogICAgZGVsZXRlIHZpZXdzSW5kZXhlZEJ5Q2lkW3RoaXMuY2lkXTsKICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgIGlmIChvcHRpb25zLmNoaWxkcmVuKSB7CiAgICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICAgIGlmICh0aGlzLnBhcmVudCkgewogICAgICB0aGlzLnBhcmVudC5fcmVtb3ZlQ2hpbGQodGhpcyk7CiAgICB9CiAgICB0aGlzLnJlbW92ZSgpOyAvLyBXaWxsIGNhbGwgc3RvcExpc3RlbmluZygpCiAgfSwKCiAgcmVuZGVyOiBmdW5jdGlvbihvdXRwdXQpIHsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IF8uZmlsdGVyKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7IHJldHVybiBjaGlsZC5faGVscGVyT3B0aW9uczsgfSk7CgogICAgdmFyIGNoaWxkcmVuID0ge307CiAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQsIGtleSkgewogICAgICBpZiAoIWNoaWxkLl9oZWxwZXJPcHRpb25zKSB7CiAgICAgICAgY2hpbGRyZW5ba2V5XSA9IGNoaWxkOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKCiAgICBpZiAoXy5pc1VuZGVmaW5lZChvdXRwdXQpIHx8ICghXy5pc0VsZW1lbnQob3V0cHV0KSAmJiAhVGhvcmF4LlV0aWwuaXMkKG91dHB1dCkgJiYgIShvdXRwdXQgJiYgb3V0cHV0LmVsKSAmJiAhXy5pc1N0cmluZyhvdXRwdXQpICYmICFfLmlzRnVuY3Rpb24ob3V0cHV0KSkpIHsKICAgICAgLy8gdHJ5IG9uZSBtb3JlIHRpbWUgdG8gYXNzaWduIHRoZSB0ZW1wbGF0ZSwgaWYgd2UgZG9uJ3QKICAgICAgLy8geWV0IGhhdmUgb25lIHdlIG11c3QgcmFpc2UKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAndGVtcGxhdGUnLCB7CiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgfSk7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy50ZW1wbGF0ZSk7CiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihvdXRwdXQpKSB7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUob3V0cHV0KTsKICAgIH0KCiAgICAvLyBEZXN0cm95IGFueSBoZWxwZXJzIHRoYXQgbWF5IGJlIGxpbmdlcmluZwogICAgXy5lYWNoKHRoaXMuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICBjaGlsZC5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IHVuZGVmaW5lZDsKCiAgICAvL2FjY2VwdCBhIHZpZXcsIHN0cmluZywgSGFuZGxlYmFycy5TYWZlU3RyaW5nIG9yIERPTSBlbGVtZW50CiAgICB0aGlzLmh0bWwoKG91dHB1dCAmJiBvdXRwdXQuZWwpIHx8IChvdXRwdXQgJiYgb3V0cHV0LnN0cmluZykgfHwgb3V0cHV0KTsKICAgICsrdGhpcy5fcmVuZGVyQ291bnQ7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkJyk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0sCgogIGNvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLmF0dHJpYnV0ZXMpIHx8IHt9KTsKICB9LAoKICBfZ2V0Q29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy5leHRlbmQoe30sIHRoaXMsIGdldFZhbHVlKHRoaXMsICdjb250ZXh0JykgfHwge30pOwogIH0sCgogIC8vIFByaXZhdGUgdmFyaWFibGVzIGluIGhhbmRsZWJhcnMgLyBvcHRpb25zLmRhdGEgaW4gdGVtcGxhdGUgaGVscGVycwogIF9nZXREYXRhOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gewogICAgICB2aWV3OiB0aGlzLAogICAgICBjaWQ6IF8udW5pcXVlSWQoJ3QnKSwKICAgICAgeWllbGQ6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIGZuIGlzIHNlZWRlZCBieSB0ZW1wbGF0ZSBoZWxwZXIgcGFzc2luZyBjb250ZXh0IHRvIGRhdGEKICAgICAgICByZXR1cm4gZGF0YS5mbiAmJiBkYXRhLmZuKGRhdGEpOwogICAgICB9CiAgICB9OwogIH0sCgogIF9nZXRIZWxwZXJzOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmhlbHBlcnMpIHsKICAgICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCBIYW5kbGViYXJzLmhlbHBlcnMsIHRoaXMuaGVscGVycyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzOwogICAgfQoKICB9LAoKICByZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgY29udGV4dCwgaWdub3JlRXJyb3JzKSB7CiAgICB2YXIgdGVtcGxhdGU7CiAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzLl9nZXRDb250ZXh0KCk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGZpbGUpKSB7CiAgICAgIHRlbXBsYXRlID0gZmlsZTsKICAgIH0gZWxzZSB7CiAgICAgIHRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUoZmlsZSwgaWdub3JlRXJyb3JzKTsKICAgIH0KICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgcmV0dXJuICcnOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRlbXBsYXRlKGNvbnRleHQsIHsKICAgICAgICBoZWxwZXJzOiB0aGlzLl9nZXRIZWxwZXJzKCksCiAgICAgICAgZGF0YTogdGhpcy5fZ2V0RGF0YShjb250ZXh0KQogICAgICB9KTsKICAgIH0KICB9LAoKICBlbnN1cmVSZW5kZXJlZDogZnVuY3Rpb24oKSB7CiAgICAhdGhpcy5fcmVuZGVyQ291bnQgJiYgdGhpcy5yZW5kZXIoKTsKICB9LAoKICBhcHBlbmRUbzogZnVuY3Rpb24oZWwpIHsKICAgIHRoaXMuZW5zdXJlUmVuZGVyZWQoKTsKICAgICQoZWwpLmFwcGVuZCh0aGlzLmVsKTsKICAgIHRoaXMudHJpZ2dlcigncmVhZHknLCB7dGFyZ2V0OiB0aGlzfSk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oaHRtbCkgewogICAgaWYgKF8uaXNVbmRlZmluZWQoaHRtbCkpIHsKICAgICAgcmV0dXJuIHRoaXMuZWwuaW5uZXJIVE1MOwogICAgfSBlbHNlIHsKICAgICAgLy8gRXZlbnQgZm9yIElFIGVsZW1lbnQgZml4ZXMKICAgICAgdGhpcy50cmlnZ2VyKCdiZWZvcmU6YXBwZW5kJyk7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fcmVwbGFjZUhUTUwoaHRtbCk7CiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfQogIH0sCgogIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oaHRtbCkgewogICAgdGhpcy5lbC5pbm5lckhUTUwgPSAiIjsKICAgIHJldHVybiB0aGlzLiRlbC5hcHBlbmQoaHRtbCk7CiAgfSwKCiAgX2FuY2hvckNsaWNrOiBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHRhcmdldCA9ICQoZXZlbnQuY3VycmVudFRhcmdldCksCiAgICAgICAgaHJlZiA9IHRhcmdldC5hdHRyKCdocmVmJyk7CiAgICAvLyBSb3V0ZSBhbnl0aGluZyB0aGF0IHN0YXJ0cyB3aXRoICMgb3IgLyAoZXhjbHVkaW5nIC8vZG9tYWluIHVybHMpCiAgICBpZiAoaHJlZiAmJiAoaHJlZlswXSA9PT0gJyMnIHx8IChocmVmWzBdID09PSAnLycgJiYgaHJlZlsxXSAhPT0gJy8nKSkpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShocmVmLCB7CiAgICAgICAgdHJpZ2dlcjogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9KTsKClRob3JheC5WaWV3LmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwoKICB2YXIgY2hpbGQgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGNoaWxkLl9fcGFyZW50X18gPSB0aGlzOwoKICByZXNldEluaGVyaXRWYXJzKGNoaWxkKTsKCiAgcmV0dXJuIGNoaWxkOwp9OwoKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5WaWV3LCBUaG9yYXguVmlld3MpOwoKZnVuY3Rpb24gYmluZEhlbHBlcnMoKSB7CiAgaWYgKHRoaXMuaGVscGVycykgewogICAgXy5lYWNoKHRoaXMuaGVscGVycywgZnVuY3Rpb24oaGVscGVyLCBuYW1lKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpczsKICAgICAgdGhpcy5oZWxwZXJzW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgb3B0aW9ucyA9IF8ubGFzdChhcmdzKTsKICAgICAgICBvcHRpb25zLmNvbnRleHQgPSB0aGlzOwogICAgICAgIHJldHVybiBoZWxwZXIuYXBwbHkodmlldywgYXJncyk7CiAgICAgIH07CiAgICB9LCB0aGlzKTsKICB9Cn0KCi8vJChzZWxlY3RvcikudmlldygpIGhlbHBlcgokLmZuLnZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwgewogICAgaGVscGVyOiB0cnVlCiAgfSk7CiAgdmFyIHNlbGVjdG9yID0gJ1snICsgdmlld0NpZEF0dHJpYnV0ZU5hbWUgKyAnXSc7CiAgaWYgKCFvcHRpb25zLmhlbHBlcikgewogICAgc2VsZWN0b3IgKz0gJzpub3QoWycgKyB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSArICddKSc7CiAgfQogIHZhciBlbCA9ICQodGhpcykuY2xvc2VzdChzZWxlY3Rvcik7CiAgcmV0dXJuIChlbCAmJiB2aWV3c0luZGV4ZWRCeUNpZFtlbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lKV0pIHx8IGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyOnRydWUsIGNsb25lRXZlbnRzOiB0cnVlICovCmZ1bmN0aW9uIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihrbGFzcywgaGFzaCkgewogIHZhciAkc3VwZXIgPSBrbGFzcy5leHRlbmQ7CiAga2xhc3MuZXh0ZW5kID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgY2hpbGQgPSAkc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChjaGlsZC5wcm90b3R5cGUubmFtZSkgewogICAgICBoYXNoW2NoaWxkLnByb3RvdHlwZS5uYW1lXSA9IGNoaWxkOwogICAgfQogICAgcmV0dXJuIGNoaWxkOwogIH07Cn0KCmZ1bmN0aW9uIHJlZ2lzdHJ5R2V0KG9iamVjdCwgdHlwZSwgbmFtZSwgaWdub3JlRXJyb3JzKSB7CiAgdmFyIHRhcmdldCA9IG9iamVjdFt0eXBlXSwKICAgICAgdmFsdWU7CiAgaWYgKG5hbWUuaW5kZXhPZignLicpID49IDApIHsKICAgIHZhciBiaXRzID0gbmFtZS5zcGxpdCgvXC4vKTsKICAgIG5hbWUgPSBiaXRzLnBvcCgpOwogICAgXy5lYWNoKGJpdHMsIGZ1bmN0aW9uKGtleSkgewogICAgICB0YXJnZXQgPSB0YXJnZXRba2V5XTsKICAgIH0pOwogIH0KICB0YXJnZXQgJiYgKHZhbHVlID0gdGFyZ2V0W25hbWVdKTsKICBpZiAoIXZhbHVlICYmICFpZ25vcmVFcnJvcnMpIHsKICAgIHRocm93IG5ldyBFcnJvcih0eXBlICsgJzogJyArIG5hbWUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQp9CgpmdW5jdGlvbiBhc3NpZ25UZW1wbGF0ZShhdHRyaWJ1dGVOYW1lLCBvcHRpb25zKSB7CiAgdmFyIHRlbXBsYXRlOwogIC8vIGlmIGF0dHJpYnV0ZSBpcyB0aGUgbmFtZSBvZiB0ZW1wbGF0ZSB0byBmZXRjaAogIGlmIChfLmlzU3RyaW5nKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXNbYXR0cmlidXRlTmFtZV0sIHRydWUpOwogIC8vIGVsc2UgdHJ5IGFuZCBmZXRjaCB0aGUgdGVtcGxhdGUgYmFzZWQgb24gdGhlIG5hbWUKICB9IGVsc2UgaWYgKHRoaXMubmFtZSAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMubmFtZSArIChvcHRpb25zLmV4dGVuc2lvbiB8fCAnJyksIHRydWUpOwogIH0KICAvLyBDb2xsZWN0aW9uVmlldyBhbmQgTGF5b3V0VmlldyBoYXZlIGEgZGVmYXVsdFRlbXBsYXRlIHRoYXQgbWF5IGJlIHVzZWQgaWYgbm9uZQogIC8vIHdhcyBmb3VuZCwgcmVndWxhciB2aWV3cyBtdXN0IGhhdmUgYSB0ZW1wbGF0ZSBpZiByZW5kZXIoKSBpcyBjYWxsZWQKICBpZiAoIXRlbXBsYXRlICYmIGF0dHJpYnV0ZU5hbWUgPT09ICd0ZW1wbGF0ZScgJiYgdGhpcy5fZGVmYXVsdFRlbXBsYXRlKSB7CiAgICB0ZW1wbGF0ZSA9IHRoaXMuX2RlZmF1bHRUZW1wbGF0ZTsKICB9CiAgLy8gaWYgd2UgZm91bmQgc29tZXRoaW5nLCBhc3NpZ24gaXQKICBpZiAodGVtcGxhdGUgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGhpc1thdHRyaWJ1dGVOYW1lXSA9IHRlbXBsYXRlOwogIH0KICAvLyBpZiBub3RoaW5nIHdhcyBmb3VuZCBhbmQgaXQncyByZXF1aXJlZCwgdGhyb3cKICBpZiAob3B0aW9ucy5yZXF1aXJlZCAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZpZXcgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJyByZXF1aXJlczogJyArIGF0dHJpYnV0ZU5hbWUpOwogIH0KfQoKLy8gZ2V0VmFsdWUgaXMgdXNlZCBpbnN0ZWFkIG9mIF8ucmVzdWx0IGJlY2F1c2Ugd2UKLy8gbmVlZCBhbiBleHRyYSBzY29wZSBwYXJhbWV0ZXIsIGFuZCB3aWxsIG1pbmlmeQovLyBiZXR0ZXIgdGhhbiBfLnJlc3VsdApmdW5jdGlvbiBnZXRWYWx1ZShvYmplY3QsIHByb3AsIHNjb3BlKSB7CiAgaWYgKCEob2JqZWN0ICYmIG9iamVjdFtwcm9wXSkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gXy5pc0Z1bmN0aW9uKG9iamVjdFtwcm9wXSkKICAgID8gb2JqZWN0W3Byb3BdLmNhbGwoc2NvcGUgfHwgb2JqZWN0KQogICAgOiBvYmplY3RbcHJvcF07Cn0KCnZhciBpbmhlcml0VmFycyA9IHt9OwpmdW5jdGlvbiBjcmVhdGVJbmhlcml0VmFycyhzZWxmKSB7CiAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBvdXIgc3RhdGljIGV2ZW50IG9iamVjdHMKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFzZWxmW29iai5uYW1lXSkgewogICAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIHJlc2V0SW5oZXJpdFZhcnMoc2VsZikgewogIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgb3VyIHN0YXRpYyBldmVudCBvYmplY3RzCiAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgfSk7Cn0KZnVuY3Rpb24gd2Fsa0luaGVyaXRUcmVlKHNvdXJjZSwgZmllbGROYW1lLCBpc1N0YXRpYywgY2FsbGJhY2spIHsKICB2YXIgdHJlZSA9IFtdOwogIGlmIChfLmhhcyhzb3VyY2UsIGZpZWxkTmFtZSkpIHsKICAgIHRyZWUucHVzaChzb3VyY2UpOwogIH0KICB2YXIgaXRlcmF0ZSA9IHNvdXJjZTsKICBpZiAoaXNTdGF0aWMpIHsKICAgIHdoaWxlIChpdGVyYXRlID0gaXRlcmF0ZS5fX3BhcmVudF9fKSB7CiAgICAgIGlmIChfLmhhcyhpdGVyYXRlLCBmaWVsZE5hbWUpKSB7CiAgICAgICAgdHJlZS5wdXNoKGl0ZXJhdGUpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGl0ZXJhdGUgPSBpdGVyYXRlLmNvbnN0cnVjdG9yOwogICAgd2hpbGUgKGl0ZXJhdGUpIHsKICAgICAgaWYgKGl0ZXJhdGUucHJvdG90eXBlICYmIF8uaGFzKGl0ZXJhdGUucHJvdG90eXBlLCBmaWVsZE5hbWUpKSB7CiAgICAgICAgdHJlZS5wdXNoKGl0ZXJhdGUucHJvdG90eXBlKTsKICAgICAgfQogICAgICBpdGVyYXRlID0gaXRlcmF0ZS5fX3N1cGVyX18gJiYgaXRlcmF0ZS5fX3N1cGVyX18uY29uc3RydWN0b3I7CiAgICB9CiAgfQoKICB2YXIgaSA9IHRyZWUubGVuZ3RoOwogIHdoaWxlIChpLS0pIHsKICAgIF8uZWFjaChnZXRWYWx1ZSh0cmVlW2ldLCBmaWVsZE5hbWUsIHNvdXJjZSksIGNhbGxiYWNrKTsKICB9Cn0KCmZ1bmN0aW9uIG9iamVjdEV2ZW50cyh0YXJnZXQsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAoXy5pc09iamVjdChjYWxsYmFjaykpIHsKICAgIHZhciBzcGVjID0gaW5oZXJpdFZhcnNbZXZlbnROYW1lXTsKICAgIGlmIChzcGVjICYmIHNwZWMuZXZlbnQpIHsKICAgICAgYWRkRXZlbnRzKHRhcmdldFsnXycgKyBldmVudE5hbWUgKyAnRXZlbnRzJ10sIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGFkZEV2ZW50cyh0YXJnZXQsIHNvdXJjZSwgY29udGV4dCkgewogIF8uZWFjaChzb3VyY2UsIGZ1bmN0aW9uKGNhbGxiYWNrLCBldmVudE5hbWUpIHsKICAgIGlmIChfLmlzQXJyYXkoY2FsbGJhY2spKSB7CiAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICB0YXJnZXQucHVzaChbZXZlbnROYW1lLCBjYiwgY29udGV4dF0pOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcmdldC5wdXNoKFtldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0XSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpIHsKICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuZGF0YSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdIYW5kbGViYXJzIHRlbXBsYXRlIGNvbXBpbGVkIHdpdGhvdXQgZGF0YSwgdXNlOiBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGUsIHtkYXRhOiB0cnVlfSknKTsKICB9CiAgcmV0dXJuIG9wdGlvbnMuZGF0YTsKfQoKLy8gVGhlc2Ugd2hpdGVsaXN0ZWQgYXR0cmlidXRlcyB3aWxsIGJlIHRoZSBvbmx5IG9uZXMgcGFzc2VkCi8vIGZyb20gdGhlIG9wdGlvbnMgaGFzaCB0byBUaG9yYXguVXRpbC50YWcKdmFyIGh0bWxBdHRyaWJ1dGVzVG9Db3B5ID0gWydpZCcsICdjbGFzc05hbWUnLCAndGFnTmFtZSddOwoKLy8gSW4gaGVscGVycyAidGFnTmFtZSIgb3IgInRhZyIgbWF5IGJlIHNwZWNpZmllZCwgYXMgd2VsbAovLyBhcyAiY2xhc3MiIG9yICJjbGFzc05hbWUiLiBOb3JtYWxpemUgdG8gInRhZ05hbWUiIGFuZAovLyAiY2xhc3NOYW1lIiB0byBtYXRjaCB0aGUgcHJvcGVydHkgbmFtZXMgdXNlZCBieSBCYWNrYm9uZQovLyBqUXVlcnksIGV0Yy4gU3BlY2lhbCBjYXNlIGZvciAiY2xhc3NOYW1lIiBpbgovLyBUaG9yYXguVXRpbC50YWc6IHdpbGwgYmUgcmV3cml0dGVuIGFzICJjbGFzcyIgaW4KLy8gZ2VuZXJhdGVkIEhUTUwuCmZ1bmN0aW9uIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy50YWcpIHsKICAgIG9wdGlvbnMudGFnTmFtZSA9IG9wdGlvbnMudGFnOwogICAgZGVsZXRlIG9wdGlvbnMudGFnOwogIH0KICBpZiAob3B0aW9uc1snY2xhc3MnXSkgewogICAgb3B0aW9ucy5jbGFzc05hbWUgPSBvcHRpb25zWydjbGFzcyddOwogICAgZGVsZXRlIG9wdGlvbnNbJ2NsYXNzJ107CiAgfQp9CgpUaG9yYXguVXRpbCA9IHsKICBnZXRWaWV3SW5zdGFuY2U6IGZ1bmN0aW9uKG5hbWUsIGF0dHJpYnV0ZXMpIHsKICAgIGF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgaWYgKF8uaXNTdHJpbmcobmFtZSkpIHsKICAgICAgdmFyIEtsYXNzID0gcmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCBuYW1lLCBmYWxzZSk7CiAgICAgIHJldHVybiBLbGFzcy5jaWQgPyBfLmV4dGVuZChLbGFzcywgYXR0cmlidXRlcyB8fCB7fSkgOiBuZXcgS2xhc3MoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICByZXR1cm4gbmV3IG5hbWUoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9LAoKICBnZXRUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgaWdub3JlRXJyb3JzKSB7CiAgICAvL2FwcGVuZCB0aGUgdGVtcGxhdGUgcGF0aCBwcmVmaXggaWYgaXQgaXMgbWlzc2luZwogICAgdmFyIHBhdGhQcmVmaXggPSBUaG9yYXgudGVtcGxhdGVQYXRoUHJlZml4LAogICAgICAgIHRlbXBsYXRlOwogICAgaWYgKHBhdGhQcmVmaXggJiYgZmlsZS5zdWJzdHIoMCwgcGF0aFByZWZpeC5sZW5ndGgpICE9PSBwYXRoUHJlZml4KSB7CiAgICAgIGZpbGUgPSBwYXRoUHJlZml4ICsgZmlsZTsKICAgIH0KCiAgICAvLyBXaXRob3V0IGV4dGVuc2lvbgogICAgZmlsZSA9IGZpbGUucmVwbGFjZSgvXC5oYW5kbGViYXJzJC8sICcnKTsKICAgIHRlbXBsYXRlID0gVGhvcmF4LnRlbXBsYXRlc1tmaWxlXTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgLy8gV2l0aCBleHRlbnNpb24KICAgICAgZmlsZSA9IGZpbGUgKyAnLmhhbmRsZWJhcnMnOwogICAgICB0ZW1wbGF0ZSA9IFRob3JheC50ZW1wbGF0ZXNbZmlsZV07CiAgICB9CgogICAgaWYgKCF0ZW1wbGF0ZSAmJiAhaWdub3JlRXJyb3JzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGVzOiAnICsgZmlsZSArICcgZG9lcyBub3QgZXhpc3QuJyk7CiAgICB9CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfSwKCiAgLy8nc2VsZWN0b3InIGlzIG5vdCBwcmVzZW50IGluICQoJzxwPjwvcD4nKQogIC8vVE9ETzogaW52ZXN0aWdhZ2UgYSBiZXR0ZXIgZGV0ZWN0aW9uIG1ldGhvZAogIGlzJDogZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc09iamVjdChvYmopICYmICgnbGVuZ3RoJyBpbiBvYmopOwogIH0sCiAgZXhwYW5kVG9rZW46IGZ1bmN0aW9uKGlucHV0LCBzY29wZSkgewogICAgaWYgKGlucHV0ICYmIGlucHV0LmluZGV4T2YgJiYgaW5wdXQuaW5kZXhPZigne3snKSA+PSAwKSB7CiAgICAgIHZhciByZSA9IC8oPzpcez9bXntdKyl8KD86XHtceyhbXn1dKylcfVx9KS9nLAogICAgICAgICAgbWF0Y2gsCiAgICAgICAgICByZXQgPSBbXTsKICAgICAgZnVuY3Rpb24gZGVyZWYodG9rZW4sIHNjb3BlKSB7CiAgICAgICAgaWYgKHRva2VuLm1hdGNoKC9eKCJ8JykvKSAmJiB0b2tlbi5tYXRjaCgvKCJ8JykkLykpIHsKICAgICAgICAgIHJldHVybiB0b2tlbi5yZXBsYWNlKC8oXigifCcpfCgnfCIpJCkvZywgJycpOwogICAgICAgIH0KICAgICAgICB2YXIgc2VnbWVudHMgPSB0b2tlbi5zcGxpdCgnLicpLAogICAgICAgICAgICBsZW4gPSBzZWdtZW50cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNjb3BlICYmIGkgPCBsZW47IGkrKykgewogICAgICAgICAgaWYgKHNlZ21lbnRzW2ldICE9PSAndGhpcycpIHsKICAgICAgICAgICAgc2NvcGUgPSBzY29wZVtzZWdtZW50c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzY29wZTsKICAgICAgfQogICAgICB3aGlsZSAobWF0Y2ggPSByZS5leGVjKGlucHV0KSkgewogICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgdmFyIHBhcmFtcyA9IG1hdGNoWzFdLnNwbGl0KC9ccysvKTsKICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgaGVscGVyID0gcGFyYW1zLnNoaWZ0KCk7CiAgICAgICAgICAgIHBhcmFtcyA9IF8ubWFwKHBhcmFtcywgZnVuY3Rpb24ocGFyYW0pIHsgcmV0dXJuIGRlcmVmKHBhcmFtLCBzY29wZSk7IH0pOwogICAgICAgICAgICBpZiAoSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0pIHsKICAgICAgICAgICAgICByZXQucHVzaChIYW5kbGViYXJzLmhlbHBlcnNbaGVscGVyXS5hcHBseShzY29wZSwgcGFyYW1zKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhlIGhlbHBlciBpcyBub3QgZGVmaW5lZCBkbyBub3RoaW5nCiAgICAgICAgICAgICAgcmV0LnB1c2gobWF0Y2hbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXQucHVzaChkZXJlZihwYXJhbXNbMF0sIHNjb3BlKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5wdXQgPSByZXQuam9pbignJyk7CiAgICB9CiAgICByZXR1cm4gaW5wdXQ7CiAgfSwKICB0YWc6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIGNvbnRlbnQsIHNjb3BlKSB7CiAgICB2YXIgaHRtbEF0dHJpYnV0ZXMgPSBfLm9taXQoYXR0cmlidXRlcywgJ3RhZ05hbWUnKSwKICAgICAgICB0YWcgPSBhdHRyaWJ1dGVzLnRhZ05hbWUgfHwgJ2Rpdic7CiAgICByZXR1cm4gJzwnICsgdGFnICsgJyAnICsgXy5tYXAoaHRtbEF0dHJpYnV0ZXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKF8uaXNVbmRlZmluZWQodmFsdWUpIHx8IGtleSA9PT0gJ2V4cGFuZC10b2tlbnMnKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICAgIHZhciBmb3JtYXR0ZWRWYWx1ZSA9IHZhbHVlOwogICAgICBpZiAoc2NvcGUpIHsKICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHZhbHVlLCBzY29wZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIChrZXkgPT09ICdjbGFzc05hbWUnID8gJ2NsYXNzJyA6IGtleSkgKyAnPSInICsgSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uKGZvcm1hdHRlZFZhbHVlKSArICciJzsKICAgIH0pLmpvaW4oJyAnKSArICc+JyArIChfLmlzVW5kZWZpbmVkKGNvbnRlbnQpID8gJycgOiBjb250ZW50KSArICc8LycgKyB0YWcgKyAnPic7CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzICovClRob3JheC5NaXhpbnMgPSB7fTsKCmluaGVyaXRWYXJzLm1peGlucyA9IHsKICBuYW1lOiAnbWl4aW5zJywKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgXy5lYWNoKHRoaXMuY29uc3RydWN0b3IubWl4aW5zLCB0aGlzLm1peGluLCB0aGlzKTsKICAgIF8uZWFjaCh0aGlzLm1peGlucywgdGhpcy5taXhpbiwgdGhpcyk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBtaXhpbjogZnVuY3Rpb24obWl4aW4pIHsKICAgIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwogICAgdGhpcy5taXhpbnMucHVzaChtaXhpbik7CiAgfSwKICByZWdpc3Rlck1peGluOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgbWV0aG9kcykgewogICAgVGhvcmF4Lk1peGluc1tuYW1lXSA9IFtjYWxsYmFjaywgbWV0aG9kc107CiAgfQp9KTsKClRob3JheC5WaWV3LnByb3RvdHlwZS5taXhpbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICBpZiAoIXRoaXMuX2FwcGxpZWRNaXhpbnMpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMgPSBbXTsKICB9CiAgaWYgKHRoaXMuX2FwcGxpZWRNaXhpbnMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMucHVzaChuYW1lKTsKICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgbmFtZS5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG1peGluID0gVGhvcmF4Lk1peGluc1tuYW1lXTsKICAgICAgXy5leHRlbmQodGhpcywgbWl4aW5bMV0pOwogICAgICAvL21peGluIGNhbGxiYWNrIG1heSBiZSBhbiBhcnJheSBvZiBbY2FsbGJhY2ssIGFyZ3VtZW50c10KICAgICAgaWYgKF8uaXNBcnJheShtaXhpblswXSkpIHsKICAgICAgICBtaXhpblswXVswXS5hcHBseSh0aGlzLCBtaXhpblswXVsxXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWl4aW5bMF0uYXBwbHkodGhpcywgXy50b0FycmF5KGFyZ3VtZW50cykuc2xpY2UoMSkpOwogICAgICB9CiAgICB9CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzLCBvYmplY3RFdmVudHMsIHdhbGtJbmhlcml0VHJlZSAqLwovLyBTYXZlIGEgY29weSBvZiB0aGUgX29uIG1ldGhvZCB0byBjYWxsIGFzIGEgJHN1cGVyIG1ldGhvZAp2YXIgX29uID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLm9uOwoKaW5oZXJpdFZhcnMuZXZlbnQgPSB7CiAgbmFtZTogJ19ldmVudHMnLAoKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgd2Fsa0luaGVyaXRUcmVlKHRoaXMuY29uc3RydWN0b3IsICdfZXZlbnRzJywgdHJ1ZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgc2VsZi5vbi5hcHBseShzZWxmLCBldmVudCk7CiAgICB9KTsKICAgIHdhbGtJbmhlcml0VHJlZSh0aGlzLCAnZXZlbnRzJywgZmFsc2UsIGZ1bmN0aW9uKGhhbmRsZXIsIGV2ZW50TmFtZSkgewogICAgICBzZWxmLm9uKGV2ZW50TmFtZSwgaGFuZGxlciwgc2VsZik7CiAgICB9KTsKICB9Cn07CgpfLmV4dGVuZChUaG9yYXguVmlldywgewogIG9uOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKCiAgICBpZiAob2JqZWN0RXZlbnRzKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2spKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBoYW5kbGVyfSkKICAgIGlmIChfLmlzT2JqZWN0KGV2ZW50TmFtZSkpIHsKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSk7CiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IFtoYW5kbGVyLCBoYW5kbGVyXX0pCiAgICAgIGlmIChfLmlzQXJyYXkoY2FsbGJhY2spKSB7CiAgICAgICAgXy5lYWNoKGNhbGxiYWNrLCBmdW5jdGlvbihjYikgewogICAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2JdKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgaGFuZGxlcikKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMucHVzaChbZXZlbnROYW1lLCBjYWxsYmFja10pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9Cn0pOwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgb246IGZ1bmN0aW9uKGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgIGlmIChvYmplY3RFdmVudHModGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgaWYgKF8uaXNPYmplY3QoZXZlbnROYW1lKSAmJiBhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICAvL2FjY2VwdCBvbih7InJlbmRlcmVkIjogY2FsbGJhY2t9KQogICAgICBfLmVhY2goZXZlbnROYW1lLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgdGhpcy5vbihrZXksIHZhbHVlLCBjYWxsYmFjayB8fCB0aGlzKTsgICAgLy8gY2FsbGJhY2sgaXMgY29udGV4dCBpbiB0aGlzIGZvcm0gb2YgdGhlIGNhbGwKICAgICAgfSwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICAvL2FjY2VwdCBvbigicmVuZGVyZWQiLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgLy9hY2NlcHQgb24oImNsaWNrIGEiLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgXy5lYWNoKChfLmlzQXJyYXkoY2FsbGJhY2spID8gY2FsbGJhY2sgOiBbY2FsbGJhY2tdKSwgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YXIgcGFyYW1zID0gZXZlbnRQYXJhbXNGcm9tRXZlbnRJdGVtLmNhbGwodGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCB8fCB0aGlzKTsKICAgICAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdET00nKSB7CiAgICAgICAgICAvL3dpbGwgY2FsbCBfYWRkRXZlbnQgZHVyaW5nIGRlbGVnYXRlRXZlbnRzKCkKICAgICAgICAgIGlmICghdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSkgewogICAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlID0gW107CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlLnB1c2gocGFyYW1zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fYWRkRXZlbnQocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgIGlmIChldmVudHMpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihldmVudHMpKSB7CiAgICAgICAgZXZlbnRzID0gZXZlbnRzLmNhbGwodGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICB0aGlzLm9uKGV2ZW50cyk7CiAgICB9CiAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlICYmIF8uZWFjaCh0aGlzLl9ldmVudHNUb0RlbGVnYXRlLCB0aGlzLl9hZGRFdmVudCwgdGhpcyk7CiAgfSwKICAvL3BhcmFtcyBtYXkgY29udGFpbjoKICAvLy0gbmFtZQogIC8vLSBvcmlnaW5hbE5hbWUKICAvLy0gc2VsZWN0b3IKICAvLy0gdHlwZSAidmlldyIgfHwgIkRPTSIKICAvLy0gaGFuZGxlcgogIF9hZGRFdmVudDogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICBpZiAocGFyYW1zLnR5cGUgPT09ICd2aWV3JykgewogICAgICBfLmVhY2gocGFyYW1zLm5hbWUuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgX29uLmNhbGwodGhpcywgbmFtZSwgYmluZEV2ZW50SGFuZGxlci5jYWxsKHRoaXMsICd2aWV3LWV2ZW50OicsIHBhcmFtcykpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBib3VuZEhhbmRsZXIgPSBiaW5kRXZlbnRIYW5kbGVyLmNhbGwodGhpcywgJ2RvbS1ldmVudDonLCBwYXJhbXMpOwogICAgICBpZiAoIXBhcmFtcy5uZXN0ZWQpIHsKICAgICAgICBib3VuZEhhbmRsZXIgPSBjb250YWluSGFuZGxlclRvQ3VyZW50Vmlldyhib3VuZEhhbmRsZXIsIHRoaXMuY2lkKTsKICAgICAgfQogICAgICBpZiAocGFyYW1zLnNlbGVjdG9yKSB7CiAgICAgICAgdmFyIG5hbWUgPSBwYXJhbXMubmFtZSArICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgdGhpcy4kZWwub24obmFtZSwgcGFyYW1zLnNlbGVjdG9yLCBib3VuZEhhbmRsZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJGVsLm9uKHBhcmFtcy5uYW1lLCBib3VuZEhhbmRsZXIpOwogICAgICB9CiAgICB9CiAgfQp9KTsKCi8vIFdoZW4gdmlldyBpcyByZWFkeSB0cmlnZ2VyIHJlYWR5IGV2ZW50IG9uIGFsbAovLyBjaGlsZHJlbiB0aGF0IGFyZSBwcmVzZW50LCB0aGVuIHJlZ2lzdGVyIGFuCi8vIGV2ZW50IHRoYXQgd2lsbCB0cmlnZ2VyIHJlYWR5IG9uIG5ldyBjaGlsZHJlbgovLyB3aGVuIHRoZXkgYXJlIGFkZGVkClRob3JheC5WaWV3Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAoIXRoaXMuX2lzUmVhZHkpIHsKICAgIHRoaXMuX2lzUmVhZHkgPSB0cnVlOwogICAgZnVuY3Rpb24gdHJpZ2dlclJlYWR5T25DaGlsZChjaGlsZCkgewogICAgICBjaGlsZC50cmlnZ2VyKCdyZWFkeScsIG9wdGlvbnMpOwogICAgfQogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIHRyaWdnZXJSZWFkeU9uQ2hpbGQpOwogICAgdGhpcy5vbignY2hpbGQnLCB0cmlnZ2VyUmVhZHlPbkNoaWxkKTsKICB9Cn0pOwoKdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXihuZXN0ZWRccyspPyhcUyspKD86XHMrKC4rKSk/LzsKCnZhciBkb21FdmVudHMgPSBbXSwKICAgIGRvbUV2ZW50UmVnZXhwOwpmdW5jdGlvbiBwdXNoRG9tRXZlbnRzKGV2ZW50cykgewogIGRvbUV2ZW50cy5wdXNoLmFwcGx5KGRvbUV2ZW50cywgZXZlbnRzKTsKICBkb21FdmVudFJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14obmVzdGVkXFxzKyk/KCcgKyBkb21FdmVudHMuam9pbignfCcpICsgJykoPzpcXHN8JCknKTsKfQpwdXNoRG9tRXZlbnRzKFsKICAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsCiAgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAndG91Y2htb3ZlJywKICAnY2xpY2snLCAnZGJsY2xpY2snLAogICdrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJywKICAnc3VibWl0JywgJ2NoYW5nZScsCiAgJ2ZvY3VzJywgJ2JsdXInCl0pOwoKZnVuY3Rpb24gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoaGFuZGxlciwgY2lkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdmlldyA9ICQoZXZlbnQudGFyZ2V0KS52aWV3KHtoZWxwZXI6IGZhbHNlfSk7CiAgICBpZiAodmlldyAmJiB2aWV3LmNpZCA9PT0gY2lkKSB7CiAgICAgIGV2ZW50Lm9yaWdpbmFsQ29udGV4dCA9IHRoaXM7CiAgICAgIGhhbmRsZXIoZXZlbnQpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIGJpbmRFdmVudEhhbmRsZXIoZXZlbnROYW1lLCBwYXJhbXMpIHsKICBldmVudE5hbWUgKz0gcGFyYW1zLm9yaWdpbmFsTmFtZTsKCiAgdmFyIGNhbGxiYWNrID0gcGFyYW1zLmhhbmRsZXIsCiAgICAgIG1ldGhvZCA9IF8uaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayA6IHRoaXNbY2FsbGJhY2tdOwogIGlmICghbWV0aG9kKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0V2ZW50ICInICsgY2FsbGJhY2sgKyAnIiBkb2VzIG5vdCBleGlzdCAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkgKyAnOicgKyBldmVudE5hbWUpOwogIH0KICByZXR1cm4gXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgdHJ5IHsKICAgICAgbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIFRob3JheC5vbkV4Y2VwdGlvbigndGhvcmF4LWV4Y2VwdGlvbjogJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJzonICsgZXZlbnROYW1lLCBlKTsKICAgIH0KICB9LCBwYXJhbXMuY29udGV4dCB8fCB0aGlzKTsKfQoKZnVuY3Rpb24gZXZlbnRQYXJhbXNGcm9tRXZlbnRJdGVtKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICB2YXIgcGFyYW1zID0gewogICAgb3JpZ2luYWxOYW1lOiBuYW1lLAogICAgaGFuZGxlcjogXy5pc1N0cmluZyhoYW5kbGVyKSA/IHRoaXNbaGFuZGxlcl0gOiBoYW5kbGVyCiAgfTsKICBpZiAobmFtZS5tYXRjaChkb21FdmVudFJlZ2V4cCkpIHsKICAgIHZhciBtYXRjaCA9IGV2ZW50U3BsaXR0ZXIuZXhlYyhuYW1lKTsKICAgIHBhcmFtcy5uZXN0ZWQgPSAhIW1hdGNoWzFdOwogICAgcGFyYW1zLm5hbWUgPSBtYXRjaFsyXTsKICAgIHBhcmFtcy50eXBlID0gJ0RPTSc7CiAgICBwYXJhbXMuc2VsZWN0b3IgPSBtYXRjaFszXTsKICB9IGVsc2UgewogICAgcGFyYW1zLm5hbWUgPSBuYW1lOwogICAgcGFyYW1zLnR5cGUgPSAndmlldyc7CiAgfQogIHBhcmFtcy5jb250ZXh0ID0gY29udGV4dDsKICByZXR1cm4gcGFyYW1zOwp9Cgo7OwovKmdsb2JhbCBnZXRPcHRpb25zRGF0YSwgdmlld0hlbHBlckF0dHJpYnV0ZU5hbWUgKi8KdmFyIHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LXRtcCcsCiAgICB2aWV3VGVtcGxhdGVPdmVycmlkZXMgPSB7fTsKCi8vIFdpbGwgYmUgc2hhcmVkIGJ5IEhlbHBlclZpZXcgYW5kIENvbGxlY3Rpb25IZWxwZXJWaWV3CnZhciBoZWxwZXJWaWV3UHJvdG90eXBlID0gewogIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIFRob3JheC5WaWV3LnByb3RvdHlwZS5fZW5zdXJlRWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy4kZWwuYXR0cih2aWV3SGVscGVyQXR0cmlidXRlTmFtZSwgdGhpcy5faGVscGVyTmFtZSk7CiAgfSwKICBfZ2V0Q29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5wYXJlbnQuX2dldENvbnRleHQuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgfQp9OwoKVGhvcmF4LkhlbHBlclZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoaGVscGVyVmlld1Byb3RvdHlwZSk7CgovLyBFbnN1cmUgbmVzdGVkIGlubGluZSBoZWxwZXJzIHdpbGwgYWx3YXlzIGhhdmUgdGhpcy5wYXJlbnQKLy8gc2V0IHRvIHRoZSB2aWV3IGNvbnRhaW5pbmcgdGhlIHRlbXBsYXRlCmZ1bmN0aW9uIGdldFBhcmVudChwYXJlbnQpIHsKICAvLyBUaGUgYHZpZXdgIGhlbHBlciBpcyBhIHNwZWNpYWwgY2FzZSBhcyBpdCBlbWJlZHMKICAvLyBhIHZpZXcgaW5zdGVhZCBvZiBjcmVhdGluZyBhIG5ldyBvbmUKICB3aGlsZSAocGFyZW50Ll9oZWxwZXJOYW1lICYmIHBhcmVudC5faGVscGVyTmFtZSAhPT0gJ3ZpZXcnKSB7CiAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50OwogIH0KICByZXR1cm4gcGFyZW50Owp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlciA9IGZ1bmN0aW9uKG5hbWUsIFZpZXdDbGFzcywgY2FsbGJhY2spIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgIGNhbGxiYWNrID0gVmlld0NsYXNzLmNhbGxiYWNrOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBWaWV3Q2xhc3M7CiAgICAgIFZpZXdDbGFzcyA9IFRob3JheC5IZWxwZXJWaWV3OwogICAgfQogIH0KICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgICBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgIHRlbXBsYXRlOiBvcHRpb25zLmZuIHx8IEhhbmRsZWJhcnMuVk0ubm9vcCwKICAgICAgaW52ZXJzZTogb3B0aW9ucy5pbnZlcnNlLAogICAgICBvcHRpb25zOiBvcHRpb25zLmhhc2gsCiAgICAgIGRlY2xhcmluZ1ZpZXc6IGRlY2xhcmluZ1ZpZXcsCiAgICAgIHBhcmVudDogZ2V0UGFyZW50KGRlY2xhcmluZ1ZpZXcpLAogICAgICBfaGVscGVyTmFtZTogbmFtZSwKICAgICAgX2hlbHBlck9wdGlvbnM6IHsKICAgICAgICBvcHRpb25zOiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucyksCiAgICAgICAgYXJnczogXy5jbG9uZShhcmdzKQogICAgICB9CiAgICB9OwoKICAgIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgICBfLmV4dGVuZCh2aWV3T3B0aW9ucywgXy5waWNrKG9wdGlvbnMuaGFzaCwgaHRtbEF0dHJpYnV0ZXNUb0NvcHkpKTsKCiAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhbiBleGlzdGluZyBpbnN0YW5jZSB0aGF0IHdlIGNhbiByZXVzZQogICAgdmFyIGluc3RhbmNlID0gXy5maW5kKGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuIGNvbXBhcmVIZWxwZXJPcHRpb25zKHZpZXdPcHRpb25zLCBjaGlsZCk7CiAgICB9KTsKCiAgICAvLyBDcmVhdGUgdGhlIGluc3RhbmNlIGlmIHdlIGRvbid0IGFscmVhZHkgaGF2ZSBvbmUKICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgICAgaW5zdGFuY2UgPSBWaWV3Q2xhc3MuZmFjdG9yeShhcmdzLCB2aWV3T3B0aW9ucyk7CiAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgaW5zdGFuY2UuX2hlbHBlck5hbWUgPSB2aWV3T3B0aW9ucy5faGVscGVyTmFtZTsKICAgICAgICBpbnN0YW5jZS5faGVscGVyT3B0aW9ucyA9IHZpZXdPcHRpb25zLl9oZWxwZXJPcHRpb25zOwogICAgICB9IGVsc2UgewogICAgICAgIGluc3RhbmNlID0gbmV3IFZpZXdDbGFzcyh2aWV3T3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIGFyZ3MucHVzaChpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyJywgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICBkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMgPSBfLndpdGhvdXQoZGVjbGFyaW5nVmlldy5fcHJldmlvdXNIZWxwZXJzLCBpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuY2hpbGRyZW5baW5zdGFuY2UuY2lkXSA9IGluc3RhbmNlOwogICAgfQoKICAgIHZhciBodG1sQXR0cmlidXRlcyA9IF8ucGljayhvcHRpb25zLmhhc2gsIGh0bWxBdHRyaWJ1dGVzVG9Db3B5KTsKICAgIGh0bWxBdHRyaWJ1dGVzW3ZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gaW5zdGFuY2UuY2lkOwoKICAgIHZhciBleHBhbmRUb2tlbnMgPSBvcHRpb25zLmhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICAgIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhodG1sQXR0cmlidXRlcywgJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7CiAgfSk7CiAgdmFyIGhlbHBlciA9IEhhbmRsZWJhcnMuaGVscGVyc1tuYW1lXTsKICByZXR1cm4gaGVscGVyOwp9OwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyB2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgcGxhY2Vob2xkZXJJZCA9IGVsLmdldEF0dHJpYnV0ZSh2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICB2aWV3ID0gdGhpcy5jaGlsZHJlbltwbGFjZWhvbGRlcklkXTsKICAgIGlmICh2aWV3KSB7CiAgICAgIC8vc2VlIGlmIHRoZSB2aWV3IGhlbHBlciBkZWNsYXJlZCBhbiBvdmVycmlkZSBmb3IgdGhlIHZpZXcKICAgICAgLy9pZiBub3QsIGVuc3VyZSB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZCBhdCBsZWFzdCBvbmNlCiAgICAgIGlmICh2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pIHsKICAgICAgICB2aWV3LnJlbmRlcih2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pOwogICAgICAgIGRlbGV0ZSB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICB9CiAgICAgICQoZWwpLnJlcGxhY2VXaXRoKHZpZXcuZWwpOwogICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh2aWV3LmVsKTsKICAgIH0KICB9LCB0aGlzKTsKfSk7CgoKLyoqCiAqIENsb25lcyB0aGUgaGVscGVyIG9wdGlvbnMsIGRyb3BwaW5nIGl0ZW1zIHRoYXQgYXJlIGtub3duIHRvIGNoYW5nZQogKiBiZXR3ZWVuIHJlbmRlcmluZyBjeWNsZXMgYXMgYXBwcm9wcmlhdGUuCiAqLwpmdW5jdGlvbiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucykgewogIHZhciByZXQgPSBfLnBpY2sob3B0aW9ucywgJ2ZuJywgJ2ludmVyc2UnLCAnaGFzaCcsICdkYXRhJyk7CiAgcmV0LmRhdGEgPSBfLm9taXQob3B0aW9ucy5kYXRhLCAnY2lkJywgJ3ZpZXcnLCAneWllbGQnKTsKICByZXR1cm4gcmV0Owp9CgovKioKICogQ2hlY2tzIGZvciBiYXNpYyBlcXVhbGl0eSBiZXR3ZWVuIHR3byBzZXRzIG9mIHBhcmFtZXRlcnMgZm9yIGEgaGVscGVyIHZpZXcuCiAqCiAqIENoZWNrZWQgZmllbGRzIGluY2x1ZGU6CiAqICAtIF9oZWxwZXJOYW1lCiAqICAtIEFsbCBhcmdzCiAqICAtIEhhc2gKICogIC0gRGF0YQogKiAgLSBGdW5jdGlvbiBhbmQgSW52ZXJ0IChpZCBiYXNlZCBpZiBwb3NzaWJsZSkKICoKICogVGhpcyBtZXRob2QgYWxsb3dzIHVzIHRvIGRldGVybWluZSBpZiB0aGUgaW5wdXRzIHRvIGEgZ2l2ZW4gdmlldyBhcmUgdGhlIHNhbWUuIElmIHRoZXkKICogYXJlIHRoZW4gd2UgbWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSByZW5kZXJpbmcgd2lsbCBiZSB0aGUgc2FtZSAob3IgdGhlIGNoaWxkIHZpZXcgd2lsbAogKiBvdGhlcndpc2UgcmVyZW5kZXJpbmcgaXQgYnkgbW9uaXRvcmluZyBpdCdzIHBhcmFtZXRlcnMgYXMgbmVjZXNzYXJ5KSBhbmQgcmV1c2UgdGhlIHZpZXcgb24KICogcmVyZW5kZXIgb2YgdGhlIHBhcmVudCB2aWV3LgogKi8KZnVuY3Rpb24gY29tcGFyZUhlbHBlck9wdGlvbnMoYSwgYikgewogIGZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYikgewogICAgcmV0dXJuIF8uZXZlcnkoYSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXR1cm4gYltrZXldID09PSB2YWx1ZTsKICAgIH0pOwogIH0KCiAgaWYgKGEuX2hlbHBlck5hbWUgIT09IGIuX2hlbHBlck5hbWUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGEgPSBhLl9oZWxwZXJPcHRpb25zOwogIGIgPSBiLl9oZWxwZXJPcHRpb25zOwoKICAvLyBJbXBsZW1lbnRzIGEgZmlyc3QgbGV2ZWwgZGVwdGggY29tcGFyaXNvbgogIHJldHVybiBhLmFyZ3MubGVuZ3RoID09PSBiLmFyZ3MubGVuZ3RoCiAgICAgICYmIGNvbXBhcmVWYWx1ZXMoYS5hcmdzLCBiLmFyZ3MpCiAgICAgICYmIF8uaXNFcXVhbChfLmtleXMoYS5vcHRpb25zKSwgXy5rZXlzKGIub3B0aW9ucykpCiAgICAgICYmIF8uZXZlcnkoYS5vcHRpb25zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnZGF0YScgfHwga2V5ID09PSAnaGFzaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXMoYS5vcHRpb25zW2tleV0sIGIub3B0aW9uc1trZXldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZm4nIHx8IGtleSA9PT0gJ2ludmVyc2UnKSB7CiAgICAgICAgICAgIHJldHVybiBiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWUKICAgICAgICAgICAgICAgIHx8ICh2YWx1ZSAmJiBfLmhhcyh2YWx1ZSwgJ3Byb2dyYW0nKSAmJiAoKGIub3B0aW9uc1trZXldIHx8IHt9KS5wcm9ncmFtID09PSB2YWx1ZS5wcm9ncmFtKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYi5vcHRpb25zW2tleV0gPT09IHZhbHVlOwogICAgICAgIH0pOwp9Cgo7OwovKmdsb2JhbCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMsIHdhbGtJbmhlcml0VHJlZSAqLwoKZnVuY3Rpb24gZGF0YU9iamVjdCh0eXBlLCBzcGVjKSB7CiAgc3BlYyA9IGluaGVyaXRWYXJzW3R5cGVdID0gXy5kZWZhdWx0cyh7CiAgICBuYW1lOiAnXycgKyB0eXBlICsgJ0V2ZW50cycsCiAgICBldmVudDogdHJ1ZQogIH0sIHNwZWMpOwoKICAvLyBBZGQgYSBjYWxsYmFjayBpbiB0aGUgdmlldyBjb25zdHJ1Y3RvcgogIHNwZWMuY3RvciA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXNbdHlwZV0pIHsKICAgICAgLy8gTmVlZCB0byBudWxsIHRoaXMubW9kZWwvY29sbGVjdGlvbiBzbyBzZXRNb2RlbC9Db2xsZWN0aW9uIHdpbGwKICAgICAgLy8gbm90IHRyZWF0IGl0IGFzIHRoZSBvbGQgbW9kZWwvY29sbGVjdGlvbiBhbmQgaW1tZWRpYXRlbHkgcmV0dXJuCiAgICAgIHZhciBvYmplY3QgPSB0aGlzW3R5cGVdOwogICAgICB0aGlzW3R5cGVdID0gbnVsbDsKICAgICAgdGhpc1tzcGVjLnNldF0ob2JqZWN0KTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiBzZXRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgdmFyIG9sZCA9IHRoaXNbdHlwZV0sCiAgICAgICAgJGVsID0gZ2V0VmFsdWUodGhpcywgc3BlYy4kZWwpOwoKICAgIGlmIChkYXRhT2JqZWN0ID09PSBvbGQpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBpZiAob2xkKSB7CiAgICAgIHRoaXMudW5iaW5kRGF0YU9iamVjdChvbGQpOwogICAgfQoKICAgIGlmIChkYXRhT2JqZWN0KSB7CiAgICAgIHRoaXNbdHlwZV0gPSBkYXRhT2JqZWN0OwoKICAgICAgaWYgKHNwZWMubG9hZGluZykgewogICAgICAgIHNwZWMubG9hZGluZy5jYWxsKHRoaXMpOwogICAgICB9CgogICAgICB0aGlzLmJpbmREYXRhT2JqZWN0KHR5cGUsIGRhdGFPYmplY3QsIF8uZXh0ZW5kKHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpKTsKICAgICAgJGVsICYmICRlbC5hdHRyKHNwZWMuY2lkQXR0ck5hbWUsIGRhdGFPYmplY3QuY2lkKTsKICAgICAgZGF0YU9iamVjdC50cmlnZ2VyKCdzZXQnLCBkYXRhT2JqZWN0LCBvbGQpOwogICAgfSBlbHNlIHsKICAgICAgdGhpc1t0eXBlXSA9IGZhbHNlOwogICAgICBpZiAoc3BlYy5jaGFuZ2UpIHsKICAgICAgICBzcGVjLmNoYW5nZS5jYWxsKHRoaXMsIGZhbHNlKTsKICAgICAgfQogICAgICAkZWwgJiYgJGVsLnJlbW92ZUF0dHIoc3BlYy5jaWRBdHRyTmFtZSk7CiAgICB9CiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTpkYXRhLW9iamVjdCcsIHR5cGUsIGRhdGFPYmplY3QsIG9sZCk7CiAgICByZXR1cm4gdGhpczsKICB9CgogIFRob3JheC5WaWV3LnByb3RvdHlwZVtzcGVjLnNldF0gPSBzZXRPYmplY3Q7Cn0KCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIGJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbih0eXBlLCBkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICBpZiAodGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdID0gZGF0YU9iamVjdDsKCiAgICB2YXIgb3B0aW9ucyA9IHRoaXMuX21vZGlmeURhdGFPYmplY3RPcHRpb25zKGRhdGFPYmplY3QsIF8uZXh0ZW5kKHt9LCBpbmhlcml0VmFyc1t0eXBlXS5kZWZhdWx0T3B0aW9ucywgb3B0aW9ucykpOwogICAgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2RhdGFPYmplY3QuY2lkXSA9IG9wdGlvbnM7CgogICAgYmluZEV2ZW50cy5jYWxsKHRoaXMsIHR5cGUsIGRhdGFPYmplY3QsIHRoaXMuY29uc3RydWN0b3IpOwogICAgYmluZEV2ZW50cy5jYWxsKHRoaXMsIHR5cGUsIGRhdGFPYmplY3QsIHRoaXMpOwoKICAgIHZhciBzcGVjID0gaW5oZXJpdFZhcnNbdHlwZV07CiAgICBzcGVjLmJpbmRDYWxsYmFjayAmJiBzcGVjLmJpbmRDYWxsYmFjay5jYWxsKHRoaXMsIGRhdGFPYmplY3QsIG9wdGlvbnMpOwoKICAgIGlmIChkYXRhT2JqZWN0LnNob3VsZEZldGNoICYmIGRhdGFPYmplY3Quc2hvdWxkRmV0Y2gob3B0aW9ucykpIHsKICAgICAgbG9hZE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKTsKICAgIH0gZWxzZSBpZiAoaW5oZXJpdFZhcnNbdHlwZV0uY2hhbmdlKSB7CiAgICAgIC8vIHdhbnQgdG8gdHJpZ2dlciBidWlsdCBpbiByZW5kZXJpbmcgd2l0aG91dCB0cmlnZ2VyaW5nIGV2ZW50IG9uIG1vZGVsCiAgICAgIGluaGVyaXRWYXJzW3R5cGVdLmNoYW5nZS5jYWxsKHRoaXMsIGRhdGFPYmplY3QsIG9wdGlvbnMpOwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0sCgogIHVuYmluZERhdGFPYmplY3Q6IGZ1bmN0aW9uIChkYXRhT2JqZWN0KSB7CiAgICBpZiAoIXRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZGVsZXRlIHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF07CiAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoZGF0YU9iamVjdCk7CiAgICBkZWxldGUgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2RhdGFPYmplY3QuY2lkXTsKICAgIHJldHVybiB0cnVlOwogIH0sCgogIF9tb2RpZnlEYXRhT2JqZWN0T3B0aW9uczogZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgcmV0dXJuIG9wdGlvbnM7CiAgfQp9KTsKCmZ1bmN0aW9uIGJpbmRFdmVudHModHlwZSwgdGFyZ2V0LCBzb3VyY2UpIHsKICB2YXIgY29udGV4dCA9IHRoaXM7CiAgd2Fsa0luaGVyaXRUcmVlKHNvdXJjZSwgJ18nICsgdHlwZSArICdFdmVudHMnLCB0cnVlLCBmdW5jdGlvbihldmVudCkgewogICAgLy8gZ2V0RXZlbnRDYWxsYmFjayB3aWxsIHJlc29sdmUgaWYgaXQgaXMgYSBzdHJpbmcgb3IgYSBtZXRob2QKICAgIC8vIGFuZCByZXR1cm4gYSBtZXRob2QKICAgIGNvbnRleHQubGlzdGVuVG8odGFyZ2V0LCBldmVudFswXSwgXy5iaW5kKGdldEV2ZW50Q2FsbGJhY2soZXZlbnRbMV0sIGNvbnRleHQpLCBldmVudFsyXSB8fCBjb250ZXh0KSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGxvYWRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucykgewogIGlmIChkYXRhT2JqZWN0LmxvYWQpIHsKICAgIGRhdGFPYmplY3QubG9hZChmdW5jdGlvbigpIHsKICAgICAgb3B0aW9ucyAmJiBvcHRpb25zLnN1Y2Nlc3MgJiYgb3B0aW9ucy5zdWNjZXNzKGRhdGFPYmplY3QpOwogICAgfSwgb3B0aW9ucyk7CiAgfSBlbHNlIHsKICAgIGRhdGFPYmplY3QuZmV0Y2gob3B0aW9ucyk7CiAgfQp9CgpmdW5jdGlvbiBnZXRFdmVudENhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgaWYgKF8uaXNGdW5jdGlvbihjYWxsYmFjaykpIHsKICAgIHJldHVybiBjYWxsYmFjazsKICB9IGVsc2UgewogICAgcmV0dXJuIGNvbnRleHRbY2FsbGJhY2tdOwogIH0KfQoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBkYXRhT2JqZWN0LCBnZXRWYWx1ZSAqLwp2YXIgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtbW9kZWwtY2lkJzsKClRob3JheC5Nb2RlbCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9LAogIGlzUG9wdWxhdGVkOiBmdW5jdGlvbigpIHsKICAgIC8vIFdlIGFyZSBwb3B1bGF0ZWQgaWYgd2UgaGF2ZSBhdHRyaWJ1dGVzIHNldAogICAgdmFyIGF0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyksCiAgICAgICAgZGVmYXVsdHMgPSBnZXRWYWx1ZSh0aGlzLCAnZGVmYXVsdHMnKSB8fCB7fTsKICAgIGZvciAodmFyIGRlZmF1bHRfa2V5IGluIGRlZmF1bHRzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzW2RlZmF1bHRfa2V5XSAhPSBkZWZhdWx0c1tkZWZhdWx0X2tleV0pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBkZWxldGUgYXR0cmlidXRlc1tkZWZhdWx0X2tleV07CiAgICB9CiAgICB2YXIga2V5cyA9IF8ua2V5cyhhdHRyaWJ1dGVzKTsKICAgIHJldHVybiBrZXlzLmxlbmd0aCA+IDEgfHwgKGtleXMubGVuZ3RoID09PSAxICYmIGtleXNbMF0gIT09IHRoaXMuaWRBdHRyaWJ1dGUpOwogIH0sCiAgc2hvdWxkRmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIC8vIHVybCgpIHdpbGwgdGhyb3cgaWYgbW9kZWwgaGFzIG5vIGB1cmxSb290YCBhbmQgbm8gYGNvbGxlY3Rpb25gCiAgICAvLyBvciBoYXMgYGNvbGxlY3Rpb25gIGFuZCBgY29sbGVjdGlvbmAgaGFzIG5vIGB1cmxgCiAgICB2YXIgdXJsOwogICAgdHJ5IHsKICAgICAgdXJsID0gZ2V0VmFsdWUodGhpcywgJ3VybCcpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHVybCA9IGZhbHNlOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMuZmV0Y2ggJiYgISF1cmwgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9Cn0pOwoKVGhvcmF4Lk1vZGVscyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4Lk1vZGVsLCBUaG9yYXguTW9kZWxzKTsKCmRhdGFPYmplY3QoJ21vZGVsJywgewogIHNldDogJ3NldE1vZGVsJywKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB0cnVlLAogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGVycm9yczogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbk1vZGVsQ2hhbmdlLAogICRlbDogJyRlbCcsCiAgY2lkQXR0ck5hbWU6IG1vZGVsQ2lkQXR0cmlidXRlTmFtZQp9KTsKCmZ1bmN0aW9uIG9uTW9kZWxDaGFuZ2UobW9kZWwpIHsKICB2YXIgbW9kZWxPcHRpb25zID0gbW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW21vZGVsLmNpZF07CiAgLy8gIW1vZGVsT3B0aW9ucyB3aWxsIGJlIHRydWUgd2hlbiBzZXRNb2RlbChmYWxzZSkgaXMgY2FsbGVkCiAgaWYgKCFtb2RlbE9wdGlvbnMgfHwgKG1vZGVsT3B0aW9ucyAmJiBtb2RlbE9wdGlvbnMucmVuZGVyKSkgewogICAgdGhpcy5yZW5kZXIoKTsKICB9Cn0KClRob3JheC5WaWV3Lm9uKHsKICBtb2RlbDogewogICAgZXJyb3I6IGZ1bmN0aW9uKG1vZGVsLCBlcnJvcnMpIHsKICAgICAgaWYgKHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFttb2RlbC5jaWRdLmVycm9ycykgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBlcnJvcnMsIG1vZGVsKTsKICAgICAgfQogICAgfSwKICAgIGNoYW5nZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgb25Nb2RlbENoYW5nZS5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0KICB9Cn0pOwoKJC5mbi5tb2RlbCA9IGZ1bmN0aW9uKHZpZXcpIHsKICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICBtb2RlbEVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICddJyksCiAgICAgIG1vZGVsQ2lkID0gbW9kZWxFbGVtZW50ICYmIG1vZGVsRWxlbWVudC5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSk7CiAgaWYgKG1vZGVsQ2lkKSB7CiAgICB2YXIgdmlldyA9IHZpZXcgfHwgJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcgJiYgdmlldy5tb2RlbCAmJiB2aWV3Lm1vZGVsLmNpZCA9PT0gbW9kZWxDaWQpIHsKICAgICAgcmV0dXJuIHZpZXcubW9kZWwgfHwgZmFsc2U7CiAgICB9CiAgICB2YXIgY29sbGVjdGlvbiA9ICR0aGlzLmNvbGxlY3Rpb24odmlldyk7CiAgICBpZiAoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gY29sbGVjdGlvbi5nZXQobW9kZWxDaWQpOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn07Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIsIGRhdGFPYmplY3QsIGdldEV2ZW50Q2FsbGJhY2ssIGdldFZhbHVlLCBtb2RlbENpZEF0dHJpYnV0ZU5hbWUsIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICovCnZhciBfZmV0Y2ggPSBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5mZXRjaCwKICAgIF9yZXNldCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLnJlc2V0LAogICAgX3JlcGxhY2VIVE1MID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLl9yZXBsYWNlSFRNTCwKICAgIGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1jaWQnLAogICAgY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tZW1wdHknLAogICAgY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1lbGVtZW50JywKICAgIEVMRU1FTlRfTk9ERV9UWVBFID0gMTsKClRob3JheC5Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewogIG1vZGVsOiBUaG9yYXguTW9kZWwgfHwgQmFja2JvbmUuTW9kZWwsCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2NvbGxlY3Rpb24nKTsKICAgIHJldHVybiBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKICBpc0VtcHR5OiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoID09PSAwICYmIHRoaXMuaXNQb3B1bGF0ZWQoKTsKICAgIH0KICB9LAogIGlzUG9wdWxhdGVkOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9mZXRjaGVkIHx8IHRoaXMubGVuZ3RoID4gMCB8fCAoIXRoaXMubGVuZ3RoICYmICFnZXRWYWx1ZSh0aGlzLCAndXJsJykpOwogIH0sCiAgc2hvdWxkRmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBvcHRpb25zLmZldGNoICYmICEhZ2V0VmFsdWUodGhpcywgJ3VybCcpICYmICF0aGlzLmlzUG9wdWxhdGVkKCk7CiAgfSwKICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIHJlc3BvbnNlKSB7CiAgICAgIGNvbGxlY3Rpb24uX2ZldGNoZWQgPSB0cnVlOwogICAgICBzdWNjZXNzICYmIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcG9uc2UpOwogICAgfTsKICAgIHJldHVybiBfZmV0Y2guYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9LAogIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIHRoaXMuX2ZldGNoZWQgPSAhIW1vZGVsczsKICAgIHJldHVybiBfcmVzZXQuY2FsbCh0aGlzLCBtb2RlbHMsIG9wdGlvbnMpOwogIH0KfSk7CgpUaG9yYXguQ29sbGVjdGlvbnMgPSB7fTsKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5Db2xsZWN0aW9uLCBUaG9yYXguQ29sbGVjdGlvbnMpOwoKZGF0YU9iamVjdCgnY29sbGVjdGlvbicsIHsKICBzZXQ6ICdzZXRDb2xsZWN0aW9uJywKICBiaW5kQ2FsbGJhY2s6IG9uU2V0Q29sbGVjdGlvbiwKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB0cnVlLAogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGVycm9yczogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbkNvbGxlY3Rpb25SZXNldCwKICAkZWw6ICdnZXRDb2xsZWN0aW9uRWxlbWVudCcsCiAgY2lkQXR0ck5hbWU6IGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lCn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25WaWV3ID0gVGhvcmF4LlZpZXcuZXh0ZW5kKHsKICBfZGVmYXVsdFRlbXBsYXRlOiBIYW5kbGViYXJzLlZNLm5vb3AsCiAgX2NvbGxlY3Rpb25TZWxlY3RvcjogJ1snICsgY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lICsgJ10nLAogIAogIC8vIHByZXNlcnZlIGNvbGxlY3Rpb24gZWxlbWVudCBpZiBpdCB3YXMgbm90IGNyZWF0ZWQgd2l0aCB7e2NvbGxlY3Rpb259fSBoZWxwZXIKICBfcmVwbGFjZUhUTUw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb24gJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMuY29sbGVjdGlvbi5jaWRdICYmIHRoaXMuX3JlbmRlckNvdW50KSB7CiAgICAgIHZhciBlbGVtZW50OwogICAgICB2YXIgb2xkQ29sbGVjdGlvbkVsZW1lbnQgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIGVsZW1lbnQgPSBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgICAgaWYgKCFvbGRDb2xsZWN0aW9uRWxlbWVudC5hdHRyKCdkYXRhLXZpZXctY2lkJykpIHsKICAgICAgICB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCkucmVwbGFjZVdpdGgob2xkQ29sbGVjdGlvbkVsZW1lbnQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gX3JlcGxhY2VIVE1MLmNhbGwodGhpcywgaHRtbCk7CiAgICB9CiAgfSwKCiAgLy9hcHBlbmRJdGVtKG1vZGVsIFssaW5kZXhdKQogIC8vYXBwZW5kSXRlbShodG1sX3N0cmluZywgaW5kZXgpCiAgLy9hcHBlbmRJdGVtKHZpZXcsIGluZGV4KQogIGFwcGVuZEl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpbmRleCwgb3B0aW9ucykgewogICAgLy9lbXB0eSBpdGVtCiAgICBpZiAoIW1vZGVsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBpdGVtVmlldywKICAgICAgICAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGZpbHRlcjogdHJ1ZQogICAgfSk7CiAgICAvL2lmIGluZGV4IGFyZ3VtZW50IGlzIGEgdmlldwogICAgaW5kZXggJiYgaW5kZXguZWwgJiYgKGluZGV4ID0gJGVsLmNoaWxkcmVuKCkuaW5kZXhPZihpbmRleC5lbCkgKyAxKTsKICAgIC8vaWYgYXJndW1lbnQgaXMgYSB2aWV3LCBvciBodG1sIHN0cmluZwogICAgaWYgKG1vZGVsLmVsIHx8IF8uaXNTdHJpbmcobW9kZWwpKSB7CiAgICAgIGl0ZW1WaWV3ID0gbW9kZWw7CiAgICAgIG1vZGVsID0gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICBpbmRleCA9IGluZGV4IHx8IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSB8fCAwOwogICAgICBpdGVtVmlldyA9IHRoaXMucmVuZGVySXRlbShtb2RlbCwgaW5kZXgpOwogICAgfQogICAgaWYgKGl0ZW1WaWV3KSB7CiAgICAgIGl0ZW1WaWV3LmNpZCAmJiB0aGlzLl9hZGRDaGlsZChpdGVtVmlldyk7CiAgICAgIC8vaWYgdGhlIHJlbmRlcmVyJ3Mgb3V0cHV0IHdhc24ndCBjb250YWluZWQgaW4gYSB0YWcsIHdyYXAgaXQgaW4gYSBkaXYKICAgICAgLy9wbGFpbiB0ZXh0LCBvciBhIG1peHR1cmUgb2YgdG9wIGxldmVsIHRleHQgbm9kZXMgYW5kIGVsZW1lbnQgbm9kZXMKICAgICAgLy93aWxsIGdldCB3cmFwcGVkCiAgICAgIGlmIChfLmlzU3RyaW5nKGl0ZW1WaWV3KSAmJiAhaXRlbVZpZXcubWF0Y2goL15ccyo8L20pKSB7CiAgICAgICAgaXRlbVZpZXcgPSAnPGRpdj4nICsgaXRlbVZpZXcgKyAnPC9kaXY+JzsKICAgICAgfQogICAgICB2YXIgaXRlbUVsZW1lbnQgPSBpdGVtVmlldy5lbCA/IFtpdGVtVmlldy5lbF0gOiBfLmZpbHRlcigkKGl0ZW1WaWV3KSwgZnVuY3Rpb24obm9kZSkgewogICAgICAgIC8vZmlsdGVyIG91dCB0b3AgbGV2ZWwgd2hpdGVzcGFjZSBub2RlcwogICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREVfVFlQRTsKICAgICAgfSk7CiAgICAgIG1vZGVsICYmICQoaXRlbUVsZW1lbnQpLmF0dHIobW9kZWxDaWRBdHRyaWJ1dGVOYW1lLCBtb2RlbC5jaWQpOwogICAgICB2YXIgcHJldmlvdXNNb2RlbCA9IGluZGV4ID4gMCA/IHRoaXMuY29sbGVjdGlvbi5hdChpbmRleCAtIDEpIDogZmFsc2U7CiAgICAgIGlmICghcHJldmlvdXNNb2RlbCkgewogICAgICAgICRlbC5wcmVwZW5kKGl0ZW1FbGVtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvL3VzZSBsYXN0KCkgYXMgYXBwZW5kSXRlbSBjYW4gYWNjZXB0IG11bHRpcGxlIG5vZGVzIGZyb20gYSB0ZW1wbGF0ZQogICAgICAgIHZhciBsYXN0ID0gJGVsLmZpbmQoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIHByZXZpb3VzTW9kZWwuY2lkICsgJyJdJykubGFzdCgpOwogICAgICAgIGxhc3QuYWZ0ZXIoaXRlbUVsZW1lbnQpOwogICAgICB9CgogICAgICB0aGlzLnRyaWdnZXIoJ2FwcGVuZCcsIG51bGwsIGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgZWwuc2V0QXR0cmlidXRlKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgfSk7CgogICAgICAhb3B0aW9ucy5zaWxlbnQgJiYgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDppdGVtJywgdGhpcywgdGhpcy5jb2xsZWN0aW9uLCBtb2RlbCwgaXRlbUVsZW1lbnQsIGluZGV4KTsKICAgICAgb3B0aW9ucy5maWx0ZXIgJiYgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfQogICAgcmV0dXJuIGl0ZW1WaWV3OwogIH0sCiAgLy/CoHVwZGF0ZUl0ZW0gb25seSB1c2VmdWwgaWYgdGhlcmUgaXMgbm8gaXRlbSB2aWV3LCBvdGhlcndpc2UKICAvL8KgaXRlbVZpZXcucmVuZGVyKCkgcHJvdmlkZXMgdGhlIHNhbWUgZnVuY3Rpb25hbGl0eQogIHVwZGF0ZUl0ZW06IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB0aGlzLnJlbW92ZUl0ZW0obW9kZWwpOwogICAgdGhpcy5hcHBlbmRJdGVtKG1vZGVsKTsKICB9LAogIHJlbW92ZUl0ZW06IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpLAogICAgICAgIHZpZXdFbCA9ICRlbC5maW5kKCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICc9IicgKyBtb2RlbC5jaWQgKyAnIl0nKTsKICAgIGlmICghdmlld0VsLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2aWV3RWwucmVtb3ZlKCk7CiAgICB2YXIgdmlld0NpZCA9IHZpZXdFbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lKSwKICAgICAgICBjaGlsZCA9IHRoaXMuY2hpbGRyZW5bdmlld0NpZF07CiAgICBpZiAoY2hpbGQpIHsKICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICBjaGlsZC5kZXN0cm95KCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIHJlbmRlckNvbGxlY3Rpb246IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuY29sbGVjdGlvbikgewogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uLmlzRW1wdHkoKSkgewogICAgICAgIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaSkgewogICAgICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGkpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcigncmVuZGVyZWQ6Y29sbGVjdGlvbicsIHRoaXMsIHRoaXMuY29sbGVjdGlvbik7CiAgICAgIGFwcGx5VmlzaWJpbGl0eUZpbHRlci5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgZW1wdHlDbGFzczogJ2VtcHR5JywKICByZW5kZXJFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSAmJiAhdGhpcy5lbXB0eVZpZXcpIHsKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAnZW1wdHlUZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctZW1wdHknLAogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLmVtcHR5VmlldykgewogICAgICB2YXIgdmlld09wdGlvbnMgPSB7fTsKICAgICAgaWYgKHRoaXMuZW1wdHlUZW1wbGF0ZSkgewogICAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gdGhpcy5lbXB0eVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuZW1wdHlWaWV3LCB2aWV3T3B0aW9ucyk7CiAgICAgIHZpZXcuZW5zdXJlUmVuZGVyZWQoKTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5lbXB0eVRlbXBsYXRlICYmIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5lbXB0eVRlbXBsYXRlKTsKICAgIH0KICB9LAogIHJlbmRlckl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpKSB7CiAgICBpZiAoIXRoaXMuaXRlbVRlbXBsYXRlICYmICF0aGlzLml0ZW1WaWV3KSB7CiAgICAgIGFzc2lnblRlbXBsYXRlLmNhbGwodGhpcywgJ2l0ZW1UZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctaXRlbScsCiAgICAgICAgLy8gb25seSByZXF1aXJlIGFuIGl0ZW1UZW1wbGF0ZSBpZiBhbiBpdGVtVmlldwogICAgICAgIC8vIGlzIG5vdCBwcmVzZW50CiAgICAgICAgcmVxdWlyZWQ6ICF0aGlzLml0ZW1WaWV3CiAgICAgIH0pOwogICAgfQogICAgaWYgKHRoaXMuaXRlbVZpZXcpIHsKICAgICAgdmFyIHZpZXdPcHRpb25zID0gewogICAgICAgIG1vZGVsOiBtb2RlbAogICAgICB9OwogICAgICBpZiAodGhpcy5pdGVtVGVtcGxhdGUpIHsKICAgICAgICB2aWV3T3B0aW9ucy50ZW1wbGF0ZSA9IHRoaXMuaXRlbVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuaXRlbVZpZXcsIHZpZXdPcHRpb25zKTsKICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLnJlbmRlclRlbXBsYXRlKHRoaXMuaXRlbVRlbXBsYXRlLCB0aGlzLml0ZW1Db250ZXh0KG1vZGVsLCBpKSk7CiAgICB9CiAgfSwKICBpdGVtQ29udGV4dDogZnVuY3Rpb24obW9kZWwgLyosIGkgKi8pIHsKICAgIHJldHVybiBtb2RlbC5hdHRyaWJ1dGVzOwogIH0sCiAgYXBwZW5kRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICRlbC5lbXB0eSgpOwogICAgdmFyIGVtcHR5Q29udGVudCA9IHRoaXMucmVuZGVyRW1wdHkoKTsKICAgIGVtcHR5Q29udGVudCAmJiB0aGlzLmFwcGVuZEl0ZW0oZW1wdHlDb250ZW50LCAwLCB7CiAgICAgIHNpbGVudDogdHJ1ZSwKICAgICAgZmlsdGVyOiBmYWxzZQogICAgfSk7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOmVtcHR5JywgdGhpcywgdGhpcy5jb2xsZWN0aW9uKTsKICB9LAogIGdldENvbGxlY3Rpb25FbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBlbGVtZW50ID0gdGhpcy4kKHRoaXMuX2NvbGxlY3Rpb25TZWxlY3Rvcik7CiAgICByZXR1cm4gZWxlbWVudC5sZW5ndGggPT09IDAgPyB0aGlzLiRlbCA6IGVsZW1lbnQ7CiAgfQp9KTsKClRob3JheC5Db2xsZWN0aW9uVmlldy5vbih7CiAgY29sbGVjdGlvbjogewogICAgcmVzZXQ6IG9uQ29sbGVjdGlvblJlc2V0LAogICAgc29ydDogb25Db2xsZWN0aW9uUmVzZXQsCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKCkgewogICAgICBhcHBseVZpc2liaWxpdHlGaWx0ZXIuY2FsbCh0aGlzKTsKICAgIH0sCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIC8vIElmIHdlIHJlbmRlcmVkIHdpdGggaXRlbSB2aWV3cywgbW9kZWwgY2hhbmdlcyB3aWxsIGJlIG9ic2VydmVkCiAgICAgIC8vIGJ5IHRoZSBnZW5lcmF0ZWQgaXRlbSB2aWV3IGJ1dCBpZiB3ZSByZW5kZXJlZCB3aXRoIHRlbXBsYXRlcwogICAgICAvLyB0aGVuIG1vZGVsIGNoYW5nZXMgbmVlZCB0byBiZSBib3VuZCBhcyBub3RoaW5nIGlzIHdhdGNoaW5nCiAgICAgICF0aGlzLml0ZW1WaWV3ICYmIHRoaXMudXBkYXRlSXRlbShtb2RlbCk7CiAgICAgIGFwcGx5SXRlbVZpc2libGl0eUZpbHRlci5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDEgJiYgJGVsLmxlbmd0aCAmJiBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5LmNhbGwodGhpcyk7CiAgICAgIGlmICgkZWwubGVuZ3RoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMuYXBwZW5kSXRlbShtb2RlbCwgaW5kZXgpOwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICB0aGlzLnJlbW92ZUl0ZW0obW9kZWwpOwogICAgICB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID09PSAwICYmICRlbC5sZW5ndGggJiYgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0KfSk7CgpUaG9yYXguVmlldy5vbih7CiAgY29sbGVjdGlvbjogewogICAgZXJyb3I6IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIG1lc3NhZ2UpIHsKICAgICAgaWYgKHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtjb2xsZWN0aW9uLmNpZF0uZXJyb3JzKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG1lc3NhZ2UsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIG9uQ29sbGVjdGlvblJlc2V0KGNvbGxlY3Rpb24pIHsKICB2YXIgb3B0aW9ucyA9IGNvbGxlY3Rpb24gJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2NvbGxlY3Rpb24uY2lkXTsKICAvLyB3ZSB3b3VsZCB3YW50IHRvIHN0aWxsIHJlbmRlciBpbiB0aGUgY2FzZSB0aGF0IHRoZQogIC8vIGNvbGxlY3Rpb24gaGFzIHRyYW5zaXRpb25lZCB0byBiZWluZyBmYWxzeQogIGlmICghY29sbGVjdGlvbiB8fCAob3B0aW9ucyAmJiBvcHRpb25zLnJlbmRlcikpIHsKICAgIHRoaXMucmVuZGVyQ29sbGVjdGlvbiAmJiB0aGlzLnJlbmRlckNvbGxlY3Rpb24oKTsKICB9Cn0KCi8vIEV2ZW4gaWYgdGhlIHZpZXcgaXMgbm90IGEgQ29sbGVjdGlvblZpZXcKLy8gZW5zdXJlUmVuZGVyZWQoKSB0byBwcm92aWRlIHNpbWlsYXIgYmVoYXZpb3IKLy8gdG8gYSBtb2RlbApmdW5jdGlvbiBvblNldENvbGxlY3Rpb24oKSB7CiAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwp9CgpmdW5jdGlvbiBhcHBseVZpc2liaWxpdHlGaWx0ZXIoKSB7CiAgaWYgKHRoaXMuaXRlbUZpbHRlcikgewogICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24obW9kZWwpIHsKICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfSwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIobW9kZWwpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuaXRlbUZpbHRlciAmJiAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJylbaXRlbVNob3VsZEJlVmlzaWJsZS5jYWxsKHRoaXMsIG1vZGVsKSA/ICdzaG93JyA6ICdoaWRlJ10oKTsKfQoKZnVuY3Rpb24gaXRlbVNob3VsZEJlVmlzaWJsZShtb2RlbCkgewogIHJldHVybiB0aGlzLml0ZW1GaWx0ZXIobW9kZWwsIHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLnJlbW92ZUNsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLnJlbW92ZUF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSk7CiAgJGVsLmVtcHR5KCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLmFkZENsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLmF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSwgdHJ1ZSk7CiAgdGhpcy5hcHBlbmRFbXB0eSgpOwp9CgovLyQoc2VsZWN0b3IpLmNvbGxlY3Rpb24oKSBoZWxwZXIKJC5mbi5jb2xsZWN0aW9uID0gZnVuY3Rpb24odmlldykgewogIGlmICh2aWV3ICYmIHZpZXcuY29sbGVjdGlvbikgewogICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICB9CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgY29sbGVjdGlvbkVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lICsgJ10nKSwKICAgICAgY29sbGVjdGlvbkNpZCA9IGNvbGxlY3Rpb25FbGVtZW50ICYmIGNvbGxlY3Rpb25FbGVtZW50LmF0dHIoY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChjb2xsZWN0aW9uQ2lkKSB7CiAgICB2aWV3ID0gJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcpIHsKICAgICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgaW5oZXJpdFZhcnMgKi8KCmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCnZhciBvbGRNb2RlbENoYW5nZSA9IGluaGVyaXRWYXJzLm1vZGVsLmNoYW5nZTsKaW5oZXJpdFZhcnMubW9kZWwuY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgb2xkTW9kZWxDaGFuZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAvLyBUT0RPIDogV2hhdCBjYW4gd2UgZG8gdG8gcmVtb3ZlIHRoaXMgZHVwbGljYXRpb24/CiAgdmFyIG1vZGVsT3B0aW9ucyA9IHRoaXMubW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMubW9kZWwuY2lkXTsKICBpZiAobW9kZWxPcHRpb25zICYmIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSkgewogICAgdGhpcy5wb3B1bGF0ZSh0aGlzLm1vZGVsLmF0dHJpYnV0ZXMsIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSA9PT0gdHJ1ZSA/IHt9IDogbW9kZWxPcHRpb25zLnBvcHVsYXRlKTsKICB9Cn07CmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIC8vc2VyaWFsaXplcyBhIGZvcm0gcHJlc2VudCBpbiB0aGUgdmlldywgcmV0dXJuaW5nIHRoZSBzZXJpYWxpemVkIGRhdGEKICAvL2FzIGFuIG9iamVjdAogIC8vcGFzcyB7c2V0OmZhbHNlfSB0byBub3QgdXBkYXRlIHRoaXMubW9kZWwgaWYgcHJlc2VudAogIC8vY2FuIHBhc3Mgb3B0aW9ucywgY2FsbGJhY2sgb3IgZXZlbnQgaW4gYW55IG9yZGVyCiAgc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHZhciBjYWxsYmFjaywgb3B0aW9ucywgZXZlbnQ7CiAgICAvL2lnbm9yZSB1bmRlZmluZWQgYXJndW1lbnRzIGluIGNhc2UgZXZlbnQgd2FzIG51bGwKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oYXJndW1lbnRzW2ldKSkgewogICAgICAgIGNhbGxiYWNrID0gYXJndW1lbnRzW2ldOwogICAgICB9IGVsc2UgaWYgKF8uaXNPYmplY3QoYXJndW1lbnRzW2ldKSkgewogICAgICAgIGlmICgnc3RvcFByb3BhZ2F0aW9uJyBpbiBhcmd1bWVudHNbaV0gJiYgJ3ByZXZlbnREZWZhdWx0JyBpbiBhcmd1bWVudHNbaV0pIHsKICAgICAgICAgIGV2ZW50ID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcHRpb25zID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChldmVudCAmJiAhdGhpcy5fcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb24oZXZlbnQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBvcHRpb25zID0gXy5leHRlbmQoewogICAgICBzZXQ6IHRydWUsCiAgICAgIHZhbGlkYXRlOiB0cnVlLAogICAgICBjaGlsZHJlbjogdHJ1ZSwKICAgICAgc2lsZW50OiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlcyB8fCB7fTsKCiAgICAvL2NhbGxiYWNrIGhhcyBjb250ZXh0IG9mIGVsZW1lbnQKICAgIHZhciB2aWV3ID0gdGhpczsKICAgIHZhciBlcnJvcnMgPSBbXTsKICAgIGVhY2hOYW1lZElucHV0LmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHZpZXcuX2dldElucHV0VmFsdWUodGhpcywgb3B0aW9ucywgZXJyb3JzKTsKICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZS5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIHRoaXMubmFtZSwge21vZGU6ICdzZXJpYWxpemUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG9iamVjdFtrZXldKSkgewogICAgICAgICAgICBvYmplY3Rba2V5XS5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldID0gW29iamVjdFtrZXldLCB2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMudHJpZ2dlcignc2VyaWFsaXplJywgYXR0cmlidXRlcywgb3B0aW9ucyk7CgogICAgaWYgKG9wdGlvbnMudmFsaWRhdGUpIHsKICAgICAgdmFyIHZhbGlkYXRlSW5wdXRFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSW5wdXQoYXR0cmlidXRlcyk7CiAgICAgIGlmICh2YWxpZGF0ZUlucHV0RXJyb3JzICYmIHZhbGlkYXRlSW5wdXRFcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh2YWxpZGF0ZUlucHV0RXJyb3JzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3ZhbGlkYXRlJywgYXR0cmlidXRlcywgZXJyb3JzLCBvcHRpb25zKTsKICAgICAgaWYgKGVycm9ycy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgZXJyb3JzKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0aW9ucy5zZXQgJiYgdGhpcy5tb2RlbCkgewogICAgICBpZiAoIXRoaXMubW9kZWwuc2V0KGF0dHJpYnV0ZXMsIHtzaWxlbnQ6IG9wdGlvbnMuc2lsZW50fSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIF8uYmluZChyZXNldFN1Ym1pdFN0YXRlLCB0aGlzKSk7CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9LAoKICBfcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb246IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjaykgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICB2YXIgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KTsKICAgIGlmICgoZXZlbnQudGFyZ2V0LnRhZ05hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgIT09ICdmb3JtJykgewogICAgICAvLyBIYW5kbGUgbm9uLXN1Ym1pdCBldmVudHMgYnkgZ2F0aW5nIG9uIHRoZSBmb3JtCiAgICAgIGZvcm0gPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgnZm9ybScpOwogICAgfQoKICAgIGlmICghZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JykpIHsKICAgICAgZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JywgJ3RydWUnKTsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLy9wb3B1bGF0ZSBhIGZvcm0gZnJvbSB0aGUgcGFzc2VkIGF0dHJpYnV0ZXMgb3IgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgcG9wdWxhdGU6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgIHZhciB2YWx1ZSwgYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwogICAgLy9jYWxsYmFjayBoYXMgY29udGV4dCBvZiBlbGVtZW50CiAgICBlYWNoTmFtZWRJbnB1dC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uKCkgewogICAgICBvYmplY3RBbmRLZXlGcm9tQXR0cmlidXRlc0FuZE5hbWUuY2FsbCh0aGlzLCBhdHRyaWJ1dGVzLCB0aGlzLm5hbWUsIHttb2RlOiAncG9wdWxhdGUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICBpZiAob2JqZWN0ICYmICFfLmlzVW5kZWZpbmVkKHZhbHVlID0gb2JqZWN0W2tleV0pKSB7CiAgICAgICAgICAvL3dpbGwgb25seSBleGVjdXRlIGlmIHdlIGhhdmUgYSBuYW1lIHRoYXQgbWF0Y2hlcyB0aGUgc3RydWN0dXJlIGluIGF0dHJpYnV0ZXMKICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdjaGVja2JveCcgJiYgXy5pc0Jvb2xlYW4odmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnR5cGUgPT09ICdjaGVja2JveCcgfHwgdGhpcy50eXBlID09PSAncmFkaW8nKSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IHZhbHVlID09IHRoaXMudmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgIHRoaXMudHJpZ2dlcigncG9wdWxhdGUnLCBhdHRyaWJ1dGVzKTsKICB9LAoKICAvL3BlcmZvcm0gZm9ybSB2YWxpZGF0aW9uLCBpbXBsZW1lbnRlZCBieSBjaGlsZCBjbGFzcwogIHZhbGlkYXRlSW5wdXQ6IGZ1bmN0aW9uKC8qIGF0dHJpYnV0ZXMsIG9wdGlvbnMsIGVycm9ycyAqLykge30sCgogIF9nZXRJbnB1dFZhbHVlOiBmdW5jdGlvbihpbnB1dCAvKiAsIG9wdGlvbnMsIGVycm9ycyAqLykgewogICAgaWYgKGlucHV0LnR5cGUgPT09ICdjaGVja2JveCcgfHwgaW5wdXQudHlwZSA9PT0gJ3JhZGlvJykgewogICAgICBpZiAoaW5wdXQuY2hlY2tlZCkgewogICAgICAgIHJldHVybiBpbnB1dC52YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpbnB1dC5tdWx0aXBsZSA9PT0gdHJ1ZSkgewogICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICQoJ29wdGlvbicsIGlucHV0KS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkKSB7CiAgICAgICAgICB2YWx1ZXMucHVzaCh0aGlzLnZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gdmFsdWVzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGlucHV0LnZhbHVlOwogICAgfQogIH0KfSk7CgpUaG9yYXguVmlldy5vbih7CiAgZXJyb3I6IGZ1bmN0aW9uKCkgewogICAgcmVzZXRTdWJtaXRTdGF0ZS5jYWxsKHRoaXMpOwoKICAgIC8vIElmIHdlIGVycm9yZWQgd2l0aCBhIG1vZGVsIHdlIHdhbnQgdG8gcmVzZXQgdGhlIGNvbnRlbnQgYnV0IGxlYXZlIHRoZSBVSQogICAgLy8gaW50YWN0LiBJZiB0aGUgdXNlciB1cGRhdGVzIHRoZSBkYXRhIGFuZCBzZXJpYWxpemVzIGFueSBvdmVyd3JpdHRlbiBkYXRhCiAgICAvLyB3aWxsIGJlIHJlc3RvcmVkLgogICAgaWYgKHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5wcmV2aW91c0F0dHJpYnV0ZXMpIHsKICAgICAgdGhpcy5tb2RlbC5zZXQodGhpcy5tb2RlbC5wcmV2aW91c0F0dHJpYnV0ZXMoKSwgewogICAgICAgIHNpbGVudDogdHJ1ZQogICAgICB9KTsKICAgIH0KICB9LAogIGRlYWN0aXZhdGVkOiBmdW5jdGlvbigpIHsKICAgIHJlc2V0U3VibWl0U3RhdGUuY2FsbCh0aGlzKTsKICB9Cn0pOwoKZnVuY3Rpb24gZWFjaE5hbWVkSW5wdXQob3B0aW9ucywgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIgaSA9IDAsCiAgICAgIHNlbGYgPSB0aGlzOwoKICB0aGlzLiQoJ3NlbGVjdCxpbnB1dCx0ZXh0YXJlYScsIG9wdGlvbnMucm9vdCB8fCB0aGlzLmVsKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgaWYgKCFvcHRpb25zLmNoaWxkcmVuKSB7CiAgICAgIGlmIChzZWxmICE9PSAkKHRoaXMpLnZpZXcoe2hlbHBlcjogZmFsc2V9KSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMudHlwZSAhPT0gJ2J1dHRvbicgJiYgdGhpcy50eXBlICE9PSAnY2FuY2VsJyAmJiB0aGlzLnR5cGUgIT09ICdzdWJtaXQnICYmIHRoaXMubmFtZSAmJiB0aGlzLm5hbWUgIT09ICcnKSB7CiAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCB8fCB0aGlzLCBpLCB0aGlzKTsKICAgICAgKytpOwogICAgfQogIH0pOwp9CgovL2NhbGxzIGEgY2FsbGJhY2sgd2l0aCB0aGUgY29ycmVjdCBvYmplY3QgZnJhZ21lbnQgYW5kIGtleSBmcm9tIGEgY29tcG91bmQgbmFtZQpmdW5jdGlvbiBvYmplY3RBbmRLZXlGcm9tQXR0cmlidXRlc0FuZE5hbWUoYXR0cmlidXRlcywgbmFtZSwgb3B0aW9ucywgY2FsbGJhY2spIHsKICB2YXIga2V5LAogICAgICBvYmplY3QgPSBhdHRyaWJ1dGVzLAogICAgICBrZXlzID0gbmFtZS5zcGxpdCgnWycpLAogICAgICBtb2RlID0gb3B0aW9ucy5tb2RlOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoIC0gMTsgKytpKSB7CiAgICBrZXkgPSBrZXlzW2ldLnJlcGxhY2UoJ10nLCAnJyk7CiAgICBpZiAoIW9iamVjdFtrZXldKSB7CiAgICAgIGlmIChtb2RlID09PSAnc2VyaWFsaXplJykgewogICAgICAgIG9iamVjdFtrZXldID0ge307CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwodGhpcywgZmFsc2UsIGtleSk7CiAgICAgIH0KICAgIH0KICAgIG9iamVjdCA9IG9iamVjdFtrZXldOwogIH0KICBrZXkgPSBrZXlzW2tleXMubGVuZ3RoIC0gMV0ucmVwbGFjZSgnXScsICcnKTsKICBjYWxsYmFjay5jYWxsKHRoaXMsIG9iamVjdCwga2V5KTsKfQoKZnVuY3Rpb24gcmVzZXRTdWJtaXRTdGF0ZSgpIHsKICB0aGlzLiQoJ2Zvcm0nKS5yZW1vdmVBdHRyKCdkYXRhLXN1Ym1pdC13YWl0Jyk7Cn0KCjs7CnZhciBsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtbGF5b3V0LWNpZCc7CgpUaG9yYXguTGF5b3V0VmlldyA9IFRob3JheC5WaWV3LmV4dGVuZCh7CiAgX2RlZmF1bHRUZW1wbGF0ZTogSGFuZGxlYmFycy5WTS5ub29wLAogIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguVmlldy5wcm90b3R5cGUucmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAodGhpcy50ZW1wbGF0ZSA9PT0gSGFuZGxlYmFycy5WTS5ub29wKSB7CiAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIHRlbXBsYXRlIHNldFZpZXcgd2lsbCBhcHBlbmQgdG8gdGhpcy4kZWwKICAgICAgZW5zdXJlTGF5b3V0Q2lkLmNhbGwodGhpcyk7CiAgICB9IGVsc2UgewogICAgICAvLyBpZiBhIHRlbXBsYXRlIHdhcyBzcGVjaWZpZWQgaXMgbXVzdCBkZWNsYXJlIGEgbGF5b3V0LWVsZW1lbnQKICAgICAgZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcyk7CiAgICB9CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICBzZXRWaWV3OiBmdW5jdGlvbih2aWV3LCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5leHRlbmQoewogICAgICBzY3JvbGw6IHRydWUsCiAgICAgIGRlc3Ryb3k6IHRydWUKICAgIH0sIG9wdGlvbnMgfHwge30pOwogICAgaWYgKF8uaXNTdHJpbmcodmlldykpIHsKICAgICAgdmlldyA9IG5ldyAoVGhvcmF4LlV0aWwucmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCB2aWV3LCBmYWxzZSkpKCk7CiAgICB9CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICB2YXIgb2xkVmlldyA9IHRoaXMuX3ZpZXc7CiAgICBpZiAodmlldyA9PT0gb2xkVmlldykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAob3B0aW9ucy5kZXN0cm95ICYmIHZpZXcpIHsKICAgICAgdmlldy5fc2hvdWxkRGVzdHJveU9uTmV4dFNldFZpZXcgPSB0cnVlOwogICAgfQoKICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOnZpZXc6c3RhcnQnLCB2aWV3LCBvbGRWaWV3LCBvcHRpb25zKTsKCiAgICBpZiAob2xkVmlldykgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChvbGRWaWV3KTsKICAgICAgb2xkVmlldy4kZWwucmVtb3ZlKCk7CiAgICAgIHRyaWdnZXJMaWZlY3ljbGVFdmVudC5jYWxsKG9sZFZpZXcsICdkZWFjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICBpZiAob2xkVmlldy5fc2hvdWxkRGVzdHJveU9uTmV4dFNldFZpZXcpIHsKICAgICAgICBvbGRWaWV3LmRlc3Ryb3koKTsKICAgICAgfQogICAgfQoKICAgIGlmICh2aWV3KSB7CiAgICAgIHRyaWdnZXJMaWZlY3ljbGVFdmVudC5jYWxsKHRoaXMsICdhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgdmlldy50cmlnZ2VyKCdhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgdGhpcy5fYWRkQ2hpbGQodmlldyk7CiAgICAgIHRoaXMuX3ZpZXcgPSB2aWV3OwogICAgICB0aGlzLl92aWV3LmFwcGVuZFRvKGdldExheW91dFZpZXdzVGFyZ2V0RWxlbWVudC5jYWxsKHRoaXMpKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3ZpZXcgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6dmlldzplbmQnLCB2aWV3LCBvbGRWaWV3LCBvcHRpb25zKTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIGdldFZpZXc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXc7CiAgfQp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xheW91dC1lbGVtZW50JywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciB2aWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKICAvLyBkdWNrIHR5cGUgY2hlY2sgZm9yIExheW91dFZpZXcKICBpZiAoIXZpZXcuZ2V0VmlldykgewogICAgdGhyb3cgbmV3IEVycm9yKCdsYXlvdXQtZWxlbWVudCBtdXN0IGJlIHVzZWQgd2l0aGluIGEgTGF5b3V0VmlldycpOwogIH0KICBvcHRpb25zLmhhc2hbbGF5b3V0Q2lkQXR0cmlidXRlTmFtZV0gPSB2aWV3LmNpZDsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIG9wdGlvbnMuaGFzaCwgJycsIHRoaXMpKTsKfSk7CgpmdW5jdGlvbiB0cmlnZ2VyTGlmZWN5Y2xlRXZlbnQoZXZlbnROYW1lLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgb3B0aW9ucy50YXJnZXQgPSB0aGlzOwogIHRoaXMudHJpZ2dlcihldmVudE5hbWUsIG9wdGlvbnMpOwogIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgY2hpbGQudHJpZ2dlcihldmVudE5hbWUsIG9wdGlvbnMpOwogIH0pOwp9CgpmdW5jdGlvbiBlbnN1cmVMYXlvdXRDaWQoKSB7CiAgKyt0aGlzLl9yZW5kZXJDb3VudDsKICAvL3NldCB0aGUgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSBvbiB0aGlzLiRlbCBpZiB0aGVyZSB3YXMgbm8gdGVtcGxhdGUKICB0aGlzLiRlbC5hdHRyKGxheW91dENpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKfQoKZnVuY3Rpb24gZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIGlmICghdGhpcy4kKCdbJyArIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgdGhpcy5jaWQgKyAnIl0nKVswXSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdObyBsYXlvdXQgZWxlbWVudCBmb3VuZCBpbiAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkpOwogIH0KfQoKZnVuY3Rpb24gZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIHJldHVybiB0aGlzLiQoJ1snICsgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNpZCArICciXScpWzBdIHx8IHRoaXMuZWxbMF0gfHwgdGhpcy5lbDsKfQoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyICovCgovL1JvdXRlcgpmdW5jdGlvbiBpbml0aWFsaXplUm91dGVyKCkgewogIEJhY2tib25lLmhpc3RvcnkgfHwgKEJhY2tib25lLmhpc3RvcnkgPSBuZXcgQmFja2JvbmUuSGlzdG9yeSgpKTsKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIG9uUm91dGUsIHRoaXMpOwogIC8vcm91dGVyIGRvZXMgbm90IGhhdmUgYSBidWlsdCBpbiBkZXN0cm95IGV2ZW50CiAgLy9idXQgVmlld0NvbnRyb2xsZXIgZG9lcwogIHRoaXMub24oJ2Rlc3Ryb3llZCcsIGZ1bmN0aW9uKCkgewogICAgQmFja2JvbmUuaGlzdG9yeS5vZmYoJ3JvdXRlJywgb25Sb3V0ZSwgdGhpcyk7CiAgfSk7Cn0KClRob3JheC5Sb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguUm91dGVyLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaW5pdGlhbGl6ZVJvdXRlci5jYWxsKHRoaXMpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgaWYgKCFjYWxsYmFjaykgewogICAgICBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICB9CiAgICAvL2FkZCBhIHJvdXRlOmJlZm9yZSBldmVudCB0aGF0IGlzIGZpcmVkIGJlZm9yZSB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkCiAgICByZXR1cm4gQmFja2JvbmUuUm91dGVyLnByb3RvdHlwZS5yb3V0ZS5jYWxsKHRoaXMsIHJvdXRlLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGU6YmVmb3JlJywgcm91dGUsIG5hbWVdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSk7CiAgfQp9KTsKClRob3JheC5Sb3V0ZXJzID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguUm91dGVyLCBUaG9yYXguUm91dGVycyk7CgpmdW5jdGlvbiBvblJvdXRlKHJvdXRlciAvKiAsIG5hbWUgKi8pIHsKICBpZiAodGhpcyA9PT0gcm91dGVyKSB7CiAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZSddLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfQp9Cgo7OwpUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcgPSBUaG9yYXguQ29sbGVjdGlvblZpZXcuZXh0ZW5kKHsKICAvLyBGb3J3YXJkIHJlbmRlciBldmVudHMgdG8gdGhlIHBhcmVudAogIGV2ZW50czogewogICAgJ3JlbmRlcmVkOml0ZW0nOiBmb3J3YXJkUmVuZGVyRXZlbnQoJ3JlbmRlcmVkOml0ZW0nKSwKICAgICdyZW5kZXJlZDpjb2xsZWN0aW9uJzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDpjb2xsZWN0aW9uJyksCiAgICAncmVuZGVyZWQ6ZW1wdHknOiBmb3J3YXJkUmVuZGVyRXZlbnQoJ3JlbmRlcmVkOmVtcHR5JykKICB9LAoKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgXy5lYWNoKGNvbGxlY3Rpb25PcHRpb25OYW1lcywgZnVuY3Rpb24odmlld0F0dHJpYnV0ZU5hbWUsIGhlbHBlck9wdGlvbk5hbWUpIHsKICAgICAgaWYgKG9wdGlvbnMub3B0aW9uc1toZWxwZXJPcHRpb25OYW1lXSkgewogICAgICAgIHZhciB2YWx1ZSA9IG9wdGlvbnMub3B0aW9uc1toZWxwZXJPcHRpb25OYW1lXTsKICAgICAgICBpZiAodmlld0F0dHJpYnV0ZU5hbWUgPT09ICdpdGVtVGVtcGxhdGUnIHx8IHZpZXdBdHRyaWJ1dGVOYW1lID09PSAnZW1wdHlUZW1wbGF0ZScpIHsKICAgICAgICAgIHZhbHVlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBvcHRpb25zW3ZpZXdBdHRyaWJ1dGVOYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICAgIC8vIEhhbmRsZWJhcnMuVk0ubm9vcCBpcyBwYXNzZWQgaW4gdGhlIGhhbmRsZWJhcnMgb3B0aW9ucyBvYmplY3QgYXMKICAgIC8vIGEgZGVmYXVsdCBmb3IgZm4gYW5kIGludmVyc2UsIGlmIGEgYmxvY2sgd2FzIHByZXNlbnQuIE5lZWQgdG8KICAgIC8vIGNoZWNrIHRvIGVuc3VyZSB3ZSBkb24ndCBwaWNrIHRoZSBlbXB0eSAvIG51bGwgYmxvY2sgdXAuCiAgICBpZiAoIW9wdGlvbnMuaXRlbVRlbXBsYXRlICYmIG9wdGlvbnMudGVtcGxhdGUgJiYgb3B0aW9ucy50ZW1wbGF0ZSAhPT0gSGFuZGxlYmFycy5WTS5ub29wKSB7CiAgICAgIG9wdGlvbnMuaXRlbVRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZTsKICAgICAgb3B0aW9ucy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0ubm9vcDsKICAgIH0KICAgIGlmICghb3B0aW9ucy5lbXB0eVRlbXBsYXRlICYmIG9wdGlvbnMuaW52ZXJzZSAmJiBvcHRpb25zLmludmVyc2UgIT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICBvcHRpb25zLmVtcHR5VGVtcGxhdGUgPSBvcHRpb25zLmludmVyc2U7CiAgICAgIG9wdGlvbnMuaW52ZXJzZSA9IEhhbmRsZWJhcnMuVk0ubm9vcDsKICAgIH0KICAgIHZhciByZXNwb25zZSA9IFRob3JheC5IZWxwZXJWaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICBpZiAodGhpcy5wYXJlbnQubmFtZSkgewogICAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSkgewogICAgICAgIHRoaXMuZW1wdHlUZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMucGFyZW50Lm5hbWUgKyAnLWVtcHR5JywgdHJ1ZSk7CiAgICAgIH0KICAgICAgaWYgKCF0aGlzLml0ZW1UZW1wbGF0ZSkgewogICAgICAgIC8vIGl0ZW0gdGVtcGxhdGUgbXVzdCBiZSBwcmVzZW50IGlmIGFuIGl0ZW1WaWV3IGlzIG5vdAogICAgICAgIHRoaXMuaXRlbVRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5wYXJlbnQubmFtZSArICctaXRlbScsICEhdGhpcy5pdGVtVmlldyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICBzZXRBc1ByaW1hcnlDb2xsZWN0aW9uSGVscGVyOiBmdW5jdGlvbigpIHsKICAgIF8uZWFjaChmb3J3YXJkYWJsZVByb3BlcnRpZXMsIGZ1bmN0aW9uKHByb3BlcnR5TmFtZSkgewogICAgICBmb3J3YXJkTWlzc2luZ1Byb3BlcnR5LmNhbGwodGhpcywgcHJvcGVydHlOYW1lKTsKICAgIH0sIHRoaXMpOwogICAgaWYgKHRoaXMucGFyZW50Lml0ZW1GaWx0ZXIgJiYgIXRoaXMuaXRlbUZpbHRlcikgewogICAgICB0aGlzLml0ZW1GaWx0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQuaXRlbUZpbHRlci5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIGlmICh0aGlzLnBhcmVudC5pdGVtQ29udGV4dCkgewogICAgICB0aGlzLml0ZW1Db250ZXh0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50Lml0ZW1Db250ZXh0LmFwcGx5KHRoaXMucGFyZW50LCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIH0KfSk7CgpfLmV4dGVuZChUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcucHJvdG90eXBlLCBoZWxwZXJWaWV3UHJvdG90eXBlKTsKCnZhciBjb2xsZWN0aW9uT3B0aW9uTmFtZXMgPSB7CiAgJ2l0ZW0tdGVtcGxhdGUnOiAnaXRlbVRlbXBsYXRlJywKICAnZW1wdHktdGVtcGxhdGUnOiAnZW1wdHlUZW1wbGF0ZScsCiAgJ2l0ZW0tdmlldyc6ICdpdGVtVmlldycsCiAgJ2VtcHR5LXZpZXcnOiAnZW1wdHlWaWV3JywKICAnZW1wdHktY2xhc3MnOiAnZW1wdHlDbGFzcycKfTsKCmZ1bmN0aW9uIGZvcndhcmRSZW5kZXJFdmVudChldmVudE5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpOwogICAgYXJncy51bnNoaWZ0KGV2ZW50TmFtZSk7CiAgICB0aGlzLnBhcmVudC50cmlnZ2VyLmFwcGx5KHRoaXMucGFyZW50LCBhcmdzKTsKICB9Cn0KCnZhciBmb3J3YXJkYWJsZVByb3BlcnRpZXMgPSBbCiAgJ2l0ZW1UZW1wbGF0ZScsCiAgJ2l0ZW1WaWV3JywKICAnZW1wdHlUZW1wbGF0ZScsCiAgJ2VtcHR5VmlldycKXTsKCmZ1bmN0aW9uIGZvcndhcmRNaXNzaW5nUHJvcGVydHkocHJvcGVydHlOYW1lKSB7CiAgdmFyIHBhcmVudCA9IGdldFBhcmVudCh0aGlzKTsKICBpZiAoIXRoaXNbcHJvcGVydHlOYW1lXSkgewogICAgdmFyIHByb3AgPSBwYXJlbnRbcHJvcGVydHlOYW1lXTsKICAgIGlmIChwcm9wKXsKICAgICAgdGhpc1twcm9wZXJ0eU5hbWVdID0gcHJvcDsKICAgIH0KICB9Cn0KCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyKCdjb2xsZWN0aW9uJywgVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LCBmdW5jdGlvbihjb2xsZWN0aW9uLCB2aWV3KSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHZpZXcgPSBjb2xsZWN0aW9uOwogICAgY29sbGVjdGlvbiA9IHZpZXcucGFyZW50LmNvbGxlY3Rpb247CiAgICBjb2xsZWN0aW9uICYmIHZpZXcuc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcigpOwogICAgdmlldy4kZWwuYXR0cihjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUsICd0cnVlJyk7CiAgICAvLyBwcm9wYWdhdGUgZnV0dXJlIGNoYW5nZXMgdG8gdGhlIHBhcmVudCdzIGNvbGxlY3Rpb24gb2JqZWN0CiAgICAvLyB0byB0aGUgaGVscGVyIHZpZXcKICAgIHZpZXcubGlzdGVuVG8odmlldy5wYXJlbnQsICdjaGFuZ2U6ZGF0YS1vYmplY3QnLCBmdW5jdGlvbih0eXBlLCBkYXRhT2JqZWN0KSB7CiAgICAgIGlmICh0eXBlID09PSAnY29sbGVjdGlvbicpIHsKICAgICAgICB2aWV3LnNldEFzUHJpbWFyeUNvbGxlY3Rpb25IZWxwZXIoKTsKICAgICAgICB2aWV3LnNldENvbGxlY3Rpb24oZGF0YU9iamVjdCk7CiAgICAgIH0KICAgIH0pOwogIH0KICBjb2xsZWN0aW9uICYmIHZpZXcuc2V0Q29sbGVjdGlvbihjb2xsZWN0aW9uKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdjb2xsZWN0aW9uLWVsZW1lbnQnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgaWYgKCFnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LnJlbmRlckNvbGxlY3Rpb24pIHsKICAgIHRocm93IG5ldyBFcnJvcigiY29sbGVjdGlvbi1lbGVtZW50IGhlbHBlciBtdXN0IGJlIGRlY2xhcmVkIGluc2lkZSBvZiBhIENvbGxlY3Rpb25WaWV3Iik7CiAgfQogIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoOwogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKGhhc2gpOwogIGhhc2gudGFnTmFtZSA9IGhhc2gudGFnTmFtZSB8fCAnZGl2JzsKICBoYXNoW2NvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZV0gPSB0cnVlOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIGhhc2gsICcnLCB0aGlzKSk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignZW1wdHknLCBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIG9wdGlvbnMgPSBkYXRhT2JqZWN0OwogIH0KICB2YXIgdmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIGRhdGFPYmplY3QgPSB2aWV3Lm1vZGVsOwogIH0KICAvLyBsaXN0ZW5lcnMgZm9yIHRoZSBlbXB0eSBoZWxwZXIgcmF0aGVyIHRoYW4gbGlzdGVuZXJzCiAgLy8gdGhhdCBhcmUgdGhlbXNlbHZlcyBlbXB0eQogIGlmICghdmlldy5fZW1wdHlMaXN0ZW5lcnMpIHsKICAgIHZpZXcuX2VtcHR5TGlzdGVuZXJzID0ge307CiAgfQogIC8vIGR1Y2sgdHlwZSBjaGVjayBmb3IgY29sbGVjdGlvbgogIGlmIChkYXRhT2JqZWN0ICYmICF2aWV3Ll9lbXB0eUxpc3RlbmVyc1tkYXRhT2JqZWN0LmNpZF0gJiYgZGF0YU9iamVjdC5tb2RlbHMgJiYgKCdsZW5ndGgnIGluIGRhdGFPYmplY3QpKSB7CiAgICB2aWV3Ll9lbXB0eUxpc3RlbmVyc1tkYXRhT2JqZWN0LmNpZF0gPSB0cnVlOwogICAgdmlldy5saXN0ZW5UbyhkYXRhT2JqZWN0LCAncmVtb3ZlJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkYXRhT2JqZWN0Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIHZpZXcucmVuZGVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgdmlldy5saXN0ZW5UbyhkYXRhT2JqZWN0LCAnYWRkJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkYXRhT2JqZWN0Lmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZpZXcucmVuZGVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgdmlldy5saXN0ZW5UbyhkYXRhT2JqZWN0LCAncmVzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgdmlldy5yZW5kZXIoKTsKICAgIH0pOwogIH0KICByZXR1cm4gIWRhdGFPYmplY3QgfHwgZGF0YU9iamVjdC5pc0VtcHR5KCkgPyBvcHRpb25zLmZuKHRoaXMpIDogb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3RlbXBsYXRlJywgZnVuY3Rpb24obmFtZSwgb3B0aW9ucykgewogIHZhciBjb250ZXh0ID0gXy5leHRlbmQoe2ZuOiBvcHRpb25zICYmIG9wdGlvbnMuZm59LCB0aGlzLCBvcHRpb25zID8gb3B0aW9ucy5oYXNoIDoge30pOwogIHZhciBvdXRwdXQgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LnJlbmRlclRlbXBsYXRlKG5hbWUsIGNvbnRleHQpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKG91dHB1dCk7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigneWllbGQnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgcmV0dXJuIGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnlpZWxkICYmIG9wdGlvbnMuZGF0YS55aWVsZCgpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3VybCcsIGZ1bmN0aW9uKHVybCkgewogIHZhciBmcmFnbWVudDsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgIGZyYWdtZW50ID0gXy5tYXAoXy5oZWFkKGFyZ3VtZW50cywgYXJndW1lbnRzLmxlbmd0aCAtIDEpLCBlbmNvZGVVUklDb21wb25lbnQpLmpvaW4oJy8nKTsKICB9IGVsc2UgewogICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHNbMV0sCiAgICAgICAgaGFzaCA9IChvcHRpb25zICYmIG9wdGlvbnMuaGFzaCkgfHwgb3B0aW9uczsKICAgIGlmIChoYXNoICYmIGhhc2hbJ2V4cGFuZC10b2tlbnMnXSkgewogICAgICBmcmFnbWVudCA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHVybCwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICBmcmFnbWVudCA9IHVybDsKICAgIH0KICB9CiAgcmV0dXJuIChCYWNrYm9uZS5oaXN0b3J5Ll9oYXNQdXNoU3RhdGUgPyBCYWNrYm9uZS5oaXN0b3J5Lm9wdGlvbnMucm9vdCA6ICcjJykgKyBmcmFnbWVudDsKfSk7Cgo7OwovKmdsb2JhbCB2aWV3VGVtcGxhdGVPdmVycmlkZXMgKi8KSGFuZGxlYmFycy5yZWdpc3RlclZpZXdIZWxwZXIoJ3ZpZXcnLCB7CiAgZmFjdG9yeTogZnVuY3Rpb24oYXJncywgb3B0aW9ucykgewogICAgdmFyIFZpZXcgPSBhcmdzLmxlbmd0aCA+PSAxID8gYXJnc1swXSA6IFRob3JheC5WaWV3OwogICAgcmV0dXJuIFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZShWaWV3LCBvcHRpb25zLm9wdGlvbnMpOwogIH0sCiAgY2FsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgdmFyIGluc3RhbmNlID0gYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGgtMV0sCiAgICAgICAgb3B0aW9ucyA9IGluc3RhbmNlLl9oZWxwZXJPcHRpb25zLm9wdGlvbnMsCiAgICAgICAgcGxhY2Vob2xkZXJJZCA9IGluc3RhbmNlLmNpZDsKCiAgICBpZiAob3B0aW9ucy5mbikgewogICAgICB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0gPSBvcHRpb25zLmZuOwogICAgfQogIH0KfSk7Cgo7Owp2YXIgY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jYWxsLW1ldGhvZCcsCiAgICB0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdHJpZ2dlci1ldmVudCc7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdidXR0b24nLCBmdW5jdGlvbihtZXRob2QsIG9wdGlvbnMpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgb3B0aW9ucyA9IG1ldGhvZDsKICAgIG1ldGhvZCA9IG9wdGlvbnMuaGFzaC5tZXRob2Q7CiAgfQogIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoLAogICAgICBleHBhbmRUb2tlbnMgPSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgZGVsZXRlIGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBpZiAoIW1ldGhvZCAmJiAhb3B0aW9ucy5oYXNoLnRyaWdnZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigiYnV0dG9uIGhlbHBlciBtdXN0IGhhdmUgYSBtZXRob2QgbmFtZSBhcyB0aGUgZmlyc3QgYXJndW1lbnQgb3IgYSAndHJpZ2dlcicsIG9yIGEgJ21ldGhvZCcgYXR0cmlidXRlIHNwZWNpZmllZC4iKTsKICB9CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMoaGFzaCk7CiAgaGFzaC50YWdOYW1lID0gaGFzaC50YWdOYW1lIHx8ICdidXR0b24nOwogIGhhc2gudHJpZ2dlciAmJiAoaGFzaFt0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lXSA9IGhhc2gudHJpZ2dlcik7CiAgZGVsZXRlIGhhc2gudHJpZ2dlcjsKICBtZXRob2QgJiYgKGhhc2hbY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWVdID0gbWV0aG9kKTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsaW5rJywgZnVuY3Rpb24oKSB7CiAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgb3B0aW9ucyA9IGFyZ3MucG9wKCksCiAgICAgIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgICAgIC8vIHVybCBpcyBhbiBhcnJheSB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSB1cmwgaGVscGVyCiAgICAgIHVybCA9IGFyZ3MubGVuZ3RoID09PSAwID8gW2hhc2guaHJlZl0gOiBhcmdzLAogICAgICBleHBhbmRUb2tlbnMgPSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgZGVsZXRlIGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBpZiAoIXVybFswXSAmJiB1cmxbMF0gIT09ICcnKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImxpbmsgaGVscGVyIHJlcXVpcmVzIGFuIGhyZWYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IG9yIGFuICdocmVmJyBhdHRyaWJ1dGUiKTsKICB9CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMoaGFzaCk7CiAgdXJsLnB1c2gob3B0aW9ucyk7CiAgaGFzaC5ocmVmID0gSGFuZGxlYmFycy5oZWxwZXJzLnVybC5hcHBseSh0aGlzLCB1cmwpOwogIGhhc2gudGFnTmFtZSA9IGhhc2gudGFnTmFtZSB8fCAnYSc7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gb3B0aW9ucy5oYXNoLnRyaWdnZXIpOwogIGRlbGV0ZSBoYXNoLnRyaWdnZXI7CiAgaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSAnX2FuY2hvckNsaWNrJzsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7Cgp2YXIgY2xpY2tTZWxlY3RvciA9ICdbJyArIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lICsgJ10sIFsnICsgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSArICddJzsKCmZ1bmN0aW9uIGhhbmRsZUNsaWNrKGV2ZW50KSB7CiAgdmFyIHRhcmdldCA9ICQoZXZlbnQudGFyZ2V0KSwKICAgICAgdmlldyA9IHRhcmdldC52aWV3KHtoZWxwZXI6IGZhbHNlfSksCiAgICAgIG1ldGhvZE5hbWUgPSB0YXJnZXQuYXR0cihjYWxsTWV0aG9kQXR0cmlidXRlTmFtZSksCiAgICAgIGV2ZW50TmFtZSA9IHRhcmdldC5hdHRyKHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUpLAogICAgICBtZXRob2RSZXNwb25zZSA9IGZhbHNlOwogIG1ldGhvZE5hbWUgJiYgKG1ldGhvZFJlc3BvbnNlID0gdmlld1ttZXRob2ROYW1lXS5jYWxsKHZpZXcsIGV2ZW50KSk7CiAgZXZlbnROYW1lICYmIHZpZXcudHJpZ2dlcihldmVudE5hbWUsIGV2ZW50KTsKICB0YXJnZXQudGFnTmFtZSA9PT0gIkEiICYmIG1ldGhvZFJlc3BvbnNlID09PSBmYWxzZSAmJiBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwp9Cgp2YXIgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZTsKCmZ1bmN0aW9uIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCkgewogIHVucmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICBsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lID0gVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUgfHwgJ2NsaWNrJzsKICAkKGRvY3VtZW50KS5vbihsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lLCBjbGlja1NlbGVjdG9yLCBoYW5kbGVDbGljayk7Cn0KCmZ1bmN0aW9uIHVucmVnaXN0ZXJDbGlja0hhbmRsZXIoKSB7CiAgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSAmJiAkKGRvY3VtZW50KS5vZmYobGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSwgY2xpY2tTZWxlY3RvciwgaGFuZGxlQ2xpY2spOwp9CgokKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHsKICBpZiAoIVRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lKSB7CiAgICByZWdpc3RlckNsaWNrSGFuZGxlcigpOwogIH0KfSk7Cgo7Owp2YXIgZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLWVsZW1lbnQtdG1wJzsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VsZW1lbnQnLCBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMob3B0aW9ucy5oYXNoKTsKICB2YXIgY2lkID0gXy51bmlxdWVJZCgnZWxlbWVudCcpLAogICAgICBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldywKICAgICAgaHRtbEF0dHJpYnV0ZXMgPSBfLnBpY2sob3B0aW9ucy5oYXNoLCBodG1sQXR0cmlidXRlc1RvQ29weSk7CiAgaHRtbEF0dHJpYnV0ZXNbZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZV0gPSBjaWQ7CiAgZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZCB8fCAoZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZCA9IHt9KTsKICBkZWNsYXJpbmdWaWV3Ll9lbGVtZW50c0J5Q2lkW2NpZF0gPSBlbGVtZW50OwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhodG1sQXR0cmlidXRlcykpOwp9KTsKClRob3JheC5WaWV3Lm9uKCdhcHBlbmQnLCBmdW5jdGlvbihzY29wZSwgY2FsbGJhY2spIHsKICAoc2NvcGUgfHwgdGhpcy4kZWwpLmZpbmQoJ1snICsgZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSArICddJykuZm9yRWFjaChmdW5jdGlvbihlbCkgewogICAgdmFyICRlbCA9ICQoZWwpLAogICAgICAgIGNpZCA9ICRlbC5hdHRyKGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUpLAogICAgICAgIGVsZW1lbnQgPSB0aGlzLl9lbGVtZW50c0J5Q2lkW2NpZF07CiAgICAvLyBBIGNhbGxiYWNrIGZ1bmN0aW9uIG1heSBiZSBzcGVjaWZpZWQgYXMgdGhlIHZhbHVlCiAgICBpZiAoXy5pc0Z1bmN0aW9uKGVsZW1lbnQpKSB7CiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LmNhbGwodGhpcyk7CiAgICB9CiAgICAkZWwucmVwbGFjZVdpdGgoZWxlbWVudCk7CiAgICBjYWxsYmFjayAmJiBjYWxsYmFjayhlbGVtZW50KTsKICB9LCB0aGlzKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdzdXBlcicsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcsCiAgICAgIHBhcmVudCA9IGRlY2xhcmluZ1ZpZXcuY29uc3RydWN0b3IgJiYgZGVjbGFyaW5nVmlldy5jb25zdHJ1Y3Rvci5fX3N1cGVyX187CiAgaWYgKHBhcmVudCkgewogICAgdmFyIHRlbXBsYXRlID0gcGFyZW50LnRlbXBsYXRlOwogICAgaWYgKCF0ZW1wbGF0ZSkgewogICAgICBpZiAoIXBhcmVudC5uYW1lKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgdXNlIHN1cGVyIGhlbHBlciB3aGVuIHBhcmVudCBoYXMgbm8gbmFtZSBvciB0ZW1wbGF0ZS4nKTsKICAgICAgfQogICAgICB0ZW1wbGF0ZSA9IHBhcmVudC5uYW1lOwogICAgfQogICAgaWYgKF8uaXNTdHJpbmcodGVtcGxhdGUpKSB7CiAgICAgIHRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGVtcGxhdGUsIGZhbHNlKTsKICAgIH0KICAgIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKHRlbXBsYXRlKHRoaXMsIG9wdGlvbnMpKTsKICB9IGVsc2UgewogICAgcmV0dXJuICcnOwogIH0KfSk7Cgo7OwovKmdsb2JhbCBjb2xsZWN0aW9uT3B0aW9uTmFtZXMsIGluaGVyaXRWYXJzICovCgp2YXIgbG9hZFN0YXJ0ID0gJ2xvYWQ6c3RhcnQnLAogICAgbG9hZEVuZCA9ICdsb2FkOmVuZCcsCiAgICByb290T2JqZWN0OwoKVGhvcmF4LnNldFJvb3RPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICByb290T2JqZWN0ID0gb2JqOwp9OwoKVGhvcmF4LmxvYWRIYW5kbGVyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgY29udGV4dCkgewogIHZhciBsb2FkQ291bnRlciA9IF8udW5pcXVlSWQoKTsKICByZXR1cm4gZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICB2YXIgc2VsZiA9IGNvbnRleHQgfHwgdGhpczsKICAgIHNlbGYuX2xvYWRJbmZvID0gc2VsZi5fbG9hZEluZm8gfHwgW107CiAgICB2YXIgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl07CgogICAgZnVuY3Rpb24gc3RhcnRMb2FkVGltZW91dCgpIHsKCiAgICAgIC8vIElmIHRoZSB0aW1lb3V0IGhhcyBiZWVuIHNldCBhbHJlYWR5IGJ1dCBoYXMgbm90IHRyaWdnZXJlZCB5ZXQgZG8gbm90aGluZwogICAgICAvLyBPdGhlcndpc2Ugc2V0IGEgbmV3IHRpbWVvdXQgKGVpdGhlciBpbml0aWFsIG9yIGZvciBnb2luZyBmcm9tIGJhY2tncm91bmQgdG8KICAgICAgLy8gbm9uLWJhY2tncm91bmQgbG9hZGluZykKICAgICAgaWYgKGxvYWRJbmZvLnRpbWVvdXQgJiYgIWxvYWRJbmZvLnJ1bikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGxvYWRpbmdUaW1lb3V0ID0gc2VsZi5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbiAhPT0gdW5kZWZpbmVkID8KICAgICAgICBzZWxmLl9sb2FkaW5nVGltZW91dER1cmF0aW9uIDogVGhvcmF4LlZpZXcucHJvdG90eXBlLl9sb2FkaW5nVGltZW91dER1cmF0aW9uOwogICAgICBsb2FkSW5mby50aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxvYWRJbmZvLnJ1biA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0LmNhbGwoc2VsZiwgbG9hZEluZm8ubWVzc2FnZSwgbG9hZEluZm8uYmFja2dyb3VuZCwgbG9hZEluZm8pOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2xvYWRTdGFydCcsIGUpOwogICAgICAgICAgfQogICAgICAgIH0sIGxvYWRpbmdUaW1lb3V0ICogMTAwMCk7CiAgICB9CgogICAgaWYgKCFsb2FkSW5mbykgewogICAgICBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXSA9IF8uZXh0ZW5kKHsKICAgICAgICBldmVudHM6IFtdLAogICAgICAgIHRpbWVvdXQ6IDAsCiAgICAgICAgbWVzc2FnZTogbWVzc2FnZSwKICAgICAgICBiYWNrZ3JvdW5kOiAhIWJhY2tncm91bmQKICAgICAgfSwgQmFja2JvbmUuRXZlbnRzKTsKICAgICAgc3RhcnRMb2FkVGltZW91dCgpOwogICAgfSBlbHNlIHsKICAgICAgY2xlYXJUaW1lb3V0KGxvYWRJbmZvLmVuZFRpbWVvdXQpOwoKICAgICAgbG9hZEluZm8ubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgIGlmICghYmFja2dyb3VuZCAmJiBsb2FkSW5mby5iYWNrZ3JvdW5kKSB7CiAgICAgICAgbG9hZEluZm8uYmFja2dyb3VuZCA9IGZhbHNlOwogICAgICAgIHN0YXJ0TG9hZFRpbWVvdXQoKTsKICAgICAgfQogICAgfQoKICAgIC8vIFByZXZlbnQgYmluZHMgdG8gdGhlIHNhbWUgb2JqZWN0IG11bHRpcGxlIHRpbWVzIGFzIHRoaXMgY2FuIGNhdXNlIHZlcnkgYmFkIHRoaW5ncwogICAgLy8gdG8gaGFwcGVuIGZvciB0aGUgbG9hZDtsb2FkO2VuZDtlbmQgZXhlY3V0aW9uIGZsb3cuCiAgICBpZiAobG9hZEluZm8uZXZlbnRzLmluZGV4T2Yob2JqZWN0KSA+PSAwKSB7CiAgICAgIGxvYWRJbmZvLmV2ZW50cy5wdXNoKG9iamVjdCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBsb2FkSW5mby5ldmVudHMucHVzaChvYmplY3QpOwoKICAgIG9iamVjdC5vbihsb2FkRW5kLCBmdW5jdGlvbiBlbmRDYWxsYmFjaygpIHsKICAgICAgdmFyIGxvYWRpbmdFbmRUaW1lb3V0ID0gc2VsZi5fbG9hZGluZ1RpbWVvdXRFbmREdXJhdGlvbjsKICAgICAgaWYgKGxvYWRpbmdFbmRUaW1lb3V0ID09PSB2b2lkIDApIHsKICAgICAgICAvLyBJZiB3ZSBhcmUgcnVubmluZyBvbiBhIG5vbi12aWV3IG9iamVjdCBwdWxsIHRoZSBkZWZhdWx0IHRpbWVvdXQKICAgICAgICBsb2FkaW5nRW5kVGltZW91dCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5fbG9hZGluZ1RpbWVvdXRFbmREdXJhdGlvbjsKICAgICAgfQoKICAgICAgdmFyIGV2ZW50cyA9IGxvYWRJbmZvLmV2ZW50cywKICAgICAgICAgIGluZGV4ID0gZXZlbnRzLmluZGV4T2Yob2JqZWN0KTsKICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICBldmVudHMuc3BsaWNlKGluZGV4LCAxKTsKCiAgICAgICAgaWYgKGV2ZW50cy5pbmRleE9mKG9iamVjdCkgPCAwKSB7CiAgICAgICAgICAvLyBMYXN0IGNhbGxiYWNrIGZvciB0aGlzIHBhcnRpY2xhciBvYmplY3QsIHJlbW92ZSB0aGUgYmluZAogICAgICAgICAgb2JqZWN0Lm9mZihsb2FkRW5kLCBlbmRDYWxsYmFjayk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIWV2ZW50cy5sZW5ndGgpIHsKICAgICAgICBjbGVhclRpbWVvdXQobG9hZEluZm8uZW5kVGltZW91dCk7CiAgICAgICAgbG9hZEluZm8uZW5kVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoIWV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgcnVuID0gbG9hZEluZm8ucnVuOwoKICAgICAgICAgICAgICBpZiAocnVuKSB7CiAgICAgICAgICAgICAgICAvLyBFbWl0IHRoZSBlbmQgYmVoYXZpb3IsIGJ1dCBvbmx5IGlmIHRoZXJlIGlzIGEgcGFpcmVkIHN0YXJ0CiAgICAgICAgICAgICAgICBlbmQuY2FsbChzZWxmLCBsb2FkSW5mby5iYWNrZ3JvdW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICAgICAgICBsb2FkSW5mby50cmlnZ2VyKGxvYWRFbmQsIGxvYWRJbmZvKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHN0b3BwaW5nIG1ha2Ugc3VyZSB3ZSBkb24ndCBydW4gYSBzdGFydAogICAgICAgICAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby50aW1lb3V0KTsKICAgICAgICAgICAgICBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2xvYWRFbmQnLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBsb2FkaW5nRW5kVGltZW91dCAqIDEwMDApOwogICAgICB9CiAgICB9KTsKICB9Owp9OwoKLyoqCiAqIEhlbHBlciBtZXRob2QgZm9yIHByb3BhZ2F0aW5nIGxvYWQ6c3RhcnQgZXZlbnRzIHRvIG90aGVyIG9iamVjdHMuCiAqCiAqIEZvcndhcmRzIGxvYWQ6c3RhcnQgZXZlbnRzIHRoYXQgb2NjdXIgb24gYHNvdXJjZWAgdG8gYGRlc3RgLgogKi8KVGhvcmF4LmZvcndhcmRMb2FkRXZlbnRzID0gZnVuY3Rpb24oc291cmNlLCBkZXN0LCBvbmNlKSB7CiAgZnVuY3Rpb24gbG9hZChtZXNzYWdlLCBiYWNrZ291bmQsIG9iamVjdCkgewogICAgaWYgKG9uY2UpIHsKICAgICAgc291cmNlLm9mZihsb2FkU3RhcnQsIGxvYWQpOwogICAgfQogICAgZGVzdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dvdW5kLCBvYmplY3QpOwogIH0KICBzb3VyY2Uub24obG9hZFN0YXJ0LCBsb2FkKTsKICByZXR1cm4gewogICAgb2ZmOiBmdW5jdGlvbigpIHsKICAgICAgc291cmNlLm9mZihsb2FkU3RhcnQsIGxvYWQpOwogICAgfQogIH07Cn07CgovLwovLyBEYXRhIGxvYWQgZXZlbnQgZ2VuZXJhdGlvbgovLwoKLyoqCiAqIE1peGluZyBmb3IgZ2VuZXJhdGluZyBsb2FkOnN0YXJ0IGFuZCBsb2FkOmVuZCBldmVudHMuCiAqLwpUaG9yYXgubWl4aW5Mb2FkYWJsZSA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICAvL2xvYWRpbmcgY29uZmlnCiAgICBfbG9hZGluZ0NsYXNzTmFtZTogJ2xvYWRpbmcnLAogICAgX2xvYWRpbmdUaW1lb3V0RHVyYXRpb246IDAuMzMsCiAgICBfbG9hZGluZ1RpbWVvdXRFbmREdXJhdGlvbjogMC4xMCwKCiAgICAvLyBQcm9wYWdhdGVzIGxvYWRpbmcgdmlldyBwYXJhbWV0ZXJzIHRvIHRoZSBBSkFYIGxheWVyCiAgICBvbkxvYWRTdGFydDogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwoKICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IHJhY2UgY29uZGl0aW9ucwogICAgICBpZiAoIXRoYXQgfHwgIXRoYXQuZWwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghdGhhdC5ub25CbG9ja2luZ0xvYWQgJiYgIWJhY2tncm91bmQgJiYgcm9vdE9iamVjdCAmJiByb290T2JqZWN0ICE9PSB0aGlzKSB7CiAgICAgICAgcm9vdE9iamVjdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgICAgfQogICAgICB0aGF0Ll9pc0xvYWRpbmcgPSB0cnVlOwogICAgICAkKHRoYXQuZWwpLmFkZENsYXNzKHRoYXQuX2xvYWRpbmdDbGFzc05hbWUpOwogICAgICAvLyB1c2VkIGJ5IGxvYWRpbmcgaGVscGVycwogICAgICB0aGF0LnRyaWdnZXIoJ2NoYW5nZTpsb2FkLXN0YXRlJywgJ3N0YXJ0Jyk7CiAgICB9LAogICAgb25Mb2FkRW5kOiBmdW5jdGlvbigvKiBiYWNrZ3JvdW5kLCBvYmplY3QgKi8pIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CgogICAgICAvLyBQcm90ZWN0IGFnYWluc3QgcmFjZSBjb25kaXRpb25zCiAgICAgIGlmICghdGhhdCB8fCAhdGhhdC5lbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAKICAgICAgdGhhdC5faXNMb2FkaW5nID0gZmFsc2U7CiAgICAgICQodGhhdC5lbCkucmVtb3ZlQ2xhc3ModGhhdC5fbG9hZGluZ0NsYXNzTmFtZSk7CiAgICAgIC8vIHVzZWQgYnkgbG9hZGluZyBoZWxwZXIKICAgICAgdGhhdC50cmlnZ2VyKCdjaGFuZ2U6bG9hZC1zdGF0ZScsICdlbmQnKTsKICAgIH0KICB9KTsKfTsKClRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzID0gZnVuY3Rpb24odGFyZ2V0LCB1c2VQYXJlbnQpIHsKICBfLmV4dGVuZCh0YXJnZXQsIHsKICAgIGxvYWRTdGFydDogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKICAgICAgdGhhdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgdGhhdCk7CiAgICB9LAogICAgbG9hZEVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwogICAgICB0aGF0LnRyaWdnZXIobG9hZEVuZCwgdGhhdCk7CiAgICB9CiAgfSk7Cn07CgpUaG9yYXgubWl4aW5Mb2FkYWJsZShUaG9yYXguVmlldy5wcm90b3R5cGUpOwpUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhUaG9yYXguVmlldy5wcm90b3R5cGUpOwoKCmlmIChUaG9yYXguSGVscGVyVmlldykgewogIFRob3JheC5taXhpbkxvYWRhYmxlKFRob3JheC5IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7CiAgVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKfQoKaWYgKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldykgewogIFRob3JheC5taXhpbkxvYWRhYmxlKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwp9CgpUaG9yYXguc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgZGF0YU9iaiwgb3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpcywKICAgICAgY29tcGxldGUgPSBvcHRpb25zLmNvbXBsZXRlOwoKICBvcHRpb25zLmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CiAgICBzZWxmLl9yZXF1ZXN0ID0gdW5kZWZpbmVkOwogICAgc2VsZi5fYWJvcnRlZCA9IGZhbHNlOwoKICAgIGNvbXBsZXRlICYmIGNvbXBsZXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICB0aGlzLl9yZXF1ZXN0ID0gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICByZXR1cm4gdGhpcy5fcmVxdWVzdDsKfTsKCmZ1bmN0aW9uIGJpbmRUb1JvdXRlKGNhbGxiYWNrLCBmYWlsYmFjaykgewogIHZhciBmcmFnbWVudCA9IEJhY2tib25lLmhpc3RvcnkuZ2V0RnJhZ21lbnQoKSwKICAgICAgcm91dGVDaGFuZ2VkID0gZmFsc2U7CgogIGZ1bmN0aW9uIHJvdXRlSGFuZGxlcigpIHsKICAgIGlmIChmcmFnbWVudCA9PT0gQmFja2JvbmUuaGlzdG9yeS5nZXRGcmFnbWVudCgpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJvdXRlQ2hhbmdlZCA9IHRydWU7CiAgICByZXMuY2FuY2VsKCk7CiAgICBmYWlsYmFjayAmJiBmYWlsYmFjaygpOwogIH0KCiAgQmFja2JvbmUuaGlzdG9yeS5vbigncm91dGUnLCByb3V0ZUhhbmRsZXIpOwoKICBmdW5jdGlvbiBmaW5hbGl6ZXIoKSB7CiAgICBCYWNrYm9uZS5oaXN0b3J5Lm9mZigncm91dGUnLCByb3V0ZUhhbmRsZXIpOwogICAgaWYgKCFyb3V0ZUNoYW5nZWQpIHsKICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CgogIHZhciByZXMgPSBfLmJpbmQoZmluYWxpemVyLCB0aGlzKTsKICByZXMuY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICBCYWNrYm9uZS5oaXN0b3J5Lm9mZigncm91dGUnLCByb3V0ZUhhbmRsZXIpOwogIH07CgogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIGxvYWREYXRhKGNhbGxiYWNrLCBmYWlsYmFjaywgb3B0aW9ucykgewogIGlmICh0aGlzLmlzUG9wdWxhdGVkKCkpIHsKICAgIHJldHVybiBjYWxsYmFjayh0aGlzKTsKICB9CgogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmICFfLmlzRnVuY3Rpb24oZmFpbGJhY2spICYmIF8uaXNPYmplY3QoZmFpbGJhY2spKSB7CiAgICBvcHRpb25zID0gZmFpbGJhY2s7CiAgICBmYWlsYmFjayA9IGZhbHNlOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZSwKICAgICAgc3VjY2Vzc0NhbGxiYWNrID0gYmluZFRvUm91dGUoXy5iaW5kKGNhbGxiYWNrLCBzZWxmKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICBpZiAoc2VsZi5fcmVxdWVzdCkgewogICAgICAgICAgc2VsZi5fYWJvcnRlZCA9IHRydWU7CiAgICAgICAgICBzZWxmLl9yZXF1ZXN0LmFib3J0KCk7CiAgICAgICAgfQogICAgICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrLmNhbGwoc2VsZiwgZmFsc2UpOwogICAgICB9KTsKCiAgdGhpcy5mZXRjaChfLmRlZmF1bHRzKHsKICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDYWxsYmFjaywKICAgIGVycm9yOiBmYWlsYmFjayAmJiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFyb3V0ZUNoYW5nZWQpIHsKICAgICAgICBmYWlsYmFjay5hcHBseShzZWxmLCBbdHJ1ZV0uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgIH0KICAgIH0sCiAgICBjb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHN1Y2Nlc3NDYWxsYmFjay5jYW5jZWwoKTsKICAgIH0KICB9LCBvcHRpb25zKSk7Cn0KCmZ1bmN0aW9uIGZldGNoUXVldWUob3B0aW9ucywgJHN1cGVyKSB7CiAgaWYgKG9wdGlvbnMucmVzZXRRdWV1ZSkgewogICAgLy8gV0FSTjogU2hvdWxkIGVuc3VyZSB0aGF0IGxvYWRlcnMgYXJlIHByb3RlY3RlZCBmcm9tIG91dCBvZiBiYW5kIGRhdGEKICAgIC8vICAgIHdoZW4gdXNpbmcgdGhpcyBvcHRpb24KICAgIHRoaXMuZmV0Y2hRdWV1ZSA9IHVuZGVmaW5lZDsKICB9CgogIGlmICghdGhpcy5mZXRjaFF1ZXVlKSB7CiAgICAvLyBLaWNrIG9mZiB0aGUgcmVxdWVzdAogICAgdGhpcy5mZXRjaFF1ZXVlID0gW29wdGlvbnNdOwogICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoewogICAgICBzdWNjZXNzOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ3N1Y2Nlc3MnKSwKICAgICAgZXJyb3I6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnZXJyb3InKSwKICAgICAgY29tcGxldGU6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnY29tcGxldGUnKQogICAgfSwgb3B0aW9ucyk7CiAgICAkc3VwZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgLy8gQ3VycmVudGx5IGZldGNoaW5nLiBRdWV1ZSBhbmQgcHJvY2VzcyBvbmNlIGNvbXBsZXRlCiAgICB0aGlzLmZldGNoUXVldWUucHVzaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGZsdXNoUXVldWUoc2VsZiwgZmV0Y2hRdWV1ZSwgaGFuZGxlcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgIC8vIEZsdXNoIHRoZSBxdWV1ZS4gRXhlY3V0ZXMgYW55IGNhbGxiYWNrIGhhbmRsZXJzIHRoYXQKICAgIC8vIG1heSBoYXZlIGJlZW4gcGFzc2VkIGluIHRoZSBmZXRjaCBvcHRpb25zLgogICAgXy5lYWNoKGZldGNoUXVldWUsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnNbaGFuZGxlcl0pIHsKICAgICAgICBvcHRpb25zW2hhbmRsZXJdLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICAvLyBSZXNldCB0aGUgcXVldWUgaWYgd2UgYXJlIHN0aWxsIHRoZSBhY3RpdmUgcmVxdWVzdAogICAgaWYgKHNlbGYuZmV0Y2hRdWV1ZSA9PT0gZmV0Y2hRdWV1ZSkgewogICAgICBzZWxmLmZldGNoUXVldWUgPSB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKdmFyIGtsYXNzZXMgPSBbXTsKVGhvcmF4Lk1vZGVsICYmIGtsYXNzZXMucHVzaChUaG9yYXguTW9kZWwpOwpUaG9yYXguQ29sbGVjdGlvbiAmJiBrbGFzc2VzLnB1c2goVGhvcmF4LkNvbGxlY3Rpb24pOwoKXy5lYWNoKGtsYXNzZXMsIGZ1bmN0aW9uKERhdGFDbGFzcykgewogIHZhciAkZmV0Y2ggPSBEYXRhQ2xhc3MucHJvdG90eXBlLmZldGNoOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKERhdGFDbGFzcy5wcm90b3R5cGUsIGZhbHNlKTsKICBfLmV4dGVuZChEYXRhQ2xhc3MucHJvdG90eXBlLCB7CiAgICBzeW5jOiBUaG9yYXguc3luYywKCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgIGNvbXBsZXRlID0gb3B0aW9ucy5jb21wbGV0ZTsKCiAgICAgIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb21wbGV0ZSAmJiBjb21wbGV0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHNlbGYubG9hZEVuZCgpOwogICAgICB9OwogICAgICBzZWxmLmxvYWRTdGFydCh1bmRlZmluZWQsIG9wdGlvbnMuYmFja2dyb3VuZCk7CiAgICAgIHJldHVybiBmZXRjaFF1ZXVlLmNhbGwodGhpcywgb3B0aW9ucyB8fCB7fSwgJGZldGNoKTsKICAgIH0sCgogICAgbG9hZDogZnVuY3Rpb24oY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmICFfLmlzRnVuY3Rpb24oZmFpbGJhY2spKSB7CiAgICAgICAgb3B0aW9ucyA9IGZhaWxiYWNrOwogICAgICAgIGZhaWxiYWNrID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBpZiAoIW9wdGlvbnMuYmFja2dyb3VuZCAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpICYmIHJvb3RPYmplY3QpIHsKICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgZ2xvYmFsIHNjb3BlIHNlZXMgdGhlIHByb3BlciBsb2FkIGV2ZW50cyBoZXJlCiAgICAgICAgLy8gaWYgd2UgYXJlIGxvYWRpbmcgaW4gc3RhbmRhbG9uZSBtb2RlCiAgICAgICAgVGhvcmF4LmZvcndhcmRMb2FkRXZlbnRzKHRoaXMsIHJvb3RPYmplY3QsIHRydWUpOwogICAgICB9CgogICAgICBsb2FkRGF0YS5jYWxsKHRoaXMsIGNhbGxiYWNrLCBmYWlsYmFjaywgb3B0aW9ucyk7CiAgICB9CiAgfSk7Cn0pOwoKVGhvcmF4LlV0aWwuYmluZFRvUm91dGUgPSBiaW5kVG9Sb3V0ZTsKCmlmIChUaG9yYXguUm91dGVyKSB7CiAgVGhvcmF4LlJvdXRlci5iaW5kVG9Sb3V0ZSA9IFRob3JheC5Sb3V0ZXIucHJvdG90eXBlLmJpbmRUb1JvdXRlID0gYmluZFRvUm91dGU7Cn0KCi8vIFByb3BhZ2F0ZXMgbG9hZGluZyB2aWV3IHBhcmFtZXRlcnMgdG8gdGhlIEFKQVggbGF5ZXIKVGhvcmF4LlZpZXcucHJvdG90eXBlLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyA9IGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICBvcHRpb25zLmlnbm9yZUVycm9ycyA9IHRoaXMuaWdub3JlRmV0Y2hFcnJvcjsKICBvcHRpb25zLmJhY2tncm91bmQgPSB0aGlzLm5vbkJsb2NraW5nTG9hZDsKICByZXR1cm4gb3B0aW9uczsKfTsKCi8vIFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldyBpbmhlcml0cyBmcm9tIENvbGxlY3Rpb25WaWV3Ci8vIG5vdCBIZWxwZXJWaWV3IHNvIG5lZWQgdG8gc2V0IGl0IG1hbnVhbGx5ClRob3JheC5IZWxwZXJWaWV3LnByb3RvdHlwZS5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMgPSBUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcucHJvdG90eXBlLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyA9IGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICBvcHRpb25zLmlnbm9yZUVycm9ycyA9IHRoaXMucGFyZW50Lmlnbm9yZUZldGNoRXJyb3I7CiAgb3B0aW9ucy5iYWNrZ3JvdW5kID0gdGhpcy5wYXJlbnQubm9uQmxvY2tpbmdMb2FkOwogIHJldHVybiBvcHRpb25zOwp9OwoKaW5oZXJpdFZhcnMuY29sbGVjdGlvbi5sb2FkaW5nID0gZnVuY3Rpb24oKSB7CiAgdmFyIGxvYWRpbmdWaWV3ID0gdGhpcy5sb2FkaW5nVmlldywKICAgICAgbG9hZGluZ1RlbXBsYXRlID0gdGhpcy5sb2FkaW5nVGVtcGxhdGUsCiAgICAgIGxvYWRpbmdQbGFjZW1lbnQgPSB0aGlzLmxvYWRpbmdQbGFjZW1lbnQ7CiAgLy9hZGQgImxvYWRpbmctdmlldyIgYW5kICJsb2FkaW5nLXRlbXBsYXRlIiBvcHRpb25zIHRvIGNvbGxlY3Rpb24gaGVscGVyCiAgaWYgKGxvYWRpbmdWaWV3IHx8IGxvYWRpbmdUZW1wbGF0ZSkgewogICAgdmFyIGNhbGxiYWNrID0gVGhvcmF4LmxvYWRIYW5kbGVyKF8uYmluZChmdW5jdGlvbigpIHsKICAgICAgdmFyIGl0ZW07CiAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy4kZWwuZW1wdHkoKTsKICAgICAgfQogICAgICBpZiAobG9hZGluZ1ZpZXcpIHsKICAgICAgICB2YXIgaW5zdGFuY2UgPSBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UobG9hZGluZ1ZpZXcpOwogICAgICAgIHRoaXMuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgICBpZiAobG9hZGluZ1RlbXBsYXRlKSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIobG9hZGluZ1RlbXBsYXRlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgfQogICAgICAgIGl0ZW0gPSBpbnN0YW5jZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpdGVtID0gdGhpcy5yZW5kZXJUZW1wbGF0ZShsb2FkaW5nVGVtcGxhdGUpOwogICAgICB9CiAgICAgIHZhciBpbmRleCA9IGxvYWRpbmdQbGFjZW1lbnQKICAgICAgICA/IGxvYWRpbmdQbGFjZW1lbnQuY2FsbCh0aGlzKQogICAgICAgIDogdGhpcy5jb2xsZWN0aW9uLmxlbmd0aAogICAgICA7CiAgICAgIHRoaXMuYXBwZW5kSXRlbShpdGVtLCBpbmRleCk7CiAgICAgIHRoaXMuJGVsLmNoaWxkcmVuKCkuZXEoaW5kZXgpLmF0dHIoJ2RhdGEtbG9hZGluZy1lbGVtZW50JywgdGhpcy5jb2xsZWN0aW9uLmNpZCk7CiAgICB9LCB0aGlzKSwgXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5maW5kKCdbZGF0YS1sb2FkaW5nLWVsZW1lbnQ9IicgKyB0aGlzLmNvbGxlY3Rpb24uY2lkICsgJyJdJykucmVtb3ZlKCk7CiAgICB9LCB0aGlzKSwKICAgIHRoaXMuY29sbGVjdGlvbik7CgogICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdsb2FkOnN0YXJ0JywgY2FsbGJhY2spOwogIH0KfTsKCmlmIChjb2xsZWN0aW9uT3B0aW9uTmFtZXMpIHsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctdGVtcGxhdGUnXSA9ICdsb2FkaW5nVGVtcGxhdGUnOwogIGNvbGxlY3Rpb25PcHRpb25OYW1lc1snbG9hZGluZy12aWV3J10gPSAnbG9hZGluZ1ZpZXcnOwogIGNvbGxlY3Rpb25PcHRpb25OYW1lc1snbG9hZGluZy1wbGFjZW1lbnQnXSA9ICdsb2FkaW5nUGxhY2VtZW50JzsKfQoKVGhvcmF4LlZpZXcub24oewogICdsb2FkOnN0YXJ0JzogVGhvcmF4LmxvYWRIYW5kbGVyKAogICAgICBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgICB0aGlzLm9uTG9hZFN0YXJ0KG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICAgIHRoaXMub25Mb2FkRW5kKG9iamVjdCk7CiAgICAgIH0pLAoKICBjb2xsZWN0aW9uOiB7CiAgICAnbG9hZDpzdGFydCc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB0aGlzLnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgfQogIH0sCiAgbW9kZWw6IHsKICAgICdsb2FkOnN0YXJ0JzogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHRoaXMudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICB9CiAgfQp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvYWRpbmcnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwogIHZpZXcub2ZmKCdjaGFuZ2U6bG9hZC1zdGF0ZScsIG9uTG9hZFN0YXRlQ2hhbmdlLCB2aWV3KTsKICB2aWV3Lm9uKCdjaGFuZ2U6bG9hZC1zdGF0ZScsIG9uTG9hZFN0YXRlQ2hhbmdlLCB2aWV3KTsKICByZXR1cm4gdmlldy5faXNMb2FkaW5nID8gb3B0aW9ucy5mbih0aGlzKSA6IG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKfSk7CgpmdW5jdGlvbiBvbkxvYWRTdGF0ZUNoYW5nZSgpIHsKICB0aGlzLnJlbmRlcigpOwp9Cjs7Ci8qZ2xvYmFsIHB1c2hEb21FdmVudHMgKi8KdmFyIGlzaU9TID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvKGlQaG9uZXxpUG9kfGlQYWQpL2kpLAogICAgaXNBbmRyb2lkID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoImFuZHJvaWQiKSA+IC0xID8gMSA6IDAsCiAgICBtaW5pbXVtU2Nyb2xsWU9mZnNldCA9IGlzQW5kcm9pZCA/IDEgOiAwOwoKVGhvcmF4LlV0aWwuc2Nyb2xsVG8gPSBmdW5jdGlvbih4LCB5KSB7CiAgeSA9IHkgfHwgbWluaW11bVNjcm9sbFlPZmZzZXQ7CiAgZnVuY3Rpb24gX3Njcm9sbFRvKCkgewogICAgd2luZG93LnNjcm9sbFRvKHgsIHkpOwogIH0KICBpZiAoaXNpT1MpIHsKICAgIC8vIGEgZGVmZXIgaXMgcmVxdWlyZWQgZm9yIGlvcwogICAgXy5kZWZlcihfc2Nyb2xsVG8pOwogIH0gZWxzZSB7CiAgICBfc2Nyb2xsVG8oKTsKICB9CiAgcmV0dXJuIFt4LCB5XTsKfTsKClRob3JheC5MYXlvdXRWaWV3Lm9uKCdjaGFuZ2U6dmlldzplbmQnLCBmdW5jdGlvbihuZXdWaWV3LCBvbGRWaWV3LCBvcHRpb25zKSB7CiAgb3B0aW9ucy5zY3JvbGwgJiYgVGhvcmF4LlV0aWwuc2Nyb2xsVG8oMCwgMCk7Cn0pOwoKVGhvcmF4LlV0aWwuc2Nyb2xsVG9Ub3AgPSBmdW5jdGlvbigpIHsKICAvLyBhbmRyb2lkIHdpbGwgdXNlIGhlaWdodCBvZiAxIGJlY2F1c2Ugb2YgbWluaW11bVNjcm9sbFlPZmZzZXQgaW4gc2Nyb2xsVG8oKQogIHJldHVybiB0aGlzLnNjcm9sbFRvKDAsIDApOwp9OwoKcHVzaERvbUV2ZW50cyhbCiAgJ3NpbmdsZVRhcCcsICdkb3VibGVUYXAnLCAnbG9uZ1RhcCcsCiAgJ3N3aXBlJywKICAnc3dpcGVVcCcsICdzd2lwZURvd24nLAogICdzd2lwZUxlZnQnLCAnc3dpcGVSaWdodCcKXSk7CgovL2J1aWx0IGluIGRvbSBldmVudHMKVGhvcmF4LlZpZXcub24oewogICdzdWJtaXQgZm9ybSc6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CiAgICAvLyBIaWRlIGFueSB2aXJ0dWFsIGtleWJvYXJkcyB0aGF0IG1heSBiZSBsaW5nZXJpbmcgYXJvdW5kCiAgICB2YXIgZm9jdXNlZCA9ICQoJzpmb2N1cycpWzBdOwogICAgZm9jdXNlZCAmJiBmb2N1c2VkLmJsdXIoKTsKICB9Cn0pOwoKOzsKLypnbG9iYWwgaXNBbmRyb2lkICovCgokLmZuLnRhcEhvbGRBbmRFbmQgPSBmdW5jdGlvbihzZWxlY3RvciwgY2FsbGJhY2tTdGFydCwgY2FsbGJhY2tFbmQpIHsKICBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQob2JqLCBldmVudFR5cGUsIGNhbGxiYWNrLCBldmVudCkgewogICAgdmFyIG9yaWdpbmFsVHlwZSA9IGV2ZW50LnR5cGUsCiAgICAgICAgcmVzdWx0OwoKICAgIGV2ZW50LnR5cGUgPSBldmVudFR5cGU7CiAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgcmVzdWx0ID0gY2FsbGJhY2suY2FsbChvYmosIGV2ZW50KTsKICAgIH0KICAgIGV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgdmFyIHRpbWVycyA9IFtdOwogIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICB2YXIgdGhpc09iamVjdCA9IHRoaXMsCiAgICAgICAgdGFwSG9sZFN0YXJ0ID0gZmFsc2UsCiAgICAgICAgJHRoaXMgPSAkKHRoaXNPYmplY3QpOwoKICAgICR0aGlzLm9uKCd0b3VjaHN0YXJ0Jywgc2VsZWN0b3IsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHRhcEhvbGRTdGFydCA9IGZhbHNlOwogICAgICB2YXIgb3JpZ0V2ZW50ID0gZXZlbnQsCiAgICAgICAgICB0aW1lcjsKCiAgICAgIGZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoZXZlbnQpIHsKICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwoKICAgICAgICBpZiAodGFwSG9sZFN0YXJ0KSB7CiAgICAgICAgICB2YXIgcmV0dmFsID0gZmFsc2U7CiAgICAgICAgICBpZiAoZXZlbnQpIHsKICAgICAgICAgICAgLy8gV2UgYXJlbid0IHNlbmRpbmcgYW55IGVuZCBldmVudHMgZm9yIHRvdWNoY2FuY2VsIGNhc2VzLAogICAgICAgICAgICAvLyBwcmV2ZW50IGFuIGV4Y2VwdGlvbgogICAgICAgICAgICByZXR2YWwgPSB0cmlnZ2VyRXZlbnQodGhpc09iamVjdCwgJ3RhcEhvbGRFbmQnLCBjYWxsYmFja0VuZCwgZXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHZhbCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgXy5lYWNoKHRpbWVycywgY2xlYXJUaW1lb3V0KTsKICAgICAgICAgICAgdGltZXJzID0gW107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAkKGRvY3VtZW50KS5vbmUoJ3RvdWNoY2FuY2VsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYXJUYXBUaW1lcigpOwoKICAgICAgICAkdGhpcy5vZmYoJ3RvdWNobW92ZScsIHNlbGVjdG9yLCBjbGVhclRhcFRpbWVyKTsKICAgICAgICAkdGhpcy5vZmYoJ3RvdWNoZW5kJywgc2VsZWN0b3IsIGNsZWFyVGFwVGltZXIpOwogICAgICB9KTsKCiAgICAgICR0aGlzLm9uKCd0b3VjaGVuZCcsIHNlbGVjdG9yLCBjbGVhclRhcFRpbWVyKTsKICAgICAgJHRoaXMub24oJ3RvdWNobW92ZScsIHNlbGVjdG9yLCBjbGVhclRhcFRpbWVyKTsKCiAgICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICB0YXBIb2xkU3RhcnQgPSB0cnVlOwogICAgICAgIHZhciByZXR2YWwgPSB0cmlnZ2VyRXZlbnQodGhpc09iamVjdCwgJ3RhcEhvbGRTdGFydCcsIGNhbGxiYWNrU3RhcnQsIG9yaWdFdmVudCk7CiAgICAgICAgaWYgKHJldHZhbCA9PT0gZmFsc2UpIHsKICAgICAgICAgIF8uZWFjaCh0aW1lcnMsIGNsZWFyVGltZW91dCk7CiAgICAgICAgICB0aW1lcnMgPSBbXTsKICAgICAgICB9CiAgICAgIH0sIDE1MCk7CiAgICAgIHRpbWVycy5wdXNoKHRpbWVyKTsKICAgIH0pOwogIH0pOwp9OwoKLy9vbmx5IGVuYWJsZSBvbiBhbmRyb2lkCnZhciB1c2VOYXRpdmVIaWdobGlnaHQgPSAhaXNBbmRyb2lkOwpUaG9yYXguY29uZmlndXJlVGFwSGlnaGxpZ2h0ID0gZnVuY3Rpb24odXNlTmF0aXZlKSB7CiAgdXNlTmF0aXZlSGlnaGxpZ2h0ID0gdXNlTmF0aXZlOwp9OwoKdmFyIE5BVElWRV9UQVBQQUJMRSA9IHsKICAnQSc6IHRydWUsCiAgJ0lOUFVUJzogdHJ1ZSwKICAnQlVUVE9OJzogdHJ1ZSwKICAnU0VMRUNUJzogdHJ1ZSwKICAnVEVYVEFSRUEnOiB0cnVlCn07CgpmdW5jdGlvbiBmaXh1cFRhcEhpZ2hsaWdodChzY29wZSkgewogIF8uZWFjaCh0aGlzLl9kb21FdmVudHMgfHwgW10sIGZ1bmN0aW9uKGJpbmQpIHsKICAgIHZhciBjb21wb25lbnRzID0gYmluZC5zcGxpdCgnICcpLAogICAgICAgIHNlbGVjdG9yID0gY29tcG9uZW50cy5zbGljZSgxKS5qb2luKCcgJykgfHwgdW5kZWZpbmVkOyAgLy8gTmVlZGVkIHRvIG1ha2UgemVwdG8gaGFwcHkKCiAgICBpZiAoY29tcG9uZW50c1swXSA9PT0gJ2NsaWNrJykgewogICAgICAvLyAhc2VsZWN0b3IgY2FzZSBpcyBmb3Igcm9vdCBjbGljayBoYW5kbGVycyBvbiB0aGUgdmlldywgaS5lLiAnY2xpY2snCiAgICAgICQoc2VsZWN0b3IgfHwgdGhpcy5lbCwgc2VsZWN0b3IgJiYgKHNjb3BlIHx8IHRoaXMuZWwpKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyICRlbCA9ICQoZWwpLmRhdGEoJ3RhcHBhYmxlJywgdHJ1ZSk7CgogICAgICAgIGlmICh1c2VOYXRpdmVIaWdobGlnaHQgJiYgIU5BVElWRV9UQVBQQUJMRVtlbC50YWdOYW1lXSkgewogICAgICAgICAgLy8gQWRkIGFuIGV4cGxpY2l0IE5PUCBiaW5kIHRvIGFsbG93IHRhcC1oaWdobGlnaHQgc3VwcG9ydAogICAgICAgICAgJGVsLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge30pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgdGhpcyk7Cn0KCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIF90YXBIaWdobGlnaHRDbGFzc05hbWU6ICdhY3RpdmUnLAogIF90YXBIaWdobGlnaHRTdGFydDogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSBldmVudC5jdXJyZW50VGFyZ2V0LAogICAgICAgIHRhZ05hbWUgPSB0YXJnZXQgJiYgdGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCiAgICAvLyBVc2VyIGlucHV0IGNvbnRyb2xzIG1heSBiZSB2aXN1YWxseSBwYXJ0IG9mIGEgbGFyZ2VyIGdyb3VwLiBGb3IgdGhlc2UgY2FzZXMKICAgIC8vIHdlIHdhbnQgdG8gZ2l2ZSBwcmlvcml0eSB0byBhbnkgcGFyZW50IHRoYXQgbWF5IHByb3ZpZGUgYSBmb2N1cyBvcGVyYXRpb24uCiAgICBpZiAodGFnTmFtZSA9PT0gJ2lucHV0JyB8fCB0YWdOYW1lID09PSAnc2VsZWN0JyB8fCB0YWdOYW1lID09PSAndGV4dGFyZWEnKSB7CiAgICAgIHRhcmdldCA9ICQodGFyZ2V0KS5jbG9zZXN0KCdbZGF0YS10YXBwYWJsZT10cnVlXScpWzBdIHx8IHRhcmdldDsKICAgIH0KCiAgICBpZiAodGFyZ2V0KSB7CiAgICAgICQodGFyZ2V0KS5hZGRDbGFzcyh0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKICBfdGFwSGlnaGxpZ2h0RW5kOiBmdW5jdGlvbigvKiBldmVudCAqLykgewogICAgJCgnLicgKyB0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpLnJlbW92ZUNsYXNzKHRoaXMuX3RhcEhpZ2hsaWdodENsYXNzTmFtZSk7CiAgfQp9KTsKCi8vVE9ETzogZXhhbWluZSBpZiB0aGVzZSBhcmUgc3RpbGwgbmVlZGVkCnZhciBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgZml4dXBUYXBIaWdobGlnaHQuY2FsbCh0aGlzKTsKfTsKClRob3JheC5WaWV3Lm9uKHsKICAncmVuZGVyZWQnOiBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrLAogICdyZW5kZXJlZDpjb2xsZWN0aW9uJzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjaywKICAncmVuZGVyZWQ6aXRlbSc6IGZpeHVwVGFwSGlnaGxpZ2h0Q2FsbGJhY2ssCiAgJ3JlbmRlcmVkOmVtcHR5JzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjawp9KTsKCnZhciBfc2V0RWxlbWVudCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50LAogICAgdGFwSGlnaGxpZ2h0U2VsZWN0b3IgPSAnW2RhdGEtdGFwcGFibGU9dHJ1ZV0sIGEsIGlucHV0LCBidXR0b24sIHNlbGVjdCwgdGV4dGFyZWEnOwoKVGhvcmF4LlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQgPSBmdW5jdGlvbigpIHsKICB2YXIgcmVzcG9uc2UgPSBfc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmICghdGhpcy5ub1RhcEhpZ2hsaWdodCkgewogICAgaWYgKCF1c2VOYXRpdmVIaWdobGlnaHQpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBmdW5jdGlvbiBleGVjKG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZWxmW25hbWVdLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKG5hbWUsIGUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgdGhpcy4kZWwudGFwSG9sZEFuZEVuZCh0YXBIaWdobGlnaHRTZWxlY3RvciwgZXhlYygnX3RhcEhpZ2hsaWdodFN0YXJ0JyksIGV4ZWMoJ190YXBIaWdobGlnaHRFbmQnKSk7CiAgICB9CiAgfQogIHJldHVybiByZXNwb25zZTsKfTsKCnZhciBfYWRkRXZlbnQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2FkZEV2ZW50OwpUaG9yYXguVmlldy5wcm90b3R5cGUuX2FkZEV2ZW50ID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgdGhpcy5fZG9tRXZlbnRzID0gdGhpcy5fZG9tRXZlbnRzIHx8IFtdOwogIGlmIChwYXJhbXMudHlwZSA9PT0gIkRPTSIpIHsKICAgIHRoaXMuX2RvbUV2ZW50cy5wdXNoKHBhcmFtcy5vcmlnaW5hbE5hbWUpOwogIH0KICByZXR1cm4gX2FkZEV2ZW50LmNhbGwodGhpcywgcGFyYW1zKTsKfTsKCjs7CgoKfSkoKTsKCg==",
                "body": "LyogWmVwdG8gdjEuMHJjMSAtIHBvbHlmaWxsIHplcHRvIGV2ZW50IGRldGVjdCBmeCBhamF4IGZvcm0gdG91Y2ggLSB6ZXB0b2pzLmNvbS9saWNlbnNlICovCjsoZnVuY3Rpb24odW5kZWZpbmVkKXsKICBpZiAoU3RyaW5nLnByb3RvdHlwZS50cmltID09PSB1bmRlZmluZWQpIC8vIGZpeCBmb3IgaU9TIDMuMgogICAgU3RyaW5nLnByb3RvdHlwZS50cmltID0gZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sICcnKS5yZXBsYWNlKC9ccyskLywgJycpIH0KCiAgLy8gRm9yIGlPUyAzLngKICAvLyBmcm9tIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L3JlZHVjZQogIGlmIChBcnJheS5wcm90b3R5cGUucmVkdWNlID09PSB1bmRlZmluZWQpCiAgICBBcnJheS5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24oZnVuKXsKICAgICAgaWYodGhpcyA9PT0gdm9pZCAwIHx8IHRoaXMgPT09IG51bGwpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICB2YXIgdCA9IE9iamVjdCh0aGlzKSwgbGVuID0gdC5sZW5ndGggPj4+IDAsIGsgPSAwLCBhY2N1bXVsYXRvcgogICAgICBpZih0eXBlb2YgZnVuICE9ICdmdW5jdGlvbicpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICBpZihsZW4gPT0gMCAmJiBhcmd1bWVudHMubGVuZ3RoID09IDEpIHRocm93IG5ldyBUeXBlRXJyb3IoKQoKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+PSAyKQogICAgICAgYWNjdW11bGF0b3IgPSBhcmd1bWVudHNbMV0KICAgICAgZWxzZQogICAgICAgIGRvewogICAgICAgICAgaWYoayBpbiB0KXsKICAgICAgICAgICAgYWNjdW11bGF0b3IgPSB0W2srK10KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCsrayA+PSBsZW4pIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICAgIH0gd2hpbGUgKHRydWUpCgogICAgICB3aGlsZSAoayA8IGxlbil7CiAgICAgICAgaWYoayBpbiB0KSBhY2N1bXVsYXRvciA9IGZ1bi5jYWxsKHVuZGVmaW5lZCwgYWNjdW11bGF0b3IsIHRba10sIGssIHQpCiAgICAgICAgaysrCiAgICAgIH0KICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yCiAgICB9Cgp9KSgpCnZhciBaZXB0byA9IChmdW5jdGlvbigpIHsKICB2YXIgdW5kZWZpbmVkLCBrZXksICQsIGNsYXNzTGlzdCwgZW1wdHlBcnJheSA9IFtdLCBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsCiAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKICAgIGVsZW1lbnREaXNwbGF5ID0ge30sIGNsYXNzQ2FjaGUgPSB7fSwKICAgIGdldENvbXB1dGVkU3R5bGUgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlLAogICAgY3NzTnVtYmVyID0geyAnY29sdW1uLWNvdW50JzogMSwgJ2NvbHVtbnMnOiAxLCAnZm9udC13ZWlnaHQnOiAxLCAnbGluZS1oZWlnaHQnOiAxLCdvcGFjaXR5JzogMSwgJ3otaW5kZXgnOiAxLCAnem9vbSc6IDEgfSwKICAgIGZyYWdtZW50UkUgPSAvXlxzKjwoXHcrfCEpW14+XSo+LywKCiAgICAvLyBVc2VkIGJ5IGAkLnplcHRvLmluaXRgIHRvIHdyYXAgZWxlbWVudHMsIHRleHQvY29tbWVudCBub2RlcywgZG9jdW1lbnQsCiAgICAvLyBhbmQgZG9jdW1lbnQgZnJhZ21lbnQgbm9kZSB0eXBlcy4KICAgIGVsZW1lbnRUeXBlcyA9IFsxLCAzLCA4LCA5LCAxMV0sCgogICAgYWRqYWNlbmN5T3BlcmF0b3JzID0gWyAnYWZ0ZXInLCAncHJlcGVuZCcsICdiZWZvcmUnLCAnYXBwZW5kJyBdLAogICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0YWJsZScpLAogICAgdGFibGVSb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpLAogICAgY29udGFpbmVycyA9IHsKICAgICAgJ3RyJzogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGJvZHknKSwKICAgICAgJ3Rib2R5JzogdGFibGUsICd0aGVhZCc6IHRhYmxlLCAndGZvb3QnOiB0YWJsZSwKICAgICAgJ3RkJzogdGFibGVSb3csICd0aCc6IHRhYmxlUm93LAogICAgICAnKic6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICB9LAogICAgcmVhZHlSRSA9IC9jb21wbGV0ZXxsb2FkZWR8aW50ZXJhY3RpdmUvLAogICAgY2xhc3NTZWxlY3RvclJFID0gL15cLihbXHctXSspJC8sCiAgICBpZFNlbGVjdG9yUkUgPSAvXiMoW1x3LV0rKSQvLAogICAgdGFnU2VsZWN0b3JSRSA9IC9eW1x3LV0rJC8sCiAgICB0b1N0cmluZyA9ICh7fSkudG9TdHJpbmcsCiAgICB6ZXB0byA9IHt9LAogICAgY2FtZWxpemUsIHVuaXEsCiAgICB0ZW1wUGFyZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKCiAgemVwdG8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIWVsZW1lbnQgfHwgZWxlbWVudC5ub2RlVHlwZSAhPT0gMSkgcmV0dXJuIGZhbHNlCiAgICB2YXIgbWF0Y2hlc1NlbGVjdG9yID0gZWxlbWVudC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9NYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tYXRjaGVzU2VsZWN0b3IKICAgIGlmIChtYXRjaGVzU2VsZWN0b3IpIHJldHVybiBtYXRjaGVzU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3RvcikKICAgIC8vIGZhbGwgYmFjayB0byBwZXJmb3JtaW5nIGEgc2VsZWN0b3I6CiAgICB2YXIgbWF0Y2gsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwgdGVtcCA9ICFwYXJlbnQKICAgIGlmICh0ZW1wKSAocGFyZW50ID0gdGVtcFBhcmVudCkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgIG1hdGNoID0gfnplcHRvLnFzYShwYXJlbnQsIHNlbGVjdG9yKS5pbmRleE9mKGVsZW1lbnQpCiAgICB0ZW1wICYmIHRlbXBQYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgIHJldHVybiBtYXRjaAogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gIltvYmplY3QgRnVuY3Rpb25dIiB9CiAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0IH0KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICB2YXIga2V5LCBjdG9yCiAgICBpZiAodG9TdHJpbmcuY2FsbCh2YWx1ZSkgIT09ICJbb2JqZWN0IE9iamVjdF0iKSByZXR1cm4gZmFsc2UKICAgIGN0b3IgPSAoaXNGdW5jdGlvbih2YWx1ZS5jb25zdHJ1Y3RvcikgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlKQogICAgaWYgKCFjdG9yIHx8ICFoYXNPd25Qcm9wZXJ0eS5jYWxsKGN0b3IsICdpc1Byb3RvdHlwZU9mJykpIHJldHVybiBmYWxzZQogICAgZm9yIChrZXkgaW4gdmFsdWUpOwogICAgcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkKICB9CiAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBBcnJheSB9CiAgZnVuY3Rpb24gbGlrZUFycmF5KG9iaikgeyByZXR1cm4gdHlwZW9mIG9iai5sZW5ndGggPT0gJ251bWJlcicgfQoKICBmdW5jdGlvbiBjb21wYWN0KGFycmF5KSB7IHJldHVybiBhcnJheS5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7IHJldHVybiBpdGVtICE9PSB1bmRlZmluZWQgJiYgaXRlbSAhPT0gbnVsbCB9KSB9CiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSkgeyByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/IFtdLmNvbmNhdC5hcHBseShbXSwgYXJyYXkpIDogYXJyYXkgfQogIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyKXsgcmV0dXJuIHN0ci5yZXBsYWNlKC8tKyguKT8vZywgZnVuY3Rpb24obWF0Y2gsIGNocil7IHJldHVybiBjaHIgPyBjaHIudG9VcHBlckNhc2UoKSA6ICcnIH0pIH0KICBmdW5jdGlvbiBkYXNoZXJpemUoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLzo6L2csICcvJykKICAgICAgICAgICAucmVwbGFjZSgvKFtBLVpdKykoW0EtWl1bYS16XSkvZywgJyQxXyQyJykKICAgICAgICAgICAucmVwbGFjZSgvKFthLXpcZF0pKFtBLVpdKS9nLCAnJDFfJDInKQogICAgICAgICAgIC5yZXBsYWNlKC9fL2csICctJykKICAgICAgICAgICAudG9Mb3dlckNhc2UoKQogIH0KICB1bmlxID0gZnVuY3Rpb24oYXJyYXkpeyByZXR1cm4gYXJyYXkuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0sIGlkeCl7IHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0pID09IGlkeCB9KSB9CgogIGZ1bmN0aW9uIGNsYXNzUkUobmFtZSkgewogICAgcmV0dXJuIG5hbWUgaW4gY2xhc3NDYWNoZSA/CiAgICAgIGNsYXNzQ2FjaGVbbmFtZV0gOiAoY2xhc3NDYWNoZVtuYW1lXSA9IG5ldyBSZWdFeHAoJyhefFxccyknICsgbmFtZSArICcoXFxzfCQpJykpCiAgfQoKICBmdW5jdGlvbiBtYXliZUFkZFB4KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gKHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiAhY3NzTnVtYmVyW2Rhc2hlcml6ZShuYW1lKV0pID8gdmFsdWUgKyAicHgiIDogdmFsdWUKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHREaXNwbGF5KG5vZGVOYW1lKSB7CiAgICB2YXIgZWxlbWVudCwgZGlzcGxheQogICAgaWYgKCFlbGVtZW50RGlzcGxheVtub2RlTmFtZV0pIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpCiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgJycpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKQogICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9PSAibm9uZSIgJiYgKGRpc3BsYXkgPSAiYmxvY2siKQogICAgICBlbGVtZW50RGlzcGxheVtub2RlTmFtZV0gPSBkaXNwbGF5CiAgICB9CiAgICByZXR1cm4gZWxlbWVudERpc3BsYXlbbm9kZU5hbWVdCiAgfQoKICAvLyBgJC56ZXB0by5mcmFnbWVudGAgdGFrZXMgYSBodG1sIHN0cmluZyBhbmQgYW4gb3B0aW9uYWwgdGFnIG5hbWUKICAvLyB0byBnZW5lcmF0ZSBET00gbm9kZXMgbm9kZXMgZnJvbSB0aGUgZ2l2ZW4gaHRtbCBzdHJpbmcuCiAgLy8gVGhlIGdlbmVyYXRlZCBET00gbm9kZXMgYXJlIHJldHVybmVkIGFzIGFuIGFycmF5LgogIC8vIFRoaXMgZnVuY3Rpb24gY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zIGZvciBleGFtcGxlIHRvIG1ha2UKICAvLyBpdCBjb21wYXRpYmxlIHdpdGggYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHRoZSBET00gZnVsbHkuCiAgemVwdG8uZnJhZ21lbnQgPSBmdW5jdGlvbihodG1sLCBuYW1lKSB7CiAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSBuYW1lID0gZnJhZ21lbnRSRS50ZXN0KGh0bWwpICYmIFJlZ0V4cC4kMQogICAgaWYgKCEobmFtZSBpbiBjb250YWluZXJzKSkgbmFtZSA9ICcqJwogICAgdmFyIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV0KICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnJyArIGh0bWwKICAgIHJldHVybiAkLmVhY2goc2xpY2UuY2FsbChjb250YWluZXIuY2hpbGROb2RlcyksIGZ1bmN0aW9uKCl7CiAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzKQogICAgfSkKICB9CgogIC8vIGAkLnplcHRvLlpgIHN3YXBzIG91dCB0aGUgcHJvdG90eXBlIG9mIHRoZSBnaXZlbiBgZG9tYCBhcnJheQogIC8vIG9mIG5vZGVzIHdpdGggYCQuZm5gIGFuZCB0aHVzIHN1cHBseWluZyBhbGwgdGhlIFplcHRvIGZ1bmN0aW9ucwogIC8vIHRvIHRoZSBhcnJheS4gTm90ZSB0aGF0IGBfX3Byb3RvX19gIGlzIG5vdCBzdXBwb3J0ZWQgb24gSW50ZXJuZXQKICAvLyBFeHBsb3Jlci4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLlogPSBmdW5jdGlvbihkb20sIHNlbGVjdG9yKSB7CiAgICBkb20gPSBkb20gfHwgW10KICAgIGRvbS5fX3Byb3RvX18gPSBhcmd1bWVudHMuY2FsbGVlLnByb3RvdHlwZQogICAgZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJycKICAgIHJldHVybiBkb20KICB9CgogIC8vIGAkLnplcHRvLmlzWmAgc2hvdWxkIHJldHVybiBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhIFplcHRvCiAgLy8gY29sbGVjdGlvbi4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLmlzWiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIHplcHRvLloKICB9CgogIC8vIGAkLnplcHRvLmluaXRgIGlzIFplcHRvJ3MgY291bnRlcnBhcnQgdG8galF1ZXJ5J3MgYCQuZm4uaW5pdGAgYW5kCiAgLy8gdGFrZXMgYSBDU1Mgc2VsZWN0b3IgYW5kIGFuIG9wdGlvbmFsIGNvbnRleHQgKGFuZCBoYW5kbGVzIHZhcmlvdXMKICAvLyBzcGVjaWFsIGNhc2VzKS4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8uaW5pdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAvLyBJZiBub3RoaW5nIGdpdmVuLCByZXR1cm4gYW4gZW1wdHkgWmVwdG8gY29sbGVjdGlvbgogICAgaWYgKCFzZWxlY3RvcikgcmV0dXJuIHplcHRvLlooKQogICAgLy8gSWYgYSBmdW5jdGlvbiBpcyBnaXZlbiwgY2FsbCBpdCB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gJChkb2N1bWVudCkucmVhZHkoc2VsZWN0b3IpCiAgICAvLyBJZiBhIFplcHRvIGNvbGxlY3Rpb24gaXMgZ2l2ZW4sIGp1dHMgcmV0dXJuIGl0CiAgICBlbHNlIGlmICh6ZXB0by5pc1ooc2VsZWN0b3IpKSByZXR1cm4gc2VsZWN0b3IKICAgIGVsc2UgewogICAgICB2YXIgZG9tCiAgICAgIC8vIG5vcm1hbGl6ZSBhcnJheSBpZiBhbiBhcnJheSBvZiBub2RlcyBpcyBnaXZlbgogICAgICBpZiAoaXNBcnJheShzZWxlY3RvcikpIGRvbSA9IGNvbXBhY3Qoc2VsZWN0b3IpCiAgICAgIC8vIGlmIGEgSmF2YVNjcmlwdCBvYmplY3QgaXMgZ2l2ZW4sIHJldHVybiBhIGNvcHkgb2YgaXQKICAgICAgLy8gdGhpcyBpcyBhIHNvbWV3aGF0IHBlY3VsaWFyIG9wdGlvbiwgYnV0IHN1cHBvcnRlZCBieQogICAgICAvLyBqUXVlcnkgc28gd2UnbGwgZG8gaXQsIHRvbwogICAgICBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSBbJC5leHRlbmQoe30sIHNlbGVjdG9yKV0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyB3cmFwIHN0dWZmIGxpa2UgYGRvY3VtZW50YCBvciBgd2luZG93YAogICAgICBlbHNlIGlmIChlbGVtZW50VHlwZXMuaW5kZXhPZihzZWxlY3Rvci5ub2RlVHlwZSkgPj0gMCB8fCBzZWxlY3RvciA9PT0gd2luZG93KQogICAgICAgIGRvbSA9IFtzZWxlY3Rvcl0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgZWxzZSBpZiAoZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3Rvci50cmltKCksIFJlZ0V4cC4kMSksIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiB0aGVyZSdzIGEgY29udGV4dCwgY3JlYXRlIGEgY29sbGVjdGlvbiBvbiB0aGF0IGNvbnRleHQgZmlyc3QsIGFuZCBzZWxlY3QKICAgICAgLy8gbm9kZXMgZnJvbSB0aGVyZQogICAgICBlbHNlIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHJldHVybiAkKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpCiAgICAgIC8vIEFuZCBsYXN0IGJ1dCBubyBsZWFzdCwgaWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgICAvLyBjcmVhdGUgYSBuZXcgWmVwdG8gY29sbGVjdGlvbiBmcm9tIHRoZSBub2RlcyBmb3VuZAogICAgICByZXR1cm4gemVwdG8uWihkb20sIHNlbGVjdG9yKQogICAgfQogIH0KCiAgLy8gYCRgIHdpbGwgYmUgdGhlIGJhc2UgYFplcHRvYCBvYmplY3QuIFdoZW4gY2FsbGluZyB0aGlzCiAgLy8gZnVuY3Rpb24ganVzdCBjYWxsIGAkLnplcHRvLmluaXQsIHdoaWNocyBtYWtlcyB0aGUgaW1wbGVtZW50YXRpb24KICAvLyBkZXRhaWxzIG9mIHNlbGVjdGluZyBub2RlcyBhbmQgY3JlYXRpbmcgWmVwdG8gY29sbGVjdGlvbnMKICAvLyBwYXRjaGFibGUgaW4gcGx1Z2lucy4KICAkID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQpewogICAgcmV0dXJuIHplcHRvLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpCiAgfQoKICAvLyBDb3B5IGFsbCBidXQgdW5kZWZpbmVkIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbW9yZQogIC8vIG9iamVjdHMgdG8gdGhlIGB0YXJnZXRgIG9iamVjdC4KICAkLmV4dGVuZCA9IGZ1bmN0aW9uKHRhcmdldCl7CiAgICBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yIChrZXkgaW4gc291cmNlKQogICAgICAgIGlmIChzb3VyY2Vba2V5XSAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XQogICAgfSkKICAgIHJldHVybiB0YXJnZXQKICB9CgogIC8vIGAkLnplcHRvLnFzYWAgaXMgWmVwdG8ncyBDU1Mgc2VsZWN0b3IgaW1wbGVtZW50YXRpb24gd2hpY2gKICAvLyB1c2VzIGBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsYCBhbmQgb3B0aW1pemVzIGZvciBzb21lIHNwZWNpYWwgY2FzZXMsIGxpa2UgYCNpZGAuCiAgLy8gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLnFzYSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHZhciBmb3VuZAogICAgcmV0dXJuIChlbGVtZW50ID09PSBkb2N1bWVudCAmJiBpZFNlbGVjdG9yUkUudGVzdChzZWxlY3RvcikpID8KICAgICAgKCAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKFJlZ0V4cC4kMSkpID8gW2ZvdW5kXSA6IGVtcHR5QXJyYXkgKSA6CiAgICAgIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkpID8gZW1wdHlBcnJheSA6CiAgICAgIHNsaWNlLmNhbGwoCiAgICAgICAgY2xhc3NTZWxlY3RvclJFLnRlc3Qoc2VsZWN0b3IpID8gZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFJlZ0V4cC4kMSkgOgogICAgICAgIHRhZ1NlbGVjdG9yUkUudGVzdChzZWxlY3RvcikgPyBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSA6CiAgICAgICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKQogICAgICApCiAgfQoKICBmdW5jdGlvbiBmaWx0ZXJlZChub2Rlcywgc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3RvciA9PT0gdW5kZWZpbmVkID8gJChub2RlcykgOiAkKG5vZGVzKS5maWx0ZXIoc2VsZWN0b3IpCiAgfQoKICBmdW5jdGlvbiBmdW5jQXJnKGNvbnRleHQsIGFyZywgaWR4LCBwYXlsb2FkKSB7CiAgIHJldHVybiBpc0Z1bmN0aW9uKGFyZykgPyBhcmcuY2FsbChjb250ZXh0LCBpZHgsIHBheWxvYWQpIDogYXJnCiAgfQoKICAkLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uCiAgJC5pc09iamVjdCA9IGlzT2JqZWN0CiAgJC5pc0FycmF5ID0gaXNBcnJheQogICQuaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3QKCiAgJC5pbkFycmF5ID0gZnVuY3Rpb24oZWxlbSwgYXJyYXksIGkpewogICAgcmV0dXJuIGVtcHR5QXJyYXkuaW5kZXhPZi5jYWxsKGFycmF5LCBlbGVtLCBpKQogIH0KCiAgJC50cmltID0gZnVuY3Rpb24oc3RyKSB7IHJldHVybiBzdHIudHJpbSgpIH0KCiAgLy8gcGx1Z2luIGNvbXBhdGliaWxpdHkKICAkLnV1aWQgPSAwCgogICQubWFwID0gZnVuY3Rpb24oZWxlbWVudHMsIGNhbGxiYWNrKXsKICAgIHZhciB2YWx1ZSwgdmFsdWVzID0gW10sIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpCiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbWVudHNbaV0sIGkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICBlbHNlCiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtZW50c1trZXldLCBrZXkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICByZXR1cm4gZmxhdHRlbih2YWx1ZXMpCiAgfQoKICAkLmVhY2ggPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2spewogICAgdmFyIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2ldLCBpLCBlbGVtZW50c1tpXSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2tleV0sIGtleSwgZWxlbWVudHNba2V5XSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudHMKICB9CgogIC8vIERlZmluZSBtZXRob2RzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgb24gYWxsCiAgLy8gWmVwdG8gY29sbGVjdGlvbnMKICAkLmZuID0gewogICAgLy8gQmVjYXVzZSBhIGNvbGxlY3Rpb24gYWN0cyBsaWtlIGFuIGFycmF5CiAgICAvLyBjb3B5IG92ZXIgdGhlc2UgdXNlZnVsIGFycmF5IGZ1bmN0aW9ucy4KICAgIGZvckVhY2g6IGVtcHR5QXJyYXkuZm9yRWFjaCwKICAgIHJlZHVjZTogZW1wdHlBcnJheS5yZWR1Y2UsCiAgICBwdXNoOiBlbXB0eUFycmF5LnB1c2gsCiAgICBpbmRleE9mOiBlbXB0eUFycmF5LmluZGV4T2YsCiAgICBjb25jYXQ6IGVtcHR5QXJyYXkuY29uY2F0LAoKICAgIC8vIGBtYXBgIGFuZCBgc2xpY2VgIGluIHRoZSBqUXVlcnkgQVBJIHdvcmsgZGlmZmVyZW50bHkKICAgIC8vIGZyb20gdGhlaXIgYXJyYXkgY291bnRlcnBhcnRzCiAgICBtYXA6IGZ1bmN0aW9uKGZuKXsKICAgICAgcmV0dXJuICQubWFwKHRoaXMsIGZ1bmN0aW9uKGVsLCBpKXsgcmV0dXJuIGZuLmNhbGwoZWwsIGksIGVsKSB9KQogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gJChzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKQogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBpZiAocmVhZHlSRS50ZXN0KGRvY3VtZW50LnJlYWR5U3RhdGUpKSBjYWxsYmFjaygkKQogICAgICBlbHNlIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpeyBjYWxsYmFjaygkKSB9LCBmYWxzZSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKGlkeCl7CiAgICAgIHJldHVybiBpZHggPT09IHVuZGVmaW5lZCA/IHNsaWNlLmNhbGwodGhpcykgOiB0aGlzW2lkeF0KICAgIH0sCiAgICB0b0FycmF5OiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5nZXQoKSB9LAogICAgc2l6ZTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoCiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAhPSBudWxsKQogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpCiAgICAgIH0pCiAgICB9LAogICAgZWFjaDogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwsIGlkeCl7IGNhbGxiYWNrLmNhbGwoZWwsIGlkeCwgZWwpIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiAkKFtdLmZpbHRlci5jYWxsKHRoaXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIHJldHVybiB6ZXB0by5tYXRjaGVzKGVsZW1lbnQsIHNlbGVjdG9yKQogICAgICB9KSkKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKHNlbGVjdG9yLGNvbnRleHQpewogICAgICByZXR1cm4gJCh1bmlxKHRoaXMuY29uY2F0KCQoc2VsZWN0b3IsY29udGV4dCkpKSkKICAgIH0sCiAgICBpczogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICByZXR1cm4gdGhpcy5sZW5ndGggPiAwICYmIHplcHRvLm1hdGNoZXModGhpc1swXSwgc2VsZWN0b3IpCiAgICB9LAogICAgbm90OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBub2Rlcz1bXQogICAgICBpZiAoaXNGdW5jdGlvbihzZWxlY3RvcikgJiYgc2VsZWN0b3IuY2FsbCAhPT0gdW5kZWZpbmVkKQogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgaWYgKCFzZWxlY3Rvci5jYWxsKHRoaXMsaWR4KSkgbm9kZXMucHVzaCh0aGlzKQogICAgICAgIH0pCiAgICAgIGVsc2UgewogICAgICAgIHZhciBleGNsdWRlcyA9IHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJyA/IHRoaXMuZmlsdGVyKHNlbGVjdG9yKSA6CiAgICAgICAgICAobGlrZUFycmF5KHNlbGVjdG9yKSAmJiBpc0Z1bmN0aW9uKHNlbGVjdG9yLml0ZW0pKSA/IHNsaWNlLmNhbGwoc2VsZWN0b3IpIDogJChzZWxlY3RvcikKICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwpewogICAgICAgICAgaWYgKGV4Y2x1ZGVzLmluZGV4T2YoZWwpIDwgMCkgbm9kZXMucHVzaChlbCkKICAgICAgICB9KQogICAgICB9CiAgICAgIHJldHVybiAkKG5vZGVzKQogICAgfSwKICAgIGVxOiBmdW5jdGlvbihpZHgpewogICAgICByZXR1cm4gaWR4ID09PSAtMSA/IHRoaXMuc2xpY2UoaWR4KSA6IHRoaXMuc2xpY2UoaWR4LCArIGlkeCArIDEpCiAgICB9LAogICAgZmlyc3Q6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBlbCA9IHRoaXNbMF0KICAgICAgcmV0dXJuIGVsICYmICFpc09iamVjdChlbCkgPyBlbCA6ICQoZWwpCiAgICB9LAogICAgbGFzdDogZnVuY3Rpb24oKXsKICAgICAgdmFyIGVsID0gdGhpc1t0aGlzLmxlbmd0aCAtIDFdCiAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKQogICAgfSwKICAgIGZpbmQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgdmFyIHJlc3VsdAogICAgICBpZiAodGhpcy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gemVwdG8ucXNhKHRoaXNbMF0sIHNlbGVjdG9yKQogICAgICBlbHNlIHJlc3VsdCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpIH0pCiAgICAgIHJldHVybiAkKHJlc3VsdCkKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7CiAgICAgIHZhciBub2RlID0gdGhpc1swXQogICAgICB3aGlsZSAobm9kZSAmJiAhemVwdG8ubWF0Y2hlcyhub2RlLCBzZWxlY3RvcikpCiAgICAgICAgbm9kZSA9IG5vZGUgIT09IGNvbnRleHQgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgbm9kZS5wYXJlbnROb2RlCiAgICAgIHJldHVybiAkKG5vZGUpCiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICB2YXIgYW5jZXN0b3JzID0gW10sIG5vZGVzID0gdGhpcwogICAgICB3aGlsZSAobm9kZXMubGVuZ3RoID4gMCkKICAgICAgICBub2RlcyA9ICQubWFwKG5vZGVzLCBmdW5jdGlvbihub2RlKXsKICAgICAgICAgIGlmICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgYW5jZXN0b3JzLmluZGV4T2Yobm9kZSkgPCAwKSB7CiAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKG5vZGUpCiAgICAgICAgICAgIHJldHVybiBub2RlCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgcmV0dXJuIGZpbHRlcmVkKGFuY2VzdG9ycywgc2VsZWN0b3IpCiAgICB9LAogICAgcGFyZW50OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh1bmlxKHRoaXMucGx1Y2soJ3BhcmVudE5vZGUnKSksIHNlbGVjdG9yKQogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gc2xpY2UuY2FsbCh0aGlzLmNoaWxkcmVuKSB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHRoaXMubWFwKGZ1bmN0aW9uKGksIGVsKXsKICAgICAgICByZXR1cm4gc2xpY2UuY2FsbChlbC5wYXJlbnROb2RlLmNoaWxkcmVuKS5maWx0ZXIoZnVuY3Rpb24oY2hpbGQpeyByZXR1cm4gY2hpbGQhPT1lbCB9KQogICAgICB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5pbm5lckhUTUwgPSAnJyB9KQogICAgfSwKICAgIC8vIGBwbHVja2AgaXMgYm9ycm93ZWQgZnJvbSBQcm90b3R5cGUuanMKICAgIHBsdWNrOiBmdW5jdGlvbihwcm9wZXJ0eSl7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gdGhpc1twcm9wZXJ0eV0gfSkKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIiAmJiAodGhpcy5zdHlsZS5kaXNwbGF5ID0gbnVsbCkKICAgICAgICBpZiAoZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCAnJykuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpID09ICJub25lIikKICAgICAgICAgIHRoaXMuc3R5bGUuZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5KHRoaXMubm9kZU5hbWUpCiAgICAgIH0pCiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpewogICAgICByZXR1cm4gdGhpcy5iZWZvcmUobmV3Q29udGVudCkucmVtb3ZlKCkKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbihuZXdDb250ZW50KXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAgICQodGhpcykud3JhcEFsbCgkKG5ld0NvbnRlbnQpWzBdLmNsb25lTm9kZShmYWxzZSkpCiAgICAgIH0pCiAgICB9LAogICAgd3JhcEFsbDogZnVuY3Rpb24obmV3Q29udGVudCl7CiAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgJCh0aGlzWzBdKS5iZWZvcmUobmV3Q29udGVudCA9ICQobmV3Q29udGVudCkpCiAgICAgICAgbmV3Q29udGVudC5hcHBlbmQodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdGhpcwogICAgfSwKICAgIHVud3JhcDogZnVuY3Rpb24oKXsKICAgICAgdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgJCh0aGlzKS5yZXBsYWNlV2l0aCgkKHRoaXMpLmNoaWxkcmVuKCkpCiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiAkKHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmNsb25lTm9kZSh0cnVlKSB9KSkKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5jc3MoImRpc3BsYXkiLCAibm9uZSIpCiAgICB9LAogICAgdG9nZ2xlOiBmdW5jdGlvbihzZXR0aW5nKXsKICAgICAgcmV0dXJuIChzZXR0aW5nID09PSB1bmRlZmluZWQgPyB0aGlzLmNzcygiZGlzcGxheSIpID09ICJub25lIiA6IHNldHRpbmcpID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKQogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ3ByZXZpb3VzRWxlbWVudFNpYmxpbmcnKSkgfSwKICAgIG5leHQ6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ25leHRFbGVtZW50U2libGluZycpKSB9LAogICAgaHRtbDogZnVuY3Rpb24oaHRtbCl7CiAgICAgIHJldHVybiBodG1sID09PSB1bmRlZmluZWQgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLmlubmVySFRNTCA6IG51bGwpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHZhciBvcmlnaW5IdG1sID0gdGhpcy5pbm5lckhUTUwKICAgICAgICAgICQodGhpcykuZW1wdHkoKS5hcHBlbmQoIGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSApCiAgICAgICAgfSkKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbih0ZXh0KXsKICAgICAgcmV0dXJuIHRleHQgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udGV4dENvbnRlbnQgOiBudWxsKSA6CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMudGV4dENvbnRlbnQgPSB0ZXh0IH0pCiAgICB9LAogICAgYXR0cjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB2YXIgcmVzdWx0CiAgICAgIHJldHVybiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgPwogICAgICAgICh0aGlzLmxlbmd0aCA9PSAwIHx8IHRoaXNbMF0ubm9kZVR5cGUgIT09IDEgPyB1bmRlZmluZWQgOgogICAgICAgICAgKG5hbWUgPT0gJ3ZhbHVlJyAmJiB0aGlzWzBdLm5vZGVOYW1lID09ICdJTlBVVCcpID8gdGhpcy52YWwoKSA6CiAgICAgICAgICAoIShyZXN1bHQgPSB0aGlzWzBdLmdldEF0dHJpYnV0ZShuYW1lKSkgJiYgbmFtZSBpbiB0aGlzWzBdKSA/IHRoaXNbMF1bbmFtZV0gOiByZXN1bHQKICAgICAgICApIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSByZXR1cm4KICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgZm9yIChrZXkgaW4gbmFtZSkgdGhpcy5zZXRBdHRyaWJ1dGUoa2V5LCBuYW1lW2tleV0pCiAgICAgICAgICBlbHNlIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpKQogICAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEpIHRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpIH0pCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICByZXR1cm4gKHZhbHVlID09PSB1bmRlZmluZWQpID8KICAgICAgICAodGhpc1swXSA/IHRoaXNbMF1bbmFtZV0gOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXNbbmFtZV0gPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXNbbmFtZV0pCiAgICAgICAgfSkKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBkYXRhID0gdGhpcy5hdHRyKCdkYXRhLScgKyBkYXNoZXJpemUobmFtZSksIHZhbHVlKQogICAgICByZXR1cm4gZGF0YSAhPT0gbnVsbCA/IGRhdGEgOiB1bmRlZmluZWQKICAgIH0sCiAgICB2YWw6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udmFsdWUgOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXMudmFsdWUgPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMudmFsdWUpCiAgICAgICAgfSkKICAgIH0sCiAgICBvZmZzZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh0aGlzLmxlbmd0aD09MCkgcmV0dXJuIG51bGwKICAgICAgdmFyIG9iaiA9IHRoaXNbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkKICAgICAgcmV0dXJuIHsKICAgICAgICBsZWZ0OiBvYmoubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCwKICAgICAgICB0b3A6IG9iai50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQsCiAgICAgICAgd2lkdGg6IG9iai53aWR0aCwKICAgICAgICBoZWlnaHQ6IG9iai5oZWlnaHQKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHByb3BlcnR5ID09ICdzdHJpbmcnKQogICAgICAgIHJldHVybiAoCiAgICAgICAgICB0aGlzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgID8gdW5kZWZpbmVkCiAgICAgICAgICAgIDogdGhpc1swXS5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eSldIHx8IGdldENvbXB1dGVkU3R5bGUodGhpc1swXSwgJycpLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpKQoKICAgICAgdmFyIGNzcyA9ICcnCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnR5KQogICAgICAgIGlmKHR5cGVvZiBwcm9wZXJ0eVtrZXldID09ICdzdHJpbmcnICYmIHByb3BlcnR5W2tleV0gPT0gJycpCiAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShkYXNoZXJpemUoa2V5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgKz0gZGFzaGVyaXplKGtleSkgKyAnOicgKyBtYXliZUFkZFB4KGtleSwgcHJvcGVydHlba2V5XSkgKyAnOycKCiAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT0gJ3N0cmluZycpCiAgICAgICAgaWYgKHZhbHVlID09ICcnKQogICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKHByb3BlcnR5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgPSBkYXNoZXJpemUocHJvcGVydHkpICsgIjoiICsgbWF5YmVBZGRQeChwcm9wZXJ0eSwgdmFsdWUpCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUuY3NzVGV4dCArPSAnOycgKyBjc3MgfSkKICAgIH0sCiAgICBpbmRleDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHJldHVybiBlbGVtZW50ID8gdGhpcy5pbmRleE9mKCQoZWxlbWVudClbMF0pIDogdGhpcy5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4T2YodGhpc1swXSkKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24obmFtZSl7CiAgICAgIGlmICh0aGlzLmxlbmd0aCA8IDEpIHJldHVybiBmYWxzZQogICAgICBlbHNlIHJldHVybiBjbGFzc1JFKG5hbWUpLnRlc3QodGhpc1swXS5jbGFzc05hbWUpCiAgICB9LAogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgY2xhc3NMaXN0ID0gW10KICAgICAgICB2YXIgY2xzID0gdGhpcy5jbGFzc05hbWUsIG5ld05hbWUgPSBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xzKQogICAgICAgIG5ld05hbWUuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtsYXNzKXsKICAgICAgICAgIGlmICghJCh0aGlzKS5oYXNDbGFzcyhrbGFzcykpIGNsYXNzTGlzdC5wdXNoKGtsYXNzKQogICAgICAgIH0sIHRoaXMpCiAgICAgICAgY2xhc3NMaXN0Lmxlbmd0aCAmJiAodGhpcy5jbGFzc05hbWUgKz0gKGNscyA/ICIgIiA6ICIiKSArIGNsYXNzTGlzdC5qb2luKCIgIikpCiAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkKICAgICAgICAgIHJldHVybiB0aGlzLmNsYXNzTmFtZSA9ICcnCiAgICAgICAgY2xhc3NMaXN0ID0gdGhpcy5jbGFzc05hbWUKICAgICAgICBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xhc3NMaXN0KS5zcGxpdCgvXHMrL2cpLmZvckVhY2goZnVuY3Rpb24oa2xhc3MpewogICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NMaXN0LnJlcGxhY2UoY2xhc3NSRShrbGFzcyksICIgIikKICAgICAgICB9KQogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gY2xhc3NMaXN0LnRyaW0oKQogICAgICB9KQogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihuYW1lLCB3aGVuKXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBuZXdOYW1lID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIHRoaXMuY2xhc3NOYW1lKQogICAgICAgIDsod2hlbiA9PT0gdW5kZWZpbmVkID8gISQodGhpcykuaGFzQ2xhc3MobmV3TmFtZSkgOiB3aGVuKSA/CiAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKG5ld05hbWUpIDogJCh0aGlzKS5yZW1vdmVDbGFzcyhuZXdOYW1lKQogICAgICB9KQogICAgfQogIH0KCiAgLy8gR2VuZXJhdGUgdGhlIGB3aWR0aGAgYW5kIGBoZWlnaHRgIGZ1bmN0aW9ucwogIDtbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24oZGltZW5zaW9uKXsKICAgICQuZm5bZGltZW5zaW9uXSA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgdmFyIG9mZnNldCwgRGltZW5zaW9uID0gZGltZW5zaW9uLnJlcGxhY2UoLy4vLCBmdW5jdGlvbihtKXsgcmV0dXJuIG1bMF0udG9VcHBlckNhc2UoKSB9KQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRoaXNbMF0gPT0gd2luZG93ID8gd2luZG93Wydpbm5lcicgKyBEaW1lbnNpb25dIDoKICAgICAgICB0aGlzWzBdID09IGRvY3VtZW50ID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WydvZmZzZXQnICsgRGltZW5zaW9uXSA6CiAgICAgICAgKG9mZnNldCA9IHRoaXMub2Zmc2V0KCkpICYmIG9mZnNldFtkaW1lbnNpb25dCiAgICAgIGVsc2UgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBlbCA9ICQodGhpcykKICAgICAgICBlbC5jc3MoZGltZW5zaW9uLCBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIGVsW2RpbWVuc2lvbl0oKSkpCiAgICAgIH0pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpIHsKICAgIHZhciBwYXJlbnQgPSAob3BlcmF0b3IgJSAyKSA/IHRhcmdldCA6IHRhcmdldC5wYXJlbnROb2RlCiAgICBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsCiAgICAgICFvcGVyYXRvciA/IHRhcmdldC5uZXh0U2libGluZyA6ICAgICAgLy8gYWZ0ZXIKICAgICAgb3BlcmF0b3IgPT0gMSA/IHBhcmVudC5maXJzdENoaWxkIDogICAvLyBwcmVwZW5kCiAgICAgIG9wZXJhdG9yID09IDIgPyB0YXJnZXQgOiAgICAgICAgICAgICAgLy8gYmVmb3JlCiAgICAgIG51bGwpIDogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXBwZW5kCiAgICAgICQobm9kZSkucmVtb3ZlKCkKICB9CgogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBmdW4pIHsKICAgIGZ1bihub2RlKQogICAgZm9yICh2YXIga2V5IGluIG5vZGUuY2hpbGROb2RlcykgdHJhdmVyc2VOb2RlKG5vZGUuY2hpbGROb2Rlc1trZXldLCBmdW4pCiAgfQoKICAvLyBHZW5lcmF0ZSB0aGUgYGFmdGVyYCwgYHByZXBlbmRgLCBgYmVmb3JlYCwgYGFwcGVuZGAsCiAgLy8gYGluc2VydEFmdGVyYCwgYGluc2VydEJlZm9yZWAsIGBhcHBlbmRUb2AsIGFuZCBgcHJlcGVuZFRvYCBtZXRob2RzLgogIGFkamFjZW5jeU9wZXJhdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgb3BlcmF0b3IpIHsKICAgICQuZm5ba2V5XSA9IGZ1bmN0aW9uKCl7CiAgICAgIC8vIGFyZ3VtZW50cyBjYW4gYmUgbm9kZXMsIGFycmF5cyBvZiBub2RlcywgWmVwdG8gb2JqZWN0cyBhbmQgSFRNTCBzdHJpbmdzCiAgICAgIHZhciBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24obil7IHJldHVybiBpc09iamVjdChuKSA/IG4gOiB6ZXB0by5mcmFnbWVudChuKSB9KQogICAgICBpZiAobm9kZXMubGVuZ3RoIDwgMSkgcmV0dXJuIHRoaXMKICAgICAgdmFyIHNpemUgPSB0aGlzLmxlbmd0aCwgY29weUJ5Q2xvbmUgPSBzaXplID4gMSwgaW5SZXZlcnNlID0gb3BlcmF0b3IgPCAyCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGluZGV4LCB0YXJnZXQpewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBub2RlID0gbm9kZXNbaW5SZXZlcnNlID8gbm9kZXMubGVuZ3RoLWktMSA6IGldCiAgICAgICAgICB0cmF2ZXJzZU5vZGUobm9kZSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVOYW1lICE9IG51bGwgJiYgbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnU0NSSVBUJyAmJiAoIW5vZGUudHlwZSB8fCBub2RlLnR5cGUgPT09ICd0ZXh0L2phdmFzY3JpcHQnKSkKICAgICAgICAgICAgICB3aW5kb3dbJ2V2YWwnXS5jYWxsKHdpbmRvdywgbm9kZS5pbm5lckhUTUwpCiAgICAgICAgICB9KQogICAgICAgICAgaWYgKGNvcHlCeUNsb25lICYmIGluZGV4IDwgc2l6ZSAtIDEpIG5vZGUgPSBub2RlLmNsb25lTm9kZSh0cnVlKQogICAgICAgICAgaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpCiAgICAgICAgfQogICAgICB9KQogICAgfQoKICAgICQuZm5bKG9wZXJhdG9yICUgMikgPyBrZXkrJ1RvJyA6ICdpbnNlcnQnKyhvcGVyYXRvciA/ICdCZWZvcmUnIDogJ0FmdGVyJyldID0gZnVuY3Rpb24oaHRtbCl7CiAgICAgICQoaHRtbClba2V5XSh0aGlzKQogICAgICByZXR1cm4gdGhpcwogICAgfQogIH0pCgogIHplcHRvLloucHJvdG90eXBlID0gJC5mbgoKICAvLyBFeHBvcnQgaW50ZXJuYWwgQVBJIGZ1bmN0aW9ucyBpbiB0aGUgYCQuemVwdG9gIG5hbWVzcGFjZQogIHplcHRvLmNhbWVsaXplID0gY2FtZWxpemUKICB6ZXB0by51bmlxID0gdW5pcQogICQuemVwdG8gPSB6ZXB0bwoKICByZXR1cm4gJAp9KSgpCgovLyBJZiBgJGAgaXMgbm90IHlldCBkZWZpbmVkLCBwb2ludCBpdCB0byBgWmVwdG9gCndpbmRvdy5aZXB0byA9IFplcHRvCickJyBpbiB3aW5kb3cgfHwgKHdpbmRvdy4kID0gWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyICQkID0gJC56ZXB0by5xc2EsIGhhbmRsZXJzID0ge30sIF96aWQgPSAxLCBzcGVjaWFsRXZlbnRzPXt9CgogIHNwZWNpYWxFdmVudHMuY2xpY2sgPSBzcGVjaWFsRXZlbnRzLm1vdXNlZG93biA9IHNwZWNpYWxFdmVudHMubW91c2V1cCA9IHNwZWNpYWxFdmVudHMubW91c2Vtb3ZlID0gJ01vdXNlRXZlbnRzJwoKICBmdW5jdGlvbiB6aWQoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuX3ppZCB8fCAoZWxlbWVudC5femlkID0gX3ppZCsrKQogIH0KICBmdW5jdGlvbiBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikgewogICAgZXZlbnQgPSBwYXJzZShldmVudCkKICAgIGlmIChldmVudC5ucykgdmFyIG1hdGNoZXIgPSBtYXRjaGVyRm9yKGV2ZW50Lm5zKQogICAgcmV0dXJuIChoYW5kbGVyc1t6aWQoZWxlbWVudCldIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24oaGFuZGxlcikgewogICAgICByZXR1cm4gaGFuZGxlcgogICAgICAgICYmICghZXZlbnQuZSAgfHwgaGFuZGxlci5lID09IGV2ZW50LmUpCiAgICAgICAgJiYgKCFldmVudC5ucyB8fCBtYXRjaGVyLnRlc3QoaGFuZGxlci5ucykpCiAgICAgICAgJiYgKCFmbiAgICAgICB8fCB6aWQoaGFuZGxlci5mbikgPT09IHppZChmbikpCiAgICAgICAgJiYgKCFzZWxlY3RvciB8fCBoYW5kbGVyLnNlbCA9PSBzZWxlY3RvcikKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHBhcnNlKGV2ZW50KSB7CiAgICB2YXIgcGFydHMgPSAoJycgKyBldmVudCkuc3BsaXQoJy4nKQogICAgcmV0dXJuIHtlOiBwYXJ0c1swXSwgbnM6IHBhcnRzLnNsaWNlKDEpLnNvcnQoKS5qb2luKCcgJyl9CiAgfQogIGZ1bmN0aW9uIG1hdGNoZXJGb3IobnMpIHsKICAgIHJldHVybiBuZXcgUmVnRXhwKCcoPzpefCApJyArIG5zLnJlcGxhY2UoJyAnLCAnIC4qID8nKSArICcoPzogfCQpJykKICB9CgogIGZ1bmN0aW9uIGVhY2hFdmVudChldmVudHMsIGZuLCBpdGVyYXRvcil7CiAgICBpZiAoJC5pc09iamVjdChldmVudHMpKSAkLmVhY2goZXZlbnRzLCBpdGVyYXRvcikKICAgIGVsc2UgZXZlbnRzLnNwbGl0KC9ccy8pLmZvckVhY2goZnVuY3Rpb24odHlwZSl7IGl0ZXJhdG9yKHR5cGUsIGZuKSB9KQogIH0KCiAgLy8gV0FSTiBmaXggbmFtZXNwYWNlZCBmb2N1cyAmIGJsdXIgZXZlbnRzIGRlbGVnYXRpb24uIElzc3VlcyAjNTUyICYgIzU5NyBwYXRjaGVkIGZyb20gdGhlIHVwc3RyZWFtIGNoYW5nZXM6CiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC9iYmI1Y2ExN2Q3YzE4NzRjZmYyYTlhN2MzZWE5NGE4YzhkNzlhNzkxCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC83NGJkNmY1MzFjNWJhMTU0YmU0OGU0OGZmMjIzOTI5YTBmNTdjMmZhCiAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYKICAgICAgKGhhbmRsZXIuZSA9PSAnZm9jdXMnIHx8IGhhbmRsZXIuZSA9PSAnYmx1cicpIHx8CiAgICAgICEhY2FwdHVyZVNldHRpbmcKICB9CgogIGZ1bmN0aW9uIGFkZChlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgZ2V0RGVsZWdhdGUsIGNhcHR1cmUpewogICAgdmFyIGlkID0gemlkKGVsZW1lbnQpLCBzZXQgPSAoaGFuZGxlcnNbaWRdIHx8IChoYW5kbGVyc1tpZF0gPSBbXSkpCiAgICBlYWNoRXZlbnQoZXZlbnRzLCBmbiwgZnVuY3Rpb24oZXZlbnQsIGZuKXsKICAgICAgdmFyIGRlbGVnYXRlID0gZ2V0RGVsZWdhdGUgJiYgZ2V0RGVsZWdhdGUoZm4sIGV2ZW50KSwKICAgICAgICBjYWxsYmFjayA9IGRlbGVnYXRlIHx8IGZuCiAgICAgIHZhciBwcm94eWZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmFwcGx5KGVsZW1lbnQsIFtldmVudF0uY29uY2F0KGV2ZW50LmRhdGEpKQogICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICB9CiAgICAgIHZhciBoYW5kbGVyID0gJC5leHRlbmQocGFyc2UoZXZlbnQpLCB7Zm46IGZuLCBwcm94eTogcHJveHlmbiwgc2VsOiBzZWxlY3RvciwgZGVsOiBkZWxlZ2F0ZSwgaTogc2V0Lmxlbmd0aH0pCiAgICAgIHNldC5wdXNoKGhhbmRsZXIpCiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihoYW5kbGVyLmUsIHByb3h5Zm4sIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHJlbW92ZShlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCkKICAgIGVhY2hFdmVudChldmVudHMgfHwgJycsIGZuLCBmdW5jdGlvbihldmVudCwgZm4pewogICAgICBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikuZm9yRWFjaChmdW5jdGlvbihoYW5kbGVyKXsKICAgICAgICBkZWxldGUgaGFuZGxlcnNbaWRdW2hhbmRsZXIuaV0KICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoaGFuZGxlci5lLCBoYW5kbGVyLnByb3h5LCBldmVudENhcHR1cmUoaGFuZGxlciwgY2FwdHVyZSkpCiAgICAgIH0pCiAgICB9KQogIH0KCiAgJC5ldmVudCA9IHsgYWRkOiBhZGQsIHJlbW92ZTogcmVtb3ZlIH0KCiAgJC5wcm94eSA9IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGZuKSkgewogICAgICB2YXIgcHJveHlGbiA9IGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpIH0KICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKQogICAgICByZXR1cm4gcHJveHlGbgogICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gJC5wcm94eShmbltjb250ZXh0XSwgZm4pCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJleHBlY3RlZCBmdW5jdGlvbiIpCiAgICB9CiAgfQoKICAkLmZuLmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICBhZGQodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi51bmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi5vbmUgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKHRoaXMsIGV2ZW50LCBjYWxsYmFjaywgbnVsbCwgZnVuY3Rpb24oZm4sIHR5cGUpewogICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KGVsZW1lbnQsIGFyZ3VtZW50cykKICAgICAgICAgIHJlbW92ZShlbGVtZW50LCB0eXBlLCBmbikKICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH0KCiAgdmFyIHJldHVyblRydWUgPSBmdW5jdGlvbigpe3JldHVybiB0cnVlfSwKICAgICAgcmV0dXJuRmFsc2UgPSBmdW5jdGlvbigpe3JldHVybiBmYWxzZX0sCiAgICAgIGV2ZW50TWV0aG9kcyA9IHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogJ2lzRGVmYXVsdFByZXZlbnRlZCcsCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiAnaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQnLAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogJ2lzUHJvcGFnYXRpb25TdG9wcGVkJwogICAgICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJveHkoZXZlbnQpIHsKICAgIHZhciBwcm94eSA9ICQuZXh0ZW5kKHtvcmlnaW5hbEV2ZW50OiBldmVudH0sIGV2ZW50KQogICAgJC5lYWNoKGV2ZW50TWV0aG9kcywgZnVuY3Rpb24obmFtZSwgcHJlZGljYXRlKSB7CiAgICAgIHByb3h5W25hbWVdID0gZnVuY3Rpb24oKXsKICAgICAgICB0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlCiAgICAgICAgcmV0dXJuIGV2ZW50W25hbWVdLmFwcGx5KGV2ZW50LCBhcmd1bWVudHMpCiAgICAgIH0KICAgICAgcHJveHlbcHJlZGljYXRlXSA9IHJldHVybkZhbHNlCiAgICB9KQogICAgcmV0dXJuIHByb3h5CiAgfQoKICAvLyBlbXVsYXRlcyB0aGUgJ2RlZmF1bHRQcmV2ZW50ZWQnIHByb3BlcnR5IGZvciBicm93c2VycyB0aGF0IGhhdmUgbm9uZQogIGZ1bmN0aW9uIGZpeChldmVudCkgewogICAgaWYgKCEoJ2RlZmF1bHRQcmV2ZW50ZWQnIGluIGV2ZW50KSkgewogICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2UKICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWUKICAgICAgICBwcmV2ZW50LmNhbGwodGhpcykKICAgICAgfQogICAgfQogIH0KCiAgJC5mbi5kZWxlZ2F0ZSA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKGVsZW1lbnQsIGV2ZW50LCBjYWxsYmFjaywgc2VsZWN0b3IsIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgZXZ0LCBtYXRjaCA9ICQoZS50YXJnZXQpLmNsb3Nlc3Qoc2VsZWN0b3IsIGVsZW1lbnQpLmdldCgwKQogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGV2dCA9ICQuZXh0ZW5kKGNyZWF0ZVByb3h5KGUpLCB7Y3VycmVudFRhcmdldDogbWF0Y2gsIGxpdmVGaXJlZDogZWxlbWVudH0pCiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShtYXRjaCwgW2V2dF0uY29uY2F0KFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9CiAgJC5mbi51bmRlbGVnYXRlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIHJlbW92ZSh0aGlzLCBldmVudCwgY2FsbGJhY2ssIHNlbGVjdG9yKQogICAgfSkKICB9CgogICQuZm4ubGl2ZSA9IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjayl7CiAgICAkKGRvY3VtZW50LmJvZHkpLmRlbGVnYXRlKHRoaXMuc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjaykKICAgIHJldHVybiB0aGlzCiAgfQogICQuZm4uZGllID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXsKICAgICQoZG9jdW1lbnQuYm9keSkudW5kZWxlZ2F0ZSh0aGlzLnNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgICByZXR1cm4gdGhpcwogIH0KCiAgJC5mbi5vbiA9IGZ1bmN0aW9uKGV2ZW50LCBzZWxlY3RvciwgY2FsbGJhY2spewogICAgcmV0dXJuIHNlbGVjdG9yID09IHVuZGVmaW5lZCB8fCAkLmlzRnVuY3Rpb24oc2VsZWN0b3IpID8KICAgICAgdGhpcy5iaW5kKGV2ZW50LCBzZWxlY3RvcikgOiB0aGlzLmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQogICQuZm4ub2ZmID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayl7CiAgICByZXR1cm4gc2VsZWN0b3IgPT0gdW5kZWZpbmVkIHx8ICQuaXNGdW5jdGlvbihzZWxlY3RvcikgPwogICAgICB0aGlzLnVuYmluZChldmVudCwgc2VsZWN0b3IpIDogdGhpcy51bmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQoKICAkLmZuLnRyaWdnZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICBpZiAodHlwZW9mIGV2ZW50ID09ICdzdHJpbmcnKSBldmVudCA9ICQuRXZlbnQoZXZlbnQpCiAgICBmaXgoZXZlbnQpCiAgICBldmVudC5kYXRhID0gZGF0YQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAvLyBpdGVtcyBpbiB0aGUgY29sbGVjdGlvbiBtaWdodCBub3QgYmUgRE9NIGVsZW1lbnRzCiAgICAgIC8vICh0b2RvOiBwb3NzaWJseSBzdXBwb3J0IGV2ZW50cyBvbiBwbGFpbiBvbGQgb2JqZWN0cykKICAgICAgaWYoJ2Rpc3BhdGNoRXZlbnQnIGluIHRoaXMpIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCkKICAgIH0pCiAgfQoKICAvLyB0cmlnZ2VycyBldmVudCBoYW5kbGVycyBvbiBjdXJyZW50IGVsZW1lbnQganVzdCBhcyBpZiBhbiBldmVudCBvY2N1cnJlZCwKICAvLyBkb2Vzbid0IHRyaWdnZXIgYW4gYWN0dWFsIGV2ZW50LCBkb2Vzbid0IGJ1YmJsZQogICQuZm4udHJpZ2dlckhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICB2YXIgZSwgcmVzdWx0CiAgICB0aGlzLmVhY2goZnVuY3Rpb24oaSwgZWxlbWVudCl7CiAgICAgIGUgPSBjcmVhdGVQcm94eSh0eXBlb2YgZXZlbnQgPT0gJ3N0cmluZycgPyAkLkV2ZW50KGV2ZW50KSA6IGV2ZW50KQogICAgICBlLmRhdGEgPSBkYXRhCiAgICAgIGUudGFyZ2V0ID0gZWxlbWVudAogICAgICAkLmVhY2goZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LnR5cGUgfHwgZXZlbnQpLCBmdW5jdGlvbihpLCBoYW5kbGVyKXsKICAgICAgICByZXN1bHQgPSBoYW5kbGVyLnByb3h5KGUpCiAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuIGZhbHNlCiAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gc2hvcnRjdXQgbWV0aG9kcyBmb3IgYC5iaW5kKGV2ZW50LCBmbilgIGZvciBlYWNoIGV2ZW50IHR5cGUKICA7KCdmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgJysKICAnbW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCAnKwogICdjaGFuZ2Ugc2VsZWN0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3InKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKGV2ZW50LCBjYWxsYmFjaykgfQogIH0pCgogIDtbJ2ZvY3VzJywgJ2JsdXInXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICQuZm5bbmFtZV0gPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZChuYW1lLCBjYWxsYmFjaykKICAgICAgZWxzZSBpZiAodGhpcy5sZW5ndGgpIHRyeSB7IHRoaXMuZ2V0KDApW25hbWVdKCkgfSBjYXRjaChlKXt9CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgJC5FdmVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChzcGVjaWFsRXZlbnRzW3R5cGVdIHx8ICdFdmVudHMnKSwgYnViYmxlcyA9IHRydWUKICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgKG5hbWUgPT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwcm9wc1tuYW1lXSkgOiAoZXZlbnRbbmFtZV0gPSBwcm9wc1tuYW1lXSkKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCB0cnVlLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsKQogICAgcmV0dXJuIGV2ZW50CiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgZnVuY3Rpb24gZGV0ZWN0KHVhKXsKICAgIHZhciBvcyA9IHRoaXMub3MgPSB7fSwgYnJvd3NlciA9IHRoaXMuYnJvd3NlciA9IHt9LAogICAgICB3ZWJraXQgPSB1YS5tYXRjaCgvV2ViS2l0XC8oW1xkLl0rKS8pLAogICAgICBhbmRyb2lkID0gdWEubWF0Y2goLyhBbmRyb2lkKVxzKyhbXGQuXSspLyksCiAgICAgIGlwYWQgPSB1YS5tYXRjaCgvKGlQYWQpLipPU1xzKFtcZF9dKykvKSwKICAgICAgaXBob25lID0gIWlwYWQgJiYgdWEubWF0Y2goLyhpUGhvbmVcc09TKVxzKFtcZF9dKykvKSwKICAgICAgd2Vib3MgPSB1YS5tYXRjaCgvKHdlYk9TfGhwd09TKVtcc1wvXShbXGQuXSspLyksCiAgICAgIHRvdWNocGFkID0gd2Vib3MgJiYgdWEubWF0Y2goL1RvdWNoUGFkLyksCiAgICAgIGtpbmRsZSA9IHVhLm1hdGNoKC9LaW5kbGVcLyhbXGQuXSspLyksCiAgICAgIHNpbGsgPSB1YS5tYXRjaCgvU2lsa1wvKFtcZC5fXSspLyksCiAgICAgIGJsYWNrYmVycnkgPSB1YS5tYXRjaCgvKEJsYWNrQmVycnkpLipWZXJzaW9uXC8oW1xkLl0rKS8pCgogICAgLy8gdG9kbyBjbGVhbiB0aGlzIHVwIHdpdGggYSBiZXR0ZXIgT1MvYnJvd3NlcgogICAgLy8gc2VwYXJhdGlvbi4gd2UgbmVlZCB0byBkaXNjZXJuIGJldHdlZW4gbXVsdGlwbGUKICAgIC8vIGJyb3dzZXJzIG9uIGFuZHJvaWQsIGFuZCBkZWNpZGUgaWYga2luZGxlIGZpcmUgaW4KICAgIC8vIHNpbGsgbW9kZSBpcyBhbmRyb2lkIG9yIG5vdAoKICAgIGlmIChicm93c2VyLndlYmtpdCA9ICEhd2Via2l0KSBicm93c2VyLnZlcnNpb24gPSB3ZWJraXRbMV0KCiAgICBpZiAoYW5kcm9pZCkgb3MuYW5kcm9pZCA9IHRydWUsIG9zLnZlcnNpb24gPSBhbmRyb2lkWzJdCiAgICBpZiAoaXBob25lKSBvcy5pb3MgPSBvcy5pcGhvbmUgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBob25lWzJdLnJlcGxhY2UoL18vZywgJy4nKQogICAgaWYgKGlwYWQpIG9zLmlvcyA9IG9zLmlwYWQgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBhZFsyXS5yZXBsYWNlKC9fL2csICcuJykKICAgIGlmICh3ZWJvcykgb3Mud2Vib3MgPSB0cnVlLCBvcy52ZXJzaW9uID0gd2Vib3NbMl0KICAgIGlmICh0b3VjaHBhZCkgb3MudG91Y2hwYWQgPSB0cnVlCiAgICBpZiAoYmxhY2tiZXJyeSkgb3MuYmxhY2tiZXJyeSA9IHRydWUsIG9zLnZlcnNpb24gPSBibGFja2JlcnJ5WzJdCiAgICBpZiAoa2luZGxlKSBvcy5raW5kbGUgPSB0cnVlLCBvcy52ZXJzaW9uID0ga2luZGxlWzFdCiAgICBpZiAoc2lsaykgYnJvd3Nlci5zaWxrID0gdHJ1ZSwgYnJvd3Nlci52ZXJzaW9uID0gc2lsa1sxXQogICAgaWYgKCFzaWxrICYmIG9zLmFuZHJvaWQgJiYgdWEubWF0Y2goL0tpbmRsZSBGaXJlLykpIGJyb3dzZXIuc2lsayA9IHRydWUKICB9CgogIGRldGVjdC5jYWxsKCQsIG5hdmlnYXRvci51c2VyQWdlbnQpCiAgLy8gbWFrZSBhdmFpbGFibGUgdG8gdW5pdCB0ZXN0cwogICQuX19kZXRlY3QgPSBkZXRlY3QKCn0pKFplcHRvKQo7KGZ1bmN0aW9uKCQsIHVuZGVmaW5lZCl7CiAgdmFyIHByZWZpeCA9ICcnLCBldmVudFByZWZpeCwgZW5kRXZlbnROYW1lLCBlbmRBbmltYXRpb25OYW1lLAogICAgdmVuZG9ycyA9IHsgV2Via2l0OiAnd2Via2l0JywgTW96OiAnJywgTzogJ28nLCBtczogJ01TJyB9LAogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsIHRlc3RFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgc3VwcG9ydGVkVHJhbnNmb3JtcyA9IC9eKCh0cmFuc2xhdGV8cm90YXRlfHNjYWxlKShYfFl8WnwzZCk/fG1hdHJpeCgzZCk/fHBlcnNwZWN0aXZlfHNrZXcoWHxZKT8pJC9pLAogICAgY2xlYXJQcm9wZXJ0aWVzID0ge30KCiAgZnVuY3Rpb24gZG93bmNhc2Uoc3RyKSB7IHJldHVybiBzdHIudG9Mb3dlckNhc2UoKSB9CiAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnQobmFtZSkgeyByZXR1cm4gZXZlbnRQcmVmaXggPyBldmVudFByZWZpeCArIG5hbWUgOiBkb3duY2FzZShuYW1lKSB9CgogICQuZWFjaCh2ZW5kb3JzLCBmdW5jdGlvbih2ZW5kb3IsIGV2ZW50KXsKICAgIGlmICh0ZXN0RWwuc3R5bGVbdmVuZG9yICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgcHJlZml4ID0gJy0nICsgZG93bmNhc2UodmVuZG9yKSArICctJwogICAgICBldmVudFByZWZpeCA9IGV2ZW50CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0pCgogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eSddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zaXRpb24tZHVyYXRpb24nXSA9CiAgY2xlYXJQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPQogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAnYW5pbWF0aW9uLWR1cmF0aW9uJ10gPSAnJwoKICAkLmZ4ID0gewogICAgb2ZmOiAoZXZlbnRQcmVmaXggPT09IHVuZGVmaW5lZCAmJiB0ZXN0RWwuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID09PSB1bmRlZmluZWQpLAogICAgY3NzUHJlZml4OiBwcmVmaXgsCiAgICB0cmFuc2l0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnVHJhbnNpdGlvbkVuZCcpLAogICAgYW5pbWF0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnQW5pbWF0aW9uRW5kJykKICB9CgogICQuZm4uYW5pbWF0ZSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMsIGR1cmF0aW9uLCBlYXNlLCBjYWxsYmFjayl7CiAgICBpZiAoJC5pc09iamVjdChkdXJhdGlvbikpCiAgICAgIGVhc2UgPSBkdXJhdGlvbi5lYXNpbmcsIGNhbGxiYWNrID0gZHVyYXRpb24uY29tcGxldGUsIGR1cmF0aW9uID0gZHVyYXRpb24uZHVyYXRpb24KICAgIGlmIChkdXJhdGlvbikgZHVyYXRpb24gPSBkdXJhdGlvbiAvIDEwMDAKICAgIHJldHVybiB0aGlzLmFuaW0ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKQogIH0KCiAgJC5mbi5hbmltID0gZnVuY3Rpb24ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKXsKICAgIHZhciB0cmFuc2Zvcm1zLCBjc3NQcm9wZXJ0aWVzID0ge30sIGtleSwgdGhhdCA9IHRoaXMsIHdyYXBwZWRDYWxsYmFjaywgZW5kRXZlbnQgPSAkLmZ4LnRyYW5zaXRpb25FbmQKICAgIGlmIChkdXJhdGlvbiA9PT0gdW5kZWZpbmVkKSBkdXJhdGlvbiA9IDAuNAogICAgaWYgKCQuZngub2ZmKSBkdXJhdGlvbiA9IDAKCiAgICBpZiAodHlwZW9mIHByb3BlcnRpZXMgPT0gJ3N0cmluZycpIHsKICAgICAgLy8ga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPSBwcm9wZXJ0aWVzCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgZW5kRXZlbnQgPSAkLmZ4LmFuaW1hdGlvbkVuZAogICAgfSBlbHNlIHsKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnRpZXMpCiAgICAgICAgaWYgKHN1cHBvcnRlZFRyYW5zZm9ybXMudGVzdChrZXkpKSB7CiAgICAgICAgICB0cmFuc2Zvcm1zIHx8ICh0cmFuc2Zvcm1zID0gW10pCiAgICAgICAgICB0cmFuc2Zvcm1zLnB1c2goa2V5ICsgJygnICsgcHJvcGVydGllc1trZXldICsgJyknKQogICAgICAgIH0KICAgICAgICBlbHNlIGNzc1Byb3BlcnRpZXNba2V5XSA9IHByb3BlcnRpZXNba2V5XQoKICAgICAgaWYgKHRyYW5zZm9ybXMpIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zZm9ybSddID0gdHJhbnNmb3Jtcy5qb2luKCcgJykKICAgICAgaWYgKCEkLmZ4Lm9mZiAmJiB0eXBlb2YgcHJvcGVydGllcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXByb3BlcnR5J10gPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKS5qb2luKCcsICcpCiAgICAgICAgY3NzUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0gKGVhc2UgfHwgJ2xpbmVhcicpCiAgICAgIH0KICAgIH0KCiAgICB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbihldmVudCl7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gZXZlbnQuY3VycmVudFRhcmdldCkgcmV0dXJuIC8vIG1ha2VzIHN1cmUgdGhlIGV2ZW50IGRpZG4ndCBidWJibGUgZnJvbSAiYmVsb3ciCiAgICAgICAgJChldmVudC50YXJnZXQpLnVuYmluZChlbmRFdmVudCwgYXJndW1lbnRzLmNhbGxlZSkKICAgICAgfQogICAgICAkKHRoaXMpLmNzcyhjbGVhclByb3BlcnRpZXMpCiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcykKICAgIH0KICAgIGlmIChkdXJhdGlvbiA+IDApIHRoaXMuYmluZChlbmRFdmVudCwgd3JhcHBlZENhbGxiYWNrKQoKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHRoYXQuY3NzKGNzc1Byb3BlcnRpZXMpCiAgICAgIGlmIChkdXJhdGlvbiA8PSAwKSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRoYXQuZWFjaChmdW5jdGlvbigpeyB3cmFwcGVkQ2FsbGJhY2suY2FsbCh0aGlzKSB9KQogICAgICB9LCAwKQogICAgfSwgMCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdGVzdEVsID0gbnVsbAp9KShaZXB0bykKOyhmdW5jdGlvbigkKXsKICB2YXIganNvbnBJRCA9IDAsCiAgICAgIGlzT2JqZWN0ID0gJC5pc09iamVjdCwKICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGtleSwKICAgICAgbmFtZSwKICAgICAgcnNjcmlwdCA9IC88c2NyaXB0XGJbXjxdKig/Oig/ITxcL3NjcmlwdD4pPFtePF0qKSo8XC9zY3JpcHQ+L2dpLAogICAgICBzY3JpcHRUeXBlUkUgPSAvXig/OnRleHR8YXBwbGljYXRpb24pXC9qYXZhc2NyaXB0L2ksCiAgICAgIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pLAogICAgICBqc29uVHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgaHRtbFR5cGUgPSAndGV4dC9odG1sJywKICAgICAgYmxhbmtSRSA9IC9eXHMqJC8KCiAgLy8gdHJpZ2dlciBhIGN1c3RvbSBldmVudCBhbmQgcmV0dXJuIGZhbHNlIGlmIGl0IHdhcyBjYW5jZWxsZWQKICBmdW5jdGlvbiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50ID0gJC5FdmVudChldmVudE5hbWUpCiAgICAkKGNvbnRleHQpLnRyaWdnZXIoZXZlbnQsIGRhdGEpCiAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQKICB9CgogIC8vIHRyaWdnZXIgYW4gQWpheCAiZ2xvYmFsIiBldmVudAogIGZ1bmN0aW9uIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCkgcmV0dXJuIHRyaWdnZXJBbmRSZXR1cm4oY29udGV4dCB8fCBkb2N1bWVudCwgZXZlbnROYW1lLCBkYXRhKQogIH0KCiAgLy8gTnVtYmVyIG9mIGFjdGl2ZSBBamF4IHJlcXVlc3RzCiAgJC5hY3RpdmUgPSAwCgogIGZ1bmN0aW9uIGFqYXhTdGFydChzZXR0aW5ncykgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCAmJiAkLmFjdGl2ZSsrID09PSAwKSB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBudWxsLCAnYWpheFN0YXJ0JykKICB9CiAgZnVuY3Rpb24gYWpheFN0b3Aoc2V0dGluZ3MpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwgJiYgISgtLSQuYWN0aXZlKSkgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgbnVsbCwgJ2FqYXhTdG9wJykKICB9CgogIC8vIHRyaWdnZXJzIGFuIGV4dHJhIGdsb2JhbCBldmVudCAiYWpheEJlZm9yZVNlbmQiIHRoYXQncyBsaWtlICJhamF4U2VuZCIgYnV0IGNhbmNlbGFibGUKICBmdW5jdGlvbiBhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSB7CiAgICB2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQKICAgIGlmIChzZXR0aW5ncy5iZWZvcmVTZW5kLmNhbGwoY29udGV4dCwgeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlIHx8CiAgICAgICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhCZWZvcmVTZW5kJywgW3hociwgc2V0dGluZ3NdKSA9PT0gZmFsc2UpCiAgICAgIHJldHVybiBmYWxzZQoKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U2VuZCcsIFt4aHIsIHNldHRpbmdzXSkKICB9CiAgZnVuY3Rpb24gYWpheFN1Y2Nlc3MoZGF0YSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0LCBzdGF0dXMgPSAnc3VjY2VzcycKICAgIHNldHRpbmdzLnN1Y2Nlc3MuY2FsbChjb250ZXh0LCBkYXRhLCBzdGF0dXMsIHhocikKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U3VjY2VzcycsIFt4aHIsIHNldHRpbmdzLCBkYXRhXSkKICAgIGFqYXhDb21wbGV0ZShzdGF0dXMsIHhociwgc2V0dGluZ3MpCiAgfQogIC8vIHR5cGU6ICJ0aW1lb3V0IiwgImVycm9yIiwgImFib3J0IiwgInBhcnNlcmVycm9yIgogIGZ1bmN0aW9uIGFqYXhFcnJvcihlcnJvciwgdHlwZSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5lcnJvci5jYWxsKGNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpCiAgICB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCAnYWpheEVycm9yJywgW3hociwgc2V0dGluZ3MsIGVycm9yXSkKICAgIGFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKQogIH0KICAvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5jb21wbGV0ZS5jYWxsKGNvbnRleHQsIHhociwgc3RhdHVzKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhDb21wbGV0ZScsIFt4aHIsIHNldHRpbmdzXSkKICAgIGFqYXhTdG9wKHNldHRpbmdzKQogIH0KCiAgLy8gRW1wdHkgZnVuY3Rpb24sIHVzZWQgYXMgZGVmYXVsdCBjYWxsYmFjawogIGZ1bmN0aW9uIGVtcHR5KCkge30KCiAgJC5hamF4SlNPTlAgPSBmdW5jdGlvbihvcHRpb25zKXsKICAgIHZhciBjYWxsYmFja05hbWUgPSAnanNvbnAnICsgKCsranNvbnBJRCksCiAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICBhYm9ydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgICAgaWYgKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZW1wdHkKICAgICAgICBhamF4Q29tcGxldGUoJ2Fib3J0JywgeGhyLCBvcHRpb25zKQogICAgICB9LAogICAgICB4aHIgPSB7IGFib3J0OiBhYm9ydCB9LCBhYm9ydFRpbWVvdXQKCiAgICBpZiAob3B0aW9ucy5lcnJvcikgc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgeGhyLmFib3J0KCkKICAgICAgb3B0aW9ucy5lcnJvcigpCiAgICB9CgogICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbihkYXRhKXsKICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgIGRlbGV0ZSB3aW5kb3dbY2FsbGJhY2tOYW1lXQogICAgICBhamF4U3VjY2VzcyhkYXRhLCB4aHIsIG9wdGlvbnMpCiAgICB9CgogICAgc2VyaWFsaXplRGF0YShvcHRpb25zKQogICAgc2NyaXB0LnNyYyA9IG9wdGlvbnMudXJsLnJlcGxhY2UoLz1cPy8sICc9JyArIGNhbGxiYWNrTmFtZSkKICAgICQoJ2hlYWQnKS5hcHBlbmQoc2NyaXB0KQoKICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSBhYm9ydFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICBhamF4Q29tcGxldGUoJ3RpbWVvdXQnLCB4aHIsIG9wdGlvbnMpCiAgICAgIH0sIG9wdGlvbnMudGltZW91dCkKCiAgICByZXR1cm4geGhyCiAgfQoKICAkLmFqYXhTZXR0aW5ncyA9IHsKICAgIC8vIERlZmF1bHQgdHlwZSBvZiByZXF1ZXN0CiAgICB0eXBlOiAnR0VUJywKICAgIC8vIENhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgYmVmb3JlIHJlcXVlc3QKICAgIGJlZm9yZVNlbmQ6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBpZiB0aGUgcmVxdWVzdCBzdWNjZWVkcwogICAgc3VjY2VzczogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIHRoZSB0aGUgc2VydmVyIGRyb3BzIGVycm9yCiAgICBlcnJvcjogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIG9uIHJlcXVlc3QgY29tcGxldGUgKGJvdGg6IGVycm9yIGFuZCBzdWNjZXNzKQogICAgY29tcGxldGU6IGVtcHR5LAogICAgLy8gVGhlIGNvbnRleHQgZm9yIHRoZSBjYWxsYmFja3MKICAgIGNvbnRleHQ6IG51bGwsCiAgICAvLyBXaGV0aGVyIHRvIHRyaWdnZXIgImdsb2JhbCIgQWpheCBldmVudHMKICAgIGdsb2JhbDogdHJ1ZSwKICAgIC8vIFRyYW5zcG9ydAogICAgeGhyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCkKICAgIH0sCiAgICAvLyBNSU1FIHR5cGVzIG1hcHBpbmcKICAgIGFjY2VwdHM6IHsKICAgICAgc2NyaXB0OiAndGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JywKICAgICAganNvbjogICBqc29uVHlwZSwKICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgIGh0bWw6ICAgaHRtbFR5cGUsCiAgICAgIHRleHQ6ICAgJ3RleHQvcGxhaW4nCiAgICB9LAogICAgLy8gV2hldGhlciB0aGUgcmVxdWVzdCBpcyB0byBhbm90aGVyIGRvbWFpbgogICAgY3Jvc3NEb21haW46IGZhbHNlLAogICAgLy8gRGVmYXVsdCB0aW1lb3V0CiAgICB0aW1lb3V0OiAwCiAgfQoKICBmdW5jdGlvbiBtaW1lVG9EYXRhVHlwZShtaW1lKSB7CiAgICByZXR1cm4gbWltZSAmJiAoIG1pbWUgPT0gaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICBtaW1lID09IGpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgc2NyaXB0VHlwZVJFLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgIHhtbFR5cGVSRS50ZXN0KG1pbWUpICYmICd4bWwnICkgfHwgJ3RleHQnCiAgfQoKICBmdW5jdGlvbiBhcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KSB7CiAgICByZXR1cm4gKHVybCArICcmJyArIHF1ZXJ5KS5yZXBsYWNlKC9bJj9dezEsMn0vLCAnPycpCiAgfQoKICAvLyBzZXJpYWxpemUgcGF5bG9hZCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBVUkwgZm9yIEdFVCByZXF1ZXN0cwogIGZ1bmN0aW9uIHNlcmlhbGl6ZURhdGEob3B0aW9ucykgewogICAgaWYgKGlzT2JqZWN0KG9wdGlvbnMuZGF0YSkpIG9wdGlvbnMuZGF0YSA9ICQucGFyYW0ob3B0aW9ucy5kYXRhKQogICAgaWYgKG9wdGlvbnMuZGF0YSAmJiAoIW9wdGlvbnMudHlwZSB8fCBvcHRpb25zLnR5cGUudG9VcHBlckNhc2UoKSA9PSAnR0VUJykpCiAgICAgIG9wdGlvbnMudXJsID0gYXBwZW5kUXVlcnkob3B0aW9ucy51cmwsIG9wdGlvbnMuZGF0YSkKICB9CgogICQuYWpheCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIG9wdGlvbnMgfHwge30pCiAgICBmb3IgKGtleSBpbiAkLmFqYXhTZXR0aW5ncykgaWYgKHNldHRpbmdzW2tleV0gPT09IHVuZGVmaW5lZCkgc2V0dGluZ3Nba2V5XSA9ICQuYWpheFNldHRpbmdzW2tleV0KCiAgICBhamF4U3RhcnQoc2V0dGluZ3MpCgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgc2V0dGluZ3MuY3Jvc3NEb21haW4gPSAvXihbXHctXSs6KT9cL1wvKFteXC9dKykvLnRlc3Qoc2V0dGluZ3MudXJsKSAmJgogICAgICBSZWdFeHAuJDIgIT0gd2luZG93LmxvY2F0aW9uLmhvc3QKCiAgICB2YXIgZGF0YVR5cGUgPSBzZXR0aW5ncy5kYXRhVHlwZSwgaGFzUGxhY2Vob2xkZXIgPSAvPVw/Ly50ZXN0KHNldHRpbmdzLnVybCkKICAgIGlmIChkYXRhVHlwZSA9PSAnanNvbnAnIHx8IGhhc1BsYWNlaG9sZGVyKSB7CiAgICAgIGlmICghaGFzUGxhY2Vob2xkZXIpIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwgJ2NhbGxiYWNrPT8nKQogICAgICByZXR1cm4gJC5hamF4SlNPTlAoc2V0dGluZ3MpCiAgICB9CgogICAgaWYgKCFzZXR0aW5ncy51cmwpIHNldHRpbmdzLnVybCA9IHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpCiAgICBzZXJpYWxpemVEYXRhKHNldHRpbmdzKQoKICAgIHZhciBtaW1lID0gc2V0dGluZ3MuYWNjZXB0c1tkYXRhVHlwZV0sCiAgICAgICAgYmFzZUhlYWRlcnMgPSB7IH0sCiAgICAgICAgcHJvdG9jb2wgPSAvXihbXHctXSs6KVwvXC8vLnRlc3Qoc2V0dGluZ3MudXJsKSA/IFJlZ0V4cC4kMSA6IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCwKICAgICAgICB4aHIgPSAkLmFqYXhTZXR0aW5ncy54aHIoKSwgYWJvcnRUaW1lb3V0CgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgYmFzZUhlYWRlcnNbJ1gtUmVxdWVzdGVkLVdpdGgnXSA9ICdYTUxIdHRwUmVxdWVzdCcKICAgIGlmIChtaW1lKSB7CiAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWUKICAgICAgaWYgKG1pbWUuaW5kZXhPZignLCcpID4gLTEpIG1pbWUgPSBtaW1lLnNwbGl0KCcsJywgMilbMF0KICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUobWltZSkKICAgIH0KICAgIGlmIChzZXR0aW5ncy5jb250ZW50VHlwZSB8fCAoc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlLnRvVXBwZXJDYXNlKCkgIT0gJ0dFVCcpKQogICAgICBiYXNlSGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpCiAgICBzZXR0aW5ncy5oZWFkZXJzID0gJC5leHRlbmQoYmFzZUhlYWRlcnMsIHNldHRpbmdzLmhlYWRlcnMgfHwge30pCgogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlCiAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09IDMwNCB8fCAoeGhyLnN0YXR1cyA9PSAwICYmIHByb3RvY29sID09ICdmaWxlOicpKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpCiAgICAgICAgICByZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGRhdGFUeXBlID09ICdzY3JpcHQnKSAgICAoMSxldmFsKShyZXN1bHQpCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICd4bWwnKSAgcmVzdWx0ID0geGhyLnJlc3BvbnNlWE1MCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICdqc29uJykgcmVzdWx0ID0gYmxhbmtSRS50ZXN0KHJlc3VsdCkgPyBudWxsIDogSlNPTi5wYXJzZShyZXN1bHQpCiAgICAgICAgICB9IGNhdGNoIChlKSB7IGVycm9yID0gZSB9CgogICAgICAgICAgaWYgKGVycm9yKSBhamF4RXJyb3IoZXJyb3IsICdwYXJzZXJlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgICBlbHNlIGFqYXhTdWNjZXNzKHJlc3VsdCwgeGhyLCBzZXR0aW5ncykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWpheEVycm9yKG51bGwsICdlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGFzeW5jID0gJ2FzeW5jJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLmFzeW5jIDogdHJ1ZQogICAgeGhyLm9wZW4oc2V0dGluZ3MudHlwZSwgc2V0dGluZ3MudXJsLCBhc3luYykKCiAgICBmb3IgKG5hbWUgaW4gc2V0dGluZ3MuaGVhZGVycykgeGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSkKCiAgICBpZiAoYWpheEJlZm9yZVNlbmQoeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlKSB7CiAgICAgIHhoci5hYm9ydCgpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmIChzZXR0aW5ncy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQogICAgICAgIHhoci5hYm9ydCgpCiAgICAgICAgYWpheEVycm9yKG51bGwsICd0aW1lb3V0JywgeGhyLCBzZXR0aW5ncykKICAgICAgfSwgc2V0dGluZ3MudGltZW91dCkKCiAgICAvLyBhdm9pZCBzZW5kaW5nIGVtcHR5IHN0cmluZyAoIzMxOSkKICAgIHhoci5zZW5kKHNldHRpbmdzLmRhdGEgPyBzZXR0aW5ncy5kYXRhIDogbnVsbCkKICAgIHJldHVybiB4aHIKICB9CgogICQuZ2V0ID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsgcmV0dXJuICQuYWpheCh7IHVybDogdXJsLCBzdWNjZXNzOiBzdWNjZXNzIH0pIH0KCiAgJC5wb3N0ID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzLCBkYXRhVHlwZSl7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGRhdGEpKSBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IHN1Y2Nlc3MsIHN1Y2Nlc3MgPSBkYXRhLCBkYXRhID0gbnVsbAogICAgcmV0dXJuICQuYWpheCh7IHR5cGU6ICdQT1NUJywgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHN1Y2Nlc3M6IHN1Y2Nlc3MsIGRhdGFUeXBlOiBkYXRhVHlwZSB9KQogIH0KCiAgJC5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIHJldHVybiAkLmFqYXgoeyB1cmw6IHVybCwgc3VjY2Vzczogc3VjY2VzcywgZGF0YVR5cGU6ICdqc29uJyB9KQogIH0KCiAgJC5mbi5sb2FkID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCiAgICB2YXIgc2VsZiA9IHRoaXMsIHBhcnRzID0gdXJsLnNwbGl0KC9ccy8pLCBzZWxlY3RvcgogICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHVybCA9IHBhcnRzWzBdLCBzZWxlY3RvciA9IHBhcnRzWzFdCiAgICAkLmdldCh1cmwsIGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKS5odG1sKHJlc3BvbnNlLnJlcGxhY2UocnNjcmlwdCwgIiIpKS5maW5kKHNlbGVjdG9yKS5odG1sKCkKICAgICAgICA6IHJlc3BvbnNlKQogICAgICBzdWNjZXNzICYmIHN1Y2Nlc3MuY2FsbChzZWxmKQogICAgfSkKICAgIHJldHVybiB0aGlzCiAgfQoKICB2YXIgZXNjYXBlID0gZW5jb2RlVVJJQ29tcG9uZW50CgogIGZ1bmN0aW9uIHNlcmlhbGl6ZShwYXJhbXMsIG9iaiwgdHJhZGl0aW9uYWwsIHNjb3BlKXsKICAgIHZhciBhcnJheSA9ICQuaXNBcnJheShvYmopCiAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChzY29wZSkga2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6IHNjb3BlICsgJ1snICsgKGFycmF5ID8gJycgOiBrZXkpICsgJ10nCiAgICAgIC8vIGhhbmRsZSBkYXRhIGluIHNlcmlhbGl6ZUFycmF5KCkgZm9ybWF0CiAgICAgIGlmICghc2NvcGUgJiYgYXJyYXkpIHBhcmFtcy5hZGQodmFsdWUubmFtZSwgdmFsdWUudmFsdWUpCiAgICAgIC8vIHJlY3Vyc2UgaW50byBuZXN0ZWQgb2JqZWN0cwogICAgICBlbHNlIGlmICh0cmFkaXRpb25hbCA/ICQuaXNBcnJheSh2YWx1ZSkgOiBpc09iamVjdCh2YWx1ZSkpCiAgICAgICAgc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpCiAgICAgIGVsc2UgcGFyYW1zLmFkZChrZXksIHZhbHVlKQogICAgfSkKICB9CgogICQucGFyYW0gPSBmdW5jdGlvbihvYmosIHRyYWRpdGlvbmFsKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgcGFyYW1zLmFkZCA9IGZ1bmN0aW9uKGssIHYpeyB0aGlzLnB1c2goZXNjYXBlKGspICsgJz0nICsgZXNjYXBlKHYpKSB9CiAgICBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsKQogICAgcmV0dXJuIHBhcmFtcy5qb2luKCcmJykucmVwbGFjZSgnJTIwJywgJysnKQogIH0KfSkoWmVwdG8pCjsoZnVuY3Rpb24gKCQpIHsKICAkLmZuLnNlcmlhbGl6ZUFycmF5ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHJlc3VsdCA9IFtdLCBlbAogICAgJCggQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5nZXQoMCkuZWxlbWVudHMpICkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIGVsID0gJCh0aGlzKQogICAgICB2YXIgdHlwZSA9IGVsLmF0dHIoJ3R5cGUnKQogICAgICBpZiAodGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdmaWVsZHNldCcgJiYKICAgICAgICAhdGhpcy5kaXNhYmxlZCAmJiB0eXBlICE9ICdzdWJtaXQnICYmIHR5cGUgIT0gJ3Jlc2V0JyAmJiB0eXBlICE9ICdidXR0b24nICYmCiAgICAgICAgKCh0eXBlICE9ICdyYWRpbycgJiYgdHlwZSAhPSAnY2hlY2tib3gnKSB8fCB0aGlzLmNoZWNrZWQpKQogICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgIG5hbWU6IGVsLmF0dHIoJ25hbWUnKSwKICAgICAgICAgIHZhbHVlOiBlbC52YWwoKQogICAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgJC5mbi5zZXJpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcmVzdWx0ID0gW10KICAgIHRoaXMuc2VyaWFsaXplQXJyYXkoKS5mb3JFYWNoKGZ1bmN0aW9uIChlbG0pIHsKICAgICAgcmVzdWx0LnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChlbG0ubmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZWxtLnZhbHVlKSApCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdC5qb2luKCcmJykKICB9CgogICQuZm4uc3VibWl0ID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZCgnc3VibWl0JywgY2FsbGJhY2spCiAgICBlbHNlIGlmICh0aGlzLmxlbmd0aCkgewogICAgICB2YXIgZXZlbnQgPSAkLkV2ZW50KCdzdWJtaXQnKQogICAgICB0aGlzLmVxKDApLnRyaWdnZXIoZXZlbnQpCiAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgdGhpcy5nZXQoMCkuc3VibWl0KCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyIHRvdWNoID0ge30sIHRvdWNoVGltZW91dAoKICBmdW5jdGlvbiBwYXJlbnRJZlRleHQobm9kZSl7CiAgICByZXR1cm4gJ3RhZ05hbWUnIGluIG5vZGUgPyBub2RlIDogbm9kZS5wYXJlbnROb2RlCiAgfQoKICBmdW5jdGlvbiBzd2lwZURpcmVjdGlvbih4MSwgeDIsIHkxLCB5Mil7CiAgICB2YXIgeERlbHRhID0gTWF0aC5hYnMoeDEgLSB4MiksIHlEZWx0YSA9IE1hdGguYWJzKHkxIC0geTIpCiAgICByZXR1cm4geERlbHRhID49IHlEZWx0YSA/ICh4MSAtIHgyID4gMCA/ICdMZWZ0JyA6ICdSaWdodCcpIDogKHkxIC0geTIgPiAwID8gJ1VwJyA6ICdEb3duJykKICB9CgogIHZhciBsb25nVGFwRGVsYXkgPSA3NTAsIGxvbmdUYXBUaW1lb3V0CgogIGZ1bmN0aW9uIGxvbmdUYXAoKXsKICAgIGxvbmdUYXBUaW1lb3V0ID0gbnVsbAogICAgaWYgKHRvdWNoLmxhc3QpIHsKICAgICAgdG91Y2guZWwudHJpZ2dlcignbG9uZ1RhcCcpCiAgICAgIHRvdWNoID0ge30KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbmNlbExvbmdUYXAoKXsKICAgIGlmIChsb25nVGFwVGltZW91dCkgY2xlYXJUaW1lb3V0KGxvbmdUYXBUaW1lb3V0KQogICAgbG9uZ1RhcFRpbWVvdXQgPSBudWxsCiAgfQoKICAkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpewogICAgdmFyIG5vdywgZGVsdGEKCiAgICAkKGRvY3VtZW50LmJvZHkpLmJpbmQoJ3RvdWNoc3RhcnQnLCBmdW5jdGlvbihlKXsKICAgICAgbm93ID0gRGF0ZS5ub3coKQogICAgICBkZWx0YSA9IG5vdyAtICh0b3VjaC5sYXN0IHx8IG5vdykKICAgICAgdG91Y2guZWwgPSAkKHBhcmVudElmVGV4dChlLnRvdWNoZXNbMF0udGFyZ2V0KSkKICAgICAgdG91Y2hUaW1lb3V0ICYmIGNsZWFyVGltZW91dCh0b3VjaFRpbWVvdXQpCiAgICAgIHRvdWNoLngxID0gZS50b3VjaGVzWzBdLnBhZ2VYCiAgICAgIHRvdWNoLnkxID0gZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgIGlmIChkZWx0YSA+IDAgJiYgZGVsdGEgPD0gMjUwKSB0b3VjaC5pc0RvdWJsZVRhcCA9IHRydWUKICAgICAgdG91Y2gubGFzdCA9IG5vdwogICAgICBsb25nVGFwVGltZW91dCA9IHNldFRpbWVvdXQobG9uZ1RhcCwgbG9uZ1RhcERlbGF5KQogICAgfSkuYmluZCgndG91Y2htb3ZlJywgZnVuY3Rpb24oZSl7CiAgICAgIGNhbmNlbExvbmdUYXAoKQogICAgICB0b3VjaC54MiA9IGUudG91Y2hlc1swXS5wYWdlWAogICAgICB0b3VjaC55MiA9IGUudG91Y2hlc1swXS5wYWdlWQogICAgfSkuYmluZCgndG91Y2hlbmQnLCBmdW5jdGlvbihlKXsKICAgICAgIGNhbmNlbExvbmdUYXAoKQoKICAgICAgLy8gZG91YmxlIHRhcCAodGFwcGVkIHR3aWNlIHdpdGhpbiAyNTBtcykKICAgICAgaWYgKHRvdWNoLmlzRG91YmxlVGFwKSB7CiAgICAgICAgdG91Y2guZWwudHJpZ2dlcignZG91YmxlVGFwJykKICAgICAgICB0b3VjaCA9IHt9CgogICAgICAvLyBzd2lwZQogICAgICB9IGVsc2UgaWYgKCh0b3VjaC54MiAmJiBNYXRoLmFicyh0b3VjaC54MSAtIHRvdWNoLngyKSA+IDMwKSB8fAogICAgICAgICAgICAgICAgICh0b3VjaC55MiAmJiBNYXRoLmFicyh0b3VjaC55MSAtIHRvdWNoLnkyKSA+IDMwKSkgewogICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJykgJiYKICAgICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJyArIChzd2lwZURpcmVjdGlvbih0b3VjaC54MSwgdG91Y2gueDIsIHRvdWNoLnkxLCB0b3VjaC55MikpKQogICAgICAgIHRvdWNoID0ge30KCiAgICAgIC8vIG5vcm1hbCB0YXAKICAgICAgfSBlbHNlIGlmICgnbGFzdCcgaW4gdG91Y2gpIHsKICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCd0YXAnKQoKICAgICAgICB0b3VjaFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCdzaW5nbGVUYXAnKQogICAgICAgICAgdG91Y2ggPSB7fQogICAgICAgIH0sIDI1MCkKICAgICAgfQogICAgfSkuYmluZCgndG91Y2hjYW5jZWwnLCBmdW5jdGlvbigpewogICAgICBpZiAodG91Y2hUaW1lb3V0KSBjbGVhclRpbWVvdXQodG91Y2hUaW1lb3V0KQogICAgICBpZiAobG9uZ1RhcFRpbWVvdXQpIGNsZWFyVGltZW91dChsb25nVGFwVGltZW91dCkKICAgICAgbG9uZ1RhcFRpbWVvdXQgPSB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgIHRvdWNoID0ge30KICAgIH0pCiAgfSkKCiAgO1snc3dpcGUnLCAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnLCAnc3dpcGVVcCcsICdzd2lwZURvd24nLCAnZG91YmxlVGFwJywgJ3RhcCcsICdzaW5nbGVUYXAnLCAnbG9uZ1RhcCddLmZvckVhY2goZnVuY3Rpb24obSl7CiAgICAkLmZuW21dID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKG0sIGNhbGxiYWNrKSB9CiAgfSkKfSkoWmVwdG8pCgovLyBsaWIvaGFuZGxlYmFycy9iYXNlLmpzCgovKmpzaGludCBlcW51bGw6dHJ1ZSovCnRoaXMuSGFuZGxlYmFycyA9IHt9OwoKKGZ1bmN0aW9uKEhhbmRsZWJhcnMpIHsKCkhhbmRsZWJhcnMuVkVSU0lPTiA9ICIxLjAucmMuMSI7CgpIYW5kbGViYXJzLmhlbHBlcnMgID0ge307CkhhbmRsZWJhcnMucGFydGlhbHMgPSB7fTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogIGlmKGludmVyc2UpIHsgZm4ubm90ID0gaW52ZXJzZTsgfQogIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZuOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwgPSBmdW5jdGlvbihuYW1lLCBzdHIpIHsKICB0aGlzLnBhcnRpYWxzW25hbWVdID0gc3RyOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGFyZykgewogIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGZpbmQgcHJvcGVydHkgJyIgKyBhcmcgKyAiJyIpOwogIH0KfSk7Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLCBmdW5jdGlvblR5cGUgPSAiW29iamVjdCBGdW5jdGlvbl0iOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCgogIHZhciByZXQgPSAiIjsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CgogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmKGNvbnRleHQgPT09IHRydWUpIHsKICAgIHJldHVybiBmbih0aGlzKTsKICB9IGVsc2UgaWYoY29udGV4dCA9PT0gZmFsc2UgfHwgY29udGV4dCA9PSBudWxsKSB7CiAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgaWYodHlwZSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgaWYoY29udGV4dC5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnMuZWFjaChjb250ZXh0LCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpbnZlcnNlKHRoaXMpOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gZm4oY29udGV4dCk7CiAgfQp9KTsKCkhhbmRsZWJhcnMuSyA9IGZ1bmN0aW9uKCkge307CgpIYW5kbGViYXJzLmNyZWF0ZUZyYW1lID0gT2JqZWN0LmNyZWF0ZSB8fCBmdW5jdGlvbihvYmplY3QpIHsKICBIYW5kbGViYXJzLksucHJvdG90eXBlID0gb2JqZWN0OwogIHZhciBvYmogPSBuZXcgSGFuZGxlYmFycy5LKCk7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG51bGw7CiAgcmV0dXJuIG9iajsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VhY2gnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGZuID0gb3B0aW9ucy5mbiwgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZTsKICB2YXIgcmV0ID0gIiIsIGRhdGE7CgogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIGRhdGEgPSBIYW5kbGViYXJzLmNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgfQoKICBpZihjb250ZXh0ICYmIGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgZm9yKHZhciBpPTAsIGo9Y29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CiAgICAgIGlmIChkYXRhKSB7IGRhdGEuaW5kZXggPSBpOyB9CiAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRbaV0sIHsgZGF0YTogZGF0YSB9KTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0ID0gaW52ZXJzZSh0aGlzKTsKICB9CiAgcmV0dXJuIHJldDsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZicsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CiAgaWYodHlwZSA9PT0gZnVuY3Rpb25UeXBlKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH0KCiAgaWYoIWNvbnRleHQgfHwgSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbnRleHQpKSB7CiAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzKTsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndW5sZXNzJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgb3B0aW9ucy5mbiA9IGludmVyc2U7CiAgb3B0aW9ucy5pbnZlcnNlID0gZm47CgogIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnNbJ2lmJ10uY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd3aXRoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHJldHVybiBvcHRpb25zLmZuKGNvbnRleHQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGZ1bmN0aW9uKGNvbnRleHQpIHsKICBIYW5kbGViYXJzLmxvZyhjb250ZXh0KTsKfSk7Cgp9KHRoaXMuSGFuZGxlYmFycykpOwo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL3BhcnNlci5qcwovKiBKaXNvbiBnZW5lcmF0ZWQgcGFyc2VyICovCnZhciBoYW5kbGViYXJzID0gKGZ1bmN0aW9uKCl7CnZhciBwYXJzZXIgPSB7dHJhY2U6IGZ1bmN0aW9uIHRyYWNlKCkgeyB9LAp5eToge30sCnN5bWJvbHNfOiB7ImVycm9yIjoyLCJyb290IjozLCJwcm9ncmFtIjo0LCJFT0YiOjUsInN0YXRlbWVudHMiOjYsInNpbXBsZUludmVyc2UiOjcsInN0YXRlbWVudCI6OCwib3BlbkludmVyc2UiOjksImNsb3NlQmxvY2siOjEwLCJvcGVuQmxvY2siOjExLCJtdXN0YWNoZSI6MTIsInBhcnRpYWwiOjEzLCJDT05URU5UIjoxNCwiQ09NTUVOVCI6MTUsIk9QRU5fQkxPQ0siOjE2LCJpbk11c3RhY2hlIjoxNywiQ0xPU0UiOjE4LCJPUEVOX0lOVkVSU0UiOjE5LCJPUEVOX0VOREJMT0NLIjoyMCwicGF0aCI6MjEsIk9QRU4iOjIyLCJPUEVOX1VORVNDQVBFRCI6MjMsIk9QRU5fUEFSVElBTCI6MjQsInBhcmFtcyI6MjUsImhhc2giOjI2LCJEQVRBIjoyNywicGFyYW0iOjI4LCJTVFJJTkciOjI5LCJJTlRFR0VSIjozMCwiQk9PTEVBTiI6MzEsImhhc2hTZWdtZW50cyI6MzIsImhhc2hTZWdtZW50IjozMywiSUQiOjM0LCJFUVVBTFMiOjM1LCJwYXRoU2VnbWVudHMiOjM2LCJTRVAiOjM3LCIkYWNjZXB0IjowLCIkZW5kIjoxfSwKdGVybWluYWxzXzogezI6ImVycm9yIiw1OiJFT0YiLDE0OiJDT05URU5UIiwxNToiQ09NTUVOVCIsMTY6Ik9QRU5fQkxPQ0siLDE4OiJDTE9TRSIsMTk6Ik9QRU5fSU5WRVJTRSIsMjA6Ik9QRU5fRU5EQkxPQ0siLDIyOiJPUEVOIiwyMzoiT1BFTl9VTkVTQ0FQRUQiLDI0OiJPUEVOX1BBUlRJQUwiLDI3OiJEQVRBIiwyOToiU1RSSU5HIiwzMDoiSU5URUdFUiIsMzE6IkJPT0xFQU4iLDM0OiJJRCIsMzU6IkVRVUFMUyIsMzc6IlNFUCJ9LApwcm9kdWN0aW9uc186IFswLFszLDJdLFs0LDNdLFs0LDFdLFs0LDBdLFs2LDFdLFs2LDJdLFs4LDNdLFs4LDNdLFs4LDFdLFs4LDFdLFs4LDFdLFs4LDFdLFsxMSwzXSxbOSwzXSxbMTAsM10sWzEyLDNdLFsxMiwzXSxbMTMsM10sWzEzLDRdLFs3LDJdLFsxNywzXSxbMTcsMl0sWzE3LDJdLFsxNywxXSxbMTcsMV0sWzI1LDJdLFsyNSwxXSxbMjgsMV0sWzI4LDFdLFsyOCwxXSxbMjgsMV0sWzI4LDFdLFsyNiwxXSxbMzIsMl0sWzMyLDFdLFszMywzXSxbMzMsM10sWzMzLDNdLFszMywzXSxbMzMsM10sWzIxLDFdLFszNiwzXSxbMzYsMV1dLApwZXJmb3JtQWN0aW9uOiBmdW5jdGlvbiBhbm9ueW1vdXMoeXl0ZXh0LHl5bGVuZyx5eWxpbmVubyx5eSx5eXN0YXRlLCQkLF8kKSB7Cgp2YXIgJDAgPSAkJC5sZW5ndGggLSAxOwpzd2l0Y2ggKHl5c3RhdGUpIHsKY2FzZSAxOiByZXR1cm4gJCRbJDAtMV07IApicmVhazsKY2FzZSAyOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDAtMl0sICQkWyQwXSk7IApicmVhazsKY2FzZSAzOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDQ6IHRoaXMuJCA9IG5ldyB5eS5Qcm9ncmFtTm9kZShbXSk7IApicmVhazsKY2FzZSA1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSA3OiB0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMC0xXSwgJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDg6IHRoaXMuJCA9IG5ldyB5eS5CbG9ja05vZGUoJCRbJDAtMl0sICQkWyQwLTFdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMF0pOyAKYnJlYWs7CmNhc2UgOTogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMTA6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDExOiB0aGlzLiQgPSBuZXcgeXkuQ29udGVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEyOiB0aGlzLiQgPSBuZXcgeXkuQ29tbWVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEzOiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSk7IApicmVhazsKY2FzZSAxNDogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0pOyAKYnJlYWs7CmNhc2UgMTU6IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMTY6IHRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdKTsgCmJyZWFrOwpjYXNlIDE3OiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSwgdHJ1ZSk7IApicmVhazsKY2FzZSAxODogdGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOb2RlKCQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDE5OiB0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5vZGUoJCRbJDAtMl0sICQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDIwOiAKYnJlYWs7CmNhc2UgMjE6IHRoaXMuJCA9IFtbJCRbJDAtMl1dLmNvbmNhdCgkJFskMC0xXSksICQkWyQwXV07IApicmVhazsKY2FzZSAyMjogdGhpcy4kID0gW1skJFskMC0xXV0uY29uY2F0KCQkWyQwXSksIG51bGxdOyAKYnJlYWs7CmNhc2UgMjM6IHRoaXMuJCA9IFtbJCRbJDAtMV1dLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMjQ6IHRoaXMuJCA9IFtbJCRbJDBdXSwgbnVsbF07IApicmVhazsKY2FzZSAyNTogdGhpcy4kID0gW1tuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKV0sIG51bGxdOyAKYnJlYWs7CmNhc2UgMjY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSAyNzogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSAyODogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMjk6IHRoaXMuJCA9IG5ldyB5eS5TdHJpbmdOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMDogdGhpcy4kID0gbmV3IHl5LkludGVnZXJOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMTogdGhpcy4kID0gbmV3IHl5LkJvb2xlYW5Ob2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMjogdGhpcy4kID0gbmV3IHl5LkRhdGFOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMzogdGhpcy4kID0gbmV3IHl5Lkhhc2hOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzNDogJCRbJDAtMV0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0xXTsgCmJyZWFrOwpjYXNlIDM1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDM2OiB0aGlzLiQgPSBbJCRbJDAtMl0sICQkWyQwXV07IApicmVhazsKY2FzZSAzNzogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuU3RyaW5nTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM4OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5JbnRlZ2VyTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM5OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQwOiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5EYXRhTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQxOiB0aGlzLiQgPSBuZXcgeXkuSWROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSA0MjogJCRbJDAtMl0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0yXTsgCmJyZWFrOwpjYXNlIDQzOiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwp9Cn0sCnRhYmxlOiBbezM6MSw0OjIsNTpbMiw0XSw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezE6WzNdfSx7NTpbMSwxNl19LHs1OlsyLDNdLDc6MTcsODoxOCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxOV0sMjA6WzIsM10sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDVdLDE0OlsyLDVdLDE1OlsyLDVdLDE2OlsyLDVdLDE5OlsyLDVdLDIwOlsyLDVdLDIyOlsyLDVdLDIzOlsyLDVdLDI0OlsyLDVdfSx7NDoyMCw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiw0XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezQ6MjEsNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNF0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDldLDE0OlsyLDldLDE1OlsyLDldLDE2OlsyLDldLDE5OlsyLDldLDIwOlsyLDldLDIyOlsyLDldLDIzOlsyLDldLDI0OlsyLDldfSx7NTpbMiwxMF0sMTQ6WzIsMTBdLDE1OlsyLDEwXSwxNjpbMiwxMF0sMTk6WzIsMTBdLDIwOlsyLDEwXSwyMjpbMiwxMF0sMjM6WzIsMTBdLDI0OlsyLDEwXX0sezU6WzIsMTFdLDE0OlsyLDExXSwxNTpbMiwxMV0sMTY6WzIsMTFdLDE5OlsyLDExXSwyMDpbMiwxMV0sMjI6WzIsMTFdLDIzOlsyLDExXSwyNDpbMiwxMV19LHs1OlsyLDEyXSwxNDpbMiwxMl0sMTU6WzIsMTJdLDE2OlsyLDEyXSwxOTpbMiwxMl0sMjA6WzIsMTJdLDIyOlsyLDEyXSwyMzpbMiwxMl0sMjQ6WzIsMTJdfSx7MTc6MjIsMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezE3OjI3LDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxNzoyOCwyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTc6MjksMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezIxOjMwLDM0OlsxLDI2XSwzNjoyNX0sezE6WzIsMV19LHs2OjMxLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDZdLDE0OlsyLDZdLDE1OlsyLDZdLDE2OlsyLDZdLDE5OlsyLDZdLDIwOlsyLDZdLDIyOlsyLDZdLDIzOlsyLDZdLDI0OlsyLDZdfSx7MTc6MjIsMTg6WzEsMzJdLDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxMDozMywyMDpbMSwzNF19LHsxMDozNSwyMDpbMSwzNF19LHsxODpbMSwzNl19LHsxODpbMiwyNF0sMjE6NDEsMjU6MzcsMjY6MzgsMjc6WzEsNDVdLDI4OjM5LDI5OlsxLDQyXSwzMDpbMSw0M10sMzE6WzEsNDRdLDMyOjQwLDMzOjQ2LDM0OlsxLDQ3XSwzNjoyNX0sezE4OlsyLDI1XX0sezE4OlsyLDQxXSwyNzpbMiw0MV0sMjk6WzIsNDFdLDMwOlsyLDQxXSwzMTpbMiw0MV0sMzQ6WzIsNDFdLDM3OlsxLDQ4XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM3OlsyLDQzXX0sezE4OlsxLDQ5XX0sezE4OlsxLDUwXX0sezE4OlsxLDUxXX0sezE4OlsxLDUyXSwyMTo1MywzNDpbMSwyNl0sMzY6MjV9LHs1OlsyLDJdLDg6MTgsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIwOlsyLDJdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7MTQ6WzIsMjBdLDE1OlsyLDIwXSwxNjpbMiwyMF0sMTk6WzIsMjBdLDIyOlsyLDIwXSwyMzpbMiwyMF0sMjQ6WzIsMjBdfSx7NTpbMiw3XSwxNDpbMiw3XSwxNTpbMiw3XSwxNjpbMiw3XSwxOTpbMiw3XSwyMDpbMiw3XSwyMjpbMiw3XSwyMzpbMiw3XSwyNDpbMiw3XX0sezIxOjU0LDM0OlsxLDI2XSwzNjoyNX0sezU6WzIsOF0sMTQ6WzIsOF0sMTU6WzIsOF0sMTY6WzIsOF0sMTk6WzIsOF0sMjA6WzIsOF0sMjI6WzIsOF0sMjM6WzIsOF0sMjQ6WzIsOF19LHsxNDpbMiwxNF0sMTU6WzIsMTRdLDE2OlsyLDE0XSwxOTpbMiwxNF0sMjA6WzIsMTRdLDIyOlsyLDE0XSwyMzpbMiwxNF0sMjQ6WzIsMTRdfSx7MTg6WzIsMjJdLDIxOjQxLDI2OjU1LDI3OlsxLDQ1XSwyODo1NiwyOTpbMSw0Ml0sMzA6WzEsNDNdLDMxOlsxLDQ0XSwzMjo0MCwzMzo0NiwzNDpbMSw0N10sMzY6MjV9LHsxODpbMiwyM119LHsxODpbMiwyN10sMjc6WzIsMjddLDI5OlsyLDI3XSwzMDpbMiwyN10sMzE6WzIsMjddLDM0OlsyLDI3XX0sezE4OlsyLDMzXSwzMzo1NywzNDpbMSw1OF19LHsxODpbMiwyOF0sMjc6WzIsMjhdLDI5OlsyLDI4XSwzMDpbMiwyOF0sMzE6WzIsMjhdLDM0OlsyLDI4XX0sezE4OlsyLDI5XSwyNzpbMiwyOV0sMjk6WzIsMjldLDMwOlsyLDI5XSwzMTpbMiwyOV0sMzQ6WzIsMjldfSx7MTg6WzIsMzBdLDI3OlsyLDMwXSwyOTpbMiwzMF0sMzA6WzIsMzBdLDMxOlsyLDMwXSwzNDpbMiwzMF19LHsxODpbMiwzMV0sMjc6WzIsMzFdLDI5OlsyLDMxXSwzMDpbMiwzMV0sMzE6WzIsMzFdLDM0OlsyLDMxXX0sezE4OlsyLDMyXSwyNzpbMiwzMl0sMjk6WzIsMzJdLDMwOlsyLDMyXSwzMTpbMiwzMl0sMzQ6WzIsMzJdfSx7MTg6WzIsMzVdLDM0OlsyLDM1XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM1OlsxLDU5XSwzNzpbMiw0M119LHszNDpbMSw2MF19LHsxNDpbMiwxM10sMTU6WzIsMTNdLDE2OlsyLDEzXSwxOTpbMiwxM10sMjA6WzIsMTNdLDIyOlsyLDEzXSwyMzpbMiwxM10sMjQ6WzIsMTNdfSx7NTpbMiwxNl0sMTQ6WzIsMTZdLDE1OlsyLDE2XSwxNjpbMiwxNl0sMTk6WzIsMTZdLDIwOlsyLDE2XSwyMjpbMiwxNl0sMjM6WzIsMTZdLDI0OlsyLDE2XX0sezU6WzIsMTddLDE0OlsyLDE3XSwxNTpbMiwxN10sMTY6WzIsMTddLDE5OlsyLDE3XSwyMDpbMiwxN10sMjI6WzIsMTddLDIzOlsyLDE3XSwyNDpbMiwxN119LHs1OlsyLDE4XSwxNDpbMiwxOF0sMTU6WzIsMThdLDE2OlsyLDE4XSwxOTpbMiwxOF0sMjA6WzIsMThdLDIyOlsyLDE4XSwyMzpbMiwxOF0sMjQ6WzIsMThdfSx7MTg6WzEsNjFdfSx7MTg6WzEsNjJdfSx7MTg6WzIsMjFdfSx7MTg6WzIsMjZdLDI3OlsyLDI2XSwyOTpbMiwyNl0sMzA6WzIsMjZdLDMxOlsyLDI2XSwzNDpbMiwyNl19LHsxODpbMiwzNF0sMzQ6WzIsMzRdfSx7MzU6WzEsNTldfSx7MjE6NjMsMjc6WzEsNjddLDI5OlsxLDY0XSwzMDpbMSw2NV0sMzE6WzEsNjZdLDM0OlsxLDI2XSwzNjoyNX0sezE4OlsyLDQyXSwyNzpbMiw0Ml0sMjk6WzIsNDJdLDMwOlsyLDQyXSwzMTpbMiw0Ml0sMzQ6WzIsNDJdLDM3OlsyLDQyXX0sezU6WzIsMTldLDE0OlsyLDE5XSwxNTpbMiwxOV0sMTY6WzIsMTldLDE5OlsyLDE5XSwyMDpbMiwxOV0sMjI6WzIsMTldLDIzOlsyLDE5XSwyNDpbMiwxOV19LHs1OlsyLDE1XSwxNDpbMiwxNV0sMTU6WzIsMTVdLDE2OlsyLDE1XSwxOTpbMiwxNV0sMjA6WzIsMTVdLDIyOlsyLDE1XSwyMzpbMiwxNV0sMjQ6WzIsMTVdfSx7MTg6WzIsMzZdLDM0OlsyLDM2XX0sezE4OlsyLDM3XSwzNDpbMiwzN119LHsxODpbMiwzOF0sMzQ6WzIsMzhdfSx7MTg6WzIsMzldLDM0OlsyLDM5XX0sezE4OlsyLDQwXSwzNDpbMiw0MF19XSwKZGVmYXVsdEFjdGlvbnM6IHsxNjpbMiwxXSwyNDpbMiwyNV0sMzg6WzIsMjNdLDU1OlsyLDIxXX0sCnBhcnNlRXJyb3I6IGZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKfSwKcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKGlucHV0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIHN0YWNrID0gWzBdLCB2c3RhY2sgPSBbbnVsbF0sIGxzdGFjayA9IFtdLCB0YWJsZSA9IHRoaXMudGFibGUsIHl5dGV4dCA9ICIiLCB5eWxpbmVubyA9IDAsIHl5bGVuZyA9IDAsIHJlY292ZXJpbmcgPSAwLCBURVJST1IgPSAyLCBFT0YgPSAxOwogICAgdGhpcy5sZXhlci5zZXRJbnB1dChpbnB1dCk7CiAgICB0aGlzLmxleGVyLnl5ID0gdGhpcy55eTsKICAgIHRoaXMueXkubGV4ZXIgPSB0aGlzLmxleGVyOwogICAgdGhpcy55eS5wYXJzZXIgPSB0aGlzOwogICAgaWYgKHR5cGVvZiB0aGlzLmxleGVyLnl5bGxvYyA9PSAidW5kZWZpbmVkIikKICAgICAgICB0aGlzLmxleGVyLnl5bGxvYyA9IHt9OwogICAgdmFyIHl5bG9jID0gdGhpcy5sZXhlci55eWxsb2M7CiAgICBsc3RhY2sucHVzaCh5eWxvYyk7CiAgICB2YXIgcmFuZ2VzID0gdGhpcy5sZXhlci5vcHRpb25zICYmIHRoaXMubGV4ZXIub3B0aW9ucy5yYW5nZXM7CiAgICBpZiAodHlwZW9mIHRoaXMueXkucGFyc2VFcnJvciA9PT0gImZ1bmN0aW9uIikKICAgICAgICB0aGlzLnBhcnNlRXJyb3IgPSB0aGlzLnl5LnBhcnNlRXJyb3I7CiAgICBmdW5jdGlvbiBwb3BTdGFjayhuKSB7CiAgICAgICAgc3RhY2subGVuZ3RoID0gc3RhY2subGVuZ3RoIC0gMiAqIG47CiAgICAgICAgdnN0YWNrLmxlbmd0aCA9IHZzdGFjay5sZW5ndGggLSBuOwogICAgICAgIGxzdGFjay5sZW5ndGggPSBsc3RhY2subGVuZ3RoIC0gbjsKICAgIH0KICAgIGZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgdG9rZW4gPSBzZWxmLmxleGVyLmxleCgpIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdG9rZW4gPSBzZWxmLnN5bWJvbHNfW3Rva2VuXSB8fCB0b2tlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQogICAgdmFyIHN5bWJvbCwgcHJlRXJyb3JTeW1ib2wsIHN0YXRlLCBhY3Rpb24sIGEsIHIsIHl5dmFsID0ge30sIHAsIGxlbiwgbmV3U3RhdGUsIGV4cGVjdGVkOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmICh0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXSkgewogICAgICAgICAgICBhY3Rpb24gPSB0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc3ltYm9sID09PSBudWxsIHx8IHR5cGVvZiBzeW1ib2wgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IGxleCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdGlvbiA9IHRhYmxlW3N0YXRlXSAmJiB0YWJsZVtzdGF0ZV1bc3ltYm9sXTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJ1bmRlZmluZWQiIHx8ICFhY3Rpb24ubGVuZ3RoIHx8ICFhY3Rpb25bMF0pIHsKICAgICAgICAgICAgdmFyIGVyclN0ciA9ICIiOwogICAgICAgICAgICBpZiAoIXJlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gdGFibGVbc3RhdGVdKQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlcm1pbmFsc19bcF0gJiYgcCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQucHVzaCgiJyIgKyB0aGlzLnRlcm1pbmFsc19bcF0gKyAiJyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmxleGVyLnNob3dQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICJQYXJzZSBlcnJvciBvbiBsaW5lICIgKyAoeXlsaW5lbm8gKyAxKSArICI6XG4iICsgdGhpcy5sZXhlci5zaG93UG9zaXRpb24oKSArICJcbkV4cGVjdGluZyAiICsgZXhwZWN0ZWQuam9pbigiLCAiKSArICIsIGdvdCAnIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJTdHIgPSAiUGFyc2UgZXJyb3Igb24gbGluZSAiICsgKHl5bGluZW5vICsgMSkgKyAiOiBVbmV4cGVjdGVkICIgKyAoc3ltYm9sID09IDE/ImVuZCBvZiBpbnB1dCI6IiciICsgKHRoaXMudGVybWluYWxzX1tzeW1ib2xdIHx8IHN5bWJvbCkgKyAiJyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wYXJzZUVycm9yKGVyclN0ciwge3RleHQ6IHRoaXMubGV4ZXIubWF0Y2gsIHRva2VuOiB0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wsIGxpbmU6IHRoaXMubGV4ZXIueXlsaW5lbm8sIGxvYzogeXlsb2MsIGV4cGVjdGVkOiBleHBlY3RlZH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhY3Rpb25bMF0gaW5zdGFuY2VvZiBBcnJheSAmJiBhY3Rpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhcnNlIEVycm9yOiBtdWx0aXBsZSBhY3Rpb25zIHBvc3NpYmxlIGF0IHN0YXRlOiAiICsgc3RhdGUgKyAiLCB0b2tlbjogIiArIHN5bWJvbCk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoYWN0aW9uWzBdKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBzdGFjay5wdXNoKHN5bWJvbCk7CiAgICAgICAgICAgIHZzdGFjay5wdXNoKHRoaXMubGV4ZXIueXl0ZXh0KTsKICAgICAgICAgICAgbHN0YWNrLnB1c2godGhpcy5sZXhlci55eWxsb2MpOwogICAgICAgICAgICBzdGFjay5wdXNoKGFjdGlvblsxXSk7CiAgICAgICAgICAgIHN5bWJvbCA9IG51bGw7CiAgICAgICAgICAgIGlmICghcHJlRXJyb3JTeW1ib2wpIHsKICAgICAgICAgICAgICAgIHl5bGVuZyA9IHRoaXMubGV4ZXIueXlsZW5nOwogICAgICAgICAgICAgICAgeXl0ZXh0ID0gdGhpcy5sZXhlci55eXRleHQ7CiAgICAgICAgICAgICAgICB5eWxpbmVubyA9IHRoaXMubGV4ZXIueXlsaW5lbm87CiAgICAgICAgICAgICAgICB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgICAgICAgICAgICAgaWYgKHJlY292ZXJpbmcgPiAwKQogICAgICAgICAgICAgICAgICAgIHJlY292ZXJpbmctLTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IHByZUVycm9yU3ltYm9sOwogICAgICAgICAgICAgICAgcHJlRXJyb3JTeW1ib2wgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVsxXTsKICAgICAgICAgICAgeXl2YWwuJCA9IHZzdGFja1t2c3RhY2subGVuZ3RoIC0gbGVuXTsKICAgICAgICAgICAgeXl2YWwuXyQgPSB7Zmlyc3RfbGluZTogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAobGVuIHx8IDEpXS5maXJzdF9saW5lLCBsYXN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9saW5lLCBmaXJzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfY29sdW1uLCBsYXN0X2NvbHVtbjogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAxXS5sYXN0X2NvbHVtbn07CiAgICAgICAgICAgIGlmIChyYW5nZXMpIHsKICAgICAgICAgICAgICAgIHl5dmFsLl8kLnJhbmdlID0gW2xzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0ucmFuZ2VbMF0sIGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ucmFuZ2VbMV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIgPSB0aGlzLnBlcmZvcm1BY3Rpb24uY2FsbCh5eXZhbCwgeXl0ZXh0LCB5eWxlbmcsIHl5bGluZW5vLCB0aGlzLnl5LCBhY3Rpb25bMV0sIHZzdGFjaywgbHN0YWNrKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZSgwLCAtMSAqIGxlbiAqIDIpOwogICAgICAgICAgICAgICAgdnN0YWNrID0gdnN0YWNrLnNsaWNlKDAsIC0xICogbGVuKTsKICAgICAgICAgICAgICAgIGxzdGFjayA9IGxzdGFjay5zbGljZSgwLCAtMSAqIGxlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnByb2R1Y3Rpb25zX1thY3Rpb25bMV1dWzBdKTsKICAgICAgICAgICAgdnN0YWNrLnB1c2goeXl2YWwuJCk7CiAgICAgICAgICAgIGxzdGFjay5wdXNoKHl5dmFsLl8kKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB0YWJsZVtzdGFja1tzdGFjay5sZW5ndGggLSAyXV1bc3RhY2tbc3RhY2subGVuZ3RoIC0gMV1dOwogICAgICAgICAgICBzdGFjay5wdXNoKG5ld1N0YXRlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQp9OwovKiBKaXNvbiBnZW5lcmF0ZWQgbGV4ZXIgKi8KdmFyIGxleGVyID0gKGZ1bmN0aW9uKCl7CnZhciBsZXhlciA9ICh7RU9GOjEsCnBhcnNlRXJyb3I6ZnVuY3Rpb24gcGFyc2VFcnJvcihzdHIsIGhhc2gpIHsKICAgICAgICBpZiAodGhpcy55eS5wYXJzZXIpIHsKICAgICAgICAgICAgdGhpcy55eS5wYXJzZXIucGFyc2VFcnJvcihzdHIsIGhhc2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdHIpOwogICAgICAgIH0KICAgIH0sCnNldElucHV0OmZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHRoaXMuX2lucHV0ID0gaW5wdXQ7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRoaXMuX2xlc3MgPSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnl5bGluZW5vID0gdGhpcy55eWxlbmcgPSAwOwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaCA9ICcnOwogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sgPSBbJ0lOSVRJQUwnXTsKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOjEsZmlyc3RfY29sdW1uOjAsbGFzdF9saW5lOjEsbGFzdF9jb2x1bW46MH07CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlID0gWzAsMF07CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKaW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaCA9IHRoaXMuX2lucHV0WzBdOwogICAgICAgIHRoaXMueXl0ZXh0ICs9IGNoOwogICAgICAgIHRoaXMueXlsZW5nKys7CiAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICB0aGlzLm1hdGNoICs9IGNoOwogICAgICAgIHRoaXMubWF0Y2hlZCArPSBjaDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgaWYgKGxpbmVzKSB7CiAgICAgICAgICAgIHRoaXMueXlsaW5lbm8rKzsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9saW5lKys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9jb2x1bW4rKzsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlWzFdKys7CgogICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UoMSk7CiAgICAgICAgcmV0dXJuIGNoOwogICAgfSwKdW5wdXQ6ZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdmFyIGxlbiA9IGNoLmxlbmd0aDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwoKICAgICAgICB0aGlzLl9pbnB1dCA9IGNoICsgdGhpcy5faW5wdXQ7CiAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLnl5dGV4dC5zdWJzdHIoMCwgdGhpcy55eXRleHQubGVuZ3RoLWxlbi0xKTsKICAgICAgICAvL3RoaXMueXlsZW5nIC09IGxlbjsKICAgICAgICB0aGlzLm9mZnNldCAtPSBsZW47CiAgICAgICAgdmFyIG9sZExpbmVzID0gdGhpcy5tYXRjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwogICAgICAgIHRoaXMubWF0Y2ggPSB0aGlzLm1hdGNoLnN1YnN0cigwLCB0aGlzLm1hdGNoLmxlbmd0aC0xKTsKICAgICAgICB0aGlzLm1hdGNoZWQgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGgtMSk7CgogICAgICAgIGlmIChsaW5lcy5sZW5ndGgtMSkgdGhpcy55eWxpbmVubyAtPSBsaW5lcy5sZW5ndGgtMTsKICAgICAgICB2YXIgciA9IHRoaXMueXlsbG9jLnJhbmdlOwoKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5maXJzdF9saW5lLAogICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiwKICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/CiAgICAgICAgICAgICAgKGxpbmVzLmxlbmd0aCA9PT0gb2xkTGluZXMubGVuZ3RoID8gdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIDogMCkgKyBvbGRMaW5lc1tvbGRMaW5lcy5sZW5ndGggLSBsaW5lcy5sZW5ndGhdLmxlbmd0aCAtIGxpbmVzWzBdLmxlbmd0aDoKICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5maXJzdF9jb2x1bW4gLSBsZW4KICAgICAgICAgIH07CgogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLnJhbmdlID0gW3JbMF0sIHJbMF0gKyB0aGlzLnl5bGVuZyAtIGxlbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbW9yZTpmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LApsZXNzOmZ1bmN0aW9uIChuKSB7CiAgICAgICAgdGhpcy51bnB1dCh0aGlzLm1hdGNoLnNsaWNlKG4pKTsKICAgIH0sCnBhc3RJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBhc3QgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGggLSB0aGlzLm1hdGNoLmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIChwYXN0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpICsgcGFzdC5zdWJzdHIoLTIwKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LAp1cGNvbWluZ0lucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmV4dCA9IHRoaXMubWF0Y2g7CiAgICAgICAgaWYgKG5leHQubGVuZ3RoIDwgMjApIHsKICAgICAgICAgICAgbmV4dCArPSB0aGlzLl9pbnB1dC5zdWJzdHIoMCwgMjAtbmV4dC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKG5leHQuc3Vic3RyKDAsMjApKyhuZXh0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LApzaG93UG9zaXRpb246ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcmUgPSB0aGlzLnBhc3RJbnB1dCgpOwogICAgICAgIHZhciBjID0gbmV3IEFycmF5KHByZS5sZW5ndGggKyAxKS5qb2luKCItIik7CiAgICAgICAgcmV0dXJuIHByZSArIHRoaXMudXBjb21pbmdJbnB1dCgpICsgIlxuIiArIGMrIl4iOwogICAgfSwKbmV4dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMuZG9uZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faW5wdXQpIHRoaXMuZG9uZSA9IHRydWU7CgogICAgICAgIHZhciB0b2tlbiwKICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgIHRlbXBNYXRjaCwKICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgIGNvbCwKICAgICAgICAgICAgbGluZXM7CiAgICAgICAgaWYgKCF0aGlzLl9tb3JlKSB7CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ID0gJyc7CiAgICAgICAgICAgIHRoaXMubWF0Y2ggPSAnJzsKICAgICAgICB9CiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5fY3VycmVudFJ1bGVzKCk7CiAgICAgICAgZm9yICh2YXIgaT0wO2kgPCBydWxlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0ZW1wTWF0Y2ggPSB0aGlzLl9pbnB1dC5tYXRjaCh0aGlzLnJ1bGVzW3J1bGVzW2ldXSk7CiAgICAgICAgICAgIGlmICh0ZW1wTWF0Y2ggJiYgKCFtYXRjaCB8fCB0ZW1wTWF0Y2hbMF0ubGVuZ3RoID4gbWF0Y2hbMF0ubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgbWF0Y2ggPSB0ZW1wTWF0Y2g7CiAgICAgICAgICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5mbGV4KSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgbGluZXMgPSBtYXRjaFswXS5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMueXlsbG9jID0ge2ZpcnN0X2xpbmU6IHRoaXMueXlsbG9jLmxhc3RfbGluZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/IGxpbmVzW2xpbmVzLmxlbmd0aC0xXS5sZW5ndGgtbGluZXNbbGluZXMubGVuZ3RoLTFdLm1hdGNoKC9ccj9cbj8vKVswXS5sZW5ndGggOiB0aGlzLnl5bGxvYy5sYXN0X2NvbHVtbiArIG1hdGNoWzBdLmxlbmd0aH07CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaDsKICAgICAgICAgICAgdGhpcy55eWxlbmcgPSB0aGlzLnl5dGV4dC5sZW5ndGg7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5yYW5nZSA9IFt0aGlzLm9mZnNldCwgdGhpcy5vZmZzZXQgKz0gdGhpcy55eWxlbmddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21vcmUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faW5wdXQgPSB0aGlzLl9pbnB1dC5zbGljZShtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICB0aGlzLm1hdGNoZWQgKz0gbWF0Y2hbMF07CiAgICAgICAgICAgIHRva2VuID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwodGhpcywgdGhpcy55eSwgdGhpcywgcnVsZXNbaW5kZXhdLHRoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV0pOwogICAgICAgICAgICBpZiAodGhpcy5kb25lICYmIHRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRva2VuKSByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIGVsc2UgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5wdXQgPT09ICIiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUVycm9yKCdMZXhpY2FsIGVycm9yIG9uIGxpbmUgJysodGhpcy55eWxpbmVubysxKSsnLiBVbnJlY29nbml6ZWQgdGV4dC5cbicrdGhpcy5zaG93UG9zaXRpb24oKSwKICAgICAgICAgICAgICAgICAgICB7dGV4dDogIiIsIHRva2VuOiBudWxsLCBsaW5lOiB0aGlzLnl5bGluZW5vfSk7CiAgICAgICAgfQogICAgfSwKbGV4OmZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgciA9IHRoaXMubmV4dCgpOwogICAgICAgIGlmICh0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGV4KCk7CiAgICAgICAgfQogICAgfSwKYmVnaW46ZnVuY3Rpb24gYmVnaW4oY29uZGl0aW9uKSB7CiAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjay5wdXNoKGNvbmRpdGlvbik7CiAgICB9LApwb3BTdGF0ZTpmdW5jdGlvbiBwb3BTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFjay5wb3AoKTsKICAgIH0sCl9jdXJyZW50UnVsZXM6ZnVuY3Rpb24gX2N1cnJlbnRSdWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25zW3RoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV1dLnJ1bGVzOwogICAgfSwKdG9wU3RhdGU6ZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTJdOwogICAgfSwKcHVzaFN0YXRlOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuYmVnaW4oY29uZGl0aW9uKTsKICAgIH19KTsKbGV4ZXIub3B0aW9ucyA9IHt9OwpsZXhlci5wZXJmb3JtQWN0aW9uID0gZnVuY3Rpb24gYW5vbnltb3VzKHl5LHl5XywkYXZvaWRpbmdfbmFtZV9jb2xsaXNpb25zLFlZX1NUQVJUKSB7Cgp2YXIgWVlTVEFURT1ZWV9TVEFSVApzd2l0Y2goJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucykgewpjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMuYmVnaW4oIm11Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgPT09ICJcXCIpIHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigwLHl5Xy55eWxlbmctMSksIHRoaXMuYmVnaW4oImVtdSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQpIHJldHVybiAxNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCmJyZWFrOwpjYXNlIDE6IHJldHVybiAxNDsgCmJyZWFrOwpjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMucG9wU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0LnNsaWNlKC0xKSA9PT0gIlxcIikgeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDAseXlfLnl5bGVuZy0xKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIApicmVhazsKY2FzZSAzOiByZXR1cm4gMjQ7IApicmVhazsKY2FzZSA0OiByZXR1cm4gMTY7IApicmVhazsKY2FzZSA1OiByZXR1cm4gMjA7IApicmVhazsKY2FzZSA2OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA3OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA4OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSA5OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSAxMDogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDMseXlfLnl5bGVuZy01KTsgdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTU7IApicmVhazsKY2FzZSAxMTogcmV0dXJuIDIyOyAKYnJlYWs7CmNhc2UgMTI6IHJldHVybiAzNTsgCmJyZWFrOwpjYXNlIDEzOiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAxNDogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMTU6IHJldHVybiAzNzsgCmJyZWFrOwpjYXNlIDE2OiAvKmlnbm9yZSB3aGl0ZXNwYWNlKi8gCmJyZWFrOwpjYXNlIDE3OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE4OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE5OiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIwOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIxOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSk7IHJldHVybiAyNzsgCmJyZWFrOwpjYXNlIDIyOiByZXR1cm4gMzE7IApicmVhazsKY2FzZSAyMzogcmV0dXJuIDMxOyAKYnJlYWs7CmNhc2UgMjQ6IHJldHVybiAzMDsgCmJyZWFrOwpjYXNlIDI1OiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAyNjogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEsIHl5Xy55eWxlbmctMik7IHJldHVybiAzNDsgCmJyZWFrOwpjYXNlIDI3OiByZXR1cm4gJ0lOVkFMSUQnOyAKYnJlYWs7CmNhc2UgMjg6IHJldHVybiA1OyAKYnJlYWs7Cn0KfTsKbGV4ZXIucnVsZXMgPSBbL14oPzpbXlx4MDBdKj8oPz0oXHtceykpKS8sL14oPzpbXlx4MDBdKykvLC9eKD86W15ceDAwXXsyLH0/KD89KFx7XHt8JCkpKS8sL14oPzpce1x7PikvLC9eKD86XHtceyMpLywvXig/Olx7XHtcLykvLC9eKD86XHtce1xeKS8sL14oPzpce1x7XHMqZWxzZVxiKS8sL14oPzpce1x7XHspLywvXig/Olx7XHsmKS8sL14oPzpce1x7IVtcc1xTXSo/XH1cfSkvLC9eKD86XHtceykvLC9eKD86PSkvLC9eKD86XC4oPz1bfSBdKSkvLC9eKD86XC5cLikvLC9eKD86W1wvLl0pLywvXig/OlxzKykvLC9eKD86XH1cfVx9KS8sL14oPzpcfVx9KS8sL14oPzoiKFxcWyJdfFteIl0pKiIpLywvXig/OicoXFxbJ118W14nXSkqJykvLC9eKD86QFthLXpBLVpdKykvLC9eKD86dHJ1ZSg/PVt9XHNdKSkvLC9eKD86ZmFsc2UoPz1bfVxzXSkpLywvXig/OlswLTldKyg/PVt9XHNdKSkvLC9eKD86W2EtekEtWjAtOV8kLV0rKD89Wz19XHNcLy5dKSkvLC9eKD86XFtbXlxdXSpcXSkvLC9eKD86LikvLC9eKD86JCkvXTsKbGV4ZXIuY29uZGl0aW9ucyA9IHsibXUiOnsicnVsZXMiOlszLDQsNSw2LDcsOCw5LDEwLDExLDEyLDEzLDE0LDE1LDE2LDE3LDE4LDE5LDIwLDIxLDIyLDIzLDI0LDI1LDI2LDI3LDI4XSwiaW5jbHVzaXZlIjpmYWxzZX0sImVtdSI6eyJydWxlcyI6WzJdLCJpbmNsdXNpdmUiOmZhbHNlfSwiSU5JVElBTCI6eyJydWxlcyI6WzAsMSwyOF0sImluY2x1c2l2ZSI6dHJ1ZX19OwpyZXR1cm4gbGV4ZXI7fSkoKQpwYXJzZXIubGV4ZXIgPSBsZXhlcjsKZnVuY3Rpb24gUGFyc2VyICgpIHsgdGhpcy55eSA9IHt9OyB9UGFyc2VyLnByb3RvdHlwZSA9IHBhcnNlcjtwYXJzZXIuUGFyc2VyID0gUGFyc2VyOwpyZXR1cm4gbmV3IFBhcnNlcjsKfSkoKTsKaWYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKZXhwb3J0cy5wYXJzZXIgPSBoYW5kbGViYXJzOwpleHBvcnRzLlBhcnNlciA9IGhhbmRsZWJhcnMuUGFyc2VyOwpleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gaGFuZGxlYmFycy5wYXJzZS5hcHBseShoYW5kbGViYXJzLCBhcmd1bWVudHMpOyB9CmV4cG9ydHMubWFpbiA9IGZ1bmN0aW9uIGNvbW1vbmpzTWFpbihhcmdzKSB7CiAgICBpZiAoIWFyZ3NbMV0pCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2FnZTogJythcmdzWzBdKycgRklMRScpOwogICAgdmFyIHNvdXJjZSwgY3dkOwogICAgaWYgKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHNvdXJjZSA9IHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHJlcXVpcmUoJ3BhdGgnKS5yZXNvbHZlKGFyZ3NbMV0pLCAidXRmOCIpOwogICAgfSBlbHNlIHsKICAgICAgICBzb3VyY2UgPSByZXF1aXJlKCJmaWxlIikucGF0aChyZXF1aXJlKCJmaWxlIikuY3dkKCkpLmpvaW4oYXJnc1sxXSkucmVhZCh7Y2hhcnNldDogInV0Zi04In0pOwogICAgfQogICAgcmV0dXJuIGV4cG9ydHMucGFyc2VyLnBhcnNlKHNvdXJjZSk7Cn0KaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7CiAgZXhwb3J0cy5tYWluKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyA/IHByb2Nlc3MuYXJndi5zbGljZSgxKSA6IHJlcXVpcmUoInN5c3RlbSIpLmFyZ3MpOwp9Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYmFzZS5qcwpIYW5kbGViYXJzLlBhcnNlciA9IGhhbmRsZWJhcnM7CgpIYW5kbGViYXJzLnBhcnNlID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgSGFuZGxlYmFycy5QYXJzZXIueXkgPSBIYW5kbGViYXJzLkFTVDsKICByZXR1cm4gSGFuZGxlYmFycy5QYXJzZXIucGFyc2Uoc3RyaW5nKTsKfTsKCkhhbmRsZWJhcnMucHJpbnQgPSBmdW5jdGlvbihhc3QpIHsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuUHJpbnRWaXNpdG9yKCkuYWNjZXB0KGFzdCk7Cn07CgpIYW5kbGViYXJzLmxvZ2dlciA9IHsKICBERUJVRzogMCwgSU5GTzogMSwgV0FSTjogMiwgRVJST1I6IDMsIGxldmVsOiAzLAoKICAvLyBvdmVycmlkZSBpbiB0aGUgaG9zdCBlbnZpcm9ubWVudAogIGxvZzogZnVuY3Rpb24obGV2ZWwsIHN0cikge30KfTsKCkhhbmRsZWJhcnMubG9nID0gZnVuY3Rpb24obGV2ZWwsIHN0cikgeyBIYW5kbGViYXJzLmxvZ2dlci5sb2cobGV2ZWwsIHN0cik7IH07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYXN0LmpzCihmdW5jdGlvbigpIHsKCiAgSGFuZGxlYmFycy5BU1QgPSB7fTsKCiAgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUgPSBmdW5jdGlvbihzdGF0ZW1lbnRzLCBpbnZlcnNlKSB7CiAgICB0aGlzLnR5cGUgPSAicHJvZ3JhbSI7CiAgICB0aGlzLnN0YXRlbWVudHMgPSBzdGF0ZW1lbnRzOwogICAgaWYoaW52ZXJzZSkgeyB0aGlzLmludmVyc2UgPSBuZXcgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUoaW52ZXJzZSk7IH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5NdXN0YWNoZU5vZGUgPSBmdW5jdGlvbihyYXdQYXJhbXMsIGhhc2gsIHVuZXNjYXBlZCkgewogICAgdGhpcy50eXBlID0gIm11c3RhY2hlIjsKICAgIHRoaXMuZXNjYXBlZCA9ICF1bmVzY2FwZWQ7CiAgICB0aGlzLmhhc2ggPSBoYXNoOwoKICAgIHZhciBpZCA9IHRoaXMuaWQgPSByYXdQYXJhbXNbMF07CiAgICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXMgPSByYXdQYXJhbXMuc2xpY2UoMSk7CgogICAgLy8gYSBtdXN0YWNoZSBpcyBhbiBlbGlnaWJsZSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0cyBpZCBpcyBzaW1wbGUgKGEgc2luZ2xlIHBhcnQsIG5vdCBgdGhpc2Agb3IgYC4uYCkKICAgIHZhciBlbGlnaWJsZUhlbHBlciA9IHRoaXMuZWxpZ2libGVIZWxwZXIgPSBpZC5pc1NpbXBsZTsKCiAgICAvLyBhIG11c3RhY2hlIGlzIGRlZmluaXRlbHkgYSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0IGlzIGFuIGVsaWdpYmxlIGhlbHBlciwgYW5kCiAgICAvLyAqIGl0IGhhcyBhdCBsZWFzdCBvbmUgcGFyYW1ldGVyIG9yIGhhc2ggc2VnbWVudAogICAgdGhpcy5pc0hlbHBlciA9IGVsaWdpYmxlSGVscGVyICYmIChwYXJhbXMubGVuZ3RoIHx8IGhhc2gpOwoKICAgIC8vIGlmIGEgbXVzdGFjaGUgaXMgYW4gZWxpZ2libGUgaGVscGVyIGJ1dCBub3QgYSBkZWZpbml0ZQogICAgLy8gaGVscGVyLCBpdCBpcyBhbWJpZ3VvdXMsIGFuZCB3aWxsIGJlIHJlc29sdmVkIGluIGEgbGF0ZXIKICAgIC8vIHBhc3Mgb3IgYXQgcnVudGltZS4KICB9OwoKICBIYW5kbGViYXJzLkFTVC5QYXJ0aWFsTm9kZSA9IGZ1bmN0aW9uKGlkLCBjb250ZXh0KSB7CiAgICB0aGlzLnR5cGUgICAgPSAicGFydGlhbCI7CgogICAgLy8gVE9ETzogZGlzYWxsb3cgY29tcGxleCBJRHMKCiAgICB0aGlzLmlkICAgICAgPSBpZDsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgfTsKCiAgdmFyIHZlcmlmeU1hdGNoID0gZnVuY3Rpb24ob3BlbiwgY2xvc2UpIHsKICAgIGlmKG9wZW4ub3JpZ2luYWwgIT09IGNsb3NlLm9yaWdpbmFsKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbihvcGVuLm9yaWdpbmFsICsgIiBkb2Vzbid0IG1hdGNoICIgKyBjbG9zZS5vcmlnaW5hbCk7CiAgICB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQmxvY2tOb2RlID0gZnVuY3Rpb24obXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UsIGNsb3NlKSB7CiAgICB2ZXJpZnlNYXRjaChtdXN0YWNoZS5pZCwgY2xvc2UpOwogICAgdGhpcy50eXBlID0gImJsb2NrIjsKICAgIHRoaXMubXVzdGFjaGUgPSBtdXN0YWNoZTsKICAgIHRoaXMucHJvZ3JhbSAgPSBwcm9ncmFtOwogICAgdGhpcy5pbnZlcnNlICA9IGludmVyc2U7CgogICAgaWYgKHRoaXMuaW52ZXJzZSAmJiAhdGhpcy5wcm9ncmFtKSB7CiAgICAgIHRoaXMuaXNJbnZlcnNlID0gdHJ1ZTsKICAgIH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5Db250ZW50Tm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gImNvbnRlbnQiOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuSGFzaE5vZGUgPSBmdW5jdGlvbihwYWlycykgewogICAgdGhpcy50eXBlID0gImhhc2giOwogICAgdGhpcy5wYWlycyA9IHBhaXJzOwogIH07CgogIEhhbmRsZWJhcnMuQVNULklkTm9kZSA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICB0aGlzLnR5cGUgPSAiSUQiOwogICAgdGhpcy5vcmlnaW5hbCA9IHBhcnRzLmpvaW4oIi4iKTsKCiAgICB2YXIgZGlnID0gW10sIGRlcHRoID0gMDsKCiAgICBmb3IodmFyIGk9MCxsPXBhcnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKCiAgICAgIGlmKHBhcnQgPT09ICIuLiIpIHsgZGVwdGgrKzsgfQogICAgICBlbHNlIGlmKHBhcnQgPT09ICIuIiB8fCBwYXJ0ID09PSAidGhpcyIpIHsgdGhpcy5pc1Njb3BlZCA9IHRydWU7IH0KICAgICAgZWxzZSB7IGRpZy5wdXNoKHBhcnQpOyB9CiAgICB9CgogICAgdGhpcy5wYXJ0cyAgICA9IGRpZzsKICAgIHRoaXMuc3RyaW5nICAgPSBkaWcuam9pbignLicpOwogICAgdGhpcy5kZXB0aCAgICA9IGRlcHRoOwoKICAgIC8vIGFuIElEIGlzIHNpbXBsZSBpZiBpdCBvbmx5IGhhcyBvbmUgcGFydCwgYW5kIHRoYXQgcGFydCBpcyBub3QKICAgIC8vIGAuLmAgb3IgYHRoaXNgLgogICAgdGhpcy5pc1NpbXBsZSA9IHBhcnRzLmxlbmd0aCA9PT0gMSAmJiAhdGhpcy5pc1Njb3BlZCAmJiBkZXB0aCA9PT0gMDsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5EYXRhTm9kZSA9IGZ1bmN0aW9uKGlkKSB7CiAgICB0aGlzLnR5cGUgPSAiREFUQSI7CiAgICB0aGlzLmlkID0gaWQ7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuU3RyaW5nTm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gIlNUUklORyI7CiAgICB0aGlzLnN0cmluZyA9IHN0cmluZzsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5JbnRlZ2VyTm9kZSA9IGZ1bmN0aW9uKGludGVnZXIpIHsKICAgIHRoaXMudHlwZSA9ICJJTlRFR0VSIjsKICAgIHRoaXMuaW50ZWdlciA9IGludGVnZXI7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQm9vbGVhbk5vZGUgPSBmdW5jdGlvbihib29sKSB7CiAgICB0aGlzLnR5cGUgPSAiQk9PTEVBTiI7CiAgICB0aGlzLmJvb2wgPSBib29sOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkNvbW1lbnROb2RlID0gZnVuY3Rpb24oY29tbWVudCkgewogICAgdGhpcy50eXBlID0gImNvbW1lbnQiOwogICAgdGhpcy5jb21tZW50ID0gY29tbWVudDsKICB9OwoKfSkoKTs7Ci8vIGxpYi9oYW5kbGViYXJzL3V0aWxzLmpzCkhhbmRsZWJhcnMuRXhjZXB0aW9uID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciB0bXAgPSBFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgZm9yICh2YXIgcCBpbiB0bXApIHsKICAgIGlmICh0bXAuaGFzT3duUHJvcGVydHkocCkpIHsgdGhpc1twXSA9IHRtcFtwXTsgfQogIH0KCiAgdGhpcy5tZXNzYWdlID0gdG1wLm1lc3NhZ2U7Cn07CkhhbmRsZWJhcnMuRXhjZXB0aW9uLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwoKLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKSGFuZGxlYmFycy5TYWZlU3RyaW5nID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7Cn07CkhhbmRsZWJhcnMuU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdHJpbmcudG9TdHJpbmcoKTsKfTsKCihmdW5jdGlvbigpIHsKICB2YXIgZXNjYXBlID0gewogICAgIiYiOiAiJmFtcDsiLAogICAgIjwiOiAiJmx0OyIsCiAgICAiPiI6ICImZ3Q7IiwKICAgICciJzogIiZxdW90OyIsCiAgICAiJyI6ICImI3gyNzsiLAogICAgImAiOiAiJiN4NjA7IgogIH07CgogIHZhciBiYWRDaGFycyA9IC9bJjw+IidgXS9nOwogIHZhciBwb3NzaWJsZSA9IC9bJjw+IidgXS87CgogIHZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24oY2hyKSB7CiAgICByZXR1cm4gZXNjYXBlW2Nocl0gfHwgIiZhbXA7IjsKICB9OwoKICBIYW5kbGViYXJzLlV0aWxzID0gewogICAgZXNjYXBlRXhwcmVzc2lvbjogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIC8vIGRvbid0IGVzY2FwZSBTYWZlU3RyaW5ncywgc2luY2UgdGhleSdyZSBhbHJlYWR5IHNhZmUKICAgICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcudG9TdHJpbmcoKTsKICAgICAgfSBlbHNlIGlmIChzdHJpbmcgPT0gbnVsbCB8fCBzdHJpbmcgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CgogICAgICBpZighcG9zc2libGUudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICAgIH0sCgogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9Owp9KSgpOzsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvY29tcGlsZXIuanMKCi8qanNoaW50IGVxbnVsbDp0cnVlKi8KSGFuZGxlYmFycy5Db21waWxlciA9IGZ1bmN0aW9uKCkge307CkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyID0gZnVuY3Rpb24oKSB7fTsKCihmdW5jdGlvbihDb21waWxlciwgSmF2YVNjcmlwdENvbXBpbGVyKSB7CiAgLy8gdGhlIGZvdW5kSGVscGVyIHJlZ2lzdGVyIHdpbGwgZGlzYW1iaWd1YXRlIGhlbHBlciBsb29rdXAgZnJvbSBmaW5kaW5nIGEKICAvLyBmdW5jdGlvbiBpbiBhIGNvbnRleHQuIFRoaXMgaXMgbmVjZXNzYXJ5IGZvciBtdXN0YWNoZSBjb21wYXRpYmlsaXR5LCB3aGljaAogIC8vIHJlcXVpcmVzIHRoYXQgY29udGV4dCBmdW5jdGlvbnMgaW4gYmxvY2tzIGFyZSBldmFsdWF0ZWQgYnkgYmxvY2tIZWxwZXJNaXNzaW5nLAogIC8vIGFuZCB0aGVuIHByb2NlZWQgYXMgaWYgdGhlIHJlc3VsdGluZyB2YWx1ZSB3YXMgcHJvdmlkZWQgdG8gYmxvY2tIZWxwZXJNaXNzaW5nLgoKICBDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICBjb21waWxlcjogQ29tcGlsZXIsCgogICAgZGlzYXNzZW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMub3Bjb2Rlcywgb3Bjb2RlLCBvdXQgPSBbXSwgcGFyYW1zLCBwYXJhbTsKCiAgICAgIGZvciAodmFyIGk9MCwgbD1vcGNvZGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW2ldOwoKICAgICAgICBpZiAob3Bjb2RlLm9wY29kZSA9PT0gJ0RFQ0xBUkUnKSB7CiAgICAgICAgICBvdXQucHVzaCgiREVDTEFSRSAiICsgb3Bjb2RlLm5hbWUgKyAiPSIgKyBvcGNvZGUudmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXJhbXMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGo9MDsgajxvcGNvZGUuYXJncy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBwYXJhbSA9IG9wY29kZS5hcmdzW2pdOwogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHBhcmFtID0gIlwiIiArIHBhcmFtLnJlcGxhY2UoIlxuIiwgIlxcbiIpICsgIlwiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICB9CiAgICAgICAgICBvdXQucHVzaChvcGNvZGUub3Bjb2RlICsgIiAiICsgcGFyYW1zLmpvaW4oIiAiKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gb3V0LmpvaW4oIlxuIik7CiAgICB9LAoKICAgIGd1aWQ6IDAsCgogICAgY29tcGlsZTogZnVuY3Rpb24ocHJvZ3JhbSwgb3B0aW9ucykgewogICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgIHRoaXMuZGVwdGhzID0ge2xpc3Q6IFtdfTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCiAgICAgIC8vIFRoZXNlIGNoYW5nZXMgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIG90aGVyIGNvbXBpbGVyIGNvbXBvbmVudHMKICAgICAgdmFyIGtub3duSGVscGVycyA9IHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnM7CiAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnMgPSB7CiAgICAgICAgJ2hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdibG9ja0hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdlYWNoJzogdHJ1ZSwKICAgICAgICAnaWYnOiB0cnVlLAogICAgICAgICd1bmxlc3MnOiB0cnVlLAogICAgICAgICd3aXRoJzogdHJ1ZSwKICAgICAgICAnbG9nJzogdHJ1ZQogICAgICB9OwogICAgICBpZiAoa25vd25IZWxwZXJzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBrbm93bkhlbHBlcnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0gPSBrbm93bkhlbHBlcnNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5wcm9ncmFtKHByb2dyYW0pOwogICAgfSwKCiAgICBhY2NlcHQ6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgcmV0dXJuIHRoaXNbbm9kZS50eXBlXShub2RlKTsKICAgIH0sCgogICAgcHJvZ3JhbTogZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICB2YXIgc3RhdGVtZW50cyA9IHByb2dyYW0uc3RhdGVtZW50cywgc3RhdGVtZW50OwogICAgICB0aGlzLm9wY29kZXMgPSBbXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXN0YXRlbWVudHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgdGhpc1tzdGF0ZW1lbnQudHlwZV0oc3RhdGVtZW50KTsKICAgICAgfQogICAgICB0aGlzLmlzU2ltcGxlID0gbCA9PT0gMTsKCiAgICAgIHRoaXMuZGVwdGhzLmxpc3QgPSB0aGlzLmRlcHRocy5saXN0LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBhIC0gYjsKICAgICAgfSk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgY29tcGlsZVByb2dyYW06IGZ1bmN0aW9uKHByb2dyYW0pIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyB0aGlzLmNvbXBpbGVyKCkuY29tcGlsZShwcm9ncmFtLCB0aGlzLm9wdGlvbnMpOwogICAgICB2YXIgZ3VpZCA9IHRoaXMuZ3VpZCsrLCBkZXB0aDsKCiAgICAgIHRoaXMudXNlUGFydGlhbCA9IHRoaXMudXNlUGFydGlhbCB8fCByZXN1bHQudXNlUGFydGlhbDsKCiAgICAgIHRoaXMuY2hpbGRyZW5bZ3VpZF0gPSByZXN1bHQ7CgogICAgICBmb3IodmFyIGk9MCwgbD1yZXN1bHQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gcmVzdWx0LmRlcHRocy5saXN0W2ldOwoKICAgICAgICBpZihkZXB0aCA8IDIpIHsgY29udGludWU7IH0KICAgICAgICBlbHNlIHsgdGhpcy5hZGREZXB0aChkZXB0aCAtIDEpOyB9CiAgICAgIH0KCiAgICAgIHJldHVybiBndWlkOwogICAgfSwKCiAgICBibG9jazogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgdmFyIG11c3RhY2hlID0gYmxvY2subXVzdGFjaGUsCiAgICAgICAgICBwcm9ncmFtID0gYmxvY2sucHJvZ3JhbSwKICAgICAgICAgIGludmVyc2UgPSBibG9jay5pbnZlcnNlOwoKICAgICAgaWYgKHByb2dyYW0pIHsKICAgICAgICBwcm9ncmFtID0gdGhpcy5jb21waWxlUHJvZ3JhbShwcm9ncmFtKTsKICAgICAgfQoKICAgICAgaWYgKGludmVyc2UpIHsKICAgICAgICBpbnZlcnNlID0gdGhpcy5jb21waWxlUHJvZ3JhbShpbnZlcnNlKTsKICAgICAgfQoKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJoZWxwZXIiKSB7CiAgICAgICAgdGhpcy5oZWxwZXJNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKCiAgICAgICAgLy8gbm93IHRoYXQgdGhlIHNpbXBsZSBtdXN0YWNoZSBpcyByZXNvbHZlZCwgd2UgbmVlZCB0bwogICAgICAgIC8vIGV2YWx1YXRlIGl0IGJ5IGV4ZWN1dGluZyBgYmxvY2tIZWxwZXJNaXNzaW5nYAogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICAgIHRoaXMub3Bjb2RlKCdibG9ja1ZhbHVlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hbWJpZ3VvdXNNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgICB0aGlzLm9wY29kZSgnYW1iaWd1b3VzQmxvY2tWYWx1ZScpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGhhc2g6IGZ1bmN0aW9uKGhhc2gpIHsKICAgICAgdmFyIHBhaXJzID0gaGFzaC5wYWlycywgcGFpciwgdmFsOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2gnLCAne30nKTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXBhaXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBwYWlyID0gcGFpcnNbaV07CiAgICAgICAgdmFsICA9IHBhaXJbMV07CgogICAgICAgIHRoaXMuYWNjZXB0KHZhbCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2Fzc2lnblRvSGFzaCcsIHBhaXJbMF0pOwogICAgICB9CiAgICB9LAoKICAgIHBhcnRpYWw6IGZ1bmN0aW9uKHBhcnRpYWwpIHsKICAgICAgdmFyIGlkID0gcGFydGlhbC5pZDsKICAgICAgdGhpcy51c2VQYXJ0aWFsID0gdHJ1ZTsKCiAgICAgIGlmKHBhcnRpYWwuY29udGV4dCkgewogICAgICAgIHRoaXMuSUQocGFydGlhbC5jb250ZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaCcsICdkZXB0aDAnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZVBhcnRpYWwnLCBpZC5vcmlnaW5hbCk7CiAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmQnKTsKICAgIH0sCgogICAgY29udGVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kQ29udGVudCcsIGNvbnRlbnQuc3RyaW5nKTsKICAgIH0sCgogICAgbXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICB2YXIgdHlwZSA9IHRoaXMuY2xhc3NpZnlNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiaGVscGVyIikgewogICAgICAgIHRoaXMuaGVscGVyTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYW1iaWd1b3VzTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9CgogICAgICBpZihtdXN0YWNoZS5lc2NhcGVkICYmICFvcHRpb25zLm5vRXNjYXBlKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZEVzY2FwZWQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICAgIH0KICAgIH0sCgogICAgYW1iaWd1b3VzTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkLCBuYW1lID0gaWQucGFydHNbMF07CgogICAgICB0aGlzLm9wY29kZSgnZ2V0Q29udGV4dCcsIGlkLmRlcHRoKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VBbWJpZ3VvdXMnLCBuYW1lKTsKICAgIH0sCgogICAgc2ltcGxlTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkOwoKICAgICAgaWYgKGlkLnR5cGUgPT09ICdEQVRBJykgewogICAgICAgIHRoaXMuREFUQShpZCk7CiAgICAgIH0gZWxzZSBpZiAoaWQucGFydHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5JRChpZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2ltcGxpZmllZCBJRCBmb3IgYHRoaXNgCiAgICAgICAgdGhpcy5hZGREZXB0aChpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hDb250ZXh0Jyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3Bjb2RlKCdyZXNvbHZlUG9zc2libGVMYW1iZGEnKTsKICAgIH0sCgogICAgaGVscGVyTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLnNldHVwRnVsbE11c3RhY2hlUGFyYW1zKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSwKICAgICAgICAgIG5hbWUgPSBtdXN0YWNoZS5pZC5wYXJ0c1swXTsKCiAgICAgIGlmICh0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzW25hbWVdKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUtub3duSGVscGVyJywgcGFyYW1zLmxlbmd0aCwgbmFtZSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc3BlY2lmaWVkIGtub3duSGVscGVyc09ubHksIGJ1dCB1c2VkIHRoZSB1bmtub3duIGhlbHBlciAiICsgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIElEOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLmFkZERlcHRoKGlkLmRlcHRoKTsKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB2YXIgbmFtZSA9IGlkLnBhcnRzWzBdOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaENvbnRleHQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnbG9va3VwT25Db250ZXh0JywgaWQucGFydHNbMF0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MSwgbD1pZC5wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cCcsIGlkLnBhcnRzW2ldKTsKICAgICAgfQogICAgfSwKCiAgICBEQVRBOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHRoaXMub3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cERhdGEnLCBkYXRhLmlkKTsKICAgIH0sCgogICAgU1RSSU5HOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hTdHJpbmcnLCBzdHJpbmcuc3RyaW5nKTsKICAgIH0sCgogICAgSU5URUdFUjogZnVuY3Rpb24oaW50ZWdlcikgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBpbnRlZ2VyLmludGVnZXIpOwogICAgfSwKCiAgICBCT09MRUFOOiBmdW5jdGlvbihib29sKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsIGJvb2wuYm9vbCk7CiAgICB9LAoKICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKCkge30sCgogICAgLy8gSEVMUEVSUwogICAgb3Bjb2RlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiBuYW1lLCBhcmdzOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkgfSk7CiAgICB9LAoKICAgIGRlY2xhcmU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiAnREVDTEFSRScsIG5hbWU6IG5hbWUsIHZhbHVlOiB2YWx1ZSB9KTsKICAgIH0sCgogICAgYWRkRGVwdGg6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKGlzTmFOKGRlcHRoKSkgeyB0aHJvdyBuZXcgRXJyb3IoIkVXT1QiKTsgfQogICAgICBpZihkZXB0aCA9PT0gMCkgeyByZXR1cm47IH0KCiAgICAgIGlmKCF0aGlzLmRlcHRoc1tkZXB0aF0pIHsKICAgICAgICB0aGlzLmRlcHRoc1tkZXB0aF0gPSB0cnVlOwogICAgICAgIHRoaXMuZGVwdGhzLmxpc3QucHVzaChkZXB0aCk7CiAgICAgIH0KICAgIH0sCgogICAgY2xhc3NpZnlNdXN0YWNoZTogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIGlzSGVscGVyICAgPSBtdXN0YWNoZS5pc0hlbHBlcjsKICAgICAgdmFyIGlzRWxpZ2libGUgPSBtdXN0YWNoZS5lbGlnaWJsZUhlbHBlcjsKICAgICAgdmFyIG9wdGlvbnMgICAgPSB0aGlzLm9wdGlvbnM7CgogICAgICAvLyBpZiBhbWJpZ3VvdXMsIHdlIGNhbiBwb3NzaWJseSByZXNvbHZlIHRoZSBhbWJpZ3VpdHkgbm93CiAgICAgIGlmIChpc0VsaWdpYmxlICYmICFpc0hlbHBlcikgewogICAgICAgIHZhciBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICAgIGlmIChvcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgICAgaXNIZWxwZXIgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgICBpc0VsaWdpYmxlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNIZWxwZXIpIHsgcmV0dXJuICJoZWxwZXIiOyB9CiAgICAgIGVsc2UgaWYgKGlzRWxpZ2libGUpIHsgcmV0dXJuICJhbWJpZ3VvdXMiOyB9CiAgICAgIGVsc2UgeyByZXR1cm4gInNpbXBsZSI7IH0KICAgIH0sCgogICAgcHVzaFBhcmFtczogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgIHZhciBpID0gcGFyYW1zLmxlbmd0aCwgcGFyYW07CgogICAgICB3aGlsZShpLS0pIHsKICAgICAgICBwYXJhbSA9IHBhcmFtc1tpXTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgaWYocGFyYW0uZGVwdGgpIHsKICAgICAgICAgICAgdGhpcy5hZGREZXB0aChwYXJhbS5kZXB0aCk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBwYXJhbS5kZXB0aCB8fCAwKTsKICAgICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nUGFyYW0nLCBwYXJhbS5zdHJpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3BhcmFtLnR5cGVdKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0dXBNdXN0YWNoZVBhcmFtczogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIHBhcmFtcyA9IG11c3RhY2hlLnBhcmFtczsKICAgICAgdGhpcy5wdXNoUGFyYW1zKHBhcmFtcyk7CgogICAgICBpZihtdXN0YWNoZS5oYXNoKSB7CiAgICAgICAgdGhpcy5oYXNoKG11c3RhY2hlLmhhc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICAgfSwKCiAgICAvLyB0aGlzIHdpbGwgcmVwbGFjZSBzZXR1cE11c3RhY2hlUGFyYW1zIHdoZW4gd2UncmUgZG9uZQogICAgc2V0dXBGdWxsTXVzdGFjaGVQYXJhbXM6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSBtdXN0YWNoZS5wYXJhbXM7CiAgICAgIHRoaXMucHVzaFBhcmFtcyhwYXJhbXMpOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwoKICAgICAgaWYobXVzdGFjaGUuaGFzaCkgewogICAgICAgIHRoaXMuaGFzaChtdXN0YWNoZS5oYXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0KICB9OwoKICB2YXIgTGl0ZXJhbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfTsKCiAgSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZSA9IHsKICAgIC8vIFBVQkxJQyBBUEk6IFlvdSBjYW4gb3ZlcnJpZGUgdGhlc2UgbWV0aG9kcyBpbiBhIHN1YmNsYXNzIHRvIHByb3ZpZGUKICAgIC8vIGFsdGVybmF0aXZlIGNvbXBpbGVkIGZvcm1zIGZvciBuYW1lIGxvb2t1cCBhbmQgYnVmZmVyaW5nIHNlbWFudGljcwogICAgbmFtZUxvb2t1cDogZnVuY3Rpb24ocGFyZW50LCBuYW1lLCB0eXBlKSB7CiAgICAgIGlmICgvXlswLTldKyQvLnRlc3QobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsiICsgbmFtZSArICJdIjsKICAgICAgfSBlbHNlIGlmIChKYXZhU2NyaXB0Q29tcGlsZXIuaXNWYWxpZEphdmFTY3JpcHRWYXJpYWJsZU5hbWUobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIi4iICsgbmFtZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsnIiArIG5hbWUgKyAiJ10iOwogICAgICB9CiAgICB9LAoKICAgIGFwcGVuZFRvQnVmZmVyOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICByZXR1cm4gInJldHVybiAiICsgc3RyaW5nICsgIjsiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiYnVmZmVyICs9ICIgKyBzdHJpbmcgKyAiOyI7CiAgICAgIH0KICAgIH0sCgogICAgaW5pdGlhbGl6ZUJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1b3RlZFN0cmluZygiIik7CiAgICB9LAoKICAgIG5hbWVzcGFjZTogIkhhbmRsZWJhcnMiLAogICAgLy8gRU5EIFBVQkxJQyBBUEkKCiAgICBjb21waWxlOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucywgY29udGV4dCwgYXNPYmplY3QpIHsKICAgICAgdGhpcy5lbnZpcm9ubWVudCA9IGVudmlyb25tZW50OwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIHRoaXMuZW52aXJvbm1lbnQuZGlzYXNzZW1ibGUoKSArICJcblxuIik7CgogICAgICB0aGlzLm5hbWUgPSB0aGlzLmVudmlyb25tZW50Lm5hbWU7CiAgICAgIHRoaXMuaXNDaGlsZCA9ICEhY29udGV4dDsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dCB8fCB7CiAgICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICAgIGFsaWFzZXM6IHsgfQogICAgICB9OwoKICAgICAgdGhpcy5wcmVhbWJsZSgpOwoKICAgICAgdGhpcy5zdGFja1Nsb3QgPSAwOwogICAgICB0aGlzLnN0YWNrVmFycyA9IFtdOwogICAgICB0aGlzLnJlZ2lzdGVycyA9IHsgbGlzdDogW10gfTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sgPSBbXTsKCiAgICAgIHRoaXMuY29tcGlsZUNoaWxkcmVuKGVudmlyb25tZW50LCBvcHRpb25zKTsKCiAgICAgIHZhciBvcGNvZGVzID0gZW52aXJvbm1lbnQub3Bjb2Rlcywgb3Bjb2RlOwoKICAgICAgdGhpcy5pID0gMDsKCiAgICAgIGZvcihsPW9wY29kZXMubGVuZ3RoOyB0aGlzLmk8bDsgdGhpcy5pKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaV07CgogICAgICAgIGlmKG9wY29kZS5vcGNvZGUgPT09ICdERUNMQVJFJykgewogICAgICAgICAgdGhpc1tvcGNvZGUubmFtZV0gPSBvcGNvZGUudmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbb3Bjb2RlLm9wY29kZV0uYXBwbHkodGhpcywgb3Bjb2RlLmFyZ3MpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRnVuY3Rpb25Db250ZXh0KGFzT2JqZWN0KTsKICAgIH0sCgogICAgbmV4dE9wY29kZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGVzID0gdGhpcy5lbnZpcm9ubWVudC5vcGNvZGVzLCBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaSArIDFdOwogICAgICByZXR1cm4gb3Bjb2Rlc1t0aGlzLmkgKyAxXTsKICAgIH0sCgogICAgZWF0OiBmdW5jdGlvbihvcGNvZGUpIHsKICAgICAgdGhpcy5pID0gdGhpcy5pICsgMTsKICAgIH0sCgogICAgcHJlYW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0ID0gW107CgogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZTsKICAgICAgICB2YXIgY29waWVzID0gImhlbHBlcnMgPSBoZWxwZXJzIHx8ICIgKyBuYW1lc3BhY2UgKyAiLmhlbHBlcnM7IjsKICAgICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC51c2VQYXJ0aWFsKSB7IGNvcGllcyA9IGNvcGllcyArICIgcGFydGlhbHMgPSBwYXJ0aWFscyB8fCAiICsgbmFtZXNwYWNlICsgIi5wYXJ0aWFsczsiOyB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7IGNvcGllcyA9IGNvcGllcyArICIgZGF0YSA9IGRhdGEgfHwge307IjsgfQogICAgICAgIG91dC5wdXNoKGNvcGllcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0LnB1c2goJycpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICBvdXQucHVzaCgiLCBidWZmZXIgPSAiICsgdGhpcy5pbml0aWFsaXplQnVmZmVyKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCIiKTsKICAgICAgfQoKICAgICAgLy8gdHJhY2sgdGhlIGxhc3QgY29udGV4dCBwdXNoZWQgaW50byBwbGFjZSB0byBhbGxvdyBza2lwcGluZyB0aGUKICAgICAgLy8gZ2V0Q29udGV4dCBvcGNvZGUgd2hlbiBpdCB3b3VsZCBiZSBhIG5vb3AKICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IDA7CiAgICAgIHRoaXMuc291cmNlID0gb3V0OwogICAgfSwKCiAgICBjcmVhdGVGdW5jdGlvbkNvbnRleHQ6IGZ1bmN0aW9uKGFzT2JqZWN0KSB7CiAgICAgIHZhciBsb2NhbHMgPSB0aGlzLnN0YWNrVmFycy5jb25jYXQodGhpcy5yZWdpc3RlcnMubGlzdCk7CgogICAgICBpZihsb2NhbHMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAiLCAiICsgbG9jYWxzLmpvaW4oIiwgIik7CiAgICAgIH0KCiAgICAgIC8vIEdlbmVyYXRlIG1pbmltaXplciBhbGlhcyBtYXBwaW5ncwogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBhbGlhc2VzID0gW107CiAgICAgICAgZm9yICh2YXIgYWxpYXMgaW4gdGhpcy5jb250ZXh0LmFsaWFzZXMpIHsKICAgICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAnLCAnICsgYWxpYXMgKyAnPScgKyB0aGlzLmNvbnRleHQuYWxpYXNlc1thbGlhc107CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5zb3VyY2VbMV0pIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9ICJ2YXIgIiArIHRoaXMuc291cmNlWzFdLnN1YnN0cmluZygyKSArICI7IjsKICAgICAgfQoKICAgICAgLy8gTWVyZ2UgY2hpbGRyZW4KICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSArPSAnXG4nICsgdGhpcy5jb250ZXh0LnByb2dyYW1zLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnNvdXJjZS5wdXNoKCJyZXR1cm4gYnVmZmVyOyIpOwogICAgICB9CgogICAgICB2YXIgcGFyYW1zID0gdGhpcy5pc0NoaWxkID8gWyJkZXB0aDAiLCAiZGF0YSJdIDogWyJIYW5kbGViYXJzIiwgImRlcHRoMCIsICJoZWxwZXJzIiwgInBhcnRpYWxzIiwgImRhdGEiXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXRoaXMuZW52aXJvbm1lbnQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHBhcmFtcy5wdXNoKCJkZXB0aCIgKyB0aGlzLmVudmlyb25tZW50LmRlcHRocy5saXN0W2ldKTsKICAgICAgfQoKICAgICAgaWYgKGFzT2JqZWN0KSB7CiAgICAgICAgcGFyYW1zLnB1c2godGhpcy5zb3VyY2Uuam9pbigiXG4gICIpKTsKCiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uLmFwcGx5KHRoaXMsIHBhcmFtcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uU291cmNlID0gJ2Z1bmN0aW9uICcgKyAodGhpcy5uYW1lIHx8ICcnKSArICcoJyArIHBhcmFtcy5qb2luKCcsJykgKyAnKSB7XG4gICcgKyB0aGlzLnNvdXJjZS5qb2luKCJcbiAgIikgKyAnfSc7CiAgICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIGZ1bmN0aW9uU291cmNlICsgIlxuXG4iKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25Tb3VyY2U7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2Jsb2NrVmFsdWVdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgdmFsdWUKICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmV0dXJuIHZhbHVlIG9mIGJsb2NrSGVscGVyTWlzc2luZwogICAgLy8KICAgIC8vIFRoZSBwdXJwb3NlIG9mIHRoaXMgb3Bjb2RlIGlzIHRvIHRha2UgYSBibG9jayBvZiB0aGUgZm9ybQogICAgLy8gYHt7I2Zvb319Li4ue3svZm9vfX1gLCByZXNvbHZlIHRoZSB2YWx1ZSBvZiBgZm9vYCwgYW5kCiAgICAvLyByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgcHJvcGVybHkKICAgIC8vIGludm9raW5nIGJsb2NrSGVscGVyTWlzc2luZy4KICAgIGJsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9IGJsb2NrSGVscGVyTWlzc2luZy5jYWxsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFthbWJpZ3VvdXNCbG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYmVmb3JlOiBsYXN0SGVscGVyPXZhbHVlIG9mIGxhc3QgZm91bmQgaGVscGVyLCBpZiBhbnkKICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbm8gbGFzdEhlbHBlcjogc2FtZSBhcyBbYmxvY2tWYWx1ZV0KICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbGFzdEhlbHBlcjogdmFsdWUKICAgIGFtYmlndW91c0Jsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy50b3BTdGFjaygpOwogICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYgKCEiICsgdGhpcy5sYXN0SGVscGVyICsgIikgeyAiICsgY3VycmVudCArICIgPSBibG9ja0hlbHBlck1pc3NpbmcuY2FsbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKTsgfSIpOwogICAgfSwKCiAgICAvLyBbYXBwZW5kQ29udGVudF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQXBwZW5kcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGBjb250ZW50YCB0byB0aGUgY3VycmVudCBidWZmZXIKICAgIGFwcGVuZENvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKHRoaXMucXVvdGVkU3RyaW5nKGNvbnRlbnQpKSk7CiAgICB9LAoKICAgIC8vIFthcHBlbmRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBDb2VyY2VzIGB2YWx1ZWAgdG8gYSBTdHJpbmcgYW5kIGFwcGVuZHMgaXQgdG8gdGhlIGN1cnJlbnQgYnVmZmVyLgogICAgLy8KICAgIC8vIElmIGB2YWx1ZWAgaXMgdHJ1dGh5LCBvciAwLCBpdCBpcyBjb2VyY2VkIGludG8gYSBzdHJpbmcgYW5kIGFwcGVuZGVkCiAgICAvLyBPdGhlcndpc2UsIHRoZSBlbXB0eSBzdHJpbmcgaXMgYXBwZW5kZWQKICAgIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsb2NhbCA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYoIiArIGxvY2FsICsgIiB8fCAiICsgbG9jYWwgKyAiID09PSAwKSB7ICIgKyB0aGlzLmFwcGVuZFRvQnVmZmVyKGxvY2FsKSArICIgfSIpOwogICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC5pc1NpbXBsZSkgewogICAgICAgIHRoaXMuc291cmNlLnB1c2goImVsc2UgeyAiICsgdGhpcy5hcHBlbmRUb0J1ZmZlcigiJyciKSArICIgfSIpOwogICAgICB9CiAgICB9LAoKICAgIC8vIFthcHBlbmRFc2NhcGVkXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gRXNjYXBlIGB2YWx1ZWAgYW5kIGFwcGVuZCBpdCB0byB0aGUgYnVmZmVyCiAgICBhcHBlbmRFc2NhcGVkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9wY29kZSA9IHRoaXMubmV4dE9wY29kZSgpLCBleHRyYSA9ICIiOwogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5lc2NhcGVFeHByZXNzaW9uID0gJ3RoaXMuZXNjYXBlRXhwcmVzc2lvbic7CgogICAgICBpZihvcGNvZGUgJiYgb3Bjb2RlLm9wY29kZSA9PT0gJ2FwcGVuZENvbnRlbnQnKSB7CiAgICAgICAgZXh0cmEgPSAiICsgIiArIHRoaXMucXVvdGVkU3RyaW5nKG9wY29kZS5hcmdzWzBdKTsKICAgICAgICB0aGlzLmVhdChvcGNvZGUpOwogICAgICB9CgogICAgICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuYXBwZW5kVG9CdWZmZXIoImVzY2FwZUV4cHJlc3Npb24oIiArIHRoaXMucG9wU3RhY2soKSArICIpIiArIGV4dHJhKSk7CiAgICB9LAoKICAgIC8vIFtnZXRDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vIENvbXBpbGVyIHZhbHVlLCBhZnRlcjogbGFzdENvbnRleHQ9ZGVwdGgKICAgIC8vCiAgICAvLyBTZXQgdGhlIHZhbHVlIG9mIHRoZSBgbGFzdENvbnRleHRgIGNvbXBpbGVyIHZhbHVlIHRvIHRoZSBkZXB0aAogICAgZ2V0Q29udGV4dDogZnVuY3Rpb24oZGVwdGgpIHsKICAgICAgaWYodGhpcy5sYXN0Q29udGV4dCAhPT0gZGVwdGgpIHsKICAgICAgICB0aGlzLmxhc3RDb250ZXh0ID0gZGVwdGg7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2xvb2t1cE9uQ29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogY3VycmVudENvbnRleHRbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIExvb2tzIHVwIHRoZSB2YWx1ZSBvZiBgbmFtZWAgb24gdGhlIGN1cnJlbnQgY29udGV4dCBhbmQgcHVzaGVzCiAgICAvLyBpdCBvbnRvIHRoZSBzdGFjay4KICAgIGxvb2t1cE9uQ29udGV4dDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0JykpOwogICAgfSwKCiAgICAvLyBbcHVzaENvbnRleHRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGN1cnJlbnRDb250ZXh0LCAuLi4KICAgIC8vCiAgICAvLyBQdXNoZXMgdGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGNvbnRleHQgb250byB0aGUgc3RhY2suCiAgICBwdXNoQ29udGV4dDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgnZGVwdGgnICsgdGhpcy5sYXN0Q29udGV4dCk7CiAgICB9LAoKICAgIC8vIFtyZXNvbHZlUG9zc2libGVMYW1iZGFdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXNvbHZlZCB2YWx1ZSwgLi4uCiAgICAvLwogICAgLy8gSWYgdGhlIGB2YWx1ZWAgaXMgYSBsYW1iZGEsIHJlcGxhY2UgaXQgb24gdGhlIHN0YWNrIGJ5CiAgICAvLyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBsYW1iZGEKICAgIHJlc29sdmVQb3NzaWJsZUxhbWJkYTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICByZXR1cm4gInR5cGVvZiAiICsgY3VycmVudCArICIgPT09IGZ1bmN0aW9uVHlwZSA/ICIgKyBjdXJyZW50ICsgIigpIDogIiArIGN1cnJlbnQ7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWVbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIFJlcGxhY2UgdGhlIHZhbHVlIG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgbG9va2luZwogICAgLy8gdXAgYG5hbWVgIG9uIGB2YWx1ZWAKICAgIGxvb2t1cDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnQgKyAiID09IG51bGwgfHwgIiArIGN1cnJlbnQgKyAiID09PSBmYWxzZSA/ICIgKyBjdXJyZW50ICsgIiA6ICIgKyB0aGlzLm5hbWVMb29rdXAoY3VycmVudCwgbmFtZSwgJ2NvbnRleHQnKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFtsb29rdXBEYXRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBkYXRhW2lkXSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcgdXAgYGlkYCBvbiB0aGUgY3VycmVudCBkYXRhCiAgICBsb29rdXBEYXRhOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RhdGEnLCBpZCwgJ2RhdGEnKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoU3RyaW5nUGFyYW1dCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHN0cmluZywgY3VycmVudENvbnRleHQsIC4uLgogICAgLy8KICAgIC8vIFRoaXMgb3Bjb2RlIGlzIGRlc2lnbmVkIGZvciB1c2UgaW4gc3RyaW5nIG1vZGUsIHdoaWNoCiAgICAvLyBwcm92aWRlcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGEgcGFyYW1ldGVyIGFsb25nIHdpdGggaXRzCiAgICAvLyBkZXB0aCByYXRoZXIgdGhhbiByZXNvbHZpbmcgaXQgaW1tZWRpYXRlbHkuCiAgICBwdXNoU3RyaW5nUGFyYW06IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgICB0aGlzLnB1c2hTdHJpbmcoc3RyaW5nKTsKICAgIH0sCgogICAgLy8gW3B1c2hTdHJpbmddCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHF1b3RlZFN0cmluZyhzdHJpbmcpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcXVvdGVkIHZlcnNpb24gb2YgYHN0cmluZ2Agb250byB0aGUgc3RhY2sKICAgIHB1c2hTdHJpbmc6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5xdW90ZWRTdHJpbmcoc3RyaW5nKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBleHByLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGFuIGV4cHJlc3Npb24gb250byB0aGUgc3RhY2sKICAgIHB1c2g6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgdGhpcy5wdXNoU3RhY2soZXhwcik7CiAgICB9LAoKICAgIC8vIFtwdXNoTGl0ZXJhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIFB1c2hlcyBhIHZhbHVlIG9udG8gdGhlIHN0YWNrLiBUaGlzIG9wZXJhdGlvbiBwcmV2ZW50cwogICAgLy8gdGhlIGNvbXBpbGVyIGZyb20gY3JlYXRpbmcgYSB0ZW1wb3JhcnkgdmFyaWFibGUgdG8gaG9sZAogICAgLy8gaXQuCiAgICBwdXNoTGl0ZXJhbDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHZhbHVlKTsKICAgIH0sCgogICAgLy8gW3B1c2hQcm9ncmFtXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBwcm9ncmFtKGd1aWQpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcHJvZ3JhbSBleHByZXNzaW9uIG9udG8gdGhlIHN0YWNrLiBUaGlzIHRha2VzCiAgICAvLyBhIGNvbXBpbGUtdGltZSBndWlkIGFuZCBjb252ZXJ0cyBpdCBpbnRvIGEgcnVudGltZS1hY2Nlc3NpYmxlCiAgICAvLyBleHByZXNzaW9uLgogICAgcHVzaFByb2dyYW06IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgaWYgKGd1aWQgIT0gbnVsbCkgewogICAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCh0aGlzLnByb2dyYW1FeHByZXNzaW9uKGd1aWQpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwobnVsbCk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2ludm9rZUhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBQb3BzIG9mZiB0aGUgaGVscGVyJ3MgcGFyYW1ldGVycywgaW52b2tlcyB0aGUgaGVscGVyLAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGVscGVyJ3MgcmV0dXJuIHZhbHVlIG9udG8gdGhlIHN0YWNrLgogICAgLy8KICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGZvdW5kLCBgaGVscGVyTWlzc2luZ2AgaXMgY2FsbGVkLgogICAgaW52b2tlSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuaGVscGVyTWlzc2luZyA9ICdoZWxwZXJzLmhlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIGhlbHBlciA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXIubmFtZSk7CgogICAgICB0aGlzLnB1c2hTdGFjaygiZm91bmRIZWxwZXIgPyBmb3VuZEhlbHBlci5jYWxsKCIgKwogICAgICAgIGhlbHBlci5jYWxsUGFyYW1zICsgIikgIiArICI6IGhlbHBlck1pc3NpbmcuY2FsbCgiICsKICAgICAgICBoZWxwZXIuaGVscGVyTWlzc2luZ1BhcmFtcyArICIpIik7CiAgICB9LAoKICAgIC8vIFtpbnZva2VLbm93bkhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gdGhlIGhlbHBlciBpcyBrbm93biB0byBleGlzdCwKICAgIC8vIHNvIGEgYGhlbHBlck1pc3NpbmdgIGZhbGxiYWNrIGlzIG5vdCByZXF1aXJlZC4KICAgIGludm9rZUtub3duSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5wdXNoU3RhY2soaGVscGVyLm5hbWUgKyAiLmNhbGwoIiArIGhlbHBlci5jYWxsUGFyYW1zICsgIikiKTsKICAgIH0sCgogICAgLy8gW2ludm9rZUFtYmlndW91c10KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgZGlzYW1iaWd1YXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gYW4gZXhwcmVzc2lvbiBsaWtlIGB7e2Zvb319YAogICAgLy8gaXMgcHJvdmlkZWQsIGJ1dCB3ZSBkb24ndCBrbm93IGF0IGNvbXBpbGUtdGltZSB3aGV0aGVyIGl0CiAgICAvLyBpcyBhIGhlbHBlciBvciBhIHBhdGguCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gZW1pdHMgbW9yZSBjb2RlIHRoYW4gdGhlIG90aGVyIG9wdGlvbnMsCiAgICAvLyBhbmQgY2FuIGJlIGF2b2lkZWQgYnkgcGFzc2luZyB0aGUgYGtub3duSGVscGVyc2AgYW5kCiAgICAvLyBga25vd25IZWxwZXJzT25seWAgZmxhZ3MgYXQgY29tcGlsZS10aW1lLgogICAgaW52b2tlQW1iaWd1b3VzOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgne30nKTsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIoMCwgbmFtZSk7CgogICAgICB2YXIgaGVscGVyTmFtZSA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMubmFtZUxvb2t1cCgnaGVscGVycycsIG5hbWUsICdoZWxwZXInKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXJOYW1lKTsKCiAgICAgIHZhciBub25IZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIHZhciBuZXh0U3RhY2sgPSB0aGlzLm5leHRTdGFjaygpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgnaWYgKGZvdW5kSGVscGVyKSB7ICcgKyBuZXh0U3RhY2sgKyAnID0gZm91bmRIZWxwZXIuY2FsbCgnICsgaGVscGVyLmNhbGxQYXJhbXMgKyAnKTsgfScpOwogICAgICB0aGlzLnNvdXJjZS5wdXNoKCdlbHNlIHsgJyArIG5leHRTdGFjayArICcgPSAnICsgbm9uSGVscGVyICsgJzsgJyArIG5leHRTdGFjayArICcgPSB0eXBlb2YgJyArIG5leHRTdGFjayArICcgPT09IGZ1bmN0aW9uVHlwZSA/ICcgKyBuZXh0U3RhY2sgKyAnKCkgOiAnICsgbmV4dFN0YWNrICsgJzsgfScpOwogICAgfSwKCiAgICAvLyBbaW52b2tlUGFydGlhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBjb250ZXh0LCAuLi4KICAgIC8vIE9uIHN0YWNrIGFmdGVyOiByZXN1bHQgb2YgcGFydGlhbCBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gcG9wcyBvZmYgYSBjb250ZXh0LCBpbnZva2VzIGEgcGFydGlhbCB3aXRoIHRoYXQgY29udGV4dCwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIHJlc3VsdCBvZiB0aGUgaW52b2NhdGlvbiBiYWNrLgogICAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW3RoaXMubmFtZUxvb2t1cCgncGFydGlhbHMnLCBuYW1lLCAncGFydGlhbCcpLCAiJyIgKyBuYW1lICsgIiciLCB0aGlzLnBvcFN0YWNrKCksICJoZWxwZXJzIiwgInBhcnRpYWxzIl07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGF0YSIpOwogICAgICB9CgogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICB0aGlzLnB1c2hTdGFjaygic2VsZi5pbnZva2VQYXJ0aWFsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpOyIpOwogICAgfSwKCiAgICAvLyBbYXNzaWduVG9IYXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCBoYXNoLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogaGFzaCwgLi4uCiAgICAvLwogICAgLy8gUG9wcyBhIHZhbHVlIGFuZCBoYXNoIG9mZiB0aGUgc3RhY2ssIGFzc2lnbnMgYGhhc2hba2V5XSA9IHZhbHVlYAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGFzaCBiYWNrIG9udG8gdGhlIHN0YWNrLgogICAgYXNzaWduVG9IYXNoOiBmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5wb3BTdGFjaygpOwogICAgICB2YXIgaGFzaCA9IHRoaXMudG9wU3RhY2soKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goaGFzaCArICJbJyIgKyBrZXkgKyAiJ10gPSAiICsgdmFsdWUgKyAiOyIpOwogICAgfSwKCiAgICAvLyBIRUxQRVJTCgogICAgY29tcGlsZXI6IEphdmFTY3JpcHRDb21waWxlciwKCiAgICBjb21waWxlQ2hpbGRyZW46IGZ1bmN0aW9uKGVudmlyb25tZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IGVudmlyb25tZW50LmNoaWxkcmVuLCBjaGlsZCwgY29tcGlsZXI7CgogICAgICBmb3IodmFyIGk9MCwgbD1jaGlsZHJlbi5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICBjb21waWxlciA9IG5ldyB0aGlzLmNvbXBpbGVyKCk7CgogICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtcy5wdXNoKCcnKTsgICAgIC8vIFBsYWNlaG9sZGVyIHRvIHByZXZlbnQgbmFtZSBjb25mbGljdHMgZm9yIG5lc3RlZCBjaGlsZHJlbgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGV4dC5wcm9ncmFtcy5sZW5ndGg7CiAgICAgICAgY2hpbGQuaW5kZXggPSBpbmRleDsKICAgICAgICBjaGlsZC5uYW1lID0gJ3Byb2dyYW0nICsgaW5kZXg7CiAgICAgICAgdGhpcy5jb250ZXh0LnByb2dyYW1zW2luZGV4XSA9IGNvbXBpbGVyLmNvbXBpbGUoY2hpbGQsIG9wdGlvbnMsIHRoaXMuY29udGV4dCk7CiAgICAgIH0KICAgIH0sCgogICAgcHJvZ3JhbUV4cHJlc3Npb246IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKCiAgICAgIGlmKGd1aWQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAic2VsZi5ub29wIjsKICAgICAgfQoKICAgICAgdmFyIGNoaWxkID0gdGhpcy5lbnZpcm9ubWVudC5jaGlsZHJlbltndWlkXSwKICAgICAgICAgIGRlcHRocyA9IGNoaWxkLmRlcHRocy5saXN0LCBkZXB0aDsKCiAgICAgIHZhciBwcm9ncmFtUGFyYW1zID0gW2NoaWxkLmluZGV4LCBjaGlsZC5uYW1lLCAiZGF0YSJdOwoKICAgICAgZm9yKHZhciBpPTAsIGwgPSBkZXB0aHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gZGVwdGhzW2ldOwoKICAgICAgICBpZihkZXB0aCA9PT0gMSkgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoMCIpOyB9CiAgICAgICAgZWxzZSB7IHByb2dyYW1QYXJhbXMucHVzaCgiZGVwdGgiICsgKGRlcHRoIC0gMSkpOyB9CiAgICAgIH0KCiAgICAgIGlmKGRlcHRocy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbSgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9IGVsc2UgewogICAgICAgIHByb2dyYW1QYXJhbXMuc2hpZnQoKTsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbVdpdGhEZXB0aCgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9CiAgICB9LAoKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lLCB2YWwpIHsKICAgICAgdGhpcy51c2VSZWdpc3RlcihuYW1lKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaChuYW1lICsgIiA9ICIgKyB2YWwgKyAiOyIpOwogICAgfSwKCiAgICB1c2VSZWdpc3RlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZighdGhpcy5yZWdpc3RlcnNbbmFtZV0pIHsKICAgICAgICB0aGlzLnJlZ2lzdGVyc1tuYW1lXSA9IHRydWU7CiAgICAgICAgdGhpcy5yZWdpc3RlcnMubGlzdC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIHB1c2hTdGFja0xpdGVyYWw6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaChuZXcgTGl0ZXJhbChpdGVtKSk7CiAgICAgIHJldHVybiBpdGVtOwogICAgfSwKCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmluY3JTdGFjaygpICsgIiA9ICIgKyBpdGVtICsgIjsiKTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICByZXBsYWNlU3RhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHZhciBpdGVtID0gY2FsbGJhY2suY2FsbCh0aGlzLCB0aGlzLnRvcFN0YWNrKCkpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLnRvcFN0YWNrKCkgKyAiID0gIiArIGl0ZW0gKyAiOyIpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICBuZXh0U3RhY2s6IGZ1bmN0aW9uKHNraXBDb21waWxlU3RhY2spIHsKICAgICAgdmFyIG5hbWUgPSB0aGlzLmluY3JTdGFjaygpOwogICAgICB0aGlzLmNvbXBpbGVTdGFjay5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSwKCiAgICBpbmNyU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnN0YWNrU2xvdCsrOwogICAgICBpZih0aGlzLnN0YWNrU2xvdCA+IHRoaXMuc3RhY2tWYXJzLmxlbmd0aCkgeyB0aGlzLnN0YWNrVmFycy5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7IH0KICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgcG9wU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbSA9IHRoaXMuY29tcGlsZVN0YWNrLnBvcCgpOwoKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBMaXRlcmFsKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGFja1Nsb3QtLTsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICB0b3BTdGFjazogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtID0gdGhpcy5jb21waWxlU3RhY2tbdGhpcy5jb21waWxlU3RhY2subGVuZ3RoIC0gMV07CgogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIExpdGVyYWwpIHsKICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICBxdW90ZWRTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gJyInICsgc3RyCiAgICAgICAgLnJlcGxhY2UoL1xcL2csICdcXFxcJykKICAgICAgICAucmVwbGFjZSgvIi9nLCAnXFwiJykKICAgICAgICAucmVwbGFjZSgvXG4vZywgJ1xcbicpCiAgICAgICAgLnJlcGxhY2UoL1xyL2csICdcXHInKSArICciJzsKICAgIH0sCgogICAgc2V0dXBIZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW107CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1TaXplLCBwYXJhbXMpOwogICAgICB2YXIgZm91bmRIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CgogICAgICByZXR1cm4gewogICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgIG5hbWU6IGZvdW5kSGVscGVyLAogICAgICAgIGNhbGxQYXJhbXM6IFsiZGVwdGgwIl0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKSwKICAgICAgICBoZWxwZXJNaXNzaW5nUGFyYW1zOiBbImRlcHRoMCIsIHRoaXMucXVvdGVkU3RyaW5nKG5hbWUpXS5jb25jYXQocGFyYW1zKS5qb2luKCIsICIpCiAgICAgIH07CiAgICB9LAoKICAgIC8vIHRoZSBwYXJhbXMgYW5kIGNvbnRleHRzIGFyZ3VtZW50cyBhcmUgcGFzc2VkIGluIGFycmF5cwogICAgLy8gdG8gZmlsbCBpbgogICAgc2V0dXBQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgcGFyYW1zKSB7CiAgICAgIHZhciBvcHRpb25zID0gW10sIGNvbnRleHRzID0gW10sIHBhcmFtLCBpbnZlcnNlLCBwcm9ncmFtOwoKICAgICAgb3B0aW9ucy5wdXNoKCJoYXNoOiIgKyB0aGlzLnBvcFN0YWNrKCkpOwoKICAgICAgaW52ZXJzZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgcHJvZ3JhbSA9IHRoaXMucG9wU3RhY2soKTsKCiAgICAgIC8vIEF2b2lkIHNldHRpbmcgZm4gYW5kIGludmVyc2UgaWYgbmVpdGhlciBhcmUgc2V0LiBUaGlzIGFsbG93cwogICAgICAvLyBoZWxwZXJzIHRvIGRvIGEgY2hlY2sgZm9yIGBpZiAob3B0aW9ucy5mbilgCiAgICAgIGlmIChwcm9ncmFtIHx8IGludmVyc2UpIHsKICAgICAgICBpZiAoIXByb2dyYW0pIHsKICAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBwcm9ncmFtID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgICAgIGludmVyc2UgPSAic2VsZi5ub29wIjsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnMucHVzaCgiaW52ZXJzZToiICsgaW52ZXJzZSk7CiAgICAgICAgb3B0aW9ucy5wdXNoKCJmbjoiICsgcHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGZvcih2YXIgaT0wOyBpPHBhcmFtU2l6ZTsgaSsrKSB7CiAgICAgICAgcGFyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc3RyaW5nUGFyYW1zKSB7CiAgICAgICAgICBjb250ZXh0cy5wdXNoKHRoaXMucG9wU3RhY2soKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIG9wdGlvbnMucHVzaCgiY29udGV4dHM6WyIgKyBjb250ZXh0cy5qb2luKCIsIikgKyAiXSIpOwogICAgICB9CgogICAgICBpZih0aGlzLm9wdGlvbnMuZGF0YSkgewogICAgICAgIG9wdGlvbnMucHVzaCgiZGF0YTpkYXRhIik7CiAgICAgIH0KCiAgICAgIHBhcmFtcy5wdXNoKCJ7IiArIG9wdGlvbnMuam9pbigiLCIpICsgIn0iKTsKICAgICAgcmV0dXJuIHBhcmFtcy5qb2luKCIsICIpOwogICAgfQogIH07CgogIHZhciByZXNlcnZlZFdvcmRzID0gKAogICAgImJyZWFrIGVsc2UgbmV3IHZhciIgKwogICAgIiBjYXNlIGZpbmFsbHkgcmV0dXJuIHZvaWQiICsKICAgICIgY2F0Y2ggZm9yIHN3aXRjaCB3aGlsZSIgKwogICAgIiBjb250aW51ZSBmdW5jdGlvbiB0aGlzIHdpdGgiICsKICAgICIgZGVmYXVsdCBpZiB0aHJvdyIgKwogICAgIiBkZWxldGUgaW4gdHJ5IiArCiAgICAiIGRvIGluc3RhbmNlb2YgdHlwZW9mIiArCiAgICAiIGFic3RyYWN0IGVudW0gaW50IHNob3J0IiArCiAgICAiIGJvb2xlYW4gZXhwb3J0IGludGVyZmFjZSBzdGF0aWMiICsKICAgICIgYnl0ZSBleHRlbmRzIGxvbmcgc3VwZXIiICsKICAgICIgY2hhciBmaW5hbCBuYXRpdmUgc3luY2hyb25pemVkIiArCiAgICAiIGNsYXNzIGZsb2F0IHBhY2thZ2UgdGhyb3dzIiArCiAgICAiIGNvbnN0IGdvdG8gcHJpdmF0ZSB0cmFuc2llbnQiICsKICAgICIgZGVidWdnZXIgaW1wbGVtZW50cyBwcm90ZWN0ZWQgdm9sYXRpbGUiICsKICAgICIgZG91YmxlIGltcG9ydCBwdWJsaWMgbGV0IHlpZWxkIgogICkuc3BsaXQoIiAiKTsKCiAgdmFyIGNvbXBpbGVyV29yZHMgPSBKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFMgPSB7fTsKCiAgZm9yKHZhciBpPTAsIGw9cmVzZXJ2ZWRXb3Jkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBjb21waWxlcldvcmRzW3Jlc2VydmVkV29yZHNbaV1dID0gdHJ1ZTsKICB9CgogIEphdmFTY3JpcHRDb21waWxlci5pc1ZhbGlkSmF2YVNjcmlwdFZhcmlhYmxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmKCFKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFNbbmFtZV0gJiYgL15bYS16QS1aXyRdWzAtOWEtekEtWl8kXSskLy50ZXN0KG5hbWUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cgp9KShIYW5kbGViYXJzLkNvbXBpbGVyLCBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcik7CgpIYW5kbGViYXJzLnByZWNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBpZiAoISgnZGF0YScgaW4gb3B0aW9ucykpIHsKICAgIG9wdGlvbnMuZGF0YSA9IHRydWU7CiAgfQogIHZhciBhc3QgPSBIYW5kbGViYXJzLnBhcnNlKHN0cmluZyk7CiAgdmFyIGVudmlyb25tZW50ID0gbmV3IEhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcigpLmNvbXBpbGUoZW52aXJvbm1lbnQsIG9wdGlvbnMpOwp9OwoKSGFuZGxlYmFycy5jb21waWxlID0gZnVuY3Rpb24oc3RyaW5nLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgaWYgKCEoJ2RhdGEnIGluIG9wdGlvbnMpKSB7CiAgICBvcHRpb25zLmRhdGEgPSB0cnVlOwogIH0KICB2YXIgY29tcGlsZWQ7CiAgZnVuY3Rpb24gY29tcGlsZSgpIHsKICAgIHZhciBhc3QgPSBIYW5kbGViYXJzLnBhcnNlKHN0cmluZyk7CiAgICB2YXIgZW52aXJvbm1lbnQgPSBuZXcgSGFuZGxlYmFycy5Db21waWxlcigpLmNvbXBpbGUoYXN0LCBvcHRpb25zKTsKICAgIHZhciB0ZW1wbGF0ZVNwZWMgPSBuZXcgSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIoKS5jb21waWxlKGVudmlyb25tZW50LCBvcHRpb25zLCB1bmRlZmluZWQsIHRydWUpOwogICAgcmV0dXJuIEhhbmRsZWJhcnMudGVtcGxhdGUodGVtcGxhdGVTcGVjKTsKICB9CgogIC8vIFRlbXBsYXRlIGlzIG9ubHkgY29tcGlsZWQgb24gZmlyc3QgdXNlIGFuZCBjYWNoZWQgYWZ0ZXIgdGhhdCBwb2ludC4KICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgaWYgKCFjb21waWxlZCkgewogICAgICBjb21waWxlZCA9IGNvbXBpbGUoKTsKICAgIH0KICAgIHJldHVybiBjb21waWxlZC5jYWxsKHRoaXMsIGNvbnRleHQsIG9wdGlvbnMpOwogIH07Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvcnVudGltZS5qcwpIYW5kbGViYXJzLlZNID0gewogIHRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZVNwZWMpIHsKICAgIC8vIEp1c3QgYWRkIHdhdGVyCiAgICB2YXIgY29udGFpbmVyID0gewogICAgICBlc2NhcGVFeHByZXNzaW9uOiBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24sCiAgICAgIGludm9rZVBhcnRpYWw6IEhhbmRsZWJhcnMuVk0uaW52b2tlUGFydGlhbCwKICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICBwcm9ncmFtOiBmdW5jdGlvbihpLCBmbiwgZGF0YSkgewogICAgICAgIHZhciBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV07CiAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIgPSBIYW5kbGViYXJzLlZNLnByb2dyYW0oZm4sIGRhdGEpOwogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIucHJvZ3JhbSA9IGk7CiAgICAgICAgfSBlbHNlIGlmICghcHJvZ3JhbVdyYXBwZXIpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXSA9IEhhbmRsZWJhcnMuVk0ucHJvZ3JhbShmbik7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlci5wcm9ncmFtID0gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb2dyYW1XcmFwcGVyOwogICAgICB9LAogICAgICBwcm9ncmFtV2l0aERlcHRoOiBIYW5kbGViYXJzLlZNLnByb2dyYW1XaXRoRGVwdGgsCiAgICAgIG5vb3A6IEhhbmRsZWJhcnMuVk0ubm9vcAogICAgfTsKCiAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgcmV0dXJuIHRlbXBsYXRlU3BlYy5jYWxsKGNvbnRhaW5lciwgSGFuZGxlYmFycywgY29udGV4dCwgb3B0aW9ucy5oZWxwZXJzLCBvcHRpb25zLnBhcnRpYWxzLCBvcHRpb25zLmRhdGEpOwogICAgfTsKICB9LAoKICBwcm9ncmFtV2l0aERlcHRoOiBmdW5jdGlvbihmbiwgZGF0YSwgJGRlcHRoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgW2NvbnRleHQsIG9wdGlvbnMuZGF0YSB8fCBkYXRhXS5jb25jYXQoYXJncykpOwogICAgfTsKICB9LAogIHByb2dyYW06IGZ1bmN0aW9uKGZuLCBkYXRhKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIHJldHVybiBmbihjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YSk7CiAgICB9OwogIH0sCiAgbm9vcDogZnVuY3Rpb24oKSB7IHJldHVybiAiIjsgfSwKICBpbnZva2VQYXJ0aWFsOiBmdW5jdGlvbihwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewogICAgdmFyIG9wdGlvbnMgPSB7IGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoKICAgIGlmKHBhcnRpYWwgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgZm91bmQiKTsKICAgIH0gZWxzZSBpZihwYXJ0aWFsIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKICAgICAgcmV0dXJuIHBhcnRpYWwoY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKCFIYW5kbGViYXJzLmNvbXBpbGUpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGNvbXBpbGVkIHdoZW4gcnVubmluZyBpbiBydW50aW1lLW9ubHkgbW9kZSIpOwogICAgfSBlbHNlIHsKICAgICAgcGFydGlhbHNbbmFtZV0gPSBIYW5kbGViYXJzLmNvbXBpbGUocGFydGlhbCwge2RhdGE6IGRhdGEgIT09IHVuZGVmaW5lZH0pOwogICAgICByZXR1cm4gcGFydGlhbHNbbmFtZV0oY29udGV4dCwgb3B0aW9ucyk7CiAgICB9CiAgfQp9OwoKSGFuZGxlYmFycy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0udGVtcGxhdGU7CjsKCi8vICAgICBVbmRlcnNjb3JlLmpzIDEuNC4yCi8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGdsb2JhbGAgb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKCiAgLy8gRXN0YWJsaXNoIHRoZSBvYmplY3QgdGhhdCBnZXRzIHJldHVybmVkIHRvIGJyZWFrIG91dCBvZiBhIGxvb3AgaXRlcmF0aW9uLgogIHZhciBicmVha2VyID0ge307CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIgcHVzaCAgICAgICAgICAgICA9IEFycmF5UHJvdG8ucHVzaCwKICAgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgICAgdW5zaGlmdCAgICAgICAgICA9IEFycmF5UHJvdG8udW5zaGlmdCwKICAgICAgdG9TdHJpbmcgICAgICAgICA9IE9ialByb3RvLnRvU3RyaW5nLAogICAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhcgogICAgbmF0aXZlRm9yRWFjaCAgICAgID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgbmF0aXZlTWFwICAgICAgICAgID0gQXJyYXlQcm90by5tYXAsCiAgICBuYXRpdmVSZWR1Y2UgICAgICAgPSBBcnJheVByb3RvLnJlZHVjZSwKICAgIG5hdGl2ZVJlZHVjZVJpZ2h0ICA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsCiAgICBuYXRpdmVGaWx0ZXIgICAgICAgPSBBcnJheVByb3RvLmZpbHRlciwKICAgIG5hdGl2ZUV2ZXJ5ICAgICAgICA9IEFycmF5UHJvdG8uZXZlcnksCiAgICBuYXRpdmVTb21lICAgICAgICAgPSBBcnJheVByb3RvLnNvbWUsCiAgICBuYXRpdmVJbmRleE9mICAgICAgPSBBcnJheVByb3RvLmluZGV4T2YsCiAgICBuYXRpdmVMYXN0SW5kZXhPZiAgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLAogICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKICAgIG5hdGl2ZUtleXMgICAgICAgICA9IE9iamVjdC5rZXlzLAogICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CgogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290WydfJ10gPSBfOwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uLgogIF8uVkVSU0lPTiA9ICcxLjQuMic7CgogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9iai5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpIHsKICAgICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVNYXAgJiYgb2JqLm1hcCA9PT0gbmF0aXZlTWFwKSByZXR1cm4gb2JqLm1hcChpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gVGhlIHJpZ2h0LWFzc29jaWF0aXZlIHZlcnNpb24gb2YgcmVkdWNlLCBhbHNvIGtub3duIGFzIGBmb2xkcmAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZVJpZ2h0YCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2VSaWdodCA9IF8uZm9sZHIgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2VSaWdodCAmJiBvYmoucmVkdWNlUmlnaHQgPT09IG5hdGl2ZVJlZHVjZVJpZ2h0KSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMiA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpbmRleCA9IGtleXMgPyBrZXlzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gb2JqW2luZGV4XTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCBvYmpbaW5kZXhdLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJyk7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0OwogICAgYW55KG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZUZpbHRlciAmJiBvYmouZmlsdGVyID09PSBuYXRpdmVGaWx0ZXIpIHJldHVybiBvYmouZmlsdGVyKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciB8fCAoaXRlcmF0b3IgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZUV2ZXJ5ICYmIG9iai5ldmVyeSA9PT0gbmF0aXZlRXZlcnkpIHJldHVybiBvYmouZXZlcnkoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkgcmV0dXJuIG9iai5zb21lKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgdGhlIGFycmF5IG9yIG9iamVjdCBjb250YWlucyBhIGdpdmVuIHZhbHVlICh1c2luZyBgPT09YCkuCiAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCiAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CiAgICB2YXIgZm91bmQgPSBmYWxzZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZvdW5kOwogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgb2JqLmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBvYmouaW5kZXhPZih0YXJnZXQpICE9IC0xOwogICAgZm91bmQgPSBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogICAgcmV0dXJuIGZvdW5kOwogIH07CgogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIChfLmlzRnVuY3Rpb24obWV0aG9kKSA/IG1ldGhvZCA6IHZhbHVlW21ldGhvZF0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYG1hcGA6IGZldGNoaW5nIGEgcHJvcGVydHkuCiAgXy5wbHVjayA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CiAgICByZXR1cm4gXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiB2YWx1ZVtrZXldOyB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaWx0ZXJgOiBzZWxlY3Rpbmcgb25seSBvYmplY3RzCiAgLy8gd2l0aCBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLndoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChhdHRyc1trZXldICE9PSB2YWx1ZVtrZXldKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG1heGltdW0gZWxlbWVudCBvciAoZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgLy8gQ2FuJ3Qgb3B0aW1pemUgYXJyYXlzIG9mIGludGVnZXJzIGxvbmdlciB0aGFuIDY1LDUzNSBlbGVtZW50cy4KICAvLyBTZWU6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD04MDc5NwogIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIC1JbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiAtSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA+PSByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIEluZmluaXR5OwogICAgdmFyIHJlc3VsdCA9IHtjb21wdXRlZCA6IEluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPCByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhbiBhcnJheS4KICBfLnNodWZmbGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgbG9va3VwIGl0ZXJhdG9ycy4KICB2YXIgbG9va3VwSXRlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG9iail7IHJldHVybiBvYmpbdmFsdWVdOyB9OwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWUgOiB2YWx1ZSwKICAgICAgICBpbmRleCA6IGluZGV4LAogICAgICAgIGNyaXRlcmlhIDogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKICAgICAgdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggPCByaWdodC5pbmRleCA/IC0xIDogMTsKICAgIH0pLCAndmFsdWUnKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQsIGJlaGF2aW9yKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIHZhciBrZXkgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgb2JqKTsKICAgICAgYmVoYXZpb3IocmVzdWx0LCBrZXksIHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBHcm91cHMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbi4gUGFzcyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlCiAgLy8gdG8gZ3JvdXAgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcml0ZXJpb24uCiAgXy5ncm91cEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgcmV0dXJuIGdyb3VwKG9iaiwgdmFsdWUsIGNvbnRleHQsIGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgICAoXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0gOiAocmVzdWx0W2tleV0gPSBbXSkpLnB1c2godmFsdWUpOwogICAgfSk7CiAgfTsKCiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgaWYgKCFfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldID0gMDsKICAgICAgcmVzdWx0W2tleV0rKzsKICAgIH0pOwogIH07CgogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uKGFycmF5LCBvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGl0ZXJhdG9yID09IG51bGwgPyBfLmlkZW50aXR5IDogbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKCiAgLy8gU2FmZWx5IGNvbnZlcnQgYW55dGhpbmcgaXRlcmFibGUgaW50byBhIHJlYWwsIGxpdmUgYXJyYXkuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gb2JqZWN0LgogIF8uc2l6ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIEFycmF5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiAobiAhPSBudWxsKSAmJiAhZ3VhcmQgPyBzbGljZS5jYWxsKGFycmF5LCAwLCBuKSA6IGFycmF5WzBdOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBhcnJheS5sZW5ndGggLSAoKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbikpOwogIH07CgogIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmxhc3QgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmICgobiAhPSBudWxsKSAmJiAhZ3VhcmQpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIE1hdGgubWF4KGFycmF5Lmxlbmd0aCAtIG4sIDApKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIH0KICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsgcmV0dXJuICEhdmFsdWU7IH0pOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CgogIC8vIFJldHVybiBhIGNvbXBsZXRlbHkgZmxhdHRlbmVkIHZlcnNpb24gb2YgYW4gYXJyYXkuCiAgXy5mbGF0dGVuID0gZnVuY3Rpb24oYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCiAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKCiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGlmIChpc1NvcnRlZCA/ICghaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSkgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgogIC8vIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogIF8udW5pb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLnVuaXEoY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIGFyZ3VtZW50cykpOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyBldmVyeSBpdGVtIHNoYXJlZCBiZXR3ZWVuIGFsbCB0aGUKICAvLyBwYXNzZWQtaW4gYXJyYXlzLgogIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gXy5pbmRleE9mKG90aGVyLCBpdGVtKSA+PSAwOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7IH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgbGVuZ3RoID0gXy5tYXgoXy5wbHVjayhhcmdzLCAnbGVuZ3RoJykpOwogICAgdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJncywgIiIgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbbGlzdFtpXVswXV0gPSBsaXN0W2ldWzFdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGlzU29ydGVkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gKGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGwgKyBpc1NvcnRlZCkgOiBpc1NvcnRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsOyBpKyspIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBmcm9tKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGhhc0luZGV4ID0gZnJvbSAhPSBudWxsOwogICAgaWYgKG5hdGl2ZUxhc3RJbmRleE9mICYmIGFycmF5Lmxhc3RJbmRleE9mID09PSBuYXRpdmVMYXN0SW5kZXhPZikgewogICAgICByZXR1cm4gaGFzSW5kZXggPyBhcnJheS5sYXN0SW5kZXhPZihpdGVtLCBmcm9tKSA6IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0pOwogICAgfQogICAgdmFyIGkgPSAoaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoKTsKICAgIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24oc3RhcnQsIHN0b3AsIHN0ZXApIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIHN0ZXAgPSBhcmd1bWVudHNbMl0gfHwgMTsKCiAgICB2YXIgbGVuID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuKTsKCiAgICB3aGlsZShpZHggPCBsZW4pIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CgogICAgcmV0dXJuIHJhbmdlOwogIH07CgogIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV1c2FibGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHByb3RvdHlwZSBzZXR0aW5nLgogIHZhciBjdG9yID0gZnVuY3Rpb24oKXt9OwoKICAvLyBDcmVhdGUgYSBmdW5jdGlvbiBib3VuZCB0byBhIGdpdmVuIG9iamVjdCAoYXNzaWduaW5nIGB0aGlzYCwgYW5kIGFyZ3VtZW50cywKICAvLyBvcHRpb25hbGx5KS4gQmluZGluZyB3aXRoIGFyZ3VtZW50cyBpcyBhbHNvIGtub3duIGFzIGBjdXJyeWAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYEZ1bmN0aW9uLmJpbmRgIGlmIGF2YWlsYWJsZS4KICAvLyBXZSBjaGVjayBmb3IgYGZ1bmMuYmluZGAgZmlyc3QsIHRvIGZhaWwgZmFzdCB3aGVuIGBmdW5jYCBpcyB1bmRlZmluZWQuCiAgXy5iaW5kID0gZnVuY3Rpb24gYmluZChmdW5jLCBjb250ZXh0KSB7CiAgICB2YXIgYm91bmQsIGFyZ3M7CiAgICBpZiAoZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kICYmIG5hdGl2ZUJpbmQpIHJldHVybiBuYXRpdmVCaW5kLmFwcGx5KGZ1bmMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBpZiAoIV8uaXNGdW5jdGlvbihmdW5jKSkgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gYm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSkgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CiAgICAgIHZhciBzZWxmID0gbmV3IGN0b3I7CiAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBpZiAoT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCkgcmV0dXJuIHJlc3VsdDsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYWxsIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdAogIC8vIGFsbCBjYWxsYmFja3MgZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PSAwKSBmdW5jcyA9IF8uZnVuY3Rpb25zKG9iaik7CiAgICBlYWNoKGZ1bmNzLCBmdW5jdGlvbihmKSB7IG9ialtmXSA9IF8uYmluZChvYmpbZl0sIG9iaik7IH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBNZW1vaXplIGFuIGV4cGVuc2l2ZSBmdW5jdGlvbiBieSBzdG9yaW5nIGl0cyByZXN1bHRzLgogIF8ubWVtb2l6ZSA9IGZ1bmN0aW9uKGZ1bmMsIGhhc2hlcikgewogICAgdmFyIG1lbW8gPSB7fTsKICAgIGhhc2hlciB8fCAoaGFzaGVyID0gXy5pZGVudGl0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBrZXkgPSBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIF8uaGFzKG1lbW8sIGtleSkgPyBtZW1vW2tleV0gOiAobWVtb1trZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfTsKCiAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwogIC8vIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBzdXBwbGllZC4KICBfLmRlbGF5ID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpeyByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsgfSwgd2FpdCk7CiAgfTsKCiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewogICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4KICBfLnRocm90dGxlID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGNvbnRleHQsIGFyZ3MsIHRpbWVvdXQsIHRocm90dGxpbmcsIG1vcmUsIHJlc3VsdDsKICAgIHZhciB3aGVuRG9uZSA9IF8uZGVib3VuY2UoZnVuY3Rpb24oKXsgbW9yZSA9IHRocm90dGxpbmcgPSBmYWxzZTsgfSwgd2FpdCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGNvbnRleHQgPSB0aGlzOyBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAobW9yZSkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgd2hlbkRvbmUoKTsKICAgICAgfTsKICAgICAgaWYgKCF0aW1lb3V0KSB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgIGlmICh0aHJvdHRsaW5nKSB7CiAgICAgICAgbW9yZSA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3R0bGluZyA9IHRydWU7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfQogICAgICB3aGVuRG9uZSgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbZnVuY107CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CiAgICBpZiAodGltZXMgPD0gMCkgcmV0dXJuIGZ1bmMoKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBPYmplY3QgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXRyaWV2ZSB0aGUgbmFtZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCiAgXy5rZXlzID0gbmF0aXZlS2V5cyB8fCBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogIT09IE9iamVjdChvYmopKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG9iamVjdCcpOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXNba2V5cy5sZW5ndGhdID0ga2V5OwogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIF8udmFsdWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgdmFsdWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSB2YWx1ZXMucHVzaChvYmpba2V5XSk7CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBwYWlycyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcGFpcnMucHVzaChba2V5LCBvYmpba2V5XV0pOwogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmVzdWx0W29ialtrZXldXSA9IGtleTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGVhY2goa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIC8vIEZpbGwgaW4gYSBnaXZlbiBvYmplY3Qgd2l0aCBkZWZhdWx0IHByb3BlcnRpZXMuCiAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIGlmIChvYmpbcHJvcF0gPT0gbnVsbCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgogIF8uY2xvbmUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwogICAgcmV0dXJuIF8uaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBfLmV4dGVuZCh7fSwgb2JqKTsKICB9OwoKICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCiAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgogIC8vIG9yZGVyIHRvIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiBpbnRlcm1lZGlhdGUgcmVzdWx0cyB3aXRoaW4gdGhlIGNoYWluLgogIF8udGFwID0gZnVuY3Rpb24ob2JqLCBpbnRlcmNlcHRvcikgewogICAgaW50ZXJjZXB0b3Iob2JqKTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KICB2YXIgZXEgPSBmdW5jdGlvbihhLCBiLCBhU3RhY2ssIGJTdGFjaykgewogICAgLy8gSWRlbnRpY2FsIG9iamVjdHMgYXJlIGVxdWFsLiBgMCA9PT0gLTBgLCBidXQgdGhleSBhcmVuJ3QgaWRlbnRpY2FsLgogICAgLy8gU2VlIHRoZSBIYXJtb255IGBlZ2FsYCBwcm9wb3NhbDogaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsLgogICAgaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwogICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwogICAgLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCiAgICBpZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwogICAgaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKICAgIC8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKICAgIGlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCiAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KICAgICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvcgogICAgICAgIC8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgogICAgICAgIHJldHVybiBhICE9ICthID8gYiAhPSArYiA6IChhID09IDAgPyAxIC8gYSA9PSAxIC8gYiA6IGEgPT0gK2IpOwogICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgogICAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgICAgcmV0dXJuICthID09ICtiOwogICAgICAvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgogICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgogICAgICAgIHJldHVybiBhLnNvdXJjZSA9PSBiLnNvdXJjZSAmJgogICAgICAgICAgICAgICBhLmdsb2JhbCA9PSBiLmdsb2JhbCAmJgogICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PSBiLm11bHRpbGluZSAmJgogICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT0gYi5pZ25vcmVDYXNlOwogICAgfQogICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CiAgICAvLyBBc3N1bWUgZXF1YWxpdHkgZm9yIGN5Y2xpYyBzdHJ1Y3R1cmVzLiBUaGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljCiAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KICAgIHZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIC8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgogICAgICAvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCiAgICAgIGlmIChhU3RhY2tbbGVuZ3RoXSA9PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKICAgIH0KICAgIC8vIEFkZCB0aGUgZmlyc3Qgb2JqZWN0IHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wdXNoKGEpOwogICAgYlN0YWNrLnB1c2goYik7CiAgICB2YXIgc2l6ZSA9IDAsIHJlc3VsdCA9IHRydWU7CiAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KICAgIGlmIChjbGFzc05hbWUgPT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBlcShhW3NpemVdLCBiW3NpemVdLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgICAvLyBmcm9tIGRpZmZlcmVudCBmcmFtZXMgYXJlLgogICAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CiAgICAgIGlmIChhQ3RvciAhPT0gYkN0b3IgJiYgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIChhQ3RvciBpbnN0YW5jZW9mIGFDdG9yKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiAoYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIERlZXAgY29tcGFyZSBvYmplY3RzLgogICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgIGlmIChfLmhhcyhhLCBrZXkpKSB7CiAgICAgICAgICAvLyBDb3VudCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgICAgICBzaXplKys7CiAgICAgICAgICAvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIuCiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBfLmhhcyhiLCBrZXkpICYmIGVxKGFba2V5XSwgYltrZXldLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICBmb3IgKGtleSBpbiBiKSB7CiAgICAgICAgICBpZiAoXy5oYXMoYiwga2V5KSAmJiAhKHNpemUtLSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSAhc2l6ZTsKICAgICAgfQogICAgfQogICAgLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucG9wKCk7CiAgICBiU3RhY2sucG9wKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgogIF8uaXNFcXVhbCA9IGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBlcShhLCBiLCBbXSwgW10pOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gYXJyYXksIHN0cmluZywgb3Igb2JqZWN0IGVtcHR5PwogIC8vIEFuICJlbXB0eSIgb2JqZWN0IGhhcyBubyBlbnVtZXJhYmxlIG93bi1wcm9wZXJ0aWVzLgogIF8uaXNFbXB0eSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSB8fCBfLmlzU3RyaW5nKG9iaikpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIERPTSBlbGVtZW50PwogIF8uaXNFbGVtZW50ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhbiBhcnJheT8KICAvLyBEZWxlZ2F0ZXMgdG8gRUNNQTUncyBuYXRpdmUgQXJyYXkuaXNBcnJheQogIF8uaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSBhbiBvYmplY3Q/CiAgXy5pc09iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gT2JqZWN0KG9iaik7CiAgfTsKCiAgLy8gQWRkIHNvbWUgaXNUeXBlIG1ldGhvZHM6IGlzQXJndW1lbnRzLCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgaXNOdW1iZXIsIGlzRGF0ZSwgaXNSZWdFeHAuCiAgZWFjaChbJ0FyZ3VtZW50cycsICdGdW5jdGlvbicsICdTdHJpbmcnLCAnTnVtYmVyJywgJ0RhdGUnLCAnUmVnRXhwJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIF9bJ2lzJyArIG5hbWVdID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgJyArIG5hbWUgKyAnXSc7CiAgICB9OwogIH0pOwoKICAvLyBEZWZpbmUgYSBmYWxsYmFjayB2ZXJzaW9uIG9mIHRoZSBtZXRob2QgaW4gYnJvd3NlcnMgKGFoZW0sIElFKSwgd2hlcmUKICAvLyB0aGVyZSBpc24ndCBhbnkgaW5zcGVjdGFibGUgIkFyZ3VtZW50cyIgdHlwZS4KICBpZiAoIV8uaXNBcmd1bWVudHMoYXJndW1lbnRzKSkgewogICAgXy5pc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gISEob2JqICYmIF8uaGFzKG9iaiwgJ2NhbGxlZScpKTsKICAgIH07CiAgfQoKICAvLyBPcHRpbWl6ZSBgaXNGdW5jdGlvbmAgaWYgYXBwcm9wcmlhdGUuCiAgaWYgKHR5cGVvZiAoLy4vKSAhPT0gJ2Z1bmN0aW9uJykgewogICAgXy5pc0Z1bmN0aW9uID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nOwogICAgfTsKICB9CgogIC8vIElzIGEgZ2l2ZW4gb2JqZWN0IGEgZmluaXRlIG51bWJlcj8KICBfLmlzRmluaXRlID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIGlzRmluaXRlKG9iaik7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9ICtvYmo7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQm9vbGVhbl0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbDsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CiAgfTsKCiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogIH07CgogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBpKTsKICB9OwoKICAvLyBSZXR1cm4gYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIG1pbiBhbmQgbWF4IChpbmNsdXNpdmUpLgogIF8ucmFuZG9tID0gZnVuY3Rpb24obWluLCBtYXgpIHsKICAgIGlmIChtYXggPT0gbnVsbCkgewogICAgICBtYXggPSBtaW47CiAgICAgIG1pbiA9IDA7CiAgICB9CiAgICByZXR1cm4gbWluICsgKDAgfCBNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKTsKICB9OwoKICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlbnRpdHlNYXAgPSB7CiAgICBlc2NhcGU6IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICInIjogJyYjeDI3OycsCiAgICAgICcvJzogJyYjeDJGOycKICAgIH0KICB9OwogIGVudGl0eU1hcC51bmVzY2FwZSA9IF8uaW52ZXJ0KGVudGl0eU1hcC5lc2NhcGUpOwoKICAvLyBSZWdleGVzIGNvbnRhaW5pbmcgdGhlIGtleXMgYW5kIHZhbHVlcyBsaXN0ZWQgaW1tZWRpYXRlbHkgYWJvdmUuCiAgdmFyIGVudGl0eVJlZ2V4ZXMgPSB7CiAgICBlc2NhcGU6ICAgbmV3IFJlZ0V4cCgnWycgKyBfLmtleXMoZW50aXR5TWFwLmVzY2FwZSkuam9pbignJykgKyAnXScsICdnJyksCiAgICB1bmVzY2FwZTogbmV3IFJlZ0V4cCgnKCcgKyBfLmtleXMoZW50aXR5TWFwLnVuZXNjYXBlKS5qb2luKCd8JykgKyAnKScsICdnJykKICB9OwoKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgXy5lYWNoKFsnZXNjYXBlJywgJ3VuZXNjYXBlJ10sIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgX1ttZXRob2RdID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gKCcnICsgc3RyaW5nKS5yZXBsYWNlKGVudGl0eVJlZ2V4ZXNbbWV0aG9kXSwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICByZXR1cm4gZW50aXR5TWFwW21ldGhvZF1bbWF0Y2hdOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQgcHJvcGVydHkgaXMgYSBmdW5jdGlvbiB0aGVuIGludm9rZSBpdDsKICAvLyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICB2YXIgdmFsdWUgPSBvYmplY3RbcHJvcGVydHldOwogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZS5jYWxsKG9iamVjdCkgOiB2YWx1ZTsKICB9OwoKICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbihuYW1lKXsKICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwogICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhIHVuaXF1ZSBpbnRlZ2VyIGlkICh1bmlxdWUgd2l0aGluIHRoZSBlbnRpcmUgY2xpZW50IHNlc3Npb24pLgogIC8vIFVzZWZ1bCBmb3IgdGVtcG9yYXJ5IERPTSBpZHMuCiAgdmFyIGlkQ291bnRlciA9IDA7CiAgXy51bmlxdWVJZCA9IGZ1bmN0aW9uKHByZWZpeCkgewogICAgdmFyIGlkID0gaWRDb3VudGVyKys7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9OwoKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGUgICAgOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAogICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKICB9OwoKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwoKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgIiciOiAgICAgICInIiwKICAgICdcXCc6ICAgICAnXFwnLAogICAgJ1xyJzogICAgICdyJywKICAgICdcbic6ICAgICAnbicsCiAgICAnXHQnOiAgICAgJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwoKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHNldHRpbmdzID0gXy5kZWZhdWx0cyh7fSwgc2V0dGluZ3MsIF8udGVtcGxhdGVTZXR0aW5ncyk7CgogICAgLy8gQ29tYmluZSBkZWxpbWl0ZXJzIGludG8gb25lIHJlZ3VsYXIgZXhwcmVzc2lvbiB2aWEgYWx0ZXJuYXRpb24uCiAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoWwogICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmV2YWx1YXRlIHx8IG5vTWF0Y2gpLnNvdXJjZQogICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwogICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGUsIGludGVycG9sYXRlLCBldmFsdWF0ZSwgb2Zmc2V0KSB7CiAgICAgIHNvdXJjZSArPSB0ZXh0LnNsaWNlKGluZGV4LCBvZmZzZXQpCiAgICAgICAgLnJlcGxhY2UoZXNjYXBlciwgZnVuY3Rpb24obWF0Y2gpIHsgcmV0dXJuICdcXCcgKyBlc2NhcGVzW21hdGNoXTsgfSk7CiAgICAgIHNvdXJjZSArPQogICAgICAgIGVzY2FwZSA/ICInK1xuKChfX3Q9KCIgKyBlc2NhcGUgKyAiKSk9PW51bGw/Jyc6Xy5lc2NhcGUoX190KSkrXG4nIiA6CiAgICAgICAgaW50ZXJwb2xhdGUgPyAiJytcbigoX190PSgiICsgaW50ZXJwb2xhdGUgKyAiKSk9PW51bGw/Jyc6X190KStcbiciIDoKICAgICAgICBldmFsdWF0ZSA/ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIiA6ICcnOwogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgIH0pOwogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKICAgICAgInByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307XG4iICsKICAgICAgc291cmNlICsgInJldHVybiBfX3A7XG4iOwoKICAgIHRyeSB7CiAgICAgIHZhciByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CgogICAgaWYgKGRhdGEpIHJldHVybiByZW5kZXIoZGF0YSwgXyk7CiAgICB2YXIgdGVtcGxhdGUgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKICAgIH07CgogICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24gc291cmNlIGFzIGEgY29udmVuaWVuY2UgZm9yIHByZWNvbXBpbGF0aW9uLgogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9OwoKICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLCB3aGljaCB3aWxsIGRlbGVnYXRlIHRvIHRoZSB3cmFwcGVyLgogIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfKG9iaikuY2hhaW4oKTsKICB9OwoKICAvLyBPT1AKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAogIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCiAgLy8gdW5kZXJzY29yZSBmdW5jdGlvbnMuIFdyYXBwZWQgb2JqZWN0cyBtYXkgYmUgY2hhaW5lZC4KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgogIHZhciByZXN1bHQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0aGlzLl9jaGFpbiA/IF8ob2JqKS5jaGFpbigpIDogb2JqOwogIH07CgogIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KICBfLm1peGluKF8pOwoKICAvLyBBZGQgYWxsIG11dGF0b3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09ICdzaGlmdCcgfHwgbmFtZSA9PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkgZGVsZXRlIG9ialswXTsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG9iaik7CiAgICB9OwogIH0pOwoKICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwogICAgfTsKICB9KTsKCiAgXy5leHRlbmQoXy5wcm90b3R5cGUsIHsKCiAgICAvLyBTdGFydCBjaGFpbmluZyBhIHdyYXBwZWQgVW5kZXJzY29yZSBvYmplY3QuCiAgICBjaGFpbjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgogICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICAgIH0KCiAgfSk7Cgp9KS5jYWxsKHRoaXMpOwoKLy8gICAgIEJhY2tib25lLmpzIDAuOS4xMAoKLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24oKXsKCiAgLy8gSW5pdGlhbCBTZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAoYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIGBleHBvcnRzYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIGFycmF5IG1ldGhvZHMuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIFRoZSB0b3AtbGV2ZWwgbmFtZXNwYWNlLiBBbGwgcHVibGljIEJhY2tib25lIGNsYXNzZXMgYW5kIG1vZHVsZXMgd2lsbAogIC8vIGJlIGF0dGFjaGVkIHRvIHRoaXMuIEV4cG9ydGVkIGZvciBib3RoIENvbW1vbkpTIGFuZCB0aGUgYnJvd3Nlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcwLjkuMTAnOwoKICAvLyBSZXF1aXJlIFVuZGVyc2NvcmUsIGlmIHdlJ3JlIG9uIHRoZSBzZXJ2ZXIsIGFuZCBpdCdzIG5vdCBhbHJlYWR5IHByZXNlbnQuCiAgdmFyIF8gPSByb290Ll87CiAgaWYgKCFfICYmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcpKSBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgb3IgRW5kZXIgb3ducyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSByb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXI7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgogIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CiAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgogIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgLy8gT3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvciB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8KICAvLyBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgogIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGg7CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsKICAgIHJldHVybjsKICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0pOwogICAgcmV0dXJuOwogICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSk7CiAgICByZXR1cm47CiAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgIHJldHVybjsKICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICB9CiAgfTsKCiAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAogIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKICAvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgogIC8vIHN1Y2Nlc3Npb24uCiAgLy8KICAvLyAgICAgdmFyIG9iamVjdCA9IHt9OwogIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7CiAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwogIC8vICAgICBvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CiAgLy8KICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoKICAgIC8vIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgb3IgYW4gZXZlbnRzIG1hcCwKICAgIC8vIHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8KICAgIC8vIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgbGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSB8fCAodGhpcy5fZXZlbnRzW25hbWVdID0gW10pOwogICAgICBsaXN0LnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgZXZlbnRzIHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgJiYgY2FsbGJhY2spKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9KTsKICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgbGlzdCwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAobGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgZXZlbnRzID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gbGlzdC5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGxpc3Rbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICBldmVudHMucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSBldmVudHM7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBbiBpbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9uIG9mIGBvbmAuIFRlbGwgKnRoaXMqIG9iamVjdCB0byBsaXN0ZW4gdG8KICAgIC8vIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncyBsaXN0ZW5pbmcgdG8uCiAgICBsaXN0ZW5UbzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzIHx8ICh0aGlzLl9saXN0ZW5lcnMgPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuZXJJZCB8fCAob2JqLl9saXN0ZW5lcklkID0gXy51bmlxdWVJZCgnbCcpKTsKICAgICAgbGlzdGVuZXJzW2lkXSA9IG9iajsKICAgICAgb2JqLm9uKG5hbWUsIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JyA/IHRoaXMgOiBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuOwogICAgICBpZiAob2JqKSB7CiAgICAgICAgb2JqLm9mZihuYW1lLCB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcgPyB0aGlzIDogY2FsbGJhY2ssIHRoaXMpOwogICAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2spIGRlbGV0ZSBsaXN0ZW5lcnNbb2JqLl9saXN0ZW5lcklkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuZXJzKSB7CiAgICAgICAgICBsaXN0ZW5lcnNbaWRdLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHt9OwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH07CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsLCB3aXRoIGRlZmluZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGRlZmF1bHRzOwogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwogICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgewogICAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBkZWZhdWx0cyk7CiAgICB9CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcyBvbiB0aGUgb2JqZWN0LCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MKICAgIC8vIHlvdSBjaG9vc2UgdG8gc2lsZW5jZSBpdC4KICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHIsIGF0dHJzLCB1bnNldCwgY2hhbmdlcywgc2lsZW50LCBjaGFuZ2luZywgcHJldiwgY3VycmVudDsKICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoKICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBFeHRyYWN0IGF0dHJpYnV0ZXMgYW5kIG9wdGlvbnMuCiAgICAgIHVuc2V0ICAgICAgICAgICA9IG9wdGlvbnMudW5zZXQ7CiAgICAgIHNpbGVudCAgICAgICAgICA9IG9wdGlvbnMuc2lsZW50OwogICAgICBjaGFuZ2VzICAgICAgICAgPSBbXTsKICAgICAgY2hhbmdpbmcgICAgICAgID0gdGhpcy5fY2hhbmdpbmc7CiAgICAgIHRoaXMuX2NoYW5naW5nICA9IHRydWU7CgogICAgICBpZiAoIWNoYW5naW5nKSB7CiAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgICB9CiAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgogICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwoKICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKSBjaGFuZ2VzLnB1c2goYXR0cik7CiAgICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2F0dHJdID0gdmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwogICAgICAgIH0KICAgICAgICB1bnNldCA/IGRlbGV0ZSBjdXJyZW50W2F0dHJdIDogY3VycmVudFthdHRyXSA9IHZhbDsKICAgICAgfQoKICAgICAgLy8gVHJpZ2dlciBhbGwgcmVsZXZhbnQgYXR0cmlidXRlIGNoYW5nZXMuCiAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKSB0aGlzLl9wZW5kaW5nID0gdHJ1ZTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoYW5nZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgY2hhbmdlc1tpXSwgdGhpcywgY3VycmVudFtjaGFuZ2VzW2ldXSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4gYHVuc2V0YCBpcyBhIG5vb3AgaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4KICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2U7CiAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4KICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgLy8gYCJjaGFuZ2UiYCBldmVudC4KICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBzdWNjZXNzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAuCiAgICAgIGlmIChhdHRycyAmJiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMud2FpdCkgJiYgIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKICAgICAgLy8gRG8gbm90IHBlcnNpc3QgaW52YWxpZCBtb2RlbHMuCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB9CgogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIC8vIEZpbmlzaCBjb25maWd1cmluZyBhbmQgc2VuZGluZyB0aGUgQWpheCByZXF1ZXN0LgogICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykgb3B0aW9ucy5hdHRycyA9IGF0dHJzOwogICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3ModGhpcywgbnVsbCwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiAhdGhpcy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSh0aGlzLmF0dHJpYnV0ZXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGEgZ2VuZXJhbAogICAgLy8gYCJlcnJvciJgIGV2ZW50IGFuZCBjYWxsIHRoZSBlcnJvciBjYWxsYmFjaywgaWYgc3BlY2lmaWVkLgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwogICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIG9wdGlvbnMgfHwge30pOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBQcm92aWRlcyBhIHN0YW5kYXJkIGNvbGxlY3Rpb24gY2xhc3MgZm9yIG91ciBzZXRzIG9mIG1vZGVscywgb3JkZXJlZAogIC8vIG9yIHVub3JkZXJlZC4gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCiAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsKICAgIH0sCgogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBkb1NvcnQsIGFkZCwgYXQsIHNvcnQsIHNvcnRBdHRyOwogICAgICBhZGQgPSBbXTsKICAgICAgYXQgPSBvcHRpb25zLmF0OwogICAgICBzb3J0ID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT0gZmFsc2U7CiAgICAgIHNvcnRBdHRyID0gXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpID8gdGhpcy5jb21wYXJhdG9yIDogbnVsbDsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChhdHRycyA9IG1vZGVsc1tpXSwgb3B0aW9ucykpKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChtb2RlbCkpIHsKICAgICAgICAgIGlmIChvcHRpb25zLm1lcmdlKSB7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycyA9PT0gbW9kZWwgPyBtb2RlbC5hdHRyaWJ1dGVzIDogYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydCAmJiAhZG9Tb3J0ICYmIGV4aXN0aW5nLmhhc0NoYW5nZWQoc29ydEF0dHIpKSBkb1NvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIGlzIGEgbmV3IG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgYWRkYCBsaXN0LgogICAgICAgIGFkZC5wdXNoKG1vZGVsKTsKCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQoKICAgICAgLy8gU2VlIGlmIHNvcnRpbmcgaXMgbmVlZGVkLCB1cGRhdGUgYGxlbmd0aGAgYW5kIHNwbGljZSBpbiBuZXcgbW9kZWxzLgogICAgICBpZiAoYWRkLmxlbmd0aCkgewogICAgICAgIGlmIChzb3J0KSBkb1NvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IGFkZC5sZW5ndGg7CiAgICAgICAgaWYgKGF0ICE9IG51bGwpIHsKICAgICAgICAgIHNwbGljZS5hcHBseSh0aGlzLm1vZGVscywgW2F0LCAwXS5jb25jYXQoYWRkKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHB1c2guYXBwbHkodGhpcy5tb2RlbHMsIGFkZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBTaWxlbnRseSBzb3J0IHRoZSBjb2xsZWN0aW9uIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAoZG9Tb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgaWYgKG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgICBmb3IgKGkgPSAwLCBsID0gYWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIChtb2RlbCA9IGFkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGBzb3J0YCBpZiB0aGUgY29sbGVjdGlvbiB3YXMgc29ydGVkLgogICAgICBpZiAoZG9Tb3J0KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwogICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwogICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiB0aGlzLmxlbmd0aH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKGJlZ2luLCBlbmQpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzLnNsaWNlKGJlZ2luLCBlbmQpOwogICAgfSwKCiAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCiAgICBnZXQ6IGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICAgIHRoaXMuX2lkQXR0ciB8fCAodGhpcy5faWRBdHRyID0gdGhpcy5tb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGUpOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWQgfHwgb2JqLmNpZCB8fCBvYmpbdGhpcy5faWRBdHRyXSB8fCBvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YgYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIH0KICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBTbWFydGx5IHVwZGF0ZSBhIGNvbGxlY3Rpb24gd2l0aCBhIGNoYW5nZSBzZXQgb2YgbW9kZWxzLCBhZGRpbmcsCiAgICAvLyByZW1vdmluZywgYW5kIG1lcmdpbmcgYXMgbmVjZXNzYXJ5LgogICAgdXBkYXRlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHthZGQ6IHRydWUsIG1lcmdlOiB0cnVlLCByZW1vdmU6IHRydWV9LCBvcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIG1vZGVsLCBpLCBsLCBleGlzdGluZzsKICAgICAgdmFyIGFkZCA9IFtdLCByZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKCiAgICAgIC8vIEFsbG93IGEgc2luZ2xlIG1vZGVsIChvciBubyBhcmd1bWVudCkgdG8gYmUgcGFzc2VkLgogICAgICBpZiAoIV8uaXNBcnJheShtb2RlbHMpKSBtb2RlbHMgPSBtb2RlbHMgPyBbbW9kZWxzXSA6IFtdOwoKICAgICAgLy8gUHJveHkgdG8gYGFkZGAgZm9yIHRoaXMgY2FzZSwgbm8gbmVlZCB0byBpdGVyYXRlLi4uCiAgICAgIGlmIChvcHRpb25zLmFkZCAmJiAhb3B0aW9ucy5yZW1vdmUpIHJldHVybiB0aGlzLmFkZChtb2RlbHMsIG9wdGlvbnMpOwoKICAgICAgLy8gRGV0ZXJtaW5lIHdoaWNoIG1vZGVscyB0byBhZGQgYW5kIG1lcmdlLCBhbmQgd2hpY2ggdG8gcmVtb3ZlLgogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG1vZGVsID0gbW9kZWxzW2ldOwogICAgICAgIGV4aXN0aW5nID0gdGhpcy5nZXQobW9kZWwpOwogICAgICAgIGlmIChvcHRpb25zLnJlbW92ZSAmJiBleGlzdGluZykgbW9kZWxNYXBbZXhpc3RpbmcuY2lkXSA9IHRydWU7CiAgICAgICAgaWYgKChvcHRpb25zLmFkZCAmJiAhZXhpc3RpbmcpIHx8IChvcHRpb25zLm1lcmdlICYmIGV4aXN0aW5nKSkgewogICAgICAgICAgYWRkLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAob3B0aW9ucy5yZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBtb2RlbCA9IHRoaXMubW9kZWxzW2ldOwogICAgICAgICAgaWYgKCFtb2RlbE1hcFttb2RlbC5jaWRdKSByZW1vdmUucHVzaChtb2RlbCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBSZW1vdmUgbW9kZWxzIChpZiBhcHBsaWNhYmxlKSBiZWZvcmUgd2UgYWRkIGFuZCBtZXJnZSB0aGUgcmVzdC4KICAgICAgaWYgKHJlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHJlbW92ZSwgb3B0aW9ucyk7CiAgICAgIGlmIChhZGQubGVuZ3RoKSB0aGlzLmFkZChhZGQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHMuc2xpY2UoKTsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgaWYgKG1vZGVscykgdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHVwZGF0ZTogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHVwZGF0ZWAgbWV0aG9kIGluc3RlYWQgb2YgYHJlc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gb3B0aW9ucy51cGRhdGUgPyAndXBkYXRlJyA6ICdyZXNldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24gaXMgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBtb2RlbCBvciBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYWRkZWQgdG8gdGhpcyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgIHJldHVybiBhdHRyczsKICAgICAgfQogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byByZW1vdmUgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgc29ydGVkSW5kZXg6IGZ1bmN0aW9uIChtb2RlbCwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFsdWUgfHwgKHZhbHVlID0gdGhpcy5jb21wYXJhdG9yKTsKICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF8uc29ydGVkSW5kZXgodGhpcy5tb2RlbHMsIG1vZGVsLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICB9CgogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgQ29sbGVjdGlvbi4KICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnaW5kZXhPZicsICdzaHVmZmxlJywgJ2xhc3RJbmRleE9mJywKICAgICdpc0VtcHR5JywgJ2NoYWluJ107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknXTsKCiAgLy8gVXNlIGF0dHJpYnV0ZXMgaW5zdGVhZCBvZiBwcm9wZXJ0aWVzLgogIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSwgY29udGV4dCkgewogICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICB9OwogICAgICByZXR1cm4gX1ttZXRob2RdKHRoaXMubW9kZWxzLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICB9OwogIH0pOwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgXy5iaW5kKGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSB0aGlzLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgIHRoaXMudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgdGhpcywgbmFtZSwgYXJncyk7CiAgICAgIH0sIHRoaXMpKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCl7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXlwvXSspJzsKICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgcGFyYW1ldGVycy4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHJldHVybiByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIFVSTCBmcmFnbWVudHMuIElmIHRoZQogIC8vIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBgb25oYXNoY2hhbmdlYCwgZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgogICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQgYnJvd3NlciwKICAgICAgLy8gYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiAhdGhpcy5faGFzUHVzaFN0YXRlICYmICFhdFJvb3QpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgdGhpcy5sb2NhdGlvbi5zZWFyY2ggKyAnIycgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgIC8vIE9yIGlmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CiAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgdGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgewogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCArIGxvYy5zZWFyY2gpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKSB8fCB0aGlzLmxvYWRVcmwodGhpcy5nZXRIYXNoKCkpOwogICAgfSwKCiAgICAvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQogICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKICAgIC8vIHJldHVybnMgYGZhbHNlYC4KICAgIGxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50T3ZlcnJpZGUpIHsKICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnRPdmVycmlkZSk7CiAgICAgIHZhciBtYXRjaGVkID0gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBtYXRjaGVkOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiBvcHRpb25zfTsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKTsKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSByZXR1cm47CiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIGZyYWdtZW50OwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICB0aGlzLl9jb25maWd1cmUob3B0aW9ucyB8fCB7fSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJwogICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQogICAgLy8gICAgIH0KICAgIC8vCiAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgogICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCiAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkgdGhyb3cgbmV3IEVycm9yKCdNZXRob2QgIicgKyBldmVudHNba2V5XSArICciIGRvZXMgbm90IGV4aXN0Jyk7CiAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7CiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwogICAgICAgIG1ldGhvZCA9IF8uYmluZChtZXRob2QsIHRoaXMpOwogICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBzZWxlY3RvciwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgIH0sCgogICAgLy8gUGVyZm9ybXMgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbiBvZiBhIFZpZXcgd2l0aCBhIHNldCBvZiBvcHRpb25zLgogICAgLy8gS2V5cyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSosIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMpIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7CiAgICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfSwKCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsKICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHZhciAkZWwgPSBCYWNrYm9uZS4kKCc8JyArIF8ucmVzdWx0KHRoaXMsICd0YWdOYW1lJykgKyAnPicpLmF0dHIoYXR0cnMpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCgkZWwsIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuc3luYwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CgogICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQoKICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CgogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CgogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIH07CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgQmFja2JvbmUuYWpheCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07Cgp9KS5jYWxsKHRoaXMpOwovKgpDb3B5cmlnaHQgKGMpIDIwMTEtMjAxMyBAV2FsbWFydExhYnMKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvCmRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlCnJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vcgpzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUgpERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgo7OwooZnVuY3Rpb24oKSB7CgovKmdsb2JhbCBjbG9uZUluaGVyaXRWYXJzLCBjcmVhdGVJbmhlcml0VmFycywgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMgKi8KCi8vc3VwcG9ydCB6ZXB0by5mb3JFYWNoIG9uIGpRdWVyeQppZiAoISQuZm4uZm9yRWFjaCkgewogICQuZm4uZm9yRWFjaCA9IGZ1bmN0aW9uKGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAkLmZuLmVhY2guY2FsbCh0aGlzLCBmdW5jdGlvbihpbmRleCkgewogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQgfHwgdGhpcywgdGhpcywgaW5kZXgpOwogICAgfSk7CiAgfTsKfQoKdmFyIHZpZXdOYW1lQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctbmFtZScsCiAgICB2aWV3Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctY2lkJywKICAgIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdmlldy1oZWxwZXInOwoKLy92aWV3IGluc3RhbmNlcwp2YXIgdmlld3NJbmRleGVkQnlDaWQgPSB7fTsKCnZhciBUaG9yYXggPSB0aGlzLlRob3JheCA9IHsKICBWRVJTSU9OOiAnMi4wLjByYzEnLAogIHRlbXBsYXRlUGF0aFByZWZpeDogJycsCiAgdGVtcGxhdGVzOiB7fSwKICAvL3ZpZXcgY2xhc3NlcwogIFZpZXdzOiB7fSwKICAvL2NlcnRhaW4gZXJyb3IgcHJvbmUgcGllY2VzIG9mIGNvZGUgKG9uIEFuZHJvaWQgb25seSBpdCBzZWVtcykKICAvL2FyZSB3cmFwcGVkIGluIGEgdHJ5IGNhdGNoIGJsb2NrLCB0aGVuIHRyaWdnZXIgdGhpcyBoYW5kbGVyIGluCiAgLy90aGUgY2F0Y2gsIHdpdGggdGhlIG5hbWUgb2YgdGhlIGZ1bmN0aW9uIG9yIGV2ZW50IHRoYXQgd2FzCiAgLy90cnlpbmcgdG8gYmUgZXhlY3V0ZWQuIE92ZXJyaWRlIHRoaXMgd2l0aCBhIGN1c3RvbSBoYW5kbGVyCiAgLy90byBkZWJ1ZyAvIGxvZyAvIGV0YwogIG9uRXhjZXB0aW9uOiBmdW5jdGlvbihuYW1lLCBlcnIpIHsKICAgIHRocm93IGVycjsKICB9Cn07CgpUaG9yYXguVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqLmN0b3IpIHsKICAgICAgICBvYmouY3Rvci5jYWxsKHRoaXMsIHJlc3BvbnNlKTsKICAgICAgfQogICAgfSwgdGhpcyk7CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkID0ge307CiAgICB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWQgPSB7fTsKCiAgICAvLyBTZXR1cCBvYmplY3QgZXZlbnQgdHJhY2tpbmcKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgICB9KTsKCiAgICB2aWV3c0luZGV4ZWRCeUNpZFt0aGlzLmNpZF0gPSB0aGlzOwogICAgdGhpcy5jaGlsZHJlbiA9IHt9OwogICAgdGhpcy5fcmVuZGVyQ291bnQgPSAwOwoKICAgIC8vdGhpcy5vcHRpb25zIGlzIHJlbW92ZWQgaW4gVGhvcmF4LlZpZXcsIHdlIG1lcmdlIHBhc3NlZAogICAgLy9wcm9wZXJ0aWVzIGRpcmVjdGx5IHdpdGggdGhlIHZpZXcgYW5kIHRlbXBsYXRlIGNvbnRleHQKICAgIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMgfHwge30pOwoKICAgIC8vIFNldHVwIGhlbHBlcnMKICAgIGJpbmRIZWxwZXJzLmNhbGwodGhpcyk7CgogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iai5jb25maWd1cmUpIHsKICAgICAgICBvYmouY29uZmlndXJlLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH0sCgogIHNldEVsZW1lbnQgOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMubmFtZSAmJiB0aGlzLiRlbC5hdHRyKHZpZXdOYW1lQXR0cmlidXRlTmFtZSwgdGhpcy5uYW1lKTsKICAgIHRoaXMuJGVsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAoKICBfYWRkQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdID0gdmlldzsKICAgIGlmICghdmlldy5wYXJlbnQpIHsKICAgICAgdmlldy5wYXJlbnQgPSB0aGlzOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGlsZCcsIHZpZXcpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgX3JlbW92ZUNoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICBkZWxldGUgdGhpcy5jaGlsZHJlblt2aWV3LmNpZF07CiAgICB2aWV3LnBhcmVudCA9IG51bGw7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9KTsKICAgIF8uZWFjaCh0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWQsIHRoaXMudW5iaW5kRGF0YU9iamVjdCwgdGhpcyk7CiAgICB0aGlzLnRyaWdnZXIoJ2Rlc3Ryb3llZCcpOwogICAgZGVsZXRlIHZpZXdzSW5kZXhlZEJ5Q2lkW3RoaXMuY2lkXTsKICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgIGlmIChvcHRpb25zLmNoaWxkcmVuKSB7CiAgICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICAgIGlmICh0aGlzLnBhcmVudCkgewogICAgICB0aGlzLnBhcmVudC5fcmVtb3ZlQ2hpbGQodGhpcyk7CiAgICB9CiAgICB0aGlzLnJlbW92ZSgpOyAvLyBXaWxsIGNhbGwgc3RvcExpc3RlbmluZygpCiAgfSwKCiAgcmVuZGVyOiBmdW5jdGlvbihvdXRwdXQpIHsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IF8uZmlsdGVyKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7IHJldHVybiBjaGlsZC5faGVscGVyT3B0aW9uczsgfSk7CgogICAgdmFyIGNoaWxkcmVuID0ge307CiAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQsIGtleSkgewogICAgICBpZiAoIWNoaWxkLl9oZWxwZXJPcHRpb25zKSB7CiAgICAgICAgY2hpbGRyZW5ba2V5XSA9IGNoaWxkOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKCiAgICBpZiAoXy5pc1VuZGVmaW5lZChvdXRwdXQpIHx8ICghXy5pc0VsZW1lbnQob3V0cHV0KSAmJiAhVGhvcmF4LlV0aWwuaXMkKG91dHB1dCkgJiYgIShvdXRwdXQgJiYgb3V0cHV0LmVsKSAmJiAhXy5pc1N0cmluZyhvdXRwdXQpICYmICFfLmlzRnVuY3Rpb24ob3V0cHV0KSkpIHsKICAgICAgLy8gdHJ5IG9uZSBtb3JlIHRpbWUgdG8gYXNzaWduIHRoZSB0ZW1wbGF0ZSwgaWYgd2UgZG9uJ3QKICAgICAgLy8geWV0IGhhdmUgb25lIHdlIG11c3QgcmFpc2UKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAndGVtcGxhdGUnLCB7CiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgfSk7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy50ZW1wbGF0ZSk7CiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihvdXRwdXQpKSB7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUob3V0cHV0KTsKICAgIH0KCiAgICAvLyBEZXN0cm95IGFueSBoZWxwZXJzIHRoYXQgbWF5IGJlIGxpbmdlcmluZwogICAgXy5lYWNoKHRoaXMuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICBjaGlsZC5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IHVuZGVmaW5lZDsKCiAgICAvL2FjY2VwdCBhIHZpZXcsIHN0cmluZywgSGFuZGxlYmFycy5TYWZlU3RyaW5nIG9yIERPTSBlbGVtZW50CiAgICB0aGlzLmh0bWwoKG91dHB1dCAmJiBvdXRwdXQuZWwpIHx8IChvdXRwdXQgJiYgb3V0cHV0LnN0cmluZykgfHwgb3V0cHV0KTsKICAgICsrdGhpcy5fcmVuZGVyQ291bnQ7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkJyk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0sCgogIGNvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLmF0dHJpYnV0ZXMpIHx8IHt9KTsKICB9LAoKICBfZ2V0Q29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy5leHRlbmQoe30sIHRoaXMsIGdldFZhbHVlKHRoaXMsICdjb250ZXh0JykgfHwge30pOwogIH0sCgogIC8vIFByaXZhdGUgdmFyaWFibGVzIGluIGhhbmRsZWJhcnMgLyBvcHRpb25zLmRhdGEgaW4gdGVtcGxhdGUgaGVscGVycwogIF9nZXREYXRhOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gewogICAgICB2aWV3OiB0aGlzLAogICAgICBjaWQ6IF8udW5pcXVlSWQoJ3QnKSwKICAgICAgeWllbGQ6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIGZuIGlzIHNlZWRlZCBieSB0ZW1wbGF0ZSBoZWxwZXIgcGFzc2luZyBjb250ZXh0IHRvIGRhdGEKICAgICAgICByZXR1cm4gZGF0YS5mbiAmJiBkYXRhLmZuKGRhdGEpOwogICAgICB9CiAgICB9OwogIH0sCgogIF9nZXRIZWxwZXJzOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmhlbHBlcnMpIHsKICAgICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCBIYW5kbGViYXJzLmhlbHBlcnMsIHRoaXMuaGVscGVycyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzOwogICAgfQoKICB9LAoKICByZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgY29udGV4dCwgaWdub3JlRXJyb3JzKSB7CiAgICB2YXIgdGVtcGxhdGU7CiAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzLl9nZXRDb250ZXh0KCk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGZpbGUpKSB7CiAgICAgIHRlbXBsYXRlID0gZmlsZTsKICAgIH0gZWxzZSB7CiAgICAgIHRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUoZmlsZSwgaWdub3JlRXJyb3JzKTsKICAgIH0KICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgcmV0dXJuICcnOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRlbXBsYXRlKGNvbnRleHQsIHsKICAgICAgICBoZWxwZXJzOiB0aGlzLl9nZXRIZWxwZXJzKCksCiAgICAgICAgZGF0YTogdGhpcy5fZ2V0RGF0YShjb250ZXh0KQogICAgICB9KTsKICAgIH0KICB9LAoKICBlbnN1cmVSZW5kZXJlZDogZnVuY3Rpb24oKSB7CiAgICAhdGhpcy5fcmVuZGVyQ291bnQgJiYgdGhpcy5yZW5kZXIoKTsKICB9LAoKICBhcHBlbmRUbzogZnVuY3Rpb24oZWwpIHsKICAgIHRoaXMuZW5zdXJlUmVuZGVyZWQoKTsKICAgICQoZWwpLmFwcGVuZCh0aGlzLmVsKTsKICAgIHRoaXMudHJpZ2dlcigncmVhZHknLCB7dGFyZ2V0OiB0aGlzfSk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oaHRtbCkgewogICAgaWYgKF8uaXNVbmRlZmluZWQoaHRtbCkpIHsKICAgICAgcmV0dXJuIHRoaXMuZWwuaW5uZXJIVE1MOwogICAgfSBlbHNlIHsKICAgICAgLy8gRXZlbnQgZm9yIElFIGVsZW1lbnQgZml4ZXMKICAgICAgdGhpcy50cmlnZ2VyKCdiZWZvcmU6YXBwZW5kJyk7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fcmVwbGFjZUhUTUwoaHRtbCk7CiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfQogIH0sCgogIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oaHRtbCkgewogICAgdGhpcy5lbC5pbm5lckhUTUwgPSAiIjsKICAgIHJldHVybiB0aGlzLiRlbC5hcHBlbmQoaHRtbCk7CiAgfSwKCiAgX2FuY2hvckNsaWNrOiBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHRhcmdldCA9ICQoZXZlbnQuY3VycmVudFRhcmdldCksCiAgICAgICAgaHJlZiA9IHRhcmdldC5hdHRyKCdocmVmJyk7CiAgICAvLyBSb3V0ZSBhbnl0aGluZyB0aGF0IHN0YXJ0cyB3aXRoICMgb3IgLyAoZXhjbHVkaW5nIC8vZG9tYWluIHVybHMpCiAgICBpZiAoaHJlZiAmJiAoaHJlZlswXSA9PT0gJyMnIHx8IChocmVmWzBdID09PSAnLycgJiYgaHJlZlsxXSAhPT0gJy8nKSkpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShocmVmLCB7CiAgICAgICAgdHJpZ2dlcjogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9KTsKClRob3JheC5WaWV3LmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwoKICB2YXIgY2hpbGQgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGNoaWxkLl9fcGFyZW50X18gPSB0aGlzOwoKICByZXNldEluaGVyaXRWYXJzKGNoaWxkKTsKCiAgcmV0dXJuIGNoaWxkOwp9OwoKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5WaWV3LCBUaG9yYXguVmlld3MpOwoKZnVuY3Rpb24gYmluZEhlbHBlcnMoKSB7CiAgaWYgKHRoaXMuaGVscGVycykgewogICAgXy5lYWNoKHRoaXMuaGVscGVycywgZnVuY3Rpb24oaGVscGVyLCBuYW1lKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpczsKICAgICAgdGhpcy5oZWxwZXJzW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgb3B0aW9ucyA9IF8ubGFzdChhcmdzKTsKICAgICAgICBvcHRpb25zLmNvbnRleHQgPSB0aGlzOwogICAgICAgIHJldHVybiBoZWxwZXIuYXBwbHkodmlldywgYXJncyk7CiAgICAgIH07CiAgICB9LCB0aGlzKTsKICB9Cn0KCi8vJChzZWxlY3RvcikudmlldygpIGhlbHBlcgokLmZuLnZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwgewogICAgaGVscGVyOiB0cnVlCiAgfSk7CiAgdmFyIHNlbGVjdG9yID0gJ1snICsgdmlld0NpZEF0dHJpYnV0ZU5hbWUgKyAnXSc7CiAgaWYgKCFvcHRpb25zLmhlbHBlcikgewogICAgc2VsZWN0b3IgKz0gJzpub3QoWycgKyB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSArICddKSc7CiAgfQogIHZhciBlbCA9ICQodGhpcykuY2xvc2VzdChzZWxlY3Rvcik7CiAgcmV0dXJuIChlbCAmJiB2aWV3c0luZGV4ZWRCeUNpZFtlbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lKV0pIHx8IGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyOnRydWUsIGNsb25lRXZlbnRzOiB0cnVlICovCmZ1bmN0aW9uIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihrbGFzcywgaGFzaCkgewogIHZhciAkc3VwZXIgPSBrbGFzcy5leHRlbmQ7CiAga2xhc3MuZXh0ZW5kID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgY2hpbGQgPSAkc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChjaGlsZC5wcm90b3R5cGUubmFtZSkgewogICAgICBoYXNoW2NoaWxkLnByb3RvdHlwZS5uYW1lXSA9IGNoaWxkOwogICAgfQogICAgcmV0dXJuIGNoaWxkOwogIH07Cn0KCmZ1bmN0aW9uIHJlZ2lzdHJ5R2V0KG9iamVjdCwgdHlwZSwgbmFtZSwgaWdub3JlRXJyb3JzKSB7CiAgdmFyIHRhcmdldCA9IG9iamVjdFt0eXBlXSwKICAgICAgdmFsdWU7CiAgaWYgKG5hbWUuaW5kZXhPZignLicpID49IDApIHsKICAgIHZhciBiaXRzID0gbmFtZS5zcGxpdCgvXC4vKTsKICAgIG5hbWUgPSBiaXRzLnBvcCgpOwogICAgXy5lYWNoKGJpdHMsIGZ1bmN0aW9uKGtleSkgewogICAgICB0YXJnZXQgPSB0YXJnZXRba2V5XTsKICAgIH0pOwogIH0KICB0YXJnZXQgJiYgKHZhbHVlID0gdGFyZ2V0W25hbWVdKTsKICBpZiAoIXZhbHVlICYmICFpZ25vcmVFcnJvcnMpIHsKICAgIHRocm93IG5ldyBFcnJvcih0eXBlICsgJzogJyArIG5hbWUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQp9CgpmdW5jdGlvbiBhc3NpZ25UZW1wbGF0ZShhdHRyaWJ1dGVOYW1lLCBvcHRpb25zKSB7CiAgdmFyIHRlbXBsYXRlOwogIC8vIGlmIGF0dHJpYnV0ZSBpcyB0aGUgbmFtZSBvZiB0ZW1wbGF0ZSB0byBmZXRjaAogIGlmIChfLmlzU3RyaW5nKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXNbYXR0cmlidXRlTmFtZV0sIHRydWUpOwogIC8vIGVsc2UgdHJ5IGFuZCBmZXRjaCB0aGUgdGVtcGxhdGUgYmFzZWQgb24gdGhlIG5hbWUKICB9IGVsc2UgaWYgKHRoaXMubmFtZSAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMubmFtZSArIChvcHRpb25zLmV4dGVuc2lvbiB8fCAnJyksIHRydWUpOwogIH0KICAvLyBDb2xsZWN0aW9uVmlldyBhbmQgTGF5b3V0VmlldyBoYXZlIGEgZGVmYXVsdFRlbXBsYXRlIHRoYXQgbWF5IGJlIHVzZWQgaWYgbm9uZQogIC8vIHdhcyBmb3VuZCwgcmVndWxhciB2aWV3cyBtdXN0IGhhdmUgYSB0ZW1wbGF0ZSBpZiByZW5kZXIoKSBpcyBjYWxsZWQKICBpZiAoIXRlbXBsYXRlICYmIGF0dHJpYnV0ZU5hbWUgPT09ICd0ZW1wbGF0ZScgJiYgdGhpcy5fZGVmYXVsdFRlbXBsYXRlKSB7CiAgICB0ZW1wbGF0ZSA9IHRoaXMuX2RlZmF1bHRUZW1wbGF0ZTsKICB9CiAgLy8gaWYgd2UgZm91bmQgc29tZXRoaW5nLCBhc3NpZ24gaXQKICBpZiAodGVtcGxhdGUgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGhpc1thdHRyaWJ1dGVOYW1lXSA9IHRlbXBsYXRlOwogIH0KICAvLyBpZiBub3RoaW5nIHdhcyBmb3VuZCBhbmQgaXQncyByZXF1aXJlZCwgdGhyb3cKICBpZiAob3B0aW9ucy5yZXF1aXJlZCAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZpZXcgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJyByZXF1aXJlczogJyArIGF0dHJpYnV0ZU5hbWUpOwogIH0KfQoKLy8gZ2V0VmFsdWUgaXMgdXNlZCBpbnN0ZWFkIG9mIF8ucmVzdWx0IGJlY2F1c2Ugd2UKLy8gbmVlZCBhbiBleHRyYSBzY29wZSBwYXJhbWV0ZXIsIGFuZCB3aWxsIG1pbmlmeQovLyBiZXR0ZXIgdGhhbiBfLnJlc3VsdApmdW5jdGlvbiBnZXRWYWx1ZShvYmplY3QsIHByb3AsIHNjb3BlKSB7CiAgaWYgKCEob2JqZWN0ICYmIG9iamVjdFtwcm9wXSkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gXy5pc0Z1bmN0aW9uKG9iamVjdFtwcm9wXSkKICAgID8gb2JqZWN0W3Byb3BdLmNhbGwoc2NvcGUgfHwgb2JqZWN0KQogICAgOiBvYmplY3RbcHJvcF07Cn0KCnZhciBpbmhlcml0VmFycyA9IHt9OwpmdW5jdGlvbiBjcmVhdGVJbmhlcml0VmFycyhzZWxmKSB7CiAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBvdXIgc3RhdGljIGV2ZW50IG9iamVjdHMKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFzZWxmW29iai5uYW1lXSkgewogICAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIHJlc2V0SW5oZXJpdFZhcnMoc2VsZikgewogIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgb3VyIHN0YXRpYyBldmVudCBvYmplY3RzCiAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgfSk7Cn0KZnVuY3Rpb24gd2Fsa0luaGVyaXRUcmVlKHNvdXJjZSwgZmllbGROYW1lLCBpc1N0YXRpYywgY2FsbGJhY2spIHsKICB2YXIgdHJlZSA9IFtdOwogIGlmIChfLmhhcyhzb3VyY2UsIGZpZWxkTmFtZSkpIHsKICAgIHRyZWUucHVzaChzb3VyY2UpOwogIH0KICB2YXIgaXRlcmF0ZSA9IHNvdXJjZTsKICBpZiAoaXNTdGF0aWMpIHsKICAgIHdoaWxlIChpdGVyYXRlID0gaXRlcmF0ZS5fX3BhcmVudF9fKSB7CiAgICAgIGlmIChfLmhhcyhpdGVyYXRlLCBmaWVsZE5hbWUpKSB7CiAgICAgICAgdHJlZS5wdXNoKGl0ZXJhdGUpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGl0ZXJhdGUgPSBpdGVyYXRlLmNvbnN0cnVjdG9yOwogICAgd2hpbGUgKGl0ZXJhdGUpIHsKICAgICAgaWYgKGl0ZXJhdGUucHJvdG90eXBlICYmIF8uaGFzKGl0ZXJhdGUucHJvdG90eXBlLCBmaWVsZE5hbWUpKSB7CiAgICAgICAgdHJlZS5wdXNoKGl0ZXJhdGUucHJvdG90eXBlKTsKICAgICAgfQogICAgICBpdGVyYXRlID0gaXRlcmF0ZS5fX3N1cGVyX18gJiYgaXRlcmF0ZS5fX3N1cGVyX18uY29uc3RydWN0b3I7CiAgICB9CiAgfQoKICB2YXIgaSA9IHRyZWUubGVuZ3RoOwogIHdoaWxlIChpLS0pIHsKICAgIF8uZWFjaChnZXRWYWx1ZSh0cmVlW2ldLCBmaWVsZE5hbWUsIHNvdXJjZSksIGNhbGxiYWNrKTsKICB9Cn0KCmZ1bmN0aW9uIG9iamVjdEV2ZW50cyh0YXJnZXQsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAoXy5pc09iamVjdChjYWxsYmFjaykpIHsKICAgIHZhciBzcGVjID0gaW5oZXJpdFZhcnNbZXZlbnROYW1lXTsKICAgIGlmIChzcGVjICYmIHNwZWMuZXZlbnQpIHsKICAgICAgYWRkRXZlbnRzKHRhcmdldFsnXycgKyBldmVudE5hbWUgKyAnRXZlbnRzJ10sIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGFkZEV2ZW50cyh0YXJnZXQsIHNvdXJjZSwgY29udGV4dCkgewogIF8uZWFjaChzb3VyY2UsIGZ1bmN0aW9uKGNhbGxiYWNrLCBldmVudE5hbWUpIHsKICAgIGlmIChfLmlzQXJyYXkoY2FsbGJhY2spKSB7CiAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICB0YXJnZXQucHVzaChbZXZlbnROYW1lLCBjYiwgY29udGV4dF0pOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcmdldC5wdXNoKFtldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0XSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpIHsKICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuZGF0YSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdIYW5kbGViYXJzIHRlbXBsYXRlIGNvbXBpbGVkIHdpdGhvdXQgZGF0YSwgdXNlOiBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGUsIHtkYXRhOiB0cnVlfSknKTsKICB9CiAgcmV0dXJuIG9wdGlvbnMuZGF0YTsKfQoKLy8gVGhlc2Ugd2hpdGVsaXN0ZWQgYXR0cmlidXRlcyB3aWxsIGJlIHRoZSBvbmx5IG9uZXMgcGFzc2VkCi8vIGZyb20gdGhlIG9wdGlvbnMgaGFzaCB0byBUaG9yYXguVXRpbC50YWcKdmFyIGh0bWxBdHRyaWJ1dGVzVG9Db3B5ID0gWydpZCcsICdjbGFzc05hbWUnLCAndGFnTmFtZSddOwoKLy8gSW4gaGVscGVycyAidGFnTmFtZSIgb3IgInRhZyIgbWF5IGJlIHNwZWNpZmllZCwgYXMgd2VsbAovLyBhcyAiY2xhc3MiIG9yICJjbGFzc05hbWUiLiBOb3JtYWxpemUgdG8gInRhZ05hbWUiIGFuZAovLyAiY2xhc3NOYW1lIiB0byBtYXRjaCB0aGUgcHJvcGVydHkgbmFtZXMgdXNlZCBieSBCYWNrYm9uZQovLyBqUXVlcnksIGV0Yy4gU3BlY2lhbCBjYXNlIGZvciAiY2xhc3NOYW1lIiBpbgovLyBUaG9yYXguVXRpbC50YWc6IHdpbGwgYmUgcmV3cml0dGVuIGFzICJjbGFzcyIgaW4KLy8gZ2VuZXJhdGVkIEhUTUwuCmZ1bmN0aW9uIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy50YWcpIHsKICAgIG9wdGlvbnMudGFnTmFtZSA9IG9wdGlvbnMudGFnOwogICAgZGVsZXRlIG9wdGlvbnMudGFnOwogIH0KICBpZiAob3B0aW9uc1snY2xhc3MnXSkgewogICAgb3B0aW9ucy5jbGFzc05hbWUgPSBvcHRpb25zWydjbGFzcyddOwogICAgZGVsZXRlIG9wdGlvbnNbJ2NsYXNzJ107CiAgfQp9CgpUaG9yYXguVXRpbCA9IHsKICBnZXRWaWV3SW5zdGFuY2U6IGZ1bmN0aW9uKG5hbWUsIGF0dHJpYnV0ZXMpIHsKICAgIGF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgaWYgKF8uaXNTdHJpbmcobmFtZSkpIHsKICAgICAgdmFyIEtsYXNzID0gcmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCBuYW1lLCBmYWxzZSk7CiAgICAgIHJldHVybiBLbGFzcy5jaWQgPyBfLmV4dGVuZChLbGFzcywgYXR0cmlidXRlcyB8fCB7fSkgOiBuZXcgS2xhc3MoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICByZXR1cm4gbmV3IG5hbWUoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9LAoKICBnZXRUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgaWdub3JlRXJyb3JzKSB7CiAgICAvL2FwcGVuZCB0aGUgdGVtcGxhdGUgcGF0aCBwcmVmaXggaWYgaXQgaXMgbWlzc2luZwogICAgdmFyIHBhdGhQcmVmaXggPSBUaG9yYXgudGVtcGxhdGVQYXRoUHJlZml4LAogICAgICAgIHRlbXBsYXRlOwogICAgaWYgKHBhdGhQcmVmaXggJiYgZmlsZS5zdWJzdHIoMCwgcGF0aFByZWZpeC5sZW5ndGgpICE9PSBwYXRoUHJlZml4KSB7CiAgICAgIGZpbGUgPSBwYXRoUHJlZml4ICsgZmlsZTsKICAgIH0KCiAgICAvLyBXaXRob3V0IGV4dGVuc2lvbgogICAgZmlsZSA9IGZpbGUucmVwbGFjZSgvXC5oYW5kbGViYXJzJC8sICcnKTsKICAgIHRlbXBsYXRlID0gVGhvcmF4LnRlbXBsYXRlc1tmaWxlXTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgLy8gV2l0aCBleHRlbnNpb24KICAgICAgZmlsZSA9IGZpbGUgKyAnLmhhbmRsZWJhcnMnOwogICAgICB0ZW1wbGF0ZSA9IFRob3JheC50ZW1wbGF0ZXNbZmlsZV07CiAgICB9CgogICAgaWYgKCF0ZW1wbGF0ZSAmJiAhaWdub3JlRXJyb3JzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGVzOiAnICsgZmlsZSArICcgZG9lcyBub3QgZXhpc3QuJyk7CiAgICB9CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfSwKCiAgLy8nc2VsZWN0b3InIGlzIG5vdCBwcmVzZW50IGluICQoJzxwPjwvcD4nKQogIC8vVE9ETzogaW52ZXN0aWdhZ2UgYSBiZXR0ZXIgZGV0ZWN0aW9uIG1ldGhvZAogIGlzJDogZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc09iamVjdChvYmopICYmICgnbGVuZ3RoJyBpbiBvYmopOwogIH0sCiAgZXhwYW5kVG9rZW46IGZ1bmN0aW9uKGlucHV0LCBzY29wZSkgewogICAgaWYgKGlucHV0ICYmIGlucHV0LmluZGV4T2YgJiYgaW5wdXQuaW5kZXhPZigne3snKSA+PSAwKSB7CiAgICAgIHZhciByZSA9IC8oPzpcez9bXntdKyl8KD86XHtceyhbXn1dKylcfVx9KS9nLAogICAgICAgICAgbWF0Y2gsCiAgICAgICAgICByZXQgPSBbXTsKICAgICAgZnVuY3Rpb24gZGVyZWYodG9rZW4sIHNjb3BlKSB7CiAgICAgICAgaWYgKHRva2VuLm1hdGNoKC9eKCJ8JykvKSAmJiB0b2tlbi5tYXRjaCgvKCJ8JykkLykpIHsKICAgICAgICAgIHJldHVybiB0b2tlbi5yZXBsYWNlKC8oXigifCcpfCgnfCIpJCkvZywgJycpOwogICAgICAgIH0KICAgICAgICB2YXIgc2VnbWVudHMgPSB0b2tlbi5zcGxpdCgnLicpLAogICAgICAgICAgICBsZW4gPSBzZWdtZW50cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNjb3BlICYmIGkgPCBsZW47IGkrKykgewogICAgICAgICAgaWYgKHNlZ21lbnRzW2ldICE9PSAndGhpcycpIHsKICAgICAgICAgICAgc2NvcGUgPSBzY29wZVtzZWdtZW50c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzY29wZTsKICAgICAgfQogICAgICB3aGlsZSAobWF0Y2ggPSByZS5leGVjKGlucHV0KSkgewogICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgdmFyIHBhcmFtcyA9IG1hdGNoWzFdLnNwbGl0KC9ccysvKTsKICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgaGVscGVyID0gcGFyYW1zLnNoaWZ0KCk7CiAgICAgICAgICAgIHBhcmFtcyA9IF8ubWFwKHBhcmFtcywgZnVuY3Rpb24ocGFyYW0pIHsgcmV0dXJuIGRlcmVmKHBhcmFtLCBzY29wZSk7IH0pOwogICAgICAgICAgICBpZiAoSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0pIHsKICAgICAgICAgICAgICByZXQucHVzaChIYW5kbGViYXJzLmhlbHBlcnNbaGVscGVyXS5hcHBseShzY29wZSwgcGFyYW1zKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhlIGhlbHBlciBpcyBub3QgZGVmaW5lZCBkbyBub3RoaW5nCiAgICAgICAgICAgICAgcmV0LnB1c2gobWF0Y2hbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXQucHVzaChkZXJlZihwYXJhbXNbMF0sIHNjb3BlKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5wdXQgPSByZXQuam9pbignJyk7CiAgICB9CiAgICByZXR1cm4gaW5wdXQ7CiAgfSwKICB0YWc6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIGNvbnRlbnQsIHNjb3BlKSB7CiAgICB2YXIgaHRtbEF0dHJpYnV0ZXMgPSBfLm9taXQoYXR0cmlidXRlcywgJ3RhZ05hbWUnKSwKICAgICAgICB0YWcgPSBhdHRyaWJ1dGVzLnRhZ05hbWUgfHwgJ2Rpdic7CiAgICByZXR1cm4gJzwnICsgdGFnICsgJyAnICsgXy5tYXAoaHRtbEF0dHJpYnV0ZXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKF8uaXNVbmRlZmluZWQodmFsdWUpIHx8IGtleSA9PT0gJ2V4cGFuZC10b2tlbnMnKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICAgIHZhciBmb3JtYXR0ZWRWYWx1ZSA9IHZhbHVlOwogICAgICBpZiAoc2NvcGUpIHsKICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHZhbHVlLCBzY29wZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIChrZXkgPT09ICdjbGFzc05hbWUnID8gJ2NsYXNzJyA6IGtleSkgKyAnPSInICsgSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uKGZvcm1hdHRlZFZhbHVlKSArICciJzsKICAgIH0pLmpvaW4oJyAnKSArICc+JyArIChfLmlzVW5kZWZpbmVkKGNvbnRlbnQpID8gJycgOiBjb250ZW50KSArICc8LycgKyB0YWcgKyAnPic7CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzICovClRob3JheC5NaXhpbnMgPSB7fTsKCmluaGVyaXRWYXJzLm1peGlucyA9IHsKICBuYW1lOiAnbWl4aW5zJywKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgXy5lYWNoKHRoaXMuY29uc3RydWN0b3IubWl4aW5zLCB0aGlzLm1peGluLCB0aGlzKTsKICAgIF8uZWFjaCh0aGlzLm1peGlucywgdGhpcy5taXhpbiwgdGhpcyk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBtaXhpbjogZnVuY3Rpb24obWl4aW4pIHsKICAgIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwogICAgdGhpcy5taXhpbnMucHVzaChtaXhpbik7CiAgfSwKICByZWdpc3Rlck1peGluOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgbWV0aG9kcykgewogICAgVGhvcmF4Lk1peGluc1tuYW1lXSA9IFtjYWxsYmFjaywgbWV0aG9kc107CiAgfQp9KTsKClRob3JheC5WaWV3LnByb3RvdHlwZS5taXhpbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICBpZiAoIXRoaXMuX2FwcGxpZWRNaXhpbnMpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMgPSBbXTsKICB9CiAgaWYgKHRoaXMuX2FwcGxpZWRNaXhpbnMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMucHVzaChuYW1lKTsKICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgbmFtZS5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG1peGluID0gVGhvcmF4Lk1peGluc1tuYW1lXTsKICAgICAgXy5leHRlbmQodGhpcywgbWl4aW5bMV0pOwogICAgICAvL21peGluIGNhbGxiYWNrIG1heSBiZSBhbiBhcnJheSBvZiBbY2FsbGJhY2ssIGFyZ3VtZW50c10KICAgICAgaWYgKF8uaXNBcnJheShtaXhpblswXSkpIHsKICAgICAgICBtaXhpblswXVswXS5hcHBseSh0aGlzLCBtaXhpblswXVsxXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWl4aW5bMF0uYXBwbHkodGhpcywgXy50b0FycmF5KGFyZ3VtZW50cykuc2xpY2UoMSkpOwogICAgICB9CiAgICB9CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzLCBvYmplY3RFdmVudHMsIHdhbGtJbmhlcml0VHJlZSAqLwovLyBTYXZlIGEgY29weSBvZiB0aGUgX29uIG1ldGhvZCB0byBjYWxsIGFzIGEgJHN1cGVyIG1ldGhvZAp2YXIgX29uID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLm9uOwoKaW5oZXJpdFZhcnMuZXZlbnQgPSB7CiAgbmFtZTogJ19ldmVudHMnLAoKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgd2Fsa0luaGVyaXRUcmVlKHRoaXMuY29uc3RydWN0b3IsICdfZXZlbnRzJywgdHJ1ZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgc2VsZi5vbi5hcHBseShzZWxmLCBldmVudCk7CiAgICB9KTsKICAgIHdhbGtJbmhlcml0VHJlZSh0aGlzLCAnZXZlbnRzJywgZmFsc2UsIGZ1bmN0aW9uKGhhbmRsZXIsIGV2ZW50TmFtZSkgewogICAgICBzZWxmLm9uKGV2ZW50TmFtZSwgaGFuZGxlciwgc2VsZik7CiAgICB9KTsKICB9Cn07CgpfLmV4dGVuZChUaG9yYXguVmlldywgewogIG9uOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKCiAgICBpZiAob2JqZWN0RXZlbnRzKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2spKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBoYW5kbGVyfSkKICAgIGlmIChfLmlzT2JqZWN0KGV2ZW50TmFtZSkpIHsKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSk7CiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IFtoYW5kbGVyLCBoYW5kbGVyXX0pCiAgICAgIGlmIChfLmlzQXJyYXkoY2FsbGJhY2spKSB7CiAgICAgICAgXy5lYWNoKGNhbGxiYWNrLCBmdW5jdGlvbihjYikgewogICAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2JdKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgaGFuZGxlcikKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMucHVzaChbZXZlbnROYW1lLCBjYWxsYmFja10pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9Cn0pOwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgb246IGZ1bmN0aW9uKGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgIGlmIChvYmplY3RFdmVudHModGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgaWYgKF8uaXNPYmplY3QoZXZlbnROYW1lKSAmJiBhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICAvL2FjY2VwdCBvbih7InJlbmRlcmVkIjogY2FsbGJhY2t9KQogICAgICBfLmVhY2goZXZlbnROYW1lLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgdGhpcy5vbihrZXksIHZhbHVlLCBjYWxsYmFjayB8fCB0aGlzKTsgICAgLy8gY2FsbGJhY2sgaXMgY29udGV4dCBpbiB0aGlzIGZvcm0gb2YgdGhlIGNhbGwKICAgICAgfSwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICAvL2FjY2VwdCBvbigicmVuZGVyZWQiLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgLy9hY2NlcHQgb24oImNsaWNrIGEiLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgXy5lYWNoKChfLmlzQXJyYXkoY2FsbGJhY2spID8gY2FsbGJhY2sgOiBbY2FsbGJhY2tdKSwgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YXIgcGFyYW1zID0gZXZlbnRQYXJhbXNGcm9tRXZlbnRJdGVtLmNhbGwodGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCB8fCB0aGlzKTsKICAgICAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdET00nKSB7CiAgICAgICAgICAvL3dpbGwgY2FsbCBfYWRkRXZlbnQgZHVyaW5nIGRlbGVnYXRlRXZlbnRzKCkKICAgICAgICAgIGlmICghdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSkgewogICAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlID0gW107CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlLnB1c2gocGFyYW1zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fYWRkRXZlbnQocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgIGlmIChldmVudHMpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihldmVudHMpKSB7CiAgICAgICAgZXZlbnRzID0gZXZlbnRzLmNhbGwodGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICB0aGlzLm9uKGV2ZW50cyk7CiAgICB9CiAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlICYmIF8uZWFjaCh0aGlzLl9ldmVudHNUb0RlbGVnYXRlLCB0aGlzLl9hZGRFdmVudCwgdGhpcyk7CiAgfSwKICAvL3BhcmFtcyBtYXkgY29udGFpbjoKICAvLy0gbmFtZQogIC8vLSBvcmlnaW5hbE5hbWUKICAvLy0gc2VsZWN0b3IKICAvLy0gdHlwZSAidmlldyIgfHwgIkRPTSIKICAvLy0gaGFuZGxlcgogIF9hZGRFdmVudDogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICBpZiAocGFyYW1zLnR5cGUgPT09ICd2aWV3JykgewogICAgICBfLmVhY2gocGFyYW1zLm5hbWUuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgX29uLmNhbGwodGhpcywgbmFtZSwgYmluZEV2ZW50SGFuZGxlci5jYWxsKHRoaXMsICd2aWV3LWV2ZW50OicsIHBhcmFtcykpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBib3VuZEhhbmRsZXIgPSBiaW5kRXZlbnRIYW5kbGVyLmNhbGwodGhpcywgJ2RvbS1ldmVudDonLCBwYXJhbXMpOwogICAgICBpZiAoIXBhcmFtcy5uZXN0ZWQpIHsKICAgICAgICBib3VuZEhhbmRsZXIgPSBjb250YWluSGFuZGxlclRvQ3VyZW50Vmlldyhib3VuZEhhbmRsZXIsIHRoaXMuY2lkKTsKICAgICAgfQogICAgICBpZiAocGFyYW1zLnNlbGVjdG9yKSB7CiAgICAgICAgdmFyIG5hbWUgPSBwYXJhbXMubmFtZSArICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgdGhpcy4kZWwub24obmFtZSwgcGFyYW1zLnNlbGVjdG9yLCBib3VuZEhhbmRsZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJGVsLm9uKHBhcmFtcy5uYW1lLCBib3VuZEhhbmRsZXIpOwogICAgICB9CiAgICB9CiAgfQp9KTsKCi8vIFdoZW4gdmlldyBpcyByZWFkeSB0cmlnZ2VyIHJlYWR5IGV2ZW50IG9uIGFsbAovLyBjaGlsZHJlbiB0aGF0IGFyZSBwcmVzZW50LCB0aGVuIHJlZ2lzdGVyIGFuCi8vIGV2ZW50IHRoYXQgd2lsbCB0cmlnZ2VyIHJlYWR5IG9uIG5ldyBjaGlsZHJlbgovLyB3aGVuIHRoZXkgYXJlIGFkZGVkClRob3JheC5WaWV3Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAoIXRoaXMuX2lzUmVhZHkpIHsKICAgIHRoaXMuX2lzUmVhZHkgPSB0cnVlOwogICAgZnVuY3Rpb24gdHJpZ2dlclJlYWR5T25DaGlsZChjaGlsZCkgewogICAgICBjaGlsZC50cmlnZ2VyKCdyZWFkeScsIG9wdGlvbnMpOwogICAgfQogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIHRyaWdnZXJSZWFkeU9uQ2hpbGQpOwogICAgdGhpcy5vbignY2hpbGQnLCB0cmlnZ2VyUmVhZHlPbkNoaWxkKTsKICB9Cn0pOwoKdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXihuZXN0ZWRccyspPyhcUyspKD86XHMrKC4rKSk/LzsKCnZhciBkb21FdmVudHMgPSBbXSwKICAgIGRvbUV2ZW50UmVnZXhwOwpmdW5jdGlvbiBwdXNoRG9tRXZlbnRzKGV2ZW50cykgewogIGRvbUV2ZW50cy5wdXNoLmFwcGx5KGRvbUV2ZW50cywgZXZlbnRzKTsKICBkb21FdmVudFJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14obmVzdGVkXFxzKyk/KCcgKyBkb21FdmVudHMuam9pbignfCcpICsgJykoPzpcXHN8JCknKTsKfQpwdXNoRG9tRXZlbnRzKFsKICAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsCiAgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAndG91Y2htb3ZlJywKICAnY2xpY2snLCAnZGJsY2xpY2snLAogICdrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJywKICAnc3VibWl0JywgJ2NoYW5nZScsCiAgJ2ZvY3VzJywgJ2JsdXInCl0pOwoKZnVuY3Rpb24gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoaGFuZGxlciwgY2lkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdmlldyA9ICQoZXZlbnQudGFyZ2V0KS52aWV3KHtoZWxwZXI6IGZhbHNlfSk7CiAgICBpZiAodmlldyAmJiB2aWV3LmNpZCA9PT0gY2lkKSB7CiAgICAgIGV2ZW50Lm9yaWdpbmFsQ29udGV4dCA9IHRoaXM7CiAgICAgIGhhbmRsZXIoZXZlbnQpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIGJpbmRFdmVudEhhbmRsZXIoZXZlbnROYW1lLCBwYXJhbXMpIHsKICBldmVudE5hbWUgKz0gcGFyYW1zLm9yaWdpbmFsTmFtZTsKCiAgdmFyIGNhbGxiYWNrID0gcGFyYW1zLmhhbmRsZXIsCiAgICAgIG1ldGhvZCA9IF8uaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayA6IHRoaXNbY2FsbGJhY2tdOwogIGlmICghbWV0aG9kKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0V2ZW50ICInICsgY2FsbGJhY2sgKyAnIiBkb2VzIG5vdCBleGlzdCAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkgKyAnOicgKyBldmVudE5hbWUpOwogIH0KICByZXR1cm4gXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgdHJ5IHsKICAgICAgbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIFRob3JheC5vbkV4Y2VwdGlvbigndGhvcmF4LWV4Y2VwdGlvbjogJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJzonICsgZXZlbnROYW1lLCBlKTsKICAgIH0KICB9LCBwYXJhbXMuY29udGV4dCB8fCB0aGlzKTsKfQoKZnVuY3Rpb24gZXZlbnRQYXJhbXNGcm9tRXZlbnRJdGVtKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICB2YXIgcGFyYW1zID0gewogICAgb3JpZ2luYWxOYW1lOiBuYW1lLAogICAgaGFuZGxlcjogXy5pc1N0cmluZyhoYW5kbGVyKSA/IHRoaXNbaGFuZGxlcl0gOiBoYW5kbGVyCiAgfTsKICBpZiAobmFtZS5tYXRjaChkb21FdmVudFJlZ2V4cCkpIHsKICAgIHZhciBtYXRjaCA9IGV2ZW50U3BsaXR0ZXIuZXhlYyhuYW1lKTsKICAgIHBhcmFtcy5uZXN0ZWQgPSAhIW1hdGNoWzFdOwogICAgcGFyYW1zLm5hbWUgPSBtYXRjaFsyXTsKICAgIHBhcmFtcy50eXBlID0gJ0RPTSc7CiAgICBwYXJhbXMuc2VsZWN0b3IgPSBtYXRjaFszXTsKICB9IGVsc2UgewogICAgcGFyYW1zLm5hbWUgPSBuYW1lOwogICAgcGFyYW1zLnR5cGUgPSAndmlldyc7CiAgfQogIHBhcmFtcy5jb250ZXh0ID0gY29udGV4dDsKICByZXR1cm4gcGFyYW1zOwp9Cgo7OwovKmdsb2JhbCBnZXRPcHRpb25zRGF0YSwgdmlld0hlbHBlckF0dHJpYnV0ZU5hbWUgKi8KdmFyIHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LXRtcCcsCiAgICB2aWV3VGVtcGxhdGVPdmVycmlkZXMgPSB7fTsKCi8vIFdpbGwgYmUgc2hhcmVkIGJ5IEhlbHBlclZpZXcgYW5kIENvbGxlY3Rpb25IZWxwZXJWaWV3CnZhciBoZWxwZXJWaWV3UHJvdG90eXBlID0gewogIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIFRob3JheC5WaWV3LnByb3RvdHlwZS5fZW5zdXJlRWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy4kZWwuYXR0cih2aWV3SGVscGVyQXR0cmlidXRlTmFtZSwgdGhpcy5faGVscGVyTmFtZSk7CiAgfSwKICBfZ2V0Q29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5wYXJlbnQuX2dldENvbnRleHQuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgfQp9OwoKVGhvcmF4LkhlbHBlclZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoaGVscGVyVmlld1Byb3RvdHlwZSk7CgovLyBFbnN1cmUgbmVzdGVkIGlubGluZSBoZWxwZXJzIHdpbGwgYWx3YXlzIGhhdmUgdGhpcy5wYXJlbnQKLy8gc2V0IHRvIHRoZSB2aWV3IGNvbnRhaW5pbmcgdGhlIHRlbXBsYXRlCmZ1bmN0aW9uIGdldFBhcmVudChwYXJlbnQpIHsKICAvLyBUaGUgYHZpZXdgIGhlbHBlciBpcyBhIHNwZWNpYWwgY2FzZSBhcyBpdCBlbWJlZHMKICAvLyBhIHZpZXcgaW5zdGVhZCBvZiBjcmVhdGluZyBhIG5ldyBvbmUKICB3aGlsZSAocGFyZW50Ll9oZWxwZXJOYW1lICYmIHBhcmVudC5faGVscGVyTmFtZSAhPT0gJ3ZpZXcnKSB7CiAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50OwogIH0KICByZXR1cm4gcGFyZW50Owp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlciA9IGZ1bmN0aW9uKG5hbWUsIFZpZXdDbGFzcywgY2FsbGJhY2spIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgIGNhbGxiYWNrID0gVmlld0NsYXNzLmNhbGxiYWNrOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBWaWV3Q2xhc3M7CiAgICAgIFZpZXdDbGFzcyA9IFRob3JheC5IZWxwZXJWaWV3OwogICAgfQogIH0KICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgICBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgIHRlbXBsYXRlOiBvcHRpb25zLmZuIHx8IEhhbmRsZWJhcnMuVk0ubm9vcCwKICAgICAgaW52ZXJzZTogb3B0aW9ucy5pbnZlcnNlLAogICAgICBvcHRpb25zOiBvcHRpb25zLmhhc2gsCiAgICAgIGRlY2xhcmluZ1ZpZXc6IGRlY2xhcmluZ1ZpZXcsCiAgICAgIHBhcmVudDogZ2V0UGFyZW50KGRlY2xhcmluZ1ZpZXcpLAogICAgICBfaGVscGVyTmFtZTogbmFtZSwKICAgICAgX2hlbHBlck9wdGlvbnM6IHsKICAgICAgICBvcHRpb25zOiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucyksCiAgICAgICAgYXJnczogXy5jbG9uZShhcmdzKQogICAgICB9CiAgICB9OwoKICAgIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgICBfLmV4dGVuZCh2aWV3T3B0aW9ucywgXy5waWNrKG9wdGlvbnMuaGFzaCwgaHRtbEF0dHJpYnV0ZXNUb0NvcHkpKTsKCiAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhbiBleGlzdGluZyBpbnN0YW5jZSB0aGF0IHdlIGNhbiByZXVzZQogICAgdmFyIGluc3RhbmNlID0gXy5maW5kKGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuIGNvbXBhcmVIZWxwZXJPcHRpb25zKHZpZXdPcHRpb25zLCBjaGlsZCk7CiAgICB9KTsKCiAgICAvLyBDcmVhdGUgdGhlIGluc3RhbmNlIGlmIHdlIGRvbid0IGFscmVhZHkgaGF2ZSBvbmUKICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgICAgaW5zdGFuY2UgPSBWaWV3Q2xhc3MuZmFjdG9yeShhcmdzLCB2aWV3T3B0aW9ucyk7CiAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgaW5zdGFuY2UuX2hlbHBlck5hbWUgPSB2aWV3T3B0aW9ucy5faGVscGVyTmFtZTsKICAgICAgICBpbnN0YW5jZS5faGVscGVyT3B0aW9ucyA9IHZpZXdPcHRpb25zLl9oZWxwZXJPcHRpb25zOwogICAgICB9IGVsc2UgewogICAgICAgIGluc3RhbmNlID0gbmV3IFZpZXdDbGFzcyh2aWV3T3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIGFyZ3MucHVzaChpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyJywgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICBkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMgPSBfLndpdGhvdXQoZGVjbGFyaW5nVmlldy5fcHJldmlvdXNIZWxwZXJzLCBpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuY2hpbGRyZW5baW5zdGFuY2UuY2lkXSA9IGluc3RhbmNlOwogICAgfQoKICAgIHZhciBodG1sQXR0cmlidXRlcyA9IF8ucGljayhvcHRpb25zLmhhc2gsIGh0bWxBdHRyaWJ1dGVzVG9Db3B5KTsKICAgIGh0bWxBdHRyaWJ1dGVzW3ZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gaW5zdGFuY2UuY2lkOwoKICAgIHZhciBleHBhbmRUb2tlbnMgPSBvcHRpb25zLmhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICAgIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhodG1sQXR0cmlidXRlcywgJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7CiAgfSk7CiAgdmFyIGhlbHBlciA9IEhhbmRsZWJhcnMuaGVscGVyc1tuYW1lXTsKICByZXR1cm4gaGVscGVyOwp9OwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyB2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgcGxhY2Vob2xkZXJJZCA9IGVsLmdldEF0dHJpYnV0ZSh2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICB2aWV3ID0gdGhpcy5jaGlsZHJlbltwbGFjZWhvbGRlcklkXTsKICAgIGlmICh2aWV3KSB7CiAgICAgIC8vc2VlIGlmIHRoZSB2aWV3IGhlbHBlciBkZWNsYXJlZCBhbiBvdmVycmlkZSBmb3IgdGhlIHZpZXcKICAgICAgLy9pZiBub3QsIGVuc3VyZSB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZCBhdCBsZWFzdCBvbmNlCiAgICAgIGlmICh2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pIHsKICAgICAgICB2aWV3LnJlbmRlcih2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pOwogICAgICAgIGRlbGV0ZSB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICB9CiAgICAgICQoZWwpLnJlcGxhY2VXaXRoKHZpZXcuZWwpOwogICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh2aWV3LmVsKTsKICAgIH0KICB9LCB0aGlzKTsKfSk7CgoKLyoqCiAqIENsb25lcyB0aGUgaGVscGVyIG9wdGlvbnMsIGRyb3BwaW5nIGl0ZW1zIHRoYXQgYXJlIGtub3duIHRvIGNoYW5nZQogKiBiZXR3ZWVuIHJlbmRlcmluZyBjeWNsZXMgYXMgYXBwcm9wcmlhdGUuCiAqLwpmdW5jdGlvbiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucykgewogIHZhciByZXQgPSBfLnBpY2sob3B0aW9ucywgJ2ZuJywgJ2ludmVyc2UnLCAnaGFzaCcsICdkYXRhJyk7CiAgcmV0LmRhdGEgPSBfLm9taXQob3B0aW9ucy5kYXRhLCAnY2lkJywgJ3ZpZXcnLCAneWllbGQnKTsKICByZXR1cm4gcmV0Owp9CgovKioKICogQ2hlY2tzIGZvciBiYXNpYyBlcXVhbGl0eSBiZXR3ZWVuIHR3byBzZXRzIG9mIHBhcmFtZXRlcnMgZm9yIGEgaGVscGVyIHZpZXcuCiAqCiAqIENoZWNrZWQgZmllbGRzIGluY2x1ZGU6CiAqICAtIF9oZWxwZXJOYW1lCiAqICAtIEFsbCBhcmdzCiAqICAtIEhhc2gKICogIC0gRGF0YQogKiAgLSBGdW5jdGlvbiBhbmQgSW52ZXJ0IChpZCBiYXNlZCBpZiBwb3NzaWJsZSkKICoKICogVGhpcyBtZXRob2QgYWxsb3dzIHVzIHRvIGRldGVybWluZSBpZiB0aGUgaW5wdXRzIHRvIGEgZ2l2ZW4gdmlldyBhcmUgdGhlIHNhbWUuIElmIHRoZXkKICogYXJlIHRoZW4gd2UgbWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSByZW5kZXJpbmcgd2lsbCBiZSB0aGUgc2FtZSAob3IgdGhlIGNoaWxkIHZpZXcgd2lsbAogKiBvdGhlcndpc2UgcmVyZW5kZXJpbmcgaXQgYnkgbW9uaXRvcmluZyBpdCdzIHBhcmFtZXRlcnMgYXMgbmVjZXNzYXJ5KSBhbmQgcmV1c2UgdGhlIHZpZXcgb24KICogcmVyZW5kZXIgb2YgdGhlIHBhcmVudCB2aWV3LgogKi8KZnVuY3Rpb24gY29tcGFyZUhlbHBlck9wdGlvbnMoYSwgYikgewogIGZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYikgewogICAgcmV0dXJuIF8uZXZlcnkoYSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXR1cm4gYltrZXldID09PSB2YWx1ZTsKICAgIH0pOwogIH0KCiAgaWYgKGEuX2hlbHBlck5hbWUgIT09IGIuX2hlbHBlck5hbWUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGEgPSBhLl9oZWxwZXJPcHRpb25zOwogIGIgPSBiLl9oZWxwZXJPcHRpb25zOwoKICAvLyBJbXBsZW1lbnRzIGEgZmlyc3QgbGV2ZWwgZGVwdGggY29tcGFyaXNvbgogIHJldHVybiBhLmFyZ3MubGVuZ3RoID09PSBiLmFyZ3MubGVuZ3RoCiAgICAgICYmIGNvbXBhcmVWYWx1ZXMoYS5hcmdzLCBiLmFyZ3MpCiAgICAgICYmIF8uaXNFcXVhbChfLmtleXMoYS5vcHRpb25zKSwgXy5rZXlzKGIub3B0aW9ucykpCiAgICAgICYmIF8uZXZlcnkoYS5vcHRpb25zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnZGF0YScgfHwga2V5ID09PSAnaGFzaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXMoYS5vcHRpb25zW2tleV0sIGIub3B0aW9uc1trZXldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZm4nIHx8IGtleSA9PT0gJ2ludmVyc2UnKSB7CiAgICAgICAgICAgIHJldHVybiBiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWUKICAgICAgICAgICAgICAgIHx8ICh2YWx1ZSAmJiBfLmhhcyh2YWx1ZSwgJ3Byb2dyYW0nKSAmJiAoKGIub3B0aW9uc1trZXldIHx8IHt9KS5wcm9ncmFtID09PSB2YWx1ZS5wcm9ncmFtKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYi5vcHRpb25zW2tleV0gPT09IHZhbHVlOwogICAgICAgIH0pOwp9Cgo7OwovKmdsb2JhbCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMsIHdhbGtJbmhlcml0VHJlZSAqLwoKZnVuY3Rpb24gZGF0YU9iamVjdCh0eXBlLCBzcGVjKSB7CiAgc3BlYyA9IGluaGVyaXRWYXJzW3R5cGVdID0gXy5kZWZhdWx0cyh7CiAgICBuYW1lOiAnXycgKyB0eXBlICsgJ0V2ZW50cycsCiAgICBldmVudDogdHJ1ZQogIH0sIHNwZWMpOwoKICAvLyBBZGQgYSBjYWxsYmFjayBpbiB0aGUgdmlldyBjb25zdHJ1Y3RvcgogIHNwZWMuY3RvciA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXNbdHlwZV0pIHsKICAgICAgLy8gTmVlZCB0byBudWxsIHRoaXMubW9kZWwvY29sbGVjdGlvbiBzbyBzZXRNb2RlbC9Db2xsZWN0aW9uIHdpbGwKICAgICAgLy8gbm90IHRyZWF0IGl0IGFzIHRoZSBvbGQgbW9kZWwvY29sbGVjdGlvbiBhbmQgaW1tZWRpYXRlbHkgcmV0dXJuCiAgICAgIHZhciBvYmplY3QgPSB0aGlzW3R5cGVdOwogICAgICB0aGlzW3R5cGVdID0gbnVsbDsKICAgICAgdGhpc1tzcGVjLnNldF0ob2JqZWN0KTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiBzZXRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgdmFyIG9sZCA9IHRoaXNbdHlwZV0sCiAgICAgICAgJGVsID0gZ2V0VmFsdWUodGhpcywgc3BlYy4kZWwpOwoKICAgIGlmIChkYXRhT2JqZWN0ID09PSBvbGQpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBpZiAob2xkKSB7CiAgICAgIHRoaXMudW5iaW5kRGF0YU9iamVjdChvbGQpOwogICAgfQoKICAgIGlmIChkYXRhT2JqZWN0KSB7CiAgICAgIHRoaXNbdHlwZV0gPSBkYXRhT2JqZWN0OwoKICAgICAgaWYgKHNwZWMubG9hZGluZykgewogICAgICAgIHNwZWMubG9hZGluZy5jYWxsKHRoaXMpOwogICAgICB9CgogICAgICB0aGlzLmJpbmREYXRhT2JqZWN0KHR5cGUsIGRhdGFPYmplY3QsIF8uZXh0ZW5kKHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpKTsKICAgICAgJGVsICYmICRlbC5hdHRyKHNwZWMuY2lkQXR0ck5hbWUsIGRhdGFPYmplY3QuY2lkKTsKICAgICAgZGF0YU9iamVjdC50cmlnZ2VyKCdzZXQnLCBkYXRhT2JqZWN0LCBvbGQpOwogICAgfSBlbHNlIHsKICAgICAgdGhpc1t0eXBlXSA9IGZhbHNlOwogICAgICBpZiAoc3BlYy5jaGFuZ2UpIHsKICAgICAgICBzcGVjLmNoYW5nZS5jYWxsKHRoaXMsIGZhbHNlKTsKICAgICAgfQogICAgICAkZWwgJiYgJGVsLnJlbW92ZUF0dHIoc3BlYy5jaWRBdHRyTmFtZSk7CiAgICB9CiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTpkYXRhLW9iamVjdCcsIHR5cGUsIGRhdGFPYmplY3QsIG9sZCk7CiAgICByZXR1cm4gdGhpczsKICB9CgogIFRob3JheC5WaWV3LnByb3RvdHlwZVtzcGVjLnNldF0gPSBzZXRPYmplY3Q7Cn0KCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIGJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbih0eXBlLCBkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICBpZiAodGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdID0gZGF0YU9iamVjdDsKCiAgICB2YXIgb3B0aW9ucyA9IHRoaXMuX21vZGlmeURhdGFPYmplY3RPcHRpb25zKGRhdGFPYmplY3QsIF8uZXh0ZW5kKHt9LCBpbmhlcml0VmFyc1t0eXBlXS5kZWZhdWx0T3B0aW9ucywgb3B0aW9ucykpOwogICAgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2RhdGFPYmplY3QuY2lkXSA9IG9wdGlvbnM7CgogICAgYmluZEV2ZW50cy5jYWxsKHRoaXMsIHR5cGUsIGRhdGFPYmplY3QsIHRoaXMuY29uc3RydWN0b3IpOwogICAgYmluZEV2ZW50cy5jYWxsKHRoaXMsIHR5cGUsIGRhdGFPYmplY3QsIHRoaXMpOwoKICAgIHZhciBzcGVjID0gaW5oZXJpdFZhcnNbdHlwZV07CiAgICBzcGVjLmJpbmRDYWxsYmFjayAmJiBzcGVjLmJpbmRDYWxsYmFjay5jYWxsKHRoaXMsIGRhdGFPYmplY3QsIG9wdGlvbnMpOwoKICAgIGlmIChkYXRhT2JqZWN0LnNob3VsZEZldGNoICYmIGRhdGFPYmplY3Quc2hvdWxkRmV0Y2gob3B0aW9ucykpIHsKICAgICAgbG9hZE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKTsKICAgIH0gZWxzZSBpZiAoaW5oZXJpdFZhcnNbdHlwZV0uY2hhbmdlKSB7CiAgICAgIC8vIHdhbnQgdG8gdHJpZ2dlciBidWlsdCBpbiByZW5kZXJpbmcgd2l0aG91dCB0cmlnZ2VyaW5nIGV2ZW50IG9uIG1vZGVsCiAgICAgIGluaGVyaXRWYXJzW3R5cGVdLmNoYW5nZS5jYWxsKHRoaXMsIGRhdGFPYmplY3QsIG9wdGlvbnMpOwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0sCgogIHVuYmluZERhdGFPYmplY3Q6IGZ1bmN0aW9uIChkYXRhT2JqZWN0KSB7CiAgICBpZiAoIXRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZGVsZXRlIHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF07CiAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoZGF0YU9iamVjdCk7CiAgICBkZWxldGUgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2RhdGFPYmplY3QuY2lkXTsKICAgIHJldHVybiB0cnVlOwogIH0sCgogIF9tb2RpZnlEYXRhT2JqZWN0T3B0aW9uczogZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgcmV0dXJuIG9wdGlvbnM7CiAgfQp9KTsKCmZ1bmN0aW9uIGJpbmRFdmVudHModHlwZSwgdGFyZ2V0LCBzb3VyY2UpIHsKICB2YXIgY29udGV4dCA9IHRoaXM7CiAgd2Fsa0luaGVyaXRUcmVlKHNvdXJjZSwgJ18nICsgdHlwZSArICdFdmVudHMnLCB0cnVlLCBmdW5jdGlvbihldmVudCkgewogICAgLy8gZ2V0RXZlbnRDYWxsYmFjayB3aWxsIHJlc29sdmUgaWYgaXQgaXMgYSBzdHJpbmcgb3IgYSBtZXRob2QKICAgIC8vIGFuZCByZXR1cm4gYSBtZXRob2QKICAgIGNvbnRleHQubGlzdGVuVG8odGFyZ2V0LCBldmVudFswXSwgXy5iaW5kKGdldEV2ZW50Q2FsbGJhY2soZXZlbnRbMV0sIGNvbnRleHQpLCBldmVudFsyXSB8fCBjb250ZXh0KSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGxvYWRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucykgewogIGlmIChkYXRhT2JqZWN0LmxvYWQpIHsKICAgIGRhdGFPYmplY3QubG9hZChmdW5jdGlvbigpIHsKICAgICAgb3B0aW9ucyAmJiBvcHRpb25zLnN1Y2Nlc3MgJiYgb3B0aW9ucy5zdWNjZXNzKGRhdGFPYmplY3QpOwogICAgfSwgb3B0aW9ucyk7CiAgfSBlbHNlIHsKICAgIGRhdGFPYmplY3QuZmV0Y2gob3B0aW9ucyk7CiAgfQp9CgpmdW5jdGlvbiBnZXRFdmVudENhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgaWYgKF8uaXNGdW5jdGlvbihjYWxsYmFjaykpIHsKICAgIHJldHVybiBjYWxsYmFjazsKICB9IGVsc2UgewogICAgcmV0dXJuIGNvbnRleHRbY2FsbGJhY2tdOwogIH0KfQoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBkYXRhT2JqZWN0LCBnZXRWYWx1ZSAqLwp2YXIgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtbW9kZWwtY2lkJzsKClRob3JheC5Nb2RlbCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9LAogIGlzUG9wdWxhdGVkOiBmdW5jdGlvbigpIHsKICAgIC8vIFdlIGFyZSBwb3B1bGF0ZWQgaWYgd2UgaGF2ZSBhdHRyaWJ1dGVzIHNldAogICAgdmFyIGF0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyksCiAgICAgICAgZGVmYXVsdHMgPSBnZXRWYWx1ZSh0aGlzLCAnZGVmYXVsdHMnKSB8fCB7fTsKICAgIGZvciAodmFyIGRlZmF1bHRfa2V5IGluIGRlZmF1bHRzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzW2RlZmF1bHRfa2V5XSAhPSBkZWZhdWx0c1tkZWZhdWx0X2tleV0pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBkZWxldGUgYXR0cmlidXRlc1tkZWZhdWx0X2tleV07CiAgICB9CiAgICB2YXIga2V5cyA9IF8ua2V5cyhhdHRyaWJ1dGVzKTsKICAgIHJldHVybiBrZXlzLmxlbmd0aCA+IDEgfHwgKGtleXMubGVuZ3RoID09PSAxICYmIGtleXNbMF0gIT09IHRoaXMuaWRBdHRyaWJ1dGUpOwogIH0sCiAgc2hvdWxkRmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIC8vIHVybCgpIHdpbGwgdGhyb3cgaWYgbW9kZWwgaGFzIG5vIGB1cmxSb290YCBhbmQgbm8gYGNvbGxlY3Rpb25gCiAgICAvLyBvciBoYXMgYGNvbGxlY3Rpb25gIGFuZCBgY29sbGVjdGlvbmAgaGFzIG5vIGB1cmxgCiAgICB2YXIgdXJsOwogICAgdHJ5IHsKICAgICAgdXJsID0gZ2V0VmFsdWUodGhpcywgJ3VybCcpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHVybCA9IGZhbHNlOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMuZmV0Y2ggJiYgISF1cmwgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9Cn0pOwoKVGhvcmF4Lk1vZGVscyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4Lk1vZGVsLCBUaG9yYXguTW9kZWxzKTsKCmRhdGFPYmplY3QoJ21vZGVsJywgewogIHNldDogJ3NldE1vZGVsJywKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB0cnVlLAogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGVycm9yczogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbk1vZGVsQ2hhbmdlLAogICRlbDogJyRlbCcsCiAgY2lkQXR0ck5hbWU6IG1vZGVsQ2lkQXR0cmlidXRlTmFtZQp9KTsKCmZ1bmN0aW9uIG9uTW9kZWxDaGFuZ2UobW9kZWwpIHsKICB2YXIgbW9kZWxPcHRpb25zID0gbW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW21vZGVsLmNpZF07CiAgLy8gIW1vZGVsT3B0aW9ucyB3aWxsIGJlIHRydWUgd2hlbiBzZXRNb2RlbChmYWxzZSkgaXMgY2FsbGVkCiAgaWYgKCFtb2RlbE9wdGlvbnMgfHwgKG1vZGVsT3B0aW9ucyAmJiBtb2RlbE9wdGlvbnMucmVuZGVyKSkgewogICAgdGhpcy5yZW5kZXIoKTsKICB9Cn0KClRob3JheC5WaWV3Lm9uKHsKICBtb2RlbDogewogICAgZXJyb3I6IGZ1bmN0aW9uKG1vZGVsLCBlcnJvcnMpIHsKICAgICAgaWYgKHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFttb2RlbC5jaWRdLmVycm9ycykgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBlcnJvcnMsIG1vZGVsKTsKICAgICAgfQogICAgfSwKICAgIGNoYW5nZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgb25Nb2RlbENoYW5nZS5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0KICB9Cn0pOwoKJC5mbi5tb2RlbCA9IGZ1bmN0aW9uKHZpZXcpIHsKICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICBtb2RlbEVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICddJyksCiAgICAgIG1vZGVsQ2lkID0gbW9kZWxFbGVtZW50ICYmIG1vZGVsRWxlbWVudC5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSk7CiAgaWYgKG1vZGVsQ2lkKSB7CiAgICB2YXIgdmlldyA9IHZpZXcgfHwgJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcgJiYgdmlldy5tb2RlbCAmJiB2aWV3Lm1vZGVsLmNpZCA9PT0gbW9kZWxDaWQpIHsKICAgICAgcmV0dXJuIHZpZXcubW9kZWwgfHwgZmFsc2U7CiAgICB9CiAgICB2YXIgY29sbGVjdGlvbiA9ICR0aGlzLmNvbGxlY3Rpb24odmlldyk7CiAgICBpZiAoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gY29sbGVjdGlvbi5nZXQobW9kZWxDaWQpOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn07Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIsIGRhdGFPYmplY3QsIGdldEV2ZW50Q2FsbGJhY2ssIGdldFZhbHVlLCBtb2RlbENpZEF0dHJpYnV0ZU5hbWUsIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICovCnZhciBfZmV0Y2ggPSBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5mZXRjaCwKICAgIF9yZXNldCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLnJlc2V0LAogICAgX3JlcGxhY2VIVE1MID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLl9yZXBsYWNlSFRNTCwKICAgIGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1jaWQnLAogICAgY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tZW1wdHknLAogICAgY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1lbGVtZW50JywKICAgIEVMRU1FTlRfTk9ERV9UWVBFID0gMTsKClRob3JheC5Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewogIG1vZGVsOiBUaG9yYXguTW9kZWwgfHwgQmFja2JvbmUuTW9kZWwsCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2NvbGxlY3Rpb24nKTsKICAgIHJldHVybiBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKICBpc0VtcHR5OiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoID09PSAwICYmIHRoaXMuaXNQb3B1bGF0ZWQoKTsKICAgIH0KICB9LAogIGlzUG9wdWxhdGVkOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9mZXRjaGVkIHx8IHRoaXMubGVuZ3RoID4gMCB8fCAoIXRoaXMubGVuZ3RoICYmICFnZXRWYWx1ZSh0aGlzLCAndXJsJykpOwogIH0sCiAgc2hvdWxkRmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBvcHRpb25zLmZldGNoICYmICEhZ2V0VmFsdWUodGhpcywgJ3VybCcpICYmICF0aGlzLmlzUG9wdWxhdGVkKCk7CiAgfSwKICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIHJlc3BvbnNlKSB7CiAgICAgIGNvbGxlY3Rpb24uX2ZldGNoZWQgPSB0cnVlOwogICAgICBzdWNjZXNzICYmIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcG9uc2UpOwogICAgfTsKICAgIHJldHVybiBfZmV0Y2guYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9LAogIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIHRoaXMuX2ZldGNoZWQgPSAhIW1vZGVsczsKICAgIHJldHVybiBfcmVzZXQuY2FsbCh0aGlzLCBtb2RlbHMsIG9wdGlvbnMpOwogIH0KfSk7CgpUaG9yYXguQ29sbGVjdGlvbnMgPSB7fTsKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5Db2xsZWN0aW9uLCBUaG9yYXguQ29sbGVjdGlvbnMpOwoKZGF0YU9iamVjdCgnY29sbGVjdGlvbicsIHsKICBzZXQ6ICdzZXRDb2xsZWN0aW9uJywKICBiaW5kQ2FsbGJhY2s6IG9uU2V0Q29sbGVjdGlvbiwKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB0cnVlLAogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGVycm9yczogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbkNvbGxlY3Rpb25SZXNldCwKICAkZWw6ICdnZXRDb2xsZWN0aW9uRWxlbWVudCcsCiAgY2lkQXR0ck5hbWU6IGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lCn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25WaWV3ID0gVGhvcmF4LlZpZXcuZXh0ZW5kKHsKICBfZGVmYXVsdFRlbXBsYXRlOiBIYW5kbGViYXJzLlZNLm5vb3AsCiAgX2NvbGxlY3Rpb25TZWxlY3RvcjogJ1snICsgY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lICsgJ10nLAogIAogIC8vIHByZXNlcnZlIGNvbGxlY3Rpb24gZWxlbWVudCBpZiBpdCB3YXMgbm90IGNyZWF0ZWQgd2l0aCB7e2NvbGxlY3Rpb259fSBoZWxwZXIKICBfcmVwbGFjZUhUTUw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb24gJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMuY29sbGVjdGlvbi5jaWRdICYmIHRoaXMuX3JlbmRlckNvdW50KSB7CiAgICAgIHZhciBlbGVtZW50OwogICAgICB2YXIgb2xkQ29sbGVjdGlvbkVsZW1lbnQgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIGVsZW1lbnQgPSBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgICAgaWYgKCFvbGRDb2xsZWN0aW9uRWxlbWVudC5hdHRyKCdkYXRhLXZpZXctY2lkJykpIHsKICAgICAgICB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCkucmVwbGFjZVdpdGgob2xkQ29sbGVjdGlvbkVsZW1lbnQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gX3JlcGxhY2VIVE1MLmNhbGwodGhpcywgaHRtbCk7CiAgICB9CiAgfSwKCiAgLy9hcHBlbmRJdGVtKG1vZGVsIFssaW5kZXhdKQogIC8vYXBwZW5kSXRlbShodG1sX3N0cmluZywgaW5kZXgpCiAgLy9hcHBlbmRJdGVtKHZpZXcsIGluZGV4KQogIGFwcGVuZEl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpbmRleCwgb3B0aW9ucykgewogICAgLy9lbXB0eSBpdGVtCiAgICBpZiAoIW1vZGVsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBpdGVtVmlldywKICAgICAgICAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGZpbHRlcjogdHJ1ZQogICAgfSk7CiAgICAvL2lmIGluZGV4IGFyZ3VtZW50IGlzIGEgdmlldwogICAgaW5kZXggJiYgaW5kZXguZWwgJiYgKGluZGV4ID0gJGVsLmNoaWxkcmVuKCkuaW5kZXhPZihpbmRleC5lbCkgKyAxKTsKICAgIC8vaWYgYXJndW1lbnQgaXMgYSB2aWV3LCBvciBodG1sIHN0cmluZwogICAgaWYgKG1vZGVsLmVsIHx8IF8uaXNTdHJpbmcobW9kZWwpKSB7CiAgICAgIGl0ZW1WaWV3ID0gbW9kZWw7CiAgICAgIG1vZGVsID0gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICBpbmRleCA9IGluZGV4IHx8IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSB8fCAwOwogICAgICBpdGVtVmlldyA9IHRoaXMucmVuZGVySXRlbShtb2RlbCwgaW5kZXgpOwogICAgfQogICAgaWYgKGl0ZW1WaWV3KSB7CiAgICAgIGl0ZW1WaWV3LmNpZCAmJiB0aGlzLl9hZGRDaGlsZChpdGVtVmlldyk7CiAgICAgIC8vaWYgdGhlIHJlbmRlcmVyJ3Mgb3V0cHV0IHdhc24ndCBjb250YWluZWQgaW4gYSB0YWcsIHdyYXAgaXQgaW4gYSBkaXYKICAgICAgLy9wbGFpbiB0ZXh0LCBvciBhIG1peHR1cmUgb2YgdG9wIGxldmVsIHRleHQgbm9kZXMgYW5kIGVsZW1lbnQgbm9kZXMKICAgICAgLy93aWxsIGdldCB3cmFwcGVkCiAgICAgIGlmIChfLmlzU3RyaW5nKGl0ZW1WaWV3KSAmJiAhaXRlbVZpZXcubWF0Y2goL15ccyo8L20pKSB7CiAgICAgICAgaXRlbVZpZXcgPSAnPGRpdj4nICsgaXRlbVZpZXcgKyAnPC9kaXY+JzsKICAgICAgfQogICAgICB2YXIgaXRlbUVsZW1lbnQgPSBpdGVtVmlldy5lbCA/IFtpdGVtVmlldy5lbF0gOiBfLmZpbHRlcigkKGl0ZW1WaWV3KSwgZnVuY3Rpb24obm9kZSkgewogICAgICAgIC8vZmlsdGVyIG91dCB0b3AgbGV2ZWwgd2hpdGVzcGFjZSBub2RlcwogICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREVfVFlQRTsKICAgICAgfSk7CiAgICAgIG1vZGVsICYmICQoaXRlbUVsZW1lbnQpLmF0dHIobW9kZWxDaWRBdHRyaWJ1dGVOYW1lLCBtb2RlbC5jaWQpOwogICAgICB2YXIgcHJldmlvdXNNb2RlbCA9IGluZGV4ID4gMCA/IHRoaXMuY29sbGVjdGlvbi5hdChpbmRleCAtIDEpIDogZmFsc2U7CiAgICAgIGlmICghcHJldmlvdXNNb2RlbCkgewogICAgICAgICRlbC5wcmVwZW5kKGl0ZW1FbGVtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvL3VzZSBsYXN0KCkgYXMgYXBwZW5kSXRlbSBjYW4gYWNjZXB0IG11bHRpcGxlIG5vZGVzIGZyb20gYSB0ZW1wbGF0ZQogICAgICAgIHZhciBsYXN0ID0gJGVsLmZpbmQoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIHByZXZpb3VzTW9kZWwuY2lkICsgJyJdJykubGFzdCgpOwogICAgICAgIGxhc3QuYWZ0ZXIoaXRlbUVsZW1lbnQpOwogICAgICB9CgogICAgICB0aGlzLnRyaWdnZXIoJ2FwcGVuZCcsIG51bGwsIGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgZWwuc2V0QXR0cmlidXRlKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgfSk7CgogICAgICAhb3B0aW9ucy5zaWxlbnQgJiYgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDppdGVtJywgdGhpcywgdGhpcy5jb2xsZWN0aW9uLCBtb2RlbCwgaXRlbUVsZW1lbnQsIGluZGV4KTsKICAgICAgb3B0aW9ucy5maWx0ZXIgJiYgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfQogICAgcmV0dXJuIGl0ZW1WaWV3OwogIH0sCiAgLy/CoHVwZGF0ZUl0ZW0gb25seSB1c2VmdWwgaWYgdGhlcmUgaXMgbm8gaXRlbSB2aWV3LCBvdGhlcndpc2UKICAvL8KgaXRlbVZpZXcucmVuZGVyKCkgcHJvdmlkZXMgdGhlIHNhbWUgZnVuY3Rpb25hbGl0eQogIHVwZGF0ZUl0ZW06IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB0aGlzLnJlbW92ZUl0ZW0obW9kZWwpOwogICAgdGhpcy5hcHBlbmRJdGVtKG1vZGVsKTsKICB9LAogIHJlbW92ZUl0ZW06IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpLAogICAgICAgIHZpZXdFbCA9ICRlbC5maW5kKCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICc9IicgKyBtb2RlbC5jaWQgKyAnIl0nKTsKICAgIGlmICghdmlld0VsLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2aWV3RWwucmVtb3ZlKCk7CiAgICB2YXIgdmlld0NpZCA9IHZpZXdFbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lKSwKICAgICAgICBjaGlsZCA9IHRoaXMuY2hpbGRyZW5bdmlld0NpZF07CiAgICBpZiAoY2hpbGQpIHsKICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICBjaGlsZC5kZXN0cm95KCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIHJlbmRlckNvbGxlY3Rpb246IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuY29sbGVjdGlvbikgewogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uLmlzRW1wdHkoKSkgewogICAgICAgIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaSkgewogICAgICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGkpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcigncmVuZGVyZWQ6Y29sbGVjdGlvbicsIHRoaXMsIHRoaXMuY29sbGVjdGlvbik7CiAgICAgIGFwcGx5VmlzaWJpbGl0eUZpbHRlci5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgZW1wdHlDbGFzczogJ2VtcHR5JywKICByZW5kZXJFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSAmJiAhdGhpcy5lbXB0eVZpZXcpIHsKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAnZW1wdHlUZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctZW1wdHknLAogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLmVtcHR5VmlldykgewogICAgICB2YXIgdmlld09wdGlvbnMgPSB7fTsKICAgICAgaWYgKHRoaXMuZW1wdHlUZW1wbGF0ZSkgewogICAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gdGhpcy5lbXB0eVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuZW1wdHlWaWV3LCB2aWV3T3B0aW9ucyk7CiAgICAgIHZpZXcuZW5zdXJlUmVuZGVyZWQoKTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5lbXB0eVRlbXBsYXRlICYmIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5lbXB0eVRlbXBsYXRlKTsKICAgIH0KICB9LAogIHJlbmRlckl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpKSB7CiAgICBpZiAoIXRoaXMuaXRlbVRlbXBsYXRlICYmICF0aGlzLml0ZW1WaWV3KSB7CiAgICAgIGFzc2lnblRlbXBsYXRlLmNhbGwodGhpcywgJ2l0ZW1UZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctaXRlbScsCiAgICAgICAgLy8gb25seSByZXF1aXJlIGFuIGl0ZW1UZW1wbGF0ZSBpZiBhbiBpdGVtVmlldwogICAgICAgIC8vIGlzIG5vdCBwcmVzZW50CiAgICAgICAgcmVxdWlyZWQ6ICF0aGlzLml0ZW1WaWV3CiAgICAgIH0pOwogICAgfQogICAgaWYgKHRoaXMuaXRlbVZpZXcpIHsKICAgICAgdmFyIHZpZXdPcHRpb25zID0gewogICAgICAgIG1vZGVsOiBtb2RlbAogICAgICB9OwogICAgICBpZiAodGhpcy5pdGVtVGVtcGxhdGUpIHsKICAgICAgICB2aWV3T3B0aW9ucy50ZW1wbGF0ZSA9IHRoaXMuaXRlbVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuaXRlbVZpZXcsIHZpZXdPcHRpb25zKTsKICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLnJlbmRlclRlbXBsYXRlKHRoaXMuaXRlbVRlbXBsYXRlLCB0aGlzLml0ZW1Db250ZXh0KG1vZGVsLCBpKSk7CiAgICB9CiAgfSwKICBpdGVtQ29udGV4dDogZnVuY3Rpb24obW9kZWwgLyosIGkgKi8pIHsKICAgIHJldHVybiBtb2RlbC5hdHRyaWJ1dGVzOwogIH0sCiAgYXBwZW5kRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICRlbC5lbXB0eSgpOwogICAgdmFyIGVtcHR5Q29udGVudCA9IHRoaXMucmVuZGVyRW1wdHkoKTsKICAgIGVtcHR5Q29udGVudCAmJiB0aGlzLmFwcGVuZEl0ZW0oZW1wdHlDb250ZW50LCAwLCB7CiAgICAgIHNpbGVudDogdHJ1ZSwKICAgICAgZmlsdGVyOiBmYWxzZQogICAgfSk7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOmVtcHR5JywgdGhpcywgdGhpcy5jb2xsZWN0aW9uKTsKICB9LAogIGdldENvbGxlY3Rpb25FbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBlbGVtZW50ID0gdGhpcy4kKHRoaXMuX2NvbGxlY3Rpb25TZWxlY3Rvcik7CiAgICByZXR1cm4gZWxlbWVudC5sZW5ndGggPT09IDAgPyB0aGlzLiRlbCA6IGVsZW1lbnQ7CiAgfQp9KTsKClRob3JheC5Db2xsZWN0aW9uVmlldy5vbih7CiAgY29sbGVjdGlvbjogewogICAgcmVzZXQ6IG9uQ29sbGVjdGlvblJlc2V0LAogICAgc29ydDogb25Db2xsZWN0aW9uUmVzZXQsCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKCkgewogICAgICBhcHBseVZpc2liaWxpdHlGaWx0ZXIuY2FsbCh0aGlzKTsKICAgIH0sCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIC8vIElmIHdlIHJlbmRlcmVkIHdpdGggaXRlbSB2aWV3cywgbW9kZWwgY2hhbmdlcyB3aWxsIGJlIG9ic2VydmVkCiAgICAgIC8vIGJ5IHRoZSBnZW5lcmF0ZWQgaXRlbSB2aWV3IGJ1dCBpZiB3ZSByZW5kZXJlZCB3aXRoIHRlbXBsYXRlcwogICAgICAvLyB0aGVuIG1vZGVsIGNoYW5nZXMgbmVlZCB0byBiZSBib3VuZCBhcyBub3RoaW5nIGlzIHdhdGNoaW5nCiAgICAgICF0aGlzLml0ZW1WaWV3ICYmIHRoaXMudXBkYXRlSXRlbShtb2RlbCk7CiAgICAgIGFwcGx5SXRlbVZpc2libGl0eUZpbHRlci5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDEgJiYgJGVsLmxlbmd0aCAmJiBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5LmNhbGwodGhpcyk7CiAgICAgIGlmICgkZWwubGVuZ3RoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMuYXBwZW5kSXRlbShtb2RlbCwgaW5kZXgpOwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICB0aGlzLnJlbW92ZUl0ZW0obW9kZWwpOwogICAgICB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID09PSAwICYmICRlbC5sZW5ndGggJiYgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0KfSk7CgpUaG9yYXguVmlldy5vbih7CiAgY29sbGVjdGlvbjogewogICAgZXJyb3I6IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIG1lc3NhZ2UpIHsKICAgICAgaWYgKHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtjb2xsZWN0aW9uLmNpZF0uZXJyb3JzKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG1lc3NhZ2UsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIG9uQ29sbGVjdGlvblJlc2V0KGNvbGxlY3Rpb24pIHsKICB2YXIgb3B0aW9ucyA9IGNvbGxlY3Rpb24gJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2NvbGxlY3Rpb24uY2lkXTsKICAvLyB3ZSB3b3VsZCB3YW50IHRvIHN0aWxsIHJlbmRlciBpbiB0aGUgY2FzZSB0aGF0IHRoZQogIC8vIGNvbGxlY3Rpb24gaGFzIHRyYW5zaXRpb25lZCB0byBiZWluZyBmYWxzeQogIGlmICghY29sbGVjdGlvbiB8fCAob3B0aW9ucyAmJiBvcHRpb25zLnJlbmRlcikpIHsKICAgIHRoaXMucmVuZGVyQ29sbGVjdGlvbiAmJiB0aGlzLnJlbmRlckNvbGxlY3Rpb24oKTsKICB9Cn0KCi8vIEV2ZW4gaWYgdGhlIHZpZXcgaXMgbm90IGEgQ29sbGVjdGlvblZpZXcKLy8gZW5zdXJlUmVuZGVyZWQoKSB0byBwcm92aWRlIHNpbWlsYXIgYmVoYXZpb3IKLy8gdG8gYSBtb2RlbApmdW5jdGlvbiBvblNldENvbGxlY3Rpb24oKSB7CiAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwp9CgpmdW5jdGlvbiBhcHBseVZpc2liaWxpdHlGaWx0ZXIoKSB7CiAgaWYgKHRoaXMuaXRlbUZpbHRlcikgewogICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24obW9kZWwpIHsKICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfSwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIobW9kZWwpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuaXRlbUZpbHRlciAmJiAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJylbaXRlbVNob3VsZEJlVmlzaWJsZS5jYWxsKHRoaXMsIG1vZGVsKSA/ICdzaG93JyA6ICdoaWRlJ10oKTsKfQoKZnVuY3Rpb24gaXRlbVNob3VsZEJlVmlzaWJsZShtb2RlbCkgewogIHJldHVybiB0aGlzLml0ZW1GaWx0ZXIobW9kZWwsIHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLnJlbW92ZUNsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLnJlbW92ZUF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSk7CiAgJGVsLmVtcHR5KCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLmFkZENsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLmF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSwgdHJ1ZSk7CiAgdGhpcy5hcHBlbmRFbXB0eSgpOwp9CgovLyQoc2VsZWN0b3IpLmNvbGxlY3Rpb24oKSBoZWxwZXIKJC5mbi5jb2xsZWN0aW9uID0gZnVuY3Rpb24odmlldykgewogIGlmICh2aWV3ICYmIHZpZXcuY29sbGVjdGlvbikgewogICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICB9CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgY29sbGVjdGlvbkVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lICsgJ10nKSwKICAgICAgY29sbGVjdGlvbkNpZCA9IGNvbGxlY3Rpb25FbGVtZW50ICYmIGNvbGxlY3Rpb25FbGVtZW50LmF0dHIoY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChjb2xsZWN0aW9uQ2lkKSB7CiAgICB2aWV3ID0gJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcpIHsKICAgICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgaW5oZXJpdFZhcnMgKi8KCmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCnZhciBvbGRNb2RlbENoYW5nZSA9IGluaGVyaXRWYXJzLm1vZGVsLmNoYW5nZTsKaW5oZXJpdFZhcnMubW9kZWwuY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgb2xkTW9kZWxDaGFuZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAvLyBUT0RPIDogV2hhdCBjYW4gd2UgZG8gdG8gcmVtb3ZlIHRoaXMgZHVwbGljYXRpb24/CiAgdmFyIG1vZGVsT3B0aW9ucyA9IHRoaXMubW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMubW9kZWwuY2lkXTsKICBpZiAobW9kZWxPcHRpb25zICYmIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSkgewogICAgdGhpcy5wb3B1bGF0ZSh0aGlzLm1vZGVsLmF0dHJpYnV0ZXMsIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSA9PT0gdHJ1ZSA/IHt9IDogbW9kZWxPcHRpb25zLnBvcHVsYXRlKTsKICB9Cn07CmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIC8vc2VyaWFsaXplcyBhIGZvcm0gcHJlc2VudCBpbiB0aGUgdmlldywgcmV0dXJuaW5nIHRoZSBzZXJpYWxpemVkIGRhdGEKICAvL2FzIGFuIG9iamVjdAogIC8vcGFzcyB7c2V0OmZhbHNlfSB0byBub3QgdXBkYXRlIHRoaXMubW9kZWwgaWYgcHJlc2VudAogIC8vY2FuIHBhc3Mgb3B0aW9ucywgY2FsbGJhY2sgb3IgZXZlbnQgaW4gYW55IG9yZGVyCiAgc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHZhciBjYWxsYmFjaywgb3B0aW9ucywgZXZlbnQ7CiAgICAvL2lnbm9yZSB1bmRlZmluZWQgYXJndW1lbnRzIGluIGNhc2UgZXZlbnQgd2FzIG51bGwKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oYXJndW1lbnRzW2ldKSkgewogICAgICAgIGNhbGxiYWNrID0gYXJndW1lbnRzW2ldOwogICAgICB9IGVsc2UgaWYgKF8uaXNPYmplY3QoYXJndW1lbnRzW2ldKSkgewogICAgICAgIGlmICgnc3RvcFByb3BhZ2F0aW9uJyBpbiBhcmd1bWVudHNbaV0gJiYgJ3ByZXZlbnREZWZhdWx0JyBpbiBhcmd1bWVudHNbaV0pIHsKICAgICAgICAgIGV2ZW50ID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcHRpb25zID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChldmVudCAmJiAhdGhpcy5fcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb24oZXZlbnQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBvcHRpb25zID0gXy5leHRlbmQoewogICAgICBzZXQ6IHRydWUsCiAgICAgIHZhbGlkYXRlOiB0cnVlLAogICAgICBjaGlsZHJlbjogdHJ1ZSwKICAgICAgc2lsZW50OiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlcyB8fCB7fTsKCiAgICAvL2NhbGxiYWNrIGhhcyBjb250ZXh0IG9mIGVsZW1lbnQKICAgIHZhciB2aWV3ID0gdGhpczsKICAgIHZhciBlcnJvcnMgPSBbXTsKICAgIGVhY2hOYW1lZElucHV0LmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHZpZXcuX2dldElucHV0VmFsdWUodGhpcywgb3B0aW9ucywgZXJyb3JzKTsKICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZS5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIHRoaXMubmFtZSwge21vZGU6ICdzZXJpYWxpemUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG9iamVjdFtrZXldKSkgewogICAgICAgICAgICBvYmplY3Rba2V5XS5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldID0gW29iamVjdFtrZXldLCB2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMudHJpZ2dlcignc2VyaWFsaXplJywgYXR0cmlidXRlcywgb3B0aW9ucyk7CgogICAgaWYgKG9wdGlvbnMudmFsaWRhdGUpIHsKICAgICAgdmFyIHZhbGlkYXRlSW5wdXRFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSW5wdXQoYXR0cmlidXRlcyk7CiAgICAgIGlmICh2YWxpZGF0ZUlucHV0RXJyb3JzICYmIHZhbGlkYXRlSW5wdXRFcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh2YWxpZGF0ZUlucHV0RXJyb3JzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3ZhbGlkYXRlJywgYXR0cmlidXRlcywgZXJyb3JzLCBvcHRpb25zKTsKICAgICAgaWYgKGVycm9ycy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgZXJyb3JzKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0aW9ucy5zZXQgJiYgdGhpcy5tb2RlbCkgewogICAgICBpZiAoIXRoaXMubW9kZWwuc2V0KGF0dHJpYnV0ZXMsIHtzaWxlbnQ6IG9wdGlvbnMuc2lsZW50fSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIF8uYmluZChyZXNldFN1Ym1pdFN0YXRlLCB0aGlzKSk7CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9LAoKICBfcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb246IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjaykgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICB2YXIgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KTsKICAgIGlmICgoZXZlbnQudGFyZ2V0LnRhZ05hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgIT09ICdmb3JtJykgewogICAgICAvLyBIYW5kbGUgbm9uLXN1Ym1pdCBldmVudHMgYnkgZ2F0aW5nIG9uIHRoZSBmb3JtCiAgICAgIGZvcm0gPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgnZm9ybScpOwogICAgfQoKICAgIGlmICghZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JykpIHsKICAgICAgZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JywgJ3RydWUnKTsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLy9wb3B1bGF0ZSBhIGZvcm0gZnJvbSB0aGUgcGFzc2VkIGF0dHJpYnV0ZXMgb3IgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgcG9wdWxhdGU6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgIHZhciB2YWx1ZSwgYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwogICAgLy9jYWxsYmFjayBoYXMgY29udGV4dCBvZiBlbGVtZW50CiAgICBlYWNoTmFtZWRJbnB1dC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uKCkgewogICAgICBvYmplY3RBbmRLZXlGcm9tQXR0cmlidXRlc0FuZE5hbWUuY2FsbCh0aGlzLCBhdHRyaWJ1dGVzLCB0aGlzLm5hbWUsIHttb2RlOiAncG9wdWxhdGUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICBpZiAob2JqZWN0ICYmICFfLmlzVW5kZWZpbmVkKHZhbHVlID0gb2JqZWN0W2tleV0pKSB7CiAgICAgICAgICAvL3dpbGwgb25seSBleGVjdXRlIGlmIHdlIGhhdmUgYSBuYW1lIHRoYXQgbWF0Y2hlcyB0aGUgc3RydWN0dXJlIGluIGF0dHJpYnV0ZXMKICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdjaGVja2JveCcgJiYgXy5pc0Jvb2xlYW4odmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnR5cGUgPT09ICdjaGVja2JveCcgfHwgdGhpcy50eXBlID09PSAncmFkaW8nKSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IHZhbHVlID09IHRoaXMudmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgIHRoaXMudHJpZ2dlcigncG9wdWxhdGUnLCBhdHRyaWJ1dGVzKTsKICB9LAoKICAvL3BlcmZvcm0gZm9ybSB2YWxpZGF0aW9uLCBpbXBsZW1lbnRlZCBieSBjaGlsZCBjbGFzcwogIHZhbGlkYXRlSW5wdXQ6IGZ1bmN0aW9uKC8qIGF0dHJpYnV0ZXMsIG9wdGlvbnMsIGVycm9ycyAqLykge30sCgogIF9nZXRJbnB1dFZhbHVlOiBmdW5jdGlvbihpbnB1dCAvKiAsIG9wdGlvbnMsIGVycm9ycyAqLykgewogICAgaWYgKGlucHV0LnR5cGUgPT09ICdjaGVja2JveCcgfHwgaW5wdXQudHlwZSA9PT0gJ3JhZGlvJykgewogICAgICBpZiAoaW5wdXQuY2hlY2tlZCkgewogICAgICAgIHJldHVybiBpbnB1dC52YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpbnB1dC5tdWx0aXBsZSA9PT0gdHJ1ZSkgewogICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICQoJ29wdGlvbicsIGlucHV0KS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkKSB7CiAgICAgICAgICB2YWx1ZXMucHVzaCh0aGlzLnZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gdmFsdWVzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGlucHV0LnZhbHVlOwogICAgfQogIH0KfSk7CgpUaG9yYXguVmlldy5vbih7CiAgZXJyb3I6IGZ1bmN0aW9uKCkgewogICAgcmVzZXRTdWJtaXRTdGF0ZS5jYWxsKHRoaXMpOwoKICAgIC8vIElmIHdlIGVycm9yZWQgd2l0aCBhIG1vZGVsIHdlIHdhbnQgdG8gcmVzZXQgdGhlIGNvbnRlbnQgYnV0IGxlYXZlIHRoZSBVSQogICAgLy8gaW50YWN0LiBJZiB0aGUgdXNlciB1cGRhdGVzIHRoZSBkYXRhIGFuZCBzZXJpYWxpemVzIGFueSBvdmVyd3JpdHRlbiBkYXRhCiAgICAvLyB3aWxsIGJlIHJlc3RvcmVkLgogICAgaWYgKHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5wcmV2aW91c0F0dHJpYnV0ZXMpIHsKICAgICAgdGhpcy5tb2RlbC5zZXQodGhpcy5tb2RlbC5wcmV2aW91c0F0dHJpYnV0ZXMoKSwgewogICAgICAgIHNpbGVudDogdHJ1ZQogICAgICB9KTsKICAgIH0KICB9LAogIGRlYWN0aXZhdGVkOiBmdW5jdGlvbigpIHsKICAgIHJlc2V0U3VibWl0U3RhdGUuY2FsbCh0aGlzKTsKICB9Cn0pOwoKZnVuY3Rpb24gZWFjaE5hbWVkSW5wdXQob3B0aW9ucywgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIgaSA9IDAsCiAgICAgIHNlbGYgPSB0aGlzOwoKICB0aGlzLiQoJ3NlbGVjdCxpbnB1dCx0ZXh0YXJlYScsIG9wdGlvbnMucm9vdCB8fCB0aGlzLmVsKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgaWYgKCFvcHRpb25zLmNoaWxkcmVuKSB7CiAgICAgIGlmIChzZWxmICE9PSAkKHRoaXMpLnZpZXcoe2hlbHBlcjogZmFsc2V9KSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMudHlwZSAhPT0gJ2J1dHRvbicgJiYgdGhpcy50eXBlICE9PSAnY2FuY2VsJyAmJiB0aGlzLnR5cGUgIT09ICdzdWJtaXQnICYmIHRoaXMubmFtZSAmJiB0aGlzLm5hbWUgIT09ICcnKSB7CiAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCB8fCB0aGlzLCBpLCB0aGlzKTsKICAgICAgKytpOwogICAgfQogIH0pOwp9CgovL2NhbGxzIGEgY2FsbGJhY2sgd2l0aCB0aGUgY29ycmVjdCBvYmplY3QgZnJhZ21lbnQgYW5kIGtleSBmcm9tIGEgY29tcG91bmQgbmFtZQpmdW5jdGlvbiBvYmplY3RBbmRLZXlGcm9tQXR0cmlidXRlc0FuZE5hbWUoYXR0cmlidXRlcywgbmFtZSwgb3B0aW9ucywgY2FsbGJhY2spIHsKICB2YXIga2V5LAogICAgICBvYmplY3QgPSBhdHRyaWJ1dGVzLAogICAgICBrZXlzID0gbmFtZS5zcGxpdCgnWycpLAogICAgICBtb2RlID0gb3B0aW9ucy5tb2RlOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoIC0gMTsgKytpKSB7CiAgICBrZXkgPSBrZXlzW2ldLnJlcGxhY2UoJ10nLCAnJyk7CiAgICBpZiAoIW9iamVjdFtrZXldKSB7CiAgICAgIGlmIChtb2RlID09PSAnc2VyaWFsaXplJykgewogICAgICAgIG9iamVjdFtrZXldID0ge307CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwodGhpcywgZmFsc2UsIGtleSk7CiAgICAgIH0KICAgIH0KICAgIG9iamVjdCA9IG9iamVjdFtrZXldOwogIH0KICBrZXkgPSBrZXlzW2tleXMubGVuZ3RoIC0gMV0ucmVwbGFjZSgnXScsICcnKTsKICBjYWxsYmFjay5jYWxsKHRoaXMsIG9iamVjdCwga2V5KTsKfQoKZnVuY3Rpb24gcmVzZXRTdWJtaXRTdGF0ZSgpIHsKICB0aGlzLiQoJ2Zvcm0nKS5yZW1vdmVBdHRyKCdkYXRhLXN1Ym1pdC13YWl0Jyk7Cn0KCjs7CnZhciBsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtbGF5b3V0LWNpZCc7CgpUaG9yYXguTGF5b3V0VmlldyA9IFRob3JheC5WaWV3LmV4dGVuZCh7CiAgX2RlZmF1bHRUZW1wbGF0ZTogSGFuZGxlYmFycy5WTS5ub29wLAogIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguVmlldy5wcm90b3R5cGUucmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAodGhpcy50ZW1wbGF0ZSA9PT0gSGFuZGxlYmFycy5WTS5ub29wKSB7CiAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIHRlbXBsYXRlIHNldFZpZXcgd2lsbCBhcHBlbmQgdG8gdGhpcy4kZWwKICAgICAgZW5zdXJlTGF5b3V0Q2lkLmNhbGwodGhpcyk7CiAgICB9IGVsc2UgewogICAgICAvLyBpZiBhIHRlbXBsYXRlIHdhcyBzcGVjaWZpZWQgaXMgbXVzdCBkZWNsYXJlIGEgbGF5b3V0LWVsZW1lbnQKICAgICAgZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcyk7CiAgICB9CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICBzZXRWaWV3OiBmdW5jdGlvbih2aWV3LCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5leHRlbmQoewogICAgICBzY3JvbGw6IHRydWUsCiAgICAgIGRlc3Ryb3k6IHRydWUKICAgIH0sIG9wdGlvbnMgfHwge30pOwogICAgaWYgKF8uaXNTdHJpbmcodmlldykpIHsKICAgICAgdmlldyA9IG5ldyAoVGhvcmF4LlV0aWwucmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCB2aWV3LCBmYWxzZSkpKCk7CiAgICB9CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICB2YXIgb2xkVmlldyA9IHRoaXMuX3ZpZXc7CiAgICBpZiAodmlldyA9PT0gb2xkVmlldykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAob3B0aW9ucy5kZXN0cm95ICYmIHZpZXcpIHsKICAgICAgdmlldy5fc2hvdWxkRGVzdHJveU9uTmV4dFNldFZpZXcgPSB0cnVlOwogICAgfQoKICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOnZpZXc6c3RhcnQnLCB2aWV3LCBvbGRWaWV3LCBvcHRpb25zKTsKCiAgICBpZiAob2xkVmlldykgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChvbGRWaWV3KTsKICAgICAgb2xkVmlldy4kZWwucmVtb3ZlKCk7CiAgICAgIHRyaWdnZXJMaWZlY3ljbGVFdmVudC5jYWxsKG9sZFZpZXcsICdkZWFjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICBpZiAob2xkVmlldy5fc2hvdWxkRGVzdHJveU9uTmV4dFNldFZpZXcpIHsKICAgICAgICBvbGRWaWV3LmRlc3Ryb3koKTsKICAgICAgfQogICAgfQoKICAgIGlmICh2aWV3KSB7CiAgICAgIHRyaWdnZXJMaWZlY3ljbGVFdmVudC5jYWxsKHRoaXMsICdhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgdmlldy50cmlnZ2VyKCdhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgdGhpcy5fYWRkQ2hpbGQodmlldyk7CiAgICAgIHRoaXMuX3ZpZXcgPSB2aWV3OwogICAgICB0aGlzLl92aWV3LmFwcGVuZFRvKGdldExheW91dFZpZXdzVGFyZ2V0RWxlbWVudC5jYWxsKHRoaXMpKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3ZpZXcgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6dmlldzplbmQnLCB2aWV3LCBvbGRWaWV3LCBvcHRpb25zKTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIGdldFZpZXc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXc7CiAgfQp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xheW91dC1lbGVtZW50JywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciB2aWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKICAvLyBkdWNrIHR5cGUgY2hlY2sgZm9yIExheW91dFZpZXcKICBpZiAoIXZpZXcuZ2V0VmlldykgewogICAgdGhyb3cgbmV3IEVycm9yKCdsYXlvdXQtZWxlbWVudCBtdXN0IGJlIHVzZWQgd2l0aGluIGEgTGF5b3V0VmlldycpOwogIH0KICBvcHRpb25zLmhhc2hbbGF5b3V0Q2lkQXR0cmlidXRlTmFtZV0gPSB2aWV3LmNpZDsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIG9wdGlvbnMuaGFzaCwgJycsIHRoaXMpKTsKfSk7CgpmdW5jdGlvbiB0cmlnZ2VyTGlmZWN5Y2xlRXZlbnQoZXZlbnROYW1lLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgb3B0aW9ucy50YXJnZXQgPSB0aGlzOwogIHRoaXMudHJpZ2dlcihldmVudE5hbWUsIG9wdGlvbnMpOwogIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgY2hpbGQudHJpZ2dlcihldmVudE5hbWUsIG9wdGlvbnMpOwogIH0pOwp9CgpmdW5jdGlvbiBlbnN1cmVMYXlvdXRDaWQoKSB7CiAgKyt0aGlzLl9yZW5kZXJDb3VudDsKICAvL3NldCB0aGUgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSBvbiB0aGlzLiRlbCBpZiB0aGVyZSB3YXMgbm8gdGVtcGxhdGUKICB0aGlzLiRlbC5hdHRyKGxheW91dENpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKfQoKZnVuY3Rpb24gZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIGlmICghdGhpcy4kKCdbJyArIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgdGhpcy5jaWQgKyAnIl0nKVswXSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdObyBsYXlvdXQgZWxlbWVudCBmb3VuZCBpbiAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkpOwogIH0KfQoKZnVuY3Rpb24gZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIHJldHVybiB0aGlzLiQoJ1snICsgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNpZCArICciXScpWzBdIHx8IHRoaXMuZWxbMF0gfHwgdGhpcy5lbDsKfQoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyICovCgovL1JvdXRlcgpmdW5jdGlvbiBpbml0aWFsaXplUm91dGVyKCkgewogIEJhY2tib25lLmhpc3RvcnkgfHwgKEJhY2tib25lLmhpc3RvcnkgPSBuZXcgQmFja2JvbmUuSGlzdG9yeSgpKTsKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIG9uUm91dGUsIHRoaXMpOwogIC8vcm91dGVyIGRvZXMgbm90IGhhdmUgYSBidWlsdCBpbiBkZXN0cm95IGV2ZW50CiAgLy9idXQgVmlld0NvbnRyb2xsZXIgZG9lcwogIHRoaXMub24oJ2Rlc3Ryb3llZCcsIGZ1bmN0aW9uKCkgewogICAgQmFja2JvbmUuaGlzdG9yeS5vZmYoJ3JvdXRlJywgb25Sb3V0ZSwgdGhpcyk7CiAgfSk7Cn0KClRob3JheC5Sb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguUm91dGVyLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaW5pdGlhbGl6ZVJvdXRlci5jYWxsKHRoaXMpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgaWYgKCFjYWxsYmFjaykgewogICAgICBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICB9CiAgICAvL2FkZCBhIHJvdXRlOmJlZm9yZSBldmVudCB0aGF0IGlzIGZpcmVkIGJlZm9yZSB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkCiAgICByZXR1cm4gQmFja2JvbmUuUm91dGVyLnByb3RvdHlwZS5yb3V0ZS5jYWxsKHRoaXMsIHJvdXRlLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGU6YmVmb3JlJywgcm91dGUsIG5hbWVdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSk7CiAgfQp9KTsKClRob3JheC5Sb3V0ZXJzID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguUm91dGVyLCBUaG9yYXguUm91dGVycyk7CgpmdW5jdGlvbiBvblJvdXRlKHJvdXRlciAvKiAsIG5hbWUgKi8pIHsKICBpZiAodGhpcyA9PT0gcm91dGVyKSB7CiAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZSddLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfQp9Cgo7OwpUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcgPSBUaG9yYXguQ29sbGVjdGlvblZpZXcuZXh0ZW5kKHsKICAvLyBGb3J3YXJkIHJlbmRlciBldmVudHMgdG8gdGhlIHBhcmVudAogIGV2ZW50czogewogICAgJ3JlbmRlcmVkOml0ZW0nOiBmb3J3YXJkUmVuZGVyRXZlbnQoJ3JlbmRlcmVkOml0ZW0nKSwKICAgICdyZW5kZXJlZDpjb2xsZWN0aW9uJzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDpjb2xsZWN0aW9uJyksCiAgICAncmVuZGVyZWQ6ZW1wdHknOiBmb3J3YXJkUmVuZGVyRXZlbnQoJ3JlbmRlcmVkOmVtcHR5JykKICB9LAoKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgXy5lYWNoKGNvbGxlY3Rpb25PcHRpb25OYW1lcywgZnVuY3Rpb24odmlld0F0dHJpYnV0ZU5hbWUsIGhlbHBlck9wdGlvbk5hbWUpIHsKICAgICAgaWYgKG9wdGlvbnMub3B0aW9uc1toZWxwZXJPcHRpb25OYW1lXSkgewogICAgICAgIHZhciB2YWx1ZSA9IG9wdGlvbnMub3B0aW9uc1toZWxwZXJPcHRpb25OYW1lXTsKICAgICAgICBpZiAodmlld0F0dHJpYnV0ZU5hbWUgPT09ICdpdGVtVGVtcGxhdGUnIHx8IHZpZXdBdHRyaWJ1dGVOYW1lID09PSAnZW1wdHlUZW1wbGF0ZScpIHsKICAgICAgICAgIHZhbHVlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBvcHRpb25zW3ZpZXdBdHRyaWJ1dGVOYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICAgIC8vIEhhbmRsZWJhcnMuVk0ubm9vcCBpcyBwYXNzZWQgaW4gdGhlIGhhbmRsZWJhcnMgb3B0aW9ucyBvYmplY3QgYXMKICAgIC8vIGEgZGVmYXVsdCBmb3IgZm4gYW5kIGludmVyc2UsIGlmIGEgYmxvY2sgd2FzIHByZXNlbnQuIE5lZWQgdG8KICAgIC8vIGNoZWNrIHRvIGVuc3VyZSB3ZSBkb24ndCBwaWNrIHRoZSBlbXB0eSAvIG51bGwgYmxvY2sgdXAuCiAgICBpZiAoIW9wdGlvbnMuaXRlbVRlbXBsYXRlICYmIG9wdGlvbnMudGVtcGxhdGUgJiYgb3B0aW9ucy50ZW1wbGF0ZSAhPT0gSGFuZGxlYmFycy5WTS5ub29wKSB7CiAgICAgIG9wdGlvbnMuaXRlbVRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZTsKICAgICAgb3B0aW9ucy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0ubm9vcDsKICAgIH0KICAgIGlmICghb3B0aW9ucy5lbXB0eVRlbXBsYXRlICYmIG9wdGlvbnMuaW52ZXJzZSAmJiBvcHRpb25zLmludmVyc2UgIT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICBvcHRpb25zLmVtcHR5VGVtcGxhdGUgPSBvcHRpb25zLmludmVyc2U7CiAgICAgIG9wdGlvbnMuaW52ZXJzZSA9IEhhbmRsZWJhcnMuVk0ubm9vcDsKICAgIH0KICAgIHZhciByZXNwb25zZSA9IFRob3JheC5IZWxwZXJWaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICBpZiAodGhpcy5wYXJlbnQubmFtZSkgewogICAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSkgewogICAgICAgIHRoaXMuZW1wdHlUZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMucGFyZW50Lm5hbWUgKyAnLWVtcHR5JywgdHJ1ZSk7CiAgICAgIH0KICAgICAgaWYgKCF0aGlzLml0ZW1UZW1wbGF0ZSkgewogICAgICAgIC8vIGl0ZW0gdGVtcGxhdGUgbXVzdCBiZSBwcmVzZW50IGlmIGFuIGl0ZW1WaWV3IGlzIG5vdAogICAgICAgIHRoaXMuaXRlbVRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5wYXJlbnQubmFtZSArICctaXRlbScsICEhdGhpcy5pdGVtVmlldyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICBzZXRBc1ByaW1hcnlDb2xsZWN0aW9uSGVscGVyOiBmdW5jdGlvbigpIHsKICAgIF8uZWFjaChmb3J3YXJkYWJsZVByb3BlcnRpZXMsIGZ1bmN0aW9uKHByb3BlcnR5TmFtZSkgewogICAgICBmb3J3YXJkTWlzc2luZ1Byb3BlcnR5LmNhbGwodGhpcywgcHJvcGVydHlOYW1lKTsKICAgIH0sIHRoaXMpOwogICAgaWYgKHRoaXMucGFyZW50Lml0ZW1GaWx0ZXIgJiYgIXRoaXMuaXRlbUZpbHRlcikgewogICAgICB0aGlzLml0ZW1GaWx0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQuaXRlbUZpbHRlci5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIGlmICh0aGlzLnBhcmVudC5pdGVtQ29udGV4dCkgewogICAgICB0aGlzLml0ZW1Db250ZXh0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50Lml0ZW1Db250ZXh0LmFwcGx5KHRoaXMucGFyZW50LCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIH0KfSk7CgpfLmV4dGVuZChUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcucHJvdG90eXBlLCBoZWxwZXJWaWV3UHJvdG90eXBlKTsKCnZhciBjb2xsZWN0aW9uT3B0aW9uTmFtZXMgPSB7CiAgJ2l0ZW0tdGVtcGxhdGUnOiAnaXRlbVRlbXBsYXRlJywKICAnZW1wdHktdGVtcGxhdGUnOiAnZW1wdHlUZW1wbGF0ZScsCiAgJ2l0ZW0tdmlldyc6ICdpdGVtVmlldycsCiAgJ2VtcHR5LXZpZXcnOiAnZW1wdHlWaWV3JywKICAnZW1wdHktY2xhc3MnOiAnZW1wdHlDbGFzcycKfTsKCmZ1bmN0aW9uIGZvcndhcmRSZW5kZXJFdmVudChldmVudE5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpOwogICAgYXJncy51bnNoaWZ0KGV2ZW50TmFtZSk7CiAgICB0aGlzLnBhcmVudC50cmlnZ2VyLmFwcGx5KHRoaXMucGFyZW50LCBhcmdzKTsKICB9Cn0KCnZhciBmb3J3YXJkYWJsZVByb3BlcnRpZXMgPSBbCiAgJ2l0ZW1UZW1wbGF0ZScsCiAgJ2l0ZW1WaWV3JywKICAnZW1wdHlUZW1wbGF0ZScsCiAgJ2VtcHR5VmlldycKXTsKCmZ1bmN0aW9uIGZvcndhcmRNaXNzaW5nUHJvcGVydHkocHJvcGVydHlOYW1lKSB7CiAgdmFyIHBhcmVudCA9IGdldFBhcmVudCh0aGlzKTsKICBpZiAoIXRoaXNbcHJvcGVydHlOYW1lXSkgewogICAgdmFyIHByb3AgPSBwYXJlbnRbcHJvcGVydHlOYW1lXTsKICAgIGlmIChwcm9wKXsKICAgICAgdGhpc1twcm9wZXJ0eU5hbWVdID0gcHJvcDsKICAgIH0KICB9Cn0KCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyKCdjb2xsZWN0aW9uJywgVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LCBmdW5jdGlvbihjb2xsZWN0aW9uLCB2aWV3KSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHZpZXcgPSBjb2xsZWN0aW9uOwogICAgY29sbGVjdGlvbiA9IHZpZXcucGFyZW50LmNvbGxlY3Rpb247CiAgICBjb2xsZWN0aW9uICYmIHZpZXcuc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcigpOwogICAgdmlldy4kZWwuYXR0cihjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUsICd0cnVlJyk7CiAgICAvLyBwcm9wYWdhdGUgZnV0dXJlIGNoYW5nZXMgdG8gdGhlIHBhcmVudCdzIGNvbGxlY3Rpb24gb2JqZWN0CiAgICAvLyB0byB0aGUgaGVscGVyIHZpZXcKICAgIHZpZXcubGlzdGVuVG8odmlldy5wYXJlbnQsICdjaGFuZ2U6ZGF0YS1vYmplY3QnLCBmdW5jdGlvbih0eXBlLCBkYXRhT2JqZWN0KSB7CiAgICAgIGlmICh0eXBlID09PSAnY29sbGVjdGlvbicpIHsKICAgICAgICB2aWV3LnNldEFzUHJpbWFyeUNvbGxlY3Rpb25IZWxwZXIoKTsKICAgICAgICB2aWV3LnNldENvbGxlY3Rpb24oZGF0YU9iamVjdCk7CiAgICAgIH0KICAgIH0pOwogIH0KICBjb2xsZWN0aW9uICYmIHZpZXcuc2V0Q29sbGVjdGlvbihjb2xsZWN0aW9uKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdjb2xsZWN0aW9uLWVsZW1lbnQnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgaWYgKCFnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LnJlbmRlckNvbGxlY3Rpb24pIHsKICAgIHRocm93IG5ldyBFcnJvcigiY29sbGVjdGlvbi1lbGVtZW50IGhlbHBlciBtdXN0IGJlIGRlY2xhcmVkIGluc2lkZSBvZiBhIENvbGxlY3Rpb25WaWV3Iik7CiAgfQogIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoOwogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKGhhc2gpOwogIGhhc2gudGFnTmFtZSA9IGhhc2gudGFnTmFtZSB8fCAnZGl2JzsKICBoYXNoW2NvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZV0gPSB0cnVlOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIGhhc2gsICcnLCB0aGlzKSk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignZW1wdHknLCBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIG9wdGlvbnMgPSBkYXRhT2JqZWN0OwogIH0KICB2YXIgdmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIGRhdGFPYmplY3QgPSB2aWV3Lm1vZGVsOwogIH0KICAvLyBsaXN0ZW5lcnMgZm9yIHRoZSBlbXB0eSBoZWxwZXIgcmF0aGVyIHRoYW4gbGlzdGVuZXJzCiAgLy8gdGhhdCBhcmUgdGhlbXNlbHZlcyBlbXB0eQogIGlmICghdmlldy5fZW1wdHlMaXN0ZW5lcnMpIHsKICAgIHZpZXcuX2VtcHR5TGlzdGVuZXJzID0ge307CiAgfQogIC8vIGR1Y2sgdHlwZSBjaGVjayBmb3IgY29sbGVjdGlvbgogIGlmIChkYXRhT2JqZWN0ICYmICF2aWV3Ll9lbXB0eUxpc3RlbmVyc1tkYXRhT2JqZWN0LmNpZF0gJiYgZGF0YU9iamVjdC5tb2RlbHMgJiYgKCdsZW5ndGgnIGluIGRhdGFPYmplY3QpKSB7CiAgICB2aWV3Ll9lbXB0eUxpc3RlbmVyc1tkYXRhT2JqZWN0LmNpZF0gPSB0cnVlOwogICAgdmlldy5saXN0ZW5UbyhkYXRhT2JqZWN0LCAncmVtb3ZlJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkYXRhT2JqZWN0Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIHZpZXcucmVuZGVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgdmlldy5saXN0ZW5UbyhkYXRhT2JqZWN0LCAnYWRkJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkYXRhT2JqZWN0Lmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZpZXcucmVuZGVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgdmlldy5saXN0ZW5UbyhkYXRhT2JqZWN0LCAncmVzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgdmlldy5yZW5kZXIoKTsKICAgIH0pOwogIH0KICByZXR1cm4gIWRhdGFPYmplY3QgfHwgZGF0YU9iamVjdC5pc0VtcHR5KCkgPyBvcHRpb25zLmZuKHRoaXMpIDogb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3RlbXBsYXRlJywgZnVuY3Rpb24obmFtZSwgb3B0aW9ucykgewogIHZhciBjb250ZXh0ID0gXy5leHRlbmQoe2ZuOiBvcHRpb25zICYmIG9wdGlvbnMuZm59LCB0aGlzLCBvcHRpb25zID8gb3B0aW9ucy5oYXNoIDoge30pOwogIHZhciBvdXRwdXQgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LnJlbmRlclRlbXBsYXRlKG5hbWUsIGNvbnRleHQpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKG91dHB1dCk7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigneWllbGQnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgcmV0dXJuIGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnlpZWxkICYmIG9wdGlvbnMuZGF0YS55aWVsZCgpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3VybCcsIGZ1bmN0aW9uKHVybCkgewogIHZhciBmcmFnbWVudDsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgIGZyYWdtZW50ID0gXy5tYXAoXy5oZWFkKGFyZ3VtZW50cywgYXJndW1lbnRzLmxlbmd0aCAtIDEpLCBlbmNvZGVVUklDb21wb25lbnQpLmpvaW4oJy8nKTsKICB9IGVsc2UgewogICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHNbMV0sCiAgICAgICAgaGFzaCA9IChvcHRpb25zICYmIG9wdGlvbnMuaGFzaCkgfHwgb3B0aW9uczsKICAgIGlmIChoYXNoICYmIGhhc2hbJ2V4cGFuZC10b2tlbnMnXSkgewogICAgICBmcmFnbWVudCA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHVybCwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICBmcmFnbWVudCA9IHVybDsKICAgIH0KICB9CiAgcmV0dXJuIChCYWNrYm9uZS5oaXN0b3J5Ll9oYXNQdXNoU3RhdGUgPyBCYWNrYm9uZS5oaXN0b3J5Lm9wdGlvbnMucm9vdCA6ICcjJykgKyBmcmFnbWVudDsKfSk7Cgo7OwovKmdsb2JhbCB2aWV3VGVtcGxhdGVPdmVycmlkZXMgKi8KSGFuZGxlYmFycy5yZWdpc3RlclZpZXdIZWxwZXIoJ3ZpZXcnLCB7CiAgZmFjdG9yeTogZnVuY3Rpb24oYXJncywgb3B0aW9ucykgewogICAgdmFyIFZpZXcgPSBhcmdzLmxlbmd0aCA+PSAxID8gYXJnc1swXSA6IFRob3JheC5WaWV3OwogICAgcmV0dXJuIFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZShWaWV3LCBvcHRpb25zLm9wdGlvbnMpOwogIH0sCiAgY2FsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgdmFyIGluc3RhbmNlID0gYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGgtMV0sCiAgICAgICAgb3B0aW9ucyA9IGluc3RhbmNlLl9oZWxwZXJPcHRpb25zLm9wdGlvbnMsCiAgICAgICAgcGxhY2Vob2xkZXJJZCA9IGluc3RhbmNlLmNpZDsKCiAgICBpZiAob3B0aW9ucy5mbikgewogICAgICB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0gPSBvcHRpb25zLmZuOwogICAgfQogIH0KfSk7Cgo7Owp2YXIgY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jYWxsLW1ldGhvZCcsCiAgICB0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdHJpZ2dlci1ldmVudCc7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdidXR0b24nLCBmdW5jdGlvbihtZXRob2QsIG9wdGlvbnMpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgb3B0aW9ucyA9IG1ldGhvZDsKICAgIG1ldGhvZCA9IG9wdGlvbnMuaGFzaC5tZXRob2Q7CiAgfQogIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoLAogICAgICBleHBhbmRUb2tlbnMgPSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgZGVsZXRlIGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBpZiAoIW1ldGhvZCAmJiAhb3B0aW9ucy5oYXNoLnRyaWdnZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigiYnV0dG9uIGhlbHBlciBtdXN0IGhhdmUgYSBtZXRob2QgbmFtZSBhcyB0aGUgZmlyc3QgYXJndW1lbnQgb3IgYSAndHJpZ2dlcicsIG9yIGEgJ21ldGhvZCcgYXR0cmlidXRlIHNwZWNpZmllZC4iKTsKICB9CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMoaGFzaCk7CiAgaGFzaC50YWdOYW1lID0gaGFzaC50YWdOYW1lIHx8ICdidXR0b24nOwogIGhhc2gudHJpZ2dlciAmJiAoaGFzaFt0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lXSA9IGhhc2gudHJpZ2dlcik7CiAgZGVsZXRlIGhhc2gudHJpZ2dlcjsKICBtZXRob2QgJiYgKGhhc2hbY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWVdID0gbWV0aG9kKTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsaW5rJywgZnVuY3Rpb24oKSB7CiAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgb3B0aW9ucyA9IGFyZ3MucG9wKCksCiAgICAgIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgICAgIC8vIHVybCBpcyBhbiBhcnJheSB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSB1cmwgaGVscGVyCiAgICAgIHVybCA9IGFyZ3MubGVuZ3RoID09PSAwID8gW2hhc2guaHJlZl0gOiBhcmdzLAogICAgICBleHBhbmRUb2tlbnMgPSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgZGVsZXRlIGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBpZiAoIXVybFswXSAmJiB1cmxbMF0gIT09ICcnKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImxpbmsgaGVscGVyIHJlcXVpcmVzIGFuIGhyZWYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IG9yIGFuICdocmVmJyBhdHRyaWJ1dGUiKTsKICB9CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMoaGFzaCk7CiAgdXJsLnB1c2gob3B0aW9ucyk7CiAgaGFzaC5ocmVmID0gSGFuZGxlYmFycy5oZWxwZXJzLnVybC5hcHBseSh0aGlzLCB1cmwpOwogIGhhc2gudGFnTmFtZSA9IGhhc2gudGFnTmFtZSB8fCAnYSc7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gb3B0aW9ucy5oYXNoLnRyaWdnZXIpOwogIGRlbGV0ZSBoYXNoLnRyaWdnZXI7CiAgaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSAnX2FuY2hvckNsaWNrJzsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7Cgp2YXIgY2xpY2tTZWxlY3RvciA9ICdbJyArIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lICsgJ10sIFsnICsgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSArICddJzsKCmZ1bmN0aW9uIGhhbmRsZUNsaWNrKGV2ZW50KSB7CiAgdmFyIHRhcmdldCA9ICQoZXZlbnQudGFyZ2V0KSwKICAgICAgdmlldyA9IHRhcmdldC52aWV3KHtoZWxwZXI6IGZhbHNlfSksCiAgICAgIG1ldGhvZE5hbWUgPSB0YXJnZXQuYXR0cihjYWxsTWV0aG9kQXR0cmlidXRlTmFtZSksCiAgICAgIGV2ZW50TmFtZSA9IHRhcmdldC5hdHRyKHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUpLAogICAgICBtZXRob2RSZXNwb25zZSA9IGZhbHNlOwogIG1ldGhvZE5hbWUgJiYgKG1ldGhvZFJlc3BvbnNlID0gdmlld1ttZXRob2ROYW1lXS5jYWxsKHZpZXcsIGV2ZW50KSk7CiAgZXZlbnROYW1lICYmIHZpZXcudHJpZ2dlcihldmVudE5hbWUsIGV2ZW50KTsKICB0YXJnZXQudGFnTmFtZSA9PT0gIkEiICYmIG1ldGhvZFJlc3BvbnNlID09PSBmYWxzZSAmJiBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwp9Cgp2YXIgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZTsKCmZ1bmN0aW9uIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCkgewogIHVucmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICBsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lID0gVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUgfHwgJ2NsaWNrJzsKICAkKGRvY3VtZW50KS5vbihsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lLCBjbGlja1NlbGVjdG9yLCBoYW5kbGVDbGljayk7Cn0KCmZ1bmN0aW9uIHVucmVnaXN0ZXJDbGlja0hhbmRsZXIoKSB7CiAgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSAmJiAkKGRvY3VtZW50KS5vZmYobGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSwgY2xpY2tTZWxlY3RvciwgaGFuZGxlQ2xpY2spOwp9CgokKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHsKICBpZiAoIVRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lKSB7CiAgICByZWdpc3RlckNsaWNrSGFuZGxlcigpOwogIH0KfSk7Cgo7Owp2YXIgZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLWVsZW1lbnQtdG1wJzsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VsZW1lbnQnLCBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMob3B0aW9ucy5oYXNoKTsKICB2YXIgY2lkID0gXy51bmlxdWVJZCgnZWxlbWVudCcpLAogICAgICBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldywKICAgICAgaHRtbEF0dHJpYnV0ZXMgPSBfLnBpY2sob3B0aW9ucy5oYXNoLCBodG1sQXR0cmlidXRlc1RvQ29weSk7CiAgaHRtbEF0dHJpYnV0ZXNbZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZV0gPSBjaWQ7CiAgZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZCB8fCAoZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZCA9IHt9KTsKICBkZWNsYXJpbmdWaWV3Ll9lbGVtZW50c0J5Q2lkW2NpZF0gPSBlbGVtZW50OwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhodG1sQXR0cmlidXRlcykpOwp9KTsKClRob3JheC5WaWV3Lm9uKCdhcHBlbmQnLCBmdW5jdGlvbihzY29wZSwgY2FsbGJhY2spIHsKICAoc2NvcGUgfHwgdGhpcy4kZWwpLmZpbmQoJ1snICsgZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSArICddJykuZm9yRWFjaChmdW5jdGlvbihlbCkgewogICAgdmFyICRlbCA9ICQoZWwpLAogICAgICAgIGNpZCA9ICRlbC5hdHRyKGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUpLAogICAgICAgIGVsZW1lbnQgPSB0aGlzLl9lbGVtZW50c0J5Q2lkW2NpZF07CiAgICAvLyBBIGNhbGxiYWNrIGZ1bmN0aW9uIG1heSBiZSBzcGVjaWZpZWQgYXMgdGhlIHZhbHVlCiAgICBpZiAoXy5pc0Z1bmN0aW9uKGVsZW1lbnQpKSB7CiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LmNhbGwodGhpcyk7CiAgICB9CiAgICAkZWwucmVwbGFjZVdpdGgoZWxlbWVudCk7CiAgICBjYWxsYmFjayAmJiBjYWxsYmFjayhlbGVtZW50KTsKICB9LCB0aGlzKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdzdXBlcicsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcsCiAgICAgIHBhcmVudCA9IGRlY2xhcmluZ1ZpZXcuY29uc3RydWN0b3IgJiYgZGVjbGFyaW5nVmlldy5jb25zdHJ1Y3Rvci5fX3N1cGVyX187CiAgaWYgKHBhcmVudCkgewogICAgdmFyIHRlbXBsYXRlID0gcGFyZW50LnRlbXBsYXRlOwogICAgaWYgKCF0ZW1wbGF0ZSkgewogICAgICBpZiAoIXBhcmVudC5uYW1lKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgdXNlIHN1cGVyIGhlbHBlciB3aGVuIHBhcmVudCBoYXMgbm8gbmFtZSBvciB0ZW1wbGF0ZS4nKTsKICAgICAgfQogICAgICB0ZW1wbGF0ZSA9IHBhcmVudC5uYW1lOwogICAgfQogICAgaWYgKF8uaXNTdHJpbmcodGVtcGxhdGUpKSB7CiAgICAgIHRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGVtcGxhdGUsIGZhbHNlKTsKICAgIH0KICAgIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKHRlbXBsYXRlKHRoaXMsIG9wdGlvbnMpKTsKICB9IGVsc2UgewogICAgcmV0dXJuICcnOwogIH0KfSk7Cgo7OwovKmdsb2JhbCBjb2xsZWN0aW9uT3B0aW9uTmFtZXMsIGluaGVyaXRWYXJzICovCgp2YXIgbG9hZFN0YXJ0ID0gJ2xvYWQ6c3RhcnQnLAogICAgbG9hZEVuZCA9ICdsb2FkOmVuZCcsCiAgICByb290T2JqZWN0OwoKVGhvcmF4LnNldFJvb3RPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICByb290T2JqZWN0ID0gb2JqOwp9OwoKVGhvcmF4LmxvYWRIYW5kbGVyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgY29udGV4dCkgewogIHZhciBsb2FkQ291bnRlciA9IF8udW5pcXVlSWQoKTsKICByZXR1cm4gZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICB2YXIgc2VsZiA9IGNvbnRleHQgfHwgdGhpczsKICAgIHNlbGYuX2xvYWRJbmZvID0gc2VsZi5fbG9hZEluZm8gfHwgW107CiAgICB2YXIgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl07CgogICAgZnVuY3Rpb24gc3RhcnRMb2FkVGltZW91dCgpIHsKCiAgICAgIC8vIElmIHRoZSB0aW1lb3V0IGhhcyBiZWVuIHNldCBhbHJlYWR5IGJ1dCBoYXMgbm90IHRyaWdnZXJlZCB5ZXQgZG8gbm90aGluZwogICAgICAvLyBPdGhlcndpc2Ugc2V0IGEgbmV3IHRpbWVvdXQgKGVpdGhlciBpbml0aWFsIG9yIGZvciBnb2luZyBmcm9tIGJhY2tncm91bmQgdG8KICAgICAgLy8gbm9uLWJhY2tncm91bmQgbG9hZGluZykKICAgICAgaWYgKGxvYWRJbmZvLnRpbWVvdXQgJiYgIWxvYWRJbmZvLnJ1bikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGxvYWRpbmdUaW1lb3V0ID0gc2VsZi5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbiAhPT0gdW5kZWZpbmVkID8KICAgICAgICBzZWxmLl9sb2FkaW5nVGltZW91dER1cmF0aW9uIDogVGhvcmF4LlZpZXcucHJvdG90eXBlLl9sb2FkaW5nVGltZW91dER1cmF0aW9uOwogICAgICBsb2FkSW5mby50aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxvYWRJbmZvLnJ1biA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0LmNhbGwoc2VsZiwgbG9hZEluZm8ubWVzc2FnZSwgbG9hZEluZm8uYmFja2dyb3VuZCwgbG9hZEluZm8pOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2xvYWRTdGFydCcsIGUpOwogICAgICAgICAgfQogICAgICAgIH0sIGxvYWRpbmdUaW1lb3V0ICogMTAwMCk7CiAgICB9CgogICAgaWYgKCFsb2FkSW5mbykgewogICAgICBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXSA9IF8uZXh0ZW5kKHsKICAgICAgICBldmVudHM6IFtdLAogICAgICAgIHRpbWVvdXQ6IDAsCiAgICAgICAgbWVzc2FnZTogbWVzc2FnZSwKICAgICAgICBiYWNrZ3JvdW5kOiAhIWJhY2tncm91bmQKICAgICAgfSwgQmFja2JvbmUuRXZlbnRzKTsKICAgICAgc3RhcnRMb2FkVGltZW91dCgpOwogICAgfSBlbHNlIHsKICAgICAgY2xlYXJUaW1lb3V0KGxvYWRJbmZvLmVuZFRpbWVvdXQpOwoKICAgICAgbG9hZEluZm8ubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgIGlmICghYmFja2dyb3VuZCAmJiBsb2FkSW5mby5iYWNrZ3JvdW5kKSB7CiAgICAgICAgbG9hZEluZm8uYmFja2dyb3VuZCA9IGZhbHNlOwogICAgICAgIHN0YXJ0TG9hZFRpbWVvdXQoKTsKICAgICAgfQogICAgfQoKICAgIC8vIFByZXZlbnQgYmluZHMgdG8gdGhlIHNhbWUgb2JqZWN0IG11bHRpcGxlIHRpbWVzIGFzIHRoaXMgY2FuIGNhdXNlIHZlcnkgYmFkIHRoaW5ncwogICAgLy8gdG8gaGFwcGVuIGZvciB0aGUgbG9hZDtsb2FkO2VuZDtlbmQgZXhlY3V0aW9uIGZsb3cuCiAgICBpZiAobG9hZEluZm8uZXZlbnRzLmluZGV4T2Yob2JqZWN0KSA+PSAwKSB7CiAgICAgIGxvYWRJbmZvLmV2ZW50cy5wdXNoKG9iamVjdCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBsb2FkSW5mby5ldmVudHMucHVzaChvYmplY3QpOwoKICAgIG9iamVjdC5vbihsb2FkRW5kLCBmdW5jdGlvbiBlbmRDYWxsYmFjaygpIHsKICAgICAgdmFyIGxvYWRpbmdFbmRUaW1lb3V0ID0gc2VsZi5fbG9hZGluZ1RpbWVvdXRFbmREdXJhdGlvbjsKICAgICAgaWYgKGxvYWRpbmdFbmRUaW1lb3V0ID09PSB2b2lkIDApIHsKICAgICAgICAvLyBJZiB3ZSBhcmUgcnVubmluZyBvbiBhIG5vbi12aWV3IG9iamVjdCBwdWxsIHRoZSBkZWZhdWx0IHRpbWVvdXQKICAgICAgICBsb2FkaW5nRW5kVGltZW91dCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5fbG9hZGluZ1RpbWVvdXRFbmREdXJhdGlvbjsKICAgICAgfQoKICAgICAgdmFyIGV2ZW50cyA9IGxvYWRJbmZvLmV2ZW50cywKICAgICAgICAgIGluZGV4ID0gZXZlbnRzLmluZGV4T2Yob2JqZWN0KTsKICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICBldmVudHMuc3BsaWNlKGluZGV4LCAxKTsKCiAgICAgICAgaWYgKGV2ZW50cy5pbmRleE9mKG9iamVjdCkgPCAwKSB7CiAgICAgICAgICAvLyBMYXN0IGNhbGxiYWNrIGZvciB0aGlzIHBhcnRpY2xhciBvYmplY3QsIHJlbW92ZSB0aGUgYmluZAogICAgICAgICAgb2JqZWN0Lm9mZihsb2FkRW5kLCBlbmRDYWxsYmFjayk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIWV2ZW50cy5sZW5ndGgpIHsKICAgICAgICBjbGVhclRpbWVvdXQobG9hZEluZm8uZW5kVGltZW91dCk7CiAgICAgICAgbG9hZEluZm8uZW5kVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoIWV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgcnVuID0gbG9hZEluZm8ucnVuOwoKICAgICAgICAgICAgICBpZiAocnVuKSB7CiAgICAgICAgICAgICAgICAvLyBFbWl0IHRoZSBlbmQgYmVoYXZpb3IsIGJ1dCBvbmx5IGlmIHRoZXJlIGlzIGEgcGFpcmVkIHN0YXJ0CiAgICAgICAgICAgICAgICBlbmQuY2FsbChzZWxmLCBsb2FkSW5mby5iYWNrZ3JvdW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICAgICAgICBsb2FkSW5mby50cmlnZ2VyKGxvYWRFbmQsIGxvYWRJbmZvKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHN0b3BwaW5nIG1ha2Ugc3VyZSB3ZSBkb24ndCBydW4gYSBzdGFydAogICAgICAgICAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby50aW1lb3V0KTsKICAgICAgICAgICAgICBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2xvYWRFbmQnLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBsb2FkaW5nRW5kVGltZW91dCAqIDEwMDApOwogICAgICB9CiAgICB9KTsKICB9Owp9OwoKLyoqCiAqIEhlbHBlciBtZXRob2QgZm9yIHByb3BhZ2F0aW5nIGxvYWQ6c3RhcnQgZXZlbnRzIHRvIG90aGVyIG9iamVjdHMuCiAqCiAqIEZvcndhcmRzIGxvYWQ6c3RhcnQgZXZlbnRzIHRoYXQgb2NjdXIgb24gYHNvdXJjZWAgdG8gYGRlc3RgLgogKi8KVGhvcmF4LmZvcndhcmRMb2FkRXZlbnRzID0gZnVuY3Rpb24oc291cmNlLCBkZXN0LCBvbmNlKSB7CiAgZnVuY3Rpb24gbG9hZChtZXNzYWdlLCBiYWNrZ291bmQsIG9iamVjdCkgewogICAgaWYgKG9uY2UpIHsKICAgICAgc291cmNlLm9mZihsb2FkU3RhcnQsIGxvYWQpOwogICAgfQogICAgZGVzdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dvdW5kLCBvYmplY3QpOwogIH0KICBzb3VyY2Uub24obG9hZFN0YXJ0LCBsb2FkKTsKICByZXR1cm4gewogICAgb2ZmOiBmdW5jdGlvbigpIHsKICAgICAgc291cmNlLm9mZihsb2FkU3RhcnQsIGxvYWQpOwogICAgfQogIH07Cn07CgovLwovLyBEYXRhIGxvYWQgZXZlbnQgZ2VuZXJhdGlvbgovLwoKLyoqCiAqIE1peGluZyBmb3IgZ2VuZXJhdGluZyBsb2FkOnN0YXJ0IGFuZCBsb2FkOmVuZCBldmVudHMuCiAqLwpUaG9yYXgubWl4aW5Mb2FkYWJsZSA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICAvL2xvYWRpbmcgY29uZmlnCiAgICBfbG9hZGluZ0NsYXNzTmFtZTogJ2xvYWRpbmcnLAogICAgX2xvYWRpbmdUaW1lb3V0RHVyYXRpb246IDAuMzMsCiAgICBfbG9hZGluZ1RpbWVvdXRFbmREdXJhdGlvbjogMC4xMCwKCiAgICAvLyBQcm9wYWdhdGVzIGxvYWRpbmcgdmlldyBwYXJhbWV0ZXJzIHRvIHRoZSBBSkFYIGxheWVyCiAgICBvbkxvYWRTdGFydDogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwoKICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IHJhY2UgY29uZGl0aW9ucwogICAgICBpZiAoIXRoYXQgfHwgIXRoYXQuZWwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghdGhhdC5ub25CbG9ja2luZ0xvYWQgJiYgIWJhY2tncm91bmQgJiYgcm9vdE9iamVjdCAmJiByb290T2JqZWN0ICE9PSB0aGlzKSB7CiAgICAgICAgcm9vdE9iamVjdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgICAgfQogICAgICB0aGF0Ll9pc0xvYWRpbmcgPSB0cnVlOwogICAgICAkKHRoYXQuZWwpLmFkZENsYXNzKHRoYXQuX2xvYWRpbmdDbGFzc05hbWUpOwogICAgICAvLyB1c2VkIGJ5IGxvYWRpbmcgaGVscGVycwogICAgICB0aGF0LnRyaWdnZXIoJ2NoYW5nZTpsb2FkLXN0YXRlJywgJ3N0YXJ0Jyk7CiAgICB9LAogICAgb25Mb2FkRW5kOiBmdW5jdGlvbigvKiBiYWNrZ3JvdW5kLCBvYmplY3QgKi8pIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CgogICAgICAvLyBQcm90ZWN0IGFnYWluc3QgcmFjZSBjb25kaXRpb25zCiAgICAgIGlmICghdGhhdCB8fCAhdGhhdC5lbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAKICAgICAgdGhhdC5faXNMb2FkaW5nID0gZmFsc2U7CiAgICAgICQodGhhdC5lbCkucmVtb3ZlQ2xhc3ModGhhdC5fbG9hZGluZ0NsYXNzTmFtZSk7CiAgICAgIC8vIHVzZWQgYnkgbG9hZGluZyBoZWxwZXIKICAgICAgdGhhdC50cmlnZ2VyKCdjaGFuZ2U6bG9hZC1zdGF0ZScsICdlbmQnKTsKICAgIH0KICB9KTsKfTsKClRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzID0gZnVuY3Rpb24odGFyZ2V0LCB1c2VQYXJlbnQpIHsKICBfLmV4dGVuZCh0YXJnZXQsIHsKICAgIGxvYWRTdGFydDogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKICAgICAgdGhhdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgdGhhdCk7CiAgICB9LAogICAgbG9hZEVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwogICAgICB0aGF0LnRyaWdnZXIobG9hZEVuZCwgdGhhdCk7CiAgICB9CiAgfSk7Cn07CgpUaG9yYXgubWl4aW5Mb2FkYWJsZShUaG9yYXguVmlldy5wcm90b3R5cGUpOwpUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhUaG9yYXguVmlldy5wcm90b3R5cGUpOwoKCmlmIChUaG9yYXguSGVscGVyVmlldykgewogIFRob3JheC5taXhpbkxvYWRhYmxlKFRob3JheC5IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7CiAgVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKfQoKaWYgKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldykgewogIFRob3JheC5taXhpbkxvYWRhYmxlKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwp9CgpUaG9yYXguc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgZGF0YU9iaiwgb3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpcywKICAgICAgY29tcGxldGUgPSBvcHRpb25zLmNvbXBsZXRlOwoKICBvcHRpb25zLmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CiAgICBzZWxmLl9yZXF1ZXN0ID0gdW5kZWZpbmVkOwogICAgc2VsZi5fYWJvcnRlZCA9IGZhbHNlOwoKICAgIGNvbXBsZXRlICYmIGNvbXBsZXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICB0aGlzLl9yZXF1ZXN0ID0gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICByZXR1cm4gdGhpcy5fcmVxdWVzdDsKfTsKCmZ1bmN0aW9uIGJpbmRUb1JvdXRlKGNhbGxiYWNrLCBmYWlsYmFjaykgewogIHZhciBmcmFnbWVudCA9IEJhY2tib25lLmhpc3RvcnkuZ2V0RnJhZ21lbnQoKSwKICAgICAgcm91dGVDaGFuZ2VkID0gZmFsc2U7CgogIGZ1bmN0aW9uIHJvdXRlSGFuZGxlcigpIHsKICAgIGlmIChmcmFnbWVudCA9PT0gQmFja2JvbmUuaGlzdG9yeS5nZXRGcmFnbWVudCgpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJvdXRlQ2hhbmdlZCA9IHRydWU7CiAgICByZXMuY2FuY2VsKCk7CiAgICBmYWlsYmFjayAmJiBmYWlsYmFjaygpOwogIH0KCiAgQmFja2JvbmUuaGlzdG9yeS5vbigncm91dGUnLCByb3V0ZUhhbmRsZXIpOwoKICBmdW5jdGlvbiBmaW5hbGl6ZXIoKSB7CiAgICBCYWNrYm9uZS5oaXN0b3J5Lm9mZigncm91dGUnLCByb3V0ZUhhbmRsZXIpOwogICAgaWYgKCFyb3V0ZUNoYW5nZWQpIHsKICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CgogIHZhciByZXMgPSBfLmJpbmQoZmluYWxpemVyLCB0aGlzKTsKICByZXMuY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICBCYWNrYm9uZS5oaXN0b3J5Lm9mZigncm91dGUnLCByb3V0ZUhhbmRsZXIpOwogIH07CgogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIGxvYWREYXRhKGNhbGxiYWNrLCBmYWlsYmFjaywgb3B0aW9ucykgewogIGlmICh0aGlzLmlzUG9wdWxhdGVkKCkpIHsKICAgIHJldHVybiBjYWxsYmFjayh0aGlzKTsKICB9CgogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmICFfLmlzRnVuY3Rpb24oZmFpbGJhY2spICYmIF8uaXNPYmplY3QoZmFpbGJhY2spKSB7CiAgICBvcHRpb25zID0gZmFpbGJhY2s7CiAgICBmYWlsYmFjayA9IGZhbHNlOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZSwKICAgICAgc3VjY2Vzc0NhbGxiYWNrID0gYmluZFRvUm91dGUoXy5iaW5kKGNhbGxiYWNrLCBzZWxmKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICBpZiAoc2VsZi5fcmVxdWVzdCkgewogICAgICAgICAgc2VsZi5fYWJvcnRlZCA9IHRydWU7CiAgICAgICAgICBzZWxmLl9yZXF1ZXN0LmFib3J0KCk7CiAgICAgICAgfQogICAgICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrLmNhbGwoc2VsZiwgZmFsc2UpOwogICAgICB9KTsKCiAgdGhpcy5mZXRjaChfLmRlZmF1bHRzKHsKICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDYWxsYmFjaywKICAgIGVycm9yOiBmYWlsYmFjayAmJiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFyb3V0ZUNoYW5nZWQpIHsKICAgICAgICBmYWlsYmFjay5hcHBseShzZWxmLCBbdHJ1ZV0uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgIH0KICAgIH0sCiAgICBjb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHN1Y2Nlc3NDYWxsYmFjay5jYW5jZWwoKTsKICAgIH0KICB9LCBvcHRpb25zKSk7Cn0KCmZ1bmN0aW9uIGZldGNoUXVldWUob3B0aW9ucywgJHN1cGVyKSB7CiAgaWYgKG9wdGlvbnMucmVzZXRRdWV1ZSkgewogICAgLy8gV0FSTjogU2hvdWxkIGVuc3VyZSB0aGF0IGxvYWRlcnMgYXJlIHByb3RlY3RlZCBmcm9tIG91dCBvZiBiYW5kIGRhdGEKICAgIC8vICAgIHdoZW4gdXNpbmcgdGhpcyBvcHRpb24KICAgIHRoaXMuZmV0Y2hRdWV1ZSA9IHVuZGVmaW5lZDsKICB9CgogIGlmICghdGhpcy5mZXRjaFF1ZXVlKSB7CiAgICAvLyBLaWNrIG9mZiB0aGUgcmVxdWVzdAogICAgdGhpcy5mZXRjaFF1ZXVlID0gW29wdGlvbnNdOwogICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoewogICAgICBzdWNjZXNzOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ3N1Y2Nlc3MnKSwKICAgICAgZXJyb3I6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnZXJyb3InKSwKICAgICAgY29tcGxldGU6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnY29tcGxldGUnKQogICAgfSwgb3B0aW9ucyk7CiAgICAkc3VwZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgLy8gQ3VycmVudGx5IGZldGNoaW5nLiBRdWV1ZSBhbmQgcHJvY2VzcyBvbmNlIGNvbXBsZXRlCiAgICB0aGlzLmZldGNoUXVldWUucHVzaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGZsdXNoUXVldWUoc2VsZiwgZmV0Y2hRdWV1ZSwgaGFuZGxlcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgIC8vIEZsdXNoIHRoZSBxdWV1ZS4gRXhlY3V0ZXMgYW55IGNhbGxiYWNrIGhhbmRsZXJzIHRoYXQKICAgIC8vIG1heSBoYXZlIGJlZW4gcGFzc2VkIGluIHRoZSBmZXRjaCBvcHRpb25zLgogICAgXy5lYWNoKGZldGNoUXVldWUsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnNbaGFuZGxlcl0pIHsKICAgICAgICBvcHRpb25zW2hhbmRsZXJdLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICAvLyBSZXNldCB0aGUgcXVldWUgaWYgd2UgYXJlIHN0aWxsIHRoZSBhY3RpdmUgcmVxdWVzdAogICAgaWYgKHNlbGYuZmV0Y2hRdWV1ZSA9PT0gZmV0Y2hRdWV1ZSkgewogICAgICBzZWxmLmZldGNoUXVldWUgPSB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKdmFyIGtsYXNzZXMgPSBbXTsKVGhvcmF4Lk1vZGVsICYmIGtsYXNzZXMucHVzaChUaG9yYXguTW9kZWwpOwpUaG9yYXguQ29sbGVjdGlvbiAmJiBrbGFzc2VzLnB1c2goVGhvcmF4LkNvbGxlY3Rpb24pOwoKXy5lYWNoKGtsYXNzZXMsIGZ1bmN0aW9uKERhdGFDbGFzcykgewogIHZhciAkZmV0Y2ggPSBEYXRhQ2xhc3MucHJvdG90eXBlLmZldGNoOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKERhdGFDbGFzcy5wcm90b3R5cGUsIGZhbHNlKTsKICBfLmV4dGVuZChEYXRhQ2xhc3MucHJvdG90eXBlLCB7CiAgICBzeW5jOiBUaG9yYXguc3luYywKCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgIGNvbXBsZXRlID0gb3B0aW9ucy5jb21wbGV0ZTsKCiAgICAgIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb21wbGV0ZSAmJiBjb21wbGV0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHNlbGYubG9hZEVuZCgpOwogICAgICB9OwogICAgICBzZWxmLmxvYWRTdGFydCh1bmRlZmluZWQsIG9wdGlvbnMuYmFja2dyb3VuZCk7CiAgICAgIHJldHVybiBmZXRjaFF1ZXVlLmNhbGwodGhpcywgb3B0aW9ucyB8fCB7fSwgJGZldGNoKTsKICAgIH0sCgogICAgbG9hZDogZnVuY3Rpb24oY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmICFfLmlzRnVuY3Rpb24oZmFpbGJhY2spKSB7CiAgICAgICAgb3B0aW9ucyA9IGZhaWxiYWNrOwogICAgICAgIGZhaWxiYWNrID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBpZiAoIW9wdGlvbnMuYmFja2dyb3VuZCAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpICYmIHJvb3RPYmplY3QpIHsKICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgZ2xvYmFsIHNjb3BlIHNlZXMgdGhlIHByb3BlciBsb2FkIGV2ZW50cyBoZXJlCiAgICAgICAgLy8gaWYgd2UgYXJlIGxvYWRpbmcgaW4gc3RhbmRhbG9uZSBtb2RlCiAgICAgICAgVGhvcmF4LmZvcndhcmRMb2FkRXZlbnRzKHRoaXMsIHJvb3RPYmplY3QsIHRydWUpOwogICAgICB9CgogICAgICBsb2FkRGF0YS5jYWxsKHRoaXMsIGNhbGxiYWNrLCBmYWlsYmFjaywgb3B0aW9ucyk7CiAgICB9CiAgfSk7Cn0pOwoKVGhvcmF4LlV0aWwuYmluZFRvUm91dGUgPSBiaW5kVG9Sb3V0ZTsKCmlmIChUaG9yYXguUm91dGVyKSB7CiAgVGhvcmF4LlJvdXRlci5iaW5kVG9Sb3V0ZSA9IFRob3JheC5Sb3V0ZXIucHJvdG90eXBlLmJpbmRUb1JvdXRlID0gYmluZFRvUm91dGU7Cn0KCi8vIFByb3BhZ2F0ZXMgbG9hZGluZyB2aWV3IHBhcmFtZXRlcnMgdG8gdGhlIEFKQVggbGF5ZXIKVGhvcmF4LlZpZXcucHJvdG90eXBlLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyA9IGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICBvcHRpb25zLmlnbm9yZUVycm9ycyA9IHRoaXMuaWdub3JlRmV0Y2hFcnJvcjsKICBvcHRpb25zLmJhY2tncm91bmQgPSB0aGlzLm5vbkJsb2NraW5nTG9hZDsKICByZXR1cm4gb3B0aW9uczsKfTsKCi8vIFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldyBpbmhlcml0cyBmcm9tIENvbGxlY3Rpb25WaWV3Ci8vIG5vdCBIZWxwZXJWaWV3IHNvIG5lZWQgdG8gc2V0IGl0IG1hbnVhbGx5ClRob3JheC5IZWxwZXJWaWV3LnByb3RvdHlwZS5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMgPSBUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcucHJvdG90eXBlLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyA9IGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICBvcHRpb25zLmlnbm9yZUVycm9ycyA9IHRoaXMucGFyZW50Lmlnbm9yZUZldGNoRXJyb3I7CiAgb3B0aW9ucy5iYWNrZ3JvdW5kID0gdGhpcy5wYXJlbnQubm9uQmxvY2tpbmdMb2FkOwogIHJldHVybiBvcHRpb25zOwp9OwoKaW5oZXJpdFZhcnMuY29sbGVjdGlvbi5sb2FkaW5nID0gZnVuY3Rpb24oKSB7CiAgdmFyIGxvYWRpbmdWaWV3ID0gdGhpcy5sb2FkaW5nVmlldywKICAgICAgbG9hZGluZ1RlbXBsYXRlID0gdGhpcy5sb2FkaW5nVGVtcGxhdGUsCiAgICAgIGxvYWRpbmdQbGFjZW1lbnQgPSB0aGlzLmxvYWRpbmdQbGFjZW1lbnQ7CiAgLy9hZGQgImxvYWRpbmctdmlldyIgYW5kICJsb2FkaW5nLXRlbXBsYXRlIiBvcHRpb25zIHRvIGNvbGxlY3Rpb24gaGVscGVyCiAgaWYgKGxvYWRpbmdWaWV3IHx8IGxvYWRpbmdUZW1wbGF0ZSkgewogICAgdmFyIGNhbGxiYWNrID0gVGhvcmF4LmxvYWRIYW5kbGVyKF8uYmluZChmdW5jdGlvbigpIHsKICAgICAgdmFyIGl0ZW07CiAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy4kZWwuZW1wdHkoKTsKICAgICAgfQogICAgICBpZiAobG9hZGluZ1ZpZXcpIHsKICAgICAgICB2YXIgaW5zdGFuY2UgPSBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UobG9hZGluZ1ZpZXcpOwogICAgICAgIHRoaXMuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgICBpZiAobG9hZGluZ1RlbXBsYXRlKSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIobG9hZGluZ1RlbXBsYXRlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgfQogICAgICAgIGl0ZW0gPSBpbnN0YW5jZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpdGVtID0gdGhpcy5yZW5kZXJUZW1wbGF0ZShsb2FkaW5nVGVtcGxhdGUpOwogICAgICB9CiAgICAgIHZhciBpbmRleCA9IGxvYWRpbmdQbGFjZW1lbnQKICAgICAgICA/IGxvYWRpbmdQbGFjZW1lbnQuY2FsbCh0aGlzKQogICAgICAgIDogdGhpcy5jb2xsZWN0aW9uLmxlbmd0aAogICAgICA7CiAgICAgIHRoaXMuYXBwZW5kSXRlbShpdGVtLCBpbmRleCk7CiAgICAgIHRoaXMuJGVsLmNoaWxkcmVuKCkuZXEoaW5kZXgpLmF0dHIoJ2RhdGEtbG9hZGluZy1lbGVtZW50JywgdGhpcy5jb2xsZWN0aW9uLmNpZCk7CiAgICB9LCB0aGlzKSwgXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5maW5kKCdbZGF0YS1sb2FkaW5nLWVsZW1lbnQ9IicgKyB0aGlzLmNvbGxlY3Rpb24uY2lkICsgJyJdJykucmVtb3ZlKCk7CiAgICB9LCB0aGlzKSwKICAgIHRoaXMuY29sbGVjdGlvbik7CgogICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdsb2FkOnN0YXJ0JywgY2FsbGJhY2spOwogIH0KfTsKCmlmIChjb2xsZWN0aW9uT3B0aW9uTmFtZXMpIHsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctdGVtcGxhdGUnXSA9ICdsb2FkaW5nVGVtcGxhdGUnOwogIGNvbGxlY3Rpb25PcHRpb25OYW1lc1snbG9hZGluZy12aWV3J10gPSAnbG9hZGluZ1ZpZXcnOwogIGNvbGxlY3Rpb25PcHRpb25OYW1lc1snbG9hZGluZy1wbGFjZW1lbnQnXSA9ICdsb2FkaW5nUGxhY2VtZW50JzsKfQoKVGhvcmF4LlZpZXcub24oewogICdsb2FkOnN0YXJ0JzogVGhvcmF4LmxvYWRIYW5kbGVyKAogICAgICBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgICB0aGlzLm9uTG9hZFN0YXJ0KG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICAgIHRoaXMub25Mb2FkRW5kKG9iamVjdCk7CiAgICAgIH0pLAoKICBjb2xsZWN0aW9uOiB7CiAgICAnbG9hZDpzdGFydCc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB0aGlzLnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgfQogIH0sCiAgbW9kZWw6IHsKICAgICdsb2FkOnN0YXJ0JzogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHRoaXMudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICB9CiAgfQp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvYWRpbmcnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwogIHZpZXcub2ZmKCdjaGFuZ2U6bG9hZC1zdGF0ZScsIG9uTG9hZFN0YXRlQ2hhbmdlLCB2aWV3KTsKICB2aWV3Lm9uKCdjaGFuZ2U6bG9hZC1zdGF0ZScsIG9uTG9hZFN0YXRlQ2hhbmdlLCB2aWV3KTsKICByZXR1cm4gdmlldy5faXNMb2FkaW5nID8gb3B0aW9ucy5mbih0aGlzKSA6IG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKfSk7CgpmdW5jdGlvbiBvbkxvYWRTdGF0ZUNoYW5nZSgpIHsKICB0aGlzLnJlbmRlcigpOwp9Cjs7Ci8qZ2xvYmFsIHB1c2hEb21FdmVudHMgKi8KdmFyIGlzaU9TID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvKGlQaG9uZXxpUG9kfGlQYWQpL2kpLAogICAgaXNBbmRyb2lkID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoImFuZHJvaWQiKSA+IC0xID8gMSA6IDAsCiAgICBtaW5pbXVtU2Nyb2xsWU9mZnNldCA9IGlzQW5kcm9pZCA/IDEgOiAwOwoKVGhvcmF4LlV0aWwuc2Nyb2xsVG8gPSBmdW5jdGlvbih4LCB5KSB7CiAgeSA9IHkgfHwgbWluaW11bVNjcm9sbFlPZmZzZXQ7CiAgZnVuY3Rpb24gX3Njcm9sbFRvKCkgewogICAgd2luZG93LnNjcm9sbFRvKHgsIHkpOwogIH0KICBpZiAoaXNpT1MpIHsKICAgIC8vIGEgZGVmZXIgaXMgcmVxdWlyZWQgZm9yIGlvcwogICAgXy5kZWZlcihfc2Nyb2xsVG8pOwogIH0gZWxzZSB7CiAgICBfc2Nyb2xsVG8oKTsKICB9CiAgcmV0dXJuIFt4LCB5XTsKfTsKClRob3JheC5MYXlvdXRWaWV3Lm9uKCdjaGFuZ2U6dmlldzplbmQnLCBmdW5jdGlvbihuZXdWaWV3LCBvbGRWaWV3LCBvcHRpb25zKSB7CiAgb3B0aW9ucy5zY3JvbGwgJiYgVGhvcmF4LlV0aWwuc2Nyb2xsVG8oMCwgMCk7Cn0pOwoKVGhvcmF4LlV0aWwuc2Nyb2xsVG9Ub3AgPSBmdW5jdGlvbigpIHsKICAvLyBhbmRyb2lkIHdpbGwgdXNlIGhlaWdodCBvZiAxIGJlY2F1c2Ugb2YgbWluaW11bVNjcm9sbFlPZmZzZXQgaW4gc2Nyb2xsVG8oKQogIHJldHVybiB0aGlzLnNjcm9sbFRvKDAsIDApOwp9OwoKcHVzaERvbUV2ZW50cyhbCiAgJ3NpbmdsZVRhcCcsICdkb3VibGVUYXAnLCAnbG9uZ1RhcCcsCiAgJ3N3aXBlJywKICAnc3dpcGVVcCcsICdzd2lwZURvd24nLAogICdzd2lwZUxlZnQnLCAnc3dpcGVSaWdodCcKXSk7CgovL2J1aWx0IGluIGRvbSBldmVudHMKVGhvcmF4LlZpZXcub24oewogICdzdWJtaXQgZm9ybSc6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CiAgICAvLyBIaWRlIGFueSB2aXJ0dWFsIGtleWJvYXJkcyB0aGF0IG1heSBiZSBsaW5nZXJpbmcgYXJvdW5kCiAgICB2YXIgZm9jdXNlZCA9ICQoJzpmb2N1cycpWzBdOwogICAgZm9jdXNlZCAmJiBmb2N1c2VkLmJsdXIoKTsKICB9Cn0pOwoKOzsKLypnbG9iYWwgaXNBbmRyb2lkICovCgokLmZuLnRhcEhvbGRBbmRFbmQgPSBmdW5jdGlvbihzZWxlY3RvciwgY2FsbGJhY2tTdGFydCwgY2FsbGJhY2tFbmQpIHsKICBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQob2JqLCBldmVudFR5cGUsIGNhbGxiYWNrLCBldmVudCkgewogICAgdmFyIG9yaWdpbmFsVHlwZSA9IGV2ZW50LnR5cGUsCiAgICAgICAgcmVzdWx0OwoKICAgIGV2ZW50LnR5cGUgPSBldmVudFR5cGU7CiAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgcmVzdWx0ID0gY2FsbGJhY2suY2FsbChvYmosIGV2ZW50KTsKICAgIH0KICAgIGV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgdmFyIHRpbWVycyA9IFtdOwogIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICB2YXIgdGhpc09iamVjdCA9IHRoaXMsCiAgICAgICAgdGFwSG9sZFN0YXJ0ID0gZmFsc2UsCiAgICAgICAgJHRoaXMgPSAkKHRoaXNPYmplY3QpOwoKICAgICR0aGlzLm9uKCd0b3VjaHN0YXJ0Jywgc2VsZWN0b3IsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHRhcEhvbGRTdGFydCA9IGZhbHNlOwogICAgICB2YXIgb3JpZ0V2ZW50ID0gZXZlbnQsCiAgICAgICAgICB0aW1lcjsKCiAgICAgIGZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoZXZlbnQpIHsKICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwoKICAgICAgICBpZiAodGFwSG9sZFN0YXJ0KSB7CiAgICAgICAgICB2YXIgcmV0dmFsID0gZmFsc2U7CiAgICAgICAgICBpZiAoZXZlbnQpIHsKICAgICAgICAgICAgLy8gV2UgYXJlbid0IHNlbmRpbmcgYW55IGVuZCBldmVudHMgZm9yIHRvdWNoY2FuY2VsIGNhc2VzLAogICAgICAgICAgICAvLyBwcmV2ZW50IGFuIGV4Y2VwdGlvbgogICAgICAgICAgICByZXR2YWwgPSB0cmlnZ2VyRXZlbnQodGhpc09iamVjdCwgJ3RhcEhvbGRFbmQnLCBjYWxsYmFja0VuZCwgZXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHZhbCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgXy5lYWNoKHRpbWVycywgY2xlYXJUaW1lb3V0KTsKICAgICAgICAgICAgdGltZXJzID0gW107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAkKGRvY3VtZW50KS5vbmUoJ3RvdWNoY2FuY2VsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYXJUYXBUaW1lcigpOwoKICAgICAgICAkdGhpcy5vZmYoJ3RvdWNobW92ZScsIHNlbGVjdG9yLCBjbGVhclRhcFRpbWVyKTsKICAgICAgICAkdGhpcy5vZmYoJ3RvdWNoZW5kJywgc2VsZWN0b3IsIGNsZWFyVGFwVGltZXIpOwogICAgICB9KTsKCiAgICAgICR0aGlzLm9uKCd0b3VjaGVuZCcsIHNlbGVjdG9yLCBjbGVhclRhcFRpbWVyKTsKICAgICAgJHRoaXMub24oJ3RvdWNobW92ZScsIHNlbGVjdG9yLCBjbGVhclRhcFRpbWVyKTsKCiAgICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICB0YXBIb2xkU3RhcnQgPSB0cnVlOwogICAgICAgIHZhciByZXR2YWwgPSB0cmlnZ2VyRXZlbnQodGhpc09iamVjdCwgJ3RhcEhvbGRTdGFydCcsIGNhbGxiYWNrU3RhcnQsIG9yaWdFdmVudCk7CiAgICAgICAgaWYgKHJldHZhbCA9PT0gZmFsc2UpIHsKICAgICAgICAgIF8uZWFjaCh0aW1lcnMsIGNsZWFyVGltZW91dCk7CiAgICAgICAgICB0aW1lcnMgPSBbXTsKICAgICAgICB9CiAgICAgIH0sIDE1MCk7CiAgICAgIHRpbWVycy5wdXNoKHRpbWVyKTsKICAgIH0pOwogIH0pOwp9OwoKLy9vbmx5IGVuYWJsZSBvbiBhbmRyb2lkCnZhciB1c2VOYXRpdmVIaWdobGlnaHQgPSAhaXNBbmRyb2lkOwpUaG9yYXguY29uZmlndXJlVGFwSGlnaGxpZ2h0ID0gZnVuY3Rpb24odXNlTmF0aXZlKSB7CiAgdXNlTmF0aXZlSGlnaGxpZ2h0ID0gdXNlTmF0aXZlOwp9OwoKdmFyIE5BVElWRV9UQVBQQUJMRSA9IHsKICAnQSc6IHRydWUsCiAgJ0lOUFVUJzogdHJ1ZSwKICAnQlVUVE9OJzogdHJ1ZSwKICAnU0VMRUNUJzogdHJ1ZSwKICAnVEVYVEFSRUEnOiB0cnVlCn07CgpmdW5jdGlvbiBmaXh1cFRhcEhpZ2hsaWdodChzY29wZSkgewogIF8uZWFjaCh0aGlzLl9kb21FdmVudHMgfHwgW10sIGZ1bmN0aW9uKGJpbmQpIHsKICAgIHZhciBjb21wb25lbnRzID0gYmluZC5zcGxpdCgnICcpLAogICAgICAgIHNlbGVjdG9yID0gY29tcG9uZW50cy5zbGljZSgxKS5qb2luKCcgJykgfHwgdW5kZWZpbmVkOyAgLy8gTmVlZGVkIHRvIG1ha2UgemVwdG8gaGFwcHkKCiAgICBpZiAoY29tcG9uZW50c1swXSA9PT0gJ2NsaWNrJykgewogICAgICAvLyAhc2VsZWN0b3IgY2FzZSBpcyBmb3Igcm9vdCBjbGljayBoYW5kbGVycyBvbiB0aGUgdmlldywgaS5lLiAnY2xpY2snCiAgICAgICQoc2VsZWN0b3IgfHwgdGhpcy5lbCwgc2VsZWN0b3IgJiYgKHNjb3BlIHx8IHRoaXMuZWwpKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyICRlbCA9ICQoZWwpLmRhdGEoJ3RhcHBhYmxlJywgdHJ1ZSk7CgogICAgICAgIGlmICh1c2VOYXRpdmVIaWdobGlnaHQgJiYgIU5BVElWRV9UQVBQQUJMRVtlbC50YWdOYW1lXSkgewogICAgICAgICAgLy8gQWRkIGFuIGV4cGxpY2l0IE5PUCBiaW5kIHRvIGFsbG93IHRhcC1oaWdobGlnaHQgc3VwcG9ydAogICAgICAgICAgJGVsLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge30pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgdGhpcyk7Cn0KCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIF90YXBIaWdobGlnaHRDbGFzc05hbWU6ICdhY3RpdmUnLAogIF90YXBIaWdobGlnaHRTdGFydDogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSBldmVudC5jdXJyZW50VGFyZ2V0LAogICAgICAgIHRhZ05hbWUgPSB0YXJnZXQgJiYgdGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCiAgICAvLyBVc2VyIGlucHV0IGNvbnRyb2xzIG1heSBiZSB2aXN1YWxseSBwYXJ0IG9mIGEgbGFyZ2VyIGdyb3VwLiBGb3IgdGhlc2UgY2FzZXMKICAgIC8vIHdlIHdhbnQgdG8gZ2l2ZSBwcmlvcml0eSB0byBhbnkgcGFyZW50IHRoYXQgbWF5IHByb3ZpZGUgYSBmb2N1cyBvcGVyYXRpb24uCiAgICBpZiAodGFnTmFtZSA9PT0gJ2lucHV0JyB8fCB0YWdOYW1lID09PSAnc2VsZWN0JyB8fCB0YWdOYW1lID09PSAndGV4dGFyZWEnKSB7CiAgICAgIHRhcmdldCA9ICQodGFyZ2V0KS5jbG9zZXN0KCdbZGF0YS10YXBwYWJsZT10cnVlXScpWzBdIHx8IHRhcmdldDsKICAgIH0KCiAgICBpZiAodGFyZ2V0KSB7CiAgICAgICQodGFyZ2V0KS5hZGRDbGFzcyh0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKICBfdGFwSGlnaGxpZ2h0RW5kOiBmdW5jdGlvbigvKiBldmVudCAqLykgewogICAgJCgnLicgKyB0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpLnJlbW92ZUNsYXNzKHRoaXMuX3RhcEhpZ2hsaWdodENsYXNzTmFtZSk7CiAgfQp9KTsKCi8vVE9ETzogZXhhbWluZSBpZiB0aGVzZSBhcmUgc3RpbGwgbmVlZGVkCnZhciBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgZml4dXBUYXBIaWdobGlnaHQuY2FsbCh0aGlzKTsKfTsKClRob3JheC5WaWV3Lm9uKHsKICAncmVuZGVyZWQnOiBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrLAogICdyZW5kZXJlZDpjb2xsZWN0aW9uJzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjaywKICAncmVuZGVyZWQ6aXRlbSc6IGZpeHVwVGFwSGlnaGxpZ2h0Q2FsbGJhY2ssCiAgJ3JlbmRlcmVkOmVtcHR5JzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjawp9KTsKCnZhciBfc2V0RWxlbWVudCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50LAogICAgdGFwSGlnaGxpZ2h0U2VsZWN0b3IgPSAnW2RhdGEtdGFwcGFibGU9dHJ1ZV0sIGEsIGlucHV0LCBidXR0b24sIHNlbGVjdCwgdGV4dGFyZWEnOwoKVGhvcmF4LlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQgPSBmdW5jdGlvbigpIHsKICB2YXIgcmVzcG9uc2UgPSBfc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmICghdGhpcy5ub1RhcEhpZ2hsaWdodCkgewogICAgaWYgKCF1c2VOYXRpdmVIaWdobGlnaHQpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBmdW5jdGlvbiBleGVjKG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZWxmW25hbWVdLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKG5hbWUsIGUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgdGhpcy4kZWwudGFwSG9sZEFuZEVuZCh0YXBIaWdobGlnaHRTZWxlY3RvciwgZXhlYygnX3RhcEhpZ2hsaWdodFN0YXJ0JyksIGV4ZWMoJ190YXBIaWdobGlnaHRFbmQnKSk7CiAgICB9CiAgfQogIHJldHVybiByZXNwb25zZTsKfTsKCnZhciBfYWRkRXZlbnQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2FkZEV2ZW50OwpUaG9yYXguVmlldy5wcm90b3R5cGUuX2FkZEV2ZW50ID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgdGhpcy5fZG9tRXZlbnRzID0gdGhpcy5fZG9tRXZlbnRzIHx8IFtdOwogIGlmIChwYXJhbXMudHlwZSA9PT0gIkRPTSIpIHsKICAgIHRoaXMuX2RvbUV2ZW50cy5wdXNoKHBhcmFtcy5vcmlnaW5hbE5hbWUpOwogIH0KICByZXR1cm4gX2FkZEV2ZW50LmNhbGwodGhpcywgcGFyYW1zKTsKfTsKCjs7CgoKfSkoKTsKCg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 03:54:59 GMT",
                    "Content-Length": "292972",
                    "Date": "Sat, 08 Nov 2014 03:55:35 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}