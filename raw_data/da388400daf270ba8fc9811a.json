{
    "url": "http://localhost:9999/fex-team/ueditor/_test/tools/br/js/UserAction.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>the 'source' property of a DOM element</b> via the following statements:<ul><li>var srcpath = location.href.split(\"/_test/\")[0]             + \"/_test/tools/br/import.php\";</li><li>sc.src = srcpath + \"?f=\" + param0 + \"&amp;e=\" + param1;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/fex-team/ueditor/_test/tools/br/js/UserAction.js",
                "path": "/fex-team/ueditor/_test/tools/br/js/UserAction.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9mZXgtdGVhbS91ZWRpdG9yL190ZXN0L3Rvb2xzL2JyL2pzL1VzZXJBY3Rpb24uanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNzAxMzMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDA6MzE6MjEgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAwOjMxOjIwIEdNVA0KDQovKioKICog5rWL6K+V55So5L6L5bqT5paH5Lu277yM5o+Q5L6b5aaCZXZlbnQgbW9ja+OAgWlmcmFtZeWwgeijheetieWQhOenjeW4uOeUqOWKn+iDvSDpg6jliIbmlrnms5XmnaXmupDkuo5ZVUnmtYvor5XmoYbmnrYKICovClVzZXJBY3Rpb24gPSB7CiAgICBiZWZvcmVkaXNwYXRjaDpudWxsLAovLyAgICBmbGFnIDogdHJ1ZSwKICAgIGlzZiAvKiBpcyBmdW5jdGlvbiA/ICovOmZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSAmJiAodHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbicpOwogICAgfSwKICAgIGlzYiAvKiBpcyBib29sZWFuPyAqLzpmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgJiYgKHR5cGVvZiB2YWx1ZSA9PSAnYm9vbGVhbicpOwogICAgfSwKICAgIGlzbyAvKiBpcyBvYmplY3Q/ICovOmZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSAmJiAodHlwZW9mIHZhbHVlID09ICdvYmplY3QnKTsKICAgIH0sCiAgICBpc3MgLyogaXMgc3RyaW5nPyAqLzpmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgJiYgKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyk7CiAgICB9LAogICAgaXNuIC8qIGlzIG51bWJlcj8gKi86ZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlICYmICh0eXBlb2YgdmFsdWUgPT0gJ251bWJlcicpOwogICAgfSwKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBHZW5lcmljIGV2ZW50IG1ldGhvZHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBrZXkgZXZlbnQgdXNpbmcgdGhlIGdpdmVuIGV2ZW50IGluZm9ybWF0aW9uIHRvIHBvcHVsYXRlIHRoZQogICAgICogZ2VuZXJhdGVkIGV2ZW50IG9iamVjdC4gVGhpcyBtZXRob2QgZG9lcyBicm93c2VyLWVxdWFsaXppbmcgY2FsY3VsYXRpb25zCiAgICAgKiB0byBhY2NvdW50IGZvciBkaWZmZXJlbmNlcyBpbiB0aGUgRE9NIGFuZCBJRSBldmVudCBtb2RlbHMgYXMgd2VsbCBhcwogICAgICogZGlmZmVyZW50IGJyb3dzZXIgcXVpcmtzLiBOb3RlOiBrZXlkb3duIGNhdXNlcyBTYWZhcmkgMi54IHRvIGNyYXNoLgogICAgICoKICAgICAqIEBtZXRob2Qgc2ltdWxhdGVLZXlFdmVudAogICAgICogQHByaXZhdGUKICAgICAqIEBzdGF0aWMKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgdGFyZ2V0IG9mIHRoZSBnaXZlbiBldmVudC4KICAgICAqIEBwYXJhbSB7U3RyaW5nfQogICAgICAgICogICAgICAgICAgICB0eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRvIGZpcmUuIFRoaXMgY2FuIGJlIGFueSBvbmUgb2YgdGhlCiAgICAgKiAgICAgICAgICAgIGZvbGxvd2luZzoga2V5dXAsIGtleWRvd24sIGFuZCBrZXlwcmVzcy4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0KICAgICAgICAqICAgICAgICAgICAgYnViYmxlcyAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiB0aGUgZXZlbnQgY2FuIGJlIGJ1YmJsZWQgdXAuCiAgICAgKiAgICAgICAgICAgIERPTSBMZXZlbCAzIHNwZWNpZmllcyB0aGF0IGFsbCBrZXkgZXZlbnRzIGJ1YmJsZSBieSBkZWZhdWx0LgogICAgICogICAgICAgICAgICBUaGUgZGVmYXVsdCBpcyB0cnVlLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBjYW5jZWxhYmxlIChPcHRpb25hbCkgSW5kaWNhdGVzIGlmIHRoZSBldmVudCBjYW4gYmUgY2FuY2VsZWQKICAgICAqICAgICAgICAgICAgdXNpbmcgcHJldmVudERlZmF1bHQoKS4gRE9NIExldmVsIDMgc3BlY2lmaWVzIHRoYXQgYWxsIGtleQogICAgICogICAgICAgICAgICBldmVudHMgY2FuIGJlIGNhbmNlbGxlZC4gVGhlIGRlZmF1bHQgaXMgdHJ1ZS4KICAgICAqIEBwYXJhbSB7V2luZG93fQogICAgICAgICogICAgICAgICAgICB2aWV3IChPcHRpb25hbCkgVGhlIHZpZXcgY29udGFpbmluZyB0aGUgdGFyZ2V0LiBUaGlzIGlzCiAgICAgKiAgICAgICAgICAgIHR5cGljYWxseSB0aGUgd2luZG93IG9iamVjdC4gVGhlIGRlZmF1bHQgaXMgd2luZG93LgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBjdHJsS2V5IChPcHRpb25hbCkgSW5kaWNhdGVzIGlmIG9uZSBvZiB0aGUgQ1RSTCBrZXlzIGlzCiAgICAgKiAgICAgICAgICAgIHByZXNzZWQgd2hpbGUgdGhlIGV2ZW50IGlzIGZpcmluZy4gVGhlIGRlZmF1bHQgaXMgZmFsc2UuCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59CiAgICAgICAgKiAgICAgICAgICAgIGFsdEtleSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiBvbmUgb2YgdGhlIEFMVCBrZXlzIGlzIHByZXNzZWQKICAgICAqICAgICAgICAgICAgd2hpbGUgdGhlIGV2ZW50IGlzIGZpcmluZy4gVGhlIGRlZmF1bHQgaXMgZmFsc2UuCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59CiAgICAgICAgKiAgICAgICAgICAgIHNoaWZ0S2V5IChPcHRpb25hbCkgSW5kaWNhdGVzIGlmIG9uZSBvZiB0aGUgU0hJRlQga2V5cyBpcwogICAgICogICAgICAgICAgICBwcmVzc2VkIHdoaWxlIHRoZSBldmVudCBpcyBmaXJpbmcuIFRoZSBkZWZhdWx0IGlzIGZhbHNlLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBtZXRhS2V5IChPcHRpb25hbCkgSW5kaWNhdGVzIGlmIG9uZSBvZiB0aGUgTUVUQSBrZXlzIGlzCiAgICAgKiAgICAgICAgICAgIHByZXNzZWQgd2hpbGUgdGhlIGV2ZW50IGlzIGZpcmluZy4gVGhlIGRlZmF1bHQgaXMgZmFsc2UuCiAgICAgKiBAcGFyYW0ge2ludH0KICAgICAgICAqICAgICAgICAgICAga2V5Q29kZSAoT3B0aW9uYWwpIFRoZSBjb2RlIGZvciB0aGUga2V5IHRoYXQgaXMgaW4gdXNlLiBUaGUKICAgICAqICAgICAgICAgICAgZGVmYXVsdCBpcyAwLgogICAgICogQHBhcmFtIHtpbnR9CiAgICAgICAgKiAgICAgICAgICAgIGNoYXJDb2RlIChPcHRpb25hbCkgVGhlIFVuaWNvZGUgY29kZSBmb3IgdGhlIGNoYXJhY3RlcgogICAgICogICAgICAgICAgICBhc3NvY2lhdGVkIHdpdGggdGhlIGtleSBiZWluZyB1c2VkLiBUaGUgZGVmYXVsdCBpcyAwLgogICAgICovCiAgICBzaW11bGF0ZUtleUV2ZW50OmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCB0eXBlIC8qIDpTdHJpbmcgKi8sIGJ1YmJsZXMgLyogOkJvb2xlYW4gKi8sIGNhbmNlbGFibGUgLyogOkJvb2xlYW4gKi8sIHZpZXcgLyogOldpbmRvdyAqLywgY3RybEtleSAvKiA6Qm9vbGVhbiAqLywgYWx0S2V5IC8qIDpCb29sZWFuICovLCBzaGlmdEtleSAvKiA6Qm9vbGVhbiAqLywgbWV0YUtleSAvKiA6Qm9vbGVhbiAqLywga2V5Q29kZSAvKiA6aW50ICovLCBjaGFyQ29kZSAvKiA6aW50ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgLy8gY2hlY2sgdGFyZ2V0CiAgICAgICAgdGFyZ2V0ID0gdHlwZW9mIHRhcmdldCA9PSAnc3RyaW5nJyA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRhcmdldCkKICAgICAgICAgICAgOiB0YXJnZXQ7CiAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzaW11bGF0ZUtleUV2ZW50KCk6IEludmFsaWQgdGFyZ2V0LiIpOwogICAgICAgIH0KCiAgICAgICAgLy8gY2hlY2sgZXZlbnQgdHlwZQogICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PSAnc3RyaW5nJykgewogICAgICAgICAgICB0eXBlID0gdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICAgICAgY2FzZSAiY3V0IjoKICAgICAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidGV4dGV2ZW50IjogLy8gRE9NIExldmVsIDMKICAgICAgICAgICAgICAgICAgICB0eXBlID0gImtleXByZXNzIjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIC8vIEBUT0RPIHdhcyB0aGUgZmFsbHRocm91Z2ggaW50ZW50aW9uYWwsIGlmIHNvIHRocm93IGVycm9yCiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2ltdWxhdGVLZXlFdmVudCgpOiBFdmVudCB0eXBlICciICsgdHlwZQogICAgICAgICAgICAgICAgICAgICAgICArICInIG5vdCBzdXBwb3J0ZWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNpbXVsYXRlS2V5RXZlbnQoKTogRXZlbnQgdHlwZSBtdXN0IGJlIGEgc3RyaW5nLiIpOwogICAgICAgIH0KCiAgICAgICAgLy8gc2V0dXAgZGVmYXVsdCB2YWx1ZXMKICAgICAgICBpZiAoIXRoaXMuaXNiKGJ1YmJsZXMpKSB7CiAgICAgICAgICAgIGJ1YmJsZXMgPSB0cnVlOyAvLyBhbGwga2V5IGV2ZW50cyBidWJibGUKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzYihjYW5jZWxhYmxlKSkgewogICAgICAgICAgICBjYW5jZWxhYmxlID0gdHJ1ZTsgLy8gYWxsIGtleSBldmVudHMgY2FuIGJlIGNhbmNlbGxlZAogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNvKHZpZXcpKSB7CiAgICAgICAgICAgIHZpZXcgPSB3aW5kb3c7IC8vIHZpZXcgaXMgdHlwaWNhbGx5IHdpbmRvdwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNiKGN0cmxLZXkpKSB7CiAgICAgICAgICAgIGN0cmxLZXkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzYih0eXBlb2YgYWx0S2V5ID09ICdib29sZWFuJykpIHsKICAgICAgICAgICAgYWx0S2V5ID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5pc2Ioc2hpZnRLZXkpKSB7CiAgICAgICAgICAgIHNoaWZ0S2V5ID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5pc2IobWV0YUtleSkpIHsKICAgICAgICAgICAgbWV0YUtleSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoISh0eXBlb2Yga2V5Q29kZSA9PSAnbnVtYmVyJykpIHsKICAgICAgICAgICAga2V5Q29kZSA9IDA7CiAgICAgICAgfQogICAgICAgIGlmICghKHR5cGVvZiBjaGFyQ29kZSA9PSAnbnVtYmVyJykpIHsKICAgICAgICAgICAgY2hhckNvZGUgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gdHJ5IHRvIGNyZWF0ZSBhIG1vdXNlIGV2ZW50CiAgICAgICAgdmFyIGN1c3RvbUV2ZW50IC8qIDpNb3VzZUV2ZW50ICovID0gbnVsbDsKCiAgICAgICAgLy8gY2hlY2sgZm9yIERPTS1jb21wbGlhbnQgYnJvd3NlcnMgZmlyc3QKICAgICAgICBpZiAodGhpcy5pc2YoZG9jdW1lbnQuY3JlYXRlRXZlbnQpKSB7CgogICAgICAgICAgICB0cnkgewoKICAgICAgICAgICAgICAgIC8vIHRyeSB0byBjcmVhdGUga2V5IGV2ZW50CiAgICAgICAgICAgICAgICBjdXN0b21FdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJLZXlFdmVudHMiKTsKCiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogSW50ZXJlc3RpbmcgcHJvYmxlbTogRmlyZWZveCBpbXBsZW1lbnRlZCBhIG5vbi1zdGFuZGFyZAogICAgICAgICAgICAgICAgICogdmVyc2lvbiBvZiBpbml0S2V5RXZlbnQoKSBiYXNlZCBvbiBET00gTGV2ZWwgMiBzcGVjcy4gS2V5CiAgICAgICAgICAgICAgICAgKiBldmVudCB3YXMgcmVtb3ZlZCBmcm9tIERPTSBMZXZlbCAyIGFuZCByZS1pbnRyb2R1Y2VkIGluIERPTQogICAgICAgICAgICAgICAgICogTGV2ZWwgMyB3aXRoIGEgZGlmZmVyZW50IGludGVyZmFjZS4gRmlyZWZveCBpcyB0aGUgb25seQogICAgICAgICAgICAgICAgICogYnJvd3NlciB3aXRoIGFueSBpbXBsZW1lbnRhdGlvbiBvZiBLZXkgRXZlbnRzLCBzbyBmb3Igbm93LAogICAgICAgICAgICAgICAgICogYXNzdW1lIGl0J3MgRmlyZWZveCBpZiB0aGUgYWJvdmUgbGluZSBkb2Vzbid0IGVycm9yLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWNpcGhlciBiZXR3ZWVuIEZpcmVmb3gncyBpbXBsZW1lbnRhdGlvbiBhbmQgYSBjb3JyZWN0CiAgICAgICAgICAgICAgICAvLyBvbmUuCiAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5pbml0S2V5RXZlbnQodHlwZSwgYnViYmxlcywgY2FuY2VsYWJsZSwgdmlldywKICAgICAgICAgICAgICAgICAgICBjdHJsS2V5LCBhbHRLZXksIHNoaWZ0S2V5LCBtZXRhS2V5LCBrZXlDb2RlLCBjaGFyQ29kZSk7CgogICAgICAgICAgICB9IGNhdGNoIChleCAvKiA6RXJyb3IgKi8pIHsKCiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogSWYgaXQgZ290IGhlcmUsIHRoYXQgbWVhbnMga2V5IGV2ZW50cyBhcmVuJ3Qgb2ZmaWNpYWxseQogICAgICAgICAgICAgICAgICogc3VwcG9ydGVkLiBTYWZhcmkvV2ViS2l0IGlzIGEgcmVhbCBwcm9ibGVtIG5vdy4gV2ViS2l0IDUyMgogICAgICAgICAgICAgICAgICogd29uJ3QgbGV0IHlvdSBzZXQga2V5Q29kZSwgY2hhckNvZGUsIG9yIG90aGVyIHByb3BlcnRpZXMgaWYKICAgICAgICAgICAgICAgICAqIHlvdSB1c2UgYSBVSUV2ZW50LCBzbyB3ZSBmaXJzdCBtdXN0IHRyeSB0byBjcmVhdGUgYSBnZW5lcmljCiAgICAgICAgICAgICAgICAgKiBldmVudC4gVGhlIGZ1biBwYXJ0IGlzIHRoYXQgdGhpcyB3aWxsIHRocm93IGFuIGVycm9yIG9uCiAgICAgICAgICAgICAgICAgKiBTYWZhcmkgMi54LiBUaGUgZW5kIHJlc3VsdCBpcyB0aGF0IHdlIG5lZWQgYW5vdGhlcgogICAgICAgICAgICAgICAgICogdHJ5Li4uY2F0Y2ggc3RhdGVtZW50IGp1c3QgdG8gZGVhbCB3aXRoIHRoaXMgbWVzcy4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHRvIGNyZWF0ZSBnZW5lcmljIGV2ZW50IC0gd2lsbCBmYWlsIGluIFNhZmFyaSAyLngKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJFdmVudHMiKTsKCiAgICAgICAgICAgICAgICB9IGNhdGNoICh1aWVycm9yIC8qIDpFcnJvciAqLykgewoKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgYWJvdmUgZmFpbGVkLCBzbyBjcmVhdGUgYSBVSUV2ZW50IGZvciBTYWZhcmkgMi54CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiVUlFdmVudHMiKTsKCiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewoKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5pbml0RXZlbnQodHlwZSwgYnViYmxlcywgY2FuY2VsYWJsZSk7CgogICAgICAgICAgICAgICAgICAgIC8vIGluaXRpYWxpemUKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC52aWV3ID0gdmlldzsKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5hbHRLZXkgPSBhbHRLZXk7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuY3RybEtleSA9IGN0cmxLZXk7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuc2hpZnRLZXkgPSBzaGlmdEtleTsKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5tZXRhS2V5ID0gbWV0YUtleTsKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5rZXlDb2RlID0ga2V5Q29kZTsKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5jaGFyQ29kZSA9IGNoYXJDb2RlOwoKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGJlZm9yZSBkaXNwYXRjaAogICAgICAgICAgICBpZiAodGhpcy5iZWZvcmVkaXNwYXRjaCAmJiB0eXBlb2YgdGhpcy5iZWZvcmVkaXNwYXRjaCA9PSAnZnVuY3Rpb24nKQogICAgICAgICAgICAgICAgdGhpcy5iZWZvcmVkaXNwYXRjaChjdXN0b21FdmVudCk7CiAgICAgICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPSBudWxsOwoKICAgICAgICAgICAgLy8gZmlyZSB0aGUgZXZlbnQKICAgICAgICAgICAgdGFyZ2V0LmRpc3BhdGNoRXZlbnQoY3VzdG9tRXZlbnQpOwoKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNvKGRvY3VtZW50LmNyZWF0ZUV2ZW50T2JqZWN0KSkgeyAvLyBJRQoKICAgICAgICAgICAgLy8gY3JlYXRlIGFuIElFIGV2ZW50IG9iamVjdAogICAgICAgICAgICBjdXN0b21FdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50T2JqZWN0KCk7CgogICAgICAgICAgICAvLyBhc3NpZ24gYXZhaWxhYmxlIHByb3BlcnRpZXMKICAgICAgICAgICAgY3VzdG9tRXZlbnQuYnViYmxlcyA9IGJ1YmJsZXM7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmNhbmNlbGFibGUgPSBjYW5jZWxhYmxlOwogICAgICAgICAgICBjdXN0b21FdmVudC52aWV3ID0gdmlldzsKICAgICAgICAgICAgY3VzdG9tRXZlbnQuY3RybEtleSA9IGN0cmxLZXk7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmFsdEtleSA9IGFsdEtleTsKICAgICAgICAgICAgY3VzdG9tRXZlbnQuc2hpZnRLZXkgPSBzaGlmdEtleTsKICAgICAgICAgICAgY3VzdG9tRXZlbnQubWV0YUtleSA9IG1ldGFLZXk7CgogICAgICAgICAgICAvKgogICAgICAgICAgICAgKiBJRSBkb2Vzbid0IHN1cHBvcnQgY2hhckNvZGUgZXhwbGljaXRseS4gQ2hhckNvZGUgc2hvdWxkIHRha2UKICAgICAgICAgICAgICogcHJlY2VkZW5jZSBvdmVyIGFueSBrZXlDb2RlIHZhbHVlIGZvciBhY2N1cmF0ZSByZXByZXNlbnRhdGlvbi4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmtleUNvZGUgPSAoY2hhckNvZGUgPiAwKSA/IGNoYXJDb2RlIDoga2V5Q29kZTsKCiAgICAgICAgICAgIC8vIGJlZm9yZSBkaXNwYXRjaAogICAgICAgICAgICBpZiAodGhpcy5iZWZvcmVkaXNwYXRjaCAmJiB0eXBlb2YgdGhpcy5iZWZvcmVkaXNwYXRjaCA9PSAnZnVuY3Rpb24nKQogICAgICAgICAgICAgICAgdGhpcy5iZWZvcmVkaXNwYXRjaChjdXN0b21FdmVudCk7CiAgICAgICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPSBudWxsOwoKICAgICAgICAgICAgLy8gZmlyZSB0aGUgZXZlbnQKICAgICAgICAgICAgdGFyZ2V0LmZpcmVFdmVudCgib24iICsgdHlwZSwgY3VzdG9tRXZlbnQpOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAic2ltdWxhdGVLZXlFdmVudCgpOiBObyBldmVudCBzaW11bGF0aW9uIGZyYW1ld29yayBwcmVzZW50LiIpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5iZWZvcmVkaXNwYXRjaCA9IG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgbW91c2UgZXZlbnQgdXNpbmcgdGhlIGdpdmVuIGV2ZW50IGluZm9ybWF0aW9uIHRvIHBvcHVsYXRlIHRoZQogICAgICogZ2VuZXJhdGVkIGV2ZW50IG9iamVjdC4gVGhpcyBtZXRob2QgZG9lcyBicm93c2VyLWVxdWFsaXppbmcgY2FsY3VsYXRpb25zCiAgICAgKiB0byBhY2NvdW50IGZvciBkaWZmZXJlbmNlcyBpbiB0aGUgRE9NIGFuZCBJRSBldmVudCBtb2RlbHMgYXMgd2VsbCBhcwogICAgICogZGlmZmVyZW50IGJyb3dzZXIgcXVpcmtzLgogICAgICoKICAgICAqIEBtZXRob2Qgc2ltdWxhdGVNb3VzZUV2ZW50CiAgICAgKiBAcHJpdmF0ZQogICAgICogQHN0YXRpYwogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSB0YXJnZXQgb2YgdGhlIGdpdmVuIGV2ZW50LgogICAgICogQHBhcmFtIHtTdHJpbmd9CiAgICAgICAgKiAgICAgICAgICAgIHR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdG8gZmlyZS4gVGhpcyBjYW4gYmUgYW55IG9uZSBvZiB0aGUKICAgICAqICAgICAgICAgICAgZm9sbG93aW5nOiBjbGljaywgZGJsY2xpY2ssIG1vdXNlZG93biwgbW91c2V1cCwgbW91c2VvdXQsCiAgICAgKiAgICAgICAgICAgIG1vdXNlb3ZlciwgYW5kIG1vdXNlbW92ZS4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0KICAgICAgICAqICAgICAgICAgICAgYnViYmxlcyAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiB0aGUgZXZlbnQgY2FuIGJlIGJ1YmJsZWQgdXAuCiAgICAgKiAgICAgICAgICAgIERPTSBMZXZlbCAyIHNwZWNpZmllcyB0aGF0IGFsbCBtb3VzZSBldmVudHMgYnViYmxlIGJ5IGRlZmF1bHQuCiAgICAgKiAgICAgICAgICAgIFRoZSBkZWZhdWx0IGlzIHRydWUuCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59CiAgICAgICAgKiAgICAgICAgICAgIGNhbmNlbGFibGUgKE9wdGlvbmFsKSBJbmRpY2F0ZXMgaWYgdGhlIGV2ZW50IGNhbiBiZSBjYW5jZWxlZAogICAgICogICAgICAgICAgICB1c2luZyBwcmV2ZW50RGVmYXVsdCgpLiBET00gTGV2ZWwgMiBzcGVjaWZpZXMgdGhhdCBhbGwgbW91c2UKICAgICAqICAgICAgICAgICAgZXZlbnRzIGV4Y2VwdCBtb3VzZW1vdmUgY2FuIGJlIGNhbmNlbGxlZC4gVGhlIGRlZmF1bHQgaXMgdHJ1ZQogICAgICogICAgICAgICAgICBmb3IgYWxsIGV2ZW50cyBleGNlcHQgbW91c2Vtb3ZlLCBmb3Igd2hpY2ggdGhlIGRlZmF1bHQgaXMKICAgICAqICAgICAgICAgICAgZmFsc2UuCiAgICAgKiBAcGFyYW0ge1dpbmRvd30KICAgICAgICAqICAgICAgICAgICAgdmlldyAoT3B0aW9uYWwpIFRoZSB2aWV3IGNvbnRhaW5pbmcgdGhlIHRhcmdldC4gVGhpcyBpcwogICAgICogICAgICAgICAgICB0eXBpY2FsbHkgdGhlIHdpbmRvdyBvYmplY3QuIFRoZSBkZWZhdWx0IGlzIHdpbmRvdy4KICAgICAqIEBwYXJhbSB7aW50fQogICAgICAgICogICAgICAgICAgICBkZXRhaWwgKE9wdGlvbmFsKSBUaGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBtb3VzZSBidXR0b24gaGFzCiAgICAgKiAgICAgICAgICAgIGJlZW4gdXNlZC4gVGhlIGRlZmF1bHQgdmFsdWUgaXMgMS4KICAgICAqIEBwYXJhbSB7aW50fQogICAgICAgICogICAgICAgICAgICBzY3JlZW5YIChPcHRpb25hbCkgVGhlIHgtY29vcmRpbmF0ZSBvbiB0aGUgc2NyZWVuIGF0IHdoaWNoCiAgICAgKiAgICAgICAgICAgIHBvaW50IHRoZSBldmVudCBvY2N1cmVkLiBUaGUgZGVmYXVsdCBpcyAwLgogICAgICogQHBhcmFtIHtpbnR9CiAgICAgICAgKiAgICAgICAgICAgIHNjcmVlblkgKE9wdGlvbmFsKSBUaGUgeS1jb29yZGluYXRlIG9uIHRoZSBzY3JlZW4gYXQgd2hpY2gKICAgICAqICAgICAgICAgICAgcG9pbnQgdGhlIGV2ZW50IG9jY3VyZWQuIFRoZSBkZWZhdWx0IGlzIDAuCiAgICAgKiBAcGFyYW0ge2ludH0KICAgICAgICAqICAgICAgICAgICAgY2xpZW50WCAoT3B0aW9uYWwpIFRoZSB4LWNvb3JkaW5hdGUgb24gdGhlIGNsaWVudCBhdCB3aGljaAogICAgICogICAgICAgICAgICBwb2ludCB0aGUgZXZlbnQgb2NjdXJlZC4gVGhlIGRlZmF1bHQgaXMgMC4KICAgICAqIEBwYXJhbSB7aW50fQogICAgICAgICogICAgICAgICAgICBjbGllbnRZIChPcHRpb25hbCkgVGhlIHktY29vcmRpbmF0ZSBvbiB0aGUgY2xpZW50IGF0IHdoaWNoCiAgICAgKiAgICAgICAgICAgIHBvaW50IHRoZSBldmVudCBvY2N1cmVkLiBUaGUgZGVmYXVsdCBpcyAwLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBjdHJsS2V5IChPcHRpb25hbCkgSW5kaWNhdGVzIGlmIG9uZSBvZiB0aGUgQ1RSTCBrZXlzIGlzCiAgICAgKiAgICAgICAgICAgIHByZXNzZWQgd2hpbGUgdGhlIGV2ZW50IGlzIGZpcmluZy4gVGhlIGRlZmF1bHQgaXMgZmFsc2UuCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59CiAgICAgICAgKiAgICAgICAgICAgIGFsdEtleSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiBvbmUgb2YgdGhlIEFMVCBrZXlzIGlzIHByZXNzZWQKICAgICAqICAgICAgICAgICAgd2hpbGUgdGhlIGV2ZW50IGlzIGZpcmluZy4gVGhlIGRlZmF1bHQgaXMgZmFsc2UuCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59CiAgICAgICAgKiAgICAgICAgICAgIHNoaWZ0S2V5IChPcHRpb25hbCkgSW5kaWNhdGVzIGlmIG9uZSBvZiB0aGUgU0hJRlQga2V5cyBpcwogICAgICogICAgICAgICAgICBwcmVzc2VkIHdoaWxlIHRoZSBldmVudCBpcyBmaXJpbmcuIFRoZSBkZWZhdWx0IGlzIGZhbHNlLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBtZXRhS2V5IChPcHRpb25hbCkgSW5kaWNhdGVzIGlmIG9uZSBvZiB0aGUgTUVUQSBrZXlzIGlzCiAgICAgKiAgICAgICAgICAgIHByZXNzZWQgd2hpbGUgdGhlIGV2ZW50IGlzIGZpcmluZy4gVGhlIGRlZmF1bHQgaXMgZmFsc2UuCiAgICAgKiBAcGFyYW0ge2ludH0KICAgICAgICAqICAgICAgICAgICAgYnV0dG9uIChPcHRpb25hbCkgVGhlIGJ1dHRvbiBiZWluZyBwcmVzc2VkIHdoaWxlIHRoZSBldmVudCBpcwogICAgICogICAgICAgICAgICBleGVjdXRpbmcuIFRoZSB2YWx1ZSBzaG91bGQgYmUgMCBmb3IgdGhlIHByaW1hcnkgbW91c2UgYnV0dG9uCiAgICAgKiAgICAgICAgICAgICh0eXBpY2FsbHkgdGhlIGxlZnQgYnV0dG9uKSwgMSBmb3IgdGhlIHRlcmNpYXJ5IG1vdXNlIGJ1dHRvbgogICAgICogICAgICAgICAgICAodHlwaWNhbGx5IHRoZSBtaWRkbGUgYnV0dG9uKSwgYW5kIDIgZm9yIHRoZSBzZWNvbmRhcnkgbW91c2UKICAgICAqICAgICAgICAgICAgYnV0dG9uICh0eXBpY2FsbHkgdGhlIHJpZ2h0IGJ1dHRvbikuIFRoZSBkZWZhdWx0IGlzIDAuCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICByZWxhdGVkVGFyZ2V0IChPcHRpb25hbCkgRm9yIG1vdXNlb3V0IGV2ZW50cywgdGhpcyBpcyB0aGUKICAgICAqICAgICAgICAgICAgZWxlbWVudCB0aGF0IHRoZSBtb3VzZSBoYXMgbW92ZWQgdG8uIEZvciBtb3VzZW92ZXIgZXZlbnRzLAogICAgICogICAgICAgICAgICB0aGlzIGlzIHRoZSBlbGVtZW50IHRoYXQgdGhlIG1vdXNlIGhhcyBtb3ZlZCBmcm9tLiBUaGlzCiAgICAgKiAgICAgICAgICAgIGFyZ3VtZW50IGlzIGlnbm9yZWQgZm9yIGFsbCBvdGhlciBldmVudHMuIFRoZSBkZWZhdWx0IGlzIG51bGwuCiAgICAgKi8KICAgIHNpbXVsYXRlTW91c2VFdmVudDpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgdHlwZSAvKiA6U3RyaW5nICovLCBidWJibGVzIC8qIDpCb29sZWFuICovLCBjYW5jZWxhYmxlIC8qIDpCb29sZWFuICovLCB2aWV3IC8qIDpXaW5kb3cgKi8sIGRldGFpbCAvKiA6aW50ICovLCBzY3JlZW5YIC8qIDppbnQgKi8sIHNjcmVlblkgLyogOmludCAqLywgY2xpZW50WCAvKiA6aW50ICovLCBjbGllbnRZIC8qIDppbnQgKi8sIGN0cmxLZXkgLyogOkJvb2xlYW4gKi8sIGFsdEtleSAvKiA6Qm9vbGVhbiAqLywgc2hpZnRLZXkgLyogOkJvb2xlYW4gKi8sIG1ldGFLZXkgLyogOkJvb2xlYW4gKi8sIGJ1dHRvbiAvKiA6aW50ICovLCByZWxhdGVkVGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLyxidXR0b24pIC8qIDpWb2lkICovIHsKCiAgICAgICAgLy8gY2hlY2sgdGFyZ2V0CiAgICAgICAgdGFyZ2V0ID0gdHlwZW9mIHRhcmdldCA9PSAnc3RyaW5nJyA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRhcmdldCkKICAgICAgICAgICAgOiB0YXJnZXQ7CiAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzaW11bGF0ZU1vdXNlRXZlbnQoKTogSW52YWxpZCB0YXJnZXQuIik7CiAgICAgICAgfQoKICAgICAgICAvLyBjaGVjayBldmVudCB0eXBlCiAgICAgICAgaWYgKHRoaXMuaXNzKHR5cGUpKSB7CiAgICAgICAgICAgIHR5cGUgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgICAgIGNhc2UgIm1vdXNlbW92ZSI6CiAgICAgICAgICAgICAgICBjYXNlICJtb3VzZWVudGVyIjovLyDpnZ7moIflh4bmlK/mjIHvvIzku4XkuLrmtYvor5Xmj5DkvpvvvIzor6Xpobnku4VJReS4i3dvcmsKICAgICAgICAgICAgICAgIGNhc2UgIm1vdXNlbGVhdmUiOgogICAgICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgICAgICBjYXNlICJibHVyIjoKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzaW11bGF0ZU1vdXNlRXZlbnQoKTogRXZlbnQgdHlwZSAnIiArIHR5cGUKICAgICAgICAgICAgICAgICAgICAgICAgKyAiJyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgInNpbXVsYXRlTW91c2VFdmVudCgpOiBFdmVudCB0eXBlIG11c3QgYmUgYSBzdHJpbmcuIik7CiAgICAgICAgfQoKICAgICAgICAvLyBzZXR1cCBkZWZhdWx0IHZhbHVlcwogICAgICAgIGlmICghdGhpcy5pc2IoYnViYmxlcykpIHsKICAgICAgICAgICAgYnViYmxlcyA9IHRydWU7IC8vIGFsbCBtb3VzZSBldmVudHMgYnViYmxlCiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5pc2IoY2FuY2VsYWJsZSkpIHsKICAgICAgICAgICAgY2FuY2VsYWJsZSA9ICh0eXBlICE9ICJtb3VzZW1vdmUiKTsgLy8gbW91c2Vtb3ZlIGlzIHRoZSBvbmx5IG9uZQogICAgICAgICAgICAvLyB0aGF0IGNhbid0IGJlIGNhbmNlbGxlZAogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNvKHZpZXcpKSB7CiAgICAgICAgICAgIHZpZXcgPSB3aW5kb3c7IC8vIHZpZXcgaXMgdHlwaWNhbGx5IHdpbmRvdwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNuKGRldGFpbCkpIHsKICAgICAgICAgICAgZGV0YWlsID0gMTsgLy8gbnVtYmVyIG9mIG1vdXNlIGNsaWNrcyBtdXN0IGJlIGF0IGxlYXN0IG9uZQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNuKHNjcmVlblgpKSB7CiAgICAgICAgICAgIHNjcmVlblggPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNuKHNjcmVlblkpKSB7CiAgICAgICAgICAgIHNjcmVlblkgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNuKGNsaWVudFgpKSB7CiAgICAgICAgICAgIGNsaWVudFggPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNuKGNsaWVudFkpKSB7CiAgICAgICAgICAgIGNsaWVudFkgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNiKGN0cmxLZXkpKSB7CiAgICAgICAgICAgIGN0cmxLZXkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzYihhbHRLZXkpKSB7CiAgICAgICAgICAgIGFsdEtleSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNiKHNoaWZ0S2V5KSkgewogICAgICAgICAgICBzaGlmdEtleSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNiKG1ldGFLZXkpKSB7CiAgICAgICAgICAgIG1ldGFLZXkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzbihidXR0b24pKSB7CiAgICAgICAgICAgIGJ1dHRvbiA9IDA7CiAgICAgICAgfQogICAgICAgIC8vIHRyeSB0byBjcmVhdGUgYSBtb3VzZSBldmVudAogICAgICAgIHZhciBjdXN0b21FdmVudCAvKiA6TW91c2VFdmVudCAqLyA9IG51bGw7CgogICAgICAgIC8vIGNoZWNrIGZvciBET00tY29tcGxpYW50IGJyb3dzZXJzIGZpcnN0CiAgICAgICAgaWYgKHRoaXMuaXNmKGRvY3VtZW50LmNyZWF0ZUV2ZW50KSkgewoKICAgICAgICAgICAgY3VzdG9tRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKICAgICAgICAgICAgLy8gU2FmYXJpIDIueCAoV2ViS2l0IDQxOCkgc3RpbGwgZG9lc24ndCBpbXBsZW1lbnQgaW5pdE1vdXNlRXZlbnQoKQogICAgICAgICAgICBpZiAodGhpcy5icm93c2VyLmllIDwgOSAmJiBjdXN0b21FdmVudC5pbml0TW91c2VFdmVudCkgewoKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIGJ1YmJsZXMsIGNhbmNlbGFibGUsIHZpZXcsCiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLCBzY3JlZW5YLCBzY3JlZW5ZLCBjbGllbnRYLCBjbGllbnRZLCBjdHJsS2V5LAogICAgICAgICAgICAgICAgICAgIGFsdEtleSwgc2hpZnRLZXksIG1ldGFLZXksIGJ1dHRvbiwgcmVsYXRlZFRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSB7IC8vIFNhZmFyaQoKICAgICAgICAgICAgICAgIC8vIHRoZSBjbG9zZXN0IHRoaW5nIGF2YWlsYWJsZSBpbiBTYWZhcmkgMi54IGlzIFVJRXZlbnRzCiAgICAgICAgICAgICAgICBjdXN0b21FdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJVSUV2ZW50cyIpOwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuaW5pdEV2ZW50KHR5cGUsIGJ1YmJsZXMsIGNhbmNlbGFibGUpOwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQudmlldyA9IHZpZXc7CiAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5kZXRhaWwgPSBkZXRhaWw7CiAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5zY3JlZW5YID0gc2NyZWVuWDsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LnNjcmVlblkgPSBzY3JlZW5ZOwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuY2xpZW50WCA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5jbGllbnRZID0gY2xpZW50WTsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmN0cmxLZXkgPSBjdHJsS2V5OwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuYWx0S2V5ID0gYWx0S2V5OwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQubWV0YUtleSA9IG1ldGFLZXk7CiAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5zaGlmdEtleSA9IHNoaWZ0S2V5OwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuYnV0dG9uID0gYnV0dG9uOwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQucmVsYXRlZFRhcmdldCA9IHJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIENoZWNrIHRvIHNlZSBpZiByZWxhdGVkVGFyZ2V0IGhhcyBiZWVuIGFzc2lnbmVkLiBGaXJlZm94IHZlcnNpb25zCiAgICAgICAgICAgICAqIGxlc3MgdGhhbiAyLjAgZG9uJ3QgYWxsb3cgaXQgdG8gYmUgYXNzaWduZWQgdmlhIGluaXRNb3VzZUV2ZW50KCkKICAgICAgICAgICAgICogYW5kIHRoZSBwcm9wZXJ0eSBpcyByZWFkb25seSBhZnRlciBldmVudCBjcmVhdGlvbiwgc28gaW4gb3JkZXIgdG8KICAgICAgICAgICAgICoga2VlcCBZQUhPTy51dGlsLmdldFJlbGF0ZWRUYXJnZXQoKSB3b3JraW5nLCBhc3NpZ24gdG8gdGhlIElFCiAgICAgICAgICAgICAqIHByb3ByaWV0YXJ5IHRvRWxlbWVudCBwcm9wZXJ0eSBmb3IgbW91c2VvdXQgZXZlbnQgYW5kIGZyb21FbGVtZW50CiAgICAgICAgICAgICAqIHByb3BlcnR5IGZvciBtb3VzZW92ZXIgZXZlbnQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpZiAocmVsYXRlZFRhcmdldCAmJiAhY3VzdG9tRXZlbnQucmVsYXRlZFRhcmdldCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT0gIm1vdXNlb3V0IikgewogICAgICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LnRvRWxlbWVudCA9IHJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIm1vdXNlb3ZlciIpIHsKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5mcm9tRWxlbWVudCA9IHJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGJlZm9yZSBkaXNwYXRjaAogICAgICAgICAgICBpZiAodGhpcy5iZWZvcmVkaXNwYXRjaCAmJiB0eXBlb2YgdGhpcy5iZWZvcmVkaXNwYXRjaCA9PSAnZnVuY3Rpb24nKQogICAgICAgICAgICAgICAgdGhpcy5iZWZvcmVkaXNwYXRjaChjdXN0b21FdmVudCk7CiAgICAgICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPSBudWxsOwoKICAgICAgICAgICAgLy8gZmlyZSB0aGUgZXZlbnQKICAgICAgICAgICAgdGFyZ2V0LmRpc3BhdGNoRXZlbnQoY3VzdG9tRXZlbnQpOwoKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNvKGRvY3VtZW50LmNyZWF0ZUV2ZW50T2JqZWN0KSkgeyAvLyBJRQoKICAgICAgICAgICAgLy8gY3JlYXRlIGFuIElFIGV2ZW50IG9iamVjdAogICAgICAgICAgICBjdXN0b21FdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50T2JqZWN0KCk7CgogICAgICAgICAgICAvLyBhc3NpZ24gYXZhaWxhYmxlIHByb3BlcnRpZXMKICAgICAgICAgICAgY3VzdG9tRXZlbnQuYnViYmxlcyA9IGJ1YmJsZXM7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmNhbmNlbGFibGUgPSBjYW5jZWxhYmxlOwogICAgICAgICAgICBjdXN0b21FdmVudC52aWV3ID0gdmlldzsKICAgICAgICAgICAgY3VzdG9tRXZlbnQuZGV0YWlsID0gZGV0YWlsOwogICAgICAgICAgICBjdXN0b21FdmVudC5zY3JlZW5YID0gc2NyZWVuWDsKICAgICAgICAgICAgY3VzdG9tRXZlbnQuc2NyZWVuWSA9IHNjcmVlblk7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmNsaWVudFggPSBjbGllbnRYOwogICAgICAgICAgICBjdXN0b21FdmVudC5jbGllbnRZID0gY2xpZW50WTsKICAgICAgICAgICAgY3VzdG9tRXZlbnQuY3RybEtleSA9IGN0cmxLZXk7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmFsdEtleSA9IGFsdEtleTsKICAgICAgICAgICAgY3VzdG9tRXZlbnQubWV0YUtleSA9IG1ldGFLZXk7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LnNoaWZ0S2V5ID0gc2hpZnRLZXk7CgogICAgICAgICAgICAvLyBmaXggYnV0dG9uIHByb3BlcnR5IGZvciBJRSdzIHdhY2t5IGltcGxlbWVudGF0aW9uCiAgICAgICAgICAgIHN3aXRjaCAoYnV0dG9uKSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuYnV0dG9uID0gMTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5idXR0b24gPSA0OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmJ1dHRvbiA9IDI7CiAgICAgICAgICAgICAgICAgICAgLy8gbGVhdmUgYXMgaXMKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuYnV0dG9uID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogSGF2ZSB0byB1c2UgcmVsYXRlZFRhcmdldCBiZWNhdXNlIElFIHdvbid0IGFsbG93IGFzc2lnbm1lbnQgdG8KICAgICAgICAgICAgICogdG9FbGVtZW50IG9yIGZyb21FbGVtZW50IG9uIGdlbmVyaWMgZXZlbnRzLiBUaGlzIGtlZXBzCiAgICAgICAgICAgICAqIFlBSE9PLnV0aWwuY3VzdG9tRXZlbnQuZ2V0UmVsYXRlZFRhcmdldCgpIGZ1bmN0aW9uYWwuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjdXN0b21FdmVudC5yZWxhdGVkVGFyZ2V0ID0gcmVsYXRlZFRhcmdldDsKCiAgICAgICAgICAgIC8vIGJlZm9yZSBkaXNwYXRjaAogICAgICAgICAgICBpZiAodGhpcy5iZWZvcmVkaXNwYXRjaCAmJiB0eXBlb2YgdGhpcy5iZWZvcmVkaXNwYXRjaCA9PSAnZnVuY3Rpb24nKQogICAgICAgICAgICAgICAgdGhpcy5iZWZvcmVkaXNwYXRjaChjdXN0b21FdmVudCk7CiAgICAgICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPSBudWxsOwogICAgICAgICAgICAvLyBmaXJlIHRoZSBldmVudAogICAgICAgICAgICB0YXJnZXQuZmlyZUV2ZW50KCJvbiIgKyB0eXBlLCBjdXN0b21FdmVudCk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICJzaW11bGF0ZU1vdXNlRXZlbnQoKTogTm8gZXZlbnQgc2ltdWxhdGlvbiBmcmFtZXdvcmsgcHJlc2VudC4iKTsKICAgICAgICB9CiAgICB9LAoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBNb3VzZSBldmVudHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBtb3VzZSBldmVudCBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gY2xpY2sgb24uCiAgICAgKiBAcGFyYW0ge1N0cmluZ30KICAgICAgICAqICAgICAgICAgICAgdHlwZSBUaGUgdHlwZSBvZiBldmVudCB0byBmaXJlLiBUaGlzIGNhbiBiZSBhbnkgb25lIG9mIHRoZQogICAgICogICAgICAgICAgICBmb2xsb3dpbmc6IGNsaWNrLCBkYmxjbGljaywgbW91c2Vkb3duLCBtb3VzZXVwLCBtb3VzZW91dCwKICAgICAqICAgICAgICAgICAgbW91c2VvdmVyLCBhbmQgbW91c2Vtb3ZlLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgbW91c2VFdmVudAogICAgICogQHN0YXRpYwogICAgICovCiAgICBmaXJlTW91c2VFdmVudDpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgdHlwZSAvKiA6U3RyaW5nICovLCBvcHRpb25zIC8qIDpPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB0aGlzLnNpbXVsYXRlTW91c2VFdmVudCh0YXJnZXQsIHR5cGUsIG9wdGlvbnMuYnViYmxlcywKICAgICAgICAgICAgb3B0aW9ucy5jYW5jZWxhYmxlLCBvcHRpb25zLnZpZXcsIG9wdGlvbnMuZGV0YWlsLAogICAgICAgICAgICBvcHRpb25zLnNjcmVlblgsIG9wdGlvbnMuc2NyZWVuWSwgb3B0aW9ucy5jbGllbnRYLAogICAgICAgICAgICBvcHRpb25zLmNsaWVudFksIG9wdGlvbnMuY3RybEtleSwgb3B0aW9ucy5hbHRLZXksCiAgICAgICAgICAgIG9wdGlvbnMuc2hpZnRLZXksIG9wdGlvbnMubWV0YUtleSwgb3B0aW9ucy5idXR0b24sCiAgICAgICAgICAgIG9wdGlvbnMucmVsYXRlZFRhcmdldCxvcHRpb25zLmJ1dHRvbik7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgY2xpY2sgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIGNsaWNrIG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgY2xpY2sKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgY2xpY2s6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogOk9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZU1vdXNlRXZlbnQodGFyZ2V0LCAiY2xpY2siLCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBkb3VibGUgY2xpY2sgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIGRvdWJsZSBjbGljayBvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIGRibGNsaWNrCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGRibGNsaWNrOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIDpPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVNb3VzZUV2ZW50KHRhcmdldCwgImRibGNsaWNrIiwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgbW91c2Vkb3duIG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBtb3VzZWRvd24KICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgbW91c2Vkb3duOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIE9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZU1vdXNlRXZlbnQodGFyZ2V0LCAibW91c2Vkb3duIiwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgbW91c2Vtb3ZlIG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBtb3VzZW1vdmUKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgbW91c2Vtb3ZlOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIE9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZU1vdXNlRXZlbnQodGFyZ2V0LCAibW91c2Vtb3ZlIiwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgbW91c2VvdXQgZXZlbnQgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuIFVzZSAicmVsYXRlZFRhcmdldCIKICAgICAqIG9uIHRoZSBvcHRpb25zIG9iamVjdCB0byBzcGVjaWZ5IHdoZXJlIHRoZSBtb3VzZSBtb3ZlZCB0by4gUXVpcmtzOgogICAgICogRmlyZWZveCBsZXNzIHRoYW4gMi4wIGRvZXNuJ3Qgc2V0IHJlbGF0ZWRUYXJnZXQgcHJvcGVybHksIHNvIHRvRWxlbWVudCBpcwogICAgICogYXNzaWduZWQgaW4gaXRzIHBsYWNlLiBJRSBkb2Vzbid0IGFsbG93IHRvRWxlbWVudCB0byBiZSBiZSBhc3NpZ25lZCwgc28KICAgICAqIHJlbGF0ZWRUYXJnZXQgaXMgYXNzaWduZWQgaW4gaXRzIHBsYWNlLiBCb3RoIG9mIHRoZXNlIGNvbmNlc3Npb25zIGFsbG93CiAgICAgKiBZQUhPTy51dGlsLkV2ZW50LmdldFJlbGF0ZWRUYXJnZXQoKSB0byB3b3JrIGNvcnJlY3RseSBpbiBib3RoIGJyb3dzZXJzLgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBtb3VzZW91dAogICAgICogQHN0YXRpYwogICAgICovCiAgICBtb3VzZW91dDpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiBPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVNb3VzZUV2ZW50KHRhcmdldCwgIm1vdXNlb3V0Iiwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgbW91c2VvdmVyIGV2ZW50IG9uIGEgcGFydGljdWxhciBlbGVtZW50LiBVc2UgInJlbGF0ZWRUYXJnZXQiCiAgICAgKiBvbiB0aGUgb3B0aW9ucyBvYmplY3QgdG8gc3BlY2lmeSB3aGVyZSB0aGUgbW91c2UgbW92ZWQgZnJvbS4gUXVpcmtzOgogICAgICogRmlyZWZveCBsZXNzIHRoYW4gMi4wIGRvZXNuJ3Qgc2V0IHJlbGF0ZWRUYXJnZXQgcHJvcGVybHksIHNvIGZyb21FbGVtZW50CiAgICAgKiBpcyBhc3NpZ25lZCBpbiBpdHMgcGxhY2UuIElFIGRvZXNuJ3QgYWxsb3cgZnJvbUVsZW1lbnQgdG8gYmUgYmUgYXNzaWduZWQsCiAgICAgKiBzbyByZWxhdGVkVGFyZ2V0IGlzIGFzc2lnbmVkIGluIGl0cyBwbGFjZS4gQm90aCBvZiB0aGVzZSBjb25jZXNzaW9ucwogICAgICogYWxsb3cgWUFIT08udXRpbC5FdmVudC5nZXRSZWxhdGVkVGFyZ2V0KCkgdG8gd29yayBjb3JyZWN0bHkgaW4gYm90aAogICAgICogYnJvd3NlcnMuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIGFjdCBvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIG1vdXNlb3ZlcgogICAgICogQHN0YXRpYwogICAgICovCiAgICBtb3VzZW92ZXI6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogT2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlTW91c2VFdmVudCh0YXJnZXQsICJtb3VzZW92ZXIiLCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBtb3VzZXVwIG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBtb3VzZXVwCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIG1vdXNldXA6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogT2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlTW91c2VFdmVudCh0YXJnZXQsICJtb3VzZXVwIiwgb3B0aW9ucyk7CiAgICB9LAogICAgbW91c2VlbnRlcjpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiBPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVNb3VzZUV2ZW50KHRhcmdldCwgIm1vdXNlZW50ZXIiLCBvcHRpb25zKTsKICAgIH0sCiAgICBtb3VzZWxlYXZlOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIE9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZU1vdXNlRXZlbnQodGFyZ2V0LCAibW91c2VsZWF2ZSIsIG9wdGlvbnMpOwogICAgfSwKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgY29udGV4dG1lbnUgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIHNob3cgY29udGV4dG1lbnUuCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBjb250ZXh0bWVudQogICAgICogQHN0YXRpYwogICAgICovCiAgICBjb250ZXh0bWVudTpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlTW91c2VFdmVudCh0YXJnZXQsICJjb250ZXh0bWVudSIsIG9wdGlvbnMpOwogICAgfSwKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgZHJhZ2VuZCBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gc2hvdyBkcmFnZW5kLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgZHJhZ2VuZAogICAgICogQHN0YXRpYwogICAgICovCiAgICBkcmFnZW5kOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIDpPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVNb3VzZUV2ZW50KHRhcmdldCwgImRyYWdlbmQiLCBvcHRpb25zKTsKICAgIH0sCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIGJsdXIgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIHNob3cgYmx1ci4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIGJsdXIKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgYmx1cjpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlTW91c2VFdmVudCh0YXJnZXQsICJibHVyIiwgb3B0aW9ucyk7CiAgICB9LAogICAgZHJhZ3RvOmZ1bmN0aW9uICh0YXJnZXQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgIG1lLm1vdXNlbW92ZSh0YXJnZXQsIHsKICAgICAgICAgICAgY2xpZW50WDpvcHRpb25zLnN0YXJ0WCwKICAgICAgICAgICAgY2xpZW50WTpvcHRpb25zLnN0YXJ0WQogICAgICAgIH0pOwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBtZS5tb3VzZWRvd24odGFyZ2V0LCB7CiAgICAgICAgICAgICAgICBjbGllbnRYOm9wdGlvbnMuc3RhcnRYLAogICAgICAgICAgICAgICAgY2xpZW50WTpvcHRpb25zLnN0YXJ0WQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBtZS5tb3VzZW1vdmUodGFyZ2V0LCB7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WDpvcHRpb25zLmVuZFgsCiAgICAgICAgICAgICAgICAgICAgY2xpZW50WTpvcHRpb25zLmVuZFkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgbWUubW91c2V1cCh0YXJnZXQsIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xpZW50WDpvcHRpb25zLmVuZFgsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudFk6b3B0aW9ucy5lbmRZCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0sIG9wdGlvbnMuYWZ0ZXJtb3ZlIHx8IDIwKTsKICAgICAgICAgICAgfSwgb3B0aW9ucy5iZWZvcmVtb3ZlIHx8IDIwKTsKICAgICAgICB9LCBvcHRpb25zLmJlZm9yZXN0YXJ0IHx8IDUwKTsKICAgIH0sCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEtleSBldmVudHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgLyoqCiAgICAgKiBGaXJlcyBhbiBldmVudCB0aGF0IG5vcm1hbGx5IHdvdWxkIGJlIGZpcmVkIGJ5IHRoZSBrZXlib2FyZCAoa2V5dXAsCiAgICAgKiBrZXlkb3duLCBrZXlwcmVzcykuIE1ha2Ugc3VyZSB0byBzcGVjaWZ5IGVpdGhlciBrZXlDb2RlIG9yIGNoYXJDb2RlIGFzIGFuCiAgICAgKiBvcHRpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfQogICAgICAgICogICAgICAgICAgICB0eXBlIFRoZSB0eXBlIG9mIGV2ZW50ICgia2V5dXAiLCAia2V5ZG93biIgb3IgImtleXByZXNzIikuCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBPcHRpb25zIGZvciB0aGUgZXZlbnQuIEVpdGhlciBrZXlDb2RlIG9yIGNoYXJDb2RlIGFyZQogICAgICogICAgICAgICAgICByZXF1aXJlZC4KICAgICAqIEBtZXRob2QgZmlyZUtleUV2ZW50CiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGZpcmVLZXlFdmVudDpmdW5jdGlvbiAodHlwZSAvKiA6U3RyaW5nICovLCB0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIDpPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB0aGlzLnNpbXVsYXRlS2V5RXZlbnQodGFyZ2V0LCB0eXBlLCBvcHRpb25zLmJ1YmJsZXMsCiAgICAgICAgICAgIG9wdGlvbnMuY2FuY2VsYWJsZSwgb3B0aW9ucy52aWV3LCBvcHRpb25zLmN0cmxLZXksCiAgICAgICAgICAgIG9wdGlvbnMuYWx0S2V5LCBvcHRpb25zLnNoaWZ0S2V5LCBvcHRpb25zLm1ldGFLZXksCiAgICAgICAgICAgIG9wdGlvbnMua2V5Q29kZSwgb3B0aW9ucy5jaGFyQ29kZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgY3V0IGV2ZW50IG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBjdXQKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgY3V0OmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIDpPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVLZXlFdmVudCgiY3V0IiwgdGFyZ2V0LCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBwYXN0ZSBldmVudCBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgcGFzdGUKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgcGFzdGU6ZnVuY3Rpb24gKCB0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIDpPYmplY3QgKi8gKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlS2V5RXZlbnQoICJwYXN0ZSIsIHRhcmdldCwgb3B0aW9ucyApOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIGtleWRvd24gZXZlbnQgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIGFjdCBvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIGtleWRvd24KICAgICAqIEBzdGF0aWMKICAgICAqLwogICAga2V5ZG93bjpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlS2V5RXZlbnQoImtleWRvd24iLCB0YXJnZXQsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIGtleXByZXNzIG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBrZXlwcmVzcwogICAgICogQHN0YXRpYwogICAgICovCiAgICBrZXlwcmVzczpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlS2V5RXZlbnQoImtleXByZXNzIiwgdGFyZ2V0LCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBrZXl1cCBldmVudCBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2Qga2V5dXAKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAga2V5dXA6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogT2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlS2V5RXZlbnQoImtleXVwIiwgdGFyZ2V0LCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBjb21wb3NpdGlvbnN0YXJ0IGV2ZW50IG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBjb21wb3NpdGlvbnN0YXJ0CiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGNvbXBvc2l0aW9uc3RhcnQ6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogT2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlS2V5RXZlbnQoImNvbXBvc2l0aW9uc3RhcnQiLCB0YXJnZXQsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIGNvbXBvc2l0aW9uc3RhcnQgZXZlbnQgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIGFjdCBvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIGNvbXBvc2l0aW9uc3RhcnQKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgY29tcG9zaXRpb25lbmQ6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogT2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlS2V5RXZlbnQoImNvbXBvc2l0aW9uZW5kIiwgdGFyZ2V0LCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiDmj5DkvptpZnJhbWXmianlsZXmlK/mjIHvvIznlKjkvovmtYvor5XpnIDopoHni6znq4vlnLrmma/nmoTnlKjkvovvvIznlLHkuo7lvILmraXmlK/mjIHvvIzpgJrov4dmaW5pc2jmlrnms5Xop6blj5FzdGFydAogICAgICogPGxpPuS6i+S7tue7keWumuWcqGZyYW1l5LiK77yM5YyF5ousYWZ0ZXJmaW5pc2jlkoxqc2xvYWRlZAogICAgICoKICAgICAqIEBwYXJhbSBvcC53aW4KICAgICAqIEBwYXJhbSBvcC5ub2pzCiAgICAgKiAgICAgICAgICAgIOS4jeWKoOi9vemineWklmpzCiAgICAgKiBAcGFyYW0gb3Aub250ZXN0CiAgICAgKiAgICAgICAgICAgIOa1i+ivleatpemqpAogICAgICogQHBhcmFtIG9wLm9uYmVmb3Jlc3RhcnQKICAgICAqICAgICAgICAgICAg5rWL6K+V5ZCv5Yqo5YmN5aSE55CG5q2l6aqk77yM6buY6K6k5Li6UVVuaXQuc3RvcCgpOwogICAgICogQHBhcmFtIG9wLm9uYWZ0ZXJmaW5pc2gKICAgICAqICAgICAgICAgICAg5rWL6K+V5a6M5q+V5omn6KGM5q2l6aqk77yM6buY6K6k5Li6UVVuaXQuc3RhcnQoKQogICAgICoKICAgICAqLwogICAgZnJhbWVFeHQ6ZnVuY3Rpb24gKG9wKSB7CiAgICAgICAgc3RvcCgpOwogICAgICAgIG9wID0gdHlwZW9mIG9wID09ICdmdW5jdGlvbicgPyB7CiAgICAgICAgICAgIG9udGVzdDpvcAogICAgICAgIH0gOiBvcDsKICAgICAgICB2YXIgcHcgPSBvcC53aW4gfHwgd2luZG93LCB3LCBmLCB1cmwgPSAnJywgaWQgPSB0eXBlb2Ygb3AuaWQgPT0gJ3VuZGVmaW5lZCcgPyAnZicKICAgICAgICAgICAgOiBvcC5pZCwgZmlkID0gJ2lmcmFtZSMnICsgaWQ7CgogICAgICAgIG9wLmZpbmlzaCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcHcuJChmaWQpLnVuYmluZCgpOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHB3LiQoJ2RpdiNkaXYnICsgaWQpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgc3RhcnQoKTsKICAgICAgICAgICAgfSwgMjApOwogICAgICAgIH07CgogICAgICAgIGlmIChwdy4kKGZpZCkubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgLyog5re75YqgZnJhbWXvvIzpg6jliIbmg4XlhrXkuIvvvIxpZnJhbWXmsqHmnInovrnmoYbvvIzkuLrkuoblj6/ku6XnnIvliLDmlYjmnpzvvIzmt7vliqDkuIDkuKrluKbovrnmoYbnmoRkaXYgKi8KICAgICAgICAgICAgcHcuJChwdy5kb2N1bWVudC5ib2R5KS5hcHBlbmQoJzxkaXYgaWQ9ImRpdicgKyBpZCArICciPjwvZGl2PicpOwogICAgICAgICAgICBwdy4kKCdkaXYjZGl2JyArIGlkKS5hcHBlbmQoJzxpZnJhbWUgaWQ9IicgKyBpZCArICciPjwvaWZyYW1lPicpOwogICAgICAgIH0KICAgICAgICBvcC5vbmFmdGVyc3RhcnQgJiYgb3Aub25hZnRlcnN0YXJ0KCQoJ2lmcmFtZSNmJylbMF0pOwogICAgICAgIHB3LiQoJ3NjcmlwdCcpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5zcmMgJiYgdGhpcy5zcmMuaW5kZXhPZignaW1wb3J0LnBocCcpID49IDApIHsKICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuc3JjLnNwbGl0KCdpbXBvcnQucGhwJylbMV07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBwdy4kKGZpZCkub25lKCdsb2FkJywKICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIHZhciB3ID0gZS50YXJnZXQuY29udGVudFdpbmRvdzsKICAgICAgICAgICAgICAgIHZhciBoID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3LmJhaWR1KSB7Ly8g562J5b6F5Yqg6L295a6M5oiQ77yMSUU25LiL6L+Z5Zyw5pa55oC75Ye66Zeu6aKYCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wLm9udGVzdCh3LCB3LmZyYW1lRWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMjApOwogICAgICAgICAgICAgICAgLy8g5om+5Yiw5b2T5YmN5pON5L2c55qEaWZyYW1l77yM54S25ZCOY2FsbCBvbnRlc3QKICAgICAgICAgICAgfSkuYXR0cignc3JjJywgY3BhdGggKyAnZnJhbWUucGhwJyArIHVybCk7CiAgICB9LAoKICAgIC8qKgogICAgICoKICAgICAqIOWIpOaWrTLkuKrmlbDnu4TmmK/lkKbnm7jnrYkKICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGlzRXF1YWxBcnJheTpmdW5jdGlvbiAoYXJyYXkxLCBhcnJheTIpIHsKICAgICAgICBpZiAoJ1tvYmplY3QgQXJyYXldJyAhPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJyYXkxKQogICAgICAgICAgICB8fCAnW29iamVjdCBBcnJheV0nICE9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChhcnJheTIpKQogICAgICAgICAgICByZXR1cm4gKGFycmF5MSA9PT0gYXJyYXkyKTsKICAgICAgICBlbHNlIGlmIChhcnJheTEubGVuZ3RoICE9IGFycmF5Mi5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBhcnJheTEpIHsKICAgICAgICAgICAgICAgIGlmIChhcnJheTFbaV0gIT0gYXJyYXkyW2ldKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAqCiAgICAgKiDpgJrnlKjmlbDmja7mqKHlnZcKICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKgogICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwogICAgY29tbW9uRGF0YTp7Ly8g6ZKI5a+55rWL6K+V5paH5Lu255qE6Lev5b6E6ICM5LiN5pivVXNlckFjdGlvbueahOi3r+W+hAogICAgICAgICJ0ZXN0ZGlyIjonLi4vLi4vJywKICAgICAgICBkYXRhZGlyOihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhdGlvbi5ocmVmLnNwbGl0KCIvX3Rlc3QvIilbMF0gKyAiL190ZXN0L3Rvb2xzL2RhdGEvIjsKICAgICAgICB9KSgpLAogICAgICAgIGN1cnJlbnRQYXRoOmZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSkuc3BsaXQoJyYnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBwID0gcGFyYW1zW2ldOwogICAgICAgICAgICAgICAgaWYgKHAuc3BsaXQoJz0nKVswXSA9PSAnY2FzZScpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2FzZXBhdGggPSBwLnNwbGl0KCc9JylbMV0uc3BsaXQoJy4nKS5qb2luKCcvJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvY2F0aW9uLmhyZWYuc3BsaXQoJy9fdGVzdC8nKVswXSArICcvX3Rlc3QvJwogICAgICAgICAgICAgICAgICAgICAgICArIGNhc2VwYXRoLnN1YnN0cmluZygwLCBjYXNlcGF0aC5sYXN0SW5kZXhPZignLycpKQogICAgICAgICAgICAgICAgICAgICAgICArICcvJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfSwKCiAgICBpbXBvcnRzcmM6ZnVuY3Rpb24gKHNyYywgY2FsbGJhY2ssIG1hdGNoZXIsIGV4Y2x1ZGUsIHdpbikgewogICAgICAgIHdpbiA9IHdpbiB8fCB3aW5kb3c7CiAgICAgICAgdmFyIGRvYyA9IHdpbi5kb2N1bWVudDsKCiAgICAgICAgdmFyIHNyY3BhdGggPSBsb2NhdGlvbi5ocmVmLnNwbGl0KCIvX3Rlc3QvIilbMF0KICAgICAgICAgICAgKyAiL190ZXN0L3Rvb2xzL2JyL2ltcG9ydC5waHAiOwogICAgICAgIHZhciBwYXJhbTAgPSBzcmM7CiAgICAgICAgdmFyIHBzID0gewogICAgICAgICAgICBmOnNyYwogICAgICAgIH07CiAgICAgICAgaWYgKGV4Y2x1ZGUpCiAgICAgICAgICAgIHBzLmUgPSBleGNsdWRlOwogICAgICAgIHZhciBwYXJhbTEgPSBleGNsdWRlIHx8ICIiOwogICAgICAgIC8qKgogICAgICAgICAqIElF5LiL6YeN5aSN6L295YWl5Lya5Ye6546w5peg5rOV5omn6KGM5oOF5Ya1CiAgICAgICAgICovCiAgICAgICAgaWYgKHdpbi5leGVjU2NyaXB0KSB7CiAgICAgICAgICAgICQuZ2V0KHNyY3BhdGgsIHBzLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgd2luLmV4ZWNTY3JpcHQoZGF0YSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBoZWFkID0gZG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF07CiAgICAgICAgICAgIHZhciBzYyA9IGRvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgICAgICAgc2MudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnOwogICAgICAgICAgICBzYy5zcmMgPSBzcmNwYXRoICsgIj9mPSIgKyBwYXJhbTAgKyAiJmU9IiArIHBhcmFtMTsKICAgICAgICAgICAgaGVhZC5hcHBlbmRDaGlsZChzYyk7CiAgICAgICAgfQoKICAgICAgICBtYXRjaGVyID0gbWF0Y2hlciB8fCBzcmM7CiAgICAgICAgdmFyIG1tID0gbWF0Y2hlci5zcGxpdCgiLCIpWzBdLnNwbGl0KCIuIik7CiAgICAgICAgdmFyIGggPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBwID0gd2luOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1tLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIChwW21tW2ldXSkgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhtbVtpXSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcCA9IHBbbW1baV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaCk7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAmJiAnZnVuY3Rpb24nID09IHR5cGVvZiBjYWxsYmFjaykKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfSwgMjApOwogICAgfSwKCiAgICAvKiDnlKjkuo7liqDovb1jc3Pmlofku7bvvIzlpoLmnpzmsqHmnInliqDovb3lrozmr5XliJnkuI3miafooYzlm57osIPlh73mlbAgKi8KICAgIGxvYWRjc3M6ZnVuY3Rpb24gKHVybCwgY2FsbGJhY2ssIGNsYXNzbmFtZSwgc3R5bGUsIHZhbHVlKSB7CiAgICAgICAgdmFyIGxpbmtzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2xpbmsnKTsKICAgICAgICBmb3IgKHZhciBsaW5rIGluIGxpbmtzKSB7CiAgICAgICAgICAgIGlmIChsaW5rLmhyZWYgPT0gdXJsKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXTsKICAgICAgICB2YXIgbGluayA9IGhlYWQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpKTsKICAgICAgICBsaW5rLnNldEF0dHJpYnV0ZSgicmVsIiwgInN0eWxlc2hlZXQiKTsKICAgICAgICBsaW5rLnNldEF0dHJpYnV0ZSgidHlwZSIsICJ0ZXh0L2NzcyIpOwogICAgICAgIGxpbmsuc2V0QXR0cmlidXRlKCJocmVmIiwgdXJsKTsKICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSk7CiAgICAgICAgJChkb2N1bWVudCkucmVhZHkoCiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGRpdi5jbGFzc05hbWUgPSBjbGFzc25hbWUgfHwgJ2Nzc2xvYWRlZCc7CiAgICAgICAgICAgICAgICB2YXIgaCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJChkaXYpLmNzcyhzdHlsZSB8fCAnd2lkdGgnKSA9PSB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICB8fCAkKGRpdikuY3NzKHN0eWxlIHx8ICd3aWR0aCcpID09ICcyMHB4JykgewogICAgICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGgpOwogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGRpdik7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoY2FsbGJhY2ssIDIwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAyMCk7CiAgICAgICAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIG9wdGlvbnMgc3VwcG9ydGVkCiAgICAgKi8KICAgIGRlbGF5aGVscGVyOmZ1bmN0aW9uIChvbmNoZWNrLCBvbnN1Y2Nlc3MsIG9uZmFpbCwgdGltZW91dCkgewogICAgICAgIG9uc3VjY2VzcyA9IG9uc3VjY2VzcyB8fCBvbmNoZWNrLm9uc3VjY2VzczsKICAgICAgICBvbmZhaWwgPSBvbmZhaWwgfHwgb25jaGVjay5vbmZhaWwgfHwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB3aW5kb3cuUVVuaXQuZmFpbCgndGltZW91dCB3YWl0IGZvciB0aW1lb3V0IDogJyArIHRpbWVvdXQgKyAnbXMnKTsKICAgICAgICAgICAgc3RhcnQoKTsKICAgICAgICB9OwogICAgICAgIHRpbWVvdXQgPSB0aW1lb3V0IHx8IG9uY2hlY2sudGltZW91dCB8fCAxMDAwMDsKCiAgICAgICAgb25jaGVjayA9ICh0eXBlb2Ygb25jaGVjayA9PSAnZnVuY3Rpb24nKSA/IG9uY2hlY2sgOiBvbmNoZWNrLm9uY2hlY2s7CiAgICAgICAgdmFyIGgxID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIW9uY2hlY2soKSkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGgxKTsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChoMik7CiAgICAgICAgICAgICAgICB0eXBlb2Ygb25zdWNjZXNzID09ICJmdW5jdGlvbiIgJiYgb25zdWNjZXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCAyMCk7CiAgICAgICAgdmFyIGgyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaDEpOwogICAgICAgICAgICBjbGVhclRpbWVvdXQoaDIpOwogICAgICAgICAgICBvbmZhaWwoKTsKICAgICAgICB9LCB0aW1lb3V0KTsKICAgIH0sCgogICAgYnJvd3NlcjooZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB3aW4gPSB3aW5kb3c7CiAgICAgICAgdmFyIG51bWJlcmlmeSA9IGZ1bmN0aW9uIChzKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IDA7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdChzLnJlcGxhY2UoL1wuL2csIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGMrKyA9PSAxKSA/ICcnIDogJy4nOwogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbmF2ID0gd2luICYmIHdpbi5uYXZpZ2F0b3IsCgogICAgICAgICAgICBvID0gewoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogSW50ZXJuZXQgRXhwbG9yZXIgdmVyc2lvbiBudW1iZXIgb3IgMC4gRXhhbXBsZTogNgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSBpZQogICAgICAgICAgICAgICAgICogQHR5cGUgZmxvYXQKICAgICAgICAgICAgICAgICAqIEBzdGF0aWMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgaWU6MCwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIE9wZXJhIHZlcnNpb24gbnVtYmVyIG9yIDAuIEV4YW1wbGU6IDkuMgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSBvcGVyYQogICAgICAgICAgICAgICAgICogQHR5cGUgZmxvYXQKICAgICAgICAgICAgICAgICAqIEBzdGF0aWMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgb3BlcmE6MCwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEdlY2tvIGVuZ2luZSByZXZpc2lvbiBudW1iZXIuIFdpbGwgZXZhbHVhdGUgdG8gMSBpZiBHZWNrbyBpcwogICAgICAgICAgICAgICAgICogZGV0ZWN0ZWQgYnV0IHRoZSByZXZpc2lvbiBjb3VsZCBub3QgYmUgZm91bmQuIE90aGVyIGJyb3dzZXJzIHdpbGwKICAgICAgICAgICAgICAgICAqIGJlIDAuIEV4YW1wbGU6IDEuOAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiBGaXJlZm94IDEuMC4wLjQ6IDEuNy44ICAgJmx0Oy0tIFJlcG9ydHMgMS43CiAgICAgICAgICAgICAgICAgKiBGaXJlZm94IDEuNS4wLjk6IDEuOC4wLjkgJmx0Oy0tIDEuOAogICAgICAgICAgICAgICAgICogRmlyZWZveCAyLjAuMC4zOiAxLjguMS4zICZsdDstLSAxLjgxCiAgICAgICAgICAgICAgICAgKiBGaXJlZm94IDMuMCAgICZsdDstLSAxLjkKICAgICAgICAgICAgICAgICAqIEZpcmVmb3ggMy41ICAgJmx0Oy0tIDEuOTEKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSBnZWNrbwogICAgICAgICAgICAgICAgICogQHR5cGUgZmxvYXQKICAgICAgICAgICAgICAgICAqIEBzdGF0aWMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZ2Vja286MCwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEFwcGxlV2ViS2l0IHZlcnNpb24uIEtIVE1MIGJyb3dzZXJzIHRoYXQgYXJlIG5vdCBXZWJLaXQgYnJvd3NlcnMKICAgICAgICAgICAgICAgICAqIHdpbGwgZXZhbHVhdGUgdG8gMSwgb3RoZXIgYnJvd3NlcnMgMC4gRXhhbXBsZTogNDE4LjkKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogU2FmYXJpIDEuMy4yICgzMTIuNik6IDMxMi44LjEgJmx0Oy0tIFJlcG9ydHMgMzEyLjggLS0gY3VycmVudGx5IHRoZQogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhdGVzdCBhdmFpbGFibGUgZm9yIE1hYyBPU1ggMTAuMy4KICAgICAgICAgICAgICAgICAqIFNhZmFyaSAyLjAuMjogICAgICAgICA0MTYgICAgICZsdDstLSBoYXNPd25Qcm9wZXJ0eSBpbnRyb2R1Y2VkCiAgICAgICAgICAgICAgICAgKiBTYWZhcmkgMi4wLjQ6ICAgICAgICAgNDE4ICAgICAmbHQ7LS0gcHJldmVudERlZmF1bHQgZml4ZWQKICAgICAgICAgICAgICAgICAqIFNhZmFyaSAyLjAuNCAoNDE5LjMpOiA0MTguOS4xICZsdDstLSBPbmUgdmVyc2lvbiBvZiBTYWZhcmkgbWF5IHJ1bgogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZlcmVudCB2ZXJzaW9ucyBvZiB3ZWJraXQKICAgICAgICAgICAgICAgICAqIFNhZmFyaSAyLjAuNCAoNDE5LjMpOiA0MTkgICAgICZsdDstLSBUaWdlciBpbnN0YWxsYXRpb25zIHRoYXQgaGF2ZSBiZWVuCiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZCwgYnV0IG5vdCB1cGRhdGVkCiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gdGhlIGxhdGVzdCBwYXRjaC4KICAgICAgICAgICAgICAgICAqIFdlYmtpdCAyMTIgbmlnaHRseTogICA1MjIrICAgICZsdDstLSBTYWZhcmkgMy4wIHByZWN1cnNvciAod2l0aCBuYXRpdmUgU1ZHCiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5kIG1hbnkgbWFqb3IgaXNzdWVzIGZpeGVkKS4KICAgICAgICAgICAgICAgICAqIFNhZmFyaSAzLjAuNCAoNTIzLjEyKSA1MjMuMTIgICZsdDstLSBGaXJzdCBUaWdlciByZWxlYXNlIC0gYXV0b21hdGljIHVwZGF0ZQogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gMi54IHZpYSB0aGUgMTAuNC4xMSBPUyBwYXRjaAogICAgICAgICAgICAgICAgICogV2Via2l0IG5pZ2h0bHkgMS8yMDA4OjUyNSsgICAgJmx0Oy0tIFN1cHBvcnRzIERPTUNvbnRlbnRMb2FkZWQgZXZlbnQuCiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeWFob28uY29tIHVzZXIgYWdlbnQgaGFjayByZW1vdmVkLgogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TYWZhcmlfdmVyc2lvbl9oaXN0b3J5CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByb3BlcnR5IHdlYmtpdAogICAgICAgICAgICAgICAgICogQHR5cGUgZmxvYXQKICAgICAgICAgICAgICAgICAqIEBzdGF0aWMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgd2Via2l0OjAsCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBDaHJvbWUgd2lsbCBiZSBkZXRlY3RlZCBhcyB3ZWJraXQsIGJ1dCB0aGlzIHByb3BlcnR5IHdpbGwgYWxzbyBiZQogICAgICAgICAgICAgICAgICogcG9wdWxhdGVkIHdpdGggdGhlIENocm9tZSB2ZXJzaW9uIG51bWJlcgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSBjaHJvbWUKICAgICAgICAgICAgICAgICAqIEB0eXBlIGZsb2F0CiAgICAgICAgICAgICAgICAgKiBAc3RhdGljCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGNocm9tZTowLAoKICAgICAgICAgICAgICAgIHNhZmFyaTowLAoKICAgICAgICAgICAgICAgIGZpcmVmb3g6MCwKCiAgICAgICAgICAgICAgICBtYXh0aG9uOjAsCiAgICAgICAgICAgICAgICBtYXh0aG9uSUU6MCwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIFRoZSBtb2JpbGUgcHJvcGVydHkgd2lsbCBiZSBzZXQgdG8gYSBzdHJpbmcgY29udGFpbmluZyBhbnkKICAgICAgICAgICAgICAgICAqIHJlbGV2YW50IHVzZXIgYWdlbnQgaW5mb3JtYXRpb24gd2hlbiBhIG1vZGVybiBtb2JpbGUgYnJvd3NlciBpcwogICAgICAgICAgICAgICAgICogZGV0ZWN0ZWQuIEN1cnJlbnRseSBsaW1pdGVkIHRvIFNhZmFyaSBvbiB0aGUgaVBob25lL2lQb2QgVG91Y2gsCiAgICAgICAgICAgICAgICAgKiBOb2tpYSBOLXNlcmllcyBkZXZpY2VzIHdpdGggdGhlIFdlYktpdC1iYXNlZCBicm93c2VyLCBhbmQgT3BlcmEKICAgICAgICAgICAgICAgICAqIE1pbmkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByb3BlcnR5IG1vYmlsZQogICAgICAgICAgICAgICAgICogQHR5cGUgc3RyaW5nCiAgICAgICAgICAgICAgICAgKiBAc3RhdGljCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIG1vYmlsZTpudWxsLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQWRvYmUgQUlSIHZlcnNpb24gbnVtYmVyIG9yIDAuIE9ubHkgcG9wdWxhdGVkIGlmIHdlYmtpdCBpcwogICAgICAgICAgICAgICAgICogZGV0ZWN0ZWQuIEV4YW1wbGU6IDEuMAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSBhaXIKICAgICAgICAgICAgICAgICAqIEB0eXBlIGZsb2F0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGFpcjowLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogR29vZ2xlIENhamEgdmVyc2lvbiBudW1iZXIgb3IgMC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkgY2FqYQogICAgICAgICAgICAgICAgICogQHR5cGUgZmxvYXQKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY2FqYTpuYXYgJiYgbmF2LmNhamFWZXJzaW9uLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogU2V0IHRvIHRydWUgaWYgdGhlIHBhZ2VicmVhayBhcHBlYXJzIHRvIGJlIGluIFNTTAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSBzZWN1cmUKICAgICAgICAgICAgICAgICAqIEB0eXBlIGJvb2xlYW4KICAgICAgICAgICAgICAgICAqIEBzdGF0aWMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgc2VjdXJlOmZhbHNlLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogVGhlIG9wZXJhdGluZyBzeXN0ZW0uIEN1cnJlbnRseSBvbmx5IGRldGVjdGluZyB3aW5kb3dzIG9yCiAgICAgICAgICAgICAgICAgKiBtYWNpbnRvc2gKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkgb3MKICAgICAgICAgICAgICAgICAqIEB0eXBlIHN0cmluZwogICAgICAgICAgICAgICAgICogQHN0YXRpYwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBvczpudWxsCgogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdWEgPSBuYXYgJiYgbmF2LnVzZXJBZ2VudCwKCiAgICAgICAgICAgIGxvYyA9IHdpbiAmJiB3aW4ubG9jYXRpb24sCgogICAgICAgICAgICBocmVmID0gbG9jICYmIGxvYy5ocmVmLAoKICAgICAgICAgICAgbTsKCiAgICAgICAgby5zZWN1cmUgPSBocmVmICYmIChocmVmLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiaHR0cHMiKSA9PT0gMCk7CgogICAgICAgIGlmICh1YSkgewoKICAgICAgICAgICAgaWYgKCgvd2luZG93c3x3aW4zMi9pKS50ZXN0KHVhKSkgewogICAgICAgICAgICAgICAgby5vcyA9ICd3aW5kb3dzJzsKICAgICAgICAgICAgfSBlbHNlIGlmICgoL21hY2ludG9zaC9pKS50ZXN0KHVhKSkgewogICAgICAgICAgICAgICAgby5vcyA9ICdtYWNpbnRvc2gnOwogICAgICAgICAgICB9IGVsc2UgaWYgKCgvcmhpbm8vaSkudGVzdCh1YSkpIHsKICAgICAgICAgICAgICAgIG8ub3MgPSAncmhpbm8nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb2Rlcm4gS0hUTUwgYnJvd3NlcnMgc2hvdWxkIHF1YWxpZnkgYXMgU2FmYXJpIFgtR3JhZGUKICAgICAgICAgICAgaWYgKCgvS0hUTUwvKS50ZXN0KHVhKSkgewogICAgICAgICAgICAgICAgby53ZWJraXQgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZXh0ZXJuYWwgJiYgLyhcZCtcLlxkKS8udGVzdChleHRlcm5hbC5tYXhfdmVyc2lvbikpIHsKCiAgICAgICAgICAgICAgICBvLm1heHRob24gPSBwYXJzZUZsb2F0KFJlZ0V4cFsnXHgyNDEnXSk7CiAgICAgICAgICAgICAgICBpZiAoL01TSUUvLnRlc3QodWEpKSB7CiAgICAgICAgICAgICAgICAgICAgby5tYXh0aG9uSUUgPSAxOwogICAgICAgICAgICAgICAgICAgIG8ubWF4dGhvbiA9IDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZGVybiBXZWJLaXQgYnJvd3NlcnMgYXJlIGF0IGxlYXN0IFgtR3JhZGUKICAgICAgICAgICAgbSA9IHVhLm1hdGNoKC9BcHBsZVdlYktpdFwvKFteXHNdKikvKTsKICAgICAgICAgICAgaWYgKG0gJiYgbVsxXSkgewogICAgICAgICAgICAgICAgby53ZWJraXQgPSBudW1iZXJpZnkobVsxXSk7CgogICAgICAgICAgICAgICAgLy8gTW9iaWxlIGJyb3dzZXIgY2hlY2sKICAgICAgICAgICAgICAgIGlmICgvIE1vYmlsZVwvLy50ZXN0KHVhKSkgewogICAgICAgICAgICAgICAgICAgIG8ubW9iaWxlID0gIkFwcGxlIjsgLy8gaVBob25lIG9yIGlQb2QgVG91Y2gKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbSA9IHVhLm1hdGNoKC9Ob2tpYU5bXlwvXSp8QW5kcm9pZCBcZFwuXGR8d2ViT1NcL1xkXC5cZC8pOwogICAgICAgICAgICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG8ubW9iaWxlID0gbVswXTsgLy8gTm9raWEgTi1zZXJpZXMsIEFuZHJvaWQsIHdlYk9TLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBleDoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm9raWFOOTUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIG0xID0gdWEubWF0Y2goL1NhZmFyaVwvKFteXHNdKikvKTsKICAgICAgICAgICAgICAgIGlmIChtMSAmJiBtMVsxXSkgLy8gU2FmYXJpCiAgICAgICAgICAgICAgICAgICAgby5zYWZhcmkgPSBudW1iZXJpZnkobTFbMV0pOwogICAgICAgICAgICAgICAgbSA9IHVhLm1hdGNoKC9DaHJvbWVcLyhbXlxzXSopLyk7CiAgICAgICAgICAgICAgICBpZiAoby5zYWZhcmkgJiYgbSAmJiBtWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgby5jaHJvbWUgPSBudW1iZXJpZnkobVsxXSk7IC8vIENocm9tZQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtID0gdWEubWF0Y2goL0Fkb2JlQUlSXC8oW15cc10qKS8pOwogICAgICAgICAgICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG8uYWlyID0gbVswXTsgLy8gQWRvYmUgQUlSIDEuMCBvciBiZXR0ZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghby53ZWJraXQpIHsgLy8gbm90IHdlYmtpdAogICAgICAgICAgICAgICAgLy8gQHRvZG8gY2hlY2sgT3BlcmEvOC4wMSAoSjJNRS9NSURQOyBPcGVyYSBNaW5pLzIuMC40NTA5LzEzMTY7CiAgICAgICAgICAgICAgICAvLyBmaTsgVTsKICAgICAgICAgICAgICAgIC8vIHRyeSBnZXQgZmlyZWZveCBhbmQgaXQncyB2ZXIKICAgICAgICAgICAgICAgIC8vIHNzcikKICAgICAgICAgICAgICAgIG0gPSB1YS5tYXRjaCgvT3BlcmFbXHNcL10oW15cc10qKS8pOwogICAgICAgICAgICAgICAgaWYgKG0gJiYgbVsxXSkgewogICAgICAgICAgICAgICAgICAgIG0gPSB1YS5tYXRjaCgvVmVyc2lvbltcc1wvXShbXlxzXSopLyk7CiAgICAgICAgICAgICAgICAgICAgby5vcGVyYSA9IG51bWJlcmlmeShtWzFdKTsKICAgICAgICAgICAgICAgICAgICBtID0gdWEubWF0Y2goL09wZXJhIE1pbmlbXjtdKi8pOwogICAgICAgICAgICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG8ubW9iaWxlID0gbVswXTsgLy8gZXg6IE9wZXJhIE1pbmkvMi4wLjQ1MDkvMTMxNgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIG5vdCBvcGVyYSBvciB3ZWJraXQKICAgICAgICAgICAgICAgICAgICBtID0gdWEubWF0Y2goL01TSUVccyhbXjtdKikvKTsKICAgICAgICAgICAgICAgICAgICBpZiAobSAmJiBtWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG8uaWUgPSBudW1iZXJpZnkobVsxXSk7CiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYgKHVhLm1hdGNoKC9HZWNrbyhbXlxzXSopLykmJnVhLm1hdGNoKC9ydjoxMS8pKXsvL3RvZG8KICAgICAgICAgICAgICAgICAgICAgICAgby5pZSA9IDExOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIG5vdCBvcGVyYSwgd2Via2l0LCBvciBpZQogICAgICAgICAgICAgICAgICAgICAgICBtID0gdWEubWF0Y2goL0dlY2tvXC8oW15cc10qKS8pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgby5nZWNrbyA9IDE7IC8vIEdlY2tvIGRldGVjdGVkLCBsb29rIGZvciByZXZpc2lvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbSA9IHVhLm1hdGNoKC9ydjooW15cc1wpXSopLyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobSAmJiBtWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgby5nZWNrbyA9IG51bWJlcmlmeShtWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG87CiAgICB9KQogICAgICAgICgpLAoKICAgIC8qKgogICAgICog5o+Q5L6b6Zif5YiX5pa55byP5omn6KGM55So5L6L55qE5pa55qGI77yM5o6l5Y+j5YyF5ousc3RhcnTjgIFhZGTjgIFuZXh077yM5pa55rOV5YWo6YOo5omn6KGM5a6M5q+V5pe25Lya5ZCv5Yqo55So5L6L57un57ut5omn6KGMCiAgICAgKi8KICAgIGZ1bmN0aW9uTGlzdEhlbHBlcjpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGNoZWNrID0gewogICAgICAgICAgICBsaXN0OltdLAogICAgICAgICAgICBzdGFydDpmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICAkKHRoaXMpLmJpbmQoJ25leHQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7Ly8g6YG/5YWN5aSq5rex55qE5aCG5qCICiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmxpc3QubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxpc3Quc2hpZnQoKSgpOwogICAgICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBzZWxmLm5leHQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYWRkOmZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxpc3QucHVzaChmdW5jKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbmV4dDpmdW5jdGlvbiAoZGVsYXkpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgICAgIGlmIChkZWxheSkgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAkKHNlbGYpLnRyaWdnZXIoJ25leHQnKTsKICAgICAgICAgICAgICAgICAgICB9LCBkZWxheSk7CiAgICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnRyaWdnZXIoJ25leHQnKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGNoZWNrOwogICAgfSwKICAgIGdldEhUTUw6ZnVuY3Rpb24gKGNvKSB7CiAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLCBoOwogICAgICAgIGlmICghY28pCiAgICAgICAgICAgIHJldHVybiAnbnVsbCc7CiAgICAgICAgZGl2LmFwcGVuZENoaWxkKGNvLmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgaCA9IGRpdi5pbm5lckhUTUwudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgaCA9IGgucmVwbGFjZSgvW1xyXG5cdFx1MjAwYlx1ZmVmZl0vZywgJycpOyAvLyBSZW1vdmUgbGluZSBmZWVkcyBhbmQgdGFicwogICAgICAgIGggPSBoLnJlcGxhY2UoLyAoXHcrKT0oW15cIl1bXlxzPl0qKS9naSwgJyAkMT0iJDIiJyk7IC8vIFJlc3RvcmUKICAgICAgICAvLyBhdHRyaWJzIG9uIElFCiAgICAgICAgcmV0dXJuIGg7CiAgICB9LAogICAgZ2V0Q2hpbGRIVE1MOmZ1bmN0aW9uIChjbykgewoKICAgICAgICB2YXIgaCA9IGNvLmlubmVySFRNTC50b0xvd2VyQ2FzZSgpOwoKICAgICAgICBoID0gaC5yZXBsYWNlKC9bXHJcblx0XHUyMDBiXHVmZWZmXS9nLCAnJyk7IC8vIFJlbW92ZSBsaW5lIGZlZWRzIGFuZCB0YWJzCiAgICAgICAgaCA9IGgucmVwbGFjZSgvIChcdyspPShbXlwiXVteXHM+XSopL2dpLCAnICQxPSIkMiInKTsgLy8gUmVzdG9yZSBhdHRyaWJzIG9uIElFCgogICAgICAgIHJldHVybiBoLnJlcGxhY2UoL1x1MjAwQi9nLCAnJyk7CiAgICB9LAogICAgZ2V0SW5kZXg6ZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICB2YXIgY2hpbGROb2RlcyA9IG5vZGUucGFyZW50Tm9kZS5jaGlsZE5vZGVzLCBpID0gMDsKICAgICAgICB3aGlsZSAoY2hpbGROb2Rlc1tpXSAhPT0gbm9kZSkKICAgICAgICAgICAgaSsrOwogICAgICAgIHJldHVybiBpOwogICAgfSwKICAgIGNoZWNrUmVzdWx0OmZ1bmN0aW9uIChyYW5nZSwgc2MsIGVjLCBzbywgZW8sIGNvbGxhcHNlZCwgZGVzY3JpcHQpIHsKICAgICAgICBkZXNjcmlwdCA9IGRlc2NyaXB0ID8gZGVzY3JpcHQgOiAnJzsKICAgICAgICBlcXVhbChyYW5nZS5jb2xsYXBzZWQsIGNvbGxhcHNlZCwgImNoZWNrIGNvbGxhcHNlZCAtLSIgKyBkZXNjcmlwdCk7CiAgICAgICAgb2socmFuZ2Uuc3RhcnRDb250YWluZXIgPT09IHNjLCAiY2hlY2sgc3RhcnRDb250YWluZXItLSIgKyBkZXNjcmlwdCk7CiAgICAgICAgb2socmFuZ2UuZW5kQ29udGFpbmVyID09PSBlYywgImNoZWNrIGVuZENvbnRhaW5lci0tIiArIGRlc2NyaXB0KTsKICAgICAgICBlcXVhbChyYW5nZS5zdGFydE9mZnNldCwgc28sICJjaGVjayBzdGFydE9mZnNldC0tIiArIGRlc2NyaXB0KTsKICAgICAgICBlcXVhbChyYW5nZS5lbmRPZmZzZXQsIGVvLCAiY2hlY2sgZW5kT2Zmc2V0LS0iICsgZGVzY3JpcHQpOwogICAgfSwKICAgIGlzU2FtZVJhbmdlOmZ1bmN0aW9uIChyYW5nZUEsIHJhbmdlQiwgZGVzY3JpcHQpIHsKICAgICAgICBkZXNjcmlwdCA9IGRlc2NyaXB0ID8gZGVzY3JpcHQgOiAnJzsKICAgICAgICBlcXVhbChyYW5nZUEuY29sbGFwc2VkLCByYW5nZUIuY29sbGFwc2VkLCAiY2hlY2sgY29sbGFwc2VkIC0tIiArIGRlc2NyaXB0KTsKICAgICAgICBvayhyYW5nZUEuZG9jdW1lbnQgPT09IHJhbmdlQi5kb2N1bWVudCwgImNoZWNrIGRvY3VtZW50LS0iICsgZGVzY3JpcHQpOwogICAgICAgIG9rKHJhbmdlQS5zdGFydENvbnRhaW5lciA9PT0gcmFuZ2VCLnN0YXJ0Q29udGFpbmVyLCAiY2hlY2sgc3RhcnRDb250YWluZXItLSIgKyBkZXNjcmlwdCk7CiAgICAgICAgb2socmFuZ2VBLmVuZENvbnRhaW5lciA9PT0gcmFuZ2VCLmVuZENvbnRhaW5lciwgImNoZWNrIGVuZENvbnRhaW5lci0tIiArIGRlc2NyaXB0KTsKICAgICAgICBlcXVhbChyYW5nZUEuc3RhcnRPZmZzZXQsIHJhbmdlQi5zdGFydE9mZnNldCwgImNoZWNrIHN0YXJ0T2Zmc2V0LS0iICsgZGVzY3JpcHQpOwogICAgICAgIGVxdWFsKHJhbmdlQS5lbmRPZmZzZXQsIHJhbmdlQi5lbmRPZmZzZXQsICJjaGVjayBlbmRPZmZzZXQtLSIgKyBkZXNjcmlwdCk7CiAgICB9LAogICAgbWFudWFsRGVsZXRlRmlsbERhdGE6ZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICB2YXIgY2hpbGRzID0gbm9kZS5jaGlsZE5vZGVzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBmaWxsRGF0YSA9IGNoaWxkc1tpXTsKICAgICAgICAgICAgaWYgKChmaWxsRGF0YS5ub2RlVHlwZSA9PSAzKSAmJiAoIGZpbGxEYXRhLmRhdGEgPT0gZG9tVXRpbHMuZmlsbENoYXIgKSkgewogICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGZpbGxEYXRhKTsKICAgICAgICAgICAgICAgIGZpbGxEYXRhID0gbnVsbDsKCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhpcy5tYW51YWxEZWxldGVGaWxsRGF0YShmaWxsRGF0YSk7CiAgICAgICAgfQoKCiAgICB9LAogICAgY3NzU3R5bGVUb0RvbVN0eWxlOmZ1bmN0aW9uIChjc3NOYW1lKSB7CiAgICAgICAgdmFyIHRlc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5zdHlsZSwKICAgICAgICAgICAgY3NzRmxvYXQgPSB0ZXN0LmNzc0Zsb2F0ICE9IHVuZGVmaW5lZCA/ICdjc3NGbG9hdCcKICAgICAgICAgICAgICAgIDogdGVzdC5zdHlsZUZsb2F0ICE9IHVuZGVmaW5lZCA/ICdzdHlsZUZsb2F0JwogICAgICAgICAgICAgICAgOiAnZmxvYXQnLAogICAgICAgICAgICBjYWNoZSA9IHsgJ2Zsb2F0Jzpjc3NGbG9hdCB9OwoKICAgICAgICBmdW5jdGlvbiByZXBsYWNlcihtYXRjaCkgewogICAgICAgICAgICByZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgfQoKLy8gICAgICAgIHJldHVybiBmdW5jdGlvbiggY3NzTmFtZSApIHsKICAgICAgICByZXR1cm4gY2FjaGVbY3NzTmFtZV0gfHwgKGNhY2hlW2Nzc05hbWVdID0gY3NzTmFtZS5yZXBsYWNlKC8tLi9nLCByZXBsYWNlcikgKTsKLy8gICAgICAgIH07CiAgICB9LAogICAgaXNTYW1lU3R5bGU6ZnVuY3Rpb24gKGVsZW1lbnRBLCBlbGVtZW50QikgewovLyAgICAgICAgdmFyIHN0eWxlQSA9IGVsZW1lbnRBLnN0eWxlLmNzc1RleHQsCi8vICAgICAgICAgICAgc3R5bGVCID0gZWxlbWVudEIuc3R5bGUuY3NzVGV4dDsKLy8gICAgICAgIGlmICggdGhpcy5icm93c2VyLmllICYmIHRoaXMuYnJvd3Nlci52ZXJzaW9uID09IDYgKSB7Ci8vICAgICAgICAgICAgc3R5bGVBID0gc3R5bGVBLnRvTG93ZXJDYXNlKCk7Ci8vICAgICAgICAgICAgc3R5bGVCID0gc3R5bGVCLnRvTG93ZXJDYXNlKCk7Ci8vICAgICAgICB9Ci8vICAgICAgICBpZiAoICFzdHlsZUEgJiYgIXN0eWxlQiApIHsKLy8gICAgICAgICAgICByZXR1cm4gdHJ1ZTsKLy8gICAgICAgIH0gZWxzZSBpZiAoICFzdHlsZUEgfHwgIXN0eWxlQiApIHsKLy8gICAgICAgICAgICByZXR1cm4gZmFsc2U7Ci8vICAgICAgICB9Ci8vICAgICAgICB2YXIgc3R5bGVOYW1lTWFwID0ge30sCi8vICAgICAgICAgICAgcmVjb3JkID0gW10sCi8vICAgICAgICAgICAgZXhpdCA9IHt9OwovLyAgICAgICAgc3R5bGVBLnJlcGxhY2UoIC9bXHctXStccyooPz06KS9nLCBmdW5jdGlvbiAoIG5hbWUgKSB7Ci8vICAgICAgICAgICAgc3R5bGVOYW1lTWFwW25hbWVdID0gcmVjb3JkLnB1c2goIG5hbWUgKTsKLy8gICAgICAgIH0gKTsKLy8gICAgICAgIHRyeSB7Ci8vICAgICAgICAgICAgc3R5bGVCLnJlcGxhY2UoIC9bXHctXStccyooPz06KS9nLCBmdW5jdGlvbiAoIG5hbWUgKSB7Ci8vICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHN0eWxlTmFtZU1hcFtuYW1lXTsKLy8gICAgICAgICAgICAgICAgaWYgKCBpbmRleCApIHsKLy8vLyAgICAgICAgICAgICAgICAgICAgbmFtZSA9IHRoaXMuY3NzU3R5bGVUb0RvbVN0eWxlKCBuYW1lICk7Ci8vICAgICAgICAgICAgICAgICAgICBpZiAoIGVsZW1lbnRBLnN0eWxlW25hbWVdICE9PSBlbGVtZW50Qi5zdHlsZVtuYW1lXSApIHsKLy8gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBleGl0OwovLyAgICAgICAgICAgICAgICAgICAgfQovLyAgICAgICAgICAgICAgICAgICAgcmVjb3JkW2luZGV4IC0gMV0gPSAnJzsKLy8gICAgICAgICAgICAgICAgfSBlbHNlIHsKLy8gICAgICAgICAgICAgICAgICAgIHRocm93IGV4aXQ7Ci8vICAgICAgICAgICAgICAgIH0KLy8gICAgICAgICAgICB9ICk7Ci8vICAgICAgICB9IGNhdGNoICggZXggKSB7Ci8vICAgICAgICAgICAgaWYgKCBleCA9PT0gZXhpdCApIHsKLy8gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwovLyAgICAgICAgICAgIH0KLy8gICAgICAgIH0KLy8gICAgICAgIHJldHVybiAhcmVjb3JkLmpvaW4oICcnICk7CiAgICAgICAgZnVuY3Rpb24gaW5kZXhPZihhcnJheSwgaXRlbSwgYXQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGF0IHx8IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CgogICAgICAgIHZhciBzdHlsZUEgPSBlbGVtZW50QS5zdHlsZS5jc3NUZXh0LnJlcGxhY2UoLyggPzsgPykvZywgJzsnKS5yZXBsYWNlKC8oID86ID8pL2csICc6JyksCiAgICAgICAgICAgIHN0eWxlQiA9IGVsZW1lbnRCLnN0eWxlLmNzc1RleHQucmVwbGFjZSgvKCA/OyA/KS9nLCAnOycpLnJlcGxhY2UoLyggPzogPykvZywgJzonKTsKICAgICAgICBpZiAoYnJvd3Nlci5vcGVyYSkgewogICAgICAgICAgICBzdHlsZUEgPSBlbGVtZW50QS5zdHlsZTsKICAgICAgICAgICAgc3R5bGVCID0gZWxlbWVudEIuc3R5bGU7CiAgICAgICAgICAgIGlmIChzdHlsZUEubGVuZ3RoICE9IHN0eWxlQi5sZW5ndGgpCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBzdHlsZUEpIHsKICAgICAgICAgICAgICAgIGlmICgvXihcZCt8Y3NzdGV4dCkkL2kudGVzdChwKSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChzdHlsZUFbcF0gIT0gc3R5bGVCW3BdKQogICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KCgogICAgICAgIGlmICghc3R5bGVBIHx8ICFzdHlsZUIpIHsKICAgICAgICAgICAgcmV0dXJuIHN0eWxlQSA9PSBzdHlsZUIgPyAxIDogMDsKICAgICAgICB9CiAgICAgICAgc3R5bGVBID0gc3R5bGVBLnNwbGl0KCc7Jyk7CiAgICAgICAgc3R5bGVCID0gc3R5bGVCLnNwbGl0KCc7Jyk7CgogICAgICAgIGlmIChzdHlsZUEubGVuZ3RoICE9IHN0eWxlQi5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3R5bGVCLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGlmIChzdHlsZUJbal0udG9Mb3dlckNhc2UoKS5pbmRleE9mKCJjb2xvciIpID4gLTEgJiYgc3R5bGVCW2pdLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigicmdiIikgPiAtMSkgewogICAgICAgICAgICAgICAgdmFyIGNvbG9yID0gdGhpcy5mb3JtYXRDb2xvcihzdHlsZUJbal0uc3Vic3RyKHN0eWxlQltqXS5pbmRleE9mKCJyZ2IiKSwgc3R5bGVCW2pdLmxlbmd0aCkpOwogICAgICAgICAgICAgICAgc3R5bGVCW2pdID0gc3R5bGVCW2pdLnJlcGxhY2Uoc3R5bGVCW2pdLnN1YnN0cihzdHlsZUJbal0uaW5kZXhPZigicmdiIiksIHN0eWxlQltqXS5sZW5ndGgpLCBjb2xvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHN0eWxlQVtpKytdOykgewogICAgICAgICAgICBpZiAoY2kudG9Mb3dlckNhc2UoKS5pbmRleE9mKCJjb2xvciIpID4gLTEgJiYgY2kudG9Mb3dlckNhc2UoKS5pbmRleE9mKCJyZ2IiKSA+IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgY29sb3IgPSB0aGlzLmZvcm1hdENvbG9yKGNpLnN1YnN0cihjaS5pbmRleE9mKCJyZ2IiKSwgY2kubGVuZ3RoKSk7CiAgICAgICAgICAgICAgICBjaSA9IGNpLnJlcGxhY2UoY2kuc3Vic3RyKGNpLmluZGV4T2YoInJnYiIpLCBjaS5sZW5ndGgpLCBjb2xvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluZGV4T2Yoc3R5bGVCLCBjaSkgPT0gLTEpIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKCiAgICAgICAgICAgIH0vL3N0eWxlQVswXS5zdWJzdHIoc3R5bGVBWzBdLmluZGV4T2YoInJnYSIpLHN0eWxlQVswXS5sZW5ndGgpCiAgICAgICAgfQogICAgICAgIHJldHVybiAxOwogICAgfSwKCgogICAgZm9ybWF0Q29sb3I6ZnVuY3Rpb24gKGNvbG9yKSB7CiAgICAgICAgdmFyIHJlZzEgPSAvXlwjW1xkYS1mXXs2fSQvaSwKICAgICAgICAgICAgcmVnMiA9IC9ecmdiXCgoXGQrKSxccyooXGQrKSxccyooXGQrKVwpJC8sCiAgICAgICAgICAgIGtleXdvcmQgPSB7CiAgICAgICAgICAgICAgICBibGFjazonIzAwMDAwMCcsCiAgICAgICAgICAgICAgICBzaWx2ZXI6JyNjMGMwYzAnLAogICAgICAgICAgICAgICAgZ3JheTonIzgwODA4MCcsCiAgICAgICAgICAgICAgICB3aGl0ZTonI2ZmZmZmZicsCiAgICAgICAgICAgICAgICBtYXJvb246JyM4MDAwMDAnLAogICAgICAgICAgICAgICAgcmVkOicjZmYwMDAwJywKICAgICAgICAgICAgICAgIHB1cnBsZTonIzgwMDA4MCcsCiAgICAgICAgICAgICAgICBmdWNoc2lhOicjZmYwMGZmJywKICAgICAgICAgICAgICAgIGdyZWVuOicjMDA4MDAwJywKICAgICAgICAgICAgICAgIGxpbWU6JyMwMGZmMDAnLAogICAgICAgICAgICAgICAgb2xpdmU6JyM4MDgwMDAnLAogICAgICAgICAgICAgICAgeWVsbG93OicjZmZmZjAnLAogICAgICAgICAgICAgICAgbmF2eTonIzAwMDA4MCcsCiAgICAgICAgICAgICAgICBibHVlOicjMDAwMGZmJywKICAgICAgICAgICAgICAgIHRlYWw6JyMwMDgwODAnLAogICAgICAgICAgICAgICAgYXF1YTonIzAwZmZmZicKICAgICAgICAgICAgfTsKICAgICAgICBpZiAocmVnMS50ZXN0KGNvbG9yKSkgewogICAgICAgICAgICAvLyAjUlJHR0JCIOebtOaOpei/lOWbngogICAgICAgICAgICByZXR1cm4gY29sb3I7CiAgICAgICAgfSBlbHNlIGlmIChyZWcyLnRlc3QoY29sb3IpKSB7CiAgICAgICAgICAgIC8vIOmdnklF5Lit55qEIHJnYigwLCAwLCAwKQogICAgICAgICAgICBmb3IgKHZhciBzLCBpID0gMSwgY29sb3IgPSAiIyI7IGkgPCA0OyBpKyspIHsKICAgICAgICAgICAgICAgIHMgPSBwYXJzZUludChSZWdFeHBbIlx4MjQiICsgaV0pLnRvU3RyaW5nKDE2KTsKICAgICAgICAgICAgICAgIGNvbG9yICs9ICgiMDAiICsgcykuc3Vic3RyKHMubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29sb3I7CiAgICAgICAgfSBlbHNlIGlmICgvXlwjW1xkYS1mXXszfSQvLnRlc3QoY29sb3IpKSB7CiAgICAgICAgICAgIC8vIOeugOWGmeeahOminOiJsuWAvDogI0YwMAogICAgICAgICAgICB2YXIgczEgPSBjb2xvci5jaGFyQXQoMSksCiAgICAgICAgICAgICAgICBzMiA9IGNvbG9yLmNoYXJBdCgyKSwKICAgICAgICAgICAgICAgIHMzID0gY29sb3IuY2hhckF0KDMpOwogICAgICAgICAgICByZXR1cm4gIiMiICsgczEgKyBzMSArIHMyICsgczIgKyBzMyArIHMzOwogICAgICAgIH0gZWxzZSBpZiAoa2V5d29yZFtjb2xvcl0pCiAgICAgICAgICAgIHJldHVybiBrZXl3b3JkW2NvbG9yXTsKCiAgICAgICAgcmV0dXJuICIiOwoKICAgIH0sCiAgICBoYXNTYW1lQXR0cnM6ZnVuY3Rpb24gKG5vZGVBLCBub2RlQikgewogICAgICAgIGlmIChub2RlQS50YWdOYW1lICE9IG5vZGVCLnRhZ05hbWUpCiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIHZhciB0aGlzQXR0cmlicyA9IG5vZGVBLmF0dHJpYnV0ZXMsCiAgICAgICAgICAgIG90aGVyQXR0cmlicyA9IG5vZGVCLmF0dHJpYnV0ZXM7CiAgICAgICAgaWYgKHRoaXNBdHRyaWJzLmxlbmd0aCAhPSBvdGhlckF0dHJpYnMubGVuZ3RoKQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICBpZiAodGhpc0F0dHJpYnMubGVuZ3RoID09IDApCiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgIHZhciBhdHRyQSwgYXR0ckI7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGF0dHJBID0gdGhpc0F0dHJpYnNbaSsrXTspIHsKICAgICAgICAgICAgaWYgKGF0dHJBLm5vZGVOYW1lID09ICdzdHlsZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzU2FtZVN0eWxlKG5vZGVBLCBub2RlQikpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXVhLmJyb3dzZXIuaWUgfHwgYXR0ckEuc3BlY2lmaWVkKSB7CiAgICAgICAgICAgICAgICBhdHRyQiA9IG5vZGVCLmF0dHJpYnV0ZXNbYXR0ckEubm9kZU5hbWVdOwogICAgICAgICAgICAgICAgaWYgKCFhdHRyQikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMTsKICAgIH0sCiAgICAvKioKICAgICAq5riF6Zmk56m6VGV4dOiKgueCuQogICAgICovCgogICAgY2xlYXJXaGl0ZU5vZGU6ZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgdG1wTm9kZSA9IG5vZGUuY2hpbGROb2Rlc1tpXTsKICAgICAgICAgICAgaWYgKHRtcE5vZGUubm9kZVR5cGUgPT0gMyAmJiAhdG1wTm9kZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRtcE5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0bXBOb2RlKTsKICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICAvKioKICAgICAq5qOA5p+l5Lik5Liq6IqC54K577yI5YyF5ZCr5omA5pyJ5a2Q6IqC54K577yJ5piv5ZCm5YW35pyJ55u45ZCM55qE5bGe5oCnCiAgICAgKi8KICAgIGZsYWc6dHJ1ZSwKICAgIGNoZWNrQWxsQ2hpbGRBdHRyaWJzOmZ1bmN0aW9uIChub2RlQSwgbm9kZUIpIHsKICAgICAgICB2YXIgayA9IG5vZGVBLmNoaWxkTm9kZXMubGVuZ3RoOwogICAgICAgIGlmIChrICE9IG5vZGVCLmNoaWxkTm9kZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIGlmICh1YS5icm93c2VyLm9wZXJhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyV2hpdGVOb2RlKG5vZGVBKTsKICAgICAgICAgICAgICAgIGsgPSBub2RlQS5jaGlsZE5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChrICE9IG5vZGVCLmNoaWxkTm9kZXMubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgIHRoaXMuZmxhZyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRoaXMuZmxhZyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuZmxhZykKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmxhZzsKICAgICAgICB3aGlsZSAoaykgewogICAgICAgICAgICB2YXIgdG1wTm9kZUEgPSBub2RlQS5jaGlsZE5vZGVzW2sgLSAxXTsKICAgICAgICAgICAgdmFyIHRtcE5vZGVCID0gbm9kZUIuY2hpbGROb2Rlc1trIC0gMV07CiAgICAgICAgICAgIGstLTsKCiAgICAgICAgICAgIGlmICh0bXBOb2RlQS5ub2RlVHlwZSA9PSAzIHx8IHRtcE5vZGVCLm5vZGVUeXBlID09IDMgfHwgdG1wTm9kZUEubm9kZVR5cGUgPT0gOCB8fCB0bXBOb2RlQi5ub2RlVHlwZSA9PSA4KQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNTYW1lQXR0cnModG1wTm9kZUEsIHRtcE5vZGVCKSkgewogICAgICAgICAgICAgICAgdGhpcy5mbGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuY2hlY2tBbGxDaGlsZEF0dHJpYnModG1wTm9kZUEsIHRtcE5vZGVCKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZmxhZzsKICAgIH0sCiAgICBoYXZlU2FtZUFsbENoaWxkQXR0cmliczpmdW5jdGlvbiAobm9kZUEsIG5vZGVCKSB7CiAgICAgICAgdGhpcy5mbGFnID0gdHJ1ZTsKICAgICAgICByZXR1cm4gdGhpcy5jaGVja0FsbENoaWxkQXR0cmlicyhub2RlQSwgbm9kZUIpOwogICAgfSwKICAgIC8q5p+l55yL5Lyg5YWl55qEaHRtbOaYr+WQpuS4juS8oOWFpeeahOWFg+e0oGVsZeWFt+acieebuOWQjOeahHN0eWxlKi8KICAgIGNoZWNrSFRNTFNhbWVTdHlsZTpmdW5jdGlvbiAoaHRtbCwgZG9jLCBlbGUsIGRlc2NyaXB0KSB7CiAgICAgICAgdmFyIHRhZ0VsZSA9IGRvYy5jcmVhdGVFbGVtZW50KGVsZS50YWdOYW1lKTsKICAgICAgICB0YWdFbGUuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAvKuS8muacieS4gOS6m+S4jeWPr+ingeWtl+espu+8jOWcqOavlOi+g+WJjeaPkOWJjeWIoOaOiSovCiAgICAgICAgdGhpcy5tYW51YWxEZWxldGVGaWxsRGF0YShlbGUpOwogICAgICAgIG9rKHRoaXMuaGF2ZVNhbWVBbGxDaGlsZEF0dHJpYnMoZWxlLCB0YWdFbGUpLCBkZXNjcmlwdCk7Ci8vICAgICAgICBvayh0aGlzLmVxdWFsc05vZGUoZWxlLmlubmVySE1UTCxodG1sKSxkZXNjcmlwdCk7CiAgICB9LAoKCiAgICBlcXVhbHNOb2RlOmZ1bmN0aW9uIChuYSwgbmIpIHsKICAgICAgICBmdW5jdGlvbiBjb21wYXJlKG5vZGVBLCBub2RlQikgewogICAgICAgICAgICBpZiAobm9kZUEubm9kZVR5cGUgIT0gbm9kZUIubm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlQS5ub2RlVHlwZSA9PSAzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIG5vZGVBLm5vZGVWYWx1ZSA9PSBub2RlQi5ub2RlVmFsdWUKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNTYW1lRWxlbWVudChub2RlQSwgbm9kZUIpKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5vZGVBLmZpcnN0Q2hpbGQgJiYgIW5vZGVCLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlQS5maXJzdENoaWxkICYmICFub2RlQi5maXJzdENoaWxkIHx8ICFub2RlQS5maXJzdENoaWxkICYmIG5vZGVCLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGFpLCBiaTsgYWkgPSBub2RlQS5jaGlsZE5vZGVzW2ldLCBiaSA9IG5vZGVCLmNoaWxkTm9kZXNbaSsrXTspIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb21wYXJlKGFpLCBiaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY29tcGFyZShkb21VdGlscy5jcmVhdGVFbGVtZW50KGRvY3VtZW50LCAnZGl2JywgewogICAgICAgICAgICAnaW5uZXJIVE1MJzpuYQogICAgICAgIH0pLCBkb21VdGlscy5jcmVhdGVFbGVtZW50KGRvY3VtZW50LCAnZGl2JywgewogICAgICAgICAgICAnaW5uZXJIVE1MJzpuYgogICAgICAgIH0pKTsKICAgIH0sCgoKICAgIGdldFNlbGVjdGVkVGV4dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHdpbmRvdy5nZXRTZWxlY3Rpb24pIHsKICAgICAgICAgICAgLy8gVGhpcyB0ZWNobmlxdWUgaXMgdGhlIG1vc3QgbGlrZWx5IHRvIGJlIHN0YW5kYXJkaXplZC4KICAgICAgICAgICAgLy8gZ2V0U2VsZWN0aW9uKCkgcmV0dXJucyBhIFNlbGVjdGlvbiBvYmplY3QsIHdoaWNoIHdlIGRvIG5vdCBkb2N1bWVudC4KICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5nZXRTZWxlY3Rpb24oKS50b1N0cmluZygpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChkb2N1bWVudC5nZXRTZWxlY3Rpb24pIHsKICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBvbGRlciwgc2ltcGxlciB0ZWNobmlxdWUgdGhhdCByZXR1cm5zIGEgc3RyaW5nCiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZG9jdW1lbnQuc2VsZWN0aW9uKSB7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIElFLXNwZWNpZmljIHRlY2huaXF1ZS4KICAgICAgICAgICAgLy8gV2UgZG8gbm90IGRvY3VtZW50IHRoZSBJRSBzZWxlY3Rpb24gcHJvcGVydHkgb3IgVGV4dFJhbmdlIG9iamVjdHMuCiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKS50ZXh0OwogICAgICAgIH0KICAgIH0sCiAgICBmaW5kUG9zaXRpb246ZnVuY3Rpb24gKG9FbGVtZW50KSB7CiAgICAgICAgdmFyIHgyID0gMDsKICAgICAgICB2YXIgeTIgPSAwOwogICAgICAgIHZhciB3aWR0aCA9IG9FbGVtZW50Lm9mZnNldFdpZHRoOwogICAgICAgIHZhciBoZWlnaHQgPSBvRWxlbWVudC5vZmZzZXRIZWlnaHQ7CiAgICAgICAgaWYgKHR5cGVvZiggb0VsZW1lbnQub2Zmc2V0UGFyZW50ICkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgZm9yICh2YXIgcG9zWCA9IDAsIHBvc1kgPSAwOyBvRWxlbWVudDsgb0VsZW1lbnQgPSBvRWxlbWVudC5vZmZzZXRQYXJlbnQpIHsKICAgICAgICAgICAgICAgIHBvc1ggKz0gb0VsZW1lbnQub2Zmc2V0TGVmdDsKICAgICAgICAgICAgICAgIHBvc1kgKz0gb0VsZW1lbnQub2Zmc2V0VG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHgyID0gcG9zWCArIHdpZHRoOwogICAgICAgICAgICB5MiA9IHBvc1kgKyBoZWlnaHQ7CiAgICAgICAgICAgIHJldHVybiBbIHBvc1gsIHBvc1kgLCB4MiwgeTJdOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4MiA9IG9FbGVtZW50LnggKyB3aWR0aDsKICAgICAgICAgICAgeTIgPSBvRWxlbWVudC55ICsgaGVpZ2h0OwogICAgICAgICAgICByZXR1cm4gWyBvRWxlbWVudC54LCBvRWxlbWVudC55LCB4MiwgeTJdOwogICAgICAgIH0KICAgIH0sCgogICAgY2hlY2tFbGVtZW50UGF0aDpmdW5jdGlvbiAoYXJyMSwgYXJyMiwgZGVzY3JpcHQpIHsKICAgICAgICBpZiAoIWRlc2NyaXB0KQogICAgICAgICAgICBkZXNjcmlwdCA9ICcnOwogICAgICAgIHZhciBpbmRleCA9IGFycjEubGVuZ3RoOwogICAgICAgIGlmIChpbmRleCAhPSBhcnIyLmxlbmd0aCkKICAgICAgICAgICAgb2soZmFsc2UsICfot6/lvoTmt7HluqbkuI3nm7jlkIwnKTsKICAgICAgICBlbHNlIHsKCiAgICAgICAgICAgIHdoaWxlIChpbmRleCA+IDApCiAgICAgICAgICAgICAgICBlcXVhbChhcnIxWy0taW5kZXggXSwgYXJyMltpbmRleCBdLCBkZXNjcmlwdCArICctLS3nrKwnICsgaW5kZXggKyAn5Liq5YWD57SgJyArIGFycjFbaW5kZXhdKTsKICAgICAgICB9CiAgICB9LAogICAgZ2V0QnJvd3NlcjpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGJyb3dzZXIgPSAiIjsKICAgICAgICBpZiAodGhpcy5icm93c2VyLmllID09IDYpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnaWU2JzsKICAgICAgICBpZiAodGhpcy5icm93c2VyLmllID09IDcpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnaWU3JzsKICAgICAgICBpZiAodGhpcy5icm93c2VyLmllID09IDgpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnaWU4JzsKICAgICAgICBpZiAodGhpcy5icm93c2VyLmllID09IDkpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnaWU5JzsKICAgICAgICBpZiAodGhpcy5icm93c2VyLnNhZmFyaSkKICAgICAgICAgICAgYnJvd3NlciA9ICdzYWZhcmknOwogICAgICAgIGlmICh0aGlzLmJyb3dzZXIuZmlyZWZveCkKICAgICAgICAgICAgYnJvd3NlciA9ICdmaXJlZm94JzsKICAgICAgICBpZiAodGhpcy5icm93c2VyLmNocm9tZSkKICAgICAgICAgICAgYnJvd3NlciA9ICdjaHJvbWUnOwogICAgICAgIGlmICh0aGlzLmJyb3dzZXIubWF4dGhvbikgewogICAgICAgICAgICBicm93c2VyID0gJ21heHRob24nOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5icm93c2VyLm1heHRob25JRSkKICAgICAgICAgICAgYnJvd3NlciA9ICdtYXhJRSc7CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5vcGVyYSkKICAgICAgICAgICAgYnJvd3NlciA9ICdvcGVyYSc7CiAgICAgICAgcmV0dXJuIGJyb3dzZXI7CiAgICB9LAogICAgZ2V0RmxvYXRTdHlsZTpmdW5jdGlvbiAoZWxlKSB7CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5pZSkKICAgICAgICAgICAgcmV0dXJuIGVsZS5zdHlsZVsnc3R5bGVGbG9hdCddOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGVsZS5zdHlsZVsnY3NzRmxvYXQnXTsKICAgIH0sCgogICAgZ2V0Q29tcHV0ZWRTdHlsZTpmdW5jdGlvbihlbGUgKXsKICAgICAgICBpZih0aGlzLmJyb3dzZXIuaWUmJnVhLmJyb3dzZXIuaWU8OSl7CiAgICAgICAgICAgIHJldHVybiBlbGUuY3VycmVudFN0eWxlOwogICAgICAgIH1lbHNlewogICAgICAgICAgICByZXR1cm4gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlKTsKICAgICAgICB9CiAgICB9LAogICAgcmVhZEZpbGU6ZnVuY3Rpb24gKG5hbWUsIGYpIHsKICAgICAgICB2YXIgYXJncyA9IHt9OwogICAgICAgIGFyZ3NbJ25hbWUnXSA9ICBuYW1lOwogICAgICAgICQuYWpheCh7CiAgICAgICAgICAgIHVybDoncmVhZC5waHAnLAogICAgICAgICAgICB0eXBlOidwb3N0JywKICAgICAgICAgICAgZGF0YTphcmdzLAogICAgICAgICAgICBzdWNjZXNzOmZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgIGYobXNnKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXJyb3I6ZnVuY3Rpb24gKHhociwgbXNnKSB7CiAgICAgICAgICAgICAgICBmKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgcmVhZFR4dDpmdW5jdGlvbiAobmFtZSwgZikgewogICAgICAgIHZhciBhcmdzID0ge307CiAgICAgICAgYXJnc1snbmFtZSddID0gJy4vdHh0LycgKyBuYW1lOwogICAgICAgICQuYWpheCh7CiAgICAgICAgICAgIHVybDoncmVhZC5waHAnLAogICAgICAgICAgICB0eXBlOidwb3N0JywKICAgICAgICAgICAgZGF0YTphcmdzLAogICAgICAgICAgICBzdWNjZXNzOmZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgIGYobXNnKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXJyb3I6ZnVuY3Rpb24gKHhociwgbXNnKSB7CiAgICAgICAgICAgICAgICBmKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LCBjaGVja0xvd2VyQ2FzZTpmdW5jdGlvbiAoc3RyaW5nQSwgc3RyaW5nQikgewogICAgICAgIGlmICghKHN0cmluZ0EgfHwgc3RyaW5nQikpCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UgaWYgKCFzdHJpbmdBIHx8ICFzdHJpbmdCKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmdBLnRvTG93ZXJDYXNlKCkgPT0gc3RyaW5nQi50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0KICAgIH0sIHJlbW92ZUVuZFNlbWljb2xvbjpmdW5jdGlvbiAoc3R5bGVWYWx1ZSkgewogICAgICAgIGlmIChzdHlsZVZhbHVlLmxlbmd0aCAtIDEgPT0gc3R5bGVWYWx1ZS5sYXN0SW5kZXhPZignOycpKQogICAgICAgICAgICBzdHlsZVZhbHVlID0gc3R5bGVWYWx1ZS5zdWJzdHJpbmcoMCwgc3R5bGVWYWx1ZS5sZW5ndGggLSAxKTsKICAgICAgICByZXR1cm4gc3R5bGVWYWx1ZTsKICAgIH0sIGNoZWNrTm9kZVN0eWxlOmZ1bmN0aW9uIChub2RlQSwgbm9kZUIpIHsKICAgICAgICB2YXIgbm9kZUFTdHlsZSA9IHRoaXMucmVtb3ZlRW5kU2VtaWNvbG9uKG5vZGVBLmdldEF0dHIoInN0eWxlIikucmVwbGFjZSgvXHMrL2csICIiKSkucmVwbGFjZSgvJnF1b3Q7L2csJycpLnNwbGl0KCI7Iik7CiAgICAgICAgdmFyIG5vZGVCU3R5bGUgPSB0aGlzLnJlbW92ZUVuZFNlbWljb2xvbihub2RlQi5nZXRBdHRyKCJzdHlsZSIpLnJlcGxhY2UoL1xzKy9nLCAiIikpLnJlcGxhY2UoLyZxdW90Oy9nLCcnKS5zcGxpdCgiOyIpOwogICAgICAgIHZhciBsZW5ndGhBID0gbm9kZUFTdHlsZS5sZW5ndGg7CiAgICAgICAgdmFyIGxlbmd0aEIgPSBub2RlQlN0eWxlLmxlbmd0aDsKICAgICAgICBpZiAoIShsZW5ndGhBICYmIGxlbmd0aEIpKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBlbHNlIGlmIChsZW5ndGhBICE9IGxlbmd0aEIpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGhBOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChub2RlQVN0eWxlW2ldLm1hdGNoKC9bLVx3XStccyo6LykgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlTmFtZSA9IG5vZGVBU3R5bGVbaV0ubWF0Y2goL1stXHddK1xzKjovKVswXS5yZXBsYWNlKC9ccyo6LywgIiIpOwogICAgICAgICAgICAgICAgICAgIG5vZGVBLmF0dHJzLnN0eWxlID0gbm9kZUEuYXR0cnMuc3R5bGUucmVwbGFjZSgvJnF1b3Q7L2csJycpOwogICAgICAgICAgICAgICAgICAgIG5vZGVCLmF0dHJzLnN0eWxlID0gbm9kZUIuYXR0cnMuc3R5bGUucmVwbGFjZSgvJnF1b3Q7L2csJycpOwogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlQSA9IG5vZGVBLmdldFN0eWxlKHN0eWxlTmFtZSkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9ccysvZywgIiIpOwogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlQiA9IG5vZGVCLmdldFN0eWxlKHN0eWxlTmFtZSkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9ccysvZywgIiIpOwogICAgICAgICAgICAgICAgICAgIGlmKC9jb2xvci8udGVzdChzdHlsZU5hbWUpKXsKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVWYWx1ZUEgPSB0aGlzLmZvcm1hdENvbG9yKHN0eWxlVmFsdWVBKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVWYWx1ZUIgPSB0aGlzLmZvcm1hdENvbG9yKHN0eWxlVmFsdWVCKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3R5bGVWYWx1ZUEgIT0gc3R5bGVWYWx1ZUIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sIGdldFByb3BlcnR5Q291bnQ6ZnVuY3Rpb24gKG8pIHsKICAgICAgICB2YXIgbiwgY291bnQgPSAwOwogICAgICAgIGZvciAobiBpbiBvKSB7CiAgICAgICAgICAgIGlmIChvLmhhc093blByb3BlcnR5KG4pKSB7CiAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb3VudDsKICAgIH0sZm9ybUhyZWY6ZnVuY3Rpb24oc3RyKXsKICAgICAgICBpZihzdHIubGFzdEluZGV4T2YoJy8nKT09IHN0ci5sZW5ndGgtMSl7CiAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCxzdHIubGVuZ3RoLTEpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgfSxjaGVja1NhbWVOb2RlQXR0cnM6ZnVuY3Rpb24gKG5vZGVBLCBub2RlQikgewogICAgICAgIHZhciBsZW5ndGhBID0gdGhpcy5nZXRQcm9wZXJ0eUNvdW50KG5vZGVBLmF0dHJzKTsKICAgICAgICB2YXIgbGVuZ3RoQiA9IHRoaXMuZ2V0UHJvcGVydHlDb3VudChub2RlQi5hdHRycyk7CiAgICAgICAgaWYgKCEobGVuZ3RoQSAmJiBsZW5ndGhCKSkKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgZWxzZSBpZiAobGVuZ3RoQSAhPSBsZW5ndGhCKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGZvciAodmFyIHAgaW4gbm9kZUEuYXR0cnMpIHsKICAgICAgICAgICAgICAgIGlmKCFub2RlQi5nZXRBdHRyKHApJiYhbm9kZUEuZ2V0QXR0cihwKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFub2RlQi5nZXRBdHRyKHApfHwhbm9kZUEuZ2V0QXR0cihwKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwLnRvTG93ZXJDYXNlKCkgPT0gInN0eWxlIikgewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5jaGVja05vZGVTdHlsZShub2RlQSwgbm9kZUIpKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKHAudG9Mb3dlckNhc2UoKSA9PSAiaHJlZiIpewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZvcm1IcmVmKG5vZGVBLmdldEF0dHIocCkudG9Mb3dlckNhc2UoKSkgIT0gdGhpcy5mb3JtSHJlZihub2RlQi5nZXRBdHRyKHApLnRvTG93ZXJDYXNlKCkpKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZUEuZ2V0QXR0cihwKS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAiIikgIT0gbm9kZUIuZ2V0QXR0cihwKS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAiIikpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LCBjaGVja0NoaWxkcmVuOmZ1bmN0aW9uIChub2RlQSwgbm9kZUIpIHsKICAgICAgICBpZiAoIShub2RlQS5jaGlsZHJlbiB8fCBub2RlQi5jaGlsZHJlbikpCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UgaWYgKCEobm9kZUEuY2hpbGRyZW4gJiYgbm9kZUIuY2hpbGRyZW4pKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSBpZiAobm9kZUEuY2hpbGRyZW4ubGVuZ3RoICE9IG5vZGVCLmNoaWxkcmVuLmxlbmd0aCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgbGVuZ3RoQSA9IG5vZGVBLmNoaWxkcmVuLmxlbmd0aDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGhBOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5jaGVja1NhbWVOb2RlKG5vZGVBLmNoaWxkcmVuW2ldLCBub2RlQi5jaGlsZHJlbltpXSkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwgY2hlY2tTYW1lTm9kZTpmdW5jdGlvbiAobm9kZUEsIG5vZGVCKSB7CiAgICAgICAgaWYgKCF0aGlzLmNoZWNrU2FtZU5vZGVBdHRycyhub2RlQSwgbm9kZUIpKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSBpZiAoIXRoaXMuY2hlY2tDaGlsZHJlbihub2RlQSwgbm9kZUIpKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSBpZiAobm9kZUEuZGF0YSAhPSBub2RlQi5kYXRhKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSBpZiAoIXRoaXMuY2hlY2tMb3dlckNhc2Uobm9kZUEudGFnTmFtZSwgbm9kZUIudGFnTmFtZSkpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBlbHNlIGlmICghdGhpcy5jaGVja0xvd2VyQ2FzZShub2RlQS50eXBlLCBub2RlQi50eXBlKSkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LCBjaGVja1NhbWVIdG1sOmZ1bmN0aW9uIChzdHJpbmdBLCBzdHJpbmdCLCBzY2hvbGl1bSkgewogICAgICAgIG9rKHRoaXMuY2hlY2tTYW1lTm9kZShVRS5odG1scGFyc2VyKHN0cmluZ0EpLCBVRS5odG1scGFyc2VyKHN0cmluZ0IpKSwgc2Nob2xpdW0pOwogICAgfSwKICAgIGdldENvbnRleHRtZW51SW5kZXhCeU5hbWU6ZnVuY3Rpb24oY29udGV4dG1lbnUsbmFtZSl7CiAgICAgICAgZm9yKHZhciBpPTA7aTxjb250ZXh0bWVudS5sZW5ndGg7aSsrKXsKICAgICAgICAgICAgaWYoY29udGV4dG1lbnVbaV0uaW5uZXJUZXh0ID09bmFtZSB8fCBjb250ZXh0bWVudVtpXS50ZXh0Q29udGVudCA9PW5hbWUpCiAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9Cn07CnZhciB1YSA9IFVzZXJBY3Rpb247CnZhciB1cGF0aCA9IHVhLmNvbW1vbkRhdGEuY3VycmVudFBhdGgoKTsKdmFyIGNwYXRoID0gdWEuY29tbW9uRGF0YS5kYXRhZGlyOw==",
                "body": "LyoqCiAqIOa1i+ivleeUqOS+i+W6k+aWh+S7tu+8jOaPkOS+m+WmgmV2ZW50IG1vY2vjgIFpZnJhbWXlsIHoo4XnrYnlkITnp43luLjnlKjlip/og70g6YOo5YiG5pa55rOV5p2l5rqQ5LqOWVVJ5rWL6K+V5qGG5p62CiAqLwpVc2VyQWN0aW9uID0gewogICAgYmVmb3JlZGlzcGF0Y2g6bnVsbCwKLy8gICAgZmxhZyA6IHRydWUsCiAgICBpc2YgLyogaXMgZnVuY3Rpb24gPyAqLzpmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgJiYgKHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nKTsKICAgIH0sCiAgICBpc2IgLyogaXMgYm9vbGVhbj8gKi86ZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlICYmICh0eXBlb2YgdmFsdWUgPT0gJ2Jvb2xlYW4nKTsKICAgIH0sCiAgICBpc28gLyogaXMgb2JqZWN0PyAqLzpmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgJiYgKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0Jyk7CiAgICB9LAogICAgaXNzIC8qIGlzIHN0cmluZz8gKi86ZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlICYmICh0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZycpOwogICAgfSwKICAgIGlzbiAvKiBpcyBudW1iZXI/ICovOmZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSAmJiAodHlwZW9mIHZhbHVlID09ICdudW1iZXInKTsKICAgIH0sCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gR2VuZXJpYyBldmVudCBtZXRob2RzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEga2V5IGV2ZW50IHVzaW5nIHRoZSBnaXZlbiBldmVudCBpbmZvcm1hdGlvbiB0byBwb3B1bGF0ZSB0aGUKICAgICAqIGdlbmVyYXRlZCBldmVudCBvYmplY3QuIFRoaXMgbWV0aG9kIGRvZXMgYnJvd3Nlci1lcXVhbGl6aW5nIGNhbGN1bGF0aW9ucwogICAgICogdG8gYWNjb3VudCBmb3IgZGlmZmVyZW5jZXMgaW4gdGhlIERPTSBhbmQgSUUgZXZlbnQgbW9kZWxzIGFzIHdlbGwgYXMKICAgICAqIGRpZmZlcmVudCBicm93c2VyIHF1aXJrcy4gTm90ZToga2V5ZG93biBjYXVzZXMgU2FmYXJpIDIueCB0byBjcmFzaC4KICAgICAqCiAgICAgKiBAbWV0aG9kIHNpbXVsYXRlS2V5RXZlbnQKICAgICAqIEBwcml2YXRlCiAgICAgKiBAc3RhdGljCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIHRhcmdldCBvZiB0aGUgZ2l2ZW4gZXZlbnQuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30KICAgICAgICAqICAgICAgICAgICAgdHlwZSBUaGUgdHlwZSBvZiBldmVudCB0byBmaXJlLiBUaGlzIGNhbiBiZSBhbnkgb25lIG9mIHRoZQogICAgICogICAgICAgICAgICBmb2xsb3dpbmc6IGtleXVwLCBrZXlkb3duLCBhbmQga2V5cHJlc3MuCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59CiAgICAgICAgKiAgICAgICAgICAgIGJ1YmJsZXMgKE9wdGlvbmFsKSBJbmRpY2F0ZXMgaWYgdGhlIGV2ZW50IGNhbiBiZSBidWJibGVkIHVwLgogICAgICogICAgICAgICAgICBET00gTGV2ZWwgMyBzcGVjaWZpZXMgdGhhdCBhbGwga2V5IGV2ZW50cyBidWJibGUgYnkgZGVmYXVsdC4KICAgICAqICAgICAgICAgICAgVGhlIGRlZmF1bHQgaXMgdHJ1ZS4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0KICAgICAgICAqICAgICAgICAgICAgY2FuY2VsYWJsZSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiB0aGUgZXZlbnQgY2FuIGJlIGNhbmNlbGVkCiAgICAgKiAgICAgICAgICAgIHVzaW5nIHByZXZlbnREZWZhdWx0KCkuIERPTSBMZXZlbCAzIHNwZWNpZmllcyB0aGF0IGFsbCBrZXkKICAgICAqICAgICAgICAgICAgZXZlbnRzIGNhbiBiZSBjYW5jZWxsZWQuIFRoZSBkZWZhdWx0IGlzIHRydWUuCiAgICAgKiBAcGFyYW0ge1dpbmRvd30KICAgICAgICAqICAgICAgICAgICAgdmlldyAoT3B0aW9uYWwpIFRoZSB2aWV3IGNvbnRhaW5pbmcgdGhlIHRhcmdldC4gVGhpcyBpcwogICAgICogICAgICAgICAgICB0eXBpY2FsbHkgdGhlIHdpbmRvdyBvYmplY3QuIFRoZSBkZWZhdWx0IGlzIHdpbmRvdy4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0KICAgICAgICAqICAgICAgICAgICAgY3RybEtleSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiBvbmUgb2YgdGhlIENUUkwga2V5cyBpcwogICAgICogICAgICAgICAgICBwcmVzc2VkIHdoaWxlIHRoZSBldmVudCBpcyBmaXJpbmcuIFRoZSBkZWZhdWx0IGlzIGZhbHNlLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBhbHRLZXkgKE9wdGlvbmFsKSBJbmRpY2F0ZXMgaWYgb25lIG9mIHRoZSBBTFQga2V5cyBpcyBwcmVzc2VkCiAgICAgKiAgICAgICAgICAgIHdoaWxlIHRoZSBldmVudCBpcyBmaXJpbmcuIFRoZSBkZWZhdWx0IGlzIGZhbHNlLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBzaGlmdEtleSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiBvbmUgb2YgdGhlIFNISUZUIGtleXMgaXMKICAgICAqICAgICAgICAgICAgcHJlc3NlZCB3aGlsZSB0aGUgZXZlbnQgaXMgZmlyaW5nLiBUaGUgZGVmYXVsdCBpcyBmYWxzZS4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0KICAgICAgICAqICAgICAgICAgICAgbWV0YUtleSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiBvbmUgb2YgdGhlIE1FVEEga2V5cyBpcwogICAgICogICAgICAgICAgICBwcmVzc2VkIHdoaWxlIHRoZSBldmVudCBpcyBmaXJpbmcuIFRoZSBkZWZhdWx0IGlzIGZhbHNlLgogICAgICogQHBhcmFtIHtpbnR9CiAgICAgICAgKiAgICAgICAgICAgIGtleUNvZGUgKE9wdGlvbmFsKSBUaGUgY29kZSBmb3IgdGhlIGtleSB0aGF0IGlzIGluIHVzZS4gVGhlCiAgICAgKiAgICAgICAgICAgIGRlZmF1bHQgaXMgMC4KICAgICAqIEBwYXJhbSB7aW50fQogICAgICAgICogICAgICAgICAgICBjaGFyQ29kZSAoT3B0aW9uYWwpIFRoZSBVbmljb2RlIGNvZGUgZm9yIHRoZSBjaGFyYWN0ZXIKICAgICAqICAgICAgICAgICAgYXNzb2NpYXRlZCB3aXRoIHRoZSBrZXkgYmVpbmcgdXNlZC4gVGhlIGRlZmF1bHQgaXMgMC4KICAgICAqLwogICAgc2ltdWxhdGVLZXlFdmVudDpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgdHlwZSAvKiA6U3RyaW5nICovLCBidWJibGVzIC8qIDpCb29sZWFuICovLCBjYW5jZWxhYmxlIC8qIDpCb29sZWFuICovLCB2aWV3IC8qIDpXaW5kb3cgKi8sIGN0cmxLZXkgLyogOkJvb2xlYW4gKi8sIGFsdEtleSAvKiA6Qm9vbGVhbiAqLywgc2hpZnRLZXkgLyogOkJvb2xlYW4gKi8sIG1ldGFLZXkgLyogOkJvb2xlYW4gKi8sIGtleUNvZGUgLyogOmludCAqLywgY2hhckNvZGUgLyogOmludCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIC8vIGNoZWNrIHRhcmdldAogICAgICAgIHRhcmdldCA9IHR5cGVvZiB0YXJnZXQgPT0gJ3N0cmluZycgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YXJnZXQpCiAgICAgICAgICAgIDogdGFyZ2V0OwogICAgICAgIGlmICghdGFyZ2V0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2ltdWxhdGVLZXlFdmVudCgpOiBJbnZhbGlkIHRhcmdldC4iKTsKICAgICAgICB9CgogICAgICAgIC8vIGNoZWNrIGV2ZW50IHR5cGUKICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgdHlwZSA9IHR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnN0YXJ0IjoKICAgICAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICAgIGNhc2UgImN1dCI6CiAgICAgICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInRleHRldmVudCI6IC8vIERPTSBMZXZlbCAzCiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJrZXlwcmVzcyI7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAvLyBAVE9ETyB3YXMgdGhlIGZhbGx0aHJvdWdoIGludGVudGlvbmFsLCBpZiBzbyB0aHJvdyBlcnJvcgogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNpbXVsYXRlS2V5RXZlbnQoKTogRXZlbnQgdHlwZSAnIiArIHR5cGUKICAgICAgICAgICAgICAgICAgICAgICAgKyAiJyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzaW11bGF0ZUtleUV2ZW50KCk6IEV2ZW50IHR5cGUgbXVzdCBiZSBhIHN0cmluZy4iKTsKICAgICAgICB9CgogICAgICAgIC8vIHNldHVwIGRlZmF1bHQgdmFsdWVzCiAgICAgICAgaWYgKCF0aGlzLmlzYihidWJibGVzKSkgewogICAgICAgICAgICBidWJibGVzID0gdHJ1ZTsgLy8gYWxsIGtleSBldmVudHMgYnViYmxlCiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5pc2IoY2FuY2VsYWJsZSkpIHsKICAgICAgICAgICAgY2FuY2VsYWJsZSA9IHRydWU7IC8vIGFsbCBrZXkgZXZlbnRzIGNhbiBiZSBjYW5jZWxsZWQKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzbyh2aWV3KSkgewogICAgICAgICAgICB2aWV3ID0gd2luZG93OyAvLyB2aWV3IGlzIHR5cGljYWxseSB3aW5kb3cKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzYihjdHJsS2V5KSkgewogICAgICAgICAgICBjdHJsS2V5ID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5pc2IodHlwZW9mIGFsdEtleSA9PSAnYm9vbGVhbicpKSB7CiAgICAgICAgICAgIGFsdEtleSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNiKHNoaWZ0S2V5KSkgewogICAgICAgICAgICBzaGlmdEtleSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNiKG1ldGFLZXkpKSB7CiAgICAgICAgICAgIG1ldGFLZXkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCEodHlwZW9mIGtleUNvZGUgPT0gJ251bWJlcicpKSB7CiAgICAgICAgICAgIGtleUNvZGUgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoISh0eXBlb2YgY2hhckNvZGUgPT0gJ251bWJlcicpKSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIHRyeSB0byBjcmVhdGUgYSBtb3VzZSBldmVudAogICAgICAgIHZhciBjdXN0b21FdmVudCAvKiA6TW91c2VFdmVudCAqLyA9IG51bGw7CgogICAgICAgIC8vIGNoZWNrIGZvciBET00tY29tcGxpYW50IGJyb3dzZXJzIGZpcnN0CiAgICAgICAgaWYgKHRoaXMuaXNmKGRvY3VtZW50LmNyZWF0ZUV2ZW50KSkgewoKICAgICAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICAgICAvLyB0cnkgdG8gY3JlYXRlIGtleSBldmVudAogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiS2V5RXZlbnRzIik7CgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAqIEludGVyZXN0aW5nIHByb2JsZW06IEZpcmVmb3ggaW1wbGVtZW50ZWQgYSBub24tc3RhbmRhcmQKICAgICAgICAgICAgICAgICAqIHZlcnNpb24gb2YgaW5pdEtleUV2ZW50KCkgYmFzZWQgb24gRE9NIExldmVsIDIgc3BlY3MuIEtleQogICAgICAgICAgICAgICAgICogZXZlbnQgd2FzIHJlbW92ZWQgZnJvbSBET00gTGV2ZWwgMiBhbmQgcmUtaW50cm9kdWNlZCBpbiBET00KICAgICAgICAgICAgICAgICAqIExldmVsIDMgd2l0aCBhIGRpZmZlcmVudCBpbnRlcmZhY2UuIEZpcmVmb3ggaXMgdGhlIG9ubHkKICAgICAgICAgICAgICAgICAqIGJyb3dzZXIgd2l0aCBhbnkgaW1wbGVtZW50YXRpb24gb2YgS2V5IEV2ZW50cywgc28gZm9yIG5vdywKICAgICAgICAgICAgICAgICAqIGFzc3VtZSBpdCdzIEZpcmVmb3ggaWYgdGhlIGFib3ZlIGxpbmUgZG9lc24ndCBlcnJvci4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgLy8gVE9ETzogRGVjaXBoZXIgYmV0d2VlbiBGaXJlZm94J3MgaW1wbGVtZW50YXRpb24gYW5kIGEgY29ycmVjdAogICAgICAgICAgICAgICAgLy8gb25lLgogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuaW5pdEtleUV2ZW50KHR5cGUsIGJ1YmJsZXMsIGNhbmNlbGFibGUsIHZpZXcsCiAgICAgICAgICAgICAgICAgICAgY3RybEtleSwgYWx0S2V5LCBzaGlmdEtleSwgbWV0YUtleSwga2V5Q29kZSwgY2hhckNvZGUpOwoKICAgICAgICAgICAgfSBjYXRjaCAoZXggLyogOkVycm9yICovKSB7CgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAqIElmIGl0IGdvdCBoZXJlLCB0aGF0IG1lYW5zIGtleSBldmVudHMgYXJlbid0IG9mZmljaWFsbHkKICAgICAgICAgICAgICAgICAqIHN1cHBvcnRlZC4gU2FmYXJpL1dlYktpdCBpcyBhIHJlYWwgcHJvYmxlbSBub3cuIFdlYktpdCA1MjIKICAgICAgICAgICAgICAgICAqIHdvbid0IGxldCB5b3Ugc2V0IGtleUNvZGUsIGNoYXJDb2RlLCBvciBvdGhlciBwcm9wZXJ0aWVzIGlmCiAgICAgICAgICAgICAgICAgKiB5b3UgdXNlIGEgVUlFdmVudCwgc28gd2UgZmlyc3QgbXVzdCB0cnkgdG8gY3JlYXRlIGEgZ2VuZXJpYwogICAgICAgICAgICAgICAgICogZXZlbnQuIFRoZSBmdW4gcGFydCBpcyB0aGF0IHRoaXMgd2lsbCB0aHJvdyBhbiBlcnJvciBvbgogICAgICAgICAgICAgICAgICogU2FmYXJpIDIueC4gVGhlIGVuZCByZXN1bHQgaXMgdGhhdCB3ZSBuZWVkIGFub3RoZXIKICAgICAgICAgICAgICAgICAqIHRyeS4uLmNhdGNoIHN0YXRlbWVudCBqdXN0IHRvIGRlYWwgd2l0aCB0aGlzIG1lc3MuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHRyeSB7CgogICAgICAgICAgICAgICAgICAgIC8vIHRyeSB0byBjcmVhdGUgZ2VuZXJpYyBldmVudCAtIHdpbGwgZmFpbCBpbiBTYWZhcmkgMi54CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiRXZlbnRzIik7CgogICAgICAgICAgICAgICAgfSBjYXRjaCAodWllcnJvciAvKiA6RXJyb3IgKi8pIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGFib3ZlIGZhaWxlZCwgc28gY3JlYXRlIGEgVUlFdmVudCBmb3IgU2FmYXJpIDIueAogICAgICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIlVJRXZlbnRzIik7CgogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKCiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuaW5pdEV2ZW50KHR5cGUsIGJ1YmJsZXMsIGNhbmNlbGFibGUpOwoKICAgICAgICAgICAgICAgICAgICAvLyBpbml0aWFsaXplCiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQudmlldyA9IHZpZXc7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuYWx0S2V5ID0gYWx0S2V5OwogICAgICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmN0cmxLZXkgPSBjdHJsS2V5OwogICAgICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LnNoaWZ0S2V5ID0gc2hpZnRLZXk7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQubWV0YUtleSA9IG1ldGFLZXk7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQua2V5Q29kZSA9IGtleUNvZGU7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuY2hhckNvZGUgPSBjaGFyQ29kZTsKCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiZWZvcmUgZGlzcGF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuYmVmb3JlZGlzcGF0Y2ggJiYgdHlwZW9mIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2goY3VzdG9tRXZlbnQpOwogICAgICAgICAgICB0aGlzLmJlZm9yZWRpc3BhdGNoID0gbnVsbDsKCiAgICAgICAgICAgIC8vIGZpcmUgdGhlIGV2ZW50CiAgICAgICAgICAgIHRhcmdldC5kaXNwYXRjaEV2ZW50KGN1c3RvbUV2ZW50KTsKCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzbyhkb2N1bWVudC5jcmVhdGVFdmVudE9iamVjdCkpIHsgLy8gSUUKCiAgICAgICAgICAgIC8vIGNyZWF0ZSBhbiBJRSBldmVudCBvYmplY3QKICAgICAgICAgICAgY3VzdG9tRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudE9iamVjdCgpOwoKICAgICAgICAgICAgLy8gYXNzaWduIGF2YWlsYWJsZSBwcm9wZXJ0aWVzCiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmJ1YmJsZXMgPSBidWJibGVzOwogICAgICAgICAgICBjdXN0b21FdmVudC5jYW5jZWxhYmxlID0gY2FuY2VsYWJsZTsKICAgICAgICAgICAgY3VzdG9tRXZlbnQudmlldyA9IHZpZXc7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmN0cmxLZXkgPSBjdHJsS2V5OwogICAgICAgICAgICBjdXN0b21FdmVudC5hbHRLZXkgPSBhbHRLZXk7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LnNoaWZ0S2V5ID0gc2hpZnRLZXk7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50Lm1ldGFLZXkgPSBtZXRhS2V5OwoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogSUUgZG9lc24ndCBzdXBwb3J0IGNoYXJDb2RlIGV4cGxpY2l0bHkuIENoYXJDb2RlIHNob3VsZCB0YWtlCiAgICAgICAgICAgICAqIHByZWNlZGVuY2Ugb3ZlciBhbnkga2V5Q29kZSB2YWx1ZSBmb3IgYWNjdXJhdGUgcmVwcmVzZW50YXRpb24uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjdXN0b21FdmVudC5rZXlDb2RlID0gKGNoYXJDb2RlID4gMCkgPyBjaGFyQ29kZSA6IGtleUNvZGU7CgogICAgICAgICAgICAvLyBiZWZvcmUgZGlzcGF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuYmVmb3JlZGlzcGF0Y2ggJiYgdHlwZW9mIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2goY3VzdG9tRXZlbnQpOwogICAgICAgICAgICB0aGlzLmJlZm9yZWRpc3BhdGNoID0gbnVsbDsKCiAgICAgICAgICAgIC8vIGZpcmUgdGhlIGV2ZW50CiAgICAgICAgICAgIHRhcmdldC5maXJlRXZlbnQoIm9uIiArIHR5cGUsIGN1c3RvbUV2ZW50KTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgInNpbXVsYXRlS2V5RXZlbnQoKTogTm8gZXZlbnQgc2ltdWxhdGlvbiBmcmFtZXdvcmsgcHJlc2VudC4iKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPSBudWxsOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIG1vdXNlIGV2ZW50IHVzaW5nIHRoZSBnaXZlbiBldmVudCBpbmZvcm1hdGlvbiB0byBwb3B1bGF0ZSB0aGUKICAgICAqIGdlbmVyYXRlZCBldmVudCBvYmplY3QuIFRoaXMgbWV0aG9kIGRvZXMgYnJvd3Nlci1lcXVhbGl6aW5nIGNhbGN1bGF0aW9ucwogICAgICogdG8gYWNjb3VudCBmb3IgZGlmZmVyZW5jZXMgaW4gdGhlIERPTSBhbmQgSUUgZXZlbnQgbW9kZWxzIGFzIHdlbGwgYXMKICAgICAqIGRpZmZlcmVudCBicm93c2VyIHF1aXJrcy4KICAgICAqCiAgICAgKiBAbWV0aG9kIHNpbXVsYXRlTW91c2VFdmVudAogICAgICogQHByaXZhdGUKICAgICAqIEBzdGF0aWMKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgdGFyZ2V0IG9mIHRoZSBnaXZlbiBldmVudC4KICAgICAqIEBwYXJhbSB7U3RyaW5nfQogICAgICAgICogICAgICAgICAgICB0eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRvIGZpcmUuIFRoaXMgY2FuIGJlIGFueSBvbmUgb2YgdGhlCiAgICAgKiAgICAgICAgICAgIGZvbGxvd2luZzogY2xpY2ssIGRibGNsaWNrLCBtb3VzZWRvd24sIG1vdXNldXAsIG1vdXNlb3V0LAogICAgICogICAgICAgICAgICBtb3VzZW92ZXIsIGFuZCBtb3VzZW1vdmUuCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59CiAgICAgICAgKiAgICAgICAgICAgIGJ1YmJsZXMgKE9wdGlvbmFsKSBJbmRpY2F0ZXMgaWYgdGhlIGV2ZW50IGNhbiBiZSBidWJibGVkIHVwLgogICAgICogICAgICAgICAgICBET00gTGV2ZWwgMiBzcGVjaWZpZXMgdGhhdCBhbGwgbW91c2UgZXZlbnRzIGJ1YmJsZSBieSBkZWZhdWx0LgogICAgICogICAgICAgICAgICBUaGUgZGVmYXVsdCBpcyB0cnVlLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBjYW5jZWxhYmxlIChPcHRpb25hbCkgSW5kaWNhdGVzIGlmIHRoZSBldmVudCBjYW4gYmUgY2FuY2VsZWQKICAgICAqICAgICAgICAgICAgdXNpbmcgcHJldmVudERlZmF1bHQoKS4gRE9NIExldmVsIDIgc3BlY2lmaWVzIHRoYXQgYWxsIG1vdXNlCiAgICAgKiAgICAgICAgICAgIGV2ZW50cyBleGNlcHQgbW91c2Vtb3ZlIGNhbiBiZSBjYW5jZWxsZWQuIFRoZSBkZWZhdWx0IGlzIHRydWUKICAgICAqICAgICAgICAgICAgZm9yIGFsbCBldmVudHMgZXhjZXB0IG1vdXNlbW92ZSwgZm9yIHdoaWNoIHRoZSBkZWZhdWx0IGlzCiAgICAgKiAgICAgICAgICAgIGZhbHNlLgogICAgICogQHBhcmFtIHtXaW5kb3d9CiAgICAgICAgKiAgICAgICAgICAgIHZpZXcgKE9wdGlvbmFsKSBUaGUgdmlldyBjb250YWluaW5nIHRoZSB0YXJnZXQuIFRoaXMgaXMKICAgICAqICAgICAgICAgICAgdHlwaWNhbGx5IHRoZSB3aW5kb3cgb2JqZWN0LiBUaGUgZGVmYXVsdCBpcyB3aW5kb3cuCiAgICAgKiBAcGFyYW0ge2ludH0KICAgICAgICAqICAgICAgICAgICAgZGV0YWlsIChPcHRpb25hbCkgVGhlIG51bWJlciBvZiB0aW1lcyB0aGUgbW91c2UgYnV0dG9uIGhhcwogICAgICogICAgICAgICAgICBiZWVuIHVzZWQuIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDEuCiAgICAgKiBAcGFyYW0ge2ludH0KICAgICAgICAqICAgICAgICAgICAgc2NyZWVuWCAoT3B0aW9uYWwpIFRoZSB4LWNvb3JkaW5hdGUgb24gdGhlIHNjcmVlbiBhdCB3aGljaAogICAgICogICAgICAgICAgICBwb2ludCB0aGUgZXZlbnQgb2NjdXJlZC4gVGhlIGRlZmF1bHQgaXMgMC4KICAgICAqIEBwYXJhbSB7aW50fQogICAgICAgICogICAgICAgICAgICBzY3JlZW5ZIChPcHRpb25hbCkgVGhlIHktY29vcmRpbmF0ZSBvbiB0aGUgc2NyZWVuIGF0IHdoaWNoCiAgICAgKiAgICAgICAgICAgIHBvaW50IHRoZSBldmVudCBvY2N1cmVkLiBUaGUgZGVmYXVsdCBpcyAwLgogICAgICogQHBhcmFtIHtpbnR9CiAgICAgICAgKiAgICAgICAgICAgIGNsaWVudFggKE9wdGlvbmFsKSBUaGUgeC1jb29yZGluYXRlIG9uIHRoZSBjbGllbnQgYXQgd2hpY2gKICAgICAqICAgICAgICAgICAgcG9pbnQgdGhlIGV2ZW50IG9jY3VyZWQuIFRoZSBkZWZhdWx0IGlzIDAuCiAgICAgKiBAcGFyYW0ge2ludH0KICAgICAgICAqICAgICAgICAgICAgY2xpZW50WSAoT3B0aW9uYWwpIFRoZSB5LWNvb3JkaW5hdGUgb24gdGhlIGNsaWVudCBhdCB3aGljaAogICAgICogICAgICAgICAgICBwb2ludCB0aGUgZXZlbnQgb2NjdXJlZC4gVGhlIGRlZmF1bHQgaXMgMC4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0KICAgICAgICAqICAgICAgICAgICAgY3RybEtleSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiBvbmUgb2YgdGhlIENUUkwga2V5cyBpcwogICAgICogICAgICAgICAgICBwcmVzc2VkIHdoaWxlIHRoZSBldmVudCBpcyBmaXJpbmcuIFRoZSBkZWZhdWx0IGlzIGZhbHNlLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBhbHRLZXkgKE9wdGlvbmFsKSBJbmRpY2F0ZXMgaWYgb25lIG9mIHRoZSBBTFQga2V5cyBpcyBwcmVzc2VkCiAgICAgKiAgICAgICAgICAgIHdoaWxlIHRoZSBldmVudCBpcyBmaXJpbmcuIFRoZSBkZWZhdWx0IGlzIGZhbHNlLgogICAgICogQHBhcmFtIHtCb29sZWFufQogICAgICAgICogICAgICAgICAgICBzaGlmdEtleSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiBvbmUgb2YgdGhlIFNISUZUIGtleXMgaXMKICAgICAqICAgICAgICAgICAgcHJlc3NlZCB3aGlsZSB0aGUgZXZlbnQgaXMgZmlyaW5nLiBUaGUgZGVmYXVsdCBpcyBmYWxzZS4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0KICAgICAgICAqICAgICAgICAgICAgbWV0YUtleSAoT3B0aW9uYWwpIEluZGljYXRlcyBpZiBvbmUgb2YgdGhlIE1FVEEga2V5cyBpcwogICAgICogICAgICAgICAgICBwcmVzc2VkIHdoaWxlIHRoZSBldmVudCBpcyBmaXJpbmcuIFRoZSBkZWZhdWx0IGlzIGZhbHNlLgogICAgICogQHBhcmFtIHtpbnR9CiAgICAgICAgKiAgICAgICAgICAgIGJ1dHRvbiAoT3B0aW9uYWwpIFRoZSBidXR0b24gYmVpbmcgcHJlc3NlZCB3aGlsZSB0aGUgZXZlbnQgaXMKICAgICAqICAgICAgICAgICAgZXhlY3V0aW5nLiBUaGUgdmFsdWUgc2hvdWxkIGJlIDAgZm9yIHRoZSBwcmltYXJ5IG1vdXNlIGJ1dHRvbgogICAgICogICAgICAgICAgICAodHlwaWNhbGx5IHRoZSBsZWZ0IGJ1dHRvbiksIDEgZm9yIHRoZSB0ZXJjaWFyeSBtb3VzZSBidXR0b24KICAgICAqICAgICAgICAgICAgKHR5cGljYWxseSB0aGUgbWlkZGxlIGJ1dHRvbiksIGFuZCAyIGZvciB0aGUgc2Vjb25kYXJ5IG1vdXNlCiAgICAgKiAgICAgICAgICAgIGJ1dHRvbiAodHlwaWNhbGx5IHRoZSByaWdodCBidXR0b24pLiBUaGUgZGVmYXVsdCBpcyAwLgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgcmVsYXRlZFRhcmdldCAoT3B0aW9uYWwpIEZvciBtb3VzZW91dCBldmVudHMsIHRoaXMgaXMgdGhlCiAgICAgKiAgICAgICAgICAgIGVsZW1lbnQgdGhhdCB0aGUgbW91c2UgaGFzIG1vdmVkIHRvLiBGb3IgbW91c2VvdmVyIGV2ZW50cywKICAgICAqICAgICAgICAgICAgdGhpcyBpcyB0aGUgZWxlbWVudCB0aGF0IHRoZSBtb3VzZSBoYXMgbW92ZWQgZnJvbS4gVGhpcwogICAgICogICAgICAgICAgICBhcmd1bWVudCBpcyBpZ25vcmVkIGZvciBhbGwgb3RoZXIgZXZlbnRzLiBUaGUgZGVmYXVsdCBpcyBudWxsLgogICAgICovCiAgICBzaW11bGF0ZU1vdXNlRXZlbnQ6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIHR5cGUgLyogOlN0cmluZyAqLywgYnViYmxlcyAvKiA6Qm9vbGVhbiAqLywgY2FuY2VsYWJsZSAvKiA6Qm9vbGVhbiAqLywgdmlldyAvKiA6V2luZG93ICovLCBkZXRhaWwgLyogOmludCAqLywgc2NyZWVuWCAvKiA6aW50ICovLCBzY3JlZW5ZIC8qIDppbnQgKi8sIGNsaWVudFggLyogOmludCAqLywgY2xpZW50WSAvKiA6aW50ICovLCBjdHJsS2V5IC8qIDpCb29sZWFuICovLCBhbHRLZXkgLyogOkJvb2xlYW4gKi8sIHNoaWZ0S2V5IC8qIDpCb29sZWFuICovLCBtZXRhS2V5IC8qIDpCb29sZWFuICovLCBidXR0b24gLyogOmludCAqLywgcmVsYXRlZFRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sYnV0dG9uKSAvKiA6Vm9pZCAqLyB7CgogICAgICAgIC8vIGNoZWNrIHRhcmdldAogICAgICAgIHRhcmdldCA9IHR5cGVvZiB0YXJnZXQgPT0gJ3N0cmluZycgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YXJnZXQpCiAgICAgICAgICAgIDogdGFyZ2V0OwogICAgICAgIGlmICghdGFyZ2V0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2ltdWxhdGVNb3VzZUV2ZW50KCk6IEludmFsaWQgdGFyZ2V0LiIpOwogICAgICAgIH0KCiAgICAgICAgLy8gY2hlY2sgZXZlbnQgdHlwZQogICAgICAgIGlmICh0aGlzLmlzcyh0eXBlKSkgewogICAgICAgICAgICB0eXBlID0gdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgICAgICBjYXNlICJjbGljayI6CiAgICAgICAgICAgICAgICBjYXNlICJkYmxjbGljayI6CiAgICAgICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICAgICAgY2FzZSAibW91c2VlbnRlciI6Ly8g6Z2e5qCH5YeG5pSv5oyB77yM5LuF5Li65rWL6K+V5o+Q5L6b77yM6K+l6aG55LuFSUXkuIt3b3JrCiAgICAgICAgICAgICAgICBjYXNlICJtb3VzZWxlYXZlIjoKICAgICAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICAgICAgY2FzZSAiYmx1ciI6CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2ltdWxhdGVNb3VzZUV2ZW50KCk6IEV2ZW50IHR5cGUgJyIgKyB0eXBlCiAgICAgICAgICAgICAgICAgICAgICAgICsgIicgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICJzaW11bGF0ZU1vdXNlRXZlbnQoKTogRXZlbnQgdHlwZSBtdXN0IGJlIGEgc3RyaW5nLiIpOwogICAgICAgIH0KCiAgICAgICAgLy8gc2V0dXAgZGVmYXVsdCB2YWx1ZXMKICAgICAgICBpZiAoIXRoaXMuaXNiKGJ1YmJsZXMpKSB7CiAgICAgICAgICAgIGJ1YmJsZXMgPSB0cnVlOyAvLyBhbGwgbW91c2UgZXZlbnRzIGJ1YmJsZQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuaXNiKGNhbmNlbGFibGUpKSB7CiAgICAgICAgICAgIGNhbmNlbGFibGUgPSAodHlwZSAhPSAibW91c2Vtb3ZlIik7IC8vIG1vdXNlbW92ZSBpcyB0aGUgb25seSBvbmUKICAgICAgICAgICAgLy8gdGhhdCBjYW4ndCBiZSBjYW5jZWxsZWQKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzbyh2aWV3KSkgewogICAgICAgICAgICB2aWV3ID0gd2luZG93OyAvLyB2aWV3IGlzIHR5cGljYWxseSB3aW5kb3cKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzbihkZXRhaWwpKSB7CiAgICAgICAgICAgIGRldGFpbCA9IDE7IC8vIG51bWJlciBvZiBtb3VzZSBjbGlja3MgbXVzdCBiZSBhdCBsZWFzdCBvbmUKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzbihzY3JlZW5YKSkgewogICAgICAgICAgICBzY3JlZW5YID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzbihzY3JlZW5ZKSkgewogICAgICAgICAgICBzY3JlZW5ZID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzbihjbGllbnRYKSkgewogICAgICAgICAgICBjbGllbnRYID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzbihjbGllbnRZKSkgewogICAgICAgICAgICBjbGllbnRZID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzYihjdHJsS2V5KSkgewogICAgICAgICAgICBjdHJsS2V5ID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5pc2IoYWx0S2V5KSkgewogICAgICAgICAgICBhbHRLZXkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzYihzaGlmdEtleSkpIHsKICAgICAgICAgICAgc2hpZnRLZXkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmlzYihtZXRhS2V5KSkgewogICAgICAgICAgICBtZXRhS2V5ID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5pc24oYnV0dG9uKSkgewogICAgICAgICAgICBidXR0b24gPSAwOwogICAgICAgIH0KICAgICAgICAvLyB0cnkgdG8gY3JlYXRlIGEgbW91c2UgZXZlbnQKICAgICAgICB2YXIgY3VzdG9tRXZlbnQgLyogOk1vdXNlRXZlbnQgKi8gPSBudWxsOwoKICAgICAgICAvLyBjaGVjayBmb3IgRE9NLWNvbXBsaWFudCBicm93c2VycyBmaXJzdAogICAgICAgIGlmICh0aGlzLmlzZihkb2N1bWVudC5jcmVhdGVFdmVudCkpIHsKCiAgICAgICAgICAgIGN1c3RvbUV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CiAgICAgICAgICAgIC8vIFNhZmFyaSAyLnggKFdlYktpdCA0MTgpIHN0aWxsIGRvZXNuJ3QgaW1wbGVtZW50IGluaXRNb3VzZUV2ZW50KCkKICAgICAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5pZSA8IDkgJiYgY3VzdG9tRXZlbnQuaW5pdE1vdXNlRXZlbnQpIHsKCiAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5pbml0TW91c2VFdmVudCh0eXBlLCBidWJibGVzLCBjYW5jZWxhYmxlLCB2aWV3LAogICAgICAgICAgICAgICAgICAgIGRldGFpbCwgc2NyZWVuWCwgc2NyZWVuWSwgY2xpZW50WCwgY2xpZW50WSwgY3RybEtleSwKICAgICAgICAgICAgICAgICAgICBhbHRLZXksIHNoaWZ0S2V5LCBtZXRhS2V5LCBidXR0b24sIHJlbGF0ZWRUYXJnZXQpOwogICAgICAgICAgICB9IGVsc2UgeyAvLyBTYWZhcmkKCiAgICAgICAgICAgICAgICAvLyB0aGUgY2xvc2VzdCB0aGluZyBhdmFpbGFibGUgaW4gU2FmYXJpIDIueCBpcyBVSUV2ZW50cwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiVUlFdmVudHMiKTsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCBjYW5jZWxhYmxlKTsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LnZpZXcgPSB2aWV3OwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuZGV0YWlsID0gZGV0YWlsOwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuc2NyZWVuWCA9IHNjcmVlblg7CiAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5zY3JlZW5ZID0gc2NyZWVuWTsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmNsaWVudFggPSBjbGllbnRYOwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuY2xpZW50WSA9IGNsaWVudFk7CiAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5jdHJsS2V5ID0gY3RybEtleTsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmFsdEtleSA9IGFsdEtleTsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50Lm1ldGFLZXkgPSBtZXRhS2V5OwogICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuc2hpZnRLZXkgPSBzaGlmdEtleTsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmJ1dHRvbiA9IGJ1dHRvbjsKICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LnJlbGF0ZWRUYXJnZXQgPSByZWxhdGVkVGFyZ2V0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKgogICAgICAgICAgICAgKiBDaGVjayB0byBzZWUgaWYgcmVsYXRlZFRhcmdldCBoYXMgYmVlbiBhc3NpZ25lZC4gRmlyZWZveCB2ZXJzaW9ucwogICAgICAgICAgICAgKiBsZXNzIHRoYW4gMi4wIGRvbid0IGFsbG93IGl0IHRvIGJlIGFzc2lnbmVkIHZpYSBpbml0TW91c2VFdmVudCgpCiAgICAgICAgICAgICAqIGFuZCB0aGUgcHJvcGVydHkgaXMgcmVhZG9ubHkgYWZ0ZXIgZXZlbnQgY3JlYXRpb24sIHNvIGluIG9yZGVyIHRvCiAgICAgICAgICAgICAqIGtlZXAgWUFIT08udXRpbC5nZXRSZWxhdGVkVGFyZ2V0KCkgd29ya2luZywgYXNzaWduIHRvIHRoZSBJRQogICAgICAgICAgICAgKiBwcm9wcmlldGFyeSB0b0VsZW1lbnQgcHJvcGVydHkgZm9yIG1vdXNlb3V0IGV2ZW50IGFuZCBmcm9tRWxlbWVudAogICAgICAgICAgICAgKiBwcm9wZXJ0eSBmb3IgbW91c2VvdmVyIGV2ZW50LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWYgKHJlbGF0ZWRUYXJnZXQgJiYgIWN1c3RvbUV2ZW50LnJlbGF0ZWRUYXJnZXQpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICJtb3VzZW91dCIpIHsKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC50b0VsZW1lbnQgPSByZWxhdGVkVGFyZ2V0OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJtb3VzZW92ZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuZnJvbUVsZW1lbnQgPSByZWxhdGVkVGFyZ2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiZWZvcmUgZGlzcGF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuYmVmb3JlZGlzcGF0Y2ggJiYgdHlwZW9mIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2goY3VzdG9tRXZlbnQpOwogICAgICAgICAgICB0aGlzLmJlZm9yZWRpc3BhdGNoID0gbnVsbDsKCiAgICAgICAgICAgIC8vIGZpcmUgdGhlIGV2ZW50CiAgICAgICAgICAgIHRhcmdldC5kaXNwYXRjaEV2ZW50KGN1c3RvbUV2ZW50KTsKCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzbyhkb2N1bWVudC5jcmVhdGVFdmVudE9iamVjdCkpIHsgLy8gSUUKCiAgICAgICAgICAgIC8vIGNyZWF0ZSBhbiBJRSBldmVudCBvYmplY3QKICAgICAgICAgICAgY3VzdG9tRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudE9iamVjdCgpOwoKICAgICAgICAgICAgLy8gYXNzaWduIGF2YWlsYWJsZSBwcm9wZXJ0aWVzCiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmJ1YmJsZXMgPSBidWJibGVzOwogICAgICAgICAgICBjdXN0b21FdmVudC5jYW5jZWxhYmxlID0gY2FuY2VsYWJsZTsKICAgICAgICAgICAgY3VzdG9tRXZlbnQudmlldyA9IHZpZXc7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmRldGFpbCA9IGRldGFpbDsKICAgICAgICAgICAgY3VzdG9tRXZlbnQuc2NyZWVuWCA9IHNjcmVlblg7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LnNjcmVlblkgPSBzY3JlZW5ZOwogICAgICAgICAgICBjdXN0b21FdmVudC5jbGllbnRYID0gY2xpZW50WDsKICAgICAgICAgICAgY3VzdG9tRXZlbnQuY2xpZW50WSA9IGNsaWVudFk7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50LmN0cmxLZXkgPSBjdHJsS2V5OwogICAgICAgICAgICBjdXN0b21FdmVudC5hbHRLZXkgPSBhbHRLZXk7CiAgICAgICAgICAgIGN1c3RvbUV2ZW50Lm1ldGFLZXkgPSBtZXRhS2V5OwogICAgICAgICAgICBjdXN0b21FdmVudC5zaGlmdEtleSA9IHNoaWZ0S2V5OwoKICAgICAgICAgICAgLy8gZml4IGJ1dHRvbiBwcm9wZXJ0eSBmb3IgSUUncyB3YWNreSBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgICBzd2l0Y2ggKGJ1dHRvbikgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmJ1dHRvbiA9IDE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRXZlbnQuYnV0dG9uID0gNDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICBjdXN0b21FdmVudC5idXR0b24gPSAyOwogICAgICAgICAgICAgICAgICAgIC8vIGxlYXZlIGFzIGlzCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGN1c3RvbUV2ZW50LmJ1dHRvbiA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIEhhdmUgdG8gdXNlIHJlbGF0ZWRUYXJnZXQgYmVjYXVzZSBJRSB3b24ndCBhbGxvdyBhc3NpZ25tZW50IHRvCiAgICAgICAgICAgICAqIHRvRWxlbWVudCBvciBmcm9tRWxlbWVudCBvbiBnZW5lcmljIGV2ZW50cy4gVGhpcyBrZWVwcwogICAgICAgICAgICAgKiBZQUhPTy51dGlsLmN1c3RvbUV2ZW50LmdldFJlbGF0ZWRUYXJnZXQoKSBmdW5jdGlvbmFsLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3VzdG9tRXZlbnQucmVsYXRlZFRhcmdldCA9IHJlbGF0ZWRUYXJnZXQ7CgogICAgICAgICAgICAvLyBiZWZvcmUgZGlzcGF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuYmVmb3JlZGlzcGF0Y2ggJiYgdHlwZW9mIHRoaXMuYmVmb3JlZGlzcGF0Y2ggPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHRoaXMuYmVmb3JlZGlzcGF0Y2goY3VzdG9tRXZlbnQpOwogICAgICAgICAgICB0aGlzLmJlZm9yZWRpc3BhdGNoID0gbnVsbDsKICAgICAgICAgICAgLy8gZmlyZSB0aGUgZXZlbnQKICAgICAgICAgICAgdGFyZ2V0LmZpcmVFdmVudCgib24iICsgdHlwZSwgY3VzdG9tRXZlbnQpOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAic2ltdWxhdGVNb3VzZUV2ZW50KCk6IE5vIGV2ZW50IHNpbXVsYXRpb24gZnJhbWV3b3JrIHByZXNlbnQuIik7CiAgICAgICAgfQogICAgfSwKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gTW91c2UgZXZlbnRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgbW91c2UgZXZlbnQgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIGNsaWNrIG9uLgogICAgICogQHBhcmFtIHtTdHJpbmd9CiAgICAgICAgKiAgICAgICAgICAgIHR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdG8gZmlyZS4gVGhpcyBjYW4gYmUgYW55IG9uZSBvZiB0aGUKICAgICAqICAgICAgICAgICAgZm9sbG93aW5nOiBjbGljaywgZGJsY2xpY2ssIG1vdXNlZG93biwgbW91c2V1cCwgbW91c2VvdXQsCiAgICAgKiAgICAgICAgICAgIG1vdXNlb3ZlciwgYW5kIG1vdXNlbW92ZS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIG1vdXNlRXZlbnQKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgZmlyZU1vdXNlRXZlbnQ6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIHR5cGUgLyogOlN0cmluZyAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdGhpcy5zaW11bGF0ZU1vdXNlRXZlbnQodGFyZ2V0LCB0eXBlLCBvcHRpb25zLmJ1YmJsZXMsCiAgICAgICAgICAgIG9wdGlvbnMuY2FuY2VsYWJsZSwgb3B0aW9ucy52aWV3LCBvcHRpb25zLmRldGFpbCwKICAgICAgICAgICAgb3B0aW9ucy5zY3JlZW5YLCBvcHRpb25zLnNjcmVlblksIG9wdGlvbnMuY2xpZW50WCwKICAgICAgICAgICAgb3B0aW9ucy5jbGllbnRZLCBvcHRpb25zLmN0cmxLZXksIG9wdGlvbnMuYWx0S2V5LAogICAgICAgICAgICBvcHRpb25zLnNoaWZ0S2V5LCBvcHRpb25zLm1ldGFLZXksIG9wdGlvbnMuYnV0dG9uLAogICAgICAgICAgICBvcHRpb25zLnJlbGF0ZWRUYXJnZXQsb3B0aW9ucy5idXR0b24pOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIGNsaWNrIG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBjbGljayBvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIGNsaWNrCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGNsaWNrOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIDpPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVNb3VzZUV2ZW50KHRhcmdldCwgImNsaWNrIiwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgZG91YmxlIGNsaWNrIG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBkb3VibGUgY2xpY2sgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBkYmxjbGljawogICAgICogQHN0YXRpYwogICAgICovCiAgICBkYmxjbGljazpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlTW91c2VFdmVudCh0YXJnZXQsICJkYmxjbGljayIsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIG1vdXNlZG93biBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgbW91c2Vkb3duCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIG1vdXNlZG93bjpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiBPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVNb3VzZUV2ZW50KHRhcmdldCwgIm1vdXNlZG93biIsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIG1vdXNlbW92ZSBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgbW91c2Vtb3ZlCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIG1vdXNlbW92ZTpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiBPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVNb3VzZUV2ZW50KHRhcmdldCwgIm1vdXNlbW92ZSIsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIG1vdXNlb3V0IGV2ZW50IG9uIGEgcGFydGljdWxhciBlbGVtZW50LiBVc2UgInJlbGF0ZWRUYXJnZXQiCiAgICAgKiBvbiB0aGUgb3B0aW9ucyBvYmplY3QgdG8gc3BlY2lmeSB3aGVyZSB0aGUgbW91c2UgbW92ZWQgdG8uIFF1aXJrczoKICAgICAqIEZpcmVmb3ggbGVzcyB0aGFuIDIuMCBkb2Vzbid0IHNldCByZWxhdGVkVGFyZ2V0IHByb3Blcmx5LCBzbyB0b0VsZW1lbnQgaXMKICAgICAqIGFzc2lnbmVkIGluIGl0cyBwbGFjZS4gSUUgZG9lc24ndCBhbGxvdyB0b0VsZW1lbnQgdG8gYmUgYmUgYXNzaWduZWQsIHNvCiAgICAgKiByZWxhdGVkVGFyZ2V0IGlzIGFzc2lnbmVkIGluIGl0cyBwbGFjZS4gQm90aCBvZiB0aGVzZSBjb25jZXNzaW9ucyBhbGxvdwogICAgICogWUFIT08udXRpbC5FdmVudC5nZXRSZWxhdGVkVGFyZ2V0KCkgdG8gd29yayBjb3JyZWN0bHkgaW4gYm90aCBicm93c2Vycy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgbW91c2VvdXQKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgbW91c2VvdXQ6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogT2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlTW91c2VFdmVudCh0YXJnZXQsICJtb3VzZW91dCIsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIG1vdXNlb3ZlciBldmVudCBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4gVXNlICJyZWxhdGVkVGFyZ2V0IgogICAgICogb24gdGhlIG9wdGlvbnMgb2JqZWN0IHRvIHNwZWNpZnkgd2hlcmUgdGhlIG1vdXNlIG1vdmVkIGZyb20uIFF1aXJrczoKICAgICAqIEZpcmVmb3ggbGVzcyB0aGFuIDIuMCBkb2Vzbid0IHNldCByZWxhdGVkVGFyZ2V0IHByb3Blcmx5LCBzbyBmcm9tRWxlbWVudAogICAgICogaXMgYXNzaWduZWQgaW4gaXRzIHBsYWNlLiBJRSBkb2Vzbid0IGFsbG93IGZyb21FbGVtZW50IHRvIGJlIGJlIGFzc2lnbmVkLAogICAgICogc28gcmVsYXRlZFRhcmdldCBpcyBhc3NpZ25lZCBpbiBpdHMgcGxhY2UuIEJvdGggb2YgdGhlc2UgY29uY2Vzc2lvbnMKICAgICAqIGFsbG93IFlBSE9PLnV0aWwuRXZlbnQuZ2V0UmVsYXRlZFRhcmdldCgpIHRvIHdvcmsgY29ycmVjdGx5IGluIGJvdGgKICAgICAqIGJyb3dzZXJzLgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBtb3VzZW92ZXIKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgbW91c2VvdmVyOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIE9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZU1vdXNlRXZlbnQodGFyZ2V0LCAibW91c2VvdmVyIiwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgbW91c2V1cCBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgbW91c2V1cAogICAgICogQHN0YXRpYwogICAgICovCiAgICBtb3VzZXVwOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIE9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZU1vdXNlRXZlbnQodGFyZ2V0LCAibW91c2V1cCIsIG9wdGlvbnMpOwogICAgfSwKICAgIG1vdXNlZW50ZXI6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogT2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlTW91c2VFdmVudCh0YXJnZXQsICJtb3VzZWVudGVyIiwgb3B0aW9ucyk7CiAgICB9LAogICAgbW91c2VsZWF2ZTpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiBPYmplY3QgKi8pIC8qIDpWb2lkICovIHsKICAgICAgICB0aGlzLmZpcmVNb3VzZUV2ZW50KHRhcmdldCwgIm1vdXNlbGVhdmUiLCBvcHRpb25zKTsKICAgIH0sCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIGNvbnRleHRtZW51IG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBzaG93IGNvbnRleHRtZW51LgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgY29udGV4dG1lbnUKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgY29udGV4dG1lbnU6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogOk9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZU1vdXNlRXZlbnQodGFyZ2V0LCAiY29udGV4dG1lbnUiLCBvcHRpb25zKTsKICAgIH0sCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIGRyYWdlbmQgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIHNob3cgZHJhZ2VuZC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIGRyYWdlbmQKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgZHJhZ2VuZDpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlTW91c2VFdmVudCh0YXJnZXQsICJkcmFnZW5kIiwgb3B0aW9ucyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBibHVyIG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBzaG93IGJsdXIuCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBibHVyCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGJsdXI6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogOk9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZU1vdXNlRXZlbnQodGFyZ2V0LCAiYmx1ciIsIG9wdGlvbnMpOwogICAgfSwKICAgIGRyYWd0bzpmdW5jdGlvbiAodGFyZ2V0LCBvcHRpb25zKSB7CiAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICBtZS5tb3VzZW1vdmUodGFyZ2V0LCB7CiAgICAgICAgICAgIGNsaWVudFg6b3B0aW9ucy5zdGFydFgsCiAgICAgICAgICAgIGNsaWVudFk6b3B0aW9ucy5zdGFydFkKICAgICAgICB9KTsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgbWUubW91c2Vkb3duKHRhcmdldCwgewogICAgICAgICAgICAgICAgY2xpZW50WDpvcHRpb25zLnN0YXJ0WCwKICAgICAgICAgICAgICAgIGNsaWVudFk6b3B0aW9ucy5zdGFydFkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbWUubW91c2Vtb3ZlKHRhcmdldCwgewogICAgICAgICAgICAgICAgICAgIGNsaWVudFg6b3B0aW9ucy5lbmRYLAogICAgICAgICAgICAgICAgICAgIGNsaWVudFk6b3B0aW9ucy5lbmRZCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG1lLm1vdXNldXAodGFyZ2V0LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudFg6b3B0aW9ucy5lbmRYLAogICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRZOm9wdGlvbnMuZW5kWQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBvcHRpb25zLmFmdGVybW92ZSB8fCAyMCk7CiAgICAgICAgICAgIH0sIG9wdGlvbnMuYmVmb3JlbW92ZSB8fCAyMCk7CiAgICAgICAgfSwgb3B0aW9ucy5iZWZvcmVzdGFydCB8fCA1MCk7CiAgICB9LAoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBLZXkgZXZlbnRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8qKgogICAgICogRmlyZXMgYW4gZXZlbnQgdGhhdCBub3JtYWxseSB3b3VsZCBiZSBmaXJlZCBieSB0aGUga2V5Ym9hcmQgKGtleXVwLAogICAgICoga2V5ZG93biwga2V5cHJlc3MpLiBNYWtlIHN1cmUgdG8gc3BlY2lmeSBlaXRoZXIga2V5Q29kZSBvciBjaGFyQ29kZSBhcyBhbgogICAgICogb3B0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30KICAgICAgICAqICAgICAgICAgICAgdHlwZSBUaGUgdHlwZSBvZiBldmVudCAoImtleXVwIiwgImtleWRvd24iIG9yICJrZXlwcmVzcyIpLgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgT3B0aW9ucyBmb3IgdGhlIGV2ZW50LiBFaXRoZXIga2V5Q29kZSBvciBjaGFyQ29kZSBhcmUKICAgICAqICAgICAgICAgICAgcmVxdWlyZWQuCiAgICAgKiBAbWV0aG9kIGZpcmVLZXlFdmVudAogICAgICogQHN0YXRpYwogICAgICovCiAgICBmaXJlS2V5RXZlbnQ6ZnVuY3Rpb24gKHR5cGUgLyogOlN0cmluZyAqLywgdGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdGhpcy5zaW11bGF0ZUtleUV2ZW50KHRhcmdldCwgdHlwZSwgb3B0aW9ucy5idWJibGVzLAogICAgICAgICAgICBvcHRpb25zLmNhbmNlbGFibGUsIG9wdGlvbnMudmlldywgb3B0aW9ucy5jdHJsS2V5LAogICAgICAgICAgICBvcHRpb25zLmFsdEtleSwgb3B0aW9ucy5zaGlmdEtleSwgb3B0aW9ucy5tZXRhS2V5LAogICAgICAgICAgICBvcHRpb25zLmtleUNvZGUsIG9wdGlvbnMuY2hhckNvZGUpOwogICAgfSwKCiAgICAvKioKICAgICAqIFNpbXVsYXRlcyBhIGN1dCBldmVudCBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgY3V0CiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGN1dDpmdW5jdGlvbiAodGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovKSAvKiA6Vm9pZCAqLyB7CiAgICAgICAgdGhpcy5maXJlS2V5RXZlbnQoImN1dCIsIHRhcmdldCwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgcGFzdGUgZXZlbnQgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIGFjdCBvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIHBhc3RlCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIHBhc3RlOmZ1bmN0aW9uICggdGFyZ2V0IC8qIDpIVE1MRWxlbWVudCAqLywgb3B0aW9ucyAvKiA6T2JqZWN0ICovICkgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZUtleUV2ZW50KCAicGFzdGUiLCB0YXJnZXQsIG9wdGlvbnMgKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBrZXlkb3duIGV2ZW50IG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBrZXlkb3duCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGtleWRvd246ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogOk9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZUtleUV2ZW50KCJrZXlkb3duIiwgdGFyZ2V0LCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBrZXlwcmVzcyBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2Qga2V5cHJlc3MKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAga2V5cHJlc3M6ZnVuY3Rpb24gKHRhcmdldCAvKiA6SFRNTEVsZW1lbnQgKi8sIG9wdGlvbnMgLyogOk9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZUtleUV2ZW50KCJrZXlwcmVzcyIsIHRhcmdldCwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEga2V5dXAgZXZlbnQgb24gYSBwYXJ0aWN1bGFyIGVsZW1lbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0KICAgICAgICAqICAgICAgICAgICAgdGFyZ2V0IFRoZSBlbGVtZW50IHRvIGFjdCBvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0fQogICAgICAgICogICAgICAgICAgICBvcHRpb25zIEFkZGl0aW9uYWwgZXZlbnQgb3B0aW9ucyAodXNlIERPTSBzdGFuZGFyZCBuYW1lcykuCiAgICAgKiBAbWV0aG9kIGtleXVwCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGtleXVwOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIE9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZUtleUV2ZW50KCJrZXl1cCIsIHRhcmdldCwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2ltdWxhdGVzIGEgY29tcG9zaXRpb25zdGFydCBldmVudCBvbiBhIHBhcnRpY3VsYXIgZWxlbWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fQogICAgICAgICogICAgICAgICAgICB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gYWN0IG9uLgogICAgICogQHBhcmFtIHtPYmplY3R9CiAgICAgICAgKiAgICAgICAgICAgIG9wdGlvbnMgQWRkaXRpb25hbCBldmVudCBvcHRpb25zICh1c2UgRE9NIHN0YW5kYXJkIG5hbWVzKS4KICAgICAqIEBtZXRob2QgY29tcG9zaXRpb25zdGFydAogICAgICogQHN0YXRpYwogICAgICovCiAgICBjb21wb3NpdGlvbnN0YXJ0OmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIE9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZUtleUV2ZW50KCJjb21wb3NpdGlvbnN0YXJ0IiwgdGFyZ2V0LCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTaW11bGF0ZXMgYSBjb21wb3NpdGlvbnN0YXJ0IGV2ZW50IG9uIGEgcGFydGljdWxhciBlbGVtZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9CiAgICAgICAgKiAgICAgICAgICAgIHRhcmdldCBUaGUgZWxlbWVudCB0byBhY3Qgb24uCiAgICAgKiBAcGFyYW0ge09iamVjdH0KICAgICAgICAqICAgICAgICAgICAgb3B0aW9ucyBBZGRpdGlvbmFsIGV2ZW50IG9wdGlvbnMgKHVzZSBET00gc3RhbmRhcmQgbmFtZXMpLgogICAgICogQG1ldGhvZCBjb21wb3NpdGlvbnN0YXJ0CiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGNvbXBvc2l0aW9uZW5kOmZ1bmN0aW9uICh0YXJnZXQgLyogOkhUTUxFbGVtZW50ICovLCBvcHRpb25zIC8qIE9iamVjdCAqLykgLyogOlZvaWQgKi8gewogICAgICAgIHRoaXMuZmlyZUtleUV2ZW50KCJjb21wb3NpdGlvbmVuZCIsIHRhcmdldCwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICog5o+Q5L6baWZyYW1l5omp5bGV5pSv5oyB77yM55So5L6L5rWL6K+V6ZyA6KaB54us56uL5Zy65pmv55qE55So5L6L77yM55Sx5LqO5byC5q2l5pSv5oyB77yM6YCa6L+HZmluaXNo5pa55rOV6Kem5Y+Rc3RhcnQKICAgICAqIDxsaT7kuovku7bnu5HlrprlnKhmcmFtZeS4iu+8jOWMheaLrGFmdGVyZmluaXNo5ZKManNsb2FkZWQKICAgICAqCiAgICAgKiBAcGFyYW0gb3Aud2luCiAgICAgKiBAcGFyYW0gb3Aubm9qcwogICAgICogICAgICAgICAgICDkuI3liqDovb3pop3lpJZqcwogICAgICogQHBhcmFtIG9wLm9udGVzdAogICAgICogICAgICAgICAgICDmtYvor5XmraXpqqQKICAgICAqIEBwYXJhbSBvcC5vbmJlZm9yZXN0YXJ0CiAgICAgKiAgICAgICAgICAgIOa1i+ivleWQr+WKqOWJjeWkhOeQhuatpemqpO+8jOm7mOiupOS4ulFVbml0LnN0b3AoKTsKICAgICAqIEBwYXJhbSBvcC5vbmFmdGVyZmluaXNoCiAgICAgKiAgICAgICAgICAgIOa1i+ivleWujOavleaJp+ihjOatpemqpO+8jOm7mOiupOS4ulFVbml0LnN0YXJ0KCkKICAgICAqCiAgICAgKi8KICAgIGZyYW1lRXh0OmZ1bmN0aW9uIChvcCkgewogICAgICAgIHN0b3AoKTsKICAgICAgICBvcCA9IHR5cGVvZiBvcCA9PSAnZnVuY3Rpb24nID8gewogICAgICAgICAgICBvbnRlc3Q6b3AKICAgICAgICB9IDogb3A7CiAgICAgICAgdmFyIHB3ID0gb3Aud2luIHx8IHdpbmRvdywgdywgZiwgdXJsID0gJycsIGlkID0gdHlwZW9mIG9wLmlkID09ICd1bmRlZmluZWQnID8gJ2YnCiAgICAgICAgICAgIDogb3AuaWQsIGZpZCA9ICdpZnJhbWUjJyArIGlkOwoKICAgICAgICBvcC5maW5pc2ggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHB3LiQoZmlkKS51bmJpbmQoKTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBwdy4kKCdkaXYjZGl2JyArIGlkKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHN0YXJ0KCk7CiAgICAgICAgICAgIH0sIDIwKTsKICAgICAgICB9OwoKICAgICAgICBpZiAocHcuJChmaWQpLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIC8qIOa3u+WKoGZyYW1l77yM6YOo5YiG5oOF5Ya15LiL77yMaWZyYW1l5rKh5pyJ6L655qGG77yM5Li65LqG5Y+v5Lul55yL5Yiw5pWI5p6c77yM5re75Yqg5LiA5Liq5bim6L655qGG55qEZGl2ICovCiAgICAgICAgICAgIHB3LiQocHcuZG9jdW1lbnQuYm9keSkuYXBwZW5kKCc8ZGl2IGlkPSJkaXYnICsgaWQgKyAnIj48L2Rpdj4nKTsKICAgICAgICAgICAgcHcuJCgnZGl2I2RpdicgKyBpZCkuYXBwZW5kKCc8aWZyYW1lIGlkPSInICsgaWQgKyAnIj48L2lmcmFtZT4nKTsKICAgICAgICB9CiAgICAgICAgb3Aub25hZnRlcnN0YXJ0ICYmIG9wLm9uYWZ0ZXJzdGFydCgkKCdpZnJhbWUjZicpWzBdKTsKICAgICAgICBwdy4kKCdzY3JpcHQnKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3JjICYmIHRoaXMuc3JjLmluZGV4T2YoJ2ltcG9ydC5waHAnKSA+PSAwKSB7CiAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLnNyYy5zcGxpdCgnaW1wb3J0LnBocCcpWzFdOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcHcuJChmaWQpLm9uZSgnbG9hZCcsCiAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB2YXIgdyA9IGUudGFyZ2V0LmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAgICAgICB2YXIgaCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAody5iYWlkdSkgey8vIOetieW+heWKoOi9veWujOaIkO+8jElFNuS4i+i/meWcsOaWueaAu+WHuumXrumimAogICAgICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGgpOwogICAgICAgICAgICAgICAgICAgICAgICBvcC5vbnRlc3Qodywgdy5mcmFtZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDIwKTsKICAgICAgICAgICAgICAgIC8vIOaJvuWIsOW9k+WJjeaTjeS9nOeahGlmcmFtZe+8jOeEtuWQjmNhbGwgb250ZXN0CiAgICAgICAgICAgIH0pLmF0dHIoJ3NyYycsIGNwYXRoICsgJ2ZyYW1lLnBocCcgKyB1cmwpOwogICAgfSwKCiAgICAvKioKICAgICAqCiAgICAgKiDliKTmlq0y5Liq5pWw57uE5piv5ZCm55u4562JCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICovCiAgICBpc0VxdWFsQXJyYXk6ZnVuY3Rpb24gKGFycmF5MSwgYXJyYXkyKSB7CiAgICAgICAgaWYgKCdbb2JqZWN0IEFycmF5XScgIT0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFycmF5MSkKICAgICAgICAgICAgfHwgJ1tvYmplY3QgQXJyYXldJyAhPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJyYXkyKSkKICAgICAgICAgICAgcmV0dXJuIChhcnJheTEgPT09IGFycmF5Mik7CiAgICAgICAgZWxzZSBpZiAoYXJyYXkxLmxlbmd0aCAhPSBhcnJheTIubGVuZ3RoKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gYXJyYXkxKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJyYXkxW2ldICE9IGFycmF5MltpXSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgKgogICAgICog6YCa55So5pWw5o2u5qih5Z2XCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICoKICAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KICAgIGNvbW1vbkRhdGE6ey8vIOmSiOWvuea1i+ivleaWh+S7tueahOi3r+W+hOiAjOS4jeaYr1VzZXJBY3Rpb27nmoTot6/lvoQKICAgICAgICAidGVzdGRpciI6Jy4uLy4uLycsCiAgICAgICAgZGF0YWRpcjooZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbG9jYXRpb24uaHJlZi5zcGxpdCgiL190ZXN0LyIpWzBdICsgIi9fdGVzdC90b29scy9kYXRhLyI7CiAgICAgICAgfSkoKSwKICAgICAgICBjdXJyZW50UGF0aDpmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBwYXJhbXMgPSBsb2NhdGlvbi5zZWFyY2guc3Vic3RyaW5nKDEpLnNwbGl0KCcmJyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyYW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcCA9IHBhcmFtc1tpXTsKICAgICAgICAgICAgICAgIGlmIChwLnNwbGl0KCc9JylbMF0gPT0gJ2Nhc2UnKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNhc2VwYXRoID0gcC5zcGxpdCgnPScpWzFdLnNwbGl0KCcuJykuam9pbignLycpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhdGlvbi5ocmVmLnNwbGl0KCcvX3Rlc3QvJylbMF0gKyAnL190ZXN0LycKICAgICAgICAgICAgICAgICAgICAgICAgKyBjYXNlcGF0aC5zdWJzdHJpbmcoMCwgY2FzZXBhdGgubGFzdEluZGV4T2YoJy8nKSkKICAgICAgICAgICAgICAgICAgICAgICAgKyAnLyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH0sCgogICAgaW1wb3J0c3JjOmZ1bmN0aW9uIChzcmMsIGNhbGxiYWNrLCBtYXRjaGVyLCBleGNsdWRlLCB3aW4pIHsKICAgICAgICB3aW4gPSB3aW4gfHwgd2luZG93OwogICAgICAgIHZhciBkb2MgPSB3aW4uZG9jdW1lbnQ7CgogICAgICAgIHZhciBzcmNwYXRoID0gbG9jYXRpb24uaHJlZi5zcGxpdCgiL190ZXN0LyIpWzBdCiAgICAgICAgICAgICsgIi9fdGVzdC90b29scy9ici9pbXBvcnQucGhwIjsKICAgICAgICB2YXIgcGFyYW0wID0gc3JjOwogICAgICAgIHZhciBwcyA9IHsKICAgICAgICAgICAgZjpzcmMKICAgICAgICB9OwogICAgICAgIGlmIChleGNsdWRlKQogICAgICAgICAgICBwcy5lID0gZXhjbHVkZTsKICAgICAgICB2YXIgcGFyYW0xID0gZXhjbHVkZSB8fCAiIjsKICAgICAgICAvKioKICAgICAgICAgKiBJReS4i+mHjeWkjei9veWFpeS8muWHuueOsOaXoOazleaJp+ihjOaDheWGtQogICAgICAgICAqLwogICAgICAgIGlmICh3aW4uZXhlY1NjcmlwdCkgewogICAgICAgICAgICAkLmdldChzcmNwYXRoLCBwcywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIHdpbi5leGVjU2NyaXB0KGRhdGEpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaGVhZCA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwogICAgICAgICAgICB2YXIgc2MgPSBkb2MuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgICAgIHNjLnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JzsKICAgICAgICAgICAgc2Muc3JjID0gc3JjcGF0aCArICI/Zj0iICsgcGFyYW0wICsgIiZlPSIgKyBwYXJhbTE7CiAgICAgICAgICAgIGhlYWQuYXBwZW5kQ2hpbGQoc2MpOwogICAgICAgIH0KCiAgICAgICAgbWF0Y2hlciA9IG1hdGNoZXIgfHwgc3JjOwogICAgICAgIHZhciBtbSA9IG1hdGNoZXIuc3BsaXQoIiwiKVswXS5zcGxpdCgiLiIpOwogICAgICAgIHZhciBoID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcCA9IHdpbjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtbS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAocFttbVtpXV0pID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2cobW1baV0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHAgPSBwW21tW2ldXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbGVhckludGVydmFsKGgpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgJiYgJ2Z1bmN0aW9uJyA9PSB0eXBlb2YgY2FsbGJhY2spCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0sIDIwKTsKICAgIH0sCgogICAgLyog55So5LqO5Yqg6L29Y3Nz5paH5Lu277yM5aaC5p6c5rKh5pyJ5Yqg6L295a6M5q+V5YiZ5LiN5omn6KGM5Zue6LCD5Ye95pWwICovCiAgICBsb2FkY3NzOmZ1bmN0aW9uICh1cmwsIGNhbGxiYWNrLCBjbGFzc25hbWUsIHN0eWxlLCB2YWx1ZSkgewogICAgICAgIHZhciBsaW5rcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdsaW5rJyk7CiAgICAgICAgZm9yICh2YXIgbGluayBpbiBsaW5rcykgewogICAgICAgICAgICBpZiAobGluay5ocmVmID09IHVybCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF07CiAgICAgICAgdmFyIGxpbmsgPSBoZWFkLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKSk7CiAgICAgICAgbGluay5zZXRBdHRyaWJ1dGUoInJlbCIsICJzdHlsZXNoZWV0Iik7CiAgICAgICAgbGluay5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9jc3MiKTsKICAgICAgICBsaW5rLnNldEF0dHJpYnV0ZSgiaHJlZiIsIHVybCk7CiAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOwogICAgICAgICQoZG9jdW1lbnQpLnJlYWR5KAogICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBkaXYuY2xhc3NOYW1lID0gY2xhc3NuYW1lIHx8ICdjc3Nsb2FkZWQnOwogICAgICAgICAgICAgICAgdmFyIGggPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCQoZGl2KS5jc3Moc3R5bGUgfHwgJ3dpZHRoJykgPT0gdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgfHwgJChkaXYpLmNzcyhzdHlsZSB8fCAnd2lkdGgnKSA9PSAnMjBweCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChkaXYpOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGNhbGxiYWNrLCAyMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMjApOwogICAgICAgICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBvcHRpb25zIHN1cHBvcnRlZAogICAgICovCiAgICBkZWxheWhlbHBlcjpmdW5jdGlvbiAob25jaGVjaywgb25zdWNjZXNzLCBvbmZhaWwsIHRpbWVvdXQpIHsKICAgICAgICBvbnN1Y2Nlc3MgPSBvbnN1Y2Nlc3MgfHwgb25jaGVjay5vbnN1Y2Nlc3M7CiAgICAgICAgb25mYWlsID0gb25mYWlsIHx8IG9uY2hlY2sub25mYWlsIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgd2luZG93LlFVbml0LmZhaWwoJ3RpbWVvdXQgd2FpdCBmb3IgdGltZW91dCA6ICcgKyB0aW1lb3V0ICsgJ21zJyk7CiAgICAgICAgICAgIHN0YXJ0KCk7CiAgICAgICAgfTsKICAgICAgICB0aW1lb3V0ID0gdGltZW91dCB8fCBvbmNoZWNrLnRpbWVvdXQgfHwgMTAwMDA7CgogICAgICAgIG9uY2hlY2sgPSAodHlwZW9mIG9uY2hlY2sgPT0gJ2Z1bmN0aW9uJykgPyBvbmNoZWNrIDogb25jaGVjay5vbmNoZWNrOwogICAgICAgIHZhciBoMSA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKCFvbmNoZWNrKCkpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChoMSk7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoaDIpOwogICAgICAgICAgICAgICAgdHlwZW9mIG9uc3VjY2VzcyA9PSAiZnVuY3Rpb24iICYmIG9uc3VjY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgMjApOwogICAgICAgIHZhciBoMiA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjbGVhckludGVydmFsKGgxKTsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGgyKTsKICAgICAgICAgICAgb25mYWlsKCk7CiAgICAgICAgfSwgdGltZW91dCk7CiAgICB9LAoKICAgIGJyb3dzZXI6KGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgd2luID0gd2luZG93OwogICAgICAgIHZhciBudW1iZXJpZnkgPSBmdW5jdGlvbiAocykgewogICAgICAgICAgICAgICAgdmFyIGMgPSAwOwogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQocy5yZXBsYWNlKC9cLi9nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChjKysgPT0gMSkgPyAnJyA6ICcuJzsKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG5hdiA9IHdpbiAmJiB3aW4ubmF2aWdhdG9yLAoKICAgICAgICAgICAgbyA9IHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEludGVybmV0IEV4cGxvcmVyIHZlcnNpb24gbnVtYmVyIG9yIDAuIEV4YW1wbGU6IDYKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkgaWUKICAgICAgICAgICAgICAgICAqIEB0eXBlIGZsb2F0CiAgICAgICAgICAgICAgICAgKiBAc3RhdGljCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGllOjAsCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBPcGVyYSB2ZXJzaW9uIG51bWJlciBvciAwLiBFeGFtcGxlOiA5LjIKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkgb3BlcmEKICAgICAgICAgICAgICAgICAqIEB0eXBlIGZsb2F0CiAgICAgICAgICAgICAgICAgKiBAc3RhdGljCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIG9wZXJhOjAsCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBHZWNrbyBlbmdpbmUgcmV2aXNpb24gbnVtYmVyLiBXaWxsIGV2YWx1YXRlIHRvIDEgaWYgR2Vja28gaXMKICAgICAgICAgICAgICAgICAqIGRldGVjdGVkIGJ1dCB0aGUgcmV2aXNpb24gY291bGQgbm90IGJlIGZvdW5kLiBPdGhlciBicm93c2VycyB3aWxsCiAgICAgICAgICAgICAgICAgKiBiZSAwLiBFeGFtcGxlOiAxLjgKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogRmlyZWZveCAxLjAuMC40OiAxLjcuOCAgICZsdDstLSBSZXBvcnRzIDEuNwogICAgICAgICAgICAgICAgICogRmlyZWZveCAxLjUuMC45OiAxLjguMC45ICZsdDstLSAxLjgKICAgICAgICAgICAgICAgICAqIEZpcmVmb3ggMi4wLjAuMzogMS44LjEuMyAmbHQ7LS0gMS44MQogICAgICAgICAgICAgICAgICogRmlyZWZveCAzLjAgICAmbHQ7LS0gMS45CiAgICAgICAgICAgICAgICAgKiBGaXJlZm94IDMuNSAgICZsdDstLSAxLjkxCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkgZ2Vja28KICAgICAgICAgICAgICAgICAqIEB0eXBlIGZsb2F0CiAgICAgICAgICAgICAgICAgKiBAc3RhdGljCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGdlY2tvOjAsCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBBcHBsZVdlYktpdCB2ZXJzaW9uLiBLSFRNTCBicm93c2VycyB0aGF0IGFyZSBub3QgV2ViS2l0IGJyb3dzZXJzCiAgICAgICAgICAgICAgICAgKiB3aWxsIGV2YWx1YXRlIHRvIDEsIG90aGVyIGJyb3dzZXJzIDAuIEV4YW1wbGU6IDQxOC45CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqIFNhZmFyaSAxLjMuMiAoMzEyLjYpOiAzMTIuOC4xICZsdDstLSBSZXBvcnRzIDMxMi44IC0tIGN1cnJlbnRseSB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXRlc3QgYXZhaWxhYmxlIGZvciBNYWMgT1NYIDEwLjMuCiAgICAgICAgICAgICAgICAgKiBTYWZhcmkgMi4wLjI6ICAgICAgICAgNDE2ICAgICAmbHQ7LS0gaGFzT3duUHJvcGVydHkgaW50cm9kdWNlZAogICAgICAgICAgICAgICAgICogU2FmYXJpIDIuMC40OiAgICAgICAgIDQxOCAgICAgJmx0Oy0tIHByZXZlbnREZWZhdWx0IGZpeGVkCiAgICAgICAgICAgICAgICAgKiBTYWZhcmkgMi4wLjQgKDQxOS4zKTogNDE4LjkuMSAmbHQ7LS0gT25lIHZlcnNpb24gb2YgU2FmYXJpIG1heSBydW4KICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbnQgdmVyc2lvbnMgb2Ygd2Via2l0CiAgICAgICAgICAgICAgICAgKiBTYWZhcmkgMi4wLjQgKDQxOS4zKTogNDE5ICAgICAmbHQ7LS0gVGlnZXIgaW5zdGFsbGF0aW9ucyB0aGF0IGhhdmUgYmVlbgogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWQsIGJ1dCBub3QgdXBkYXRlZAogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIHRoZSBsYXRlc3QgcGF0Y2guCiAgICAgICAgICAgICAgICAgKiBXZWJraXQgMjEyIG5pZ2h0bHk6ICAgNTIyKyAgICAmbHQ7LS0gU2FmYXJpIDMuMCBwcmVjdXJzb3IgKHdpdGggbmF0aXZlIFNWRwogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBtYW55IG1ham9yIGlzc3VlcyBmaXhlZCkuCiAgICAgICAgICAgICAgICAgKiBTYWZhcmkgMy4wLjQgKDUyMy4xMikgNTIzLjEyICAmbHQ7LS0gRmlyc3QgVGlnZXIgcmVsZWFzZSAtIGF1dG9tYXRpYyB1cGRhdGUKICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tIDIueCB2aWEgdGhlIDEwLjQuMTEgT1MgcGF0Y2gKICAgICAgICAgICAgICAgICAqIFdlYmtpdCBuaWdodGx5IDEvMjAwODo1MjUrICAgICZsdDstLSBTdXBwb3J0cyBET01Db250ZW50TG9hZGVkIGV2ZW50LgogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlhaG9vLmNvbSB1c2VyIGFnZW50IGhhY2sgcmVtb3ZlZC4KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2FmYXJpX3ZlcnNpb25faGlzdG9yeQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB3ZWJraXQKICAgICAgICAgICAgICAgICAqIEB0eXBlIGZsb2F0CiAgICAgICAgICAgICAgICAgKiBAc3RhdGljCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHdlYmtpdDowLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQ2hyb21lIHdpbGwgYmUgZGV0ZWN0ZWQgYXMgd2Via2l0LCBidXQgdGhpcyBwcm9wZXJ0eSB3aWxsIGFsc28gYmUKICAgICAgICAgICAgICAgICAqIHBvcHVsYXRlZCB3aXRoIHRoZSBDaHJvbWUgdmVyc2lvbiBudW1iZXIKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkgY2hyb21lCiAgICAgICAgICAgICAgICAgKiBAdHlwZSBmbG9hdAogICAgICAgICAgICAgICAgICogQHN0YXRpYwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBjaHJvbWU6MCwKCiAgICAgICAgICAgICAgICBzYWZhcmk6MCwKCiAgICAgICAgICAgICAgICBmaXJlZm94OjAsCgogICAgICAgICAgICAgICAgbWF4dGhvbjowLAogICAgICAgICAgICAgICAgbWF4dGhvbklFOjAsCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBUaGUgbW9iaWxlIHByb3BlcnR5IHdpbGwgYmUgc2V0IHRvIGEgc3RyaW5nIGNvbnRhaW5pbmcgYW55CiAgICAgICAgICAgICAgICAgKiByZWxldmFudCB1c2VyIGFnZW50IGluZm9ybWF0aW9uIHdoZW4gYSBtb2Rlcm4gbW9iaWxlIGJyb3dzZXIgaXMKICAgICAgICAgICAgICAgICAqIGRldGVjdGVkLiBDdXJyZW50bHkgbGltaXRlZCB0byBTYWZhcmkgb24gdGhlIGlQaG9uZS9pUG9kIFRvdWNoLAogICAgICAgICAgICAgICAgICogTm9raWEgTi1zZXJpZXMgZGV2aWNlcyB3aXRoIHRoZSBXZWJLaXQtYmFzZWQgYnJvd3NlciwgYW5kIE9wZXJhCiAgICAgICAgICAgICAgICAgKiBNaW5pLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSBtb2JpbGUKICAgICAgICAgICAgICAgICAqIEB0eXBlIHN0cmluZwogICAgICAgICAgICAgICAgICogQHN0YXRpYwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBtb2JpbGU6bnVsbCwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEFkb2JlIEFJUiB2ZXJzaW9uIG51bWJlciBvciAwLiBPbmx5IHBvcHVsYXRlZCBpZiB3ZWJraXQgaXMKICAgICAgICAgICAgICAgICAqIGRldGVjdGVkLiBFeGFtcGxlOiAxLjAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkgYWlyCiAgICAgICAgICAgICAgICAgKiBAdHlwZSBmbG9hdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBhaXI6MCwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEdvb2dsZSBDYWphIHZlcnNpb24gbnVtYmVyIG9yIDAuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByb3BlcnR5IGNhamEKICAgICAgICAgICAgICAgICAqIEB0eXBlIGZsb2F0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGNhamE6bmF2ICYmIG5hdi5jYWphVmVyc2lvbiwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIFNldCB0byB0cnVlIGlmIHRoZSBwYWdlYnJlYWsgYXBwZWFycyB0byBiZSBpbiBTU0wKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkgc2VjdXJlCiAgICAgICAgICAgICAgICAgKiBAdHlwZSBib29sZWFuCiAgICAgICAgICAgICAgICAgKiBAc3RhdGljCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHNlY3VyZTpmYWxzZSwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIFRoZSBvcGVyYXRpbmcgc3lzdGVtLiBDdXJyZW50bHkgb25seSBkZXRlY3Rpbmcgd2luZG93cyBvcgogICAgICAgICAgICAgICAgICogbWFjaW50b3NoCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByb3BlcnR5IG9zCiAgICAgICAgICAgICAgICAgKiBAdHlwZSBzdHJpbmcKICAgICAgICAgICAgICAgICAqIEBzdGF0aWMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgb3M6bnVsbAoKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVhID0gbmF2ICYmIG5hdi51c2VyQWdlbnQsCgogICAgICAgICAgICBsb2MgPSB3aW4gJiYgd2luLmxvY2F0aW9uLAoKICAgICAgICAgICAgaHJlZiA9IGxvYyAmJiBsb2MuaHJlZiwKCiAgICAgICAgICAgIG07CgogICAgICAgIG8uc2VjdXJlID0gaHJlZiAmJiAoaHJlZi50b0xvd2VyQ2FzZSgpLmluZGV4T2YoImh0dHBzIikgPT09IDApOwoKICAgICAgICBpZiAodWEpIHsKCiAgICAgICAgICAgIGlmICgoL3dpbmRvd3N8d2luMzIvaSkudGVzdCh1YSkpIHsKICAgICAgICAgICAgICAgIG8ub3MgPSAnd2luZG93cyc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKC9tYWNpbnRvc2gvaSkudGVzdCh1YSkpIHsKICAgICAgICAgICAgICAgIG8ub3MgPSAnbWFjaW50b3NoJzsKICAgICAgICAgICAgfSBlbHNlIGlmICgoL3JoaW5vL2kpLnRlc3QodWEpKSB7CiAgICAgICAgICAgICAgICBvLm9zID0gJ3JoaW5vJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTW9kZXJuIEtIVE1MIGJyb3dzZXJzIHNob3VsZCBxdWFsaWZ5IGFzIFNhZmFyaSBYLUdyYWRlCiAgICAgICAgICAgIGlmICgoL0tIVE1MLykudGVzdCh1YSkpIHsKICAgICAgICAgICAgICAgIG8ud2Via2l0ID0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmV4dGVybmFsICYmIC8oXGQrXC5cZCkvLnRlc3QoZXh0ZXJuYWwubWF4X3ZlcnNpb24pKSB7CgogICAgICAgICAgICAgICAgby5tYXh0aG9uID0gcGFyc2VGbG9hdChSZWdFeHBbJ1x4MjQxJ10pOwogICAgICAgICAgICAgICAgaWYgKC9NU0lFLy50ZXN0KHVhKSkgewogICAgICAgICAgICAgICAgICAgIG8ubWF4dGhvbklFID0gMTsKICAgICAgICAgICAgICAgICAgICBvLm1heHRob24gPSAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBNb2Rlcm4gV2ViS2l0IGJyb3dzZXJzIGFyZSBhdCBsZWFzdCBYLUdyYWRlCiAgICAgICAgICAgIG0gPSB1YS5tYXRjaCgvQXBwbGVXZWJLaXRcLyhbXlxzXSopLyk7CiAgICAgICAgICAgIGlmIChtICYmIG1bMV0pIHsKICAgICAgICAgICAgICAgIG8ud2Via2l0ID0gbnVtYmVyaWZ5KG1bMV0pOwoKICAgICAgICAgICAgICAgIC8vIE1vYmlsZSBicm93c2VyIGNoZWNrCiAgICAgICAgICAgICAgICBpZiAoLyBNb2JpbGVcLy8udGVzdCh1YSkpIHsKICAgICAgICAgICAgICAgICAgICBvLm1vYmlsZSA9ICJBcHBsZSI7IC8vIGlQaG9uZSBvciBpUG9kIFRvdWNoCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG0gPSB1YS5tYXRjaCgvTm9raWFOW15cL10qfEFuZHJvaWQgXGRcLlxkfHdlYk9TXC9cZFwuXGQvKTsKICAgICAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgICAgICBvLm1vYmlsZSA9IG1bMF07IC8vIE5va2lhIE4tc2VyaWVzLCBBbmRyb2lkLCB3ZWJPUywKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXg6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5va2lhTjk1CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBtMSA9IHVhLm1hdGNoKC9TYWZhcmlcLyhbXlxzXSopLyk7CiAgICAgICAgICAgICAgICBpZiAobTEgJiYgbTFbMV0pIC8vIFNhZmFyaQogICAgICAgICAgICAgICAgICAgIG8uc2FmYXJpID0gbnVtYmVyaWZ5KG0xWzFdKTsKICAgICAgICAgICAgICAgIG0gPSB1YS5tYXRjaCgvQ2hyb21lXC8oW15cc10qKS8pOwogICAgICAgICAgICAgICAgaWYgKG8uc2FmYXJpICYmIG0gJiYgbVsxXSkgewogICAgICAgICAgICAgICAgICAgIG8uY2hyb21lID0gbnVtYmVyaWZ5KG1bMV0pOyAvLyBDaHJvbWUKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbSA9IHVhLm1hdGNoKC9BZG9iZUFJUlwvKFteXHNdKikvKTsKICAgICAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgICAgICBvLmFpciA9IG1bMF07IC8vIEFkb2JlIEFJUiAxLjAgb3IgYmV0dGVyCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIW8ud2Via2l0KSB7IC8vIG5vdCB3ZWJraXQKICAgICAgICAgICAgICAgIC8vIEB0b2RvIGNoZWNrIE9wZXJhLzguMDEgKEoyTUUvTUlEUDsgT3BlcmEgTWluaS8yLjAuNDUwOS8xMzE2OwogICAgICAgICAgICAgICAgLy8gZmk7IFU7CiAgICAgICAgICAgICAgICAvLyB0cnkgZ2V0IGZpcmVmb3ggYW5kIGl0J3MgdmVyCiAgICAgICAgICAgICAgICAvLyBzc3IpCiAgICAgICAgICAgICAgICBtID0gdWEubWF0Y2goL09wZXJhW1xzXC9dKFteXHNdKikvKTsKICAgICAgICAgICAgICAgIGlmIChtICYmIG1bMV0pIHsKICAgICAgICAgICAgICAgICAgICBtID0gdWEubWF0Y2goL1ZlcnNpb25bXHNcL10oW15cc10qKS8pOwogICAgICAgICAgICAgICAgICAgIG8ub3BlcmEgPSBudW1iZXJpZnkobVsxXSk7CiAgICAgICAgICAgICAgICAgICAgbSA9IHVhLm1hdGNoKC9PcGVyYSBNaW5pW147XSovKTsKICAgICAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgICAgICBvLm1vYmlsZSA9IG1bMF07IC8vIGV4OiBPcGVyYSBNaW5pLzIuMC40NTA5LzEzMTYKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBub3Qgb3BlcmEgb3Igd2Via2l0CiAgICAgICAgICAgICAgICAgICAgbSA9IHVhLm1hdGNoKC9NU0lFXHMoW147XSopLyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG0gJiYgbVsxXSkgewogICAgICAgICAgICAgICAgICAgICAgICBvLmllID0gbnVtYmVyaWZ5KG1bMV0pOwogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmICh1YS5tYXRjaCgvR2Vja28oW15cc10qKS8pJiZ1YS5tYXRjaCgvcnY6MTEvKSl7Ly90b2RvCiAgICAgICAgICAgICAgICAgICAgICAgIG8uaWUgPSAxMTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBub3Qgb3BlcmEsIHdlYmtpdCwgb3IgaWUKICAgICAgICAgICAgICAgICAgICAgICAgbSA9IHVhLm1hdGNoKC9HZWNrb1wvKFteXHNdKikvKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8uZ2Vja28gPSAxOyAvLyBHZWNrbyBkZXRlY3RlZCwgbG9vayBmb3IgcmV2aXNpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0gPSB1YS5tYXRjaCgvcnY6KFteXHNcKV0qKS8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0gJiYgbVsxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8uZ2Vja28gPSBudW1iZXJpZnkobVsxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBvOwogICAgfSkKICAgICAgICAoKSwKCiAgICAvKioKICAgICAqIOaPkOS+m+mYn+WIl+aWueW8j+aJp+ihjOeUqOS+i+eahOaWueahiO+8jOaOpeWPo+WMheaLrHN0YXJ044CBYWRk44CBbmV4dO+8jOaWueazleWFqOmDqOaJp+ihjOWujOavleaXtuS8muWQr+WKqOeUqOS+i+e7p+e7reaJp+ihjAogICAgICovCiAgICBmdW5jdGlvbkxpc3RIZWxwZXI6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaGVjayA9IHsKICAgICAgICAgICAgbGlzdDpbXSwKICAgICAgICAgICAgc3RhcnQ6ZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgJCh0aGlzKS5iaW5kKCduZXh0JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgey8vIOmBv+WFjeWkqua3seeahOWghuagiAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5saXN0Lmxlbmd0aCA9PSAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5saXN0LnNoaWZ0KCkoKTsKICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2VsZi5uZXh0KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGFkZDpmdW5jdGlvbiAoZnVuYykgewogICAgICAgICAgICAgICAgdGhpcy5saXN0LnB1c2goZnVuYyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG5leHQ6ZnVuY3Rpb24gKGRlbGF5KSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICBpZiAoZGVsYXkpIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmKS50cmlnZ2VyKCduZXh0Jyk7CiAgICAgICAgICAgICAgICAgICAgfSwgZGVsYXkpOwogICAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS50cmlnZ2VyKCduZXh0Jyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJldHVybiBjaGVjazsKICAgIH0sCiAgICBnZXRIVE1MOmZ1bmN0aW9uIChjbykgewogICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgaDsKICAgICAgICBpZiAoIWNvKQogICAgICAgICAgICByZXR1cm4gJ251bGwnOwogICAgICAgIGRpdi5hcHBlbmRDaGlsZChjby5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgIGggPSBkaXYuaW5uZXJIVE1MLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIGggPSBoLnJlcGxhY2UoL1tcclxuXHRcdTIwMGJcdWZlZmZdL2csICcnKTsgLy8gUmVtb3ZlIGxpbmUgZmVlZHMgYW5kIHRhYnMKICAgICAgICBoID0gaC5yZXBsYWNlKC8gKFx3Kyk9KFteXCJdW15ccz5dKikvZ2ksICcgJDE9IiQyIicpOyAvLyBSZXN0b3JlCiAgICAgICAgLy8gYXR0cmlicyBvbiBJRQogICAgICAgIHJldHVybiBoOwogICAgfSwKICAgIGdldENoaWxkSFRNTDpmdW5jdGlvbiAoY28pIHsKCiAgICAgICAgdmFyIGggPSBjby5pbm5lckhUTUwudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgaCA9IGgucmVwbGFjZSgvW1xyXG5cdFx1MjAwYlx1ZmVmZl0vZywgJycpOyAvLyBSZW1vdmUgbGluZSBmZWVkcyBhbmQgdGFicwogICAgICAgIGggPSBoLnJlcGxhY2UoLyAoXHcrKT0oW15cIl1bXlxzPl0qKS9naSwgJyAkMT0iJDIiJyk7IC8vIFJlc3RvcmUgYXR0cmlicyBvbiBJRQoKICAgICAgICByZXR1cm4gaC5yZXBsYWNlKC9cdTIwMEIvZywgJycpOwogICAgfSwKICAgIGdldEluZGV4OmZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgdmFyIGNoaWxkTm9kZXMgPSBub2RlLnBhcmVudE5vZGUuY2hpbGROb2RlcywgaSA9IDA7CiAgICAgICAgd2hpbGUgKGNoaWxkTm9kZXNbaV0gIT09IG5vZGUpCiAgICAgICAgICAgIGkrKzsKICAgICAgICByZXR1cm4gaTsKICAgIH0sCiAgICBjaGVja1Jlc3VsdDpmdW5jdGlvbiAocmFuZ2UsIHNjLCBlYywgc28sIGVvLCBjb2xsYXBzZWQsIGRlc2NyaXB0KSB7CiAgICAgICAgZGVzY3JpcHQgPSBkZXNjcmlwdCA/IGRlc2NyaXB0IDogJyc7CiAgICAgICAgZXF1YWwocmFuZ2UuY29sbGFwc2VkLCBjb2xsYXBzZWQsICJjaGVjayBjb2xsYXBzZWQgLS0iICsgZGVzY3JpcHQpOwogICAgICAgIG9rKHJhbmdlLnN0YXJ0Q29udGFpbmVyID09PSBzYywgImNoZWNrIHN0YXJ0Q29udGFpbmVyLS0iICsgZGVzY3JpcHQpOwogICAgICAgIG9rKHJhbmdlLmVuZENvbnRhaW5lciA9PT0gZWMsICJjaGVjayBlbmRDb250YWluZXItLSIgKyBkZXNjcmlwdCk7CiAgICAgICAgZXF1YWwocmFuZ2Uuc3RhcnRPZmZzZXQsIHNvLCAiY2hlY2sgc3RhcnRPZmZzZXQtLSIgKyBkZXNjcmlwdCk7CiAgICAgICAgZXF1YWwocmFuZ2UuZW5kT2Zmc2V0LCBlbywgImNoZWNrIGVuZE9mZnNldC0tIiArIGRlc2NyaXB0KTsKICAgIH0sCiAgICBpc1NhbWVSYW5nZTpmdW5jdGlvbiAocmFuZ2VBLCByYW5nZUIsIGRlc2NyaXB0KSB7CiAgICAgICAgZGVzY3JpcHQgPSBkZXNjcmlwdCA/IGRlc2NyaXB0IDogJyc7CiAgICAgICAgZXF1YWwocmFuZ2VBLmNvbGxhcHNlZCwgcmFuZ2VCLmNvbGxhcHNlZCwgImNoZWNrIGNvbGxhcHNlZCAtLSIgKyBkZXNjcmlwdCk7CiAgICAgICAgb2socmFuZ2VBLmRvY3VtZW50ID09PSByYW5nZUIuZG9jdW1lbnQsICJjaGVjayBkb2N1bWVudC0tIiArIGRlc2NyaXB0KTsKICAgICAgICBvayhyYW5nZUEuc3RhcnRDb250YWluZXIgPT09IHJhbmdlQi5zdGFydENvbnRhaW5lciwgImNoZWNrIHN0YXJ0Q29udGFpbmVyLS0iICsgZGVzY3JpcHQpOwogICAgICAgIG9rKHJhbmdlQS5lbmRDb250YWluZXIgPT09IHJhbmdlQi5lbmRDb250YWluZXIsICJjaGVjayBlbmRDb250YWluZXItLSIgKyBkZXNjcmlwdCk7CiAgICAgICAgZXF1YWwocmFuZ2VBLnN0YXJ0T2Zmc2V0LCByYW5nZUIuc3RhcnRPZmZzZXQsICJjaGVjayBzdGFydE9mZnNldC0tIiArIGRlc2NyaXB0KTsKICAgICAgICBlcXVhbChyYW5nZUEuZW5kT2Zmc2V0LCByYW5nZUIuZW5kT2Zmc2V0LCAiY2hlY2sgZW5kT2Zmc2V0LS0iICsgZGVzY3JpcHQpOwogICAgfSwKICAgIG1hbnVhbERlbGV0ZUZpbGxEYXRhOmZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgdmFyIGNoaWxkcyA9IG5vZGUuY2hpbGROb2RlczsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgZmlsbERhdGEgPSBjaGlsZHNbaV07CiAgICAgICAgICAgIGlmICgoZmlsbERhdGEubm9kZVR5cGUgPT0gMykgJiYgKCBmaWxsRGF0YS5kYXRhID09IGRvbVV0aWxzLmZpbGxDaGFyICkpIHsKICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShmaWxsRGF0YSk7CiAgICAgICAgICAgICAgICBmaWxsRGF0YSA9IG51bGw7CgogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRoaXMubWFudWFsRGVsZXRlRmlsbERhdGEoZmlsbERhdGEpOwogICAgICAgIH0KCgogICAgfSwKICAgIGNzc1N0eWxlVG9Eb21TdHlsZTpmdW5jdGlvbiAoY3NzTmFtZSkgewogICAgICAgIHZhciB0ZXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jykuc3R5bGUsCiAgICAgICAgICAgIGNzc0Zsb2F0ID0gdGVzdC5jc3NGbG9hdCAhPSB1bmRlZmluZWQgPyAnY3NzRmxvYXQnCiAgICAgICAgICAgICAgICA6IHRlc3Quc3R5bGVGbG9hdCAhPSB1bmRlZmluZWQgPyAnc3R5bGVGbG9hdCcKICAgICAgICAgICAgICAgIDogJ2Zsb2F0JywKICAgICAgICAgICAgY2FjaGUgPSB7ICdmbG9hdCc6Y3NzRmxvYXQgfTsKCiAgICAgICAgZnVuY3Rpb24gcmVwbGFjZXIobWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0KCi8vICAgICAgICByZXR1cm4gZnVuY3Rpb24oIGNzc05hbWUgKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlW2Nzc05hbWVdIHx8IChjYWNoZVtjc3NOYW1lXSA9IGNzc05hbWUucmVwbGFjZSgvLS4vZywgcmVwbGFjZXIpICk7Ci8vICAgICAgICB9OwogICAgfSwKICAgIGlzU2FtZVN0eWxlOmZ1bmN0aW9uIChlbGVtZW50QSwgZWxlbWVudEIpIHsKLy8gICAgICAgIHZhciBzdHlsZUEgPSBlbGVtZW50QS5zdHlsZS5jc3NUZXh0LAovLyAgICAgICAgICAgIHN0eWxlQiA9IGVsZW1lbnRCLnN0eWxlLmNzc1RleHQ7Ci8vICAgICAgICBpZiAoIHRoaXMuYnJvd3Nlci5pZSAmJiB0aGlzLmJyb3dzZXIudmVyc2lvbiA9PSA2ICkgewovLyAgICAgICAgICAgIHN0eWxlQSA9IHN0eWxlQS50b0xvd2VyQ2FzZSgpOwovLyAgICAgICAgICAgIHN0eWxlQiA9IHN0eWxlQi50b0xvd2VyQ2FzZSgpOwovLyAgICAgICAgfQovLyAgICAgICAgaWYgKCAhc3R5bGVBICYmICFzdHlsZUIgKSB7Ci8vICAgICAgICAgICAgcmV0dXJuIHRydWU7Ci8vICAgICAgICB9IGVsc2UgaWYgKCAhc3R5bGVBIHx8ICFzdHlsZUIgKSB7Ci8vICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwovLyAgICAgICAgfQovLyAgICAgICAgdmFyIHN0eWxlTmFtZU1hcCA9IHt9LAovLyAgICAgICAgICAgIHJlY29yZCA9IFtdLAovLyAgICAgICAgICAgIGV4aXQgPSB7fTsKLy8gICAgICAgIHN0eWxlQS5yZXBsYWNlKCAvW1x3LV0rXHMqKD89OikvZywgZnVuY3Rpb24gKCBuYW1lICkgewovLyAgICAgICAgICAgIHN0eWxlTmFtZU1hcFtuYW1lXSA9IHJlY29yZC5wdXNoKCBuYW1lICk7Ci8vICAgICAgICB9ICk7Ci8vICAgICAgICB0cnkgewovLyAgICAgICAgICAgIHN0eWxlQi5yZXBsYWNlKCAvW1x3LV0rXHMqKD89OikvZywgZnVuY3Rpb24gKCBuYW1lICkgewovLyAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBzdHlsZU5hbWVNYXBbbmFtZV07Ci8vICAgICAgICAgICAgICAgIGlmICggaW5kZXggKSB7Ci8vLy8gICAgICAgICAgICAgICAgICAgIG5hbWUgPSB0aGlzLmNzc1N0eWxlVG9Eb21TdHlsZSggbmFtZSApOwovLyAgICAgICAgICAgICAgICAgICAgaWYgKCBlbGVtZW50QS5zdHlsZVtuYW1lXSAhPT0gZWxlbWVudEIuc3R5bGVbbmFtZV0gKSB7Ci8vICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXhpdDsKLy8gICAgICAgICAgICAgICAgICAgIH0KLy8gICAgICAgICAgICAgICAgICAgIHJlY29yZFtpbmRleCAtIDFdID0gJyc7Ci8vICAgICAgICAgICAgICAgIH0gZWxzZSB7Ci8vICAgICAgICAgICAgICAgICAgICB0aHJvdyBleGl0OwovLyAgICAgICAgICAgICAgICB9Ci8vICAgICAgICAgICAgfSApOwovLyAgICAgICAgfSBjYXRjaCAoIGV4ICkgewovLyAgICAgICAgICAgIGlmICggZXggPT09IGV4aXQgKSB7Ci8vICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKLy8gICAgICAgICAgICB9Ci8vICAgICAgICB9Ci8vICAgICAgICByZXR1cm4gIXJlY29yZC5qb2luKCAnJyApOwogICAgICAgIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIGl0ZW0sIGF0KSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBhdCB8fCAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3R5bGVBID0gZWxlbWVudEEuc3R5bGUuY3NzVGV4dC5yZXBsYWNlKC8oID87ID8pL2csICc7JykucmVwbGFjZSgvKCA/OiA/KS9nLCAnOicpLAogICAgICAgICAgICBzdHlsZUIgPSBlbGVtZW50Qi5zdHlsZS5jc3NUZXh0LnJlcGxhY2UoLyggPzsgPykvZywgJzsnKS5yZXBsYWNlKC8oID86ID8pL2csICc6Jyk7CiAgICAgICAgaWYgKGJyb3dzZXIub3BlcmEpIHsKICAgICAgICAgICAgc3R5bGVBID0gZWxlbWVudEEuc3R5bGU7CiAgICAgICAgICAgIHN0eWxlQiA9IGVsZW1lbnRCLnN0eWxlOwogICAgICAgICAgICBpZiAoc3R5bGVBLmxlbmd0aCAhPSBzdHlsZUIubGVuZ3RoKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIGZvciAodmFyIHAgaW4gc3R5bGVBKSB7CiAgICAgICAgICAgICAgICBpZiAoL14oXGQrfGNzc3RleHQpJC9pLnRlc3QocCkpCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAoc3R5bGVBW3BdICE9IHN0eWxlQltwXSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CgoKICAgICAgICBpZiAoIXN0eWxlQSB8fCAhc3R5bGVCKSB7CiAgICAgICAgICAgIHJldHVybiBzdHlsZUEgPT0gc3R5bGVCID8gMSA6IDA7CiAgICAgICAgfQogICAgICAgIHN0eWxlQSA9IHN0eWxlQS5zcGxpdCgnOycpOwogICAgICAgIHN0eWxlQiA9IHN0eWxlQi5zcGxpdCgnOycpOwoKICAgICAgICBpZiAoc3R5bGVBLmxlbmd0aCAhPSBzdHlsZUIubGVuZ3RoKQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHN0eWxlQi5sZW5ndGg7IGorKykgewogICAgICAgICAgICBpZiAoc3R5bGVCW2pdLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiY29sb3IiKSA+IC0xICYmIHN0eWxlQltqXS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoInJnYiIpID4gLTEpIHsKICAgICAgICAgICAgICAgIHZhciBjb2xvciA9IHRoaXMuZm9ybWF0Q29sb3Ioc3R5bGVCW2pdLnN1YnN0cihzdHlsZUJbal0uaW5kZXhPZigicmdiIiksIHN0eWxlQltqXS5sZW5ndGgpKTsKICAgICAgICAgICAgICAgIHN0eWxlQltqXSA9IHN0eWxlQltqXS5yZXBsYWNlKHN0eWxlQltqXS5zdWJzdHIoc3R5bGVCW2pdLmluZGV4T2YoInJnYiIpLCBzdHlsZUJbal0ubGVuZ3RoKSwgY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSBzdHlsZUFbaSsrXTspIHsKICAgICAgICAgICAgaWYgKGNpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiY29sb3IiKSA+IC0xICYmIGNpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigicmdiIikgPiAtMSkgewogICAgICAgICAgICAgICAgdmFyIGNvbG9yID0gdGhpcy5mb3JtYXRDb2xvcihjaS5zdWJzdHIoY2kuaW5kZXhPZigicmdiIiksIGNpLmxlbmd0aCkpOwogICAgICAgICAgICAgICAgY2kgPSBjaS5yZXBsYWNlKGNpLnN1YnN0cihjaS5pbmRleE9mKCJyZ2IiKSwgY2kubGVuZ3RoKSwgY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmRleE9mKHN0eWxlQiwgY2kpID09IC0xKSB7CgogICAgICAgICAgICAgICAgcmV0dXJuIDA7CgogICAgICAgICAgICB9Ly9zdHlsZUFbMF0uc3Vic3RyKHN0eWxlQVswXS5pbmRleE9mKCJyZ2EiKSxzdHlsZUFbMF0ubGVuZ3RoKQogICAgICAgIH0KICAgICAgICByZXR1cm4gMTsKICAgIH0sCgoKICAgIGZvcm1hdENvbG9yOmZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHZhciByZWcxID0gL15cI1tcZGEtZl17Nn0kL2ksCiAgICAgICAgICAgIHJlZzIgPSAvXnJnYlwoKFxkKyksXHMqKFxkKyksXHMqKFxkKylcKSQvLAogICAgICAgICAgICBrZXl3b3JkID0gewogICAgICAgICAgICAgICAgYmxhY2s6JyMwMDAwMDAnLAogICAgICAgICAgICAgICAgc2lsdmVyOicjYzBjMGMwJywKICAgICAgICAgICAgICAgIGdyYXk6JyM4MDgwODAnLAogICAgICAgICAgICAgICAgd2hpdGU6JyNmZmZmZmYnLAogICAgICAgICAgICAgICAgbWFyb29uOicjODAwMDAwJywKICAgICAgICAgICAgICAgIHJlZDonI2ZmMDAwMCcsCiAgICAgICAgICAgICAgICBwdXJwbGU6JyM4MDAwODAnLAogICAgICAgICAgICAgICAgZnVjaHNpYTonI2ZmMDBmZicsCiAgICAgICAgICAgICAgICBncmVlbjonIzAwODAwMCcsCiAgICAgICAgICAgICAgICBsaW1lOicjMDBmZjAwJywKICAgICAgICAgICAgICAgIG9saXZlOicjODA4MDAwJywKICAgICAgICAgICAgICAgIHllbGxvdzonI2ZmZmYwJywKICAgICAgICAgICAgICAgIG5hdnk6JyMwMDAwODAnLAogICAgICAgICAgICAgICAgYmx1ZTonIzAwMDBmZicsCiAgICAgICAgICAgICAgICB0ZWFsOicjMDA4MDgwJywKICAgICAgICAgICAgICAgIGFxdWE6JyMwMGZmZmYnCiAgICAgICAgICAgIH07CiAgICAgICAgaWYgKHJlZzEudGVzdChjb2xvcikpIHsKICAgICAgICAgICAgLy8gI1JSR0dCQiDnm7TmjqXov5Tlm54KICAgICAgICAgICAgcmV0dXJuIGNvbG9yOwogICAgICAgIH0gZWxzZSBpZiAocmVnMi50ZXN0KGNvbG9yKSkgewogICAgICAgICAgICAvLyDpnZ5JReS4reeahCByZ2IoMCwgMCwgMCkKICAgICAgICAgICAgZm9yICh2YXIgcywgaSA9IDEsIGNvbG9yID0gIiMiOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICAgICAgICBzID0gcGFyc2VJbnQoUmVnRXhwWyJceDI0IiArIGldKS50b1N0cmluZygxNik7CiAgICAgICAgICAgICAgICBjb2xvciArPSAoIjAwIiArIHMpLnN1YnN0cihzLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbG9yOwogICAgICAgIH0gZWxzZSBpZiAoL15cI1tcZGEtZl17M30kLy50ZXN0KGNvbG9yKSkgewogICAgICAgICAgICAvLyDnroDlhpnnmoTpopzoibLlgLw6ICNGMDAKICAgICAgICAgICAgdmFyIHMxID0gY29sb3IuY2hhckF0KDEpLAogICAgICAgICAgICAgICAgczIgPSBjb2xvci5jaGFyQXQoMiksCiAgICAgICAgICAgICAgICBzMyA9IGNvbG9yLmNoYXJBdCgzKTsKICAgICAgICAgICAgcmV0dXJuICIjIiArIHMxICsgczEgKyBzMiArIHMyICsgczMgKyBzMzsKICAgICAgICB9IGVsc2UgaWYgKGtleXdvcmRbY29sb3JdKQogICAgICAgICAgICByZXR1cm4ga2V5d29yZFtjb2xvcl07CgogICAgICAgIHJldHVybiAiIjsKCiAgICB9LAogICAgaGFzU2FtZUF0dHJzOmZ1bmN0aW9uIChub2RlQSwgbm9kZUIpIHsKICAgICAgICBpZiAobm9kZUEudGFnTmFtZSAhPSBub2RlQi50YWdOYW1lKQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB2YXIgdGhpc0F0dHJpYnMgPSBub2RlQS5hdHRyaWJ1dGVzLAogICAgICAgICAgICBvdGhlckF0dHJpYnMgPSBub2RlQi5hdHRyaWJ1dGVzOwogICAgICAgIGlmICh0aGlzQXR0cmlicy5sZW5ndGggIT0gb3RoZXJBdHRyaWJzLmxlbmd0aCkKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgaWYgKHRoaXNBdHRyaWJzLmxlbmd0aCA9PSAwKQogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB2YXIgYXR0ckEsIGF0dHJCOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBhdHRyQSA9IHRoaXNBdHRyaWJzW2krK107KSB7CiAgICAgICAgICAgIGlmIChhdHRyQS5ub2RlTmFtZSA9PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1NhbWVTdHlsZShub2RlQSwgbm9kZUIpKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF1YS5icm93c2VyLmllIHx8IGF0dHJBLnNwZWNpZmllZCkgewogICAgICAgICAgICAgICAgYXR0ckIgPSBub2RlQi5hdHRyaWJ1dGVzW2F0dHJBLm5vZGVOYW1lXTsKICAgICAgICAgICAgICAgIGlmICghYXR0ckIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDE7CiAgICB9LAogICAgLyoqCiAgICAgKua4hemZpOepulRleHToioLngrkKICAgICAqLwoKICAgIGNsZWFyV2hpdGVOb2RlOmZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHRtcE5vZGUgPSBub2RlLmNoaWxkTm9kZXNbaV07CiAgICAgICAgICAgIGlmICh0bXBOb2RlLm5vZGVUeXBlID09IDMgJiYgIXRtcE5vZGUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0bXBOb2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodG1wTm9kZSk7CiAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAogICAgLyoqCiAgICAgKuajgOafpeS4pOS4quiKgueCue+8iOWMheWQq+aJgOacieWtkOiKgueCue+8ieaYr+WQpuWFt+acieebuOWQjOeahOWxnuaApwogICAgICovCiAgICBmbGFnOnRydWUsCiAgICBjaGVja0FsbENoaWxkQXR0cmliczpmdW5jdGlvbiAobm9kZUEsIG5vZGVCKSB7CiAgICAgICAgdmFyIGsgPSBub2RlQS5jaGlsZE5vZGVzLmxlbmd0aDsKICAgICAgICBpZiAoayAhPSBub2RlQi5jaGlsZE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAodWEuYnJvd3Nlci5vcGVyYSkgewogICAgICAgICAgICAgICAgdGhpcy5jbGVhcldoaXRlTm9kZShub2RlQSk7CiAgICAgICAgICAgICAgICBrID0gbm9kZUEuY2hpbGROb2Rlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoayAhPSBub2RlQi5jaGlsZE5vZGVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICB0aGlzLmZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB0aGlzLmZsYWcgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmZsYWcpCiAgICAgICAgICAgIHJldHVybiB0aGlzLmZsYWc7CiAgICAgICAgd2hpbGUgKGspIHsKICAgICAgICAgICAgdmFyIHRtcE5vZGVBID0gbm9kZUEuY2hpbGROb2Rlc1trIC0gMV07CiAgICAgICAgICAgIHZhciB0bXBOb2RlQiA9IG5vZGVCLmNoaWxkTm9kZXNbayAtIDFdOwogICAgICAgICAgICBrLS07CgogICAgICAgICAgICBpZiAodG1wTm9kZUEubm9kZVR5cGUgPT0gMyB8fCB0bXBOb2RlQi5ub2RlVHlwZSA9PSAzIHx8IHRtcE5vZGVBLm5vZGVUeXBlID09IDggfHwgdG1wTm9kZUIubm9kZVR5cGUgPT0gOCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAoIXRoaXMuaGFzU2FtZUF0dHJzKHRtcE5vZGVBLCB0bXBOb2RlQikpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxhZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNoZWNrQWxsQ2hpbGRBdHRyaWJzKHRtcE5vZGVBLCB0bXBOb2RlQik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmZsYWc7CiAgICB9LAogICAgaGF2ZVNhbWVBbGxDaGlsZEF0dHJpYnM6ZnVuY3Rpb24gKG5vZGVBLCBub2RlQikgewogICAgICAgIHRoaXMuZmxhZyA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tBbGxDaGlsZEF0dHJpYnMobm9kZUEsIG5vZGVCKTsKICAgIH0sCiAgICAvKuafpeeci+S8oOWFpeeahGh0bWzmmK/lkKbkuI7kvKDlhaXnmoTlhYPntKBlbGXlhbfmnInnm7jlkIznmoRzdHlsZSovCiAgICBjaGVja0hUTUxTYW1lU3R5bGU6ZnVuY3Rpb24gKGh0bWwsIGRvYywgZWxlLCBkZXNjcmlwdCkgewogICAgICAgIHZhciB0YWdFbGUgPSBkb2MuY3JlYXRlRWxlbWVudChlbGUudGFnTmFtZSk7CiAgICAgICAgdGFnRWxlLmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgLyrkvJrmnInkuIDkupvkuI3lj6/op4HlrZfnrKbvvIzlnKjmr5TovoPliY3mj5DliY3liKDmjokqLwogICAgICAgIHRoaXMubWFudWFsRGVsZXRlRmlsbERhdGEoZWxlKTsKICAgICAgICBvayh0aGlzLmhhdmVTYW1lQWxsQ2hpbGRBdHRyaWJzKGVsZSwgdGFnRWxlKSwgZGVzY3JpcHQpOwovLyAgICAgICAgb2sodGhpcy5lcXVhbHNOb2RlKGVsZS5pbm5lckhNVEwsaHRtbCksZGVzY3JpcHQpOwogICAgfSwKCgogICAgZXF1YWxzTm9kZTpmdW5jdGlvbiAobmEsIG5iKSB7CiAgICAgICAgZnVuY3Rpb24gY29tcGFyZShub2RlQSwgbm9kZUIpIHsKICAgICAgICAgICAgaWYgKG5vZGVBLm5vZGVUeXBlICE9IG5vZGVCLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZUEubm9kZVR5cGUgPT0gMykgewogICAgICAgICAgICAgICAgcmV0dXJuICBub2RlQS5ub2RlVmFsdWUgPT0gbm9kZUIubm9kZVZhbHVlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzU2FtZUVsZW1lbnQobm9kZUEsIG5vZGVCKSkgewogICAgICAgICAgICAgICAgaWYgKCFub2RlQS5maXJzdENoaWxkICYmICFub2RlQi5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobm9kZUEuZmlyc3RDaGlsZCAmJiAhbm9kZUIuZmlyc3RDaGlsZCB8fCAhbm9kZUEuZmlyc3RDaGlsZCAmJiBub2RlQi5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhaSwgYmk7IGFpID0gbm9kZUEuY2hpbGROb2Rlc1tpXSwgYmkgPSBub2RlQi5jaGlsZE5vZGVzW2krK107KSB7CgogICAgICAgICAgICAgICAgICAgIGlmICghY29tcGFyZShhaSwgYmkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNvbXBhcmUoZG9tVXRpbHMuY3JlYXRlRWxlbWVudChkb2N1bWVudCwgJ2RpdicsIHsKICAgICAgICAgICAgJ2lubmVySFRNTCc6bmEKICAgICAgICB9KSwgZG9tVXRpbHMuY3JlYXRlRWxlbWVudChkb2N1bWVudCwgJ2RpdicsIHsKICAgICAgICAgICAgJ2lubmVySFRNTCc6bmIKICAgICAgICB9KSk7CiAgICB9LAoKCiAgICBnZXRTZWxlY3RlZFRleHQ6ZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh3aW5kb3cuZ2V0U2VsZWN0aW9uKSB7CiAgICAgICAgICAgIC8vIFRoaXMgdGVjaG5pcXVlIGlzIHRoZSBtb3N0IGxpa2VseSB0byBiZSBzdGFuZGFyZGl6ZWQuCiAgICAgICAgICAgIC8vIGdldFNlbGVjdGlvbigpIHJldHVybnMgYSBTZWxlY3Rpb24gb2JqZWN0LCB3aGljaCB3ZSBkbyBub3QgZG9jdW1lbnQuCiAgICAgICAgICAgIHJldHVybiB3aW5kb3cuZ2V0U2VsZWN0aW9uKCkudG9TdHJpbmcoKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKSB7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gb2xkZXIsIHNpbXBsZXIgdGVjaG5pcXVlIHRoYXQgcmV0dXJucyBhIHN0cmluZwogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRvY3VtZW50LnNlbGVjdGlvbikgewogICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBJRS1zcGVjaWZpYyB0ZWNobmlxdWUuCiAgICAgICAgICAgIC8vIFdlIGRvIG5vdCBkb2N1bWVudCB0aGUgSUUgc2VsZWN0aW9uIHByb3BlcnR5IG9yIFRleHRSYW5nZSBvYmplY3RzLgogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCkudGV4dDsKICAgICAgICB9CiAgICB9LAogICAgZmluZFBvc2l0aW9uOmZ1bmN0aW9uIChvRWxlbWVudCkgewogICAgICAgIHZhciB4MiA9IDA7CiAgICAgICAgdmFyIHkyID0gMDsKICAgICAgICB2YXIgd2lkdGggPSBvRWxlbWVudC5vZmZzZXRXaWR0aDsKICAgICAgICB2YXIgaGVpZ2h0ID0gb0VsZW1lbnQub2Zmc2V0SGVpZ2h0OwogICAgICAgIGlmICh0eXBlb2YoIG9FbGVtZW50Lm9mZnNldFBhcmVudCApICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIGZvciAodmFyIHBvc1ggPSAwLCBwb3NZID0gMDsgb0VsZW1lbnQ7IG9FbGVtZW50ID0gb0VsZW1lbnQub2Zmc2V0UGFyZW50KSB7CiAgICAgICAgICAgICAgICBwb3NYICs9IG9FbGVtZW50Lm9mZnNldExlZnQ7CiAgICAgICAgICAgICAgICBwb3NZICs9IG9FbGVtZW50Lm9mZnNldFRvcDsKICAgICAgICAgICAgfQogICAgICAgICAgICB4MiA9IHBvc1ggKyB3aWR0aDsKICAgICAgICAgICAgeTIgPSBwb3NZICsgaGVpZ2h0OwogICAgICAgICAgICByZXR1cm4gWyBwb3NYLCBwb3NZICwgeDIsIHkyXTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeDIgPSBvRWxlbWVudC54ICsgd2lkdGg7CiAgICAgICAgICAgIHkyID0gb0VsZW1lbnQueSArIGhlaWdodDsKICAgICAgICAgICAgcmV0dXJuIFsgb0VsZW1lbnQueCwgb0VsZW1lbnQueSwgeDIsIHkyXTsKICAgICAgICB9CiAgICB9LAoKICAgIGNoZWNrRWxlbWVudFBhdGg6ZnVuY3Rpb24gKGFycjEsIGFycjIsIGRlc2NyaXB0KSB7CiAgICAgICAgaWYgKCFkZXNjcmlwdCkKICAgICAgICAgICAgZGVzY3JpcHQgPSAnJzsKICAgICAgICB2YXIgaW5kZXggPSBhcnIxLmxlbmd0aDsKICAgICAgICBpZiAoaW5kZXggIT0gYXJyMi5sZW5ndGgpCiAgICAgICAgICAgIG9rKGZhbHNlLCAn6Lev5b6E5rex5bqm5LiN55u45ZCMJyk7CiAgICAgICAgZWxzZSB7CgogICAgICAgICAgICB3aGlsZSAoaW5kZXggPiAwKQogICAgICAgICAgICAgICAgZXF1YWwoYXJyMVstLWluZGV4IF0sIGFycjJbaW5kZXggXSwgZGVzY3JpcHQgKyAnLS0t56ysJyArIGluZGV4ICsgJ+S4quWFg+e0oCcgKyBhcnIxW2luZGV4XSk7CiAgICAgICAgfQogICAgfSwKICAgIGdldEJyb3dzZXI6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBicm93c2VyID0gIiI7CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5pZSA9PSA2KQogICAgICAgICAgICBicm93c2VyID0gJ2llNic7CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5pZSA9PSA3KQogICAgICAgICAgICBicm93c2VyID0gJ2llNyc7CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5pZSA9PSA4KQogICAgICAgICAgICBicm93c2VyID0gJ2llOCc7CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5pZSA9PSA5KQogICAgICAgICAgICBicm93c2VyID0gJ2llOSc7CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5zYWZhcmkpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnc2FmYXJpJzsKICAgICAgICBpZiAodGhpcy5icm93c2VyLmZpcmVmb3gpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnZmlyZWZveCc7CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5jaHJvbWUpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnY2hyb21lJzsKICAgICAgICBpZiAodGhpcy5icm93c2VyLm1heHRob24pIHsKICAgICAgICAgICAgYnJvd3NlciA9ICdtYXh0aG9uJzsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuYnJvd3Nlci5tYXh0aG9uSUUpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnbWF4SUUnOwogICAgICAgIGlmICh0aGlzLmJyb3dzZXIub3BlcmEpCiAgICAgICAgICAgIGJyb3dzZXIgPSAnb3BlcmEnOwogICAgICAgIHJldHVybiBicm93c2VyOwogICAgfSwKICAgIGdldEZsb2F0U3R5bGU6ZnVuY3Rpb24gKGVsZSkgewogICAgICAgIGlmICh0aGlzLmJyb3dzZXIuaWUpCiAgICAgICAgICAgIHJldHVybiBlbGUuc3R5bGVbJ3N0eWxlRmxvYXQnXTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBlbGUuc3R5bGVbJ2Nzc0Zsb2F0J107CiAgICB9LAoKICAgIGdldENvbXB1dGVkU3R5bGU6ZnVuY3Rpb24oZWxlICl7CiAgICAgICAgaWYodGhpcy5icm93c2VyLmllJiZ1YS5icm93c2VyLmllPDkpewogICAgICAgICAgICByZXR1cm4gZWxlLmN1cnJlbnRTdHlsZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZSk7CiAgICAgICAgfQogICAgfSwKICAgIHJlYWRGaWxlOmZ1bmN0aW9uIChuYW1lLCBmKSB7CiAgICAgICAgdmFyIGFyZ3MgPSB7fTsKICAgICAgICBhcmdzWyduYW1lJ10gPSAgbmFtZTsKICAgICAgICAkLmFqYXgoewogICAgICAgICAgICB1cmw6J3JlYWQucGhwJywKICAgICAgICAgICAgdHlwZToncG9zdCcsCiAgICAgICAgICAgIGRhdGE6YXJncywKICAgICAgICAgICAgc3VjY2VzczpmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgICAgICBmKG1zZyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVycm9yOmZ1bmN0aW9uICh4aHIsIG1zZykgewogICAgICAgICAgICAgICAgZihudWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKICAgIHJlYWRUeHQ6ZnVuY3Rpb24gKG5hbWUsIGYpIHsKICAgICAgICB2YXIgYXJncyA9IHt9OwogICAgICAgIGFyZ3NbJ25hbWUnXSA9ICcuL3R4dC8nICsgbmFtZTsKICAgICAgICAkLmFqYXgoewogICAgICAgICAgICB1cmw6J3JlYWQucGhwJywKICAgICAgICAgICAgdHlwZToncG9zdCcsCiAgICAgICAgICAgIGRhdGE6YXJncywKICAgICAgICAgICAgc3VjY2VzczpmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgICAgICBmKG1zZyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVycm9yOmZ1bmN0aW9uICh4aHIsIG1zZykgewogICAgICAgICAgICAgICAgZihudWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwgY2hlY2tMb3dlckNhc2U6ZnVuY3Rpb24gKHN0cmluZ0EsIHN0cmluZ0IpIHsKICAgICAgICBpZiAoIShzdHJpbmdBIHx8IHN0cmluZ0IpKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBlbHNlIGlmICghc3RyaW5nQSB8fCAhc3RyaW5nQikKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nQS50b0xvd2VyQ2FzZSgpID09IHN0cmluZ0IudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICB9LCByZW1vdmVFbmRTZW1pY29sb246ZnVuY3Rpb24gKHN0eWxlVmFsdWUpIHsKICAgICAgICBpZiAoc3R5bGVWYWx1ZS5sZW5ndGggLSAxID09IHN0eWxlVmFsdWUubGFzdEluZGV4T2YoJzsnKSkKICAgICAgICAgICAgc3R5bGVWYWx1ZSA9IHN0eWxlVmFsdWUuc3Vic3RyaW5nKDAsIHN0eWxlVmFsdWUubGVuZ3RoIC0gMSk7CiAgICAgICAgcmV0dXJuIHN0eWxlVmFsdWU7CiAgICB9LCBjaGVja05vZGVTdHlsZTpmdW5jdGlvbiAobm9kZUEsIG5vZGVCKSB7CiAgICAgICAgdmFyIG5vZGVBU3R5bGUgPSB0aGlzLnJlbW92ZUVuZFNlbWljb2xvbihub2RlQS5nZXRBdHRyKCJzdHlsZSIpLnJlcGxhY2UoL1xzKy9nLCAiIikpLnJlcGxhY2UoLyZxdW90Oy9nLCcnKS5zcGxpdCgiOyIpOwogICAgICAgIHZhciBub2RlQlN0eWxlID0gdGhpcy5yZW1vdmVFbmRTZW1pY29sb24obm9kZUIuZ2V0QXR0cigic3R5bGUiKS5yZXBsYWNlKC9ccysvZywgIiIpKS5yZXBsYWNlKC8mcXVvdDsvZywnJykuc3BsaXQoIjsiKTsKICAgICAgICB2YXIgbGVuZ3RoQSA9IG5vZGVBU3R5bGUubGVuZ3RoOwogICAgICAgIHZhciBsZW5ndGhCID0gbm9kZUJTdHlsZS5sZW5ndGg7CiAgICAgICAgaWYgKCEobGVuZ3RoQSAmJiBsZW5ndGhCKSkKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgZWxzZSBpZiAobGVuZ3RoQSAhPSBsZW5ndGhCKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoQTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZUFTdHlsZVtpXS5tYXRjaCgvWy1cd10rXHMqOi8pICkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZU5hbWUgPSBub2RlQVN0eWxlW2ldLm1hdGNoKC9bLVx3XStccyo6LylbMF0ucmVwbGFjZSgvXHMqOi8sICIiKTsKICAgICAgICAgICAgICAgICAgICBub2RlQS5hdHRycy5zdHlsZSA9IG5vZGVBLmF0dHJzLnN0eWxlLnJlcGxhY2UoLyZxdW90Oy9nLCcnKTsKICAgICAgICAgICAgICAgICAgICBub2RlQi5hdHRycy5zdHlsZSA9IG5vZGVCLmF0dHJzLnN0eWxlLnJlcGxhY2UoLyZxdW90Oy9nLCcnKTsKICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVWYWx1ZUEgPSBub2RlQS5nZXRTdHlsZShzdHlsZU5hbWUpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMrL2csICIiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVWYWx1ZUIgPSBub2RlQi5nZXRTdHlsZShzdHlsZU5hbWUpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMrL2csICIiKTsKICAgICAgICAgICAgICAgICAgICBpZigvY29sb3IvLnRlc3Qoc3R5bGVOYW1lKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVmFsdWVBID0gdGhpcy5mb3JtYXRDb2xvcihzdHlsZVZhbHVlQSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVmFsdWVCID0gdGhpcy5mb3JtYXRDb2xvcihzdHlsZVZhbHVlQik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWVBICE9IHN0eWxlVmFsdWVCKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LCBnZXRQcm9wZXJ0eUNvdW50OmZ1bmN0aW9uIChvKSB7CiAgICAgICAgdmFyIG4sIGNvdW50ID0gMDsKICAgICAgICBmb3IgKG4gaW4gbykgewogICAgICAgICAgICBpZiAoby5oYXNPd25Qcm9wZXJ0eShuKSkgewogICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY291bnQ7CiAgICB9LGZvcm1IcmVmOmZ1bmN0aW9uKHN0cil7CiAgICAgICAgaWYoc3RyLmxhc3RJbmRleE9mKCcvJyk9PSBzdHIubGVuZ3RoLTEpewogICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyaW5nKDAsc3RyLmxlbmd0aC0xKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgIH0sY2hlY2tTYW1lTm9kZUF0dHJzOmZ1bmN0aW9uIChub2RlQSwgbm9kZUIpIHsKICAgICAgICB2YXIgbGVuZ3RoQSA9IHRoaXMuZ2V0UHJvcGVydHlDb3VudChub2RlQS5hdHRycyk7CiAgICAgICAgdmFyIGxlbmd0aEIgPSB0aGlzLmdldFByb3BlcnR5Q291bnQobm9kZUIuYXR0cnMpOwogICAgICAgIGlmICghKGxlbmd0aEEgJiYgbGVuZ3RoQikpCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UgaWYgKGxlbmd0aEEgIT0gbGVuZ3RoQikKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBwIGluIG5vZGVBLmF0dHJzKSB7CiAgICAgICAgICAgICAgICBpZighbm9kZUIuZ2V0QXR0cihwKSYmIW5vZGVBLmdldEF0dHIocCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBlbHNlIGlmICghbm9kZUIuZ2V0QXR0cihwKXx8IW5vZGVBLmdldEF0dHIocCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgZWxzZSBpZiAocC50b0xvd2VyQ2FzZSgpID09ICJzdHlsZSIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tOb2RlU3R5bGUobm9kZUEsIG5vZGVCKSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZihwLnRvTG93ZXJDYXNlKCkgPT0gImhyZWYiKXsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mb3JtSHJlZihub2RlQS5nZXRBdHRyKHApLnRvTG93ZXJDYXNlKCkpICE9IHRoaXMuZm9ybUhyZWYobm9kZUIuZ2V0QXR0cihwKS50b0xvd2VyQ2FzZSgpKSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVBLmdldEF0dHIocCkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgIiIpICE9IG5vZGVCLmdldEF0dHIocCkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgIiIpKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSwgY2hlY2tDaGlsZHJlbjpmdW5jdGlvbiAobm9kZUEsIG5vZGVCKSB7CiAgICAgICAgaWYgKCEobm9kZUEuY2hpbGRyZW4gfHwgbm9kZUIuY2hpbGRyZW4pKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBlbHNlIGlmICghKG5vZGVBLmNoaWxkcmVuICYmIG5vZGVCLmNoaWxkcmVuKSkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgaWYgKG5vZGVBLmNoaWxkcmVuLmxlbmd0aCAhPSBub2RlQi5jaGlsZHJlbi5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGxlbmd0aEEgPSBub2RlQS5jaGlsZHJlbi5sZW5ndGg7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoQTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tTYW1lTm9kZShub2RlQS5jaGlsZHJlbltpXSwgbm9kZUIuY2hpbGRyZW5baV0pKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sIGNoZWNrU2FtZU5vZGU6ZnVuY3Rpb24gKG5vZGVBLCBub2RlQikgewogICAgICAgIGlmICghdGhpcy5jaGVja1NhbWVOb2RlQXR0cnMobm9kZUEsIG5vZGVCKSkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgaWYgKCF0aGlzLmNoZWNrQ2hpbGRyZW4obm9kZUEsIG5vZGVCKSkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgaWYgKG5vZGVBLmRhdGEgIT0gbm9kZUIuZGF0YSkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgaWYgKCF0aGlzLmNoZWNrTG93ZXJDYXNlKG5vZGVBLnRhZ05hbWUsIG5vZGVCLnRhZ05hbWUpKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSBpZiAoIXRoaXMuY2hlY2tMb3dlckNhc2Uobm9kZUEudHlwZSwgbm9kZUIudHlwZSkpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgfSwgY2hlY2tTYW1lSHRtbDpmdW5jdGlvbiAoc3RyaW5nQSwgc3RyaW5nQiwgc2Nob2xpdW0pIHsKICAgICAgICBvayh0aGlzLmNoZWNrU2FtZU5vZGUoVUUuaHRtbHBhcnNlcihzdHJpbmdBKSwgVUUuaHRtbHBhcnNlcihzdHJpbmdCKSksIHNjaG9saXVtKTsKICAgIH0sCiAgICBnZXRDb250ZXh0bWVudUluZGV4QnlOYW1lOmZ1bmN0aW9uKGNvbnRleHRtZW51LG5hbWUpewogICAgICAgIGZvcih2YXIgaT0wO2k8Y29udGV4dG1lbnUubGVuZ3RoO2krKyl7CiAgICAgICAgICAgIGlmKGNvbnRleHRtZW51W2ldLmlubmVyVGV4dCA9PW5hbWUgfHwgY29udGV4dG1lbnVbaV0udGV4dENvbnRlbnQgPT1uYW1lKQogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQp9Owp2YXIgdWEgPSBVc2VyQWN0aW9uOwp2YXIgdXBhdGggPSB1YS5jb21tb25EYXRhLmN1cnJlbnRQYXRoKCk7CnZhciBjcGF0aCA9IHVhLmNvbW1vbkRhdGEuZGF0YWRpcjs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 00:31:20 GMT",
                    "Content-Length": "70133",
                    "Date": "Sun, 09 Nov 2014 00:31:21 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}