{
    "url": "http://localhost:9999/movecodemove/SPA/libs/Exoskeleton.custom.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/movecodemove/SPA/libs/Exoskeleton.custom.js",
                "path": "/movecodemove/SPA/libs/Exoskeleton.custom.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tb3ZlY29kZW1vdmUvU1BBL2xpYnMvRXhvc2tlbGV0b24uY3VzdG9tLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjY0OTYNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDU6MTY6MTcgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA1OjE2OjE3IEdNVA0KDQovKiEKICogRXhvc2tlbGV0b24uanMgMC42LjMKICogKGMpIDIwMTMgUGF1bCBNaWxsZXIgPGh0dHA6Ly9wYXVsbWlsbHIuY29tPgogKiBCYXNlZCBvbiBCYWNrYm9uZS5qcwogKiAoYykgMjAxMC0yMDEzIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZAogKiBFeG9za2VsZXRvbiBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOiA8aHR0cDovL2V4b3Nqcy5jb20+CiAqLwoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKLy8JU2V0IHVwIEJhY2tib25lIGFwcHJvcHJpYXRlbHkgZm9yIHRoZSBlbnZpcm9ubWVudC4KCWlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKCQlkZWZpbmUoWyd1bmRlcnNjb3JlJywgJ2pxdWVyeScsICdleHBvcnRzJ10sIGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKCQkJcm9vdC5CYWNrYm9uZSA9IHJvb3QuRXhvc2tlbGV0b24gPSBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwoJCX0pOwoJfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKCQl2YXIgXywgJDsKCQl0cnkgeyBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOyB9IGNhdGNoKGUpIHsgfQoJCXRyeSB7ICQgPSByZXF1aXJlKCdqcXVlcnknKTsgfSBjYXRjaChlKSB7IH0KCQlmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwoJfSBlbHNlIHsKCQlyb290LkJhY2tib25lID0gcm9vdC5FeG9za2VsZXRvbiA9IGZhY3Rvcnkocm9vdCwge30sIHJvb3QuXywgKHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQpKTsKCX0KCn0pKHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfLCAkKSB7CgkndXNlIHN0cmljdCc7CgovLwlJbml0aWFsIFNldHVwCi8vCS0tLS0tLS0tLS0tLS0KCi8vCVNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQovLwlyZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCgl2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7Cgl2YXIgcHJldmlvdXNFeG9za2VsZXRvbiA9IHJvb3QuRXhvc2tlbGV0b247CgovLwlVbmRlcnNjb3JlIHJlcGxhY2VtZW50LgoJdmFyIHV0aWxzID0gQmFja2JvbmUudXRpbHMgPSBfID0gKF8gfHwge30pOwoKLy8JSG9sZCBvbnRvIGEgbG9jYWwgcmVmZXJlbmNlIHRvIGAkYC4gQ2FuIGJlIGNoYW5nZWQgYXQgYW55IHBvaW50LgoJQmFja2JvbmUuJCA9ICQ7CgovLwlDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgoJdmFyIGFycmF5ID0gW107Cgl2YXIgcHVzaCA9IGFycmF5LnB1c2g7Cgl2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKCXZhciB0b1N0cmluZyA9ICh7fSkudG9TdHJpbmc7CgovLwlDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgovLwlCYWNrYm9uZS5WRVJTSU9OID0gJzEuMC4wJzsKCi8vCVJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQovLwl0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCglCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CgkJcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CgkJcm9vdC5FeG9za2VsZXRvbiA9IHByZXZpb3VzRXhvc2tlbGV0b247CgkJcmV0dXJuIHRoaXM7Cgl9OwoKLy8JSGVscGVycwovLwktLS0tLS0tCgovLwlIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KLy8JU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKLy8JY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KCUJhY2tib25lLmV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CgkJdmFyIHBhcmVudCA9IHRoaXM7CgkJdmFyIGNoaWxkOwoKCQkvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CgkJLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAoJCS8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KCQlpZiAocHJvdG9Qcm9wcyAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CgkJCWNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKCQl9IGVsc2UgewoJCQljaGlsZCA9IGZ1bmN0aW9uKCl7IHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKCQl9CgoJCS8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgoJCV8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKCgkJLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKCQkvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgoJCXZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07CgkJU3Vycm9nYXRlLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CgkJY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCgkJLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCgkJLy8gaWYgc3VwcGxpZWQuCgkJaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgoJCS8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKCQkvLyBsYXRlci4KCQljaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKCQlyZXR1cm4gY2hpbGQ7Cgl9OwoKLy8JVGhyb3cgYW4gZXJyb3Igd2hlbiBhIFVSTCBpcyBuZWVkZWQsIGFuZCBub25lIGlzIHN1cHBsaWVkLgoJdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CgkJdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7Cgl9OwoKLy8JV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCgl2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCQl2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwoJCW9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbihyZXNwKSB7CgkJCWlmIChlcnJvcikgZXJyb3IobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJCQltb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCQl9OwoJfTsKCi8vCUNoZWNrZXIgZm9yIHV0aWxpdHkgbWV0aG9kcy4gVXNlZnVsIGZvciBjdXN0b20gYnVpbGRzLgoJdmFyIHV0aWxFeGlzdHMgPSBmdW5jdGlvbihtZXRob2QpIHsKCQlyZXR1cm4gdHlwZW9mIF9bbWV0aG9kXSA9PT0gJ2Z1bmN0aW9uJzsKCX07CgoJLyogdXRpbHMgKi8KCgl1dGlscy5yZXN1bHQgPSBmdW5jdGlvbiByZXN1bHQob2JqZWN0LCBwcm9wZXJ0eSkgewoJCXZhciB2YWx1ZSA9IG9iamVjdCA/IG9iamVjdFtwcm9wZXJ0eV0gOiB1bmRlZmluZWQ7CgkJcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyA/IG9iamVjdFtwcm9wZXJ0eV0oKSA6IHZhbHVlOwoJfTsKCgl1dGlscy5kZWZhdWx0cyA9IGZ1bmN0aW9uIGRlZmF1bHRzKG9iaikgewoJCXNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pIHsKCQkJZm9yICh2YXIga2V5IGluIGl0ZW0pIGlmIChvYmpba2V5XSA9PT0gdW5kZWZpbmVkKQoJCQkJb2JqW2tleV0gPSBpdGVtW2tleV07CgkJfSk7CgkJcmV0dXJuIG9iajsKCX07CgoJdXRpbHMuZXh0ZW5kID0gZnVuY3Rpb24gZXh0ZW5kKG9iaikgewoJCXNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pIHsKCQkJZm9yICh2YXIga2V5IGluIGl0ZW0pIG9ialtrZXldID0gaXRlbVtrZXldOwoJCX0pOwoJCXJldHVybiBvYmo7Cgl9OwoKCXZhciBodG1sRXNjYXBlcyA9IHsKCQkJJyYnOiAnJmFtcDsnLAoJCQknPCc6ICcmbHQ7JywKCQkJJz4nOiAnJmd0OycsCgkJCSciJzogJyZxdW90OycsCgkJCSInIjogJyYjMzk7JwoJfTsKCgl1dGlscy5lc2NhcGUgPSBmdW5jdGlvbiBlc2NhcGUoc3RyaW5nKSB7CgkJcmV0dXJuIHN0cmluZyA9PSBudWxsID8gJycgOiBTdHJpbmcoc3RyaW5nKS5yZXBsYWNlKC9bJjw+IiddL2csIGZ1bmN0aW9uKG1hdGNoKSB7CgkJCXJldHVybiBodG1sRXNjYXBlc1ttYXRjaF07CgkJfSk7Cgl9OwoKCXV0aWxzLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKCQl2YXIgaXRlcmF0b3IgPSB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgPyB2YWx1ZSA6IGZ1bmN0aW9uKG9iail7IHJldHVybiBvYmpbdmFsdWVdOyB9OwoJCXJldHVybiBvYmoKCQkubWFwKGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJCQlyZXR1cm4gewoJCQkJdmFsdWU6IHZhbHVlLAoJCQkJaW5kZXg6IGluZGV4LAoJCQkJY3JpdGVyaWE6IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KQoJCQl9OwoJCX0pCgkJLnNvcnQoZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKCQkJdmFyIGEgPSBsZWZ0LmNyaXRlcmlhOwoJCQl2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwoJCQlpZiAoYSAhPT0gYikgewoJCQkJaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkgcmV0dXJuIDE7CgkJCQlpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CgkJCX0KCQkJcmV0dXJuIGxlZnQuaW5kZXggLSByaWdodC5pbmRleDsKCQl9KQoJCS5tYXAoZnVuY3Rpb24oaXRlbSkgewoJCQlyZXR1cm4gaXRlbS52YWx1ZTsKCQl9KTsKCX07CgoJLyoqIFVzZWQgdG8gZ2VuZXJhdGUgdW5pcXVlIElEcyAqLwoJdmFyIGlkQ291bnRlciA9IDA7CgoJdXRpbHMudW5pcXVlSWQgPSBmdW5jdGlvbiB1bmlxdWVJZChwcmVmaXgpIHsKCQl2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwoJCXJldHVybiBwcmVmaXggPyBwcmVmaXggKyBpZCA6IGlkOwoJfTsKCgl2YXIgZXEgPSBmdW5jdGlvbihhLCBiLCBhU3RhY2ssIGJTdGFjaykgewoJCS8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KCQkvLyBTZWUgdGhlIFtIYXJtb255IGBlZ2FsYCBwcm9wb3NhbF0oaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsKS4KCQlpZiAoYSA9PT0gYikgcmV0dXJuIGEgIT09IDAgfHwgMSAvIGEgPT0gMSAvIGI7CgkJLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgoJCWlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKCQkvLyBVbndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cy4KCQkvL2lmIChhIGluc3RhbmNlb2YgXykgYSA9IGEuX3dyYXBwZWQ7CgkJLy9pZiAoYiBpbnN0YW5jZW9mIF8pIGIgPSBiLl93cmFwcGVkOwoJCS8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCgkJdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CgkJaWYgKGNsYXNzTmFtZSAhPSB0b1N0cmluZy5jYWxsKGIpKSByZXR1cm4gZmFsc2U7CgkJc3dpdGNoIChjbGFzc05hbWUpIHsKCQkvLyBTdHJpbmdzLCBudW1iZXJzLCBkYXRlcywgYW5kIGJvb2xlYW5zIGFyZSBjb21wYXJlZCBieSB2YWx1ZS4KCQljYXNlICdbb2JqZWN0IFN0cmluZ10nOgoJCQkvLyBQcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCB3cmFwcGVycyBhcmUgZXF1aXZhbGVudDsgdGh1cywgYCI1ImAgaXMKCQkJLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KCQkJcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwoJCWNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CgkJCS8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKCQkJLy8gb3RoZXIgbnVtZXJpYyB2YWx1ZXMuCgkJCXJldHVybiBhICE9PSArYSA/IGIgIT09ICtiIDogKGEgPT09IDAgPyAxIC8gYSA9PT0gMSAvIGIgOiBhID09PSArYik7CgkJY2FzZSAnW29iamVjdCBEYXRlXSc6CgkJY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CgkJCS8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKCQkJLy8gbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zLiBOb3RlIHRoYXQgaW52YWxpZCBkYXRlcyB3aXRoIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucwoJCQkvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCgkJCXJldHVybiArYSA9PSArYjsKCQkJLy8gUmVnRXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIHBhdHRlcm5zIGFuZCBmbGFncy4KCQljYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgoJCQlyZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKCQkJYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKCQkJYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKCQkJYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKCQl9CgkJaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CgkJLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwoJCS8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgoJCXZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwoJCXdoaWxlIChsZW5ndGgtLSkgewoJCQkvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKCQkJLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgoJCQlpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CgkJfQoJCS8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwoJCS8vIGZyb20gZGlmZmVyZW50IGZyYW1lcyBhcmUuCgkJdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwoJCWlmIChhQ3RvciAhPT0gYkN0b3IgJiYgISh0eXBlb2YgYUN0b3IgPT09ICdmdW5jdGlvbicgJiYgKGFDdG9yIGluc3RhbmNlb2YgYUN0b3IpICYmCgkJCQl0eXBlb2YgYkN0b3IgPT09ICdmdW5jdGlvbicgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKSkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCS8vIEFkZCB0aGUgZmlyc3Qgb2JqZWN0IHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KCQlhU3RhY2sucHVzaChhKTsKCQliU3RhY2sucHVzaChiKTsKCQl2YXIgc2l6ZSA9IDAsIHJlc3VsdCA9IHRydWU7CgkJLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCgkJaWYgKGNsYXNzTmFtZSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KCQkJc2l6ZSA9IGEubGVuZ3RoOwoJCQlyZXN1bHQgPSBzaXplID09PSBiLmxlbmd0aDsKCQkJaWYgKHJlc3VsdCkgewoJCQkJLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KCQkJCXdoaWxlIChzaXplLS0pIHsKCQkJCQlpZiAoIShyZXN1bHQgPSBlcShhW3NpemVdLCBiW3NpemVdLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCS8vIERlZXAgY29tcGFyZSBvYmplY3RzLgoJCQlmb3IgKHZhciBrZXkgaW4gYSkgewoJCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwoYSwga2V5KSkgewoJCQkJCS8vIENvdW50IHRoZSBleHBlY3RlZCBudW1iZXIgb2YgcHJvcGVydGllcy4KCQkJCQlzaXplKys7CgkJCQkJLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgoJCQkJCWlmICghKHJlc3VsdCA9IGhhc093blByb3BlcnR5LmNhbGwoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CgkJCQl9CgkJCX0KCQkJLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMuCgkJCWlmIChyZXN1bHQpIHsKCQkJCWZvciAoa2V5IGluIGIpIHsKCQkJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChiLCBrZXkpICYmICEoc2l6ZS0tKSkgYnJlYWs7CgkJCQl9CgkJCQlyZXN1bHQgPSAhc2l6ZTsKCQkJfQoJCX0KCQkvLyBSZW1vdmUgdGhlIGZpcnN0IG9iamVjdCBmcm9tIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KCQlhU3RhY2sucG9wKCk7CgkJYlN0YWNrLnBvcCgpOwoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCS8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgoJdXRpbHMuaXNFcXVhbCA9IGZ1bmN0aW9uKGEsIGIpIHsKCQlyZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKCX07CgoJLyogZXZlbnRzICovCgoJLy8gQmFja2JvbmUuRXZlbnRzCgkvLyAtLS0tLS0tLS0tLS0tLS0KCgkvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCgkvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCgkvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgoJLy8gc3VjY2Vzc2lvbi4KCS8vCi8vCXZhciBvYmplY3QgPSB7fTsKLy8JXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwovLwlvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKLy8Jb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwoJLy8KCXZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgoJCQkvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAoJCQkvLyB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KCQkJb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkJCQlpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spCgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl0aGlzLl9ldmVudHMgfHwgKHRoaXMuX2V2ZW50cyA9IHt9KTsKCQkJCXZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKCQkJCWV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCgkJCS8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKCQkJLy8gdGhlIGNhbGxiYWNrIGlzIGludm9rZWQsIGl0IHdpbGwgYmUgcmVtb3ZlZC4KCQkJb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCQkJCWlmICghZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKQoJCQkJCXJldHVybiB0aGlzOwoJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJdmFyIHJhbjsKCgkJCQl2YXIgb25jZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmIChyYW4pIHJldHVybjsKCQkJCQlyYW4gPSB0cnVlOwoJCQkJCXNlbGYub2ZmKG5hbWUsIG9uY2UpOwoJCQkJCWNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQkJb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKCQkJCXJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwoJCQl9LAoKCQkJLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCgkJCS8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKCQkJLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAoJCQkvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCgkJCW9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCQkJCXZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwoJCQkJaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkpCgkJCQkJcmV0dXJuIHRoaXM7CgkJCQlpZiAoIW5hbWUgJiYgIWNhbGxiYWNrICYmICFjb250ZXh0KSB7CgkJCQkJdGhpcy5fZXZlbnRzID0gdW5kZWZpbmVkOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoKCQkJCW5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IE9iamVjdC5rZXlzKHRoaXMuX2V2ZW50cyk7CgkJCQlmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJCQkJbmFtZSA9IG5hbWVzW2ldOwoJCQkJCWlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKCQkJCQkJdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CgkJCQkJCWlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CgkJCQkJCQlmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewoJCQkJCQkJCWV2ID0gZXZlbnRzW2pdOwoJCQkJCQkJCWlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmCgkJCQkJCQkJCQljYWxsYmFjayAhPT0gZXYuY2FsbGJhY2suX2NhbGxiYWNrKSB8fAoJCQkJCQkJCQkJKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKCQkJCQkJCQkJcmV0YWluLnB1c2goZXYpOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQlpZiAoIXJldGFpbi5sZW5ndGgpIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoKCQkJLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCgkJCS8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCgkJCS8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KCQkJLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgoJCQl0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CgkJCQlpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CgkJCQl2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCQkJCWlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwoJCQkJdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKCQkJCXZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwoJCQkJaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwoJCQkJaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCgkJCS8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKCQkJLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4KCQkJc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewoJCQkJdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG87CgkJCQlpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKCQkJCXZhciByZW1vdmUgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CgkJCQlpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwoJCQkJaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwoJCQkJZm9yICh2YXIgaWQgaW4gbGlzdGVuaW5nVG8pIHsKCQkJCQlvYmogPSBsaXN0ZW5pbmdUb1tpZF07CgkJCQkJb2JqLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CgkJCQkJaWYgKHJlbW92ZSB8fCAhT2JqZWN0LmtleXMob2JqLl9ldmVudHMpLmxlbmd0aCkgewoJCQkJCQlkZWxldGUgdGhpcy5fbGlzdGVuaW5nVG9baWRdOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJfTsKCgkvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgoJdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCgkvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAoJLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKCS8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCgl2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsKCQlpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoJCXZhciBhcnI7CgoJCS8vIEhhbmRsZSBldmVudCBtYXBzLgoJCWlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKCQkJZm9yICh2YXIga2V5IGluIG5hbWUpIHsKCQkJCWFyciA9IFtrZXksIG5hbWVba2V5XV07CgkJCQlwdXNoLmFwcGx5KGFyciwgcmVzdCk7CgkJCQlvYmpbYWN0aW9uXS5hcHBseShvYmosIGFycik7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KCQlpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CgkJCXZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CgkJCWZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJCQlhcnIgPSBbbmFtZXNbaV1dOwoJCQkJcHVzaC5hcHBseShhcnIsIHJlc3QpOwoJCQkJb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBhcnIpOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXJldHVybiB0cnVlOwoJfTsKCgkvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgoJLy8gdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBpbnRlcm5hbAoJLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgoJdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKCQl2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CgkJc3dpdGNoIChhcmdzLmxlbmd0aCkgewoJCWNhc2UgMDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOyByZXR1cm47CgkJY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CgkJY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyKTsgcmV0dXJuOwoJCWNhc2UgMzogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOyByZXR1cm47CgkJZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsKCQl9Cgl9OwoKCXZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgoJLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KCS8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKCS8vIGxpc3RlbmluZyB0by4KCU9iamVjdC5rZXlzKGxpc3Rlbk1ldGhvZHMpLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CgkJdmFyIGltcGxlbWVudGF0aW9uID0gbGlzdGVuTWV0aG9kc1ttZXRob2RdOwoJCUV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewoJCQl2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CgkJCXZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwoJCQlsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CgkJCWlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CgkJCW9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwoJCQlyZXR1cm4gdGhpczsKCQl9OwoJfSk7CgoJLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCglFdmVudHMuYmluZCAgID0gRXZlbnRzLm9uOwoJRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgoJLyogcm91dGVyICovCgoJLy8gQmFja2JvbmUuUm91dGVyCgkvLyAtLS0tLS0tLS0tLS0tLS0KCgkvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQoJLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KCXZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCQlpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CgkJdGhpcy5fYmluZFJvdXRlcygpOwoJCXRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfTsKCgkvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCgkvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLgoJdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7Cgl2YXIgbmFtZWRQYXJhbSAgICA9IC8oXChcPyk/Olx3Ky9nOwoJdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKCXZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgoJdmFyIGlzUmVnRXhwID0gZnVuY3Rpb24odmFsdWUpIHsKCQlyZXR1cm4gdmFsdWUgPyAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgUmVnRXhwXScpIDogZmFsc2U7Cgl9OwoKCS8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgoJXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJCS8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgoJCS8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgoJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCgkJLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKCQkvLwoJCS8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKCQkvLyAgICAgICAuLi4KCQkvLyAgICAgfSk7CgkJLy8KCQlyb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CgkJCWlmICghaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwoJCQlpZiAodHlwZW9mIG5hbWUgPT09ICdmdW5jdGlvbicpIHsKCQkJCWNhbGxiYWNrID0gbmFtZTsKCQkJCW5hbWUgPSAnJzsKCQkJfQoJCQlpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CgkJCXZhciByb3V0ZXIgPSB0aGlzOwoJCQlCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbihmcmFnbWVudCkgewoJCQkJdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CgkJCQlyb3V0ZXIuZXhlY3V0ZShjYWxsYmFjaywgYXJncyk7CgkJCQlyb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CgkJCQlyb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKCQkJCUJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCByb3V0ZXIsIG5hbWUsIGFyZ3MpOwoJCQl9KTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJLy8gRXhlY3V0ZSBhIHJvdXRlIGhhbmRsZXIgd2l0aCB0aGUgcHJvdmlkZWQgcGFyYW1ldGVycy4gIFRoaXMgaXMgYW4KCQkvLyBleGNlbGxlbnQgcGxhY2UgdG8gZG8gcHJlLXJvdXRlIHNldHVwIG9yIHBvc3Qtcm91dGUgY2xlYW51cC4KCQlleGVjdXRlOiBmdW5jdGlvbihjYWxsYmFjaywgYXJncykgewoJCQlpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sCgoJCS8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCgkJbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CgkJCUJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKCQkvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCgkJLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KCQlfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CgkJCWlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKCQkJdGhpcy5yb3V0ZXMgPSBfLnJlc3VsdCh0aGlzLCAncm91dGVzJyk7CgkJCXZhciByb3V0ZSwgcm91dGVzID0gT2JqZWN0LmtleXModGhpcy5yb3V0ZXMpOwoJCQl3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CgkJCQl0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwoJCQl9CgkJfSwKCgkJLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKCQkvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCgkJX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CgkJCXJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKCQkJLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQoJCQkucmVwbGFjZShuYW1lZFBhcmFtLCBmdW5jdGlvbihtYXRjaCwgb3B0aW9uYWwpIHsKCQkJCXJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKCQkJfSkKCQkJLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyhbXj9dKj8pJyk7CgkJCXJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyg/OlxcPyhbXFxzXFxTXSopKT8kJyk7CgkJfSwKCgkJLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgoJCS8vIGV4dHJhY3RlZCBkZWNvZGVkIHBhcmFtZXRlcnMuIEVtcHR5IG9yIHVubWF0Y2hlZCBwYXJhbWV0ZXJzIHdpbGwgYmUKCQkvLyB0cmVhdGVkIGFzIGBudWxsYCB0byBub3JtYWxpemUgY3Jvc3MtYnJvd3NlciBiZWhhdmlvci4KCQlfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewoJCQl2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CgkJCXJldHVybiBwYXJhbXMubWFwKGZ1bmN0aW9uKHBhcmFtLCBpKSB7CgkJCQkvLyBEb24ndCBkZWNvZGUgdGhlIHNlYXJjaCBwYXJhbXMuCgkJCQlpZiAoaSA9PT0gcGFyYW1zLmxlbmd0aCAtIDEpIHJldHVybiBwYXJhbSB8fCBudWxsOwoJCQkJcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CgkJCX0pOwoJCX0KCgl9KTsKCgkvKiBoaXN0b3J5ICovCgoJLy8gQmFja2JvbmUuSGlzdG9yeQoJLy8gLS0tLS0tLS0tLS0tLS0tLQoKCS8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgoJLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCgkvLyBbb25oYXNoY2hhbmdlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS93aW5kb3cub25oYXNoY2hhbmdlKQoJLy8gYW5kIFVSTCBmcmFnbWVudHMuCgl2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbigpIHsKCQl0aGlzLmhhbmRsZXJzID0gW107CgkJdGhpcy5jaGVja1VybCA9IHRoaXMuY2hlY2tVcmwuYmluZCh0aGlzKTsKCgkJLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuCgkJaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CgkJCXRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwoJCX0KCX07CgoJLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgYSBsZWFkaW5nIGhhc2gvc2xhc2ggYW5kIHRyYWlsaW5nIHNwYWNlLgoJdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCgkvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgoJdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKCgkvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCgl2YXIgdHJhaWxpbmdTbGFzaCA9IC9cLyQvOwoKCS8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIHVybHMgb2YgaGFzaCBhbmQgcXVlcnkuCgl2YXIgcGF0aFN0cmlwcGVyID0gL1sjXS4qJC87CgoJLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwoJSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgoJLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgoJXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKCQkvLyBBcmUgd2UgYXQgdGhlIGFwcCByb290PwoJCWF0Um9vdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwoJCX0sCgoJCS8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKCQkvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KCQlnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsKCQkJdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKCQkJcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKCQl9LAoKCQkvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCgkJLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KCQlnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CgkJCWlmIChmcmFnbWVudCA9PSBudWxsKSB7CgkJCQlpZiAodGhpcy5fd2FudHNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJCQkJCWZyYWdtZW50ID0gZGVjb2RlVVJJKHRoaXMubG9jYXRpb24ucGF0aG5hbWUgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCk7CgkJCQkJdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CgkJCQkJaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKCQkJCX0gZWxzZSB7CgkJCQkJZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CgkJfSwKCgkJLy8gU3RhcnQgdGhlIGhhc2ggY2hhbmdlIGhhbmRsaW5nLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBjdXJyZW50IFVSTCBtYXRjaGVzCgkJLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KCQlzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewoJCQlpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CgkJCUhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgoJCQkvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uCgkJCS8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIG9yIHNob3VsZCB3ZSB1c2UgaGFzaGNoYW5nZSBvbmx5PwoJCQl0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKCQkJdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CgkJCXRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKCQkJdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwoJCQl2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7CgoJCQkvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgoJCQl0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCgkJCS8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGRldGVybWluZSBob3cgd2UKCQkJLy8gY2hlY2sgdGhlIFVSTCBzdGF0ZS4KCQkJaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CgkJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsLCBmYWxzZSk7CgkJCX0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwsIGZhbHNlKTsKCQkJfQoKCQkJLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKCQkJLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgoJCQl0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgkJCXZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwoKCQkJLy8gVHJhbnNpdGlvbiBmcm9tIGhhc2hDaGFuZ2UgdG8gcHVzaFN0YXRlIG9yIHZpY2UgdmVyc2EgaWYgYm90aCBhcmUKCQkJLy8gcmVxdWVzdGVkLgoJCQlpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CgoJCQkJLy8gSWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKCQkJCS8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCgkJCQlpZiAodGhpcy5hdFJvb3QoKSAmJiBsb2MuaGFzaCkgewoJCQkJCXRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKCQkJCQl0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCk7CgkJCQl9CgoJCQl9CgoJCQlpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKCQl9LAoKCQkvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKCQkvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KCQlzdG9wOiBmdW5jdGlvbigpIHsKCQkJd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCk7CgkJCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CgkJCUhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoJCX0sCgoJCS8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKCQkvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgoJCXJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKCQkJdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwoJCX0sCgoJCS8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAoJCS8vIGNhbGxzIGBsb2FkVXJsYC4KCQljaGVja1VybDogZnVuY3Rpb24oKSB7CgkJCXZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwoJCQlpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwoJCQl0aGlzLmxvYWRVcmwoKTsKCQl9LAoKCQkvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQoJCS8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCgkJLy8gcmV0dXJucyBgZmFsc2VgLgoJCWxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50KSB7CgkJCWZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQpOwoJCQlyZXR1cm4gdGhpcy5oYW5kbGVycy5zb21lKGZ1bmN0aW9uKGhhbmRsZXIpIHsKCQkJCWlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CgkJCQkJaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKCQkvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCgkJLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCgkJLy8KCQkvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCgkJLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKCQkvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgoJCW5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewoJCQlpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwoJCQlpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKCQkJdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCgkJCS8vIFN0cmlwIHRoZSBoYXNoIGZvciBtYXRjaGluZy4KCQkJZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwoKCQkJaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSByZXR1cm47CgkJCXRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCgkJCS8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KCQkJaWYgKGZyYWdtZW50ID09PSAnJyAmJiB1cmwgIT09ICcvJykgdXJsID0gdXJsLnNsaWNlKDAsIC0xKTsKCgkJCS8vIElmIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgoJCQlpZiAodGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCQkJCXRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgoJCQkJLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKCQkJCS8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCgkJCX0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkJCQl0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwoJCQkJLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCgkJCQkvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KCQkJfSBlbHNlIHsKCQkJCXJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwoJCQl9CgkJCWlmIChvcHRpb25zLnRyaWdnZXIpIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwoJCX0sCgoJCS8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCgkJLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCgkJX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewoJCQlpZiAocmVwbGFjZSkgewoJCQkJdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKCQkJCWxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKCQkJfSBlbHNlIHsKCQkJCS8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KCQkJCWxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKCQkJfQoJCX0KCgl9KTsKCgkvKiBmb290ZXIgKi8KCgkvLyAhISEKCS8vIEluaXQuCglbJ01vZGVsJywgJ0NvbGxlY3Rpb24nLCAnUm91dGVyJywgJ1ZpZXcnLCAnSGlzdG9yeSddLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewoJCXZhciBpdGVtID0gQmFja2JvbmVbbmFtZV07CgkJaWYgKGl0ZW0pIGl0ZW0uZXh0ZW5kID0gQmFja2JvbmUuZXh0ZW5kOwoJfSk7CgoJLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwoJLy8gd2FudCBnbG9iYWwgInB1YnN1YiIgaW4gYSBjb252ZW5pZW50IHBsYWNlLgoJXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgoJLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkgaWYgdGhlIEhpc3RvcnkgbW9kdWxlIGlzIGluY2x1ZGVkLgoJaWYgKEhpc3RvcnkpIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeSgpOwoJcmV0dXJuIEJhY2tib25lOwp9KTs=",
                "body": "LyohCiAqIEV4b3NrZWxldG9uLmpzIDAuNi4zCiAqIChjKSAyMDEzIFBhdWwgTWlsbGVyIDxodHRwOi8vcGF1bG1pbGxyLmNvbT4KICogQmFzZWQgb24gQmFja2JvbmUuanMKICogKGMpIDIwMTAtMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQKICogRXhvc2tlbGV0b24gbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjogPGh0dHA6Ly9leG9zanMuY29tPgogKi8KCihmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7Ci8vCVNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuCglpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CgkJZGVmaW5lKFsndW5kZXJzY29yZScsICdqcXVlcnknLCAnZXhwb3J0cyddLCBmdW5jdGlvbihfLCAkLCBleHBvcnRzKSB7CgkJCXJvb3QuQmFja2JvbmUgPSByb290LkV4b3NrZWxldG9uID0gZmFjdG9yeShyb290LCBleHBvcnRzLCBfLCAkKTsKCQl9KTsKCX0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CgkJdmFyIF8sICQ7CgkJdHJ5IHsgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsgfSBjYXRjaChlKSB7IH0KCQl0cnkgeyAkID0gcmVxdWlyZSgnanF1ZXJ5Jyk7IH0gY2F0Y2goZSkgeyB9CgkJZmFjdG9yeShyb290LCBleHBvcnRzLCBfLCAkKTsKCX0gZWxzZSB7CgkJcm9vdC5CYWNrYm9uZSA9IHJvb3QuRXhvc2tlbGV0b24gPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIChyb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kKSk7Cgl9Cgp9KSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoJJ3VzZSBzdHJpY3QnOwoKLy8JSW5pdGlhbCBTZXR1cAovLwktLS0tLS0tLS0tLS0tCgovLwlTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKLy8JcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgoJdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoJdmFyIHByZXZpb3VzRXhvc2tlbGV0b24gPSByb290LkV4b3NrZWxldG9uOwoKLy8JVW5kZXJzY29yZSByZXBsYWNlbWVudC4KCXZhciB1dGlscyA9IEJhY2tib25lLnV0aWxzID0gXyA9IChfIHx8IHt9KTsKCi8vCUhvbGQgb250byBhIGxvY2FsIHJlZmVyZW5jZSB0byBgJGAuIENhbiBiZSBjaGFuZ2VkIGF0IGFueSBwb2ludC4KCUJhY2tib25lLiQgPSAkOwoKLy8JQ3JlYXRlIGxvY2FsIHJlZmVyZW5jZXMgdG8gYXJyYXkgbWV0aG9kcyB3ZSdsbCB3YW50IHRvIHVzZSBsYXRlci4KCXZhciBhcnJheSA9IFtdOwoJdmFyIHB1c2ggPSBhcnJheS5wdXNoOwoJdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7Cgl2YXIgdG9TdHJpbmcgPSAoe30pLnRvU3RyaW5nOwoKLy8JQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5LiBLZWVwIGluIHN5bmMgd2l0aCBgcGFja2FnZS5qc29uYC4KLy8JQmFja2JvbmUuVkVSU0lPTiA9ICcxLjAuMCc7CgovLwlSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKLy8JdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgoJQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewoJCXJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwoJCXJvb3QuRXhvc2tlbGV0b24gPSBwcmV2aW91c0V4b3NrZWxldG9uOwoJCXJldHVybiB0aGlzOwoJfTsKCi8vCUhlbHBlcnMKLy8JLS0tLS0tLQoKLy8JSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCi8vCVNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCi8vCWNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCglCYWNrYm9uZS5leHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewoJCXZhciBwYXJlbnQgPSB0aGlzOwoJCXZhciBjaGlsZDsKCgkJLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQoJCS8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCQkvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkJaWYgKHByb3RvUHJvcHMgJiYgaGFzT3duUHJvcGVydHkuY2FsbChwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewoJCQljaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CgkJfSBlbHNlIHsKCQkJY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CgkJfQoKCQkvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KCQlfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgoJCS8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCgkJLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KCQl2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwoJCVN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwoJCWNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgoJCS8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAoJCS8vIGlmIHN1cHBsaWVkLgoJCWlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKCQkvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCgkJLy8gbGF0ZXIuCgkJY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCgkJcmV0dXJuIGNoaWxkOwoJfTsKCi8vCVRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KCXZhciB1cmxFcnJvciA9IGZ1bmN0aW9uKCkgewoJCXRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwoJfTsKCi8vCVdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgoJdmFyIHdyYXBFcnJvciA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkJdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKCQlvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewoJCQlpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCQkJbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJfTsKCX07CgovLwlDaGVja2VyIGZvciB1dGlsaXR5IG1ldGhvZHMuIFVzZWZ1bCBmb3IgY3VzdG9tIGJ1aWxkcy4KCXZhciB1dGlsRXhpc3RzID0gZnVuY3Rpb24obWV0aG9kKSB7CgkJcmV0dXJuIHR5cGVvZiBfW21ldGhvZF0gPT09ICdmdW5jdGlvbic7Cgl9OwoKCS8qIHV0aWxzICovCgoJdXRpbHMucmVzdWx0ID0gZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwgcHJvcGVydHkpIHsKCQl2YXIgdmFsdWUgPSBvYmplY3QgPyBvYmplY3RbcHJvcGVydHldIDogdW5kZWZpbmVkOwoJCXJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgPyBvYmplY3RbcHJvcGVydHldKCkgOiB2YWx1ZTsKCX07CgoJdXRpbHMuZGVmYXVsdHMgPSBmdW5jdGlvbiBkZWZhdWx0cyhvYmopIHsKCQlzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CgkJCWZvciAodmFyIGtleSBpbiBpdGVtKSBpZiAob2JqW2tleV0gPT09IHVuZGVmaW5lZCkKCQkJCW9ialtrZXldID0gaXRlbVtrZXldOwoJCX0pOwoJCXJldHVybiBvYmo7Cgl9OwoKCXV0aWxzLmV4dGVuZCA9IGZ1bmN0aW9uIGV4dGVuZChvYmopIHsKCQlzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CgkJCWZvciAodmFyIGtleSBpbiBpdGVtKSBvYmpba2V5XSA9IGl0ZW1ba2V5XTsKCQl9KTsKCQlyZXR1cm4gb2JqOwoJfTsKCgl2YXIgaHRtbEVzY2FwZXMgPSB7CgkJCScmJzogJyZhbXA7JywKCQkJJzwnOiAnJmx0OycsCgkJCSc+JzogJyZndDsnLAoJCQknIic6ICcmcXVvdDsnLAoJCQkiJyI6ICcmIzM5OycKCX07CgoJdXRpbHMuZXNjYXBlID0gZnVuY3Rpb24gZXNjYXBlKHN0cmluZykgewoJCXJldHVybiBzdHJpbmcgPT0gbnVsbCA/ICcnIDogU3RyaW5nKHN0cmluZykucmVwbGFjZSgvWyY8PiInXS9nLCBmdW5jdGlvbihtYXRjaCkgewoJCQlyZXR1cm4gaHRtbEVzY2FwZXNbbWF0Y2hdOwoJCX0pOwoJfTsKCgl1dGlscy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CgkJdmFyIGl0ZXJhdG9yID0gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nID8gdmFsdWUgOiBmdW5jdGlvbihvYmopeyByZXR1cm4gb2JqW3ZhbHVlXTsgfTsKCQlyZXR1cm4gb2JqCgkJLm1hcChmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCQkJcmV0dXJuIHsKCQkJCXZhbHVlOiB2YWx1ZSwKCQkJCWluZGV4OiBpbmRleCwKCQkJCWNyaXRlcmlhOiBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkKCQkJfTsKCQl9KQoJCS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CgkJCXZhciBhID0gbGVmdC5jcml0ZXJpYTsKCQkJdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKCQkJaWYgKGEgIT09IGIpIHsKCQkJCWlmIChhID4gYiB8fCBhID09PSB2b2lkIDApIHJldHVybiAxOwoJCQkJaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwoJCQl9CgkJCXJldHVybiBsZWZ0LmluZGV4IC0gcmlnaHQuaW5kZXg7CgkJfSkKCQkubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKCQkJcmV0dXJuIGl0ZW0udmFsdWU7CgkJfSk7Cgl9OwoKCS8qKiBVc2VkIHRvIGdlbmVyYXRlIHVuaXF1ZSBJRHMgKi8KCXZhciBpZENvdW50ZXIgPSAwOwoKCXV0aWxzLnVuaXF1ZUlkID0gZnVuY3Rpb24gdW5pcXVlSWQocHJlZml4KSB7CgkJdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKCQlyZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKCX07CgoJdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKCQkvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCgkJLy8gU2VlIHRoZSBbSGFybW9ueSBgZWdhbGAgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbCkuCgkJaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwoJCS8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KCQlpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgcmV0dXJuIGEgPT09IGI7CgkJLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCgkJLy9pZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwoJCS8vaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKCQkvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgoJCXZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwoJCWlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwoJCXN3aXRjaCAoY2xhc3NOYW1lKSB7CgkJLy8gU3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCgkJY2FzZSAnW29iamVjdCBTdHJpbmddJzoKCQkJLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCgkJCS8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCgkJCXJldHVybiBhID09IFN0cmluZyhiKTsKCQljYXNlICdbb2JqZWN0IE51bWJlcl0nOgoJCQkvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLiBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yCgkJCS8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgoJCQlyZXR1cm4gYSAhPT0gK2EgPyBiICE9PSArYiA6IChhID09PSAwID8gMSAvIGEgPT09IDEgLyBiIDogYSA9PT0gK2IpOwoJCWNhc2UgJ1tvYmplY3QgRGF0ZV0nOgoJCWNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgoJCQkvLyBDb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWVyaWMgcHJpbWl0aXZlIHZhbHVlcy4gRGF0ZXMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyCgkJCS8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKCQkJLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgoJCQlyZXR1cm4gK2EgPT0gK2I7CgkJCS8vIFJlZ0V4cHMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyIHNvdXJjZSBwYXR0ZXJucyBhbmQgZmxhZ3MuCgkJY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKCQkJcmV0dXJuIGEuc291cmNlID09IGIuc291cmNlICYmCgkJCWEuZ2xvYmFsID09IGIuZ2xvYmFsICYmCgkJCWEubXVsdGlsaW5lID09IGIubXVsdGlsaW5lICYmCgkJCWEuaWdub3JlQ2FzZSA9PSBiLmlnbm9yZUNhc2U7CgkJfQoJCWlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwoJCS8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKCQkvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KCQl2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKCQl3aGlsZSAobGVuZ3RoLS0pIHsKCQkJLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCgkJCS8vIHVuaXF1ZSBuZXN0ZWQgc3RydWN0dXJlcy4KCQkJaWYgKGFTdGFja1tsZW5ndGhdID09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PSBiOwoJCX0KCQkvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKCQkvLyBmcm9tIGRpZmZlcmVudCBmcmFtZXMgYXJlLgoJCXZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKCQlpZiAoYUN0b3IgIT09IGJDdG9yICYmICEodHlwZW9mIGFDdG9yID09PSAnZnVuY3Rpb24nICYmIChhQ3RvciBpbnN0YW5jZW9mIGFDdG9yKSAmJgoJCQkJdHlwZW9mIGJDdG9yID09PSAnZnVuY3Rpb24nICYmIChiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKSkpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQkvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCgkJYVN0YWNrLnB1c2goYSk7CgkJYlN0YWNrLnB1c2goYik7CgkJdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwoJCS8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzLgoJCWlmIChjbGFzc05hbWUgPT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCgkJCXNpemUgPSBhLmxlbmd0aDsKCQkJcmVzdWx0ID0gc2l6ZSA9PT0gYi5sZW5ndGg7CgkJCWlmIChyZXN1bHQpIHsKCQkJCS8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCgkJCQl3aGlsZSAoc2l6ZS0tKSB7CgkJCQkJaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQkvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KCQkJZm9yICh2YXIga2V5IGluIGEpIHsKCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIGtleSkpIHsKCQkJCQkvLyBDb3VudCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHByb3BlcnRpZXMuCgkJCQkJc2l6ZSsrOwoJCQkJCS8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlci4KCQkJCQlpZiAoIShyZXN1bHQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwoJCQkJfQoJCQl9CgkJCS8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgoJCQlpZiAocmVzdWx0KSB7CgkJCQlmb3IgKGtleSBpbiBiKSB7CgkJCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwoYiwga2V5KSAmJiAhKHNpemUtLSkpIGJyZWFrOwoJCQkJfQoJCQkJcmVzdWx0ID0gIXNpemU7CgkJCX0KCQl9CgkJLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCgkJYVN0YWNrLnBvcCgpOwoJCWJTdGFjay5wb3AoKTsKCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KCXV0aWxzLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CgkJcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7Cgl9OwoKCS8qIGV2ZW50cyAqLwoKCS8vIEJhY2tib25lLkV2ZW50cwoJLy8gLS0tLS0tLS0tLS0tLS0tCgoJLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAoJLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawoJLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KCS8vIHN1Y2Nlc3Npb24uCgkvLwovLwl2YXIgb2JqZWN0ID0ge307Ci8vCV8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKLy8Jb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7Ci8vCW9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKCS8vCgl2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoKCQkJLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKCQkJLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCgkJCW9uOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewoJCQkJaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKQoJCQkJCXJldHVybiB0aGlzOwoJCQkJdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CgkJCQl2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CgkJCQlldmVudHMucHVzaCh7Y2FsbGJhY2s6IGNhbGxiYWNrLCBjb250ZXh0OiBjb250ZXh0LCBjdHg6IGNvbnRleHQgfHwgdGhpc30pOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQkvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCgkJCS8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCgkJCW9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkJCQlpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykKCQkJCQlyZXR1cm4gdGhpczsKCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCXZhciByYW47CgoJCQkJdmFyIG9uY2UgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAocmFuKSByZXR1cm47CgkJCQkJcmFuID0gdHJ1ZTsKCQkJCQlzZWxmLm9mZihuYW1lLCBvbmNlKTsKCQkJCQljYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCQkJfTsKCQkJCW9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkJCQlyZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKCQkJfSwKCgkJCS8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAoJCQkvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCgkJCS8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgbmFtZWAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQKCQkJLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgoJCQlvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkJCQl2YXIgcmV0YWluLCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKCQkJCWlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKQoJCQkJCXJldHVybiB0aGlzOwoJCQkJaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewoJCQkJCXRoaXMuX2V2ZW50cyA9IHVuZGVmaW5lZDsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCgkJCQluYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBPYmplY3Qua2V5cyh0aGlzLl9ldmVudHMpOwoJCQkJZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCQkJCW5hbWUgPSBuYW1lc1tpXTsKCQkJCQlpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CgkJCQkJCXRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwoJCQkJCQlpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewoJCQkJCQkJZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKCQkJCQkJCQlldiA9IGV2ZW50c1tqXTsKCQkJCQkJCQlpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjayAmJgoJCQkJCQkJCQkJY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKCQkJCQkJCQkJCShjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CgkJCQkJCQkJCXJldGFpbi5wdXNoKGV2KTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJaWYgKCFyZXRhaW4ubGVuZ3RoKSBkZWxldGUgdGhpcy5fZXZlbnRzW25hbWVdOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCgkJCS8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQoJCQkvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQoJCQkvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCgkJCS8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCQkJdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewoJCQkJaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwoJCQkJdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkJCQlpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKCQkJCXZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07CgkJCQl2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKCQkJCWlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKCQkJCWlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQkvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCgkJCS8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCgkJCXN0b3BMaXN0ZW5pbmc6IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKCQkJCXZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwoJCQkJaWYgKCFsaXN0ZW5pbmdUbykgcmV0dXJuIHRoaXM7CgkJCQl2YXIgcmVtb3ZlID0gIW5hbWUgJiYgIWNhbGxiYWNrOwoJCQkJaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKCQkJCWlmIChvYmopIChsaXN0ZW5pbmdUbyA9IHt9KVtvYmouX2xpc3RlbklkXSA9IG9iajsKCQkJCWZvciAodmFyIGlkIGluIGxpc3RlbmluZ1RvKSB7CgkJCQkJb2JqID0gbGlzdGVuaW5nVG9baWRdOwoJCQkJCW9iai5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwoJCQkJCWlmIChyZW1vdmUgfHwgIU9iamVjdC5rZXlzKG9iai5fZXZlbnRzKS5sZW5ndGgpIHsKCQkJCQkJZGVsZXRlIHRoaXMuX2xpc3RlbmluZ1RvW2lkXTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoKCX07CgoJLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KCXZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgoJLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKCS8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCgkvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgoJdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CgkJaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKCQl2YXIgYXJyOwoKCQkvLyBIYW5kbGUgZXZlbnQgbWFwcy4KCQlpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CgkJCWZvciAodmFyIGtleSBpbiBuYW1lKSB7CgkJCQlhcnIgPSBba2V5LCBuYW1lW2tleV1dOwoJCQkJcHVzaC5hcHBseShhcnIsIHJlc3QpOwoJCQkJb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBhcnIpOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCgkJaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewoJCQl2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwoJCQlmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCQkJYXJyID0gW25hbWVzW2ldXTsKCQkJCXB1c2guYXBwbHkoYXJyLCByZXN0KTsKCQkJCW9ialthY3Rpb25dLmFwcGx5KG9iaiwgYXJyKTsKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlyZXR1cm4gdHJ1ZTsKCX07CgoJLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKCS8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKCS8vIEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KCXZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CgkJdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoLCBhMSA9IGFyZ3NbMF0sIGEyID0gYXJnc1sxXSwgYTMgPSBhcmdzWzJdOwoJCXN3aXRjaCAoYXJncy5sZW5ndGgpIHsKCQljYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsgcmV0dXJuOwoJCWNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwoJCWNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKCQljYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKTsgcmV0dXJuOwoJCWRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CgkJfQoJfTsKCgl2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKCS8vIEludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb25zIG9mIGBvbmAgYW5kIGBvbmNlYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvCgkvLyBsaXN0ZW4gdG8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzCgkvLyBsaXN0ZW5pbmcgdG8uCglPYmplY3Qua2V5cyhsaXN0ZW5NZXRob2RzKS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewoJCXZhciBpbXBsZW1lbnRhdGlvbiA9IGxpc3Rlbk1ldGhvZHNbbWV0aG9kXTsKCQlFdmVudHNbbWV0aG9kXSA9IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKCQkJdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG8gfHwgKHRoaXMuX2xpc3RlbmluZ1RvID0ge30pOwoJCQl2YXIgaWQgPSBvYmouX2xpc3RlbklkIHx8IChvYmouX2xpc3RlbklkID0gXy51bmlxdWVJZCgnbCcpKTsKCQkJbGlzdGVuaW5nVG9baWRdID0gb2JqOwoJCQlpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwoJCQlvYmpbaW1wbGVtZW50YXRpb25dKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCQkJcmV0dXJuIHRoaXM7CgkJfTsKCX0pOwoKCS8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoJRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKCUV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwoKCS8qIHJvdXRlciAqLwoKCS8vIEJhY2tib25lLlJvdXRlcgoJLy8gLS0tLS0tLS0tLS0tLS0tCgoJLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKCS8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCgl2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCW9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkJaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwoJCXRoaXMuX2JpbmRSb3V0ZXMoKTsKCQl0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAoJLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KCXZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwoJdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKCXZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7Cgl2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKCXZhciBpc1JlZ0V4cCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJcmV0dXJuIHZhbHVlID8gKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nKSA6IGZhbHNlOwoJfTsKCgkvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KCV8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKCQkvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCQkvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCQlpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgoJCS8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CgkJLy8KCQkvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CgkJLy8gICAgICAgLi4uCgkJLy8gICAgIH0pOwoJCS8vCgkJcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewoJCQlpZiAoIWlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKCQkJaWYgKHR5cGVvZiBuYW1lID09PSAnZnVuY3Rpb24nKSB7CgkJCQljYWxsYmFjayA9IG5hbWU7CgkJCQluYW1lID0gJyc7CgkJCX0KCQkJaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwoJCQl2YXIgcm91dGVyID0gdGhpczsKCQkJQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgZnVuY3Rpb24oZnJhZ21lbnQpIHsKCQkJCXZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwoJCQkJcm91dGVyLmV4ZWN1dGUoY2FsbGJhY2ssIGFyZ3MpOwoJCQkJcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoJCQkJcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CgkJCQlCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKCQkJfSk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vIEV4ZWN1dGUgYSByb3V0ZSBoYW5kbGVyIHdpdGggdGhlIHByb3ZpZGVkIHBhcmFtZXRlcnMuICBUaGlzIGlzIGFuCgkJLy8gZXhjZWxsZW50IHBsYWNlIHRvIGRvIHByZS1yb3V0ZSBzZXR1cCBvciBwb3N0LXJvdXRlIGNsZWFudXAuCgkJZXhlY3V0ZTogZnVuY3Rpb24oY2FsbGJhY2ssIGFyZ3MpIHsKCQkJaWYgKGNhbGxiYWNrKSBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKCQl9LAoKCQkvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgoJCW5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewoJCQlCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCgkJLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAoJCS8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCgkJX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CgkJCXRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwoJCQl2YXIgcm91dGUsIHJvdXRlcyA9IE9iamVjdC5rZXlzKHRoaXMucm91dGVzKTsKCQkJd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewoJCQkJdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKCQkJfQoJCX0sCgoJCS8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCgkJLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgoJCV9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewoJCQlyb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCgkJCS5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKCQkJLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24obWF0Y2gsIG9wdGlvbmFsKSB7CgkJCQlyZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW14vP10rKSc7CgkJCX0pCgkJCS5yZXBsYWNlKHNwbGF0UGFyYW0sICcoW14/XSo/KScpOwoJCQlyZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICcoPzpcXD8oW1xcc1xcU10qKSk/JCcpOwoJCX0sCgoJCS8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKCQkvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCgkJLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCgkJX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbihyb3V0ZSwgZnJhZ21lbnQpIHsKCQkJdmFyIHBhcmFtcyA9IHJvdXRlLmV4ZWMoZnJhZ21lbnQpLnNsaWNlKDEpOwoJCQlyZXR1cm4gcGFyYW1zLm1hcChmdW5jdGlvbihwYXJhbSwgaSkgewoJCQkJLy8gRG9uJ3QgZGVjb2RlIHRoZSBzZWFyY2ggcGFyYW1zLgoJCQkJaWYgKGkgPT09IHBhcmFtcy5sZW5ndGggLSAxKSByZXR1cm4gcGFyYW0gfHwgbnVsbDsKCQkJCXJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwoJCQl9KTsKCQl9CgoJfSk7CgoJLyogaGlzdG9yeSAqLwoKCS8vIEJhY2tib25lLkhpc3RvcnkKCS8vIC0tLS0tLS0tLS0tLS0tLS0KCgkvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBlaXRoZXIKCS8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgoJLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKCS8vIGFuZCBVUkwgZnJhZ21lbnRzLgoJdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5oYW5kbGVycyA9IFtdOwoJCXRoaXMuY2hlY2tVcmwgPSB0aGlzLmNoZWNrVXJsLmJpbmQodGhpcyk7CgoJCS8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgoJCWlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwoJCQl0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKCQl9Cgl9OwoKCS8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KCXZhciByb3V0ZVN0cmlwcGVyID0gL15bI1wvXXxccyskL2c7CgoJLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KCXZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgoJLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgoJdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCgkvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2ggYW5kIHF1ZXJ5LgoJdmFyIHBhdGhTdHJpcHBlciA9IC9bI10uKiQvOwoKCS8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KCUhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKCS8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KCV8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCgkJLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KCQlhdFJvb3Q6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5sb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKCQl9LAoKCQkvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCgkJLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCgkJZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CgkJCXZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CgkJCXJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CgkJfSwKCgkJLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAoJCS8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCgkJZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewoJCQlpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewoJCQkJaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCQkJCQlmcmFnbWVudCA9IGRlY29kZVVSSSh0aGlzLmxvY2F0aW9uLnBhdGhuYW1lICsgdGhpcy5sb2NhdGlvbi5zZWFyY2gpOwoJCQkJCXZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwoJCQkJCWlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zbGljZShyb290Lmxlbmd0aCk7CgkJCQl9IGVsc2UgewoJCQkJCWZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwoJCX0sCgoJCS8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwoJCS8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCgkJc3RhcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkJaWYgKEhpc3Rvcnkuc3RhcnRlZCkgdGhyb3cgbmV3IEVycm9yKCJCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCIpOwoJCQlIaXN0b3J5LnN0YXJ0ZWQgPSB0cnVlOwoKCQkJLy8gRmlndXJlIG91dCB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uLgoJCQkvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCBvciBzaG91bGQgd2UgdXNlIGhhc2hjaGFuZ2Ugb25seT8KCQkJdGhpcy5vcHRpb25zICAgICAgICAgID0gXy5leHRlbmQoe3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CgkJCXRoaXMucm9vdCAgICAgICAgICAgICA9IHRoaXMub3B0aW9ucy5yb290OwoJCQl0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CgkJCXRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKCQkJdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwoKCQkJLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4KCQkJdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7CgoJCQkvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBkZXRlcm1pbmUgaG93IHdlCgkJCS8vIGNoZWNrIHRoZSBVUkwgc3RhdGUuCgkJCWlmICh0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoJCQkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCwgZmFsc2UpOwoJCQl9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJCQkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsLCBmYWxzZSk7CgkJCX0KCgkJCS8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCgkJCS8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KCQkJdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoJCQl2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKCgkJCS8vIFRyYW5zaXRpb24gZnJvbSBoYXNoQ2hhbmdlIHRvIHB1c2hTdGF0ZSBvciB2aWNlIHZlcnNhIGlmIGJvdGggYXJlCgkJCS8vIHJlcXVlc3RlZC4KCQkJaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoKCQkJCS8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CgkJCQkvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgoJCQkJaWYgKHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKCQkJCQl0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CgkJCQkJdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQpOwoJCQkJfQoKCQkJfQoKCQkJaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CgkJfSwKCgkJLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCgkJLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCgkJc3RvcDogZnVuY3Rpb24oKSB7CgkJCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwoJCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwoJCQlIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCQl9LAoKCQkvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCgkJLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KCQlyb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CgkJCXRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKCQl9LAoKCQkvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKCQkvLyBjYWxscyBgbG9hZFVybGAuCgkJY2hlY2tVcmw6IGZ1bmN0aW9uKCkgewoJCQl2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKCQkJaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKCQkJdGhpcy5sb2FkVXJsKCk7CgkJfSwKCgkJLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKCQkvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAoJCS8vIHJldHVybnMgYGZhbHNlYC4KCQlsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewoJCQlmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKCQkJcmV0dXJuIHRoaXMuaGFuZGxlcnMuc29tZShmdW5jdGlvbihoYW5kbGVyKSB7CgkJCQlpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewoJCQkJCWhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCgkJLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwoJCS8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgoJCS8vCgkJLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQoJCS8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCgkJLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KCQluYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCQkJaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKCQkJaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogISFvcHRpb25zfTsKCgkJCXZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CgoJCQkvLyBTdHJpcCB0aGUgaGFzaCBmb3IgbWF0Y2hpbmcuCgkJCWZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCgkJCWlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwoJCQl0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgoJCQkvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCgkJCWlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgoJCQkvLyBJZiB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KCQkJaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CgkJCQl0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKCQkJCS8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCgkJCQkvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgoJCQl9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJCQkJdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKCQkJCS8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQoJCQkJLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKCQkJfQoJCQlpZiAob3B0aW9ucy50cmlnZ2VyKSByZXR1cm4gdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKCQl9LAoKCQkvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwoJCS8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgoJCV91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKCQkJaWYgKHJlcGxhY2UpIHsKCQkJCXZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CgkJCQlsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CgkJCX0gZWxzZSB7CgkJCQkvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCgkJCQlsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7CgkJCX0KCQl9CgoJfSk7CgoJLyogZm9vdGVyICovCgoJLy8gISEhCgkvLyBJbml0LgoJWydNb2RlbCcsICdDb2xsZWN0aW9uJywgJ1JvdXRlcicsICdWaWV3JywgJ0hpc3RvcnknXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKCQl2YXIgaXRlbSA9IEJhY2tib25lW25hbWVdOwoJCWlmIChpdGVtKSBpdGVtLmV4dGVuZCA9IEJhY2tib25lLmV4dGVuZDsKCX0pOwoKCS8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KCS8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KCV8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwoKCS8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5IGlmIHRoZSBIaXN0b3J5IG1vZHVsZSBpcyBpbmNsdWRlZC4KCWlmIChIaXN0b3J5KSBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3RvcnkoKTsKCXJldHVybiBCYWNrYm9uZTsKfSk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 05:16:17 GMT",
                    "Content-Length": "26496",
                    "Date": "Sat, 08 Nov 2014 05:16:17 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}