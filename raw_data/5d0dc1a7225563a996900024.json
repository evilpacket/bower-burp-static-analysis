{
    "url": "http://localhost:9999/ddmal/diva.js/build/js/utils.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.hash</b> and written to <b>window.location.replace()</b> via the following statements:<ul><li>var hash = window.location.hash;</li><li>window.location.replace(hash + '&amp;' + key + '=' + value);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ddmal/diva.js/build/js/utils.js",
                "path": "/ddmal/diva.js/build/js/utils.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kZG1hbC9kaXZhLmpzL2J1aWxkL2pzL3V0aWxzLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjkxNjUNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMjE6NDQ6MDUgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDIxOjQ0OjA0IEdNVA0KDQovLyBTb21lIHNpbXBsZSB1dGlsaXR5IG1ldGhvZHMgZm9yIHdlYiBzdG9yYWdlIChlLmcuLCBsb2NhbFN0b3JhZ2UpClN0b3JhZ2UucHJvdG90eXBlLnNldE9iamVjdCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICB0aGlzLnNldEl0ZW0oa2V5LCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpOwp9OwoKU3RvcmFnZS5wcm90b3R5cGUuZ2V0T2JqZWN0ID0gZnVuY3Rpb24gKGtleSkgewogICAgdmFyIHZhbHVlID0gdGhpcy5nZXRJdGVtKGtleSk7CiAgICByZXR1cm4gdmFsdWUgJiYgSlNPTi5wYXJzZSh2YWx1ZSk7Cn07CgovLyBmcm9tIGh0dHA6Ly9mb3Jyc3QuY29tL3Bvc3RzL2pRdWVyeV9lbGVtZW50X0lEX2dlbmVyYXRvci1Sb00KKGZ1bmN0aW9uICgkKSB7CiAgICB2YXIgY291bnRlciA9IDE7CiAgICAkLmdlbmVyYXRlSWQgPSBmdW5jdGlvbihzdWZmaXgpIHsKICAgICAgICB2YXIgZ2VuZXJhdGVkSWQ7CiAgICAgICAgZG8gewogICAgICAgICAgICBnZW5lcmF0ZWRJZCA9IChjb3VudGVyKyspICsgKHN1ZmZpeCA/ICctJyArIHN1ZmZpeCA6ICcnKTsKICAgICAgICB9IHdoaWxlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGdlbmVyYXRlZElkKSk7CgogICAgICAgIHJldHVybiBnZW5lcmF0ZWRJZDsKICAgIH07Cn0pKGpRdWVyeSk7CgovLyBGcm9tIGh0dHA6Ly93d3cuYWxleGFuZHJlLWdvbWVzLmNvbS8/cD0xMTUsIG1vZGlmaWVkIHNsaWdodGx5CihmdW5jdGlvbiAoJCkgewogICAgJC5nZXRTY3JvbGxiYXJXaWR0aCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTsKICAgICAgICBpbm5lci5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICBpbm5lci5zdHlsZS5oZWlnaHQgPSAnMjAwcHgnOwoKICAgICAgICB2YXIgb3V0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBvdXRlci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgb3V0ZXIuc3R5bGUudG9wID0gJzBweCc7CiAgICAgICAgb3V0ZXIuc3R5bGUubGVmdCA9ICcwcHgnOwogICAgICAgIG91dGVyLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgICAgICBvdXRlci5zdHlsZS53aWR0aCA9ICcyMDBweCc7CiAgICAgICAgb3V0ZXIuc3R5bGUuaGVpZ2h0ID0gJzE1MHB4JzsKICAgICAgICBvdXRlci5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwogICAgICAgIG91dGVyLmFwcGVuZENoaWxkKGlubmVyKTsKCiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChvdXRlcik7CgogICAgICAgIHZhciB3MSA9IGlubmVyLm9mZnNldFdpZHRoOwogICAgICAgIG91dGVyLnN0eWxlLm92ZXJmbG93ID0gJ3Njcm9sbCc7CiAgICAgICAgdmFyIHcyID0gaW5uZXIub2Zmc2V0V2lkdGg7CiAgICAgICAgaWYgKHcxID09IHcyKSB7CiAgICAgICAgICAgIHcyID0gb3V0ZXIuY2xpZW50V2lkdGg7IC8vIGZvciBJRSBpIHRoaW5rCiAgICAgICAgfQoKICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKG91dGVyKTsKICAgICAgICByZXR1cm4gdzEgLSB3MjsKICAgIH07Cn0pKGpRdWVyeSk7CgovLyBGb3IgZ2V0dGluZyB0aGUgI2tleSB2YWx1ZXMgZnJvbSB0aGUgVVJMLiBGb3Igc3BlY2lmeWluZyBhIHBhZ2UgYW5kIHpvb20gbGV2ZWwKLy8gTG9vayBpbnRvIGNhY2hpbmcsIGJlY2F1c2Ugd2Ugb25seSBuZWVkIHRvIGdldCB0aGlzIGR1cmluZyB0aGUgaW5pdGlhbCBsb2FkCi8vIEFsdGhvdWdoIGZvciB0aGUgdGVzdHMgSSBndWVzcyB3ZSB3b3VsZCBuZWVkIHRvIG92ZXJyaWRlIGNhY2hpbmcgc29tZWhvdwooZnVuY3Rpb24gKCQpIHsKICAgICQuZ2V0SGFzaFBhcmFtID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdmFyIGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDsKICAgICAgICBpZiAoaGFzaCAhPT0gJycpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlcmUgaXMgc29tZXRoaW5nIHRoYXQgbG9va3MgbGlrZSBlaXRoZXIgJmtleT0gb3IgI2tleT0KICAgICAgICAgICAgdmFyIHN0YXJ0SW5kZXggPSAoaGFzaC5pbmRleE9mKCcmJyArIGtleSArICc9JykgPiAwKSA/IGhhc2guaW5kZXhPZignJicgKyBrZXkgKyAnPScpIDogaGFzaC5pbmRleE9mKCcjJyArIGtleSArICc9Jyk7CgogICAgICAgICAgICAvLyBJZiBzdGFydEluZGV4IGlzIHN0aWxsIC0xLCBpdCBtZWFucyBpdCBjYW4ndCBmaW5kIGVpdGhlcgogICAgICAgICAgICBpZiAoc3RhcnRJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBBZGQgdGhlIGxlbmd0aCBvZiB0aGUga2V5IHBsdXMgdGhlICYgYW5kID0KICAgICAgICAgICAgICAgIHN0YXJ0SW5kZXggKz0ga2V5Lmxlbmd0aCArIDI7CgogICAgICAgICAgICAgICAgLy8gRWl0aGVyIHRvIHRoZSBuZXh0IGFtcGVyc2FuZCBvciB0byB0aGUgZW5kIG9mIHRoZSBzdHJpbmcKICAgICAgICAgICAgICAgIHZhciBlbmRJbmRleCA9IGhhc2guaW5kZXhPZignJicsIHN0YXJ0SW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKGVuZEluZGV4ID4gc3RhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNoLnN1YnN0cmluZyhzdGFydEluZGV4LCBlbmRJbmRleCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVuZEluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbWVhbnMgdGhpcyBoYXNoIHBhcmFtIGlzIHRoZSBsYXN0IG9uZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNoLnN1YnN0cmluZyhzdGFydEluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElmIHRoZSBrZXkgZG9lc24ndCBoYXZlIGEgdmFsdWUgSSB0aGluawogICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSWYgaXQgY2FuJ3QgZmluZCB0aGUga2V5CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gaGFzaCBwYXJhbXMganVzdCByZXR1cm4gZmFsc2UKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH07Cn0pKGpRdWVyeSk7CgooZnVuY3Rpb24gKCQpIHsKICAgICQudXBkYXRlSGFzaFBhcmFtID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIC8vIEZpcnN0IG1ha2Ugc3VyZSB0aGF0IHdlIGhhdmUgdG8gZG8gYW55IHdvcmsgYXQgYWxsCiAgICAgICAgdmFyIG9yaWdpbmFsVmFsdWUgPSAkLmdldEhhc2hQYXJhbShrZXkpOwogICAgICAgIHZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7CiAgICAgICAgaWYgKG9yaWdpbmFsVmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIC8vIElzIHRoZSBrZXkgYWxyZWFkeSBpbiB0aGUgVVJMPwogICAgICAgICAgICBpZiAodHlwZW9mIG9yaWdpbmFsVmFsdWUgPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIC8vIEFscmVhZHkgaW4gdGhlIFVSTC4gSnVzdCBnZXQgcmlkIG9mIHRoZSBvcmlnaW5hbCB2YWx1ZQogICAgICAgICAgICAgICAgdmFyIHN0YXJ0SW5kZXggPSAoaGFzaC5pbmRleE9mKCcmJyArIGtleSArICc9JykgPiAwKSA/IGhhc2guaW5kZXhPZignJicgKyBrZXkgKyAnPScpIDogaGFzaC5pbmRleE9mKCcjJyArIGtleSArICc9Jyk7CiAgICAgICAgICAgICAgICB2YXIgZW5kSW5kZXggPSBzdGFydEluZGV4ICsga2V5Lmxlbmd0aCArIDIgKyBvcmlnaW5hbFZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgIC8vICMgaWYgaXQncyB0aGUgZmlyc3QsICYgb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICB2YXIgc3RhcnRUaGluZyA9IChzdGFydEluZGV4ID09PSAwKSA/ICcjJyA6ICcmJzsKICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKGhhc2guc3Vic3RyaW5nKDAsIHN0YXJ0SW5kZXgpICsgc3RhcnRUaGluZyArIGtleSArICc9JyArIHZhbHVlICsgaGFzaC5zdWJzdHJpbmcoZW5kSW5kZXgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEl0J3Mgbm90IHByZXNlbnQgLSBhZGQgaXQKICAgICAgICAgICAgICAgIGlmIChoYXNoLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKCcjJyArIGtleSArICc9JyArIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kIGl0CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UoaGFzaCArICcmJyArIGtleSArICc9JyArIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKGpRdWVyeSk7CgovKgogKiBqUXVlcnkgZHJhZ3Njcm9sbGFibGUgUGx1Z2luCiAqIHZlcnNpb246IDEuMCAoMjUtSnVuLTIwMDkpCiAqIENvcHlyaWdodCAoYykgMjAwOSBNaXF1ZWwgSGVycmVyYQogKiBodHRwOi8vcGx1Z2lucy5qcXVlcnkuY29tL3Byb2plY3QvRHJhZ3Njcm9sbGFibGUKICoKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICoKICovCihmdW5jdGlvbiAoJCkgeyAvLyBzZWN1cmUgJCBqUXVlcnkgYWxpYXMKCi8qKgogKiBBZGRzIHRoZSBhYmlsaXR5IHRvIG1hbmFnZSBlbGVtZW50cyBzY3JvbGwgYnkgZHJhZ2dpbmcKICogb25lIG9yIG1vcmUgb2YgaXRzIGRlc2NlbmRhbnQgZWxlbWVudHMuIE9wdGlvbnMgcGFyYW1ldGVyCiAqIGFsbG93IHRvIHNwZWNpZmljYWxseSBzZWxlY3Qgd2hpY2ggaW5uZXIgZWxlbWVudHMgd2lsbAogKiByZXNwb25kIHRvIHRoZSBkcmFnIGV2ZW50cy4KICoKICogb3B0aW9ucyBwcm9wZXJ0aWVzOgogKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICogIGRyYWdTZWxlY3RvciAgICAgICAgIHwganF1ZXJ5IHNlbGVjdG9yIHRvIGFwcGx5IHRvIGVhY2ggd3JhcHBlZCBlbGVtZW50CiAqICAgICAgICAgICAgICAgICAgICAgICB8IHRvIGZpbmQgd2hpY2ggd2lsbCBiZSB0aGUgZHJhZ2dpbmcgZWxlbWVudHMuCiAqICAgICAgICAgICAgICAgICAgICAgICB8IERlZmF1bHRzIHRvICc+OmZpcnN0JyB3aGljaCBpcyB0aGUgZmlyc3QgY2hpbGQgb2YKICogICAgICAgICAgICAgICAgICAgICAgIHwgc2Nyb2xsYWJsZSBlbGVtZW50CiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogKiAgYWNjZXB0UHJvcGFnYXRlZEV2ZW50fCBXaWxsIHRoZSBkcmFnZ2luZyBlbGVtZW50IGFjY2VwdCBwcm9wYWdhdGVkCiAqICAgICAgICAgICAgICAgICAgICAgICB8IGV2ZW50cz8gZGVmYXVsdCBpcyB5ZXMsIGEgcHJvcGFnYXRlZCBtb3VzZSBldmVudAogKiAgICAgICAgICAgICAgICAgICAgICAgfCBvbiBhIGlubmVyIGVsZW1lbnQgd2lsbCBiZSBhY2NlcHRlZCBhbmQgcHJvY2Vzc2VkLgogKiAgICAgICAgICAgICAgICAgICAgICAgfCBJZiBzZXQgdG8gZmFsc2UsIG9ubHkgZXZlbnRzIG9yaWdpbmF0ZWQgb24gdGhlCiAqICAgICAgICAgICAgICAgICAgICAgICB8IGRyYWdnYWJsZSBlbGVtZW50cyB3aWxsIGJlIHByb2Nlc3NlZC4KICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAqICBwcmV2ZW50RGVmYXVsdCAgICAgICB8IFByZXZlbnRzIHRoZSBldmVudCB0byBwcm9wYWdhdGUgZnVydGhlciBlZmZlY3RpdmV5CiAqICAgICAgICAgICAgICAgICAgICAgICB8IGRpc3NhYmxpbmcgb3RoZXIgZGVmYXVsdCBhY3Rpb25zLiBEZWZhdWx0cyB0byB0cnVlCiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogKgogKiAgdXNhZ2UgZXhhbXBsZXM6CiAqCiAqICBUbyBhZGQgdGhlIHNjcm9sbCBieSBkcmFnIHRvIHRoZSBlbGVtZW50IGlkPXZpZXdwb3J0IHdoZW4gZHJhZ2dpbmcgaXRzCiAqICBmaXJzdCBjaGlsZCBhY2NlcHRpbmcgYW55IHByb3BhZ2F0ZWQgZXZlbnRzCiAqICAkKCcjdmlld3BvcnQnKS5kcmFnc2Nyb2xsYWJsZSgpOwogKgogKiAgVG8gYWRkIHRoZSBzY3JvbGwgYnkgZHJhZyBhYmlsaXR5IHRvIGFueSBlbGVtZW50IGRpdiBvZiBjbGFzcyB2aWV3cG9ydAogKiAgd2hlbiBkcmFnZ2luZyBpdHMgZmlyc3QgZGVzY2VuZGFudCBvZiBjbGFzcyBkcmFnTWUgcmVzcG9uZGluZyBvbmx5IHRvCiAqICBldmNlbnRzIG9yaWdpbmF0ZWQgb24gdGhlICcuZHJhZ01lJyBlbGVtZW50cy4KICogICQoJ2Rpdi52aWV3cG9ydCcpLmRyYWdzY3JvbGxhYmxlKHtkcmFnU2VsZWN0b3I6Jy5kcmFnTWU6Zmlyc3QnLAogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY2VwdFByb3BhZ2F0ZWRFdmVudDogZmFsc2V9KTsKICoKICogIE5vdGljZSB0aGF0IHNvbWUgJ3ZpZXdwb3J0cycgY291bGQgYmUgbmVzdGVkIHdpdGhpbiBvdGhlcnMgYnV0IGV2ZW50cwogKiAgd291bGQgbm90IGludGVyZmVyZSBhcyBhY2NlcHRQcm9wYWdhdGVkRXZlbnQgaXMgc2V0IHRvIGZhbHNlLgogKgogKi8KJC5mbi5kcmFnc2Nyb2xsYWJsZSA9IGZ1bmN0aW9uKCBvcHRpb25zICl7CgogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoCiAgICAgICAgewogICAgICAgICAgICBkcmFnU2VsZWN0b3I6Jz46Zmlyc3QnLAogICAgICAgICAgICBhY2NlcHRQcm9wYWdhdGVkRXZlbnQ6IHRydWUsCiAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiB0cnVlCiAgICAgICAgfSxvcHRpb25zIHx8IHt9KTsKCgogICAgdmFyIGRyYWdzY3JvbGw9IHsKICAgICAgICBtb3VzZURvd25IYW5kbGVyIDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgLy8gbW91c2Vkb3duLCBsZWZ0IGNsaWNrLCBjaGVjayBwcm9wYWdhdGlvbgogICAgICAgICAgICBpZiAoZXZlbnQud2hpY2ghPTEgfHwKICAgICAgICAgICAgICAgICghZXZlbnQuZGF0YS5hY2NlcHRQcm9wYWdhdGVkRXZlbnQgJiYgZXZlbnQudGFyZ2V0ICE9IHRoaXMpKXsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSW5pdGlhbCBjb29yZGluYXRlcyB3aWxsIGJlIHRoZSBsYXN0IHdoZW4gZHJhZ2dpbmcKICAgICAgICAgICAgZXZlbnQuZGF0YS5sYXN0Q29vcmQgPSB7bGVmdDogZXZlbnQuY2xpZW50WCwgdG9wOiBldmVudC5jbGllbnRZfTsKCiAgICAgICAgICAgICQuZXZlbnQuYWRkKCBkb2N1bWVudCwgIm1vdXNldXAiLAogICAgICAgICAgICAgICAgICAgICAgICAgZHJhZ3Njcm9sbC5tb3VzZVVwSGFuZGxlciwgZXZlbnQuZGF0YSApOwogICAgICAgICAgICAkLmV2ZW50LmFkZCggZG9jdW1lbnQsICJtb3VzZW1vdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgZHJhZ3Njcm9sbC5tb3VzZU1vdmVIYW5kbGVyLCBldmVudC5kYXRhICk7CiAgICAgICAgICAgIGlmIChldmVudC5kYXRhLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBtb3VzZU1vdmVIYW5kbGVyIDogZnVuY3Rpb24oZXZlbnQpIHsgLy8gVXNlciBpcyBkcmFnZ2luZwogICAgICAgICAgICAvLyBIb3cgbXVjaCBkaWQgdGhlIG1vdXNlIG1vdmU/CiAgICAgICAgICAgIHZhciBkZWx0YSA9IHtsZWZ0OiAoZXZlbnQuY2xpZW50WCAtIGV2ZW50LmRhdGEubGFzdENvb3JkLmxlZnQpLAogICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAoZXZlbnQuY2xpZW50WSAtIGV2ZW50LmRhdGEubGFzdENvb3JkLnRvcCl9OwoKICAgICAgICAgICAgLy8gU2V0IHRoZSBzY3JvbGwgcG9zaXRpb24gcmVsYXRpdmUgdG8gd2hhdCBldmVyIHRoZSBzY3JvbGwgaXMgbm93CiAgICAgICAgICAgIGV2ZW50LmRhdGEuc2Nyb2xsYWJsZS5zY3JvbGxMZWZ0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGF0YS5zY3JvbGxhYmxlLnNjcm9sbExlZnQoKSAtIGRlbHRhLmxlZnQpOwogICAgICAgICAgICBldmVudC5kYXRhLnNjcm9sbGFibGUuc2Nyb2xsVG9wKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGF0YS5zY3JvbGxhYmxlLnNjcm9sbFRvcCgpIC0gZGVsdGEudG9wKTsKCiAgICAgICAgICAgIC8vIFNhdmUgd2hlcmUgdGhlIGN1cnNvciBpcwogICAgICAgICAgICBldmVudC5kYXRhLmxhc3RDb29yZD17bGVmdDogZXZlbnQuY2xpZW50WCwgdG9wOiBldmVudC5jbGllbnRZfTsKICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKICAgICAgICBtb3VzZVVwSGFuZGxlciA6IGZ1bmN0aW9uKGV2ZW50KSB7IC8vIFN0b3Agc2Nyb2xsaW5nCiAgICAgICAgICAgICQuZXZlbnQucmVtb3ZlKCBkb2N1bWVudCwgIm1vdXNlbW92ZSIsIGRyYWdzY3JvbGwubW91c2VNb3ZlSGFuZGxlcik7CiAgICAgICAgICAgICQuZXZlbnQucmVtb3ZlKCBkb2N1bWVudCwgIm1vdXNldXAiLCBkcmFnc2Nyb2xsLm1vdXNlVXBIYW5kbGVyKTsKICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8vIHNldCB1cCB0aGUgaW5pdGlhbCBldmVudHMKICAgIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAvLyBjbG9zdXJlIG9iamVjdCBkYXRhIGZvciBlYWNoIHNjcm9sbGFibGUgZWxlbWVudAogICAgICAgIHZhciBkYXRhID0ge3Njcm9sbGFibGUgOiAkKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIGFjY2VwdFByb3BhZ2F0ZWRFdmVudCA6IHNldHRpbmdzLmFjY2VwdFByb3BhZ2F0ZWRFdmVudCwKICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdCA6IHNldHRpbmdzLnByZXZlbnREZWZhdWx0IH07CiAgICAgICAgLy8gU2V0IG1vdXNlIGluaXRpYXRpbmcgZXZlbnQgb24gdGhlIGRlc2lyZWQgZGVzY2VuZGFudAogICAgICAgICQodGhpcykuZmluZChzZXR0aW5ncy5kcmFnU2VsZWN0b3IpLgogICAgICAgICAgICAgICAgICAgICAgICBiaW5kKCdtb3VzZWRvd24nLCBkYXRhLCBkcmFnc2Nyb2xsLm1vdXNlRG93bkhhbmRsZXIpOwogICAgfSk7Cn07IC8vZW5kIHBsdWdpbiBkcmFnc2Nyb2xsYWJsZQoKfSkoIGpRdWVyeSApOyAvLyBjb25maW5lIHNjb3BlCgovKiEKICAgIGpRdWVyeS5raW5ldGljIHYxLjguMgogICAgRGF2ZSBUYXlsb3IgaHR0cDovL3RoZS10YXlsb3JzLm9yZy9qcXVlcnkua2luZXRpYwoKICAgIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogICAgQ29weXJpZ2h0IChjKSA8MjAxMT4gPERhdmUgVGF5bG9yIGh0dHA6Ly90aGUtdGF5bG9ycy5vcmc+CiovCi8qZ2xvYmFsIGRlZmluZSxyZXF1aXJlICovCihmdW5jdGlvbigkKXsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICB2YXIgREVGQVVMVF9TRVRUSU5HUyA9IHsKICAgICAgICAgICAgY3Vyc29yOiAnbW92ZScsCiAgICAgICAgICAgIGRlY2VsZXJhdGU6IHRydWUsCiAgICAgICAgICAgIHRyaWdnZXJIYXJkd2FyZTogZmFsc2UsCiAgICAgICAgICAgIHk6IHRydWUsCiAgICAgICAgICAgIHg6IHRydWUsCiAgICAgICAgICAgIHNsb3dkb3duOiAwLjksCiAgICAgICAgICAgIG1heHZlbG9jaXR5OiA0MCwKICAgICAgICAgICAgdGhyb3R0bGVGUFM6IDYwLAogICAgICAgICAgICBtb3ZpbmdDbGFzczogewogICAgICAgICAgICAgICAgdXA6ICdraW5ldGljLW1vdmluZy11cCcsCiAgICAgICAgICAgICAgICBkb3duOiAna2luZXRpYy1tb3ZpbmctZG93bicsCiAgICAgICAgICAgICAgICBsZWZ0OiAna2luZXRpYy1tb3ZpbmctbGVmdCcsCiAgICAgICAgICAgICAgICByaWdodDogJ2tpbmV0aWMtbW92aW5nLXJpZ2h0JwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWNlbGVyYXRpbmdDbGFzczogewogICAgICAgICAgICAgICAgdXA6ICdraW5ldGljLWRlY2VsZXJhdGluZy11cCcsCiAgICAgICAgICAgICAgICBkb3duOiAna2luZXRpYy1kZWNlbGVyYXRpbmctZG93bicsCiAgICAgICAgICAgICAgICBsZWZ0OiAna2luZXRpYy1kZWNlbGVyYXRpbmctbGVmdCcsCiAgICAgICAgICAgICAgICByaWdodDogJ2tpbmV0aWMtZGVjZWxlcmF0aW5nLXJpZ2h0JwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBTRVRUSU5HU19LRVkgPSAna2luZXRpYy1zZXR0aW5ncycsCiAgICAgICAgQUNUSVZFX0NMQVNTID0gJ2tpbmV0aWMtYWN0aXZlJzsKICAgIC8qKgogICAgICogUHJvdmlkZXMgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIGluIGEgY3Jvc3MgYnJvd3NlciB3YXkuCiAgICAgKiBodHRwOi8vcGF1bGlyaXNoLmNvbS8yMDExL3JlcXVlc3RhbmltYXRpb25mcmFtZS1mb3Itc21hcnQtYW5pbWF0aW5nLwogICAgICovCiAgICBpZiAoICF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lICkgewoKICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gKCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHJldHVybiB3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgd2luZG93Lm9SZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgd2luZG93Lm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIGZ1bmN0aW9uKCAvKiBmdW5jdGlvbiBGcmFtZVJlcXVlc3RDYWxsYmFjayAqLyBjYWxsYmFjaywgLyogRE9NRWxlbWVudCBFbGVtZW50ICovIGVsZW1lbnQgKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCggY2FsbGJhY2ssIDEwMDAgLyA2MCApOwogICAgICAgICAgICB9OwoKICAgICAgICB9KCkpOwoKICAgIH0KCiAgICAvLyBhZGQgdG91Y2ggY2hlY2tlciB0byBqUXVlcnkuc3VwcG9ydAogICAgJC5zdXBwb3J0ID0gJC5zdXBwb3J0IHx8IHt9OwogICAgJC5leHRlbmQoJC5zdXBwb3J0LCB7CiAgICAgICAgdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAogICAgfSk7CiAgICB2YXIgc2VsZWN0U3RhcnQgPSBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9OwoKICAgIHZhciBkZWNlbGVyYXRlVmVsb2NpdHkgPSBmdW5jdGlvbih2ZWxvY2l0eSwgc2xvd2Rvd24pIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLmFicyh2ZWxvY2l0eSkpID09PSAwID8gMCAvLyBpcyB2ZWxvY2l0eSBsZXNzIHRoYW4gMT8KICAgICAgICAgICAgICAgOiB2ZWxvY2l0eSAqIHNsb3dkb3duOyAvLyByZWR1Y2Ugc2xvd2Rvd24KICAgIH07CgogICAgdmFyIGNhcFZlbG9jaXR5ID0gZnVuY3Rpb24odmVsb2NpdHksIG1heCkgewogICAgICAgIHZhciBuZXdWZWxvY2l0eSA9IHZlbG9jaXR5OwogICAgICAgIGlmICh2ZWxvY2l0eSA+IDApIHsKICAgICAgICAgICAgaWYgKHZlbG9jaXR5ID4gbWF4KSB7CiAgICAgICAgICAgICAgICBuZXdWZWxvY2l0eSA9IG1heDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSA8ICgwIC0gbWF4KSkgewogICAgICAgICAgICAgICAgbmV3VmVsb2NpdHkgPSAoMCAtIG1heCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1ZlbG9jaXR5OwogICAgfTsKCiAgICB2YXIgc2V0TW92ZUNsYXNzZXMgPSBmdW5jdGlvbihzZXR0aW5ncywgY2xhc3NlcykgewogICAgICAgIHRoaXMucmVtb3ZlQ2xhc3Moc2V0dGluZ3MubW92aW5nQ2xhc3MudXApCiAgICAgICAgICAgIC5yZW1vdmVDbGFzcyhzZXR0aW5ncy5tb3ZpbmdDbGFzcy5kb3duKQogICAgICAgICAgICAucmVtb3ZlQ2xhc3Moc2V0dGluZ3MubW92aW5nQ2xhc3MubGVmdCkKICAgICAgICAgICAgLnJlbW92ZUNsYXNzKHNldHRpbmdzLm1vdmluZ0NsYXNzLnJpZ2h0KQogICAgICAgICAgICAucmVtb3ZlQ2xhc3Moc2V0dGluZ3MuZGVjZWxlcmF0aW5nQ2xhc3MudXApCiAgICAgICAgICAgIC5yZW1vdmVDbGFzcyhzZXR0aW5ncy5kZWNlbGVyYXRpbmdDbGFzcy5kb3duKQogICAgICAgICAgICAucmVtb3ZlQ2xhc3Moc2V0dGluZ3MuZGVjZWxlcmF0aW5nQ2xhc3MubGVmdCkKICAgICAgICAgICAgLnJlbW92ZUNsYXNzKHNldHRpbmdzLmRlY2VsZXJhdGluZ0NsYXNzLnJpZ2h0KTsKCiAgICAgICAgaWYgKHNldHRpbmdzLnZlbG9jaXR5ID4gMCkgewogICAgICAgICAgICB0aGlzLmFkZENsYXNzKGNsYXNzZXMucmlnaHQpOwogICAgICAgIH0KICAgICAgICBpZiAoc2V0dGluZ3MudmVsb2NpdHkgPCAwKSB7CiAgICAgICAgICAgIHRoaXMuYWRkQ2xhc3MoY2xhc3Nlcy5sZWZ0KTsKICAgICAgICB9CiAgICAgICAgaWYgKHNldHRpbmdzLnZlbG9jaXR5WSA+IDApIHsKICAgICAgICAgICAgdGhpcy5hZGRDbGFzcyhjbGFzc2VzLmRvd24pOwogICAgICAgIH0KICAgICAgICBpZiAoc2V0dGluZ3MudmVsb2NpdHlZIDwgMCkgewogICAgICAgICAgICB0aGlzLmFkZENsYXNzKGNsYXNzZXMudXApOwogICAgICAgIH0KCiAgICB9OwoKICAgIHZhciBzdG9wID0gZnVuY3Rpb24oJHNjcm9sbGVyLCBzZXR0aW5ncykgewogICAgICAgIHNldHRpbmdzLnZlbG9jaXR5ID0gMDsKICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eVkgPSAwOwogICAgICAgIHNldHRpbmdzLmRlY2VsZXJhdGUgPSB0cnVlOwogICAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3Muc3RvcHBlZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBzZXR0aW5ncy5zdG9wcGVkLmNhbGwoJHNjcm9sbGVyLCBzZXR0aW5ncyk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKiogZG8gdGhlIGFjdHVhbCBraW5ldGljIG1vdmVtZW50ICovCiAgICB2YXIgbW92ZSA9IGZ1bmN0aW9uKCRzY3JvbGxlciwgc2V0dGluZ3MpIHsKICAgICAgICB2YXIgc2Nyb2xsZXIgPSAkc2Nyb2xsZXJbMF07CiAgICAgICAgLy8gc2V0IHNjcm9sbExlZnQKICAgICAgICBpZiAoc2V0dGluZ3MueCAmJiBzY3JvbGxlci5zY3JvbGxXaWR0aCA+IDApewogICAgICAgICAgICBzY3JvbGxlci5zY3JvbGxMZWZ0ID0gc2V0dGluZ3Muc2Nyb2xsTGVmdCA9IHNjcm9sbGVyLnNjcm9sbExlZnQgKyBzZXR0aW5ncy52ZWxvY2l0eTsKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHNldHRpbmdzLnZlbG9jaXR5KSA+IDApIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5ID0gc2V0dGluZ3MuZGVjZWxlcmF0ZSA/CiAgICAgICAgICAgICAgICAgICAgZGVjZWxlcmF0ZVZlbG9jaXR5KHNldHRpbmdzLnZlbG9jaXR5LCBzZXR0aW5ncy5zbG93ZG93bikgOiBzZXR0aW5ncy52ZWxvY2l0eTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5ID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIHNldCBzY3JvbGxUb3AKICAgICAgICBpZiAoc2V0dGluZ3MueSAmJiBzY3JvbGxlci5zY3JvbGxIZWlnaHQgPiAwKXsKICAgICAgICAgICAgc2Nyb2xsZXIuc2Nyb2xsVG9wID0gc2V0dGluZ3Muc2Nyb2xsVG9wID0gc2Nyb2xsZXIuc2Nyb2xsVG9wICsgc2V0dGluZ3MudmVsb2NpdHlZOwogICAgICAgICAgICBpZiAoTWF0aC5hYnMoc2V0dGluZ3MudmVsb2NpdHlZKSA+IDApIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5WSA9IHNldHRpbmdzLmRlY2VsZXJhdGUgPwogICAgICAgICAgICAgICAgICAgIGRlY2VsZXJhdGVWZWxvY2l0eShzZXR0aW5ncy52ZWxvY2l0eVksIHNldHRpbmdzLnNsb3dkb3duKSA6IHNldHRpbmdzLnZlbG9jaXR5WTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5WSA9IDA7CiAgICAgICAgfQoKICAgICAgICBzZXRNb3ZlQ2xhc3Nlcy5jYWxsKCRzY3JvbGxlciwgc2V0dGluZ3MsIHNldHRpbmdzLmRlY2VsZXJhdGluZ0NsYXNzKTsKCiAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5tb3ZlZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBzZXR0aW5ncy5tb3ZlZC5jYWxsKCRzY3JvbGxlciwgc2V0dGluZ3MpOwogICAgICAgIH0KCiAgICAgICAgaWYgKE1hdGguYWJzKHNldHRpbmdzLnZlbG9jaXR5KSA+IDAgfHwgTWF0aC5hYnMoc2V0dGluZ3MudmVsb2NpdHlZKSA+IDApIHsKICAgICAgICAgICAgLy8gdGljayBmb3IgbmV4dCBtb3ZlbWVudAogICAgICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7IG1vdmUoJHNjcm9sbGVyLCBzZXR0aW5ncyk7IH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0b3AoJHNjcm9sbGVyLCBzZXR0aW5ncyk7CiAgICAgICAgfQogICAgfTsKCiAgICB2YXIgY2FsbE9wdGlvbiA9IGZ1bmN0aW9uKG1ldGhvZCwgb3B0aW9ucykgewogICAgICAgIHZhciBtZXRob2RGbiA9ICQua2luZXRpYy5jYWxsTWV0aG9kc1ttZXRob2RdLAogICAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKQogICAgICAgIDsKICAgICAgICBpZiAobWV0aG9kRm4pIHsKICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICB2YXIgb3B0cyA9IGFyZ3Muc2xpY2UoMSksIHNldHRpbmdzID0gJCh0aGlzKS5kYXRhKFNFVFRJTkdTX0tFWSk7CiAgICAgICAgICAgICAgICBvcHRzLnVuc2hpZnQoc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgbWV0aG9kRm4uYXBwbHkodGhpcywgb3B0cyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CgogICAgdmFyIGF0dGFjaExpc3RlbmVycyA9IGZ1bmN0aW9uKCR0aGlzLCBzZXR0aW5ncykgewogICAgICAgIHZhciBlbGVtZW50ID0gJHRoaXNbMF07CiAgICAgICAgaWYgKCQuc3VwcG9ydC50b3VjaCkgewogICAgICAgICAgICAkdGhpcy5iaW5kKCd0b3VjaHN0YXJ0Jywgc2V0dGluZ3MuZXZlbnRzLnRvdWNoU3RhcnQpCiAgICAgICAgICAgICAgICAuYmluZCgndG91Y2hlbmQnLCBzZXR0aW5ncy5ldmVudHMuaW5wdXRFbmQpCiAgICAgICAgICAgICAgICAuYmluZCgndG91Y2htb3ZlJywgc2V0dGluZ3MuZXZlbnRzLnRvdWNoTW92ZSkKICAgICAgICAgICAgOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICR0aGlzCiAgICAgICAgICAgICAgICAubW91c2Vkb3duKHNldHRpbmdzLmV2ZW50cy5pbnB1dERvd24pCiAgICAgICAgICAgICAgICAubW91c2V1cChzZXR0aW5ncy5ldmVudHMuaW5wdXRFbmQpCiAgICAgICAgICAgICAgICAubW91c2Vtb3ZlKHNldHRpbmdzLmV2ZW50cy5pbnB1dE1vdmUpCiAgICAgICAgICAgIDsKICAgICAgICB9CiAgICAgICAgJHRoaXMKICAgICAgICAgICAgLmNsaWNrKHNldHRpbmdzLmV2ZW50cy5pbnB1dENsaWNrKQogICAgICAgICAgICAuc2Nyb2xsKHNldHRpbmdzLmV2ZW50cy5zY3JvbGwpCiAgICAgICAgICAgIC5iaW5kKCJzZWxlY3RzdGFydCIsIHNlbGVjdFN0YXJ0KSAvLyBwcmV2ZW50IHNlbGVjdGlvbiB3aGVuIGRyYWdnaW5nCiAgICAgICAgICAgIC5iaW5kKCdkcmFnc3RhcnQnLCBzZXR0aW5ncy5ldmVudHMuZHJhZ1N0YXJ0KTsKICAgIH07CiAgICB2YXIgZGV0YWNoTGlzdGVuZXJzID0gZnVuY3Rpb24oJHRoaXMsIHNldHRpbmdzKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSAkdGhpc1swXTsKICAgICAgICBpZiAoJC5zdXBwb3J0LnRvdWNoKSB7CiAgICAgICAgICAgICR0aGlzLnVuYmluZCgndG91Y2hzdGFydCcsIHNldHRpbmdzLmV2ZW50cy50b3VjaFN0YXJ0KQogICAgICAgICAgICAgICAgLnVuYmluZCgndG91Y2hlbmQnLCBzZXR0aW5ncy5ldmVudHMuaW5wdXRFbmQpCiAgICAgICAgICAgICAgICAudW5iaW5kKCd0b3VjaG1vdmUnLCBzZXR0aW5ncy5ldmVudHMudG91Y2hNb3ZlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkdGhpcwogICAgICAgICAgICAudW5iaW5kKCdtb3VzZWRvd24nLCBzZXR0aW5ncy5ldmVudHMuaW5wdXREb3duKQogICAgICAgICAgICAudW5iaW5kKCdtb3VzZXVwJywgc2V0dGluZ3MuZXZlbnRzLmlucHV0RW5kKQogICAgICAgICAgICAudW5iaW5kKCdtb3VzZW1vdmUnLCBzZXR0aW5ncy5ldmVudHMuaW5wdXRNb3ZlKQogICAgICAgICAgICAudW5iaW5kKCdzY3JvbGwnLCBzZXR0aW5ncy5ldmVudHMuc2Nyb2xsKTsKICAgICAgICB9CiAgICAgICAgJHRoaXMudW5iaW5kKCdjbGljaycsIHNldHRpbmdzLmV2ZW50cy5pbnB1dENsaWNrKQogICAgICAgIC51bmJpbmQoInNlbGVjdHN0YXJ0Iiwgc2VsZWN0U3RhcnQpOyAvLyBwcmV2ZW50IHNlbGVjdGlvbiB3aGVuIGRyYWdnaW5nCiAgICAgICAgJHRoaXMudW5iaW5kKCdkcmFnc3RhcnQnLCBzZXR0aW5ncy5ldmVudHMuZHJhZ1N0YXJ0KTsKICAgIH07CgogICAgdmFyIGluaXRFbGVtZW50cyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB0aGlzCiAgICAgICAgLmFkZENsYXNzKEFDVElWRV9DTEFTUykKICAgICAgICAuZWFjaChmdW5jdGlvbigpewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgJHRoaXMgPSAkKHRoaXMpOwoKICAgICAgICAgICAgaWYgKCR0aGlzLmRhdGEoU0VUVElOR1NfS0VZKSl7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKHt9LCBERUZBVUxUX1NFVFRJTkdTLCBvcHRpb25zKSwKICAgICAgICAgICAgICAgIHhwb3MsCiAgICAgICAgICAgICAgICBwcmV2WFBvcyA9IGZhbHNlLAogICAgICAgICAgICAgICAgeXBvcywKICAgICAgICAgICAgICAgIHByZXZZUG9zID0gZmFsc2UsCiAgICAgICAgICAgICAgICBtb3VzZURvd24gPSBmYWxzZSwKICAgICAgICAgICAgICAgIHNjcm9sbExlZnQsCiAgICAgICAgICAgICAgICBzY3JvbGxUb3AsCiAgICAgICAgICAgICAgICB0aHJvdHRsZVRpbWVvdXQgPSAxMDAwIC8gc2V0dGluZ3MudGhyb3R0bGVGUFMsCiAgICAgICAgICAgICAgICBsYXN0TW92ZSwKICAgICAgICAgICAgICAgIGVsZW1lbnRGb2N1c2VkCiAgICAgICAgICAgIDsKCiAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5ID0gMDsKICAgICAgICAgICAgc2V0dGluZ3MudmVsb2NpdHlZID0gMDsKCiAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB3ZSByZXNldCBldmVyeXRoaW5nIHdoZW4gbW91c2UgdXAKICAgICAgICAgICAgdmFyIHJlc2V0TW91c2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHhwb3MgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHlwb3MgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgICAgICB9OwogICAgICAgICAgICAkKGRvY3VtZW50KS5tb3VzZXVwKHJlc2V0TW91c2UpLmNsaWNrKHJlc2V0TW91c2UpOwoKICAgICAgICAgICAgdmFyIGNhbGN1bGF0ZVZlbG9jaXRpZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5ICAgID0gY2FwVmVsb2NpdHkocHJldlhQb3MgLSB4cG9zLCBzZXR0aW5ncy5tYXh2ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eVkgICA9IGNhcFZlbG9jaXR5KHByZXZZUG9zIC0geXBvcywgc2V0dGluZ3MubWF4dmVsb2NpdHkpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgdXNlVGFyZ2V0ID0gZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKHNldHRpbmdzLmZpbHRlclRhcmdldCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0dGluZ3MuZmlsdGVyVGFyZ2V0LmNhbGwoc2VsZiwgdGFyZ2V0KSAhPT0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gZnVuY3Rpb24oY2xpZW50WCwgY2xpZW50WSkgewogICAgICAgICAgICAgICAgbW91c2VEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5ID0gcHJldlhQb3MgPSAwOwogICAgICAgICAgICAgICAgc2V0dGluZ3MudmVsb2NpdHlZID0gcHJldllQb3MgPSAwOwogICAgICAgICAgICAgICAgeHBvcyA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICB5cG9zID0gY2xpZW50WTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGVuZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHhwb3MgJiYgcHJldlhQb3MgJiYgc2V0dGluZ3MuZGVjZWxlcmF0ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBzZXR0aW5ncy5kZWNlbGVyYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjYWxjdWxhdGVWZWxvY2l0aWVzKCk7CiAgICAgICAgICAgICAgICAgICAgeHBvcyA9IHByZXZYUG9zID0gbW91c2VEb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgbW92ZSgkdGhpcywgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgaW5wdXRtb3ZlID0gZnVuY3Rpb24oY2xpZW50WCwgY2xpZW50WSkgewogICAgICAgICAgICAgICAgaWYgKCFsYXN0TW92ZSB8fCBuZXcgRGF0ZSgpID4gbmV3IERhdGUobGFzdE1vdmUuZ2V0VGltZSgpICsgdGhyb3R0bGVUaW1lb3V0KSkgewogICAgICAgICAgICAgICAgICAgIGxhc3RNb3ZlID0gbmV3IERhdGUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdXNlRG93biAmJiAoeHBvcyB8fCB5cG9zKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudEZvY3VzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZWxlbWVudEZvY3VzZWQpLmJsdXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGb2N1c2VkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aGlzLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MuZGVjZWxlcmF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eSAgID0gc2V0dGluZ3MudmVsb2NpdHlZICA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICR0aGlzWzBdLnNjcm9sbExlZnQgPSBzZXR0aW5ncy5zY3JvbGxMZWZ0ID0gc2V0dGluZ3MueCA/ICR0aGlzWzBdLnNjcm9sbExlZnQgLSAoY2xpZW50WCAtIHhwb3MpIDogJHRoaXNbMF0uc2Nyb2xsTGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgJHRoaXNbMF0uc2Nyb2xsVG9wICA9IHNldHRpbmdzLnNjcm9sbFRvcCAgPSBzZXR0aW5ncy55ID8gJHRoaXNbMF0uc2Nyb2xsVG9wIC0gKGNsaWVudFkgLSB5cG9zKSAgOiAkdGhpc1swXS5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZYUG9zID0geHBvczsKICAgICAgICAgICAgICAgICAgICAgICAgcHJldllQb3MgPSB5cG9zOwogICAgICAgICAgICAgICAgICAgICAgICB4cG9zID0gY2xpZW50WDsKICAgICAgICAgICAgICAgICAgICAgICAgeXBvcyA9IGNsaWVudFk7CgogICAgICAgICAgICAgICAgICAgICAgICBjYWxjdWxhdGVWZWxvY2l0aWVzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldE1vdmVDbGFzc2VzLmNhbGwoJHRoaXMsIHNldHRpbmdzLCBzZXR0aW5ncy5tb3ZpbmdDbGFzcyk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNldHRpbmdzLm1vdmVkID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0aW5ncy5tb3ZlZC5jYWxsKCR0aGlzLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBFdmVudHMKICAgICAgICAgICAgc2V0dGluZ3MuZXZlbnRzID0gewogICAgICAgICAgICAgICAgdG91Y2hTdGFydDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRvdWNoOwogICAgICAgICAgICAgICAgICAgIGlmICh1c2VUYXJnZXQoZS50YXJnZXQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvdWNoID0gZS5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0KHRvdWNoLmNsaWVudFgsIHRvdWNoLmNsaWVudFkpOwogICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB0b3VjaE1vdmU6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgICAgIHZhciB0b3VjaDsKICAgICAgICAgICAgICAgICAgICBpZiAobW91c2VEb3duKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvdWNoID0gZS5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0bW92ZSh0b3VjaC5jbGllbnRYLCB0b3VjaC5jbGllbnRZKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUucHJldmVudERlZmF1bHQpIHtlLnByZXZlbnREZWZhdWx0KCk7fQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnB1dERvd246IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgICAgIGlmICh1c2VUYXJnZXQoZS50YXJnZXQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudEZvY3VzZWQgPSBlLnRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0Lm5vZGVOYW1lID09PSAnSU1HJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5wdXRFbmQ6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgICAgIGVuZCgpOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGb2N1c2VkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCkge2UucHJldmVudERlZmF1bHQoKTt9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5wdXRNb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdXNlRG93bil7CiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0bW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLnByZXZlbnREZWZhdWx0KSB7ZS5wcmV2ZW50RGVmYXVsdCgpO30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2Nyb2xsOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5tb3ZlZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICBzZXR0aW5ncy5tb3ZlZC5jYWxsKCR0aGlzLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChlLnByZXZlbnREZWZhdWx0KSB7ZS5wcmV2ZW50RGVmYXVsdCgpO30KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnB1dENsaWNrOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoc2V0dGluZ3MudmVsb2NpdHkpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gcHJldmVudCBkcmFnIGFuZCBkcm9wIGltYWdlcyBpbiBpZQogICAgICAgICAgICAgICAgZHJhZ1N0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRGb2N1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBhdHRhY2hMaXN0ZW5lcnMoJHRoaXMsIHNldHRpbmdzKTsKICAgICAgICAgICAgJHRoaXMuZGF0YShTRVRUSU5HU19LRVksIHNldHRpbmdzKQogICAgICAgICAgICAgICAgLmNzcygiY3Vyc29yIiwgc2V0dGluZ3MuY3Vyc29yKTsKCiAgICAgICAgICAgIGlmIChzZXR0aW5ncy50cmlnZ2VySGFyZHdhcmUpIHsKICAgICAgICAgICAgICAgICR0aGlzLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtdHJhbnNmb3JtJzogJ3RyYW5zbGF0ZTNkKDAsMCwwKScsCiAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtcGVyc3BlY3RpdmUnOiAnMTAwMCcsCiAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtYmFja2ZhY2UtdmlzaWJpbGl0eSc6ICdoaWRkZW4nCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfTsKCiAgICAkLmtpbmV0aWMgPSB7CiAgICAgICAgc2V0dGluZ3NLZXk6IFNFVFRJTkdTX0tFWSwKICAgICAgICBjYWxsTWV0aG9kczogewogICAgICAgICAgICBzdGFydDogZnVuY3Rpb24oc2V0dGluZ3MsIG9wdGlvbnMpewogICAgICAgICAgICAgICAgdmFyICR0aGlzID0gJCh0aGlzKTsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gJC5leHRlbmQoc2V0dGluZ3MsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MuZGVjZWxlcmF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIG1vdmUoJHRoaXMsIHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZW5kOiBmdW5jdGlvbihzZXR0aW5ncywgb3B0aW9ucyl7CiAgICAgICAgICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpOwogICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MuZGVjZWxlcmF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3A6IGZ1bmN0aW9uKHNldHRpbmdzLCBvcHRpb25zKXsKICAgICAgICAgICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyk7CiAgICAgICAgICAgICAgICBzdG9wKCR0aGlzLCBzZXR0aW5ncyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRldGFjaDogZnVuY3Rpb24oc2V0dGluZ3MsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyk7CiAgICAgICAgICAgICAgICBkZXRhY2hMaXN0ZW5lcnMoJHRoaXMsIHNldHRpbmdzKTsKICAgICAgICAgICAgICAgICR0aGlzCiAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoQUNUSVZFX0NMQVNTKQogICAgICAgICAgICAgICAgLmNzcygiY3Vyc29yIiwgIiIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBhdHRhY2g6IGZ1bmN0aW9uKHNldHRpbmdzLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpOwogICAgICAgICAgICAgICAgYXR0YWNoTGlzdGVuZXJzKCR0aGlzLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAkdGhpcwogICAgICAgICAgICAgICAgLmFkZENsYXNzKEFDVElWRV9DTEFTUykKICAgICAgICAgICAgICAgIC5jc3MoImN1cnNvciIsICJtb3ZlIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgJC5mbi5raW5ldGljID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY2FsbE9wdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluaXRFbGVtZW50cy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH07Cgp9KHdpbmRvdy5qUXVlcnkgfHwgd2luZG93LlplcHRvKSk7CgovKioKKiAgICAgIEV2ZW50cy4gUHViL1N1YiBzeXN0ZW0gZm9yIExvb3NlbHkgQ291cGxlZCBsb2dpYy4KKiAgICAgIEJhc2VkIG9uIFBldGVyIEhpZ2dpbnMnIHBvcnQgZnJvbSBEb2pvIHRvIGpRdWVyeQoqICAgICAgaHR0cHM6Ly9naXRodWIuY29tL3BoaWdnaW5zNDIvYmxvb2R5LWpxdWVyeS1wbHVnaW5zL2Jsb2IvbWFzdGVyL3B1YnN1Yi5qcwoqCiogICAgICBSZS1hZGFwdGVkIHRvIHZhbmlsbGEgSmF2YXNjcmlwdAoqCiogICAgICBAY2xhc3MgRXZlbnRzCiovCnZhciBkaXZhID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIGNhY2hlID0ge307CiAgICB2YXIgcHViID0gewogICAgICAgIEV2ZW50czogewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogICAgICBkaXZhLkV2ZW50cy5wdWJsaXNoCiAgICAgICAgICAgICAqICAgICAgZS5nLjogZGl2YS5FdmVudHMucHVibGlzaCgiUGFnZURpZExvYWQiLCBbcGFnZUluZGV4LCBmaWxlbmFtZSwgcGFnZVNlbGVjdG9yXSwgdGhpcyk7CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICAgQGNsYXNzIEV2ZW50cwogICAgICAgICAgICAgKiAgICAgIEBtZXRob2QgcHVibGlzaAogICAgICAgICAgICAgKiAgICAgIEBwYXJhbSB0b3BpYyB7U3RyaW5nfQogICAgICAgICAgICAgKiAgICAgIEBwYXJhbSBhcmdzICAgICB7QXJyYXl9CiAgICAgICAgICAgICAqICAgICAgQHBhcmFtIHNjb3BlIHtPYmplY3R9IE9wdGlvbmFsCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwdWJsaXNoOiBmdW5jdGlvbiAodG9waWMsIGFyZ3MsIHNjb3BlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY2FjaGVbdG9waWNdKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciB0aGlzVG9waWMgPSBjYWNoZVt0b3BpY10sCiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSB0aGlzVG9waWMubGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoaS0tKQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzVG9waWNbaV0uYXBwbHkoIHNjb3BlIHx8IHRoaXMsIGFyZ3MgfHwgW10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogICAgICBkaXZhLkV2ZW50cy5zdWJzY3JpYmUKICAgICAgICAgICAgICogICAgICBlLmcuOiBkaXZhLkV2ZW50cy5zdWJzY3JpYmUoIlBhZ2VEaWRMb2FkIiwgaGlnaGxpZ2h0KQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAgIEBjbGFzcyBFdmVudHMKICAgICAgICAgICAgICogICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICAgICAgKiAgICAgIEBwYXJhbSB0b3BpYyB7U3RyaW5nfQogICAgICAgICAgICAgKiAgICAgIEBwYXJhbSBjYWxsYmFjayB7RnVuY3Rpb259CiAgICAgICAgICAgICAqICAgICAgQHJldHVybiBFdmVudCBoYW5kbGVyIHtBcnJheX0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHN1YnNjcmliZTogZnVuY3Rpb24gKHRvcGljLCBjYWxsYmFjaykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFjYWNoZVt0b3BpY10pCiAgICAgICAgICAgICAgICAgICAgY2FjaGVbdG9waWNdID0gW107CgogICAgICAgICAgICAgICAgY2FjaGVbdG9waWNdLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICAgICAgcmV0dXJuIFt0b3BpYywgY2FsbGJhY2tdOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogICAgICBkaXZhLkV2ZW50cy51bnN1YnNjcmliZQogICAgICAgICAgICAgKiAgICAgIGUuZy46IHZhciBoYW5kbGUgPSBFdmVudHMuc3Vic2NyaWJlKCJQYWdlRGlkTG9hZCIsIGhpZ2hsaWdodCk7CiAgICAgICAgICAgICAqICAgICAgICAgICAgICBFdmVudHMudW5zdWJzY3JpYmUoaGFuZGxlKTsKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgICBAY2xhc3MgRXZlbnRzCiAgICAgICAgICAgICAqICAgICAgQG1ldGhvZCB1bnN1YnNjcmliZQogICAgICAgICAgICAgKiAgICAgIEBwYXJhbSBoYW5kbGUge0FycmF5fQogICAgICAgICAgICAgKiAgICAgIEBwYXJhbSBjb21wbGV0ZWx5IHtCb29sZWFufSAtIFVuc3Vic2NyaWJlIGFsbCBldmVudHMgZm9yIGEgZ2l2ZW4gdG9waWMuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB1bnN1YnNjcmliZTogZnVuY3Rpb24gKGhhbmRsZSwgY29tcGxldGVseSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHQgPSBoYW5kbGVbMF0sCiAgICAgICAgICAgICAgICAgICAgaSA9IGNhY2hlW3RdLmxlbmd0aDsKCiAgICAgICAgICAgICAgICBpZiAoY2FjaGVbdF0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGktLSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZVt0XVtpXSA9PT0gaGFuZGxlWzFdKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZVt0XS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGxldGVseSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FjaGVbdF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiAgICAgIGRpdmEuRXZlbnRzLnVuc3Vic2NyaWJlQWxsCiAgICAgICAgICAgICAqICAgICAgZS5nLjogZGl2YS5FdmVudHMudW5zdWJzY3JpYmVBbGwoKTsKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgICBAY2xhc3MgRXZlbnRzCiAgICAgICAgICAgICAqICAgICAgQG1ldGhvZCB1bnN1YnNjcmliZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdW5zdWJzY3JpYmVBbGw6IGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhY2hlID0ge307CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgcmV0dXJuIHB1YjsKfSgpKTsKCnZhciBtdWx0aURpdmE7Cgp2YXIgbXVsdGlEaXZhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpCnsKICAgIHZhciBhY3RpdmU7CgogICAgJChkb2N1bWVudCkub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkKICAgIHsKICAgICAgICB1cGRhdGVBY3RpdmUoJChlLnRhcmdldCkpOwogICAgfSk7CgogICAgLy9wYXJhbWV0ZXIgc2hvdWxkIGFscmVhZHkgYmUgc2VsZWN0ZWQgaW4galF1ZXJ5CiAgICB2YXIgdXBkYXRlQWN0aXZlID0gZnVuY3Rpb24gKHRhcmdldCkKICAgIHsKICAgICAgICB2YXIgbmVhcmVzdE91dGVyOwoKICAgICAgICAvL3RoZXNlIHdpbGwgZmluZCAwIG9yIDEgb2JqZWN0cywgbmV2ZXIgbW9yZQogICAgICAgIHZhciBmaW5kT3V0ZXIgPSB0YXJnZXQuZmluZCgnLmRpdmEtb3V0ZXInKTsKICAgICAgICB2YXIgY2xvc2VzdE91dGVyID0gdGFyZ2V0LmNsb3Nlc3QoJy5kaXZhLW91dGVyJyk7CgogICAgICAgIGlmIChmaW5kT3V0ZXIubGVuZ3RoID4gMCkgLy9jbGlja2VkIG9uIHNvbWV0aGluZyB0aGF0IHdhcyBub3QgZWl0aGVyIGEgcGFyZW50IG9yIHNpYmxpbmcgb2YgZGl2YS1vdXRlcgogICAgICAgIHsKICAgICAgICAgICAgbmVhcmVzdE91dGVyID0gZmluZE91dGVyOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChjbG9zZXN0T3V0ZXIubGVuZ3RoID4gMCkgLy9jbGlja2VkIG9uIHNvbWV0aGluZyB0aGF0IHdhcyBhIGNoaWxkIG9mIGRpdmEtb3V0ZXIKICAgICAgICB7CiAgICAgICAgICAgIG5lYXJlc3RPdXRlciA9IGNsb3Nlc3RPdXRlcjsKICAgICAgICB9CiAgICAgICAgZWxzZSAvL2NsaWNrZWQgb24gc29tZXRoaW5nIHVucmVsYXRlZAogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy9hY3RpdmF0ZSB0aGlzIG9uZQogICAgICAgIG5lYXJlc3RPdXRlci5wYXJlbnQoKS5kYXRhKCdkaXZhJykuYWN0aXZhdGUoKTsKICAgICAgICBhY3RpdmUgPSBuZWFyZXN0T3V0ZXIucGFyZW50KCk7CgogICAgICAgIC8vZGVhY3RpdmF0ZSBhbGwgdGhlIG90aGVycwogICAgICAgIHZhciBjdXJPdXRlciA9ICQoIi5kaXZhLW91dGVyIikubGVuZ3RoOwogICAgICAgIHdoaWxlIChjdXJPdXRlci0tKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCQoJCgiLmRpdmEtb3V0ZXIiKVtjdXJPdXRlcl0pLmF0dHIoJ2lkJykgIT0gbmVhcmVzdE91dGVyLmF0dHIoJ2lkJykpCiAgICAgICAgICAgICAgICAkKCQoIi5kaXZhLW91dGVyIilbY3VyT3V0ZXJdKS5wYXJlbnQoKS5kYXRhKCdkaXZhJykuZGVhY3RpdmF0ZSgpOwogICAgICAgIH0KICAgIH07CgogICAgdGhpcy5nZXRBY3RpdmUgPSBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgcmV0dXJuIGFjdGl2ZTsKICAgIH07Cn07CgpkaXZhLkV2ZW50cy5zdWJzY3JpYmUoIlZpZXdlckRpZExvYWQiLCBmdW5jdGlvbihzZXR0aW5ncykKewogICAgaWYoJCgiLmRpdmEtb3V0ZXIiKS5sZW5ndGggPiAxKXsKICAgICAgICAvL21ha2Ugc3VyZSB0aGVyZSdzIG9ubHkgb25lIGFjdGl2ZSBkaXZhOyBkZWFjdGl2YXRlIGFueSBuZXdlciBvbmVzCiAgICAgICAgdGhpcy5kZWFjdGl2YXRlKCk7CgogICAgICAgIC8vY3JlYXRlIHRoZSBjb250cm9sbGVyIGlmIGl0IGRvZXNuJ3QgYWxyZWFkeSBleGlzdAogICAgICAgIGlmKCFtdWx0aURpdmEpCiAgICAgICAgICAgIG11bHRpRGl2YSA9IG5ldyBtdWx0aURpdmFDb250cm9sbGVyKCk7CiAgICB9Cn0pOw==",
                "body": "Ly8gU29tZSBzaW1wbGUgdXRpbGl0eSBtZXRob2RzIGZvciB3ZWIgc3RvcmFnZSAoZS5nLiwgbG9jYWxTdG9yYWdlKQpTdG9yYWdlLnByb3RvdHlwZS5zZXRPYmplY3QgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgdGhpcy5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTsKfTsKClN0b3JhZ2UucHJvdG90eXBlLmdldE9iamVjdCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0SXRlbShrZXkpOwogICAgcmV0dXJuIHZhbHVlICYmIEpTT04ucGFyc2UodmFsdWUpOwp9OwoKLy8gZnJvbSBodHRwOi8vZm9ycnN0LmNvbS9wb3N0cy9qUXVlcnlfZWxlbWVudF9JRF9nZW5lcmF0b3ItUm9NCihmdW5jdGlvbiAoJCkgewogICAgdmFyIGNvdW50ZXIgPSAxOwogICAgJC5nZW5lcmF0ZUlkID0gZnVuY3Rpb24oc3VmZml4KSB7CiAgICAgICAgdmFyIGdlbmVyYXRlZElkOwogICAgICAgIGRvIHsKICAgICAgICAgICAgZ2VuZXJhdGVkSWQgPSAoY291bnRlcisrKSArIChzdWZmaXggPyAnLScgKyBzdWZmaXggOiAnJyk7CiAgICAgICAgfSB3aGlsZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZChnZW5lcmF0ZWRJZCkpOwoKICAgICAgICByZXR1cm4gZ2VuZXJhdGVkSWQ7CiAgICB9Owp9KShqUXVlcnkpOwoKLy8gRnJvbSBodHRwOi8vd3d3LmFsZXhhbmRyZS1nb21lcy5jb20vP3A9MTE1LCBtb2RpZmllZCBzbGlnaHRseQooZnVuY3Rpb24gKCQpIHsKICAgICQuZ2V0U2Nyb2xsYmFyV2lkdGggPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7CiAgICAgICAgaW5uZXIuc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgaW5uZXIuc3R5bGUuaGVpZ2h0ID0gJzIwMHB4JzsKCiAgICAgICAgdmFyIG91dGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgb3V0ZXIuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnOwogICAgICAgIG91dGVyLnN0eWxlLnRvcCA9ICcwcHgnOwogICAgICAgIG91dGVyLnN0eWxlLmxlZnQgPSAnMHB4JzsKICAgICAgICBvdXRlci5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CiAgICAgICAgb3V0ZXIuc3R5bGUud2lkdGggPSAnMjAwcHgnOwogICAgICAgIG91dGVyLnN0eWxlLmhlaWdodCA9ICcxNTBweCc7CiAgICAgICAgb3V0ZXIuc3R5bGUub3ZlcmZsb3cgPSAnaGlkZGVuJzsKICAgICAgICBvdXRlci5hcHBlbmRDaGlsZChpbm5lcik7CgogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQob3V0ZXIpOwoKICAgICAgICB2YXIgdzEgPSBpbm5lci5vZmZzZXRXaWR0aDsKICAgICAgICBvdXRlci5zdHlsZS5vdmVyZmxvdyA9ICdzY3JvbGwnOwogICAgICAgIHZhciB3MiA9IGlubmVyLm9mZnNldFdpZHRoOwogICAgICAgIGlmICh3MSA9PSB3MikgewogICAgICAgICAgICB3MiA9IG91dGVyLmNsaWVudFdpZHRoOyAvLyBmb3IgSUUgaSB0aGluawogICAgICAgIH0KCiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChvdXRlcik7CiAgICAgICAgcmV0dXJuIHcxIC0gdzI7CiAgICB9Owp9KShqUXVlcnkpOwoKLy8gRm9yIGdldHRpbmcgdGhlICNrZXkgdmFsdWVzIGZyb20gdGhlIFVSTC4gRm9yIHNwZWNpZnlpbmcgYSBwYWdlIGFuZCB6b29tIGxldmVsCi8vIExvb2sgaW50byBjYWNoaW5nLCBiZWNhdXNlIHdlIG9ubHkgbmVlZCB0byBnZXQgdGhpcyBkdXJpbmcgdGhlIGluaXRpYWwgbG9hZAovLyBBbHRob3VnaCBmb3IgdGhlIHRlc3RzIEkgZ3Vlc3Mgd2Ugd291bGQgbmVlZCB0byBvdmVycmlkZSBjYWNoaW5nIHNvbWVob3cKKGZ1bmN0aW9uICgkKSB7CiAgICAkLmdldEhhc2hQYXJhbSA9IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7CiAgICAgICAgaWYgKGhhc2ggIT09ICcnKSB7CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZXJlIGlzIHNvbWV0aGluZyB0aGF0IGxvb2tzIGxpa2UgZWl0aGVyICZrZXk9IG9yICNrZXk9CiAgICAgICAgICAgIHZhciBzdGFydEluZGV4ID0gKGhhc2guaW5kZXhPZignJicgKyBrZXkgKyAnPScpID4gMCkgPyBoYXNoLmluZGV4T2YoJyYnICsga2V5ICsgJz0nKSA6IGhhc2guaW5kZXhPZignIycgKyBrZXkgKyAnPScpOwoKICAgICAgICAgICAgLy8gSWYgc3RhcnRJbmRleCBpcyBzdGlsbCAtMSwgaXQgbWVhbnMgaXQgY2FuJ3QgZmluZCBlaXRoZXIKICAgICAgICAgICAgaWYgKHN0YXJ0SW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgLy8gQWRkIHRoZSBsZW5ndGggb2YgdGhlIGtleSBwbHVzIHRoZSAmIGFuZCA9CiAgICAgICAgICAgICAgICBzdGFydEluZGV4ICs9IGtleS5sZW5ndGggKyAyOwoKICAgICAgICAgICAgICAgIC8vIEVpdGhlciB0byB0aGUgbmV4dCBhbXBlcnNhbmQgb3IgdG8gdGhlIGVuZCBvZiB0aGUgc3RyaW5nCiAgICAgICAgICAgICAgICB2YXIgZW5kSW5kZXggPSBoYXNoLmluZGV4T2YoJyYnLCBzdGFydEluZGV4KTsKICAgICAgICAgICAgICAgIGlmIChlbmRJbmRleCA+IHN0YXJ0SW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzaC5zdWJzdHJpbmcoc3RhcnRJbmRleCwgZW5kSW5kZXgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbmRJbmRleCA8IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIG1lYW5zIHRoaXMgaGFzaCBwYXJhbSBpcyB0aGUgbGFzdCBvbmUKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzaC5zdWJzdHJpbmcoc3RhcnRJbmRleCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBJZiB0aGUga2V5IGRvZXNuJ3QgaGF2ZSBhIHZhbHVlIEkgdGhpbmsKICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIElmIGl0IGNhbid0IGZpbmQgdGhlIGtleQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIGhhc2ggcGFyYW1zIGp1c3QgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9Owp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uICgkKSB7CiAgICAkLnVwZGF0ZUhhc2hQYXJhbSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAvLyBGaXJzdCBtYWtlIHN1cmUgdGhhdCB3ZSBoYXZlIHRvIGRvIGFueSB3b3JrIGF0IGFsbAogICAgICAgIHZhciBvcmlnaW5hbFZhbHVlID0gJC5nZXRIYXNoUGFyYW0oa2V5KTsKICAgICAgICB2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgICAgIGlmIChvcmlnaW5hbFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAvLyBJcyB0aGUga2V5IGFscmVhZHkgaW4gdGhlIFVSTD8KICAgICAgICAgICAgaWYgKHR5cGVvZiBvcmlnaW5hbFZhbHVlID09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAvLyBBbHJlYWR5IGluIHRoZSBVUkwuIEp1c3QgZ2V0IHJpZCBvZiB0aGUgb3JpZ2luYWwgdmFsdWUKICAgICAgICAgICAgICAgIHZhciBzdGFydEluZGV4ID0gKGhhc2guaW5kZXhPZignJicgKyBrZXkgKyAnPScpID4gMCkgPyBoYXNoLmluZGV4T2YoJyYnICsga2V5ICsgJz0nKSA6IGhhc2guaW5kZXhPZignIycgKyBrZXkgKyAnPScpOwogICAgICAgICAgICAgICAgdmFyIGVuZEluZGV4ID0gc3RhcnRJbmRleCArIGtleS5sZW5ndGggKyAyICsgb3JpZ2luYWxWYWx1ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAvLyAjIGlmIGl0J3MgdGhlIGZpcnN0LCAmIG90aGVyd2lzZQogICAgICAgICAgICAgICAgdmFyIHN0YXJ0VGhpbmcgPSAoc3RhcnRJbmRleCA9PT0gMCkgPyAnIycgOiAnJic7CiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZShoYXNoLnN1YnN0cmluZygwLCBzdGFydEluZGV4KSArIHN0YXJ0VGhpbmcgKyBrZXkgKyAnPScgKyB2YWx1ZSArIGhhc2guc3Vic3RyaW5nKGVuZEluZGV4KSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJdCdzIG5vdCBwcmVzZW50IC0gYWRkIGl0CiAgICAgICAgICAgICAgICBpZiAoaGFzaC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZSgnIycgKyBrZXkgKyAnPScgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCBpdAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKGhhc2ggKyAnJicgKyBrZXkgKyAnPScgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KShqUXVlcnkpOwoKLyoKICogalF1ZXJ5IGRyYWdzY3JvbGxhYmxlIFBsdWdpbgogKiB2ZXJzaW9uOiAxLjAgKDI1LUp1bi0yMDA5KQogKiBDb3B5cmlnaHQgKGMpIDIwMDkgTWlxdWVsIEhlcnJlcmEKICogaHR0cDovL3BsdWdpbnMuanF1ZXJ5LmNvbS9wcm9qZWN0L0RyYWdzY3JvbGxhYmxlCiAqCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzOgogKiAgIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCiAqICAgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2dwbC5odG1sCiAqCiAqLwooZnVuY3Rpb24gKCQpIHsgLy8gc2VjdXJlICQgalF1ZXJ5IGFsaWFzCgovKioKICogQWRkcyB0aGUgYWJpbGl0eSB0byBtYW5hZ2UgZWxlbWVudHMgc2Nyb2xsIGJ5IGRyYWdnaW5nCiAqIG9uZSBvciBtb3JlIG9mIGl0cyBkZXNjZW5kYW50IGVsZW1lbnRzLiBPcHRpb25zIHBhcmFtZXRlcgogKiBhbGxvdyB0byBzcGVjaWZpY2FsbHkgc2VsZWN0IHdoaWNoIGlubmVyIGVsZW1lbnRzIHdpbGwKICogcmVzcG9uZCB0byB0aGUgZHJhZyBldmVudHMuCiAqCiAqIG9wdGlvbnMgcHJvcGVydGllczoKICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAqICBkcmFnU2VsZWN0b3IgICAgICAgICB8IGpxdWVyeSBzZWxlY3RvciB0byBhcHBseSB0byBlYWNoIHdyYXBwZWQgZWxlbWVudAogKiAgICAgICAgICAgICAgICAgICAgICAgfCB0byBmaW5kIHdoaWNoIHdpbGwgYmUgdGhlIGRyYWdnaW5nIGVsZW1lbnRzLgogKiAgICAgICAgICAgICAgICAgICAgICAgfCBEZWZhdWx0cyB0byAnPjpmaXJzdCcgd2hpY2ggaXMgdGhlIGZpcnN0IGNoaWxkIG9mCiAqICAgICAgICAgICAgICAgICAgICAgICB8IHNjcm9sbGFibGUgZWxlbWVudAogKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICogIGFjY2VwdFByb3BhZ2F0ZWRFdmVudHwgV2lsbCB0aGUgZHJhZ2dpbmcgZWxlbWVudCBhY2NlcHQgcHJvcGFnYXRlZAogKiAgICAgICAgICAgICAgICAgICAgICAgfCBldmVudHM/IGRlZmF1bHQgaXMgeWVzLCBhIHByb3BhZ2F0ZWQgbW91c2UgZXZlbnQKICogICAgICAgICAgICAgICAgICAgICAgIHwgb24gYSBpbm5lciBlbGVtZW50IHdpbGwgYmUgYWNjZXB0ZWQgYW5kIHByb2Nlc3NlZC4KICogICAgICAgICAgICAgICAgICAgICAgIHwgSWYgc2V0IHRvIGZhbHNlLCBvbmx5IGV2ZW50cyBvcmlnaW5hdGVkIG9uIHRoZQogKiAgICAgICAgICAgICAgICAgICAgICAgfCBkcmFnZ2FibGUgZWxlbWVudHMgd2lsbCBiZSBwcm9jZXNzZWQuCiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogKiAgcHJldmVudERlZmF1bHQgICAgICAgfCBQcmV2ZW50cyB0aGUgZXZlbnQgdG8gcHJvcGFnYXRlIGZ1cnRoZXIgZWZmZWN0aXZleQogKiAgICAgICAgICAgICAgICAgICAgICAgfCBkaXNzYWJsaW5nIG90aGVyIGRlZmF1bHQgYWN0aW9ucy4gRGVmYXVsdHMgdG8gdHJ1ZQogKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICoKICogIHVzYWdlIGV4YW1wbGVzOgogKgogKiAgVG8gYWRkIHRoZSBzY3JvbGwgYnkgZHJhZyB0byB0aGUgZWxlbWVudCBpZD12aWV3cG9ydCB3aGVuIGRyYWdnaW5nIGl0cwogKiAgZmlyc3QgY2hpbGQgYWNjZXB0aW5nIGFueSBwcm9wYWdhdGVkIGV2ZW50cwogKiAgJCgnI3ZpZXdwb3J0JykuZHJhZ3Njcm9sbGFibGUoKTsKICoKICogIFRvIGFkZCB0aGUgc2Nyb2xsIGJ5IGRyYWcgYWJpbGl0eSB0byBhbnkgZWxlbWVudCBkaXYgb2YgY2xhc3Mgdmlld3BvcnQKICogIHdoZW4gZHJhZ2dpbmcgaXRzIGZpcnN0IGRlc2NlbmRhbnQgb2YgY2xhc3MgZHJhZ01lIHJlc3BvbmRpbmcgb25seSB0bwogKiAgZXZjZW50cyBvcmlnaW5hdGVkIG9uIHRoZSAnLmRyYWdNZScgZWxlbWVudHMuCiAqICAkKCdkaXYudmlld3BvcnQnKS5kcmFnc2Nyb2xsYWJsZSh7ZHJhZ1NlbGVjdG9yOicuZHJhZ01lOmZpcnN0JywKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NlcHRQcm9wYWdhdGVkRXZlbnQ6IGZhbHNlfSk7CiAqCiAqICBOb3RpY2UgdGhhdCBzb21lICd2aWV3cG9ydHMnIGNvdWxkIGJlIG5lc3RlZCB3aXRoaW4gb3RoZXJzIGJ1dCBldmVudHMKICogIHdvdWxkIG5vdCBpbnRlcmZlcmUgYXMgYWNjZXB0UHJvcGFnYXRlZEV2ZW50IGlzIHNldCB0byBmYWxzZS4KICoKICovCiQuZm4uZHJhZ3Njcm9sbGFibGUgPSBmdW5jdGlvbiggb3B0aW9ucyApewoKICAgIHZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKAogICAgICAgIHsKICAgICAgICAgICAgZHJhZ1NlbGVjdG9yOic+OmZpcnN0JywKICAgICAgICAgICAgYWNjZXB0UHJvcGFnYXRlZEV2ZW50OiB0cnVlLAogICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogdHJ1ZQogICAgICAgIH0sb3B0aW9ucyB8fCB7fSk7CgoKICAgIHZhciBkcmFnc2Nyb2xsPSB7CiAgICAgICAgbW91c2VEb3duSGFuZGxlciA6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIC8vIG1vdXNlZG93biwgbGVmdCBjbGljaywgY2hlY2sgcHJvcGFnYXRpb24KICAgICAgICAgICAgaWYgKGV2ZW50LndoaWNoIT0xIHx8CiAgICAgICAgICAgICAgICAoIWV2ZW50LmRhdGEuYWNjZXB0UHJvcGFnYXRlZEV2ZW50ICYmIGV2ZW50LnRhcmdldCAhPSB0aGlzKSl7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEluaXRpYWwgY29vcmRpbmF0ZXMgd2lsbCBiZSB0aGUgbGFzdCB3aGVuIGRyYWdnaW5nCiAgICAgICAgICAgIGV2ZW50LmRhdGEubGFzdENvb3JkID0ge2xlZnQ6IGV2ZW50LmNsaWVudFgsIHRvcDogZXZlbnQuY2xpZW50WX07CgogICAgICAgICAgICAkLmV2ZW50LmFkZCggZG9jdW1lbnQsICJtb3VzZXVwIiwKICAgICAgICAgICAgICAgICAgICAgICAgIGRyYWdzY3JvbGwubW91c2VVcEhhbmRsZXIsIGV2ZW50LmRhdGEgKTsKICAgICAgICAgICAgJC5ldmVudC5hZGQoIGRvY3VtZW50LCAibW91c2Vtb3ZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIGRyYWdzY3JvbGwubW91c2VNb3ZlSGFuZGxlciwgZXZlbnQuZGF0YSApOwogICAgICAgICAgICBpZiAoZXZlbnQuZGF0YS5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbW91c2VNb3ZlSGFuZGxlciA6IGZ1bmN0aW9uKGV2ZW50KSB7IC8vIFVzZXIgaXMgZHJhZ2dpbmcKICAgICAgICAgICAgLy8gSG93IG11Y2ggZGlkIHRoZSBtb3VzZSBtb3ZlPwogICAgICAgICAgICB2YXIgZGVsdGEgPSB7bGVmdDogKGV2ZW50LmNsaWVudFggLSBldmVudC5kYXRhLmxhc3RDb29yZC5sZWZ0KSwKICAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogKGV2ZW50LmNsaWVudFkgLSBldmVudC5kYXRhLmxhc3RDb29yZC50b3ApfTsKCiAgICAgICAgICAgIC8vIFNldCB0aGUgc2Nyb2xsIHBvc2l0aW9uIHJlbGF0aXZlIHRvIHdoYXQgZXZlciB0aGUgc2Nyb2xsIGlzIG5vdwogICAgICAgICAgICBldmVudC5kYXRhLnNjcm9sbGFibGUuc2Nyb2xsTGVmdCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEuc2Nyb2xsYWJsZS5zY3JvbGxMZWZ0KCkgLSBkZWx0YS5sZWZ0KTsKICAgICAgICAgICAgZXZlbnQuZGF0YS5zY3JvbGxhYmxlLnNjcm9sbFRvcCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEuc2Nyb2xsYWJsZS5zY3JvbGxUb3AoKSAtIGRlbHRhLnRvcCk7CgogICAgICAgICAgICAvLyBTYXZlIHdoZXJlIHRoZSBjdXJzb3IgaXMKICAgICAgICAgICAgZXZlbnQuZGF0YS5sYXN0Q29vcmQ9e2xlZnQ6IGV2ZW50LmNsaWVudFgsIHRvcDogZXZlbnQuY2xpZW50WX07CiAgICAgICAgICAgIGlmIChldmVudC5kYXRhLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgbW91c2VVcEhhbmRsZXIgOiBmdW5jdGlvbihldmVudCkgeyAvLyBTdG9wIHNjcm9sbGluZwogICAgICAgICAgICAkLmV2ZW50LnJlbW92ZSggZG9jdW1lbnQsICJtb3VzZW1vdmUiLCBkcmFnc2Nyb2xsLm1vdXNlTW92ZUhhbmRsZXIpOwogICAgICAgICAgICAkLmV2ZW50LnJlbW92ZSggZG9jdW1lbnQsICJtb3VzZXVwIiwgZHJhZ3Njcm9sbC5tb3VzZVVwSGFuZGxlcik7CiAgICAgICAgICAgIGlmIChldmVudC5kYXRhLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBzZXQgdXAgdGhlIGluaXRpYWwgZXZlbnRzCiAgICB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gY2xvc3VyZSBvYmplY3QgZGF0YSBmb3IgZWFjaCBzY3JvbGxhYmxlIGVsZW1lbnQKICAgICAgICB2YXIgZGF0YSA9IHtzY3JvbGxhYmxlIDogJCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBhY2NlcHRQcm9wYWdhdGVkRXZlbnQgOiBzZXR0aW5ncy5hY2NlcHRQcm9wYWdhdGVkRXZlbnQsCiAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQgOiBzZXR0aW5ncy5wcmV2ZW50RGVmYXVsdCB9OwogICAgICAgIC8vIFNldCBtb3VzZSBpbml0aWF0aW5nIGV2ZW50IG9uIHRoZSBkZXNpcmVkIGRlc2NlbmRhbnQKICAgICAgICAkKHRoaXMpLmZpbmQoc2V0dGluZ3MuZHJhZ1NlbGVjdG9yKS4KICAgICAgICAgICAgICAgICAgICAgICAgYmluZCgnbW91c2Vkb3duJywgZGF0YSwgZHJhZ3Njcm9sbC5tb3VzZURvd25IYW5kbGVyKTsKICAgIH0pOwp9OyAvL2VuZCBwbHVnaW4gZHJhZ3Njcm9sbGFibGUKCn0pKCBqUXVlcnkgKTsgLy8gY29uZmluZSBzY29wZQoKLyohCiAgICBqUXVlcnkua2luZXRpYyB2MS44LjIKICAgIERhdmUgVGF5bG9yIGh0dHA6Ly90aGUtdGF5bG9ycy5vcmcvanF1ZXJ5LmtpbmV0aWMKCiAgICBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICAgIENvcHlyaWdodCAoYykgPDIwMTE+IDxEYXZlIFRheWxvciBodHRwOi8vdGhlLXRheWxvcnMub3JnPgoqLwovKmdsb2JhbCBkZWZpbmUscmVxdWlyZSAqLwooZnVuY3Rpb24oJCl7CiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIERFRkFVTFRfU0VUVElOR1MgPSB7CiAgICAgICAgICAgIGN1cnNvcjogJ21vdmUnLAogICAgICAgICAgICBkZWNlbGVyYXRlOiB0cnVlLAogICAgICAgICAgICB0cmlnZ2VySGFyZHdhcmU6IGZhbHNlLAogICAgICAgICAgICB5OiB0cnVlLAogICAgICAgICAgICB4OiB0cnVlLAogICAgICAgICAgICBzbG93ZG93bjogMC45LAogICAgICAgICAgICBtYXh2ZWxvY2l0eTogNDAsCiAgICAgICAgICAgIHRocm90dGxlRlBTOiA2MCwKICAgICAgICAgICAgbW92aW5nQ2xhc3M6IHsKICAgICAgICAgICAgICAgIHVwOiAna2luZXRpYy1tb3ZpbmctdXAnLAogICAgICAgICAgICAgICAgZG93bjogJ2tpbmV0aWMtbW92aW5nLWRvd24nLAogICAgICAgICAgICAgICAgbGVmdDogJ2tpbmV0aWMtbW92aW5nLWxlZnQnLAogICAgICAgICAgICAgICAgcmlnaHQ6ICdraW5ldGljLW1vdmluZy1yaWdodCcKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVjZWxlcmF0aW5nQ2xhc3M6IHsKICAgICAgICAgICAgICAgIHVwOiAna2luZXRpYy1kZWNlbGVyYXRpbmctdXAnLAogICAgICAgICAgICAgICAgZG93bjogJ2tpbmV0aWMtZGVjZWxlcmF0aW5nLWRvd24nLAogICAgICAgICAgICAgICAgbGVmdDogJ2tpbmV0aWMtZGVjZWxlcmF0aW5nLWxlZnQnLAogICAgICAgICAgICAgICAgcmlnaHQ6ICdraW5ldGljLWRlY2VsZXJhdGluZy1yaWdodCcKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgU0VUVElOR1NfS0VZID0gJ2tpbmV0aWMtc2V0dGluZ3MnLAogICAgICAgIEFDVElWRV9DTEFTUyA9ICdraW5ldGljLWFjdGl2ZSc7CiAgICAvKioKICAgICAqIFByb3ZpZGVzIHJlcXVlc3RBbmltYXRpb25GcmFtZSBpbiBhIGNyb3NzIGJyb3dzZXIgd2F5LgogICAgICogaHR0cDovL3BhdWxpcmlzaC5jb20vMjAxMS9yZXF1ZXN0YW5pbWF0aW9uZnJhbWUtZm9yLXNtYXJ0LWFuaW1hdGluZy8KICAgICAqLwogICAgaWYgKCAhd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSApIHsKCiAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICggZnVuY3Rpb24oKSB7CgogICAgICAgICAgICByZXR1cm4gd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIHdpbmRvdy5vUmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIHdpbmRvdy5tc1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICBmdW5jdGlvbiggLyogZnVuY3Rpb24gRnJhbWVSZXF1ZXN0Q2FsbGJhY2sgKi8gY2FsbGJhY2ssIC8qIERPTUVsZW1lbnQgRWxlbWVudCAqLyBlbGVtZW50ICkgewogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoIGNhbGxiYWNrLCAxMDAwIC8gNjAgKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgfSgpKTsKCiAgICB9CgogICAgLy8gYWRkIHRvdWNoIGNoZWNrZXIgdG8galF1ZXJ5LnN1cHBvcnQKICAgICQuc3VwcG9ydCA9ICQuc3VwcG9ydCB8fCB7fTsKICAgICQuZXh0ZW5kKCQuc3VwcG9ydCwgewogICAgICAgIHRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKICAgIH0pOwogICAgdmFyIHNlbGVjdFN0YXJ0ID0gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfTsKCiAgICB2YXIgZGVjZWxlcmF0ZVZlbG9jaXR5ID0gZnVuY3Rpb24odmVsb2NpdHksIHNsb3dkb3duKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5hYnModmVsb2NpdHkpKSA9PT0gMCA/IDAgLy8gaXMgdmVsb2NpdHkgbGVzcyB0aGFuIDE/CiAgICAgICAgICAgICAgIDogdmVsb2NpdHkgKiBzbG93ZG93bjsgLy8gcmVkdWNlIHNsb3dkb3duCiAgICB9OwoKICAgIHZhciBjYXBWZWxvY2l0eSA9IGZ1bmN0aW9uKHZlbG9jaXR5LCBtYXgpIHsKICAgICAgICB2YXIgbmV3VmVsb2NpdHkgPSB2ZWxvY2l0eTsKICAgICAgICBpZiAodmVsb2NpdHkgPiAwKSB7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSA+IG1heCkgewogICAgICAgICAgICAgICAgbmV3VmVsb2NpdHkgPSBtYXg7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodmVsb2NpdHkgPCAoMCAtIG1heCkpIHsKICAgICAgICAgICAgICAgIG5ld1ZlbG9jaXR5ID0gKDAgLSBtYXgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdWZWxvY2l0eTsKICAgIH07CgogICAgdmFyIHNldE1vdmVDbGFzc2VzID0gZnVuY3Rpb24oc2V0dGluZ3MsIGNsYXNzZXMpIHsKICAgICAgICB0aGlzLnJlbW92ZUNsYXNzKHNldHRpbmdzLm1vdmluZ0NsYXNzLnVwKQogICAgICAgICAgICAucmVtb3ZlQ2xhc3Moc2V0dGluZ3MubW92aW5nQ2xhc3MuZG93bikKICAgICAgICAgICAgLnJlbW92ZUNsYXNzKHNldHRpbmdzLm1vdmluZ0NsYXNzLmxlZnQpCiAgICAgICAgICAgIC5yZW1vdmVDbGFzcyhzZXR0aW5ncy5tb3ZpbmdDbGFzcy5yaWdodCkKICAgICAgICAgICAgLnJlbW92ZUNsYXNzKHNldHRpbmdzLmRlY2VsZXJhdGluZ0NsYXNzLnVwKQogICAgICAgICAgICAucmVtb3ZlQ2xhc3Moc2V0dGluZ3MuZGVjZWxlcmF0aW5nQ2xhc3MuZG93bikKICAgICAgICAgICAgLnJlbW92ZUNsYXNzKHNldHRpbmdzLmRlY2VsZXJhdGluZ0NsYXNzLmxlZnQpCiAgICAgICAgICAgIC5yZW1vdmVDbGFzcyhzZXR0aW5ncy5kZWNlbGVyYXRpbmdDbGFzcy5yaWdodCk7CgogICAgICAgIGlmIChzZXR0aW5ncy52ZWxvY2l0eSA+IDApIHsKICAgICAgICAgICAgdGhpcy5hZGRDbGFzcyhjbGFzc2VzLnJpZ2h0KTsKICAgICAgICB9CiAgICAgICAgaWYgKHNldHRpbmdzLnZlbG9jaXR5IDwgMCkgewogICAgICAgICAgICB0aGlzLmFkZENsYXNzKGNsYXNzZXMubGVmdCk7CiAgICAgICAgfQogICAgICAgIGlmIChzZXR0aW5ncy52ZWxvY2l0eVkgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuYWRkQ2xhc3MoY2xhc3Nlcy5kb3duKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNldHRpbmdzLnZlbG9jaXR5WSA8IDApIHsKICAgICAgICAgICAgdGhpcy5hZGRDbGFzcyhjbGFzc2VzLnVwKTsKICAgICAgICB9CgogICAgfTsKCiAgICB2YXIgc3RvcCA9IGZ1bmN0aW9uKCRzY3JvbGxlciwgc2V0dGluZ3MpIHsKICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eSA9IDA7CiAgICAgICAgc2V0dGluZ3MudmVsb2NpdHlZID0gMDsKICAgICAgICBzZXR0aW5ncy5kZWNlbGVyYXRlID0gdHJ1ZTsKICAgICAgICBpZiAodHlwZW9mIHNldHRpbmdzLnN0b3BwZWQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgc2V0dGluZ3Muc3RvcHBlZC5jYWxsKCRzY3JvbGxlciwgc2V0dGluZ3MpOwogICAgICAgIH0KICAgIH07CgogICAgLyoqIGRvIHRoZSBhY3R1YWwga2luZXRpYyBtb3ZlbWVudCAqLwogICAgdmFyIG1vdmUgPSBmdW5jdGlvbigkc2Nyb2xsZXIsIHNldHRpbmdzKSB7CiAgICAgICAgdmFyIHNjcm9sbGVyID0gJHNjcm9sbGVyWzBdOwogICAgICAgIC8vIHNldCBzY3JvbGxMZWZ0CiAgICAgICAgaWYgKHNldHRpbmdzLnggJiYgc2Nyb2xsZXIuc2Nyb2xsV2lkdGggPiAwKXsKICAgICAgICAgICAgc2Nyb2xsZXIuc2Nyb2xsTGVmdCA9IHNldHRpbmdzLnNjcm9sbExlZnQgPSBzY3JvbGxlci5zY3JvbGxMZWZ0ICsgc2V0dGluZ3MudmVsb2NpdHk7CiAgICAgICAgICAgIGlmIChNYXRoLmFicyhzZXR0aW5ncy52ZWxvY2l0eSkgPiAwKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eSA9IHNldHRpbmdzLmRlY2VsZXJhdGUgPwogICAgICAgICAgICAgICAgICAgIGRlY2VsZXJhdGVWZWxvY2l0eShzZXR0aW5ncy52ZWxvY2l0eSwgc2V0dGluZ3Muc2xvd2Rvd24pIDogc2V0dGluZ3MudmVsb2NpdHk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eSA9IDA7CiAgICAgICAgfQoKICAgICAgICAvLyBzZXQgc2Nyb2xsVG9wCiAgICAgICAgaWYgKHNldHRpbmdzLnkgJiYgc2Nyb2xsZXIuc2Nyb2xsSGVpZ2h0ID4gMCl7CiAgICAgICAgICAgIHNjcm9sbGVyLnNjcm9sbFRvcCA9IHNldHRpbmdzLnNjcm9sbFRvcCA9IHNjcm9sbGVyLnNjcm9sbFRvcCArIHNldHRpbmdzLnZlbG9jaXR5WTsKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHNldHRpbmdzLnZlbG9jaXR5WSkgPiAwKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eVkgPSBzZXR0aW5ncy5kZWNlbGVyYXRlID8KICAgICAgICAgICAgICAgICAgICBkZWNlbGVyYXRlVmVsb2NpdHkoc2V0dGluZ3MudmVsb2NpdHlZLCBzZXR0aW5ncy5zbG93ZG93bikgOiBzZXR0aW5ncy52ZWxvY2l0eVk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eVkgPSAwOwogICAgICAgIH0KCiAgICAgICAgc2V0TW92ZUNsYXNzZXMuY2FsbCgkc2Nyb2xsZXIsIHNldHRpbmdzLCBzZXR0aW5ncy5kZWNlbGVyYXRpbmdDbGFzcyk7CgogICAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MubW92ZWQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgc2V0dGluZ3MubW92ZWQuY2FsbCgkc2Nyb2xsZXIsIHNldHRpbmdzKTsKICAgICAgICB9CgogICAgICAgIGlmIChNYXRoLmFicyhzZXR0aW5ncy52ZWxvY2l0eSkgPiAwIHx8IE1hdGguYWJzKHNldHRpbmdzLnZlbG9jaXR5WSkgPiAwKSB7CiAgICAgICAgICAgIC8vIHRpY2sgZm9yIG5leHQgbW92ZW1lbnQKICAgICAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpeyBtb3ZlKCRzY3JvbGxlciwgc2V0dGluZ3MpOyB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdG9wKCRzY3JvbGxlciwgc2V0dGluZ3MpOwogICAgICAgIH0KICAgIH07CgogICAgdmFyIGNhbGxPcHRpb24gPSBmdW5jdGlvbihtZXRob2QsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgbWV0aG9kRm4gPSAkLmtpbmV0aWMuY2FsbE1ldGhvZHNbbWV0aG9kXSwKICAgICAgICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykKICAgICAgICA7CiAgICAgICAgaWYgKG1ldGhvZEZuKSB7CiAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgdmFyIG9wdHMgPSBhcmdzLnNsaWNlKDEpLCBzZXR0aW5ncyA9ICQodGhpcykuZGF0YShTRVRUSU5HU19LRVkpOwogICAgICAgICAgICAgICAgb3B0cy51bnNoaWZ0KHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIG1ldGhvZEZuLmFwcGx5KHRoaXMsIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKICAgIHZhciBhdHRhY2hMaXN0ZW5lcnMgPSBmdW5jdGlvbigkdGhpcywgc2V0dGluZ3MpIHsKICAgICAgICB2YXIgZWxlbWVudCA9ICR0aGlzWzBdOwogICAgICAgIGlmICgkLnN1cHBvcnQudG91Y2gpIHsKICAgICAgICAgICAgJHRoaXMuYmluZCgndG91Y2hzdGFydCcsIHNldHRpbmdzLmV2ZW50cy50b3VjaFN0YXJ0KQogICAgICAgICAgICAgICAgLmJpbmQoJ3RvdWNoZW5kJywgc2V0dGluZ3MuZXZlbnRzLmlucHV0RW5kKQogICAgICAgICAgICAgICAgLmJpbmQoJ3RvdWNobW92ZScsIHNldHRpbmdzLmV2ZW50cy50b3VjaE1vdmUpCiAgICAgICAgICAgIDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkdGhpcwogICAgICAgICAgICAgICAgLm1vdXNlZG93bihzZXR0aW5ncy5ldmVudHMuaW5wdXREb3duKQogICAgICAgICAgICAgICAgLm1vdXNldXAoc2V0dGluZ3MuZXZlbnRzLmlucHV0RW5kKQogICAgICAgICAgICAgICAgLm1vdXNlbW92ZShzZXR0aW5ncy5ldmVudHMuaW5wdXRNb3ZlKQogICAgICAgICAgICA7CiAgICAgICAgfQogICAgICAgICR0aGlzCiAgICAgICAgICAgIC5jbGljayhzZXR0aW5ncy5ldmVudHMuaW5wdXRDbGljaykKICAgICAgICAgICAgLnNjcm9sbChzZXR0aW5ncy5ldmVudHMuc2Nyb2xsKQogICAgICAgICAgICAuYmluZCgic2VsZWN0c3RhcnQiLCBzZWxlY3RTdGFydCkgLy8gcHJldmVudCBzZWxlY3Rpb24gd2hlbiBkcmFnZ2luZwogICAgICAgICAgICAuYmluZCgnZHJhZ3N0YXJ0Jywgc2V0dGluZ3MuZXZlbnRzLmRyYWdTdGFydCk7CiAgICB9OwogICAgdmFyIGRldGFjaExpc3RlbmVycyA9IGZ1bmN0aW9uKCR0aGlzLCBzZXR0aW5ncykgewogICAgICAgIHZhciBlbGVtZW50ID0gJHRoaXNbMF07CiAgICAgICAgaWYgKCQuc3VwcG9ydC50b3VjaCkgewogICAgICAgICAgICAkdGhpcy51bmJpbmQoJ3RvdWNoc3RhcnQnLCBzZXR0aW5ncy5ldmVudHMudG91Y2hTdGFydCkKICAgICAgICAgICAgICAgIC51bmJpbmQoJ3RvdWNoZW5kJywgc2V0dGluZ3MuZXZlbnRzLmlucHV0RW5kKQogICAgICAgICAgICAgICAgLnVuYmluZCgndG91Y2htb3ZlJywgc2V0dGluZ3MuZXZlbnRzLnRvdWNoTW92ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJHRoaXMKICAgICAgICAgICAgLnVuYmluZCgnbW91c2Vkb3duJywgc2V0dGluZ3MuZXZlbnRzLmlucHV0RG93bikKICAgICAgICAgICAgLnVuYmluZCgnbW91c2V1cCcsIHNldHRpbmdzLmV2ZW50cy5pbnB1dEVuZCkKICAgICAgICAgICAgLnVuYmluZCgnbW91c2Vtb3ZlJywgc2V0dGluZ3MuZXZlbnRzLmlucHV0TW92ZSkKICAgICAgICAgICAgLnVuYmluZCgnc2Nyb2xsJywgc2V0dGluZ3MuZXZlbnRzLnNjcm9sbCk7CiAgICAgICAgfQogICAgICAgICR0aGlzLnVuYmluZCgnY2xpY2snLCBzZXR0aW5ncy5ldmVudHMuaW5wdXRDbGljaykKICAgICAgICAudW5iaW5kKCJzZWxlY3RzdGFydCIsIHNlbGVjdFN0YXJ0KTsgLy8gcHJldmVudCBzZWxlY3Rpb24gd2hlbiBkcmFnZ2luZwogICAgICAgICR0aGlzLnVuYmluZCgnZHJhZ3N0YXJ0Jywgc2V0dGluZ3MuZXZlbnRzLmRyYWdTdGFydCk7CiAgICB9OwoKICAgIHZhciBpbml0RWxlbWVudHMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgdGhpcwogICAgICAgIC5hZGRDbGFzcyhBQ1RJVkVfQ0xBU1MpCiAgICAgICAgLmVhY2goZnVuY3Rpb24oKXsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgICR0aGlzID0gJCh0aGlzKTsKCiAgICAgICAgICAgIGlmICgkdGhpcy5kYXRhKFNFVFRJTkdTX0tFWSkpewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSAkLmV4dGVuZCh7fSwgREVGQVVMVF9TRVRUSU5HUywgb3B0aW9ucyksCiAgICAgICAgICAgICAgICB4cG9zLAogICAgICAgICAgICAgICAgcHJldlhQb3MgPSBmYWxzZSwKICAgICAgICAgICAgICAgIHlwb3MsCiAgICAgICAgICAgICAgICBwcmV2WVBvcyA9IGZhbHNlLAogICAgICAgICAgICAgICAgbW91c2VEb3duID0gZmFsc2UsCiAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgc2Nyb2xsVG9wLAogICAgICAgICAgICAgICAgdGhyb3R0bGVUaW1lb3V0ID0gMTAwMCAvIHNldHRpbmdzLnRocm90dGxlRlBTLAogICAgICAgICAgICAgICAgbGFzdE1vdmUsCiAgICAgICAgICAgICAgICBlbGVtZW50Rm9jdXNlZAogICAgICAgICAgICA7CgogICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eSA9IDA7CiAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5WSA9IDA7CgogICAgICAgICAgICAvLyBtYWtlIHN1cmUgd2UgcmVzZXQgZXZlcnl0aGluZyB3aGVuIG1vdXNlIHVwCiAgICAgICAgICAgIHZhciByZXNldE1vdXNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB4cG9zID0gZmFsc2U7CiAgICAgICAgICAgICAgICB5cG9zID0gZmFsc2U7CiAgICAgICAgICAgICAgICBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgJChkb2N1bWVudCkubW91c2V1cChyZXNldE1vdXNlKS5jbGljayhyZXNldE1vdXNlKTsKCiAgICAgICAgICAgIHZhciBjYWxjdWxhdGVWZWxvY2l0aWVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eSAgICA9IGNhcFZlbG9jaXR5KHByZXZYUG9zIC0geHBvcywgc2V0dGluZ3MubWF4dmVsb2NpdHkpOwogICAgICAgICAgICAgICAgc2V0dGluZ3MudmVsb2NpdHlZICAgPSBjYXBWZWxvY2l0eShwcmV2WVBvcyAtIHlwb3MsIHNldHRpbmdzLm1heHZlbG9jaXR5KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHVzZVRhcmdldCA9IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICAgICAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihzZXR0aW5ncy5maWx0ZXJUYXJnZXQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNldHRpbmdzLmZpbHRlclRhcmdldC5jYWxsKHNlbGYsIHRhcmdldCkgIT09IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBzdGFydCA9IGZ1bmN0aW9uKGNsaWVudFgsIGNsaWVudFkpIHsKICAgICAgICAgICAgICAgIG1vdXNlRG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy52ZWxvY2l0eSA9IHByZXZYUG9zID0gMDsKICAgICAgICAgICAgICAgIHNldHRpbmdzLnZlbG9jaXR5WSA9IHByZXZZUG9zID0gMDsKICAgICAgICAgICAgICAgIHhwb3MgPSBjbGllbnRYOwogICAgICAgICAgICAgICAgeXBvcyA9IGNsaWVudFk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBlbmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh4cG9zICYmIHByZXZYUG9zICYmIHNldHRpbmdzLmRlY2VsZXJhdGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MuZGVjZWxlcmF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY2FsY3VsYXRlVmVsb2NpdGllcygpOwogICAgICAgICAgICAgICAgICAgIHhwb3MgPSBwcmV2WFBvcyA9IG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIG1vdmUoJHRoaXMsIHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGlucHV0bW92ZSA9IGZ1bmN0aW9uKGNsaWVudFgsIGNsaWVudFkpIHsKICAgICAgICAgICAgICAgIGlmICghbGFzdE1vdmUgfHwgbmV3IERhdGUoKSA+IG5ldyBEYXRlKGxhc3RNb3ZlLmdldFRpbWUoKSArIHRocm90dGxlVGltZW91dCkpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0TW92ZSA9IG5ldyBEYXRlKCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZURvd24gJiYgKHhwb3MgfHwgeXBvcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRGb2N1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGVsZW1lbnRGb2N1c2VkKS5ibHVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Rm9jdXNlZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGhpcy5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLmRlY2VsZXJhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MudmVsb2NpdHkgICA9IHNldHRpbmdzLnZlbG9jaXR5WSAgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAkdGhpc1swXS5zY3JvbGxMZWZ0ID0gc2V0dGluZ3Muc2Nyb2xsTGVmdCA9IHNldHRpbmdzLnggPyAkdGhpc1swXS5zY3JvbGxMZWZ0IC0gKGNsaWVudFggLSB4cG9zKSA6ICR0aGlzWzBdLnNjcm9sbExlZnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICR0aGlzWzBdLnNjcm9sbFRvcCAgPSBzZXR0aW5ncy5zY3JvbGxUb3AgID0gc2V0dGluZ3MueSA/ICR0aGlzWzBdLnNjcm9sbFRvcCAtIChjbGllbnRZIC0geXBvcykgIDogJHRoaXNbMF0uc2Nyb2xsVG9wOwogICAgICAgICAgICAgICAgICAgICAgICBwcmV2WFBvcyA9IHhwb3M7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZZUG9zID0geXBvczsKICAgICAgICAgICAgICAgICAgICAgICAgeHBvcyA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgICAgIHlwb3MgPSBjbGllbnRZOwoKICAgICAgICAgICAgICAgICAgICAgICAgY2FsY3VsYXRlVmVsb2NpdGllcygpOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRNb3ZlQ2xhc3Nlcy5jYWxsKCR0aGlzLCBzZXR0aW5ncywgc2V0dGluZ3MubW92aW5nQ2xhc3MpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5tb3ZlZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MubW92ZWQuY2FsbCgkdGhpcywgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRXZlbnRzCiAgICAgICAgICAgIHNldHRpbmdzLmV2ZW50cyA9IHsKICAgICAgICAgICAgICAgIHRvdWNoU3RhcnQ6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgICAgIHZhciB0b3VjaDsKICAgICAgICAgICAgICAgICAgICBpZiAodXNlVGFyZ2V0KGUudGFyZ2V0KSkgewogICAgICAgICAgICAgICAgICAgICAgICB0b3VjaCA9IGUub3JpZ2luYWxFdmVudC50b3VjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCh0b3VjaC5jbGllbnRYLCB0b3VjaC5jbGllbnRZKTsKICAgICAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdG91Y2hNb3ZlOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgICAgICB2YXIgdG91Y2g7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdXNlRG93bikgewogICAgICAgICAgICAgICAgICAgICAgICB0b3VjaCA9IGUub3JpZ2luYWxFdmVudC50b3VjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dG1vdmUodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLnByZXZlbnREZWZhdWx0KSB7ZS5wcmV2ZW50RGVmYXVsdCgpO30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5wdXREb3duOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgICAgICBpZiAodXNlVGFyZ2V0KGUudGFyZ2V0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGb2N1c2VkID0gZS50YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5ub2RlTmFtZSA9PT0gJ0lNRycpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlucHV0RW5kOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgICAgICBlbmQoKTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50Rm9jdXNlZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKGUucHJldmVudERlZmF1bHQpIHtlLnByZXZlbnREZWZhdWx0KCk7fQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlucHV0TW92ZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZURvd24pewogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dG1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCkge2UucHJldmVudERlZmF1bHQoKTt9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNjcm9sbDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MubW92ZWQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MubW92ZWQuY2FsbCgkdGhpcywgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCkge2UucHJldmVudERlZmF1bHQoKTt9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5wdXRDbGljazogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHNldHRpbmdzLnZlbG9jaXR5KSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIHByZXZlbnQgZHJhZyBhbmQgZHJvcCBpbWFnZXMgaW4gaWUKICAgICAgICAgICAgICAgIGRyYWdTdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Rm9jdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXR0YWNoTGlzdGVuZXJzKCR0aGlzLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICR0aGlzLmRhdGEoU0VUVElOR1NfS0VZLCBzZXR0aW5ncykKICAgICAgICAgICAgICAgIC5jc3MoImN1cnNvciIsIHNldHRpbmdzLmN1cnNvcik7CgogICAgICAgICAgICBpZiAoc2V0dGluZ3MudHJpZ2dlckhhcmR3YXJlKSB7CiAgICAgICAgICAgICAgICAkdGhpcy5jc3MoewogICAgICAgICAgICAgICAgICAgICctd2Via2l0LXRyYW5zZm9ybSc6ICd0cmFuc2xhdGUzZCgwLDAsMCknLAogICAgICAgICAgICAgICAgICAgICctd2Via2l0LXBlcnNwZWN0aXZlJzogJzEwMDAnLAogICAgICAgICAgICAgICAgICAgICctd2Via2l0LWJhY2tmYWNlLXZpc2liaWxpdHknOiAnaGlkZGVuJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH07CgogICAgJC5raW5ldGljID0gewogICAgICAgIHNldHRpbmdzS2V5OiBTRVRUSU5HU19LRVksCiAgICAgICAgY2FsbE1ldGhvZHM6IHsKICAgICAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uKHNldHRpbmdzLCBvcHRpb25zKXsKICAgICAgICAgICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyk7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9ICQuZXh0ZW5kKHNldHRpbmdzLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIGlmIChzZXR0aW5ncykgewogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLmRlY2VsZXJhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBtb3ZlKCR0aGlzLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVuZDogZnVuY3Rpb24oc2V0dGluZ3MsIG9wdGlvbnMpewogICAgICAgICAgICAgICAgdmFyICR0aGlzID0gJCh0aGlzKTsKICAgICAgICAgICAgICAgIGlmIChzZXR0aW5ncykgewogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLmRlY2VsZXJhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wOiBmdW5jdGlvbihzZXR0aW5ncywgb3B0aW9ucyl7CiAgICAgICAgICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpOwogICAgICAgICAgICAgICAgc3RvcCgkdGhpcywgc2V0dGluZ3MpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZXRhY2g6IGZ1bmN0aW9uKHNldHRpbmdzLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpOwogICAgICAgICAgICAgICAgZGV0YWNoTGlzdGVuZXJzKCR0aGlzLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAkdGhpcwogICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKEFDVElWRV9DTEFTUykKICAgICAgICAgICAgICAgIC5jc3MoImN1cnNvciIsICIiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYXR0YWNoOiBmdW5jdGlvbihzZXR0aW5ncywgb3B0aW9ucykgewogICAgICAgICAgICAgICAgdmFyICR0aGlzID0gJCh0aGlzKTsKICAgICAgICAgICAgICAgIGF0dGFjaExpc3RlbmVycygkdGhpcywgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgJHRoaXMKICAgICAgICAgICAgICAgIC5hZGRDbGFzcyhBQ1RJVkVfQ0xBU1MpCiAgICAgICAgICAgICAgICAuY3NzKCJjdXJzb3IiLCAibW92ZSIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgICQuZm4ua2luZXRpYyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNhbGxPcHRpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbml0RWxlbWVudHMuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKfSh3aW5kb3cualF1ZXJ5IHx8IHdpbmRvdy5aZXB0bykpOwoKLyoqCiogICAgICBFdmVudHMuIFB1Yi9TdWIgc3lzdGVtIGZvciBMb29zZWx5IENvdXBsZWQgbG9naWMuCiogICAgICBCYXNlZCBvbiBQZXRlciBIaWdnaW5zJyBwb3J0IGZyb20gRG9qbyB0byBqUXVlcnkKKiAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9waGlnZ2luczQyL2Jsb29keS1qcXVlcnktcGx1Z2lucy9ibG9iL21hc3Rlci9wdWJzdWIuanMKKgoqICAgICAgUmUtYWRhcHRlZCB0byB2YW5pbGxhIEphdmFzY3JpcHQKKgoqICAgICAgQGNsYXNzIEV2ZW50cwoqLwp2YXIgZGl2YSA9IChmdW5jdGlvbigpIHsKICAgIHZhciBjYWNoZSA9IHt9OwogICAgdmFyIHB1YiA9IHsKICAgICAgICBFdmVudHM6IHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqICAgICAgZGl2YS5FdmVudHMucHVibGlzaAogICAgICAgICAgICAgKiAgICAgIGUuZy46IGRpdmEuRXZlbnRzLnB1Ymxpc2goIlBhZ2VEaWRMb2FkIiwgW3BhZ2VJbmRleCwgZmlsZW5hbWUsIHBhZ2VTZWxlY3Rvcl0sIHRoaXMpOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAgIEBjbGFzcyBFdmVudHMKICAgICAgICAgICAgICogICAgICBAbWV0aG9kIHB1Ymxpc2gKICAgICAgICAgICAgICogICAgICBAcGFyYW0gdG9waWMge1N0cmluZ30KICAgICAgICAgICAgICogICAgICBAcGFyYW0gYXJncyAgICAge0FycmF5fQogICAgICAgICAgICAgKiAgICAgIEBwYXJhbSBzY29wZSB7T2JqZWN0fSBPcHRpb25hbAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcHVibGlzaDogZnVuY3Rpb24gKHRvcGljLCBhcmdzLCBzY29wZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGNhY2hlW3RvcGljXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGhpc1RvcGljID0gY2FjaGVbdG9waWNdLAogICAgICAgICAgICAgICAgICAgICAgICBpID0gdGhpc1RvcGljLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGktLSkKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1RvcGljW2ldLmFwcGx5KCBzY29wZSB8fCB0aGlzLCBhcmdzIHx8IFtdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqICAgICAgZGl2YS5FdmVudHMuc3Vic2NyaWJlCiAgICAgICAgICAgICAqICAgICAgZS5nLjogZGl2YS5FdmVudHMuc3Vic2NyaWJlKCJQYWdlRGlkTG9hZCIsIGhpZ2hsaWdodCkKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgICBAY2xhc3MgRXZlbnRzCiAgICAgICAgICAgICAqICAgICAgQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICAgICAgICogICAgICBAcGFyYW0gdG9waWMge1N0cmluZ30KICAgICAgICAgICAgICogICAgICBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgICAgICAgICAgKiAgICAgIEByZXR1cm4gRXZlbnQgaGFuZGxlciB7QXJyYXl9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzdWJzY3JpYmU6IGZ1bmN0aW9uICh0b3BpYywgY2FsbGJhY2spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghY2FjaGVbdG9waWNdKQogICAgICAgICAgICAgICAgICAgIGNhY2hlW3RvcGljXSA9IFtdOwoKICAgICAgICAgICAgICAgIGNhY2hlW3RvcGljXS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgIHJldHVybiBbdG9waWMsIGNhbGxiYWNrXTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqICAgICAgZGl2YS5FdmVudHMudW5zdWJzY3JpYmUKICAgICAgICAgICAgICogICAgICBlLmcuOiB2YXIgaGFuZGxlID0gRXZlbnRzLnN1YnNjcmliZSgiUGFnZURpZExvYWQiLCBoaWdobGlnaHQpOwogICAgICAgICAgICAgKiAgICAgICAgICAgICAgRXZlbnRzLnVuc3Vic2NyaWJlKGhhbmRsZSk7CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICAgQGNsYXNzIEV2ZW50cwogICAgICAgICAgICAgKiAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICAgICAgICogICAgICBAcGFyYW0gaGFuZGxlIHtBcnJheX0KICAgICAgICAgICAgICogICAgICBAcGFyYW0gY29tcGxldGVseSB7Qm9vbGVhbn0gLSBVbnN1YnNjcmliZSBhbGwgZXZlbnRzIGZvciBhIGdpdmVuIHRvcGljLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdW5zdWJzY3JpYmU6IGZ1bmN0aW9uIChoYW5kbGUsIGNvbXBsZXRlbHkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gaGFuZGxlWzBdLAogICAgICAgICAgICAgICAgICAgIGkgPSBjYWNoZVt0XS5sZW5ndGg7CgogICAgICAgICAgICAgICAgaWYgKGNhY2hlW3RdKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChpLS0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVbdF1baV0gPT09IGhhbmRsZVsxXSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVbdF0uc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBsZXRlbHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhY2hlW3RdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogICAgICBkaXZhLkV2ZW50cy51bnN1YnNjcmliZUFsbAogICAgICAgICAgICAgKiAgICAgIGUuZy46IGRpdmEuRXZlbnRzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICAgQGNsYXNzIEV2ZW50cwogICAgICAgICAgICAgKiAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHVuc3Vic2NyaWJlQWxsOiBmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjYWNoZSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIHJldHVybiBwdWI7Cn0oKSk7Cgp2YXIgbXVsdGlEaXZhOwoKdmFyIG11bHRpRGl2YUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKQp7CiAgICB2YXIgYWN0aXZlOwoKICAgICQoZG9jdW1lbnQpLm9uKCdjbGljaycsIGZ1bmN0aW9uKGUpCiAgICB7CiAgICAgICAgdXBkYXRlQWN0aXZlKCQoZS50YXJnZXQpKTsKICAgIH0pOwoKICAgIC8vcGFyYW1ldGVyIHNob3VsZCBhbHJlYWR5IGJlIHNlbGVjdGVkIGluIGpRdWVyeQogICAgdmFyIHVwZGF0ZUFjdGl2ZSA9IGZ1bmN0aW9uICh0YXJnZXQpCiAgICB7CiAgICAgICAgdmFyIG5lYXJlc3RPdXRlcjsKCiAgICAgICAgLy90aGVzZSB3aWxsIGZpbmQgMCBvciAxIG9iamVjdHMsIG5ldmVyIG1vcmUKICAgICAgICB2YXIgZmluZE91dGVyID0gdGFyZ2V0LmZpbmQoJy5kaXZhLW91dGVyJyk7CiAgICAgICAgdmFyIGNsb3Nlc3RPdXRlciA9IHRhcmdldC5jbG9zZXN0KCcuZGl2YS1vdXRlcicpOwoKICAgICAgICBpZiAoZmluZE91dGVyLmxlbmd0aCA+IDApIC8vY2xpY2tlZCBvbiBzb21ldGhpbmcgdGhhdCB3YXMgbm90IGVpdGhlciBhIHBhcmVudCBvciBzaWJsaW5nIG9mIGRpdmEtb3V0ZXIKICAgICAgICB7CiAgICAgICAgICAgIG5lYXJlc3RPdXRlciA9IGZpbmRPdXRlcjsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY2xvc2VzdE91dGVyLmxlbmd0aCA+IDApIC8vY2xpY2tlZCBvbiBzb21ldGhpbmcgdGhhdCB3YXMgYSBjaGlsZCBvZiBkaXZhLW91dGVyCiAgICAgICAgewogICAgICAgICAgICBuZWFyZXN0T3V0ZXIgPSBjbG9zZXN0T3V0ZXI7CiAgICAgICAgfQogICAgICAgIGVsc2UgLy9jbGlja2VkIG9uIHNvbWV0aGluZyB1bnJlbGF0ZWQKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vYWN0aXZhdGUgdGhpcyBvbmUKICAgICAgICBuZWFyZXN0T3V0ZXIucGFyZW50KCkuZGF0YSgnZGl2YScpLmFjdGl2YXRlKCk7CiAgICAgICAgYWN0aXZlID0gbmVhcmVzdE91dGVyLnBhcmVudCgpOwoKICAgICAgICAvL2RlYWN0aXZhdGUgYWxsIHRoZSBvdGhlcnMKICAgICAgICB2YXIgY3VyT3V0ZXIgPSAkKCIuZGl2YS1vdXRlciIpLmxlbmd0aDsKICAgICAgICB3aGlsZSAoY3VyT3V0ZXItLSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICgkKCQoIi5kaXZhLW91dGVyIilbY3VyT3V0ZXJdKS5hdHRyKCdpZCcpICE9IG5lYXJlc3RPdXRlci5hdHRyKCdpZCcpKQogICAgICAgICAgICAgICAgJCgkKCIuZGl2YS1vdXRlciIpW2N1ck91dGVyXSkucGFyZW50KCkuZGF0YSgnZGl2YScpLmRlYWN0aXZhdGUoKTsKICAgICAgICB9CiAgICB9OwoKICAgIHRoaXMuZ2V0QWN0aXZlID0gZnVuY3Rpb24oKQogICAgewogICAgICAgIHJldHVybiBhY3RpdmU7CiAgICB9Owp9OwoKZGl2YS5FdmVudHMuc3Vic2NyaWJlKCJWaWV3ZXJEaWRMb2FkIiwgZnVuY3Rpb24oc2V0dGluZ3MpCnsKICAgIGlmKCQoIi5kaXZhLW91dGVyIikubGVuZ3RoID4gMSl7CiAgICAgICAgLy9tYWtlIHN1cmUgdGhlcmUncyBvbmx5IG9uZSBhY3RpdmUgZGl2YTsgZGVhY3RpdmF0ZSBhbnkgbmV3ZXIgb25lcwogICAgICAgIHRoaXMuZGVhY3RpdmF0ZSgpOwoKICAgICAgICAvL2NyZWF0ZSB0aGUgY29udHJvbGxlciBpZiBpdCBkb2Vzbid0IGFscmVhZHkgZXhpc3QKICAgICAgICBpZighbXVsdGlEaXZhKQogICAgICAgICAgICBtdWx0aURpdmEgPSBuZXcgbXVsdGlEaXZhQ29udHJvbGxlcigpOwogICAgfQp9KTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 21:44:04 GMT",
                    "Content-Length": "29165",
                    "Date": "Thu, 06 Nov 2014 21:44:05 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}