{
    "url": "http://localhost:9999/terribleplan/Typertext/build/typertext.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>l.href = location;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/terribleplan/Typertext/build/typertext.js",
                "path": "/terribleplan/Typertext/build/typertext.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC90ZXJyaWJsZXBsYW4vVHlwZXJ0ZXh0L2J1aWxkL3R5cGVydGV4dC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjM2MTUNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDA6MDQ6MjIgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAwOjA0OjIyIEdNVA0KDQp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgdmFyIEJhc2VFeGNlcHRpb24gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEJhc2VFeGNlcHRpb24obWVzc2FnZSwgY29kZSwgY3VzdG9tKSB7CiAgICAgICAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgICAgICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgICAgICAgICAgIHRoaXMuY3VzdG9tID0gY3VzdG9tOwogICAgICAgIH0KICAgICAgICBCYXNlRXhjZXB0aW9uLnByb3RvdHlwZS5HZXRDb2RlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jb2RlOwogICAgICAgIH07CgogICAgICAgIEJhc2VFeGNlcHRpb24ucHJvdG90eXBlLkdldE1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2U7CiAgICAgICAgfTsKCiAgICAgICAgQmFzZUV4Y2VwdGlvbi5wcm90b3R5cGUuR2V0Q3VzdG9tID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jdXN0b207CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gQmFzZUV4Y2VwdGlvbjsKICAgIH0pKCk7CiAgICBUeXBlcnRleHQuQmFzZUV4Y2VwdGlvbiA9IEJhc2VFeGNlcHRpb247Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIHZhciBHZW5lcmljUmVzcG9uc2UgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEdlbmVyaWNSZXNwb25zZShzdGF0dXMsIHJlc3BvbnNlSGVhZGVyR2V0dGVyLCBodHRwUmVzcG9uc2VDb2RlLCByZXNwb25zZUJvZHkpIHsKICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgIHRoaXMuaGVhZGVycyA9IHJlc3BvbnNlSGVhZGVyR2V0dGVyOwogICAgICAgICAgICB0aGlzLmh0dHBTdGF0dXMgPSBodHRwUmVzcG9uc2VDb2RlOwogICAgICAgICAgICB0aGlzLmNvbnRlbnQgPSByZXNwb25zZUJvZHk7CiAgICAgICAgfQogICAgICAgIEdlbmVyaWNSZXNwb25zZS5wcm90b3R5cGUuR2V0Q29udGVudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudDsKICAgICAgICB9OwoKICAgICAgICBHZW5lcmljUmVzcG9uc2UucHJvdG90eXBlLkdldENvbnRlbnRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5HZXRIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwogICAgICAgIH07CgogICAgICAgIEdlbmVyaWNSZXNwb25zZS5wcm90b3R5cGUuR2V0SGVhZGVyID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGVhZGVycyhuYW1lKTsKICAgICAgICB9OwoKICAgICAgICBHZW5lcmljUmVzcG9uc2UucHJvdG90eXBlLkdldEh0dHBTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHBTdGF0dXM7CiAgICAgICAgfTsKCiAgICAgICAgR2VuZXJpY1Jlc3BvbnNlLnByb3RvdHlwZS5HZXRTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YXR1czsKICAgICAgICB9OwogICAgICAgIHJldHVybiBHZW5lcmljUmVzcG9uc2U7CiAgICB9KSgpOwogICAgVHlwZXJ0ZXh0LkdlbmVyaWNSZXNwb25zZSA9IEdlbmVyaWNSZXNwb25zZTsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChIdHRwKSB7CiAgICAgICAgKGZ1bmN0aW9uIChIdHRwTWV0aG9kKSB7CiAgICAgICAgICAgIEh0dHBNZXRob2RbSHR0cE1ldGhvZFsiREVMRVRFIl0gPSAwXSA9ICJERUxFVEUiOwogICAgICAgICAgICBIdHRwTWV0aG9kW0h0dHBNZXRob2RbIkdFVCJdID0gMV0gPSAiR0VUIjsKICAgICAgICAgICAgSHR0cE1ldGhvZFtIdHRwTWV0aG9kWyJIRUFEIl0gPSAyXSA9ICJIRUFEIjsKICAgICAgICAgICAgSHR0cE1ldGhvZFtIdHRwTWV0aG9kWyJPUFRJT05TIl0gPSAzXSA9ICJPUFRJT05TIjsKICAgICAgICAgICAgSHR0cE1ldGhvZFtIdHRwTWV0aG9kWyJQT1NUIl0gPSA0XSA9ICJQT1NUIjsKICAgICAgICAgICAgSHR0cE1ldGhvZFtIdHRwTWV0aG9kWyJQVVQiXSA9IDVdID0gIlBVVCI7CiAgICAgICAgICAgIEh0dHBNZXRob2RbSHR0cE1ldGhvZFsiVFJBQ0UiXSA9IDZdID0gIlRSQUNFIjsKICAgICAgICB9KShIdHRwLkh0dHBNZXRob2QgfHwgKEh0dHAuSHR0cE1ldGhvZCA9IHt9KSk7CiAgICAgICAgdmFyIEh0dHBNZXRob2QgPSBIdHRwLkh0dHBNZXRob2Q7CiAgICB9KShUeXBlcnRleHQuSHR0cCB8fCAoVHlwZXJ0ZXh0Lkh0dHAgPSB7fSkpOwogICAgdmFyIEh0dHAgPSBUeXBlcnRleHQuSHR0cDsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChIdHRwKSB7CiAgICAgICAgdmFyIEh0dHBVcmwgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiBIdHRwVXJsKGRvbWFpbiwgcHJvdG9jb2wsIHBhdGgsIHF1ZXJ5U3RyaW5nLCBwb3J0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3RvY29sID09PSAidW5kZWZpbmVkIikgeyBwcm90b2NvbCA9IDAgLyogaHR0cCAqLzsgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXRoID09PSAidW5kZWZpbmVkIikgeyBwYXRoID0gIi8iOyB9CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHF1ZXJ5U3RyaW5nID09PSAidW5kZWZpbmVkIikgeyBxdWVyeVN0cmluZyA9IHt9OyB9CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBvcnQgPT09ICJ1bmRlZmluZWQiKSB7IHBvcnQgPSAwOyB9CiAgICAgICAgICAgICAgICBpZiAocG9ydCA8IDEgfHwgcG9ydCA+IDY1NTM1IHx8IGlzTmFOKHBvcnQpKSB7CiAgICAgICAgICAgICAgICAgICAgcG9ydCA9IEh0dHBVcmwuRGVmYXVsdFBvcnQocHJvdG9jb2wpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChwYXRoLmluZGV4T2YoIi8iKSAhPSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcGF0aCA9ICIvIiArIHBhdGg7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5kb21haW4gPSBkb21haW47CiAgICAgICAgICAgICAgICB0aGlzLnByb3RvY29sID0gcHJvdG9jb2w7CiAgICAgICAgICAgICAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgICAgICAgICAgICAgdGhpcy5xdWVyeVN0cmluZyA9IHF1ZXJ5U3RyaW5nOwogICAgICAgICAgICAgICAgdGhpcy5wb3J0ID0gcG9ydDsKICAgICAgICAgICAgfQogICAgICAgICAgICBIdHRwVXJsLkRlZmF1bHRQb3J0ID0gZnVuY3Rpb24gKHByb3RvY29sKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHByb3RvY29sKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAwIC8qIGh0dHAgKi86CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiA4MDsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEgLyogaHR0cHMgKi86CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiA0NDM7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFVybC5Gcm9tVXJsID0gZnVuY3Rpb24gKGxvY2F0aW9uKSB7CiAgICAgICAgICAgICAgICB2YXIgbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgICAgICAgICAgIGwuaHJlZiA9IGxvY2F0aW9uOwogICAgICAgICAgICAgICAgaWYgKCFsLmhvc3RuYW1lIHx8ICFsLnByb3RvY29sIHx8ICFsLnBhdGhuYW1lIHx8ICFsLnNlYXJjaCB8fCAhbC5wb3J0KSB7CiAgICAgICAgICAgICAgICAgICAgbC5ocmVmID0gbC5ocmVmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBIdHRwVXJsKGwuaG9zdG5hbWUsIFR5cGVydGV4dC5IdHRwLkh0dHBQcm90b2NvbFtsLnByb3RvY29sLnNsaWNlKDAsIC0xKV0sIGwucGF0aG5hbWUsIEh0dHBVcmwuRGVjb2RlUXVlcnlTdHJpbmcobC5zZWFyY2gpLCBwYXJzZUludChsLnBvcnQpKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwuRGVjb2RlUXVlcnlTdHJpbmcgPSBmdW5jdGlvbiAocXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgICAgIGlmIChxdWVyeVN0cmluZy5pbmRleE9mKCI/IikgPT0gMCkgewogICAgICAgICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nID0gcXVlcnlTdHJpbmcuc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBIdHRwVXJsLlVybERlY29kZVN0cmluZyhxdWVyeVN0cmluZyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwVXJsLkVuY29kZVF1ZXJ5U3RyaW5nID0gZnVuY3Rpb24gKHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICB2YXIgcnMgPSAiPyIgKyBIdHRwVXJsLlVybEVuY29kZU9iamVjdChxdWVyeSk7CiAgICAgICAgICAgICAgICByZXR1cm4gKChycy5sZW5ndGggPT0gMSkgPyAiIiA6IHJzKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwuVXJsRW5jb2RlT2JqZWN0ID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIHZhciBycyA9ICIiOwogICAgICAgICAgICAgICAgdmFyIHRlbXA7CgogICAgICAgICAgICAgICAgZm9yICh0ZW1wIGluIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY3VyID0gZGF0YVt0ZW1wXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdXIgIT09ICJvYmplY3QiICYmIHR5cGVvZiBjdXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcnMgKz0gZW5jb2RlVVJJQ29tcG9uZW50KHRlbXApICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KGN1cikgKyAiJiI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGN1ciBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY3VyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGN1cltpXSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIGN1cltpXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJzICs9IGVuY29kZVVSSUNvbXBvbmVudCh0ZW1wKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudChjdXJbaV0pICsgIiYiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBycy5zbGljZSgwLCAtMSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwVXJsLlVybERlY29kZVN0cmluZyA9IGZ1bmN0aW9uIChxdWVyeVN0cmluZykgewogICAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlID0ge30sIHBhcmFtcyA9IEh0dHBVcmwuc3BsaXRTdHJpbmcocXVlcnlTdHJpbmcsICImIik7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXNbaV0gPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYW0gPSBIdHRwVXJsLnNwbGl0U3RyaW5nKHBhcmFtc1tpXSwgIj0iLCAyKTsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtWzBdKTsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW0ubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVmFsdWVba2V5XSA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlW2tleV0gPSBkZWNvZGVVUklDb21wb25lbnQocGFyYW1bMV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5WYWx1ZTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwuc3BsaXRTdHJpbmcgPSBmdW5jdGlvbiAoaW5wdXQsIHNlcGFyYXRvciwgbGltaXQpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbGltaXQgPT09ICJ1bmRlZmluZWQiKSB7IGxpbWl0ID0gLTE7IH0KICAgICAgICAgICAgICAgIGxpbWl0Kys7CiAgICAgICAgICAgICAgICB2YXIgY2h1bmtzID0gaW5wdXQuc3BsaXQoc2VwYXJhdG9yKTsKICAgICAgICAgICAgICAgIGlmIChsaW1pdCA+IDAgJiYgY2h1bmtzLmxlbmd0aCA+IGxpbWl0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IGNodW5rcy5zcGxpY2UoMCwgbGltaXQpOwogICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKGNodW5rcy5qb2luKHNlcGFyYXRvcikpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY2h1bmtzOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFVybC5wcm90b3R5cGUuVG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVHlwZXJ0ZXh0Lkh0dHAuSHR0cFByb3RvY29sW3RoaXMucHJvdG9jb2xdICsgIjovLyIgKyB0aGlzLmRvbWFpbiArICgodGhpcy5wb3J0ID09IEh0dHBVcmwuRGVmYXVsdFBvcnQodGhpcy5wcm90b2NvbCkpID8gIiIgOiAiOiIgKyB0aGlzLnBvcnQpICsgdGhpcy5wYXRoICsgSHR0cFVybC5FbmNvZGVRdWVyeVN0cmluZyh0aGlzLnF1ZXJ5U3RyaW5nKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwucHJvdG90eXBlLkdldFBvcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wb3J0OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFVybC5wcm90b3R5cGUuR2V0RG9tYWluID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tYWluOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFVybC5wcm90b3R5cGUuR2V0UHJvdG9jb2wgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wcm90b2NvbDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwucHJvdG90eXBlLlNhbWVPcmlnaW5DaGVjayA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5kb21haW4gPT09IHVybC5HZXREb21haW4oKSAmJiB0aGlzLnBvcnQgPT09IHVybC5HZXRQb3J0KCkgJiYgdGhpcy5wcm90b2NvbCA9PT0gdXJsLkdldFByb3RvY29sKCkpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gSHR0cFVybDsKICAgICAgICB9KSgpOwogICAgICAgIEh0dHAuSHR0cFVybCA9IEh0dHBVcmw7CiAgICB9KShUeXBlcnRleHQuSHR0cCB8fCAoVHlwZXJ0ZXh0Lkh0dHAgPSB7fSkpOwogICAgdmFyIEh0dHAgPSBUeXBlcnRleHQuSHR0cDsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChUcmFuc3BvcnQpIHsKICAgIH0pKFR5cGVydGV4dC5UcmFuc3BvcnQgfHwgKFR5cGVydGV4dC5UcmFuc3BvcnQgPSB7fSkpOwogICAgdmFyIFRyYW5zcG9ydCA9IFR5cGVydGV4dC5UcmFuc3BvcnQ7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIAp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBfX2V4dGVuZHMgPSB0aGlzLl9fZXh0ZW5kcyB8fCBmdW5jdGlvbiAoZCwgYikgewogICAgZm9yICh2YXIgcCBpbiBiKSBpZiAoYi5oYXNPd25Qcm9wZXJ0eShwKSkgZFtwXSA9IGJbcF07CiAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH0KICAgIF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlOwogICAgZC5wcm90b3R5cGUgPSBuZXcgX18oKTsKfTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoSHR0cCkgewogICAgICAgIHZhciBIdHRwRXhjZXB0aW9uID0gKGZ1bmN0aW9uIChfc3VwZXIpIHsKICAgICAgICAgICAgX19leHRlbmRzKEh0dHBFeGNlcHRpb24sIF9zdXBlcik7CiAgICAgICAgICAgIGZ1bmN0aW9uIEh0dHBFeGNlcHRpb24oKSB7CiAgICAgICAgICAgICAgICBfc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gSHR0cEV4Y2VwdGlvbjsKICAgICAgICB9KShUeXBlcnRleHQuQmFzZUV4Y2VwdGlvbik7CiAgICAgICAgSHR0cC5IdHRwRXhjZXB0aW9uID0gSHR0cEV4Y2VwdGlvbjsKICAgIH0pKFR5cGVydGV4dC5IdHRwIHx8IChUeXBlcnRleHQuSHR0cCA9IHt9KSk7CiAgICB2YXIgSHR0cCA9IFR5cGVydGV4dC5IdHRwOwp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKEh0dHApIHsKICAgICAgICAoZnVuY3Rpb24gKEh0dHBQcm90b2NvbCkgewogICAgICAgICAgICBIdHRwUHJvdG9jb2xbSHR0cFByb3RvY29sWyJodHRwIl0gPSAwXSA9ICJodHRwIjsKICAgICAgICAgICAgSHR0cFByb3RvY29sW0h0dHBQcm90b2NvbFsiaHR0cHMiXSA9IDFdID0gImh0dHBzIjsKICAgICAgICB9KShIdHRwLkh0dHBQcm90b2NvbCB8fCAoSHR0cC5IdHRwUHJvdG9jb2wgPSB7fSkpOwogICAgICAgIHZhciBIdHRwUHJvdG9jb2wgPSBIdHRwLkh0dHBQcm90b2NvbDsKICAgIH0pKFR5cGVydGV4dC5IdHRwIHx8IChUeXBlcnRleHQuSHR0cCA9IHt9KSk7CiAgICB2YXIgSHR0cCA9IFR5cGVydGV4dC5IdHRwOwp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKFRyYW5zcG9ydCkgewogICAgICAgIHZhciBIdHRwVXJsID0gVHlwZXJ0ZXh0Lkh0dHAuSHR0cFVybDsKCiAgICAgICAgdmFyIFRyYW5zcG9ydENob29zZXIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiBUcmFuc3BvcnRDaG9vc2VyKCkgewogICAgICAgICAgICB9CiAgICAgICAgICAgIFRyYW5zcG9ydENob29zZXIuVHJhbnNwb3J0ID0gZnVuY3Rpb24gKG1ldGhvZCwgcmVxdWVzdCwgcG9zdERhdGEsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB2YXIgaWVUZXN0RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICBpZVRlc3REaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgbHRlIElFIDddPjxpPjwvaT48IVtlbmRpZl0tLT4iOwoKICAgICAgICAgICAgICAgIGlmIChpZVRlc3REaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImkiKS5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyB7fTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZVRlc3REaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgbHRlIElFIDldPjxpPjwvaT48IVtlbmRpZl0tLT4iOwogICAgICAgICAgICAgICAgdmFyIGllTHRlOSA9IChpZVRlc3REaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImkiKS5sZW5ndGggPT09IDEpOwogICAgICAgICAgICAgICAgdmFyIG9yaWdpbiA9IEh0dHBVcmwuRnJvbVVybCh3aW5kb3cubG9jYXRpb24uaHJlZik7CgogICAgICAgICAgICAgICAgaWYgKG9yaWdpbi5TYW1lT3JpZ2luQ2hlY2sob3JpZ2luKSB8fCAhaWVMdGU5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFR5cGVydGV4dC5UcmFuc3BvcnQuWEhSOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChvcmlnaW4uR2V0UHJvdG9jb2woKSA9PT0gcmVxdWVzdC5HZXRQcm90b2NvbCgpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFR5cGVydGV4dC5UcmFuc3BvcnQuWERSOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IHt9OwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gVHJhbnNwb3J0Q2hvb3NlcjsKICAgICAgICB9KSgpOwogICAgICAgIFRyYW5zcG9ydC5UcmFuc3BvcnRDaG9vc2VyID0gVHJhbnNwb3J0Q2hvb3NlcjsKICAgIH0pKFR5cGVydGV4dC5UcmFuc3BvcnQgfHwgKFR5cGVydGV4dC5UcmFuc3BvcnQgPSB7fSkpOwogICAgdmFyIFRyYW5zcG9ydCA9IFR5cGVydGV4dC5UcmFuc3BvcnQ7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoSHR0cCkgewogICAgICAgIHZhciBUcmFuc3BvcnRDaG9vc2VyID0gVHlwZXJ0ZXh0LlRyYW5zcG9ydC5UcmFuc3BvcnRDaG9vc2VyOwoKICAgICAgICB2YXIgSHR0cFJlcXVlc3QgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiBIdHRwUmVxdWVzdCgpIHsKICAgICAgICAgICAgfQogICAgICAgICAgICBIdHRwUmVxdWVzdC5wcm90b3R5cGUuRGVsZXRlID0gZnVuY3Rpb24gKHJlcXVlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLlJhd1JlcXVlc3QoNSAvKiBQVVQgKi8sIHJlcXVlc3QsIHt9LCBjYWxsYmFjayk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwUmVxdWVzdC5wcm90b3R5cGUuR2V0ID0gZnVuY3Rpb24gKHJlcXVlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLlJhd1JlcXVlc3QoMSAvKiBHRVQgKi8sIHJlcXVlc3QsIHt9LCBjYWxsYmFjayk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwUmVxdWVzdC5wcm90b3R5cGUuUG9zdCA9IGZ1bmN0aW9uIChyZXF1ZXN0LCBwb3N0RGF0YSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuUmF3UmVxdWVzdCg0IC8qIFBPU1QgKi8sIHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwUmVxdWVzdC5wcm90b3R5cGUuUHV0ID0gZnVuY3Rpb24gKHJlcXVlc3QsIHB1dERhdGEsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLlJhd1JlcXVlc3QoNSAvKiBQVVQgKi8sIHJlcXVlc3QsIHB1dERhdGEsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5SYXdSZXF1ZXN0ID0gZnVuY3Rpb24gKG1ldGhvZCwgcmVxdWVzdCwgcG9zdERhdGEsIGNhbGxiYWNrLCB0cmFuc3BvcnQpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcG9zdERhdGEgPT09ICJ1bmRlZmluZWQiKSB7IHBvc3REYXRhID0ge307IH0KICAgICAgICAgICAgICAgIGlmICghY2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAoYykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmICghdHJhbnNwb3J0KQogICAgICAgICAgICAgICAgICAgIHRyYW5zcG9ydCA9IFRyYW5zcG9ydENob29zZXIuVHJhbnNwb3J0KG1ldGhvZCwgcmVxdWVzdCwgcG9zdERhdGEsIGNhbGxiYWNrKTsKCiAgICAgICAgICAgICAgICB2YXIgdHJhbnNwb3J0SW5zdGFuY2UgPSBuZXcgdHJhbnNwb3J0KG1ldGhvZCwgcmVxdWVzdCwgcG9zdERhdGEsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgIHRyYW5zcG9ydEluc3RhbmNlLlNlbmQoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIEh0dHBSZXF1ZXN0OwogICAgICAgIH0pKCk7CiAgICAgICAgSHR0cC5IdHRwUmVxdWVzdCA9IEh0dHBSZXF1ZXN0OwogICAgfSkoVHlwZXJ0ZXh0Lkh0dHAgfHwgKFR5cGVydGV4dC5IdHRwID0ge30pKTsKICAgIHZhciBIdHRwID0gVHlwZXJ0ZXh0Lkh0dHA7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoSHR0cCkgewogICAgICAgIHZhciBIdHRwUmVzcG9uc2UgPSAoZnVuY3Rpb24gKF9zdXBlcikgewogICAgICAgICAgICBfX2V4dGVuZHMoSHR0cFJlc3BvbnNlLCBfc3VwZXIpOwogICAgICAgICAgICBmdW5jdGlvbiBIdHRwUmVzcG9uc2Uoc3RhdHVzLCByZXNwb25zZUhlYWRlckdldHRlciwgaHR0cFJlc3BvbnNlQ29kZSwgcmVzcG9uc2VCb2R5KSB7CiAgICAgICAgICAgICAgICBfc3VwZXIuY2FsbCh0aGlzLCBzdGF0dXMsIHJlc3BvbnNlSGVhZGVyR2V0dGVyLCBodHRwUmVzcG9uc2VDb2RlLCByZXNwb25zZUJvZHkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBIdHRwUmVzcG9uc2U7CiAgICAgICAgfSkoVHlwZXJ0ZXh0LkdlbmVyaWNSZXNwb25zZSk7CiAgICAgICAgSHR0cC5IdHRwUmVzcG9uc2UgPSBIdHRwUmVzcG9uc2U7CiAgICB9KShUeXBlcnRleHQuSHR0cCB8fCAoVHlwZXJ0ZXh0Lkh0dHAgPSB7fSkpOwogICAgdmFyIEh0dHAgPSBUeXBlcnRleHQuSHR0cDsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChIdHRwKSB7CiAgICAgICAgKGZ1bmN0aW9uIChIdHRwUmVzcG9uc2VTdGF0dXMpIHsKICAgICAgICAgICAgSHR0cFJlc3BvbnNlU3RhdHVzW0h0dHBSZXNwb25zZVN0YXR1c1sic3VjY2VzcyJdID0gMF0gPSAic3VjY2VzcyI7CiAgICAgICAgICAgIEh0dHBSZXNwb25zZVN0YXR1c1tIdHRwUmVzcG9uc2VTdGF0dXNbInNlcnZlckVycm9yIl0gPSAxXSA9ICJzZXJ2ZXJFcnJvciI7CiAgICAgICAgICAgIEh0dHBSZXNwb25zZVN0YXR1c1tIdHRwUmVzcG9uc2VTdGF0dXNbImNsaWVudEVycm9yIl0gPSAyXSA9ICJjbGllbnRFcnJvciI7CiAgICAgICAgICAgIEh0dHBSZXNwb25zZVN0YXR1c1tIdHRwUmVzcG9uc2VTdGF0dXNbInJlc3BvbnNlRXJyb3IiXSA9IDNdID0gInJlc3BvbnNlRXJyb3IiOwogICAgICAgICAgICBIdHRwUmVzcG9uc2VTdGF0dXNbSHR0cFJlc3BvbnNlU3RhdHVzWyJ1bmtub3duRXJyb3IiXSA9IDRdID0gInVua25vd25FcnJvciI7CiAgICAgICAgICAgIEh0dHBSZXNwb25zZVN0YXR1c1tIdHRwUmVzcG9uc2VTdGF0dXNbInRpbWVvdXQiXSA9IDVdID0gInRpbWVvdXQiOwogICAgICAgIH0pKEh0dHAuSHR0cFJlc3BvbnNlU3RhdHVzIHx8IChIdHRwLkh0dHBSZXNwb25zZVN0YXR1cyA9IHt9KSk7CiAgICAgICAgdmFyIEh0dHBSZXNwb25zZVN0YXR1cyA9IEh0dHAuSHR0cFJlc3BvbnNlU3RhdHVzOwogICAgfSkoVHlwZXJ0ZXh0Lkh0dHAgfHwgKFR5cGVydGV4dC5IdHRwID0ge30pKTsKICAgIHZhciBIdHRwID0gVHlwZXJ0ZXh0Lkh0dHA7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoSnNvbikgewogICAgICAgIHZhciBKc29uRXhjZXB0aW9uID0gKGZ1bmN0aW9uIChfc3VwZXIpIHsKICAgICAgICAgICAgX19leHRlbmRzKEpzb25FeGNlcHRpb24sIF9zdXBlcik7CiAgICAgICAgICAgIGZ1bmN0aW9uIEpzb25FeGNlcHRpb24obWVzc2FnZSwgY29kZSkgewogICAgICAgICAgICAgICAgX3N1cGVyLmNhbGwodGhpcywgbWVzc2FnZSwgY29kZSwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIEpzb25FeGNlcHRpb247CiAgICAgICAgfSkoVHlwZXJ0ZXh0LkJhc2VFeGNlcHRpb24pOwogICAgICAgIEpzb24uSnNvbkV4Y2VwdGlvbiA9IEpzb25FeGNlcHRpb247CiAgICB9KShUeXBlcnRleHQuSnNvbiB8fCAoVHlwZXJ0ZXh0Lkpzb24gPSB7fSkpOwogICAgdmFyIEpzb24gPSBUeXBlcnRleHQuSnNvbjsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChKc29uKSB7CiAgICAgICAgdmFyIEh0dHBSZXF1ZXN0ID0gVHlwZXJ0ZXh0Lkh0dHAuSHR0cFJlcXVlc3Q7CgogICAgICAgIHZhciBIdHRwTWV0aG9kID0gVHlwZXJ0ZXh0Lkh0dHAuSHR0cE1ldGhvZDsKCiAgICAgICAgdmFyIEpzb25SZXF1ZXN0ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZnVuY3Rpb24gSnNvblJlcXVlc3QoanNvbkNvbnRlbnRUeXBlKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGpzb25Db250ZW50VHlwZSA9PT0gInVuZGVmaW5lZCIpIHsganNvbkNvbnRlbnRUeXBlID0gImFwcGxpY2F0aW9uL2pzb24iOyB9CiAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3QgPSBuZXcgSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgICAgIHRoaXMuanNvblR5cGUgPSBqc29uQ29udGVudFR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSnNvblJlcXVlc3QucHJvdG90eXBlLkRlbGV0ZSA9IGZ1bmN0aW9uIChyZXF1ZXN0LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5SYXdSZXF1ZXN0KDAgLyogREVMRVRFICovLCByZXF1ZXN0LCB7fSwgY2FsbGJhY2spOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSnNvblJlcXVlc3QucHJvdG90eXBlLkdldCA9IGZ1bmN0aW9uIChyZXF1ZXN0LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5SYXdSZXF1ZXN0KDEgLyogR0VUICovLCByZXF1ZXN0LCB7fSwgY2FsbGJhY2spOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSnNvblJlcXVlc3QucHJvdG90eXBlLlBvc3QgPSBmdW5jdGlvbiAocmVxdWVzdCwgcG9zdERhdGEsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLlJhd1JlcXVlc3QoNCAvKiBQT1NUICovLCByZXF1ZXN0LCBwb3N0RGF0YSwgY2FsbGJhY2spOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSnNvblJlcXVlc3QucHJvdG90eXBlLlB1dCA9IGZ1bmN0aW9uIChyZXF1ZXN0LCBwdXREYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5SYXdSZXF1ZXN0KDUgLyogUFVUICovLCByZXF1ZXN0LCBwdXREYXRhLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBKc29uUmVxdWVzdC5wcm90b3R5cGUuUmF3UmVxdWVzdCA9IGZ1bmN0aW9uIChtZXRob2QsIHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjaywgdHJhbnNwb3J0KSB7CiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwb3N0RGF0YSA9PT0gInVuZGVmaW5lZCIpIHsgcG9zdERhdGEgPSB7fTsgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0LlJhd1JlcXVlc3QobWV0aG9kLCByZXF1ZXN0LCBwb3N0RGF0YSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3QuUmF3UmVxdWVzdChtZXRob2QsIHJlcXVlc3QsIHBvc3REYXRhLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuR2V0Q29udGVudFR5cGUoKSAhPSBfdGhpcy5qc29uVHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhUeXBlcnRleHQuSnNvbi5Kc29uUmVzcG9uc2UuZnJvbUludmFsaWRIdHRwUmVzcG9uc2UocmVzcG9uc2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soVHlwZXJ0ZXh0Lkpzb24uSnNvblJlc3BvbnNlLmZyb21IdHRwUmVzcG9uc2UocmVzcG9uc2UpKTsKICAgICAgICAgICAgICAgIH0sIHRyYW5zcG9ydCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBKc29uUmVxdWVzdDsKICAgICAgICB9KSgpOwogICAgICAgIEpzb24uSnNvblJlcXVlc3QgPSBKc29uUmVxdWVzdDsKICAgIH0pKFR5cGVydGV4dC5Kc29uIHx8IChUeXBlcnRleHQuSnNvbiA9IHt9KSk7CiAgICB2YXIgSnNvbiA9IFR5cGVydGV4dC5Kc29uOwp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKEpzb24pIHsKICAgICAgICB2YXIgSHR0cFJlc3BvbnNlU3RhdHVzID0gVHlwZXJ0ZXh0Lkh0dHAuSHR0cFJlc3BvbnNlU3RhdHVzOwoKICAgICAgICB2YXIgSnNvblJlc3BvbnNlID0gKGZ1bmN0aW9uIChfc3VwZXIpIHsKICAgICAgICAgICAgX19leHRlbmRzKEpzb25SZXNwb25zZSwgX3N1cGVyKTsKICAgICAgICAgICAgZnVuY3Rpb24gSnNvblJlc3BvbnNlKHN0YXR1cywgcmVzcG9uc2VIZWFkZXJHZXR0ZXIsIGh0dHBSZXNwb25zZUNvZGUsIHJlc3BvbnNlQm9keSwgcGFyc2VTdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBfc3VwZXIuY2FsbCh0aGlzLCBzdGF0dXMsIHJlc3BvbnNlSGVhZGVyR2V0dGVyLCBodHRwUmVzcG9uc2VDb2RlLCByZXNwb25zZUJvZHkpOwogICAgICAgICAgICAgICAgcGFyc2VTdWNjZXNzID0gISFwYXJzZVN1Y2Nlc3MgfHwgZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnNlU3VjY2VzcyA9IHBhcnNlU3VjY2VzczsKICAgICAgICAgICAgfQogICAgICAgICAgICBKc29uUmVzcG9uc2UuZnJvbUh0dHBSZXNwb25zZSA9IGZ1bmN0aW9uIChodHRwUmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSnNvblJlc3BvbnNlKGh0dHBSZXNwb25zZS5HZXRTdGF0dXMoKSwgaHR0cFJlc3BvbnNlLkdldEhlYWRlciwgaHR0cFJlc3BvbnNlLkdldEh0dHBTdGF0dXMoKSwgd2luZG93WyJKU09OIl0ucGFyc2UoaHR0cFJlc3BvbnNlLkdldENvbnRlbnQoKSksIHRydWUpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSnNvblJlc3BvbnNlKGh0dHBSZXNwb25zZS5HZXRTdGF0dXMoKSwgaHR0cFJlc3BvbnNlLkdldEhlYWRlciwgaHR0cFJlc3BvbnNlLkdldEh0dHBTdGF0dXMoKSwgbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBKc29uUmVzcG9uc2UuZnJvbUludmFsaWRIdHRwUmVzcG9uc2UgPSBmdW5jdGlvbiAoaHR0cFJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEpzb25SZXNwb25zZSgzIC8qIHJlc3BvbnNlRXJyb3IgKi8sIGh0dHBSZXNwb25zZS5HZXRIZWFkZXIsIGh0dHBSZXNwb25zZS5HZXRIdHRwU3RhdHVzKCkpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSnNvblJlc3BvbnNlLnByb3RvdHlwZS5HZXRQYXJzZVN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnNlU3VjY2VzczsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIEpzb25SZXNwb25zZTsKICAgICAgICB9KShUeXBlcnRleHQuR2VuZXJpY1Jlc3BvbnNlKTsKICAgICAgICBKc29uLkpzb25SZXNwb25zZSA9IEpzb25SZXNwb25zZTsKICAgIH0pKFR5cGVydGV4dC5Kc29uIHx8IChUeXBlcnRleHQuSnNvbiA9IHt9KSk7CiAgICB2YXIgSnNvbiA9IFR5cGVydGV4dC5Kc29uOwp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKFRyYW5zcG9ydCkgewogICAgICAgIHZhciBIdHRwTWV0aG9kID0gVHlwZXJ0ZXh0Lkh0dHAuSHR0cE1ldGhvZDsKICAgICAgICB2YXIgSHR0cFVybCA9IFR5cGVydGV4dC5IdHRwLkh0dHBVcmw7CgogICAgICAgIHZhciBIdHRwUmVzcG9uc2VTdGF0dXMgPSBUeXBlcnRleHQuSHR0cC5IdHRwUmVzcG9uc2VTdGF0dXM7CiAgICAgICAgdmFyIEh0dHBSZXNwb25zZSA9IFR5cGVydGV4dC5IdHRwLkh0dHBSZXNwb25zZTsKCiAgICAgICAgdmFyIFhEUiA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIFhEUihtZXRob2QsIHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwb3N0RGF0YSA9PT0gInVuZGVmaW5lZCIpIHsgcG9zdERhdGEgPSB7fTsgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gInVuZGVmaW5lZCIpIHsgY2FsbGJhY2sgPSBmdW5jdGlvbiAoYykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfTsgfQogICAgICAgICAgICAgICAgdGhpcy5wb3N0RGF0YSA9IHBvc3REYXRhOwogICAgICAgICAgICAgICAgdGhpcy5tZXRob2QgPSBtZXRob2Q7CiAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogICAgICAgICAgICAgICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwoKICAgICAgICAgICAgICAgIHRoaXMueGRyID0gbmV3IFhEb21haW5SZXF1ZXN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgWERSLnByb3RvdHlwZS5TZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgICAgIHZhciBnZXRIZWFkZXIgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJjb250ZW50LXR5cGUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy54ZHIuY29udGVudFR5cGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHRoaXMueGRyLm9udGltZW91dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjayhuZXcgSHR0cFJlc3BvbnNlKDUgLyogdGltZW91dCAqLywgZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICAgICAgICAgIH0sIC0xLCAiIikpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0aGlzLnhkci5vbmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLmNhbGxiYWNrKG5ldyBIdHRwUmVzcG9uc2UoNCAvKiB1bmtub3duRXJyb3IgKi8sIGdldEhlYWRlciwgLTEsIF90aGlzLnhkci5yZXNwb25zZVRleHQpKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGhpcy54ZHIub25sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLmNhbGxiYWNrKG5ldyBIdHRwUmVzcG9uc2UoMCAvKiBzdWNjZXNzICovLCBnZXRIZWFkZXIsIDIwMCwgX3RoaXMueGRyLnJlc3BvbnNlVGV4dCkpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0aGlzLnhkci5vbnByb2dyZXNzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0aGlzLnhkci5vcGVuKEh0dHBNZXRob2RbdGhpcy5tZXRob2RdLCB0aGlzLnJlcXVlc3QuVG9TdHJpbmcoKSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWV0aG9kID09IDEgLyogR0VUICovKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy54ZHIuc2VuZCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnhkci5zZW5kKEh0dHBVcmwuVXJsRW5jb2RlT2JqZWN0KHRoaXMucG9zdERhdGEpKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIFhEUi5wcm90b3R5cGUuRGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMueGRyLm9udGltZW91dCA9IHRoaXMueGRyLm9uZXJyb3IgPSB0aGlzLnhkci5vbmxvYWQgPSB0aGlzLnhkci5vbnByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMueGRyID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIFhEUjsKICAgICAgICB9KSgpOwogICAgICAgIFRyYW5zcG9ydC5YRFIgPSBYRFI7CiAgICB9KShUeXBlcnRleHQuVHJhbnNwb3J0IHx8IChUeXBlcnRleHQuVHJhbnNwb3J0ID0ge30pKTsKICAgIHZhciBUcmFuc3BvcnQgPSBUeXBlcnRleHQuVHJhbnNwb3J0Owp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKFRyYW5zcG9ydCkgewogICAgICAgIHZhciBIdHRwTWV0aG9kID0gVHlwZXJ0ZXh0Lkh0dHAuSHR0cE1ldGhvZDsKICAgICAgICB2YXIgSHR0cFVybCA9IFR5cGVydGV4dC5IdHRwLkh0dHBVcmw7CgogICAgICAgIHZhciBIdHRwUmVzcG9uc2VTdGF0dXMgPSBUeXBlcnRleHQuSHR0cC5IdHRwUmVzcG9uc2VTdGF0dXM7CiAgICAgICAgdmFyIEh0dHBSZXNwb25zZSA9IFR5cGVydGV4dC5IdHRwLkh0dHBSZXNwb25zZTsKCiAgICAgICAgdmFyIFhIUiA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIFhIUihtZXRob2QsIHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwb3N0RGF0YSA9PT0gInVuZGVmaW5lZCIpIHsgcG9zdERhdGEgPSB7fTsgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gInVuZGVmaW5lZCIpIHsgY2FsbGJhY2sgPSBmdW5jdGlvbiAoYykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfTsgfQogICAgICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgICAgIHRoaXMucG9zdERhdGEgPSBwb3N0RGF0YTsKICAgICAgICAgICAgICAgIHRoaXMubWV0aG9kID0gbWV0aG9kOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICAgICAgICAgICAgICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKCiAgICAgICAgICAgICAgICB0aGlzLnhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoKICAgICAgICAgICAgICAgIHRoaXMueGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMueGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0SGVhZGVyID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy54aHIuZ2V0UmVzcG9uc2VIZWFkZXIobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMueGhyLnN0YXR1cyA9PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNhbGxiYWNrKG5ldyBIdHRwUmVzcG9uc2UoMCAvKiBzdWNjZXNzICovLCBnZXRIZWFkZXIsIF90aGlzLnhoci5zdGF0dXMsIF90aGlzLnhoci5yZXNwb25zZVRleHQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChfdGhpcy54aHIuc3RhdHVzID49IDQwMCAmJiBfdGhpcy54aHIuc3RhdHVzIDwgNTAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjayhuZXcgSHR0cFJlc3BvbnNlKDIgLyogY2xpZW50RXJyb3IgKi8sIGdldEhlYWRlciwgX3RoaXMueGhyLnN0YXR1cywgX3RoaXMueGhyLnJlc3BvbnNlVGV4dCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF90aGlzLnhoci5zdGF0dXMgPj0gNTAwICYmIF90aGlzLnhoci5zdGF0dXMgPCA2MDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNhbGxiYWNrKG5ldyBIdHRwUmVzcG9uc2UoMSAvKiBzZXJ2ZXJFcnJvciAqLywgZ2V0SGVhZGVyLCBfdGhpcy54aHIuc3RhdHVzLCBfdGhpcy54aHIucmVzcG9uc2VUZXh0KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjayhuZXcgSHR0cFJlc3BvbnNlKDQgLyogdW5rbm93bkVycm9yICovLCBnZXRIZWFkZXIsIF90aGlzLnhoci5zdGF0dXMsIF90aGlzLnhoci5yZXNwb25zZVRleHQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGhpcy54aHIub250aW1lb3V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLmNhbGxiYWNrKG5ldyBIdHRwUmVzcG9uc2UoNSAvKiB0aW1lb3V0ICovLCBmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgICAgICAgICAgfSwgLTEsICIiKSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIFhIUi5wcm90b3R5cGUuU2VuZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMueGhyLm9wZW4oSHR0cE1ldGhvZFt0aGlzLm1ldGhvZF0sIHRoaXMucmVxdWVzdC5Ub1N0cmluZygpLCB0cnVlKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZXRob2QgPT0gMSAvKiBHRVQgKi8pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnhoci5zZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMueGhyLnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiKTsKCiAgICAgICAgICAgICAgICB0aGlzLnhoci5zZW5kKEh0dHBVcmwuVXJsRW5jb2RlT2JqZWN0KHRoaXMucG9zdERhdGEpKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIFhIUi5wcm90b3R5cGUuRGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMueGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHRoaXMueGhyLm9udGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLnhociA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBYSFI7CiAgICAgICAgfSkoKTsKICAgICAgICBUcmFuc3BvcnQuWEhSID0gWEhSOwogICAgfSkoVHlwZXJ0ZXh0LlRyYW5zcG9ydCB8fCAoVHlwZXJ0ZXh0LlRyYW5zcG9ydCA9IHt9KSk7CiAgICB2YXIgVHJhbnNwb3J0ID0gVHlwZXJ0ZXh0LlRyYW5zcG9ydDsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwovLyMgc291cmNlTWFwcGluZ1VSTD10eXBlcnRleHQuanMubWFwCg==",
                "body": "dmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIHZhciBCYXNlRXhjZXB0aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBCYXNlRXhjZXB0aW9uKG1lc3NhZ2UsIGNvZGUsIGN1c3RvbSkgewogICAgICAgICAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICAgICAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgICAgICAgICB0aGlzLmN1c3RvbSA9IGN1c3RvbTsKICAgICAgICB9CiAgICAgICAgQmFzZUV4Y2VwdGlvbi5wcm90b3R5cGUuR2V0Q29kZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29kZTsKICAgICAgICB9OwoKICAgICAgICBCYXNlRXhjZXB0aW9uLnByb3RvdHlwZS5HZXRNZXNzYWdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tZXNzYWdlOwogICAgICAgIH07CgogICAgICAgIEJhc2VFeGNlcHRpb24ucHJvdG90eXBlLkdldEN1c3RvbSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VzdG9tOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIEJhc2VFeGNlcHRpb247CiAgICB9KSgpOwogICAgVHlwZXJ0ZXh0LkJhc2VFeGNlcHRpb24gPSBCYXNlRXhjZXB0aW9uOwp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICB2YXIgR2VuZXJpY1Jlc3BvbnNlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBHZW5lcmljUmVzcG9uc2Uoc3RhdHVzLCByZXNwb25zZUhlYWRlckdldHRlciwgaHR0cFJlc3BvbnNlQ29kZSwgcmVzcG9uc2VCb2R5KSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgICB0aGlzLmhlYWRlcnMgPSByZXNwb25zZUhlYWRlckdldHRlcjsKICAgICAgICAgICAgdGhpcy5odHRwU3RhdHVzID0gaHR0cFJlc3BvbnNlQ29kZTsKICAgICAgICAgICAgdGhpcy5jb250ZW50ID0gcmVzcG9uc2VCb2R5OwogICAgICAgIH0KICAgICAgICBHZW5lcmljUmVzcG9uc2UucHJvdG90eXBlLkdldENvbnRlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgR2VuZXJpY1Jlc3BvbnNlLnByb3RvdHlwZS5HZXRDb250ZW50VHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuR2V0SGVhZGVyKCJDb250ZW50LVR5cGUiKTsKICAgICAgICB9OwoKICAgICAgICBHZW5lcmljUmVzcG9uc2UucHJvdG90eXBlLkdldEhlYWRlciA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmhlYWRlcnMobmFtZSk7CiAgICAgICAgfTsKCiAgICAgICAgR2VuZXJpY1Jlc3BvbnNlLnByb3RvdHlwZS5HZXRIdHRwU3RhdHVzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5odHRwU3RhdHVzOwogICAgICAgIH07CgogICAgICAgIEdlbmVyaWNSZXNwb25zZS5wcm90b3R5cGUuR2V0U3RhdHVzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zdGF0dXM7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gR2VuZXJpY1Jlc3BvbnNlOwogICAgfSkoKTsKICAgIFR5cGVydGV4dC5HZW5lcmljUmVzcG9uc2UgPSBHZW5lcmljUmVzcG9uc2U7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoSHR0cCkgewogICAgICAgIChmdW5jdGlvbiAoSHR0cE1ldGhvZCkgewogICAgICAgICAgICBIdHRwTWV0aG9kW0h0dHBNZXRob2RbIkRFTEVURSJdID0gMF0gPSAiREVMRVRFIjsKICAgICAgICAgICAgSHR0cE1ldGhvZFtIdHRwTWV0aG9kWyJHRVQiXSA9IDFdID0gIkdFVCI7CiAgICAgICAgICAgIEh0dHBNZXRob2RbSHR0cE1ldGhvZFsiSEVBRCJdID0gMl0gPSAiSEVBRCI7CiAgICAgICAgICAgIEh0dHBNZXRob2RbSHR0cE1ldGhvZFsiT1BUSU9OUyJdID0gM10gPSAiT1BUSU9OUyI7CiAgICAgICAgICAgIEh0dHBNZXRob2RbSHR0cE1ldGhvZFsiUE9TVCJdID0gNF0gPSAiUE9TVCI7CiAgICAgICAgICAgIEh0dHBNZXRob2RbSHR0cE1ldGhvZFsiUFVUIl0gPSA1XSA9ICJQVVQiOwogICAgICAgICAgICBIdHRwTWV0aG9kW0h0dHBNZXRob2RbIlRSQUNFIl0gPSA2XSA9ICJUUkFDRSI7CiAgICAgICAgfSkoSHR0cC5IdHRwTWV0aG9kIHx8IChIdHRwLkh0dHBNZXRob2QgPSB7fSkpOwogICAgICAgIHZhciBIdHRwTWV0aG9kID0gSHR0cC5IdHRwTWV0aG9kOwogICAgfSkoVHlwZXJ0ZXh0Lkh0dHAgfHwgKFR5cGVydGV4dC5IdHRwID0ge30pKTsKICAgIHZhciBIdHRwID0gVHlwZXJ0ZXh0Lkh0dHA7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoSHR0cCkgewogICAgICAgIHZhciBIdHRwVXJsID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZnVuY3Rpb24gSHR0cFVybChkb21haW4sIHByb3RvY29sLCBwYXRoLCBxdWVyeVN0cmluZywgcG9ydCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm90b2NvbCA9PT0gInVuZGVmaW5lZCIpIHsgcHJvdG9jb2wgPSAwIC8qIGh0dHAgKi87IH0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGF0aCA9PT0gInVuZGVmaW5lZCIpIHsgcGF0aCA9ICIvIjsgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBxdWVyeVN0cmluZyA9PT0gInVuZGVmaW5lZCIpIHsgcXVlcnlTdHJpbmcgPSB7fTsgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwb3J0ID09PSAidW5kZWZpbmVkIikgeyBwb3J0ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcnQgPCAxIHx8IHBvcnQgPiA2NTUzNSB8fCBpc05hTihwb3J0KSkgewogICAgICAgICAgICAgICAgICAgIHBvcnQgPSBIdHRwVXJsLkRlZmF1bHRQb3J0KHByb3RvY29sKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAocGF0aC5pbmRleE9mKCIvIikgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHBhdGggPSAiLyIgKyBwYXRoOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluOwogICAgICAgICAgICAgICAgdGhpcy5wcm90b2NvbCA9IHByb3RvY29sOwogICAgICAgICAgICAgICAgdGhpcy5wYXRoID0gcGF0aDsKICAgICAgICAgICAgICAgIHRoaXMucXVlcnlTdHJpbmcgPSBxdWVyeVN0cmluZzsKICAgICAgICAgICAgICAgIHRoaXMucG9ydCA9IHBvcnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSHR0cFVybC5EZWZhdWx0UG9ydCA9IGZ1bmN0aW9uIChwcm90b2NvbCkgewogICAgICAgICAgICAgICAgc3dpdGNoIChwcm90b2NvbCkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgMCAvKiBodHRwICovOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gODA7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxIC8qIGh0dHBzICovOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gNDQzOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwuRnJvbVVybCA9IGZ1bmN0aW9uIChsb2NhdGlvbikgewogICAgICAgICAgICAgICAgdmFyIGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgICAgICAgICBsLmhyZWYgPSBsb2NhdGlvbjsKICAgICAgICAgICAgICAgIGlmICghbC5ob3N0bmFtZSB8fCAhbC5wcm90b2NvbCB8fCAhbC5wYXRobmFtZSB8fCAhbC5zZWFyY2ggfHwgIWwucG9ydCkgewogICAgICAgICAgICAgICAgICAgIGwuaHJlZiA9IGwuaHJlZjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSHR0cFVybChsLmhvc3RuYW1lLCBUeXBlcnRleHQuSHR0cC5IdHRwUHJvdG9jb2xbbC5wcm90b2NvbC5zbGljZSgwLCAtMSldLCBsLnBhdGhuYW1lLCBIdHRwVXJsLkRlY29kZVF1ZXJ5U3RyaW5nKGwuc2VhcmNoKSwgcGFyc2VJbnQobC5wb3J0KSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwVXJsLkRlY29kZVF1ZXJ5U3RyaW5nID0gZnVuY3Rpb24gKHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAocXVlcnlTdHJpbmcuaW5kZXhPZigiPyIpID09IDApIHsKICAgICAgICAgICAgICAgICAgICBxdWVyeVN0cmluZyA9IHF1ZXJ5U3RyaW5nLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gSHR0cFVybC5VcmxEZWNvZGVTdHJpbmcocXVlcnlTdHJpbmcpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFVybC5FbmNvZGVRdWVyeVN0cmluZyA9IGZ1bmN0aW9uIChxdWVyeSkgewogICAgICAgICAgICAgICAgdmFyIHJzID0gIj8iICsgSHR0cFVybC5VcmxFbmNvZGVPYmplY3QocXVlcnkpOwogICAgICAgICAgICAgICAgcmV0dXJuICgocnMubGVuZ3RoID09IDEpID8gIiIgOiBycyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwVXJsLlVybEVuY29kZU9iamVjdCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICB2YXIgcnMgPSAiIjsKICAgICAgICAgICAgICAgIHZhciB0ZW1wOwoKICAgICAgICAgICAgICAgIGZvciAodGVtcCBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1ciA9IGRhdGFbdGVtcF07CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY3VyICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgY3VyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJzICs9IGVuY29kZVVSSUNvbXBvbmVudCh0ZW1wKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudChjdXIpICsgIiYiOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjdXIgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGN1ci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdXJbaV0gPT09ICJvYmplY3QiICYmIHR5cGVvZiBjdXJbaV0gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBycyArPSBlbmNvZGVVUklDb21wb25lbnQodGVtcCkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQoY3VyW2ldKSArICImIjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcnMuc2xpY2UoMCwgLTEpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFVybC5VcmxEZWNvZGVTdHJpbmcgPSBmdW5jdGlvbiAocXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgICAgIHZhciByZXR1cm5WYWx1ZSA9IHt9LCBwYXJhbXMgPSBIdHRwVXJsLnNwbGl0U3RyaW5nKHF1ZXJ5U3RyaW5nLCAiJiIpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zW2ldID09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtID0gSHR0cFVybC5zcGxpdFN0cmluZyhwYXJhbXNbaV0sICI9IiwgMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVswXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlW2tleV0gPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm5WYWx1ZVtrZXldID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtWzFdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwVXJsLnNwbGl0U3RyaW5nID0gZnVuY3Rpb24gKGlucHV0LCBzZXBhcmF0b3IsIGxpbWl0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGxpbWl0ID09PSAidW5kZWZpbmVkIikgeyBsaW1pdCA9IC0xOyB9CiAgICAgICAgICAgICAgICBsaW1pdCsrOwogICAgICAgICAgICAgICAgdmFyIGNodW5rcyA9IGlucHV0LnNwbGl0KHNlcGFyYXRvcik7CiAgICAgICAgICAgICAgICBpZiAobGltaXQgPiAwICYmIGNodW5rcy5sZW5ndGggPiBsaW1pdCkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXQgPSBjaHVua3Muc3BsaWNlKDAsIGxpbWl0KTsKICAgICAgICAgICAgICAgICAgICByZXQucHVzaChjaHVua3Muam9pbihzZXBhcmF0b3IpKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNodW5rczsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwucHJvdG90eXBlLlRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFR5cGVydGV4dC5IdHRwLkh0dHBQcm90b2NvbFt0aGlzLnByb3RvY29sXSArICI6Ly8iICsgdGhpcy5kb21haW4gKyAoKHRoaXMucG9ydCA9PSBIdHRwVXJsLkRlZmF1bHRQb3J0KHRoaXMucHJvdG9jb2wpKSA/ICIiIDogIjoiICsgdGhpcy5wb3J0KSArIHRoaXMucGF0aCArIEh0dHBVcmwuRW5jb2RlUXVlcnlTdHJpbmcodGhpcy5xdWVyeVN0cmluZyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwVXJsLnByb3RvdHlwZS5HZXRQb3J0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9ydDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwucHJvdG90eXBlLkdldERvbWFpbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRvbWFpbjsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEh0dHBVcmwucHJvdG90eXBlLkdldFByb3RvY29sID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvdG9jb2w7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwVXJsLnByb3RvdHlwZS5TYW1lT3JpZ2luQ2hlY2sgPSBmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKHRoaXMuZG9tYWluID09PSB1cmwuR2V0RG9tYWluKCkgJiYgdGhpcy5wb3J0ID09PSB1cmwuR2V0UG9ydCgpICYmIHRoaXMucHJvdG9jb2wgPT09IHVybC5HZXRQcm90b2NvbCgpKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIEh0dHBVcmw7CiAgICAgICAgfSkoKTsKICAgICAgICBIdHRwLkh0dHBVcmwgPSBIdHRwVXJsOwogICAgfSkoVHlwZXJ0ZXh0Lkh0dHAgfHwgKFR5cGVydGV4dC5IdHRwID0ge30pKTsKICAgIHZhciBIdHRwID0gVHlwZXJ0ZXh0Lkh0dHA7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoVHJhbnNwb3J0KSB7CiAgICB9KShUeXBlcnRleHQuVHJhbnNwb3J0IHx8IChUeXBlcnRleHQuVHJhbnNwb3J0ID0ge30pKTsKICAgIHZhciBUcmFuc3BvcnQgPSBUeXBlcnRleHQuVHJhbnNwb3J0Owp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgX19leHRlbmRzID0gdGhpcy5fX2V4dGVuZHMgfHwgZnVuY3Rpb24gKGQsIGIpIHsKICAgIGZvciAodmFyIHAgaW4gYikgaWYgKGIuaGFzT3duUHJvcGVydHkocCkpIGRbcF0gPSBiW3BdOwogICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9CiAgICBfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZTsKICAgIGQucHJvdG90eXBlID0gbmV3IF9fKCk7Cn07CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKEh0dHApIHsKICAgICAgICB2YXIgSHR0cEV4Y2VwdGlvbiA9IChmdW5jdGlvbiAoX3N1cGVyKSB7CiAgICAgICAgICAgIF9fZXh0ZW5kcyhIdHRwRXhjZXB0aW9uLCBfc3VwZXIpOwogICAgICAgICAgICBmdW5jdGlvbiBIdHRwRXhjZXB0aW9uKCkgewogICAgICAgICAgICAgICAgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIEh0dHBFeGNlcHRpb247CiAgICAgICAgfSkoVHlwZXJ0ZXh0LkJhc2VFeGNlcHRpb24pOwogICAgICAgIEh0dHAuSHR0cEV4Y2VwdGlvbiA9IEh0dHBFeGNlcHRpb247CiAgICB9KShUeXBlcnRleHQuSHR0cCB8fCAoVHlwZXJ0ZXh0Lkh0dHAgPSB7fSkpOwogICAgdmFyIEh0dHAgPSBUeXBlcnRleHQuSHR0cDsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChIdHRwKSB7CiAgICAgICAgKGZ1bmN0aW9uIChIdHRwUHJvdG9jb2wpIHsKICAgICAgICAgICAgSHR0cFByb3RvY29sW0h0dHBQcm90b2NvbFsiaHR0cCJdID0gMF0gPSAiaHR0cCI7CiAgICAgICAgICAgIEh0dHBQcm90b2NvbFtIdHRwUHJvdG9jb2xbImh0dHBzIl0gPSAxXSA9ICJodHRwcyI7CiAgICAgICAgfSkoSHR0cC5IdHRwUHJvdG9jb2wgfHwgKEh0dHAuSHR0cFByb3RvY29sID0ge30pKTsKICAgICAgICB2YXIgSHR0cFByb3RvY29sID0gSHR0cC5IdHRwUHJvdG9jb2w7CiAgICB9KShUeXBlcnRleHQuSHR0cCB8fCAoVHlwZXJ0ZXh0Lkh0dHAgPSB7fSkpOwogICAgdmFyIEh0dHAgPSBUeXBlcnRleHQuSHR0cDsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChUcmFuc3BvcnQpIHsKICAgICAgICB2YXIgSHR0cFVybCA9IFR5cGVydGV4dC5IdHRwLkh0dHBVcmw7CgogICAgICAgIHZhciBUcmFuc3BvcnRDaG9vc2VyID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZnVuY3Rpb24gVHJhbnNwb3J0Q2hvb3NlcigpIHsKICAgICAgICAgICAgfQogICAgICAgICAgICBUcmFuc3BvcnRDaG9vc2VyLlRyYW5zcG9ydCA9IGZ1bmN0aW9uIChtZXRob2QsIHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdmFyIGllVGVzdERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgaWVUZXN0RGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGx0ZSBJRSA3XT48aT48L2k+PCFbZW5kaWZdLS0+IjsKCiAgICAgICAgICAgICAgICBpZiAoaWVUZXN0RGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpIikubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cge307CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWVUZXN0RGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGx0ZSBJRSA5XT48aT48L2k+PCFbZW5kaWZdLS0+IjsKICAgICAgICAgICAgICAgIHZhciBpZUx0ZTkgPSAoaWVUZXN0RGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpIikubGVuZ3RoID09PSAxKTsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW4gPSBIdHRwVXJsLkZyb21Vcmwod2luZG93LmxvY2F0aW9uLmhyZWYpOwoKICAgICAgICAgICAgICAgIGlmIChvcmlnaW4uU2FtZU9yaWdpbkNoZWNrKG9yaWdpbikgfHwgIWllTHRlOSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBUeXBlcnRleHQuVHJhbnNwb3J0LlhIUjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3JpZ2luLkdldFByb3RvY29sKCkgPT09IHJlcXVlc3QuR2V0UHJvdG9jb2woKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBUeXBlcnRleHQuVHJhbnNwb3J0LlhEUjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyB7fTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIFRyYW5zcG9ydENob29zZXI7CiAgICAgICAgfSkoKTsKICAgICAgICBUcmFuc3BvcnQuVHJhbnNwb3J0Q2hvb3NlciA9IFRyYW5zcG9ydENob29zZXI7CiAgICB9KShUeXBlcnRleHQuVHJhbnNwb3J0IHx8IChUeXBlcnRleHQuVHJhbnNwb3J0ID0ge30pKTsKICAgIHZhciBUcmFuc3BvcnQgPSBUeXBlcnRleHQuVHJhbnNwb3J0Owp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKEh0dHApIHsKICAgICAgICB2YXIgVHJhbnNwb3J0Q2hvb3NlciA9IFR5cGVydGV4dC5UcmFuc3BvcnQuVHJhbnNwb3J0Q2hvb3NlcjsKCiAgICAgICAgdmFyIEh0dHBSZXF1ZXN0ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZnVuY3Rpb24gSHR0cFJlcXVlc3QoKSB7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSHR0cFJlcXVlc3QucHJvdG90eXBlLkRlbGV0ZSA9IGZ1bmN0aW9uIChyZXF1ZXN0LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5SYXdSZXF1ZXN0KDUgLyogUFVUICovLCByZXF1ZXN0LCB7fSwgY2FsbGJhY2spOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFJlcXVlc3QucHJvdG90eXBlLkdldCA9IGZ1bmN0aW9uIChyZXF1ZXN0LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5SYXdSZXF1ZXN0KDEgLyogR0VUICovLCByZXF1ZXN0LCB7fSwgY2FsbGJhY2spOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFJlcXVlc3QucHJvdG90eXBlLlBvc3QgPSBmdW5jdGlvbiAocmVxdWVzdCwgcG9zdERhdGEsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLlJhd1JlcXVlc3QoNCAvKiBQT1NUICovLCByZXF1ZXN0LCBwb3N0RGF0YSwgY2FsbGJhY2spOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSHR0cFJlcXVlc3QucHJvdG90eXBlLlB1dCA9IGZ1bmN0aW9uIChyZXF1ZXN0LCBwdXREYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5SYXdSZXF1ZXN0KDUgLyogUFVUICovLCByZXF1ZXN0LCBwdXREYXRhLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBIdHRwUmVxdWVzdC5wcm90b3R5cGUuUmF3UmVxdWVzdCA9IGZ1bmN0aW9uIChtZXRob2QsIHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjaywgdHJhbnNwb3J0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBvc3REYXRhID09PSAidW5kZWZpbmVkIikgeyBwb3N0RGF0YSA9IHt9OyB9CiAgICAgICAgICAgICAgICBpZiAoIWNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gKGMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoIXRyYW5zcG9ydCkKICAgICAgICAgICAgICAgICAgICB0cmFuc3BvcnQgPSBUcmFuc3BvcnRDaG9vc2VyLlRyYW5zcG9ydChtZXRob2QsIHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjayk7CgogICAgICAgICAgICAgICAgdmFyIHRyYW5zcG9ydEluc3RhbmNlID0gbmV3IHRyYW5zcG9ydChtZXRob2QsIHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB0cmFuc3BvcnRJbnN0YW5jZS5TZW5kKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBIdHRwUmVxdWVzdDsKICAgICAgICB9KSgpOwogICAgICAgIEh0dHAuSHR0cFJlcXVlc3QgPSBIdHRwUmVxdWVzdDsKICAgIH0pKFR5cGVydGV4dC5IdHRwIHx8IChUeXBlcnRleHQuSHR0cCA9IHt9KSk7CiAgICB2YXIgSHR0cCA9IFR5cGVydGV4dC5IdHRwOwp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKEh0dHApIHsKICAgICAgICB2YXIgSHR0cFJlc3BvbnNlID0gKGZ1bmN0aW9uIChfc3VwZXIpIHsKICAgICAgICAgICAgX19leHRlbmRzKEh0dHBSZXNwb25zZSwgX3N1cGVyKTsKICAgICAgICAgICAgZnVuY3Rpb24gSHR0cFJlc3BvbnNlKHN0YXR1cywgcmVzcG9uc2VIZWFkZXJHZXR0ZXIsIGh0dHBSZXNwb25zZUNvZGUsIHJlc3BvbnNlQm9keSkgewogICAgICAgICAgICAgICAgX3N1cGVyLmNhbGwodGhpcywgc3RhdHVzLCByZXNwb25zZUhlYWRlckdldHRlciwgaHR0cFJlc3BvbnNlQ29kZSwgcmVzcG9uc2VCb2R5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gSHR0cFJlc3BvbnNlOwogICAgICAgIH0pKFR5cGVydGV4dC5HZW5lcmljUmVzcG9uc2UpOwogICAgICAgIEh0dHAuSHR0cFJlc3BvbnNlID0gSHR0cFJlc3BvbnNlOwogICAgfSkoVHlwZXJ0ZXh0Lkh0dHAgfHwgKFR5cGVydGV4dC5IdHRwID0ge30pKTsKICAgIHZhciBIdHRwID0gVHlwZXJ0ZXh0Lkh0dHA7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoSHR0cCkgewogICAgICAgIChmdW5jdGlvbiAoSHR0cFJlc3BvbnNlU3RhdHVzKSB7CiAgICAgICAgICAgIEh0dHBSZXNwb25zZVN0YXR1c1tIdHRwUmVzcG9uc2VTdGF0dXNbInN1Y2Nlc3MiXSA9IDBdID0gInN1Y2Nlc3MiOwogICAgICAgICAgICBIdHRwUmVzcG9uc2VTdGF0dXNbSHR0cFJlc3BvbnNlU3RhdHVzWyJzZXJ2ZXJFcnJvciJdID0gMV0gPSAic2VydmVyRXJyb3IiOwogICAgICAgICAgICBIdHRwUmVzcG9uc2VTdGF0dXNbSHR0cFJlc3BvbnNlU3RhdHVzWyJjbGllbnRFcnJvciJdID0gMl0gPSAiY2xpZW50RXJyb3IiOwogICAgICAgICAgICBIdHRwUmVzcG9uc2VTdGF0dXNbSHR0cFJlc3BvbnNlU3RhdHVzWyJyZXNwb25zZUVycm9yIl0gPSAzXSA9ICJyZXNwb25zZUVycm9yIjsKICAgICAgICAgICAgSHR0cFJlc3BvbnNlU3RhdHVzW0h0dHBSZXNwb25zZVN0YXR1c1sidW5rbm93bkVycm9yIl0gPSA0XSA9ICJ1bmtub3duRXJyb3IiOwogICAgICAgICAgICBIdHRwUmVzcG9uc2VTdGF0dXNbSHR0cFJlc3BvbnNlU3RhdHVzWyJ0aW1lb3V0Il0gPSA1XSA9ICJ0aW1lb3V0IjsKICAgICAgICB9KShIdHRwLkh0dHBSZXNwb25zZVN0YXR1cyB8fCAoSHR0cC5IdHRwUmVzcG9uc2VTdGF0dXMgPSB7fSkpOwogICAgICAgIHZhciBIdHRwUmVzcG9uc2VTdGF0dXMgPSBIdHRwLkh0dHBSZXNwb25zZVN0YXR1czsKICAgIH0pKFR5cGVydGV4dC5IdHRwIHx8IChUeXBlcnRleHQuSHR0cCA9IHt9KSk7CiAgICB2YXIgSHR0cCA9IFR5cGVydGV4dC5IdHRwOwp9KShUeXBlcnRleHQgfHwgKFR5cGVydGV4dCA9IHt9KSk7CnZhciBUeXBlcnRleHQ7CihmdW5jdGlvbiAoVHlwZXJ0ZXh0KSB7CiAgICAoZnVuY3Rpb24gKEpzb24pIHsKICAgICAgICB2YXIgSnNvbkV4Y2VwdGlvbiA9IChmdW5jdGlvbiAoX3N1cGVyKSB7CiAgICAgICAgICAgIF9fZXh0ZW5kcyhKc29uRXhjZXB0aW9uLCBfc3VwZXIpOwogICAgICAgICAgICBmdW5jdGlvbiBKc29uRXhjZXB0aW9uKG1lc3NhZ2UsIGNvZGUpIHsKICAgICAgICAgICAgICAgIF9zdXBlci5jYWxsKHRoaXMsIG1lc3NhZ2UsIGNvZGUsIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBKc29uRXhjZXB0aW9uOwogICAgICAgIH0pKFR5cGVydGV4dC5CYXNlRXhjZXB0aW9uKTsKICAgICAgICBKc29uLkpzb25FeGNlcHRpb24gPSBKc29uRXhjZXB0aW9uOwogICAgfSkoVHlwZXJ0ZXh0Lkpzb24gfHwgKFR5cGVydGV4dC5Kc29uID0ge30pKTsKICAgIHZhciBKc29uID0gVHlwZXJ0ZXh0Lkpzb247Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKdmFyIFR5cGVydGV4dDsKKGZ1bmN0aW9uIChUeXBlcnRleHQpIHsKICAgIChmdW5jdGlvbiAoSnNvbikgewogICAgICAgIHZhciBIdHRwUmVxdWVzdCA9IFR5cGVydGV4dC5IdHRwLkh0dHBSZXF1ZXN0OwoKICAgICAgICB2YXIgSHR0cE1ldGhvZCA9IFR5cGVydGV4dC5IdHRwLkh0dHBNZXRob2Q7CgogICAgICAgIHZhciBKc29uUmVxdWVzdCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIEpzb25SZXF1ZXN0KGpzb25Db250ZW50VHlwZSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBqc29uQ29udGVudFR5cGUgPT09ICJ1bmRlZmluZWQiKSB7IGpzb25Db250ZW50VHlwZSA9ICJhcHBsaWNhdGlvbi9qc29uIjsgfQogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0ID0gbmV3IEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgICAgICB0aGlzLmpzb25UeXBlID0ganNvbkNvbnRlbnRUeXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEpzb25SZXF1ZXN0LnByb3RvdHlwZS5EZWxldGUgPSBmdW5jdGlvbiAocmVxdWVzdCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuUmF3UmVxdWVzdCgwIC8qIERFTEVURSAqLywgcmVxdWVzdCwge30sIGNhbGxiYWNrKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEpzb25SZXF1ZXN0LnByb3RvdHlwZS5HZXQgPSBmdW5jdGlvbiAocmVxdWVzdCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuUmF3UmVxdWVzdCgxIC8qIEdFVCAqLywgcmVxdWVzdCwge30sIGNhbGxiYWNrKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEpzb25SZXF1ZXN0LnByb3RvdHlwZS5Qb3N0ID0gZnVuY3Rpb24gKHJlcXVlc3QsIHBvc3REYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5SYXdSZXF1ZXN0KDQgLyogUE9TVCAqLywgcmVxdWVzdCwgcG9zdERhdGEsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEpzb25SZXF1ZXN0LnByb3RvdHlwZS5QdXQgPSBmdW5jdGlvbiAocmVxdWVzdCwgcHV0RGF0YSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuUmF3UmVxdWVzdCg1IC8qIFBVVCAqLywgcmVxdWVzdCwgcHV0RGF0YSwgY2FsbGJhY2spOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSnNvblJlcXVlc3QucHJvdG90eXBlLlJhd1JlcXVlc3QgPSBmdW5jdGlvbiAobWV0aG9kLCByZXF1ZXN0LCBwb3N0RGF0YSwgY2FsbGJhY2ssIHRyYW5zcG9ydCkgewogICAgICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcG9zdERhdGEgPT09ICJ1bmRlZmluZWQiKSB7IHBvc3REYXRhID0ge307IH0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdC5SYXdSZXF1ZXN0KG1ldGhvZCwgcmVxdWVzdCwgcG9zdERhdGEsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0LlJhd1JlcXVlc3QobWV0aG9kLCByZXF1ZXN0LCBwb3N0RGF0YSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLkdldENvbnRlbnRUeXBlKCkgIT0gX3RoaXMuanNvblR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soVHlwZXJ0ZXh0Lkpzb24uSnNvblJlc3BvbnNlLmZyb21JbnZhbGlkSHR0cFJlc3BvbnNlKHJlc3BvbnNlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKFR5cGVydGV4dC5Kc29uLkpzb25SZXNwb25zZS5mcm9tSHR0cFJlc3BvbnNlKHJlc3BvbnNlKSk7CiAgICAgICAgICAgICAgICB9LCB0cmFuc3BvcnQpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gSnNvblJlcXVlc3Q7CiAgICAgICAgfSkoKTsKICAgICAgICBKc29uLkpzb25SZXF1ZXN0ID0gSnNvblJlcXVlc3Q7CiAgICB9KShUeXBlcnRleHQuSnNvbiB8fCAoVHlwZXJ0ZXh0Lkpzb24gPSB7fSkpOwogICAgdmFyIEpzb24gPSBUeXBlcnRleHQuSnNvbjsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChKc29uKSB7CiAgICAgICAgdmFyIEh0dHBSZXNwb25zZVN0YXR1cyA9IFR5cGVydGV4dC5IdHRwLkh0dHBSZXNwb25zZVN0YXR1czsKCiAgICAgICAgdmFyIEpzb25SZXNwb25zZSA9IChmdW5jdGlvbiAoX3N1cGVyKSB7CiAgICAgICAgICAgIF9fZXh0ZW5kcyhKc29uUmVzcG9uc2UsIF9zdXBlcik7CiAgICAgICAgICAgIGZ1bmN0aW9uIEpzb25SZXNwb25zZShzdGF0dXMsIHJlc3BvbnNlSGVhZGVyR2V0dGVyLCBodHRwUmVzcG9uc2VDb2RlLCByZXNwb25zZUJvZHksIHBhcnNlU3VjY2VzcykgewogICAgICAgICAgICAgICAgX3N1cGVyLmNhbGwodGhpcywgc3RhdHVzLCByZXNwb25zZUhlYWRlckdldHRlciwgaHR0cFJlc3BvbnNlQ29kZSwgcmVzcG9uc2VCb2R5KTsKICAgICAgICAgICAgICAgIHBhcnNlU3VjY2VzcyA9ICEhcGFyc2VTdWNjZXNzIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5wYXJzZVN1Y2Nlc3MgPSBwYXJzZVN1Y2Nlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSnNvblJlc3BvbnNlLmZyb21IdHRwUmVzcG9uc2UgPSBmdW5jdGlvbiAoaHR0cFJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICB0cnkgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEpzb25SZXNwb25zZShodHRwUmVzcG9uc2UuR2V0U3RhdHVzKCksIGh0dHBSZXNwb25zZS5HZXRIZWFkZXIsIGh0dHBSZXNwb25zZS5HZXRIdHRwU3RhdHVzKCksIHdpbmRvd1siSlNPTiJdLnBhcnNlKGh0dHBSZXNwb25zZS5HZXRDb250ZW50KCkpLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEpzb25SZXNwb25zZShodHRwUmVzcG9uc2UuR2V0U3RhdHVzKCksIGh0dHBSZXNwb25zZS5HZXRIZWFkZXIsIGh0dHBSZXNwb25zZS5HZXRIdHRwU3RhdHVzKCksIG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgSnNvblJlc3BvbnNlLmZyb21JbnZhbGlkSHR0cFJlc3BvbnNlID0gZnVuY3Rpb24gKGh0dHBSZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBKc29uUmVzcG9uc2UoMyAvKiByZXNwb25zZUVycm9yICovLCBodHRwUmVzcG9uc2UuR2V0SGVhZGVyLCBodHRwUmVzcG9uc2UuR2V0SHR0cFN0YXR1cygpKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIEpzb25SZXNwb25zZS5wcm90b3R5cGUuR2V0UGFyc2VTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVN1Y2Nlc3M7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBKc29uUmVzcG9uc2U7CiAgICAgICAgfSkoVHlwZXJ0ZXh0LkdlbmVyaWNSZXNwb25zZSk7CiAgICAgICAgSnNvbi5Kc29uUmVzcG9uc2UgPSBKc29uUmVzcG9uc2U7CiAgICB9KShUeXBlcnRleHQuSnNvbiB8fCAoVHlwZXJ0ZXh0Lkpzb24gPSB7fSkpOwogICAgdmFyIEpzb24gPSBUeXBlcnRleHQuSnNvbjsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChUcmFuc3BvcnQpIHsKICAgICAgICB2YXIgSHR0cE1ldGhvZCA9IFR5cGVydGV4dC5IdHRwLkh0dHBNZXRob2Q7CiAgICAgICAgdmFyIEh0dHBVcmwgPSBUeXBlcnRleHQuSHR0cC5IdHRwVXJsOwoKICAgICAgICB2YXIgSHR0cFJlc3BvbnNlU3RhdHVzID0gVHlwZXJ0ZXh0Lkh0dHAuSHR0cFJlc3BvbnNlU3RhdHVzOwogICAgICAgIHZhciBIdHRwUmVzcG9uc2UgPSBUeXBlcnRleHQuSHR0cC5IdHRwUmVzcG9uc2U7CgogICAgICAgIHZhciBYRFIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiBYRFIobWV0aG9kLCByZXF1ZXN0LCBwb3N0RGF0YSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcG9zdERhdGEgPT09ICJ1bmRlZmluZWQiKSB7IHBvc3REYXRhID0ge307IH0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJ1bmRlZmluZWQiKSB7IGNhbGxiYWNrID0gZnVuY3Rpb24gKGMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH07IH0KICAgICAgICAgICAgICAgIHRoaXMucG9zdERhdGEgPSBwb3N0RGF0YTsKICAgICAgICAgICAgICAgIHRoaXMubWV0aG9kID0gbWV0aG9kOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICAgICAgICAgICAgICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKCiAgICAgICAgICAgICAgICB0aGlzLnhkciA9IG5ldyBYRG9tYWluUmVxdWVzdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFhEUi5wcm90b3R5cGUuU2VuZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICAgICAgICB2YXIgZ2V0SGVhZGVyID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmFtZS50b0xvd2VyQ2FzZSgpID09PSAiY29udGVudC10eXBlIikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMueGRyLmNvbnRlbnRUeXBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0aGlzLnhkci5vbnRpbWVvdXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2FsbGJhY2sobmV3IEh0dHBSZXNwb25zZSg1IC8qIHRpbWVvdXQgKi8sIGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgICAgICAgICB9LCAtMSwgIiIpKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGhpcy54ZHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjayhuZXcgSHR0cFJlc3BvbnNlKDQgLyogdW5rbm93bkVycm9yICovLCBnZXRIZWFkZXIsIC0xLCBfdGhpcy54ZHIucmVzcG9uc2VUZXh0KSk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHRoaXMueGRyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjayhuZXcgSHR0cFJlc3BvbnNlKDAgLyogc3VjY2VzcyAqLywgZ2V0SGVhZGVyLCAyMDAsIF90aGlzLnhkci5yZXNwb25zZVRleHQpKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGhpcy54ZHIub25wcm9ncmVzcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGhpcy54ZHIub3BlbihIdHRwTWV0aG9kW3RoaXMubWV0aG9kXSwgdGhpcy5yZXF1ZXN0LlRvU3RyaW5nKCkpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1ldGhvZCA9PSAxIC8qIEdFVCAqLykgewogICAgICAgICAgICAgICAgICAgIHRoaXMueGRyLnNlbmQoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy54ZHIuc2VuZChIdHRwVXJsLlVybEVuY29kZU9iamVjdCh0aGlzLnBvc3REYXRhKSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBYRFIucHJvdG90eXBlLkRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnhkci5vbnRpbWVvdXQgPSB0aGlzLnhkci5vbmVycm9yID0gdGhpcy54ZHIub25sb2FkID0gdGhpcy54ZHIub25wcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLnhkciA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBYRFI7CiAgICAgICAgfSkoKTsKICAgICAgICBUcmFuc3BvcnQuWERSID0gWERSOwogICAgfSkoVHlwZXJ0ZXh0LlRyYW5zcG9ydCB8fCAoVHlwZXJ0ZXh0LlRyYW5zcG9ydCA9IHt9KSk7CiAgICB2YXIgVHJhbnNwb3J0ID0gVHlwZXJ0ZXh0LlRyYW5zcG9ydDsKfSkoVHlwZXJ0ZXh0IHx8IChUeXBlcnRleHQgPSB7fSkpOwp2YXIgVHlwZXJ0ZXh0OwooZnVuY3Rpb24gKFR5cGVydGV4dCkgewogICAgKGZ1bmN0aW9uIChUcmFuc3BvcnQpIHsKICAgICAgICB2YXIgSHR0cE1ldGhvZCA9IFR5cGVydGV4dC5IdHRwLkh0dHBNZXRob2Q7CiAgICAgICAgdmFyIEh0dHBVcmwgPSBUeXBlcnRleHQuSHR0cC5IdHRwVXJsOwoKICAgICAgICB2YXIgSHR0cFJlc3BvbnNlU3RhdHVzID0gVHlwZXJ0ZXh0Lkh0dHAuSHR0cFJlc3BvbnNlU3RhdHVzOwogICAgICAgIHZhciBIdHRwUmVzcG9uc2UgPSBUeXBlcnRleHQuSHR0cC5IdHRwUmVzcG9uc2U7CgogICAgICAgIHZhciBYSFIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiBYSFIobWV0aG9kLCByZXF1ZXN0LCBwb3N0RGF0YSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcG9zdERhdGEgPT09ICJ1bmRlZmluZWQiKSB7IHBvc3REYXRhID0ge307IH0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJ1bmRlZmluZWQiKSB7IGNhbGxiYWNrID0gZnVuY3Rpb24gKGMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH07IH0KICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLnBvc3REYXRhID0gcG9zdERhdGE7CiAgICAgICAgICAgICAgICB0aGlzLm1ldGhvZCA9IG1ldGhvZDsKICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7CgogICAgICAgICAgICAgICAgdGhpcy54aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCiAgICAgICAgICAgICAgICB0aGlzLnhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnhoci5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdldEhlYWRlciA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMueGhyLmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnhoci5zdGF0dXMgPT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjayhuZXcgSHR0cFJlc3BvbnNlKDAgLyogc3VjY2VzcyAqLywgZ2V0SGVhZGVyLCBfdGhpcy54aHIuc3RhdHVzLCBfdGhpcy54aHIucmVzcG9uc2VUZXh0KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoX3RoaXMueGhyLnN0YXR1cyA+PSA0MDAgJiYgX3RoaXMueGhyLnN0YXR1cyA8IDUwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2FsbGJhY2sobmV3IEh0dHBSZXNwb25zZSgyIC8qIGNsaWVudEVycm9yICovLCBnZXRIZWFkZXIsIF90aGlzLnhoci5zdGF0dXMsIF90aGlzLnhoci5yZXNwb25zZVRleHQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChfdGhpcy54aHIuc3RhdHVzID49IDUwMCAmJiBfdGhpcy54aHIuc3RhdHVzIDwgNjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjayhuZXcgSHR0cFJlc3BvbnNlKDEgLyogc2VydmVyRXJyb3IgKi8sIGdldEhlYWRlciwgX3RoaXMueGhyLnN0YXR1cywgX3RoaXMueGhyLnJlc3BvbnNlVGV4dCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2FsbGJhY2sobmV3IEh0dHBSZXNwb25zZSg0IC8qIHVua25vd25FcnJvciAqLywgZ2V0SGVhZGVyLCBfdGhpcy54aHIuc3RhdHVzLCBfdGhpcy54aHIucmVzcG9uc2VUZXh0KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHRoaXMueGhyLm9udGltZW91dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjayhuZXcgSHR0cFJlc3BvbnNlKDUgLyogdGltZW91dCAqLywgZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICAgICAgICAgIH0sIC0xLCAiIikpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBYSFIucHJvdG90eXBlLlNlbmQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnhoci5vcGVuKEh0dHBNZXRob2RbdGhpcy5tZXRob2RdLCB0aGlzLnJlcXVlc3QuVG9TdHJpbmcoKSwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWV0aG9kID09IDEgLyogR0VUICovKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy54aHIuc2VuZCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnhoci5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIik7CgogICAgICAgICAgICAgICAgdGhpcy54aHIuc2VuZChIdHRwVXJsLlVybEVuY29kZU9iamVjdCh0aGlzLnBvc3REYXRhKSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBYSFIucHJvdG90eXBlLkRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLnhoci5vbnRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy54aHIgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gWEhSOwogICAgICAgIH0pKCk7CiAgICAgICAgVHJhbnNwb3J0LlhIUiA9IFhIUjsKICAgIH0pKFR5cGVydGV4dC5UcmFuc3BvcnQgfHwgKFR5cGVydGV4dC5UcmFuc3BvcnQgPSB7fSkpOwogICAgdmFyIFRyYW5zcG9ydCA9IFR5cGVydGV4dC5UcmFuc3BvcnQ7Cn0pKFR5cGVydGV4dCB8fCAoVHlwZXJ0ZXh0ID0ge30pKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9dHlwZXJ0ZXh0LmpzLm1hcAo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 00:04:22 GMT",
                    "Content-Length": "23615",
                    "Date": "Sun, 09 Nov 2014 00:04:22 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}